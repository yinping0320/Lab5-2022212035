/**
 * @fileoverview added by tsickle
 * Generated from: lib/bill-tracker/services/bill-tracker-ui.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Injector, ComponentFactoryResolver, ReflectiveInjector, Inject, LOCALE_ID } from '@angular/core';
import { BsModalService } from '@farris/ui-modal';
import { BillTrackerDataService } from './bill-tracker-data.service';
import { BillTrackerComponent } from '../components/bill-tracker/bill-tracker.component';
import { BillTrackerArgs } from '../config/bill-tracker-args';
import { GetDownBillsInfoArgs } from '../../entity/tracking/GetDownBillsInfoArgs';
import { BillTrackerLocalePipe } from '../pipe/bill-tracker-locale.pipe';
import { of } from 'rxjs';
import { switchMap, catchError } from 'rxjs/operators';
import { MessagerService } from '@farris/ui-messager';
import { LoadingService } from '@farris/ui-loading';
import { FrameworkService, AppType } from '@gsp-sys/rtf-common';
import { BillTrackerConstant } from '../config/bill-tracker-constant';
import { BillTrackerGraphOptions } from '../config/bill-tracker-graph-options';
import { BillTrackerGridOptions } from '../config/bill-tracker-grid-options';
export class BillTrackerUiService {
    /**
     * @param {?} frameworkService
     * @param {?} messager
     * @param {?} loading
     * @param {?} localeId
     * @param {?} dataService
     * @param {?} modalService
     * @param {?} cfr
     * @param {?} injector
     */
    constructor(frameworkService, messager, loading, localeId, dataService, modalService, cfr, injector) {
        this.frameworkService = frameworkService;
        this.messager = messager;
        this.loading = loading;
        this.dataService = dataService;
        this.modalService = modalService;
        this.cfr = cfr;
        this.injector = injector;
        /**
         * 内置模态框配置
         */
        this.defaultModalOptions = {
            title: null,
            width: 1100,
            height: 480,
            buttons: null,
            showButtons: null,
        };
        this.localePipe = new BillTrackerLocalePipe(localeId);
    }
    /**
     * 打开单据追踪弹窗
     * todo: spa模式下，弹窗在body中，位于最上层，打开联查时会盖住新tab页，此问题待解决
     * @param {?} args 单据追踪参数
     * @param {?=} maximized 是否最大化弹窗
     * @param {?=} modalOptions 弹窗配置
     * @param {?=} graphOptions 追踪图配置
     * @param {?=} gridOptions 数据表配置
     * @return {?}
     */
    openDefaultBillTrackerDialog(args, maximized = true, modalOptions, graphOptions, gridOptions) {
        if (typeof modalOptions == "string") {
            if (modalOptions == "") {
                this.messager.info(this.localePipe.transform("modalOptionsCantBeEmpty"));
                return of(null);
            }
            modalOptions = JSON.parse(modalOptions);
        }
        /** @type {?} */
        let modalOpts = {
            title: this.localePipe.transform("billTracker")
        };
        modalOpts = Object.assign(modalOpts, this.defaultModalOptions, modalOptions);
        if (typeof graphOptions == "string") {
            if (graphOptions != "") {
                graphOptions = JSON.parse(graphOptions);
            }
            else {
                graphOptions = null;
            }
        }
        if (typeof gridOptions == "string") {
            if (gridOptions != "") {
                gridOptions = JSON.parse(gridOptions);
            }
            else {
                gridOptions = null;
            }
        }
        /** @type {?} */
        const downArgs = new GetDownBillsInfoArgs();
        downArgs.billDataId = args.billDataId;
        downArgs.documentTypeId = args.documentTypeId;
        downArgs.bizKind = args.bizKind;
        downArgs.bizType = args.bizType;
        downArgs.billChildInfos = args.billChildInfos;
        downArgs.curYear = args.curYear;
        this.loading.show({ message: this.localePipe.transform("loading") });
        return this.dataService.canTracking(downArgs).pipe(switchMap((/**
         * @param {?} res
         * @return {?}
         */
        (res) => {
            if (!res.canDownTracking && !res.canUpTracking) {
                this.messager.info(this.localePipe.transform("noAssoBill"));
                this.loading.close();
                return of(null);
            }
            /** @type {?} */
            const billTrackerArgs = new BillTrackerArgs();
            billTrackerArgs.canTrackingResult = res;
            billTrackerArgs.getBillsInfoArgs = args;
            /** @type {?} */
            let graphOpt = new BillTrackerGraphOptions();
            graphOpt = Object.assign(graphOpt, graphOptions);
            billTrackerArgs.graphOptions = graphOpt;
            /** @type {?} */
            let gridOpt = new BillTrackerGridOptions();
            gridOpt = Object.assign(gridOpt, gridOptions);
            billTrackerArgs.gridOptions = gridOpt;
            /** @type {?} */
            const cmpR = this.createBillTrackerComponent(billTrackerArgs);
            this.loading.close();
            /** @type {?} */
            const modalRef = this.modalService.show(cmpR, modalOpts);
            if (maximized) {
                modalRef.dialog.instance.maxDialog();
            }
            cmpR.instance.setModalRef(modalRef);
            return of(cmpR.instance);
        })), catchError((/**
         * @param {?} err
         * @return {?}
         */
        (err) => {
            this.loading.close();
            //todo 确定异常结构, 目前采用兼容取值方式
            this.messager.error(err.error == null ? err.message : (err.error.Message || err.error.message || err.message));
            throw err;
        })));
    }
    /**
     * 打开单据追踪应用
     * @param {?} args 单据追踪参数
     * @param {?=} graphOptions 追踪图配置
     * @param {?=} gridOptions 数据表配置
     * @return {?}
     */
    openDefaultBillTrackerApp(args, graphOptions, gridOptions) {
        if (typeof graphOptions == "string") {
            if (graphOptions == "") {
                this.messager.info(this.localePipe.transform("modalOptionsCantBeEmpty"));
                return;
            }
            graphOptions = JSON.parse(graphOptions);
        }
        if (typeof gridOptions == "string") {
            if (gridOptions == "") {
                this.messager.info(this.localePipe.transform("modalOptionsCantBeEmpty"));
                return;
            }
            gridOptions = JSON.parse(gridOptions);
        }
        /** @type {?} */
        const downArgs = new GetDownBillsInfoArgs();
        downArgs.documentTypeId = args.documentTypeId;
        downArgs.billDataId = args.billDataId;
        downArgs.bizKind = args.bizKind;
        downArgs.bizType = args.bizType;
        downArgs.billChildInfos = args.billChildInfos;
        downArgs.curYear = args.curYear;
        this.loading.show({ message: this.localePipe.transform("loading") });
        this.dataService.canTracking(downArgs).subscribe((/**
         * @param {?} res
         * @return {?}
         */
        (res) => {
            if (!res.canDownTracking && !res.canUpTracking) {
                this.messager.info(this.localePipe.transform("noAssoBill"));
                this.loading.close();
                return;
            }
            /** @type {?} */
            const billTrackerArgs = new BillTrackerArgs();
            // warning：如果存在特殊字符或者长度超长，可能会打开空白的单据追踪应用
            billTrackerArgs.canTrackingResult = res;
            billTrackerArgs.getBillsInfoArgs = args;
            /** @type {?} */
            let graphOpt = new BillTrackerGraphOptions();
            graphOpt = Object.assign(graphOpt, graphOptions);
            billTrackerArgs.graphOptions = graphOpt;
            /** @type {?} */
            let gridOpt = new BillTrackerGridOptions();
            gridOpt = Object.assign(gridOpt, gridOptions);
            billTrackerArgs.gridOptions = gridOpt;
            /** @type {?} */
            const opt = {
                appId: BillTrackerConstant.DEFAULT_APP_ID,
                appEntrance: BillTrackerConstant.DEFAULT_APP_ENTRANCE,
                funcId: BillTrackerConstant.DEFAULT_FUNC_ID,
                tabId: "billTracker" + Date.now(),
                tabName: this.localePipe.transform("billTracker"),
                appType: AppType.App,
                entityParams: billTrackerArgs,
                queryStringParams: this.buildQueryMap(billTrackerArgs),
                isReload: undefined,
            };
            this.frameworkService.openMenu(opt);
            this.loading.close();
        }), (/**
         * @param {?} err
         * @return {?}
         */
        (err) => {
            this.loading.close();
            //todo 确定异常结构, 目前采用兼容取值方式
            this.messager.error(err.error == null ? err.message : (err.error.Message || err.error.message || err.message));
            throw err;
        }));
    }
    /**
     * 创建单据追踪组件
     * @param {?} billTrackerArgs 单据追踪参数
     * @param {?=} cfr ComponentFactoryResolver
     * @param {?=} injector Injector
     * @param {?=} custProviders 自定义Provider
     * @return {?}
     */
    createBillTrackerComponent(billTrackerArgs, cfr, injector, custProviders) {
        cfr = cfr == null ? this.cfr : cfr;
        injector = injector == null ? this.injector : injector;
        custProviders = custProviders == null || Array.isArray(custProviders) == false ? [] : custProviders;
        /** @type {?} */
        const inj = ReflectiveInjector.resolveAndCreate([
            { provide: BillTrackerArgs, useValue: billTrackerArgs },
            ...custProviders
        ], injector);
        /** @type {?} */
        const cmpF = cfr.resolveComponentFactory(BillTrackerComponent);
        /** @type {?} */
        const cmpR = cmpF.create(inj);
        return cmpR;
    }
    /**
     * 能否继续追踪
     * @param {?} args
     * @return {?}
     */
    canTracking(args) {
        return this.dataService.canTracking(args);
    }
    /**
     * 获取下游单据信息
     * @param {?} args
     * @return {?}
     */
    getDownBillsInfo(args) {
        return this.dataService.getDownBillsInfo(args);
    }
    /**
     * 获取上游单据信息
     * @param {?} args
     * @return {?}
     */
    getUpBillsInfo(args) {
        return this.dataService.getUpBillsInfo(args);
    }
    /**
     * 查询实体数据
     * @param {?} args
     * @return {?}
     */
    getEntityData(args) {
        return this.dataService.getEntityData(args);
    }
    /**
     * @private
     * @param {?} billTrackerArgs
     * @return {?}
     */
    buildQueryMap(billTrackerArgs) {
        /** @type {?} */
        let map = new Map();
        for (let key in billTrackerArgs) {
            /** @type {?} */
            let value = billTrackerArgs[key];
            if (typeof value == "object") {
                value = value && JSON.stringify(value);
            }
            // url编码后base64加密，避免url中出现特殊字符
            // 在default-bill-tracker中解码时应先atob在decodeURIComponent
            map.set(key, btoa(encodeURIComponent(value)));
        }
        return map;
    }
}
BillTrackerUiService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BillTrackerUiService.ctorParameters = () => [
    { type: FrameworkService },
    { type: MessagerService },
    { type: LoadingService },
    { type: String, decorators: [{ type: Inject, args: [LOCALE_ID,] }] },
    { type: BillTrackerDataService },
    { type: BsModalService },
    { type: ComponentFactoryResolver },
    { type: Injector }
];
if (false) {
    /**
     * 内置模态框配置
     * @type {?}
     */
    BillTrackerUiService.prototype.defaultModalOptions;
    /** @type {?} */
    BillTrackerUiService.prototype.localePipe;
    /** @type {?} */
    BillTrackerUiService.prototype.frameworkService;
    /** @type {?} */
    BillTrackerUiService.prototype.messager;
    /** @type {?} */
    BillTrackerUiService.prototype.loading;
    /** @type {?} */
    BillTrackerUiService.prototype.dataService;
    /** @type {?} */
    BillTrackerUiService.prototype.modalService;
    /** @type {?} */
    BillTrackerUiService.prototype.cfr;
    /** @type {?} */
    BillTrackerUiService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmlsbC10cmFja2VyLXVpLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZWRwLWJpZi9ydW50aW1lLWFwaS8iLCJzb3VyY2VzIjpbImxpYi9iaWxsLXRyYWNrZXIvc2VydmljZXMvYmlsbC10cmFja2VyLXVpLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSx3QkFBd0IsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3RILE9BQU8sRUFBRSxjQUFjLEVBQWdCLE1BQU0sa0JBQWtCLENBQUM7QUFDaEUsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDckUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sbURBQW1ELENBQUM7QUFDekYsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRTlELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDRDQUE0QyxDQUFDO0FBQ2xGLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxFQUFFLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN2RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFdEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxnQkFBZ0IsRUFBYyxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM1RSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUV0RSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUMvRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUs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OztJQUNwQyx3Q0FBeUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBSZWZsZWN0aXZlSW5qZWN0b3IsIEluamVjdCwgTE9DQUxFX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEJzTW9kYWxTZXJ2aWNlLCBNb2RhbE9wdGlvbnMgfSBmcm9tICdAZmFycmlzL3VpLW1vZGFsJztcclxuaW1wb3J0IHsgQmlsbFRyYWNrZXJEYXRhU2VydmljZSB9IGZyb20gJy4vYmlsbC10cmFja2VyLWRhdGEuc2VydmljZSc7XHJcbmltcG9ydCB7IEJpbGxUcmFja2VyQ29tcG9uZW50IH0gZnJvbSAnLi4vY29tcG9uZW50cy9iaWxsLXRyYWNrZXIvYmlsbC10cmFja2VyLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IEJpbGxUcmFja2VyQXJncyB9IGZyb20gJy4uL2NvbmZpZy9iaWxsLXRyYWNrZXItYXJncyc7XHJcbmltcG9ydCB7IEdldEJpbGxzSW5mb0FyZ3MgfSBmcm9tICcuLi8uLi9lbnRpdHkvdHJhY2tpbmcvR2V0QmlsbHNJbmZvQXJncyc7XHJcbmltcG9ydCB7IEdldERvd25CaWxsc0luZm9BcmdzIH0gZnJvbSAnLi4vLi4vZW50aXR5L3RyYWNraW5nL0dldERvd25CaWxsc0luZm9BcmdzJztcclxuaW1wb3J0IHsgQmlsbFRyYWNrZXJMb2NhbGVQaXBlIH0gZnJvbSAnLi4vcGlwZS9iaWxsLXRyYWNrZXItbG9jYWxlLnBpcGUnO1xyXG5pbXBvcnQgeyBvZiwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBzd2l0Y2hNYXAsIGNhdGNoRXJyb3IgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IE1lc3NhZ2VyU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbWVzc2FnZXInO1xyXG5pbXBvcnQgeyBDYW5UcmFja2luZ1Jlc3VsdCB9IGZyb20gJy4uL2FyZ3MvQ2FuVHJhY2tpbmdSZXN1bHQnO1xyXG5pbXBvcnQgeyBMb2FkaW5nU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbG9hZGluZyc7XHJcbmltcG9ydCB7IEZyYW1ld29ya1NlcnZpY2UsIEFwcE9wdGlvbnMsIEFwcFR5cGUgfSBmcm9tICdAZ3NwLXN5cy9ydGYtY29tbW9uJztcclxuaW1wb3J0IHsgQmlsbFRyYWNrZXJDb25zdGFudCB9IGZyb20gJy4uL2NvbmZpZy9iaWxsLXRyYWNrZXItY29uc3RhbnQnO1xyXG5pbXBvcnQgeyBJQmlsbFRyYWNrZXJVaVNlcnZpY2UgfSBmcm9tICcuLi9iYXNlL0lCaWxsVHJhY2tlclVpU2VydmljZSc7XHJcbmltcG9ydCB7IEJpbGxUcmFja2VyR3JhcGhPcHRpb25zIH0gZnJvbSAnLi4vY29uZmlnL2JpbGwtdHJhY2tlci1ncmFwaC1vcHRpb25zJztcclxuaW1wb3J0IHsgQmlsbFRyYWNrZXJHcmlkT3B0aW9ucyB9IGZyb20gJy4uL2NvbmZpZy9iaWxsLXRyYWNrZXItZ3JpZC1vcHRpb25zJztcclxuaW1wb3J0IHsgR2V0TWFpbkVudGl0eURhdGFBcmdzIH0gZnJvbSAnLi4vYXJncy9HZXRNYWluRW50aXR5RGF0YUFyZ3MnO1xyXG5pbXBvcnQgeyBFbnRpdHlEYXRhUmVzdWx0IH0gZnJvbSAnLi4vYXJncy9FbnRpdHlEYXRhUmVzdWx0JztcclxuaW1wb3J0IHsgR2V0VXBCaWxsc0luZm9BcmdzIH0gZnJvbSAnLi4vLi4vZW50aXR5L3RyYWNraW5nL0dldFVwQmlsbHNJbmZvQXJncyc7XHJcbmltcG9ydCB7IFVwQmlsbEluZm9SZXN1bHQgfSBmcm9tICcuLi9hcmdzL1VwQmlsbEluZm9SZXN1bHQnO1xyXG5pbXBvcnQgeyBEb3duQmlsbEluZm9SZXN1bHQgfSBmcm9tICcuLi9hcmdzL0Rvd25CaWxsSW5mb1Jlc3VsdCc7XHJcbmltcG9ydCB7IEJhc2U2NCB9IGZyb20gJy4uL3V0aWxzL0Jhc2U2NCc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBCaWxsVHJhY2tlclVpU2VydmljZSBpbXBsZW1lbnRzIElCaWxsVHJhY2tlclVpU2VydmljZSB7XHJcbiAgLyoqXHJcbiAgICog5YaF572u5qih5oCB5qGG6YWN572uXHJcbiAgICovXHJcbiAgcHVibGljIHJlYWRvbmx5IGRlZmF1bHRNb2RhbE9wdGlvbnM6IE1vZGFsT3B0aW9ucyA9IHtcclxuICAgIHRpdGxlOiBudWxsLFxyXG4gICAgd2lkdGg6IDExMDAsXHJcbiAgICBoZWlnaHQ6IDQ4MCxcclxuICAgIGJ1dHRvbnM6IG51bGwsXHJcbiAgICBzaG93QnV0dG9uczogbnVsbCxcclxuICB9O1xyXG5cclxuICBsb2NhbGVQaXBlOiBCaWxsVHJhY2tlckxvY2FsZVBpcGU7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHVibGljIGZyYW1ld29ya1NlcnZpY2U6IEZyYW1ld29ya1NlcnZpY2UsXHJcbiAgICBwdWJsaWMgbWVzc2FnZXI6IE1lc3NhZ2VyU2VydmljZSxcclxuICAgIHB1YmxpYyBsb2FkaW5nOiBMb2FkaW5nU2VydmljZSxcclxuICAgIEBJbmplY3QoTE9DQUxFX0lEKSBsb2NhbGVJZDogc3RyaW5nLFxyXG4gICAgcHVibGljIGRhdGFTZXJ2aWNlOiBCaWxsVHJhY2tlckRhdGFTZXJ2aWNlLFxyXG4gICAgcHVibGljIG1vZGFsU2VydmljZTogQnNNb2RhbFNlcnZpY2UsXHJcbiAgICBwdWJsaWMgY2ZyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICBwdWJsaWMgaW5qZWN0b3I6IEluamVjdG9yLFxyXG4gICkge1xyXG4gICAgdGhpcy5sb2NhbGVQaXBlID0gbmV3IEJpbGxUcmFja2VyTG9jYWxlUGlwZShsb2NhbGVJZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmiZPlvIDljZXmja7ov73ouKrlvLnnqpdcclxuICAgKiB0b2RvOiBzcGHmqKHlvI/kuIvvvIzlvLnnqpflnKhib2R55Lit77yM5L2N5LqO5pyA5LiK5bGC77yM5omT5byA6IGU5p+l5pe25Lya55uW5L2P5pawdGFi6aG177yM5q2k6Zeu6aKY5b6F6Kej5YazXHJcbiAgICogQHBhcmFtIGFyZ3Mg5Y2V5o2u6L+96Liq5Y+C5pWwXHJcbiAgICogQHBhcmFtIG1heGltaXplZCDmmK/lkKbmnIDlpKfljJblvLnnqpdcclxuICAgKiBAcGFyYW0gbW9kYWxPcHRpb25zIOW8ueeql+mFjee9rlxyXG4gICAqIEBwYXJhbSBncmFwaE9wdGlvbnMg6L+96Liq5Zu+6YWN572uXHJcbiAgICogQHBhcmFtIGdyaWRPcHRpb25zIOaVsOaNruihqOmFjee9rlxyXG4gICAqL1xyXG4gIHB1YmxpYyBvcGVuRGVmYXVsdEJpbGxUcmFja2VyRGlhbG9nKGFyZ3M6IEdldEJpbGxzSW5mb0FyZ3MsIG1heGltaXplZDogYm9vbGVhbiA9IHRydWUsIG1vZGFsT3B0aW9ucz86IE1vZGFsT3B0aW9ucywgZ3JhcGhPcHRpb25zPzogQmlsbFRyYWNrZXJHcmFwaE9wdGlvbnMsIGdyaWRPcHRpb25zPzogQmlsbFRyYWNrZXJHcmlkT3B0aW9ucyk6IE9ic2VydmFibGU8QmlsbFRyYWNrZXJDb21wb25lbnQ+IHtcclxuICAgIGlmICh0eXBlb2YgbW9kYWxPcHRpb25zID09IFwic3RyaW5nXCIpIHtcclxuICAgICAgaWYgKG1vZGFsT3B0aW9ucyA9PSBcIlwiKSB7XHJcbiAgICAgICAgdGhpcy5tZXNzYWdlci5pbmZvKHRoaXMubG9jYWxlUGlwZS50cmFuc2Zvcm0oXCJtb2RhbE9wdGlvbnNDYW50QmVFbXB0eVwiKSk7XHJcbiAgICAgICAgcmV0dXJuIG9mKG51bGwpO1xyXG4gICAgICB9XHJcbiAgICAgIG1vZGFsT3B0aW9ucyA9IEpTT04ucGFyc2UobW9kYWxPcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgbW9kYWxPcHRzOiBNb2RhbE9wdGlvbnMgPSB7XHJcbiAgICAgIHRpdGxlOiB0aGlzLmxvY2FsZVBpcGUudHJhbnNmb3JtKFwiYmlsbFRyYWNrZXJcIilcclxuICAgIH07XHJcbiAgICBtb2RhbE9wdHMgPSBPYmplY3QuYXNzaWduKG1vZGFsT3B0cywgdGhpcy5kZWZhdWx0TW9kYWxPcHRpb25zLCBtb2RhbE9wdGlvbnMpO1xyXG5cclxuICAgIGlmICh0eXBlb2YgZ3JhcGhPcHRpb25zID09IFwic3RyaW5nXCIpIHtcclxuICAgICAgaWYgKGdyYXBoT3B0aW9ucyAhPSBcIlwiKSB7XHJcbiAgICAgICAgZ3JhcGhPcHRpb25zID0gSlNPTi5wYXJzZShncmFwaE9wdGlvbnMpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGdyYXBoT3B0aW9ucyA9IG51bGw7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAodHlwZW9mIGdyaWRPcHRpb25zID09IFwic3RyaW5nXCIpIHtcclxuICAgICAgaWYgKGdyaWRPcHRpb25zICE9IFwiXCIpIHtcclxuICAgICAgICBncmlkT3B0aW9ucyA9IEpTT04ucGFyc2UoZ3JpZE9wdGlvbnMpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGdyaWRPcHRpb25zID0gbnVsbDtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGRvd25BcmdzID0gbmV3IEdldERvd25CaWxsc0luZm9BcmdzKCk7XHJcbiAgICBkb3duQXJncy5iaWxsRGF0YUlkID0gYXJncy5iaWxsRGF0YUlkO1xyXG4gICAgZG93bkFyZ3MuZG9jdW1lbnRUeXBlSWQgPSBhcmdzLmRvY3VtZW50VHlwZUlkO1xyXG4gICAgZG93bkFyZ3MuYml6S2luZCA9IGFyZ3MuYml6S2luZDtcclxuICAgIGRvd25BcmdzLmJpelR5cGUgPSBhcmdzLmJpelR5cGU7XHJcbiAgICBkb3duQXJncy5iaWxsQ2hpbGRJbmZvcyA9IGFyZ3MuYmlsbENoaWxkSW5mb3M7XHJcbiAgICBkb3duQXJncy5jdXJZZWFyID0gYXJncy5jdXJZZWFyO1xyXG5cclxuICAgIHRoaXMubG9hZGluZy5zaG93KHsgbWVzc2FnZTogdGhpcy5sb2NhbGVQaXBlLnRyYW5zZm9ybShcImxvYWRpbmdcIikgfSk7XHJcbiAgICByZXR1cm4gdGhpcy5kYXRhU2VydmljZS5jYW5UcmFja2luZyhkb3duQXJncykucGlwZShcclxuICAgICAgc3dpdGNoTWFwKFxyXG4gICAgICAgIChyZXM6IENhblRyYWNraW5nUmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICBpZiAoIXJlcy5jYW5Eb3duVHJhY2tpbmcgJiYgIXJlcy5jYW5VcFRyYWNraW5nKSB7XHJcbiAgICAgICAgICAgIHRoaXMubWVzc2FnZXIuaW5mbyh0aGlzLmxvY2FsZVBpcGUudHJhbnNmb3JtKFwibm9Bc3NvQmlsbFwiKSk7XHJcbiAgICAgICAgICAgIHRoaXMubG9hZGluZy5jbG9zZSgpO1xyXG4gICAgICAgICAgICByZXR1cm4gb2YobnVsbCk7XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgY29uc3QgYmlsbFRyYWNrZXJBcmdzOiBCaWxsVHJhY2tlckFyZ3MgPSBuZXcgQmlsbFRyYWNrZXJBcmdzKCk7XHJcbiAgICAgICAgICBiaWxsVHJhY2tlckFyZ3MuY2FuVHJhY2tpbmdSZXN1bHQgPSByZXM7XHJcbiAgICAgICAgICBiaWxsVHJhY2tlckFyZ3MuZ2V0QmlsbHNJbmZvQXJncyA9IGFyZ3M7XHJcblxyXG4gICAgICAgICAgbGV0IGdyYXBoT3B0ID0gbmV3IEJpbGxUcmFja2VyR3JhcGhPcHRpb25zKCk7XHJcbiAgICAgICAgICBncmFwaE9wdCA9IE9iamVjdC5hc3NpZ24oZ3JhcGhPcHQsIGdyYXBoT3B0aW9ucyk7XHJcbiAgICAgICAgICBiaWxsVHJhY2tlckFyZ3MuZ3JhcGhPcHRpb25zID0gZ3JhcGhPcHQ7XHJcblxyXG4gICAgICAgICAgbGV0IGdyaWRPcHQgPSBuZXcgQmlsbFRyYWNrZXJHcmlkT3B0aW9ucygpO1xyXG4gICAgICAgICAgZ3JpZE9wdCA9IE9iamVjdC5hc3NpZ24oZ3JpZE9wdCwgZ3JpZE9wdGlvbnMpO1xyXG4gICAgICAgICAgYmlsbFRyYWNrZXJBcmdzLmdyaWRPcHRpb25zID0gZ3JpZE9wdDtcclxuXHJcbiAgICAgICAgICBjb25zdCBjbXBSID0gdGhpcy5jcmVhdGVCaWxsVHJhY2tlckNvbXBvbmVudChiaWxsVHJhY2tlckFyZ3MpO1xyXG5cclxuICAgICAgICAgIHRoaXMubG9hZGluZy5jbG9zZSgpO1xyXG4gICAgICAgICAgY29uc3QgbW9kYWxSZWYgPSB0aGlzLm1vZGFsU2VydmljZS5zaG93KGNtcFIsIG1vZGFsT3B0cyk7XHJcbiAgICAgICAgICBpZiAobWF4aW1pemVkKSB7XHJcbiAgICAgICAgICAgIG1vZGFsUmVmLmRpYWxvZy5pbnN0YW5jZS5tYXhEaWFsb2coKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNtcFIuaW5zdGFuY2Uuc2V0TW9kYWxSZWYobW9kYWxSZWYpO1xyXG5cclxuICAgICAgICAgIHJldHVybiBvZihjbXBSLmluc3RhbmNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICksXHJcbiAgICAgIGNhdGNoRXJyb3IoXHJcbiAgICAgICAgKGVycikgPT4ge1xyXG4gICAgICAgICAgdGhpcy5sb2FkaW5nLmNsb3NlKCk7XHJcbiAgICAgICAgICAvL3RvZG8g56Gu5a6a5byC5bi457uT5p6ELCDnm67liY3ph4fnlKjlhbzlrrnlj5blgLzmlrnlvI9cclxuICAgICAgICAgIHRoaXMubWVzc2FnZXIuZXJyb3IoZXJyLmVycm9yID09IG51bGwgPyBlcnIubWVzc2FnZSA6IChlcnIuZXJyb3IuTWVzc2FnZSB8fCBlcnIuZXJyb3IubWVzc2FnZSB8fCBlcnIubWVzc2FnZSkpO1xyXG4gICAgICAgICAgdGhyb3cgZXJyO1xyXG4gICAgICAgIH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJk+W8gOWNleaNrui/vei4quW6lOeUqFxyXG4gICAqIEBwYXJhbSBhcmdzIOWNleaNrui/vei4quWPguaVsFxyXG4gICAqIEBwYXJhbSBncmFwaE9wdGlvbnMg6L+96Liq5Zu+6YWN572uXHJcbiAgICogQHBhcmFtIGdyaWRPcHRpb25zIOaVsOaNruihqOmFjee9rlxyXG4gICAqL1xyXG4gIHB1YmxpYyBvcGVuRGVmYXVsdEJpbGxUcmFja2VyQXBwKGFyZ3M6IEdldEJpbGxzSW5mb0FyZ3MsIGdyYXBoT3B0aW9ucz86IEJpbGxUcmFja2VyR3JhcGhPcHRpb25zLCBncmlkT3B0aW9ucz86IEJpbGxUcmFja2VyR3JpZE9wdGlvbnMpOiB2b2lkIHtcclxuICAgIGlmICh0eXBlb2YgZ3JhcGhPcHRpb25zID09IFwic3RyaW5nXCIpIHtcclxuICAgICAgaWYgKGdyYXBoT3B0aW9ucyA9PSBcIlwiKSB7XHJcbiAgICAgICAgdGhpcy5tZXNzYWdlci5pbmZvKHRoaXMubG9jYWxlUGlwZS50cmFuc2Zvcm0oXCJtb2RhbE9wdGlvbnNDYW50QmVFbXB0eVwiKSk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGdyYXBoT3B0aW9ucyA9IEpTT04ucGFyc2UoZ3JhcGhPcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodHlwZW9mIGdyaWRPcHRpb25zID09IFwic3RyaW5nXCIpIHtcclxuICAgICAgaWYgKGdyaWRPcHRpb25zID09IFwiXCIpIHtcclxuICAgICAgICB0aGlzLm1lc3NhZ2VyLmluZm8odGhpcy5sb2NhbGVQaXBlLnRyYW5zZm9ybShcIm1vZGFsT3B0aW9uc0NhbnRCZUVtcHR5XCIpKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgZ3JpZE9wdGlvbnMgPSBKU09OLnBhcnNlKGdyaWRPcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBkb3duQXJncyA9IG5ldyBHZXREb3duQmlsbHNJbmZvQXJncygpO1xyXG4gICAgZG93bkFyZ3MuZG9jdW1lbnRUeXBlSWQgPSBhcmdzLmRvY3VtZW50VHlwZUlkO1xyXG4gICAgZG93bkFyZ3MuYmlsbERhdGFJZCA9IGFyZ3MuYmlsbERhdGFJZDtcclxuICAgIGRvd25BcmdzLmJpektpbmQgPSBhcmdzLmJpektpbmQ7XHJcbiAgICBkb3duQXJncy5iaXpUeXBlID0gYXJncy5iaXpUeXBlO1xyXG4gICAgZG93bkFyZ3MuYmlsbENoaWxkSW5mb3MgPSBhcmdzLmJpbGxDaGlsZEluZm9zO1xyXG4gICAgZG93bkFyZ3MuY3VyWWVhciA9IGFyZ3MuY3VyWWVhcjtcclxuXHJcbiAgICB0aGlzLmxvYWRpbmcuc2hvdyh7IG1lc3NhZ2U6IHRoaXMubG9jYWxlUGlwZS50cmFuc2Zvcm0oXCJsb2FkaW5nXCIpIH0pO1xyXG4gICAgdGhpcy5kYXRhU2VydmljZS5jYW5UcmFja2luZyhkb3duQXJncykuc3Vic2NyaWJlKFxyXG4gICAgICAocmVzOiBDYW5UcmFja2luZ1Jlc3VsdCkgPT4ge1xyXG4gICAgICAgIGlmICghcmVzLmNhbkRvd25UcmFja2luZyAmJiAhcmVzLmNhblVwVHJhY2tpbmcpIHtcclxuICAgICAgICAgIHRoaXMubWVzc2FnZXIuaW5mbyh0aGlzLmxvY2FsZVBpcGUudHJhbnNmb3JtKFwibm9Bc3NvQmlsbFwiKSk7XHJcbiAgICAgICAgICB0aGlzLmxvYWRpbmcuY2xvc2UoKTtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGJpbGxUcmFja2VyQXJnczogQmlsbFRyYWNrZXJBcmdzID0gbmV3IEJpbGxUcmFja2VyQXJncygpO1xyXG4gICAgICAgIC8vIHdhcm5pbmfvvJrlpoLmnpzlrZjlnKjnibnmrorlrZfnrKbmiJbogIXplb/luqbotoXplb/vvIzlj6/og73kvJrmiZPlvIDnqbrnmb3nmoTljZXmja7ov73ouKrlupTnlKhcclxuICAgICAgICBiaWxsVHJhY2tlckFyZ3MuY2FuVHJhY2tpbmdSZXN1bHQgPSByZXM7XHJcbiAgICAgICAgYmlsbFRyYWNrZXJBcmdzLmdldEJpbGxzSW5mb0FyZ3MgPSBhcmdzO1xyXG5cclxuICAgICAgICBsZXQgZ3JhcGhPcHQgPSBuZXcgQmlsbFRyYWNrZXJHcmFwaE9wdGlvbnMoKTtcclxuICAgICAgICBncmFwaE9wdCA9IE9iamVjdC5hc3NpZ24oZ3JhcGhPcHQsIGdyYXBoT3B0aW9ucyk7XHJcbiAgICAgICAgYmlsbFRyYWNrZXJBcmdzLmdyYXBoT3B0aW9ucyA9IGdyYXBoT3B0O1xyXG5cclxuICAgICAgICBsZXQgZ3JpZE9wdCA9IG5ldyBCaWxsVHJhY2tlckdyaWRPcHRpb25zKCk7XHJcbiAgICAgICAgZ3JpZE9wdCA9IE9iamVjdC5hc3NpZ24oZ3JpZE9wdCwgZ3JpZE9wdGlvbnMpO1xyXG4gICAgICAgIGJpbGxUcmFja2VyQXJncy5ncmlkT3B0aW9ucyA9IGdyaWRPcHQ7XHJcblxyXG4gICAgICAgIGNvbnN0IG9wdDogQXBwT3B0aW9ucyA9IHtcclxuICAgICAgICAgIGFwcElkOiBCaWxsVHJhY2tlckNvbnN0YW50LkRFRkFVTFRfQVBQX0lELFxyXG4gICAgICAgICAgYXBwRW50cmFuY2U6IEJpbGxUcmFja2VyQ29uc3RhbnQuREVGQVVMVF9BUFBfRU5UUkFOQ0UsXHJcbiAgICAgICAgICBmdW5jSWQ6IEJpbGxUcmFja2VyQ29uc3RhbnQuREVGQVVMVF9GVU5DX0lELFxyXG4gICAgICAgICAgdGFiSWQ6IFwiYmlsbFRyYWNrZXJcIiArIERhdGUubm93KCksXHJcbiAgICAgICAgICB0YWJOYW1lOiB0aGlzLmxvY2FsZVBpcGUudHJhbnNmb3JtKFwiYmlsbFRyYWNrZXJcIiksXHJcbiAgICAgICAgICBhcHBUeXBlOiBBcHBUeXBlLkFwcCxcclxuICAgICAgICAgIGVudGl0eVBhcmFtczogYmlsbFRyYWNrZXJBcmdzLFxyXG4gICAgICAgICAgcXVlcnlTdHJpbmdQYXJhbXM6IHRoaXMuYnVpbGRRdWVyeU1hcChiaWxsVHJhY2tlckFyZ3MpLFxyXG4gICAgICAgICAgaXNSZWxvYWQ6IHVuZGVmaW5lZCxcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB0aGlzLmZyYW1ld29ya1NlcnZpY2Uub3Blbk1lbnUob3B0KTtcclxuICAgICAgICB0aGlzLmxvYWRpbmcuY2xvc2UoKTtcclxuICAgICAgfSxcclxuICAgICAgKGVycikgPT4ge1xyXG4gICAgICAgIHRoaXMubG9hZGluZy5jbG9zZSgpO1xyXG4gICAgICAgIC8vdG9kbyDnoa7lrprlvILluLjnu5PmnoQsIOebruWJjemHh+eUqOWFvOWuueWPluWAvOaWueW8j1xyXG4gICAgICAgIHRoaXMubWVzc2FnZXIuZXJyb3IoZXJyLmVycm9yID09IG51bGwgPyBlcnIubWVzc2FnZSA6IChlcnIuZXJyb3IuTWVzc2FnZSB8fCBlcnIuZXJyb3IubWVzc2FnZSB8fCBlcnIubWVzc2FnZSkpO1xyXG4gICAgICAgIHRocm93IGVycjtcclxuICAgICAgfVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIm+W7uuWNleaNrui/vei4que7hOS7tlxyXG4gICAqIEBwYXJhbSBiaWxsVHJhY2tlckFyZ3Mg5Y2V5o2u6L+96Liq5Y+C5pWwXHJcbiAgICogQHBhcmFtIGNmciBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXJcclxuICAgKiBAcGFyYW0gaW5qZWN0b3IgSW5qZWN0b3JcclxuICAgKiBAcGFyYW0gY3VzdFByb3ZpZGVycyDoh6rlrprkuYlQcm92aWRlclxyXG4gICAqIEByZXR1cm5zXHJcbiAgICovXHJcbiAgcHVibGljIGNyZWF0ZUJpbGxUcmFja2VyQ29tcG9uZW50KGJpbGxUcmFja2VyQXJnczogQmlsbFRyYWNrZXJBcmdzLCBjZnI/OiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIGluamVjdG9yPzogSW5qZWN0b3IsIGN1c3RQcm92aWRlcnM/OiBhbnlbXSkge1xyXG4gICAgY2ZyID0gY2ZyID09IG51bGwgPyB0aGlzLmNmciA6IGNmcjtcclxuICAgIGluamVjdG9yID0gaW5qZWN0b3IgPT0gbnVsbCA/IHRoaXMuaW5qZWN0b3IgOiBpbmplY3RvcjtcclxuICAgIGN1c3RQcm92aWRlcnMgPSBjdXN0UHJvdmlkZXJzID09IG51bGwgfHwgQXJyYXkuaXNBcnJheShjdXN0UHJvdmlkZXJzKSA9PSBmYWxzZSA/IFtdIDogY3VzdFByb3ZpZGVycztcclxuXHJcbiAgICBjb25zdCBpbmogPSBSZWZsZWN0aXZlSW5qZWN0b3IucmVzb2x2ZUFuZENyZWF0ZShbXHJcbiAgICAgIHsgcHJvdmlkZTogQmlsbFRyYWNrZXJBcmdzLCB1c2VWYWx1ZTogYmlsbFRyYWNrZXJBcmdzIH0sXHJcbiAgICAgIC4uLmN1c3RQcm92aWRlcnNcclxuICAgIF0sIGluamVjdG9yKTtcclxuICAgIGNvbnN0IGNtcEYgPSBjZnIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoQmlsbFRyYWNrZXJDb21wb25lbnQpO1xyXG4gICAgY29uc3QgY21wUiA9IGNtcEYuY3JlYXRlKGluaik7XHJcbiAgICByZXR1cm4gY21wUjtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiDveWQpue7p+e7rei/vei4qlxyXG4gICAqIEBwYXJhbSBhcmdzXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwdWJsaWMgY2FuVHJhY2tpbmcoYXJnczogR2V0RG93bkJpbGxzSW5mb0FyZ3MpOiBPYnNlcnZhYmxlPENhblRyYWNraW5nUmVzdWx0PiB7XHJcbiAgICByZXR1cm4gdGhpcy5kYXRhU2VydmljZS5jYW5UcmFja2luZyhhcmdzKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluS4i+a4uOWNleaNruS/oeaBr1xyXG4gICAqIEBwYXJhbSBhcmdzXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RG93bkJpbGxzSW5mbyhhcmdzOiBHZXREb3duQmlsbHNJbmZvQXJncyk6IE9ic2VydmFibGU8RG93bkJpbGxJbmZvUmVzdWx0W10+IHtcclxuICAgIHJldHVybiB0aGlzLmRhdGFTZXJ2aWNlLmdldERvd25CaWxsc0luZm8oYXJncyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bkuIrmuLjljZXmja7kv6Hmga9cclxuICAgKiBAcGFyYW0gYXJnc1xyXG4gICAqIEByZXR1cm5zXHJcbiAgICovXHJcbiAgcHVibGljIGdldFVwQmlsbHNJbmZvKGFyZ3M6IEdldFVwQmlsbHNJbmZvQXJncyk6IE9ic2VydmFibGU8VXBCaWxsSW5mb1Jlc3VsdFtdPiB7XHJcbiAgICByZXR1cm4gdGhpcy5kYXRhU2VydmljZS5nZXRVcEJpbGxzSW5mbyhhcmdzKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOafpeivouWunuS9k+aVsOaNrlxyXG4gICAqIEBwYXJhbSBhcmdzXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RW50aXR5RGF0YShhcmdzOiBHZXRNYWluRW50aXR5RGF0YUFyZ3MpOiBPYnNlcnZhYmxlPEVudGl0eURhdGFSZXN1bHQ+IHtcclxuICAgIHJldHVybiB0aGlzLmRhdGFTZXJ2aWNlLmdldEVudGl0eURhdGEoYXJncyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGJ1aWxkUXVlcnlNYXAoYmlsbFRyYWNrZXJBcmdzOiBCaWxsVHJhY2tlckFyZ3MpOiBNYXA8c3RyaW5nLCBzdHJpbmc+IHtcclxuICAgIGxldCBtYXAgPSBuZXcgTWFwKCk7XHJcbiAgICBmb3IgKGxldCBrZXkgaW4gYmlsbFRyYWNrZXJBcmdzKSB7XHJcbiAgICAgIGxldCB2YWx1ZSA9IGJpbGxUcmFja2VyQXJnc1trZXldO1xyXG4gICAgICBpZiAodHlwZW9mIHZhbHVlID09IFwib2JqZWN0XCIpIHtcclxuICAgICAgICB2YWx1ZSA9IHZhbHVlICYmIEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcclxuICAgICAgfVxyXG4gICAgICAvLyB1cmznvJbnoIHlkI5iYXNlNjTliqDlr4bvvIzpgb/lhY11cmzkuK3lh7rnjrDnibnmrorlrZfnrKZcclxuICAgICAgLy8g5ZyoZGVmYXVsdC1iaWxsLXRyYWNrZXLkuK3op6PnoIHml7blupTlhYhhdG9i5ZyoZGVjb2RlVVJJQ29tcG9uZW50XHJcbiAgICAgIG1hcC5zZXQoa2V5LCBidG9hKGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkpKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbWFwO1xyXG4gIH1cclxufVxyXG4iXX0=