/**
 * @fileoverview added by tsickle
 * Generated from: lib/bill-tracker/services/bill-tracker-internal-ui.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ComponentFactoryResolver, Inject, Injectable, Injector, LOCALE_ID } from "@angular/core";
import { JointQueryMode, JointQueryParameterType } from "@edp-bif/common-api";
import { MessagerService } from "@farris/ui-messager";
import { BsModalService } from "@farris/ui-modal";
import { AppType, FrameworkService } from "@gsp-sys/rtf-common";
import { BillTrackerConstant } from "../config/bill-tracker-constant";
import { BillTrackerLocalePipe } from "../pipe/bill-tracker-locale.pipe";
import { BillTrackerDataInfoService } from "./bill-tracker-data-info.service";
import { BillTrackerDataService } from "./bill-tracker-data.service";
import { LoadingService } from "@farris/ui-loading";
export class BillTrackerInternalUiService {
    /**
     * @param {?} framework
     * @param {?} messager
     * @param {?} loading
     * @param {?} localeId
     * @param {?} dataService
     * @param {?} dataInfoService
     * @param {?} modalService
     * @param {?} cfr
     * @param {?} injector
     * @param {?} localePipe
     */
    constructor(framework, messager, loading, localeId, dataService, dataInfoService, modalService, cfr, injector, localePipe) {
        this.framework = framework;
        this.messager = messager;
        this.loading = loading;
        this.dataService = dataService;
        this.dataInfoService = dataInfoService;
        this.modalService = modalService;
        this.cfr = cfr;
        this.injector = injector;
        this.localePipe = localePipe;
    }
    /**
     * @param {?} billInfo
     * @param {?} billDataInfo
     * @return {?}
     */
    openBillDetail(billInfo, billDataInfo) {
        /** @type {?} */
        const jointQueryMode = billInfo.jointQueryMode;
        /** @type {?} */
        const jointQueryParameters = JSON.parse(billInfo.jointQueryParameters);
        /** @type {?} */
        const id = billDataInfo.dataId;
        if (this.dataService.hasDynamicParams(jointQueryParameters)) {
            /** @type {?} */
            const args = this.dataService.buildGetJointQueryParametersArgs(jointQueryParameters, billInfo, billDataInfo);
            /** @type {?} */
            const l = this.loading.show({ message: this.localePipe.transform("loading") });
            this.dataService.getJointQueryParameters(args).subscribe((/**
             * @param {?} results
             * @return {?}
             */
            (results) => {
                l.close();
                if (jointQueryMode == JointQueryMode.APP) {
                    this.openMenu(jointQueryParameters, id, results);
                }
                else if (jointQueryMode == JointQueryMode.URL) {
                    this.openUrl(jointQueryParameters, id, results);
                }
            }), (/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                l.close();
                //todo 确定异常结构, 目前采用兼容取值方式
                this.messager.error(err.error == null ? err.message : (err.error.Message || err.error.message || err.message));
                throw err;
            }));
        }
        else {
            if (jointQueryMode == JointQueryMode.APP) {
                this.openMenu(jointQueryParameters, id);
            }
            else if (jointQueryMode == JointQueryMode.URL) {
                this.openUrl(jointQueryParameters, id);
            }
        }
    }
    /**
     * @param {?} billInfo
     * @param {?} billDataInfo
     * @param {?} fieldsWithValue
     * @return {?}
     */
    openBillDetailWithFields(billInfo, billDataInfo, fieldsWithValue) {
        /** @type {?} */
        const id = billDataInfo.dataId;
        /** @type {?} */
        const jointQueryMode = billInfo.jointQueryMode;
        /** @type {?} */
        const jointQueryParameters = JSON.parse(billInfo.jointQueryParameters);
        if (this.dataService.hasDynamicParams(jointQueryParameters)) {
            /** @type {?} */
            const l = this.loading.show({ message: this.localePipe.transform("loading") });
            /** @type {?} */
            const args = this.dataService.buildGetJointQueryParametersArgs(jointQueryParameters, billInfo, billDataInfo);
            this.dataService.getJointQueryParameters(args).subscribe((/**
             * @param {?} results
             * @return {?}
             */
            (results) => {
                l.close();
                if (jointQueryMode == JointQueryMode.APP) {
                    this.openMenu(jointQueryParameters, id, results);
                }
                else if (jointQueryMode == JointQueryMode.URL) {
                    this.openUrl(jointQueryParameters, id, results);
                }
            }), (/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                l.close();
                //todo 确定异常结构, 目前采用兼容取值方式
                this.messager.error(err.error == null ? err.message : (err.error.Message || err.error.message || err.message));
                throw err;
            }));
        }
        else {
            if (jointQueryMode == JointQueryMode.APP) {
                this.openMenu(jointQueryParameters, id);
            }
            else if (jointQueryMode == JointQueryMode.URL) {
                this.openUrl(jointQueryParameters, id);
            }
        }
    }
    /**
     * 直接打开菜单
     * @param {?} jointQueryParameters
     * @param {?} id
     * @param {?=} jqpr
     * @return {?}
     */
    openMenu(jointQueryParameters, id, jqpr) {
        /** @type {?} */
        const entityParams = {};
        entityParams["id"] = id;
        entityParams["action"] = "LoadAndView1";
        /** @type {?} */
        const map = new Map();
        map.set("id", id);
        map.set("action", "LoadAndView1");
        this.buildOpenMenuParams(jointQueryParameters, map, entityParams, jqpr);
        // 从entityParam取自定义tab名，然后删除此属性防止带入url
        /** @type {?} */
        let tabName = entityParams && entityParams[BillTrackerConstant.BILL_VIEWER_PARAM_CODE_CUSTOM_TAB_NAME];
        if (entityParams && entityParams[BillTrackerConstant.BILL_VIEWER_PARAM_CODE_CUSTOM_TAB_NAME]) {
            delete entityParams[BillTrackerConstant.BILL_VIEWER_PARAM_CODE_CUSTOM_TAB_NAME];
            map.delete(BillTrackerConstant.BILL_VIEWER_PARAM_CODE_CUSTOM_TAB_NAME);
        }
        /** @type {?} */
        const WEB_FORM_ROUTE_PARAMS = encodeURIComponent(JSON.stringify(entityParams));
        map.set("WEB_FORM_ROUTE_PARAMS", WEB_FORM_ROUTE_PARAMS);
        /** @type {?} */
        const opts = {
            appType: AppType.Menu,
            funcId: jointQueryParameters.funcId,
            appEntrance: null,
            appId: null,
            tabId: id,
            entityParams: entityParams,
            queryStringParams: map,
        };
        if (tabName) {
            // 页签名称超长时给出提醒并仅取前200个字符
            if (tabName.length > 200) {
                this.messager.warning(this.localePipe.transform("tabNameLengthIsTooLong"));
                tabName = tabName.substring(0, 200);
            }
            opts.tabName = tabName;
        }
        this.framework.openMenu(opts);
    }
    /**
     * 借助单据查看容器打开url
     * @param {?} jointQueryParameters
     * @param {?} id
     * @param {?=} jqpr
     * @return {?}
     */
    openUrl(jointQueryParameters, id, jqpr) {
        // console.log("open default container for url");
        // console.log("open default container for url");
        /** @type {?} */
        let url = this.appendQueryParam(jointQueryParameters.url, "id", id);
        url = this.appendQueryParam(url, "action", 'LoadAndView1');
        // 用于填充cvft，否则服务器端控制台报错
        /** @type {?} */
        const timestamp = new Date().getTime().toString();
        url = this.appendQueryParam(url, "cvft", timestamp);
        // 添加自定义参数
        if (Array.isArray(jointQueryParameters.params)) {
            jointQueryParameters.params.forEach((/**
             * @param {?} p
             * @return {?}
             */
            p => {
                /** @type {?} */
                let value = p.value;
                if (p.type == JointQueryParameterType.Field || p.type == JointQueryParameterType.Expression) {
                    /** @type {?} */
                    const r = jqpr.find((/**
                     * @param {?} it
                     * @return {?}
                     */
                    it => it.code == p.code));
                    value = r && r.value;
                }
                url = this.appendQueryParam(url, p.code, value);
            }));
        }
        else {
            // 兼容key-value格式params
            Object.keys(jointQueryParameters.params).forEach((/**
             * @param {?} k
             * @return {?}
             */
            (k) => {
                url = this.appendQueryParam(url, k, jointQueryParameters.params[k]);
            }));
        }
        /** @type {?} */
        const entityParams = jointQueryParameters.params || {};
        entityParams["id"] = id;
        entityParams["url"] = url;
        entityParams["action"] = "LoadAndView1";
        /** @type {?} */
        const map = new Map();
        map.set("url", url);
        map.set("id", id);
        map.set("action", "LoadAndView1");
        this.buildOpenMenuParams(jointQueryParameters, map, undefined, jqpr);
        /** @type {?} */
        const opts = {
            appType: AppType.Menu,
            funcId: BillTrackerConstant.BILL_VIEWER_FUNC_ID,
            appEntrance: null,
            appId: null,
            tabId: id,
            entityParams: entityParams,
            queryStringParams: map,
        };
        this.framework.openMenu(opts);
    }
    /**
     * @param {?} jointQueryParameters
     * @param {?} map
     * @param {?=} entityParams
     * @param {?=} jqpr
     * @return {?}
     */
    buildOpenMenuParams(jointQueryParameters, map, entityParams = {}, jqpr) {
        // 添加自定义参数
        if (Array.isArray(jointQueryParameters.params)) {
            jointQueryParameters.params.forEach((/**
             * @param {?} p
             * @return {?}
             */
            p => {
                /** @type {?} */
                let value = p.value;
                if (p.type == JointQueryParameterType.Field || p.type == JointQueryParameterType.Expression) {
                    if (jqpr) {
                        /** @type {?} */
                        const r = jqpr.find((/**
                         * @param {?} it
                         * @return {?}
                         */
                        it => it.code == p.code));
                        value = r.value;
                    }
                }
                entityParams[p.code] = value;
                map.set(p.code, value);
            }));
        }
        else {
            // 兼容key-value格式params
            Object.keys(jointQueryParameters.params).forEach((/**
             * @param {?} k
             * @return {?}
             */
            (k) => {
                entityParams[k] = jointQueryParameters.params[k];
                map.set(k, jointQueryParameters.params[k]);
            }));
        }
    }
    /**
     * @param {?} url
     * @param {?} k
     * @param {?} v
     * @return {?}
     */
    appendQueryParam(url, k, v) {
        /** @type {?} */
        let idx = url.indexOf('?');
        if (idx < 0) {
            url += '?';
        }
        idx = url.indexOf('?');
        if (url.indexOf(k, idx) > -1) {
            /** @type {?} */
            let re1 = eval('/(\\?)(' + k + '=)([^&]*)/gi');
            url = url.replace(re1, '?' + k + '=' + v);
            /** @type {?} */
            let re2 = eval('/(&)(' + k + '=)([^&]*)/gi');
            url = url.replace(re2, '&' + k + '=' + v);
        }
        else {
            /** @type {?} */
            let paraStr = k + '=' + v;
            if (idx < 0)
                url += '?';
            else if (idx >= 0 && idx != url.length - 1)
                url += '&';
            url = url + paraStr;
        }
        return url;
    }
}
BillTrackerInternalUiService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BillTrackerInternalUiService.ctorParameters = () => [
    { type: FrameworkService },
    { type: MessagerService },
    { type: LoadingService },
    { type: String, decorators: [{ type: Inject, args: [LOCALE_ID,] }] },
    { type: BillTrackerDataService },
    { type: BillTrackerDataInfoService },
    { type: BsModalService },
    { type: ComponentFactoryResolver },
    { type: Injector },
    { type: BillTrackerLocalePipe }
];
if (false) {
    /** @type {?} */
    BillTrackerInternalUiService.prototype.framework;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.messager;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.loading;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.dataService;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.dataInfoService;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.modalService;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.cfr;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.injector;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.localePipe;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmlsbC10cmFja2VyLWludGVybmFsLXVpLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZWRwLWJpZi9ydW50aW1lLWFwaS8iLCJzb3VyY2VzIjpbImxpYi9iaWxsLXRyYWNrZXIvc2VydmljZXMvYmlsbC10cmFja2VyLWludGVybmFsLXVpLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRWxHLE9BQU8sRUFBRSxjQUFjLEVBQXdCLHVCQUF1QixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDcEcsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNsRCxPQUFPLEVBQWMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFJNUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDdEUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDekUsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDOUUsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDckUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBR3BELE1BQU0sT0FBTyw0QkFBNEI7Ozs7Ozs7Ozs7Ozs7SUFFdkMsWUFDUyxTQUEyQixFQUMzQixRQUF5QixFQUN6QixPQUF1QixFQUNYLFFBQWdCLEVBQzVCLFdBQW1DLEVBQ25DLGVBQTJDLEVBQzNDLFlBQTRCLEVBQzVCLEdBQTZCLEVBQzdCLFFBQWtCLEVBQ2xCLFVBQWlDO1FBVGpDLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQzNCLGFB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LEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDOztnQkFDdEMsR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxHQUFHLGNBQWMsQ0FBQztZQUM1QyxHQUFHLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDM0M7YUFBTTs7Z0JBQ0QsT0FBTyxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztZQUV6QixJQUFJLEdBQUcsR0FBRyxDQUFDO2dCQUNULEdBQUcsSUFBSSxHQUFHLENBQUM7aUJBQ1IsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxHQUFHLENBQUM7Z0JBQ3hDLEdBQUcsSUFBSSxHQUFHLENBQUM7WUFDYixHQUFHLEdBQUcsR0FBRyxHQUFHLE9BQU8sQ0FBQztTQUNyQjtRQUNELE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQzs7O1lBdE9GLFVBQVU7Ozs7WUFWbUIsZ0JBQWdCO1lBRnJDLGVBQWU7WUFVZixjQUFjO3lDQVNsQixNQUFNLFNBQUMsU0FBUztZQVZaLHNCQUFzQjtZQUR0QiwwQkFBMEI7WUFQMUIsY0FBYztZQUpkLHdCQUF3QjtZQUFzQixRQUFRO1lBVXRELHFCQUFxQjs7OztJQVMxQixpREFBa0M7O0lBQ2xDLGdEQUFnQzs7SUFDaEMsK0NBQThCOztJQUU5QixtREFBMEM7O0lBQzFDLHVEQUFrRDs7SUFDbEQsb0RBQW1DOztJQUNuQywyQ0FBb0M7O0lBQ3BDLGdEQUF5Qjs7SUFDekIsa0RBQXdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yLCBMT0NBTEVfSUQgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBCaWxsRGF0YUZpZWxkQmFzZSwgQmlsbFNjaGVtYUZpZWxkQmFzZSB9IGZyb20gXCJAZWRwLWFpZi9jb21tb24tYXBpXCI7XHJcbmltcG9ydCB7IEpvaW50UXVlcnlNb2RlLCBKb2ludFF1ZXJ5UGFyYW1ldGVycywgSm9pbnRRdWVyeVBhcmFtZXRlclR5cGUgfSBmcm9tIFwiQGVkcC1iaWYvY29tbW9uLWFwaVwiO1xyXG5pbXBvcnQgeyBNZXNzYWdlclNlcnZpY2UgfSBmcm9tIFwiQGZhcnJpcy91aS1tZXNzYWdlclwiO1xyXG5pbXBvcnQgeyBCc01vZGFsU2VydmljZSB9IGZyb20gXCJAZmFycmlzL3VpLW1vZGFsXCI7XHJcbmltcG9ydCB7IEFwcE9wdGlvbnMsIEFwcFR5cGUsIEZyYW1ld29ya1NlcnZpY2UgfSBmcm9tIFwiQGdzcC1zeXMvcnRmLWNvbW1vblwiO1xyXG5pbXBvcnQgeyBCaWxsRGF0YUluZm8gfSBmcm9tIFwiLi4vLi4vZW50aXR5L3RyYWNraW5nL0JpbGxEYXRhSW5mb1wiO1xyXG5pbXBvcnQgeyBCaWxsSW5mbyB9IGZyb20gXCIuLi8uLi9lbnRpdHkvdHJhY2tpbmcvQmlsbEluZm9cIjtcclxuaW1wb3J0IHsgSm9pbnRRdWVyeVBhcmFtZXRlclJlc3VsdCB9IGZyb20gXCIuLi8uLi9lbnRpdHkvdHJhY2tpbmcvSm9pbnRRdWVyeVBhcmFtZXRlclJlc3VsdFwiO1xyXG5pbXBvcnQgeyBCaWxsVHJhY2tlckNvbnN0YW50IH0gZnJvbSBcIi4uL2NvbmZpZy9iaWxsLXRyYWNrZXItY29uc3RhbnRcIjtcclxuaW1wb3J0IHsgQmlsbFRyYWNrZXJMb2NhbGVQaXBlIH0gZnJvbSBcIi4uL3BpcGUvYmlsbC10cmFja2VyLWxvY2FsZS5waXBlXCI7XHJcbmltcG9ydCB7IEJpbGxUcmFja2VyRGF0YUluZm9TZXJ2aWNlIH0gZnJvbSBcIi4vYmlsbC10cmFja2VyLWRhdGEtaW5mby5zZXJ2aWNlXCI7XHJcbmltcG9ydCB7IEJpbGxUcmFja2VyRGF0YVNlcnZpY2UgfSBmcm9tIFwiLi9iaWxsLXRyYWNrZXItZGF0YS5zZXJ2aWNlXCI7XHJcbmltcG9ydCB7IExvYWRpbmdTZXJ2aWNlIH0gZnJvbSBcIkBmYXJyaXMvdWktbG9hZGluZ1wiO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQmlsbFRyYWNrZXJJbnRlcm5hbFVpU2VydmljZSB7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHVibGljIGZyYW1ld29yazogRnJhbWV3b3JrU2VydmljZSxcclxuICAgIHB1YmxpYyBtZXNzYWdlcjogTWVzc2FnZXJTZXJ2aWNlLFxyXG4gICAgcHVibGljIGxvYWRpbmc6IExvYWRpbmdTZXJ2aWNlLFxyXG4gICAgQEluamVjdChMT0NBTEVfSUQpIGxvY2FsZUlkOiBzdHJpbmcsXHJcbiAgICBwdWJsaWMgZGF0YVNlcnZpY2U6IEJpbGxUcmFja2VyRGF0YVNlcnZpY2UsXHJcbiAgICBwdWJsaWMgZGF0YUluZm9TZXJ2aWNlOiBCaWxsVHJhY2tlckRhdGFJbmZvU2VydmljZSxcclxuICAgIHB1YmxpYyBtb2RhbFNlcnZpY2U6IEJzTW9kYWxTZXJ2aWNlLFxyXG4gICAgcHVibGljIGNmcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxyXG4gICAgcHVibGljIGluamVjdG9yOiBJbmplY3RvcixcclxuICAgIHB1YmxpYyBsb2NhbGVQaXBlOiBCaWxsVHJhY2tlckxvY2FsZVBpcGUsXHJcbiAgKSB7XHJcbiAgfVxyXG5cclxuICBvcGVuQmlsbERldGFpbChiaWxsSW5mbzogQmlsbEluZm8sIGJpbGxEYXRhSW5mbzogQmlsbERhdGFJbmZvKSB7XHJcbiAgICBjb25zdCBqb2ludFF1ZXJ5TW9kZSA9IGJpbGxJbmZvLmpvaW50UXVlcnlNb2RlO1xyXG4gICAgY29uc3Qgam9pbnRRdWVyeVBhcmFtZXRlcnM6IEpvaW50UXVlcnlQYXJhbWV0ZXJzID0gSlNPTi5wYXJzZShiaWxsSW5mby5qb2ludFF1ZXJ5UGFyYW1ldGVycyk7XHJcbiAgICBjb25zdCBpZCA9IGJpbGxEYXRhSW5mby5kYXRhSWQ7XHJcblxyXG4gICAgaWYgKHRoaXMuZGF0YVNlcnZpY2UuaGFzRHluYW1pY1BhcmFtcyhqb2ludFF1ZXJ5UGFyYW1ldGVycykpIHtcclxuICAgICAgY29uc3QgYXJncyA9IHRoaXMuZGF0YVNlcnZpY2UuYnVpbGRHZXRKb2ludFF1ZXJ5UGFyYW1ldGVyc0FyZ3Moam9pbnRRdWVyeVBhcmFtZXRlcnMsIGJpbGxJbmZvLCBiaWxsRGF0YUluZm8pO1xyXG4gICAgICBjb25zdCBsID0gdGhpcy5sb2FkaW5nLnNob3coeyBtZXNzYWdlOiB0aGlzLmxvY2FsZVBpcGUudHJhbnNmb3JtKFwibG9hZGluZ1wiKSB9KTtcclxuICAgICAgdGhpcy5kYXRhU2VydmljZS5nZXRKb2ludFF1ZXJ5UGFyYW1ldGVycyhhcmdzKS5zdWJzY3JpYmUoXHJcbiAgICAgICAgKHJlc3VsdHMpID0+IHtcclxuICAgICAgICAgIGwuY2xvc2UoKTtcclxuICAgICAgICAgIGlmIChqb2ludFF1ZXJ5TW9kZSA9PSBKb2ludFF1ZXJ5TW9kZS5BUFApIHtcclxuICAgICAgICAgICAgdGhpcy5vcGVuTWVudShqb2ludFF1ZXJ5UGFyYW1ldGVycywgaWQsIHJlc3VsdHMpO1xyXG4gICAgICAgICAgfSBlbHNlIGlmIChqb2ludFF1ZXJ5TW9kZSA9PSBKb2ludFF1ZXJ5TW9kZS5VUkwpIHtcclxuICAgICAgICAgICAgdGhpcy5vcGVuVXJsKGpvaW50UXVlcnlQYXJhbWV0ZXJzLCBpZCwgcmVzdWx0cyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICAoZXJyKSA9PiB7XHJcbiAgICAgICAgICBsLmNsb3NlKCk7XHJcbiAgICAgICAgICAvL3RvZG8g56Gu5a6a5byC5bi457uT5p6ELCDnm67liY3ph4fnlKjlhbzlrrnlj5blgLzmlrnlvI9cclxuICAgICAgICAgIHRoaXMubWVzc2FnZXIuZXJyb3IoZXJyLmVycm9yID09IG51bGwgPyBlcnIubWVzc2FnZSA6IChlcnIuZXJyb3IuTWVzc2FnZSB8fCBlcnIuZXJyb3IubWVzc2FnZSB8fCBlcnIubWVzc2FnZSkpO1xyXG4gICAgICAgICAgdGhyb3cgZXJyO1xyXG4gICAgICAgIH1cclxuICAgICAgKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmIChqb2ludFF1ZXJ5TW9kZSA9PSBKb2ludFF1ZXJ5TW9kZS5BUFApIHtcclxuICAgICAgICB0aGlzLm9wZW5NZW51KGpvaW50UXVlcnlQYXJhbWV0ZXJzLCBpZCk7XHJcbiAgICAgIH0gZWxzZSBpZiAoam9pbnRRdWVyeU1vZGUgPT0gSm9pbnRRdWVyeU1vZGUuVVJMKSB7XHJcbiAgICAgICAgdGhpcy5vcGVuVXJsKGpvaW50UXVlcnlQYXJhbWV0ZXJzLCBpZCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIG9wZW5CaWxsRGV0YWlsV2l0aEZpZWxkcyhiaWxsSW5mbzogQmlsbEluZm8sIGJpbGxEYXRhSW5mbzogQmlsbERhdGFJbmZvLCBmaWVsZHNXaXRoVmFsdWU6IEJpbGxTY2hlbWFGaWVsZEJhc2VbXSkge1xyXG4gICAgY29uc3QgaWQgPSBiaWxsRGF0YUluZm8uZGF0YUlkO1xyXG4gICAgY29uc3Qgam9pbnRRdWVyeU1vZGUgPSBiaWxsSW5mby5qb2ludFF1ZXJ5TW9kZTtcclxuICAgIGNvbnN0IGpvaW50UXVlcnlQYXJhbWV0ZXJzOiBKb2ludFF1ZXJ5UGFyYW1ldGVycyA9IEpTT04ucGFyc2UoYmlsbEluZm8uam9pbnRRdWVyeVBhcmFtZXRlcnMpO1xyXG5cclxuICAgIGlmICh0aGlzLmRhdGFTZXJ2aWNlLmhhc0R5bmFtaWNQYXJhbXMoam9pbnRRdWVyeVBhcmFtZXRlcnMpKSB7XHJcbiAgICAgIGNvbnN0IGwgPSB0aGlzLmxvYWRpbmcuc2hvdyh7IG1lc3NhZ2U6IHRoaXMubG9jYWxlUGlwZS50cmFuc2Zvcm0oXCJsb2FkaW5nXCIpIH0pO1xyXG4gICAgICBjb25zdCBhcmdzID0gdGhpcy5kYXRhU2VydmljZS5idWlsZEdldEpvaW50UXVlcnlQYXJhbWV0ZXJzQXJncyhqb2ludFF1ZXJ5UGFyYW1ldGVycywgYmlsbEluZm8sIGJpbGxEYXRhSW5mbyk7XHJcbiAgICAgIHRoaXMuZGF0YVNlcnZpY2UuZ2V0Sm9pbnRRdWVyeVBhcmFtZXRlcnMoYXJncykuc3Vic2NyaWJlKFxyXG4gICAgICAgIChyZXN1bHRzKSA9PiB7XHJcbiAgICAgICAgICBsLmNsb3NlKCk7XHJcbiAgICAgICAgICBpZiAoam9pbnRRdWVyeU1vZGUgPT0gSm9pbnRRdWVyeU1vZGUuQVBQKSB7XHJcbiAgICAgICAgICAgIHRoaXMub3Blbk1lbnUoam9pbnRRdWVyeVBhcmFtZXRlcnMsIGlkLCByZXN1bHRzKTtcclxuICAgICAgICAgIH0gZWxzZSBpZiAoam9pbnRRdWVyeU1vZGUgPT0gSm9pbnRRdWVyeU1vZGUuVVJMKSB7XHJcbiAgICAgICAgICAgIHRoaXMub3BlblVybChqb2ludFF1ZXJ5UGFyYW1ldGVycywgaWQsIHJlc3VsdHMpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKGVycikgPT4ge1xyXG4gICAgICAgICAgbC5jbG9zZSgpO1xyXG4gICAgICAgICAgLy90b2RvIOehruWumuW8guW4uOe7k+aehCwg55uu5YmN6YeH55So5YW85a655Y+W5YC85pa55byPXHJcbiAgICAgICAgICB0aGlzLm1lc3NhZ2VyLmVycm9yKGVyci5lcnJvciA9PSBudWxsID8gZXJyLm1lc3NhZ2UgOiAoZXJyLmVycm9yLk1lc3NhZ2UgfHwgZXJyLmVycm9yLm1lc3NhZ2UgfHwgZXJyLm1lc3NhZ2UpKTtcclxuICAgICAgICAgIHRocm93IGVycjtcclxuICAgICAgICB9XHJcbiAgICAgICk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAoam9pbnRRdWVyeU1vZGUgPT0gSm9pbnRRdWVyeU1vZGUuQVBQKSB7XHJcbiAgICAgICAgdGhpcy5vcGVuTWVudShqb2ludFF1ZXJ5UGFyYW1ldGVycywgaWQpO1xyXG4gICAgICB9IGVsc2UgaWYgKGpvaW50UXVlcnlNb2RlID09IEpvaW50UXVlcnlNb2RlLlVSTCkge1xyXG4gICAgICAgIHRoaXMub3BlblVybChqb2ludFF1ZXJ5UGFyYW1ldGVycywgaWQpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDnm7TmjqXmiZPlvIDoj5zljZVcclxuICAgKiBAcGFyYW0gam9pbnRRdWVyeVBhcmFtZXRlcnNcclxuICAgKiBAcGFyYW0gaWRcclxuICAgKi9cclxuICBvcGVuTWVudShqb2ludFF1ZXJ5UGFyYW1ldGVyczogSm9pbnRRdWVyeVBhcmFtZXRlcnMsIGlkOiBzdHJpbmcsIGpxcHI/OiBKb2ludFF1ZXJ5UGFyYW1ldGVyUmVzdWx0W10pIHtcclxuICAgIGNvbnN0IGVudGl0eVBhcmFtcyA9IHt9O1xyXG4gICAgZW50aXR5UGFyYW1zW1wiaWRcIl0gPSBpZDtcclxuICAgIGVudGl0eVBhcmFtc1tcImFjdGlvblwiXSA9IFwiTG9hZEFuZFZpZXcxXCI7XHJcblxyXG4gICAgY29uc3QgbWFwID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcclxuICAgIG1hcC5zZXQoXCJpZFwiLCBpZCk7XHJcbiAgICBtYXAuc2V0KFwiYWN0aW9uXCIsIFwiTG9hZEFuZFZpZXcxXCIpO1xyXG5cclxuICAgIHRoaXMuYnVpbGRPcGVuTWVudVBhcmFtcyhqb2ludFF1ZXJ5UGFyYW1ldGVycywgbWFwLCBlbnRpdHlQYXJhbXMsIGpxcHIpO1xyXG5cclxuICAgIC8vIOS7jmVudGl0eVBhcmFt5Y+W6Ieq5a6a5LmJdGFi5ZCN77yM54S25ZCO5Yig6Zmk5q2k5bGe5oCn6Ziy5q2i5bim5YWldXJsXHJcbiAgICBsZXQgdGFiTmFtZTogc3RyaW5nID0gZW50aXR5UGFyYW1zICYmIGVudGl0eVBhcmFtc1tCaWxsVHJhY2tlckNvbnN0YW50LkJJTExfVklFV0VSX1BBUkFNX0NPREVfQ1VTVE9NX1RBQl9OQU1FXTtcclxuICAgIGlmIChlbnRpdHlQYXJhbXMgJiYgZW50aXR5UGFyYW1zW0JpbGxUcmFja2VyQ29uc3RhbnQuQklMTF9WSUVXRVJfUEFSQU1fQ09ERV9DVVNUT01fVEFCX05BTUVdKSB7XHJcbiAgICAgIGRlbGV0ZSBlbnRpdHlQYXJhbXNbQmlsbFRyYWNrZXJDb25zdGFudC5CSUxMX1ZJRVdFUl9QQVJBTV9DT0RFX0NVU1RPTV9UQUJfTkFNRV07XHJcbiAgICAgIG1hcC5kZWxldGUoQmlsbFRyYWNrZXJDb25zdGFudC5CSUxMX1ZJRVdFUl9QQVJBTV9DT0RFX0NVU1RPTV9UQUJfTkFNRSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgV0VCX0ZPUk1fUk9VVEVfUEFSQU1TID0gZW5jb2RlVVJJQ29tcG9uZW50KEpTT04uc3RyaW5naWZ5KGVudGl0eVBhcmFtcykpO1xyXG4gICAgbWFwLnNldChcIldFQl9GT1JNX1JPVVRFX1BBUkFNU1wiLCBXRUJfRk9STV9ST1VURV9QQVJBTVMpO1xyXG5cclxuICAgIGNvbnN0IG9wdHM6IEFwcE9wdGlvbnMgPSB7XHJcbiAgICAgIGFwcFR5cGU6IEFwcFR5cGUuTWVudSxcclxuICAgICAgZnVuY0lkOiBqb2ludFF1ZXJ5UGFyYW1ldGVycy5mdW5jSWQsXHJcbiAgICAgIGFwcEVudHJhbmNlOiBudWxsLFxyXG4gICAgICBhcHBJZDogbnVsbCxcclxuICAgICAgdGFiSWQ6IGlkLFxyXG4gICAgICBlbnRpdHlQYXJhbXM6IGVudGl0eVBhcmFtcyxcclxuICAgICAgcXVlcnlTdHJpbmdQYXJhbXM6IG1hcCxcclxuICAgIH07XHJcblxyXG4gICAgaWYgKHRhYk5hbWUpIHtcclxuICAgICAgLy8g6aG1562+5ZCN56ew6LaF6ZW/5pe257uZ5Ye65o+Q6YaS5bm25LuF5Y+W5YmNMjAw5Liq5a2X56ymXHJcbiAgICAgIGlmICh0YWJOYW1lLmxlbmd0aCA+IDIwMCkge1xyXG4gICAgICAgIHRoaXMubWVzc2FnZXIud2FybmluZyh0aGlzLmxvY2FsZVBpcGUudHJhbnNmb3JtKFwidGFiTmFtZUxlbmd0aElzVG9vTG9uZ1wiKSk7XHJcbiAgICAgICAgdGFiTmFtZSA9IHRhYk5hbWUuc3Vic3RyaW5nKDAsIDIwMCk7XHJcbiAgICAgIH1cclxuICAgICAgb3B0cy50YWJOYW1lID0gdGFiTmFtZTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmZyYW1ld29yay5vcGVuTWVudShvcHRzKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWAn+WKqeWNleaNruafpeeci+WuueWZqOaJk+W8gHVybFxyXG4gICAqIEBwYXJhbSBqb2ludFF1ZXJ5UGFyYW1ldGVyc1xyXG4gICAqIEBwYXJhbSBpZFxyXG4gICAqL1xyXG4gIG9wZW5Vcmwoam9pbnRRdWVyeVBhcmFtZXRlcnM6IEpvaW50UXVlcnlQYXJhbWV0ZXJzLCBpZDogc3RyaW5nLCBqcXByPzogSm9pbnRRdWVyeVBhcmFtZXRlclJlc3VsdFtdKSB7XHJcbiAgICAvLyBjb25zb2xlLmxvZyhcIm9wZW4gZGVmYXVsdCBjb250YWluZXIgZm9yIHVybFwiKTtcclxuXHJcbiAgICBsZXQgdXJsID0gdGhpcy5hcHBlbmRRdWVyeVBhcmFtKGpvaW50UXVlcnlQYXJhbWV0ZXJzLnVybCwgXCJpZFwiLCBpZCk7XHJcbiAgICB1cmwgPSB0aGlzLmFwcGVuZFF1ZXJ5UGFyYW0odXJsLCBcImFjdGlvblwiLCAnTG9hZEFuZFZpZXcxJyk7XHJcbiAgICAvLyDnlKjkuo7loavlhYVjdmZ077yM5ZCm5YiZ5pyN5Yqh5Zmo56uv5o6n5Yi25Y+w5oql6ZSZXHJcbiAgICBjb25zdCB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKS50b1N0cmluZygpO1xyXG4gICAgdXJsID0gdGhpcy5hcHBlbmRRdWVyeVBhcmFtKHVybCwgXCJjdmZ0XCIsIHRpbWVzdGFtcCk7XHJcblxyXG4gICAgLy8g5re75Yqg6Ieq5a6a5LmJ5Y+C5pWwXHJcbiAgICBpZiAoQXJyYXkuaXNBcnJheShqb2ludFF1ZXJ5UGFyYW1ldGVycy5wYXJhbXMpKSB7XHJcbiAgICAgIGpvaW50UXVlcnlQYXJhbWV0ZXJzLnBhcmFtcy5mb3JFYWNoKHAgPT4ge1xyXG4gICAgICAgIGxldCB2YWx1ZSA9IHAudmFsdWU7XHJcbiAgICAgICAgaWYgKHAudHlwZSA9PSBKb2ludFF1ZXJ5UGFyYW1ldGVyVHlwZS5GaWVsZCB8fCBwLnR5cGUgPT0gSm9pbnRRdWVyeVBhcmFtZXRlclR5cGUuRXhwcmVzc2lvbikge1xyXG4gICAgICAgICAgY29uc3QgciA9IGpxcHIuZmluZChpdCA9PiBpdC5jb2RlID09IHAuY29kZSk7XHJcbiAgICAgICAgICB2YWx1ZSA9IHIgJiYgci52YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdXJsID0gdGhpcy5hcHBlbmRRdWVyeVBhcmFtKHVybCwgcC5jb2RlLCB2YWx1ZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8g5YW85a65a2V5LXZhbHVl5qC85byPcGFyYW1zXHJcbiAgICAgIE9iamVjdC5rZXlzKGpvaW50UXVlcnlQYXJhbWV0ZXJzLnBhcmFtcykuZm9yRWFjaCgoaykgPT4ge1xyXG4gICAgICAgIHVybCA9IHRoaXMuYXBwZW5kUXVlcnlQYXJhbSh1cmwsIGssIGpvaW50UXVlcnlQYXJhbWV0ZXJzLnBhcmFtc1trXSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGVudGl0eVBhcmFtcyA9IGpvaW50UXVlcnlQYXJhbWV0ZXJzLnBhcmFtcyB8fCB7fTtcclxuICAgIGVudGl0eVBhcmFtc1tcImlkXCJdID0gaWQ7XHJcbiAgICBlbnRpdHlQYXJhbXNbXCJ1cmxcIl0gPSB1cmw7XHJcbiAgICBlbnRpdHlQYXJhbXNbXCJhY3Rpb25cIl0gPSBcIkxvYWRBbmRWaWV3MVwiO1xyXG5cclxuICAgIGNvbnN0IG1hcCA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XHJcbiAgICBtYXAuc2V0KFwidXJsXCIsIHVybCk7XHJcbiAgICBtYXAuc2V0KFwiaWRcIiwgaWQpO1xyXG4gICAgbWFwLnNldChcImFjdGlvblwiLCBcIkxvYWRBbmRWaWV3MVwiKTtcclxuXHJcbiAgICB0aGlzLmJ1aWxkT3Blbk1lbnVQYXJhbXMoam9pbnRRdWVyeVBhcmFtZXRlcnMsIG1hcCwgdW5kZWZpbmVkLCBqcXByKTtcclxuXHJcbiAgICBjb25zdCBvcHRzOiBBcHBPcHRpb25zID0ge1xyXG4gICAgICBhcHBUeXBlOiBBcHBUeXBlLk1lbnUsXHJcbiAgICAgIGZ1bmNJZDogQmlsbFRyYWNrZXJDb25zdGFudC5CSUxMX1ZJRVdFUl9GVU5DX0lELFxyXG4gICAgICBhcHBFbnRyYW5jZTogbnVsbCxcclxuICAgICAgYXBwSWQ6IG51bGwsXHJcbiAgICAgIHRhYklkOiBpZCxcclxuICAgICAgZW50aXR5UGFyYW1zOiBlbnRpdHlQYXJhbXMsXHJcbiAgICAgIHF1ZXJ5U3RyaW5nUGFyYW1zOiBtYXAsXHJcbiAgICB9O1xyXG4gICAgdGhpcy5mcmFtZXdvcmsub3Blbk1lbnUob3B0cyk7XHJcbiAgfVxyXG5cclxuICBidWlsZE9wZW5NZW51UGFyYW1zKGpvaW50UXVlcnlQYXJhbWV0ZXJzOiBKb2ludFF1ZXJ5UGFyYW1ldGVycywgbWFwOiBNYXA8c3RyaW5nLCBzdHJpbmc+LCBlbnRpdHlQYXJhbXM6IGFueSA9IHt9LCBqcXByPzogSm9pbnRRdWVyeVBhcmFtZXRlclJlc3VsdFtdKSB7XHJcbiAgICAvLyDmt7vliqDoh6rlrprkuYnlj4LmlbBcclxuICAgIGlmIChBcnJheS5pc0FycmF5KGpvaW50UXVlcnlQYXJhbWV0ZXJzLnBhcmFtcykpIHtcclxuICAgICAgam9pbnRRdWVyeVBhcmFtZXRlcnMucGFyYW1zLmZvckVhY2gocCA9PiB7XHJcbiAgICAgICAgbGV0IHZhbHVlID0gcC52YWx1ZTtcclxuICAgICAgICBpZiAocC50eXBlID09IEpvaW50UXVlcnlQYXJhbWV0ZXJUeXBlLkZpZWxkIHx8IHAudHlwZSA9PSBKb2ludFF1ZXJ5UGFyYW1ldGVyVHlwZS5FeHByZXNzaW9uKSB7XHJcbiAgICAgICAgICBpZiAoanFwcikge1xyXG4gICAgICAgICAgICBjb25zdCByID0ganFwci5maW5kKGl0ID0+IGl0LmNvZGUgPT0gcC5jb2RlKTtcclxuICAgICAgICAgICAgdmFsdWUgPSByLnZhbHVlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbnRpdHlQYXJhbXNbcC5jb2RlXSA9IHZhbHVlO1xyXG4gICAgICAgIG1hcC5zZXQocC5jb2RlLCB2YWx1ZSlcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyDlhbzlrrlrZXktdmFsdWXmoLzlvI9wYXJhbXNcclxuICAgICAgT2JqZWN0LmtleXMoam9pbnRRdWVyeVBhcmFtZXRlcnMucGFyYW1zKS5mb3JFYWNoKChrKSA9PiB7XHJcbiAgICAgICAgZW50aXR5UGFyYW1zW2tdID0gam9pbnRRdWVyeVBhcmFtZXRlcnMucGFyYW1zW2tdO1xyXG4gICAgICAgIG1hcC5zZXQoaywgam9pbnRRdWVyeVBhcmFtZXRlcnMucGFyYW1zW2tdKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhcHBlbmRRdWVyeVBhcmFtKHVybDogc3RyaW5nLCBrOiBzdHJpbmcsIHYpIHtcclxuICAgIGxldCBpZHggPSB1cmwuaW5kZXhPZignPycpO1xyXG4gICAgaWYgKGlkeCA8IDApIHtcclxuICAgICAgdXJsICs9ICc/JztcclxuICAgIH1cclxuICAgIGlkeCA9IHVybC5pbmRleE9mKCc/Jyk7XHJcbiAgICBpZiAodXJsLmluZGV4T2YoaywgaWR4KSA+IC0xKSB7XHJcbiAgICAgIGxldCByZTEgPSBldmFsKCcvKFxcXFw/KSgnICsgayArICc9KShbXiZdKikvZ2knKTtcclxuICAgICAgdXJsID0gdXJsLnJlcGxhY2UocmUxLCAnPycgKyBrICsgJz0nICsgdik7XHJcbiAgICAgIGxldCByZTIgPSBldmFsKCcvKCYpKCcgKyBrICsgJz0pKFteJl0qKS9naScpO1xyXG4gICAgICB1cmwgPSB1cmwucmVwbGFjZShyZTIsICcmJyArIGsgKyAnPScgKyB2KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGxldCBwYXJhU3RyID0gayArICc9JyArIHY7XHJcblxyXG4gICAgICBpZiAoaWR4IDwgMClcclxuICAgICAgICB1cmwgKz0gJz8nO1xyXG4gICAgICBlbHNlIGlmIChpZHggPj0gMCAmJiBpZHggIT0gdXJsLmxlbmd0aCAtIDEpXHJcbiAgICAgICAgdXJsICs9ICcmJztcclxuICAgICAgdXJsID0gdXJsICsgcGFyYVN0cjtcclxuICAgIH1cclxuICAgIHJldHVybiB1cmw7XHJcbiAgfVxyXG59XHJcbiJdfQ==