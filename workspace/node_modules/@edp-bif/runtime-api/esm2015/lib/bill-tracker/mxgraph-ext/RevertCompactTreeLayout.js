/**
 * @fileoverview added by tsickle
 * Generated from: lib/bill-tracker/mxgraph-ext/RevertCompactTreeLayout.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { mxCompactTreeLayout, mxCellPath, mxDictionary } from '../../ref/mxgraph';
export class RevertCompactTreeLayout extends mxCompactTreeLayout {
    /**
     * @param {?} graph
     * @param {?=} horizontal
     * @param {?=} invert
     */
    constructor(graph, horizontal, invert) {
        super(graph, horizontal, invert);
        this.useBoundingBox = false;
    }
    /**
     * @param {?} cell
     * @param {?} parent
     * @return {?}
     */
    dfs(cell, parent) {
        /** @type {?} */
        let id = mxCellPath.create(cell);
        /** @type {?} */
        let node = null;
        if (cell != null && this.visited[id] == null && !this.isVertexIgnored(cell)) {
            this.visited[id] = cell;
            node = this.createNode(cell);
            /** @type {?} */
            let model = this.graph.getModel();
            /** @type {?} */
            let prev = null;
            // let out = this.graph.getEdges(cell, parent, this.invert, !this.invert, false, true);
            /** @type {?} */
            let ins = this.graph.getEdges(cell, parent, !this.invert, this.invert, false, true);
            /** @type {?} */
            let view = this.graph.getView();
            if (this.sortEdges) {
                // this.sortOutgoingEdges(cell, out);
                this.sortIngoingEdges(cell, ins);
            }
            for (let i = 0; i < ins.length; i++) {
                /** @type {?} */
                let edge = ins[i];
                if (!this.isEdgeIgnored(edge)) {
                    // Resets the points on the traversed edge
                    if (this.resetEdges) {
                        this.setEdgePoints(edge, null);
                    }
                    if (this.edgeRouting) {
                        this.setEdgeStyleEnabled(edge, false);
                        this.setEdgePoints(edge, null);
                    }
                    // Checks if terminal in same swimlane
                    /** @type {?} */
                    let state = view.getState(edge);
                    // let target = (state != null) ? state.getVisibleTerminal(this.invert) : view.getVisibleTerminal(edge, this.invert);
                    /** @type {?} */
                    let source = (state != null) ? state.getVisibleTerminal(!this.invert) : view.getVisibleTerminal(edge, !this.invert);
                    /** @type {?} */
                    let tmp = this.dfs(source, parent);
                    if (tmp != null && model.getGeometry(source) != null) {
                        if (prev == null) {
                            node.child = tmp;
                        }
                        else {
                            prev.next = tmp;
                        }
                        prev = tmp;
                    }
                }
            }
        }
        return node;
    }
    /**
     * @param {?} target
     * @param {?} edges
     * @return {?}
     */
    sortIngoingEdges(target, edges) {
        /** @type {?} */
        let lookup = new mxDictionary();
        edges.sort((/**
         * @param {?} e1
         * @param {?} e2
         * @return {?}
         */
        function (e1, e2) {
            /** @type {?} */
            let start1 = e1.getTerminal(e1.getTerminal(true) == target);
            // let end1 = e1.getTerminal(e1.getTerminal(true) == target);
            /** @type {?} */
            let p1 = lookup.get(start1);
            if (p1 == null) {
                p1 = mxCellPath.create(start1).split(mxCellPath.PATH_SEPARATOR);
                lookup.put(start1, p1);
            }
            /** @type {?} */
            let start2 = e2.getTerminal(e2.getTerminal(true) == target);
            /** @type {?} */
            let p2 = lookup.get(start2);
            if (p2 == null) {
                p2 = mxCellPath.create(start2).split(mxCellPath.PATH_SEPARATOR);
                lookup.put(start2, p2);
            }
            return mxCellPath.compare(p1, p2);
        }));
    }
    /**
     * @param {?} parent
     * @param {?} dest
     * @return {?}
     */
    execute(parent, dest) {
        this.parent = parent;
        /** @type {?} */
        let model = this.graph.getModel();
        if (dest == null) {
            // Takes the parent as the root if it has outgoing edges
            if (this.graph.getEdges(parent, model.getParent(parent), !this.invert, this.invert, false).length > 0) {
                this.root = parent;
            }
            // Tries to find a suitable root in the parent's
            // children
            else {
                /** @type {?} */
                let dests = this.graph.findTreeRoots(parent, true, true);
                if (dests.length > 0) {
                    for (let i = 0; i < dests.length; i++) {
                        if (!this.isVertexIgnored(dests[i]) &&
                            this.graph.getEdges(dests[i], null, !this.invert, this.invert, false).length > 0) {
                            this.root = dests[i];
                            break;
                        }
                    }
                }
            }
        }
        else {
            this.root = dest;
        }
        if (this.root != null) {
            if (this.resizeParent) {
                this.parentsChanged = new Object();
            }
            else {
                this.parentsChanged = null;
            }
            //  Maintaining parent location
            this.parentX = null;
            this.parentY = null;
            if (parent != this.root && model.isVertex(parent) != null && this.maintainParentLocation) {
                /** @type {?} */
                let geo = this.graph.getCellGeometry(parent);
                if (geo != null) {
                    this.parentX = geo.x;
                    this.parentY = geo.y;
                }
            }
            model.beginUpdate();
            try {
                this.visited = {};
                this.node = this.dfs(this.root, parent);
                if (this.alignRanks) {
                    this.maxRankHeight = [];
                    this.findRankHeights(this.node, 0);
                    this.setCellHeights(this.node, 0);
                }
                if (this.node != null) {
                    this.layout(this.node);
                    /** @type {?} */
                    let x0 = this.graph.gridSize;
                    /** @type {?} */
                    let y0 = x0;
                    if (!this.moveTree) {
                        /** @type {?} */
                        let g = this.getVertexBounds(this.root);
                        if (g != null) {
                            x0 = g.x;
                            y0 = g.y;
                        }
                    }
                    /** @type {?} */
                    let bounds = null;
                    if (this.isHorizontal()) {
                        bounds = this.horizontalLayout(this.node, -x0, y0);
                    }
                    else {
                        bounds = this.verticalLayout(this.node, null, x0, y0);
                    }
                    if (bounds != null) {
                        /** @type {?} */
                        let dx = 0;
                        /** @type {?} */
                        let dy = 0;
                        if (bounds.x > 0) {
                            dx = -1 * Math.abs(x0 - bounds.x);
                        }
                        if (bounds.y > 0) {
                            dy = -1 * Math.abs(y0 - bounds.y);
                        }
                        if (dx != 0 || dy != 0) {
                            this.moveNode(this.node, dx, dy);
                        }
                        if (this.resizeParent) {
                            this.adjustParents();
                        }
                        if (this.edgeRouting) {
                            // Iterate through all edges setting their positions
                            this.localEdgeProcessing(this.node);
                        }
                    }
                    // Maintaining parent location
                    if (this.parentX != null && this.parentY != null) {
                        /** @type {?} */
                        let geo = this.graph.getCellGeometry(parent);
                        if (geo != null) {
                            geo = geo.clone();
                            geo.x = this.parentX;
                            geo.y = this.parentY;
                            model.setGeometry(parent, geo);
                        }
                    }
                }
            }
            finally {
                model.endUpdate();
            }
        }
    }
    /**
     * @param {?} node
     * @param {?} x0
     * @param {?} y0
     * @param {?=} bounds
     * @return {?}
     */
    horizontalLayout(node, x0, y0, bounds) {
        node.x += x0 - node.offsetX;
        node.y += y0 + node.offsetY;
        bounds = this.apply(node, bounds);
        /** @type {?} */
        var child = node.child;
        if (child != null) {
            bounds = this.horizontalLayout(child, node.x, node.y, bounds);
            /** @type {?} */
            var siblingOffset = node.y + child.offsetY;
            /** @type {?} */
            var s = child.next;
            while (s != null) {
                bounds = this.horizontalLayout(s, node.x - child.offsetX, siblingOffset, bounds);
                siblingOffset += s.offsetY;
                s = s.next;
            }
        }
        return bounds;
    }
}
if (false) {
    /** @type {?} */
    RevertCompactTreeLayout.prototype.visited;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.graph;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.sortEdges;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.parent;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.parentsChanged;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.parentX;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.parentY;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.node;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.alignRanks;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.maxRankHeight;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.moveTree;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.nodeDistance;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.useBoundingBox;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmV2ZXJ0Q29tcGFjdFRyZWVMYXlvdXQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZWRwLWJpZi9ydW50aW1lLWFwaS8iLCJzb3VyY2VzIjpbImxpYi9iaWxsLXRyYWNrZXIvbXhncmFwaC1leHQvUmV2ZXJ0Q29tcGFjdFRyZWVMYXlvdXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBMEIsTUFBTSxtQkFBbUIsQ0FBQztBQUUxRyxNQUFNLE9BQU8sdUJBQXdCLFNBQVEsbUJBQW1COzs7Ozs7SUFjNUQsWUFBWSxLQUF3QixFQUFFLFVBQW9CLEVBQUUsTUFBZ0I7UUFDeEUsS0FBSyxDQUFDLEtBQUssRUFBRSxVQUFVLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFGckMsbUJBQWMsR0FBWSxLQUFLLENBQUM7SUFHaEMsQ0FBQzs7Ozs7O0lBRUQsR0FBRyxDQUFDLElBQXNCLEVBQUUsTUFBd0I7O1lBQzVDLEVBQUUsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQzs7WUFDNUIsSUFBSSxHQUFHLElBQUk7UUFFZixJQUFJLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3pFLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDO1lBQ3hCLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDOztnQkFFekIsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFOztnQkFDN0IsSUFBSSxHQUFHLElBQUk7OztnQkFFWCxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxN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LENBQUM7YUFDZDtTQUNKO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztDQStFSjs7O0lBelVHLDBDQUE0Qzs7SUFDNUMsd0NBQXlCOztJQUN6Qiw0Q0FBZTs7SUFDZix5Q0FBeUI7O0lBQ3pCLGlEQUF1Qjs7SUFDdkIsMENBQWdCOztJQUNoQiwwQ0FBZ0I7O0lBQ2hCLHVDQUFVOztJQUNWLDZDQUFnQjs7SUFDaEIsZ0RBQXFCOztJQUNyQiwyQ0FBYzs7SUFDZCwrQ0FBa0I7O0lBQ2xCLGlEQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG14Q29tcGFjdFRyZWVMYXlvdXQsIG14Q2VsbFBhdGgsIG14RGljdGlvbmFyeSwgTXhHcmFwaE5TLCBteFJlY3RhbmdsZSB9IGZyb20gJy4uLy4uL3JlZi9teGdyYXBoJztcclxuXHJcbmV4cG9ydCBjbGFzcyBSZXZlcnRDb21wYWN0VHJlZUxheW91dCBleHRlbmRzIG14Q29tcGFjdFRyZWVMYXlvdXQge1xyXG4gICAgdmlzaXRlZDogeyBbaWQ6IHN0cmluZ106IE14R3JhcGhOUy5teENlbGwgfTtcclxuICAgIGdyYXBoOiBNeEdyYXBoTlMubXhHcmFwaDtcclxuICAgIHNvcnRFZGdlczogYW55O1xyXG4gICAgcGFyZW50OiBNeEdyYXBoTlMubXhDZWxsO1xyXG4gICAgcGFyZW50c0NoYW5nZWQ6IE9iamVjdDtcclxuICAgIHBhcmVudFg6IG51bWJlcjtcclxuICAgIHBhcmVudFk6IG51bWJlcjtcclxuICAgIG5vZGU6IGFueTtcclxuICAgIGFsaWduUmFua3M6IGFueTtcclxuICAgIG1heFJhbmtIZWlnaHQ6IGFueVtdO1xyXG4gICAgbW92ZVRyZWU6IGFueTtcclxuICAgIG5vZGVEaXN0YW5jZTogYW55O1xyXG4gICAgdXNlQm91bmRpbmdCb3g6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIGNvbnN0cnVjdG9yKGdyYXBoOiBNeEdyYXBoTlMubXhHcmFwaCwgaG9yaXpvbnRhbD86IGJvb2xlYW4sIGludmVydD86IGJvb2xlYW4pIHtcclxuICAgICAgICBzdXBlcihncmFwaCwgaG9yaXpvbnRhbCwgaW52ZXJ0KTtcclxuICAgIH1cclxuXHJcbiAgICBkZnMoY2VsbDogTXhHcmFwaE5TLm14Q2VsbCwgcGFyZW50OiBNeEdyYXBoTlMubXhDZWxsKSB7XHJcbiAgICAgICAgbGV0IGlkID0gbXhDZWxsUGF0aC5jcmVhdGUoY2VsbCk7XHJcbiAgICAgICAgbGV0IG5vZGUgPSBudWxsO1xyXG5cclxuICAgICAgICBpZiAoY2VsbCAhPSBudWxsICYmIHRoaXMudmlzaXRlZFtpZF0gPT0gbnVsbCAmJiAhdGhpcy5pc1ZlcnRleElnbm9yZWQoY2VsbCkpIHtcclxuICAgICAgICAgICAgdGhpcy52aXNpdGVkW2lkXSA9IGNlbGw7XHJcbiAgICAgICAgICAgIG5vZGUgPSB0aGlzLmNyZWF0ZU5vZGUoY2VsbCk7XHJcblxyXG4gICAgICAgICAgICBsZXQgbW9kZWwgPSB0aGlzLmdyYXBoLmdldE1vZGVsKCk7XHJcbiAgICAgICAgICAgIGxldCBwcmV2ID0gbnVsbDtcclxuICAgICAgICAgICAgLy8gbGV0IG91dCA9IHRoaXMuZ3JhcGguZ2V0RWRnZXMoY2VsbCwgcGFyZW50LCB0aGlzLmludmVydCwgIXRoaXMuaW52ZXJ0LCBmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIGxldCBpbnMgPSB0aGlzLmdyYXBoLmdldEVkZ2VzKGNlbGwsIHBhcmVudCwgIXRoaXMuaW52ZXJ0LCB0aGlzLmludmVydCwgZmFsc2UsIHRydWUpO1xyXG4gICAgICAgICAgICBsZXQgdmlldyA9IHRoaXMuZ3JhcGguZ2V0VmlldygpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuc29ydEVkZ2VzKSB7XHJcbiAgICAgICAgICAgICAgICAvLyB0aGlzLnNvcnRPdXRnb2luZ0VkZ2VzKGNlbGwsIG91dCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNvcnRJbmdvaW5nRWRnZXMoY2VsbCwgaW5zKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGxldCBlZGdlID0gaW5zW2ldO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0VkZ2VJZ25vcmVkKGVkZ2UpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXRzIHRoZSBwb2ludHMgb24gdGhlIHRyYXZlcnNlZCBlZGdlXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucmVzZXRFZGdlcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEVkZ2VQb2ludHMoZWRnZSwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5lZGdlUm91dGluZykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEVkZ2VTdHlsZUVuYWJsZWQoZWRnZSwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEVkZ2VQb2ludHMoZWRnZSwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBDaGVja3MgaWYgdGVybWluYWwgaW4gc2FtZSBzd2ltbGFuZVxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzdGF0ZSA9IHZpZXcuZ2V0U3RhdGUoZWRnZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gbGV0IHRhcmdldCA9IChzdGF0ZSAhPSBudWxsKSA/IHN0YXRlLmdldFZpc2libGVUZXJtaW5hbCh0aGlzLmludmVydCkgOiB2aWV3LmdldFZpc2libGVUZXJtaW5hbChlZGdlLCB0aGlzLmludmVydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHNvdXJjZSA9IChzdGF0ZSAhPSBudWxsKSA/IHN0YXRlLmdldFZpc2libGVUZXJtaW5hbCghdGhpcy5pbnZlcnQpIDogdmlldy5nZXRWaXNpYmxlVGVybWluYWwoZWRnZSwgIXRoaXMuaW52ZXJ0KTtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgdG1wID0gdGhpcy5kZnMoc291cmNlLCBwYXJlbnQpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAodG1wICE9IG51bGwgJiYgbW9kZWwuZ2V0R2VvbWV0cnkoc291cmNlKSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2ID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuY2hpbGQgPSB0bXA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2Lm5leHQgPSB0bXA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZXYgPSB0bXA7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gbm9kZTtcclxuICAgIH1cclxuXHJcbiAgICBzb3J0SW5nb2luZ0VkZ2VzKHRhcmdldDogTXhHcmFwaE5TLm14Q2VsbCwgZWRnZXM6IE14R3JhcGhOUy5teENlbGxbXSkge1xyXG4gICAgICAgIGxldCBsb29rdXAgPSBuZXcgbXhEaWN0aW9uYXJ5KCk7XHJcblxyXG4gICAgICAgIGVkZ2VzLnNvcnQoZnVuY3Rpb24gKGUxLCBlMikge1xyXG4gICAgICAgICAgICBsZXQgc3RhcnQxID0gZTEuZ2V0VGVybWluYWwoZTEuZ2V0VGVybWluYWwodHJ1ZSkgPT0gdGFyZ2V0KTtcclxuICAgICAgICAgICAgLy8gbGV0IGVuZDEgPSBlMS5nZXRUZXJtaW5hbChlMS5nZXRUZXJtaW5hbCh0cnVlKSA9PSB0YXJnZXQpO1xyXG4gICAgICAgICAgICBsZXQgcDEgPSBsb29rdXAuZ2V0KHN0YXJ0MSk7XHJcblxyXG4gICAgICAgICAgICBpZiAocDEgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgcDEgPSBteENlbGxQYXRoLmNyZWF0ZShzdGFydDEpLnNwbGl0KG14Q2VsbFBhdGguUEFUSF9TRVBBUkFUT1IpO1xyXG4gICAgICAgICAgICAgICAgbG9va3VwLnB1dChzdGFydDEsIHAxKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IHN0YXJ0MiA9IGUyLmdldFRlcm1pbmFsKGUyLmdldFRlcm1pbmFsKHRydWUpID09IHRhcmdldCk7XHJcbiAgICAgICAgICAgIGxldCBwMiA9IGxvb2t1cC5nZXQoc3RhcnQyKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChwMiA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBwMiA9IG14Q2VsbFBhdGguY3JlYXRlKHN0YXJ0Mikuc3BsaXQobXhDZWxsUGF0aC5QQVRIX1NFUEFSQVRPUik7XHJcbiAgICAgICAgICAgICAgICBsb29rdXAucHV0KHN0YXJ0MiwgcDIpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gbXhDZWxsUGF0aC5jb21wYXJlKHAxLCBwMik7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZXhlY3V0ZShwYXJlbnQ6IE14R3JhcGhOUy5teENlbGwsIGRlc3Q6IE14R3JhcGhOUy5teENlbGwpIHtcclxuICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDtcclxuICAgICAgICBsZXQgbW9kZWwgPSB0aGlzLmdyYXBoLmdldE1vZGVsKCk7XHJcblxyXG4gICAgICAgIGlmIChkZXN0ID09IG51bGwpIHtcclxuICAgICAgICAgICAgLy8gVGFrZXMgdGhlIHBhcmVudCBhcyB0aGUgcm9vdCBpZiBpdCBoYXMgb3V0Z29pbmcgZWRnZXNcclxuICAgICAgICAgICAgaWYgKHRoaXMuZ3JhcGguZ2V0RWRnZXMocGFyZW50LCBtb2RlbC5nZXRQYXJlbnQocGFyZW50KSxcclxuICAgICAgICAgICAgICAgICF0aGlzLmludmVydCwgdGhpcy5pbnZlcnQsIGZhbHNlKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJvb3QgPSBwYXJlbnQ7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIFRyaWVzIHRvIGZpbmQgYSBzdWl0YWJsZSByb290IGluIHRoZSBwYXJlbnQnc1xyXG4gICAgICAgICAgICAvLyBjaGlsZHJlblxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGxldCBkZXN0cyA9IHRoaXMuZ3JhcGguZmluZFRyZWVSb290cyhwYXJlbnQsIHRydWUsIHRydWUpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChkZXN0cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkZXN0cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNWZXJ0ZXhJZ25vcmVkKGRlc3RzW2ldKSAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ncmFwaC5nZXRFZGdlcyhkZXN0c1tpXSwgbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAhdGhpcy5pbnZlcnQsIHRoaXMuaW52ZXJ0LCBmYWxzZSkubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yb290ID0gZGVzdHNbaV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5yb290ID0gZGVzdDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnJvb3QgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5yZXNpemVQYXJlbnQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucGFyZW50c0NoYW5nZWQgPSBuZXcgT2JqZWN0KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBhcmVudHNDaGFuZ2VkID0gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gIE1haW50YWluaW5nIHBhcmVudCBsb2NhdGlvblxyXG4gICAgICAgICAgICB0aGlzLnBhcmVudFggPSBudWxsO1xyXG4gICAgICAgICAgICB0aGlzLnBhcmVudFkgPSBudWxsO1xyXG5cclxuICAgICAgICAgICAgaWYgKHBhcmVudCAhPSB0aGlzLnJvb3QgJiYgbW9kZWwuaXNWZXJ0ZXgocGFyZW50KSAhPSBudWxsICYmIHRoaXMubWFpbnRhaW5QYXJlbnRMb2NhdGlvbikge1xyXG4gICAgICAgICAgICAgICAgbGV0IGdlbyA9IHRoaXMuZ3JhcGguZ2V0Q2VsbEdlb21ldHJ5KHBhcmVudCk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGdlbyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJlbnRYID0gZ2VvLng7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJlbnRZID0gZ2VvLnk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIG1vZGVsLmJlZ2luVXBkYXRlKCk7XHJcblxyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy52aXNpdGVkID0ge307XHJcbiAgICAgICAgICAgICAgICB0aGlzLm5vZGUgPSB0aGlzLmRmcyh0aGlzLnJvb3QsIHBhcmVudCk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuYWxpZ25SYW5rcykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWF4UmFua0hlaWdodCA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmluZFJhbmtIZWlnaHRzKHRoaXMubm9kZSwgMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDZWxsSGVpZ2h0cyh0aGlzLm5vZGUsIDApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLm5vZGUgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubGF5b3V0KHRoaXMubm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHgwID0gdGhpcy5ncmFwaC5ncmlkU2l6ZTtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgeTAgPSB4MDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLm1vdmVUcmVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBnID0gdGhpcy5nZXRWZXJ0ZXhCb3VuZHModGhpcy5yb290KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHgwID0gZy54O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeTAgPSBnLnk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBib3VuZHMgPSBudWxsO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0hvcml6b250YWwoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBib3VuZHMgPSB0aGlzLmhvcml6b250YWxMYXlvdXQodGhpcy5ub2RlLCAteDAsIHkwKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvdW5kcyA9IHRoaXMudmVydGljYWxMYXlvdXQodGhpcy5ub2RlLCBudWxsLCB4MCwgeTApO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJvdW5kcyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBkeCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBkeSA9IDA7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYm91bmRzLnggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkeCA9IC0xICogTWF0aC5hYnMoeDAgLSBib3VuZHMueCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChib3VuZHMueSA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGR5ID0gLTEgKiBNYXRoLmFicyh5MCAtIGJvdW5kcy55KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGR4ICE9IDAgfHwgZHkgIT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb3ZlTm9kZSh0aGlzLm5vZGUsIGR4LCBkeSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlc2l6ZVBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGp1c3RQYXJlbnRzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmVkZ2VSb3V0aW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJdGVyYXRlIHRocm91Z2ggYWxsIGVkZ2VzIHNldHRpbmcgdGhlaXIgcG9zaXRpb25zXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsRWRnZVByb2Nlc3NpbmcodGhpcy5ub2RlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gTWFpbnRhaW5pbmcgcGFyZW50IGxvY2F0aW9uXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50WCAhPSBudWxsICYmIHRoaXMucGFyZW50WSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBnZW8gPSB0aGlzLmdyYXBoLmdldENlbGxHZW9tZXRyeShwYXJlbnQpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdlbyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZW8gPSBnZW8uY2xvbmUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlby54ID0gdGhpcy5wYXJlbnRYO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2VvLnkgPSB0aGlzLnBhcmVudFk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbC5zZXRHZW9tZXRyeShwYXJlbnQsIGdlbyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZmluYWxseSB7XHJcbiAgICAgICAgICAgICAgICBtb2RlbC5lbmRVcGRhdGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBob3Jpem9udGFsTGF5b3V0KG5vZGUsIHgwOiBudW1iZXIsIHkwOiBudW1iZXIsIGJvdW5kcz86IE14R3JhcGhOUy5teFJlY3RhbmdsZSkge1xyXG4gICAgICAgIG5vZGUueCArPSB4MCAtIG5vZGUub2Zmc2V0WDtcclxuICAgICAgICBub2RlLnkgKz0geTAgKyBub2RlLm9mZnNldFk7XHJcbiAgICAgICAgYm91bmRzID0gdGhpcy5hcHBseShub2RlLCBib3VuZHMpO1xyXG4gICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7XHJcblxyXG4gICAgICAgIGlmIChjaGlsZCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGJvdW5kcyA9IHRoaXMuaG9yaXpvbnRhbExheW91dChjaGlsZCwgbm9kZS54LCBub2RlLnksIGJvdW5kcyk7XHJcbiAgICAgICAgICAgIHZhciBzaWJsaW5nT2Zmc2V0ID0gbm9kZS55ICsgY2hpbGQub2Zmc2V0WTtcclxuICAgICAgICAgICAgdmFyIHMgPSBjaGlsZC5uZXh0O1xyXG5cclxuICAgICAgICAgICAgd2hpbGUgKHMgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgYm91bmRzID0gdGhpcy5ob3Jpem9udGFsTGF5b3V0KHMsIG5vZGUueCAtIGNoaWxkLm9mZnNldFgsIHNpYmxpbmdPZmZzZXQsIGJvdW5kcyk7XHJcbiAgICAgICAgICAgICAgICBzaWJsaW5nT2Zmc2V0ICs9IHMub2Zmc2V0WTtcclxuICAgICAgICAgICAgICAgIHMgPSBzLm5leHQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBib3VuZHM7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gbGF5b3V0KG5vZGUpIHtcclxuICAgIC8vICAgICBpZiAobm9kZSAhPSBudWxsKSB7XHJcbiAgICAvLyAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7XHJcblxyXG4gICAgLy8gICAgICAgICB3aGlsZSAoY2hpbGQgIT0gbnVsbCkge1xyXG4gICAgLy8gICAgICAgICAgICAgdGhpcy5sYXlvdXQoY2hpbGQpO1xyXG4gICAgLy8gICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5uZXh0O1xyXG4gICAgLy8gICAgICAgICB9XHJcblxyXG4gICAgLy8gICAgICAgICBpZiAobm9kZS5jaGlsZCAhPSBudWxsKSB7XHJcbiAgICAvLyAgICAgICAgICAgICB0aGlzLmF0dGFjaFBhcmVudChub2RlLCB0aGlzLmpvaW4obm9kZSkpO1xyXG4gICAgLy8gICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgIGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgICAgdGhpcy5sYXlvdXRMZWFmKG5vZGUpO1xyXG4gICAgLy8gICAgICAgICB9XHJcbiAgICAvLyAgICAgfVxyXG4gICAgLy8gfVxyXG5cclxuICAgIC8vIGFwcGx5KG5vZGUsIGJvdW5kcykge1xyXG4gICAgLy8gICAgIHZhciBtb2RlbCA9IHRoaXMuZ3JhcGguZ2V0TW9kZWwoKTtcclxuICAgIC8vICAgICB2YXIgY2VsbCA9IG5vZGUuY2VsbDtcclxuICAgIC8vICAgICB2YXIgZyA9IG1vZGVsLmdldEdlb21ldHJ5KGNlbGwpO1xyXG5cclxuICAgIC8vICAgICBpZiAoY2VsbCAhPSBudWxsICYmIGcgIT0gbnVsbCkge1xyXG4gICAgLy8gICAgICAgICBpZiAodGhpcy5pc1ZlcnRleE1vdmFibGUoY2VsbCkpIHtcclxuICAgIC8vICAgICAgICAgICAgIGcgPSB0aGlzLnNldFZlcnRleExvY2F0aW9uKGNlbGwsIG5vZGUueCwgbm9kZS55KTtcclxuXHJcbiAgICAvLyAgICAgICAgICAgICBpZiAodGhpcy5yZXNpemVQYXJlbnQpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gbW9kZWwuZ2V0UGFyZW50KGNlbGwpO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIHZhciBpZCA9IG14Q2VsbFBhdGguY3JlYXRlKHBhcmVudCk7XHJcblxyXG4gICAgLy8gICAgICAgICAgICAgICAgIC8vIEltcGxlbWVudHMgc2V0IHNlbWFudGljXHJcbiAgICAvLyAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50c0NoYW5nZWRbaWRdID09IG51bGwpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJlbnRzQ2hhbmdlZFtpZF0gPSBwYXJlbnQ7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICB9XHJcblxyXG4gICAgLy8gICAgICAgICBpZiAoYm91bmRzID09IG51bGwpIHtcclxuICAgIC8vICAgICAgICAgICAgIGJvdW5kcyA9IG5ldyBteFJlY3RhbmdsZShnLngsIGcueSwgZy53aWR0aCwgZy5oZWlnaHQpO1xyXG4gICAgLy8gICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgIGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgICAgYm91bmRzID0gbmV3IG14UmVjdGFuZ2xlKE1hdGgubWluKGJvdW5kcy54LCBnLngpLFxyXG4gICAgLy8gICAgICAgICAgICAgICAgIE1hdGgubWluKGJvdW5kcy55LCBnLnkpLFxyXG4gICAgLy8gICAgICAgICAgICAgICAgIE1hdGgubWF4KGJvdW5kcy54ICsgYm91bmRzLndpZHRoLCBnLnggKyBnLndpZHRoKSxcclxuICAgIC8vICAgICAgICAgICAgICAgICBNYXRoLm1heChib3VuZHMueSArIGJvdW5kcy5oZWlnaHQsIGcueSArIGcuaGVpZ2h0KSk7XHJcbiAgICAvLyAgICAgICAgIH1cclxuICAgIC8vICAgICB9XHJcblxyXG4gICAgLy8gICAgIHJldHVybiBib3VuZHM7XHJcbiAgICAvLyB9XHJcblxyXG4gICAgLy8gYXR0YWNoUGFyZW50KG5vZGUsIGhlaWdodCkge1xyXG4gICAgLy8gICAgIGxldCB4ID0gdGhpcy5ub2RlRGlzdGFuY2UgKyB0aGlzLmxldmVsRGlzdGFuY2U7XHJcbiAgICAvLyAgICAgbGV0IHkyID0gKGhlaWdodCAtIG5vZGUud2lkdGgpIC8gMiAtIHRoaXMubm9kZURpc3RhbmNlO1xyXG4gICAgLy8gICAgIGxldCB5MSA9IHkyICsgbm9kZS53aWR0aCArIDIgKiB0aGlzLm5vZGVEaXN0YW5jZSAtIGhlaWdodDtcclxuXHJcbiAgICAvLyAgICAgbm9kZS5jaGlsZC5vZmZzZXRYID0geCArIG5vZGUuaGVpZ2h0O1xyXG4gICAgLy8gICAgIG5vZGUuY2hpbGQub2Zmc2V0WSA9IHkxO1xyXG5cclxuICAgIC8vICAgICBub2RlLmNvbnRvdXIudXBwZXJIZWFkID0gdGhpcy5jcmVhdGVMaW5lKG5vZGUuaGVpZ2h0LCAwLFxyXG4gICAgLy8gICAgICAgICB0aGlzLmNyZWF0ZUxpbmUoeCwgeTEsIG5vZGUuY29udG91ci51cHBlckhlYWQpKTtcclxuICAgIC8vICAgICBub2RlLmNvbnRvdXIubG93ZXJIZWFkID0gdGhpcy5jcmVhdGVMaW5lKG5vZGUuaGVpZ2h0LCAwLFxyXG4gICAgLy8gICAgICAgICB0aGlzLmNyZWF0ZUxpbmUoeCwgeTIsIG5vZGUuY29udG91ci5sb3dlckhlYWQpKTtcclxuICAgIC8vIH1cclxuXHJcbiAgICAvLyBsYXlvdXRMZWFmKG5vZGUpIHtcclxuICAgIC8vICAgICBsZXQgZGlzdCA9IDIgKiB0aGlzLm5vZGVEaXN0YW5jZTtcclxuXHJcbiAgICAvLyAgICAgbm9kZS5jb250b3VyLnVwcGVyVGFpbCA9IHRoaXMuY3JlYXRlTGluZShcclxuICAgIC8vICAgICAgICAgbm9kZS5oZWlnaHQgKyBkaXN0LCAwKTtcclxuICAgIC8vICAgICBub2RlLmNvbnRvdXIudXBwZXJIZWFkID0gbm9kZS5jb250b3VyLnVwcGVyVGFpbDtcclxuICAgIC8vICAgICBub2RlLmNvbnRvdXIubG93ZXJUYWlsID0gdGhpcy5jcmVhdGVMaW5lKFxyXG4gICAgLy8gICAgICAgICAwLCAtbm9kZS53aWR0aCAtIGRpc3QpO1xyXG4gICAgLy8gICAgIG5vZGUuY29udG91ci5sb3dlckhlYWQgPSB0aGlzLmNyZWF0ZUxpbmUoXHJcbiAgICAvLyAgICAgICAgIG5vZGUuaGVpZ2h0ICsgZGlzdCwgMCwgbm9kZS5jb250b3VyLmxvd2VyVGFpbCk7XHJcbiAgICAvLyB9XHJcbn0iXX0=