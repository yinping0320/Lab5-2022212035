/**
 * @fileoverview added by tsickle
 * Generated from: lib/bill-tracker/mxgraph-ext/CompactTreeLayout.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { mxCompactTreeLayout, mxCellPath, mxDictionary } from '../../ref/mxgraph';
export class CompactTreeLayout extends mxCompactTreeLayout {
    /**
     * @param {?} graph
     * @param {?=} horizontal
     * @param {?=} invert
     */
    constructor(graph, horizontal, invert) {
        super(graph, horizontal, invert);
        this.useBoundingBox = false;
    }
    /**
     * @param {?} cell
     * @param {?} parent
     * @return {?}
     */
    dfs(cell, parent) {
        /** @type {?} */
        let id = mxCellPath.create(cell);
        /** @type {?} */
        let node = null;
        if (cell != null && this.visited[id] == null && !this.isVertexIgnored(cell)) {
            this.visited[id] = cell;
            node = this.createNode(cell);
            /** @type {?} */
            let model = this.graph.getModel();
            /** @type {?} */
            let prev = null;
            /** @type {?} */
            let out = this.graph.getEdges(cell, parent, this.invert, !this.invert, false, true);
            /** @type {?} */
            let view = this.graph.getView();
            if (this.sortEdges) {
                this.sortOutgoingEdges(cell, out);
            }
            for (let i = 0; i < out.length; i++) {
                /** @type {?} */
                let edge = out[i];
                if (!this.isEdgeIgnored(edge)) {
                    // Resets the points on the traversed edge
                    if (this.resetEdges) {
                        this.setEdgePoints(edge, null);
                    }
                    if (this.edgeRouting) {
                        this.setEdgeStyleEnabled(edge, false);
                        this.setEdgePoints(edge, null);
                    }
                    // Checks if terminal in same swimlane
                    /** @type {?} */
                    let state = view.getState(edge);
                    /** @type {?} */
                    let target = (state != null) ? state.getVisibleTerminal(this.invert) : view.getVisibleTerminal(edge, this.invert);
                    /** @type {?} */
                    let tmp = this.dfs(target, parent);
                    if (tmp != null && model.getGeometry(target) != null) {
                        if (prev == null) {
                            node.child = tmp;
                        }
                        else {
                            prev.next = tmp;
                        }
                        prev = tmp;
                    }
                }
            }
        }
        return node;
    }
    /**
     * @param {?} target
     * @param {?} edges
     * @return {?}
     */
    sortIngoingEdges(target, edges) {
        /** @type {?} */
        let lookup = new mxDictionary();
        edges.sort((/**
         * @param {?} e1
         * @param {?} e2
         * @return {?}
         */
        function (e1, e2) {
            /** @type {?} */
            let start1 = e1.getTerminal(e1.getTerminal(true) == target);
            // let end1 = e1.getTerminal(e1.getTerminal(true) == target);
            /** @type {?} */
            let p1 = lookup.get(start1);
            if (p1 == null) {
                p1 = mxCellPath.create(start1).split(mxCellPath.PATH_SEPARATOR);
                lookup.put(start1, p1);
            }
            /** @type {?} */
            let start2 = e2.getTerminal(e2.getTerminal(true) == target);
            /** @type {?} */
            let p2 = lookup.get(start2);
            if (p2 == null) {
                p2 = mxCellPath.create(start2).split(mxCellPath.PATH_SEPARATOR);
                lookup.put(start2, p2);
            }
            return mxCellPath.compare(p1, p2);
        }));
    }
    /**
     * @param {?} parent
     * @param {?} root
     * @return {?}
     */
    execute(parent, root) {
        this.parent = parent;
        /** @type {?} */
        let model = this.graph.getModel();
        if (root == null) {
            // Takes the parent as the root if it has outgoing edges
            if (this.graph.getEdges(parent, model.getParent(parent), this.invert, !this.invert, false).length > 0) {
                this.root = parent;
            }
            // Tries to find a suitable root in the parent's
            // children
            else {
                /** @type {?} */
                let roots = this.graph.findTreeRoots(parent, true, this.invert);
                if (roots.length > 0) {
                    for (let i = 0; i < roots.length; i++) {
                        if (!this.isVertexIgnored(roots[i]) &&
                            this.graph.getEdges(roots[i], null, this.invert, !this.invert, false).length > 0) {
                            this.root = roots[i];
                            break;
                        }
                    }
                }
            }
        }
        else {
            this.root = root;
        }
        if (this.root != null) {
            if (this.resizeParent) {
                this.parentsChanged = new Object();
            }
            else {
                this.parentsChanged = null;
            }
            //  Maintaining parent location
            this.parentX = null;
            this.parentY = null;
            if (parent != this.root && model.isVertex(parent) != null && this.maintainParentLocation) {
                /** @type {?} */
                let geo = this.graph.getCellGeometry(parent);
                if (geo != null) {
                    this.parentX = geo.x;
                    this.parentY = geo.y;
                }
            }
            model.beginUpdate();
            try {
                this.visited = {};
                this.node = this.dfs(this.root, parent);
                if (this.alignRanks) {
                    this.maxRankHeight = [];
                    this.findRankHeights(this.node, 0);
                    this.setCellHeights(this.node, 0);
                }
                if (this.node != null) {
                    this.layout(this.node);
                    /** @type {?} */
                    let x0 = this.graph.gridSize;
                    /** @type {?} */
                    let y0 = x0;
                    if (!this.moveTree) {
                        /** @type {?} */
                        let g = this.getVertexBounds(this.root);
                        if (g != null) {
                            x0 = g.x;
                            y0 = g.y;
                        }
                    }
                    /** @type {?} */
                    let bounds = null;
                    if (this.isHorizontal()) {
                        bounds = this.horizontalLayout(this.node, x0, y0);
                    }
                    else {
                        bounds = this.verticalLayout(this.node, null, x0, y0);
                    }
                    if (bounds != null) {
                        /** @type {?} */
                        let dx = 0;
                        /** @type {?} */
                        let dy = 0;
                        // if (bounds.x < 0) {
                        //     dx = Math.abs(x0 - bounds.x);
                        // }
                        // if (bounds.y < 0) {
                        //     dy = Math.abs(y0 - bounds.y);
                        // }
                        if (bounds.x > 0) {
                            dx = -1 * Math.abs(x0 - bounds.x);
                        }
                        if (bounds.y > 0) {
                            dy = -1 * Math.abs(y0 - bounds.y);
                        }
                        if (dx != 0 || dy != 0) {
                            this.moveNode(this.node, dx, dy);
                        }
                        if (this.resizeParent) {
                            this.adjustParents();
                        }
                        if (this.edgeRouting) {
                            // Iterate through all edges setting their positions
                            this.localEdgeProcessing(this.node);
                        }
                    }
                    // Maintaining parent location
                    if (this.parentX != null && this.parentY != null) {
                        /** @type {?} */
                        let geo = this.graph.getCellGeometry(parent);
                        if (geo != null) {
                            geo = geo.clone();
                            geo.x = this.parentX;
                            geo.y = this.parentY;
                            model.setGeometry(parent, geo);
                        }
                    }
                }
            }
            finally {
                model.endUpdate();
            }
        }
    }
    /**
     * @param {?} node
     * @param {?} x0
     * @param {?} y0
     * @param {?=} bounds
     * @return {?}
     */
    horizontalLayout(node, x0, y0, bounds) {
        node.x += x0 + node.offsetX;
        node.y += y0 + node.offsetY;
        bounds = this.apply(node, bounds);
        /** @type {?} */
        let child = node.child;
        if (child != null) {
            bounds = this.horizontalLayout(child, node.x, node.y, bounds);
            /** @type {?} */
            let siblingOffset = node.y + child.offsetY;
            /** @type {?} */
            let s = child.next;
            while (s != null) {
                bounds = this.horizontalLayout(s, node.x + child.offsetX, siblingOffset, bounds);
                siblingOffset += s.offsetY;
                s = s.next;
            }
        }
        return bounds;
    }
}
if (false) {
    /** @type {?} */
    CompactTreeLayout.prototype.visited;
    /** @type {?} */
    CompactTreeLayout.prototype.graph;
    /** @type {?} */
    CompactTreeLayout.prototype.sortEdges;
    /** @type {?} */
    CompactTreeLayout.prototype.parent;
    /** @type {?} */
    CompactTreeLayout.prototype.parentsChanged;
    /** @type {?} */
    CompactTreeLayout.prototype.parentX;
    /** @type {?} */
    CompactTreeLayout.prototype.parentY;
    /** @type {?} */
    CompactTreeLayout.prototype.node;
    /** @type {?} */
    CompactTreeLayout.prototype.alignRanks;
    /** @type {?} */
    CompactTreeLayout.prototype.maxRankHeight;
    /** @type {?} */
    CompactTreeLayout.prototype.moveTree;
    /** @type {?} */
    CompactTreeLayout.prototype.nodeDistance;
    /** @type {?} */
    CompactTreeLayout.prototype.useBoundingBox;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29tcGFjdFRyZWVMYXlvdXQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZWRwLWJpZi9ydW50aW1lLWFwaS8iLCJzb3VyY2VzIjpbImxpYi9iaWxsLXRyYWNrZXIvbXhncmFwaC1leHQvQ29tcGFjdFRyZWVMYXlvdXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBMEIsTUFBTSxtQkFBbUIsQ0FBQztBQUUxRyxNQUFNLE9BQU8saUJBQWtCLFNBQVEsbUJBQW1COzs7Ozs7SUFjdEQsWUFBWSxLQUF3QixFQUFFLFVBQW9CLEVBQUUsTUFBZ0I7UUFDeEUsS0FBSyxDQUFDLEtBQUssRUFBRSxVQUFVLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFGckMsbUJBQWMsR0FBWSxLQUFLLENBQUM7SUFHaEMsQ0FBQzs7Ozs7O0lBRUQsR0FBRyxDQUFDLElBQXNCLEVBQUUsTUFBd0I7O1lBQzVDLEVBQUUsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQzs7WUFDNUIsSUFBSSxHQUFHLElBQUk7UUFFZixJQUFJLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3pFLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDO1lBQ3hCLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDOztnQkFFekIsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFOztnQkFDN0IsSUFBSSxHQUFHLElBQUk7O2dCQUNYLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJ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QUFDLE9BQU8sQ0FBQztnQkFDM0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7YUFDZDtTQUNKO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztDQStFSjs7O0lBN1VHLG9DQUE0Qzs7SUFDNUMsa0NBQXlCOztJQUN6QixzQ0FBZTs7SUFDZixtQ0FBeUI7O0lBQ3pCLDJDQUF1Qjs7SUFDdkIsb0NBQWdCOztJQUNoQixvQ0FBZ0I7O0lBQ2hCLGlDQUFVOztJQUNWLHVDQUFnQjs7SUFDaEIsMENBQXFCOztJQUNyQixxQ0FBYzs7SUFDZCx5Q0FBa0I7O0lBQ2xCLDJDQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG14Q29tcGFjdFRyZWVMYXlvdXQsIG14Q2VsbFBhdGgsIG14RGljdGlvbmFyeSwgTXhHcmFwaE5TLCBteFJlY3RhbmdsZSB9IGZyb20gJy4uLy4uL3JlZi9teGdyYXBoJztcclxuXHJcbmV4cG9ydCBjbGFzcyBDb21wYWN0VHJlZUxheW91dCBleHRlbmRzIG14Q29tcGFjdFRyZWVMYXlvdXQge1xyXG4gICAgdmlzaXRlZDogeyBbaWQ6IHN0cmluZ106IE14R3JhcGhOUy5teENlbGwgfTtcclxuICAgIGdyYXBoOiBNeEdyYXBoTlMubXhHcmFwaDtcclxuICAgIHNvcnRFZGdlczogYW55O1xyXG4gICAgcGFyZW50OiBNeEdyYXBoTlMubXhDZWxsO1xyXG4gICAgcGFyZW50c0NoYW5nZWQ6IE9iamVjdDtcclxuICAgIHBhcmVudFg6IG51bWJlcjtcclxuICAgIHBhcmVudFk6IG51bWJlcjtcclxuICAgIG5vZGU6IGFueTtcclxuICAgIGFsaWduUmFua3M6IGFueTtcclxuICAgIG1heFJhbmtIZWlnaHQ6IGFueVtdO1xyXG4gICAgbW92ZVRyZWU6IGFueTtcclxuICAgIG5vZGVEaXN0YW5jZTogYW55O1xyXG4gICAgdXNlQm91bmRpbmdCb3g6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIGNvbnN0cnVjdG9yKGdyYXBoOiBNeEdyYXBoTlMubXhHcmFwaCwgaG9yaXpvbnRhbD86IGJvb2xlYW4sIGludmVydD86IGJvb2xlYW4pIHtcclxuICAgICAgICBzdXBlcihncmFwaCwgaG9yaXpvbnRhbCwgaW52ZXJ0KTtcclxuICAgIH1cclxuXHJcbiAgICBkZnMoY2VsbDogTXhHcmFwaE5TLm14Q2VsbCwgcGFyZW50OiBNeEdyYXBoTlMubXhDZWxsKSB7XHJcbiAgICAgICAgbGV0IGlkID0gbXhDZWxsUGF0aC5jcmVhdGUoY2VsbCk7XHJcbiAgICAgICAgbGV0IG5vZGUgPSBudWxsO1xyXG5cclxuICAgICAgICBpZiAoY2VsbCAhPSBudWxsICYmIHRoaXMudmlzaXRlZFtpZF0gPT0gbnVsbCAmJiAhdGhpcy5pc1ZlcnRleElnbm9yZWQoY2VsbCkpIHtcclxuICAgICAgICAgICAgdGhpcy52aXNpdGVkW2lkXSA9IGNlbGw7XHJcbiAgICAgICAgICAgIG5vZGUgPSB0aGlzLmNyZWF0ZU5vZGUoY2VsbCk7XHJcblxyXG4gICAgICAgICAgICBsZXQgbW9kZWwgPSB0aGlzLmdyYXBoLmdldE1vZGVsKCk7XHJcbiAgICAgICAgICAgIGxldCBwcmV2ID0gbnVsbDtcclxuICAgICAgICAgICAgbGV0IG91dCA9IHRoaXMuZ3JhcGguZ2V0RWRnZXMoY2VsbCwgcGFyZW50LCB0aGlzLmludmVydCwgIXRoaXMuaW52ZXJ0LCBmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIGxldCB2aWV3ID0gdGhpcy5ncmFwaC5nZXRWaWV3KCk7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5zb3J0RWRnZXMpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc29ydE91dGdvaW5nRWRnZXMoY2VsbCwgb3V0KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvdXQubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGxldCBlZGdlID0gb3V0W2ldO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0VkZ2VJZ25vcmVkKGVkZ2UpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXRzIHRoZSBwb2ludHMgb24gdGhlIHRyYXZlcnNlZCBlZGdlXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucmVzZXRFZGdlcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEVkZ2VQb2ludHMoZWRnZSwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5lZGdlUm91dGluZykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEVkZ2VTdHlsZUVuYWJsZWQoZWRnZSwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEVkZ2VQb2ludHMoZWRnZSwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBDaGVja3MgaWYgdGVybWluYWwgaW4gc2FtZSBzd2ltbGFuZVxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzdGF0ZSA9IHZpZXcuZ2V0U3RhdGUoZWRnZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHRhcmdldCA9IChzdGF0ZSAhPSBudWxsKSA/IHN0YXRlLmdldFZpc2libGVUZXJtaW5hbCh0aGlzLmludmVydCkgOiB2aWV3LmdldFZpc2libGVUZXJtaW5hbChlZGdlLCB0aGlzLmludmVydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHRtcCA9IHRoaXMuZGZzKHRhcmdldCwgcGFyZW50KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRtcCAhPSBudWxsICYmIG1vZGVsLmdldEdlb21ldHJ5KHRhcmdldCkgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJldiA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLmNoaWxkID0gdG1wO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldi5uZXh0ID0gdG1wO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmV2ID0gdG1wO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG5vZGU7XHJcbiAgICB9XHJcblxyXG4gICAgc29ydEluZ29pbmdFZGdlcyh0YXJnZXQ6IE14R3JhcGhOUy5teENlbGwsIGVkZ2VzOiBNeEdyYXBoTlMubXhDZWxsW10pIHtcclxuICAgICAgICBsZXQgbG9va3VwID0gbmV3IG14RGljdGlvbmFyeSgpO1xyXG5cclxuICAgICAgICBlZGdlcy5zb3J0KGZ1bmN0aW9uIChlMSwgZTIpIHtcclxuICAgICAgICAgICAgbGV0IHN0YXJ0MSA9IGUxLmdldFRlcm1pbmFsKGUxLmdldFRlcm1pbmFsKHRydWUpID09IHRhcmdldCk7XHJcbiAgICAgICAgICAgIC8vIGxldCBlbmQxID0gZTEuZ2V0VGVybWluYWwoZTEuZ2V0VGVybWluYWwodHJ1ZSkgPT0gdGFyZ2V0KTtcclxuICAgICAgICAgICAgbGV0IHAxID0gbG9va3VwLmdldChzdGFydDEpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHAxID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHAxID0gbXhDZWxsUGF0aC5jcmVhdGUoc3RhcnQxKS5zcGxpdChteENlbGxQYXRoLlBBVEhfU0VQQVJBVE9SKTtcclxuICAgICAgICAgICAgICAgIGxvb2t1cC5wdXQoc3RhcnQxLCBwMSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGxldCBzdGFydDIgPSBlMi5nZXRUZXJtaW5hbChlMi5nZXRUZXJtaW5hbCh0cnVlKSA9PSB0YXJnZXQpO1xyXG4gICAgICAgICAgICBsZXQgcDIgPSBsb29rdXAuZ2V0KHN0YXJ0Mik7XHJcblxyXG4gICAgICAgICAgICBpZiAocDIgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgcDIgPSBteENlbGxQYXRoLmNyZWF0ZShzdGFydDIpLnNwbGl0KG14Q2VsbFBhdGguUEFUSF9TRVBBUkFUT1IpO1xyXG4gICAgICAgICAgICAgICAgbG9va3VwLnB1dChzdGFydDIsIHAyKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIG14Q2VsbFBhdGguY29tcGFyZShwMSwgcDIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGV4ZWN1dGUocGFyZW50OiBNeEdyYXBoTlMubXhDZWxsLCByb290OiBNeEdyYXBoTlMubXhDZWxsKSB7XHJcbiAgICAgICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7XHJcbiAgICAgICAgbGV0IG1vZGVsID0gdGhpcy5ncmFwaC5nZXRNb2RlbCgpO1xyXG5cclxuICAgICAgICBpZiAocm9vdCA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIC8vIFRha2VzIHRoZSBwYXJlbnQgYXMgdGhlIHJvb3QgaWYgaXQgaGFzIG91dGdvaW5nIGVkZ2VzXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmdyYXBoLmdldEVkZ2VzKHBhcmVudCwgbW9kZWwuZ2V0UGFyZW50KHBhcmVudCksXHJcbiAgICAgICAgICAgICAgICB0aGlzLmludmVydCwgIXRoaXMuaW52ZXJ0LCBmYWxzZSkubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yb290ID0gcGFyZW50O1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBUcmllcyB0byBmaW5kIGEgc3VpdGFibGUgcm9vdCBpbiB0aGUgcGFyZW50J3NcclxuICAgICAgICAgICAgLy8gY2hpbGRyZW5cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgcm9vdHMgPSB0aGlzLmdyYXBoLmZpbmRUcmVlUm9vdHMocGFyZW50LCB0cnVlLCB0aGlzLmludmVydCk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHJvb3RzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJvb3RzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc1ZlcnRleElnbm9yZWQocm9vdHNbaV0pICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdyYXBoLmdldEVkZ2VzKHJvb3RzW2ldLCBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW52ZXJ0LCAhdGhpcy5pbnZlcnQsIGZhbHNlKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJvb3QgPSByb290c1tpXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnJvb3QgPSByb290O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMucm9vdCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnJlc2l6ZVBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wYXJlbnRzQ2hhbmdlZCA9IG5ldyBPYmplY3QoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucGFyZW50c0NoYW5nZWQgPSBudWxsO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyAgTWFpbnRhaW5pbmcgcGFyZW50IGxvY2F0aW9uXHJcbiAgICAgICAgICAgIHRoaXMucGFyZW50WCA9IG51bGw7XHJcbiAgICAgICAgICAgIHRoaXMucGFyZW50WSA9IG51bGw7XHJcblxyXG4gICAgICAgICAgICBpZiAocGFyZW50ICE9IHRoaXMucm9vdCAmJiBtb2RlbC5pc1ZlcnRleChwYXJlbnQpICE9IG51bGwgJiYgdGhpcy5tYWludGFpblBhcmVudExvY2F0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZ2VvID0gdGhpcy5ncmFwaC5nZXRDZWxsR2VvbWV0cnkocGFyZW50KTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoZ2VvICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcmVudFggPSBnZW8ueDtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcmVudFkgPSBnZW8ueTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbW9kZWwuYmVnaW5VcGRhdGUoKTtcclxuXHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnZpc2l0ZWQgPSB7fTtcclxuICAgICAgICAgICAgICAgIHRoaXMubm9kZSA9IHRoaXMuZGZzKHRoaXMucm9vdCwgcGFyZW50KTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5hbGlnblJhbmtzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXhSYW5rSGVpZ2h0ID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5maW5kUmFua0hlaWdodHModGhpcy5ub2RlLCAwKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldENlbGxIZWlnaHRzKHRoaXMubm9kZSwgMCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubm9kZSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXlvdXQodGhpcy5ub2RlKTtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgeDAgPSB0aGlzLmdyYXBoLmdyaWRTaXplO1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCB5MCA9IHgwO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMubW92ZVRyZWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGcgPSB0aGlzLmdldFZlcnRleEJvdW5kcyh0aGlzLnJvb3QpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGcgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeDAgPSBnLng7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5MCA9IGcueTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGJvdW5kcyA9IG51bGw7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzSG9yaXpvbnRhbCgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvdW5kcyA9IHRoaXMuaG9yaXpvbnRhbExheW91dCh0aGlzLm5vZGUsIHgwLCB5MCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBib3VuZHMgPSB0aGlzLnZlcnRpY2FsTGF5b3V0KHRoaXMubm9kZSwgbnVsbCwgeDAsIHkwKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChib3VuZHMgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZHggPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZHkgPSAwO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgKGJvdW5kcy54IDwgMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgZHggPSBNYXRoLmFicyh4MCAtIGJvdW5kcy54KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgKGJvdW5kcy55IDwgMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgZHkgPSBNYXRoLmFicyh5MCAtIGJvdW5kcy55KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYm91bmRzLnggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkeCA9IC0xICogTWF0aC5hYnMoeDAgLSBib3VuZHMueCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChib3VuZHMueSA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGR5ID0gLTEgKiBNYXRoLmFicyh5MCAtIGJvdW5kcy55KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGR4ICE9IDAgfHwgZHkgIT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb3ZlTm9kZSh0aGlzLm5vZGUsIGR4LCBkeSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlc2l6ZVBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGp1c3RQYXJlbnRzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmVkZ2VSb3V0aW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJdGVyYXRlIHRocm91Z2ggYWxsIGVkZ2VzIHNldHRpbmcgdGhlaXIgcG9zaXRpb25zXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsRWRnZVByb2Nlc3NpbmcodGhpcy5ub2RlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gTWFpbnRhaW5pbmcgcGFyZW50IGxvY2F0aW9uXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50WCAhPSBudWxsICYmIHRoaXMucGFyZW50WSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBnZW8gPSB0aGlzLmdyYXBoLmdldENlbGxHZW9tZXRyeShwYXJlbnQpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdlbyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZW8gPSBnZW8uY2xvbmUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlby54ID0gdGhpcy5wYXJlbnRYO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2VvLnkgPSB0aGlzLnBhcmVudFk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbC5zZXRHZW9tZXRyeShwYXJlbnQsIGdlbyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZmluYWxseSB7XHJcbiAgICAgICAgICAgICAgICBtb2RlbC5lbmRVcGRhdGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBob3Jpem9udGFsTGF5b3V0KG5vZGUsIHgwOiBudW1iZXIsIHkwOiBudW1iZXIsIGJvdW5kcz86IE14R3JhcGhOUy5teFJlY3RhbmdsZSkge1xyXG4gICAgICAgIG5vZGUueCArPSB4MCArIG5vZGUub2Zmc2V0WDtcclxuICAgICAgICBub2RlLnkgKz0geTAgKyBub2RlLm9mZnNldFk7XHJcbiAgICAgICAgYm91bmRzID0gdGhpcy5hcHBseShub2RlLCBib3VuZHMpO1xyXG4gICAgICAgIGxldCBjaGlsZCA9IG5vZGUuY2hpbGQ7XHJcblxyXG4gICAgICAgIGlmIChjaGlsZCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGJvdW5kcyA9IHRoaXMuaG9yaXpvbnRhbExheW91dChjaGlsZCwgbm9kZS54LCBub2RlLnksIGJvdW5kcyk7XHJcbiAgICAgICAgICAgIGxldCBzaWJsaW5nT2Zmc2V0ID0gbm9kZS55ICsgY2hpbGQub2Zmc2V0WTtcclxuICAgICAgICAgICAgbGV0IHMgPSBjaGlsZC5uZXh0O1xyXG5cclxuICAgICAgICAgICAgd2hpbGUgKHMgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgYm91bmRzID0gdGhpcy5ob3Jpem9udGFsTGF5b3V0KHMsIG5vZGUueCArIGNoaWxkLm9mZnNldFgsIHNpYmxpbmdPZmZzZXQsIGJvdW5kcyk7XHJcbiAgICAgICAgICAgICAgICBzaWJsaW5nT2Zmc2V0ICs9IHMub2Zmc2V0WTtcclxuICAgICAgICAgICAgICAgIHMgPSBzLm5leHQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBib3VuZHM7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gbGF5b3V0KG5vZGUpIHtcclxuICAgIC8vICAgICBpZiAobm9kZSAhPSBudWxsKSB7XHJcbiAgICAvLyAgICAgICAgIGxldCBjaGlsZCA9IG5vZGUuY2hpbGQ7XHJcblxyXG4gICAgLy8gICAgICAgICB3aGlsZSAoY2hpbGQgIT0gbnVsbCkge1xyXG4gICAgLy8gICAgICAgICAgICAgdGhpcy5sYXlvdXQoY2hpbGQpO1xyXG4gICAgLy8gICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5uZXh0O1xyXG4gICAgLy8gICAgICAgICB9XHJcblxyXG4gICAgLy8gICAgICAgICBpZiAobm9kZS5jaGlsZCAhPSBudWxsKSB7XHJcbiAgICAvLyAgICAgICAgICAgICB0aGlzLmF0dGFjaFBhcmVudChub2RlLCB0aGlzLmpvaW4obm9kZSkpO1xyXG4gICAgLy8gICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgIGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgICAgdGhpcy5sYXlvdXRMZWFmKG5vZGUpO1xyXG4gICAgLy8gICAgICAgICB9XHJcbiAgICAvLyAgICAgfVxyXG4gICAgLy8gfVxyXG5cclxuICAgIC8vIGFwcGx5KG5vZGUsIGJvdW5kcykge1xyXG4gICAgLy8gICAgIGxldCBtb2RlbCA9IHRoaXMuZ3JhcGguZ2V0TW9kZWwoKTtcclxuICAgIC8vICAgICBsZXQgY2VsbCA9IG5vZGUuY2VsbDtcclxuICAgIC8vICAgICBsZXQgZyA9IG1vZGVsLmdldEdlb21ldHJ5KGNlbGwpO1xyXG5cclxuICAgIC8vICAgICBpZiAoY2VsbCAhPSBudWxsICYmIGcgIT0gbnVsbCkge1xyXG4gICAgLy8gICAgICAgICBpZiAodGhpcy5pc1ZlcnRleE1vdmFibGUoY2VsbCkpIHtcclxuICAgIC8vICAgICAgICAgICAgIGcgPSB0aGlzLnNldFZlcnRleExvY2F0aW9uKGNlbGwsIG5vZGUueCwgbm9kZS55KTtcclxuXHJcbiAgICAvLyAgICAgICAgICAgICBpZiAodGhpcy5yZXNpemVQYXJlbnQpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICBsZXQgcGFyZW50ID0gbW9kZWwuZ2V0UGFyZW50KGNlbGwpO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIGxldCBpZCA9IG14Q2VsbFBhdGguY3JlYXRlKHBhcmVudCk7XHJcblxyXG4gICAgLy8gICAgICAgICAgICAgICAgIC8vIEltcGxlbWVudHMgc2V0IHNlbWFudGljXHJcbiAgICAvLyAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50c0NoYW5nZWRbaWRdID09IG51bGwpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJlbnRzQ2hhbmdlZFtpZF0gPSBwYXJlbnQ7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICB9XHJcblxyXG4gICAgLy8gICAgICAgICBpZiAoYm91bmRzID09IG51bGwpIHtcclxuICAgIC8vICAgICAgICAgICAgIGJvdW5kcyA9IG5ldyBteFJlY3RhbmdsZShnLngsIGcueSwgZy53aWR0aCwgZy5oZWlnaHQpO1xyXG4gICAgLy8gICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgIGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgICAgYm91bmRzID0gbmV3IG14UmVjdGFuZ2xlKE1hdGgubWluKGJvdW5kcy54LCBnLngpLFxyXG4gICAgLy8gICAgICAgICAgICAgICAgIE1hdGgubWluKGJvdW5kcy55LCBnLnkpLFxyXG4gICAgLy8gICAgICAgICAgICAgICAgIE1hdGgubWF4KGJvdW5kcy54ICsgYm91bmRzLndpZHRoLCBnLnggKyBnLndpZHRoKSxcclxuICAgIC8vICAgICAgICAgICAgICAgICBNYXRoLm1heChib3VuZHMueSArIGJvdW5kcy5oZWlnaHQsIGcueSArIGcuaGVpZ2h0KSk7XHJcbiAgICAvLyAgICAgICAgIH1cclxuICAgIC8vICAgICB9XHJcblxyXG4gICAgLy8gICAgIHJldHVybiBib3VuZHM7XHJcbiAgICAvLyB9XHJcblxyXG4gICAgLy8gYXR0YWNoUGFyZW50KG5vZGUsIGhlaWdodCkge1xyXG4gICAgLy8gICAgIGxldCB4ID0gdGhpcy5ub2RlRGlzdGFuY2UgKyB0aGlzLmxldmVsRGlzdGFuY2U7XHJcbiAgICAvLyAgICAgbGV0IHkyID0gKGhlaWdodCAtIG5vZGUud2lkdGgpIC8gMiAtIHRoaXMubm9kZURpc3RhbmNlO1xyXG4gICAgLy8gICAgIGxldCB5MSA9IHkyICsgbm9kZS53aWR0aCArIDIgKiB0aGlzLm5vZGVEaXN0YW5jZSAtIGhlaWdodDtcclxuXHJcbiAgICAvLyAgICAgbm9kZS5jaGlsZC5vZmZzZXRYID0geCArIG5vZGUuaGVpZ2h0O1xyXG4gICAgLy8gICAgIG5vZGUuY2hpbGQub2Zmc2V0WSA9IHkxO1xyXG5cclxuICAgIC8vICAgICBub2RlLmNvbnRvdXIudXBwZXJIZWFkID0gdGhpcy5jcmVhdGVMaW5lKG5vZGUuaGVpZ2h0LCAwLFxyXG4gICAgLy8gICAgICAgICB0aGlzLmNyZWF0ZUxpbmUoeCwgeTEsIG5vZGUuY29udG91ci51cHBlckhlYWQpKTtcclxuICAgIC8vICAgICBub2RlLmNvbnRvdXIubG93ZXJIZWFkID0gdGhpcy5jcmVhdGVMaW5lKG5vZGUuaGVpZ2h0LCAwLFxyXG4gICAgLy8gICAgICAgICB0aGlzLmNyZWF0ZUxpbmUoeCwgeTIsIG5vZGUuY29udG91ci5sb3dlckhlYWQpKTtcclxuICAgIC8vIH1cclxuXHJcbiAgICAvLyBsYXlvdXRMZWFmKG5vZGUpIHtcclxuICAgIC8vICAgICBsZXQgZGlzdCA9IDIgKiB0aGlzLm5vZGVEaXN0YW5jZTtcclxuXHJcbiAgICAvLyAgICAgbm9kZS5jb250b3VyLnVwcGVyVGFpbCA9IHRoaXMuY3JlYXRlTGluZShcclxuICAgIC8vICAgICAgICAgbm9kZS5oZWlnaHQgKyBkaXN0LCAwKTtcclxuICAgIC8vICAgICBub2RlLmNvbnRvdXIudXBwZXJIZWFkID0gbm9kZS5jb250b3VyLnVwcGVyVGFpbDtcclxuICAgIC8vICAgICBub2RlLmNvbnRvdXIubG93ZXJUYWlsID0gdGhpcy5jcmVhdGVMaW5lKFxyXG4gICAgLy8gICAgICAgICAwLCAtbm9kZS53aWR0aCAtIGRpc3QpO1xyXG4gICAgLy8gICAgIG5vZGUuY29udG91ci5sb3dlckhlYWQgPSB0aGlzLmNyZWF0ZUxpbmUoXHJcbiAgICAvLyAgICAgICAgIG5vZGUuaGVpZ2h0ICsgZGlzdCwgMCwgbm9kZS5jb250b3VyLmxvd2VyVGFpbCk7XHJcbiAgICAvLyB9XHJcbn0iXX0=