/**
 * @fileoverview added by tsickle
 * Generated from: lib/bill-tracker/mxgraph-ext/RevertCompactTreeLayout.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { mxCompactTreeLayout, mxCellPath, mxDictionary } from '../../ref/mxgraph';
var RevertCompactTreeLayout = /** @class */ (function (_super) {
    tslib_1.__extends(RevertCompactTreeLayout, _super);
    function RevertCompactTreeLayout(graph, horizontal, invert) {
        var _this = _super.call(this, graph, horizontal, invert) || this;
        _this.useBoundingBox = false;
        return _this;
    }
    /**
     * @param {?} cell
     * @param {?} parent
     * @return {?}
     */
    RevertCompactTreeLayout.prototype.dfs = /**
     * @param {?} cell
     * @param {?} parent
     * @return {?}
     */
    function (cell, parent) {
        /** @type {?} */
        var id = mxCellPath.create(cell);
        /** @type {?} */
        var node = null;
        if (cell != null && this.visited[id] == null && !this.isVertexIgnored(cell)) {
            this.visited[id] = cell;
            node = this.createNode(cell);
            /** @type {?} */
            var model = this.graph.getModel();
            /** @type {?} */
            var prev = null;
            // let out = this.graph.getEdges(cell, parent, this.invert, !this.invert, false, true);
            /** @type {?} */
            var ins = this.graph.getEdges(cell, parent, !this.invert, this.invert, false, true);
            /** @type {?} */
            var view = this.graph.getView();
            if (this.sortEdges) {
                // this.sortOutgoingEdges(cell, out);
                this.sortIngoingEdges(cell, ins);
            }
            for (var i = 0; i < ins.length; i++) {
                /** @type {?} */
                var edge = ins[i];
                if (!this.isEdgeIgnored(edge)) {
                    // Resets the points on the traversed edge
                    if (this.resetEdges) {
                        this.setEdgePoints(edge, null);
                    }
                    if (this.edgeRouting) {
                        this.setEdgeStyleEnabled(edge, false);
                        this.setEdgePoints(edge, null);
                    }
                    // Checks if terminal in same swimlane
                    /** @type {?} */
                    var state = view.getState(edge);
                    // let target = (state != null) ? state.getVisibleTerminal(this.invert) : view.getVisibleTerminal(edge, this.invert);
                    /** @type {?} */
                    var source = (state != null) ? state.getVisibleTerminal(!this.invert) : view.getVisibleTerminal(edge, !this.invert);
                    /** @type {?} */
                    var tmp = this.dfs(source, parent);
                    if (tmp != null && model.getGeometry(source) != null) {
                        if (prev == null) {
                            node.child = tmp;
                        }
                        else {
                            prev.next = tmp;
                        }
                        prev = tmp;
                    }
                }
            }
        }
        return node;
    };
    /**
     * @param {?} target
     * @param {?} edges
     * @return {?}
     */
    RevertCompactTreeLayout.prototype.sortIngoingEdges = /**
     * @param {?} target
     * @param {?} edges
     * @return {?}
     */
    function (target, edges) {
        /** @type {?} */
        var lookup = new mxDictionary();
        edges.sort((/**
         * @param {?} e1
         * @param {?} e2
         * @return {?}
         */
        function (e1, e2) {
            /** @type {?} */
            var start1 = e1.getTerminal(e1.getTerminal(true) == target);
            // let end1 = e1.getTerminal(e1.getTerminal(true) == target);
            /** @type {?} */
            var p1 = lookup.get(start1);
            if (p1 == null) {
                p1 = mxCellPath.create(start1).split(mxCellPath.PATH_SEPARATOR);
                lookup.put(start1, p1);
            }
            /** @type {?} */
            var start2 = e2.getTerminal(e2.getTerminal(true) == target);
            /** @type {?} */
            var p2 = lookup.get(start2);
            if (p2 == null) {
                p2 = mxCellPath.create(start2).split(mxCellPath.PATH_SEPARATOR);
                lookup.put(start2, p2);
            }
            return mxCellPath.compare(p1, p2);
        }));
    };
    /**
     * @param {?} parent
     * @param {?} dest
     * @return {?}
     */
    RevertCompactTreeLayout.prototype.execute = /**
     * @param {?} parent
     * @param {?} dest
     * @return {?}
     */
    function (parent, dest) {
        this.parent = parent;
        /** @type {?} */
        var model = this.graph.getModel();
        if (dest == null) {
            // Takes the parent as the root if it has outgoing edges
            if (this.graph.getEdges(parent, model.getParent(parent), !this.invert, this.invert, false).length > 0) {
                this.root = parent;
            }
            // Tries to find a suitable root in the parent's
            // children
            else {
                /** @type {?} */
                var dests = this.graph.findTreeRoots(parent, true, true);
                if (dests.length > 0) {
                    for (var i = 0; i < dests.length; i++) {
                        if (!this.isVertexIgnored(dests[i]) &&
                            this.graph.getEdges(dests[i], null, !this.invert, this.invert, false).length > 0) {
                            this.root = dests[i];
                            break;
                        }
                    }
                }
            }
        }
        else {
            this.root = dest;
        }
        if (this.root != null) {
            if (this.resizeParent) {
                this.parentsChanged = new Object();
            }
            else {
                this.parentsChanged = null;
            }
            //  Maintaining parent location
            this.parentX = null;
            this.parentY = null;
            if (parent != this.root && model.isVertex(parent) != null && this.maintainParentLocation) {
                /** @type {?} */
                var geo = this.graph.getCellGeometry(parent);
                if (geo != null) {
                    this.parentX = geo.x;
                    this.parentY = geo.y;
                }
            }
            model.beginUpdate();
            try {
                this.visited = {};
                this.node = this.dfs(this.root, parent);
                if (this.alignRanks) {
                    this.maxRankHeight = [];
                    this.findRankHeights(this.node, 0);
                    this.setCellHeights(this.node, 0);
                }
                if (this.node != null) {
                    this.layout(this.node);
                    /** @type {?} */
                    var x0 = this.graph.gridSize;
                    /** @type {?} */
                    var y0 = x0;
                    if (!this.moveTree) {
                        /** @type {?} */
                        var g = this.getVertexBounds(this.root);
                        if (g != null) {
                            x0 = g.x;
                            y0 = g.y;
                        }
                    }
                    /** @type {?} */
                    var bounds = null;
                    if (this.isHorizontal()) {
                        bounds = this.horizontalLayout(this.node, -x0, y0);
                    }
                    else {
                        bounds = this.verticalLayout(this.node, null, x0, y0);
                    }
                    if (bounds != null) {
                        /** @type {?} */
                        var dx = 0;
                        /** @type {?} */
                        var dy = 0;
                        if (bounds.x > 0) {
                            dx = -1 * Math.abs(x0 - bounds.x);
                        }
                        if (bounds.y > 0) {
                            dy = -1 * Math.abs(y0 - bounds.y);
                        }
                        if (dx != 0 || dy != 0) {
                            this.moveNode(this.node, dx, dy);
                        }
                        if (this.resizeParent) {
                            this.adjustParents();
                        }
                        if (this.edgeRouting) {
                            // Iterate through all edges setting their positions
                            this.localEdgeProcessing(this.node);
                        }
                    }
                    // Maintaining parent location
                    if (this.parentX != null && this.parentY != null) {
                        /** @type {?} */
                        var geo = this.graph.getCellGeometry(parent);
                        if (geo != null) {
                            geo = geo.clone();
                            geo.x = this.parentX;
                            geo.y = this.parentY;
                            model.setGeometry(parent, geo);
                        }
                    }
                }
            }
            finally {
                model.endUpdate();
            }
        }
    };
    /**
     * @param {?} node
     * @param {?} x0
     * @param {?} y0
     * @param {?=} bounds
     * @return {?}
     */
    RevertCompactTreeLayout.prototype.horizontalLayout = /**
     * @param {?} node
     * @param {?} x0
     * @param {?} y0
     * @param {?=} bounds
     * @return {?}
     */
    function (node, x0, y0, bounds) {
        node.x += x0 - node.offsetX;
        node.y += y0 + node.offsetY;
        bounds = this.apply(node, bounds);
        /** @type {?} */
        var child = node.child;
        if (child != null) {
            bounds = this.horizontalLayout(child, node.x, node.y, bounds);
            /** @type {?} */
            var siblingOffset = node.y + child.offsetY;
            /** @type {?} */
            var s = child.next;
            while (s != null) {
                bounds = this.horizontalLayout(s, node.x - child.offsetX, siblingOffset, bounds);
                siblingOffset += s.offsetY;
                s = s.next;
            }
        }
        return bounds;
    };
    return RevertCompactTreeLayout;
}(mxCompactTreeLayout));
export { RevertCompactTreeLayout };
if (false) {
    /** @type {?} */
    RevertCompactTreeLayout.prototype.visited;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.graph;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.sortEdges;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.parent;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.parentsChanged;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.parentX;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.parentY;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.node;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.alignRanks;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.maxRankHeight;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.moveTree;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.nodeDistance;
    /** @type {?} */
    RevertCompactTreeLayout.prototype.useBoundingBox;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmV2ZXJ0Q29tcGFjdFRyZWVMYXlvdXQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZWRwLWJpZi9ydW50aW1lLWFwaS8iLCJzb3VyY2VzIjpbImxpYi9iaWxsLXRyYWNrZXIvbXhncmFwaC1leHQvUmV2ZXJ0Q29tcGFjdFRyZWVMYXlvdXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsT0FBTyxFQUFFLG1CQUFtQixFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQTBCLE1BQU0sbUJBQW1CLENBQUM7QUFFMUc7SUFBNkMsbURBQW1CO0lBYzVELGlDQUFZLEtBQXdCLEVBQUUsVUFBb0IsRUFBRSxNQUFnQjtRQUE1RSxZQUNJLGtCQUFNLEtBQUssRUFBRSxVQUFVLEVBQUUsTUFBTSxDQUFDLFNBQ25DO1FBSEQsb0JBQWMsR0FBWSxLQUFLLENBQUM7O0lBR2hDLENBQUM7Ozs7OztJQUVELHFDQUFHOzs7OztJQUFILFVBQUksSUFBc0IsRUFBRSxNQUF3Qjs7WUFDNUMsRUFBRSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDOztZQUM1QixJQUFJLEdBQUcsSUFBSTtRQUVmLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDekUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDeEIsSUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7O2dCQUV6QixLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUU7O2dCQUM3QixJQUFJLEdBQUcsSUFBSTs7O2dCQUVYLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFB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M0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7YUFDZDtTQUNKO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQStFTCw4QkFBQztBQUFELENBQUMsQUExVUQsQ0FBNkMsbUJBQW1CLEdBMFUvRDs7OztJQXpVRywwQ0FBNEM7O0lBQzVDLHdDQUF5Qjs7SUFDekIsNENBQWU7O0lBQ2YseUNBQXlCOztJQUN6QixpREFBdUI7O0lBQ3ZCLDBDQUFnQjs7SUFDaEIsMENBQWdCOztJQUNoQix1Q0FBVTs7SUFDViw2Q0FBZ0I7O0lBQ2hCLGdEQUFxQjs7SUFDckIsMkNBQWM7O0lBQ2QsK0NBQWtCOztJQUNsQixpREFBZ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBteENvbXBhY3RUcmVlTGF5b3V0LCBteENlbGxQYXRoLCBteERpY3Rpb25hcnksIE14R3JhcGhOUywgbXhSZWN0YW5nbGUgfSBmcm9tICcuLi8uLi9yZWYvbXhncmFwaCc7XHJcblxyXG5leHBvcnQgY2xhc3MgUmV2ZXJ0Q29tcGFjdFRyZWVMYXlvdXQgZXh0ZW5kcyBteENvbXBhY3RUcmVlTGF5b3V0IHtcclxuICAgIHZpc2l0ZWQ6IHsgW2lkOiBzdHJpbmddOiBNeEdyYXBoTlMubXhDZWxsIH07XHJcbiAgICBncmFwaDogTXhHcmFwaE5TLm14R3JhcGg7XHJcbiAgICBzb3J0RWRnZXM6IGFueTtcclxuICAgIHBhcmVudDogTXhHcmFwaE5TLm14Q2VsbDtcclxuICAgIHBhcmVudHNDaGFuZ2VkOiBPYmplY3Q7XHJcbiAgICBwYXJlbnRYOiBudW1iZXI7XHJcbiAgICBwYXJlbnRZOiBudW1iZXI7XHJcbiAgICBub2RlOiBhbnk7XHJcbiAgICBhbGlnblJhbmtzOiBhbnk7XHJcbiAgICBtYXhSYW5rSGVpZ2h0OiBhbnlbXTtcclxuICAgIG1vdmVUcmVlOiBhbnk7XHJcbiAgICBub2RlRGlzdGFuY2U6IGFueTtcclxuICAgIHVzZUJvdW5kaW5nQm94OiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBjb25zdHJ1Y3RvcihncmFwaDogTXhHcmFwaE5TLm14R3JhcGgsIGhvcml6b250YWw/OiBib29sZWFuLCBpbnZlcnQ/OiBib29sZWFuKSB7XHJcbiAgICAgICAgc3VwZXIoZ3JhcGgsIGhvcml6b250YWwsIGludmVydCk7XHJcbiAgICB9XHJcblxyXG4gICAgZGZzKGNlbGw6IE14R3JhcGhOUy5teENlbGwsIHBhcmVudDogTXhHcmFwaE5TLm14Q2VsbCkge1xyXG4gICAgICAgIGxldCBpZCA9IG14Q2VsbFBhdGguY3JlYXRlKGNlbGwpO1xyXG4gICAgICAgIGxldCBub2RlID0gbnVsbDtcclxuXHJcbiAgICAgICAgaWYgKGNlbGwgIT0gbnVsbCAmJiB0aGlzLnZpc2l0ZWRbaWRdID09IG51bGwgJiYgIXRoaXMuaXNWZXJ0ZXhJZ25vcmVkKGNlbGwpKSB7XHJcbiAgICAgICAgICAgIHRoaXMudmlzaXRlZFtpZF0gPSBjZWxsO1xyXG4gICAgICAgICAgICBub2RlID0gdGhpcy5jcmVhdGVOb2RlKGNlbGwpO1xyXG5cclxuICAgICAgICAgICAgbGV0IG1vZGVsID0gdGhpcy5ncmFwaC5nZXRNb2RlbCgpO1xyXG4gICAgICAgICAgICBsZXQgcHJldiA9IG51bGw7XHJcbiAgICAgICAgICAgIC8vIGxldCBvdXQgPSB0aGlzLmdyYXBoLmdldEVkZ2VzKGNlbGwsIHBhcmVudCwgdGhpcy5pbnZlcnQsICF0aGlzLmludmVydCwgZmFsc2UsIHRydWUpO1xyXG4gICAgICAgICAgICBsZXQgaW5zID0gdGhpcy5ncmFwaC5nZXRFZGdlcyhjZWxsLCBwYXJlbnQsICF0aGlzLmludmVydCwgdGhpcy5pbnZlcnQsIGZhbHNlLCB0cnVlKTtcclxuICAgICAgICAgICAgbGV0IHZpZXcgPSB0aGlzLmdyYXBoLmdldFZpZXcoKTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNvcnRFZGdlcykge1xyXG4gICAgICAgICAgICAgICAgLy8gdGhpcy5zb3J0T3V0Z29pbmdFZGdlcyhjZWxsLCBvdXQpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zb3J0SW5nb2luZ0VkZ2VzKGNlbGwsIGlucyk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZWRnZSA9IGluc1tpXTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNFZGdlSWdub3JlZChlZGdlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0cyB0aGUgcG9pbnRzIG9uIHRoZSB0cmF2ZXJzZWQgZWRnZVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlc2V0RWRnZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRFZGdlUG9pbnRzKGVkZ2UsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZWRnZVJvdXRpbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRFZGdlU3R5bGVFbmFibGVkKGVkZ2UsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRFZGdlUG9pbnRzKGVkZ2UsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2tzIGlmIHRlcm1pbmFsIGluIHNhbWUgc3dpbWxhbmVcclxuICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdGUgPSB2aWV3LmdldFN0YXRlKGVkZ2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGxldCB0YXJnZXQgPSAoc3RhdGUgIT0gbnVsbCkgPyBzdGF0ZS5nZXRWaXNpYmxlVGVybWluYWwodGhpcy5pbnZlcnQpIDogdmlldy5nZXRWaXNpYmxlVGVybWluYWwoZWRnZSwgdGhpcy5pbnZlcnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzb3VyY2UgPSAoc3RhdGUgIT0gbnVsbCkgPyBzdGF0ZS5nZXRWaXNpYmxlVGVybWluYWwoIXRoaXMuaW52ZXJ0KSA6IHZpZXcuZ2V0VmlzaWJsZVRlcm1pbmFsKGVkZ2UsICF0aGlzLmludmVydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHRtcCA9IHRoaXMuZGZzKHNvdXJjZSwgcGFyZW50KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRtcCAhPSBudWxsICYmIG1vZGVsLmdldEdlb21ldHJ5KHNvdXJjZSkgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJldiA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLmNoaWxkID0gdG1wO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldi5uZXh0ID0gdG1wO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmV2ID0gdG1wO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG5vZGU7XHJcbiAgICB9XHJcblxyXG4gICAgc29ydEluZ29pbmdFZGdlcyh0YXJnZXQ6IE14R3JhcGhOUy5teENlbGwsIGVkZ2VzOiBNeEdyYXBoTlMubXhDZWxsW10pIHtcclxuICAgICAgICBsZXQgbG9va3VwID0gbmV3IG14RGljdGlvbmFyeSgpO1xyXG5cclxuICAgICAgICBlZGdlcy5zb3J0KGZ1bmN0aW9uIChlMSwgZTIpIHtcclxuICAgICAgICAgICAgbGV0IHN0YXJ0MSA9IGUxLmdldFRlcm1pbmFsKGUxLmdldFRlcm1pbmFsKHRydWUpID09IHRhcmdldCk7XHJcbiAgICAgICAgICAgIC8vIGxldCBlbmQxID0gZTEuZ2V0VGVybWluYWwoZTEuZ2V0VGVybWluYWwodHJ1ZSkgPT0gdGFyZ2V0KTtcclxuICAgICAgICAgICAgbGV0IHAxID0gbG9va3VwLmdldChzdGFydDEpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHAxID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHAxID0gbXhDZWxsUGF0aC5jcmVhdGUoc3RhcnQxKS5zcGxpdChteENlbGxQYXRoLlBBVEhfU0VQQVJBVE9SKTtcclxuICAgICAgICAgICAgICAgIGxvb2t1cC5wdXQoc3RhcnQxLCBwMSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGxldCBzdGFydDIgPSBlMi5nZXRUZXJtaW5hbChlMi5nZXRUZXJtaW5hbCh0cnVlKSA9PSB0YXJnZXQpO1xyXG4gICAgICAgICAgICBsZXQgcDIgPSBsb29rdXAuZ2V0KHN0YXJ0Mik7XHJcblxyXG4gICAgICAgICAgICBpZiAocDIgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgcDIgPSBteENlbGxQYXRoLmNyZWF0ZShzdGFydDIpLnNwbGl0KG14Q2VsbFBhdGguUEFUSF9TRVBBUkFUT1IpO1xyXG4gICAgICAgICAgICAgICAgbG9va3VwLnB1dChzdGFydDIsIHAyKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIG14Q2VsbFBhdGguY29tcGFyZShwMSwgcDIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGV4ZWN1dGUocGFyZW50OiBNeEdyYXBoTlMubXhDZWxsLCBkZXN0OiBNeEdyYXBoTlMubXhDZWxsKSB7XHJcbiAgICAgICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7XHJcbiAgICAgICAgbGV0IG1vZGVsID0gdGhpcy5ncmFwaC5nZXRNb2RlbCgpO1xyXG5cclxuICAgICAgICBpZiAoZGVzdCA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIC8vIFRha2VzIHRoZSBwYXJlbnQgYXMgdGhlIHJvb3QgaWYgaXQgaGFzIG91dGdvaW5nIGVkZ2VzXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmdyYXBoLmdldEVkZ2VzKHBhcmVudCwgbW9kZWwuZ2V0UGFyZW50KHBhcmVudCksXHJcbiAgICAgICAgICAgICAgICAhdGhpcy5pbnZlcnQsIHRoaXMuaW52ZXJ0LCBmYWxzZSkubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yb290ID0gcGFyZW50O1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBUcmllcyB0byBmaW5kIGEgc3VpdGFibGUgcm9vdCBpbiB0aGUgcGFyZW50J3NcclxuICAgICAgICAgICAgLy8gY2hpbGRyZW5cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZGVzdHMgPSB0aGlzLmdyYXBoLmZpbmRUcmVlUm9vdHMocGFyZW50LCB0cnVlLCB0cnVlKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoZGVzdHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGVzdHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzVmVydGV4SWdub3JlZChkZXN0c1tpXSkgJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ3JhcGguZ2V0RWRnZXMoZGVzdHNbaV0sIG51bGwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIXRoaXMuaW52ZXJ0LCB0aGlzLmludmVydCwgZmFsc2UpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucm9vdCA9IGRlc3RzW2ldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMucm9vdCA9IGRlc3Q7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5yb290ICE9IG51bGwpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMucmVzaXplUGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBhcmVudHNDaGFuZ2VkID0gbmV3IE9iamVjdCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wYXJlbnRzQ2hhbmdlZCA9IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vICBNYWludGFpbmluZyBwYXJlbnQgbG9jYXRpb25cclxuICAgICAgICAgICAgdGhpcy5wYXJlbnRYID0gbnVsbDtcclxuICAgICAgICAgICAgdGhpcy5wYXJlbnRZID0gbnVsbDtcclxuXHJcbiAgICAgICAgICAgIGlmIChwYXJlbnQgIT0gdGhpcy5yb290ICYmIG1vZGVsLmlzVmVydGV4KHBhcmVudCkgIT0gbnVsbCAmJiB0aGlzLm1haW50YWluUGFyZW50TG9jYXRpb24pIHtcclxuICAgICAgICAgICAgICAgIGxldCBnZW8gPSB0aGlzLmdyYXBoLmdldENlbGxHZW9tZXRyeShwYXJlbnQpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChnZW8gIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGFyZW50WCA9IGdlby54O1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGFyZW50WSA9IGdlby55O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBtb2RlbC5iZWdpblVwZGF0ZSgpO1xyXG5cclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHRoaXMudmlzaXRlZCA9IHt9O1xyXG4gICAgICAgICAgICAgICAgdGhpcy5ub2RlID0gdGhpcy5kZnModGhpcy5yb290LCBwYXJlbnQpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmFsaWduUmFua3MpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm1heFJhbmtIZWlnaHQgPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmZpbmRSYW5rSGVpZ2h0cyh0aGlzLm5vZGUsIDApO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0Q2VsbEhlaWdodHModGhpcy5ub2RlLCAwKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5ub2RlICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxheW91dCh0aGlzLm5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCB4MCA9IHRoaXMuZ3JhcGguZ3JpZFNpemU7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHkwID0geDA7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5tb3ZlVHJlZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZyA9IHRoaXMuZ2V0VmVydGV4Qm91bmRzKHRoaXMucm9vdCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4MCA9IGcueDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHkwID0gZy55O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBsZXQgYm91bmRzID0gbnVsbDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNIb3Jpem9udGFsKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYm91bmRzID0gdGhpcy5ob3Jpem9udGFsTGF5b3V0KHRoaXMubm9kZSwgLXgwLCB5MCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBib3VuZHMgPSB0aGlzLnZlcnRpY2FsTGF5b3V0KHRoaXMubm9kZSwgbnVsbCwgeDAsIHkwKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChib3VuZHMgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZHggPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZHkgPSAwO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJvdW5kcy54ID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZHggPSAtMSAqIE1hdGguYWJzKHgwIC0gYm91bmRzLngpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYm91bmRzLnkgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkeSA9IC0xICogTWF0aC5hYnMoeTAgLSBib3VuZHMueSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkeCAhPSAwIHx8IGR5ICE9IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW92ZU5vZGUodGhpcy5ub2RlLCBkeCwgZHkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZXNpemVQYXJlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRqdXN0UGFyZW50cygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5lZGdlUm91dGluZykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSXRlcmF0ZSB0aHJvdWdoIGFsbCBlZGdlcyBzZXR0aW5nIHRoZWlyIHBvc2l0aW9uc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhbEVkZ2VQcm9jZXNzaW5nKHRoaXMubm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIE1haW50YWluaW5nIHBhcmVudCBsb2NhdGlvblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcmVudFggIT0gbnVsbCAmJiB0aGlzLnBhcmVudFkgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZ2VvID0gdGhpcy5ncmFwaC5nZXRDZWxsR2VvbWV0cnkocGFyZW50KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnZW8gIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2VvID0gZ2VvLmNsb25lKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZW8ueCA9IHRoaXMucGFyZW50WDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlby55ID0gdGhpcy5wYXJlbnRZO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWwuc2V0R2VvbWV0cnkocGFyZW50LCBnZW8pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGZpbmFsbHkge1xyXG4gICAgICAgICAgICAgICAgbW9kZWwuZW5kVXBkYXRlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaG9yaXpvbnRhbExheW91dChub2RlLCB4MDogbnVtYmVyLCB5MDogbnVtYmVyLCBib3VuZHM/OiBNeEdyYXBoTlMubXhSZWN0YW5nbGUpIHtcclxuICAgICAgICBub2RlLnggKz0geDAgLSBub2RlLm9mZnNldFg7XHJcbiAgICAgICAgbm9kZS55ICs9IHkwICsgbm9kZS5vZmZzZXRZO1xyXG4gICAgICAgIGJvdW5kcyA9IHRoaXMuYXBwbHkobm9kZSwgYm91bmRzKTtcclxuICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkO1xyXG5cclxuICAgICAgICBpZiAoY2hpbGQgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBib3VuZHMgPSB0aGlzLmhvcml6b250YWxMYXlvdXQoY2hpbGQsIG5vZGUueCwgbm9kZS55LCBib3VuZHMpO1xyXG4gICAgICAgICAgICB2YXIgc2libGluZ09mZnNldCA9IG5vZGUueSArIGNoaWxkLm9mZnNldFk7XHJcbiAgICAgICAgICAgIHZhciBzID0gY2hpbGQubmV4dDtcclxuXHJcbiAgICAgICAgICAgIHdoaWxlIChzICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIGJvdW5kcyA9IHRoaXMuaG9yaXpvbnRhbExheW91dChzLCBub2RlLnggLSBjaGlsZC5vZmZzZXRYLCBzaWJsaW5nT2Zmc2V0LCBib3VuZHMpO1xyXG4gICAgICAgICAgICAgICAgc2libGluZ09mZnNldCArPSBzLm9mZnNldFk7XHJcbiAgICAgICAgICAgICAgICBzID0gcy5uZXh0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gYm91bmRzO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGxheW91dChub2RlKSB7XHJcbiAgICAvLyAgICAgaWYgKG5vZGUgIT0gbnVsbCkge1xyXG4gICAgLy8gICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkO1xyXG5cclxuICAgIC8vICAgICAgICAgd2hpbGUgKGNoaWxkICE9IG51bGwpIHtcclxuICAgIC8vICAgICAgICAgICAgIHRoaXMubGF5b3V0KGNoaWxkKTtcclxuICAgIC8vICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQubmV4dDtcclxuICAgIC8vICAgICAgICAgfVxyXG5cclxuICAgIC8vICAgICAgICAgaWYgKG5vZGUuY2hpbGQgIT0gbnVsbCkge1xyXG4gICAgLy8gICAgICAgICAgICAgdGhpcy5hdHRhY2hQYXJlbnQobm9kZSwgdGhpcy5qb2luKG5vZGUpKTtcclxuICAgIC8vICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICBlbHNlIHtcclxuICAgIC8vICAgICAgICAgICAgIHRoaXMubGF5b3V0TGVhZihub2RlKTtcclxuICAgIC8vICAgICAgICAgfVxyXG4gICAgLy8gICAgIH1cclxuICAgIC8vIH1cclxuXHJcbiAgICAvLyBhcHBseShub2RlLCBib3VuZHMpIHtcclxuICAgIC8vICAgICB2YXIgbW9kZWwgPSB0aGlzLmdyYXBoLmdldE1vZGVsKCk7XHJcbiAgICAvLyAgICAgdmFyIGNlbGwgPSBub2RlLmNlbGw7XHJcbiAgICAvLyAgICAgdmFyIGcgPSBtb2RlbC5nZXRHZW9tZXRyeShjZWxsKTtcclxuXHJcbiAgICAvLyAgICAgaWYgKGNlbGwgIT0gbnVsbCAmJiBnICE9IG51bGwpIHtcclxuICAgIC8vICAgICAgICAgaWYgKHRoaXMuaXNWZXJ0ZXhNb3ZhYmxlKGNlbGwpKSB7XHJcbiAgICAvLyAgICAgICAgICAgICBnID0gdGhpcy5zZXRWZXJ0ZXhMb2NhdGlvbihjZWxsLCBub2RlLngsIG5vZGUueSk7XHJcblxyXG4gICAgLy8gICAgICAgICAgICAgaWYgKHRoaXMucmVzaXplUGFyZW50KSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IG1vZGVsLmdldFBhcmVudChjZWxsKTtcclxuICAgIC8vICAgICAgICAgICAgICAgICB2YXIgaWQgPSBteENlbGxQYXRoLmNyZWF0ZShwYXJlbnQpO1xyXG5cclxuICAgIC8vICAgICAgICAgICAgICAgICAvLyBJbXBsZW1lbnRzIHNldCBzZW1hbnRpY1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcmVudHNDaGFuZ2VkW2lkXSA9PSBudWxsKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFyZW50c0NoYW5nZWRbaWRdID0gcGFyZW50O1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICAgfVxyXG5cclxuICAgIC8vICAgICAgICAgaWYgKGJvdW5kcyA9PSBudWxsKSB7XHJcbiAgICAvLyAgICAgICAgICAgICBib3VuZHMgPSBuZXcgbXhSZWN0YW5nbGUoZy54LCBnLnksIGcud2lkdGgsIGcuaGVpZ2h0KTtcclxuICAgIC8vICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICBlbHNlIHtcclxuICAgIC8vICAgICAgICAgICAgIGJvdW5kcyA9IG5ldyBteFJlY3RhbmdsZShNYXRoLm1pbihib3VuZHMueCwgZy54KSxcclxuICAgIC8vICAgICAgICAgICAgICAgICBNYXRoLm1pbihib3VuZHMueSwgZy55KSxcclxuICAgIC8vICAgICAgICAgICAgICAgICBNYXRoLm1heChib3VuZHMueCArIGJvdW5kcy53aWR0aCwgZy54ICsgZy53aWR0aCksXHJcbiAgICAvLyAgICAgICAgICAgICAgICAgTWF0aC5tYXgoYm91bmRzLnkgKyBib3VuZHMuaGVpZ2h0LCBnLnkgKyBnLmhlaWdodCkpO1xyXG4gICAgLy8gICAgICAgICB9XHJcbiAgICAvLyAgICAgfVxyXG5cclxuICAgIC8vICAgICByZXR1cm4gYm91bmRzO1xyXG4gICAgLy8gfVxyXG5cclxuICAgIC8vIGF0dGFjaFBhcmVudChub2RlLCBoZWlnaHQpIHtcclxuICAgIC8vICAgICBsZXQgeCA9IHRoaXMubm9kZURpc3RhbmNlICsgdGhpcy5sZXZlbERpc3RhbmNlO1xyXG4gICAgLy8gICAgIGxldCB5MiA9IChoZWlnaHQgLSBub2RlLndpZHRoKSAvIDIgLSB0aGlzLm5vZGVEaXN0YW5jZTtcclxuICAgIC8vICAgICBsZXQgeTEgPSB5MiArIG5vZGUud2lkdGggKyAyICogdGhpcy5ub2RlRGlzdGFuY2UgLSBoZWlnaHQ7XHJcblxyXG4gICAgLy8gICAgIG5vZGUuY2hpbGQub2Zmc2V0WCA9IHggKyBub2RlLmhlaWdodDtcclxuICAgIC8vICAgICBub2RlLmNoaWxkLm9mZnNldFkgPSB5MTtcclxuXHJcbiAgICAvLyAgICAgbm9kZS5jb250b3VyLnVwcGVySGVhZCA9IHRoaXMuY3JlYXRlTGluZShub2RlLmhlaWdodCwgMCxcclxuICAgIC8vICAgICAgICAgdGhpcy5jcmVhdGVMaW5lKHgsIHkxLCBub2RlLmNvbnRvdXIudXBwZXJIZWFkKSk7XHJcbiAgICAvLyAgICAgbm9kZS5jb250b3VyLmxvd2VySGVhZCA9IHRoaXMuY3JlYXRlTGluZShub2RlLmhlaWdodCwgMCxcclxuICAgIC8vICAgICAgICAgdGhpcy5jcmVhdGVMaW5lKHgsIHkyLCBub2RlLmNvbnRvdXIubG93ZXJIZWFkKSk7XHJcbiAgICAvLyB9XHJcblxyXG4gICAgLy8gbGF5b3V0TGVhZihub2RlKSB7XHJcbiAgICAvLyAgICAgbGV0IGRpc3QgPSAyICogdGhpcy5ub2RlRGlzdGFuY2U7XHJcblxyXG4gICAgLy8gICAgIG5vZGUuY29udG91ci51cHBlclRhaWwgPSB0aGlzLmNyZWF0ZUxpbmUoXHJcbiAgICAvLyAgICAgICAgIG5vZGUuaGVpZ2h0ICsgZGlzdCwgMCk7XHJcbiAgICAvLyAgICAgbm9kZS5jb250b3VyLnVwcGVySGVhZCA9IG5vZGUuY29udG91ci51cHBlclRhaWw7XHJcbiAgICAvLyAgICAgbm9kZS5jb250b3VyLmxvd2VyVGFpbCA9IHRoaXMuY3JlYXRlTGluZShcclxuICAgIC8vICAgICAgICAgMCwgLW5vZGUud2lkdGggLSBkaXN0KTtcclxuICAgIC8vICAgICBub2RlLmNvbnRvdXIubG93ZXJIZWFkID0gdGhpcy5jcmVhdGVMaW5lKFxyXG4gICAgLy8gICAgICAgICBub2RlLmhlaWdodCArIGRpc3QsIDAsIG5vZGUuY29udG91ci5sb3dlclRhaWwpO1xyXG4gICAgLy8gfVxyXG59Il19