/**
 * @fileoverview added by tsickle
 * Generated from: lib/bill-tracker/mxgraph-ext/CompactTreeLayout.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { mxCompactTreeLayout, mxCellPath, mxDictionary } from '../../ref/mxgraph';
var CompactTreeLayout = /** @class */ (function (_super) {
    tslib_1.__extends(CompactTreeLayout, _super);
    function CompactTreeLayout(graph, horizontal, invert) {
        var _this = _super.call(this, graph, horizontal, invert) || this;
        _this.useBoundingBox = false;
        return _this;
    }
    /**
     * @param {?} cell
     * @param {?} parent
     * @return {?}
     */
    CompactTreeLayout.prototype.dfs = /**
     * @param {?} cell
     * @param {?} parent
     * @return {?}
     */
    function (cell, parent) {
        /** @type {?} */
        var id = mxCellPath.create(cell);
        /** @type {?} */
        var node = null;
        if (cell != null && this.visited[id] == null && !this.isVertexIgnored(cell)) {
            this.visited[id] = cell;
            node = this.createNode(cell);
            /** @type {?} */
            var model = this.graph.getModel();
            /** @type {?} */
            var prev = null;
            /** @type {?} */
            var out = this.graph.getEdges(cell, parent, this.invert, !this.invert, false, true);
            /** @type {?} */
            var view = this.graph.getView();
            if (this.sortEdges) {
                this.sortOutgoingEdges(cell, out);
            }
            for (var i = 0; i < out.length; i++) {
                /** @type {?} */
                var edge = out[i];
                if (!this.isEdgeIgnored(edge)) {
                    // Resets the points on the traversed edge
                    if (this.resetEdges) {
                        this.setEdgePoints(edge, null);
                    }
                    if (this.edgeRouting) {
                        this.setEdgeStyleEnabled(edge, false);
                        this.setEdgePoints(edge, null);
                    }
                    // Checks if terminal in same swimlane
                    /** @type {?} */
                    var state = view.getState(edge);
                    /** @type {?} */
                    var target = (state != null) ? state.getVisibleTerminal(this.invert) : view.getVisibleTerminal(edge, this.invert);
                    /** @type {?} */
                    var tmp = this.dfs(target, parent);
                    if (tmp != null && model.getGeometry(target) != null) {
                        if (prev == null) {
                            node.child = tmp;
                        }
                        else {
                            prev.next = tmp;
                        }
                        prev = tmp;
                    }
                }
            }
        }
        return node;
    };
    /**
     * @param {?} target
     * @param {?} edges
     * @return {?}
     */
    CompactTreeLayout.prototype.sortIngoingEdges = /**
     * @param {?} target
     * @param {?} edges
     * @return {?}
     */
    function (target, edges) {
        /** @type {?} */
        var lookup = new mxDictionary();
        edges.sort((/**
         * @param {?} e1
         * @param {?} e2
         * @return {?}
         */
        function (e1, e2) {
            /** @type {?} */
            var start1 = e1.getTerminal(e1.getTerminal(true) == target);
            // let end1 = e1.getTerminal(e1.getTerminal(true) == target);
            /** @type {?} */
            var p1 = lookup.get(start1);
            if (p1 == null) {
                p1 = mxCellPath.create(start1).split(mxCellPath.PATH_SEPARATOR);
                lookup.put(start1, p1);
            }
            /** @type {?} */
            var start2 = e2.getTerminal(e2.getTerminal(true) == target);
            /** @type {?} */
            var p2 = lookup.get(start2);
            if (p2 == null) {
                p2 = mxCellPath.create(start2).split(mxCellPath.PATH_SEPARATOR);
                lookup.put(start2, p2);
            }
            return mxCellPath.compare(p1, p2);
        }));
    };
    /**
     * @param {?} parent
     * @param {?} root
     * @return {?}
     */
    CompactTreeLayout.prototype.execute = /**
     * @param {?} parent
     * @param {?} root
     * @return {?}
     */
    function (parent, root) {
        this.parent = parent;
        /** @type {?} */
        var model = this.graph.getModel();
        if (root == null) {
            // Takes the parent as the root if it has outgoing edges
            if (this.graph.getEdges(parent, model.getParent(parent), this.invert, !this.invert, false).length > 0) {
                this.root = parent;
            }
            // Tries to find a suitable root in the parent's
            // children
            else {
                /** @type {?} */
                var roots = this.graph.findTreeRoots(parent, true, this.invert);
                if (roots.length > 0) {
                    for (var i = 0; i < roots.length; i++) {
                        if (!this.isVertexIgnored(roots[i]) &&
                            this.graph.getEdges(roots[i], null, this.invert, !this.invert, false).length > 0) {
                            this.root = roots[i];
                            break;
                        }
                    }
                }
            }
        }
        else {
            this.root = root;
        }
        if (this.root != null) {
            if (this.resizeParent) {
                this.parentsChanged = new Object();
            }
            else {
                this.parentsChanged = null;
            }
            //  Maintaining parent location
            this.parentX = null;
            this.parentY = null;
            if (parent != this.root && model.isVertex(parent) != null && this.maintainParentLocation) {
                /** @type {?} */
                var geo = this.graph.getCellGeometry(parent);
                if (geo != null) {
                    this.parentX = geo.x;
                    this.parentY = geo.y;
                }
            }
            model.beginUpdate();
            try {
                this.visited = {};
                this.node = this.dfs(this.root, parent);
                if (this.alignRanks) {
                    this.maxRankHeight = [];
                    this.findRankHeights(this.node, 0);
                    this.setCellHeights(this.node, 0);
                }
                if (this.node != null) {
                    this.layout(this.node);
                    /** @type {?} */
                    var x0 = this.graph.gridSize;
                    /** @type {?} */
                    var y0 = x0;
                    if (!this.moveTree) {
                        /** @type {?} */
                        var g = this.getVertexBounds(this.root);
                        if (g != null) {
                            x0 = g.x;
                            y0 = g.y;
                        }
                    }
                    /** @type {?} */
                    var bounds = null;
                    if (this.isHorizontal()) {
                        bounds = this.horizontalLayout(this.node, x0, y0);
                    }
                    else {
                        bounds = this.verticalLayout(this.node, null, x0, y0);
                    }
                    if (bounds != null) {
                        /** @type {?} */
                        var dx = 0;
                        /** @type {?} */
                        var dy = 0;
                        // if (bounds.x < 0) {
                        //     dx = Math.abs(x0 - bounds.x);
                        // }
                        // if (bounds.y < 0) {
                        //     dy = Math.abs(y0 - bounds.y);
                        // }
                        if (bounds.x > 0) {
                            dx = -1 * Math.abs(x0 - bounds.x);
                        }
                        if (bounds.y > 0) {
                            dy = -1 * Math.abs(y0 - bounds.y);
                        }
                        if (dx != 0 || dy != 0) {
                            this.moveNode(this.node, dx, dy);
                        }
                        if (this.resizeParent) {
                            this.adjustParents();
                        }
                        if (this.edgeRouting) {
                            // Iterate through all edges setting their positions
                            this.localEdgeProcessing(this.node);
                        }
                    }
                    // Maintaining parent location
                    if (this.parentX != null && this.parentY != null) {
                        /** @type {?} */
                        var geo = this.graph.getCellGeometry(parent);
                        if (geo != null) {
                            geo = geo.clone();
                            geo.x = this.parentX;
                            geo.y = this.parentY;
                            model.setGeometry(parent, geo);
                        }
                    }
                }
            }
            finally {
                model.endUpdate();
            }
        }
    };
    /**
     * @param {?} node
     * @param {?} x0
     * @param {?} y0
     * @param {?=} bounds
     * @return {?}
     */
    CompactTreeLayout.prototype.horizontalLayout = /**
     * @param {?} node
     * @param {?} x0
     * @param {?} y0
     * @param {?=} bounds
     * @return {?}
     */
    function (node, x0, y0, bounds) {
        node.x += x0 + node.offsetX;
        node.y += y0 + node.offsetY;
        bounds = this.apply(node, bounds);
        /** @type {?} */
        var child = node.child;
        if (child != null) {
            bounds = this.horizontalLayout(child, node.x, node.y, bounds);
            /** @type {?} */
            var siblingOffset = node.y + child.offsetY;
            /** @type {?} */
            var s = child.next;
            while (s != null) {
                bounds = this.horizontalLayout(s, node.x + child.offsetX, siblingOffset, bounds);
                siblingOffset += s.offsetY;
                s = s.next;
            }
        }
        return bounds;
    };
    return CompactTreeLayout;
}(mxCompactTreeLayout));
export { CompactTreeLayout };
if (false) {
    /** @type {?} */
    CompactTreeLayout.prototype.visited;
    /** @type {?} */
    CompactTreeLayout.prototype.graph;
    /** @type {?} */
    CompactTreeLayout.prototype.sortEdges;
    /** @type {?} */
    CompactTreeLayout.prototype.parent;
    /** @type {?} */
    CompactTreeLayout.prototype.parentsChanged;
    /** @type {?} */
    CompactTreeLayout.prototype.parentX;
    /** @type {?} */
    CompactTreeLayout.prototype.parentY;
    /** @type {?} */
    CompactTreeLayout.prototype.node;
    /** @type {?} */
    CompactTreeLayout.prototype.alignRanks;
    /** @type {?} */
    CompactTreeLayout.prototype.maxRankHeight;
    /** @type {?} */
    CompactTreeLayout.prototype.moveTree;
    /** @type {?} */
    CompactTreeLayout.prototype.nodeDistance;
    /** @type {?} */
    CompactTreeLayout.prototype.useBoundingBox;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29tcGFjdFRyZWVMYXlvdXQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZWRwLWJpZi9ydW50aW1lLWFwaS8iLCJzb3VyY2VzIjpbImxpYi9iaWxsLXRyYWNrZXIvbXhncmFwaC1leHQvQ29tcGFjdFRyZWVMYXlvdXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsT0FBTyxFQUFFLG1CQUFtQixFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQTBCLE1BQU0sbUJBQW1CLENBQUM7QUFFMUc7SUFBdUMsNkNBQW1CO0lBY3RELDJCQUFZLEtBQXdCLEVBQUUsVUFBb0IsRUFBRSxNQUFnQjtRQUE1RSxZQUNJLGtCQUFNLEtBQUssRUFBRSxVQUFVLEVBQUUsTUFBTSxDQUFDLFNBQ25DO1FBSEQsb0JBQWMsR0FBWSxLQUFLLENBQUM7O0lBR2hDLENBQUM7Ozs7OztJQUVELCtCQUFHOzs7OztJQUFILFVBQUksSUFBc0IsRUFBRSxNQUF3Qjs7WUFDNUMsRUFBRSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDOztZQUM1QixJQUFJLEdBQUcsSUFBSTtRQUVmLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDekUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDeEIsSUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7O2dCQUV6QixLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUU7O2dCQUM3QixJQUFJLEdBQUcsSUFBSTs7Z0JBQ1gsR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxN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QUFDO2dCQUNqRixhQUFhLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQztnQkFDM0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7YUFDZDtTQUNKO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQStFTCx3QkFBQztBQUFELENBQUMsQUE5VUQsQ0FBdUMsbUJBQW1CLEdBOFV6RDs7OztJQTdVRyxvQ0FBNEM7O0lBQzVDLGtDQUF5Qjs7SUFDekIsc0NBQWU7O0lBQ2YsbUNBQXlCOztJQUN6QiwyQ0FBdUI7O0lBQ3ZCLG9DQUFnQjs7SUFDaEIsb0NBQWdCOztJQUNoQixpQ0FBVTs7SUFDVix1Q0FBZ0I7O0lBQ2hCLDBDQUFxQjs7SUFDckIscUNBQWM7O0lBQ2QseUNBQWtCOztJQUNsQiwyQ0FBZ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBteENvbXBhY3RUcmVlTGF5b3V0LCBteENlbGxQYXRoLCBteERpY3Rpb25hcnksIE14R3JhcGhOUywgbXhSZWN0YW5nbGUgfSBmcm9tICcuLi8uLi9yZWYvbXhncmFwaCc7XHJcblxyXG5leHBvcnQgY2xhc3MgQ29tcGFjdFRyZWVMYXlvdXQgZXh0ZW5kcyBteENvbXBhY3RUcmVlTGF5b3V0IHtcclxuICAgIHZpc2l0ZWQ6IHsgW2lkOiBzdHJpbmddOiBNeEdyYXBoTlMubXhDZWxsIH07XHJcbiAgICBncmFwaDogTXhHcmFwaE5TLm14R3JhcGg7XHJcbiAgICBzb3J0RWRnZXM6IGFueTtcclxuICAgIHBhcmVudDogTXhHcmFwaE5TLm14Q2VsbDtcclxuICAgIHBhcmVudHNDaGFuZ2VkOiBPYmplY3Q7XHJcbiAgICBwYXJlbnRYOiBudW1iZXI7XHJcbiAgICBwYXJlbnRZOiBudW1iZXI7XHJcbiAgICBub2RlOiBhbnk7XHJcbiAgICBhbGlnblJhbmtzOiBhbnk7XHJcbiAgICBtYXhSYW5rSGVpZ2h0OiBhbnlbXTtcclxuICAgIG1vdmVUcmVlOiBhbnk7XHJcbiAgICBub2RlRGlzdGFuY2U6IGFueTtcclxuICAgIHVzZUJvdW5kaW5nQm94OiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBjb25zdHJ1Y3RvcihncmFwaDogTXhHcmFwaE5TLm14R3JhcGgsIGhvcml6b250YWw/OiBib29sZWFuLCBpbnZlcnQ/OiBib29sZWFuKSB7XHJcbiAgICAgICAgc3VwZXIoZ3JhcGgsIGhvcml6b250YWwsIGludmVydCk7XHJcbiAgICB9XHJcblxyXG4gICAgZGZzKGNlbGw6IE14R3JhcGhOUy5teENlbGwsIHBhcmVudDogTXhHcmFwaE5TLm14Q2VsbCkge1xyXG4gICAgICAgIGxldCBpZCA9IG14Q2VsbFBhdGguY3JlYXRlKGNlbGwpO1xyXG4gICAgICAgIGxldCBub2RlID0gbnVsbDtcclxuXHJcbiAgICAgICAgaWYgKGNlbGwgIT0gbnVsbCAmJiB0aGlzLnZpc2l0ZWRbaWRdID09IG51bGwgJiYgIXRoaXMuaXNWZXJ0ZXhJZ25vcmVkKGNlbGwpKSB7XHJcbiAgICAgICAgICAgIHRoaXMudmlzaXRlZFtpZF0gPSBjZWxsO1xyXG4gICAgICAgICAgICBub2RlID0gdGhpcy5jcmVhdGVOb2RlKGNlbGwpO1xyXG5cclxuICAgICAgICAgICAgbGV0IG1vZGVsID0gdGhpcy5ncmFwaC5nZXRNb2RlbCgpO1xyXG4gICAgICAgICAgICBsZXQgcHJldiA9IG51bGw7XHJcbiAgICAgICAgICAgIGxldCBvdXQgPSB0aGlzLmdyYXBoLmdldEVkZ2VzKGNlbGwsIHBhcmVudCwgdGhpcy5pbnZlcnQsICF0aGlzLmludmVydCwgZmFsc2UsIHRydWUpO1xyXG4gICAgICAgICAgICBsZXQgdmlldyA9IHRoaXMuZ3JhcGguZ2V0VmlldygpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuc29ydEVkZ2VzKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNvcnRPdXRnb2luZ0VkZ2VzKGNlbGwsIG91dCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3V0Lmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZWRnZSA9IG91dFtpXTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNFZGdlSWdub3JlZChlZGdlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0cyB0aGUgcG9pbnRzIG9uIHRoZSB0cmF2ZXJzZWQgZWRnZVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlc2V0RWRnZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRFZGdlUG9pbnRzKGVkZ2UsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZWRnZVJvdXRpbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRFZGdlU3R5bGVFbmFibGVkKGVkZ2UsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRFZGdlUG9pbnRzKGVkZ2UsIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2tzIGlmIHRlcm1pbmFsIGluIHNhbWUgc3dpbWxhbmVcclxuICAgICAgICAgICAgICAgICAgICBsZXQgc3RhdGUgPSB2aWV3LmdldFN0YXRlKGVkZ2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCB0YXJnZXQgPSAoc3RhdGUgIT0gbnVsbCkgPyBzdGF0ZS5nZXRWaXNpYmxlVGVybWluYWwodGhpcy5pbnZlcnQpIDogdmlldy5nZXRWaXNpYmxlVGVybWluYWwoZWRnZSwgdGhpcy5pbnZlcnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCB0bXAgPSB0aGlzLmRmcyh0YXJnZXQsIHBhcmVudCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0bXAgIT0gbnVsbCAmJiBtb2RlbC5nZXRHZW9tZXRyeSh0YXJnZXQpICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZXYgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5jaGlsZCA9IHRtcDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXYubmV4dCA9IHRtcDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJldiA9IHRtcDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBub2RlO1xyXG4gICAgfVxyXG5cclxuICAgIHNvcnRJbmdvaW5nRWRnZXModGFyZ2V0OiBNeEdyYXBoTlMubXhDZWxsLCBlZGdlczogTXhHcmFwaE5TLm14Q2VsbFtdKSB7XHJcbiAgICAgICAgbGV0IGxvb2t1cCA9IG5ldyBteERpY3Rpb25hcnkoKTtcclxuXHJcbiAgICAgICAgZWRnZXMuc29ydChmdW5jdGlvbiAoZTEsIGUyKSB7XHJcbiAgICAgICAgICAgIGxldCBzdGFydDEgPSBlMS5nZXRUZXJtaW5hbChlMS5nZXRUZXJtaW5hbCh0cnVlKSA9PSB0YXJnZXQpO1xyXG4gICAgICAgICAgICAvLyBsZXQgZW5kMSA9IGUxLmdldFRlcm1pbmFsKGUxLmdldFRlcm1pbmFsKHRydWUpID09IHRhcmdldCk7XHJcbiAgICAgICAgICAgIGxldCBwMSA9IGxvb2t1cC5nZXQoc3RhcnQxKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChwMSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBwMSA9IG14Q2VsbFBhdGguY3JlYXRlKHN0YXJ0MSkuc3BsaXQobXhDZWxsUGF0aC5QQVRIX1NFUEFSQVRPUik7XHJcbiAgICAgICAgICAgICAgICBsb29rdXAucHV0KHN0YXJ0MSwgcDEpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsZXQgc3RhcnQyID0gZTIuZ2V0VGVybWluYWwoZTIuZ2V0VGVybWluYWwodHJ1ZSkgPT0gdGFyZ2V0KTtcclxuICAgICAgICAgICAgbGV0IHAyID0gbG9va3VwLmdldChzdGFydDIpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHAyID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHAyID0gbXhDZWxsUGF0aC5jcmVhdGUoc3RhcnQyKS5zcGxpdChteENlbGxQYXRoLlBBVEhfU0VQQVJBVE9SKTtcclxuICAgICAgICAgICAgICAgIGxvb2t1cC5wdXQoc3RhcnQyLCBwMik7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBteENlbGxQYXRoLmNvbXBhcmUocDEsIHAyKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBleGVjdXRlKHBhcmVudDogTXhHcmFwaE5TLm14Q2VsbCwgcm9vdDogTXhHcmFwaE5TLm14Q2VsbCkge1xyXG4gICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50O1xyXG4gICAgICAgIGxldCBtb2RlbCA9IHRoaXMuZ3JhcGguZ2V0TW9kZWwoKTtcclxuXHJcbiAgICAgICAgaWYgKHJvb3QgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAvLyBUYWtlcyB0aGUgcGFyZW50IGFzIHRoZSByb290IGlmIGl0IGhhcyBvdXRnb2luZyBlZGdlc1xyXG4gICAgICAgICAgICBpZiAodGhpcy5ncmFwaC5nZXRFZGdlcyhwYXJlbnQsIG1vZGVsLmdldFBhcmVudChwYXJlbnQpLFxyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnZlcnQsICF0aGlzLmludmVydCwgZmFsc2UpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucm9vdCA9IHBhcmVudDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gVHJpZXMgdG8gZmluZCBhIHN1aXRhYmxlIHJvb3QgaW4gdGhlIHBhcmVudCdzXHJcbiAgICAgICAgICAgIC8vIGNoaWxkcmVuXHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbGV0IHJvb3RzID0gdGhpcy5ncmFwaC5maW5kVHJlZVJvb3RzKHBhcmVudCwgdHJ1ZSwgdGhpcy5pbnZlcnQpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChyb290cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByb290cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNWZXJ0ZXhJZ25vcmVkKHJvb3RzW2ldKSAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ncmFwaC5nZXRFZGdlcyhyb290c1tpXSwgbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmludmVydCwgIXRoaXMuaW52ZXJ0LCBmYWxzZSkubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yb290ID0gcm9vdHNbaV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5yb290ID0gcm9vdDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnJvb3QgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5yZXNpemVQYXJlbnQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucGFyZW50c0NoYW5nZWQgPSBuZXcgT2JqZWN0KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBhcmVudHNDaGFuZ2VkID0gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gIE1haW50YWluaW5nIHBhcmVudCBsb2NhdGlvblxyXG4gICAgICAgICAgICB0aGlzLnBhcmVudFggPSBudWxsO1xyXG4gICAgICAgICAgICB0aGlzLnBhcmVudFkgPSBudWxsO1xyXG5cclxuICAgICAgICAgICAgaWYgKHBhcmVudCAhPSB0aGlzLnJvb3QgJiYgbW9kZWwuaXNWZXJ0ZXgocGFyZW50KSAhPSBudWxsICYmIHRoaXMubWFpbnRhaW5QYXJlbnRMb2NhdGlvbikge1xyXG4gICAgICAgICAgICAgICAgbGV0IGdlbyA9IHRoaXMuZ3JhcGguZ2V0Q2VsbEdlb21ldHJ5KHBhcmVudCk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGdlbyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJlbnRYID0gZ2VvLng7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJlbnRZID0gZ2VvLnk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIG1vZGVsLmJlZ2luVXBkYXRlKCk7XHJcblxyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy52aXNpdGVkID0ge307XHJcbiAgICAgICAgICAgICAgICB0aGlzLm5vZGUgPSB0aGlzLmRmcyh0aGlzLnJvb3QsIHBhcmVudCk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuYWxpZ25SYW5rcykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWF4UmFua0hlaWdodCA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmluZFJhbmtIZWlnaHRzKHRoaXMubm9kZSwgMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDZWxsSGVpZ2h0cyh0aGlzLm5vZGUsIDApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLm5vZGUgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubGF5b3V0KHRoaXMubm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHgwID0gdGhpcy5ncmFwaC5ncmlkU2l6ZTtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgeTAgPSB4MDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLm1vdmVUcmVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBnID0gdGhpcy5nZXRWZXJ0ZXhCb3VuZHModGhpcy5yb290KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHgwID0gZy54O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeTAgPSBnLnk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBib3VuZHMgPSBudWxsO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0hvcml6b250YWwoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBib3VuZHMgPSB0aGlzLmhvcml6b250YWxMYXlvdXQodGhpcy5ub2RlLCB4MCwgeTApO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYm91bmRzID0gdGhpcy52ZXJ0aWNhbExheW91dCh0aGlzLm5vZGUsIG51bGwsIHgwLCB5MCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoYm91bmRzICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGR4ID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGR5ID0gMDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIChib3VuZHMueCA8IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIGR4ID0gTWF0aC5hYnMoeDAgLSBib3VuZHMueCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIChib3VuZHMueSA8IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIGR5ID0gTWF0aC5hYnMoeTAgLSBib3VuZHMueSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJvdW5kcy54ID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZHggPSAtMSAqIE1hdGguYWJzKHgwIC0gYm91bmRzLngpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYm91bmRzLnkgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkeSA9IC0xICogTWF0aC5hYnMoeTAgLSBib3VuZHMueSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkeCAhPSAwIHx8IGR5ICE9IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW92ZU5vZGUodGhpcy5ub2RlLCBkeCwgZHkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZXNpemVQYXJlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRqdXN0UGFyZW50cygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5lZGdlUm91dGluZykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSXRlcmF0ZSB0aHJvdWdoIGFsbCBlZGdlcyBzZXR0aW5nIHRoZWlyIHBvc2l0aW9uc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhbEVkZ2VQcm9jZXNzaW5nKHRoaXMubm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIE1haW50YWluaW5nIHBhcmVudCBsb2NhdGlvblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcmVudFggIT0gbnVsbCAmJiB0aGlzLnBhcmVudFkgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZ2VvID0gdGhpcy5ncmFwaC5nZXRDZWxsR2VvbWV0cnkocGFyZW50KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnZW8gIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2VvID0gZ2VvLmNsb25lKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZW8ueCA9IHRoaXMucGFyZW50WDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlby55ID0gdGhpcy5wYXJlbnRZO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWwuc2V0R2VvbWV0cnkocGFyZW50LCBnZW8pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGZpbmFsbHkge1xyXG4gICAgICAgICAgICAgICAgbW9kZWwuZW5kVXBkYXRlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaG9yaXpvbnRhbExheW91dChub2RlLCB4MDogbnVtYmVyLCB5MDogbnVtYmVyLCBib3VuZHM/OiBNeEdyYXBoTlMubXhSZWN0YW5nbGUpIHtcclxuICAgICAgICBub2RlLnggKz0geDAgKyBub2RlLm9mZnNldFg7XHJcbiAgICAgICAgbm9kZS55ICs9IHkwICsgbm9kZS5vZmZzZXRZO1xyXG4gICAgICAgIGJvdW5kcyA9IHRoaXMuYXBwbHkobm9kZSwgYm91bmRzKTtcclxuICAgICAgICBsZXQgY2hpbGQgPSBub2RlLmNoaWxkO1xyXG5cclxuICAgICAgICBpZiAoY2hpbGQgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBib3VuZHMgPSB0aGlzLmhvcml6b250YWxMYXlvdXQoY2hpbGQsIG5vZGUueCwgbm9kZS55LCBib3VuZHMpO1xyXG4gICAgICAgICAgICBsZXQgc2libGluZ09mZnNldCA9IG5vZGUueSArIGNoaWxkLm9mZnNldFk7XHJcbiAgICAgICAgICAgIGxldCBzID0gY2hpbGQubmV4dDtcclxuXHJcbiAgICAgICAgICAgIHdoaWxlIChzICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIGJvdW5kcyA9IHRoaXMuaG9yaXpvbnRhbExheW91dChzLCBub2RlLnggKyBjaGlsZC5vZmZzZXRYLCBzaWJsaW5nT2Zmc2V0LCBib3VuZHMpO1xyXG4gICAgICAgICAgICAgICAgc2libGluZ09mZnNldCArPSBzLm9mZnNldFk7XHJcbiAgICAgICAgICAgICAgICBzID0gcy5uZXh0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gYm91bmRzO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGxheW91dChub2RlKSB7XHJcbiAgICAvLyAgICAgaWYgKG5vZGUgIT0gbnVsbCkge1xyXG4gICAgLy8gICAgICAgICBsZXQgY2hpbGQgPSBub2RlLmNoaWxkO1xyXG5cclxuICAgIC8vICAgICAgICAgd2hpbGUgKGNoaWxkICE9IG51bGwpIHtcclxuICAgIC8vICAgICAgICAgICAgIHRoaXMubGF5b3V0KGNoaWxkKTtcclxuICAgIC8vICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQubmV4dDtcclxuICAgIC8vICAgICAgICAgfVxyXG5cclxuICAgIC8vICAgICAgICAgaWYgKG5vZGUuY2hpbGQgIT0gbnVsbCkge1xyXG4gICAgLy8gICAgICAgICAgICAgdGhpcy5hdHRhY2hQYXJlbnQobm9kZSwgdGhpcy5qb2luKG5vZGUpKTtcclxuICAgIC8vICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICBlbHNlIHtcclxuICAgIC8vICAgICAgICAgICAgIHRoaXMubGF5b3V0TGVhZihub2RlKTtcclxuICAgIC8vICAgICAgICAgfVxyXG4gICAgLy8gICAgIH1cclxuICAgIC8vIH1cclxuXHJcbiAgICAvLyBhcHBseShub2RlLCBib3VuZHMpIHtcclxuICAgIC8vICAgICBsZXQgbW9kZWwgPSB0aGlzLmdyYXBoLmdldE1vZGVsKCk7XHJcbiAgICAvLyAgICAgbGV0IGNlbGwgPSBub2RlLmNlbGw7XHJcbiAgICAvLyAgICAgbGV0IGcgPSBtb2RlbC5nZXRHZW9tZXRyeShjZWxsKTtcclxuXHJcbiAgICAvLyAgICAgaWYgKGNlbGwgIT0gbnVsbCAmJiBnICE9IG51bGwpIHtcclxuICAgIC8vICAgICAgICAgaWYgKHRoaXMuaXNWZXJ0ZXhNb3ZhYmxlKGNlbGwpKSB7XHJcbiAgICAvLyAgICAgICAgICAgICBnID0gdGhpcy5zZXRWZXJ0ZXhMb2NhdGlvbihjZWxsLCBub2RlLngsIG5vZGUueSk7XHJcblxyXG4gICAgLy8gICAgICAgICAgICAgaWYgKHRoaXMucmVzaXplUGFyZW50KSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgbGV0IHBhcmVudCA9IG1vZGVsLmdldFBhcmVudChjZWxsKTtcclxuICAgIC8vICAgICAgICAgICAgICAgICBsZXQgaWQgPSBteENlbGxQYXRoLmNyZWF0ZShwYXJlbnQpO1xyXG5cclxuICAgIC8vICAgICAgICAgICAgICAgICAvLyBJbXBsZW1lbnRzIHNldCBzZW1hbnRpY1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcmVudHNDaGFuZ2VkW2lkXSA9PSBudWxsKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFyZW50c0NoYW5nZWRbaWRdID0gcGFyZW50O1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICAgfVxyXG5cclxuICAgIC8vICAgICAgICAgaWYgKGJvdW5kcyA9PSBudWxsKSB7XHJcbiAgICAvLyAgICAgICAgICAgICBib3VuZHMgPSBuZXcgbXhSZWN0YW5nbGUoZy54LCBnLnksIGcud2lkdGgsIGcuaGVpZ2h0KTtcclxuICAgIC8vICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICBlbHNlIHtcclxuICAgIC8vICAgICAgICAgICAgIGJvdW5kcyA9IG5ldyBteFJlY3RhbmdsZShNYXRoLm1pbihib3VuZHMueCwgZy54KSxcclxuICAgIC8vICAgICAgICAgICAgICAgICBNYXRoLm1pbihib3VuZHMueSwgZy55KSxcclxuICAgIC8vICAgICAgICAgICAgICAgICBNYXRoLm1heChib3VuZHMueCArIGJvdW5kcy53aWR0aCwgZy54ICsgZy53aWR0aCksXHJcbiAgICAvLyAgICAgICAgICAgICAgICAgTWF0aC5tYXgoYm91bmRzLnkgKyBib3VuZHMuaGVpZ2h0LCBnLnkgKyBnLmhlaWdodCkpO1xyXG4gICAgLy8gICAgICAgICB9XHJcbiAgICAvLyAgICAgfVxyXG5cclxuICAgIC8vICAgICByZXR1cm4gYm91bmRzO1xyXG4gICAgLy8gfVxyXG5cclxuICAgIC8vIGF0dGFjaFBhcmVudChub2RlLCBoZWlnaHQpIHtcclxuICAgIC8vICAgICBsZXQgeCA9IHRoaXMubm9kZURpc3RhbmNlICsgdGhpcy5sZXZlbERpc3RhbmNlO1xyXG4gICAgLy8gICAgIGxldCB5MiA9IChoZWlnaHQgLSBub2RlLndpZHRoKSAvIDIgLSB0aGlzLm5vZGVEaXN0YW5jZTtcclxuICAgIC8vICAgICBsZXQgeTEgPSB5MiArIG5vZGUud2lkdGggKyAyICogdGhpcy5ub2RlRGlzdGFuY2UgLSBoZWlnaHQ7XHJcblxyXG4gICAgLy8gICAgIG5vZGUuY2hpbGQub2Zmc2V0WCA9IHggKyBub2RlLmhlaWdodDtcclxuICAgIC8vICAgICBub2RlLmNoaWxkLm9mZnNldFkgPSB5MTtcclxuXHJcbiAgICAvLyAgICAgbm9kZS5jb250b3VyLnVwcGVySGVhZCA9IHRoaXMuY3JlYXRlTGluZShub2RlLmhlaWdodCwgMCxcclxuICAgIC8vICAgICAgICAgdGhpcy5jcmVhdGVMaW5lKHgsIHkxLCBub2RlLmNvbnRvdXIudXBwZXJIZWFkKSk7XHJcbiAgICAvLyAgICAgbm9kZS5jb250b3VyLmxvd2VySGVhZCA9IHRoaXMuY3JlYXRlTGluZShub2RlLmhlaWdodCwgMCxcclxuICAgIC8vICAgICAgICAgdGhpcy5jcmVhdGVMaW5lKHgsIHkyLCBub2RlLmNvbnRvdXIubG93ZXJIZWFkKSk7XHJcbiAgICAvLyB9XHJcblxyXG4gICAgLy8gbGF5b3V0TGVhZihub2RlKSB7XHJcbiAgICAvLyAgICAgbGV0IGRpc3QgPSAyICogdGhpcy5ub2RlRGlzdGFuY2U7XHJcblxyXG4gICAgLy8gICAgIG5vZGUuY29udG91ci51cHBlclRhaWwgPSB0aGlzLmNyZWF0ZUxpbmUoXHJcbiAgICAvLyAgICAgICAgIG5vZGUuaGVpZ2h0ICsgZGlzdCwgMCk7XHJcbiAgICAvLyAgICAgbm9kZS5jb250b3VyLnVwcGVySGVhZCA9IG5vZGUuY29udG91ci51cHBlclRhaWw7XHJcbiAgICAvLyAgICAgbm9kZS5jb250b3VyLmxvd2VyVGFpbCA9IHRoaXMuY3JlYXRlTGluZShcclxuICAgIC8vICAgICAgICAgMCwgLW5vZGUud2lkdGggLSBkaXN0KTtcclxuICAgIC8vICAgICBub2RlLmNvbnRvdXIubG93ZXJIZWFkID0gdGhpcy5jcmVhdGVMaW5lKFxyXG4gICAgLy8gICAgICAgICBub2RlLmhlaWdodCArIGRpc3QsIDAsIG5vZGUuY29udG91ci5sb3dlclRhaWwpO1xyXG4gICAgLy8gfVxyXG59Il19