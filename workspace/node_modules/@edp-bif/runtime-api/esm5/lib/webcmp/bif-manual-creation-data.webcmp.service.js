/**
 * @fileoverview added by tsickle
 * Generated from: lib/webcmp/bif-manual-creation-data.webcmp.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Optional } from '@angular/core';
import { throwError } from 'rxjs';
import { MessagerService } from "@farris/ui-messager";
import { BindingData, ViewModel, FrameContext } from "@farris/devkit";
import { FormBillCreationProcessExecutorArgs } from '../entity/form-rest/FormBillCreationProcessExecutorArgs';
import { FormBillCreationProcessExecutorResult } from '@edp-aif/runtime-api';
import { BifDataService } from '../bif-manual-creation/service/bif-data.service';
import { FormCreateArgs, FormUpdateArgs } from '../ref';
import { PushTaskArgs } from '../bif-manual-creation/args/PushTaskArgs';
import { PushCreationMode } from '@edp-aif/common-api';
import { GetEntityDatasArgs } from '../bif-manual-creation/args/GetEntityDatasArgs';
import { ManualCreationMode } from '../entity/form-rest/ManualCreationMode';
import { LocalePipe } from '../bif-manual-creation/pipe/locale.pipe';
import { EntityParamUtils } from './EntityParamUtils';
/**
 * 手工生单数据服务类
 */
var BifManualCreationDataWebCmpService = /** @class */ (function () {
    function BifManualCreationDataWebCmpService(dataService, bindingData, messagerService, viewModel, frameContext) {
        this.dataService = dataService;
        this.bindingData = bindingData;
        this.messagerService = messagerService;
        this.viewModel = viewModel;
        this.frameContext = frameContext;
        this.localePipe = new LocalePipe(this.dataService && this.dataService.localeId || 'zh-CHS');
    }
    /**
     * 根据生单流程Id查找指定的生单流程
     * @param processId 单据流生单流程 Id
     * @returns creationProcess 生单流程 @type { Observable<IRtSlimBillCreationProcessEntityEx> }
     */
    /**
     * 根据生单流程Id查找指定的生单流程
     * @param {?} processId 单据流生单流程 Id
     * @return {?} creationProcess 生单流程 \@type { Observable<IRtSlimBillCreationProcessEntityEx> }
     */
    BifManualCreationDataWebCmpService.prototype.getSlimBillCreationProcessEntityExById = /**
     * 根据生单流程Id查找指定的生单流程
     * @param {?} processId 单据流生单流程 Id
     * @return {?} creationProcess 生单流程 \@type { Observable<IRtSlimBillCreationProcessEntityEx> }
     */
    function (processId) {
        if (processId == null || processId == "" || processId.trim() == "") {
            this.messagerService.error(this.localePipe.transform("processIdCantBeEmpty"));
            throw "参数processId不可为空";
        }
        return this.dataService.getSlimBillCreationProcessEntityExById(processId);
    };
    /**
     * 查询表单配置
     * @param formSettingsId 表单配置Id
     * @returns formSettings 表单配置 @type { Observable<FormSettings> }
     */
    /**
     * 查询表单配置
     * @param {?} formSettingsId 表单配置Id
     * @return {?} formSettings 表单配置 \@type { Observable<FormSettings> }
     */
    BifManualCreationDataWebCmpService.prototype.getFormSettingsById = /**
     * 查询表单配置
     * @param {?} formSettingsId 表单配置Id
     * @return {?} formSettings 表单配置 \@type { Observable<FormSettings> }
     */
    function (formSettingsId) {
        return this.dataService.getFormSettingsById(formSettingsId);
    };
    /**
     * 执行生单流程
     * @param entities 参与生单的上游单据ID列表或实体列表
     * @param creationProcessId 单据流生单流程 Id
     * @param creationRuleId 生单规则Id（生单流程实体中记录）
     * @returns creationResult 生单结果 @type { Observable<FormBillCreationProcessExecutorResult> }
     */
    /**
     * 执行生单流程
     * @param {?} entities 参与生单的上游单据ID列表或实体列表
     * @param {?} creationProcessId 单据流生单流程 Id
     * @param {?} creationRuleId 生单规则Id（生单流程实体中记录）
     * @param {?} targetDataIds
     * @param {?} manualCreationMode
     * @return {?} creationResult 生单结果 \@type { Observable<FormBillCreationProcessExecutorResult> }
     */
    BifManualCreationDataWebCmpService.prototype.executeBillCreationProcess = /**
     * 执行生单流程
     * @param {?} entities 参与生单的上游单据ID列表或实体列表
     * @param {?} creationProcessId 单据流生单流程 Id
     * @param {?} creationRuleId 生单规则Id（生单流程实体中记录）
     * @param {?} targetDataIds
     * @param {?} manualCreationMode
     * @return {?} creationResult 生单结果 \@type { Observable<FormBillCreationProcessExecutorResult> }
     */
    function (entities, creationProcessId, creationRuleId, targetDataIds, manualCreationMode) {
        if (entities == null || ((/** @type {?} */ (entities))) == "") {
            this.messagerService.error(this.localePipe.transform("entitiesCantBeEmpty"));
            throw "参数entities不可为空";
        }
        if (entities instanceof Map) {
            entities = Array.from(entities.values());
        }
        entities = Array.isArray(entities) ? entities : [entities];
        manualCreationMode = manualCreationMode ? manualCreationMode : ManualCreationMode.Push;
        var _a = EntityParamUtils.buildSourceVoEntityData(entities), sourceVoEntityDatas = _a.sourceVoEntityDatas, sourceVoEntityDataIds = _a.sourceVoEntityDataIds;
        //创建执行生单流程参数对象
        /** @type {?} */
        var args = new FormBillCreationProcessExecutorArgs();
        args.billCreationProcessId = creationProcessId;
        args.creationRuleId = creationRuleId;
        //FormCreationRuleExecutorArgs的sourceVoEntityDatas属性为前端实体序列化后的字符串列表
        //sourceVoEntityDatas列表中的每个字符串，在结构上应与单据流定义中所选中的上游视图对象一致。
        args.sourceVoEntityDatas = sourceVoEntityDatas;
        args.sourceVoEntityDataIds = sourceVoEntityDataIds;
        //下推过程中不存在目标主表单据Id，所以targetVoDataIds为空列表。
        args.targetVoDataIds = targetDataIds;
        args.manualCreationMode = manualCreationMode;
        return this.dataService.executeBillCreationProcess(args);
    };
    /**
     * 创建实体数据（RetrieveDefault至缓存）
     * @param formVoId 表单绑定VO Id
     * @param res 生单流程执行结果
     * @returns formCreateResult 创建实体数据返回结果 @type { Observable<FormCreateResult> }
     */
    /**
     * 创建实体数据（RetrieveDefault至缓存）
     * @param {?} formVoId 表单绑定VO Id
     * @param {?} res 生单流程执行结果
     * @return {?} formCreateResult 创建实体数据返回结果 \@type { Observable<FormCreateResult> }
     */
    BifManualCreationDataWebCmpService.prototype.createEntityDatas = /**
     * 创建实体数据（RetrieveDefault至缓存）
     * @param {?} formVoId 表单绑定VO Id
     * @param {?} res 生单流程执行结果
     * @return {?} formCreateResult 创建实体数据返回结果 \@type { Observable<FormCreateResult> }
     */
    function (formVoId, res) {
        /** @type {?} */
        var args = new FormCreateArgs();
        args.formVoId = formVoId;
        //获取生单流程执行结果
        args.rpcCreationRuleExecutorResult = res.creationRuleExecutorResult.ConvertToJson();
        //创建实体数据
        return this.dataService.createEntityDatas(args);
    };
    /**
     * 更新实体数据
     * @param res 生单流程执行结果
     * @returns formUpdateResult 更新实体数据返回结果 @type { Observable<FormUpdateResult> }
     */
    /**
     * 更新实体数据
     * @param {?} res 生单流程执行结果
     * @return {?} formUpdateResult 更新实体数据返回结果 \@type { Observable<FormUpdateResult> }
     */
    BifManualCreationDataWebCmpService.prototype.updateEntityDatas = /**
     * 更新实体数据
     * @param {?} res 生单流程执行结果
     * @return {?} formUpdateResult 更新实体数据返回结果 \@type { Observable<FormUpdateResult> }
     */
    function (res) {
        /** @type {?} */
        var args = new FormUpdateArgs();
        //Mapping执行条件判断结果为true时才会执行生单流程得到生单结果
        if (res.conditionResult.conditionExecutionResult == true) {
            //生单结果不为空
            if (res.creationRuleExecutorResult && res.creationRuleExecutorResult.mappingResults && res.creationRuleExecutorResult.mappingResults.length > 0) {
                args.rpcCreationRuleExecutorResult = res.creationRuleExecutorResult.ConvertToJson();
                return this.dataService.updateEntityDatas(args);
            }
            else {
                return throwError("creationRuleExecutorResult is empty!");
            }
        }
        else {
            return throwError("conditionExecutionResult is false!");
        }
    };
    /**
     * 推送任务中心
     * @param res 生单流程执行结果
     * @returns formUpdateResult 更新实体数据返回结果 @type { Observable<FormUpdateResult> }
     */
    /**
     * 推送任务中心
     * @param {?} res 生单流程执行结果
     * @return {?} formUpdateResult 更新实体数据返回结果 \@type { Observable<FormUpdateResult> }
     */
    BifManualCreationDataWebCmpService.prototype.pushTaskCenter = /**
     * 推送任务中心
     * @param {?} res 生单流程执行结果
     * @return {?} formUpdateResult 更新实体数据返回结果 \@type { Observable<FormUpdateResult> }
     */
    function (res) {
        /** @type {?} */
        var args = new PushTaskArgs();
        //Mapping执行条件判断结果为true时才会执行生单流程得到生单结果
        if (res.conditionResult.conditionExecutionResult == true) {
            //生单结果不为空
            if (res.creationRuleExecutorResult && res.creationRuleExecutorResult.mappingResults && res.creationRuleExecutorResult.mappingResults.length > 0) {
                if (res.pushCreationMode == PushCreationMode.TASKCENTER) {
                    args.suCode = res.downBillSuCode;
                    args.creationRuleExecutorResult = res.creationRuleExecutorResult;
                    return this.dataService.pushTaskCenter(args);
                }
                else {
                    return throwError("creationRuleExecutorResult can't be pushed to task center!");
                }
            }
            else {
                return throwError("creationRuleExecutorResult is empty!");
            }
        }
        else {
            return throwError("conditionExecutionResult is false!");
        }
    };
    /**
     * 查询生单结果
     * @param creationResultId 生单结果id
     */
    /**
     * 查询生单结果
     * @param {?} creationResultId 生单结果id
     * @return {?}
     */
    BifManualCreationDataWebCmpService.prototype.getCreationResultById = /**
     * 查询生单结果
     * @param {?} creationResultId 生单结果id
     * @return {?}
     */
    function (creationResultId) {
        return this.dataService.getCreationResultById(creationResultId);
    };
    /**
     * 暂存生单结果
     */
    /**
     * 暂存生单结果
     * @param {?} creationResult
     * @return {?}
     */
    BifManualCreationDataWebCmpService.prototype.addFormBillCreationProcessExecutorResult = /**
     * 暂存生单结果
     * @param {?} creationResult
     * @return {?}
     */
    function (creationResult) {
        if (creationResult == null) {
            this.messagerService.error(this.localePipe.transform("creationResultCantBeEmpty"));
            throw "参数creationResult不可为空";
        }
        if (typeof creationResult == "string") {
            if (creationResult == "") {
                this.messagerService.error(this.localePipe.transform("creationResultCantBeEmpty"));
                throw "参数creationResult不可为空";
            }
            /** @type {?} */
            var temp = new FormBillCreationProcessExecutorResult();
            temp.LoadFromJson(creationResult);
            creationResult = temp;
        }
        if ((creationResult instanceof FormBillCreationProcessExecutorResult) == false) {
            /** @type {?} */
            var res = new FormBillCreationProcessExecutorResult();
            res.LoadFromJsonObject(creationResult);
            creationResult = res;
        }
        return this.dataService.addFormBillCreationProcessExecutorResult(creationResult);
    };
    /**
     * 获取VO序列化数据
     */
    /**
     * 获取VO序列化数据
     * @param args
     * @returns
     */
    /**
       * 获取VO序列化数据
       */
    /**
     * 获取VO序列化数据
     * @param {?} dataId
     * @param {?} voId
     * @param {?} suCode
     * @return {?}
     */
    BifManualCreationDataWebCmpService.prototype.getEntityDatas = /**
       * 获取VO序列化数据
       */
    /**
     * 获取VO序列化数据
     * @param {?} dataId
     * @param {?} voId
     * @param {?} suCode
     * @return {?}
     */
    function (dataId, voId, suCode) {
        if (dataId == null) {
            this.messagerService.error(this.localePipe.transform("dataIdCantBeEmpty"));
            throw "参数dataId不可为空";
        }
        if (voId == null) {
            this.messagerService.error(this.localePipe.transform("voIdCantBeEmpty"));
            throw "参数voId不可为空";
        }
        if (suCode == null) {
            this.messagerService.error(this.localePipe.transform("suCodeCantBeEmpty"));
            throw "参数suCode不可为空";
        }
        /** @type {?} */
        var args = new GetEntityDatasArgs();
        args.dataId = dataId;
        args.suCode = suCode;
        args.voId = voId;
        return this.dataService.getEntityDatas(args);
    };
    BifManualCreationDataWebCmpService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    BifManualCreationDataWebCmpService.ctorParameters = function () { return [
        { type: BifDataService },
        { type: BindingData },
        { type: MessagerService },
        { type: ViewModel, decorators: [{ type: Optional }] },
        { type: FrameContext, decorators: [{ type: Optional }] }
    ]; };
    return BifManualCreationDataWebCmpService;
}());
export { BifManualCreationDataWebCmpService };
if (false) {
    /** @type {?} */
    BifManualCreationDataWebCmpService.prototype.localePipe;
    /** @type {?} */
    BifManualCreationDataWebCmpService.prototype.dataService;
    /** @type {?} */
    BifManualCreationDataWebCmpService.prototype.bindingData;
    /** @type {?} */
    BifManualCreationDataWebCmpService.prototype.messagerService;
    /** @type {?} */
    BifManualCreationDataWebCmpService.prototype.viewModel;
    /** @type {?} */
    BifManualCreationDataWebCmpService.prototype.frameContext;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmlmLW1hbnVhbC1jcmVhdGlvbi1kYXRhLndlYmNtcC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGVkcC1iaWYvcnVudGltZS1hcGkvIiwic291cmNlcyI6WyJsaWIvd2ViY21wL2JpZi1tYW51YWwtY3JlYXRpb24tZGF0YS53ZWJjbXAuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBYyxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFOUMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBR3RELE9BQU8sRUFBVSxXQUFXLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzlFLE9BQU8sRUFBRSxtQ0FBbUMsRUFBRSxNQUFNLHlEQUF5RCxDQUFDO0FBQzlHLE9BQU8sRUFBRSxxQ0FBcUMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzdFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxpREFBaUQsQ0FBQztBQUNqRixPQUFPLEVBQUUsY0FBYyxFQUFzQyxjQUFjLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDNUYsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRXZELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGdEQUFnRCxDQUFDO0FBQ3BGLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBQzVFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQUNyRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQzs7OztBQUt0RDtJQUlFLDRDQUNTLFdBQTJCLEVBQzNCLFdBQXdCLEVBQ3hCLGVBQWdD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LENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQztZQUMzRSxNQUFNLGNBQWMsQ0FBQztTQUN0Qjs7WUFDSyxJQUFJLEdBQUcsSUFBSSxrQkFBa0IsRUFBRTtRQUNyQyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUVqQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9DLENBQUM7O2dCQWhNRixVQUFVOzs7O2dCQWJGLGNBQWM7Z0JBTE4sV0FBVztnQkFIbkIsZUFBZTtnQkFHTSxTQUFTLHVCQTBCbEMsUUFBUTtnQkExQjRCLFlBQVksdUJBMkJoRCxRQUFROztJQXdMYix5Q0FBQztDQUFBLEFBak1ELElBaU1DO1NBaE1ZLGtDQUFrQzs7O0lBQzdDLHdEQUE4Qjs7SUFHNUIseURBQWtDOztJQUNsQyx5REFBK0I7O0lBQy9CLDZEQUF1Qzs7SUFDdkMsdURBQXVDOztJQUN2QywwREFBNkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQgeyBNZXNzYWdlclNlcnZpY2UgfSBmcm9tIFwiQGZhcnJpcy91aS1tZXNzYWdlclwiO1xyXG5pbXBvcnQgeyBNb2RhbE9wdGlvbnMgfSBmcm9tICdAZmFycmlzL3VpLW1vZGFsJztcclxuXHJcbmltcG9ydCB7IEVudGl0eSwgQmluZGluZ0RhdGEsIFZpZXdNb2RlbCwgRnJhbWVDb250ZXh0IH0gZnJvbSBcIkBmYXJyaXMvZGV2a2l0XCI7XHJcblxyXG5pbXBvcnQgeyBJUnRTbGltQmlsbENyZWF0aW9uUHJvY2Vzc0VudGl0eUV4LCBGb3JtU2V0dGluZ3MgfSBmcm9tIFwiQGVkcC1iaWYvY29tbW9uLWFwaVwiO1xyXG5pbXBvcnQgeyBGb3JtQmlsbENyZWF0aW9uUHJvY2Vzc0V4ZWN1dG9yQXJncyB9IGZyb20gJy4uL2VudGl0eS9mb3JtLXJlc3QvRm9ybUJpbGxDcmVhdGlvblByb2Nlc3NFeGVjdXRvckFyZ3MnO1xyXG5pbXBvcnQgeyBGb3JtQmlsbENyZWF0aW9uUHJvY2Vzc0V4ZWN1dG9yUmVzdWx0IH0gZnJvbSAnQGVkcC1haWYvcnVudGltZS1hcGknO1xyXG5pbXBvcnQgeyBCaWZEYXRhU2VydmljZSB9IGZyb20gJy4uL2JpZi1tYW51YWwtY3JlYXRpb24vc2VydmljZS9iaWYtZGF0YS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRm9ybUNyZWF0ZUFyZ3MsIEZvcm1DcmVhdGVSZXN1bHQsIEZvcm1VcGRhdGVSZXN1bHQsIEZvcm1VcGRhdGVBcmdzIH0gZnJvbSAnLi4vcmVmJztcclxuaW1wb3J0IHsgUHVzaFRhc2tBcmdzIH0gZnJvbSAnLi4vYmlmLW1hbnVhbC1jcmVhdGlvbi9hcmdzL1B1c2hUYXNrQXJncyc7XHJcbmltcG9ydCB7IFB1c2hDcmVhdGlvbk1vZGUgfSBmcm9tICdAZWRwLWFpZi9jb21tb24tYXBpJztcclxuaW1wb3J0IHsgR2VuZXJhbFRleHRJZFdpdGhEYXRhSWQgfSBmcm9tICcuLi9lbnRpdHkvZm9ybS1yZXN0L0dlbmVyYWxUZXh0SWRXaXRoRGF0YUlkJztcclxuaW1wb3J0IHsgR2V0RW50aXR5RGF0YXNBcmdzIH0gZnJvbSAnLi4vYmlmLW1hbnVhbC1jcmVhdGlvbi9hcmdzL0dldEVudGl0eURhdGFzQXJncyc7XHJcbmltcG9ydCB7IE1hbnVhbENyZWF0aW9uTW9kZSB9IGZyb20gJy4uL2VudGl0eS9mb3JtLXJlc3QvTWFudWFsQ3JlYXRpb25Nb2RlJztcclxuaW1wb3J0IHsgTG9jYWxlUGlwZSB9IGZyb20gJy4uL2JpZi1tYW51YWwtY3JlYXRpb24vcGlwZS9sb2NhbGUucGlwZSc7XHJcbmltcG9ydCB7IEVudGl0eVBhcmFtVXRpbHMgfSBmcm9tICcuL0VudGl0eVBhcmFtVXRpbHMnO1xyXG5cclxuLyoqXHJcbiAqIOaJi+W3peeUn+WNleaVsOaNruacjeWKoeexu1xyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQmlmTWFudWFsQ3JlYXRpb25EYXRhV2ViQ21wU2VydmljZSB7XHJcbiAgcHVibGljIGxvY2FsZVBpcGU6IExvY2FsZVBpcGU7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHVibGljIGRhdGFTZXJ2aWNlOiBCaWZEYXRhU2VydmljZSxcclxuICAgIHB1YmxpYyBiaW5kaW5nRGF0YTogQmluZGluZ0RhdGEsXHJcbiAgICBwdWJsaWMgbWVzc2FnZXJTZXJ2aWNlOiBNZXNzYWdlclNlcnZpY2UsXHJcbiAgICBAT3B0aW9uYWwoKSBwdWJsaWMgdmlld01vZGVsOiBWaWV3TW9kZWwsXHJcbiAgICBAT3B0aW9uYWwoKSBwdWJsaWMgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXHJcbiAgKSB7XHJcbiAgICB0aGlzLmxvY2FsZVBpcGUgPSBuZXcgTG9jYWxlUGlwZSh0aGlzLmRhdGFTZXJ2aWNlICYmIHRoaXMuZGF0YVNlcnZpY2UubG9jYWxlSWQgfHwgJ3poLUNIUycpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2u55Sf5Y2V5rWB56iLSWTmn6Xmib7mjIflrprnmoTnlJ/ljZXmtYHnqItcclxuICAgKiBAcGFyYW0gcHJvY2Vzc0lkIOWNleaNrua1geeUn+WNlea1geeoiyBJZFxyXG4gICAqIEByZXR1cm5zIGNyZWF0aW9uUHJvY2VzcyDnlJ/ljZXmtYHnqIsgQHR5cGUgeyBPYnNlcnZhYmxlPElSdFNsaW1CaWxsQ3JlYXRpb25Qcm9jZXNzRW50aXR5RXg+IH1cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0U2xpbUJpbGxDcmVhdGlvblByb2Nlc3NFbnRpdHlFeEJ5SWQocHJvY2Vzc0lkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPElSdFNsaW1CaWxsQ3JlYXRpb25Qcm9jZXNzRW50aXR5RXg+IHtcclxuICAgIGlmIChwcm9jZXNzSWQgPT0gbnVsbCB8fCBwcm9jZXNzSWQgPT0gXCJcIiB8fCBwcm9jZXNzSWQudHJpbSgpID09IFwiXCIpIHtcclxuICAgICAgdGhpcy5tZXNzYWdlclNlcnZpY2UuZXJyb3IodGhpcy5sb2NhbGVQaXBlLnRyYW5zZm9ybShcInByb2Nlc3NJZENhbnRCZUVtcHR5XCIpKTtcclxuICAgICAgdGhyb3cgXCLlj4LmlbBwcm9jZXNzSWTkuI3lj6/kuLrnqbpcIjtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLmRhdGFTZXJ2aWNlLmdldFNsaW1CaWxsQ3JlYXRpb25Qcm9jZXNzRW50aXR5RXhCeUlkKHByb2Nlc3NJZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmn6Xor6LooajljZXphY3nva5cclxuICAgKiBAcGFyYW0gZm9ybVNldHRpbmdzSWQg6KGo5Y2V6YWN572uSWRcclxuICAgKiBAcmV0dXJucyBmb3JtU2V0dGluZ3Mg6KGo5Y2V6YWN572uIEB0eXBlIHsgT2JzZXJ2YWJsZTxGb3JtU2V0dGluZ3M+IH1cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0Rm9ybVNldHRpbmdzQnlJZChmb3JtU2V0dGluZ3NJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxGb3JtU2V0dGluZ3M+IHtcclxuICAgIHJldHVybiB0aGlzLmRhdGFTZXJ2aWNlLmdldEZvcm1TZXR0aW5nc0J5SWQoZm9ybVNldHRpbmdzSWQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5omn6KGM55Sf5Y2V5rWB56iLXHJcbiAgICogQHBhcmFtIGVudGl0aWVzIOWPguS4jueUn+WNleeahOS4iua4uOWNleaNrklE5YiX6KGo5oiW5a6e5L2T5YiX6KGoXHJcbiAgICogQHBhcmFtIGNyZWF0aW9uUHJvY2Vzc0lkIOWNleaNrua1geeUn+WNlea1geeoiyBJZFxyXG4gICAqIEBwYXJhbSBjcmVhdGlvblJ1bGVJZCDnlJ/ljZXop4TliJlJZO+8iOeUn+WNlea1geeoi+WunuS9k+S4reiusOW9le+8iVxyXG4gICAqIEByZXR1cm5zIGNyZWF0aW9uUmVzdWx0IOeUn+WNlee7k+aenCBAdHlwZSB7IE9ic2VydmFibGU8Rm9ybUJpbGxDcmVhdGlvblByb2Nlc3NFeGVjdXRvclJlc3VsdD4gfVxyXG4gICAqL1xyXG4gIHB1YmxpYyBleGVjdXRlQmlsbENyZWF0aW9uUHJvY2VzcyhlbnRpdGllczogRW50aXR5W10sIGNyZWF0aW9uUHJvY2Vzc0lkOiBzdHJpbmcsIGNyZWF0aW9uUnVsZUlkOiBzdHJpbmcsIHRhcmdldERhdGFJZHM6IHN0cmluZ1tdLCBtYW51YWxDcmVhdGlvbk1vZGU6IE1hbnVhbENyZWF0aW9uTW9kZSk6IE9ic2VydmFibGU8Rm9ybUJpbGxDcmVhdGlvblByb2Nlc3NFeGVjdXRvclJlc3VsdD4ge1xyXG4gICAgaWYgKGVudGl0aWVzID09IG51bGwgfHwgKGVudGl0aWVzIGFzIGFueSkgPT0gXCJcIikge1xyXG4gICAgICB0aGlzLm1lc3NhZ2VyU2VydmljZS5lcnJvcih0aGlzLmxvY2FsZVBpcGUudHJhbnNmb3JtKFwiZW50aXRpZXNDYW50QmVFbXB0eVwiKSk7XHJcbiAgICAgIHRocm93IFwi5Y+C5pWwZW50aXRpZXPkuI3lj6/kuLrnqbpcIjtcclxuICAgIH1cclxuICAgIGlmIChlbnRpdGllcyBpbnN0YW5jZW9mIE1hcCkge1xyXG4gICAgICBlbnRpdGllcyA9IEFycmF5LmZyb20oZW50aXRpZXMudmFsdWVzKCkpO1xyXG4gICAgfVxyXG4gICAgZW50aXRpZXMgPSBBcnJheS5pc0FycmF5KGVudGl0aWVzKSA/IGVudGl0aWVzIDogW2VudGl0aWVzXTtcclxuICAgIG1hbnVhbENyZWF0aW9uTW9kZSA9IG1hbnVhbENyZWF0aW9uTW9kZSA/IG1hbnVhbENyZWF0aW9uTW9kZSA6IE1hbnVhbENyZWF0aW9uTW9kZS5QdXNoO1xyXG5cclxuICAgIGNvbnN0IHsgc291cmNlVm9FbnRpdHlEYXRhcywgc291cmNlVm9FbnRpdHlEYXRhSWRzIH0gPSBFbnRpdHlQYXJhbVV0aWxzLmJ1aWxkU291cmNlVm9FbnRpdHlEYXRhKGVudGl0aWVzKTtcclxuXHJcbiAgICAvL+WIm+W7uuaJp+ihjOeUn+WNlea1geeoi+WPguaVsOWvueixoVxyXG4gICAgY29uc3QgYXJncyA9IG5ldyBGb3JtQmlsbENyZWF0aW9uUHJvY2Vzc0V4ZWN1dG9yQXJncygpO1xyXG4gICAgYXJncy5iaWxsQ3JlYXRpb25Qcm9jZXNzSWQgPSBjcmVhdGlvblByb2Nlc3NJZDtcclxuICAgIGFyZ3MuY3JlYXRpb25SdWxlSWQgPSBjcmVhdGlvblJ1bGVJZDtcclxuICAgIC8vRm9ybUNyZWF0aW9uUnVsZUV4ZWN1dG9yQXJnc+eahHNvdXJjZVZvRW50aXR5RGF0YXPlsZ7mgKfkuLrliY3nq6/lrp7kvZPluo/liJfljJblkI7nmoTlrZfnrKbkuLLliJfooahcclxuICAgIC8vc291cmNlVm9FbnRpdHlEYXRhc+WIl+ihqOS4reeahOavj+S4quWtl+espuS4su+8jOWcqOe7k+aehOS4iuW6lOS4juWNleaNrua1geWumuS5ieS4reaJgOmAieS4reeahOS4iua4uOinhuWbvuWvueixoeS4gOiHtOOAglxyXG4gICAgYXJncy5zb3VyY2VWb0VudGl0eURhdGFzID0gc291cmNlVm9FbnRpdHlEYXRhcztcclxuICAgIGFyZ3Muc291cmNlVm9FbnRpdHlEYXRhSWRzID0gc291cmNlVm9FbnRpdHlEYXRhSWRzO1xyXG4gICAgLy/kuIvmjqjov4fnqIvkuK3kuI3lrZjlnKjnm67moIfkuLvooajljZXmja5JZO+8jOaJgOS7pXRhcmdldFZvRGF0YUlkc+S4uuepuuWIl+ihqOOAglxyXG4gICAgYXJncy50YXJnZXRWb0RhdGFJZHMgPSB0YXJnZXREYXRhSWRzO1xyXG4gICAgYXJncy5tYW51YWxDcmVhdGlvbk1vZGUgPSBtYW51YWxDcmVhdGlvbk1vZGU7XHJcbiAgICByZXR1cm4gdGhpcy5kYXRhU2VydmljZS5leGVjdXRlQmlsbENyZWF0aW9uUHJvY2VzcyhhcmdzKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIm+W7uuWunuS9k+aVsOaNru+8iFJldHJpZXZlRGVmYXVsdOiHs+e8k+WtmO+8iVxyXG4gICAqIEBwYXJhbSBmb3JtVm9JZCDooajljZXnu5HlrppWTyBJZFxyXG4gICAqIEBwYXJhbSByZXMg55Sf5Y2V5rWB56iL5omn6KGM57uT5p6cXHJcbiAgICogQHJldHVybnMgZm9ybUNyZWF0ZVJlc3VsdCDliJvlu7rlrp7kvZPmlbDmja7ov5Tlm57nu5PmnpwgQHR5cGUgeyBPYnNlcnZhYmxlPEZvcm1DcmVhdGVSZXN1bHQ+IH1cclxuICAgKi9cclxuICBwdWJsaWMgY3JlYXRlRW50aXR5RGF0YXMoZm9ybVZvSWQ6IHN0cmluZywgcmVzOiBGb3JtQmlsbENyZWF0aW9uUHJvY2Vzc0V4ZWN1dG9yUmVzdWx0KTogT2JzZXJ2YWJsZTxGb3JtQ3JlYXRlUmVzdWx0PiB7XHJcbiAgICBjb25zdCBhcmdzID0gbmV3IEZvcm1DcmVhdGVBcmdzKCk7XHJcbiAgICBhcmdzLmZvcm1Wb0lkID0gZm9ybVZvSWQ7XHJcbiAgICAvL+iOt+WPlueUn+WNlea1geeoi+aJp+ihjOe7k+aenFxyXG4gICAgYXJncy5ycGNDcmVhdGlvblJ1bGVFeGVjdXRvclJlc3VsdCA9IHJlcy5jcmVhdGlvblJ1bGVFeGVjdXRvclJlc3VsdC5Db252ZXJ0VG9Kc29uKCk7XHJcbiAgICAvL+WIm+W7uuWunuS9k+aVsOaNrlxyXG4gICAgcmV0dXJuIHRoaXMuZGF0YVNlcnZpY2UuY3JlYXRlRW50aXR5RGF0YXMoYXJncyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmm7TmlrDlrp7kvZPmlbDmja5cclxuICAgKiBAcGFyYW0gcmVzIOeUn+WNlea1geeoi+aJp+ihjOe7k+aenFxyXG4gICAqIEByZXR1cm5zIGZvcm1VcGRhdGVSZXN1bHQg5pu05paw5a6e5L2T5pWw5o2u6L+U5Zue57uT5p6cIEB0eXBlIHsgT2JzZXJ2YWJsZTxGb3JtVXBkYXRlUmVzdWx0PiB9XHJcbiAgICovXHJcbiAgcHVibGljIHVwZGF0ZUVudGl0eURhdGFzKHJlczogRm9ybUJpbGxDcmVhdGlvblByb2Nlc3NFeGVjdXRvclJlc3VsdCk6IE9ic2VydmFibGU8Rm9ybVVwZGF0ZVJlc3VsdD4ge1xyXG4gICAgY29uc3QgYXJncyA9IG5ldyBGb3JtVXBkYXRlQXJncygpO1xyXG4gICAgLy9NYXBwaW5n5omn6KGM5p2h5Lu25Yik5pat57uT5p6c5Li6dHJ1ZeaXtuaJjeS8muaJp+ihjOeUn+WNlea1geeoi+W+l+WIsOeUn+WNlee7k+aenFxyXG4gICAgaWYgKHJlcy5jb25kaXRpb25SZXN1bHQuY29uZGl0aW9uRXhlY3V0aW9uUmVzdWx0ID09IHRydWUpIHtcclxuICAgICAgLy/nlJ/ljZXnu5PmnpzkuI3kuLrnqbpcclxuICAgICAgaWYgKHJlcy5jcmVhdGlvblJ1bGVFeGVjdXRvclJlc3VsdCAmJiByZXMuY3JlYXRpb25SdWxlRXhlY3V0b3JSZXN1bHQubWFwcGluZ1Jlc3VsdHMgJiYgcmVzLmNyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0Lm1hcHBpbmdSZXN1bHRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBhcmdzLnJwY0NyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0ID0gcmVzLmNyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0LkNvbnZlcnRUb0pzb24oKTtcclxuICAgICAgICByZXR1cm4gdGhpcy5kYXRhU2VydmljZS51cGRhdGVFbnRpdHlEYXRhcyhhcmdzKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihcImNyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0IGlzIGVtcHR5IVwiKVxyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdGhyb3dFcnJvcihcImNvbmRpdGlvbkV4ZWN1dGlvblJlc3VsdCBpcyBmYWxzZSFcIilcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaOqOmAgeS7u+WKoeS4reW/g1xyXG4gICAqIEBwYXJhbSByZXMg55Sf5Y2V5rWB56iL5omn6KGM57uT5p6cXHJcbiAgICogQHJldHVybnMgZm9ybVVwZGF0ZVJlc3VsdCDmm7TmlrDlrp7kvZPmlbDmja7ov5Tlm57nu5PmnpwgQHR5cGUgeyBPYnNlcnZhYmxlPEZvcm1VcGRhdGVSZXN1bHQ+IH1cclxuICAgKi9cclxuICBwdWJsaWMgcHVzaFRhc2tDZW50ZXIocmVzOiBGb3JtQmlsbENyZWF0aW9uUHJvY2Vzc0V4ZWN1dG9yUmVzdWx0KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IGFyZ3MgPSBuZXcgUHVzaFRhc2tBcmdzKCk7XHJcbiAgICAvL01hcHBpbmfmiafooYzmnaHku7bliKTmlq3nu5PmnpzkuLp0cnVl5pe25omN5Lya5omn6KGM55Sf5Y2V5rWB56iL5b6X5Yiw55Sf5Y2V57uT5p6cXHJcbiAgICBpZiAocmVzLmNvbmRpdGlvblJlc3VsdC5jb25kaXRpb25FeGVjdXRpb25SZXN1bHQgPT0gdHJ1ZSkge1xyXG4gICAgICAvL+eUn+WNlee7k+aenOS4jeS4uuepulxyXG4gICAgICBpZiAocmVzLmNyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0ICYmIHJlcy5jcmVhdGlvblJ1bGVFeGVjdXRvclJlc3VsdC5tYXBwaW5nUmVzdWx0cyAmJiByZXMuY3JlYXRpb25SdWxlRXhlY3V0b3JSZXN1bHQubWFwcGluZ1Jlc3VsdHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGlmIChyZXMucHVzaENyZWF0aW9uTW9kZSA9PSBQdXNoQ3JlYXRpb25Nb2RlLlRBU0tDRU5URVIpIHtcclxuICAgICAgICAgIGFyZ3Muc3VDb2RlID0gcmVzLmRvd25CaWxsU3VDb2RlO1xyXG4gICAgICAgICAgYXJncy5jcmVhdGlvblJ1bGVFeGVjdXRvclJlc3VsdCA9IHJlcy5jcmVhdGlvblJ1bGVFeGVjdXRvclJlc3VsdDtcclxuICAgICAgICAgIHJldHVybiB0aGlzLmRhdGFTZXJ2aWNlLnB1c2hUYXNrQ2VudGVyKGFyZ3MpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihcImNyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0IGNhbid0IGJlIHB1c2hlZCB0byB0YXNrIGNlbnRlciFcIilcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoXCJjcmVhdGlvblJ1bGVFeGVjdXRvclJlc3VsdCBpcyBlbXB0eSFcIilcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHRocm93RXJyb3IoXCJjb25kaXRpb25FeGVjdXRpb25SZXN1bHQgaXMgZmFsc2UhXCIpXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmn6Xor6LnlJ/ljZXnu5PmnpxcclxuICAgKiBAcGFyYW0gY3JlYXRpb25SZXN1bHRJZCDnlJ/ljZXnu5PmnpxpZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRDcmVhdGlvblJlc3VsdEJ5SWQoY3JlYXRpb25SZXN1bHRJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxGb3JtQmlsbENyZWF0aW9uUHJvY2Vzc0V4ZWN1dG9yUmVzdWx0PiB7XHJcbiAgICByZXR1cm4gdGhpcy5kYXRhU2VydmljZS5nZXRDcmVhdGlvblJlc3VsdEJ5SWQoY3JlYXRpb25SZXN1bHRJZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmmoLlrZjnlJ/ljZXnu5PmnpxcclxuICAgKi9cclxuICBwdWJsaWMgYWRkRm9ybUJpbGxDcmVhdGlvblByb2Nlc3NFeGVjdXRvclJlc3VsdChjcmVhdGlvblJlc3VsdDogRm9ybUJpbGxDcmVhdGlvblByb2Nlc3NFeGVjdXRvclJlc3VsdCk6IE9ic2VydmFibGU8R2VuZXJhbFRleHRJZFdpdGhEYXRhSWRbXT4ge1xyXG4gICAgaWYgKGNyZWF0aW9uUmVzdWx0ID09IG51bGwpIHtcclxuICAgICAgdGhpcy5tZXNzYWdlclNlcnZpY2UuZXJyb3IodGhpcy5sb2NhbGVQaXBlLnRyYW5zZm9ybShcImNyZWF0aW9uUmVzdWx0Q2FudEJlRW1wdHlcIikpO1xyXG4gICAgICB0aHJvdyBcIuWPguaVsGNyZWF0aW9uUmVzdWx05LiN5Y+v5Li656m6XCI7XHJcbiAgICB9XHJcbiAgICBpZiAodHlwZW9mIGNyZWF0aW9uUmVzdWx0ID09IFwic3RyaW5nXCIpIHtcclxuICAgICAgaWYgKGNyZWF0aW9uUmVzdWx0ID09IFwiXCIpIHtcclxuICAgICAgICB0aGlzLm1lc3NhZ2VyU2VydmljZS5lcnJvcih0aGlzLmxvY2FsZVBpcGUudHJhbnNmb3JtKFwiY3JlYXRpb25SZXN1bHRDYW50QmVFbXB0eVwiKSk7XHJcbiAgICAgICAgdGhyb3cgXCLlj4LmlbBjcmVhdGlvblJlc3VsdOS4jeWPr+S4uuepulwiO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IHRlbXAgPSBuZXcgRm9ybUJpbGxDcmVhdGlvblByb2Nlc3NFeGVjdXRvclJlc3VsdCgpO1xyXG4gICAgICB0ZW1wLkxvYWRGcm9tSnNvbihjcmVhdGlvblJlc3VsdCk7XHJcbiAgICAgIGNyZWF0aW9uUmVzdWx0ID0gdGVtcDtcclxuICAgIH1cclxuICAgIGlmICgoY3JlYXRpb25SZXN1bHQgaW5zdGFuY2VvZiBGb3JtQmlsbENyZWF0aW9uUHJvY2Vzc0V4ZWN1dG9yUmVzdWx0KSA9PSBmYWxzZSkge1xyXG4gICAgICBjb25zdCByZXMgPSBuZXcgRm9ybUJpbGxDcmVhdGlvblByb2Nlc3NFeGVjdXRvclJlc3VsdCgpO1xyXG4gICAgICByZXMuTG9hZEZyb21Kc29uT2JqZWN0KGNyZWF0aW9uUmVzdWx0KTtcclxuICAgICAgY3JlYXRpb25SZXN1bHQgPSByZXM7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5kYXRhU2VydmljZS5hZGRGb3JtQmlsbENyZWF0aW9uUHJvY2Vzc0V4ZWN1dG9yUmVzdWx0KGNyZWF0aW9uUmVzdWx0KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPllZP5bqP5YiX5YyW5pWw5o2uXHJcbiAgICovXHJcbiAgLyoqXHJcbiAgICog6I635Y+WVk/luo/liJfljJbmlbDmja5cclxuICAgKiBAcGFyYW0gYXJnc1xyXG4gICAqIEByZXR1cm5zXHJcbiAgICovXHJcbiAgcHVibGljIGdldEVudGl0eURhdGFzKGRhdGFJZDogc3RyaW5nLCB2b0lkOiBzdHJpbmcsIHN1Q29kZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcclxuICAgIGlmIChkYXRhSWQgPT0gbnVsbCkge1xyXG4gICAgICB0aGlzLm1lc3NhZ2VyU2VydmljZS5lcnJvcih0aGlzLmxvY2FsZVBpcGUudHJhbnNmb3JtKFwiZGF0YUlkQ2FudEJlRW1wdHlcIikpO1xyXG4gICAgICB0aHJvdyBcIuWPguaVsGRhdGFJZOS4jeWPr+S4uuepulwiO1xyXG4gICAgfVxyXG4gICAgaWYgKHZvSWQgPT0gbnVsbCkge1xyXG4gICAgICB0aGlzLm1lc3NhZ2VyU2VydmljZS5lcnJvcih0aGlzLmxvY2FsZVBpcGUudHJhbnNmb3JtKFwidm9JZENhbnRCZUVtcHR5XCIpKTtcclxuICAgICAgdGhyb3cgXCLlj4LmlbB2b0lk5LiN5Y+v5Li656m6XCI7XHJcbiAgICB9XHJcbiAgICBpZiAoc3VDb2RlID09IG51bGwpIHtcclxuICAgICAgdGhpcy5tZXNzYWdlclNlcnZpY2UuZXJyb3IodGhpcy5sb2NhbGVQaXBlLnRyYW5zZm9ybShcInN1Q29kZUNhbnRCZUVtcHR5XCIpKTtcclxuICAgICAgdGhyb3cgXCLlj4LmlbBzdUNvZGXkuI3lj6/kuLrnqbpcIjtcclxuICAgIH1cclxuICAgIGNvbnN0IGFyZ3MgPSBuZXcgR2V0RW50aXR5RGF0YXNBcmdzKCk7XHJcbiAgICBhcmdzLmRhdGFJZCA9IGRhdGFJZDtcclxuICAgIGFyZ3Muc3VDb2RlID0gc3VDb2RlO1xyXG4gICAgYXJncy52b0lkID0gdm9JZDtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5kYXRhU2VydmljZS5nZXRFbnRpdHlEYXRhcyhhcmdzKTtcclxuICB9XHJcbn1cclxuIl19