/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ComponentFactoryResolver, EventEmitter, Injector, Output } from '@angular/core';
import { BsModalService } from '@farris/ui-modal';
import { NotifyService } from '@farris/ui-notify';
export class ModalPropertyComponent {
    /**
     * @param {?} notifyServ
     * @param {?} resolver
     * @param {?} modalService
     * @param {?} injector
     */
    constructor(notifyServ, resolver, modalService, injector) {
        this.notifyServ = notifyServ;
        this.resolver = resolver;
        this.modalService = modalService;
        this.injector = injector;
        this.valueChanged = new EventEmitter();
        this.submitModal = new EventEmitter();
        this.showClearButton = false;
    }
    /**
     * @return {?}
     */
    get elementConfig() {
        return this._elementConfig;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set elementConfig(value) {
        this._elementConfig = value;
        this.convertModalShowValue(this._elementValue);
        this.showClearButton = this.elementConfig.showClearButton && !this.elementConfig.readonly;
    }
    /**
     * @return {?}
     */
    get elementValue() {
        return this._elementValue;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set elementValue(value) {
        this._elementValue = value;
        this.convertModalShowValue(this._elementValue);
    }
    /**
     * @return {?}
     */
    ngOnInit() {
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    changeValue($event) {
        this.valueChanged.next({ $event, elementValue: this.elementValue });
    }
    /**
     * 清除模态框内容
     * @return {?}
     */
    modalClear() {
        // 数据转换
        this.convertModalShowValue(null);
        // 若有清除后事件，先执行方法
        if (Object.keys(this.elementConfig).indexOf('afterClickClearButton') > -1 &&
            typeof (this.elementConfig.afterClickClearButton) === 'function') {
            this.elementConfig.afterClickClearButton(this.elementValue);
        }
        this.valueChanged.next({ elementValue: null });
    }
    /**
     * 模态框场景下将属性值转换为输入框中显示的值
     * @private
     * @param {?} value 属性值
     * @return {?}
     */
    convertModalShowValue(value) {
        if (this.elementConfig.converter) {
            this.elementShowValue = this.elementConfig.converter.convertTo(value);
            return;
        }
        if (value && value instanceof Object) {
            this.elementShowValue = JSON.stringify(value);
            return;
        }
        this.elementShowValue = value;
    }
    /**
     * 自定义编辑器使用模态框打开
     * @return {?}
     */
    openModal() {
        if (this.elementConfig.readonly) {
            return;
        }
        if (Object.keys(this.elementConfig).indexOf('beforeOpenModal') > -1 && typeof (this.elementConfig.beforeOpenModal) === 'function') {
            /** @type {?} */
            const result = this.elementConfig.beforeOpenModal();
            if (result && !result.result) {
                this.notifyServ.warning(result.message);
                return;
            }
        }
        this.createEditorComponent();
    }
    /**
     * 创建自定义编辑器
     * @private
     * @return {?}
     */
    createEditorComponent() {
        /** @type {?} */
        const editor = this.elementConfig.editor;
        if (!editor) {
            return;
        }
        // 创建模态框组件
        /** @type {?} */
        const compFactory = this.resolver.resolveComponentFactory(editor);
        /** @type {?} */
        const compRef = compFactory.create(this.injector);
        compRef.instance.value = this.elementValue;
        // 编辑器需要的额外参数
        compRef.instance.editorParams = this.elementConfig.editorParams;
        /** @type {?} */
        let modalConfig = compRef.instance.modalConfig;
        if (!modalConfig) {
            modalConfig = {
                title: '属性配置',
                width: 800,
                height: 400,
                showButtons: false
            };
        }
        else if (modalConfig.showButtons) {
            modalConfig.buttons = compRef.instance.modalFooter;
        }
        /** @type {?} */
        const dialog = this.modalService.show(compRef, modalConfig);
        // 监听关闭模态框
        if (compRef.instance.closeModal && compRef.instance.closeModal instanceof EventEmitter) {
            compRef.instance.closeModal.subscribe((/**
             * @param {?} data
             * @return {?}
             */
            (data) => {
                // 数据转换
                if (data) {
                    this.convertModalShowValue(data);
                    this.valueChanged.next({ elementValue: data });
                }
                dialog.close();
            }));
        }
        // 弹出框关闭事件，带参数，格式为{ value, parameters }
        if (compRef.instance.submitModal && compRef.instance.submitModal instanceof EventEmitter) {
            compRef.instance.submitModal.subscribe((/**
             * @param {?} data
             * @return {?}
             */
            data => {
                if (!data) {
                    dialog.close();
                    return;
                }
                const { value, parameters } = data;
                // 数据转换
                this.convertModalShowValue(value);
                this.submitModal.next({ elementValue: value, parameters });
                dialog.close();
            }));
        }
    }
}
ModalPropertyComponent.decorators = [
    { type: Component, args: [{
                selector: 'app-modal-prop',
                template: `
    <div class="farris-input-wrap modalIcon">
        <input type="input" class="form-control form-control-sm" [(ngModel)]="elementShowValue" readonly>
        <span [class.allowClear]="showClearButton" class="showClearButton" (click)="modalClear()">
            <i class="material-icons clearIcon">close</i>
        </span>
        <i class="material-icons moreIcon" (click)="openModal()">filter_none</i>
    </div>
    `,
                styles: [`
        .modalIcon .showClearButton {
            display: none;
        }
        .modalIcon:hover .allowClear.showClearButton {
            display: block;
        }
        .modalIcon input {
            padding-right: 30px;
        }
        .modalIcon .moreIcon {
            position: absolute;
            top: 6px;
            right: 6px;
            cursor: pointer;
            font-size: 16px;
            color: #758a96;
        }
        .modalIcon .clearIcon {
            position: absolute;
            top: 5px;
            right: 30px;
            cursor: pointer;
            font-size: 19px;
            color: #758a96;
        }
        `]
            }] }
];
/** @nocollapse */
ModalPropertyComponent.ctorParameters = () => [
    { type: NotifyService },
    { type: ComponentFactoryResolver },
    { type: BsModalService },
    { type: Injector }
];
ModalPropertyComponent.propDecorators = {
    valueChanged: [{ type: Output }],
    submitModal: [{ type: Output }]
};
if (false) {
    /** @type {?} */
    ModalPropertyComponent.prototype.valueChanged;
    /** @type {?} */
    ModalPropertyComponent.prototype.submitModal;
    /**
     * @type {?}
     * @private
     */
    ModalPropertyComponent.prototype._elementConfig;
    /**
     * @type {?}
     * @private
     */
    ModalPropertyComponent.prototype._elementValue;
    /**
     * 输入框中显示的值
     * @type {?}
     */
    ModalPropertyComponent.prototype.elementShowValue;
    /** @type {?} */
    ModalPropertyComponent.prototype.showClearButton;
    /**
     * @type {?}
     * @private
     */
    ModalPropertyComponent.prototype.notifyServ;
    /**
     * @type {?}
     * @private
     */
    ModalPropertyComponent.prototype.resolver;
    /**
     * @type {?}
     * @private
     */
    ModalPropertyComponent.prototype.modalService;
    /**
     * @type {?}
     * @private
     */
    ModalPropertyComponent.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kYWwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9pZGUtcHJvcGVydHktcGFuZWwvIiwic291cmNlcyI6WyJsaWIvcHJvcGVydHktcGFuZWwvY29udHJvbHMvbW9kYWwuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLHdCQUF3QixFQUFFLFlBQVksRUFBRSxRQUFRLEVBQTRCLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM5SCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDbEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBNENsRCxNQUFNLE9BQU8sc0JBQXNCOzs7Ozs7O0lBbUMvQixZQUNZLFVBQXlCLEVBQ3pCLFFBQWtDLEVBQ2xDLFlBQTRCLEVBQzVCLFFBQWtCO1FBSGxCLGVBQVUsR0FBVixVQUFVLENBQWU7UUFDekIsYUFBUSxHQUFSLFFBQVEsQ0FBMEI7UUFDbEMsaUJBQVksR0FBWixZQUFZLENBQWdCO1FBQzVCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFwQ3BCLGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUN2QyxnQkFBVyxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFTaEQsb0JBQWUsR0FBRyxLQUFLLENBQUM7SUEwQlUsQ0FBQzs7OztJQXpCbkMsSUFBSSxhQUFhO1FBQ2IsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDO0lBQy9CLENBQUM7Ozs7O0lBRUQsSUFBSSxhQUFhLENBQUMsS0FBSztRQUNuQixJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQztRQUU1QixJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRS9DLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLElBQUksQ0FBQyxJQUFJLENBQUMs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UUFBUSxDQUFDLFdBQVcsQ0FBQyxTQUFTOzs7O1lBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQzFDLElBQUksQ0FBQyxJQUFJLEVBQUU7b0JBQ1AsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO29CQUNmLE9BQU87aUJBQ1Y7c0JBQ0ssRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLEdBQUcsSUFBSTtnQkFDbEMsT0FBTztnQkFDUCxJQUFJLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBRWxDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO2dCQUUzRCxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDbkIsQ0FBQyxFQUFDLENBQUM7U0FDTjtJQUVMLENBQUM7OztZQXhNSixTQUFTLFNBQUM7Z0JBQ1AsUUFBUSxFQUFFLGdCQUFnQjtnQkFDMUIsUUFBUSxFQUFFOzs7Ozs7OztLQVFUO3lCQUVHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztTQTBCQzthQUVSOzs7O1lBM0NRLGFBQWE7WUFGRix3QkFBd0I7WUFDbkMsY0FBYztZQURxQyxRQUFROzs7MkJBaUQvRCxNQUFNOzBCQUNOLE1BQU07Ozs7SUFEUCw4Q0FBaUQ7O0lBQ2pELDZDQUFnRDs7Ozs7SUFFaEQsZ0RBQXVDOzs7OztJQUN2QywrQ0FBMkI7Ozs7O0lBSTNCLGtEQUF5Qjs7SUFFekIsaURBQXdCOzs7OztJQXVCcEIsNENBQWlDOzs7OztJQUNqQywwQ0FBMEM7Ozs7O0lBQzFDLDhDQUFvQzs7Ozs7SUFDcEMsMENBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIEV2ZW50RW1pdHRlciwgSW5qZWN0b3IsIElucHV0LCBPbkNoYW5nZXMsIE9uSW5pdCwgT3V0cHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEJzTW9kYWxTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1tb2RhbCc7XHJcbmltcG9ydCB7IE5vdGlmeVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLW5vdGlmeSc7XHJcbmltcG9ydCB7IFByb3BlcnR5RW50aXR5IH0gZnJvbSAnLi4vZW50aXR5L3Byb3BlcnR5LWVudGl0eSc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICAgIHNlbGVjdG9yOiAnYXBwLW1vZGFsLXByb3AnLFxyXG4gICAgdGVtcGxhdGU6IGBcclxuICAgIDxkaXYgY2xhc3M9XCJmYXJyaXMtaW5wdXQtd3JhcCBtb2RhbEljb25cIj5cclxuICAgICAgICA8aW5wdXQgdHlwZT1cImlucHV0XCIgY2xhc3M9XCJmb3JtLWNvbnRyb2wgZm9ybS1jb250cm9sLXNtXCIgWyhuZ01vZGVsKV09XCJlbGVtZW50U2hvd1ZhbHVlXCIgcmVhZG9ubHk+XHJcbiAgICAgICAgPHNwYW4gW2NsYXNzLmFsbG93Q2xlYXJdPVwic2hvd0NsZWFyQnV0dG9uXCIgY2xhc3M9XCJzaG93Q2xlYXJCdXR0b25cIiAoY2xpY2spPVwibW9kYWxDbGVhcigpXCI+XHJcbiAgICAgICAgICAgIDxpIGNsYXNzPVwibWF0ZXJpYWwtaWNvbnMgY2xlYXJJY29uXCI+Y2xvc2U8L2k+XHJcbiAgICAgICAgPC9zcGFuPlxyXG4gICAgICAgIDxpIGNsYXNzPVwibWF0ZXJpYWwtaWNvbnMgbW9yZUljb25cIiAoY2xpY2spPVwib3Blbk1vZGFsKClcIj5maWx0ZXJfbm9uZTwvaT5cclxuICAgIDwvZGl2PlxyXG4gICAgYCxcclxuICAgIHN0eWxlczogW1xyXG4gICAgICAgIGBcclxuICAgICAgICAubW9kYWxJY29uIC5zaG93Q2xlYXJCdXR0b24ge1xyXG4gICAgICAgICAgICBkaXNwbGF5OiBub25lO1xyXG4gICAgICAgIH1cclxuICAgICAgICAubW9kYWxJY29uOmhvdmVyIC5hbGxvd0NsZWFyLnNob3dDbGVhckJ1dHRvbiB7XHJcbiAgICAgICAgICAgIGRpc3BsYXk6IGJsb2NrO1xyXG4gICAgICAgIH1cclxuICAgICAgICAubW9kYWxJY29uIGlucHV0IHtcclxuICAgICAgICAgICAgcGFkZGluZy1yaWdodDogMzBweDtcclxuICAgICAgICB9XHJcbiAgICAgICAgLm1vZGFsSWNvbiAubW9yZUljb24ge1xyXG4gICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7XHJcbiAgICAgICAgICAgIHRvcDogNnB4O1xyXG4gICAgICAgICAgICByaWdodDogNnB4O1xyXG4gICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7XHJcbiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTZweDtcclxuICAgICAgICAgICAgY29sb3I6ICM3NThhOTY7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC5tb2RhbEljb24gLmNsZWFySWNvbiB7XHJcbiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTtcclxuICAgICAgICAgICAgdG9wOiA1cHg7XHJcbiAgICAgICAgICAgIHJpZ2h0OiAzMHB4O1xyXG4gICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7XHJcbiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTlweDtcclxuICAgICAgICAgICAgY29sb3I6ICM3NThhOTY7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGBcclxuICAgIF1cclxufSlcclxuZXhwb3J0IGNsYXNzIE1vZGFsUHJvcGVydHlDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xyXG5cclxuXHJcbiAgICBAT3V0cHV0KCkgdmFsdWVDaGFuZ2VkID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcbiAgICBAT3V0cHV0KCkgc3VibWl0TW9kYWwgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuXHJcbiAgICBwcml2YXRlIF9lbGVtZW50Q29uZmlnOiBQcm9wZXJ0eUVudGl0eTtcclxuICAgIHByaXZhdGUgX2VsZW1lbnRWYWx1ZTogYW55O1xyXG5cclxuXHJcbiAgICAvKiog6L6T5YWl5qGG5Lit5pi+56S655qE5YC8ICovXHJcbiAgICBlbGVtZW50U2hvd1ZhbHVlOiBzdHJpbmc7XHJcblxyXG4gICAgc2hvd0NsZWFyQnV0dG9uID0gZmFsc2U7XHJcbiAgICBnZXQgZWxlbWVudENvbmZpZygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZWxlbWVudENvbmZpZztcclxuICAgIH1cclxuXHJcbiAgICBzZXQgZWxlbWVudENvbmZpZyh2YWx1ZSkge1xyXG4gICAgICAgIHRoaXMuX2VsZW1lbnRDb25maWcgPSB2YWx1ZTtcclxuXHJcbiAgICAgICAgdGhpcy5jb252ZXJ0TW9kYWxTaG93VmFsdWUodGhpcy5fZWxlbWVudFZhbHVlKTtcclxuXHJcbiAgICAgICAgdGhpcy5zaG93Q2xlYXJCdXR0b24gPSB0aGlzLmVsZW1lbnRDb25maWcuc2hvd0NsZWFyQnV0dG9uICYmICF0aGlzLmVsZW1lbnRDb25maWcucmVhZG9ubHk7XHJcbiAgICB9XHJcbiAgICBnZXQgZWxlbWVudFZhbHVlKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9lbGVtZW50VmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0IGVsZW1lbnRWYWx1ZSh2YWx1ZSkge1xyXG4gICAgICAgIHRoaXMuX2VsZW1lbnRWYWx1ZSA9IHZhbHVlO1xyXG5cclxuICAgICAgICB0aGlzLmNvbnZlcnRNb2RhbFNob3dWYWx1ZSh0aGlzLl9lbGVtZW50VmFsdWUpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByaXZhdGUgbm90aWZ5U2VydjogTm90aWZ5U2VydmljZSxcclxuICAgICAgICBwcml2YXRlIHJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICAgICAgcHJpdmF0ZSBtb2RhbFNlcnZpY2U6IEJzTW9kYWxTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yKSB7IH1cclxuXHJcbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgY2hhbmdlVmFsdWUoJGV2ZW50KSB7XHJcbiAgICAgICAgdGhpcy52YWx1ZUNoYW5nZWQubmV4dCh7ICRldmVudCwgZWxlbWVudFZhbHVlOiB0aGlzLmVsZW1lbnRWYWx1ZSB9KTtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog5riF6Zmk5qih5oCB5qGG5YaF5a65XHJcbiAgICAgKi9cclxuICAgIG1vZGFsQ2xlYXIoKSB7XHJcbiAgICAgICAgLy8g5pWw5o2u6L2s5o2iXHJcbiAgICAgICAgdGhpcy5jb252ZXJ0TW9kYWxTaG93VmFsdWUobnVsbCk7XHJcblxyXG4gICAgICAgIC8vIOiLpeaciea4hemZpOWQjuS6i+S7tu+8jOWFiOaJp+ihjOaWueazlVxyXG4gICAgICAgIGlmIChPYmplY3Qua2V5cyh0aGlzLmVsZW1lbnRDb25maWcpLmluZGV4T2YoJ2FmdGVyQ2xpY2tDbGVhckJ1dHRvbicpID4gLTEgJiZcclxuICAgICAgICAgICAgdHlwZW9mICh0aGlzLmVsZW1lbnRDb25maWcuYWZ0ZXJDbGlja0NsZWFyQnV0dG9uKSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICB0aGlzLmVsZW1lbnRDb25maWcuYWZ0ZXJDbGlja0NsZWFyQnV0dG9uKHRoaXMuZWxlbWVudFZhbHVlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMudmFsdWVDaGFuZ2VkLm5leHQoeyBlbGVtZW50VmFsdWU6IG51bGwgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmqKHmgIHmoYblnLrmma/kuIvlsIblsZ7mgKflgLzovazmjaLkuLrovpPlhaXmoYbkuK3mmL7npLrnmoTlgLxcclxuICAgICAqIEBwYXJhbSB2YWx1ZSDlsZ7mgKflgLxcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBjb252ZXJ0TW9kYWxTaG93VmFsdWUodmFsdWUpIHtcclxuICAgICAgICBpZiAodGhpcy5lbGVtZW50Q29uZmlnLmNvbnZlcnRlcikge1xyXG4gICAgICAgICAgICB0aGlzLmVsZW1lbnRTaG93VmFsdWUgPSB0aGlzLmVsZW1lbnRDb25maWcuY29udmVydGVyLmNvbnZlcnRUbyh2YWx1ZSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlIGluc3RhbmNlb2YgT2JqZWN0KSB7XHJcbiAgICAgICAgICAgIHRoaXMuZWxlbWVudFNob3dWYWx1ZSA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmVsZW1lbnRTaG93VmFsdWUgPSB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiHquWumuS5iee8lui+keWZqOS9v+eUqOaooeaAgeahhuaJk+W8gFxyXG4gICAgICovXHJcbiAgICBvcGVuTW9kYWwoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZWxlbWVudENvbmZpZy5yZWFkb25seSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChPYmplY3Qua2V5cyh0aGlzLmVsZW1lbnRDb25maWcpLmluZGV4T2YoJ2JlZm9yZU9wZW5Nb2RhbCcpID4gLTEgJiYgdHlwZW9mICh0aGlzLmVsZW1lbnRDb25maWcuYmVmb3JlT3Blbk1vZGFsKSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLmVsZW1lbnRDb25maWcuYmVmb3JlT3Blbk1vZGFsKCk7XHJcbiAgICAgICAgICAgIGlmIChyZXN1bHQgJiYgIXJlc3VsdC5yZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubm90aWZ5U2Vydi53YXJuaW5nKHJlc3VsdC5tZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNyZWF0ZUVkaXRvckNvbXBvbmVudCgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yib5bu66Ieq5a6a5LmJ57yW6L6R5ZmoXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgY3JlYXRlRWRpdG9yQ29tcG9uZW50KCkge1xyXG4gICAgICAgIGNvbnN0IGVkaXRvciA9IHRoaXMuZWxlbWVudENvbmZpZy5lZGl0b3I7XHJcbiAgICAgICAgaWYgKCFlZGl0b3IpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDliJvlu7rmqKHmgIHmoYbnu4Tku7ZcclxuICAgICAgICBjb25zdCBjb21wRmFjdG9yeSA9IHRoaXMucmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoZWRpdG9yKTtcclxuICAgICAgICBjb25zdCBjb21wUmVmID0gY29tcEZhY3RvcnkuY3JlYXRlKHRoaXMuaW5qZWN0b3IpO1xyXG4gICAgICAgIGNvbXBSZWYuaW5zdGFuY2UudmFsdWUgPSB0aGlzLmVsZW1lbnRWYWx1ZTtcclxuICAgICAgICAvLyDnvJbovpHlmajpnIDopoHnmoTpop3lpJblj4LmlbBcclxuICAgICAgICBjb21wUmVmLmluc3RhbmNlLmVkaXRvclBhcmFtcyA9IHRoaXMuZWxlbWVudENvbmZpZy5lZGl0b3JQYXJhbXM7XHJcblxyXG4gICAgICAgIGxldCBtb2RhbENvbmZpZyA9IGNvbXBSZWYuaW5zdGFuY2UubW9kYWxDb25maWc7XHJcbiAgICAgICAgaWYgKCFtb2RhbENvbmZpZykge1xyXG4gICAgICAgICAgICBtb2RhbENvbmZpZyA9IHtcclxuICAgICAgICAgICAgICAgIHRpdGxlOiAn5bGe5oCn6YWN572uJyxcclxuICAgICAgICAgICAgICAgIHdpZHRoOiA4MDAsXHJcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IDQwMCxcclxuICAgICAgICAgICAgICAgIHNob3dCdXR0b25zOiBmYWxzZVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0gZWxzZSBpZiAobW9kYWxDb25maWcuc2hvd0J1dHRvbnMpIHtcclxuICAgICAgICAgICAgbW9kYWxDb25maWcuYnV0dG9ucyA9IGNvbXBSZWYuaW5zdGFuY2UubW9kYWxGb290ZXI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBkaWFsb2cgPSB0aGlzLm1vZGFsU2VydmljZS5zaG93KGNvbXBSZWYsIG1vZGFsQ29uZmlnKTtcclxuXHJcbiAgICAgICAgLy8g55uR5ZCs5YWz6Zet5qih5oCB5qGGXHJcbiAgICAgICAgaWYgKGNvbXBSZWYuaW5zdGFuY2UuY2xvc2VNb2RhbCAmJiBjb21wUmVmLmluc3RhbmNlLmNsb3NlTW9kYWwgaW5zdGFuY2VvZiBFdmVudEVtaXR0ZXIpIHtcclxuICAgICAgICAgICAgY29tcFJlZi5pbnN0YW5jZS5jbG9zZU1vZGFsLnN1YnNjcmliZSgoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8g5pWw5o2u6L2s5o2iXHJcbiAgICAgICAgICAgICAgICBpZiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29udmVydE1vZGFsU2hvd1ZhbHVlKGRhdGEpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnZhbHVlQ2hhbmdlZC5uZXh0KHsgZWxlbWVudFZhbHVlOiBkYXRhIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGRpYWxvZy5jbG9zZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG5cclxuXHJcbiAgICAgICAgLy8g5by55Ye65qGG5YWz6Zet5LqL5Lu277yM5bim5Y+C5pWw77yM5qC85byP5Li6eyB2YWx1ZSwgcGFyYW1ldGVycyB9XHJcbiAgICAgICAgaWYgKGNvbXBSZWYuaW5zdGFuY2Uuc3VibWl0TW9kYWwgJiYgY29tcFJlZi5pbnN0YW5jZS5zdWJtaXRNb2RhbCBpbnN0YW5jZW9mIEV2ZW50RW1pdHRlcikge1xyXG4gICAgICAgICAgICBjb21wUmVmLmluc3RhbmNlLnN1Ym1pdE1vZGFsLnN1YnNjcmliZShkYXRhID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICghZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZy5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbnN0IHsgdmFsdWUsIHBhcmFtZXRlcnMgfSA9IGRhdGE7XHJcbiAgICAgICAgICAgICAgICAvLyDmlbDmja7ovazmjaJcclxuICAgICAgICAgICAgICAgIHRoaXMuY29udmVydE1vZGFsU2hvd1ZhbHVlKHZhbHVlKTtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLnN1Ym1pdE1vZGFsLm5leHQoeyBlbGVtZW50VmFsdWU6IHZhbHVlLCBwYXJhbWV0ZXJzIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGRpYWxvZy5jbG9zZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG59XHJcbiJdfQ==