/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { BehaviorSubject, Subject } from 'rxjs';
export class ComboService {
    constructor() {
        this.innerData = [];
        this.selected$ = new Subject();
        this.isOpen$ = new BehaviorSubject(false);
        this.data$ = new BehaviorSubject('');
        // initData() {
        //     // this.loadDataTable(this.data || []);
        //     // switch (this.displayType) {
        //     //     case 'TreeList': {
        //     //         this.getData().subscribe(data => this.loadDataTree(data));
        //     //         break;
        //     //     }
        //     //     case 'LIST': {
        //     //         // List
        //     //         this.getData().subscribe(data => this.loadDataTable(data));
        //     //         break;
        //     //     }
        //     //     // case 'LOOKUPLIST': {
        //     //     //     // List
        //     //     //     this.getData().subscribe(data =>
        //     //     //         this.loadLookUpDataTable(data)
        //     //     //     );
        //     //     //     break;
        //     //     // }
        //     //     // case 'LOOKUPTREELIST': {
        //     //     //     // List
        //     //     //     this.getData().subscribe(data => this.loadLookUpDataTree(data));
        //     //     //     break;
        //     //     // }
        //     // }
        // }
        // getData(): Observable<any> {
        //     // if (this.uri) {
        //     //     const params = {};
        //     //     this.showLoading();
        //     //     if (this.comboHttp) {
        //     //         return this.comboHttp.getData(this.uri);
        //     //     } else {
        //     //         return this.http.get(this.uri);
        //     //     }
        //     // } else {
        //         if (this.data) {
        //             return of(this.data);
        //         } else {
        //             return of([]);
        //         }
        //     // }
        // }
        // loadDataTable(data: any) {
        //     if (data instanceof Array) {
        //         this.data = data;
        //     } else {
        //         this.data = data.returnValue;
        //     }
        //     this.loadData(this.data, this.selectedValues, (dataArr, val) => {
        //         // tslint:disable-next-line:triple-equals
        //         return dataArr.find(d => d[this.idField] + '' == val);
        //     });
        //     // this.closeLoading();
        // }
        // loadDataTree(data: any) {
        //     if (data instanceof Array) {
        //         this.data = data;
        //     } else {
        //         this.data = data.returnValue;
        //     }
        //     this.loadData(this.data, this.selectedValues, (dataArr, val) => {
        //         return eachData(dataArr, val, this.idField);
        //         function eachData(paramData, paramVal, idField) {
        //             let rtnData: any = '';
        //             paramData.find(d => {
        //                 // tslint:disable-next-line:triple-equals
        //                 if (d.data[idField] == paramVal) {
        //                     rtnData = d.data;
        //                     return true;
        //                 } else if (d.children && d.children.length) {
        //                     rtnData = eachData(d.children, paramVal, idField);
        //                 } else {
        //                     return false;
        //                 }
        //             });
        //             return rtnData;
        //         }
        //     });
        //     // this.closeLoading();
        // }
        // loadLookUpDataTable(resData: any) {
        //     if (resData.returnValue) {
        //         resData = resData.returnValue;
        //     }
        //     this.columns = resData.columns;
        //     this.pageInfo = resData.pageInfo;
        //     this.data = resData.items;
        //     this.loadData(this.data, this.selectedValues, (dataArr, val) => {
        //         // tslint:disable-next-line: triple-equals
        //         return dataArr.find(d => d[this.idField] + '' == val);
        //     });
        //     this.closeLoading();
        // }
        // loadLookUpDataTree(resData: any) {
        //     if (resData.returnValue) {
        //         resData = resData.returnValue;
        //     }
        //     this.columns = resData.columns;
        //     const treeInfo = resData.treeInfo;
        //     // tslint:disable-next-line: no-string-literal
        //     if (!treeInfo['treeDataIsInit']) {
        //         if (treeInfo.layerType.toLowerCase() === 'pathcode') {
        //             this.data = this.lookupUtils.makeTree(resData.items, treeInfo);
        //         } else {
        //             this.data = this.lookupUtils.makeTreeWithParentID(
        //                 resData.items,
        //                 '',
        //                 `${treeInfo.dataField}.${treeInfo.parentField}`,
        //                 this.idField
        //             );
        //         }
        //     }
        //     this.loadData(this.data, this.selectedValues, (dataArr, val) => {
        //         return eachData(dataArr, val, this.idField);
        //         function eachData(paramData, paramVal, idField) {
        //             let rtnData: any = '';
        //             paramData.find(d => {
        //                 // tslint:disable-next-line:triple-equals
        //                 if (d.data[idField] == paramVal) {
        //                     rtnData = d.data;
        //                     return true;
        //                 } else if (d.children && d.children.length) {
        //                     rtnData = eachData(d.children, paramVal, idField);
        //                 } else {
        //                     return false;
        //                 }
        //             });
        //             return rtnData;
        //         }
        //     });
        //     this.closeLoading();
        // }
        // private showLoading() {
        //     this.loading = this.loadingService.show();
        // }
        // closeLoading() {
        //     if (this.loading) {
        //         this.loading.close();
        //         this.loading = null;
        //     }
        // }
    }
    /**
     * @return {?}
     */
    get data() {
        return this.innerData;
    }
    /**
     * @param {?} val
     * @return {?}
     */
    set data(val) {
        this.innerData = val;
        this.data$.next(val);
    }
    // columns: any;
    // injectService() {
    //     if (this.injector && !this.comboHttp) {
    //         this.lookupUtils = this.injector.get(LookupUtils, null);
    //         if (this.displayType.indexOf('LOOKUP') > -1) {
    //             this.comboHttp = this.injector.get(ServerSideToken, null);
    //         } else {
    //             this.comboHttp = this.injector.get(ComboServerSideToken, null);
    //         }
    //     }
    // }
    /**
     * @param {?} value
     * @return {?}
     */
    toBoolean(value) {
        return value != null && `${value}` !== 'false';
    }
    /**
     * @param {?} data
     * @param {?=} index
     * @return {?}
     */
    selectItem(data, index) {
        this.isOpen$.next(false);
        this.selectedValue = data;
        this.selected$.next(this.selectedValue);
    }
    /**
     * @param {?} data
     * @return {?}
     */
    unSelectItem(data) {
        this.selectedValue = null;
        this.selected$.next(null);
    }
    /**
     * @param {?} id
     * @return {?}
     */
    isSelect(id) {
        return false;
    }
    // loadData(data: any, selectValues: string = '', callback) {
    //     if (data) {
    //         if (selectValues) {
    //             if (selectValues.split) {
    //                 // key 是字符串，可能是拼起来的
    //                 const selectedItems = selectValues.split(',').map(val => {
    //                     return callback(data, val);
    //                 });
    //
    //                 this.selections = selectedItems;
    //             } else {
    //                 // key不可split
    //                 this.selections = [selectValues];
    //             }
    //         } else {
    //             this.selections = [];
    //         }
    //         // this.selections$.next(this.selections);
    //         // const _data = this.initData(data);
    //         // this.updateState({...this._state, data: _data});
    //     } else {
    //         // this.updateState({ data: [], selections: [] });
    //     }
    // }
    // filterData(val: string, filed: any = 'text') {
    //     if (val) {
    //         const data = this.data
    //             ? this.data.filter(item => {
    //                 if (item[filed]) {
    //                     return String(item[filed]).indexOf(val) > -1;
    //                 } else if (item.data && item.data[filed]) {
    //                     return String(item.data[filed]).indexOf(val) > -1;
    //                 }
    //               })
    //             : [];
    //         this.data$.next(data);
    //     }
    // }
    /**
     * @return {?}
     */
    getSelected() {
        return this.selectedValue;
    }
    // filterSelections(displayText: string) {
    //     if (displayText && this.selections) {
    //         const selections = displayText
    //             .split(',')
    //             .map(val => {
    //                 return this.selections.find(d => d[this.textField] === val);
    //             })
    //             .filter(val => !!val);
    //         this.selectedValues = this.getValue(this.valueField, selections);
    //         this.selections = selections;
    //     }
    // }
    // clearSelections() {
    //     this.selections = [];
    // }
    /**
     * @param {?} prop
     * @param {?=} selections
     * @return {?}
     */
    getValue(prop, selections) {
        // selections = selections ? selections : this.selections;
        // if (selections && selections.length) {
        //     // if (this.mapFields) {
        //     //     const helpFields = Object.keys(this.mapFields);
        //     //     helpFields.forEach( (f: any) => {
        //     //         if (this.mapFields[f] === prop) {
        //     //             prop = f;
        //     //             return;
        //     //         }
        //     //     });
        //     // }
        //
        //     // if (selections.length === 1) {
        //     //     return this.getValueByObj(prop, selections[0]);
        //     // }
        //
        //     const tmp = selections
        //         .map(item => {
        //             return this.getValueByObj(prop, item);
        //         })
        //         .join(',');
        //     return tmp;
        // }
        if (this.selectedValue) {
            return this.getValueByObj(prop, this.selectedValue);
        }
        return '';
    }
    /**
     * @param {?} field
     * @param {?} data
     * @return {?}
     */
    getValueByObj(field, data) {
        if (!data) {
            return '';
        }
        /** @type {?} */
        let resultVal = '';
        if (field.indexOf('.') === -1) {
            resultVal = data[field];
        }
        else {
            resultVal = field.split('.').reduce((/**
             * @param {?} obj
             * @param {?} key
             * @return {?}
             */
            (obj, key) => {
                if (obj) {
                    return obj[key];
                }
                else {
                    return null;
                }
            }), data);
        }
        return resultVal;
    }
}
ComboService.decorators = [
    { type: Injectable }
];
if (false) {
    /** @type {?} */
    ComboService.prototype.idField;
    /** @type {?} */
    ComboService.prototype.valueField;
    /** @type {?} */
    ComboService.prototype.textField;
    /** @type {?} */
    ComboService.prototype.mapFields;
    /**
     * @type {?}
     * @private
     */
    ComboService.prototype.innerData;
    /** @type {?} */
    ComboService.prototype.selectedValue;
    /** @type {?} */
    ComboService.prototype.selected$;
    /** @type {?} */
    ComboService.prototype.isOpen$;
    /** @type {?} */
    ComboService.prototype.data$;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tYm8uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvaWRlLXByb3BlcnR5LXBhbmVsLyIsInNvdXJjZXMiOlsibGliL2NvbWJvLWxpc3QvY29tYm8uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBWSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE9BQU8sRUFBa0IsTUFBTSxNQUFNLENBQUM7QUFLaEUsTUFBTSxPQUFPLFlBQVk7SUFEekI7UUFNWSxjQUFTLEdBQVEsRUFBRSxDQUFDO1FBUzVCLGNBQVMsR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDO1FBQy9CLFlBQU8sR0FBRyxJQUFJLGVBQWUsQ0FBVSxLQUFLLENBQUMsQ0FBQztRQUM5QyxVQUFLLEdBQUcsSUFBSSxlQUFlLENBQU0sRUFBRSxDQUFDLENBQUM7UUF5SXJDLGVBQWU7UUFDZiw4Q0FBOEM7UUFDOUMscUNBQXFDO1FBQ3JDLGdDQUFnQztRQUNoQyw0RUFBNEU7UUFDNUUsd0JBQXdCO1FBQ3hCLGVBQWU7UUFDZiw0QkFBNEI7UUFDNUIseUJBQXlCO1FBQ3pCLDZFQUE2RTtRQUM3RSx3QkFBd0I7UUFDeEIsZUFBZTtRQUNmLHFDQUFxQztRQUNyQyw0QkFBNEI7UUFDNUIscURBQXFEO1FBQ3JELHVEQUF1RDtRQUN2RCx1QkFBdUI7UUFDdkIsMkJBQTJCO1FBQzNCLGtCQUFrQjtRQUNsQix5Q0FBeUM7UUFDekMsNEJBQTRCO1FBQzVCLHFGQUFxRjtRQUNyRiwyQkFBMkI7UUFDM0Isa0JBQWtCO1FBQ2xCLFdBQVc7UUFDWCxJQUFJO1FBRUosK0JBQStCO1FBQy9CLHlCQUF5QjtRQUN6QixnQ0FBZ0M7UUFDaEMsaUNBQWlDO1FBQ2pDLG1DQUFtQztRQUNuQywwREFBMEQ7UUFDMUQsc0JBQXNCO1FBQ3RCLGlEQUFpRDtRQUNqRCxlQUFlO1FBQ2Ysa0JBQWtCO1FBQ2xCLDJCQUEyQjtRQUMz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QVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDM0I7YUFBTTtZQUNILFNBQVMsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU07Ozs7O1lBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7Z0JBQzdDLElBQUksR0FBRyxFQUFFO29CQUNMLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUNuQjtxQkFBTTtvQkFDSCxPQUFPLElBQUksQ0FBQztpQkFDZjtZQUNMLENBQUMsR0FBRSxJQUFJLENBQUMsQ0FBQztTQUNaO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDckIsQ0FBQzs7O1lBeEpKLFVBQVU7Ozs7SUFFUCwrQkFBZ0I7O0lBQ2hCLGtDQUFtQjs7SUFDbkIsaUNBQWtCOztJQUNsQixpQ0FBNkM7Ozs7O0lBQzdDLGlDQUE0Qjs7SUFRNUIscUNBQW1COztJQUNuQixpQ0FBK0I7O0lBQy9CLCtCQUE4Qzs7SUFDOUMsNkJBQXFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBTdWJqZWN0LCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBDb21ib1NlcnZpY2Uge1xyXG4gICAgaWRGaWVsZDogc3RyaW5nO1xyXG4gICAgdmFsdWVGaWVsZDogc3RyaW5nO1xyXG4gICAgdGV4dEZpZWxkOiBzdHJpbmc7XHJcbiAgICBtYXBGaWVsZHM6IHsgW3NvdXJjZUZpZWxkOiBzdHJpbmddOiBzdHJpbmcgfTtcclxuICAgIHByaXZhdGUgaW5uZXJEYXRhOiBhbnkgPSBbXTtcclxuICAgIGdldCBkYXRhKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmlubmVyRGF0YTtcclxuICAgIH1cclxuICAgIHNldCBkYXRhKHZhbCkge1xyXG4gICAgICAgIHRoaXMuaW5uZXJEYXRhID0gdmFsO1xyXG4gICAgICAgIHRoaXMuZGF0YSQubmV4dCh2YWwpO1xyXG4gICAgfVxyXG4gICAgc2VsZWN0ZWRWYWx1ZTogYW55O1xyXG4gICAgc2VsZWN0ZWQkID0gbmV3IFN1YmplY3Q8YW55PigpO1xyXG4gICAgaXNPcGVuJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4oZmFsc2UpO1xyXG4gICAgZGF0YSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGFueT4oJycpO1xyXG4gICAgLy8gY29sdW1uczogYW55O1xyXG5cclxuICAgIC8vIGluamVjdFNlcnZpY2UoKSB7XHJcbiAgICAvLyAgICAgaWYgKHRoaXMuaW5qZWN0b3IgJiYgIXRoaXMuY29tYm9IdHRwKSB7XHJcbiAgICAvLyAgICAgICAgIHRoaXMubG9va3VwVXRpbHMgPSB0aGlzLmluamVjdG9yLmdldChMb29rdXBVdGlscywgbnVsbCk7XHJcbiAgICAvLyAgICAgICAgIGlmICh0aGlzLmRpc3BsYXlUeXBlLmluZGV4T2YoJ0xPT0tVUCcpID4gLTEpIHtcclxuICAgIC8vICAgICAgICAgICAgIHRoaXMuY29tYm9IdHRwID0gdGhpcy5pbmplY3Rvci5nZXQoU2VydmVyU2lkZVRva2VuLCBudWxsKTtcclxuICAgIC8vICAgICAgICAgfSBlbHNlIHtcclxuICAgIC8vICAgICAgICAgICAgIHRoaXMuY29tYm9IdHRwID0gdGhpcy5pbmplY3Rvci5nZXQoQ29tYm9TZXJ2ZXJTaWRlVG9rZW4sIG51bGwpO1xyXG4gICAgLy8gICAgICAgICB9XHJcbiAgICAvLyAgICAgfVxyXG4gICAgLy8gfVxyXG4gICAgdG9Cb29sZWFuKHZhbHVlOiBhbnkpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiBgJHt2YWx1ZX1gICE9PSAnZmFsc2UnO1xyXG4gICAgfVxyXG4gICAgc2VsZWN0SXRlbShkYXRhOiBhbnksIGluZGV4PzogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5pc09wZW4kLm5leHQoZmFsc2UpO1xyXG4gICAgICAgIHRoaXMuc2VsZWN0ZWRWYWx1ZSA9IGRhdGE7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RlZCQubmV4dCh0aGlzLnNlbGVjdGVkVmFsdWUpO1xyXG4gICAgfVxyXG4gICAgdW5TZWxlY3RJdGVtKGRhdGE6IGFueSkge1xyXG4gICAgICAgIHRoaXMuc2VsZWN0ZWRWYWx1ZSA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RlZCQubmV4dChudWxsKTtcclxuICAgIH1cclxuICAgIGlzU2VsZWN0KGlkOiBhbnkpIHtcclxuXHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGxvYWREYXRhKGRhdGE6IGFueSwgc2VsZWN0VmFsdWVzOiBzdHJpbmcgPSAnJywgY2FsbGJhY2spIHtcclxuICAgIC8vICAgICBpZiAoZGF0YSkge1xyXG4gICAgLy8gICAgICAgICBpZiAoc2VsZWN0VmFsdWVzKSB7XHJcbiAgICAvLyAgICAgICAgICAgICBpZiAoc2VsZWN0VmFsdWVzLnNwbGl0KSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgLy8ga2V5IOaYr+Wtl+espuS4su+8jOWPr+iDveaYr+aLvOi1t+adpeeahFxyXG4gICAgLy8gICAgICAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkSXRlbXMgPSBzZWxlY3RWYWx1ZXMuc3BsaXQoJywnKS5tYXAodmFsID0+IHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGRhdGEsIHZhbCk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAvL1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9ucyA9IHNlbGVjdGVkSXRlbXM7XHJcbiAgICAvLyAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIC8vIGtleeS4jeWPr3NwbGl0XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3Rpb25zID0gW3NlbGVjdFZhbHVlc107XHJcbiAgICAvLyAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgICAgICB0aGlzLnNlbGVjdGlvbnMgPSBbXTtcclxuICAgIC8vICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICAvLyB0aGlzLnNlbGVjdGlvbnMkLm5leHQodGhpcy5zZWxlY3Rpb25zKTtcclxuICAgIC8vICAgICAgICAgLy8gY29uc3QgX2RhdGEgPSB0aGlzLmluaXREYXRhKGRhdGEpO1xyXG4gICAgLy8gICAgICAgICAvLyB0aGlzLnVwZGF0ZVN0YXRlKHsuLi50aGlzLl9zdGF0ZSwgZGF0YTogX2RhdGF9KTtcclxuICAgIC8vICAgICB9IGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAvLyB0aGlzLnVwZGF0ZVN0YXRlKHsgZGF0YTogW10sIHNlbGVjdGlvbnM6IFtdIH0pO1xyXG4gICAgLy8gICAgIH1cclxuICAgIC8vIH1cclxuICAgIC8vIGZpbHRlckRhdGEodmFsOiBzdHJpbmcsIGZpbGVkOiBhbnkgPSAndGV4dCcpIHtcclxuICAgIC8vICAgICBpZiAodmFsKSB7XHJcbiAgICAvLyAgICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGFcclxuICAgIC8vICAgICAgICAgICAgID8gdGhpcy5kYXRhLmZpbHRlcihpdGVtID0+IHtcclxuICAgIC8vICAgICAgICAgICAgICAgICBpZiAoaXRlbVtmaWxlZF0pIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtW2ZpbGVkXSkuaW5kZXhPZih2YWwpID4gLTE7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpdGVtLmRhdGEgJiYgaXRlbS5kYXRhW2ZpbGVkXSkge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKGl0ZW0uZGF0YVtmaWxlZF0pLmluZGV4T2YodmFsKSA+IC0xO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICAgICAgICAgfSlcclxuICAgIC8vICAgICAgICAgICAgIDogW107XHJcbiAgICAvLyAgICAgICAgIHRoaXMuZGF0YSQubmV4dChkYXRhKTtcclxuICAgIC8vICAgICB9XHJcbiAgICAvLyB9XHJcbiAgICBnZXRTZWxlY3RlZCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3RlZFZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGZpbHRlclNlbGVjdGlvbnMoZGlzcGxheVRleHQ6IHN0cmluZykge1xyXG4gICAgLy8gICAgIGlmIChkaXNwbGF5VGV4dCAmJiB0aGlzLnNlbGVjdGlvbnMpIHtcclxuICAgIC8vICAgICAgICAgY29uc3Qgc2VsZWN0aW9ucyA9IGRpc3BsYXlUZXh0XHJcbiAgICAvLyAgICAgICAgICAgICAuc3BsaXQoJywnKVxyXG4gICAgLy8gICAgICAgICAgICAgLm1hcCh2YWwgPT4ge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNlbGVjdGlvbnMuZmluZChkID0+IGRbdGhpcy50ZXh0RmllbGRdID09PSB2YWwpO1xyXG4gICAgLy8gICAgICAgICAgICAgfSlcclxuICAgIC8vICAgICAgICAgICAgIC5maWx0ZXIodmFsID0+ICEhdmFsKTtcclxuICAgIC8vICAgICAgICAgdGhpcy5zZWxlY3RlZFZhbHVlcyA9IHRoaXMuZ2V0VmFsdWUodGhpcy52YWx1ZUZpZWxkLCBzZWxlY3Rpb25zKTtcclxuICAgIC8vICAgICAgICAgdGhpcy5zZWxlY3Rpb25zID0gc2VsZWN0aW9ucztcclxuICAgIC8vICAgICB9XHJcbiAgICAvLyB9XHJcblxyXG4gICAgLy8gY2xlYXJTZWxlY3Rpb25zKCkge1xyXG4gICAgLy8gICAgIHRoaXMuc2VsZWN0aW9ucyA9IFtdO1xyXG4gICAgLy8gfVxyXG5cclxuICAgIGdldFZhbHVlKHByb3A6IHN0cmluZywgc2VsZWN0aW9ucz86IGFueSk6IGFueSB7XHJcbiAgICAgICAgLy8gc2VsZWN0aW9ucyA9IHNlbGVjdGlvbnMgPyBzZWxlY3Rpb25zIDogdGhpcy5zZWxlY3Rpb25zO1xyXG4gICAgICAgIC8vIGlmIChzZWxlY3Rpb25zICYmIHNlbGVjdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgLy8gICAgIC8vIGlmICh0aGlzLm1hcEZpZWxkcykge1xyXG4gICAgICAgIC8vICAgICAvLyAgICAgY29uc3QgaGVscEZpZWxkcyA9IE9iamVjdC5rZXlzKHRoaXMubWFwRmllbGRzKTtcclxuICAgICAgICAvLyAgICAgLy8gICAgIGhlbHBGaWVsZHMuZm9yRWFjaCggKGY6IGFueSkgPT4ge1xyXG4gICAgICAgIC8vICAgICAvLyAgICAgICAgIGlmICh0aGlzLm1hcEZpZWxkc1tmXSA9PT0gcHJvcCkge1xyXG4gICAgICAgIC8vICAgICAvLyAgICAgICAgICAgICBwcm9wID0gZjtcclxuICAgICAgICAvLyAgICAgLy8gICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIC8vICAgICAvLyAgICAgICAgIH1cclxuICAgICAgICAvLyAgICAgLy8gICAgIH0pO1xyXG4gICAgICAgIC8vICAgICAvLyB9XHJcbiAgICAgICAgLy9cclxuICAgICAgICAvLyAgICAgLy8gaWYgKHNlbGVjdGlvbnMubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgLy8gICAgIC8vICAgICByZXR1cm4gdGhpcy5nZXRWYWx1ZUJ5T2JqKHByb3AsIHNlbGVjdGlvbnNbMF0pO1xyXG4gICAgICAgIC8vICAgICAvLyB9XHJcbiAgICAgICAgLy9cclxuICAgICAgICAvLyAgICAgY29uc3QgdG1wID0gc2VsZWN0aW9uc1xyXG4gICAgICAgIC8vICAgICAgICAgLm1hcChpdGVtID0+IHtcclxuICAgICAgICAvLyAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRWYWx1ZUJ5T2JqKHByb3AsIGl0ZW0pO1xyXG4gICAgICAgIC8vICAgICAgICAgfSlcclxuICAgICAgICAvLyAgICAgICAgIC5qb2luKCcsJyk7XHJcbiAgICAgICAgLy8gICAgIHJldHVybiB0bXA7XHJcbiAgICAgICAgLy8gfVxyXG4gICAgICAgIGlmICh0aGlzLnNlbGVjdGVkVmFsdWUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VmFsdWVCeU9iaihwcm9wLCB0aGlzLnNlbGVjdGVkVmFsdWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcbiAgICBnZXRWYWx1ZUJ5T2JqKGZpZWxkOiBzdHJpbmcsIGRhdGE6IGFueSkge1xyXG4gICAgICAgIGlmICghZGF0YSkge1xyXG4gICAgICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCByZXN1bHRWYWwgPSAnJztcclxuICAgICAgICBpZiAoZmllbGQuaW5kZXhPZignLicpID09PSAtMSkge1xyXG4gICAgICAgICAgICByZXN1bHRWYWwgPSBkYXRhW2ZpZWxkXTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXN1bHRWYWwgPSBmaWVsZC5zcGxpdCgnLicpLnJlZHVjZSgob2JqLCBrZXkpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChvYmopIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2JqW2tleV07XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LCBkYXRhKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdFZhbDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBpbml0RGF0YSgpIHtcclxuICAgIC8vICAgICAvLyB0aGlzLmxvYWREYXRhVGFibGUodGhpcy5kYXRhIHx8IFtdKTtcclxuICAgIC8vICAgICAvLyBzd2l0Y2ggKHRoaXMuZGlzcGxheVR5cGUpIHtcclxuICAgIC8vICAgICAvLyAgICAgY2FzZSAnVHJlZUxpc3QnOiB7XHJcbiAgICAvLyAgICAgLy8gICAgICAgICB0aGlzLmdldERhdGEoKS5zdWJzY3JpYmUoZGF0YSA9PiB0aGlzLmxvYWREYXRhVHJlZShkYXRhKSk7XHJcbiAgICAvLyAgICAgLy8gICAgICAgICBicmVhaztcclxuICAgIC8vICAgICAvLyAgICAgfVxyXG4gICAgLy8gICAgIC8vICAgICBjYXNlICdMSVNUJzoge1xyXG4gICAgLy8gICAgIC8vICAgICAgICAgLy8gTGlzdFxyXG4gICAgLy8gICAgIC8vICAgICAgICAgdGhpcy5nZXREYXRhKCkuc3Vic2NyaWJlKGRhdGEgPT4gdGhpcy5sb2FkRGF0YVRhYmxlKGRhdGEpKTtcclxuICAgIC8vICAgICAvLyAgICAgICAgIGJyZWFrO1xyXG4gICAgLy8gICAgIC8vICAgICB9XHJcbiAgICAvLyAgICAgLy8gICAgIC8vIGNhc2UgJ0xPT0tVUExJU1QnOiB7XHJcbiAgICAvLyAgICAgLy8gICAgIC8vICAgICAvLyBMaXN0XHJcbiAgICAvLyAgICAgLy8gICAgIC8vICAgICB0aGlzLmdldERhdGEoKS5zdWJzY3JpYmUoZGF0YSA9PlxyXG4gICAgLy8gICAgIC8vICAgICAvLyAgICAgICAgIHRoaXMubG9hZExvb2tVcERhdGFUYWJsZShkYXRhKVxyXG4gICAgLy8gICAgIC8vICAgICAvLyAgICAgKTtcclxuICAgIC8vICAgICAvLyAgICAgLy8gICAgIGJyZWFrO1xyXG4gICAgLy8gICAgIC8vICAgICAvLyB9XHJcbiAgICAvLyAgICAgLy8gICAgIC8vIGNhc2UgJ0xPT0tVUFRSRUVMSVNUJzoge1xyXG4gICAgLy8gICAgIC8vICAgICAvLyAgICAgLy8gTGlzdFxyXG4gICAgLy8gICAgIC8vICAgICAvLyAgICAgdGhpcy5nZXREYXRhKCkuc3Vic2NyaWJlKGRhdGEgPT4gdGhpcy5sb2FkTG9va1VwRGF0YVRyZWUoZGF0YSkpO1xyXG4gICAgLy8gICAgIC8vICAgICAvLyAgICAgYnJlYWs7XHJcbiAgICAvLyAgICAgLy8gICAgIC8vIH1cclxuICAgIC8vICAgICAvLyB9XHJcbiAgICAvLyB9XHJcblxyXG4gICAgLy8gZ2V0RGF0YSgpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgLy8gICAgIC8vIGlmICh0aGlzLnVyaSkge1xyXG4gICAgLy8gICAgIC8vICAgICBjb25zdCBwYXJhbXMgPSB7fTtcclxuICAgIC8vICAgICAvLyAgICAgdGhpcy5zaG93TG9hZGluZygpO1xyXG4gICAgLy8gICAgIC8vICAgICBpZiAodGhpcy5jb21ib0h0dHApIHtcclxuICAgIC8vICAgICAvLyAgICAgICAgIHJldHVybiB0aGlzLmNvbWJvSHR0cC5nZXREYXRhKHRoaXMudXJpKTtcclxuICAgIC8vICAgICAvLyAgICAgfSBlbHNlIHtcclxuICAgIC8vICAgICAvLyAgICAgICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KHRoaXMudXJpKTtcclxuICAgIC8vICAgICAvLyAgICAgfVxyXG4gICAgLy8gICAgIC8vIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgIGlmICh0aGlzLmRhdGEpIHtcclxuICAgIC8vICAgICAgICAgICAgIHJldHVybiBvZih0aGlzLmRhdGEpO1xyXG4gICAgLy8gICAgICAgICB9IGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgICAgcmV0dXJuIG9mKFtdKTtcclxuICAgIC8vICAgICAgICAgfVxyXG4gICAgLy8gICAgIC8vIH1cclxuICAgIC8vIH1cclxuICAgIC8vIGxvYWREYXRhVGFibGUoZGF0YTogYW55KSB7XHJcbiAgICAvLyAgICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBBcnJheSkge1xyXG4gICAgLy8gICAgICAgICB0aGlzLmRhdGEgPSBkYXRhO1xyXG4gICAgLy8gICAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgIHRoaXMuZGF0YSA9IGRhdGEucmV0dXJuVmFsdWU7XHJcbiAgICAvLyAgICAgfVxyXG4gICAgLy8gICAgIHRoaXMubG9hZERhdGEodGhpcy5kYXRhLCB0aGlzLnNlbGVjdGVkVmFsdWVzLCAoZGF0YUFyciwgdmFsKSA9PiB7XHJcbiAgICAvLyAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTp0cmlwbGUtZXF1YWxzXHJcbiAgICAvLyAgICAgICAgIHJldHVybiBkYXRhQXJyLmZpbmQoZCA9PiBkW3RoaXMuaWRGaWVsZF0gKyAnJyA9PSB2YWwpO1xyXG4gICAgLy8gICAgIH0pO1xyXG4gICAgLy8gICAgIC8vIHRoaXMuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAvLyB9XHJcbiAgICAvLyBsb2FkRGF0YVRyZWUoZGF0YTogYW55KSB7XHJcbiAgICAvLyAgICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBBcnJheSkge1xyXG4gICAgLy8gICAgICAgICB0aGlzLmRhdGEgPSBkYXRhO1xyXG4gICAgLy8gICAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgIHRoaXMuZGF0YSA9IGRhdGEucmV0dXJuVmFsdWU7XHJcbiAgICAvLyAgICAgfVxyXG4gICAgLy8gICAgIHRoaXMubG9hZERhdGEodGhpcy5kYXRhLCB0aGlzLnNlbGVjdGVkVmFsdWVzLCAoZGF0YUFyciwgdmFsKSA9PiB7XHJcbiAgICAvLyAgICAgICAgIHJldHVybiBlYWNoRGF0YShkYXRhQXJyLCB2YWwsIHRoaXMuaWRGaWVsZCk7XHJcbiAgICAvLyAgICAgICAgIGZ1bmN0aW9uIGVhY2hEYXRhKHBhcmFtRGF0YSwgcGFyYW1WYWwsIGlkRmllbGQpIHtcclxuICAgIC8vICAgICAgICAgICAgIGxldCBydG5EYXRhOiBhbnkgPSAnJztcclxuICAgIC8vICAgICAgICAgICAgIHBhcmFtRGF0YS5maW5kKGQgPT4ge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTp0cmlwbGUtZXF1YWxzXHJcbiAgICAvLyAgICAgICAgICAgICAgICAgaWYgKGQuZGF0YVtpZEZpZWxkXSA9PSBwYXJhbVZhbCkge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICBydG5EYXRhID0gZC5kYXRhO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIC8vICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGQuY2hpbGRyZW4gJiYgZC5jaGlsZHJlbi5sZW5ndGgpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgcnRuRGF0YSA9IGVhY2hEYXRhKGQuY2hpbGRyZW4sIHBhcmFtVmFsLCBpZEZpZWxkKTtcclxuICAgIC8vICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICAgICAgfSk7XHJcbiAgICAvLyAgICAgICAgICAgICByZXR1cm4gcnRuRGF0YTtcclxuICAgIC8vICAgICAgICAgfVxyXG4gICAgLy8gICAgIH0pO1xyXG4gICAgLy8gICAgIC8vIHRoaXMuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAvLyB9XHJcbiAgICAvLyBsb2FkTG9va1VwRGF0YVRhYmxlKHJlc0RhdGE6IGFueSkge1xyXG4gICAgLy8gICAgIGlmIChyZXNEYXRhLnJldHVyblZhbHVlKSB7XHJcbiAgICAvLyAgICAgICAgIHJlc0RhdGEgPSByZXNEYXRhLnJldHVyblZhbHVlO1xyXG4gICAgLy8gICAgIH1cclxuICAgIC8vICAgICB0aGlzLmNvbHVtbnMgPSByZXNEYXRhLmNvbHVtbnM7XHJcbiAgICAvLyAgICAgdGhpcy5wYWdlSW5mbyA9IHJlc0RhdGEucGFnZUluZm87XHJcbiAgICAvLyAgICAgdGhpcy5kYXRhID0gcmVzRGF0YS5pdGVtcztcclxuICAgIC8vICAgICB0aGlzLmxvYWREYXRhKHRoaXMuZGF0YSwgdGhpcy5zZWxlY3RlZFZhbHVlcywgKGRhdGFBcnIsIHZhbCkgPT4ge1xyXG4gICAgLy8gICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IHRyaXBsZS1lcXVhbHNcclxuICAgIC8vICAgICAgICAgcmV0dXJuIGRhdGFBcnIuZmluZChkID0+IGRbdGhpcy5pZEZpZWxkXSArICcnID09IHZhbCk7XHJcbiAgICAvLyAgICAgfSk7XHJcbiAgICAvLyAgICAgdGhpcy5jbG9zZUxvYWRpbmcoKTtcclxuICAgIC8vIH1cclxuICAgIC8vIGxvYWRMb29rVXBEYXRhVHJlZShyZXNEYXRhOiBhbnkpIHtcclxuICAgIC8vICAgICBpZiAocmVzRGF0YS5yZXR1cm5WYWx1ZSkge1xyXG4gICAgLy8gICAgICAgICByZXNEYXRhID0gcmVzRGF0YS5yZXR1cm5WYWx1ZTtcclxuICAgIC8vICAgICB9XHJcbiAgICAvLyAgICAgdGhpcy5jb2x1bW5zID0gcmVzRGF0YS5jb2x1bW5zO1xyXG4gICAgLy8gICAgIGNvbnN0IHRyZWVJbmZvID0gcmVzRGF0YS50cmVlSW5mbztcclxuICAgIC8vICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLXN0cmluZy1saXRlcmFsXHJcbiAgICAvLyAgICAgaWYgKCF0cmVlSW5mb1sndHJlZURhdGFJc0luaXQnXSkge1xyXG4gICAgLy8gICAgICAgICBpZiAodHJlZUluZm8ubGF5ZXJUeXBlLnRvTG93ZXJDYXNlKCkgPT09ICdwYXRoY29kZScpIHtcclxuICAgIC8vICAgICAgICAgICAgIHRoaXMuZGF0YSA9IHRoaXMubG9va3VwVXRpbHMubWFrZVRyZWUocmVzRGF0YS5pdGVtcywgdHJlZUluZm8pO1xyXG4gICAgLy8gICAgICAgICB9IGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgICAgdGhpcy5kYXRhID0gdGhpcy5sb29rdXBVdGlscy5tYWtlVHJlZVdpdGhQYXJlbnRJRChcclxuICAgIC8vICAgICAgICAgICAgICAgICByZXNEYXRhLml0ZW1zLFxyXG4gICAgLy8gICAgICAgICAgICAgICAgICcnLFxyXG4gICAgLy8gICAgICAgICAgICAgICAgIGAke3RyZWVJbmZvLmRhdGFGaWVsZH0uJHt0cmVlSW5mby5wYXJlbnRGaWVsZH1gLFxyXG4gICAgLy8gICAgICAgICAgICAgICAgIHRoaXMuaWRGaWVsZFxyXG4gICAgLy8gICAgICAgICAgICAgKTtcclxuICAgIC8vICAgICAgICAgfVxyXG4gICAgLy8gICAgIH1cclxuICAgIC8vICAgICB0aGlzLmxvYWREYXRhKHRoaXMuZGF0YSwgdGhpcy5zZWxlY3RlZFZhbHVlcywgKGRhdGFBcnIsIHZhbCkgPT4ge1xyXG4gICAgLy8gICAgICAgICByZXR1cm4gZWFjaERhdGEoZGF0YUFyciwgdmFsLCB0aGlzLmlkRmllbGQpO1xyXG4gICAgLy8gICAgICAgICBmdW5jdGlvbiBlYWNoRGF0YShwYXJhbURhdGEsIHBhcmFtVmFsLCBpZEZpZWxkKSB7XHJcbiAgICAvLyAgICAgICAgICAgICBsZXQgcnRuRGF0YTogYW55ID0gJyc7XHJcbiAgICAvLyAgICAgICAgICAgICBwYXJhbURhdGEuZmluZChkID0+IHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dHJpcGxlLWVxdWFsc1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIGlmIChkLmRhdGFbaWRGaWVsZF0gPT0gcGFyYW1WYWwpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgcnRuRGF0YSA9IGQuZGF0YTtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkLmNoaWxkcmVuICYmIGQuY2hpbGRyZW4ubGVuZ3RoKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgIHJ0bkRhdGEgPSBlYWNoRGF0YShkLmNoaWxkcmVuLCBwYXJhbVZhbCwgaWRGaWVsZCk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICAgICAgIH0pO1xyXG4gICAgLy8gICAgICAgICAgICAgcmV0dXJuIHJ0bkRhdGE7XHJcbiAgICAvLyAgICAgICAgIH1cclxuICAgIC8vICAgICB9KTtcclxuICAgIC8vICAgICB0aGlzLmNsb3NlTG9hZGluZygpO1xyXG4gICAgLy8gfVxyXG4gICAgLy8gcHJpdmF0ZSBzaG93TG9hZGluZygpIHtcclxuICAgIC8vICAgICB0aGlzLmxvYWRpbmcgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcclxuICAgIC8vIH1cclxuICAgIC8vIGNsb3NlTG9hZGluZygpIHtcclxuICAgIC8vICAgICBpZiAodGhpcy5sb2FkaW5nKSB7XHJcbiAgICAvLyAgICAgICAgIHRoaXMubG9hZGluZy5jbG9zZSgpO1xyXG4gICAgLy8gICAgICAgICB0aGlzLmxvYWRpbmcgPSBudWxsO1xyXG4gICAgLy8gICAgIH1cclxuICAgIC8vIH1cclxufVxyXG4iXX0=