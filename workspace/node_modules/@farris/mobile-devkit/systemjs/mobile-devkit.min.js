System.register(["rxjs","rxjs/operators","axios","reflect-metadata","date-fns","dayjs","@farris/expression-engine"],(function(t){"use strict";var e,n,i,r,o,a,s,u,p,c,l,h,f,d,y,g,v,m,E,b,C,x,P,w,M,I,S,O;return{setters:[function(t){e=t.of,n=t.from,i=t.Observable,r=t.isObservable,o=t.forkJoin,a=t.BehaviorSubject,s=t.EMPTY,u=t.Subject},function(t){p=t.switchMap,c=t.map,l=t.shareReplay,h=t.tap,f=t.catchError,d=t.concatMap,y=t.every,g=t.take,v=t.throwIfEmpty,m=t.takeLast},function(t){E=t.default},function(){},function(t){b=t.format,C=t.parseISO,x=t.isDate,P=t.isEqual,w=t.compareAsc},function(t){M=t.default},function(t){I=t.Expression,S=t.ExpressionEngine,O=t.ExpressionContext}],execute:function(){t({BackEndMessage:void 0,BindingPropertyType:void 0,BindingType:void 0,ChangeType:void 0,CommandHandlerExtenderMeta:function(t){return Mt(Oe,(function(t){return t}))(t)},CommandHandlerMeta:function(t){return Mt(Se,(function(t){return t}))(t)},DataChangeType:void 0,DataPathNodeType:void 0,DataPropGroup:void 0,EntityFactory:ve,EntityMeta:function(t){return Mt(ue,(function(t){return t}))(t)},Expression:void 0,INJECTOR_IMPL__PRE_R3__:Et,InjectFlags:void 0,ModifyType:void 0,RepositoryMeta:function(t){return Mt(Ce,(function(t){return t}))(t)},ViewChangeType:void 0,createEntities:ge,createEntity:ye,createInjectionToken:et,createInjector:Ct,isType:function(t){return"function"==typeof t},makeDecorator:Mt,makeParamDecorator:function(t,e,n){var i=It(e);function r(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];if(this instanceof r)return i.apply(this,e),this;var o=new((t=r).bind.apply(t,_([void 0],e)));return a.annotation=o,a;function a(t,e,n){for(var i=t.hasOwnProperty(Pt)?t[Pt]:Object.defineProperty(t,Pt,{value:[]})[Pt];i.length<=n;)i.push(null);return(i[n]=i[n]||[]).push(o),t}}n&&(r.prototype=Object.create(n.prototype));return r.prototype.ngMetadataName=t,r.annotationCls=r,r},makePropDecorator:St,setCurrentInjector:ht,"ɵa":G,"ɵc":et});var T=function(t,e){return(T=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function j(t,e){function n(){this.constructor=t}T(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var D=function(){return(D=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function N(t,e){var n,i,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,i=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=a.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function R(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],i=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function V(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var i,r,o=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)a.push(i.value)}catch(t){r={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return a}function _(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(V(arguments[e]));return t}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function A(t){var e={exports:{}};return t(e,e.exports),e.exports}var B=A((function(t,e){t.exports=function(t,e,n){e.prototype.isBetween=function(t,e,i,r){var o=n(t),a=n(e),s="("===(r=r||"()")[0],u=")"===r[1];return(s?this.isAfter(o,i):!this.isBefore(o,i))&&(u?this.isBefore(a,i):!this.isAfter(a,i))||(s?this.isBefore(o,i):!this.isAfter(o,i))&&(u?this.isAfter(a,i):!this.isBefore(a,i))}}})),F=A((function(t,e){t.exports=function(t,e,n){t=t||{};var i=e.prototype,r={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function o(t,e,n,r){return i.fromToBase(t,e,n,r)}n.en.relativeTime=r,i.fromToBase=function(e,i,o,a,s){for(var u,p,c,l=o.$locale().relativeTime||r,h=t.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],f=h.length,d=0;d<f;d+=1){var y=h[d];y.d&&(u=a?n(e).diff(o,y.d,!0):o.diff(e,y.d,!0));var g=(t.rounding||Math.round)(Math.abs(u));if(c=u>0,g<=y.r||!y.r){g<=1&&d>0&&(y=h[d-1]);var v=l[y.l];s&&(g=s(""+g)),p="string"==typeof v?v.replace("%d",g):v(g,i,y.l,c);break}}if(i)return p;var m=c?l.future:l.past;return"function"==typeof m?m(p):m.replace("%s",p)},i.to=function(t,e){return o(t,e,this,!0)},i.from=function(t,e){return o(t,e,this)};var a=function(t){return t.$u?n.utc():n()};i.toNow=function(t){return this.to(a(this),t)},i.fromNow=function(t){return this.from(a(this),t)}}})),L=A((function(t,e){t.exports=function(t,e,n){var i="h:mm A",r={lastDay:"[Yesterday at] "+i,sameDay:"[Today at] "+i,nextDay:"[Tomorrow at] "+i,nextWeek:"dddd [at] "+i,lastWeek:"[Last] dddd [at] "+i,sameElse:"MM/DD/YYYY"};e.prototype.calendar=function(t,e){var i=e||this.$locale().calendar||r,o=n(t||void 0).startOf("d"),a=this.diff(o,"d",!0),s="sameElse",u=a<-6?s:a<-1?"lastWeek":a<0?"lastDay":a<1?"sameDay":a<2?"nextDay":a<7?"nextWeek":s,p=i[u]||r[u];return"function"==typeof p?p.call(this,n()):this.format(p)}}}));A((function(t,e){t.exports=function(t){function e(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var n=e(t),i={name:"zh-cn",weekdays:"星期日_星期一_星期二_星期三_星期四_星期五_星期六".split("_"),weekdaysShort:"周日_周一_周二_周三_周四_周五_周六".split("_"),weekdaysMin:"日_一_二_三_四_五_六".split("_"),months:"一月_二月_三月_四月_五月_六月_七月_八月_九月_十月_十一月_十二月".split("_"),monthsShort:"1月_2月_3月_4月_5月_6月_7月_8月_9月_10月_11月_12月".split("_"),ordinal:function(t,e){switch(e){case"W":return t+"周";default:return t+"日"}},weekStart:1,yearStart:4,formats:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY/MM/DD",LL:"YYYY年M月D日",LLL:"YYYY年M月D日Ah点mm分",LLLL:"YYYY年M月D日ddddAh点mm分",l:"YYYY/M/D",ll:"YYYY年M月D日",lll:"YYYY年M月D日 HH:mm",llll:"YYYY年M月D日dddd HH:mm"},relativeTime:{future:"%s内",past:"%s前",s:"几秒",m:"1 分钟",mm:"%d 分钟",h:"1 小时",hh:"%d 小时",d:"1 天",dd:"%d 天",M:"1 个月",MM:"%d 个月",y:"1 年",yy:"%d 年"},meridiem:function(t,e){var n=100*t+e;return n<600?"凌晨":n<900?"早上":n<1100?"上午":n<1300?"中午":n<1800?"下午":"晚上"}};return n.default.locale(i,null,!0),i}(M)}));var k,H;t("Type",Function);!function(t){t[t.Add=0]="Add",t[t.Delete=1]="Delete",t[t.Edit=2]="Edit",t[t.Append=3]="Append"}(k||(k=t("DataChangeType",{}))),function(t){t[t.Default=0]="Default",t[t.Self=1]="Self",t[t.SkipSelf=2]="SkipSelf",t[t.Optional=4]="Optional"}(H||(H=t("InjectFlags",{})));var K=[],U=function(t){return t},q=U,Y=function(){return Array.prototype.slice.call(arguments)},J=/\n/gm,z={};function W(t){if("string"==typeof t)return t;if(Array.isArray(t))return"["+t.map(W).join(", ")+"]";if(null==t)return""+t;if(t.overriddenName)return""+t.overriddenName;if(t.name)return""+t.name;var e=t.toString();if(null==e)return""+e;var n=e.indexOf("\n");return-1===n?e:e.substring(0,n)}function G(t){for(var e in t)if(t[e]===G)return e;throw Error("Could not find renamed property on target object.")}function $(t,e){return new Error(function(t,e,n,i){void 0===i&&(i=null),t=t&&"\n"===t.charAt(0)&&"ɵ"==t.charAt(1)?t.substr(2):t;var r=W(e);if(Array.isArray(e))r=e.map(W).join(" -> ");else if("object"==typeof e){var o=[];for(var a in e)if(e.hasOwnProperty(a)){var s=e[a];o.push(a+":"+("string"==typeof s?JSON.stringify(s):W(s)))}r="{"+o.join(", ")+"}"}return n+(i?"("+i+")":"")+"["+r+"]: "+t.replace(J,"\n  ")}(t,e,"StaticInjectorError"))}var X=G({"ɵprov":G});G({"ɵinj":G});var Z=G({ngInjectableDef:G});function Q(t,e){return e&&e.token===t?e:null}var tt=t("InjectionToken",function(){function t(t,e){var n;this._desc=t,this.ngMetadataName="InjectionToken",this.ɵprov=void 0,"number"==typeof e?this.__NG_ELEMENT_ID__=e:void 0!==e&&(this.ɵprov={token:(n={token:this,providedIn:e.providedIn||"root",factory:e.factory}).token,providedIn:n.providedIn||null,factory:n.factory,value:void 0})}return t.prototype.toString=function(){return"InjectionToken "+this._desc},t}());function et(t){return new tt(t)}var nt,it=(t({Injector:nt=function(){},"ɵb":nt}),nt),rt=new(function(){function t(){}return t.prototype.get=function(t,e){if(void 0===e&&(e=z),e===z){var n=new Error("NullInjectorError: No provider for "+W(t)+"!");throw n.name="NullInjectorError",n}return e},t}()),ot=G({__forward_ref__:G});function at(t){return"function"==typeof(e=t)&&e.hasOwnProperty(ot)&&e.__forward_ref__===st?t():t;var e}function st(t){return t.__forward_ref__=st,t.toString=function(){return W(this())},t}var ut=t("INJECTOR",new tt("INJECTOR",-1)),pt=t("ɵ0",G),ct=t("USE_VALUE",G({provide:String,useValue:pt})),lt=void 0;function ht(t){var e=lt;return lt=t,e}var ft=t("StaticInjector",function(){function t(t,e,n){void 0===e&&(e=rt),void 0===n&&(n=null),e=e||rt,this.parent=e,this.source=n;var i=this._records=new Map;i.set(it,{token:it,fn:U,deps:K,value:this,useNew:!1}),i.set(ut,{token:ut,fn:U,deps:K,value:this,useNew:!1}),this.scope=gt(i,t)}return t.prototype.get=function(t,e,n){void 0===n&&(n=H.Default);var i,r=this._records,o=r.get(t);if(void 0===o){var a=Q(i=t,i[X])||Q(i,i[Z]);if(a){var s=a&&a.providedIn;("any"===s||null!=s&&s===this.scope)&&r.set(t,o=vt({provide:t,useFactory:a.factory,deps:K}))}void 0===o&&r.set(t,null)}var u=ht(this);try{return mt(t,o,r,this.parent,e,n)}catch(t){throw t}finally{ht(u)}},t.prototype.toString=function(){var t=[];return this._records.forEach((function(e,n){return t.push(W(n))})),"StaticInjector["+t.join(", ")+"]"},t}());function dt(t){return $("Cannot mix multi providers and regular providers",t)}var yt=t("INJECTOR_SCOPE",new tt("Set Injector scope."));function gt(t,e){var n=null;if(e)if(e=at(e),Array.isArray(e))for(var i=0;i<e.length;i++)n=gt(t,e[i])||n;else{if("function"==typeof e)throw $("Function/Class not supported",e);if(!e||"object"!=typeof e||!e.provide)throw $("Unexpected provider",e);var r=at(e.provide),o=vt(e);if(!0===e.multi){var a=t.get(r);if(a){if(a.fn!==Y)throw dt(r)}else t.set(r,a={token:e.provide,deps:[],useNew:!1,fn:Y,value:K});r=e,a.deps.push({token:r,options:6})}var s=t.get(r);if(s&&s.fn===Y)throw dt(r);r===yt&&(n=o.value),t.set(r,o)}return n}function vt(t){var e=function(t){var e=K,n=t.deps;if(n&&n.length){e=[];for(var i=0;i<n.length;i++){var r=6,o=at(n[i]);e.push({token:o,options:r})}}else if(t.useExisting){e=[{token:o=at(t.useExisting),options:6}]}else if(!n&&!(ct in t))throw $("'deps' required",t);return e}(t),n=U,i=K,r=!1,o=at(t.provide);if(ct in t)i=t.useValue;else if(t.useFactory)n=t.useFactory;else if(t.useExisting);else if(t.useClass)r=!0,n=at(t.useClass);else{if("function"!=typeof o)throw $("StaticProvider does not have [useValue|useFactory|useExisting|useClass] or [provide] is not newable",t);r=!0,n=o}return{deps:e,fn:n,useNew:r,value:i}}function mt(t,e,n,i,r,o){try{return function(t,e,n,i,r,o){var a,s;if(!e||o&H.SkipSelf)s=o&H.Self?o&H.Optional?rt.get(t,void 0!==r?r:null):rt.get(t,r):i.get(t,r,H.Default);else{if((s=e.value)===q)throw Error("ɵCircular dependency");if(s===K){e.value=q;var u=e.useNew,p=e.fn,c=e.deps,l=K;if(c.length){l=[];for(var h=0;h<c.length;h++){var f=c[h],d=f.options,y=2&d?n.get(f.token):void 0;l.push(mt(f.token,y,n,y||4&d?i:rt,1&d?null:z,H.Default))}}e.value=s=u?new((a=p).bind.apply(a,_([void 0],l))):p.apply(void 0,l)}}return s}(t,e,n,i,r,o)}catch(n){throw n instanceof Error||(n=new Error(n)),(n.ngTempTokenPath=n.ngTempTokenPath||[]).unshift(t),e&&e.value===q&&(e.value=K),n}}function Et(t,e,n){return new ft(t,e,n)}var bt=t("INJECTOR_IMPL",Et);function Ct(t,e){return Array.isArray(t)?bt(t,e,""):bt(t.providers,t.parent,t.name||"")}var xt=t("ANNOTATIONS","__annotations__"),Pt=t("PARAMETERS","__parameters__"),wt=t("PROP_METADATA","__prop__metadata__");function Mt(t,e,n,i,r){var o=It(e);function a(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];if(this instanceof a)return o.call.apply(o,_([this],e)),this;var s=new((t=a).bind.apply(t,_([void 0],e))),u=function(t){return r&&r.apply(void 0,_([t],e)),(t.hasOwnProperty(xt)?t[xt]:Object.defineProperty(t,xt,{value:[]})[xt]).push(s),t};return i&&i(u),u}return n&&(a.prototype=Object.create(n.prototype)),a.prototype.ngMetadataName=t,a.annotationCls=a,a}function It(t){return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];if(t){var i=t.apply(void 0,_(e));for(var r in i)this[r]=i[r]}}}function St(t,e,n){var i=It(e);function r(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];if(this instanceof r)return i.apply(this,e),this;var o=new((t=r).bind.apply(t,_([void 0],e)));return function(t,e){var n=t.constructor,i=n.hasOwnProperty(wt)?n[wt]:Object.defineProperty(n,wt,{value:{}})[wt];i[e]=i.hasOwnProperty(e)&&i[e]||[],i[e].unshift(o)}}return n&&(r.prototype=Object.create(n.prototype)),r.prototype.ngMetadataName=t,r.annotationCls=r,r}var Ot,Tt=t("MetadataUtil",function(){function t(){}return t.getClassMetadatas=function(t){return t[xt]},t.getClassMetadataByName=function(t,e){return this.getClassMetadataByNameWithTranslate(t,e,null,null)},t.getClassMetadataByNameWithTranslate=function(t,e,n,i){var r=this.getClassMetadatas(t);if(!r)return null;var o=r.find((function(t){return t.ngMetadataName===e}));return o&&n&&i&&i.forEach((function(t){var e=o[t];if(e&&e.startsWith("{{")&&e.endsWith("}}")){var i=e.replace("{{","").replace("}}","").trim();o[t]=n.transform(i,null)}})),o},t.getPropsMetadatas=function(t){return t[wt]},t.getPropsMetadatasByName=function(t,e){return this.getPropsMetadatasByNameWithTranslate(t,e)},t.getPropsMetadatasByNameWithTranslate=function(t,e,n,i){var r={},o=this.getPropsMetadatas(t);return o?(Object.keys(o).forEach((function(t){var a=o[t].find((function(t){return t.ngMetadataName===e}));n&&i&&i.forEach((function(t){var e=a[t];if(e&&e.startsWith("{{")&&e.endsWith("}}")){var i=e.replace("{{","").replace("}}","").trim();a[t]=n.transform(i,null)}})),a&&(r[t]=a)})),r):r},t.getPropMetadatasByName=function(t,e){return null},t.getPropMetadataByName=function(t,e,n){return null},t}()),jt=(t("HttpMethods",function(){function t(){}return t.GET="GET",t.DELETE="DELETE",t.HEAD="HEAD",t.OPTIONS="OPTIONS",t.POST="POST",t.PUT="PUT",t.PATCH="PATCH",t.LINK="LINK",t.UNLINK="UNLINK",t}()),t("HttpUtil",function(){function t(){}return t.appendHeader=function(t,e,n){var i;return t=Object.assign({},t,((i={})[e]=n,i))},t.appendBodyToRequestConfig=function(t,e){return e||(e={}),e=Object.assign({},e,{body:t})},t.buildAxiosRequestConfig=function(t,e,n){return{url:e,method:t,params:(n=n||{}).params||null,headers:n.headers||null,responseType:n.responseType||"json",data:n.body||null}},t.buildHttpResponse=function(t){return{body:t.data,headers:t.headers,status:t.status,statusText:t.statusText}},t}())),Dt=t("HttpClient",function(){function t(){this.axiosInstance=E.create()}return t.prototype.get=function(t,e){return this.request("GET",t,e)},t.prototype.post=function(t,e,n){return n=jt.appendBodyToRequestConfig(e,n),this.request("POST",t,n)},t.prototype.put=function(t,e,n){return n=jt.appendBodyToRequestConfig(e,n),this.request("PUT",t,n)},t.prototype.patch=function(t,e,n){return n=jt.appendBodyToRequestConfig(e,n),this.request("PATCH",t,n)},t.prototype.delete=function(t,e){return this.request("DELETE",t,e)},t.prototype.request=function(t,i,r){var o=this;return e(!0).pipe(p((function(){var e=jt.buildAxiosRequestConfig(t,i,r);return n(o.axiosInstance.request(e))}))).pipe(c((function(t){var e=jt.buildHttpResponse(t);return"response"===r.observe?e:t.data})))},t}()),Nt=t("HTTP_PROVIDERS",[{provide:Dt,useClass:Dt,deps:[]}]),Rt=t("Modification",(function(t,e,n,i,r){this.type=e,this.value=t,this.preValue=i,this.path=n,this.position=r}));function Vt(t,e){return JSON.stringify(t)===JSON.stringify(e)}!function(t){t.Add="ADD",t.AddData="AddData",t.Clone="CLONE",t.Remove="REMOVE",t.RemoveData="RemoveData",t.ValueChange="VALUE_CHANGE",t.Load="LOAD",t.UnChanged="UNCHANGED",t.PaginationInfoChange="PAGINATION_INFO_CHANGE",t.Insert="Insert",t.Update="UPDATE"}(Ot||(Ot=t("ModifyType",{})));var _t,At=t("ChangeSet",function(){function t(){this.modifications=[]}return Object.defineProperty(t.prototype,"changes",{get:function(){return this.modifications},enumerable:!0,configurable:!0}),t.prototype.append=function(t){switch(t.type){case Ot.ValueChange:this.appendValueChangeModification(t);break;case Ot.Add:case Ot.Insert:case Ot.Clone:this.appendAddModification(t);break;case Ot.Remove:this.appendRemoveModification(t);break;case Ot.Load:break;default:throw new Error("不支持此类型的变更")}},t.prototype.appendValueChangeModification=function(t){var e=t.value,n=this.findModifyItemsPath(t.path);if(n)n.value=e;else{var i=this.findNewAddItemsPath(t.path);i?i.value=Object.assign({},i.value,e):this.modifications.push(t)}},t.prototype.appendAddModification=function(t){var e=t.value,n=this.findNewAddItemsPath(t.path);n?n.value=n.value.concat(e):this.modifications.push(t)},t.prototype.appendRemoveModification=function(t){var e=t.path,n=Object.keys(t.value)[0],i=t.value[n];this.modifications.forEach((function(t){t.type!==Ot.Add&&t.type!==Ot.Insert&&t.type!==Ot.Clone||!1!==Vt(t.path,e)&&(t.value=t.value.filter((function(t){return t[n]!==i})))}));var r=e.concat(n+":"+i);this.modifications=this.modifications.filter((function(t){if(t.type!==Ot.ValueChange)return!0;var e=Array.from(t.path);return e.pop(),!Vt(e,r)})),this.removeDescendantRemoveModifications(t),this.modifications.push(t)},t.prototype.clear=function(){this.modifications=[]},t.prototype.findNewAddItemsPath=function(t){return this.modifications.find((function(e,n){return Vt(t,e.path)&&(e.type===Ot.Add||e.type===Ot.Insert||e.type===Ot.Clone)}))},t.prototype.findModifyItemsPath=function(t){return this.modifications.find((function(e,n){return Vt(t,e.path)&&e.type===Ot.ValueChange}))},t.prototype.removeDescendantRemoveModifications=function(t){var e=this,n=this.createRemovePathWithId(t);this.modifications=this.modifications.filter((function(t){if(t.type!==Ot.Remove)return!0;var i=e.createRemovePathWithId(t);return!e.isDescendantPath(n,i)}))},t.prototype.createRemovePathWithId=function(t){var e=t.path,n=Object.keys(t.value)[0],i=t.value[n];return e.concat([n+":"+i])},t.prototype.isDescendantPath=function(t,e){if(t.length>e.length)return!1;var n=!0;return t.forEach((function(t,i){t===e[i]||(n=!1)})),n},t}());!function(t){t.DataId="DataId",t.PropName="PropName"}(_t||(_t=t("DataPathNodeType",{})));var Bt,Ft=t("DataPathNode",(function(t,e){this.type=t,this.value=e,this.prev=null,this.next=null})),Lt=t("DataPath",function(){function t(){this.head=new Ft(null,null),this.length=0}return t.prototype.unshift=function(t,e){var n=new Ft(t,e);n.next=this.head.next,n.prev=this.head,this.head.next=n,n.next&&(n.next.prev=n),this.length++},t.prototype.push=function(t,e){var n=this.getTail(),i=new Ft(t,e);n.next=i,this.length++},t.prototype.getTail=function(){for(var t=this.head;t.next;)t=t.next;return t},t.prototype.toArray=function(){for(var t=[],e=this.head.next;e;)t.push(e.type+":"+e.value),e=e.next;return t},t.prototype.toString=function(){return"["+this.toArray().join(", ")+"]"},t.prototype.clone=function(){for(var e=new t,n=this.head.next;n;)e.push(n.type,n.value),n=n.next;return e},t}());!function(t){t.Primitive="Primitive",t.Object="Object",t.Dynamic="Dynamic",t.List="List"}(Bt||(Bt=t("DataPropGroup",{})));t("DataPropInfo",(function(){}));var kt=t("PRIMITIVE_PROP_META","PrimitivePropMeta");t("PrimitivePropMeta",St(kt,(function(t){var e={primary:!1,foreign:!1};if(t)switch(typeof t){case"boolean":e.primary=Boolean(t);break;case"string":e.dataField=String(t);break;case"object":e=Object.assign(e,t)}return e}))),t("StringUtil",function(){function t(){}return t.format=function(t,e){var n=e.maxLenght,i=e.prefix,r=void 0===i?"":i,o=e.suffix,a=void 0===o?"":o,s=e.ellipsis,u=void 0===s?"...":s;return n&&t?n&&t.length>n?r+(t=t.slice(0,n))+a+u:r+t+a:t},t.filterSearchValue=function(t,e){if(null==t||null==t||""==t)return t;if(t=t.trim(),null==e||null==e||""==e)return t=t.replace(/[<>&"]/g,(function(t){return{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[t]}));if(e&&""==e.text)return"<p>"+(t=t.replace(/[<>&"]/g,(function(t){return{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[t]})))+"</p>";if("string"==typeof e){var n=new RegExp(""+e,"g");return"<p>"+t.replace(n,"##s1p1##"+e+"##s2p2##").replace(/[<>&"]/g,(function(t){return{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[t]})).replace(/##s1p1##/g,'<span style="color:red">').replace(/##s2p2##/g,"</span>")+"</p>"}if("object"==typeof e){var i=e.text,r=e.style;n=new RegExp(""+i,"g");return"<p>"+t.replace(n,"##s1p1##"+r+"##s2p2##"+i+"##s3p3##").replace(/[<>&"]/g,(function(t){return{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[t]})).replace(/##s1p1##/g,'<span style="').replace(/##s2p2##/g,'">').replace(/##s3p3##/g,"</span>")+"</p>"}},t}()),t("NumberUtil",function(){function t(){}return t.format=function(t,e){var n,i=e.precision||0===e.precision?e.precision:2,r=e.decimal||".",o=e.thousand||"",a=e.prefix||"",s=e.suffix||"";"dynamic"==e.prefixType&&e.prefix&&(a=new Function("return "+e.prefix)()(e.sourceData));t=(t+"").replace(/[^0-9+-Ee.]/g,"");var u,p,c;if(n=(i||0===i?(u=t,p=i,c=Math.pow(10,p),""+parseFloat(Math.round(parseFloat((u*c).toFixed(2*p))).toFixed(2*p))/c):""+Math.round(t)).split("."),o){for(var l=/(-?\d+)(\d{3})/;l.test(n[0]);)n[0]=n[0].replace(l,"$1"+o+"$2");(n[1]||"").length<i&&(n[1]=n[1]||"",n[1]+=new Array(i-n[1].length+1).join("0"))}var h=n.join(r);return h=""+a+h+s},t}()),t("BoolUtil",function(){function t(){}return t.format=function(t,e){return!0===t?"是":"否"},t}()),t("EnumUtil",function(){function t(){}return t.format=function(t,e){var n=e.separator,i=e.enumData,r=[];if(t&&n&&(r=t.split(n)),r.length>1)return r.map((function(t){var e=i.find((function(e){return e.value===t}));return e?e.name:(console.error("找不到"+t+"对应的枚举选项"),t)})).join(n);var o=i.find((function(e){return e.value===t}));return o?o.name:(console.error("找不到"+t+"对应的枚举选项"),t)},t}());M.locale("zh-cn");var Ht,Kt,Ut,qt=t("DateUtil",function(){function t(){}return t.formatISO=function(t){if(!0===this.isEmptyDateOrDateString(t))return this.emptyISODateTimeString;var e=this.parse(t);return b(e,this.defaultISOFormat)},t.format=function(t,e){if(!0===this.isEmptyDateOrDateString(t))return this.emptyISODateTimeString;var n=this.parse(t);return e=e||this.defaultDisplayFormat,b(n,e)},t.dateShow=function(t,e){return!0===this.isEmptyDateOrDateString(t)?this.emptyISODateTimeString:e&&""!==e?this[e]&&this[e](t):void 0},t.dateOperation=function(t,e){if(!0===this.isEmptyDateOrDateString(t))return this.emptyISODateTimeString;var n=e.type,i=void 0===n?"":n,r=e.option;return i&&""!==i?"isSame"===i||"isBefore"===i||"isAfter"===i?this[i]&&this[i](t,e.targetDate,e.granularity):"isBetween"===i?this[i]&&this[i](t,e.targetDate,e.targetDate2,e.granularity,e.contains):r?this[i]&&this[i](t,r):this[i]&&this[i](t):void 0},t.relativeTime=function(t,e){M.extend(F);var n=M(t);return e?M(n).fromNow(e):M(n).fromNow()},t.isToday=function(t){var e=new Date,n=M(t);return this.isSame(n,e,"date")},t.calendar=function(t,e){var n=M(t);return M.extend(L),e?M().calendar(n,D({},e)):M().calendar(n,{sameDay:"[今天] HH:mm",nextDay:"[明天] HH:mm",lastDay:"[昨天] HH:mm",sameElse:"YYYY-MM-DD"})},t.parse=function(t){return!0===this.isEmptyDateOrDateString(t)?null:!0===this.isDate(t)?t:C(t)},t.isDate=function(t){return x(t)},t.isEmptyDateOrDateString=function(t){return!0===this.isDate(t)?this.isEmptyDate(t):this.isEmptyDateString(t)},t.isEmptyDate=function(t){return!t},t.isEmptyDateString=function(t){return!t||!0===t.startsWith("0001-01-01")},t.isEqual=function(t,e){var n=this.parse(t),i=this.parse(e);return n===i||P(n,i)},t.compare=function(t,e){var n=this.parse(t),i=this.parse(e);return!0===this.isEqual(n,i)?0:n||!0!==this.isDate(i)?i||!0!==this.isDate(n)?w(n,i):1:-1},t.isSame=function(t,e,n){return n?M(t).isSame(M(e),n):M(t).isSame(M(e))},t.isBefore=function(t,e,n){return n?M(t).isBefore(M(e),n):M(t).isBefore(M(e))},t.isAfter=function(t,e,n){return n?M(t).isAfter(M(e),n):M(t).isAfter(M(e))},t.isBetween=function(t,e,n,i,r){return M.extend(B),i?M(t).isBetween(M(e),M(n),i,r):M(t).isBetween(M(e),M(n),null,r)},t.emptyDateTimeString=null,t.emptyISODateTimeString=null,t.defaultISOFormat="yyyy-MM-dd'T'HH:mm:ssxxx",t.defaultDisplayFormat="yyyy-MM-dd HH:mm:ss",t.defaultDateFormat="yyyy-MM-dd",t.defaultTimeFormat="HH:mm:ss",t}()),Yt=t("ArrayUtil",function(){function t(){}return t.remove=function(t,e){var n=t.findIndex((function(t){return t===e}));this.removeByIndex(t,n)},t.removeByIndex=function(t,e){!t||t[e],t.splice(e,1)},t}()),Jt=t("ObjectUtil",function(){function t(){}return t.isPlainObject=function(t){if("object"!=typeof t||null===t||"[object Object]"!==Object.prototype.toString.call({}))return!1;if(null===Object.getPrototypeOf(t))return!0;for(var e=t;null!==Object.getPrototypeOf(e);)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e},t}()),zt=t("BindingPathConverter",function(){function t(){}return t.toBindingPathArray=function(t){return"string"==typeof t?t.split("/").filter((function(t){return""!==t})):t.concat([])},t.toBindingPathString=function(t){return"/"+t.join("/")},t}());t("BindingPathComparer",function(){function t(){}return t.isEqual=function(t,e){var n=zt.toBindingPathArray(t),i=zt.toBindingPathArray(e);return n.every((function(t,e){return t===i[e]}))},t.isParent=function(t,e){var n=zt.toBindingPathArray(t),i=zt.toBindingPathArray(e);if(n.length===i.length+1)return this.isAncestor(t,e)},t.isAncestor=function(t,e){var n=zt.toBindingPathArray(t),i=zt.toBindingPathArray(e);return!(t.length<=i.length)&&i.every((function(t,e){return t===n[e]}))},t}()),t("BindingPathTraverser",function(){function t(){}return t.getLeafPathString=function(t){return zt.toBindingPathArray(t).pop()},t.getParentPathString=function(t){var e=zt.toBindingPathArray(t);return e.pop(),"/"+e.join("/")},t}());!function(t){t.Load="Load",t.Append="Append",t.Remove="Remove",t.Swap="Swap",t.SelectionChanged="SelectionChanged",t.ValueChanged="ValueChanged",t.UpdateErrors="UpdateErrors",t.GlobalSelectionChanged="GlobalSelectionChanged",t.PaginationInfoChange="PaginationInfoChange"}(Ht||(Ht=t("ChangeType",{}))),function(t){t[t.ValueChanged=0]="ValueChanged"}(Kt||(Kt=t("ViewChangeType",{}))),function(t){t.Plain="Plain",t.Object="Object",t.List="List",t.Dynamic="Dynamic"}(Ut||(Ut=t("BindingPropertyType",{})));var Wt=t("PropertyUtil",function(){function t(){}return t.getProperties=function(t){var e=[],n=pe.getNgFields(t);Object.keys(n).forEach((function(t){var i=n[t];e.push({name:t,type:Ut.Plain,isPrimaryKey:i.primary,isForeignKey:i.foreign,enableMultiLangInput:i.enableMultiLangInput})}));var i=pe.getNgObjects(t);Object.keys(i).forEach((function(t){var n=i[t];e.push({name:t,type:Ut.Object,entityType:n.type})}));var r=pe.getNgList(t);Object.keys(r).forEach((function(t){var n=r[t];e.push({name:t,type:Ut.List,entityType:n.type})}));var o=pe.getNgDynamic(t);return Object.keys(o).forEach((function(t){var n=o[t];e.push({name:t,type:Ut.Dynamic,entityType:n.type})})),e},t.getDynamicProperties=function(t){var e=[];return Object.keys(t).forEach((function(n){t.hasOwnProperty(n)&&(t[n]instanceof Object?e.push({name:n,type:Ut.Dynamic,entityType:null}):e.push({name:n,type:Ut.Plain,isPrimaryKey:!1,isForeignKey:!1}))})),e},t.getPropertyByName=function(t,e){return t.find((function(t){return t.name===e}))},t.getPrimaryKey=function(t){var e=t.find((function(t){return!0===t.isPrimaryKey}));return e?e.name:""},t}()),Gt=t("BindingObject",function(){function t(t){this.isShowValidationMsg=!1,this.controlMap={},this.properties=t,this.primaryKey=Wt.getPrimaryKey(t),this.innerValues=new Map,this.changes=new u,this.viewChanges=new u}return Object.defineProperty(t.prototype,"primaryKeyValue",{get:function(){return this.primaryKey?this.getValue(this.primaryKey):""},enumerable:!0,configurable:!0}),t.prototype.setShowValidationMsg=function(t){this.isShowValidationMsg=t},t.prototype.getValue=function(t){return this.innerValues.get(t)},t.prototype.setValue=function(t,n,i,r,o,a){var s=this;void 0===i&&(i=!1),void 0===r&&(r=!1);var u=this.getValue(t);u!==n&&(a&&u!==n||(a=function(t,n,i){return e(!0)}),!0===r?a(u,n,!1).subscribe((function(e){if(e){s.innerValues=s.innerValues.set(t,n);var r={type:Kt.ValueChanged,path:[t],value:n,errors:o};s.viewChanges.next(r),!0===i&&s.changes.next({type:Ht.ValueChanged,path:[t],value:n,id:s.primaryKeyValue,errors:o}),a(u,n,!0).subscribe()}else s.changes.next({type:Ht.ValueChanged,path:[t],value:u,id:s.primaryKeyValue,errors:o})})):(this.innerValues=this.innerValues.set(t,n),!0===i&&this.changes.next({type:Ht.ValueChanged,path:[t],value:n,id:this.primaryKeyValue,errors:o}),a(u,n,!0).subscribe()))},t.prototype.toJSON=function(t){var e=this,n=window.localStorage.getItem("languageCode")||"zh-CHS",i={};return this.properties.forEach((function(r){var o=r.name;if(r.type===Ut.List){var a=e[o];i[o]=a.toJSON(t)}else if(r.type===Ut.Object){var s=e[o];i[o]=s.toJSON(t)}else if(r.type===Ut.Dynamic){s=e[o];i[o]=s.toJSON(t)}else if(t&&!0===t.ignoreMultiLangInput&&!0===r.enableMultiLangInput){var u=e.getValue(o);i[o]=u?u[n]:u}else i[o]=e.getValue(o)})),i},t}()),$t=t("BindingListFactory",function(){function t(){}return t.create=function(t){var e=new te(t);return this.extendProperties(e,t),e},t.extendProperties=function(t,e){e.forEach((function(e){var n=e.name;Object.defineProperty(t,n,{get:function(){return t.currentItem[n]}})}))},t}()),Xt=t("BindingObjectFactory",function(){function t(){}return t.create=function(t){var e=new Gt(t);return this.extendProperties(e,t),e},t.createDynamicBindingObject=function(t){var e=Wt.getDynamicProperties(t),n=new Gt(e);return this.extendProperties(n,e),n},t.extendProperties=function(t,e){var n=this;e.forEach((function(e){e.type===Ut.List?n.extendListProperty(t,e):e.type===Ut.Object?n.extendObjectProperty(t,e):e.type===Ut.Dynamic?n.extendDynamicObjectProperty(t,e):n.extendPlainProperty(t,e)}))},t.extendListProperty=function(t,e){var n=e.name,i=Wt.getProperties(e.entityType),r=$t.create(i);r.parent=t,r.changes.subscribe((function(e){e.path.unshift(n),t.changes.next(e)})),Object.defineProperty(t,n,{value:r})},t.extendObjectProperty=function(t,e){var n=e.name,i=Wt.getProperties(e.entityType),r=this.create(i);r.parent=t,r.changes.subscribe((function(e){e.path.unshift(n),t.changes.next(e)})),Object.defineProperty(t,n,{value:r})},t.extendDynamicObjectProperty=function(t,e){t[e.name]=null},t.attachDynamicObjectProperty=function(t,e,n){n.parent=t,n.changes.subscribe((function(n){n.path.unshift(e),t.changes.next(n)})),Object.defineProperty(t,e,{value:n})},t.extendPlainProperty=function(t,e){var n=e.name;Object.defineProperty(t,n,{get:function(){return t.getValue(n)},set:function(e){e!==t.getValue(n)&&t.setValue(n,e,!0,!0)}})},t}()),Zt=t("EntityUtil",function(){function t(){}return t.loadEntity=function(t,e){var n=this;e.properties.forEach((function(i){var r=i.name;if(i.type===Ut.List)n.loadEntityList(t[r]||t[de],e[r]);else if(i.type===Ut.Object)t&&t[r]&&n.loadEntity(t[r],e[r]);else if(i.type===Ut.Dynamic){if(t&&t[r]){var o=Xt.createDynamicBindingObject(t[r].data);Xt.attachDynamicObjectProperty(e,r,o),n.loadEntity(t[r],e[r])}}else e.setValue(r,t[r],!1,!1)})),this.setUpEntityPipeline(t,e)},t.setUpEntityPipeline=function(t,e){t.onValueChanged.subscribe((function(t){if(t.type===Ot.ValueChange&&0!==t.path.length){var n=t.path[t.path.length-1],i=t.path[t.path.length-2];if(e.primaryKey&&"id"===e.primaryKey){var r=e.primaryKey;if(i!==r+":"+e.getValue(r))return}e.getValue(n)!==t.value&&e.setValue(n,t.value,!0,!1,t.errors)}})),e.viewChanges.subscribe((function(n){var i,r=n.value,o=n.path[0],a=t.getPaths(),s=a.path;if(e.id,a.isUdt){"",(i=function(t){t&&t&&t.id?t.id:t.parent&&i(t.parent)})(e),a.isGrid&&s.shift(),s.length&&s.join(".")}if(e.primaryKey){var u=e.primaryKey;if(o!==u&&(!t[u]||t[u]!==e[u]))return}t[o]!==r&&(t[o]=r)}))},t.loadEntityList=function(t,e){this.loadEntities(t.items,e),this.setUpEntityListPipeline(t,e)},t.setUpEntityListPipeline=function(t,e){var n=this;t.onListChanged.subscribe((function(t){switch(t.type){case Ot.Add:case Ot.Clone:if(0===t.value.length)return;var i=(o=t.path)[o.length-2],r=e.parent.primaryKeyValue;if(-1===i.indexOf(r))return;n.appendEntities(t.value,e,t.type===Ot.Clone);break;case Ot.Insert:i=(o=t.path)[o.length-2],r=e.parent.primaryKeyValue;var o,a=t.position;if(-1===i.indexOf(r))return;n.insertEntity(t.value[0],e,a);break;case Ot.Remove:var s=t.value[e.primaryKey];e.removeByIds([s]);break;case Ot.Load:var u=t.value;n.loadEntities(u,e)}}))},t.loadRepository=function(t,e){var n=this,i=Array.from(t.entityCollection.toArray());this.loadEntities(i,e),t.entityCollectionChange.subscribe((function(t){switch(t.type){case Ot.Load:n.loadEntities(t.value,e,t.entityCreate);break;case Ot.Add:case Ot.Clone:n.appendEntities(t.value,e,t.type===Ot.Clone);break;case Ot.AddData:n.addData(t.value,e);break;case Ot.Insert:n.insertEntity(t.value,e,t.position);break;case Ot.Remove:n.removeEntities(t.value,e);break;case Ot.RemoveData:n.removeData(t.value,e);break;case Ot.PaginationInfoChange:e.paginationInfo=t.value}})),e.changes.subscribe((function(e){if(e.type===Ht.PaginationInfoChange){var n=t.entityCollection;n.paginationInfo=Object.assign({},n.paginationInfo,e.value)}}))},t.loadEntities=function(t,e,n){void 0===n&&(n=!1);var i=this.createBindingObjects(t,e);e.load(i,n)},t.appendEntities=function(t,e,n){void 0===n&&(n=!1);var i=this.createBindingObjects(t,e);e.append(i,n)},t.addData=function(t,e){var n=this.createBindingObjects(t,e);e.addData(n)},t.insertEntity=function(t,e,n){var i=this.createBindingObject(t,e);e.insert(i,n)},t.removeEntities=function(t,e){if(null!==t&&0!==t.length){var n=e.primaryKey,i=[];t.forEach((function(t){i.push(t[n])})),e.removeByIds(i)}},t.removeData=function(t,e){if(null!==t&&0!==t.length){var n=e.primaryKey,i=[];t.forEach((function(t){i.push(t[n])})),e.removeDataByIds(i)}},t.createBindingObjects=function(t,e){var n=this;if(null===t||0===t.length)return[];var i=[];return t.forEach((function(t){var r=Xt.create(e.properties);r._ENTITY_=t,n.loadEntity(t,r),i.push(r)})),i},t.createBindingObject=function(t,e){var n=Xt.create(e.properties);return this.loadEntity(t,n),n},t.watchReposiroty=function(t,e){t.entityCollectionChange.subscribe((function(t){switch(t.type){case Ot.PaginationInfoChange:e.pagingInfo=t.value}}))},t.getPropInfo=function(t,e){var n,i,r=pe.getNgFields(t);Object.keys(r).forEach((function(t){t===e&&(n="NgField",i=null)}));var o=pe.getNgObjects(t);Object.keys(o).forEach((function(t){t===e&&(n="NgObject",i=o[t].type)}));var a=pe.getNgList(t);Object.keys(a).forEach((function(t){t===e&&(n="NgList",i=a[t].type)}));var s=pe.getNgDynamic(t);return Object.keys(s).forEach((function(t){t===e&&(n="NgDynamic",i=s[t].type)})),{propType:n,propEntityType:i}},t.getPrimaryKey=function(t){var e=pe.getPrimaryFieldMetadata(t);return e?e.dataField:""},t.isObjectProp=function(t,e){var n=!1,i=pe.getNgObjects(t);return Object.keys(i).forEach((function(t){t===e&&(n=!0)})),n},t.isDynamicProp=function(t,e){var n=!1,i=pe.getNgDynamic(t);return Object.keys(i).forEach((function(t){t===e&&(n=!0)})),n},t.appendInitialData=function(t,e){var n=Object.assign({},e);delete n.id,delete n.parentID,t.initialData=n},t}()),Qt=t("BindingData",function(){function t(){this.paginationInfo=null}return Object.defineProperty(t.prototype,"bindingPath",{get:function(){return this.viewModelContext&&this.viewModelContext.viewModel.bindingPath?this.viewModelContext.viewModel.bindingPath:"/"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pagingInfo",{get:function(){return this.paginationInfo},set:function(t){this.paginationInfo=t,this.firePagingChangeEvent()},enumerable:!0,configurable:!0}),t.prototype.setPagingInfo=function(t,e,n){if(n.length<1||"/"===n)this.paginationInfo=Object.assign(this.paginationInfo,{pageSize:e,pageIndex:t/e+1});else{var i=this.paginationInfo||{};n.substr(1).split("/").filter((function(t){return!!t&&t.length>0})).map((function(t){return t.substring(0,t.length-1)})).forEach((function(t){i.hasOwnProperty(t)||(i[t]={}),i=i[t]})),i.pageIndex=(t/e||0)+1,i.pageSize=e||0}this.firePagingChangeEvent()},t.prototype.firePagingChangeEvent=function(){this.list.changes.next({type:Ht.PaginationInfoChange,path:[],value:this.paginationInfo})},Object.defineProperty(t.prototype,"changes",{get:function(){return this.list.changes},enumerable:!0,configurable:!0}),t.prototype.setValueChangeInvokerFactory=function(t){this.valueChangeInvokerFactory=t},t.prototype.init=function(t,e){this.initByRepository(t,null)},t.prototype.initByRepository=function(t,e){this.viewModelContext=e,this.properties=Wt.getProperties(t.entityType),this.list=$t.create(this.properties),this.pagingInfo=t.entityCollection.paginationInfo,Zt.loadRepository(t,this.list),this.dataTypeInfo=t.entityTypeInfo,this.extendProperties(this.properties)},t.prototype.initByBindingList=function(t,e,n){this.list=t,this.viewModelContext=e,this.dataTypeInfo=n,this.extendProperties(this.list.properties)},t.prototype.getValue=function(t){var e=this.list;return t.forEach((function(t){e&&(e=e[t])})),e},t.prototype.setValue=function(e,n,i,r){if(void 0===i&&(i=!1),void 0===r&&(r=!0),!e||0===e.length)throw Error("路径不能为空");var o=e.slice(0,e.length-1),a=e[e.length-1],s=this.getValue(o);if(!s)throw Error("找不到要设置的对象");s instanceof t?s=s.list.currentItem:s instanceof te&&(s=s.currentItem),this.valueChangeInvokerFactory?s.setValue(a,n,i,r,null,this.valueChangeInvokerFactory(e)):s.setValue(a,n,i,r)},t.prototype.clearValue=function(t,e,n){var i;void 0===e&&(e=!1),void 0===n&&(n=!0);var r=this.dataTypeInfo.getPropInfoByPath(t);r&&r.metadataInfo&&void 0!==r.metadataInfo.initValue?i=r.metadataInfo.initValue:i="number"==typeof this.getValue(t)?0:"";this.setValue(t,i,e,n)},t.prototype.getList=function(){if(!this.bindingPath||"/"===this.bindingPath)return this.list;var t=this.bindingPath.substr(1).split("/").filter((function(t){return""!==t}));return this.getValue(t)},t.prototype.getObject=function(){return this.getList().currentItem},t.prototype.getPath=function(t){var e=this,n=t.filter((function(t){return t})),i=[this.list.primaryKey+":"+this.list.currentId];return n.forEach((function(t){i.push(t);var n=e[t];n&&i.push(n.primaryKey+":"+n.currentId)})),i},t.prototype.getInitValueByPaths=function(t){var e,n=this.dataTypeInfo&&this.dataTypeInfo.getPropInfoByPath(t)||null;return n&&n.metadataInfo&&void 0!==n.metadataInfo.initValue&&(e=n.metadataInfo.initValue),e},t.prototype.extendProperties=function(t){var e=this;t.forEach((function(t){var n=t.name;Object.defineProperty(e,n,{get:function(){return e.list.currentItem[n]},set:function(t){e.list.currentItem[n]=t}})}))},t}()),te=t("BindingList",function(){function t(t){this._paginationInfo=null,this.properties=t,this.primaryKey=Wt.getPrimaryKey(t),this.changes=new u,this.innerList=[],this.currentId=null}return Object.defineProperty(t.prototype,"paginationInfo",{get:function(){return this._paginationInfo},set:function(t){this._paginationInfo=t,this._paginationInfo!==t&&this.changes.next({type:Ht.PaginationInfoChange,path:[],value:this._paginationInfo})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pageIndex",{get:function(){return this.paginationInfo&&this.paginationInfo.hasOwnProperty("pageIndex")?this.paginationInfo.pageIndex:1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pageSize",{get:function(){return this.paginationInfo&&this.paginationInfo.hasOwnProperty("pageSize")?this.paginationInfo.pageSize:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"total",{get:function(){return this.paginationInfo?this.paginationInfo.total||this.paginationInfo.totalCount:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"skip",{get:function(){return(this.pageIndex-1)*this.pageSize},enumerable:!0,configurable:!0}),t.prototype.setPaginationInfo=function(t,e){this.paginationInfo=Object.assign({},this.paginationInfo,{pageSize:e,pageIndex:t/e+1})},Object.defineProperty(t.prototype,"currentItem",{get:function(){var t=this.findById(this.currentId);return t||(this.emptyCurrentItem||(this.emptyCurrentItem=Xt.create(this.properties)),this.emptyCurrentItem)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return this.innerList.length},enumerable:!0,configurable:!0}),t.prototype[Symbol.iterator]=function(){var t=this,e=-1,n=this.innerList.length;return{next:function(){return++e<n?{done:!1,value:t.innerList[e]}:{done:!0,value:void 0}}}},t.prototype.load=function(t,e){var n=this;if(void 0===e&&(e=!1),this.innerList=[],0!==t.length){if(t.forEach((function(t){n.add(t)})),!this.findById(this.currentId)){var i=t[0][this.primaryKey];this.setCurrentId(i,!1,!1)}}else this.currentId=null;var r={type:Ht.Load,path:[],value:t};r.create=e,this.changes.next(r)},t.prototype.append=function(t,e){var n=this;if(void 0===e&&(e=!1),0!==t.length){t.forEach((function(t){n.add(t)}));var i=t[t.length-1][this.primaryKey];this.setCurrentId(i,!0,!0);var r={type:Ht.Append,path:[],value:t};e&&(r.isCloned=!0),this.changes.next(r)}},t.prototype.addData=function(t){var e=this;0!==t.length&&(t.forEach((function(t){e.add(t)})),this.changes.next({type:Ht.Append,path:[],value:t}))},t.prototype.insert=function(t,e){},t.prototype.add=function(t){var e=this;this.innerList.push(t),t.parent=this,t.changes.subscribe((function(t){e.changes.next(t)}))},t.prototype.removeByIds=function(t){var e=this;if(t&&0!==t.length){var n=this.currentId;t.forEach((function(t){t===n&&(n=e.getCurrentIdBeforeDeleting());var i=e.getIndexById(t);-1!==i&&Yt.removeByIndex(e.innerList,i)})),0===this.innerList.length?this.currentId=null:this.setCurrentId(n,!1,!1),this.changes.next({type:Ht.Remove,path:[],value:t})}},t.prototype.removeDataByIds=function(t){},t.prototype.clear=function(){this.innerList=[],this.currentId=null,this.changes.next({type:Ht.Remove,path:[],value:[]})},t.prototype.getCurrentIdBeforeDeleting=function(){var t=-1,e=this.getIndexById(this.currentId);return t=e===this.length-1?e-1:e+1,this.getIdByIndex(t)},t.prototype.findById=function(t){var e,n=this;return void 0===(e=this.innerList.find((function(e){return e.getValue(n.primaryKey)===t})))?null:e},t.prototype.setCurrentId=function(t,e,n){(void 0===e&&(e=!0),void 0===n&&(n=!0),this.currentId!==t)&&(this.findById(t)&&(this.currentId=t,!0===e&&this.changes.next({type:Ht.SelectionChanged,path:[],value:this.currentItem}),!0===n&&this.changes.next({type:Ht.GlobalSelectionChanged,path:[],value:this.currentItem})))},t.prototype.getIndexById=function(t){var e=this;return this.innerList.findIndex((function(n){return n[e.primaryKey]===t}))},t.prototype.getIdByIndex=function(t){if(t<0||t>this.length)return null;var e=this.innerList[t];return e?e[this.primaryKey]:null},t.prototype.toArray=function(){return this.innerList.concat([])},t.prototype.swapById=function(t,e){},t.prototype.toJSON=function(t){var e=[];return this.innerList.forEach((function(n){e.push(n.toJSON(t))})),e},t.prototype.getPaginationConfigByPath=function(t,e){if(!t||"/"===t)return this.paginationInfo;if("string"!=typeof t)throw new Error("路径必须为字符串！");var n=(t=t.substring(1)).split("/").filter((function(t){return!!t&&t.trim().length>0})).map((function(t){return t.trim()})),i=this.paginationInfo;return n.forEach((function(t){i=i&&i.hasOwnProperty(t)?i[t]:null})),i||(void 0!==e?e:void 0)},t.prototype.sortBy=function(t,e,n){if(!t||t.length<1||!e||e.length<1)throw new Error("sortBy:argument error");var i="string"==typeof t?t.split(","):t||[],r="string"==typeof e?e.split(","):e||[];if(i.length!==r.length||i.length<1)throw new Error("sortBy:fields and directions not match");var o,a;this.innerList=this.innerList.sort((o=i,a=r,function(t,e){var n,i;try{for(var r=R(o),s=r.next();!s.done;s=r.next()){var u=s.value,p=["asc"].includes(a[o.indexOf(u)])?1:-1;if(t.getValue(u)>e.getValue(u))return 1*p;if(t.getValue(u)<e.getValue(u))return-1*p}}catch(t){n={error:t}}finally{try{s&&!s.done&&(i=r.return)&&i.call(r)}finally{if(n)throw n.error}}return 0}))},t.prototype.getValue=function(e,n,i,r){var o,a;void 0===i&&(i=!1),void 0===r&&(r="zh-CHS"),e instanceof t?e=e.currentItem:e instanceof Qt&&(e=e.list.currentItem);var s=null;if(-1===n.indexOf("."))s=e[n];else{var u=n.split(".");try{for(var p=R(u),c=p.next();!c.done;c=p.next()){var l=c.value;e=s=this.getValue(e,l,i,r)}}catch(t){o={error:t}}finally{try{c&&!c.done&&(a=p.return)&&a.call(p)}finally{if(o)throw o.error}}}return i&&s&&s.hasOwnProperty(r)?s[r]:s},t}()),ee=t("BindingDataFactory",function(){function t(){}return t.createFromRepository=function(t,e){var n=new Qt,i=Wt.getProperties(t.entityType),r=$t.create(i);return n.initByBindingList(r,null,t.entityTypeInfo),Zt.loadRepository(t,r),n.pagingInfo=t.entityCollection.paginationInfo,n},t.createFromEntityManager=function(t,e){var n=new Qt,i=Wt.getProperties(t.entityType),r=$t.create(i);n.initByBindingList(r,null,t.entityCollection.entityTypeInfo);var o=t.getEntitiesByPath([]);return Zt.loadEntities(o,r),n},t.createFromExistingBindingData=function(t,e){var n=new Qt;return n.initByBindingList(t.list,null,n.dataTypeInfo),n},t}()),ne=(t("EntityPathConverter",function(){function t(){}return t.toEntityPathArray=function(t,e){var n=this,i=zt.toBindingPathArray(t),r=[];if(0===i.length)return r;var o=e.list.currentItem;return r.push(this.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue)),i.forEach((function(t){switch(Wt.getPropertyByName(o.properties,t).type){case Ut.Plain:r.push(t);break;case Ut.Object:o=o[t],r.push(t),r.push(n.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue));break;case Ut.List:var e=o[t];o=e.currentItem,r.push(t),r.push(n.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue))}})),r},t.createPrimaryKeyPath=function(t,e){return t+":"+e},t}()),t("EntityPathComparer",(function(){})),t("FormPathConverter",function(){function t(){}return t.toBindingPathArray=function(t){return t.split(".").filter((function(t){return""!==t}))},t}()),t("DataPathUtil",function(){function t(){}return t.convertToBindingPathArray=function(t){return t.split("/").filter((function(t){return""!==t}))},t.convertToEntityPathArray=function(t,e){var n=this,i=this.convertToBindingPathArray(t),r=[];if(0===i.length)return r;var o=e.list.currentItem;return r.push(this.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue)),i.forEach((function(t){switch(Wt.getPropertyByName(o.properties,t).type){case Ut.Plain:r.push(t);break;case Ut.Object:o=o[t],r.push(t),r.push(n.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue));break;case Ut.List:var e=o[t];o=e.currentItem,r.push(t),r.push(n.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue))}})),r},t.convertToRestUrl=function(t,e){var n=this.convertToBindingPathArray(t),i=[],r=e.list.currentItem;return i.push(r.primaryKeyValue),n.forEach((function(t){var e=Wt.getPropertyByName(r.properties,t);if(e.type!==Ut.List)throw new Error(e.name+"不是子表对应的属性");var n=r[t];r=n.currentItem,i.push(t),i.push(r.primaryKeyValue)})),i.pop(),"/"+i.join("/")},t.getLeafPath=function(e){return t.convertToBindingPathArray(e).pop()},t.getParentPath=function(e){var n=t.convertToBindingPathArray(e);return n.pop(),"/"+n.join("/")},t.createPrimaryKeyPath=function(t,e){return t+":"+e},t}()),t("Guid",function(){function t(e){if(!e)throw new TypeError("Invalid argument; `value` has no value.");this.value=t.EMPTY,e&&t.isGuid(e)&&(this.value=e)}return t.isGuid=function(e){var n=e.toString();return e&&(e instanceof t||t.validator.test(n))},t.create=function(){return new t([t.gen(2),t.gen(1),t.gen(1),t.gen(1),t.gen(3)].join("-"))},t.createEmpty=function(){return new t("emptyguid")},t.parse=function(e){return new t(e)},t.raw=function(){return[t.gen(2),t.gen(1),t.gen(1),t.gen(1),t.gen(3)].join("-")},t.gen=function(t){for(var e="",n=0;n<t;n++)e+=(65536*(1+Math.random())|0).toString(16).substring(1);return e},t.prototype.equals=function(e){return t.isGuid(e)&&this.value===e.toString()},t.prototype.isEmpty=function(){return this.value===t.EMPTY},t.prototype.toString=function(){return this.value},t.prototype.toJSON=function(){return{value:this.value}},t.validator=new RegExp("^[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}$","i"),t.EMPTY="00000000-0000-0000-0000-000000000000",t}()),t("isObservable",(function(t){return!!t&&(!(!t[Symbol.observable]||t!==t[Symbol.observable]())||(!(!t["@@observable"]||t!==t["@@observable"]())||t instanceof i))}))),ie=t("EnvUtil",function(){function t(){}return t.isInWf=function(){var t=window.top.location.pathname;return-1!==t.indexOf("wf/webapp/apptaskcenter")||-1!==t.indexOf("wf/webapp/mobiletaskcenter")||-1!==t.indexOf("wf/webapp/proc-center-mobile")},t}()),re=t("UrlUtil",function(){function t(){}return t.getParams=function(t){var e=t.split("?");if(e.length<2)return null;var n={};return e[1].split("&").forEach((function(t){if(t){var e=t.split("=");e.length<2||(n[e[0]]=e[1])}})),n},t}()),oe=t("OBJECT_PROP_META","ObjectPropMeta");t("ObjectPropMeta",St(oe,(function(t){if(Jt.isPlainObject(t))return t;var e=typeof t;return"string"===e?{dataField:t}:"function"===e?{type:t}:void 0})));var ae=t("DYNAMIC_PROP_META","DynamicPropMeta");t("DynamicPropMeta",St(ae,(function(t){if(Jt.isPlainObject(t))return t;var e=typeof t;return"string"===e?{dataField:t}:"function"===e?{type:t}:void 0})));var se=t("LIST_PROP_META","ListPropMeta");t("ListPropMeta",St(se,(function(t){if(Jt.isPlainObject(t))return t;var e=typeof t;return"string"===e?{dataField:t}:"function"===e?{type:t}:void 0})));var ue=t("ENTITY_META","EntityMeta");var pe=t("FieldMetadataUtil",function(){function t(){}return t.getNgFields=function(t){return Tt.getPropsMetadatasByName(t,kt)},t.getNgField=function(t,e){return this.getNgFields(t)[e]},t.getDataField=function(t,e){return this.getNgField(t,e).dataField||e},t.getNgObjects=function(t){return Tt.getPropsMetadatasByName(t,oe)},t.getNgDynamic=function(t){return Tt.getPropsMetadatasByName(t,ae)},t.getNgList=function(t){return Tt.getPropsMetadatasByName(t,se)},t.getPrimaryFieldMetadata=function(e){var n=t.getNgFields(e),i=Object.keys(n).find((function(t){return n[t].primary}));if(i){var r=n[i];return r.property=i,r.dataField||(r.dataField=i),r}},t.getPrimaryKey=function(t){var e=this.getPrimaryFieldMetadata(t);return e?e.property:""},t}()),ce=t("EntityMetadataUtil",function(){function t(){}return t.getAllNgProperties=function(t){var e=this.getNgFieldProperties(t),n=this.getNgObjectProperties(t),i=this.getNgDynamicProperties(t),r=this.getNgObjectProperties(t);return Object.assign({},e,n,i,r)},t.getNgEntityMatadata=function(t){return Tt.getClassMetadataByNameWithTranslate(t,ue)},t.getNgFieldProperties=function(t){return Tt.getPropsMetadatasByName(t,kt)},t.getNgObjectProperties=function(t){return Tt.getPropsMetadatasByName(t,oe)},t.getNgDynamicProperties=function(t){return Tt.getPropsMetadatasByName(t,ae)},t.getNgListProperties=function(t){return Tt.getPropsMetadatasByName(t,se)},t.getPrimaryKeyProperty=function(e){var n,i=t.getNgFieldProperties(e);return Object.keys(i).forEach((function(t){var e=i[t];!0===e.primary&&(n=e)})),n},t}()),le=t("DataTypeInfo",function(){function t(t){this.type=t,this.primaryKey="",this.foreignKey="",this.propInfoMap=new Map,this.collectEntityInfos(),this.collectPropInfos()}return Object.defineProperty(t.prototype,"isValueObject",{get:function(){return!this.primaryKey},enumerable:!0,configurable:!0}),t.prototype.getPropInfos=function(){return Array.from(this.propInfoMap.values())},t.prototype.getPropNames=function(){var t=[];return this.getPropInfos().forEach((function(e){t.push(e.name)})),t},t.prototype.getPropInfosByGroup=function(t){return Array.from(this.propInfoMap.values()).filter((function(e){return e.group===t}))},t.prototype.getPropNamesByGroup=function(t){var e=[];return this.getPropInfosByGroup(t).forEach((function(t){e.push(t.name)})),e},t.prototype.getPropInfoByName=function(t){return this.propInfoMap.has(t)?this.propInfoMap.get(t):null},t.prototype.getPropInfoByPath=function(t){var e=t.concat([]);if(0===e.length)throw Error("属性路径不能为空");for(var n=this,i=null;n&&e.length>0;){var r=e.shift();if(!(i=n.getPropInfoByName(r)))throw Error("路径"+t+"中存在不正确的节点"+r+"，请检查");n=i.typeInfo,i.group===Bt.Dynamic&&e.length>0&&(i=null,n=null)}return i},t.prototype.getTypeInfoByPath=function(t){if(0===t.length)return this;var e=this.getPropInfoByPath(t);if(!e.typeInfo)throw Error("路径"+t+"无法定位到一个EntityTypeInfo，请检查");return e.typeInfo},t.prototype.getPrimaryKeyPropInfo=function(){return this.getPropInfoByName(this.primaryKey)},t.prototype.getPropMappingByName=function(t){var e=this.getPropInfoByName(t);return e?e.mapping:""},t.prototype.getPropMappingByPath=function(t){var e=this.getPropInfoByPath(t);return e?e.mapping:""},t.prototype.checkPropGroup=function(t,e){var n=this.getPropInfoByName(t);return!(!n||n.group!==e)},t.prototype.collectEntityInfos=function(){var t=ce.getNgEntityMatadata(this.type);this.entityInfo=t},t.prototype.collectPropInfos=function(){var t=this,e=ce.getNgFieldProperties(this.type);Object.keys(e).forEach((function(n){var i=e[n];!0===i.primary&&(t.primaryKey=n),!0===i.foreign&&(t.foreignKey=n),t.addPropInfo(Bt.Primitive,n,i.dataField,null,i)}));var n=ce.getNgObjectProperties(this.type);Object.keys(n).forEach((function(e){var i=n[e];t.addPropInfo(Bt.Object,e,i.dataField,i.type,i)}));var i=ce.getNgDynamicProperties(this.type);Object.keys(i).forEach((function(e){var n=i[e];t.addPropInfo(Bt.Dynamic,e,n.dataField,null,n)}));var r=ce.getNgListProperties(this.type);Object.keys(r).forEach((function(e){var n=r[e];t.addPropInfo(Bt.List,e,n.dataField,n.type,n)}))},t.prototype.addPropInfo=function(e,n,i,r,o){i=i||n;var a=null;r&&(a=new t(r));var s={group:e,name:n,mapping:i,typeInfo:a,metadataInfo:o};this.propInfoMap.set(n,s)},t}()),he=t("DataPathCreator",function(){function t(){}return t.createByLongPathFromRoot=function(t,e){var n=new Lt,i=t;if(!i||0===i.length)return n;for(var r={nodeValue:i.shift(),nodeType:_t.DataId,entityTypeInfo:new le(e.entityType)};r;){n.push(r.nodeType,r.nodeValue);var o=i.shift();if(!o||!r.entityTypeInfo)break;r=this.getNextPathNodeInfo(r,o)}return n},t.getNextPathNodeInfo=function(t,e){var n=t.nodeValue,i=t.nodeType,r=t.entityTypeInfo;if(!e||!r)return null;var o={nodeValue:e,nodeType:null,entityTypeInfo:null};if(i===_t.DataId)o.nodeType=_t.PropName,o.entityTypeInfo=r;else{var a=r.getPropInfoByName(n);a.group===Bt.List?(o.nodeType=_t.DataId,o.entityTypeInfo=a.typeInfo):(o.nodeType=_t.PropName,o.entityTypeInfo=a.group===Bt.Object?a.typeInfo:null)}return o},t.createByShortPathFromRoot=function(t,e,n){var i=new Lt,r=t,o=n.list.currentItem,a=new le(e.entityType);return i.push(_t.DataId,o.primaryKeyValue),r.forEach((function(t){var e=a.getPropInfoByName(t);switch(e.group){case Bt.Primitive:i.push(_t.PropName,t);break;case Bt.Object:o=o[t],a=e.typeInfo,i.push(_t.PropName,t);break;case Bt.List:var n=o[t];o=n.currentItem,a=e.typeInfo,i.push(_t.PropName,t),i.push(_t.DataId,o.primaryKeyValue)}})),i},t}()),fe=t("PARENT_PATH","__PARENT_PATH__"),de=t("PARENT_CLASS","__PARENT__");function ye(t,e){return new t(e)}function ge(t,e){var n=[];return e.forEach((function(e){var i=ye(t,e);n.push(i)})),n}function ve(t,e){return new t(e)}var me=t("EntityList",function(){function t(t,e){var n=this;this.__type__="EntityList",this.originalData=[],this.listChanged=new u,this.changeSet=new At,this.onListChanged=this.listChanged.asObservable(),this.clear(),t&&t.forEach((function(t){n.initEntity(ve(e,t))}))}return Object.defineProperty(t.prototype,"items",{get:function(){return this.rawData},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"changes",{get:function(){return this.changeSet.changes},enumerable:!0,configurable:!0}),t.prototype[Symbol.iterator]=function(){return N(this,(function(t){switch(t.label){case 0:return[5,R(this.items)];case 1:return t.sent(),[2]}}))},t.prototype.loadEntities=function(t){var e=this;this.clear(),t.forEach((function(t){e.initEntity(t)}));var n={path:[],value:t,preValue:void 0,type:Ot.Load,target:this};this.setChanges(n)},t.prototype.clear=function(){this.rawData=[],this.originalData=[]},t.prototype.appendNew=function(t,e){void 0===e&&(e=!1);var n=this.initEntity(t,!0),i={path:[],value:[n],preValue:void 0,type:Ot.Add};return!0===e&&(i.type=Ot.Clone),this.setChanges(i),n},t.prototype.insert=function(t,e){var n=this.initEntity(t,!0),i={path:[],value:[n],preValue:void 0,type:Ot.Insert,position:e};return this.setChanges(i),n},t.prototype.appendEntity=function(t){var e={path:[],value:[this.initEntity(t)],preValue:void 0,type:Ot.Add};this.setChanges(e)},t.prototype.appendEntities=function(t){var e=this,n={path:[],value:t.map((function(t){return e.initEntity(t)})),preValue:void 0,type:Ot.Add};this.setChanges(n)},t.prototype.remove=function(t){var e,n=this.count(),i=this.rawData.findIndex((function(e){return e.primaryValue===t}));if(-1===i)return!1;var r=this.rawData[i];this.rawData.splice(i,1);var o={path:[],value:(e={},e[r.primaryProperty.dataField]=t,e),preValue:void 0,type:Ot.Remove};return this.updateIndex(n),this.setChanges(o),!0},t.prototype.get=function(t){return this.items.find((function(e){return e.primaryValue===t}))},t.prototype.setChanges=function(t){this.listChanged.next(t);var e=Object.assign({},t);(t.type===Ot.Add||t.type===Ot.Insert||t.type===Ot.Clone)&&t.value[0]instanceof be&&(e.value=[t.value[0].data]),this.changeSet.append(e)},t.prototype.count=function(){return this.items.length},t.prototype.indexOf=function(t){return this.items.indexOf(t)},t.prototype.sum=function(t){return 0===this.count()?0:this.items.reduce((function(e,n){return e+n[t]}),0)},t.prototype.toJson=function(){return this.rawData},t.prototype.toJSON=function(){var t=[];return this.items.forEach((function(e){t.push(e.toJSON())})),t},t.prototype.toArray=function(){return this.items},t.prototype.initEntity=function(t,e){var n=this;return void 0===e&&(e=!1),t[de]=this,t[fe]=this[fe],t.onValueChanged.subscribe((function(t){var e={path:t.path,value:t.value,preValue:t.preValue,type:t.type};void 0!==t.changeSetValue&&(e.changeSetValue=t.changeSetValue),n.setChanges(e)})),this[this.rawData.push(t)-1]=t,e||this.originalData.push(t.toJSON()),t},t.prototype.updateIndex=function(t){for(var e=this,n=0;n<t;n++)delete this[n];this.rawData.forEach((function(t,n){e[n]=t}))},t.prototype.getPropertyName=function(){var t=this[fe];if(t&&t.length)return t[t.length-1]},t}());function Ee(t,e){return new t(e)}var be=t("Entity",function(){function t(t){this.validErrors={},this.changeSet=new At,this.isValidating=!1,this.newData=void 0,this.valueChanged=new u,this.onValueChanged=this.valueChanged.asObservable(),this.hasChange=!1,this.newData=Object.assign({},t),this.onValueChanged=this.valueChanged,this.initialize()}return Object.defineProperty(t.prototype,"data",{get:function(){return this.newData},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"errors",{get:function(){return this.validErrors},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"changes",{get:function(){return this.changeSet.changes},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"primaryProperty",{get:function(){return pe.getPrimaryFieldMetadata(this.constructor)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"primaryKey",{get:function(){return this.primaryProperty?this.primaryProperty.property:""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"primaryValue",{get:function(){if(this.primaryKey){var t=this[this.primaryProperty.property];return t||""}return""},enumerable:!0,configurable:!0}),t.prototype.setChanges=function(t){t.path[t.path.length-1],t.type!==Ot.Load&&(this.hasChange=!0),this.valueChanged.next(t),this.changeSet.append(t)},t.prototype.getPaths=function(){var t={path:[],isUdt:!1,isGrid:!1},e=function(n){var i=n[fe];if(i){var r=i[i.length-1];Object.keys(pe.getNgObjects(n[de].constructor)).indexOf(r)>-1&&(t.isUdt=!0),n[de]&&n instanceof me==!0&&(t.isGrid=!0),t.path.push(r)}n[de]&&n instanceof me==!0&&e(n[de])};return e(this),t.path=t.path.reverse(),t},t.prototype.load=function(t){t||(t={}),this.loadFields(t),this.loadLists(t),this.loadObjects(t),this.loadDynamicObjects(t),this.newData=Object.assign({},t)},t.prototype.toJSON=function(){var t=this,e={},n=pe.getNgFields(this.constructor);Object.keys(n).forEach((function(i){var r=n[i].dataField||i;e[r]=t[i]}));var i=pe.getNgObjects(this.constructor);Object.keys(i).forEach((function(n){var r=i[n].dataField||n;e[r]=t[n]?t[n].toJSON():{}}));var r=pe.getNgDynamic(this.constructor);Object.keys(r).forEach((function(n){var i=r[n].dataField||n;e[i]=t[n]?t[n].toJSON():{}}));var o=pe.getNgList(this.constructor);return Object.keys(o).forEach((function(n){var i=o[n].dataField||n;e[i]=t[n]?t[n].toJSON():{}})),e},t.prototype.initialize=function(){var t=this.constructor,e=pe.getNgFields(t),n=pe.getNgObjects(t),i=pe.getNgList(t),r=pe.getNgDynamic(t);this.initializeNormalField(e),this.initializeList(i),this.initializeObject(n),this.initializeDynamic(r)},t.prototype.createPath=function(t){var e=this.primaryProperty;return e?[e.dataField+":"+this.primaryValue,t]:[":",t]},t.prototype.initializeNormalField=function(t){var e=this;Object.keys(t).forEach((function(n){var i=t[n];i.dataField,delete e[n]&&Object.defineProperty(e,n,{get:function(){return this.getPropValue(n,i)},set:function(t){if(!this.primaryKey||this.primaryKey===n||this.primaryValue){var e=this.getPropValue(n,i);!1!==this.isPropValueChanged(n,i,t,e)&&(this.setPropValue(n,i,t),this.emitValueChange(n,i,t,e))}},configurable:!0})}))},t.prototype.initializeList=function(t){var e=this;Object.keys(t).forEach((function(n){var i=t[n],r=e.createPath(n),o=i.dataField||n,a=e.data[o],s=new me;if(s[de]=e,s[fe]=r,a){var u=a.map((function(t){return Ee(i.type,t)}));s.loadEntities(u)}s.onListChanged.subscribe((function(t){t&&(s[fe][0]!==t.path[0]&&(t.path=s[fe].concat(t.path)),e.setChanges(t))})),e[n]=s}))},t.prototype.initializeObject=function(t){var e=this;Object.keys(t).forEach((function(n){var i=t[n],r=e.createPath(n),o=i.dataField||n,a=e.data[o]||{},s=function(t){var n;return(n=t instanceof i.type?t:Ee(i.type,t))[de]=e,n[fe]=r,n.onValueChanged.subscribe((function(t){t&&(t.path=(e[fe]||[]).concat(t.path),e.setChanges(t))})),n},u=s(a);delete e[n]&&Object.defineProperty(e,n,{get:function(){return u},set:function(t){var e={path:u[fe],value:t.data,preValue:this[n].data,type:Ot.ValueChange};u=s(t),this.setChanges(e)},configurable:!0})}))},t.prototype.initializeDynamic=function(t){var e=this;Object.keys(t).forEach((function(n){var i=t[n],r=e.createPath(n),o=i.dataField||n,a=e.data[o]||{},s=function(t){var n;return(n=t instanceof i.type?t:Ee(i.type,t))[de]=e,n[fe]=r,n.onValueChanged.subscribe((function(t){t&&(t.path=(e[fe]||[]).concat(t.path),e.setChanges(t))})),n},u=s(a);delete e[n]&&Object.defineProperty(e,n,{get:function(){return u},set:function(t){var e={path:u[fe],value:t.data,preValue:this[n].data,type:Ot.ValueChange};u=s(t),this.setChanges(e)},configurable:!0})}))},t.prototype.loadFields=function(t){var e=this,n=pe.getNgFields(this.constructor);Object.keys(n).forEach((function(i){var r=n[i].dataField||i;e[i]=t[r]}))},t.prototype.loadLists=function(t){var e=this,n=pe.getNgList(this.constructor);Object.keys(n).forEach((function(i){var r=n[i],o=r.dataField||i,a=r.type,s=t[o];if(s){var u=s.map((function(t){return Ee(a,t)}));e[i].loadEntities(u)}else e[i].loadEntities([])}))},t.prototype.loadObjects=function(t){var e=this,n=pe.getNgObjects(this.constructor);Object.keys(n).forEach((function(i){var r=n[i].dataField||i,o=t[r],a=e[i];a&&o&&a.load(o)}))},t.prototype.loadDynamicObjects=function(t){var e=this,n=pe.getNgDynamic(this.constructor);Object.keys(n).forEach((function(i){var r=n[i].dataField||i,o=t[r]||{},a=e[i];a&&a.loadDynamicData(o)}))},t.prototype.emitValueChange=function(t,e,n,i){var r={path:this.createPath(t),value:n,preValue:i,type:Ot.ValueChange};this[fe]&&(r.path=this[fe].concat(r.path)),this.setChanges(r)},t.prototype.getPropValue=function(t,e){var n,i=e.dataField||t,r=this.data[i];if(!0===e.enableMultiLangInput&&!r){var o=window.localStorage.getItem("languageCode")||"zh-CHS",a=i.replace("_MULTILANGUAGE","");return(n={})[o]=this.data[a],n}return r},t.prototype.setPropValue=function(t,e,n){var i=e.dataField||t;this.data[i]=n},t.prototype.isPropValueChanged=function(t,e,n,i){return!0===e.enableMultiLangInput?(!0!==this.isEmptyMultiLangPropValue(n)||!0!==this.isEmptyMultiLangPropValue(i))&&JSON.stringify(n)!==JSON.stringify(i):n!==i},t.prototype.isEmptyMultiLangPropValue=function(t){return!t||0===Object.keys(t).length},t}()),Ce=(t("DynamicEntity",function(t){function e(e){var n=t.call(this,e)||this;return n.loadDynamicData(e),n}return j(e,t),Object.defineProperty(e.prototype,"IsNested",{get:function(){return this[de]instanceof e},enumerable:!0,configurable:!0}),e.prototype.loadDynamicData=function(t){this.initializeDynamicField(t)},e.prototype.initializeDynamicField=function(t){var e=this;Object.keys(t).forEach((function(n){e[n]&&delete e[n];var i=n;if(t[n]instanceof Object){var r=e.createPath(n),o=e.createDynamicEntityFromJsonData(t[n],r);Object.defineProperty(e,n,{get:function(){return o},set:function(t){var e={path:o[fe],value:t.data,preValue:this[n].data,type:Ot.ValueChange};o=this.createDynamicEntityFromJsonData(t,r),this.setChanges(e)},configurable:!0})}else Object.defineProperty(e,n,{get:function(){return this.data[i]},set:function(t){var e=this.data[i];if(e!==t){this.data[i]=t;var r={type:Ot.ValueChange,path:this.createPath(n),value:t,preValue:e};this[fe]&&(r.path=this[fe].concat(r.path)),this.setChanges(r)}},configurable:!0})}))},e.prototype.createDynamicEntityFromJsonData=function(t,n){var i,r=this;return(i=t instanceof e?t:new e(t))[de]=this,i[fe]=n,i.onValueChanged.subscribe((function(t){t&&(t.path=(r[fe]||[]).concat(t.path),r.setChanges(t))})),i},e.prototype.setChanges=function(t){var e,n=t.path[t.path.length-1],i=Object.assign({},this.data);this.newData=Object.assign(this.newData,((e={})[n]=t.value,e));var r=t.path;t.path.length>2&&(r=t.path.slice(0,t.path.length-2));var o={path:r,value:this.data,preValue:i,type:t.type};this.valueChanged.next(o),this.changeSet.append(t)},e.prototype.toJSON=function(){return this.data},e}(be)),t("REPOSITORY_META","RepositoryMeta"));var xe=t("EntityCollection",function(){function t(t){this.innerEntitySet=new Set,this.innerEntityMap=new Map,this.collectionChanged=new u,this.changes=new u,this.entityType=t,this.primaryKey=pe.getPrimaryKey(this.entityType)}return t.prototype.count=function(){return this.innerEntitySet.size},Object.defineProperty(t.prototype,"entityTypeName",{get:function(){return this.entityType.name},enumerable:!0,configurable:!0}),t.prototype.has=function(t){return this.innerEntityMap.has(t)},t.prototype.clear=function(){this.innerEntityMap.clear(),this.innerEntitySet.clear(),this.notifyCollectionChanged(new Rt([],Ot.Load))},t.prototype.reset=function(){this.innerEntityMap.clear(),this.innerEntitySet.clear();var t=new Rt([],Ot.Load);t.isReset=!0,this.notifyCollectionChanged(t)},t.prototype.toArray=function(){return Array.from(this.innerEntitySet)},t.prototype.toJSON=function(){var t=[];return this.toArray().forEach((function(e){t.push(e.toJSON())})),t},t.prototype.loadEntities=function(t,e){var n=this;void 0===e&&(e=!1),this.innerEntityMap.clear(),this.innerEntitySet.clear(),t.forEach((function(t){n.innerEntitySet.add(t),n.innerEntityMap.set(t[n.primaryKey],t),n.listenEntityChangeEvent(t)}));var i=new Rt(t,Ot.Load);i.entityCreate=e,this.notifyCollectionChanged(i)},t.prototype.addEntity=function(t,e){void 0===e&&(e=!1),this.verifyEntityToAdd(t),this.innerEntitySet.add(t),this.innerEntityMap.set(t[this.primaryKey],t),this.listenEntityChangeEvent(t);var n=e?Ot.Clone:Ot.Add;this.notifyCollectionChanged(new Rt([t],n))},t.prototype.insertEntity=function(t,e){this.verifyEntityToAdd(t),this.innerEntitySet.add(t),this.innerEntityMap.set(t[this.primaryKey],t),this.listenEntityChangeEvent(t),this.notifyCollectionChanged(new Rt(t,Ot.Insert,null,null,e))},t.prototype.updateEntity=function(t,e){t.load(e),this.notifyCollectionChanged(new Rt(t,Ot.Update,null,null))},t.prototype.addEntities=function(t){var e=this;if(t){var n=[];t.forEach((function(t){e.verifyEntityToAdd(t),n.push(t)})),n.forEach((function(t){e.innerEntitySet.add(t),e.innerEntityMap.set(t[e.primaryKey],t),e.listenEntityChangeEvent(t)})),this.notifyCollectionChanged(new Rt(n,Ot.Add))}},t.prototype.addData=function(t){var e=this;if(t){var n=[];t.forEach((function(t){e.verifyEntityToAdd(t),n.push(t)})),n.forEach((function(t){e.innerEntitySet.add(t),e.innerEntityMap.set(t[e.primaryKey],t),e.listenEntityChangeEvent(t)})),this.notifyCollectionChanged(new Rt(n,Ot.AddData))}},t.prototype.getEntityById=function(t){return!1===this.innerEntityMap.has(t)?null:this.innerEntityMap.get(t)},t.prototype.getEntityByPath=function(t){for(var e=t[0].split(":")[1],n=this.getEntityById(e),i=1;i<t.length&&n;i+=1){var r=t[i];n instanceof be?-1===r.indexOf(":")&&(n=n[t[i]]):n=n.get(t[i].split(":")[1])}return n},t.prototype.getEntitiesByPath=function(t){for(var e=t[0].split(":")[1],n=this.getEntityById(e),i=1;i<t.length&&n;i+=2){if(!((n=n[t[i]])instanceof me))throw new Error("路径格式错误");if(i+1<t.length){var r=t[i+1].split(":")[1];n=n.get(r)}}return n},t.prototype.getEntities=function(t){return Array.from(this.innerEntitySet).filter(t)},t.prototype.getAllEntities=function(){return Array.from(this.innerEntitySet)},t.prototype.removeEntityById=function(t){this.verifyEntityToRemove(t);var e=this.innerEntityMap.get(t);return this.innerEntityMap.delete(t),this.innerEntitySet.delete(e),this.notifyCollectionChanged(new Rt([e],Ot.Remove)),e},t.prototype.removeEntitiesByIds=function(t){},t.prototype.removeEntities=function(t){var e=this,n=Array.from(this.innerEntitySet).filter(t);return n.forEach((function(t){e.innerEntityMap.delete(t[e.primaryKey]),e.innerEntitySet.delete(t)})),this.notifyCollectionChanged(new Rt(n,Ot.Remove)),n},t.prototype.removeData=function(t){var e=this,n=Array.from(this.innerEntitySet).filter(t);return n.forEach((function(t){e.innerEntityMap.delete(t[e.primaryKey]),e.innerEntitySet.delete(t)})),this.notifyCollectionChanged(new Rt(n,Ot.RemoveData)),n},t.prototype.resetEntities=function(t,e){var n,i;if(-1===t[0].indexOf(":"))throw new Error("路径格式错误");var r=V(t[0].split(":"),2),o=r[0],a=r[1],s=null;try{for(var u=R(this.innerEntitySet),p=u.next();!p.done;p=u.next()){var c=p.value;if(c[o]===a){s=c;break}}}catch(t){n={error:t}}finally{try{p&&!p.done&&(i=u.return)&&i.call(u)}finally{if(n)throw n.error}}if(!s)throw new Error("找不到"+o+"为"+a+"的实体");var l=s;t.slice(1).forEach((function(t){l=l[t]}));var h=l;h.clear(),h.loadEntities(e)},t.prototype.verifyEntityToAdd=function(t){return this.has(t[this.primaryKey])&&(this.innerEntitySet.delete(this.innerEntityMap.get(t[this.primaryKey])),this.innerEntityMap.delete(t[this.primaryKey])),!0},t.prototype.verifyEntityToRemove=function(t){if(!this.has(t))throw new Error("The entity with identity of '"+t+" dose not exsit.'");return!0},t.prototype.notifyCollectionChanged=function(t){this.collectionChanged.next(t)},Object.defineProperty(t.prototype,"pageSize",{get:function(){return this.paginationInfo&&this.paginationInfo.pageSize||0},set:function(t){if("number"!=typeof t||t<0)throw new Error("Invalid parameter:pageSize");var e=this.paginationInfo;this.paginationInfo=Object.assign({},e,{pageSize:t}),this.notifyCollectionChanged(new Rt(this.paginationInfo,Ot.PaginationInfoChange))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalCount",{get:function(){return this.paginationInfo&&this.paginationInfo.total||0},set:function(t){if("number"!=typeof t||t<0)throw new Error("Invalid parameter:total");var e=this.paginationInfo;this.paginationInfo=Object.assign({},e,{total:t}),this.notifyCollectionChanged(new Rt(this.paginationInfo,Ot.PaginationInfoChange))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pageIndex",{get:function(){return this.paginationInfo&&this.paginationInfo.pageIndex||1},set:function(t){if("number"!=typeof t||t<0)throw new Error("Invalid parameter:pageIndex");var e=this.paginationInfo;this.paginationInfo=Object.assign({},e,{pageIndex:t}),this.notifyCollectionChanged(new Rt(this.paginationInfo,Ot.PaginationInfoChange))},enumerable:!0,configurable:!0}),t.prototype.updatePaginationInfoByPath=function(t,e){var n=this.paginationInfo,i=e.pageIndex,r=e.pageSize,o=e.totalCount,a=Object.assign({},n,{pageIndex:i,pageSize:r,total:o});this.setPaginationConfigByPath(t,a)},t.prototype.getPaginationConfigByPath=function(t,e){if(!t||"/"===t)return this.paginationInfo;if("string"!=typeof t)throw new Error("路径必须为字符串！");var n=(t=t.substring(1)).split("/").filter((function(t){return!!t&&t.trim().length>0})).map((function(t){return t.trim()})),i=this.paginationInfo;return n.forEach((function(t){i=i&&i.hasOwnProperty(t)?i[t]:null})),i||(void 0!==e?e:void 0)},t.prototype.setPaginationConfigByPath=function(t,e){var n=JSON.stringify(this.paginationInfo);return t&&"/"!==t?(Array.isArray(t)||(t=t.toString().match(/[^/[\]]+/g)||[]),t.slice(0,-1).reduce((function(e,n,i){return Object(e[n])===e[n]?e[n]:e[n]=Math.abs(t[i+1])>>0==+t[i+1]?[]:{}}),this.paginationInfo)[t[t.length-1]]=e):this.paginationInfo=e,JSON.stringify(this.paginationInfo)!==n&&this.notifyCollectionChanged(new Rt(this.paginationInfo,Ot.PaginationInfoChange)),this.paginationInfo},t.prototype.listenEntityChangeEvent=function(t){var e=this;t&&t.onValueChanged.subscribe((function(t){return e.changes.next(t)}))},t}()),Pe=t("EntityManager",function(){function t(t){this.entityCollection=t,this.entityType=t.entityType}return t.prototype.createEntity=function(t){return ye(this.entityType,t)},t.prototype.createEntities=function(t,e){return ge(this.entityType,t)},t.prototype.createEntitiesByPath=function(t,e){var n,i,r,o=t.split("/");if(o.length<3)throw Error("根据path删除实体数据出错了。传入的path["+t+"]格式不对");if(e.length<1)return[];for(var a=2;a<o.length;a+=2){var s=o[a-1];r=o[a];var u=n?n.get(s):this.entityCollection.getEntityById(s);n=u[r];var p=i?i.propEntityType:this.entityType;if(i=Zt.getPropInfo(p,r),!n)throw Error("fpath参数错误，无法找到"+r+"对应的子表。fpath为："+t)}return e.map((function(t){return ye(i.propEntityType,t)}))},t.prototype.getEntityByPath=function(t){return this.getEntityNodeByPath(t)},t.prototype.getEntitiesByPath=function(t){var e=this.getEntityNodeByPath(t);return e.toArray()},t.prototype.getEntityNodeByPath=function(t){for(var e=he.createByLongPathFromRoot(t,this),n=this.entityCollection,i=e.head.next;i;){if(!(n=i.type===_t.DataId?n instanceof xe==!0?n.getEntityById(i.value):n.get(i.value):n[i.value]))throw new Error("找不到"+i.value+"对应的数据节点");i=i.next}return n},t.prototype.getPropValueByPath=function(t){var e=t.pop();return this.getEntityByPath(t)[e]},t.prototype.setPropValueByPath=function(t,e){var n=t.pop();this.getEntityByPath(t)[n]=e},t.prototype.insertEntityBeforeByPath=function(t){throw new Error("Not Implemented")},t.prototype.insertEntitiesBeforeByPath=function(){throw new Error("Not Implemented")},t.prototype.insertEntityAfterByPath=function(){throw new Error("Not Implemented")},t.prototype.insertEntitiesAfterByPath=function(){throw new Error("Not Implemented")},t.prototype.appendEntityByPath=function(t,e,n,i){void 0===i&&(i=!1);var r,o,a,s=t.split("/");if(s.length<3)throw Error("根据path删除实体数据出错了。传入的path["+t+"]格式不对");for(var u=2;u<s.length;u+=2){var p=s[u-1];a=s[u];var c=r?r.get(p):this.entityCollection.getEntityById(p);r=c[a];var l=o?o.propEntityType:this.entityType;if(o=Zt.getPropInfo(l,a),!r)throw Error("fpath参数错误，无法找到"+a+"对应的子表。fpath为："+t)}var h=ye(o.propEntityType,e);return n&&Zt.appendInitialData(h,n),r.appendNew(h,i),h},t.prototype.insertEntityByPath=function(t,e,n,i){var r,o,a,s=t.split("/");if(s.length<3)throw Error("根据path删除实体数据出错了。传入的path["+t+"]格式不对");for(var u=2;u<s.length;u+=2){var p=s[u-1];a=s[u];var c=r?r.get(p):this.entityCollection.getEntityById(p);r=c[a];var l=o?o.propEntityType:this.entityType;if(o=Zt.getPropInfo(l,a),!r)throw Error("fpath参数错误，无法找到"+a+"对应的子表。fpath为："+t)}var h=ye(o.propEntityType,e);return n&&Zt.appendInitialData(h,n),r.insert(h,i),h},t.prototype.appendEntitiesByPath=function(t,e){var n=this.getEntityNodeByPath(t);n instanceof xe==!0?n.addEntities(e):n.appendEntities(e)},t.prototype.removeEntityByPath=function(t,e){var n,i=t.split("/");if(i.length<3)throw Error("根据path删除实体数据出错了。传入的path["+t+"]格式不对");for(var r=2;r<i.length;r+=2){var o=i[r-1],a=i[r],s=n?n.get(o):this.entityCollection.getEntityById(o);if(!(n=s[a]))throw Error("fpath参数错误，无法找到"+a+"对应的子表。fpath为："+t)}n.remove(e)},t.prototype.removeEntitiesByPath=function(t,e){throw new Error("Not Implemented")},t.prototype.clearAllEntityChanges=function(){this.entityCollection.toArray().forEach((function(t){t.changes.splice(0,t.changes.length)}))},t.prototype.resetAllEntityChangeMark=function(){this.entityCollection.toArray().forEach((function(t){t.hasChange=!1}))},t.prototype.clearEntityChangesById=function(t){var e=this.entityCollection.getEntityById(t);e&&e.changes.splice(0,e.changes.length)},t.prototype.clearEntityChangesByIds=function(t){var e=this;!t||t.length<0||t.forEach((function(t){e.clearEntityChangesById(t)}))},t.prototype.checkAllEntityChanges=function(){return this.entityCollection.toArray().some((function(t){return t.changes.length>0}))},t.prototype.checkEntityChangesById=function(t){var e=this.entityCollection.getEntityById(t);return!!e&&e.changes.length>0},t.prototype.clearEntityChangesByArray=function(t){this.clearEntityChangesByIds(t)},t}()),we=function(){function t(t,e){this.entityType=t,this.paginationConfig=e,null!==this.paginationConfig&&void 0!==this.paginationConfig||(this.paginationConfig=this.getNgListProperties()),this.expandMainEntityConfig(),this.deleteMainEntityConfig()}return t.prototype.expandMainEntityConfig=function(){var t=this.entityType.name;if(this.paginationConfig.hasOwnProperty(t)){var e=this.paginationConfig[t];this.paginationConfig=Object.assign(this.paginationConfig,e)}},t.prototype.deleteMainEntityConfig=function(){delete this.paginationConfig[this.entityType.name]},Object.defineProperty(t.prototype,"pagination",{get:function(){return this.paginationConfig},enumerable:!0,configurable:!0}),t.prototype.getPaginationConfigByPath=function(t,e){if(!t||"/"===t)return this.paginationConfig;if("string"!=typeof t)throw new Error("路径必须为字符串！");var n=(t=t.substring(1)).split("/").filter((function(t){return!!t&&t.trim().length>0})),i=this.paginationConfig;return n.forEach((function(t){i=i&&i.hasOwnProperty(t)?i[t]:null})),i||(void 0!==e?e:void 0)},t.prototype.setPaginationConfigByPath=function(t,e){return Array.isArray(t)||(t=t.toString().match(/[^/[\]]+/g)||[]),t.slice(0,-1).reduce((function(e,n,i){return Object(e[n])===e[n]?e[n]:e[n]=Math.abs(t[i+1])>>0==+t[i+1]?[]:{}}),this.paginationConfig)[t[t.length-1]]=e,this.paginationConfig},t.prototype.getNgListProperties=function(t){void 0===t&&(t=0);var e=function(n){var i=pe.getNgList(n),r={};return Object.keys(i).length<1||Object.keys(i).forEach((function(n){var o=i[n].dataField;o.endsWith("s")&&(o=o.substring(0,o.length-1)),r[o]={pageSize:t};var a=e(i[n].type);null!==a&&Object.keys(a).length>0&&(r=Object.assign({},r,a))})),r},n=e(this.entityType);return Object.assign({},{pageSize:t},n)},t}(),Me=function(){function t(){this.history=[],this.cacheData=[]}return t.prototype.addChange=function(t){this["on"+k[t.changeType]+"Data"](t)},t.prototype.addChanges=function(t){var e=this;t.forEach((function(t){return e.addChange(t)}))},t.prototype.clear=function(){this.history.splice(0,this.history.length)},t.prototype.clearByIds=function(t){this.history=this.history.filter((function(e){var n,i;if(!e.fpath||"/"===e.fpath||!e.fpath.includes("/"))return!t.includes(e.dataId);try{for(var r=R(t),o=r.next();!o.done;o=r.next()){var a=o.value;return!e.fpath.split("/").includes(a)}}catch(t){n={error:t}}finally{try{o&&!o.done&&(i=r.return)&&i.call(r)}finally{if(n)throw n.error}}}))},t.prototype.isChanged=function(){return this.history.length>0},t.prototype.clearCache=function(){this.cacheData.splice(0,this.cacheData.length)},t.prototype.getCacheData=function(){return this.cacheData},t.prototype.onAddData=function(t){this.history.push(t)},t.prototype.onEditData=function(t){this.cacheData.push(t)},t.prototype.onAppendData=function(t){this.history.push(t),this.cacheData.push(t)},t.prototype.onDeleteData=function(t){var e=this.history.findIndex((function(e){return e.dataId===t.dataId&&e.changeType===k.Add}));e>=0?this.history.splice(e,1):this.history.push(t)},t}(),Ie=t("Repository",function(){function t(){this.paginationInfo=null}return t.prototype.init=function(){this.entityTypeInfo=new le(this.entityType),this.entityCollection=new xe(this.entityType),this.entityCollection.entityTypeInfo=this.entityTypeInfo,this.dataChangeHistory=new Me},Object.defineProperty(t.prototype,"changes",{get:function(){return this.entityCollection.changes},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"primaryKey",{get:function(){return this.entityCollection.primaryKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"entityCollectionChange",{get:function(){return this.entityCollection.collectionChanged},enumerable:!0,configurable:!0}),t.prototype.reset=function(){this.entityCollection.clear()},t.prototype.buildEntity=function(t){return ye(this.entityType,t)},t.prototype.buildEntities=function(t){return ge(this.entityType,t)},t.prototype.setPaginationConfig=function(t){this.paginationManager=new we(this.entityType,t);var e=(this.paginationManager.getPaginationConfigByPath("/")||{}).pageSize,n=void 0===e?0:e;this.entityCollection.paginationInfo=Object.assign({pageSize:n},this.entityCollection.paginationInfo,this.paginationManager.pagination)},t.prototype.setPaginationInfo=function(t){this.paginationInfo=D({},this.paginationInfo,t)},t}()),Se=(t("DefaultRepository",function(t){function e(){return t.call(this)||this}return j(e,t),e.prototype.init=function(){t.prototype.init.call(this),this.entityManager=new Pe(this.entityCollection)},e}(Ie)),t("COMMAND_HANDLER_META","CommandHandlerMeta"));var Oe=t("COMMAND_HANDLER_EXTENDER_META","CommandHandlerExtenderMeta");var Te,je=t("TaskNode",function(){function t(t,e){this.name=t,this.func=e}return t.prototype.execute=function(t){var n=this.func(t);return ne(n)?n:e(n)},t}()),De=t("VARIABLE_PARSERS",et("@farris/devkit VARIABLE_PARSERS")),Ne=(t("AppOptions",(function(){})),t("BindingDataManager",function(){function t(){this.bindingDataMap=new Map}return t.prototype.getBindingDataMap=function(){return this.bindingDataMap},t.prototype.getBindingDataByName=function(t){return this.bindingDataMap.get(t)},t.prototype.regBindingData=function(t,e){this.bindingDataMap.set(t,e)},t.prototype.ifBindingDataExits=function(t){return!!this.getBindingDataByName(t)},t}())),Re=t("RepositoryManager",function(){function t(){this.repositoryMap=new Map}return t.prototype.regRepository=function(t,e){this.repositoryMap.set(t,e)},t.prototype.getRepositoryMap=function(){return this.repositoryMap},t.prototype.getRepositories=function(){return Array.from(this.repositoryMap.values())},t.prototype.getRepositoryByName=function(t){return this.repositoryMap.get(t)},t.prototype.ifRepositoryExits=function(t){return!!this.getRepositoryByName(t)},t}()),Ve=t("ViewModelContextManager",function(){function t(){this.contextMap=new Map,this.contextSet=new Set}return t.prototype.regContext=function(t){var e=t.id;!0===this.contextMap.has(e)&&this.unregContext(t),this.contextMap.set(e,t),this.contextSet.add(t)},t.prototype.unregContext=function(t){var e=t.id;this.contextMap.delete(e),this.contextSet.delete(t)},t.prototype.getContextMap=function(){return this.contextMap},t.prototype.getContexts=function(){return Array.from(this.contextSet)},t.prototype.getContextsByNamespace=function(t){return this.getContexts()},t.prototype.getContextById=function(t){return this.contextMap.get(t)},t.prototype.getRootContext=function(){return this.getContexts().find((function(t){return null===t.parent}))},t.prototype.getRootContextAndPosterityById=function(t){var e=this.getContextById(t),n=this.getContexts(),i=[],r=this.getContextsGroupRoot(e);return n.map((function(t){t.parent&&t.parent.id===r&&i.push(t)})),i.push(this.getContextById(r)),i},t.prototype.getContextsGroupRoot=function(t){return t.parent?this.getContextsGroupRoot(t.parent):t.id},t}()),_e=t("Context",function(){function t(){this.params=new Map}return t.prototype.getParam=function(t){return this.params.get(t)},t.prototype.setParam=function(t,e){this.params.set(t,e)},t}()),Ae=t("VALIDATION_RULE_TOKEN",new tt("@Farris validation rule")),Be=t("AppContext",function(t){function e(e,n,i,r,o,a,s){void 0===a&&(a={});var u=t.call(this)||this;return u.injector=e,u.eventBus=n,u.repositoryManager=i,u.bindingDataManager=r,u.viewModelContextManager=o,u.validationManager=a,u.validationRule=s,u.validationRule=e.get(Ae,[]),u}return j(e,t),e.prototype.regViewModelContext=function(t){var e=t.repository,n=e.name;if(!1===this.repositoryManager.ifRepositoryExits(n)&&this.repositoryManager.regRepository(n,e),!1===this.bindingDataManager.ifBindingDataExits(n)){var i=ee.createFromRepository(e,"/");this.bindingDataManager.regBindingData(n,i)}this.viewModelContextManager.regContext(t)},e}(_e)),Fe=t("ViewModelContext",function(){function t(){}return t.prototype.init=function(t){this.innerViewModel=t,this.id=this.innerViewModel.id,this.appContext=t.injector.get(Be),this.regToTree(),this.regToAppContext()},t.prototype.regToTree=function(){var e=this.innerViewModel.injector.get(it,null,H.SkipSelf);e?(this.parent=e.get(t,null),this.root=this.parent?this.parent.root:this):(this.parent=null,this.root=this)},t.prototype.regToAppContext=function(){this.appContext.regViewModelContext(this)},Object.defineProperty(t.prototype,"viewModel",{get:function(){return this.innerViewModel},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"injector",{get:function(){return this.innerViewModel.injector},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"repository",{get:function(){return this.innerViewModel.repository},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bindingData",{get:function(){return this.innerViewModel.bindingData},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"uiState",{get:function(){return this.innerViewModel.uiState},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stateMachine",{get:function(){return this.innerViewModel.stateMachine},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"form",{get:function(){return this.innerViewModel.form},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"commandBus",{get:function(){return this.innerViewModel.commandBus},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"expressionEngineImpl",{get:function(){return this.innerViewModel.expressionEngineImpl},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"expressionManager",{get:function(){return this.innerViewModel.expressionManager},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"expressionResult",{get:function(){return this.innerViewModel.expressionResult},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"controlsProxy",{get:function(){return this.innerViewModel.controlsProxy},enumerable:!0,configurable:!0}),t.prototype.getVirtualRootFrameContext=function(){return this},t.prototype.registerExtendCommand=function(t,e){this.viewModel.registerExtendCommand(t,e)},t}()),Le=t("CONTROLSTATE_PROP_META","ControlStatePropMeta"),ke=(t("ControlStatePropMeta",St(Le,(function(t){return t}))),t("UISTATE_PROP_META","UIStatePropMeta")),He=(t("UIStatePropMeta",St(ke,(function(t){return t}))),t("UIStateMetadataUtil",function(){function t(){}return t.getUIFields=function(t){return Tt.getPropsMetadatasByName(t,ke)},t.getControlFields=function(t){return Tt.getPropsMetadatasByName(t,Le)},t}())),Ke=t("CONTROL_STATE_INTERCEPTOR_TOKEN",et("@farris/devkit CONTROL_STATE_INTERCEPTOR_TOKEN")),Ue=t("InitContext",(function(){})),qe=t("InterceptContext",(function(){})),Ye=t("ProcessContext",(function(){})),Je=t("ControlStateInterceptorService",function(){function t(t){this.injector=t,this.controlInterceptors=[],this.controlInterceptors=this.injector.get(Ke,null,H.Optional)}return t.prototype.init=function(){var t,n;if(this.result)return this.result;var i=[],a=new Ue,s=this.getProcessContext();a.processContext=this.processContext=s;try{for(var u=R(this.controlInterceptors),p=u.next();!p.done;p=u.next()){var c=p.value;if(c.init&&"function"==typeof c.init){var h=c.init(a),f=r(h)?h:e(h);i.push(f)}}}catch(e){t={error:e}}finally{try{p&&!p.done&&(n=u.return)&&n.call(u)}finally{if(t)throw t.error}}return this.result=o(i).pipe(l(1))},t.prototype.intercept=function(t){var e,n;t.processContext=this.processContext;try{for(var i=R(this.controlInterceptors),r=i.next();!r.done;r=i.next()){r.value.intercept(t)}}catch(t){e={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}},t.prototype.getProcessContext=function(){var t=new Ye,e=ie.isInWf();if(t.isInWf=e,!1===e)return t;var n=window.parent.document.querySelector("iframe");if(!n||!n.src)return t;var i=re.getParams(n.src);return i?(t.uiStateInProcess=i.UIStateInProcess,t.formConfigId=i.formConfigId,t):t},t}()),ze=function(){function t(t){this.viewModelContext=t,this.controlStateInterceptorService=t.injector.get(Je)}return t.prototype.init=function(){return this.controlStateInterceptorService.init()},t.prototype.updateControlState=function(t){var e=this;if(!this.controlFields){var n=this.viewModelContext.uiState;this.controlFields=He.getControlFields(n.constructor),this.variableNames=Object.keys(this.controlFields)}this.beforeUpdate(t)&&this.variableNames.forEach((function(n){var i=e.controlFields[n];Object.keys(i.originalValue).forEach((function(r){e.update(t,i,n,r)}))}))},t.prototype.beforeUpdate=function(t){if(!this.variableNames)return!1;var e=t.lintenerType,n=t.change;return"uiState"!==e||!this.variableNames.includes(n.field)},t.prototype.update=function(t,e,n,i){var r,o=e.originalValue[i];if(this.needUpdate(o,t)){var a=this.computeOriginalValue(o),s=new qe;s.controlState=e,s.value=a,s.type=i,s.viewModelContext=this.viewModelContext,this.controlStateInterceptorService&&this.controlStateInterceptorService.intercept(s);var u=this.viewModelContext.uiState;u[n]||(u[n]={}),u[n]=D({},u[n],((r={})[i]=s.value,r)),this.afterUpdate(i,s)}},t.prototype.needUpdate=function(t,e){var n=t.type,i=t.value,r=e.lintenerType,o=e.change;if("firstUpdate"===r)return!0;if("constant"===n)return!1;if(!i)return!1;if("expression"===n&&"expression"===r)return!0;switch(r){case"bindingData":if(o&&o.path&&o.path.length>0)return!!i.includes(o.path[0]);break;case"uiState":if(o&&o.field)return!!i.includes(o.field);break;case"stateMachine":return!!i.includes("stateMachine");case"form":return!!i.includes("form")}return!0},t.prototype.computeOriginalValue=function(t){var e=t.value,n=t.type;if(e&&"string"==typeof e&&"constant"!==n){var i={bindingData:this.viewModelContext.bindingData.list.currentItem.toJSON(),entityListData:this.viewModelContext.bindingData.getList().toJSON(),currentEntityData:this.viewModelContext.bindingData.getObject().toJSON(),uiState:this.viewModelContext.uiState,form:this.viewModelContext.viewModel.form,stateMachine:this.viewModelContext.stateMachine.renderStates};return this.eval(e,i)}return e},t.prototype.eval=function(t,e){t="return "+t;var n=Object.getOwnPropertyNames(e),i="__scope__"+(new Date).valueOf();return new Function(i,"\n          "+n.map((function(t){return"var "+t+" = "+i+"['"+t+"'];"})).join("\r\n")+"\n          return function () {\n            try{  \n"+t+"\n }catch(e){console.error(e);}\n          };")(e)()},t.prototype.afterUpdate=function(t,e){"required"===t&&this.updateRequired(e)},t.prototype.updateRequired=function(t){var e=t.controlState.controlInfo.bindingPath;if(e){var n=this.viewModelContext.form,i=n.getFormValueByBindPath(e),r=i.form_name;if(r&&0!==Object.keys(r).length){!0===t.value?(n.addValidate(i.bindingPath,i.name),r.pushValidatorFnforRequired([{type:"required",constraints:[!0],message:"必填"}],!0),r.required=!0):!1===t.value&&r.getValidatorFn()&&r.getValidatorFn().length>=1&&(r.required=!1,r.resetValidatorFnforRequired(),r.validationResult&&"required"===r.validationResult.type&&(r.validationResult={passing:!0,message:""}))}}},t}(),We=function(){function t(t){var e=this;this.subscriptionsMap=new Map,this.viewModelContext=t,this.controlStateUpdater=t.injector.get(ze),this.controlStateUpdater.init().subscribe((function(t){e.register();e.controlStateUpdater.updateControlState({lintenerType:"firstUpdate",change:null})}))}return t.prototype.register=function(){this.registerBindingDataLintener(),this.registerUIStateLintener(),this.registerStateMachineLintener(),this.registerFormLintener()},t.prototype.registerBindingDataLintener=function(){var t=this,e="bindingData";if(!1===this.subscriptionsMap.has(e)){var n=this.viewModelContext.bindingData.changes.subscribe((function(e){e.type!==Ht.Load&&t.controlStateUpdater.updateControlState({lintenerType:"bindingData",change:e})}));this.subscriptionsMap.set(e,n)}},t.prototype.registerUIStateLintener=function(){var t=this,e="uiState";if(!1===this.subscriptionsMap.has(e)){var n=this.viewModelContext.uiState.changes.subscribe((function(e){t.controlStateUpdater.updateControlState({lintenerType:"uiState",change:e})}));this.subscriptionsMap.set(e,n)}},t.prototype.registerStateMachineLintener=function(){var t=this,e="stateMachine";if(!1===this.subscriptionsMap.has(e)&&this.viewModelContext.stateMachine){var n=this.viewModelContext.stateMachine.stateChange.subscribe((function(e){t.controlStateUpdater.updateControlState({lintenerType:"stateMachine",change:e})}));this.subscriptionsMap.set(e,n)}},t.prototype.registerFormLintener=function(){var t=this,e="form";if(!1===this.subscriptionsMap.has(e)){var n=this.viewModelContext.form.changes.subscribe((function(e){e&&"validateFieldsFinished"===e.type?t.controlStateUpdater.updateControlState({lintenerType:"expression",change:e}):t.controlStateUpdater.updateControlState({lintenerType:"form",change:e})}));this.subscriptionsMap.set(e,n)}},t}(),Ge=t("UIState",function(){function t(){this.changes=new u,this.innerData=Object.assign({}),this._init()}return t.prototype._init=function(){var t=this.constructor,e=He.getUIFields(t),n=He.getControlFields(t);this.initializeUIField(e),this.initializeControlField(n)},t.prototype.config=function(t){var e=this.constructor,n=He.getControlFields(e);n&&Object.keys(n).length>0&&(this.controlStateListener=t.injector.get(We))},t.prototype.initializeUIField=function(t){var e=this;Object.keys(t).forEach((function(n){var i=t[n].stateName||n;delete e[n]&&e.defineProperty(n,i)}))},t.prototype.initializeControlField=function(t){var e=this;Object.keys(t).forEach((function(n){var i=t[n].stateName||n;delete e[n]&&e.defineProperty(n,i)}))},t.prototype.isExistProperty=function(t){return!(!this.innerData.hasOwnProperty(t)&&!this.hasOwnProperty(t))},t.prototype.defineProperty=function(t,e){void 0===e&&(e=null),Object.defineProperty(this,t,{get:function(){return null!==e?this.innerData[e]:this.innerData[t]},set:function(n){(null!==e?this.innerData[e]:this.innerData[t])!==n&&(null!==e?this.innerData[e]=n:this.innerData[t]=n,this.changes.next({field:t,value:n}))}})},t.prototype.setPropertyValue=function(t,e){""!==t&&void 0!==t&&(this.isExistProperty(t)||this.defineProperty(t),this[t]=e)},t}()),$e=t("State",(function(t){this.name=t})),Xe=t("initialUIState",!1),Ze=t("STATE_PROP_META","StatePropMeta"),Qe=(t("StatePropMeta",St(Ze,(function(t){return t}))),t("RENDER_STATE_PROP_META","RenderStatePropMeta")),tn=(t("RenderStatePropMeta",St(Qe,(function(t){return t}))),t("ACTION_METHOD_META","ActionMethodMeta")),en=(t("ActionMethodMeta",St(tn,(function(t){return t}))),t("StateMachineContext",function(){function t(t,e){this.stateMachine=t,this.state=e.name}return t.prototype.init=function(t){this.viewModelContext=t,this.parser=this.viewModelContext.injector.get(Di),this.stateMachineWatcher=this.stateMachine.stateMachineWatcher},t.prototype.transitTo=function(t){var e=this.stateMachine.states[t];e&&(this.state=e.name,this.stateMachine.render())},t.prototype.getUIState=function(t){if(t){var e=this.stateMachineWatcher.getViewModelContext(t);if(e){if(this.stateMachineWatcher.subscribeUIStateChange(e,t),this.parser){var n=this.parser.parse(t,e);return null===n||"object"==typeof n&&0===Object.keys(n).length?null:n}throw new Error("未初始化变量解析器。")}}},t.prototype.getData=function(t){if(t){var e=this.stateMachineWatcher.getViewModelContext(t);if(e){if(this.stateMachineWatcher.subscribeEntityChange(e,t),this.parser){var n=this.parser.parse(t,e);return null===n||"object"==typeof n&&0===Object.keys(n).length?null:n}throw new Error("未初始化变量解析器。")}}},t}())),nn=function(){function t(t){this.stateMachine=t,this.uiStatePathList=[],this.dataStatePathList=[],this.viewModelContextAndUIStatePathsMap=new Map,this.viewModelContextAndDataStatePathsMap=new Map}return t.prototype.init=function(t){this.viewModelContext=t},t.prototype.getViewModelContext=function(t){var e=this.extractPaths(t).split("/")[1];return this.viewModelContext.appContext.viewModelContextManager.getContextById(e)},t.prototype.subscribeUIStateChange=function(t,e){var n=this,i=this.getStatePath(e);!1===this.viewModelContextAndUIStatePathsMap.has(t)&&(this.viewModelContextAndUIStatePathsMap.set(t,this.uiStatePathList),t.uiState.changes.subscribe((function(e){var i=n.viewModelContextAndUIStatePathsMap.get(t);e.field&&i.indexOf(e.field)>-1&&n.stateMachine.render()}))),-1===this.viewModelContextAndUIStatePathsMap.get(t).indexOf(i)&&this.uiStatePathList.push(i)},t.prototype.subscribeEntityChange=function(t,e){var n=this;!1===this.viewModelContextAndDataStatePathsMap.has(t)&&(this.viewModelContextAndDataStatePathsMap.set(t,this.dataStatePathList),t.bindingData.changes.subscribe((function(e){"Load"!==e.type&&"SelectionChanged"!==e.type||n.stateMachine.render();var i=n.viewModelContextAndDataStatePathsMap.get(t);e.path.join()&&n.isAccordingPath(i,e.path.join("/"))&&n.stateMachine.render()}))),-1===this.viewModelContextAndDataStatePathsMap.get(t).indexOf(e)&&this.dataStatePathList.push(e)},t.prototype.getStatePath=function(t){return this.extractPaths(t).split("/")[2]},t.prototype.isAccordingPath=function(t,e){return void 0!==t.find((function(t){return t.indexOf(e)>-1}))},t.prototype.extractPaths=function(t){var e,n=t.match(/\{UISTATE~(\S+?)\}/g),i=t.match(/\{DATA~(\S+?)\}/g);if(null!==n){var r=/\{UISTATE~(\S+?)\}/;n.forEach((function(t){var n=t.match(r);null!=n&&2===n.length&&(e=n[1])}))}if(null!==i){var o=/\{DATA~(\S+?)\}/;i.forEach((function(t){var n=t.match(o);null!=n&&2===n.length&&(e=n[1])}))}return e},t}(),rn=t("StateMachine",function(){function t(){this.renderStates={},this.handlePropMetadatas(),this.stateChange=new a(!1),this.context=new en(this,this.initialState),this.stateMachineWatcher=new nn(this)}return t.prototype.init=function(t){this.viewModelContext=t,this.context.init(this.viewModelContext),this.stateMachineWatcher.init(this.viewModelContext),this.render()},t.prototype.handlePropMetadatas=function(){var t=this,e=Tt.getPropsMetadatas(this.constructor);if(e&&Object.keys(e).forEach((function(n){e[n].forEach((function(e){t.handlePropMetadata(n,e)}))})),!this.initialState)throw new Error("请在StatePropMeta注解中指定状态机的初始状态。")},t.prototype.handlePropMetadata=function(t,e){switch(e.ngMetadataName){case Ze:this.buildState(t,e);break;case Qe:this.buildRenderState(t,e);break;case tn:this.buildAction(t,e)}},t.prototype.buildState=function(t,e){this.states=this.states||{},this[t]=new $e(t),this.states[t]=this[t],e.initialState&&(this.initialState=this[t])},t.prototype.buildRenderState=function(t,e){this.renderStates=this.renderStates||{},this[t]=Xe,this.renderStates[t]=this[t],this.renders=this.renders||{},this.renders[t]=e.render},t.prototype.buildAction=function(t,e){var n=this;this[t]=function(){var t=e.transitTo,i=n.states[t];n.context.transitTo(i.name),n.render()}},t.prototype.render=function(){for(var t in this.renderStates)if(!1!==this.renderStates.hasOwnProperty(t)){var e=this.renders[t];e&&(this.renderStates[t]=e(this.context),this[t]=this.renderStates[t])}this.stateChange.next(this.context.state)},t}());!function(t){t.EntityState="EntityState",t.UIState="UIState"}(Te||(Te=t("BindingType",{})));t("DateStringValueConverter",function(){function t(){}return t.prototype.convertFrom=function(t){return qt.formatISO(t)},t.prototype.convertTo=function(t){return qt.parse(t)},t}()),t("ArrayStringValueConverter",function(){function t(){}return t.prototype.convertFrom=function(t){return t.join(",")},t.prototype.convertTo=function(t){return t.split(",")},t}());var on,an=t("EntityBindingValueAccessor",function(){function t(t,e,n){this.bindingData=t,this.bindingPathSegments=this.getBindingPathSegments(e),this.valueConverter=n}return t.prototype.getValue=function(){var t=this.bindingData.getValue(this.bindingPathSegments);return this.valueConverter?this.valueConverter.convertTo(t):t},t.prototype.setValue=function(t){var e=this.bindingData.getValue(this.bindingPathSegments),n=this.valueConverter?this.valueConverter.convertFrom(t):t;!0===this.isDateConverter(this.valueConverter)&&!0===qt.isEqual(e,n)||this.bindingData.setValue(this.bindingPathSegments,n,!0,!0)},t.prototype.getBindingPathSegments=function(t){var e=zt.toBindingPathArray(this.bindingData.bindingPath);t=t.replace(/\./g,"/");var n=zt.toBindingPathArray(t);return e.concat(n)},t.prototype.isDateConverter=function(t){var e=!1;return t&&!0===t.hasOwnProperty("format")&&(e=!0),e},t}()),sn=t("UIStateBindingValueAccessor",function(){function t(t,e,n){this.uiState=t,this.bindingPathSegments=this.getUiStateBindingPath(e)}return t.prototype.getValue=function(){var t,e=this.uiState;return this.bindingPathSegments.forEach((function(n){t=e[n],e=t})),t},t.prototype.setValue=function(t){var e,n=this.bindingPathSegments.length;if(1===n)this.uiState.setPropertyValue(this.bindingPathSegments,t);else{for(var i=void 0,r=n-1;r>0;r--)(e={})[this.bindingPathSegments[r]]=t,t=i=e;this.uiState.setPropertyValue(this.bindingPathSegments[0],i)}},t.prototype.getUiStateBindingPath=function(t){return-1!==t.search("/")?t.split("/"):[t]},t}()),un=t("BindingValueAccessorFactory",function(){function t(){}return t.create=function(t,e,n,i){switch(t){case Te.EntityState:var r=i.bindingData;return new an(r,e,n);case Te.UIState:var o=i.uiState;return new sn(o,e,n);default:throw new Error("Not Supported")}},t}()),pn=t("FORM_CONTROL_PROP_META","FormControlPropMeta"),cn=(t("FormControlPropMeta",St(pn,(function(t){return t}))),t("ValidatorFactory",function(){function t(){}return t.create=function(t){var e=this,n=[];return Array.isArray(t)&&t.length>1?t.forEach((function(t){n.push(e.initValidRuleFn(t))})):Array.isArray(t)&&1===t.length?n.push(this.initValidRuleFn(t[0])):n.push(this.initValidRuleFn(t)),n},t.initValidRuleFn=function(t){var i=t.type,r=t.constraints,o=t.message;switch(i){case"required":return function(t,e){if(!0!==r[0]&&!0===e.injector.get(Di).parse(r[0],e))return null==t||""===t?{type:i,passing:!1,message:o||"必填"}:{type:i,passing:!0,message:""};return!0===r[0]&&(null==t||""===t)?{type:i,passing:!1,message:o||"必填"}:{type:i,passing:!0,message:""}};case"NumberMaxValue":case"numberMaxValue":return function(t){return"number"!=typeof t?{passing:!0,message:""}:r[0]||0==r[0]?t<=parseFloat(r[0])?{passing:!0,message:""}:{passing:!1,message:o||"输入值不能大于"+r[0]}:{passing:!0,message:""}};case"NumberMinValue":case"numberMinValue":return function(t){return"number"!=typeof t?{passing:!0,message:""}:r[0]||0==r[0]?t>=parseFloat(r[0])?{passing:!0,message:""}:{passing:!1,message:o||"输入值不能小于"+r[0]}:{passing:!0,message:""}};case"DateMaxValue":case"dateMaxValue":return function(t){if(null==t||""===t)return{passing:!0,message:""};if(r[0]){var e=r[0];return 21==e.length&&(e=e.slice(1,20)),qt.isBefore(t,e)||qt.isSame(t,e)?{passing:!0,message:""}:{passing:!1,message:o||"输入日期不能大于"+e}}return{passing:!0,message:""}};case"DateMinValue":case"dateMinValue":return function(t){if(null==t||""===t)return{passing:!0,message:""};if(r[0]){var e=r[0];return 21==e.length&&(e=e.slice(1,20)),qt.isAfter(t,e)||qt.isSame(t,e)?{passing:!0,message:""}:{passing:!1,message:o||"输入日期不能小于"+e}}return{passing:!0,message:""}};case"StringMaxLength":case"stringMaxLength":return function(t){return null==t||""===t?{passing:!0,message:""}:r[0]?t.length<=r[0]?{passing:!0,message:""}:{passing:!1,message:o||"输入值长度不能大于"+r[0]}:{passing:!0,message:""}};case"StringMinLength":case"stringMinLength":return function(t){return null==t||""===t?{passing:!0,message:""}:r[0]?t.length>=r[0]?{passing:!0,message:""}:{passing:!1,message:o||"输入值长度不能小于"+r[0]}:{passing:!0,message:""}};case"regex":return function(t){if(null==t||""===t)return{passing:!0,message:""};var e=[];"string"==typeof r[0]&&(e=r[0].split(","));for(var n=0;n<e.length;n++){if(""===e[n])return;if(new RegExp(e[n]).test(t))return{passing:!1,message:o||"存在不可输入项"+e[n]}}return{passing:!0,message:""}};case"regexp":return function(t){return null==t||""===t||new RegExp(r[0]).test(t)?{passing:!0,message:""}:{passing:!1,message:o||"请输入正确格式"}};case"mobile":return function(t){if(null==t||""===t)return{passing:!1,message:o||"请输入正确的手机号格式"};var e=!0===r[0]?/^1[0-9]{10}$/:r[0];return new RegExp(e).test(t)?{passing:!0,message:""}:{passing:!1,message:o||"请输入正确的手机号格式"}};case"email":return function(t){if(null==t||""===t)return{passing:!1,message:o||"请输入正确的邮箱格式"};var e=!0===r[0]?/^[A-Za-z0-9\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/:r[0];return new RegExp(e).test(t)?{passing:!0,message:""}:{passing:!1,message:o||"请输入正确的邮箱格式"}};case"idCard":return function(t){if(null==t||""===t)return{passing:!1,message:o||"请输入正确的身份证格式"};var e=!0===r[0]?/^[1-9]\d{5}(18|19|([23]\d))\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$/:r[0];return new RegExp(e).test(t)?{passing:!0,message:""}:{passing:!1,message:o||"请输入正确的身份证格式"}};case"customFunction":return function(t,e){if("function"==typeof r[0]){var n=r[0](t,e);return n?{passing:!1,message:n}:{passing:!0,message:""}}return{passing:!0,message:""}};case"expression":return function(t,e,n){return void 0===n&&(n={}),!1===e.expressionManager.validate(r[0],n)?{passing:!1,message:o}:{passing:!0,message:""}};case"requiredExpression":return function(t,e,n){return void 0===n&&(n={}),!0===e.expressionManager.validate(r[0],n)?null==t||""===t?{type:i,passing:!1,message:o||"必填"}:{type:i,passing:!0,message:""}:{passing:!0,message:""}};case"asyncCustomFunction":return function(t,i){return"function"==typeof r[0]?n(r[0](t,i)).pipe(p((function(t){return e(t?{passing:!1,message:t}:{passing:!0,message:""})}))):{passing:!0,message:""}};default:return function(){return{passing:!0,message:""}}}},t.executeValidator=function(t,n,i,r){for(var o=e({passing:!0,message:""}),a=0;a<t.length;a++){var s=t[a](n,i,r);if(ne(s)){o=s;break}if(!1===s.passing)return e(s)}return o},t.noSupportAsynExecuteValidator=function(t,e,n,i){for(var r=0;r<t.length;r++){var o=t[r](e,n,i);if(ne(o))break;if(!1===o.passing)return o}return{passing:!0,message:""}},t}())),ln=t("FormControl",function(){function t(t,e){this.validatorFn=[],this.required=!1,this.requiredExpressionFlag=!1,this.validateExpressionFlag=!1,this.readonly=!1,this.visible=!0,this.validRules=[],this.validRules_validates=[],this.valueAccessor=un.create(t.bindingType,t.bindingPath,t.valueConverter,e),this.validRules=[],t.validRules&&(this.validRules=t.validRules,this.setValidatorFn(t.validRules))}return Object.defineProperty(t.prototype,"value",{get:function(){return this.valueAccessor.getValue()},set:function(t){this.valueAccessor.setValue(t)},enumerable:!0,configurable:!0}),t.prototype.getValidRules=function(){return this.validRules},t.prototype.setValidatorFn=function(t){this.validatorFn=cn.create(t)},t.prototype.pushValidatorFnforValidate=function(t,e){e&&this.validateExpressionFlag||(this.validateExpressionFlag=e,this.validRules_validates=t,this.validatorFn=this.validatorFn.concat(cn.create(t)))},t.prototype.pushValidatorFnforRequired=function(t,e){e&&this.requiredExpressionFlag||(this.requiredExpressionFlag=e,this.validatorFn=this.validatorFn.concat(cn.create(t)))},t.prototype.resetValidatorFnforRequired=function(){this.requiredExpressionFlag=!1,this.validatorFn=cn.create(this.validRules.concat(this.validRules_validates))},t.prototype.getValidatorFn=function(){return this.validatorFn},t}()),hn=t("Form",function(){function t(t){this.viewModelContext=t,this.formControlConfigs=[],this.validateformControls=[],this.validateformControlPathMap=new Map,this.changes=new u}return t.prototype.init=function(){this.collectMetadatas(),this.createFormControls()},t.prototype.getFormValueByBindPath=function(t){var e=this,n={form_name:{},name:"",bindingPath:""};return t=t.replace(/\//g,"."),0===this.formControlConfigs.length||this.formControlConfigs.forEach((function(i){i.bindingPath===t&&(n.form_name=e[i.name],n.name=i.name,n.bindingPath=i.bindingPath)})),n},t.prototype.getValidateformControls=function(){return this.validateformControls},t.prototype.setValidateformControls=function(t){(this.validateformControls&&0===this.validateformControls.length&&this.validateformControls.push(t),this.validateformControls&&this.validateformControls.length>=1)&&(-1===this.validateformControls.findIndex((function(e){return e==t}))&&this.validateformControls.push(t));Array.isArray(this.validateformControls)||(this.validateformControls=[t])},t.prototype.getValidateformControlPathMap=function(){return this.validateformControlPathMap},t.prototype.setValidateformControlPathMap=function(t,e){this.validateformControlPathMap.has(t)||this.validateformControlPathMap.set(t,e)},t.prototype.addValidate=function(t,e){var n=this.viewModelContext.bindingData.bindingPath.slice(1).replace(/\//g,".");n&&(n+="."),this.setValidateformControlPathMap(n+t,e),this.setValidateformControls(e)},t.prototype.validateFields=function(){var t=this,e=[];return 0===this.validateformControls.length||this.validateformControls.forEach((function(n){var i=cn.executeValidator(t[n].validatorFn,t[n].value,t.viewModelContext).pipe(h((function(e){t[n].validationResult=e,!e.passing&&t.changes.next({type:"validateFieldsFinished"})})));e.push(i)})),e},t.prototype.noSupportAsynValidateFields=function(){var t=this,e=[];return 0===this.validateformControls.length||(this.validateformControls.forEach((function(n){t[n].validationResult||(t[n].validationResult=cn.noSupportAsynExecuteValidator(t[n].validatorFn,t[n].value,t.viewModelContext)),!t[n].validationResult.passing&&e.push(t[n])})),this.changes.next({type:"validateFieldsFinished"})),e},t.prototype.getFieldError=function(t){var e=this;return 0===this.validateformControls.length||-1===this.validateformControls.findIndex((function(e){return e===t}))?{}:cn.executeValidator(this[t].validatorFn,this[t].value,this.viewModelContext).pipe(h((function(n){e[t].validationResult=n,!n.passing&&e.changes.next({type:"validateFieldsFinished"})})))},t.prototype.getFieldErrorByPath=function(t){var e=this;if(0===this.validateformControls.length)return{};var n=t[0];return t&&t.length>=2&&(n=t.join(".")),this.validateformControlPathMap.has(n)?(cn.executeValidator(this[this.validateformControlPathMap.get(n)].validatorFn,this[this.validateformControlPathMap.get(n)].value,this.viewModelContext).subscribe((function(t){e[e.validateformControlPathMap.get(n)].validationResult=t,e.changes.next({type:"validateFieldsFinished",value:e.validateformControlPathMap.get(n)})})),this[this.validateformControlPathMap.get(n)].validationResult):{}},t.prototype.resetFieldsValidate=function(t){var e=this;if(0===this.validateformControls.length)return!0;if(t&&t.length>0){var n=new Set(t);this.validateformControls.filter((function(t){return n.has(t)})).forEach((function(t){e[t].validationResult=void 0}))}else this.validateformControls.forEach((function(t){e[t].validationResult=void 0}));this.changes.next({type:"validateFieldsFinished"})},t.prototype.createFormControls=function(){var t=this;this.formControlConfigs.forEach((function(e){var n=e.name,i=new ln(e,t.viewModelContext);t[n]=i}))},t.prototype.collectMetadatas=function(){var t=this,e=Tt.getPropsMetadatasByName(this.constructor,pn),n=this.viewModelContext.bindingData.bindingPath.slice(1).replace(/\//g,"."),i=this.viewModelContext.appContext.validationManager;n&&(n+="."),Object.keys(e).forEach((function(r){var o=e[r],a=null;o.validRules&&(t.validateformControls.push(r),t.validateformControlPathMap.set(n+o.bindingPath,r),a=o.validRules);var s=("/"+n+o.bindingPath).replace(/\./g,"/");i[s]&&(a?a=a.concat(Object.values(i[s])):(t.validateformControls.push(r),t.validateformControlPathMap.set(n+o.bindingPath,r),a=Object.values(i[s])));var u={name:r,bindingType:o.bindingType,bindingPath:o.bindingPath,valueConverter:o.valueConverter,valueChanging:o.valueChanging,valueChanged:o.valueChanged,validRules:a};t.formControlConfigs.push(u)}))},t.prototype.getEntityValueChangingListeners=function(){var t={};return this.formControlConfigs.forEach((function(e){e.valueChanging&&(t[e.bindingPath]=e.valueChanging)})),t},t.prototype.getEntityValueChangedListeners=function(){var t={};return this.formControlConfigs.forEach((function(e){e.valueChanged&&(t[e.bindingPath]=e.valueChanged)})),t},t}()),fn=t("COMMAND_METHOD_META","CommandMethodMeta"),dn=(t("CommandMethodMeta",St(fn,(function(t){return t}))),t("RESOLVER_TOKEN",new tt("@farris_resolver_token"))),yn=t("ENTITY_TEMPLATE","ENTITY~"),gn=t("STATE_TEMPLATE","STATE~"),vn=t("GROUP_FUNCTIONS",["SumByProp","CountByProp","AvgByProp","MaxByProp","MinByProp","IsExistRecord","ListContains","ListGreaterThan","ListLessThan","ListStartWith","ListEndWith"]),mn=t("ResolverRegistry",(function(t){this.viewModelContext=t,this.resolvers=this.viewModelContext.injector.get(dn,[])})),En=t("EntityDependencyResolver",function(){function t(t){this.viewModelContext=t,this.repository=this.viewModelContext.repository,this.entityTypeInfo=this.repository.entityTypeInfo}return t.prototype.resolve=function(t){var e=wn.getGroupFunctionDependency(t,this.repository.entityTypeInfo),n=this.getEntityDependency(t);e&&e.length>0&&n&&n.length>0&&e.forEach((function(t){var e=n.findIndex((function(e){return t.startsWith(e)}));-1!==e&&n.splice(e,1)}));var i=_(e,n);return _(new Set(i))},t.prototype.getValidEntityPropertyExpression=function(t){var e=t.split("."),n=null;try{n=this.entityTypeInfo.getPropInfoByPath(e)}catch(t){}return n?t.split("."):e.length>1?(e.pop(),this.getValidEntityPropertyExpression(e.join("."))):null},t.prototype.getEntityDependency=function(t){var e=this,n=[];if(this.entityTypeInfo){var i=new RegExp("[\\'\\\"]?\\s*("+this.entityTypeInfo.entityInfo.nodeCode+"|"+this.entityTypeInfo.entityInfo.originalCode+")[\\.\\[\\]a-zA-Z0-9_]+\\s*[\\'\\\"]?","g"),r=t.match(i);Array.isArray(r)&&r.length>0&&r.forEach((function(t){if(-1!==t.indexOf(".")){t=t.trim().replace(/\"/g,""),t=(t=wn.convertToNodeCode(t,e.repository.entityTypeInfo).join(".")).substr(t.indexOf(".")+1);var i=e.getValidEntityPropertyExpression(t);i&&Array.isArray(i)&&i.length>0&&(i.splice(0,0,yn),n.push(i.join("/")))}else console.warn("无效的实体表达式:"+t)}))}else console.warn("获取实体类型信息失败，请重新编译改表单。");return n},t}()),bn=["GetContextParameter","GetSessionValue"],Cn=t("StateDependencyResolver",function(){function t(t){this.viewModelContext=t}return t.prototype.resolve=function(t){var e=[],n=new RegExp("DefaultFunction\\.("+bn.join("|")+")\\s*\\([^\\r\\n\\)]*\\)","g"),i=t.match(n);if(i&&i.length>0){var r=/\(([^\r\n\)]*)\)/;i.forEach((function(t){var n=t.match(r);if(2===n.length){var i=n[1].trim().replace(/\"/g,""),o=["STATE~"];o.push(i),e.push(o.join("/"))}}))}return e},t}()),xn=t("CommentDependencyResolver",function(){function t(){}return t.prototype.resolve=function(t){var e=[];if(!t||t.length<1)return e;var n=t.match(/\/\*\*\s*__define__\((.*)\)\s*\*\//);if(n&&2===n.length){var i=n[1].trim(),r=null;try{r=JSON.parse(i)}catch(t){console.warn("自定义依赖解析失败："+i)}r&&r.hasOwnProperty("deps")&&Array.isArray(r.deps)&&e.push.apply(e,_(r.deps))}return e},t}()),Pn=t("ResolveService",function(){function t(t){this.viewModelContext=t,this.resolverRegistry=this.viewModelContext.injector.get(mn)}return t.prototype.resolve=function(t){var e=[];if(this.resolverRegistry&&this.resolverRegistry.resolvers&&!(this.resolverRegistry.resolvers.length<1)){var n=this.resolverRegistry.resolvers.find((function(t){return t instanceof xn}));if(n){var i=n.resolve(t);i&&Array.isArray(i)&&i.length>0&&e.push.apply(e,_(i))}if(!(e&&e.length>0))return this.resolverRegistry.resolvers.forEach((function(n){if(!(n instanceof xn)){var i=n.resolve(t);i&&i.length>0&&e.push.apply(e,_(i))}})),_(new Set(e))}},t}()),wn=t("ExpressionUtil",function(){function t(){}return t.getGroupFunctionDependency=function(t,e){var n=this,i=[],r=new RegExp("DefaultFunction\\.("+vn.join("|")+")\\s*\\([^\\r\\n\\)]*\\)","g"),o=t.match(r);if(o&&o.length>0){var a=/\(([^\r\n\)]*)\)/;o.forEach((function(t){var r=t.match(a);if(2===r.length){var o=r[1],s=o.split(",").map((function(t){return t.replace(/\"/g,"")}));if(!s||2!==s.length)throw new Error("无法解析参数： "+JSON.stringify(o));var u=s.join("."),p=(u=(u=n.convertToNodeCode(u,e).join(".")).substr(u.indexOf(".")+1)).split(".");p.splice(0,0,yn),i.push(p.join("/"))}}))}return i},t.convertToNodeCode=function(t,e){var n=[];if(e&&t.includes("."))for(var i=t.split(".")||[],r=e,o=0;o<i.length;o++){var a=i[o];if(r&&r.entityInfo&&r.entityInfo.nodeCode===a||r.entityInfo.originalCode===a){0===o?n.push(r.entityInfo.originalCode):n.push(r.entityInfo.nodeCode);var s=i[o+1];if(!s)break;var u=r.getPropInfoByName(s);if(!u)break;u.typeInfo&&(r=u.typeInfo)}else{if(!r||!r.getPropInfoByName(a))break;var p=r.getPropInfoByName(a);n.push(p.name)}}return n},t.getChildrenEntityPaths=function(t,e,n){var i=this;void 0===n&&(n=[]);var r=t.getPropInfosByGroup(Bt.List);r&&r.length>0?r.forEach((function(t){0===n.length&&e.push([t.name]);var r=t.typeInfo.getPropInfosByGroup(Bt.List);r&&r.length>0?(n.push(t.name),r.forEach((function(t){i.getChildrenEntityPaths(t.typeInfo,e,n)}))):(0!==n.length&&(n.push(t.name),e.push(_(n))),n.length=0)})):(n.length>0&&(n.push(t.entityInfo.nodeCode),e.push(_(n))),n.length=0)},t.getCurrentRowByPaths=function(t,e){var n=null,i=e.getValue(t);if(i&&i.length>0){var r=i.currentItem.primaryKeyValue||null;if(r){var o=i.findById(r);o&&(n=o.toJSON())}}return n},t.getAvailableChildrenPathsFromEntityPaths=function(t,e){var n=[];for(t=_(t);t.length>0;){if("List"===e.getPropInfoByPath(t).group){n=t;break}t.pop()}return n},t.getBindingPath=function(t,e){return t=this.getEntityPath(t),this.getAvailableChildrenPathsFromEntityPaths(t,e)},t.getEntityPath=function(t){return t.filter((function(t,e){return e%2!=0||!t.includes(":")}))},t}()),Mn=t("Core",function(){function t(){}return t.warn=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.logable()&&console&&console.warn.apply(console,_([t],e))},t.error=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.logable()&&console&&console.error.apply(console,_([t],e))},t.log=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.logable()&&console&&console.log.apply(console,_([t],e))},t.logable=function(){return window&&window.localStorage&&"true"===window.localStorage.getItem("__DEVKIT_LOGABLE__")||!1},t}()),In=(t("FORM_PATH_TOKEN",new tt("@farris/devkit form path token")),t("BACK_END_MESSAGE_HANDLER_TOKEN",new tt("@farris/devkit_back_end_message_handler")),t("MESSAGE_SERVICE_TOKEN",new tt("@farris/message_service_token"))),Sn=t("NOTIFY_SERVICE_TOKEN",new tt("@farris/notify_service_token")),On=t("NAMESPACE",new tt("@farris/devkit NAMESPACE"));t("BigNumberType","BigNumber");!function(t){var e;(e=t.Level||(t.Level={})).Error="Error",e.Info="Info",e.Warning="Warning";var n=function(t,e){this.bizMessages=t,this.context=e};t.Message=n}(on||(on=t("BackEndMessage",{})));var Tn,jn=t("EFFECTOR_TOKEN",new tt("@farris/effector_token")),Dn=t("RepositoryEffector",function(){function t(t){this.viewModelContext=t,this.ns=this.viewModelContext.injector.get(On,""),this.repository=this.viewModelContext.repository,this.bindingData=this.viewModelContext.bindingData}return t.prototype.effect=function(t,e,n){if(!n||!n.path)throw new Error("repository effector 需要指定行信息。");var i=n.path,r=i[0]||this.bindingData.list.currentItem.primaryKeyValue,o=this.repository.entityCollection.getEntityById(r);if(!r||o){for(var a=i.pop(),s=o,u=1;u<i.length;u++){var p=i[u];s=s instanceof me?s.get(p):s[p]}s?s[a]!==e&&(s[a]=e):console.error("找不到实体对应的路径："+i.push(a))}else console.error("找不到id："+r+"对应的实体！")},t}()),Nn=t("UIStateEffector",function(){function t(t){this.viewModelContext=t,this.ns=this.viewModelContext.injector.get(On,""),this.uiState=this.viewModelContext.uiState}return t.prototype.effect=function(t,e,n){this.uiState.setPropertyValue(t,e)},t}()),Rn=t("EffectorRegistry",(function(t){this.viewModelContext=t,this.effectors=this.viewModelContext.injector.get(jn)}));!function(t){var e,n,i,r,o,a;(e=t.ExpressionBindingType||(t.ExpressionBindingType={})).State="State",e.Field="Field",(n=t.ExpressionType||(t.ExpressionType={})).Required="require",n.Readonly="readonly",n.Compute="compute",n.Dependency="dependency",n.Visible="visible",n.Relative="relative",n.Validate="validate",n.DataPicking="dataPicking",(i=t.EventType||(t.EventType={})).ValueChanged="VALUE_CHANGED",i.SelectionChanged="SELECTION_CHANGED",i.Load="Load",i.Append="Append",i.Remove="Remove",i.Update="Update",(r=t.EventSource||(t.EventSource={})).Field="Field",r.State="State",r.BindingData="BindingData",r.Repository="Repository",(o=t.MessageType||(t.MessageType={})).error="error",o.info="info",o.warning="warning",(a=t.EffectPath||(t.EffectPath={}))[a.currentRow=0]="currentRow",t.MESSAGE={"zh-CHS":{require:"请输入'$property'",validate:"'$property'校验不通过"},en:{require:"Please input '$property'",validate:"'$property' calibration failed"},"zh-CHT":{require:"請輸入'$property'",validate:"'$property'校驗不通過"}},t.DEPENDENCY_SPLITER="/"}(Tn||(Tn=t("Expression",{})));var Vn=t("LISTENER_TOKEN",new tt("@Farris listener")),_n=t("ɵe",function(){function t(){this.subject=new u}return Object.defineProperty(t.prototype,"onEvent",{get:function(){return this.subject},enumerable:!0,configurable:!0}),t.prototype.findEntityPaths=function(t,e,n){var i=this;void 0===n&&(n=[]);var r=t.getPropInfosByGroup(Bt.List);r&&r.length>0?r.forEach((function(t){n.push(t.name);var r=t.typeInfo.getPropInfosByGroup(Bt.List);r&&r.length>0?r.forEach((function(t){i.findEntityPaths(t.typeInfo,e,n)})):e.push(n)})):n&&n.length>0&&e.push(n)},t}()),An=t("UIStateChangeListener",function(t){function e(e){var n=t.call(this)||this;return n.viewModelContext=e,n.frameId=n.viewModelContext.id,n.uiState=n.viewModelContext.uiState,n.namespace=n.viewModelContext.injector.get(On,null),n.registerEvent(),n}return j(e,t),e.prototype.buildEventPath=function(t){return null},e.prototype.registerEvent=function(){var t=this;this.uiState&&this.uiState.changes&&this.uiState.changes.subscribe((function(e){var n={ns:t.namespace,path:[e.field],type:Tn.EventType.ValueChanged,value:e.value,source:Tn.EventSource.State,frameId:t.frameId};t.subject.next(n)}))},e}(_n));Tn.EventType;var Bn=t("RepositoryChangeListener",function(t){function e(e){var n=t.call(this)||this;return n.viewModelContext=e,n.namespace=n.viewModelContext.injector.get(On,null),n.repository=n.viewModelContext.repository,n.bindingData=n.viewModelContext.bindingData,n.registerEvent(),n}return j(e,t),e.prototype.registerEvent=function(){var t=this;this.repository&&this.repository.changes&&this.repository.changes.subscribe((function(e){var n=t.convertEventType(e);if(n){var i=t.buildEventPath(e),r={ns:t.namespace,type:n,path:i,value:e.value,source:Tn.EventSource.Field};t.subject.next(r)}})),this.repository&&this.repository.entityCollectionChange&&this.repository.entityCollectionChange.subscribe((function(e){var n=t.convertEventType(e);if(n){var i=t.buildEventPath(e),r={ns:t.namespace,type:n,path:i,value:e.value,source:Tn.EventSource.Repository};t.subject.next(r)}}))},e.prototype.buildEventPath=function(t){var e=this,n=t.path,i=[];return!n||n.length<1?i:i=n.filter((function(t,n){if(n%2==0&&t.includes(":")){if(":"===t)return!1;if(t.split(":")[0]!==e.repository.primaryKey)return!1}return!0}))},e.prototype.convertEventType=function(t){var e=null;return t.type===Ot.Add||t.type===Ot.AddData||t.type===Ot.Insert||t.type===Ot.Remove||t.type===Ot.RemoveData||t.type===Ot.Load||t.type===Ot.ValueChange||t.type===Ot.Update&&(e=Tn.EventType.Update),e},e}(_n)),Fn=t("ListenerRegistry",(function(t){this.viewModelContext=t,this.listeners=this.viewModelContext.injector.get(Vn)})),Ln=Tn.EventType,kn=t("BindingDataChangeListener",function(t){function e(e){var n=t.call(this)||this;return n.viewModelContext=e,n.repository=null,n.namespace=n.viewModelContext.injector.get(On,""),n.repository=n.viewModelContext.repository,n.bindingData=n.viewModelContext.bindingData,n.registerEvent(),n}return j(e,t),e.prototype.registerEvent=function(){var t=this;this.bindingData&&this.bindingData.changes&&"function"==typeof this.bindingData.changes.subscribe&&this.bindingData.changes.subscribe((function(e){if(e.type===Ht.Append||e.type===Ht.ValueChanged||e.type===Ht.Remove||e.type===Ht.Load||e.type===Ht.SelectionChanged){var n=null;e.type===Ht.Append?n=Ln.Append:e.type===Ht.ValueChanged?n=Ln.ValueChanged:e.type===Ht.Remove?n=Ln.Remove:e.type===Ht.Load?n=!0===e.create?Ln.Append:Ln.Load:e.type===Ht.SelectionChanged&&(n=Ln.SelectionChanged);var i=t.buildEventPath(e),r={ns:t.namespace,path:i,type:n,source:Tn.EventSource.BindingData,value:e.value,id:e.id};t.subject.next(r)}}))},e.prototype.buildEventPath=function(t){var e=t.path,n=[],i=this.bindingData.list.currentItem.primaryKeyValue;i&&(t.type===Ht.Load&&0===t.path.length||n.push(this.bindingData.list.primaryKey+":"+i));for(var r=[],o=0;o<e.length;o++){var a=e[o];r.push(a);var s=this.bindingData.getValue(r);if(n.push(a),s instanceof te&&r.length<e.length){var u=s.currentItem.primaryKeyValue;o===e.length-2&&t.id&&(u=t.id),n.push(this.bindingData.list.primaryKey+":"+u)}}return n},e}(_n)),Hn=t("Listeners",function(){function t(t){this.viewModelContext=t,this.subject=new u,this.registry=this.viewModelContext.injector.get(Fn,null),this.regist()}return Object.defineProperty(t.prototype,"onEvent",{get:function(){return this.subject},enumerable:!0,configurable:!0}),t.prototype.regist=function(){var t=this,e=this.registry&&this.registry.listeners||[];e&&e.length>0&&e.forEach((function(e){e.onEvent.subscribe((function(e){t.subject.next(e)}))}))},t}()),Kn=t("ExpressionEventEmitter",function(){function t(t){var e=this;this.viewModelContext=t,this.listeners=this.viewModelContext.injector.get(Hn),this.events=new Array,this.listeners.onEvent.subscribe((function(t){if(e.onEvent&&e.onEvent.observers.length>0){var n=[];e.events.length>0&&(n=_(e.events)),n.push(t),e.onEvent.next(n),e.events=[]}else e.events.push(t)}))}return t.prototype.attach=function(){return this.onEvent||(this.onEvent=new a(this.events)),this.onEvent.asObservable()},t}()),Un=et("@farris/devkit TranslateToken"),qn=(t("FORM_MANIFEST_SERVICE_TOKEN",new tt("@farris/form_manifest_service")),t("FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN",new tt("@farris/form_expression_manifest_service"))),Yn=t("ExpressionRegistry",function(){function t(t){this.viewModelContext=t,this._expressions=null,this.injector=this.viewModelContext.injector,this.formExpressionManifestService=this.injector.get(qn,null),this.translate=this.injector.get(Un,null)}return t.prototype.load=function(){var t=this;return this.formExpressionManifestService.load().pipe(p((function(n){var i=t.setExpressions(n);return t.cleanSpecialCharacters(),e(i)})),f((function(t){return e([])})))},t.prototype.setExpressions=function(t){var e=this,n=[],i=Array.from(t),r=this.viewModelContext.injector.get(Be);return i.forEach((function(t){t.expressions.forEach((function(i){var o,a,s={id:i.id,ns:t.ns,viewModelId:t.viewModelId,path:t.path,bindingType:t.type,type:i.type,expression:i.value||i.expr||"",message:i.message||null,messageType:i.messageType||null,deps:[]};if(i.type===Tn.ExpressionType.Required){var u={type:"requiredExpression",constraints:[i.id],message:i.message};r.validationManager[t.path]=D({},r.validationManager[t.path]||{},((o={})[i.id]=u,o))}if(i.type===Tn.ExpressionType.Validate){u={type:"expression",constraints:[i.id],message:i.message};r.validationManager[t.path]=D({},r.validationManager[t.path]||{},((a={})[i.id]=u,a))}i.type!==Tn.ExpressionType.Required&&i.type!==Tn.ExpressionType.Validate||(i.message||(s.message=e.getExpressionMessage(i.type)),i.messageType||(s.messageType="error")),s.message&&e.transform(s),n.push(s)}))})),this._expressions=n,n},Object.defineProperty(t.prototype,"expressions",{get:function(){return this._expressions?e(this._expressions):window.__expressions__?(this.setExpressions(window.__expressions__),e(this._expressions)):this.load()},enumerable:!0,configurable:!0}),t.prototype.getExpressionById=function(t){return!this._expressions||this._expressions.length<1?null:this._expressions.find((function(e){return e.id===t}))},t.prototype.getExpressionMessage=function(t,e){if(t!==Tn.ExpressionType.Validate&&t!==Tn.ExpressionType.Required)return null;if(!this.translate)return e;var n=this.translate.getCurrentLanguage()||"zh-CHS";return Tn.MESSAGE[n][t]},t.prototype.transform=function(t){this.translate&&t.message&&t.message.startsWith("{{")&&t.message.endsWith("}}")&&(t.message=this.translate.transform(t.message.substr(2,t.message.length-4),null)||this.getExpressionMessage(t.type))},t.prototype.cleanSpecialCharacters=function(){var t=this;if(this._expressions&&!(this._expressions.length<1)&&Array.isArray(this._expressions)){var e=this.viewModelContext.repository;if(e){var n=e.entityTypeInfo,i=new RegExp("[\\'\\\"]?\\s*("+n.entityInfo.nodeCode+"|"+n.entityInfo.originalCode+")[\\.\\[\\]a-zA-Z0-9_]+\\s*[\\'\\\"]?","g");this._expressions.forEach((function(e){var n=e.expression.match(i);Array.isArray(n)&&n.length>0&&n.forEach((function(n){if(-1!==n.indexOf(".")){if(/\[\d\]/g.test(n)){var i=n.replace(/\[\d\]/g,"");e.expression=t.replaceAll(e.expression,n,i)}if(/\*/g.test(n)){i=n.replace(/\*/g,"");e.expression=t.replaceAll(e.expression,n,i)}}else console.warn("无效的实体表达式:"+n)}))}))}}},t.prototype.replaceAll=function(t,e,n){return t.split(e).join(n)},t}()),Jn=t("ExpressionExecutor",function(){function t(){}return t.prototype.compile=function(t,e){if("[object Object]"!==Object.prototype.toString.call(e))throw new Error("上下文必须为对象！");var n=this.buildContext(e);if(!t.factory){var i=new I(t.expression,n);t.factory=i.compile()}return t.factory.eval(n)},t.prototype.eval=function(t,e){if("[object Object]"!==Object.prototype.toString.call(e))throw new Error("上下文必须为对象！");var n=this.buildContext(e);return new S(n).eval(t)},t.prototype.buildContext=function(t){var e=new O;return t&&Object.keys(t).length>0&&Object.keys(t).forEach((function(n){e.set(n,t[n])})),e},t}()),zn=t("EventHandler",function(){function t(t){this.frameContext=t,this.injector=t.injector,this.repository=t.repository,this.bindingData=t.bindingData,this.expressionRegistry=this.injector.get(Yn,null),this.effectorFactory=this.injector.get(mi,null),this.expressionExecutor=this.injector.get(Jn),this.expressionResult=this.injector.get(pi,null)}return t.prototype.handleEvent=function(t,e){t=Object.assign({},t),this.expressionObjects=e,this.dispatch(t)},Object.defineProperty(t.prototype,"primaryValue",{get:function(){return this.bindingData.list.currentItem.primaryKeyValue},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"entityOriginalNodeCode",{get:function(){return this.repository&&this.repository.entityTypeInfo&&this.repository.entityTypeInfo.entityInfo&&this.repository.entityTypeInfo.entityInfo.originalCode||null},enumerable:!0,configurable:!0}),t.prototype.perform=function(t,e){return this.expressionExecutor.compile(t,e)},t.prototype.effect=function(t,e){var n=e.bindingType,i=this.effectorFactory.getEffector(e);if(i){if(n!==Tn.ExpressionBindingType.Field)throw new Error("not supported！");var r=e.effectPaths||[];if(r.length>0)r.forEach((function(n){var r={path:n.split("/"),message:e.message,expressionId:e.id,eventType:t.type,viewModelId:e.viewModelId};i.effect(e.path,e.result,r)}));else if(e.type===Tn.ExpressionType.Required||e.type===Tn.ExpressionType.Validate||e.type===Tn.ExpressionType.Readonly||e.type===Tn.ExpressionType.Visible){var o={message:e.message,expressionId:e.id,eventType:t.type,viewModelId:e.viewModelId};i.effect(e.path,e.result,o)}}},t.prototype.isValidateOrRequiredExpression=function(t){return t&&(t.type===Tn.ExpressionType.Validate||t.type===Tn.ExpressionType.Required)},t.prototype.getEntityPathFromEvent=function(t){if(!(t=JSON.parse(JSON.stringify(t)))||!t.path||t.path.length<1)return[];var e=t.path;return this.getEntityPath(e)},t.prototype.getEntityPath=function(t){return t.filter((function(t,e){return e%2!=0||!t.includes(":")}))},t.prototype.buildEntityPath=function(t){return t.filter((function(t,e){return e%2!=0||!t.includes(":")}))},t.prototype.cleanEventPath=function(t){return(t=t.filter((function(t){return!(!t||":"===t)}))).map((function(t){return t.includes(":")?t.split(":")[1]:t}))},t.prototype.getCurrentRowByPaths=function(t){var e=null,n=this.bindingData.getValue(t);if(n&&n.length>0){var i=n.currentItem.primaryKeyValue||null;if(i){var r=n.findById(i);r&&(e=r.toJSON())}}return e},t.prototype.getEventId=function(t,e){if(!t||t.length<1)throw new Error("invalid path!");var n=t.findIndex((function(t){return t===e}));if(-1===n)return null;var i=n+1;if(i>t.length-1)throw new Error("invalid propertyName or path");var r=t[i];if(-1===r.indexOf(":"))throw new Error("compute error.");return r.split(":")[1]},t.prototype.buildStateContext=function(t){var e=t.ns,n=this.injector.get(Be,null).viewModelContextManager.getContextsByNamespace(e),i={};if(n&&n.length>0){var r=n[0].getVirtualRootFrameContext();if(r){var o=r.viewModel.uiState;(Object.getOwnPropertyNames(o)||[]).forEach((function(t){null!==t.match(/^[a-zA-Z0-9_\$]+$/g)&&(i[t]=o[t])}))}}return i},t.prototype.buildEntityContext=function(t,e,n){var i=this,r=e.bindingType;if(r===Tn.ExpressionBindingType.Field){var o=this.repository.entityTypeInfo,a=[];wn.getChildrenEntityPaths(o,a);var s=n&&n.find((function(t){return""===t.bindingPath||"/"===t.bindingPath}))||null,u=s&&s.primaryValue||this.bindingData.list.currentId,p=this.bindingData.list.findById(u);if(!p)return null;var c=p.toJSON();return c.__type__="Entity",!a||a.length<1?c:(a.sort((function(t,e){return t.length-e.length})),a.forEach((function(t){var e=i.bindingData.getValue(t),r=e.currentId,o=t[t.length-1],a=t.slice(0,t.length-1).reduce((function(t,e){return t&&t[e]||null}),c);if(a){var s=a,u=null;if(r){if(n&&n.length>0){var p=n.find((function(e){return e.bindingPath.split("/").filter((function(t){return t})).join("/")===t.join("/")}));p&&(r=p.primaryValue)}var l=e.findById(r),h=a[o];(u=D({__items__:[]},l&&l.toJSON()||{},{__type__:"List"})).length=function(){return u.__items__.length},h&&Array.isArray(h)&&(u.__items__=[].concat(h))}else(u={__items__:[],__type__:"List"}).length=function(){return u.__items__.length};s[o]=u}})),c)}if(r!==Tn.ExpressionBindingType.State)return null},t.prototype.buildContext=function(t,e,n,i){var r,o=[];if(n)o.push(n);else{var a=this.buildEntityContext(e,t,i);o.push(a)}var s=this.buildStateContext(e),u=this.entityOriginalNodeCode,p=null;return 1===o.length?p=o.pop():((p=o[0]).__type__||(p.__type__="Entity"),p.__items__=o),D(((r={})[u]=p,r),s,{frameContext:this.frameContext,bindingData:this.bindingData,repository:this.repository})},t.prototype.buildEffectPath=function(t,e){var n=e.path.split("/").filter((function(t){return t})),i=t.path[0]&&t.path[0].split(":")[1];if(!i)throw new Error("Invalid event path!");if(1===n.length)return[i,n.pop()];for(var r=[i],o=0;o<n.length;o++){var a=n[o];r.push(a);var s=n.slice(0,o+1),u=this.repository.entityTypeInfo.getPropInfoByPath(s);if("List"===u.group){var p=this.getEventId(t.path,u.name)||null;if(!p){var c=this.bindingData.getValue(s);c&&(p=c.currentId)}r.push(p)}}return r},t.prototype.getPathInfo=function(t){var e=t.split("/").filter((function(t){return t})),n=wn.getAvailableChildrenPathsFromEntityPaths(e,this.repository.entityTypeInfo),i=e.slice(n.length).join("/");return{path:n.join("/"),propertyName:i,paths:n,propertyNames:i.split("/").filter((function(t){return t}))}},t.prototype.getTablePathsFromEventPaths=function(t){return t=this.getEntityPath(t),wn.getAvailableChildrenPathsFromEntityPaths(t,this.repository.entityTypeInfo)},t.prototype.getPropertyPathsFromEventPaths=function(t){t=this.getEntityPath(t);var e=wn.getAvailableChildrenPathsFromEntityPaths(t,this.repository.entityTypeInfo);return t.slice(e.length)},t.prototype.analysis=function(t,e){var n=this.getPathInfo(e.path),i=this.getEntityPath(t.path.slice(0)),r=this.getPathInfo(i.join("/"));if(!n||!r)return console.warn("表达式路径或事件路径错误，获取路径信息失败。"),null;var o=n.path.split("/").filter((function(t){return t})),a=n.propertyName.split("/").filter((function(t){return t})),s=r.path.split("/").filter((function(t){return t})),u={distance:void 0,eventFromChildren:void 0,eventFromParent:void 0,expressionTablePaths:o,expressionPropertyNames:a,eventTablePaths:s,eventPropertyNames:r.propertyName.split("/").filter((function(t){return t})),isSameTable:!1};return u.distance=Math.abs(o.length-s.length),1===u.distance&&(u.eventFromChildren=s.length>o.length&&s.join("/").startsWith(o.join("/")),u.eventFromParent=s.length<o.length&&o.join("/").startsWith(s.join("/"))),u.isSameTable=o.join("/")===s.join("/"),u},t.prototype.buildCurrentRows=function(t,e){var n=new Array;if(!t||t.length<1)n.push({bindingPath:"/",primaryValue:e[0]});else{var i=[];t.forEach((function(t,r){0===r&&n.push({bindingPath:"/",primaryValue:e[0]}),i.push(t);var o=e[2*r+2];n.push({bindingPath:i.join("/"),primaryValue:o})}))}return n},t}()),Wn=t("EntityValueChangedEventHandler",function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return j(e,t),e.prototype.filter=function(t){return null},e.prototype.dispatch=function(t){},e.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},e}(zn)),Gn=function(){function t(){}return t.effect=function(t,e,n){!n||n.length<1||n.forEach((function(n){var i={path:n,message:e.message,expressionId:e.id,viewModelId:e.viewModelId,eventType:e.eventType};t.effect(e.path,e.result,i)}))},t}(),$n=t("StateValueChangedEventHandler",function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return j(e,t),e.prototype.filter=function(t){var e=this;return this.expressionObjects&&this.expressionObjects.length>0?this.expressionObjects.filter((function(n){var i=n.deps;if(!i||i.length<1||t.ns!==n.ns)return!1;var r=e.cleanEventPath(t.path);r.splice(0,0,gn);var o=r.join("/");return!!i.includes(o)})):null},e.prototype.dispatch=function(t){var e=this,n=this.filter(t);n&&n.length>0&&n.forEach((function(n){var i=e.buildContext(n,t),r=e.perform(n,i);(void 0!==r||e.isValidateOrRequiredExpression(n))&&(n.result=r,n.id&&e.expressionResult.set(n.id,n.result),e.effect(t,n))}))},e.prototype.effect=function(t,e){var n=this,i=this.effectorFactory.getEffector(e),r=e.bindingType;if(r===Tn.ExpressionBindingType.State)i.effect(e.path,e.result,{message:e.message,eventType:t.type,viewModelId:e.viewModelId});else if(r===Tn.ExpressionBindingType.Field){var o=this.getPathInfo(e.path),a=o.paths,s=this.repository.entityCollection.getAllEntities();this.effectRows(s,a,o.propertyNames,(function(r,o){n.output(t,e,r,i,[o])}))}},e.prototype.output=function(t,e,n,i,r){var o=this.buildContext(e,t,null,n),a=this.perform(e,o);void 0!==a&&(e.result=a,e.id&&this.expressionResult.set(e.id,e.result),Gn.effect(i,e,r))},e.prototype.effectRows=function(t,e,n,i,r,o,a){var s=this;if(void 0===r&&(r=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),!e||e.length<1)t.forEach((function(t){if(t&&t.primaryValue){var e=a.concat([t.primaryValue]).concat(n),s=r.concat([{bindingPath:o.join("/")||"/",primaryValue:t.primaryValue}]);i(s,e)}})),r.length=0,a.length=0;else{var u=!1,p=o;t.forEach((function(t){var c=e[0],l=t[c];if(l&&!(l.count()<1)){r.push({bindingPath:o.join("/")||"/",primaryValue:t.primaryValue}),a.push(t.primaryValue),a.push(c),!1===u&&(u=!0,p.push(c));var h=e.slice(1);s.effectRows(l.items,h,n,i,r,p,a)}}))}},e.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},e}(zn)),Xn=t("RepositoryAddEntityEventHandler",function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return j(e,t),e.prototype.filter=function(t){return null},e.prototype.dispatch=function(t){var e=this,n=this.filter(t);n&&n.length>0&&n.forEach((function(n){var i=e.buildEntityContext(t,n),r=e.buildContext(n,t,i),o=e.perform(n,r);(void 0!==o||e.isValidateOrRequiredExpression(n))&&(n.result=o,n.id&&e.expressionResult.set(n.id,n.result),e.effect(t,n))}))},e.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},e}(zn)),Zn=t("RepositoryRemoveEntityEventHandler",function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return j(e,t),e.prototype.filter=function(t){return null},e.prototype.dispatch=function(t){},e}(zn)),Qn=t("RepositoryLoadEventHandler",function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return j(e,t),e.prototype.filter=function(t){return null},e.prototype.dispatch=function(t){var e=this,n=this.filter(t);n&&n.length>0&&n.forEach((function(n){var i=e.buildEntityContext(t,n),r=e.buildContext(n,t,i),o=e.perform(n,r);(void 0!==o||e.isValidateOrRequiredExpression(n))&&(n.result=o,n.id?e.expressionResult.set(n.id,n.result):console.warn("EventHandler 表达式未设置唯一标识，无法更新表达式值。"),e.effect(t,n))}))},e.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},e}(zn)),ti=t("EntityUpdateEventHandler",function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return j(e,t),e.prototype.filter=function(t){var e=this;return this.expressionObjects.filter((function(n){if(n.ns!==t.ns||!n.deps||0===n.deps.length||n.type===Tn.ExpressionType.Compute||n.type===Tn.ExpressionType.Dependency||n.type===Tn.ExpressionType.DataPicking)return!1;var i=e.analysis(t,n);return!!i&&(0===i.expressionTablePaths.length&&-1!==n.deps.findIndex((function(t){if(!t.startsWith(yn))return!1;var n=t.split(Tn.DEPENDENCY_SPLITER).filter((function(t){return t})).slice(1),i=e.getPathInfo(n.join("/"));return!!i&&0===i.paths.length})))}))},e.prototype.dispatch=function(t){var e=this,n=this.filter(t);n&&n.length>0&&n.forEach((function(n){var i=e.buildEntityContext(t,n),r=e.buildContext(n,t,i),o=e.perform(n,r);(void 0!==o||e.isValidateOrRequiredExpression(n))&&(n.result=o,n.id?e.expressionResult.set(n.id,n.result):console.warn("EventHandler 表达式未设置唯一标识，无法更新表达式值。"),e.effect(t,n))}))},e.prototype.getCurrentRowByEvent=function(t,e){var n=null,i=this.bindingData.getValue(t),r=this.getEntityPath(e.path);if(i&&i.length>0){var o=i.currentItem.primaryKeyValue||null,a=wn.getAvailableChildrenPathsFromEntityPaths(r,this.repository.entityTypeInfo);if(a&&a.toString()===t.toString()&&((o=e.id||null)||(o=this.getEventId(e.path,t[t.length-1]))),o){var s=i.findById(o);s&&(n=s.toJSON())}}return n},e}(zn)),ei=t("BindingDataAppendObjectEventHandler",function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return j(e,t),e.prototype.filter=function(t){var e=this;if(this.expressionObjects&&this.expressionObjects.length>0){var n=this.expressionObjects.filter((function(n){if(n.ns!==t.ns||!n.deps||n.deps.length<1)return!1;var i=e.buildEntityPath(t.path),r=e.analysis(t,n);return!!r&&((0!==i.length||n.bindingType!==Tn.ExpressionBindingType.Field)&&(i.splice(0,0,yn),r.eventTablePaths.length-1===r.expressionTablePaths.length&&(!!r.eventTablePaths.join(Tn.DEPENDENCY_SPLITER).startsWith(r.expressionTablePaths.join(Tn.DEPENDENCY_SPLITER))&&-1!==n.deps.findIndex((function(t){if(!t.startsWith(i.join(Tn.DEPENDENCY_SPLITER)))return!1;var n=t.split(Tn.DEPENDENCY_SPLITER).filter((function(t){return t})).slice(1),o=e.getPathInfo(n.join(Tn.DEPENDENCY_SPLITER));return!(!o||o.paths.join(Tn.DEPENDENCY_SPLITER)!==r.eventTablePaths.join(Tn.DEPENDENCY_SPLITER))})))))})),i=this.buildEntityPath(t.path),r=this.expressionObjects.filter((function(n){if(n.ns!==t.ns)return!1;if(e.getPathInfo(n.path).paths.join(Tn.DEPENDENCY_SPLITER)!==i.join(Tn.DEPENDENCY_SPLITER))return!1;if(!n.deps||n.deps.length<1)return!0;if(n.deps.every((function(t){return t.startsWith(gn)})))return!0;var r=e.analysis(t,n);return!(!r||0!==r.distance||!r.isSameTable)}));return n.concat(r)}return null},e.prototype.dispatch=function(t){var e=this,n=this.filter(t);n&&n.length>0&&n.forEach((function(n){var i=e.buildEntityContext(t,n),r=e.buildContext(n,t,i),o=e.perform(n,r);(void 0!==o||e.isValidateOrRequiredExpression(n))&&(n.result=o,n.id?e.expressionResult.set(n.id,n.result):console.warn("EventHandler 表达式未设置唯一标识，无法更新表达式值。"),e.effect(t,n))}))},e.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},e.prototype.effect=function(t,e){var n=this,i=e.bindingType,r=this.cleanEventPath(t.path),o=this.effectorFactory.getEffector(e);if(o){var a=this.analysis(t,e);if(a){var s=e.path.split("/").filter((function(t){return t}));if(i===Tn.ExpressionBindingType.Field){var u=[],p=s.slice(a.expressionTablePaths.length);if(0===a.distance){if(!a.isSameTable)return;var c=r.slice(0);if(1===r.length)if(t.value&&Array.isArray(t.value))t.value.forEach((function(t){u.push([t.primaryKeyValue].concat(p))}));else{var l=c.concat(p);u.push(l)}else if(t.value&&Array.isArray(t.value))t.value.forEach((function(t){u.push(c.concat([t.primaryKeyValue]).concat(p))}));else{var h=this.bindingData.getValue(a.eventTablePaths);h&&h.currentId&&u.push(c.concat(h.currentId).concat(p))}}else{if(!0===a.eventFromParent)return void console.warn("[BindingDataAppendObjectEventHandler][effect_error]");if(!0!==a.eventFromChildren)return void console.warn("[BindingDataAppendObjectEventHandler][effect_error]");l=r.slice(0,r.length-1).concat(p);u.push(l)}u.forEach((function(i){var r=n.buildCurrentRows(a.expressionTablePaths,i);n.output(t,e,r,o,[i])}))}else i===Tn.ExpressionBindingType.State&&console.error("not supported！")}else console.warn("[BindingDataAppendObjectEventHandler][analysis]获取路径信息失败。")}},e.prototype.output=function(t,e,n,i,r){var o=this.buildContext(e,t,null,n),a=this.perform(e,o);void 0!==a&&(e.result=a,e.id&&this.expressionResult.set(e.id,e.result),Gn.effect(i,D({eventType:t.type},e),r))},e}(zn)),ni=t("BindingDataValueChangeEventHandler",function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return j(e,t),e.prototype.filter=function(t){var e=this;return this.expressionObjects&&this.expressionObjects.length>0?this.expressionObjects.filter((function(n){var i=n.deps;if(!i||i.length<1||t.ns!==n.ns)return!1;var r=e.getEntityPath(t.path);return r.splice(0,0,yn),i.includes(r.join("/"))})):null},e.prototype.dispatch=function(t){var e=this,n=this.filter(t);n&&n.length>0&&n.forEach((function(n){e.effect(t,n)}))},e.prototype.effect=function(t,e){var n,i,r=this.effectorFactory.getEffector(e);if(r){var o=this.analysis(t,e);if(o){var a=this.cleanEventPath(t.path),s=[];if(0===o.distance){if(!1===o.isSameTable)return void console.warn("[BindingDataValueChangeEventHandler]不支持多对多关系。");var u=(c=a.slice(0,a.length-o.eventPropertyNames.length)).concat(o.expressionPropertyNames),p=this.buildCurrentRows(o.eventTablePaths,u);s.push(u),this.output(t,e,p,r,s)}else if(!0===o.eventFromChildren){if(o.distance>1)return;u=(c=a.slice(0,a.length-o.eventPropertyNames.length-2)).concat(o.expressionPropertyNames);s.push(u);p=this.buildCurrentRows(o.eventTablePaths,a);this.output(t,e,p,r,s)}else if(!0===o.eventFromParent){if(o.distance>1)return void console.warn("[BindingDataValueChangeEventHandler]不支持多对多关系。");var c;(c=a.slice(0,a.length-o.eventPropertyNames.length)).push(o.expressionTablePaths.slice(0).pop()),o.expressionTablePaths;var l=a[0];if(!l)return;for(var h=this.frameContext.repository.entityCollection.getEntityById(l),f=1;f<c.length;f++){var d=c[f];h=h instanceof me?h.get(d):h[d]}var y=h;if(y&&y instanceof me&&y.count()>0)try{for(var g=R(y),v=g.next();!v.done;v=g.next()){var m=v.value;if(m&&m.primaryValue){u=c.concat([m.primaryValue]).concat(o.expressionPropertyNames),p=this.buildCurrentRows(o.expressionTablePaths,u);this.output(t,e,p,r,[u])}}}catch(t){n={error:t}}finally{try{v&&!v.done&&(i=g.return)&&i.call(g)}finally{if(n)throw n.error}}}}}},e.prototype.output=function(t,e,n,i,r){var o=this.buildContext(e,t,null,n),a=this.perform(e,o);void 0!==a&&(e.result=a,e.id&&this.expressionResult.set(e.id,e.result),Gn.effect(i,e,r))},e.prototype.getCurrentRowByEvent=function(t,e){e=JSON.parse(JSON.stringify(e));var n=null,i=this.bindingData.getValue(t),r=this.getEntityPath(e.path);if(i&&i.length>0){var o=i.currentItem.primaryKeyValue||null,a=wn.getAvailableChildrenPathsFromEntityPaths(r,this.repository.entityTypeInfo);if(a&&a.toString()===t.toString()&&((o=e.id||null)||(o=this.getEventId(e.path,t[t.length-1]))),o){var s=i.findById(o);s&&(n=s.toJSON())}}return n},e}(zn)),ii=t("BindingDataRemoveObjectEventHandler",function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return j(e,t),e.prototype.filter=function(t){var e=this;if(this.expressionObjects&&this.expressionObjects.length>0)return this.expressionObjects.filter((function(n){if(n.ns!==t.ns||!n.deps||n.deps.length<1)return!1;var i=e.analysis(t,n);if(!i)return!1;var r=e.buildEntityPath(t.path);return(0!==r.length||n.bindingType!==Tn.ExpressionBindingType.Field)&&(r.splice(0,0,yn),i.eventTablePaths.length-1===i.expressionTablePaths.length&&(!!i.eventTablePaths.join(Tn.DEPENDENCY_SPLITER).startsWith(i.expressionTablePaths.join(Tn.DEPENDENCY_SPLITER))&&-1!==n.deps.findIndex((function(t){if(!t.startsWith(r.join(Tn.DEPENDENCY_SPLITER)))return!1;var n=t.split(Tn.DEPENDENCY_SPLITER).filter((function(t){return t})).slice(1),o=e.getPathInfo(n.join(Tn.DEPENDENCY_SPLITER));return!(!o||o.paths.join(Tn.DEPENDENCY_SPLITER)!==i.eventTablePaths.join(Tn.DEPENDENCY_SPLITER))}))))}))},e.prototype.dispatch=function(t){var e=this,n=this.filter(t);n&&n.length>0&&n.forEach((function(n){var i=e.buildEntityContext(t,n),r=e.buildContext(n,t,i),o=e.perform(n,r);(void 0!==o||e.isValidateOrRequiredExpression(n))&&(n.result=o,n.id&&e.expressionResult.set(n.id,n.result),e.effect(t,n))}))},e.prototype.effect=function(t,e){var n=e.bindingType,i=this.cleanEventPath(t.path),r=this.effectorFactory.getEffector(e);if(r){var o=this.analysis(t,e);if(o){var a=e.path.split("/").filter((function(t){return t}));if(n===Tn.ExpressionBindingType.Field){var s=[],u=a.slice(o.expressionTablePaths.length);if(0!==o.distance){if(!0===o.eventFromParent)return void console.warn("[BindingDataRemoveObjectEventHandler][effect_error]");if(!0!==o.eventFromChildren)return void console.warn("[BindingDataRemoveObjectEventHandler][effect_error]");var p=i.slice(0,i.length-1).concat(u);s.push(p)}Gn.effect(r,e,s)}else n===Tn.ExpressionBindingType.State&&console.error("not supported！")}else console.warn("[BindingDataRemoveObjectEventHandler][analysis]获取路径信息失败。")}},e.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},e}(zn)),ri=t("BindingDataLoadEventHandler",function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return j(e,t),e.prototype.filter=function(t){var e=this;return(t.path&&0!==t.path.length||!t.value||!Array.isArray(t.value)||0!==t.value.length)&&this.expressionObjects&&this.expressionObjects.length>0?this.expressionObjects.filter((function(n){if(n.ns!==t.ns||n.type!==Tn.ExpressionType.Readonly&&n.type!==Tn.ExpressionType.Visible&&n.type!==Tn.ExpressionType.Required&&n.type!==Tn.ExpressionType.Validate)return!1;var i=e.analysis(t,n);return!!i&&(0===i.distance&&i.isSameTable)})):null},e.prototype.dispatch=function(t){var e=this,n=this.filter(t);n&&n.length>0&&n.forEach((function(n){var i=e.buildEntityContext(t,n),r=e.buildContext(n,t,i),o=e.perform(n,r);(void 0!==o||e.isValidateOrRequiredExpression(n))&&(n.result=o,n.id&&e.expressionResult.set(n.id,n.result),e.effect(t,n))}))},e.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},e}(zn)),oi=t("BindingDataSelectionChangedEventHandler",function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return j(e,t),e.prototype.filter=function(t){var e=this;return this.expressionObjects&&this.expressionObjects.length>0?this.expressionObjects.filter((function(n){var i=n.deps;if(!i||i.length<1)return!1;var r=i.findIndex((function(t){return t.startsWith(yn)}));if(-1===r)return!1;var o=e.analysis(t,n);return!!o&&(1===o.eventTablePaths.length&&(2===o.expressionTablePaths.length&&(!!o.expressionTablePaths.join("/").startsWith(o.eventTablePaths.join("/"))&&-1!==(r=i.findIndex((function(t){return t.startsWith(yn+"/"+o.eventTablePaths[0])}))))))})):null},e.prototype.dispatch=function(t){var e=this,n=this.filter(t);n&&n.length>0&&n.forEach((function(n){var i=e.buildEntityContext(t,n),r=e.buildContext(n,t,i),o=e.perform(n,r);(void 0!==o||e.isValidateOrRequiredExpression(n))&&(n.result=o,n.id&&e.expressionResult.set(n.id,n.result),e.effect(t,n))}))},e}(zn)),ai=(t("ASSIGNER_TOKEN",new tt("@Farris expression assigner")),t("EVENT_HANDLER_TOKEN",new tt("@Farris_event_handler"))),si=t("EventHandlerRegistry",function(){function t(t){this.viewModelContext=t,this.handlers=this.viewModelContext.injector.get(ai)}return Object.defineProperty(t.prototype,"entityValueChangedEventHandler",{get:function(){return this.handlers&&this.handlers.find((function(t){return t instanceof Wn}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stateValueChangedEventHandler",{get:function(){return this.handlers&&this.handlers.find((function(t){return t instanceof $n}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"repositoryAddEntityEventHandler",{get:function(){return this.handlers&&this.handlers.find((function(t){return t instanceof Xn}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"repositoryRemoveEntityEventHandler",{get:function(){return this.handlers&&this.handlers.find((function(t){return t instanceof Zn}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"entityUpdateEventHandler",{get:function(){return this.handlers&&this.handlers.find((function(t){return t instanceof ti}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"repositoryLoadEventHandler",{get:function(){return this.handlers&&this.handlers.find((function(t){return t instanceof Qn}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bindingDataAppendEntityEventHandler",{get:function(){return this.handlers&&this.handlers.find((function(t){return t instanceof ei}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bindingDataValueChangeEventHandler",{get:function(){return this.handlers&&this.handlers.find((function(t){return t instanceof ni}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bindingDataRemoveObjectEventHandler",{get:function(){return this.handlers&&this.handlers.find((function(t){return t instanceof ii}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bindingDataLoadEventHandler",{get:function(){return this.handlers&&this.handlers.find((function(t){return t instanceof ri}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bindingDataSelectionChangedHandler",{get:function(){return this.handlers&&this.handlers.find((function(t){return t instanceof oi}))},enumerable:!0,configurable:!0}),t}()),ui=t("ExpressionEngineImpl",function(){function t(t){var e=this;this.viewModelContext=t,this.expressionObjects=new Array,this.injector=this.viewModelContext.injector,this.expressionRegistry=this.injector.get(Yn),this.expressionEventEmitter=this.injector.get(Kn),this.resolverRegistry=this.injector.get(mn),this.eventHandlerRegistry=this.injector.get(si),this.resolveService=this.injector.get(Pn),this.expressionRegistry.expressions.subscribe((function(t){t&&t.length>0&&(e.expressionObjects=t,e.resolveDependency()),e.attachEvent()}))}return t.prototype.attachEvent=function(){var t=this;this.expressionEventEmitter.attach().subscribe((function(e){!e||e.length<1||!t.expressionObjects||t.expressionObjects.length<1||e.forEach((function(e){var n=t.getEventHandler(e);n?n.handleEvent(e,t.expressionObjects):Mn.warn("没有对应的事件处理器,event="+e.type)}))}))},t.prototype.resolveDependency=function(){var t=this;!this.resolverRegistry||!this.resolverRegistry.resolvers||this.resolverRegistry.resolvers.length<1||!this.expressionObjects||this.expressionObjects.length<1||!Array.isArray(this.expressionObjects)||this.expressionObjects.forEach((function(e){var n=e.expression,i=t.resolveService.resolve(n);e.deps=i}))},t.prototype.getEventHandler=function(t){if(t.type===Tn.EventType.ValueChanged){if(t.source===Tn.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataValueChangeEventHandler;if(t.source===Tn.EventSource.Field)return this.eventHandlerRegistry.entityValueChangedEventHandler;if(t.source===Tn.EventSource.State)return this.eventHandlerRegistry.stateValueChangedEventHandler}else if(t.type===Tn.EventType.Append){if(t.source===Tn.EventSource.Repository||t.source===Tn.EventSource.Field)return this.eventHandlerRegistry.repositoryAddEntityEventHandler;if(t.source===Tn.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataAppendEntityEventHandler}else if(t.type===Tn.EventType.Remove){if(t.source===Tn.EventSource.Repository||t.source===Tn.EventSource.Field)return this.eventHandlerRegistry.repositoryRemoveEntityEventHandler;if(t.source===Tn.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataRemoveObjectEventHandler}else if(t.type===Tn.EventType.Update){if(t.source===Tn.EventSource.Repository)return this.eventHandlerRegistry.entityUpdateEventHandler}else if(t.type===Tn.EventType.Load){if(t.source===Tn.EventSource.Repository||t.source===Tn.EventSource.Field)return this.eventHandlerRegistry.repositoryLoadEventHandler;if(t.source===Tn.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataLoadEventHandler}else if(t.type===Tn.EventType.SelectionChanged&&t.source===Tn.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataSelectionChangedHandler;return null},t}()),pi=t("ExpressionResult",function(){function t(t){this.viewModelContext=t}return t.prototype.set=function(t,e){this[t]=e},t}()),ci=t("ExpressionManager",function(){function t(t){this.frameContext=t,this.injector=this.frameContext.injector,this.resolveService=this.injector.get(Pn),this.expressionExecutor=this.injector.get(Jn),this.expressionRegistry=this.injector.get(Yn),this.expressionResult=this.injector.get(pi),this.messageService=this.injector.get(In,null),this.notifyService=this.injector.get(Sn,null)}return t.prototype.eval=function(t,e,n){var i=this.expressionRegistry.getExpressionById(t);if(i){var r={},o=e&&e.bindingPath||null;if(o&&n){var a=o.split("/").filter((function(t){return t})),s=this.frameContext.bindingData.getValue(a),u="id";s&&(u=s.primaryKey);var p=n[u];p&&(r.currentRows=[{bindingPath:a.join("/"),primaryValue:p}])}var c=this.execute(i.expression,r);return this.expressionResult.set(t,c),c}},t.prototype.validate=function(t,e){var n=this.expressionRegistry.getExpressionById(t);if(n){var i=e&&e.patch||null,r={};i&&(r.patch=i);var o=e.currentRow||null;o&&(r.currentRows=r.currentRows||[],r.currentRows.push(o));var a=this.execute(n.expression,r);return this.expressionResult.set(t,a),a}console.warn("ExpressionManager 执行失败，未获取到表达式!")},t.prototype.onDataPicking=function(t){var n=t&&t.expressionId||null;if(!n)return console.warn("ExpressionManager 相关表达式设置错误，没有表达式编号。"),e(!0);var i=this.eval(n);if(!i){var r=this.expressionRegistry.getExpressionById(n);if(!r)return console.warn("ExpressionManager 无法找到对应的表达式"+n),e(!0);var o=r.messageType||Tn.MessageType.warning,a=r.message;return a&&this.notifyService[o](a,{hideTitle:!0}),s}return e(i)},t.prototype.execute=function(t,e){var n,i=this.resolveService.resolve(t),r=wn.getGroupFunctionDependency(t,this.frameContext.repository.entityTypeInfo),o=this.buildEntityContext(i,r,e),a=this.buildStateContext(),s=e&&e.contexts||null,u=D(((n={})[this.entityOriginalNodeCode]=o,n),a,{frameContext:this.frameContext,bindingData:this.frameContext.bindingData,repository:this.frameContext.repository},s);if(o)return this.expressionExecutor.eval(t,u)},t.prototype.executeAsync=function(t,n){var i=this.execute(t,n);return e(i)},t.prototype.buildEntityContext=function(t,e,n){var i=this,r=n&&n.currentRows||null,o=-1!==t.findIndex((function(t){return!!i.isEntityDependency(t)&&(!!(-1!==e.findIndex((function(e){return e===t})))&&1===t.split("/").filter((function(t){return t})).length-1)})),a={};r&&r.length>0&&r.forEach((function(t){a[t.bindingPath||"/"]=t.primaryValue}));var s=this.getEntity(a),u=n&&n.patch||null;if(!s)return null;if(u&&Object.keys(u).length>0&&Object.keys(u).forEach((function(t){var e=t.split("/").filter((function(t){return t})),n=u[t];i.setValue(s,e,n)})),o){var p=this.frameContext.repository.entityCollection.toJSON();s.__type__="List",s.__items__=p}return s},t.prototype.setValue=function(t,e,n){if(1===e.length)t[e[0]]=n;else{var i=e.pop();e.reduce((function(t,e){return t&&t[e]}),t)[i]=n}},t.prototype.isEntityDependency=function(t){return t.startsWith(yn)},t.prototype.getEntity=function(t){var e=this,n=this.frameContext.repository.entityTypeInfo,i=this.frameContext.bindingData,r=[],o=null;return t["/"]?(o=this.frameContext.bindingData.list.findById(t["/"]))&&(o=o.toJSON()):o=this.frameContext.bindingData.list.currentItem.toJSON(),o?(wn.getChildrenEntityPaths(n,r),o.__type__="Entity",!r||r.length<1||r.forEach((function(n){var r=null;if(t&&t[n.join("/")]){var a=i.getValue(n),s=t[n.join("/")],u=null;(u=s!==a.currentId?a.findById(s):a.currentItem)&&u.primaryKeyValue&&(r=u.toJSON())}else{if(t&&!!Object.keys(t).find((function(t){var e=t.split("/").join("/");return n.join("/").startsWith(e)}))||!1){var p=t&&t["/"]||i.list.currentId,c=e.frameContext.repository.entityCollection.getEntityById(p),l=[],h=n.reduce((function(e,n){l.push(n);var i=e&&e[n];if(i){var r=t&&t[l.join("/")]||i.items[0]&&i.items[0].primaryValue||null;if(r)return i.get(r)||null}return null}),c);r=h?h.toJSON():{}}else r=wn.getCurrentRowByPaths(n,i)}var f=n.pop(),d=n.reduce((function(t,e){return t&&t[e]||null}),o),y=d[f],g=D({__items__:[]},r&&r||{},{__type__:"List"});g.length=function(){return g.__items__.length},y&&Array.isArray(y)&&(g.__items__=[].concat(y)),d[f]=g})),o):null},Object.defineProperty(t.prototype,"entityOriginalNodeCode",{get:function(){var t=this.injector.get(Ie);return t&&t.entityTypeInfo&&t.entityTypeInfo.entityInfo&&t.entityTypeInfo.entityInfo.originalCode||null},enumerable:!0,configurable:!0}),t.prototype.buildStateContext=function(){var t={};if(this.frameContext){var e=this.frameContext.getVirtualRootFrameContext();if(e){var n=e.viewModel.uiState;(Object.getOwnPropertyNames(n)||[]).forEach((function(e){null!==e.match(/^[a-zA-Z0-9_\$]+$/g)&&(t[e]=n[e])}))}}return t},t}()),li=t("ExpressionResultFactory",function(){function t(t){this.viewModelContext=t,this.injector=this.viewModelContext.injector,this.expressionRegistry=this.injector.get(Yn),this.expressionManager=this.injector.get(ci),this.expressionResult=this.injector.get(pi),this.registeEvent()}return t.prototype.registeEvent=function(){var t=this;this.expressionRegistry.expressions.subscribe((function(e){e.forEach((function(e){if(!(e.deps&&e.deps.length>0)){var n=t.expressionManager.eval(e.id);t.expressionResult[e.id]=n}}))}))},t}()),hi=function(){function t(){}return t.getFormValueByPath=function(t,e){if(!e)return null;if(!t)return null;if(!e.bindingData)return null;if("/"===e.bindingData.bindingPath)return e.form.getFormValueByBindPath(t);if(e.bindingData.bindingPath&&e.bindingData.bindingPath.length>1&&0==t.indexOf(e.bindingData.bindingPath))return t=t.replace(e.bindingData.bindingPath+"/",""),e.form.getFormValueByBindPath(t);return null},t}(),fi=t("ReadonlyEffector",function(){function t(t){this.viewModelContext=t,this.ns=this.viewModelContext.injector.get(On,"")}return t.prototype.effect=function(t,e,n){var i;if(n.viewModelId&&(i=this.viewModelContext.appContext.viewModelContextManager.getContextById(n.viewModelId))&&i.form){var r=hi.getFormValueByPath(t,i).form_name;r&&(r.readonly=!0===e,i.form.changes.next({type:"validateFieldsFinished"}))}},t}()),di=t("ValidateEffector",function(){function t(t){this.viewModelContext=t,this.ns=this.viewModelContext.injector.get(On,"")}return t.prototype.effect=function(t,e,n){var i;if(n.viewModelId&&(i=this.viewModelContext.appContext.viewModelContextManager.getContextById(n.viewModelId))&&i.form){var r=hi.getFormValueByPath(t,i),o=r.form_name;if(o){!1===e&&n.eventType!==Tn.EventType.Append&&n.eventType!==Tn.EventType.Load?o.validationResult={passing:!e,message:n.message}:!0===e&&(o.validationResult={passing:!0,message:""});var a=[{type:"expression",constraints:[n.expressionId],message:n.message}];i.form.addValidate(r.bindingPath,r.name),o.pushValidatorFnforValidate(a,!0)}}},t}()),yi=t("RequiredEffector",function(){function t(t){this.viewModelContext=t,this.ns=this.viewModelContext.injector.get(On,"")}return t.prototype.effect=function(t,e,n){var i;if(n.viewModelId&&(i=this.viewModelContext.appContext.viewModelContextManager.getContextById(n.viewModelId))&&i.form){var r=hi.getFormValueByPath(t,i),o=r.form_name;if(o){var a=[{type:"required",constraints:[!0],message:n.message||"必填"}];!0===e?(i.form.addValidate(r.bindingPath,r.name),o.pushValidatorFnforRequired(a,!0),o.required=!0):!1===e&&(o.required=!1,o.getValidatorFn()&&o.getValidatorFn().length>=1&&(o.resetValidatorFnforRequired(),o.validationResult&&"required"===o.validationResult.type&&(o.validationResult={passing:!0,message:""}))),i.form.changes.next({type:"validateFieldsFinished"})}}},t}()),gi=t("VisibleEffector",function(){function t(t){this.viewModelContext=t,this.ns=this.viewModelContext.injector.get(On,"")}return t.prototype.effect=function(t,e,n){var i;if(n.viewModelId&&(i=this.viewModelContext.appContext.viewModelContextManager.getContextById(n.viewModelId))&&i.form){var r=hi.getFormValueByPath(t,i).form_name;r&&(r.visible=!0===e,i.form.changes.next({type:"validateFieldsFinished"}))}},t}()),vi=t("DependencyEffector",function(){function t(t){this.viewModelContext=t,this.ns=this.viewModelContext.injector.get(On,"")}return t.prototype.effect=function(t,e,n){var i;if(n.viewModelId&&(i=this.viewModelContext.appContext.viewModelContextManager.getContextById(n.viewModelId)).form){var r=hi.getFormValueByPath(t,i).form_name;r&&!0===e&&(r.value=null,r.validationResult={passing:e,message:""})}},t}()),mi=t("EffectorFactory",function(){function t(t){this.viewModelContext=t,this.injector=this.viewModelContext.injector,this.effectorRegistry=this.injector.get(Rn)}return t.prototype.getEffector=function(t){t.path;var e=t.ns,n=t.bindingType,i=t.type,r=this.effectorRegistry.effectors.filter((function(t){return t.ns==e}));if(i===Tn.ExpressionType.Compute){if(n===Tn.ExpressionBindingType.Field)return r.find((function(t){return t instanceof Dn}));if(n===Tn.ExpressionBindingType.State)return r.find((function(t){return t instanceof Nn}));throw new Error("不支持的绑定字段类型："+n)}return i===Tn.ExpressionType.Readonly?r.find((function(t){return t instanceof fi})):i===Tn.ExpressionType.Dependency?r.find((function(t){return t instanceof vi})):i!==Tn.ExpressionType.Relative?i===Tn.ExpressionType.Validate?r.find((function(t){return t instanceof di})):i===Tn.ExpressionType.Required?r.find((function(t){return t instanceof yi})):i===Tn.ExpressionType.Visible?r.find((function(t){return t instanceof gi})):null:void 0},t}()),Ei=t("VIEW_MODEL_EXPRESSION_PROVIDERS",_([{provide:mn,useClass:mn,deps:[Fe]},{provide:Pn,useClass:Pn,deps:[Fe]},{provide:Fn,useClass:Fn,deps:[Fe]},{provide:Hn,useClass:Hn,deps:[Fe]},{provide:si,useClass:si,deps:[Fe]},{provide:Rn,useClass:Rn,deps:[Fe]},{provide:mi,useClass:mi,deps:[Fe]},{provide:Yn,useClass:Yn,deps:[Fe]},{provide:Kn,useClass:Kn,deps:[Fe]},{provide:Jn,useClass:Jn,deps:[Fe]},{provide:ci,useClass:ci,deps:[Fe]},{provide:pi,useClass:pi,deps:[Fe]},{provide:li,useClass:li,deps:[Fe]},{provide:ui,useClass:ui,deps:[Fe]}],[{provide:dn,useClass:En,multi:!0,deps:[Fe]},{provide:dn,useClass:Cn,multi:!0,deps:[Fe]},{provide:dn,useClass:xn,multi:!0,deps:[Fe]}],[{provide:Vn,useClass:An,multi:!0,deps:[Fe]},{provide:Vn,useClass:Bn,multi:!0,deps:[Fe]},{provide:Vn,useClass:kn,multi:!0,deps:[Fe]}],[{provide:ai,useClass:Xn,multi:!0,deps:[Fe]},{provide:ai,useClass:Zn,multi:!0,deps:[Fe]},{provide:ai,useClass:Wn,multi:!0,deps:[Fe]},{provide:ai,useClass:$n,multi:!0,deps:[Fe]},{provide:ai,useClass:Qn,multi:!0,deps:[Fe]},{provide:ai,useClass:ti,multi:!0,deps:[Fe]},{provide:ai,useClass:ei,multi:!0,deps:[Fe]},{provide:ai,useClass:ni,multi:!0,deps:[Fe]},{provide:ai,useClass:ii,multi:!0,deps:[Fe]},{provide:ai,useClass:ri,multi:!0,deps:[Fe]},{provide:ai,useClass:oi,multi:!0,deps:[Fe]}],[{provide:jn,useClass:Dn,multi:!0,deps:[Fe]},{provide:jn,useClass:Nn,multi:!0,deps:[Fe]},{provide:jn,useClass:fi,multi:!0,deps:[Fe]},{provide:jn,useClass:di,multi:!0,deps:[Fe]},{provide:jn,useClass:yi,multi:!0,deps:[Fe]},{provide:jn,useClass:gi,multi:!0,deps:[Fe]},{provide:jn,useClass:vi,multi:!0,deps:[Fe]}])),bi=t("ControlsProxy",function(){function t(){this.controlsProxyMap=new Map}return t.prototype.setControlProxy=function(t,e){this.controlsProxyMap.set(t,e)},t.prototype.getControlProxy=function(t){return this.controlsProxyMap.get(t)},t}()),Ci=t("ViewModel",function(){function t(t,e){this.extendCommands=new Map,this.injector=t,this.id=e}return t.prototype.init=function(){this.initRepository(),this.initContext(),this.initBindingData(),this.initUIState(),this.intiStateMachine(),this.initForm(),this.initCommandBus(),this.registerWithParent(),this.initListeners(),this.closeOldBeSession(),this.initExpression(),this.initControlsProxy(),this.config()},t.prototype.config=function(){this.uiState.config(this.context)},t.prototype.initControlsProxy=function(){this.controlsProxy=this.injector.get(bi)},t.prototype.initRepository=function(){this.repository=this.injector.get(Ie)},t.prototype.initContext=function(){this.context=this.injector.get(Fe),this.context.init(this)},t.prototype.initExpression=function(){var t=this.context.appContext.viewModelContextManager.getContexts().find((function(t){return!!t.expressionEngineImpl}));if(t)return this.expressionEngineImpl=t.expressionEngineImpl,this.expressionManager=t.expressionManager,void(this.expressionResult=t.expressionResult);this.expressionEngineImpl=this.injector.get(ui,null),this.expressionManager=this.injector.get(ci,null),this.injector.get(li,null),this.expressionResult=this.injector.get(pi,null)},t.prototype.initBindingData=function(){var t=this;this.bindingData=this.context.injector.get(Qt),this.entityValueChangingListeners=new Map,this.entityValueChangedListeners=new Map,this.bindingData&&this.bindingData.setValueChangeInvokerFactory((function(i){return function(r,o,a,u){var p,c="/"+i.join("/");if(p=!1===a?t.entityValueChangingListeners[c]:t.entityValueChangedListeners[c]){var l={paths:i,preValue:r,value:o,changed:a},f=p.split(";").filter((function(t){return t})),g=!0;return n(f).pipe(d((function(e){return g?t[e](l).pipe(h((function(t){g=t}))):s})),y((function(t){return t})))}return e(!0)}}));var i=this.repository.name,r=this.context.appContext.bindingDataManager.getBindingDataByName(i);this.bindingData.initByBindingList(r.list,this.context,r.dataTypeInfo)},t.prototype.initUIState=function(){this.uiState=this.injector.get(Ge)},t.prototype.intiStateMachine=function(){this.stateMachine=this.injector.get(rn,null),this.stateMachine&&this.stateMachine.init(this.context)},t.prototype.initForm=function(){this.form=this.injector.get(hn,null),this.form.init()},t.prototype.initCommandBus=function(){this.commandBus=this.injector.get(Hi),this.extendCommandMethods()},t.prototype.extendCommandMethods=function(){var t=this;this.ngCommands=Tt.getPropsMetadatasByName(this.constructor,fn),this.keybindingMap=new Map,Object.keys(this.ngCommands).forEach((function(e){var n=t.ngCommands[e];Object.defineProperty(t,e,{value:function(e){var i={name:n.name,params:n.params,paramDescriptions:n.paramDescriptions,eventParam:e||null};return t.commandBus.dispatch(i)}}),n.keyBinding&&t.keybindingMap.set(e,n.keyBinding)}))},t.prototype.registerExtendCommand=function(t,e){var n=this;Object.defineProperty(this,t,{value:function(t){return e(t,n.context)}}),this.extendCommands.set(t,e)},t.prototype.registerWithParent=function(){var t=this.context.parent;if(t&&t.viewModel&&t.viewModel.childViewModels){var e=t.viewModel,n=this.constructor.name;e[e.childViewModels[n]]=this}},t.prototype.closeOldBeSession=function(){var t=this.context.appContext.viewModelContextManager.getContexts();1===t.length&&t[0]===this.context&&this.context.repository.reset()},t.prototype.initListeners=function(){var t=this,e=function(t,e){return"/"+t.split("/").concat(e.split(".")).filter((function(t){return t.length>0})).join("/")};if(this.form){var n=this.form.getEntityValueChangingListeners();Object.keys(n).forEach((function(i){var r=e(t.bindingPath,i);t.entityValueChangingListeners[r]=n[i]}));var i=this.form.getEntityValueChangedListeners();Object.keys(i).forEach((function(n){var r=e(t.bindingPath,n);t.entityValueChangedListeners[r]=i[n]}))}},t}()),xi=(t("ViewModelOptions",(function(){})),t("ɵd",function(){function t(){this.eventBus=new u,this.subscriptionsMap=new Map}return t.prototype.triggerEvent=function(t){this.eventBus.next(t)},t.prototype.subscribe=function(t,e,n){if(!1===this.subscriptionsMap.has(t)){var i=this.eventBus.subscribe((function(t){return e(t)}),(function(t){return n(t)}));this.subscriptionsMap.set(t,i)}},t.prototype.unsubscribe=function(t){!0===this.subscriptionsMap.has(t)&&(this.subscriptionsMap.get(t).unsubscribe(),this.subscriptionsMap.delete(t))},t.prototype.unsubscribeAllListview=function(t){var e,n;if(void 0===t&&(t="-listview-extend"),0!=this.subscriptionsMap.size)try{for(var i=R(this.subscriptionsMap.keys()),r=i.next();!r.done;r=i.next()){var o=r.value;o.indexOf(t)>0&&(this.subscriptionsMap.get(o).unsubscribe(),this.subscriptionsMap.delete(o))}}catch(t){e={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}},t}())),Pi=[{provide:xi,useClass:xi,deps:[]},{provide:Ne,useClass:Ne,deps:[]},{provide:Re,useClass:Re,deps:[]},{provide:Ve,useClass:Ve,deps:[]},{provide:Be,useClass:Be,deps:[it,xi,Re,Ne,Ve]}],wi=[{provide:Je,useClass:Je,deps:[it]}],Mi=[{provide:We,useClass:We,deps:[Fe]},{provide:ze,useClass:ze,deps:[Fe]}],Ii=(t("App",function(){function t(t){t.providers=t.providers||[];var e=Ct(_(Pi,Ni,Nt,wi,t.providers));this.context=e.get(Be)}return t.prototype.createViewModel=function(t){var e=t.providers||[],n=t.parent||null,i=Ct(_([{provide:Fe,useClass:Fe,deps:[]},{provide:bi,useClass:bi,deps:[]}],Ki,Ei,Mi,e),n?n.injector:this.context.injector).get(Ci);return i.init(),i},t}()),function(){function t(){}return t.getAppContext=function(t){if(t instanceof _i)return t.viewModelContext.appContext;if(t instanceof Fe)return t.appContext;if(t instanceof Be)return t;throw new Error("上下文中找不到AppContext，请检查！")},t.getFrameContext=function(t){if(t instanceof _i)return t.viewModelContext;if(t instanceof Fe)return t;throw new Error("上下文中找不到FrameContext，请检查！")},t.getRootFrameContext=function(t){return this.getFrameContext(t).root},t.getFrameContextById=function(t,e){return this.getAppContext(t).viewModelContextManager.getContextById(e)},t}()),Si=t("DataVariableParser",function(){function t(){}return t.prototype.parse=function(t,e){var n=this,i=Ii.getAppContext(e),r=this.extractPaths(t);return 1===r.length&&t==="{DATA~"+r[0]+"}"?this.getValue(r[0],i):(r.forEach((function(e){var r="{DATA~"+e+"}",o=n.getValue(e,i);t=t.replace(r,o)})),t)},t.prototype.extractPaths=function(t){var e=[],n=t.match(/\{DATA~(\S+?)\}/g);if(null===n)return[];var i=/\{DATA~(\S+?)\}/;return n.forEach((function(t){var n=t.match(i);null!=n&&2===n.length&&e.push(n[1])})),e},t.prototype.getValue=function(t,e){var n=t.split("/").filter((function(t){return""!==t})),i=e.viewModelContextManager.getContextById(n[0]);if(!i)throw new Error(t+"不正确，请检查！");var r=i.bindingData;if(!r)throw new Error(t+"不正确，请检查！");return r.getValue(n.slice(1))},t}()),Oi=t("UIStateVariableParser",function(){function t(){}return t.prototype.parse=function(t,e){var n=this,i=Ii.getAppContext(e),r=this.extractPaths(t);return 1===r.length&&t==="{UISTATE~"+r[0]+"}"?this.getUIState(r[0],i):(r.forEach((function(e){var r="{UISTATE~"+e+"}",o=n.getUIState(e,i);t=t.replace(r,o)})),t)},t.prototype.extractPaths=function(t){var e=[],n=t.match(/\{UISTATE~(\S+?)\}/g);if(null===n)return[];var i=/\{UISTATE~(\S+?)\}/;return n.forEach((function(t){var n=t.match(i);null!=n&&2===n.length&&e.push(n[1])})),e},t.prototype.getUIState=function(t,e){var n=t.split("/").filter((function(t){return""!==t})),i=V(n,2),r=i[0],o=i[1],a=e.viewModelContextManager.getContextById(r).uiState[o];if(a&&a.constructor.toString().startsWith("function Date()"))return this.formatDate(a);for(var s=2;s<n.length;s++)if(!(a=a[n[s]]))return a;return a},t.prototype.formatDate=function(t){if(!t)return"";var e=t.getFullYear(),n=(t.getMonth()+1).toString();n=1===n.length?"0"+n:n;var i=t.getDate().toString();return e+"-"+n+"-"+(i=1===i.length?"0"+i:i)},t}()),Ti=t("StateMachineVariableParser",function(){function t(){}return t.prototype.parse=function(t,e){var n=this,i=this.extractPaths(t);return 1===i.length&&t==="{STATEMACHINE~"+i[0]+"}"?this.getValue(i[0],e):(i.forEach((function(i){var r="{STATEMACHINE~"+i+"}",o=n.getValue(i,e);t=t.replace(r,o)})),t)},t.prototype.extractPaths=function(t){var e=[],n=t.match(/\{STATEMACHINE~(\S+?)\}/g);if(null===n)return[];var i=/\{STATEMACHINE~(\S+?)\}/;return n.forEach((function(t){var n=t.match(i);null!=n&&2===n.length&&e.push(n[1])})),e},t.prototype.getValue=function(t,e){var n=this.getPathObj(t),i=this.getTargetStateMachine(n.frameId,e);if("currentState"===n.type)return i.context.state;if("renderStates"===n.type)return i[n.name];throw new Error("不支类型为"+n.type+"的状态机变量")},t.prototype.getTargetStateMachine=function(t,e){var n;if(!(n=t?Ii.getFrameContextById(e,t):Ii.getRootFrameContext(e))||!n.stateMachine)throw new Error("找不到对应的状态机实例，请检查！");return n.stateMachine},t.prototype.getPathObj=function(t){var e=this.splitPath(t);return"currentState"===e[0]||"renderStates"===e[0]?{frameId:"",type:e[0],name:e[1]}:{frameId:e[0],type:e[1],name:e[2]}},t.prototype.splitPath=function(t){return t.split("/").filter((function(t){return""!==t}))},t}()),ji=t("CommandVariableParser",function(){function t(){}return t.prototype.parse=function(t,e){var n=this,i=this.extractPaths(t);return 1===i.length&&t==="{COMMAND~"+i[0]+"}"?this.getValue(i[0],e):(i.forEach((function(i){var r="{COMMAND~"+i+"}",o=n.getValue(i,e);t=t.replace(r,o)})),t)},t.prototype.extractPaths=function(t){var e=[],n=t.match(/\{COMMAND~(\S+?)\}/g);if(null===n)return[];var i=/\{COMMAND~(\S+?)\}/;return n.forEach((function(t){var n=t.match(i);null!=n&&2===n.length&&e.push(n[1])})),e},t.prototype.getValue=function(t,e){if(e instanceof _i==!1)throw new Error("当前上下文不支持COMMAND变量，请检查！");var n=V(t.split("/").filter((function(t){return""!==t})),2),i=n[0],r=n[1];return"params"===i?e.command.params[r]:"results"===i?e.results[r]:void 0},t}()),Di=t("VariableParseService",function(){function t(t){this.parsers=t}return t.prototype.parse=function(t,e){var n=this;if("string"==typeof t&&t.length>0)return this.parseExpression(t,e);if(Array.isArray(t))t.forEach((function(i,r){t[r]="string"==typeof i?n.parseExpression(i,e):n.parse(i,e)}));else if("object"==typeof t&&null!==t){Object.keys(t).forEach((function(i){"string"==typeof t[i]?t[i]=n.parseExpression(t[i],e):t[i]=n.parse(t[i],e)}))}return t},t.prototype.evaluate=function(t,e){var n=this.parse(t,e);return new Function("return "+n)()},t.prototype.parseExpression=function(t,e){return""===t?"":(this.parsers.forEach((function(n){"string"==typeof t&&(t=n.parse(t,e))})),t)},t}()),Ni=t("APP_VARIABLE_PROVIDERS",[{provide:De,useClass:Si,multi:!0,deps:[]},{provide:De,useClass:Oi,multi:!0,deps:[]},{provide:De,useClass:Ti,multi:!0,deps:[]},{provide:De,useClass:ji,multi:!0,deps:[]},{provide:Di,useClass:Di,deps:[De]}]),Ri=t("TaskLink",function(){function t(t,e,n){this.from=t,this.to=e,this.condition=n}return t.prototype.canLink=function(t){var e;switch(typeof this.condition){case"boolean":e=this.condition;break;case"function":e=this.condition(t);break;case"string":e=t.viewModelContext.injector.get(Di).evaluate(this.condition,t);break;default:e=!1}return e},t}()),Vi=t("TaskFlow",function(){function t(){this.nodes=[],this.links=[]}return t.prototype.addNode=function(t,e){var n=new je(t,e);this.nodes.push(n)},t.prototype.addNodes=function(t){this.nodes=this.nodes.concat(t)},t.prototype.insertNode=function(t,e,n){var i=this.findNodeIndex(t),r=this.createNode(e,n);this.nodes.splice(i,0,r)},t.prototype.appendNode=function(t,e,n){var i=this.findNodeIndex(t)+1,r=this.createNode(e,n);this.nodes.splice(i,0,r)},t.prototype.findNodeIndex=function(t){return this.nodes.findIndex((function(e){return e.name===t}))},t.prototype.createNode=function(t,e){return new je(t,e)},t.prototype.addLink=function(t,e,n){var i=this.createLink(t,e,n);this.links.push(i)},t.prototype.addLinks=function(t){this.links=this.links.concat(t)},t.prototype.createLink=function(t,e,n){return new Ri(t,e,n)},t.prototype.getNext=function(t,e){if(!t)return this.nodes.shift();var n=this.links.find((function(n){return n.from===t&&n.canLink(e)}));return n?this.nodes.find((function(t){return t.name===n.to})):void 0},t.prototype.clone=function(){var e=new t;return e.addNodes(this.nodes),e.addLinks(this.links),e},t}()),_i=t("CommandContext",(function(t,e){this.results={},this.command=t,this.viewModelContext=e})),Ai=(t("CommandHandler",function(){function t(){}return t.prototype.init=function(t){this.viewModelContext=t,this.parseService=t.injector.get(Di),this.taskFlow=new Vi,this.schedule()},t.prototype.execute=function(t){var e=this,n=new u,i=this.taskFlow.clone();return setTimeout((function(){var r=D({},t).eventParam,o=void 0===r?null:r;delete t.eventParam;var s=JSON.parse(JSON.stringify(t));s.params=e.parseService.parse(s.params,e.viewModelContext),t.eventParam=o,s.eventParam=o;var u=new _i(s,e.viewModelContext);u.eventParams=t.eventParam||null;var p=new a(u),l=i.getNext("",u);p.pipe(d((function(t){return l.execute(t).pipe(g(1),c((function(e){return t.results[l.name]=e,t.latestResult=e,(l=i.getNext(l.name,t))?p.next(t):p.complete(),t})),v((function(){p.complete()})))}))).pipe(m(1)).subscribe({next:function(t){n.next(t.latestResult)},error:function(t){e.displayError(t),n.error(t)},complete:function(){n.complete()}})}),0),n},t.prototype.displayError=function(t){console&&console.error&&(t||(t="unknown error"),console.error(t))},t.prototype.addTask=function(t,e){this.taskFlow.addNode(t,e)},t.prototype.addLink=function(t,e,n){this.taskFlow.addLink(t,e,n)},t.prototype.insertTask=function(t,e,n){throw new Error("Not Implemented")},t.prototype.afterTask=function(t,e,n){throw new Error("Not Implemented")},t.prototype.replaceTask=function(t,e){throw new Error("Not Implement")},t.prototype.invoke=function(t,e,n,i){this.setContextToServiceInstance(t,i);var r=this.parseService.parse(n,i);return t[e].apply(t,_(r))},t.prototype.setContextToServiceInstance=function(t,e){var n=t.context;n&&n instanceof _i==!1||(t.context=e)},t}()),t("COMMAND_HANDLERS_TOKEN",et("@Farris/devkit COMMAND_HANDLERS_TOKEN"))),Bi=t("CommandHandlerRegistry",function(){function t(t){var e=this;this.injector=t;var n=this.injector.get(Ai,null,H.Optional);this.handlerMap=new Map,n&&n.forEach((function(t){e.regist(t)}))}return t.prototype.set=function(t,e){if(this.handlerMap.has(t))throw new Error(t+"对应的CommandHandler已经存在");this.handlerMap.set(t,e)},t.prototype.get=function(t){if(!1===this.handlerMap.has(t))throw new Error("找不到"+t+"对应的CommandHandler");return this.handlerMap.get(t)},t.prototype.regist=function(t){var e=Tt.getClassMetadataByName(t.constructor,Se);if(!e)throw new Error("CommandHandler必须指定要处理的命令名称");var n=e.commandName;this.set(n,t)},t}()),Fi=(t("CommandHandlerExtender",(function(){})),t("COMMAND_HANDLER_EXTENDERS_TOKEN",et("@farris/devkit COMMAND_HANDLER_EXTENDERS_TOKEN"))),Li=t("CommandHandlerExtenderRegistry",function(){function t(t){var e=this;this.injector=t;var n=this.injector.get(Fi,null,H.Optional);this.extendersMap=new Map,n&&n.forEach((function(t){e.regist(t)}))}return t.prototype.get=function(t){return!1===this.extendersMap.has(t)?[]:this.extendersMap.get(t)},t.prototype.set=function(t,e){this.extendersMap.has(t)?this.extendersMap.get(t).push(e):this.extendersMap.set(t,[e])},t.prototype.regist=function(t){var e=Tt.getClassMetadataByName(t.constructor,Oe);if(!e)throw new Error("CommandHandlerExtender必须指定要扩展的命令名称");var n=e.commandName;this.set(n,t)},t}()),ki=t("CommandHandlerFactory",function(){function t(t,e,n){this.handlerRegistry=t,this.extenderRegistry=e,this.viewModelContext=n}return t.prototype.create=function(t){var e=this.handlerRegistry.get(t);return e.init(this.viewModelContext),this.extenderRegistry.get(t).reduce((function(t,e){return e.extend(t)}),e)},t}()),Hi=t("CommandBus",function(){function t(t){this.handlerFactory=t,this.executingCommands=[],this.executingCommandCount$=new a(this.executingCommands.length)}return t.prototype.dispatch=function(t){var e=this,n=new u;return this.executeCommand(t).subscribe({next:function(t){n.next(t),n.complete()},complete:function(){n.complete(),e.removeCommandFromExecutingQueue(t)},error:function(i){n.error(i),e.removeCommandFromExecutingQueue(t)}}),n},t.prototype.executeCommand=function(t){this.addCommandToExecutingQueue(t);var e=t.name;return this.handlerFactory.create(e).execute(t)},t.prototype.addCommandToExecutingQueue=function(t){this.executingCommands.push(t),this.executingCommandCount$.next(this.executingCommands.length)},t.prototype.removeCommandFromExecutingQueue=function(t){this.executingCommands=this.executingCommands.filter((function(e){return e!==t})),this.executingCommandCount$.next(this.executingCommands.length)},t}()),Ki=t("VIEW_MODEL_COMMAND_PROVIDERS",[{provide:Bi,useClass:Bi,deps:[it]},{provide:Li,useClass:Li,deps:[it]},{provide:ki,useClass:ki,deps:[Bi,Li,Fe]},{provide:Hi,useClass:Hi,deps:[ki]}]);t("EXCEPTION_HANDLER","@farris/devkit ExceptionHandler")}}}));
