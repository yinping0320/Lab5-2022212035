import * as tslib_1 from "tslib";
import { ModifyType } from '../changeset/types';
import { PARENT_PATH, PARENT_CLASS } from './types';
import { Entity } from './entity';
/**
 * 支持动态字段集合的动态实体
 */
var DynamicEntity = /** @class */ (function (_super) {
    tslib_1.__extends(DynamicEntity, _super);
    /**
     * @param data JSON数据
     */
    function DynamicEntity(data) {
        var _this = _super.call(this, data) || this;
        _this.loadDynamicData(data);
        return _this;
    }
    Object.defineProperty(DynamicEntity.prototype, "IsNested", {
        /**
         * 是否是嵌套的动态实体
         */
        get: function () {
            return this[PARENT_CLASS] instanceof DynamicEntity;
        },
        enumerable: true,
        configurable: true
    });
    DynamicEntity.prototype.loadDynamicData = function (dynamicData) {
        this.initializeDynamicField(dynamicData);
        // super.loadFields(dynamicData);
    };
    /**
     * 初始化动态数据
     * @param dynamicData 动态数据
     */
    DynamicEntity.prototype.initializeDynamicField = function (dynamicData) {
        var _this = this;
        // 遍历动态数据的key，创建动态实体属性。
        Object.keys(dynamicData).forEach(function (propertyName) {
            // 如果属性已经存在，先删除
            if (_this[propertyName]) {
                delete _this[propertyName];
            }
            var dataField = propertyName;
            if (dynamicData[propertyName] instanceof Object) {
                var path_1 = _this.createPath(propertyName);
                var dynamicEntity_1 = _this.createDynamicEntityFromJsonData(dynamicData[propertyName], path_1);
                Object.defineProperty(_this, propertyName, {
                    get: function () {
                        return dynamicEntity_1;
                    },
                    set: function (value) {
                        var modifyInfo = {
                            path: dynamicEntity_1[PARENT_PATH],
                            value: value.data,
                            preValue: this[propertyName].data,
                            type: ModifyType.ValueChange
                        };
                        dynamicEntity_1 = this.createDynamicEntityFromJsonData(value, path_1);
                        this.setChanges(modifyInfo);
                    },
                    configurable: true
                });
            }
            else {
                Object.defineProperty(_this, propertyName, {
                    // 定义返回数据方法。
                    get: function () {
                        // 从初始数据返回字段值。
                        return this.data[dataField];
                    },
                    set: function (value) {
                        // 值相同时不触发变更。
                        var oldValue = this.data[dataField];
                        if (oldValue === value) {
                            return;
                        }
                        // 更新元数据数据。
                        this.data[dataField] = value;
                        // 变更集
                        var changes = {
                            type: ModifyType.ValueChange,
                            path: this.createPath(propertyName),
                            value: value,
                            preValue: oldValue
                        };
                        if (this[PARENT_PATH]) {
                            changes.path = this[PARENT_PATH].concat(changes.path);
                        }
                        this.setChanges(changes);
                    },
                    configurable: true
                });
            }
        });
    };
    DynamicEntity.prototype.createDynamicEntityFromJsonData = function (value, parentPath) {
        var _this = this;
        var instance;
        if (value instanceof DynamicEntity) {
            instance = value;
        }
        else {
            instance = new DynamicEntity(value);
        }
        instance[PARENT_CLASS] = this;
        instance[PARENT_PATH] = parentPath;
        instance.onValueChanged.subscribe(function (changes) {
            if (changes) {
                changes.path = (_this[PARENT_PATH] || []).concat(changes.path);
                _this.setChanges(changes);
            }
        });
        return instance;
    };
    /**
     * 将变更记录保存至变更集中
     * @param value 变更记录
     * @todo
     * 1、preValue的处理有问题，下级传递上来的变更这样可以，根DyanmicaEntity上的，data已经发生变化，prevalue和value是一样了；
     * 2、当value是下级冒泡上来的，需要根据value去更新当前层级的data，该逻辑不应该放在setChagnes，待修改。
     */
    DynamicEntity.prototype.setChanges = function (value) {
        var _a;
        var propertyName = value.path[value.path.length - 1];
        var preValue = Object.assign({}, this.data);
        this.newData = Object.assign(this.newData, (_a = {}, _a[propertyName] = value.value, _a));
        var parentPath = value.path;
        if (value.path.length > 2) {
            parentPath = value.path.slice(0, value.path.length - 2);
        }
        // 统一不使用构造函数（保持和其他位置对Modification的构造一致）
        // const parentModification = new Modification(this.data, value.type, parentPath, preValue);
        var parentModification = {
            path: parentPath,
            value: this.data,
            preValue: preValue,
            type: value.type
        };
        this.valueChanged.next(parentModification);
        this.changeSet.append(value);
    };
    /**
     * toJSON
     */
    DynamicEntity.prototype.toJSON = function () {
        return this.data;
    };
    return DynamicEntity;
}(Entity));
export { DynamicEntity };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pY19lbnRpdHkuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZW50aXR5L2R5bmFtaWNfZW50aXR5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFnQixNQUFNLG9CQUFvQixDQUFDO0FBQzlELE9BQU8sRUFBRSxXQUFXLEVBQVcsWUFBWSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQzdELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFbEM7O0dBRUc7QUFDSDtJQUFtQyx5Q0FBTTtJQVN2Qzs7T0FFRztJQUNILHVCQUFZLElBQVM7UUFBckIsWUFDRSxrQkFBTSxJQUFJLENBQUMsU0FFWjtRQURDLEtBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7O0lBQzdCLENBQUM7SUFWRCxzQkFBVyxtQ0FBUTtRQUhuQjs7V0FFRzthQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksYUFBYSxDQUFDO1FBQ3JELENBQUM7OztPQUFBO0lBVU0sdUNBQWUsR0FBdEIsVUFBdUIsV0FBZ0I7UUFDckMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3pDLGlDQUFpQztJQUNuQyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssOENBQXNCLEdBQTlCLFVBQStCLFdBQWdCO1FBQS9DLGlCQTZEQztRQTVEQyx1QkFBdUI7UUFDdkIsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQSxZQUFZO1lBRTNDLGVBQWU7WUFDZixJQUFJLEtBQUksQ0FBQyxZQUFZLENBQUMsRUFBRTtnQkFDdEIsT0FBTyxLQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDM0I7WUFFRCxJQUFNLFNBQVMsR0FBRyxZQUFZLENBQUM7WUFDL0IsSUFBSSxXQUFXLENBQUMsWUFBWSxDQUFDLFlB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Q0FBQyxLQUFLLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQ7O09BRUc7SUFDSSw4QkFBTSxHQUFiO1FBQ0UsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ25CLENBQUM7SUFDSCxvQkFBQztBQUFELENBQUMsQUEvSUQsQ0FBbUMsTUFBTSxHQStJeEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNb2RpZnlUeXBlLCBNb2RpZmljYXRpb24gfSBmcm9tICcuLi9jaGFuZ2VzZXQvdHlwZXMnO1xuaW1wb3J0IHsgUEFSRU5UX1BBVEgsIER5bmFtaWMsIFBBUkVOVF9DTEFTUyB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgRW50aXR5IH0gZnJvbSAnLi9lbnRpdHknO1xuXG4vKipcbiAqIOaUr+aMgeWKqOaAgeWtl+autembhuWQiOeahOWKqOaAgeWunuS9k1xuICovXG5leHBvcnQgY2xhc3MgRHluYW1pY0VudGl0eSBleHRlbmRzIEVudGl0eSBpbXBsZW1lbnRzIER5bmFtaWMge1xuXG4gIC8qKlxuICAgKiDmmK/lkKbmmK/ltYzlpZfnmoTliqjmgIHlrp7kvZNcbiAgICovXG4gIHB1YmxpYyBnZXQgSXNOZXN0ZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXNbUEFSRU5UX0NMQVNTXSBpbnN0YW5jZW9mIER5bmFtaWNFbnRpdHk7XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIGRhdGEgSlNPTuaVsOaNrlxuICAgKi9cbiAgY29uc3RydWN0b3IoZGF0YTogYW55KSB7XG4gICAgc3VwZXIoZGF0YSk7XG4gICAgdGhpcy5sb2FkRHluYW1pY0RhdGEoZGF0YSk7XG4gIH1cblxuICBwdWJsaWMgbG9hZER5bmFtaWNEYXRhKGR5bmFtaWNEYXRhOiBhbnkpIHtcbiAgICB0aGlzLmluaXRpYWxpemVEeW5hbWljRmllbGQoZHluYW1pY0RhdGEpO1xuICAgIC8vIHN1cGVyLmxvYWRGaWVsZHMoZHluYW1pY0RhdGEpO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIneWni+WMluWKqOaAgeaVsOaNrlxuICAgKiBAcGFyYW0gZHluYW1pY0RhdGEg5Yqo5oCB5pWw5o2uXG4gICAqL1xuICBwcml2YXRlIGluaXRpYWxpemVEeW5hbWljRmllbGQoZHluYW1pY0RhdGE6IGFueSk6IHZvaWQge1xuICAgIC8vIOmBjeWOhuWKqOaAgeaVsOaNrueahGtlee+8jOWIm+W7uuWKqOaAgeWunuS9k+WxnuaAp+OAglxuICAgIE9iamVjdC5rZXlzKGR5bmFtaWNEYXRhKS5mb3JFYWNoKHByb3BlcnR5TmFtZSA9PiB7XG5cbiAgICAgIC8vIOWmguaenOWxnuaAp+W3sue7j+WtmOWcqO+8jOWFiOWIoOmZpFxuICAgICAgaWYgKHRoaXNbcHJvcGVydHlOYW1lXSkge1xuICAgICAgICBkZWxldGUgdGhpc1twcm9wZXJ0eU5hbWVdO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBkYXRhRmllbGQgPSBwcm9wZXJ0eU5hbWU7XG4gICAgICBpZiAoZHluYW1pY0RhdGFbcHJvcGVydHlOYW1lXSBpbnN0YW5jZW9mIE9iamVjdCkge1xuICAgICAgICBjb25zdCBwYXRoID0gdGhpcy5jcmVhdGVQYXRoKHByb3BlcnR5TmFtZSk7XG4gICAgICAgIGxldCBkeW5hbWljRW50aXR5ID0gdGhpcy5jcmVhdGVEeW5hbWljRW50aXR5RnJvbUpzb25EYXRhKGR5bmFtaWNEYXRhW3Byb3BlcnR5TmFtZV0sIHBhdGgpO1xuICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgcHJvcGVydHlOYW1lLCB7XG4gICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHJldHVybiBkeW5hbWljRW50aXR5O1xuICAgICAgICAgIH0sXG4gICAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgICAgICAgY29uc3QgbW9kaWZ5SW5mbyA9IHtcbiAgICAgICAgICAgICAgcGF0aDogZHluYW1pY0VudGl0eVtQQVJFTlRfUEFUSF0sXG4gICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZS5kYXRhLFxuICAgICAgICAgICAgICBwcmVWYWx1ZTogdGhpc1twcm9wZXJ0eU5hbWVdLmRhdGEsXG4gICAgICAgICAgICAgIHR5cGU6IE1vZGlmeVR5cGUuVmFsdWVDaGFuZ2VcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBkeW5hbWljRW50aXR5ID0gdGhpcy5jcmVhdGVEeW5hbWljRW50aXR5RnJvbUpzb25EYXRhKHZhbHVlLCBwYXRoKTtcbiAgICAgICAgICAgIHRoaXMuc2V0Q2hhbmdlcyhtb2RpZnlJbmZvKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBwcm9wZXJ0eU5hbWUsIHtcbiAgICAgICAgICAvLyDlrprkuYnov5Tlm57mlbDmja7mlrnms5XjgIJcbiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgLy8g5LuO5Yid5aeL5pWw5o2u6L+U5Zue5a2X5q615YC844CCXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRhW2RhdGFGaWVsZF07XG4gICAgICAgICAgfSxcbiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICAgICAgICAvLyDlgLznm7jlkIzml7bkuI3op6blj5Hlj5jmm7TjgIJcbiAgICAgICAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpcy5kYXRhW2RhdGFGaWVsZF07XG4gICAgICAgICAgICBpZiAob2xkVmFsdWUgPT09IHZhbHVlKSB7XG4gICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIOabtOaWsOWFg+aVsOaNruaVsOaNruOAglxuICAgICAgICAgICAgdGhpcy5kYXRhW2RhdGFGaWVsZF0gPSB2YWx1ZTtcbiAgICAgICAgICAgIC8vIOWPmOabtOmbhlxuICAgICAgICAgICAgY29uc3QgY2hhbmdlcyA9IHtcbiAgICAgICAgICAgICAgdHlwZTogTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZSxcbiAgICAgICAgICAgICAgcGF0aDogdGhpcy5jcmVhdGVQYXRoKHByb3BlcnR5TmFtZSksXG4gICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSxcbiAgICAgICAgICAgICAgcHJlVmFsdWU6IG9sZFZhbHVlXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAodGhpc1tQQVJFTlRfUEFUSF0pIHtcbiAgICAgICAgICAgICAgY2hhbmdlcy5wYXRoID0gdGhpc1tQQVJFTlRfUEFUSF0uY29uY2F0KGNoYW5nZXMucGF0aCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlcyk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUR5bmFtaWNFbnRpdHlGcm9tSnNvbkRhdGEodmFsdWU6IGFueSwgcGFyZW50UGF0aDogc3RyaW5nW10pIHtcbiAgICBsZXQgaW5zdGFuY2U6IER5bmFtaWNFbnRpdHk7XG4gICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRHluYW1pY0VudGl0eSkge1xuICAgICAgaW5zdGFuY2UgPSB2YWx1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgaW5zdGFuY2UgPSBuZXcgRHluYW1pY0VudGl0eSh2YWx1ZSk7XG4gICAgfVxuICAgIGluc3RhbmNlW1BBUkVOVF9DTEFTU10gPSB0aGlzO1xuICAgIGluc3RhbmNlW1BBUkVOVF9QQVRIXSA9IHBhcmVudFBhdGg7XG4gICAgaW5zdGFuY2Uub25WYWx1ZUNoYW5nZWQuc3Vic2NyaWJlKGNoYW5nZXMgPT4ge1xuICAgICAgaWYgKGNoYW5nZXMpIHtcbiAgICAgICAgY2hhbmdlcy5wYXRoID0gKHRoaXNbUEFSRU5UX1BBVEhdIHx8IFtdKS5jb25jYXQoY2hhbmdlcy5wYXRoKTtcbiAgICAgICAgdGhpcy5zZXRDaGFuZ2VzKGNoYW5nZXMpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGluc3RhbmNlO1xuICB9XG5cbiAgLyoqXG4gICAqIOWwhuWPmOabtOiusOW9leS/neWtmOiHs+WPmOabtOmbhuS4rVxuICAgKiBAcGFyYW0gdmFsdWUg5Y+Y5pu06K6w5b2VXG4gICAqIEB0b2RvXG4gICAqIDHjgIFwcmVWYWx1ZeeahOWkhOeQhuaciemXrumimO+8jOS4i+e6p+S8oOmAkuS4iuadpeeahOWPmOabtOi/meagt+WPr+S7pe+8jOaguUR5YW5taWNhRW50aXR55LiK55qE77yMZGF0YeW3sue7j+WPkeeUn+WPmOWMlu+8jHByZXZhbHVl5ZKMdmFsdWXmmK/kuIDmoLfkuobvvJtcbiAgICogMuOAgeW9k3ZhbHVl5piv5LiL57qn5YaS5rOh5LiK5p2l55qE77yM6ZyA6KaB5qC55o2udmFsdWXljrvmm7TmlrDlvZPliY3lsYLnuqfnmoRkYXRh77yM6K+l6YC76L6R5LiN5bqU6K+l5pS+5Zyoc2V0Q2hhZ25lc++8jOW+heS/ruaUueOAglxuICAgKi9cbiAgc2V0Q2hhbmdlcyh2YWx1ZTogTW9kaWZpY2F0aW9uKTogdm9pZCB7XG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gdmFsdWUucGF0aFt2YWx1ZS5wYXRoLmxlbmd0aCAtIDFdO1xuICAgIGNvbnN0IHByZVZhbHVlID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5kYXRhKTtcbiAgICB0aGlzLm5ld0RhdGEgPSBPYmplY3QuYXNzaWduKHRoaXMubmV3RGF0YSwgeyBbcHJvcGVydHlOYW1lXTogdmFsdWUudmFsdWUgfSk7XG4gICAgbGV0IHBhcmVudFBhdGggPSB2YWx1ZS5wYXRoO1xuICAgIGlmICh2YWx1ZS5wYXRoLmxlbmd0aCA+IDIpIHtcbiAgICAgIHBhcmVudFBhdGggPSB2YWx1ZS5wYXRoLnNsaWNlKDAsIHZhbHVlLnBhdGgubGVuZ3RoIC0gMik7XG4gICAgfVxuXG4gICAgLy8g57uf5LiA5LiN5L2/55So5p6E6YCg5Ye95pWw77yI5L+d5oyB5ZKM5YW25LuW5L2N572u5a+5TW9kaWZpY2F0aW9u55qE5p6E6YCg5LiA6Ie077yJXG4gICAgLy8gY29uc3QgcGFyZW50TW9kaWZpY2F0aW9uID0gbmV3IE1vZGlmaWNhdGlvbih0aGlzLmRhdGEsIHZhbHVlLnR5cGUsIHBhcmVudFBhdGgsIHByZVZhbHVlKTtcbiAgICBjb25zdCBwYXJlbnRNb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbiA9IHtcbiAgICAgIHBhdGg6IHBhcmVudFBhdGgsXG4gICAgICB2YWx1ZTogdGhpcy5kYXRhLFxuICAgICAgcHJlVmFsdWU6IHByZVZhbHVlLFxuICAgICAgdHlwZTogdmFsdWUudHlwZVxuICAgIH07XG5cbiAgICB0aGlzLnZhbHVlQ2hhbmdlZC5uZXh0KHBhcmVudE1vZGlmaWNhdGlvbik7XG4gICAgdGhpcy5jaGFuZ2VTZXQuYXBwZW5kKHZhbHVlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiB0b0pTT05cbiAgICovXG4gIHB1YmxpYyB0b0pTT04oKSB7XG4gICAgcmV0dXJuIHRoaXMuZGF0YTtcbiAgfVxufVxuIl19