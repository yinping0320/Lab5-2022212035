import * as tslib_1 from "tslib";
import { Subject } from 'rxjs';
import { ChangeSet } from '../changeset/change_set';
import { ModifyType } from '../changeset/types';
import { Entity } from './entity';
import { EntityFactory } from './entity_creator';
import { PARENT_CLASS, PARENT_PATH } from './types';
/**
 * 实体集合列表
 */
var EntityList = /** @class */ (function () {
    // #endregion
    /**
     * @param data JSON数据集合
     * @param type 集合中的实体类型
     */
    function EntityList(data, type) {
        var _this = this;
        this.__type__ = 'EntityList';
        // #region 私有属性
        this.originalData = [];
        /**
         * 已废弃：请勿使用
         */
        this.listChanged = new Subject();
        /**
         * 已废弃：请勿使用
         */
        this.changeSet = new ChangeSet();
        // #endregion
        // #region 公有属性
        /**
         * 集合改变时触发(新增、行记录修改、删除)
         * @event
         */
        this.onListChanged = this.listChanged.asObservable();
        this.clear();
        if (data) {
            // this.loadEntities(data);
            data.forEach(function (item) {
                _this.initEntity(EntityFactory(type, item));
            });
        }
    }
    Object.defineProperty(EntityList.prototype, "items", {
        /**
         * 获取项集合
         */
        get: function () {
            return this.rawData;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityList.prototype, "changes", {
        /**
         * 列表变更集
         */
        get: function () {
            return this.changeSet.changes;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 迭代器
     */
    EntityList.prototype[Symbol.iterator] = function () {
        return tslib_1.__generator(this, function (_a) {
            switch (_a.label) {
                case 0: return [5 /*yield**/, tslib_1.__values(this.items)];
                case 1:
                    _a.sent();
                    return [2 /*return*/];
            }
        });
    };
    // #region 公有方法
    /** 加载实体列表 */
    EntityList.prototype.loadEntities = function (entities) {
        var _this = this;
        this.clear();
        entities.forEach(function (entity) {
            _this.initEntity(entity);
        });
        // 发送Load变更
        var changeItem = {
            path: [],
            value: entities,
            preValue: undefined,
            type: ModifyType.Load,
            target: this
        };
        this.setChanges(changeItem);
    };
    /**
     * 清空
     */
    EntityList.prototype.clear = function () {
        this.rawData = [];
        this.originalData = [];
    };
    /**
     * 添加实体对象到集合中，并返回新加的对象
     * @param entity 实体对象
     * @param isCloned 克隆
     */
    EntityList.prototype.appendNew = function (entity, isCloned) {
        if (isCloned === void 0) { isCloned = false; }
        var newEntity = this.initEntity(entity, true);
        // 新增变更
        var changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Add
        };
        if (isCloned === true) {
            changeItem.type = ModifyType.Clone;
        }
        this.setChanges(changeItem);
        return newEntity;
    };
    /**
     * 在指定位置插入实体
     * @param entity 实体
     * @param position 插入位置
     */
    EntityList.prototype.insert = function (entity, position) {
        var newEntity = this.initEntity(entity, true);
        // 新增变更
        var changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Insert,
            position: position,
        };
        this.setChanges(changeItem);
        return newEntity;
    };
    /**
     * 追加实体
     */
    EntityList.prototype.appendEntity = function (entity) {
        var newEntity = this.initEntity(entity);
        // 新增变更
        var changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Add
        };
        this.setChanges(changeItem);
    };
    /**
     * 批量追加实体
     */
    EntityList.prototype.appendEntities = function (entities) {
        var _this = this;
        var newEntites = entities.map(function (entity) {
            return _this.initEntity(entity);
        });
        var changeItem = {
            path: [],
            value: newEntites,
            preValue: undefined,
            type: ModifyType.Add
        };
        this.setChanges(changeItem);
    };
    /**
     * 删除指定主键ID 的实体对象，返回布尔，true 删除成功，false 删除失败
     * @param primaryId 主键ID
     */
    EntityList.prototype.remove = function (primaryId) {
        var _a;
        var total = this.count();
        var indexToRemove = this.rawData.findIndex(function (entity) {
            return entity.primaryValue === primaryId;
        });
        if (indexToRemove === -1) {
            return false;
        }
        var entityToRemove = this.rawData[indexToRemove];
        this.rawData.splice(indexToRemove, 1);
        // 删除变更
        var changeItem = {
            path: [],
            value: (_a = {}, _a[entityToRemove.primaryProperty.dataField] = primaryId, _a),
            preValue: undefined,
            type: ModifyType.Remove
        };
        this.updateIndex(total);
        this.setChanges(changeItem);
        return true;
    };
    /**
     * 从集合中获取指定ID值的实体对象
     * @param id 主键值
     */
    EntityList.prototype.get = function (id) {
        return this.items.find(function (item) {
            return item.primaryValue === id;
        });
    };
    /**
     * 将变更记录添加到集合变更集中
     * @param value 变更记录
     */
    EntityList.prototype.setChanges = function (modinfo) {
        // 向app层发送的变更
        this.listChanged.next(modinfo);
        // 构造向changeSet中添加的chagne
        var change = Object.assign({}, modinfo);
        if ((modinfo.type === ModifyType.Add || modinfo.type === ModifyType.Insert || modinfo.type === ModifyType.Clone) && modinfo.value[0] instanceof Entity) {
            change.value = [modinfo.value[0].data];
        }
        this.changeSet.append(change);
    };
    /** 集合总记录数 */
    EntityList.prototype.count = function () {
        return this.items.length;
    };
    /**
     * 获取实体对象的索引值
     */
    EntityList.prototype.indexOf = function (entity) {
        return this.items.indexOf(entity);
    };
    /**
     * 计算集合中某个属性的总和
     * @param propertyName 属性名称
     */
    EntityList.prototype.sum = function (propertyName) {
        if (this.count() === 0) {
            return 0;
        }
        return this.items.reduce(function (val, curr) {
            return val + curr[propertyName];
        }, 0);
    };
    /**
     * 已废弃：请使用toJSON方法代替
     * @deprecated
     */
    EntityList.prototype.toJson = function () {
        return this.rawData;
    };
    /**
     * 转换为JSON格式
     */
    EntityList.prototype.toJSON = function () {
        var result = [];
        this.items.forEach(function (entity) {
            result.push(entity.toJSON());
        });
        return result;
    };
    EntityList.prototype.toArray = function () {
        return this.items;
    };
    // #endregion
    // #region 私有方法
    /**
     * 实体初始化
     * @param entity 实体
     */
    EntityList.prototype.initEntity = function (entity, isNewEntity) {
        var _this = this;
        if (isNewEntity === void 0) { isNewEntity = false; }
        entity[PARENT_CLASS] = this;
        entity[PARENT_PATH] = this[PARENT_PATH];
        entity.onValueChanged.subscribe(function (v) {
            var path = v.path;
            var value = v.value;
            var preValue = v.preValue;
            var operator = v.type;
            var subChanges = { path: path, value: value, preValue: preValue, type: operator };
            if (v.changeSetValue !== undefined) {
                subChanges['changeSetValue'] = v.changeSetValue;
            }
            _this.setChanges(subChanges);
        });
        // TODO: 添加数据验证逻辑代码
        var newLength = this.rawData.push(entity);
        this[newLength - 1] = entity;
        if (!isNewEntity) {
            this.originalData.push(entity.toJSON());
        }
        return entity;
    };
    /**
     * 更新索引
     * @param total 总记录数
     */
    EntityList.prototype.updateIndex = function (total) {
        var _this = this;
        for (var i = 0; i < total; i++) {
            delete this[i];
        }
        this.rawData.forEach(function (entity, index) {
            _this[index] = entity;
        });
    };
    /**
     * 获取属性名称
     */
    EntityList.prototype.getPropertyName = function () {
        var path = this[PARENT_PATH];
        if (path && path.length) {
            var name_1 = path[path.length - 1];
            return name_1;
        }
        return undefined;
    };
    return EntityList;
}());
export { EntityList };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X2xpc3QuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZW50aXR5L2VudGl0eV9saXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNwRCxPQUFPLEVBQWdCLFVBQVUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzlELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFhLE1BQU0sU0FBUyxDQUFDO0FBSy9EOztHQUVHO0FBQ0g7SUF3REUsYUFBYTtJQUdiOzs7T0FHRztJQUNILG9CQUFZLElBQVksRUFBRSxJQUFnQjtRQUExQyxpQkFRQztRQXRFTSxhQUFRLEdBQUcsWUFBWSxDQUFDO1FBRS9CLGVBQWU7UUFDUCxpQkFBWSxHQUFVLEVBQUUsQ0FBQztRQU1qQzs7V0FFRztRQUNLLGdCQUFXLEdBQUcsSUFBSSxPQUFPLEVBQWdCLENBQUM7UUFFbEQ7O1dBRUc7UUFDSyxjQUFTLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQztRQUNwQyxhQUFhO1FBR2IsZUFBZTtRQUVmOzs7V0FHRztRQUNJLGtCQUFhLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQW9DckQsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2IsSUFBSSxJQUFJLEVBQUU7WUFDUiwyQkFBMkI7WUFDM0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFBLElBQUk7Z0JBQ2YsS0FBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDN0Ms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LENBQUMsR0FBRyxLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDOUIsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDaEI7UUFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFDLE1BQU0sRUFBRSxLQUFLO1lBQ2pDLEtBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxNQUFNLENBQUM7UUFDdkIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxvQ0FBZSxHQUF2QjtRQUNFLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUMvQixJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ3ZCLElBQU0sTUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ25DLE9BQU8sTUFBSSxDQUFDO1NBQ2I7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBSUgsaUJBQUM7QUFBRCxDQUFDLEFBcFZELElBb1ZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQ2hhbmdlU2V0IH0gZnJvbSAnLi4vY2hhbmdlc2V0L2NoYW5nZV9zZXQnO1xuaW1wb3J0IHsgTW9kaWZpY2F0aW9uLCBNb2RpZnlUeXBlIH0gZnJvbSAnLi4vY2hhbmdlc2V0L3R5cGVzJztcbmltcG9ydCB7IEVudGl0eSB9IGZyb20gJy4vZW50aXR5JztcbmltcG9ydCB7IEVudGl0eUZhY3RvcnkgfSBmcm9tICcuL2VudGl0eV9jcmVhdG9yJztcbmltcG9ydCB7IFBBUkVOVF9DTEFTUywgUEFSRU5UX1BBVEgsIENsYXNzVHlwZSB9IGZyb20gJy4vdHlwZXMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIElMaXN0PFQ+IHtcbiAgW2luZGV4OiBudW1iZXJdOiBUO1xufVxuLyoqXG4gKiDlrp7kvZPpm4blkIjliJfooahcbiAqL1xuZXhwb3J0IGNsYXNzIEVudGl0eUxpc3Q8VCBleHRlbmRzIEVudGl0eT4gaW1wbGVtZW50cyBJTGlzdDxUPiwgSXRlcmFibGU8VD4ge1xuICBwdWJsaWMgX190eXBlX18gPSAnRW50aXR5TGlzdCc7XG5cbiAgLy8gI3JlZ2lvbiDnp4HmnInlsZ7mgKdcbiAgcHJpdmF0ZSBvcmlnaW5hbERhdGE6IGFueVtdID0gW107XG4gIC8qKlxuICAgKiDlt7Llup/lvIPvvJror7fli7/kvb/nlKhcbiAgICovXG4gIHByaXZhdGUgcmF3RGF0YTogVFtdO1xuXG4gIC8qKlxuICAgKiDlt7Llup/lvIPvvJror7fli7/kvb/nlKhcbiAgICovXG4gIHByaXZhdGUgbGlzdENoYW5nZWQgPSBuZXcgU3ViamVjdDxNb2RpZmljYXRpb24+KCk7XG5cbiAgLyoqXG4gICAqIOW3suW6n+W8g++8muivt+WLv+S9v+eUqFxuICAgKi9cbiAgcHJpdmF0ZSBjaGFuZ2VTZXQgPSBuZXcgQ2hhbmdlU2V0KCk7XG4gIC8vICNlbmRyZWdpb25cblxuXG4gIC8vICNyZWdpb24g5YWs5pyJ5bGe5oCnXG5cbiAgLyoqXG4gICAqIOmbhuWQiOaUueWPmOaXtuinpuWPkSjmlrDlop7jgIHooYzorrDlvZXkv67mlLnjgIHliKDpmaQpXG4gICAqIEBldmVudFxuICAgKi9cbiAgcHVibGljIG9uTGlzdENoYW5nZWQgPSB0aGlzLmxpc3RDaGFuZ2VkLmFzT2JzZXJ2YWJsZSgpO1xuXG4gIC8qKlxuICAgKiDojrflj5bpobnpm4blkIhcbiAgICovXG4gIHB1YmxpYyBnZXQgaXRlbXMoKTogVFtdIHtcbiAgICByZXR1cm4gdGhpcy5yYXdEYXRhO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIl+ihqOWPmOabtOmbhlxuICAgKi9cbiAgcHVibGljIGdldCBjaGFuZ2VzKCkge1xuICAgIHJldHVybiB0aGlzLmNoYW5nZVNldC5jaGFuZ2VzO1xuICB9XG5cbiAgLyoqXG4gICAqIOiOt+WPluaMh+Wumue0ouW8leWkhOeahOWAvFxuICAgKi9cbiAgW2luZGV4OiBudW1iZXJdOiBUO1xuXG4gIC8qKlxuICAgKiDov63ku6PlmahcbiAgICovXG4gICpbU3ltYm9sLml0ZXJhdG9yXSgpOiBJdGVyYXRvcjxUPiB7XG4gICAgeWllbGQqIHRoaXMuaXRlbXM7XG4gIH1cblxuICAvLyAjZW5kcmVnaW9uXG5cblxuICAvKipcbiAgICogQHBhcmFtIGRhdGEgSlNPTuaVsOaNrumbhuWQiFxuICAgKiBAcGFyYW0gdHlwZSDpm4blkIjkuK3nmoTlrp7kvZPnsbvlnotcbiAgICovXG4gIGNvbnN0cnVjdG9yKGRhdGE/OiBhbnlbXSwgdHlwZT86IENsYXNzVHlwZSkge1xuICAgIHRoaXMuY2xlYXIoKTtcbiAgICBpZiAoZGF0YSkge1xuICAgICAgLy8gdGhpcy5sb2FkRW50aXRpZXMoZGF0YSk7XG4gICAgICBkYXRhLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgIHRoaXMuaW5pdEVudGl0eShFbnRpdHlGYWN0b3J5KHR5cGUsIGl0ZW0pKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG5cbiAgLy8gI3JlZ2lvbiDlhazmnInmlrnms5VcblxuICAvKiog5Yqg6L295a6e5L2T5YiX6KGoICovXG4gIHB1YmxpYyBsb2FkRW50aXRpZXMoZW50aXRpZXM6IFRbXSkge1xuICAgIHRoaXMuY2xlYXIoKTtcblxuICAgIGVudGl0aWVzLmZvckVhY2goZW50aXR5ID0+IHtcbiAgICAgIHRoaXMuaW5pdEVudGl0eShlbnRpdHkpO1xuICAgIH0pO1xuXG4gICAgLy8g5Y+R6YCBTG9hZOWPmOabtFxuICAgIGNvbnN0IGNoYW5nZUl0ZW0gPSB7XG4gICAgICBwYXRoOiBbXSxcbiAgICAgIHZhbHVlOiBlbnRpdGllcyxcbiAgICAgIHByZVZhbHVlOiB1bmRlZmluZWQsXG4gICAgICB0eXBlOiBNb2RpZnlUeXBlLkxvYWQsXG4gICAgICB0YXJnZXQ6IHRoaXNcbiAgICB9O1xuICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VJdGVtKTtcbiAgfVxuICAvKipcbiAgICog5riF56m6XG4gICAqL1xuICBwdWJsaWMgY2xlYXIoKSB7XG4gICAgdGhpcy5yYXdEYXRhID0gW107XG4gICAgdGhpcy5vcmlnaW5hbERhdGEgPSBbXTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmt7vliqDlrp7kvZPlr7nosaHliLDpm4blkIjkuK3vvIzlubbov5Tlm57mlrDliqDnmoTlr7nosaFcbiAgICogQHBhcmFtIGVudGl0eSDlrp7kvZPlr7nosaFcbiAgICogQHBhcmFtIGlzQ2xvbmVkIOWFi+mahlxuICAgKi9cbiAgcHVibGljIGFwcGVuZE5ldyhlbnRpdHk6IFQsIGlzQ2xvbmVkOiBib29sZWFuID0gZmFsc2UpOiBUIHtcbiAgICBjb25zdCBuZXdFbnRpdHkgPSB0aGlzLmluaXRFbnRpdHkoZW50aXR5LCB0cnVlKTtcbiAgICAvLyDmlrDlop7lj5jmm7RcbiAgICBjb25zdCBjaGFuZ2VJdGVtID0ge1xuICAgICAgcGF0aDogW10sXG4gICAgICB2YWx1ZTogW25ld0VudGl0eV0sXG4gICAgICBwcmVWYWx1ZTogdW5kZWZpbmVkLFxuICAgICAgdHlwZTogTW9kaWZ5VHlwZS5BZGRcbiAgICB9O1xuXG4gICAgaWYgKGlzQ2xvbmVkID09PSB0cnVlKSB7XG4gICAgICBjaGFuZ2VJdGVtLnR5cGUgPSBNb2RpZnlUeXBlLkNsb25lO1xuICAgIH1cblxuICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VJdGVtKTtcbiAgICByZXR1cm4gbmV3RW50aXR5O1xuICB9XG4gIC8qKlxuICAgKiDlnKjmjIflrprkvY3nva7mj5LlhaXlrp7kvZNcbiAgICogQHBhcmFtIGVudGl0eSDlrp7kvZNcbiAgICogQHBhcmFtIHBvc2l0aW9uIOaPkuWFpeS9jee9rlxuICAgKi9cbiAgcHVibGljIGluc2VydChlbnRpdHk6IFQsIHBvc2l0aW9uPzogMSB8IC0xKTogVCB7XG4gICAgY29uc3QgbmV3RW50aXR5ID0gdGhpcy5pbml0RW50aXR5KGVudGl0eSwgdHJ1ZSk7XG5cbiAgICAvLyDmlrDlop7lj5jmm7RcbiAgICBjb25zdCBjaGFuZ2VJdGVtID0ge1xuICAgICAgcGF0aDogW10sXG4gICAgICB2YWx1ZTogW25ld0VudGl0eV0sXG4gICAgICBwcmVWYWx1ZTogdW5kZWZpbmVkLFxuICAgICAgdHlwZTogTW9kaWZ5VHlwZS5JbnNlcnQsXG4gICAgICBwb3NpdGlvbjogcG9zaXRpb24sXG4gICAgfTtcblxuICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VJdGVtKTtcbiAgICByZXR1cm4gbmV3RW50aXR5O1xuICB9XG4gIC8qKlxuICAgKiDov73liqDlrp7kvZNcbiAgICovXG4gIHB1YmxpYyBhcHBlbmRFbnRpdHkoZW50aXR5OiBUKTogdm9pZCB7XG4gICAgY29uc3QgbmV3RW50aXR5ID0gdGhpcy5pbml0RW50aXR5KGVudGl0eSk7XG5cbiAgICAvLyDmlrDlop7lj5jmm7RcbiAgICBjb25zdCBjaGFuZ2VJdGVtID0ge1xuICAgICAgcGF0aDogW10sXG4gICAgICB2YWx1ZTogW25ld0VudGl0eV0sXG4gICAgICBwcmVWYWx1ZTogdW5kZWZpbmVkLFxuICAgICAgdHlwZTogTW9kaWZ5VHlwZS5BZGRcbiAgICB9O1xuXG4gICAgdGhpcy5zZXRDaGFuZ2VzKGNoYW5nZUl0ZW0pO1xuICB9XG5cbiAgLyoqXG4gICAqIOaJuemHj+i/veWKoOWunuS9k1xuICAgKi9cbiAgcHVibGljIGFwcGVuZEVudGl0aWVzKGVudGl0aWVzOiBUW10pOiB2b2lkIHtcbiAgICBjb25zdCBuZXdFbnRpdGVzID0gZW50aXRpZXMubWFwKChlbnRpdHk6IFQpID0+IHtcbiAgICAgIHJldHVybiB0aGlzLmluaXRFbnRpdHkoZW50aXR5KTtcbiAgICB9KTtcbiAgICBjb25zdCBjaGFuZ2VJdGVtID0ge1xuICAgICAgcGF0aDogW10sXG4gICAgICB2YWx1ZTogbmV3RW50aXRlcyxcbiAgICAgIHByZVZhbHVlOiB1bmRlZmluZWQsXG4gICAgICB0eXBlOiBNb2RpZnlUeXBlLkFkZFxuICAgIH07XG5cbiAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlSXRlbSk7XG4gIH1cblxuICAvKipcbiAgICog5Yig6Zmk5oyH5a6a5Li76ZSuSUQg55qE5a6e5L2T5a+56LGh77yM6L+U5Zue5biD5bCU77yMdHJ1ZSDliKDpmaTmiJDlip/vvIxmYWxzZSDliKDpmaTlpLHotKVcbiAgICogQHBhcmFtIHByaW1hcnlJZCDkuLvplK5JRFxuICAgKi9cbiAgcHVibGljIHJlbW92ZShwcmltYXJ5SWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHRvdGFsID0gdGhpcy5jb3VudCgpO1xuICAgIGNvbnN0IGluZGV4VG9SZW1vdmUgPSB0aGlzLnJhd0RhdGEuZmluZEluZGV4KChlbnRpdHk6IEVudGl0eSkgPT4ge1xuICAgICAgcmV0dXJuIGVudGl0eS5wcmltYXJ5VmFsdWUgPT09IHByaW1hcnlJZDtcbiAgICB9KTtcbiAgICBpZiAoaW5kZXhUb1JlbW92ZSA9PT0gLTEpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgY29uc3QgZW50aXR5VG9SZW1vdmUgPSB0aGlzLnJhd0RhdGFbaW5kZXhUb1JlbW92ZV07XG4gICAgdGhpcy5yYXdEYXRhLnNwbGljZShpbmRleFRvUmVtb3ZlLCAxKTtcblxuICAgIC8vIOWIoOmZpOWPmOabtFxuICAgIGNvbnN0IGNoYW5nZUl0ZW0gPSB7XG4gICAgICBwYXRoOiBbXSxcbiAgICAgIHZhbHVlOiB7IFtlbnRpdHlUb1JlbW92ZS5wcmltYXJ5UHJvcGVydHkuZGF0YUZpZWxkXTogcHJpbWFyeUlkIH0sXG4gICAgICBwcmVWYWx1ZTogdW5kZWZpbmVkLFxuICAgICAgdHlwZTogTW9kaWZ5VHlwZS5SZW1vdmVcbiAgICB9O1xuXG4gICAgdGhpcy51cGRhdGVJbmRleCh0b3RhbCk7XG4gICAgdGhpcy5zZXRDaGFuZ2VzKGNoYW5nZUl0ZW0pO1xuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICog5LuO6ZuG5ZCI5Lit6I635Y+W5oyH5a6aSUTlgLznmoTlrp7kvZPlr7nosaFcbiAgICogQHBhcmFtIGlkIOS4u+mUruWAvFxuICAgKi9cbiAgcHVibGljIGdldChpZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuaXRlbXMuZmluZChpdGVtID0+IHtcbiAgICAgIHJldHVybiBpdGVtLnByaW1hcnlWYWx1ZSA9PT0gaWQ7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICog5bCG5Y+Y5pu06K6w5b2V5re75Yqg5Yiw6ZuG5ZCI5Y+Y5pu06ZuG5LitXG4gICAqIEBwYXJhbSB2YWx1ZSDlj5jmm7TorrDlvZVcbiAgICovXG4gIHB1YmxpYyBzZXRDaGFuZ2VzKG1vZGluZm86IE1vZGlmaWNhdGlvbikge1xuICAgIC8vIOWQkWFwcOWxguWPkemAgeeahOWPmOabtFxuICAgIHRoaXMubGlzdENoYW5nZWQubmV4dChtb2RpbmZvKTtcblxuICAgIC8vIOaehOmAoOWQkWNoYW5nZVNldOS4rea3u+WKoOeahGNoYWduZVxuICAgIGNvbnN0IGNoYW5nZSA9IE9iamVjdC5hc3NpZ24oe30sIG1vZGluZm8pO1xuICAgIGlmICgobW9kaW5mby50eXBlID09PSBNb2RpZnlUeXBlLkFkZCB8fCBtb2RpbmZvLnR5cGUgPT09IE1vZGlmeVR5cGUuSW5zZXJ0IHx8IG1vZGluZm8udHlwZSA9PT0gTW9kaWZ5VHlwZS5DbG9uZSkgJiYgbW9kaW5mby52YWx1ZVswXSBpbnN0YW5jZW9mIEVudGl0eSkge1xuICAgICAgY2hhbmdlLnZhbHVlID0gW21vZGluZm8udmFsdWVbMF0uZGF0YV07XG4gICAgfVxuICAgIHRoaXMuY2hhbmdlU2V0LmFwcGVuZChjaGFuZ2UpO1xuICB9XG5cbiAgLyoqIOmbhuWQiOaAu+iusOW9leaVsCAqL1xuICBwdWJsaWMgY291bnQoKSB7XG4gICAgcmV0dXJuIHRoaXMuaXRlbXMubGVuZ3RoO1xuICB9XG5cbiAgLyoqXG4gICAqIOiOt+WPluWunuS9k+WvueixoeeahOe0ouW8leWAvFxuICAgKi9cbiAgcHVibGljIGluZGV4T2YoZW50aXR5OiBUKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5pdGVtcy5pbmRleE9mKGVudGl0eSk7XG4gIH1cblxuICAvKipcbiAgICog6K6h566X6ZuG5ZCI5Lit5p+Q5Liq5bGe5oCn55qE5oC75ZKMXG4gICAqIEBwYXJhbSBwcm9wZXJ0eU5hbWUg5bGe5oCn5ZCN56ewXG4gICAqL1xuICBwdWJsaWMgc3VtKHByb3BlcnR5TmFtZTogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBpZiAodGhpcy5jb3VudCgpID09PSAwKSB7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuaXRlbXMucmVkdWNlKCh2YWwsIGN1cnI6IFQpID0+IHtcbiAgICAgIHJldHVybiB2YWwgKyBjdXJyW3Byb3BlcnR5TmFtZV07XG4gICAgfSwgMCk7XG4gIH1cblxuICAvKipcbiAgICog5bey5bqf5byD77ya6K+35L2/55SodG9KU09O5pa55rOV5Luj5pu/XG4gICAqIEBkZXByZWNhdGVkXG4gICAqL1xuICBwdWJsaWMgdG9Kc29uKCkge1xuICAgIHJldHVybiB0aGlzLnJhd0RhdGE7XG4gIH1cblxuICAvKipcbiAgICog6L2s5o2i5Li6SlNPTuagvOW8j1xuICAgKi9cbiAgcHVibGljIHRvSlNPTigpOiBhbnlbXSB7XG4gICAgY29uc3QgcmVzdWx0ID0gW107XG4gICAgdGhpcy5pdGVtcy5mb3JFYWNoKChlbnRpdHk6IEVudGl0eSkgPT4ge1xuICAgICAgcmVzdWx0LnB1c2goZW50aXR5LnRvSlNPTigpKTtcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcHVibGljIHRvQXJyYXkoKTogVFtdIHtcbiAgICByZXR1cm4gdGhpcy5pdGVtcztcbiAgfVxuXG4gIC8vICNlbmRyZWdpb25cblxuXG4gIC8vICNyZWdpb24g56eB5pyJ5pa55rOVXG5cbiAgLyoqXG4gICAqIOWunuS9k+WIneWni+WMllxuICAgKiBAcGFyYW0gZW50aXR5IOWunuS9k1xuICAgKi9cbiAgcHJpdmF0ZSBpbml0RW50aXR5KGVudGl0eTogVCwgaXNOZXdFbnRpdHk6IGJvb2xlYW4gPSBmYWxzZSk6IFQge1xuICAgIGVudGl0eVtQQVJFTlRfQ0xBU1NdID0gdGhpcztcbiAgICBlbnRpdHlbUEFSRU5UX1BBVEhdID0gdGhpc1tQQVJFTlRfUEFUSF07XG4gICAgZW50aXR5Lm9uVmFsdWVDaGFuZ2VkLnN1YnNjcmliZSgodjogTW9kaWZpY2F0aW9uKSA9PiB7XG4gICAgICBjb25zdCBwYXRoID0gdi5wYXRoO1xuICAgICAgY29uc3QgdmFsdWUgPSB2LnZhbHVlO1xuICAgICAgY29uc3QgcHJlVmFsdWUgPSB2LnByZVZhbHVlO1xuICAgICAgY29uc3Qgb3BlcmF0b3IgPSB2LnR5cGU7XG4gICAgICBjb25zdCBzdWJDaGFuZ2VzID0geyBwYXRoLCB2YWx1ZSwgcHJlVmFsdWUsIHR5cGU6IG9wZXJhdG9yIH07XG4gICAgICBpZiAodi5jaGFuZ2VTZXRWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHN1YkNoYW5nZXNbJ2NoYW5nZVNldFZhbHVlJ10gPSB2LmNoYW5nZVNldFZhbHVlO1xuICAgICAgfVxuICAgICAgdGhpcy5zZXRDaGFuZ2VzKHN1YkNoYW5nZXMpO1xuICAgIH0pO1xuICAgIC8vIFRPRE86IOa3u+WKoOaVsOaNrumqjOivgemAu+i+keS7o+eggVxuICAgIGNvbnN0IG5ld0xlbmd0aCA9IHRoaXMucmF3RGF0YS5wdXNoKGVudGl0eSk7XG4gICAgdGhpc1tuZXdMZW5ndGggLSAxXSA9IGVudGl0eTtcbiAgICBpZiAoIWlzTmV3RW50aXR5KSB7XG4gICAgICB0aGlzLm9yaWdpbmFsRGF0YS5wdXNoKGVudGl0eS50b0pTT04oKSk7XG4gICAgfVxuICAgIHJldHVybiBlbnRpdHk7XG4gIH1cblxuICAvKipcbiAgICog5pu05paw57Si5byVXG4gICAqIEBwYXJhbSB0b3RhbCDmgLvorrDlvZXmlbBcbiAgICovXG4gIHByaXZhdGUgdXBkYXRlSW5kZXgodG90YWw6IG51bWJlcikge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdG90YWw7IGkrKykge1xuICAgICAgZGVsZXRlIHRoaXNbaV07XG4gICAgfVxuICAgIHRoaXMucmF3RGF0YS5mb3JFYWNoKChlbnRpdHksIGluZGV4KSA9PiB7XG4gICAgICB0aGlzW2luZGV4XSA9IGVudGl0eTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5blsZ7mgKflkI3np7BcbiAgICovXG4gIHByaXZhdGUgZ2V0UHJvcGVydHlOYW1lKCkge1xuICAgIGNvbnN0IHBhdGggPSB0aGlzW1BBUkVOVF9QQVRIXTtcbiAgICBpZiAocGF0aCAmJiBwYXRoLmxlbmd0aCkge1xuICAgICAgY29uc3QgbmFtZSA9IHBhdGhbcGF0aC5sZW5ndGggLSAxXTtcbiAgICAgIHJldHVybiBuYW1lO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgLy8gI2VuZHJlZ2lvblxuXG59XG4iXX0=