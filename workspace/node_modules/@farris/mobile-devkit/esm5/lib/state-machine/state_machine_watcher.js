/**
 * 状态机事件，监听uistate的变化和entity的变化
 */
var StateMachineWatcher = /** @class */ (function () {
    function StateMachineWatcher(stateMachine) {
        this.stateMachine = stateMachine;
        /**
         * 所有UIStatePath数组
         */
        this.uiStatePathList = [];
        /**
         * 所有DataStatePath数组
         */
        this.dataStatePathList = [];
        this.viewModelContextAndUIStatePathsMap = new Map();
        this.viewModelContextAndDataStatePathsMap = new Map();
    }
    /**
     * 初始化
     * @param viewModelContext 当前视图上下文
     */
    StateMachineWatcher.prototype.init = function (viewModelContext) {
        this.viewModelContext = viewModelContext;
    };
    /**
     * 返回表达式中ViewModelId对应的ViewModelContext
     */
    StateMachineWatcher.prototype.getViewModelContext = function (expression) {
        var viewModelId = this.extractPaths(expression).split('/')[1];
        return this.viewModelContext.appContext.viewModelContextManager.getContextById(viewModelId);
    };
    /**
     * 监听UIState变更
     * @param viewModelContext ViewModel上下文
     * @param expression UIState表达式
     */
    StateMachineWatcher.prototype.subscribeUIStateChange = function (viewModelContext, expression) {
        var _this = this;
        var uiStatePath = this.getStatePath(expression);
        if (this.viewModelContextAndUIStatePathsMap.has(viewModelContext) === false) {
            this.viewModelContextAndUIStatePathsMap.set(viewModelContext, this.uiStatePathList);
            viewModelContext.uiState.changes.subscribe(function (uiStateChange) {
                var uiStatePathList = _this.viewModelContextAndUIStatePathsMap.get(viewModelContext);
                if (uiStateChange.field && uiStatePathList.indexOf(uiStateChange.field) > -1) {
                    _this.stateMachine.render();
                }
            });
        }
        if (this.viewModelContextAndUIStatePathsMap.get(viewModelContext).indexOf(uiStatePath) === -1) {
            this.uiStatePathList.push(uiStatePath);
        }
    };
    /**
     * 监听实体变更
     */
    StateMachineWatcher.prototype.subscribeEntityChange = function (viewModelContext, expression) {
        var _this = this;
        if (this.viewModelContextAndDataStatePathsMap.has(viewModelContext) === false) {
            this.viewModelContextAndDataStatePathsMap.set(viewModelContext, this.dataStatePathList);
            viewModelContext.bindingData.changes.subscribe(function (change) {
                if (change.type === 'Load' || change.type === 'SelectionChanged') {
                    _this.stateMachine.render();
                }
                var dataPathList = _this.viewModelContextAndDataStatePathsMap.get(viewModelContext);
                if (change.path.join() && _this.isAccordingPath(dataPathList, change.path.join('/'))) {
                    _this.stateMachine.render();
                }
            });
        }
        if (this.viewModelContextAndDataStatePathsMap.get(viewModelContext).indexOf(expression) === -1) {
            this.dataStatePathList.push(expression);
        }
    };
    /**
     * 根据表达式获取对应的StatePath（移除了ViewModelId之外的部分）
     * @param expression 变量表达式
     */
    StateMachineWatcher.prototype.getStatePath = function (expression) {
        return this.extractPaths(expression).split('/')[2];
    };
    /**
     * 判断是否监听范围内的变更路径
     */
    StateMachineWatcher.prototype.isAccordingPath = function (dataStatePaths, dataStatePath) {
        var targetPath = dataStatePaths.find(function (item) {
            return item.indexOf(dataStatePath) > -1;
        });
        return targetPath === undefined ? false : true;
    };
    /**
     * 暂时把这个方法放了这个地方，等季老师共用方法调整后，直接引用他的方法，该方法可删除
     * @param expression 变量表达式
     */
    StateMachineWatcher.prototype.extractPaths = function (expression) {
        var path;
        var UI_STATE_PATTERN_G = /\{UISTATE~(\S+?)\}/g;
        var DATA_PATTERN_G = /\{DATA~(\S+?)\}/g;
        var uiStateVariables = expression.match(UI_STATE_PATTERN_G);
        var dataVariables = expression.match(DATA_PATTERN_G);
        if (uiStateVariables !== null) {
            var UI_STATE_PATTERN_1 = /\{UISTATE~(\S+?)\}/;
            uiStateVariables.forEach(function (uiStateVariable) {
                var pathMatches = uiStateVariable.match(UI_STATE_PATTERN_1);
                if (pathMatches != null && pathMatches.length === 2) {
                    path = pathMatches[1];
                }
            });
        }
        if (dataVariables !== null) {
            var DATA_PATTERN_1 = /\{DATA~(\S+?)\}/;
            dataVariables.forEach(function (dataVariable) {
                var pathMatches = dataVariable.match(DATA_PATTERN_1);
                if (pathMatches != null && pathMatches.length === 2) {
                    path = pathMatches[1];
                }
            });
        }
        return path;
    };
    return StateMachineWatcher;
}());
export { StateMachineWatcher };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVfbWFjaGluZV93YXRjaGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3N0YXRlLW1hY2hpbmUvc3RhdGVfbWFjaGluZV93YXRjaGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUtBOztHQUVHO0FBQ0g7SUEyQkUsNkJBQW1CLFlBQTBCO1FBQTFCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBVjdDOztXQUVHO1FBQ0ssb0JBQWUsR0FBa0IsRUFBRSxDQUFDO1FBRTVDOztXQUVHO1FBQ0ssc0JBQWlCLEdBQWtCLEVBQUUsQ0FBQztRQUc1QyxJQUFJLENBQUMsa0NBQWtDLEdBQUcsSUFBSSxHQUFHLEVBQXlCLENBQUM7UUFDM0UsSUFBSSxDQUFDLG9DQUFvQyxHQUFHLElBQUksR0FBRyxFQUF5QixDQUFDO0lBQy9FLENBQUM7SUFFRDs7O09BR0c7SUFDSSxrQ0FBSSxHQUFYLFVBQVksZ0JBQWtDO1FBQzVDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztJQUMzQyxDQUFDO0lBRUQ7O09BRUc7SUFDSSxpREFBbUIsR0FBMUIsVUFBMkIsVUFBZTtRQUN4QyxJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNoRSxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsdUJBQXVCLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzlGLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksb0RBQXNCLEdBQTdCLFVBQThCLGdCQUFrQyxFQUFFLFVBQWU7UUFBakYsaUJBZ0JDO1FBZkMsSUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUVsRCxJQUFJLElBQUksQ0FBQyxrQ0FBa0MsQ0FBQyxHQUFHLENB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aUpDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3RhdGVNYWNoaW5lIH0gZnJvbSAnLi9zdGF0ZV9tYWNoaW5lJztcbmltcG9ydCB7IFZpZXdNb2RlbENvbnRleHQgfSBmcm9tICcuLi92aWV3LW1vZGVsL2luZGV4JztcbmltcG9ydCB7IENoYW5nZSB9IGZyb20gJy4uL2JpbmRpbmctZGF0YS9jaGFuZ2VzJztcblxuXG4vKipcbiAqIOeKtuaAgeacuuS6i+S7tu+8jOebkeWQrHVpc3RhdGXnmoTlj5jljJblkoxlbnRpdHnnmoTlj5jljJZcbiAqL1xuZXhwb3J0IGNsYXNzIFN0YXRlTWFjaGluZVdhdGNoZXIge1xuXG4gIC8qKlxuICAgKiDlvZPliY1WaWV3TW9kZWzkuIrkuIvmlodcbiAgICovXG4gIHByaXZhdGUgdmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dDtcblxuICAvKipcbiAgICogdmlld01vZGVsPT5VSVN0YXRlUGFodHPlrZflhbhcbiAgICovXG4gIHByaXZhdGUgdmlld01vZGVsQ29udGV4dEFuZFVJU3RhdGVQYXRoc01hcDogTWFwPFZpZXdNb2RlbENvbnRleHQsIEFycmF5PHN0cmluZz4+O1xuXG4gIC8qKlxuICAgKiB2aWV3TW9kZWw9PkRhdGFTdGF0ZVBhaHRz5a2X5YW4XG4gICAqL1xuICBwcml2YXRlIHZpZXdNb2RlbENvbnRleHRBbmREYXRhU3RhdGVQYXRoc01hcDogTWFwPFZpZXdNb2RlbENvbnRleHQsIEFycmF5PHN0cmluZz4+O1xuXG4gIC8qKlxuICAgKiDmiYDmnIlVSVN0YXRlUGF0aOaVsOe7hFxuICAgKi9cbiAgcHJpdmF0ZSB1aVN0YXRlUGF0aExpc3Q6IEFycmF5PHN0cmluZz4gPSBbXTtcblxuICAvKipcbiAgICog5omA5pyJRGF0YVN0YXRlUGF0aOaVsOe7hFxuICAgKi9cbiAgcHJpdmF0ZSBkYXRhU3RhdGVQYXRoTGlzdDogQXJyYXk8c3RyaW5nPiA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBzdGF0ZU1hY2hpbmU6IFN0YXRlTWFjaGluZSkge1xuICAgIHRoaXMudmlld01vZGVsQ29udGV4dEFuZFVJU3RhdGVQYXRoc01hcCA9IG5ldyBNYXA8Vmlld01vZGVsQ29udGV4dCwgYW55PigpO1xuICAgIHRoaXMudmlld01vZGVsQ29udGV4dEFuZERhdGFTdGF0ZVBhdGhzTWFwID0gbmV3IE1hcDxWaWV3TW9kZWxDb250ZXh0LCBhbnk+KCk7XG4gIH1cblxuICAvKipcbiAgICog5Yid5aeL5YyWXG4gICAqIEBwYXJhbSB2aWV3TW9kZWxDb250ZXh0IOW9k+WJjeinhuWbvuS4iuS4i+aWh1xuICAgKi9cbiAgcHVibGljIGluaXQodmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dCkge1xuICAgIHRoaXMudmlld01vZGVsQ29udGV4dCA9IHZpZXdNb2RlbENvbnRleHQ7XG4gIH1cblxuICAvKipcbiAgICog6L+U5Zue6KGo6L6+5byP5LitVmlld01vZGVsSWTlr7nlupTnmoRWaWV3TW9kZWxDb250ZXh0XG4gICAqL1xuICBwdWJsaWMgZ2V0Vmlld01vZGVsQ29udGV4dChleHByZXNzaW9uOiBhbnkpOiBWaWV3TW9kZWxDb250ZXh0IHtcbiAgICBjb25zdCB2aWV3TW9kZWxJZCA9IHRoaXMuZXh0cmFjdFBhdGhzKGV4cHJlc3Npb24pLnNwbGl0KCcvJylbMV07XG4gICAgcmV0dXJuIHRoaXMudmlld01vZGVsQ29udGV4dC5hcHBDb250ZXh0LnZpZXdNb2RlbENvbnRleHRNYW5hZ2VyLmdldENvbnRleHRCeUlkKHZpZXdNb2RlbElkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDnm5HlkKxVSVN0YXRl5Y+Y5pu0XG4gICAqIEBwYXJhbSB2aWV3TW9kZWxDb250ZXh0IFZpZXdNb2RlbOS4iuS4i+aWh1xuICAgKiBAcGFyYW0gZXhwcmVzc2lvbiBVSVN0YXRl6KGo6L6+5byPXG4gICAqL1xuICBwdWJsaWMgc3Vic2NyaWJlVUlTdGF0ZUNoYW5nZSh2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0LCBleHByZXNzaW9uOiBhbnkpIHtcbiAgICBjb25zdCB1aVN0YXRlUGF0aCA9IHRoaXMuZ2V0U3RhdGVQYXRoKGV4cHJlc3Npb24pO1xuXG4gICAgaWYgKHRoaXMudmlld01vZGVsQ29udGV4dEFuZFVJU3RhdGVQYXRoc01hcC5oYXModmlld01vZGVsQ29udGV4dCkgPT09IGZhbHNlKSB7XG4gICAgICB0aGlzLnZpZXdNb2RlbENvbnRleHRBbmRVSVN0YXRlUGF0aHNNYXAuc2V0KHZpZXdNb2RlbENvbnRleHQsIHRoaXMudWlTdGF0ZVBhdGhMaXN0KTtcbiAgICAgIHZpZXdNb2RlbENvbnRleHQudWlTdGF0ZS5jaGFuZ2VzLnN1YnNjcmliZSgodWlTdGF0ZUNoYW5nZSkgPT4ge1xuICAgICAgICBjb25zdCB1aVN0YXRlUGF0aExpc3QgPSB0aGlzLnZpZXdNb2RlbENvbnRleHRBbmRVSVN0YXRlUGF0aHNNYXAuZ2V0KHZpZXdNb2RlbENvbnRleHQpO1xuICAgICAgICBpZiAodWlTdGF0ZUNoYW5nZS5maWVsZCAmJiB1aVN0YXRlUGF0aExpc3QuaW5kZXhPZih1aVN0YXRlQ2hhbmdlLmZpZWxkKSA+IC0xKSB7XG4gICAgICAgICAgdGhpcy5zdGF0ZU1hY2hpbmUucmVuZGVyKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnZpZXdNb2RlbENvbnRleHRBbmRVSVN0YXRlUGF0aHNNYXAuZ2V0KHZpZXdNb2RlbENvbnRleHQpLmluZGV4T2YodWlTdGF0ZVBhdGgpID09PSAtMSkge1xuICAgICAgdGhpcy51aVN0YXRlUGF0aExpc3QucHVzaCh1aVN0YXRlUGF0aCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOebkeWQrOWunuS9k+WPmOabtFxuICAgKi9cbiAgcHVibGljIHN1YnNjcmliZUVudGl0eUNoYW5nZSh2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0LCBleHByZXNzaW9uOiBhbnkpIHtcblxuICAgIGlmICh0aGlzLnZpZXdNb2RlbENvbnRleHRBbmREYXRhU3RhdGVQYXRoc01hcC5oYXModmlld01vZGVsQ29udGV4dCkgPT09IGZhbHNlKSB7XG4gICAgICB0aGlzLnZpZXdNb2RlbENvbnRleHRBbmREYXRhU3RhdGVQYXRoc01hcC5zZXQodmlld01vZGVsQ29udGV4dCwgdGhpcy5kYXRhU3RhdGVQYXRoTGlzdCk7XG4gICAgICB2aWV3TW9kZWxDb250ZXh0LmJpbmRpbmdEYXRhLmNoYW5nZXMuc3Vic2NyaWJlKChjaGFuZ2U6IENoYW5nZSkgPT4ge1xuXG4gICAgICAgIGlmIChjaGFuZ2UudHlwZSA9PT0gJ0xvYWQnIHx8IGNoYW5nZS50eXBlID09PSAnU2VsZWN0aW9uQ2hhbmdlZCcpIHtcbiAgICAgICAgICB0aGlzLnN0YXRlTWFjaGluZS5yZW5kZXIoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGRhdGFQYXRoTGlzdCA9IHRoaXMudmlld01vZGVsQ29udGV4dEFuZERhdGFTdGF0ZVBhdGhzTWFwLmdldCh2aWV3TW9kZWxDb250ZXh0KTtcbiAgICAgICAgaWYgKGNoYW5nZS5wYXRoLmpvaW4oKSAmJiB0aGlzLmlzQWNjb3JkaW5nUGF0aChkYXRhUGF0aExpc3QsIGNoYW5nZS5wYXRoLmpvaW4oJy8nKSkpIHtcbiAgICAgICAgICB0aGlzLnN0YXRlTWFjaGluZS5yZW5kZXIoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMudmlld01vZGVsQ29udGV4dEFuZERhdGFTdGF0ZVBhdGhzTWFwLmdldCh2aWV3TW9kZWxDb250ZXh0KS5pbmRleE9mKGV4cHJlc3Npb24pID09PSAtMSkge1xuICAgICAgdGhpcy5kYXRhU3RhdGVQYXRoTGlzdC5wdXNoKGV4cHJlc3Npb24pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDmoLnmja7ooajovr7lvI/ojrflj5blr7nlupTnmoRTdGF0ZVBhdGjvvIjnp7vpmaTkuoZWaWV3TW9kZWxJZOS5i+WklueahOmDqOWIhu+8iVxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbiDlj5jph4/ooajovr7lvI9cbiAgICovXG4gIHByaXZhdGUgZ2V0U3RhdGVQYXRoKGV4cHJlc3Npb246IGFueSkge1xuICAgIHJldHVybiB0aGlzLmV4dHJhY3RQYXRocyhleHByZXNzaW9uKS5zcGxpdCgnLycpWzJdO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIpOaWreaYr+WQpuebkeWQrOiMg+WbtOWGheeahOWPmOabtOi3r+W+hFxuICAgKi9cbiAgcHVibGljIGlzQWNjb3JkaW5nUGF0aChkYXRhU3RhdGVQYXRoczogYW55LCBkYXRhU3RhdGVQYXRoOiBzdHJpbmcpIHtcbiAgICBjb25zdCB0YXJnZXRQYXRoID0gZGF0YVN0YXRlUGF0aHMuZmluZCgoaXRlbSkgPT4ge1xuICAgICAgcmV0dXJuIGl0ZW0uaW5kZXhPZihkYXRhU3RhdGVQYXRoKSA+IC0xO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRhcmdldFBhdGggPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmmoLml7bmiorov5nkuKrmlrnms5XmlL7kuobov5nkuKrlnLDmlrnvvIznrYnlraPogIHluIjlhbHnlKjmlrnms5XosIPmlbTlkI7vvIznm7TmjqXlvJXnlKjku5bnmoTmlrnms5XvvIzor6Xmlrnms5Xlj6/liKDpmaRcbiAgICogQHBhcmFtIGV4cHJlc3Npb24g5Y+Y6YeP6KGo6L6+5byPXG4gICAqL1xuICBwcml2YXRlIGV4dHJhY3RQYXRocyhleHByZXNzaW9uOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGxldCBwYXRoOiBzdHJpbmc7XG4gICAgY29uc3QgVUlfU1RBVEVfUEFUVEVSTl9HID0gL1xce1VJU1RBVEV+KFxcUys/KVxcfS9nO1xuICAgIGNvbnN0IERBVEFfUEFUVEVSTl9HID0gL1xce0RBVEF+KFxcUys/KVxcfS9nO1xuICAgIGNvbnN0IHVpU3RhdGVWYXJpYWJsZXMgPSBleHByZXNzaW9uLm1hdGNoKFVJX1NUQVRFX1BBVFRFUk5fRyk7XG4gICAgY29uc3QgZGF0YVZhcmlhYmxlcyA9IGV4cHJlc3Npb24ubWF0Y2goREFUQV9QQVRURVJOX0cpO1xuICAgIGlmICh1aVN0YXRlVmFyaWFibGVzICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBVSV9TVEFURV9QQVRURVJOID0gL1xce1VJU1RBVEV+KFxcUys/KVxcfS87XG4gICAgICB1aVN0YXRlVmFyaWFibGVzLmZvckVhY2goKHVpU3RhdGVWYXJpYWJsZTogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IHBhdGhNYXRjaGVzID0gdWlTdGF0ZVZhcmlhYmxlLm1hdGNoKFVJX1NUQVRFX1BBVFRFUk4pO1xuICAgICAgICBpZiAocGF0aE1hdGNoZXMgIT0gbnVsbCAmJiBwYXRoTWF0Y2hlcy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICBwYXRoID0gcGF0aE1hdGNoZXNbMV07XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAoZGF0YVZhcmlhYmxlcyAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgREFUQV9QQVRURVJOID0gL1xce0RBVEF+KFxcUys/KVxcfS87XG4gICAgICBkYXRhVmFyaWFibGVzLmZvckVhY2goKGRhdGFWYXJpYWJsZTogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IHBhdGhNYXRjaGVzID0gZGF0YVZhcmlhYmxlLm1hdGNoKERBVEFfUEFUVEVSTik7XG4gICAgICAgIGlmIChwYXRoTWF0Y2hlcyAhPSBudWxsICYmIHBhdGhNYXRjaGVzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgIHBhdGggPSBwYXRoTWF0Y2hlc1sxXTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBwYXRoO1xuICB9XG59Il19