import { MetadataUtil } from '../core/index';
import { FormControl } from './form_control';
import { FORM_CONTROL_PROP_META } from './decorators';
import { Subject } from 'rxjs';
import { ValidatorFactory } from '../validator';
import { tap } from 'rxjs/operators';
/**
 * Form抽象类
 */
var Form = /** @class */ (function () {
    /**
     * 构造函数
     */
    function Form(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.formControlConfigs = [];
        this.validateformControls = [];
        this.validateformControlPathMap = new Map;
        this.changes = new Subject();
    }
    /**
     * 初始化
     */
    Form.prototype.init = function () {
        this.collectMetadatas();
        this.createFormControls();
    };
    /**
     * 使用不包含绝对路径的/或者/子表/的路径信息获取对应的formControlConfig的name属性与bindingPath并且返回该路径的formControl
     * @param path 路径信息
     * @returns
     */
    Form.prototype.getFormValueByBindPath = function (path) {
        var _this = this;
        var formControl = {
            form_name: {},
            name: '',
            bindingPath: ''
        };
        path = path.replace(/\//g, '.');
        if (this.formControlConfigs.length === 0)
            return formControl;
        this.formControlConfigs.forEach(function (formControlConfig) {
            if (formControlConfig.bindingPath === path) {
                formControl.form_name = _this[formControlConfig.name];
                formControl.name = formControlConfig.name;
                formControl.bindingPath = formControlConfig.bindingPath;
            }
        });
        return formControl;
    };
    /**
     *
     * @returns 获取当前表单上的存在校验字段的集合
     */
    Form.prototype.getValidateformControls = function () {
        return this.validateformControls;
    };
    Form.prototype.setValidateformControls = function (name) {
        if (this.validateformControls && this.validateformControls.length === 0) {
            this.validateformControls.push(name);
        }
        if (this.validateformControls && this.validateformControls.length >= 1) {
            var index = this.validateformControls.findIndex(function (item) { return item == name; });
            if (index === -1) {
                this.validateformControls.push(name);
            }
        }
        if (!Array.isArray(this.validateformControls)) {
            this.validateformControls = [name];
        }
    };
    Form.prototype.getValidateformControlPathMap = function () {
        return this.validateformControlPathMap;
    };
    Form.prototype.setValidateformControlPathMap = function (name, value) {
        if (!this.validateformControlPathMap.has(name)) {
            this.validateformControlPathMap.set(name, value);
        }
    };
    /**
     * 使用formControlConfig的bindingPath路径信息与对应formControlConfig的name信息储存起来作为验证信息在form上的记录
     * @param path formControlConfig的bindingPath路径信息
     * @param name 对应formContro的name信息
     */
    Form.prototype.addValidate = function (path, name) {
        var bindingPath = this.viewModelContext.bindingData.bindingPath.slice(1).replace(/\//g, '.');
        if (bindingPath) {
            bindingPath = bindingPath + '.';
        }
        ;
        this.setValidateformControlPathMap(bindingPath + path, name);
        this.setValidateformControls(name);
    };
    /**
     * 全部校验
     *  formControlConfigs 上所有的formControl的存在方法调用一遍 将错误信息集中返回
     */
    Form.prototype.validateFields = function () {
        var _this = this;
        var validationResult = [];
        if (this.validateformControls.length === 0) {
            return validationResult;
        }
        this.validateformControls.forEach(function (formControl) {
            var result$ = ValidatorFactory.executeValidator(_this[formControl]['validatorFn'], _this[formControl]['value'], _this.viewModelContext).pipe(tap(function (message) {
                _this[formControl]['validationResult'] = message;
                !message['passing'] && _this.changes.next({ type: 'validateFieldsFinished' });
            }));
            validationResult.push(result$);
        });
        return validationResult;
    };
    /**
     * 不支持自定义异步全部校验
     *  formControlConfigs 上所有的formControl的存在方法调用一遍 将错误信息集中返回
     */
    Form.prototype.noSupportAsynValidateFields = function () {
        var _this = this;
        var validationResult = [];
        if (this.validateformControls.length === 0) {
            return validationResult;
        }
        this.validateformControls.forEach(function (formControl) {
            if (!_this[formControl]['validationResult']) {
                _this[formControl]['validationResult'] = ValidatorFactory.noSupportAsynExecuteValidator(_this[formControl]['validatorFn'], _this[formControl]['value'], _this.viewModelContext);
            }
            !_this[formControl]['validationResult'].passing && validationResult.push(_this[formControl]);
        });
        this.changes.next({ type: 'validateFieldsFinished' });
        return validationResult;
    };
    /**
     * 获取某一个得校验错误信息
     * @param name 属性名称
     */
    Form.prototype.getFieldError = function (name) {
        var _this = this;
        if (this.validateformControls.length === 0) {
            return {};
        }
        var index = this.validateformControls.findIndex(function (item) {
            return item === name;
        });
        if (index === -1) {
            return {};
        }
        else {
            var result$ = ValidatorFactory.executeValidator(this[name]['validatorFn'], this[name]['value'], this.viewModelContext).pipe(tap(function (message) {
                _this[name]['validationResult'] = message;
                !message['passing'] && _this.changes.next({ type: 'validateFieldsFinished' });
            }));
            return result$;
        }
    };
    /**
   * 根据form元数据中的path获取某一个得校验错误信息
   * @param path 属性名称数组
   */
    Form.prototype.getFieldErrorByPath = function (path) {
        var _this = this;
        if (this.validateformControls.length === 0) {
            return {};
        }
        var pathName = path[0];
        if (path && path.length >= 2) {
            pathName = path.join('.');
        }
        var index = this.validateformControlPathMap.has(pathName);
        if (!index) {
            return {};
        }
        else {
            ValidatorFactory.executeValidator(this[this.validateformControlPathMap.get(pathName)]['validatorFn'], this[this.validateformControlPathMap.get(pathName)]['value'], this.viewModelContext).subscribe(function (message) {
                _this[_this.validateformControlPathMap.get(pathName)]['validationResult'] = message;
                _this.changes.next({ type: 'validateFieldsFinished', value: _this.validateformControlPathMap.get(pathName) });
            });
            return this[this.validateformControlPathMap.get(pathName)]['validationResult'];
        }
    };
    /**
     * 清除一组字段验证状态
     * @param fields 字段的数组
     */
    Form.prototype.resetFieldsValidate = function (fields) {
        var _this = this;
        if (this.validateformControls.length === 0) {
            return true;
        }
        else {
            if (fields && fields.length > 0) {
                var sb_1 = new Set(fields);
                // 交集
                var intersect = this.validateformControls.filter(function (x) { return sb_1.has(x); });
                // 遍历清空所有校验结果数据
                intersect.forEach(function (item) {
                    _this[item]['validationResult'] = undefined;
                });
            }
            else {
                // 没传数据全部清除
                this.validateformControls.forEach(function (item) {
                    _this[item]['validationResult'] = undefined;
                });
            }
            this.changes.next({ type: 'validateFieldsFinished' });
        }
    };
    /**
     * 创建FormControls
     */
    Form.prototype.createFormControls = function () {
        var _this = this;
        this.formControlConfigs.forEach(function (formControlConfig) {
            var name = formControlConfig.name;
            var formControl = new FormControl(formControlConfig, _this.viewModelContext);
            _this[name] = formControl;
        });
    };
    /**
     * 收集元数据
     */
    Form.prototype.collectMetadatas = function () {
        var _this = this;
        var formControlMetadatas = MetadataUtil.getPropsMetadatasByName(this.constructor, FORM_CONTROL_PROP_META);
        var bindingPath = this.viewModelContext.bindingData.bindingPath.slice(1).replace(/\//g, '.');
        var validationManager = this.viewModelContext.appContext['validationManager'];
        if (bindingPath) {
            bindingPath = bindingPath + '.';
        }
        ;
        Object.keys(formControlMetadatas).forEach(function (name) {
            var formControlMetadata = formControlMetadatas[name];
            var validRules = null;
            if (formControlMetadata.validRules) {
                _this.validateformControls.push(name);
                _this.validateformControlPathMap.set(bindingPath + formControlMetadata.bindingPath, name);
                validRules = formControlMetadata.validRules;
            }
            var key = ('/' + bindingPath + formControlMetadata.bindingPath).replace(/\./g, '/');
            if (validationManager[key]) {
                if (!validRules) {
                    _this.validateformControls.push(name);
                    _this.validateformControlPathMap.set(bindingPath + formControlMetadata.bindingPath, name);
                    validRules = Object.values(validationManager[key]);
                }
                else {
                    validRules = validRules.concat(Object.values(validationManager[key]));
                }
            }
            var formControlConfig = {
                name: name,
                bindingType: formControlMetadata.bindingType,
                bindingPath: formControlMetadata.bindingPath,
                valueConverter: formControlMetadata.valueConverter,
                valueChanging: formControlMetadata.valueChanging,
                valueChanged: formControlMetadata.valueChanged,
                validRules: validRules
            };
            _this.formControlConfigs.push(formControlConfig);
        });
    };
    Form.prototype.getEntityValueChangingListeners = function () {
        var listeners = {};
        this.formControlConfigs.forEach(function (formControl) {
            if (formControl.valueChanging) {
                listeners[formControl.bindingPath] = formControl.valueChanging;
            }
        });
        return listeners;
    };
    Form.prototype.getEntityValueChangedListeners = function () {
        var listeners = {};
        this.formControlConfigs.forEach(function (formControl) {
            if (formControl.valueChanged) {
                listeners[formControl.bindingPath] = formControl.valueChanged;
            }
        });
        return listeners;
    };
    return Form;
}());
export { Form };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9mb3JtL2Zvcm0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUU3QyxPQUFPLEVBQXFCLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hFLE9BQU8sRUFBdUIsc0JBQXNCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDM0UsT0FBTyxFQUFNLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNuQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxjQUFjLENBQUE7QUFDL0MsT0FBTyxFQUFPLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTFDOztHQUVHO0FBQ0g7SUFrQkU7O09BRUc7SUFDSCxjQUFZLGdCQUFrQztRQUM1QyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUM7UUFDekMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLEVBQUUsQ0FBQztRQUM3QixJQUFJLENBQUMsb0JBQW9CLEdBQUcsRUFBRSxDQUFDO1FBQy9CLElBQUksQ0FBQywwQkFBMEIsR0FBRyxJQUFJLEdBQUcsQ0FBQztRQUMxQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7SUFDL0IsQ0FBQztJQUVEOztPQUVHO0lBQ0ksbUJBQUksR0FBWDtRQUNFLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gscUNBQXNCLEdBQXRCLFVBQXVCLElBQUk7UUFBM0IsaUJBZ0JDO1FBZkMsSUFBSSxXQUFXLEdBQUc7WUFDaEIsU0FBUyxFQUFFLEVBQUU7WUFDYixJQUFJLEVBQUUsRUFBRTtZQUNSLFdBQVcsRUFBRSxFQUFFO1NBQ2hCLENBQUM7UUFDRixJ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QkFDaEQsWUFBWSxFQUFFLG1CQUFtQixDQUFDLFlBQVk7Z0JBQzlDLFVBQVUsRUFBRSxVQUFVO2FBQ3ZCLENBQUM7WUFDRixLQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDbEQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU0sOENBQStCLEdBQXRDO1FBQ0UsSUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsVUFBQyxXQUE4QjtZQUM3RCxJQUFJLFdBQVcsQ0FBQyxhQUFhLEVBQUU7Z0JBQzdCLFNBQVMsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLEdBQUcsV0FBVyxDQUFDLGFBQWEsQ0FBQzthQUNoRTtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVNLDZDQUE4QixHQUFyQztRQUNFLElBQU0sU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLFVBQUMsV0FBOEI7WUFDN0QsSUFBSSxXQUFXLENBQUMsWUFBWSxFQUFFO2dCQUM1QixTQUFTLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxZQUFZLENBQUM7YUFDL0Q7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFDSCxXQUFDO0FBQUQsQ0FBQyxBQXJTRCxJQXFTQztBQUVELE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1ldGFkYXRhVXRpbCB9IGZyb20gJy4uL2NvcmUvaW5kZXgnO1xuaW1wb3J0IHsgVmlld01vZGVsQ29udGV4dCB9IGZyb20gJy4uL3ZpZXctbW9kZWwvaW5kZXgnO1xuaW1wb3J0IHsgRm9ybUNvbnRyb2xDb25maWcsIEZvcm1Db250cm9sIH0gZnJvbSAnLi9mb3JtX2NvbnRyb2wnO1xuaW1wb3J0IHsgRm9ybUNvbnRyb2xNZXRhZGF0YSwgRk9STV9DT05UUk9MX1BST1BfTUVUQSB9IGZyb20gJy4vZGVjb3JhdG9ycyc7XG5pbXBvcnQgeyBvZiwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgVmFsaWRhdG9yRmFjdG9yeSB9IGZyb20gJy4uL3ZhbGlkYXRvcidcbmltcG9ydCB7IG1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG4vKipcbiAqIEZvcm3mir3osaHnsbtcbiAqL1xuYWJzdHJhY3QgY2xhc3MgRm9ybSB7XG5cbiAgLyoqXG4gICAqIOihqOWNleaOp+S7tumFjee9rlxuICAgKi9cbiAgcHJpdmF0ZSBmb3JtQ29udHJvbENvbmZpZ3M6IEZvcm1Db250cm9sQ29uZmlnW107XG5cbiAgLyoqXG4gICAqIFZpZXdNb2RlbOS4iuS4i+aWh1xuICAgKi9cbiAgcHJpdmF0ZSB2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0O1xuXG4gIHByaXZhdGUgdmFsaWRhdGVmb3JtQ29udHJvbHM6IHN0cmluZ1tdO1xuXG4gIHByaXZhdGUgdmFsaWRhdGVmb3JtQ29udHJvbFBhdGhNYXA6IE1hcDxzdHJpbmcsIHN0cmluZz47XG5cbiAgcHVibGljIGNoYW5nZXM6IFN1YmplY3Q8YW55PjtcblxuICAvKipcbiAgICog5p6E6YCg5Ye95pWwXG4gICAqL1xuICBjb25zdHJ1Y3Rvcih2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0KSB7XG4gICAgdGhpcy52aWV3TW9kZWxDb250ZXh0ID0gdmlld01vZGVsQ29udGV4dDtcbiAgICB0aGlzLmZvcm1Db250cm9sQ29uZmlncyA9IFtdO1xuICAgIHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMgPSBbXTtcbiAgICB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwID0gbmV3IE1hcDtcbiAgICB0aGlzLmNoYW5nZXMgPSBuZXcgU3ViamVjdCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIneWni+WMllxuICAgKi9cbiAgcHVibGljIGluaXQoKSB7XG4gICAgdGhpcy5jb2xsZWN0TWV0YWRhdGFzKCk7XG4gICAgdGhpcy5jcmVhdGVGb3JtQ29udHJvbHMoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDkvb/nlKjkuI3ljIXlkKvnu53lr7not6/lvoTnmoQv5oiW6ICFL+WtkOihqC/nmoTot6/lvoTkv6Hmga/ojrflj5blr7nlupTnmoRmb3JtQ29udHJvbENvbmZpZ+eahG5hbWXlsZ7mgKfkuI5iaW5kaW5nUGF0aOW5tuS4lOi/lOWbnuivpei3r+W+hOeahGZvcm1Db250cm9sXG4gICAqIEBwYXJhbSBwYXRoIOi3r+W+hOS/oeaBryBcbiAgICogQHJldHVybnMgIFxuICAgKi9cbiAgZ2V0Rm9ybVZhbHVlQnlCaW5kUGF0aChwYXRoKSB7XG4gICAgbGV0IGZvcm1Db250cm9sID0ge1xuICAgICAgZm9ybV9uYW1lOiB7fSxcbiAgICAgIG5hbWU6ICcnLFxuICAgICAgYmluZGluZ1BhdGg6ICcnXG4gICAgfTtcbiAgICBwYXRoID0gcGF0aC5yZXBsYWNlKC9cXC8vZywgJy4nKVxuICAgIGlmICh0aGlzLmZvcm1Db250cm9sQ29uZmlncy5sZW5ndGggPT09IDApIHJldHVybiBmb3JtQ29udHJvbDtcbiAgICB0aGlzLmZvcm1Db250cm9sQ29uZmlncy5mb3JFYWNoKChmb3JtQ29udHJvbENvbmZpZzogRm9ybUNvbnRyb2xDb25maWcpID0+IHtcbiAgICAgIGlmIChmb3JtQ29udHJvbENvbmZpZy5iaW5kaW5nUGF0aCA9PT0gcGF0aCkge1xuICAgICAgICBmb3JtQ29udHJvbC5mb3JtX25hbWUgPSB0aGlzW2Zvcm1Db250cm9sQ29uZmlnLm5hbWVdO1xuICAgICAgICBmb3JtQ29udHJvbC5uYW1lID0gZm9ybUNvbnRyb2xDb25maWcubmFtZTtcbiAgICAgICAgZm9ybUNvbnRyb2wuYmluZGluZ1BhdGggPSBmb3JtQ29udHJvbENvbmZpZy5iaW5kaW5nUGF0aDtcbiAgICAgIH1cbiAgICB9KVxuICAgIHJldHVybiBmb3JtQ29udHJvbDtcbiAgfVxuICAvKipcbiAgICogXG4gICAqIEByZXR1cm5zIOiOt+WPluW9k+WJjeihqOWNleS4iueahOWtmOWcqOagoemqjOWtl+auteeahOmbhuWQiFxuICAgKi9cbiAgZ2V0VmFsaWRhdGVmb3JtQ29udHJvbHMoKSB7XG4gICAgcmV0dXJuIHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHM7XG4gIH1cblxuICBzZXRWYWxpZGF0ZWZvcm1Db250cm9scyhuYW1lKSB7XG5cbiAgICBpZiAodGhpcy52YWxpZGF0ZWZvcm1Db250cm9scyAmJiB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5wdXNoKG5hbWUpXG4gICAgfVxuXG4gICAgaWYgKHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMgJiYgdGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5sZW5ndGggPj0gMSkge1xuICAgICAgY29uc3QgaW5kZXggPSB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLmZpbmRJbmRleChpdGVtID0+IGl0ZW0gPT0gbmFtZSk7XG4gICAgICBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICAgIHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMucHVzaChuYW1lKVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghQXJyYXkuaXNBcnJheSh0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzKSkge1xuICAgICAgdGhpcy52YWxpZGF0ZWZvcm1Db250cm9scyA9IFtuYW1lXVxuICAgIH1cbiAgfVxuXG4gIGdldFZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwKCkge1xuICAgIHJldHVybiB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwO1xuICB9XG5cbiAgc2V0VmFsaWRhdGVmb3JtQ29udHJvbFBhdGhNYXAobmFtZSwgdmFsdWUpIHtcbiAgICBpZiAoIXRoaXMudmFsaWRhdGVmb3JtQ29udHJvbFBhdGhNYXAuaGFzKG5hbWUpKSB7XG4gICAgICB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwLnNldChuYW1lLCB2YWx1ZSlcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog5L2/55SoZm9ybUNvbnRyb2xDb25maWfnmoRiaW5kaW5nUGF0aOi3r+W+hOS/oeaBr+S4juWvueW6lGZvcm1Db250cm9sQ29uZmln55qEbmFtZeS/oeaBr+WCqOWtmOi1t+adpeS9nOS4uumqjOivgeS/oeaBr+WcqGZvcm3kuIrnmoTorrDlvZVcbiAgICogQHBhcmFtIHBhdGggZm9ybUNvbnRyb2xDb25maWfnmoRiaW5kaW5nUGF0aOi3r+W+hOS/oeaBr1xuICAgKiBAcGFyYW0gbmFtZSDlr7nlupRmb3JtQ29udHJv55qEbmFtZeS/oeaBr1xuICAgKi9cbiAgYWRkVmFsaWRhdGUocGF0aCwgbmFtZSkge1xuICAgIGxldCBiaW5kaW5nUGF0aCA9IHRoaXMudmlld01vZGVsQ29udGV4dC5iaW5kaW5nRGF0YS5iaW5kaW5nUGF0aC5zbGljZSgxKS5yZXBsYWNlKC9cXC8vZywgJy4nKTtcbiAgICBpZiAoYmluZGluZ1BhdGgpIHsgYmluZGluZ1BhdGggPSBiaW5kaW5nUGF0aCArICcuJyB9O1xuICAgIHRoaXMuc2V0VmFsaWRhdGVmb3JtQ29udHJvbFBhdGhNYXAoYmluZGluZ1BhdGggKyBwYXRoLCBuYW1lKTtcbiAgICB0aGlzLnNldFZhbGlkYXRlZm9ybUNvbnRyb2xzKG5hbWUpXG4gIH1cblxuXG4gIC8qKlxuICAgKiDlhajpg6jmoKHpqowgXG4gICAqICBmb3JtQ29udHJvbENvbmZpZ3Mg5LiK5omA5pyJ55qEZm9ybUNvbnRyb2znmoTlrZjlnKjmlrnms5XosIPnlKjkuIDpgY0g5bCG6ZSZ6K+v5L+h5oGv6ZuG5Lit6L+U5ZueXG4gICAqL1xuICB2YWxpZGF0ZUZpZWxkcygpIHtcbiAgICBsZXQgdmFsaWRhdGlvblJlc3VsdCA9IFtdO1xuICAgIGlmICh0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gdmFsaWRhdGlvblJlc3VsdDsgfVxuICAgIHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMuZm9yRWFjaCgoZm9ybUNvbnRyb2wpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCQgPSBWYWxpZGF0b3JGYWN0b3J5LmV4ZWN1dGVWYWxpZGF0b3IodGhpc1tmb3JtQ29udHJvbF1bJ3ZhbGlkYXRvckZuJ10sIHRoaXNbZm9ybUNvbnRyb2xdWyd2YWx1ZSddLCB0aGlzLnZpZXdNb2RlbENvbnRleHQpLnBpcGUoXG4gICAgICAgIHRhcChcbiAgICAgICAgICAobWVzc2FnZSkgPT4ge1xuICAgICAgICAgICAgdGhpc1tmb3JtQ29udHJvbF1bJ3ZhbGlkYXRpb25SZXN1bHQnXSA9IG1lc3NhZ2U7XG4gICAgICAgICAgICAhbWVzc2FnZVsncGFzc2luZyddICYmIHRoaXMuY2hhbmdlcy5uZXh0KHsgdHlwZTogJ3ZhbGlkYXRlRmllbGRzRmluaXNoZWQnIH0pXG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICApXG4gICAgICB2YWxpZGF0aW9uUmVzdWx0LnB1c2gocmVzdWx0JClcbiAgICB9KTtcbiAgICByZXR1cm4gdmFsaWRhdGlvblJlc3VsdDtcbiAgfVxuXG4gIC8qKlxuICAgKiDkuI3mlK/mjIHoh6rlrprkuYnlvILmraXlhajpg6jmoKHpqowgXG4gICAqICBmb3JtQ29udHJvbENvbmZpZ3Mg5LiK5omA5pyJ55qEZm9ybUNvbnRyb2znmoTlrZjlnKjmlrnms5XosIPnlKjkuIDpgY0g5bCG6ZSZ6K+v5L+h5oGv6ZuG5Lit6L+U5ZueXG4gICAqL1xuICBub1N1cHBvcnRBc3luVmFsaWRhdGVGaWVsZHMoKSB7XG4gICAgbGV0IHZhbGlkYXRpb25SZXN1bHQgPSBbXTtcbiAgICBpZiAodGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5sZW5ndGggPT09IDApIHsgcmV0dXJuIHZhbGlkYXRpb25SZXN1bHQ7IH1cbiAgICB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLmZvckVhY2goKGZvcm1Db250cm9sKSA9PiB7XG4gICAgICBpZiAoIXRoaXNbZm9ybUNvbnRyb2xdWyd2YWxpZGF0aW9uUmVzdWx0J10pIHtcbiAgICAgICAgdGhpc1tmb3JtQ29udHJvbF1bJ3ZhbGlkYXRpb25SZXN1bHQnXSA9IFZhbGlkYXRvckZhY3Rvcnkubm9TdXBwb3J0QXN5bkV4ZWN1dGVWYWxpZGF0b3IodGhpc1tmb3JtQ29udHJvbF1bJ3ZhbGlkYXRvckZuJ10sIHRoaXNbZm9ybUNvbnRyb2xdWyd2YWx1ZSddLCB0aGlzLnZpZXdNb2RlbENvbnRleHQpO1xuICAgICAgfVxuICAgICAgIXRoaXNbZm9ybUNvbnRyb2xdWyd2YWxpZGF0aW9uUmVzdWx0J10ucGFzc2luZyAmJiB2YWxpZGF0aW9uUmVzdWx0LnB1c2godGhpc1tmb3JtQ29udHJvbF0pXG4gICAgfSk7XG4gICAgdGhpcy5jaGFuZ2VzLm5leHQoeyB0eXBlOiAndmFsaWRhdGVGaWVsZHNGaW5pc2hlZCcgfSlcbiAgICByZXR1cm4gdmFsaWRhdGlvblJlc3VsdDtcbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5bmn5DkuIDkuKrlvpfmoKHpqozplJnor6/kv6Hmga9cbiAgICogQHBhcmFtIG5hbWUg5bGe5oCn5ZCN56ewXG4gICAqL1xuICBnZXRGaWVsZEVycm9yKG5hbWU6IHN0cmluZykge1xuICAgIGlmICh0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHt9XG4gICAgfVxuICAgIGNvbnN0IGluZGV4ID0gdGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5maW5kSW5kZXgoKGl0ZW0pID0+IHtcbiAgICAgIHJldHVybiBpdGVtID09PSBuYW1lXG4gICAgfSk7XG4gICAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgICAgcmV0dXJuIHt9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHJlc3VsdCQgPSBWYWxpZGF0b3JGYWN0b3J5LmV4ZWN1dGVWYWxpZGF0b3IodGhpc1tuYW1lXVsndmFsaWRhdG9yRm4nXSwgdGhpc1tuYW1lXVsndmFsdWUnXSwgdGhpcy52aWV3TW9kZWxDb250ZXh0KS5waXBlKFxuICAgICAgICB0YXAoXG4gICAgICAgICAgKG1lc3NhZ2UpID0+IHtcbiAgICAgICAgICAgIHRoaXNbbmFtZV1bJ3ZhbGlkYXRpb25SZXN1bHQnXSA9IG1lc3NhZ2U7XG4gICAgICAgICAgICAhbWVzc2FnZVsncGFzc2luZyddICYmIHRoaXMuY2hhbmdlcy5uZXh0KHsgdHlwZTogJ3ZhbGlkYXRlRmllbGRzRmluaXNoZWQnIH0pXG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICApXG4gICAgICByZXR1cm4gcmVzdWx0JDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAqIOagueaNrmZvcm3lhYPmlbDmja7kuK3nmoRwYXRo6I635Y+W5p+Q5LiA5Liq5b6X5qCh6aqM6ZSZ6K+v5L+h5oGvXG4gKiBAcGFyYW0gcGF0aCDlsZ7mgKflkI3np7DmlbDnu4RcbiAqL1xuICBnZXRGaWVsZEVycm9yQnlQYXRoKHBhdGg6IHN0cmluZ1tdKSB7XG4gICAgaWYgKHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4ge31cbiAgICB9XG4gICAgbGV0IHBhdGhOYW1lID0gcGF0aFswXVxuICAgIGlmIChwYXRoICYmIHBhdGgubGVuZ3RoID49IDIpIHtcbiAgICAgIHBhdGhOYW1lID0gcGF0aC5qb2luKCcuJyk7XG4gICAgfVxuICAgIGNvbnN0IGluZGV4ID0gdGhpcy52YWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcC5oYXMocGF0aE5hbWUpO1xuICAgIGlmICghaW5kZXgpIHtcbiAgICAgIHJldHVybiB7fVxuICAgIH0gZWxzZSB7XG4gICAgICBWYWxpZGF0b3JGYWN0b3J5LmV4ZWN1dGVWYWxpZGF0b3IodGhpc1t0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwLmdldChwYXRoTmFtZSldWyd2YWxpZGF0b3JGbiddLCB0aGlzW3RoaXMudmFsaWRhdGVmb3JtQ29udHJvbFBhdGhNYXAuZ2V0KHBhdGhOYW1lKV1bJ3ZhbHVlJ10sIHRoaXMudmlld01vZGVsQ29udGV4dCkuc3Vic2NyaWJlKFxuICAgICAgICAobWVzc2FnZSkgPT4ge1xuICAgICAgICAgIHRoaXNbdGhpcy52YWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcC5nZXQocGF0aE5hbWUpXVsndmFsaWRhdGlvblJlc3VsdCddID0gbWVzc2FnZTtcbiAgICAgICAgICB0aGlzLmNoYW5nZXMubmV4dCh7IHR5cGU6ICd2YWxpZGF0ZUZpZWxkc0ZpbmlzaGVkJywgdmFsdWU6IHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbFBhdGhNYXAuZ2V0KHBhdGhOYW1lKSB9KTtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICAgcmV0dXJuIHRoaXNbdGhpcy52YWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcC5nZXQocGF0aE5hbWUpXVsndmFsaWRhdGlvblJlc3VsdCddO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDmuIXpmaTkuIDnu4TlrZfmrrXpqozor4HnirbmgIFcbiAgICogQHBhcmFtIGZpZWxkcyDlrZfmrrXnmoTmlbDnu4RcbiAgICovXG4gIHJlc2V0RmllbGRzVmFsaWRhdGUoZmllbGRzPzogc3RyaW5nW10pIHtcbiAgICBpZiAodGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoZmllbGRzICYmIGZpZWxkcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IHNiID0gbmV3IFNldChmaWVsZHMpO1xuICAgICAgICAvLyDkuqTpm4ZcbiAgICAgICAgY29uc3QgaW50ZXJzZWN0ID0gdGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5maWx0ZXIoeCA9PiBzYi5oYXMoeCkpO1xuICAgICAgICAvLyDpgY3ljobmuIXnqbrmiYDmnInmoKHpqoznu5PmnpzmlbDmja5cbiAgICAgICAgaW50ZXJzZWN0LmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgICAgdGhpc1tpdGVtXVsndmFsaWRhdGlvblJlc3VsdCddID0gdW5kZWZpbmVkO1xuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8g5rKh5Lyg5pWw5o2u5YWo6YOo5riF6ZmkXG4gICAgICAgIHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgICAgICB0aGlzW2l0ZW1dWyd2YWxpZGF0aW9uUmVzdWx0J10gPSB1bmRlZmluZWQ7XG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgICB0aGlzLmNoYW5nZXMubmV4dCh7IHR5cGU6ICd2YWxpZGF0ZUZpZWxkc0ZpbmlzaGVkJyB9KVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDliJvlu7pGb3JtQ29udHJvbHNcbiAgICovXG4gIHByaXZhdGUgY3JlYXRlRm9ybUNvbnRyb2xzKCkge1xuICAgIHRoaXMuZm9ybUNvbnRyb2xDb25maWdzLmZvckVhY2goKGZvcm1Db250cm9sQ29uZmlnOiBGb3JtQ29udHJvbENvbmZpZykgPT4ge1xuICAgICAgY29uc3QgbmFtZSA9IGZvcm1Db250cm9sQ29uZmlnLm5hbWU7XG4gICAgICBjb25zdCBmb3JtQ29udHJvbCA9IG5ldyBGb3JtQ29udHJvbChmb3JtQ29udHJvbENvbmZpZywgdGhpcy52aWV3TW9kZWxDb250ZXh0KTtcbiAgICAgIHRoaXNbbmFtZV0gPSBmb3JtQ29udHJvbDtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmlLbpm4blhYPmlbDmja5cbiAgICovXG4gIHByaXZhdGUgY29sbGVjdE1ldGFkYXRhcygpIHtcbiAgICBjb25zdCBmb3JtQ29udHJvbE1ldGFkYXRhcyA9IE1ldGFkYXRhVXRpbC5nZXRQcm9wc01ldGFkYXRhc0J5TmFtZSh0aGlzLmNvbnN0cnVjdG9yLCBGT1JNX0NPTlRST0xfUFJPUF9NRVRBKTtcbiAgICBsZXQgYmluZGluZ1BhdGggPSB0aGlzLnZpZXdNb2RlbENvbnRleHQuYmluZGluZ0RhdGEuYmluZGluZ1BhdGguc2xpY2UoMSkucmVwbGFjZSgvXFwvL2csICcuJyk7XG4gICAgY29uc3QgdmFsaWRhdGlvbk1hbmFnZXIgPSB0aGlzLnZpZXdNb2RlbENvbnRleHQuYXBwQ29udGV4dFsndmFsaWRhdGlvbk1hbmFnZXInXTtcbiAgICBpZiAoYmluZGluZ1BhdGgpIHsgYmluZGluZ1BhdGggPSBiaW5kaW5nUGF0aCArICcuJyB9O1xuICAgIE9iamVjdC5rZXlzKGZvcm1Db250cm9sTWV0YWRhdGFzKS5mb3JFYWNoKChuYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgIGNvbnN0IGZvcm1Db250cm9sTWV0YWRhdGEgPSBmb3JtQ29udHJvbE1ldGFkYXRhc1tuYW1lXSBhcyBGb3JtQ29udHJvbE1ldGFkYXRhO1xuICAgICAgbGV0IHZhbGlkUnVsZXMgPSBudWxsO1xuICAgICAgaWYgKGZvcm1Db250cm9sTWV0YWRhdGEudmFsaWRSdWxlcykge1xuICAgICAgICB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLnB1c2gobmFtZSk7XG4gICAgICAgIHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbFBhdGhNYXAuc2V0KGJpbmRpbmdQYXRoICsgZm9ybUNvbnRyb2xNZXRhZGF0YS5iaW5kaW5nUGF0aCwgbmFtZSk7XG4gICAgICAgIHZhbGlkUnVsZXMgPSBmb3JtQ29udHJvbE1ldGFkYXRhLnZhbGlkUnVsZXM7XG4gICAgICB9XG4gICAgICBjb25zdCBrZXkgPSAoJy8nK2JpbmRpbmdQYXRoK2Zvcm1Db250cm9sTWV0YWRhdGEuYmluZGluZ1BhdGgpLnJlcGxhY2UoL1xcLi9nLCAnLycpXG4gICAgICBpZih2YWxpZGF0aW9uTWFuYWdlcltrZXldKXtcbiAgICAgICAgaWYoIXZhbGlkUnVsZXMpe1xuICAgICAgICAgIHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMucHVzaChuYW1lKTtcbiAgICAgICAgICB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwLnNldChiaW5kaW5nUGF0aCArIGZvcm1Db250cm9sTWV0YWRhdGEuYmluZGluZ1BhdGgsIG5hbWUpO1xuICAgICAgICAgIHZhbGlkUnVsZXMgPSBPYmplY3QudmFsdWVzKHZhbGlkYXRpb25NYW5hZ2VyW2tleV0pO1xuICAgICAgICB9ZWxzZXtcbiAgICAgICAgICB2YWxpZFJ1bGVzID0gdmFsaWRSdWxlcy5jb25jYXQoT2JqZWN0LnZhbHVlcyh2YWxpZGF0aW9uTWFuYWdlcltrZXldKSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc3QgZm9ybUNvbnRyb2xDb25maWc6IEZvcm1Db250cm9sQ29uZmlnID0ge1xuICAgICAgICBuYW1lOiBuYW1lLFxuICAgICAgICBiaW5kaW5nVHlwZTogZm9ybUNvbnRyb2xNZXRhZGF0YS5iaW5kaW5nVHlwZSxcbiAgICAgICAgYmluZGluZ1BhdGg6IGZvcm1Db250cm9sTWV0YWRhdGEuYmluZGluZ1BhdGgsXG4gICAgICAgIHZhbHVlQ29udmVydGVyOiBmb3JtQ29udHJvbE1ldGFkYXRhLnZhbHVlQ29udmVydGVyLFxuICAgICAgICB2YWx1ZUNoYW5naW5nOiBmb3JtQ29udHJvbE1ldGFkYXRhLnZhbHVlQ2hhbmdpbmcsXG4gICAgICAgIHZhbHVlQ2hhbmdlZDogZm9ybUNvbnRyb2xNZXRhZGF0YS52YWx1ZUNoYW5nZWQsXG4gICAgICAgIHZhbGlkUnVsZXM6IHZhbGlkUnVsZXNcbiAgICAgIH07XG4gICAgICB0aGlzLmZvcm1Db250cm9sQ29uZmlncy5wdXNoKGZvcm1Db250cm9sQ29uZmlnKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRFbnRpdHlWYWx1ZUNoYW5naW5nTGlzdGVuZXJzKCk6IHsgW3Byb3BlcnR5OiBzdHJpbmddOiBzdHJpbmcgfSB7XG4gICAgY29uc3QgbGlzdGVuZXJzID0ge307XG4gICAgdGhpcy5mb3JtQ29udHJvbENvbmZpZ3MuZm9yRWFjaCgoZm9ybUNvbnRyb2w6IEZvcm1Db250cm9sQ29uZmlnKSA9PiB7XG4gICAgICBpZiAoZm9ybUNvbnRyb2wudmFsdWVDaGFuZ2luZykge1xuICAgICAgICBsaXN0ZW5lcnNbZm9ybUNvbnRyb2wuYmluZGluZ1BhdGhdID0gZm9ybUNvbnRyb2wudmFsdWVDaGFuZ2luZztcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gbGlzdGVuZXJzO1xuICB9XG5cbiAgcHVibGljIGdldEVudGl0eVZhbHVlQ2hhbmdlZExpc3RlbmVycygpOiB7IFtwcm9wZXJ0eTogc3RyaW5nXTogc3RyaW5nIH0ge1xuICAgIGNvbnN0IGxpc3RlbmVycyA9IHt9O1xuICAgIHRoaXMuZm9ybUNvbnRyb2xDb25maWdzLmZvckVhY2goKGZvcm1Db250cm9sOiBGb3JtQ29udHJvbENvbmZpZykgPT4ge1xuICAgICAgaWYgKGZvcm1Db250cm9sLnZhbHVlQ2hhbmdlZCkge1xuICAgICAgICBsaXN0ZW5lcnNbZm9ybUNvbnRyb2wuYmluZGluZ1BhdGhdID0gZm9ybUNvbnRyb2wudmFsdWVDaGFuZ2VkO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBsaXN0ZW5lcnM7XG4gIH1cbn1cblxuZXhwb3J0IHsgRm9ybSB9O1xuIl19