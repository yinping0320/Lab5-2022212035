import { of } from "rxjs";
import { NoCodeRenderStateUtil } from "./render_state_util";
/**
 * 根据流程页面状态扩展
 * 控制逻辑：
 * 1.根据【流程页面状态】控制隐藏页首和页尾（隐藏按钮）（有点问题，驳回时）
 * 2.流程页面状态为ViewOnly时，按钮隐藏（包含普通按钮、按钮组内按钮、列表滑动工具栏、卡片动作按钮栏）,其他的控件设置为只读或者禁用。
 */
var ProcessUiControlStateInterceptor = /** @class */ (function () {
    function ProcessUiControlStateInterceptor() {
        this.canIntercept = true;
    }
    /**
     * 初始化
     */
    ProcessUiControlStateInterceptor.prototype.init = function (initContext) {
        var processContext = initContext.processContext;
        var isInWf = processContext.isInWf;
        if (!isInWf) {
            this.canIntercept = false;
            return of(true);
        }
        var uiStateInProcess = processContext.uiStateInProcess;
        if (!isInWf) {
            // 制单状态：单据不是在流程中心打开：允许修改
            this.renderStates = NoCodeRenderStateUtil.getRenderStatesWhenDrafting();
        }
        else if (uiStateInProcess === 'BackEdit') {
            // 退回修改：我的代办中打开驳回的表单
            this.renderStates = NoCodeRenderStateUtil.getRenderStatesWhenBackEdit();
        }
        else if (uiStateInProcess === 'Redrafting') {
            // 重新制单：我的发起撤回，并且尚未重新提交
            this.renderStates = NoCodeRenderStateUtil.getRenderStatesWhenReDrafting();
        }
        else if (uiStateInProcess === "Approving") {
            //1、审批中，待办任务（除待阅、重新提交）
            //2、默认未只读态，最终以流程节点上的配置为准
            this.renderStates = NoCodeRenderStateUtil.getRenderStatesWhenApproving();
        }
        else if (uiStateInProcess === "ViewOnly") {
            this.renderStates = NoCodeRenderStateUtil.getRenderStatesWhenViewOnly();
        }
        else {
            this.renderStates = NoCodeRenderStateUtil.getRenderStatesWhenViewOnly();
        }
        return of(true);
    };
    /**
     * 拦截
     * 根据页面状态，隐藏页头和页尾。如果为ViewOnly，把按钮和输入控件设置为只读
     * @param interceptContext
     */
    ProcessUiControlStateInterceptor.prototype.intercept = function (interceptContext) {
        if (!this.canIntercept) {
            return;
        }
        switch (interceptContext.type) {
            case 'visible': {
                this.visibleStateIntercept(interceptContext);
                break;
            }
            case 'readonly': {
                this.readonlyStateIntercept(interceptContext);
                break;
            }
            case 'disabled': {
                this.disabledStateIntercept(interceptContext);
                break;
            }
            case 'hideDeleteBtn':
            case 'hideUploadBtn': {
                this.attachmentBtnStateIntercept(interceptContext);
                break;
            }
        }
    };
    /**
     * 隐藏头部、尾部、审批日志
     * @param interceptContext
     */
    ProcessUiControlStateInterceptor.prototype.visibleStateIntercept = function (interceptContext) {
        var controlInfo = interceptContext.controlState.controlInfo;
        var viewModelContext = interceptContext.viewModelContext;
        var bindingPath = viewModelContext.viewModel.bindingPath;
        if (this.renderStates.showHeader === false) {
            if ((!bindingPath || bindingPath === '/') && controlInfo.type === 'NavigationBar') {
                interceptContext.value = false;
            }
        }
        if (this.renderStates.showFooter === false) {
            if ((!bindingPath || bindingPath === '/') && controlInfo.isInFooter && controlInfo.type === 'Button') {
                interceptContext.value = false;
            }
        }
        if (this.renderStates.showChildHeader === false) {
            if ((bindingPath && bindingPath !== '/') && controlInfo.type === 'NavigationBar') {
                interceptContext.value = false;
            }
        }
        if (this.renderStates.showChildFooter === false) {
            if ((bindingPath && bindingPath !== '/') && controlInfo.isInFooter && controlInfo.type === 'Button') {
                interceptContext.value = false;
            }
        }
        var processContext = interceptContext.processContext;
        if (processContext.uiStateInProcess === "ViewOnly") {
            if (controlInfo.type === 'Button') {
                interceptContext.value = false;
            }
        }
    };
    /**
     * 设置为只读
     * @param interceptContext
     * @returns
     */
    ProcessUiControlStateInterceptor.prototype.readonlyStateIntercept = function (interceptContext) {
        var processContext = interceptContext.processContext;
        var controlInfo = interceptContext.controlState.controlInfo;
        if (processContext.uiStateInProcess === "ViewOnly" && controlInfo.type !== 'Button') {
            interceptContext.value = true;
        }
    };
    /**
     * 设置为禁用
     * @param interceptContext
     * @returns
     */
    ProcessUiControlStateInterceptor.prototype.disabledStateIntercept = function (interceptContext) {
        var processContext = interceptContext.processContext;
        var controlInfo = interceptContext.controlState.controlInfo;
        if (processContext.uiStateInProcess === "ViewOnly" && controlInfo.type !== 'Button') {
            if (!interceptContext.controlState.originalValue.hasOwnProperty('readonly')) {
                interceptContext.value = true;
            }
        }
    };
    /**
     * 附件设置为只读
     * @param interceptContext
     * @returns
     */
    ProcessUiControlStateInterceptor.prototype.attachmentBtnStateIntercept = function (interceptContext) {
        var processContext = interceptContext.processContext;
        if (processContext.uiStateInProcess === "ViewOnly") {
            interceptContext.value = true;
        }
    };
    return ProcessUiControlStateInterceptor;
}());
export { ProcessUiControlStateInterceptor };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzc191aV9zdGF0ZV9pbnRlcmNlcHRvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi91aS1zdGF0ZS9jb250cm9sLXN0YXRlL3Byb2Nlc3NfdWlfc3RhdGVfaW50ZXJjZXB0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUV0QyxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUU1RDs7Ozs7R0FLRztBQUNIO0lBS0k7UUFEUSxpQkFBWSxHQUFXLElBQUksQ0FBQztJQUdwQyxDQUFDO0lBRUQ7O09BRUc7SUFDSSwrQ0FBSSxHQUFYLFVBQVksV0FBdUI7UUFDL0IsSUFBTSxjQUFjLEdBQW1CLFdBQVcsQ0FBQyxjQUFjLENBQUM7UUFDbEUsSUFBTSxNQUFNLEdBQUcsY0FBYyxDQUFDLE1BQU0sQ0FBQztRQUVyQyxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ1QsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7WUFDMUIsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDbkI7UUFFRCxJQUFNLGdCQUFnQixHQUFHLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQztRQUN6RCxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ1Qsd0JBQXdCO1lBQ3hCLElBQUksQ0FBQyxZQUFZLEdBQUcscUJBQXFCLENBQUMsMkJBQTJCLEVBQUUsQ0FBQztTQUMzRTthQUFNLElBQUksZ0JBQWdCLEtBQUssVUFBVSxFQUFFO1lBRXhDLG9CQUFvQjtZQUNwQixJQUFJLENBQUMsWUFBWSxHQUFHLHFCQUFxQixDQUFDLDJCQUEyQixFQUFFLENBQUM7U0FDM0U7YUFBTSxJQUFJLGdCQUFnQixLQUFLLFlBQVksRUFBRTtZQUUxQyx1QkFBdUI7WUFDdkIsSUFBSSxDQUFDLFlBQVksR0FBRyxxQkFBcUIsQ0FBQyw2QkFB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Q0FBQyxjQUFjLENBQUM7UUFDdkUsSUFBRyxjQUFjLENBQUMsZ0JBQWdCLEtBQUssVUFBVSxFQUFDO1lBQzlDLGdCQUFnQixDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7U0FDakM7SUFDTCxDQUFDO0lBRUwsdUNBQUM7QUFBRCxDQUFDLEFBL0pELElBK0pDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tIFwicnhqc1wiO1xyXG5pbXBvcnQgeyBJbnRlcmNlcHRDb250ZXh0LCBDb250cm9sU3RhdGVJbnRlcmNlcHRvciwgSW5pdENvbnRleHQsIFByb2Nlc3NDb250ZXh0IH0gZnJvbSBcIi4vY29udHJvbF9zdGF0ZV9pbnRlcmNlcHRvclwiO1xyXG5pbXBvcnQgeyBOb0NvZGVSZW5kZXJTdGF0ZVV0aWwgfSBmcm9tIFwiLi9yZW5kZXJfc3RhdGVfdXRpbFwiO1xyXG5cclxuLyoqXHJcbiAqIOagueaNrua1geeoi+mhtemdoueKtuaAgeaJqeWxlVxyXG4gKiDmjqfliLbpgLvovpHvvJpcclxuICogMS7moLnmja7jgJDmtYHnqIvpobXpnaLnirbmgIHjgJHmjqfliLbpmpDol4/pobXpppblkozpobXlsL7vvIjpmpDol4/mjInpkq7vvInvvIjmnInngrnpl67popjvvIzpqbPlm57ml7bvvIlcclxuICogMi7mtYHnqIvpobXpnaLnirbmgIHkuLpWaWV3T25seeaXtu+8jOaMiemSrumakOiXj++8iOWMheWQq+aZrumAmuaMiemSruOAgeaMiemSrue7hOWGheaMiemSruOAgeWIl+ihqOa7keWKqOW3peWFt+agj+OAgeWNoeeJh+WKqOS9nOaMiemSruagj++8iSzlhbbku5bnmoTmjqfku7borr7nva7kuLrlj6ror7vmiJbogIXnpoHnlKjjgIJcclxuICovXHJcbmV4cG9ydCBjbGFzcyBQcm9jZXNzVWlDb250cm9sU3RhdGVJbnRlcmNlcHRvciBpbXBsZW1lbnRzIENvbnRyb2xTdGF0ZUludGVyY2VwdG9yIHtcclxuXHJcbiAgICBwcml2YXRlIHJlbmRlclN0YXRlczogYW55O1xyXG5cclxuICAgIHByaXZhdGUgY2FuSW50ZXJjZXB0OmJvb2xlYW4gPSB0cnVlO1xyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yid5aeL5YyWXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBpbml0KGluaXRDb250ZXh0OkluaXRDb250ZXh0KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgICAgICBjb25zdCBwcm9jZXNzQ29udGV4dDogUHJvY2Vzc0NvbnRleHQgPSBpbml0Q29udGV4dC5wcm9jZXNzQ29udGV4dDtcclxuICAgICAgICBjb25zdCBpc0luV2YgPSBwcm9jZXNzQ29udGV4dC5pc0luV2Y7XHJcblxyXG4gICAgICAgIGlmICghaXNJbldmKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2FuSW50ZXJjZXB0ID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHVpU3RhdGVJblByb2Nlc3MgPSBwcm9jZXNzQ29udGV4dC51aVN0YXRlSW5Qcm9jZXNzO1xyXG4gICAgICAgIGlmICghaXNJbldmKSB7XHJcbiAgICAgICAgICAgIC8vIOWItuWNleeKtuaAge+8muWNleaNruS4jeaYr+WcqOa1geeoi+S4reW/g+aJk+W8gO+8muWFgeiuuOS/ruaUuVxyXG4gICAgICAgICAgICB0aGlzLnJlbmRlclN0YXRlcyA9IE5vQ29kZVJlbmRlclN0YXRlVXRpbC5nZXRSZW5kZXJTdGF0ZXNXaGVuRHJhZnRpbmcoKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHVpU3RhdGVJblByb2Nlc3MgPT09ICdCYWNrRWRpdCcpIHtcclxuXHJcbiAgICAgICAgICAgIC8vIOmAgOWbnuS/ruaUue+8muaIkeeahOS7o+WKnuS4reaJk+W8gOmps+WbnueahOihqOWNlVxyXG4gICAgICAgICAgICB0aGlzLnJlbmRlclN0YXRlcyA9IE5vQ29kZVJlbmRlclN0YXRlVXRpbC5nZXRSZW5kZXJTdGF0ZXNXaGVuQmFja0VkaXQoKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHVpU3RhdGVJblByb2Nlc3MgPT09ICdSZWRyYWZ0aW5nJykge1xyXG5cclxuICAgICAgICAgICAgLy8g6YeN5paw5Yi25Y2V77ya5oiR55qE5Y+R6LW35pKk5Zue77yM5bm25LiU5bCa5pyq6YeN5paw5o+Q5LqkXHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyU3RhdGVzID0gTm9Db2RlUmVuZGVyU3RhdGVVdGlsLmdldFJlbmRlclN0YXRlc1doZW5SZURyYWZ0aW5nKCk7XHJcbiAgICAgICAgfWVsc2UgaWYodWlTdGF0ZUluUHJvY2VzcyA9PT0gXCJBcHByb3ZpbmdcIikge1xyXG4gICAgICAgICAgICAvLzHjgIHlrqHmibnkuK3vvIzlvoXlip7ku7vliqHvvIjpmaTlvoXpmIXjgIHph43mlrDmj5DkuqTvvIlcclxuICAgICAgICAgICAgLy8y44CB6buY6K6k5pyq5Y+q6K+75oCB77yM5pyA57uI5Lul5rWB56iL6IqC54K55LiK55qE6YWN572u5Li65YeGXHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyU3RhdGVzID0gTm9Db2RlUmVuZGVyU3RhdGVVdGlsLmdldFJlbmRlclN0YXRlc1doZW5BcHByb3ZpbmcoKTtcclxuICAgICAgICB9ZWxzZSBpZih1aVN0YXRlSW5Qcm9jZXNzID09PSBcIlZpZXdPbmx5XCIgKSB7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnJlbmRlclN0YXRlcyA9IE5vQ29kZVJlbmRlclN0YXRlVXRpbC5nZXRSZW5kZXJTdGF0ZXNXaGVuVmlld09ubHkoKTtcclxuICAgICAgICB9ZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyU3RhdGVzID0gTm9Db2RlUmVuZGVyU3RhdGVVdGlsLmdldFJlbmRlclN0YXRlc1doZW5WaWV3T25seSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG9mKHRydWUpXHJcbiAgICB9XHJcblxyXG4gICBcclxuICAgIC8qKlxyXG4gICAgICog5oum5oiqXHJcbiAgICAgKiDmoLnmja7pobXpnaLnirbmgIHvvIzpmpDol4/pobXlpLTlkozpobXlsL7jgILlpoLmnpzkuLpWaWV3T25see+8jOaKiuaMiemSruWSjOi+k+WFpeaOp+S7tuiuvue9ruS4uuWPquivu1xyXG4gICAgICogQHBhcmFtIGludGVyY2VwdENvbnRleHQgXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBpbnRlcmNlcHQoaW50ZXJjZXB0Q29udGV4dDogSW50ZXJjZXB0Q29udGV4dCk6dm9pZCB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmNhbkludGVyY2VwdCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBzd2l0Y2ggKGludGVyY2VwdENvbnRleHQudHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlICd2aXNpYmxlJzoge1xyXG4gICAgICAgICAgICAgICAgdGhpcy52aXNpYmxlU3RhdGVJbnRlcmNlcHQoaW50ZXJjZXB0Q29udGV4dCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlICdyZWFkb25seSc6IHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVhZG9ubHlTdGF0ZUludGVyY2VwdChpbnRlcmNlcHRDb250ZXh0KTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgJ2Rpc2FibGVkJzoge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kaXNhYmxlZFN0YXRlSW50ZXJjZXB0KGludGVyY2VwdENvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSAnaGlkZURlbGV0ZUJ0bic6IGNhc2UgJ2hpZGVVcGxvYWRCdG4nOntcclxuICAgICAgICAgICAgICAgIHRoaXMuYXR0YWNobWVudEJ0blN0YXRlSW50ZXJjZXB0KGludGVyY2VwdENvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6ZqQ6JeP5aS06YOo44CB5bC+6YOo44CB5a6h5om55pel5b+XXHJcbiAgICAgKiBAcGFyYW0gaW50ZXJjZXB0Q29udGV4dCBcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSB2aXNpYmxlU3RhdGVJbnRlcmNlcHQoaW50ZXJjZXB0Q29udGV4dDogSW50ZXJjZXB0Q29udGV4dCkge1xyXG4gICAgICAgIGNvbnN0IGNvbnRyb2xJbmZvID0gaW50ZXJjZXB0Q29udGV4dC5jb250cm9sU3RhdGUuY29udHJvbEluZm87XHJcbiAgICAgICAgY29uc3Qgdmlld01vZGVsQ29udGV4dCA9IGludGVyY2VwdENvbnRleHQudmlld01vZGVsQ29udGV4dDtcclxuICAgICAgICBjb25zdCBiaW5kaW5nUGF0aCA9IHZpZXdNb2RlbENvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoXHJcblxyXG4gICAgICAgIGlmICh0aGlzLnJlbmRlclN0YXRlcy5zaG93SGVhZGVyID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICBpZiAoKCFiaW5kaW5nUGF0aCB8fCBiaW5kaW5nUGF0aCA9PT0gJy8nKSAmJiAgY29udHJvbEluZm8udHlwZSA9PT0gJ05hdmlnYXRpb25CYXInKSB7XHJcbiAgICAgICAgICAgICAgICBpbnRlcmNlcHRDb250ZXh0LnZhbHVlID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMucmVuZGVyU3RhdGVzLnNob3dGb290ZXIgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgIGlmICgoIWJpbmRpbmdQYXRoIHx8IGJpbmRpbmdQYXRoID09PSAnLycpICYmIGNvbnRyb2xJbmZvLmlzSW5Gb290ZXIgJiYgIGNvbnRyb2xJbmZvLnR5cGUgPT09ICdCdXR0b24nKSB7XHJcbiAgICAgICAgICAgICAgICBpbnRlcmNlcHRDb250ZXh0LnZhbHVlID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnJlbmRlclN0YXRlcy5zaG93Q2hpbGRIZWFkZXIgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgIGlmICgoYmluZGluZ1BhdGggJiYgYmluZGluZ1BhdGggIT09ICcvJykgJiYgIGNvbnRyb2xJbmZvLnR5cGUgPT09ICdOYXZpZ2F0aW9uQmFyJykge1xyXG4gICAgICAgICAgICAgICAgaW50ZXJjZXB0Q29udGV4dC52YWx1ZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5yZW5kZXJTdGF0ZXMuc2hvd0NoaWxkRm9vdGVyID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICBpZiAoKGJpbmRpbmdQYXRoICYmIGJpbmRpbmdQYXRoICE9PSAnLycpICYmIGNvbnRyb2xJbmZvLmlzSW5Gb290ZXIgICYmICBjb250cm9sSW5mby50eXBlID09PSAnQnV0dG9uJykge1xyXG4gICAgICAgICAgICAgICAgaW50ZXJjZXB0Q29udGV4dC52YWx1ZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBwcm9jZXNzQ29udGV4dDogUHJvY2Vzc0NvbnRleHQgPSBpbnRlcmNlcHRDb250ZXh0LnByb2Nlc3NDb250ZXh0O1xyXG4gICAgICAgIGlmKHByb2Nlc3NDb250ZXh0LnVpU3RhdGVJblByb2Nlc3MgPT09IFwiVmlld09ubHlcIil7XHJcbiAgICAgICAgICAgIGlmKGNvbnRyb2xJbmZvLnR5cGUgPT09ICdCdXR0b24nKXtcclxuICAgICAgICAgICAgICAgIGludGVyY2VwdENvbnRleHQudmFsdWUgPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiuvue9ruS4uuWPquivu1xyXG4gICAgICogQHBhcmFtIGludGVyY2VwdENvbnRleHQgXHJcbiAgICAgKiBAcmV0dXJucyBcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSByZWFkb25seVN0YXRlSW50ZXJjZXB0KGludGVyY2VwdENvbnRleHQ6IEludGVyY2VwdENvbnRleHQpIHtcclxuICAgICAgICBjb25zdCBwcm9jZXNzQ29udGV4dDogUHJvY2Vzc0NvbnRleHQgPSBpbnRlcmNlcHRDb250ZXh0LnByb2Nlc3NDb250ZXh0O1xyXG4gICAgICAgIGNvbnN0IGNvbnRyb2xJbmZvID0gaW50ZXJjZXB0Q29udGV4dC5jb250cm9sU3RhdGUuY29udHJvbEluZm87XHJcbiAgICAgICAgaWYocHJvY2Vzc0NvbnRleHQudWlTdGF0ZUluUHJvY2VzcyA9PT0gXCJWaWV3T25seVwiICYmIGNvbnRyb2xJbmZvLnR5cGUgIT09ICdCdXR0b24nKXtcclxuICAgICAgICAgICAgaW50ZXJjZXB0Q29udGV4dC52YWx1ZSA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6K6+572u5Li656aB55SoXHJcbiAgICAgKiBAcGFyYW0gaW50ZXJjZXB0Q29udGV4dCBcclxuICAgICAqIEByZXR1cm5zXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgZGlzYWJsZWRTdGF0ZUludGVyY2VwdChpbnRlcmNlcHRDb250ZXh0OiBJbnRlcmNlcHRDb250ZXh0KSB7XHJcbiAgICAgICAgY29uc3QgcHJvY2Vzc0NvbnRleHQ6IFByb2Nlc3NDb250ZXh0ID0gaW50ZXJjZXB0Q29udGV4dC5wcm9jZXNzQ29udGV4dDtcclxuICAgICAgICBjb25zdCBjb250cm9sSW5mbyA9IGludGVyY2VwdENvbnRleHQuY29udHJvbFN0YXRlLmNvbnRyb2xJbmZvO1xyXG4gICAgICAgIGlmKHByb2Nlc3NDb250ZXh0LnVpU3RhdGVJblByb2Nlc3MgPT09IFwiVmlld09ubHlcIiAmJiBjb250cm9sSW5mby50eXBlICE9PSAnQnV0dG9uJyl7XHJcbiAgICAgICAgICAgIGlmKCFpbnRlcmNlcHRDb250ZXh0LmNvbnRyb2xTdGF0ZS5vcmlnaW5hbFZhbHVlLmhhc093blByb3BlcnR5KCdyZWFkb25seScpKXtcclxuICAgICAgICAgICAgICAgIGludGVyY2VwdENvbnRleHQudmFsdWUgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6ZmE5Lu26K6+572u5Li65Y+q6K+7XHJcbiAgICAgKiBAcGFyYW0gaW50ZXJjZXB0Q29udGV4dCBcclxuICAgICAqIEByZXR1cm5zXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgYXR0YWNobWVudEJ0blN0YXRlSW50ZXJjZXB0KGludGVyY2VwdENvbnRleHQ6IEludGVyY2VwdENvbnRleHQpe1xyXG4gICAgICAgIGNvbnN0IHByb2Nlc3NDb250ZXh0OiBQcm9jZXNzQ29udGV4dCA9IGludGVyY2VwdENvbnRleHQucHJvY2Vzc0NvbnRleHQ7XHJcbiAgICAgICAgaWYocHJvY2Vzc0NvbnRleHQudWlTdGF0ZUluUHJvY2VzcyA9PT0gXCJWaWV3T25seVwiKXtcclxuICAgICAgICAgICAgaW50ZXJjZXB0Q29udGV4dC52YWx1ZSA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxufVxyXG5cclxuIl19