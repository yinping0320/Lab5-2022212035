import * as tslib_1 from "tslib";
import { UIStateMetadataUtil } from "../uistate_metadata_util";
import { ControlStateInterceptorService } from "./control_state_interceptor.service";
import { InterceptContext } from "./control_state_interceptor";
var ControlStateUpdater = /** @class */ (function () {
    function ControlStateUpdater(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.controlStateInterceptorService = viewModelContext.injector.get(ControlStateInterceptorService);
    }
    /**
     * 初始化
     * @returns
     */
    ControlStateUpdater.prototype.init = function () {
        return this.controlStateInterceptorService.init();
    };
    /**
     * 更新【描述控件状态】的变量
     * @param changes 监听到的变化
     */
    ControlStateUpdater.prototype.updateControlState = function (changes) {
        var _this = this;
        //1.获取【描述控件状态】的变量，并缓存
        if (!this.controlFields) {
            var uiState = this.viewModelContext.uiState;
            this.controlFields = UIStateMetadataUtil.getControlFields(uiState.constructor);
            this.variableNames = Object.keys(this.controlFields);
        }
        //2.更新前事件
        if (!this.beforeUpdate(changes)) {
            return;
        }
        //3.遍历变量，进行更新
        this.variableNames.forEach(function (variableName) {
            var fieldMetadata = _this.controlFields[variableName];
            //遍历默认值
            Object.keys(fieldMetadata.originalValue).forEach(function (propertyName) {
                //更新
                _this.update(changes, fieldMetadata, variableName, propertyName);
            });
        });
    };
    /**
     * 更新前事件
     * @param changes
     * @returns
     */
    ControlStateUpdater.prototype.beforeUpdate = function (changes) {
        //1.没有【控件状态变量】，无需更新
        if (!this.variableNames) {
            return false;
        }
        var lintenerType = changes.lintenerType, change = changes.change;
        //2.【控件状态变量】变化时，不做处理。否则会造成循环调用
        if (lintenerType === 'uiState' && this.variableNames.includes(change.field)) {
            return false;
        }
        return true;
    };
    /**
     * 更新
     * @param changes 监听到的变化
     * @param fieldMetadata 变量的元数据
     * @param variableName 变量名
     * @param propertyName 控件的属性名
     * @returns
     */
    ControlStateUpdater.prototype.update = function (changes, fieldMetadata, variableName, propertyName) {
        var _a;
        var propertyValue = fieldMetadata.originalValue[propertyName];
        //1.是否需要更新
        if (!this.needUpdate(propertyValue, changes)) {
            return;
        }
        //2.计算原始值
        var value = this.computeOriginalValue(propertyValue);
        //3.拦截器处理
        var interceptContext = new InterceptContext();
        interceptContext.controlState = fieldMetadata;
        interceptContext.value = value;
        interceptContext.type = propertyName;
        interceptContext.viewModelContext = this.viewModelContext;
        if (this.controlStateInterceptorService) {
            this.controlStateInterceptorService.intercept(interceptContext);
        }
        //4.更新状态
        var uiState = this.viewModelContext.uiState;
        if (!uiState[variableName]) {
            uiState[variableName] = {};
        }
        uiState[variableName] = tslib_1.__assign({}, uiState[variableName], (_a = {}, _a[propertyName] = interceptContext.value, _a));
        //5.更新后事件
        this.afterUpdate(propertyName, interceptContext);
    };
    /**
     * 是否需要新
     * @param originalValue
     * @returns
     */
    ControlStateUpdater.prototype.needUpdate = function (originalValue, changes) {
        var type = originalValue.type, value = originalValue.value;
        var lintenerType = changes.lintenerType, change = changes.change;
        //1.第一次更新全部
        if (lintenerType === 'firstUpdate') {
            return true;
        }
        //2.固定值类型：只在第一次更新，后续不需要更新
        if (type === 'constant') {
            return false;
        }
        //3.value为空，也是固定值,也不需要更新
        if (!value) {
            return false;
        }
        //4.表达式类型：监听到表达式变化，直接更新表达式变量
        if (type === 'expression' && lintenerType === 'expression') {
            return true;
        }
        //5.根据监听到变化的类型判断
        switch (lintenerType) {
            case 'bindingData': {
                if (change && change.path && change.path.length > 0) {
                    if (value.includes(change.path[0])) {
                        return true;
                    }
                    else {
                        return false;
                    }
                }
                break;
            }
            case 'uiState': {
                if (change && change.field) {
                    if (value.includes(change.field)) {
                        return true;
                    }
                    else {
                        return false;
                    }
                }
                break;
            }
            case 'stateMachine': {
                if (value.includes('stateMachine')) {
                    return true;
                }
                else {
                    return false;
                }
                break;
            }
            case 'form': {
                if (value.includes('form')) {
                    return true;
                }
                else {
                    return false;
                }
                break;
            }
        }
        return true;
    };
    /**
     * 计算变量的值
     * @param originalValue
     * @returns
     */
    ControlStateUpdater.prototype.computeOriginalValue = function (originalValue) {
        var value = originalValue.value;
        var type = originalValue.type;
        if (value && typeof value === 'string' && type !== 'constant') {
            var context = {
                bindingData: this.viewModelContext.bindingData.list.currentItem.toJSON(),
                entityListData: this.viewModelContext.bindingData.getList().toJSON(),
                currentEntityData: this.viewModelContext.bindingData.getObject().toJSON(),
                uiState: this.viewModelContext.uiState,
                form: this.viewModelContext.viewModel.form,
                stateMachine: this.viewModelContext.stateMachine.renderStates,
            };
            return this.eval(value, context);
        }
        return value;
    };
    /**
     * 计算
     * @param expr 变量
     * @param contexts 上下文
     * @returns
     */
    ControlStateUpdater.prototype.eval = function (expr, contexts) {
        expr = "return " + expr;
        var scopeNames = Object.getOwnPropertyNames(contexts);
        var scopeVariable = "__scope__" + new Date().valueOf();
        return new Function(scopeVariable, "\n          " + scopeNames.map(function (key) { return "var " + key + " = " + scopeVariable + "['" + key + "'];"; }).join('\r\n') + "\n          return function () {\n            try{  \n" + expr + "\n }catch(e){console.error(e);}\n          };")(contexts)();
    };
    /**
     * 更新变量后，需要进行的操作
     * @param propertyName
     * @param interceptContext
     */
    ControlStateUpdater.prototype.afterUpdate = function (propertyName, interceptContext) {
        //1.必填处理
        if (propertyName === 'required') {
            this.updateRequired(interceptContext);
        }
    };
    /**
     * 更新必填状态
     * @param fieldMetadata
     * @param interceptContext
     * @returns
     */
    ControlStateUpdater.prototype.updateRequired = function (interceptContext) {
        var bindingPath = interceptContext.controlState.controlInfo.bindingPath;
        if (!bindingPath) {
            return;
        }
        var form = this.viewModelContext.form;
        var formControl = form.getFormValueByBindPath(bindingPath);
        var form_name = formControl.form_name;
        if (!form_name || Object.keys(form_name).length === 0) {
            return;
        }
        var validators = [{ "type": "required", "constraints": [true], message: '必填' }];
        if (interceptContext.value === true) {
            form.addValidate(formControl.bindingPath, formControl.name);
            form_name.pushValidatorFnforRequired(validators, true);
            form_name.required = true;
        }
        else if (interceptContext.value === false) {
            if (form_name.getValidatorFn() && form_name.getValidatorFn().length >= 1) {
                form_name.required = false;
                //去除必填
                form_name.resetValidatorFnforRequired();
                if (form_name.validationResult && form_name.validationResult.type === 'required') {
                    form_name.validationResult = { passing: true, message: '' };
                }
            }
        }
    };
    return ControlStateUpdater;
}());
export { ControlStateUpdater };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbF9zdGF0ZV91cGRhdGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3VpLXN0YXRlL2NvbnRyb2wtc3RhdGUvY29udHJvbF9zdGF0ZV91cGRhdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFHQSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUdyRixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUUvRDtJQWVJLDZCQUFZLGdCQUFrQztRQUMxQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUM7UUFDekMsSUFBSSxDQUFDLDhCQUE4QixHQUFHLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsOEJBQThCLENBQUMsQ0FBQztJQUN4RyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ksa0NBQUksR0FBWDtRQUNJLE9BQU8sSUFBSSxDQUFDLDhCQUE4QixDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3RELENBQUM7SUFFRDs7O09BR0c7SUFDSSxnREFBa0IsR0FBekIsVUFBMEIsT0FBZ0M7UUFBMUQsaUJBdUJDO1FBdEJHLHFCQUFxQjtRQUNyQixJQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBQztZQUNuQixJQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDO1lBQzlDLElBQUksQ0FBQyxhQUFhLEdBQUcsbUJBQW1CLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQy9FLElBQUksQ0FBQyxhQUFhLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUE7U0FDdkQ7UUFFRCxTQUFTO1FBQ1QsSUFBRyxDQUFDLElBQUksQ0FBQyxZQUFZ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Q1I7UUFFRCxJQUFNLFVBQVUsR0FBRyxDQUFDLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxhQUFhLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUcsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNuRixJQUFJLGdCQUFnQixDQUFDLEtBQUssS0FBSyxJQUFJLEVBQUU7WUFDbkMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM1RCxTQUFTLENBQUMsMEJBQTBCLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFBO1lBQ3RELFNBQVMsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1NBQzNCO2FBQU0sSUFBSSxnQkFBZ0IsQ0FBQyxLQUFLLEtBQUssS0FBSyxFQUFFO1lBQzNDLElBQUksU0FBUyxDQUFDLGNBQWMsRUFBRSxJQUFJLFNBQVMsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFO2dCQUN4RSxTQUFTLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQTtnQkFDMUIsTUFBTTtnQkFDTixTQUFTLENBQUMsMkJBQTJCLEVBQUUsQ0FBQztnQkFDeEMsSUFBSSxTQUFTLENBQUMsZ0JBQWdCLElBQUksU0FBUyxDQUFDLGdCQUFnQixDQUFDLElBQUksS0FBSyxVQUFVLEVBQUU7b0JBQ2hGLFNBQVMsQ0FBQyxnQkFBZ0IsR0FBRyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxDQUFDO2lCQUM3RDthQUNGO1NBQ0Y7SUFDTCxDQUFDO0lBRUwsMEJBQUM7QUFBRCxDQUFDLEFBeFJELElBd1JDIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7IFZpZXdNb2RlbENvbnRleHQgfSBmcm9tIFwiLi4vLi4vdmlldy1tb2RlbFwiO1xyXG5pbXBvcnQgeyBDb250cm9sU3RhdGVQcm9wTWV0YWRhdGEgfSBmcm9tIFwiLi4vY29udHJvbF9kZWNvcmF0b3JzXCI7XHJcbmltcG9ydCB7IFVJU3RhdGVNZXRhZGF0YVV0aWwgfSBmcm9tIFwiLi4vdWlzdGF0ZV9tZXRhZGF0YV91dGlsXCI7XHJcbmltcG9ydCB7IENvbnRyb2xTdGF0ZUludGVyY2VwdG9yU2VydmljZSB9IGZyb20gXCIuL2NvbnRyb2xfc3RhdGVfaW50ZXJjZXB0b3Iuc2VydmljZVwiO1xyXG5pbXBvcnQgeyBGb3JtQ29udHJvbCB9IGZyb20gXCIuLi8uLi9mb3JtXCI7XHJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tIFwicnhqc1wiO1xyXG5pbXBvcnQgeyBJbnRlcmNlcHRDb250ZXh0IH0gZnJvbSBcIi4vY29udHJvbF9zdGF0ZV9pbnRlcmNlcHRvclwiO1xyXG5cclxuZXhwb3J0IGNsYXNzIENvbnRyb2xTdGF0ZVVwZGF0ZXIge1xyXG5cclxuICAgIC8v6KeG5Zu+5qih5Z6L5LiK5LiL5paHXHJcbiAgICBwcml2YXRlIHZpZXdNb2RlbENvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQ7XHJcblxyXG4gICAgLy/mi6bmiKrlmajmnI3liqFcclxuICAgIHByaXZhdGUgY29udHJvbFN0YXRlSW50ZXJjZXB0b3JTZXJ2aWNlOiBDb250cm9sU3RhdGVJbnRlcmNlcHRvclNlcnZpY2U7XHJcblxyXG4gICAgLy/mj4/ov7Dmjqfku7bnirbmgIHnmoTlj5jph49cclxuICAgIHByaXZhdGUgY29udHJvbEZpZWxkczoge1twcm9wTmFtZTogc3RyaW5nXTogQ29udHJvbFN0YXRlUHJvcE1ldGFkYXRhfTtcclxuXHJcbiAgICAvL+OAkOaPj+i/sOaOp+S7tueKtuaAgeOAkeeahOWPmOmHj+S/oeaBr1xyXG4gICAgcHJpdmF0ZSB2YXJpYWJsZU5hbWVzOmFueVtdO1xyXG5cclxuXHJcbiAgICBjb25zdHJ1Y3Rvcih2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0KSB7XHJcbiAgICAgICAgdGhpcy52aWV3TW9kZWxDb250ZXh0ID0gdmlld01vZGVsQ29udGV4dDtcclxuICAgICAgICB0aGlzLmNvbnRyb2xTdGF0ZUludGVyY2VwdG9yU2VydmljZSA9IHZpZXdNb2RlbENvbnRleHQuaW5qZWN0b3IuZ2V0KENvbnRyb2xTdGF0ZUludGVyY2VwdG9yU2VydmljZSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDliJ3lp4vljJZcclxuICAgICAqIEByZXR1cm5zIFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgaW5pdCgpOk9ic2VydmFibGU8YW55PntcclxuICAgICAgICByZXR1cm4gdGhpcy5jb250cm9sU3RhdGVJbnRlcmNlcHRvclNlcnZpY2UuaW5pdCgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5pu05paw44CQ5o+P6L+w5o6n5Lu254q25oCB44CR55qE5Y+Y6YePXHJcbiAgICAgKiBAcGFyYW0gY2hhbmdlcyDnm5HlkKzliLDnmoTlj5jljJZcclxuICAgICAqL1xyXG4gICAgcHVibGljIHVwZGF0ZUNvbnRyb2xTdGF0ZShjaGFuZ2VzOnsgbGludGVuZXJUeXBlLCBjaGFuZ2UgfSkge1xyXG4gICAgICAgIC8vMS7ojrflj5bjgJDmj4/ov7Dmjqfku7bnirbmgIHjgJHnmoTlj5jph4/vvIzlubbnvJPlrZhcclxuICAgICAgICBpZighdGhpcy5jb250cm9sRmllbGRzKXtcclxuICAgICAgICAgICAgY29uc3QgdWlTdGF0ZSA9IHRoaXMudmlld01vZGVsQ29udGV4dC51aVN0YXRlO1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xGaWVsZHMgPSBVSVN0YXRlTWV0YWRhdGFVdGlsLmdldENvbnRyb2xGaWVsZHModWlTdGF0ZS5jb25zdHJ1Y3Rvcik7XHJcbiAgICAgICAgICAgIHRoaXMudmFyaWFibGVOYW1lcyA9IE9iamVjdC5rZXlzKHRoaXMuY29udHJvbEZpZWxkcylcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vMi7mm7TmlrDliY3kuovku7ZcclxuICAgICAgICBpZighdGhpcy5iZWZvcmVVcGRhdGUoY2hhbmdlcykpe1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLzMu6YGN5Y6G5Y+Y6YeP77yM6L+b6KGM5pu05pawXHJcbiAgICAgICAgdGhpcy52YXJpYWJsZU5hbWVzLmZvckVhY2godmFyaWFibGVOYW1lID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZmllbGRNZXRhZGF0YSA9IHRoaXMuY29udHJvbEZpZWxkc1t2YXJpYWJsZU5hbWVdIGFzIENvbnRyb2xTdGF0ZVByb3BNZXRhZGF0YTtcclxuICAgICAgICAgICAgLy/pgY3ljobpu5jorqTlgLxcclxuICAgICAgICAgICAgT2JqZWN0LmtleXMoZmllbGRNZXRhZGF0YS5vcmlnaW5hbFZhbHVlKS5mb3JFYWNoKHByb3BlcnR5TmFtZSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvL+abtOaWsFxyXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGUoY2hhbmdlcyxmaWVsZE1ldGFkYXRhLHZhcmlhYmxlTmFtZSxwcm9wZXJ0eU5hbWUpXHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOabtOaWsOWJjeS6i+S7tlxyXG4gICAgICogQHBhcmFtIGNoYW5nZXMgXHJcbiAgICAgKiBAcmV0dXJucyBcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBiZWZvcmVVcGRhdGUoY2hhbmdlczp7IGxpbnRlbmVyVHlwZSwgY2hhbmdlIH0pOmJvb2xlYW57XHJcbiAgICAgICAgLy8xLuayoeacieOAkOaOp+S7tueKtuaAgeWPmOmHj+OAke+8jOaXoOmcgOabtOaWsFxyXG4gICAgICAgIGlmKCF0aGlzLnZhcmlhYmxlTmFtZXMpe1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB7IGxpbnRlbmVyVHlwZSwgY2hhbmdlIH0gPSBjaGFuZ2VzO1xyXG4gICAgICAgIC8vMi7jgJDmjqfku7bnirbmgIHlj5jph4/jgJHlj5jljJbml7bvvIzkuI3lgZrlpITnkIbjgILlkKbliJnkvJrpgKDmiJDlvqrnjq/osIPnlKhcclxuICAgICAgICBpZihsaW50ZW5lclR5cGUgPT09ICd1aVN0YXRlJyAmJiB0aGlzLnZhcmlhYmxlTmFtZXMuaW5jbHVkZXMoY2hhbmdlLmZpZWxkKSl7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5pu05pawXHJcbiAgICAgKiBAcGFyYW0gY2hhbmdlcyDnm5HlkKzliLDnmoTlj5jljJZcclxuICAgICAqIEBwYXJhbSBmaWVsZE1ldGFkYXRhIOWPmOmHj+eahOWFg+aVsOaNrlxyXG4gICAgICogQHBhcmFtIHZhcmlhYmxlTmFtZSDlj5jph4/lkI1cclxuICAgICAqIEBwYXJhbSBwcm9wZXJ0eU5hbWUg5o6n5Lu255qE5bGe5oCn5ZCNXHJcbiAgICAgKiBAcmV0dXJucyBcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSB1cGRhdGUoY2hhbmdlczp7IGxpbnRlbmVyVHlwZSwgY2hhbmdlIH0sZmllbGRNZXRhZGF0YTpDb250cm9sU3RhdGVQcm9wTWV0YWRhdGEsdmFyaWFibGVOYW1lOnN0cmluZyxwcm9wZXJ0eU5hbWU6c3RyaW5nKXtcclxuICAgICAgICBsZXQgcHJvcGVydHlWYWx1ZTp7dHlwZSx2YWx1ZX0gPSBmaWVsZE1ldGFkYXRhLm9yaWdpbmFsVmFsdWVbcHJvcGVydHlOYW1lXTtcclxuXHJcbiAgICAgICAgLy8xLuaYr+WQpumcgOimgeabtOaWsFxyXG4gICAgICAgIGlmKCF0aGlzLm5lZWRVcGRhdGUocHJvcGVydHlWYWx1ZSxjaGFuZ2VzKSl7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vMi7orqHnrpfljp/lp4vlgLxcclxuICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmNvbXB1dGVPcmlnaW5hbFZhbHVlKHByb3BlcnR5VmFsdWUpO1xyXG5cclxuICAgICAgICAvLzMu5oum5oiq5Zmo5aSE55CGXHJcbiAgICAgICAgY29uc3QgaW50ZXJjZXB0Q29udGV4dCA9IG5ldyBJbnRlcmNlcHRDb250ZXh0KCk7XHJcbiAgICAgICAgaW50ZXJjZXB0Q29udGV4dC5jb250cm9sU3RhdGUgPSBmaWVsZE1ldGFkYXRhXHJcbiAgICAgICAgaW50ZXJjZXB0Q29udGV4dC52YWx1ZSA9IHZhbHVlO1xyXG4gICAgICAgIGludGVyY2VwdENvbnRleHQudHlwZSA9IHByb3BlcnR5TmFtZTtcclxuICAgICAgICBpbnRlcmNlcHRDb250ZXh0LnZpZXdNb2RlbENvbnRleHQgPSB0aGlzLnZpZXdNb2RlbENvbnRleHQ7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmNvbnRyb2xTdGF0ZUludGVyY2VwdG9yU2VydmljZSkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xTdGF0ZUludGVyY2VwdG9yU2VydmljZS5pbnRlcmNlcHQoaW50ZXJjZXB0Q29udGV4dCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLzQu5pu05paw54q25oCBXHJcbiAgICAgICAgY29uc3QgdWlTdGF0ZSA9IHRoaXMudmlld01vZGVsQ29udGV4dC51aVN0YXRlO1xyXG4gICAgICAgIGlmICghdWlTdGF0ZVt2YXJpYWJsZU5hbWVdKSB7XHJcbiAgICAgICAgICAgIHVpU3RhdGVbdmFyaWFibGVOYW1lXSA9IHt9O1xyXG4gICAgICAgIH1cclxuICAgICAgICB1aVN0YXRlW3ZhcmlhYmxlTmFtZV0gPSB7IC4uLnVpU3RhdGVbdmFyaWFibGVOYW1lXSwgW3Byb3BlcnR5TmFtZV06IGludGVyY2VwdENvbnRleHQudmFsdWUgfTtcclxuXHJcbiAgICAgICAgLy81LuabtOaWsOWQjuS6i+S7tlxyXG4gICAgICAgIHRoaXMuYWZ0ZXJVcGRhdGUocHJvcGVydHlOYW1lLGludGVyY2VwdENvbnRleHQpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5piv5ZCm6ZyA6KaB5pawXHJcbiAgICAgKiBAcGFyYW0gb3JpZ2luYWxWYWx1ZSBcclxuICAgICAqIEByZXR1cm5zIFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIG5lZWRVcGRhdGUob3JpZ2luYWxWYWx1ZTogeyB0eXBlLCB2YWx1ZTphbnkgfSxjaGFuZ2VzOnsgbGludGVuZXJUeXBlLCBjaGFuZ2UgfSk6Ym9vbGVhbntcclxuICAgICAgICBjb25zdCB7IHR5cGUsIHZhbHVlIH0gPSBvcmlnaW5hbFZhbHVlO1xyXG4gICAgICAgIGNvbnN0IHsgbGludGVuZXJUeXBlLCBjaGFuZ2UgfSA9IGNoYW5nZXM7XHJcblxyXG4gICAgICAgIC8vMS7nrKzkuIDmrKHmm7TmlrDlhajpg6hcclxuICAgICAgICBpZihsaW50ZW5lclR5cGUgPT09ICdmaXJzdFVwZGF0ZScpe1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8yLuWbuuWumuWAvOexu+Wei++8muWPquWcqOesrOS4gOasoeabtOaWsO+8jOWQjue7reS4jemcgOimgeabtOaWsFxyXG4gICAgICAgIGlmKHR5cGUgPT09ICdjb25zdGFudCcpe1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLzMudmFsdWXkuLrnqbrvvIzkuZ/mmK/lm7rlrprlgLws5Lmf5LiN6ZyA6KaB5pu05pawXHJcbiAgICAgICAgaWYoIXZhbHVlKXtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy80LuihqOi+vuW8j+exu+Wei++8muebkeWQrOWIsOihqOi+vuW8j+WPmOWMlu+8jOebtOaOpeabtOaWsOihqOi+vuW8j+WPmOmHj1xyXG4gICAgICAgIGlmKHR5cGUgPT09ICdleHByZXNzaW9uJyAmJiBsaW50ZW5lclR5cGUgPT09ICdleHByZXNzaW9uJyl7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy81LuagueaNruebkeWQrOWIsOWPmOWMlueahOexu+Wei+WIpOaWrVxyXG4gICAgICAgIHN3aXRjaChsaW50ZW5lclR5cGUpe1xyXG4gICAgICAgICAgICBjYXNlICdiaW5kaW5nRGF0YSc6e1xyXG4gICAgICAgICAgICAgICAgaWYoY2hhbmdlICYmIGNoYW5nZS5wYXRoICYmIGNoYW5nZS5wYXRoLmxlbmd0aCA+IDApe1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKHZhbHVlLmluY2x1ZGVzKGNoYW5nZS5wYXRoWzBdKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSAndWlTdGF0ZSc6e1xyXG4gICAgICAgICAgICAgICAgaWYoY2hhbmdlICYmIGNoYW5nZS5maWVsZCl7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYodmFsdWUuaW5jbHVkZXMoY2hhbmdlLmZpZWxkKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGJyZWFrOyAgXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSAnc3RhdGVNYWNoaW5lJzp7XHJcbiAgICAgICAgICAgICAgICBpZih2YWx1ZS5pbmNsdWRlcygnc3RhdGVNYWNoaW5lJykpe1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7ICAgIFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgJ2Zvcm0nOntcclxuICAgICAgICAgICAgICAgIGlmKHZhbHVlLmluY2x1ZGVzKCdmb3JtJykpe1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7ICAgIFxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDorqHnrpflj5jph4/nmoTlgLxcclxuICAgICAqIEBwYXJhbSBvcmlnaW5hbFZhbHVlIFxyXG4gICAgICogQHJldHVybnMgXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgY29tcHV0ZU9yaWdpbmFsVmFsdWUob3JpZ2luYWxWYWx1ZTogeyB0eXBlLCB2YWx1ZSB9KTogYW55IHtcclxuICAgICAgICBsZXQgdmFsdWUgPSBvcmlnaW5hbFZhbHVlLnZhbHVlO1xyXG4gICAgICAgIGNvbnN0IHR5cGUgPSBvcmlnaW5hbFZhbHVlLnR5cGU7XHJcblxyXG4gICAgICAgIGlmKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgJiYgdHlwZSAhPT0nY29uc3RhbnQnKXtcclxuICAgICAgICAgICAgY29uc3QgY29udGV4dCA9IHtcclxuICAgICAgICAgICAgICAgIGJpbmRpbmdEYXRhOnRoaXMudmlld01vZGVsQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJdGVtLnRvSlNPTigpLFxyXG4gICAgICAgICAgICAgICAgZW50aXR5TGlzdERhdGE6dGhpcy52aWV3TW9kZWxDb250ZXh0LmJpbmRpbmdEYXRhLmdldExpc3QoKS50b0pTT04oKSxcclxuICAgICAgICAgICAgICAgIGN1cnJlbnRFbnRpdHlEYXRhOnRoaXMudmlld01vZGVsQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRPYmplY3QoKS50b0pTT04oKSxcclxuICAgICAgICAgICAgICAgIHVpU3RhdGU6dGhpcy52aWV3TW9kZWxDb250ZXh0LnVpU3RhdGUsXHJcbiAgICAgICAgICAgICAgICBmb3JtOnRoaXMudmlld01vZGVsQ29udGV4dC52aWV3TW9kZWwuZm9ybSxcclxuICAgICAgICAgICAgICAgIHN0YXRlTWFjaGluZTp0aGlzLnZpZXdNb2RlbENvbnRleHQuc3RhdGVNYWNoaW5lLnJlbmRlclN0YXRlcyxcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5ldmFsKHZhbHVlLCBjb250ZXh0KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6K6h566XXHJcbiAgICAgKiBAcGFyYW0gZXhwciDlj5jph49cclxuICAgICAqIEBwYXJhbSBjb250ZXh0cyDkuIrkuIvmlodcclxuICAgICAqIEByZXR1cm5zIFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGV2YWwoZXhwcjogc3RyaW5nLCBjb250ZXh0cykge1xyXG4gICAgICAgIGV4cHIgPSBgcmV0dXJuICR7ZXhwcn1gO1xyXG4gICAgICAgIGNvbnN0IHNjb3BlTmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhjb250ZXh0cyk7XHJcbiAgICAgICAgY29uc3Qgc2NvcGVWYXJpYWJsZSA9IGBfX3Njb3BlX18ke25ldyBEYXRlKCkudmFsdWVPZigpfWA7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbihzY29wZVZhcmlhYmxlLCBgXHJcbiAgICAgICAgICAke3Njb3BlTmFtZXMubWFwKChrZXk6IHN0cmluZykgPT4gYHZhciAke2tleX0gPSAke3Njb3BlVmFyaWFibGV9Wycke2tleX0nXTtgKS5qb2luKCdcXHJcXG4nKX1cclxuICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHRyeXsgIFxcbiR7ZXhwcn1cXG4gfWNhdGNoKGUpe2NvbnNvbGUuZXJyb3IoZSk7fVxyXG4gICAgICAgICAgfTtgKShjb250ZXh0cykoKTtcclxuICAgICAgfVxyXG5cclxuXHJcbiAgICAvKipcclxuICAgICAqIOabtOaWsOWPmOmHj+WQju+8jOmcgOimgei/m+ihjOeahOaTjeS9nFxyXG4gICAgICogQHBhcmFtIHByb3BlcnR5TmFtZSBcclxuICAgICAqIEBwYXJhbSBpbnRlcmNlcHRDb250ZXh0IFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGFmdGVyVXBkYXRlKHByb3BlcnR5TmFtZSxpbnRlcmNlcHRDb250ZXh0OkludGVyY2VwdENvbnRleHQpe1xyXG4gICAgICAgIC8vMS7lv4XloavlpITnkIZcclxuICAgICAgICBpZihwcm9wZXJ0eU5hbWUgPT09ICdyZXF1aXJlZCcpe1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVJlcXVpcmVkKGludGVyY2VwdENvbnRleHQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOabtOaWsOW/heWhq+eKtuaAgVxyXG4gICAgICogQHBhcmFtIGZpZWxkTWV0YWRhdGEgXHJcbiAgICAgKiBAcGFyYW0gaW50ZXJjZXB0Q29udGV4dCBcclxuICAgICAqIEByZXR1cm5zIFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHVwZGF0ZVJlcXVpcmVkKGludGVyY2VwdENvbnRleHQ6SW50ZXJjZXB0Q29udGV4dCl7XHJcbiAgICAgICAgY29uc3QgYmluZGluZ1BhdGggPSBpbnRlcmNlcHRDb250ZXh0LmNvbnRyb2xTdGF0ZS5jb250cm9sSW5mby5iaW5kaW5nUGF0aDtcclxuICAgICAgICBpZighYmluZGluZ1BhdGgpe1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGZvcm0gPSB0aGlzLnZpZXdNb2RlbENvbnRleHQuZm9ybTtcclxuICAgICAgICBjb25zdCBmb3JtQ29udHJvbCA9IGZvcm0uZ2V0Rm9ybVZhbHVlQnlCaW5kUGF0aChiaW5kaW5nUGF0aCk7XHJcbiAgICAgICAgbGV0IGZvcm1fbmFtZSA9IGZvcm1Db250cm9sLmZvcm1fbmFtZSBhcyBGb3JtQ29udHJvbDtcclxuICAgICAgICBpZiAoIWZvcm1fbmFtZSB8fCBPYmplY3Qua2V5cyhmb3JtX25hbWUpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBjb25zdCB2YWxpZGF0b3JzID0gW3sgXCJ0eXBlXCI6IFwicmVxdWlyZWRcIiwgXCJjb25zdHJhaW50c1wiOiBbdHJ1ZV0sIG1lc3NhZ2U6ICAn5b+F5aGrJyB9XTtcclxuICAgICAgICBpZiAoaW50ZXJjZXB0Q29udGV4dC52YWx1ZSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgZm9ybS5hZGRWYWxpZGF0ZShmb3JtQ29udHJvbC5iaW5kaW5nUGF0aCwgZm9ybUNvbnRyb2wubmFtZSk7XHJcbiAgICAgICAgICBmb3JtX25hbWUucHVzaFZhbGlkYXRvckZuZm9yUmVxdWlyZWQodmFsaWRhdG9ycywgdHJ1ZSlcclxuICAgICAgICAgIGZvcm1fbmFtZS5yZXF1aXJlZCA9IHRydWU7XHJcbiAgICAgICAgfSBlbHNlIGlmIChpbnRlcmNlcHRDb250ZXh0LnZhbHVlID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgaWYgKGZvcm1fbmFtZS5nZXRWYWxpZGF0b3JGbigpICYmIGZvcm1fbmFtZS5nZXRWYWxpZGF0b3JGbigpLmxlbmd0aCA+PSAxKSB7XHJcbiAgICAgICAgICAgIGZvcm1fbmFtZS5yZXF1aXJlZCA9IGZhbHNlXHJcbiAgICAgICAgICAgIC8v5Y676Zmk5b+F5aGrXHJcbiAgICAgICAgICAgIGZvcm1fbmFtZS5yZXNldFZhbGlkYXRvckZuZm9yUmVxdWlyZWQoKTtcclxuICAgICAgICAgICAgaWYgKGZvcm1fbmFtZS52YWxpZGF0aW9uUmVzdWx0ICYmIGZvcm1fbmFtZS52YWxpZGF0aW9uUmVzdWx0LnR5cGUgPT09ICdyZXF1aXJlZCcpIHtcclxuICAgICAgICAgICAgICBmb3JtX25hbWUudmFsaWRhdGlvblJlc3VsdCA9IHsgcGFzc2luZzogdHJ1ZSwgbWVzc2FnZTogJycgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbn0iXX0=