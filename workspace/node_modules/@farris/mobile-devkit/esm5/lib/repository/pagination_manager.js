import { FieldMetadataUtil } from '../entity/index';
// tslint:disable: no-bitwise
var PaginationManager = /** @class */ (function () {
    function PaginationManager(entityType, paginationConfig) {
        this.entityType = entityType;
        this.paginationConfig = paginationConfig;
        if (this.paginationConfig === null || this.paginationConfig === undefined) {
            this.paginationConfig = this.getNgListProperties();
        }
        // 兼容老表单，将之前的主表分页信息展开到分页配置根中
        this.expandMainEntityConfig();
        this.deleteMainEntityConfig();
    }
    /**
     * 主表分页信息展开到分页配置根中
     */
    PaginationManager.prototype.expandMainEntityConfig = function () {
        var entityName = this.entityType.name;
        if (this.paginationConfig.hasOwnProperty(entityName)) {
            var entityConfig = this.paginationConfig[entityName];
            this.paginationConfig = Object.assign(this.paginationConfig, entityConfig);
        }
    };
    /**
     * 删除主表实体配置信息
     */
    PaginationManager.prototype.deleteMainEntityConfig = function () {
        delete this.paginationConfig[this.entityType.name];
    };
    Object.defineProperty(PaginationManager.prototype, "pagination", {
        /**
         * 获取分页信息
         */
        get: function () {
            return this.paginationConfig;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 获取分页信息
     * @param path 路径
     * @param defaultValue 默认值
     */
    PaginationManager.prototype.getPaginationConfigByPath = function (path, defaultValue) {
        if (!path || path === '/') {
            return this.paginationConfig;
        }
        if (typeof path !== 'string') {
            throw new Error('路径必须为字符串！');
        }
        path = path.substring(1);
        var paths = path.split('/').filter(function (item) { return !!item && item.trim().length > 0; });
        var config = this.paginationConfig;
        paths.forEach(function (item) {
            if (config && config.hasOwnProperty(item)) {
                config = config[item];
            }
            else {
                config = null;
            }
        });
        return !!config ? config : typeof defaultValue !== 'undefined' ? defaultValue : undefined;
    };
    /**
     * 设置分页信息
     * @param path 路径
     * @param value 值
     */
    PaginationManager.prototype.setPaginationConfigByPath = function (path, value) {
        if (!Array.isArray(path)) {
            path = path.toString().match(/[^/[\]]+/g) || [];
        }
        path.slice(0, -1).reduce(function (prev, current, index) {
            return Object(prev[current]) === prev[current]
                ? prev[current]
                : prev[current] = Math.abs(path[index + 1]) >> 0 === +path[index + 1]
                    ? []
                    : {};
        }, this.paginationConfig)[path[path.length - 1]] = value;
        return this.paginationConfig;
    };
    /**
     * 递归获取当前实体的所有NgList属性
     * @param defaultPageSize defaultPageSize
     */
    PaginationManager.prototype.getNgListProperties = function (defaultPageSize) {
        if (defaultPageSize === void 0) { defaultPageSize = 0; }
        var getChilds = function (objectType) {
            var listProperties = FieldMetadataUtil.getNgList(objectType);
            var result = {};
            if (Object.keys(listProperties).length < 1) {
                return result;
            }
            Object.keys(listProperties).forEach(function (prop) {
                var itemTypeName = listProperties[prop].dataField;
                // 去掉尾部的s
                if (itemTypeName.endsWith('s')) {
                    itemTypeName = itemTypeName.substring(0, itemTypeName.length - 1);
                }
                result[itemTypeName] = {
                    pageSize: defaultPageSize
                };
                var child = getChilds(listProperties[prop].type);
                if (child !== null && Object.keys(child).length > 0) {
                    result = Object.assign({}, result, child);
                }
            });
            return result;
        };
        var childs = getChilds(this.entityType);
        var root = Object.assign({}, { pageSize: defaultPageSize }, childs);
        return root;
    };
    return PaginationManager;
}());
export { PaginationManager };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnaW5hdGlvbl9tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3JlcG9zaXRvcnkvcGFnaW5hdGlvbl9tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBVSxpQkFBaUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzVELDZCQUE2QjtBQUU3QjtJQUVJLDJCQUFvQixVQUFtQixFQUFVLGdCQUFxQjtRQUFsRCxlQUFVLEdBQVYsVUFBVSxDQUFTO1FBQVUscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFLO1FBQ2xFLElBQUksSUFBSSxDQUFDLGdCQUFnQixLQUFLLElBQUksSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEtBQUssU0FBUyxFQUFFO1lBQ3ZFLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztTQUN0RDtRQUNELDRCQUE0QjtRQUM1QixJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztRQUM5QixJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztJQUNsQyxDQUFDO0lBQ0Q7O09BRUc7SUFDSyxrREFBc0IsR0FBOUI7UUFDSSxJQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQztRQUN4QyxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDbEQsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3ZELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxZQUFZLENBQUMsQ0FBQztTQUM5RTtJQUNMLENBQUM7SUFDRDs7T0FFRztJQUNLLGtEQUFzQixHQUE5QjtRQUNJLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUlELHNCQUFXLHlDQUFVO1FBSHJCOztXQUVHO2FBQ0g7WUFDSSxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztRQUNqQyxDQUFDOzs7T0FBQTtJQUNEOzs7O09BSUc7SUFDSSxxREFBeUIsR0FBaEMsVUFBaUMsSUFBWSxFQUFFLFlBQWtCO1FBQzdELElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxLQUFLLEdBQUcsRUFBRTtZQUN2QixPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztTQUNoQztRQUNELElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxFQUFFO1lBQzFCLE1BQU0sSUFBSSxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDaEM7UUFDRCxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6QixJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQWhDLENBQWdDLENBQUMsQ0FBQztRQUMvRSxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7UUFDbkMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFBLElBQUk7WUFDZCxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUN2QyxNQUFNLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3pCO2lCQUFNO2dCQUNILE1BQU0sR0FBRyxJQUFJLENBQUM7YUFDakI7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxPQUFPLFlBQVksS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBQzlGLENBQUM7SUFDRDs7OztPQUlHO0lBQ0kscURBQXlCLEdBQWhDLFVBQWlDLElBQXlCLEVBQUUsS0FBVTtRQUNsRSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUN0QixJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDbkQ7UUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsS0FBSztZQUMxQyxPQUFBLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUNuQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztnQkFDZixDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDO29CQUNqRSxDQUFDLENBQUMsRUFBRTtvQkFDSixDQUFDLENBQUMsRUFBRTtRQUpaLENBSVksRUFDWixJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUMxRCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztJQUNqQyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssK0NBQW1CLEdBQTNCLFVBQTRCLGVBQTJCO1FBQTNCLGdDQUFBLEVBQUEsbUJBQTJCO1FBRW5ELElBQU0sU0FBUyxHQUFHLFVBQUMsVUFBd0I7WUFDdkMsSUFBTSxjQUFjLEdBQUcsaUJBQWlCLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQy9ELElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQztZQUNoQixJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDeEMsT0FBTyxNQUFNLENBQUM7YUFDakI7WUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFBLElBQUk7Z0JBQ3BDLElBQUksWUFBWSxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFTLENBQUM7Z0JBQ2xELFNBQVM7Z0JBQ1QsSUFBSSxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFO29CQUM1QixZQUFZLEdBQUcsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztpQkFDckU7Z0JBQ0QsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHO29CQUNuQixRQUFRLEVBQUUsZUFBZTtpQkFDNUIsQ0FBQztnQkFDRixJQUFNLEtBQUssR0FBRyxTQUFTLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNuRCxJQUFJLEtBQUssS0FBSyxJQUFJLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO29CQUNqRCxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO2lCQUM3QztZQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxNQUFNLENBQUM7UUFDbEIsQ0FBQyxDQUFDO1FBQ0YsSUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUMxQyxJQUFNLElBQUksR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxlQUFlLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUN0RSxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUwsd0JBQUM7QUFBRCxDQUFDLEFBN0dELElBNkdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVHlwZSAgfSBmcm9tICcuLi9jb3JlL2luZGV4JztcbmltcG9ydCB7IEVudGl0eSwgRmllbGRNZXRhZGF0YVV0aWwgfSBmcm9tICcuLi9lbnRpdHkvaW5kZXgnO1xuLy8gdHNsaW50OmRpc2FibGU6IG5vLWJpdHdpc2VcblxuZXhwb3J0IGNsYXNzIFBhZ2luYXRpb25NYW5hZ2VyPFQgZXh0ZW5kcyBFbnRpdHk+IHtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgZW50aXR5VHlwZTogVHlwZTxUPiwgcHJpdmF0ZSBwYWdpbmF0aW9uQ29uZmlnOiBhbnkpIHtcbiAgICAgICAgaWYgKHRoaXMucGFnaW5hdGlvbkNvbmZpZyA9PT0gbnVsbCB8fCB0aGlzLnBhZ2luYXRpb25Db25maWcgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5wYWdpbmF0aW9uQ29uZmlnID0gdGhpcy5nZXROZ0xpc3RQcm9wZXJ0aWVzKCk7XG4gICAgICAgIH1cbiAgICAgICAgLy8g5YW85a656ICB6KGo5Y2V77yM5bCG5LmL5YmN55qE5Li76KGo5YiG6aG15L+h5oGv5bGV5byA5Yiw5YiG6aG16YWN572u5qC55LitXG4gICAgICAgIHRoaXMuZXhwYW5kTWFpbkVudGl0eUNvbmZpZygpO1xuICAgICAgICB0aGlzLmRlbGV0ZU1haW5FbnRpdHlDb25maWcoKTtcbiAgICB9XG4gICAgLyoqXG4gICAgICog5Li76KGo5YiG6aG15L+h5oGv5bGV5byA5Yiw5YiG6aG16YWN572u5qC55LitXG4gICAgICovXG4gICAgcHJpdmF0ZSBleHBhbmRNYWluRW50aXR5Q29uZmlnKCkge1xuICAgICAgICBjb25zdCBlbnRpdHlOYW1lID0gdGhpcy5lbnRpdHlUeXBlLm5hbWU7XG4gICAgICAgIGlmICh0aGlzLnBhZ2luYXRpb25Db25maWcuaGFzT3duUHJvcGVydHkoZW50aXR5TmFtZSkpIHtcbiAgICAgICAgICAgIGNvbnN0IGVudGl0eUNvbmZpZyA9IHRoaXMucGFnaW5hdGlvbkNvbmZpZ1tlbnRpdHlOYW1lXTtcbiAgICAgICAgICAgIHRoaXMucGFnaW5hdGlvbkNvbmZpZyA9IE9iamVjdC5hc3NpZ24odGhpcy5wYWdpbmF0aW9uQ29uZmlnLCBlbnRpdHlDb25maWcpO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8qKlxuICAgICAqIOWIoOmZpOS4u+ihqOWunuS9k+mFjee9ruS/oeaBr1xuICAgICAqL1xuICAgIHByaXZhdGUgZGVsZXRlTWFpbkVudGl0eUNvbmZpZygpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMucGFnaW5hdGlvbkNvbmZpZ1t0aGlzLmVudGl0eVR5cGUubmFtZV07XG4gICAgfVxuICAgIC8qKlxuICAgICAqIOiOt+WPluWIhumhteS/oeaBr1xuICAgICAqL1xuICAgIHB1YmxpYyBnZXQgcGFnaW5hdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGFnaW5hdGlvbkNvbmZpZztcbiAgICB9XG4gICAgLyoqXG4gICAgICog6I635Y+W5YiG6aG15L+h5oGvXG4gICAgICogQHBhcmFtIHBhdGgg6Lev5b6EXG4gICAgICogQHBhcmFtIGRlZmF1bHRWYWx1ZSDpu5jorqTlgLxcbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0UGFnaW5hdGlvbkNvbmZpZ0J5UGF0aChwYXRoOiBzdHJpbmcsIGRlZmF1bHRWYWx1ZT86IGFueSkge1xuICAgICAgICBpZiAoIXBhdGggfHwgcGF0aCA9PT0gJy8nKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wYWdpbmF0aW9uQ29uZmlnO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlb2YgcGF0aCAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcign6Lev5b6E5b+F6aG75Li65a2X56ym5Liy77yBJyk7XG4gICAgICAgIH1cbiAgICAgICAgcGF0aCA9IHBhdGguc3Vic3RyaW5nKDEpO1xuICAgICAgICBjb25zdCBwYXRocyA9IHBhdGguc3BsaXQoJy8nKS5maWx0ZXIoaXRlbSA9PiAhIWl0ZW0gJiYgaXRlbS50cmltKCkubGVuZ3RoID4gMCk7XG4gICAgICAgIGxldCBjb25maWcgPSB0aGlzLnBhZ2luYXRpb25Db25maWc7XG4gICAgICAgIHBhdGhzLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgICAgICBpZiAoY29uZmlnICYmIGNvbmZpZy5oYXNPd25Qcm9wZXJ0eShpdGVtKSkge1xuICAgICAgICAgICAgICAgIGNvbmZpZyA9IGNvbmZpZ1tpdGVtXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uZmlnID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiAhIWNvbmZpZyA/IGNvbmZpZyA6IHR5cGVvZiBkZWZhdWx0VmFsdWUgIT09ICd1bmRlZmluZWQnID8gZGVmYXVsdFZhbHVlIDogdW5kZWZpbmVkO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiDorr7nva7liIbpobXkv6Hmga9cbiAgICAgKiBAcGFyYW0gcGF0aCDot6/lvoRcbiAgICAgKiBAcGFyYW0gdmFsdWUg5YC8XG4gICAgICovXG4gICAgcHVibGljIHNldFBhZ2luYXRpb25Db25maWdCeVBhdGgocGF0aDogc3RyaW5nIHwgQXJyYXk8YW55PiwgdmFsdWU6IGFueSkge1xuICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocGF0aCkpIHtcbiAgICAgICAgICAgIHBhdGggPSBwYXRoLnRvU3RyaW5nKCkubWF0Y2goL1teL1tcXF1dKy9nKSB8fCBbXTtcbiAgICAgICAgfVxuICAgICAgICBwYXRoLnNsaWNlKDAsIC0xKS5yZWR1Y2UoKHByZXYsIGN1cnJlbnQsIGluZGV4KSA9PlxuICAgICAgICAgICAgT2JqZWN0KHByZXZbY3VycmVudF0pID09PSBwcmV2W2N1cnJlbnRdXG4gICAgICAgICAgICAgICAgPyBwcmV2W2N1cnJlbnRdXG4gICAgICAgICAgICAgICAgOiBwcmV2W2N1cnJlbnRdID0gTWF0aC5hYnMocGF0aFtpbmRleCArIDFdKSA+PiAwID09PSArcGF0aFtpbmRleCArIDFdXG4gICAgICAgICAgICAgICAgICAgID8gW11cbiAgICAgICAgICAgICAgICAgICAgOiB7fSxcbiAgICAgICAgICAgIHRoaXMucGFnaW5hdGlvbkNvbmZpZylbcGF0aFtwYXRoLmxlbmd0aCAtIDFdXSA9IHZhbHVlO1xuICAgICAgICByZXR1cm4gdGhpcy5wYWdpbmF0aW9uQ29uZmlnO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOmAkuW9kuiOt+WPluW9k+WJjeWunuS9k+eahOaJgOaciU5nTGlzdOWxnuaAp1xuICAgICAqIEBwYXJhbSBkZWZhdWx0UGFnZVNpemUgZGVmYXVsdFBhZ2VTaXplXG4gICAgICovXG4gICAgcHJpdmF0ZSBnZXROZ0xpc3RQcm9wZXJ0aWVzKGRlZmF1bHRQYWdlU2l6ZTogbnVtYmVyID0gMCkge1xuXG4gICAgICAgIGNvbnN0IGdldENoaWxkcyA9IChvYmplY3RUeXBlOiBUeXBlPEVudGl0eT4pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGxpc3RQcm9wZXJ0aWVzID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdMaXN0KG9iamVjdFR5cGUpO1xuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IHt9O1xuICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKGxpc3RQcm9wZXJ0aWVzKS5sZW5ndGggPCAxKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgT2JqZWN0LmtleXMobGlzdFByb3BlcnRpZXMpLmZvckVhY2gocHJvcCA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGl0ZW1UeXBlTmFtZSA9IGxpc3RQcm9wZXJ0aWVzW3Byb3BdLmRhdGFGaWVsZDtcbiAgICAgICAgICAgICAgICAvLyDljrvmjonlsL7pg6jnmoRzXG4gICAgICAgICAgICAgICAgaWYgKGl0ZW1UeXBlTmFtZS5lbmRzV2l0aCgncycpKSB7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW1UeXBlTmFtZSA9IGl0ZW1UeXBlTmFtZS5zdWJzdHJpbmcoMCwgaXRlbVR5cGVOYW1lLmxlbmd0aCAtIDEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXN1bHRbaXRlbVR5cGVOYW1lXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgcGFnZVNpemU6IGRlZmF1bHRQYWdlU2l6ZVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgY29uc3QgY2hpbGQgPSBnZXRDaGlsZHMobGlzdFByb3BlcnRpZXNbcHJvcF0udHlwZSk7XG4gICAgICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsICYmIE9iamVjdC5rZXlzKGNoaWxkKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IE9iamVjdC5hc3NpZ24oe30sIHJlc3VsdCwgY2hpbGQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgY2hpbGRzID0gZ2V0Q2hpbGRzKHRoaXMuZW50aXR5VHlwZSk7XG4gICAgICAgIGNvbnN0IHJvb3QgPSBPYmplY3QuYXNzaWduKHt9LCB7IHBhZ2VTaXplOiBkZWZhdWx0UGFnZVNpemUgfSwgY2hpbGRzKTtcbiAgICAgICAgcmV0dXJuIHJvb3Q7XG4gICAgfVxuXG59XG4iXX0=