// tslint:disable: max-line-length member-ordering
/**
 * 绑定数据相关定义
 * @author Witt<jiwt@inspur.com>
 * @todo
 * 1、全局的BindingData和局部的BindingData应该拆成两个类，两个类之间是装饰关系；；
 * 2、为了保持兼容，减少改动量，暂时放在一起，待进一步重构。
 */
import { ChangeType } from './changes';
import { BindingList } from './binding_list';
import { BindingListFactory } from './binding_list_factory';
import { PropertyUtil } from './property_util';
import { EntityUtil } from './entity_util';
/**
 * BindingData
 */
var BindingData = /** @class */ (function () {
    function BindingData() {
        this.paginationInfo = null;
    }
    Object.defineProperty(BindingData.prototype, "bindingPath", {
        /**
         * 绑定该路径
         */
        get: function () {
            if (this.viewModelContext && this.viewModelContext.viewModel.bindingPath) {
                return this.viewModelContext.viewModel.bindingPath;
            }
            return '/';
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BindingData.prototype, "pagingInfo", {
        get: function () {
            return this.paginationInfo;
        },
        set: function (pagingInfo) {
            this.paginationInfo = pagingInfo;
            this.firePagingChangeEvent();
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 设置分页信息
     * @param skip 跳过
     * @param take 获取
     * @param bindingPath 路径
     */
    BindingData.prototype.setPagingInfo = function (skip, take, bindingPath) {
        if (bindingPath.length < 1 || bindingPath === '/') {
            this.paginationInfo = Object.assign(this.paginationInfo, { pageSize: take, pageIndex: skip / take + 1 });
        }
        else {
            var pagingInfo_1 = this.paginationInfo || {};
            var bindingPaths = bindingPath.substr(1).split('/').filter(function (item) { return !!item && item.length > 0; }).map(function (item) { return item.substring(0, item.length - 1); });
            bindingPaths.forEach(function (path) {
                if (!pagingInfo_1.hasOwnProperty(path)) {
                    pagingInfo_1[path] = {};
                }
                pagingInfo_1 = pagingInfo_1[path];
            });
            pagingInfo_1.pageIndex = ((skip / take) || 0) + 1;
            pagingInfo_1.pageSize = take || 0;
        }
        this.firePagingChangeEvent();
    };
    BindingData.prototype.firePagingChangeEvent = function () {
        this.list.changes.next({
            type: ChangeType.PaginationInfoChange,
            path: [],
            value: this.paginationInfo
        });
    };
    Object.defineProperty(BindingData.prototype, "changes", {
        /**
         * 变更集
         */
        get: function () {
            return this.list.changes;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 设置值变化执行器工厂
     * @param value 值变化执行器工厂
     */
    BindingData.prototype.setValueChangeInvokerFactory = function (value) {
        this.valueChangeInvokerFactory = value;
    };
    /**
     * 初始化（已废弃）
     */
    BindingData.prototype.init = function (repository, bindingPath) {
        this.initByRepository(repository, null);
    };
    /**
     * 根据Repository对BindingData进行初始化
     */
    BindingData.prototype.initByRepository = function (repository, viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.properties = PropertyUtil.getProperties(repository.entityType);
        this.list = BindingListFactory.create(this.properties);
        // 从repository初始化bindingData
        this.pagingInfo = repository.entityCollection.paginationInfo;
        // @todo
        // BindingData不应该知道Repository，加载数据、建立关联关系的过程应该转移到外边
        EntityUtil.loadRepository(repository, this.list);
        this.dataTypeInfo = repository.entityTypeInfo;
        this.extendProperties(this.properties);
    };
    /**
     * 初始化
     */
    BindingData.prototype.initByBindingList = function (bindingList, viewModelContext, dataTypeInfo) {
        this.list = bindingList;
        this.viewModelContext = viewModelContext;
        this.dataTypeInfo = dataTypeInfo;
        this.extendProperties(this.list.properties);
    };
    /**
     * 获取paths对应的属性值
     * @param  paths 属性路径数组
     * @returns 属性值
     */
    BindingData.prototype.getValue = function (paths) {
        var target = this.list;
        paths.forEach(function (path) {
            if (target) {
                target = target[path];
            }
        });
        return target;
    };
    /**
     * 根据paths设置属性值
     * @param paths 属性路径数组
     * @param value 属性值
     * @param emitEventToView 如果设置为true，则发送事件通知订阅它的组件、指令去更新界面，默认为false。
     * @param emitEventToEntity 如果设置为true，则同步去更新Entity上对应的字段，默认为true。
     */
    BindingData.prototype.setValue = function (paths, value, emitEventToView, emitEventToEntity) {
        if (emitEventToView === void 0) { emitEventToView = false; }
        if (emitEventToEntity === void 0) { emitEventToEntity = true; }
        if (!paths || paths.length === 0) {
            throw Error('路径不能为空');
        }
        var parentPaths = paths.slice(0, paths.length - 1);
        var propName = paths[paths.length - 1];
        var parent = this.getValue(parentPaths);
        if (!parent) {
            throw Error('找不到要设置的对象');
        }
        if (parent instanceof BindingData) {
            parent = parent.list.currentItem;
        }
        else if (parent instanceof BindingList) {
            parent = parent.currentItem;
        }
        if (!!this.valueChangeInvokerFactory) {
            parent.setValue(propName, value, emitEventToView, emitEventToEntity, null, this.valueChangeInvokerFactory(paths));
        }
        else {
            parent.setValue(propName, value, emitEventToView, emitEventToEntity);
        }
    };
    /**
     * 根据paths清空属性值
     */
    BindingData.prototype.clearValue = function (paths, emitEventToView, emitEventToEntity) {
        if (emitEventToView === void 0) { emitEventToView = false; }
        if (emitEventToEntity === void 0) { emitEventToEntity = true; }
        var initValue;
        var propInfo = this.dataTypeInfo.getPropInfoByPath(paths);
        if (propInfo && propInfo.metadataInfo && propInfo.metadataInfo.initValue !== undefined) {
            initValue = propInfo.metadataInfo.initValue;
        }
        else {
            // 原来的帮助映射中，强行纠正了数值的情况，保持一致
            var oldValue = this.getValue(paths);
            if (typeof oldValue === 'number') {
                initValue = 0;
            }
            else {
                initValue = '';
            }
        }
        this.setValue(paths, initValue, emitEventToView, emitEventToEntity);
    };
    /**
     * 获取当前列表
     */
    BindingData.prototype.getList = function () {
        if (!this.bindingPath || this.bindingPath === '/') {
            return this.list;
        }
        var bindingPath = this.bindingPath.substr(1);
        var bindingPathArray = bindingPath.split('/').filter(function (part) {
            return part !== '';
        });
        return this.getValue(bindingPathArray);
    };
    /**
     * 获取当前对象
     */
    BindingData.prototype.getObject = function () {
        var bindingList = this.getList();
        return bindingList.currentItem;
    };
    /**
     * 绑定路径（仅路径部分，不包括属性）
     * @param bindingPath 绑定路径
     */
    BindingData.prototype.getPath = function (bindingPath) {
        var _this = this;
        var bindingPaths = bindingPath.filter(function (p) { return p; });
        var path = [this.list.primaryKey + ":" + this.list.currentId];
        bindingPaths.forEach(function (item) {
            path.push(item);
            var list = _this[item];
            if (list) {
                path.push(list.primaryKey + ":" + list.currentId);
            }
        });
        return path;
    };
    /**
     * 通过绑定路径获取属性初始值
     * @param paths 绑定路径
     */
    BindingData.prototype.getInitValueByPaths = function (paths) {
        var initValue;
        var propInfo = this.dataTypeInfo && this.dataTypeInfo.getPropInfoByPath(paths) || null;
        if (propInfo && propInfo.metadataInfo && propInfo.metadataInfo.initValue !== undefined) {
            initValue = propInfo.metadataInfo.initValue;
        }
        return initValue;
    };
    /**
     * 扩展BindingData属性，映射BindingData所持有的绑定列表当前行的属性，减少绑定层级。
     * @param properties 关联实体的属性集合
     */
    BindingData.prototype.extendProperties = function (properties) {
        var _this = this;
        properties.forEach(function (property) {
            var propName = property.name;
            Object.defineProperty(_this, propName, {
                get: function () {
                    return _this.list.currentItem[propName];
                },
                set: function (value) {
                    _this.list.currentItem[propName] = value;
                }
            });
        });
    };
    return BindingData;
}());
export { BindingData };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19kYXRhLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2JpbmRpbmctZGF0YS9iaW5kaW5nX2RhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsa0RBQWtEO0FBQ2xEOzs7Ozs7R0FNRztBQU9ILE9BQU8sRUFBVSxVQUFVLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFL0MsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzNDOztHQUVHO0FBRUg7SUFBQTtRQTRCVSxtQkFBYyxHQUFHLElBQUksQ0FBQztJQXdPaEMsQ0FBQztJQXhQQyxzQkFBVyxvQ0FBVztRQUh0Qjs7V0FFRzthQUNIO1lBQ0UsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUU7Z0JBQ3hFLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUM7YUFDcEQ7WUFDRCxPQUFPLEdBQUcsQ0FBQztRQUNiLENBQUM7OztPQUFBO0lBYUQsc0JBQVcsbUNBQVU7YUFLckI7WUFDRSxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUM7UUFDN0IsQ0FBQzthQVBELFVBQXNCLFVBQWU7WUFDbkMsSUFBSSxDQUFDLGNBQWMsR0FBRyxVQUFVLENBQUM7WUFDakMsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFDL0IsQ0FBQzs7O09BQUE7SUFLRDs7Ozs7T0FLRztJQUNJLG1DQUFhLEdBQXBCLFVBQXFCLElBQVksRUFBRSxJQUFZLEVBQUUsV0FBbUI7UUFDbEUsSUFBSSxX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QkFDSCxPQUFPLEtBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUN6QyxDQUFDO2dCQUNELEdBQUcsRUFBRSxVQUFDLEtBQVU7b0JBQ2QsS0FBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLEdBQUcsS0FBSyxDQUFDO2dCQUMxQyxDQUFDO2FBQ0YsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0gsa0JBQUM7QUFBRCxDQUFDLEFBcFFELElBb1FDO0FBRUQsT0FBTyxFQUFFLFdBQVcsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHNsaW50OmRpc2FibGU6IG1heC1saW5lLWxlbmd0aCBtZW1iZXItb3JkZXJpbmdcbi8qKlxuICog57uR5a6a5pWw5o2u55u45YWz5a6a5LmJXG4gKiBAYXV0aG9yIFdpdHQ8aml3dEBpbnNwdXIuY29tPlxuICogQHRvZG9cbiAqIDHjgIHlhajlsYDnmoRCaW5kaW5nRGF0YeWSjOWxgOmDqOeahEJpbmRpbmdEYXRh5bqU6K+l5ouG5oiQ5Lik5Liq57G777yM5Lik5Liq57G75LmL6Ze05piv6KOF6aWw5YWz57O777yb77ybXG4gKiAy44CB5Li65LqG5L+d5oyB5YW85a6577yM5YeP5bCR5pS55Yqo6YeP77yM5pqC5pe25pS+5Zyo5LiA6LW377yM5b6F6L+b5LiA5q2l6YeN5p6E44CCXG4gKi9cblxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBEYXRhVHlwZUluZm8gfSBmcm9tICcuLi9lbnRpdHkvZW50aXR5LXR5cGUtaW5mby9pbmRleCc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAnLi4vcmVwb3NpdG9yeS9pbmRleCc7XG5pbXBvcnQgeyBWaWV3TW9kZWxDb250ZXh0IH0gZnJvbSAnLi4vdmlldy1tb2RlbC9pbmRleCc7XG5pbXBvcnQgeyBDaGFuZ2UsIENoYW5nZVR5cGUgfSBmcm9tICcuL2NoYW5nZXMnO1xuaW1wb3J0IHsgQmluZGluZ1Byb3BlcnR5IH0gZnJvbSAnLi9iaW5kaW5nX3Byb3BlcnR5JztcbmltcG9ydCB7IEJpbmRpbmdMaXN0IH0gZnJvbSAnLi9iaW5kaW5nX2xpc3QnO1xuaW1wb3J0IHsgQmluZGluZ0xpc3RGYWN0b3J5IH0gZnJvbSAnLi9iaW5kaW5nX2xpc3RfZmFjdG9yeSc7XG5pbXBvcnQgeyBQcm9wZXJ0eVV0aWwgfSBmcm9tICcuL3Byb3BlcnR5X3V0aWwnO1xuaW1wb3J0IHsgRW50aXR5VXRpbCB9IGZyb20gJy4vZW50aXR5X3V0aWwnO1xuaW1wb3J0IHsgSW52b2tlT25WYWx1ZUNoYW5nZSB9IGZyb20gJy4vYmluZGluZ19vYmplY3QnO1xuXG4vKipcbiAqIEJpbmRpbmdEYXRhXG4gKi9cblxuY2xhc3MgQmluZGluZ0RhdGEge1xuXG4gIHByaXZhdGUgdmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dDtcblxuICAvKipcbiAgICog5pWw5o2u57G75Z6L5o+P6L+wXG4gICAqL1xuICBwdWJsaWMgZGF0YVR5cGVJbmZvOiBEYXRhVHlwZUluZm87XG5cbiAgLyoqXG4gICAqIOe7keWumuivpei3r+W+hFxuICAgKi9cbiAgcHVibGljIGdldCBiaW5kaW5nUGF0aCgpOiBzdHJpbmcge1xuICAgIGlmICh0aGlzLnZpZXdNb2RlbENvbnRleHQgJiYgdGhpcy52aWV3TW9kZWxDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCkge1xuICAgICAgcmV0dXJuIHRoaXMudmlld01vZGVsQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGg7XG4gICAgfVxuICAgIHJldHVybiAnLyc7XG4gIH1cblxuICAvKipcbiAgICog5Y+v57uR5a6a55qE5bGe5oCn5o+P6L+wXG4gICAqL1xuICBwdWJsaWMgcHJvcGVydGllczogQmluZGluZ1Byb3BlcnR5W107XG5cbiAgLyoqXG4gICAqIOaVsOaNruWIl+ihqFxuICAgKi9cbiAgcHVibGljIGxpc3Q6IEJpbmRpbmdMaXN0O1xuICBwcml2YXRlIHBhZ2luYXRpb25JbmZvID0gbnVsbDtcblxuICBwdWJsaWMgc2V0IHBhZ2luZ0luZm8ocGFnaW5nSW5mbzogYW55KSB7XG4gICAgdGhpcy5wYWdpbmF0aW9uSW5mbyA9IHBhZ2luZ0luZm87XG4gICAgdGhpcy5maXJlUGFnaW5nQ2hhbmdlRXZlbnQoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgcGFnaW5nSW5mbygpIHtcbiAgICByZXR1cm4gdGhpcy5wYWdpbmF0aW9uSW5mbztcbiAgfVxuICAvKipcbiAgICog6K6+572u5YiG6aG15L+h5oGvXG4gICAqIEBwYXJhbSBza2lwIOi3s+i/h1xuICAgKiBAcGFyYW0gdGFrZSDojrflj5ZcbiAgICogQHBhcmFtIGJpbmRpbmdQYXRoIOi3r+W+hFxuICAgKi9cbiAgcHVibGljIHNldFBhZ2luZ0luZm8oc2tpcDogbnVtYmVyLCB0YWtlOiBudW1iZXIsIGJpbmRpbmdQYXRoOiBzdHJpbmcpIHtcbiAgICBpZiAoYmluZGluZ1BhdGgubGVuZ3RoIDwgMSB8fCBiaW5kaW5nUGF0aCA9PT0gJy8nKSB7XG4gICAgICB0aGlzLnBhZ2luYXRpb25JbmZvID0gT2JqZWN0LmFzc2lnbih0aGlzLnBhZ2luYXRpb25JbmZvLCB7IHBhZ2VTaXplOiB0YWtlLCBwYWdlSW5kZXg6IHNraXAgLyB0YWtlICsgMSB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHBhZ2luZ0luZm8gPSB0aGlzLnBhZ2luYXRpb25JbmZvIHx8IHt9O1xuICAgICAgY29uc3QgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGguc3Vic3RyKDEpLnNwbGl0KCcvJykuZmlsdGVyKGl0ZW0gPT4gISFpdGVtICYmIGl0ZW0ubGVuZ3RoID4gMCkubWFwKGl0ZW0gPT4gaXRlbS5zdWJzdHJpbmcoMCwgaXRlbS5sZW5ndGggLSAxKSk7XG4gICAgICBiaW5kaW5nUGF0aHMuZm9yRWFjaChwYXRoID0+IHtcbiAgICAgICAgaWYgKCFwYWdpbmdJbmZvLmhhc093blByb3BlcnR5KHBhdGgpKSB7XG4gICAgICAgICAgcGFnaW5nSW5mb1twYXRoXSA9IHt9O1xuICAgICAgICB9XG4gICAgICAgIHBhZ2luZ0luZm8gPSBwYWdpbmdJbmZvW3BhdGhdO1xuICAgICAgfSk7XG4gICAgICBwYWdpbmdJbmZvLnBhZ2VJbmRleCA9ICgoc2tpcCAvIHRha2UpIHx8IDApICsgMTtcbiAgICAgIHBhZ2luZ0luZm8ucGFnZVNpemUgPSB0YWtlIHx8IDA7XG4gICAgfVxuICAgIHRoaXMuZmlyZVBhZ2luZ0NoYW5nZUV2ZW50KCk7XG4gIH1cbiAgcHJpdmF0ZSBmaXJlUGFnaW5nQ2hhbmdlRXZlbnQoKSB7XG4gICAgdGhpcy5saXN0LmNoYW5nZXMubmV4dCh7XG4gICAgICB0eXBlOiBDaGFuZ2VUeXBlLlBhZ2luYXRpb25JbmZvQ2hhbmdlLFxuICAgICAgcGF0aDogW10sXG4gICAgICB2YWx1ZTogdGhpcy5wYWdpbmF0aW9uSW5mb1xuICAgIH0pO1xuICB9XG4gIC8qKlxuICAgKiDlj5jmm7Tpm4ZcbiAgICovXG4gIHB1YmxpYyBnZXQgY2hhbmdlcygpOiBTdWJqZWN0PENoYW5nZT4ge1xuICAgIHJldHVybiB0aGlzLmxpc3QuY2hhbmdlcztcbiAgfVxuXG4gIC8qKlxuICAgKiDlgLzlj5jljJbmiafooYzlmajlt6XljoLvvIzmoLnmja7ot6/lvoTkuqfnlJ/miafooYzlmahcbiAgICovXG4gIHByaXZhdGUgdmFsdWVDaGFuZ2VJbnZva2VyRmFjdG9yeTogKHBhdGhzOiBzdHJpbmdbXSkgPT4gSW52b2tlT25WYWx1ZUNoYW5nZTtcblxuICAvKipcbiAgICog6K6+572u5YC85Y+Y5YyW5omn6KGM5Zmo5bel5Y6CXG4gICAqIEBwYXJhbSB2YWx1ZSDlgLzlj5jljJbmiafooYzlmajlt6XljoJcbiAgICovXG4gIHB1YmxpYyBzZXRWYWx1ZUNoYW5nZUludm9rZXJGYWN0b3J5KHZhbHVlOiAocGF0aHM6IHN0cmluZ1tdKSA9PiBJbnZva2VPblZhbHVlQ2hhbmdlKSB7XG4gICAgdGhpcy52YWx1ZUNoYW5nZUludm9rZXJGYWN0b3J5ID0gdmFsdWU7XG4gIH1cblxuICAvKipcbiAgICog5Yid5aeL5YyW77yI5bey5bqf5byD77yJXG4gICAqL1xuICBwdWJsaWMgaW5pdChyZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4sIGJpbmRpbmdQYXRoOiBzdHJpbmcpIHtcbiAgICB0aGlzLmluaXRCeVJlcG9zaXRvcnkocmVwb3NpdG9yeSwgbnVsbCk7XG4gIH1cblxuICAvKipcbiAgICog5qC55o2uUmVwb3NpdG9yeeWvuUJpbmRpbmdEYXRh6L+b6KGM5Yid5aeL5YyWXG4gICAqL1xuICBwdWJsaWMgaW5pdEJ5UmVwb3NpdG9yeShyZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4sIHZpZXdNb2RlbENvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQpIHtcbiAgICB0aGlzLnZpZXdNb2RlbENvbnRleHQgPSB2aWV3TW9kZWxDb250ZXh0O1xuXG4gICAgdGhpcy5wcm9wZXJ0aWVzID0gUHJvcGVydHlVdGlsLmdldFByb3BlcnRpZXMocmVwb3NpdG9yeS5lbnRpdHlUeXBlKTtcbiAgICB0aGlzLmxpc3QgPSBCaW5kaW5nTGlzdEZhY3RvcnkuY3JlYXRlKHRoaXMucHJvcGVydGllcyk7XG4gICAgLy8g5LuOcmVwb3NpdG9yeeWIneWni+WMlmJpbmRpbmdEYXRhXG4gICAgdGhpcy5wYWdpbmdJbmZvID0gcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLnBhZ2luYXRpb25JbmZvO1xuXG4gICAgLy8gQHRvZG9cbiAgICAvLyBCaW5kaW5nRGF0YeS4jeW6lOivpeefpemBk1JlcG9zaXRvcnnvvIzliqDovb3mlbDmja7jgIHlu7rnq4vlhbPogZTlhbPns7vnmoTov4fnqIvlupTor6Xovaznp7vliLDlpJbovrlcbiAgICBFbnRpdHlVdGlsLmxvYWRSZXBvc2l0b3J5KHJlcG9zaXRvcnksIHRoaXMubGlzdCk7XG4gICAgdGhpcy5kYXRhVHlwZUluZm8gPSByZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvO1xuXG4gICAgdGhpcy5leHRlbmRQcm9wZXJ0aWVzKHRoaXMucHJvcGVydGllcyk7XG4gIH1cblxuICAvKipcbiAgICog5Yid5aeL5YyWXG4gICAqL1xuICBwdWJsaWMgaW5pdEJ5QmluZGluZ0xpc3QoYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0LCAgdmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dCwgZGF0YVR5cGVJbmZvOiBEYXRhVHlwZUluZm8pIHtcbiAgICB0aGlzLmxpc3QgPSBiaW5kaW5nTGlzdDtcbiAgICB0aGlzLnZpZXdNb2RlbENvbnRleHQgPSB2aWV3TW9kZWxDb250ZXh0O1xuICAgIHRoaXMuZGF0YVR5cGVJbmZvID0gZGF0YVR5cGVJbmZvO1xuICAgIHRoaXMuZXh0ZW5kUHJvcGVydGllcyh0aGlzLmxpc3QucHJvcGVydGllcyk7XG4gIH1cblxuICAvKipcbiAgICog6I635Y+WcGF0aHPlr7nlupTnmoTlsZ7mgKflgLxcbiAgICogQHBhcmFtICBwYXRocyDlsZ7mgKfot6/lvoTmlbDnu4RcbiAgICogQHJldHVybnMg5bGe5oCn5YC8XG4gICAqL1xuICBwdWJsaWMgZ2V0VmFsdWUocGF0aHM6IHN0cmluZ1tdKSB7XG4gICAgbGV0IHRhcmdldDogYW55ID0gdGhpcy5saXN0O1xuICAgIHBhdGhzLmZvckVhY2goKHBhdGg6IHN0cmluZykgPT4ge1xuICAgICAgaWYgKHRhcmdldCkge1xuICAgICAgICB0YXJnZXQgPSB0YXJnZXRbcGF0aF07XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHRhcmdldDtcbiAgfVxuXG4gIC8qKlxuICAgKiDmoLnmja5wYXRoc+iuvue9ruWxnuaAp+WAvFxuICAgKiBAcGFyYW0gcGF0aHMg5bGe5oCn6Lev5b6E5pWw57uEXG4gICAqIEBwYXJhbSB2YWx1ZSDlsZ7mgKflgLxcbiAgICogQHBhcmFtIGVtaXRFdmVudFRvVmlldyDlpoLmnpzorr7nva7kuLp0cnVl77yM5YiZ5Y+R6YCB5LqL5Lu26YCa55+l6K6i6ZiF5a6D55qE57uE5Lu244CB5oyH5Luk5Y675pu05paw55WM6Z2i77yM6buY6K6k5Li6ZmFsc2XjgIJcbiAgICogQHBhcmFtIGVtaXRFdmVudFRvRW50aXR5IOWmguaenOiuvue9ruS4unRydWXvvIzliJnlkIzmraXljrvmm7TmlrBFbnRpdHnkuIrlr7nlupTnmoTlrZfmrrXvvIzpu5jorqTkuLp0cnVl44CCXG4gICAqL1xuICBwdWJsaWMgc2V0VmFsdWUocGF0aHM6IHN0cmluZ1tdLCB2YWx1ZTogYW55LCBlbWl0RXZlbnRUb1ZpZXc6IGJvb2xlYW4gPSBmYWxzZSwgZW1pdEV2ZW50VG9FbnRpdHk6IGJvb2xlYW4gPSB0cnVlKSB7XG5cbiAgICBpZiAoIXBhdGhzIHx8IHBhdGhzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgRXJyb3IoJ+i3r+W+hOS4jeiDveS4uuepuicpO1xuICAgIH1cbiAgICBjb25zdCBwYXJlbnRQYXRocyA9IHBhdGhzLnNsaWNlKDAsIHBhdGhzLmxlbmd0aCAtIDEpO1xuICAgIGNvbnN0IHByb3BOYW1lID0gcGF0aHNbcGF0aHMubGVuZ3RoIC0gMV07XG5cbiAgICBsZXQgcGFyZW50ID0gdGhpcy5nZXRWYWx1ZShwYXJlbnRQYXRocyk7XG4gICAgaWYgKCFwYXJlbnQpIHtcbiAgICAgIHRocm93IEVycm9yKCfmib7kuI3liLDopoHorr7nva7nmoTlr7nosaEnKTtcbiAgICB9XG4gICAgaWYgKHBhcmVudCBpbnN0YW5jZW9mIEJpbmRpbmdEYXRhKSB7XG4gICAgICBwYXJlbnQgPSBwYXJlbnQubGlzdC5jdXJyZW50SXRlbTtcbiAgICB9IGVsc2UgaWYgKHBhcmVudCBpbnN0YW5jZW9mIEJpbmRpbmdMaXN0KSB7XG4gICAgICBwYXJlbnQgPSBwYXJlbnQuY3VycmVudEl0ZW07XG4gICAgfVxuICAgIGlmICghIXRoaXMudmFsdWVDaGFuZ2VJbnZva2VyRmFjdG9yeSkge1xuICAgICAgcGFyZW50LnNldFZhbHVlKHByb3BOYW1lLCB2YWx1ZSwgZW1pdEV2ZW50VG9WaWV3LCBlbWl0RXZlbnRUb0VudGl0eSwgbnVsbCwgdGhpcy52YWx1ZUNoYW5nZUludm9rZXJGYWN0b3J5KHBhdGhzKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmVudC5zZXRWYWx1ZShwcm9wTmFtZSwgdmFsdWUsIGVtaXRFdmVudFRvVmlldywgZW1pdEV2ZW50VG9FbnRpdHkpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDmoLnmja5wYXRoc+a4heepuuWxnuaAp+WAvFxuICAgKi9cbiAgcHVibGljIGNsZWFyVmFsdWUocGF0aHM6IHN0cmluZ1tdLCBlbWl0RXZlbnRUb1ZpZXc6IGJvb2xlYW4gPSBmYWxzZSwgZW1pdEV2ZW50VG9FbnRpdHk6IGJvb2xlYW4gPSB0cnVlKSB7XG4gICAgbGV0IGluaXRWYWx1ZTogYW55O1xuICAgIGNvbnN0IHByb3BJbmZvID0gdGhpcy5kYXRhVHlwZUluZm8uZ2V0UHJvcEluZm9CeVBhdGgocGF0aHMpO1xuICAgIGlmIChwcm9wSW5mbyAmJiBwcm9wSW5mby5tZXRhZGF0YUluZm8gJiYgcHJvcEluZm8ubWV0YWRhdGFJbmZvLmluaXRWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBpbml0VmFsdWUgPSBwcm9wSW5mby5tZXRhZGF0YUluZm8uaW5pdFZhbHVlO1xuICAgIH0gZWxzZSB7XG5cbiAgICAgIC8vIOWOn+adpeeahOW4ruWKqeaYoOWwhOS4re+8jOW8uuihjOe6oOato+S6huaVsOWAvOeahOaDheWGte+8jOS/neaMgeS4gOiHtFxuICAgICAgY29uc3Qgb2xkVmFsdWUgPSB0aGlzLmdldFZhbHVlKHBhdGhzKTtcbiAgICAgIGlmICh0eXBlb2Ygb2xkVmFsdWUgPT09ICdudW1iZXInKSB7XG4gICAgICAgIGluaXRWYWx1ZSA9IDA7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpbml0VmFsdWUgPSAnJztcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5zZXRWYWx1ZShwYXRocywgaW5pdFZhbHVlLCBlbWl0RXZlbnRUb1ZpZXcsIGVtaXRFdmVudFRvRW50aXR5KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5blvZPliY3liJfooahcbiAgICovXG4gIHB1YmxpYyBnZXRMaXN0KCkge1xuXG4gICAgaWYgKCF0aGlzLmJpbmRpbmdQYXRoIHx8IHRoaXMuYmluZGluZ1BhdGggPT09ICcvJykge1xuICAgICAgcmV0dXJuIHRoaXMubGlzdDtcbiAgICB9XG5cbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IHRoaXMuYmluZGluZ1BhdGguc3Vic3RyKDEpO1xuICAgIGNvbnN0IGJpbmRpbmdQYXRoQXJyYXkgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcigocGFydDogc3RyaW5nKSA9PiB7XG4gICAgICByZXR1cm4gcGFydCAhPT0gJyc7XG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXMuZ2V0VmFsdWUoYmluZGluZ1BhdGhBcnJheSk7XG4gIH1cblxuICAvKipcbiAgICog6I635Y+W5b2T5YmN5a+56LGhXG4gICAqL1xuICBwdWJsaWMgZ2V0T2JqZWN0KCkge1xuICAgIGNvbnN0IGJpbmRpbmdMaXN0ID0gdGhpcy5nZXRMaXN0KCk7XG4gICAgcmV0dXJuIGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtO1xuICB9XG4gIC8qKlxuICAgKiDnu5Hlrprot6/lvoTvvIjku4Xot6/lvoTpg6jliIbvvIzkuI3ljIXmi6zlsZ7mgKfvvIlcbiAgICogQHBhcmFtIGJpbmRpbmdQYXRoIOe7keWumui3r+W+hFxuICAgKi9cbiAgcHVibGljIGdldFBhdGgoYmluZGluZ1BhdGg/OiBzdHJpbmdbXSkge1xuICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLmZpbHRlcihwID0+IHApO1xuICAgIGNvbnN0IHBhdGggPSBbYCR7dGhpcy5saXN0LnByaW1hcnlLZXl9OiR7dGhpcy5saXN0LmN1cnJlbnRJZH1gXTtcblxuICAgIGJpbmRpbmdQYXRocy5mb3JFYWNoKChpdGVtOiBzdHJpbmcpID0+IHtcbiAgICAgIHBhdGgucHVzaChpdGVtKTtcbiAgICAgIGNvbnN0IGxpc3QgPSB0aGlzW2l0ZW1dIGFzIEJpbmRpbmdMaXN0O1xuICAgICAgaWYgKGxpc3QpIHtcbiAgICAgICAgcGF0aC5wdXNoKGAke2xpc3QucHJpbWFyeUtleX06JHtsaXN0LmN1cnJlbnRJZH1gKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcGF0aDtcbiAgfVxuICAvKipcbiAgICog6YCa6L+H57uR5a6a6Lev5b6E6I635Y+W5bGe5oCn5Yid5aeL5YC8XG4gICAqIEBwYXJhbSBwYXRocyDnu5Hlrprot6/lvoRcbiAgICovXG4gIHByaXZhdGUgZ2V0SW5pdFZhbHVlQnlQYXRocyhwYXRoczogQXJyYXk8c3RyaW5nPikge1xuICAgIGxldCBpbml0VmFsdWU6IGFueTtcbiAgICBjb25zdCBwcm9wSW5mbyA9IHRoaXMuZGF0YVR5cGVJbmZvICYmIHRoaXMuZGF0YVR5cGVJbmZvLmdldFByb3BJbmZvQnlQYXRoKHBhdGhzKSB8fCBudWxsO1xuICAgIGlmIChwcm9wSW5mbyAmJiBwcm9wSW5mby5tZXRhZGF0YUluZm8gJiYgcHJvcEluZm8ubWV0YWRhdGFJbmZvLmluaXRWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBpbml0VmFsdWUgPSBwcm9wSW5mby5tZXRhZGF0YUluZm8uaW5pdFZhbHVlO1xuICAgIH1cbiAgICByZXR1cm4gaW5pdFZhbHVlO1xuICB9XG4gIC8qKlxuICAgKiDmianlsZVCaW5kaW5nRGF0YeWxnuaAp++8jOaYoOWwhEJpbmRpbmdEYXRh5omA5oyB5pyJ55qE57uR5a6a5YiX6KGo5b2T5YmN6KGM55qE5bGe5oCn77yM5YeP5bCR57uR5a6a5bGC57qn44CCXG4gICAqIEBwYXJhbSBwcm9wZXJ0aWVzIOWFs+iBlOWunuS9k+eahOWxnuaAp+mbhuWQiFxuICAgKi9cbiAgcHJpdmF0ZSBleHRlbmRQcm9wZXJ0aWVzKHByb3BlcnRpZXM6IEJpbmRpbmdQcm9wZXJ0eVtdKSB7XG4gICAgcHJvcGVydGllcy5mb3JFYWNoKChwcm9wZXJ0eTogQmluZGluZ1Byb3BlcnR5KSA9PiB7XG4gICAgICBjb25zdCBwcm9wTmFtZSA9IHByb3BlcnR5Lm5hbWU7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgcHJvcE5hbWUsIHtcbiAgICAgICAgZ2V0OiAoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMubGlzdC5jdXJyZW50SXRlbVtwcm9wTmFtZV07XG4gICAgICAgIH0sXG4gICAgICAgIHNldDogKHZhbHVlOiBhbnkpID0+IHtcbiAgICAgICAgICB0aGlzLmxpc3QuY3VycmVudEl0ZW1bcHJvcE5hbWVdID0gdmFsdWU7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCB7IEJpbmRpbmdEYXRhIH07XG4iXX0=