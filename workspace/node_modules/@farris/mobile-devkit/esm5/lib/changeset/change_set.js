/*
 * @Author: Lucus, Witt
 * @Date: 2018-10-30 15:53:59
 * @Last Modified by: Witt
 * @Last Modified time: 2018-11-08 17:25:08
 */
import { ModifyType } from './types';
function isEqual(value, other) {
    return JSON.stringify(value) === JSON.stringify(other);
}
/**
 * 实体数据变更集
 */
var ChangeSet = /** @class */ (function () {
    function ChangeSet() {
        /**
         * 变更集合
         */
        this.modifications = [];
    }
    Object.defineProperty(ChangeSet.prototype, "changes", {
        /**
         *  获取所有的变更记录
         */
        get: function () {
            return this.modifications;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 将变更集添加到集合中
     * ### 使用示例
     * ```
     * const changeSet = new ChangeSet();
     * const modify = new Modification('newValue', ModifyType.ValueChange, [1, 'title'], 'oldValue');
     * changeSet.append(modify)
     * ```
     * @param changeItem 变更数据
     */
    ChangeSet.prototype.append = function (modification) {
        switch (modification.type) {
            case ModifyType.ValueChange:
                this.appendValueChangeModification(modification);
                break;
            case ModifyType.Add:
            case ModifyType.Insert:
            case ModifyType.Clone:
                this.appendAddModification(modification);
                break;
            case ModifyType.Remove:
                this.appendRemoveModification(modification);
                break;
            case ModifyType.Load:
                break;
            default:
                throw new Error('不支持此类型的变更');
        }
    };
    /**
     * 添加值变化变更
     */
    ChangeSet.prototype.appendValueChangeModification = function (modification) {
        var value = modification.value;
        var existedModification = this.findModifyItemsPath(modification.path);
        if (existedModification) {
            // 如果存在相同路径的ValueChange类型的变更集，则更新值；
            existedModification.value = value;
        }
        else {
            var existedAddModification = this.findNewAddItemsPath(modification.path);
            if (existedAddModification) {
                // @todo：
                // 1、此处逻辑有问题，value是个字符串，不能直接assign；
                // 2、之所以没有出现问题，是因为都是服务器端新增，新增后，客户端清空了所有变更。
                // 如果存在涵盖该ValueChange变更的Add变更，则更新Add变更对应的数据；
                existedAddModification.value = Object.assign({}, existedAddModification.value, value);
            }
            else {
                // 其他情况，新增一条ValueChange变更。
                this.modifications.push(modification);
            }
        }
    };
    /**
     * 添加新增变更
     */
    ChangeSet.prototype.appendAddModification = function (modification) {
        var value = modification.value;
        var existedModification = this.findNewAddItemsPath(modification.path);
        if (existedModification) {
            // 1、如果已经存在相同路径的Add变更，则合并Value。
            existedModification.value = existedModification.value.concat(value);
        }
        else {
            // 2、如果没有，则新增一条Add变更。
            this.modifications.push(modification);
        }
    };
    /**
     * 添加删除变更
     */
    ChangeSet.prototype.appendRemoveModification = function (modification) {
        var path = modification.path;
        var primaryKey = Object.keys(modification.value)[0];
        var primaryKeyValue = modification.value[primaryKey];
        // 1、存在相同path的新增变更，移除新增变更，不需要添加删除变更；
        // @todo：待重构（1、只考虑了主从情况，2、临时用多重循环实现）
        this.modifications.forEach(function (addModification) {
            // 只处理新增变更
            if (addModification.type !== ModifyType.Add && addModification.type !== ModifyType.Insert && addModification.type !== ModifyType.Clone) {
                return;
            }
            // @todo 只考虑主从结构，再深的层次暂不考虑
            if (isEqual(addModification.path, path) === false) {
                return;
            }
            // 遍历新增新增变更的value（value是个数组），移除相匹配的新增删除
            addModification.value = addModification.value.filter(function (addDataItem) {
                return addDataItem[primaryKey] !== primaryKeyValue;
            });
        });
        // 2、移除对应的修改变更
        var fullRemovePath = path.concat(primaryKey + ":" + primaryKeyValue);
        this.modifications = this.modifications.filter(function (valueModification) {
            if (valueModification.type !== ModifyType.ValueChange) {
                return true;
            }
            var valueChangePath = Array.from(valueModification.path);
            valueChangePath.pop();
            // 路径相同进行移除
            var isToRemove = isEqual(valueChangePath, fullRemovePath);
            return !isToRemove;
        });
        // 先删除下级删除变更，再插入
        // 主要针对从从表删除之后，又删除子表时，根实体上还存在从从表删除变更的场景
        this.removeDescendantRemoveModifications(modification);
        this.modifications.push(modification);
    };
    /**
     * 清空变更集合
     */
    ChangeSet.prototype.clear = function () {
        this.modifications = [];
    };
    /**
     * 根据path获取Add类型的变更记录
     * @param path 变更路径
     */
    ChangeSet.prototype.findNewAddItemsPath = function (path) {
        return this.modifications.find(function (value, index) {
            return isEqual(path, value.path) && (value.type === ModifyType.Add || value.type === ModifyType.Insert || value.type === ModifyType.Clone);
        });
    };
    /**
     * 根据path获取ValueChange类型的变更记录
     * @param path 变更路径
     */
    ChangeSet.prototype.findModifyItemsPath = function (path) {
        return this.modifications.find(function (value, index) {
            return isEqual(path, value.path) && value.type === ModifyType.ValueChange;
        });
    };
    /**
     * 删除后代（包括自己）所有的删除变更
     * @todo：临时做一个最小化修改
     */
    ChangeSet.prototype.removeDescendantRemoveModifications = function (parentRemoveModification) {
        var _this = this;
        var parentPathWithId = this.createRemovePathWithId(parentRemoveModification);
        // 删除后代修改变更
        this.modifications = this.modifications.filter(function (modification) {
            if (modification.type !== ModifyType.Remove) {
                return true;
            }
            var descendantPathWithId = _this.createRemovePathWithId(modification);
            var isDescendant = _this.isDescendantPath(parentPathWithId, descendantPathWithId);
            return !isDescendant;
        });
    };
    /**
     * 获取删除路径的完整格式
     * @summary
     * 1、目前删除变更的路径标记到父集合；
     * 2、为了方便比较，将被删除的数据id加入到路径中
     */
    ChangeSet.prototype.createRemovePathWithId = function (modification) {
        var path = modification.path;
        var primaryKey = Object.keys(modification.value)[0];
        var primaryKeyValue = modification.value[primaryKey];
        var pathWithId = path.concat([primaryKey + ":" + primaryKeyValue]);
        return pathWithId;
    };
    /**
     * 判断是否是后代节点路径
     * @param parentPath 父节点路径
     * @param descendantPath 后代节点
     */
    ChangeSet.prototype.isDescendantPath = function (parentPath, descendantPath) {
        if (parentPath.length > descendantPath.length) {
            return false;
        }
        var isDescendantPath = true;
        parentPath.forEach(function (parentPathItem, parentPathItemIndex) {
            if (parentPathItem !== descendantPath[parentPathItemIndex]) {
                isDescendantPath = false;
                return;
            }
        });
        return isDescendantPath;
    };
    return ChangeSet;
}());
export { ChangeSet };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbmdlX3NldC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9jaGFuZ2VzZXQvY2hhbmdlX3NldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7R0FLRztBQUVILE9BQU8sRUFBZ0IsVUFBVSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRW5ELFNBQVMsT0FBTyxDQUFDLEtBQVUsRUFBRSxLQUFVO0lBQ3JDLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsS0FBTSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzFELENBQUM7QUFFRDs7R0FFRztBQUNIO0lBQUE7UUFFRTs7V0FFRztRQUNPLGtCQUFhLEdBQW1CLEVBQUUsQ0FBQztJQXdOL0MsQ0FBQztJQW5OQyxzQkFBVyw4QkFBTztRQUhsQjs7V0FFRzthQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBQzVCLENBQUM7OztPQUFBO0lBRUQ7Ozs7Ozs7OztPQVNHO0lBQ0ksMEJBQU0sR0FBYixVQUFjLFlBQTBCO1FBQ3RDLFFBQVEsWUFBWSxDQUFDLElBQUksRUFBRTtZQUN6QixLQUFLLFVBQVUsQ0FBQyxXQUFXO2dCQUN6QixJQUFJLENBQUMsNkJBQTZCLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBQ2pELE1BQU07WUFDUixLQUFLLFVBQVUsQ0FBQyxHQUFHLENBQUM7WUFDcEIsS0FBSyxVQUFVLENBQUMsTUFBTSxDQUFDO1lBQ3ZCLEtBQUssVUFBVSxDQUFDLEtBQUs7Z0JBQ25CLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxZQUFZLENBQUMsQ0FBQztnQkFDekMsTUFBTTtZQUNSLEtBQUssVUFBVSxDQUFDLE1BQU07Z0JBQ3BCLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxZQUFZLENBQUMsQ0FBQztnQkFDNUMsTUFBTTtZQUNSLEtBQUssVUFBVSxDQUFDLElBQUk7Z0JBQ2xCLE1BQU07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LE1BQU0sQ0FBQyxDQUFJLFVBQVUsU0FBSSxlQUFpQixDQUFDLENBQUMsQ0FBQztRQUNyRSxPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNLLG9DQUFnQixHQUF4QixVQUF5QixVQUFvQixFQUFFLGNBQXdCO1FBQ3JFLElBQUksVUFBVSxDQUFDLE1BQU0sR0FBRyxjQUFjLENBQUMsTUFBTSxFQUFFO1lBQzdDLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFFRCxJQUFJLGdCQUFnQixHQUFHLElBQUksQ0FBQztRQUM1QixVQUFVLENBQUMsT0FBTyxDQUFDLFVBQUMsY0FBc0IsRUFBRSxtQkFBMkI7WUFDckUsSUFBSSxjQUFjLEtBQUssY0FBYyxDQUFDLG1CQUFtQixDQUFDLEVBQUU7Z0JBQzFELGdCQUFnQixHQUFHLEtBQUssQ0FBQztnQkFDekIsT0FBTzthQUNSO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLGdCQUFnQixDQUFDO0lBQzFCLENBQUM7SUFFSCxnQkFBQztBQUFELENBQUMsQUE3TkQsSUE2TkM7QUFFRCxPQUFPLEVBQUUsU0FBUyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQEF1dGhvcjogTHVjdXMsIFdpdHRcbiAqIEBEYXRlOiAyMDE4LTEwLTMwIDE1OjUzOjU5XG4gKiBATGFzdCBNb2RpZmllZCBieTogV2l0dFxuICogQExhc3QgTW9kaWZpZWQgdGltZTogMjAxOC0xMS0wOCAxNzoyNTowOFxuICovXG5cbmltcG9ydCB7IE1vZGlmaWNhdGlvbiwgTW9kaWZ5VHlwZSB9IGZyb20gJy4vdHlwZXMnO1xuXG5mdW5jdGlvbiBpc0VxdWFsKHZhbHVlOiBhbnksIG90aGVyOiBhbnkpIHtcbiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHZhbHVlKSA9PT0gIEpTT04uc3RyaW5naWZ5KG90aGVyKTtcbn1cblxuLyoqXG4gKiDlrp7kvZPmlbDmja7lj5jmm7Tpm4ZcbiAqL1xuY2xhc3MgQ2hhbmdlU2V0IHtcblxuICAvKipcbiAgICog5Y+Y5pu06ZuG5ZCIXG4gICAqL1xuICBwcm90ZWN0ZWQgbW9kaWZpY2F0aW9uczogTW9kaWZpY2F0aW9uW10gPSBbXTtcblxuICAvKipcbiAgICogIOiOt+WPluaJgOacieeahOWPmOabtOiusOW9lVxuICAgKi9cbiAgcHVibGljIGdldCBjaGFuZ2VzKCk6IE1vZGlmaWNhdGlvbltdIHtcbiAgICByZXR1cm4gdGhpcy5tb2RpZmljYXRpb25zO1xuICB9XG5cbiAgLyoqXG4gICAqIOWwhuWPmOabtOmbhua3u+WKoOWIsOmbhuWQiOS4rVxuICAgKiAjIyMg5L2/55So56S65L6LXG4gICAqIGBgYFxuICAgKiBjb25zdCBjaGFuZ2VTZXQgPSBuZXcgQ2hhbmdlU2V0KCk7XG4gICAqIGNvbnN0IG1vZGlmeSA9IG5ldyBNb2RpZmljYXRpb24oJ25ld1ZhbHVlJywgTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZSwgWzEsICd0aXRsZSddLCAnb2xkVmFsdWUnKTtcbiAgICogY2hhbmdlU2V0LmFwcGVuZChtb2RpZnkpXG4gICAqIGBgYFxuICAgKiBAcGFyYW0gY2hhbmdlSXRlbSDlj5jmm7TmlbDmja5cbiAgICovXG4gIHB1YmxpYyBhcHBlbmQobW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pIHtcbiAgICBzd2l0Y2ggKG1vZGlmaWNhdGlvbi50eXBlKSB7XG4gICAgICBjYXNlIE1vZGlmeVR5cGUuVmFsdWVDaGFuZ2U6XG4gICAgICAgIHRoaXMuYXBwZW5kVmFsdWVDaGFuZ2VNb2RpZmljYXRpb24obW9kaWZpY2F0aW9uKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIE1vZGlmeVR5cGUuQWRkOlxuICAgICAgY2FzZSBNb2RpZnlUeXBlLkluc2VydDpcbiAgICAgIGNhc2UgTW9kaWZ5VHlwZS5DbG9uZTpcbiAgICAgICAgdGhpcy5hcHBlbmRBZGRNb2RpZmljYXRpb24obW9kaWZpY2F0aW9uKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIE1vZGlmeVR5cGUuUmVtb3ZlOlxuICAgICAgICB0aGlzLmFwcGVuZFJlbW92ZU1vZGlmaWNhdGlvbihtb2RpZmljYXRpb24pO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgTW9kaWZ5VHlwZS5Mb2FkOlxuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IG5ldyBFcnJvcign5LiN5pSv5oyB5q2k57G75Z6L55qE5Y+Y5pu0Jyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOa3u+WKoOWAvOWPmOWMluWPmOabtFxuICAgKi9cbiAgcHJpdmF0ZSBhcHBlbmRWYWx1ZUNoYW5nZU1vZGlmaWNhdGlvbihtb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbikge1xuICAgIGNvbnN0IHZhbHVlID0gbW9kaWZpY2F0aW9uLnZhbHVlO1xuXG4gICAgY29uc3QgZXhpc3RlZE1vZGlmaWNhdGlvbiA9IHRoaXMuZmluZE1vZGlmeUl0ZW1zUGF0aChtb2RpZmljYXRpb24ucGF0aCk7XG4gICAgaWYgKGV4aXN0ZWRNb2RpZmljYXRpb24pIHtcblxuICAgICAgLy8g5aaC5p6c5a2Y5Zyo55u45ZCM6Lev5b6E55qEVmFsdWVDaGFuZ2XnsbvlnovnmoTlj5jmm7Tpm4bvvIzliJnmm7TmlrDlgLzvvJtcbiAgICAgIGV4aXN0ZWRNb2RpZmljYXRpb24udmFsdWUgPSB2YWx1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZXhpc3RlZEFkZE1vZGlmaWNhdGlvbiA9IHRoaXMuZmluZE5ld0FkZEl0ZW1zUGF0aChtb2RpZmljYXRpb24ucGF0aCk7XG4gICAgICBpZiAoZXhpc3RlZEFkZE1vZGlmaWNhdGlvbikge1xuXG4gICAgICAgIC8vIEB0b2Rv77yaXG4gICAgICAgIC8vIDHjgIHmraTlpITpgLvovpHmnInpl67popjvvIx2YWx1ZeaYr+S4quWtl+espuS4su+8jOS4jeiDveebtOaOpWFzc2lnbu+8m1xuICAgICAgICAvLyAy44CB5LmL5omA5Lul5rKh5pyJ5Ye6546w6Zeu6aKY77yM5piv5Zug5Li66YO95piv5pyN5Yqh5Zmo56uv5paw5aKe77yM5paw5aKe5ZCO77yM5a6i5oi356uv5riF56m65LqG5omA5pyJ5Y+Y5pu044CCXG4gICAgICAgIC8vIOWmguaenOWtmOWcqOa2teebluivpVZhbHVlQ2hhbmdl5Y+Y5pu055qEQWRk5Y+Y5pu077yM5YiZ5pu05pawQWRk5Y+Y5pu05a+55bqU55qE5pWw5o2u77ybXG4gICAgICAgIGV4aXN0ZWRBZGRNb2RpZmljYXRpb24udmFsdWUgPSBPYmplY3QuYXNzaWduKHt9LCBleGlzdGVkQWRkTW9kaWZpY2F0aW9uLnZhbHVlLCB2YWx1ZSk7XG4gICAgICB9IGVsc2Uge1xuXG4gICAgICAgIC8vIOWFtuS7luaDheWGte+8jOaWsOWinuS4gOadoVZhbHVlQ2hhbmdl5Y+Y5pu044CCXG4gICAgICAgIHRoaXMubW9kaWZpY2F0aW9ucy5wdXNoKG1vZGlmaWNhdGlvbik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOa3u+WKoOaWsOWinuWPmOabtFxuICAgKi9cbiAgcHJpdmF0ZSBhcHBlbmRBZGRNb2RpZmljYXRpb24obW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pIHtcbiAgICBjb25zdCB2YWx1ZSA9IG1vZGlmaWNhdGlvbi52YWx1ZTtcblxuICAgIGNvbnN0IGV4aXN0ZWRNb2RpZmljYXRpb24gPSB0aGlzLmZpbmROZXdBZGRJdGVtc1BhdGgobW9kaWZpY2F0aW9uLnBhdGgpO1xuICAgIGlmIChleGlzdGVkTW9kaWZpY2F0aW9uKSB7XG5cbiAgICAgIC8vIDHjgIHlpoLmnpzlt7Lnu4/lrZjlnKjnm7jlkIzot6/lvoTnmoRBZGTlj5jmm7TvvIzliJnlkIjlubZWYWx1ZeOAglxuICAgICAgZXhpc3RlZE1vZGlmaWNhdGlvbi52YWx1ZSA9IGV4aXN0ZWRNb2RpZmljYXRpb24udmFsdWUuY29uY2F0KHZhbHVlKTtcbiAgICB9IGVsc2Uge1xuXG4gICAgICAvLyAy44CB5aaC5p6c5rKh5pyJ77yM5YiZ5paw5aKe5LiA5p2hQWRk5Y+Y5pu044CCXG4gICAgICB0aGlzLm1vZGlmaWNhdGlvbnMucHVzaChtb2RpZmljYXRpb24pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDmt7vliqDliKDpmaTlj5jmm7RcbiAgICovXG4gIHByaXZhdGUgYXBwZW5kUmVtb3ZlTW9kaWZpY2F0aW9uKG1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSB7XG5cbiAgICBjb25zdCBwYXRoID0gbW9kaWZpY2F0aW9uLnBhdGg7XG4gICAgY29uc3QgcHJpbWFyeUtleSA9IE9iamVjdC5rZXlzKG1vZGlmaWNhdGlvbi52YWx1ZSlbMF07XG4gICAgY29uc3QgcHJpbWFyeUtleVZhbHVlID0gbW9kaWZpY2F0aW9uLnZhbHVlW3ByaW1hcnlLZXldO1xuXG4gICAgLy8gMeOAgeWtmOWcqOebuOWQjHBhdGjnmoTmlrDlop7lj5jmm7TvvIznp7vpmaTmlrDlop7lj5jmm7TvvIzkuI3pnIDopoHmt7vliqDliKDpmaTlj5jmm7TvvJtcbiAgICAvLyBAdG9kb++8muW+hemHjeaehO+8iDHjgIHlj6rogIPomZHkuobkuLvku47mg4XlhrXvvIwy44CB5Li05pe255So5aSa6YeN5b6q546v5a6e546w77yJXG4gICAgdGhpcy5tb2RpZmljYXRpb25zLmZvckVhY2goKGFkZE1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSA9PiB7XG5cbiAgICAgIC8vIOWPquWkhOeQhuaWsOWinuWPmOabtFxuICAgICAgaWYgKGFkZE1vZGlmaWNhdGlvbi50eXBlICE9PSBNb2RpZnlUeXBlLkFkZCAmJiBhZGRNb2RpZmljYXRpb24udHlwZSAhPT0gTW9kaWZ5VHlwZS5JbnNlcnQgJiYgYWRkTW9kaWZpY2F0aW9uLnR5cGUgIT09IE1vZGlmeVR5cGUuQ2xvbmUpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBAdG9kbyDlj6rogIPomZHkuLvku47nu5PmnoTvvIzlho3mt7HnmoTlsYLmrKHmmoLkuI3ogIPomZFcbiAgICAgIGlmIChpc0VxdWFsKGFkZE1vZGlmaWNhdGlvbi5wYXRoLCBwYXRoKSA9PT0gZmFsc2UpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyDpgY3ljobmlrDlop7mlrDlop7lj5jmm7TnmoR2YWx1Ze+8iHZhbHVl5piv5Liq5pWw57uE77yJ77yM56e76Zmk55u45Yy56YWN55qE5paw5aKe5Yig6ZmkXG4gICAgICBhZGRNb2RpZmljYXRpb24udmFsdWUgPSBhZGRNb2RpZmljYXRpb24udmFsdWUuZmlsdGVyKChhZGREYXRhSXRlbTogYW55KSA9PiB7XG4gICAgICAgIHJldHVybiBhZGREYXRhSXRlbVtwcmltYXJ5S2V5XSAhPT0gcHJpbWFyeUtleVZhbHVlO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAvLyAy44CB56e76Zmk5a+55bqU55qE5L+u5pS55Y+Y5pu0XG4gICAgY29uc3QgZnVsbFJlbW92ZVBhdGggPSBwYXRoLmNvbmNhdChgJHtwcmltYXJ5S2V5fToke3ByaW1hcnlLZXlWYWx1ZX1gKTtcbiAgICB0aGlzLm1vZGlmaWNhdGlvbnMgPSB0aGlzLm1vZGlmaWNhdGlvbnMuZmlsdGVyKCh2YWx1ZU1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSA9PiB7XG4gICAgICBpZiAodmFsdWVNb2RpZmljYXRpb24udHlwZSAhPT0gTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHZhbHVlQ2hhbmdlUGF0aCA9IEFycmF5LmZyb20odmFsdWVNb2RpZmljYXRpb24ucGF0aCk7XG4gICAgICB2YWx1ZUNoYW5nZVBhdGgucG9wKCk7XG5cbiAgICAgIC8vIOi3r+W+hOebuOWQjOi/m+ihjOenu+mZpFxuICAgICAgY29uc3QgaXNUb1JlbW92ZSA9IGlzRXF1YWwodmFsdWVDaGFuZ2VQYXRoLCBmdWxsUmVtb3ZlUGF0aCk7XG4gICAgICByZXR1cm4gIWlzVG9SZW1vdmU7XG4gICAgfSk7XG5cbiAgICAvLyDlhYjliKDpmaTkuIvnuqfliKDpmaTlj5jmm7TvvIzlho3mj5LlhaVcbiAgICAvLyDkuLvopoHpkojlr7nku47ku47ooajliKDpmaTkuYvlkI7vvIzlj4jliKDpmaTlrZDooajml7bvvIzmoLnlrp7kvZPkuIrov5jlrZjlnKjku47ku47ooajliKDpmaTlj5jmm7TnmoTlnLrmma9cbiAgICB0aGlzLnJlbW92ZURlc2NlbmRhbnRSZW1vdmVNb2RpZmljYXRpb25zKG1vZGlmaWNhdGlvbik7XG4gICAgdGhpcy5tb2RpZmljYXRpb25zLnB1c2gobW9kaWZpY2F0aW9uKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmuIXnqbrlj5jmm7Tpm4blkIhcbiAgICovXG4gIHB1YmxpYyBjbGVhcigpIHtcbiAgICB0aGlzLm1vZGlmaWNhdGlvbnMgPSBbXTtcbiAgfVxuXG5cbiAgLyoqXG4gICAqIOagueaNrnBhdGjojrflj5ZBZGTnsbvlnovnmoTlj5jmm7TorrDlvZVcbiAgICogQHBhcmFtIHBhdGgg5Y+Y5pu06Lev5b6EXG4gICAqL1xuICBwcml2YXRlIGZpbmROZXdBZGRJdGVtc1BhdGgocGF0aDogYW55W10pIHtcbiAgICByZXR1cm4gdGhpcy5tb2RpZmljYXRpb25zLmZpbmQoKHZhbHVlLCBpbmRleCkgPT4ge1xuICAgICAgcmV0dXJuIGlzRXF1YWwocGF0aCwgdmFsdWUucGF0aCkgJiYgKHZhbHVlLnR5cGUgPT09IE1vZGlmeVR5cGUuQWRkIHx8IHZhbHVlLnR5cGUgPT09IE1vZGlmeVR5cGUuSW5zZXJ0IHx8IHZhbHVlLnR5cGUgPT09IE1vZGlmeVR5cGUuQ2xvbmUpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIOagueaNrnBhdGjojrflj5ZWYWx1ZUNoYW5nZeexu+Wei+eahOWPmOabtOiusOW9lVxuICAgKiBAcGFyYW0gcGF0aCDlj5jmm7Tot6/lvoRcbiAgICovXG4gIHByaXZhdGUgZmluZE1vZGlmeUl0ZW1zUGF0aChwYXRoOiBhbnlbXSkge1xuICAgIHJldHVybiB0aGlzLm1vZGlmaWNhdGlvbnMuZmluZCgodmFsdWUsIGluZGV4KSA9PiB7XG4gICAgICByZXR1cm4gaXNFcXVhbChwYXRoLCB2YWx1ZS5wYXRoKSAmJiB2YWx1ZS50eXBlID09PSBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIoOmZpOWQjuS7o++8iOWMheaLrOiHquW3se+8ieaJgOacieeahOWIoOmZpOWPmOabtFxuICAgKiBAdG9kb++8muS4tOaXtuWBmuS4gOS4quacgOWwj+WMluS/ruaUuVxuICAgKi9cbiAgcHJpdmF0ZSByZW1vdmVEZXNjZW5kYW50UmVtb3ZlTW9kaWZpY2F0aW9ucyhwYXJlbnRSZW1vdmVNb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbik6IHZvaWQge1xuXG4gICAgY29uc3QgcGFyZW50UGF0aFdpdGhJZCA9IHRoaXMuY3JlYXRlUmVtb3ZlUGF0aFdpdGhJZChwYXJlbnRSZW1vdmVNb2RpZmljYXRpb24pO1xuXG4gICAgLy8g5Yig6Zmk5ZCO5Luj5L+u5pS55Y+Y5pu0XG4gICAgdGhpcy5tb2RpZmljYXRpb25zID0gdGhpcy5tb2RpZmljYXRpb25zLmZpbHRlcigobW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pID0+IHtcbiAgICAgIGlmIChtb2RpZmljYXRpb24udHlwZSAhPT0gTW9kaWZ5VHlwZS5SZW1vdmUpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgICBjb25zdCBkZXNjZW5kYW50UGF0aFdpdGhJZCA9IHRoaXMuY3JlYXRlUmVtb3ZlUGF0aFdpdGhJZChtb2RpZmljYXRpb24pO1xuICAgICAgY29uc3QgaXNEZXNjZW5kYW50ID0gIHRoaXMuaXNEZXNjZW5kYW50UGF0aChwYXJlbnRQYXRoV2l0aElkLCBkZXNjZW5kYW50UGF0aFdpdGhJZCk7XG4gICAgICByZXR1cm4gIWlzRGVzY2VuZGFudDtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5bliKDpmaTot6/lvoTnmoTlrozmlbTmoLzlvI9cbiAgICogQHN1bW1hcnlcbiAgICogMeOAgeebruWJjeWIoOmZpOWPmOabtOeahOi3r+W+hOagh+iusOWIsOeItumbhuWQiO+8m1xuICAgKiAy44CB5Li65LqG5pa55L6/5q+U6L6D77yM5bCG6KKr5Yig6Zmk55qE5pWw5o2uaWTliqDlhaXliLDot6/lvoTkuK1cbiAgICovXG4gIHByaXZhdGUgY3JlYXRlUmVtb3ZlUGF0aFdpdGhJZChtb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbikge1xuICAgIGNvbnN0IHBhdGggPSBtb2RpZmljYXRpb24ucGF0aDtcbiAgICBjb25zdCBwcmltYXJ5S2V5ID0gT2JqZWN0LmtleXMobW9kaWZpY2F0aW9uLnZhbHVlKVswXTtcbiAgICBjb25zdCBwcmltYXJ5S2V5VmFsdWUgPSBtb2RpZmljYXRpb24udmFsdWVbcHJpbWFyeUtleV07XG4gICAgY29uc3QgcGF0aFdpdGhJZCA9IHBhdGguY29uY2F0KFtgJHtwcmltYXJ5S2V5fToke3ByaW1hcnlLZXlWYWx1ZX1gXSk7XG4gICAgcmV0dXJuIHBhdGhXaXRoSWQ7XG4gIH1cblxuICAvKipcbiAgICog5Yik5pat5piv5ZCm5piv5ZCO5Luj6IqC54K56Lev5b6EXG4gICAqIEBwYXJhbSBwYXJlbnRQYXRoIOeItuiKgueCuei3r+W+hFxuICAgKiBAcGFyYW0gZGVzY2VuZGFudFBhdGgg5ZCO5Luj6IqC54K5XG4gICAqL1xuICBwcml2YXRlIGlzRGVzY2VuZGFudFBhdGgocGFyZW50UGF0aDogc3RyaW5nW10sIGRlc2NlbmRhbnRQYXRoOiBzdHJpbmdbXSkge1xuICAgIGlmIChwYXJlbnRQYXRoLmxlbmd0aCA+IGRlc2NlbmRhbnRQYXRoLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGxldCBpc0Rlc2NlbmRhbnRQYXRoID0gdHJ1ZTtcbiAgICBwYXJlbnRQYXRoLmZvckVhY2goKHBhcmVudFBhdGhJdGVtOiBzdHJpbmcsIHBhcmVudFBhdGhJdGVtSW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgaWYgKHBhcmVudFBhdGhJdGVtICE9PSBkZXNjZW5kYW50UGF0aFtwYXJlbnRQYXRoSXRlbUluZGV4XSkge1xuICAgICAgICBpc0Rlc2NlbmRhbnRQYXRoID0gZmFsc2U7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBpc0Rlc2NlbmRhbnRQYXRoO1xuICB9XG5cbn1cblxuZXhwb3J0IHsgQ2hhbmdlU2V0IH07XG5cbiJdfQ==