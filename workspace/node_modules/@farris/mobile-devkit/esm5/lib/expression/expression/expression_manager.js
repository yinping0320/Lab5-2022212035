import * as tslib_1 from "tslib";
import { EMPTY, of } from "rxjs";
import { Repository } from "../../repository/index";
import { MESSAGE_SERVICE_TOKEN, NOTIFY_SERVICE_TOKEN } from "../core/index";
import { ENTITY_TEMPLATE, ResolveService } from "../resolver/index";
import { ExpressionUtil } from "../utils/expression_util";
import { ExpressionExecutor } from "./expression_executor";
import { ExpressionRegistry } from "./expression_registry";
import { Expression } from './types';
import { ExpressionResult } from "./expression_result";
var ExpressionManager = /** @class */ (function () {
    function ExpressionManager(frameContext) {
        this.frameContext = frameContext;
        this.injector = this.frameContext.injector;
        this.resolveService = this.injector.get(ResolveService);
        this.expressionExecutor = this.injector.get(ExpressionExecutor);
        this.expressionRegistry = this.injector.get(ExpressionRegistry);
        this.expressionResult = this.injector.get(ExpressionResult);
        this.messageService = this.injector.get(MESSAGE_SERVICE_TOKEN, null);
        this.notifyService = this.injector.get(NOTIFY_SERVICE_TOKEN, null);
    }
    /**
     * 根据表达式id进行计算
     * @param expressionId 表达式id
     * @param viewModel viewModel
     * @param rowData rowData
     * @returns
     */
    ExpressionManager.prototype.eval = function (expressionId, viewModel, rowData) {
        var expressionObject = this.expressionRegistry.getExpressionById(expressionId);
        if (expressionObject) {
            var customContext = {};
            var bindingPath = viewModel && viewModel.bindingPath || null;
            if (bindingPath && rowData) {
                var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
                var bindingList = this.frameContext.bindingData.getValue(bindingPaths);
                var primaryKey = 'id';
                if (bindingList) {
                    primaryKey = bindingList.primaryKey;
                }
                var primaryValue = rowData[primaryKey];
                if (primaryValue) {
                    customContext.currentRows = [{ bindingPath: bindingPaths.join('/'), primaryValue: primaryValue }];
                }
            }
            var result = this.execute(expressionObject.expression, customContext);
            this.expressionResult.set(expressionId, result);
            return result;
        }
        else {
            // console.warn('ExpressionManager 执行失败，未获取到表达式!');
        }
        return undefined;
    };
    ExpressionManager.prototype.validate = function (expressionId, options) {
        var expressionObject = this.expressionRegistry.getExpressionById(expressionId);
        if (expressionObject) {
            var patch = options && options.patch || null;
            var customContext = {};
            if (patch) {
                customContext.patch = patch;
            }
            var currentRow = options.currentRow || null;
            if (currentRow) {
                customContext.currentRows = customContext.currentRows || [];
                customContext.currentRows.push(currentRow);
            }
            var result = this.execute(expressionObject.expression, customContext);
            this.expressionResult.set(expressionId, result);
            return result;
        }
        else {
            console.warn('ExpressionManager 执行失败，未获取到表达式!');
        }
        return undefined;
    };
    /**
     * 帮助前封装
     * @param event
     */
    ExpressionManager.prototype.onDataPicking = function (configs) {
        var expressionId = configs && configs.expressionId || null;
        if (!expressionId) {
            console.warn("ExpressionManager \u76F8\u5173\u8868\u8FBE\u5F0F\u8BBE\u7F6E\u9519\u8BEF\uFF0C\u6CA1\u6709\u8868\u8FBE\u5F0F\u7F16\u53F7\u3002");
            return of(true);
        }
        var result = this.eval(expressionId);
        if (!result) {
            var expressionObject = this.expressionRegistry.getExpressionById(expressionId);
            if (!expressionObject) {
                console.warn("ExpressionManager \u65E0\u6CD5\u627E\u5230\u5BF9\u5E94\u7684\u8868\u8FBE\u5F0F" + expressionId);
                return of(true);
            }
            var messageType = expressionObject.messageType || Expression.MessageType.warning;
            var message = expressionObject.message;
            if (message) {
                this.notifyService[messageType](message, { hideTitle: true });
            }
            return EMPTY;
        }
        return of(result);
    };
    /**
     * 执行表达式计算
     * @param expression 表达式
     * @param customContext 自定义上下文
     * @returns
     */
    ExpressionManager.prototype.execute = function (expression, customContext) {
        var _a;
        var deps = this.resolveService.resolve(expression);
        var groupDependencies = ExpressionUtil.getGroupFunctionDependency(expression, this.frameContext.repository.entityTypeInfo);
        var entityContext = this.buildEntityContext(deps, groupDependencies, customContext);
        var stateContext = this.buildStateContext();
        var data = customContext && customContext.contexts || null;
        var context = tslib_1.__assign((_a = {}, _a[this.entityOriginalNodeCode] = entityContext, _a), stateContext, { frameContext: this.frameContext, bindingData: this.frameContext.bindingData, repository: this.frameContext.repository }, data);
        if (!entityContext) {
            return undefined;
        }
        return this.expressionExecutor.eval(expression, context);
    };
    /**
     * 执行表达式（返回可观察对象）
     * @param expression 表达式
     * @param customContext 自定义上下文
     * @returns
     */
    ExpressionManager.prototype.executeAsync = function (expression, customContext) {
        var result = this.execute(expression, customContext);
        return of(result);
    };
    /**
     * 构造实体上下文
     * @param deps
     * @param groupDependencies
     * @param context
     * @returns
     */
    ExpressionManager.prototype.buildEntityContext = function (deps, groupDependencies, context) {
        var _this = this;
        var currentRows = context && context.currentRows || null;
        var index = deps.findIndex(function (dep) {
            var isEntityDependency = _this.isEntityDependency(dep);
            // 如果依赖的是state，无需处理，现在需要确定的是返回多少实体的问题，和state没有关系
            // 表达式依赖了实体
            if (isEntityDependency) {
                var isGroupDependency = groupDependencies.findIndex(function (item) { return item === dep; }) !== -1;
                // 是聚合依赖
                if (isGroupDependency) {
                    var dependencyLength = dep.split('/').filter(function (p) { return p; }).length - 1;
                    if (dependencyLength === 1) {
                        // 聚合了主表字段，所有主表数据都需要参与运算，此时已经确定计算的实体上下文了。
                        return true;
                    }
                    else {
                        // 聚合了子表字段，只需要传递当前实体
                        return false;
                    }
                }
                else {
                    // 当前依赖不是聚合，只需要传递当前实体
                    return false;
                }
            }
            return false;
        });
        var isGroupdMainEntity = index !== -1;
        var options = {};
        if (currentRows && currentRows.length > 0) {
            currentRows.forEach(function (currentRow) {
                options[currentRow.bindingPath || '/'] = currentRow.primaryValue;
            });
        }
        var entity = this.getEntity(options);
        var patch = context && context.patch || null;
        if (!entity) {
            return null;
        }
        if (patch && Object.keys(patch).length > 0) {
            Object.keys(patch).forEach(function (key) {
                var paths = key.split('/').filter(function (p) { return p; });
                var value = patch[key];
                _this.setValue(entity, paths, value);
            });
        }
        if (isGroupdMainEntity) {
            var collection = this.frameContext.repository.entityCollection.toJSON();
            entity['__type__'] = 'List';
            entity['__items__'] = collection;
        }
        return entity;
    };
    ExpressionManager.prototype.setValue = function (target, paths, value) {
        if (paths.length === 1) {
            target[paths[0]] = value;
        }
        else {
            var propertyName = paths.pop();
            var result = paths.reduce(function (object, path) {
                return object && object[path];
            }, target);
            result[propertyName] = value;
        }
    };
    /**
     * 是否为实体依赖
     * @param dep
     * @returns
     */
    ExpressionManager.prototype.isEntityDependency = function (dep) {
        return dep.startsWith(ENTITY_TEMPLATE);
    };
    /**
     * 获取实体
     * @param options
     * @returns
     */
    ExpressionManager.prototype.getEntity = function (options) {
        var _this = this;
        var entityTypeInfo = this.frameContext.repository.entityTypeInfo;
        var bindingData = this.frameContext.bindingData;
        var childrenEntityPaths = [];
        var entity = null;
        if (options['/']) {
            // 修正主表
            entity = this.frameContext.bindingData.list.findById(options['/']);
            if (entity) {
                entity = entity.toJSON();
            }
        }
        else {
            entity = this.frameContext.bindingData.list.currentItem.toJSON();
        }
        if (!entity) {
            return null;
        }
        ExpressionUtil.getChildrenEntityPaths(entityTypeInfo, childrenEntityPaths);
        entity['__type__'] = 'Entity';
        if (!childrenEntityPaths || childrenEntityPaths.length < 1) {
            return entity;
        }
        // 找到所有子表
        childrenEntityPaths.forEach(function (paths) {
            var row = null;
            if (options && options[paths.join('/')]) {
                // 不应该使用bindingData，这样就默认使用了当前行
                var bindingList = bindingData.getValue(paths);
                var currentRowId = options[paths.join('/')];
                var currentRow = null;
                if (currentRowId !== bindingList.currentId) {
                    currentRow = bindingList.findById(currentRowId);
                }
                else {
                    currentRow = bindingList.currentItem;
                }
                if (currentRow && currentRow.primaryKeyValue) {
                    row = currentRow.toJSON();
                }
            }
            else {
                // 如果上级表已经切换了当前行，那么下级表也应该切换
                var parentTableCurrentRowChanged = options && !!Object.keys(options).find(function (path) {
                    var fullPath = path.split('/').join('/');
                    return paths.join('/').startsWith(fullPath);
                }) || false;
                if (parentTableCurrentRowChanged) {
                    var primaryValue = options && options['/'] || bindingData.list.currentId;
                    var entity_1 = _this.frameContext.repository.entityCollection.getEntityById(primaryValue);
                    var fullPaths_1 = [];
                    var data = paths.reduce(function (object, path) {
                        fullPaths_1.push(path);
                        var item = object && object[path];
                        if (item) {
                            var currentRowId = options && options[fullPaths_1.join('/')] || item.items[0] && item.items[0].primaryValue || null;
                            if (currentRowId) {
                                var currentRow = item.get(currentRowId);
                                return currentRow || null;
                            }
                        }
                        return null;
                    }, entity_1);
                    if (data) {
                        row = data.toJSON();
                    }
                    else {
                        row = {};
                    }
                }
                else {
                    row = ExpressionUtil.getCurrentRowByPaths(paths, bindingData);
                }
            }
            var propertyName = paths.pop();
            var parent = paths.reduce(function (object, path) {
                return object && object[path] || null;
            }, entity);
            var list = parent[propertyName];
            var node = tslib_1.__assign({ __items__: [] }, row && row || {}, { __type__: 'List' });
            node.length = function () { return node.__items__.length; };
            if (list && Array.isArray(list)) {
                node.__items__ = [].concat(list);
            }
            parent[propertyName] = node;
        });
        return entity;
    };
    Object.defineProperty(ExpressionManager.prototype, "entityOriginalNodeCode", {
        /**
         * 获取主实体原始字段名
         */
        get: function () {
            var repository = this.injector.get(Repository);
            return repository && repository.entityTypeInfo && repository.entityTypeInfo.entityInfo && repository.entityTypeInfo.entityInfo.originalCode || null;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 构造变量上下文
     * @param event
     * @returns
     */
    ExpressionManager.prototype.buildStateContext = function () {
        var result = {};
        if (this.frameContext) {
            var rootFrameContext = this.frameContext.getVirtualRootFrameContext();
            if (rootFrameContext) {
                var uiState_1 = rootFrameContext.viewModel.uiState;
                var propertyNames = Object.getOwnPropertyNames(uiState_1) || [];
                propertyNames.forEach(function (prop) {
                    if (prop.match(/^[a-zA-Z0-9_\$]+$/g) !== null) {
                        result[prop] = uiState_1[prop];
                    }
                });
            }
        }
        return result;
    };
    return ExpressionManager;
}());
export { ExpressionManager };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl9tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2V4cHJlc3Npb24vZXhwcmVzc2lvbi9leHByZXNzaW9uX21hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxLQUFLLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBSzdDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUlwRCxPQUFPLEVBQW1DLHFCQUFxQixFQUFFLG9CQUFvQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdHLE9BQU8sRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRTFELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzNELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzNELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDckMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFHdkQ7SUFnQkUsMkJBQW9CLFlBQThCO1FBQTlCLGlCQUFZLEdBQVosWUFBWSxDQUFrQjtRQUNoRCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDO1FBQzNDLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDeEQsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FB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LENBQUMsQ0FBQztxQkFDOUI7Z0JBQ0gsQ0FBQyxDQUFDLENBQUM7YUFDSjtTQUNGO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUNILHdCQUFDO0FBQUQsQ0FBQyxBQWpWRCxJQWlWQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVNUFRZLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQgeyBJbmplY3RvciB9IGZyb20gJy4uLy4uL2NvcmUvaW5kZXgnO1xuXG5pbXBvcnQgeyBBcHBDb250ZXh0IH0gZnJvbSBcIi4uLy4uL2FwcC9pbmRleFwiO1xuaW1wb3J0IHsgRW50aXR5LCBFbnRpdHlMaXN0IH0gZnJvbSBcIi4uLy4uL2VudGl0eS9pbmRleFwiO1xuaW1wb3J0IHsgUmVwb3NpdG9yeSB9IGZyb20gXCIuLi8uLi9yZXBvc2l0b3J5L2luZGV4XCI7XG5pbXBvcnQgeyBCaW5kaW5nRGF0YSwgQmluZGluZ0xpc3QsIEJpbmRpbmdPYmplY3QgfSBmcm9tIFwiLi4vLi4vYmluZGluZy1kYXRhL2luZGV4XCI7XG5pbXBvcnQgeyBWaWV3TW9kZWxDb250ZXh0LCBWaWV3TW9kZWwgfSBmcm9tIFwiLi4vLi4vdmlldy1tb2RlbC9pbmRleFwiO1xuXG5pbXBvcnQgeyBJTWVzc2FnZVNlcnZpY2UsIElOb3RpZnlTZXJ2aWNlLCBNRVNTQUdFX1NFUlZJQ0VfVE9LRU4sIE5PVElGWV9TRVJWSUNFX1RPS0VOIH0gZnJvbSBcIi4uL2NvcmUvaW5kZXhcIjtcbmltcG9ydCB7IEVOVElUWV9URU1QTEFURSwgUmVzb2x2ZVNlcnZpY2UgfSBmcm9tIFwiLi4vcmVzb2x2ZXIvaW5kZXhcIjtcbmltcG9ydCB7IEV4cHJlc3Npb25VdGlsIH0gZnJvbSBcIi4uL3V0aWxzL2V4cHJlc3Npb25fdXRpbFwiO1xuXG5pbXBvcnQgeyBFeHByZXNzaW9uRXhlY3V0b3IgfSBmcm9tIFwiLi9leHByZXNzaW9uX2V4ZWN1dG9yXCI7XG5pbXBvcnQgeyBFeHByZXNzaW9uUmVnaXN0cnkgfSBmcm9tIFwiLi9leHByZXNzaW9uX3JlZ2lzdHJ5XCI7XG5pbXBvcnQgeyBFeHByZXNzaW9uIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBFeHByZXNzaW9uUmVzdWx0IH0gZnJvbSBcIi4vZXhwcmVzc2lvbl9yZXN1bHRcIjtcblxuXG5leHBvcnQgY2xhc3MgRXhwcmVzc2lvbk1hbmFnZXIge1xuXG4gIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yO1xuXG4gIHByaXZhdGUgcmVzb2x2ZVNlcnZpY2U6IFJlc29sdmVTZXJ2aWNlO1xuXG4gIHByaXZhdGUgZXhwcmVzc2lvbkV4ZWN1dG9yOiBFeHByZXNzaW9uRXhlY3V0b3I7XG5cbiAgcHJpdmF0ZSBleHByZXNzaW9uUmVnaXN0cnk6IEV4cHJlc3Npb25SZWdpc3RyeTtcblxuICBwcml2YXRlIGV4cHJlc3Npb25SZXN1bHQ6IEV4cHJlc3Npb25SZXN1bHQ7XG5cbiAgcHJpdmF0ZSBtZXNzYWdlU2VydmljZTogSU1lc3NhZ2VTZXJ2aWNlO1xuXG4gIHByaXZhdGUgbm90aWZ5U2VydmljZTogSU5vdGlmeVNlcnZpY2U7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBmcmFtZUNvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQpIHtcbiAgICB0aGlzLmluamVjdG9yID0gdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3I7XG4gICAgdGhpcy5yZXNvbHZlU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KFJlc29sdmVTZXJ2aWNlKTtcbiAgICB0aGlzLmV4cHJlc3Npb25FeGVjdXRvciA9IHRoaXMuaW5qZWN0b3IuZ2V0KEV4cHJlc3Npb25FeGVjdXRvcik7XG4gICAgdGhpcy5leHByZXNzaW9uUmVnaXN0cnkgPSB0aGlzLmluamVjdG9yLmdldChFeHByZXNzaW9uUmVnaXN0cnkpO1xuICAgIHRoaXMuZXhwcmVzc2lvblJlc3VsdCA9IHRoaXMuaW5qZWN0b3IuZ2V0KEV4cHJlc3Npb25SZXN1bHQpO1xuICAgIHRoaXMubWVzc2FnZVNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChNRVNTQUdFX1NFUlZJQ0VfVE9LRU4sIG51bGwpO1xuICAgIHRoaXMubm90aWZ5U2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KE5PVElGWV9TRVJWSUNFX1RPS0VOLCBudWxsKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmoLnmja7ooajovr7lvI9pZOi/m+ihjOiuoeeul1xuICAgKiBAcGFyYW0gZXhwcmVzc2lvbklkIOihqOi+vuW8j2lkXG4gICAqIEBwYXJhbSB2aWV3TW9kZWwgdmlld01vZGVsXG4gICAqIEBwYXJhbSByb3dEYXRhIHJvd0RhdGFcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgZXZhbChleHByZXNzaW9uSWQ6IHN0cmluZywgdmlld01vZGVsPzogVmlld01vZGVsLCByb3dEYXRhPzogYW55KSB7XG4gICAgY29uc3QgZXhwcmVzc2lvbk9iamVjdCA9IHRoaXMuZXhwcmVzc2lvblJlZ2lzdHJ5LmdldEV4cHJlc3Npb25CeUlkKGV4cHJlc3Npb25JZCk7XG4gICAgaWYgKGV4cHJlc3Npb25PYmplY3QpIHtcbiAgICAgIGNvbnN0IGN1c3RvbUNvbnRleHQ6IEV4cHJlc3Npb24uSUN1c3RvbUNvbnRleHQgPSB7fTtcbiAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gdmlld01vZGVsICYmIHZpZXdNb2RlbC5iaW5kaW5nUGF0aCB8fCBudWxsO1xuICAgICAgaWYgKGJpbmRpbmdQYXRoICYmIHJvd0RhdGEpIHtcbiAgICAgICAgY29uc3QgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcbiAgICAgICAgY29uc3QgYmluZGluZ0xpc3QgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRWYWx1ZShiaW5kaW5nUGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xuICAgICAgICBsZXQgcHJpbWFyeUtleSA9ICdpZCc7XG4gICAgICAgIGlmIChiaW5kaW5nTGlzdCkge1xuICAgICAgICAgIHByaW1hcnlLZXkgPSBiaW5kaW5nTGlzdC5wcmltYXJ5S2V5O1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHByaW1hcnlWYWx1ZSA9IHJvd0RhdGFbcHJpbWFyeUtleV07XG4gICAgICAgIGlmIChwcmltYXJ5VmFsdWUpIHtcbiAgICAgICAgICBjdXN0b21Db250ZXh0LmN1cnJlbnRSb3dzID0gW3sgYmluZGluZ1BhdGg6IGJpbmRpbmdQYXRocy5qb2luKCcvJyksIHByaW1hcnlWYWx1ZSB9XTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5leGVjdXRlKGV4cHJlc3Npb25PYmplY3QuZXhwcmVzc2lvbiwgY3VzdG9tQ29udGV4dCk7XG4gICAgICB0aGlzLmV4cHJlc3Npb25SZXN1bHQuc2V0KGV4cHJlc3Npb25JZCwgcmVzdWx0KTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGNvbnNvbGUud2FybignRXhwcmVzc2lvbk1hbmFnZXIg5omn6KGM5aSx6LSl77yM5pyq6I635Y+W5Yiw6KGo6L6+5byPIScpO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG4gIHB1YmxpYyB2YWxpZGF0ZShleHByZXNzaW9uSWQ6IHN0cmluZywgb3B0aW9uczogYW55KSB7XG4gICAgY29uc3QgZXhwcmVzc2lvbk9iamVjdCA9IHRoaXMuZXhwcmVzc2lvblJlZ2lzdHJ5LmdldEV4cHJlc3Npb25CeUlkKGV4cHJlc3Npb25JZCk7XG4gICAgaWYgKGV4cHJlc3Npb25PYmplY3QpIHtcbiAgICAgIGNvbnN0IHBhdGNoID0gb3B0aW9ucyAmJiBvcHRpb25zLnBhdGNoIHx8IG51bGw7XG4gICAgICBjb25zdCBjdXN0b21Db250ZXh0OiBFeHByZXNzaW9uLklDdXN0b21Db250ZXh0ID0ge307XG4gICAgICBpZiAocGF0Y2gpIHtcbiAgICAgICAgY3VzdG9tQ29udGV4dC5wYXRjaCA9IHBhdGNoO1xuICAgICAgfVxuICAgICAgY29uc3QgY3VycmVudFJvdyA9IG9wdGlvbnMuY3VycmVudFJvdyB8fCBudWxsO1xuICAgICAgaWYgKGN1cnJlbnRSb3cpIHtcbiAgICAgICAgY3VzdG9tQ29udGV4dC5jdXJyZW50Um93cyA9IGN1c3RvbUNvbnRleHQuY3VycmVudFJvd3MgfHwgW107XG4gICAgICAgIGN1c3RvbUNvbnRleHQuY3VycmVudFJvd3MucHVzaChjdXJyZW50Um93KTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuZXhlY3V0ZShleHByZXNzaW9uT2JqZWN0LmV4cHJlc3Npb24sIGN1c3RvbUNvbnRleHQpO1xuICAgICAgdGhpcy5leHByZXNzaW9uUmVzdWx0LnNldChleHByZXNzaW9uSWQsIHJlc3VsdCk7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLndhcm4oJ0V4cHJlc3Npb25NYW5hZ2VyIOaJp+ihjOWksei0pe+8jOacquiOt+WPluWIsOihqOi+vuW8jyEnKTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICAvKipcbiAgICog5biu5Yqp5YmN5bCB6KOFXG4gICAqIEBwYXJhbSBldmVudCBcbiAgICovXG4gIHB1YmxpYyBvbkRhdGFQaWNraW5nKGNvbmZpZ3M6IHsgZXhwcmVzc2lvbklkOiBzdHJpbmcgfSkge1xuICAgIGNvbnN0IGV4cHJlc3Npb25JZCA9IGNvbmZpZ3MgJiYgY29uZmlncy5leHByZXNzaW9uSWQgfHwgbnVsbDtcbiAgICBpZiAoIWV4cHJlc3Npb25JZCkge1xuICAgICAgY29uc29sZS53YXJuKGBFeHByZXNzaW9uTWFuYWdlciDnm7jlhbPooajovr7lvI/orr7nva7plJnor6/vvIzmsqHmnInooajovr7lvI/nvJblj7fjgIJgKTtcbiAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5ldmFsKGV4cHJlc3Npb25JZCk7XG4gICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgIGNvbnN0IGV4cHJlc3Npb25PYmplY3QgPSB0aGlzLmV4cHJlc3Npb25SZWdpc3RyeS5nZXRFeHByZXNzaW9uQnlJZChleHByZXNzaW9uSWQpO1xuICAgICAgaWYgKCFleHByZXNzaW9uT2JqZWN0KSB7XG4gICAgICAgIGNvbnNvbGUud2FybihgRXhwcmVzc2lvbk1hbmFnZXIg5peg5rOV5om+5Yiw5a+55bqU55qE6KGo6L6+5byPJHtleHByZXNzaW9uSWR9YCk7XG4gICAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG1lc3NhZ2VUeXBlID0gZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlVHlwZSB8fCBFeHByZXNzaW9uLk1lc3NhZ2VUeXBlLndhcm5pbmc7XG4gICAgICBjb25zdCBtZXNzYWdlID0gZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlO1xuICAgICAgaWYgKG1lc3NhZ2UpIHtcbiAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlW21lc3NhZ2VUeXBlXShtZXNzYWdlLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBFTVBUWTtcbiAgICB9XG4gICAgcmV0dXJuIG9mKHJlc3VsdCk7XG4gIH1cbiAgLyoqXG4gICAqIOaJp+ihjOihqOi+vuW8j+iuoeeul1xuICAgKiBAcGFyYW0gZXhwcmVzc2lvbiDooajovr7lvI9cbiAgICogQHBhcmFtIGN1c3RvbUNvbnRleHQg6Ieq5a6a5LmJ5LiK5LiL5paHXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHJpdmF0ZSBleGVjdXRlKGV4cHJlc3Npb246IHN0cmluZywgY3VzdG9tQ29udGV4dD86IEV4cHJlc3Npb24uSUN1c3RvbUNvbnRleHQpOiBhbnkge1xuICAgIGNvbnN0IGRlcHMgPSB0aGlzLnJlc29sdmVTZXJ2aWNlLnJlc29sdmUoZXhwcmVzc2lvbik7XG4gICAgY29uc3QgZ3JvdXBEZXBlbmRlbmNpZXMgPSBFeHByZXNzaW9uVXRpbC5nZXRHcm91cEZ1bmN0aW9uRGVwZW5kZW5jeShleHByZXNzaW9uLCB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvKTtcbiAgICBjb25zdCBlbnRpdHlDb250ZXh0ID0gdGhpcy5idWlsZEVudGl0eUNvbnRleHQoZGVwcywgZ3JvdXBEZXBlbmRlbmNpZXMsIGN1c3RvbUNvbnRleHQpO1xuICAgIGNvbnN0IHN0YXRlQ29udGV4dCA9IHRoaXMuYnVpbGRTdGF0ZUNvbnRleHQoKTtcbiAgICBjb25zdCBkYXRhID0gY3VzdG9tQ29udGV4dCAmJiBjdXN0b21Db250ZXh0LmNvbnRleHRzIHx8IG51bGw7XG4gICAgY29uc3QgY29udGV4dCA9IHtcbiAgICAgIFt0aGlzLmVudGl0eU9yaWdpbmFsTm9kZUNvZGVdOiBlbnRpdHlDb250ZXh0LFxuICAgICAgLi4uc3RhdGVDb250ZXh0LFxuICAgICAgZnJhbWVDb250ZXh0OiB0aGlzLmZyYW1lQ29udGV4dCxcbiAgICAgIGJpbmRpbmdEYXRhOiB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YSxcbiAgICAgIHJlcG9zaXRvcnk6IHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnksXG4gICAgICAuLi5kYXRhXG4gICAgfVxuICAgIGlmICghZW50aXR5Q29udGV4dCkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZXhwcmVzc2lvbkV4ZWN1dG9yLmV2YWwoZXhwcmVzc2lvbiwgY29udGV4dCk7XG4gIH1cbiAgLyoqXG4gICAqIOaJp+ihjOihqOi+vuW8j++8iOi/lOWbnuWPr+inguWvn+Wvueixoe+8iVxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbiDooajovr7lvI9cbiAgICogQHBhcmFtIGN1c3RvbUNvbnRleHQg6Ieq5a6a5LmJ5LiK5LiL5paHXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHJpdmF0ZSBleGVjdXRlQXN5bmMoZXhwcmVzc2lvbjogc3RyaW5nLCBjdXN0b21Db250ZXh0PzogRXhwcmVzc2lvbi5JQ3VzdG9tQ29udGV4dCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5leGVjdXRlKGV4cHJlc3Npb24sIGN1c3RvbUNvbnRleHQpO1xuICAgIHJldHVybiBvZihyZXN1bHQpO1xuICB9XG4gIC8qKlxuICAgKiDmnoTpgKDlrp7kvZPkuIrkuIvmlodcbiAgICogQHBhcmFtIGRlcHMgXG4gICAqIEBwYXJhbSBncm91cERlcGVuZGVuY2llcyBcbiAgICogQHBhcmFtIGNvbnRleHQgXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHJpdmF0ZSBidWlsZEVudGl0eUNvbnRleHQoZGVwczogc3RyaW5nW10sIGdyb3VwRGVwZW5kZW5jaWVzOiBzdHJpbmdbXSwgY29udGV4dD86IEV4cHJlc3Npb24uSUN1c3RvbUNvbnRleHQpIHtcblxuICAgIGNvbnN0IGN1cnJlbnRSb3dzID0gY29udGV4dCAmJiBjb250ZXh0LmN1cnJlbnRSb3dzIHx8IG51bGw7XG4gICAgY29uc3QgaW5kZXggPSBkZXBzLmZpbmRJbmRleCgoZGVwOiBzdHJpbmcpID0+IHtcbiAgICAgIGNvbnN0IGlzRW50aXR5RGVwZW5kZW5jeSA9IHRoaXMuaXNFbnRpdHlEZXBlbmRlbmN5KGRlcCk7XG4gICAgICAvLyDlpoLmnpzkvp3otZbnmoTmmK9zdGF0Ze+8jOaXoOmcgOWkhOeQhu+8jOeOsOWcqOmcgOimgeehruWumueahOaYr+i/lOWbnuWkmuWwkeWunuS9k+eahOmXrumimO+8jOWSjHN0YXRl5rKh5pyJ5YWz57O7XG4gICAgICAvLyDooajovr7lvI/kvp3otZbkuoblrp7kvZNcbiAgICAgIGlmIChpc0VudGl0eURlcGVuZGVuY3kpIHtcbiAgICAgICAgY29uc3QgaXNHcm91cERlcGVuZGVuY3kgPSBncm91cERlcGVuZGVuY2llcy5maW5kSW5kZXgoaXRlbSA9PiBpdGVtID09PSBkZXApICE9PSAtMTtcbiAgICAgICAgLy8g5piv6IGa5ZCI5L6d6LWWXG4gICAgICAgIGlmIChpc0dyb3VwRGVwZW5kZW5jeSkge1xuICAgICAgICAgIGNvbnN0IGRlcGVuZGVuY3lMZW5ndGggPSBkZXAuc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS5sZW5ndGggLSAxO1xuICAgICAgICAgIGlmIChkZXBlbmRlbmN5TGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAvLyDogZrlkIjkuobkuLvooajlrZfmrrXvvIzmiYDmnInkuLvooajmlbDmja7pg73pnIDopoHlj4LkuI7ov5DnrpfvvIzmraTml7blt7Lnu4/noa7lrprorqHnrpfnmoTlrp7kvZPkuIrkuIvmlofkuobjgIJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyDogZrlkIjkuoblrZDooajlrZfmrrXvvIzlj6rpnIDopoHkvKDpgJLlvZPliY3lrp7kvZNcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8g5b2T5YmN5L6d6LWW5LiN5piv6IGa5ZCI77yM5Y+q6ZyA6KaB5Lyg6YCS5b2T5YmN5a6e5L2TXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSlcbiAgICBjb25zdCBpc0dyb3VwZE1haW5FbnRpdHkgPSBpbmRleCAhPT0gLTE7XG5cbiAgICBjb25zdCBvcHRpb25zID0ge307XG4gICAgaWYgKGN1cnJlbnRSb3dzICYmIGN1cnJlbnRSb3dzLmxlbmd0aCA+IDApIHtcbiAgICAgIGN1cnJlbnRSb3dzLmZvckVhY2goKGN1cnJlbnRSb3c6IEV4cHJlc3Npb24uSUN1cnJlbnRSb3cpID0+IHtcbiAgICAgICAgb3B0aW9uc1tjdXJyZW50Um93LmJpbmRpbmdQYXRoIHx8ICcvJ10gPSBjdXJyZW50Um93LnByaW1hcnlWYWx1ZTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBjb25zdCBlbnRpdHkgPSB0aGlzLmdldEVudGl0eShvcHRpb25zKTtcbiAgICBjb25zdCBwYXRjaCA9IGNvbnRleHQgJiYgY29udGV4dC5wYXRjaCB8fCBudWxsO1xuICAgIGlmICghZW50aXR5KSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgaWYgKHBhdGNoICYmIE9iamVjdC5rZXlzKHBhdGNoKS5sZW5ndGggPiAwKSB7XG4gICAgICBPYmplY3Qua2V5cyhwYXRjaCkuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3QgcGF0aHMgPSBrZXkuc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBwYXRjaFtrZXldO1xuICAgICAgICB0aGlzLnNldFZhbHVlKGVudGl0eSwgcGF0aHMsIHZhbHVlKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAoaXNHcm91cGRNYWluRW50aXR5KSB7XG4gICAgICBjb25zdCBjb2xsZWN0aW9uID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLnRvSlNPTigpO1xuICAgICAgZW50aXR5WydfX3R5cGVfXyddID0gJ0xpc3QnO1xuICAgICAgZW50aXR5WydfX2l0ZW1zX18nXSA9IGNvbGxlY3Rpb247XG4gICAgfVxuICAgIHJldHVybiBlbnRpdHk7XG4gIH1cbiAgcHJpdmF0ZSBzZXRWYWx1ZSh0YXJnZXQ6IGFueSwgcGF0aHM6IHN0cmluZ1tdLCB2YWx1ZTogYW55KSB7XG4gICAgaWYgKHBhdGhzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgdGFyZ2V0W3BhdGhzWzBdXSA9IHZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwYXRocy5wb3AoKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHBhdGhzLnJlZHVjZSgob2JqZWN0OiBhbnksIHBhdGg6IHN0cmluZykgPT4ge1xuICAgICAgICByZXR1cm4gb2JqZWN0ICYmIG9iamVjdFtwYXRoXTtcbiAgICAgIH0sIHRhcmdldCk7XG4gICAgICByZXN1bHRbcHJvcGVydHlOYW1lXSA9IHZhbHVlO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog5piv5ZCm5Li65a6e5L2T5L6d6LWWXG4gICAqIEBwYXJhbSBkZXAgXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHJpdmF0ZSBpc0VudGl0eURlcGVuZGVuY3koZGVwOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gZGVwLnN0YXJ0c1dpdGgoRU5USVRZX1RFTVBMQVRFKTtcbiAgfVxuICAvKipcbiAgICog6I635Y+W5a6e5L2TXG4gICAqIEBwYXJhbSBvcHRpb25zIFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyBnZXRFbnRpdHkob3B0aW9uczogeyBbYmluZGluZ1BhdGg6IHN0cmluZ106IHN0cmluZyB9KSB7XG4gICAgY29uc3QgZW50aXR5VHlwZUluZm8gPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvO1xuICAgIGNvbnN0IGJpbmRpbmdEYXRhID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGE7XG4gICAgY29uc3QgY2hpbGRyZW5FbnRpdHlQYXRocyA9IFtdO1xuXG4gICAgbGV0IGVudGl0eSA9IG51bGw7XG4gICAgaWYgKG9wdGlvbnNbJy8nXSkge1xuICAgICAgLy8g5L+u5q2j5Li76KGoXG4gICAgICBlbnRpdHkgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0LmZpbmRCeUlkKG9wdGlvbnNbJy8nXSk7XG4gICAgICBpZiAoZW50aXR5KSB7XG4gICAgICAgIGVudGl0eSA9IGVudGl0eS50b0pTT04oKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgZW50aXR5ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SXRlbS50b0pTT04oKTtcbiAgICB9XG4gICAgaWYgKCFlbnRpdHkpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBFeHByZXNzaW9uVXRpbC5nZXRDaGlsZHJlbkVudGl0eVBhdGhzKGVudGl0eVR5cGVJbmZvLCBjaGlsZHJlbkVudGl0eVBhdGhzKTtcbiAgICBlbnRpdHlbJ19fdHlwZV9fJ10gPSAnRW50aXR5JztcbiAgICBpZiAoIWNoaWxkcmVuRW50aXR5UGF0aHMgfHwgY2hpbGRyZW5FbnRpdHlQYXRocy5sZW5ndGggPCAxKSB7XG4gICAgICByZXR1cm4gZW50aXR5O1xuICAgIH1cbiAgICAvLyDmib7liLDmiYDmnInlrZDooahcbiAgICBjaGlsZHJlbkVudGl0eVBhdGhzLmZvckVhY2goKHBhdGhzOiBzdHJpbmdbXSkgPT4ge1xuICAgICAgbGV0IHJvdyA9IG51bGw7XG4gICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zW3BhdGhzLmpvaW4oJy8nKV0pIHtcbiAgICAgICAgLy8g5LiN5bqU6K+l5L2/55SoYmluZGluZ0RhdGHvvIzov5nmoLflsLHpu5jorqTkvb/nlKjkuoblvZPliY3ooYxcbiAgICAgICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xuICAgICAgICBjb25zdCBjdXJyZW50Um93SWQgPSBvcHRpb25zW3BhdGhzLmpvaW4oJy8nKV07XG4gICAgICAgIGxldCBjdXJyZW50Um93OiBCaW5kaW5nT2JqZWN0ID0gbnVsbDtcbiAgICAgICAgaWYgKGN1cnJlbnRSb3dJZCAhPT0gYmluZGluZ0xpc3QuY3VycmVudElkKSB7XG4gICAgICAgICAgY3VycmVudFJvdyA9IGJpbmRpbmdMaXN0LmZpbmRCeUlkKGN1cnJlbnRSb3dJZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY3VycmVudFJvdyA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGN1cnJlbnRSb3cgJiYgY3VycmVudFJvdy5wcmltYXJ5S2V5VmFsdWUpIHtcbiAgICAgICAgICByb3cgPSBjdXJyZW50Um93LnRvSlNPTigpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyDlpoLmnpzkuIrnuqfooajlt7Lnu4/liIfmjaLkuoblvZPliY3ooYzvvIzpgqPkuYjkuIvnuqfooajkuZ/lupTor6XliIfmjaJcbiAgICAgICAgY29uc3QgcGFyZW50VGFibGVDdXJyZW50Um93Q2hhbmdlZCA9IG9wdGlvbnMgJiYgISFPYmplY3Qua2V5cyhvcHRpb25zKS5maW5kKHBhdGggPT4ge1xuICAgICAgICAgIGNvbnN0IGZ1bGxQYXRoID0gcGF0aC5zcGxpdCgnLycpLmpvaW4oJy8nKTtcbiAgICAgICAgICByZXR1cm4gcGF0aHMuam9pbignLycpLnN0YXJ0c1dpdGgoZnVsbFBhdGgpO1xuICAgICAgICB9KSB8fCBmYWxzZTtcbiAgICAgICAgaWYgKHBhcmVudFRhYmxlQ3VycmVudFJvd0NoYW5nZWQpIHtcbiAgICAgICAgICBjb25zdCBwcmltYXJ5VmFsdWUgPSBvcHRpb25zICYmIG9wdGlvbnNbJy8nXSB8fCBiaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZDtcbiAgICAgICAgICBjb25zdCBlbnRpdHkgPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChwcmltYXJ5VmFsdWUpO1xuICAgICAgICAgIGNvbnN0IGZ1bGxQYXRocyA9IFtdO1xuICAgICAgICAgIGNvbnN0IGRhdGEgPSBwYXRocy5yZWR1Y2UoKG9iamVjdCwgcGF0aCkgPT4ge1xuICAgICAgICAgICAgZnVsbFBhdGhzLnB1c2gocGF0aCk7XG4gICAgICAgICAgICBjb25zdCBpdGVtID0gb2JqZWN0ICYmIG9iamVjdFtwYXRoXSBhcyBFbnRpdHlMaXN0PEVudGl0eT47XG4gICAgICAgICAgICBpZiAoaXRlbSkge1xuICAgICAgICAgICAgICBjb25zdCBjdXJyZW50Um93SWQgPSBvcHRpb25zICYmIG9wdGlvbnNbZnVsbFBhdGhzLmpvaW4oJy8nKV0gfHwgaXRlbS5pdGVtc1swXSAmJiBpdGVtLml0ZW1zWzBdLnByaW1hcnlWYWx1ZSB8fCBudWxsO1xuICAgICAgICAgICAgICBpZiAoY3VycmVudFJvd0lkKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFJvdyA9IGl0ZW0uZ2V0KGN1cnJlbnRSb3dJZCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRSb3cgfHwgbnVsbDtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgfSwgZW50aXR5KSBhcyBFbnRpdHk7XG4gICAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICAgIHJvdyA9IGRhdGEudG9KU09OKCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJvdyA9IHt9O1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByb3cgPSBFeHByZXNzaW9uVXRpbC5nZXRDdXJyZW50Um93QnlQYXRocyhwYXRocywgYmluZGluZ0RhdGEpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwYXRocy5wb3AoKTtcbiAgICAgIGxldCBwYXJlbnQgPSBwYXRocy5yZWR1Y2UoKG9iamVjdDogYW55LCBwYXRoOiBzdHJpbmcpID0+IHtcbiAgICAgICAgcmV0dXJuIG9iamVjdCAmJiBvYmplY3RbcGF0aF0gfHwgbnVsbDtcbiAgICAgIH0sIGVudGl0eSk7XG4gICAgICBjb25zdCBsaXN0ID0gcGFyZW50W3Byb3BlcnR5TmFtZV07XG4gICAgICBjb25zdCBub2RlOiBhbnkgPSB7IF9faXRlbXNfXzogW10sIC4uLnJvdyAmJiByb3cgfHwge30sIF9fdHlwZV9fOiAnTGlzdCcgfTtcbiAgICAgIG5vZGUubGVuZ3RoID0gKCkgPT4gbm9kZS5fX2l0ZW1zX18ubGVuZ3RoO1xuICAgICAgaWYgKGxpc3QgJiYgQXJyYXkuaXNBcnJheShsaXN0KSkge1xuICAgICAgICBub2RlLl9faXRlbXNfXyA9IFtdLmNvbmNhdChsaXN0KTtcbiAgICAgIH1cbiAgICAgIHBhcmVudFtwcm9wZXJ0eU5hbWVdID0gbm9kZTtcbiAgICB9KTtcbiAgICByZXR1cm4gZW50aXR5O1xuICB9XG4gIC8qKlxuICAgKiDojrflj5bkuLvlrp7kvZPljp/lp4vlrZfmrrXlkI1cbiAgICovXG4gIHByb3RlY3RlZCBnZXQgZW50aXR5T3JpZ2luYWxOb2RlQ29kZSgpOiBzdHJpbmcge1xuICAgIGNvbnN0IHJlcG9zaXRvcnkgPSB0aGlzLmluamVjdG9yLmdldChSZXBvc2l0b3J5KTtcbiAgICByZXR1cm4gcmVwb3NpdG9yeSAmJiByZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvICYmIHJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8uZW50aXR5SW5mbyAmJiByZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvLmVudGl0eUluZm8ub3JpZ2luYWxDb2RlIHx8IG51bGw7XG4gIH1cbiAgLyoqXG4gICAqIOaehOmAoOWPmOmHj+S4iuS4i+aWh1xuICAgKiBAcGFyYW0gZXZlbnQgXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHVibGljIGJ1aWxkU3RhdGVDb250ZXh0KCkge1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIGlmICh0aGlzLmZyYW1lQ29udGV4dCkge1xuICAgICAgY29uc3Qgcm9vdEZyYW1lQ29udGV4dCA9IHRoaXMuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XG4gICAgICBpZiAocm9vdEZyYW1lQ29udGV4dCkge1xuICAgICAgICBjb25zdCB1aVN0YXRlID0gcm9vdEZyYW1lQ29udGV4dC52aWV3TW9kZWwudWlTdGF0ZTtcbiAgICAgICAgY29uc3QgcHJvcGVydHlOYW1lcyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHVpU3RhdGUpIHx8IFtdO1xuICAgICAgICBwcm9wZXJ0eU5hbWVzLmZvckVhY2goKHByb3A6IHN0cmluZykgPT4ge1xuICAgICAgICAgIGlmIChwcm9wLm1hdGNoKC9eW2EtekEtWjAtOV9cXCRdKyQvZykgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdFtwcm9wXSA9IHVpU3RhdGVbcHJvcF07XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxufSJdfQ==