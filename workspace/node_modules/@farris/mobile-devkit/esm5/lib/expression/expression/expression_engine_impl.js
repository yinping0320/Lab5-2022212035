import { Core } from '../core/index';
import { ResolverRegistry, ResolveService } from "../resolver/index";
import { EventHandlerRegistry } from "../event-handler/index";
import { ExpressionRegistry } from "./expression_registry";
import { ExpressionEventEmitter } from "./expression_event_emitter";
import { Expression } from './types';
var ExpressionEngineImpl = /** @class */ (function () {
    function ExpressionEngineImpl(viewModelContext) {
        var _this = this;
        this.viewModelContext = viewModelContext;
        this.expressionObjects = new Array();
        this.injector = this.viewModelContext.injector;
        this.expressionRegistry = this.injector.get(ExpressionRegistry);
        this.expressionEventEmitter = this.injector.get(ExpressionEventEmitter);
        this.resolverRegistry = this.injector.get(ResolverRegistry);
        this.eventHandlerRegistry = this.injector.get(EventHandlerRegistry);
        this.resolveService = this.injector.get(ResolveService);
        this.expressionRegistry.expressions.subscribe(function (exprs) {
            if (exprs && exprs.length > 0) {
                _this.expressionObjects = exprs;
                // 解析表达式依赖
                _this.resolveDependency();
            }
            _this.attachEvent();
        });
    }
    ExpressionEngineImpl.prototype.attachEvent = function () {
        var _this = this;
        this.expressionEventEmitter.attach().subscribe(function (events) {
            if (!events || events.length < 1 || !_this.expressionObjects || _this.expressionObjects.length < 1) {
                return;
            }
            events.forEach(function (event) {
                var handler = _this.getEventHandler(event);
                if (handler) {
                    handler.handleEvent(event, _this.expressionObjects);
                }
                else {
                    Core.warn("\u6CA1\u6709\u5BF9\u5E94\u7684\u4E8B\u4EF6\u5904\u7406\u5668,event=" + event.type);
                }
            });
        });
    };
    /**
     * 解析表达式依赖
     * @returns
     */
    ExpressionEngineImpl.prototype.resolveDependency = function () {
        var _this = this;
        if (!this.resolverRegistry || !this.resolverRegistry.resolvers || this.resolverRegistry.resolvers.length < 1 || !this.expressionObjects || this.expressionObjects.length < 1 || !Array.isArray(this.expressionObjects)) {
            return;
        }
        this.expressionObjects.forEach(function (expressionObject) {
            var expression = expressionObject.expression;
            var dependencies = _this.resolveService.resolve(expression);
            expressionObject.deps = dependencies;
        });
    };
    /**
     * 获取表达式事件处理器
     * @param event event
     * @returns
     */
    ExpressionEngineImpl.prototype.getEventHandler = function (event) {
        if (event.type === Expression.EventType.ValueChanged) {
            // 实体值变化
            if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataValueChangeEventHandler;
            }
            else if (event.source === Expression.EventSource.Field) {
                return this.eventHandlerRegistry.entityValueChangedEventHandler;
            }
            else if (event.source === Expression.EventSource.State) {
                return this.eventHandlerRegistry.stateValueChangedEventHandler;
            }
        }
        else if (event.type === Expression.EventType.Append) {
            if (event.source === Expression.EventSource.Repository || event.source === Expression.EventSource.Field) {
                return this.eventHandlerRegistry.repositoryAddEntityEventHandler;
            }
            else if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataAppendEntityEventHandler;
            }
        }
        else if (event.type === Expression.EventType.Remove) {
            if (event.source === Expression.EventSource.Repository || event.source === Expression.EventSource.Field) {
                return this.eventHandlerRegistry.repositoryRemoveEntityEventHandler;
            }
            else if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataRemoveObjectEventHandler;
            }
        }
        else if (event.type === Expression.EventType.Update) {
            if (event.source === Expression.EventSource.Repository) {
                return this.eventHandlerRegistry.entityUpdateEventHandler;
            }
        }
        else if (event.type === Expression.EventType.Load) {
            if (event.source === Expression.EventSource.Repository || event.source === Expression.EventSource.Field) {
                return this.eventHandlerRegistry.repositoryLoadEventHandler;
            }
            else if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataLoadEventHandler;
            }
        }
        else if (event.type === Expression.EventType.SelectionChanged) {
            if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataSelectionChangedHandler;
            }
        }
        return null;
    };
    return ExpressionEngineImpl;
}());
export { ExpressionEngineImpl };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl9lbmdpbmVfaW1wbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9leHByZXNzaW9uL2V4cHJlc3Npb24vZXhwcmVzc2lvbl9lbmdpbmVfaW1wbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNyRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUU5RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRXJDO0lBZ0JFLDhCQUFvQixnQkFBa0M7UUFBdEQsaUJBZ0JDO1FBaEJtQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBZDlDLHNCQUFpQixHQUF1QyxJQUFJLEtBQUssRUFBK0IsQ0FBQztRQWV2RyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUM7UUFDL0MsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLHNCQUFzQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLHNCQUFzQixDQUFDLENBQUM7UUFDeEUsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDNUQsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxD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Q0FBQyxvQkFBb0IsQ0FBQyx3QkFBd0IsQ0FBQzthQUMzRDtTQUNGO2FBQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFO1lBQ25ELElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxVQUFVLENBQUMsV0FBVyxDQUFDLFVBQVUsSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLFVBQVUsQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFO2dCQUN2RyxPQUFPLElBQUksQ0FBQyxvQkFBb0IsQ0FBQywwQkFBMEIsQ0FBQzthQUM3RDtpQkFBTSxJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssVUFBVSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUU7Z0JBQzlELE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLDJCQUEyQixDQUFDO2FBQzlEO1NBQ0Y7YUFBTSxJQUFJLEtBQUssQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsRUFBRTtZQUMvRCxJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssVUFBVSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUU7Z0JBQ3ZELE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLGtDQUFrQyxDQUFDO2FBQ3JFO1NBQ0Y7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFDSCwyQkFBQztBQUFELENBQUMsQUEzR0QsSUEyR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RvciB9IGZyb20gXCIuLi8uLi9jb3JlL2luZGV4XCI7XG5pbXBvcnQgeyBWaWV3TW9kZWxDb250ZXh0IH0gZnJvbSAnLi4vLi4vdmlldy1tb2RlbC9pbmRleCc7XG5cbmltcG9ydCB7IENvcmUgfSBmcm9tICcuLi9jb3JlL2luZGV4JztcbmltcG9ydCB7IFJlc29sdmVyUmVnaXN0cnksIFJlc29sdmVTZXJ2aWNlIH0gZnJvbSBcIi4uL3Jlc29sdmVyL2luZGV4XCI7XG5pbXBvcnQgeyBFdmVudEhhbmRsZXJSZWdpc3RyeSB9IGZyb20gXCIuLi9ldmVudC1oYW5kbGVyL2luZGV4XCI7XG5cbmltcG9ydCB7IEV4cHJlc3Npb25SZWdpc3RyeSB9IGZyb20gXCIuL2V4cHJlc3Npb25fcmVnaXN0cnlcIjtcbmltcG9ydCB7IEV4cHJlc3Npb25FdmVudEVtaXR0ZXIgfSBmcm9tIFwiLi9leHByZXNzaW9uX2V2ZW50X2VtaXR0ZXJcIjtcbmltcG9ydCB7IEV4cHJlc3Npb24gfSBmcm9tICcuL3R5cGVzJztcblxuZXhwb3J0IGNsYXNzIEV4cHJlc3Npb25FbmdpbmVJbXBsIHtcblxuICBwcml2YXRlIGV4cHJlc3Npb25PYmplY3RzOiBBcnJheTxFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3Q+ID0gbmV3IEFycmF5PEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdD4oKTtcblxuICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcjtcblxuICBwcml2YXRlIGV4cHJlc3Npb25SZWdpc3RyeTogRXhwcmVzc2lvblJlZ2lzdHJ5O1xuXG4gIHByaXZhdGUgZXhwcmVzc2lvbkV2ZW50RW1pdHRlcjogRXhwcmVzc2lvbkV2ZW50RW1pdHRlcjtcblxuICBwcml2YXRlIHJlc29sdmVyUmVnaXN0cnk6IFJlc29sdmVyUmVnaXN0cnk7XG5cbiAgcHJpdmF0ZSBldmVudEhhbmRsZXJSZWdpc3RyeTogRXZlbnRIYW5kbGVyUmVnaXN0cnk7XG5cbiAgcHJpdmF0ZSByZXNvbHZlU2VydmljZTogUmVzb2x2ZVNlcnZpY2U7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSB2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0KSB7XG4gICAgdGhpcy5pbmplY3RvciA9IHRoaXMudmlld01vZGVsQ29udGV4dC5pbmplY3RvcjtcbiAgICB0aGlzLmV4cHJlc3Npb25SZWdpc3RyeSA9IHRoaXMuaW5qZWN0b3IuZ2V0KEV4cHJlc3Npb25SZWdpc3RyeSk7XG4gICAgdGhpcy5leHByZXNzaW9uRXZlbnRFbWl0dGVyID0gdGhpcy5pbmplY3Rvci5nZXQoRXhwcmVzc2lvbkV2ZW50RW1pdHRlcik7XG4gICAgdGhpcy5yZXNvbHZlclJlZ2lzdHJ5ID0gdGhpcy5pbmplY3Rvci5nZXQoUmVzb2x2ZXJSZWdpc3RyeSk7XG4gICAgdGhpcy5ldmVudEhhbmRsZXJSZWdpc3RyeSA9IHRoaXMuaW5qZWN0b3IuZ2V0KEV2ZW50SGFuZGxlclJlZ2lzdHJ5KTtcbiAgICB0aGlzLnJlc29sdmVTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQoUmVzb2x2ZVNlcnZpY2UpO1xuXG4gICAgdGhpcy5leHByZXNzaW9uUmVnaXN0cnkuZXhwcmVzc2lvbnMuc3Vic2NyaWJlKChleHByczogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0W10pID0+IHtcbiAgICAgIGlmIChleHBycyAmJiBleHBycy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHRoaXMuZXhwcmVzc2lvbk9iamVjdHMgPSBleHBycztcbiAgICAgICAgLy8g6Kej5p6Q6KGo6L6+5byP5L6d6LWWXG4gICAgICAgIHRoaXMucmVzb2x2ZURlcGVuZGVuY3koKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuYXR0YWNoRXZlbnQoKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXR0YWNoRXZlbnQoKSB7XG4gICAgdGhpcy5leHByZXNzaW9uRXZlbnRFbWl0dGVyLmF0dGFjaCgpLnN1YnNjcmliZSgoZXZlbnRzOiBFeHByZXNzaW9uLkV2ZW50QXJnc1tdKSA9PiB7XG4gICAgICBpZiAoIWV2ZW50cyB8fCBldmVudHMubGVuZ3RoIDwgMSB8fCAhdGhpcy5leHByZXNzaW9uT2JqZWN0cyB8fCB0aGlzLmV4cHJlc3Npb25PYmplY3RzLmxlbmd0aCA8IDEpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgZXZlbnRzLmZvckVhY2goKGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncykgPT4ge1xuICAgICAgICBjb25zdCBoYW5kbGVyID0gdGhpcy5nZXRFdmVudEhhbmRsZXIoZXZlbnQpO1xuICAgICAgICBpZiAoaGFuZGxlcikge1xuICAgICAgICAgIGhhbmRsZXIuaGFuZGxlRXZlbnQoZXZlbnQsIHRoaXMuZXhwcmVzc2lvbk9iamVjdHMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIENvcmUud2Fybihg5rKh5pyJ5a+55bqU55qE5LqL5Lu25aSE55CG5ZmoLGV2ZW50PSR7ZXZlbnQudHlwZX1gKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbiAgLyoqXG4gICAqIOino+aekOihqOi+vuW8j+S+nei1llxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHByaXZhdGUgcmVzb2x2ZURlcGVuZGVuY3koKSB7XG4gICAgaWYgKCF0aGlzLnJlc29sdmVyUmVnaXN0cnkgfHwgIXRoaXMucmVzb2x2ZXJSZWdpc3RyeS5yZXNvbHZlcnMgfHwgdGhpcy5yZXNvbHZlclJlZ2lzdHJ5LnJlc29sdmVycy5sZW5ndGggPCAxIHx8ICF0aGlzLmV4cHJlc3Npb25PYmplY3RzIHx8IHRoaXMuZXhwcmVzc2lvbk9iamVjdHMubGVuZ3RoIDwgMSB8fCAhQXJyYXkuaXNBcnJheSh0aGlzLmV4cHJlc3Npb25PYmplY3RzKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmV4cHJlc3Npb25PYmplY3RzLmZvckVhY2goKGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkgPT4ge1xuICAgICAgY29uc3QgZXhwcmVzc2lvbiA9IGV4cHJlc3Npb25PYmplY3QuZXhwcmVzc2lvbjtcbiAgICAgIGNvbnN0IGRlcGVuZGVuY2llcyA9IHRoaXMucmVzb2x2ZVNlcnZpY2UucmVzb2x2ZShleHByZXNzaW9uKTtcbiAgICAgIGV4cHJlc3Npb25PYmplY3QuZGVwcyA9IGRlcGVuZGVuY2llcztcbiAgICB9KTtcbiAgfVxuICAvKipcbiAgICog6I635Y+W6KGo6L6+5byP5LqL5Lu25aSE55CG5ZmoXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHByaXZhdGUgZ2V0RXZlbnRIYW5kbGVyKGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncyk6IEV4cHJlc3Npb24uSUV2ZW50SGFuZGxlciB7XG4gICAgaWYgKGV2ZW50LnR5cGUgPT09IEV4cHJlc3Npb24uRXZlbnRUeXBlLlZhbHVlQ2hhbmdlZCkge1xuICAgICAgLy8g5a6e5L2T5YC85Y+Y5YyWXG4gICAgICBpZiAoZXZlbnQuc291cmNlID09PSBFeHByZXNzaW9uLkV2ZW50U291cmNlLkJpbmRpbmdEYXRhKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmV2ZW50SGFuZGxlclJlZ2lzdHJ5LmJpbmRpbmdEYXRhVmFsdWVDaGFuZ2VFdmVudEhhbmRsZXI7XG4gICAgICB9IGVsc2UgaWYgKGV2ZW50LnNvdXJjZSA9PT0gRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5GaWVsZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5ldmVudEhhbmRsZXJSZWdpc3RyeS5lbnRpdHlWYWx1ZUNoYW5nZWRFdmVudEhhbmRsZXI7XG4gICAgICB9IGVsc2UgaWYgKGV2ZW50LnNvdXJjZSA9PT0gRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5TdGF0ZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5ldmVudEhhbmRsZXJSZWdpc3RyeS5zdGF0ZVZhbHVlQ2hhbmdlZEV2ZW50SGFuZGxlcjtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGV2ZW50LnR5cGUgPT09IEV4cHJlc3Npb24uRXZlbnRUeXBlLkFwcGVuZCkge1xuICAgICAgaWYgKGV2ZW50LnNvdXJjZSA9PT0gRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5SZXBvc2l0b3J5IHx8IGV2ZW50LnNvdXJjZSA9PT0gRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5GaWVsZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5ldmVudEhhbmRsZXJSZWdpc3RyeS5yZXBvc2l0b3J5QWRkRW50aXR5RXZlbnRIYW5kbGVyO1xuICAgICAgfSBlbHNlIGlmIChldmVudC5zb3VyY2UgPT09IEV4cHJlc3Npb24uRXZlbnRTb3VyY2UuQmluZGluZ0RhdGEpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRIYW5kbGVyUmVnaXN0cnkuYmluZGluZ0RhdGFBcHBlbmRFbnRpdHlFdmVudEhhbmRsZXI7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChldmVudC50eXBlID09PSBFeHByZXNzaW9uLkV2ZW50VHlwZS5SZW1vdmUpIHtcbiAgICAgIGlmIChldmVudC5zb3VyY2UgPT09IEV4cHJlc3Npb24uRXZlbnRTb3VyY2UuUmVwb3NpdG9yeSB8fCBldmVudC5zb3VyY2UgPT09IEV4cHJlc3Npb24uRXZlbnRTb3VyY2UuRmllbGQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRIYW5kbGVyUmVnaXN0cnkucmVwb3NpdG9yeVJlbW92ZUVudGl0eUV2ZW50SGFuZGxlcjtcbiAgICAgIH0gZWxzZSBpZiAoZXZlbnQuc291cmNlID09PSBFeHByZXNzaW9uLkV2ZW50U291cmNlLkJpbmRpbmdEYXRhKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmV2ZW50SGFuZGxlclJlZ2lzdHJ5LmJpbmRpbmdEYXRhUmVtb3ZlT2JqZWN0RXZlbnRIYW5kbGVyO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZXZlbnQudHlwZSA9PT0gRXhwcmVzc2lvbi5FdmVudFR5cGUuVXBkYXRlKSB7XG4gICAgICBpZiAoZXZlbnQuc291cmNlID09PSBFeHByZXNzaW9uLkV2ZW50U291cmNlLlJlcG9zaXRvcnkpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRIYW5kbGVyUmVnaXN0cnkuZW50aXR5VXBkYXRlRXZlbnRIYW5kbGVyO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZXZlbnQudHlwZSA9PT0gRXhwcmVzc2lvbi5FdmVudFR5cGUuTG9hZCkge1xuICAgICAgaWYgKGV2ZW50LnNvdXJjZSA9PT0gRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5SZXBvc2l0b3J5IHx8IGV2ZW50LnNvdXJjZSA9PT0gRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5GaWVsZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5ldmVudEhhbmRsZXJSZWdpc3RyeS5yZXBvc2l0b3J5TG9hZEV2ZW50SGFuZGxlcjtcbiAgICAgIH0gZWxzZSBpZiAoZXZlbnQuc291cmNlID09PSBFeHByZXNzaW9uLkV2ZW50U291cmNlLkJpbmRpbmdEYXRhKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmV2ZW50SGFuZGxlclJlZ2lzdHJ5LmJpbmRpbmdEYXRhTG9hZEV2ZW50SGFuZGxlcjtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGV2ZW50LnR5cGUgPT09IEV4cHJlc3Npb24uRXZlbnRUeXBlLlNlbGVjdGlvbkNoYW5nZWQpIHtcbiAgICAgIGlmIChldmVudC5zb3VyY2UgPT09IEV4cHJlc3Npb24uRXZlbnRTb3VyY2UuQmluZGluZ0RhdGEpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRIYW5kbGVyUmVnaXN0cnkuYmluZGluZ0RhdGFTZWxlY3Rpb25DaGFuZ2VkSGFuZGxlcjtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cbiJdfQ==