import * as tslib_1 from "tslib";
import { EffectorManager } from "../effector/effector_manager";
import { Expression } from "../expression";
import { ENTITY_TEMPLATE } from "../resolver/index";
import { EventHandler } from "./event_handler";
/**
 * 删除数据时需要计算的表达式
 * 1、依赖被删除数据表的上级表达式（不考虑同表内的聚合依赖）
 */
var BindingDataRemoveObjectEventHandler = /** @class */ (function (_super) {
    tslib_1.__extends(BindingDataRemoveObjectEventHandler, _super);
    function BindingDataRemoveObjectEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    /**
     * 过滤出需要计算的表达式
     * @param event event
     * @returns
     */
    BindingDataRemoveObjectEventHandler.prototype.filter = function (event) {
        var _this = this;
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            // 找到聚合相关表达式
            var expressions = this.expressionObjects.filter(function (expressionObject) {
                if (expressionObject.ns !== event.ns || !expressionObject.deps || expressionObject.deps.length < 1) {
                    return false;
                }
                var info = _this.analysis(event, expressionObject);
                if (!info) {
                    return false;
                }
                // event.path like [id:xxxx] or [id:xxxx,子表s]
                var eventTablePaths = _this.buildEntityPath(event.path);
                // 主表删除
                if (eventTablePaths.length === 0) {
                    if (expressionObject.bindingType === Expression.ExpressionBindingType.Field) {
                        return false;
                    }
                }
                // 从表或从从表删除
                eventTablePaths.splice(0, 0, ENTITY_TEMPLATE);
                // eventEntityPath like ['ENTITY~','formEEUR1E1s'] // 从表新增
                // deps like ['ENTITY~/formEEUR1E1s/udt/udt_field','ENTITY~/formEEUR1E1s/ref/ref_udt/ref_udt_field']
                // 仅处理上级表达式
                if (info.eventTablePaths.length - 1 !== info.expressionTablePaths.length) {
                    return false;
                }
                // 不支持跨表
                if (!info.eventTablePaths.join(Expression.DEPENDENCY_SPLITER).startsWith(info.expressionTablePaths.join(Expression.DEPENDENCY_SPLITER))) {
                    return false;
                }
                var index = expressionObject.deps.findIndex(function (dep) {
                    // 依赖
                    if (!dep.startsWith(eventTablePaths.join(Expression.DEPENDENCY_SPLITER))) {
                        return false;
                    }
                    var deps = dep.split(Expression.DEPENDENCY_SPLITER).filter(function (p) { return p; }).slice(1);
                    var dependPathInfo = _this.getPathInfo(deps.join(Expression.DEPENDENCY_SPLITER));
                    if (dependPathInfo && dependPathInfo.paths.join(Expression.DEPENDENCY_SPLITER) === info.eventTablePaths.join(Expression.DEPENDENCY_SPLITER)) {
                        return true;
                    }
                    return false;
                });
                return index === -1 ? false : true;
            });
            return expressions;
        }
    };
    /**
     * 发布事件
     * @param event event
     */
    BindingDataRemoveObjectEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                var entityContext = _this.buildEntityContext(event, expressionObject);
                var context = _this.buildContext(expressionObject, event, entityContext);
                var result = _this.perform(expressionObject, context);
                if (result === undefined && !_this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = result;
                if (expressionObject.id) {
                    _this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                _this.effect(event, expressionObject);
            });
        }
    };
    /**
     * 删除副作用器
     * @param event event
     * @param expressionObject 表达式
     * @returns
     */
    BindingDataRemoveObjectEventHandler.prototype.effect = function (event, expressionObject) {
        var effectTo = expressionObject.bindingType;
        var eventPath = this.cleanEventPath(event.path);
        var effector = this.effectorFactory.getEffector(expressionObject);
        if (!effector) {
            return;
        }
        var info = this.analysis(event, expressionObject);
        if (!info) {
            console.warn("[BindingDataRemoveObjectEventHandler][analysis]\u83B7\u53D6\u8DEF\u5F84\u4FE1\u606F\u5931\u8D25\u3002");
            return;
        }
        var expressionPaths = expressionObject.path.split('/').filter(function (p) { return p; });
        if (effectTo === Expression.ExpressionBindingType.Field) {
            var paths = [];
            var propertyPaths = expressionPaths.slice(info.expressionTablePaths.length);
            // 删除场景仅需要计算事件表上面的表
            if (info.distance !== 0) {
                // 表达式和事件不在同一个表，即下级表删除了一批数据
                if (info.eventFromParent === true) {
                    // 在过滤时这种情况的应该就排除掉了
                    console.warn("[BindingDataRemoveObjectEventHandler][effect_error]");
                    return;
                }
                else if (info.eventFromChildren === true) {
                    var prevPaths = eventPath.slice(0, eventPath.length - 1);
                    var path = prevPaths.concat(propertyPaths);
                    paths.push(path);
                }
                else {
                    console.warn("[BindingDataRemoveObjectEventHandler][effect_error]");
                    return;
                }
            }
            EffectorManager.effect(effector, expressionObject, paths);
        }
        else if (effectTo === Expression.ExpressionBindingType.State) {
            console.error('not supported！');
        }
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    BindingDataRemoveObjectEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        return this.getCurrentRowByPaths(paths);
    };
    return BindingDataRemoveObjectEventHandler;
}(EventHandler));
export { BindingDataRemoveObjectEventHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19kYXRhX3JlbW92ZV9vYmplY3RfZXZlbnRfaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9leHByZXNzaW9uL2V2ZW50LWhhbmRsZXIvYmluZGluZ19kYXRhX3JlbW92ZV9vYmplY3RfZXZlbnRfaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRXBELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUUvQzs7O0dBR0c7QUFDSDtJQUF5RCwrREFBWTtJQUFyRTs7SUFpSUEsQ0FBQztJQS9IQzs7OztPQUlHO0lBQ0ksb0RBQU0sR0FBYixVQUFjLEtBQTJCO1FBQXpDLGlCQStDQztRQTlDQyxJQUFJLElBQUksQ0FBQyxpQkFBaUIsSUFBSSxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMvRCxZQUFZO1lBQ1osSUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxVQUFDLGdCQUE2QztnQkFDOUYsSUFBSSxnQkFBZ0IsQ0FBQyxFQUFFLEtBQUssS0FBSyxDQUFDLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtvQkFDbEcsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7Z0JBQ0QsSUFBTSxJQUFJLEdBQUcsS0FBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztnQkFDcEQsSUFBSSxDQUFDLElBQUksRUFBRTtvQkFDVCxPQUFPLEtB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R0FBM0IsVUFBNEIsS0FBZSxFQUFFLEtBQTJCO1FBQ3RFLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFDSCwwQ0FBQztBQUFELENBQUMsQUFqSUQsQ0FBeUQsWUFBWSxHQWlJcEUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFZmZlY3Rvck1hbmFnZXIgfSBmcm9tIFwiLi4vZWZmZWN0b3IvZWZmZWN0b3JfbWFuYWdlclwiO1xuaW1wb3J0IHsgRXhwcmVzc2lvbiB9IGZyb20gXCIuLi9leHByZXNzaW9uXCI7XG5pbXBvcnQgeyBFTlRJVFlfVEVNUExBVEUgfSBmcm9tIFwiLi4vcmVzb2x2ZXIvaW5kZXhcIjtcbmltcG9ydCB7IEV4cHJlc3Npb25VdGlsIH0gZnJvbSBcIi4uL3V0aWxzL2V4cHJlc3Npb25fdXRpbFwiO1xuaW1wb3J0IHsgRXZlbnRIYW5kbGVyIH0gZnJvbSBcIi4vZXZlbnRfaGFuZGxlclwiO1xuXG4vKipcbiAqIOWIoOmZpOaVsOaNruaXtumcgOimgeiuoeeul+eahOihqOi+vuW8j1xuICogMeOAgeS+nei1luiiq+WIoOmZpOaVsOaNruihqOeahOS4iue6p+ihqOi+vuW8j++8iOS4jeiAg+iZkeWQjOihqOWGheeahOiBmuWQiOS+nei1lu+8iVxuICovXG5leHBvcnQgY2xhc3MgQmluZGluZ0RhdGFSZW1vdmVPYmplY3RFdmVudEhhbmRsZXIgZXh0ZW5kcyBFdmVudEhhbmRsZXIge1xuXG4gIC8qKlxuICAgKiDov4fmu6Tlh7rpnIDopoHorqHnrpfnmoTooajovr7lvI9cbiAgICogQHBhcmFtIGV2ZW50IGV2ZW50XG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHVibGljIGZpbHRlcihldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MpIHtcbiAgICBpZiAodGhpcy5leHByZXNzaW9uT2JqZWN0cyAmJiB0aGlzLmV4cHJlc3Npb25PYmplY3RzLmxlbmd0aCA+IDApIHtcbiAgICAgIC8vIOaJvuWIsOiBmuWQiOebuOWFs+ihqOi+vuW8j1xuICAgICAgY29uc3QgZXhwcmVzc2lvbnMgPSB0aGlzLmV4cHJlc3Npb25PYmplY3RzLmZpbHRlcigoZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KSA9PiB7XG4gICAgICAgIGlmIChleHByZXNzaW9uT2JqZWN0Lm5zICE9PSBldmVudC5ucyB8fCAhZXhwcmVzc2lvbk9iamVjdC5kZXBzIHx8IGV4cHJlc3Npb25PYmplY3QuZGVwcy5sZW5ndGggPCAxKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGluZm8gPSB0aGlzLmFuYWx5c2lzKGV2ZW50LCBleHByZXNzaW9uT2JqZWN0KTtcbiAgICAgICAgaWYgKCFpbmZvKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIC8vIGV2ZW50LnBhdGggbGlrZSBbaWQ6eHh4eF0gb3IgW2lkOnh4eHgs5a2Q6KGoc11cbiAgICAgICAgY29uc3QgZXZlbnRUYWJsZVBhdGhzID0gdGhpcy5idWlsZEVudGl0eVBhdGgoZXZlbnQucGF0aCk7XG4gICAgICAgIC8vIOS4u+ihqOWIoOmZpFxuICAgICAgICBpZiAoZXZlbnRUYWJsZVBhdGhzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIGlmIChleHByZXNzaW9uT2JqZWN0LmJpbmRpbmdUeXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25CaW5kaW5nVHlwZS5GaWVsZCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyDku47ooajmiJbku47ku47ooajliKDpmaRcbiAgICAgICAgZXZlbnRUYWJsZVBhdGhzLnNwbGljZSgwLCAwLCBFTlRJVFlfVEVNUExBVEUpO1xuICAgICAgICAvLyBldmVudEVudGl0eVBhdGggbGlrZSBbJ0VOVElUWX4nLCdmb3JtRUVVUjFFMXMnXSAvLyDku47ooajmlrDlop5cbiAgICAgICAgLy8gZGVwcyBsaWtlIFsnRU5USVRZfi9mb3JtRUVVUjFFMXMvdWR0L3VkdF9maWVsZCcsJ0VOVElUWX4vZm9ybUVFVVIxRTFzL3JlZi9yZWZfdWR0L3JlZl91ZHRfZmllbGQnXVxuICAgICAgICAvLyDku4XlpITnkIbkuIrnuqfooajovr7lvI9cbiAgICAgICAgaWYgKGluZm8uZXZlbnRUYWJsZVBhdGhzLmxlbmd0aCAtIDEgIT09IGluZm8uZXhwcmVzc2lvblRhYmxlUGF0aHMubGVuZ3RoKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIC8vIOS4jeaUr+aMgei3qOihqFxuICAgICAgICBpZiAoIWluZm8uZXZlbnRUYWJsZVBhdGhzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpLnN0YXJ0c1dpdGgoaW5mby5leHByZXNzaW9uVGFibGVQYXRocy5qb2luKEV4cHJlc3Npb24uREVQRU5ERU5DWV9TUExJVEVSKSkpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgaW5kZXggPSBleHByZXNzaW9uT2JqZWN0LmRlcHMuZmluZEluZGV4KChkZXA6IHN0cmluZykgPT4ge1xuICAgICAgICAgIC8vIOS+nei1llxuICAgICAgICAgIGlmICghZGVwLnN0YXJ0c1dpdGgoZXZlbnRUYWJsZVBhdGhzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBkZXBzID0gZGVwLnNwbGl0KEV4cHJlc3Npb24uREVQRU5ERU5DWV9TUExJVEVSKS5maWx0ZXIocCA9PiBwKS5zbGljZSgxKTtcbiAgICAgICAgICBjb25zdCBkZXBlbmRQYXRoSW5mbyA9IHRoaXMuZ2V0UGF0aEluZm8oZGVwcy5qb2luKEV4cHJlc3Npb24uREVQRU5ERU5DWV9TUExJVEVSKSk7XG4gICAgICAgICAgaWYgKGRlcGVuZFBhdGhJbmZvICYmIGRlcGVuZFBhdGhJbmZvLnBhdGhzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpID09PSBpbmZvLmV2ZW50VGFibGVQYXRocy5qb2luKEV4cHJlc3Npb24uREVQRU5ERU5DWV9TUExJVEVSKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBpbmRleCA9PT0gLTEgPyBmYWxzZSA6IHRydWU7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBleHByZXNzaW9ucztcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOWPkeW4g+S6i+S7tlxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcbiAgICovXG4gIHB1YmxpYyBkaXNwYXRjaChldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MpIHtcbiAgICBjb25zdCBleHByZXNzaW9ucyA9IHRoaXMuZmlsdGVyKGV2ZW50KTtcbiAgICBpZiAoZXhwcmVzc2lvbnMgJiYgZXhwcmVzc2lvbnMubGVuZ3RoID4gMCkge1xuICAgICAgZXhwcmVzc2lvbnMuZm9yRWFjaCgoZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KSA9PiB7XG4gICAgICAgIGNvbnN0IGVudGl0eUNvbnRleHQgPSB0aGlzLmJ1aWxkRW50aXR5Q29udGV4dChldmVudCwgZXhwcmVzc2lvbk9iamVjdCk7XG4gICAgICAgIGNvbnN0IGNvbnRleHQgPSB0aGlzLmJ1aWxkQ29udGV4dChleHByZXNzaW9uT2JqZWN0LCBldmVudCwgZW50aXR5Q29udGV4dCk7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMucGVyZm9ybShleHByZXNzaW9uT2JqZWN0LCBjb250ZXh0KTtcbiAgICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkICYmICF0aGlzLmlzVmFsaWRhdGVPclJlcXVpcmVkRXhwcmVzc2lvbihleHByZXNzaW9uT2JqZWN0KSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCA9IHJlc3VsdDtcbiAgICAgICAgaWYgKGV4cHJlc3Npb25PYmplY3QuaWQpIHtcbiAgICAgICAgICB0aGlzLmV4cHJlc3Npb25SZXN1bHQuc2V0KGV4cHJlc3Npb25PYmplY3QuaWQsIGV4cHJlc3Npb25PYmplY3QucmVzdWx0KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmVmZmVjdChldmVudCwgZXhwcmVzc2lvbk9iamVjdCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOWIoOmZpOWJr+S9nOeUqOWZqFxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcbiAgICogQHBhcmFtIGV4cHJlc3Npb25PYmplY3Qg6KGo6L6+5byPXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHVibGljIGVmZmVjdChldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MsIGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCk6IHZvaWQge1xuICAgIGNvbnN0IGVmZmVjdFRvID0gZXhwcmVzc2lvbk9iamVjdC5iaW5kaW5nVHlwZTtcbiAgICBjb25zdCBldmVudFBhdGggPSB0aGlzLmNsZWFuRXZlbnRQYXRoKGV2ZW50LnBhdGgpO1xuICAgIGNvbnN0IGVmZmVjdG9yID0gdGhpcy5lZmZlY3RvckZhY3RvcnkuZ2V0RWZmZWN0b3IoZXhwcmVzc2lvbk9iamVjdCk7XG4gICAgaWYgKCFlZmZlY3Rvcikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBpbmZvID0gdGhpcy5hbmFseXNpcyhldmVudCwgZXhwcmVzc2lvbk9iamVjdCk7XG4gICAgaWYgKCFpbmZvKSB7XG4gICAgICBjb25zb2xlLndhcm4oYFtCaW5kaW5nRGF0YVJlbW92ZU9iamVjdEV2ZW50SGFuZGxlcl1bYW5hbHlzaXNd6I635Y+W6Lev5b6E5L+h5oGv5aSx6LSl44CCYCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGV4cHJlc3Npb25QYXRocyA9IGV4cHJlc3Npb25PYmplY3QucGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgIGlmIChlZmZlY3RUbyA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uQmluZGluZ1R5cGUuRmllbGQpIHtcbiAgICAgIGNvbnN0IHBhdGhzOiBhbnlbXVtdID0gW107XG4gICAgICBjb25zdCBwcm9wZXJ0eVBhdGhzID0gZXhwcmVzc2lvblBhdGhzLnNsaWNlKGluZm8uZXhwcmVzc2lvblRhYmxlUGF0aHMubGVuZ3RoKTtcbiAgICAgIC8vIOWIoOmZpOWcuuaZr+S7hemcgOimgeiuoeeul+S6i+S7tuihqOS4iumdoueahOihqFxuICAgICAgaWYgKGluZm8uZGlzdGFuY2UgIT09IDApIHtcbiAgICAgICAgLy8g6KGo6L6+5byP5ZKM5LqL5Lu25LiN5Zyo5ZCM5LiA5Liq6KGo77yM5Y2z5LiL57qn6KGo5Yig6Zmk5LqG5LiA5om55pWw5o2uXG4gICAgICAgIGlmIChpbmZvLmV2ZW50RnJvbVBhcmVudCA9PT0gdHJ1ZSkge1xuICAgICAgICAgIC8vIOWcqOi/h+a7pOaXtui/meenjeaDheWGteeahOW6lOivpeWwseaOkumZpOaOieS6hlxuICAgICAgICAgIGNvbnNvbGUud2FybihgW0JpbmRpbmdEYXRhUmVtb3ZlT2JqZWN0RXZlbnRIYW5kbGVyXVtlZmZlY3RfZXJyb3JdYCk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9IGVsc2UgaWYgKGluZm8uZXZlbnRGcm9tQ2hpbGRyZW4gPT09IHRydWUpIHtcbiAgICAgICAgICBjb25zdCBwcmV2UGF0aHMgPSBldmVudFBhdGguc2xpY2UoMCwgZXZlbnRQYXRoLmxlbmd0aCAtIDEpO1xuICAgICAgICAgIGNvbnN0IHBhdGggPSBwcmV2UGF0aHMuY29uY2F0KHByb3BlcnR5UGF0aHMpO1xuICAgICAgICAgIHBhdGhzLnB1c2gocGF0aCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKGBbQmluZGluZ0RhdGFSZW1vdmVPYmplY3RFdmVudEhhbmRsZXJdW2VmZmVjdF9lcnJvcl1gKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIEVmZmVjdG9yTWFuYWdlci5lZmZlY3QoZWZmZWN0b3IsIGV4cHJlc3Npb25PYmplY3QsIHBhdGhzKTtcbiAgICB9IGVsc2UgaWYgKGVmZmVjdFRvID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25CaW5kaW5nVHlwZS5TdGF0ZSkge1xuICAgICAgY29uc29sZS5lcnJvcignbm90IHN1cHBvcnRlZO+8gScpO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog6I635Y+W5a2Q6KGo5LqL5Lu26KGMXG4gICAqIEBwYXJhbSBwYXRocyBcbiAgICogQHBhcmFtIGV2ZW50IFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyBnZXRDdXJyZW50Um93QnlFdmVudChwYXRoczogc3RyaW5nW10sIGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncyk6IG51bGwgfCB7IFtwcm9wOiBzdHJpbmddOiBhbnkgfSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0Q3VycmVudFJvd0J5UGF0aHMocGF0aHMpO1xuICB9XG59Il19