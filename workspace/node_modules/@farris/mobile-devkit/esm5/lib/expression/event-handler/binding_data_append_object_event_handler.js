import * as tslib_1 from "tslib";
import { EffectorManager } from "../effector/effector_manager";
import { Expression } from "../expression/index";
import { ENTITY_TEMPLATE, STATE_TEMPLATE } from "../resolver/index";
import { EventHandler } from "./event_handler";
var BindingDataAppendObjectEventHandler = /** @class */ (function (_super) {
    tslib_1.__extends(BindingDataAppendObjectEventHandler, _super);
    function BindingDataAppendObjectEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    /**
     * 过滤出需要计算的表达式
     * @param event event
     * @returns
     */
    BindingDataAppendObjectEventHandler.prototype.filter = function (event) {
        var _this = this;
        // event.path like ["id:7dd77e50-ebed-4639-b483-d12004603640", "formEEUR1E1s"] or undefined or []
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            // const fullEventPath = event.path || [];
            // 找到聚合相关表达式(依赖新增表的表达式),聚合的前提是表达式path位于事件路径的上方
            // 给实体属性或vo变量设置了聚合相关的表达式，此时表达式依赖中路径到子表属性
            var groupExpressions = this.expressionObjects.filter(function (expressionObject) {
                if (expressionObject.ns !== event.ns || !expressionObject.deps || expressionObject.deps.length < 1) {
                    return false;
                }
                var eventTablePaths = _this.buildEntityPath(event.path);
                var info = _this.analysis(event, expressionObject);
                if (!info) {
                    return false;
                }
                // const eventEntityPath = this.buildEntityPath(event.path);
                // 主表新增
                if (eventTablePaths.length === 0) {
                    if (expressionObject.bindingType === Expression.ExpressionBindingType.Field) {
                        // 认为主表新增时不需要处理聚合函数
                        return false;
                    }
                }
                // 从表或从从表新增
                eventTablePaths.splice(0, 0, ENTITY_TEMPLATE);
                // eventEntityPath like ['ENTITY~','formEEUR1E1s'] // 从表新增
                // deps like ['ENTITY~/formEEUR1E1s/udt/udt_field','ENTITY~/formEEUR1E1s/ref/ref_udt/ref_udt_field']
                // 仅处理上级表达式
                if (info.eventTablePaths.length - 1 !== info.expressionTablePaths.length) {
                    return false;
                }
                // 不支持跨表
                if (!info.eventTablePaths.join(Expression.DEPENDENCY_SPLITER).startsWith(info.expressionTablePaths.join(Expression.DEPENDENCY_SPLITER))) {
                    return false;
                }
                var index = expressionObject.deps.findIndex(function (dep) {
                    // 依赖
                    if (!dep.startsWith(eventTablePaths.join(Expression.DEPENDENCY_SPLITER))) {
                        return false;
                    }
                    var deps = dep.split(Expression.DEPENDENCY_SPLITER).filter(function (p) { return p; }).slice(1);
                    var dependPathInfo = _this.getPathInfo(deps.join(Expression.DEPENDENCY_SPLITER));
                    if (dependPathInfo && dependPathInfo.paths.join(Expression.DEPENDENCY_SPLITER) === info.eventTablePaths.join(Expression.DEPENDENCY_SPLITER)) {
                        return true;
                    }
                    return false;
                });
                return index === -1 ? false : true;
            });
            var eventTablePaths_1 = this.buildEntityPath(event.path);
            // 事件表中表达式（事件表本身的表达式）
            var relativeExpressions = this.expressionObjects.filter(function (expressionObject) {
                // expressionObject.bindingType !== Expression.ExpressionBindingType.Field 暂不支持State表达式
                if (expressionObject.ns !== event.ns) {
                    return false;
                }
                var expressionPathInfo = _this.getPathInfo(expressionObject.path);
                // 过滤掉非当前表的表达式
                if (expressionPathInfo.paths.join(Expression.DEPENDENCY_SPLITER) !== eventTablePaths_1.join(Expression.DEPENDENCY_SPLITER)) {
                    return false;
                }
                // 没有依赖的表达式
                if (!expressionObject.deps || expressionObject.deps.length < 1) {
                    return true;
                }
                // 仅依赖State
                var onlyDependOnState = expressionObject.deps.every(function (dep) { return dep.startsWith(STATE_TEMPLATE); });
                // 仅依赖当前表或上级表
                // const onlyDependOnCurrentTable = expressionObject.deps.every((dep: string) => {
                //   if (!dep.startsWith(ENTITY_TEMPLATE)) {
                //     return false;
                //   }
                //   const deps = dep.split(Expression.DEPENDENCY_SPLITER).slice(1);
                //   const dependPathInfo = this.getPathInfo(deps.join(Expression.DEPENDENCY_SPLITER));
                //   return dependPathInfo.paths.join(Expression.DEPENDENCY_SPLITER) === eventTablePaths.join(Expression.DEPENDENCY_SPLITER) || eventTablePaths.join(Expression.DEPENDENCY_SPLITER).startsWith(dependPathInfo.paths.join(Expression.DEPENDENCY_SPLITER)) && dependPathInfo.paths.length + 1 == eventTablePaths.length;
                // });
                // if (onlyDependOnState || onlyDependOnCurrentTable) {
                //   return true;
                // }
                if (onlyDependOnState) {
                    return true;
                }
                var result = _this.analysis(event, expressionObject);
                if (result && result.distance === 0 && result.isSameTable) {
                    return true;
                }
                // 事件表表达式，但依赖下级表的未计算
                return false;
            });
            return groupExpressions.concat(relativeExpressions);
        }
        return null;
    };
    /**
     * 发布事件
     * @param event event
     */
    BindingDataAppendObjectEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                var entityContext = _this.buildEntityContext(event, expressionObject);
                var context = _this.buildContext(expressionObject, event, entityContext);
                var result = _this.perform(expressionObject, context);
                if (result === undefined && !_this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = result;
                if (expressionObject.id) {
                    _this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                else {
                    console.warn("EventHandler \u8868\u8FBE\u5F0F\u672A\u8BBE\u7F6E\u552F\u4E00\u6807\u8BC6\uFF0C\u65E0\u6CD5\u66F4\u65B0\u8868\u8FBE\u5F0F\u503C\u3002");
                }
                _this.effect(event, expressionObject);
            });
        }
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    BindingDataAppendObjectEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        return this.getCurrentRowByPaths(paths);
    };
    /**
     * 新增副作用器
     * @param event event
     * @param expressionObject 表达式
     * @returns
     */
    BindingDataAppendObjectEventHandler.prototype.effect = function (event, expressionObject) {
        var _this = this;
        var effectTo = expressionObject.bindingType;
        var eventPath = this.cleanEventPath(event.path);
        var effector = this.effectorFactory.getEffector(expressionObject);
        if (!effector) {
            return;
        }
        var info = this.analysis(event, expressionObject);
        if (!info) {
            console.warn("[BindingDataAppendObjectEventHandler][analysis]\u83B7\u53D6\u8DEF\u5F84\u4FE1\u606F\u5931\u8D25\u3002");
            return;
        }
        var expressionPaths = expressionObject.path.split('/').filter(function (p) { return p; });
        if (effectTo === Expression.ExpressionBindingType.Field) {
            var paths_1 = [];
            var propertyPaths_1 = expressionPaths.slice(info.expressionTablePaths.length);
            // 新增场景仅需要计算事件表及事件表上面的表
            if (info.distance === 0) {
                if (!info.isSameTable) {
                    return;
                }
                // 表达式和事件在同一个表
                var prevPaths_1 = eventPath.slice(0);
                if (eventPath.length === 1) {
                    // 主表新增，此时事件路径中有主键，直接拼接属性就是完整路径
                    if (event.value && Array.isArray(event.value)) {
                        event.value.forEach(function (bindingObject) {
                            paths_1.push([bindingObject.primaryKeyValue].concat(propertyPaths_1));
                        });
                    }
                    else {
                        var path = prevPaths_1.concat(propertyPaths_1);
                        paths_1.push(path);
                    }
                }
                else {
                    // 从表或从从表新增，此时事件路径中缺少最后一个层级的主键
                    if (event.value && Array.isArray(event.value)) {
                        event.value.forEach(function (bindingObject) {
                            paths_1.push(prevPaths_1.concat([bindingObject.primaryKeyValue]).concat(propertyPaths_1));
                        });
                    }
                    else {
                        var bindingList = this.bindingData.getValue(info.eventTablePaths);
                        if (bindingList && bindingList.currentId) {
                            paths_1.push(prevPaths_1.concat(bindingList.currentId).concat(propertyPaths_1));
                        }
                    }
                }
            }
            else {
                // 表达式和事件不在同一个表，即下级表新增或批量新增了一批数据
                if (info.eventFromParent === true) {
                    // 在过滤时这种情况的应该就排除掉了
                    console.warn("[BindingDataAppendObjectEventHandler][effect_error]");
                    return;
                }
                else if (info.eventFromChildren === true) {
                    var prevPaths = eventPath.slice(0, eventPath.length - 1);
                    var path = prevPaths.concat(propertyPaths_1);
                    paths_1.push(path);
                }
                else {
                    console.warn("[BindingDataAppendObjectEventHandler][effect_error]");
                    return;
                }
            }
            paths_1.forEach(function (path) {
                var currentRows = _this.buildCurrentRows(info.expressionTablePaths, path);
                _this.output(event, expressionObject, currentRows, effector, [path]);
            });
        }
        else if (effectTo === Expression.ExpressionBindingType.State) {
            console.error('not supported！');
        }
    };
    BindingDataAppendObjectEventHandler.prototype.output = function (event, expressionObject, currentRows, effector, paths) {
        var context = this.buildContext(expressionObject, event, null, currentRows);
        var value = this.perform(expressionObject, context);
        if (value === undefined) {
            return;
        }
        expressionObject.result = value;
        if (expressionObject.id) {
            this.expressionResult.set(expressionObject.id, expressionObject.result);
        }
        EffectorManager.effect(effector, tslib_1.__assign({ eventType: event.type }, expressionObject), paths);
    };
    return BindingDataAppendObjectEventHandler;
}(EventHandler));
export { BindingDataAppendObjectEventHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19kYXRhX2FwcGVuZF9vYmplY3RfZXZlbnRfaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9leHByZXNzaW9uL2V2ZW50LWhhbmRsZXIvYmluZGluZ19kYXRhX2FwcGVuZF9vYmplY3RfZXZlbnRfaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRXBFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUUvQztJQUF5RCwrREFBWTtJQUFyRTs7SUEyTkEsQ0FBQztJQTFOQzs7OztPQUlHO0lBQ0ksb0RBQU0sR0FBYixVQUFjLEtBQTJCO1FBQXpDLGlCQTRGQztRQTNGQyxpR0FBaUc7UUFDakcsSUFBSSxJQUFJLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDL0QsMENBQTBDO1lBQzFDLDhDQUE4QztZQUM5Qyx3Q0FBd0M7WUFDeEMsSUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLFVBQUMsZ0JBQTZDO2dCQUNuRyxJQUFJLGdCQUFnQixDQUFDLEVBQUUsS0FBSyxLQUFLLENBQUMsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxJQUFJLGdCQUFnQixDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO29CQUNsRyxPQUFPLEtBQUssQ0FBQztpQkFDZDtnQkFDRCxJQUFNLGVBQWUsR0FBRyxLQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FB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NkMsRUFBRSxXQUFxQyxFQUFFLFFBQTZCLEVBQUUsS0FBYztRQUM1SyxJQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDOUUsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN0RCxJQUFJLEtBQUssS0FBSyxTQUFTLEVBQUU7WUFDdkIsT0FBTztTQUNSO1FBQ0QsZ0JBQWdCLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNoQyxJQUFJLGdCQUFnQixDQUFDLEVBQUUsRUFBRTtZQUN2QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsRUFBRSxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUN6RTtRQUNELGVBQWUsQ0FBQyxNQUFNLENBQUMsUUFBUSxxQkFBSSxTQUFTLEVBQUUsS0FBSyxDQUFDLElBQUksSUFBSyxnQkFBZ0IsR0FBSSxLQUFLLENBQUMsQ0FBQztJQUMxRixDQUFDO0lBQ0gsMENBQUM7QUFBRCxDQUFDLEFBM05ELENBQXlELFlBQVksR0EyTnBFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmluZGluZ0xpc3QsIEJpbmRpbmdPYmplY3QgfSBmcm9tIFwiLi4vLi4vYmluZGluZy1kYXRhL2luZGV4XCI7XG5pbXBvcnQgeyBFZmZlY3Rvck1hbmFnZXIgfSBmcm9tIFwiLi4vZWZmZWN0b3IvZWZmZWN0b3JfbWFuYWdlclwiO1xuaW1wb3J0IHsgRXhwcmVzc2lvbiB9IGZyb20gXCIuLi9leHByZXNzaW9uL2luZGV4XCI7XG5pbXBvcnQgeyBFTlRJVFlfVEVNUExBVEUsIFNUQVRFX1RFTVBMQVRFIH0gZnJvbSBcIi4uL3Jlc29sdmVyL2luZGV4XCI7XG5pbXBvcnQgeyBFeHByZXNzaW9uVXRpbCB9IGZyb20gXCIuLi91dGlsc1wiO1xuaW1wb3J0IHsgRXZlbnRIYW5kbGVyIH0gZnJvbSBcIi4vZXZlbnRfaGFuZGxlclwiO1xuXG5leHBvcnQgY2xhc3MgQmluZGluZ0RhdGFBcHBlbmRPYmplY3RFdmVudEhhbmRsZXIgZXh0ZW5kcyBFdmVudEhhbmRsZXIge1xuICAvKipcbiAgICog6L+H5ruk5Ye66ZyA6KaB6K6h566X55qE6KGo6L6+5byPXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyBmaWx0ZXIoZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKTogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0W10ge1xuICAgIC8vIGV2ZW50LnBhdGggbGlrZSBbXCJpZDo3ZGQ3N2U1MC1lYmVkLTQ2MzktYjQ4My1kMTIwMDQ2MDM2NDBcIiwgXCJmb3JtRUVVUjFFMXNcIl0gb3IgdW5kZWZpbmVkIG9yIFtdXG4gICAgaWYgKHRoaXMuZXhwcmVzc2lvbk9iamVjdHMgJiYgdGhpcy5leHByZXNzaW9uT2JqZWN0cy5sZW5ndGggPiAwKSB7XG4gICAgICAvLyBjb25zdCBmdWxsRXZlbnRQYXRoID0gZXZlbnQucGF0aCB8fCBbXTtcbiAgICAgIC8vIOaJvuWIsOiBmuWQiOebuOWFs+ihqOi+vuW8jyjkvp3otZbmlrDlop7ooajnmoTooajovr7lvI8pLOiBmuWQiOeahOWJjeaPkOaYr+ihqOi+vuW8j3BhdGjkvY3kuo7kuovku7bot6/lvoTnmoTkuIrmlrlcbiAgICAgIC8vIOe7meWunuS9k+WxnuaAp+aIlnZv5Y+Y6YeP6K6+572u5LqG6IGa5ZCI55u45YWz55qE6KGo6L6+5byP77yM5q2k5pe26KGo6L6+5byP5L6d6LWW5Lit6Lev5b6E5Yiw5a2Q6KGo5bGe5oCnXG4gICAgICBjb25zdCBncm91cEV4cHJlc3Npb25zID0gdGhpcy5leHByZXNzaW9uT2JqZWN0cy5maWx0ZXIoKGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkgPT4ge1xuICAgICAgICBpZiAoZXhwcmVzc2lvbk9iamVjdC5ucyAhPT0gZXZlbnQubnMgfHwgIWV4cHJlc3Npb25PYmplY3QuZGVwcyB8fCBleHByZXNzaW9uT2JqZWN0LmRlcHMubGVuZ3RoIDwgMSkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBldmVudFRhYmxlUGF0aHMgPSB0aGlzLmJ1aWxkRW50aXR5UGF0aChldmVudC5wYXRoKTtcbiAgICAgICAgY29uc3QgaW5mbyA9IHRoaXMuYW5hbHlzaXMoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QpO1xuICAgICAgICBpZiAoIWluZm8pIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgLy8gY29uc3QgZXZlbnRFbnRpdHlQYXRoID0gdGhpcy5idWlsZEVudGl0eVBhdGgoZXZlbnQucGF0aCk7XG4gICAgICAgIC8vIOS4u+ihqOaWsOWinlxuICAgICAgICBpZiAoZXZlbnRUYWJsZVBhdGhzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIGlmIChleHByZXNzaW9uT2JqZWN0LmJpbmRpbmdUeXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25CaW5kaW5nVHlwZS5GaWVsZCkge1xuICAgICAgICAgICAgLy8g6K6k5Li65Li76KGo5paw5aKe5pe25LiN6ZyA6KaB5aSE55CG6IGa5ZCI5Ye95pWwXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIOS7juihqOaIluS7juS7juihqOaWsOWinlxuICAgICAgICBldmVudFRhYmxlUGF0aHMuc3BsaWNlKDAsIDAsIEVOVElUWV9URU1QTEFURSk7XG4gICAgICAgIC8vIGV2ZW50RW50aXR5UGF0aCBsaWtlIFsnRU5USVRZficsJ2Zvcm1FRVVSMUUxcyddIC8vIOS7juihqOaWsOWinlxuICAgICAgICAvLyBkZXBzIGxpa2UgWydFTlRJVFl+L2Zvcm1FRVVSMUUxcy91ZHQvdWR0X2ZpZWxkJywnRU5USVRZfi9mb3JtRUVVUjFFMXMvcmVmL3JlZl91ZHQvcmVmX3VkdF9maWVsZCddXG4gICAgICAgIC8vIOS7heWkhOeQhuS4iue6p+ihqOi+vuW8j1xuICAgICAgICBpZiAoaW5mby5ldmVudFRhYmxlUGF0aHMubGVuZ3RoIC0gMSAhPT0gaW5mby5leHByZXNzaW9uVGFibGVQYXRocy5sZW5ndGgpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgLy8g5LiN5pSv5oyB6Leo6KGoXG4gICAgICAgIGlmICghaW5mby5ldmVudFRhYmxlUGF0aHMuam9pbihFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikuc3RhcnRzV2l0aChpbmZvLmV4cHJlc3Npb25UYWJsZVBhdGhzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpKSkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBpbmRleCA9IGV4cHJlc3Npb25PYmplY3QuZGVwcy5maW5kSW5kZXgoKGRlcDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgLy8g5L6d6LWWXG4gICAgICAgICAgaWYgKCFkZXAuc3RhcnRzV2l0aChldmVudFRhYmxlUGF0aHMuam9pbihFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IGRlcHMgPSBkZXAuc3BsaXQoRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpLmZpbHRlcihwID0+IHApLnNsaWNlKDEpO1xuICAgICAgICAgIGNvbnN0IGRlcGVuZFBhdGhJbmZvID0gdGhpcy5nZXRQYXRoSW5mbyhkZXBzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpKTtcbiAgICAgICAgICBpZiAoZGVwZW5kUGF0aEluZm8gJiYgZGVwZW5kUGF0aEluZm8ucGF0aHMuam9pbihFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikgPT09IGluZm8uZXZlbnRUYWJsZVBhdGhzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGluZGV4ID09PSAtMSA/IGZhbHNlIDogdHJ1ZTtcbiAgICAgIH0pO1xuICAgICAgY29uc3QgZXZlbnRUYWJsZVBhdGhzID0gdGhpcy5idWlsZEVudGl0eVBhdGgoZXZlbnQucGF0aCk7XG4gICAgICAvLyDkuovku7booajkuK3ooajovr7lvI/vvIjkuovku7booajmnKzouqvnmoTooajovr7lvI/vvIlcbiAgICAgIGNvbnN0IHJlbGF0aXZlRXhwcmVzc2lvbnMgPSB0aGlzLmV4cHJlc3Npb25PYmplY3RzLmZpbHRlcigoZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KSA9PiB7XG4gICAgICAgIC8vIGV4cHJlc3Npb25PYmplY3QuYmluZGluZ1R5cGUgIT09IEV4cHJlc3Npb24uRXhwcmVzc2lvbkJpbmRpbmdUeXBlLkZpZWxkIOaaguS4jeaUr+aMgVN0YXRl6KGo6L6+5byPXG4gICAgICAgIGlmIChleHByZXNzaW9uT2JqZWN0Lm5zICE9PSBldmVudC5ucykge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBleHByZXNzaW9uUGF0aEluZm8gPSB0aGlzLmdldFBhdGhJbmZvKGV4cHJlc3Npb25PYmplY3QucGF0aCk7XG4gICAgICAgIC8vIOi/h+a7pOaOiemdnuW9k+WJjeihqOeahOihqOi+vuW8j1xuICAgICAgICBpZiAoZXhwcmVzc2lvblBhdGhJbmZvLnBhdGhzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpICE9PSBldmVudFRhYmxlUGF0aHMuam9pbihFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgLy8g5rKh5pyJ5L6d6LWW55qE6KGo6L6+5byPXG4gICAgICAgIGlmICghZXhwcmVzc2lvbk9iamVjdC5kZXBzIHx8IGV4cHJlc3Npb25PYmplY3QuZGVwcy5sZW5ndGggPCAxKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgLy8g5LuF5L6d6LWWU3RhdGVcbiAgICAgICAgY29uc3Qgb25seURlcGVuZE9uU3RhdGUgPSBleHByZXNzaW9uT2JqZWN0LmRlcHMuZXZlcnkoKGRlcDogc3RyaW5nKSA9PiBkZXAuc3RhcnRzV2l0aChTVEFURV9URU1QTEFURSkpO1xuICAgICAgICAvLyDku4Xkvp3otZblvZPliY3ooajmiJbkuIrnuqfooahcbiAgICAgICAgLy8gY29uc3Qgb25seURlcGVuZE9uQ3VycmVudFRhYmxlID0gZXhwcmVzc2lvbk9iamVjdC5kZXBzLmV2ZXJ5KChkZXA6IHN0cmluZykgPT4ge1xuICAgICAgICAvLyAgIGlmICghZGVwLnN0YXJ0c1dpdGgoRU5USVRZX1RFTVBMQVRFKSkge1xuICAgICAgICAvLyAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAvLyAgIH1cbiAgICAgICAgLy8gICBjb25zdCBkZXBzID0gZGVwLnNwbGl0KEV4cHJlc3Npb24uREVQRU5ERU5DWV9TUExJVEVSKS5zbGljZSgxKTtcbiAgICAgICAgLy8gICBjb25zdCBkZXBlbmRQYXRoSW5mbyA9IHRoaXMuZ2V0UGF0aEluZm8oZGVwcy5qb2luKEV4cHJlc3Npb24uREVQRU5ERU5DWV9TUExJVEVSKSk7XG4gICAgICAgIC8vICAgcmV0dXJuIGRlcGVuZFBhdGhJbmZvLnBhdGhzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpID09PSBldmVudFRhYmxlUGF0aHMuam9pbihFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikgfHwgZXZlbnRUYWJsZVBhdGhzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpLnN0YXJ0c1dpdGgoZGVwZW5kUGF0aEluZm8ucGF0aHMuam9pbihFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikpICYmIGRlcGVuZFBhdGhJbmZvLnBhdGhzLmxlbmd0aCArIDEgPT0gZXZlbnRUYWJsZVBhdGhzLmxlbmd0aDtcbiAgICAgICAgLy8gfSk7XG4gICAgICAgIC8vIGlmIChvbmx5RGVwZW5kT25TdGF0ZSB8fCBvbmx5RGVwZW5kT25DdXJyZW50VGFibGUpIHtcbiAgICAgICAgLy8gICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgLy8gfVxuICAgICAgICBpZiAob25seURlcGVuZE9uU3RhdGUpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLmFuYWx5c2lzKGV2ZW50LCBleHByZXNzaW9uT2JqZWN0KTtcbiAgICAgICAgaWYgKHJlc3VsdCAmJiByZXN1bHQuZGlzdGFuY2UgPT09IDAgJiYgcmVzdWx0LmlzU2FtZVRhYmxlKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgLy8g5LqL5Lu26KGo6KGo6L6+5byP77yM5L2G5L6d6LWW5LiL57qn6KGo55qE5pyq6K6h566XXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIGdyb3VwRXhwcmVzc2lvbnMuY29uY2F0KHJlbGF0aXZlRXhwcmVzc2lvbnMpO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICAvKipcbiAgICog5Y+R5biD5LqL5Lu2XG4gICAqIEBwYXJhbSBldmVudCBldmVudFxuICAgKi9cbiAgcHVibGljIGRpc3BhdGNoKGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncykge1xuICAgIGNvbnN0IGV4cHJlc3Npb25zID0gdGhpcy5maWx0ZXIoZXZlbnQpO1xuICAgIGlmIChleHByZXNzaW9ucyAmJiBleHByZXNzaW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICBleHByZXNzaW9ucy5mb3JFYWNoKChleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpID0+IHtcbiAgICAgICAgY29uc3QgZW50aXR5Q29udGV4dCA9IHRoaXMuYnVpbGRFbnRpdHlDb250ZXh0KGV2ZW50LCBleHByZXNzaW9uT2JqZWN0KTtcbiAgICAgICAgY29uc3QgY29udGV4dCA9IHRoaXMuYnVpbGRDb250ZXh0KGV4cHJlc3Npb25PYmplY3QsIGV2ZW50LCBlbnRpdHlDb250ZXh0KTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5wZXJmb3JtKGV4cHJlc3Npb25PYmplY3QsIGNvbnRleHQpO1xuICAgICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQgJiYgIXRoaXMuaXNWYWxpZGF0ZU9yUmVxdWlyZWRFeHByZXNzaW9uKGV4cHJlc3Npb25PYmplY3QpKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGV4cHJlc3Npb25PYmplY3QucmVzdWx0ID0gcmVzdWx0O1xuICAgICAgICBpZiAoZXhwcmVzc2lvbk9iamVjdC5pZCkge1xuICAgICAgICAgIHRoaXMuZXhwcmVzc2lvblJlc3VsdC5zZXQoZXhwcmVzc2lvbk9iamVjdC5pZCwgZXhwcmVzc2lvbk9iamVjdC5yZXN1bHQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUud2FybihgRXZlbnRIYW5kbGVyIOihqOi+vuW8j+acquiuvue9ruWUr+S4gOagh+ivhu+8jOaXoOazleabtOaWsOihqOi+vuW8j+WAvOOAgmApO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZWZmZWN0KGV2ZW50LCBleHByZXNzaW9uT2JqZWN0KTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog6I635Y+W5a2Q6KGo5LqL5Lu26KGMXG4gICAqIEBwYXJhbSBwYXRocyBcbiAgICogQHBhcmFtIGV2ZW50IFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyBnZXRDdXJyZW50Um93QnlFdmVudChwYXRoczogc3RyaW5nW10sIGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncyk6IG51bGwgfCB7IFtwcm9wOiBzdHJpbmddOiBhbnkgfSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0Q3VycmVudFJvd0J5UGF0aHMocGF0aHMpO1xuICB9XG4gIC8qKlxuICAgKiDmlrDlop7lia/kvZznlKjlmahcbiAgICogQHBhcmFtIGV2ZW50IGV2ZW50XG4gICAqIEBwYXJhbSBleHByZXNzaW9uT2JqZWN0IOihqOi+vuW8j1xuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyBlZmZlY3QoZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzLCBleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpOiB2b2lkIHtcbiAgICBjb25zdCBlZmZlY3RUbyA9IGV4cHJlc3Npb25PYmplY3QuYmluZGluZ1R5cGU7XG4gICAgY29uc3QgZXZlbnRQYXRoID0gdGhpcy5jbGVhbkV2ZW50UGF0aChldmVudC5wYXRoKTtcbiAgICBjb25zdCBlZmZlY3RvciA9IHRoaXMuZWZmZWN0b3JGYWN0b3J5LmdldEVmZmVjdG9yKGV4cHJlc3Npb25PYmplY3QpO1xuICAgIGlmICghZWZmZWN0b3IpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgaW5mbyA9IHRoaXMuYW5hbHlzaXMoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QpO1xuICAgIGlmICghaW5mbykge1xuICAgICAgY29uc29sZS53YXJuKGBbQmluZGluZ0RhdGFBcHBlbmRPYmplY3RFdmVudEhhbmRsZXJdW2FuYWx5c2lzXeiOt+WPlui3r+W+hOS/oeaBr+Wksei0peOAgmApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBleHByZXNzaW9uUGF0aHMgPSBleHByZXNzaW9uT2JqZWN0LnBhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcbiAgICBpZiAoZWZmZWN0VG8gPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvbkJpbmRpbmdUeXBlLkZpZWxkKSB7XG4gICAgICBjb25zdCBwYXRoczogYW55W11bXSA9IFtdO1xuICAgICAgY29uc3QgcHJvcGVydHlQYXRocyA9IGV4cHJlc3Npb25QYXRocy5zbGljZShpbmZvLmV4cHJlc3Npb25UYWJsZVBhdGhzLmxlbmd0aCk7XG4gICAgICAvLyDmlrDlop7lnLrmma/ku4XpnIDopoHorqHnrpfkuovku7booajlj4rkuovku7booajkuIrpnaLnmoTooahcbiAgICAgIGlmIChpbmZvLmRpc3RhbmNlID09PSAwKSB7XG4gICAgICAgIGlmICghaW5mby5pc1NhbWVUYWJsZSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICAvLyDooajovr7lvI/lkozkuovku7blnKjlkIzkuIDkuKrooahcbiAgICAgICAgY29uc3QgcHJldlBhdGhzID0gZXZlbnRQYXRoLnNsaWNlKDApO1xuICAgICAgICBpZiAoZXZlbnRQYXRoLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgIC8vIOS4u+ihqOaWsOWinu+8jOatpOaXtuS6i+S7tui3r+W+hOS4reacieS4u+mUru+8jOebtOaOpeaLvOaOpeWxnuaAp+WwseaYr+WujOaVtOi3r+W+hFxuICAgICAgICAgIGlmIChldmVudC52YWx1ZSAmJiBBcnJheS5pc0FycmF5KGV2ZW50LnZhbHVlKSkge1xuICAgICAgICAgICAgZXZlbnQudmFsdWUuZm9yRWFjaCgoYmluZGluZ09iamVjdDogQmluZGluZ09iamVjdCkgPT4ge1xuICAgICAgICAgICAgICBwYXRocy5wdXNoKFtiaW5kaW5nT2JqZWN0LnByaW1hcnlLZXlWYWx1ZV0uY29uY2F0KHByb3BlcnR5UGF0aHMpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBwYXRoID0gcHJldlBhdGhzLmNvbmNhdChwcm9wZXJ0eVBhdGhzKTtcbiAgICAgICAgICAgIHBhdGhzLnB1c2gocGF0aCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIOS7juihqOaIluS7juS7juihqOaWsOWinu+8jOatpOaXtuS6i+S7tui3r+W+hOS4ree8uuWwkeacgOWQjuS4gOS4quWxgue6p+eahOS4u+mUrlxuICAgICAgICAgIGlmIChldmVudC52YWx1ZSAmJiBBcnJheS5pc0FycmF5KGV2ZW50LnZhbHVlKSkge1xuICAgICAgICAgICAgZXZlbnQudmFsdWUuZm9yRWFjaCgoYmluZGluZ09iamVjdDogQmluZGluZ09iamVjdCkgPT4ge1xuICAgICAgICAgICAgICBwYXRocy5wdXNoKHByZXZQYXRocy5jb25jYXQoW2JpbmRpbmdPYmplY3QucHJpbWFyeUtleVZhbHVlXSkuY29uY2F0KHByb3BlcnR5UGF0aHMpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBiaW5kaW5nTGlzdCA9IHRoaXMuYmluZGluZ0RhdGEuZ2V0VmFsdWUoaW5mby5ldmVudFRhYmxlUGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xuICAgICAgICAgICAgaWYgKGJpbmRpbmdMaXN0ICYmIGJpbmRpbmdMaXN0LmN1cnJlbnRJZCkge1xuICAgICAgICAgICAgICBwYXRocy5wdXNoKHByZXZQYXRocy5jb25jYXQoYmluZGluZ0xpc3QuY3VycmVudElkKS5jb25jYXQocHJvcGVydHlQYXRocykpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8g6KGo6L6+5byP5ZKM5LqL5Lu25LiN5Zyo5ZCM5LiA5Liq6KGo77yM5Y2z5LiL57qn6KGo5paw5aKe5oiW5om56YeP5paw5aKe5LqG5LiA5om55pWw5o2uXG4gICAgICAgIGlmIChpbmZvLmV2ZW50RnJvbVBhcmVudCA9PT0gdHJ1ZSkge1xuICAgICAgICAgIC8vIOWcqOi/h+a7pOaXtui/meenjeaDheWGteeahOW6lOivpeWwseaOkumZpOaOieS6hlxuICAgICAgICAgIGNvbnNvbGUud2FybihgW0JpbmRpbmdEYXRhQXBwZW5kT2JqZWN0RXZlbnRIYW5kbGVyXVtlZmZlY3RfZXJyb3JdYCk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9IGVsc2UgaWYgKGluZm8uZXZlbnRGcm9tQ2hpbGRyZW4gPT09IHRydWUpIHtcbiAgICAgICAgICBjb25zdCBwcmV2UGF0aHMgPSBldmVudFBhdGguc2xpY2UoMCwgZXZlbnRQYXRoLmxlbmd0aCAtIDEpO1xuICAgICAgICAgIGNvbnN0IHBhdGggPSBwcmV2UGF0aHMuY29uY2F0KHByb3BlcnR5UGF0aHMpO1xuICAgICAgICAgIHBhdGhzLnB1c2gocGF0aCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKGBbQmluZGluZ0RhdGFBcHBlbmRPYmplY3RFdmVudEhhbmRsZXJdW2VmZmVjdF9lcnJvcl1gKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHBhdGhzLmZvckVhY2goKHBhdGg6IGFueVtdKSA9PiB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRSb3dzID0gdGhpcy5idWlsZEN1cnJlbnRSb3dzKGluZm8uZXhwcmVzc2lvblRhYmxlUGF0aHMsIHBhdGgpO1xuICAgICAgICB0aGlzLm91dHB1dChldmVudCwgZXhwcmVzc2lvbk9iamVjdCwgY3VycmVudFJvd3MsIGVmZmVjdG9yLCBbcGF0aF0pO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChlZmZlY3RUbyA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uQmluZGluZ1R5cGUuU3RhdGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ25vdCBzdXBwb3J0ZWTvvIEnKTtcbiAgICB9XG4gIH1cbiAgcHVibGljIG91dHB1dChldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MsIGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCwgY3VycmVudFJvd3M6IEV4cHJlc3Npb24uSUN1cnJlbnRSb3dbXSwgZWZmZWN0b3I6IEV4cHJlc3Npb24uRWZmZWN0b3IsIHBhdGhzOiBhbnlbXVtdKSB7XG4gICAgY29uc3QgY29udGV4dCA9IHRoaXMuYnVpbGRDb250ZXh0KGV4cHJlc3Npb25PYmplY3QsIGV2ZW50LCBudWxsLCBjdXJyZW50Um93cyk7XG4gICAgY29uc3QgdmFsdWUgPSB0aGlzLnBlcmZvcm0oZXhwcmVzc2lvbk9iamVjdCwgY29udGV4dCk7XG4gICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZXhwcmVzc2lvbk9iamVjdC5yZXN1bHQgPSB2YWx1ZTtcbiAgICBpZiAoZXhwcmVzc2lvbk9iamVjdC5pZCkge1xuICAgICAgdGhpcy5leHByZXNzaW9uUmVzdWx0LnNldChleHByZXNzaW9uT2JqZWN0LmlkLCBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCk7XG4gICAgfVxuICAgIEVmZmVjdG9yTWFuYWdlci5lZmZlY3QoZWZmZWN0b3IsIHsgZXZlbnRUeXBlOiBldmVudC50eXBlLCAuLi5leHByZXNzaW9uT2JqZWN0IH0sIHBhdGhzKTtcbiAgfVxufSJdfQ==