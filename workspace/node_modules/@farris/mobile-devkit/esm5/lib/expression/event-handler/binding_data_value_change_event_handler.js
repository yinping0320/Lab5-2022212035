import * as tslib_1 from "tslib";
import { EffectorManager } from '../effector/effector_manager';
import { EntityList } from '../../entity/index';
import { ENTITY_TEMPLATE } from '../resolver/index';
import { ExpressionUtil } from '../utils/expression_util';
import { EventHandler } from './event_handler';
var BindingDataValueChangeEventHandler = /** @class */ (function (_super) {
    tslib_1.__extends(BindingDataValueChangeEventHandler, _super);
    function BindingDataValueChangeEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    BindingDataValueChangeEventHandler.prototype.filter = function (event) {
        var _this = this;
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            return this.expressionObjects.filter(function (expressionObject) {
                var deps = expressionObject.deps;
                if (!deps || deps.length < 1 || event.ns !== expressionObject.ns) {
                    return false;
                }
                var eventEntityPaths = _this.getEntityPath(event.path);
                eventEntityPaths.splice(0, 0, ENTITY_TEMPLATE);
                return deps.includes(eventEntityPaths.join('/'));
            });
        }
        return null;
    };
    /**
     * 发布事件
     * @param event event
     */
    BindingDataValueChangeEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                _this.effect(event, expressionObject);
            });
        }
    };
    /**
     * 输出副作用
     * @param event event
     * @param expressionObject 表达式
     * @returns
     */
    BindingDataValueChangeEventHandler.prototype.effect = function (event, expressionObject) {
        var e_1, _a;
        // 首先计算当前表达式和事件会影响那些路径
        var effector = this.effectorFactory.getEffector(expressionObject);
        if (!effector) {
            return;
        }
        var result = this.analysis(event, expressionObject);
        if (!result) {
            return;
        }
        var eventPaths = this.cleanEventPath(event.path);
        var paths = [];
        if (result.distance === 0) {
            // 值变化之后影响到了一个表内字段或影响到了同级表字段
            if (result.isSameTable === false) {
                // 同级表跳过
                console.warn("[BindingDataValueChangeEventHandler]\u4E0D\u652F\u6301\u591A\u5BF9\u591A\u5173\u7CFB\u3002");
                return;
            }
            var prevPaths = eventPaths.slice(0, eventPaths.length - result.eventPropertyNames.length);
            var path = prevPaths.concat(result.expressionPropertyNames);
            var currentRows = this.buildCurrentRows(result.eventTablePaths, path);
            paths.push(path);
            this.output(event, expressionObject, currentRows, effector, paths);
        }
        else {
            if (result.eventFromChildren === true) {
                if (result.distance > 1) {
                    return;
                }
                // 下级表值变化影响到了上级表的表达式
                var prevPaths = eventPaths.slice(0, eventPaths.length - result.eventPropertyNames.length - 2);
                var path = prevPaths.concat(result.expressionPropertyNames);
                paths.push(path);
                var currentRows = this.buildCurrentRows(result.eventTablePaths, eventPaths);
                this.output(event, expressionObject, currentRows, effector, paths);
            }
            else if (result.eventFromParent === true) {
                if (result.distance > 1) {
                    console.warn("[BindingDataValueChangeEventHandler]\u4E0D\u652F\u6301\u591A\u5BF9\u591A\u5173\u7CFB\u3002");
                    return;
                }
                // 上级表值变化影响到了下级表的表达式
                var prevPaths = eventPaths.slice(0, eventPaths.length - result.eventPropertyNames.length);
                // 添加下级表nodecode到路径中
                prevPaths.push(result.expressionTablePaths.slice(0).pop());
                // 遍历子表
                var bindingPaths = result.expressionTablePaths;
                var primaryKeyValue = eventPaths[0];
                if (!primaryKeyValue) {
                    return;
                }
                var object = this.frameContext.repository.entityCollection.getEntityById(primaryKeyValue);
                // prevPaths like [1,c,1.1,cc]
                for (var index = 1; index < prevPaths.length; index++) {
                    var propertyName = prevPaths[index];
                    if (object instanceof EntityList) {
                        object = object.get(propertyName);
                    }
                    else {
                        object = object[propertyName];
                    }
                }
                var list = object;
                if (list && list instanceof EntityList && list.count() > 0) {
                    try {
                        for (var list_1 = tslib_1.__values(list), list_1_1 = list_1.next(); !list_1_1.done; list_1_1 = list_1.next()) {
                            var entity = list_1_1.value;
                            if (entity && entity.primaryValue) {
                                var path = prevPaths.concat([entity.primaryValue]).concat(result.expressionPropertyNames);
                                var currentRows = this.buildCurrentRows(result.expressionTablePaths, path);
                                this.output(event, expressionObject, currentRows, effector, [path]);
                            }
                        }
                    }
                    catch (e_1_1) { e_1 = { error: e_1_1 }; }
                    finally {
                        try {
                            if (list_1_1 && !list_1_1.done && (_a = list_1.return)) _a.call(list_1);
                        }
                        finally { if (e_1) throw e_1.error; }
                    }
                }
            }
            else {
                // 跨表
            }
        }
    };
    BindingDataValueChangeEventHandler.prototype.output = function (event, expressionObject, currentRows, effector, paths) {
        var context = this.buildContext(expressionObject, event, null, currentRows);
        var value = this.perform(expressionObject, context);
        if (value === undefined) {
            return;
        }
        expressionObject.result = value;
        if (expressionObject.id) {
            this.expressionResult.set(expressionObject.id, expressionObject.result);
        }
        EffectorManager.effect(effector, expressionObject, paths);
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    BindingDataValueChangeEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        event = JSON.parse(JSON.stringify(event));
        var result = null;
        var bindingList = this.bindingData.getValue(paths);
        var eventEntityPath = this.getEntityPath(event.path);
        if (bindingList && bindingList.length > 0) {
            var primaryValue = bindingList.currentItem.primaryKeyValue || null;
            // 使用事件中的主键
            var childrenPaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(eventEntityPath, this.repository.entityTypeInfo);
            if (childrenPaths && childrenPaths.toString() === paths.toString()) {
                // 发生值变化的数据位于要获取当前行的子表中，此时事件行应该是发生值变化的数据id，而不是当前行id
                primaryValue = event.id || null;
                if (!primaryValue) {
                    primaryValue = this.getEventId(event.path, paths[paths.length - 1]);
                }
            }
            if (primaryValue) {
                var bindingObject = bindingList.findById(primaryValue);
                if (bindingObject) {
                    result = bindingObject.toJSON();
                }
            }
        }
        return result;
    };
    return BindingDataValueChangeEventHandler;
}(EventHandler));
export { BindingDataValueChangeEventHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19kYXRhX3ZhbHVlX2NoYW5nZV9ldmVudF9oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2V4cHJlc3Npb24vZXZlbnQtaGFuZGxlci9iaW5kaW5nX2RhdGFfdmFsdWVfY2hhbmdlX2V2ZW50X2hhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUcvRCxPQUFPLEVBQVUsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFeEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFL0M7SUFBd0QsOERBQVk7SUFBcEU7O0lBMEpBLENBQUM7SUF4SlEsbURBQU0sR0FBYixVQUFjLEtBQTJCO1FBQXpDLGlCQWFDO1FBWkMsSUFBSSxJQUFJLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDL0QsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLFVBQUMsZ0JBQTZDO2dCQUNqRixJQUFNLElBQUksR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUM7Z0JBQ25DLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksS0FBSyxDQUFDLEVBQUUsS0FBSyxnQkFBZ0IsQ0FBQyxFQUFFLEVBQUU7b0JBQ2hFLE9BQU8sS0FBSyxDQUFDO2lCQUNkO2dCQUNELElBQU0sZ0JBQWdCLEdBQUcsS0FBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3hELGdCQUFnQixDQUFDLE1BQU0s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QVksR0FBRyxLQUFLLENBQUMsRUFBRSxJQUFJLElBQUksQ0FBQztnQkFDaEMsSUFBSSxDQUFDLFlBQVksRUFBRTtvQkFDakIsWUFBWSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNyRTthQUNGO1lBQ0QsSUFBSSxZQUFZLEVBQUU7Z0JBQ2hCLElBQU0sYUFBYSxHQUFHLFdBQVcsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBQ3pELElBQUksYUFBYSxFQUFFO29CQUNqQixNQUFNLEdBQUcsYUFBYSxDQUFDLE1BQU0sRUFBRSxDQUFDO2lCQUNqQzthQUNGO1NBQ0Y7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBQ0gseUNBQUM7QUFBRCxDQUFDLEFBMUpELENBQXdELFlBQVksR0EwSm5FIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWZmZWN0b3JNYW5hZ2VyIH0gZnJvbSAnLi4vZWZmZWN0b3IvZWZmZWN0b3JfbWFuYWdlcic7XG5pbXBvcnQgeyBCaW5kaW5nTGlzdCB9IGZyb20gJy4uLy4uL2JpbmRpbmctZGF0YS9pbmRleCc7XG5pbXBvcnQgeyBEYXRhUHJvcEluZm8gfSBmcm9tICcuLi8uLi9lbnRpdHkvaW5kZXgnO1xuaW1wb3J0IHsgRW50aXR5LCBFbnRpdHlMaXN0IH0gZnJvbSAnLi4vLi4vZW50aXR5L2luZGV4JztcbmltcG9ydCB7IEV4cHJlc3Npb24gfSBmcm9tICcuLi9leHByZXNzaW9uL2luZGV4JztcbmltcG9ydCB7IEVOVElUWV9URU1QTEFURSB9IGZyb20gJy4uL3Jlc29sdmVyL2luZGV4JztcbmltcG9ydCB7IEV4cHJlc3Npb25VdGlsIH0gZnJvbSAnLi4vdXRpbHMvZXhwcmVzc2lvbl91dGlsJztcbmltcG9ydCB7IEV2ZW50SGFuZGxlciB9IGZyb20gJy4vZXZlbnRfaGFuZGxlcic7XG5cbmV4cG9ydCBjbGFzcyBCaW5kaW5nRGF0YVZhbHVlQ2hhbmdlRXZlbnRIYW5kbGVyIGV4dGVuZHMgRXZlbnRIYW5kbGVyIHtcblxuICBwdWJsaWMgZmlsdGVyKGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncykge1xuICAgIGlmICh0aGlzLmV4cHJlc3Npb25PYmplY3RzICYmIHRoaXMuZXhwcmVzc2lvbk9iamVjdHMubGVuZ3RoID4gMCkge1xuICAgICAgcmV0dXJuIHRoaXMuZXhwcmVzc2lvbk9iamVjdHMuZmlsdGVyKChleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpID0+IHtcbiAgICAgICAgY29uc3QgZGVwcyA9IGV4cHJlc3Npb25PYmplY3QuZGVwcztcbiAgICAgICAgaWYgKCFkZXBzIHx8IGRlcHMubGVuZ3RoIDwgMSB8fCBldmVudC5ucyAhPT0gZXhwcmVzc2lvbk9iamVjdC5ucykge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBldmVudEVudGl0eVBhdGhzID0gdGhpcy5nZXRFbnRpdHlQYXRoKGV2ZW50LnBhdGgpO1xuICAgICAgICBldmVudEVudGl0eVBhdGhzLnNwbGljZSgwLCAwLCBFTlRJVFlfVEVNUExBVEUpO1xuICAgICAgICByZXR1cm4gZGVwcy5pbmNsdWRlcyhldmVudEVudGl0eVBhdGhzLmpvaW4oJy8nKSk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICAvKipcbiAgICog5Y+R5biD5LqL5Lu2XG4gICAqIEBwYXJhbSBldmVudCBldmVudFxuICAgKi9cbiAgcHVibGljIGRpc3BhdGNoKGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncykge1xuICAgIGNvbnN0IGV4cHJlc3Npb25zID0gdGhpcy5maWx0ZXIoZXZlbnQpO1xuICAgIGlmIChleHByZXNzaW9ucyAmJiBleHByZXNzaW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICBleHByZXNzaW9ucy5mb3JFYWNoKChleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpID0+IHtcbiAgICAgICAgdGhpcy5lZmZlY3QoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOi+k+WHuuWJr+S9nOeUqFxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcbiAgICogQHBhcmFtIGV4cHJlc3Npb25PYmplY3Qg6KGo6L6+5byPXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHVibGljIGVmZmVjdChldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MsIGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCk6IHZvaWQge1xuICAgIC8vIOmmluWFiOiuoeeul+W9k+WJjeihqOi+vuW8j+WSjOS6i+S7tuS8muW9seWTjemCo+S6m+i3r+W+hFxuICAgIGNvbnN0IGVmZmVjdG9yID0gdGhpcy5lZmZlY3RvckZhY3RvcnkuZ2V0RWZmZWN0b3IoZXhwcmVzc2lvbk9iamVjdCk7XG4gICAgaWYgKCFlZmZlY3Rvcikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmFuYWx5c2lzKGV2ZW50LCBleHByZXNzaW9uT2JqZWN0KTtcbiAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBldmVudFBhdGhzID0gdGhpcy5jbGVhbkV2ZW50UGF0aChldmVudC5wYXRoKTtcbiAgICBjb25zdCBwYXRoczogYW55W11bXSA9IFtdO1xuICAgIGlmIChyZXN1bHQuZGlzdGFuY2UgPT09IDApIHtcbiAgICAgIC8vIOWAvOWPmOWMluS5i+WQjuW9seWTjeWIsOS6huS4gOS4quihqOWGheWtl+auteaIluW9seWTjeWIsOS6huWQjOe6p+ihqOWtl+autVxuICAgICAgaWYgKHJlc3VsdC5pc1NhbWVUYWJsZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgLy8g5ZCM57qn6KGo6Lez6L+HXG4gICAgICAgIGNvbnNvbGUud2FybihgW0JpbmRpbmdEYXRhVmFsdWVDaGFuZ2VFdmVudEhhbmRsZXJd5LiN5pSv5oyB5aSa5a+55aSa5YWz57O744CCYCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHByZXZQYXRocyA9IGV2ZW50UGF0aHMuc2xpY2UoMCwgZXZlbnRQYXRocy5sZW5ndGggLSByZXN1bHQuZXZlbnRQcm9wZXJ0eU5hbWVzLmxlbmd0aCk7XG4gICAgICBjb25zdCBwYXRoID0gcHJldlBhdGhzLmNvbmNhdChyZXN1bHQuZXhwcmVzc2lvblByb3BlcnR5TmFtZXMpO1xuICAgICAgY29uc3QgY3VycmVudFJvd3MgPSB0aGlzLmJ1aWxkQ3VycmVudFJvd3MocmVzdWx0LmV2ZW50VGFibGVQYXRocywgcGF0aCk7XG4gICAgICBwYXRocy5wdXNoKHBhdGgpO1xuICAgICAgdGhpcy5vdXRwdXQoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QsIGN1cnJlbnRSb3dzLCBlZmZlY3RvciwgcGF0aHMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAocmVzdWx0LmV2ZW50RnJvbUNoaWxkcmVuID09PSB0cnVlKSB7XG4gICAgICAgIGlmIChyZXN1bHQuZGlzdGFuY2UgPiAxKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIC8vIOS4i+e6p+ihqOWAvOWPmOWMluW9seWTjeWIsOS6huS4iue6p+ihqOeahOihqOi+vuW8j1xuICAgICAgICBjb25zdCBwcmV2UGF0aHMgPSBldmVudFBhdGhzLnNsaWNlKDAsIGV2ZW50UGF0aHMubGVuZ3RoIC0gcmVzdWx0LmV2ZW50UHJvcGVydHlOYW1lcy5sZW5ndGggLSAyKTtcbiAgICAgICAgY29uc3QgcGF0aCA9IHByZXZQYXRocy5jb25jYXQocmVzdWx0LmV4cHJlc3Npb25Qcm9wZXJ0eU5hbWVzKTtcbiAgICAgICAgcGF0aHMucHVzaChwYXRoKTtcbiAgICAgICAgY29uc3QgY3VycmVudFJvd3MgPSB0aGlzLmJ1aWxkQ3VycmVudFJvd3MocmVzdWx0LmV2ZW50VGFibGVQYXRocywgZXZlbnRQYXRocyk7XG4gICAgICAgIHRoaXMub3V0cHV0KGV2ZW50LCBleHByZXNzaW9uT2JqZWN0LCBjdXJyZW50Um93cywgZWZmZWN0b3IsIHBhdGhzKTtcbiAgICAgIH0gZWxzZSBpZiAocmVzdWx0LmV2ZW50RnJvbVBhcmVudCA9PT0gdHJ1ZSkge1xuICAgICAgICBpZiAocmVzdWx0LmRpc3RhbmNlID4gMSkge1xuICAgICAgICAgIGNvbnNvbGUud2FybihgW0JpbmRpbmdEYXRhVmFsdWVDaGFuZ2VFdmVudEhhbmRsZXJd5LiN5pSv5oyB5aSa5a+55aSa5YWz57O744CCYCk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIC8vIOS4iue6p+ihqOWAvOWPmOWMluW9seWTjeWIsOS6huS4i+e6p+ihqOeahOihqOi+vuW8j1xuICAgICAgICBjb25zdCBwcmV2UGF0aHMgPSBldmVudFBhdGhzLnNsaWNlKDAsIGV2ZW50UGF0aHMubGVuZ3RoIC0gcmVzdWx0LmV2ZW50UHJvcGVydHlOYW1lcy5sZW5ndGgpO1xuICAgICAgICAvLyDmt7vliqDkuIvnuqfooahub2RlY29kZeWIsOi3r+W+hOS4rVxuICAgICAgICBwcmV2UGF0aHMucHVzaChyZXN1bHQuZXhwcmVzc2lvblRhYmxlUGF0aHMuc2xpY2UoMCkucG9wKCkpO1xuICAgICAgICAvLyDpgY3ljoblrZDooahcbiAgICAgICAgY29uc3QgYmluZGluZ1BhdGhzID0gcmVzdWx0LmV4cHJlc3Npb25UYWJsZVBhdGhzO1xuICAgICAgICBjb25zdCBwcmltYXJ5S2V5VmFsdWUgPSBldmVudFBhdGhzWzBdO1xuICAgICAgICBpZiAoIXByaW1hcnlLZXlWYWx1ZSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBsZXQgb2JqZWN0ID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0eUJ5SWQocHJpbWFyeUtleVZhbHVlKTtcbiAgICAgICAgLy8gcHJldlBhdGhzIGxpa2UgWzEsYywxLjEsY2NdXG4gICAgICAgIGZvciAobGV0IGluZGV4ID0gMTsgaW5kZXggPCBwcmV2UGF0aHMubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gcHJldlBhdGhzW2luZGV4XTtcbiAgICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgRW50aXR5TGlzdCkge1xuICAgICAgICAgICAgb2JqZWN0ID0gb2JqZWN0LmdldChwcm9wZXJ0eU5hbWUpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvYmplY3QgPSBvYmplY3RbcHJvcGVydHlOYW1lXTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgbGlzdCA9IG9iamVjdDtcbiAgICAgICAgaWYgKGxpc3QgJiYgbGlzdCBpbnN0YW5jZW9mIEVudGl0eUxpc3QgJiYgbGlzdC5jb3VudCgpID4gMCkge1xuICAgICAgICAgIGZvciAobGV0IGVudGl0eSBvZiBsaXN0KSB7XG4gICAgICAgICAgICBpZiAoZW50aXR5ICYmIGVudGl0eS5wcmltYXJ5VmFsdWUpIHtcbiAgICAgICAgICAgICAgY29uc3QgcGF0aCA9IHByZXZQYXRocy5jb25jYXQoW2VudGl0eS5wcmltYXJ5VmFsdWVdKS5jb25jYXQocmVzdWx0LmV4cHJlc3Npb25Qcm9wZXJ0eU5hbWVzKTtcbiAgICAgICAgICAgICAgY29uc3QgY3VycmVudFJvd3MgPSB0aGlzLmJ1aWxkQ3VycmVudFJvd3MocmVzdWx0LmV4cHJlc3Npb25UYWJsZVBhdGhzLCBwYXRoKTtcbiAgICAgICAgICAgICAgdGhpcy5vdXRwdXQoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QsIGN1cnJlbnRSb3dzLCBlZmZlY3RvciwgW3BhdGhdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIOi3qOihqFxuICAgICAgfVxuICAgIH1cbiAgfVxuICBwdWJsaWMgb3V0cHV0KGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncywgZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0LCBjdXJyZW50Um93czogRXhwcmVzc2lvbi5JQ3VycmVudFJvd1tdLCBlZmZlY3RvcjogRXhwcmVzc2lvbi5FZmZlY3RvciwgcGF0aHM6IGFueVtdW10pIHtcbiAgICBjb25zdCBjb250ZXh0ID0gdGhpcy5idWlsZENvbnRleHQoZXhwcmVzc2lvbk9iamVjdCwgZXZlbnQsIG51bGwsIGN1cnJlbnRSb3dzKTtcbiAgICBjb25zdCB2YWx1ZSA9IHRoaXMucGVyZm9ybShleHByZXNzaW9uT2JqZWN0LCBjb250ZXh0KTtcbiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCA9IHZhbHVlO1xuICAgIGlmIChleHByZXNzaW9uT2JqZWN0LmlkKSB7XG4gICAgICB0aGlzLmV4cHJlc3Npb25SZXN1bHQuc2V0KGV4cHJlc3Npb25PYmplY3QuaWQsIGV4cHJlc3Npb25PYmplY3QucmVzdWx0KTtcbiAgICB9XG4gICAgRWZmZWN0b3JNYW5hZ2VyLmVmZmVjdChlZmZlY3RvciwgZXhwcmVzc2lvbk9iamVjdCwgcGF0aHMpO1xuICB9XG4gIC8qKlxuICAgKiDojrflj5blrZDooajkuovku7booYxcbiAgICogQHBhcmFtIHBhdGhzIFxuICAgKiBAcGFyYW0gZXZlbnQgXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHVibGljIGdldEN1cnJlbnRSb3dCeUV2ZW50KHBhdGhzOiBzdHJpbmdbXSwgZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKTogbnVsbCB8IHsgW3Byb3A6IHN0cmluZ106IGFueSB9IHtcbiAgICBldmVudCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTtcbiAgICBsZXQgcmVzdWx0ID0gbnVsbDtcbiAgICBjb25zdCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QgPSB0aGlzLmJpbmRpbmdEYXRhLmdldFZhbHVlKHBhdGhzKSBhcyBCaW5kaW5nTGlzdDtcbiAgICBjb25zdCBldmVudEVudGl0eVBhdGggPSB0aGlzLmdldEVudGl0eVBhdGgoZXZlbnQucGF0aCk7XG4gICAgaWYgKGJpbmRpbmdMaXN0ICYmIGJpbmRpbmdMaXN0Lmxlbmd0aCA+IDApIHtcbiAgICAgIGxldCBwcmltYXJ5VmFsdWUgPSBiaW5kaW5nTGlzdC5jdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWUgfHwgbnVsbDtcbiAgICAgIC8vIOS9v+eUqOS6i+S7tuS4reeahOS4u+mUrlxuICAgICAgY29uc3QgY2hpbGRyZW5QYXRocyA9IEV4cHJlc3Npb25VdGlsLmdldEF2YWlsYWJsZUNoaWxkcmVuUGF0aHNGcm9tRW50aXR5UGF0aHMoZXZlbnRFbnRpdHlQYXRoLCB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8pO1xuICAgICAgaWYgKGNoaWxkcmVuUGF0aHMgJiYgY2hpbGRyZW5QYXRocy50b1N0cmluZygpID09PSBwYXRocy50b1N0cmluZygpKSB7XG4gICAgICAgIC8vIOWPkeeUn+WAvOWPmOWMlueahOaVsOaNruS9jeS6juimgeiOt+WPluW9k+WJjeihjOeahOWtkOihqOS4re+8jOatpOaXtuS6i+S7tuihjOW6lOivpeaYr+WPkeeUn+WAvOWPmOWMlueahOaVsOaNrmlk77yM6ICM5LiN5piv5b2T5YmN6KGMaWRcbiAgICAgICAgcHJpbWFyeVZhbHVlID0gZXZlbnQuaWQgfHwgbnVsbDtcbiAgICAgICAgaWYgKCFwcmltYXJ5VmFsdWUpIHtcbiAgICAgICAgICBwcmltYXJ5VmFsdWUgPSB0aGlzLmdldEV2ZW50SWQoZXZlbnQucGF0aCwgcGF0aHNbcGF0aHMubGVuZ3RoIC0gMV0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAocHJpbWFyeVZhbHVlKSB7XG4gICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBiaW5kaW5nTGlzdC5maW5kQnlJZChwcmltYXJ5VmFsdWUpO1xuICAgICAgICBpZiAoYmluZGluZ09iamVjdCkge1xuICAgICAgICAgIHJlc3VsdCA9IGJpbmRpbmdPYmplY3QudG9KU09OKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxufSJdfQ==