import * as tslib_1 from "tslib";
import { AppContext } from '../../app/index';
import { EffectorFactory } from '../effector/index';
import { Expression, ExpressionExecutor, ExpressionRegistry, ExpressionResult } from '../expression/index';
import { ExpressionUtil } from '../utils/expression_util';
var EventHandler = /** @class */ (function () {
    function EventHandler(frameContext) {
        this.frameContext = frameContext;
        this.injector = frameContext.injector;
        this.repository = frameContext.repository;
        this.bindingData = frameContext.bindingData;
        this.expressionRegistry = this.injector.get(ExpressionRegistry, null);
        this.effectorFactory = this.injector.get(EffectorFactory, null);
        this.expressionExecutor = this.injector.get(ExpressionExecutor);
        this.expressionResult = this.injector.get(ExpressionResult, null);
    }
    EventHandler.prototype.handleEvent = function (event, expressionObjects) {
        event = Object.assign({}, event);
        this.expressionObjects = expressionObjects;
        this.dispatch(event);
    };
    Object.defineProperty(EventHandler.prototype, "primaryValue", {
        //#endregion
        //#region 属性
        /**
         * 主表主键值
         */
        get: function () {
            return this.bindingData.list.currentItem.primaryKeyValue;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EventHandler.prototype, "entityOriginalNodeCode", {
        /**
         * 获取主实体原始字段名
         */
        get: function () {
            return this.repository && this.repository.entityTypeInfo && this.repository.entityTypeInfo.entityInfo && this.repository.entityTypeInfo.entityInfo.originalCode || null;
        },
        enumerable: true,
        configurable: true
    });
    //#endregion
    //#region 表达式核心
    /**
     * 执行表达式计算
     * @param expression 表达式
     * @param context 上下文
     * @returns any
     */
    EventHandler.prototype.perform = function (expressionObject, context) {
        return this.expressionExecutor.compile(expressionObject, context);
    };
    /**
     * 副作用
     * @param event event
     * @param expressionObject expressionObject
     */
    EventHandler.prototype.effect = function (event, expressionObject) {
        var effectTo = expressionObject.bindingType;
        var effector = this.effectorFactory.getEffector(expressionObject);
        if (!effector) {
            // console.warn(`EventHandler 没有对应的副作用器。${expressionObject.type}`);
            return;
        }
        if (effectTo === Expression.ExpressionBindingType.Field) {
            var effectPaths = expressionObject.effectPaths || [];
            if (effectPaths.length > 0) {
                effectPaths.forEach(function (path) {
                    var effectPath = path.split('/');
                    var effectOptions = { path: effectPath, message: expressionObject.message, expressionId: expressionObject.id, eventType: event.type, viewModelId: expressionObject.viewModelId };
                    effector.effect(expressionObject.path, expressionObject.result, effectOptions);
                });
            }
            else if (expressionObject.type === Expression.ExpressionType.Required || expressionObject.type === Expression.ExpressionType.Validate || expressionObject.type === Expression.ExpressionType.Readonly || expressionObject.type === Expression.ExpressionType.Visible) {
                var effectOptions = { message: expressionObject.message, expressionId: expressionObject.id, eventType: event.type, viewModelId: expressionObject.viewModelId };
                effector.effect(expressionObject.path, expressionObject.result, effectOptions);
            }
        }
        else {
            throw new Error('not supported！');
        }
    };
    //#endregion
    //#region util
    EventHandler.prototype.isValidateOrRequiredExpression = function (expressionObject) {
        return expressionObject && (expressionObject.type === Expression.ExpressionType.Validate || expressionObject.type === Expression.ExpressionType.Required);
    };
    /**
     * 以事件参数为依据构建实体路径
     * @param event event
     * @returns
     */
    EventHandler.prototype.getEntityPathFromEvent = function (event) {
        event = JSON.parse(JSON.stringify(event));
        if (!event || !event.path || event.path.length < 1) {
            return [];
        }
        var paths = event.path;
        return this.getEntityPath(paths);
    };
    /**
     * 获取事件路径中的实体路径
     * @param path path
     * @returns
     */
    EventHandler.prototype.getEntityPath = function (path) {
        var paths = path.filter(function (value, index) {
            if (index % 2 === 0 && value.includes(':')) {
                return false;
            }
            else {
                return true;
            }
        });
        return paths;
    };
    /**
     * 构造实体路径
     * @param path path
     * @description 删除路径中的id字段
     * @returns
     */
    EventHandler.prototype.buildEntityPath = function (path) {
        var paths = path.filter(function (value, index) {
            if (index % 2 === 0 && value.includes(':')) {
                return false;
            }
            else {
                return true;
            }
        });
        return paths;
    };
    /**
     * 清理事件路径中的id主键标识
     * @param path path
     * @returns
     */
    EventHandler.prototype.cleanEventPath = function (path) {
        path = path.filter(function (p) {
            if (p && p !== ':') {
                return true;
            }
            else {
                return false;
            }
        });
        return path.map(function (item) {
            if (item.includes(':')) {
                return item.split(':')[1];
            }
            else {
                return item;
            }
        });
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    EventHandler.prototype.getCurrentRowByPaths = function (paths) {
        var result = null;
        var bindingList = this.bindingData.getValue(paths);
        if (bindingList && bindingList.length > 0) {
            var primaryValue = bindingList.currentItem.primaryKeyValue || null;
            if (primaryValue) {
                var bindingObject = bindingList.findById(primaryValue);
                if (bindingObject) {
                    result = bindingObject.toJSON();
                }
            }
        }
        return result;
    };
    /**
     * 获取事件路径中指定子表的事件行
     * @param path
     * @param tableCode
     * @returns
     */
    EventHandler.prototype.getEventId = function (path, tableCode) {
        if (!path || path.length < 1) {
            throw new Error('invalid path!');
        }
        var propertyIndex = path.findIndex(function (p) { return p === tableCode; });
        if (propertyIndex === -1) {
            return null;
        }
        var idIndex = propertyIndex + 1;
        if (idIndex > path.length - 1) {
            throw new Error('invalid propertyName or path');
        }
        var id = path[idIndex];
        if (id.indexOf(':') === -1) {
            throw new Error('compute error.');
        }
        return id.split(':')[1];
    };
    //#endregion
    //#region  构造上下文
    /**
     * 构造变量上下文
     * @param event
     * @returns
     */
    EventHandler.prototype.buildStateContext = function (event) {
        var ns = event.ns;
        var appContext = this.injector.get(AppContext, null);
        var frameContexts = appContext.viewModelContextManager.getContextsByNamespace(ns);
        var result = {};
        if (frameContexts && frameContexts.length > 0) {
            var anonymousFrameContext = frameContexts[0];
            var rootFrameContext = anonymousFrameContext.getVirtualRootFrameContext();
            if (rootFrameContext) {
                var uiState_1 = rootFrameContext.viewModel.uiState;
                var propertyNames = Object.getOwnPropertyNames(uiState_1) || [];
                propertyNames.forEach(function (prop) {
                    if (prop.match(/^[a-zA-Z0-9_\$]+$/g) !== null) {
                        result[prop] = uiState_1[prop];
                    }
                });
            }
        }
        return result;
    };
    /**
     * 获取事件实体
     * @param event
     * @returns
     */
    EventHandler.prototype.buildEntityContext = function (event, expressionObject, currentRows) {
        var _this = this;
        var expressionBindingType = expressionObject.bindingType;
        if (expressionBindingType === Expression.ExpressionBindingType.Field) {
            var entityTypeInfo = this.repository.entityTypeInfo;
            var childrenEntityPaths = [];
            ExpressionUtil.getChildrenEntityPaths(entityTypeInfo, childrenEntityPaths);
            // 获取当前行
            var row = currentRows && currentRows.find(function (row) { return row.bindingPath === '' || row.bindingPath === '/'; }) || null;
            var primaryValue = row && row.primaryValue || this.bindingData.list.currentId;
            var entity = this.bindingData.list.findById(primaryValue);
            if (!entity) {
                return null;
            }
            var object_1 = entity.toJSON();
            object_1['__type__'] = 'Entity';
            if (!childrenEntityPaths || childrenEntityPaths.length < 1) {
                return object_1;
            }
            childrenEntityPaths.sort(function (v1, v2) { return v1.length - v2.length; });
            // 找到所有子表
            childrenEntityPaths.forEach(function (paths) {
                var bindingList = _this.bindingData.getValue(paths);
                var currentRowId = bindingList.currentId;
                var propertyName = paths[paths.length - 1];
                // parent 为entity或entitylist或null
                var parent = paths.slice(0, paths.length - 1).reduce(function (object, path) {
                    return object && object[path] || null;
                }, object_1);
                if (!parent) {
                    return;
                }
                var data = parent;
                var node = null;
                if (!currentRowId) {
                    // 当前表没有数据
                    node = { __items__: [], __type__: 'List' };
                    node.length = function () { return node.__items__.length; };
                }
                else {
                    // 纠正当前行
                    if (currentRows && currentRows.length > 0) {
                        // 是否指定了当前行
                        var userAssignCurrentRow = currentRows.find(function (row) {
                            var bindingPaths = row.bindingPath.split('/').filter(function (p) { return p; });
                            return bindingPaths.join('/') === paths.join('/');
                        });
                        if (userAssignCurrentRow) {
                            currentRowId = userAssignCurrentRow.primaryValue;
                        }
                    }
                    // 子表当前行
                    var row_1 = bindingList.findById(currentRowId);
                    // 找到子表当前行的上级
                    var list = parent[propertyName];
                    node = tslib_1.__assign({ __items__: [] }, row_1 && row_1.toJSON() || {}, { __type__: 'List' });
                    node.length = function () { return node.__items__.length; };
                    if (list && Array.isArray(list)) {
                        node.__items__ = [].concat(list);
                    }
                }
                data[propertyName] = node;
            });
            return object_1;
        }
        else if (expressionBindingType === Expression.ExpressionBindingType.State) {
            // todo: 支持状态表达式
        }
        else {
            return null;
        }
    };
    /**
     * 构造表达式计算上下文
     * @param expressionObject 表达式
     * @param event 事件
     * @param entityContext 实体上下文
     * @param currentRows 当前行
     * @returns
     */
    EventHandler.prototype.buildContext = function (expressionObject, event, entityContext, currentRows) {
        var _a;
        var context = [];
        if (entityContext) {
            context.push(entityContext);
        }
        else {
            var entity_1 = this.buildEntityContext(event, expressionObject, currentRows);
            context.push(entity_1);
        }
        var stateContext = this.buildStateContext(event);
        var entityCode = this.entityOriginalNodeCode;
        var entity = null;
        if (context.length === 1) {
            entity = context.pop();
        }
        else {
            entity = context[0];
            if (!entity['__type__']) {
                entity['__type__'] = 'Entity';
            }
            entity['__items__'] = context;
        }
        return tslib_1.__assign((_a = {}, _a[entityCode] = entity, _a), stateContext, { frameContext: this.frameContext, bindingData: this.bindingData, repository: this.repository });
    };
    //#endregion
    /**
     * 构造副作用路径
     * @param event
     * @param expressionObject
     * @returns
     */
    EventHandler.prototype.buildEffectPath = function (event, expressionObject) {
        var expressionPaths = expressionObject.path.split('/').filter(function (p) { return p; });
        var primaryValue = event.path[0] && event.path[0].split(':')[1];
        if (!primaryValue) {
            throw new Error('Invalid event path!');
        }
        if (expressionPaths.length === 1) {
            // 主表简单字段
            return [primaryValue, expressionPaths.pop()];
        }
        else {
            var result = [primaryValue];
            for (var index = 0; index < expressionPaths.length; index++) {
                var propertyName = expressionPaths[index];
                result.push(propertyName);
                var currentPaths = expressionPaths.slice(0, index + 1);
                var propertyInfo = this.repository.entityTypeInfo.getPropInfoByPath(currentPaths);
                if (propertyInfo.group === 'List') {
                    var id = this.getEventId(event.path, propertyInfo.name) || null;
                    // 事件和表达式不是同一个表
                    if (!id) {
                        var bindingList = this.bindingData.getValue(currentPaths);
                        if (bindingList) {
                            id = bindingList.currentId;
                        }
                    }
                    result.push(id);
                }
            }
            return result;
        }
    };
    //#region 辅助方法
    EventHandler.prototype.getPathInfo = function (path) {
        var paths = path.split('/').filter(function (p) { return p; });
        // 获取最大实体层级，其余为属性（简单属性、udt、关联、关联嵌套关联）
        var entityPath = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(paths, this.repository.entityTypeInfo);
        var propertyName = paths.slice(entityPath.length).join('/');
        return { path: entityPath.join('/'), propertyName: propertyName, paths: entityPath, propertyNames: propertyName.split('/').filter(function (p) { return p; }) };
    };
    /**
     * get table paths from event paths
     * @param paths event paths
     * @returns
     */
    EventHandler.prototype.getTablePathsFromEventPaths = function (paths) {
        paths = this.getEntityPath(paths);
        var entityPaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(paths, this.repository.entityTypeInfo);
        return entityPaths;
    };
    /**
     * get property paths from event paths
     * @param paths event paths
     * @returns
     */
    EventHandler.prototype.getPropertyPathsFromEventPaths = function (paths) {
        paths = this.getEntityPath(paths);
        var tablePaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(paths, this.repository.entityTypeInfo);
        return paths.slice(tablePaths.length);
    };
    /**
     * 分析事件和表达式的关系
     */
    EventHandler.prototype.analysis = function (event, expressionObject) {
        var expressionPathInfo = this.getPathInfo(expressionObject.path);
        var eventPaths = this.getEntityPath(event.path.slice(0));
        var eventPathInfo = this.getPathInfo(eventPaths.join('/'));
        if (!expressionPathInfo || !eventPathInfo) {
            console.warn("\u8868\u8FBE\u5F0F\u8DEF\u5F84\u6216\u4E8B\u4EF6\u8DEF\u5F84\u9519\u8BEF\uFF0C\u83B7\u53D6\u8DEF\u5F84\u4FE1\u606F\u5931\u8D25\u3002");
            return null;
        }
        var expressionTablePaths = expressionPathInfo.path.split('/').filter(function (p) { return p; });
        var expressionPropertyNames = expressionPathInfo.propertyName.split('/').filter(function (p) { return p; });
        var eventTablePaths = eventPathInfo.path.split('/').filter(function (p) { return p; });
        var eventPropertyNames = eventPathInfo.propertyName.split('/').filter(function (p) { return p; });
        var result = {
            distance: undefined,
            eventFromChildren: undefined,
            eventFromParent: undefined,
            expressionTablePaths: expressionTablePaths,
            expressionPropertyNames: expressionPropertyNames,
            eventTablePaths: eventTablePaths,
            eventPropertyNames: eventPropertyNames,
            isSameTable: false
        };
        result.distance = Math.abs(expressionTablePaths.length - eventTablePaths.length);
        if (result.distance === 1) {
            result.eventFromChildren = eventTablePaths.length > expressionTablePaths.length && eventTablePaths.join('/').startsWith(expressionTablePaths.join('/'));
            result.eventFromParent = eventTablePaths.length < expressionTablePaths.length && expressionTablePaths.join('/').startsWith(eventTablePaths.join('/'));
        }
        result.isSameTable = expressionTablePaths.join('/') === eventTablePaths.join('/');
        return result;
    };
    EventHandler.prototype.buildCurrentRows = function (tablePaths, fullPaths) {
        var currentRows = new Array();
        if (!tablePaths || tablePaths.length < 1) {
            currentRows.push({
                bindingPath: '/',
                primaryValue: fullPaths[0]
            });
        }
        else {
            var paths_1 = [];
            tablePaths.forEach(function (path, index) {
                if (index === 0) {
                    currentRows.push({
                        bindingPath: '/',
                        primaryValue: fullPaths[0]
                    });
                }
                paths_1.push(path);
                var primaryValue = fullPaths[index * 2 + 2];
                currentRows.push({
                    bindingPath: paths_1.join('/'),
                    primaryValue: primaryValue
                });
            });
        }
        return currentRows;
    };
    return EventHandler;
}());
export { EventHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnRfaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9leHByZXNzaW9uL2V2ZW50LWhhbmRsZXIvZXZlbnRfaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRzdDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsVUFBVSxFQUFFLGtCQUFrQixFQUFFLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFHM0csT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRTFEO0lBZ0JFLHNCQUFzQixZQUE4QjtRQUE5QixpQkFBWSxHQUFaLFlBQVksQ0FBa0I7UUFDbEQsSUFBSSxDQUFDLFFBQVEsR0FBRyxZQUFZLENBQUMsUUFBUSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxVQUFVLEdBQUcsWUFBWSxDQUFDLFVBQVUsQ0FBQztRQUMxQyxJQUFJLENBQUMsV0FBVyxHQUFHLFlBQVksQ0FBQyxXQUFXLENBQUM7UUFDNUMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGtCQUFrQixFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3RFLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUVwRSxDQUFD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LENBQUM7cUJBQzNCLENBQUMsQ0FBQztpQkFDSjtnQkFDRCxPQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNqQixJQUFNLFlBQVksR0FBRyxTQUFTLENBQUMsS0FBSyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDOUMsV0FBVyxDQUFDLElBQUksQ0FBQztvQkFDZixXQUFXLEVBQUUsT0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7b0JBQzVCLFlBQVksRUFBRSxZQUFZO2lCQUMzQixDQUFDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBQ0QsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztJQUVILG1CQUFDO0FBQUQsQ0FBQyxBQXplRCxJQXllQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdG9yIH0gZnJvbSAnLi4vLi4vY29yZS9pbmRleCc7XG5pbXBvcnQgeyBBcHBDb250ZXh0IH0gZnJvbSAnLi4vLi4vYXBwL2luZGV4JztcbmltcG9ydCB7IEJpbmRpbmdEYXRhLCBCaW5kaW5nTGlzdCwgQmluZGluZ09iamVjdCB9IGZyb20gJy4uLy4uL2JpbmRpbmctZGF0YS9pbmRleCc7XG5pbXBvcnQgeyBEYXRhUHJvcEluZm8sIEVudGl0eSwgRW50aXR5TGlzdCB9IGZyb20gJy4uLy4uL2VudGl0eS9pbmRleCc7XG5pbXBvcnQgeyBFZmZlY3RvckZhY3RvcnkgfSBmcm9tICcuLi9lZmZlY3Rvci9pbmRleCc7XG5pbXBvcnQgeyBFeHByZXNzaW9uLCBFeHByZXNzaW9uRXhlY3V0b3IsIEV4cHJlc3Npb25SZWdpc3RyeSwgRXhwcmVzc2lvblJlc3VsdCB9IGZyb20gJy4uL2V4cHJlc3Npb24vaW5kZXgnO1xuaW1wb3J0IHsgUmVwb3NpdG9yeSB9IGZyb20gJy4uLy4uL3JlcG9zaXRvcnkvaW5kZXgnO1xuaW1wb3J0IHsgVmlld01vZGVsQ29udGV4dCB9IGZyb20gJy4uLy4uL3ZpZXctbW9kZWwvaW5kZXgnO1xuaW1wb3J0IHsgRXhwcmVzc2lvblV0aWwgfSBmcm9tICcuLi91dGlscy9leHByZXNzaW9uX3V0aWwnO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgRXZlbnRIYW5kbGVyIGltcGxlbWVudHMgRXhwcmVzc2lvbi5JRXZlbnRIYW5kbGVyIHtcblxuICBwcm90ZWN0ZWQgaW5qZWN0b3I6IEluamVjdG9yO1xuXG4gIHByb3RlY3RlZCByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT47XG5cbiAgcHJvdGVjdGVkIGJpbmRpbmdEYXRhOiBCaW5kaW5nRGF0YTtcblxuICBwcm90ZWN0ZWQgZXhwcmVzc2lvblJlZ2lzdHJ5OiBFeHByZXNzaW9uUmVnaXN0cnk7XG5cbiAgcHJvdGVjdGVkIGVmZmVjdG9yRmFjdG9yeTogRWZmZWN0b3JGYWN0b3J5O1xuXG4gIHByb3RlY3RlZCBleHByZXNzaW9uRXhlY3V0b3I6IEV4cHJlc3Npb25FeGVjdXRvcjtcblxuICBwcm90ZWN0ZWQgZXhwcmVzc2lvblJlc3VsdDogRXhwcmVzc2lvblJlc3VsdDtcblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgZnJhbWVDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0KSB7XG4gICAgdGhpcy5pbmplY3RvciA9IGZyYW1lQ29udGV4dC5pbmplY3RvcjtcbiAgICB0aGlzLnJlcG9zaXRvcnkgPSBmcmFtZUNvbnRleHQucmVwb3NpdG9yeTtcbiAgICB0aGlzLmJpbmRpbmdEYXRhID0gZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhO1xuICAgIHRoaXMuZXhwcmVzc2lvblJlZ2lzdHJ5ID0gdGhpcy5pbmplY3Rvci5nZXQoRXhwcmVzc2lvblJlZ2lzdHJ5LCBudWxsKTtcbiAgICB0aGlzLmVmZmVjdG9yRmFjdG9yeSA9IHRoaXMuaW5qZWN0b3IuZ2V0KEVmZmVjdG9yRmFjdG9yeSwgbnVsbCk7XG4gICAgdGhpcy5leHByZXNzaW9uRXhlY3V0b3IgPSB0aGlzLmluamVjdG9yLmdldChFeHByZXNzaW9uRXhlY3V0b3IpO1xuICAgIHRoaXMuZXhwcmVzc2lvblJlc3VsdCA9IHRoaXMuaW5qZWN0b3IuZ2V0KEV4cHJlc3Npb25SZXN1bHQsIG51bGwpO1xuXG4gIH1cblxuICBwdWJsaWMgZXhwcmVzc2lvbk9iamVjdHM6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdFtdO1xuXG4gIHB1YmxpYyBoYW5kbGVFdmVudChldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MsIGV4cHJlc3Npb25PYmplY3RzOiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3RbXSkge1xuICAgIGV2ZW50ID0gT2JqZWN0LmFzc2lnbih7fSwgZXZlbnQpO1xuICAgIHRoaXMuZXhwcmVzc2lvbk9iamVjdHMgPSBleHByZXNzaW9uT2JqZWN0cztcbiAgICB0aGlzLmRpc3BhdGNoKGV2ZW50KTtcbiAgfVxuXG4gIC8vI3JlZ2lvbiDmir3osaHlh73mlbBcbiAgLyoqXG4gICAqIOiOt+WPluebuOWFs+ihqOi+vuW8j1xuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcbiAgICovXG4gIHB1YmxpYyBhYnN0cmFjdCBmaWx0ZXIoZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKTtcbiAgLyoqXG4gICAqIOWPkeW4g+S6i+S7tlxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbk9iamVjdCDooajovr7lvI/lr7nosaFcbiAgICogQHBhcmFtIGV2ZW50IOS6i+S7tlxuICAgKi9cbiAgcHVibGljIGFic3RyYWN0IGRpc3BhdGNoKGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncyk6IHZvaWQ7XG4gIC8vI2VuZHJlZ2lvblxuXG4gIC8vI3JlZ2lvbiDlsZ7mgKdcblxuICAvKipcbiAgICog5Li76KGo5Li76ZSu5YC8XG4gICAqL1xuICBwcm90ZWN0ZWQgZ2V0IHByaW1hcnlWYWx1ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZTtcbiAgfVxuICAvKipcbiAgICog6I635Y+W5Li75a6e5L2T5Y6f5aeL5a2X5q615ZCNXG4gICAqL1xuICBwcm90ZWN0ZWQgZ2V0IGVudGl0eU9yaWdpbmFsTm9kZUNvZGUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5ICYmIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbyAmJiB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8uZW50aXR5SW5mbyAmJiB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8uZW50aXR5SW5mby5vcmlnaW5hbENvZGUgfHwgbnVsbDtcbiAgfVxuXG4gIC8vI2VuZHJlZ2lvblxuXG4gIC8vI3JlZ2lvbiDooajovr7lvI/moLjlv4NcbiAgLyoqXG4gICAqIOaJp+ihjOihqOi+vuW8j+iuoeeul1xuICAgKiBAcGFyYW0gZXhwcmVzc2lvbiDooajovr7lvI9cbiAgICogQHBhcmFtIGNvbnRleHQg5LiK5LiL5paHXG4gICAqIEByZXR1cm5zIGFueVxuICAgKi9cbiAgcHVibGljIHBlcmZvcm0oZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0LCBjb250ZXh0OiBhbnkpIHtcbiAgICByZXR1cm4gdGhpcy5leHByZXNzaW9uRXhlY3V0b3IuY29tcGlsZShleHByZXNzaW9uT2JqZWN0LCBjb250ZXh0KTtcbiAgfVxuICAvKipcbiAgICog5Ymv5L2c55SoXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbk9iamVjdCBleHByZXNzaW9uT2JqZWN0XG4gICAqL1xuICBwdWJsaWMgZWZmZWN0KGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncywgZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KTogdm9pZCB7XG4gICAgY29uc3QgZWZmZWN0VG8gPSBleHByZXNzaW9uT2JqZWN0LmJpbmRpbmdUeXBlO1xuICAgIGNvbnN0IGVmZmVjdG9yID0gdGhpcy5lZmZlY3RvckZhY3RvcnkuZ2V0RWZmZWN0b3IoZXhwcmVzc2lvbk9iamVjdCk7XG4gICAgaWYgKCFlZmZlY3Rvcikge1xuICAgICAgLy8gY29uc29sZS53YXJuKGBFdmVudEhhbmRsZXIg5rKh5pyJ5a+55bqU55qE5Ymv5L2c55So5Zmo44CCJHtleHByZXNzaW9uT2JqZWN0LnR5cGV9YCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChlZmZlY3RUbyA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uQmluZGluZ1R5cGUuRmllbGQpIHtcbiAgICAgIGNvbnN0IGVmZmVjdFBhdGhzID0gZXhwcmVzc2lvbk9iamVjdC5lZmZlY3RQYXRocyB8fCBbXTtcbiAgICAgIGlmIChlZmZlY3RQYXRocy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGVmZmVjdFBhdGhzLmZvckVhY2goKHBhdGg6IHN0cmluZykgPT4ge1xuICAgICAgICAgIGNvbnN0IGVmZmVjdFBhdGggPSBwYXRoLnNwbGl0KCcvJyk7XG4gICAgICAgICAgY29uc3QgZWZmZWN0T3B0aW9ucyA9IHsgcGF0aDogZWZmZWN0UGF0aCwgbWVzc2FnZTogZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlLCBleHByZXNzaW9uSWQ6IGV4cHJlc3Npb25PYmplY3QuaWQsIGV2ZW50VHlwZTogZXZlbnQudHlwZSwgdmlld01vZGVsSWQ6IGV4cHJlc3Npb25PYmplY3Qudmlld01vZGVsSWQgfTtcbiAgICAgICAgICBlZmZlY3Rvci5lZmZlY3QoZXhwcmVzc2lvbk9iamVjdC5wYXRoLCBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCwgZWZmZWN0T3B0aW9ucyk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmIChleHByZXNzaW9uT2JqZWN0LnR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuUmVxdWlyZWQgfHwgZXhwcmVzc2lvbk9iamVjdC50eXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLlZhbGlkYXRlIHx8IGV4cHJlc3Npb25PYmplY3QudHlwZSA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5SZWFkb25seSB8fCBleHByZXNzaW9uT2JqZWN0LnR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuVmlzaWJsZSkge1xuICAgICAgICBjb25zdCBlZmZlY3RPcHRpb25zID0geyBtZXNzYWdlOiBleHByZXNzaW9uT2JqZWN0Lm1lc3NhZ2UsIGV4cHJlc3Npb25JZDogZXhwcmVzc2lvbk9iamVjdC5pZCwgZXZlbnRUeXBlOiBldmVudC50eXBlLCB2aWV3TW9kZWxJZDogZXhwcmVzc2lvbk9iamVjdC52aWV3TW9kZWxJZCB9O1xuICAgICAgICBlZmZlY3Rvci5lZmZlY3QoZXhwcmVzc2lvbk9iamVjdC5wYXRoLCBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCwgZWZmZWN0T3B0aW9ucyk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignbm90IHN1cHBvcnRlZO+8gScpO1xuICAgIH1cbiAgfVxuXG4gIC8vI2VuZHJlZ2lvblxuXG4gIC8vI3JlZ2lvbiB1dGlsXG5cbiAgcHJvdGVjdGVkIGlzVmFsaWRhdGVPclJlcXVpcmVkRXhwcmVzc2lvbihleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpIHtcbiAgICByZXR1cm4gZXhwcmVzc2lvbk9iamVjdCAmJiAoZXhwcmVzc2lvbk9iamVjdC50eXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLlZhbGlkYXRlIHx8IGV4cHJlc3Npb25PYmplY3QudHlwZSA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5SZXF1aXJlZCk7XG4gIH1cbiAgLyoqXG4gICAqIOS7peS6i+S7tuWPguaVsOS4uuS+neaNruaehOW7uuWunuS9k+i3r+W+hFxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwcm90ZWN0ZWQgZ2V0RW50aXR5UGF0aEZyb21FdmVudChldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MpOiBzdHJpbmdbXSB7XG4gICAgZXZlbnQgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGV2ZW50KSk7XG4gICAgaWYgKCFldmVudCB8fCAhZXZlbnQucGF0aCB8fCBldmVudC5wYXRoLmxlbmd0aCA8IDEpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgY29uc3QgcGF0aHMgPSBldmVudC5wYXRoO1xuICAgIHJldHVybiB0aGlzLmdldEVudGl0eVBhdGgocGF0aHMpO1xuICB9XG4gIC8qKlxuICAgKiDojrflj5bkuovku7bot6/lvoTkuK3nmoTlrp7kvZPot6/lvoRcbiAgICogQHBhcmFtIHBhdGggcGF0aFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHByb3RlY3RlZCBnZXRFbnRpdHlQYXRoKHBhdGg6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IHBhdGhzID0gcGF0aC5maWx0ZXIoKHZhbHVlOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgIGlmIChpbmRleCAlIDIgPT09IDAgJiYgdmFsdWUuaW5jbHVkZXMoJzonKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcGF0aHM7XG4gIH1cbiAgLyoqXG4gICAqIOaehOmAoOWunuS9k+i3r+W+hFxuICAgKiBAcGFyYW0gcGF0aCBwYXRoXG4gICAqIEBkZXNjcmlwdGlvbiDliKDpmaTot6/lvoTkuK3nmoRpZOWtl+autVxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHByb3RlY3RlZCBidWlsZEVudGl0eVBhdGgocGF0aDogc3RyaW5nW10pOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgcGF0aHMgPSBwYXRoLmZpbHRlcigodmFsdWU6IHN0cmluZywgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgaWYgKGluZGV4ICUgMiA9PT0gMCAmJiB2YWx1ZS5pbmNsdWRlcygnOicpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBwYXRocztcbiAgfVxuICAvKipcbiAgICog5riF55CG5LqL5Lu26Lev5b6E5Lit55qEaWTkuLvplK7moIfor4ZcbiAgICogQHBhcmFtIHBhdGggcGF0aFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHByb3RlY3RlZCBjbGVhbkV2ZW50UGF0aChwYXRoOiBzdHJpbmdbXSkge1xuICAgIHBhdGggPSBwYXRoLmZpbHRlcihwID0+IHtcbiAgICAgIGlmIChwICYmIHAgIT09ICc6Jykge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcGF0aC5tYXAoKGl0ZW06IHN0cmluZykgPT4ge1xuICAgICAgaWYgKGl0ZW0uaW5jbHVkZXMoJzonKSkge1xuICAgICAgICByZXR1cm4gaXRlbS5zcGxpdCgnOicpWzFdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGl0ZW07XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbiAgLyoqXG4gICAqIOiOt+WPluWtkOihqOS6i+S7tuihjFxuICAgKiBAcGFyYW0gcGF0aHMgXG4gICAqIEBwYXJhbSBldmVudCBcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwcm90ZWN0ZWQgZ2V0Q3VycmVudFJvd0J5UGF0aHMocGF0aHM6IHN0cmluZ1tdKTogbnVsbCB8IHsgW3Byb3A6IHN0cmluZ106IGFueSB9IHtcbiAgICBsZXQgcmVzdWx0ID0gbnVsbDtcbiAgICBjb25zdCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QgPSB0aGlzLmJpbmRpbmdEYXRhLmdldFZhbHVlKHBhdGhzKSBhcyBCaW5kaW5nTGlzdDtcbiAgICBpZiAoYmluZGluZ0xpc3QgJiYgYmluZGluZ0xpc3QubGVuZ3RoID4gMCkge1xuICAgICAgbGV0IHByaW1hcnlWYWx1ZSA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZSB8fCBudWxsO1xuICAgICAgaWYgKHByaW1hcnlWYWx1ZSkge1xuICAgICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gYmluZGluZ0xpc3QuZmluZEJ5SWQocHJpbWFyeVZhbHVlKTtcbiAgICAgICAgaWYgKGJpbmRpbmdPYmplY3QpIHtcbiAgICAgICAgICByZXN1bHQgPSBiaW5kaW5nT2JqZWN0LnRvSlNPTigpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbiAgLyoqXG4gICAqIOiOt+WPluS6i+S7tui3r+W+hOS4reaMh+WumuWtkOihqOeahOS6i+S7tuihjFxuICAgKiBAcGFyYW0gcGF0aCBcbiAgICogQHBhcmFtIHRhYmxlQ29kZSBcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwcm90ZWN0ZWQgZ2V0RXZlbnRJZChwYXRoOiBzdHJpbmdbXSwgdGFibGVDb2RlOiBzdHJpbmcpIHtcbiAgICBpZiAoIXBhdGggfHwgcGF0aC5sZW5ndGggPCAxKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgcGF0aCEnKTtcbiAgICB9XG4gICAgY29uc3QgcHJvcGVydHlJbmRleCA9IHBhdGguZmluZEluZGV4KHAgPT4gcCA9PT0gdGFibGVDb2RlKTtcbiAgICBpZiAocHJvcGVydHlJbmRleCA9PT0gLTEpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCBpZEluZGV4ID0gcHJvcGVydHlJbmRleCArIDE7XG4gICAgaWYgKGlkSW5kZXggPiBwYXRoLmxlbmd0aCAtIDEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBwcm9wZXJ0eU5hbWUgb3IgcGF0aCcpO1xuICAgIH1cbiAgICBjb25zdCBpZCA9IHBhdGhbaWRJbmRleF07XG4gICAgaWYgKGlkLmluZGV4T2YoJzonKSA9PT0gLTEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignY29tcHV0ZSBlcnJvci4nKTtcbiAgICB9XG4gICAgcmV0dXJuIGlkLnNwbGl0KCc6JylbMV07XG4gIH1cbiAgLy8jZW5kcmVnaW9uXG5cblxuICAvLyNyZWdpb24gIOaehOmAoOS4iuS4i+aWh1xuXG4gIC8qKlxuICAgKiDmnoTpgKDlj5jph4/kuIrkuIvmlodcbiAgICogQHBhcmFtIGV2ZW50IFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyBidWlsZFN0YXRlQ29udGV4dChldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MpIHtcbiAgICBjb25zdCBucyA9IGV2ZW50Lm5zO1xuICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLmluamVjdG9yLmdldDxBcHBDb250ZXh0PihBcHBDb250ZXh0LCBudWxsKTtcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gYXBwQ29udGV4dC52aWV3TW9kZWxDb250ZXh0TWFuYWdlci5nZXRDb250ZXh0c0J5TmFtZXNwYWNlKG5zKTtcbiAgICBjb25zdCByZXN1bHQgPSB7fTtcbiAgICBpZiAoZnJhbWVDb250ZXh0cyAmJiBmcmFtZUNvbnRleHRzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IGFub255bW91c0ZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dHNbMF07XG4gICAgICBjb25zdCByb290RnJhbWVDb250ZXh0ID0gYW5vbnltb3VzRnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XG4gICAgICBpZiAocm9vdEZyYW1lQ29udGV4dCkge1xuICAgICAgICBjb25zdCB1aVN0YXRlID0gcm9vdEZyYW1lQ29udGV4dC52aWV3TW9kZWwudWlTdGF0ZTtcbiAgICAgICAgY29uc3QgcHJvcGVydHlOYW1lcyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHVpU3RhdGUpIHx8IFtdO1xuICAgICAgICBwcm9wZXJ0eU5hbWVzLmZvckVhY2goKHByb3A6IHN0cmluZykgPT4ge1xuICAgICAgICAgIGlmIChwcm9wLm1hdGNoKC9eW2EtekEtWjAtOV9cXCRdKyQvZykgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdFtwcm9wXSA9IHVpU3RhdGVbcHJvcF07XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuICAvKipcbiAgICog6I635Y+W5LqL5Lu25a6e5L2TXG4gICAqIEBwYXJhbSBldmVudCBcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgYnVpbGRFbnRpdHlDb250ZXh0KGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncywgZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0LCBjdXJyZW50Um93cz86IEFycmF5PEV4cHJlc3Npb24uSUN1cnJlbnRSb3c+KSB7XG4gICAgY29uc3QgZXhwcmVzc2lvbkJpbmRpbmdUeXBlID0gZXhwcmVzc2lvbk9iamVjdC5iaW5kaW5nVHlwZTtcbiAgICBpZiAoZXhwcmVzc2lvbkJpbmRpbmdUeXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25CaW5kaW5nVHlwZS5GaWVsZCkge1xuICAgICAgY29uc3QgZW50aXR5VHlwZUluZm8gPSB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm87XG4gICAgICBjb25zdCBjaGlsZHJlbkVudGl0eVBhdGhzID0gW107XG4gICAgICBFeHByZXNzaW9uVXRpbC5nZXRDaGlsZHJlbkVudGl0eVBhdGhzKGVudGl0eVR5cGVJbmZvLCBjaGlsZHJlbkVudGl0eVBhdGhzKTtcbiAgICAgIC8vIOiOt+WPluW9k+WJjeihjFxuICAgICAgY29uc3Qgcm93ID0gY3VycmVudFJvd3MgJiYgY3VycmVudFJvd3MuZmluZChyb3cgPT4gcm93LmJpbmRpbmdQYXRoID09PSAnJyB8fCByb3cuYmluZGluZ1BhdGggPT09ICcvJykgfHwgbnVsbDtcbiAgICAgIGNvbnN0IHByaW1hcnlWYWx1ZSA9IHJvdyAmJiByb3cucHJpbWFyeVZhbHVlIHx8IHRoaXMuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XG4gICAgICBsZXQgZW50aXR5ID0gdGhpcy5iaW5kaW5nRGF0YS5saXN0LmZpbmRCeUlkKHByaW1hcnlWYWx1ZSk7XG4gICAgICBpZiAoIWVudGl0eSkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG9iamVjdCA9IGVudGl0eS50b0pTT04oKTtcbiAgICAgIG9iamVjdFsnX190eXBlX18nXSA9ICdFbnRpdHknO1xuICAgICAgaWYgKCFjaGlsZHJlbkVudGl0eVBhdGhzIHx8IGNoaWxkcmVuRW50aXR5UGF0aHMubGVuZ3RoIDwgMSkge1xuICAgICAgICByZXR1cm4gb2JqZWN0O1xuICAgICAgfVxuICAgICAgY2hpbGRyZW5FbnRpdHlQYXRocy5zb3J0KCh2MSwgdjIpID0+IHYxLmxlbmd0aCAtIHYyLmxlbmd0aCk7XG4gICAgICAvLyDmib7liLDmiYDmnInlrZDooahcbiAgICAgIGNoaWxkcmVuRW50aXR5UGF0aHMuZm9yRWFjaCgocGF0aHM6IHN0cmluZ1tdKSA9PiB7XG4gICAgICAgIGNvbnN0IGJpbmRpbmdMaXN0ID0gdGhpcy5iaW5kaW5nRGF0YS5nZXRWYWx1ZShwYXRocykgYXMgQmluZGluZ0xpc3Q7XG4gICAgICAgIGxldCBjdXJyZW50Um93SWQgPSBiaW5kaW5nTGlzdC5jdXJyZW50SWQ7XG4gICAgICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHBhdGhzW3BhdGhzLmxlbmd0aCAtIDFdO1xuICAgICAgICAvLyBwYXJlbnQg5Li6ZW50aXR55oiWZW50aXR5bGlzdOaIlm51bGxcbiAgICAgICAgY29uc3QgcGFyZW50ID0gcGF0aHMuc2xpY2UoMCwgcGF0aHMubGVuZ3RoIC0gMSkucmVkdWNlKChvYmplY3Q6IGFueSwgcGF0aDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIG9iamVjdCAmJiBvYmplY3RbcGF0aF0gfHwgbnVsbDtcbiAgICAgICAgfSwgb2JqZWN0KTtcbiAgICAgICAgaWYgKCFwYXJlbnQpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZGF0YSA9IHBhcmVudDtcbiAgICAgICAgbGV0IG5vZGU6IGFueSA9IG51bGw7XG4gICAgICAgIGlmICghY3VycmVudFJvd0lkKSB7XG4gICAgICAgICAgLy8g5b2T5YmN6KGo5rKh5pyJ5pWw5o2uXG4gICAgICAgICAgbm9kZSA9IHsgX19pdGVtc19fOiBbXSwgX190eXBlX186ICdMaXN0JyB9O1xuICAgICAgICAgIG5vZGUubGVuZ3RoID0gKCkgPT4gbm9kZS5fX2l0ZW1zX18ubGVuZ3RoO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIOe6oOato+W9k+WJjeihjFxuICAgICAgICAgIGlmIChjdXJyZW50Um93cyAmJiBjdXJyZW50Um93cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAvLyDmmK/lkKbmjIflrprkuoblvZPliY3ooYxcbiAgICAgICAgICAgIGNvbnN0IHVzZXJBc3NpZ25DdXJyZW50Um93ID0gY3VycmVudFJvd3MuZmluZChyb3cgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSByb3cuYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcbiAgICAgICAgICAgICAgcmV0dXJuIGJpbmRpbmdQYXRocy5qb2luKCcvJykgPT09IHBhdGhzLmpvaW4oJy8nKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaWYgKHVzZXJBc3NpZ25DdXJyZW50Um93KSB7XG4gICAgICAgICAgICAgIGN1cnJlbnRSb3dJZCA9IHVzZXJBc3NpZ25DdXJyZW50Um93LnByaW1hcnlWYWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgLy8g5a2Q6KGo5b2T5YmN6KGMXG4gICAgICAgICAgY29uc3Qgcm93ID0gYmluZGluZ0xpc3QuZmluZEJ5SWQoY3VycmVudFJvd0lkKTtcbiAgICAgICAgICAvLyDmib7liLDlrZDooajlvZPliY3ooYznmoTkuIrnuqdcbiAgICAgICAgICBjb25zdCBsaXN0ID0gcGFyZW50W3Byb3BlcnR5TmFtZV07XG4gICAgICAgICAgbm9kZSA9IHsgX19pdGVtc19fOiBbXSwgLi4ucm93ICYmIHJvdy50b0pTT04oKSB8fCB7fSwgX190eXBlX186ICdMaXN0JyB9O1xuICAgICAgICAgIG5vZGUubGVuZ3RoID0gKCkgPT4gbm9kZS5fX2l0ZW1zX18ubGVuZ3RoO1xuXG4gICAgICAgICAgaWYgKGxpc3QgJiYgQXJyYXkuaXNBcnJheShsaXN0KSkge1xuICAgICAgICAgICAgbm9kZS5fX2l0ZW1zX18gPSBbXS5jb25jYXQobGlzdCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGRhdGFbcHJvcGVydHlOYW1lXSA9IG5vZGU7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBvYmplY3Q7XG4gICAgfSBlbHNlIGlmIChleHByZXNzaW9uQmluZGluZ1R5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvbkJpbmRpbmdUeXBlLlN0YXRlKSB7XG4gICAgICAvLyB0b2RvOiDmlK/mjIHnirbmgIHooajovr7lvI9cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiDmnoTpgKDooajovr7lvI/orqHnrpfkuIrkuIvmlodcbiAgICogQHBhcmFtIGV4cHJlc3Npb25PYmplY3Qg6KGo6L6+5byPXG4gICAqIEBwYXJhbSBldmVudCDkuovku7ZcbiAgICogQHBhcmFtIGVudGl0eUNvbnRleHQg5a6e5L2T5LiK5LiL5paHXG4gICAqIEBwYXJhbSBjdXJyZW50Um93cyDlvZPliY3ooYxcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgYnVpbGRDb250ZXh0KGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCwgZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzLCBlbnRpdHlDb250ZXh0PzogYW55LCBjdXJyZW50Um93cz86IEFycmF5PEV4cHJlc3Npb24uSUN1cnJlbnRSb3c+KTogYW55IHtcbiAgICBsZXQgY29udGV4dCA9IFtdO1xuICAgIGlmIChlbnRpdHlDb250ZXh0KSB7XG4gICAgICBjb250ZXh0LnB1c2goZW50aXR5Q29udGV4dCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGVudGl0eSA9IHRoaXMuYnVpbGRFbnRpdHlDb250ZXh0KGV2ZW50LCBleHByZXNzaW9uT2JqZWN0LCBjdXJyZW50Um93cyk7XG4gICAgICBjb250ZXh0LnB1c2goZW50aXR5KTtcbiAgICB9XG4gICAgY29uc3Qgc3RhdGVDb250ZXh0ID0gdGhpcy5idWlsZFN0YXRlQ29udGV4dChldmVudCk7XG4gICAgY29uc3QgZW50aXR5Q29kZSA9IHRoaXMuZW50aXR5T3JpZ2luYWxOb2RlQ29kZTtcbiAgICBsZXQgZW50aXR5ID0gbnVsbDtcbiAgICBpZiAoY29udGV4dC5sZW5ndGggPT09IDEpIHtcbiAgICAgIGVudGl0eSA9IGNvbnRleHQucG9wKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGVudGl0eSA9IGNvbnRleHRbMF07XG4gICAgICBpZiAoIWVudGl0eVsnX190eXBlX18nXSkge1xuICAgICAgICBlbnRpdHlbJ19fdHlwZV9fJ10gPSAnRW50aXR5JztcbiAgICAgIH1cbiAgICAgIGVudGl0eVsnX19pdGVtc19fJ10gPSBjb250ZXh0O1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgW2VudGl0eUNvZGVdOiBlbnRpdHksXG4gICAgICAuLi5zdGF0ZUNvbnRleHQsXG4gICAgICBmcmFtZUNvbnRleHQ6IHRoaXMuZnJhbWVDb250ZXh0LFxuICAgICAgYmluZGluZ0RhdGE6IHRoaXMuYmluZGluZ0RhdGEsXG4gICAgICByZXBvc2l0b3J5OiB0aGlzLnJlcG9zaXRvcnlcbiAgICB9O1xuICB9XG4gIC8vI2VuZHJlZ2lvblxuICAvKipcbiAgICog5p6E6YCg5Ymv5L2c55So6Lev5b6EXG4gICAqIEBwYXJhbSBldmVudCBcbiAgICogQHBhcmFtIGV4cHJlc3Npb25PYmplY3QgXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHJvdGVjdGVkIGJ1aWxkRWZmZWN0UGF0aChldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MsIGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCBleHByZXNzaW9uUGF0aHMgPSBleHByZXNzaW9uT2JqZWN0LnBhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcbiAgICBjb25zdCBwcmltYXJ5VmFsdWUgPSBldmVudC5wYXRoWzBdICYmIGV2ZW50LnBhdGhbMF0uc3BsaXQoJzonKVsxXTtcbiAgICBpZiAoIXByaW1hcnlWYWx1ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGV2ZW50IHBhdGghJyk7XG4gICAgfVxuICAgIGlmIChleHByZXNzaW9uUGF0aHMubGVuZ3RoID09PSAxKSB7XG4gICAgICAvLyDkuLvooajnroDljZXlrZfmrrVcbiAgICAgIHJldHVybiBbcHJpbWFyeVZhbHVlLCBleHByZXNzaW9uUGF0aHMucG9wKCldO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBbcHJpbWFyeVZhbHVlXTtcbiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBleHByZXNzaW9uUGF0aHMubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IGV4cHJlc3Npb25QYXRoc1tpbmRleF07XG4gICAgICAgIHJlc3VsdC5wdXNoKHByb3BlcnR5TmFtZSk7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRQYXRocyA9IGV4cHJlc3Npb25QYXRocy5zbGljZSgwLCBpbmRleCArIDEpO1xuICAgICAgICBjb25zdCBwcm9wZXJ0eUluZm86IERhdGFQcm9wSW5mbyA9IHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mby5nZXRQcm9wSW5mb0J5UGF0aChjdXJyZW50UGF0aHMpO1xuICAgICAgICBpZiAocHJvcGVydHlJbmZvLmdyb3VwID09PSAnTGlzdCcpIHtcbiAgICAgICAgICBsZXQgaWQgPSB0aGlzLmdldEV2ZW50SWQoZXZlbnQucGF0aCwgcHJvcGVydHlJbmZvLm5hbWUpIHx8IG51bGw7XG4gICAgICAgICAgLy8g5LqL5Lu25ZKM6KGo6L6+5byP5LiN5piv5ZCM5LiA5Liq6KGoXG4gICAgICAgICAgaWYgKCFpZCkge1xuICAgICAgICAgICAgY29uc3QgYmluZGluZ0xpc3QgPSB0aGlzLmJpbmRpbmdEYXRhLmdldFZhbHVlKGN1cnJlbnRQYXRocykgYXMgQmluZGluZ0xpc3Q7XG4gICAgICAgICAgICBpZiAoYmluZGluZ0xpc3QpIHtcbiAgICAgICAgICAgICAgaWQgPSBiaW5kaW5nTGlzdC5jdXJyZW50SWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHJlc3VsdC5wdXNoKGlkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gIH1cblxuICAvLyNyZWdpb24g6L6F5Yqp5pa55rOVXG4gIHByb3RlY3RlZCBnZXRQYXRoSW5mbyhwYXRoOiBzdHJpbmcpOiB7IHBhdGg6IHN0cmluZywgcHJvcGVydHlOYW1lOiBzdHJpbmcsIHBhdGhzOiBzdHJpbmdbXSwgcHJvcGVydHlOYW1lczogc3RyaW5nW10gfSB7XG4gICAgY29uc3QgcGF0aHMgPSBwYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgLy8g6I635Y+W5pyA5aSn5a6e5L2T5bGC57qn77yM5YW25L2Z5Li65bGe5oCn77yI566A5Y2V5bGe5oCn44CBdWR044CB5YWz6IGU44CB5YWz6IGU5bWM5aWX5YWz6IGU77yJXG4gICAgY29uc3QgZW50aXR5UGF0aCA9IEV4cHJlc3Npb25VdGlsLmdldEF2YWlsYWJsZUNoaWxkcmVuUGF0aHNGcm9tRW50aXR5UGF0aHMocGF0aHMsIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbyk7XG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gcGF0aHMuc2xpY2UoZW50aXR5UGF0aC5sZW5ndGgpLmpvaW4oJy8nKTtcbiAgICByZXR1cm4geyBwYXRoOiBlbnRpdHlQYXRoLmpvaW4oJy8nKSwgcHJvcGVydHlOYW1lLCBwYXRoczogZW50aXR5UGF0aCwgcHJvcGVydHlOYW1lczogcHJvcGVydHlOYW1lLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkgfTtcbiAgfVxuICAvKipcbiAgICogZ2V0IHRhYmxlIHBhdGhzIGZyb20gZXZlbnQgcGF0aHNcbiAgICogQHBhcmFtIHBhdGhzIGV2ZW50IHBhdGhzXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHJvdGVjdGVkIGdldFRhYmxlUGF0aHNGcm9tRXZlbnRQYXRocyhwYXRoczogc3RyaW5nW10pIHtcbiAgICBwYXRocyA9IHRoaXMuZ2V0RW50aXR5UGF0aChwYXRocyk7XG4gICAgY29uc3QgZW50aXR5UGF0aHMgPSBFeHByZXNzaW9uVXRpbC5nZXRBdmFpbGFibGVDaGlsZHJlblBhdGhzRnJvbUVudGl0eVBhdGhzKHBhdGhzLCB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8pO1xuICAgIHJldHVybiBlbnRpdHlQYXRocztcbiAgfVxuICAvKipcbiAgICogZ2V0IHByb3BlcnR5IHBhdGhzIGZyb20gZXZlbnQgcGF0aHNcbiAgICogQHBhcmFtIHBhdGhzIGV2ZW50IHBhdGhzXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHJvdGVjdGVkIGdldFByb3BlcnR5UGF0aHNGcm9tRXZlbnRQYXRocyhwYXRoczogc3RyaW5nW10pIHtcbiAgICBwYXRocyA9IHRoaXMuZ2V0RW50aXR5UGF0aChwYXRocyk7XG4gICAgY29uc3QgdGFibGVQYXRocyA9IEV4cHJlc3Npb25VdGlsLmdldEF2YWlsYWJsZUNoaWxkcmVuUGF0aHNGcm9tRW50aXR5UGF0aHMocGF0aHMsIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbyk7XG4gICAgcmV0dXJuIHBhdGhzLnNsaWNlKHRhYmxlUGF0aHMubGVuZ3RoKTtcbiAgfVxuICAvKipcbiAgICog5YiG5p6Q5LqL5Lu25ZKM6KGo6L6+5byP55qE5YWz57O7XG4gICAqL1xuICBwcm90ZWN0ZWQgYW5hbHlzaXMoZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzLCBleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpIHtcbiAgICBjb25zdCBleHByZXNzaW9uUGF0aEluZm8gPSB0aGlzLmdldFBhdGhJbmZvKGV4cHJlc3Npb25PYmplY3QucGF0aCk7XG4gICAgY29uc3QgZXZlbnRQYXRocyA9IHRoaXMuZ2V0RW50aXR5UGF0aChldmVudC5wYXRoLnNsaWNlKDApKTtcbiAgICBjb25zdCBldmVudFBhdGhJbmZvID0gdGhpcy5nZXRQYXRoSW5mbyhldmVudFBhdGhzLmpvaW4oJy8nKSk7XG4gICAgaWYgKCFleHByZXNzaW9uUGF0aEluZm8gfHwgIWV2ZW50UGF0aEluZm8pIHtcbiAgICAgIGNvbnNvbGUud2Fybihg6KGo6L6+5byP6Lev5b6E5oiW5LqL5Lu26Lev5b6E6ZSZ6K+v77yM6I635Y+W6Lev5b6E5L+h5oGv5aSx6LSl44CCYCk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgZXhwcmVzc2lvblRhYmxlUGF0aHMgPSBleHByZXNzaW9uUGF0aEluZm8ucGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgIGNvbnN0IGV4cHJlc3Npb25Qcm9wZXJ0eU5hbWVzID0gZXhwcmVzc2lvblBhdGhJbmZvLnByb3BlcnR5TmFtZS5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgIGNvbnN0IGV2ZW50VGFibGVQYXRocyA9IGV2ZW50UGF0aEluZm8ucGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgIGNvbnN0IGV2ZW50UHJvcGVydHlOYW1lcyA9IGV2ZW50UGF0aEluZm8ucHJvcGVydHlOYW1lLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgZGlzdGFuY2U6IHVuZGVmaW5lZCxcbiAgICAgIGV2ZW50RnJvbUNoaWxkcmVuOiB1bmRlZmluZWQsXG4gICAgICBldmVudEZyb21QYXJlbnQ6IHVuZGVmaW5lZCxcbiAgICAgIGV4cHJlc3Npb25UYWJsZVBhdGhzLFxuICAgICAgZXhwcmVzc2lvblByb3BlcnR5TmFtZXMsXG4gICAgICBldmVudFRhYmxlUGF0aHMsXG4gICAgICBldmVudFByb3BlcnR5TmFtZXMsXG4gICAgICBpc1NhbWVUYWJsZTogZmFsc2VcbiAgICB9O1xuICAgIHJlc3VsdC5kaXN0YW5jZSA9IE1hdGguYWJzKGV4cHJlc3Npb25UYWJsZVBhdGhzLmxlbmd0aCAtIGV2ZW50VGFibGVQYXRocy5sZW5ndGgpO1xuICAgIGlmIChyZXN1bHQuZGlzdGFuY2UgPT09IDEpIHtcbiAgICAgIHJlc3VsdC5ldmVudEZyb21DaGlsZHJlbiA9IGV2ZW50VGFibGVQYXRocy5sZW5ndGggPiBleHByZXNzaW9uVGFibGVQYXRocy5sZW5ndGggJiYgZXZlbnRUYWJsZVBhdGhzLmpvaW4oJy8nKS5zdGFydHNXaXRoKGV4cHJlc3Npb25UYWJsZVBhdGhzLmpvaW4oJy8nKSk7XG4gICAgICByZXN1bHQuZXZlbnRGcm9tUGFyZW50ID0gZXZlbnRUYWJsZVBhdGhzLmxlbmd0aCA8IGV4cHJlc3Npb25UYWJsZVBhdGhzLmxlbmd0aCAmJiBleHByZXNzaW9uVGFibGVQYXRocy5qb2luKCcvJykuc3RhcnRzV2l0aChldmVudFRhYmxlUGF0aHMuam9pbignLycpKTtcbiAgICB9XG4gICAgcmVzdWx0LmlzU2FtZVRhYmxlID0gZXhwcmVzc2lvblRhYmxlUGF0aHMuam9pbignLycpID09PSBldmVudFRhYmxlUGF0aHMuam9pbignLycpO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgYnVpbGRDdXJyZW50Um93cyh0YWJsZVBhdGhzOiBzdHJpbmdbXSwgZnVsbFBhdGhzOiBzdHJpbmdbXSkge1xuICAgIGNvbnN0IGN1cnJlbnRSb3dzID0gbmV3IEFycmF5PEV4cHJlc3Npb24uSUN1cnJlbnRSb3c+KCk7XG4gICAgaWYgKCF0YWJsZVBhdGhzIHx8IHRhYmxlUGF0aHMubGVuZ3RoIDwgMSkge1xuICAgICAgY3VycmVudFJvd3MucHVzaCh7XG4gICAgICAgIGJpbmRpbmdQYXRoOiAnLycsXG4gICAgICAgIHByaW1hcnlWYWx1ZTogZnVsbFBhdGhzWzBdXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgcGF0aHMgPSBbXTtcbiAgICAgIHRhYmxlUGF0aHMuZm9yRWFjaCgocGF0aDogc3RyaW5nLCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgIGlmIChpbmRleCA9PT0gMCkge1xuICAgICAgICAgIGN1cnJlbnRSb3dzLnB1c2goe1xuICAgICAgICAgICAgYmluZGluZ1BhdGg6ICcvJyxcbiAgICAgICAgICAgIHByaW1hcnlWYWx1ZTogZnVsbFBhdGhzWzBdXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcGF0aHMucHVzaChwYXRoKTtcbiAgICAgICAgY29uc3QgcHJpbWFyeVZhbHVlID0gZnVsbFBhdGhzW2luZGV4ICogMiArIDJdO1xuICAgICAgICBjdXJyZW50Um93cy5wdXNoKHtcbiAgICAgICAgICBiaW5kaW5nUGF0aDogcGF0aHMuam9pbignLycpLFxuICAgICAgICAgIHByaW1hcnlWYWx1ZTogcHJpbWFyeVZhbHVlXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBjdXJyZW50Um93cztcbiAgfVxuICAvLyNlbmRyZWdpb25cbn0iXX0=