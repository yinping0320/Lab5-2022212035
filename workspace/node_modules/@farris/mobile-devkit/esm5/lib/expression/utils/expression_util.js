import * as tslib_1 from "tslib";
import { DataPropGroup } from "../../entity/index";
import { ENTITY_TEMPLATE, GROUP_FUNCTIONS } from "../resolver/index";
var ExpressionUtil = /** @class */ (function () {
    function ExpressionUtil() {
    }
    ExpressionUtil.getGroupFunctionDependency = function (expr, entityTypeInfo) {
        var _this = this;
        var deps = [];
        // 获取聚合函数依赖项
        var groupFunctionRegex = new RegExp("DefaultFunction\\.(" + GROUP_FUNCTIONS.join('|') + ")\\s*\\([^\\r\\n\\)]*\\)", "g");
        var groupFunctions = expr.match(groupFunctionRegex);
        if (groupFunctions && groupFunctions.length > 0) {
            // todo: 使用正则匹配时可能会因为参数中有逗号导致问题，后续使用ast解析
            var argumentsRegex_1 = /\(([^\r\n\)]*)\)/;
            groupFunctions.forEach(function (groupFunction) {
                var argumentMatchResult = groupFunction.match(argumentsRegex_1);
                if (argumentMatchResult.length === 2) {
                    var argument = argumentMatchResult[1];
                    var args = argument.split(',').map(function (p) { return p.replace(/\"/g, ''); });
                    if (args && args.length === 2) {
                        var item = args.join('.');
                        item = _this.convertToNodeCode(item, entityTypeInfo).join('.');
                        item = item.substr(item.indexOf('.') + 1);
                        var dep = item.split('.');
                        dep.splice(0, 0, ENTITY_TEMPLATE);
                        deps.push(dep.join('/'));
                    }
                    else {
                        throw new Error("\u65E0\u6CD5\u89E3\u6790\u53C2\u6570\uFF1A " + JSON.stringify(argument));
                    }
                }
            });
        }
        return deps;
    };
    /**
     * 将voCode转换为前端nodeCode
     * @param entityExpression like Entity.Child.p1
     * @returns
     */
    ExpressionUtil.convertToNodeCode = function (entityExpression, entityTypeInfo) {
        // UserEntity.storys.p1
        var nodeCodes = [];
        if (entityTypeInfo && entityExpression.includes('.')) {
            var entityExpressions = entityExpression.split('.') || [];
            var dataTypeInfo = entityTypeInfo;
            for (var index = 0; index < entityExpressions.length; index++) {
                var prop = entityExpressions[index];
                if (dataTypeInfo && dataTypeInfo.entityInfo && dataTypeInfo.entityInfo.nodeCode === prop || dataTypeInfo.entityInfo.originalCode === prop) {
                    // 第一个是主表code，不能转nodeCode
                    if (index === 0) {
                        nodeCodes.push(dataTypeInfo.entityInfo.originalCode);
                    }
                    else {
                        nodeCodes.push(dataTypeInfo.entityInfo.nodeCode);
                    }
                    // 下一级可能为子表、对象或属性
                    var nextNodeCode = entityExpressions[index + 1];
                    if (!nextNodeCode) {
                        break;
                    }
                    var nextNodeCodePropInfo = dataTypeInfo.getPropInfoByName(nextNodeCode);
                    if (!nextNodeCodePropInfo) {
                        break;
                    }
                    // 下一级为子表或对象
                    if (nextNodeCodePropInfo.typeInfo) {
                        dataTypeInfo = nextNodeCodePropInfo.typeInfo;
                    }
                }
                else if (dataTypeInfo && dataTypeInfo.getPropInfoByName(prop)) {
                    var dataPropInfo = dataTypeInfo.getPropInfoByName(prop);
                    nodeCodes.push(dataPropInfo.name);
                }
                else {
                    //throw new Error(`错误的属性参数 ${entityExpression}`);
                    break;
                }
            }
        }
        return nodeCodes;
    };
    /**
     * 找到元数据中所有实体路径
     * @param dataTypeInfo
     * @param results
     * @param paths
     */
    ExpressionUtil.getChildrenEntityPaths = function (dataTypeInfo, results, paths) {
        var _this = this;
        if (paths === void 0) { paths = []; }
        var list = dataTypeInfo.getPropInfosByGroup(DataPropGroup.List);
        if (list && list.length > 0) {
            list.forEach(function (dataPropInfo) {
                if (paths.length === 0) {
                    results.push([dataPropInfo.name]);
                }
                var childrens = dataPropInfo.typeInfo.getPropInfosByGroup(DataPropGroup.List);
                if (childrens && childrens.length > 0) {
                    paths.push(dataPropInfo.name);
                    childrens.forEach(function (dataPropInfo) {
                        _this.getChildrenEntityPaths(dataPropInfo.typeInfo, results, paths);
                    });
                }
                else {
                    if (paths.length !== 0) {
                        paths.push(dataPropInfo.name);
                        results.push(tslib_1.__spread(paths));
                    }
                    paths.length = 0;
                }
            });
        }
        else {
            if (paths.length > 0) {
                paths.push(dataTypeInfo.entityInfo.nodeCode);
                results.push(tslib_1.__spread(paths));
            }
            paths.length = 0;
        }
    };
    /**
     * 获取指定绑定路径的当前行数据
     * @param paths 绑定路径
     * @param bindingData
     * @returns
     */
    ExpressionUtil.getCurrentRowByPaths = function (paths, bindingData) {
        var result = null;
        var bindingList = bindingData.getValue(paths);
        if (bindingList && bindingList.length > 0) {
            var primaryValue = bindingList.currentItem.primaryKeyValue || null;
            // 使用事件中的主键
            // 主表或下级表新增，此时事件行就是当前行，无需处理
            if (primaryValue) {
                var bindingObject = bindingList.findById(primaryValue);
                if (bindingObject) {
                    result = bindingObject.toJSON();
                }
            }
        }
        return result;
    };
    /**
     * 从实体路径中获取级数最大的从表或从从表
     * @param paths
     * @returns
     */
    ExpressionUtil.getAvailableChildrenPathsFromEntityPaths = function (paths, entityTypeInfo) {
        var nodeCodes = [];
        paths = tslib_1.__spread(paths);
        while (paths.length > 0) {
            var dataPropInfo = entityTypeInfo.getPropInfoByPath(paths);
            if (dataPropInfo.group === 'List') {
                nodeCodes = paths;
                break;
            }
            paths.pop();
        }
        return nodeCodes;
    };
    /**
     * 从路径中获取绑定路径
     * @param paths 路径
     * @param entityTypeInfo entityTypeInfo
     * @returns
     */
    ExpressionUtil.getBindingPath = function (paths, entityTypeInfo) {
        paths = this.getEntityPath(paths);
        var entityPaths = this.getAvailableChildrenPathsFromEntityPaths(paths, entityTypeInfo);
        return entityPaths;
    };
    ExpressionUtil.getEntityPath = function (path) {
        var paths = path.filter(function (value, index) {
            if (index % 2 === 0 && value.includes(':')) {
                return false;
            }
            else {
                return true;
            }
        });
        return paths;
    };
    return ExpressionUtil;
}());
export { ExpressionUtil };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl91dGlsLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2V4cHJlc3Npb24vdXRpbHMvZXhwcmVzc2lvbl91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQUUsYUFBYSxFQUE4QixNQUFNLG9CQUFvQixDQUFDO0FBQy9FLE9BQU8sRUFBRSxlQUFlLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFckU7SUFBQTtJQTBLQSxDQUFDO0lBektlLHlDQUEwQixHQUF4QyxVQUF5QyxJQUFZLEVBQUUsY0FBNEI7UUFBbkYsaUJBMkJDO1FBMUJDLElBQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNoQixZQUFZO1FBQ1osSUFBTSxrQkFBa0IsR0FBRyxJQUFJLE1BQU0sQ0FBQyx3QkFBc0IsZUFBZSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsNkJBQTBCLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDdEgsSUFBTSxjQUFjLEdBQXFCLElBQUksQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUN4RSxJQUFJLGNBQWMsSUFBSSxjQUFjLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMvQyx5Q0FBeUM7WUFDekMsSUFBTSxnQkFBYyxHQUFHLGtCQUFrQixDQUFDO1lBQzFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsVUFBQyxhQUFxQjtnQkFDM0MsSUFBTSxtQkFBbUIsR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLGdCQUFjLENBQUMsQ0FBQztnQkFDaEUsSUFBSSxtQkFBbUIsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO29CQUNwQyxJQUFNLFFBQVEsR0FBRyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDeEMsSUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQSxDQUFD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Li9iaW5kaW5nLWRhdGEvaW5kZXhcIjtcbmltcG9ydCB7IERhdGFQcm9wR3JvdXAsIERhdGFQcm9wSW5mbywgRGF0YVR5cGVJbmZvIH0gZnJvbSBcIi4uLy4uL2VudGl0eS9pbmRleFwiO1xuaW1wb3J0IHsgRU5USVRZX1RFTVBMQVRFLCBHUk9VUF9GVU5DVElPTlMgfSBmcm9tIFwiLi4vcmVzb2x2ZXIvaW5kZXhcIjtcblxuZXhwb3J0IGNsYXNzIEV4cHJlc3Npb25VdGlsIHtcbiAgcHVibGljIHN0YXRpYyBnZXRHcm91cEZ1bmN0aW9uRGVwZW5kZW5jeShleHByOiBzdHJpbmcsIGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8pOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgZGVwcyA9IFtdO1xuICAgIC8vIOiOt+WPluiBmuWQiOWHveaVsOS+nei1lumhuVxuICAgIGNvbnN0IGdyb3VwRnVuY3Rpb25SZWdleCA9IG5ldyBSZWdFeHAoYERlZmF1bHRGdW5jdGlvblxcXFwuKCR7R1JPVVBfRlVOQ1RJT05TLmpvaW4oJ3wnKX0pXFxcXHMqXFxcXChbXlxcXFxyXFxcXG5cXFxcKV0qXFxcXClgLCBcImdcIik7XG4gICAgY29uc3QgZ3JvdXBGdW5jdGlvbnM6IFJlZ0V4cE1hdGNoQXJyYXkgPSBleHByLm1hdGNoKGdyb3VwRnVuY3Rpb25SZWdleCk7XG4gICAgaWYgKGdyb3VwRnVuY3Rpb25zICYmIGdyb3VwRnVuY3Rpb25zLmxlbmd0aCA+IDApIHtcbiAgICAgIC8vIHRvZG86IOS9v+eUqOato+WImeWMuemFjeaXtuWPr+iDveS8muWboOS4uuWPguaVsOS4reaciemAl+WPt+WvvOiHtOmXrumimO+8jOWQjue7reS9v+eUqGFzdOino+aekFxuICAgICAgY29uc3QgYXJndW1lbnRzUmVnZXggPSAvXFwoKFteXFxyXFxuXFwpXSopXFwpLztcbiAgICAgIGdyb3VwRnVuY3Rpb25zLmZvckVhY2goKGdyb3VwRnVuY3Rpb246IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCBhcmd1bWVudE1hdGNoUmVzdWx0ID0gZ3JvdXBGdW5jdGlvbi5tYXRjaChhcmd1bWVudHNSZWdleCk7XG4gICAgICAgIGlmIChhcmd1bWVudE1hdGNoUmVzdWx0Lmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgIGNvbnN0IGFyZ3VtZW50ID0gYXJndW1lbnRNYXRjaFJlc3VsdFsxXTtcbiAgICAgICAgICBjb25zdCBhcmdzID0gYXJndW1lbnQuc3BsaXQoJywnKS5tYXAocCA9PiBwLnJlcGxhY2UoL1xcXCIvZywgJycpKTtcbiAgICAgICAgICBpZiAoYXJncyAmJiBhcmdzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgbGV0IGl0ZW06IGFueSA9IGFyZ3Muam9pbignLicpO1xuICAgICAgICAgICAgaXRlbSA9IHRoaXMuY29udmVydFRvTm9kZUNvZGUoaXRlbSwgZW50aXR5VHlwZUluZm8pLmpvaW4oJy4nKTtcbiAgICAgICAgICAgIGl0ZW0gPSBpdGVtLnN1YnN0cihpdGVtLmluZGV4T2YoJy4nKSArIDEpO1xuICAgICAgICAgICAgY29uc3QgZGVwID0gaXRlbS5zcGxpdCgnLicpO1xuICAgICAgICAgICAgZGVwLnNwbGljZSgwLCAwLCBFTlRJVFlfVEVNUExBVEUpO1xuICAgICAgICAgICAgZGVwcy5wdXNoKGRlcC5qb2luKCcvJykpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYOaXoOazleino+aekOWPguaVsO+8miAke0pTT04uc3RyaW5naWZ5KGFyZ3VtZW50KX1gKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gZGVwcztcbiAgfVxuICAvKipcbiAgICog5bCGdm9Db2Rl6L2s5o2i5Li65YmN56uvbm9kZUNvZGVcbiAgICogQHBhcmFtIGVudGl0eUV4cHJlc3Npb24gbGlrZSBFbnRpdHkuQ2hpbGQucDFcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGNvbnZlcnRUb05vZGVDb2RlKGVudGl0eUV4cHJlc3Npb246IHN0cmluZywgZW50aXR5VHlwZUluZm86IERhdGFUeXBlSW5mbyk6IHN0cmluZ1tdIHtcbiAgICAvLyBVc2VyRW50aXR5LnN0b3J5cy5wMVxuICAgIGNvbnN0IG5vZGVDb2RlcyA9IFtdO1xuICAgIGlmIChlbnRpdHlUeXBlSW5mbyAmJiBlbnRpdHlFeHByZXNzaW9uLmluY2x1ZGVzKCcuJykpIHtcbiAgICAgIGNvbnN0IGVudGl0eUV4cHJlc3Npb25zID0gZW50aXR5RXhwcmVzc2lvbi5zcGxpdCgnLicpIHx8IFtdO1xuICAgICAgbGV0IGRhdGFUeXBlSW5mbyA9IGVudGl0eVR5cGVJbmZvO1xuICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGVudGl0eUV4cHJlc3Npb25zLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgICBjb25zdCBwcm9wID0gZW50aXR5RXhwcmVzc2lvbnNbaW5kZXhdO1xuICAgICAgICBpZiAoZGF0YVR5cGVJbmZvICYmIGRhdGFUeXBlSW5mby5lbnRpdHlJbmZvICYmIGRhdGFUeXBlSW5mby5lbnRpdHlJbmZvLm5vZGVDb2RlID09PSBwcm9wIHx8IGRhdGFUeXBlSW5mby5lbnRpdHlJbmZvLm9yaWdpbmFsQ29kZSA9PT0gcHJvcCkge1xuICAgICAgICAgIC8vIOesrOS4gOS4quaYr+S4u+ihqGNvZGXvvIzkuI3og73ovaxub2RlQ29kZVxuICAgICAgICAgIGlmIChpbmRleCA9PT0gMCkge1xuICAgICAgICAgICAgbm9kZUNvZGVzLnB1c2goZGF0YVR5cGVJbmZvLmVudGl0eUluZm8ub3JpZ2luYWxDb2RlKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbm9kZUNvZGVzLnB1c2goZGF0YVR5cGVJbmZvLmVudGl0eUluZm8ubm9kZUNvZGUpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIOS4i+S4gOe6p+WPr+iDveS4uuWtkOihqOOAgeWvueixoeaIluWxnuaAp1xuICAgICAgICAgIGNvbnN0IG5leHROb2RlQ29kZSA9IGVudGl0eUV4cHJlc3Npb25zW2luZGV4ICsgMV07XG4gICAgICAgICAgaWYgKCFuZXh0Tm9kZUNvZGUpIHtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBuZXh0Tm9kZUNvZGVQcm9wSW5mbyA9IGRhdGFUeXBlSW5mby5nZXRQcm9wSW5mb0J5TmFtZShuZXh0Tm9kZUNvZGUpO1xuICAgICAgICAgIGlmICghbmV4dE5vZGVDb2RlUHJvcEluZm8pIHtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyDkuIvkuIDnuqfkuLrlrZDooajmiJblr7nosaFcbiAgICAgICAgICBpZiAobmV4dE5vZGVDb2RlUHJvcEluZm8udHlwZUluZm8pIHtcbiAgICAgICAgICAgIGRhdGFUeXBlSW5mbyA9IG5leHROb2RlQ29kZVByb3BJbmZvLnR5cGVJbmZvO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChkYXRhVHlwZUluZm8gJiYgZGF0YVR5cGVJbmZvLmdldFByb3BJbmZvQnlOYW1lKHByb3ApKSB7XG4gICAgICAgICAgY29uc3QgZGF0YVByb3BJbmZvID0gZGF0YVR5cGVJbmZvLmdldFByb3BJbmZvQnlOYW1lKHByb3ApO1xuICAgICAgICAgIG5vZGVDb2Rlcy5wdXNoKGRhdGFQcm9wSW5mby5uYW1lKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcihg6ZSZ6K+v55qE5bGe5oCn5Y+C5pWwICR7ZW50aXR5RXhwcmVzc2lvbn1gKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbm9kZUNvZGVzO1xuICB9XG4gIC8qKlxuICAgKiDmib7liLDlhYPmlbDmja7kuK3miYDmnInlrp7kvZPot6/lvoRcbiAgICogQHBhcmFtIGRhdGFUeXBlSW5mbyBcbiAgICogQHBhcmFtIHJlc3VsdHMgXG4gICAqIEBwYXJhbSBwYXRocyBcbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgZ2V0Q2hpbGRyZW5FbnRpdHlQYXRocyhkYXRhVHlwZUluZm86IERhdGFUeXBlSW5mbywgcmVzdWx0czogYW55W10sIHBhdGhzOiBzdHJpbmdbXSA9IFtdKSB7XG4gICAgY29uc3QgbGlzdDogRGF0YVByb3BJbmZvW10gPSBkYXRhVHlwZUluZm8uZ2V0UHJvcEluZm9zQnlHcm91cChEYXRhUHJvcEdyb3VwLkxpc3QpO1xuICAgIGlmIChsaXN0ICYmIGxpc3QubGVuZ3RoID4gMCkge1xuICAgICAgbGlzdC5mb3JFYWNoKChkYXRhUHJvcEluZm86IERhdGFQcm9wSW5mbykgPT4ge1xuICAgICAgICBpZiAocGF0aHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgcmVzdWx0cy5wdXNoKFtkYXRhUHJvcEluZm8ubmFtZV0pO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGNoaWxkcmVuczogRGF0YVByb3BJbmZvW10gPSBkYXRhUHJvcEluZm8udHlwZUluZm8uZ2V0UHJvcEluZm9zQnlHcm91cChEYXRhUHJvcEdyb3VwLkxpc3QpO1xuICAgICAgICBpZiAoY2hpbGRyZW5zICYmIGNoaWxkcmVucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgcGF0aHMucHVzaChkYXRhUHJvcEluZm8ubmFtZSk7XG4gICAgICAgICAgY2hpbGRyZW5zLmZvckVhY2goKGRhdGFQcm9wSW5mbzogRGF0YVByb3BJbmZvKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmdldENoaWxkcmVuRW50aXR5UGF0aHMoZGF0YVByb3BJbmZvLnR5cGVJbmZvLCByZXN1bHRzLCBwYXRocyk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKHBhdGhzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICAgICAgcGF0aHMucHVzaChkYXRhUHJvcEluZm8ubmFtZSk7XG4gICAgICAgICAgICByZXN1bHRzLnB1c2goWy4uLnBhdGhzXSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHBhdGhzLmxlbmd0aCA9IDA7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAocGF0aHMubGVuZ3RoID4gMCkge1xuICAgICAgICBwYXRocy5wdXNoKGRhdGFUeXBlSW5mby5lbnRpdHlJbmZvLm5vZGVDb2RlKTtcbiAgICAgICAgcmVzdWx0cy5wdXNoKFsuLi5wYXRoc10pO1xuICAgICAgfVxuICAgICAgcGF0aHMubGVuZ3RoID0gMDtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOiOt+WPluaMh+Wumue7keWumui3r+W+hOeahOW9k+WJjeihjOaVsOaNrlxuICAgKiBAcGFyYW0gcGF0aHMg57uR5a6a6Lev5b6EXG4gICAqIEBwYXJhbSBiaW5kaW5nRGF0YSBcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGdldEN1cnJlbnRSb3dCeVBhdGhzKHBhdGhzOiBzdHJpbmdbXSwgYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhKTogbnVsbCB8IHsgW3Byb3A6IHN0cmluZ106IGFueSB9IHtcbiAgICBsZXQgcmVzdWx0ID0gbnVsbDtcbiAgICBjb25zdCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QgPSBiaW5kaW5nRGF0YS5nZXRWYWx1ZShwYXRocykgYXMgQmluZGluZ0xpc3Q7XG4gICAgaWYgKGJpbmRpbmdMaXN0ICYmIGJpbmRpbmdMaXN0Lmxlbmd0aCA+IDApIHtcbiAgICAgIGxldCBwcmltYXJ5VmFsdWUgPSBiaW5kaW5nTGlzdC5jdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWUgfHwgbnVsbDtcbiAgICAgIC8vIOS9v+eUqOS6i+S7tuS4reeahOS4u+mUrlxuICAgICAgLy8g5Li76KGo5oiW5LiL57qn6KGo5paw5aKe77yM5q2k5pe25LqL5Lu26KGM5bCx5piv5b2T5YmN6KGM77yM5peg6ZyA5aSE55CGXG4gICAgICBpZiAocHJpbWFyeVZhbHVlKSB7XG4gICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBiaW5kaW5nTGlzdC5maW5kQnlJZChwcmltYXJ5VmFsdWUpO1xuICAgICAgICBpZiAoYmluZGluZ09iamVjdCkge1xuICAgICAgICAgIHJlc3VsdCA9IGJpbmRpbmdPYmplY3QudG9KU09OKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuICAvKipcbiAgICog5LuO5a6e5L2T6Lev5b6E5Lit6I635Y+W57qn5pWw5pyA5aSn55qE5LuO6KGo5oiW5LuO5LuO6KGoXG4gICAqIEBwYXJhbSBwYXRocyBcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGdldEF2YWlsYWJsZUNoaWxkcmVuUGF0aHNGcm9tRW50aXR5UGF0aHMocGF0aHM6IHN0cmluZ1tdLCBlbnRpdHlUeXBlSW5mbzogRGF0YVR5cGVJbmZvKTogc3RyaW5nW10ge1xuICAgIGxldCBub2RlQ29kZXMgPSBbXTtcbiAgICBwYXRocyA9IFsuLi5wYXRoc107XG4gICAgd2hpbGUgKHBhdGhzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IGRhdGFQcm9wSW5mbyA9IGVudGl0eVR5cGVJbmZvLmdldFByb3BJbmZvQnlQYXRoKHBhdGhzKTtcbiAgICAgIGlmIChkYXRhUHJvcEluZm8uZ3JvdXAgPT09ICdMaXN0Jykge1xuICAgICAgICBub2RlQ29kZXMgPSBwYXRocztcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBwYXRocy5wb3AoKTtcbiAgICB9XG4gICAgcmV0dXJuIG5vZGVDb2RlcztcbiAgfVxuICAvKipcbiAgICog5LuO6Lev5b6E5Lit6I635Y+W57uR5a6a6Lev5b6EXG4gICAqIEBwYXJhbSBwYXRocyDot6/lvoRcbiAgICogQHBhcmFtIGVudGl0eVR5cGVJbmZvIGVudGl0eVR5cGVJbmZvXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBnZXRCaW5kaW5nUGF0aChwYXRoczogc3RyaW5nW10sIGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8pIHtcbiAgICBwYXRocyA9IHRoaXMuZ2V0RW50aXR5UGF0aChwYXRocyk7XG4gICAgY29uc3QgZW50aXR5UGF0aHMgPSB0aGlzLmdldEF2YWlsYWJsZUNoaWxkcmVuUGF0aHNGcm9tRW50aXR5UGF0aHMocGF0aHMsIGVudGl0eVR5cGVJbmZvKTtcbiAgICByZXR1cm4gZW50aXR5UGF0aHM7XG4gIH1cbiAgcHVibGljIHN0YXRpYyBnZXRFbnRpdHlQYXRoKHBhdGg6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IHBhdGhzID0gcGF0aC5maWx0ZXIoKHZhbHVlOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgIGlmIChpbmRleCAlIDIgPT09IDAgJiYgdmFsdWUuaW5jbHVkZXMoJzonKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcGF0aHM7XG4gIH1cbn0iXX0=