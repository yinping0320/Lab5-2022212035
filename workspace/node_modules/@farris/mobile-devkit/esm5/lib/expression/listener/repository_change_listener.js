import * as tslib_1 from "tslib";
import { ModifyType } from '../../changeset/index';
import { ChangeListener } from './change_listener';
import { Expression } from '../expression/index';
import { NAMESPACE } from '../core/index';
var EventType = Expression.EventType;
var RepositoryChangeListener = /** @class */ (function (_super) {
    tslib_1.__extends(RepositoryChangeListener, _super);
    function RepositoryChangeListener(viewModelContext) {
        var _this = _super.call(this) || this;
        _this.viewModelContext = viewModelContext;
        _this.namespace = _this.viewModelContext.injector.get(NAMESPACE, null);
        _this.repository = _this.viewModelContext.repository;
        _this.bindingData = _this.viewModelContext.bindingData;
        _this.registerEvent();
        return _this;
    }
    RepositoryChangeListener.prototype.registerEvent = function () {
        var _this = this;
        if (this.repository && this.repository.changes) {
            this.repository.changes.subscribe(function (change) {
                var eventType = _this.convertEventType(change);
                if (!eventType) {
                    return;
                }
                var path = _this.buildEventPath(change);
                var modification = {
                    ns: _this.namespace,
                    type: eventType,
                    path: path,
                    value: change.value,
                    source: Expression.EventSource.Field,
                };
                // console.log("RepositoryChangeListener", modification);
                _this.subject.next(modification);
            });
        }
        // repository只监听值变化事件
        if (this.repository && this.repository.entityCollectionChange) {
            this.repository.entityCollectionChange.subscribe(function (change) {
                var eventType = _this.convertEventType(change);
                if (!eventType) {
                    return;
                }
                var path = _this.buildEventPath(change);
                var modification = {
                    ns: _this.namespace,
                    type: eventType,
                    path: path,
                    value: change.value,
                    source: Expression.EventSource.Repository,
                };
                _this.subject.next(modification);
            });
        }
    };
    /**
     * 构建事件路径参数
     * @param event event
     * @description 构建完之后的路径类似[id,prop] or [id,从表名s,从表当前行id,从表属性] or [id,udt,udt_prop]
     * @returns
     */
    RepositoryChangeListener.prototype.buildEventPath = function (event) {
        var _this = this;
        var paths = event.path;
        var result = [];
        if (!paths || paths.length < 1) {
            // 主表新增时path为空
            return result;
        }
        // 过滤掉udt的冒号，关联字段的id
        result = paths.filter(function (path, index) {
            if (index % 2 === 0 && path.includes(':')) {
                if (path === ':') {
                    return false;
                }
                var primaryKey = path.split(':')[0];
                if (primaryKey !== _this.repository.primaryKey) {
                    return false;
                }
            }
            return true;
        });
        // 移除路径中的id字符串
        // result = paths.map((path: string, index: number) => {
        //   if (path.includes(':') && index % 2 === 0) {
        //     return path.split(':')[1];
        //   }
        //   return path;
        // });
        // 此时result中不应该有冒号
        return result;
    };
    RepositoryChangeListener.prototype.convertEventType = function (change) {
        var eventType = null;
        if (change.type === ModifyType.Add || change.type === ModifyType.AddData || change.type === ModifyType.Insert) {
            // eventType = Expression.EventType.Append;
            // 不处理新增
        }
        else if (change.type === ModifyType.Remove || change.type === ModifyType.RemoveData) {
            // eventType = Expression.EventType.Remove;
        }
        else if (change.type === ModifyType.Load) {
            // eventType = Expression.EventType.Load;
        }
        else if (change.type === ModifyType.ValueChange) {
            //eventType = Expression.EventType.ValueChanged;
            // 不处理值变化
        }
        else if (change.type === ModifyType.Update) {
            eventType = Expression.EventType.Update;
        }
        return eventType;
    };
    return RepositoryChangeListener;
}(ChangeListener));
export { RepositoryChangeListener };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3NpdG9yeV9jaGFuZ2VfbGlzdGVuZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZXhwcmVzc2lvbi9saXN0ZW5lci9yZXBvc2l0b3J5X2NoYW5nZV9saXN0ZW5lci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFnQixVQUFVLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUdqRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRWpELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFJMUMsSUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQztBQUV2QztJQUF1QyxvREFBYztJQVFuRCxrQ0FBb0IsZ0JBQWtDO1FBQXRELFlBQ0UsaUJBQU8sU0FNUjtRQVBtQixzQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBR3BELEtBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3JFLEtBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQztRQUNuRCxLQUFJLENBQUMsV0FBVyxHQUFHLEtBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUM7UUFDckQsS0FBSSxDQUFDLGFBQWEsRUFBRSxDQUFDOztJQUN2QixDQUFDO0lBRU8sZ0RBQWEsR0FBckI7UUFBQSxpQkFxQ0M7UUFwQ0MsSUFBSSxJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFO1lBQzlDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxVQUFDLE1BQW9CO2dCQUNyRCxJQUFJ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LE1BQU0sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxPQUFPLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsTUFBTSxFQUFFO1lBQzdHLDJDQUEyQztZQUMzQyxRQUFRO1NBQ1Q7YUFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxVQUFVLEVBQUU7WUFDckYsMkNBQTJDO1NBQzVDO2FBQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxJQUFJLEVBQUU7WUFDMUMseUNBQXlDO1NBQzFDO2FBQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxXQUFXLEVBQUU7WUFDakQsZ0RBQWdEO1lBQ2hELFNBQVM7U0FDVjthQUFNLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsTUFBTSxFQUFFO1lBQzVDLFNBQVMsR0FBRyxVQUFVLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQTtTQUN4QztRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFDSCwrQkFBQztBQUFELENBQUMsQUE5R0QsQ0FBdUMsY0FBYyxHQThHcEQ7QUFFRCxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1vZGlmaWNhdGlvbiwgTW9kaWZ5VHlwZSB9IGZyb20gJy4uLy4uL2NoYW5nZXNldC9pbmRleCc7XG5pbXBvcnQgeyBFbnRpdHkgfSBmcm9tICcuLi8uLi9lbnRpdHkvaW5kZXgnO1xuaW1wb3J0IHsgUmVwb3NpdG9yeSB9IGZyb20gJy4uLy4uL3JlcG9zaXRvcnkvaW5kZXgnO1xuaW1wb3J0IHsgQ2hhbmdlTGlzdGVuZXIgfSBmcm9tICcuL2NoYW5nZV9saXN0ZW5lcic7XG5pbXBvcnQgeyBFeHByZXNzaW9uIH0gZnJvbSAnLi4vZXhwcmVzc2lvbi9pbmRleCc7XG5pbXBvcnQgeyBCaW5kaW5nRGF0YSB9IGZyb20gJy4uLy4uL2JpbmRpbmctZGF0YS9pbmRleCc7XG5pbXBvcnQgeyBOQU1FU1BBQ0UgfSBmcm9tICcuLi9jb3JlL2luZGV4JztcbmltcG9ydCB7IFZpZXdNb2RlbENvbnRleHQgfSBmcm9tICcuLi8uLi92aWV3LW1vZGVsL2luZGV4JztcblxudHlwZSBFdmVudEFyZ3MgPSBFeHByZXNzaW9uLkV2ZW50QXJncztcbmNvbnN0IEV2ZW50VHlwZSA9IEV4cHJlc3Npb24uRXZlbnRUeXBlO1xuXG5jbGFzcyBSZXBvc2l0b3J5Q2hhbmdlTGlzdGVuZXIgZXh0ZW5kcyBDaGFuZ2VMaXN0ZW5lciB7XG5cbiAgcHJpdmF0ZSBuYW1lc3BhY2U6IHN0cmluZztcblxuICBwcml2YXRlIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8RW50aXR5PjtcblxuICBwcml2YXRlIGJpbmRpbmdEYXRhOiBCaW5kaW5nRGF0YTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHZpZXdNb2RlbENvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQpIHtcbiAgICBzdXBlcigpO1xuICAgIFxuICAgIHRoaXMubmFtZXNwYWNlID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LmluamVjdG9yLmdldChOQU1FU1BBQ0UsIG51bGwpO1xuICAgIHRoaXMucmVwb3NpdG9yeSA9IHRoaXMudmlld01vZGVsQ29udGV4dC5yZXBvc2l0b3J5O1xuICAgIHRoaXMuYmluZGluZ0RhdGEgPSB0aGlzLnZpZXdNb2RlbENvbnRleHQuYmluZGluZ0RhdGE7XG4gICAgdGhpcy5yZWdpc3RlckV2ZW50KCk7XG4gIH1cblxuICBwcml2YXRlIHJlZ2lzdGVyRXZlbnQoKSB7XG4gICAgaWYgKHRoaXMucmVwb3NpdG9yeSAmJiB0aGlzLnJlcG9zaXRvcnkuY2hhbmdlcykge1xuICAgICAgdGhpcy5yZXBvc2l0b3J5LmNoYW5nZXMuc3Vic2NyaWJlKChjaGFuZ2U6IE1vZGlmaWNhdGlvbikgPT4ge1xuICAgICAgICBsZXQgZXZlbnRUeXBlID0gdGhpcy5jb252ZXJ0RXZlbnRUeXBlKGNoYW5nZSk7XG4gICAgICAgIGlmICghZXZlbnRUeXBlKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmJ1aWxkRXZlbnRQYXRoKGNoYW5nZSk7XG4gICAgICAgIGNvbnN0IG1vZGlmaWNhdGlvbjogRXZlbnRBcmdzID0ge1xuICAgICAgICAgIG5zOiB0aGlzLm5hbWVzcGFjZSxcbiAgICAgICAgICB0eXBlOiBldmVudFR5cGUsXG4gICAgICAgICAgcGF0aDogcGF0aCxcbiAgICAgICAgICB2YWx1ZTogY2hhbmdlLnZhbHVlLFxuICAgICAgICAgIHNvdXJjZTogRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5GaWVsZCxcbiAgICAgICAgfTtcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJSZXBvc2l0b3J5Q2hhbmdlTGlzdGVuZXJcIiwgbW9kaWZpY2F0aW9uKTtcbiAgICAgICAgdGhpcy5zdWJqZWN0Lm5leHQobW9kaWZpY2F0aW9uKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICAvLyByZXBvc2l0b3J55Y+q55uR5ZCs5YC85Y+Y5YyW5LqL5Lu2XG4gICAgaWYgKHRoaXMucmVwb3NpdG9yeSAmJiB0aGlzLnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbkNoYW5nZSkge1xuICAgICAgdGhpcy5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb25DaGFuZ2Uuc3Vic2NyaWJlKChjaGFuZ2U6IE1vZGlmaWNhdGlvbikgPT4ge1xuICAgICAgICBsZXQgZXZlbnRUeXBlID0gdGhpcy5jb252ZXJ0RXZlbnRUeXBlKGNoYW5nZSk7XG4gICAgICAgIGlmICghZXZlbnRUeXBlKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmJ1aWxkRXZlbnRQYXRoKGNoYW5nZSk7XG4gICAgICAgIGNvbnN0IG1vZGlmaWNhdGlvbjogRXZlbnRBcmdzID0ge1xuICAgICAgICAgIG5zOiB0aGlzLm5hbWVzcGFjZSxcbiAgICAgICAgICB0eXBlOiBldmVudFR5cGUsXG4gICAgICAgICAgcGF0aDogcGF0aCxcbiAgICAgICAgICB2YWx1ZTogY2hhbmdlLnZhbHVlLFxuICAgICAgICAgIHNvdXJjZTogRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5SZXBvc2l0b3J5LFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnN1YmplY3QubmV4dChtb2RpZmljYXRpb24pO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOaehOW7uuS6i+S7tui3r+W+hOWPguaVsFxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcbiAgICogQGRlc2NyaXB0aW9uIOaehOW7uuWujOS5i+WQjueahOi3r+W+hOexu+S8vFtpZCxwcm9wXSBvciBbaWQs5LuO6KGo5ZCNcyzku47ooajlvZPliY3ooYxpZCzku47ooajlsZ7mgKddIG9yIFtpZCx1ZHQsdWR0X3Byb3BdXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHVibGljIGJ1aWxkRXZlbnRQYXRoKGV2ZW50OiBNb2RpZmljYXRpb24pOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgcGF0aHMgPSBldmVudC5wYXRoO1xuICAgIGxldCByZXN1bHQgPSBbXTtcbiAgICBpZiAoIXBhdGhzIHx8IHBhdGhzLmxlbmd0aCA8IDEpIHtcbiAgICAgIC8vIOS4u+ihqOaWsOWinuaXtnBhdGjkuLrnqbpcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICAgIC8vIOi/h+a7pOaOiXVkdOeahOWGkuWPt++8jOWFs+iBlOWtl+auteeahGlkXG4gICAgcmVzdWx0ID0gcGF0aHMuZmlsdGVyKChwYXRoOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgIGlmIChpbmRleCAlIDIgPT09IDAgJiYgcGF0aC5pbmNsdWRlcygnOicpKSB7XG4gICAgICAgIGlmIChwYXRoID09PSAnOicpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcHJpbWFyeUtleSA9IHBhdGguc3BsaXQoJzonKVswXTtcbiAgICAgICAgaWYgKHByaW1hcnlLZXkgIT09IHRoaXMucmVwb3NpdG9yeS5wcmltYXJ5S2V5KSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KTtcbiAgICAvLyDnp7vpmaTot6/lvoTkuK3nmoRpZOWtl+espuS4slxuICAgIC8vIHJlc3VsdCA9IHBhdGhzLm1hcCgocGF0aDogc3RyaW5nLCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgLy8gICBpZiAocGF0aC5pbmNsdWRlcygnOicpICYmIGluZGV4ICUgMiA9PT0gMCkge1xuICAgIC8vICAgICByZXR1cm4gcGF0aC5zcGxpdCgnOicpWzFdO1xuICAgIC8vICAgfVxuICAgIC8vICAgcmV0dXJuIHBhdGg7XG4gICAgLy8gfSk7XG4gICAgLy8g5q2k5pe2cmVzdWx05Lit5LiN5bqU6K+l5pyJ5YaS5Y+3XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHByaXZhdGUgY29udmVydEV2ZW50VHlwZShjaGFuZ2U6IE1vZGlmaWNhdGlvbik6IEV4cHJlc3Npb24uRXZlbnRUeXBlIHtcbiAgICBsZXQgZXZlbnRUeXBlID0gbnVsbDtcbiAgICBpZiAoY2hhbmdlLnR5cGUgPT09IE1vZGlmeVR5cGUuQWRkIHx8IGNoYW5nZS50eXBlID09PSBNb2RpZnlUeXBlLkFkZERhdGEgfHwgY2hhbmdlLnR5cGUgPT09IE1vZGlmeVR5cGUuSW5zZXJ0KSB7XG4gICAgICAvLyBldmVudFR5cGUgPSBFeHByZXNzaW9uLkV2ZW50VHlwZS5BcHBlbmQ7XG4gICAgICAvLyDkuI3lpITnkIbmlrDlop5cbiAgICB9IGVsc2UgaWYgKGNoYW5nZS50eXBlID09PSBNb2RpZnlUeXBlLlJlbW92ZSB8fCBjaGFuZ2UudHlwZSA9PT0gTW9kaWZ5VHlwZS5SZW1vdmVEYXRhKSB7XG4gICAgICAvLyBldmVudFR5cGUgPSBFeHByZXNzaW9uLkV2ZW50VHlwZS5SZW1vdmU7XG4gICAgfSBlbHNlIGlmIChjaGFuZ2UudHlwZSA9PT0gTW9kaWZ5VHlwZS5Mb2FkKSB7XG4gICAgICAvLyBldmVudFR5cGUgPSBFeHByZXNzaW9uLkV2ZW50VHlwZS5Mb2FkO1xuICAgIH0gZWxzZSBpZiAoY2hhbmdlLnR5cGUgPT09IE1vZGlmeVR5cGUuVmFsdWVDaGFuZ2UpIHtcbiAgICAgIC8vZXZlbnRUeXBlID0gRXhwcmVzc2lvbi5FdmVudFR5cGUuVmFsdWVDaGFuZ2VkO1xuICAgICAgLy8g5LiN5aSE55CG5YC85Y+Y5YyWXG4gICAgfSBlbHNlIGlmIChjaGFuZ2UudHlwZSA9PT0gTW9kaWZ5VHlwZS5VcGRhdGUpIHtcbiAgICAgIGV2ZW50VHlwZSA9IEV4cHJlc3Npb24uRXZlbnRUeXBlLlVwZGF0ZVxuICAgIH1cbiAgICByZXR1cm4gZXZlbnRUeXBlO1xuICB9XG59XG5cbmV4cG9ydCB7IFJlcG9zaXRvcnlDaGFuZ2VMaXN0ZW5lciB9Il19