import { MetadataUtil } from '../core/index';
import { Repository } from '../repository/index';
import { CommandBus } from '../command/index';
import { BindingData } from '../binding-data/index';
import { UIState } from '../ui-state/index';
import { StateMachine } from '../state-machine/index';
import { Form } from '../form/index';
import { ViewModelContext } from './view_model_context';
import { COMMAND_METHOD_META } from './decorators';
import { EMPTY, from, of } from 'rxjs';
import { concatMap, every, tap } from 'rxjs/operators';
import { ExpressionEngineImpl, ExpressionManager, ExpressionResult, ExpressionResultFactory } from '../expression/index';
import { ControlsProxy } from '../control-proxy';
var ViewModel = /** @class */ (function () {
    /**
     * 构造函数
     */
    function ViewModel(injector, id) {
        /**
         * 扩展命令
         */
        this.extendCommands = new Map();
        this.injector = injector;
        this.id = id;
    }
    /**
     * 初始化
     */
    ViewModel.prototype.init = function () {
        this.initRepository();
        this.initContext();
        this.initBindingData();
        this.initUIState();
        this.intiStateMachine();
        this.initForm();
        this.initCommandBus();
        this.registerWithParent();
        this.initListeners();
        this.closeOldBeSession();
        this.initExpression();
        this.initControlsProxy();
        this.config();
    };
    ViewModel.prototype.config = function () {
        this.uiState.config(this.context);
    };
    ViewModel.prototype.initControlsProxy = function () {
        this.controlsProxy = this.injector.get(ControlsProxy);
    };
    ViewModel.prototype.initRepository = function () {
        this.repository = this.injector.get(Repository);
    };
    ViewModel.prototype.initContext = function () {
        this.context = this.injector.get(ViewModelContext);
        this.context.init(this);
    };
    ViewModel.prototype.initExpression = function () {
        var appContext = this.context.appContext;
        var allViewModelContexts = appContext.viewModelContextManager.getContexts();
        var existedViewModelContext = allViewModelContexts.find(function (viewModelContext) {
            if (viewModelContext.expressionEngineImpl) {
                return true;
            }
            else {
                return false;
            }
        });
        if (existedViewModelContext) {
            this.expressionEngineImpl = existedViewModelContext.expressionEngineImpl;
            this.expressionManager = existedViewModelContext.expressionManager;
            this.expressionResult = existedViewModelContext.expressionResult;
            return;
        }
        this.expressionEngineImpl = this.injector.get(ExpressionEngineImpl, null);
        this.expressionManager = this.injector.get(ExpressionManager, null);
        var expressionResultFactory = this.injector.get(ExpressionResultFactory, null);
        this.expressionResult = this.injector.get(ExpressionResult, null);
    };
    ViewModel.prototype.initBindingData = function () {
        var _this = this;
        this.bindingData = this.context.injector.get(BindingData);
        this.entityValueChangingListeners = new Map();
        this.entityValueChangedListeners = new Map();
        if (this.bindingData) {
            this.bindingData.setValueChangeInvokerFactory(function (paths) {
                return function (preValue, value, entityChanged, primaryValue) {
                    var plainPath = '/' + paths.join('/');
                    var command;
                    if (entityChanged === false) {
                        command = _this.entityValueChangingListeners[plainPath];
                    }
                    else {
                        command = _this.entityValueChangedListeners[plainPath];
                    }
                    if (!!command) {
                        var change_1 = {
                            paths: paths,
                            preValue: preValue,
                            value: value,
                            changed: entityChanged
                        };
                        var commands = command.split(';').filter(function (p) { return p; });
                        var valueChangeSuccess_1 = true;
                        return from(commands).pipe(concatMap(function (item) {
                            if (!valueChangeSuccess_1) {
                                return EMPTY;
                            }
                            return _this[item](change_1).pipe(tap(function (result) {
                                valueChangeSuccess_1 = result;
                            }));
                        }), every(function (result) { return result; }));
                    }
                    else {
                        return of(true);
                    }
                };
            });
        }
        var repositoryName = this.repository.name;
        var bindingDataManager = this.context.appContext.bindingDataManager;
        var repositoryBindingData = bindingDataManager.getBindingDataByName(repositoryName);
        this.bindingData.initByBindingList(repositoryBindingData.list, this.context, repositoryBindingData.dataTypeInfo);
    };
    ViewModel.prototype.initUIState = function () {
        this.uiState = this.injector.get(UIState);
    };
    ViewModel.prototype.intiStateMachine = function () {
        this.stateMachine = this.injector.get(StateMachine, null);
        if (!this.stateMachine) {
            return;
        }
        this.stateMachine.init(this.context);
    };
    ViewModel.prototype.initForm = function () {
        this.form = this.injector.get(Form, null);
        this.form.init();
    };
    ViewModel.prototype.initCommandBus = function () {
        this.commandBus = this.injector.get(CommandBus);
        this.extendCommandMethods();
    };
    ViewModel.prototype.extendCommandMethods = function () {
        var _this = this;
        this.ngCommands = MetadataUtil.getPropsMetadatasByName(this.constructor, COMMAND_METHOD_META);
        this.keybindingMap = new Map();
        Object.keys(this.ngCommands).forEach(function (propName) {
            var ngCommand = _this.ngCommands[propName];
            Object.defineProperty(_this, propName, {
                value: function (eventParams) {
                    var command = {
                        name: ngCommand.name,
                        params: ngCommand.params,
                        paramDescriptions: ngCommand.paramDescriptions,
                        eventParam: eventParams || null
                    };
                    return _this.commandBus.dispatch(command);
                }
            });
            if (ngCommand.keyBinding) {
                _this.keybindingMap.set(propName, ngCommand.keyBinding);
            }
        });
    };
    /**
     * 注册扩展命令方法
     */
    ViewModel.prototype.registerExtendCommand = function (commandName, commandHandler) {
        var _this = this;
        Object.defineProperty(this, commandName, {
            value: function (eventParams) {
                return commandHandler(eventParams, _this.context);
            }
        });
        this.extendCommands.set(commandName, commandHandler);
    };
    ViewModel.prototype.registerWithParent = function () {
        var parentContext = this.context.parent;
        if (!parentContext || !parentContext.viewModel || !parentContext.viewModel['childViewModels']) {
            return;
        }
        var parentViewModel = parentContext.viewModel;
        var className = this.constructor.name;
        var propName = parentViewModel['childViewModels'][className];
        parentViewModel[propName] = this;
    };
    /**
     * 关闭老的BeSession
     */
    ViewModel.prototype.closeOldBeSession = function () {
        var allViewModelContexts = this.context.appContext.viewModelContextManager.getContexts();
        if (allViewModelContexts.length === 1 && allViewModelContexts[0] === this.context) {
            this.context.repository.reset();
        }
    };
    /**
   * 从Form获取监听器
   */
    ViewModel.prototype.initListeners = function () {
        var _this = this;
        var extractPath = function (bindingBasePath, bindingPath) {
            return '/' + bindingBasePath.split('/').concat(bindingPath.split('.')).filter(function (item) { return item.length > 0; }).join('/');
        };
        if (this.form) {
            var valueChangingListeners_1 = this.form.getEntityValueChangingListeners();
            Object.keys(valueChangingListeners_1).forEach(function (bindingPath) {
                var plainPath = extractPath(_this.bindingPath, bindingPath);
                _this.entityValueChangingListeners[plainPath] = valueChangingListeners_1[bindingPath];
            });
            var valueChangedListeners_1 = this.form.getEntityValueChangedListeners();
            Object.keys(valueChangedListeners_1).forEach(function (bindingPath) {
                var plainPath = extractPath(_this.bindingPath, bindingPath);
                _this.entityValueChangedListeners[plainPath] = valueChangedListeners_1[bindingPath];
            });
        }
    };
    return ViewModel;
}());
export { ViewModel };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld19tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi92aWV3LW1vZGVsL3ZpZXdfbW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUc3QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDakQsT0FBTyxFQUFXLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxXQUFXLEVBQTBDLE1BQU0sdUJBQXVCLENBQUM7QUFDNUYsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRXhELE9BQU8sRUFBRSxtQkFBbUIsRUFBcUMsTUFBTSxjQUFjLENBQUM7QUFDdEYsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXZELE9BQU8sRUFDTCxvQkFBb0IsRUFBRSxpQkFBaUIsRUFBRSxnQkFBZ0IsRUFBRSx1QkFBdUIsRUFDbkYsTUFBTSxxQkFBcUIsQ0FBQztBQUM3QixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFakQ7SUEwRkU7O09BRUc7SUFDSCxtQkFBbUIsUUFBa0IsRUFBRSxFQUFVO1FBdEZqRDs7V0FFRztRQUNJLG1CQUFjLEdBQXFCLElBQUksR0FBRyxFQUFlLENBQUM7UUFvRi9ELElBQUksQ0FBQyxRQUFRLEdB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QUMsQ0FBQztZQUVILElBQU0sdUJBQXFCLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyw4QkFBOEIsRUFBRSxDQUFDO1lBQ3pFLE1BQU0sQ0FBQyxJQUFJLENBQUMsdUJBQXFCLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQyxXQUFXO2dCQUNyRCxJQUFNLFNBQVMsR0FBRyxXQUFXLENBQUMsS0FBSSxDQUFDLFdBQVcsRUFBRSxXQUFXLENBQUMsQ0FBQztnQkFDN0QsS0FBSSxDQUFDLDJCQUEyQixDQUFDLFNBQVMsQ0FBQyxHQUFHLHVCQUFxQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ25GLENBQUMsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDO0lBRUgsZ0JBQUM7QUFBRCxDQUFDLEFBMVRELElBMFRDO0FBRUQsT0FBTyxFQUFFLFNBQVMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWV0YWRhdGFVdGlsIH0gZnJvbSAnLi4vY29yZS9pbmRleCc7XG5pbXBvcnQgeyBJbmplY3RvciB9IGZyb20gJy4uL2NvcmUvaW5kZXgnO1xuaW1wb3J0IHsgRW50aXR5IH0gZnJvbSAnLi4vZW50aXR5L2luZGV4JztcbmltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tICcuLi9yZXBvc2l0b3J5L2luZGV4JztcbmltcG9ydCB7IENvbW1hbmQsIENvbW1hbmRCdXMgfSBmcm9tICcuLi9jb21tYW5kL2luZGV4JztcbmltcG9ydCB7IEJpbmRpbmdEYXRhLCBFbnRpdHlWYWx1ZUNoYW5nZSwgSW52b2tlT25WYWx1ZUNoYW5nZSB9IGZyb20gJy4uL2JpbmRpbmctZGF0YS9pbmRleCc7XG5pbXBvcnQgeyBVSVN0YXRlIH0gZnJvbSAnLi4vdWktc3RhdGUvaW5kZXgnO1xuaW1wb3J0IHsgU3RhdGVNYWNoaW5lIH0gZnJvbSAnLi4vc3RhdGUtbWFjaGluZS9pbmRleCc7XG5pbXBvcnQgeyBGb3JtIH0gZnJvbSAnLi4vZm9ybS9pbmRleCc7XG5pbXBvcnQgeyBWaWV3TW9kZWxDb250ZXh0IH0gZnJvbSAnLi92aWV3X21vZGVsX2NvbnRleHQnO1xuXG5pbXBvcnQgeyBDT01NQU5EX01FVEhPRF9NRVRBLCBDb21tYW5kTWV0aG9kTWV0YWRhdGEsIEtleWJpbmRpbmcgfSBmcm9tICcuL2RlY29yYXRvcnMnO1xuaW1wb3J0IHsgRU1QVFksIGZyb20sIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjb25jYXRNYXAsIGV2ZXJ5LCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7XG4gIEV4cHJlc3Npb25FbmdpbmVJbXBsLCBFeHByZXNzaW9uTWFuYWdlciwgRXhwcmVzc2lvblJlc3VsdCwgRXhwcmVzc2lvblJlc3VsdEZhY3Rvcnlcbn0gZnJvbSAnLi4vZXhwcmVzc2lvbi9pbmRleCc7XG5pbXBvcnQgeyBDb250cm9sc1Byb3h5IH0gZnJvbSAnLi4vY29udHJvbC1wcm94eSc7XG5cbmFic3RyYWN0IGNsYXNzIFZpZXdNb2RlbCB7XG5cbiAgLyoqXG4gICAqIOWRveS7pOWFg+aVsOaNrumbhuWQiFxuICAgKi9cbiAgcHVibGljIG5nQ29tbWFuZHM6IHsgW3Byb3BOYW1lOiBzdHJpbmddOiBDb21tYW5kTWV0aG9kTWV0YWRhdGEgfTtcblxuICAvKipcbiAgICog5omp5bGV5ZG95LukXG4gICAqL1xuICBwdWJsaWMgZXh0ZW5kQ29tbWFuZHM6IE1hcDxzdHJpbmcsIGFueT4gPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xuXG4gIC8qKlxuICAgKiDlkI3np7BcbiAgICovXG4gIHB1YmxpYyBpZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiDms6jlhaXlmahcbiAgICovXG4gIHB1YmxpYyBpbmplY3RvcjogSW5qZWN0b3I7XG5cbiAgLyoqXG4gICAqIOinhuWbvuaooeWei+S4iuS4i+aWh1xuICAgKi9cbiAgcHVibGljIGNvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQ7XG5cbiAgLyoqXG4gICAqIOaVsOaNruS7k+W6k1xuICAgKi9cbiAgcHVibGljIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8RW50aXR5PjtcblxuICAvKipcbiAgICog57uR5a6a6Lev5b6EXG4gICAqL1xuICBwdWJsaWMgYmluZGluZ1BhdGg6IHN0cmluZztcblxuICAvKipcbiAgICog5pWw5o2u54q25oCBXG4gICAqL1xuICBwdWJsaWMgYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhO1xuXG4gIC8qKlxuICAgKiBVSeeKtuaAgVxuICAgKi9cbiAgcHVibGljIHVpU3RhdGU6IFVJU3RhdGU7XG5cbiAgLyoqXG4gICAqIOeKtuaAgeaculxuICAgKi9cbiAgcHVibGljIHN0YXRlTWFjaGluZTogU3RhdGVNYWNoaW5lO1xuXG4gIC8qKlxuICAgKiDooajljZVcbiAgICovXG4gIHB1YmxpYyBmb3JtOiBGb3JtO1xuXG4gIC8qKlxuICAgKiDlkb3ku6TmgLvnur9cbiAgICovXG4gIHB1YmxpYyBjb21tYW5kQnVzOiBDb21tYW5kQnVzO1xuXG4gIC8qKlxuICAgKiDlv6vmjbfplK7mmKDlsIRcbiAgICovXG4gIHB1YmxpYyBrZXliaW5kaW5nTWFwOiBNYXA8c3RyaW5nLCBLZXliaW5kaW5nPjtcblxuICAvKiogXG4gICAqIOaOp+S7tuWunuS+i+S7o+eQhlxuICAgKi9cbiAgcHVibGljIGNvbnRyb2xzUHJveHkgOiBDb250cm9sc1Byb3h5O1xuXG5cbiAgLyoqXG4gICAqIOWAvOWPmOWMluWJjeebkeWQrOWZqFxuICAgKi9cbiAgcHJpdmF0ZSBlbnRpdHlWYWx1ZUNoYW5naW5nTGlzdGVuZXJzOiBNYXA8c3RyaW5nLCBzdHJpbmc+O1xuXG4gIC8qKlxuICAgKiDlgLzlj5jljJblkI7nm5HlkKzlmahcbiAgICovXG4gIHByaXZhdGUgZW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzOiBNYXA8c3RyaW5nLCBzdHJpbmc+O1xuXG5cblxuICBwdWJsaWMgZXhwcmVzc2lvbkVuZ2luZUltcGw6IEV4cHJlc3Npb25FbmdpbmVJbXBsO1xuICBwdWJsaWMgZXhwcmVzc2lvbk1hbmFnZXI6IEV4cHJlc3Npb25NYW5hZ2VyO1xuICBwdWJsaWMgZXhwcmVzc2lvblJlc3VsdDogRXhwcmVzc2lvblJlc3VsdDtcblxuXG4gIC8qKlxuICAgKiDmnoTpgKDlh73mlbBcbiAgICovXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihpbmplY3RvcjogSW5qZWN0b3IsIGlkOiBzdHJpbmcpIHtcbiAgICB0aGlzLmluamVjdG9yID0gaW5qZWN0b3I7XG4gICAgdGhpcy5pZCA9IGlkO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIneWni+WMllxuICAgKi9cbiAgcHVibGljIGluaXQoKSB7XG4gICAgdGhpcy5pbml0UmVwb3NpdG9yeSgpO1xuICAgIHRoaXMuaW5pdENvbnRleHQoKTtcbiAgICB0aGlzLmluaXRCaW5kaW5nRGF0YSgpO1xuICAgIHRoaXMuaW5pdFVJU3RhdGUoKTtcbiAgICB0aGlzLmludGlTdGF0ZU1hY2hpbmUoKTtcbiAgICB0aGlzLmluaXRGb3JtKCk7XG4gICAgdGhpcy5pbml0Q29tbWFuZEJ1cygpO1xuICAgIHRoaXMucmVnaXN0ZXJXaXRoUGFyZW50KCk7XG4gICAgdGhpcy5pbml0TGlzdGVuZXJzKCk7XG4gICAgdGhpcy5jbG9zZU9sZEJlU2Vzc2lvbigpO1xuICAgIHRoaXMuaW5pdEV4cHJlc3Npb24oKTtcbiAgICB0aGlzLmluaXRDb250cm9sc1Byb3h5KCk7XG4gICAgdGhpcy5jb25maWcoKTtcbiAgfVxuICBcbiAgY29uZmlnKCl7XG4gICAgdGhpcy51aVN0YXRlLmNvbmZpZyh0aGlzLmNvbnRleHQpO1xuICB9XG5cbiAgaW5pdENvbnRyb2xzUHJveHkoKXtcbiAgICB0aGlzLmNvbnRyb2xzUHJveHkgPSB0aGlzLmluamVjdG9yLmdldChDb250cm9sc1Byb3h5KTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdFJlcG9zaXRvcnkoKSB7XG4gICAgdGhpcy5yZXBvc2l0b3J5ID0gdGhpcy5pbmplY3Rvci5nZXQoUmVwb3NpdG9yeSk7XG4gIH1cblxuICBwcml2YXRlIGluaXRDb250ZXh0KCkge1xuICAgIHRoaXMuY29udGV4dCA9IHRoaXMuaW5qZWN0b3IuZ2V0PFZpZXdNb2RlbENvbnRleHQ+KFZpZXdNb2RlbENvbnRleHQpO1xuICAgIHRoaXMuY29udGV4dC5pbml0KHRoaXMpO1xuICB9XG5cbiAgcHVibGljIGluaXRFeHByZXNzaW9uKCkge1xuXG4gICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMuY29udGV4dC5hcHBDb250ZXh0O1xuICAgIGNvbnN0IGFsbFZpZXdNb2RlbENvbnRleHRzID0gYXBwQ29udGV4dC52aWV3TW9kZWxDb250ZXh0TWFuYWdlci5nZXRDb250ZXh0cygpO1xuICAgIGNvbnN0IGV4aXN0ZWRWaWV3TW9kZWxDb250ZXh0ID0gYWxsVmlld01vZGVsQ29udGV4dHMuZmluZCgodmlld01vZGVsQ29udGV4dDogYW55KSA9PiB7XG4gICAgICBpZiAodmlld01vZGVsQ29udGV4dC5leHByZXNzaW9uRW5naW5lSW1wbCkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmIChleGlzdGVkVmlld01vZGVsQ29udGV4dCkge1xuICAgICAgdGhpcy5leHByZXNzaW9uRW5naW5lSW1wbCA9IGV4aXN0ZWRWaWV3TW9kZWxDb250ZXh0LmV4cHJlc3Npb25FbmdpbmVJbXBsO1xuICAgICAgdGhpcy5leHByZXNzaW9uTWFuYWdlciA9IGV4aXN0ZWRWaWV3TW9kZWxDb250ZXh0LmV4cHJlc3Npb25NYW5hZ2VyO1xuICAgICAgdGhpcy5leHByZXNzaW9uUmVzdWx0ID0gZXhpc3RlZFZpZXdNb2RlbENvbnRleHQuZXhwcmVzc2lvblJlc3VsdDtcbiAgICAgIHJldHVybjtcbiAgICB9ICBcblxuICAgIHRoaXMuZXhwcmVzc2lvbkVuZ2luZUltcGwgPSB0aGlzLmluamVjdG9yLmdldDxFeHByZXNzaW9uRW5naW5lSW1wbD4oRXhwcmVzc2lvbkVuZ2luZUltcGwsIG51bGwpO1xuICAgIHRoaXMuZXhwcmVzc2lvbk1hbmFnZXIgPSB0aGlzLmluamVjdG9yLmdldDxFeHByZXNzaW9uTWFuYWdlcj4oRXhwcmVzc2lvbk1hbmFnZXIsIG51bGwpO1xuICAgIGNvbnN0IGV4cHJlc3Npb25SZXN1bHRGYWN0b3J5ID0gdGhpcy5pbmplY3Rvci5nZXQ8RXhwcmVzc2lvblJlc3VsdEZhY3Rvcnk+KEV4cHJlc3Npb25SZXN1bHRGYWN0b3J5LCBudWxsKTtcbiAgICB0aGlzLmV4cHJlc3Npb25SZXN1bHQgPSB0aGlzLmluamVjdG9yLmdldDxFeHByZXNzaW9uUmVzdWx0PihFeHByZXNzaW9uUmVzdWx0LCBudWxsKTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdEJpbmRpbmdEYXRhKCkge1xuICAgIHRoaXMuYmluZGluZ0RhdGEgPSB0aGlzLmNvbnRleHQuaW5qZWN0b3IuZ2V0KEJpbmRpbmdEYXRhKTtcbiAgICB0aGlzLmVudGl0eVZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnMgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuICAgIHRoaXMuZW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcbiAgICBpZiAodGhpcy5iaW5kaW5nRGF0YSkge1xuICAgICAgdGhpcy5iaW5kaW5nRGF0YS5zZXRWYWx1ZUNoYW5nZUludm9rZXJGYWN0b3J5KChwYXRoczogc3RyaW5nW10pOiBJbnZva2VPblZhbHVlQ2hhbmdlID0+IHtcbiAgICAgICAgcmV0dXJuIChwcmVWYWx1ZSwgdmFsdWUsIGVudGl0eUNoYW5nZWQ6IGJvb2xlYW4sIHByaW1hcnlWYWx1ZT86IGFueSk6IE9ic2VydmFibGU8Ym9vbGVhbj4gPT4ge1xuICAgICAgICAgIGNvbnN0IHBsYWluUGF0aCA9ICcvJyArIHBhdGhzLmpvaW4oJy8nKTtcbiAgICAgICAgICBsZXQgY29tbWFuZDogc3RyaW5nO1xuICAgICAgICAgIGlmIChlbnRpdHlDaGFuZ2VkID09PSBmYWxzZSkge1xuICAgICAgICAgICAgY29tbWFuZCA9IHRoaXMuZW50aXR5VmFsdWVDaGFuZ2luZ0xpc3RlbmVyc1twbGFpblBhdGhdO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb21tYW5kID0gdGhpcy5lbnRpdHlWYWx1ZUNoYW5nZWRMaXN0ZW5lcnNbcGxhaW5QYXRoXTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoISFjb21tYW5kKSB7XG4gICAgICAgICAgICBjb25zdCBjaGFuZ2U6IEVudGl0eVZhbHVlQ2hhbmdlID0ge1xuICAgICAgICAgICAgICBwYXRoczogcGF0aHMsXG4gICAgICAgICAgICAgIHByZVZhbHVlOiBwcmVWYWx1ZSxcbiAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLFxuICAgICAgICAgICAgICBjaGFuZ2VkOiBlbnRpdHlDaGFuZ2VkXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgY29uc3QgY29tbWFuZHMgPSBjb21tYW5kLnNwbGl0KCc7JykuZmlsdGVyKHAgPT4gcCk7XG4gICAgICAgICAgICBsZXQgdmFsdWVDaGFuZ2VTdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgIHJldHVybiBmcm9tKGNvbW1hbmRzKS5waXBlKFxuICAgICAgICAgICAgICBjb25jYXRNYXAoaXRlbSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCF2YWx1ZUNoYW5nZVN1Y2Nlc3MpIHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBFTVBUWTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbaXRlbV0oY2hhbmdlKS5waXBlKFxuICAgICAgICAgICAgICAgICAgdGFwKChyZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZUNoYW5nZVN1Y2Nlc3MgPSByZXN1bHQ7XG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICBldmVyeSgocmVzdWx0OiBhbnkpID0+IHJlc3VsdClcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHJlcG9zaXRvcnlOYW1lID0gdGhpcy5yZXBvc2l0b3J5Lm5hbWU7XG4gICAgY29uc3QgYmluZGluZ0RhdGFNYW5hZ2VyID0gdGhpcy5jb250ZXh0LmFwcENvbnRleHQuYmluZGluZ0RhdGFNYW5hZ2VyO1xuICAgIGNvbnN0IHJlcG9zaXRvcnlCaW5kaW5nRGF0YSA9IGJpbmRpbmdEYXRhTWFuYWdlci5nZXRCaW5kaW5nRGF0YUJ5TmFtZShyZXBvc2l0b3J5TmFtZSk7XG4gICAgdGhpcy5iaW5kaW5nRGF0YS5pbml0QnlCaW5kaW5nTGlzdChyZXBvc2l0b3J5QmluZGluZ0RhdGEubGlzdCwgdGhpcy5jb250ZXh0LCByZXBvc2l0b3J5QmluZGluZ0RhdGEuZGF0YVR5cGVJbmZvKTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdFVJU3RhdGUoKSB7XG4gICAgdGhpcy51aVN0YXRlID0gdGhpcy5pbmplY3Rvci5nZXQoVUlTdGF0ZSk7XG4gIH1cblxuICBwcml2YXRlIGludGlTdGF0ZU1hY2hpbmUoKSB7XG4gICAgdGhpcy5zdGF0ZU1hY2hpbmUgPSB0aGlzLmluamVjdG9yLmdldChTdGF0ZU1hY2hpbmUsIG51bGwpO1xuICAgIGlmICghdGhpcy5zdGF0ZU1hY2hpbmUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5zdGF0ZU1hY2hpbmUuaW5pdCh0aGlzLmNvbnRleHQpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0Rm9ybSgpIHtcbiAgICB0aGlzLmZvcm0gPSB0aGlzLmluamVjdG9yLmdldChGb3JtLCBudWxsKTtcbiAgICB0aGlzLmZvcm0uaW5pdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0Q29tbWFuZEJ1cygpIHtcbiAgICB0aGlzLmNvbW1hbmRCdXMgPSB0aGlzLmluamVjdG9yLmdldChDb21tYW5kQnVzKTtcbiAgICB0aGlzLmV4dGVuZENvbW1hbmRNZXRob2RzKCk7XG4gIH1cblxuICBwcml2YXRlIGV4dGVuZENvbW1hbmRNZXRob2RzKCkge1xuICAgIHRoaXMubmdDb21tYW5kcyA9IE1ldGFkYXRhVXRpbC5nZXRQcm9wc01ldGFkYXRhc0J5TmFtZSh0aGlzLmNvbnN0cnVjdG9yLCBDT01NQU5EX01FVEhPRF9NRVRBKTtcbiAgICB0aGlzLmtleWJpbmRpbmdNYXAgPSBuZXcgTWFwPHN0cmluZywgS2V5YmluZGluZz4oKTtcblxuICAgIE9iamVjdC5rZXlzKHRoaXMubmdDb21tYW5kcykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgbmdDb21tYW5kOiBDb21tYW5kTWV0aG9kTWV0YWRhdGEgPSB0aGlzLm5nQ29tbWFuZHNbcHJvcE5hbWVdO1xuXG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgcHJvcE5hbWUsIHtcbiAgICAgICAgdmFsdWU6IChldmVudFBhcmFtczogYW55KSA9PiB7XG4gICAgICAgICAgY29uc3QgY29tbWFuZDogQ29tbWFuZCA9IHtcbiAgICAgICAgICAgIG5hbWU6IG5nQ29tbWFuZC5uYW1lLFxuICAgICAgICAgICAgcGFyYW1zOiBuZ0NvbW1hbmQucGFyYW1zLFxuICAgICAgICAgICAgcGFyYW1EZXNjcmlwdGlvbnM6IG5nQ29tbWFuZC5wYXJhbURlc2NyaXB0aW9ucyxcbiAgICAgICAgICAgIGV2ZW50UGFyYW06IGV2ZW50UGFyYW1zIHx8IG51bGxcbiAgICAgICAgICB9O1xuICAgICAgICAgIHJldHVybiB0aGlzLmNvbW1hbmRCdXMuZGlzcGF0Y2goY29tbWFuZCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICBpZiAobmdDb21tYW5kLmtleUJpbmRpbmcpIHtcbiAgICAgICAgdGhpcy5rZXliaW5kaW5nTWFwLnNldChwcm9wTmFtZSwgbmdDb21tYW5kLmtleUJpbmRpbmcpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIOazqOWGjOaJqeWxleWRveS7pOaWueazlVxuICAgKi9cbiAgcHVibGljIHJlZ2lzdGVyRXh0ZW5kQ29tbWFuZChjb21tYW5kTmFtZTogc3RyaW5nLCBjb21tYW5kSGFuZGxlcjogYW55KSB7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIGNvbW1hbmROYW1lLCB7XG4gICAgICB2YWx1ZTogKGV2ZW50UGFyYW1zOiBhbnkpID0+IHtcbiAgICAgICAgcmV0dXJuIGNvbW1hbmRIYW5kbGVyKGV2ZW50UGFyYW1zLCB0aGlzLmNvbnRleHQpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMuZXh0ZW5kQ29tbWFuZHMuc2V0KGNvbW1hbmROYW1lLCBjb21tYW5kSGFuZGxlcik7XG4gIH1cblxuICBwcml2YXRlIHJlZ2lzdGVyV2l0aFBhcmVudCgpIHtcbiAgICBjb25zdCBwYXJlbnRDb250ZXh0ID0gdGhpcy5jb250ZXh0LnBhcmVudDtcbiAgICBpZiAoIXBhcmVudENvbnRleHQgfHwgIXBhcmVudENvbnRleHQudmlld01vZGVsIHx8ICFwYXJlbnRDb250ZXh0LnZpZXdNb2RlbFsnY2hpbGRWaWV3TW9kZWxzJ10pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBwYXJlbnRWaWV3TW9kZWwgPSBwYXJlbnRDb250ZXh0LnZpZXdNb2RlbDtcbiAgICBjb25zdCBjbGFzc05hbWUgPSB0aGlzLmNvbnN0cnVjdG9yLm5hbWU7XG4gICAgY29uc3QgcHJvcE5hbWUgPSBwYXJlbnRWaWV3TW9kZWxbJ2NoaWxkVmlld01vZGVscyddW2NsYXNzTmFtZV07XG4gICAgcGFyZW50Vmlld01vZGVsW3Byb3BOYW1lXSA9IHRoaXM7XG4gIH1cblxuICAvKipcbiAgICog5YWz6Zet6ICB55qEQmVTZXNzaW9uXG4gICAqL1xuICBwcml2YXRlIGNsb3NlT2xkQmVTZXNzaW9uKCkge1xuICAgIGNvbnN0IGFsbFZpZXdNb2RlbENvbnRleHRzID0gdGhpcy5jb250ZXh0LmFwcENvbnRleHQudmlld01vZGVsQ29udGV4dE1hbmFnZXIuZ2V0Q29udGV4dHMoKTtcbiAgICBpZiAoYWxsVmlld01vZGVsQ29udGV4dHMubGVuZ3RoID09PSAxICYmIGFsbFZpZXdNb2RlbENvbnRleHRzWzBdID09PSB0aGlzLmNvbnRleHQpIHtcbiAgICAgIHRoaXMuY29udGV4dC5yZXBvc2l0b3J5LnJlc2V0KCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gKiDku45Gb3Jt6I635Y+W55uR5ZCs5ZmoXG4gKi9cbiAgcHJpdmF0ZSBpbml0TGlzdGVuZXJzKCkge1xuICAgIGNvbnN0IGV4dHJhY3RQYXRoID0gKGJpbmRpbmdCYXNlUGF0aDogc3RyaW5nLCBiaW5kaW5nUGF0aDogc3RyaW5nKTogc3RyaW5nID0+IHtcbiAgICAgIHJldHVybiAnLycgKyBiaW5kaW5nQmFzZVBhdGguc3BsaXQoJy8nKS5jb25jYXQoYmluZGluZ1BhdGguc3BsaXQoJy4nKSkuZmlsdGVyKChpdGVtKSA9PiBpdGVtLmxlbmd0aCA+IDApLmpvaW4oJy8nKTtcbiAgICB9O1xuXG4gICAgaWYgKHRoaXMuZm9ybSkge1xuICAgICAgY29uc3QgdmFsdWVDaGFuZ2luZ0xpc3RlbmVycyA9IHRoaXMuZm9ybS5nZXRFbnRpdHlWYWx1ZUNoYW5naW5nTGlzdGVuZXJzKCk7XG4gICAgICBPYmplY3Qua2V5cyh2YWx1ZUNoYW5naW5nTGlzdGVuZXJzKS5mb3JFYWNoKChiaW5kaW5nUGF0aCkgPT4ge1xuICAgICAgICBjb25zdCBwbGFpblBhdGggPSBleHRyYWN0UGF0aCh0aGlzLmJpbmRpbmdQYXRoLCBiaW5kaW5nUGF0aCk7XG4gICAgICAgIHRoaXMuZW50aXR5VmFsdWVDaGFuZ2luZ0xpc3RlbmVyc1twbGFpblBhdGhdID0gdmFsdWVDaGFuZ2luZ0xpc3RlbmVyc1tiaW5kaW5nUGF0aF07XG4gICAgICB9KTtcblxuICAgICAgY29uc3QgdmFsdWVDaGFuZ2VkTGlzdGVuZXJzID0gdGhpcy5mb3JtLmdldEVudGl0eVZhbHVlQ2hhbmdlZExpc3RlbmVycygpO1xuICAgICAgT2JqZWN0LmtleXModmFsdWVDaGFuZ2VkTGlzdGVuZXJzKS5mb3JFYWNoKChiaW5kaW5nUGF0aCkgPT4ge1xuICAgICAgICBjb25zdCBwbGFpblBhdGggPSBleHRyYWN0UGF0aCh0aGlzLmJpbmRpbmdQYXRoLCBiaW5kaW5nUGF0aCk7XG4gICAgICAgIHRoaXMuZW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzW3BsYWluUGF0aF0gPSB2YWx1ZUNoYW5nZWRMaXN0ZW5lcnNbYmluZGluZ1BhdGhdO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbn1cblxuZXhwb3J0IHsgVmlld01vZGVsIH07XG4iXX0=