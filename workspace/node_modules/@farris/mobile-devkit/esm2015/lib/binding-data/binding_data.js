// tslint:disable: max-line-length member-ordering
/**
 * 绑定数据相关定义
 * @author Witt<jiwt@inspur.com>
 * @todo
 * 1、全局的BindingData和局部的BindingData应该拆成两个类，两个类之间是装饰关系；；
 * 2、为了保持兼容，减少改动量，暂时放在一起，待进一步重构。
 */
import { ChangeType } from './changes';
import { BindingList } from './binding_list';
import { BindingListFactory } from './binding_list_factory';
import { PropertyUtil } from './property_util';
import { EntityUtil } from './entity_util';
/**
 * BindingData
 */
class BindingData {
    constructor() {
        this.paginationInfo = null;
    }
    /**
     * 绑定该路径
     */
    get bindingPath() {
        if (this.viewModelContext && this.viewModelContext.viewModel.bindingPath) {
            return this.viewModelContext.viewModel.bindingPath;
        }
        return '/';
    }
    set pagingInfo(pagingInfo) {
        this.paginationInfo = pagingInfo;
        this.firePagingChangeEvent();
    }
    get pagingInfo() {
        return this.paginationInfo;
    }
    /**
     * 设置分页信息
     * @param skip 跳过
     * @param take 获取
     * @param bindingPath 路径
     */
    setPagingInfo(skip, take, bindingPath) {
        if (bindingPath.length < 1 || bindingPath === '/') {
            this.paginationInfo = Object.assign(this.paginationInfo, { pageSize: take, pageIndex: skip / take + 1 });
        }
        else {
            let pagingInfo = this.paginationInfo || {};
            const bindingPaths = bindingPath.substr(1).split('/').filter(item => !!item && item.length > 0).map(item => item.substring(0, item.length - 1));
            bindingPaths.forEach(path => {
                if (!pagingInfo.hasOwnProperty(path)) {
                    pagingInfo[path] = {};
                }
                pagingInfo = pagingInfo[path];
            });
            pagingInfo.pageIndex = ((skip / take) || 0) + 1;
            pagingInfo.pageSize = take || 0;
        }
        this.firePagingChangeEvent();
    }
    firePagingChangeEvent() {
        this.list.changes.next({
            type: ChangeType.PaginationInfoChange,
            path: [],
            value: this.paginationInfo
        });
    }
    /**
     * 变更集
     */
    get changes() {
        return this.list.changes;
    }
    /**
     * 设置值变化执行器工厂
     * @param value 值变化执行器工厂
     */
    setValueChangeInvokerFactory(value) {
        this.valueChangeInvokerFactory = value;
    }
    /**
     * 初始化（已废弃）
     */
    init(repository, bindingPath) {
        this.initByRepository(repository, null);
    }
    /**
     * 根据Repository对BindingData进行初始化
     */
    initByRepository(repository, viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.properties = PropertyUtil.getProperties(repository.entityType);
        this.list = BindingListFactory.create(this.properties);
        // 从repository初始化bindingData
        this.pagingInfo = repository.entityCollection.paginationInfo;
        // @todo
        // BindingData不应该知道Repository，加载数据、建立关联关系的过程应该转移到外边
        EntityUtil.loadRepository(repository, this.list);
        this.dataTypeInfo = repository.entityTypeInfo;
        this.extendProperties(this.properties);
    }
    /**
     * 初始化
     */
    initByBindingList(bindingList, viewModelContext, dataTypeInfo) {
        this.list = bindingList;
        this.viewModelContext = viewModelContext;
        this.dataTypeInfo = dataTypeInfo;
        this.extendProperties(this.list.properties);
    }
    /**
     * 获取paths对应的属性值
     * @param  paths 属性路径数组
     * @returns 属性值
     */
    getValue(paths) {
        let target = this.list;
        paths.forEach((path) => {
            if (target) {
                target = target[path];
            }
        });
        return target;
    }
    /**
     * 根据paths设置属性值
     * @param paths 属性路径数组
     * @param value 属性值
     * @param emitEventToView 如果设置为true，则发送事件通知订阅它的组件、指令去更新界面，默认为false。
     * @param emitEventToEntity 如果设置为true，则同步去更新Entity上对应的字段，默认为true。
     */
    setValue(paths, value, emitEventToView = false, emitEventToEntity = true) {
        if (!paths || paths.length === 0) {
            throw Error('路径不能为空');
        }
        const parentPaths = paths.slice(0, paths.length - 1);
        const propName = paths[paths.length - 1];
        let parent = this.getValue(parentPaths);
        if (!parent) {
            throw Error('找不到要设置的对象');
        }
        if (parent instanceof BindingData) {
            parent = parent.list.currentItem;
        }
        else if (parent instanceof BindingList) {
            parent = parent.currentItem;
        }
        if (!!this.valueChangeInvokerFactory) {
            parent.setValue(propName, value, emitEventToView, emitEventToEntity, null, this.valueChangeInvokerFactory(paths));
        }
        else {
            parent.setValue(propName, value, emitEventToView, emitEventToEntity);
        }
    }
    /**
     * 根据paths清空属性值
     */
    clearValue(paths, emitEventToView = false, emitEventToEntity = true) {
        let initValue;
        const propInfo = this.dataTypeInfo.getPropInfoByPath(paths);
        if (propInfo && propInfo.metadataInfo && propInfo.metadataInfo.initValue !== undefined) {
            initValue = propInfo.metadataInfo.initValue;
        }
        else {
            // 原来的帮助映射中，强行纠正了数值的情况，保持一致
            const oldValue = this.getValue(paths);
            if (typeof oldValue === 'number') {
                initValue = 0;
            }
            else {
                initValue = '';
            }
        }
        this.setValue(paths, initValue, emitEventToView, emitEventToEntity);
    }
    /**
     * 获取当前列表
     */
    getList() {
        if (!this.bindingPath || this.bindingPath === '/') {
            return this.list;
        }
        const bindingPath = this.bindingPath.substr(1);
        const bindingPathArray = bindingPath.split('/').filter((part) => {
            return part !== '';
        });
        return this.getValue(bindingPathArray);
    }
    /**
     * 获取当前对象
     */
    getObject() {
        const bindingList = this.getList();
        return bindingList.currentItem;
    }
    /**
     * 绑定路径（仅路径部分，不包括属性）
     * @param bindingPath 绑定路径
     */
    getPath(bindingPath) {
        const bindingPaths = bindingPath.filter(p => p);
        const path = [`${this.list.primaryKey}:${this.list.currentId}`];
        bindingPaths.forEach((item) => {
            path.push(item);
            const list = this[item];
            if (list) {
                path.push(`${list.primaryKey}:${list.currentId}`);
            }
        });
        return path;
    }
    /**
     * 通过绑定路径获取属性初始值
     * @param paths 绑定路径
     */
    getInitValueByPaths(paths) {
        let initValue;
        const propInfo = this.dataTypeInfo && this.dataTypeInfo.getPropInfoByPath(paths) || null;
        if (propInfo && propInfo.metadataInfo && propInfo.metadataInfo.initValue !== undefined) {
            initValue = propInfo.metadataInfo.initValue;
        }
        return initValue;
    }
    /**
     * 扩展BindingData属性，映射BindingData所持有的绑定列表当前行的属性，减少绑定层级。
     * @param properties 关联实体的属性集合
     */
    extendProperties(properties) {
        properties.forEach((property) => {
            const propName = property.name;
            Object.defineProperty(this, propName, {
                get: () => {
                    return this.list.currentItem[propName];
                },
                set: (value) => {
                    this.list.currentItem[propName] = value;
                }
            });
        });
    }
}
export { BindingData };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19kYXRhLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2JpbmRpbmctZGF0YS9iaW5kaW5nX2RhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsa0RBQWtEO0FBQ2xEOzs7Ozs7R0FNRztBQU9ILE9BQU8sRUFBVSxVQUFVLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFL0MsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzNDOztHQUVHO0FBRUgsTUFBTSxXQUFXO0lBQWpCO1FBNEJVLG1CQUFjLEdBQUcsSUFBSSxDQUFDO0lBd09oQyxDQUFDO0lBM1BDOztPQUVHO0lBQ0gsSUFBVyxXQUFXO1FBQ3BCLElBQUksSUFBSSxDQUFDLGdCQUFnQixJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFO1lBQ3hFLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUM7U0FDcEQ7UUFDRCxPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7SUFhRCxJQUFXLFVBQVUsQ0FBQyxVQUFlO1FBQ25DLElBQUksQ0FBQyxjQUFjLEdBQUcsVUFBVSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO0lBQy9CLENBQUM7SUFFRCxJQUFXLFVBQVU7UUFDbkIsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDO0lBQzdCLENBQUM7SUFDRDs7Ozs7T0FLRztJQUNJLGFBQWEsQ0FBQyxJQUFZLEVBQUUsSUFBWSxFQUFFLFdBQW1CO1FBQ2xFLElBQUksV0FBVyxDQUFDLE1BQU0sR0FB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LENBQUM7YUFDRixDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRjtBQUVELE9BQU8sRUFBRSxXQUFXLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlOiBtYXgtbGluZS1sZW5ndGggbWVtYmVyLW9yZGVyaW5nXG4vKipcbiAqIOe7keWumuaVsOaNruebuOWFs+WumuS5iVxuICogQGF1dGhvciBXaXR0PGppd3RAaW5zcHVyLmNvbT5cbiAqIEB0b2RvXG4gKiAx44CB5YWo5bGA55qEQmluZGluZ0RhdGHlkozlsYDpg6jnmoRCaW5kaW5nRGF0YeW6lOivpeaLhuaIkOS4pOS4quexu++8jOS4pOS4quexu+S5i+mXtOaYr+ijhemlsOWFs+ezu++8m++8m1xuICogMuOAgeS4uuS6huS/neaMgeWFvOWuue+8jOWHj+WwkeaUueWKqOmHj++8jOaaguaXtuaUvuWcqOS4gOi1t++8jOW+hei/m+S4gOatpemHjeaehOOAglxuICovXG5cbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgRGF0YVR5cGVJbmZvIH0gZnJvbSAnLi4vZW50aXR5L2VudGl0eS10eXBlLWluZm8vaW5kZXgnO1xuaW1wb3J0IHsgUmVwb3NpdG9yeSB9IGZyb20gJy4uL3JlcG9zaXRvcnkvaW5kZXgnO1xuaW1wb3J0IHsgVmlld01vZGVsQ29udGV4dCB9IGZyb20gJy4uL3ZpZXctbW9kZWwvaW5kZXgnO1xuaW1wb3J0IHsgQ2hhbmdlLCBDaGFuZ2VUeXBlIH0gZnJvbSAnLi9jaGFuZ2VzJztcbmltcG9ydCB7IEJpbmRpbmdQcm9wZXJ0eSB9IGZyb20gJy4vYmluZGluZ19wcm9wZXJ0eSc7XG5pbXBvcnQgeyBCaW5kaW5nTGlzdCB9IGZyb20gJy4vYmluZGluZ19saXN0JztcbmltcG9ydCB7IEJpbmRpbmdMaXN0RmFjdG9yeSB9IGZyb20gJy4vYmluZGluZ19saXN0X2ZhY3RvcnknO1xuaW1wb3J0IHsgUHJvcGVydHlVdGlsIH0gZnJvbSAnLi9wcm9wZXJ0eV91dGlsJztcbmltcG9ydCB7IEVudGl0eVV0aWwgfSBmcm9tICcuL2VudGl0eV91dGlsJztcbmltcG9ydCB7IEludm9rZU9uVmFsdWVDaGFuZ2UgfSBmcm9tICcuL2JpbmRpbmdfb2JqZWN0JztcblxuLyoqXG4gKiBCaW5kaW5nRGF0YVxuICovXG5cbmNsYXNzIEJpbmRpbmdEYXRhIHtcblxuICBwcml2YXRlIHZpZXdNb2RlbENvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQ7XG5cbiAgLyoqXG4gICAqIOaVsOaNruexu+Wei+aPj+i/sFxuICAgKi9cbiAgcHVibGljIGRhdGFUeXBlSW5mbzogRGF0YVR5cGVJbmZvO1xuXG4gIC8qKlxuICAgKiDnu5Hlrpror6Xot6/lvoRcbiAgICovXG4gIHB1YmxpYyBnZXQgYmluZGluZ1BhdGgoKTogc3RyaW5nIHtcbiAgICBpZiAodGhpcy52aWV3TW9kZWxDb250ZXh0ICYmIHRoaXMudmlld01vZGVsQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGgpIHtcbiAgICAgIHJldHVybiB0aGlzLnZpZXdNb2RlbENvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoO1xuICAgIH1cbiAgICByZXR1cm4gJy8nO1xuICB9XG5cbiAgLyoqXG4gICAqIOWPr+e7keWumueahOWxnuaAp+aPj+i/sFxuICAgKi9cbiAgcHVibGljIHByb3BlcnRpZXM6IEJpbmRpbmdQcm9wZXJ0eVtdO1xuXG4gIC8qKlxuICAgKiDmlbDmja7liJfooahcbiAgICovXG4gIHB1YmxpYyBsaXN0OiBCaW5kaW5nTGlzdDtcbiAgcHJpdmF0ZSBwYWdpbmF0aW9uSW5mbyA9IG51bGw7XG5cbiAgcHVibGljIHNldCBwYWdpbmdJbmZvKHBhZ2luZ0luZm86IGFueSkge1xuICAgIHRoaXMucGFnaW5hdGlvbkluZm8gPSBwYWdpbmdJbmZvO1xuICAgIHRoaXMuZmlyZVBhZ2luZ0NoYW5nZUV2ZW50KCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHBhZ2luZ0luZm8oKSB7XG4gICAgcmV0dXJuIHRoaXMucGFnaW5hdGlvbkluZm87XG4gIH1cbiAgLyoqXG4gICAqIOiuvue9ruWIhumhteS/oeaBr1xuICAgKiBAcGFyYW0gc2tpcCDot7Pov4dcbiAgICogQHBhcmFtIHRha2Ug6I635Y+WXG4gICAqIEBwYXJhbSBiaW5kaW5nUGF0aCDot6/lvoRcbiAgICovXG4gIHB1YmxpYyBzZXRQYWdpbmdJbmZvKHNraXA6IG51bWJlciwgdGFrZTogbnVtYmVyLCBiaW5kaW5nUGF0aDogc3RyaW5nKSB7XG4gICAgaWYgKGJpbmRpbmdQYXRoLmxlbmd0aCA8IDEgfHwgYmluZGluZ1BhdGggPT09ICcvJykge1xuICAgICAgdGhpcy5wYWdpbmF0aW9uSW5mbyA9IE9iamVjdC5hc3NpZ24odGhpcy5wYWdpbmF0aW9uSW5mbywgeyBwYWdlU2l6ZTogdGFrZSwgcGFnZUluZGV4OiBza2lwIC8gdGFrZSArIDEgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBwYWdpbmdJbmZvID0gdGhpcy5wYWdpbmF0aW9uSW5mbyB8fCB7fTtcbiAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnN1YnN0cigxKS5zcGxpdCgnLycpLmZpbHRlcihpdGVtID0+ICEhaXRlbSAmJiBpdGVtLmxlbmd0aCA+IDApLm1hcChpdGVtID0+IGl0ZW0uc3Vic3RyaW5nKDAsIGl0ZW0ubGVuZ3RoIC0gMSkpO1xuICAgICAgYmluZGluZ1BhdGhzLmZvckVhY2gocGF0aCA9PiB7XG4gICAgICAgIGlmICghcGFnaW5nSW5mby5oYXNPd25Qcm9wZXJ0eShwYXRoKSkge1xuICAgICAgICAgIHBhZ2luZ0luZm9bcGF0aF0gPSB7fTtcbiAgICAgICAgfVxuICAgICAgICBwYWdpbmdJbmZvID0gcGFnaW5nSW5mb1twYXRoXTtcbiAgICAgIH0pO1xuICAgICAgcGFnaW5nSW5mby5wYWdlSW5kZXggPSAoKHNraXAgLyB0YWtlKSB8fCAwKSArIDE7XG4gICAgICBwYWdpbmdJbmZvLnBhZ2VTaXplID0gdGFrZSB8fCAwO1xuICAgIH1cbiAgICB0aGlzLmZpcmVQYWdpbmdDaGFuZ2VFdmVudCgpO1xuICB9XG4gIHByaXZhdGUgZmlyZVBhZ2luZ0NoYW5nZUV2ZW50KCkge1xuICAgIHRoaXMubGlzdC5jaGFuZ2VzLm5leHQoe1xuICAgICAgdHlwZTogQ2hhbmdlVHlwZS5QYWdpbmF0aW9uSW5mb0NoYW5nZSxcbiAgICAgIHBhdGg6IFtdLFxuICAgICAgdmFsdWU6IHRoaXMucGFnaW5hdGlvbkluZm9cbiAgICB9KTtcbiAgfVxuICAvKipcbiAgICog5Y+Y5pu06ZuGXG4gICAqL1xuICBwdWJsaWMgZ2V0IGNoYW5nZXMoKTogU3ViamVjdDxDaGFuZ2U+IHtcbiAgICByZXR1cm4gdGhpcy5saXN0LmNoYW5nZXM7XG4gIH1cblxuICAvKipcbiAgICog5YC85Y+Y5YyW5omn6KGM5Zmo5bel5Y6C77yM5qC55o2u6Lev5b6E5Lqn55Sf5omn6KGM5ZmoXG4gICAqL1xuICBwcml2YXRlIHZhbHVlQ2hhbmdlSW52b2tlckZhY3Rvcnk6IChwYXRoczogc3RyaW5nW10pID0+IEludm9rZU9uVmFsdWVDaGFuZ2U7XG5cbiAgLyoqXG4gICAqIOiuvue9ruWAvOWPmOWMluaJp+ihjOWZqOW3peWOglxuICAgKiBAcGFyYW0gdmFsdWUg5YC85Y+Y5YyW5omn6KGM5Zmo5bel5Y6CXG4gICAqL1xuICBwdWJsaWMgc2V0VmFsdWVDaGFuZ2VJbnZva2VyRmFjdG9yeSh2YWx1ZTogKHBhdGhzOiBzdHJpbmdbXSkgPT4gSW52b2tlT25WYWx1ZUNoYW5nZSkge1xuICAgIHRoaXMudmFsdWVDaGFuZ2VJbnZva2VyRmFjdG9yeSA9IHZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIneWni+WMlu+8iOW3suW6n+W8g++8iVxuICAgKi9cbiAgcHVibGljIGluaXQocmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+LCBiaW5kaW5nUGF0aDogc3RyaW5nKSB7XG4gICAgdGhpcy5pbml0QnlSZXBvc2l0b3J5KHJlcG9zaXRvcnksIG51bGwpO1xuICB9XG5cbiAgLyoqXG4gICAqIOagueaNrlJlcG9zaXRvcnnlr7lCaW5kaW5nRGF0Yei/m+ihjOWIneWni+WMllxuICAgKi9cbiAgcHVibGljIGluaXRCeVJlcG9zaXRvcnkocmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+LCB2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0KSB7XG4gICAgdGhpcy52aWV3TW9kZWxDb250ZXh0ID0gdmlld01vZGVsQ29udGV4dDtcblxuICAgIHRoaXMucHJvcGVydGllcyA9IFByb3BlcnR5VXRpbC5nZXRQcm9wZXJ0aWVzKHJlcG9zaXRvcnkuZW50aXR5VHlwZSk7XG4gICAgdGhpcy5saXN0ID0gQmluZGluZ0xpc3RGYWN0b3J5LmNyZWF0ZSh0aGlzLnByb3BlcnRpZXMpO1xuICAgIC8vIOS7jnJlcG9zaXRvcnnliJ3lp4vljJZiaW5kaW5nRGF0YVxuICAgIHRoaXMucGFnaW5nSW5mbyA9IHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5wYWdpbmF0aW9uSW5mbztcblxuICAgIC8vIEB0b2RvXG4gICAgLy8gQmluZGluZ0RhdGHkuI3lupTor6Xnn6XpgZNSZXBvc2l0b3J577yM5Yqg6L295pWw5o2u44CB5bu656uL5YWz6IGU5YWz57O755qE6L+H56iL5bqU6K+l6L2s56e75Yiw5aSW6L65XG4gICAgRW50aXR5VXRpbC5sb2FkUmVwb3NpdG9yeShyZXBvc2l0b3J5LCB0aGlzLmxpc3QpO1xuICAgIHRoaXMuZGF0YVR5cGVJbmZvID0gcmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbztcblxuICAgIHRoaXMuZXh0ZW5kUHJvcGVydGllcyh0aGlzLnByb3BlcnRpZXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIneWni+WMllxuICAgKi9cbiAgcHVibGljIGluaXRCeUJpbmRpbmdMaXN0KGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCwgIHZpZXdNb2RlbENvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQsIGRhdGFUeXBlSW5mbzogRGF0YVR5cGVJbmZvKSB7XG4gICAgdGhpcy5saXN0ID0gYmluZGluZ0xpc3Q7XG4gICAgdGhpcy52aWV3TW9kZWxDb250ZXh0ID0gdmlld01vZGVsQ29udGV4dDtcbiAgICB0aGlzLmRhdGFUeXBlSW5mbyA9IGRhdGFUeXBlSW5mbztcbiAgICB0aGlzLmV4dGVuZFByb3BlcnRpZXModGhpcy5saXN0LnByb3BlcnRpZXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIOiOt+WPlnBhdGhz5a+55bqU55qE5bGe5oCn5YC8XG4gICAqIEBwYXJhbSAgcGF0aHMg5bGe5oCn6Lev5b6E5pWw57uEXG4gICAqIEByZXR1cm5zIOWxnuaAp+WAvFxuICAgKi9cbiAgcHVibGljIGdldFZhbHVlKHBhdGhzOiBzdHJpbmdbXSkge1xuICAgIGxldCB0YXJnZXQ6IGFueSA9IHRoaXMubGlzdDtcbiAgICBwYXRocy5mb3JFYWNoKChwYXRoOiBzdHJpbmcpID0+IHtcbiAgICAgIGlmICh0YXJnZXQpIHtcbiAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0W3BhdGhdO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiB0YXJnZXQ7XG4gIH1cblxuICAvKipcbiAgICog5qC55o2ucGF0aHPorr7nva7lsZ7mgKflgLxcbiAgICogQHBhcmFtIHBhdGhzIOWxnuaAp+i3r+W+hOaVsOe7hFxuICAgKiBAcGFyYW0gdmFsdWUg5bGe5oCn5YC8XG4gICAqIEBwYXJhbSBlbWl0RXZlbnRUb1ZpZXcg5aaC5p6c6K6+572u5Li6dHJ1Ze+8jOWImeWPkemAgeS6i+S7tumAmuefpeiuoumYheWug+eahOe7hOS7tuOAgeaMh+S7pOWOu+abtOaWsOeVjOmdou+8jOm7mOiupOS4umZhbHNl44CCXG4gICAqIEBwYXJhbSBlbWl0RXZlbnRUb0VudGl0eSDlpoLmnpzorr7nva7kuLp0cnVl77yM5YiZ5ZCM5q2l5Y675pu05pawRW50aXR55LiK5a+55bqU55qE5a2X5q6177yM6buY6K6k5Li6dHJ1ZeOAglxuICAgKi9cbiAgcHVibGljIHNldFZhbHVlKHBhdGhzOiBzdHJpbmdbXSwgdmFsdWU6IGFueSwgZW1pdEV2ZW50VG9WaWV3OiBib29sZWFuID0gZmFsc2UsIGVtaXRFdmVudFRvRW50aXR5OiBib29sZWFuID0gdHJ1ZSkge1xuXG4gICAgaWYgKCFwYXRocyB8fCBwYXRocy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IEVycm9yKCfot6/lvoTkuI3og73kuLrnqbonKTtcbiAgICB9XG4gICAgY29uc3QgcGFyZW50UGF0aHMgPSBwYXRocy5zbGljZSgwLCBwYXRocy5sZW5ndGggLSAxKTtcbiAgICBjb25zdCBwcm9wTmFtZSA9IHBhdGhzW3BhdGhzLmxlbmd0aCAtIDFdO1xuXG4gICAgbGV0IHBhcmVudCA9IHRoaXMuZ2V0VmFsdWUocGFyZW50UGF0aHMpO1xuICAgIGlmICghcGFyZW50KSB7XG4gICAgICB0aHJvdyBFcnJvcign5om+5LiN5Yiw6KaB6K6+572u55qE5a+56LGhJyk7XG4gICAgfVxuICAgIGlmIChwYXJlbnQgaW5zdGFuY2VvZiBCaW5kaW5nRGF0YSkge1xuICAgICAgcGFyZW50ID0gcGFyZW50Lmxpc3QuY3VycmVudEl0ZW07XG4gICAgfSBlbHNlIGlmIChwYXJlbnQgaW5zdGFuY2VvZiBCaW5kaW5nTGlzdCkge1xuICAgICAgcGFyZW50ID0gcGFyZW50LmN1cnJlbnRJdGVtO1xuICAgIH1cbiAgICBpZiAoISF0aGlzLnZhbHVlQ2hhbmdlSW52b2tlckZhY3RvcnkpIHtcbiAgICAgIHBhcmVudC5zZXRWYWx1ZShwcm9wTmFtZSwgdmFsdWUsIGVtaXRFdmVudFRvVmlldywgZW1pdEV2ZW50VG9FbnRpdHksIG51bGwsIHRoaXMudmFsdWVDaGFuZ2VJbnZva2VyRmFjdG9yeShwYXRocykpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXJlbnQuc2V0VmFsdWUocHJvcE5hbWUsIHZhbHVlLCBlbWl0RXZlbnRUb1ZpZXcsIGVtaXRFdmVudFRvRW50aXR5KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog5qC55o2ucGF0aHPmuIXnqbrlsZ7mgKflgLxcbiAgICovXG4gIHB1YmxpYyBjbGVhclZhbHVlKHBhdGhzOiBzdHJpbmdbXSwgZW1pdEV2ZW50VG9WaWV3OiBib29sZWFuID0gZmFsc2UsIGVtaXRFdmVudFRvRW50aXR5OiBib29sZWFuID0gdHJ1ZSkge1xuICAgIGxldCBpbml0VmFsdWU6IGFueTtcbiAgICBjb25zdCBwcm9wSW5mbyA9IHRoaXMuZGF0YVR5cGVJbmZvLmdldFByb3BJbmZvQnlQYXRoKHBhdGhzKTtcbiAgICBpZiAocHJvcEluZm8gJiYgcHJvcEluZm8ubWV0YWRhdGFJbmZvICYmIHByb3BJbmZvLm1ldGFkYXRhSW5mby5pbml0VmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgaW5pdFZhbHVlID0gcHJvcEluZm8ubWV0YWRhdGFJbmZvLmluaXRWYWx1ZTtcbiAgICB9IGVsc2Uge1xuXG4gICAgICAvLyDljp/mnaXnmoTluK7liqnmmKDlsITkuK3vvIzlvLrooYznuqDmraPkuobmlbDlgLznmoTmg4XlhrXvvIzkv53mjIHkuIDoh7RcbiAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpcy5nZXRWYWx1ZShwYXRocyk7XG4gICAgICBpZiAodHlwZW9mIG9sZFZhbHVlID09PSAnbnVtYmVyJykge1xuICAgICAgICBpbml0VmFsdWUgPSAwO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaW5pdFZhbHVlID0gJyc7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuc2V0VmFsdWUocGF0aHMsIGluaXRWYWx1ZSwgZW1pdEV2ZW50VG9WaWV3LCBlbWl0RXZlbnRUb0VudGl0eSk7XG4gIH1cblxuICAvKipcbiAgICog6I635Y+W5b2T5YmN5YiX6KGoXG4gICAqL1xuICBwdWJsaWMgZ2V0TGlzdCgpIHtcblxuICAgIGlmICghdGhpcy5iaW5kaW5nUGF0aCB8fCB0aGlzLmJpbmRpbmdQYXRoID09PSAnLycpIHtcbiAgICAgIHJldHVybiB0aGlzLmxpc3Q7XG4gICAgfVxuXG4gICAgY29uc3QgYmluZGluZ1BhdGggPSB0aGlzLmJpbmRpbmdQYXRoLnN1YnN0cigxKTtcbiAgICBjb25zdCBiaW5kaW5nUGF0aEFycmF5ID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIoKHBhcnQ6IHN0cmluZykgPT4ge1xuICAgICAgcmV0dXJuIHBhcnQgIT09ICcnO1xuICAgIH0pO1xuICAgIHJldHVybiB0aGlzLmdldFZhbHVlKGJpbmRpbmdQYXRoQXJyYXkpO1xuICB9XG5cbiAgLyoqXG4gICAqIOiOt+WPluW9k+WJjeWvueixoVxuICAgKi9cbiAgcHVibGljIGdldE9iamVjdCgpIHtcbiAgICBjb25zdCBiaW5kaW5nTGlzdCA9IHRoaXMuZ2V0TGlzdCgpO1xuICAgIHJldHVybiBiaW5kaW5nTGlzdC5jdXJyZW50SXRlbTtcbiAgfVxuICAvKipcbiAgICog57uR5a6a6Lev5b6E77yI5LuF6Lev5b6E6YOo5YiG77yM5LiN5YyF5ous5bGe5oCn77yJXG4gICAqIEBwYXJhbSBiaW5kaW5nUGF0aCDnu5Hlrprot6/lvoRcbiAgICovXG4gIHB1YmxpYyBnZXRQYXRoKGJpbmRpbmdQYXRoPzogc3RyaW5nW10pIHtcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5maWx0ZXIocCA9PiBwKTtcbiAgICBjb25zdCBwYXRoID0gW2Ake3RoaXMubGlzdC5wcmltYXJ5S2V5fToke3RoaXMubGlzdC5jdXJyZW50SWR9YF07XG5cbiAgICBiaW5kaW5nUGF0aHMuZm9yRWFjaCgoaXRlbTogc3RyaW5nKSA9PiB7XG4gICAgICBwYXRoLnB1c2goaXRlbSk7XG4gICAgICBjb25zdCBsaXN0ID0gdGhpc1tpdGVtXSBhcyBCaW5kaW5nTGlzdDtcbiAgICAgIGlmIChsaXN0KSB7XG4gICAgICAgIHBhdGgucHVzaChgJHtsaXN0LnByaW1hcnlLZXl9OiR7bGlzdC5jdXJyZW50SWR9YCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHBhdGg7XG4gIH1cbiAgLyoqXG4gICAqIOmAmui/h+e7keWumui3r+W+hOiOt+WPluWxnuaAp+WIneWni+WAvFxuICAgKiBAcGFyYW0gcGF0aHMg57uR5a6a6Lev5b6EXG4gICAqL1xuICBwcml2YXRlIGdldEluaXRWYWx1ZUJ5UGF0aHMocGF0aHM6IEFycmF5PHN0cmluZz4pIHtcbiAgICBsZXQgaW5pdFZhbHVlOiBhbnk7XG4gICAgY29uc3QgcHJvcEluZm8gPSB0aGlzLmRhdGFUeXBlSW5mbyAmJiB0aGlzLmRhdGFUeXBlSW5mby5nZXRQcm9wSW5mb0J5UGF0aChwYXRocykgfHwgbnVsbDtcbiAgICBpZiAocHJvcEluZm8gJiYgcHJvcEluZm8ubWV0YWRhdGFJbmZvICYmIHByb3BJbmZvLm1ldGFkYXRhSW5mby5pbml0VmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgaW5pdFZhbHVlID0gcHJvcEluZm8ubWV0YWRhdGFJbmZvLmluaXRWYWx1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGluaXRWYWx1ZTtcbiAgfVxuICAvKipcbiAgICog5omp5bGVQmluZGluZ0RhdGHlsZ7mgKfvvIzmmKDlsIRCaW5kaW5nRGF0YeaJgOaMgeacieeahOe7keWumuWIl+ihqOW9k+WJjeihjOeahOWxnuaAp++8jOWHj+Wwkee7keWumuWxgue6p+OAglxuICAgKiBAcGFyYW0gcHJvcGVydGllcyDlhbPogZTlrp7kvZPnmoTlsZ7mgKfpm4blkIhcbiAgICovXG4gIHByaXZhdGUgZXh0ZW5kUHJvcGVydGllcyhwcm9wZXJ0aWVzOiBCaW5kaW5nUHJvcGVydHlbXSkge1xuICAgIHByb3BlcnRpZXMuZm9yRWFjaCgocHJvcGVydHk6IEJpbmRpbmdQcm9wZXJ0eSkgPT4ge1xuICAgICAgY29uc3QgcHJvcE5hbWUgPSBwcm9wZXJ0eS5uYW1lO1xuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHByb3BOYW1lLCB7XG4gICAgICAgIGdldDogKCkgPT4ge1xuICAgICAgICAgIHJldHVybiB0aGlzLmxpc3QuY3VycmVudEl0ZW1bcHJvcE5hbWVdO1xuICAgICAgICB9LFxuICAgICAgICBzZXQ6ICh2YWx1ZTogYW55KSA9PiB7XG4gICAgICAgICAgdGhpcy5saXN0LmN1cnJlbnRJdGVtW3Byb3BOYW1lXSA9IHZhbHVlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgeyBCaW5kaW5nRGF0YSB9O1xuIl19