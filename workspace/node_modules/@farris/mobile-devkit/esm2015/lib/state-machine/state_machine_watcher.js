/**
 * 状态机事件，监听uistate的变化和entity的变化
 */
export class StateMachineWatcher {
    constructor(stateMachine) {
        this.stateMachine = stateMachine;
        /**
         * 所有UIStatePath数组
         */
        this.uiStatePathList = [];
        /**
         * 所有DataStatePath数组
         */
        this.dataStatePathList = [];
        this.viewModelContextAndUIStatePathsMap = new Map();
        this.viewModelContextAndDataStatePathsMap = new Map();
    }
    /**
     * 初始化
     * @param viewModelContext 当前视图上下文
     */
    init(viewModelContext) {
        this.viewModelContext = viewModelContext;
    }
    /**
     * 返回表达式中ViewModelId对应的ViewModelContext
     */
    getViewModelContext(expression) {
        const viewModelId = this.extractPaths(expression).split('/')[1];
        return this.viewModelContext.appContext.viewModelContextManager.getContextById(viewModelId);
    }
    /**
     * 监听UIState变更
     * @param viewModelContext ViewModel上下文
     * @param expression UIState表达式
     */
    subscribeUIStateChange(viewModelContext, expression) {
        const uiStatePath = this.getStatePath(expression);
        if (this.viewModelContextAndUIStatePathsMap.has(viewModelContext) === false) {
            this.viewModelContextAndUIStatePathsMap.set(viewModelContext, this.uiStatePathList);
            viewModelContext.uiState.changes.subscribe((uiStateChange) => {
                const uiStatePathList = this.viewModelContextAndUIStatePathsMap.get(viewModelContext);
                if (uiStateChange.field && uiStatePathList.indexOf(uiStateChange.field) > -1) {
                    this.stateMachine.render();
                }
            });
        }
        if (this.viewModelContextAndUIStatePathsMap.get(viewModelContext).indexOf(uiStatePath) === -1) {
            this.uiStatePathList.push(uiStatePath);
        }
    }
    /**
     * 监听实体变更
     */
    subscribeEntityChange(viewModelContext, expression) {
        if (this.viewModelContextAndDataStatePathsMap.has(viewModelContext) === false) {
            this.viewModelContextAndDataStatePathsMap.set(viewModelContext, this.dataStatePathList);
            viewModelContext.bindingData.changes.subscribe((change) => {
                if (change.type === 'Load' || change.type === 'SelectionChanged') {
                    this.stateMachine.render();
                }
                const dataPathList = this.viewModelContextAndDataStatePathsMap.get(viewModelContext);
                if (change.path.join() && this.isAccordingPath(dataPathList, change.path.join('/'))) {
                    this.stateMachine.render();
                }
            });
        }
        if (this.viewModelContextAndDataStatePathsMap.get(viewModelContext).indexOf(expression) === -1) {
            this.dataStatePathList.push(expression);
        }
    }
    /**
     * 根据表达式获取对应的StatePath（移除了ViewModelId之外的部分）
     * @param expression 变量表达式
     */
    getStatePath(expression) {
        return this.extractPaths(expression).split('/')[2];
    }
    /**
     * 判断是否监听范围内的变更路径
     */
    isAccordingPath(dataStatePaths, dataStatePath) {
        const targetPath = dataStatePaths.find((item) => {
            return item.indexOf(dataStatePath) > -1;
        });
        return targetPath === undefined ? false : true;
    }
    /**
     * 暂时把这个方法放了这个地方，等季老师共用方法调整后，直接引用他的方法，该方法可删除
     * @param expression 变量表达式
     */
    extractPaths(expression) {
        let path;
        const UI_STATE_PATTERN_G = /\{UISTATE~(\S+?)\}/g;
        const DATA_PATTERN_G = /\{DATA~(\S+?)\}/g;
        const uiStateVariables = expression.match(UI_STATE_PATTERN_G);
        const dataVariables = expression.match(DATA_PATTERN_G);
        if (uiStateVariables !== null) {
            const UI_STATE_PATTERN = /\{UISTATE~(\S+?)\}/;
            uiStateVariables.forEach((uiStateVariable) => {
                const pathMatches = uiStateVariable.match(UI_STATE_PATTERN);
                if (pathMatches != null && pathMatches.length === 2) {
                    path = pathMatches[1];
                }
            });
        }
        if (dataVariables !== null) {
            const DATA_PATTERN = /\{DATA~(\S+?)\}/;
            dataVariables.forEach((dataVariable) => {
                const pathMatches = dataVariable.match(DATA_PATTERN);
                if (pathMatches != null && pathMatches.length === 2) {
                    path = pathMatches[1];
                }
            });
        }
        return path;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVfbWFjaGluZV93YXRjaGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3N0YXRlLW1hY2hpbmUvc3RhdGVfbWFjaGluZV93YXRjaGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUtBOztHQUVHO0FBQ0gsTUFBTSxPQUFPLG1CQUFtQjtJQTJCOUIsWUFBbUIsWUFBMEI7UUFBMUIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFWN0M7O1dBRUc7UUFDSyxvQkFBZSxHQUFrQixFQUFFLENBQUM7UUFFNUM7O1dBRUc7UUFDSyxzQkFBaUIsR0FBa0IsRUFBRSxDQUFDO1FBRzVDLElBQUksQ0FBQyxrQ0FBa0MsR0FBRyxJQUFJLEdBQUcsRUFBeUIsQ0FBQztRQUMzRSxJQUFJLENBQUMsb0NBQW9DLEdBQUcsSUFBSSxHQUFHLEVBQXlCLENBQUM7SUFDL0UsQ0FBQztJQUVEOzs7T0FHRztJQUNJLElBQUksQ0FBQyxnQkFBa0M7UUFDNUMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDO0lBQzNDLENBQUM7SUFFRDs7T0FFRztJQUNJLG1CQUFtQixDQUFDLFVBQWU7UUFDeEMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEUsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLHVCQUF1QixDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUM5RixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNJLHNCQUFzQixDQUFDLGdCQUFrQyxFQUFFLFVBQWU7UUFDL0UsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUVsRCxJQUFJLElBQUksQ0FBQyxrQ0FBa0MsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMs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ZU1hY2hpbmUgfSBmcm9tICcuL3N0YXRlX21hY2hpbmUnO1xuaW1wb3J0IHsgVmlld01vZGVsQ29udGV4dCB9IGZyb20gJy4uL3ZpZXctbW9kZWwvaW5kZXgnO1xuaW1wb3J0IHsgQ2hhbmdlIH0gZnJvbSAnLi4vYmluZGluZy1kYXRhL2NoYW5nZXMnO1xuXG5cbi8qKlxuICog54q25oCB5py65LqL5Lu277yM55uR5ZCsdWlzdGF0ZeeahOWPmOWMluWSjGVudGl0eeeahOWPmOWMllxuICovXG5leHBvcnQgY2xhc3MgU3RhdGVNYWNoaW5lV2F0Y2hlciB7XG5cbiAgLyoqXG4gICAqIOW9k+WJjVZpZXdNb2RlbOS4iuS4i+aWh1xuICAgKi9cbiAgcHJpdmF0ZSB2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0O1xuXG4gIC8qKlxuICAgKiB2aWV3TW9kZWw9PlVJU3RhdGVQYWh0c+Wtl+WFuFxuICAgKi9cbiAgcHJpdmF0ZSB2aWV3TW9kZWxDb250ZXh0QW5kVUlTdGF0ZVBhdGhzTWFwOiBNYXA8Vmlld01vZGVsQ29udGV4dCwgQXJyYXk8c3RyaW5nPj47XG5cbiAgLyoqXG4gICAqIHZpZXdNb2RlbD0+RGF0YVN0YXRlUGFodHPlrZflhbhcbiAgICovXG4gIHByaXZhdGUgdmlld01vZGVsQ29udGV4dEFuZERhdGFTdGF0ZVBhdGhzTWFwOiBNYXA8Vmlld01vZGVsQ29udGV4dCwgQXJyYXk8c3RyaW5nPj47XG5cbiAgLyoqXG4gICAqIOaJgOaciVVJU3RhdGVQYXRo5pWw57uEXG4gICAqL1xuICBwcml2YXRlIHVpU3RhdGVQYXRoTGlzdDogQXJyYXk8c3RyaW5nPiA9IFtdO1xuXG4gIC8qKlxuICAgKiDmiYDmnIlEYXRhU3RhdGVQYXRo5pWw57uEXG4gICAqL1xuICBwcml2YXRlIGRhdGFTdGF0ZVBhdGhMaXN0OiBBcnJheTxzdHJpbmc+ID0gW107XG5cbiAgY29uc3RydWN0b3IocHVibGljIHN0YXRlTWFjaGluZTogU3RhdGVNYWNoaW5lKSB7XG4gICAgdGhpcy52aWV3TW9kZWxDb250ZXh0QW5kVUlTdGF0ZVBhdGhzTWFwID0gbmV3IE1hcDxWaWV3TW9kZWxDb250ZXh0LCBhbnk+KCk7XG4gICAgdGhpcy52aWV3TW9kZWxDb250ZXh0QW5kRGF0YVN0YXRlUGF0aHNNYXAgPSBuZXcgTWFwPFZpZXdNb2RlbENvbnRleHQsIGFueT4oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDliJ3lp4vljJZcbiAgICogQHBhcmFtIHZpZXdNb2RlbENvbnRleHQg5b2T5YmN6KeG5Zu+5LiK5LiL5paHXG4gICAqL1xuICBwdWJsaWMgaW5pdCh2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0KSB7XG4gICAgdGhpcy52aWV3TW9kZWxDb250ZXh0ID0gdmlld01vZGVsQ29udGV4dDtcbiAgfVxuXG4gIC8qKlxuICAgKiDov5Tlm57ooajovr7lvI/kuK1WaWV3TW9kZWxJZOWvueW6lOeahFZpZXdNb2RlbENvbnRleHRcbiAgICovXG4gIHB1YmxpYyBnZXRWaWV3TW9kZWxDb250ZXh0KGV4cHJlc3Npb246IGFueSk6IFZpZXdNb2RlbENvbnRleHQge1xuICAgIGNvbnN0IHZpZXdNb2RlbElkID0gdGhpcy5leHRyYWN0UGF0aHMoZXhwcmVzc2lvbikuc3BsaXQoJy8nKVsxXTtcbiAgICByZXR1cm4gdGhpcy52aWV3TW9kZWxDb250ZXh0LmFwcENvbnRleHQudmlld01vZGVsQ29udGV4dE1hbmFnZXIuZ2V0Q29udGV4dEJ5SWQodmlld01vZGVsSWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIOebkeWQrFVJU3RhdGXlj5jmm7RcbiAgICogQHBhcmFtIHZpZXdNb2RlbENvbnRleHQgVmlld01vZGVs5LiK5LiL5paHXG4gICAqIEBwYXJhbSBleHByZXNzaW9uIFVJU3RhdGXooajovr7lvI9cbiAgICovXG4gIHB1YmxpYyBzdWJzY3JpYmVVSVN0YXRlQ2hhbmdlKHZpZXdNb2RlbENvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQsIGV4cHJlc3Npb246IGFueSkge1xuICAgIGNvbnN0IHVpU3RhdGVQYXRoID0gdGhpcy5nZXRTdGF0ZVBhdGgoZXhwcmVzc2lvbik7XG5cbiAgICBpZiAodGhpcy52aWV3TW9kZWxDb250ZXh0QW5kVUlTdGF0ZVBhdGhzTWFwLmhhcyh2aWV3TW9kZWxDb250ZXh0KSA9PT0gZmFsc2UpIHtcbiAgICAgIHRoaXMudmlld01vZGVsQ29udGV4dEFuZFVJU3RhdGVQYXRoc01hcC5zZXQodmlld01vZGVsQ29udGV4dCwgdGhpcy51aVN0YXRlUGF0aExpc3QpO1xuICAgICAgdmlld01vZGVsQ29udGV4dC51aVN0YXRlLmNoYW5nZXMuc3Vic2NyaWJlKCh1aVN0YXRlQ2hhbmdlKSA9PiB7XG4gICAgICAgIGNvbnN0IHVpU3RhdGVQYXRoTGlzdCA9IHRoaXMudmlld01vZGVsQ29udGV4dEFuZFVJU3RhdGVQYXRoc01hcC5nZXQodmlld01vZGVsQ29udGV4dCk7XG4gICAgICAgIGlmICh1aVN0YXRlQ2hhbmdlLmZpZWxkICYmIHVpU3RhdGVQYXRoTGlzdC5pbmRleE9mKHVpU3RhdGVDaGFuZ2UuZmllbGQpID4gLTEpIHtcbiAgICAgICAgICB0aGlzLnN0YXRlTWFjaGluZS5yZW5kZXIoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMudmlld01vZGVsQ29udGV4dEFuZFVJU3RhdGVQYXRoc01hcC5nZXQodmlld01vZGVsQ29udGV4dCkuaW5kZXhPZih1aVN0YXRlUGF0aCkgPT09IC0xKSB7XG4gICAgICB0aGlzLnVpU3RhdGVQYXRoTGlzdC5wdXNoKHVpU3RhdGVQYXRoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog55uR5ZCs5a6e5L2T5Y+Y5pu0XG4gICAqL1xuICBwdWJsaWMgc3Vic2NyaWJlRW50aXR5Q2hhbmdlKHZpZXdNb2RlbENvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQsIGV4cHJlc3Npb246IGFueSkge1xuXG4gICAgaWYgKHRoaXMudmlld01vZGVsQ29udGV4dEFuZERhdGFTdGF0ZVBhdGhzTWFwLmhhcyh2aWV3TW9kZWxDb250ZXh0KSA9PT0gZmFsc2UpIHtcbiAgICAgIHRoaXMudmlld01vZGVsQ29udGV4dEFuZERhdGFTdGF0ZVBhdGhzTWFwLnNldCh2aWV3TW9kZWxDb250ZXh0LCB0aGlzLmRhdGFTdGF0ZVBhdGhMaXN0KTtcbiAgICAgIHZpZXdNb2RlbENvbnRleHQuYmluZGluZ0RhdGEuY2hhbmdlcy5zdWJzY3JpYmUoKGNoYW5nZTogQ2hhbmdlKSA9PiB7XG5cbiAgICAgICAgaWYgKGNoYW5nZS50eXBlID09PSAnTG9hZCcgfHwgY2hhbmdlLnR5cGUgPT09ICdTZWxlY3Rpb25DaGFuZ2VkJykge1xuICAgICAgICAgIHRoaXMuc3RhdGVNYWNoaW5lLnJlbmRlcigpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGF0YVBhdGhMaXN0ID0gdGhpcy52aWV3TW9kZWxDb250ZXh0QW5kRGF0YVN0YXRlUGF0aHNNYXAuZ2V0KHZpZXdNb2RlbENvbnRleHQpO1xuICAgICAgICBpZiAoY2hhbmdlLnBhdGguam9pbigpICYmIHRoaXMuaXNBY2NvcmRpbmdQYXRoKGRhdGFQYXRoTGlzdCwgY2hhbmdlLnBhdGguam9pbignLycpKSkge1xuICAgICAgICAgIHRoaXMuc3RhdGVNYWNoaW5lLnJlbmRlcigpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy52aWV3TW9kZWxDb250ZXh0QW5kRGF0YVN0YXRlUGF0aHNNYXAuZ2V0KHZpZXdNb2RlbENvbnRleHQpLmluZGV4T2YoZXhwcmVzc2lvbikgPT09IC0xKSB7XG4gICAgICB0aGlzLmRhdGFTdGF0ZVBhdGhMaXN0LnB1c2goZXhwcmVzc2lvbik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOagueaNruihqOi+vuW8j+iOt+WPluWvueW6lOeahFN0YXRlUGF0aO+8iOenu+mZpOS6hlZpZXdNb2RlbElk5LmL5aSW55qE6YOo5YiG77yJXG4gICAqIEBwYXJhbSBleHByZXNzaW9uIOWPmOmHj+ihqOi+vuW8j1xuICAgKi9cbiAgcHJpdmF0ZSBnZXRTdGF0ZVBhdGgoZXhwcmVzc2lvbjogYW55KSB7XG4gICAgcmV0dXJuIHRoaXMuZXh0cmFjdFBhdGhzKGV4cHJlc3Npb24pLnNwbGl0KCcvJylbMl07XG4gIH1cblxuICAvKipcbiAgICog5Yik5pat5piv5ZCm55uR5ZCs6IyD5Zu05YaF55qE5Y+Y5pu06Lev5b6EXG4gICAqL1xuICBwdWJsaWMgaXNBY2NvcmRpbmdQYXRoKGRhdGFTdGF0ZVBhdGhzOiBhbnksIGRhdGFTdGF0ZVBhdGg6IHN0cmluZykge1xuICAgIGNvbnN0IHRhcmdldFBhdGggPSBkYXRhU3RhdGVQYXRocy5maW5kKChpdGVtKSA9PiB7XG4gICAgICByZXR1cm4gaXRlbS5pbmRleE9mKGRhdGFTdGF0ZVBhdGgpID4gLTE7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGFyZ2V0UGF0aCA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIOaaguaXtuaKiui/meS4quaWueazleaUvuS6hui/meS4quWcsOaWue+8jOetieWto+iAgeW4iOWFseeUqOaWueazleiwg+aVtOWQju+8jOebtOaOpeW8leeUqOS7lueahOaWueazle+8jOivpeaWueazleWPr+WIoOmZpFxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbiDlj5jph4/ooajovr7lvI9cbiAgICovXG4gIHByaXZhdGUgZXh0cmFjdFBhdGhzKGV4cHJlc3Npb246IHN0cmluZyk6IHN0cmluZyB7XG4gICAgbGV0IHBhdGg6IHN0cmluZztcbiAgICBjb25zdCBVSV9TVEFURV9QQVRURVJOX0cgPSAvXFx7VUlTVEFURX4oXFxTKz8pXFx9L2c7XG4gICAgY29uc3QgREFUQV9QQVRURVJOX0cgPSAvXFx7REFUQX4oXFxTKz8pXFx9L2c7XG4gICAgY29uc3QgdWlTdGF0ZVZhcmlhYmxlcyA9IGV4cHJlc3Npb24ubWF0Y2goVUlfU1RBVEVfUEFUVEVSTl9HKTtcbiAgICBjb25zdCBkYXRhVmFyaWFibGVzID0gZXhwcmVzc2lvbi5tYXRjaChEQVRBX1BBVFRFUk5fRyk7XG4gICAgaWYgKHVpU3RhdGVWYXJpYWJsZXMgIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IFVJX1NUQVRFX1BBVFRFUk4gPSAvXFx7VUlTVEFURX4oXFxTKz8pXFx9LztcbiAgICAgIHVpU3RhdGVWYXJpYWJsZXMuZm9yRWFjaCgodWlTdGF0ZVZhcmlhYmxlOiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3QgcGF0aE1hdGNoZXMgPSB1aVN0YXRlVmFyaWFibGUubWF0Y2goVUlfU1RBVEVfUEFUVEVSTik7XG4gICAgICAgIGlmIChwYXRoTWF0Y2hlcyAhPSBudWxsICYmIHBhdGhNYXRjaGVzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgIHBhdGggPSBwYXRoTWF0Y2hlc1sxXTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIGlmIChkYXRhVmFyaWFibGVzICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBEQVRBX1BBVFRFUk4gPSAvXFx7REFUQX4oXFxTKz8pXFx9LztcbiAgICAgIGRhdGFWYXJpYWJsZXMuZm9yRWFjaCgoZGF0YVZhcmlhYmxlOiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3QgcGF0aE1hdGNoZXMgPSBkYXRhVmFyaWFibGUubWF0Y2goREFUQV9QQVRURVJOKTtcbiAgICAgICAgaWYgKHBhdGhNYXRjaGVzICE9IG51bGwgJiYgcGF0aE1hdGNoZXMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgcGF0aCA9IHBhdGhNYXRjaGVzWzFdO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHBhdGg7XG4gIH1cbn0iXX0=