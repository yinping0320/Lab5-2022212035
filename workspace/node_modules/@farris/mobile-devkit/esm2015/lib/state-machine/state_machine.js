import { BehaviorSubject } from 'rxjs';
import { MetadataUtil } from '../core/index';
import { State, initialUIState } from './types';
import { STATE_PROP_META, RENDER_STATE_PROP_META, ACTION_METHOD_META } from './decorators';
import { StateMachineContext } from './state_machine_context';
import { StateMachineWatcher } from './state_machine_watcher';
/**
 * 状态机
 */
export class StateMachine {
    /**
     * 构造函数
     */
    constructor() {
        this.renderStates = {};
        this.handlePropMetadatas();
        this.stateChange = new BehaviorSubject(false);
        this.context = new StateMachineContext(this, this.initialState);
        this.stateMachineWatcher = new StateMachineWatcher(this);
    }
    /**
     * 初始化状态机
     * @param viewModelContext ViewModel上下文
     * @summary
     * 状态机变更，为了在绑定数据之后执行状态机的操作，把render方法延后执行。
     */
    init(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.context.init(this.viewModelContext);
        this.stateMachineWatcher.init(this.viewModelContext);
        this.render();
    }
    /**
     * 批量处理属性元数据
     */
    handlePropMetadatas() {
        const propsMetadatas = MetadataUtil.getPropsMetadatas(this.constructor);
        // 遍历所有属性装饰器，并调用相应的build方法
        if (propsMetadatas) {
            Object.keys(propsMetadatas).forEach((propName) => {
                const propMetadatas = propsMetadatas[propName];
                propMetadatas.forEach(propMetadata => {
                    this.handlePropMetadata(propName, propMetadata);
                });
            });
        }
        if (!this.initialState) {
            throw new Error('请在StatePropMeta注解中指定状态机的初始状态。');
        }
    }
    /**
     * 处理属性元数据
     */
    handlePropMetadata(propName, propMetadata) {
        const ngMetadataName = propMetadata.ngMetadataName;
        switch (ngMetadataName) {
            case STATE_PROP_META:
                this.buildState(propName, propMetadata);
                break;
            case RENDER_STATE_PROP_META:
                this.buildRenderState(propName, propMetadata);
                break;
            case ACTION_METHOD_META:
                this.buildAction(propName, propMetadata);
                break;
            default:
                break;
        }
    }
    /**
     * 包装State
     * @param stateName 状态名称
     * @param ngState   状态对象
     */
    buildState(stateName, ngState) {
        this.states = this.states || {};
        this[stateName] = new State(stateName);
        this.states[stateName] = this[stateName];
        if (ngState.initialState) {
            this.initialState = this[stateName];
        }
    }
    /**
     * 包装RenderState
     * @param renderStateName 渲染状态名称
     * @param ngRenderState   渲染状态元数据
     */
    buildRenderState(renderStateName, ngRenderState) {
        this.renderStates = this.renderStates || {};
        this[renderStateName] = initialUIState;
        this.renderStates[renderStateName] = this[renderStateName];
        // 将renderState上指定的render加入到renders中
        this.renders = this.renders || {};
        this.renders[renderStateName] = ngRenderState.render;
    }
    /**
     * 包装Action
     * @param actionName 动作名称
     * @param ngAction 动作元数据
     */
    buildAction(actionName, ngAction) {
        this[actionName] = () => {
            const nextStateName = ngAction.transitTo;
            const nextState = this.states[nextStateName];
            this.context.transitTo(nextState.name);
            this.render();
        };
    }
    /**
     * 重新计算所有渲染状态的值
     * @sumamry
     * 当 state切换的时候，调用遍历所有的render方法，更改renderState
     */
    render() {
        for (const renderStateName in this.renderStates) {
            if (this.renderStates.hasOwnProperty(renderStateName) === false) {
                continue;
            }
            // 执行RenderState的render方法，更新renderState
            const stateRender = this.renders[renderStateName];
            if (!stateRender) {
                continue;
            }
            this.renderStates[renderStateName] = stateRender(this.context);
            this[renderStateName] = this.renderStates[renderStateName];
        }
        this.stateChange.next(this.context.state);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVfbWFjaGluZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9zdGF0ZS1tYWNoaW5lL3N0YXRlX21hY2hpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN2QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzdDLE9BQU8sRUFBRSxLQUFLLEVBQUUsY0FBYyxFQUE0RCxNQUFNLFNBQVMsQ0FBQztBQUMxRyxPQUFPLEVBRUwsZUFBZSxFQUFFLHNCQUFzQixFQUFFLGtCQUFrQixFQUM1RCxNQUFNLGNBQWMsQ0FBQztBQUN0QixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUU5RDs7R0FFRztBQUNILE1BQU0sT0FBTyxZQUFZO0lBMEN2Qjs7T0FFRztJQUNIO1FBQ0UsSUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLGVBQWUsQ0FBTSxLQUFLLENBQUMsQ0FBQztRQUNuRCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksbUJBQW1CLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNoRSxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSSxJQUFJLENBQUMsZ0JBQWtDO1FBQzVDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztRQUN6QyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMs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SUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUNwRCxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdkMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2hCLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsTUFBTTtRQUNKLEtBQUssTUFBTSxlQUFlLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtZQUUvQyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLGVBQWUsQ0FBQyxLQUFLLEtBQUssRUFBRTtnQkFDL0QsU0FBUzthQUNWO1lBRUQsdUNBQXVDO1lBQ3ZDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDbEQsSUFBSSxDQUFDLFdBQVcsRUFBRTtnQkFDaEIsU0FBUzthQUNWO1lBRUQsSUFBSSxDQUFDLFlBQVksQ0FBQyxlQUFlLENBQUMsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQy9ELElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1NBQzVEO1FBQ0QsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM1QyxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IE1ldGFkYXRhVXRpbCB9IGZyb20gJy4uL2NvcmUvaW5kZXgnO1xuaW1wb3J0IHsgVmlld01vZGVsQ29udGV4dCB9IGZyb20gJy4uL3ZpZXctbW9kZWwvaW5kZXgnO1xuXG5pbXBvcnQgeyBTdGF0ZSwgaW5pdGlhbFVJU3RhdGUsIFN0YXRlRGljdGlvbmFyeSwgUmVuZGVyU3RhdGVEaWN0aW9uYXJ5LCBSZW5kZXJEaWN0aW9uYXJ5IH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQge1xuICBTdGF0ZVByb3BNZXRhZGF0YSwgQWN0aW9uTWV0aG9kTWV0YWRhdGEsIFJlbmRlclN0YXRlUHJvcE1ldGFkYXRhLFxuICBTVEFURV9QUk9QX01FVEEsIFJFTkRFUl9TVEFURV9QUk9QX01FVEEsIEFDVElPTl9NRVRIT0RfTUVUQVxufSBmcm9tICcuL2RlY29yYXRvcnMnO1xuaW1wb3J0IHsgU3RhdGVNYWNoaW5lQ29udGV4dCB9IGZyb20gJy4vc3RhdGVfbWFjaGluZV9jb250ZXh0JztcbmltcG9ydCB7IFN0YXRlTWFjaGluZVdhdGNoZXIgfSBmcm9tICcuL3N0YXRlX21hY2hpbmVfd2F0Y2hlcic7XG5cbi8qKlxuICog54q25oCB5py6XG4gKi9cbmV4cG9ydCBjbGFzcyBTdGF0ZU1hY2hpbmUge1xuXG4gIC8qKlxuICAgKiDliJ3lp4vnirbmgIFcbiAgICovXG4gIHByaXZhdGUgaW5pdGlhbFN0YXRlOiBTdGF0ZTtcblxuICAvKipcbiAgICog54q25oCB5a2X5YW4XG4gICAqL1xuICBwdWJsaWMgc3RhdGVzOiBTdGF0ZURpY3Rpb25hcnk7XG5cbiAgLyoqXG4gICAqIOa4suafk+eKtuaAgeWtl+WFuFxuICAgKi9cbiAgcHVibGljIHJlbmRlclN0YXRlczogUmVuZGVyU3RhdGVEaWN0aW9uYXJ5O1xuXG4gIC8qKlxuICAgKiDmuLLmn5PlmajlrZflhbhcbiAgICovXG4gIHB1YmxpYyByZW5kZXJzOiBSZW5kZXJEaWN0aW9uYXJ5O1xuXG4gIC8qKlxuICAgKiDnirbmgIHmnLrkuIrkuIvmlodcbiAgICovXG4gIHB1YmxpYyBjb250ZXh0OiBTdGF0ZU1hY2hpbmVDb250ZXh0O1xuXG4gIC8qKlxuICAgKiDnirbmgIHlj5jmm7RcbiAgICovXG4gIHB1YmxpYyBzdGF0ZUNoYW5nZTogQmVoYXZpb3JTdWJqZWN0PHN0cmluZz47XG5cbiAgLyoqXG4gICAqIFZpZXdNb2RlbOS4iuS4i+aWh1xuICAgKi9cbiAgcHVibGljIHZpZXdNb2RlbENvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQ7XG5cbiAgLyoqXG4gICAqIOeKtuaAgeacuuS6i+S7tuebkeWQrFxuICAgKi9cbiAgcHVibGljIHN0YXRlTWFjaGluZVdhdGNoZXI6IFN0YXRlTWFjaGluZVdhdGNoZXI7XG5cbiAgLyoqXG4gICAqIOaehOmAoOWHveaVsFxuICAgKi9cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5yZW5kZXJTdGF0ZXMgPSB7fTtcbiAgICB0aGlzLmhhbmRsZVByb3BNZXRhZGF0YXMoKTtcbiAgICB0aGlzLnN0YXRlQ2hhbmdlID0gbmV3IEJlaGF2aW9yU3ViamVjdDxhbnk+KGZhbHNlKTtcbiAgICB0aGlzLmNvbnRleHQgPSBuZXcgU3RhdGVNYWNoaW5lQ29udGV4dCh0aGlzLCB0aGlzLmluaXRpYWxTdGF0ZSk7XG4gICAgdGhpcy5zdGF0ZU1hY2hpbmVXYXRjaGVyID0gbmV3IFN0YXRlTWFjaGluZVdhdGNoZXIodGhpcyk7XG4gIH1cblxuICAvKipcbiAgICog5Yid5aeL5YyW54q25oCB5py6XG4gICAqIEBwYXJhbSB2aWV3TW9kZWxDb250ZXh0IFZpZXdNb2RlbOS4iuS4i+aWh1xuICAgKiBAc3VtbWFyeVxuICAgKiDnirbmgIHmnLrlj5jmm7TvvIzkuLrkuoblnKjnu5HlrprmlbDmja7kuYvlkI7miafooYznirbmgIHmnLrnmoTmk43kvZzvvIzmiopyZW5kZXLmlrnms5Xlu7blkI7miafooYzjgIJcbiAgICovXG4gIHB1YmxpYyBpbml0KHZpZXdNb2RlbENvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQpIHtcbiAgICB0aGlzLnZpZXdNb2RlbENvbnRleHQgPSB2aWV3TW9kZWxDb250ZXh0O1xuICAgIHRoaXMuY29udGV4dC5pbml0KHRoaXMudmlld01vZGVsQ29udGV4dCk7XG4gICAgdGhpcy5zdGF0ZU1hY2hpbmVXYXRjaGVyLmluaXQodGhpcy52aWV3TW9kZWxDb250ZXh0KTtcbiAgICB0aGlzLnJlbmRlcigpO1xuICB9XG5cbiAgLyoqXG4gICAqIOaJuemHj+WkhOeQhuWxnuaAp+WFg+aVsOaNrlxuICAgKi9cbiAgcHJpdmF0ZSBoYW5kbGVQcm9wTWV0YWRhdGFzKCkge1xuICAgIGNvbnN0IHByb3BzTWV0YWRhdGFzID0gTWV0YWRhdGFVdGlsLmdldFByb3BzTWV0YWRhdGFzKHRoaXMuY29uc3RydWN0b3IpO1xuXG4gICAgLy8g6YGN5Y6G5omA5pyJ5bGe5oCn6KOF6aWw5Zmo77yM5bm26LCD55So55u45bqU55qEYnVpbGTmlrnms5VcbiAgICBpZiAocHJvcHNNZXRhZGF0YXMpIHtcbiAgICAgIE9iamVjdC5rZXlzKHByb3BzTWV0YWRhdGFzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IHByb3BNZXRhZGF0YXMgPSBwcm9wc01ldGFkYXRhc1twcm9wTmFtZV07XG4gICAgICAgIHByb3BNZXRhZGF0YXMuZm9yRWFjaChwcm9wTWV0YWRhdGEgPT4ge1xuICAgICAgICAgIHRoaXMuaGFuZGxlUHJvcE1ldGFkYXRhKHByb3BOYW1lLCBwcm9wTWV0YWRhdGEpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5pbml0aWFsU3RhdGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcign6K+35ZyoU3RhdGVQcm9wTWV0YeazqOino+S4reaMh+WumueKtuaAgeacuueahOWIneWni+eKtuaAgeOAgicpO1xuICAgIH1cbiAgfVxuICBcbiAgLyoqXG4gICAqIOWkhOeQhuWxnuaAp+WFg+aVsOaNrlxuICAgKi9cbiAgcHJpdmF0ZSBoYW5kbGVQcm9wTWV0YWRhdGEocHJvcE5hbWU6IHN0cmluZywgcHJvcE1ldGFkYXRhOiBhbnkpIHtcbiAgICBjb25zdCBuZ01ldGFkYXRhTmFtZSA9ICBwcm9wTWV0YWRhdGEubmdNZXRhZGF0YU5hbWU7XG4gICAgc3dpdGNoKG5nTWV0YWRhdGFOYW1lKSB7XG4gICAgICBjYXNlIFNUQVRFX1BST1BfTUVUQTpcbiAgICAgICAgdGhpcy5idWlsZFN0YXRlKHByb3BOYW1lLCBwcm9wTWV0YWRhdGEpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgUkVOREVSX1NUQVRFX1BST1BfTUVUQTpcbiAgICAgICAgdGhpcy5idWlsZFJlbmRlclN0YXRlKHByb3BOYW1lLCBwcm9wTWV0YWRhdGEpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgQUNUSU9OX01FVEhPRF9NRVRBOlxuICAgICAgICB0aGlzLmJ1aWxkQWN0aW9uKHByb3BOYW1lLCBwcm9wTWV0YWRhdGEpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDljIXoo4VTdGF0ZVxuICAgKiBAcGFyYW0gc3RhdGVOYW1lIOeKtuaAgeWQjeensFxuICAgKiBAcGFyYW0gbmdTdGF0ZSAgIOeKtuaAgeWvueixoVxuICAgKi9cbiAgcHJpdmF0ZSBidWlsZFN0YXRlKHN0YXRlTmFtZTogc3RyaW5nLCBuZ1N0YXRlOiBTdGF0ZVByb3BNZXRhZGF0YSkge1xuICAgIHRoaXMuc3RhdGVzID0gdGhpcy5zdGF0ZXMgfHwge307XG4gICAgdGhpc1tzdGF0ZU5hbWVdID0gbmV3IFN0YXRlKHN0YXRlTmFtZSk7XG4gICAgdGhpcy5zdGF0ZXNbc3RhdGVOYW1lXSA9IHRoaXNbc3RhdGVOYW1lXTtcbiAgICBpZiAobmdTdGF0ZS5pbml0aWFsU3RhdGUpIHtcbiAgICAgIHRoaXMuaW5pdGlhbFN0YXRlID0gdGhpc1tzdGF0ZU5hbWVdO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDljIXoo4VSZW5kZXJTdGF0ZVxuICAgKiBAcGFyYW0gcmVuZGVyU3RhdGVOYW1lIOa4suafk+eKtuaAgeWQjeensFxuICAgKiBAcGFyYW0gbmdSZW5kZXJTdGF0ZSAgIOa4suafk+eKtuaAgeWFg+aVsOaNrlxuICAgKi9cbiAgcHJpdmF0ZSBidWlsZFJlbmRlclN0YXRlKHJlbmRlclN0YXRlTmFtZTogc3RyaW5nLCBuZ1JlbmRlclN0YXRlOiBSZW5kZXJTdGF0ZVByb3BNZXRhZGF0YSkge1xuICAgIHRoaXMucmVuZGVyU3RhdGVzID0gdGhpcy5yZW5kZXJTdGF0ZXMgfHwge307XG4gICAgdGhpc1tyZW5kZXJTdGF0ZU5hbWVdID0gaW5pdGlhbFVJU3RhdGU7XG4gICAgdGhpcy5yZW5kZXJTdGF0ZXNbcmVuZGVyU3RhdGVOYW1lXSA9IHRoaXNbcmVuZGVyU3RhdGVOYW1lXTtcblxuICAgIC8vIOWwhnJlbmRlclN0YXRl5LiK5oyH5a6a55qEcmVuZGVy5Yqg5YWl5YiwcmVuZGVyc+S4rVxuICAgIHRoaXMucmVuZGVycyA9IHRoaXMucmVuZGVycyB8fCB7fTtcbiAgICB0aGlzLnJlbmRlcnNbcmVuZGVyU3RhdGVOYW1lXSA9IG5nUmVuZGVyU3RhdGUucmVuZGVyO1xuICB9XG5cbiAgLyoqXG4gICAqIOWMheijhUFjdGlvblxuICAgKiBAcGFyYW0gYWN0aW9uTmFtZSDliqjkvZzlkI3np7BcbiAgICogQHBhcmFtIG5nQWN0aW9uIOWKqOS9nOWFg+aVsOaNrlxuICAgKi9cbiAgcHJpdmF0ZSBidWlsZEFjdGlvbihhY3Rpb25OYW1lOiBzdHJpbmcsIG5nQWN0aW9uOiBBY3Rpb25NZXRob2RNZXRhZGF0YSkge1xuICAgIHRoaXNbYWN0aW9uTmFtZV0gPSAoKSA9PiB7XG4gICAgICBjb25zdCBuZXh0U3RhdGVOYW1lID0gbmdBY3Rpb24udHJhbnNpdFRvO1xuICAgICAgY29uc3QgbmV4dFN0YXRlOiBTdGF0ZSA9IHRoaXMuc3RhdGVzW25leHRTdGF0ZU5hbWVdO1xuICAgICAgdGhpcy5jb250ZXh0LnRyYW5zaXRUbyhuZXh0U3RhdGUubmFtZSk7XG4gICAgICB0aGlzLnJlbmRlcigpO1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICog6YeN5paw6K6h566X5omA5pyJ5riy5p+T54q25oCB55qE5YC8XG4gICAqIEBzdW1hbXJ5XG4gICAqIOW9kyBzdGF0ZeWIh+aNoueahOaXtuWAme+8jOiwg+eUqOmBjeWOhuaJgOacieeahHJlbmRlcuaWueazle+8jOabtOaUuXJlbmRlclN0YXRlXG4gICAqL1xuICByZW5kZXIoKSB7XG4gICAgZm9yIChjb25zdCByZW5kZXJTdGF0ZU5hbWUgaW4gdGhpcy5yZW5kZXJTdGF0ZXMpIHtcblxuICAgICAgaWYgKHRoaXMucmVuZGVyU3RhdGVzLmhhc093blByb3BlcnR5KHJlbmRlclN0YXRlTmFtZSkgPT09IGZhbHNlKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICAvLyDmiafooYxSZW5kZXJTdGF0ZeeahHJlbmRlcuaWueazle+8jOabtOaWsHJlbmRlclN0YXRlXG4gICAgICBjb25zdCBzdGF0ZVJlbmRlciA9IHRoaXMucmVuZGVyc1tyZW5kZXJTdGF0ZU5hbWVdO1xuICAgICAgaWYgKCFzdGF0ZVJlbmRlcikge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5yZW5kZXJTdGF0ZXNbcmVuZGVyU3RhdGVOYW1lXSA9IHN0YXRlUmVuZGVyKHRoaXMuY29udGV4dCk7XG4gICAgICB0aGlzW3JlbmRlclN0YXRlTmFtZV0gPSB0aGlzLnJlbmRlclN0YXRlc1tyZW5kZXJTdGF0ZU5hbWVdO1xuICAgIH1cbiAgICB0aGlzLnN0YXRlQ2hhbmdlLm5leHQodGhpcy5jb250ZXh0LnN0YXRlKTtcbiAgfVxufVxuIl19