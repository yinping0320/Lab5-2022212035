/*
 * @Author: Lucus, Witt
 * @Date: 2018-10-30 15:53:59
 * @Last Modified by: Witt
 * @Last Modified time: 2018-11-08 17:25:08
 */
import { ModifyType } from './types';
function isEqual(value, other) {
    return JSON.stringify(value) === JSON.stringify(other);
}
/**
 * 实体数据变更集
 */
class ChangeSet {
    constructor() {
        /**
         * 变更集合
         */
        this.modifications = [];
    }
    /**
     *  获取所有的变更记录
     */
    get changes() {
        return this.modifications;
    }
    /**
     * 将变更集添加到集合中
     * ### 使用示例
     * ```
     * const changeSet = new ChangeSet();
     * const modify = new Modification('newValue', ModifyType.ValueChange, [1, 'title'], 'oldValue');
     * changeSet.append(modify)
     * ```
     * @param changeItem 变更数据
     */
    append(modification) {
        switch (modification.type) {
            case ModifyType.ValueChange:
                this.appendValueChangeModification(modification);
                break;
            case ModifyType.Add:
            case ModifyType.Insert:
            case ModifyType.Clone:
                this.appendAddModification(modification);
                break;
            case ModifyType.Remove:
                this.appendRemoveModification(modification);
                break;
            case ModifyType.Load:
                break;
            default:
                throw new Error('不支持此类型的变更');
        }
    }
    /**
     * 添加值变化变更
     */
    appendValueChangeModification(modification) {
        const value = modification.value;
        const existedModification = this.findModifyItemsPath(modification.path);
        if (existedModification) {
            // 如果存在相同路径的ValueChange类型的变更集，则更新值；
            existedModification.value = value;
        }
        else {
            const existedAddModification = this.findNewAddItemsPath(modification.path);
            if (existedAddModification) {
                // @todo：
                // 1、此处逻辑有问题，value是个字符串，不能直接assign；
                // 2、之所以没有出现问题，是因为都是服务器端新增，新增后，客户端清空了所有变更。
                // 如果存在涵盖该ValueChange变更的Add变更，则更新Add变更对应的数据；
                existedAddModification.value = Object.assign({}, existedAddModification.value, value);
            }
            else {
                // 其他情况，新增一条ValueChange变更。
                this.modifications.push(modification);
            }
        }
    }
    /**
     * 添加新增变更
     */
    appendAddModification(modification) {
        const value = modification.value;
        const existedModification = this.findNewAddItemsPath(modification.path);
        if (existedModification) {
            // 1、如果已经存在相同路径的Add变更，则合并Value。
            existedModification.value = existedModification.value.concat(value);
        }
        else {
            // 2、如果没有，则新增一条Add变更。
            this.modifications.push(modification);
        }
    }
    /**
     * 添加删除变更
     */
    appendRemoveModification(modification) {
        const path = modification.path;
        const primaryKey = Object.keys(modification.value)[0];
        const primaryKeyValue = modification.value[primaryKey];
        // 1、存在相同path的新增变更，移除新增变更，不需要添加删除变更；
        // @todo：待重构（1、只考虑了主从情况，2、临时用多重循环实现）
        this.modifications.forEach((addModification) => {
            // 只处理新增变更
            if (addModification.type !== ModifyType.Add && addModification.type !== ModifyType.Insert && addModification.type !== ModifyType.Clone) {
                return;
            }
            // @todo 只考虑主从结构，再深的层次暂不考虑
            if (isEqual(addModification.path, path) === false) {
                return;
            }
            // 遍历新增新增变更的value（value是个数组），移除相匹配的新增删除
            addModification.value = addModification.value.filter((addDataItem) => {
                return addDataItem[primaryKey] !== primaryKeyValue;
            });
        });
        // 2、移除对应的修改变更
        const fullRemovePath = path.concat(`${primaryKey}:${primaryKeyValue}`);
        this.modifications = this.modifications.filter((valueModification) => {
            if (valueModification.type !== ModifyType.ValueChange) {
                return true;
            }
            const valueChangePath = Array.from(valueModification.path);
            valueChangePath.pop();
            // 路径相同进行移除
            const isToRemove = isEqual(valueChangePath, fullRemovePath);
            return !isToRemove;
        });
        // 先删除下级删除变更，再插入
        // 主要针对从从表删除之后，又删除子表时，根实体上还存在从从表删除变更的场景
        this.removeDescendantRemoveModifications(modification);
        this.modifications.push(modification);
    }
    /**
     * 清空变更集合
     */
    clear() {
        this.modifications = [];
    }
    /**
     * 根据path获取Add类型的变更记录
     * @param path 变更路径
     */
    findNewAddItemsPath(path) {
        return this.modifications.find((value, index) => {
            return isEqual(path, value.path) && (value.type === ModifyType.Add || value.type === ModifyType.Insert || value.type === ModifyType.Clone);
        });
    }
    /**
     * 根据path获取ValueChange类型的变更记录
     * @param path 变更路径
     */
    findModifyItemsPath(path) {
        return this.modifications.find((value, index) => {
            return isEqual(path, value.path) && value.type === ModifyType.ValueChange;
        });
    }
    /**
     * 删除后代（包括自己）所有的删除变更
     * @todo：临时做一个最小化修改
     */
    removeDescendantRemoveModifications(parentRemoveModification) {
        const parentPathWithId = this.createRemovePathWithId(parentRemoveModification);
        // 删除后代修改变更
        this.modifications = this.modifications.filter((modification) => {
            if (modification.type !== ModifyType.Remove) {
                return true;
            }
            const descendantPathWithId = this.createRemovePathWithId(modification);
            const isDescendant = this.isDescendantPath(parentPathWithId, descendantPathWithId);
            return !isDescendant;
        });
    }
    /**
     * 获取删除路径的完整格式
     * @summary
     * 1、目前删除变更的路径标记到父集合；
     * 2、为了方便比较，将被删除的数据id加入到路径中
     */
    createRemovePathWithId(modification) {
        const path = modification.path;
        const primaryKey = Object.keys(modification.value)[0];
        const primaryKeyValue = modification.value[primaryKey];
        const pathWithId = path.concat([`${primaryKey}:${primaryKeyValue}`]);
        return pathWithId;
    }
    /**
     * 判断是否是后代节点路径
     * @param parentPath 父节点路径
     * @param descendantPath 后代节点
     */
    isDescendantPath(parentPath, descendantPath) {
        if (parentPath.length > descendantPath.length) {
            return false;
        }
        let isDescendantPath = true;
        parentPath.forEach((parentPathItem, parentPathItemIndex) => {
            if (parentPathItem !== descendantPath[parentPathItemIndex]) {
                isDescendantPath = false;
                return;
            }
        });
        return isDescendantPath;
    }
}
export { ChangeSet };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbmdlX3NldC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9jaGFuZ2VzZXQvY2hhbmdlX3NldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7R0FLRztBQUVILE9BQU8sRUFBZ0IsVUFBVSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRW5ELFNBQVMsT0FBTyxDQUFDLEtBQVUsRUFBRSxLQUFVO0lBQ3JDLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsS0FBTSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzFELENBQUM7QUFFRDs7R0FFRztBQUNILE1BQU0sU0FBUztJQUFmO1FBRUU7O1dBRUc7UUFDTyxrQkFBYSxHQUFtQixFQUFFLENBQUM7SUF3Ti9DLENBQUM7SUF0TkM7O09BRUc7SUFDSCxJQUFXLE9BQU87UUFDaEIsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDO0lBQzVCLENBQUM7SUFFRDs7Ozs7Ozs7O09BU0c7SUFDSSxNQUFNLENBQUMsWUFBMEI7UUFDdEMsUUFBUSxZQUFZLENBQUMsSUFBSSxFQUFFO1lBQ3pCLEtBQUssVUFBVSxDQUFDLFdBQVc7Z0JBQ3pCLElBQUksQ0FBQyw2QkFBNkIsQ0FBQyxZQUFZLENBQUMsQ0FBQztnQkFDakQsTUFBTTtZQUNSLEtBQUssVUFBVSxDQUFDLEdBQUcsQ0FBQztZQUNwQixLQUFLLFVBQVUsQ0FBQyxNQUFNLENBQUM7WUFDdkIsS0FBSyxVQUFVLENBQUMsS0FBSztnQkFDbkIsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUN6QyxNQUFNO1lBQ1IsS0FBSyxVQUFVLENBQUMsTUFBTTtnQkFDcEIsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUM1QyxNQUFNO1lBQ1IsS0FBSyxVQUFVLENBQUMsSUFBSTtnQkFDbEIsTUFBTTtZQUNSO2dCQUNF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QUFDLENBQUMsR0FBRyxVQUFVLElBQUksZUFBZSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JFLE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ssZ0JBQWdCLENBQUMsVUFBb0IsRUFBRSxjQUF3QjtRQUNyRSxJQUFJLFVBQVUsQ0FBQyxNQUFNLEdBQUcsY0FBYyxDQUFDLE1BQU0sRUFBRTtZQUM3QyxPQUFPLEtBQUssQ0FBQztTQUNkO1FBRUQsSUFBSSxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7UUFDNUIsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLGNBQXNCLEVBQUUsbUJBQTJCLEVBQUUsRUFBRTtZQUN6RSxJQUFJLGNBQWMsS0FBSyxjQUFjLENBQUMsbUJBQW1CLENBQUMsRUFBRTtnQkFDMUQsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO2dCQUN6QixPQUFPO2FBQ1I7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sZ0JBQWdCLENBQUM7SUFDMUIsQ0FBQztDQUVGO0FBRUQsT0FBTyxFQUFFLFNBQVMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIEBBdXRob3I6IEx1Y3VzLCBXaXR0XG4gKiBARGF0ZTogMjAxOC0xMC0zMCAxNTo1Mzo1OVxuICogQExhc3QgTW9kaWZpZWQgYnk6IFdpdHRcbiAqIEBMYXN0IE1vZGlmaWVkIHRpbWU6IDIwMTgtMTEtMDggMTc6MjU6MDhcbiAqL1xuXG5pbXBvcnQgeyBNb2RpZmljYXRpb24sIE1vZGlmeVR5cGUgfSBmcm9tICcuL3R5cGVzJztcblxuZnVuY3Rpb24gaXNFcXVhbCh2YWx1ZTogYW55LCBvdGhlcjogYW55KSB7XG4gIHJldHVybiBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgPT09ICBKU09OLnN0cmluZ2lmeShvdGhlcik7XG59XG5cbi8qKlxuICog5a6e5L2T5pWw5o2u5Y+Y5pu06ZuGXG4gKi9cbmNsYXNzIENoYW5nZVNldCB7XG5cbiAgLyoqXG4gICAqIOWPmOabtOmbhuWQiFxuICAgKi9cbiAgcHJvdGVjdGVkIG1vZGlmaWNhdGlvbnM6IE1vZGlmaWNhdGlvbltdID0gW107XG5cbiAgLyoqXG4gICAqICDojrflj5bmiYDmnInnmoTlj5jmm7TorrDlvZVcbiAgICovXG4gIHB1YmxpYyBnZXQgY2hhbmdlcygpOiBNb2RpZmljYXRpb25bXSB7XG4gICAgcmV0dXJuIHRoaXMubW9kaWZpY2F0aW9ucztcbiAgfVxuXG4gIC8qKlxuICAgKiDlsIblj5jmm7Tpm4bmt7vliqDliLDpm4blkIjkuK1cbiAgICogIyMjIOS9v+eUqOekuuS+i1xuICAgKiBgYGBcbiAgICogY29uc3QgY2hhbmdlU2V0ID0gbmV3IENoYW5nZVNldCgpO1xuICAgKiBjb25zdCBtb2RpZnkgPSBuZXcgTW9kaWZpY2F0aW9uKCduZXdWYWx1ZScsIE1vZGlmeVR5cGUuVmFsdWVDaGFuZ2UsIFsxLCAndGl0bGUnXSwgJ29sZFZhbHVlJyk7XG4gICAqIGNoYW5nZVNldC5hcHBlbmQobW9kaWZ5KVxuICAgKiBgYGBcbiAgICogQHBhcmFtIGNoYW5nZUl0ZW0g5Y+Y5pu05pWw5o2uXG4gICAqL1xuICBwdWJsaWMgYXBwZW5kKG1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSB7XG4gICAgc3dpdGNoIChtb2RpZmljYXRpb24udHlwZSkge1xuICAgICAgY2FzZSBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlOlxuICAgICAgICB0aGlzLmFwcGVuZFZhbHVlQ2hhbmdlTW9kaWZpY2F0aW9uKG1vZGlmaWNhdGlvbik7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBNb2RpZnlUeXBlLkFkZDpcbiAgICAgIGNhc2UgTW9kaWZ5VHlwZS5JbnNlcnQ6XG4gICAgICBjYXNlIE1vZGlmeVR5cGUuQ2xvbmU6XG4gICAgICAgIHRoaXMuYXBwZW5kQWRkTW9kaWZpY2F0aW9uKG1vZGlmaWNhdGlvbik7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBNb2RpZnlUeXBlLlJlbW92ZTpcbiAgICAgICAgdGhpcy5hcHBlbmRSZW1vdmVNb2RpZmljYXRpb24obW9kaWZpY2F0aW9uKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIE1vZGlmeVR5cGUuTG9hZDpcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ+S4jeaUr+aMgeatpOexu+Wei+eahOWPmOabtCcpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDmt7vliqDlgLzlj5jljJblj5jmm7RcbiAgICovXG4gIHByaXZhdGUgYXBwZW5kVmFsdWVDaGFuZ2VNb2RpZmljYXRpb24obW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pIHtcbiAgICBjb25zdCB2YWx1ZSA9IG1vZGlmaWNhdGlvbi52YWx1ZTtcblxuICAgIGNvbnN0IGV4aXN0ZWRNb2RpZmljYXRpb24gPSB0aGlzLmZpbmRNb2RpZnlJdGVtc1BhdGgobW9kaWZpY2F0aW9uLnBhdGgpO1xuICAgIGlmIChleGlzdGVkTW9kaWZpY2F0aW9uKSB7XG5cbiAgICAgIC8vIOWmguaenOWtmOWcqOebuOWQjOi3r+W+hOeahFZhbHVlQ2hhbmdl57G75Z6L55qE5Y+Y5pu06ZuG77yM5YiZ5pu05paw5YC877ybXG4gICAgICBleGlzdGVkTW9kaWZpY2F0aW9uLnZhbHVlID0gdmFsdWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGV4aXN0ZWRBZGRNb2RpZmljYXRpb24gPSB0aGlzLmZpbmROZXdBZGRJdGVtc1BhdGgobW9kaWZpY2F0aW9uLnBhdGgpO1xuICAgICAgaWYgKGV4aXN0ZWRBZGRNb2RpZmljYXRpb24pIHtcblxuICAgICAgICAvLyBAdG9kb++8mlxuICAgICAgICAvLyAx44CB5q2k5aSE6YC76L6R5pyJ6Zeu6aKY77yMdmFsdWXmmK/kuKrlrZfnrKbkuLLvvIzkuI3og73nm7TmjqVhc3NpZ27vvJtcbiAgICAgICAgLy8gMuOAgeS5i+aJgOS7peayoeacieWHuueOsOmXrumimO+8jOaYr+WboOS4uumDveaYr+acjeWKoeWZqOerr+aWsOWinu+8jOaWsOWinuWQju+8jOWuouaIt+err+a4heepuuS6huaJgOacieWPmOabtOOAglxuICAgICAgICAvLyDlpoLmnpzlrZjlnKjmtrXnm5bor6VWYWx1ZUNoYW5nZeWPmOabtOeahEFkZOWPmOabtO+8jOWImeabtOaWsEFkZOWPmOabtOWvueW6lOeahOaVsOaNru+8m1xuICAgICAgICBleGlzdGVkQWRkTW9kaWZpY2F0aW9uLnZhbHVlID0gT2JqZWN0LmFzc2lnbih7fSwgZXhpc3RlZEFkZE1vZGlmaWNhdGlvbi52YWx1ZSwgdmFsdWUpO1xuICAgICAgfSBlbHNlIHtcblxuICAgICAgICAvLyDlhbbku5bmg4XlhrXvvIzmlrDlop7kuIDmnaFWYWx1ZUNoYW5nZeWPmOabtOOAglxuICAgICAgICB0aGlzLm1vZGlmaWNhdGlvbnMucHVzaChtb2RpZmljYXRpb24pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDmt7vliqDmlrDlop7lj5jmm7RcbiAgICovXG4gIHByaXZhdGUgYXBwZW5kQWRkTW9kaWZpY2F0aW9uKG1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSB7XG4gICAgY29uc3QgdmFsdWUgPSBtb2RpZmljYXRpb24udmFsdWU7XG5cbiAgICBjb25zdCBleGlzdGVkTW9kaWZpY2F0aW9uID0gdGhpcy5maW5kTmV3QWRkSXRlbXNQYXRoKG1vZGlmaWNhdGlvbi5wYXRoKTtcbiAgICBpZiAoZXhpc3RlZE1vZGlmaWNhdGlvbikge1xuXG4gICAgICAvLyAx44CB5aaC5p6c5bey57uP5a2Y5Zyo55u45ZCM6Lev5b6E55qEQWRk5Y+Y5pu077yM5YiZ5ZCI5bm2VmFsdWXjgIJcbiAgICAgIGV4aXN0ZWRNb2RpZmljYXRpb24udmFsdWUgPSBleGlzdGVkTW9kaWZpY2F0aW9uLnZhbHVlLmNvbmNhdCh2YWx1ZSk7XG4gICAgfSBlbHNlIHtcblxuICAgICAgLy8gMuOAgeWmguaenOayoeacie+8jOWImeaWsOWinuS4gOadoUFkZOWPmOabtOOAglxuICAgICAgdGhpcy5tb2RpZmljYXRpb25zLnB1c2gobW9kaWZpY2F0aW9uKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog5re75Yqg5Yig6Zmk5Y+Y5pu0XG4gICAqL1xuICBwcml2YXRlIGFwcGVuZFJlbW92ZU1vZGlmaWNhdGlvbihtb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbikge1xuXG4gICAgY29uc3QgcGF0aCA9IG1vZGlmaWNhdGlvbi5wYXRoO1xuICAgIGNvbnN0IHByaW1hcnlLZXkgPSBPYmplY3Qua2V5cyhtb2RpZmljYXRpb24udmFsdWUpWzBdO1xuICAgIGNvbnN0IHByaW1hcnlLZXlWYWx1ZSA9IG1vZGlmaWNhdGlvbi52YWx1ZVtwcmltYXJ5S2V5XTtcblxuICAgIC8vIDHjgIHlrZjlnKjnm7jlkIxwYXRo55qE5paw5aKe5Y+Y5pu077yM56e76Zmk5paw5aKe5Y+Y5pu077yM5LiN6ZyA6KaB5re75Yqg5Yig6Zmk5Y+Y5pu077ybXG4gICAgLy8gQHRvZG/vvJrlvoXph43mnoTvvIgx44CB5Y+q6ICD6JmR5LqG5Li75LuO5oOF5Ya177yMMuOAgeS4tOaXtueUqOWkmumHjeW+queOr+WunueOsO+8iVxuICAgIHRoaXMubW9kaWZpY2F0aW9ucy5mb3JFYWNoKChhZGRNb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbikgPT4ge1xuXG4gICAgICAvLyDlj6rlpITnkIbmlrDlop7lj5jmm7RcbiAgICAgIGlmIChhZGRNb2RpZmljYXRpb24udHlwZSAhPT0gTW9kaWZ5VHlwZS5BZGQgJiYgYWRkTW9kaWZpY2F0aW9uLnR5cGUgIT09IE1vZGlmeVR5cGUuSW5zZXJ0ICYmIGFkZE1vZGlmaWNhdGlvbi50eXBlICE9PSBNb2RpZnlUeXBlLkNsb25lKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gQHRvZG8g5Y+q6ICD6JmR5Li75LuO57uT5p6E77yM5YaN5rex55qE5bGC5qyh5pqC5LiN6ICD6JmRXG4gICAgICBpZiAoaXNFcXVhbChhZGRNb2RpZmljYXRpb24ucGF0aCwgcGF0aCkgPT09IGZhbHNlKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8g6YGN5Y6G5paw5aKe5paw5aKe5Y+Y5pu055qEdmFsdWXvvIh2YWx1ZeaYr+S4quaVsOe7hO+8ie+8jOenu+mZpOebuOWMuemFjeeahOaWsOWinuWIoOmZpFxuICAgICAgYWRkTW9kaWZpY2F0aW9uLnZhbHVlID0gYWRkTW9kaWZpY2F0aW9uLnZhbHVlLmZpbHRlcigoYWRkRGF0YUl0ZW06IGFueSkgPT4ge1xuICAgICAgICByZXR1cm4gYWRkRGF0YUl0ZW1bcHJpbWFyeUtleV0gIT09IHByaW1hcnlLZXlWYWx1ZTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgLy8gMuOAgeenu+mZpOWvueW6lOeahOS/ruaUueWPmOabtFxuICAgIGNvbnN0IGZ1bGxSZW1vdmVQYXRoID0gcGF0aC5jb25jYXQoYCR7cHJpbWFyeUtleX06JHtwcmltYXJ5S2V5VmFsdWV9YCk7XG4gICAgdGhpcy5tb2RpZmljYXRpb25zID0gdGhpcy5tb2RpZmljYXRpb25zLmZpbHRlcigodmFsdWVNb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbikgPT4ge1xuICAgICAgaWYgKHZhbHVlTW9kaWZpY2F0aW9uLnR5cGUgIT09IE1vZGlmeVR5cGUuVmFsdWVDaGFuZ2UpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgICBjb25zdCB2YWx1ZUNoYW5nZVBhdGggPSBBcnJheS5mcm9tKHZhbHVlTW9kaWZpY2F0aW9uLnBhdGgpO1xuICAgICAgdmFsdWVDaGFuZ2VQYXRoLnBvcCgpO1xuXG4gICAgICAvLyDot6/lvoTnm7jlkIzov5vooYznp7vpmaRcbiAgICAgIGNvbnN0IGlzVG9SZW1vdmUgPSBpc0VxdWFsKHZhbHVlQ2hhbmdlUGF0aCwgZnVsbFJlbW92ZVBhdGgpO1xuICAgICAgcmV0dXJuICFpc1RvUmVtb3ZlO1xuICAgIH0pO1xuXG4gICAgLy8g5YWI5Yig6Zmk5LiL57qn5Yig6Zmk5Y+Y5pu077yM5YaN5o+S5YWlXG4gICAgLy8g5Li76KaB6ZKI5a+55LuO5LuO6KGo5Yig6Zmk5LmL5ZCO77yM5Y+I5Yig6Zmk5a2Q6KGo5pe277yM5qC55a6e5L2T5LiK6L+Y5a2Y5Zyo5LuO5LuO6KGo5Yig6Zmk5Y+Y5pu055qE5Zy65pmvXG4gICAgdGhpcy5yZW1vdmVEZXNjZW5kYW50UmVtb3ZlTW9kaWZpY2F0aW9ucyhtb2RpZmljYXRpb24pO1xuICAgIHRoaXMubW9kaWZpY2F0aW9ucy5wdXNoKG1vZGlmaWNhdGlvbik7XG4gIH1cblxuICAvKipcbiAgICog5riF56m65Y+Y5pu06ZuG5ZCIXG4gICAqL1xuICBwdWJsaWMgY2xlYXIoKSB7XG4gICAgdGhpcy5tb2RpZmljYXRpb25zID0gW107XG4gIH1cblxuXG4gIC8qKlxuICAgKiDmoLnmja5wYXRo6I635Y+WQWRk57G75Z6L55qE5Y+Y5pu06K6w5b2VXG4gICAqIEBwYXJhbSBwYXRoIOWPmOabtOi3r+W+hFxuICAgKi9cbiAgcHJpdmF0ZSBmaW5kTmV3QWRkSXRlbXNQYXRoKHBhdGg6IGFueVtdKSB7XG4gICAgcmV0dXJuIHRoaXMubW9kaWZpY2F0aW9ucy5maW5kKCh2YWx1ZSwgaW5kZXgpID0+IHtcbiAgICAgIHJldHVybiBpc0VxdWFsKHBhdGgsIHZhbHVlLnBhdGgpICYmICh2YWx1ZS50eXBlID09PSBNb2RpZnlUeXBlLkFkZCB8fCB2YWx1ZS50eXBlID09PSBNb2RpZnlUeXBlLkluc2VydCB8fCB2YWx1ZS50eXBlID09PSBNb2RpZnlUeXBlLkNsb25lKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmoLnmja5wYXRo6I635Y+WVmFsdWVDaGFuZ2XnsbvlnovnmoTlj5jmm7TorrDlvZVcbiAgICogQHBhcmFtIHBhdGgg5Y+Y5pu06Lev5b6EXG4gICAqL1xuICBwcml2YXRlIGZpbmRNb2RpZnlJdGVtc1BhdGgocGF0aDogYW55W10pIHtcbiAgICByZXR1cm4gdGhpcy5tb2RpZmljYXRpb25zLmZpbmQoKHZhbHVlLCBpbmRleCkgPT4ge1xuICAgICAgcmV0dXJuIGlzRXF1YWwocGF0aCwgdmFsdWUucGF0aCkgJiYgdmFsdWUudHlwZSA9PT0gTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDliKDpmaTlkI7ku6PvvIjljIXmi6zoh6rlt7HvvInmiYDmnInnmoTliKDpmaTlj5jmm7RcbiAgICogQHRvZG/vvJrkuLTml7blgZrkuIDkuKrmnIDlsI/ljJbkv67mlLlcbiAgICovXG4gIHByaXZhdGUgcmVtb3ZlRGVzY2VuZGFudFJlbW92ZU1vZGlmaWNhdGlvbnMocGFyZW50UmVtb3ZlTW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pOiB2b2lkIHtcblxuICAgIGNvbnN0IHBhcmVudFBhdGhXaXRoSWQgPSB0aGlzLmNyZWF0ZVJlbW92ZVBhdGhXaXRoSWQocGFyZW50UmVtb3ZlTW9kaWZpY2F0aW9uKTtcblxuICAgIC8vIOWIoOmZpOWQjuS7o+S/ruaUueWPmOabtFxuICAgIHRoaXMubW9kaWZpY2F0aW9ucyA9IHRoaXMubW9kaWZpY2F0aW9ucy5maWx0ZXIoKG1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSA9PiB7XG4gICAgICBpZiAobW9kaWZpY2F0aW9uLnR5cGUgIT09IE1vZGlmeVR5cGUuUmVtb3ZlKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgY29uc3QgZGVzY2VuZGFudFBhdGhXaXRoSWQgPSB0aGlzLmNyZWF0ZVJlbW92ZVBhdGhXaXRoSWQobW9kaWZpY2F0aW9uKTtcbiAgICAgIGNvbnN0IGlzRGVzY2VuZGFudCA9ICB0aGlzLmlzRGVzY2VuZGFudFBhdGgocGFyZW50UGF0aFdpdGhJZCwgZGVzY2VuZGFudFBhdGhXaXRoSWQpO1xuICAgICAgcmV0dXJuICFpc0Rlc2NlbmRhbnQ7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICog6I635Y+W5Yig6Zmk6Lev5b6E55qE5a6M5pW05qC85byPXG4gICAqIEBzdW1tYXJ5XG4gICAqIDHjgIHnm67liY3liKDpmaTlj5jmm7TnmoTot6/lvoTmoIforrDliLDniLbpm4blkIjvvJtcbiAgICogMuOAgeS4uuS6huaWueS+v+avlOi+g++8jOWwhuiiq+WIoOmZpOeahOaVsOaNrmlk5Yqg5YWl5Yiw6Lev5b6E5LitXG4gICAqL1xuICBwcml2YXRlIGNyZWF0ZVJlbW92ZVBhdGhXaXRoSWQobW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pIHtcbiAgICBjb25zdCBwYXRoID0gbW9kaWZpY2F0aW9uLnBhdGg7XG4gICAgY29uc3QgcHJpbWFyeUtleSA9IE9iamVjdC5rZXlzKG1vZGlmaWNhdGlvbi52YWx1ZSlbMF07XG4gICAgY29uc3QgcHJpbWFyeUtleVZhbHVlID0gbW9kaWZpY2F0aW9uLnZhbHVlW3ByaW1hcnlLZXldO1xuICAgIGNvbnN0IHBhdGhXaXRoSWQgPSBwYXRoLmNvbmNhdChbYCR7cHJpbWFyeUtleX06JHtwcmltYXJ5S2V5VmFsdWV9YF0pO1xuICAgIHJldHVybiBwYXRoV2l0aElkO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIpOaWreaYr+WQpuaYr+WQjuS7o+iKgueCuei3r+W+hFxuICAgKiBAcGFyYW0gcGFyZW50UGF0aCDniLboioLngrnot6/lvoRcbiAgICogQHBhcmFtIGRlc2NlbmRhbnRQYXRoIOWQjuS7o+iKgueCuVxuICAgKi9cbiAgcHJpdmF0ZSBpc0Rlc2NlbmRhbnRQYXRoKHBhcmVudFBhdGg6IHN0cmluZ1tdLCBkZXNjZW5kYW50UGF0aDogc3RyaW5nW10pIHtcbiAgICBpZiAocGFyZW50UGF0aC5sZW5ndGggPiBkZXNjZW5kYW50UGF0aC5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBsZXQgaXNEZXNjZW5kYW50UGF0aCA9IHRydWU7XG4gICAgcGFyZW50UGF0aC5mb3JFYWNoKChwYXJlbnRQYXRoSXRlbTogc3RyaW5nLCBwYXJlbnRQYXRoSXRlbUluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgIGlmIChwYXJlbnRQYXRoSXRlbSAhPT0gZGVzY2VuZGFudFBhdGhbcGFyZW50UGF0aEl0ZW1JbmRleF0pIHtcbiAgICAgICAgaXNEZXNjZW5kYW50UGF0aCA9IGZhbHNlO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gaXNEZXNjZW5kYW50UGF0aDtcbiAgfVxuXG59XG5cbmV4cG9ydCB7IENoYW5nZVNldCB9O1xuXG4iXX0=