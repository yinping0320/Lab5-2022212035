import { Subject, BehaviorSubject } from 'rxjs';
import { concatMap, map, takeLast, take, throwIfEmpty } from 'rxjs/operators';
import { createInjectionToken } from '../core/index';
import { VariableParseService } from '../variable/index';
import { CommandContext } from './command_context';
import { TaskFlow } from './flow/index';
/**
 * 命令处理抽象类，所有具体的命令处理类必须继承它，并实现schedule方法。
 */
class CommandHandler {
    /**
     * 构造函数
     */
    constructor() {
    }
    /**
     * 初始化
     */
    init(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.parseService = viewModelContext.injector.get(VariableParseService);
        this.taskFlow = new TaskFlow();
        this.schedule();
    }
    /**
     * 执行任务
     * @param command 要执行的命令
     * @return 最后一个任务的执行结果
     * @todo：按功能拆分小函数
     */
    execute(command) {
        const lastTaskResult$ = new Subject();
        const taskFlow = this.taskFlow.clone();
        // setTimeout暂时不能去掉的原因：
        // 1、树表单加载数据，依赖TreeTableBinding里设置的全局变量，需要延后执行加载时机；
        // 2、关闭前命令需要延迟执行。
        setTimeout(() => {
            // 1、解析参数
            // 避免解析变量时修改了原始的command
            const { eventParam = null } = Object.assign({}, command);
            delete command.eventParam;
            const commandToExecute = JSON.parse(JSON.stringify(command));
            commandToExecute.params = this.parseService.parse(commandToExecute.params, this.viewModelContext);
            command.eventParam = eventParam;
            commandToExecute.eventParam = eventParam;
            // 2、串联任务流
            const initContext = new CommandContext(commandToExecute, this.viewModelContext);
            initContext.eventParams = command.eventParam || null;
            const context$ = new BehaviorSubject(initContext);
            let currentTask = taskFlow.getNext('', initContext);
            const highOrder$ = context$.pipe(concatMap((context) => {
                const result$ = currentTask.execute(context);
                return result$.pipe(take(1), map((result) => {
                    // 写入执行结果
                    context.results[currentTask.name] = result;
                    context.latestResult = result;
                    currentTask = taskFlow.getNext(currentTask.name, context);
                    // 操作控制流
                    if (currentTask) {
                        context$.next(context);
                    }
                    else {
                        context$.complete();
                    }
                    // 将结果流转换为context流
                    return context;
                }), throwIfEmpty(() => {
                    context$.complete();
                }));
            }));
            // 3、执行合并后的任务流
            highOrder$.pipe(takeLast(1)).subscribe({
                next: (context) => {
                    lastTaskResult$.next(context.latestResult);
                },
                error: (error) => {
                    this.displayError(error);
                    lastTaskResult$.error(error);
                },
                complete: () => {
                    lastTaskResult$.complete();
                },
            });
        }, 0);
        return lastTaskResult$;
    }
    /**
     * 显示错误信息
     */
    displayError(error) {
        if (!console || !console.error) {
            return;
        }
        if (!error) {
            error = 'unknown error';
        }
        console.error(error);
    }
    /**
     * 添加任务，只有子类可以添加任务，外部不能访问
     * @param name  任务名称
     * @param func 任务函数
     */
    addTask(name, func) {
        this.taskFlow.addNode(name, func);
    }
    /**
     * 添加任务，只有子类可以添加任务，外部不能访问
     * @param name  任务名称
     * @param func 任务函数
     */
    addLink(from, to, condition) {
        this.taskFlow.addLink(from, to, condition);
    }
    /**
     * 插入任务
     * @param  name 要扩展的任务名称
     * @param  func 扩展函数
     */
    insertTask(target, name, func) {
        throw new Error('Not Implemented');
    }
    /**
     * 插入任务
     * @param  name 要扩展的任务名称
     * @param  func 扩展函数
     */
    afterTask(target, name, func) {
        throw new Error('Not Implemented');
    }
    /**
     * 替换任务
     * @param  name 要替换的任务名称
     * @param  func 替换函数
     */
    replaceTask(name, func) {
        throw new Error('Not Implement');
    }
    /**
     * 调用方法
     */
    invoke(serviceInstance, method, args, context) {
        this.setContextToServiceInstance(serviceInstance, context);
        const parsedArgs = this.parseService.parse(args, context);
        return serviceInstance[method](...parsedArgs);
    }
    /**
     * 为服务设置命令上下文
     * @todo
     * 通过这种方式存在很大问题：
     * 1、会覆盖掉已有的context，给开发人员造成困扰和调试成本；
     * 2、服务中依赖了一个没有声明的对象，不符合面向对象的原则。
     * 建议解决方案：
     * 1、将context修改为某个特殊属性名；
     * 2、先检测服务上有没有一个CommandContext类型的context属性，有的话再赋值，
     *    这就要求需要使用context的服务需要是实现一个IContext接口。
     */
    setContextToServiceInstance(serviceInstance, context) {
        // 如果服务上已经存在context属性，并且该属性不是CommandContext类型，则不能覆盖
        const serviceContext = serviceInstance.context;
        if (serviceContext && (serviceContext instanceof CommandContext === false)) {
            return;
        }
        serviceInstance.context = context;
    }
}
/**
 * 命令处理器注入Token
 */
const COMMAND_HANDLERS_TOKEN = createInjectionToken('@Farris/devkit COMMAND_HANDLERS_TOKEN');
export { CommandHandler, COMMAND_HANDLERS_TOKEN };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZF9oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2NvbW1hbmQvY29tbWFuZF9oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBYyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVELE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQVcsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFdkYsT0FBTyxFQUFFLG9CQUFvQixFQUFZLE1BQU0sZUFBZSxDQUFDO0FBRS9ELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBR3pELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQVksUUFBUSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBR2xEOztHQUVHO0FBQ0gsTUFBZSxjQUFjO0lBaUIzQjs7T0FFRztJQUNIO0lBQ0EsQ0FBQztJQU9EOztPQUVHO0lBQ0ksSUFBSSxDQUFDLGdCQUFrQztRQUM1QyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUM7UUFDekMsSUFBSSxDQUFDLFlBQVksR0FBRyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDeEUsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLFFBQVEsRUFBRSxDQUFDO1FBRS9CLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNsQixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSSxPQUFPLENBQUMsT0FBZ0I7UUFDN0IsTUFBTSxlQUFlLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUN0QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXZDLHVCQUF1QjtRQUN2Qixt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QzNELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztRQUMxRCxPQUFPLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFRDs7Ozs7Ozs7OztPQVVHO0lBQ0ssMkJBQTJCLENBQUMsZUFBb0IsRUFBRSxPQUF1QjtRQUUvRSxtREFBbUQ7UUFDbkQsTUFBTSxjQUFjLEdBQUcsZUFBZSxDQUFDLE9BQU8sQ0FBQztRQUMvQyxJQUFJLGNBQWMsSUFBSSxDQUFDLGNBQWMsWUFBWSxjQUFjLEtBQUssS0FBSyxDQUFDLEVBQUU7WUFDMUUsT0FBTztTQUNSO1FBRUQsZUFBZSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7SUFDcEMsQ0FBQztDQUNGO0FBRUQ7O0dBRUc7QUFDSCxNQUFNLHNCQUFzQixHQUFHLG9CQUFvQixDQUFDLHVDQUF1QyxDQUFDLENBQUM7QUFFN0YsT0FBTyxFQUFFLGNBQWMsRUFBRSxzQkFBc0IsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCwgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjb25jYXRNYXAsIG1hcCwgdGFrZUxhc3QsIHRha2UsIHRpbWVvdXQsIHRocm93SWZFbXB0eSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgY3JlYXRlSW5qZWN0aW9uVG9rZW4sIEluamVjdG9yIH0gZnJvbSAnLi4vY29yZS9pbmRleCc7XG5pbXBvcnQgeyBWaWV3TW9kZWxDb250ZXh0IH0gZnJvbSAnLi4vdmlldy1tb2RlbC9pbmRleCc7XG5pbXBvcnQgeyBWYXJpYWJsZVBhcnNlU2VydmljZSB9IGZyb20gJy4uL3ZhcmlhYmxlL2luZGV4JztcblxuaW1wb3J0IHsgQ29tbWFuZCwgQ29tbWFuZFBhcmFtcywgUGFyYW1EZXNjcmlwdGlvbnMgfSBmcm9tICcuL2NvbW1hbmQnO1xuaW1wb3J0IHsgQ29tbWFuZENvbnRleHQgfSBmcm9tICcuL2NvbW1hbmRfY29udGV4dCc7XG5pbXBvcnQgeyBUYXNrRnVuYywgVGFza0Zsb3cgfSBmcm9tICcuL2Zsb3cvaW5kZXgnO1xuXG5cbi8qKlxuICog5ZG95Luk5aSE55CG5oq96LGh57G777yM5omA5pyJ5YW35L2T55qE5ZG95Luk5aSE55CG57G75b+F6aG757un5om/5a6D77yM5bm25a6e546wc2NoZWR1bGXmlrnms5XjgIJcbiAqL1xuYWJzdHJhY3QgY2xhc3MgQ29tbWFuZEhhbmRsZXIge1xuXG4gIC8qKlxuICAgKiDku7vliqHmtYHnqIvlm75cbiAgICovXG4gIHByaXZhdGUgdGFza0Zsb3c6IFRhc2tGbG93O1xuXG4gIC8qKlxuICAgKiDkuIrkuIvmlodcbiAgICovXG4gIHByb3RlY3RlZCB2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0O1xuXG4gIC8qKlxuICAgKiDlj5jph4/op6PmnpDmnI3liqFcbiAgICovXG4gIHByb3RlY3RlZCBwYXJzZVNlcnZpY2U6IFZhcmlhYmxlUGFyc2VTZXJ2aWNlO1xuXG4gIC8qKlxuICAgKiDmnoTpgKDlh73mlbBcbiAgICovXG4gIGNvbnN0cnVjdG9yKCkge1xuICB9XG5cbiAgLyoqXG4gICAqIOaehOmAoOaJp+ihjOa1geeoi1xuICAgKi9cbiAgYWJzdHJhY3Qgc2NoZWR1bGUoKTtcblxuICAvKipcbiAgICog5Yid5aeL5YyWXG4gICAqL1xuICBwdWJsaWMgaW5pdCh2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0KSB7XG4gICAgdGhpcy52aWV3TW9kZWxDb250ZXh0ID0gdmlld01vZGVsQ29udGV4dDtcbiAgICB0aGlzLnBhcnNlU2VydmljZSA9IHZpZXdNb2RlbENvbnRleHQuaW5qZWN0b3IuZ2V0KFZhcmlhYmxlUGFyc2VTZXJ2aWNlKTtcbiAgICB0aGlzLnRhc2tGbG93ID0gbmV3IFRhc2tGbG93KCk7XG5cbiAgICB0aGlzLnNjaGVkdWxlKCk7XG4gIH1cblxuICAvKipcbiAgICog5omn6KGM5Lu75YqhXG4gICAqIEBwYXJhbSBjb21tYW5kIOimgeaJp+ihjOeahOWRveS7pFxuICAgKiBAcmV0dXJuIOacgOWQjuS4gOS4quS7u+WKoeeahOaJp+ihjOe7k+aenFxuICAgKiBAdG9kb++8muaMieWKn+iDveaLhuWIhuWwj+WHveaVsFxuICAgKi9cbiAgcHVibGljIGV4ZWN1dGUoY29tbWFuZDogQ29tbWFuZCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgbGFzdFRhc2tSZXN1bHQkID0gbmV3IFN1YmplY3QoKTtcbiAgICBjb25zdCB0YXNrRmxvdyA9IHRoaXMudGFza0Zsb3cuY2xvbmUoKTtcblxuICAgIC8vIHNldFRpbWVvdXTmmoLml7bkuI3og73ljrvmjonnmoTljp/lm6DvvJpcbiAgICAvLyAx44CB5qCR6KGo5Y2V5Yqg6L295pWw5o2u77yM5L6d6LWWVHJlZVRhYmxlQmluZGluZ+mHjOiuvue9rueahOWFqOWxgOWPmOmHj++8jOmcgOimgeW7tuWQjuaJp+ihjOWKoOi9veaXtuacuu+8m1xuICAgIC8vIDLjgIHlhbPpl63liY3lkb3ku6TpnIDopoHlu7bov5/miafooYzjgIJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcblxuICAgICAgLy8gMeOAgeino+aekOWPguaVsFxuICAgICAgLy8g6YG/5YWN6Kej5p6Q5Y+Y6YeP5pe25L+u5pS55LqG5Y6f5aeL55qEY29tbWFuZFxuICAgICAgY29uc3QgeyBldmVudFBhcmFtID0gbnVsbCB9ID0ge1xuICAgICAgICAuLi5jb21tYW5kXG4gICAgICB9O1xuICAgICAgZGVsZXRlIGNvbW1hbmQuZXZlbnRQYXJhbTtcbiAgICAgIGNvbnN0IGNvbW1hbmRUb0V4ZWN1dGUgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGNvbW1hbmQpKTtcbiAgICAgIGNvbW1hbmRUb0V4ZWN1dGUucGFyYW1zID0gdGhpcy5wYXJzZVNlcnZpY2UucGFyc2UoY29tbWFuZFRvRXhlY3V0ZS5wYXJhbXMsIHRoaXMudmlld01vZGVsQ29udGV4dCk7XG4gICAgICBjb21tYW5kLmV2ZW50UGFyYW0gPSBldmVudFBhcmFtO1xuICAgICAgY29tbWFuZFRvRXhlY3V0ZS5ldmVudFBhcmFtID0gZXZlbnRQYXJhbTtcblxuICAgICAgLy8gMuOAgeS4suiBlOS7u+WKoea1gVxuICAgICAgY29uc3QgaW5pdENvbnRleHQgPSBuZXcgQ29tbWFuZENvbnRleHQoY29tbWFuZFRvRXhlY3V0ZSwgdGhpcy52aWV3TW9kZWxDb250ZXh0KTtcbiAgICAgIGluaXRDb250ZXh0LmV2ZW50UGFyYW1zID0gY29tbWFuZC5ldmVudFBhcmFtIHx8IG51bGw7XG4gICAgICBjb25zdCBjb250ZXh0JCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Q29tbWFuZENvbnRleHQ+KGluaXRDb250ZXh0KTtcbiAgICAgIGxldCBjdXJyZW50VGFzayA9IHRhc2tGbG93LmdldE5leHQoJycsIGluaXRDb250ZXh0KTtcbiAgICAgIGNvbnN0IGhpZ2hPcmRlciQgPSBjb250ZXh0JC5waXBlKFxuICAgICAgICBjb25jYXRNYXAoKGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSA9PiB7XG4gICAgICAgICAgY29uc3QgcmVzdWx0JCA9IGN1cnJlbnRUYXNrLmV4ZWN1dGUoY29udGV4dCk7XG4gICAgICAgICAgcmV0dXJuIHJlc3VsdCQucGlwZShcbiAgICAgICAgICAgIHRha2UoMSksXG4gICAgICAgICAgICBtYXAoKHJlc3VsdDogYW55KSA9PiB7XG5cbiAgICAgICAgICAgICAgLy8g5YaZ5YWl5omn6KGM57uT5p6cXG4gICAgICAgICAgICAgIGNvbnRleHQucmVzdWx0c1tjdXJyZW50VGFzay5uYW1lXSA9IHJlc3VsdDtcbiAgICAgICAgICAgICAgY29udGV4dC5sYXRlc3RSZXN1bHQgPSByZXN1bHQ7XG4gICAgICAgICAgICAgIGN1cnJlbnRUYXNrID0gdGFza0Zsb3cuZ2V0TmV4dChjdXJyZW50VGFzay5uYW1lLCBjb250ZXh0KTtcblxuICAgICAgICAgICAgICAvLyDmk43kvZzmjqfliLbmtYFcbiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrKSB7XG4gICAgICAgICAgICAgICAgY29udGV4dCQubmV4dChjb250ZXh0KTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb250ZXh0JC5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgLy8g5bCG57uT5p6c5rWB6L2s5o2i5Li6Y29udGV4dOa1gVxuICAgICAgICAgICAgICByZXR1cm4gY29udGV4dDtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgdGhyb3dJZkVtcHR5KCgpID0+IHtcbiAgICAgICAgICAgICAgY29udGV4dCQuY29tcGxldGUoKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKTtcbiAgICAgICAgfSlcbiAgICAgICk7XG5cbiAgICAgIC8vIDPjgIHmiafooYzlkIjlubblkI7nmoTku7vliqHmtYFcbiAgICAgIGhpZ2hPcmRlciQucGlwZShcbiAgICAgICAgdGFrZUxhc3QoMSlcbiAgICAgICkuc3Vic2NyaWJlKHtcbiAgICAgICAgbmV4dDogKGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSA9PiB7XG4gICAgICAgICAgbGFzdFRhc2tSZXN1bHQkLm5leHQoY29udGV4dC5sYXRlc3RSZXN1bHQpO1xuICAgICAgICB9LFxuICAgICAgICBlcnJvcjogKGVycm9yOiBhbnkpID0+IHtcbiAgICAgICAgICB0aGlzLmRpc3BsYXlFcnJvcihlcnJvcik7XG4gICAgICAgICAgbGFzdFRhc2tSZXN1bHQkLmVycm9yKGVycm9yKTtcbiAgICAgICAgfSxcbiAgICAgICAgY29tcGxldGU6ICgpID0+IHtcbiAgICAgICAgICBsYXN0VGFza1Jlc3VsdCQuY29tcGxldGUoKTtcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgfSwgMCk7XG5cbiAgICByZXR1cm4gbGFzdFRhc2tSZXN1bHQkO1xuICB9XG5cbiAgLyoqXG4gICAqIOaYvuekuumUmeivr+S/oeaBr1xuICAgKi9cbiAgcHJpdmF0ZSBkaXNwbGF5RXJyb3IoZXJyb3I6IGFueSkge1xuICAgIGlmICghY29uc29sZSB8fCAhY29uc29sZS5lcnJvcikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIWVycm9yKSB7XG4gICAgICBlcnJvciA9ICd1bmtub3duIGVycm9yJztcbiAgICB9XG4gICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gIH1cblxuICAvKipcbiAgICog5re75Yqg5Lu75Yqh77yM5Y+q5pyJ5a2Q57G75Y+v5Lul5re75Yqg5Lu75Yqh77yM5aSW6YOo5LiN6IO96K6/6ZeuXG4gICAqIEBwYXJhbSBuYW1lICDku7vliqHlkI3np7BcbiAgICogQHBhcmFtIGZ1bmMg5Lu75Yqh5Ye95pWwXG4gICAqL1xuICBwcm90ZWN0ZWQgYWRkVGFzayhuYW1lOiBzdHJpbmcsIGZ1bmM6IFRhc2tGdW5jKSB7XG4gICAgdGhpcy50YXNrRmxvdy5hZGROb2RlKG5hbWUsIGZ1bmMpO1xuICB9XG5cbiAgLyoqXG4gICAqIOa3u+WKoOS7u+WKoe+8jOWPquacieWtkOexu+WPr+S7pea3u+WKoOS7u+WKoe+8jOWklumDqOS4jeiDveiuv+mXrlxuICAgKiBAcGFyYW0gbmFtZSAg5Lu75Yqh5ZCN56ewXG4gICAqIEBwYXJhbSBmdW5jIOS7u+WKoeWHveaVsFxuICAgKi9cbiAgcHJvdGVjdGVkIGFkZExpbmsoZnJvbTogc3RyaW5nLCB0bzogc3RyaW5nLCBjb25kaXRpb246IHN0cmluZyB8IGJvb2xlYW4pIHtcbiAgICB0aGlzLnRhc2tGbG93LmFkZExpbmsoZnJvbSwgdG8sIGNvbmRpdGlvbik7XG4gIH1cblxuICAvKipcbiAgICog5o+S5YWl5Lu75YqhXG4gICAqIEBwYXJhbSAgbmFtZSDopoHmianlsZXnmoTku7vliqHlkI3np7BcbiAgICogQHBhcmFtICBmdW5jIOaJqeWxleWHveaVsFxuICAgKi9cbiAgcHVibGljIGluc2VydFRhc2sodGFyZ2V0OiBzdHJpbmcsIG5hbWU6IHN0cmluZywgZnVuYzogVGFza0Z1bmMpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBJbXBsZW1lbnRlZCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIOaPkuWFpeS7u+WKoVxuICAgKiBAcGFyYW0gIG5hbWUg6KaB5omp5bGV55qE5Lu75Yqh5ZCN56ewXG4gICAqIEBwYXJhbSAgZnVuYyDmianlsZXlh73mlbBcbiAgICovXG4gIHB1YmxpYyBhZnRlclRhc2sodGFyZ2V0OiBzdHJpbmcsIG5hbWU6IHN0cmluZywgZnVuYzogVGFza0Z1bmMpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBJbXBsZW1lbnRlZCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIOabv+aNouS7u+WKoVxuICAgKiBAcGFyYW0gIG5hbWUg6KaB5pu/5o2i55qE5Lu75Yqh5ZCN56ewXG4gICAqIEBwYXJhbSAgZnVuYyDmm7/mjaLlh73mlbBcbiAgICovXG4gIHB1YmxpYyByZXBsYWNlVGFzayhuYW1lOiBzdHJpbmcsIGZ1bmM6IFRhc2tGdW5jKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgSW1wbGVtZW50Jyk7XG4gIH1cblxuICAvKipcbiAgICog6LCD55So5pa55rOVXG4gICAqL1xuICBwdWJsaWMgaW52b2tlKHNlcnZpY2VJbnN0YW5jZTogYW55LCBtZXRob2Q6IHN0cmluZywgYXJnczogYW55W10sIGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSB7XG4gICAgdGhpcy5zZXRDb250ZXh0VG9TZXJ2aWNlSW5zdGFuY2Uoc2VydmljZUluc3RhbmNlLCBjb250ZXh0KTtcbiAgICBjb25zdCBwYXJzZWRBcmdzID0gdGhpcy5wYXJzZVNlcnZpY2UucGFyc2UoYXJncywgY29udGV4dCk7XG4gICAgcmV0dXJuIHNlcnZpY2VJbnN0YW5jZVttZXRob2RdKC4uLnBhcnNlZEFyZ3MpO1xuICB9XG5cbiAgLyoqXG4gICAqIOS4uuacjeWKoeiuvue9ruWRveS7pOS4iuS4i+aWh1xuICAgKiBAdG9kb1xuICAgKiDpgJrov4fov5nnp43mlrnlvI/lrZjlnKjlvojlpKfpl67popjvvJpcbiAgICogMeOAgeS8muimhuebluaOieW3suacieeahGNvbnRleHTvvIznu5nlvIDlj5HkurrlkZjpgKDmiJDlm7DmibDlkozosIPor5XmiJDmnKzvvJtcbiAgICogMuOAgeacjeWKoeS4reS+nei1luS6huS4gOS4quayoeacieWjsOaYjueahOWvueixoe+8jOS4jeespuWQiOmdouWQkeWvueixoeeahOWOn+WImeOAglxuICAgKiDlu7rorq7op6PlhrPmlrnmoYjvvJpcbiAgICogMeOAgeWwhmNvbnRleHTkv67mlLnkuLrmn5DkuKrnibnmrorlsZ7mgKflkI3vvJtcbiAgICogMuOAgeWFiOajgOa1i+acjeWKoeS4iuacieayoeacieS4gOS4qkNvbW1hbmRDb250ZXh057G75Z6L55qEY29udGV4dOWxnuaAp++8jOacieeahOivneWGjei1i+WAvO+8jFxuICAgKiAgICDov5nlsLHopoHmsYLpnIDopoHkvb/nlKhjb250ZXh055qE5pyN5Yqh6ZyA6KaB5piv5a6e546w5LiA5LiqSUNvbnRleHTmjqXlj6PjgIJcbiAgICovXG4gIHByaXZhdGUgc2V0Q29udGV4dFRvU2VydmljZUluc3RhbmNlKHNlcnZpY2VJbnN0YW5jZTogYW55LCBjb250ZXh0OiBDb21tYW5kQ29udGV4dCkge1xuXG4gICAgLy8g5aaC5p6c5pyN5Yqh5LiK5bey57uP5a2Y5ZyoY29udGV4dOWxnuaAp++8jOW5tuS4lOivpeWxnuaAp+S4jeaYr0NvbW1hbmRDb250ZXh057G75Z6L77yM5YiZ5LiN6IO96KaG55uWXG4gICAgY29uc3Qgc2VydmljZUNvbnRleHQgPSBzZXJ2aWNlSW5zdGFuY2UuY29udGV4dDtcbiAgICBpZiAoc2VydmljZUNvbnRleHQgJiYgKHNlcnZpY2VDb250ZXh0IGluc3RhbmNlb2YgQ29tbWFuZENvbnRleHQgPT09IGZhbHNlKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHNlcnZpY2VJbnN0YW5jZS5jb250ZXh0ID0gY29udGV4dDtcbiAgfVxufVxuXG4vKipcbiAqIOWRveS7pOWkhOeQhuWZqOazqOWFpVRva2VuXG4gKi9cbmNvbnN0IENPTU1BTkRfSEFORExFUlNfVE9LRU4gPSBjcmVhdGVJbmplY3Rpb25Ub2tlbignQEZhcnJpcy9kZXZraXQgQ09NTUFORF9IQU5ETEVSU19UT0tFTicpO1xuXG5leHBvcnQgeyBDb21tYW5kSGFuZGxlciwgQ09NTUFORF9IQU5ETEVSU19UT0tFTiB9O1xuIl19