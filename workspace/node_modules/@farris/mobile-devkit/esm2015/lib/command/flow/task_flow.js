/*
 * @Author: Witt
 * @Date: 2018-10-17 14:13:40
 * @Last Modified by: Witt
 * @Last Modified time: 2018-10-17 16:08:34
 */
import { TaskNode } from './task_node';
import { TaskLink } from './task_link';
/**
 * 任务执行流程
 */
class TaskFlow {
    constructor() {
        /**
         * 节点集合
         */
        this.nodes = [];
        /**
         * 边集合
         */
        this.links = [];
        // #endregion
    }
    // #region 节点操作
    /**
     * 添加节点
     */
    addNode(name, func) {
        const node = new TaskNode(name, func);
        this.nodes.push(node);
    }
    /**
     * 批量添加链接
     */
    addNodes(nodes) {
        this.nodes = this.nodes.concat(nodes);
    }
    /**
     * 在目标节点之前插入一个节点
     * @param target 目标节点名称
     * @param name 名称
     * @param func 函数
     */
    insertNode(target, name, func) {
        const index = this.findNodeIndex(target);
        const node = this.createNode(name, func);
        this.nodes.splice(index, 0, node);
    }
    /**
     * 在目标节点之前插入一个节点
     */
    appendNode(target, name, func) {
        const index = this.findNodeIndex(target) + 1;
        const node = this.createNode(name, func);
        this.nodes.splice(index, 0, node);
    }
    /**
     * 获取节点索引
     * @param name 名称
     */
    findNodeIndex(name) {
        return this.nodes.findIndex((node) => {
            return node.name === name;
        });
    }
    /**
     * 创建任务节点
     * @param name 名称
     * @param func 函数
     */
    createNode(name, func) {
        const node = new TaskNode(name, func);
        return node;
    }
    // #endregion
    // #region 链接操作
    /**
     * 添加链接
     * @param name 名称
     * @param func 函数
     */
    addLink(from, to, condition) {
        const link = this.createLink(from, to, condition);
        this.links.push(link);
    }
    /**
     * 批量添加链接
     */
    addLinks(links) {
        this.links = this.links.concat(links);
    }
    /**
     * 创建链接
     */
    createLink(from, to, condition) {
        const link = new TaskLink(from, to, condition);
        return link;
    }
    // #endregion
    // #region 流程控制
    /**
     * 获取下一个节点
     * @param from    源节点名称
     * @param context 上下文
     */
    getNext(from, context) {
        if (!from) {
            return this.nodes.shift();
        }
        // 符合满足条件的边
        const nextLink = this.links.find((link) => {
            return link.from === from && link.canLink(context);
        });
        if (!nextLink) {
            return;
        }
        return this.nodes.find((node) => {
            return node.name === nextLink.to;
        });
    }
    // #endregion
    // #region 其他方法
    /**
     * 克隆任务流
     */
    clone() {
        const taskFlow = new TaskFlow();
        taskFlow.addNodes(this.nodes);
        taskFlow.addLinks(this.links);
        return taskFlow;
    }
}
export { TaskFlow };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFza19mbG93LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2NvbW1hbmQvZmxvdy90YXNrX2Zsb3cudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7O0dBS0c7QUFFSCxPQUFPLEVBQVksUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ2pELE9BQU8sRUFBWSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFHakQ7O0dBRUc7QUFDSCxNQUFNLFFBQVE7SUFBZDtRQUVFOztXQUVHO1FBQ0ssVUFBSyxHQUFlLEVBQUUsQ0FBQztRQUUvQjs7V0FFRztRQUNLLFVBQUssR0FBZSxFQUFFLENBQUM7UUFxSS9CLGFBQWE7SUFDZixDQUFDO0lBbklDLGVBQWU7SUFFZjs7T0FFRztJQUNJLE9BQU8sQ0FBQyxJQUFZLEVBQUUsSUFBYztRQUN6QyxNQUFNLElBQUksR0FBRyxJQUFJLFFBQVEsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDdEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEIsQ0FBQztJQUdEOztPQUVHO0lBQ0ksUUFBUSxDQUFDLEtBQWlCO1FBQy9CLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ksVUFBVSxDQUFDLE1BQWMsRUFBRSxJQUFZLEVBQUUsSUFBYztRQUM1RCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLENB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QUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQEF1dGhvcjogV2l0dFxuICogQERhdGU6IDIwMTgtMTAtMTcgMTQ6MTM6NDBcbiAqIEBMYXN0IE1vZGlmaWVkIGJ5OiBXaXR0XG4gKiBATGFzdCBNb2RpZmllZCB0aW1lOiAyMDE4LTEwLTE3IDE2OjA4OjM0XG4gKi9cblxuaW1wb3J0IHsgVGFza0Z1bmMsIFRhc2tOb2RlIH0gZnJvbSAnLi90YXNrX25vZGUnO1xuaW1wb3J0IHsgTGlua0Z1bmMsIFRhc2tMaW5rIH0gZnJvbSAnLi90YXNrX2xpbmsnO1xuaW1wb3J0IHsgQ29tbWFuZENvbnRleHQgfSBmcm9tICcuLi9jb21tYW5kX2NvbnRleHQnO1xuXG4vKipcbiAqIOS7u+WKoeaJp+ihjOa1geeoi1xuICovXG5jbGFzcyBUYXNrRmxvdyB7XG5cbiAgLyoqXG4gICAqIOiKgueCuembhuWQiFxuICAgKi9cbiAgcHJpdmF0ZSBub2RlczogVGFza05vZGVbXSA9IFtdO1xuXG4gIC8qKlxuICAgKiDovrnpm4blkIhcbiAgICovXG4gIHByaXZhdGUgbGlua3M6IFRhc2tMaW5rW10gPSBbXTtcblxuXG4gIC8vICNyZWdpb24g6IqC54K55pON5L2cXG5cbiAgLyoqXG4gICAqIOa3u+WKoOiKgueCuVxuICAgKi9cbiAgcHVibGljIGFkZE5vZGUobmFtZTogc3RyaW5nLCBmdW5jOiBUYXNrRnVuYyk6IHZvaWQge1xuICAgIGNvbnN0IG5vZGUgPSBuZXcgVGFza05vZGUobmFtZSwgZnVuYyk7XG4gICAgdGhpcy5ub2Rlcy5wdXNoKG5vZGUpO1xuICB9XG5cblxuICAvKipcbiAgICog5om56YeP5re75Yqg6ZO+5o6lXG4gICAqL1xuICBwdWJsaWMgYWRkTm9kZXMobm9kZXM6IFRhc2tOb2RlW10pIHtcbiAgICB0aGlzLm5vZGVzID0gdGhpcy5ub2Rlcy5jb25jYXQobm9kZXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIOWcqOebruagh+iKgueCueS5i+WJjeaPkuWFpeS4gOS4quiKgueCuVxuICAgKiBAcGFyYW0gdGFyZ2V0IOebruagh+iKgueCueWQjeensFxuICAgKiBAcGFyYW0gbmFtZSDlkI3np7BcbiAgICogQHBhcmFtIGZ1bmMg5Ye95pWwXG4gICAqL1xuICBwdWJsaWMgaW5zZXJ0Tm9kZSh0YXJnZXQ6IHN0cmluZywgbmFtZTogc3RyaW5nLCBmdW5jOiBUYXNrRnVuYyk6IHZvaWQge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5maW5kTm9kZUluZGV4KHRhcmdldCk7XG4gICAgY29uc3Qgbm9kZSA9IHRoaXMuY3JlYXRlTm9kZShuYW1lLCBmdW5jKTtcbiAgICB0aGlzLm5vZGVzLnNwbGljZShpbmRleCwgMCwgbm9kZSk7XG4gIH1cblxuICAvKipcbiAgICog5Zyo55uu5qCH6IqC54K55LmL5YmN5o+S5YWl5LiA5Liq6IqC54K5XG4gICAqL1xuICBwdWJsaWMgYXBwZW5kTm9kZSh0YXJnZXQ6IHN0cmluZywgbmFtZTogc3RyaW5nLCBmdW5jOiBUYXNrRnVuYykge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5maW5kTm9kZUluZGV4KHRhcmdldCkgKyAxO1xuICAgIGNvbnN0IG5vZGUgPSB0aGlzLmNyZWF0ZU5vZGUobmFtZSwgZnVuYyk7XG4gICAgdGhpcy5ub2Rlcy5zcGxpY2UoaW5kZXgsIDAsIG5vZGUpO1xuICB9XG5cbiAgLyoqXG4gICAqIOiOt+WPluiKgueCuee0ouW8lVxuICAgKiBAcGFyYW0gbmFtZSDlkI3np7BcbiAgICovXG4gIHByaXZhdGUgZmluZE5vZGVJbmRleChuYW1lOiBzdHJpbmcpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLm5vZGVzLmZpbmRJbmRleCgobm9kZTogVGFza05vZGUpID0+IHtcbiAgICAgIHJldHVybiBub2RlLm5hbWUgPT09IG5hbWU7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICog5Yib5bu65Lu75Yqh6IqC54K5XG4gICAqIEBwYXJhbSBuYW1lIOWQjeensFxuICAgKiBAcGFyYW0gZnVuYyDlh73mlbBcbiAgICovXG4gIHByaXZhdGUgY3JlYXRlTm9kZShuYW1lOiBzdHJpbmcsIGZ1bmM6IFRhc2tGdW5jKTogVGFza05vZGUge1xuICAgIGNvbnN0IG5vZGUgPSBuZXcgVGFza05vZGUobmFtZSwgZnVuYyk7XG4gICAgcmV0dXJuIG5vZGU7XG4gIH1cblxuICAvLyAjZW5kcmVnaW9uXG5cblxuICAvLyAjcmVnaW9uIOmTvuaOpeaTjeS9nFxuXG4gIC8qKlxuICAgKiDmt7vliqDpk77mjqVcbiAgICogQHBhcmFtIG5hbWUg5ZCN56ewXG4gICAqIEBwYXJhbSBmdW5jIOWHveaVsFxuICAgKi9cbiAgcHVibGljIGFkZExpbmsoZnJvbTogc3RyaW5nLCB0bzogc3RyaW5nLCBjb25kaXRpb246IHN0cmluZyB8IGJvb2xlYW4pIHtcbiAgICBjb25zdCBsaW5rID0gdGhpcy5jcmVhdGVMaW5rKGZyb20sIHRvLCBjb25kaXRpb24pO1xuICAgIHRoaXMubGlua3MucHVzaChsaW5rKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmibnph4/mt7vliqDpk77mjqVcbiAgICovXG4gIHB1YmxpYyBhZGRMaW5rcyhsaW5rczogVGFza0xpbmtbXSkge1xuICAgIHRoaXMubGlua3MgPSB0aGlzLmxpbmtzLmNvbmNhdChsaW5rcyk7XG4gIH1cblxuICAvKipcbiAgICog5Yib5bu66ZO+5o6lXG4gICAqL1xuICBwcml2YXRlIGNyZWF0ZUxpbmsoZnJvbTogc3RyaW5nLCB0bzogc3RyaW5nLCBjb25kaXRpb246IHN0cmluZyB8IGJvb2xlYW4pIHtcbiAgICBjb25zdCBsaW5rID0gbmV3IFRhc2tMaW5rKGZyb20sIHRvLCBjb25kaXRpb24pO1xuICAgIHJldHVybiBsaW5rO1xuICB9XG5cbiAgLy8gI2VuZHJlZ2lvblxuXG5cbiAgLy8gI3JlZ2lvbiDmtYHnqIvmjqfliLZcbiAgLyoqXG4gICAqIOiOt+WPluS4i+S4gOS4quiKgueCuVxuICAgKiBAcGFyYW0gZnJvbSAgICDmupDoioLngrnlkI3np7BcbiAgICogQHBhcmFtIGNvbnRleHQg5LiK5LiL5paHXG4gICAqL1xuICBnZXROZXh0KGZyb20/OiBzdHJpbmcsIGNvbnRleHQ/OiBDb21tYW5kQ29udGV4dCk6IFRhc2tOb2RlIHtcbiAgICBpZiAoIWZyb20pIHtcbiAgICAgIHJldHVybiB0aGlzLm5vZGVzLnNoaWZ0KCk7XG4gICAgfVxuXG4gICAgLy8g56ym5ZCI5ruh6Laz5p2h5Lu255qE6L65XG4gICAgY29uc3QgbmV4dExpbmsgPSB0aGlzLmxpbmtzLmZpbmQoKGxpbms6IFRhc2tMaW5rKSA9PiB7XG4gICAgICByZXR1cm4gbGluay5mcm9tID09PSBmcm9tICYmIGxpbmsuY2FuTGluayhjb250ZXh0KTtcbiAgICB9KTtcbiAgICBpZiAoIW5leHRMaW5rKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMubm9kZXMuZmluZCgobm9kZTogVGFza05vZGUpID0+IHtcbiAgICAgIHJldHVybiBub2RlLm5hbWUgPT09IG5leHRMaW5rLnRvO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gI2VuZHJlZ2lvblxuXG4gIC8vICNyZWdpb24g5YW25LuW5pa55rOVXG5cbiAgLyoqXG4gICAqIOWFi+mahuS7u+WKoea1gVxuICAgKi9cbiAgY2xvbmUoKSB7XG4gICAgY29uc3QgdGFza0Zsb3cgPSBuZXcgVGFza0Zsb3coKTtcbiAgICB0YXNrRmxvdy5hZGROb2Rlcyh0aGlzLm5vZGVzKTtcbiAgICB0YXNrRmxvdy5hZGRMaW5rcyh0aGlzLmxpbmtzKTtcbiAgICByZXR1cm4gdGFza0Zsb3c7XG4gIH1cblxuICAvLyAjZW5kcmVnaW9uXG59XG5cbmV4cG9ydCB7IFRhc2tGbG93IH07XG4iXX0=