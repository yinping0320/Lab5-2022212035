import { Subject } from 'rxjs';
import { ChangeSet } from '../changeset/change_set';
import { ModifyType } from '../changeset/types';
import { Entity } from './entity';
import { EntityFactory } from './entity_creator';
import { PARENT_CLASS, PARENT_PATH } from './types';
/**
 * 实体集合列表
 */
export class EntityList {
    // #endregion
    /**
     * @param data JSON数据集合
     * @param type 集合中的实体类型
     */
    constructor(data, type) {
        this.__type__ = 'EntityList';
        // #region 私有属性
        this.originalData = [];
        /**
         * 已废弃：请勿使用
         */
        this.listChanged = new Subject();
        /**
         * 已废弃：请勿使用
         */
        this.changeSet = new ChangeSet();
        // #endregion
        // #region 公有属性
        /**
         * 集合改变时触发(新增、行记录修改、删除)
         * @event
         */
        this.onListChanged = this.listChanged.asObservable();
        this.clear();
        if (data) {
            // this.loadEntities(data);
            data.forEach(item => {
                this.initEntity(EntityFactory(type, item));
            });
        }
    }
    /**
     * 获取项集合
     */
    get items() {
        return this.rawData;
    }
    /**
     * 列表变更集
     */
    get changes() {
        return this.changeSet.changes;
    }
    /**
     * 迭代器
     */
    *[Symbol.iterator]() {
        yield* this.items;
    }
    // #region 公有方法
    /** 加载实体列表 */
    loadEntities(entities) {
        this.clear();
        entities.forEach(entity => {
            this.initEntity(entity);
        });
        // 发送Load变更
        const changeItem = {
            path: [],
            value: entities,
            preValue: undefined,
            type: ModifyType.Load,
            target: this
        };
        this.setChanges(changeItem);
    }
    /**
     * 清空
     */
    clear() {
        this.rawData = [];
        this.originalData = [];
    }
    /**
     * 添加实体对象到集合中，并返回新加的对象
     * @param entity 实体对象
     * @param isCloned 克隆
     */
    appendNew(entity, isCloned = false) {
        const newEntity = this.initEntity(entity, true);
        // 新增变更
        const changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Add
        };
        if (isCloned === true) {
            changeItem.type = ModifyType.Clone;
        }
        this.setChanges(changeItem);
        return newEntity;
    }
    /**
     * 在指定位置插入实体
     * @param entity 实体
     * @param position 插入位置
     */
    insert(entity, position) {
        const newEntity = this.initEntity(entity, true);
        // 新增变更
        const changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Insert,
            position: position,
        };
        this.setChanges(changeItem);
        return newEntity;
    }
    /**
     * 追加实体
     */
    appendEntity(entity) {
        const newEntity = this.initEntity(entity);
        // 新增变更
        const changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Add
        };
        this.setChanges(changeItem);
    }
    /**
     * 批量追加实体
     */
    appendEntities(entities) {
        const newEntites = entities.map((entity) => {
            return this.initEntity(entity);
        });
        const changeItem = {
            path: [],
            value: newEntites,
            preValue: undefined,
            type: ModifyType.Add
        };
        this.setChanges(changeItem);
    }
    /**
     * 删除指定主键ID 的实体对象，返回布尔，true 删除成功，false 删除失败
     * @param primaryId 主键ID
     */
    remove(primaryId) {
        const total = this.count();
        const indexToRemove = this.rawData.findIndex((entity) => {
            return entity.primaryValue === primaryId;
        });
        if (indexToRemove === -1) {
            return false;
        }
        const entityToRemove = this.rawData[indexToRemove];
        this.rawData.splice(indexToRemove, 1);
        // 删除变更
        const changeItem = {
            path: [],
            value: { [entityToRemove.primaryProperty.dataField]: primaryId },
            preValue: undefined,
            type: ModifyType.Remove
        };
        this.updateIndex(total);
        this.setChanges(changeItem);
        return true;
    }
    /**
     * 从集合中获取指定ID值的实体对象
     * @param id 主键值
     */
    get(id) {
        return this.items.find(item => {
            return item.primaryValue === id;
        });
    }
    /**
     * 将变更记录添加到集合变更集中
     * @param value 变更记录
     */
    setChanges(modinfo) {
        // 向app层发送的变更
        this.listChanged.next(modinfo);
        // 构造向changeSet中添加的chagne
        const change = Object.assign({}, modinfo);
        if ((modinfo.type === ModifyType.Add || modinfo.type === ModifyType.Insert || modinfo.type === ModifyType.Clone) && modinfo.value[0] instanceof Entity) {
            change.value = [modinfo.value[0].data];
        }
        this.changeSet.append(change);
    }
    /** 集合总记录数 */
    count() {
        return this.items.length;
    }
    /**
     * 获取实体对象的索引值
     */
    indexOf(entity) {
        return this.items.indexOf(entity);
    }
    /**
     * 计算集合中某个属性的总和
     * @param propertyName 属性名称
     */
    sum(propertyName) {
        if (this.count() === 0) {
            return 0;
        }
        return this.items.reduce((val, curr) => {
            return val + curr[propertyName];
        }, 0);
    }
    /**
     * 已废弃：请使用toJSON方法代替
     * @deprecated
     */
    toJson() {
        return this.rawData;
    }
    /**
     * 转换为JSON格式
     */
    toJSON() {
        const result = [];
        this.items.forEach((entity) => {
            result.push(entity.toJSON());
        });
        return result;
    }
    toArray() {
        return this.items;
    }
    // #endregion
    // #region 私有方法
    /**
     * 实体初始化
     * @param entity 实体
     */
    initEntity(entity, isNewEntity = false) {
        entity[PARENT_CLASS] = this;
        entity[PARENT_PATH] = this[PARENT_PATH];
        entity.onValueChanged.subscribe((v) => {
            const path = v.path;
            const value = v.value;
            const preValue = v.preValue;
            const operator = v.type;
            const subChanges = { path, value, preValue, type: operator };
            if (v.changeSetValue !== undefined) {
                subChanges['changeSetValue'] = v.changeSetValue;
            }
            this.setChanges(subChanges);
        });
        // TODO: 添加数据验证逻辑代码
        const newLength = this.rawData.push(entity);
        this[newLength - 1] = entity;
        if (!isNewEntity) {
            this.originalData.push(entity.toJSON());
        }
        return entity;
    }
    /**
     * 更新索引
     * @param total 总记录数
     */
    updateIndex(total) {
        for (let i = 0; i < total; i++) {
            delete this[i];
        }
        this.rawData.forEach((entity, index) => {
            this[index] = entity;
        });
    }
    /**
     * 获取属性名称
     */
    getPropertyName() {
        const path = this[PARENT_PATH];
        if (path && path.length) {
            const name = path[path.length - 1];
            return name;
        }
        return undefined;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X2xpc3QuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZW50aXR5L2VudGl0eV9saXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3BELE9BQU8sRUFBZ0IsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDOUQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNsQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakQsT0FBTyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQWEsTUFBTSxTQUFTLENBQUM7QUFLL0Q7O0dBRUc7QUFDSCxNQUFNLE9BQU8sVUFBVTtJQXdEckIsYUFBYTtJQUdiOzs7T0FHRztJQUNILFlBQVksSUFBWSxFQUFFLElBQWdCO1FBOURuQyxhQUFRLEdBQUcsWUFBWSxDQUFDO1FBRS9CLGVBQWU7UUFDUCxpQkFBWSxHQUFVLEVBQUUsQ0FBQztRQU1qQzs7V0FFRztRQUNLLGdCQUFXLEdBQUcsSUFBSSxPQUFPLEVBQWdCLENBQUM7UUFFbEQ7O1dBRUc7UUFDSyxjQUFTLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQztRQUNwQyxhQUFhO1FBR2IsZUFBZTtRQUVmOzs7V0FHRztRQUNJLGtCQUFhLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQW9DckQsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2IsSUFBSSxJQUFJLEVBQUU7WUFDUiwyQkFBMkI7WUFDM0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDbEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENB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QUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNLLGVBQWU7UUFDckIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQy9CLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDdkIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDbkMsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7Q0FJRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IENoYW5nZVNldCB9IGZyb20gJy4uL2NoYW5nZXNldC9jaGFuZ2Vfc2V0JztcbmltcG9ydCB7IE1vZGlmaWNhdGlvbiwgTW9kaWZ5VHlwZSB9IGZyb20gJy4uL2NoYW5nZXNldC90eXBlcyc7XG5pbXBvcnQgeyBFbnRpdHkgfSBmcm9tICcuL2VudGl0eSc7XG5pbXBvcnQgeyBFbnRpdHlGYWN0b3J5IH0gZnJvbSAnLi9lbnRpdHlfY3JlYXRvcic7XG5pbXBvcnQgeyBQQVJFTlRfQ0xBU1MsIFBBUkVOVF9QQVRILCBDbGFzc1R5cGUgfSBmcm9tICcuL3R5cGVzJztcblxuZXhwb3J0IGludGVyZmFjZSBJTGlzdDxUPiB7XG4gIFtpbmRleDogbnVtYmVyXTogVDtcbn1cbi8qKlxuICog5a6e5L2T6ZuG5ZCI5YiX6KGoXG4gKi9cbmV4cG9ydCBjbGFzcyBFbnRpdHlMaXN0PFQgZXh0ZW5kcyBFbnRpdHk+IGltcGxlbWVudHMgSUxpc3Q8VD4sIEl0ZXJhYmxlPFQ+IHtcbiAgcHVibGljIF9fdHlwZV9fID0gJ0VudGl0eUxpc3QnO1xuXG4gIC8vICNyZWdpb24g56eB5pyJ5bGe5oCnXG4gIHByaXZhdGUgb3JpZ2luYWxEYXRhOiBhbnlbXSA9IFtdO1xuICAvKipcbiAgICog5bey5bqf5byD77ya6K+35Yu/5L2/55SoXG4gICAqL1xuICBwcml2YXRlIHJhd0RhdGE6IFRbXTtcblxuICAvKipcbiAgICog5bey5bqf5byD77ya6K+35Yu/5L2/55SoXG4gICAqL1xuICBwcml2YXRlIGxpc3RDaGFuZ2VkID0gbmV3IFN1YmplY3Q8TW9kaWZpY2F0aW9uPigpO1xuXG4gIC8qKlxuICAgKiDlt7Llup/lvIPvvJror7fli7/kvb/nlKhcbiAgICovXG4gIHByaXZhdGUgY2hhbmdlU2V0ID0gbmV3IENoYW5nZVNldCgpO1xuICAvLyAjZW5kcmVnaW9uXG5cblxuICAvLyAjcmVnaW9uIOWFrOacieWxnuaAp1xuXG4gIC8qKlxuICAgKiDpm4blkIjmlLnlj5jml7bop6blj5Eo5paw5aKe44CB6KGM6K6w5b2V5L+u5pS544CB5Yig6ZmkKVxuICAgKiBAZXZlbnRcbiAgICovXG4gIHB1YmxpYyBvbkxpc3RDaGFuZ2VkID0gdGhpcy5saXN0Q2hhbmdlZC5hc09ic2VydmFibGUoKTtcblxuICAvKipcbiAgICog6I635Y+W6aG56ZuG5ZCIXG4gICAqL1xuICBwdWJsaWMgZ2V0IGl0ZW1zKCk6IFRbXSB7XG4gICAgcmV0dXJuIHRoaXMucmF3RGF0YTtcbiAgfVxuXG4gIC8qKlxuICAgKiDliJfooajlj5jmm7Tpm4ZcbiAgICovXG4gIHB1YmxpYyBnZXQgY2hhbmdlcygpIHtcbiAgICByZXR1cm4gdGhpcy5jaGFuZ2VTZXQuY2hhbmdlcztcbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5bmjIflrprntKLlvJXlpITnmoTlgLxcbiAgICovXG4gIFtpbmRleDogbnVtYmVyXTogVDtcblxuICAvKipcbiAgICog6L+t5Luj5ZmoXG4gICAqL1xuICAqW1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmF0b3I8VD4ge1xuICAgIHlpZWxkKiB0aGlzLml0ZW1zO1xuICB9XG5cbiAgLy8gI2VuZHJlZ2lvblxuXG5cbiAgLyoqXG4gICAqIEBwYXJhbSBkYXRhIEpTT07mlbDmja7pm4blkIhcbiAgICogQHBhcmFtIHR5cGUg6ZuG5ZCI5Lit55qE5a6e5L2T57G75Z6LXG4gICAqL1xuICBjb25zdHJ1Y3RvcihkYXRhPzogYW55W10sIHR5cGU/OiBDbGFzc1R5cGUpIHtcbiAgICB0aGlzLmNsZWFyKCk7XG4gICAgaWYgKGRhdGEpIHtcbiAgICAgIC8vIHRoaXMubG9hZEVudGl0aWVzKGRhdGEpO1xuICAgICAgZGF0YS5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICB0aGlzLmluaXRFbnRpdHkoRW50aXR5RmFjdG9yeSh0eXBlLCBpdGVtKSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuXG4gIC8vICNyZWdpb24g5YWs5pyJ5pa55rOVXG5cbiAgLyoqIOWKoOi9veWunuS9k+WIl+ihqCAqL1xuICBwdWJsaWMgbG9hZEVudGl0aWVzKGVudGl0aWVzOiBUW10pIHtcbiAgICB0aGlzLmNsZWFyKCk7XG5cbiAgICBlbnRpdGllcy5mb3JFYWNoKGVudGl0eSA9PiB7XG4gICAgICB0aGlzLmluaXRFbnRpdHkoZW50aXR5KTtcbiAgICB9KTtcblxuICAgIC8vIOWPkemAgUxvYWTlj5jmm7RcbiAgICBjb25zdCBjaGFuZ2VJdGVtID0ge1xuICAgICAgcGF0aDogW10sXG4gICAgICB2YWx1ZTogZW50aXRpZXMsXG4gICAgICBwcmVWYWx1ZTogdW5kZWZpbmVkLFxuICAgICAgdHlwZTogTW9kaWZ5VHlwZS5Mb2FkLFxuICAgICAgdGFyZ2V0OiB0aGlzXG4gICAgfTtcbiAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlSXRlbSk7XG4gIH1cbiAgLyoqXG4gICAqIOa4heepulxuICAgKi9cbiAgcHVibGljIGNsZWFyKCkge1xuICAgIHRoaXMucmF3RGF0YSA9IFtdO1xuICAgIHRoaXMub3JpZ2luYWxEYXRhID0gW107XG4gIH1cblxuICAvKipcbiAgICog5re75Yqg5a6e5L2T5a+56LGh5Yiw6ZuG5ZCI5Lit77yM5bm26L+U5Zue5paw5Yqg55qE5a+56LGhXG4gICAqIEBwYXJhbSBlbnRpdHkg5a6e5L2T5a+56LGhXG4gICAqIEBwYXJhbSBpc0Nsb25lZCDlhYvpmoZcbiAgICovXG4gIHB1YmxpYyBhcHBlbmROZXcoZW50aXR5OiBULCBpc0Nsb25lZDogYm9vbGVhbiA9IGZhbHNlKTogVCB7XG4gICAgY29uc3QgbmV3RW50aXR5ID0gdGhpcy5pbml0RW50aXR5KGVudGl0eSwgdHJ1ZSk7XG4gICAgLy8g5paw5aKe5Y+Y5pu0XG4gICAgY29uc3QgY2hhbmdlSXRlbSA9IHtcbiAgICAgIHBhdGg6IFtdLFxuICAgICAgdmFsdWU6IFtuZXdFbnRpdHldLFxuICAgICAgcHJlVmFsdWU6IHVuZGVmaW5lZCxcbiAgICAgIHR5cGU6IE1vZGlmeVR5cGUuQWRkXG4gICAgfTtcblxuICAgIGlmIChpc0Nsb25lZCA9PT0gdHJ1ZSkge1xuICAgICAgY2hhbmdlSXRlbS50eXBlID0gTW9kaWZ5VHlwZS5DbG9uZTtcbiAgICB9XG5cbiAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlSXRlbSk7XG4gICAgcmV0dXJuIG5ld0VudGl0eTtcbiAgfVxuICAvKipcbiAgICog5Zyo5oyH5a6a5L2N572u5o+S5YWl5a6e5L2TXG4gICAqIEBwYXJhbSBlbnRpdHkg5a6e5L2TXG4gICAqIEBwYXJhbSBwb3NpdGlvbiDmj5LlhaXkvY3nva5cbiAgICovXG4gIHB1YmxpYyBpbnNlcnQoZW50aXR5OiBULCBwb3NpdGlvbj86IDEgfCAtMSk6IFQge1xuICAgIGNvbnN0IG5ld0VudGl0eSA9IHRoaXMuaW5pdEVudGl0eShlbnRpdHksIHRydWUpO1xuXG4gICAgLy8g5paw5aKe5Y+Y5pu0XG4gICAgY29uc3QgY2hhbmdlSXRlbSA9IHtcbiAgICAgIHBhdGg6IFtdLFxuICAgICAgdmFsdWU6IFtuZXdFbnRpdHldLFxuICAgICAgcHJlVmFsdWU6IHVuZGVmaW5lZCxcbiAgICAgIHR5cGU6IE1vZGlmeVR5cGUuSW5zZXJ0LFxuICAgICAgcG9zaXRpb246IHBvc2l0aW9uLFxuICAgIH07XG5cbiAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlSXRlbSk7XG4gICAgcmV0dXJuIG5ld0VudGl0eTtcbiAgfVxuICAvKipcbiAgICog6L+95Yqg5a6e5L2TXG4gICAqL1xuICBwdWJsaWMgYXBwZW5kRW50aXR5KGVudGl0eTogVCk6IHZvaWQge1xuICAgIGNvbnN0IG5ld0VudGl0eSA9IHRoaXMuaW5pdEVudGl0eShlbnRpdHkpO1xuXG4gICAgLy8g5paw5aKe5Y+Y5pu0XG4gICAgY29uc3QgY2hhbmdlSXRlbSA9IHtcbiAgICAgIHBhdGg6IFtdLFxuICAgICAgdmFsdWU6IFtuZXdFbnRpdHldLFxuICAgICAgcHJlVmFsdWU6IHVuZGVmaW5lZCxcbiAgICAgIHR5cGU6IE1vZGlmeVR5cGUuQWRkXG4gICAgfTtcblxuICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VJdGVtKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmibnph4/ov73liqDlrp7kvZNcbiAgICovXG4gIHB1YmxpYyBhcHBlbmRFbnRpdGllcyhlbnRpdGllczogVFtdKTogdm9pZCB7XG4gICAgY29uc3QgbmV3RW50aXRlcyA9IGVudGl0aWVzLm1hcCgoZW50aXR5OiBUKSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5pbml0RW50aXR5KGVudGl0eSk7XG4gICAgfSk7XG4gICAgY29uc3QgY2hhbmdlSXRlbSA9IHtcbiAgICAgIHBhdGg6IFtdLFxuICAgICAgdmFsdWU6IG5ld0VudGl0ZXMsXG4gICAgICBwcmVWYWx1ZTogdW5kZWZpbmVkLFxuICAgICAgdHlwZTogTW9kaWZ5VHlwZS5BZGRcbiAgICB9O1xuXG4gICAgdGhpcy5zZXRDaGFuZ2VzKGNoYW5nZUl0ZW0pO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIoOmZpOaMh+WumuS4u+mUrklEIOeahOWunuS9k+Wvueixoe+8jOi/lOWbnuW4g+WwlO+8jHRydWUg5Yig6Zmk5oiQ5Yqf77yMZmFsc2Ug5Yig6Zmk5aSx6LSlXG4gICAqIEBwYXJhbSBwcmltYXJ5SWQg5Li76ZSuSURcbiAgICovXG4gIHB1YmxpYyByZW1vdmUocHJpbWFyeUlkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBjb25zdCB0b3RhbCA9IHRoaXMuY291bnQoKTtcbiAgICBjb25zdCBpbmRleFRvUmVtb3ZlID0gdGhpcy5yYXdEYXRhLmZpbmRJbmRleCgoZW50aXR5OiBFbnRpdHkpID0+IHtcbiAgICAgIHJldHVybiBlbnRpdHkucHJpbWFyeVZhbHVlID09PSBwcmltYXJ5SWQ7XG4gICAgfSk7XG4gICAgaWYgKGluZGV4VG9SZW1vdmUgPT09IC0xKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGNvbnN0IGVudGl0eVRvUmVtb3ZlID0gdGhpcy5yYXdEYXRhW2luZGV4VG9SZW1vdmVdO1xuICAgIHRoaXMucmF3RGF0YS5zcGxpY2UoaW5kZXhUb1JlbW92ZSwgMSk7XG5cbiAgICAvLyDliKDpmaTlj5jmm7RcbiAgICBjb25zdCBjaGFuZ2VJdGVtID0ge1xuICAgICAgcGF0aDogW10sXG4gICAgICB2YWx1ZTogeyBbZW50aXR5VG9SZW1vdmUucHJpbWFyeVByb3BlcnR5LmRhdGFGaWVsZF06IHByaW1hcnlJZCB9LFxuICAgICAgcHJlVmFsdWU6IHVuZGVmaW5lZCxcbiAgICAgIHR5cGU6IE1vZGlmeVR5cGUuUmVtb3ZlXG4gICAgfTtcblxuICAgIHRoaXMudXBkYXRlSW5kZXgodG90YWwpO1xuICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VJdGVtKTtcblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIOS7jumbhuWQiOS4reiOt+WPluaMh+WumklE5YC855qE5a6e5L2T5a+56LGhXG4gICAqIEBwYXJhbSBpZCDkuLvplK7lgLxcbiAgICovXG4gIHB1YmxpYyBnZXQoaWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLml0ZW1zLmZpbmQoaXRlbSA9PiB7XG4gICAgICByZXR1cm4gaXRlbS5wcmltYXJ5VmFsdWUgPT09IGlkO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIOWwhuWPmOabtOiusOW9lea3u+WKoOWIsOmbhuWQiOWPmOabtOmbhuS4rVxuICAgKiBAcGFyYW0gdmFsdWUg5Y+Y5pu06K6w5b2VXG4gICAqL1xuICBwdWJsaWMgc2V0Q2hhbmdlcyhtb2RpbmZvOiBNb2RpZmljYXRpb24pIHtcbiAgICAvLyDlkJFhcHDlsYLlj5HpgIHnmoTlj5jmm7RcbiAgICB0aGlzLmxpc3RDaGFuZ2VkLm5leHQobW9kaW5mbyk7XG5cbiAgICAvLyDmnoTpgKDlkJFjaGFuZ2VTZXTkuK3mt7vliqDnmoRjaGFnbmVcbiAgICBjb25zdCBjaGFuZ2UgPSBPYmplY3QuYXNzaWduKHt9LCBtb2RpbmZvKTtcbiAgICBpZiAoKG1vZGluZm8udHlwZSA9PT0gTW9kaWZ5VHlwZS5BZGQgfHwgbW9kaW5mby50eXBlID09PSBNb2RpZnlUeXBlLkluc2VydCB8fCBtb2RpbmZvLnR5cGUgPT09IE1vZGlmeVR5cGUuQ2xvbmUpICYmIG1vZGluZm8udmFsdWVbMF0gaW5zdGFuY2VvZiBFbnRpdHkpIHtcbiAgICAgIGNoYW5nZS52YWx1ZSA9IFttb2RpbmZvLnZhbHVlWzBdLmRhdGFdO1xuICAgIH1cbiAgICB0aGlzLmNoYW5nZVNldC5hcHBlbmQoY2hhbmdlKTtcbiAgfVxuXG4gIC8qKiDpm4blkIjmgLvorrDlvZXmlbAgKi9cbiAgcHVibGljIGNvdW50KCkge1xuICAgIHJldHVybiB0aGlzLml0ZW1zLmxlbmd0aDtcbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5blrp7kvZPlr7nosaHnmoTntKLlvJXlgLxcbiAgICovXG4gIHB1YmxpYyBpbmRleE9mKGVudGl0eTogVCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuaXRlbXMuaW5kZXhPZihlbnRpdHkpO1xuICB9XG5cbiAgLyoqXG4gICAqIOiuoeeul+mbhuWQiOS4reafkOS4quWxnuaAp+eahOaAu+WSjFxuICAgKiBAcGFyYW0gcHJvcGVydHlOYW1lIOWxnuaAp+WQjeensFxuICAgKi9cbiAgcHVibGljIHN1bShwcm9wZXJ0eU5hbWU6IHN0cmluZyk6IG51bWJlciB7XG4gICAgaWYgKHRoaXMuY291bnQoKSA9PT0gMCkge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLml0ZW1zLnJlZHVjZSgodmFsLCBjdXJyOiBUKSA9PiB7XG4gICAgICByZXR1cm4gdmFsICsgY3Vycltwcm9wZXJ0eU5hbWVdO1xuICAgIH0sIDApO1xuICB9XG5cbiAgLyoqXG4gICAqIOW3suW6n+W8g++8muivt+S9v+eUqHRvSlNPTuaWueazleS7o+abv1xuICAgKiBAZGVwcmVjYXRlZFxuICAgKi9cbiAgcHVibGljIHRvSnNvbigpIHtcbiAgICByZXR1cm4gdGhpcy5yYXdEYXRhO1xuICB9XG5cbiAgLyoqXG4gICAqIOi9rOaNouS4ukpTT07moLzlvI9cbiAgICovXG4gIHB1YmxpYyB0b0pTT04oKTogYW55W10ge1xuICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xuICAgIHRoaXMuaXRlbXMuZm9yRWFjaCgoZW50aXR5OiBFbnRpdHkpID0+IHtcbiAgICAgIHJlc3VsdC5wdXNoKGVudGl0eS50b0pTT04oKSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHB1YmxpYyB0b0FycmF5KCk6IFRbXSB7XG4gICAgcmV0dXJuIHRoaXMuaXRlbXM7XG4gIH1cblxuICAvLyAjZW5kcmVnaW9uXG5cblxuICAvLyAjcmVnaW9uIOengeacieaWueazlVxuXG4gIC8qKlxuICAgKiDlrp7kvZPliJ3lp4vljJZcbiAgICogQHBhcmFtIGVudGl0eSDlrp7kvZNcbiAgICovXG4gIHByaXZhdGUgaW5pdEVudGl0eShlbnRpdHk6IFQsIGlzTmV3RW50aXR5OiBib29sZWFuID0gZmFsc2UpOiBUIHtcbiAgICBlbnRpdHlbUEFSRU5UX0NMQVNTXSA9IHRoaXM7XG4gICAgZW50aXR5W1BBUkVOVF9QQVRIXSA9IHRoaXNbUEFSRU5UX1BBVEhdO1xuICAgIGVudGl0eS5vblZhbHVlQ2hhbmdlZC5zdWJzY3JpYmUoKHY6IE1vZGlmaWNhdGlvbikgPT4ge1xuICAgICAgY29uc3QgcGF0aCA9IHYucGF0aDtcbiAgICAgIGNvbnN0IHZhbHVlID0gdi52YWx1ZTtcbiAgICAgIGNvbnN0IHByZVZhbHVlID0gdi5wcmVWYWx1ZTtcbiAgICAgIGNvbnN0IG9wZXJhdG9yID0gdi50eXBlO1xuICAgICAgY29uc3Qgc3ViQ2hhbmdlcyA9IHsgcGF0aCwgdmFsdWUsIHByZVZhbHVlLCB0eXBlOiBvcGVyYXRvciB9O1xuICAgICAgaWYgKHYuY2hhbmdlU2V0VmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBzdWJDaGFuZ2VzWydjaGFuZ2VTZXRWYWx1ZSddID0gdi5jaGFuZ2VTZXRWYWx1ZTtcbiAgICAgIH1cbiAgICAgIHRoaXMuc2V0Q2hhbmdlcyhzdWJDaGFuZ2VzKTtcbiAgICB9KTtcbiAgICAvLyBUT0RPOiDmt7vliqDmlbDmja7pqozor4HpgLvovpHku6PnoIFcbiAgICBjb25zdCBuZXdMZW5ndGggPSB0aGlzLnJhd0RhdGEucHVzaChlbnRpdHkpO1xuICAgIHRoaXNbbmV3TGVuZ3RoIC0gMV0gPSBlbnRpdHk7XG4gICAgaWYgKCFpc05ld0VudGl0eSkge1xuICAgICAgdGhpcy5vcmlnaW5hbERhdGEucHVzaChlbnRpdHkudG9KU09OKCkpO1xuICAgIH1cbiAgICByZXR1cm4gZW50aXR5O1xuICB9XG5cbiAgLyoqXG4gICAqIOabtOaWsOe0ouW8lVxuICAgKiBAcGFyYW0gdG90YWwg5oC76K6w5b2V5pWwXG4gICAqL1xuICBwcml2YXRlIHVwZGF0ZUluZGV4KHRvdGFsOiBudW1iZXIpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRvdGFsOyBpKyspIHtcbiAgICAgIGRlbGV0ZSB0aGlzW2ldO1xuICAgIH1cbiAgICB0aGlzLnJhd0RhdGEuZm9yRWFjaCgoZW50aXR5LCBpbmRleCkgPT4ge1xuICAgICAgdGhpc1tpbmRleF0gPSBlbnRpdHk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICog6I635Y+W5bGe5oCn5ZCN56ewXG4gICAqL1xuICBwcml2YXRlIGdldFByb3BlcnR5TmFtZSgpIHtcbiAgICBjb25zdCBwYXRoID0gdGhpc1tQQVJFTlRfUEFUSF07XG4gICAgaWYgKHBhdGggJiYgcGF0aC5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IG5hbWUgPSBwYXRoW3BhdGgubGVuZ3RoIC0gMV07XG4gICAgICByZXR1cm4gbmFtZTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIC8vICNlbmRyZWdpb25cblxufVxuIl19