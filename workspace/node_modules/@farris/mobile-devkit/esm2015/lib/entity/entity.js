import { Subject } from 'rxjs';
import { FieldMetadataUtil } from './metadata/index';
;
import { ModifyType, ChangeSet } from '../changeset/index';
import { PARENT_PATH, PARENT_CLASS } from './types';
import { EntityList } from './entity_list';
import { EntityFactory } from './entity_factory';
/**
 * @author Lucas Huang
 * 实体抽象基类，所有实体必须扩展自Entity
 *
 * ### 使用示例
 * ```
 * export class UserEntity extends Entity {
 *    userId: string;
 *    userName: string;
 *
 *    constructor(data: any){
 *        super(data);
 *    }
 * }
 * ```
 */
export class Entity {
    // #endregion
    /**
     * @param data JSON数据
     */
    constructor(data) {
        // #region 私有、保护属性
        /**
         * 验证错误集合
         */
        this.validErrors = {};
        /**
         * 增量变更集合
         */
        this.changeSet = new ChangeSet();
        /**
         * 是否正在验证
         */
        this.isValidating = false;
        /**
         * 新数据
         */
        this.newData = undefined;
        // #endregion
        // #region 公有属性
        /**
         * 变更流
         */
        this.valueChanged = new Subject();
        /**
         * 属性值改变时触发
         *
         * ### 使用示例
         * ```
         *  const entity = new UserEntity(data);
         *  entity.onValueChanged.subscribe((data: Modification) => {
         *      console.log(data);
         *  })
         *
         * ```
         *
         * @event
         */
        this.onValueChanged = this.valueChanged.asObservable();
        /**
         * 是否变更
         */
        this.hasChange = false;
        this.newData = Object.assign({}, data);
        this.onValueChanged = this.valueChanged;
        this.initialize();
    }
    /**
     * 返回JSON格式的数据
     */
    get data() {
        return this.newData;
    }
    /**
     * 验证错误集合
     */
    get errors() {
        return this.validErrors;
    }
    /**
     * 实体变更集
     */
    get changes() {
        return this.changeSet.changes;
    }
    /**
     * 实体主键元数据
     */
    get primaryProperty() {
        return FieldMetadataUtil.getPrimaryFieldMetadata(this.constructor);
    }
    /**
     * 主键
     * @todo
     * 1、没有主键时返回''不合理，应该返回undefined
     */
    get primaryKey() {
        if (this.primaryProperty) {
            return this.primaryProperty.property;
        }
        else {
            return '';
        }
    }
    /**
     * 实体主键值
     * 1、没有主键时返回''不合理，应该返回undefined
     */
    get primaryValue() {
        if (this.primaryKey) {
            // return this[this.primaryProperty.property].toString();
            const primaryValue = this[this.primaryProperty.property];
            return primaryValue ? primaryValue : '';
        }
        else {
            return '';
        }
    }
    // #region 公有方法
    /**
     * 将变更记录保存至变更集中
     * @param value 变更记录
     */
    setChanges(value) {
        const propertyName = value.path[value.path.length - 1];
        // 增加实体变化后增加标志，加载数据或者重新加载不做标记
        if (value.type !== ModifyType.Load) {
            this.hasChange = true;
        }
        // @todo：事件会从下级向上冒泡，change可能是下级的，不能和当前Entity的newData合并。
        // this.newData = Object.assign(this.newData, { [propertyName]: value.value });
        this.valueChanged.next(value);
        this.changeSet.append(value);
    }
    getPaths() {
        const pathObj = {
            path: [],
            isUdt: false,
            isGrid: false
        };
        const handleParent = item => {
            const parentPaths = item[PARENT_PATH];
            if (parentPaths) {
                const prop = parentPaths[parentPaths.length - 1];
                // 父级所在实体包含的ngObject，存在当前实体字段，则判断为UDt字段
                if (Object.keys(FieldMetadataUtil.getNgObjects(item[PARENT_CLASS].constructor)).indexOf(prop) > -1) {
                    pathObj.isUdt = true;
                }
                // 存在类型为ngList，则判断为grid
                if (item[PARENT_CLASS] && item instanceof EntityList === true) {
                    pathObj.isGrid = true;
                }
                pathObj.path.push(prop);
            }
            if (item[PARENT_CLASS] && item instanceof EntityList === true) {
                handleParent(item[PARENT_CLASS]);
            }
        };
        handleParent(this);
        pathObj.path = pathObj.path.reverse();
        return pathObj;
    }
    /**
     * 加载数据
     * @param data 新数据
     */
    load(data) {
        if (!data) {
            data = {};
        }
        this.loadFields(data);
        this.loadLists(data);
        this.loadObjects(data);
        this.loadDynamicObjects(data);
        this.newData = Object.assign({}, data);
    }
    /**
     * 转换为JSON
     */
    toJSON() {
        const result = {};
        // 简单属性
        const ngFields = FieldMetadataUtil.getNgFields(this.constructor);
        Object.keys(ngFields).forEach((propName) => {
            const ngField = ngFields[propName];
            const dataField = ngField.dataField || propName;
            result[dataField] = this[propName];
        });
        // 对象属性
        const ngObjects = FieldMetadataUtil.getNgObjects(this.constructor);
        Object.keys(ngObjects).forEach((propName) => {
            const ngObject = ngObjects[propName];
            const dataField = ngObject.dataField || propName;
            result[dataField] = this[propName] ? this[propName].toJSON() : {};
        });
        // 动态属性
        const ngDynamics = FieldMetadataUtil.getNgDynamic(this.constructor);
        Object.keys(ngDynamics).forEach((propName) => {
            const ngDynamic = ngDynamics[propName];
            const dataField = ngDynamic.dataField || propName;
            result[dataField] = this[propName] ? this[propName].toJSON() : {};
        });
        // 列表属性
        const ngLists = FieldMetadataUtil.getNgList(this.constructor);
        Object.keys(ngLists).forEach((propName) => {
            const ngList = ngLists[propName];
            const dataField = ngList.dataField || propName;
            result[dataField] = this[propName] ? this[propName].toJSON() : {};
        });
        return result;
    }
    // #endregion
    //#region 实体初始化相关private方法
    /**
     * 初始化实体
     */
    initialize() {
        const constructor = this.constructor;
        const ngFields = FieldMetadataUtil.getNgFields(constructor);
        const ngObjects = FieldMetadataUtil.getNgObjects(constructor);
        const ngLists = FieldMetadataUtil.getNgList(constructor);
        const ngDynamic = FieldMetadataUtil.getNgDynamic(constructor);
        this.initializeNormalField(ngFields);
        this.initializeList(ngLists);
        this.initializeObject(ngObjects);
        this.initializeDynamic(ngDynamic);
    }
    /**
     * 创建path
     * @param propertyName 属性名称
     */
    createPath(propertyName) {
        const primaryFieldMetadata = this.primaryProperty;
        if (primaryFieldMetadata) {
            const primaryDataField = primaryFieldMetadata.dataField;
            return [primaryDataField + ':' + this.primaryValue, propertyName];
        }
        else {
            return [':', propertyName];
        }
    }
    /**
     * 属性字段初始化
     * @param ngFields 属性字段元数据
     */
    initializeNormalField(ngFields) {
        Object.keys(ngFields).forEach(propName => {
            const ngField = ngFields[propName];
            const dataField = ngField.dataField || propName;
            if (delete this[propName]) {
                Object.defineProperty(this, propName, {
                    get: function () {
                        return this.getPropValue(propName, ngField);
                    },
                    set: function (newPropValue) {
                        // 影响清空关联字段的主键值，移除此逻辑
                        // // 有主键的实体，不允许给实体赋空值
                        // if (this.primaryKey && this.primaryKey === propName && !newPropValue) {
                        //   return;
                        // }
                        // 有主键的实体，必须先给主键赋值，否则其他字段不允许赋值
                        if (this.primaryKey && this.primaryKey !== propName && !this.primaryValue) {
                            return;
                        }
                        // 值相同时不触发变更。
                        const oldPropValue = this.getPropValue(propName, ngField);
                        if (this.isPropValueChanged(propName, ngField, newPropValue, oldPropValue) === false) {
                            return;
                        }
                        this.setPropValue(propName, ngField, newPropValue);
                        this.emitValueChange(propName, ngField, newPropValue, oldPropValue);
                    },
                    configurable: true
                });
            }
        });
    }
    /**
     * 初始化列表类型的元数据
     * @param ngListMetadata 列表类型元数据
     */
    initializeList(ngListMetadata) {
        Object.keys(ngListMetadata).forEach(propertyName => {
            const fieldMetadata = ngListMetadata[propertyName];
            const path = this.createPath(propertyName);
            const dataField = fieldMetadata.dataField || propertyName;
            const val = this.data[dataField];
            const entityList = new EntityList();
            entityList[PARENT_CLASS] = this;
            entityList[PARENT_PATH] = path;
            if (val) {
                const entities = val.map(v => EntityFactory(fieldMetadata.type, v));
                entityList.loadEntities(entities);
            }
            entityList.onListChanged.subscribe(value => {
                if (value) {
                    if (entityList[PARENT_PATH][0] !== value.path[0]) {
                        value.path = entityList[PARENT_PATH].concat(value.path);
                    }
                    this.setChanges(value);
                }
            });
            this[propertyName] = entityList;
        });
    }
    /**
     * 初始化子对象
     * @param ngObjectMetadata 子对象元数据
     */
    initializeObject(ngObjectMetadata) {
        Object.keys(ngObjectMetadata).forEach(propertyName => {
            const fieldMetadata = ngObjectMetadata[propertyName];
            const path = this.createPath(propertyName);
            const dataField = fieldMetadata.dataField || propertyName;
            // val不存在时，用空对象代替
            const val = this.data[dataField] || {};
            const createEntityFromJsonData = (value) => {
                let instance;
                if (value instanceof fieldMetadata.type) {
                    instance = value;
                }
                else {
                    instance = EntityFactory(fieldMetadata.type, value);
                }
                instance[PARENT_CLASS] = this;
                instance[PARENT_PATH] = path;
                instance.onValueChanged.subscribe(changes => {
                    if (changes) {
                        changes.path = (this[PARENT_PATH] || []).concat(changes.path);
                        this.setChanges(changes);
                    }
                });
                return instance;
            };
            // 如果没有值用一个空对象代替
            let childEntity = createEntityFromJsonData(val);
            if (delete this[propertyName]) {
                Object.defineProperty(this, propertyName, {
                    get: () => {
                        return childEntity;
                    },
                    set: function (value) {
                        const modifyInfo = {
                            path: childEntity[PARENT_PATH],
                            value: value.data,
                            preValue: this[propertyName].data,
                            type: ModifyType.ValueChange
                        };
                        childEntity = createEntityFromJsonData(value);
                        this.setChanges(modifyInfo);
                    },
                    configurable: true
                });
            }
        });
    }
    initializeDynamic(ngDynamicMetadata) {
        Object.keys(ngDynamicMetadata).forEach(propertyName => {
            const fieldMetadata = ngDynamicMetadata[propertyName];
            const path = this.createPath(propertyName);
            const dataField = fieldMetadata.dataField || propertyName;
            const originalData = this.data[dataField] || {};
            const createEntityFromJsonData = (value) => {
                let instance;
                if (value instanceof fieldMetadata.type) {
                    instance = value;
                }
                else {
                    instance = EntityFactory(fieldMetadata.type, value);
                }
                instance[PARENT_CLASS] = this;
                instance[PARENT_PATH] = path;
                instance.onValueChanged.subscribe(changes => {
                    if (changes) {
                        changes.path = (this[PARENT_PATH] || []).concat(changes.path);
                        this.setChanges(changes);
                    }
                });
                return instance;
            };
            let dynamicEntity = createEntityFromJsonData(originalData);
            if (delete this[propertyName]) {
                Object.defineProperty(this, propertyName, {
                    get: function () {
                        return dynamicEntity;
                    },
                    set: function (value) {
                        const modifyInfo = {
                            path: dynamicEntity[PARENT_PATH],
                            value: value.data,
                            preValue: this[propertyName].data,
                            type: ModifyType.ValueChange
                        };
                        dynamicEntity = createEntityFromJsonData(value);
                        this.setChanges(modifyInfo);
                    },
                    configurable: true
                });
            }
        });
    }
    //#endregion
    // #region 加载实体数据相关private、projected方法
    /**
     * 加载简单字段值
     * @todo 临时用修改的方式模拟
     */
    loadFields(data) {
        const ngFields = FieldMetadataUtil.getNgFields(this.constructor);
        Object.keys(ngFields).forEach((propName) => {
            const ngField = ngFields[propName];
            const dataField = ngField.dataField || propName;
            // if (ngField.primary === false) {
            //   this[propName] = data[dataField];
            // }
            this[propName] = data[dataField];
        });
    }
    /**
     * 加载子列表数据
     * @param data 数据
     */
    loadLists(data) {
        const ngLists = FieldMetadataUtil.getNgList(this.constructor);
        Object.keys(ngLists).forEach((propName) => {
            const ngList = ngLists[propName];
            const dataField = ngList.dataField || propName;
            const entityType = ngList.type;
            // 创建实体
            const listData = data[dataField];
            if (listData) {
                const entities = listData.map((entityData) => {
                    return EntityFactory(entityType, entityData);
                });
                this[propName].loadEntities(entities);
            }
            else {
                this[propName].loadEntities([]);
            }
        });
    }
    loadObjects(data) {
        const ngObjects = FieldMetadataUtil.getNgObjects(this.constructor);
        Object.keys(ngObjects).forEach((propName) => {
            const ngObject = ngObjects[propName];
            const dataField = ngObject.dataField || propName;
            const objectData = data[dataField];
            const entity = this[propName];
            if (!entity || !objectData) {
                return;
            }
            entity.load(objectData);
        });
    }
    loadDynamicObjects(data) {
        const ngDynamicObjects = FieldMetadataUtil.getNgDynamic(this.constructor);
        Object.keys(ngDynamicObjects).forEach((propName) => {
            const ngDynamicObject = ngDynamicObjects[propName];
            const dataField = ngDynamicObject.dataField || propName;
            const dynamicData = data[dataField] || {};
            const dynamicEntity = this[propName];
            if (!dynamicEntity) {
                return;
            }
            dynamicEntity.loadDynamicData(dynamicData);
        });
    }
    // #endregion
    // #region 私有工具方法
    /**
     * 发送值变更
     */
    emitValueChange(propName, propMetadata, newPropValue, oldPropValue) {
        const change = {
            path: this.createPath(propName),
            value: newPropValue,
            preValue: oldPropValue,
            type: ModifyType.ValueChange
        };
        if (this[PARENT_PATH]) {
            change.path = this[PARENT_PATH].concat(change.path);
        }
        this.setChanges(change);
    }
    /**
     * 获取属性值
     */
    getPropValue(propName, propMetadata) {
        const dataField = propMetadata.dataField || propName;
        const value = this.data[dataField];
        // 对多语录入字段，query不返回问题进行兼容
        if (propMetadata.enableMultiLangInput === true && !value) {
            const langCode = window.localStorage.getItem('languageCode') || 'zh-CHS';
            const originDataField = dataField.replace('_MULTILANGUAGE', '');
            return {
                [langCode]: this.data[originDataField]
            };
        }
        return value;
    }
    /**
     * 设置属性值
     */
    setPropValue(propName, propMetadata, propValue) {
        const dataField = propMetadata.dataField || propName;
        this.data[dataField] = propValue;
    }
    /**
     * 检查属性值是否发生变化
     */
    isPropValueChanged(propName, propMetadata, newPropValue, oldPropValue) {
        if (propMetadata.enableMultiLangInput === true) {
            if (this.isEmptyMultiLangPropValue(newPropValue) === true && this.isEmptyMultiLangPropValue(oldPropValue) === true) {
                return false;
            }
            return JSON.stringify(newPropValue) !== JSON.stringify(oldPropValue);
        }
        else {
            return newPropValue !== oldPropValue;
        }
    }
    /**
     * 多语录入字段的值是否为空
     */
    isEmptyMultiLangPropValue(value) {
        return !value || Object.keys(value).length === 0;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2VudGl0eS9lbnRpdHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFjLE9BQU8sRUFBWSxNQUFNLE1BQU0sQ0FBQztBQUVyRCxPQUFPLEVBQW9GLGlCQUFpQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFBQSxDQUFDO0FBQ3hJLE9BQU8sRUFBZ0IsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3pFLE9BQU8sRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFXLE1BQU0sU0FBUyxDQUFDO0FBQzdELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWpEOzs7Ozs7Ozs7Ozs7Ozs7R0FlRztBQUNILE1BQU0sT0FBZ0IsTUFBTTtJQStHMUIsYUFBYTtJQUdiOztPQUVHO0lBQ0gsWUFBWSxJQUFTO1FBbEhyQixrQkFBa0I7UUFFbEI7O1dBRUc7UUFDSyxnQkFBVyxHQUFHLEVBQUUsQ0FBQztRQUV6Qjs7V0FFRztRQUNPLGNBQVMsR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDO1FBRXRDOztXQUVHO1FBQ08saUJBQVksR0FBRyxLQUFLLENBQUM7UUFFL0I7O1dBRUc7UUFDTyxZQUFPLEdBQUcsU0FBUyxDQUFDO1FBRTlCLGFBQWE7UUFHYixlQUFlO1FBRWY7O1dBRUc7UUFDSSxpQkFBWSxHQUFHLElBQUksT0FBTyxFQUFnQixDQUFDO1FBRWxEOzs7Ozs7Ozs7Ozs7O1dBYUc7UUFDSSxtQkFBYyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLENBQUM7UUF1QnpEOztXQUVHO1FBQ0ksY0FBUyxHQUFHLEtBQUssQ0FBQztRQTJDdkIsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsTUFBTSxD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LENBQUMsUUFBUSxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUM7YUFDdkMsQ0FBQztTQUNIO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQ7O09BRUc7SUFDSyxZQUFZLENBQUMsUUFBZ0IsRUFBRSxZQUFtQyxFQUFFLFNBQWM7UUFDeEYsTUFBTSxTQUFTLEdBQUcsWUFBWSxDQUFDLFNBQVMsSUFBSSxRQUFRLENBQUM7UUFDckQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxTQUFTLENBQUM7SUFDbkMsQ0FBQztJQUVEOztPQUVHO0lBQ0ssa0JBQWtCLENBQUMsUUFBZ0IsRUFBRSxZQUFtQyxFQUFFLFlBQWlCLEVBQUUsWUFBaUI7UUFDcEgsSUFBSSxZQUFZLENBQUMsb0JBQW9CLEtBQUssSUFBSSxFQUFFO1lBQzlDLElBQUksSUFBSSxDQUFDLHlCQUF5QixDQUFDLFlBQVksQ0FBQyxLQUFLLElBQUksSUFBSSxJQUFJLENBQUMseUJBQXlCLENBQUMsWUFBWSxDQUFDLEtBQUssSUFBSSxFQUFFO2dCQUNsSCxPQUFPLEtBQUssQ0FBQzthQUNkO1lBQ0QsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUM7U0FDdEU7YUFBTTtZQUNMLE9BQU8sWUFBWSxLQUFLLFlBQVksQ0FBQztTQUN0QztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLHlCQUF5QixDQUFDLEtBQVU7UUFDMUMsT0FBTyxDQUFDLEtBQUssSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUM7SUFDbkQsQ0FBQztDQUdGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCwgZnJvbSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHNjYW4sIG1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgUHJpbWl0aXZlUHJvcE1ldGFkYXRhLCBMaXN0UHJvcE1ldGFkYXRhLCBPYmplY3RQcm9wTWV0YWRhdGEsIER5bmFtaWNQcm9wTWV0YWRhdGEsIEZpZWxkTWV0YWRhdGFVdGlsIH0gZnJvbSAnLi9tZXRhZGF0YS9pbmRleCc7O1xuaW1wb3J0IHsgTW9kaWZpY2F0aW9uLCBNb2RpZnlUeXBlLCBDaGFuZ2VTZXQgfSBmcm9tICcuLi9jaGFuZ2VzZXQvaW5kZXgnO1xuaW1wb3J0IHsgUEFSRU5UX1BBVEgsIFBBUkVOVF9DTEFTUywgRHluYW1pYyB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgRW50aXR5TGlzdCB9IGZyb20gJy4vZW50aXR5X2xpc3QnO1xuaW1wb3J0IHsgRW50aXR5RmFjdG9yeSB9IGZyb20gJy4vZW50aXR5X2ZhY3RvcnknO1xuXG4vKipcbiAqIEBhdXRob3IgTHVjYXMgSHVhbmdcbiAqIOWunuS9k+aKveixoeWfuuexu++8jOaJgOacieWunuS9k+W/hemhu+aJqeWxleiHqkVudGl0eVxuICpcbiAqICMjIyDkvb/nlKjnpLrkvotcbiAqIGBgYFxuICogZXhwb3J0IGNsYXNzIFVzZXJFbnRpdHkgZXh0ZW5kcyBFbnRpdHkge1xuICogICAgdXNlcklkOiBzdHJpbmc7XG4gKiAgICB1c2VyTmFtZTogc3RyaW5nO1xuICpcbiAqICAgIGNvbnN0cnVjdG9yKGRhdGE6IGFueSl7XG4gKiAgICAgICAgc3VwZXIoZGF0YSk7XG4gKiAgICB9XG4gKiB9XG4gKiBgYGBcbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEVudGl0eSB7XG5cblxuICAvLyAjcmVnaW9uIOengeacieOAgeS/neaKpOWxnuaAp1xuXG4gIC8qKlxuICAgKiDpqozor4HplJnor6/pm4blkIhcbiAgICovXG4gIHByaXZhdGUgdmFsaWRFcnJvcnMgPSB7fTtcblxuICAvKipcbiAgICog5aKe6YeP5Y+Y5pu06ZuG5ZCIXG4gICAqL1xuICBwcm90ZWN0ZWQgY2hhbmdlU2V0ID0gbmV3IENoYW5nZVNldCgpO1xuXG4gIC8qKlxuICAgKiDmmK/lkKbmraPlnKjpqozor4FcbiAgICovXG4gIHByb3RlY3RlZCBpc1ZhbGlkYXRpbmcgPSBmYWxzZTtcblxuICAvKipcbiAgICog5paw5pWw5o2uXG4gICAqL1xuICBwcm90ZWN0ZWQgbmV3RGF0YSA9IHVuZGVmaW5lZDtcblxuICAvLyAjZW5kcmVnaW9uXG5cblxuICAvLyAjcmVnaW9uIOWFrOacieWxnuaAp1xuXG4gIC8qKlxuICAgKiDlj5jmm7TmtYFcbiAgICovXG4gIHB1YmxpYyB2YWx1ZUNoYW5nZWQgPSBuZXcgU3ViamVjdDxNb2RpZmljYXRpb24+KCk7XG5cbiAgLyoqXG4gICAqIOWxnuaAp+WAvOaUueWPmOaXtuinpuWPkVxuICAgKlxuICAgKiAjIyMg5L2/55So56S65L6LXG4gICAqIGBgYFxuICAgKiAgY29uc3QgZW50aXR5ID0gbmV3IFVzZXJFbnRpdHkoZGF0YSk7XG4gICAqICBlbnRpdHkub25WYWx1ZUNoYW5nZWQuc3Vic2NyaWJlKChkYXRhOiBNb2RpZmljYXRpb24pID0+IHtcbiAgICogICAgICBjb25zb2xlLmxvZyhkYXRhKTtcbiAgICogIH0pXG4gICAqXG4gICAqIGBgYFxuICAgKlxuICAgKiBAZXZlbnRcbiAgICovXG4gIHB1YmxpYyBvblZhbHVlQ2hhbmdlZCA9IHRoaXMudmFsdWVDaGFuZ2VkLmFzT2JzZXJ2YWJsZSgpO1xuXG4gIC8qKlxuICAgKiDov5Tlm55KU09O5qC85byP55qE5pWw5o2uXG4gICAqL1xuICBwdWJsaWMgZ2V0IGRhdGEoKTogYW55IHtcbiAgICByZXR1cm4gdGhpcy5uZXdEYXRhO1xuICB9XG5cbiAgLyoqXG4gICAqIOmqjOivgemUmeivr+mbhuWQiFxuICAgKi9cbiAgcHVibGljIGdldCBlcnJvcnMoKSB7XG4gICAgcmV0dXJuIHRoaXMudmFsaWRFcnJvcnM7XG4gIH1cblxuICAvKipcbiAgICog5a6e5L2T5Y+Y5pu06ZuGXG4gICAqL1xuICBwdWJsaWMgZ2V0IGNoYW5nZXMoKTogTW9kaWZpY2F0aW9uW10ge1xuICAgIHJldHVybiB0aGlzLmNoYW5nZVNldC5jaGFuZ2VzO1xuICB9XG5cbiAgLyoqXG4gICAqIOaYr+WQpuWPmOabtFxuICAgKi9cbiAgcHVibGljIGhhc0NoYW5nZSA9IGZhbHNlO1xuXG4gIC8qKlxuICAgKiDlrp7kvZPkuLvplK7lhYPmlbDmja5cbiAgICovXG4gIHB1YmxpYyBnZXQgcHJpbWFyeVByb3BlcnR5KCk6IFByaW1pdGl2ZVByb3BNZXRhZGF0YSB7XG4gICAgcmV0dXJuIEZpZWxkTWV0YWRhdGFVdGlsLmdldFByaW1hcnlGaWVsZE1ldGFkYXRhKHRoaXMuY29uc3RydWN0b3IpO1xuICB9XG5cbiAgLyoqXG4gICAqIOS4u+mUrlxuICAgKiBAdG9kb1xuICAgKiAx44CB5rKh5pyJ5Li76ZSu5pe26L+U5ZueJyfkuI3lkIjnkIbvvIzlupTor6Xov5Tlm551bmRlZmluZWRcbiAgICovXG4gIHB1YmxpYyBnZXQgcHJpbWFyeUtleSgpOiBzdHJpbmcge1xuICAgIGlmICh0aGlzLnByaW1hcnlQcm9wZXJ0eSkge1xuICAgICAgcmV0dXJuIHRoaXMucHJpbWFyeVByb3BlcnR5LnByb3BlcnR5O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOWunuS9k+S4u+mUruWAvFxuICAgKiAx44CB5rKh5pyJ5Li76ZSu5pe26L+U5ZueJyfkuI3lkIjnkIbvvIzlupTor6Xov5Tlm551bmRlZmluZWRcbiAgICovXG4gIHB1YmxpYyBnZXQgcHJpbWFyeVZhbHVlKCk6IHN0cmluZyB7XG4gICAgaWYgKHRoaXMucHJpbWFyeUtleSkge1xuICAgICAgLy8gcmV0dXJuIHRoaXNbdGhpcy5wcmltYXJ5UHJvcGVydHkucHJvcGVydHldLnRvU3RyaW5nKCk7XG4gICAgICBjb25zdCBwcmltYXJ5VmFsdWUgPSB0aGlzW3RoaXMucHJpbWFyeVByb3BlcnR5LnByb3BlcnR5XTtcbiAgICAgIHJldHVybiBwcmltYXJ5VmFsdWUgPyBwcmltYXJ5VmFsdWUgOiAnJztcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuICcnO1xuICAgIH1cbiAgfVxuXG4gIC8vICNlbmRyZWdpb25cblxuXG4gIC8qKlxuICAgKiBAcGFyYW0gZGF0YSBKU09O5pWw5o2uXG4gICAqL1xuICBjb25zdHJ1Y3RvcihkYXRhOiBhbnkpIHtcbiAgICB0aGlzLm5ld0RhdGEgPSBPYmplY3QuYXNzaWduKHt9LCBkYXRhKTtcbiAgICB0aGlzLm9uVmFsdWVDaGFuZ2VkID0gdGhpcy52YWx1ZUNoYW5nZWQ7XG4gICAgdGhpcy5pbml0aWFsaXplKCk7XG4gIH1cblxuXG4gIC8vICNyZWdpb24g5YWs5pyJ5pa55rOVXG5cbiAgLyoqXG4gICAqIOWwhuWPmOabtOiusOW9leS/neWtmOiHs+WPmOabtOmbhuS4rVxuICAgKiBAcGFyYW0gdmFsdWUg5Y+Y5pu06K6w5b2VXG4gICAqL1xuICBwdWJsaWMgc2V0Q2hhbmdlcyh2YWx1ZTogTW9kaWZpY2F0aW9uKTogdm9pZCB7XG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gdmFsdWUucGF0aFt2YWx1ZS5wYXRoLmxlbmd0aCAtIDFdO1xuICAgIC8vIOWinuWKoOWunuS9k+WPmOWMluWQjuWinuWKoOagh+W/l++8jOWKoOi9veaVsOaNruaIluiAhemHjeaWsOWKoOi9veS4jeWBmuagh+iusFxuICAgIGlmICh2YWx1ZS50eXBlICE9PSBNb2RpZnlUeXBlLkxvYWQpIHsgdGhpcy5oYXNDaGFuZ2UgPSB0cnVlOyB9XG5cbiAgICAvLyBAdG9kb++8muS6i+S7tuS8muS7juS4i+e6p+WQkeS4iuWGkuazoe+8jGNoYW5nZeWPr+iDveaYr+S4i+e6p+eahO+8jOS4jeiDveWSjOW9k+WJjUVudGl0eeeahG5ld0RhdGHlkIjlubbjgIJcbiAgICAvLyB0aGlzLm5ld0RhdGEgPSBPYmplY3QuYXNzaWduKHRoaXMubmV3RGF0YSwgeyBbcHJvcGVydHlOYW1lXTogdmFsdWUudmFsdWUgfSk7XG4gICAgdGhpcy52YWx1ZUNoYW5nZWQubmV4dCh2YWx1ZSk7XG4gICAgdGhpcy5jaGFuZ2VTZXQuYXBwZW5kKHZhbHVlKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRQYXRocygpIHtcbiAgICBjb25zdCBwYXRoT2JqID0ge1xuICAgICAgcGF0aDogW10sXG4gICAgICBpc1VkdDogZmFsc2UsXG4gICAgICBpc0dyaWQ6IGZhbHNlXG4gICAgfTtcbiAgICBjb25zdCBoYW5kbGVQYXJlbnQgPSBpdGVtID0+IHtcbiAgICAgIGNvbnN0IHBhcmVudFBhdGhzID0gaXRlbVtQQVJFTlRfUEFUSF07XG4gICAgICBpZiAocGFyZW50UGF0aHMpIHtcbiAgICAgICAgY29uc3QgcHJvcCA9IHBhcmVudFBhdGhzW3BhcmVudFBhdGhzLmxlbmd0aCAtIDFdO1xuICAgICAgICAvLyDniLbnuqfmiYDlnKjlrp7kvZPljIXlkKvnmoRuZ09iamVjdO+8jOWtmOWcqOW9k+WJjeWunuS9k+Wtl+aute+8jOWImeWIpOaWreS4ulVEdOWtl+autVxuICAgICAgICBpZiAoT2JqZWN0LmtleXMoRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdPYmplY3RzKGl0ZW1bUEFSRU5UX0NMQVNTXS5jb25zdHJ1Y3RvcikpLmluZGV4T2YocHJvcCkgPiAtMSkge1xuICAgICAgICAgIHBhdGhPYmouaXNVZHQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIC8vIOWtmOWcqOexu+Wei+S4um5nTGlzdO+8jOWImeWIpOaWreS4umdyaWRcbiAgICAgICAgaWYgKGl0ZW1bUEFSRU5UX0NMQVNTXSAmJiBpdGVtIGluc3RhbmNlb2YgRW50aXR5TGlzdCA9PT0gdHJ1ZSkge1xuICAgICAgICAgIHBhdGhPYmouaXNHcmlkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBwYXRoT2JqLnBhdGgucHVzaChwcm9wKTtcbiAgICAgIH1cbiAgICAgIGlmIChpdGVtW1BBUkVOVF9DTEFTU10gJiYgaXRlbSBpbnN0YW5jZW9mIEVudGl0eUxpc3QgPT09IHRydWUpIHtcbiAgICAgICAgaGFuZGxlUGFyZW50KGl0ZW1bUEFSRU5UX0NMQVNTXSk7XG4gICAgICB9XG4gICAgfTtcbiAgICBoYW5kbGVQYXJlbnQodGhpcyk7XG4gICAgcGF0aE9iai5wYXRoID0gcGF0aE9iai5wYXRoLnJldmVyc2UoKTtcbiAgICByZXR1cm4gcGF0aE9iajtcbiAgfVxuXG4gIC8qKlxuICAgKiDliqDovb3mlbDmja5cbiAgICogQHBhcmFtIGRhdGEg5paw5pWw5o2uXG4gICAqL1xuICBwdWJsaWMgbG9hZChkYXRhOiBhbnkpIHtcbiAgICBpZiAoIWRhdGEpIHtcbiAgICAgIGRhdGEgPSB7fTtcbiAgICB9XG5cbiAgICB0aGlzLmxvYWRGaWVsZHMoZGF0YSk7XG4gICAgdGhpcy5sb2FkTGlzdHMoZGF0YSk7XG4gICAgdGhpcy5sb2FkT2JqZWN0cyhkYXRhKTtcblxuICAgIHRoaXMubG9hZER5bmFtaWNPYmplY3RzKGRhdGEpO1xuICAgIHRoaXMubmV3RGF0YSA9IE9iamVjdC5hc3NpZ24oe30sIGRhdGEpO1xuICB9XG5cbiAgLyoqXG4gICAqIOi9rOaNouS4ukpTT05cbiAgICovXG4gIHB1YmxpYyB0b0pTT04oKSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG5cbiAgICAvLyDnroDljZXlsZ7mgKdcbiAgICBjb25zdCBuZ0ZpZWxkcyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nRmllbGRzKHRoaXMuY29uc3RydWN0b3IpO1xuICAgIE9iamVjdC5rZXlzKG5nRmllbGRzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICBjb25zdCBuZ0ZpZWxkID0gbmdGaWVsZHNbcHJvcE5hbWVdO1xuICAgICAgY29uc3QgZGF0YUZpZWxkID0gbmdGaWVsZC5kYXRhRmllbGQgfHwgcHJvcE5hbWU7XG4gICAgICByZXN1bHRbZGF0YUZpZWxkXSA9IHRoaXNbcHJvcE5hbWVdO1xuICAgIH0pO1xuXG4gICAgLy8g5a+56LGh5bGe5oCnXG4gICAgY29uc3QgbmdPYmplY3RzID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdPYmplY3RzKHRoaXMuY29uc3RydWN0b3IpO1xuICAgIE9iamVjdC5rZXlzKG5nT2JqZWN0cykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgbmdPYmplY3QgPSBuZ09iamVjdHNbcHJvcE5hbWVdO1xuICAgICAgY29uc3QgZGF0YUZpZWxkID0gbmdPYmplY3QuZGF0YUZpZWxkIHx8IHByb3BOYW1lO1xuICAgICAgcmVzdWx0W2RhdGFGaWVsZF0gPSB0aGlzW3Byb3BOYW1lXSA/IHRoaXNbcHJvcE5hbWVdLnRvSlNPTigpIDoge307XG4gICAgfSk7XG5cbiAgICAvLyDliqjmgIHlsZ7mgKdcbiAgICBjb25zdCBuZ0R5bmFtaWNzID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdEeW5hbWljKHRoaXMuY29uc3RydWN0b3IpO1xuICAgIE9iamVjdC5rZXlzKG5nRHluYW1pY3MpLmZvckVhY2goKHByb3BOYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgIGNvbnN0IG5nRHluYW1pYyA9IG5nRHluYW1pY3NbcHJvcE5hbWVdO1xuICAgICAgY29uc3QgZGF0YUZpZWxkID0gbmdEeW5hbWljLmRhdGFGaWVsZCB8fCBwcm9wTmFtZTtcbiAgICAgIHJlc3VsdFtkYXRhRmllbGRdID0gdGhpc1twcm9wTmFtZV0gPyB0aGlzW3Byb3BOYW1lXS50b0pTT04oKSA6IHt9O1xuICAgIH0pO1xuXG4gICAgLy8g5YiX6KGo5bGe5oCnXG4gICAgY29uc3QgbmdMaXN0cyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nTGlzdCh0aGlzLmNvbnN0cnVjdG9yKTtcbiAgICBPYmplY3Qua2V5cyhuZ0xpc3RzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICBjb25zdCBuZ0xpc3QgPSBuZ0xpc3RzW3Byb3BOYW1lXTtcbiAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IG5nTGlzdC5kYXRhRmllbGQgfHwgcHJvcE5hbWU7XG4gICAgICByZXN1bHRbZGF0YUZpZWxkXSA9IHRoaXNbcHJvcE5hbWVdID8gdGhpc1twcm9wTmFtZV0udG9KU09OKCkgOiB7fTtcbiAgICB9KTtcblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICAvLyAjZW5kcmVnaW9uXG5cblxuICAvLyNyZWdpb24g5a6e5L2T5Yid5aeL5YyW55u45YWzcHJpdmF0ZeaWueazlVxuXG4gIC8qKlxuICAgKiDliJ3lp4vljJblrp7kvZNcbiAgICovXG4gIHByaXZhdGUgaW5pdGlhbGl6ZSgpIHtcbiAgICBjb25zdCBjb25zdHJ1Y3RvciA9IHRoaXMuY29uc3RydWN0b3I7XG5cbiAgICBjb25zdCBuZ0ZpZWxkcyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nRmllbGRzKGNvbnN0cnVjdG9yKTtcbiAgICBjb25zdCBuZ09iamVjdHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ09iamVjdHMoY29uc3RydWN0b3IpO1xuICAgIGNvbnN0IG5nTGlzdHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0xpc3QoY29uc3RydWN0b3IpO1xuICAgIGNvbnN0IG5nRHluYW1pYyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nRHluYW1pYyhjb25zdHJ1Y3Rvcik7XG5cbiAgICB0aGlzLmluaXRpYWxpemVOb3JtYWxGaWVsZChuZ0ZpZWxkcyk7XG4gICAgdGhpcy5pbml0aWFsaXplTGlzdChuZ0xpc3RzKTtcbiAgICB0aGlzLmluaXRpYWxpemVPYmplY3QobmdPYmplY3RzKTtcbiAgICB0aGlzLmluaXRpYWxpemVEeW5hbWljKG5nRHluYW1pYyk7XG4gIH1cblxuICAvKipcbiAgICog5Yib5bu6cGF0aFxuICAgKiBAcGFyYW0gcHJvcGVydHlOYW1lIOWxnuaAp+WQjeensFxuICAgKi9cbiAgcHJvdGVjdGVkIGNyZWF0ZVBhdGgocHJvcGVydHlOYW1lOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgcHJpbWFyeUZpZWxkTWV0YWRhdGEgPSB0aGlzLnByaW1hcnlQcm9wZXJ0eTtcbiAgICBpZiAocHJpbWFyeUZpZWxkTWV0YWRhdGEpIHtcbiAgICAgIGNvbnN0IHByaW1hcnlEYXRhRmllbGQgPSBwcmltYXJ5RmllbGRNZXRhZGF0YS5kYXRhRmllbGQ7XG4gICAgICByZXR1cm4gW3ByaW1hcnlEYXRhRmllbGQgKyAnOicgKyB0aGlzLnByaW1hcnlWYWx1ZSwgcHJvcGVydHlOYW1lXTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFsnOicsIHByb3BlcnR5TmFtZV07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOWxnuaAp+Wtl+auteWIneWni+WMllxuICAgKiBAcGFyYW0gbmdGaWVsZHMg5bGe5oCn5a2X5q615YWD5pWw5o2uXG4gICAqL1xuICBwcml2YXRlIGluaXRpYWxpemVOb3JtYWxGaWVsZChuZ0ZpZWxkczogeyBba2V5OiBzdHJpbmddOiBQcmltaXRpdmVQcm9wTWV0YWRhdGEgfSk6IHZvaWQge1xuICAgIE9iamVjdC5rZXlzKG5nRmllbGRzKS5mb3JFYWNoKHByb3BOYW1lID0+IHtcbiAgICAgIGNvbnN0IG5nRmllbGQgPSBuZ0ZpZWxkc1twcm9wTmFtZV0gYXMgUHJpbWl0aXZlUHJvcE1ldGFkYXRhO1xuICAgICAgY29uc3QgZGF0YUZpZWxkID0gbmdGaWVsZC5kYXRhRmllbGQgfHwgcHJvcE5hbWU7XG5cbiAgICAgIGlmIChkZWxldGUgdGhpc1twcm9wTmFtZV0pIHtcbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHByb3BOYW1lLCB7XG4gICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRQcm9wVmFsdWUocHJvcE5hbWUsIG5nRmllbGQpO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgc2V0OiBmdW5jdGlvbiAobmV3UHJvcFZhbHVlKSB7XG5cbiAgICAgICAgICAgIC8vIOW9seWTjea4heepuuWFs+iBlOWtl+auteeahOS4u+mUruWAvO+8jOenu+mZpOatpOmAu+i+kVxuICAgICAgICAgICAgLy8gLy8g5pyJ5Li76ZSu55qE5a6e5L2T77yM5LiN5YWB6K6457uZ5a6e5L2T6LWL56m65YC8XG4gICAgICAgICAgICAvLyBpZiAodGhpcy5wcmltYXJ5S2V5ICYmIHRoaXMucHJpbWFyeUtleSA9PT0gcHJvcE5hbWUgJiYgIW5ld1Byb3BWYWx1ZSkge1xuICAgICAgICAgICAgLy8gICByZXR1cm47XG4gICAgICAgICAgICAvLyB9XG5cbiAgICAgICAgICAgIC8vIOacieS4u+mUrueahOWunuS9k++8jOW/hemhu+WFiOe7meS4u+mUrui1i+WAvO+8jOWQpuWImeWFtuS7luWtl+auteS4jeWFgeiuuOi1i+WAvFxuICAgICAgICAgICAgaWYgKHRoaXMucHJpbWFyeUtleSAmJiB0aGlzLnByaW1hcnlLZXkgIT09IHByb3BOYW1lICYmICF0aGlzLnByaW1hcnlWYWx1ZSkge1xuICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIOWAvOebuOWQjOaXtuS4jeinpuWPkeWPmOabtOOAglxuICAgICAgICAgICAgY29uc3Qgb2xkUHJvcFZhbHVlID0gdGhpcy5nZXRQcm9wVmFsdWUocHJvcE5hbWUsIG5nRmllbGQpO1xuICAgICAgICAgICAgaWYgKHRoaXMuaXNQcm9wVmFsdWVDaGFuZ2VkKHByb3BOYW1lLCBuZ0ZpZWxkLCBuZXdQcm9wVmFsdWUsIG9sZFByb3BWYWx1ZSkgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2V0UHJvcFZhbHVlKHByb3BOYW1lLCBuZ0ZpZWxkLCBuZXdQcm9wVmFsdWUpO1xuICAgICAgICAgICAgdGhpcy5lbWl0VmFsdWVDaGFuZ2UocHJvcE5hbWUsIG5nRmllbGQsIG5ld1Byb3BWYWx1ZSwgb2xkUHJvcFZhbHVlKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDliJ3lp4vljJbliJfooajnsbvlnovnmoTlhYPmlbDmja5cbiAgICogQHBhcmFtIG5nTGlzdE1ldGFkYXRhIOWIl+ihqOexu+Wei+WFg+aVsOaNrlxuICAgKi9cbiAgcHJpdmF0ZSBpbml0aWFsaXplTGlzdChuZ0xpc3RNZXRhZGF0YTogeyBba2V5OiBzdHJpbmddOiBMaXN0UHJvcE1ldGFkYXRhIH0pOiB2b2lkIHtcbiAgICBPYmplY3Qua2V5cyhuZ0xpc3RNZXRhZGF0YSkuZm9yRWFjaChwcm9wZXJ0eU5hbWUgPT4ge1xuICAgICAgY29uc3QgZmllbGRNZXRhZGF0YSA9IG5nTGlzdE1ldGFkYXRhW3Byb3BlcnR5TmFtZV0gYXMgTGlzdFByb3BNZXRhZGF0YTtcbiAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmNyZWF0ZVBhdGgocHJvcGVydHlOYW1lKTtcbiAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IGZpZWxkTWV0YWRhdGEuZGF0YUZpZWxkIHx8IHByb3BlcnR5TmFtZTtcbiAgICAgIGNvbnN0IHZhbCA9IHRoaXMuZGF0YVtkYXRhRmllbGRdO1xuXG4gICAgICBjb25zdCBlbnRpdHlMaXN0ID0gbmV3IEVudGl0eUxpc3Q8dHlwZW9mIGZpZWxkTWV0YWRhdGEudHlwZT4oKTtcbiAgICAgIGVudGl0eUxpc3RbUEFSRU5UX0NMQVNTXSA9IHRoaXM7XG4gICAgICBlbnRpdHlMaXN0W1BBUkVOVF9QQVRIXSA9IHBhdGg7XG5cbiAgICAgIGlmICh2YWwpIHtcbiAgICAgICAgY29uc3QgZW50aXRpZXMgPSB2YWwubWFwKHYgPT4gRW50aXR5RmFjdG9yeTx0eXBlb2YgZmllbGRNZXRhZGF0YS50eXBlPihmaWVsZE1ldGFkYXRhLnR5cGUsIHYpKTtcbiAgICAgICAgZW50aXR5TGlzdC5sb2FkRW50aXRpZXMoZW50aXRpZXMpO1xuICAgICAgfVxuXG4gICAgICBlbnRpdHlMaXN0Lm9uTGlzdENoYW5nZWQuc3Vic2NyaWJlKHZhbHVlID0+IHtcbiAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgaWYgKGVudGl0eUxpc3RbUEFSRU5UX1BBVEhdWzBdICE9PSB2YWx1ZS5wYXRoWzBdKSB7XG4gICAgICAgICAgICB2YWx1ZS5wYXRoID0gZW50aXR5TGlzdFtQQVJFTlRfUEFUSF0uY29uY2F0KHZhbHVlLnBhdGgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLnNldENoYW5nZXModmFsdWUpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHRoaXNbcHJvcGVydHlOYW1lXSA9IGVudGl0eUxpc3Q7XG4gICAgfSk7XG4gIH1cbiAgLyoqXG4gICAqIOWIneWni+WMluWtkOWvueixoVxuICAgKiBAcGFyYW0gbmdPYmplY3RNZXRhZGF0YSDlrZDlr7nosaHlhYPmlbDmja5cbiAgICovXG4gIHByaXZhdGUgaW5pdGlhbGl6ZU9iamVjdChuZ09iamVjdE1ldGFkYXRhOiB7IFtrZXk6IHN0cmluZ106IE9iamVjdFByb3BNZXRhZGF0YSB9KSB7XG4gICAgT2JqZWN0LmtleXMobmdPYmplY3RNZXRhZGF0YSkuZm9yRWFjaChwcm9wZXJ0eU5hbWUgPT4ge1xuICAgICAgY29uc3QgZmllbGRNZXRhZGF0YSA9IG5nT2JqZWN0TWV0YWRhdGFbcHJvcGVydHlOYW1lXSBhcyBPYmplY3RQcm9wTWV0YWRhdGE7XG4gICAgICBjb25zdCBwYXRoID0gdGhpcy5jcmVhdGVQYXRoKHByb3BlcnR5TmFtZSk7XG4gICAgICBjb25zdCBkYXRhRmllbGQgPSBmaWVsZE1ldGFkYXRhLmRhdGFGaWVsZCB8fCBwcm9wZXJ0eU5hbWU7XG5cbiAgICAgIC8vIHZhbOS4jeWtmOWcqOaXtu+8jOeUqOepuuWvueixoeS7o+abv1xuICAgICAgY29uc3QgdmFsID0gdGhpcy5kYXRhW2RhdGFGaWVsZF0gfHwge307XG5cbiAgICAgIGNvbnN0IGNyZWF0ZUVudGl0eUZyb21Kc29uRGF0YSA9ICh2YWx1ZTogYW55KSA9PiB7XG4gICAgICAgIGxldCBpbnN0YW5jZTtcbiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgZmllbGRNZXRhZGF0YS50eXBlKSB7XG4gICAgICAgICAgaW5zdGFuY2UgPSB2YWx1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpbnN0YW5jZSA9IEVudGl0eUZhY3RvcnkoZmllbGRNZXRhZGF0YS50eXBlLCB2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgaW5zdGFuY2VbUEFSRU5UX0NMQVNTXSA9IHRoaXM7XG4gICAgICAgIGluc3RhbmNlW1BBUkVOVF9QQVRIXSA9IHBhdGg7XG5cbiAgICAgICAgaW5zdGFuY2Uub25WYWx1ZUNoYW5nZWQuc3Vic2NyaWJlKGNoYW5nZXMgPT4ge1xuICAgICAgICAgIGlmIChjaGFuZ2VzKSB7XG4gICAgICAgICAgICBjaGFuZ2VzLnBhdGggPSAodGhpc1tQQVJFTlRfUEFUSF0gfHwgW10pLmNvbmNhdChjaGFuZ2VzLnBhdGgpO1xuICAgICAgICAgICAgdGhpcy5zZXRDaGFuZ2VzKGNoYW5nZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGluc3RhbmNlO1xuICAgICAgfTtcblxuICAgICAgLy8g5aaC5p6c5rKh5pyJ5YC855So5LiA5Liq56m65a+56LGh5Luj5pu/XG4gICAgICBsZXQgY2hpbGRFbnRpdHkgPSBjcmVhdGVFbnRpdHlGcm9tSnNvbkRhdGEodmFsKTtcbiAgICAgIGlmIChkZWxldGUgdGhpc1twcm9wZXJ0eU5hbWVdKSB7XG4gICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBwcm9wZXJ0eU5hbWUsIHtcbiAgICAgICAgICBnZXQ6ICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBjaGlsZEVudGl0eTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlOiBhbnkpIHtcbiAgICAgICAgICAgIGNvbnN0IG1vZGlmeUluZm8gPSB7XG4gICAgICAgICAgICAgIHBhdGg6IGNoaWxkRW50aXR5W1BBUkVOVF9QQVRIXSxcbiAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLmRhdGEsXG4gICAgICAgICAgICAgIHByZVZhbHVlOiB0aGlzW3Byb3BlcnR5TmFtZV0uZGF0YSxcbiAgICAgICAgICAgICAgdHlwZTogTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNoaWxkRW50aXR5ID0gY3JlYXRlRW50aXR5RnJvbUpzb25EYXRhKHZhbHVlKTtcbiAgICAgICAgICAgIHRoaXMuc2V0Q2hhbmdlcyhtb2RpZnlJbmZvKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdGlhbGl6ZUR5bmFtaWMobmdEeW5hbWljTWV0YWRhdGE6IHsgW2tleTogc3RyaW5nXTogRHluYW1pY1Byb3BNZXRhZGF0YSB9KSB7XG4gICAgT2JqZWN0LmtleXMobmdEeW5hbWljTWV0YWRhdGEpLmZvckVhY2gocHJvcGVydHlOYW1lID0+IHtcbiAgICAgIGNvbnN0IGZpZWxkTWV0YWRhdGEgPSBuZ0R5bmFtaWNNZXRhZGF0YVtwcm9wZXJ0eU5hbWVdIGFzIER5bmFtaWNQcm9wTWV0YWRhdGE7XG4gICAgICBjb25zdCBwYXRoID0gdGhpcy5jcmVhdGVQYXRoKHByb3BlcnR5TmFtZSk7XG4gICAgICBjb25zdCBkYXRhRmllbGQgPSBmaWVsZE1ldGFkYXRhLmRhdGFGaWVsZCB8fCBwcm9wZXJ0eU5hbWU7XG5cbiAgICAgIGNvbnN0IG9yaWdpbmFsRGF0YSA9IHRoaXMuZGF0YVtkYXRhRmllbGRdIHx8IHt9O1xuXG4gICAgICBjb25zdCBjcmVhdGVFbnRpdHlGcm9tSnNvbkRhdGEgPSAodmFsdWU6IGFueSkgPT4ge1xuICAgICAgICBsZXQgaW5zdGFuY2U7XG4gICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGZpZWxkTWV0YWRhdGEudHlwZSkge1xuICAgICAgICAgIGluc3RhbmNlID0gdmFsdWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaW5zdGFuY2UgPSBFbnRpdHlGYWN0b3J5KGZpZWxkTWV0YWRhdGEudHlwZSwgdmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIGluc3RhbmNlW1BBUkVOVF9DTEFTU10gPSB0aGlzO1xuICAgICAgICBpbnN0YW5jZVtQQVJFTlRfUEFUSF0gPSBwYXRoO1xuXG4gICAgICAgIGluc3RhbmNlLm9uVmFsdWVDaGFuZ2VkLnN1YnNjcmliZShjaGFuZ2VzID0+IHtcbiAgICAgICAgICBpZiAoY2hhbmdlcykge1xuICAgICAgICAgICAgY2hhbmdlcy5wYXRoID0gKHRoaXNbUEFSRU5UX1BBVEhdIHx8IFtdKS5jb25jYXQoY2hhbmdlcy5wYXRoKTtcbiAgICAgICAgICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBpbnN0YW5jZTtcbiAgICAgIH07XG5cbiAgICAgIGxldCBkeW5hbWljRW50aXR5ID0gY3JlYXRlRW50aXR5RnJvbUpzb25EYXRhKG9yaWdpbmFsRGF0YSk7XG4gICAgICBpZiAoZGVsZXRlIHRoaXNbcHJvcGVydHlOYW1lXSkge1xuICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgcHJvcGVydHlOYW1lLCB7XG4gICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gZHluYW1pY0VudGl0eTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgICAgICBjb25zdCBtb2RpZnlJbmZvID0ge1xuICAgICAgICAgICAgICBwYXRoOiBkeW5hbWljRW50aXR5W1BBUkVOVF9QQVRIXSxcbiAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLmRhdGEsXG4gICAgICAgICAgICAgIHByZVZhbHVlOiB0aGlzW3Byb3BlcnR5TmFtZV0uZGF0YSxcbiAgICAgICAgICAgICAgdHlwZTogTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGR5bmFtaWNFbnRpdHkgPSBjcmVhdGVFbnRpdHlGcm9tSnNvbkRhdGEodmFsdWUpO1xuICAgICAgICAgICAgdGhpcy5zZXRDaGFuZ2VzKG1vZGlmeUluZm8pO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLy8jZW5kcmVnaW9uXG5cblxuICAvLyAjcmVnaW9uIOWKoOi9veWunuS9k+aVsOaNruebuOWFs3ByaXZhdGXjgIFwcm9qZWN0ZWTmlrnms5VcblxuICAvKipcbiAgICog5Yqg6L29566A5Y2V5a2X5q615YC8XG4gICAqIEB0b2RvIOS4tOaXtueUqOS/ruaUueeahOaWueW8j+aooeaLn1xuICAgKi9cbiAgcHJvdGVjdGVkIGxvYWRGaWVsZHMoZGF0YTogYW55KSB7XG4gICAgY29uc3QgbmdGaWVsZHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0ZpZWxkcyh0aGlzLmNvbnN0cnVjdG9yKTtcbiAgICBPYmplY3Qua2V5cyhuZ0ZpZWxkcykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgbmdGaWVsZCA9IG5nRmllbGRzW3Byb3BOYW1lXTtcbiAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IG5nRmllbGQuZGF0YUZpZWxkIHx8IHByb3BOYW1lO1xuICAgICAgLy8gaWYgKG5nRmllbGQucHJpbWFyeSA9PT0gZmFsc2UpIHtcbiAgICAgIC8vICAgdGhpc1twcm9wTmFtZV0gPSBkYXRhW2RhdGFGaWVsZF07XG4gICAgICAvLyB9XG4gICAgICB0aGlzW3Byb3BOYW1lXSA9IGRhdGFbZGF0YUZpZWxkXTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDliqDovb3lrZDliJfooajmlbDmja5cbiAgICogQHBhcmFtIGRhdGEg5pWw5o2uXG4gICAqL1xuICBwcm90ZWN0ZWQgbG9hZExpc3RzKGRhdGE6IGFueSkge1xuICAgIGNvbnN0IG5nTGlzdHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0xpc3QodGhpcy5jb25zdHJ1Y3Rvcik7XG4gICAgT2JqZWN0LmtleXMobmdMaXN0cykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgbmdMaXN0ID0gbmdMaXN0c1twcm9wTmFtZV07XG4gICAgICBjb25zdCBkYXRhRmllbGQgPSBuZ0xpc3QuZGF0YUZpZWxkIHx8IHByb3BOYW1lO1xuICAgICAgY29uc3QgZW50aXR5VHlwZSA9IG5nTGlzdC50eXBlO1xuXG4gICAgICAvLyDliJvlu7rlrp7kvZNcbiAgICAgIGNvbnN0IGxpc3REYXRhID0gZGF0YVtkYXRhRmllbGRdO1xuICAgICAgaWYgKGxpc3REYXRhKSB7XG4gICAgICAgIGNvbnN0IGVudGl0aWVzID0gbGlzdERhdGEubWFwKChlbnRpdHlEYXRhOiBhbnkpID0+IHtcbiAgICAgICAgICByZXR1cm4gRW50aXR5RmFjdG9yeTx0eXBlb2YgZW50aXR5VHlwZT4oZW50aXR5VHlwZSwgZW50aXR5RGF0YSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzW3Byb3BOYW1lXS5sb2FkRW50aXRpZXMoZW50aXRpZXMpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpc1twcm9wTmFtZV0ubG9hZEVudGl0aWVzKFtdKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZE9iamVjdHMoZGF0YTogYW55KSB7XG4gICAgY29uc3QgbmdPYmplY3RzID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdPYmplY3RzKHRoaXMuY29uc3RydWN0b3IpO1xuICAgIE9iamVjdC5rZXlzKG5nT2JqZWN0cykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgbmdPYmplY3QgPSBuZ09iamVjdHNbcHJvcE5hbWVdO1xuICAgICAgY29uc3QgZGF0YUZpZWxkID0gbmdPYmplY3QuZGF0YUZpZWxkIHx8IHByb3BOYW1lO1xuICAgICAgY29uc3Qgb2JqZWN0RGF0YSA9IGRhdGFbZGF0YUZpZWxkXTtcbiAgICAgIGNvbnN0IGVudGl0eSA9IHRoaXNbcHJvcE5hbWVdIGFzIEVudGl0eTtcbiAgICAgIGlmICghZW50aXR5IHx8ICFvYmplY3REYXRhKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGVudGl0eS5sb2FkKG9iamVjdERhdGEpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJvdGVjdGVkIGxvYWREeW5hbWljT2JqZWN0cyhkYXRhOiBhbnkpIHtcbiAgICBjb25zdCBuZ0R5bmFtaWNPYmplY3RzID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdEeW5hbWljKHRoaXMuY29uc3RydWN0b3IpO1xuICAgIE9iamVjdC5rZXlzKG5nRHluYW1pY09iamVjdHMpLmZvckVhY2goKHByb3BOYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgIGNvbnN0IG5nRHluYW1pY09iamVjdCA9IG5nRHluYW1pY09iamVjdHNbcHJvcE5hbWVdO1xuICAgICAgY29uc3QgZGF0YUZpZWxkID0gbmdEeW5hbWljT2JqZWN0LmRhdGFGaWVsZCB8fCBwcm9wTmFtZTtcblxuICAgICAgY29uc3QgZHluYW1pY0RhdGEgPSBkYXRhW2RhdGFGaWVsZF0gfHwge307XG4gICAgICBjb25zdCBkeW5hbWljRW50aXR5ID0gdGhpc1twcm9wTmFtZV0gYXMgRHluYW1pYztcbiAgICAgIGlmICghZHluYW1pY0VudGl0eSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBkeW5hbWljRW50aXR5LmxvYWREeW5hbWljRGF0YShkeW5hbWljRGF0YSk7XG4gICAgfSk7XG4gIH1cblxuICAvLyAjZW5kcmVnaW9uXG5cbiAgLy8gI3JlZ2lvbiDnp4HmnInlt6Xlhbfmlrnms5VcblxuXG4gIC8qKlxuICAgKiDlj5HpgIHlgLzlj5jmm7RcbiAgICovXG4gIHByaXZhdGUgZW1pdFZhbHVlQ2hhbmdlKHByb3BOYW1lOiBzdHJpbmcsIHByb3BNZXRhZGF0YTogUHJpbWl0aXZlUHJvcE1ldGFkYXRhLCBuZXdQcm9wVmFsdWU6IGFueSwgb2xkUHJvcFZhbHVlOiBhbnkpOiB2b2lkIHtcbiAgICBjb25zdCBjaGFuZ2UgPSB7XG4gICAgICBwYXRoOiB0aGlzLmNyZWF0ZVBhdGgocHJvcE5hbWUpLFxuICAgICAgdmFsdWU6IG5ld1Byb3BWYWx1ZSxcbiAgICAgIHByZVZhbHVlOiBvbGRQcm9wVmFsdWUsXG4gICAgICB0eXBlOiBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlXG4gICAgfTtcblxuICAgIGlmICh0aGlzW1BBUkVOVF9QQVRIXSkge1xuICAgICAgY2hhbmdlLnBhdGggPSB0aGlzW1BBUkVOVF9QQVRIXS5jb25jYXQoY2hhbmdlLnBhdGgpO1xuICAgIH1cbiAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5blsZ7mgKflgLxcbiAgICovXG4gIHByaXZhdGUgZ2V0UHJvcFZhbHVlKHByb3BOYW1lOiBzdHJpbmcsIHByb3BNZXRhZGF0YTogUHJpbWl0aXZlUHJvcE1ldGFkYXRhKSB7XG4gICAgY29uc3QgZGF0YUZpZWxkID0gcHJvcE1ldGFkYXRhLmRhdGFGaWVsZCB8fCBwcm9wTmFtZTtcbiAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZGF0YVtkYXRhRmllbGRdO1xuXG4gICAgLy8g5a+55aSa6K+t5b2V5YWl5a2X5q6177yMcXVlcnnkuI3ov5Tlm57pl67popjov5vooYzlhbzlrrlcbiAgICBpZiAocHJvcE1ldGFkYXRhLmVuYWJsZU11bHRpTGFuZ0lucHV0ID09PSB0cnVlICYmICF2YWx1ZSkge1xuICAgICAgY29uc3QgbGFuZ0NvZGUgPSB3aW5kb3cubG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2xhbmd1YWdlQ29kZScpIHx8ICd6aC1DSFMnO1xuICAgICAgY29uc3Qgb3JpZ2luRGF0YUZpZWxkID0gZGF0YUZpZWxkLnJlcGxhY2UoJ19NVUxUSUxBTkdVQUdFJywgJycpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgW2xhbmdDb2RlXTogdGhpcy5kYXRhW29yaWdpbkRhdGFGaWVsZF1cbiAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiDorr7nva7lsZ7mgKflgLxcbiAgICovXG4gIHByaXZhdGUgc2V0UHJvcFZhbHVlKHByb3BOYW1lOiBzdHJpbmcsIHByb3BNZXRhZGF0YTogUHJpbWl0aXZlUHJvcE1ldGFkYXRhLCBwcm9wVmFsdWU6IGFueSkge1xuICAgIGNvbnN0IGRhdGFGaWVsZCA9IHByb3BNZXRhZGF0YS5kYXRhRmllbGQgfHwgcHJvcE5hbWU7XG4gICAgdGhpcy5kYXRhW2RhdGFGaWVsZF0gPSBwcm9wVmFsdWU7XG4gIH1cblxuICAvKipcbiAgICog5qOA5p+l5bGe5oCn5YC85piv5ZCm5Y+R55Sf5Y+Y5YyWXG4gICAqL1xuICBwcml2YXRlIGlzUHJvcFZhbHVlQ2hhbmdlZChwcm9wTmFtZTogc3RyaW5nLCBwcm9wTWV0YWRhdGE6IFByaW1pdGl2ZVByb3BNZXRhZGF0YSwgbmV3UHJvcFZhbHVlOiBhbnksIG9sZFByb3BWYWx1ZTogYW55KSB7XG4gICAgaWYgKHByb3BNZXRhZGF0YS5lbmFibGVNdWx0aUxhbmdJbnB1dCA9PT0gdHJ1ZSkge1xuICAgICAgaWYgKHRoaXMuaXNFbXB0eU11bHRpTGFuZ1Byb3BWYWx1ZShuZXdQcm9wVmFsdWUpID09PSB0cnVlICYmIHRoaXMuaXNFbXB0eU11bHRpTGFuZ1Byb3BWYWx1ZShvbGRQcm9wVmFsdWUpID09PSB0cnVlKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShuZXdQcm9wVmFsdWUpICE9PSBKU09OLnN0cmluZ2lmeShvbGRQcm9wVmFsdWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbmV3UHJvcFZhbHVlICE9PSBvbGRQcm9wVmFsdWU7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOWkmuivreW9leWFpeWtl+auteeahOWAvOaYr+WQpuS4uuepulxuICAgKi9cbiAgcHJpdmF0ZSBpc0VtcHR5TXVsdGlMYW5nUHJvcFZhbHVlKHZhbHVlOiBhbnkpIHtcbiAgICByZXR1cm4gIXZhbHVlIHx8IE9iamVjdC5rZXlzKHZhbHVlKS5sZW5ndGggPT09IDA7XG4gIH1cblxuICAvLyAjZW5kcmVnaW9uXG59XG4iXX0=