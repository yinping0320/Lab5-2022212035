/*
 * @Author: Witt
 * @Date: 2018-12-07 09:05:09
 * @Last Modified by: Witt
 * @Last Modified time: 2018-12-27 20:35:02
 */
import { EntityMetadataUtil } from '../metadata/index';
import { DataPropGroup } from './data_prop_info';
/**
 * 实体类型信息
 * @todo：
 * 1、构造时不应该识别Entity模块的东西，应该是更抽象的；
 * 2、构造函数应该接收一个Builder接口，由Entity或者其他实现层来实现这个接口。
 */
class DataTypeInfo {
    /**
     * 是否为值对象
     */
    get isValueObject() {
        return !this.primaryKey;
    }
    /**
     * 构造函数
     * @todo：不应该识别
     */
    constructor(type) {
        this.type = type;
        this.primaryKey = '';
        this.foreignKey = '';
        this.propInfoMap = new Map();
        this.collectEntityInfos();
        this.collectPropInfos();
    }
    /**
     * 获取全部属性信息
     */
    getPropInfos() {
        return Array.from(this.propInfoMap.values());
    }
    /**
     * 获取全部属性的名称
     */
    getPropNames() {
        const propNames = [];
        const propInfos = this.getPropInfos();
        propInfos.forEach((propInfo) => {
            propNames.push(propInfo.name);
        });
        return propNames;
    }
    /**
     * 根据group获取属性信息数组
     */
    getPropInfosByGroup(group) {
        const allPropInfos = Array.from(this.propInfoMap.values());
        const propInfos = allPropInfos.filter((propInfo) => {
            return propInfo.group === group;
        });
        return propInfos;
    }
    /**
     * 根据group获取属性名称数组
     * @param group 属性分组
     */
    getPropNamesByGroup(group) {
        const propNames = [];
        const propInfos = this.getPropInfosByGroup(group);
        propInfos.forEach((propInfo) => {
            propNames.push(propInfo.name);
        });
        return propNames;
    }
    /**
     * 根据propName获取属性信息
     */
    getPropInfoByName(propName) {
        if (this.propInfoMap.has(propName)) {
            return this.propInfoMap.get(propName);
        }
        return null;
    }
    /**
     * 根据path获取属性信息
     */
    getPropInfoByPath(path) {
        // 先复制，防止shift方法产生污染
        const arrPath = path.concat([]);
        if (arrPath.length === 0) {
            throw Error(`属性路径不能为空`);
        }
        // 循环查找
        let typeInfo = this;
        let propInfo = null;
        while (typeInfo && arrPath.length > 0) {
            const propName = arrPath.shift();
            propInfo = typeInfo.getPropInfoByName(propName);
            if (!propInfo) {
                throw Error(`路径${path}中存在不正确的节点${propName}，请检查`);
            }
            typeInfo = propInfo.typeInfo;
            // 如果是动态列，并且路径数组里还有属性，统一设置为null(动态列不再描述属性信息)
            if (propInfo.group === DataPropGroup.Dynamic && arrPath.length > 0) {
                propInfo = null;
                typeInfo = null;
            }
        }
        return propInfo;
    }
    /**
     * 根据path获取对应属性的TypeInfo
     */
    getTypeInfoByPath(path) {
        // 空数组时返回
        if (path.length === 0) {
            return this;
        }
        // 获取对应属性信息
        const propInfo = this.getPropInfoByPath(path);
        if (!propInfo.typeInfo) {
            throw Error(`路径${path}无法定位到一个EntityTypeInfo，请检查`);
        }
        return propInfo.typeInfo;
    }
    /**
     * 获取主键的属性信息
     */
    getPrimaryKeyPropInfo() {
        return this.getPropInfoByName(this.primaryKey);
    }
    /**
     * 根据name获取影射名
     */
    getPropMappingByName(name) {
        const propInfo = this.getPropInfoByName(name);
        if (!propInfo) {
            return '';
        }
        return propInfo.mapping;
    }
    /**
     * 根据path获取映射名
     */
    getPropMappingByPath(path) {
        const propInfo = this.getPropInfoByPath(path);
        if (!propInfo) {
            return '';
        }
        return propInfo.mapping;
    }
    /**
     * 检查属性是否属于特定的分组
     */
    checkPropGroup(propName, propGroup) {
        const propInfo = this.getPropInfoByName(propName);
        if (propInfo && propInfo.group === propGroup) {
            return true;
        }
        return false;
    }
    /**
     * --------------------------------------------------------------------------------
     * 属性元数据 => 属性描述信息
     * --------------------------------------------------------------------------------
     */
    collectEntityInfos() {
        const entityMetadata = EntityMetadataUtil.getNgEntityMatadata(this.type);
        this.entityInfo = entityMetadata;
    }
    /**
     * 搜集所有属性信息
     * @todo：消除重复代码，ts不支持interface类型检测，暂时通过遍历实现。
     */
    collectPropInfos() {
        // 简单属性
        const ngPlainProperties = EntityMetadataUtil.getNgFieldProperties(this.type);
        Object.keys(ngPlainProperties).forEach((propName) => {
            const ngProperty = ngPlainProperties[propName];
            if (ngProperty.primary === true) {
                this.primaryKey = propName;
            }
            if (ngProperty.foreign === true) {
                this.foreignKey = propName;
            }
            this.addPropInfo(DataPropGroup.Primitive, propName, ngProperty.dataField, null, ngProperty);
        });
        // 实体属性
        const ngEntityProperties = EntityMetadataUtil.getNgObjectProperties(this.type);
        Object.keys(ngEntityProperties).forEach((propName) => {
            const ngProperty = ngEntityProperties[propName];
            this.addPropInfo(DataPropGroup.Object, propName, ngProperty.dataField, ngProperty.type, ngProperty);
        });
        // 动态实体属性
        const ngDynamicProperties = EntityMetadataUtil.getNgDynamicProperties(this.type);
        Object.keys(ngDynamicProperties).forEach((propName) => {
            const ngProperty = ngDynamicProperties[propName];
            this.addPropInfo(DataPropGroup.Dynamic, propName, ngProperty.dataField, null, ngProperty);
        });
        // 实体列表属性
        const ngEntityListProperties = EntityMetadataUtil.getNgListProperties(this.type);
        Object.keys(ngEntityListProperties).forEach((propName) => {
            const ngProperty = ngEntityListProperties[propName];
            this.addPropInfo(DataPropGroup.List, propName, ngProperty.dataField, ngProperty.type, ngProperty);
        });
    }
    /**
     * 添加属性信息
     */
    addPropInfo(group, name, mapping, type, metadataInfo) {
        // 没有设置影射时，用属性名充当影射
        mapping = mapping ? mapping : name;
        let typeInfo = null;
        if (type) {
            typeInfo = new DataTypeInfo(type);
        }
        const propInfo = { group, name, mapping, typeInfo, metadataInfo };
        this.propInfoMap.set(name, propInfo);
    }
}
export { DataTypeInfo };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YV90eXBlX2luZm8uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZW50aXR5L2VudGl0eS10eXBlLWluZm8vZGF0YV90eXBlX2luZm8udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7O0dBS0c7QUFHSCxPQUFPLEVBRUwsa0JBQWtCLEVBQ25CLE1BQU0sbUJBQW1CLENBQUM7QUFDM0IsT0FBTyxFQUFFLGFBQWEsRUFBZ0IsTUFBTSxrQkFBa0IsQ0FBQztBQUUvRDs7Ozs7R0FLRztBQUNILE1BQU0sWUFBWTtJQTJCaEI7O09BRUc7SUFDSCxJQUFXLGFBQWE7UUFDdEIsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDMUIsQ0FBQztJQUVEOzs7T0FHRztJQUNILFlBQVksSUFBUztRQUNuQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksR0FBRyxFQUF3QixDQUFDO1FBQ25ELElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQzFCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFRDs7T0FFRztJQUNJLFlBQVk7UUFDakIsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRUQ7O09BRUc7SUFDSSxZQUFZO1FBQ2pCLE1BQU0sU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNyQixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDdEMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFO1lBQzdCLFNBQVMsQ0FBQyxJQUFJ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QUM7UUFDbEUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7Q0FFRjtBQUVELE9BQU8sRUFBRSxZQUFZLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBAQXV0aG9yOiBXaXR0XG4gKiBARGF0ZTogMjAxOC0xMi0wNyAwOTowNTowOVxuICogQExhc3QgTW9kaWZpZWQgYnk6IFdpdHRcbiAqIEBMYXN0IE1vZGlmaWVkIHRpbWU6IDIwMTgtMTItMjcgMjA6MzU6MDJcbiAqL1xuXG5pbXBvcnQgeyBUeXBlIH0gZnJvbSAnLi4vLi4vY29yZS90eXBlcyc7XG5pbXBvcnQge1xuICBFbnRpdHlNZXRhZGF0YSwgUHJvcE1ldGFkYXRhLCBQcmltaXRpdmVQcm9wTWV0YWRhdGEsIE9iamVjdFByb3BNZXRhZGF0YSwgRHluYW1pY1Byb3BNZXRhZGF0YSwgTGlzdFByb3BNZXRhZGF0YSxcbiAgRW50aXR5TWV0YWRhdGFVdGlsXG59IGZyb20gJy4uL21ldGFkYXRhL2luZGV4JztcbmltcG9ydCB7IERhdGFQcm9wR3JvdXAsIERhdGFQcm9wSW5mbyB9IGZyb20gJy4vZGF0YV9wcm9wX2luZm8nO1xuXG4vKipcbiAqIOWunuS9k+exu+Wei+S/oeaBr1xuICogQHRvZG/vvJpcbiAqIDHjgIHmnoTpgKDml7bkuI3lupTor6Xor4bliKtFbnRpdHnmqKHlnZfnmoTkuJzopb/vvIzlupTor6XmmK/mm7Tmir3osaHnmoTvvJtcbiAqIDLjgIHmnoTpgKDlh73mlbDlupTor6XmjqXmlLbkuIDkuKpCdWlsZGVy5o6l5Y+j77yM55SxRW50aXR55oiW6ICF5YW25LuW5a6e546w5bGC5p2l5a6e546w6L+Z5Liq5o6l5Y+j44CCXG4gKi9cbmNsYXNzIERhdGFUeXBlSW5mbyB7XG5cbiAgLyoqXG4gICAqIOWunuS9k+aPj+i/sOWFg+aVsOaNrlxuICAgKi9cbiAgcHVibGljIGVudGl0eUluZm86IEVudGl0eU1ldGFkYXRhO1xuXG4gIC8qKlxuICAgKiDmlbDmja7nsbvlnotcbiAgICovXG4gIHB1YmxpYyB0eXBlOiBUeXBlPGFueT47XG5cbiAgLyoqXG4gICAqIOWxnuaAp+mbhuWQiFxuICAgKi9cbiAgcHVibGljIHByb3BJbmZvTWFwOiBNYXA8c3RyaW5nLCBEYXRhUHJvcEluZm8+O1xuXG4gIC8qKlxuICAgKiDkuLvplK5cbiAgICovXG4gIHB1YmxpYyBwcmltYXJ5S2V5OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIOWklumUrlxuICAgKi9cbiAgcHVibGljIGZvcmVpZ25LZXk6IHN0cmluZztcblxuICAvKipcbiAgICog5piv5ZCm5Li65YC85a+56LGhXG4gICAqL1xuICBwdWJsaWMgZ2V0IGlzVmFsdWVPYmplY3QoKSB7XG4gICAgcmV0dXJuICF0aGlzLnByaW1hcnlLZXk7XG4gIH1cblxuICAvKipcbiAgICog5p6E6YCg5Ye95pWwXG4gICAqIEB0b2Rv77ya5LiN5bqU6K+l6K+G5YirXG4gICAqL1xuICBjb25zdHJ1Y3Rvcih0eXBlOiBhbnkpIHtcbiAgICB0aGlzLnR5cGUgPSB0eXBlO1xuICAgIHRoaXMucHJpbWFyeUtleSA9ICcnO1xuICAgIHRoaXMuZm9yZWlnbktleSA9ICcnO1xuICAgIHRoaXMucHJvcEluZm9NYXAgPSBuZXcgTWFwPHN0cmluZywgRGF0YVByb3BJbmZvPigpO1xuICAgIHRoaXMuY29sbGVjdEVudGl0eUluZm9zKCk7XG4gICAgdGhpcy5jb2xsZWN0UHJvcEluZm9zKCk7XG4gIH1cblxuICAvKipcbiAgICog6I635Y+W5YWo6YOo5bGe5oCn5L+h5oGvXG4gICAqL1xuICBwdWJsaWMgZ2V0UHJvcEluZm9zKCk6IERhdGFQcm9wSW5mb1tdIHtcbiAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLnByb3BJbmZvTWFwLnZhbHVlcygpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5blhajpg6jlsZ7mgKfnmoTlkI3np7BcbiAgICovXG4gIHB1YmxpYyBnZXRQcm9wTmFtZXMoKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IHByb3BOYW1lcyA9IFtdO1xuICAgIGNvbnN0IHByb3BJbmZvcyA9IHRoaXMuZ2V0UHJvcEluZm9zKCk7XG4gICAgcHJvcEluZm9zLmZvckVhY2goKHByb3BJbmZvKSA9PiB7XG4gICAgICBwcm9wTmFtZXMucHVzaChwcm9wSW5mby5uYW1lKTtcbiAgICB9KTtcbiAgICByZXR1cm4gcHJvcE5hbWVzO1xuICB9XG5cbiAgLyoqXG4gICAqIOagueaNrmdyb3Vw6I635Y+W5bGe5oCn5L+h5oGv5pWw57uEXG4gICAqL1xuICBwdWJsaWMgZ2V0UHJvcEluZm9zQnlHcm91cChncm91cDogRGF0YVByb3BHcm91cCk6IERhdGFQcm9wSW5mb1tdIHtcbiAgICBjb25zdCBhbGxQcm9wSW5mb3MgPSBBcnJheS5mcm9tKHRoaXMucHJvcEluZm9NYXAudmFsdWVzKCkpO1xuICAgIGNvbnN0IHByb3BJbmZvcyA9IGFsbFByb3BJbmZvcy5maWx0ZXIoKHByb3BJbmZvOiBEYXRhUHJvcEluZm8pID0+IHtcbiAgICAgIHJldHVybiBwcm9wSW5mby5ncm91cCA9PT0gZ3JvdXA7XG4gICAgfSk7XG4gICAgcmV0dXJuIHByb3BJbmZvcztcbiAgfVxuXG4gIC8qKlxuICAgKiDmoLnmja5ncm91cOiOt+WPluWxnuaAp+WQjeensOaVsOe7hFxuICAgKiBAcGFyYW0gZ3JvdXAg5bGe5oCn5YiG57uEXG4gICAqL1xuICBwdWJsaWMgZ2V0UHJvcE5hbWVzQnlHcm91cChncm91cDogRGF0YVByb3BHcm91cCk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCBwcm9wTmFtZXMgPSBbXTtcbiAgICBjb25zdCBwcm9wSW5mb3MgPSB0aGlzLmdldFByb3BJbmZvc0J5R3JvdXAoZ3JvdXApO1xuICAgIHByb3BJbmZvcy5mb3JFYWNoKChwcm9wSW5mbykgPT4ge1xuICAgICAgcHJvcE5hbWVzLnB1c2gocHJvcEluZm8ubmFtZSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHByb3BOYW1lcztcbiAgfVxuXG4gIC8qKlxuICAgKiDmoLnmja5wcm9wTmFtZeiOt+WPluWxnuaAp+S/oeaBr1xuICAgKi9cbiAgcHVibGljIGdldFByb3BJbmZvQnlOYW1lKHByb3BOYW1lOiBzdHJpbmcpOiBEYXRhUHJvcEluZm8ge1xuICAgIGlmICh0aGlzLnByb3BJbmZvTWFwLmhhcyhwcm9wTmFtZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLnByb3BJbmZvTWFwLmdldChwcm9wTmFtZSk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIOagueaNrnBhdGjojrflj5blsZ7mgKfkv6Hmga9cbiAgICovXG4gIHB1YmxpYyBnZXRQcm9wSW5mb0J5UGF0aChwYXRoOiBzdHJpbmdbXSk6IERhdGFQcm9wSW5mbyB7XG5cbiAgICAvLyDlhYjlpI3liLbvvIzpmLLmraJzaGlmdOaWueazleS6p+eUn+axoeafk1xuICAgIGNvbnN0IGFyclBhdGggPSBwYXRoLmNvbmNhdChbXSk7XG4gICAgaWYgKGFyclBhdGgubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBFcnJvcihg5bGe5oCn6Lev5b6E5LiN6IO95Li656m6YCk7XG4gICAgfVxuXG4gICAgLy8g5b6q546v5p+l5om+XG4gICAgbGV0IHR5cGVJbmZvID0gdGhpcztcbiAgICBsZXQgcHJvcEluZm8gPSBudWxsO1xuICAgIHdoaWxlICh0eXBlSW5mbyAmJiBhcnJQYXRoLmxlbmd0aCA+IDApIHtcblxuICAgICAgY29uc3QgcHJvcE5hbWUgPSBhcnJQYXRoLnNoaWZ0KCk7XG4gICAgICBwcm9wSW5mbyA9IHR5cGVJbmZvLmdldFByb3BJbmZvQnlOYW1lKHByb3BOYW1lKTtcbiAgICAgIGlmICghcHJvcEluZm8pIHtcbiAgICAgICAgdGhyb3cgRXJyb3IoYOi3r+W+hCR7cGF0aH3kuK3lrZjlnKjkuI3mraPnoa7nmoToioLngrkke3Byb3BOYW1lfe+8jOivt+ajgOafpWApO1xuICAgICAgfVxuICAgICAgdHlwZUluZm8gPSBwcm9wSW5mby50eXBlSW5mbztcblxuICAgICAgLy8g5aaC5p6c5piv5Yqo5oCB5YiX77yM5bm25LiU6Lev5b6E5pWw57uE6YeM6L+Y5pyJ5bGe5oCn77yM57uf5LiA6K6+572u5Li6bnVsbCjliqjmgIHliJfkuI3lho3mj4/ov7DlsZ7mgKfkv6Hmga8pXG4gICAgICBpZiAocHJvcEluZm8uZ3JvdXAgPT09IERhdGFQcm9wR3JvdXAuRHluYW1pYyAmJiBhcnJQYXRoLmxlbmd0aCA+IDApIHtcbiAgICAgICAgcHJvcEluZm8gPSBudWxsO1xuICAgICAgICB0eXBlSW5mbyA9IG51bGw7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHByb3BJbmZvO1xuICB9XG5cbiAgLyoqXG4gICAqIOagueaNrnBhdGjojrflj5blr7nlupTlsZ7mgKfnmoRUeXBlSW5mb1xuICAgKi9cbiAgcHVibGljIGdldFR5cGVJbmZvQnlQYXRoKHBhdGg6IHN0cmluZ1tdKTogRGF0YVR5cGVJbmZvIHtcblxuICAgIC8vIOepuuaVsOe7hOaXtui/lOWbnlxuICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLy8g6I635Y+W5a+55bqU5bGe5oCn5L+h5oGvXG4gICAgY29uc3QgcHJvcEluZm8gPSB0aGlzLmdldFByb3BJbmZvQnlQYXRoKHBhdGgpO1xuICAgIGlmICghcHJvcEluZm8udHlwZUluZm8pIHtcbiAgICAgIHRocm93IEVycm9yKGDot6/lvoQke3BhdGh95peg5rOV5a6a5L2N5Yiw5LiA5LiqRW50aXR5VHlwZUluZm/vvIzor7fmo4Dmn6VgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcHJvcEluZm8udHlwZUluZm87XG4gIH1cblxuICAvKipcbiAgICog6I635Y+W5Li76ZSu55qE5bGe5oCn5L+h5oGvXG4gICAqL1xuICBwdWJsaWMgZ2V0UHJpbWFyeUtleVByb3BJbmZvKCk6IERhdGFQcm9wSW5mbyB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UHJvcEluZm9CeU5hbWUodGhpcy5wcmltYXJ5S2V5KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmoLnmja5uYW1l6I635Y+W5b2x5bCE5ZCNXG4gICAqL1xuICBwdWJsaWMgZ2V0UHJvcE1hcHBpbmdCeU5hbWUobmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBwcm9wSW5mbyA9IHRoaXMuZ2V0UHJvcEluZm9CeU5hbWUobmFtZSk7XG4gICAgaWYgKCFwcm9wSW5mbykge1xuICAgICAgcmV0dXJuICcnO1xuICAgIH1cbiAgICByZXR1cm4gcHJvcEluZm8ubWFwcGluZztcbiAgfVxuXG4gIC8qKlxuICAgKiDmoLnmja5wYXRo6I635Y+W5pig5bCE5ZCNXG4gICAqL1xuICBwdWJsaWMgZ2V0UHJvcE1hcHBpbmdCeVBhdGgocGF0aDogc3RyaW5nW10pOiBzdHJpbmcge1xuICAgIGNvbnN0IHByb3BJbmZvID0gdGhpcy5nZXRQcm9wSW5mb0J5UGF0aChwYXRoKTtcbiAgICBpZiAoIXByb3BJbmZvKSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuICAgIHJldHVybiBwcm9wSW5mby5tYXBwaW5nO1xuICB9XG5cbiAgLyoqXG4gICAqIOajgOafpeWxnuaAp+aYr+WQpuWxnuS6jueJueWumueahOWIhue7hFxuICAgKi9cbiAgcHVibGljIGNoZWNrUHJvcEdyb3VwKHByb3BOYW1lOiBzdHJpbmcsIHByb3BHcm91cDogRGF0YVByb3BHcm91cCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHByb3BJbmZvID0gdGhpcy5nZXRQcm9wSW5mb0J5TmFtZShwcm9wTmFtZSk7XG4gICAgaWYgKHByb3BJbmZvICYmIHByb3BJbmZvLmdyb3VwID09PSBwcm9wR3JvdXApIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuXG4gIC8qKlxuICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgKiDlsZ7mgKflhYPmlbDmja4gPT4g5bGe5oCn5o+P6L+w5L+h5oGvXG4gICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAqL1xuXG4gIHByaXZhdGUgY29sbGVjdEVudGl0eUluZm9zKCkge1xuICAgIGNvbnN0IGVudGl0eU1ldGFkYXRhID0gRW50aXR5TWV0YWRhdGFVdGlsLmdldE5nRW50aXR5TWF0YWRhdGEodGhpcy50eXBlKTtcbiAgICB0aGlzLmVudGl0eUluZm8gPSBlbnRpdHlNZXRhZGF0YTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmkJzpm4bmiYDmnInlsZ7mgKfkv6Hmga9cbiAgICogQHRvZG/vvJrmtojpmaTph43lpI3ku6PnoIHvvIx0c+S4jeaUr+aMgWludGVyZmFjZeexu+Wei+ajgOa1i++8jOaaguaXtumAmui/h+mBjeWOhuWunueOsOOAglxuICAgKi9cbiAgcHJpdmF0ZSBjb2xsZWN0UHJvcEluZm9zKCkge1xuXG4gICAgLy8g566A5Y2V5bGe5oCnXG4gICAgY29uc3QgbmdQbGFpblByb3BlcnRpZXMgPSBFbnRpdHlNZXRhZGF0YVV0aWwuZ2V0TmdGaWVsZFByb3BlcnRpZXModGhpcy50eXBlKTtcbiAgICBPYmplY3Qua2V5cyhuZ1BsYWluUHJvcGVydGllcykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgbmdQcm9wZXJ0eSA9IG5nUGxhaW5Qcm9wZXJ0aWVzW3Byb3BOYW1lXSBhcyBQcmltaXRpdmVQcm9wTWV0YWRhdGE7XG4gICAgICBpZiAobmdQcm9wZXJ0eS5wcmltYXJ5ID09PSB0cnVlKSB7XG4gICAgICAgIHRoaXMucHJpbWFyeUtleSA9IHByb3BOYW1lO1xuICAgICAgfVxuICAgICAgaWYgKG5nUHJvcGVydHkuZm9yZWlnbiA9PT0gdHJ1ZSkge1xuICAgICAgICB0aGlzLmZvcmVpZ25LZXkgPSBwcm9wTmFtZTtcbiAgICAgIH1cbiAgICAgIHRoaXMuYWRkUHJvcEluZm8oRGF0YVByb3BHcm91cC5QcmltaXRpdmUsIHByb3BOYW1lLCBuZ1Byb3BlcnR5LmRhdGFGaWVsZCwgbnVsbCwgbmdQcm9wZXJ0eSk7XG4gICAgfSk7XG5cbiAgICAvLyDlrp7kvZPlsZ7mgKdcbiAgICBjb25zdCBuZ0VudGl0eVByb3BlcnRpZXMgPSBFbnRpdHlNZXRhZGF0YVV0aWwuZ2V0TmdPYmplY3RQcm9wZXJ0aWVzKHRoaXMudHlwZSk7XG4gICAgT2JqZWN0LmtleXMobmdFbnRpdHlQcm9wZXJ0aWVzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICBjb25zdCBuZ1Byb3BlcnR5ID0gbmdFbnRpdHlQcm9wZXJ0aWVzW3Byb3BOYW1lXSBhcyBPYmplY3RQcm9wTWV0YWRhdGE7XG4gICAgICB0aGlzLmFkZFByb3BJbmZvKERhdGFQcm9wR3JvdXAuT2JqZWN0LCBwcm9wTmFtZSwgbmdQcm9wZXJ0eS5kYXRhRmllbGQsIG5nUHJvcGVydHkudHlwZSwgbmdQcm9wZXJ0eSk7XG4gICAgfSk7XG5cbiAgICAvLyDliqjmgIHlrp7kvZPlsZ7mgKdcbiAgICBjb25zdCBuZ0R5bmFtaWNQcm9wZXJ0aWVzID0gRW50aXR5TWV0YWRhdGFVdGlsLmdldE5nRHluYW1pY1Byb3BlcnRpZXModGhpcy50eXBlKTtcbiAgICBPYmplY3Qua2V5cyhuZ0R5bmFtaWNQcm9wZXJ0aWVzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICBjb25zdCBuZ1Byb3BlcnR5ID0gbmdEeW5hbWljUHJvcGVydGllc1twcm9wTmFtZV0gYXMgRHluYW1pY1Byb3BNZXRhZGF0YTtcbiAgICAgIHRoaXMuYWRkUHJvcEluZm8oRGF0YVByb3BHcm91cC5EeW5hbWljLCBwcm9wTmFtZSwgbmdQcm9wZXJ0eS5kYXRhRmllbGQsIG51bGwsIG5nUHJvcGVydHkpO1xuICAgIH0pO1xuXG4gICAgLy8g5a6e5L2T5YiX6KGo5bGe5oCnXG4gICAgY29uc3QgbmdFbnRpdHlMaXN0UHJvcGVydGllcyA9IEVudGl0eU1ldGFkYXRhVXRpbC5nZXROZ0xpc3RQcm9wZXJ0aWVzKHRoaXMudHlwZSk7XG4gICAgT2JqZWN0LmtleXMobmdFbnRpdHlMaXN0UHJvcGVydGllcykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgbmdQcm9wZXJ0eSA9IG5nRW50aXR5TGlzdFByb3BlcnRpZXNbcHJvcE5hbWVdIGFzIExpc3RQcm9wTWV0YWRhdGE7XG4gICAgICB0aGlzLmFkZFByb3BJbmZvKERhdGFQcm9wR3JvdXAuTGlzdCwgcHJvcE5hbWUsIG5nUHJvcGVydHkuZGF0YUZpZWxkLCBuZ1Byb3BlcnR5LnR5cGUsIG5nUHJvcGVydHkpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIOa3u+WKoOWxnuaAp+S/oeaBr1xuICAgKi9cbiAgcHJpdmF0ZSBhZGRQcm9wSW5mbyhncm91cDogRGF0YVByb3BHcm91cCwgbmFtZTogc3RyaW5nLCBtYXBwaW5nOiBzdHJpbmcsIHR5cGU6IFR5cGU8YW55PiwgbWV0YWRhdGFJbmZvOiBQcm9wTWV0YWRhdGEpIHtcblxuICAgIC8vIOayoeacieiuvue9ruW9seWwhOaXtu+8jOeUqOWxnuaAp+WQjeWFheW9k+W9seWwhFxuICAgIG1hcHBpbmcgPSBtYXBwaW5nID8gbWFwcGluZyA6IG5hbWU7XG4gICAgbGV0IHR5cGVJbmZvID0gbnVsbDtcbiAgICBpZiAodHlwZSkge1xuICAgICAgdHlwZUluZm8gPSBuZXcgRGF0YVR5cGVJbmZvKHR5cGUpO1xuICAgIH1cbiAgICBjb25zdCBwcm9wSW5mbyA9IHsgZ3JvdXAsIG5hbWUsIG1hcHBpbmcsIHR5cGVJbmZvLCBtZXRhZGF0YUluZm8gfTtcbiAgICB0aGlzLnByb3BJbmZvTWFwLnNldChuYW1lLCBwcm9wSW5mbyk7XG4gIH1cblxufVxuXG5leHBvcnQgeyBEYXRhVHlwZUluZm8gfTtcbiJdfQ==