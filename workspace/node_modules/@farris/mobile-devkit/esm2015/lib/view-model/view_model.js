import { MetadataUtil } from '../core/index';
import { Repository } from '../repository/index';
import { CommandBus } from '../command/index';
import { BindingData } from '../binding-data/index';
import { UIState } from '../ui-state/index';
import { StateMachine } from '../state-machine/index';
import { Form } from '../form/index';
import { ViewModelContext } from './view_model_context';
import { COMMAND_METHOD_META } from './decorators';
import { EMPTY, from, of } from 'rxjs';
import { concatMap, every, tap } from 'rxjs/operators';
import { ExpressionEngineImpl, ExpressionManager, ExpressionResult, ExpressionResultFactory } from '../expression/index';
import { ControlsProxy } from '../control-proxy';
class ViewModel {
    /**
     * 构造函数
     */
    constructor(injector, id) {
        /**
         * 扩展命令
         */
        this.extendCommands = new Map();
        this.injector = injector;
        this.id = id;
    }
    /**
     * 初始化
     */
    init() {
        this.initRepository();
        this.initContext();
        this.initBindingData();
        this.initUIState();
        this.intiStateMachine();
        this.initForm();
        this.initCommandBus();
        this.registerWithParent();
        this.initListeners();
        this.closeOldBeSession();
        this.initExpression();
        this.initControlsProxy();
        this.config();
    }
    config() {
        this.uiState.config(this.context);
    }
    initControlsProxy() {
        this.controlsProxy = this.injector.get(ControlsProxy);
    }
    initRepository() {
        this.repository = this.injector.get(Repository);
    }
    initContext() {
        this.context = this.injector.get(ViewModelContext);
        this.context.init(this);
    }
    initExpression() {
        const appContext = this.context.appContext;
        const allViewModelContexts = appContext.viewModelContextManager.getContexts();
        const existedViewModelContext = allViewModelContexts.find((viewModelContext) => {
            if (viewModelContext.expressionEngineImpl) {
                return true;
            }
            else {
                return false;
            }
        });
        if (existedViewModelContext) {
            this.expressionEngineImpl = existedViewModelContext.expressionEngineImpl;
            this.expressionManager = existedViewModelContext.expressionManager;
            this.expressionResult = existedViewModelContext.expressionResult;
            return;
        }
        this.expressionEngineImpl = this.injector.get(ExpressionEngineImpl, null);
        this.expressionManager = this.injector.get(ExpressionManager, null);
        const expressionResultFactory = this.injector.get(ExpressionResultFactory, null);
        this.expressionResult = this.injector.get(ExpressionResult, null);
    }
    initBindingData() {
        this.bindingData = this.context.injector.get(BindingData);
        this.entityValueChangingListeners = new Map();
        this.entityValueChangedListeners = new Map();
        if (this.bindingData) {
            this.bindingData.setValueChangeInvokerFactory((paths) => {
                return (preValue, value, entityChanged, primaryValue) => {
                    const plainPath = '/' + paths.join('/');
                    let command;
                    if (entityChanged === false) {
                        command = this.entityValueChangingListeners[plainPath];
                    }
                    else {
                        command = this.entityValueChangedListeners[plainPath];
                    }
                    if (!!command) {
                        const change = {
                            paths: paths,
                            preValue: preValue,
                            value: value,
                            changed: entityChanged
                        };
                        const commands = command.split(';').filter(p => p);
                        let valueChangeSuccess = true;
                        return from(commands).pipe(concatMap(item => {
                            if (!valueChangeSuccess) {
                                return EMPTY;
                            }
                            return this[item](change).pipe(tap((result) => {
                                valueChangeSuccess = result;
                            }));
                        }), every((result) => result));
                    }
                    else {
                        return of(true);
                    }
                };
            });
        }
        const repositoryName = this.repository.name;
        const bindingDataManager = this.context.appContext.bindingDataManager;
        const repositoryBindingData = bindingDataManager.getBindingDataByName(repositoryName);
        this.bindingData.initByBindingList(repositoryBindingData.list, this.context, repositoryBindingData.dataTypeInfo);
    }
    initUIState() {
        this.uiState = this.injector.get(UIState);
    }
    intiStateMachine() {
        this.stateMachine = this.injector.get(StateMachine, null);
        if (!this.stateMachine) {
            return;
        }
        this.stateMachine.init(this.context);
    }
    initForm() {
        this.form = this.injector.get(Form, null);
        this.form.init();
    }
    initCommandBus() {
        this.commandBus = this.injector.get(CommandBus);
        this.extendCommandMethods();
    }
    extendCommandMethods() {
        this.ngCommands = MetadataUtil.getPropsMetadatasByName(this.constructor, COMMAND_METHOD_META);
        this.keybindingMap = new Map();
        Object.keys(this.ngCommands).forEach((propName) => {
            const ngCommand = this.ngCommands[propName];
            Object.defineProperty(this, propName, {
                value: (eventParams) => {
                    const command = {
                        name: ngCommand.name,
                        params: ngCommand.params,
                        paramDescriptions: ngCommand.paramDescriptions,
                        eventParam: eventParams || null
                    };
                    return this.commandBus.dispatch(command);
                }
            });
            if (ngCommand.keyBinding) {
                this.keybindingMap.set(propName, ngCommand.keyBinding);
            }
        });
    }
    /**
     * 注册扩展命令方法
     */
    registerExtendCommand(commandName, commandHandler) {
        Object.defineProperty(this, commandName, {
            value: (eventParams) => {
                return commandHandler(eventParams, this.context);
            }
        });
        this.extendCommands.set(commandName, commandHandler);
    }
    registerWithParent() {
        const parentContext = this.context.parent;
        if (!parentContext || !parentContext.viewModel || !parentContext.viewModel['childViewModels']) {
            return;
        }
        const parentViewModel = parentContext.viewModel;
        const className = this.constructor.name;
        const propName = parentViewModel['childViewModels'][className];
        parentViewModel[propName] = this;
    }
    /**
     * 关闭老的BeSession
     */
    closeOldBeSession() {
        const allViewModelContexts = this.context.appContext.viewModelContextManager.getContexts();
        if (allViewModelContexts.length === 1 && allViewModelContexts[0] === this.context) {
            this.context.repository.reset();
        }
    }
    /**
   * 从Form获取监听器
   */
    initListeners() {
        const extractPath = (bindingBasePath, bindingPath) => {
            return '/' + bindingBasePath.split('/').concat(bindingPath.split('.')).filter((item) => item.length > 0).join('/');
        };
        if (this.form) {
            const valueChangingListeners = this.form.getEntityValueChangingListeners();
            Object.keys(valueChangingListeners).forEach((bindingPath) => {
                const plainPath = extractPath(this.bindingPath, bindingPath);
                this.entityValueChangingListeners[plainPath] = valueChangingListeners[bindingPath];
            });
            const valueChangedListeners = this.form.getEntityValueChangedListeners();
            Object.keys(valueChangedListeners).forEach((bindingPath) => {
                const plainPath = extractPath(this.bindingPath, bindingPath);
                this.entityValueChangedListeners[plainPath] = valueChangedListeners[bindingPath];
            });
        }
    }
}
export { ViewModel };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld19tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi92aWV3LW1vZGVsL3ZpZXdfbW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUc3QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDakQsT0FBTyxFQUFXLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxXQUFXLEVBQTBDLE1BQU0sdUJBQXVCLENBQUM7QUFDNUYsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRXhELE9BQU8sRUFBRSxtQkFBbUIsRUFBcUMsTUFBTSxjQUFjLENBQUM7QUFDdEYsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXZELE9BQU8sRUFDTCxvQkFBb0IsRUFBRSxpQkFBaUIsRUFBRSxnQkFBZ0IsRUFBRSx1QkFBdUIsRUFDbkYsTUFBTSxxQkFBcUIsQ0FBQztBQUM3QixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFakQsTUFBZSxTQUFTO0lBMEZ0Qjs7T0FFRztJQUNILFlBQW1CLFFBQWtCLEVBQUUsRUFBVTtRQXRGakQ7O1dBRUc7UUFDSSxtQkFBYyxHQUFxQixJQUFJLEdBQUcsRUFBZSxDQUFDO1FBb0YvRCxJQUFJLENB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LEVBQUUsQ0FBQztZQUN6RSxNQUFNLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsV0FBVyxFQUFFLEVBQUU7Z0JBQ3pELE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUFDO2dCQUM3RCxJQUFJLENBQUMsMkJBQTJCLENBQUMsU0FBUyxDQUFDLEdBQUcscUJBQXFCLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDbkYsQ0FBQyxDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7Q0FFRjtBQUVELE9BQU8sRUFBRSxTQUFTLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1ldGFkYXRhVXRpbCB9IGZyb20gJy4uL2NvcmUvaW5kZXgnO1xuaW1wb3J0IHsgSW5qZWN0b3IgfSBmcm9tICcuLi9jb3JlL2luZGV4JztcbmltcG9ydCB7IEVudGl0eSB9IGZyb20gJy4uL2VudGl0eS9pbmRleCc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAnLi4vcmVwb3NpdG9yeS9pbmRleCc7XG5pbXBvcnQgeyBDb21tYW5kLCBDb21tYW5kQnVzIH0gZnJvbSAnLi4vY29tbWFuZC9pbmRleCc7XG5pbXBvcnQgeyBCaW5kaW5nRGF0YSwgRW50aXR5VmFsdWVDaGFuZ2UsIEludm9rZU9uVmFsdWVDaGFuZ2UgfSBmcm9tICcuLi9iaW5kaW5nLWRhdGEvaW5kZXgnO1xuaW1wb3J0IHsgVUlTdGF0ZSB9IGZyb20gJy4uL3VpLXN0YXRlL2luZGV4JztcbmltcG9ydCB7IFN0YXRlTWFjaGluZSB9IGZyb20gJy4uL3N0YXRlLW1hY2hpbmUvaW5kZXgnO1xuaW1wb3J0IHsgRm9ybSB9IGZyb20gJy4uL2Zvcm0vaW5kZXgnO1xuaW1wb3J0IHsgVmlld01vZGVsQ29udGV4dCB9IGZyb20gJy4vdmlld19tb2RlbF9jb250ZXh0JztcblxuaW1wb3J0IHsgQ09NTUFORF9NRVRIT0RfTUVUQSwgQ29tbWFuZE1ldGhvZE1ldGFkYXRhLCBLZXliaW5kaW5nIH0gZnJvbSAnLi9kZWNvcmF0b3JzJztcbmltcG9ydCB7IEVNUFRZLCBmcm9tLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY29uY2F0TWFwLCBldmVyeSwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQge1xuICBFeHByZXNzaW9uRW5naW5lSW1wbCwgRXhwcmVzc2lvbk1hbmFnZXIsIEV4cHJlc3Npb25SZXN1bHQsIEV4cHJlc3Npb25SZXN1bHRGYWN0b3J5XG59IGZyb20gJy4uL2V4cHJlc3Npb24vaW5kZXgnO1xuaW1wb3J0IHsgQ29udHJvbHNQcm94eSB9IGZyb20gJy4uL2NvbnRyb2wtcHJveHknO1xuXG5hYnN0cmFjdCBjbGFzcyBWaWV3TW9kZWwge1xuXG4gIC8qKlxuICAgKiDlkb3ku6TlhYPmlbDmja7pm4blkIhcbiAgICovXG4gIHB1YmxpYyBuZ0NvbW1hbmRzOiB7IFtwcm9wTmFtZTogc3RyaW5nXTogQ29tbWFuZE1ldGhvZE1ldGFkYXRhIH07XG5cbiAgLyoqXG4gICAqIOaJqeWxleWRveS7pFxuICAgKi9cbiAgcHVibGljIGV4dGVuZENvbW1hbmRzOiBNYXA8c3RyaW5nLCBhbnk+ID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcblxuICAvKipcbiAgICog5ZCN56ewXG4gICAqL1xuICBwdWJsaWMgaWQ6IHN0cmluZztcblxuICAvKipcbiAgICog5rOo5YWl5ZmoXG4gICAqL1xuICBwdWJsaWMgaW5qZWN0b3I6IEluamVjdG9yO1xuXG4gIC8qKlxuICAgKiDop4blm77mqKHlnovkuIrkuIvmlodcbiAgICovXG4gIHB1YmxpYyBjb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0O1xuXG4gIC8qKlxuICAgKiDmlbDmja7ku5PlupNcbiAgICovXG4gIHB1YmxpYyByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PEVudGl0eT47XG5cbiAgLyoqXG4gICAqIOe7keWumui3r+W+hFxuICAgKi9cbiAgcHVibGljIGJpbmRpbmdQYXRoOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIOaVsOaNrueKtuaAgVxuICAgKi9cbiAgcHVibGljIGJpbmRpbmdEYXRhOiBCaW5kaW5nRGF0YTtcblxuICAvKipcbiAgICogVUnnirbmgIFcbiAgICovXG4gIHB1YmxpYyB1aVN0YXRlOiBVSVN0YXRlO1xuXG4gIC8qKlxuICAgKiDnirbmgIHmnLpcbiAgICovXG4gIHB1YmxpYyBzdGF0ZU1hY2hpbmU6IFN0YXRlTWFjaGluZTtcblxuICAvKipcbiAgICog6KGo5Y2VXG4gICAqL1xuICBwdWJsaWMgZm9ybTogRm9ybTtcblxuICAvKipcbiAgICog5ZG95Luk5oC757q/XG4gICAqL1xuICBwdWJsaWMgY29tbWFuZEJ1czogQ29tbWFuZEJ1cztcblxuICAvKipcbiAgICog5b+r5o236ZSu5pig5bCEXG4gICAqL1xuICBwdWJsaWMga2V5YmluZGluZ01hcDogTWFwPHN0cmluZywgS2V5YmluZGluZz47XG5cbiAgLyoqIFxuICAgKiDmjqfku7blrp7kvovku6PnkIZcbiAgICovXG4gIHB1YmxpYyBjb250cm9sc1Byb3h5IDogQ29udHJvbHNQcm94eTtcblxuXG4gIC8qKlxuICAgKiDlgLzlj5jljJbliY3nm5HlkKzlmahcbiAgICovXG4gIHByaXZhdGUgZW50aXR5VmFsdWVDaGFuZ2luZ0xpc3RlbmVyczogTWFwPHN0cmluZywgc3RyaW5nPjtcblxuICAvKipcbiAgICog5YC85Y+Y5YyW5ZCO55uR5ZCs5ZmoXG4gICAqL1xuICBwcml2YXRlIGVudGl0eVZhbHVlQ2hhbmdlZExpc3RlbmVyczogTWFwPHN0cmluZywgc3RyaW5nPjtcblxuXG5cbiAgcHVibGljIGV4cHJlc3Npb25FbmdpbmVJbXBsOiBFeHByZXNzaW9uRW5naW5lSW1wbDtcbiAgcHVibGljIGV4cHJlc3Npb25NYW5hZ2VyOiBFeHByZXNzaW9uTWFuYWdlcjtcbiAgcHVibGljIGV4cHJlc3Npb25SZXN1bHQ6IEV4cHJlc3Npb25SZXN1bHQ7XG5cblxuICAvKipcbiAgICog5p6E6YCg5Ye95pWwXG4gICAqL1xuICBwdWJsaWMgY29uc3RydWN0b3IoaW5qZWN0b3I6IEluamVjdG9yLCBpZDogc3RyaW5nKSB7XG4gICAgdGhpcy5pbmplY3RvciA9IGluamVjdG9yO1xuICAgIHRoaXMuaWQgPSBpZDtcbiAgfVxuXG4gIC8qKlxuICAgKiDliJ3lp4vljJZcbiAgICovXG4gIHB1YmxpYyBpbml0KCkge1xuICAgIHRoaXMuaW5pdFJlcG9zaXRvcnkoKTtcbiAgICB0aGlzLmluaXRDb250ZXh0KCk7XG4gICAgdGhpcy5pbml0QmluZGluZ0RhdGEoKTtcbiAgICB0aGlzLmluaXRVSVN0YXRlKCk7XG4gICAgdGhpcy5pbnRpU3RhdGVNYWNoaW5lKCk7XG4gICAgdGhpcy5pbml0Rm9ybSgpO1xuICAgIHRoaXMuaW5pdENvbW1hbmRCdXMoKTtcbiAgICB0aGlzLnJlZ2lzdGVyV2l0aFBhcmVudCgpO1xuICAgIHRoaXMuaW5pdExpc3RlbmVycygpO1xuICAgIHRoaXMuY2xvc2VPbGRCZVNlc3Npb24oKTtcbiAgICB0aGlzLmluaXRFeHByZXNzaW9uKCk7XG4gICAgdGhpcy5pbml0Q29udHJvbHNQcm94eSgpO1xuICAgIHRoaXMuY29uZmlnKCk7XG4gIH1cbiAgXG4gIGNvbmZpZygpe1xuICAgIHRoaXMudWlTdGF0ZS5jb25maWcodGhpcy5jb250ZXh0KTtcbiAgfVxuXG4gIGluaXRDb250cm9sc1Byb3h5KCl7XG4gICAgdGhpcy5jb250cm9sc1Byb3h5ID0gdGhpcy5pbmplY3Rvci5nZXQoQ29udHJvbHNQcm94eSk7XG4gIH1cblxuICBwcml2YXRlIGluaXRSZXBvc2l0b3J5KCkge1xuICAgIHRoaXMucmVwb3NpdG9yeSA9IHRoaXMuaW5qZWN0b3IuZ2V0KFJlcG9zaXRvcnkpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0Q29udGV4dCgpIHtcbiAgICB0aGlzLmNvbnRleHQgPSB0aGlzLmluamVjdG9yLmdldDxWaWV3TW9kZWxDb250ZXh0PihWaWV3TW9kZWxDb250ZXh0KTtcbiAgICB0aGlzLmNvbnRleHQuaW5pdCh0aGlzKTtcbiAgfVxuXG4gIHB1YmxpYyBpbml0RXhwcmVzc2lvbigpIHtcblxuICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLmNvbnRleHQuYXBwQ29udGV4dDtcbiAgICBjb25zdCBhbGxWaWV3TW9kZWxDb250ZXh0cyA9IGFwcENvbnRleHQudmlld01vZGVsQ29udGV4dE1hbmFnZXIuZ2V0Q29udGV4dHMoKTtcbiAgICBjb25zdCBleGlzdGVkVmlld01vZGVsQ29udGV4dCA9IGFsbFZpZXdNb2RlbENvbnRleHRzLmZpbmQoKHZpZXdNb2RlbENvbnRleHQ6IGFueSkgPT4ge1xuICAgICAgaWYgKHZpZXdNb2RlbENvbnRleHQuZXhwcmVzc2lvbkVuZ2luZUltcGwpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpZiAoZXhpc3RlZFZpZXdNb2RlbENvbnRleHQpIHtcbiAgICAgIHRoaXMuZXhwcmVzc2lvbkVuZ2luZUltcGwgPSBleGlzdGVkVmlld01vZGVsQ29udGV4dC5leHByZXNzaW9uRW5naW5lSW1wbDtcbiAgICAgIHRoaXMuZXhwcmVzc2lvbk1hbmFnZXIgPSBleGlzdGVkVmlld01vZGVsQ29udGV4dC5leHByZXNzaW9uTWFuYWdlcjtcbiAgICAgIHRoaXMuZXhwcmVzc2lvblJlc3VsdCA9IGV4aXN0ZWRWaWV3TW9kZWxDb250ZXh0LmV4cHJlc3Npb25SZXN1bHQ7XG4gICAgICByZXR1cm47XG4gICAgfSAgXG5cbiAgICB0aGlzLmV4cHJlc3Npb25FbmdpbmVJbXBsID0gdGhpcy5pbmplY3Rvci5nZXQ8RXhwcmVzc2lvbkVuZ2luZUltcGw+KEV4cHJlc3Npb25FbmdpbmVJbXBsLCBudWxsKTtcbiAgICB0aGlzLmV4cHJlc3Npb25NYW5hZ2VyID0gdGhpcy5pbmplY3Rvci5nZXQ8RXhwcmVzc2lvbk1hbmFnZXI+KEV4cHJlc3Npb25NYW5hZ2VyLCBudWxsKTtcbiAgICBjb25zdCBleHByZXNzaW9uUmVzdWx0RmFjdG9yeSA9IHRoaXMuaW5qZWN0b3IuZ2V0PEV4cHJlc3Npb25SZXN1bHRGYWN0b3J5PihFeHByZXNzaW9uUmVzdWx0RmFjdG9yeSwgbnVsbCk7XG4gICAgdGhpcy5leHByZXNzaW9uUmVzdWx0ID0gdGhpcy5pbmplY3Rvci5nZXQ8RXhwcmVzc2lvblJlc3VsdD4oRXhwcmVzc2lvblJlc3VsdCwgbnVsbCk7XG4gIH1cblxuICBwcml2YXRlIGluaXRCaW5kaW5nRGF0YSgpIHtcbiAgICB0aGlzLmJpbmRpbmdEYXRhID0gdGhpcy5jb250ZXh0LmluamVjdG9yLmdldChCaW5kaW5nRGF0YSk7XG4gICAgdGhpcy5lbnRpdHlWYWx1ZUNoYW5naW5nTGlzdGVuZXJzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcbiAgICB0aGlzLmVudGl0eVZhbHVlQ2hhbmdlZExpc3RlbmVycyA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XG4gICAgaWYgKHRoaXMuYmluZGluZ0RhdGEpIHtcbiAgICAgIHRoaXMuYmluZGluZ0RhdGEuc2V0VmFsdWVDaGFuZ2VJbnZva2VyRmFjdG9yeSgocGF0aHM6IHN0cmluZ1tdKTogSW52b2tlT25WYWx1ZUNoYW5nZSA9PiB7XG4gICAgICAgIHJldHVybiAocHJlVmFsdWUsIHZhbHVlLCBlbnRpdHlDaGFuZ2VkOiBib29sZWFuLCBwcmltYXJ5VmFsdWU/OiBhbnkpOiBPYnNlcnZhYmxlPGJvb2xlYW4+ID0+IHtcbiAgICAgICAgICBjb25zdCBwbGFpblBhdGggPSAnLycgKyBwYXRocy5qb2luKCcvJyk7XG4gICAgICAgICAgbGV0IGNvbW1hbmQ6IHN0cmluZztcbiAgICAgICAgICBpZiAoZW50aXR5Q2hhbmdlZCA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIGNvbW1hbmQgPSB0aGlzLmVudGl0eVZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnNbcGxhaW5QYXRoXTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29tbWFuZCA9IHRoaXMuZW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzW3BsYWluUGF0aF07XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKCEhY29tbWFuZCkge1xuICAgICAgICAgICAgY29uc3QgY2hhbmdlOiBFbnRpdHlWYWx1ZUNoYW5nZSA9IHtcbiAgICAgICAgICAgICAgcGF0aHM6IHBhdGhzLFxuICAgICAgICAgICAgICBwcmVWYWx1ZTogcHJlVmFsdWUsXG4gICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSxcbiAgICAgICAgICAgICAgY2hhbmdlZDogZW50aXR5Q2hhbmdlZFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNvbnN0IGNvbW1hbmRzID0gY29tbWFuZC5zcGxpdCgnOycpLmZpbHRlcihwID0+IHApO1xuICAgICAgICAgICAgbGV0IHZhbHVlQ2hhbmdlU3VjY2VzcyA9IHRydWU7XG4gICAgICAgICAgICByZXR1cm4gZnJvbShjb21tYW5kcykucGlwZShcbiAgICAgICAgICAgICAgY29uY2F0TWFwKGl0ZW0gPT4ge1xuICAgICAgICAgICAgICAgIGlmICghdmFsdWVDaGFuZ2VTdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW2l0ZW1dKGNoYW5nZSkucGlwZShcbiAgICAgICAgICAgICAgICAgIHRhcCgocmVzdWx0OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVDaGFuZ2VTdWNjZXNzID0gcmVzdWx0O1xuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgZXZlcnkoKHJlc3VsdDogYW55KSA9PiByZXN1bHQpXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCByZXBvc2l0b3J5TmFtZSA9IHRoaXMucmVwb3NpdG9yeS5uYW1lO1xuICAgIGNvbnN0IGJpbmRpbmdEYXRhTWFuYWdlciA9IHRoaXMuY29udGV4dC5hcHBDb250ZXh0LmJpbmRpbmdEYXRhTWFuYWdlcjtcbiAgICBjb25zdCByZXBvc2l0b3J5QmluZGluZ0RhdGEgPSBiaW5kaW5nRGF0YU1hbmFnZXIuZ2V0QmluZGluZ0RhdGFCeU5hbWUocmVwb3NpdG9yeU5hbWUpO1xuICAgIHRoaXMuYmluZGluZ0RhdGEuaW5pdEJ5QmluZGluZ0xpc3QocmVwb3NpdG9yeUJpbmRpbmdEYXRhLmxpc3QsIHRoaXMuY29udGV4dCwgcmVwb3NpdG9yeUJpbmRpbmdEYXRhLmRhdGFUeXBlSW5mbyk7XG4gIH1cblxuICBwcml2YXRlIGluaXRVSVN0YXRlKCkge1xuICAgIHRoaXMudWlTdGF0ZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KFVJU3RhdGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbnRpU3RhdGVNYWNoaW5lKCkge1xuICAgIHRoaXMuc3RhdGVNYWNoaW5lID0gdGhpcy5pbmplY3Rvci5nZXQoU3RhdGVNYWNoaW5lLCBudWxsKTtcbiAgICBpZiAoIXRoaXMuc3RhdGVNYWNoaW5lKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuc3RhdGVNYWNoaW5lLmluaXQodGhpcy5jb250ZXh0KTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdEZvcm0oKSB7XG4gICAgdGhpcy5mb3JtID0gdGhpcy5pbmplY3Rvci5nZXQoRm9ybSwgbnVsbCk7XG4gICAgdGhpcy5mb3JtLmluaXQoKTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdENvbW1hbmRCdXMoKSB7XG4gICAgdGhpcy5jb21tYW5kQnVzID0gdGhpcy5pbmplY3Rvci5nZXQoQ29tbWFuZEJ1cyk7XG4gICAgdGhpcy5leHRlbmRDb21tYW5kTWV0aG9kcygpO1xuICB9XG5cbiAgcHJpdmF0ZSBleHRlbmRDb21tYW5kTWV0aG9kcygpIHtcbiAgICB0aGlzLm5nQ29tbWFuZHMgPSBNZXRhZGF0YVV0aWwuZ2V0UHJvcHNNZXRhZGF0YXNCeU5hbWUodGhpcy5jb25zdHJ1Y3RvciwgQ09NTUFORF9NRVRIT0RfTUVUQSk7XG4gICAgdGhpcy5rZXliaW5kaW5nTWFwID0gbmV3IE1hcDxzdHJpbmcsIEtleWJpbmRpbmc+KCk7XG5cbiAgICBPYmplY3Qua2V5cyh0aGlzLm5nQ29tbWFuZHMpLmZvckVhY2goKHByb3BOYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgIGNvbnN0IG5nQ29tbWFuZDogQ29tbWFuZE1ldGhvZE1ldGFkYXRhID0gdGhpcy5uZ0NvbW1hbmRzW3Byb3BOYW1lXTtcblxuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHByb3BOYW1lLCB7XG4gICAgICAgIHZhbHVlOiAoZXZlbnRQYXJhbXM6IGFueSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGNvbW1hbmQ6IENvbW1hbmQgPSB7XG4gICAgICAgICAgICBuYW1lOiBuZ0NvbW1hbmQubmFtZSxcbiAgICAgICAgICAgIHBhcmFtczogbmdDb21tYW5kLnBhcmFtcyxcbiAgICAgICAgICAgIHBhcmFtRGVzY3JpcHRpb25zOiBuZ0NvbW1hbmQucGFyYW1EZXNjcmlwdGlvbnMsXG4gICAgICAgICAgICBldmVudFBhcmFtOiBldmVudFBhcmFtcyB8fCBudWxsXG4gICAgICAgICAgfTtcbiAgICAgICAgICByZXR1cm4gdGhpcy5jb21tYW5kQnVzLmRpc3BhdGNoKGNvbW1hbmQpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgaWYgKG5nQ29tbWFuZC5rZXlCaW5kaW5nKSB7XG4gICAgICAgIHRoaXMua2V5YmluZGluZ01hcC5zZXQocHJvcE5hbWUsIG5nQ29tbWFuZC5rZXlCaW5kaW5nKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDms6jlhozmianlsZXlkb3ku6Tmlrnms5VcbiAgICovXG4gIHB1YmxpYyByZWdpc3RlckV4dGVuZENvbW1hbmQoY29tbWFuZE5hbWU6IHN0cmluZywgY29tbWFuZEhhbmRsZXI6IGFueSkge1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBjb21tYW5kTmFtZSwge1xuICAgICAgdmFsdWU6IChldmVudFBhcmFtczogYW55KSA9PiB7XG4gICAgICAgIHJldHVybiBjb21tYW5kSGFuZGxlcihldmVudFBhcmFtcywgdGhpcy5jb250ZXh0KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLmV4dGVuZENvbW1hbmRzLnNldChjb21tYW5kTmFtZSwgY29tbWFuZEhhbmRsZXIpO1xuICB9XG5cbiAgcHJpdmF0ZSByZWdpc3RlcldpdGhQYXJlbnQoKSB7XG4gICAgY29uc3QgcGFyZW50Q29udGV4dCA9IHRoaXMuY29udGV4dC5wYXJlbnQ7XG4gICAgaWYgKCFwYXJlbnRDb250ZXh0IHx8ICFwYXJlbnRDb250ZXh0LnZpZXdNb2RlbCB8fCAhcGFyZW50Q29udGV4dC52aWV3TW9kZWxbJ2NoaWxkVmlld01vZGVscyddKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgcGFyZW50Vmlld01vZGVsID0gcGFyZW50Q29udGV4dC52aWV3TW9kZWw7XG4gICAgY29uc3QgY2xhc3NOYW1lID0gdGhpcy5jb25zdHJ1Y3Rvci5uYW1lO1xuICAgIGNvbnN0IHByb3BOYW1lID0gcGFyZW50Vmlld01vZGVsWydjaGlsZFZpZXdNb2RlbHMnXVtjbGFzc05hbWVdO1xuICAgIHBhcmVudFZpZXdNb2RlbFtwcm9wTmFtZV0gPSB0aGlzO1xuICB9XG5cbiAgLyoqXG4gICAqIOWFs+mXreiAgeeahEJlU2Vzc2lvblxuICAgKi9cbiAgcHJpdmF0ZSBjbG9zZU9sZEJlU2Vzc2lvbigpIHtcbiAgICBjb25zdCBhbGxWaWV3TW9kZWxDb250ZXh0cyA9IHRoaXMuY29udGV4dC5hcHBDb250ZXh0LnZpZXdNb2RlbENvbnRleHRNYW5hZ2VyLmdldENvbnRleHRzKCk7XG4gICAgaWYgKGFsbFZpZXdNb2RlbENvbnRleHRzLmxlbmd0aCA9PT0gMSAmJiBhbGxWaWV3TW9kZWxDb250ZXh0c1swXSA9PT0gdGhpcy5jb250ZXh0KSB7XG4gICAgICB0aGlzLmNvbnRleHQucmVwb3NpdG9yeS5yZXNldCgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICog5LuORm9ybeiOt+WPluebkeWQrOWZqFxuICovXG4gIHByaXZhdGUgaW5pdExpc3RlbmVycygpIHtcbiAgICBjb25zdCBleHRyYWN0UGF0aCA9IChiaW5kaW5nQmFzZVBhdGg6IHN0cmluZywgYmluZGluZ1BhdGg6IHN0cmluZyk6IHN0cmluZyA9PiB7XG4gICAgICByZXR1cm4gJy8nICsgYmluZGluZ0Jhc2VQYXRoLnNwbGl0KCcvJykuY29uY2F0KGJpbmRpbmdQYXRoLnNwbGl0KCcuJykpLmZpbHRlcigoaXRlbSkgPT4gaXRlbS5sZW5ndGggPiAwKS5qb2luKCcvJyk7XG4gICAgfTtcblxuICAgIGlmICh0aGlzLmZvcm0pIHtcbiAgICAgIGNvbnN0IHZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnMgPSB0aGlzLmZvcm0uZ2V0RW50aXR5VmFsdWVDaGFuZ2luZ0xpc3RlbmVycygpO1xuICAgICAgT2JqZWN0LmtleXModmFsdWVDaGFuZ2luZ0xpc3RlbmVycykuZm9yRWFjaCgoYmluZGluZ1BhdGgpID0+IHtcbiAgICAgICAgY29uc3QgcGxhaW5QYXRoID0gZXh0cmFjdFBhdGgodGhpcy5iaW5kaW5nUGF0aCwgYmluZGluZ1BhdGgpO1xuICAgICAgICB0aGlzLmVudGl0eVZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnNbcGxhaW5QYXRoXSA9IHZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnNbYmluZGluZ1BhdGhdO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHZhbHVlQ2hhbmdlZExpc3RlbmVycyA9IHRoaXMuZm9ybS5nZXRFbnRpdHlWYWx1ZUNoYW5nZWRMaXN0ZW5lcnMoKTtcbiAgICAgIE9iamVjdC5rZXlzKHZhbHVlQ2hhbmdlZExpc3RlbmVycykuZm9yRWFjaCgoYmluZGluZ1BhdGgpID0+IHtcbiAgICAgICAgY29uc3QgcGxhaW5QYXRoID0gZXh0cmFjdFBhdGgodGhpcy5iaW5kaW5nUGF0aCwgYmluZGluZ1BhdGgpO1xuICAgICAgICB0aGlzLmVudGl0eVZhbHVlQ2hhbmdlZExpc3RlbmVyc1twbGFpblBhdGhdID0gdmFsdWVDaGFuZ2VkTGlzdGVuZXJzW2JpbmRpbmdQYXRoXTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG59XG5cbmV4cG9ydCB7IFZpZXdNb2RlbCB9O1xuIl19