import { MetadataUtil } from '../core/index';
import { FormControl } from './form_control';
import { FORM_CONTROL_PROP_META } from './decorators';
import { Subject } from 'rxjs';
import { ValidatorFactory } from '../validator';
import { tap } from 'rxjs/operators';
/**
 * Form抽象类
 */
class Form {
    /**
     * 构造函数
     */
    constructor(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.formControlConfigs = [];
        this.validateformControls = [];
        this.validateformControlPathMap = new Map;
        this.changes = new Subject();
    }
    /**
     * 初始化
     */
    init() {
        this.collectMetadatas();
        this.createFormControls();
    }
    /**
     * 使用不包含绝对路径的/或者/子表/的路径信息获取对应的formControlConfig的name属性与bindingPath并且返回该路径的formControl
     * @param path 路径信息
     * @returns
     */
    getFormValueByBindPath(path) {
        let formControl = {
            form_name: {},
            name: '',
            bindingPath: ''
        };
        path = path.replace(/\//g, '.');
        if (this.formControlConfigs.length === 0)
            return formControl;
        this.formControlConfigs.forEach((formControlConfig) => {
            if (formControlConfig.bindingPath === path) {
                formControl.form_name = this[formControlConfig.name];
                formControl.name = formControlConfig.name;
                formControl.bindingPath = formControlConfig.bindingPath;
            }
        });
        return formControl;
    }
    /**
     *
     * @returns 获取当前表单上的存在校验字段的集合
     */
    getValidateformControls() {
        return this.validateformControls;
    }
    setValidateformControls(name) {
        if (this.validateformControls && this.validateformControls.length === 0) {
            this.validateformControls.push(name);
        }
        if (this.validateformControls && this.validateformControls.length >= 1) {
            const index = this.validateformControls.findIndex(item => item == name);
            if (index === -1) {
                this.validateformControls.push(name);
            }
        }
        if (!Array.isArray(this.validateformControls)) {
            this.validateformControls = [name];
        }
    }
    getValidateformControlPathMap() {
        return this.validateformControlPathMap;
    }
    setValidateformControlPathMap(name, value) {
        if (!this.validateformControlPathMap.has(name)) {
            this.validateformControlPathMap.set(name, value);
        }
    }
    /**
     * 使用formControlConfig的bindingPath路径信息与对应formControlConfig的name信息储存起来作为验证信息在form上的记录
     * @param path formControlConfig的bindingPath路径信息
     * @param name 对应formContro的name信息
     */
    addValidate(path, name) {
        let bindingPath = this.viewModelContext.bindingData.bindingPath.slice(1).replace(/\//g, '.');
        if (bindingPath) {
            bindingPath = bindingPath + '.';
        }
        ;
        this.setValidateformControlPathMap(bindingPath + path, name);
        this.setValidateformControls(name);
    }
    /**
     * 全部校验
     *  formControlConfigs 上所有的formControl的存在方法调用一遍 将错误信息集中返回
     */
    validateFields() {
        let validationResult = [];
        if (this.validateformControls.length === 0) {
            return validationResult;
        }
        this.validateformControls.forEach((formControl) => {
            const result$ = ValidatorFactory.executeValidator(this[formControl]['validatorFn'], this[formControl]['value'], this.viewModelContext).pipe(tap((message) => {
                this[formControl]['validationResult'] = message;
                !message['passing'] && this.changes.next({ type: 'validateFieldsFinished' });
            }));
            validationResult.push(result$);
        });
        return validationResult;
    }
    /**
     * 不支持自定义异步全部校验
     *  formControlConfigs 上所有的formControl的存在方法调用一遍 将错误信息集中返回
     */
    noSupportAsynValidateFields() {
        let validationResult = [];
        if (this.validateformControls.length === 0) {
            return validationResult;
        }
        this.validateformControls.forEach((formControl) => {
            if (!this[formControl]['validationResult']) {
                this[formControl]['validationResult'] = ValidatorFactory.noSupportAsynExecuteValidator(this[formControl]['validatorFn'], this[formControl]['value'], this.viewModelContext);
            }
            !this[formControl]['validationResult'].passing && validationResult.push(this[formControl]);
        });
        this.changes.next({ type: 'validateFieldsFinished' });
        return validationResult;
    }
    /**
     * 获取某一个得校验错误信息
     * @param name 属性名称
     */
    getFieldError(name) {
        if (this.validateformControls.length === 0) {
            return {};
        }
        const index = this.validateformControls.findIndex((item) => {
            return item === name;
        });
        if (index === -1) {
            return {};
        }
        else {
            const result$ = ValidatorFactory.executeValidator(this[name]['validatorFn'], this[name]['value'], this.viewModelContext).pipe(tap((message) => {
                this[name]['validationResult'] = message;
                !message['passing'] && this.changes.next({ type: 'validateFieldsFinished' });
            }));
            return result$;
        }
    }
    /**
   * 根据form元数据中的path获取某一个得校验错误信息
   * @param path 属性名称数组
   */
    getFieldErrorByPath(path) {
        if (this.validateformControls.length === 0) {
            return {};
        }
        let pathName = path[0];
        if (path && path.length >= 2) {
            pathName = path.join('.');
        }
        const index = this.validateformControlPathMap.has(pathName);
        if (!index) {
            return {};
        }
        else {
            ValidatorFactory.executeValidator(this[this.validateformControlPathMap.get(pathName)]['validatorFn'], this[this.validateformControlPathMap.get(pathName)]['value'], this.viewModelContext).subscribe((message) => {
                this[this.validateformControlPathMap.get(pathName)]['validationResult'] = message;
                this.changes.next({ type: 'validateFieldsFinished', value: this.validateformControlPathMap.get(pathName) });
            });
            return this[this.validateformControlPathMap.get(pathName)]['validationResult'];
        }
    }
    /**
     * 清除一组字段验证状态
     * @param fields 字段的数组
     */
    resetFieldsValidate(fields) {
        if (this.validateformControls.length === 0) {
            return true;
        }
        else {
            if (fields && fields.length > 0) {
                const sb = new Set(fields);
                // 交集
                const intersect = this.validateformControls.filter(x => sb.has(x));
                // 遍历清空所有校验结果数据
                intersect.forEach(item => {
                    this[item]['validationResult'] = undefined;
                });
            }
            else {
                // 没传数据全部清除
                this.validateformControls.forEach(item => {
                    this[item]['validationResult'] = undefined;
                });
            }
            this.changes.next({ type: 'validateFieldsFinished' });
        }
    }
    /**
     * 创建FormControls
     */
    createFormControls() {
        this.formControlConfigs.forEach((formControlConfig) => {
            const name = formControlConfig.name;
            const formControl = new FormControl(formControlConfig, this.viewModelContext);
            this[name] = formControl;
        });
    }
    /**
     * 收集元数据
     */
    collectMetadatas() {
        const formControlMetadatas = MetadataUtil.getPropsMetadatasByName(this.constructor, FORM_CONTROL_PROP_META);
        let bindingPath = this.viewModelContext.bindingData.bindingPath.slice(1).replace(/\//g, '.');
        const validationManager = this.viewModelContext.appContext['validationManager'];
        if (bindingPath) {
            bindingPath = bindingPath + '.';
        }
        ;
        Object.keys(formControlMetadatas).forEach((name) => {
            const formControlMetadata = formControlMetadatas[name];
            let validRules = null;
            if (formControlMetadata.validRules) {
                this.validateformControls.push(name);
                this.validateformControlPathMap.set(bindingPath + formControlMetadata.bindingPath, name);
                validRules = formControlMetadata.validRules;
            }
            const key = ('/' + bindingPath + formControlMetadata.bindingPath).replace(/\./g, '/');
            if (validationManager[key]) {
                if (!validRules) {
                    this.validateformControls.push(name);
                    this.validateformControlPathMap.set(bindingPath + formControlMetadata.bindingPath, name);
                    validRules = Object.values(validationManager[key]);
                }
                else {
                    validRules = validRules.concat(Object.values(validationManager[key]));
                }
            }
            const formControlConfig = {
                name: name,
                bindingType: formControlMetadata.bindingType,
                bindingPath: formControlMetadata.bindingPath,
                valueConverter: formControlMetadata.valueConverter,
                valueChanging: formControlMetadata.valueChanging,
                valueChanged: formControlMetadata.valueChanged,
                validRules: validRules
            };
            this.formControlConfigs.push(formControlConfig);
        });
    }
    getEntityValueChangingListeners() {
        const listeners = {};
        this.formControlConfigs.forEach((formControl) => {
            if (formControl.valueChanging) {
                listeners[formControl.bindingPath] = formControl.valueChanging;
            }
        });
        return listeners;
    }
    getEntityValueChangedListeners() {
        const listeners = {};
        this.formControlConfigs.forEach((formControl) => {
            if (formControl.valueChanged) {
                listeners[formControl.bindingPath] = formControl.valueChanged;
            }
        });
        return listeners;
    }
}
export { Form };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9mb3JtL2Zvcm0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUU3QyxPQUFPLEVBQXFCLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hFLE9BQU8sRUFBdUIsc0JBQXNCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDM0UsT0FBTyxFQUFNLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNuQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxjQUFjLENBQUE7QUFDL0MsT0FBTyxFQUFPLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTFDOztHQUVHO0FBQ0gsTUFBZSxJQUFJO0lBa0JqQjs7T0FFRztJQUNILFlBQVksZ0JBQWtDO1FBQzVDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztRQUN6QyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxFQUFFLENBQUM7UUFDL0IsSUFBSSxDQUFDLDBCQUEwQixHQUFHLElBQUksR0FBRyxDQUFDO1FBQzFDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBRUQ7O09BRUc7SUFDSSxJQUFJO1FBQ1QsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxzQkFBc0IsQ0FBQyxJQUFJO1FBQ3pCLElBQUksV0FBVyxHQUFHO1lBQ2hCLFNBQVMsRUFBRSxFQUFFO1lBQ2IsSUFBSSxFQUFFLEVBQUU7WUFDUixXQUFXLEVBQUUsRUFBRTtTQUNoQixDQUFDO1FBQ0YsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFBO1FBQy9CLElBQUksSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQUUsT0FBTyxXQUFXLENBQUM7UUFDN0QsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDLGlCQUFvQyxFQUFFLEVBQUU7WUFDdkUsSUFBSSxpQkFBaUIsQ0FBQyxXQUFXLEtBQUssSUFBSSxFQUFFO2dCQUMxQyxXQUFXLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDckQsV0FBVyxDQUFDLElBQUksR0FBRyxpQkFBaUIsQ0FBQyxJQUFJLENBQUM7Z0JBQzFDLFdBQVcsQ0FBQyxXQUFXLEdBQUcsaUJBQWlCLENBQUMsV0FBVyxDQUFDO2FBQ3pEO1FBQ0gsQ0FBQyxDQUFDLENBQUE7UUFDRixPQUFPLFdBQVcsQ0FBQztJQUNyQixDQUFDO0lBQ0Q7OztPQUdHO0lBQ0gsdUJBQXVCO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDO0lBQ25DLENBQUM7SUFFRCx1QkFBdUIsQ0FBQyxJQUFJO1FBRTFCLElBQUksSUFBSSxDQUFDLG9CQUFvQixJQUFJLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQ3ZFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7U0FDckM7UUFFRCxJQUFJLElBQUksQ0FBQyxvQkFBb0IsSUFBSSxJQUFJLENBQUMsb0JBQW9CLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRTtZQUN0RSxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxDQUFDO1lBQ3hFLElBQUksS0FBSyxLQUFLLENBQUMsQ0FBQyxFQUFFO2dCQUNoQixJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO2FBQ3JDO1NBQ0Y7UUFFRCxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsRUFBRTtZQUM3QyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtTQUNuQztJQUNILENBQUM7SUFFRCw2QkFBNkI7UUFDM0IsT0FBTyxJQUFJLENBQUMsMEJBQTBCLENBQUM7SUFDekMsQ0FBQztJQUVELDZCQUE2QixDQUFDLElBQUksRUFBRSxLQUFLO1FBQ3ZDLElBQUksQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzlDLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFBO1NBQ2pEO0lBQ0gsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxXQUFXLENBQUMsSUFBSSxFQUFFLElBQUk7UUFDcEIsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDN0YsSUFBSSxXQUFXLEVBQUU7WUFBRSxXQUFXLEdBQUcsV0FBVyxHQUFHLEdBQUcsQ0FBQTtTQUFFO1FBQUEsQ0FBQztRQUNyRCxJQUFJLENBQUMsNkJBQTZCLENBQUMsV0FBVyxHQUFHLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDcEMsQ0FBQztJQUdEOzs7T0FHRztJQUNILGNBQWM7UUFDWixJQUFJLGdCQUFnQixHQUFHLEVBQUUsQ0FBQztRQUMxQixJQUFJLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQUUsT0FBTyxnQkFBZ0IsQ0FBQztTQUFFO1FBQ3hFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRTtZQUNoRCxNQUFNLE9BQU8sR0FBRyxnQkFBZ0IsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsYUFBYSxDQUFDLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLElBQUksQ0FDekksR0FBRyxDQUNELENBQUMsT0FBTyxFQUFFLEVBQUU7Z0JBQ1YsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLEdBQUcsT0FBTyxDQUFDO2dCQUNoRCxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksRUFBRSx3QkFBd0IsRUFBRSxDQUFDLENBQUE7WUFDOUUsQ0FBQyxDQUNGLENBQ0YsQ0FBQTtZQUNELGdCQUFnQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUNoQyxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sZ0JBQWdCLENBQUM7SUFDMUIsQ0FBQztJQUVEOzs7T0FHRztJQUNILDJCQUEyQjtRQUN6QixJQUFJLGdCQUFnQixHQUFHLEVBQUUsQ0FBQztRQUMxQixJQUFJLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQUUsT0FBTyxnQkFBZ0IsQ0FBQztTQUFFO1FBQ3hFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRTtZQUNoRCxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLEVBQUU7Z0JBQzFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLGdCQUFnQixDQUFDLDZCQUE2QixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxhQUFhLENBQUMsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7YUFDN0s7WUFDRCxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLE9BQU8sSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUE7UUFDNUYsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksRUFBRSx3QkFBd0IsRUFBRSxDQUFDLENBQUE7UUFDckQsT0FBTyxnQkFBZ0IsQ0FBQztJQUMxQixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsYUFBYSxDQUFDLElBQVk7UUFDeEIsSUFBSSxJQUFJLENBQUMsb0JBQW9CLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUMxQyxPQUFPLEVBQUUsQ0FBQTtTQUNWO1FBQ0QsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ3pELE9BQU8sSUFBSSxLQUFLLElBQUksQ0FBQTtRQUN0QixDQUFDLENBQUMsQ0FBQztRQUNILElBQUksS0FBSyxLQUFLLENBQUMsQ0FBQyxFQUFFO1lBQ2hCLE9BQU8sRUFBRSxDQUFBO1NBQ1Y7YUFBTTtZQUNMLE1BQU0sT0FBTyxHQUFHLGdCQUFnQixDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxhQUFhLENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsSUFBSSxDQUMzSCxHQUFHLENBQ0QsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDVixJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsa0JBQWtCLENBQUMsR0FBRyxPQUFPLENBQUM7Z0JBQ3pDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLHdCQUF3QixFQUFFLENBQUMsQ0FBQTtZQUM5RSxDQUFDLENBQ0YsQ0FDRixDQUFBO1lBQ0QsT0FBTyxPQUFPLENBQUM7U0FDaEI7SUFDSCxDQUFDO0lBRUQ7OztLQUdDO0lBQ0QsbUJBQW1CLENBQUMsSUFBYztRQUNoQyxJQUFJLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQzFDLE9BQU8sRUFBRSxDQUFBO1NBQ1Y7UUFDRCxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDdEIsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUU7WUFDNUIsUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDM0I7UUFDRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsMEJBQTBCLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzVELElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDVixPQUFPLEVBQUUsQ0FBQTtTQUNWO2FBQU07WUFDTCxnQkFBZ0IsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsU0FBUyxDQUNsTSxDQUFDLE9BQU8sRUFBRSxFQUFFO2dCQUNWLElBQUksQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsa0JBQWtCLENBQUMsR0FBRyxPQUFPLENBQUM7Z0JBQ2xGLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLHdCQUF3QixFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsMEJBQTBCLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUM5RyxDQUFDLENBQ0YsQ0FBQTtZQUNELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1NBQ2hGO0lBQ0gsQ0FBQztJQUVEOzs7T0FHRztJQUNILG1CQUFtQixDQUFDLE1BQWlCO1FBQ25DLElBQUksSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDMUMsT0FBTyxJQUFJLENBQUM7U0FDYjthQUFNO1lBQ0wsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQy9CLE1BQU0sRUFBRSxHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUMzQixLQUFLO2dCQUNMLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ25FLGVBQWU7Z0JBQ2YsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtvQkFDdkIsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLGtCQUFrQixDQUFDLEdBQUcsU0FBUyxDQUFDO2dCQUM3QyxDQUFDLENBQUMsQ0FBQTthQUNIO2lCQUFNO2dCQUNMLFdBQVc7Z0JBQ1gsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtvQkFDdkMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLGtCQUFrQixDQUFDLEdBQUcsU0FBUyxDQUFDO2dCQUM3QyxDQUFDLENBQUMsQ0FBQTthQUNIO1lBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsd0JBQXdCLEVBQUUsQ0FBQyxDQUFBO1NBQ3REO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0ssa0JBQWtCO1FBQ3hCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxpQkFBb0MsRUFBRSxFQUFFO1lBQ3ZFLE1BQU0sSUFBSSxHQUFHLGlCQUFpQixDQUFDLElBQUksQ0FBQztZQUNwQyxNQUFNLFdBQVcsR0FBRyxJQUFJLFdBQVcsQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUM5RSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsV0FBVyxDQUFDO1FBQzNCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0ssZ0JBQWdCO1FBQ3RCLE1BQU0sb0JBQW9CLEdBQUcsWUFBWSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztRQUM1RyxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztRQUM3RixNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUNoRixJQUFJLFdBQVcsRUFBRTtZQUFFLFdBQVcsR0FBRyxXQUFXLEdBQUcsR0FBRyxDQUFBO1NBQUU7UUFBQSxDQUFDO1FBQ3JELE1BQU0sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFZLEVBQUUsRUFBRTtZQUN6RCxNQUFNLG1CQUFtQixHQUFHLG9CQUFvQixDQUFDLElBQUksQ0FBd0IsQ0FBQztZQUM5RSxJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUM7WUFDdEIsSUFBSSxtQkFBbUIsQ0FBQyxVQUFVLEVBQUU7Z0JBQ2xDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3JDLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxHQUFHLENBQUMsV0FBVyxHQUFHLG1CQUFtQixDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDekYsVUFBVSxHQUFHLG1CQUFtQixDQUFDLFVBQVUsQ0FBQzthQUM3QztZQUNELE1BQU0sR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFDLFdBQVcsR0FBQyxtQkFBbUIsQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFBO1lBQ2pGLElBQUcsaUJBQWlCLENBQUMsR0FBRyxDQUFDLEVBQUM7Z0JBQ3hCLElBQUcsQ0FBQyxVQUFVLEVBQUM7b0JBQ2IsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDckMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLEdBQUcsQ0FBQyxXQUFXLEdBQUcsbUJBQW1CLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUN6RixVQUFVLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2lCQUNwRDtxQkFBSTtvQkFDSCxVQUFVLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQTtpQkFDdEU7YUFDRjtZQUNELE1BQU0saUJBQWlCLEdBQXNCO2dCQUMzQyxJQUFJLEVBQUUsSUFBSTtnQkFDVixXQUFXLEVBQUUsbUJBQW1CLENBQUMsV0FBVztnQkFDNUMsV0FBVyxFQUFFLG1CQUFtQixDQUFDLFdBQVc7Z0JBQzVDLGNBQWMsRUFBRSxtQkFBbUIsQ0FBQyxjQUFjO2dCQUNsRCxhQUFhLEVBQUUsbUJBQW1CLENBQUMsYUFBYTtnQkFDaEQsWUFBWSxFQUFFLG1CQUFtQixDQUFDLFlBQVk7Z0JBQzlDLFVBQVUsRUFBRSxVQUFVO2FBQ3ZCLENBQUM7WUFDRixJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDbEQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU0sK0JBQStCO1FBQ3BDLE1BQU0sU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUMsV0FBOEIsRUFBRSxFQUFFO1lBQ2pFLElBQUksV0FBVyxDQUFDLGFBQWEsRUFBRTtnQkFDN0IsU0FBUyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsR0FBRyxXQUFXLENBQUMsYUFBYSxDQUFDO2FBQ2hFO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBRU0sOEJBQThCO1FBQ25DLE1BQU0sU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUMsV0FBOEIsRUFBRSxFQUFFO1lBQ2pFLElBQUksV0FBVyxDQUFDLFlBQVksRUFBRTtnQkFDNUIsU0FBUyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsR0FBRyxXQUFXLENBQUMsWUFBWSxDQUFDO2FBQy9EO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0NBQ0Y7QUFFRCxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNZXRhZGF0YVV0aWwgfSBmcm9tICcuLi9jb3JlL2luZGV4JztcbmltcG9ydCB7IFZpZXdNb2RlbENvbnRleHQgfSBmcm9tICcuLi92aWV3LW1vZGVsL2luZGV4JztcbmltcG9ydCB7IEZvcm1Db250cm9sQ29uZmlnLCBGb3JtQ29udHJvbCB9IGZyb20gJy4vZm9ybV9jb250cm9sJztcbmltcG9ydCB7IEZvcm1Db250cm9sTWV0YWRhdGEsIEZPUk1fQ09OVFJPTF9QUk9QX01FVEEgfSBmcm9tICcuL2RlY29yYXRvcnMnO1xuaW1wb3J0IHsgb2YsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFZhbGlkYXRvckZhY3RvcnkgfSBmcm9tICcuLi92YWxpZGF0b3InXG5pbXBvcnQgeyBtYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuLyoqXG4gKiBGb3Jt5oq96LGh57G7XG4gKi9cbmFic3RyYWN0IGNsYXNzIEZvcm0ge1xuXG4gIC8qKlxuICAgKiDooajljZXmjqfku7bphY3nva5cbiAgICovXG4gIHByaXZhdGUgZm9ybUNvbnRyb2xDb25maWdzOiBGb3JtQ29udHJvbENvbmZpZ1tdO1xuXG4gIC8qKlxuICAgKiBWaWV3TW9kZWzkuIrkuIvmlodcbiAgICovXG4gIHByaXZhdGUgdmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dDtcblxuICBwcml2YXRlIHZhbGlkYXRlZm9ybUNvbnRyb2xzOiBzdHJpbmdbXTtcblxuICBwcml2YXRlIHZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwOiBNYXA8c3RyaW5nLCBzdHJpbmc+O1xuXG4gIHB1YmxpYyBjaGFuZ2VzOiBTdWJqZWN0PGFueT47XG5cbiAgLyoqXG4gICAqIOaehOmAoOWHveaVsFxuICAgKi9cbiAgY29uc3RydWN0b3Iodmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dCkge1xuICAgIHRoaXMudmlld01vZGVsQ29udGV4dCA9IHZpZXdNb2RlbENvbnRleHQ7XG4gICAgdGhpcy5mb3JtQ29udHJvbENvbmZpZ3MgPSBbXTtcbiAgICB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzID0gW107XG4gICAgdGhpcy52YWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcCA9IG5ldyBNYXA7XG4gICAgdGhpcy5jaGFuZ2VzID0gbmV3IFN1YmplY3QoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDliJ3lp4vljJZcbiAgICovXG4gIHB1YmxpYyBpbml0KCkge1xuICAgIHRoaXMuY29sbGVjdE1ldGFkYXRhcygpO1xuICAgIHRoaXMuY3JlYXRlRm9ybUNvbnRyb2xzKCk7XG4gIH1cblxuICAvKipcbiAgICog5L2/55So5LiN5YyF5ZCr57ud5a+56Lev5b6E55qEL+aIluiAhS/lrZDooagv55qE6Lev5b6E5L+h5oGv6I635Y+W5a+55bqU55qEZm9ybUNvbnRyb2xDb25maWfnmoRuYW1l5bGe5oCn5LiOYmluZGluZ1BhdGjlubbkuJTov5Tlm57or6Xot6/lvoTnmoRmb3JtQ29udHJvbFxuICAgKiBAcGFyYW0gcGF0aCDot6/lvoTkv6Hmga8gXG4gICAqIEByZXR1cm5zICBcbiAgICovXG4gIGdldEZvcm1WYWx1ZUJ5QmluZFBhdGgocGF0aCkge1xuICAgIGxldCBmb3JtQ29udHJvbCA9IHtcbiAgICAgIGZvcm1fbmFtZToge30sXG4gICAgICBuYW1lOiAnJyxcbiAgICAgIGJpbmRpbmdQYXRoOiAnJ1xuICAgIH07XG4gICAgcGF0aCA9IHBhdGgucmVwbGFjZSgvXFwvL2csICcuJylcbiAgICBpZiAodGhpcy5mb3JtQ29udHJvbENvbmZpZ3MubGVuZ3RoID09PSAwKSByZXR1cm4gZm9ybUNvbnRyb2w7XG4gICAgdGhpcy5mb3JtQ29udHJvbENvbmZpZ3MuZm9yRWFjaCgoZm9ybUNvbnRyb2xDb25maWc6IEZvcm1Db250cm9sQ29uZmlnKSA9PiB7XG4gICAgICBpZiAoZm9ybUNvbnRyb2xDb25maWcuYmluZGluZ1BhdGggPT09IHBhdGgpIHtcbiAgICAgICAgZm9ybUNvbnRyb2wuZm9ybV9uYW1lID0gdGhpc1tmb3JtQ29udHJvbENvbmZpZy5uYW1lXTtcbiAgICAgICAgZm9ybUNvbnRyb2wubmFtZSA9IGZvcm1Db250cm9sQ29uZmlnLm5hbWU7XG4gICAgICAgIGZvcm1Db250cm9sLmJpbmRpbmdQYXRoID0gZm9ybUNvbnRyb2xDb25maWcuYmluZGluZ1BhdGg7XG4gICAgICB9XG4gICAgfSlcbiAgICByZXR1cm4gZm9ybUNvbnRyb2w7XG4gIH1cbiAgLyoqXG4gICAqIFxuICAgKiBAcmV0dXJucyDojrflj5blvZPliY3ooajljZXkuIrnmoTlrZjlnKjmoKHpqozlrZfmrrXnmoTpm4blkIhcbiAgICovXG4gIGdldFZhbGlkYXRlZm9ybUNvbnRyb2xzKCkge1xuICAgIHJldHVybiB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzO1xuICB9XG5cbiAgc2V0VmFsaWRhdGVmb3JtQ29udHJvbHMobmFtZSkge1xuXG4gICAgaWYgKHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMgJiYgdGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMucHVzaChuYW1lKVxuICAgIH1cblxuICAgIGlmICh0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzICYmIHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMubGVuZ3RoID49IDEpIHtcbiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5maW5kSW5kZXgoaXRlbSA9PiBpdGVtID09IG5hbWUpO1xuICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgICAgICB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLnB1c2gobmFtZSlcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIUFycmF5LmlzQXJyYXkodGhpcy52YWxpZGF0ZWZvcm1Db250cm9scykpIHtcbiAgICAgIHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMgPSBbbmFtZV1cbiAgICB9XG4gIH1cblxuICBnZXRWYWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcCgpIHtcbiAgICByZXR1cm4gdGhpcy52YWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcDtcbiAgfVxuXG4gIHNldFZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwKG5hbWUsIHZhbHVlKSB7XG4gICAgaWYgKCF0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwLmhhcyhuYW1lKSkge1xuICAgICAgdGhpcy52YWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcC5zZXQobmFtZSwgdmFsdWUpXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOS9v+eUqGZvcm1Db250cm9sQ29uZmln55qEYmluZGluZ1BhdGjot6/lvoTkv6Hmga/kuI7lr7nlupRmb3JtQ29udHJvbENvbmZpZ+eahG5hbWXkv6Hmga/lgqjlrZjotbfmnaXkvZzkuLrpqozor4Hkv6Hmga/lnKhmb3Jt5LiK55qE6K6w5b2VXG4gICAqIEBwYXJhbSBwYXRoIGZvcm1Db250cm9sQ29uZmln55qEYmluZGluZ1BhdGjot6/lvoTkv6Hmga9cbiAgICogQHBhcmFtIG5hbWUg5a+55bqUZm9ybUNvbnRyb+eahG5hbWXkv6Hmga9cbiAgICovXG4gIGFkZFZhbGlkYXRlKHBhdGgsIG5hbWUpIHtcbiAgICBsZXQgYmluZGluZ1BhdGggPSB0aGlzLnZpZXdNb2RlbENvbnRleHQuYmluZGluZ0RhdGEuYmluZGluZ1BhdGguc2xpY2UoMSkucmVwbGFjZSgvXFwvL2csICcuJyk7XG4gICAgaWYgKGJpbmRpbmdQYXRoKSB7IGJpbmRpbmdQYXRoID0gYmluZGluZ1BhdGggKyAnLicgfTtcbiAgICB0aGlzLnNldFZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwKGJpbmRpbmdQYXRoICsgcGF0aCwgbmFtZSk7XG4gICAgdGhpcy5zZXRWYWxpZGF0ZWZvcm1Db250cm9scyhuYW1lKVxuICB9XG5cblxuICAvKipcbiAgICog5YWo6YOo5qCh6aqMIFxuICAgKiAgZm9ybUNvbnRyb2xDb25maWdzIOS4iuaJgOacieeahGZvcm1Db250cm9s55qE5a2Y5Zyo5pa55rOV6LCD55So5LiA6YGNIOWwhumUmeivr+S/oeaBr+mbhuS4rei/lOWbnlxuICAgKi9cbiAgdmFsaWRhdGVGaWVsZHMoKSB7XG4gICAgbGV0IHZhbGlkYXRpb25SZXN1bHQgPSBbXTtcbiAgICBpZiAodGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5sZW5ndGggPT09IDApIHsgcmV0dXJuIHZhbGlkYXRpb25SZXN1bHQ7IH1cbiAgICB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLmZvckVhY2goKGZvcm1Db250cm9sKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQkID0gVmFsaWRhdG9yRmFjdG9yeS5leGVjdXRlVmFsaWRhdG9yKHRoaXNbZm9ybUNvbnRyb2xdWyd2YWxpZGF0b3JGbiddLCB0aGlzW2Zvcm1Db250cm9sXVsndmFsdWUnXSwgdGhpcy52aWV3TW9kZWxDb250ZXh0KS5waXBlKFxuICAgICAgICB0YXAoXG4gICAgICAgICAgKG1lc3NhZ2UpID0+IHtcbiAgICAgICAgICAgIHRoaXNbZm9ybUNvbnRyb2xdWyd2YWxpZGF0aW9uUmVzdWx0J10gPSBtZXNzYWdlO1xuICAgICAgICAgICAgIW1lc3NhZ2VbJ3Bhc3NpbmcnXSAmJiB0aGlzLmNoYW5nZXMubmV4dCh7IHR5cGU6ICd2YWxpZGF0ZUZpZWxkc0ZpbmlzaGVkJyB9KVxuICAgICAgICAgIH1cbiAgICAgICAgKVxuICAgICAgKVxuICAgICAgdmFsaWRhdGlvblJlc3VsdC5wdXNoKHJlc3VsdCQpXG4gICAgfSk7XG4gICAgcmV0dXJuIHZhbGlkYXRpb25SZXN1bHQ7XG4gIH1cblxuICAvKipcbiAgICog5LiN5pSv5oyB6Ieq5a6a5LmJ5byC5q2l5YWo6YOo5qCh6aqMIFxuICAgKiAgZm9ybUNvbnRyb2xDb25maWdzIOS4iuaJgOacieeahGZvcm1Db250cm9s55qE5a2Y5Zyo5pa55rOV6LCD55So5LiA6YGNIOWwhumUmeivr+S/oeaBr+mbhuS4rei/lOWbnlxuICAgKi9cbiAgbm9TdXBwb3J0QXN5blZhbGlkYXRlRmllbGRzKCkge1xuICAgIGxldCB2YWxpZGF0aW9uUmVzdWx0ID0gW107XG4gICAgaWYgKHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMubGVuZ3RoID09PSAwKSB7IHJldHVybiB2YWxpZGF0aW9uUmVzdWx0OyB9XG4gICAgdGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5mb3JFYWNoKChmb3JtQ29udHJvbCkgPT4ge1xuICAgICAgaWYgKCF0aGlzW2Zvcm1Db250cm9sXVsndmFsaWRhdGlvblJlc3VsdCddKSB7XG4gICAgICAgIHRoaXNbZm9ybUNvbnRyb2xdWyd2YWxpZGF0aW9uUmVzdWx0J10gPSBWYWxpZGF0b3JGYWN0b3J5Lm5vU3VwcG9ydEFzeW5FeGVjdXRlVmFsaWRhdG9yKHRoaXNbZm9ybUNvbnRyb2xdWyd2YWxpZGF0b3JGbiddLCB0aGlzW2Zvcm1Db250cm9sXVsndmFsdWUnXSwgdGhpcy52aWV3TW9kZWxDb250ZXh0KTtcbiAgICAgIH1cbiAgICAgICF0aGlzW2Zvcm1Db250cm9sXVsndmFsaWRhdGlvblJlc3VsdCddLnBhc3NpbmcgJiYgdmFsaWRhdGlvblJlc3VsdC5wdXNoKHRoaXNbZm9ybUNvbnRyb2xdKVxuICAgIH0pO1xuICAgIHRoaXMuY2hhbmdlcy5uZXh0KHsgdHlwZTogJ3ZhbGlkYXRlRmllbGRzRmluaXNoZWQnIH0pXG4gICAgcmV0dXJuIHZhbGlkYXRpb25SZXN1bHQ7XG4gIH1cblxuICAvKipcbiAgICog6I635Y+W5p+Q5LiA5Liq5b6X5qCh6aqM6ZSZ6K+v5L+h5oGvXG4gICAqIEBwYXJhbSBuYW1lIOWxnuaAp+WQjeensFxuICAgKi9cbiAgZ2V0RmllbGRFcnJvcihuYW1lOiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB7fVxuICAgIH1cbiAgICBjb25zdCBpbmRleCA9IHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMuZmluZEluZGV4KChpdGVtKSA9PiB7XG4gICAgICByZXR1cm4gaXRlbSA9PT0gbmFtZVxuICAgIH0pO1xuICAgIGlmIChpbmRleCA9PT0gLTEpIHtcbiAgICAgIHJldHVybiB7fVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCByZXN1bHQkID0gVmFsaWRhdG9yRmFjdG9yeS5leGVjdXRlVmFsaWRhdG9yKHRoaXNbbmFtZV1bJ3ZhbGlkYXRvckZuJ10sIHRoaXNbbmFtZV1bJ3ZhbHVlJ10sIHRoaXMudmlld01vZGVsQ29udGV4dCkucGlwZShcbiAgICAgICAgdGFwKFxuICAgICAgICAgIChtZXNzYWdlKSA9PiB7XG4gICAgICAgICAgICB0aGlzW25hbWVdWyd2YWxpZGF0aW9uUmVzdWx0J10gPSBtZXNzYWdlO1xuICAgICAgICAgICAgIW1lc3NhZ2VbJ3Bhc3NpbmcnXSAmJiB0aGlzLmNoYW5nZXMubmV4dCh7IHR5cGU6ICd2YWxpZGF0ZUZpZWxkc0ZpbmlzaGVkJyB9KVxuICAgICAgICAgIH1cbiAgICAgICAgKVxuICAgICAgKVxuICAgICAgcmV0dXJuIHJlc3VsdCQ7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gKiDmoLnmja5mb3Jt5YWD5pWw5o2u5Lit55qEcGF0aOiOt+WPluafkOS4gOS4quW+l+agoemqjOmUmeivr+S/oeaBr1xuICogQHBhcmFtIHBhdGgg5bGe5oCn5ZCN56ew5pWw57uEXG4gKi9cbiAgZ2V0RmllbGRFcnJvckJ5UGF0aChwYXRoOiBzdHJpbmdbXSkge1xuICAgIGlmICh0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHt9XG4gICAgfVxuICAgIGxldCBwYXRoTmFtZSA9IHBhdGhbMF1cbiAgICBpZiAocGF0aCAmJiBwYXRoLmxlbmd0aCA+PSAyKSB7XG4gICAgICBwYXRoTmFtZSA9IHBhdGguam9pbignLicpO1xuICAgIH1cbiAgICBjb25zdCBpbmRleCA9IHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbFBhdGhNYXAuaGFzKHBhdGhOYW1lKTtcbiAgICBpZiAoIWluZGV4KSB7XG4gICAgICByZXR1cm4ge31cbiAgICB9IGVsc2Uge1xuICAgICAgVmFsaWRhdG9yRmFjdG9yeS5leGVjdXRlVmFsaWRhdG9yKHRoaXNbdGhpcy52YWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcC5nZXQocGF0aE5hbWUpXVsndmFsaWRhdG9yRm4nXSwgdGhpc1t0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwLmdldChwYXRoTmFtZSldWyd2YWx1ZSddLCB0aGlzLnZpZXdNb2RlbENvbnRleHQpLnN1YnNjcmliZShcbiAgICAgICAgKG1lc3NhZ2UpID0+IHtcbiAgICAgICAgICB0aGlzW3RoaXMudmFsaWRhdGVmb3JtQ29udHJvbFBhdGhNYXAuZ2V0KHBhdGhOYW1lKV1bJ3ZhbGlkYXRpb25SZXN1bHQnXSA9IG1lc3NhZ2U7XG4gICAgICAgICAgdGhpcy5jaGFuZ2VzLm5leHQoeyB0eXBlOiAndmFsaWRhdGVGaWVsZHNGaW5pc2hlZCcsIHZhbHVlOiB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwLmdldChwYXRoTmFtZSkgfSk7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICAgIHJldHVybiB0aGlzW3RoaXMudmFsaWRhdGVmb3JtQ29udHJvbFBhdGhNYXAuZ2V0KHBhdGhOYW1lKV1bJ3ZhbGlkYXRpb25SZXN1bHQnXTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog5riF6Zmk5LiA57uE5a2X5q616aqM6K+B54q25oCBXG4gICAqIEBwYXJhbSBmaWVsZHMg5a2X5q6155qE5pWw57uEXG4gICAqL1xuICByZXNldEZpZWxkc1ZhbGlkYXRlKGZpZWxkcz86IHN0cmluZ1tdKSB7XG4gICAgaWYgKHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGZpZWxkcyAmJiBmaWVsZHMubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCBzYiA9IG5ldyBTZXQoZmllbGRzKTtcbiAgICAgICAgLy8g5Lqk6ZuGXG4gICAgICAgIGNvbnN0IGludGVyc2VjdCA9IHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMuZmlsdGVyKHggPT4gc2IuaGFzKHgpKTtcbiAgICAgICAgLy8g6YGN5Y6G5riF56m65omA5pyJ5qCh6aqM57uT5p6c5pWw5o2uXG4gICAgICAgIGludGVyc2VjdC5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICAgIHRoaXNbaXRlbV1bJ3ZhbGlkYXRpb25SZXN1bHQnXSA9IHVuZGVmaW5lZDtcbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIOayoeS8oOaVsOaNruWFqOmDqOa4hemZpFxuICAgICAgICB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgICAgdGhpc1tpdGVtXVsndmFsaWRhdGlvblJlc3VsdCddID0gdW5kZWZpbmVkO1xuICAgICAgICB9KVxuICAgICAgfVxuICAgICAgdGhpcy5jaGFuZ2VzLm5leHQoeyB0eXBlOiAndmFsaWRhdGVGaWVsZHNGaW5pc2hlZCcgfSlcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog5Yib5bu6Rm9ybUNvbnRyb2xzXG4gICAqL1xuICBwcml2YXRlIGNyZWF0ZUZvcm1Db250cm9scygpIHtcbiAgICB0aGlzLmZvcm1Db250cm9sQ29uZmlncy5mb3JFYWNoKChmb3JtQ29udHJvbENvbmZpZzogRm9ybUNvbnRyb2xDb25maWcpID0+IHtcbiAgICAgIGNvbnN0IG5hbWUgPSBmb3JtQ29udHJvbENvbmZpZy5uYW1lO1xuICAgICAgY29uc3QgZm9ybUNvbnRyb2wgPSBuZXcgRm9ybUNvbnRyb2woZm9ybUNvbnRyb2xDb25maWcsIHRoaXMudmlld01vZGVsQ29udGV4dCk7XG4gICAgICB0aGlzW25hbWVdID0gZm9ybUNvbnRyb2w7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICog5pS26ZuG5YWD5pWw5o2uXG4gICAqL1xuICBwcml2YXRlIGNvbGxlY3RNZXRhZGF0YXMoKSB7XG4gICAgY29uc3QgZm9ybUNvbnRyb2xNZXRhZGF0YXMgPSBNZXRhZGF0YVV0aWwuZ2V0UHJvcHNNZXRhZGF0YXNCeU5hbWUodGhpcy5jb25zdHJ1Y3RvciwgRk9STV9DT05UUk9MX1BST1BfTUVUQSk7XG4gICAgbGV0IGJpbmRpbmdQYXRoID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LmJpbmRpbmdEYXRhLmJpbmRpbmdQYXRoLnNsaWNlKDEpLnJlcGxhY2UoL1xcLy9nLCAnLicpO1xuICAgIGNvbnN0IHZhbGlkYXRpb25NYW5hZ2VyID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LmFwcENvbnRleHRbJ3ZhbGlkYXRpb25NYW5hZ2VyJ107XG4gICAgaWYgKGJpbmRpbmdQYXRoKSB7IGJpbmRpbmdQYXRoID0gYmluZGluZ1BhdGggKyAnLicgfTtcbiAgICBPYmplY3Qua2V5cyhmb3JtQ29udHJvbE1ldGFkYXRhcykuZm9yRWFjaCgobmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICBjb25zdCBmb3JtQ29udHJvbE1ldGFkYXRhID0gZm9ybUNvbnRyb2xNZXRhZGF0YXNbbmFtZV0gYXMgRm9ybUNvbnRyb2xNZXRhZGF0YTtcbiAgICAgIGxldCB2YWxpZFJ1bGVzID0gbnVsbDtcbiAgICAgIGlmIChmb3JtQ29udHJvbE1ldGFkYXRhLnZhbGlkUnVsZXMpIHtcbiAgICAgICAgdGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5wdXNoKG5hbWUpO1xuICAgICAgICB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwLnNldChiaW5kaW5nUGF0aCArIGZvcm1Db250cm9sTWV0YWRhdGEuYmluZGluZ1BhdGgsIG5hbWUpO1xuICAgICAgICB2YWxpZFJ1bGVzID0gZm9ybUNvbnRyb2xNZXRhZGF0YS52YWxpZFJ1bGVzO1xuICAgICAgfVxuICAgICAgY29uc3Qga2V5ID0gKCcvJytiaW5kaW5nUGF0aCtmb3JtQ29udHJvbE1ldGFkYXRhLmJpbmRpbmdQYXRoKS5yZXBsYWNlKC9cXC4vZywgJy8nKVxuICAgICAgaWYodmFsaWRhdGlvbk1hbmFnZXJba2V5XSl7XG4gICAgICAgIGlmKCF2YWxpZFJ1bGVzKXtcbiAgICAgICAgICB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLnB1c2gobmFtZSk7XG4gICAgICAgICAgdGhpcy52YWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcC5zZXQoYmluZGluZ1BhdGggKyBmb3JtQ29udHJvbE1ldGFkYXRhLmJpbmRpbmdQYXRoLCBuYW1lKTtcbiAgICAgICAgICB2YWxpZFJ1bGVzID0gT2JqZWN0LnZhbHVlcyh2YWxpZGF0aW9uTWFuYWdlcltrZXldKTtcbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgdmFsaWRSdWxlcyA9IHZhbGlkUnVsZXMuY29uY2F0KE9iamVjdC52YWx1ZXModmFsaWRhdGlvbk1hbmFnZXJba2V5XSkpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNvbnN0IGZvcm1Db250cm9sQ29uZmlnOiBGb3JtQ29udHJvbENvbmZpZyA9IHtcbiAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgYmluZGluZ1R5cGU6IGZvcm1Db250cm9sTWV0YWRhdGEuYmluZGluZ1R5cGUsXG4gICAgICAgIGJpbmRpbmdQYXRoOiBmb3JtQ29udHJvbE1ldGFkYXRhLmJpbmRpbmdQYXRoLFxuICAgICAgICB2YWx1ZUNvbnZlcnRlcjogZm9ybUNvbnRyb2xNZXRhZGF0YS52YWx1ZUNvbnZlcnRlcixcbiAgICAgICAgdmFsdWVDaGFuZ2luZzogZm9ybUNvbnRyb2xNZXRhZGF0YS52YWx1ZUNoYW5naW5nLFxuICAgICAgICB2YWx1ZUNoYW5nZWQ6IGZvcm1Db250cm9sTWV0YWRhdGEudmFsdWVDaGFuZ2VkLFxuICAgICAgICB2YWxpZFJ1bGVzOiB2YWxpZFJ1bGVzXG4gICAgICB9O1xuICAgICAgdGhpcy5mb3JtQ29udHJvbENvbmZpZ3MucHVzaChmb3JtQ29udHJvbENvbmZpZyk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0RW50aXR5VmFsdWVDaGFuZ2luZ0xpc3RlbmVycygpOiB7IFtwcm9wZXJ0eTogc3RyaW5nXTogc3RyaW5nIH0ge1xuICAgIGNvbnN0IGxpc3RlbmVycyA9IHt9O1xuICAgIHRoaXMuZm9ybUNvbnRyb2xDb25maWdzLmZvckVhY2goKGZvcm1Db250cm9sOiBGb3JtQ29udHJvbENvbmZpZykgPT4ge1xuICAgICAgaWYgKGZvcm1Db250cm9sLnZhbHVlQ2hhbmdpbmcpIHtcbiAgICAgICAgbGlzdGVuZXJzW2Zvcm1Db250cm9sLmJpbmRpbmdQYXRoXSA9IGZvcm1Db250cm9sLnZhbHVlQ2hhbmdpbmc7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGxpc3RlbmVycztcbiAgfVxuXG4gIHB1YmxpYyBnZXRFbnRpdHlWYWx1ZUNoYW5nZWRMaXN0ZW5lcnMoKTogeyBbcHJvcGVydHk6IHN0cmluZ106IHN0cmluZyB9IHtcbiAgICBjb25zdCBsaXN0ZW5lcnMgPSB7fTtcbiAgICB0aGlzLmZvcm1Db250cm9sQ29uZmlncy5mb3JFYWNoKChmb3JtQ29udHJvbDogRm9ybUNvbnRyb2xDb25maWcpID0+IHtcbiAgICAgIGlmIChmb3JtQ29udHJvbC52YWx1ZUNoYW5nZWQpIHtcbiAgICAgICAgbGlzdGVuZXJzW2Zvcm1Db250cm9sLmJpbmRpbmdQYXRoXSA9IGZvcm1Db250cm9sLnZhbHVlQ2hhbmdlZDtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gbGlzdGVuZXJzO1xuICB9XG59XG5cbmV4cG9ydCB7IEZvcm0gfTtcbiJdfQ==