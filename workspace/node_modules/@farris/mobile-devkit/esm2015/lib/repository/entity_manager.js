/*
 * @Author: Witt
 * @Date: 2019-03-07 17:24:38
 * @Last Modified by:   Witt
 * @Last Modified time: 2019-03-11 19:50:38
 */
import { createEntity, createEntities } from '../entity/index';
import { EntityCollection } from './entity_collection';
import { DataPathCreator, DataPathNodeType } from '../entity/index';
import { EntityUtil } from '../binding-data/entity_util';
/**
 * 实体管理类
 */
class EntityManager {
    /**
     * 构造函数
     */
    constructor(entityCollection) {
        this.entityCollection = entityCollection;
        this.entityType = entityCollection.entityType;
    }
    // #region 创建实体相关方法
    /**
     * 创建实体
     */
    createEntity(entityData) {
        const entity = createEntity(this.entityType, entityData);
        return entity;
    }
    /**
     * 批量创建实体
     */
    createEntities(entityListData, entityType) {
        const entities = createEntities(this.entityType, entityListData);
        return entities;
    }
    /**
     * 批量创建下级实体
     * @param fPath fpath
     * @param entityListData 实体数据
     */
    createEntitiesByPath(fPath, entityListData) {
        const subPaths = fPath.split('/');
        if (subPaths.length < 3) {
            throw Error(`根据path删除实体数据出错了。传入的path[${fPath}]格式不对`);
        }
        if (entityListData.length < 1) {
            return [];
        }
        let childEntityList;
        let propInfo;
        let propName;
        for (let i = 2; i < subPaths.length; i = i + 2) {
            const fid = subPaths[i - 1];
            propName = subPaths[i];
            const parentEntity = childEntityList ? childEntityList.get(fid) : this.entityCollection.getEntityById(fid);
            childEntityList = parentEntity[propName];
            const entityType = propInfo ? propInfo.propEntityType : this.entityType;
            propInfo = EntityUtil.getPropInfo(entityType, propName);
            if (!childEntityList) {
                throw Error(`fpath参数错误，无法找到${propName}对应的子表。fpath为：${fPath}`);
            }
        }
        const entities = entityListData.map(entityData => {
            return createEntity(propInfo.propEntityType, entityData);
        });
        return entities;
    }
    // #endregion
    // #region 获取实体、实体数组相关方法
    /**
     * 获取path对应的实体
     */
    getEntityByPath(path) {
        const entity = this.getEntityNodeByPath(path);
        return entity;
    }
    /**
     * 获取path对应的实体
     */
    getEntitiesByPath(path) {
        const entityCollectionOrList = this.getEntityNodeByPath(path);
        let entities;
        if (entityCollectionOrList instanceof EntityCollection === true) {
            entities = entityCollectionOrList.toArray();
        }
        else {
            entities = entityCollectionOrList.toArray();
        }
        return entities;
    }
    /**
     * 获取实体节点
     * @param path 节点路径
     */
    getEntityNodeByPath(path) {
        const dataPath = DataPathCreator.createByLongPathFromRoot(path, this);
        let entityNode = this.entityCollection;
        let pathNode = dataPath.head.next;
        while (pathNode) {
            if (pathNode.type === DataPathNodeType.DataId) {
                if (entityNode instanceof EntityCollection === true) {
                    entityNode = entityNode.getEntityById(pathNode.value);
                }
                else {
                    entityNode = entityNode.get(pathNode.value);
                }
            }
            else {
                entityNode = entityNode[pathNode.value];
            }
            if (!entityNode) {
                throw new Error(`找不到${pathNode.value}对应的数据节点`);
            }
            pathNode = pathNode.next;
        }
        return entityNode;
    }
    // #endregion
    // #region 获取、设置属性值
    /**
     * 获取path对应的实体属性值
     */
    getPropValueByPath(path) {
        const propName = path.pop();
        const entity = this.getEntityByPath(path);
        return entity[propName];
    }
    /**
     * 设置path对应实体的属性值
     */
    setPropValueByPath(path, propValue) {
        const propName = path.pop();
        const entity = this.getEntityByPath(path);
        entity[propName] = propValue;
    }
    // #endregion
    // #region 插入实体
    /**
     * 在path对应实体前插入实体
     */
    insertEntityBeforeByPath(fpath) {
        throw new Error('Not Implemented');
    }
    /**
     * 在path对应实体前批量插入实体
     */
    insertEntitiesBeforeByPath() {
        throw new Error('Not Implemented');
    }
    /**
     * 在path对应实体前插入实体
     */
    insertEntityAfterByPath() {
        throw new Error('Not Implemented');
    }
    /**
     * 在path对应实体前批量插入实体
     */
    insertEntitiesAfterByPath() {
        throw new Error('Not Implemented');
    }
    // #endregion
    // #region 追加实体
    /**
     * 在path对应的实体集合中追加1个实体
     */
    // public appendEntityByPath(fpath: string[], entity: Entity): void {
    //   const entityCollectionOrList = this.getEntityNodeByPath(fpath);
    //   if (entityCollectionOrList instanceof EntityCollection === true) {
    //     const entityCollection = entityCollectionOrList as EntityCollection<Entity>;
    //     entityCollection.addEntity(entity);
    //   } else {
    //     const entityList = (entityCollectionOrList as EntityList<Entity>);
    //     entityList.appendEntity(entity);
    //   }
    // }
    /**
     * 根据path获取实体集合
     * @param fpath 路径
     * @param entityData 实体数据
     * @param initialData[可选] 默认值
     */
    appendEntityByPath(fpath, entityData, initialData, isCloned = false) {
        const subPaths = fpath.split('/');
        if (subPaths.length < 3) {
            throw Error(`根据path删除实体数据出错了。传入的path[${fpath}]格式不对`);
        }
        let childEntityList;
        let propInfo;
        let propName;
        for (let i = 2; i < subPaths.length; i = i + 2) {
            const fid = subPaths[i - 1];
            propName = subPaths[i];
            // todo: EntityCollection重构之后这里无需差异处理
            const parentEntity = childEntityList ? childEntityList.get(fid) : this.entityCollection.getEntityById(fid);
            childEntityList = parentEntity[propName];
            const entityType = propInfo ? propInfo.propEntityType : this.entityType;
            propInfo = EntityUtil.getPropInfo(entityType, propName);
            if (!childEntityList) {
                throw Error(`fpath参数错误，无法找到${propName}对应的子表。fpath为：${fpath}`);
            }
        }
        // const propInfo = EntityUtil.getPropInfo(this.entityType, propName);
        const childEntity = createEntity(propInfo.propEntityType, entityData);
        // 在实体的实例上增加默认值属性，以便在createBindingObject时存放默认值
        if (initialData) {
            EntityUtil.appendInitialData(childEntity, initialData);
        }
        childEntityList.appendNew(childEntity, isCloned);
        return childEntity;
    }
    /**
     * 在指定位置插入实体
     * @param fpath 父路径
     * @param entityData 实体数据
     * @param initialData 初始数据
     * @param position 插入位置
     */
    insertEntityByPath(fpath, entityData, initialData, position) {
        const subPaths = fpath.split('/');
        if (subPaths.length < 3) {
            throw Error(`根据path删除实体数据出错了。传入的path[${fpath}]格式不对`);
        }
        let childEntityList;
        let propInfo;
        let propName;
        for (let i = 2; i < subPaths.length; i = i + 2) {
            const fid = subPaths[i - 1];
            propName = subPaths[i];
            // todo: EntityCollection重构之后这里无需差异处理
            const parentEntity = childEntityList ? childEntityList.get(fid) : this.entityCollection.getEntityById(fid);
            childEntityList = parentEntity[propName];
            const entityType = propInfo ? propInfo.propEntityType : this.entityType;
            propInfo = EntityUtil.getPropInfo(entityType, propName);
            if (!childEntityList) {
                throw Error(`fpath参数错误，无法找到${propName}对应的子表。fpath为：${fpath}`);
            }
        }
        // const propInfo = EntityUtil.getPropInfo(this.entityType, propName);
        const childEntity = createEntity(propInfo.propEntityType, entityData);
        // 在实体的实例上增加默认值属性，以便在createBindingObject时存放默认值
        if (initialData) {
            EntityUtil.appendInitialData(childEntity, initialData);
        }
        childEntityList.insert(childEntity, position);
        return childEntity;
    }
    /**
     * 在path对应的实体集合中追加多个实体
     */
    appendEntitiesByPath(fpath, entities) {
        const entityCollectionOrList = this.getEntityNodeByPath(fpath);
        if (entityCollectionOrList instanceof EntityCollection === true) {
            const entityCollection = entityCollectionOrList;
            entityCollection.addEntities(entities);
        }
        else {
            const entityList = entityCollectionOrList;
            entityList.appendEntities(entities);
        }
    }
    // #endregion
    // #region 删除实体
    /**
     * 从fapth对应的实体集合中删除id对应的实体
     */
    // public removeEntityByPath(fpath: string[], id: string): void {
    //   const entityCollectionOrList = this.getEntityNodeByPath(fpath);
    //   if (entityCollectionOrList instanceof EntityCollection === true) {
    //     const entityCollection = entityCollectionOrList as EntityCollection<Entity>;
    //     entityCollection.removeEntityById(id);
    //   } else {
    //     const entityList = (entityCollectionOrList as EntityList<Entity>);
    //     entityList.remove(id);
    //   }
    // }
    /**
     * 根据path获取实体集合
     * @param fpath path
     */
    removeEntityByPath(fpath, id) {
        const subPaths = fpath.split('/');
        if (subPaths.length < 3) {
            throw Error(`根据path删除实体数据出错了。传入的path[${fpath}]格式不对`);
        }
        let childEntityList;
        for (let i = 2; i < subPaths.length; i = i + 2) {
            const fid = subPaths[i - 1];
            const propName = subPaths[i];
            const parentEntity = childEntityList ? childEntityList.get(fid) : this.entityCollection.getEntityById(fid);
            childEntityList = parentEntity[propName];
            if (!childEntityList) {
                throw Error(`fpath参数错误，无法找到${propName}对应的子表。fpath为：${fpath}`);
            }
        }
        childEntityList.remove(id);
    }
    /**
     * 从fapth对应的实体集合中删除ids对应的实体
     */
    removeEntitiesByPath(fpath, ids) {
        // const entityCollectionOrList = this.getEntityNodeByPath(fpath);
        // if (entityCollectionOrList instanceof EntityCollection === true) {
        //   const entityCollection = entityCollectionOrList as EntityCollection<Entity>;
        //   entityCollection.removeEntitiesByIds(ids);
        // } else {
        //   const entityList = (entityCollectionOrList as EntityList<Entity>);
        //   entityList.remove(ids);
        // }
        throw new Error('Not Implemented');
    }
    // #endregion
    // #region 清空变更集相关方法
    /**
     * 清空所有实体的变更集
     */
    clearAllEntityChanges() {
        const entities = this.entityCollection.toArray();
        entities.forEach((entity) => {
            entity.changes.splice(0, entity.changes.length);
        });
    }
    resetAllEntityChangeMark() {
        const entities = this.entityCollection.toArray();
        entities.forEach((entity) => {
            entity.hasChange = false;
        });
    }
    /**
     * 清空id指定的实体变更集
     */
    clearEntityChangesById(id) {
        const entity = this.entityCollection.getEntityById(id);
        if (!entity) {
            return;
        }
        entity.changes.splice(0, entity.changes.length);
    }
    /**
     * 清空ids数组中指定的实体的变更集
     */
    clearEntityChangesByIds(ids) {
        if (!ids || ids.length < 0) {
            return;
        }
        ids.forEach((id) => {
            this.clearEntityChangesById(id);
        });
    }
    // #endregion
    // #region 变更集检查相关方法
    /**
     * 检查所有的实体，是否有未提交的变更
     */
    checkAllEntityChanges() {
        const entities = this.entityCollection.toArray();
        const hasChanges = entities.some((entity) => {
            if (entity.changes.length > 0) {
                return true;
            }
            else {
                return false;
            }
        });
        return hasChanges;
    }
    /**
     * 检查id对应的实体，是否有未提交的变更
     */
    checkEntityChangesById(id) {
        const entity = this.entityCollection.getEntityById(id);
        if (!entity) {
            return false;
        }
        return entity.changes.length > 0;
    }
    // #endregion
    // #region 不规范方法，待废弃
    /**
     * 待废弃
     * @deprecated
     */
    clearEntityChangesByArray(idArray) {
        this.clearEntityChangesByIds(idArray);
    }
}
export { EntityManager };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X21hbmFnZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvcmVwb3NpdG9yeS9lbnRpdHlfbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7R0FLRztBQUdILE9BQU8sRUFBc0IsWUFBWSxFQUFFLGNBQWMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ25GLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFBWSxlQUFlLEVBQUUsZ0JBQWdCLEVBQWdCLE1BQU0saUJBQWlCLENBQUM7QUFDNUYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBR3pEOztHQUVHO0FBQ0gsTUFBTSxhQUFhO0lBWWpCOztPQUVHO0lBQ0gsWUFBWSxnQkFBcUM7UUFDL0MsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDO1FBQ3pDLElBQUksQ0FBQyxVQUFVLEdBQUcsZ0JBQWdCLENBQUMsVUFBVSxDQUFDO0lBQ2hELENBQUM7SUFHRCxtQkFBbUI7SUFFbkI7O09BRUc7SUFDSSxZQUFZLENBQUMsVUFBZTtRQUNqQyxNQUFNLE1BQU0sR0FBRyxZQUFZLENBQUksSUFBSSxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUM1RCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRUQ7O09BRUc7SUFDSSxjQUFjLENBQUMsY0FBcUIsRUFBRSxVQUFlO1FBQzFELE1BQU0sUUFBUSxHQUFRLGNBQWMsQ0FBSSxJQUFJLENBQUMsVUFBVSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQ3pFLE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFDRDs7OztPQUlHO0lBQ0ksb0JBQW9CLENBQUMsS0FBYSxFQUFFLGNBQXFCO1FBQzlELE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENB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QyxDQUFDO1FBQ3ZELElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsT0FBTyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELGFBQWE7SUFHYixvQkFBb0I7SUFFcEI7OztPQUdHO0lBQ0kseUJBQXlCLENBQUMsT0FBaUI7UUFDaEQsSUFBSSxDQUFDLHVCQUF1QixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3hDLENBQUM7Q0FJRjtBQUVELE9BQU8sRUFBRSxhQUFhLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBAQXV0aG9yOiBXaXR0XG4gKiBARGF0ZTogMjAxOS0wMy0wNyAxNzoyNDozOFxuICogQExhc3QgTW9kaWZpZWQgYnk6ICAgV2l0dFxuICogQExhc3QgTW9kaWZpZWQgdGltZTogMjAxOS0wMy0xMSAxOTo1MDozOFxuICovXG5cbmltcG9ydCB7IFR5cGUgfSBmcm9tICcuLi9jb3JlL2luZGV4JztcbmltcG9ydCB7IEVudGl0eSwgRW50aXR5TGlzdCwgY3JlYXRlRW50aXR5LCBjcmVhdGVFbnRpdGllcyB9IGZyb20gJy4uL2VudGl0eS9pbmRleCc7XG5pbXBvcnQgeyBFbnRpdHlDb2xsZWN0aW9uIH0gZnJvbSAnLi9lbnRpdHlfY29sbGVjdGlvbic7XG5pbXBvcnQgeyBEYXRhUGF0aCwgRGF0YVBhdGhDcmVhdG9yLCBEYXRhUGF0aE5vZGVUeXBlLCBEYXRhVHlwZUluZm8gfSBmcm9tICcuLi9lbnRpdHkvaW5kZXgnO1xuaW1wb3J0IHsgRW50aXR5VXRpbCB9IGZyb20gJy4uL2JpbmRpbmctZGF0YS9lbnRpdHlfdXRpbCc7XG5cblxuLyoqXG4gKiDlrp7kvZPnrqHnkIbnsbtcbiAqL1xuY2xhc3MgRW50aXR5TWFuYWdlcjxUIGV4dGVuZHMgRW50aXR5PiB7XG5cbiAgLyoqXG4gICAqIOWunuS9k+exu+Wei1xuICAgKi9cbiAgcHVibGljIGVudGl0eVR5cGU6IFR5cGU8RW50aXR5PjtcblxuICAvKipcbiAgICog5a6e5L2T6ZuG5ZCIXG4gICAqL1xuICBwdWJsaWMgZW50aXR5Q29sbGVjdGlvbjogRW50aXR5Q29sbGVjdGlvbjxFbnRpdHk+O1xuXG4gIC8qKlxuICAgKiDmnoTpgKDlh73mlbBcbiAgICovXG4gIGNvbnN0cnVjdG9yKGVudGl0eUNvbGxlY3Rpb246IEVudGl0eUNvbGxlY3Rpb248VD4pIHtcbiAgICB0aGlzLmVudGl0eUNvbGxlY3Rpb24gPSBlbnRpdHlDb2xsZWN0aW9uO1xuICAgIHRoaXMuZW50aXR5VHlwZSA9IGVudGl0eUNvbGxlY3Rpb24uZW50aXR5VHlwZTtcbiAgfVxuXG5cbiAgLy8gI3JlZ2lvbiDliJvlu7rlrp7kvZPnm7jlhbPmlrnms5VcblxuICAvKipcbiAgICog5Yib5bu65a6e5L2TXG4gICAqL1xuICBwdWJsaWMgY3JlYXRlRW50aXR5KGVudGl0eURhdGE6IGFueSk6IFQge1xuICAgIGNvbnN0IGVudGl0eSA9IGNyZWF0ZUVudGl0eTxUPih0aGlzLmVudGl0eVR5cGUsIGVudGl0eURhdGEpO1xuICAgIHJldHVybiBlbnRpdHk7XG4gIH1cblxuICAvKipcbiAgICog5om56YeP5Yib5bu65a6e5L2TXG4gICAqL1xuICBwdWJsaWMgY3JlYXRlRW50aXRpZXMoZW50aXR5TGlzdERhdGE6IGFueVtdLCBlbnRpdHlUeXBlOiBhbnkpOiBUW10ge1xuICAgIGNvbnN0IGVudGl0aWVzOiBUW10gPSBjcmVhdGVFbnRpdGllczxUPih0aGlzLmVudGl0eVR5cGUsIGVudGl0eUxpc3REYXRhKTtcbiAgICByZXR1cm4gZW50aXRpZXM7XG4gIH1cbiAgLyoqXG4gICAqIOaJuemHj+WIm+W7uuS4i+e6p+WunuS9k1xuICAgKiBAcGFyYW0gZlBhdGggZnBhdGhcbiAgICogQHBhcmFtIGVudGl0eUxpc3REYXRhIOWunuS9k+aVsOaNrlxuICAgKi9cbiAgcHVibGljIGNyZWF0ZUVudGl0aWVzQnlQYXRoKGZQYXRoOiBzdHJpbmcsIGVudGl0eUxpc3REYXRhOiBhbnlbXSkge1xuICAgIGNvbnN0IHN1YlBhdGhzID0gZlBhdGguc3BsaXQoJy8nKTtcbiAgICBpZiAoc3ViUGF0aHMubGVuZ3RoIDwgMykge1xuICAgICAgdGhyb3cgRXJyb3IoYOagueaNrnBhdGjliKDpmaTlrp7kvZPmlbDmja7lh7rplJnkuobjgILkvKDlhaXnmoRwYXRoWyR7ZlBhdGh9XeagvOW8j+S4jeWvuWApO1xuICAgIH1cbiAgICBpZiAoZW50aXR5TGlzdERhdGEubGVuZ3RoIDwgMSkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBsZXQgY2hpbGRFbnRpdHlMaXN0OiBFbnRpdHlMaXN0PGFueT47XG4gICAgbGV0IHByb3BJbmZvOiB7IHByb3BUeXBlOiBzdHJpbmcsIHByb3BFbnRpdHlUeXBlOiBhbnkgfTtcbiAgICBsZXQgcHJvcE5hbWU6IHN0cmluZztcbiAgICBmb3IgKGxldCBpID0gMjsgaSA8IHN1YlBhdGhzLmxlbmd0aDsgaSA9IGkgKyAyKSB7XG4gICAgICBjb25zdCBmaWQgPSBzdWJQYXRoc1tpIC0gMV07XG4gICAgICBwcm9wTmFtZSA9IHN1YlBhdGhzW2ldO1xuICAgICAgY29uc3QgcGFyZW50RW50aXR5ID0gY2hpbGRFbnRpdHlMaXN0ID8gY2hpbGRFbnRpdHlMaXN0LmdldChmaWQpIDogdGhpcy5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0eUJ5SWQoZmlkKTtcbiAgICAgIGNoaWxkRW50aXR5TGlzdCA9IHBhcmVudEVudGl0eVtwcm9wTmFtZV07XG4gICAgICBjb25zdCBlbnRpdHlUeXBlID0gcHJvcEluZm8gPyBwcm9wSW5mby5wcm9wRW50aXR5VHlwZSA6IHRoaXMuZW50aXR5VHlwZTtcbiAgICAgIHByb3BJbmZvID0gRW50aXR5VXRpbC5nZXRQcm9wSW5mbyhlbnRpdHlUeXBlLCBwcm9wTmFtZSk7XG4gICAgICBpZiAoIWNoaWxkRW50aXR5TGlzdCkge1xuICAgICAgICB0aHJvdyBFcnJvcihgZnBhdGjlj4LmlbDplJnor6/vvIzml6Dms5Xmib7liLAke3Byb3BOYW1lfeWvueW6lOeahOWtkOihqOOAgmZwYXRo5Li677yaJHtmUGF0aH1gKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgZW50aXRpZXMgPSBlbnRpdHlMaXN0RGF0YS5tYXAoZW50aXR5RGF0YSA9PiB7XG4gICAgICByZXR1cm4gY3JlYXRlRW50aXR5PEVudGl0eT4ocHJvcEluZm8ucHJvcEVudGl0eVR5cGUsIGVudGl0eURhdGEpO1xuICAgIH0pO1xuICAgIHJldHVybiBlbnRpdGllcztcbiAgfVxuICAvLyAjZW5kcmVnaW9uXG5cblxuICAvLyAjcmVnaW9uIOiOt+WPluWunuS9k+OAgeWunuS9k+aVsOe7hOebuOWFs+aWueazlVxuXG4gIC8qKlxuICAgKiDojrflj5ZwYXRo5a+55bqU55qE5a6e5L2TXG4gICAqL1xuICBwdWJsaWMgZ2V0RW50aXR5QnlQYXRoKHBhdGg6IHN0cmluZ1tdKTogRW50aXR5IHtcbiAgICBjb25zdCBlbnRpdHkgPSB0aGlzLmdldEVudGl0eU5vZGVCeVBhdGgocGF0aCkgYXMgRW50aXR5O1xuICAgIHJldHVybiBlbnRpdHk7XG4gIH1cblxuICAvKipcbiAgICog6I635Y+WcGF0aOWvueW6lOeahOWunuS9k1xuICAgKi9cbiAgcHVibGljIGdldEVudGl0aWVzQnlQYXRoKHBhdGg6IHN0cmluZ1tdKTogRW50aXR5W10ge1xuICAgIGNvbnN0IGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgPSB0aGlzLmdldEVudGl0eU5vZGVCeVBhdGgocGF0aCkgYXMgRW50aXR5Q29sbGVjdGlvbjxFbnRpdHk+IHwgRW50aXR5TGlzdDxFbnRpdHk+O1xuICAgIGxldCBlbnRpdGllczogRW50aXR5W107XG4gICAgaWYgKGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgaW5zdGFuY2VvZiBFbnRpdHlDb2xsZWN0aW9uID09PSB0cnVlKSB7XG4gICAgICBlbnRpdGllcyA9IChlbnRpdHlDb2xsZWN0aW9uT3JMaXN0IGFzIEVudGl0eUNvbGxlY3Rpb248RW50aXR5PikudG9BcnJheSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBlbnRpdGllcyA9IChlbnRpdHlDb2xsZWN0aW9uT3JMaXN0IGFzIEVudGl0eUxpc3Q8RW50aXR5PikudG9BcnJheSgpO1xuICAgIH1cbiAgICByZXR1cm4gZW50aXRpZXM7XG4gIH1cblxuICAvKipcbiAgICog6I635Y+W5a6e5L2T6IqC54K5XG4gICAqIEBwYXJhbSBwYXRoIOiKgueCuei3r+W+hFxuICAgKi9cbiAgcHVibGljIGdldEVudGl0eU5vZGVCeVBhdGgocGF0aDogc3RyaW5nW10pOiBFbnRpdHlDb2xsZWN0aW9uPEVudGl0eT4gfCBFbnRpdHlMaXN0PEVudGl0eT4gfCBFbnRpdHkge1xuICAgIGNvbnN0IGRhdGFQYXRoID0gRGF0YVBhdGhDcmVhdG9yLmNyZWF0ZUJ5TG9uZ1BhdGhGcm9tUm9vdChwYXRoLCB0aGlzKTtcbiAgICBsZXQgZW50aXR5Tm9kZTogYW55ID0gdGhpcy5lbnRpdHlDb2xsZWN0aW9uO1xuICAgIGxldCBwYXRoTm9kZSA9IGRhdGFQYXRoLmhlYWQubmV4dDtcbiAgICB3aGlsZSAocGF0aE5vZGUpIHtcbiAgICAgIGlmIChwYXRoTm9kZS50eXBlID09PSBEYXRhUGF0aE5vZGVUeXBlLkRhdGFJZCkge1xuICAgICAgICBpZiAoZW50aXR5Tm9kZSBpbnN0YW5jZW9mIEVudGl0eUNvbGxlY3Rpb24gPT09IHRydWUpIHtcbiAgICAgICAgICBlbnRpdHlOb2RlID0gKGVudGl0eU5vZGUgYXMgRW50aXR5Q29sbGVjdGlvbjxFbnRpdHk+KS5nZXRFbnRpdHlCeUlkKHBhdGhOb2RlLnZhbHVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBlbnRpdHlOb2RlID0gKGVudGl0eU5vZGUgYXMgRW50aXR5TGlzdDxFbnRpdHk+KS5nZXQocGF0aE5vZGUudmFsdWUpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBlbnRpdHlOb2RlID0gZW50aXR5Tm9kZVtwYXRoTm9kZS52YWx1ZV07XG4gICAgICB9XG4gICAgICBpZiAoIWVudGl0eU5vZGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGDmib7kuI3liLAke3BhdGhOb2RlLnZhbHVlfeWvueW6lOeahOaVsOaNruiKgueCuWApO1xuICAgICAgfVxuICAgICAgcGF0aE5vZGUgPSBwYXRoTm9kZS5uZXh0O1xuICAgIH1cbiAgICByZXR1cm4gZW50aXR5Tm9kZTtcbiAgfVxuICAvLyAjZW5kcmVnaW9uXG5cblxuICAvLyAjcmVnaW9uIOiOt+WPluOAgeiuvue9ruWxnuaAp+WAvFxuXG4gIC8qKlxuICAgKiDojrflj5ZwYXRo5a+55bqU55qE5a6e5L2T5bGe5oCn5YC8XG4gICAqL1xuICBwdWJsaWMgZ2V0UHJvcFZhbHVlQnlQYXRoKHBhdGg6IHN0cmluZ1tdKTogYW55IHtcbiAgICBjb25zdCBwcm9wTmFtZSA9IHBhdGgucG9wKCk7XG4gICAgY29uc3QgZW50aXR5ID0gdGhpcy5nZXRFbnRpdHlCeVBhdGgocGF0aCk7XG4gICAgcmV0dXJuIGVudGl0eVtwcm9wTmFtZV07XG4gIH1cblxuICAvKipcbiAgICog6K6+572ucGF0aOWvueW6lOWunuS9k+eahOWxnuaAp+WAvFxuICAgKi9cbiAgcHVibGljIHNldFByb3BWYWx1ZUJ5UGF0aChwYXRoOiBzdHJpbmdbXSwgcHJvcFZhbHVlOiBhbnkpOiB2b2lkIHtcbiAgICBjb25zdCBwcm9wTmFtZSA9IHBhdGgucG9wKCk7XG4gICAgY29uc3QgZW50aXR5ID0gdGhpcy5nZXRFbnRpdHlCeVBhdGgocGF0aCk7XG4gICAgZW50aXR5W3Byb3BOYW1lXSA9IHByb3BWYWx1ZTtcbiAgfVxuXG4gIC8vICNlbmRyZWdpb25cblxuXG4gIC8vICNyZWdpb24g5o+S5YWl5a6e5L2TXG5cbiAgLyoqXG4gICAqIOWcqHBhdGjlr7nlupTlrp7kvZPliY3mj5LlhaXlrp7kvZNcbiAgICovXG4gIHB1YmxpYyBpbnNlcnRFbnRpdHlCZWZvcmVCeVBhdGgoZnBhdGg6IHN0cmluZ1tdKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgSW1wbGVtZW50ZWQnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDlnKhwYXRo5a+55bqU5a6e5L2T5YmN5om56YeP5o+S5YWl5a6e5L2TXG4gICAqL1xuICBwdWJsaWMgaW5zZXJ0RW50aXRpZXNCZWZvcmVCeVBhdGgoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgSW1wbGVtZW50ZWQnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDlnKhwYXRo5a+55bqU5a6e5L2T5YmN5o+S5YWl5a6e5L2TXG4gICAqL1xuICBwdWJsaWMgaW5zZXJ0RW50aXR5QWZ0ZXJCeVBhdGgoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgSW1wbGVtZW50ZWQnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDlnKhwYXRo5a+55bqU5a6e5L2T5YmN5om56YeP5o+S5YWl5a6e5L2TXG4gICAqL1xuICBwdWJsaWMgaW5zZXJ0RW50aXRpZXNBZnRlckJ5UGF0aCgpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBJbXBsZW1lbnRlZCcpO1xuICB9XG5cbiAgLy8gI2VuZHJlZ2lvblxuXG5cbiAgLy8gI3JlZ2lvbiDov73liqDlrp7kvZNcblxuICAvKipcbiAgICog5ZyocGF0aOWvueW6lOeahOWunuS9k+mbhuWQiOS4rei/veWKoDHkuKrlrp7kvZNcbiAgICovXG4gIC8vIHB1YmxpYyBhcHBlbmRFbnRpdHlCeVBhdGgoZnBhdGg6IHN0cmluZ1tdLCBlbnRpdHk6IEVudGl0eSk6IHZvaWQge1xuICAvLyAgIGNvbnN0IGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgPSB0aGlzLmdldEVudGl0eU5vZGVCeVBhdGgoZnBhdGgpO1xuICAvLyAgIGlmIChlbnRpdHlDb2xsZWN0aW9uT3JMaXN0IGluc3RhbmNlb2YgRW50aXR5Q29sbGVjdGlvbiA9PT0gdHJ1ZSkge1xuICAvLyAgICAgY29uc3QgZW50aXR5Q29sbGVjdGlvbiA9IGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgYXMgRW50aXR5Q29sbGVjdGlvbjxFbnRpdHk+O1xuICAvLyAgICAgZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdHkoZW50aXR5KTtcbiAgLy8gICB9IGVsc2Uge1xuICAvLyAgICAgY29uc3QgZW50aXR5TGlzdCA9IChlbnRpdHlDb2xsZWN0aW9uT3JMaXN0IGFzIEVudGl0eUxpc3Q8RW50aXR5Pik7XG4gIC8vICAgICBlbnRpdHlMaXN0LmFwcGVuZEVudGl0eShlbnRpdHkpO1xuICAvLyAgIH1cbiAgLy8gfVxuXG4gIC8qKlxuICAgKiDmoLnmja5wYXRo6I635Y+W5a6e5L2T6ZuG5ZCIXG4gICAqIEBwYXJhbSBmcGF0aCDot6/lvoRcbiAgICogQHBhcmFtIGVudGl0eURhdGEg5a6e5L2T5pWw5o2uXG4gICAqIEBwYXJhbSBpbml0aWFsRGF0YVvlj6/pgIldIOm7mOiupOWAvFxuICAgKi9cbiAgcHVibGljIGFwcGVuZEVudGl0eUJ5UGF0aChmcGF0aDogc3RyaW5nLCBlbnRpdHlEYXRhOiBhbnksIGluaXRpYWxEYXRhPzogYW55LCBpc0Nsb25lZDogYm9vbGVhbiA9IGZhbHNlKTogRW50aXR5IHtcbiAgICBjb25zdCBzdWJQYXRocyA9IGZwYXRoLnNwbGl0KCcvJyk7XG4gICAgaWYgKHN1YlBhdGhzLmxlbmd0aCA8IDMpIHtcbiAgICAgIHRocm93IEVycm9yKGDmoLnmja5wYXRo5Yig6Zmk5a6e5L2T5pWw5o2u5Ye66ZSZ5LqG44CC5Lyg5YWl55qEcGF0aFske2ZwYXRofV3moLzlvI/kuI3lr7lgKTtcbiAgICB9XG5cbiAgICBsZXQgY2hpbGRFbnRpdHlMaXN0OiBFbnRpdHlMaXN0PGFueT47XG4gICAgbGV0IHByb3BJbmZvOiB7IHByb3BUeXBlOiBzdHJpbmcsIHByb3BFbnRpdHlUeXBlOiBhbnkgfTtcbiAgICBsZXQgcHJvcE5hbWU6IHN0cmluZztcbiAgICBmb3IgKGxldCBpID0gMjsgaSA8IHN1YlBhdGhzLmxlbmd0aDsgaSA9IGkgKyAyKSB7XG4gICAgICBjb25zdCBmaWQgPSBzdWJQYXRoc1tpIC0gMV07XG4gICAgICBwcm9wTmFtZSA9IHN1YlBhdGhzW2ldO1xuXG4gICAgICAvLyB0b2RvOiBFbnRpdHlDb2xsZWN0aW9u6YeN5p6E5LmL5ZCO6L+Z6YeM5peg6ZyA5beu5byC5aSE55CGXG4gICAgICBjb25zdCBwYXJlbnRFbnRpdHkgPSBjaGlsZEVudGl0eUxpc3QgPyBjaGlsZEVudGl0eUxpc3QuZ2V0KGZpZCkgOiB0aGlzLmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChmaWQpO1xuICAgICAgY2hpbGRFbnRpdHlMaXN0ID0gcGFyZW50RW50aXR5W3Byb3BOYW1lXTtcbiAgICAgIGNvbnN0IGVudGl0eVR5cGUgPSBwcm9wSW5mbyA/IHByb3BJbmZvLnByb3BFbnRpdHlUeXBlIDogdGhpcy5lbnRpdHlUeXBlO1xuICAgICAgcHJvcEluZm8gPSBFbnRpdHlVdGlsLmdldFByb3BJbmZvKGVudGl0eVR5cGUsIHByb3BOYW1lKTtcbiAgICAgIGlmICghY2hpbGRFbnRpdHlMaXN0KSB7XG4gICAgICAgIHRocm93IEVycm9yKGBmcGF0aOWPguaVsOmUmeivr++8jOaXoOazleaJvuWIsCR7cHJvcE5hbWV95a+55bqU55qE5a2Q6KGo44CCZnBhdGjkuLrvvJoke2ZwYXRofWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGNvbnN0IHByb3BJbmZvID0gRW50aXR5VXRpbC5nZXRQcm9wSW5mbyh0aGlzLmVudGl0eVR5cGUsIHByb3BOYW1lKTtcbiAgICBjb25zdCBjaGlsZEVudGl0eSA9IGNyZWF0ZUVudGl0eTxFbnRpdHk+KHByb3BJbmZvLnByb3BFbnRpdHlUeXBlLCBlbnRpdHlEYXRhKTtcbiAgICAvLyDlnKjlrp7kvZPnmoTlrp7kvovkuIrlop7liqDpu5jorqTlgLzlsZ7mgKfvvIzku6Xkvr/lnKhjcmVhdGVCaW5kaW5nT2JqZWN05pe25a2Y5pS+6buY6K6k5YC8XG4gICAgaWYgKGluaXRpYWxEYXRhKSB7XG4gICAgICBFbnRpdHlVdGlsLmFwcGVuZEluaXRpYWxEYXRhKGNoaWxkRW50aXR5LCBpbml0aWFsRGF0YSk7XG4gICAgfVxuICAgIGNoaWxkRW50aXR5TGlzdC5hcHBlbmROZXcoY2hpbGRFbnRpdHksIGlzQ2xvbmVkKTtcbiAgICByZXR1cm4gY2hpbGRFbnRpdHk7XG4gIH1cbiAgLyoqXG4gICAqIOWcqOaMh+WumuS9jee9ruaPkuWFpeWunuS9k1xuICAgKiBAcGFyYW0gZnBhdGgg54i26Lev5b6EXG4gICAqIEBwYXJhbSBlbnRpdHlEYXRhIOWunuS9k+aVsOaNrlxuICAgKiBAcGFyYW0gaW5pdGlhbERhdGEg5Yid5aeL5pWw5o2uXG4gICAqIEBwYXJhbSBwb3NpdGlvbiDmj5LlhaXkvY3nva5cbiAgICovXG4gIHB1YmxpYyBpbnNlcnRFbnRpdHlCeVBhdGgoZnBhdGg6IHN0cmluZywgZW50aXR5RGF0YTogYW55LCBpbml0aWFsRGF0YT86IGFueSwgcG9zaXRpb24/OiAxIHwgLTEpIHtcbiAgICBjb25zdCBzdWJQYXRocyA9IGZwYXRoLnNwbGl0KCcvJyk7XG4gICAgaWYgKHN1YlBhdGhzLmxlbmd0aCA8IDMpIHtcbiAgICAgIHRocm93IEVycm9yKGDmoLnmja5wYXRo5Yig6Zmk5a6e5L2T5pWw5o2u5Ye66ZSZ5LqG44CC5Lyg5YWl55qEcGF0aFske2ZwYXRofV3moLzlvI/kuI3lr7lgKTtcbiAgICB9XG5cbiAgICBsZXQgY2hpbGRFbnRpdHlMaXN0OiBFbnRpdHlMaXN0PGFueT47XG4gICAgbGV0IHByb3BJbmZvOiB7IHByb3BUeXBlOiBzdHJpbmcsIHByb3BFbnRpdHlUeXBlOiBhbnkgfTtcbiAgICBsZXQgcHJvcE5hbWU6IHN0cmluZztcbiAgICBmb3IgKGxldCBpID0gMjsgaSA8IHN1YlBhdGhzLmxlbmd0aDsgaSA9IGkgKyAyKSB7XG4gICAgICBjb25zdCBmaWQgPSBzdWJQYXRoc1tpIC0gMV07XG4gICAgICBwcm9wTmFtZSA9IHN1YlBhdGhzW2ldO1xuXG4gICAgICAvLyB0b2RvOiBFbnRpdHlDb2xsZWN0aW9u6YeN5p6E5LmL5ZCO6L+Z6YeM5peg6ZyA5beu5byC5aSE55CGXG4gICAgICBjb25zdCBwYXJlbnRFbnRpdHkgPSBjaGlsZEVudGl0eUxpc3QgPyBjaGlsZEVudGl0eUxpc3QuZ2V0KGZpZCkgOiB0aGlzLmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChmaWQpO1xuICAgICAgY2hpbGRFbnRpdHlMaXN0ID0gcGFyZW50RW50aXR5W3Byb3BOYW1lXTtcbiAgICAgIGNvbnN0IGVudGl0eVR5cGUgPSBwcm9wSW5mbyA/IHByb3BJbmZvLnByb3BFbnRpdHlUeXBlIDogdGhpcy5lbnRpdHlUeXBlO1xuICAgICAgcHJvcEluZm8gPSBFbnRpdHlVdGlsLmdldFByb3BJbmZvKGVudGl0eVR5cGUsIHByb3BOYW1lKTtcbiAgICAgIGlmICghY2hpbGRFbnRpdHlMaXN0KSB7XG4gICAgICAgIHRocm93IEVycm9yKGBmcGF0aOWPguaVsOmUmeivr++8jOaXoOazleaJvuWIsCR7cHJvcE5hbWV95a+55bqU55qE5a2Q6KGo44CCZnBhdGjkuLrvvJoke2ZwYXRofWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGNvbnN0IHByb3BJbmZvID0gRW50aXR5VXRpbC5nZXRQcm9wSW5mbyh0aGlzLmVudGl0eVR5cGUsIHByb3BOYW1lKTtcbiAgICBjb25zdCBjaGlsZEVudGl0eSA9IGNyZWF0ZUVudGl0eTxFbnRpdHk+KHByb3BJbmZvLnByb3BFbnRpdHlUeXBlLCBlbnRpdHlEYXRhKTtcbiAgICAvLyDlnKjlrp7kvZPnmoTlrp7kvovkuIrlop7liqDpu5jorqTlgLzlsZ7mgKfvvIzku6Xkvr/lnKhjcmVhdGVCaW5kaW5nT2JqZWN05pe25a2Y5pS+6buY6K6k5YC8XG4gICAgaWYgKGluaXRpYWxEYXRhKSB7XG4gICAgICBFbnRpdHlVdGlsLmFwcGVuZEluaXRpYWxEYXRhKGNoaWxkRW50aXR5LCBpbml0aWFsRGF0YSk7XG4gICAgfVxuICAgIGNoaWxkRW50aXR5TGlzdC5pbnNlcnQoY2hpbGRFbnRpdHksIHBvc2l0aW9uKTtcbiAgICByZXR1cm4gY2hpbGRFbnRpdHk7XG4gIH1cbiAgLyoqXG4gICAqIOWcqHBhdGjlr7nlupTnmoTlrp7kvZPpm4blkIjkuK3ov73liqDlpJrkuKrlrp7kvZNcbiAgICovXG4gIHB1YmxpYyBhcHBlbmRFbnRpdGllc0J5UGF0aChmcGF0aDogc3RyaW5nW10sIGVudGl0aWVzOiBFbnRpdHlbXSkge1xuICAgIGNvbnN0IGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgPSB0aGlzLmdldEVudGl0eU5vZGVCeVBhdGgoZnBhdGgpO1xuICAgIGlmIChlbnRpdHlDb2xsZWN0aW9uT3JMaXN0IGluc3RhbmNlb2YgRW50aXR5Q29sbGVjdGlvbiA9PT0gdHJ1ZSkge1xuICAgICAgY29uc3QgZW50aXR5Q29sbGVjdGlvbiA9IGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgYXMgRW50aXR5Q29sbGVjdGlvbjxFbnRpdHk+O1xuICAgICAgZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdGllcyhlbnRpdGllcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGVudGl0eUxpc3QgPSAoZW50aXR5Q29sbGVjdGlvbk9yTGlzdCBhcyBFbnRpdHlMaXN0PEVudGl0eT4pO1xuICAgICAgZW50aXR5TGlzdC5hcHBlbmRFbnRpdGllcyhlbnRpdGllcyk7XG4gICAgfVxuICB9XG5cbiAgLy8gI2VuZHJlZ2lvblxuXG5cbiAgLy8gI3JlZ2lvbiDliKDpmaTlrp7kvZNcblxuICAvKipcbiAgICog5LuOZmFwdGjlr7nlupTnmoTlrp7kvZPpm4blkIjkuK3liKDpmaRpZOWvueW6lOeahOWunuS9k1xuICAgKi9cbiAgLy8gcHVibGljIHJlbW92ZUVudGl0eUJ5UGF0aChmcGF0aDogc3RyaW5nW10sIGlkOiBzdHJpbmcpOiB2b2lkIHtcbiAgLy8gICBjb25zdCBlbnRpdHlDb2xsZWN0aW9uT3JMaXN0ID0gdGhpcy5nZXRFbnRpdHlOb2RlQnlQYXRoKGZwYXRoKTtcbiAgLy8gICBpZiAoZW50aXR5Q29sbGVjdGlvbk9yTGlzdCBpbnN0YW5jZW9mIEVudGl0eUNvbGxlY3Rpb24gPT09IHRydWUpIHtcbiAgLy8gICAgIGNvbnN0IGVudGl0eUNvbGxlY3Rpb24gPSBlbnRpdHlDb2xsZWN0aW9uT3JMaXN0IGFzIEVudGl0eUNvbGxlY3Rpb248RW50aXR5PjtcbiAgLy8gICAgIGVudGl0eUNvbGxlY3Rpb24ucmVtb3ZlRW50aXR5QnlJZChpZCk7XG4gIC8vICAgfSBlbHNlIHtcbiAgLy8gICAgIGNvbnN0IGVudGl0eUxpc3QgPSAoZW50aXR5Q29sbGVjdGlvbk9yTGlzdCBhcyBFbnRpdHlMaXN0PEVudGl0eT4pO1xuICAvLyAgICAgZW50aXR5TGlzdC5yZW1vdmUoaWQpO1xuICAvLyAgIH1cbiAgLy8gfVxuXG4gIC8qKlxuICAgKiDmoLnmja5wYXRo6I635Y+W5a6e5L2T6ZuG5ZCIXG4gICAqIEBwYXJhbSBmcGF0aCBwYXRoXG4gICAqL1xuICBwdWJsaWMgcmVtb3ZlRW50aXR5QnlQYXRoKGZwYXRoOiBzdHJpbmcsIGlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBzdWJQYXRocyA9IGZwYXRoLnNwbGl0KCcvJyk7XG4gICAgaWYgKHN1YlBhdGhzLmxlbmd0aCA8IDMpIHtcbiAgICAgIHRocm93IEVycm9yKGDmoLnmja5wYXRo5Yig6Zmk5a6e5L2T5pWw5o2u5Ye66ZSZ5LqG44CC5Lyg5YWl55qEcGF0aFske2ZwYXRofV3moLzlvI/kuI3lr7lgKTtcbiAgICB9XG4gICAgbGV0IGNoaWxkRW50aXR5TGlzdDogRW50aXR5TGlzdDxhbnk+O1xuICAgIGZvciAobGV0IGkgPSAyOyBpIDwgc3ViUGF0aHMubGVuZ3RoOyBpID0gaSArIDIpIHtcbiAgICAgIGNvbnN0IGZpZCA9IHN1YlBhdGhzW2kgLSAxXTtcbiAgICAgIGNvbnN0IHByb3BOYW1lID0gc3ViUGF0aHNbaV07XG4gICAgICBjb25zdCBwYXJlbnRFbnRpdHkgPSBjaGlsZEVudGl0eUxpc3QgPyBjaGlsZEVudGl0eUxpc3QuZ2V0KGZpZCkgOiB0aGlzLmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChmaWQpO1xuICAgICAgY2hpbGRFbnRpdHlMaXN0ID0gcGFyZW50RW50aXR5W3Byb3BOYW1lXTtcbiAgICAgIGlmICghY2hpbGRFbnRpdHlMaXN0KSB7XG4gICAgICAgIHRocm93IEVycm9yKGBmcGF0aOWPguaVsOmUmeivr++8jOaXoOazleaJvuWIsCR7cHJvcE5hbWV95a+55bqU55qE5a2Q6KGo44CCZnBhdGjkuLrvvJoke2ZwYXRofWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNoaWxkRW50aXR5TGlzdC5yZW1vdmUoaWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIOS7jmZhcHRo5a+55bqU55qE5a6e5L2T6ZuG5ZCI5Lit5Yig6ZmkaWRz5a+55bqU55qE5a6e5L2TXG4gICAqL1xuICBwdWJsaWMgcmVtb3ZlRW50aXRpZXNCeVBhdGgoZnBhdGg6IHN0cmluZ1tdLCBpZHM6IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgLy8gY29uc3QgZW50aXR5Q29sbGVjdGlvbk9yTGlzdCA9IHRoaXMuZ2V0RW50aXR5Tm9kZUJ5UGF0aChmcGF0aCk7XG4gICAgLy8gaWYgKGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgaW5zdGFuY2VvZiBFbnRpdHlDb2xsZWN0aW9uID09PSB0cnVlKSB7XG4gICAgLy8gICBjb25zdCBlbnRpdHlDb2xsZWN0aW9uID0gZW50aXR5Q29sbGVjdGlvbk9yTGlzdCBhcyBFbnRpdHlDb2xsZWN0aW9uPEVudGl0eT47XG4gICAgLy8gICBlbnRpdHlDb2xsZWN0aW9uLnJlbW92ZUVudGl0aWVzQnlJZHMoaWRzKTtcbiAgICAvLyB9IGVsc2Uge1xuICAgIC8vICAgY29uc3QgZW50aXR5TGlzdCA9IChlbnRpdHlDb2xsZWN0aW9uT3JMaXN0IGFzIEVudGl0eUxpc3Q8RW50aXR5Pik7XG4gICAgLy8gICBlbnRpdHlMaXN0LnJlbW92ZShpZHMpO1xuICAgIC8vIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBJbXBsZW1lbnRlZCcpO1xuICB9XG4gIC8vICNlbmRyZWdpb25cblxuXG4gIC8vICNyZWdpb24g5riF56m65Y+Y5pu06ZuG55u45YWz5pa55rOVXG5cbiAgLyoqXG4gICAqIOa4heepuuaJgOacieWunuS9k+eahOWPmOabtOmbhlxuICAgKi9cbiAgcHVibGljIGNsZWFyQWxsRW50aXR5Q2hhbmdlcygpIHtcbiAgICBjb25zdCBlbnRpdGllcyA9IHRoaXMuZW50aXR5Q29sbGVjdGlvbi50b0FycmF5KCk7XG4gICAgZW50aXRpZXMuZm9yRWFjaCgoZW50aXR5OiBFbnRpdHkpID0+IHtcbiAgICAgIGVudGl0eS5jaGFuZ2VzLnNwbGljZSgwLCBlbnRpdHkuY2hhbmdlcy5sZW5ndGgpO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHJlc2V0QWxsRW50aXR5Q2hhbmdlTWFyaygpIHtcbiAgICBjb25zdCBlbnRpdGllcyA9IHRoaXMuZW50aXR5Q29sbGVjdGlvbi50b0FycmF5KCk7XG4gICAgZW50aXRpZXMuZm9yRWFjaCgoZW50aXR5OiBFbnRpdHkpID0+IHtcbiAgICAgIGVudGl0eS5oYXNDaGFuZ2UgPSBmYWxzZTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmuIXnqbppZOaMh+WumueahOWunuS9k+WPmOabtOmbhlxuICAgKi9cbiAgcHVibGljIGNsZWFyRW50aXR5Q2hhbmdlc0J5SWQoaWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IGVudGl0eSA9IHRoaXMuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdHlCeUlkKGlkKTtcbiAgICBpZiAoIWVudGl0eSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBlbnRpdHkuY2hhbmdlcy5zcGxpY2UoMCwgZW50aXR5LmNoYW5nZXMubGVuZ3RoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmuIXnqbppZHPmlbDnu4TkuK3mjIflrprnmoTlrp7kvZPnmoTlj5jmm7Tpm4ZcbiAgICovXG4gIHB1YmxpYyBjbGVhckVudGl0eUNoYW5nZXNCeUlkcyhpZHM6IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgaWYgKCFpZHMgfHwgaWRzLmxlbmd0aCA8IDApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZHMuZm9yRWFjaCgoaWQ6IHN0cmluZykgPT4ge1xuICAgICAgdGhpcy5jbGVhckVudGl0eUNoYW5nZXNCeUlkKGlkKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8vICNlbmRyZWdpb25cblxuXG4gIC8vICNyZWdpb24g5Y+Y5pu06ZuG5qOA5p+l55u45YWz5pa55rOVXG5cbiAgLyoqXG4gICAqIOajgOafpeaJgOacieeahOWunuS9k++8jOaYr+WQpuacieacquaPkOS6pOeahOWPmOabtFxuICAgKi9cbiAgcHVibGljIGNoZWNrQWxsRW50aXR5Q2hhbmdlcygpOiBib29sZWFuIHtcblxuICAgIGNvbnN0IGVudGl0aWVzID0gdGhpcy5lbnRpdHlDb2xsZWN0aW9uLnRvQXJyYXkoKTtcbiAgICBjb25zdCBoYXNDaGFuZ2VzID0gZW50aXRpZXMuc29tZSgoZW50aXR5OiBFbnRpdHkpID0+IHtcbiAgICAgIGlmIChlbnRpdHkuY2hhbmdlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBoYXNDaGFuZ2VzO1xuICB9XG5cbiAgLyoqXG4gICAqIOajgOafpWlk5a+55bqU55qE5a6e5L2T77yM5piv5ZCm5pyJ5pyq5o+Q5Lqk55qE5Y+Y5pu0XG4gICAqL1xuICBwdWJsaWMgY2hlY2tFbnRpdHlDaGFuZ2VzQnlJZChpZDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgY29uc3QgZW50aXR5ID0gdGhpcy5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0eUJ5SWQoaWQpO1xuICAgIGlmICghZW50aXR5KSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiBlbnRpdHkuY2hhbmdlcy5sZW5ndGggPiAwO1xuICB9XG5cbiAgLy8gI2VuZHJlZ2lvblxuXG5cbiAgLy8gI3JlZ2lvbiDkuI3op4TojIPmlrnms5XvvIzlvoXlup/lvINcblxuICAvKipcbiAgICog5b6F5bqf5byDXG4gICAqIEBkZXByZWNhdGVkXG4gICAqL1xuICBwdWJsaWMgY2xlYXJFbnRpdHlDaGFuZ2VzQnlBcnJheShpZEFycmF5OiBzdHJpbmdbXSk6IHZvaWQge1xuICAgIHRoaXMuY2xlYXJFbnRpdHlDaGFuZ2VzQnlJZHMoaWRBcnJheSk7XG4gIH1cblxuICAvLyAjZW5kcmVnaW9uXG5cbn1cblxuZXhwb3J0IHsgRW50aXR5TWFuYWdlciB9O1xuIl19