import { AppContext } from '../../app/index';
import { EffectorFactory } from '../effector/index';
import { Expression, ExpressionExecutor, ExpressionRegistry, ExpressionResult } from '../expression/index';
import { ExpressionUtil } from '../utils/expression_util';
export class EventHandler {
    constructor(frameContext) {
        this.frameContext = frameContext;
        this.injector = frameContext.injector;
        this.repository = frameContext.repository;
        this.bindingData = frameContext.bindingData;
        this.expressionRegistry = this.injector.get(ExpressionRegistry, null);
        this.effectorFactory = this.injector.get(EffectorFactory, null);
        this.expressionExecutor = this.injector.get(ExpressionExecutor);
        this.expressionResult = this.injector.get(ExpressionResult, null);
    }
    handleEvent(event, expressionObjects) {
        event = Object.assign({}, event);
        this.expressionObjects = expressionObjects;
        this.dispatch(event);
    }
    //#endregion
    //#region 属性
    /**
     * 主表主键值
     */
    get primaryValue() {
        return this.bindingData.list.currentItem.primaryKeyValue;
    }
    /**
     * 获取主实体原始字段名
     */
    get entityOriginalNodeCode() {
        return this.repository && this.repository.entityTypeInfo && this.repository.entityTypeInfo.entityInfo && this.repository.entityTypeInfo.entityInfo.originalCode || null;
    }
    //#endregion
    //#region 表达式核心
    /**
     * 执行表达式计算
     * @param expression 表达式
     * @param context 上下文
     * @returns any
     */
    perform(expressionObject, context) {
        return this.expressionExecutor.compile(expressionObject, context);
    }
    /**
     * 副作用
     * @param event event
     * @param expressionObject expressionObject
     */
    effect(event, expressionObject) {
        const effectTo = expressionObject.bindingType;
        const effector = this.effectorFactory.getEffector(expressionObject);
        if (!effector) {
            // console.warn(`EventHandler 没有对应的副作用器。${expressionObject.type}`);
            return;
        }
        if (effectTo === Expression.ExpressionBindingType.Field) {
            const effectPaths = expressionObject.effectPaths || [];
            if (effectPaths.length > 0) {
                effectPaths.forEach((path) => {
                    const effectPath = path.split('/');
                    const effectOptions = { path: effectPath, message: expressionObject.message, expressionId: expressionObject.id, eventType: event.type, viewModelId: expressionObject.viewModelId };
                    effector.effect(expressionObject.path, expressionObject.result, effectOptions);
                });
            }
            else if (expressionObject.type === Expression.ExpressionType.Required || expressionObject.type === Expression.ExpressionType.Validate || expressionObject.type === Expression.ExpressionType.Readonly || expressionObject.type === Expression.ExpressionType.Visible) {
                const effectOptions = { message: expressionObject.message, expressionId: expressionObject.id, eventType: event.type, viewModelId: expressionObject.viewModelId };
                effector.effect(expressionObject.path, expressionObject.result, effectOptions);
            }
        }
        else {
            throw new Error('not supported！');
        }
    }
    //#endregion
    //#region util
    isValidateOrRequiredExpression(expressionObject) {
        return expressionObject && (expressionObject.type === Expression.ExpressionType.Validate || expressionObject.type === Expression.ExpressionType.Required);
    }
    /**
     * 以事件参数为依据构建实体路径
     * @param event event
     * @returns
     */
    getEntityPathFromEvent(event) {
        event = JSON.parse(JSON.stringify(event));
        if (!event || !event.path || event.path.length < 1) {
            return [];
        }
        const paths = event.path;
        return this.getEntityPath(paths);
    }
    /**
     * 获取事件路径中的实体路径
     * @param path path
     * @returns
     */
    getEntityPath(path) {
        const paths = path.filter((value, index) => {
            if (index % 2 === 0 && value.includes(':')) {
                return false;
            }
            else {
                return true;
            }
        });
        return paths;
    }
    /**
     * 构造实体路径
     * @param path path
     * @description 删除路径中的id字段
     * @returns
     */
    buildEntityPath(path) {
        const paths = path.filter((value, index) => {
            if (index % 2 === 0 && value.includes(':')) {
                return false;
            }
            else {
                return true;
            }
        });
        return paths;
    }
    /**
     * 清理事件路径中的id主键标识
     * @param path path
     * @returns
     */
    cleanEventPath(path) {
        path = path.filter(p => {
            if (p && p !== ':') {
                return true;
            }
            else {
                return false;
            }
        });
        return path.map((item) => {
            if (item.includes(':')) {
                return item.split(':')[1];
            }
            else {
                return item;
            }
        });
    }
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    getCurrentRowByPaths(paths) {
        let result = null;
        const bindingList = this.bindingData.getValue(paths);
        if (bindingList && bindingList.length > 0) {
            let primaryValue = bindingList.currentItem.primaryKeyValue || null;
            if (primaryValue) {
                const bindingObject = bindingList.findById(primaryValue);
                if (bindingObject) {
                    result = bindingObject.toJSON();
                }
            }
        }
        return result;
    }
    /**
     * 获取事件路径中指定子表的事件行
     * @param path
     * @param tableCode
     * @returns
     */
    getEventId(path, tableCode) {
        if (!path || path.length < 1) {
            throw new Error('invalid path!');
        }
        const propertyIndex = path.findIndex(p => p === tableCode);
        if (propertyIndex === -1) {
            return null;
        }
        const idIndex = propertyIndex + 1;
        if (idIndex > path.length - 1) {
            throw new Error('invalid propertyName or path');
        }
        const id = path[idIndex];
        if (id.indexOf(':') === -1) {
            throw new Error('compute error.');
        }
        return id.split(':')[1];
    }
    //#endregion
    //#region  构造上下文
    /**
     * 构造变量上下文
     * @param event
     * @returns
     */
    buildStateContext(event) {
        const ns = event.ns;
        const appContext = this.injector.get(AppContext, null);
        const frameContexts = appContext.viewModelContextManager.getContextsByNamespace(ns);
        const result = {};
        if (frameContexts && frameContexts.length > 0) {
            const anonymousFrameContext = frameContexts[0];
            const rootFrameContext = anonymousFrameContext.getVirtualRootFrameContext();
            if (rootFrameContext) {
                const uiState = rootFrameContext.viewModel.uiState;
                const propertyNames = Object.getOwnPropertyNames(uiState) || [];
                propertyNames.forEach((prop) => {
                    if (prop.match(/^[a-zA-Z0-9_\$]+$/g) !== null) {
                        result[prop] = uiState[prop];
                    }
                });
            }
        }
        return result;
    }
    /**
     * 获取事件实体
     * @param event
     * @returns
     */
    buildEntityContext(event, expressionObject, currentRows) {
        const expressionBindingType = expressionObject.bindingType;
        if (expressionBindingType === Expression.ExpressionBindingType.Field) {
            const entityTypeInfo = this.repository.entityTypeInfo;
            const childrenEntityPaths = [];
            ExpressionUtil.getChildrenEntityPaths(entityTypeInfo, childrenEntityPaths);
            // 获取当前行
            const row = currentRows && currentRows.find(row => row.bindingPath === '' || row.bindingPath === '/') || null;
            const primaryValue = row && row.primaryValue || this.bindingData.list.currentId;
            let entity = this.bindingData.list.findById(primaryValue);
            if (!entity) {
                return null;
            }
            const object = entity.toJSON();
            object['__type__'] = 'Entity';
            if (!childrenEntityPaths || childrenEntityPaths.length < 1) {
                return object;
            }
            childrenEntityPaths.sort((v1, v2) => v1.length - v2.length);
            // 找到所有子表
            childrenEntityPaths.forEach((paths) => {
                const bindingList = this.bindingData.getValue(paths);
                let currentRowId = bindingList.currentId;
                const propertyName = paths[paths.length - 1];
                // parent 为entity或entitylist或null
                const parent = paths.slice(0, paths.length - 1).reduce((object, path) => {
                    return object && object[path] || null;
                }, object);
                if (!parent) {
                    return;
                }
                const data = parent;
                let node = null;
                if (!currentRowId) {
                    // 当前表没有数据
                    node = { __items__: [], __type__: 'List' };
                    node.length = () => node.__items__.length;
                }
                else {
                    // 纠正当前行
                    if (currentRows && currentRows.length > 0) {
                        // 是否指定了当前行
                        const userAssignCurrentRow = currentRows.find(row => {
                            const bindingPaths = row.bindingPath.split('/').filter(p => p);
                            return bindingPaths.join('/') === paths.join('/');
                        });
                        if (userAssignCurrentRow) {
                            currentRowId = userAssignCurrentRow.primaryValue;
                        }
                    }
                    // 子表当前行
                    const row = bindingList.findById(currentRowId);
                    // 找到子表当前行的上级
                    const list = parent[propertyName];
                    node = Object.assign({ __items__: [] }, row && row.toJSON() || {}, { __type__: 'List' });
                    node.length = () => node.__items__.length;
                    if (list && Array.isArray(list)) {
                        node.__items__ = [].concat(list);
                    }
                }
                data[propertyName] = node;
            });
            return object;
        }
        else if (expressionBindingType === Expression.ExpressionBindingType.State) {
            // todo: 支持状态表达式
        }
        else {
            return null;
        }
    }
    /**
     * 构造表达式计算上下文
     * @param expressionObject 表达式
     * @param event 事件
     * @param entityContext 实体上下文
     * @param currentRows 当前行
     * @returns
     */
    buildContext(expressionObject, event, entityContext, currentRows) {
        let context = [];
        if (entityContext) {
            context.push(entityContext);
        }
        else {
            const entity = this.buildEntityContext(event, expressionObject, currentRows);
            context.push(entity);
        }
        const stateContext = this.buildStateContext(event);
        const entityCode = this.entityOriginalNodeCode;
        let entity = null;
        if (context.length === 1) {
            entity = context.pop();
        }
        else {
            entity = context[0];
            if (!entity['__type__']) {
                entity['__type__'] = 'Entity';
            }
            entity['__items__'] = context;
        }
        return Object.assign({ [entityCode]: entity }, stateContext, { frameContext: this.frameContext, bindingData: this.bindingData, repository: this.repository });
    }
    //#endregion
    /**
     * 构造副作用路径
     * @param event
     * @param expressionObject
     * @returns
     */
    buildEffectPath(event, expressionObject) {
        const expressionPaths = expressionObject.path.split('/').filter(p => p);
        const primaryValue = event.path[0] && event.path[0].split(':')[1];
        if (!primaryValue) {
            throw new Error('Invalid event path!');
        }
        if (expressionPaths.length === 1) {
            // 主表简单字段
            return [primaryValue, expressionPaths.pop()];
        }
        else {
            const result = [primaryValue];
            for (let index = 0; index < expressionPaths.length; index++) {
                const propertyName = expressionPaths[index];
                result.push(propertyName);
                const currentPaths = expressionPaths.slice(0, index + 1);
                const propertyInfo = this.repository.entityTypeInfo.getPropInfoByPath(currentPaths);
                if (propertyInfo.group === 'List') {
                    let id = this.getEventId(event.path, propertyInfo.name) || null;
                    // 事件和表达式不是同一个表
                    if (!id) {
                        const bindingList = this.bindingData.getValue(currentPaths);
                        if (bindingList) {
                            id = bindingList.currentId;
                        }
                    }
                    result.push(id);
                }
            }
            return result;
        }
    }
    //#region 辅助方法
    getPathInfo(path) {
        const paths = path.split('/').filter(p => p);
        // 获取最大实体层级，其余为属性（简单属性、udt、关联、关联嵌套关联）
        const entityPath = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(paths, this.repository.entityTypeInfo);
        const propertyName = paths.slice(entityPath.length).join('/');
        return { path: entityPath.join('/'), propertyName, paths: entityPath, propertyNames: propertyName.split('/').filter(p => p) };
    }
    /**
     * get table paths from event paths
     * @param paths event paths
     * @returns
     */
    getTablePathsFromEventPaths(paths) {
        paths = this.getEntityPath(paths);
        const entityPaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(paths, this.repository.entityTypeInfo);
        return entityPaths;
    }
    /**
     * get property paths from event paths
     * @param paths event paths
     * @returns
     */
    getPropertyPathsFromEventPaths(paths) {
        paths = this.getEntityPath(paths);
        const tablePaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(paths, this.repository.entityTypeInfo);
        return paths.slice(tablePaths.length);
    }
    /**
     * 分析事件和表达式的关系
     */
    analysis(event, expressionObject) {
        const expressionPathInfo = this.getPathInfo(expressionObject.path);
        const eventPaths = this.getEntityPath(event.path.slice(0));
        const eventPathInfo = this.getPathInfo(eventPaths.join('/'));
        if (!expressionPathInfo || !eventPathInfo) {
            console.warn(`表达式路径或事件路径错误，获取路径信息失败。`);
            return null;
        }
        const expressionTablePaths = expressionPathInfo.path.split('/').filter(p => p);
        const expressionPropertyNames = expressionPathInfo.propertyName.split('/').filter(p => p);
        const eventTablePaths = eventPathInfo.path.split('/').filter(p => p);
        const eventPropertyNames = eventPathInfo.propertyName.split('/').filter(p => p);
        const result = {
            distance: undefined,
            eventFromChildren: undefined,
            eventFromParent: undefined,
            expressionTablePaths,
            expressionPropertyNames,
            eventTablePaths,
            eventPropertyNames,
            isSameTable: false
        };
        result.distance = Math.abs(expressionTablePaths.length - eventTablePaths.length);
        if (result.distance === 1) {
            result.eventFromChildren = eventTablePaths.length > expressionTablePaths.length && eventTablePaths.join('/').startsWith(expressionTablePaths.join('/'));
            result.eventFromParent = eventTablePaths.length < expressionTablePaths.length && expressionTablePaths.join('/').startsWith(eventTablePaths.join('/'));
        }
        result.isSameTable = expressionTablePaths.join('/') === eventTablePaths.join('/');
        return result;
    }
    buildCurrentRows(tablePaths, fullPaths) {
        const currentRows = new Array();
        if (!tablePaths || tablePaths.length < 1) {
            currentRows.push({
                bindingPath: '/',
                primaryValue: fullPaths[0]
            });
        }
        else {
            const paths = [];
            tablePaths.forEach((path, index) => {
                if (index === 0) {
                    currentRows.push({
                        bindingPath: '/',
                        primaryValue: fullPaths[0]
                    });
                }
                paths.push(path);
                const primaryValue = fullPaths[index * 2 + 2];
                currentRows.push({
                    bindingPath: paths.join('/'),
                    primaryValue: primaryValue
                });
            });
        }
        return currentRows;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnRfaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9leHByZXNzaW9uL2V2ZW50LWhhbmRsZXIvZXZlbnRfaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFHN0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxVQUFVLEVBQUUsa0JBQWtCLEVBQUUsa0JBQWtCLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUczRyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFMUQsTUFBTSxPQUFnQixZQUFZO0lBZ0JoQyxZQUFzQixZQUE4QjtRQUE5QixpQkFBWSxHQUFaLFlBQVksQ0FBa0I7UUFDbEQsSUFBSSxDQUFDLFFBQVEsR0FBRyxZQUFZLENBQUMsUUFBUSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxVQUFVLEdBQUcsWUFBWSxDQUFDLFVBQVUsQ0FBQztRQUMxQyxJQUFJLENBQUMsV0FBVyxHQUFHLFlBQVksQ0FBQyxXQUFXLENBQUM7UUFDNUMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGtCQUFrQixFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3RFLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMs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QVksRUFBRSxZQUFZO2lCQUMzQixDQUFDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBQ0QsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztDQUVGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0b3IgfSBmcm9tICcuLi8uLi9jb3JlL2luZGV4JztcbmltcG9ydCB7IEFwcENvbnRleHQgfSBmcm9tICcuLi8uLi9hcHAvaW5kZXgnO1xuaW1wb3J0IHsgQmluZGluZ0RhdGEsIEJpbmRpbmdMaXN0LCBCaW5kaW5nT2JqZWN0IH0gZnJvbSAnLi4vLi4vYmluZGluZy1kYXRhL2luZGV4JztcbmltcG9ydCB7IERhdGFQcm9wSW5mbywgRW50aXR5LCBFbnRpdHlMaXN0IH0gZnJvbSAnLi4vLi4vZW50aXR5L2luZGV4JztcbmltcG9ydCB7IEVmZmVjdG9yRmFjdG9yeSB9IGZyb20gJy4uL2VmZmVjdG9yL2luZGV4JztcbmltcG9ydCB7IEV4cHJlc3Npb24sIEV4cHJlc3Npb25FeGVjdXRvciwgRXhwcmVzc2lvblJlZ2lzdHJ5LCBFeHByZXNzaW9uUmVzdWx0IH0gZnJvbSAnLi4vZXhwcmVzc2lvbi9pbmRleCc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAnLi4vLi4vcmVwb3NpdG9yeS9pbmRleCc7XG5pbXBvcnQgeyBWaWV3TW9kZWxDb250ZXh0IH0gZnJvbSAnLi4vLi4vdmlldy1tb2RlbC9pbmRleCc7XG5pbXBvcnQgeyBFeHByZXNzaW9uVXRpbCB9IGZyb20gJy4uL3V0aWxzL2V4cHJlc3Npb25fdXRpbCc7XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBFdmVudEhhbmRsZXIgaW1wbGVtZW50cyBFeHByZXNzaW9uLklFdmVudEhhbmRsZXIge1xuXG4gIHByb3RlY3RlZCBpbmplY3RvcjogSW5qZWN0b3I7XG5cbiAgcHJvdGVjdGVkIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55PjtcblxuICBwcm90ZWN0ZWQgYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhO1xuXG4gIHByb3RlY3RlZCBleHByZXNzaW9uUmVnaXN0cnk6IEV4cHJlc3Npb25SZWdpc3RyeTtcblxuICBwcm90ZWN0ZWQgZWZmZWN0b3JGYWN0b3J5OiBFZmZlY3RvckZhY3Rvcnk7XG5cbiAgcHJvdGVjdGVkIGV4cHJlc3Npb25FeGVjdXRvcjogRXhwcmVzc2lvbkV4ZWN1dG9yO1xuXG4gIHByb3RlY3RlZCBleHByZXNzaW9uUmVzdWx0OiBFeHByZXNzaW9uUmVzdWx0O1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBmcmFtZUNvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQpIHtcbiAgICB0aGlzLmluamVjdG9yID0gZnJhbWVDb250ZXh0LmluamVjdG9yO1xuICAgIHRoaXMucmVwb3NpdG9yeSA9IGZyYW1lQ29udGV4dC5yZXBvc2l0b3J5O1xuICAgIHRoaXMuYmluZGluZ0RhdGEgPSBmcmFtZUNvbnRleHQuYmluZGluZ0RhdGE7XG4gICAgdGhpcy5leHByZXNzaW9uUmVnaXN0cnkgPSB0aGlzLmluamVjdG9yLmdldChFeHByZXNzaW9uUmVnaXN0cnksIG51bGwpO1xuICAgIHRoaXMuZWZmZWN0b3JGYWN0b3J5ID0gdGhpcy5pbmplY3Rvci5nZXQoRWZmZWN0b3JGYWN0b3J5LCBudWxsKTtcbiAgICB0aGlzLmV4cHJlc3Npb25FeGVjdXRvciA9IHRoaXMuaW5qZWN0b3IuZ2V0KEV4cHJlc3Npb25FeGVjdXRvcik7XG4gICAgdGhpcy5leHByZXNzaW9uUmVzdWx0ID0gdGhpcy5pbmplY3Rvci5nZXQoRXhwcmVzc2lvblJlc3VsdCwgbnVsbCk7XG5cbiAgfVxuXG4gIHB1YmxpYyBleHByZXNzaW9uT2JqZWN0czogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0W107XG5cbiAgcHVibGljIGhhbmRsZUV2ZW50KGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncywgZXhwcmVzc2lvbk9iamVjdHM6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdFtdKSB7XG4gICAgZXZlbnQgPSBPYmplY3QuYXNzaWduKHt9LCBldmVudCk7XG4gICAgdGhpcy5leHByZXNzaW9uT2JqZWN0cyA9IGV4cHJlc3Npb25PYmplY3RzO1xuICAgIHRoaXMuZGlzcGF0Y2goZXZlbnQpO1xuICB9XG5cbiAgLy8jcmVnaW9uIOaKveixoeWHveaVsFxuICAvKipcbiAgICog6I635Y+W55u45YWz6KGo6L6+5byPXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxuICAgKi9cbiAgcHVibGljIGFic3RyYWN0IGZpbHRlcihldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MpO1xuICAvKipcbiAgICog5Y+R5biD5LqL5Lu2XG4gICAqIEBwYXJhbSBleHByZXNzaW9uT2JqZWN0IOihqOi+vuW8j+WvueixoVxuICAgKiBAcGFyYW0gZXZlbnQg5LqL5Lu2XG4gICAqL1xuICBwdWJsaWMgYWJzdHJhY3QgZGlzcGF0Y2goZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKTogdm9pZDtcbiAgLy8jZW5kcmVnaW9uXG5cbiAgLy8jcmVnaW9uIOWxnuaAp1xuXG4gIC8qKlxuICAgKiDkuLvooajkuLvplK7lgLxcbiAgICovXG4gIHByb3RlY3RlZCBnZXQgcHJpbWFyeVZhbHVlKCkge1xuICAgIHJldHVybiB0aGlzLmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudEl0ZW0ucHJpbWFyeUtleVZhbHVlO1xuICB9XG4gIC8qKlxuICAgKiDojrflj5bkuLvlrp7kvZPljp/lp4vlrZfmrrXlkI1cbiAgICovXG4gIHByb3RlY3RlZCBnZXQgZW50aXR5T3JpZ2luYWxOb2RlQ29kZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnJlcG9zaXRvcnkgJiYgdGhpcy5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvICYmIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mby5lbnRpdHlJbmZvICYmIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mby5lbnRpdHlJbmZvLm9yaWdpbmFsQ29kZSB8fCBudWxsO1xuICB9XG5cbiAgLy8jZW5kcmVnaW9uXG5cbiAgLy8jcmVnaW9uIOihqOi+vuW8j+aguOW/g1xuICAvKipcbiAgICog5omn6KGM6KGo6L6+5byP6K6h566XXG4gICAqIEBwYXJhbSBleHByZXNzaW9uIOihqOi+vuW8j1xuICAgKiBAcGFyYW0gY29udGV4dCDkuIrkuIvmlodcbiAgICogQHJldHVybnMgYW55XG4gICAqL1xuICBwdWJsaWMgcGVyZm9ybShleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QsIGNvbnRleHQ6IGFueSkge1xuICAgIHJldHVybiB0aGlzLmV4cHJlc3Npb25FeGVjdXRvci5jb21waWxlKGV4cHJlc3Npb25PYmplY3QsIGNvbnRleHQpO1xuICB9XG4gIC8qKlxuICAgKiDlia/kvZznlKhcbiAgICogQHBhcmFtIGV2ZW50IGV2ZW50XG4gICAqIEBwYXJhbSBleHByZXNzaW9uT2JqZWN0IGV4cHJlc3Npb25PYmplY3RcbiAgICovXG4gIHB1YmxpYyBlZmZlY3QoZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzLCBleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpOiB2b2lkIHtcbiAgICBjb25zdCBlZmZlY3RUbyA9IGV4cHJlc3Npb25PYmplY3QuYmluZGluZ1R5cGU7XG4gICAgY29uc3QgZWZmZWN0b3IgPSB0aGlzLmVmZmVjdG9yRmFjdG9yeS5nZXRFZmZlY3RvcihleHByZXNzaW9uT2JqZWN0KTtcbiAgICBpZiAoIWVmZmVjdG9yKSB7XG4gICAgICAvLyBjb25zb2xlLndhcm4oYEV2ZW50SGFuZGxlciDmsqHmnInlr7nlupTnmoTlia/kvZznlKjlmajjgIIke2V4cHJlc3Npb25PYmplY3QudHlwZX1gKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGVmZmVjdFRvID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25CaW5kaW5nVHlwZS5GaWVsZCkge1xuICAgICAgY29uc3QgZWZmZWN0UGF0aHMgPSBleHByZXNzaW9uT2JqZWN0LmVmZmVjdFBhdGhzIHx8IFtdO1xuICAgICAgaWYgKGVmZmVjdFBhdGhzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZWZmZWN0UGF0aHMuZm9yRWFjaCgocGF0aDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgY29uc3QgZWZmZWN0UGF0aCA9IHBhdGguc3BsaXQoJy8nKTtcbiAgICAgICAgICBjb25zdCBlZmZlY3RPcHRpb25zID0geyBwYXRoOiBlZmZlY3RQYXRoLCBtZXNzYWdlOiBleHByZXNzaW9uT2JqZWN0Lm1lc3NhZ2UsIGV4cHJlc3Npb25JZDogZXhwcmVzc2lvbk9iamVjdC5pZCwgZXZlbnRUeXBlOiBldmVudC50eXBlLCB2aWV3TW9kZWxJZDogZXhwcmVzc2lvbk9iamVjdC52aWV3TW9kZWxJZCB9O1xuICAgICAgICAgIGVmZmVjdG9yLmVmZmVjdChleHByZXNzaW9uT2JqZWN0LnBhdGgsIGV4cHJlc3Npb25PYmplY3QucmVzdWx0LCBlZmZlY3RPcHRpb25zKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2UgaWYgKGV4cHJlc3Npb25PYmplY3QudHlwZSA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5SZXF1aXJlZCB8fCBleHByZXNzaW9uT2JqZWN0LnR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuVmFsaWRhdGUgfHwgZXhwcmVzc2lvbk9iamVjdC50eXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLlJlYWRvbmx5IHx8IGV4cHJlc3Npb25PYmplY3QudHlwZSA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5WaXNpYmxlKSB7XG4gICAgICAgIGNvbnN0IGVmZmVjdE9wdGlvbnMgPSB7IG1lc3NhZ2U6IGV4cHJlc3Npb25PYmplY3QubWVzc2FnZSwgZXhwcmVzc2lvbklkOiBleHByZXNzaW9uT2JqZWN0LmlkLCBldmVudFR5cGU6IGV2ZW50LnR5cGUsIHZpZXdNb2RlbElkOiBleHByZXNzaW9uT2JqZWN0LnZpZXdNb2RlbElkIH07XG4gICAgICAgIGVmZmVjdG9yLmVmZmVjdChleHByZXNzaW9uT2JqZWN0LnBhdGgsIGV4cHJlc3Npb25PYmplY3QucmVzdWx0LCBlZmZlY3RPcHRpb25zKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdub3Qgc3VwcG9ydGVk77yBJyk7XG4gICAgfVxuICB9XG5cbiAgLy8jZW5kcmVnaW9uXG5cbiAgLy8jcmVnaW9uIHV0aWxcblxuICBwcm90ZWN0ZWQgaXNWYWxpZGF0ZU9yUmVxdWlyZWRFeHByZXNzaW9uKGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkge1xuICAgIHJldHVybiBleHByZXNzaW9uT2JqZWN0ICYmIChleHByZXNzaW9uT2JqZWN0LnR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuVmFsaWRhdGUgfHwgZXhwcmVzc2lvbk9iamVjdC50eXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLlJlcXVpcmVkKTtcbiAgfVxuICAvKipcbiAgICog5Lul5LqL5Lu25Y+C5pWw5Li65L6d5o2u5p6E5bu65a6e5L2T6Lev5b6EXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHByb3RlY3RlZCBnZXRFbnRpdHlQYXRoRnJvbUV2ZW50KGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncyk6IHN0cmluZ1tdIHtcbiAgICBldmVudCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTtcbiAgICBpZiAoIWV2ZW50IHx8ICFldmVudC5wYXRoIHx8IGV2ZW50LnBhdGgubGVuZ3RoIDwgMSkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBjb25zdCBwYXRocyA9IGV2ZW50LnBhdGg7XG4gICAgcmV0dXJuIHRoaXMuZ2V0RW50aXR5UGF0aChwYXRocyk7XG4gIH1cbiAgLyoqXG4gICAqIOiOt+WPluS6i+S7tui3r+W+hOS4reeahOWunuS9k+i3r+W+hFxuICAgKiBAcGFyYW0gcGF0aCBwYXRoXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHJvdGVjdGVkIGdldEVudGl0eVBhdGgocGF0aDogc3RyaW5nW10pOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgcGF0aHMgPSBwYXRoLmZpbHRlcigodmFsdWU6IHN0cmluZywgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgaWYgKGluZGV4ICUgMiA9PT0gMCAmJiB2YWx1ZS5pbmNsdWRlcygnOicpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBwYXRocztcbiAgfVxuICAvKipcbiAgICog5p6E6YCg5a6e5L2T6Lev5b6EXG4gICAqIEBwYXJhbSBwYXRoIHBhdGhcbiAgICogQGRlc2NyaXB0aW9uIOWIoOmZpOi3r+W+hOS4reeahGlk5a2X5q61XG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHJvdGVjdGVkIGJ1aWxkRW50aXR5UGF0aChwYXRoOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCBwYXRocyA9IHBhdGguZmlsdGVyKCh2YWx1ZTogc3RyaW5nLCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICBpZiAoaW5kZXggJSAyID09PSAwICYmIHZhbHVlLmluY2x1ZGVzKCc6JykpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHBhdGhzO1xuICB9XG4gIC8qKlxuICAgKiDmuIXnkIbkuovku7bot6/lvoTkuK3nmoRpZOS4u+mUruagh+ivhlxuICAgKiBAcGFyYW0gcGF0aCBwYXRoXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHJvdGVjdGVkIGNsZWFuRXZlbnRQYXRoKHBhdGg6IHN0cmluZ1tdKSB7XG4gICAgcGF0aCA9IHBhdGguZmlsdGVyKHAgPT4ge1xuICAgICAgaWYgKHAgJiYgcCAhPT0gJzonKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBwYXRoLm1hcCgoaXRlbTogc3RyaW5nKSA9PiB7XG4gICAgICBpZiAoaXRlbS5pbmNsdWRlcygnOicpKSB7XG4gICAgICAgIHJldHVybiBpdGVtLnNwbGl0KCc6JylbMV07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuICAvKipcbiAgICog6I635Y+W5a2Q6KGo5LqL5Lu26KGMXG4gICAqIEBwYXJhbSBwYXRocyBcbiAgICogQHBhcmFtIGV2ZW50IFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHByb3RlY3RlZCBnZXRDdXJyZW50Um93QnlQYXRocyhwYXRoczogc3RyaW5nW10pOiBudWxsIHwgeyBbcHJvcDogc3RyaW5nXTogYW55IH0ge1xuICAgIGxldCByZXN1bHQgPSBudWxsO1xuICAgIGNvbnN0IGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCA9IHRoaXMuYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xuICAgIGlmIChiaW5kaW5nTGlzdCAmJiBiaW5kaW5nTGlzdC5sZW5ndGggPiAwKSB7XG4gICAgICBsZXQgcHJpbWFyeVZhbHVlID0gYmluZGluZ0xpc3QuY3VycmVudEl0ZW0ucHJpbWFyeUtleVZhbHVlIHx8IG51bGw7XG4gICAgICBpZiAocHJpbWFyeVZhbHVlKSB7XG4gICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBiaW5kaW5nTGlzdC5maW5kQnlJZChwcmltYXJ5VmFsdWUpO1xuICAgICAgICBpZiAoYmluZGluZ09iamVjdCkge1xuICAgICAgICAgIHJlc3VsdCA9IGJpbmRpbmdPYmplY3QudG9KU09OKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuICAvKipcbiAgICog6I635Y+W5LqL5Lu26Lev5b6E5Lit5oyH5a6a5a2Q6KGo55qE5LqL5Lu26KGMXG4gICAqIEBwYXJhbSBwYXRoIFxuICAgKiBAcGFyYW0gdGFibGVDb2RlIFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHByb3RlY3RlZCBnZXRFdmVudElkKHBhdGg6IHN0cmluZ1tdLCB0YWJsZUNvZGU6IHN0cmluZykge1xuICAgIGlmICghcGF0aCB8fCBwYXRoLmxlbmd0aCA8IDEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBwYXRoIScpO1xuICAgIH1cbiAgICBjb25zdCBwcm9wZXJ0eUluZGV4ID0gcGF0aC5maW5kSW5kZXgocCA9PiBwID09PSB0YWJsZUNvZGUpO1xuICAgIGlmIChwcm9wZXJ0eUluZGV4ID09PSAtMSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGNvbnN0IGlkSW5kZXggPSBwcm9wZXJ0eUluZGV4ICsgMTtcbiAgICBpZiAoaWRJbmRleCA+IHBhdGgubGVuZ3RoIC0gMSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIHByb3BlcnR5TmFtZSBvciBwYXRoJyk7XG4gICAgfVxuICAgIGNvbnN0IGlkID0gcGF0aFtpZEluZGV4XTtcbiAgICBpZiAoaWQuaW5kZXhPZignOicpID09PSAtMSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdjb21wdXRlIGVycm9yLicpO1xuICAgIH1cbiAgICByZXR1cm4gaWQuc3BsaXQoJzonKVsxXTtcbiAgfVxuICAvLyNlbmRyZWdpb25cblxuXG4gIC8vI3JlZ2lvbiAg5p6E6YCg5LiK5LiL5paHXG5cbiAgLyoqXG4gICAqIOaehOmAoOWPmOmHj+S4iuS4i+aWh1xuICAgKiBAcGFyYW0gZXZlbnQgXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHVibGljIGJ1aWxkU3RhdGVDb250ZXh0KGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncykge1xuICAgIGNvbnN0IG5zID0gZXZlbnQubnM7XG4gICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMuaW5qZWN0b3IuZ2V0PEFwcENvbnRleHQ+KEFwcENvbnRleHQsIG51bGwpO1xuICAgIGNvbnN0IGZyYW1lQ29udGV4dHMgPSBhcHBDb250ZXh0LnZpZXdNb2RlbENvbnRleHRNYW5hZ2VyLmdldENvbnRleHRzQnlOYW1lc3BhY2UobnMpO1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIGlmIChmcmFtZUNvbnRleHRzICYmIGZyYW1lQ29udGV4dHMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgYW5vbnltb3VzRnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0c1swXTtcbiAgICAgIGNvbnN0IHJvb3RGcmFtZUNvbnRleHQgPSBhbm9ueW1vdXNGcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKTtcbiAgICAgIGlmIChyb290RnJhbWVDb250ZXh0KSB7XG4gICAgICAgIGNvbnN0IHVpU3RhdGUgPSByb290RnJhbWVDb250ZXh0LnZpZXdNb2RlbC51aVN0YXRlO1xuICAgICAgICBjb25zdCBwcm9wZXJ0eU5hbWVzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXModWlTdGF0ZSkgfHwgW107XG4gICAgICAgIHByb3BlcnR5TmFtZXMuZm9yRWFjaCgocHJvcDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgaWYgKHByb3AubWF0Y2goL15bYS16QS1aMC05X1xcJF0rJC9nKSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0W3Byb3BdID0gdWlTdGF0ZVtwcm9wXTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG4gIC8qKlxuICAgKiDojrflj5bkuovku7blrp7kvZNcbiAgICogQHBhcmFtIGV2ZW50IFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyBidWlsZEVudGl0eUNvbnRleHQoZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzLCBleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QsIGN1cnJlbnRSb3dzPzogQXJyYXk8RXhwcmVzc2lvbi5JQ3VycmVudFJvdz4pIHtcbiAgICBjb25zdCBleHByZXNzaW9uQmluZGluZ1R5cGUgPSBleHByZXNzaW9uT2JqZWN0LmJpbmRpbmdUeXBlO1xuICAgIGlmIChleHByZXNzaW9uQmluZGluZ1R5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvbkJpbmRpbmdUeXBlLkZpZWxkKSB7XG4gICAgICBjb25zdCBlbnRpdHlUeXBlSW5mbyA9IHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbztcbiAgICAgIGNvbnN0IGNoaWxkcmVuRW50aXR5UGF0aHMgPSBbXTtcbiAgICAgIEV4cHJlc3Npb25VdGlsLmdldENoaWxkcmVuRW50aXR5UGF0aHMoZW50aXR5VHlwZUluZm8sIGNoaWxkcmVuRW50aXR5UGF0aHMpO1xuICAgICAgLy8g6I635Y+W5b2T5YmN6KGMXG4gICAgICBjb25zdCByb3cgPSBjdXJyZW50Um93cyAmJiBjdXJyZW50Um93cy5maW5kKHJvdyA9PiByb3cuYmluZGluZ1BhdGggPT09ICcnIHx8IHJvdy5iaW5kaW5nUGF0aCA9PT0gJy8nKSB8fCBudWxsO1xuICAgICAgY29uc3QgcHJpbWFyeVZhbHVlID0gcm93ICYmIHJvdy5wcmltYXJ5VmFsdWUgfHwgdGhpcy5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZDtcbiAgICAgIGxldCBlbnRpdHkgPSB0aGlzLmJpbmRpbmdEYXRhLmxpc3QuZmluZEJ5SWQocHJpbWFyeVZhbHVlKTtcbiAgICAgIGlmICghZW50aXR5KSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuICAgICAgY29uc3Qgb2JqZWN0ID0gZW50aXR5LnRvSlNPTigpO1xuICAgICAgb2JqZWN0WydfX3R5cGVfXyddID0gJ0VudGl0eSc7XG4gICAgICBpZiAoIWNoaWxkcmVuRW50aXR5UGF0aHMgfHwgY2hpbGRyZW5FbnRpdHlQYXRocy5sZW5ndGggPCAxKSB7XG4gICAgICAgIHJldHVybiBvYmplY3Q7XG4gICAgICB9XG4gICAgICBjaGlsZHJlbkVudGl0eVBhdGhzLnNvcnQoKHYxLCB2MikgPT4gdjEubGVuZ3RoIC0gdjIubGVuZ3RoKTtcbiAgICAgIC8vIOaJvuWIsOaJgOacieWtkOihqFxuICAgICAgY2hpbGRyZW5FbnRpdHlQYXRocy5mb3JFYWNoKChwYXRoczogc3RyaW5nW10pID0+IHtcbiAgICAgICAgY29uc3QgYmluZGluZ0xpc3QgPSB0aGlzLmJpbmRpbmdEYXRhLmdldFZhbHVlKHBhdGhzKSBhcyBCaW5kaW5nTGlzdDtcbiAgICAgICAgbGV0IGN1cnJlbnRSb3dJZCA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJZDtcbiAgICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gcGF0aHNbcGF0aHMubGVuZ3RoIC0gMV07XG4gICAgICAgIC8vIHBhcmVudCDkuLplbnRpdHnmiJZlbnRpdHlsaXN05oiWbnVsbFxuICAgICAgICBjb25zdCBwYXJlbnQgPSBwYXRocy5zbGljZSgwLCBwYXRocy5sZW5ndGggLSAxKS5yZWR1Y2UoKG9iamVjdDogYW55LCBwYXRoOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICByZXR1cm4gb2JqZWN0ICYmIG9iamVjdFtwYXRoXSB8fCBudWxsO1xuICAgICAgICB9LCBvYmplY3QpO1xuICAgICAgICBpZiAoIXBhcmVudCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBkYXRhID0gcGFyZW50O1xuICAgICAgICBsZXQgbm9kZTogYW55ID0gbnVsbDtcbiAgICAgICAgaWYgKCFjdXJyZW50Um93SWQpIHtcbiAgICAgICAgICAvLyDlvZPliY3ooajmsqHmnInmlbDmja5cbiAgICAgICAgICBub2RlID0geyBfX2l0ZW1zX186IFtdLCBfX3R5cGVfXzogJ0xpc3QnIH07XG4gICAgICAgICAgbm9kZS5sZW5ndGggPSAoKSA9PiBub2RlLl9faXRlbXNfXy5sZW5ndGg7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8g57qg5q2j5b2T5YmN6KGMXG4gICAgICAgICAgaWYgKGN1cnJlbnRSb3dzICYmIGN1cnJlbnRSb3dzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIC8vIOaYr+WQpuaMh+WumuS6huW9k+WJjeihjFxuICAgICAgICAgICAgY29uc3QgdXNlckFzc2lnbkN1cnJlbnRSb3cgPSBjdXJyZW50Um93cy5maW5kKHJvdyA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IHJvdy5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgICAgICAgICAgICByZXR1cm4gYmluZGluZ1BhdGhzLmpvaW4oJy8nKSA9PT0gcGF0aHMuam9pbignLycpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAodXNlckFzc2lnbkN1cnJlbnRSb3cpIHtcbiAgICAgICAgICAgICAgY3VycmVudFJvd0lkID0gdXNlckFzc2lnbkN1cnJlbnRSb3cucHJpbWFyeVZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICAvLyDlrZDooajlvZPliY3ooYxcbiAgICAgICAgICBjb25zdCByb3cgPSBiaW5kaW5nTGlzdC5maW5kQnlJZChjdXJyZW50Um93SWQpO1xuICAgICAgICAgIC8vIOaJvuWIsOWtkOihqOW9k+WJjeihjOeahOS4iue6p1xuICAgICAgICAgIGNvbnN0IGxpc3QgPSBwYXJlbnRbcHJvcGVydHlOYW1lXTtcbiAgICAgICAgICBub2RlID0geyBfX2l0ZW1zX186IFtdLCAuLi5yb3cgJiYgcm93LnRvSlNPTigpIHx8IHt9LCBfX3R5cGVfXzogJ0xpc3QnIH07XG4gICAgICAgICAgbm9kZS5sZW5ndGggPSAoKSA9PiBub2RlLl9faXRlbXNfXy5sZW5ndGg7XG5cbiAgICAgICAgICBpZiAobGlzdCAmJiBBcnJheS5pc0FycmF5KGxpc3QpKSB7XG4gICAgICAgICAgICBub2RlLl9faXRlbXNfXyA9IFtdLmNvbmNhdChsaXN0KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZGF0YVtwcm9wZXJ0eU5hbWVdID0gbm9kZTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIG9iamVjdDtcbiAgICB9IGVsc2UgaWYgKGV4cHJlc3Npb25CaW5kaW5nVHlwZSA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uQmluZGluZ1R5cGUuU3RhdGUpIHtcbiAgICAgIC8vIHRvZG86IOaUr+aMgeeKtuaAgeihqOi+vuW8j1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOaehOmAoOihqOi+vuW8j+iuoeeul+S4iuS4i+aWh1xuICAgKiBAcGFyYW0gZXhwcmVzc2lvbk9iamVjdCDooajovr7lvI9cbiAgICogQHBhcmFtIGV2ZW50IOS6i+S7tlxuICAgKiBAcGFyYW0gZW50aXR5Q29udGV4dCDlrp7kvZPkuIrkuIvmlodcbiAgICogQHBhcmFtIGN1cnJlbnRSb3dzIOW9k+WJjeihjFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyBidWlsZENvbnRleHQoZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0LCBldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MsIGVudGl0eUNvbnRleHQ/OiBhbnksIGN1cnJlbnRSb3dzPzogQXJyYXk8RXhwcmVzc2lvbi5JQ3VycmVudFJvdz4pOiBhbnkge1xuICAgIGxldCBjb250ZXh0ID0gW107XG4gICAgaWYgKGVudGl0eUNvbnRleHQpIHtcbiAgICAgIGNvbnRleHQucHVzaChlbnRpdHlDb250ZXh0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZW50aXR5ID0gdGhpcy5idWlsZEVudGl0eUNvbnRleHQoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QsIGN1cnJlbnRSb3dzKTtcbiAgICAgIGNvbnRleHQucHVzaChlbnRpdHkpO1xuICAgIH1cbiAgICBjb25zdCBzdGF0ZUNvbnRleHQgPSB0aGlzLmJ1aWxkU3RhdGVDb250ZXh0KGV2ZW50KTtcbiAgICBjb25zdCBlbnRpdHlDb2RlID0gdGhpcy5lbnRpdHlPcmlnaW5hbE5vZGVDb2RlO1xuICAgIGxldCBlbnRpdHkgPSBudWxsO1xuICAgIGlmIChjb250ZXh0Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgZW50aXR5ID0gY29udGV4dC5wb3AoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZW50aXR5ID0gY29udGV4dFswXTtcbiAgICAgIGlmICghZW50aXR5WydfX3R5cGVfXyddKSB7XG4gICAgICAgIGVudGl0eVsnX190eXBlX18nXSA9ICdFbnRpdHknO1xuICAgICAgfVxuICAgICAgZW50aXR5WydfX2l0ZW1zX18nXSA9IGNvbnRleHQ7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBbZW50aXR5Q29kZV06IGVudGl0eSxcbiAgICAgIC4uLnN0YXRlQ29udGV4dCxcbiAgICAgIGZyYW1lQ29udGV4dDogdGhpcy5mcmFtZUNvbnRleHQsXG4gICAgICBiaW5kaW5nRGF0YTogdGhpcy5iaW5kaW5nRGF0YSxcbiAgICAgIHJlcG9zaXRvcnk6IHRoaXMucmVwb3NpdG9yeVxuICAgIH07XG4gIH1cbiAgLy8jZW5kcmVnaW9uXG4gIC8qKlxuICAgKiDmnoTpgKDlia/kvZznlKjot6/lvoRcbiAgICogQHBhcmFtIGV2ZW50IFxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbk9iamVjdCBcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwcm90ZWN0ZWQgYnVpbGRFZmZlY3RQYXRoKGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncywgZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KTogc3RyaW5nW10ge1xuICAgIGNvbnN0IGV4cHJlc3Npb25QYXRocyA9IGV4cHJlc3Npb25PYmplY3QucGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgIGNvbnN0IHByaW1hcnlWYWx1ZSA9IGV2ZW50LnBhdGhbMF0gJiYgZXZlbnQucGF0aFswXS5zcGxpdCgnOicpWzFdO1xuICAgIGlmICghcHJpbWFyeVZhbHVlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZXZlbnQgcGF0aCEnKTtcbiAgICB9XG4gICAgaWYgKGV4cHJlc3Npb25QYXRocy5sZW5ndGggPT09IDEpIHtcbiAgICAgIC8vIOS4u+ihqOeugOWNleWtl+autVxuICAgICAgcmV0dXJuIFtwcmltYXJ5VmFsdWUsIGV4cHJlc3Npb25QYXRocy5wb3AoKV07XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IFtwcmltYXJ5VmFsdWVdO1xuICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGV4cHJlc3Npb25QYXRocy5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gZXhwcmVzc2lvblBhdGhzW2luZGV4XTtcbiAgICAgICAgcmVzdWx0LnB1c2gocHJvcGVydHlOYW1lKTtcbiAgICAgICAgY29uc3QgY3VycmVudFBhdGhzID0gZXhwcmVzc2lvblBhdGhzLnNsaWNlKDAsIGluZGV4ICsgMSk7XG4gICAgICAgIGNvbnN0IHByb3BlcnR5SW5mbzogRGF0YVByb3BJbmZvID0gdGhpcy5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvLmdldFByb3BJbmZvQnlQYXRoKGN1cnJlbnRQYXRocyk7XG4gICAgICAgIGlmIChwcm9wZXJ0eUluZm8uZ3JvdXAgPT09ICdMaXN0Jykge1xuICAgICAgICAgIGxldCBpZCA9IHRoaXMuZ2V0RXZlbnRJZChldmVudC5wYXRoLCBwcm9wZXJ0eUluZm8ubmFtZSkgfHwgbnVsbDtcbiAgICAgICAgICAvLyDkuovku7blkozooajovr7lvI/kuI3mmK/lkIzkuIDkuKrooahcbiAgICAgICAgICBpZiAoIWlkKSB7XG4gICAgICAgICAgICBjb25zdCBiaW5kaW5nTGlzdCA9IHRoaXMuYmluZGluZ0RhdGEuZ2V0VmFsdWUoY3VycmVudFBhdGhzKSBhcyBCaW5kaW5nTGlzdDtcbiAgICAgICAgICAgIGlmIChiaW5kaW5nTGlzdCkge1xuICAgICAgICAgICAgICBpZCA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgcmVzdWx0LnB1c2goaWQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgfVxuXG4gIC8vI3JlZ2lvbiDovoXliqnmlrnms5VcbiAgcHJvdGVjdGVkIGdldFBhdGhJbmZvKHBhdGg6IHN0cmluZyk6IHsgcGF0aDogc3RyaW5nLCBwcm9wZXJ0eU5hbWU6IHN0cmluZywgcGF0aHM6IHN0cmluZ1tdLCBwcm9wZXJ0eU5hbWVzOiBzdHJpbmdbXSB9IHtcbiAgICBjb25zdCBwYXRocyA9IHBhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcbiAgICAvLyDojrflj5bmnIDlpKflrp7kvZPlsYLnuqfvvIzlhbbkvZnkuLrlsZ7mgKfvvIjnroDljZXlsZ7mgKfjgIF1ZHTjgIHlhbPogZTjgIHlhbPogZTltYzlpZflhbPogZTvvIlcbiAgICBjb25zdCBlbnRpdHlQYXRoID0gRXhwcmVzc2lvblV0aWwuZ2V0QXZhaWxhYmxlQ2hpbGRyZW5QYXRoc0Zyb21FbnRpdHlQYXRocyhwYXRocywgdGhpcy5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvKTtcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwYXRocy5zbGljZShlbnRpdHlQYXRoLmxlbmd0aCkuam9pbignLycpO1xuICAgIHJldHVybiB7IHBhdGg6IGVudGl0eVBhdGguam9pbignLycpLCBwcm9wZXJ0eU5hbWUsIHBhdGhzOiBlbnRpdHlQYXRoLCBwcm9wZXJ0eU5hbWVzOiBwcm9wZXJ0eU5hbWUuc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKSB9O1xuICB9XG4gIC8qKlxuICAgKiBnZXQgdGFibGUgcGF0aHMgZnJvbSBldmVudCBwYXRoc1xuICAgKiBAcGFyYW0gcGF0aHMgZXZlbnQgcGF0aHNcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwcm90ZWN0ZWQgZ2V0VGFibGVQYXRoc0Zyb21FdmVudFBhdGhzKHBhdGhzOiBzdHJpbmdbXSkge1xuICAgIHBhdGhzID0gdGhpcy5nZXRFbnRpdHlQYXRoKHBhdGhzKTtcbiAgICBjb25zdCBlbnRpdHlQYXRocyA9IEV4cHJlc3Npb25VdGlsLmdldEF2YWlsYWJsZUNoaWxkcmVuUGF0aHNGcm9tRW50aXR5UGF0aHMocGF0aHMsIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbyk7XG4gICAgcmV0dXJuIGVudGl0eVBhdGhzO1xuICB9XG4gIC8qKlxuICAgKiBnZXQgcHJvcGVydHkgcGF0aHMgZnJvbSBldmVudCBwYXRoc1xuICAgKiBAcGFyYW0gcGF0aHMgZXZlbnQgcGF0aHNcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwcm90ZWN0ZWQgZ2V0UHJvcGVydHlQYXRoc0Zyb21FdmVudFBhdGhzKHBhdGhzOiBzdHJpbmdbXSkge1xuICAgIHBhdGhzID0gdGhpcy5nZXRFbnRpdHlQYXRoKHBhdGhzKTtcbiAgICBjb25zdCB0YWJsZVBhdGhzID0gRXhwcmVzc2lvblV0aWwuZ2V0QXZhaWxhYmxlQ2hpbGRyZW5QYXRoc0Zyb21FbnRpdHlQYXRocyhwYXRocywgdGhpcy5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvKTtcbiAgICByZXR1cm4gcGF0aHMuc2xpY2UodGFibGVQYXRocy5sZW5ndGgpO1xuICB9XG4gIC8qKlxuICAgKiDliIbmnpDkuovku7blkozooajovr7lvI/nmoTlhbPns7tcbiAgICovXG4gIHByb3RlY3RlZCBhbmFseXNpcyhldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MsIGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkge1xuICAgIGNvbnN0IGV4cHJlc3Npb25QYXRoSW5mbyA9IHRoaXMuZ2V0UGF0aEluZm8oZXhwcmVzc2lvbk9iamVjdC5wYXRoKTtcbiAgICBjb25zdCBldmVudFBhdGhzID0gdGhpcy5nZXRFbnRpdHlQYXRoKGV2ZW50LnBhdGguc2xpY2UoMCkpO1xuICAgIGNvbnN0IGV2ZW50UGF0aEluZm8gPSB0aGlzLmdldFBhdGhJbmZvKGV2ZW50UGF0aHMuam9pbignLycpKTtcbiAgICBpZiAoIWV4cHJlc3Npb25QYXRoSW5mbyB8fCAhZXZlbnRQYXRoSW5mbykge1xuICAgICAgY29uc29sZS53YXJuKGDooajovr7lvI/ot6/lvoTmiJbkuovku7bot6/lvoTplJnor6/vvIzojrflj5bot6/lvoTkv6Hmga/lpLHotKXjgIJgKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCBleHByZXNzaW9uVGFibGVQYXRocyA9IGV4cHJlc3Npb25QYXRoSW5mby5wYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgY29uc3QgZXhwcmVzc2lvblByb3BlcnR5TmFtZXMgPSBleHByZXNzaW9uUGF0aEluZm8ucHJvcGVydHlOYW1lLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgY29uc3QgZXZlbnRUYWJsZVBhdGhzID0gZXZlbnRQYXRoSW5mby5wYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgY29uc3QgZXZlbnRQcm9wZXJ0eU5hbWVzID0gZXZlbnRQYXRoSW5mby5wcm9wZXJ0eU5hbWUuc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcbiAgICBjb25zdCByZXN1bHQgPSB7XG4gICAgICBkaXN0YW5jZTogdW5kZWZpbmVkLFxuICAgICAgZXZlbnRGcm9tQ2hpbGRyZW46IHVuZGVmaW5lZCxcbiAgICAgIGV2ZW50RnJvbVBhcmVudDogdW5kZWZpbmVkLFxuICAgICAgZXhwcmVzc2lvblRhYmxlUGF0aHMsXG4gICAgICBleHByZXNzaW9uUHJvcGVydHlOYW1lcyxcbiAgICAgIGV2ZW50VGFibGVQYXRocyxcbiAgICAgIGV2ZW50UHJvcGVydHlOYW1lcyxcbiAgICAgIGlzU2FtZVRhYmxlOiBmYWxzZVxuICAgIH07XG4gICAgcmVzdWx0LmRpc3RhbmNlID0gTWF0aC5hYnMoZXhwcmVzc2lvblRhYmxlUGF0aHMubGVuZ3RoIC0gZXZlbnRUYWJsZVBhdGhzLmxlbmd0aCk7XG4gICAgaWYgKHJlc3VsdC5kaXN0YW5jZSA9PT0gMSkge1xuICAgICAgcmVzdWx0LmV2ZW50RnJvbUNoaWxkcmVuID0gZXZlbnRUYWJsZVBhdGhzLmxlbmd0aCA+IGV4cHJlc3Npb25UYWJsZVBhdGhzLmxlbmd0aCAmJiBldmVudFRhYmxlUGF0aHMuam9pbignLycpLnN0YXJ0c1dpdGgoZXhwcmVzc2lvblRhYmxlUGF0aHMuam9pbignLycpKTtcbiAgICAgIHJlc3VsdC5ldmVudEZyb21QYXJlbnQgPSBldmVudFRhYmxlUGF0aHMubGVuZ3RoIDwgZXhwcmVzc2lvblRhYmxlUGF0aHMubGVuZ3RoICYmIGV4cHJlc3Npb25UYWJsZVBhdGhzLmpvaW4oJy8nKS5zdGFydHNXaXRoKGV2ZW50VGFibGVQYXRocy5qb2luKCcvJykpO1xuICAgIH1cbiAgICByZXN1bHQuaXNTYW1lVGFibGUgPSBleHByZXNzaW9uVGFibGVQYXRocy5qb2luKCcvJykgPT09IGV2ZW50VGFibGVQYXRocy5qb2luKCcvJyk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHByb3RlY3RlZCBidWlsZEN1cnJlbnRSb3dzKHRhYmxlUGF0aHM6IHN0cmluZ1tdLCBmdWxsUGF0aHM6IHN0cmluZ1tdKSB7XG4gICAgY29uc3QgY3VycmVudFJvd3MgPSBuZXcgQXJyYXk8RXhwcmVzc2lvbi5JQ3VycmVudFJvdz4oKTtcbiAgICBpZiAoIXRhYmxlUGF0aHMgfHwgdGFibGVQYXRocy5sZW5ndGggPCAxKSB7XG4gICAgICBjdXJyZW50Um93cy5wdXNoKHtcbiAgICAgICAgYmluZGluZ1BhdGg6ICcvJyxcbiAgICAgICAgcHJpbWFyeVZhbHVlOiBmdWxsUGF0aHNbMF1cbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBwYXRocyA9IFtdO1xuICAgICAgdGFibGVQYXRocy5mb3JFYWNoKChwYXRoOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7XG4gICAgICAgICAgY3VycmVudFJvd3MucHVzaCh7XG4gICAgICAgICAgICBiaW5kaW5nUGF0aDogJy8nLFxuICAgICAgICAgICAgcHJpbWFyeVZhbHVlOiBmdWxsUGF0aHNbMF1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBwYXRocy5wdXNoKHBhdGgpO1xuICAgICAgICBjb25zdCBwcmltYXJ5VmFsdWUgPSBmdWxsUGF0aHNbaW5kZXggKiAyICsgMl07XG4gICAgICAgIGN1cnJlbnRSb3dzLnB1c2goe1xuICAgICAgICAgIGJpbmRpbmdQYXRoOiBwYXRocy5qb2luKCcvJyksXG4gICAgICAgICAgcHJpbWFyeVZhbHVlOiBwcmltYXJ5VmFsdWVcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGN1cnJlbnRSb3dzO1xuICB9XG4gIC8vI2VuZHJlZ2lvblxufSJdfQ==