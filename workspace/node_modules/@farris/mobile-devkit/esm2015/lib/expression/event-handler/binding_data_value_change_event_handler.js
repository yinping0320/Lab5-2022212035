import { EffectorManager } from '../effector/effector_manager';
import { EntityList } from '../../entity/index';
import { ENTITY_TEMPLATE } from '../resolver/index';
import { ExpressionUtil } from '../utils/expression_util';
import { EventHandler } from './event_handler';
export class BindingDataValueChangeEventHandler extends EventHandler {
    filter(event) {
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            return this.expressionObjects.filter((expressionObject) => {
                const deps = expressionObject.deps;
                if (!deps || deps.length < 1 || event.ns !== expressionObject.ns) {
                    return false;
                }
                const eventEntityPaths = this.getEntityPath(event.path);
                eventEntityPaths.splice(0, 0, ENTITY_TEMPLATE);
                return deps.includes(eventEntityPaths.join('/'));
            });
        }
        return null;
    }
    /**
     * 发布事件
     * @param event event
     */
    dispatch(event) {
        const expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach((expressionObject) => {
                this.effect(event, expressionObject);
            });
        }
    }
    /**
     * 输出副作用
     * @param event event
     * @param expressionObject 表达式
     * @returns
     */
    effect(event, expressionObject) {
        // 首先计算当前表达式和事件会影响那些路径
        const effector = this.effectorFactory.getEffector(expressionObject);
        if (!effector) {
            return;
        }
        const result = this.analysis(event, expressionObject);
        if (!result) {
            return;
        }
        const eventPaths = this.cleanEventPath(event.path);
        const paths = [];
        if (result.distance === 0) {
            // 值变化之后影响到了一个表内字段或影响到了同级表字段
            if (result.isSameTable === false) {
                // 同级表跳过
                console.warn(`[BindingDataValueChangeEventHandler]不支持多对多关系。`);
                return;
            }
            const prevPaths = eventPaths.slice(0, eventPaths.length - result.eventPropertyNames.length);
            const path = prevPaths.concat(result.expressionPropertyNames);
            const currentRows = this.buildCurrentRows(result.eventTablePaths, path);
            paths.push(path);
            this.output(event, expressionObject, currentRows, effector, paths);
        }
        else {
            if (result.eventFromChildren === true) {
                if (result.distance > 1) {
                    return;
                }
                // 下级表值变化影响到了上级表的表达式
                const prevPaths = eventPaths.slice(0, eventPaths.length - result.eventPropertyNames.length - 2);
                const path = prevPaths.concat(result.expressionPropertyNames);
                paths.push(path);
                const currentRows = this.buildCurrentRows(result.eventTablePaths, eventPaths);
                this.output(event, expressionObject, currentRows, effector, paths);
            }
            else if (result.eventFromParent === true) {
                if (result.distance > 1) {
                    console.warn(`[BindingDataValueChangeEventHandler]不支持多对多关系。`);
                    return;
                }
                // 上级表值变化影响到了下级表的表达式
                const prevPaths = eventPaths.slice(0, eventPaths.length - result.eventPropertyNames.length);
                // 添加下级表nodecode到路径中
                prevPaths.push(result.expressionTablePaths.slice(0).pop());
                // 遍历子表
                const bindingPaths = result.expressionTablePaths;
                const primaryKeyValue = eventPaths[0];
                if (!primaryKeyValue) {
                    return;
                }
                let object = this.frameContext.repository.entityCollection.getEntityById(primaryKeyValue);
                // prevPaths like [1,c,1.1,cc]
                for (let index = 1; index < prevPaths.length; index++) {
                    const propertyName = prevPaths[index];
                    if (object instanceof EntityList) {
                        object = object.get(propertyName);
                    }
                    else {
                        object = object[propertyName];
                    }
                }
                const list = object;
                if (list && list instanceof EntityList && list.count() > 0) {
                    for (let entity of list) {
                        if (entity && entity.primaryValue) {
                            const path = prevPaths.concat([entity.primaryValue]).concat(result.expressionPropertyNames);
                            const currentRows = this.buildCurrentRows(result.expressionTablePaths, path);
                            this.output(event, expressionObject, currentRows, effector, [path]);
                        }
                    }
                }
            }
            else {
                // 跨表
            }
        }
    }
    output(event, expressionObject, currentRows, effector, paths) {
        const context = this.buildContext(expressionObject, event, null, currentRows);
        const value = this.perform(expressionObject, context);
        if (value === undefined) {
            return;
        }
        expressionObject.result = value;
        if (expressionObject.id) {
            this.expressionResult.set(expressionObject.id, expressionObject.result);
        }
        EffectorManager.effect(effector, expressionObject, paths);
    }
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    getCurrentRowByEvent(paths, event) {
        event = JSON.parse(JSON.stringify(event));
        let result = null;
        const bindingList = this.bindingData.getValue(paths);
        const eventEntityPath = this.getEntityPath(event.path);
        if (bindingList && bindingList.length > 0) {
            let primaryValue = bindingList.currentItem.primaryKeyValue || null;
            // 使用事件中的主键
            const childrenPaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(eventEntityPath, this.repository.entityTypeInfo);
            if (childrenPaths && childrenPaths.toString() === paths.toString()) {
                // 发生值变化的数据位于要获取当前行的子表中，此时事件行应该是发生值变化的数据id，而不是当前行id
                primaryValue = event.id || null;
                if (!primaryValue) {
                    primaryValue = this.getEventId(event.path, paths[paths.length - 1]);
                }
            }
            if (primaryValue) {
                const bindingObject = bindingList.findById(primaryValue);
                if (bindingObject) {
                    result = bindingObject.toJSON();
                }
            }
        }
        return result;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19kYXRhX3ZhbHVlX2NoYW5nZV9ldmVudF9oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2V4cHJlc3Npb24vZXZlbnQtaGFuZGxlci9iaW5kaW5nX2RhdGFfdmFsdWVfY2hhbmdlX2V2ZW50X2hhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBRy9ELE9BQU8sRUFBVSxVQUFVLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUV4RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzFELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUUvQyxNQUFNLE9BQU8sa0NBQW1DLFNBQVEsWUFBWTtJQUUzRCxNQUFNLENBQUMsS0FBMkI7UUFDdkMsSUFBSSxJQUFJLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDL0QsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLENBQUMsZ0JBQTZDLEVBQUUsRUFBRTtnQkFDckYsTUFBTSxJQUFJLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDO2dCQUNuQyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLEtBQUssQ0FBQyxFQUFFLEtBQUssZ0JBQWdCLENBQUMsRUFBRSxFQUFFO29CQUNoRSxPQUFPLEtBQUssQ0FBQztpQkFDZDtnQkFDRCxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUN4RCxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxF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QUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNyRTthQUNGO1lBQ0QsSUFBSSxZQUFZLEVBQUU7Z0JBQ2hCLE1BQU0sYUFBYSxHQUFHLFdBQVcsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBQ3pELElBQUksYUFBYSxFQUFFO29CQUNqQixNQUFNLEdBQUcsYUFBYSxDQUFDLE1BQU0sRUFBRSxDQUFDO2lCQUNqQzthQUNGO1NBQ0Y7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFZmZlY3Rvck1hbmFnZXIgfSBmcm9tICcuLi9lZmZlY3Rvci9lZmZlY3Rvcl9tYW5hZ2VyJztcbmltcG9ydCB7IEJpbmRpbmdMaXN0IH0gZnJvbSAnLi4vLi4vYmluZGluZy1kYXRhL2luZGV4JztcbmltcG9ydCB7IERhdGFQcm9wSW5mbyB9IGZyb20gJy4uLy4uL2VudGl0eS9pbmRleCc7XG5pbXBvcnQgeyBFbnRpdHksIEVudGl0eUxpc3QgfSBmcm9tICcuLi8uLi9lbnRpdHkvaW5kZXgnO1xuaW1wb3J0IHsgRXhwcmVzc2lvbiB9IGZyb20gJy4uL2V4cHJlc3Npb24vaW5kZXgnO1xuaW1wb3J0IHsgRU5USVRZX1RFTVBMQVRFIH0gZnJvbSAnLi4vcmVzb2x2ZXIvaW5kZXgnO1xuaW1wb3J0IHsgRXhwcmVzc2lvblV0aWwgfSBmcm9tICcuLi91dGlscy9leHByZXNzaW9uX3V0aWwnO1xuaW1wb3J0IHsgRXZlbnRIYW5kbGVyIH0gZnJvbSAnLi9ldmVudF9oYW5kbGVyJztcblxuZXhwb3J0IGNsYXNzIEJpbmRpbmdEYXRhVmFsdWVDaGFuZ2VFdmVudEhhbmRsZXIgZXh0ZW5kcyBFdmVudEhhbmRsZXIge1xuXG4gIHB1YmxpYyBmaWx0ZXIoZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKSB7XG4gICAgaWYgKHRoaXMuZXhwcmVzc2lvbk9iamVjdHMgJiYgdGhpcy5leHByZXNzaW9uT2JqZWN0cy5sZW5ndGggPiAwKSB7XG4gICAgICByZXR1cm4gdGhpcy5leHByZXNzaW9uT2JqZWN0cy5maWx0ZXIoKGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkgPT4ge1xuICAgICAgICBjb25zdCBkZXBzID0gZXhwcmVzc2lvbk9iamVjdC5kZXBzO1xuICAgICAgICBpZiAoIWRlcHMgfHwgZGVwcy5sZW5ndGggPCAxIHx8IGV2ZW50Lm5zICE9PSBleHByZXNzaW9uT2JqZWN0Lm5zKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGV2ZW50RW50aXR5UGF0aHMgPSB0aGlzLmdldEVudGl0eVBhdGgoZXZlbnQucGF0aCk7XG4gICAgICAgIGV2ZW50RW50aXR5UGF0aHMuc3BsaWNlKDAsIDAsIEVOVElUWV9URU1QTEFURSk7XG4gICAgICAgIHJldHVybiBkZXBzLmluY2x1ZGVzKGV2ZW50RW50aXR5UGF0aHMuam9pbignLycpKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiDlj5HluIPkuovku7ZcbiAgICogQHBhcmFtIGV2ZW50IGV2ZW50XG4gICAqL1xuICBwdWJsaWMgZGlzcGF0Y2goZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKSB7XG4gICAgY29uc3QgZXhwcmVzc2lvbnMgPSB0aGlzLmZpbHRlcihldmVudCk7XG4gICAgaWYgKGV4cHJlc3Npb25zICYmIGV4cHJlc3Npb25zLmxlbmd0aCA+IDApIHtcbiAgICAgIGV4cHJlc3Npb25zLmZvckVhY2goKGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkgPT4ge1xuICAgICAgICB0aGlzLmVmZmVjdChldmVudCwgZXhwcmVzc2lvbk9iamVjdCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog6L6T5Ye65Ymv5L2c55SoXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbk9iamVjdCDooajovr7lvI9cbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgZWZmZWN0KGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncywgZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KTogdm9pZCB7XG4gICAgLy8g6aaW5YWI6K6h566X5b2T5YmN6KGo6L6+5byP5ZKM5LqL5Lu25Lya5b2x5ZON6YKj5Lqb6Lev5b6EXG4gICAgY29uc3QgZWZmZWN0b3IgPSB0aGlzLmVmZmVjdG9yRmFjdG9yeS5nZXRFZmZlY3RvcihleHByZXNzaW9uT2JqZWN0KTtcbiAgICBpZiAoIWVmZmVjdG9yKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuYW5hbHlzaXMoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QpO1xuICAgIGlmICghcmVzdWx0KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGV2ZW50UGF0aHMgPSB0aGlzLmNsZWFuRXZlbnRQYXRoKGV2ZW50LnBhdGgpO1xuICAgIGNvbnN0IHBhdGhzOiBhbnlbXVtdID0gW107XG4gICAgaWYgKHJlc3VsdC5kaXN0YW5jZSA9PT0gMCkge1xuICAgICAgLy8g5YC85Y+Y5YyW5LmL5ZCO5b2x5ZON5Yiw5LqG5LiA5Liq6KGo5YaF5a2X5q615oiW5b2x5ZON5Yiw5LqG5ZCM57qn6KGo5a2X5q61XG4gICAgICBpZiAocmVzdWx0LmlzU2FtZVRhYmxlID09PSBmYWxzZSkge1xuICAgICAgICAvLyDlkIznuqfooajot7Pov4dcbiAgICAgICAgY29uc29sZS53YXJuKGBbQmluZGluZ0RhdGFWYWx1ZUNoYW5nZUV2ZW50SGFuZGxlcl3kuI3mlK/mjIHlpJrlr7nlpJrlhbPns7vjgIJgKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3QgcHJldlBhdGhzID0gZXZlbnRQYXRocy5zbGljZSgwLCBldmVudFBhdGhzLmxlbmd0aCAtIHJlc3VsdC5ldmVudFByb3BlcnR5TmFtZXMubGVuZ3RoKTtcbiAgICAgIGNvbnN0IHBhdGggPSBwcmV2UGF0aHMuY29uY2F0KHJlc3VsdC5leHByZXNzaW9uUHJvcGVydHlOYW1lcyk7XG4gICAgICBjb25zdCBjdXJyZW50Um93cyA9IHRoaXMuYnVpbGRDdXJyZW50Um93cyhyZXN1bHQuZXZlbnRUYWJsZVBhdGhzLCBwYXRoKTtcbiAgICAgIHBhdGhzLnB1c2gocGF0aCk7XG4gICAgICB0aGlzLm91dHB1dChldmVudCwgZXhwcmVzc2lvbk9iamVjdCwgY3VycmVudFJvd3MsIGVmZmVjdG9yLCBwYXRocyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChyZXN1bHQuZXZlbnRGcm9tQ2hpbGRyZW4gPT09IHRydWUpIHtcbiAgICAgICAgaWYgKHJlc3VsdC5kaXN0YW5jZSA+IDEpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgLy8g5LiL57qn6KGo5YC85Y+Y5YyW5b2x5ZON5Yiw5LqG5LiK57qn6KGo55qE6KGo6L6+5byPXG4gICAgICAgIGNvbnN0IHByZXZQYXRocyA9IGV2ZW50UGF0aHMuc2xpY2UoMCwgZXZlbnRQYXRocy5sZW5ndGggLSByZXN1bHQuZXZlbnRQcm9wZXJ0eU5hbWVzLmxlbmd0aCAtIDIpO1xuICAgICAgICBjb25zdCBwYXRoID0gcHJldlBhdGhzLmNvbmNhdChyZXN1bHQuZXhwcmVzc2lvblByb3BlcnR5TmFtZXMpO1xuICAgICAgICBwYXRocy5wdXNoKHBhdGgpO1xuICAgICAgICBjb25zdCBjdXJyZW50Um93cyA9IHRoaXMuYnVpbGRDdXJyZW50Um93cyhyZXN1bHQuZXZlbnRUYWJsZVBhdGhzLCBldmVudFBhdGhzKTtcbiAgICAgICAgdGhpcy5vdXRwdXQoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QsIGN1cnJlbnRSb3dzLCBlZmZlY3RvciwgcGF0aHMpO1xuICAgICAgfSBlbHNlIGlmIChyZXN1bHQuZXZlbnRGcm9tUGFyZW50ID09PSB0cnVlKSB7XG4gICAgICAgIGlmIChyZXN1bHQuZGlzdGFuY2UgPiAxKSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKGBbQmluZGluZ0RhdGFWYWx1ZUNoYW5nZUV2ZW50SGFuZGxlcl3kuI3mlK/mjIHlpJrlr7nlpJrlhbPns7vjgIJgKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgLy8g5LiK57qn6KGo5YC85Y+Y5YyW5b2x5ZON5Yiw5LqG5LiL57qn6KGo55qE6KGo6L6+5byPXG4gICAgICAgIGNvbnN0IHByZXZQYXRocyA9IGV2ZW50UGF0aHMuc2xpY2UoMCwgZXZlbnRQYXRocy5sZW5ndGggLSByZXN1bHQuZXZlbnRQcm9wZXJ0eU5hbWVzLmxlbmd0aCk7XG4gICAgICAgIC8vIOa3u+WKoOS4i+e6p+ihqG5vZGVjb2Rl5Yiw6Lev5b6E5LitXG4gICAgICAgIHByZXZQYXRocy5wdXNoKHJlc3VsdC5leHByZXNzaW9uVGFibGVQYXRocy5zbGljZSgwKS5wb3AoKSk7XG4gICAgICAgIC8vIOmBjeWOhuWtkOihqFxuICAgICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSByZXN1bHQuZXhwcmVzc2lvblRhYmxlUGF0aHM7XG4gICAgICAgIGNvbnN0IHByaW1hcnlLZXlWYWx1ZSA9IGV2ZW50UGF0aHNbMF07XG4gICAgICAgIGlmICghcHJpbWFyeUtleVZhbHVlKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGxldCBvYmplY3QgPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChwcmltYXJ5S2V5VmFsdWUpO1xuICAgICAgICAvLyBwcmV2UGF0aHMgbGlrZSBbMSxjLDEuMSxjY11cbiAgICAgICAgZm9yIChsZXQgaW5kZXggPSAxOyBpbmRleCA8IHByZXZQYXRocy5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwcmV2UGF0aHNbaW5kZXhdO1xuICAgICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiBFbnRpdHlMaXN0KSB7XG4gICAgICAgICAgICBvYmplY3QgPSBvYmplY3QuZ2V0KHByb3BlcnR5TmFtZSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG9iamVjdCA9IG9iamVjdFtwcm9wZXJ0eU5hbWVdO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjb25zdCBsaXN0ID0gb2JqZWN0O1xuICAgICAgICBpZiAobGlzdCAmJiBsaXN0IGluc3RhbmNlb2YgRW50aXR5TGlzdCAmJiBsaXN0LmNvdW50KCkgPiAwKSB7XG4gICAgICAgICAgZm9yIChsZXQgZW50aXR5IG9mIGxpc3QpIHtcbiAgICAgICAgICAgIGlmIChlbnRpdHkgJiYgZW50aXR5LnByaW1hcnlWYWx1ZSkge1xuICAgICAgICAgICAgICBjb25zdCBwYXRoID0gcHJldlBhdGhzLmNvbmNhdChbZW50aXR5LnByaW1hcnlWYWx1ZV0pLmNvbmNhdChyZXN1bHQuZXhwcmVzc2lvblByb3BlcnR5TmFtZXMpO1xuICAgICAgICAgICAgICBjb25zdCBjdXJyZW50Um93cyA9IHRoaXMuYnVpbGRDdXJyZW50Um93cyhyZXN1bHQuZXhwcmVzc2lvblRhYmxlUGF0aHMsIHBhdGgpO1xuICAgICAgICAgICAgICB0aGlzLm91dHB1dChldmVudCwgZXhwcmVzc2lvbk9iamVjdCwgY3VycmVudFJvd3MsIGVmZmVjdG9yLCBbcGF0aF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8g6Leo6KGoXG4gICAgICB9XG4gICAgfVxuICB9XG4gIHB1YmxpYyBvdXRwdXQoZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzLCBleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QsIGN1cnJlbnRSb3dzOiBFeHByZXNzaW9uLklDdXJyZW50Um93W10sIGVmZmVjdG9yOiBFeHByZXNzaW9uLkVmZmVjdG9yLCBwYXRoczogYW55W11bXSkge1xuICAgIGNvbnN0IGNvbnRleHQgPSB0aGlzLmJ1aWxkQ29udGV4dChleHByZXNzaW9uT2JqZWN0LCBldmVudCwgbnVsbCwgY3VycmVudFJvd3MpO1xuICAgIGNvbnN0IHZhbHVlID0gdGhpcy5wZXJmb3JtKGV4cHJlc3Npb25PYmplY3QsIGNvbnRleHQpO1xuICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGV4cHJlc3Npb25PYmplY3QucmVzdWx0ID0gdmFsdWU7XG4gICAgaWYgKGV4cHJlc3Npb25PYmplY3QuaWQpIHtcbiAgICAgIHRoaXMuZXhwcmVzc2lvblJlc3VsdC5zZXQoZXhwcmVzc2lvbk9iamVjdC5pZCwgZXhwcmVzc2lvbk9iamVjdC5yZXN1bHQpO1xuICAgIH1cbiAgICBFZmZlY3Rvck1hbmFnZXIuZWZmZWN0KGVmZmVjdG9yLCBleHByZXNzaW9uT2JqZWN0LCBwYXRocyk7XG4gIH1cbiAgLyoqXG4gICAqIOiOt+WPluWtkOihqOS6i+S7tuihjFxuICAgKiBAcGFyYW0gcGF0aHMgXG4gICAqIEBwYXJhbSBldmVudCBcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgZ2V0Q3VycmVudFJvd0J5RXZlbnQocGF0aHM6IHN0cmluZ1tdLCBldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MpOiBudWxsIHwgeyBbcHJvcDogc3RyaW5nXTogYW55IH0ge1xuICAgIGV2ZW50ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShldmVudCkpO1xuICAgIGxldCByZXN1bHQgPSBudWxsO1xuICAgIGNvbnN0IGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCA9IHRoaXMuYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xuICAgIGNvbnN0IGV2ZW50RW50aXR5UGF0aCA9IHRoaXMuZ2V0RW50aXR5UGF0aChldmVudC5wYXRoKTtcbiAgICBpZiAoYmluZGluZ0xpc3QgJiYgYmluZGluZ0xpc3QubGVuZ3RoID4gMCkge1xuICAgICAgbGV0IHByaW1hcnlWYWx1ZSA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZSB8fCBudWxsO1xuICAgICAgLy8g5L2/55So5LqL5Lu25Lit55qE5Li76ZSuXG4gICAgICBjb25zdCBjaGlsZHJlblBhdGhzID0gRXhwcmVzc2lvblV0aWwuZ2V0QXZhaWxhYmxlQ2hpbGRyZW5QYXRoc0Zyb21FbnRpdHlQYXRocyhldmVudEVudGl0eVBhdGgsIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbyk7XG4gICAgICBpZiAoY2hpbGRyZW5QYXRocyAmJiBjaGlsZHJlblBhdGhzLnRvU3RyaW5nKCkgPT09IHBhdGhzLnRvU3RyaW5nKCkpIHtcbiAgICAgICAgLy8g5Y+R55Sf5YC85Y+Y5YyW55qE5pWw5o2u5L2N5LqO6KaB6I635Y+W5b2T5YmN6KGM55qE5a2Q6KGo5Lit77yM5q2k5pe25LqL5Lu26KGM5bqU6K+l5piv5Y+R55Sf5YC85Y+Y5YyW55qE5pWw5o2uaWTvvIzogIzkuI3mmK/lvZPliY3ooYxpZFxuICAgICAgICBwcmltYXJ5VmFsdWUgPSBldmVudC5pZCB8fCBudWxsO1xuICAgICAgICBpZiAoIXByaW1hcnlWYWx1ZSkge1xuICAgICAgICAgIHByaW1hcnlWYWx1ZSA9IHRoaXMuZ2V0RXZlbnRJZChldmVudC5wYXRoLCBwYXRoc1twYXRocy5sZW5ndGggLSAxXSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChwcmltYXJ5VmFsdWUpIHtcbiAgICAgICAgY29uc3QgYmluZGluZ09iamVjdCA9IGJpbmRpbmdMaXN0LmZpbmRCeUlkKHByaW1hcnlWYWx1ZSk7XG4gICAgICAgIGlmIChiaW5kaW5nT2JqZWN0KSB7XG4gICAgICAgICAgcmVzdWx0ID0gYmluZGluZ09iamVjdC50b0pTT04oKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG59Il19