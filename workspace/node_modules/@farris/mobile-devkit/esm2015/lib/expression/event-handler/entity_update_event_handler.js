import { Expression } from "../expression/index";
import { ENTITY_TEMPLATE } from "../resolver/index";
import { ExpressionUtil } from "../utils/expression_util";
import { EventHandler } from "./event_handler";
export class EntityUpdateEventHandler extends EventHandler {
    filter(event) {
        return this.expressionObjects.filter((expressionObject) => {
            // 重新加载实体时不计算计算表达式，只处理只读、必填等
            if (expressionObject.ns !== event.ns || !expressionObject.deps || expressionObject.deps.length === 0 || expressionObject.type === Expression.ExpressionType.Compute || expressionObject.type === Expression.ExpressionType.Dependency || expressionObject.type === Expression.ExpressionType.DataPicking) {
                return false;
            }
            const result = this.analysis(event, expressionObject);
            if (!result) {
                return false;
            }
            // 必须是主表表达式
            if (result.expressionTablePaths.length !== 0) {
                return false;
            }
            const index = expressionObject.deps.findIndex((dep) => {
                if (!dep.startsWith(ENTITY_TEMPLATE)) {
                    return false;
                }
                const deps = dep.split(Expression.DEPENDENCY_SPLITER).filter(p => p).slice(1);
                const depPathInfo = this.getPathInfo(deps.join('/'));
                if (!depPathInfo) {
                    return false;
                }
                if (depPathInfo.paths.length !== 0) {
                    return false;
                }
                return true;
            });
            return index === -1 ? false : true;
        });
    }
    /**
     * 发布事件
     * @param event event
     */
    dispatch(event) {
        const expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach((expressionObject) => {
                const entityContext = this.buildEntityContext(event, expressionObject);
                const context = this.buildContext(expressionObject, event, entityContext);
                const result = this.perform(expressionObject, context);
                if (result === undefined && !this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = result;
                if (expressionObject.id) {
                    this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                else {
                    console.warn(`EventHandler 表达式未设置唯一标识，无法更新表达式值。`);
                }
                this.effect(event, expressionObject);
            });
        }
    }
    getCurrentRowByEvent(paths, event) {
        let result = null;
        const bindingList = this.bindingData.getValue(paths);
        const eventEntityPath = this.getEntityPath(event.path);
        if (bindingList && bindingList.length > 0) {
            let primaryValue = bindingList.currentItem.primaryKeyValue || null;
            // 使用事件中的主键
            const childrenPaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(eventEntityPath, this.repository.entityTypeInfo);
            if (childrenPaths && childrenPaths.toString() === paths.toString()) {
                // 发生值变化的数据位于要获取当前行的子表中，此时事件行应该是发生值变化的数据id，而不是当前行id
                primaryValue = event.id || null;
                if (!primaryValue) {
                    primaryValue = this.getEventId(event.path, paths[paths.length - 1]);
                }
            }
            if (primaryValue) {
                const bindingObject = bindingList.findById(primaryValue);
                if (bindingObject) {
                    result = bindingObject.toJSON();
                }
            }
        }
        return result;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X3VwZGF0ZV9ldmVudF9oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2V4cHJlc3Npb24vZXZlbnQtaGFuZGxlci9lbnRpdHlfdXBkYXRlX2V2ZW50X2hhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDMUQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRS9DLE1BQU0sT0FBTyx3QkFBeUIsU0FBUSxZQUFZO0lBRWpELE1BQU0sQ0FBQyxLQUEyQjtRQUN2QyxPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQyxnQkFBNkMsRUFBRSxFQUFFO1lBQ3JGLDRCQUE0QjtZQUM1QixJQUFJLGdCQUFnQixDQUFDLEVBQUUsS0FBSyxLQUFLLENBQUMsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxJQUFJLGdCQUFnQixDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLGdCQUFnQixDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsY0FBYyxDQUFDLE9BQU8sSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLGNBQWMsQ0FBQyxVQUFVLElBQUksZ0JBQWdCLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFO2dCQUN4UyxPQUFPLEtBQUssQ0FBQzthQUNkO1lBQ0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztZQUN0RCxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNYLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7WUFDRCxXQUFXO1lBQ1gsSUFBSSxNQUFNLENBQUMsb0JBQW9CLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtnQkFDNUMsT0FBTyxLQUFLLENBQUM7YUFDZDtZQUNELE1BQU0sS0FBSyxHQUFHLGdCQUFnQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxHQUFXLEVBQUUsRUFBRTtnQkFDNUQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLEVBQUU7b0JBQ3BDLE9BQU8sS0FBSyxDQUFDO2lCQUNkO2dCQUNELE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM5RSxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDckQsSUFBSSxDQUFDLFdBQVcsRUFBRTtvQkFDaEIsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7Z0JBQ0QsSUFBSSxXQUFXLENBQUMsS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7b0JBQ2xDLE9BQU8sS0FBSyxDQUFDO2lCQUNkO2dCQUNELE9BQU8sSUFBSSxDQUFDO1lBQ2QsQ0FBQyxDQUFDLENBQUM7WUFDSCxPQUFPLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDckMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0Q7OztPQUdHO0lBQ0ksUUFBUSxDQUFDLEtBQTJCO1FBQ3pDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdkMsSUFBSSxXQUFXLElBQUksV0FBVyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDekMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLGdCQUE2QyxFQUFFLEVBQUU7Z0JBQ3BFLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztnQkFDdkUsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsYUFBYSxDQUFDLENBQUM7Z0JBQzFFLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQ3ZELElBQUksTUFBTSxLQUFLLFNBQVMsSUFBSSxDQUFDLElBQUksQ0FBQyw4QkFBOEIsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFO29CQUNsRixPQUFPO2lCQUNSO2dCQUNELGdCQUFnQixDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7Z0JBQ2pDLElBQUksZ0JBQWdCLENBQUMsRUFBRSxFQUFFO29CQUN2QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsRUFBRSxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztpQkFDekU7cUJBQU07b0JBQ0wsT0FBTyxDQUFDLElBQUksQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO2lCQUNuRDtnQkFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3ZDLENBQUMsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDO0lBQ00sb0JBQW9CLENBQUMsS0FBZSxFQUFFLEtBQTJCO1FBQ3RFLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQztRQUNsQixNQUFNLFdBQVcsR0FBZ0IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFnQixDQUFDO1FBQ2pGLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3ZELElBQUksV0FBVyxJQUFJLFdBQVcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3pDLElBQUksWUFBWSxHQUFHLFdBQVcsQ0FBQyxXQUFXLENBQUMsZUFBZSxJQUFJLElBQUksQ0FBQztZQUNuRSxXQUFXO1lBQ1gsTUFBTSxhQUFhLEdBQUcsY0FBYyxDQUFDLHdDQUF3QyxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQy9ILElBQUksYUFBYSxJQUFJLGFBQWEsQ0FBQyxRQUFRLEVBQUUsS0FBSyxLQUFLLENBQUMsUUFBUSxFQUFFLEVBQUU7Z0JBQ2xFLG1EQUFtRDtnQkFDbkQsWUFBWSxHQUFHLEtBQUssQ0FBQyxFQUFFLElBQUksSUFBSSxDQUFDO2dCQUNoQyxJQUFJLENBQUMsWUFBWSxFQUFFO29CQUNqQixZQUFZLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQ3JFO2FBQ0Y7WUFDRCxJQUFJLFlBQVksRUFBRTtnQkFDaEIsTUFBTSxhQUFhLEdBQUcsV0FBVyxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQztnQkFDekQsSUFBSSxhQUFhLEVBQUU7b0JBQ2pCLE1BQU0sR0FBRyxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUM7aUJBQ2pDO2FBQ0Y7U0FDRjtRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJpbmRpbmdMaXN0IH0gZnJvbSBcIi4uLy4uL2JpbmRpbmctZGF0YS9pbmRleFwiO1xuaW1wb3J0IHsgRXhwcmVzc2lvbiB9IGZyb20gXCIuLi9leHByZXNzaW9uL2luZGV4XCI7XG5pbXBvcnQgeyBFTlRJVFlfVEVNUExBVEUgfSBmcm9tIFwiLi4vcmVzb2x2ZXIvaW5kZXhcIjtcbmltcG9ydCB7IEV4cHJlc3Npb25VdGlsIH0gZnJvbSBcIi4uL3V0aWxzL2V4cHJlc3Npb25fdXRpbFwiO1xuaW1wb3J0IHsgRXZlbnRIYW5kbGVyIH0gZnJvbSBcIi4vZXZlbnRfaGFuZGxlclwiO1xuXG5leHBvcnQgY2xhc3MgRW50aXR5VXBkYXRlRXZlbnRIYW5kbGVyIGV4dGVuZHMgRXZlbnRIYW5kbGVyIHtcblxuICBwdWJsaWMgZmlsdGVyKGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncykge1xuICAgIHJldHVybiB0aGlzLmV4cHJlc3Npb25PYmplY3RzLmZpbHRlcigoZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KSA9PiB7XG4gICAgICAvLyDph43mlrDliqDovb3lrp7kvZPml7bkuI3orqHnrpforqHnrpfooajovr7lvI/vvIzlj6rlpITnkIblj6ror7vjgIHlv4XloavnrYlcbiAgICAgIGlmIChleHByZXNzaW9uT2JqZWN0Lm5zICE9PSBldmVudC5ucyB8fCAhZXhwcmVzc2lvbk9iamVjdC5kZXBzIHx8IGV4cHJlc3Npb25PYmplY3QuZGVwcy5sZW5ndGggPT09IDAgfHwgZXhwcmVzc2lvbk9iamVjdC50eXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLkNvbXB1dGUgfHwgZXhwcmVzc2lvbk9iamVjdC50eXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLkRlcGVuZGVuY3kgfHwgZXhwcmVzc2lvbk9iamVjdC50eXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLkRhdGFQaWNraW5nKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuYW5hbHlzaXMoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QpO1xuICAgICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgLy8g5b+F6aG75piv5Li76KGo6KGo6L6+5byPXG4gICAgICBpZiAocmVzdWx0LmV4cHJlc3Npb25UYWJsZVBhdGhzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICBjb25zdCBpbmRleCA9IGV4cHJlc3Npb25PYmplY3QuZGVwcy5maW5kSW5kZXgoKGRlcDogc3RyaW5nKSA9PiB7XG4gICAgICAgIGlmICghZGVwLnN0YXJ0c1dpdGgoRU5USVRZX1RFTVBMQVRFKSkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBkZXBzID0gZGVwLnNwbGl0KEV4cHJlc3Npb24uREVQRU5ERU5DWV9TUExJVEVSKS5maWx0ZXIocCA9PiBwKS5zbGljZSgxKTtcbiAgICAgICAgY29uc3QgZGVwUGF0aEluZm8gPSB0aGlzLmdldFBhdGhJbmZvKGRlcHMuam9pbignLycpKTtcbiAgICAgICAgaWYgKCFkZXBQYXRoSW5mbykge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZGVwUGF0aEluZm8ucGF0aHMubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gaW5kZXggPT09IC0xID8gZmFsc2UgOiB0cnVlO1xuICAgIH0pO1xuICB9XG4gIC8qKlxuICAgKiDlj5HluIPkuovku7ZcbiAgICogQHBhcmFtIGV2ZW50IGV2ZW50XG4gICAqL1xuICBwdWJsaWMgZGlzcGF0Y2goZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKSB7XG4gICAgY29uc3QgZXhwcmVzc2lvbnMgPSB0aGlzLmZpbHRlcihldmVudCk7XG4gICAgaWYgKGV4cHJlc3Npb25zICYmIGV4cHJlc3Npb25zLmxlbmd0aCA+IDApIHtcbiAgICAgIGV4cHJlc3Npb25zLmZvckVhY2goKGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkgPT4ge1xuICAgICAgICBjb25zdCBlbnRpdHlDb250ZXh0ID0gdGhpcy5idWlsZEVudGl0eUNvbnRleHQoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QpO1xuICAgICAgICBjb25zdCBjb250ZXh0ID0gdGhpcy5idWlsZENvbnRleHQoZXhwcmVzc2lvbk9iamVjdCwgZXZlbnQsIGVudGl0eUNvbnRleHQpO1xuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnBlcmZvcm0oZXhwcmVzc2lvbk9iamVjdCwgY29udGV4dCk7XG4gICAgICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCAmJiAhdGhpcy5pc1ZhbGlkYXRlT3JSZXF1aXJlZEV4cHJlc3Npb24oZXhwcmVzc2lvbk9iamVjdCkpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgZXhwcmVzc2lvbk9iamVjdC5yZXN1bHQgPSByZXN1bHQ7XG4gICAgICAgIGlmIChleHByZXNzaW9uT2JqZWN0LmlkKSB7XG4gICAgICAgICAgdGhpcy5leHByZXNzaW9uUmVzdWx0LnNldChleHByZXNzaW9uT2JqZWN0LmlkLCBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKGBFdmVudEhhbmRsZXIg6KGo6L6+5byP5pyq6K6+572u5ZSv5LiA5qCH6K+G77yM5peg5rOV5pu05paw6KGo6L6+5byP5YC844CCYCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5lZmZlY3QoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIHB1YmxpYyBnZXRDdXJyZW50Um93QnlFdmVudChwYXRoczogc3RyaW5nW10sIGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncykge1xuICAgIGxldCByZXN1bHQgPSBudWxsO1xuICAgIGNvbnN0IGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCA9IHRoaXMuYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xuICAgIGNvbnN0IGV2ZW50RW50aXR5UGF0aCA9IHRoaXMuZ2V0RW50aXR5UGF0aChldmVudC5wYXRoKTtcbiAgICBpZiAoYmluZGluZ0xpc3QgJiYgYmluZGluZ0xpc3QubGVuZ3RoID4gMCkge1xuICAgICAgbGV0IHByaW1hcnlWYWx1ZSA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZSB8fCBudWxsO1xuICAgICAgLy8g5L2/55So5LqL5Lu25Lit55qE5Li76ZSuXG4gICAgICBjb25zdCBjaGlsZHJlblBhdGhzID0gRXhwcmVzc2lvblV0aWwuZ2V0QXZhaWxhYmxlQ2hpbGRyZW5QYXRoc0Zyb21FbnRpdHlQYXRocyhldmVudEVudGl0eVBhdGgsIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbyk7XG4gICAgICBpZiAoY2hpbGRyZW5QYXRocyAmJiBjaGlsZHJlblBhdGhzLnRvU3RyaW5nKCkgPT09IHBhdGhzLnRvU3RyaW5nKCkpIHtcbiAgICAgICAgLy8g5Y+R55Sf5YC85Y+Y5YyW55qE5pWw5o2u5L2N5LqO6KaB6I635Y+W5b2T5YmN6KGM55qE5a2Q6KGo5Lit77yM5q2k5pe25LqL5Lu26KGM5bqU6K+l5piv5Y+R55Sf5YC85Y+Y5YyW55qE5pWw5o2uaWTvvIzogIzkuI3mmK/lvZPliY3ooYxpZFxuICAgICAgICBwcmltYXJ5VmFsdWUgPSBldmVudC5pZCB8fCBudWxsO1xuICAgICAgICBpZiAoIXByaW1hcnlWYWx1ZSkge1xuICAgICAgICAgIHByaW1hcnlWYWx1ZSA9IHRoaXMuZ2V0RXZlbnRJZChldmVudC5wYXRoLCBwYXRoc1twYXRocy5sZW5ndGggLSAxXSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChwcmltYXJ5VmFsdWUpIHtcbiAgICAgICAgY29uc3QgYmluZGluZ09iamVjdCA9IGJpbmRpbmdMaXN0LmZpbmRCeUlkKHByaW1hcnlWYWx1ZSk7XG4gICAgICAgIGlmIChiaW5kaW5nT2JqZWN0KSB7XG4gICAgICAgICAgcmVzdWx0ID0gYmluZGluZ09iamVjdC50b0pTT04oKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG59Il19