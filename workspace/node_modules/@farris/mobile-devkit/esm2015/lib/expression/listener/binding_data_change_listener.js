import { BindingList, ChangeType } from '../../binding-data/index';
import { ChangeListener } from './change_listener';
import { Expression } from '../expression/index';
import { NAMESPACE } from '../core/index';
const EventType = Expression.EventType;
/**
 * 监听bindingList变更
 * @description 主要用于监听行切换等事件
 */
class BindingDataChangeListener extends ChangeListener {
    /**
     * 构造函数
     */
    constructor(viewModelContext) {
        super();
        this.viewModelContext = viewModelContext;
        /**
         * 实体仓库
         */
        this.repository = null;
        this.namespace = this.viewModelContext.injector.get(NAMESPACE, '');
        this.repository = this.viewModelContext.repository;
        this.bindingData = this.viewModelContext.bindingData;
        this.registerEvent();
    }
    /**
     * 注册值变化事件
     */
    registerEvent() {
        if (this.bindingData && this.bindingData.changes && typeof this.bindingData.changes.subscribe === 'function') {
            this.bindingData.changes.subscribe((change) => {
                if (change.type === ChangeType.Append || change.type === ChangeType.ValueChanged || change.type === ChangeType.Remove || change.type === ChangeType.Load || change.type === ChangeType.SelectionChanged) {
                    let eventType = null;
                    if (change.type === ChangeType.Append) {
                        eventType = EventType.Append;
                    }
                    else if (change.type === ChangeType.ValueChanged) {
                        eventType = EventType.ValueChanged;
                    }
                    else if (change.type === ChangeType.Remove) {
                        eventType = EventType.Remove;
                    }
                    else if (change.type === ChangeType.Load) {
                        // 主表新增
                        if (change.create === true) {
                            eventType = EventType.Append;
                        }
                        else {
                            eventType = EventType.Load;
                        }
                    }
                    else if (change.type === ChangeType.SelectionChanged) {
                        eventType = EventType.SelectionChanged;
                    }
                    const path = this.buildEventPath(change);
                    const modification = {
                        ns: this.namespace,
                        path: path,
                        type: eventType,
                        source: Expression.EventSource.BindingData,
                        value: change.value,
                        id: change.id
                    };
                    // console.log("BindingDataChangeListener", modification);
                    this.subject.next(modification);
                }
            });
        }
    }
    buildEventPath(change) {
        const path = change.path;
        const paths = [];
        // if (!path || path.length < 1) {
        //   return paths;
        // }
        const primaryValue = this.bindingData.list.currentItem.primaryKeyValue;
        if (primaryValue) {
            if (!(change.type === ChangeType.Load && change.path.length === 0)) {
                paths.push(`${this.bindingData.list.primaryKey}:${primaryValue}`);
            }
        }
        const currentPath = [];
        for (let index = 0; index < path.length; index++) {
            const propertyName = path[index];
            currentPath.push(propertyName);
            const item = this.bindingData.getValue(currentPath);
            paths.push(propertyName);
            if (item instanceof BindingList) {
                if (currentPath.length < path.length) {
                    const bindingList = item;
                    let currentId = bindingList.currentItem.primaryKeyValue;
                    if (index === path.length - 2 && change.id) {
                        currentId = change.id;
                    }
                    paths.push(`${this.bindingData.list.primaryKey}:${currentId}`);
                }
            }
        }
        return paths;
    }
}
export { BindingDataChangeListener };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19kYXRhX2NoYW5nZV9saXN0ZW5lci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9leHByZXNzaW9uL2xpc3RlbmVyL2JpbmRpbmdfZGF0YV9jaGFuZ2VfbGlzdGVuZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFlLFdBQVcsRUFBVSxVQUFVLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN4RixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFNMUMsTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQztBQUN2Qzs7O0dBR0c7QUFDSCxNQUFNLHlCQUEwQixTQUFRLGNBQWM7SUFpQnBEOztPQUVHO0lBQ0gsWUFBb0IsZ0JBQWtDO1FBQ3BELEtBQUssRUFBRSxDQUFDO1FBRFUscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQWJ0RDs7V0FFRztRQUNLLGVBQVUsR0FBb0IsSUFBSSxDQUFDO1FBWXpDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ25FLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQztRQUNuRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUM7UUFFckQsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFRDs7T0FFRztJQUNLLGFBQWE7UUFDbkIsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxJ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S0FBSyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDaEQsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2pDLFdBQVcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDL0IsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDcEQsS0FBSyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUN6QixJQUFJLElBQUksWUFBWSxXQUFXLEVBQUU7Z0JBQy9CLElBQUksV0FBVyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFO29CQUNwQyxNQUFNLFdBQVcsR0FBRyxJQUFtQixDQUFDO29CQUN4QyxJQUFJLFNBQVMsR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQztvQkFDeEQsSUFBSSxLQUFLLEtBQUssSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksTUFBTSxDQUFDLEVBQUUsRUFBRTt3QkFDMUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxFQUFFLENBQUM7cUJBQ3ZCO29CQUNELEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksU0FBUyxFQUFFLENBQUMsQ0FBQztpQkFDaEU7YUFDRjtTQUNGO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0NBQ0Y7QUFDRCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJpbmRpbmdEYXRhLCBCaW5kaW5nTGlzdCwgQ2hhbmdlLCBDaGFuZ2VUeXBlIH0gZnJvbSAnLi4vLi4vYmluZGluZy1kYXRhL2luZGV4JztcbmltcG9ydCB7IENoYW5nZUxpc3RlbmVyIH0gZnJvbSAnLi9jaGFuZ2VfbGlzdGVuZXInO1xuaW1wb3J0IHsgRXhwcmVzc2lvbiB9IGZyb20gJy4uL2V4cHJlc3Npb24vaW5kZXgnO1xuaW1wb3J0IHsgTkFNRVNQQUNFIH0gZnJvbSAnLi4vY29yZS9pbmRleCc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAnLi4vLi4vcmVwb3NpdG9yeS9pbmRleCc7XG5pbXBvcnQgeyBWaWV3TW9kZWxDb250ZXh0IH0gZnJvbSAnLi4vLi4vdmlldy1tb2RlbC9pbmRleCc7XG5cblxudHlwZSBFdmVudEFyZ3MgPSBFeHByZXNzaW9uLkV2ZW50QXJncztcbmNvbnN0IEV2ZW50VHlwZSA9IEV4cHJlc3Npb24uRXZlbnRUeXBlO1xuLyoqXG4gKiDnm5HlkKxiaW5kaW5nTGlzdOWPmOabtFxuICogQGRlc2NyaXB0aW9uIOS4u+imgeeUqOS6juebkeWQrOihjOWIh+aNouetieS6i+S7tlxuICovXG5jbGFzcyBCaW5kaW5nRGF0YUNoYW5nZUxpc3RlbmVyIGV4dGVuZHMgQ2hhbmdlTGlzdGVuZXIge1xuXG4gIC8qKlxuICAgKiDlkb3lkI3nqbrpl7RcbiAgICovXG4gIHByaXZhdGUgbmFtZXNwYWNlO1xuXG4gIC8qKlxuICAgKiDlrp7kvZPku5PlupNcbiAgICovXG4gIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+ID0gbnVsbDtcblxuICAvKipcbiAgICog57uR5a6a5pWw5o2uXG4gICAqL1xuICBwcml2YXRlIGJpbmRpbmdEYXRhOiBCaW5kaW5nRGF0YVxuICBcbiAgLyoqXG4gICAqIOaehOmAoOWHveaVsFxuICAgKi9cbiAgY29uc3RydWN0b3IocHJpdmF0ZSB2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0KSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLm5hbWVzcGFjZSA9IHRoaXMudmlld01vZGVsQ29udGV4dC5pbmplY3Rvci5nZXQoTkFNRVNQQUNFLCAnJyk7XG4gICAgdGhpcy5yZXBvc2l0b3J5ID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LnJlcG9zaXRvcnk7XG4gICAgdGhpcy5iaW5kaW5nRGF0YSA9IHRoaXMudmlld01vZGVsQ29udGV4dC5iaW5kaW5nRGF0YTtcblxuICAgIHRoaXMucmVnaXN0ZXJFdmVudCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIOazqOWGjOWAvOWPmOWMluS6i+S7tlxuICAgKi9cbiAgcHJpdmF0ZSByZWdpc3RlckV2ZW50KCkge1xuICAgIGlmICh0aGlzLmJpbmRpbmdEYXRhICYmIHRoaXMuYmluZGluZ0RhdGEuY2hhbmdlcyAmJiB0eXBlb2YgdGhpcy5iaW5kaW5nRGF0YS5jaGFuZ2VzLnN1YnNjcmliZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhpcy5iaW5kaW5nRGF0YS5jaGFuZ2VzLnN1YnNjcmliZSgoY2hhbmdlOiBDaGFuZ2UpID0+IHtcbiAgICAgICAgaWYgKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLkFwcGVuZCB8fCBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5WYWx1ZUNoYW5nZWQgfHwgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuUmVtb3ZlIHx8IGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLkxvYWQgfHwgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuU2VsZWN0aW9uQ2hhbmdlZCkge1xuICAgICAgICAgIGxldCBldmVudFR5cGUgPSBudWxsO1xuICAgICAgICAgIGlmIChjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5BcHBlbmQpIHtcbiAgICAgICAgICAgIGV2ZW50VHlwZSA9IEV2ZW50VHlwZS5BcHBlbmQ7XG4gICAgICAgICAgfSBlbHNlIGlmIChjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5WYWx1ZUNoYW5nZWQpIHtcbiAgICAgICAgICAgIGV2ZW50VHlwZSA9IEV2ZW50VHlwZS5WYWx1ZUNoYW5nZWQ7XG4gICAgICAgICAgfSBlbHNlIGlmIChjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5SZW1vdmUpIHtcbiAgICAgICAgICAgIGV2ZW50VHlwZSA9IEV2ZW50VHlwZS5SZW1vdmU7XG4gICAgICAgICAgfSBlbHNlIGlmIChjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5Mb2FkKSB7XG4gICAgICAgICAgICAvLyDkuLvooajmlrDlop5cbiAgICAgICAgICAgIGlmIChjaGFuZ2UuY3JlYXRlID09PSB0cnVlKSB7XG4gICAgICAgICAgICAgIGV2ZW50VHlwZSA9IEV2ZW50VHlwZS5BcHBlbmQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBldmVudFR5cGUgPSBFdmVudFR5cGUuTG9hZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2UgaWYgKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlNlbGVjdGlvbkNoYW5nZWQpIHtcbiAgICAgICAgICAgIGV2ZW50VHlwZSA9IEV2ZW50VHlwZS5TZWxlY3Rpb25DaGFuZ2VkXG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmJ1aWxkRXZlbnRQYXRoKGNoYW5nZSk7XG4gICAgICAgICAgY29uc3QgbW9kaWZpY2F0aW9uOiBFdmVudEFyZ3MgPSB7XG4gICAgICAgICAgICBuczogdGhpcy5uYW1lc3BhY2UsXG4gICAgICAgICAgICBwYXRoOiBwYXRoLFxuICAgICAgICAgICAgdHlwZTogZXZlbnRUeXBlLFxuICAgICAgICAgICAgc291cmNlOiBFeHByZXNzaW9uLkV2ZW50U291cmNlLkJpbmRpbmdEYXRhLFxuICAgICAgICAgICAgdmFsdWU6IGNoYW5nZS52YWx1ZSxcbiAgICAgICAgICAgIGlkOiBjaGFuZ2UuaWRcbiAgICAgICAgICB9O1xuICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiQmluZGluZ0RhdGFDaGFuZ2VMaXN0ZW5lclwiLCBtb2RpZmljYXRpb24pO1xuICAgICAgICAgIHRoaXMuc3ViamVjdC5uZXh0KG1vZGlmaWNhdGlvbik7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBidWlsZEV2ZW50UGF0aChjaGFuZ2U6IENoYW5nZSk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCBwYXRoID0gY2hhbmdlLnBhdGg7XG4gICAgY29uc3QgcGF0aHMgPSBbXTtcbiAgICAvLyBpZiAoIXBhdGggfHwgcGF0aC5sZW5ndGggPCAxKSB7XG4gICAgLy8gICByZXR1cm4gcGF0aHM7XG4gICAgLy8gfVxuICAgIGNvbnN0IHByaW1hcnlWYWx1ZSA9IHRoaXMuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWU7XG4gICAgaWYgKHByaW1hcnlWYWx1ZSkge1xuICAgICAgaWYgKCEoY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuTG9hZCAmJiBjaGFuZ2UucGF0aC5sZW5ndGggPT09IDApKSB7XG4gICAgICAgIHBhdGhzLnB1c2goYCR7dGhpcy5iaW5kaW5nRGF0YS5saXN0LnByaW1hcnlLZXl9OiR7cHJpbWFyeVZhbHVlfWApO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBjdXJyZW50UGF0aCA9IFtdO1xuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBwYXRoLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gcGF0aFtpbmRleF07XG4gICAgICBjdXJyZW50UGF0aC5wdXNoKHByb3BlcnR5TmFtZSk7XG4gICAgICBjb25zdCBpdGVtID0gdGhpcy5iaW5kaW5nRGF0YS5nZXRWYWx1ZShjdXJyZW50UGF0aCk7XG4gICAgICBwYXRocy5wdXNoKHByb3BlcnR5TmFtZSk7XG4gICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIEJpbmRpbmdMaXN0KSB7XG4gICAgICAgIGlmIChjdXJyZW50UGF0aC5sZW5ndGggPCBwYXRoLmxlbmd0aCkge1xuICAgICAgICAgIGNvbnN0IGJpbmRpbmdMaXN0ID0gaXRlbSBhcyBCaW5kaW5nTGlzdDtcbiAgICAgICAgICBsZXQgY3VycmVudElkID0gYmluZGluZ0xpc3QuY3VycmVudEl0ZW0ucHJpbWFyeUtleVZhbHVlO1xuICAgICAgICAgIGlmIChpbmRleCA9PT0gcGF0aC5sZW5ndGggLSAyICYmIGNoYW5nZS5pZCkge1xuICAgICAgICAgICAgY3VycmVudElkID0gY2hhbmdlLmlkO1xuICAgICAgICAgIH1cbiAgICAgICAgICBwYXRocy5wdXNoKGAke3RoaXMuYmluZGluZ0RhdGEubGlzdC5wcmltYXJ5S2V5fToke2N1cnJlbnRJZH1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcGF0aHM7XG4gIH1cbn1cbmV4cG9ydCB7IEJpbmRpbmdEYXRhQ2hhbmdlTGlzdGVuZXIgfTtcbiJdfQ==