import { ModifyType } from '../../changeset/index';
import { ChangeListener } from './change_listener';
import { Expression } from '../expression/index';
import { NAMESPACE } from '../core/index';
const EventType = Expression.EventType;
class RepositoryChangeListener extends ChangeListener {
    constructor(viewModelContext) {
        super();
        this.viewModelContext = viewModelContext;
        this.namespace = this.viewModelContext.injector.get(NAMESPACE, null);
        this.repository = this.viewModelContext.repository;
        this.bindingData = this.viewModelContext.bindingData;
        this.registerEvent();
    }
    registerEvent() {
        if (this.repository && this.repository.changes) {
            this.repository.changes.subscribe((change) => {
                let eventType = this.convertEventType(change);
                if (!eventType) {
                    return;
                }
                const path = this.buildEventPath(change);
                const modification = {
                    ns: this.namespace,
                    type: eventType,
                    path: path,
                    value: change.value,
                    source: Expression.EventSource.Field,
                };
                // console.log("RepositoryChangeListener", modification);
                this.subject.next(modification);
            });
        }
        // repository只监听值变化事件
        if (this.repository && this.repository.entityCollectionChange) {
            this.repository.entityCollectionChange.subscribe((change) => {
                let eventType = this.convertEventType(change);
                if (!eventType) {
                    return;
                }
                const path = this.buildEventPath(change);
                const modification = {
                    ns: this.namespace,
                    type: eventType,
                    path: path,
                    value: change.value,
                    source: Expression.EventSource.Repository,
                };
                this.subject.next(modification);
            });
        }
    }
    /**
     * 构建事件路径参数
     * @param event event
     * @description 构建完之后的路径类似[id,prop] or [id,从表名s,从表当前行id,从表属性] or [id,udt,udt_prop]
     * @returns
     */
    buildEventPath(event) {
        const paths = event.path;
        let result = [];
        if (!paths || paths.length < 1) {
            // 主表新增时path为空
            return result;
        }
        // 过滤掉udt的冒号，关联字段的id
        result = paths.filter((path, index) => {
            if (index % 2 === 0 && path.includes(':')) {
                if (path === ':') {
                    return false;
                }
                const primaryKey = path.split(':')[0];
                if (primaryKey !== this.repository.primaryKey) {
                    return false;
                }
            }
            return true;
        });
        // 移除路径中的id字符串
        // result = paths.map((path: string, index: number) => {
        //   if (path.includes(':') && index % 2 === 0) {
        //     return path.split(':')[1];
        //   }
        //   return path;
        // });
        // 此时result中不应该有冒号
        return result;
    }
    convertEventType(change) {
        let eventType = null;
        if (change.type === ModifyType.Add || change.type === ModifyType.AddData || change.type === ModifyType.Insert) {
            // eventType = Expression.EventType.Append;
            // 不处理新增
        }
        else if (change.type === ModifyType.Remove || change.type === ModifyType.RemoveData) {
            // eventType = Expression.EventType.Remove;
        }
        else if (change.type === ModifyType.Load) {
            // eventType = Expression.EventType.Load;
        }
        else if (change.type === ModifyType.ValueChange) {
            //eventType = Expression.EventType.ValueChanged;
            // 不处理值变化
        }
        else if (change.type === ModifyType.Update) {
            eventType = Expression.EventType.Update;
        }
        return eventType;
    }
}
export { RepositoryChangeListener };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3NpdG9yeV9jaGFuZ2VfbGlzdGVuZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZXhwcmVzc2lvbi9saXN0ZW5lci9yZXBvc2l0b3J5X2NoYW5nZV9saXN0ZW5lci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWdCLFVBQVUsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBR2pFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFakQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUkxQyxNQUFNLFNBQVMsR0FBRyxVQUFVLENBQUMsU0FBUyxDQUFDO0FBRXZDLE1BQU0sd0JBQXlCLFNBQVEsY0FBYztJQVFuRCxZQUFvQixnQkFBa0M7UUFDcEQsS0FBSyxFQUFFLENBQUM7UUFEVSxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBR3BELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3JFLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQztRQUNuRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUM7UUFDckQsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFTyxhQUFhO1FBQ25CLElBQUksSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRTtZQUM5QyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFvQixFQUFFLEVBQUU7Z0JBQ3pELElBQUksU0FB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QUFJLEtBQUssVUFBVSxDQUFDLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxPQUFPLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsTUFBTSxFQUFFO1lBQzdHLDJDQUEyQztZQUMzQyxRQUFRO1NBQ1Q7YUFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxVQUFVLEVBQUU7WUFDckYsMkNBQTJDO1NBQzVDO2FBQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxJQUFJLEVBQUU7WUFDMUMseUNBQXlDO1NBQzFDO2FBQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxXQUFXLEVBQUU7WUFDakQsZ0RBQWdEO1lBQ2hELFNBQVM7U0FDVjthQUFNLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsTUFBTSxFQUFFO1lBQzVDLFNBQVMsR0FBRyxVQUFVLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQTtTQUN4QztRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7Q0FDRjtBQUVELE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTW9kaWZpY2F0aW9uLCBNb2RpZnlUeXBlIH0gZnJvbSAnLi4vLi4vY2hhbmdlc2V0L2luZGV4JztcbmltcG9ydCB7IEVudGl0eSB9IGZyb20gJy4uLy4uL2VudGl0eS9pbmRleCc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAnLi4vLi4vcmVwb3NpdG9yeS9pbmRleCc7XG5pbXBvcnQgeyBDaGFuZ2VMaXN0ZW5lciB9IGZyb20gJy4vY2hhbmdlX2xpc3RlbmVyJztcbmltcG9ydCB7IEV4cHJlc3Npb24gfSBmcm9tICcuLi9leHByZXNzaW9uL2luZGV4JztcbmltcG9ydCB7IEJpbmRpbmdEYXRhIH0gZnJvbSAnLi4vLi4vYmluZGluZy1kYXRhL2luZGV4JztcbmltcG9ydCB7IE5BTUVTUEFDRSB9IGZyb20gJy4uL2NvcmUvaW5kZXgnO1xuaW1wb3J0IHsgVmlld01vZGVsQ29udGV4dCB9IGZyb20gJy4uLy4uL3ZpZXctbW9kZWwvaW5kZXgnO1xuXG50eXBlIEV2ZW50QXJncyA9IEV4cHJlc3Npb24uRXZlbnRBcmdzO1xuY29uc3QgRXZlbnRUeXBlID0gRXhwcmVzc2lvbi5FdmVudFR5cGU7XG5cbmNsYXNzIFJlcG9zaXRvcnlDaGFuZ2VMaXN0ZW5lciBleHRlbmRzIENoYW5nZUxpc3RlbmVyIHtcblxuICBwcml2YXRlIG5hbWVzcGFjZTogc3RyaW5nO1xuXG4gIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxFbnRpdHk+O1xuXG4gIHByaXZhdGUgYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgdmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dCkge1xuICAgIHN1cGVyKCk7XG4gICAgXG4gICAgdGhpcy5uYW1lc3BhY2UgPSB0aGlzLnZpZXdNb2RlbENvbnRleHQuaW5qZWN0b3IuZ2V0KE5BTUVTUEFDRSwgbnVsbCk7XG4gICAgdGhpcy5yZXBvc2l0b3J5ID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LnJlcG9zaXRvcnk7XG4gICAgdGhpcy5iaW5kaW5nRGF0YSA9IHRoaXMudmlld01vZGVsQ29udGV4dC5iaW5kaW5nRGF0YTtcbiAgICB0aGlzLnJlZ2lzdGVyRXZlbnQoKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVnaXN0ZXJFdmVudCgpIHtcbiAgICBpZiAodGhpcy5yZXBvc2l0b3J5ICYmIHRoaXMucmVwb3NpdG9yeS5jaGFuZ2VzKSB7XG4gICAgICB0aGlzLnJlcG9zaXRvcnkuY2hhbmdlcy5zdWJzY3JpYmUoKGNoYW5nZTogTW9kaWZpY2F0aW9uKSA9PiB7XG4gICAgICAgIGxldCBldmVudFR5cGUgPSB0aGlzLmNvbnZlcnRFdmVudFR5cGUoY2hhbmdlKTtcbiAgICAgICAgaWYgKCFldmVudFR5cGUpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuYnVpbGRFdmVudFBhdGgoY2hhbmdlKTtcbiAgICAgICAgY29uc3QgbW9kaWZpY2F0aW9uOiBFdmVudEFyZ3MgPSB7XG4gICAgICAgICAgbnM6IHRoaXMubmFtZXNwYWNlLFxuICAgICAgICAgIHR5cGU6IGV2ZW50VHlwZSxcbiAgICAgICAgICBwYXRoOiBwYXRoLFxuICAgICAgICAgIHZhbHVlOiBjaGFuZ2UudmFsdWUsXG4gICAgICAgICAgc291cmNlOiBFeHByZXNzaW9uLkV2ZW50U291cmNlLkZpZWxkLFxuICAgICAgICB9O1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhcIlJlcG9zaXRvcnlDaGFuZ2VMaXN0ZW5lclwiLCBtb2RpZmljYXRpb24pO1xuICAgICAgICB0aGlzLnN1YmplY3QubmV4dChtb2RpZmljYXRpb24pO1xuICAgICAgfSk7XG4gICAgfVxuICAgIC8vIHJlcG9zaXRvcnnlj6rnm5HlkKzlgLzlj5jljJbkuovku7ZcbiAgICBpZiAodGhpcy5yZXBvc2l0b3J5ICYmIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uQ2hhbmdlKSB7XG4gICAgICB0aGlzLnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbkNoYW5nZS5zdWJzY3JpYmUoKGNoYW5nZTogTW9kaWZpY2F0aW9uKSA9PiB7XG4gICAgICAgIGxldCBldmVudFR5cGUgPSB0aGlzLmNvbnZlcnRFdmVudFR5cGUoY2hhbmdlKTtcbiAgICAgICAgaWYgKCFldmVudFR5cGUpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuYnVpbGRFdmVudFBhdGgoY2hhbmdlKTtcbiAgICAgICAgY29uc3QgbW9kaWZpY2F0aW9uOiBFdmVudEFyZ3MgPSB7XG4gICAgICAgICAgbnM6IHRoaXMubmFtZXNwYWNlLFxuICAgICAgICAgIHR5cGU6IGV2ZW50VHlwZSxcbiAgICAgICAgICBwYXRoOiBwYXRoLFxuICAgICAgICAgIHZhbHVlOiBjaGFuZ2UudmFsdWUsXG4gICAgICAgICAgc291cmNlOiBFeHByZXNzaW9uLkV2ZW50U291cmNlLlJlcG9zaXRvcnksXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuc3ViamVjdC5uZXh0KG1vZGlmaWNhdGlvbik7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog5p6E5bu65LqL5Lu26Lev5b6E5Y+C5pWwXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxuICAgKiBAZGVzY3JpcHRpb24g5p6E5bu65a6M5LmL5ZCO55qE6Lev5b6E57G75Ly8W2lkLHByb3BdIG9yIFtpZCzku47ooajlkI1zLOS7juihqOW9k+WJjeihjGlkLOS7juihqOWxnuaAp10gb3IgW2lkLHVkdCx1ZHRfcHJvcF1cbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgYnVpbGRFdmVudFBhdGgoZXZlbnQ6IE1vZGlmaWNhdGlvbik6IHN0cmluZ1tdIHtcbiAgICBjb25zdCBwYXRocyA9IGV2ZW50LnBhdGg7XG4gICAgbGV0IHJlc3VsdCA9IFtdO1xuICAgIGlmICghcGF0aHMgfHwgcGF0aHMubGVuZ3RoIDwgMSkge1xuICAgICAgLy8g5Li76KGo5paw5aKe5pe2cGF0aOS4uuepulxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gICAgLy8g6L+H5ruk5o6JdWR055qE5YaS5Y+377yM5YWz6IGU5a2X5q6155qEaWRcbiAgICByZXN1bHQgPSBwYXRocy5maWx0ZXIoKHBhdGg6IHN0cmluZywgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgaWYgKGluZGV4ICUgMiA9PT0gMCAmJiBwYXRoLmluY2x1ZGVzKCc6JykpIHtcbiAgICAgICAgaWYgKHBhdGggPT09ICc6Jykge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBwcmltYXJ5S2V5ID0gcGF0aC5zcGxpdCgnOicpWzBdO1xuICAgICAgICBpZiAocHJpbWFyeUtleSAhPT0gdGhpcy5yZXBvc2l0b3J5LnByaW1hcnlLZXkpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0pO1xuICAgIC8vIOenu+mZpOi3r+W+hOS4reeahGlk5a2X56ym5LiyXG4gICAgLy8gcmVzdWx0ID0gcGF0aHMubWFwKChwYXRoOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAvLyAgIGlmIChwYXRoLmluY2x1ZGVzKCc6JykgJiYgaW5kZXggJSAyID09PSAwKSB7XG4gICAgLy8gICAgIHJldHVybiBwYXRoLnNwbGl0KCc6JylbMV07XG4gICAgLy8gICB9XG4gICAgLy8gICByZXR1cm4gcGF0aDtcbiAgICAvLyB9KTtcbiAgICAvLyDmraTml7ZyZXN1bHTkuK3kuI3lupTor6XmnInlhpLlj7dcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0RXZlbnRUeXBlKGNoYW5nZTogTW9kaWZpY2F0aW9uKTogRXhwcmVzc2lvbi5FdmVudFR5cGUge1xuICAgIGxldCBldmVudFR5cGUgPSBudWxsO1xuICAgIGlmIChjaGFuZ2UudHlwZSA9PT0gTW9kaWZ5VHlwZS5BZGQgfHwgY2hhbmdlLnR5cGUgPT09IE1vZGlmeVR5cGUuQWRkRGF0YSB8fCBjaGFuZ2UudHlwZSA9PT0gTW9kaWZ5VHlwZS5JbnNlcnQpIHtcbiAgICAgIC8vIGV2ZW50VHlwZSA9IEV4cHJlc3Npb24uRXZlbnRUeXBlLkFwcGVuZDtcbiAgICAgIC8vIOS4jeWkhOeQhuaWsOWinlxuICAgIH0gZWxzZSBpZiAoY2hhbmdlLnR5cGUgPT09IE1vZGlmeVR5cGUuUmVtb3ZlIHx8IGNoYW5nZS50eXBlID09PSBNb2RpZnlUeXBlLlJlbW92ZURhdGEpIHtcbiAgICAgIC8vIGV2ZW50VHlwZSA9IEV4cHJlc3Npb24uRXZlbnRUeXBlLlJlbW92ZTtcbiAgICB9IGVsc2UgaWYgKGNoYW5nZS50eXBlID09PSBNb2RpZnlUeXBlLkxvYWQpIHtcbiAgICAgIC8vIGV2ZW50VHlwZSA9IEV4cHJlc3Npb24uRXZlbnRUeXBlLkxvYWQ7XG4gICAgfSBlbHNlIGlmIChjaGFuZ2UudHlwZSA9PT0gTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZSkge1xuICAgICAgLy9ldmVudFR5cGUgPSBFeHByZXNzaW9uLkV2ZW50VHlwZS5WYWx1ZUNoYW5nZWQ7XG4gICAgICAvLyDkuI3lpITnkIblgLzlj5jljJZcbiAgICB9IGVsc2UgaWYgKGNoYW5nZS50eXBlID09PSBNb2RpZnlUeXBlLlVwZGF0ZSkge1xuICAgICAgZXZlbnRUeXBlID0gRXhwcmVzc2lvbi5FdmVudFR5cGUuVXBkYXRlXG4gICAgfVxuICAgIHJldHVybiBldmVudFR5cGU7XG4gIH1cbn1cblxuZXhwb3J0IHsgUmVwb3NpdG9yeUNoYW5nZUxpc3RlbmVyIH0iXX0=