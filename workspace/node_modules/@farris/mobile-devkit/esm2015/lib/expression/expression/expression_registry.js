import { of } from "rxjs";
import { catchError, switchMap } from "rxjs/operators";
import { TranslateToken } from "../../i18n/index";
import { FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN } from "../manifest/index";
import { Expression } from './types';
import { AppContext } from '../../app';
export class ExpressionRegistry {
    constructor(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this._expressions = null;
        this.injector = this.viewModelContext.injector;
        this.formExpressionManifestService = this.injector.get(FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN, null);
        this.translate = this.injector.get(TranslateToken, null);
    }
    /**
     * 加载表达式文件
     */
    load() {
        return this.formExpressionManifestService.load().pipe(switchMap((describe) => {
            const expressions = this.setExpressions(describe);
            this.cleanSpecialCharacters();
            return of(expressions);
        }), catchError((e) => {
            return of([]);
        }));
    }
    setExpressions(describe) {
        const expressions = [];
        const exprs = Array.from(describe);
        const appContext = this.viewModelContext.injector.get(AppContext);
        exprs.forEach((expr) => {
            expr.expressions.forEach((expression) => {
                const expressionObject = {
                    id: expression.id,
                    ns: expr.ns,
                    viewModelId: expr.viewModelId,
                    path: expr.path,
                    bindingType: expr.type,
                    type: expression.type,
                    expression: expression.value || expression.expr || '',
                    message: expression.message || null,
                    messageType: expression.messageType || null,
                    deps: []
                };
                if (expression.type === Expression.ExpressionType.Required) {
                    const b = { type: "requiredExpression", constraints: [expression.id], message: expression.message };
                    appContext.validationManager[expr.path] = Object.assign({}, (appContext.validationManager[expr.path] || {}), { [expression.id]: b });
                }
                if (expression.type === Expression.ExpressionType.Validate) {
                    const b = { type: "expression", constraints: [expression.id], message: expression.message };
                    appContext.validationManager[expr.path] = Object.assign({}, (appContext.validationManager[expr.path] || {}), { [expression.id]: b });
                }
                if ((expression.type === Expression.ExpressionType.Required || expression.type === Expression.ExpressionType.Validate)) {
                    if (!expression.message) {
                        expressionObject.message = this.getExpressionMessage(expression.type);
                    }
                    if (!expression.messageType) {
                        expressionObject.messageType = 'error';
                    }
                }
                if (expressionObject.message) {
                    this.transform(expressionObject);
                }
                expressions.push(expressionObject);
            });
        });
        this._expressions = expressions;
        return expressions;
    }
    /**
     * 获取所有表达式
     */
    get expressions() {
        if (this._expressions) {
            return of(this._expressions);
        }
        // 短路，实现功能
        if (window['__expressions__']) {
            this.setExpressions(window['__expressions__']);
            return of(this._expressions);
        }
        return this.load();
    }
    /**
     * 根据表达式id获取对应的表达式对象
     * @param id 表达式id
     * @returns
     */
    getExpressionById(id) {
        if (!this._expressions || this._expressions.length < 1) {
            return null;
        }
        return this._expressions.find((expressionObject) => expressionObject.id === id);
    }
    getExpressionMessage(expressionType, defaultValue) {
        if (!(expressionType === Expression.ExpressionType.Validate || expressionType === Expression.ExpressionType.Required)) {
            return null;
        }
        if (!this.translate) {
            return defaultValue;
        }
        const currentLanguage = this.translate.getCurrentLanguage() || 'zh-CHS';
        return Expression.MESSAGE[currentLanguage][expressionType];
    }
    transform(expressionObject) {
        if (!this.translate) {
            return;
        }
        if (expressionObject.message && expressionObject.message.startsWith('{{') && expressionObject.message.endsWith('}}')) {
            expressionObject.message = this.translate.transform(expressionObject.message.substr(2, expressionObject.message.length - 4), null) || this.getExpressionMessage(expressionObject.type);
        }
    }
    cleanSpecialCharacters() {
        if (!this._expressions || this._expressions.length < 1 || !Array.isArray(this._expressions)) {
            return;
        }
        const repository = this.viewModelContext.repository;
        if (!repository) {
            return;
        }
        const entityTypeInfo = repository.entityTypeInfo;
        const regex = new RegExp(`[\\'\\"]?\\s*(${entityTypeInfo.entityInfo.nodeCode}|${entityTypeInfo.entityInfo.originalCode})[\\.\\[\\]a-zA-Z0-9_]+\\s*[\\'\\"]?`, 'g');
        this._expressions.forEach((expressionObject) => {
            const expr = expressionObject.expression;
            const entityPropertyExpressions = expr.match(regex);
            if (Array.isArray(entityPropertyExpressions) && entityPropertyExpressions.length > 0) {
                // 解析出所有实体相关的字符串，以主实体名字开头，包含主实体属性或子表
                entityPropertyExpressions.forEach((item) => {
                    if (item.indexOf('.') === -1) {
                        console.warn(`无效的实体表达式:${item}`);
                        return;
                    }
                    // 去数组
                    if (/\[\d\]/g.test(item)) {
                        const replacer = item.replace(/\[\d\]/g, '');
                        expressionObject.expression = this.replaceAll(expressionObject.expression, item, replacer);
                    }
                    // 去星号
                    if (/\*/g.test(item)) {
                        const replacer = item.replace(/\*/g, '');
                        expressionObject.expression = this.replaceAll(expressionObject.expression, item, replacer);
                    }
                });
            }
        });
    }
    replaceAll(originalValue, search, replacer) {
        return originalValue.split(search).join(replacer);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl9yZWdpc3RyeS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9leHByZXNzaW9uL2V4cHJlc3Npb24vZXhwcmVzc2lvbl9yZWdpc3RyeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkQsT0FBTyxFQUFhLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRzdELE9BQU8sRUFBRSxzQ0FBc0MsRUFBa0MsTUFBTSxtQkFBbUIsQ0FBQztBQUMzRyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxXQUFXLENBQUE7QUFFdEMsTUFBTSxPQUFPLGtCQUFrQjtJQVU3QixZQUFvQixnQkFBa0M7UUFBbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQU45QyxpQkFBWSxHQUFrQyxJQUFJLENBQUM7UUFRekQsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDO1FBQy9DLElBQUksQ0FBQyw2QkFBNkIsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxzQ0FBc0MsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNyRyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRUQ7O09BRUc7SUFDSSxJQUFJO1FBQ1QsT0FBTyxJQUFJLENBQUMsNkJBQTZCLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUNuRCxTQUFTLENBQUMsQ0FBQyxRQUFvQixFQUFFLEVBQUU7WUFDakMsTUFBTSxXQUFX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QUFTLEVBQUUsRUFBRSxDQUFDLENBQUM7d0JBQzdDLGdCQUFnQixDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7cUJBQzVGO29CQUNELE1BQU07b0JBQ04sSUFBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFDO3dCQUNsQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQzt3QkFDekMsZ0JBQWdCLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztxQkFDNUY7Z0JBQ0gsQ0FBQyxDQUFDLENBQUM7YUFDSjtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNPLFVBQVUsQ0FBQyxhQUFxQixFQUFFLE1BQWMsRUFBRSxRQUFnQjtRQUN4RSxPQUFPLGFBQWEsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3BELENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdG9yIH0gZnJvbSBcIi4uLy4uL2NvcmUvaW5kZXhcIjtcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSBcInJ4anNcIjtcbmltcG9ydCB7IGNhdGNoRXJyb3IsIHN3aXRjaE1hcCB9IGZyb20gXCJyeGpzL29wZXJhdG9yc1wiO1xuaW1wb3J0IHsgVHJhbnNsYXRlLCBUcmFuc2xhdGVUb2tlbiB9IGZyb20gXCIuLi8uLi9pMThuL2luZGV4XCI7XG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAnLi4vLi4vcmVwb3NpdG9yeS9pbmRleCc7XG5pbXBvcnQgeyBWaWV3TW9kZWxDb250ZXh0LCBWaWV3TW9kZWwgfSBmcm9tIFwiLi4vLi4vdmlldy1tb2RlbC9pbmRleFwiO1xuaW1wb3J0IHsgRk9STV9FWFBSRVNTSU9OX01BTklGRVNUX1NFUlZJQ0VfVE9LRU4sIElGb3JtRXhwcmVzc2lvbk1hbmlmZXN0U2VydmljZSB9IGZyb20gXCIuLi9tYW5pZmVzdC9pbmRleFwiO1xuaW1wb3J0IHsgRXhwcmVzc2lvbiB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgQXBwQ29udGV4dCB9IGZyb20gJy4uLy4uL2FwcCdcbmltcG9ydCB7IFZhbGlkYXRvckZhY3RvcnkgfSBmcm9tICcuLi8uLi92YWxpZGF0b3InXG5leHBvcnQgY2xhc3MgRXhwcmVzc2lvblJlZ2lzdHJ5IHtcblxuICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcjtcblxuICBwcml2YXRlIF9leHByZXNzaW9uczogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0W10gPSBudWxsO1xuXG4gIHByaXZhdGUgZm9ybUV4cHJlc3Npb25NYW5pZmVzdFNlcnZpY2U6IElGb3JtRXhwcmVzc2lvbk1hbmlmZXN0U2VydmljZTtcblxuICBwcml2YXRlIHRyYW5zbGF0ZTogVHJhbnNsYXRlO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgdmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dCkge1xuXG4gICAgdGhpcy5pbmplY3RvciA9IHRoaXMudmlld01vZGVsQ29udGV4dC5pbmplY3RvcjtcbiAgICB0aGlzLmZvcm1FeHByZXNzaW9uTWFuaWZlc3RTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQoRk9STV9FWFBSRVNTSU9OX01BTklGRVNUX1NFUlZJQ0VfVE9LRU4sIG51bGwpO1xuICAgIHRoaXMudHJhbnNsYXRlID0gdGhpcy5pbmplY3Rvci5nZXQoVHJhbnNsYXRlVG9rZW4sIG51bGwpO1xuICB9XG5cbiAgLyoqXG4gICAqIOWKoOi9veihqOi+vuW8j+aWh+S7tlxuICAgKi9cbiAgcHVibGljIGxvYWQoKTogT2JzZXJ2YWJsZTxFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3RbXT4ge1xuICAgIHJldHVybiB0aGlzLmZvcm1FeHByZXNzaW9uTWFuaWZlc3RTZXJ2aWNlLmxvYWQoKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKChkZXNjcmliZTogQXJyYXk8YW55PikgPT4ge1xuICAgICAgICBjb25zdCBleHByZXNzaW9ucyA9IHRoaXMuc2V0RXhwcmVzc2lvbnMoZGVzY3JpYmUpO1xuXHR0aGlzLmNsZWFuU3BlY2lhbENoYXJhY3RlcnMoKTtcbiAgICAgICAgcmV0dXJuIG9mKGV4cHJlc3Npb25zKTtcbiAgICAgIH0pLFxuICAgICAgY2F0Y2hFcnJvcigoZSkgPT4ge1xuICAgICAgICByZXR1cm4gb2YoW10pO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHNldEV4cHJlc3Npb25zKGRlc2NyaWJlKSB7XG4gICAgY29uc3QgZXhwcmVzc2lvbnM6IEFycmF5PEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdD4gPSBbXTtcbiAgICBjb25zdCBleHBycyA9IEFycmF5LmZyb20oZGVzY3JpYmUpO1xuICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLnZpZXdNb2RlbENvbnRleHQuaW5qZWN0b3IuZ2V0PEFwcENvbnRleHQ+KEFwcENvbnRleHQpO1xuICAgIGV4cHJzLmZvckVhY2goKGV4cHI6IGFueSkgPT4ge1xuICAgICAgZXhwci5leHByZXNzaW9ucy5mb3JFYWNoKChleHByZXNzaW9uOiBhbnkpID0+IHtcbiAgICAgICAgY29uc3QgZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0ID0ge1xuICAgICAgICAgIGlkOiBleHByZXNzaW9uLmlkLFxuICAgICAgICAgIG5zOiBleHByLm5zLFxuICAgICAgICAgIHZpZXdNb2RlbElkOiBleHByLnZpZXdNb2RlbElkLFxuICAgICAgICAgIHBhdGg6IGV4cHIucGF0aCxcbiAgICAgICAgICBiaW5kaW5nVHlwZTogZXhwci50eXBlLFxuICAgICAgICAgIHR5cGU6IGV4cHJlc3Npb24udHlwZSxcbiAgICAgICAgICBleHByZXNzaW9uOiBleHByZXNzaW9uLnZhbHVlIHx8IGV4cHJlc3Npb24uZXhwciB8fCAnJyxcbiAgICAgICAgICBtZXNzYWdlOiBleHByZXNzaW9uLm1lc3NhZ2UgfHwgbnVsbCxcbiAgICAgICAgICBtZXNzYWdlVHlwZTogZXhwcmVzc2lvbi5tZXNzYWdlVHlwZSB8fCBudWxsLFxuICAgICAgICAgIGRlcHM6IFtdXG4gICAgICAgIH07XG4gICAgICAgIGlmIChleHByZXNzaW9uLnR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuUmVxdWlyZWQpIHtcbiAgICAgICAgICBjb25zdCBiID0geyB0eXBlOiBcInJlcXVpcmVkRXhwcmVzc2lvblwiLCBjb25zdHJhaW50czogW2V4cHJlc3Npb24uaWRdLCBtZXNzYWdlOiBleHByZXNzaW9uLm1lc3NhZ2UgfVxuICAgICAgICAgIGFwcENvbnRleHQudmFsaWRhdGlvbk1hbmFnZXJbZXhwci5wYXRoXSA9IHsgLi4uKGFwcENvbnRleHQudmFsaWRhdGlvbk1hbmFnZXJbZXhwci5wYXRoXSB8fCB7fSksIFtleHByZXNzaW9uLmlkXTogYiB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGV4cHJlc3Npb24udHlwZSA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5WYWxpZGF0ZSkge1xuICAgICAgICAgIGNvbnN0IGIgPSB7IHR5cGU6IFwiZXhwcmVzc2lvblwiLCBjb25zdHJhaW50czogW2V4cHJlc3Npb24uaWRdLCBtZXNzYWdlOiBleHByZXNzaW9uLm1lc3NhZ2UgfVxuICAgICAgICAgIGFwcENvbnRleHQudmFsaWRhdGlvbk1hbmFnZXJbZXhwci5wYXRoXSA9IHsgLi4uKGFwcENvbnRleHQudmFsaWRhdGlvbk1hbmFnZXJbZXhwci5wYXRoXSB8fCB7fSksIFtleHByZXNzaW9uLmlkXTogYiB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKChleHByZXNzaW9uLnR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuUmVxdWlyZWQgfHwgZXhwcmVzc2lvbi50eXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLlZhbGlkYXRlKSkge1xuICAgICAgICAgIGlmICghZXhwcmVzc2lvbi5tZXNzYWdlKSB7XG4gICAgICAgICAgICBleHByZXNzaW9uT2JqZWN0Lm1lc3NhZ2UgPSB0aGlzLmdldEV4cHJlc3Npb25NZXNzYWdlKGV4cHJlc3Npb24udHlwZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghZXhwcmVzc2lvbi5tZXNzYWdlVHlwZSkge1xuICAgICAgICAgICAgZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlVHlwZSA9ICdlcnJvcic7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChleHByZXNzaW9uT2JqZWN0Lm1lc3NhZ2UpIHtcbiAgICAgICAgICB0aGlzLnRyYW5zZm9ybShleHByZXNzaW9uT2JqZWN0KTtcbiAgICAgICAgfVxuICAgICAgICBleHByZXNzaW9ucy5wdXNoKGV4cHJlc3Npb25PYmplY3QpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICB0aGlzLl9leHByZXNzaW9ucyA9IGV4cHJlc3Npb25zO1xuICAgIHJldHVybiBleHByZXNzaW9ucztcbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5bmiYDmnInooajovr7lvI9cbiAgICovXG4gIHB1YmxpYyBnZXQgZXhwcmVzc2lvbnMoKTogT2JzZXJ2YWJsZTxFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3RbXT4ge1xuICAgIGlmICh0aGlzLl9leHByZXNzaW9ucykge1xuICAgICAgcmV0dXJuIG9mKHRoaXMuX2V4cHJlc3Npb25zKTtcbiAgICB9XG5cbiAgICAvLyDnn63ot6/vvIzlrp7njrDlip/og71cbiAgICBpZiAod2luZG93WydfX2V4cHJlc3Npb25zX18nXSkge1xuICAgICAgdGhpcy5zZXRFeHByZXNzaW9ucyh3aW5kb3dbJ19fZXhwcmVzc2lvbnNfXyddKTtcbiAgICAgIHJldHVybiBvZih0aGlzLl9leHByZXNzaW9ucyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMubG9hZCgpO1xuICB9XG4gIC8qKlxuICAgKiDmoLnmja7ooajovr7lvI9pZOiOt+WPluWvueW6lOeahOihqOi+vuW8j+WvueixoVxuICAgKiBAcGFyYW0gaWQg6KGo6L6+5byPaWRcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgZ2V0RXhwcmVzc2lvbkJ5SWQoaWQ6IHN0cmluZyk6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCB7XG4gICAgaWYgKCF0aGlzLl9leHByZXNzaW9ucyB8fCB0aGlzLl9leHByZXNzaW9ucy5sZW5ndGggPCAxKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2V4cHJlc3Npb25zLmZpbmQoKGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkgPT4gZXhwcmVzc2lvbk9iamVjdC5pZCA9PT0gaWQpO1xuICB9XG4gIHByaXZhdGUgZ2V0RXhwcmVzc2lvbk1lc3NhZ2UoZXhwcmVzc2lvblR5cGU6IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUsIGRlZmF1bHRWYWx1ZT86IHN0cmluZykge1xuICAgIGlmICghKGV4cHJlc3Npb25UeXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLlZhbGlkYXRlIHx8IGV4cHJlc3Npb25UeXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLlJlcXVpcmVkKSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGlmICghdGhpcy50cmFuc2xhdGUpIHtcbiAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7XG4gICAgfVxuICAgIGNvbnN0IGN1cnJlbnRMYW5ndWFnZSA9IHRoaXMudHJhbnNsYXRlLmdldEN1cnJlbnRMYW5ndWFnZSgpIHx8ICd6aC1DSFMnO1xuICAgIHJldHVybiBFeHByZXNzaW9uLk1FU1NBR0VbY3VycmVudExhbmd1YWdlXVtleHByZXNzaW9uVHlwZV07XG4gIH1cbiAgcHJpdmF0ZSB0cmFuc2Zvcm0oZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KSB7XG4gICAgaWYgKCF0aGlzLnRyYW5zbGF0ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlICYmIGV4cHJlc3Npb25PYmplY3QubWVzc2FnZS5zdGFydHNXaXRoKCd7eycpICYmIGV4cHJlc3Npb25PYmplY3QubWVzc2FnZS5lbmRzV2l0aCgnfX0nKSkge1xuICAgICAgZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlID0gdGhpcy50cmFuc2xhdGUudHJhbnNmb3JtKGV4cHJlc3Npb25PYmplY3QubWVzc2FnZS5zdWJzdHIoMiwgZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlLmxlbmd0aCAtIDQpLCBudWxsKSB8fCB0aGlzLmdldEV4cHJlc3Npb25NZXNzYWdlKGV4cHJlc3Npb25PYmplY3QudHlwZSk7XG4gICAgfVxuICB9XG4gIHByaXZhdGUgY2xlYW5TcGVjaWFsQ2hhcmFjdGVycygpIHtcbiAgICBpZiAoIXRoaXMuX2V4cHJlc3Npb25zIHx8IHRoaXMuX2V4cHJlc3Npb25zLmxlbmd0aCA8IDEgfHwgIUFycmF5LmlzQXJyYXkodGhpcy5fZXhwcmVzc2lvbnMpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55PiA9IHRoaXMudmlld01vZGVsQ29udGV4dC5yZXBvc2l0b3J5O1xuICAgIGlmICghcmVwb3NpdG9yeSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBlbnRpdHlUeXBlSW5mbyA9IHJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm87XG4gICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKGBbXFxcXCdcXFxcXCJdP1xcXFxzKigke2VudGl0eVR5cGVJbmZvLmVudGl0eUluZm8ubm9kZUNvZGV9fCR7ZW50aXR5VHlwZUluZm8uZW50aXR5SW5mby5vcmlnaW5hbENvZGV9KVtcXFxcLlxcXFxbXFxcXF1hLXpBLVowLTlfXStcXFxccypbXFxcXCdcXFxcXCJdP2AsICdnJyk7XG4gICAgdGhpcy5fZXhwcmVzc2lvbnMuZm9yRWFjaCgoZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KSA9PiB7XG4gICAgICBjb25zdCBleHByID0gZXhwcmVzc2lvbk9iamVjdC5leHByZXNzaW9uO1xuICAgICAgY29uc3QgZW50aXR5UHJvcGVydHlFeHByZXNzaW9uczogUmVnRXhwTWF0Y2hBcnJheSA9IGV4cHIubWF0Y2gocmVnZXgpO1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZW50aXR5UHJvcGVydHlFeHByZXNzaW9ucykgJiYgZW50aXR5UHJvcGVydHlFeHByZXNzaW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgIC8vIOino+aekOWHuuaJgOacieWunuS9k+ebuOWFs+eahOWtl+espuS4su+8jOS7peS4u+WunuS9k+WQjeWtl+W8gOWktO+8jOWMheWQq+S4u+WunuS9k+WxnuaAp+aIluWtkOihqFxuICAgICAgICBlbnRpdHlQcm9wZXJ0eUV4cHJlc3Npb25zLmZvckVhY2goKGl0ZW06IHN0cmluZykgPT4ge1xuICAgICAgICAgIGlmIChpdGVtLmluZGV4T2YoJy4nKSA9PT0gLTEpIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2Fybihg5peg5pWI55qE5a6e5L2T6KGo6L6+5byPOiR7aXRlbX1gKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8g5Y675pWw57uEXG4gICAgICAgICAgaWYgKC9cXFtcXGRcXF0vZy50ZXN0KGl0ZW0pKSB7XG4gICAgICAgICAgICBjb25zdCByZXBsYWNlciA9IGl0ZW0ucmVwbGFjZSgvXFxbXFxkXFxdL2csICcnKTtcbiAgICAgICAgICAgIGV4cHJlc3Npb25PYmplY3QuZXhwcmVzc2lvbiA9IHRoaXMucmVwbGFjZUFsbChleHByZXNzaW9uT2JqZWN0LmV4cHJlc3Npb24sIGl0ZW0sIHJlcGxhY2VyKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8g5Y675pif5Y+3XG4gICAgICAgICAgaWYoL1xcKi9nLnRlc3QoaXRlbSkpe1xuICAgICAgICAgICAgY29uc3QgcmVwbGFjZXIgPSBpdGVtLnJlcGxhY2UoL1xcKi9nLCAnJyk7XG4gICAgICAgICAgICBleHByZXNzaW9uT2JqZWN0LmV4cHJlc3Npb24gPSB0aGlzLnJlcGxhY2VBbGwoZXhwcmVzc2lvbk9iamVjdC5leHByZXNzaW9uLCBpdGVtLCByZXBsYWNlcik7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuICBwcml2YXRlIHJlcGxhY2VBbGwob3JpZ2luYWxWYWx1ZTogc3RyaW5nLCBzZWFyY2g6IHN0cmluZywgcmVwbGFjZXI6IHN0cmluZykge1xuICAgIHJldHVybiBvcmlnaW5hbFZhbHVlLnNwbGl0KHNlYXJjaCkuam9pbihyZXBsYWNlcik7XG4gIH1cbn0iXX0=