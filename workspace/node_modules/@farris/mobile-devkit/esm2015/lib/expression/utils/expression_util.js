import { DataPropGroup } from "../../entity/index";
import { ENTITY_TEMPLATE, GROUP_FUNCTIONS } from "../resolver/index";
export class ExpressionUtil {
    static getGroupFunctionDependency(expr, entityTypeInfo) {
        const deps = [];
        // 获取聚合函数依赖项
        const groupFunctionRegex = new RegExp(`DefaultFunction\\.(${GROUP_FUNCTIONS.join('|')})\\s*\\([^\\r\\n\\)]*\\)`, "g");
        const groupFunctions = expr.match(groupFunctionRegex);
        if (groupFunctions && groupFunctions.length > 0) {
            // todo: 使用正则匹配时可能会因为参数中有逗号导致问题，后续使用ast解析
            const argumentsRegex = /\(([^\r\n\)]*)\)/;
            groupFunctions.forEach((groupFunction) => {
                const argumentMatchResult = groupFunction.match(argumentsRegex);
                if (argumentMatchResult.length === 2) {
                    const argument = argumentMatchResult[1];
                    const args = argument.split(',').map(p => p.replace(/\"/g, ''));
                    if (args && args.length === 2) {
                        let item = args.join('.');
                        item = this.convertToNodeCode(item, entityTypeInfo).join('.');
                        item = item.substr(item.indexOf('.') + 1);
                        const dep = item.split('.');
                        dep.splice(0, 0, ENTITY_TEMPLATE);
                        deps.push(dep.join('/'));
                    }
                    else {
                        throw new Error(`无法解析参数： ${JSON.stringify(argument)}`);
                    }
                }
            });
        }
        return deps;
    }
    /**
     * 将voCode转换为前端nodeCode
     * @param entityExpression like Entity.Child.p1
     * @returns
     */
    static convertToNodeCode(entityExpression, entityTypeInfo) {
        // UserEntity.storys.p1
        const nodeCodes = [];
        if (entityTypeInfo && entityExpression.includes('.')) {
            const entityExpressions = entityExpression.split('.') || [];
            let dataTypeInfo = entityTypeInfo;
            for (let index = 0; index < entityExpressions.length; index++) {
                const prop = entityExpressions[index];
                if (dataTypeInfo && dataTypeInfo.entityInfo && dataTypeInfo.entityInfo.nodeCode === prop || dataTypeInfo.entityInfo.originalCode === prop) {
                    // 第一个是主表code，不能转nodeCode
                    if (index === 0) {
                        nodeCodes.push(dataTypeInfo.entityInfo.originalCode);
                    }
                    else {
                        nodeCodes.push(dataTypeInfo.entityInfo.nodeCode);
                    }
                    // 下一级可能为子表、对象或属性
                    const nextNodeCode = entityExpressions[index + 1];
                    if (!nextNodeCode) {
                        break;
                    }
                    const nextNodeCodePropInfo = dataTypeInfo.getPropInfoByName(nextNodeCode);
                    if (!nextNodeCodePropInfo) {
                        break;
                    }
                    // 下一级为子表或对象
                    if (nextNodeCodePropInfo.typeInfo) {
                        dataTypeInfo = nextNodeCodePropInfo.typeInfo;
                    }
                }
                else if (dataTypeInfo && dataTypeInfo.getPropInfoByName(prop)) {
                    const dataPropInfo = dataTypeInfo.getPropInfoByName(prop);
                    nodeCodes.push(dataPropInfo.name);
                }
                else {
                    //throw new Error(`错误的属性参数 ${entityExpression}`);
                    break;
                }
            }
        }
        return nodeCodes;
    }
    /**
     * 找到元数据中所有实体路径
     * @param dataTypeInfo
     * @param results
     * @param paths
     */
    static getChildrenEntityPaths(dataTypeInfo, results, paths = []) {
        const list = dataTypeInfo.getPropInfosByGroup(DataPropGroup.List);
        if (list && list.length > 0) {
            list.forEach((dataPropInfo) => {
                if (paths.length === 0) {
                    results.push([dataPropInfo.name]);
                }
                const childrens = dataPropInfo.typeInfo.getPropInfosByGroup(DataPropGroup.List);
                if (childrens && childrens.length > 0) {
                    paths.push(dataPropInfo.name);
                    childrens.forEach((dataPropInfo) => {
                        this.getChildrenEntityPaths(dataPropInfo.typeInfo, results, paths);
                    });
                }
                else {
                    if (paths.length !== 0) {
                        paths.push(dataPropInfo.name);
                        results.push([...paths]);
                    }
                    paths.length = 0;
                }
            });
        }
        else {
            if (paths.length > 0) {
                paths.push(dataTypeInfo.entityInfo.nodeCode);
                results.push([...paths]);
            }
            paths.length = 0;
        }
    }
    /**
     * 获取指定绑定路径的当前行数据
     * @param paths 绑定路径
     * @param bindingData
     * @returns
     */
    static getCurrentRowByPaths(paths, bindingData) {
        let result = null;
        const bindingList = bindingData.getValue(paths);
        if (bindingList && bindingList.length > 0) {
            let primaryValue = bindingList.currentItem.primaryKeyValue || null;
            // 使用事件中的主键
            // 主表或下级表新增，此时事件行就是当前行，无需处理
            if (primaryValue) {
                const bindingObject = bindingList.findById(primaryValue);
                if (bindingObject) {
                    result = bindingObject.toJSON();
                }
            }
        }
        return result;
    }
    /**
     * 从实体路径中获取级数最大的从表或从从表
     * @param paths
     * @returns
     */
    static getAvailableChildrenPathsFromEntityPaths(paths, entityTypeInfo) {
        let nodeCodes = [];
        paths = [...paths];
        while (paths.length > 0) {
            const dataPropInfo = entityTypeInfo.getPropInfoByPath(paths);
            if (dataPropInfo.group === 'List') {
                nodeCodes = paths;
                break;
            }
            paths.pop();
        }
        return nodeCodes;
    }
    /**
     * 从路径中获取绑定路径
     * @param paths 路径
     * @param entityTypeInfo entityTypeInfo
     * @returns
     */
    static getBindingPath(paths, entityTypeInfo) {
        paths = this.getEntityPath(paths);
        const entityPaths = this.getAvailableChildrenPathsFromEntityPaths(paths, entityTypeInfo);
        return entityPaths;
    }
    static getEntityPath(path) {
        const paths = path.filter((value, index) => {
            if (index % 2 === 0 && value.includes(':')) {
                return false;
            }
            else {
                return true;
            }
        });
        return paths;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl91dGlsLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2V4cHJlc3Npb24vdXRpbHMvZXhwcmVzc2lvbl91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxhQUFhLEVBQThCLE1BQU0sb0JBQW9CLENBQUM7QUFDL0UsT0FBTyxFQUFFLGVBQWUsRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUVyRSxNQUFNLE9BQU8sY0FBYztJQUNsQixNQUFNLENBQUMsMEJBQTBCLENBQUMsSUFBWSxFQUFFLGNBQTRCO1FBQ2pGLE1BQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNoQixZQUFZO1FBQ1osTUFBTSxrQkFBa0IsR0FBRyxJQUFJLE1BQU0sQ0FBQyxzQkFBc0IsZUFBZSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsMEJBQTBCLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDdEgsTUFBTSxjQUFjLEdBQXFCLElBQUksQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUN4RSxJQUFJLGNBQWMsSUFBSSxjQUFjLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMvQyx5Q0FBeUM7WUFDekMsTUFBTSxjQUFjLEdBQUcsa0JBQWtCLENBQUM7WUFDMUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDLGFBQXFCLEVBQUUsRUFBRTtnQkFDL0MsTUFBTSxtQkFBbUIsR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDO2dCQUNoRSxJQUFJLG1CQUFtQixDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7b0JBQ3BDLE1BQU0sUUFBUSxHQUFHLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUN4QyxNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFB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ZnJvbSBcIi4uLy4uL2JpbmRpbmctZGF0YS9pbmRleFwiO1xuaW1wb3J0IHsgRGF0YVByb3BHcm91cCwgRGF0YVByb3BJbmZvLCBEYXRhVHlwZUluZm8gfSBmcm9tIFwiLi4vLi4vZW50aXR5L2luZGV4XCI7XG5pbXBvcnQgeyBFTlRJVFlfVEVNUExBVEUsIEdST1VQX0ZVTkNUSU9OUyB9IGZyb20gXCIuLi9yZXNvbHZlci9pbmRleFwiO1xuXG5leHBvcnQgY2xhc3MgRXhwcmVzc2lvblV0aWwge1xuICBwdWJsaWMgc3RhdGljIGdldEdyb3VwRnVuY3Rpb25EZXBlbmRlbmN5KGV4cHI6IHN0cmluZywgZW50aXR5VHlwZUluZm86IERhdGFUeXBlSW5mbyk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCBkZXBzID0gW107XG4gICAgLy8g6I635Y+W6IGa5ZCI5Ye95pWw5L6d6LWW6aG5XG4gICAgY29uc3QgZ3JvdXBGdW5jdGlvblJlZ2V4ID0gbmV3IFJlZ0V4cChgRGVmYXVsdEZ1bmN0aW9uXFxcXC4oJHtHUk9VUF9GVU5DVElPTlMuam9pbignfCcpfSlcXFxccypcXFxcKFteXFxcXHJcXFxcblxcXFwpXSpcXFxcKWAsIFwiZ1wiKTtcbiAgICBjb25zdCBncm91cEZ1bmN0aW9uczogUmVnRXhwTWF0Y2hBcnJheSA9IGV4cHIubWF0Y2goZ3JvdXBGdW5jdGlvblJlZ2V4KTtcbiAgICBpZiAoZ3JvdXBGdW5jdGlvbnMgJiYgZ3JvdXBGdW5jdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgLy8gdG9kbzog5L2/55So5q2j5YiZ5Yy56YWN5pe25Y+v6IO95Lya5Zug5Li65Y+C5pWw5Lit5pyJ6YCX5Y+35a+86Ie06Zeu6aKY77yM5ZCO57ut5L2/55SoYXN06Kej5p6QXG4gICAgICBjb25zdCBhcmd1bWVudHNSZWdleCA9IC9cXCgoW15cXHJcXG5cXCldKilcXCkvO1xuICAgICAgZ3JvdXBGdW5jdGlvbnMuZm9yRWFjaCgoZ3JvdXBGdW5jdGlvbjogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IGFyZ3VtZW50TWF0Y2hSZXN1bHQgPSBncm91cEZ1bmN0aW9uLm1hdGNoKGFyZ3VtZW50c1JlZ2V4KTtcbiAgICAgICAgaWYgKGFyZ3VtZW50TWF0Y2hSZXN1bHQubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgY29uc3QgYXJndW1lbnQgPSBhcmd1bWVudE1hdGNoUmVzdWx0WzFdO1xuICAgICAgICAgIGNvbnN0IGFyZ3MgPSBhcmd1bWVudC5zcGxpdCgnLCcpLm1hcChwID0+IHAucmVwbGFjZSgvXFxcIi9nLCAnJykpO1xuICAgICAgICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICBsZXQgaXRlbTogYW55ID0gYXJncy5qb2luKCcuJyk7XG4gICAgICAgICAgICBpdGVtID0gdGhpcy5jb252ZXJ0VG9Ob2RlQ29kZShpdGVtLCBlbnRpdHlUeXBlSW5mbykuam9pbignLicpO1xuICAgICAgICAgICAgaXRlbSA9IGl0ZW0uc3Vic3RyKGl0ZW0uaW5kZXhPZignLicpICsgMSk7XG4gICAgICAgICAgICBjb25zdCBkZXAgPSBpdGVtLnNwbGl0KCcuJyk7XG4gICAgICAgICAgICBkZXAuc3BsaWNlKDAsIDAsIEVOVElUWV9URU1QTEFURSk7XG4gICAgICAgICAgICBkZXBzLnB1c2goZGVwLmpvaW4oJy8nKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihg5peg5rOV6Kej5p6Q5Y+C5pWw77yaICR7SlNPTi5zdHJpbmdpZnkoYXJndW1lbnQpfWApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBkZXBzO1xuICB9XG4gIC8qKlxuICAgKiDlsIZ2b0NvZGXovazmjaLkuLrliY3nq69ub2RlQ29kZVxuICAgKiBAcGFyYW0gZW50aXR5RXhwcmVzc2lvbiBsaWtlIEVudGl0eS5DaGlsZC5wMVxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgY29udmVydFRvTm9kZUNvZGUoZW50aXR5RXhwcmVzc2lvbjogc3RyaW5nLCBlbnRpdHlUeXBlSW5mbzogRGF0YVR5cGVJbmZvKTogc3RyaW5nW10ge1xuICAgIC8vIFVzZXJFbnRpdHkuc3RvcnlzLnAxXG4gICAgY29uc3Qgbm9kZUNvZGVzID0gW107XG4gICAgaWYgKGVudGl0eVR5cGVJbmZvICYmIGVudGl0eUV4cHJlc3Npb24uaW5jbHVkZXMoJy4nKSkge1xuICAgICAgY29uc3QgZW50aXR5RXhwcmVzc2lvbnMgPSBlbnRpdHlFeHByZXNzaW9uLnNwbGl0KCcuJykgfHwgW107XG4gICAgICBsZXQgZGF0YVR5cGVJbmZvID0gZW50aXR5VHlwZUluZm87XG4gICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgZW50aXR5RXhwcmVzc2lvbnMubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgIGNvbnN0IHByb3AgPSBlbnRpdHlFeHByZXNzaW9uc1tpbmRleF07XG4gICAgICAgIGlmIChkYXRhVHlwZUluZm8gJiYgZGF0YVR5cGVJbmZvLmVudGl0eUluZm8gJiYgZGF0YVR5cGVJbmZvLmVudGl0eUluZm8ubm9kZUNvZGUgPT09IHByb3AgfHwgZGF0YVR5cGVJbmZvLmVudGl0eUluZm8ub3JpZ2luYWxDb2RlID09PSBwcm9wKSB7XG4gICAgICAgICAgLy8g56ys5LiA5Liq5piv5Li76KGoY29kZe+8jOS4jeiDvei9rG5vZGVDb2RlXG4gICAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7XG4gICAgICAgICAgICBub2RlQ29kZXMucHVzaChkYXRhVHlwZUluZm8uZW50aXR5SW5mby5vcmlnaW5hbENvZGUpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBub2RlQ29kZXMucHVzaChkYXRhVHlwZUluZm8uZW50aXR5SW5mby5ub2RlQ29kZSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8g5LiL5LiA57qn5Y+v6IO95Li65a2Q6KGo44CB5a+56LGh5oiW5bGe5oCnXG4gICAgICAgICAgY29uc3QgbmV4dE5vZGVDb2RlID0gZW50aXR5RXhwcmVzc2lvbnNbaW5kZXggKyAxXTtcbiAgICAgICAgICBpZiAoIW5leHROb2RlQ29kZSkge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IG5leHROb2RlQ29kZVByb3BJbmZvID0gZGF0YVR5cGVJbmZvLmdldFByb3BJbmZvQnlOYW1lKG5leHROb2RlQ29kZSk7XG4gICAgICAgICAgaWYgKCFuZXh0Tm9kZUNvZGVQcm9wSW5mbykge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIOS4i+S4gOe6p+S4uuWtkOihqOaIluWvueixoVxuICAgICAgICAgIGlmIChuZXh0Tm9kZUNvZGVQcm9wSW5mby50eXBlSW5mbykge1xuICAgICAgICAgICAgZGF0YVR5cGVJbmZvID0gbmV4dE5vZGVDb2RlUHJvcEluZm8udHlwZUluZm87XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGRhdGFUeXBlSW5mbyAmJiBkYXRhVHlwZUluZm8uZ2V0UHJvcEluZm9CeU5hbWUocHJvcCkpIHtcbiAgICAgICAgICBjb25zdCBkYXRhUHJvcEluZm8gPSBkYXRhVHlwZUluZm8uZ2V0UHJvcEluZm9CeU5hbWUocHJvcCk7XG4gICAgICAgICAgbm9kZUNvZGVzLnB1c2goZGF0YVByb3BJbmZvLm5hbWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vdGhyb3cgbmV3IEVycm9yKGDplJnor6/nmoTlsZ7mgKflj4LmlbAgJHtlbnRpdHlFeHByZXNzaW9ufWApO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBub2RlQ29kZXM7XG4gIH1cbiAgLyoqXG4gICAqIOaJvuWIsOWFg+aVsOaNruS4reaJgOacieWunuS9k+i3r+W+hFxuICAgKiBAcGFyYW0gZGF0YVR5cGVJbmZvIFxuICAgKiBAcGFyYW0gcmVzdWx0cyBcbiAgICogQHBhcmFtIHBhdGhzIFxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBnZXRDaGlsZHJlbkVudGl0eVBhdGhzKGRhdGFUeXBlSW5mbzogRGF0YVR5cGVJbmZvLCByZXN1bHRzOiBhbnlbXSwgcGF0aHM6IHN0cmluZ1tdID0gW10pIHtcbiAgICBjb25zdCBsaXN0OiBEYXRhUHJvcEluZm9bXSA9IGRhdGFUeXBlSW5mby5nZXRQcm9wSW5mb3NCeUdyb3VwKERhdGFQcm9wR3JvdXAuTGlzdCk7XG4gICAgaWYgKGxpc3QgJiYgbGlzdC5sZW5ndGggPiAwKSB7XG4gICAgICBsaXN0LmZvckVhY2goKGRhdGFQcm9wSW5mbzogRGF0YVByb3BJbmZvKSA9PiB7XG4gICAgICAgIGlmIChwYXRocy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICByZXN1bHRzLnB1c2goW2RhdGFQcm9wSW5mby5uYW1lXSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY2hpbGRyZW5zOiBEYXRhUHJvcEluZm9bXSA9IGRhdGFQcm9wSW5mby50eXBlSW5mby5nZXRQcm9wSW5mb3NCeUdyb3VwKERhdGFQcm9wR3JvdXAuTGlzdCk7XG4gICAgICAgIGlmIChjaGlsZHJlbnMgJiYgY2hpbGRyZW5zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBwYXRocy5wdXNoKGRhdGFQcm9wSW5mby5uYW1lKTtcbiAgICAgICAgICBjaGlsZHJlbnMuZm9yRWFjaCgoZGF0YVByb3BJbmZvOiBEYXRhUHJvcEluZm8pID0+IHtcbiAgICAgICAgICAgIHRoaXMuZ2V0Q2hpbGRyZW5FbnRpdHlQYXRocyhkYXRhUHJvcEluZm8udHlwZUluZm8sIHJlc3VsdHMsIHBhdGhzKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAocGF0aHMubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgICAgICBwYXRocy5wdXNoKGRhdGFQcm9wSW5mby5uYW1lKTtcbiAgICAgICAgICAgIHJlc3VsdHMucHVzaChbLi4ucGF0aHNdKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcGF0aHMubGVuZ3RoID0gMDtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChwYXRocy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHBhdGhzLnB1c2goZGF0YVR5cGVJbmZvLmVudGl0eUluZm8ubm9kZUNvZGUpO1xuICAgICAgICByZXN1bHRzLnB1c2goWy4uLnBhdGhzXSk7XG4gICAgICB9XG4gICAgICBwYXRocy5sZW5ndGggPSAwO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog6I635Y+W5oyH5a6a57uR5a6a6Lev5b6E55qE5b2T5YmN6KGM5pWw5o2uXG4gICAqIEBwYXJhbSBwYXRocyDnu5Hlrprot6/lvoRcbiAgICogQHBhcmFtIGJpbmRpbmdEYXRhIFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgZ2V0Q3VycmVudFJvd0J5UGF0aHMocGF0aHM6IHN0cmluZ1tdLCBiaW5kaW5nRGF0YTogQmluZGluZ0RhdGEpOiBudWxsIHwgeyBbcHJvcDogc3RyaW5nXTogYW55IH0ge1xuICAgIGxldCByZXN1bHQgPSBudWxsO1xuICAgIGNvbnN0IGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCA9IGJpbmRpbmdEYXRhLmdldFZhbHVlKHBhdGhzKSBhcyBCaW5kaW5nTGlzdDtcbiAgICBpZiAoYmluZGluZ0xpc3QgJiYgYmluZGluZ0xpc3QubGVuZ3RoID4gMCkge1xuICAgICAgbGV0IHByaW1hcnlWYWx1ZSA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZSB8fCBudWxsO1xuICAgICAgLy8g5L2/55So5LqL5Lu25Lit55qE5Li76ZSuXG4gICAgICAvLyDkuLvooajmiJbkuIvnuqfooajmlrDlop7vvIzmraTml7bkuovku7booYzlsLHmmK/lvZPliY3ooYzvvIzml6DpnIDlpITnkIZcbiAgICAgIGlmIChwcmltYXJ5VmFsdWUpIHtcbiAgICAgICAgY29uc3QgYmluZGluZ09iamVjdCA9IGJpbmRpbmdMaXN0LmZpbmRCeUlkKHByaW1hcnlWYWx1ZSk7XG4gICAgICAgIGlmIChiaW5kaW5nT2JqZWN0KSB7XG4gICAgICAgICAgcmVzdWx0ID0gYmluZGluZ09iamVjdC50b0pTT04oKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG4gIC8qKlxuICAgKiDku47lrp7kvZPot6/lvoTkuK3ojrflj5bnuqfmlbDmnIDlpKfnmoTku47ooajmiJbku47ku47ooahcbiAgICogQHBhcmFtIHBhdGhzIFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgZ2V0QXZhaWxhYmxlQ2hpbGRyZW5QYXRoc0Zyb21FbnRpdHlQYXRocyhwYXRoczogc3RyaW5nW10sIGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8pOiBzdHJpbmdbXSB7XG4gICAgbGV0IG5vZGVDb2RlcyA9IFtdO1xuICAgIHBhdGhzID0gWy4uLnBhdGhzXTtcbiAgICB3aGlsZSAocGF0aHMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgZGF0YVByb3BJbmZvID0gZW50aXR5VHlwZUluZm8uZ2V0UHJvcEluZm9CeVBhdGgocGF0aHMpO1xuICAgICAgaWYgKGRhdGFQcm9wSW5mby5ncm91cCA9PT0gJ0xpc3QnKSB7XG4gICAgICAgIG5vZGVDb2RlcyA9IHBhdGhzO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIHBhdGhzLnBvcCgpO1xuICAgIH1cbiAgICByZXR1cm4gbm9kZUNvZGVzO1xuICB9XG4gIC8qKlxuICAgKiDku47ot6/lvoTkuK3ojrflj5bnu5Hlrprot6/lvoRcbiAgICogQHBhcmFtIHBhdGhzIOi3r+W+hFxuICAgKiBAcGFyYW0gZW50aXR5VHlwZUluZm8gZW50aXR5VHlwZUluZm9cbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGdldEJpbmRpbmdQYXRoKHBhdGhzOiBzdHJpbmdbXSwgZW50aXR5VHlwZUluZm86IERhdGFUeXBlSW5mbykge1xuICAgIHBhdGhzID0gdGhpcy5nZXRFbnRpdHlQYXRoKHBhdGhzKTtcbiAgICBjb25zdCBlbnRpdHlQYXRocyA9IHRoaXMuZ2V0QXZhaWxhYmxlQ2hpbGRyZW5QYXRoc0Zyb21FbnRpdHlQYXRocyhwYXRocywgZW50aXR5VHlwZUluZm8pO1xuICAgIHJldHVybiBlbnRpdHlQYXRocztcbiAgfVxuICBwdWJsaWMgc3RhdGljIGdldEVudGl0eVBhdGgocGF0aDogc3RyaW5nW10pOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgcGF0aHMgPSBwYXRoLmZpbHRlcigodmFsdWU6IHN0cmluZywgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgaWYgKGluZGV4ICUgMiA9PT0gMCAmJiB2YWx1ZS5pbmNsdWRlcygnOicpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBwYXRocztcbiAgfVxufSJdfQ==