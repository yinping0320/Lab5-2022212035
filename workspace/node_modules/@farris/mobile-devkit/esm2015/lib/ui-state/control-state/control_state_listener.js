import { ChangeType } from "../../binding-data";
import { ControlStateUpdater } from "./control_state_updater";
export class ControlStateListener {
    constructor(viewModelContext) {
        //监听订阅集合
        this.subscriptionsMap = new Map();
        this.viewModelContext = viewModelContext;
        this.controlStateUpdater = viewModelContext.injector.get(ControlStateUpdater);
        //更新器初始化完成后，注册监听,主动触发一次更新
        this.controlStateUpdater.init().subscribe(res => {
            this.register();
            const changes = {
                lintenerType: 'firstUpdate',
                change: null
            };
            this.controlStateUpdater.updateControlState(changes);
        });
    }
    /**
     *注册监听
     */
    register() {
        this.registerBindingDataLintener();
        this.registerUIStateLintener();
        this.registerStateMachineLintener();
        this.registerFormLintener();
    }
    /**
     * 监听BindingData变化
     */
    registerBindingDataLintener() {
        const stateName = 'bindingData';
        if (this.subscriptionsMap.has(stateName) === false) {
            const subscription = this.viewModelContext.bindingData.changes.subscribe((change) => {
                if (change.type === ChangeType.Load) {
                    return;
                }
                this.controlStateUpdater.updateControlState({
                    lintenerType: 'bindingData',
                    change
                });
            });
            this.subscriptionsMap.set(stateName, subscription);
        }
    }
    /**
     * 监听UIState变化
     */
    registerUIStateLintener() {
        const stateName = 'uiState';
        if (this.subscriptionsMap.has(stateName) === false) {
            const subscription = this.viewModelContext.uiState.changes.subscribe((change) => {
                this.controlStateUpdater.updateControlState({
                    lintenerType: 'uiState',
                    change
                });
            });
            this.subscriptionsMap.set(stateName, subscription);
        }
    }
    /**
     * 监听StateMachine变化
     */
    registerStateMachineLintener() {
        const stateName = 'stateMachine';
        if (this.subscriptionsMap.has(stateName) === false && this.viewModelContext.stateMachine) {
            const subscription = this.viewModelContext.stateMachine.stateChange.subscribe((change) => {
                this.controlStateUpdater.updateControlState({
                    lintenerType: 'stateMachine',
                    change
                });
            });
            this.subscriptionsMap.set(stateName, subscription);
        }
    }
    /**
     * 监听Form变化
     */
    registerFormLintener() {
        const stateName = 'form';
        if (this.subscriptionsMap.has(stateName) === false) {
            const subscription = this.viewModelContext.form.changes.subscribe((change) => {
                if (change && change.type === 'validateFieldsFinished') {
                    this.controlStateUpdater.updateControlState({
                        lintenerType: 'expression',
                        change
                    });
                }
                else {
                    this.controlStateUpdater.updateControlState({
                        lintenerType: 'form',
                        change
                    });
                }
            });
            this.subscriptionsMap.set(stateName, subscription);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbF9zdGF0ZV9saXN0ZW5lci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi91aS1zdGF0ZS9jb250cm9sLXN0YXRlL2NvbnRyb2xfc3RhdGVfbGlzdGVuZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFVLFVBQVUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXhELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRzlELE1BQU0sT0FBTyxvQkFBb0I7SUFXL0IsWUFBWSxnQkFBa0M7UUFUOUMsUUFBUTtRQUNBLHFCQUFnQixHQUE4QixJQUFJLEdBQUcsRUFBd0IsQ0FBQztRQVNwRixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUM7UUFDekMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUc5RSx5QkFBeUI7UUFDekIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksRUFBRSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUEsRUFBRTtZQUM3QyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFFaEIsTUFBTSxPQUFPLEdBQUc7Z0JBQ2QsWUFBWSxFQUFDLGFBQWE7Z0JBQzFCLE1BQU0sRUFBQyxJQUFJO2FBQ1osQ0FBQTtZQUNELElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN2RCxDQUFDLENBQUMsQ0FBQTtJQUVKLENBQUM7SUFFRDs7T0FFRztJQUNLLFFBQVE7UUFDZCxJQUFJLENBQUMsMkJBQTJCLEVBQUUsQ0FBQztRQUNuQyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsNEJBQTRCLEVBQUUsQ0FBQztRQUNwQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztJ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QyxDQUFDLENBQUM7WUFDSCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUMsQ0FBQztTQUNwRDtJQUNILENBQUM7Q0FFRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gXCJyeGpzXCI7XHJcbmltcG9ydCB7IENoYW5nZSwgQ2hhbmdlVHlwZSB9IGZyb20gXCIuLi8uLi9iaW5kaW5nLWRhdGFcIjtcclxuaW1wb3J0IHsgVmlld01vZGVsQ29udGV4dCB9IGZyb20gXCIuLi8uLi92aWV3LW1vZGVsXCI7XHJcbmltcG9ydCB7IENvbnRyb2xTdGF0ZVVwZGF0ZXIgfSBmcm9tIFwiLi9jb250cm9sX3N0YXRlX3VwZGF0ZXJcIjtcclxuaW1wb3J0IHsgVUlTdGF0ZU9ic2VydmFibGVQYXJhbSB9IGZyb20gXCIuLi91aV9zdGF0ZVwiO1xyXG5cclxuZXhwb3J0IGNsYXNzIENvbnRyb2xTdGF0ZUxpc3RlbmVyIHtcclxuXHJcbiAgLy/nm5HlkKzorqLpmIXpm4blkIhcclxuICBwcml2YXRlIHN1YnNjcmlwdGlvbnNNYXA6IE1hcDxzdHJpbmcsIFN1YnNjcmlwdGlvbj4gPSBuZXcgTWFwPHN0cmluZywgU3Vic2NyaXB0aW9uPigpO1xyXG5cclxuICAvL+inhuWbvuaooeWei+S4iuS4i+aWh1xyXG4gIHByaXZhdGUgdmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dDtcclxuXHJcbiAgLy/mm7TmlrDlmahcclxuICBwcml2YXRlIGNvbnRyb2xTdGF0ZVVwZGF0ZXI6Q29udHJvbFN0YXRlVXBkYXRlcjtcclxuXHJcbiAgY29uc3RydWN0b3Iodmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dCkge1xyXG4gICAgdGhpcy52aWV3TW9kZWxDb250ZXh0ID0gdmlld01vZGVsQ29udGV4dDtcclxuICAgIHRoaXMuY29udHJvbFN0YXRlVXBkYXRlciA9IHZpZXdNb2RlbENvbnRleHQuaW5qZWN0b3IuZ2V0KENvbnRyb2xTdGF0ZVVwZGF0ZXIpO1xyXG4gICAgXHJcblxyXG4gICAgLy/mm7TmlrDlmajliJ3lp4vljJblrozmiJDlkI7vvIzms6jlhoznm5HlkKws5Li75Yqo6Kem5Y+R5LiA5qyh5pu05pawXHJcbiAgICB0aGlzLmNvbnRyb2xTdGF0ZVVwZGF0ZXIuaW5pdCgpLnN1YnNjcmliZShyZXM9PntcclxuICAgICAgdGhpcy5yZWdpc3RlcigpO1xyXG5cclxuICAgICAgY29uc3QgY2hhbmdlcyA9IHtcclxuICAgICAgICBsaW50ZW5lclR5cGU6J2ZpcnN0VXBkYXRlJyxcclxuICAgICAgICBjaGFuZ2U6bnVsbFxyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuY29udHJvbFN0YXRlVXBkYXRlci51cGRhdGVDb250cm9sU3RhdGUoY2hhbmdlcyk7XHJcbiAgICB9KVxyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAq5rOo5YaM55uR5ZCsXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZWdpc3Rlcigpe1xyXG4gICAgdGhpcy5yZWdpc3RlckJpbmRpbmdEYXRhTGludGVuZXIoKTtcclxuICAgIHRoaXMucmVnaXN0ZXJVSVN0YXRlTGludGVuZXIoKTtcclxuICAgIHRoaXMucmVnaXN0ZXJTdGF0ZU1hY2hpbmVMaW50ZW5lcigpO1xyXG4gICAgdGhpcy5yZWdpc3RlckZvcm1MaW50ZW5lcigpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog55uR5ZCsQmluZGluZ0RhdGHlj5jljJZcclxuICAgKi9cclxuICBwcml2YXRlIHJlZ2lzdGVyQmluZGluZ0RhdGFMaW50ZW5lcigpIHtcclxuICAgIGNvbnN0IHN0YXRlTmFtZSA9ICdiaW5kaW5nRGF0YSc7XHJcbiAgICBpZiAodGhpcy5zdWJzY3JpcHRpb25zTWFwLmhhcyhzdGF0ZU5hbWUpID09PSBmYWxzZSkge1xyXG4gICAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLnZpZXdNb2RlbENvbnRleHQuYmluZGluZ0RhdGEuY2hhbmdlcy5zdWJzY3JpYmUoKGNoYW5nZTogQ2hhbmdlKSA9PiB7XHJcbiAgICAgICAgaWYgKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLkxvYWQpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jb250cm9sU3RhdGVVcGRhdGVyLnVwZGF0ZUNvbnRyb2xTdGF0ZSh7XHJcbiAgICAgICAgICBsaW50ZW5lclR5cGU6J2JpbmRpbmdEYXRhJyxcclxuICAgICAgICAgIGNoYW5nZVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgICAgdGhpcy5zdWJzY3JpcHRpb25zTWFwLnNldChzdGF0ZU5hbWUsIHN1YnNjcmlwdGlvbik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDnm5HlkKxVSVN0YXRl5Y+Y5YyWXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZWdpc3RlclVJU3RhdGVMaW50ZW5lcigpIHtcclxuICAgIGNvbnN0IHN0YXRlTmFtZSA9ICd1aVN0YXRlJztcclxuICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbnNNYXAuaGFzKHN0YXRlTmFtZSkgPT09IGZhbHNlKSB7XHJcbiAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHRoaXMudmlld01vZGVsQ29udGV4dC51aVN0YXRlLmNoYW5nZXMuc3Vic2NyaWJlKChjaGFuZ2U6IFVJU3RhdGVPYnNlcnZhYmxlUGFyYW0pID0+IHtcclxuICAgICAgICB0aGlzLmNvbnRyb2xTdGF0ZVVwZGF0ZXIudXBkYXRlQ29udHJvbFN0YXRlKHtcclxuICAgICAgICAgIGxpbnRlbmVyVHlwZTondWlTdGF0ZScsXHJcbiAgICAgICAgICBjaGFuZ2VcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9uc01hcC5zZXQoc3RhdGVOYW1lLCBzdWJzY3JpcHRpb24pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgXHJcbiAgLyoqXHJcbiAgICog55uR5ZCsU3RhdGVNYWNoaW5l5Y+Y5YyWXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZWdpc3RlclN0YXRlTWFjaGluZUxpbnRlbmVyKCkge1xyXG4gICAgY29uc3Qgc3RhdGVOYW1lID0gJ3N0YXRlTWFjaGluZSc7XHJcbiAgICBpZiAodGhpcy5zdWJzY3JpcHRpb25zTWFwLmhhcyhzdGF0ZU5hbWUpID09PSBmYWxzZSAmJiB0aGlzLnZpZXdNb2RlbENvbnRleHQuc3RhdGVNYWNoaW5lKSB7XHJcbiAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHRoaXMudmlld01vZGVsQ29udGV4dC5zdGF0ZU1hY2hpbmUuc3RhdGVDaGFuZ2Uuc3Vic2NyaWJlKChjaGFuZ2U6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIHRoaXMuY29udHJvbFN0YXRlVXBkYXRlci51cGRhdGVDb250cm9sU3RhdGUoe1xyXG4gICAgICAgICAgbGludGVuZXJUeXBlOidzdGF0ZU1hY2hpbmUnLFxyXG4gICAgICAgICAgY2hhbmdlXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbnNNYXAuc2V0KHN0YXRlTmFtZSwgc3Vic2NyaXB0aW9uKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIFxyXG4gIC8qKlxyXG4gICAqIOebkeWQrEZvcm3lj5jljJZcclxuICAgKi9cclxuICBwcml2YXRlIHJlZ2lzdGVyRm9ybUxpbnRlbmVyKCkge1xyXG4gICAgY29uc3Qgc3RhdGVOYW1lID0gJ2Zvcm0nO1xyXG4gICAgaWYgKHRoaXMuc3Vic2NyaXB0aW9uc01hcC5oYXMoc3RhdGVOYW1lKSA9PT0gZmFsc2UpIHtcclxuICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LmZvcm0uY2hhbmdlcy5zdWJzY3JpYmUoKGNoYW5nZTogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKGNoYW5nZSAmJiBjaGFuZ2UudHlwZSA9PT0gJ3ZhbGlkYXRlRmllbGRzRmluaXNoZWQnKSB7XHJcbiAgICAgICAgICB0aGlzLmNvbnRyb2xTdGF0ZVVwZGF0ZXIudXBkYXRlQ29udHJvbFN0YXRlKHtcclxuICAgICAgICAgICAgbGludGVuZXJUeXBlOidleHByZXNzaW9uJyxcclxuICAgICAgICAgICAgY2hhbmdlXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2V7XHJcbiAgICAgICAgICB0aGlzLmNvbnRyb2xTdGF0ZVVwZGF0ZXIudXBkYXRlQ29udHJvbFN0YXRlKHtcclxuICAgICAgICAgICAgbGludGVuZXJUeXBlOidmb3JtJyxcclxuICAgICAgICAgICAgY2hhbmdlXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICB9KTtcclxuICAgICAgdGhpcy5zdWJzY3JpcHRpb25zTWFwLnNldChzdGF0ZU5hbWUsIHN1YnNjcmlwdGlvbik7XHJcbiAgICB9XHJcbiAgfVxyXG4gIFxyXG59Il19