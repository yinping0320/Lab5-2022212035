import { of } from "rxjs";
import { NoCodeRenderStateUtil } from "./render_state_util";
/**
 * 根据流程页面状态扩展
 * 控制逻辑：
 * 1.根据【流程页面状态】控制隐藏页首和页尾（隐藏按钮）（有点问题，驳回时）
 * 2.流程页面状态为ViewOnly时，按钮隐藏（包含普通按钮、按钮组内按钮、列表滑动工具栏、卡片动作按钮栏）,其他的控件设置为只读或者禁用。
 */
export class ProcessUiControlStateInterceptor {
    constructor() {
        this.canIntercept = true;
    }
    /**
     * 初始化
     */
    init(initContext) {
        const processContext = initContext.processContext;
        const isInWf = processContext.isInWf;
        if (!isInWf) {
            this.canIntercept = false;
            return of(true);
        }
        const uiStateInProcess = processContext.uiStateInProcess;
        if (!isInWf) {
            // 制单状态：单据不是在流程中心打开：允许修改
            this.renderStates = NoCodeRenderStateUtil.getRenderStatesWhenDrafting();
        }
        else if (uiStateInProcess === 'BackEdit') {
            // 退回修改：我的代办中打开驳回的表单
            this.renderStates = NoCodeRenderStateUtil.getRenderStatesWhenBackEdit();
        }
        else if (uiStateInProcess === 'Redrafting') {
            // 重新制单：我的发起撤回，并且尚未重新提交
            this.renderStates = NoCodeRenderStateUtil.getRenderStatesWhenReDrafting();
        }
        else if (uiStateInProcess === "Approving") {
            //1、审批中，待办任务（除待阅、重新提交）
            //2、默认未只读态，最终以流程节点上的配置为准
            this.renderStates = NoCodeRenderStateUtil.getRenderStatesWhenApproving();
        }
        else if (uiStateInProcess === "ViewOnly") {
            this.renderStates = NoCodeRenderStateUtil.getRenderStatesWhenViewOnly();
        }
        else {
            this.renderStates = NoCodeRenderStateUtil.getRenderStatesWhenViewOnly();
        }
        return of(true);
    }
    /**
     * 拦截
     * 根据页面状态，隐藏页头和页尾。如果为ViewOnly，把按钮和输入控件设置为只读
     * @param interceptContext
     */
    intercept(interceptContext) {
        if (!this.canIntercept) {
            return;
        }
        switch (interceptContext.type) {
            case 'visible': {
                this.visibleStateIntercept(interceptContext);
                break;
            }
            case 'readonly': {
                this.readonlyStateIntercept(interceptContext);
                break;
            }
            case 'disabled': {
                this.disabledStateIntercept(interceptContext);
                break;
            }
            case 'hideDeleteBtn':
            case 'hideUploadBtn': {
                this.attachmentBtnStateIntercept(interceptContext);
                break;
            }
        }
    }
    /**
     * 隐藏头部、尾部、审批日志
     * @param interceptContext
     */
    visibleStateIntercept(interceptContext) {
        const controlInfo = interceptContext.controlState.controlInfo;
        const viewModelContext = interceptContext.viewModelContext;
        const bindingPath = viewModelContext.viewModel.bindingPath;
        if (this.renderStates.showHeader === false) {
            if ((!bindingPath || bindingPath === '/') && controlInfo.type === 'NavigationBar') {
                interceptContext.value = false;
            }
        }
        if (this.renderStates.showFooter === false) {
            if ((!bindingPath || bindingPath === '/') && controlInfo.isInFooter && controlInfo.type === 'Button') {
                interceptContext.value = false;
            }
        }
        if (this.renderStates.showChildHeader === false) {
            if ((bindingPath && bindingPath !== '/') && controlInfo.type === 'NavigationBar') {
                interceptContext.value = false;
            }
        }
        if (this.renderStates.showChildFooter === false) {
            if ((bindingPath && bindingPath !== '/') && controlInfo.isInFooter && controlInfo.type === 'Button') {
                interceptContext.value = false;
            }
        }
        const processContext = interceptContext.processContext;
        if (processContext.uiStateInProcess === "ViewOnly") {
            if (controlInfo.type === 'Button') {
                interceptContext.value = false;
            }
        }
    }
    /**
     * 设置为只读
     * @param interceptContext
     * @returns
     */
    readonlyStateIntercept(interceptContext) {
        const processContext = interceptContext.processContext;
        const controlInfo = interceptContext.controlState.controlInfo;
        if (processContext.uiStateInProcess === "ViewOnly" && controlInfo.type !== 'Button') {
            interceptContext.value = true;
        }
    }
    /**
     * 设置为禁用
     * @param interceptContext
     * @returns
     */
    disabledStateIntercept(interceptContext) {
        const processContext = interceptContext.processContext;
        const controlInfo = interceptContext.controlState.controlInfo;
        if (processContext.uiStateInProcess === "ViewOnly" && controlInfo.type !== 'Button') {
            if (!interceptContext.controlState.originalValue.hasOwnProperty('readonly')) {
                interceptContext.value = true;
            }
        }
    }
    /**
     * 附件设置为只读
     * @param interceptContext
     * @returns
     */
    attachmentBtnStateIntercept(interceptContext) {
        const processContext = interceptContext.processContext;
        if (processContext.uiStateInProcess === "ViewOnly") {
            interceptContext.value = true;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzc191aV9zdGF0ZV9pbnRlcmNlcHRvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi91aS1zdGF0ZS9jb250cm9sLXN0YXRlL3Byb2Nlc3NfdWlfc3RhdGVfaW50ZXJjZXB0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUV0QyxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUU1RDs7Ozs7R0FLRztBQUNILE1BQU0sT0FBTyxnQ0FBZ0M7SUFLekM7UUFEUSxpQkFBWSxHQUFXLElBQUksQ0FBQztJQUdwQyxDQUFDO0lBRUQ7O09BRUc7SUFDSSxJQUFJLENBQUMsV0FBdUI7UUFDL0IsTUFBTSxjQUFjLEdBQW1CLFdBQVcsQ0FBQyxjQUFjLENBQUM7UUFDbEUsTUFBTSxNQUFNLEdBQUcsY0FBYyxDQUFDLE1BQU0sQ0FBQztRQUVyQyxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ1QsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7WUFDMUIsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDbkI7UUFFRCxNQUFNLGdCQUFnQixHQUFHLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQztRQUN6RCxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ1Qsd0JBQXdCO1lBQ3hCLElBQUksQ0FBQyxZQUFZLEdBQUcscUJBQXFCLENBQUMsMkJBQTJCLEVBQUUsQ0FBQztTQUMzRTthQUFNLElBQUksZ0JBQWdCLEtBQUssVUFBVSxFQUFFO1lBRXhDLG9CQUFvQjtZQUNwQixJQUFJLENBQUMsWUFBWSxHQUFHLHFCQUFxQixDQUFDLDJCQUEyQixFQUFFLENBQUM7U0FDM0U7YUFBTSxJQUFJLGdCQUFnQixLQUFLLFlBQVksRUFBRTtZQUUxQyx1QkFBdUI7WUFDdkIsSUFBSSxDQUFDLFlBQVksR0FBRyxxQkFB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RyxjQUFjLENBQUMsZ0JBQWdCLEtBQUssVUFBVSxFQUFDO1lBQzlDLGdCQUFnQixDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7U0FDakM7SUFDTCxDQUFDO0NBRUoiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gXCJyeGpzXCI7XHJcbmltcG9ydCB7IEludGVyY2VwdENvbnRleHQsIENvbnRyb2xTdGF0ZUludGVyY2VwdG9yLCBJbml0Q29udGV4dCwgUHJvY2Vzc0NvbnRleHQgfSBmcm9tIFwiLi9jb250cm9sX3N0YXRlX2ludGVyY2VwdG9yXCI7XHJcbmltcG9ydCB7IE5vQ29kZVJlbmRlclN0YXRlVXRpbCB9IGZyb20gXCIuL3JlbmRlcl9zdGF0ZV91dGlsXCI7XHJcblxyXG4vKipcclxuICog5qC55o2u5rWB56iL6aG16Z2i54q25oCB5omp5bGVXHJcbiAqIOaOp+WItumAu+i+ke+8mlxyXG4gKiAxLuagueaNruOAkOa1geeoi+mhtemdoueKtuaAgeOAkeaOp+WItumakOiXj+mhtemmluWSjOmhteWwvu+8iOmakOiXj+aMiemSru+8ie+8iOacieeCuemXrumimO+8jOmps+WbnuaXtu+8iVxyXG4gKiAyLua1geeoi+mhtemdoueKtuaAgeS4ulZpZXdPbmx55pe277yM5oyJ6ZKu6ZqQ6JeP77yI5YyF5ZCr5pmu6YCa5oyJ6ZKu44CB5oyJ6ZKu57uE5YaF5oyJ6ZKu44CB5YiX6KGo5ruR5Yqo5bel5YW35qCP44CB5Y2h54mH5Yqo5L2c5oyJ6ZKu5qCP77yJLOWFtuS7lueahOaOp+S7tuiuvue9ruS4uuWPquivu+aIluiAheemgeeUqOOAglxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIFByb2Nlc3NVaUNvbnRyb2xTdGF0ZUludGVyY2VwdG9yIGltcGxlbWVudHMgQ29udHJvbFN0YXRlSW50ZXJjZXB0b3Ige1xyXG5cclxuICAgIHByaXZhdGUgcmVuZGVyU3RhdGVzOiBhbnk7XHJcblxyXG4gICAgcHJpdmF0ZSBjYW5JbnRlcmNlcHQ6Ym9vbGVhbiA9IHRydWU7XHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDliJ3lp4vljJZcclxuICAgICAqL1xyXG4gICAgcHVibGljIGluaXQoaW5pdENvbnRleHQ6SW5pdENvbnRleHQpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgICAgIGNvbnN0IHByb2Nlc3NDb250ZXh0OiBQcm9jZXNzQ29udGV4dCA9IGluaXRDb250ZXh0LnByb2Nlc3NDb250ZXh0O1xyXG4gICAgICAgIGNvbnN0IGlzSW5XZiA9IHByb2Nlc3NDb250ZXh0LmlzSW5XZjtcclxuXHJcbiAgICAgICAgaWYgKCFpc0luV2YpIHtcclxuICAgICAgICAgICAgdGhpcy5jYW5JbnRlcmNlcHQgPSBmYWxzZTtcclxuICAgICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgdWlTdGF0ZUluUHJvY2VzcyA9IHByb2Nlc3NDb250ZXh0LnVpU3RhdGVJblByb2Nlc3M7XHJcbiAgICAgICAgaWYgKCFpc0luV2YpIHtcclxuICAgICAgICAgICAgLy8g5Yi25Y2V54q25oCB77ya5Y2V5o2u5LiN5piv5Zyo5rWB56iL5Lit5b+D5omT5byA77ya5YWB6K645L+u5pS5XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyU3RhdGVzID0gTm9Db2RlUmVuZGVyU3RhdGVVdGlsLmdldFJlbmRlclN0YXRlc1doZW5EcmFmdGluZygpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodWlTdGF0ZUluUHJvY2VzcyA9PT0gJ0JhY2tFZGl0Jykge1xyXG5cclxuICAgICAgICAgICAgLy8g6YCA5Zue5L+u5pS577ya5oiR55qE5Luj5Yqe5Lit5omT5byA6amz5Zue55qE6KGo5Y2VXHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyU3RhdGVzID0gTm9Db2RlUmVuZGVyU3RhdGVVdGlsLmdldFJlbmRlclN0YXRlc1doZW5CYWNrRWRpdCgpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodWlTdGF0ZUluUHJvY2VzcyA9PT0gJ1JlZHJhZnRpbmcnKSB7XHJcblxyXG4gICAgICAgICAgICAvLyDph43mlrDliLbljZXvvJrmiJHnmoTlj5HotbfmkqTlm57vvIzlubbkuJTlsJrmnKrph43mlrDmj5DkuqRcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJTdGF0ZXMgPSBOb0NvZGVSZW5kZXJTdGF0ZVV0aWwuZ2V0UmVuZGVyU3RhdGVzV2hlblJlRHJhZnRpbmcoKTtcclxuICAgICAgICB9ZWxzZSBpZih1aVN0YXRlSW5Qcm9jZXNzID09PSBcIkFwcHJvdmluZ1wiKSB7XHJcbiAgICAgICAgICAgIC8vMeOAgeWuoeaJueS4re+8jOW+heWKnuS7u+WKoe+8iOmZpOW+hemYheOAgemHjeaWsOaPkOS6pO+8iVxyXG4gICAgICAgICAgICAvLzLjgIHpu5jorqTmnKrlj6ror7vmgIHvvIzmnIDnu4jku6XmtYHnqIvoioLngrnkuIrnmoTphY3nva7kuLrlh4ZcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJTdGF0ZXMgPSBOb0NvZGVSZW5kZXJTdGF0ZVV0aWwuZ2V0UmVuZGVyU3RhdGVzV2hlbkFwcHJvdmluZygpO1xyXG4gICAgICAgIH1lbHNlIGlmKHVpU3RhdGVJblByb2Nlc3MgPT09IFwiVmlld09ubHlcIiApIHtcclxuXHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyU3RhdGVzID0gTm9Db2RlUmVuZGVyU3RhdGVVdGlsLmdldFJlbmRlclN0YXRlc1doZW5WaWV3T25seSgpO1xyXG4gICAgICAgIH1lbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJTdGF0ZXMgPSBOb0NvZGVSZW5kZXJTdGF0ZVV0aWwuZ2V0UmVuZGVyU3RhdGVzV2hlblZpZXdPbmx5KCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gb2YodHJ1ZSlcclxuICAgIH1cclxuXHJcbiAgIFxyXG4gICAgLyoqXHJcbiAgICAgKiDmi6bmiKpcclxuICAgICAqIOagueaNrumhtemdoueKtuaAge+8jOmakOiXj+mhteWktOWSjOmhteWwvuOAguWmguaenOS4ulZpZXdPbmx577yM5oqK5oyJ6ZKu5ZKM6L6T5YWl5o6n5Lu26K6+572u5Li65Y+q6K+7XHJcbiAgICAgKiBAcGFyYW0gaW50ZXJjZXB0Q29udGV4dCBcclxuICAgICAqL1xyXG4gICAgcHVibGljIGludGVyY2VwdChpbnRlcmNlcHRDb250ZXh0OiBJbnRlcmNlcHRDb250ZXh0KTp2b2lkIHtcclxuICAgICAgICBpZiAoIXRoaXMuY2FuSW50ZXJjZXB0KSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHN3aXRjaCAoaW50ZXJjZXB0Q29udGV4dC50eXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgJ3Zpc2libGUnOiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnZpc2libGVTdGF0ZUludGVyY2VwdChpbnRlcmNlcHRDb250ZXh0KTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgJ3JlYWRvbmx5Jzoge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWFkb25seVN0YXRlSW50ZXJjZXB0KGludGVyY2VwdENvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSAnZGlzYWJsZWQnOiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRpc2FibGVkU3RhdGVJbnRlcmNlcHQoaW50ZXJjZXB0Q29udGV4dCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlICdoaWRlRGVsZXRlQnRuJzogY2FzZSAnaGlkZVVwbG9hZEJ0bic6e1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hdHRhY2htZW50QnRuU3RhdGVJbnRlcmNlcHQoaW50ZXJjZXB0Q29udGV4dCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDpmpDol4/lpLTpg6jjgIHlsL7pg6jjgIHlrqHmibnml6Xlv5dcclxuICAgICAqIEBwYXJhbSBpbnRlcmNlcHRDb250ZXh0IFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHZpc2libGVTdGF0ZUludGVyY2VwdChpbnRlcmNlcHRDb250ZXh0OiBJbnRlcmNlcHRDb250ZXh0KSB7XHJcbiAgICAgICAgY29uc3QgY29udHJvbEluZm8gPSBpbnRlcmNlcHRDb250ZXh0LmNvbnRyb2xTdGF0ZS5jb250cm9sSW5mbztcclxuICAgICAgICBjb25zdCB2aWV3TW9kZWxDb250ZXh0ID0gaW50ZXJjZXB0Q29udGV4dC52aWV3TW9kZWxDb250ZXh0O1xyXG4gICAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gdmlld01vZGVsQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGhcclxuXHJcbiAgICAgICAgaWYgKHRoaXMucmVuZGVyU3RhdGVzLnNob3dIZWFkZXIgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgIGlmICgoIWJpbmRpbmdQYXRoIHx8IGJpbmRpbmdQYXRoID09PSAnLycpICYmICBjb250cm9sSW5mby50eXBlID09PSAnTmF2aWdhdGlvbkJhcicpIHtcclxuICAgICAgICAgICAgICAgIGludGVyY2VwdENvbnRleHQudmFsdWUgPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5yZW5kZXJTdGF0ZXMuc2hvd0Zvb3RlciA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgaWYgKCghYmluZGluZ1BhdGggfHwgYmluZGluZ1BhdGggPT09ICcvJykgJiYgY29udHJvbEluZm8uaXNJbkZvb3RlciAmJiAgY29udHJvbEluZm8udHlwZSA9PT0gJ0J1dHRvbicpIHtcclxuICAgICAgICAgICAgICAgIGludGVyY2VwdENvbnRleHQudmFsdWUgPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMucmVuZGVyU3RhdGVzLnNob3dDaGlsZEhlYWRlciA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgaWYgKChiaW5kaW5nUGF0aCAmJiBiaW5kaW5nUGF0aCAhPT0gJy8nKSAmJiAgY29udHJvbEluZm8udHlwZSA9PT0gJ05hdmlnYXRpb25CYXInKSB7XHJcbiAgICAgICAgICAgICAgICBpbnRlcmNlcHRDb250ZXh0LnZhbHVlID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnJlbmRlclN0YXRlcy5zaG93Q2hpbGRGb290ZXIgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgIGlmICgoYmluZGluZ1BhdGggJiYgYmluZGluZ1BhdGggIT09ICcvJykgJiYgY29udHJvbEluZm8uaXNJbkZvb3RlciAgJiYgIGNvbnRyb2xJbmZvLnR5cGUgPT09ICdCdXR0b24nKSB7XHJcbiAgICAgICAgICAgICAgICBpbnRlcmNlcHRDb250ZXh0LnZhbHVlID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHByb2Nlc3NDb250ZXh0OiBQcm9jZXNzQ29udGV4dCA9IGludGVyY2VwdENvbnRleHQucHJvY2Vzc0NvbnRleHQ7XHJcbiAgICAgICAgaWYocHJvY2Vzc0NvbnRleHQudWlTdGF0ZUluUHJvY2VzcyA9PT0gXCJWaWV3T25seVwiKXtcclxuICAgICAgICAgICAgaWYoY29udHJvbEluZm8udHlwZSA9PT0gJ0J1dHRvbicpe1xyXG4gICAgICAgICAgICAgICAgaW50ZXJjZXB0Q29udGV4dC52YWx1ZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6K6+572u5Li65Y+q6K+7XHJcbiAgICAgKiBAcGFyYW0gaW50ZXJjZXB0Q29udGV4dCBcclxuICAgICAqIEByZXR1cm5zIFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5U3RhdGVJbnRlcmNlcHQoaW50ZXJjZXB0Q29udGV4dDogSW50ZXJjZXB0Q29udGV4dCkge1xyXG4gICAgICAgIGNvbnN0IHByb2Nlc3NDb250ZXh0OiBQcm9jZXNzQ29udGV4dCA9IGludGVyY2VwdENvbnRleHQucHJvY2Vzc0NvbnRleHQ7XHJcbiAgICAgICAgY29uc3QgY29udHJvbEluZm8gPSBpbnRlcmNlcHRDb250ZXh0LmNvbnRyb2xTdGF0ZS5jb250cm9sSW5mbztcclxuICAgICAgICBpZihwcm9jZXNzQ29udGV4dC51aVN0YXRlSW5Qcm9jZXNzID09PSBcIlZpZXdPbmx5XCIgJiYgY29udHJvbEluZm8udHlwZSAhPT0gJ0J1dHRvbicpe1xyXG4gICAgICAgICAgICBpbnRlcmNlcHRDb250ZXh0LnZhbHVlID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDorr7nva7kuLrnpoHnlKhcclxuICAgICAqIEBwYXJhbSBpbnRlcmNlcHRDb250ZXh0IFxyXG4gICAgICogQHJldHVybnNcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBkaXNhYmxlZFN0YXRlSW50ZXJjZXB0KGludGVyY2VwdENvbnRleHQ6IEludGVyY2VwdENvbnRleHQpIHtcclxuICAgICAgICBjb25zdCBwcm9jZXNzQ29udGV4dDogUHJvY2Vzc0NvbnRleHQgPSBpbnRlcmNlcHRDb250ZXh0LnByb2Nlc3NDb250ZXh0O1xyXG4gICAgICAgIGNvbnN0IGNvbnRyb2xJbmZvID0gaW50ZXJjZXB0Q29udGV4dC5jb250cm9sU3RhdGUuY29udHJvbEluZm87XHJcbiAgICAgICAgaWYocHJvY2Vzc0NvbnRleHQudWlTdGF0ZUluUHJvY2VzcyA9PT0gXCJWaWV3T25seVwiICYmIGNvbnRyb2xJbmZvLnR5cGUgIT09ICdCdXR0b24nKXtcclxuICAgICAgICAgICAgaWYoIWludGVyY2VwdENvbnRleHQuY29udHJvbFN0YXRlLm9yaWdpbmFsVmFsdWUuaGFzT3duUHJvcGVydHkoJ3JlYWRvbmx5Jykpe1xyXG4gICAgICAgICAgICAgICAgaW50ZXJjZXB0Q29udGV4dC52YWx1ZSA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDpmYTku7borr7nva7kuLrlj6ror7tcclxuICAgICAqIEBwYXJhbSBpbnRlcmNlcHRDb250ZXh0IFxyXG4gICAgICogQHJldHVybnNcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBhdHRhY2htZW50QnRuU3RhdGVJbnRlcmNlcHQoaW50ZXJjZXB0Q29udGV4dDogSW50ZXJjZXB0Q29udGV4dCl7XHJcbiAgICAgICAgY29uc3QgcHJvY2Vzc0NvbnRleHQ6IFByb2Nlc3NDb250ZXh0ID0gaW50ZXJjZXB0Q29udGV4dC5wcm9jZXNzQ29udGV4dDtcclxuICAgICAgICBpZihwcm9jZXNzQ29udGV4dC51aVN0YXRlSW5Qcm9jZXNzID09PSBcIlZpZXdPbmx5XCIpe1xyXG4gICAgICAgICAgICBpbnRlcmNlcHRDb250ZXh0LnZhbHVlID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG59XHJcblxyXG4iXX0=