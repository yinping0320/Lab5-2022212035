import { shareReplay } from "rxjs/operators";
import { InjectFlags } from "../../core";
import { CONTROL_STATE_INTERCEPTOR_TOKEN, InitContext, ProcessContext } from "./control_state_interceptor";
import { forkJoin, isObservable, of } from "rxjs";
import { EnvUtil, UrlUtil } from "../../utils";
/**
 * 状态拦截器服务
 */
export class ControlStateInterceptorService {
    constructor(injector) {
        this.injector = injector;
        //控件状态拦截器
        this.controlInterceptors = [];
        this.controlInterceptors = this.injector.get(CONTROL_STATE_INTERCEPTOR_TOKEN, null, InjectFlags.Optional);
    }
    init() {
        if (this.result) {
            return this.result;
        }
        const inits = [];
        const initContext = new InitContext();
        const processContext = this.getProcessContext();
        initContext.processContext = this.processContext = processContext;
        for (const controlInterceptor of this.controlInterceptors) {
            if (controlInterceptor.init && typeof controlInterceptor.init === 'function') {
                const initFunc = controlInterceptor.init(initContext);
                const $result = isObservable(initFunc) ? initFunc : of(initFunc);
                inits.push($result);
            }
        }
        return this.result = forkJoin(inits).pipe(shareReplay(1));
    }
    intercept(interceptContext) {
        interceptContext.processContext = this.processContext;
        for (const controlInterceptor of this.controlInterceptors) {
            controlInterceptor.intercept(interceptContext);
        }
    }
    getProcessContext() {
        const processContext = new ProcessContext();
        const isInWf = EnvUtil.isInWf();
        processContext.isInWf = isInWf;
        if (isInWf === false) {
            return processContext;
        }
        const iframe = window.parent.document.querySelector('iframe');
        if (!iframe || !iframe.src) {
            return processContext;
        }
        const queryParams = UrlUtil.getParams(iframe.src);
        if (!queryParams) {
            return processContext;
        }
        processContext.uiStateInProcess = queryParams.UIStateInProcess;
        processContext.formConfigId = queryParams.formConfigId;
        return processContext;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbF9zdGF0ZV9pbnRlcmNlcHRvci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3VpLXN0YXRlL2NvbnRyb2wtc3RhdGUvY29udHJvbF9zdGF0ZV9pbnRlcmNlcHRvci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsV0FBVyxFQUFZLE1BQU0sWUFBWSxDQUFDO0FBQ25ELE9BQU8sRUFBRSwrQkFBK0IsRUFBNkMsV0FBVyxFQUFFLGNBQWMsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ3RKLE9BQU8sRUFBYyxRQUFRLEVBQUUsWUFBWSxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUU5Qzs7R0FFRztBQUNILE1BQU0sT0FBTyw4QkFBOEI7SUFRdkMsWUFBb0IsUUFBa0I7UUFBbEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQU50QyxTQUFTO1FBQ0Qsd0JBQW1CLEdBQThCLEVBQUUsQ0FBQztRQU14RCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsK0JBQStCLEVBQUUsSUFBSSxFQUFFLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUM5RyxDQUFDO0lBRU0sSUFBSTtRQUNQLElBQUcsSUFBSSxDQUFDLE1BQU0sRUFBQztZQUNYLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQztTQUN0QjtRQUVELE1BQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUNqQixNQUFNLFdBQVcsR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO1FBQ3RDLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQ2hELFdBQVcsQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLGNBQWMsR0FBRyxjQUFjLENBQUM7UUFFbEUsS0FBSSxNQUFNLGtCQUFrQixJQUFJLElBQUksQ0FBQyxtQkFBbUIsRUFBQztZQUNyRCxJQUFHLGtCQUFrQixDQUFDLElBQUksSUFBSSxPQUFPLGtCQUFrQixDQUFDLElBQUksS0FBSyxVQUFVLEVBQUM7Z0JBQ3hFLE1BQU0sUUFBUSxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDdEQsTUFBTSxPQUFPLEdBQUcsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDakUsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUN2QjtTQUNKO1FBRUQsT0FBTyxJQUFJLENBQUMsTUFBTSxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUQsQ0FBQztJQUVNLFNBQVMsQ0FBQyxnQkFBaUM7UUFDOUMsZ0JBQWdCLENBQUMsY0FBYyxHQUFJLElBQUksQ0FBQyxjQUFjLENBQUM7UUFDdkQsS0FBSSxNQUFNLGtCQUFrQixJQUFJLElBQUksQ0FBQyxtQkFBbUIsRUFBQztZQUNyRCxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztTQUNsRDtJQUNMLENBQUM7SUFFTyxpQkFBaUI7UUFDckIsTUFBTSxjQUFjLEdBQUcsSUFBSyxjQUFjLEVBQUUsQ0FBQztRQUM3QyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDaEMsY0FBYyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDL0IsSUFBSSxNQUFNLEtBQUssS0FBSyxFQUFFO1lBQ2xCLE9BQU8sY0FBYyxDQUFBO1NBQ3hCO1FBRUQsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzlELElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFO1lBQ3hCLE9BQU8sY0FBYyxDQUFBO1NBQ3hCO1FBRUQsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbEQsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNkLE9BQU8sY0FBYyxDQUFBO1NBQ3hCO1FBRUQsY0FBYyxDQUFDLGdCQUFnQixHQUFHLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQztRQUMvRCxjQUFjLENBQUMsWUFBWSxHQUFHLFdBQVcsQ0FBQyxZQUFZLENBQUM7UUFFdkQsT0FBTyxjQUFjLENBQUE7SUFDekIsQ0FBQztDQUdKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc2hhcmVSZXBsYXkgfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcclxuaW1wb3J0IHsgSW5qZWN0RmxhZ3MsIEluamVjdG9yIH0gZnJvbSBcIi4uLy4uL2NvcmVcIjtcclxuaW1wb3J0IHsgQ09OVFJPTF9TVEFURV9JTlRFUkNFUFRPUl9UT0tFTiwgSW50ZXJjZXB0Q29udGV4dCwgQ29udHJvbFN0YXRlSW50ZXJjZXB0b3IsIEluaXRDb250ZXh0LCBQcm9jZXNzQ29udGV4dCB9IGZyb20gXCIuL2NvbnRyb2xfc3RhdGVfaW50ZXJjZXB0b3JcIjtcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZm9ya0pvaW4sIGlzT2JzZXJ2YWJsZSwgb2YgfSBmcm9tIFwicnhqc1wiO1xyXG5pbXBvcnQgeyBFbnZVdGlsLCBVcmxVdGlsfSBmcm9tIFwiLi4vLi4vdXRpbHNcIjtcclxuXHJcbi8qKlxyXG4gKiDnirbmgIHmi6bmiKrlmajmnI3liqFcclxuICovXHJcbmV4cG9ydCBjbGFzcyBDb250cm9sU3RhdGVJbnRlcmNlcHRvclNlcnZpY2V7XHJcblxyXG4gICAgLy/mjqfku7bnirbmgIHmi6bmiKrlmahcclxuICAgIHByaXZhdGUgY29udHJvbEludGVyY2VwdG9yczogQ29udHJvbFN0YXRlSW50ZXJjZXB0b3JbXSA9IFtdO1xyXG4gICAgcHJpdmF0ZSByZXN1bHQ6T2JzZXJ2YWJsZTxhbnk+O1xyXG5cclxuICAgIHByaXZhdGUgcHJvY2Vzc0NvbnRleHQ6IFByb2Nlc3NDb250ZXh0O1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yKXtcclxuICAgICAgICB0aGlzLmNvbnRyb2xJbnRlcmNlcHRvcnMgPSB0aGlzLmluamVjdG9yLmdldChDT05UUk9MX1NUQVRFX0lOVEVSQ0VQVE9SX1RPS0VOLCBudWxsLCBJbmplY3RGbGFncy5PcHRpb25hbCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGluaXQoKTpPYnNlcnZhYmxlPGFueT57XHJcbiAgICAgICAgaWYodGhpcy5yZXN1bHQpe1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZXN1bHQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBpbml0cyA9IFtdO1xyXG4gICAgICAgIGNvbnN0IGluaXRDb250ZXh0ID0gbmV3IEluaXRDb250ZXh0KCk7XHJcbiAgICAgICAgY29uc3QgcHJvY2Vzc0NvbnRleHQgPSB0aGlzLmdldFByb2Nlc3NDb250ZXh0KCk7XHJcbiAgICAgICAgaW5pdENvbnRleHQucHJvY2Vzc0NvbnRleHQgPSB0aGlzLnByb2Nlc3NDb250ZXh0ID0gcHJvY2Vzc0NvbnRleHQ7XHJcblxyXG4gICAgICAgIGZvcihjb25zdCBjb250cm9sSW50ZXJjZXB0b3Igb2YgdGhpcy5jb250cm9sSW50ZXJjZXB0b3JzKXtcclxuICAgICAgICAgICAgaWYoY29udHJvbEludGVyY2VwdG9yLmluaXQgJiYgdHlwZW9mIGNvbnRyb2xJbnRlcmNlcHRvci5pbml0ID09PSAnZnVuY3Rpb24nKXtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGluaXRGdW5jID0gY29udHJvbEludGVyY2VwdG9yLmluaXQoaW5pdENvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgJHJlc3VsdCA9IGlzT2JzZXJ2YWJsZShpbml0RnVuYykgPyBpbml0RnVuYyA6IG9mKGluaXRGdW5jKTtcclxuICAgICAgICAgICAgICAgIGluaXRzLnB1c2goJHJlc3VsdCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLnJlc3VsdCA9IGZvcmtKb2luKGluaXRzKS5waXBlKHNoYXJlUmVwbGF5KDEpKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgaW50ZXJjZXB0KGludGVyY2VwdENvbnRleHQ6SW50ZXJjZXB0Q29udGV4dCkge1xyXG4gICAgICAgIGludGVyY2VwdENvbnRleHQucHJvY2Vzc0NvbnRleHQgID0gdGhpcy5wcm9jZXNzQ29udGV4dDtcclxuICAgICAgICBmb3IoY29uc3QgY29udHJvbEludGVyY2VwdG9yIG9mIHRoaXMuY29udHJvbEludGVyY2VwdG9ycyl7XHJcbiAgICAgICAgICAgIGNvbnRyb2xJbnRlcmNlcHRvci5pbnRlcmNlcHQoaW50ZXJjZXB0Q29udGV4dCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0UHJvY2Vzc0NvbnRleHQoKTpQcm9jZXNzQ29udGV4dHtcclxuICAgICAgICBjb25zdCBwcm9jZXNzQ29udGV4dCA9IG5ldyAgUHJvY2Vzc0NvbnRleHQoKTtcclxuICAgICAgICBjb25zdCBpc0luV2YgPSBFbnZVdGlsLmlzSW5XZigpO1xyXG4gICAgICAgIHByb2Nlc3NDb250ZXh0LmlzSW5XZiA9IGlzSW5XZjtcclxuICAgICAgICBpZiAoaXNJbldmID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gcHJvY2Vzc0NvbnRleHRcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGlmcmFtZSA9IHdpbmRvdy5wYXJlbnQuZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaWZyYW1lJyk7XHJcbiAgICAgICAgaWYgKCFpZnJhbWUgfHwgIWlmcmFtZS5zcmMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3NDb250ZXh0XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBxdWVyeVBhcmFtcyA9IFVybFV0aWwuZ2V0UGFyYW1zKGlmcmFtZS5zcmMpO1xyXG4gICAgICAgIGlmICghcXVlcnlQYXJhbXMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3NDb250ZXh0XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwcm9jZXNzQ29udGV4dC51aVN0YXRlSW5Qcm9jZXNzID0gcXVlcnlQYXJhbXMuVUlTdGF0ZUluUHJvY2VzcztcclxuICAgICAgICBwcm9jZXNzQ29udGV4dC5mb3JtQ29uZmlnSWQgPSBxdWVyeVBhcmFtcy5mb3JtQ29uZmlnSWQ7XHJcblxyXG4gICAgICAgIHJldHVybiBwcm9jZXNzQ29udGV4dFxyXG4gICAgfVxyXG4gICAgXHJcblxyXG59XHJcblxyXG4iXX0=