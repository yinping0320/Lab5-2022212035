/*
 * @Author: Witt
 * @Date: 2018-11-17 13:38:23
 * @Last Modified by: Witt
 * @Last Modified time: 2018-11-17 13:38:50
 * @todo：临时删除原有功能，待重构
 */
import { Subject } from 'rxjs';
import { UIStateMetadataUtil } from './uistate_metadata_util';
import { ControlStateListener } from './control-state/control_state_listener';
/**
 * UI状态
 */
export class UIState {
    constructor() {
        this.changes = new Subject();
        this.innerData = Object.assign({});
        this._init();
    }
    _init() {
        const construct = this.constructor;
        const uiFields = UIStateMetadataUtil.getUIFields(construct);
        const controlFields = UIStateMetadataUtil.getControlFields(construct);
        this.initializeUIField(uiFields);
        this.initializeControlField(controlFields);
    }
    //注册监听
    config(viewModelContext) {
        const construct = this.constructor;
        const controlFields = UIStateMetadataUtil.getControlFields(construct);
        if (controlFields && Object.keys(controlFields).length > 0) {
            this.controlStateListener = viewModelContext.injector.get(ControlStateListener);
        }
    }
    initializeUIField(uiFieldMetadata) {
        Object.keys(uiFieldMetadata).forEach(propertyName => {
            const fieldMetadata = uiFieldMetadata[propertyName];
            const uiField = fieldMetadata.stateName || propertyName;
            if (delete this[propertyName]) {
                this.defineProperty(propertyName, uiField);
            }
        });
    }
    initializeControlField(controlFieldMetadata) {
        Object.keys(controlFieldMetadata).forEach(propertyName => {
            const fieldMetadata = controlFieldMetadata[propertyName];
            const uiField = fieldMetadata.stateName || propertyName;
            if (delete this[propertyName]) {
                this.defineProperty(propertyName, uiField);
            }
        });
    }
    isExistProperty(propertyName) {
        if (this.innerData.hasOwnProperty(propertyName) || this.hasOwnProperty(propertyName)) {
            return true;
        }
        return false;
    }
    defineProperty(propertyName, field = null) {
        Object.defineProperty(this, propertyName, {
            get: function () {
                return field !== null ? this.innerData[field] : this.innerData[propertyName];
            },
            set: function (value) {
                // 值相同时不触发变更
                const oldValue = field !== null ? this.innerData[field] : this.innerData[propertyName];
                if (oldValue === value) {
                    return;
                }
                if (field !== null) {
                    this.innerData[field] = value;
                }
                else {
                    this.innerData[propertyName] = value;
                }
                this.changes.next({
                    field: propertyName,
                    value: value
                });
            }
        });
    }
    setPropertyValue(propertyName, value) {
        if (propertyName === '' || propertyName === undefined) {
            return;
        }
        if (!this.isExistProperty(propertyName)) {
            this.defineProperty(propertyName);
        }
        this[propertyName] = value;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidWlfc3RhdGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvdWktc3RhdGUvdWlfc3RhdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBRUgsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUc5RCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQVE5RTs7R0FFRztBQUNILE1BQU0sT0FBTyxPQUFPO0lBUWxCO1FBQ0UsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLE9BQU8sRUFBMEIsQ0FBQztRQUVyRCxJQUFJLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ2YsQ0FBQztJQUVELEtBQUs7UUFDSCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDO1FBQ25DLE1BQU0sUUFBUSxHQUFHLG1CQUFtQixDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUM1RCxNQUFNLGFBQWEsR0FBRyxtQkFBbUIsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUV0RSxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDakMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxNQUFNO0lBQ04sTUFBTSxDQUFDLGdCQUFnQjtRQUNyQixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDO1FBQ25DLE1BQU0sYUFBYSxHQUFHLG1CQUFtQixDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXRFLElBQUcsYUFBYSxJQUFJLE1BQU0sQ0FBQyxJ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ZUFBZSxDQUFDLFlBQVksQ0FBQyxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLENBQUM7U0FDbkM7UUFDRCxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsS0FBSyxDQUFDO0lBQzdCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBAQXV0aG9yOiBXaXR0XG4gKiBARGF0ZTogMjAxOC0xMS0xNyAxMzozODoyM1xuICogQExhc3QgTW9kaWZpZWQgYnk6IFdpdHRcbiAqIEBMYXN0IE1vZGlmaWVkIHRpbWU6IDIwMTgtMTEtMTcgMTM6Mzg6NTBcbiAqIEB0b2Rv77ya5Li05pe25Yig6Zmk5Y6f5pyJ5Yqf6IO977yM5b6F6YeN5p6EXG4gKi9cblxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgVUlTdGF0ZU1ldGFkYXRhVXRpbCB9IGZyb20gJy4vdWlzdGF0ZV9tZXRhZGF0YV91dGlsJztcbmltcG9ydCB7IFVJU3RhdGVQcm9wTWV0YWRhdGEgfSBmcm9tICcuL2RlY29yYXRvcnMnO1xuaW1wb3J0IHsgQ29udHJvbFN0YXRlUHJvcE1ldGFkYXRhIH0gZnJvbSAnLi9jb250cm9sX2RlY29yYXRvcnMnO1xuaW1wb3J0IHsgQ29udHJvbFN0YXRlTGlzdGVuZXIgfSBmcm9tICcuL2NvbnRyb2wtc3RhdGUvY29udHJvbF9zdGF0ZV9saXN0ZW5lcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVUlTdGF0ZU9ic2VydmFibGVQYXJhbSB7XG4gIGZpZWxkOiBzdHJpbmc7XG4gIHZhbHVlOiBhbnk7XG59XG5cblxuLyoqXG4gKiBVSeeKtuaAgVxuICovXG5leHBvcnQgY2xhc3MgVUlTdGF0ZSB7XG5cbiAgaW5uZXJEYXRhOiB7fTtcblxuICAvLyDnm5HlkKzlj5jljJZcbiAgY2hhbmdlczogU3ViamVjdDxVSVN0YXRlT2JzZXJ2YWJsZVBhcmFtPjtcbiAgcHVibGljIGNvbnRyb2xTdGF0ZUxpc3RlbmVyOkNvbnRyb2xTdGF0ZUxpc3RlbmVyO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuY2hhbmdlcyA9IG5ldyBTdWJqZWN0PFVJU3RhdGVPYnNlcnZhYmxlUGFyYW0+KCk7XG5cbiAgICB0aGlzLmlubmVyRGF0YSA9IE9iamVjdC5hc3NpZ24oe30pO1xuICAgIHRoaXMuX2luaXQoKTtcbiAgfVxuXG4gIF9pbml0KCkge1xuICAgIGNvbnN0IGNvbnN0cnVjdCA9IHRoaXMuY29uc3RydWN0b3I7XG4gICAgY29uc3QgdWlGaWVsZHMgPSBVSVN0YXRlTWV0YWRhdGFVdGlsLmdldFVJRmllbGRzKGNvbnN0cnVjdCk7XG4gICAgY29uc3QgY29udHJvbEZpZWxkcyA9IFVJU3RhdGVNZXRhZGF0YVV0aWwuZ2V0Q29udHJvbEZpZWxkcyhjb25zdHJ1Y3QpO1xuXG4gICAgdGhpcy5pbml0aWFsaXplVUlGaWVsZCh1aUZpZWxkcyk7XG4gICAgdGhpcy5pbml0aWFsaXplQ29udHJvbEZpZWxkKGNvbnRyb2xGaWVsZHMpO1xuICB9XG5cbiAgLy/ms6jlhoznm5HlkKxcbiAgY29uZmlnKHZpZXdNb2RlbENvbnRleHQpe1xuICAgIGNvbnN0IGNvbnN0cnVjdCA9IHRoaXMuY29uc3RydWN0b3I7XG4gICAgY29uc3QgY29udHJvbEZpZWxkcyA9IFVJU3RhdGVNZXRhZGF0YVV0aWwuZ2V0Q29udHJvbEZpZWxkcyhjb25zdHJ1Y3QpO1xuXG4gICAgaWYoY29udHJvbEZpZWxkcyAmJiBPYmplY3Qua2V5cyhjb250cm9sRmllbGRzKS5sZW5ndGggPiAwKXtcbiAgICAgIHRoaXMuY29udHJvbFN0YXRlTGlzdGVuZXIgPSB2aWV3TW9kZWxDb250ZXh0LmluamVjdG9yLmdldChDb250cm9sU3RhdGVMaXN0ZW5lcik7XG5cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGluaXRpYWxpemVVSUZpZWxkKHVpRmllbGRNZXRhZGF0YTogeyBba2V5OiBzdHJpbmddOiBVSVN0YXRlUHJvcE1ldGFkYXRhIH0pOiB2b2lkIHtcbiAgICBPYmplY3Qua2V5cyh1aUZpZWxkTWV0YWRhdGEpLmZvckVhY2gocHJvcGVydHlOYW1lID0+IHtcbiAgICAgIGNvbnN0IGZpZWxkTWV0YWRhdGEgPSB1aUZpZWxkTWV0YWRhdGFbcHJvcGVydHlOYW1lXSBhcyBVSVN0YXRlUHJvcE1ldGFkYXRhO1xuICAgICAgY29uc3QgdWlGaWVsZCA9IGZpZWxkTWV0YWRhdGEuc3RhdGVOYW1lIHx8IHByb3BlcnR5TmFtZTtcblxuICAgICAgaWYgKGRlbGV0ZSB0aGlzW3Byb3BlcnR5TmFtZV0pIHtcbiAgICAgICAgdGhpcy5kZWZpbmVQcm9wZXJ0eShwcm9wZXJ0eU5hbWUsIHVpRmllbGQpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0aWFsaXplQ29udHJvbEZpZWxkKGNvbnRyb2xGaWVsZE1ldGFkYXRhOiB7IFtrZXk6IHN0cmluZ106IENvbnRyb2xTdGF0ZVByb3BNZXRhZGF0YSB9KTogdm9pZCB7XG4gICAgT2JqZWN0LmtleXMoY29udHJvbEZpZWxkTWV0YWRhdGEpLmZvckVhY2gocHJvcGVydHlOYW1lID0+IHtcbiAgICAgIGNvbnN0IGZpZWxkTWV0YWRhdGEgPSBjb250cm9sRmllbGRNZXRhZGF0YVtwcm9wZXJ0eU5hbWVdIGFzIENvbnRyb2xTdGF0ZVByb3BNZXRhZGF0YTtcbiAgICAgIGNvbnN0IHVpRmllbGQgPSBmaWVsZE1ldGFkYXRhLnN0YXRlTmFtZSB8fCBwcm9wZXJ0eU5hbWU7XG5cbiAgICAgIGlmIChkZWxldGUgdGhpc1twcm9wZXJ0eU5hbWVdKSB7XG4gICAgICAgIHRoaXMuZGVmaW5lUHJvcGVydHkocHJvcGVydHlOYW1lLCB1aUZpZWxkKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBpc0V4aXN0UHJvcGVydHkocHJvcGVydHlOYW1lOiBhbnkpIHtcbiAgICBpZiAodGhpcy5pbm5lckRhdGEuaGFzT3duUHJvcGVydHkocHJvcGVydHlOYW1lKSB8fCB0aGlzLmhhc093blByb3BlcnR5KHByb3BlcnR5TmFtZSkpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGRlZmluZVByb3BlcnR5KHByb3BlcnR5TmFtZTogYW55LCBmaWVsZDogYW55ID0gbnVsbCkge1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBwcm9wZXJ0eU5hbWUsIHtcbiAgICAgIGdldDogZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gZmllbGQgIT09IG51bGwgPyB0aGlzLmlubmVyRGF0YVtmaWVsZF0gOiB0aGlzLmlubmVyRGF0YVtwcm9wZXJ0eU5hbWVdO1xuICAgICAgfSxcbiAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgIC8vIOWAvOebuOWQjOaXtuS4jeinpuWPkeWPmOabtFxuICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IGZpZWxkICE9PSBudWxsID8gdGhpcy5pbm5lckRhdGFbZmllbGRdIDogdGhpcy5pbm5lckRhdGFbcHJvcGVydHlOYW1lXTtcbiAgICAgICAgaWYgKG9sZFZhbHVlID09PSB2YWx1ZSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZmllbGQgIT09IG51bGwpIHtcbiAgICAgICAgICB0aGlzLmlubmVyRGF0YVtmaWVsZF0gPSB2YWx1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmlubmVyRGF0YVtwcm9wZXJ0eU5hbWVdID0gdmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jaGFuZ2VzLm5leHQoe1xuICAgICAgICAgIGZpZWxkOiBwcm9wZXJ0eU5hbWUsXG4gICAgICAgICAgdmFsdWU6IHZhbHVlXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHNldFByb3BlcnR5VmFsdWUocHJvcGVydHlOYW1lOiBhbnksIHZhbHVlOiBhbnkpIHtcbiAgICBpZiAocHJvcGVydHlOYW1lID09PSAnJyB8fCBwcm9wZXJ0eU5hbWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuaXNFeGlzdFByb3BlcnR5KHByb3BlcnR5TmFtZSkpIHtcbiAgICAgIHRoaXMuZGVmaW5lUHJvcGVydHkocHJvcGVydHlOYW1lKTtcbiAgICB9XG4gICAgdGhpc1twcm9wZXJ0eU5hbWVdID0gdmFsdWU7XG4gIH1cbn1cbiJdfQ==