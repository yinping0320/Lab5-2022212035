import { __spread, __assign, __values, __generator, __extends, __read } from 'tslib';
import { of, from, Subject, Observable, isObservable as isObservable$1, forkJoin, BehaviorSubject, EMPTY as EMPTY$1 } from 'rxjs';
import { switchMap, map, shareReplay, tap, catchError, concatMap, every, take, throwIfEmpty, takeLast } from 'rxjs/operators';
import axios from 'axios';
import 'reflect-metadata';
import { format, parseISO, isDate, isEqual as isEqual$1, compareAsc } from 'date-fns';
import dayjs from 'dayjs';
import IsBetween from 'dayjs/plugin/IsBetween';
import relativeTime from 'dayjs/plugin/relativeTime';
import Calendar from 'dayjs/plugin/calendar';
import 'dayjs/locale/zh-cn';
import { Expression as Expression$1, ExpressionEngine, ExpressionContext } from '@farris/expression-engine';

var Type = Function;
var DataChangeType;
(function (DataChangeType) {
    DataChangeType[DataChangeType["Add"] = 0] = "Add";
    DataChangeType[DataChangeType["Delete"] = 1] = "Delete";
    DataChangeType[DataChangeType["Edit"] = 2] = "Edit";
    DataChangeType[DataChangeType["Append"] = 3] = "Append";
})(DataChangeType || (DataChangeType = {}));

function isType(v) {
    return typeof v === 'function';
}
var InjectFlags;
(function (InjectFlags) {
    InjectFlags[InjectFlags["Default"] = 0] = "Default";
    InjectFlags[InjectFlags["Self"] = 1] = "Self";
    InjectFlags[InjectFlags["SkipSelf"] = 2] = "SkipSelf";
    InjectFlags[InjectFlags["Optional"] = 4] = "Optional";
})(InjectFlags || (InjectFlags = {}));

var EMPTY = [];
var IDENT = function (value) {
    return value;
};
var CIRCULAR = IDENT;
var MULTI_PROVIDER_FN = function () {
    return Array.prototype.slice.call(arguments);
};
var NEW_LINE = /\n/gm;
var NO_NEW_LINE = 'ɵ';
var _THROW_IF_NOT_FOUND = {};
var THROW_IF_NOT_FOUND = _THROW_IF_NOT_FOUND;
var NG_TEMP_TOKEN_PATH = 'ngTempTokenPath';

function stringify(token) {
    if (typeof token === 'string') {
        return token;
    }
    if (Array.isArray(token)) {
        return '[' + token.map(stringify).join(', ') + ']';
    }
    if (token == null) {
        return '' + token;
    }
    if (token.overriddenName) {
        return "" + token.overriddenName;
    }
    if (token.name) {
        return "" + token.name;
    }
    var res = token.toString();
    if (res == null) {
        return '' + res;
    }
    var newLineIndex = res.indexOf('\n');
    return newLineIndex === -1 ? res : res.substring(0, newLineIndex);
}
function getClosureSafeProperty(objWithPropertyToExtract) {
    for (var key in objWithPropertyToExtract) {
        if (objWithPropertyToExtract[key] === getClosureSafeProperty) {
            return key;
        }
    }
    throw Error('Could not find renamed property on target object.');
}
function formatError(text, obj, injectorErrorName, source) {
    if (source === void 0) { source = null; }
    text = text && text.charAt(0) === '\n' && text.charAt(1) == NO_NEW_LINE ? text.substr(2) : text;
    var context = stringify(obj);
    if (Array.isArray(obj)) {
        context = obj.map(stringify).join(' -> ');
    }
    else if (typeof obj === 'object') {
        var parts = [];
        for (var key in obj) {
            if (obj.hasOwnProperty(key)) {
                var value = obj[key];
                parts.push(key + ':' + (typeof value === 'string' ? JSON.stringify(value) : stringify(value)));
            }
        }
        context = "{" + parts.join(', ') + "}";
    }
    return "" + injectorErrorName + (source ? '(' + source + ')' : '') + "[" + context + "]: " + text.replace(NEW_LINE, '\n  ');
}
function staticError(text, obj) {
    return new Error(formatError(text, obj, 'StaticInjectorError'));
}

function ɵɵdefineInjectable(opts) {
    return {
        token: opts.token,
        providedIn: opts.providedIn || null,
        factory: opts.factory,
        value: undefined,
    };
}
var NG_PROV_DEF = getClosureSafeProperty({ ɵprov: getClosureSafeProperty });
var NG_INJ_DEF = getClosureSafeProperty({ ɵinj: getClosureSafeProperty });
var NG_INJECTABLE_DEF = getClosureSafeProperty({ ngInjectableDef: getClosureSafeProperty });
function getOwnDefinition(type, def) {
    return def && def.token === type ? def : null;
}
function getInjectableDef(type) {
    return getOwnDefinition(type, type[NG_PROV_DEF]) ||
        getOwnDefinition(type, type[NG_INJECTABLE_DEF]);
}

var InjectionToken = /** @class */ (function () {
    function InjectionToken(_desc, options) {
        this._desc = _desc;
        this.ngMetadataName = 'InjectionToken';
        this.ɵprov = undefined;
        if (typeof options === 'number') {
            this.__NG_ELEMENT_ID__ = options;
        }
        else if (options !== undefined) {
            this.ɵprov = ɵɵdefineInjectable({
                token: this,
                providedIn: options.providedIn || 'root',
                factory: options.factory,
            });
        }
    }
    InjectionToken.prototype.toString = function () {
        return "InjectionToken " + this._desc;
    };
    return InjectionToken;
}());
function createInjectionToken(token) {
    return new InjectionToken(token);
}

/**
 * 注入器抽象类
 */
var Injector = /** @class */ (function () {
    function Injector() {
    }
    return Injector;
}());

var NullInjector = /** @class */ (function () {
    function NullInjector() {
    }
    NullInjector.prototype.get = function (token, notFoundValue) {
        if (notFoundValue === void 0) { notFoundValue = THROW_IF_NOT_FOUND; }
        if (notFoundValue === THROW_IF_NOT_FOUND) {
            var error = new Error("NullInjectorError: No provider for " + stringify(token) + "!");
            error.name = 'NullInjectorError';
            throw error;
        }
        return notFoundValue;
    };
    return NullInjector;
}());
var NULL_INJECTOR = new NullInjector();

var __forward_ref__ = getClosureSafeProperty({ __forward_ref__: getClosureSafeProperty });
function resolveForwardRef(type) {
    return isForwardRef(type) ? type() : type;
}
function forwardRef(forwardRefFn) {
    forwardRefFn.__forward_ref__ = forwardRef;
    forwardRefFn.toString = function () {
        return stringify(this());
    };
    return forwardRefFn;
}
function isForwardRef(fn) {
    return typeof fn === 'function' && fn.hasOwnProperty(__forward_ref__) &&
        fn.__forward_ref__ === forwardRef;
}

var INJECTOR = new InjectionToken('INJECTOR', -1);
var ɵ0 = getClosureSafeProperty;
var USE_VALUE = getClosureSafeProperty({ provide: String, useValue: ɵ0 });
var _currentInjector = undefined;
function setCurrentInjector(injector) {
    var former = _currentInjector;
    _currentInjector = injector;
    return former;
}
var StaticInjector = /** @class */ (function () {
    function StaticInjector(providers, parent, source) {
        if (parent === void 0) { parent = NULL_INJECTOR; }
        if (source === void 0) { source = null; }
        parent = parent ? parent : NULL_INJECTOR;
        this.parent = parent;
        this.source = source;
        var records = this._records = new Map();
        records.set(Injector, { token: Injector, fn: IDENT, deps: EMPTY, value: this, useNew: false });
        records.set(INJECTOR, { token: INJECTOR, fn: IDENT, deps: EMPTY, value: this, useNew: false });
        this.scope = recursivelyProcessProviders(records, providers);
    }
    StaticInjector.prototype.get = function (token, notFoundValue, flags) {
        if (flags === void 0) { flags = InjectFlags.Default; }
        var records = this._records;
        var record = records.get(token);
        if (record === undefined) {
            var injectableDef = getInjectableDef(token);
            if (injectableDef) {
                var providedIn = injectableDef && injectableDef.providedIn;
                if (providedIn === 'any' || providedIn != null && providedIn === this.scope) {
                    records.set(token, record = resolveProvider({ provide: token, useFactory: injectableDef.factory, deps: EMPTY }));
                }
            }
            if (record === undefined) {
                records.set(token, null);
            }
        }
        var lastInjector = setCurrentInjector(this);
        try {
            return tryResolveToken(token, record, records, this.parent, notFoundValue, flags);
        }
        catch (e) {
            throw e;
        }
        finally {
            setCurrentInjector(lastInjector);
        }
    };
    StaticInjector.prototype.toString = function () {
        var tokens = [];
        var records = this._records;
        records.forEach(function (v, token) { return tokens.push(stringify(token)); });
        return "StaticInjector[" + tokens.join(', ') + "]";
    };
    return StaticInjector;
}());
function multiProviderMixError(token) {
    return staticError('Cannot mix multi providers and regular providers', token);
}
var INJECTOR_SCOPE = new InjectionToken('Set Injector scope.');
/**
 * 递归处理Provider
 */
function recursivelyProcessProviders(records, provider) {
    var scope = null;
    if (provider) {
        provider = resolveForwardRef(provider);
        if (Array.isArray(provider)) {
            for (var i = 0; i < provider.length; i++) {
                scope = recursivelyProcessProviders(records, provider[i]) || scope;
            }
        }
        else if (typeof provider === 'function') {
            throw staticError('Function/Class not supported', provider);
        }
        else if (provider && typeof provider === 'object' && provider.provide) {
            var token = resolveForwardRef(provider.provide);
            var resolvedProvider = resolveProvider(provider);
            // multi
            if (provider.multi === true) {
                var multiProvider = records.get(token);
                if (multiProvider) {
                    if (multiProvider.fn !== MULTI_PROVIDER_FN) {
                        throw multiProviderMixError(token);
                    }
                }
                else {
                    records.set(token, multiProvider = {
                        token: provider.provide,
                        deps: [],
                        useNew: false,
                        fn: MULTI_PROVIDER_FN,
                        value: EMPTY
                    });
                }
                token = provider;
                multiProvider.deps.push({ token: token, options: 6 /* Default */ });
            }
            var record = records.get(token);
            if (record && record.fn === MULTI_PROVIDER_FN) {
                throw multiProviderMixError(token);
            }
            if (token === INJECTOR_SCOPE) {
                scope = resolvedProvider.value;
            }
            records.set(token, resolvedProvider);
        }
        else {
            throw staticError('Unexpected provider', provider);
        }
    }
    return scope;
}
function resolveProvider(provider) {
    var deps = computeDeps(provider);
    var fn = IDENT;
    var value = EMPTY;
    var useNew = false;
    var provide = resolveForwardRef(provider.provide);
    if (USE_VALUE in provider) {
        value = provider.useValue;
    }
    else if (provider.useFactory) {
        fn = provider.useFactory;
    }
    else if (provider.useExisting) {
        // Just use IDENT
    }
    else if (provider.useClass) {
        // 静态类型
        useNew = true;
        fn = resolveForwardRef(provider.useClass);
    }
    else if (typeof provide === 'function') {
        // 构造函数
        useNew = true;
        fn = provide;
    }
    else {
        throw staticError('StaticProvider does not have [useValue|useFactory|useExisting|useClass] or [provide] is not newable', provider);
    }
    return { deps: deps, fn: fn, useNew: useNew, value: value };
}
/**
 * 计算依赖
 */
function computeDeps(provider) {
    var deps = EMPTY;
    var providerDeps = provider.deps;
    if (providerDeps && providerDeps.length) {
        deps = [];
        for (var i = 0; i < providerDeps.length; i++) {
            var options = 6 /* Default */;
            var token = resolveForwardRef(providerDeps[i]);
            deps.push({ token: token, options: options });
        }
    }
    else if (provider.useExisting) {
        var token = resolveForwardRef(provider.useExisting);
        deps = [{ token: token, options: 6 /* Default */ }];
    }
    else if (!providerDeps && !(USE_VALUE in provider)) {
        // useValue & useExisting are the only ones which are exempt from deps all others need it.
        throw staticError('\'deps\' required', provider);
    }
    return deps;
}
function tryResolveToken(token, record, records, parent, notFoundValue, flags) {
    try {
        return resolveToken(token, record, records, parent, notFoundValue, flags);
    }
    catch (e) {
        if (!(e instanceof Error)) {
            e = new Error(e);
        }
        var path = e[NG_TEMP_TOKEN_PATH] = e[NG_TEMP_TOKEN_PATH] || [];
        path.unshift(token);
        // 清空循环引用的值
        if (record && record.value === CIRCULAR) {
            record.value = EMPTY;
        }
        throw e;
    }
}
function resolveToken(token, record, records, parent, notFoundValue, flags) {
    var _a;
    var value;
    if (record && !(flags & InjectFlags.SkipSelf)) {
        value = record.value;
        if (value === CIRCULAR) {
            throw Error(NO_NEW_LINE + 'Circular dependency');
        }
        else if (value === EMPTY) {
            record.value = CIRCULAR;
            var useNew = record.useNew;
            var fn = record.fn;
            var depRecords = record.deps;
            var deps = EMPTY;
            if (depRecords.length) {
                deps = [];
                for (var i = 0; i < depRecords.length; i++) {
                    var depRecord = depRecords[i];
                    var options = depRecord.options;
                    var childRecord = options & 2 /* CheckSelf */ ? records.get(depRecord.token) : undefined;
                    deps.push(tryResolveToken(depRecord.token, childRecord, records, !childRecord && !(options & 4 /* CheckParent */) ? NULL_INJECTOR : parent, options & 1 /* Optional */ ? null : THROW_IF_NOT_FOUND, InjectFlags.Default));
                }
            }
            record.value = value = useNew ? new ((_a = fn).bind.apply(_a, __spread([void 0], deps)))() : fn.apply(undefined, deps);
        }
    }
    else if (!(flags & InjectFlags.Self)) {
        value = parent.get(token, notFoundValue, InjectFlags.Default);
    }
    else if (!(flags & InjectFlags.Optional)) {
        value = NULL_INJECTOR.get(token, notFoundValue);
    }
    else {
        value = NULL_INJECTOR.get(token, typeof notFoundValue !== 'undefined' ? notFoundValue : null);
    }
    return value;
}

function INJECTOR_IMPL__PRE_R3__(providers, parent, name) {
    return new StaticInjector(providers, parent, name);
}
var INJECTOR_IMPL = INJECTOR_IMPL__PRE_R3__;
function createInjector(options, parent) {
    if (Array.isArray(options)) {
        return INJECTOR_IMPL(options, parent, '');
    }
    else {
        return INJECTOR_IMPL(options.providers, options.parent, options.name || '');
    }
}

var ANNOTATIONS = '__annotations__';
var PARAMETERS = '__parameters__';
var PROP_METADATA = '__prop__metadata__';
/**
 * @suppress {globalThis}
 */
function makeDecorator(name, props, parentClass, chainFn, typeFn) {
    var metaCtor = makeMetadataCtor(props);
    function DecoratorFactory() {
        var _a;
        var args = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            args[_i] = arguments[_i];
        }
        if (this instanceof DecoratorFactory) {
            metaCtor.call.apply(metaCtor, __spread([this], args));
            return this;
        }
        var annotationInstance = new ((_a = DecoratorFactory).bind.apply(_a, __spread([void 0], args)))();
        var typeDecorator = function createTypeDecorator(cls) {
            typeFn && typeFn.apply(void 0, __spread([cls], args));
            // Use of Object.defineProperty is important since it creates non-enumerable property which
            // prevents the property is copied during subclassing.
            var annotations = cls.hasOwnProperty(ANNOTATIONS) ?
                cls[ANNOTATIONS] :
                Object.defineProperty(cls, ANNOTATIONS, { value: [] })[ANNOTATIONS];
            annotations.push(annotationInstance);
            return cls;
        };
        if (chainFn) {
            chainFn(typeDecorator);
        }
        return typeDecorator;
    }
    if (parentClass) {
        DecoratorFactory.prototype = Object.create(parentClass.prototype);
    }
    DecoratorFactory.prototype.ngMetadataName = name;
    DecoratorFactory.annotationCls = DecoratorFactory;
    return DecoratorFactory;
}
function makeMetadataCtor(props) {
    return function ctor() {
        var args = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            args[_i] = arguments[_i];
        }
        if (props) {
            var values = props.apply(void 0, __spread(args));
            // tslint:disable-next-line:forin
            for (var propName in values) {
                this[propName] = values[propName];
            }
        }
    };
}
function makeParamDecorator(name, props, parentClass) {
    var metaCtor = makeMetadataCtor(props);
    function ParamDecoratorFactory() {
        var _a;
        var args = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            args[_i] = arguments[_i];
        }
        if (this instanceof ParamDecoratorFactory) {
            metaCtor.apply(this, args);
            return this;
        }
        var annotationInstance = new ((_a = ParamDecoratorFactory).bind.apply(_a, __spread([void 0], args)))();
        ParamDecorator.annotation = annotationInstance;
        return ParamDecorator;
        function ParamDecorator(cls, unusedKey, index) {
            // Use of Object.defineProperty is important since it creates non-enumerable property which
            // prevents the property is copied during subclassing.
            var parameters = cls.hasOwnProperty(PARAMETERS) ?
                cls[PARAMETERS] :
                Object.defineProperty(cls, PARAMETERS, { value: [] })[PARAMETERS];
            // there might be gaps if some in between parameters do not have annotations.
            // we pad with nulls.
            while (parameters.length <= index) {
                parameters.push(null);
            }
            (parameters[index] = parameters[index] || []).push(annotationInstance);
            return cls;
        }
    }
    if (parentClass) {
        ParamDecoratorFactory.prototype = Object.create(parentClass.prototype);
    }
    ParamDecoratorFactory.prototype.ngMetadataName = name;
    ParamDecoratorFactory.annotationCls = ParamDecoratorFactory;
    return ParamDecoratorFactory;
}
function makePropDecorator(name, props, parentClass) {
    var metaCtor = makeMetadataCtor(props);
    function PropDecoratorFactory() {
        var _a;
        var args = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            args[_i] = arguments[_i];
        }
        if (this instanceof PropDecoratorFactory) {
            metaCtor.apply(this, args);
            return this;
        }
        var decoratorInstance = new ((_a = PropDecoratorFactory).bind.apply(_a, __spread([void 0], args)))();
        // tslint:disable-next-line:no-shadowed-variable
        return function PropDecorator(target, name) {
            var constructor = target.constructor;
            // Use of Object.defineProperty is important since it creates non-enumerable property which
            // prevents the property is copied during subclassing.
            var meta = constructor.hasOwnProperty(PROP_METADATA) ?
                constructor[PROP_METADATA] :
                Object.defineProperty(constructor, PROP_METADATA, { value: {} })[PROP_METADATA];
            meta[name] = meta.hasOwnProperty(name) && meta[name] || [];
            meta[name].unshift(decoratorInstance);
        };
    }
    if (parentClass) {
        PropDecoratorFactory.prototype = Object.create(parentClass.prototype);
    }
    PropDecoratorFactory.prototype.ngMetadataName = name;
    PropDecoratorFactory.annotationCls = PropDecoratorFactory;
    return PropDecoratorFactory;
}

/**
 * 元数据解析
 * 约束：
 * 1、类型装饰器：在某个类型上，某种类型的装饰器，只使用一次，不重复添加；
 * 2、属性装饰器：在某个属性上，某种类型的装饰器，只使用一次，不重复添加
 */
var MetadataUtil = /** @class */ (function () {
    function MetadataUtil() {
    }
    // ----------------------------------------
    // 类型元数据
    // ----------------------------------------
    /**
     * 获取类元数据
     * 返回结果形如：
     * [
     *   Injectable
     *   NgViewModel
     *   NgViewModel
     * ]
     */
    MetadataUtil.getClassMetadatas = function (constructor) {
        var metadatas = constructor[ANNOTATIONS];
        return metadatas;
    };
    /**
     * 获取某个class上的某种装饰器
     * 返回结果：NgViewModel
     */
    MetadataUtil.getClassMetadataByName = function (constructor, metadataName) {
        var metadata = this.getClassMetadataByNameWithTranslate(constructor, metadataName, null, null);
        return metadata;
    };
    MetadataUtil.getClassMetadataByNameWithTranslate = function (constructor, metadataName, translateService, keysToTranslate) {
        var allClassMetadatas = this.getClassMetadatas(constructor);
        if (!allClassMetadatas) {
            return null;
        }
        var metadata = allClassMetadatas.find(function (classMetadata) {
            return classMetadata.ngMetadataName === metadataName;
        });
        if (metadata && translateService && keysToTranslate) {
            keysToTranslate.forEach(function (metadataPropKey) {
                var propertyVariable = metadata[metadataPropKey];
                if (propertyVariable && propertyVariable.startsWith('{{') && propertyVariable.endsWith('}}')) {
                    var translateKey = propertyVariable.replace('{{', '').replace('}}', '').trim();
                    metadata[metadataPropKey] = translateService.transform(translateKey, null);
                }
            });
        }
        return metadata;
    };
    // ----------------------------------------
    // 属性元数据
    // ----------------------------------------
    /**
     * 获取所有属性的所有元数据
     * 返回格式：
     * {
     *   propName1: [ NgDefaultValue, NgMaxLength, NgMinLength],
     *   propName2: [ NgDefaultValue, NgMaxLength, NgMinLength]
     * }
     */
    MetadataUtil.getPropsMetadatas = function (constructor) {
        var allPropMetadatas = constructor[PROP_METADATA];
        return allPropMetadatas;
    };
    /**
     * 获取所有属性的某一类型的元数据
     * 如果同一属性
     * 返回结果：
     * {
     *    propName1: NgDefaultValue,
     *    propName2: NgDefaultValue
     * }
     */
    MetadataUtil.getPropsMetadatasByName = function (constructor, metadataName) {
        var metadatas = this.getPropsMetadatasByNameWithTranslate(constructor, metadataName);
        return metadatas;
    };
    MetadataUtil.getPropsMetadatasByNameWithTranslate = function (constructor, metadataName, translateService, keysToTranslate) {
        var metadatas = {};
        // 读取构造函数中存储的类属性注解。
        var allPropMetadatas = this.getPropsMetadatas(constructor);
        if (!allPropMetadatas) {
            return metadatas;
        }
        // 遍历所有属性提取注解信息。
        Object.keys(allPropMetadatas).forEach(function (propName) {
            // 提取当前属性注解对象
            var propMetadatas = allPropMetadatas[propName];
            // 提取指定类型的注解项
            var metadata = propMetadatas.find(function (propMetadata) {
                return propMetadata.ngMetadataName === metadataName;
            });
            if (translateService && keysToTranslate) {
                keysToTranslate.forEach(function (metadataPropKey) {
                    var propertyVariable = metadata[metadataPropKey];
                    if (propertyVariable && propertyVariable.startsWith('{{') && propertyVariable.endsWith('}}')) {
                        var translateKey = propertyVariable.replace('{{', '').replace('}}', '').trim();
                        metadata[metadataPropKey] = translateService.transform(translateKey, null);
                    }
                });
            }
            if (metadata) {
                metadatas[propName] = metadata;
            }
        });
        return metadatas;
    };
    /**
     * 获取某个属性的所有元数据
     * 返回格式：[ NgDefaultValue, NgMaxLength, NgMinLength]
     */
    MetadataUtil.getPropMetadatasByName = function (constructor, propName) {
        // 暂不实现
        return null;
    };
    /**
     * 获取某个属性的某种元数据
     * 返回格式：NgDefaultValue
     */
    MetadataUtil.getPropMetadataByName = function (constructor, propName, metadataName) {
        // 暂不实现
        return null;
    };
    return MetadataUtil;
}());

/**
 * HttpMethods
 */
var HttpMethods = /** @class */ (function () {
    function HttpMethods() {
    }
    HttpMethods.GET = 'GET';
    HttpMethods.DELETE = 'DELETE';
    HttpMethods.HEAD = 'HEAD';
    HttpMethods.OPTIONS = 'OPTIONS';
    HttpMethods.POST = 'POST';
    HttpMethods.PUT = 'PUT';
    HttpMethods.PATCH = 'PATCH';
    HttpMethods.LINK = 'LINK';
    HttpMethods.UNLINK = 'UNLINK';
    return HttpMethods;
}());

var HttpUtil = /** @class */ (function () {
    function HttpUtil() {
    }
    /**
     * 追加Header
     */
    HttpUtil.appendHeader = function (headers, key, value) {
        var _a;
        headers = Object.assign({}, headers, (_a = {}, _a[key] = value, _a));
        return headers;
    };
    /**
     * 向RequestConfig中追加body
     */
    HttpUtil.appendBodyToRequestConfig = function (body, requestConfig) {
        if (!requestConfig) {
            requestConfig = {};
        }
        requestConfig = Object.assign({}, requestConfig, { body: body });
        return requestConfig;
    };
    /**
     * 构造AxiosReqeustConfig
     */
    HttpUtil.buildAxiosRequestConfig = function (method, url, requestConfig) {
        requestConfig = requestConfig || {};
        var axiosRequestConfig = {
            url: url,
            method: method,
            params: requestConfig.params || null,
            headers: requestConfig.headers || null,
            responseType: requestConfig.responseType || 'json',
            data: requestConfig.body || null
        };
        return axiosRequestConfig;
    };
    /**
     * 构造Http响应信息
     */
    HttpUtil.buildHttpResponse = function (axiosResponse) {
        var httpResponse = {
            body: axiosResponse.data,
            headers: axiosResponse.headers,
            status: axiosResponse.status,
            statusText: axiosResponse.statusText
        };
        return httpResponse;
    };
    return HttpUtil;
}());

/**
 * HttpClient
 */
var HttpClient = /** @class */ (function () {
    /**
     * 构造函数
     */
    function HttpClient() {
        this.axiosInstance = axios.create();
    }
    /**
     * 发送GET请求
     */
    HttpClient.prototype.get = function (url, requestConfig) {
        return this.request('GET', url, requestConfig);
    };
    /**
     * 发送POST请求
     */
    HttpClient.prototype.post = function (url, body, requestConfig) {
        requestConfig = HttpUtil.appendBodyToRequestConfig(body, requestConfig);
        return this.request('POST', url, requestConfig);
    };
    /**
     * 发送PUT请求
     */
    HttpClient.prototype.put = function (url, body, requestConfig) {
        requestConfig = HttpUtil.appendBodyToRequestConfig(body, requestConfig);
        return this.request('PUT', url, requestConfig);
    };
    /**
     * 发送PATCH请求
     */
    HttpClient.prototype.patch = function (url, body, requestConfig) {
        requestConfig = HttpUtil.appendBodyToRequestConfig(body, requestConfig);
        return this.request('PATCH', url, requestConfig);
    };
    /**
     * 发送DELETE请求
     */
    HttpClient.prototype.delete = function (url, requestConfig) {
        return this.request('DELETE', url, requestConfig);
    };
    /**
     * 发送请求
     */
    HttpClient.prototype.request = function (method, url, requestConfig) {
        var _this = this;
        var request$ = of(true).pipe(switchMap(function () {
            var axiosRequestConfig = HttpUtil.buildAxiosRequestConfig(method, url, requestConfig);
            return from(_this.axiosInstance.request(axiosRequestConfig));
        }));
        return request$.pipe(map(function (axiosResponse) {
            var httpResponse = HttpUtil.buildHttpResponse(axiosResponse);
            return requestConfig.observe === 'response' ? httpResponse : axiosResponse.data;
        }));
    };
    return HttpClient;
}());

var HTTP_PROVIDERS = [
    { provide: HttpClient, useClass: HttpClient, deps: [] }
];

/**
 * 变更记录
 */
var Modification = /** @class */ (function () {
    /**
     * 构造函数
     * @param value 新值
     * @param modifyType 变更类型
     * @param path 变更路径
     * @param preValue 旧值
     */
    function Modification(value, modifyType, path, preValue, position) {
        this.type = modifyType;
        this.value = value;
        this.preValue = preValue;
        this.path = path;
        this.position = position;
    }
    return Modification;
}());
/**
 * 变更类型
 */
var ModifyType;
(function (ModifyType) {
    /**
     * 添加
     */
    ModifyType["Add"] = "ADD";
    /**
     * 添加数据
     */
    ModifyType["AddData"] = "AddData";
    /**
     * 克隆数据
     */
    ModifyType["Clone"] = "CLONE";
    /**
     * 删除
     */
    ModifyType["Remove"] = "REMOVE";
    ModifyType["RemoveData"] = "RemoveData";
    /**
     * 修改
     */
    ModifyType["ValueChange"] = "VALUE_CHANGE";
    /**
     * 加载
     */
    ModifyType["Load"] = "LOAD";
    /**
     * 未改变
     */
    ModifyType["UnChanged"] = "UNCHANGED";
    /**
     * 分页信息变更
     */
    ModifyType["PaginationInfoChange"] = "PAGINATION_INFO_CHANGE";
    /**
     * 插入
     */
    ModifyType["Insert"] = "Insert";
    /**
     * 更新实体
     */
    ModifyType["Update"] = "UPDATE";
})(ModifyType || (ModifyType = {}));

/*
 * @Author: Lucus, Witt
 * @Date: 2018-10-30 15:53:59
 * @Last Modified by: Witt
 * @Last Modified time: 2018-11-08 17:25:08
 */
function isEqual(value, other) {
    return JSON.stringify(value) === JSON.stringify(other);
}
/**
 * 实体数据变更集
 */
var ChangeSet = /** @class */ (function () {
    function ChangeSet() {
        /**
         * 变更集合
         */
        this.modifications = [];
    }
    Object.defineProperty(ChangeSet.prototype, "changes", {
        /**
         *  获取所有的变更记录
         */
        get: function () {
            return this.modifications;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 将变更集添加到集合中
     * ### 使用示例
     * ```
     * const changeSet = new ChangeSet();
     * const modify = new Modification('newValue', ModifyType.ValueChange, [1, 'title'], 'oldValue');
     * changeSet.append(modify)
     * ```
     * @param changeItem 变更数据
     */
    ChangeSet.prototype.append = function (modification) {
        switch (modification.type) {
            case ModifyType.ValueChange:
                this.appendValueChangeModification(modification);
                break;
            case ModifyType.Add:
            case ModifyType.Insert:
            case ModifyType.Clone:
                this.appendAddModification(modification);
                break;
            case ModifyType.Remove:
                this.appendRemoveModification(modification);
                break;
            case ModifyType.Load:
                break;
            default:
                throw new Error('不支持此类型的变更');
        }
    };
    /**
     * 添加值变化变更
     */
    ChangeSet.prototype.appendValueChangeModification = function (modification) {
        var value = modification.value;
        var existedModification = this.findModifyItemsPath(modification.path);
        if (existedModification) {
            // 如果存在相同路径的ValueChange类型的变更集，则更新值；
            existedModification.value = value;
        }
        else {
            var existedAddModification = this.findNewAddItemsPath(modification.path);
            if (existedAddModification) {
                // @todo：
                // 1、此处逻辑有问题，value是个字符串，不能直接assign；
                // 2、之所以没有出现问题，是因为都是服务器端新增，新增后，客户端清空了所有变更。
                // 如果存在涵盖该ValueChange变更的Add变更，则更新Add变更对应的数据；
                existedAddModification.value = Object.assign({}, existedAddModification.value, value);
            }
            else {
                // 其他情况，新增一条ValueChange变更。
                this.modifications.push(modification);
            }
        }
    };
    /**
     * 添加新增变更
     */
    ChangeSet.prototype.appendAddModification = function (modification) {
        var value = modification.value;
        var existedModification = this.findNewAddItemsPath(modification.path);
        if (existedModification) {
            // 1、如果已经存在相同路径的Add变更，则合并Value。
            existedModification.value = existedModification.value.concat(value);
        }
        else {
            // 2、如果没有，则新增一条Add变更。
            this.modifications.push(modification);
        }
    };
    /**
     * 添加删除变更
     */
    ChangeSet.prototype.appendRemoveModification = function (modification) {
        var path = modification.path;
        var primaryKey = Object.keys(modification.value)[0];
        var primaryKeyValue = modification.value[primaryKey];
        // 1、存在相同path的新增变更，移除新增变更，不需要添加删除变更；
        // @todo：待重构（1、只考虑了主从情况，2、临时用多重循环实现）
        this.modifications.forEach(function (addModification) {
            // 只处理新增变更
            if (addModification.type !== ModifyType.Add && addModification.type !== ModifyType.Insert && addModification.type !== ModifyType.Clone) {
                return;
            }
            // @todo 只考虑主从结构，再深的层次暂不考虑
            if (isEqual(addModification.path, path) === false) {
                return;
            }
            // 遍历新增新增变更的value（value是个数组），移除相匹配的新增删除
            addModification.value = addModification.value.filter(function (addDataItem) {
                return addDataItem[primaryKey] !== primaryKeyValue;
            });
        });
        // 2、移除对应的修改变更
        var fullRemovePath = path.concat(primaryKey + ":" + primaryKeyValue);
        this.modifications = this.modifications.filter(function (valueModification) {
            if (valueModification.type !== ModifyType.ValueChange) {
                return true;
            }
            var valueChangePath = Array.from(valueModification.path);
            valueChangePath.pop();
            // 路径相同进行移除
            var isToRemove = isEqual(valueChangePath, fullRemovePath);
            return !isToRemove;
        });
        // 先删除下级删除变更，再插入
        // 主要针对从从表删除之后，又删除子表时，根实体上还存在从从表删除变更的场景
        this.removeDescendantRemoveModifications(modification);
        this.modifications.push(modification);
    };
    /**
     * 清空变更集合
     */
    ChangeSet.prototype.clear = function () {
        this.modifications = [];
    };
    /**
     * 根据path获取Add类型的变更记录
     * @param path 变更路径
     */
    ChangeSet.prototype.findNewAddItemsPath = function (path) {
        return this.modifications.find(function (value, index) {
            return isEqual(path, value.path) && (value.type === ModifyType.Add || value.type === ModifyType.Insert || value.type === ModifyType.Clone);
        });
    };
    /**
     * 根据path获取ValueChange类型的变更记录
     * @param path 变更路径
     */
    ChangeSet.prototype.findModifyItemsPath = function (path) {
        return this.modifications.find(function (value, index) {
            return isEqual(path, value.path) && value.type === ModifyType.ValueChange;
        });
    };
    /**
     * 删除后代（包括自己）所有的删除变更
     * @todo：临时做一个最小化修改
     */
    ChangeSet.prototype.removeDescendantRemoveModifications = function (parentRemoveModification) {
        var _this = this;
        var parentPathWithId = this.createRemovePathWithId(parentRemoveModification);
        // 删除后代修改变更
        this.modifications = this.modifications.filter(function (modification) {
            if (modification.type !== ModifyType.Remove) {
                return true;
            }
            var descendantPathWithId = _this.createRemovePathWithId(modification);
            var isDescendant = _this.isDescendantPath(parentPathWithId, descendantPathWithId);
            return !isDescendant;
        });
    };
    /**
     * 获取删除路径的完整格式
     * @summary
     * 1、目前删除变更的路径标记到父集合；
     * 2、为了方便比较，将被删除的数据id加入到路径中
     */
    ChangeSet.prototype.createRemovePathWithId = function (modification) {
        var path = modification.path;
        var primaryKey = Object.keys(modification.value)[0];
        var primaryKeyValue = modification.value[primaryKey];
        var pathWithId = path.concat([primaryKey + ":" + primaryKeyValue]);
        return pathWithId;
    };
    /**
     * 判断是否是后代节点路径
     * @param parentPath 父节点路径
     * @param descendantPath 后代节点
     */
    ChangeSet.prototype.isDescendantPath = function (parentPath, descendantPath) {
        if (parentPath.length > descendantPath.length) {
            return false;
        }
        var isDescendantPath = true;
        parentPath.forEach(function (parentPathItem, parentPathItemIndex) {
            if (parentPathItem !== descendantPath[parentPathItemIndex]) {
                isDescendantPath = false;
                return;
            }
        });
        return isDescendantPath;
    };
    return ChangeSet;
}());

/*
 * @Author: Witt
 * @Date: 2018-12-27 09:25:38
 * @Last Modified by: Witt
 * @Last Modified time: 2018-12-27 09:39:10
 */
/**
 * 路径类型
 */
var DataPathNodeType;
(function (DataPathNodeType) {
    /**
     * 标记该节点是一个实体主键值，用来在列表上定位一个实体
     */
    DataPathNodeType["DataId"] = "DataId";
    /**
     * 标记该节点是一个属性名，用来在对象上定位一个属性
     */
    DataPathNodeType["PropName"] = "PropName";
})(DataPathNodeType || (DataPathNodeType = {}));
/**
 * 路径节点
 */
var DataPathNode = /** @class */ (function () {
    /**
     * 构造函数
     */
    function DataPathNode(type, data) {
        this.type = type;
        this.value = data;
        this.prev = null;
        this.next = null;
    }
    return DataPathNode;
}());

/*
 * @Author: Witt
 * @Date: 2018-12-27 09:26:41
 * @Last Modified by: Witt
 * @Last Modified time: 2019-01-15 22:00:45
 */
/**
 * 变更路径（简单双向列表）
 */
var DataPath = /** @class */ (function () {
    /**
     * 构造函数
     */
    function DataPath() {
        this.head = new DataPathNode(null, null);
        this.length = 0;
    }
    /**
     * 添加一个节点到头部
     */
    DataPath.prototype.unshift = function (type, data) {
        var newNode = new DataPathNode(type, data);
        newNode.next = this.head.next;
        newNode.prev = this.head;
        this.head.next = newNode;
        if (newNode.next) {
            newNode.next.prev = newNode;
        }
        this.length++;
    };
    /**
     * 在链表最后追加一个节点
     */
    DataPath.prototype.push = function (type, data) {
        var tailNode = this.getTail();
        var newNode = new DataPathNode(type, data);
        tailNode.next = newNode;
        this.length++;
    };
    /**
     * 获取链表尾部节点
     */
    DataPath.prototype.getTail = function () {
        var lastNode = this.head;
        while (lastNode.next) {
            lastNode = lastNode.next;
        }
        return lastNode;
    };
    /**
     * 转换为数组格式
     */
    DataPath.prototype.toArray = function () {
        var pathArray = [];
        var currentNode = this.head.next;
        while (currentNode) {
            pathArray.push(currentNode.type + ":" + currentNode.value);
            currentNode = currentNode.next;
        }
        return pathArray;
    };
    /**
     * 转换为字符串格式
     */
    DataPath.prototype.toString = function () {
        var pathArray = this.toArray();
        var pathString = pathArray.join(', ');
        return "[" + pathString + "]";
    };
    /**
     * 拷贝
     */
    DataPath.prototype.clone = function () {
        var newDataPath = new DataPath();
        var curDataNode = this.head.next;
        while (curDataNode) {
            newDataPath.push(curDataNode.type, curDataNode.value);
            curDataNode = curDataNode.next;
        }
        return newDataPath;
    };
    return DataPath;
}());

/*
 * @Author: Witt
 * @Date: 2019-08-14 14:11:51
 * @Last Modified by: Witt
 * @Last Modified time: 2019-08-14 16:11:51
 */
/**
 * 实体属性分组
 */
var DataPropGroup;
(function (DataPropGroup) {
    /**
     * 简单类型
     */
    DataPropGroup["Primitive"] = "Primitive";
    /**
     * 实体类型
     */
    DataPropGroup["Object"] = "Object";
    /**
     * 动态实体类型
     */
    DataPropGroup["Dynamic"] = "Dynamic";
    /**
     * 列表类型
     */
    DataPropGroup["List"] = "List";
})(DataPropGroup || (DataPropGroup = {}));
/**
 * 实体属性信息
 */
var DataPropInfo = /** @class */ (function () {
    function DataPropInfo() {
    }
    return DataPropInfo;
}());

/**
 * 元数据名称
 */
var PRIMITIVE_PROP_META = 'PrimitivePropMeta';
/**
 * 【简单属性装饰器工厂】的工厂
 */
function makePrimitivePropMetaDecorator(options) {
    var metadata = {
        primary: false,
        foreign: false
    };
    if (options) {
        var paramType = typeof options;
        switch (paramType) {
            case 'boolean':
                metadata.primary = Boolean(options);
                break;
            case 'string':
                metadata.dataField = String(options);
                break;
            case 'object':
                metadata = Object.assign(metadata, options);
                break;
        }
    }
    return metadata;
}
/**
 * 简单属性装饰器工厂
 */
var PrimitivePropMeta = makePropDecorator(PRIMITIVE_PROP_META, makePrimitivePropMetaDecorator);

var StringUtil = /** @class */ (function () {
    function StringUtil() {
    }
    /**
       * 字符串格式化
       */
    StringUtil.format = function (value, options) {
        var maxLenght = options.maxLenght, _a = options.prefix, prefix = _a === void 0 ? '' : _a, _b = options.suffix, suffix = _b === void 0 ? '' : _b, _c = options.ellipsis, ellipsis = _c === void 0 ? '...' : _c;
        if (!maxLenght)
            return value;
        if (!value)
            return value;
        if (maxLenght && value.length > maxLenght) {
            value = value.slice(0, maxLenght);
            return prefix + value + suffix + ellipsis;
        }
        return prefix + value + suffix;
    };
    StringUtil.filterSearchValue = function (value, options) {
        if (value == undefined || value == null || value == '') {
            return value;
        }
        value = value.trim();
        if (options == undefined || options == null || options == '') {
            value = value.replace(/[<>&"]/g, function (c) { return { '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;' }[c]; });
            return value;
        }
        if (options && options.text == "") {
            value = value.replace(/[<>&"]/g, function (c) { return { '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;' }[c]; });
            return "<p>" + value + "</p>";
        }
        if (typeof options === 'string') {
            var re = new RegExp("" + options, 'g');
            var newStr = value.replace(re, "##s1p1##" + options + "##s2p2##");
            newStr = newStr.replace(/[<>&"]/g, function (c) { return { '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;' }[c]; });
            newStr = newStr.replace(/##s1p1##/g, '<span style="color:red">');
            newStr = newStr.replace(/##s2p2##/g, "</span>");
            return "<p>" + newStr + "</p>";
        }
        if (typeof options === 'object') {
            var text = options.text, style = options.style;
            var re = new RegExp("" + text, 'g');
            var newStr = value.replace(re, "##s1p1##" + style + "##s2p2##" + text + "##s3p3##");
            newStr = newStr.replace(/[<>&"]/g, function (c) { return { '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;' }[c]; });
            newStr = newStr.replace(/##s1p1##/g, "<span style=\"");
            newStr = newStr.replace(/##s2p2##/g, "\">");
            newStr = newStr.replace(/##s3p3##/g, "</span>");
            return "<p>" + newStr + "</p>";
        }
    };
    return StringUtil;
}());

var NumberUtil = /** @class */ (function () {
    function NumberUtil() {
    }
    /**
       * 数字格式化
       * {
       *   precision: 2,
       *   decimal: true,
       *   thousand: ','
       *   prefix: '',
       *   suffix: ''
       * }
       */
    NumberUtil.format = function (value, options) {
        // 参数处理
        var decimals = (options.precision || options.precision === 0) ? options.precision : 2;
        var decimalPoint = options.decimal || '.';
        var thousandsSep = options.thousand || '';
        var prefix = options.prefix || '';
        var suffix = options.suffix || '';
        var prefixType = options.prefixType;
        if (prefixType == "dynamic" && options.prefix) {
            // 表示前缀为一个函数  那么执行函数定义
            var prefixFunc = new Function("return " + options.prefix);
            prefix = prefixFunc()(options.sourceData);
        }
        value = (value + '').replace(/[^0-9+-Ee.]/g, '');
        var s;
        // 处理精度
        var toFixedFix = function (n, prec) {
            var k = Math.pow(10, prec);
            return '' + parseFloat(Math.round(parseFloat((n * k).toFixed(prec * 2))).toFixed(prec * 2)) / k;
        };
        s = ((decimals || decimals === 0) ? toFixedFix(value, decimals) : '' + Math.round(value)).split('.');
        // 处理千分位
        if (thousandsSep) {
            var pattern = /(-?\d+)(\d{3})/;
            while (pattern.test(s[0])) {
                s[0] = s[0].replace(pattern, "$1" + thousandsSep + "$2");
            }
            if ((s[1] || '').length < decimals) {
                s[1] = s[1] || '';
                s[1] += new Array(decimals - s[1].length + 1).join('0');
            }
        }
        var formatedValue = s.join(decimalPoint);
        formatedValue = "" + prefix + formatedValue + suffix;
        return formatedValue;
    };
    return NumberUtil;
}());

/**
 * 布尔工具类
 */
var BoolUtil = /** @class */ (function () {
    function BoolUtil() {
    }
    /**
     * 布尔值格式化
    */
    BoolUtil.format = function (value, options) {
        if (value === true) {
            return '是';
        }
        else {
            return '否';
        }
    };
    return BoolUtil;
}());

var EnumUtil = /** @class */ (function () {
    function EnumUtil() {
    }
    /**
     * 枚举格式化
     * {
     *  enumData: [
     *    {value: 'value1', name: 'name1'},
     *    {value: 'value2', name: 'name2'}
     *  ]
     * }
     */
    EnumUtil.format = function (value, options) {
        var separator = options.separator;
        var enumOptions = options.enumData;
        var valueArry = [];
        if (value && separator) {
            valueArry = value.split(separator);
        }
        if (valueArry.length > 1) {
            var nameArry = valueArry.map(function (item) {
                var targetEnumOption = enumOptions.find(function (enumOption) {
                    return enumOption.value === item;
                });
                if (!targetEnumOption) {
                    console.error("\u627E\u4E0D\u5230" + item + "\u5BF9\u5E94\u7684\u679A\u4E3E\u9009\u9879");
                    return item;
                }
                return targetEnumOption.name;
            });
            return nameArry.join(separator);
        }
        var targetEnumOption = enumOptions.find(function (enumOption) {
            return enumOption.value === value;
        });
        if (!targetEnumOption) {
            console.error("\u627E\u4E0D\u5230" + value + "\u5BF9\u5E94\u7684\u679A\u4E3E\u9009\u9879");
            return value;
        }
        return targetEnumOption.name;
    };
    return EnumUtil;
}());

dayjs.locale('zh-cn');
/**
 * 日期处理类
 */
var DateUtil = /** @class */ (function () {
    function DateUtil() {
    }
    /**
     * 将日期（或日期字符串）转换为完整的的ISO格式的字符串
     */
    DateUtil.formatISO = function (dateOrDateString) {
        if (this.isEmptyDateOrDateString(dateOrDateString) === true) {
            return this.emptyISODateTimeString;
        }
        var dateObj = this.parse(dateOrDateString);
        return format(dateObj, this.defaultISOFormat);
    };
    /**
     * 将日期（或日期字符串）转换为指定格式的字符串
     * @param dateOrDateString 日期对象或符合ISO8601规范的日期字符串
     * @param dateFormat 日期格式字符串
     */
    DateUtil.format = function (dateOrDateString, dateFormat) {
        if (this.isEmptyDateOrDateString(dateOrDateString) === true) {
            return this.emptyISODateTimeString;
        }
        var dateObj = this.parse(dateOrDateString);
        dateFormat = dateFormat ? dateFormat : this.defaultDisplayFormat;
        return format(dateObj, dateFormat);
    };
    DateUtil.dateShow = function (dateOrDateString, type) {
        if (this.isEmptyDateOrDateString(dateOrDateString) === true) {
            return this.emptyISODateTimeString;
        }
        if (!type || "" === type) {
            return;
        }
        return this[type] && this[type](dateOrDateString);
    };
    DateUtil.dateOperation = function (dateOrDateString, options) {
        if (this.isEmptyDateOrDateString(dateOrDateString) === true) {
            return this.emptyISODateTimeString;
        }
        var _a = options.type, type = _a === void 0 ? "" : _a, option = options.option;
        if (!type || "" === type) {
            return;
        }
        if ('isSame' === type) {
            return this[type] && this[type](dateOrDateString, options['targetDate'], options['granularity']);
        }
        if ('isBefore' === type) {
            return this[type] && this[type](dateOrDateString, options['targetDate'], options['granularity']);
        }
        if ('isAfter' === type) {
            return this[type] && this[type](dateOrDateString, options['targetDate'], options['granularity']);
        }
        if ('isBetween' === type) {
            return this[type] && this[type](dateOrDateString, options['targetDate'], options['targetDate2'], options['granularity'], options['contains']);
        }
        if (!option) {
            return this[type] && this[type](dateOrDateString);
        }
        return this[type] && this[type](dateOrDateString, option);
    };
    DateUtil.relativeTime = function (dateOrDateString, option) {
        dayjs.extend(relativeTime);
        var dateObj = dayjs(dateOrDateString);
        if (!option) {
            return dayjs(dateObj).fromNow();
        }
        return dayjs(dateObj).fromNow(option);
    };
    DateUtil.isToday = function (dateOrDateString) {
        var todayDate = new Date();
        var dateObj = dayjs(dateOrDateString);
        return this.isSame(dateObj, todayDate, 'date');
    };
    DateUtil.calendar = function (dateOrDateString, option) {
        var dateObj = dayjs(dateOrDateString);
        dayjs.extend(Calendar);
        if (option) {
            return dayjs().calendar(dateObj, __assign({}, option));
        }
        return dayjs().calendar(dateObj, {
            sameDay: '[今天] HH:mm',
            nextDay: '[明天] HH:mm',
            lastDay: '[昨天] HH:mm',
            sameElse: 'YYYY-MM-DD'
        });
    };
    /**
     * 创建日期
     * @param dateOrDateString 日期对象或符合ISO8601规范的日期字符串
     */
    DateUtil.parse = function (dateOrDateString) {
        if (this.isEmptyDateOrDateString(dateOrDateString) === true) {
            return null;
        }
        if (this.isDate(dateOrDateString) === true) {
            return dateOrDateString;
        }
        return parseISO(dateOrDateString);
    };
    /**
     * 是否是日期对象
     */
    DateUtil.isDate = function (date) {
        return isDate(date);
    };
    /**
     * 是否是空日期或者空日期字符串
     * @param dateOrDateString 日期或日期字符串
     */
    DateUtil.isEmptyDateOrDateString = function (dateOrDateString) {
        if (this.isDate(dateOrDateString) === true) {
            return this.isEmptyDate(dateOrDateString);
        }
        return this.isEmptyDateString(dateOrDateString);
    };
    /**
     * 是否为空日期字符串
     * @param date 日期对象
     */
    DateUtil.isEmptyDate = function (date) {
        if (!date) {
            return true;
        }
        return false;
    };
    /**
     * 是否是空日期字符串
     * @param dateString 日期字符串
     */
    DateUtil.isEmptyDateString = function (dateString) {
        if (!dateString || dateString.startsWith('0001-01-01') === true) {
            return true;
        }
        return false;
    };
    /**
     * 两个日期是否相等
     * @param dateOrDateString1 日期对象或字符串
     * @param dateOrDateString1 日期对象或字符串
     * @return 相等返回true，否则返回false
     */
    DateUtil.isEqual = function (dateOrDateString1, dateOrDateString2) {
        var dateObj1 = this.parse(dateOrDateString1);
        var dateObj2 = this.parse(dateOrDateString2);
        if (dateObj1 === dateObj2) {
            return true;
        }
        return isEqual$1(dateObj1, dateObj2);
    };
    /**
     * 两个日期是否相等
     * @param dateOrDateString1 日期对象或字符串
     * @param dateOrDateString1 日期对象或字符串
     * @return 返回-1、0、1
     */
    DateUtil.compare = function (dateOrDateString1, dateOrDateString2) {
        var dateObj1 = this.parse(dateOrDateString1);
        var dateObj2 = this.parse(dateOrDateString2);
        if (this.isEqual(dateObj1, dateObj2) === true) {
            return 0;
        }
        // 处理解析后为null的场景，null比所有有效日期小
        if (!dateObj1 && this.isDate(dateObj2) === true) {
            return -1;
        }
        if (!dateObj2 && this.isDate(dateObj1) === true) {
            return 1;
        }
        return compareAsc(dateObj1, dateObj2);
    };
    /**
     *
     * @param currentDate 当前日期
     * @param targetDate 目标日期
     * @param type 比较类型 date	D	天00:00 day	d	星期00:00 month	M	月第一天00:00 year	y	1月1日00点 week	w	周第一天00:00hour	h	00:00:00minute	m	00:00second	s	00millisecond	ms	0
     * @returns
     */
    DateUtil.isSame = function (currentDate, targetDate, type) {
        if (type) {
            return dayjs(currentDate).isSame(dayjs(targetDate), type);
        }
        return dayjs(currentDate).isSame(dayjs(targetDate));
    };
    /**
     *
     * @param currentDate 当前日期
     * @param targetDate 目标日期
     * @returns boolean
     */
    DateUtil.isBefore = function (currentDate, targetDate, type) {
        if (type) {
            return dayjs(currentDate).isBefore(dayjs(targetDate), type);
        }
        return dayjs(currentDate).isBefore(dayjs(targetDate));
    };
    /**
   *
   * @param currentDate 当前日期
   * @param targetDate 目标日期
   * @returns boolean
   */
    DateUtil.isAfter = function (currentDate, targetDate, type) {
        if (type) {
            return dayjs(currentDate).isAfter(dayjs(targetDate), type);
        }
        return dayjs(currentDate).isAfter(dayjs(targetDate));
    };
    /**
     *
     * @param currentDate
     * @param targetDate1
     * @param targetDate2
     * @returns
     */
    DateUtil.isBetween = function (currentDate, targetDate1, targetDate2, type, contains) {
        dayjs.extend(IsBetween);
        if (type) {
            return dayjs(currentDate).isBetween(dayjs(targetDate1), dayjs(targetDate2), type, contains);
        }
        return dayjs(currentDate).isBetween(dayjs(targetDate1), dayjs(targetDate2), null, contains);
    };
    /**
     * 空日期字符串（N版）
     * @todo：兼容服务器端，不应该在devkit体现这种兼容，待移除
     */
    // static emptyDateTimeString = '0001-01-01T00:00:00';
    DateUtil.emptyDateTimeString = null;
    /**
     * 默认空日期字符串（ISO标准格式）
     */
    // static emptyISODateTimeString = '0001-01-01T00:00:00+00:00';
    DateUtil.emptyISODateTimeString = null;
    /**
     * 默认日期听格式
     */
    DateUtil.defaultISOFormat = "yyyy-MM-dd'T'HH:mm:ssxxx";
    DateUtil.defaultDisplayFormat = 'yyyy-MM-dd HH:mm:ss';
    DateUtil.defaultDateFormat = 'yyyy-MM-dd';
    DateUtil.defaultTimeFormat = 'HH:mm:ss';
    return DateUtil;
}());

var ArrayUtil = /** @class */ (function () {
    function ArrayUtil() {
    }
    /**
     * 从数组中删除一项
     */
    ArrayUtil.remove = function (arr, itemToRemove) {
        var indexToRemove = arr.findIndex(function (item) {
            return item === itemToRemove;
        });
        this.removeByIndex(arr, indexToRemove);
    };
    /**
     * 从数组中删除indexToRemove对应的项
     * @param index
     */
    ArrayUtil.removeByIndex = function (arr, indexToRemove) {
        if (!arr || arr[indexToRemove] !== undefined) {
        }
        arr.splice(indexToRemove, 1);
    };
    return ArrayUtil;
}());

var ObjectUtil = /** @class */ (function () {
    function ObjectUtil() {
    }
    /**
     * 检查是否是简单对象
     */
    ObjectUtil.isPlainObject = function (value) {
        if (!(typeof value === 'object' && value !== null) || Object.prototype.toString.call({}) !== '[object Object]') {
            return false;
        }
        if (Object.getPrototypeOf(value) === null) {
            return true;
        }
        var proto = value;
        while (Object.getPrototypeOf(proto) !== null) {
            proto = Object.getPrototypeOf(proto);
        }
        return Object.getPrototypeOf(value) === proto;
    };
    return ObjectUtil;
}());

/**
 * 数据路径处理
 */
var BindingPathConverter = /** @class */ (function () {
    function BindingPathConverter() {
    }
    /**
     * (BindingPathString | BindingPathArray) => BindingPathArray
     * @param bindingPath BindingPath的字符串或者数组格式
     * @return BindingPath数组
     */
    BindingPathConverter.toBindingPathArray = function (bindingPath) {
        var bindingPathArray;
        if (typeof bindingPath === 'string') {
            bindingPathArray = bindingPath.split('/').filter(function (part) {
                return part !== '';
            });
            return bindingPathArray;
        }
        else {
            bindingPathArray = bindingPath.concat([]);
        }
        return bindingPathArray;
    };
    /**
     * BindingPathArray => BindingPathString
     */
    BindingPathConverter.toBindingPathString = function (bindingPathArray) {
        return '/' + bindingPathArray.join('/');
    };
    return BindingPathConverter;
}());

/**
 * BindingPath比较器
 */
var BindingPathComparer = /** @class */ (function () {
    function BindingPathComparer() {
    }
    /**
     * 是否相等
     */
    BindingPathComparer.isEqual = function (srcPath, dstPath) {
        var srcPathArray = BindingPathConverter.toBindingPathArray(srcPath);
        var dstPathArray = BindingPathConverter.toBindingPathArray(dstPath);
        var isEqual = srcPathArray.every(function (srcPathItem, srcPathIndex) {
            return srcPathItem === dstPathArray[srcPathIndex];
        });
        return isEqual;
    };
    /**
     * 是否是父路径
     */
    BindingPathComparer.isParent = function (childPath, parentPath) {
        var childPathArray = BindingPathConverter.toBindingPathArray(childPath);
        var parentPathArray = BindingPathConverter.toBindingPathArray(parentPath);
        // 长度差1个
        if (childPathArray.length !== parentPathArray.length + 1) {
            return;
        }
        return this.isAncestor(childPath, parentPath);
    };
    /**
     * 是否是祖先路径
     */
    BindingPathComparer.isAncestor = function (descendantPath, ancestorPath) {
        var descendantPathArray = BindingPathConverter.toBindingPathArray(descendantPath);
        var ancestorPathArray = BindingPathConverter.toBindingPathArray(ancestorPath);
        if (descendantPath.length <= ancestorPathArray.length) {
            return false;
        }
        var isAncestor = ancestorPathArray.every(function (ancestorPathItem, ancestorPathIndex) {
            return ancestorPathItem === descendantPathArray[ancestorPathIndex];
        });
        return isAncestor;
    };
    return BindingPathComparer;
}());

/**
 * BindingPath遍历器
 */
var BindingPathTraverser = /** @class */ (function () {
    function BindingPathTraverser() {
    }
    /**
     * 获取叶子节点的Path
     */
    BindingPathTraverser.getLeafPathString = function (bindingPath) {
        var bindingPathArray = BindingPathConverter.toBindingPathArray(bindingPath);
        return bindingPathArray.pop();
    };
    /**
     * 获取父路径
     */
    BindingPathTraverser.getParentPathString = function (bindingPath) {
        var bindingPathArray = BindingPathConverter.toBindingPathArray(bindingPath);
        bindingPathArray.pop();
        return '/' + bindingPathArray.join('/');
    };
    return BindingPathTraverser;
}());

/**
 * 变更相关定义
 * @author Witt<jiwt@inspur.com>
 */
/**
 * 绑定数据变更类型
 */
var ChangeType;
(function (ChangeType) {
    ChangeType["Load"] = "Load";
    ChangeType["Append"] = "Append";
    ChangeType["Remove"] = "Remove";
    ChangeType["Swap"] = "Swap";
    ChangeType["SelectionChanged"] = "SelectionChanged";
    ChangeType["ValueChanged"] = "ValueChanged";
    ChangeType["UpdateErrors"] = "UpdateErrors";
    ChangeType["GlobalSelectionChanged"] = "GlobalSelectionChanged";
    /**
     * 分页信息变化
     */
    ChangeType["PaginationInfoChange"] = "PaginationInfoChange";
})(ChangeType || (ChangeType = {}));
/**
 * 视图变更类型
 */
var ViewChangeType;
(function (ViewChangeType) {
    ViewChangeType[ViewChangeType["ValueChanged"] = 0] = "ValueChanged";
})(ViewChangeType || (ViewChangeType = {}));

/**
 * 绑定属性相关定义
 * @author Witt<jiwt@inspur.com>
 */
/**
 * 属性类型
 */
var BindingPropertyType;
(function (BindingPropertyType) {
    /**
     * 简单类型
     */
    BindingPropertyType["Plain"] = "Plain";
    /**
     * 对象类型
     */
    BindingPropertyType["Object"] = "Object";
    /**
     * 列表类型
     */
    BindingPropertyType["List"] = "List";
    /**
     * 动态类型
     */
    BindingPropertyType["Dynamic"] = "Dynamic";
})(BindingPropertyType || (BindingPropertyType = {}));

/**
 * 属性工具类
 */
var PropertyUtil = /** @class */ (function () {
    function PropertyUtil() {
    }
    /**
     * 获取实体上的属性集合，并将他们转换成BindingProperty集合
     * @param  entityType 实体类型
     * @returns 绑定属性集合
     */
    PropertyUtil.getProperties = function (entityType) {
        var properties = [];
        // Plain
        var ngFieldProperties = FieldMetadataUtil.getNgFields(entityType);
        Object.keys(ngFieldProperties).forEach(function (propertyName) {
            var ngFieldProperty = ngFieldProperties[propertyName];
            properties.push({
                name: propertyName,
                type: BindingPropertyType.Plain,
                isPrimaryKey: ngFieldProperty.primary,
                isForeignKey: ngFieldProperty.foreign,
                enableMultiLangInput: ngFieldProperty.enableMultiLangInput
            });
        });
        // Object
        var ngObjectProperties = FieldMetadataUtil.getNgObjects(entityType);
        Object.keys(ngObjectProperties).forEach(function (propertyName) {
            var ngObjectProperty = ngObjectProperties[propertyName];
            properties.push({
                name: propertyName,
                type: BindingPropertyType.Object,
                entityType: ngObjectProperty.type
            });
        });
        // List
        var ngListProperties = FieldMetadataUtil.getNgList(entityType);
        Object.keys(ngListProperties).forEach(function (propertyName) {
            var ngListProperty = ngListProperties[propertyName];
            properties.push({
                name: propertyName,
                type: BindingPropertyType.List,
                entityType: ngListProperty.type
            });
        });
        // Dynamics
        var ngDynamicProperties = FieldMetadataUtil.getNgDynamic(entityType);
        Object.keys(ngDynamicProperties).forEach(function (propertyName) {
            var ngDynamicProperty = ngDynamicProperties[propertyName];
            properties.push({
                name: propertyName,
                type: BindingPropertyType.Dynamic,
                entityType: ngDynamicProperty.type
            });
        });
        return properties;
    };
    PropertyUtil.getDynamicProperties = function (dynamicData) {
        var properties = [];
        Object.keys(dynamicData).forEach(function (propertyName) {
            if (dynamicData.hasOwnProperty(propertyName)) {
                if (dynamicData[propertyName] instanceof Object) {
                    properties.push({
                        name: propertyName,
                        type: BindingPropertyType.Dynamic,
                        entityType: null
                    });
                }
                else {
                    properties.push({
                        name: propertyName,
                        type: BindingPropertyType.Plain,
                        isPrimaryKey: false,
                        isForeignKey: false
                    });
                }
            }
        });
        return properties;
    };
    /**
     * 根据属性名获取属性
     */
    PropertyUtil.getPropertyByName = function (properties, propertyName) {
        var targetProperty = properties.find(function (property) {
            return property.name === propertyName;
        });
        return targetProperty;
    };
    /**
     * 获取实体主键名
     * @param properties 属性集合
     * @returns 主键名
     */
    PropertyUtil.getPrimaryKey = function (properties) {
        // 实体必须有主键，如果没有主键在构造实体的时候就已经报错，这里不需要再进行检查
        var primaryProperty = properties.find(function (property) {
            return property.isPrimaryKey === true;
        });
        return primaryProperty ? primaryProperty.name : '';
    };
    return PropertyUtil;
}());

/**
 * BindingObject相关定义
 * @author Witt<jiwt@inspur.com>
 */
/**
 * BindingObject是Entity在绑定层的一个影射，它将Entity内的数据转换为不可变对象，并用于界面绑定。
 */
var BindingObject = /** @class */ (function () {
    /**
     * 构造函数
     * @param properties 属性集合
     */
    function BindingObject(properties) {
        /**
         * 标识是否提交过
         */
        this.isShowValidationMsg = false;
        /**
         * 以{ [propertyName]: FormControl }的形式存放每条数据的control
         */
        this.controlMap = {};
        this.properties = properties;
        this.primaryKey = PropertyUtil.getPrimaryKey(properties);
        this.innerValues = new Map();
        this.changes = new Subject();
        this.viewChanges = new Subject();
    }
    Object.defineProperty(BindingObject.prototype, "primaryKeyValue", {
        /**
         * 主键值
         */
        get: function () {
            return this.primaryKey ? this.getValue(this.primaryKey) : '';
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 设置是否提交过
     */
    BindingObject.prototype.setShowValidationMsg = function (flag) {
        this.isShowValidationMsg = flag;
    };
    /**
     * 根据属性名获取属性值
     * @param   propertyName 属性名
     * @returns 属性值
     */
    BindingObject.prototype.getValue = function (propertyName) {
        return this.innerValues.get(propertyName);
    };
    /**
     * 设置属性值
     * @param propertyName        属性名
     * @param propertyValue       属性值
     * @param emitEventToView     是否通知View层去更新界面，默认为false
     * @param emitEventToEntity   是否通知Entity层去更新值，默认为false
     * @param errors              错误消息
     * @param invokeOnValueChange 值变化事件执行句柄
     */
    BindingObject.prototype.setValue = function (propertyName, propertyValue, emitEventToView, emitEventToEntity, errors, invokeOnValueChange) {
        var _this = this;
        if (emitEventToView === void 0) { emitEventToView = false; }
        if (emitEventToEntity === void 0) { emitEventToEntity = false; }
        var oldPropertyValue = this.getValue(propertyName);
        // 由于特定原因（@邵珠强），无法屏蔽oldPropertyValue === propertyValue
        if (oldPropertyValue === propertyValue) {
            return;
        }
        if (!invokeOnValueChange || oldPropertyValue === propertyValue) {
            // 设定缺省
            invokeOnValueChange = function (preValue, value, entityChanged) {
                return of(true);
            };
        }
        if (emitEventToEntity === true) {
            // BUG 322301，删除@2019.08.10; 如果无对应实体，则中止值传递; 这种情况发生在带从表的单据新增，从表响应Load变化的情况；
            // if(!this.innerValues.has(propertyName)) {
            //   return;
            // }
            // 执行实体值变化前事件
            invokeOnValueChange(oldPropertyValue, propertyValue, false).subscribe(function (result) {
                if (result) {
                    // 如果成功，执行变化，并通知实体变化
                    _this.innerValues = _this.innerValues.set(propertyName, propertyValue);
                    var viewChange = {
                        type: ViewChangeType.ValueChanged,
                        path: [propertyName],
                        value: propertyValue,
                        errors: errors
                    };
                    _this.viewChanges.next(viewChange);
                    // 如果需要通知视图，通知视图相应修改
                    if (emitEventToView === true) {
                        _this.changes.next({
                            type: ChangeType.ValueChanged,
                            path: [propertyName],
                            value: propertyValue,
                            id: _this.primaryKeyValue,
                            errors: errors
                        });
                    }
                    // 执行实体值变化后事件
                    invokeOnValueChange(oldPropertyValue, propertyValue, true).subscribe();
                }
                else {
                    // 如果失败，不再通知实体变化
                    // 并执行界面回滚操作
                    _this.changes.next({
                        type: ChangeType.ValueChanged,
                        path: [propertyName],
                        value: oldPropertyValue,
                        id: _this.primaryKeyValue,
                        errors: errors
                    });
                }
            });
        }
        else {
            // `emitEventToEntity === false`, 则认定实体值已经发生变化，通知视图变化，并触发实体值变化后事件
            this.innerValues = this.innerValues.set(propertyName, propertyValue);
            if (emitEventToView === true) {
                this.changes.next({
                    type: ChangeType.ValueChanged,
                    path: [propertyName],
                    value: propertyValue,
                    id: this.primaryKeyValue,
                    errors: errors
                });
            }
            // 执行实体值变化后事件
            invokeOnValueChange(oldPropertyValue, propertyValue, true).subscribe();
        }
    };
    /**
     * 将BindingObject实例转换成JSON对象
     */
    BindingObject.prototype.toJSON = function (options) {
        var _this = this;
        var langCode = window.localStorage.getItem('languageCode') || 'zh-CHS';
        var result = {};
        this.properties.forEach(function (property) {
            var propName = property.name;
            if (property.type === BindingPropertyType.List) {
                var list = _this[propName];
                result[propName] = list.toJSON(options);
            }
            else if (property.type === BindingPropertyType.Object) {
                var object = _this[propName];
                result[propName] = object.toJSON(options);
            }
            else if (property.type === BindingPropertyType.Dynamic) {
                var object = _this[propName];
                result[propName] = object.toJSON(options);
            }
            else {
                // 1、对于多语录入字段；
                // 2、传入ignoreMultiLangInput标志，则取当前语言的值给控件。
                if (options && options.ignoreMultiLangInput === true && property.enableMultiLangInput === true) {
                    var multiLangValueObj = _this.getValue(propName);
                    if (multiLangValueObj) {
                        result[propName] = multiLangValueObj[langCode];
                    }
                    else {
                        result[propName] = multiLangValueObj;
                    }
                }
                else {
                    result[propName] = _this.getValue(propName);
                }
            }
        });
        return result;
    };
    return BindingObject;
}());

/**
 * 绑定列表工厂相关定义
 * @author Witt<jiwt@inspur.com>
 */
/**
 * BindingList工厂用于创建一个空的BindingList对象，并将当前行的属性影射到BindingList对象上。
 *
 * **示例代码**
 * ```ts
 * const deptProperties: BindingProperty[] = PropertyUtil.getProperties(DeptEntity);
 * const deptList = BindingListFactory.create(deptProperties);
 * ```
 */
var BindingListFactory = /** @class */ (function () {
    function BindingListFactory() {
    }
    /**
     * 创建BindingList实例，并扩展其属性
     * @param bindingProperties 绑定属性集合
     */
    BindingListFactory.create = function (bindingProperties) {
        var bindingList = new BindingList(bindingProperties);
        this.extendProperties(bindingList, bindingProperties);
        return bindingList;
    };
    /**
     * 扩展BindingList属性，将当前行上的属性映射到列表上
     * @param bindingList       要扩展的绑定列表
     * @param bindingProperties 绑定属性集合
     */
    BindingListFactory.extendProperties = function (bindingList, bindingProperties) {
        bindingProperties.forEach(function (bindingProperty) {
            var propertyName = bindingProperty.name;
            Object.defineProperty(bindingList, propertyName, {
                get: function () {
                    return bindingList.currentItem[propertyName];
                }
            });
        });
    };
    return BindingListFactory;
}());

/**
 * 绑定对象工厂相关定义
 * @author Witt<jiwt@inspur.com>
 */
/**
 * BindingObject工厂用于创建一个空的BindingObject对象，并对其属性进行扩展。
 *
 * **扩展属性处理**
 *
 * 对于要扩展的属性（BindingProperty）有三种处理：
 * - 普通属性：初始化为一个undefined，并包装get、set方法，通过set方法监听变更；
 * - 对象属性：初始化为一个空的BindingObject对象，并监听子对象的变更；
 * - 列表属性：初始化为一个空的BindingList对象，并监听子列表的变更；
 *
 * **示例代码**
 *
 * ```ts
 *  const empProperties = PropertyUtil.getProperties(EmpEntity);
 * const empBindingObject = BindingObjectFactory.create(properties);
 * ```
 */
var BindingObjectFactory = /** @class */ (function () {
    function BindingObjectFactory() {
    }
    /**
     * 创建BindingObject实例
     * @param properties 要扩展的属性集合
     * @returns 带扩展属性的空BindingObject对象
     * @
     */
    BindingObjectFactory.create = function (properties) {
        var object = new BindingObject(properties);
        this.extendProperties(object, properties);
        return object;
    };
    BindingObjectFactory.createDynamicBindingObject = function (data) {
        var properties = PropertyUtil.getDynamicProperties(data);
        var object = new BindingObject(properties);
        this.extendProperties(object, properties);
        return object;
    };
    /**
     * 扩展属性绑定对象的属性
     * @param object     要扩展的绑定对象
     * @param properties 绑定属性集合
     */
    BindingObjectFactory.extendProperties = function (object, properties) {
        var _this = this;
        // 扩展BindingObject属性
        properties.forEach(function (property) {
            if (property.type === BindingPropertyType.List) {
                _this.extendListProperty(object, property);
            }
            else if (property.type === BindingPropertyType.Object) {
                _this.extendObjectProperty(object, property);
            }
            else if (property.type === BindingPropertyType.Dynamic) {
                _this.extendDynamicObjectProperty(object, property);
            }
            else {
                _this.extendPlainProperty(object, property);
            }
        });
    };
    /**
     * 扩展列表类型的绑定属性
     * @param object     要扩展的绑定对象
     * @param properties 列表类型的绑定属性集合
     */
    BindingObjectFactory.extendListProperty = function (object, property) {
        var propertyName = property.name;
        var childListProperties = PropertyUtil.getProperties(property.entityType);
        var childList = BindingListFactory.create(childListProperties);
        // 指定子List的parent、监听子List的changes事件
        childList.parent = object;
        childList.changes.subscribe(function (change) {
            change.path.unshift(propertyName);
            object.changes.next(change);
        });
        // 将子的BindingList实例赋值给当前属性
        Object.defineProperty(object, propertyName, {
            value: childList
        });
    };
    /**
     * 扩展对象类型的绑定属性
     * @param object     要扩展的绑定对象
     * @param properties 对象类型的绑定属性集合
     */
    BindingObjectFactory.extendObjectProperty = function (object, property) {
        var propertyName = property.name;
        var childObjectProperties = PropertyUtil.getProperties(property.entityType);
        var childObject = this.create(childObjectProperties);
        // 指定子Object的parent、监听子Object的changes事件
        childObject.parent = object;
        childObject.changes.subscribe(function (change) {
            change.path.unshift(propertyName);
            object.changes.next(change);
        });
        Object.defineProperty(object, propertyName, {
            value: childObject
        });
    };
    BindingObjectFactory.extendDynamicObjectProperty = function (object, property) {
        var propertyName = property.name;
        object[propertyName] = null;
    };
    BindingObjectFactory.attachDynamicObjectProperty = function (object, propertyName, dynamicObject) {
        dynamicObject.parent = object;
        dynamicObject.changes.subscribe(function (change) {
            change.path.unshift(propertyName);
            object.changes.next(change);
        });
        Object.defineProperty(object, propertyName, {
            value: dynamicObject
        });
    };
    /**
     * 扩展简单类型的绑定属性
     * @param object     要扩展的绑定对象
     * @param properties 简单类型的绑定属性集合
     */
    BindingObjectFactory.extendPlainProperty = function (object, property) {
        var propertyName = property.name;
        Object.defineProperty(object, propertyName, {
            get: function () {
                return object.getValue(propertyName);
            },
            set: function (value) {
                var oldValue = object.getValue(propertyName);
                if (value === oldValue) {
                    return;
                }
                object.setValue(propertyName, value, true, true);
            }
        });
    };
    return BindingObjectFactory;
}());

/**
 * 实体操作工具类
 */
var EntityUtil = /** @class */ (function () {
    function EntityUtil() {
    }
    /**
     * 将entity的数据加载到bindingObject中，并保持两者同步。
     * @param entity        实体对象
     * @param bindingObject 绑定对象
     */
    EntityUtil.loadEntity = function (entity, bindingObject) {
        var _this = this;
        // 遍历bindingObject的properties进行赋值
        bindingObject.properties.forEach(function (property) {
            var propertyName = property.name;
            if (property.type === BindingPropertyType.List) {
                _this.loadEntityList(entity[propertyName] || entity[PARENT_CLASS], bindingObject[propertyName]);
            }
            else if (property.type === BindingPropertyType.Object) {
                if (entity && entity[propertyName]) {
                    _this.loadEntity(entity[propertyName], bindingObject[propertyName]);
                }
            }
            else if (property.type === BindingPropertyType.Dynamic) {
                if (entity && entity[propertyName]) {
                    var dynamicObject = BindingObjectFactory.createDynamicBindingObject(entity[propertyName].data);
                    BindingObjectFactory.attachDynamicObjectProperty(bindingObject, propertyName, dynamicObject);
                    _this.loadEntity(entity[propertyName], bindingObject[propertyName]);
                }
            }
            else {
                bindingObject.setValue(propertyName, entity[propertyName], false, false);
            }
        });
        this.setUpEntityPipeline(entity, bindingObject);
    };
    /**
     * 建立entity和bindingObject之间的关联
     * @param entity        实体对象
     * @param bindingObject 绑定对象
     */
    EntityUtil.setUpEntityPipeline = function (entity, bindingObject) {
        // 监听entity变更
        entity.onValueChanged.subscribe(function (modification) {
            if (modification.type !== ModifyType.ValueChange || modification.path.length === 0) {
                return;
            }
            var propertyName = modification.path[modification.path.length - 1];
            var primaryKeyPath = modification.path[modification.path.length - 2];
            // 验证主键是否匹配
            // 存在主键并且主键不是id时才检查（值对象、关联对象不检查）
            if (bindingObject.primaryKey && bindingObject.primaryKey === 'id') {
                var primaryKey = bindingObject.primaryKey;
                var primaryKeyValue = bindingObject.getValue(primaryKey);
                if (primaryKeyPath !== primaryKey + ":" + primaryKeyValue) {
                    return;
                }
            }
            // 值没有发生变化，不再设置
            // TODO: 通过bindingObject修改entity属性值时，entity总会触发一个变更回来，如果不截获这个重复的变更，会导致重复或死循环
            if (bindingObject.getValue(propertyName) === modification.value) {
                return;
            }
            bindingObject.setValue(propertyName, modification.value, true, false, modification.errors);
        });
        // 监听bindingObject变更
        bindingObject.viewChanges.subscribe(function (viewChange) {
            var value = viewChange.value;
            var propertyName = viewChange.path[0];
            var pathPrefix = '';
            var pathData = entity.getPaths();
            var paths = pathData.path;
            var id = bindingObject['id'];
            if (pathData.isUdt) {
                // grid中udt没有id，从父级中取出id，以便存放验证信息
                var getParentId = function (target) {
                    var parentId = '';
                    var findId = function (item) {
                        if (item && item && item['id']) {
                            parentId = item['id'];
                            return;
                        }
                        else if (item['parent']) {
                            findId(item['parent']);
                        }
                    };
                    findId(target);
                    return parentId;
                };
                id = getParentId(bindingObject);
                if (pathData.isGrid) {
                    // grid 将从表主字段去除
                    paths.shift();
                }
                if (paths.length) {
                    pathPrefix = paths.join('.') + '.';
                }
            }
            // 不是主键值字段时，要先检查主键是否存在，并且主键是否相等（防止后代变更冒泡上来）
            // 非主键属性变更时，要先检查主键是否匹配（如果主键也修改了，要求先修改主键再修改其他值）
            if (bindingObject.primaryKey) {
                var primaryKey = bindingObject.primaryKey;
                if (propertyName !== primaryKey) {
                    if (!entity[primaryKey] || entity[primaryKey] !== bindingObject[primaryKey]) {
                        return;
                    }
                }
            }
            // 如果BindingObject上的属性值和Entity上对应属性值一样，则不再设置
            if (entity[propertyName] === value) {
                return;
            }
            // 调用表单验证,通过后调用实体验证
            // bingdingObject变化后，先调用实体上的验证，通过后再设置实体的变动
            entity[propertyName] = value;
        });
    };
    /**
     * 将entityList中的Entity对象转换为BindingObject对象，加载到bindingList中，并保持entityList和bindingList同步。
     * @param entityList  实体列表
     * @param bindingList 绑定列表
     */
    EntityUtil.loadEntityList = function (entityList, bindingList) {
        this.loadEntities(entityList.items, bindingList);
        this.setUpEntityListPipeline(entityList, bindingList);
    };
    /**
     * 建立entityList和bindingList之间的关联
     * @param entityList  实体列表
     * @param bindingList 绑定列表
     */
    EntityUtil.setUpEntityListPipeline = function (entityList, bindingList) {
        var _this = this;
        entityList.onListChanged.subscribe(function (modification) {
            switch (modification.type) {
                // 添加实体
                case ModifyType.Add:
                case ModifyType.Clone:
                    {
                        var entitiesToAdd = modification.value;
                        if (entitiesToAdd.length === 0) {
                            return;
                        }
                        // 检查父id是否一致，冒泡导致的变更不处理
                        var paths = modification.path;
                        var parentPath = paths[paths.length - 2];
                        var parentId = bindingList.parent.primaryKeyValue;
                        if (parentPath.indexOf(parentId) === -1) {
                            return;
                        }
                        _this.appendEntities(modification.value, bindingList, modification.type === ModifyType.Clone);
                    }
                    break;
                case ModifyType.Insert:
                    {
                        // 检查父id是否一致，冒泡导致的变更不处理
                        var paths = modification.path;
                        var parentPath = paths[paths.length - 2];
                        var parentId = bindingList.parent.primaryKeyValue;
                        var position = modification.position;
                        if (parentPath.indexOf(parentId) === -1) {
                            return;
                        }
                        _this.insertEntity(modification.value[0], bindingList, position);
                    }
                    break;
                // 删除实体
                case ModifyType.Remove:
                    {
                        // 删除实体（value格式待商榷，目前value的格式为 { primaryKey: primaryValue}）
                        var id = modification.value[bindingList.primaryKey];
                        bindingList.removeByIds([id]);
                        // this.removeEntities(<Entity[]>modification.value, bindingList);
                    }
                    break;
                // 加载实体
                case ModifyType.Load:
                    var entities = modification.value;
                    _this.loadEntities(entities, bindingList);
                    break;
                default:
                    break;
            }
        });
    };
    /**
     * 监听repository变化，保持repository和bindingList同步。
     * @param repository  实体仓库
     * @param bindingList 绑定列表
     */
    EntityUtil.loadRepository = function (repository, bindingList) {
        var _this = this;
        // 初次加载
        var entities = Array.from(repository.entityCollection.toArray());
        this.loadEntities(entities, bindingList);
        // 监听变化
        repository.entityCollectionChange.subscribe(function (modification) {
            switch (modification.type) {
                case ModifyType.Load:
                    _this.loadEntities(modification.value, bindingList, modification.entityCreate);
                    break;
                case ModifyType.Add:
                case ModifyType.Clone:
                    _this.appendEntities(modification.value, bindingList, modification.type === ModifyType.Clone);
                    break;
                case ModifyType.AddData:
                    _this.addData(modification.value, bindingList);
                    break;
                case ModifyType.Insert:
                    _this.insertEntity(modification.value, bindingList, modification.position);
                    break;
                case ModifyType.Remove:
                    _this.removeEntities(modification.value, bindingList);
                    break;
                case ModifyType.RemoveData:
                    _this.removeData(modification.value, bindingList);
                    break;
                case ModifyType.PaginationInfoChange:
                    bindingList.paginationInfo = modification.value;
                    break;
                default:
                    break;
            }
        });
        // 监听BindingList数据变化
        bindingList.changes.subscribe(function (change) {
            if (change.type === ChangeType.PaginationInfoChange) {
                var entityCollection = repository.entityCollection;
                // const entityTypeName = entityCollection.entityTypeName;
                // const original = entityCollection.paginationInfo[entityTypeName];
                // const entityPaginationInfo = Object.assign({}, original, change.value);
                entityCollection.paginationInfo = Object.assign({}, entityCollection.paginationInfo, change.value);
            }
        });
    };
    /**
     * 将entities中的Entity对象转换为BindingObject对象，并加载到bindingList中
     * @param entities    实体数组
     * @param bindingList 绑定列表
     */
    EntityUtil.loadEntities = function (entities, bindingList, entityCreate) {
        if (entityCreate === void 0) { entityCreate = false; }
        var bindingObjects = this.createBindingObjects(entities, bindingList);
        bindingList.load(bindingObjects, entityCreate);
    };
    /**
     * 将entities中的Entity对象转换为BIndingObject对象，并追加到bindingList中
     * @param entities    实体数组
     * @param bindingList 绑定列表
     */
    EntityUtil.appendEntities = function (entities, bindingList, isCloned) {
        if (isCloned === void 0) { isCloned = false; }
        var bindingObjects = this.createBindingObjects(entities, bindingList);
        bindingList.append(bindingObjects, isCloned);
    };
    /**
     * 增加实体数据（不切换当前行）
     * @param entities
     * @param bindingList
     */
    EntityUtil.addData = function (entities, bindingList) {
        var bindingObjects = this.createBindingObjects(entities, bindingList);
        bindingList.addData(bindingObjects);
    };
    EntityUtil.insertEntity = function (entity, bindingList, position) {
        var bindingObject = this.createBindingObject(entity, bindingList);
        bindingList.insert(bindingObject, position);
    };
    /**
     * 从bindingList移除entities对应的BindingObject对象
     * @param entities    实体数组
     * @param bindingList 绑定列表
     */
    EntityUtil.removeEntities = function (entities, bindingList) {
        if (entities === null || entities.length === 0) {
            return;
        }
        // 归集要删除的id数组
        var primaryKey = bindingList.primaryKey;
        var ids = [];
        entities.forEach(function (entity) {
            ids.push(entity[primaryKey]);
        });
        bindingList.removeByIds(ids);
    };
    EntityUtil.removeData = function (entities, bindingList) {
        if (entities === null || entities.length === 0) {
            return;
        }
        // 归集要删除的id数组
        var primaryKey = bindingList.primaryKey;
        var ids = [];
        entities.forEach(function (entity) {
            ids.push(entity[primaryKey]);
        });
        bindingList.removeDataByIds(ids);
    };
    /**
     * 将entities中的Entity对象转换为BindingObject对象
     * @param entities    实体数组
     * @param bindingList 绑定列表
     */
    EntityUtil.createBindingObjects = function (entities, bindingList) {
        var _this = this;
        if (entities === null || entities.length === 0) {
            return [];
        }
        var bindingObjects = [];
        entities.forEach(function (entity) {
            var bindingObject = BindingObjectFactory.create(bindingList.properties);
            bindingObject['_ENTITY_'] = entity;
            _this.loadEntity(entity, bindingObject);
            // // 为bindingObject设置默认值initialData属性
            // if (entity['initialData']) {
            //   bindingObject['initialData'] = entity['initialData'];
            // }
            bindingObjects.push(bindingObject);
        });
        return bindingObjects;
    };
    EntityUtil.createBindingObject = function (entity, bindingList) {
        var bindingObject = BindingObjectFactory.create(bindingList.properties);
        this.loadEntity(entity, bindingObject);
        return bindingObject;
    };
    EntityUtil.watchReposiroty = function (repository, bindingData) {
        // reposiroty => bindingData
        repository.entityCollectionChange.subscribe(function (modification) {
            switch (modification.type) {
                case ModifyType.PaginationInfoChange:
                    bindingData.pagingInfo = modification.value;
                    break;
                default:
                    break;
            }
        });
    };
    /**
     * 查找属性的类型
     * @param entityType 实体类型
     * @param targetPropName 属性名称
     * @return 属性信息，包含属性类型（NgField、NgObject、NgList）和属性对应的实体类型（当NgField类型时为null）
     */
    EntityUtil.getPropInfo = function (entityType, targetPropName) {
        var propType;
        var propEntityType;
        // NgField
        var ngFieldProperties = FieldMetadataUtil.getNgFields(entityType);
        Object.keys(ngFieldProperties).forEach(function (propName) {
            if (propName === targetPropName) {
                propType = 'NgField';
                propEntityType = null;
            }
        });
        // NgObject
        var ngObjectProperties = FieldMetadataUtil.getNgObjects(entityType);
        Object.keys(ngObjectProperties).forEach(function (propName) {
            if (propName === targetPropName) {
                propType = 'NgObject';
                propEntityType = ngObjectProperties[propName].type;
            }
        });
        // NgList
        var ngListProperties = FieldMetadataUtil.getNgList(entityType);
        Object.keys(ngListProperties).forEach(function (propName) {
            if (propName === targetPropName) {
                propType = 'NgList';
                propEntityType = ngListProperties[propName].type;
            }
        });
        var ngDynamicProperties = FieldMetadataUtil.getNgDynamic(entityType);
        Object.keys(ngDynamicProperties).forEach(function (propName) {
            if (propName === targetPropName) {
                propType = 'NgDynamic';
                propEntityType = ngDynamicProperties[propName].type;
            }
        });
        return { propType: propType, propEntityType: propEntityType };
    };
    /**
     * 获取实体的主键名
     * @param entityType 实体类型
     */
    EntityUtil.getPrimaryKey = function (entityType) {
        var primaryNgFiledProp = FieldMetadataUtil.getPrimaryFieldMetadata(entityType);
        if (primaryNgFiledProp) {
            return primaryNgFiledProp.dataField;
        }
        else {
            return '';
        }
    };
    /**
     * 是否为对象属性
     */
    EntityUtil.isObjectProp = function (entityType, targetPropName) {
        var isObjectProp = false;
        var ngObjectProperties = FieldMetadataUtil.getNgObjects(entityType);
        Object.keys(ngObjectProperties).forEach(function (propName) {
            if (propName === targetPropName) {
                isObjectProp = true;
            }
        });
        return isObjectProp;
    };
    /**
     * 检查是否是动态列属性
     */
    EntityUtil.isDynamicProp = function (entityType, targetPropName) {
        var isDynamicProp = false;
        var ngDynamicProperties = FieldMetadataUtil.getNgDynamic(entityType);
        Object.keys(ngDynamicProperties).forEach(function (propName) {
            if (propName === targetPropName) {
                isDynamicProp = true;
            }
        });
        return isDynamicProp;
    };
    /**
     * 为实体增加initialData属性
     * @param entity 实体实例
     * @param initialData 默认值对象
     */
    EntityUtil.appendInitialData = function (entity, initialData) {
        var data = Object.assign({}, initialData);
        delete data.id;
        delete data.parentID;
        entity['initialData'] = data;
    };
    return EntityUtil;
}());

// tslint:disable: max-line-length member-ordering
/**
 * BindingData
 */
var BindingData = /** @class */ (function () {
    function BindingData() {
        this.paginationInfo = null;
    }
    Object.defineProperty(BindingData.prototype, "bindingPath", {
        /**
         * 绑定该路径
         */
        get: function () {
            if (this.viewModelContext && this.viewModelContext.viewModel.bindingPath) {
                return this.viewModelContext.viewModel.bindingPath;
            }
            return '/';
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BindingData.prototype, "pagingInfo", {
        get: function () {
            return this.paginationInfo;
        },
        set: function (pagingInfo) {
            this.paginationInfo = pagingInfo;
            this.firePagingChangeEvent();
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 设置分页信息
     * @param skip 跳过
     * @param take 获取
     * @param bindingPath 路径
     */
    BindingData.prototype.setPagingInfo = function (skip, take, bindingPath) {
        if (bindingPath.length < 1 || bindingPath === '/') {
            this.paginationInfo = Object.assign(this.paginationInfo, { pageSize: take, pageIndex: skip / take + 1 });
        }
        else {
            var pagingInfo_1 = this.paginationInfo || {};
            var bindingPaths = bindingPath.substr(1).split('/').filter(function (item) { return !!item && item.length > 0; }).map(function (item) { return item.substring(0, item.length - 1); });
            bindingPaths.forEach(function (path) {
                if (!pagingInfo_1.hasOwnProperty(path)) {
                    pagingInfo_1[path] = {};
                }
                pagingInfo_1 = pagingInfo_1[path];
            });
            pagingInfo_1.pageIndex = ((skip / take) || 0) + 1;
            pagingInfo_1.pageSize = take || 0;
        }
        this.firePagingChangeEvent();
    };
    BindingData.prototype.firePagingChangeEvent = function () {
        this.list.changes.next({
            type: ChangeType.PaginationInfoChange,
            path: [],
            value: this.paginationInfo
        });
    };
    Object.defineProperty(BindingData.prototype, "changes", {
        /**
         * 变更集
         */
        get: function () {
            return this.list.changes;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 设置值变化执行器工厂
     * @param value 值变化执行器工厂
     */
    BindingData.prototype.setValueChangeInvokerFactory = function (value) {
        this.valueChangeInvokerFactory = value;
    };
    /**
     * 初始化（已废弃）
     */
    BindingData.prototype.init = function (repository, bindingPath) {
        this.initByRepository(repository, null);
    };
    /**
     * 根据Repository对BindingData进行初始化
     */
    BindingData.prototype.initByRepository = function (repository, viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.properties = PropertyUtil.getProperties(repository.entityType);
        this.list = BindingListFactory.create(this.properties);
        // 从repository初始化bindingData
        this.pagingInfo = repository.entityCollection.paginationInfo;
        // @todo
        // BindingData不应该知道Repository，加载数据、建立关联关系的过程应该转移到外边
        EntityUtil.loadRepository(repository, this.list);
        this.dataTypeInfo = repository.entityTypeInfo;
        this.extendProperties(this.properties);
    };
    /**
     * 初始化
     */
    BindingData.prototype.initByBindingList = function (bindingList, viewModelContext, dataTypeInfo) {
        this.list = bindingList;
        this.viewModelContext = viewModelContext;
        this.dataTypeInfo = dataTypeInfo;
        this.extendProperties(this.list.properties);
    };
    /**
     * 获取paths对应的属性值
     * @param  paths 属性路径数组
     * @returns 属性值
     */
    BindingData.prototype.getValue = function (paths) {
        var target = this.list;
        paths.forEach(function (path) {
            if (target) {
                target = target[path];
            }
        });
        return target;
    };
    /**
     * 根据paths设置属性值
     * @param paths 属性路径数组
     * @param value 属性值
     * @param emitEventToView 如果设置为true，则发送事件通知订阅它的组件、指令去更新界面，默认为false。
     * @param emitEventToEntity 如果设置为true，则同步去更新Entity上对应的字段，默认为true。
     */
    BindingData.prototype.setValue = function (paths, value, emitEventToView, emitEventToEntity) {
        if (emitEventToView === void 0) { emitEventToView = false; }
        if (emitEventToEntity === void 0) { emitEventToEntity = true; }
        if (!paths || paths.length === 0) {
            throw Error('路径不能为空');
        }
        var parentPaths = paths.slice(0, paths.length - 1);
        var propName = paths[paths.length - 1];
        var parent = this.getValue(parentPaths);
        if (!parent) {
            throw Error('找不到要设置的对象');
        }
        if (parent instanceof BindingData) {
            parent = parent.list.currentItem;
        }
        else if (parent instanceof BindingList) {
            parent = parent.currentItem;
        }
        if (!!this.valueChangeInvokerFactory) {
            parent.setValue(propName, value, emitEventToView, emitEventToEntity, null, this.valueChangeInvokerFactory(paths));
        }
        else {
            parent.setValue(propName, value, emitEventToView, emitEventToEntity);
        }
    };
    /**
     * 根据paths清空属性值
     */
    BindingData.prototype.clearValue = function (paths, emitEventToView, emitEventToEntity) {
        if (emitEventToView === void 0) { emitEventToView = false; }
        if (emitEventToEntity === void 0) { emitEventToEntity = true; }
        var initValue;
        var propInfo = this.dataTypeInfo.getPropInfoByPath(paths);
        if (propInfo && propInfo.metadataInfo && propInfo.metadataInfo.initValue !== undefined) {
            initValue = propInfo.metadataInfo.initValue;
        }
        else {
            // 原来的帮助映射中，强行纠正了数值的情况，保持一致
            var oldValue = this.getValue(paths);
            if (typeof oldValue === 'number') {
                initValue = 0;
            }
            else {
                initValue = '';
            }
        }
        this.setValue(paths, initValue, emitEventToView, emitEventToEntity);
    };
    /**
     * 获取当前列表
     */
    BindingData.prototype.getList = function () {
        if (!this.bindingPath || this.bindingPath === '/') {
            return this.list;
        }
        var bindingPath = this.bindingPath.substr(1);
        var bindingPathArray = bindingPath.split('/').filter(function (part) {
            return part !== '';
        });
        return this.getValue(bindingPathArray);
    };
    /**
     * 获取当前对象
     */
    BindingData.prototype.getObject = function () {
        var bindingList = this.getList();
        return bindingList.currentItem;
    };
    /**
     * 绑定路径（仅路径部分，不包括属性）
     * @param bindingPath 绑定路径
     */
    BindingData.prototype.getPath = function (bindingPath) {
        var _this = this;
        var bindingPaths = bindingPath.filter(function (p) { return p; });
        var path = [this.list.primaryKey + ":" + this.list.currentId];
        bindingPaths.forEach(function (item) {
            path.push(item);
            var list = _this[item];
            if (list) {
                path.push(list.primaryKey + ":" + list.currentId);
            }
        });
        return path;
    };
    /**
     * 通过绑定路径获取属性初始值
     * @param paths 绑定路径
     */
    BindingData.prototype.getInitValueByPaths = function (paths) {
        var initValue;
        var propInfo = this.dataTypeInfo && this.dataTypeInfo.getPropInfoByPath(paths) || null;
        if (propInfo && propInfo.metadataInfo && propInfo.metadataInfo.initValue !== undefined) {
            initValue = propInfo.metadataInfo.initValue;
        }
        return initValue;
    };
    /**
     * 扩展BindingData属性，映射BindingData所持有的绑定列表当前行的属性，减少绑定层级。
     * @param properties 关联实体的属性集合
     */
    BindingData.prototype.extendProperties = function (properties) {
        var _this = this;
        properties.forEach(function (property) {
            var propName = property.name;
            Object.defineProperty(_this, propName, {
                get: function () {
                    return _this.list.currentItem[propName];
                },
                set: function (value) {
                    _this.list.currentItem[propName] = value;
                }
            });
        });
    };
    return BindingData;
}());

/**
 * BindingList是一个BindingObject集合
 */
var BindingList = /** @class */ (function () {
    /**
     * 构造函数
     */
    function BindingList(properties) {
        //#region 分页相关
        /**
         * 分页信息
         */
        this._paginationInfo = null;
        this.properties = properties;
        this.primaryKey = PropertyUtil.getPrimaryKey(properties);
        this.changes = new Subject();
        this.innerList = [];
        this.currentId = null;
    }
    Object.defineProperty(BindingList.prototype, "paginationInfo", {
        get: function () {
            return this._paginationInfo;
        },
        set: function (sPaginationInfo) {
            this._paginationInfo = sPaginationInfo;
            if (this._paginationInfo === sPaginationInfo) {
                return;
            }
            this.changes.next({
                type: ChangeType.PaginationInfoChange,
                path: [],
                value: this._paginationInfo
            });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BindingList.prototype, "pageIndex", {
        /**
         * 获取页码
         */
        get: function () {
            if (!!this.paginationInfo && this.paginationInfo.hasOwnProperty("pageIndex")) {
                return this.paginationInfo.pageIndex;
            }
            return 1;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BindingList.prototype, "pageSize", {
        /**
         * 获取分页大小
         */
        get: function () {
            if (!!this.paginationInfo && this.paginationInfo.hasOwnProperty("pageSize")) {
                return this.paginationInfo.pageSize;
            }
            return 0;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BindingList.prototype, "total", {
        /**
         * 获取数据总项数
         */
        get: function () {
            if (!!this.paginationInfo) {
                return this.paginationInfo.total || this.paginationInfo.totalCount;
            }
            return 0;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BindingList.prototype, "skip", {
        /**
         * 获取跳过的数据条数
         */
        get: function () {
            var pageIndex = this.pageIndex;
            var pageSize = this.pageSize;
            return (pageIndex - 1) * pageSize;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 前台设置分页信息
     * @param skip skip
     * @param take take
     */
    BindingList.prototype.setPaginationInfo = function (skip, take) {
        this.paginationInfo = Object.assign({}, this.paginationInfo, {
            pageSize: take,
            pageIndex: skip / take + 1
        });
        /*this.changes.next({
          type: ChangeType.PaginationInfoChange,
          path: [],
          value: this.paginationInfo
        });*/
    };
    Object.defineProperty(BindingList.prototype, "currentItem", {
        //#endregion
        /**
         * 当前行对应的绑定对象
         * 如果currentId为null，则创建一个空结构，防止绑定报错；
         */
        get: function () {
            var currentItem = this.findById(this.currentId);
            if (!currentItem) {
                if (!this.emptyCurrentItem) {
                    this.emptyCurrentItem = BindingObjectFactory.create(this.properties);
                }
                return this.emptyCurrentItem;
            }
            return currentItem;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BindingList.prototype, "length", {
        /**
         * 绑定对象的数量
         */
        get: function () {
            return this.innerList.length;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 添加[Symbol.iterator]，使之能通过for of遍历
     */
    BindingList.prototype[Symbol.iterator] = function () {
        var self = this;
        var index = -1;
        var size = this.innerList.length;
        return {
            next: function () {
                index++;
                if (index < size) {
                    return {
                        done: false,
                        value: self.innerList[index]
                    };
                }
                return { done: true, value: undefined };
            }
        };
    };
    /**
     * 批量加载绑定对象，加载之前先清空绑定列表，并重置当前行，加载之后将第一行设置为默认当前行。
     * @param objects 要加载绑定对象数组
     */
    BindingList.prototype.load = function (objects, entityCreate) {
        var _this = this;
        if (entityCreate === void 0) { entityCreate = false; }
        // 重置列表
        this.innerList = [];
        if (objects.length !== 0) {
            // 加载数据
            objects.forEach(function (object) {
                _this.add(object);
            });
            // 设置默认当前行
            var currentItem = this.findById(this.currentId);
            if (!currentItem) {
                var firstId = objects[0][this.primaryKey];
                this.setCurrentId(firstId, false, false);
            }
        }
        else {
            this.currentId = null;
        }
        var change = {
            type: ChangeType.Load,
            path: [],
            value: objects
        };
        change.create = entityCreate;
        // 触发事件
        this.changes.next(change);
    };
    /**
     * 批量追加绑定对象，追加之后将最后一个追加的绑定对象设置为当前行。
     * @param objects 要加载绑定对象数组
     */
    BindingList.prototype.append = function (objects, isCloned) {
        var _this = this;
        if (isCloned === void 0) { isCloned = false; }
        if (objects.length === 0) {
            return;
        }
        // 加载BindingObject
        objects.forEach(function (object) {
            _this.add(object);
        });
        // 当前行为新追加的最后1行
        var lastId = objects[objects.length - 1][this.primaryKey];
        this.setCurrentId(lastId, true, true);
        // 触发事件
        var change = {
            type: ChangeType.Append,
            path: [],
            value: objects
        };
        if (isCloned) {
            change.isCloned = true;
        }
        this.changes.next(change);
    };
    /**
     * 增加数据
     * @param objects 实体
     * @description 增加实体数据，但不切换当前行
     */
    BindingList.prototype.addData = function (objects) {
        var _this = this;
        if (objects.length === 0) {
            return;
        }
        // 加载BindingObject
        objects.forEach(function (object) {
            _this.add(object);
        });
        // 触发事件
        this.changes.next({
            type: ChangeType.Append,
            path: [],
            value: objects
        });
    };
    BindingList.prototype.insert = function (object, position) {
        // const currentIndex = this.innerList.findIndex((obj: BindingObject) => obj.primaryKeyValue === this.currentId);
        // // 加载BindingObject
        // if (position === 1) {
        //   this.innerList = this.innerList.insert(currentIndex + 1, object);
        // } else if (position === -1) {
        //   this.innerList = this.innerList.insert(currentIndex, object);
        // } else {
        //   this.innerList = this.innerList.push(object);
        // }
        // object.parent = this;
        // // 监听object变更，并继续向上抛，由于list有当前行的概念，不需要在path中追加路径
        // object.changes.subscribe((change: Change) => {
        //   this.changes.next(change);
        // });
        // this.setCurrentId(object.primaryKeyValue, true, true);
        // // 触发事件
        // this.changes.next({
        //   type: ChangeType.Append,
        //   path: [],
        //   value: object
        // });
    };
    /**
     * 添加绑定对象，并建立绑定对象和绑定列表之间的关联。
     * @param object 绑定对象
     */
    BindingList.prototype.add = function (object) {
        var _this = this;
        this.innerList.push(object);
        object.parent = this;
        // 监听object变更，并继续向上抛，由于list有当前行的概念，不需要在path中追加路径
        object.changes.subscribe(function (change) {
            _this.changes.next(change);
        });
    };
    /**
     * 删除主键值数组对应的绑定对象。
     * @param ids 主键值数组
     */
    BindingList.prototype.removeByIds = function (ids) {
        var _this = this;
        if (!ids || ids.length === 0) {
            return;
        }
        var nextCurrentId = this.currentId;
        ids.forEach(function (id) {
            // 如果当前行被删除，计算下一当前行
            if (id === nextCurrentId) {
                nextCurrentId = _this.getCurrentIdBeforeDeleting();
            }
            // 删除对象，找不到时跳过
            var index = _this.getIndexById(id);
            if (index === -1) {
                return;
            }
            ArrayUtil.removeByIndex(_this.innerList, index);
        });
        // 重新设置当前行
        if (this.innerList.length === 0) {
            this.currentId = null;
        }
        else {
            this.setCurrentId(nextCurrentId, false, false);
        }
        // 出发行删除事件
        this.changes.next({
            type: ChangeType.Remove,
            path: [],
            value: ids
        });
    };
    /**
     * 删除数据（不切换当前行）
     * @param ids ids
     */
    BindingList.prototype.removeDataByIds = function (ids) {
        // if (!ids || ids.length === 0) {
        //   return;
        // }
        // ids.forEach((id: string) => {
        //   // 删除对象，找不到时跳过
        //   const index = this.getIndexById(id);
        //   if (index === -1) {
        //     return;
        //   }
        //   this.innerList = this.innerList.delete(index);
        // });
        // // 出发行删除事件
        // this.changes.next({
        //   type: ChangeType.Remove,
        //   path: [],
        //   value: ids
        // });
    };
    /**
     * 清空
     */
    BindingList.prototype.clear = function () {
        this.innerList = [];
        this.currentId = null;
        this.changes.next({
            type: ChangeType.Remove,
            path: [],
            value: []
        });
    };
    /**
     * 如果当前行被删除，删除之前重新计算当前行的位置，并返回下一当前行的主键值。
     * - 如果被删除的行是最后1行，则上移1行；
     * - 其他情况，下移1行。
     */
    BindingList.prototype.getCurrentIdBeforeDeleting = function () {
        var nextIndex = -1;
        var currentIndex = this.getIndexById(this.currentId);
        if (currentIndex === this.length - 1) {
            nextIndex = currentIndex - 1;
        }
        else {
            nextIndex = currentIndex + 1;
        }
        return this.getIdByIndex(nextIndex);
    };
    /**
     * 根据主键值获取对应绑定对象
     * @param   id 要查找的主键值
     * @returns 找到时返回对应BindingObject， 找不到时返回null
     */
    BindingList.prototype.findById = function (id) {
        var _this = this;
        var target;
        target = this.innerList.find(function (item) {
            return item.getValue(_this.primaryKey) === id;
        });
        return target === undefined ? null : target;
    };
    /**
     * 将主键值为id的绑定对象设置为当前行
     * @param  id        要设置的主键值
     * @param  emitEvent 是否发送当前行变更事件
     */
    BindingList.prototype.setCurrentId = function (id, emitEvent, emitGlobalEvent) {
        if (emitEvent === void 0) { emitEvent = true; }
        if (emitGlobalEvent === void 0) { emitGlobalEvent = true; }
        if (this.currentId === id) {
            return;
        }
        // 不存在时设置为null
        // const currentObj = this.findById(id);
        // if (!currentObj) {
        //   this.currentId = null;
        // } else {
        //   this.currentId = id;
        // }
        // @todo：找不到时按理应该设置为null，目前是直接返回，框架部分功能依赖该特性。
        var currentObj = this.findById(id);
        if (!currentObj) {
            return;
        }
        this.currentId = id;
        // 发出行切换事件
        if (emitEvent === true) {
            this.changes.next({
                type: ChangeType.SelectionChanged,
                path: [],
                value: this.currentItem
            });
        }
        // 是否发送全局的行切换事件
        if (emitGlobalEvent === true) {
            this.changes.next({
                type: ChangeType.GlobalSelectionChanged,
                path: [],
                value: this.currentItem
            });
        }
    };
    /**
     * 根据主键值为id的绑定对象的索引
     * @param id 主键值
     * @returns 找到时返回对应的index，找不到时返回-1
     */
    BindingList.prototype.getIndexById = function (id) {
        var _this = this;
        return this.innerList.findIndex(function (obj) {
            return obj[_this.primaryKey] === id;
        });
    };
    /**
     * 根据索引位置获取对应绑定对象的主键值
     * @reutrn 找到时返回对应主键值，找不到返回null
     */
    BindingList.prototype.getIdByIndex = function (index) {
        if (index < 0 || index > this.length) {
            return null;
        }
        var obj = this.innerList[index];
        if (!obj) {
            return null;
        }
        return obj[this.primaryKey];
    };
    /**
     * 转换为BindingObject数组
     */
    BindingList.prototype.toArray = function () {
        return this.innerList.concat([]);
    };
    /**
     * 交互数据位置
     * @param id1 id1
     * @param id2 id2
     */
    BindingList.prototype.swapById = function (id1, id2) {
        // const item1 = this.innerList.find(element => element.primaryKeyValue === id1);
        // const item2 = this.innerList.find(element => element.primaryKeyValue === id2);
        // this.innerList = this.innerList.map((bindingObject: BindingObject, index: number) => {
        //   if (bindingObject.primaryKeyValue === id1) {
        //     return item2;
        //   } else if (bindingObject.primaryKeyValue === id2) {
        //     return item1;
        //   } else return bindingObject;
        // }).toList();
        // this.changes.next({
        //   type: ChangeType.Swap,
        //   path: []
        // });
    };
    /**
     * 转换为JSON对象
     * @returns 普通对象数组
     */
    BindingList.prototype.toJSON = function (options) {
        var result = [];
        this.innerList.forEach(function (obj) {
            result.push(obj.toJSON(options));
        });
        return result;
    };
    /**
     * 获取分页信息
     * @param path 路径
     * @param defaultValue 默认值
     */
    BindingList.prototype.getPaginationConfigByPath = function (path, defaultValue) {
        if (!path || path === '/') {
            return this.paginationInfo;
        }
        if (typeof path !== 'string') {
            throw new Error('路径必须为字符串！');
        }
        path = path.substring(1);
        var paths = path.split('/').filter(function (item) { return !!item && item.trim().length > 0; }).map(function (item) { return item.trim(); });
        var config = this.paginationInfo;
        paths.forEach(function (item) {
            if (config && config.hasOwnProperty(item)) {
                config = config[item];
            }
            else {
                config = null;
            }
        });
        return !!config ? config : typeof defaultValue !== 'undefined' ? defaultValue : undefined;
    };
    /**
     * 对bindingList就行排序
     * @param string 排序字段
     * @param directions 排序规则字段
     * @param options 参数
     */
    BindingList.prototype.sortBy = function (fields, directions, options) {
        if (!fields || fields.length < 1 || !directions || directions.length < 1) {
            throw new Error('sortBy:argument error');
        }
        // 默认升序
        var arrFields = typeof fields === 'string' ? fields.split(',') : fields || [];
        var arrDirections = typeof directions === 'string' ? directions.split(',') : directions || [];
        // 排序字段和排序方式应一致
        if (arrFields.length !== arrDirections.length || arrFields.length < 1) {
            throw new Error('sortBy:fields and directions not match');
        }
        // nage,age,total
        var comparator = function (props, orders) { return function (item1, item2) {
            var e_1, _a;
            try {
                for (var props_1 = __values(props), props_1_1 = props_1.next(); !props_1_1.done; props_1_1 = props_1.next()) {
                    var prop = props_1_1.value;
                    var order = ['asc'].includes(orders[props.indexOf(prop)]) ? 1 : -1;
                    if (item1.getValue(prop) > item2.getValue(prop)) {
                        return order * 1;
                    }
                    if (item1.getValue(prop) < item2.getValue(prop)) {
                        return order * -1;
                    }
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (props_1_1 && !props_1_1.done && (_a = props_1.return)) _a.call(props_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
            return 0;
        }; };
        this.innerList = this.innerList.sort(comparator(arrFields, arrDirections));
    };
    BindingList.prototype.getValue = function (target, propName, isMultiLangProp, currentLanguage) {
        var e_2, _a;
        if (isMultiLangProp === void 0) { isMultiLangProp = false; }
        if (currentLanguage === void 0) { currentLanguage = 'zh-CHS'; }
        if (target instanceof BindingList) {
            target = target.currentItem;
        }
        else if (target instanceof BindingData) {
            target = target.list.currentItem;
        }
        var result = null;
        if (propName.indexOf('.') === -1) {
            result = target[propName];
        }
        else {
            var props = propName.split('.');
            try {
                for (var props_2 = __values(props), props_2_1 = props_2.next(); !props_2_1.done; props_2_1 = props_2.next()) {
                    var prop = props_2_1.value;
                    target = result = this.getValue(target, prop, isMultiLangProp, currentLanguage);
                }
            }
            catch (e_2_1) { e_2 = { error: e_2_1 }; }
            finally {
                try {
                    if (props_2_1 && !props_2_1.done && (_a = props_2.return)) _a.call(props_2);
                }
                finally { if (e_2) throw e_2.error; }
            }
        }
        if (isMultiLangProp && result && result.hasOwnProperty(currentLanguage)) {
            return result[currentLanguage];
        }
        else {
            return result;
        }
    };
    return BindingList;
}());

var BindingDataFactory = /** @class */ (function () {
    function BindingDataFactory() {
    }
    /**
     * 根据Repository创建一个BindingData
     */
    BindingDataFactory.createFromRepository = function (repository, bindingPath) {
        var bindingData = new BindingData();
        var bindingProperties = PropertyUtil.getProperties(repository.entityType);
        var bindingList = BindingListFactory.create(bindingProperties);
        bindingData.initByBindingList(bindingList, null, repository.entityTypeInfo);
        EntityUtil.loadRepository(repository, bindingList);
        // 从repository初始化bindingData
        bindingData.pagingInfo = repository.entityCollection.paginationInfo;
        return bindingData;
    };
    /**
     * 根据EntityManager创建BindingData，并建立双向关联（请勿使用）
     * @internal
     * @summary
     * 1、该方法暂时仅供内部单元测试使用；
     * 2、该方法暂时只创建BindingData，不建立双向关联
     */
    BindingDataFactory.createFromEntityManager = function (entityManager, bindingPath) {
        var bindingData = new BindingData();
        var bindingProperties = PropertyUtil.getProperties(entityManager.entityType);
        var bindingList = BindingListFactory.create(bindingProperties);
        bindingData.initByBindingList(bindingList, null, entityManager.entityCollection.entityTypeInfo);
        // 初始化数据
        var entities = entityManager.getEntitiesByPath([]);
        EntityUtil.loadEntities(entities, bindingList);
        return bindingData;
    };
    /**
     * 根据已经存在的BindingData创建一个新的BindingData
     */
    BindingDataFactory.createFromExistingBindingData = function (existingBindingData, bindingPath) {
        var bindingData = new BindingData();
        bindingData.initByBindingList(existingBindingData.list, null, bindingData.dataTypeInfo);
        return bindingData;
    };
    return BindingDataFactory;
}());

/**
 * EntityPath转换器
 */
var EntityPathConverter = /** @class */ (function () {
    function EntityPathConverter() {
    }
    /**
     * 转换为Entity可识别的路径
     * 根：[]
     * 主表：['id:xxx', 'name'],
     * 关联：['id:xxx', 'deptInfo', 'id:xxx', 'name']
     * UDT: ['id:xxx', 'updateInfo', ':', 'createdOn']
     * 从表：['id:xxx', 'edus', 'id:xxx', 'name'],
     * 从从表：['id:xxx', 'edus', 'id:xxx', 'grades', 'id:xxx', 'name']
     */
    EntityPathConverter.toEntityPathArray = function (bindingPathString, bindingData) {
        var _this = this;
        var bindingPathArray = BindingPathConverter.toBindingPathArray(bindingPathString);
        var entityPathArray = [];
        if (bindingPathArray.length === 0) {
            return entityPathArray;
        }
        // 根节点
        var currentBindingObject = bindingData.list.currentItem;
        entityPathArray.push(this.createPrimaryKeyPath(currentBindingObject.primaryKey, currentBindingObject.primaryKeyValue));
        bindingPathArray.forEach(function (propName) {
            var propInfo = PropertyUtil.getPropertyByName(currentBindingObject.properties, propName);
            switch (propInfo.type) {
                case BindingPropertyType.Plain:
                    entityPathArray.push(propName);
                    break;
                case BindingPropertyType.Object:
                    currentBindingObject = currentBindingObject[propName];
                    entityPathArray.push(propName);
                    entityPathArray.push(_this.createPrimaryKeyPath(currentBindingObject.primaryKey, currentBindingObject.primaryKeyValue));
                    break;
                case BindingPropertyType.List:
                    var currentBindingList = currentBindingObject[propName];
                    currentBindingObject = currentBindingList.currentItem;
                    entityPathArray.push(propName);
                    entityPathArray.push(_this.createPrimaryKeyPath(currentBindingObject.primaryKey, currentBindingObject.primaryKeyValue));
                    break;
                default:
                    break;
            }
        });
        return entityPathArray;
    };
    /**
     * 创建路径中的主键部分
     */
    EntityPathConverter.createPrimaryKeyPath = function (primaryKey, primaryKeyValue) {
        return primaryKey + ":" + primaryKeyValue;
    };
    return EntityPathConverter;
}());

/**
 * 实体路径比较器
 */
var EntityPathComparer = /** @class */ (function () {
    function EntityPathComparer() {
    }
    return EntityPathComparer;
}());

/**
 * 表单路径转换类
 */
var FormPathConverter = /** @class */ (function () {
    function FormPathConverter() {
    }
    /**
     * ControlPathString => BingingPathArray
     * @params controlPath FormControl对应的数据绑定路径（BindingData的bindingPaht + FormControl的binding）
     * @return BindingPath数组
     */
    FormPathConverter.toBindingPathArray = function (formPahtString) {
        var bindingPathArray = formPahtString.split('.').filter(function (part) {
            return part !== '';
        });
        return bindingPathArray;
    };
    return FormPathConverter;
}());

/**
 * 数据路径转换、比较等工具类
 * @summary
 * ----------------------------------------
 * 术语：
 * BindingPath：数组形式；
 * BindingPathString：BindingPath的字符串形式，用/分隔；
 * ControlPathString：BindingPath的字符串形式，用.分隔；
 *
 * EntityPath：数组形式；
 * EntityPathString：EntityPath的字符串形式，使用/分隔；
 * ----------------------------------------
 */

/**
 * 路径处理工具类（处理/PathNode1/PathNode2/...格式的路径）
 */
var DataPathUtil = /** @class */ (function () {
    function DataPathUtil() {
    }
    /**
     * 转换成BindingData可识别的路径
     */
    DataPathUtil.convertToBindingPathArray = function (path) {
        var bindingPathArray = path.split('/').filter(function (part) {
            return part !== '';
        });
        return bindingPathArray;
    };
    /**
     * 转换为Entity可识别的路径
     * 根：[]
     * 主表：['id:xxx', 'name'],
     * 关联：['id:xxx', 'deptInfo', 'id:xxx', 'name']
     * UDT: ['id:xxx', 'updateInfo', ':', 'createdOn']
     * 从表：['id:xxx', 'edus', 'id:xxx', 'name'],
     * 从从表：['id:xxx', 'edus', 'id:xxx', 'grades', 'id:xxx', 'name']
     */
    DataPathUtil.convertToEntityPathArray = function (path, bindingData) {
        var _this = this;
        var bindingPathArray = this.convertToBindingPathArray(path);
        var entityPathArray = [];
        if (bindingPathArray.length === 0) {
            return entityPathArray;
        }
        // 根节点
        var currentBindingObject = bindingData.list.currentItem;
        entityPathArray.push(this.createPrimaryKeyPath(currentBindingObject.primaryKey, currentBindingObject.primaryKeyValue));
        bindingPathArray.forEach(function (propName) {
            var propInfo = PropertyUtil.getPropertyByName(currentBindingObject.properties, propName);
            switch (propInfo.type) {
                case BindingPropertyType.Plain:
                    entityPathArray.push(propName);
                    break;
                case BindingPropertyType.Object:
                    currentBindingObject = currentBindingObject[propName];
                    entityPathArray.push(propName);
                    entityPathArray.push(_this.createPrimaryKeyPath(currentBindingObject.primaryKey, currentBindingObject.primaryKeyValue));
                    break;
                case BindingPropertyType.List:
                    var currentBindingList = currentBindingObject[propName];
                    currentBindingObject = currentBindingList.currentItem;
                    entityPathArray.push(propName);
                    entityPathArray.push(_this.createPrimaryKeyPath(currentBindingObject.primaryKey, currentBindingObject.primaryKeyValue));
                    break;
                default:
                    break;
            }
        });
        return entityPathArray;
    };
    /**
     * 转换为RestUrl里的路径
     *
     * 返回结果：
     * 主表（/）：/
     * 从表（/jiwtEdus）：/xxx/jiwtEdus
     * 从从表（/jiwtEdus/jiwtGrades）： /xxx/jiwtEdus/xxx/jiwtGrades
     */
    DataPathUtil.convertToRestUrl = function (path, bindingData) {
        var bindingPathArray = this.convertToBindingPathArray(path);
        var restPathArray = [];
        var currentBindingObject = bindingData.list.currentItem;
        restPathArray.push(currentBindingObject.primaryKeyValue);
        bindingPathArray.forEach(function (propName) {
            var propInfo = PropertyUtil.getPropertyByName(currentBindingObject.properties, propName);
            if (propInfo.type !== BindingPropertyType.List) {
                throw new Error(propInfo.name + "\u4E0D\u662F\u5B50\u8868\u5BF9\u5E94\u7684\u5C5E\u6027");
            }
            var currentBindingList = currentBindingObject[propName];
            currentBindingObject = currentBindingList.currentItem;
            restPathArray.push(propName);
            restPathArray.push(currentBindingObject.primaryKeyValue);
        });
        // 移除最后一个主键
        restPathArray.pop();
        return '/' + restPathArray.join('/');
    };
    /**
     * 获取叶子节点的Path
     */
    DataPathUtil.getLeafPath = function (path) {
        var pathArray = DataPathUtil.convertToBindingPathArray(path);
        return pathArray.pop();
    };
    /**
     * 获取父路径
     */
    DataPathUtil.getParentPath = function (path) {
        var pathArray = DataPathUtil.convertToBindingPathArray(path);
        pathArray.pop();
        return '/' + pathArray.join('/');
    };
    /**
     * 创建路径中的主键部分
     */
    DataPathUtil.createPrimaryKeyPath = function (primaryKey, primaryKeyValue) {
        return primaryKey + ":" + primaryKeyValue;
    };
    return DataPathUtil;
}());

// tslint:disable: max-line-length
/**
 * GUID创建服务
 * @scope 静态类没有提供Provider
 */
var Guid = /** @class */ (function () {
    function Guid(guid) {
        if (!guid) {
            throw new TypeError('Invalid argument; `value` has no value.');
        }
        this.value = Guid.EMPTY;
        if (guid && Guid.isGuid(guid)) {
            this.value = guid;
        }
    }
    Guid.isGuid = function (guid) {
        var value = guid.toString();
        return guid && (guid instanceof Guid || Guid.validator.test(value));
    };
    Guid.create = function () {
        return new Guid([Guid.gen(2), Guid.gen(1), Guid.gen(1), Guid.gen(1), Guid.gen(3)].join('-'));
    };
    Guid.createEmpty = function () {
        return new Guid('emptyguid');
    };
    Guid.parse = function (guid) {
        return new Guid(guid);
    };
    Guid.raw = function () {
        return [Guid.gen(2), Guid.gen(1), Guid.gen(1), Guid.gen(1), Guid.gen(3)].join('-');
    };
    Guid.gen = function (count) {
        var out = '';
        for (var i = 0; i < count; i++) {
            // tslint:disable-next-line:no-bitwise
            out += (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
        }
        return out;
    };
    Guid.prototype.equals = function (other) {
        // Comparing string `value` against provided `guid` will auto-call
        // toString on `guid` for comparison
        return Guid.isGuid(other) && this.value === other.toString();
    };
    Guid.prototype.isEmpty = function () {
        return this.value === Guid.EMPTY;
    };
    Guid.prototype.toString = function () {
        return this.value;
    };
    Guid.prototype.toJSON = function () {
        return {
            value: this.value,
        };
    };
    Guid.validator = new RegExp('^[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}$', 'i');
    Guid.EMPTY = '00000000-0000-0000-0000-000000000000';
    return Guid;
}());

/*
 * @Author: aalizzwell
 * @Date: 2019-10-25 13:30:52
 * @Last Modified by:   aalizzwell
 * @Last Modified time: 2019-10-25 13:30:52
 */
var isObservable = function (value) {
    if (!value) {
        return false;
    }
    if (value[Symbol.observable] && value === value[Symbol.observable]()) {
        return true;
    }
    if (value['@@observable'] && value === value['@@observable']()) {
        return true;
    }
    if (value instanceof Observable) {
        return true;
    }
    return false;
};
var ɵ0$1 = isObservable;

/**
 * 环境工具类
 */
var EnvUtil = /** @class */ (function () {
    function EnvUtil() {
    }
    /**
     * 是否在任务中心中运行
     */
    EnvUtil.isInWf = function () {
        var url = window.top.location.pathname;
        if (url.indexOf('wf/webapp/apptaskcenter') !== -1 || url.indexOf('wf/webapp/mobiletaskcenter') !== -1 || url.indexOf('wf/webapp/proc-center-mobile') !== -1) {
            return true;
        }
        return false;
    };
    return EnvUtil;
}());

/**
 * Url工具类
 */
var UrlUtil = /** @class */ (function () {
    function UrlUtil() {
    }
    /**
     * 获取参数对象
     */
    UrlUtil.getParams = function (url) {
        var urlParts = url.split('?');
        if (urlParts.length < 2) {
            return null;
        }
        var params = {};
        var paramsString = urlParts[1];
        var keyValueStrings = paramsString.split('&');
        keyValueStrings.forEach(function (keyValueString) {
            if (!keyValueString) {
                return;
            }
            var keyValue = keyValueString.split('=');
            if (keyValue.length < 2) {
                return;
            }
            params[keyValue[0]] = keyValue[1];
        });
        return params;
    };
    return UrlUtil;
}());

/**
 * 【对象属性元数据】名称
 */
var OBJECT_PROP_META = 'ObjectPropMeta';
/**
 * 【对象属性元数据装饰器工厂】的工厂
 */
function makeObjectPropMetaDecorator(options) {
    if (ObjectUtil.isPlainObject(options)) {
        return options;
    }
    var type = typeof options;
    if (type === 'string') {
        return {
            dataField: options
        };
    }
    if (type === 'function') {
        return {
            type: options
        };
    }
}
/**
 * 对象属性元数据装饰器工厂
 */
var ObjectPropMeta = makePropDecorator(OBJECT_PROP_META, makeObjectPropMetaDecorator);

/**
 * 【动态对象元数据装饰器】名称
 */
var DYNAMIC_PROP_META = 'DynamicPropMeta';
/**
 * 【动态对象元数据装饰器工厂】的工厂
 */
function makeDynamicPropMetaDecorator(options) {
    if (ObjectUtil.isPlainObject(options)) {
        return options;
    }
    var type = typeof options;
    if (type === 'string') {
        return {
            dataField: options
        };
    }
    if (type === 'function') {
        return {
            type: options
        };
    }
}
/**
 * 实体属性注解
 */
var DynamicPropMeta = makePropDecorator(DYNAMIC_PROP_META, makeDynamicPropMetaDecorator);

/**
 * 【列表属性元数据】名称
 */
var LIST_PROP_META = 'ListPropMeta';
/**
 * 【列表属性元数据装饰器工厂】的工厂
 */
function makeListPropMetaDecorator(options) {
    if (ObjectUtil.isPlainObject(options)) {
        return options;
    }
    var type = typeof options;
    if (type === 'string') {
        return {
            dataField: options
        };
    }
    if (type === 'function') {
        return {
            type: options
        };
    }
}
/**
 * 列表属性装饰器工厂
 */
var ListPropMeta = makePropDecorator(LIST_PROP_META, makeListPropMetaDecorator);

var ENTITY_META = 'EntityMeta';
/**
 * 实体装饰器
 */
function EntityMeta(options) {
    var decoratorFactory = makeDecorator(ENTITY_META, function (obj) { return obj; });
    return decoratorFactory(options);
}

/**
 * 属性注解器通用方法
 */
var FieldMetadataUtil = /** @class */ (function () {
    function FieldMetadataUtil() {
    }
    /**
     * 获取实体所有的简单属性元数据
     * @param target 实体类型
     * @returns 形如：{[propName: string]: NgObjectProperty}
     */
    FieldMetadataUtil.getNgFields = function (target) {
        return MetadataUtil.getPropsMetadatasByName(target, PRIMITIVE_PROP_META);
    };
    /**
     * 获取某个简单属性的元数据
     */
    FieldMetadataUtil.getNgField = function (target, propName) {
        var ngFields = this.getNgFields(target);
        var ngField = ngFields[propName];
        return ngField;
    };
    /**
     * 获取实体属性在原始数据中的属性名
     */
    FieldMetadataUtil.getDataField = function (target, propName) {
        var ngField = this.getNgField(target, propName);
        return ngField.dataField || propName;
    };
    /**
     * 获取标注为NgObject的属性的元数据
     * @param target 实体类型
     * @returns 形如：{[propName: string]: NgObjectProperty}
     */
    FieldMetadataUtil.getNgObjects = function (target) {
        return MetadataUtil.getPropsMetadatasByName(target, OBJECT_PROP_META);
    };
    FieldMetadataUtil.getNgDynamic = function (target) {
        return MetadataUtil.getPropsMetadatasByName(target, DYNAMIC_PROP_META);
    };
    /**
     * 获取标注为NgList的属性的元数据
     * @param target 实体类型
     * @returns 形如：{[propName: string]: NgListProperty}
     */
    FieldMetadataUtil.getNgList = function (target) {
        return MetadataUtil.getPropsMetadatasByName(target, LIST_PROP_META);
    };
    /**
     * 获取实体标注为主键的属性元数据
     * @param target 实体类型
     */
    FieldMetadataUtil.getPrimaryFieldMetadata = function (target) {
        var ngFieldObj = FieldMetadataUtil.getNgFields(target);
        var primaryKey = Object.keys(ngFieldObj).find(function (prop) {
            return ngFieldObj[prop].primary;
        });
        if (primaryKey) {
            var propMeta = ngFieldObj[primaryKey];
            propMeta.property = primaryKey;
            if (!propMeta.dataField) {
                propMeta.dataField = primaryKey;
            }
            return propMeta;
        }
        return undefined;
    };
    /**
     * 获取主键名称，没有主键时返回空字符串
     */
    FieldMetadataUtil.getPrimaryKey = function (entityType) {
        var primaryNgField = this.getPrimaryFieldMetadata(entityType);
        if (!primaryNgField) {
            return '';
        }
        return primaryNgField.property;
    };
    return FieldMetadataUtil;
}());

/**
 * 实体元数据工具类
 */
var EntityMetadataUtil = /** @class */ (function () {
    function EntityMetadataUtil() {
    }
    /**
     * 获取所有属性
     * @todo：封装根据基类获取所有元数据的方法，解决重复代码
     */
    EntityMetadataUtil.getAllNgProperties = function (entityType) {
        var ngPlainProperties = this.getNgFieldProperties(entityType);
        var ngEntityProperties = this.getNgObjectProperties(entityType);
        var ngDynamicProperties = this.getNgDynamicProperties(entityType);
        var ngEntityListProperties = this.getNgObjectProperties(entityType);
        return Object.assign({}, ngPlainProperties, ngEntityProperties, ngDynamicProperties, ngEntityListProperties);
    };
    /**
     * 获取EnttiyClassMetadata
     */
    EntityMetadataUtil.getNgEntityMatadata = function (entityType) {
        return MetadataUtil.getClassMetadataByNameWithTranslate(entityType, ENTITY_META);
    };
    /**
     * 获取PrimitivePropMetadata的属性元数据
     */
    EntityMetadataUtil.getNgFieldProperties = function (entityType) {
        return MetadataUtil.getPropsMetadatasByName(entityType, PRIMITIVE_PROP_META);
    };
    /**
     * 获取ObjectPropMetadata属性元数据
     */
    EntityMetadataUtil.getNgObjectProperties = function (entityType) {
        return MetadataUtil.getPropsMetadatasByName(entityType, OBJECT_PROP_META);
    };
    /**
     * 获取DynamicPropMetadata属性元数据
     */
    EntityMetadataUtil.getNgDynamicProperties = function (entityType) {
        return MetadataUtil.getPropsMetadatasByName(entityType, DYNAMIC_PROP_META);
    };
    /**
     * 获取ListPropMetadata属性元数据
     */
    EntityMetadataUtil.getNgListProperties = function (entityType) {
        return MetadataUtil.getPropsMetadatasByName(entityType, LIST_PROP_META);
    };
    /**
     * 获取主键属性元数据
     */
    EntityMetadataUtil.getPrimaryKeyProperty = function (entityType) {
        var primaryKeyProperty;
        var ngPlainProperties = EntityMetadataUtil.getNgFieldProperties(entityType);
        Object.keys(ngPlainProperties).forEach(function (propName) {
            var ngProperty = ngPlainProperties[propName];
            if (ngProperty.primary === true) {
                primaryKeyProperty = ngProperty;
            }
        });
        return primaryKeyProperty;
    };
    return EntityMetadataUtil;
}());

/*
 * @Author: Witt
 * @Date: 2018-12-07 09:05:09
 * @Last Modified by: Witt
 * @Last Modified time: 2018-12-27 20:35:02
 */
/**
 * 实体类型信息
 * @todo：
 * 1、构造时不应该识别Entity模块的东西，应该是更抽象的；
 * 2、构造函数应该接收一个Builder接口，由Entity或者其他实现层来实现这个接口。
 */
var DataTypeInfo = /** @class */ (function () {
    /**
     * 构造函数
     * @todo：不应该识别
     */
    function DataTypeInfo(type) {
        this.type = type;
        this.primaryKey = '';
        this.foreignKey = '';
        this.propInfoMap = new Map();
        this.collectEntityInfos();
        this.collectPropInfos();
    }
    Object.defineProperty(DataTypeInfo.prototype, "isValueObject", {
        /**
         * 是否为值对象
         */
        get: function () {
            return !this.primaryKey;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 获取全部属性信息
     */
    DataTypeInfo.prototype.getPropInfos = function () {
        return Array.from(this.propInfoMap.values());
    };
    /**
     * 获取全部属性的名称
     */
    DataTypeInfo.prototype.getPropNames = function () {
        var propNames = [];
        var propInfos = this.getPropInfos();
        propInfos.forEach(function (propInfo) {
            propNames.push(propInfo.name);
        });
        return propNames;
    };
    /**
     * 根据group获取属性信息数组
     */
    DataTypeInfo.prototype.getPropInfosByGroup = function (group) {
        var allPropInfos = Array.from(this.propInfoMap.values());
        var propInfos = allPropInfos.filter(function (propInfo) {
            return propInfo.group === group;
        });
        return propInfos;
    };
    /**
     * 根据group获取属性名称数组
     * @param group 属性分组
     */
    DataTypeInfo.prototype.getPropNamesByGroup = function (group) {
        var propNames = [];
        var propInfos = this.getPropInfosByGroup(group);
        propInfos.forEach(function (propInfo) {
            propNames.push(propInfo.name);
        });
        return propNames;
    };
    /**
     * 根据propName获取属性信息
     */
    DataTypeInfo.prototype.getPropInfoByName = function (propName) {
        if (this.propInfoMap.has(propName)) {
            return this.propInfoMap.get(propName);
        }
        return null;
    };
    /**
     * 根据path获取属性信息
     */
    DataTypeInfo.prototype.getPropInfoByPath = function (path) {
        // 先复制，防止shift方法产生污染
        var arrPath = path.concat([]);
        if (arrPath.length === 0) {
            throw Error("\u5C5E\u6027\u8DEF\u5F84\u4E0D\u80FD\u4E3A\u7A7A");
        }
        // 循环查找
        var typeInfo = this;
        var propInfo = null;
        while (typeInfo && arrPath.length > 0) {
            var propName = arrPath.shift();
            propInfo = typeInfo.getPropInfoByName(propName);
            if (!propInfo) {
                throw Error("\u8DEF\u5F84" + path + "\u4E2D\u5B58\u5728\u4E0D\u6B63\u786E\u7684\u8282\u70B9" + propName + "\uFF0C\u8BF7\u68C0\u67E5");
            }
            typeInfo = propInfo.typeInfo;
            // 如果是动态列，并且路径数组里还有属性，统一设置为null(动态列不再描述属性信息)
            if (propInfo.group === DataPropGroup.Dynamic && arrPath.length > 0) {
                propInfo = null;
                typeInfo = null;
            }
        }
        return propInfo;
    };
    /**
     * 根据path获取对应属性的TypeInfo
     */
    DataTypeInfo.prototype.getTypeInfoByPath = function (path) {
        // 空数组时返回
        if (path.length === 0) {
            return this;
        }
        // 获取对应属性信息
        var propInfo = this.getPropInfoByPath(path);
        if (!propInfo.typeInfo) {
            throw Error("\u8DEF\u5F84" + path + "\u65E0\u6CD5\u5B9A\u4F4D\u5230\u4E00\u4E2AEntityTypeInfo\uFF0C\u8BF7\u68C0\u67E5");
        }
        return propInfo.typeInfo;
    };
    /**
     * 获取主键的属性信息
     */
    DataTypeInfo.prototype.getPrimaryKeyPropInfo = function () {
        return this.getPropInfoByName(this.primaryKey);
    };
    /**
     * 根据name获取影射名
     */
    DataTypeInfo.prototype.getPropMappingByName = function (name) {
        var propInfo = this.getPropInfoByName(name);
        if (!propInfo) {
            return '';
        }
        return propInfo.mapping;
    };
    /**
     * 根据path获取映射名
     */
    DataTypeInfo.prototype.getPropMappingByPath = function (path) {
        var propInfo = this.getPropInfoByPath(path);
        if (!propInfo) {
            return '';
        }
        return propInfo.mapping;
    };
    /**
     * 检查属性是否属于特定的分组
     */
    DataTypeInfo.prototype.checkPropGroup = function (propName, propGroup) {
        var propInfo = this.getPropInfoByName(propName);
        if (propInfo && propInfo.group === propGroup) {
            return true;
        }
        return false;
    };
    /**
     * --------------------------------------------------------------------------------
     * 属性元数据 => 属性描述信息
     * --------------------------------------------------------------------------------
     */
    DataTypeInfo.prototype.collectEntityInfos = function () {
        var entityMetadata = EntityMetadataUtil.getNgEntityMatadata(this.type);
        this.entityInfo = entityMetadata;
    };
    /**
     * 搜集所有属性信息
     * @todo：消除重复代码，ts不支持interface类型检测，暂时通过遍历实现。
     */
    DataTypeInfo.prototype.collectPropInfos = function () {
        var _this = this;
        // 简单属性
        var ngPlainProperties = EntityMetadataUtil.getNgFieldProperties(this.type);
        Object.keys(ngPlainProperties).forEach(function (propName) {
            var ngProperty = ngPlainProperties[propName];
            if (ngProperty.primary === true) {
                _this.primaryKey = propName;
            }
            if (ngProperty.foreign === true) {
                _this.foreignKey = propName;
            }
            _this.addPropInfo(DataPropGroup.Primitive, propName, ngProperty.dataField, null, ngProperty);
        });
        // 实体属性
        var ngEntityProperties = EntityMetadataUtil.getNgObjectProperties(this.type);
        Object.keys(ngEntityProperties).forEach(function (propName) {
            var ngProperty = ngEntityProperties[propName];
            _this.addPropInfo(DataPropGroup.Object, propName, ngProperty.dataField, ngProperty.type, ngProperty);
        });
        // 动态实体属性
        var ngDynamicProperties = EntityMetadataUtil.getNgDynamicProperties(this.type);
        Object.keys(ngDynamicProperties).forEach(function (propName) {
            var ngProperty = ngDynamicProperties[propName];
            _this.addPropInfo(DataPropGroup.Dynamic, propName, ngProperty.dataField, null, ngProperty);
        });
        // 实体列表属性
        var ngEntityListProperties = EntityMetadataUtil.getNgListProperties(this.type);
        Object.keys(ngEntityListProperties).forEach(function (propName) {
            var ngProperty = ngEntityListProperties[propName];
            _this.addPropInfo(DataPropGroup.List, propName, ngProperty.dataField, ngProperty.type, ngProperty);
        });
    };
    /**
     * 添加属性信息
     */
    DataTypeInfo.prototype.addPropInfo = function (group, name, mapping, type, metadataInfo) {
        // 没有设置影射时，用属性名充当影射
        mapping = mapping ? mapping : name;
        var typeInfo = null;
        if (type) {
            typeInfo = new DataTypeInfo(type);
        }
        var propInfo = { group: group, name: name, mapping: mapping, typeInfo: typeInfo, metadataInfo: metadataInfo };
        this.propInfoMap.set(name, propInfo);
    };
    return DataTypeInfo;
}());

/**
 * 数据Path工厂类
 */
var DataPathCreator = /** @class */ (function () {
    function DataPathCreator() {
    }
    /**
     * 将长路径数组或字符串转换为
     * @param fullPathArrayOrString 路径数组或字符串
     * @param repository 实体仓库
     * @summary
     * 1、长路径格式说明参考：data-path.md
     */
    DataPathCreator.createByLongPathFromRoot = function (fullPathArrayOrString, entityManager) {
        var dataPath = new DataPath();
        var fullPathArray = fullPathArrayOrString;
        if (!fullPathArray || fullPathArray.length === 0) {
            return dataPath;
        }
        var currentNodeInfo = {
            nodeValue: fullPathArray.shift(),
            nodeType: DataPathNodeType.DataId,
            entityTypeInfo: new DataTypeInfo(entityManager.entityType)
        };
        while (currentNodeInfo) {
            dataPath.push(currentNodeInfo.nodeType, currentNodeInfo.nodeValue);
            // 处理下一个节点
            var nextNodeValue = fullPathArray.shift();
            if (!nextNodeValue || !currentNodeInfo.entityTypeInfo) {
                break;
            }
            currentNodeInfo = this.getNextPathNodeInfo(currentNodeInfo, nextNodeValue);
        }
        return dataPath;
    };
    /**
     * 获取下一个路径节点的信息
     * @param parentNodeInfo 当前路径节点信息
     * @param nextNodeValue 下一个路径节点的值
     * @summary
     * 1、这个递归写的很绕，说明数据结构设计不合理；
     * 2、多个因素混用了一个结构；
     */
    DataPathCreator.getNextPathNodeInfo = function (parentNodeInfo, nextNodeValue) {
        var parentNodeValue = parentNodeInfo.nodeValue;
        var parentNodeType = parentNodeInfo.nodeType;
        var parentEntityTypeInfo = parentNodeInfo.entityTypeInfo;
        if (!nextNodeValue || !parentEntityTypeInfo) {
            return null;
        }
        var nextPathNodeInfo = {
            nodeValue: nextNodeValue,
            nodeType: null,
            entityTypeInfo: null
        };
        // DataNodeType=List：下一节点肯定是Object，并且EntityTypeInfo不变
        if (parentNodeType === DataPathNodeType.DataId) {
            nextPathNodeInfo.nodeType = DataPathNodeType.PropName;
            nextPathNodeInfo.entityTypeInfo = parentEntityTypeInfo;
        }
        else {
            // DataNodeType=Object：必然对应一个属性信息
            var nextPropInfo = parentEntityTypeInfo.getPropInfoByName(parentNodeValue);
            if (nextPropInfo.group === DataPropGroup.List) {
                // EntityPropGroup=EntityList：下一个节点是List类型。
                nextPathNodeInfo.nodeType = DataPathNodeType.DataId;
                nextPathNodeInfo.entityTypeInfo = nextPropInfo.typeInfo;
            }
            else {
                // EntityPropGroup=Entity：       下级entityTypeInfo为
                // EntityPropGroup=Dynamic|Plain：null
                nextPathNodeInfo.nodeType = DataPathNodeType.PropName;
                nextPathNodeInfo.entityTypeInfo = nextPropInfo.group === DataPropGroup.Object ? nextPropInfo.typeInfo : null;
            }
        }
        return nextPathNodeInfo;
    };
    /**
     * @param fullPathArrayOrString 路径数组或字符串
     * @param repository 实体仓库
     * @summary
     * 1、长路径格式说明参考：data-path.md
     * 2、shortPathArrayOrString暂时只支持字符串数组
     */
    DataPathCreator.createByShortPathFromRoot = function (shortPathArrayOrString, entityManager, bindingData) {
        var dataPath = new DataPath();
        var shortPathArray = shortPathArrayOrString;
        // 根节点
        var currentBindingObject = bindingData.list.currentItem;
        var currentEntityTypeInfo = new DataTypeInfo(entityManager.entityType);
        dataPath.push(DataPathNodeType.DataId, currentBindingObject.primaryKeyValue);
        // 遍历下级节点
        shortPathArray.forEach(function (propName) {
            var propInfo = currentEntityTypeInfo.getPropInfoByName(propName);
            switch (propInfo.group) {
                case DataPropGroup.Primitive:
                    dataPath.push(DataPathNodeType.PropName, propName);
                    break;
                case DataPropGroup.Object:
                    currentBindingObject = currentBindingObject[propName];
                    currentEntityTypeInfo = propInfo.typeInfo;
                    dataPath.push(DataPathNodeType.PropName, propName);
                    break;
                case DataPropGroup.List:
                    var currentBindingList = currentBindingObject[propName];
                    currentBindingObject = currentBindingList.currentItem;
                    currentEntityTypeInfo = propInfo.typeInfo;
                    dataPath.push(DataPathNodeType.PropName, propName);
                    dataPath.push(DataPathNodeType.DataId, currentBindingObject.primaryKeyValue);
                    break;
                default:
                    break;
            }
        });
        return dataPath;
    };
    return DataPathCreator;
}());

/**
 * 获取path对应的实体
 * @summary
 * 关于path的格式如下：
 * - 主表：[parentId]
 * - 主表关联: [parentId, assoInfo]
 * - 从表: [parentId, child1s, child1Id]
 * - 从表关联：[parentId, child1s, child1Id, assoInfo]
 * - 从从表: [parentId, child1s, child1Id, grand11s, grand11Id]
 * - 从从表关联：[parentId, child1s, child1Id, grand11s, grand11Id, assoInfo]
 */

var PARENT_PATH = '__PARENT_PATH__';
var PARENT_CLASS = '__PARENT__';

/**
 * 创建实体
 * @param entityType 实体类型
 * @param entityData 实体数据
 */
function createEntity(entityType, entityData) {
    var entity = new entityType(entityData);
    return entity;
}
/**
 * 批量创建实体
 * @param entityType     实体类型
 * @param entityListData 实体数据数组
 */
function createEntities(entityType, entityListData) {
    var entities = [];
    entityListData.forEach(function (entityData) {
        var entity = createEntity(entityType, entityData);
        entities.push(entity);
    });
    return entities;
}
/**
 * 已弃用：请使用createEntity方法代替。
 */
function EntityFactory(T, data) {
    var entity = new T(data);
    return entity;
}

/**
 * 实体集合列表
 */
var EntityList = /** @class */ (function () {
    // #endregion
    /**
     * @param data JSON数据集合
     * @param type 集合中的实体类型
     */
    function EntityList(data, type) {
        var _this = this;
        this.__type__ = 'EntityList';
        // #region 私有属性
        this.originalData = [];
        /**
         * 已废弃：请勿使用
         */
        this.listChanged = new Subject();
        /**
         * 已废弃：请勿使用
         */
        this.changeSet = new ChangeSet();
        // #endregion
        // #region 公有属性
        /**
         * 集合改变时触发(新增、行记录修改、删除)
         * @event
         */
        this.onListChanged = this.listChanged.asObservable();
        this.clear();
        if (data) {
            // this.loadEntities(data);
            data.forEach(function (item) {
                _this.initEntity(EntityFactory(type, item));
            });
        }
    }
    Object.defineProperty(EntityList.prototype, "items", {
        /**
         * 获取项集合
         */
        get: function () {
            return this.rawData;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityList.prototype, "changes", {
        /**
         * 列表变更集
         */
        get: function () {
            return this.changeSet.changes;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 迭代器
     */
    EntityList.prototype[Symbol.iterator] = function () {
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0: return [5 /*yield**/, __values(this.items)];
                case 1:
                    _a.sent();
                    return [2 /*return*/];
            }
        });
    };
    // #region 公有方法
    /** 加载实体列表 */
    EntityList.prototype.loadEntities = function (entities) {
        var _this = this;
        this.clear();
        entities.forEach(function (entity) {
            _this.initEntity(entity);
        });
        // 发送Load变更
        var changeItem = {
            path: [],
            value: entities,
            preValue: undefined,
            type: ModifyType.Load,
            target: this
        };
        this.setChanges(changeItem);
    };
    /**
     * 清空
     */
    EntityList.prototype.clear = function () {
        this.rawData = [];
        this.originalData = [];
    };
    /**
     * 添加实体对象到集合中，并返回新加的对象
     * @param entity 实体对象
     * @param isCloned 克隆
     */
    EntityList.prototype.appendNew = function (entity, isCloned) {
        if (isCloned === void 0) { isCloned = false; }
        var newEntity = this.initEntity(entity, true);
        // 新增变更
        var changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Add
        };
        if (isCloned === true) {
            changeItem.type = ModifyType.Clone;
        }
        this.setChanges(changeItem);
        return newEntity;
    };
    /**
     * 在指定位置插入实体
     * @param entity 实体
     * @param position 插入位置
     */
    EntityList.prototype.insert = function (entity, position) {
        var newEntity = this.initEntity(entity, true);
        // 新增变更
        var changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Insert,
            position: position,
        };
        this.setChanges(changeItem);
        return newEntity;
    };
    /**
     * 追加实体
     */
    EntityList.prototype.appendEntity = function (entity) {
        var newEntity = this.initEntity(entity);
        // 新增变更
        var changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Add
        };
        this.setChanges(changeItem);
    };
    /**
     * 批量追加实体
     */
    EntityList.prototype.appendEntities = function (entities) {
        var _this = this;
        var newEntites = entities.map(function (entity) {
            return _this.initEntity(entity);
        });
        var changeItem = {
            path: [],
            value: newEntites,
            preValue: undefined,
            type: ModifyType.Add
        };
        this.setChanges(changeItem);
    };
    /**
     * 删除指定主键ID 的实体对象，返回布尔，true 删除成功，false 删除失败
     * @param primaryId 主键ID
     */
    EntityList.prototype.remove = function (primaryId) {
        var _a;
        var total = this.count();
        var indexToRemove = this.rawData.findIndex(function (entity) {
            return entity.primaryValue === primaryId;
        });
        if (indexToRemove === -1) {
            return false;
        }
        var entityToRemove = this.rawData[indexToRemove];
        this.rawData.splice(indexToRemove, 1);
        // 删除变更
        var changeItem = {
            path: [],
            value: (_a = {}, _a[entityToRemove.primaryProperty.dataField] = primaryId, _a),
            preValue: undefined,
            type: ModifyType.Remove
        };
        this.updateIndex(total);
        this.setChanges(changeItem);
        return true;
    };
    /**
     * 从集合中获取指定ID值的实体对象
     * @param id 主键值
     */
    EntityList.prototype.get = function (id) {
        return this.items.find(function (item) {
            return item.primaryValue === id;
        });
    };
    /**
     * 将变更记录添加到集合变更集中
     * @param value 变更记录
     */
    EntityList.prototype.setChanges = function (modinfo) {
        // 向app层发送的变更
        this.listChanged.next(modinfo);
        // 构造向changeSet中添加的chagne
        var change = Object.assign({}, modinfo);
        if ((modinfo.type === ModifyType.Add || modinfo.type === ModifyType.Insert || modinfo.type === ModifyType.Clone) && modinfo.value[0] instanceof Entity) {
            change.value = [modinfo.value[0].data];
        }
        this.changeSet.append(change);
    };
    /** 集合总记录数 */
    EntityList.prototype.count = function () {
        return this.items.length;
    };
    /**
     * 获取实体对象的索引值
     */
    EntityList.prototype.indexOf = function (entity) {
        return this.items.indexOf(entity);
    };
    /**
     * 计算集合中某个属性的总和
     * @param propertyName 属性名称
     */
    EntityList.prototype.sum = function (propertyName) {
        if (this.count() === 0) {
            return 0;
        }
        return this.items.reduce(function (val, curr) {
            return val + curr[propertyName];
        }, 0);
    };
    /**
     * 已废弃：请使用toJSON方法代替
     * @deprecated
     */
    EntityList.prototype.toJson = function () {
        return this.rawData;
    };
    /**
     * 转换为JSON格式
     */
    EntityList.prototype.toJSON = function () {
        var result = [];
        this.items.forEach(function (entity) {
            result.push(entity.toJSON());
        });
        return result;
    };
    EntityList.prototype.toArray = function () {
        return this.items;
    };
    // #endregion
    // #region 私有方法
    /**
     * 实体初始化
     * @param entity 实体
     */
    EntityList.prototype.initEntity = function (entity, isNewEntity) {
        var _this = this;
        if (isNewEntity === void 0) { isNewEntity = false; }
        entity[PARENT_CLASS] = this;
        entity[PARENT_PATH] = this[PARENT_PATH];
        entity.onValueChanged.subscribe(function (v) {
            var path = v.path;
            var value = v.value;
            var preValue = v.preValue;
            var operator = v.type;
            var subChanges = { path: path, value: value, preValue: preValue, type: operator };
            if (v.changeSetValue !== undefined) {
                subChanges['changeSetValue'] = v.changeSetValue;
            }
            _this.setChanges(subChanges);
        });
        // TODO: 添加数据验证逻辑代码
        var newLength = this.rawData.push(entity);
        this[newLength - 1] = entity;
        if (!isNewEntity) {
            this.originalData.push(entity.toJSON());
        }
        return entity;
    };
    /**
     * 更新索引
     * @param total 总记录数
     */
    EntityList.prototype.updateIndex = function (total) {
        var _this = this;
        for (var i = 0; i < total; i++) {
            delete this[i];
        }
        this.rawData.forEach(function (entity, index) {
            _this[index] = entity;
        });
    };
    /**
     * 获取属性名称
     */
    EntityList.prototype.getPropertyName = function () {
        var path = this[PARENT_PATH];
        if (path && path.length) {
            var name_1 = path[path.length - 1];
            return name_1;
        }
        return undefined;
    };
    return EntityList;
}());

function EntityFactory$1(T, data) {
    var entity = new T(data);
    return entity;
}

;
/**
 * @author Lucas Huang
 * 实体抽象基类，所有实体必须扩展自Entity
 *
 * ### 使用示例
 * ```
 * export class UserEntity extends Entity {
 *    userId: string;
 *    userName: string;
 *
 *    constructor(data: any){
 *        super(data);
 *    }
 * }
 * ```
 */
var Entity = /** @class */ (function () {
    // #endregion
    /**
     * @param data JSON数据
     */
    function Entity(data) {
        // #region 私有、保护属性
        /**
         * 验证错误集合
         */
        this.validErrors = {};
        /**
         * 增量变更集合
         */
        this.changeSet = new ChangeSet();
        /**
         * 是否正在验证
         */
        this.isValidating = false;
        /**
         * 新数据
         */
        this.newData = undefined;
        // #endregion
        // #region 公有属性
        /**
         * 变更流
         */
        this.valueChanged = new Subject();
        /**
         * 属性值改变时触发
         *
         * ### 使用示例
         * ```
         *  const entity = new UserEntity(data);
         *  entity.onValueChanged.subscribe((data: Modification) => {
         *      console.log(data);
         *  })
         *
         * ```
         *
         * @event
         */
        this.onValueChanged = this.valueChanged.asObservable();
        /**
         * 是否变更
         */
        this.hasChange = false;
        this.newData = Object.assign({}, data);
        this.onValueChanged = this.valueChanged;
        this.initialize();
    }
    Object.defineProperty(Entity.prototype, "data", {
        /**
         * 返回JSON格式的数据
         */
        get: function () {
            return this.newData;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Entity.prototype, "errors", {
        /**
         * 验证错误集合
         */
        get: function () {
            return this.validErrors;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Entity.prototype, "changes", {
        /**
         * 实体变更集
         */
        get: function () {
            return this.changeSet.changes;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Entity.prototype, "primaryProperty", {
        /**
         * 实体主键元数据
         */
        get: function () {
            return FieldMetadataUtil.getPrimaryFieldMetadata(this.constructor);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Entity.prototype, "primaryKey", {
        /**
         * 主键
         * @todo
         * 1、没有主键时返回''不合理，应该返回undefined
         */
        get: function () {
            if (this.primaryProperty) {
                return this.primaryProperty.property;
            }
            else {
                return '';
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Entity.prototype, "primaryValue", {
        /**
         * 实体主键值
         * 1、没有主键时返回''不合理，应该返回undefined
         */
        get: function () {
            if (this.primaryKey) {
                // return this[this.primaryProperty.property].toString();
                var primaryValue = this[this.primaryProperty.property];
                return primaryValue ? primaryValue : '';
            }
            else {
                return '';
            }
        },
        enumerable: true,
        configurable: true
    });
    // #region 公有方法
    /**
     * 将变更记录保存至变更集中
     * @param value 变更记录
     */
    Entity.prototype.setChanges = function (value) {
        var propertyName = value.path[value.path.length - 1];
        // 增加实体变化后增加标志，加载数据或者重新加载不做标记
        if (value.type !== ModifyType.Load) {
            this.hasChange = true;
        }
        // @todo：事件会从下级向上冒泡，change可能是下级的，不能和当前Entity的newData合并。
        // this.newData = Object.assign(this.newData, { [propertyName]: value.value });
        this.valueChanged.next(value);
        this.changeSet.append(value);
    };
    Entity.prototype.getPaths = function () {
        var pathObj = {
            path: [],
            isUdt: false,
            isGrid: false
        };
        var handleParent = function (item) {
            var parentPaths = item[PARENT_PATH];
            if (parentPaths) {
                var prop = parentPaths[parentPaths.length - 1];
                // 父级所在实体包含的ngObject，存在当前实体字段，则判断为UDt字段
                if (Object.keys(FieldMetadataUtil.getNgObjects(item[PARENT_CLASS].constructor)).indexOf(prop) > -1) {
                    pathObj.isUdt = true;
                }
                // 存在类型为ngList，则判断为grid
                if (item[PARENT_CLASS] && item instanceof EntityList === true) {
                    pathObj.isGrid = true;
                }
                pathObj.path.push(prop);
            }
            if (item[PARENT_CLASS] && item instanceof EntityList === true) {
                handleParent(item[PARENT_CLASS]);
            }
        };
        handleParent(this);
        pathObj.path = pathObj.path.reverse();
        return pathObj;
    };
    /**
     * 加载数据
     * @param data 新数据
     */
    Entity.prototype.load = function (data) {
        if (!data) {
            data = {};
        }
        this.loadFields(data);
        this.loadLists(data);
        this.loadObjects(data);
        this.loadDynamicObjects(data);
        this.newData = Object.assign({}, data);
    };
    /**
     * 转换为JSON
     */
    Entity.prototype.toJSON = function () {
        var _this = this;
        var result = {};
        // 简单属性
        var ngFields = FieldMetadataUtil.getNgFields(this.constructor);
        Object.keys(ngFields).forEach(function (propName) {
            var ngField = ngFields[propName];
            var dataField = ngField.dataField || propName;
            result[dataField] = _this[propName];
        });
        // 对象属性
        var ngObjects = FieldMetadataUtil.getNgObjects(this.constructor);
        Object.keys(ngObjects).forEach(function (propName) {
            var ngObject = ngObjects[propName];
            var dataField = ngObject.dataField || propName;
            result[dataField] = _this[propName] ? _this[propName].toJSON() : {};
        });
        // 动态属性
        var ngDynamics = FieldMetadataUtil.getNgDynamic(this.constructor);
        Object.keys(ngDynamics).forEach(function (propName) {
            var ngDynamic = ngDynamics[propName];
            var dataField = ngDynamic.dataField || propName;
            result[dataField] = _this[propName] ? _this[propName].toJSON() : {};
        });
        // 列表属性
        var ngLists = FieldMetadataUtil.getNgList(this.constructor);
        Object.keys(ngLists).forEach(function (propName) {
            var ngList = ngLists[propName];
            var dataField = ngList.dataField || propName;
            result[dataField] = _this[propName] ? _this[propName].toJSON() : {};
        });
        return result;
    };
    // #endregion
    //#region 实体初始化相关private方法
    /**
     * 初始化实体
     */
    Entity.prototype.initialize = function () {
        var constructor = this.constructor;
        var ngFields = FieldMetadataUtil.getNgFields(constructor);
        var ngObjects = FieldMetadataUtil.getNgObjects(constructor);
        var ngLists = FieldMetadataUtil.getNgList(constructor);
        var ngDynamic = FieldMetadataUtil.getNgDynamic(constructor);
        this.initializeNormalField(ngFields);
        this.initializeList(ngLists);
        this.initializeObject(ngObjects);
        this.initializeDynamic(ngDynamic);
    };
    /**
     * 创建path
     * @param propertyName 属性名称
     */
    Entity.prototype.createPath = function (propertyName) {
        var primaryFieldMetadata = this.primaryProperty;
        if (primaryFieldMetadata) {
            var primaryDataField = primaryFieldMetadata.dataField;
            return [primaryDataField + ':' + this.primaryValue, propertyName];
        }
        else {
            return [':', propertyName];
        }
    };
    /**
     * 属性字段初始化
     * @param ngFields 属性字段元数据
     */
    Entity.prototype.initializeNormalField = function (ngFields) {
        var _this = this;
        Object.keys(ngFields).forEach(function (propName) {
            var ngField = ngFields[propName];
            var dataField = ngField.dataField || propName;
            if (delete _this[propName]) {
                Object.defineProperty(_this, propName, {
                    get: function () {
                        return this.getPropValue(propName, ngField);
                    },
                    set: function (newPropValue) {
                        // 影响清空关联字段的主键值，移除此逻辑
                        // // 有主键的实体，不允许给实体赋空值
                        // if (this.primaryKey && this.primaryKey === propName && !newPropValue) {
                        //   return;
                        // }
                        // 有主键的实体，必须先给主键赋值，否则其他字段不允许赋值
                        if (this.primaryKey && this.primaryKey !== propName && !this.primaryValue) {
                            return;
                        }
                        // 值相同时不触发变更。
                        var oldPropValue = this.getPropValue(propName, ngField);
                        if (this.isPropValueChanged(propName, ngField, newPropValue, oldPropValue) === false) {
                            return;
                        }
                        this.setPropValue(propName, ngField, newPropValue);
                        this.emitValueChange(propName, ngField, newPropValue, oldPropValue);
                    },
                    configurable: true
                });
            }
        });
    };
    /**
     * 初始化列表类型的元数据
     * @param ngListMetadata 列表类型元数据
     */
    Entity.prototype.initializeList = function (ngListMetadata) {
        var _this = this;
        Object.keys(ngListMetadata).forEach(function (propertyName) {
            var fieldMetadata = ngListMetadata[propertyName];
            var path = _this.createPath(propertyName);
            var dataField = fieldMetadata.dataField || propertyName;
            var val = _this.data[dataField];
            var entityList = new EntityList();
            entityList[PARENT_CLASS] = _this;
            entityList[PARENT_PATH] = path;
            if (val) {
                var entities = val.map(function (v) { return EntityFactory$1(fieldMetadata.type, v); });
                entityList.loadEntities(entities);
            }
            entityList.onListChanged.subscribe(function (value) {
                if (value) {
                    if (entityList[PARENT_PATH][0] !== value.path[0]) {
                        value.path = entityList[PARENT_PATH].concat(value.path);
                    }
                    _this.setChanges(value);
                }
            });
            _this[propertyName] = entityList;
        });
    };
    /**
     * 初始化子对象
     * @param ngObjectMetadata 子对象元数据
     */
    Entity.prototype.initializeObject = function (ngObjectMetadata) {
        var _this = this;
        Object.keys(ngObjectMetadata).forEach(function (propertyName) {
            var fieldMetadata = ngObjectMetadata[propertyName];
            var path = _this.createPath(propertyName);
            var dataField = fieldMetadata.dataField || propertyName;
            // val不存在时，用空对象代替
            var val = _this.data[dataField] || {};
            var createEntityFromJsonData = function (value) {
                var instance;
                if (value instanceof fieldMetadata.type) {
                    instance = value;
                }
                else {
                    instance = EntityFactory$1(fieldMetadata.type, value);
                }
                instance[PARENT_CLASS] = _this;
                instance[PARENT_PATH] = path;
                instance.onValueChanged.subscribe(function (changes) {
                    if (changes) {
                        changes.path = (_this[PARENT_PATH] || []).concat(changes.path);
                        _this.setChanges(changes);
                    }
                });
                return instance;
            };
            // 如果没有值用一个空对象代替
            var childEntity = createEntityFromJsonData(val);
            if (delete _this[propertyName]) {
                Object.defineProperty(_this, propertyName, {
                    get: function () {
                        return childEntity;
                    },
                    set: function (value) {
                        var modifyInfo = {
                            path: childEntity[PARENT_PATH],
                            value: value.data,
                            preValue: this[propertyName].data,
                            type: ModifyType.ValueChange
                        };
                        childEntity = createEntityFromJsonData(value);
                        this.setChanges(modifyInfo);
                    },
                    configurable: true
                });
            }
        });
    };
    Entity.prototype.initializeDynamic = function (ngDynamicMetadata) {
        var _this = this;
        Object.keys(ngDynamicMetadata).forEach(function (propertyName) {
            var fieldMetadata = ngDynamicMetadata[propertyName];
            var path = _this.createPath(propertyName);
            var dataField = fieldMetadata.dataField || propertyName;
            var originalData = _this.data[dataField] || {};
            var createEntityFromJsonData = function (value) {
                var instance;
                if (value instanceof fieldMetadata.type) {
                    instance = value;
                }
                else {
                    instance = EntityFactory$1(fieldMetadata.type, value);
                }
                instance[PARENT_CLASS] = _this;
                instance[PARENT_PATH] = path;
                instance.onValueChanged.subscribe(function (changes) {
                    if (changes) {
                        changes.path = (_this[PARENT_PATH] || []).concat(changes.path);
                        _this.setChanges(changes);
                    }
                });
                return instance;
            };
            var dynamicEntity = createEntityFromJsonData(originalData);
            if (delete _this[propertyName]) {
                Object.defineProperty(_this, propertyName, {
                    get: function () {
                        return dynamicEntity;
                    },
                    set: function (value) {
                        var modifyInfo = {
                            path: dynamicEntity[PARENT_PATH],
                            value: value.data,
                            preValue: this[propertyName].data,
                            type: ModifyType.ValueChange
                        };
                        dynamicEntity = createEntityFromJsonData(value);
                        this.setChanges(modifyInfo);
                    },
                    configurable: true
                });
            }
        });
    };
    //#endregion
    // #region 加载实体数据相关private、projected方法
    /**
     * 加载简单字段值
     * @todo 临时用修改的方式模拟
     */
    Entity.prototype.loadFields = function (data) {
        var _this = this;
        var ngFields = FieldMetadataUtil.getNgFields(this.constructor);
        Object.keys(ngFields).forEach(function (propName) {
            var ngField = ngFields[propName];
            var dataField = ngField.dataField || propName;
            // if (ngField.primary === false) {
            //   this[propName] = data[dataField];
            // }
            _this[propName] = data[dataField];
        });
    };
    /**
     * 加载子列表数据
     * @param data 数据
     */
    Entity.prototype.loadLists = function (data) {
        var _this = this;
        var ngLists = FieldMetadataUtil.getNgList(this.constructor);
        Object.keys(ngLists).forEach(function (propName) {
            var ngList = ngLists[propName];
            var dataField = ngList.dataField || propName;
            var entityType = ngList.type;
            // 创建实体
            var listData = data[dataField];
            if (listData) {
                var entities = listData.map(function (entityData) {
                    return EntityFactory$1(entityType, entityData);
                });
                _this[propName].loadEntities(entities);
            }
            else {
                _this[propName].loadEntities([]);
            }
        });
    };
    Entity.prototype.loadObjects = function (data) {
        var _this = this;
        var ngObjects = FieldMetadataUtil.getNgObjects(this.constructor);
        Object.keys(ngObjects).forEach(function (propName) {
            var ngObject = ngObjects[propName];
            var dataField = ngObject.dataField || propName;
            var objectData = data[dataField];
            var entity = _this[propName];
            if (!entity || !objectData) {
                return;
            }
            entity.load(objectData);
        });
    };
    Entity.prototype.loadDynamicObjects = function (data) {
        var _this = this;
        var ngDynamicObjects = FieldMetadataUtil.getNgDynamic(this.constructor);
        Object.keys(ngDynamicObjects).forEach(function (propName) {
            var ngDynamicObject = ngDynamicObjects[propName];
            var dataField = ngDynamicObject.dataField || propName;
            var dynamicData = data[dataField] || {};
            var dynamicEntity = _this[propName];
            if (!dynamicEntity) {
                return;
            }
            dynamicEntity.loadDynamicData(dynamicData);
        });
    };
    // #endregion
    // #region 私有工具方法
    /**
     * 发送值变更
     */
    Entity.prototype.emitValueChange = function (propName, propMetadata, newPropValue, oldPropValue) {
        var change = {
            path: this.createPath(propName),
            value: newPropValue,
            preValue: oldPropValue,
            type: ModifyType.ValueChange
        };
        if (this[PARENT_PATH]) {
            change.path = this[PARENT_PATH].concat(change.path);
        }
        this.setChanges(change);
    };
    /**
     * 获取属性值
     */
    Entity.prototype.getPropValue = function (propName, propMetadata) {
        var _a;
        var dataField = propMetadata.dataField || propName;
        var value = this.data[dataField];
        // 对多语录入字段，query不返回问题进行兼容
        if (propMetadata.enableMultiLangInput === true && !value) {
            var langCode = window.localStorage.getItem('languageCode') || 'zh-CHS';
            var originDataField = dataField.replace('_MULTILANGUAGE', '');
            return _a = {},
                _a[langCode] = this.data[originDataField],
                _a;
        }
        return value;
    };
    /**
     * 设置属性值
     */
    Entity.prototype.setPropValue = function (propName, propMetadata, propValue) {
        var dataField = propMetadata.dataField || propName;
        this.data[dataField] = propValue;
    };
    /**
     * 检查属性值是否发生变化
     */
    Entity.prototype.isPropValueChanged = function (propName, propMetadata, newPropValue, oldPropValue) {
        if (propMetadata.enableMultiLangInput === true) {
            if (this.isEmptyMultiLangPropValue(newPropValue) === true && this.isEmptyMultiLangPropValue(oldPropValue) === true) {
                return false;
            }
            return JSON.stringify(newPropValue) !== JSON.stringify(oldPropValue);
        }
        else {
            return newPropValue !== oldPropValue;
        }
    };
    /**
     * 多语录入字段的值是否为空
     */
    Entity.prototype.isEmptyMultiLangPropValue = function (value) {
        return !value || Object.keys(value).length === 0;
    };
    return Entity;
}());

/**
 * 支持动态字段集合的动态实体
 */
var DynamicEntity = /** @class */ (function (_super) {
    __extends(DynamicEntity, _super);
    /**
     * @param data JSON数据
     */
    function DynamicEntity(data) {
        var _this = _super.call(this, data) || this;
        _this.loadDynamicData(data);
        return _this;
    }
    Object.defineProperty(DynamicEntity.prototype, "IsNested", {
        /**
         * 是否是嵌套的动态实体
         */
        get: function () {
            return this[PARENT_CLASS] instanceof DynamicEntity;
        },
        enumerable: true,
        configurable: true
    });
    DynamicEntity.prototype.loadDynamicData = function (dynamicData) {
        this.initializeDynamicField(dynamicData);
        // super.loadFields(dynamicData);
    };
    /**
     * 初始化动态数据
     * @param dynamicData 动态数据
     */
    DynamicEntity.prototype.initializeDynamicField = function (dynamicData) {
        var _this = this;
        // 遍历动态数据的key，创建动态实体属性。
        Object.keys(dynamicData).forEach(function (propertyName) {
            // 如果属性已经存在，先删除
            if (_this[propertyName]) {
                delete _this[propertyName];
            }
            var dataField = propertyName;
            if (dynamicData[propertyName] instanceof Object) {
                var path_1 = _this.createPath(propertyName);
                var dynamicEntity_1 = _this.createDynamicEntityFromJsonData(dynamicData[propertyName], path_1);
                Object.defineProperty(_this, propertyName, {
                    get: function () {
                        return dynamicEntity_1;
                    },
                    set: function (value) {
                        var modifyInfo = {
                            path: dynamicEntity_1[PARENT_PATH],
                            value: value.data,
                            preValue: this[propertyName].data,
                            type: ModifyType.ValueChange
                        };
                        dynamicEntity_1 = this.createDynamicEntityFromJsonData(value, path_1);
                        this.setChanges(modifyInfo);
                    },
                    configurable: true
                });
            }
            else {
                Object.defineProperty(_this, propertyName, {
                    // 定义返回数据方法。
                    get: function () {
                        // 从初始数据返回字段值。
                        return this.data[dataField];
                    },
                    set: function (value) {
                        // 值相同时不触发变更。
                        var oldValue = this.data[dataField];
                        if (oldValue === value) {
                            return;
                        }
                        // 更新元数据数据。
                        this.data[dataField] = value;
                        // 变更集
                        var changes = {
                            type: ModifyType.ValueChange,
                            path: this.createPath(propertyName),
                            value: value,
                            preValue: oldValue
                        };
                        if (this[PARENT_PATH]) {
                            changes.path = this[PARENT_PATH].concat(changes.path);
                        }
                        this.setChanges(changes);
                    },
                    configurable: true
                });
            }
        });
    };
    DynamicEntity.prototype.createDynamicEntityFromJsonData = function (value, parentPath) {
        var _this = this;
        var instance;
        if (value instanceof DynamicEntity) {
            instance = value;
        }
        else {
            instance = new DynamicEntity(value);
        }
        instance[PARENT_CLASS] = this;
        instance[PARENT_PATH] = parentPath;
        instance.onValueChanged.subscribe(function (changes) {
            if (changes) {
                changes.path = (_this[PARENT_PATH] || []).concat(changes.path);
                _this.setChanges(changes);
            }
        });
        return instance;
    };
    /**
     * 将变更记录保存至变更集中
     * @param value 变更记录
     * @todo
     * 1、preValue的处理有问题，下级传递上来的变更这样可以，根DyanmicaEntity上的，data已经发生变化，prevalue和value是一样了；
     * 2、当value是下级冒泡上来的，需要根据value去更新当前层级的data，该逻辑不应该放在setChagnes，待修改。
     */
    DynamicEntity.prototype.setChanges = function (value) {
        var _a;
        var propertyName = value.path[value.path.length - 1];
        var preValue = Object.assign({}, this.data);
        this.newData = Object.assign(this.newData, (_a = {}, _a[propertyName] = value.value, _a));
        var parentPath = value.path;
        if (value.path.length > 2) {
            parentPath = value.path.slice(0, value.path.length - 2);
        }
        // 统一不使用构造函数（保持和其他位置对Modification的构造一致）
        // const parentModification = new Modification(this.data, value.type, parentPath, preValue);
        var parentModification = {
            path: parentPath,
            value: this.data,
            preValue: preValue,
            type: value.type
        };
        this.valueChanged.next(parentModification);
        this.changeSet.append(value);
    };
    /**
     * toJSON
     */
    DynamicEntity.prototype.toJSON = function () {
        return this.data;
    };
    return DynamicEntity;
}(Entity));

/**
 * REPOSITORY_META
 */
var REPOSITORY_META = 'RepositoryMeta';
/**
 * RepositoryMeta
 */
function RepositoryMeta(options) {
    var decoratorFactory = makeDecorator(REPOSITORY_META, function (obj) { return obj; });
    return decoratorFactory(options);
}

// tslint:disable: no-bitwise
/**
 * 实体集合
 * @todo：应该用EntityList代替。
 */
var EntityCollection = /** @class */ (function () {
    /**
     * 构造函数
     */
    function EntityCollection(entityType) {
        this.innerEntitySet = new Set();
        this.innerEntityMap = new Map();
        this.collectionChanged = new Subject();
        this.changes = new Subject();
        this.entityType = entityType;
        this.primaryKey = FieldMetadataUtil.getPrimaryKey(this.entityType);
    }
    /**
     * 实体数量
     */
    EntityCollection.prototype.count = function () {
        return this.innerEntitySet.size;
    };
    Object.defineProperty(EntityCollection.prototype, "entityTypeName", {
        get: function () {
            return this.entityType.name;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 是否包含指定主键值的实体
     * @param id 主键值
     */
    EntityCollection.prototype.has = function (id) {
        return this.innerEntityMap.has(id);
    };
    /**
     * 清空全部实体
     */
    EntityCollection.prototype.clear = function () {
        this.innerEntityMap.clear();
        this.innerEntitySet.clear();
        this.notifyCollectionChanged(new Modification([], ModifyType.Load));
    };
    /**
     * 清空全部实体
     * @param isReset 是否为重置实体操作
     */
    EntityCollection.prototype.reset = function () {
        this.innerEntityMap.clear();
        this.innerEntitySet.clear();
        var modification = new Modification([], ModifyType.Load);
        modification.isReset = true;
        this.notifyCollectionChanged(modification);
    };
    /**
     * 转换为实体数组
     */
    EntityCollection.prototype.toArray = function () {
        return Array.from(this.innerEntitySet);
    };
    /**
     * 转换为JSON数组
     */
    EntityCollection.prototype.toJSON = function () {
        var result = [];
        var entities = this.toArray();
        entities.forEach(function (entity) {
            result.push(entity.toJSON());
        });
        return result;
    };
    /**
     * 批量加载实体
     */
    EntityCollection.prototype.loadEntities = function (entities, entityCreate) {
        var _this = this;
        if (entityCreate === void 0) { entityCreate = false; }
        this.innerEntityMap.clear();
        this.innerEntitySet.clear();
        entities.forEach(function (entity) {
            _this.innerEntitySet.add(entity);
            _this.innerEntityMap.set(entity[_this.primaryKey], entity);
            _this.listenEntityChangeEvent(entity);
        });
        var modification = new Modification(entities, ModifyType.Load);
        modification.entityCreate = entityCreate;
        this.notifyCollectionChanged(modification);
    };
    /**
     * 追加实体
     * @param entity 要追加的实体
     * @param isCloned 实体是否是克隆的
     */
    EntityCollection.prototype.addEntity = function (entity, isCloned) {
        if (isCloned === void 0) { isCloned = false; }
        this.verifyEntityToAdd(entity);
        this.innerEntitySet.add(entity);
        this.innerEntityMap.set(entity[this.primaryKey], entity);
        this.listenEntityChangeEvent(entity);
        var modifyType = isCloned ? ModifyType.Clone : ModifyType.Add;
        this.notifyCollectionChanged(new Modification([entity], modifyType));
    };
    /**
     * 在当前行前或后插入数据
     * @param entity 实体
     * @param position 位置
     */
    EntityCollection.prototype.insertEntity = function (entity, position) {
        this.verifyEntityToAdd(entity);
        this.innerEntitySet.add(entity);
        this.innerEntityMap.set(entity[this.primaryKey], entity);
        this.listenEntityChangeEvent(entity);
        this.notifyCollectionChanged(new Modification(entity, ModifyType.Insert, null, null, position));
    };
    /**
     * 更新实体
     * @param entity entity
     * @param entityData 实体数据
     */
    EntityCollection.prototype.updateEntity = function (entity, entityData) {
        entity.load(entityData);
        this.notifyCollectionChanged(new Modification(entity, ModifyType.Update, null, null));
    };
    /**
     * 批量追加实体
     * @param entities 要加载的实体数组
     */
    EntityCollection.prototype.addEntities = function (entities) {
        var _this = this;
        if (!entities) {
            return;
        }
        var entitiesToAdd = [];
        entities.forEach(function (entity) {
            _this.verifyEntityToAdd(entity);
            entitiesToAdd.push(entity);
        });
        entitiesToAdd.forEach(function (entity) {
            _this.innerEntitySet.add(entity);
            _this.innerEntityMap.set(entity[_this.primaryKey], entity);
            _this.listenEntityChangeEvent(entity);
        });
        this.notifyCollectionChanged(new Modification(entitiesToAdd, ModifyType.Add));
    };
    /**
     * 添加实体（不切换当前行）
     * @param entities 实体
     */
    EntityCollection.prototype.addData = function (entities) {
        var _this = this;
        if (!entities) {
            return;
        }
        var entitiesToAdd = [];
        entities.forEach(function (entity) {
            _this.verifyEntityToAdd(entity);
            entitiesToAdd.push(entity);
        });
        entitiesToAdd.forEach(function (entity) {
            _this.innerEntitySet.add(entity);
            _this.innerEntityMap.set(entity[_this.primaryKey], entity);
            _this.listenEntityChangeEvent(entity);
        });
        this.notifyCollectionChanged(new Modification(entitiesToAdd, ModifyType.AddData));
    };
    /**
     * 根据主键值获取实体
     */
    EntityCollection.prototype.getEntityById = function (identity) {
        if (this.innerEntityMap.has(identity) === false) {
            return null;
        }
        var entity = this.innerEntityMap.get(identity);
        return entity;
    };
    /**
     * 根据路径获取实体
     */
    EntityCollection.prototype.getEntityByPath = function (pathArray) {
        var rootEntityId = pathArray[0].split(':')[1];
        var parentNode = this.getEntityById(rootEntityId);
        for (var i = 1; i < pathArray.length && parentNode; i = i + 1) {
            var currentPath = pathArray[i];
            if (parentNode instanceof Entity) {
                // @todo：强识了别冒号
                if (currentPath.indexOf(':') === -1) {
                    parentNode = parentNode[pathArray[i]];
                }
            }
            else {
                parentNode = parentNode.get(pathArray[i].split(':')[1]);
            }
        }
        return parentNode;
    };
    /**
     * id:1/a/id:2/c
     * @param pathArray 路径数组
     */
    EntityCollection.prototype.getEntitiesByPath = function (pathArray) {
        var rootEntityId = pathArray[0].split(':')[1];
        var entity = this.getEntityById(rootEntityId);
        for (var i = 1; i < pathArray.length && entity; i += 2) {
            var path = pathArray[i];
            entity = entity[path];
            if (!(entity instanceof EntityList)) {
                throw new Error('路径格式错误');
            }
            if ((i + 1) < pathArray.length) {
                var id = pathArray[i + 1].split(':')[1];
                entity = entity.get(id);
            }
        }
        return entity;
    };
    /**
     * 返回符合指定条件的实体集合
     * @param predicate 条件谓词
     */
    EntityCollection.prototype.getEntities = function (predicate) {
        var entities = Array.from(this.innerEntitySet);
        var matchedEntities = entities.filter(predicate);
        return matchedEntities;
    };
    /**
     * 获取全部实体
     */
    EntityCollection.prototype.getAllEntities = function () {
        return Array.from(this.innerEntitySet);
    };
    /**
     * 根据主键值删除对应实体
     * @param identity 主键值
     */
    EntityCollection.prototype.removeEntityById = function (identity) {
        this.verifyEntityToRemove(identity);
        var entityToRemove = this.innerEntityMap.get(identity);
        this.innerEntityMap.delete(identity);
        this.innerEntitySet.delete(entityToRemove);
        this.notifyCollectionChanged(new Modification([entityToRemove], ModifyType.Remove));
        return entityToRemove;
    };
    EntityCollection.prototype.removeEntitiesByIds = function (id) {
    };
    /**
     * 删除符合条件的实体集合
     */
    EntityCollection.prototype.removeEntities = function (predicate) {
        var _this = this;
        var entitiesToRemove = Array.from(this.innerEntitySet).filter(predicate);
        entitiesToRemove.forEach(function (entityToRemove) {
            _this.innerEntityMap.delete(entityToRemove[_this.primaryKey]);
            _this.innerEntitySet.delete(entityToRemove);
        });
        this.notifyCollectionChanged(new Modification(entitiesToRemove, ModifyType.Remove));
        return entitiesToRemove;
    };
    /**
     * 移除数据（不切换当前行）
     * @param predicate 过滤函数
     */
    EntityCollection.prototype.removeData = function (predicate) {
        var _this = this;
        var entitiesToRemove = Array.from(this.innerEntitySet).filter(predicate);
        entitiesToRemove.forEach(function (entityToRemove) {
            _this.innerEntityMap.delete(entityToRemove[_this.primaryKey]);
            _this.innerEntitySet.delete(entityToRemove);
        });
        this.notifyCollectionChanged(new Modification(entitiesToRemove, ModifyType.RemoveData));
        return entitiesToRemove;
    };
    /**
     * 重置子表数据
     * @param paths 路径
     * 路径格式 ['id:provinceId','id:cityMDMs','zoneMDMs']
     * @description path参数格式
     * ```json
     * [
     * "id:b5ed23ca-88d9-4377-98ec-92f35c1325f1",
     * "cityMDMs",
     * "id:373706af-622f-4aea-a006-dddbffd7bda3",
     * "zoneMDMs"
     * ]
     * ```
     * @param entities 实体数组
     */
    EntityCollection.prototype.resetEntities = function (paths, entities) {
        var e_1, _a;
        if (paths[0].indexOf(':') === -1) {
            throw new Error('路径格式错误');
        }
        // paths里面第一个一定是id
        var entityInfo = paths[0].split(':');
        var _b = __read(entityInfo, 2), entityPrimaryKey = _b[0], entityId = _b[1];
        var entity = null;
        try {
            for (var _c = __values(this.innerEntitySet), _d = _c.next(); !_d.done; _d = _c.next()) {
                var element = _d.value;
                if (element[entityPrimaryKey] === entityId) {
                    entity = element;
                    break;
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_d && !_d.done && (_a = _c.return)) _a.call(_c);
            }
            finally { if (e_1) throw e_1.error; }
        }
        // for (let index = 0; index < this.innerEntitySet; index++) {
        //   const element: T = this.innerEntitySet[index];
        //   if (element[entityPrimaryKey] === entityId) {
        //     entity = element;
        //     break;
        //   }
        // }
        if (!entity) {
            throw new Error("\u627E\u4E0D\u5230" + entityPrimaryKey + "\u4E3A" + entityId + "\u7684\u5B9E\u4F53");
        }
        var data = entity;
        paths.slice(1).forEach(function (path) {
            data = data[path];
        });
        var entityList = data;
        entityList.clear();
        entityList.loadEntities(entities);
    };
    /**
     * 验证实体是否能够添加
     */
    EntityCollection.prototype.verifyEntityToAdd = function (entity) {
        if (this.has(entity[this.primaryKey])) {
            this.innerEntitySet.delete(this.innerEntityMap.get(entity[this.primaryKey]));
            this.innerEntityMap.delete(entity[this.primaryKey]);
            // throw new Error(`The repository already had an item with the save identity of '${entity[this.primaryKey]}'`);
        }
        return true;
    };
    /**
     * 验证实体是否能移除
     */
    EntityCollection.prototype.verifyEntityToRemove = function (identity) {
        if (!this.has(identity)) {
            throw new Error("The entity with identity of '" + identity + " dose not exsit.'");
        }
        return true;
    };
    /**
     * 实体集合变更流
     */
    EntityCollection.prototype.notifyCollectionChanged = function (modification) {
        this.collectionChanged.next(modification);
    };
    Object.defineProperty(EntityCollection.prototype, "pageSize", {
        /**
         * 获取分页大小
         * @description 如果用户未指定分页大小则默认为0，即获取所有数据
         */
        get: function () {
            if (!!this.paginationInfo) {
                return this.paginationInfo.pageSize || 0;
            }
            return 0;
        },
        //#region 分页
        /**
         * 设置分页大小
         */
        set: function (pageSize) {
            if (typeof (pageSize) !== 'number' || pageSize < 0) {
                throw new Error('Invalid parameter:pageSize');
            }
            var original = this.paginationInfo;
            // const entityPaginationInfo = Object.assign({}, original[this.entityTypeName], { pageSize });
            // this.paginationInfo = Object.assign({}, original, { [this.entityTypeName]: entityPaginationInfo });
            // this.notifyCollectionChanged(new Modification(this.paginationInfo[this.entityTypeName], ModifyType.PaginationInfoChange));
            this.paginationInfo = Object.assign({}, original, { pageSize: pageSize });
            this.notifyCollectionChanged(new Modification(this.paginationInfo, ModifyType.PaginationInfoChange));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityCollection.prototype, "totalCount", {
        /**
         * 获取数据总条数
         */
        get: function () {
            if (!!this.paginationInfo) {
                return this.paginationInfo.total || 0;
            }
            return 0;
        },
        /**
         * 设置数据总条数
         */
        set: function (total) {
            if (typeof (total) !== 'number' || total < 0) {
                throw new Error('Invalid parameter:total');
            }
            var original = this.paginationInfo;
            // const entityPaginationInfo = Object.assign({}, original[this.entityTypeName], { total });
            // this.paginationInfo = Object.assign({}, original, { [this.entityTypeName]: entityPaginationInfo });
            this.paginationInfo = Object.assign({}, original, { total: total });
            this.notifyCollectionChanged(new Modification(this.paginationInfo, ModifyType.PaginationInfoChange));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityCollection.prototype, "pageIndex", {
        /**
         * 获取当前页码
         */
        get: function () {
            if (!!this.paginationInfo) {
                return this.paginationInfo.pageIndex || 1;
            }
            return 1;
        },
        /**
         * 设置当前页码
         */
        set: function (pageIndex) {
            if (typeof (pageIndex) !== 'number' || pageIndex < 0) {
                throw new Error('Invalid parameter:pageIndex');
            }
            var original = this.paginationInfo;
            // const entityPaginationInfo = Object.assign({}, original[this.entityTypeName], { pageIndex });
            // this.paginationInfo = Object.assign({}, original, { [this.entityTypeName]: entityPaginationInfo });
            this.paginationInfo = Object.assign({}, original, { pageIndex: pageIndex });
            this.notifyCollectionChanged(new Modification(this.paginationInfo, ModifyType.PaginationInfoChange));
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 更新分页信息
     * @param path 绑定路径
     * @param pageInfo 分页信息
     */
    EntityCollection.prototype.updatePaginationInfoByPath = function (path, pageInfo) {
        var original = this.paginationInfo;
        var pageIndex = pageInfo.pageIndex, pageSize = pageInfo.pageSize, total = pageInfo.totalCount;
        var paginationInfo = Object.assign({}, original, { pageIndex: pageIndex, pageSize: pageSize, total: total });
        this.setPaginationConfigByPath(path, paginationInfo);
    };
    /**
     * 根据路径获取分页大小
     * @param path 路径
     */
    EntityCollection.prototype.getPaginationConfigByPath = function (path, defaultValue) {
        if (!path || path === '/') {
            return this.paginationInfo;
        }
        if (typeof path !== 'string') {
            throw new Error('路径必须为字符串！');
        }
        path = path.substring(1);
        var paths = path.split('/').filter(function (item) { return !!item && item.trim().length > 0; }).map(function (item) { return item.trim(); });
        var config = this.paginationInfo;
        paths.forEach(function (item) {
            if (config && config.hasOwnProperty(item)) {
                config = config[item];
            }
            else {
                config = null;
            }
        });
        return !!config ? config : typeof defaultValue !== 'undefined' ? defaultValue : undefined;
    };
    /**
     * 设置分页信息
     * @param path 路径
     * @param value 值
     */
    EntityCollection.prototype.setPaginationConfigByPath = function (path, value) {
        var original = JSON.stringify(this.paginationInfo);
        if (!path || path === '/') {
            this.paginationInfo = value;
        }
        else {
            if (!Array.isArray(path)) {
                path = path.toString().match(/[^/[\]]+/g) || [];
            }
            path.slice(0, -1).reduce(function (prev, current, index) {
                return Object(prev[current]) === prev[current]
                    ? prev[current]
                    : prev[current] = Math.abs(path[index + 1]) >> 0 === +path[index + 1]
                        ? []
                        : {};
            }, this.paginationInfo)[path[path.length - 1]] = value;
        }
        if (JSON.stringify(this.paginationInfo) !== original) {
            this.notifyCollectionChanged(new Modification(this.paginationInfo, ModifyType.PaginationInfoChange));
        }
        return this.paginationInfo;
    };
    //#endregion
    /**
     * 监听实体变更
     */
    EntityCollection.prototype.listenEntityChangeEvent = function (entity) {
        var _this = this;
        if (entity) {
            entity.onValueChanged.subscribe(function (change) { return _this.changes.next(change); });
        }
    };
    return EntityCollection;
}());

/*
 * @Author: Witt
 * @Date: 2019-03-07 17:24:38
 * @Last Modified by:   Witt
 * @Last Modified time: 2019-03-11 19:50:38
 */
/**
 * 实体管理类
 */
var EntityManager = /** @class */ (function () {
    /**
     * 构造函数
     */
    function EntityManager(entityCollection) {
        this.entityCollection = entityCollection;
        this.entityType = entityCollection.entityType;
    }
    // #region 创建实体相关方法
    /**
     * 创建实体
     */
    EntityManager.prototype.createEntity = function (entityData) {
        var entity = createEntity(this.entityType, entityData);
        return entity;
    };
    /**
     * 批量创建实体
     */
    EntityManager.prototype.createEntities = function (entityListData, entityType) {
        var entities = createEntities(this.entityType, entityListData);
        return entities;
    };
    /**
     * 批量创建下级实体
     * @param fPath fpath
     * @param entityListData 实体数据
     */
    EntityManager.prototype.createEntitiesByPath = function (fPath, entityListData) {
        var subPaths = fPath.split('/');
        if (subPaths.length < 3) {
            throw Error("\u6839\u636Epath\u5220\u9664\u5B9E\u4F53\u6570\u636E\u51FA\u9519\u4E86\u3002\u4F20\u5165\u7684path[" + fPath + "]\u683C\u5F0F\u4E0D\u5BF9");
        }
        if (entityListData.length < 1) {
            return [];
        }
        var childEntityList;
        var propInfo;
        var propName;
        for (var i = 2; i < subPaths.length; i = i + 2) {
            var fid = subPaths[i - 1];
            propName = subPaths[i];
            var parentEntity = childEntityList ? childEntityList.get(fid) : this.entityCollection.getEntityById(fid);
            childEntityList = parentEntity[propName];
            var entityType = propInfo ? propInfo.propEntityType : this.entityType;
            propInfo = EntityUtil.getPropInfo(entityType, propName);
            if (!childEntityList) {
                throw Error("fpath\u53C2\u6570\u9519\u8BEF\uFF0C\u65E0\u6CD5\u627E\u5230" + propName + "\u5BF9\u5E94\u7684\u5B50\u8868\u3002fpath\u4E3A\uFF1A" + fPath);
            }
        }
        var entities = entityListData.map(function (entityData) {
            return createEntity(propInfo.propEntityType, entityData);
        });
        return entities;
    };
    // #endregion
    // #region 获取实体、实体数组相关方法
    /**
     * 获取path对应的实体
     */
    EntityManager.prototype.getEntityByPath = function (path) {
        var entity = this.getEntityNodeByPath(path);
        return entity;
    };
    /**
     * 获取path对应的实体
     */
    EntityManager.prototype.getEntitiesByPath = function (path) {
        var entityCollectionOrList = this.getEntityNodeByPath(path);
        var entities;
        if (entityCollectionOrList instanceof EntityCollection === true) {
            entities = entityCollectionOrList.toArray();
        }
        else {
            entities = entityCollectionOrList.toArray();
        }
        return entities;
    };
    /**
     * 获取实体节点
     * @param path 节点路径
     */
    EntityManager.prototype.getEntityNodeByPath = function (path) {
        var dataPath = DataPathCreator.createByLongPathFromRoot(path, this);
        var entityNode = this.entityCollection;
        var pathNode = dataPath.head.next;
        while (pathNode) {
            if (pathNode.type === DataPathNodeType.DataId) {
                if (entityNode instanceof EntityCollection === true) {
                    entityNode = entityNode.getEntityById(pathNode.value);
                }
                else {
                    entityNode = entityNode.get(pathNode.value);
                }
            }
            else {
                entityNode = entityNode[pathNode.value];
            }
            if (!entityNode) {
                throw new Error("\u627E\u4E0D\u5230" + pathNode.value + "\u5BF9\u5E94\u7684\u6570\u636E\u8282\u70B9");
            }
            pathNode = pathNode.next;
        }
        return entityNode;
    };
    // #endregion
    // #region 获取、设置属性值
    /**
     * 获取path对应的实体属性值
     */
    EntityManager.prototype.getPropValueByPath = function (path) {
        var propName = path.pop();
        var entity = this.getEntityByPath(path);
        return entity[propName];
    };
    /**
     * 设置path对应实体的属性值
     */
    EntityManager.prototype.setPropValueByPath = function (path, propValue) {
        var propName = path.pop();
        var entity = this.getEntityByPath(path);
        entity[propName] = propValue;
    };
    // #endregion
    // #region 插入实体
    /**
     * 在path对应实体前插入实体
     */
    EntityManager.prototype.insertEntityBeforeByPath = function (fpath) {
        throw new Error('Not Implemented');
    };
    /**
     * 在path对应实体前批量插入实体
     */
    EntityManager.prototype.insertEntitiesBeforeByPath = function () {
        throw new Error('Not Implemented');
    };
    /**
     * 在path对应实体前插入实体
     */
    EntityManager.prototype.insertEntityAfterByPath = function () {
        throw new Error('Not Implemented');
    };
    /**
     * 在path对应实体前批量插入实体
     */
    EntityManager.prototype.insertEntitiesAfterByPath = function () {
        throw new Error('Not Implemented');
    };
    // #endregion
    // #region 追加实体
    /**
     * 在path对应的实体集合中追加1个实体
     */
    // public appendEntityByPath(fpath: string[], entity: Entity): void {
    //   const entityCollectionOrList = this.getEntityNodeByPath(fpath);
    //   if (entityCollectionOrList instanceof EntityCollection === true) {
    //     const entityCollection = entityCollectionOrList as EntityCollection<Entity>;
    //     entityCollection.addEntity(entity);
    //   } else {
    //     const entityList = (entityCollectionOrList as EntityList<Entity>);
    //     entityList.appendEntity(entity);
    //   }
    // }
    /**
     * 根据path获取实体集合
     * @param fpath 路径
     * @param entityData 实体数据
     * @param initialData[可选] 默认值
     */
    EntityManager.prototype.appendEntityByPath = function (fpath, entityData, initialData, isCloned) {
        if (isCloned === void 0) { isCloned = false; }
        var subPaths = fpath.split('/');
        if (subPaths.length < 3) {
            throw Error("\u6839\u636Epath\u5220\u9664\u5B9E\u4F53\u6570\u636E\u51FA\u9519\u4E86\u3002\u4F20\u5165\u7684path[" + fpath + "]\u683C\u5F0F\u4E0D\u5BF9");
        }
        var childEntityList;
        var propInfo;
        var propName;
        for (var i = 2; i < subPaths.length; i = i + 2) {
            var fid = subPaths[i - 1];
            propName = subPaths[i];
            // todo: EntityCollection重构之后这里无需差异处理
            var parentEntity = childEntityList ? childEntityList.get(fid) : this.entityCollection.getEntityById(fid);
            childEntityList = parentEntity[propName];
            var entityType = propInfo ? propInfo.propEntityType : this.entityType;
            propInfo = EntityUtil.getPropInfo(entityType, propName);
            if (!childEntityList) {
                throw Error("fpath\u53C2\u6570\u9519\u8BEF\uFF0C\u65E0\u6CD5\u627E\u5230" + propName + "\u5BF9\u5E94\u7684\u5B50\u8868\u3002fpath\u4E3A\uFF1A" + fpath);
            }
        }
        // const propInfo = EntityUtil.getPropInfo(this.entityType, propName);
        var childEntity = createEntity(propInfo.propEntityType, entityData);
        // 在实体的实例上增加默认值属性，以便在createBindingObject时存放默认值
        if (initialData) {
            EntityUtil.appendInitialData(childEntity, initialData);
        }
        childEntityList.appendNew(childEntity, isCloned);
        return childEntity;
    };
    /**
     * 在指定位置插入实体
     * @param fpath 父路径
     * @param entityData 实体数据
     * @param initialData 初始数据
     * @param position 插入位置
     */
    EntityManager.prototype.insertEntityByPath = function (fpath, entityData, initialData, position) {
        var subPaths = fpath.split('/');
        if (subPaths.length < 3) {
            throw Error("\u6839\u636Epath\u5220\u9664\u5B9E\u4F53\u6570\u636E\u51FA\u9519\u4E86\u3002\u4F20\u5165\u7684path[" + fpath + "]\u683C\u5F0F\u4E0D\u5BF9");
        }
        var childEntityList;
        var propInfo;
        var propName;
        for (var i = 2; i < subPaths.length; i = i + 2) {
            var fid = subPaths[i - 1];
            propName = subPaths[i];
            // todo: EntityCollection重构之后这里无需差异处理
            var parentEntity = childEntityList ? childEntityList.get(fid) : this.entityCollection.getEntityById(fid);
            childEntityList = parentEntity[propName];
            var entityType = propInfo ? propInfo.propEntityType : this.entityType;
            propInfo = EntityUtil.getPropInfo(entityType, propName);
            if (!childEntityList) {
                throw Error("fpath\u53C2\u6570\u9519\u8BEF\uFF0C\u65E0\u6CD5\u627E\u5230" + propName + "\u5BF9\u5E94\u7684\u5B50\u8868\u3002fpath\u4E3A\uFF1A" + fpath);
            }
        }
        // const propInfo = EntityUtil.getPropInfo(this.entityType, propName);
        var childEntity = createEntity(propInfo.propEntityType, entityData);
        // 在实体的实例上增加默认值属性，以便在createBindingObject时存放默认值
        if (initialData) {
            EntityUtil.appendInitialData(childEntity, initialData);
        }
        childEntityList.insert(childEntity, position);
        return childEntity;
    };
    /**
     * 在path对应的实体集合中追加多个实体
     */
    EntityManager.prototype.appendEntitiesByPath = function (fpath, entities) {
        var entityCollectionOrList = this.getEntityNodeByPath(fpath);
        if (entityCollectionOrList instanceof EntityCollection === true) {
            var entityCollection = entityCollectionOrList;
            entityCollection.addEntities(entities);
        }
        else {
            var entityList = entityCollectionOrList;
            entityList.appendEntities(entities);
        }
    };
    // #endregion
    // #region 删除实体
    /**
     * 从fapth对应的实体集合中删除id对应的实体
     */
    // public removeEntityByPath(fpath: string[], id: string): void {
    //   const entityCollectionOrList = this.getEntityNodeByPath(fpath);
    //   if (entityCollectionOrList instanceof EntityCollection === true) {
    //     const entityCollection = entityCollectionOrList as EntityCollection<Entity>;
    //     entityCollection.removeEntityById(id);
    //   } else {
    //     const entityList = (entityCollectionOrList as EntityList<Entity>);
    //     entityList.remove(id);
    //   }
    // }
    /**
     * 根据path获取实体集合
     * @param fpath path
     */
    EntityManager.prototype.removeEntityByPath = function (fpath, id) {
        var subPaths = fpath.split('/');
        if (subPaths.length < 3) {
            throw Error("\u6839\u636Epath\u5220\u9664\u5B9E\u4F53\u6570\u636E\u51FA\u9519\u4E86\u3002\u4F20\u5165\u7684path[" + fpath + "]\u683C\u5F0F\u4E0D\u5BF9");
        }
        var childEntityList;
        for (var i = 2; i < subPaths.length; i = i + 2) {
            var fid = subPaths[i - 1];
            var propName = subPaths[i];
            var parentEntity = childEntityList ? childEntityList.get(fid) : this.entityCollection.getEntityById(fid);
            childEntityList = parentEntity[propName];
            if (!childEntityList) {
                throw Error("fpath\u53C2\u6570\u9519\u8BEF\uFF0C\u65E0\u6CD5\u627E\u5230" + propName + "\u5BF9\u5E94\u7684\u5B50\u8868\u3002fpath\u4E3A\uFF1A" + fpath);
            }
        }
        childEntityList.remove(id);
    };
    /**
     * 从fapth对应的实体集合中删除ids对应的实体
     */
    EntityManager.prototype.removeEntitiesByPath = function (fpath, ids) {
        // const entityCollectionOrList = this.getEntityNodeByPath(fpath);
        // if (entityCollectionOrList instanceof EntityCollection === true) {
        //   const entityCollection = entityCollectionOrList as EntityCollection<Entity>;
        //   entityCollection.removeEntitiesByIds(ids);
        // } else {
        //   const entityList = (entityCollectionOrList as EntityList<Entity>);
        //   entityList.remove(ids);
        // }
        throw new Error('Not Implemented');
    };
    // #endregion
    // #region 清空变更集相关方法
    /**
     * 清空所有实体的变更集
     */
    EntityManager.prototype.clearAllEntityChanges = function () {
        var entities = this.entityCollection.toArray();
        entities.forEach(function (entity) {
            entity.changes.splice(0, entity.changes.length);
        });
    };
    EntityManager.prototype.resetAllEntityChangeMark = function () {
        var entities = this.entityCollection.toArray();
        entities.forEach(function (entity) {
            entity.hasChange = false;
        });
    };
    /**
     * 清空id指定的实体变更集
     */
    EntityManager.prototype.clearEntityChangesById = function (id) {
        var entity = this.entityCollection.getEntityById(id);
        if (!entity) {
            return;
        }
        entity.changes.splice(0, entity.changes.length);
    };
    /**
     * 清空ids数组中指定的实体的变更集
     */
    EntityManager.prototype.clearEntityChangesByIds = function (ids) {
        var _this = this;
        if (!ids || ids.length < 0) {
            return;
        }
        ids.forEach(function (id) {
            _this.clearEntityChangesById(id);
        });
    };
    // #endregion
    // #region 变更集检查相关方法
    /**
     * 检查所有的实体，是否有未提交的变更
     */
    EntityManager.prototype.checkAllEntityChanges = function () {
        var entities = this.entityCollection.toArray();
        var hasChanges = entities.some(function (entity) {
            if (entity.changes.length > 0) {
                return true;
            }
            else {
                return false;
            }
        });
        return hasChanges;
    };
    /**
     * 检查id对应的实体，是否有未提交的变更
     */
    EntityManager.prototype.checkEntityChangesById = function (id) {
        var entity = this.entityCollection.getEntityById(id);
        if (!entity) {
            return false;
        }
        return entity.changes.length > 0;
    };
    // #endregion
    // #region 不规范方法，待废弃
    /**
     * 待废弃
     * @deprecated
     */
    EntityManager.prototype.clearEntityChangesByArray = function (idArray) {
        this.clearEntityChangesByIds(idArray);
    };
    return EntityManager;
}());

// tslint:disable: no-bitwise
var PaginationManager = /** @class */ (function () {
    function PaginationManager(entityType, paginationConfig) {
        this.entityType = entityType;
        this.paginationConfig = paginationConfig;
        if (this.paginationConfig === null || this.paginationConfig === undefined) {
            this.paginationConfig = this.getNgListProperties();
        }
        // 兼容老表单，将之前的主表分页信息展开到分页配置根中
        this.expandMainEntityConfig();
        this.deleteMainEntityConfig();
    }
    /**
     * 主表分页信息展开到分页配置根中
     */
    PaginationManager.prototype.expandMainEntityConfig = function () {
        var entityName = this.entityType.name;
        if (this.paginationConfig.hasOwnProperty(entityName)) {
            var entityConfig = this.paginationConfig[entityName];
            this.paginationConfig = Object.assign(this.paginationConfig, entityConfig);
        }
    };
    /**
     * 删除主表实体配置信息
     */
    PaginationManager.prototype.deleteMainEntityConfig = function () {
        delete this.paginationConfig[this.entityType.name];
    };
    Object.defineProperty(PaginationManager.prototype, "pagination", {
        /**
         * 获取分页信息
         */
        get: function () {
            return this.paginationConfig;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 获取分页信息
     * @param path 路径
     * @param defaultValue 默认值
     */
    PaginationManager.prototype.getPaginationConfigByPath = function (path, defaultValue) {
        if (!path || path === '/') {
            return this.paginationConfig;
        }
        if (typeof path !== 'string') {
            throw new Error('路径必须为字符串！');
        }
        path = path.substring(1);
        var paths = path.split('/').filter(function (item) { return !!item && item.trim().length > 0; });
        var config = this.paginationConfig;
        paths.forEach(function (item) {
            if (config && config.hasOwnProperty(item)) {
                config = config[item];
            }
            else {
                config = null;
            }
        });
        return !!config ? config : typeof defaultValue !== 'undefined' ? defaultValue : undefined;
    };
    /**
     * 设置分页信息
     * @param path 路径
     * @param value 值
     */
    PaginationManager.prototype.setPaginationConfigByPath = function (path, value) {
        if (!Array.isArray(path)) {
            path = path.toString().match(/[^/[\]]+/g) || [];
        }
        path.slice(0, -1).reduce(function (prev, current, index) {
            return Object(prev[current]) === prev[current]
                ? prev[current]
                : prev[current] = Math.abs(path[index + 1]) >> 0 === +path[index + 1]
                    ? []
                    : {};
        }, this.paginationConfig)[path[path.length - 1]] = value;
        return this.paginationConfig;
    };
    /**
     * 递归获取当前实体的所有NgList属性
     * @param defaultPageSize defaultPageSize
     */
    PaginationManager.prototype.getNgListProperties = function (defaultPageSize) {
        if (defaultPageSize === void 0) { defaultPageSize = 0; }
        var getChilds = function (objectType) {
            var listProperties = FieldMetadataUtil.getNgList(objectType);
            var result = {};
            if (Object.keys(listProperties).length < 1) {
                return result;
            }
            Object.keys(listProperties).forEach(function (prop) {
                var itemTypeName = listProperties[prop].dataField;
                // 去掉尾部的s
                if (itemTypeName.endsWith('s')) {
                    itemTypeName = itemTypeName.substring(0, itemTypeName.length - 1);
                }
                result[itemTypeName] = {
                    pageSize: defaultPageSize
                };
                var child = getChilds(listProperties[prop].type);
                if (child !== null && Object.keys(child).length > 0) {
                    result = Object.assign({}, result, child);
                }
            });
            return result;
        };
        var childs = getChilds(this.entityType);
        var root = Object.assign({}, { pageSize: defaultPageSize }, childs);
        return root;
    };
    return PaginationManager;
}());

var DataChangeHistory = /** @class */ (function () {
    function DataChangeHistory() {
        this.history = [];
        this.cacheData = [];
    }
    DataChangeHistory.prototype.addChange = function (dataChange) {
        var changeType = DataChangeType[dataChange.changeType];
        this["on" + changeType + "Data"](dataChange);
    };
    DataChangeHistory.prototype.addChanges = function (dataChange) {
        var _this = this;
        dataChange.forEach(function (change) { return _this.addChange(change); });
    };
    DataChangeHistory.prototype.clear = function () {
        this.history.splice(0, this.history.length);
    };
    DataChangeHistory.prototype.clearByIds = function (ids) {
        this.history = this.history.filter(function (item) {
            var e_1, _a;
            if (item.fpath && item.fpath !== '/' && item.fpath.includes('/')) {
                try {
                    for (var ids_1 = __values(ids), ids_1_1 = ids_1.next(); !ids_1_1.done; ids_1_1 = ids_1.next()) {
                        var id = ids_1_1.value;
                        var include = item.fpath.split('/').includes(id);
                        return !include;
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (ids_1_1 && !ids_1_1.done && (_a = ids_1.return)) _a.call(ids_1);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
            }
            else {
                return !ids.includes(item.dataId);
            }
        });
    };
    DataChangeHistory.prototype.isChanged = function () {
        return this.history.length > 0;
    };
    DataChangeHistory.prototype.clearCache = function () {
        this.cacheData.splice(0, this.cacheData.length);
    };
    DataChangeHistory.prototype.getCacheData = function () {
        return this.cacheData;
    };
    DataChangeHistory.prototype.onAddData = function (dataChange) {
        this.history.push(dataChange);
    };
    DataChangeHistory.prototype.onEditData = function (dataChange) {
        this.cacheData.push(dataChange);
    };
    DataChangeHistory.prototype.onAppendData = function (dataChange) {
        this.history.push(dataChange);
        this.cacheData.push(dataChange);
    };
    DataChangeHistory.prototype.onDeleteData = function (dataChange) {
        var index = this.history.findIndex(function (item) { return item.dataId === dataChange.dataId && item.changeType === DataChangeType.Add; });
        if (index >= 0) {
            this.history.splice(index, 1);
        }
        else {
            this.history.push(dataChange);
        }
    };
    return DataChangeHistory;
}());

/*
 * @Author: Witt
 * @Date: 2018-10-12 15:37:11
 * @Last Modified by: aalizzwell
 * @Last Modified time: 2019-09-03 19:10:44
 * @todo 待优化问题
 * 1、apiUrl是否应该在基类中，子类中的api如何传递给基类；
 */
var Repository = /** @class */ (function () {
    /**
     * 构造函数
     */
    function Repository() {
        /**
         * 用户分页配置信息
         */
        this.paginationInfo = null;
    }
    Repository.prototype.init = function () {
        this.entityTypeInfo = new DataTypeInfo(this.entityType);
        this.entityCollection = new EntityCollection(this.entityType);
        this.entityCollection.entityTypeInfo = this.entityTypeInfo;
        this.dataChangeHistory = new DataChangeHistory();
    };
    Object.defineProperty(Repository.prototype, "changes", {
        get: function () {
            return this.entityCollection.changes;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Repository.prototype, "primaryKey", {
        /**
         * 实体主键
         */
        get: function () {
            return this.entityCollection.primaryKey;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Repository.prototype, "entityCollectionChange", {
        /**
         * 实体变更集合
         */
        get: function () {
            return this.entityCollection.collectionChanged;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 重置状态
     */
    Repository.prototype.reset = function () {
        this.entityCollection.clear();
    };
    /**
     * 创建实体
     */
    Repository.prototype.buildEntity = function (data) {
        var entity = createEntity(this.entityType, data);
        return entity;
    };
    /**
     * 批量创建实体
     */
    Repository.prototype.buildEntities = function (listData) {
        var entities = createEntities(this.entityType, listData);
        return entities;
    };
    /**
     * 初始化分页配置
     * @param config 用户分页配置
     */
    Repository.prototype.setPaginationConfig = function (config) {
        this.paginationManager = new PaginationManager(this.entityType, config);
        var _a = (this.paginationManager.getPaginationConfigByPath('/') || {}).pageSize, pageSize = _a === void 0 ? 0 : _a;
        // tslint:disable-next-line: max-line-length
        this.entityCollection.paginationInfo = Object.assign({ pageSize: pageSize }, this.entityCollection.paginationInfo, this.paginationManager.pagination);
        // 无需再单独设置一次pageSize，减少一次变更
        // this.entityCollection.pageSize = pageSize;
    };
    /**
     * 设置分页
     */
    Repository.prototype.setPaginationInfo = function (paginationInfo) {
        this.paginationInfo = __assign({}, this.paginationInfo, paginationInfo);
    };
    return Repository;
}());

/**
 * 空Repository实现
 */
var DefaultRepository = /** @class */ (function (_super) {
    __extends(DefaultRepository, _super);
    function DefaultRepository() {
        return _super.call(this) || this;
    }
    DefaultRepository.prototype.init = function () {
        _super.prototype.init.call(this);
        this.entityManager = new EntityManager(this.entityCollection);
    };
    return DefaultRepository;
}(Repository));

/**
 * 命令处理装饰器名称
 */
var COMMAND_HANDLER_META = 'CommandHandlerMeta';
/**
 * 命令处理装饰器工厂
 */
function CommandHandlerMeta(options) {
    var decoratorFactory = makeDecorator(COMMAND_HANDLER_META, function (handler) { return handler; });
    return decoratorFactory(options);
}
/**
 * 命令处理扩展装饰器名称
 */
var COMMAND_HANDLER_EXTENDER_META = 'CommandHandlerExtenderMeta';
/**
 * 命令处理扩展装饰器工厂
 */
function CommandHandlerExtenderMeta(options) {
    var decoratorFactory = makeDecorator(COMMAND_HANDLER_EXTENDER_META, function (extender) { return extender; });
    return decoratorFactory(options);
}

/**
 * 任务节点
 */
var TaskNode = /** @class */ (function () {
    /**
     * 构造函数
     */
    function TaskNode(name, func) {
        this.name = name;
        this.func = func;
    }
    /**
     * 执行任务函数
     */
    TaskNode.prototype.execute = function (context) {
        var result = this.func(context);
        var result$ = isObservable(result) ? result : of(result);
        return result$;
    };
    return TaskNode;
}());

/**
 * session变量解析
 * @author Witt <jiwt@inspur.com>
 */
var VARIABLE_PARSERS = createInjectionToken('@farris/devkit VARIABLE_PARSERS');

var AppOptions = /** @class */ (function () {
    function AppOptions() {
    }
    return AppOptions;
}());

/*
 * @Author: Witt
 * @Date: 2018-12-29 10:46:01
 * @Last Modified by: Witt
 * @Last Modified time: 2018-12-30 17:56:02
 */
/**
 * BindingData管理类
 */
var BindingDataManager = /** @class */ (function () {
    /**
     * 构造函数
     */
    function BindingDataManager() {
        this.bindingDataMap = new Map();
    }
    /**
     * 获取BindingDataMap
     */
    BindingDataManager.prototype.getBindingDataMap = function () {
        return this.bindingDataMap;
    };
    /**
     * 根据name获取BindingData
     * @return 找不到时返回undefined
     */
    BindingDataManager.prototype.getBindingDataByName = function (name) {
        return this.bindingDataMap.get(name);
    };
    /**
     * 初始化全局的BindingData
     */
    BindingDataManager.prototype.regBindingData = function (name, bindingData) {
        this.bindingDataMap.set(name, bindingData);
    };
    /**
     * 是否Repository已经存在
     */
    BindingDataManager.prototype.ifBindingDataExits = function (name) {
        var bindingData = this.getBindingDataByName(name);
        return bindingData ? true : false;
    };
    return BindingDataManager;
}());

/*
 * @Author: Witt
 * @Date: 2018-12-29 10:46:01
 * @Last Modified by: Witt
 * @Last Modified time: 2018-12-30 18:06:11
 */
/**
 * Repository管理类
 */
var RepositoryManager = /** @class */ (function () {
    /**
     * 构造函数
     */
    function RepositoryManager() {
        this.repositoryMap = new Map();
    }
    /**
     * 注册Repository
     */
    RepositoryManager.prototype.regRepository = function (name, repository) {
        this.repositoryMap.set(name, repository);
    };
    /**
     * 获取RepositoryMap
     * @internal
     */
    RepositoryManager.prototype.getRepositoryMap = function () {
        return this.repositoryMap;
    };
    /**
     * 获取Repository数组
     */
    RepositoryManager.prototype.getRepositories = function () {
        return Array.from(this.repositoryMap.values());
    };
    /**
     * 根据name获取Repository
     */
    RepositoryManager.prototype.getRepositoryByName = function (name) {
        return this.repositoryMap.get(name);
    };
    /**
     * 是否Repository已经存在
     */
    RepositoryManager.prototype.ifRepositoryExits = function (name) {
        var repository = this.getRepositoryByName(name);
        return repository ? true : false;
    };
    return RepositoryManager;
}());

/**
 * ViewModelContext管理类
 */
var ViewModelContextManager = /** @class */ (function () {
    /**
     * 构造函数
     */
    function ViewModelContextManager() {
        this.contextMap = new Map();
        this.contextSet = new Set();
    }
    /**
     * 注册Context
     */
    ViewModelContextManager.prototype.regContext = function (viewModelContext) {
        var id = viewModelContext.id;
        if (this.contextMap.has(id) === true) {
            // throw Error(`id为${id}的ViewModelContext已经存在`);
            // 临时处理，方式报错。
            this.unregContext(viewModelContext);
        }
        this.contextMap.set(id, viewModelContext);
        this.contextSet.add(viewModelContext);
    };
    /**
     * 取消注册
     */
    ViewModelContextManager.prototype.unregContext = function (context) {
        var id = context.id;
        this.contextMap.delete(id);
        this.contextSet.delete(context);
    };
    /**
     * 获取ContextMap
     */
    ViewModelContextManager.prototype.getContextMap = function () {
        return this.contextMap;
    };
    /**
     * 获取全部Context
     */
    ViewModelContextManager.prototype.getContexts = function () {
        return Array.from(this.contextSet);
    };
    /**
     * 根据命名控件获取上下文集合
     */
    ViewModelContextManager.prototype.getContextsByNamespace = function (namespace) {
        return this.getContexts();
    };
    /**
     * 根据id获取Context
     */
    ViewModelContextManager.prototype.getContextById = function (id) {
        var targetContext = this.contextMap.get(id);
        return targetContext;
    };
    /**
     * 获取根Context
     */
    ViewModelContextManager.prototype.getRootContext = function () {
        var contexts = this.getContexts();
        var rootContext = contexts.find(function (context) {
            return context.parent === null;
        });
        return rootContext;
    };
    /**
     * 获取传入视图模型id的root及root的下一代集合数组
     */
    ViewModelContextManager.prototype.getRootContextAndPosterityById = function (viewModelId) {
        var targetContext = this.getContextById(viewModelId);
        var contexts = this.getContexts();
        var contextsGroup = [];
        // 1.找到ROOT
        var RootId = this.getContextsGroupRoot(targetContext);
        // 2.可直接遍历拿到所有直系后代 (目前只有两层结构直接获取下一代)
        contexts.map(function (context) {
            if (context.parent && context.parent.id === RootId) {
                contextsGroup.push(context);
            }
        });
        contextsGroup.push(this.getContextById(RootId));
        return contextsGroup;
    };
    ViewModelContextManager.prototype.getContextsGroupRoot = function (context) {
        if (context.parent) {
            return this.getContextsGroupRoot(context.parent);
        }
        else {
            return context.id;
        }
    };
    return ViewModelContextManager;
}());

var Context = /** @class */ (function () {
    function Context() {
        /**
         * 上下文变量
         */
        this.params = new Map();
    }
    /**
     * 获取变量
     */
    Context.prototype.getParam = function (key) {
        return this.params.get(key);
    };
    /**
     * 设置变量
     */
    Context.prototype.setParam = function (key, value) {
        this.params.set(key, value);
    };
    return Context;
}());

/**
 * 表单模块路径
 */
var VALIDATION_RULE_TOKEN = new InjectionToken('@Farris validation rule');

var AppContext = /** @class */ (function (_super) {
    __extends(AppContext, _super);
    /**
     * 构造函数
     */
    function AppContext(injector, eventBus, repositoryManager, bindingDataManager, viewModelContextManager, validationManager, validationRule) {
        if (validationManager === void 0) { validationManager = {}; }
        var _this = _super.call(this) || this;
        _this.injector = injector;
        _this.eventBus = eventBus;
        _this.repositoryManager = repositoryManager;
        _this.bindingDataManager = bindingDataManager;
        _this.viewModelContextManager = viewModelContextManager;
        _this.validationManager = validationManager;
        _this.validationRule = validationRule;
        _this.validationRule = injector.get(VALIDATION_RULE_TOKEN, []);
        return _this;
    }
    /**
     * 注册FrameContext
     */
    AppContext.prototype.regViewModelContext = function (viewModelContext) {
        var repository = viewModelContext.repository;
        var repositoryName = repository.name;
        // Repository
        if (this.repositoryManager.ifRepositoryExits(repositoryName) === false) {
            this.repositoryManager.regRepository(repositoryName, repository);
        }
        // BindingData
        if (this.bindingDataManager.ifBindingDataExits(repositoryName) === false) {
            var bindingData = BindingDataFactory.createFromRepository(repository, '/');
            this.bindingDataManager.regBindingData(repositoryName, bindingData);
        }
        // 考虑路由再次进入的时候，AppContext没有被注销，但Component被再次构造的场景
        this.viewModelContextManager.regContext(viewModelContext);
    };
    return AppContext;
}(Context));

/**
 * 视图模型上下文
 */
var ViewModelContext = /** @class */ (function () {
    function ViewModelContext() {
    }
    ViewModelContext.prototype.init = function (viewModel) {
        this.innerViewModel = viewModel;
        this.id = this.innerViewModel.id;
        this.appContext = viewModel.injector.get(AppContext);
        this.regToTree();
        this.regToAppContext();
    };
    ViewModelContext.prototype.regToTree = function () {
        var parentInjector = this.innerViewModel.injector.get(Injector, null, InjectFlags.SkipSelf);
        if (parentInjector) {
            this.parent = parentInjector.get(ViewModelContext, null);
            this.root = this.parent ? this.parent.root : this;
        }
        else {
            this.parent = null;
            this.root = this;
        }
    };
    ViewModelContext.prototype.regToAppContext = function () {
        this.appContext.regViewModelContext(this);
    };
    Object.defineProperty(ViewModelContext.prototype, "viewModel", {
        get: function () {
            return this.innerViewModel;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ViewModelContext.prototype, "injector", {
        get: function () {
            return this.innerViewModel.injector;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ViewModelContext.prototype, "repository", {
        get: function () {
            return this.innerViewModel.repository;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ViewModelContext.prototype, "bindingData", {
        get: function () {
            return this.innerViewModel.bindingData;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ViewModelContext.prototype, "uiState", {
        get: function () {
            return this.innerViewModel.uiState;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ViewModelContext.prototype, "stateMachine", {
        get: function () {
            return this.innerViewModel.stateMachine;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ViewModelContext.prototype, "form", {
        get: function () {
            return this.innerViewModel.form;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ViewModelContext.prototype, "commandBus", {
        get: function () {
            return this.innerViewModel.commandBus;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ViewModelContext.prototype, "expressionEngineImpl", {
        get: function () {
            return this.innerViewModel.expressionEngineImpl;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ViewModelContext.prototype, "expressionManager", {
        get: function () {
            return this.innerViewModel.expressionManager;
        },
        enumerable: true,
        configurable: true
    });
    ;
    Object.defineProperty(ViewModelContext.prototype, "expressionResult", {
        get: function () {
            return this.innerViewModel.expressionResult;
        },
        enumerable: true,
        configurable: true
    });
    ;
    Object.defineProperty(ViewModelContext.prototype, "controlsProxy", {
        get: function () {
            return this.innerViewModel.controlsProxy;
        },
        enumerable: true,
        configurable: true
    });
    ;
    ViewModelContext.prototype.getVirtualRootFrameContext = function () {
        var formFrameContext = this;
        // let parent = this.parent;
        // while (parent) {
        //   // 兼容没有重新编译的表单，如果判断parent.namespace存在会导致获取不到root-framecontext
        //   if (parent.namespace === this.namespace) {
        //     formFrameContext = parent;
        //     parent = parent.parent;
        //   } else {
        //     break;
        //   }
        // }
        return formFrameContext;
    };
    /**
     * 注册扩展命令
     */
    ViewModelContext.prototype.registerExtendCommand = function (commandName, commandHandler) {
        this.viewModel.registerExtendCommand(commandName, commandHandler);
    };
    return ViewModelContext;
}());

var ControlInfo = /** @class */ (function () {
    function ControlInfo() {
    }
    return ControlInfo;
}());
/**
 * UIState属性元数据名称
 */
var CONTROLSTATE_PROP_META = 'ControlStatePropMeta';
var ɵ0$2 = function (obj) { return obj; };
/**
 * UIState属性元数据装饰器工厂
 */
var ControlStatePropMeta = makePropDecorator(CONTROLSTATE_PROP_META, ɵ0$2);

/**
 * UIState属性元数据名称
 */
var UISTATE_PROP_META = 'UIStatePropMeta';
var ɵ0$3 = function (obj) { return obj; };
/**
 * UIState属性元数据装饰器工厂
 */
var UIStatePropMeta = makePropDecorator(UISTATE_PROP_META, ɵ0$3);

var UIStateMetadataUtil = /** @class */ (function () {
    function UIStateMetadataUtil() {
    }
    /**
     * 获取NgUIState的属性元数据
     * @param
     * @returns 属性元数据对象
     * @example
     * 返回格式：
     * {
     *    '属性名称': <NgUIStateProperty>{ ...}
     * }
     */
    UIStateMetadataUtil.getUIFields = function (target) {
        return MetadataUtil.getPropsMetadatasByName(target, UISTATE_PROP_META);
    };
    UIStateMetadataUtil.getControlFields = function (target) {
        return MetadataUtil.getPropsMetadatasByName(target, CONTROLSTATE_PROP_META);
    };
    return UIStateMetadataUtil;
}());

/**
 * 命令处理器扩展注入Token
 */
var CONTROL_STATE_INTERCEPTOR_TOKEN = createInjectionToken('@farris/devkit CONTROL_STATE_INTERCEPTOR_TOKEN');
var InitContext = /** @class */ (function () {
    function InitContext() {
    }
    return InitContext;
}());
var InterceptContext = /** @class */ (function () {
    function InterceptContext() {
    }
    return InterceptContext;
}());
var ProcessContext = /** @class */ (function () {
    function ProcessContext() {
    }
    return ProcessContext;
}());

/**
 * 状态拦截器服务
 */
var ControlStateInterceptorService = /** @class */ (function () {
    function ControlStateInterceptorService(injector) {
        this.injector = injector;
        //控件状态拦截器
        this.controlInterceptors = [];
        this.controlInterceptors = this.injector.get(CONTROL_STATE_INTERCEPTOR_TOKEN, null, InjectFlags.Optional);
    }
    ControlStateInterceptorService.prototype.init = function () {
        var e_1, _a;
        if (this.result) {
            return this.result;
        }
        var inits = [];
        var initContext = new InitContext();
        var processContext = this.getProcessContext();
        initContext.processContext = this.processContext = processContext;
        try {
            for (var _b = __values(this.controlInterceptors), _c = _b.next(); !_c.done; _c = _b.next()) {
                var controlInterceptor = _c.value;
                if (controlInterceptor.init && typeof controlInterceptor.init === 'function') {
                    var initFunc = controlInterceptor.init(initContext);
                    var $result = isObservable$1(initFunc) ? initFunc : of(initFunc);
                    inits.push($result);
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_1) throw e_1.error; }
        }
        return this.result = forkJoin(inits).pipe(shareReplay(1));
    };
    ControlStateInterceptorService.prototype.intercept = function (interceptContext) {
        var e_2, _a;
        interceptContext.processContext = this.processContext;
        try {
            for (var _b = __values(this.controlInterceptors), _c = _b.next(); !_c.done; _c = _b.next()) {
                var controlInterceptor = _c.value;
                controlInterceptor.intercept(interceptContext);
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_2) throw e_2.error; }
        }
    };
    ControlStateInterceptorService.prototype.getProcessContext = function () {
        var processContext = new ProcessContext();
        var isInWf = EnvUtil.isInWf();
        processContext.isInWf = isInWf;
        if (isInWf === false) {
            return processContext;
        }
        var iframe = window.parent.document.querySelector('iframe');
        if (!iframe || !iframe.src) {
            return processContext;
        }
        var queryParams = UrlUtil.getParams(iframe.src);
        if (!queryParams) {
            return processContext;
        }
        processContext.uiStateInProcess = queryParams.UIStateInProcess;
        processContext.formConfigId = queryParams.formConfigId;
        return processContext;
    };
    return ControlStateInterceptorService;
}());

var ControlStateUpdater = /** @class */ (function () {
    function ControlStateUpdater(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.controlStateInterceptorService = viewModelContext.injector.get(ControlStateInterceptorService);
    }
    /**
     * 初始化
     * @returns
     */
    ControlStateUpdater.prototype.init = function () {
        return this.controlStateInterceptorService.init();
    };
    /**
     * 更新【描述控件状态】的变量
     * @param changes 监听到的变化
     */
    ControlStateUpdater.prototype.updateControlState = function (changes) {
        var _this = this;
        //1.获取【描述控件状态】的变量，并缓存
        if (!this.controlFields) {
            var uiState = this.viewModelContext.uiState;
            this.controlFields = UIStateMetadataUtil.getControlFields(uiState.constructor);
            this.variableNames = Object.keys(this.controlFields);
        }
        //2.更新前事件
        if (!this.beforeUpdate(changes)) {
            return;
        }
        //3.遍历变量，进行更新
        this.variableNames.forEach(function (variableName) {
            var fieldMetadata = _this.controlFields[variableName];
            //遍历默认值
            Object.keys(fieldMetadata.originalValue).forEach(function (propertyName) {
                //更新
                _this.update(changes, fieldMetadata, variableName, propertyName);
            });
        });
    };
    /**
     * 更新前事件
     * @param changes
     * @returns
     */
    ControlStateUpdater.prototype.beforeUpdate = function (changes) {
        //1.没有【控件状态变量】，无需更新
        if (!this.variableNames) {
            return false;
        }
        var lintenerType = changes.lintenerType, change = changes.change;
        //2.【控件状态变量】变化时，不做处理。否则会造成循环调用
        if (lintenerType === 'uiState' && this.variableNames.includes(change.field)) {
            return false;
        }
        return true;
    };
    /**
     * 更新
     * @param changes 监听到的变化
     * @param fieldMetadata 变量的元数据
     * @param variableName 变量名
     * @param propertyName 控件的属性名
     * @returns
     */
    ControlStateUpdater.prototype.update = function (changes, fieldMetadata, variableName, propertyName) {
        var _a;
        var propertyValue = fieldMetadata.originalValue[propertyName];
        //1.是否需要更新
        if (!this.needUpdate(propertyValue, changes)) {
            return;
        }
        //2.计算原始值
        var value = this.computeOriginalValue(propertyValue);
        //3.拦截器处理
        var interceptContext = new InterceptContext();
        interceptContext.controlState = fieldMetadata;
        interceptContext.value = value;
        interceptContext.type = propertyName;
        interceptContext.viewModelContext = this.viewModelContext;
        if (this.controlStateInterceptorService) {
            this.controlStateInterceptorService.intercept(interceptContext);
        }
        //4.更新状态
        var uiState = this.viewModelContext.uiState;
        if (!uiState[variableName]) {
            uiState[variableName] = {};
        }
        uiState[variableName] = __assign({}, uiState[variableName], (_a = {}, _a[propertyName] = interceptContext.value, _a));
        //5.更新后事件
        this.afterUpdate(propertyName, interceptContext);
    };
    /**
     * 是否需要新
     * @param originalValue
     * @returns
     */
    ControlStateUpdater.prototype.needUpdate = function (originalValue, changes) {
        var type = originalValue.type, value = originalValue.value;
        var lintenerType = changes.lintenerType, change = changes.change;
        //1.第一次更新全部
        if (lintenerType === 'firstUpdate') {
            return true;
        }
        //2.固定值类型：只在第一次更新，后续不需要更新
        if (type === 'constant') {
            return false;
        }
        //3.value为空，也是固定值,也不需要更新
        if (!value) {
            return false;
        }
        //4.表达式类型：监听到表达式变化，直接更新表达式变量
        if (type === 'expression' && lintenerType === 'expression') {
            return true;
        }
        //5.根据监听到变化的类型判断
        switch (lintenerType) {
            case 'bindingData': {
                if (change && change.path && change.path.length > 0) {
                    if (value.includes(change.path[0])) {
                        return true;
                    }
                    else {
                        return false;
                    }
                }
                break;
            }
            case 'uiState': {
                if (change && change.field) {
                    if (value.includes(change.field)) {
                        return true;
                    }
                    else {
                        return false;
                    }
                }
                break;
            }
            case 'stateMachine': {
                if (value.includes('stateMachine')) {
                    return true;
                }
                else {
                    return false;
                }
                break;
            }
            case 'form': {
                if (value.includes('form')) {
                    return true;
                }
                else {
                    return false;
                }
                break;
            }
        }
        return true;
    };
    /**
     * 计算变量的值
     * @param originalValue
     * @returns
     */
    ControlStateUpdater.prototype.computeOriginalValue = function (originalValue) {
        var value = originalValue.value;
        var type = originalValue.type;
        if (value && typeof value === 'string' && type !== 'constant') {
            var context = {
                bindingData: this.viewModelContext.bindingData.list.currentItem.toJSON(),
                entityListData: this.viewModelContext.bindingData.getList().toJSON(),
                currentEntityData: this.viewModelContext.bindingData.getObject().toJSON(),
                uiState: this.viewModelContext.uiState,
                form: this.viewModelContext.viewModel.form,
                stateMachine: this.viewModelContext.stateMachine.renderStates,
            };
            return this.eval(value, context);
        }
        return value;
    };
    /**
     * 计算
     * @param expr 变量
     * @param contexts 上下文
     * @returns
     */
    ControlStateUpdater.prototype.eval = function (expr, contexts) {
        expr = "return " + expr;
        var scopeNames = Object.getOwnPropertyNames(contexts);
        var scopeVariable = "__scope__" + new Date().valueOf();
        return new Function(scopeVariable, "\n          " + scopeNames.map(function (key) { return "var " + key + " = " + scopeVariable + "['" + key + "'];"; }).join('\r\n') + "\n          return function () {\n            try{  \n" + expr + "\n }catch(e){console.error(e);}\n          };")(contexts)();
    };
    /**
     * 更新变量后，需要进行的操作
     * @param propertyName
     * @param interceptContext
     */
    ControlStateUpdater.prototype.afterUpdate = function (propertyName, interceptContext) {
        //1.必填处理
        if (propertyName === 'required') {
            this.updateRequired(interceptContext);
        }
    };
    /**
     * 更新必填状态
     * @param fieldMetadata
     * @param interceptContext
     * @returns
     */
    ControlStateUpdater.prototype.updateRequired = function (interceptContext) {
        var bindingPath = interceptContext.controlState.controlInfo.bindingPath;
        if (!bindingPath) {
            return;
        }
        var form = this.viewModelContext.form;
        var formControl = form.getFormValueByBindPath(bindingPath);
        var form_name = formControl.form_name;
        if (!form_name || Object.keys(form_name).length === 0) {
            return;
        }
        var validators = [{ "type": "required", "constraints": [true], message: '必填' }];
        if (interceptContext.value === true) {
            form.addValidate(formControl.bindingPath, formControl.name);
            form_name.pushValidatorFnforRequired(validators, true);
            form_name.required = true;
        }
        else if (interceptContext.value === false) {
            if (form_name.getValidatorFn() && form_name.getValidatorFn().length >= 1) {
                form_name.required = false;
                //去除必填
                form_name.resetValidatorFnforRequired();
                if (form_name.validationResult && form_name.validationResult.type === 'required') {
                    form_name.validationResult = { passing: true, message: '' };
                }
            }
        }
    };
    return ControlStateUpdater;
}());

var ControlStateListener = /** @class */ (function () {
    function ControlStateListener(viewModelContext) {
        var _this = this;
        //监听订阅集合
        this.subscriptionsMap = new Map();
        this.viewModelContext = viewModelContext;
        this.controlStateUpdater = viewModelContext.injector.get(ControlStateUpdater);
        //更新器初始化完成后，注册监听,主动触发一次更新
        this.controlStateUpdater.init().subscribe(function (res) {
            _this.register();
            var changes = {
                lintenerType: 'firstUpdate',
                change: null
            };
            _this.controlStateUpdater.updateControlState(changes);
        });
    }
    /**
     *注册监听
     */
    ControlStateListener.prototype.register = function () {
        this.registerBindingDataLintener();
        this.registerUIStateLintener();
        this.registerStateMachineLintener();
        this.registerFormLintener();
    };
    /**
     * 监听BindingData变化
     */
    ControlStateListener.prototype.registerBindingDataLintener = function () {
        var _this = this;
        var stateName = 'bindingData';
        if (this.subscriptionsMap.has(stateName) === false) {
            var subscription = this.viewModelContext.bindingData.changes.subscribe(function (change) {
                if (change.type === ChangeType.Load) {
                    return;
                }
                _this.controlStateUpdater.updateControlState({
                    lintenerType: 'bindingData',
                    change: change
                });
            });
            this.subscriptionsMap.set(stateName, subscription);
        }
    };
    /**
     * 监听UIState变化
     */
    ControlStateListener.prototype.registerUIStateLintener = function () {
        var _this = this;
        var stateName = 'uiState';
        if (this.subscriptionsMap.has(stateName) === false) {
            var subscription = this.viewModelContext.uiState.changes.subscribe(function (change) {
                _this.controlStateUpdater.updateControlState({
                    lintenerType: 'uiState',
                    change: change
                });
            });
            this.subscriptionsMap.set(stateName, subscription);
        }
    };
    /**
     * 监听StateMachine变化
     */
    ControlStateListener.prototype.registerStateMachineLintener = function () {
        var _this = this;
        var stateName = 'stateMachine';
        if (this.subscriptionsMap.has(stateName) === false && this.viewModelContext.stateMachine) {
            var subscription = this.viewModelContext.stateMachine.stateChange.subscribe(function (change) {
                _this.controlStateUpdater.updateControlState({
                    lintenerType: 'stateMachine',
                    change: change
                });
            });
            this.subscriptionsMap.set(stateName, subscription);
        }
    };
    /**
     * 监听Form变化
     */
    ControlStateListener.prototype.registerFormLintener = function () {
        var _this = this;
        var stateName = 'form';
        if (this.subscriptionsMap.has(stateName) === false) {
            var subscription = this.viewModelContext.form.changes.subscribe(function (change) {
                if (change && change.type === 'validateFieldsFinished') {
                    _this.controlStateUpdater.updateControlState({
                        lintenerType: 'expression',
                        change: change
                    });
                }
                else {
                    _this.controlStateUpdater.updateControlState({
                        lintenerType: 'form',
                        change: change
                    });
                }
            });
            this.subscriptionsMap.set(stateName, subscription);
        }
    };
    return ControlStateListener;
}());

/*
 * @Author: Witt
 * @Date: 2018-11-17 13:38:23
 * @Last Modified by: Witt
 * @Last Modified time: 2018-11-17 13:38:50
 * @todo：临时删除原有功能，待重构
 */
/**
 * UI状态
 */
var UIState = /** @class */ (function () {
    function UIState() {
        this.changes = new Subject();
        this.innerData = Object.assign({});
        this._init();
    }
    UIState.prototype._init = function () {
        var construct = this.constructor;
        var uiFields = UIStateMetadataUtil.getUIFields(construct);
        var controlFields = UIStateMetadataUtil.getControlFields(construct);
        this.initializeUIField(uiFields);
        this.initializeControlField(controlFields);
    };
    //注册监听
    UIState.prototype.config = function (viewModelContext) {
        var construct = this.constructor;
        var controlFields = UIStateMetadataUtil.getControlFields(construct);
        if (controlFields && Object.keys(controlFields).length > 0) {
            this.controlStateListener = viewModelContext.injector.get(ControlStateListener);
        }
    };
    UIState.prototype.initializeUIField = function (uiFieldMetadata) {
        var _this = this;
        Object.keys(uiFieldMetadata).forEach(function (propertyName) {
            var fieldMetadata = uiFieldMetadata[propertyName];
            var uiField = fieldMetadata.stateName || propertyName;
            if (delete _this[propertyName]) {
                _this.defineProperty(propertyName, uiField);
            }
        });
    };
    UIState.prototype.initializeControlField = function (controlFieldMetadata) {
        var _this = this;
        Object.keys(controlFieldMetadata).forEach(function (propertyName) {
            var fieldMetadata = controlFieldMetadata[propertyName];
            var uiField = fieldMetadata.stateName || propertyName;
            if (delete _this[propertyName]) {
                _this.defineProperty(propertyName, uiField);
            }
        });
    };
    UIState.prototype.isExistProperty = function (propertyName) {
        if (this.innerData.hasOwnProperty(propertyName) || this.hasOwnProperty(propertyName)) {
            return true;
        }
        return false;
    };
    UIState.prototype.defineProperty = function (propertyName, field) {
        if (field === void 0) { field = null; }
        Object.defineProperty(this, propertyName, {
            get: function () {
                return field !== null ? this.innerData[field] : this.innerData[propertyName];
            },
            set: function (value) {
                // 值相同时不触发变更
                var oldValue = field !== null ? this.innerData[field] : this.innerData[propertyName];
                if (oldValue === value) {
                    return;
                }
                if (field !== null) {
                    this.innerData[field] = value;
                }
                else {
                    this.innerData[propertyName] = value;
                }
                this.changes.next({
                    field: propertyName,
                    value: value
                });
            }
        });
    };
    UIState.prototype.setPropertyValue = function (propertyName, value) {
        if (propertyName === '' || propertyName === undefined) {
            return;
        }
        if (!this.isExistProperty(propertyName)) {
            this.defineProperty(propertyName);
        }
        this[propertyName] = value;
    };
    return UIState;
}());

/**
 * --------------------------------------------------------------------------------
 * State相关
 * --------------------------------------------------------------------------------
 */
/**
 * 基本状态：表单的基本状态，通过State的运算确定RenderState的值，进而控制页面控件的状态。
 */
var State = /** @class */ (function () {
    /**
     * 构造函数
     * @param name 状态名称
     */
    function State(name) {
        this.name = name;
    }
    return State;
}());
/**
 * 初始渲染状态
 */
var initialUIState = false;

/**
 * 状态元数据名称
 */
var STATE_PROP_META = 'StatePropMeta';
var ɵ0$4 = function (obj) { return obj; };
/**
 * 页面状态元数据装饰器工厂
 */
var StatePropMeta = makePropDecorator(STATE_PROP_META, ɵ0$4);

/**
 * 组件状态元数据名称
 */
var RENDER_STATE_PROP_META = 'RenderStatePropMeta';
var ɵ0$5 = function (obj) { return obj; };
/**
 * 组件状态元数据工厂
 */
var RenderStatePropMeta = makePropDecorator(RENDER_STATE_PROP_META, ɵ0$5);

/**
 * 动作方法元数据名称
 */
var ACTION_METHOD_META = 'ActionMethodMeta';
var ɵ0$6 = function (action) { return action; };
/**
 * 迁移动作元数据装饰工厂
 */
var ActionMethodMeta = makePropDecorator(ACTION_METHOD_META, ɵ0$6);

/**
 * 状态机上下文
 */
var StateMachineContext = /** @class */ (function () {
    /**
     * 构造函数
     * @param stateMachine 状态机实例
     * @param initialState 初始状态
     */
    function StateMachineContext(stateMachine, initialState) {
        this.stateMachine = stateMachine;
        this.state = initialState.name;
    }
    /**
     * 初始化
     */
    StateMachineContext.prototype.init = function (frameContext) {
        this.viewModelContext = frameContext;
        this.parser = this.viewModelContext.injector.get(VariableParseService);
        this.stateMachineWatcher = this.stateMachine.stateMachineWatcher;
    };
    /**
     * 状态迁移
     * @param stateName 下一状态的名称
     */
    StateMachineContext.prototype.transitTo = function (stateName) {
        var nextState = this.stateMachine.states[stateName];
        if (nextState) {
            this.state = nextState.name;
            this.stateMachine.render();
        }
    };
    /**
     * 获取expression对应的UIState值
     * @param expression UIState表达式
     */
    StateMachineContext.prototype.getUIState = function (expression) {
        if (!expression) {
            return;
        }
        var viewModelContext = this.stateMachineWatcher.getViewModelContext(expression);
        if (!viewModelContext) {
            return;
        }
        this.stateMachineWatcher.subscribeUIStateChange(viewModelContext, expression);
        if (this.parser) {
            var value = this.parser.parse(expression, viewModelContext);
            if (value === null) {
                return null;
            }
            if (typeof value === 'object' && Object.keys(value).length === 0) {
                return null;
            }
            return value;
        }
        else {
            throw new Error('未初始化变量解析器。');
        }
    };
    /**
     * 获取数据的值
     */
    StateMachineContext.prototype.getData = function (expression) {
        if (!expression) {
            return;
        }
        var viewModelContext = this.stateMachineWatcher.getViewModelContext(expression);
        if (!viewModelContext) {
            return;
        }
        this.stateMachineWatcher.subscribeEntityChange(viewModelContext, expression);
        if (this.parser) {
            var value = this.parser.parse(expression, viewModelContext);
            if (value === null) {
                return null;
            }
            if (typeof value === 'object' && Object.keys(value).length === 0) {
                return null;
            }
            return value;
        }
        else {
            throw new Error('未初始化变量解析器。');
        }
    };
    return StateMachineContext;
}());

/**
 * 状态机事件，监听uistate的变化和entity的变化
 */
var StateMachineWatcher = /** @class */ (function () {
    function StateMachineWatcher(stateMachine) {
        this.stateMachine = stateMachine;
        /**
         * 所有UIStatePath数组
         */
        this.uiStatePathList = [];
        /**
         * 所有DataStatePath数组
         */
        this.dataStatePathList = [];
        this.viewModelContextAndUIStatePathsMap = new Map();
        this.viewModelContextAndDataStatePathsMap = new Map();
    }
    /**
     * 初始化
     * @param viewModelContext 当前视图上下文
     */
    StateMachineWatcher.prototype.init = function (viewModelContext) {
        this.viewModelContext = viewModelContext;
    };
    /**
     * 返回表达式中ViewModelId对应的ViewModelContext
     */
    StateMachineWatcher.prototype.getViewModelContext = function (expression) {
        var viewModelId = this.extractPaths(expression).split('/')[1];
        return this.viewModelContext.appContext.viewModelContextManager.getContextById(viewModelId);
    };
    /**
     * 监听UIState变更
     * @param viewModelContext ViewModel上下文
     * @param expression UIState表达式
     */
    StateMachineWatcher.prototype.subscribeUIStateChange = function (viewModelContext, expression) {
        var _this = this;
        var uiStatePath = this.getStatePath(expression);
        if (this.viewModelContextAndUIStatePathsMap.has(viewModelContext) === false) {
            this.viewModelContextAndUIStatePathsMap.set(viewModelContext, this.uiStatePathList);
            viewModelContext.uiState.changes.subscribe(function (uiStateChange) {
                var uiStatePathList = _this.viewModelContextAndUIStatePathsMap.get(viewModelContext);
                if (uiStateChange.field && uiStatePathList.indexOf(uiStateChange.field) > -1) {
                    _this.stateMachine.render();
                }
            });
        }
        if (this.viewModelContextAndUIStatePathsMap.get(viewModelContext).indexOf(uiStatePath) === -1) {
            this.uiStatePathList.push(uiStatePath);
        }
    };
    /**
     * 监听实体变更
     */
    StateMachineWatcher.prototype.subscribeEntityChange = function (viewModelContext, expression) {
        var _this = this;
        if (this.viewModelContextAndDataStatePathsMap.has(viewModelContext) === false) {
            this.viewModelContextAndDataStatePathsMap.set(viewModelContext, this.dataStatePathList);
            viewModelContext.bindingData.changes.subscribe(function (change) {
                if (change.type === 'Load' || change.type === 'SelectionChanged') {
                    _this.stateMachine.render();
                }
                var dataPathList = _this.viewModelContextAndDataStatePathsMap.get(viewModelContext);
                if (change.path.join() && _this.isAccordingPath(dataPathList, change.path.join('/'))) {
                    _this.stateMachine.render();
                }
            });
        }
        if (this.viewModelContextAndDataStatePathsMap.get(viewModelContext).indexOf(expression) === -1) {
            this.dataStatePathList.push(expression);
        }
    };
    /**
     * 根据表达式获取对应的StatePath（移除了ViewModelId之外的部分）
     * @param expression 变量表达式
     */
    StateMachineWatcher.prototype.getStatePath = function (expression) {
        return this.extractPaths(expression).split('/')[2];
    };
    /**
     * 判断是否监听范围内的变更路径
     */
    StateMachineWatcher.prototype.isAccordingPath = function (dataStatePaths, dataStatePath) {
        var targetPath = dataStatePaths.find(function (item) {
            return item.indexOf(dataStatePath) > -1;
        });
        return targetPath === undefined ? false : true;
    };
    /**
     * 暂时把这个方法放了这个地方，等季老师共用方法调整后，直接引用他的方法，该方法可删除
     * @param expression 变量表达式
     */
    StateMachineWatcher.prototype.extractPaths = function (expression) {
        var path;
        var UI_STATE_PATTERN_G = /\{UISTATE~(\S+?)\}/g;
        var DATA_PATTERN_G = /\{DATA~(\S+?)\}/g;
        var uiStateVariables = expression.match(UI_STATE_PATTERN_G);
        var dataVariables = expression.match(DATA_PATTERN_G);
        if (uiStateVariables !== null) {
            var UI_STATE_PATTERN_1 = /\{UISTATE~(\S+?)\}/;
            uiStateVariables.forEach(function (uiStateVariable) {
                var pathMatches = uiStateVariable.match(UI_STATE_PATTERN_1);
                if (pathMatches != null && pathMatches.length === 2) {
                    path = pathMatches[1];
                }
            });
        }
        if (dataVariables !== null) {
            var DATA_PATTERN_1 = /\{DATA~(\S+?)\}/;
            dataVariables.forEach(function (dataVariable) {
                var pathMatches = dataVariable.match(DATA_PATTERN_1);
                if (pathMatches != null && pathMatches.length === 2) {
                    path = pathMatches[1];
                }
            });
        }
        return path;
    };
    return StateMachineWatcher;
}());

/**
 * 状态机
 */
var StateMachine = /** @class */ (function () {
    /**
     * 构造函数
     */
    function StateMachine() {
        this.renderStates = {};
        this.handlePropMetadatas();
        this.stateChange = new BehaviorSubject(false);
        this.context = new StateMachineContext(this, this.initialState);
        this.stateMachineWatcher = new StateMachineWatcher(this);
    }
    /**
     * 初始化状态机
     * @param viewModelContext ViewModel上下文
     * @summary
     * 状态机变更，为了在绑定数据之后执行状态机的操作，把render方法延后执行。
     */
    StateMachine.prototype.init = function (viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.context.init(this.viewModelContext);
        this.stateMachineWatcher.init(this.viewModelContext);
        this.render();
    };
    /**
     * 批量处理属性元数据
     */
    StateMachine.prototype.handlePropMetadatas = function () {
        var _this = this;
        var propsMetadatas = MetadataUtil.getPropsMetadatas(this.constructor);
        // 遍历所有属性装饰器，并调用相应的build方法
        if (propsMetadatas) {
            Object.keys(propsMetadatas).forEach(function (propName) {
                var propMetadatas = propsMetadatas[propName];
                propMetadatas.forEach(function (propMetadata) {
                    _this.handlePropMetadata(propName, propMetadata);
                });
            });
        }
        if (!this.initialState) {
            throw new Error('请在StatePropMeta注解中指定状态机的初始状态。');
        }
    };
    /**
     * 处理属性元数据
     */
    StateMachine.prototype.handlePropMetadata = function (propName, propMetadata) {
        var ngMetadataName = propMetadata.ngMetadataName;
        switch (ngMetadataName) {
            case STATE_PROP_META:
                this.buildState(propName, propMetadata);
                break;
            case RENDER_STATE_PROP_META:
                this.buildRenderState(propName, propMetadata);
                break;
            case ACTION_METHOD_META:
                this.buildAction(propName, propMetadata);
                break;
            default:
                break;
        }
    };
    /**
     * 包装State
     * @param stateName 状态名称
     * @param ngState   状态对象
     */
    StateMachine.prototype.buildState = function (stateName, ngState) {
        this.states = this.states || {};
        this[stateName] = new State(stateName);
        this.states[stateName] = this[stateName];
        if (ngState.initialState) {
            this.initialState = this[stateName];
        }
    };
    /**
     * 包装RenderState
     * @param renderStateName 渲染状态名称
     * @param ngRenderState   渲染状态元数据
     */
    StateMachine.prototype.buildRenderState = function (renderStateName, ngRenderState) {
        this.renderStates = this.renderStates || {};
        this[renderStateName] = initialUIState;
        this.renderStates[renderStateName] = this[renderStateName];
        // 将renderState上指定的render加入到renders中
        this.renders = this.renders || {};
        this.renders[renderStateName] = ngRenderState.render;
    };
    /**
     * 包装Action
     * @param actionName 动作名称
     * @param ngAction 动作元数据
     */
    StateMachine.prototype.buildAction = function (actionName, ngAction) {
        var _this = this;
        this[actionName] = function () {
            var nextStateName = ngAction.transitTo;
            var nextState = _this.states[nextStateName];
            _this.context.transitTo(nextState.name);
            _this.render();
        };
    };
    /**
     * 重新计算所有渲染状态的值
     * @sumamry
     * 当 state切换的时候，调用遍历所有的render方法，更改renderState
     */
    StateMachine.prototype.render = function () {
        for (var renderStateName in this.renderStates) {
            if (this.renderStates.hasOwnProperty(renderStateName) === false) {
                continue;
            }
            // 执行RenderState的render方法，更新renderState
            var stateRender = this.renders[renderStateName];
            if (!stateRender) {
                continue;
            }
            this.renderStates[renderStateName] = stateRender(this.context);
            this[renderStateName] = this.renderStates[renderStateName];
        }
        this.stateChange.next(this.context.state);
    };
    return StateMachine;
}());

var BindingType;
(function (BindingType) {
    /**
     * 实体状态
     */
    BindingType["EntityState"] = "EntityState";
    /**
     * UI状态
     */
    BindingType["UIState"] = "UIState";
})(BindingType || (BindingType = {}));

/**
 * 日期字符串转换器
 */
var DateStringValueConverter = /** @class */ (function () {
    function DateStringValueConverter() {
    }
    DateStringValueConverter.prototype.convertFrom = function (dateObj) {
        return DateUtil.formatISO(dateObj);
    };
    DateStringValueConverter.prototype.convertTo = function (dateString) {
        return DateUtil.parse(dateString);
    };
    return DateStringValueConverter;
}());
/**
 * 数组字符串转换器
 */
var ArrayStringValueConverter = /** @class */ (function () {
    function ArrayStringValueConverter() {
    }
    ArrayStringValueConverter.prototype.convertFrom = function (arr) {
        return arr.join(',');
    };
    ArrayStringValueConverter.prototype.convertTo = function (arrString) {
        return arrString.split(',');
    };
    return ArrayStringValueConverter;
}());

/**
 * Entity值访问器
 */
var EntityBindingValueAccessor = /** @class */ (function () {
    function EntityBindingValueAccessor(bindingData, bindingPath, valueConverter) {
        this.bindingData = bindingData;
        this.bindingPathSegments = this.getBindingPathSegments(bindingPath);
        this.valueConverter = valueConverter;
    }
    EntityBindingValueAccessor.prototype.getValue = function () {
        var stateValue = this.bindingData.getValue(this.bindingPathSegments);
        var controlValue = this.valueConverter ? this.valueConverter.convertTo(stateValue) : stateValue;
        return controlValue;
    };
    EntityBindingValueAccessor.prototype.setValue = function (controlValue) {
        var oldStateValue = this.bindingData.getValue(this.bindingPathSegments);
        var stateValue = this.valueConverter ? this.valueConverter.convertFrom(controlValue) : controlValue;
        if (this.isDateConverter(this.valueConverter) === true) {
            if (DateUtil.isEqual(oldStateValue, stateValue) === true) {
                return;
            }
        }
        this.bindingData.setValue(this.bindingPathSegments, stateValue, true, true);
    };
    EntityBindingValueAccessor.prototype.getBindingPathSegments = function (bindingPath) {
        var parentPathSegments = BindingPathConverter.toBindingPathArray(this.bindingData.bindingPath);
        bindingPath = bindingPath.replace(/\./g, '\/');
        var bindingPathSegments = BindingPathConverter.toBindingPathArray(bindingPath);
        return parentPathSegments.concat(bindingPathSegments);
    };
    /**
     * 是否是DateConverter
     */
    EntityBindingValueAccessor.prototype.isDateConverter = function (converter) {
        var isDateConverter = false;
        if (converter && converter.hasOwnProperty('format') === true) {
            isDateConverter = true;
        }
        return isDateConverter;
    };
    return EntityBindingValueAccessor;
}());
/**
 * UIState值访问器
 */
var UIStateBindingValueAccessor = /** @class */ (function () {
    function UIStateBindingValueAccessor(uiState, bindingPath, valueConverter) {
        this.uiState = uiState;
        this.bindingPathSegments = this.getUiStateBindingPath(bindingPath);
    }
    UIStateBindingValueAccessor.prototype.getValue = function () {
        var stateValue;
        var obj = this.uiState;
        this.bindingPathSegments.forEach(function (item) {
            stateValue = obj[item];
            obj = stateValue;
        });
        return stateValue;
    };
    UIStateBindingValueAccessor.prototype.setValue = function (controlValue) {
        var _a;
        var length = this.bindingPathSegments.length;
        if (length === 1) {
            this.uiState.setPropertyValue(this.bindingPathSegments, controlValue);
        }
        else {
            var obj = void 0;
            for (var i = length - 1; i > 0; i--) {
                obj = (_a = {}, _a[this.bindingPathSegments[i]] = controlValue, _a);
                controlValue = obj;
            }
            this.uiState.setPropertyValue(this.bindingPathSegments[0], obj);
        }
    };
    // UISTATE获取路径
    UIStateBindingValueAccessor.prototype.getUiStateBindingPath = function (bindingPath) {
        var index = bindingPath.search('/');
        if (index !== -1) {
            return bindingPath.split('/');
        }
        else {
            return [bindingPath];
        }
    };
    return UIStateBindingValueAccessor;
}());
/**
 * 绑定值访问器工厂
 */
var BindingValueAccessorFactory = /** @class */ (function () {
    function BindingValueAccessorFactory() {
    }
    BindingValueAccessorFactory.create = function (bindingType, bindingBindingPath, bindingValueConverter, viewModelContext) {
        switch (bindingType) {
            case BindingType.EntityState:
                var bindingData = viewModelContext.bindingData;
                return new EntityBindingValueAccessor(bindingData, bindingBindingPath, bindingValueConverter);
            case BindingType.UIState:
                var uiState = viewModelContext.uiState;
                return new UIStateBindingValueAccessor(uiState, bindingBindingPath, bindingValueConverter);
            default:
                throw new Error('Not Supported');
        }
    };
    return BindingValueAccessorFactory;
}());

/**
 * FormControl元数据名称
 */
var FORM_CONTROL_PROP_META = 'FormControlPropMeta';
var ɵ0$7 = function (obj) { return obj; };
/**
 * FormControl装饰器工厂
 */
var FormControlPropMeta = makePropDecorator(FORM_CONTROL_PROP_META, ɵ0$7);

/**
 * 验证器工厂
 */
var ValidatorFactory = /** @class */ (function () {
    function ValidatorFactory() {
    }
    /**
     * 创建适配器
     */
    ValidatorFactory.create = function (validRules) {
        var _this = this;
        var validatorFn = [];
        if (Array.isArray(validRules) && validRules.length > 1) {
            validRules.forEach(function (validRule) {
                validatorFn.push(_this.initValidRuleFn(validRule));
            });
        }
        else if (Array.isArray(validRules) && validRules.length === 1) {
            validatorFn.push(this.initValidRuleFn(validRules[0]));
        }
        else {
            validatorFn.push(this.initValidRuleFn(validRules));
        }
        return validatorFn;
    };
    ValidatorFactory.initValidRuleFn = function (validRule) {
        var type = validRule.type, constraints = validRule.constraints, message = validRule.message;
        switch (type) {
            case 'required':
                return function (v, context) {
                    if (constraints[0] !== true) {
                        var parseService = context.injector.get(VariableParseService);
                        var parsedArgs = parseService.parse(constraints[0], context);
                        if (parsedArgs === true) {
                            if (null === v || undefined === v || '' === v) {
                                return { type: type, passing: false, message: message || '必填' };
                            }
                            else {
                                return { type: type, passing: true, message: '' };
                            }
                        }
                    }
                    if (constraints[0] === true) {
                        if (null === v || undefined === v || '' === v) {
                            return { type: type, passing: false, message: message || '必填' };
                        }
                        else {
                            return { type: type, passing: true, message: '' };
                        }
                    }
                    return { type: type, passing: true, message: '' };
                };
            case 'NumberMaxValue':
            case 'numberMaxValue':
                return function (v) {
                    if (typeof v !== 'number') {
                        return { passing: true, message: '' };
                    }
                    if (constraints[0] || 0 == constraints[0]) {
                        if (v <= parseFloat(constraints[0])) {
                            return { passing: true, message: '' };
                        }
                        else {
                            return { passing: false, message: message || "\u8F93\u5165\u503C\u4E0D\u80FD\u5927\u4E8E" + constraints[0] };
                        }
                    }
                    return { passing: true, message: '' };
                };
            case 'NumberMinValue':
            case 'numberMinValue':
                return function (v) {
                    if (typeof v !== 'number') {
                        return { passing: true, message: '' };
                    }
                    if (constraints[0] || 0 == constraints[0]) {
                        if (v >= parseFloat(constraints[0])) {
                            return { passing: true, message: '' };
                        }
                        else {
                            return { passing: false, message: message || "\u8F93\u5165\u503C\u4E0D\u80FD\u5C0F\u4E8E" + constraints[0] };
                        }
                    }
                    return { passing: true, message: '' };
                };
            case 'DateMaxValue':
            case 'dateMaxValue':
                return function (v) {
                    if (v === null || v === undefined || v === '') {
                        return { passing: true, message: '' };
                    }
                    if (constraints[0]) {
                        var condition = constraints[0];
                        if (condition.length == 21) {
                            condition = condition.slice(1, 20);
                        }
                        if (DateUtil.isBefore(v, condition) || DateUtil.isSame(v, condition)) {
                            return { passing: true, message: '' };
                        }
                        else {
                            return { passing: false, message: message || "\u8F93\u5165\u65E5\u671F\u4E0D\u80FD\u5927\u4E8E" + condition };
                        }
                    }
                    return { passing: true, message: '' };
                };
            case 'DateMinValue':
            case 'dateMinValue':
                return function (v) {
                    if (v === null || v === undefined || v === '') {
                        return { passing: true, message: '' };
                    }
                    if (constraints[0]) {
                        var condition = constraints[0];
                        if (condition.length == 21) {
                            condition = condition.slice(1, 20);
                        }
                        if (DateUtil.isAfter(v, condition) || DateUtil.isSame(v, condition)) {
                            return { passing: true, message: '' };
                        }
                        else {
                            return { passing: false, message: message || "\u8F93\u5165\u65E5\u671F\u4E0D\u80FD\u5C0F\u4E8E" + condition };
                        }
                    }
                    return { passing: true, message: '' };
                };
            case 'StringMaxLength':
            case 'stringMaxLength':
                return function (v) {
                    if (v === null || v === undefined || v === '') {
                        return { passing: true, message: '' };
                    }
                    if (constraints[0]) {
                        if (v.length <= constraints[0]) {
                            return { passing: true, message: '' };
                        }
                        else {
                            return { passing: false, message: message || "\u8F93\u5165\u503C\u957F\u5EA6\u4E0D\u80FD\u5927\u4E8E" + constraints[0] };
                        }
                    }
                    return { passing: true, message: '' };
                };
            case 'StringMinLength':
            case 'stringMinLength':
                return function (v) {
                    if (v === null || v === undefined || v === '') {
                        return { passing: true, message: '' };
                    }
                    if (constraints[0]) {
                        if (v.length >= constraints[0]) {
                            return { passing: true, message: '' };
                        }
                        else {
                            return { passing: false, message: message || "\u8F93\u5165\u503C\u957F\u5EA6\u4E0D\u80FD\u5C0F\u4E8E" + constraints[0] };
                        }
                    }
                    return { passing: true, message: '' };
                };
            case 'regex':
                return function (v) {
                    if (v === null || v === undefined || v === '') {
                        return { passing: true, message: '' };
                    }
                    var constraintsTemp = [];
                    if (typeof constraints[0] === 'string') {
                        constraintsTemp = constraints[0].split(',');
                    }
                    for (var i = 0; i < constraintsTemp.length; i++) {
                        if (constraintsTemp[i] === '') {
                            return;
                        }
                        var re = new RegExp(constraintsTemp[i]);
                        if (re.test(v)) {
                            return { passing: false, message: message || "\u5B58\u5728\u4E0D\u53EF\u8F93\u5165\u9879" + constraintsTemp[i] };
                        }
                    }
                    return { passing: true, message: '' };
                };
            case 'regexp':
                return function (v) {
                    if (v === null || v === undefined || v === '') {
                        return { passing: true, message: '' };
                    }
                    var re = new RegExp(constraints[0]);
                    if (!re.test(v)) {
                        return { passing: false, message: message || "\u8BF7\u8F93\u5165\u6B63\u786E\u683C\u5F0F" };
                    }
                    return { passing: true, message: '' };
                };
            case 'mobile':
                return function (v) {
                    if (v === null || v === undefined || v === '') {
                        return { passing: false, message: message || "\u8BF7\u8F93\u5165\u6B63\u786E\u7684\u624B\u673A\u53F7\u683C\u5F0F" };
                    }
                    var regexStr = constraints[0] === true ? /^1[0-9]{10}$/ : constraints[0];
                    var re = new RegExp(regexStr);
                    if (!re.test(v)) {
                        return { passing: false, message: message || "\u8BF7\u8F93\u5165\u6B63\u786E\u7684\u624B\u673A\u53F7\u683C\u5F0F" };
                    }
                    else {
                        return { passing: true, message: '' };
                    }
                };
            case 'email':
                return function (v) {
                    if (v === null || v === undefined || v === '') {
                        return { passing: false, message: message || "\u8BF7\u8F93\u5165\u6B63\u786E\u7684\u90AE\u7BB1\u683C\u5F0F" };
                    }
                    var regexStr = constraints[0] === true ? /^[A-Za-z0-9\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/ : constraints[0];
                    var re = new RegExp(regexStr);
                    if (!re.test(v)) {
                        return { passing: false, message: message || "\u8BF7\u8F93\u5165\u6B63\u786E\u7684\u90AE\u7BB1\u683C\u5F0F" };
                    }
                    else {
                        return { passing: true, message: '' };
                    }
                };
            case 'idCard':
                return function (v) {
                    if (v === null || v === undefined || v === '') {
                        return { passing: false, message: message || "\u8BF7\u8F93\u5165\u6B63\u786E\u7684\u8EAB\u4EFD\u8BC1\u683C\u5F0F" };
                    }
                    var regexStr = constraints[0] === true ? /^[1-9]\d{5}(18|19|([23]\d))\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$/ : constraints[0];
                    var re = new RegExp(regexStr);
                    if (!re.test(v)) {
                        return { passing: false, message: message || "\u8BF7\u8F93\u5165\u6B63\u786E\u7684\u8EAB\u4EFD\u8BC1\u683C\u5F0F" };
                    }
                    else {
                        return { passing: true, message: '' };
                    }
                };
            case 'customFunction':
                return function (v, context) {
                    if (typeof constraints[0] === 'function') {
                        var message_1 = constraints[0](v, context);
                        if (!message_1) {
                            return { passing: true, message: '' };
                        }
                        else {
                            return { passing: false, message: message_1 };
                        }
                    }
                    return { passing: true, message: '' };
                };
            case 'expression':
                return function (value, viewModelContext, options) {
                    if (options === void 0) { options = {}; }
                    var result = viewModelContext.expressionManager.validate(constraints[0], options);
                    if (result === false) {
                        return { passing: false, message: message };
                    }
                    else {
                        return { passing: true, message: '' };
                    }
                };
            case 'requiredExpression':
                return function (v, viewModelContext, options) {
                    if (options === void 0) { options = {}; }
                    var result = viewModelContext.expressionManager.validate(constraints[0], options);
                    if (result === true) {
                        if (null === v || undefined === v || '' === v) {
                            return { type: type, passing: false, message: message || '必填' };
                        }
                        else {
                            return { type: type, passing: true, message: '' };
                        }
                    }
                    else {
                        return { passing: true, message: '' };
                    }
                };
            case 'asyncCustomFunction':
                return function (v, context) {
                    if (typeof constraints[0] === 'function') {
                        var $message = from(constraints[0](v, context));
                        return $message.pipe(switchMap(function (message) {
                            if (!message) {
                                return of({ passing: true, message: '' });
                            }
                            else {
                                return of({ passing: false, message: message });
                            }
                        }));
                    }
                    return { passing: true, message: '' };
                };
            default:
                return function () {
                    return { passing: true, message: '' };
                };
        }
    };
    /**
     * 支持异步自定义函数
     * 遍历生成的校验方法对当前值进行校验，当发现错误就返回校验结果
     * 遍历完成没有错误则返回校验通过结果
     * @param validatorFn 校验方法
     * @param value 当前值
     */
    ValidatorFactory.executeValidator = function (validatorFn, value, context, options) {
        var validationResult = of({ passing: true, message: '' });
        for (var i = 0; i < validatorFn.length; i++) {
            var result = validatorFn[i](value, context, options);
            if (isObservable(result)) {
                validationResult = result;
                break;
            }
            if (result['passing'] === false) {
                return of(result);
            }
        }
        return validationResult;
    };
    /**
     * 不支持异步自定义函数
     * 遍历生成的校验方法对当前值进行校验，当发现错误就返回校验结果
     * 遍历完成没有错误则返回校验通过结果
     * @param validatorFn 校验方法
     * @param value 当前值
     */
    ValidatorFactory.noSupportAsynExecuteValidator = function (validatorFn, value, context, options) {
        for (var i = 0; i < validatorFn.length; i++) {
            var validationResult = validatorFn[i](value, context, options);
            if (isObservable(validationResult)) {
                break;
            }
            if (validationResult['passing'] === false) {
                return validationResult;
            }
        }
        return { passing: true, message: '' };
    };
    return ValidatorFactory;
}());

/**
 * FormControl定义
 */
var FormControl = /** @class */ (function () {
    function FormControl(config, viewModelContext) {
        this.validatorFn = [];
        this.required = false;
        this.requiredExpressionFlag = false;
        this.validateExpressionFlag = false;
        this.readonly = false;
        this.visible = true;
        // 初始验证规则
        this.validRules = [];
        // 记忆验证表达式的规则
        this.validRules_validates = [];
        this.valueAccessor = BindingValueAccessorFactory.create(config.bindingType, config.bindingPath, config.valueConverter, viewModelContext);
        this.validRules = [];
        if (config.validRules) {
            this.validRules = config.validRules;
            this.setValidatorFn(config.validRules);
        }
    }
    Object.defineProperty(FormControl.prototype, "value", {
        get: function () {
            return this.valueAccessor.getValue();
        },
        set: function (val) {
            this.valueAccessor.setValue(val);
        },
        enumerable: true,
        configurable: true
    });
    FormControl.prototype.getValidRules = function () {
        return this.validRules;
    };
    FormControl.prototype.setValidatorFn = function (validRules) {
        this.validatorFn = ValidatorFactory.create(validRules);
    };
    FormControl.prototype.pushValidatorFnforValidate = function (validRules, flag) {
        if (flag && this.validateExpressionFlag) {
            return;
        }
        this.validateExpressionFlag = flag;
        this.validRules_validates = validRules;
        this.validatorFn = this.validatorFn.concat(ValidatorFactory.create(validRules));
    };
    FormControl.prototype.pushValidatorFnforRequired = function (validRules, flag) {
        if (flag && this.requiredExpressionFlag) {
            return;
        }
        this.requiredExpressionFlag = flag;
        this.validatorFn = this.validatorFn.concat(ValidatorFactory.create(validRules));
    };
    FormControl.prototype.resetValidatorFnforRequired = function () {
        this.requiredExpressionFlag = false;
        this.validatorFn = ValidatorFactory.create(this.validRules.concat(this.validRules_validates));
    };
    FormControl.prototype.getValidatorFn = function () {
        return this.validatorFn;
    };
    return FormControl;
}());

/**
 * Form抽象类
 */
var Form = /** @class */ (function () {
    /**
     * 构造函数
     */
    function Form(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.formControlConfigs = [];
        this.validateformControls = [];
        this.validateformControlPathMap = new Map;
        this.changes = new Subject();
    }
    /**
     * 初始化
     */
    Form.prototype.init = function () {
        this.collectMetadatas();
        this.createFormControls();
    };
    /**
     * 使用不包含绝对路径的/或者/子表/的路径信息获取对应的formControlConfig的name属性与bindingPath并且返回该路径的formControl
     * @param path 路径信息
     * @returns
     */
    Form.prototype.getFormValueByBindPath = function (path) {
        var _this = this;
        var formControl = {
            form_name: {},
            name: '',
            bindingPath: ''
        };
        path = path.replace(/\//g, '.');
        if (this.formControlConfigs.length === 0)
            return formControl;
        this.formControlConfigs.forEach(function (formControlConfig) {
            if (formControlConfig.bindingPath === path) {
                formControl.form_name = _this[formControlConfig.name];
                formControl.name = formControlConfig.name;
                formControl.bindingPath = formControlConfig.bindingPath;
            }
        });
        return formControl;
    };
    /**
     *
     * @returns 获取当前表单上的存在校验字段的集合
     */
    Form.prototype.getValidateformControls = function () {
        return this.validateformControls;
    };
    Form.prototype.setValidateformControls = function (name) {
        if (this.validateformControls && this.validateformControls.length === 0) {
            this.validateformControls.push(name);
        }
        if (this.validateformControls && this.validateformControls.length >= 1) {
            var index = this.validateformControls.findIndex(function (item) { return item == name; });
            if (index === -1) {
                this.validateformControls.push(name);
            }
        }
        if (!Array.isArray(this.validateformControls)) {
            this.validateformControls = [name];
        }
    };
    Form.prototype.getValidateformControlPathMap = function () {
        return this.validateformControlPathMap;
    };
    Form.prototype.setValidateformControlPathMap = function (name, value) {
        if (!this.validateformControlPathMap.has(name)) {
            this.validateformControlPathMap.set(name, value);
        }
    };
    /**
     * 使用formControlConfig的bindingPath路径信息与对应formControlConfig的name信息储存起来作为验证信息在form上的记录
     * @param path formControlConfig的bindingPath路径信息
     * @param name 对应formContro的name信息
     */
    Form.prototype.addValidate = function (path, name) {
        var bindingPath = this.viewModelContext.bindingData.bindingPath.slice(1).replace(/\//g, '.');
        if (bindingPath) {
            bindingPath = bindingPath + '.';
        }
        ;
        this.setValidateformControlPathMap(bindingPath + path, name);
        this.setValidateformControls(name);
    };
    /**
     * 全部校验
     *  formControlConfigs 上所有的formControl的存在方法调用一遍 将错误信息集中返回
     */
    Form.prototype.validateFields = function () {
        var _this = this;
        var validationResult = [];
        if (this.validateformControls.length === 0) {
            return validationResult;
        }
        this.validateformControls.forEach(function (formControl) {
            var result$ = ValidatorFactory.executeValidator(_this[formControl]['validatorFn'], _this[formControl]['value'], _this.viewModelContext).pipe(tap(function (message) {
                _this[formControl]['validationResult'] = message;
                !message['passing'] && _this.changes.next({ type: 'validateFieldsFinished' });
            }));
            validationResult.push(result$);
        });
        return validationResult;
    };
    /**
     * 不支持自定义异步全部校验
     *  formControlConfigs 上所有的formControl的存在方法调用一遍 将错误信息集中返回
     */
    Form.prototype.noSupportAsynValidateFields = function () {
        var _this = this;
        var validationResult = [];
        if (this.validateformControls.length === 0) {
            return validationResult;
        }
        this.validateformControls.forEach(function (formControl) {
            if (!_this[formControl]['validationResult']) {
                _this[formControl]['validationResult'] = ValidatorFactory.noSupportAsynExecuteValidator(_this[formControl]['validatorFn'], _this[formControl]['value'], _this.viewModelContext);
            }
            !_this[formControl]['validationResult'].passing && validationResult.push(_this[formControl]);
        });
        this.changes.next({ type: 'validateFieldsFinished' });
        return validationResult;
    };
    /**
     * 获取某一个得校验错误信息
     * @param name 属性名称
     */
    Form.prototype.getFieldError = function (name) {
        var _this = this;
        if (this.validateformControls.length === 0) {
            return {};
        }
        var index = this.validateformControls.findIndex(function (item) {
            return item === name;
        });
        if (index === -1) {
            return {};
        }
        else {
            var result$ = ValidatorFactory.executeValidator(this[name]['validatorFn'], this[name]['value'], this.viewModelContext).pipe(tap(function (message) {
                _this[name]['validationResult'] = message;
                !message['passing'] && _this.changes.next({ type: 'validateFieldsFinished' });
            }));
            return result$;
        }
    };
    /**
   * 根据form元数据中的path获取某一个得校验错误信息
   * @param path 属性名称数组
   */
    Form.prototype.getFieldErrorByPath = function (path) {
        var _this = this;
        if (this.validateformControls.length === 0) {
            return {};
        }
        var pathName = path[0];
        if (path && path.length >= 2) {
            pathName = path.join('.');
        }
        var index = this.validateformControlPathMap.has(pathName);
        if (!index) {
            return {};
        }
        else {
            ValidatorFactory.executeValidator(this[this.validateformControlPathMap.get(pathName)]['validatorFn'], this[this.validateformControlPathMap.get(pathName)]['value'], this.viewModelContext).subscribe(function (message) {
                _this[_this.validateformControlPathMap.get(pathName)]['validationResult'] = message;
                _this.changes.next({ type: 'validateFieldsFinished', value: _this.validateformControlPathMap.get(pathName) });
            });
            return this[this.validateformControlPathMap.get(pathName)]['validationResult'];
        }
    };
    /**
     * 清除一组字段验证状态
     * @param fields 字段的数组
     */
    Form.prototype.resetFieldsValidate = function (fields) {
        var _this = this;
        if (this.validateformControls.length === 0) {
            return true;
        }
        else {
            if (fields && fields.length > 0) {
                var sb_1 = new Set(fields);
                // 交集
                var intersect = this.validateformControls.filter(function (x) { return sb_1.has(x); });
                // 遍历清空所有校验结果数据
                intersect.forEach(function (item) {
                    _this[item]['validationResult'] = undefined;
                });
            }
            else {
                // 没传数据全部清除
                this.validateformControls.forEach(function (item) {
                    _this[item]['validationResult'] = undefined;
                });
            }
            this.changes.next({ type: 'validateFieldsFinished' });
        }
    };
    /**
     * 创建FormControls
     */
    Form.prototype.createFormControls = function () {
        var _this = this;
        this.formControlConfigs.forEach(function (formControlConfig) {
            var name = formControlConfig.name;
            var formControl = new FormControl(formControlConfig, _this.viewModelContext);
            _this[name] = formControl;
        });
    };
    /**
     * 收集元数据
     */
    Form.prototype.collectMetadatas = function () {
        var _this = this;
        var formControlMetadatas = MetadataUtil.getPropsMetadatasByName(this.constructor, FORM_CONTROL_PROP_META);
        var bindingPath = this.viewModelContext.bindingData.bindingPath.slice(1).replace(/\//g, '.');
        var validationManager = this.viewModelContext.appContext['validationManager'];
        if (bindingPath) {
            bindingPath = bindingPath + '.';
        }
        ;
        Object.keys(formControlMetadatas).forEach(function (name) {
            var formControlMetadata = formControlMetadatas[name];
            var validRules = null;
            if (formControlMetadata.validRules) {
                _this.validateformControls.push(name);
                _this.validateformControlPathMap.set(bindingPath + formControlMetadata.bindingPath, name);
                validRules = formControlMetadata.validRules;
            }
            var key = ('/' + bindingPath + formControlMetadata.bindingPath).replace(/\./g, '/');
            if (validationManager[key]) {
                if (!validRules) {
                    _this.validateformControls.push(name);
                    _this.validateformControlPathMap.set(bindingPath + formControlMetadata.bindingPath, name);
                    validRules = Object.values(validationManager[key]);
                }
                else {
                    validRules = validRules.concat(Object.values(validationManager[key]));
                }
            }
            var formControlConfig = {
                name: name,
                bindingType: formControlMetadata.bindingType,
                bindingPath: formControlMetadata.bindingPath,
                valueConverter: formControlMetadata.valueConverter,
                valueChanging: formControlMetadata.valueChanging,
                valueChanged: formControlMetadata.valueChanged,
                validRules: validRules
            };
            _this.formControlConfigs.push(formControlConfig);
        });
    };
    Form.prototype.getEntityValueChangingListeners = function () {
        var listeners = {};
        this.formControlConfigs.forEach(function (formControl) {
            if (formControl.valueChanging) {
                listeners[formControl.bindingPath] = formControl.valueChanging;
            }
        });
        return listeners;
    };
    Form.prototype.getEntityValueChangedListeners = function () {
        var listeners = {};
        this.formControlConfigs.forEach(function (formControl) {
            if (formControl.valueChanged) {
                listeners[formControl.bindingPath] = formControl.valueChanged;
            }
        });
        return listeners;
    };
    return Form;
}());

/**
 * 命令装饰器名称
 */
var COMMAND_METHOD_META = 'CommandMethodMeta';
var ɵ0$8 = function (obj) { return obj; };
/**
 * 命令装饰器工厂
 */
var CommandMethodMeta = makePropDecorator(COMMAND_METHOD_META, ɵ0$8);

var RESOLVER_TOKEN = new InjectionToken('@farris_resolver_token');
var ENTITY_TEMPLATE = 'ENTITY~';
var STATE_TEMPLATE = 'STATE~';
var GROUP_FUNCTIONS = ['SumByProp', 'CountByProp', 'AvgByProp', 'MaxByProp', 'MinByProp', 'IsExistRecord', 'ListContains', 'ListGreaterThan', 'ListLessThan', 'ListStartWith', 'ListEndWith'];

var ResolverRegistry = /** @class */ (function () {
    function ResolverRegistry(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.resolvers = this.viewModelContext.injector.get(RESOLVER_TOKEN, []);
    }
    return ResolverRegistry;
}());

var EntityDependencyResolver = /** @class */ (function () {
    function EntityDependencyResolver(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.repository = this.viewModelContext.repository;
        this.entityTypeInfo = this.repository.entityTypeInfo;
    }
    /**
     * 解析用户表达式中的实体依赖
     * @param expr 用户配置的完整表达式
     * @returns
     */
    EntityDependencyResolver.prototype.resolve = function (expr) {
        var groupFunctionDependencies = ExpressionUtil.getGroupFunctionDependency(expr, this.repository.entityTypeInfo);
        var entityDependencies = this.getEntityDependency(expr);
        // 去除错误的到子表的依赖
        if (groupFunctionDependencies && groupFunctionDependencies.length > 0 && entityDependencies && entityDependencies.length > 0) {
            groupFunctionDependencies.forEach(function (dep) {
                var index = entityDependencies.findIndex(function (item) { return dep.startsWith(item); });
                if (index !== -1) {
                    entityDependencies.splice(index, 1);
                }
            });
        }
        // 去重
        var merged = __spread(groupFunctionDependencies, entityDependencies);
        var deps = __spread(new Set(merged));
        return deps;
    };
    /**
     * 获取合法的实体属性表达式
     * @param entityPropertyExpression 实体属性表达式
     * @returns
     */
    EntityDependencyResolver.prototype.getValidEntityPropertyExpression = function (entityPropertyExpression) {
        var propPaths = entityPropertyExpression.split('.');
        var propInfo = null;
        try {
            propInfo = this.entityTypeInfo.getPropInfoByPath(propPaths);
        }
        catch (e) { }
        if (!propInfo) {
            if (propPaths.length > 1) {
                propPaths.pop();
                return this.getValidEntityPropertyExpression(propPaths.join('.'));
            }
            else {
                return null;
            }
        }
        else {
            return entityPropertyExpression.split('.');
        }
    };
    /**
     * 获取所有实体依赖
     * @param expr 表达式字符串
     * @returns
     */
    EntityDependencyResolver.prototype.getEntityDependency = function (expr) {
        var _this = this;
        var deps = [];
        if (this.entityTypeInfo) {
            // 使用正则匹配出所有实体
            var regex = new RegExp("[\\'\\\"]?\\s*(" + this.entityTypeInfo.entityInfo.nodeCode + "|" + this.entityTypeInfo.entityInfo.originalCode + ")[\\.\\[\\]a-zA-Z0-9_]+\\s*[\\'\\\"]?", 'g');
            var entityPropertyExpressions = expr.match(regex);
            if (Array.isArray(entityPropertyExpressions) && entityPropertyExpressions.length > 0) {
                // 解析出所有实体相关的字符串，以主实体名字开头，包含主实体属性或子表
                entityPropertyExpressions.forEach(function (item) {
                    if (item.indexOf('.') === -1) {
                        console.warn("\u65E0\u6548\u7684\u5B9E\u4F53\u8868\u8FBE\u5F0F:" + item);
                        return;
                    }
                    // 去空格
                    item = item.trim().replace(/\"/g, '');
                    var paths = ExpressionUtil.convertToNodeCode(item, _this.repository.entityTypeInfo);
                    item = paths.join('.');
                    // 截去主实体及点
                    item = item.substr(item.indexOf('.') + 1);
                    var dep = _this.getValidEntityPropertyExpression(item);
                    if (dep && Array.isArray(dep) && dep.length > 0) {
                        // 此处必须加上主实体的名字来区分依赖的是实体还是其他类型的数据
                        dep.splice(0, 0, ENTITY_TEMPLATE);
                        deps.push(dep.join('/'));
                    }
                });
            }
        }
        else {
            console.warn("\u83B7\u53D6\u5B9E\u4F53\u7C7B\u578B\u4FE1\u606F\u5931\u8D25\uFF0C\u8BF7\u91CD\u65B0\u7F16\u8BD1\u6539\u8868\u5355\u3002");
        }
        return deps;
    };
    return EntityDependencyResolver;
}());

var CONTEXT_FUNCTIONS = ['GetContextParameter', 'GetSessionValue'];
var StateDependencyResolver = /** @class */ (function () {
    function StateDependencyResolver(viewModelContext) {
        this.viewModelContext = viewModelContext;
    }
    StateDependencyResolver.prototype.resolve = function (expr) {
        var deps = [];
        var regex = new RegExp("DefaultFunction\\.(" + CONTEXT_FUNCTIONS.join('|') + ")\\s*\\([^\\r\\n\\)]*\\)", 'g');
        var contextFunctions = expr.match(regex);
        if (contextFunctions && contextFunctions.length > 0) {
            // todo: 使用正则匹配时可能会因为参数中有逗号导致问题，后续使用ast解析
            var argumentsRegex_1 = /\(([^\r\n\)]*)\)/;
            contextFunctions.forEach(function (groupFunction) {
                var argumentMatchResult = groupFunction.match(argumentsRegex_1);
                if (argumentMatchResult.length === 2) {
                    var argument = argumentMatchResult[1].trim().replace(/\"/g, '');
                    var dep = ['STATE~'];
                    dep.push(argument);
                    deps.push(dep.join('/'));
                }
            });
        }
        return deps;
    };
    return StateDependencyResolver;
}());

/**
 * 用户自定义参数解析器
 */
var CommentDependencyResolver = /** @class */ (function () {
    function CommentDependencyResolver() {
    }
    CommentDependencyResolver.prototype.resolve = function (expr) {
        var dependencies = [];
        if (!expr || expr.length < 1) {
            return dependencies;
        }
        var defineRegex = /\/\*\*\s*__define__\((.*)\)\s*\*\//;
        var defineMatchArray = expr.match(defineRegex);
        if (defineMatchArray && defineMatchArray.length === 2) {
            var defineString = defineMatchArray[1].trim();
            var defineObject = null;
            try {
                defineObject = JSON.parse(defineString);
            }
            catch (e) {
                console.warn("\u81EA\u5B9A\u4E49\u4F9D\u8D56\u89E3\u6790\u5931\u8D25\uFF1A" + defineString);
            }
            if (defineObject && defineObject.hasOwnProperty('deps') && Array.isArray(defineObject['deps'])) {
                dependencies.push.apply(dependencies, __spread(defineObject['deps']));
            }
        }
        return dependencies;
    };
    return CommentDependencyResolver;
}());

var ResolveService = /** @class */ (function () {
    function ResolveService(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.resolverRegistry = this.viewModelContext.injector.get(ResolverRegistry);
    }
    ResolveService.prototype.resolve = function (expression) {
        var deps = [];
        if (!this.resolverRegistry || !this.resolverRegistry.resolvers || this.resolverRegistry.resolvers.length < 1) {
            return;
        }
        // 优先使用用户自定义的依赖
        var commentDependencyResolver = this.resolverRegistry.resolvers.find(function (resolver) { return resolver instanceof CommentDependencyResolver; });
        if (commentDependencyResolver) {
            var commentDependencies = commentDependencyResolver.resolve(expression);
            if (commentDependencies && Array.isArray(commentDependencies) && commentDependencies.length > 0) {
                deps.push.apply(deps, __spread(commentDependencies));
            }
        }
        // 如果用户已经自定义了依赖，则不再计算
        if (deps && deps.length > 0) {
            return;
        }
        this.resolverRegistry.resolvers.forEach(function (resolver) {
            // 再解析一次也可以，返回的依然是空数组
            if (resolver instanceof CommentDependencyResolver) {
                return;
            }
            var dependency = resolver.resolve(expression);
            if (dependency && dependency.length > 0) {
                deps.push.apply(deps, __spread(dependency));
            }
        });
        // 去重
        return __spread(new Set(deps));
    };
    return ResolveService;
}());

var ExpressionUtil = /** @class */ (function () {
    function ExpressionUtil() {
    }
    ExpressionUtil.getGroupFunctionDependency = function (expr, entityTypeInfo) {
        var _this = this;
        var deps = [];
        // 获取聚合函数依赖项
        var groupFunctionRegex = new RegExp("DefaultFunction\\.(" + GROUP_FUNCTIONS.join('|') + ")\\s*\\([^\\r\\n\\)]*\\)", "g");
        var groupFunctions = expr.match(groupFunctionRegex);
        if (groupFunctions && groupFunctions.length > 0) {
            // todo: 使用正则匹配时可能会因为参数中有逗号导致问题，后续使用ast解析
            var argumentsRegex_1 = /\(([^\r\n\)]*)\)/;
            groupFunctions.forEach(function (groupFunction) {
                var argumentMatchResult = groupFunction.match(argumentsRegex_1);
                if (argumentMatchResult.length === 2) {
                    var argument = argumentMatchResult[1];
                    var args = argument.split(',').map(function (p) { return p.replace(/\"/g, ''); });
                    if (args && args.length === 2) {
                        var item = args.join('.');
                        item = _this.convertToNodeCode(item, entityTypeInfo).join('.');
                        item = item.substr(item.indexOf('.') + 1);
                        var dep = item.split('.');
                        dep.splice(0, 0, ENTITY_TEMPLATE);
                        deps.push(dep.join('/'));
                    }
                    else {
                        throw new Error("\u65E0\u6CD5\u89E3\u6790\u53C2\u6570\uFF1A " + JSON.stringify(argument));
                    }
                }
            });
        }
        return deps;
    };
    /**
     * 将voCode转换为前端nodeCode
     * @param entityExpression like Entity.Child.p1
     * @returns
     */
    ExpressionUtil.convertToNodeCode = function (entityExpression, entityTypeInfo) {
        // UserEntity.storys.p1
        var nodeCodes = [];
        if (entityTypeInfo && entityExpression.includes('.')) {
            var entityExpressions = entityExpression.split('.') || [];
            var dataTypeInfo = entityTypeInfo;
            for (var index = 0; index < entityExpressions.length; index++) {
                var prop = entityExpressions[index];
                if (dataTypeInfo && dataTypeInfo.entityInfo && dataTypeInfo.entityInfo.nodeCode === prop || dataTypeInfo.entityInfo.originalCode === prop) {
                    // 第一个是主表code，不能转nodeCode
                    if (index === 0) {
                        nodeCodes.push(dataTypeInfo.entityInfo.originalCode);
                    }
                    else {
                        nodeCodes.push(dataTypeInfo.entityInfo.nodeCode);
                    }
                    // 下一级可能为子表、对象或属性
                    var nextNodeCode = entityExpressions[index + 1];
                    if (!nextNodeCode) {
                        break;
                    }
                    var nextNodeCodePropInfo = dataTypeInfo.getPropInfoByName(nextNodeCode);
                    if (!nextNodeCodePropInfo) {
                        break;
                    }
                    // 下一级为子表或对象
                    if (nextNodeCodePropInfo.typeInfo) {
                        dataTypeInfo = nextNodeCodePropInfo.typeInfo;
                    }
                }
                else if (dataTypeInfo && dataTypeInfo.getPropInfoByName(prop)) {
                    var dataPropInfo = dataTypeInfo.getPropInfoByName(prop);
                    nodeCodes.push(dataPropInfo.name);
                }
                else {
                    //throw new Error(`错误的属性参数 ${entityExpression}`);
                    break;
                }
            }
        }
        return nodeCodes;
    };
    /**
     * 找到元数据中所有实体路径
     * @param dataTypeInfo
     * @param results
     * @param paths
     */
    ExpressionUtil.getChildrenEntityPaths = function (dataTypeInfo, results, paths) {
        var _this = this;
        if (paths === void 0) { paths = []; }
        var list = dataTypeInfo.getPropInfosByGroup(DataPropGroup.List);
        if (list && list.length > 0) {
            list.forEach(function (dataPropInfo) {
                if (paths.length === 0) {
                    results.push([dataPropInfo.name]);
                }
                var childrens = dataPropInfo.typeInfo.getPropInfosByGroup(DataPropGroup.List);
                if (childrens && childrens.length > 0) {
                    paths.push(dataPropInfo.name);
                    childrens.forEach(function (dataPropInfo) {
                        _this.getChildrenEntityPaths(dataPropInfo.typeInfo, results, paths);
                    });
                }
                else {
                    if (paths.length !== 0) {
                        paths.push(dataPropInfo.name);
                        results.push(__spread(paths));
                    }
                    paths.length = 0;
                }
            });
        }
        else {
            if (paths.length > 0) {
                paths.push(dataTypeInfo.entityInfo.nodeCode);
                results.push(__spread(paths));
            }
            paths.length = 0;
        }
    };
    /**
     * 获取指定绑定路径的当前行数据
     * @param paths 绑定路径
     * @param bindingData
     * @returns
     */
    ExpressionUtil.getCurrentRowByPaths = function (paths, bindingData) {
        var result = null;
        var bindingList = bindingData.getValue(paths);
        if (bindingList && bindingList.length > 0) {
            var primaryValue = bindingList.currentItem.primaryKeyValue || null;
            // 使用事件中的主键
            // 主表或下级表新增，此时事件行就是当前行，无需处理
            if (primaryValue) {
                var bindingObject = bindingList.findById(primaryValue);
                if (bindingObject) {
                    result = bindingObject.toJSON();
                }
            }
        }
        return result;
    };
    /**
     * 从实体路径中获取级数最大的从表或从从表
     * @param paths
     * @returns
     */
    ExpressionUtil.getAvailableChildrenPathsFromEntityPaths = function (paths, entityTypeInfo) {
        var nodeCodes = [];
        paths = __spread(paths);
        while (paths.length > 0) {
            var dataPropInfo = entityTypeInfo.getPropInfoByPath(paths);
            if (dataPropInfo.group === 'List') {
                nodeCodes = paths;
                break;
            }
            paths.pop();
        }
        return nodeCodes;
    };
    /**
     * 从路径中获取绑定路径
     * @param paths 路径
     * @param entityTypeInfo entityTypeInfo
     * @returns
     */
    ExpressionUtil.getBindingPath = function (paths, entityTypeInfo) {
        paths = this.getEntityPath(paths);
        var entityPaths = this.getAvailableChildrenPathsFromEntityPaths(paths, entityTypeInfo);
        return entityPaths;
    };
    ExpressionUtil.getEntityPath = function (path) {
        var paths = path.filter(function (value, index) {
            if (index % 2 === 0 && value.includes(':')) {
                return false;
            }
            else {
                return true;
            }
        });
        return paths;
    };
    return ExpressionUtil;
}());

var Core = /** @class */ (function () {
    function Core() {
    }
    Core.warn = function (message) {
        var optionalParams = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            optionalParams[_i - 1] = arguments[_i];
        }
        this.logable() && console && console.warn.apply(console, __spread([message], optionalParams));
    };
    Core.error = function (message) {
        var optionalParams = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            optionalParams[_i - 1] = arguments[_i];
        }
        this.logable() && console && console.error.apply(console, __spread([message], optionalParams));
    };
    Core.log = function (message) {
        var optionalParams = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            optionalParams[_i - 1] = arguments[_i];
        }
        this.logable() && console && console.log.apply(console, __spread([message], optionalParams));
    };
    Core.logable = function () {
        return window && window.localStorage && window.localStorage.getItem('__DEVKIT_LOGABLE__') === 'true' || false;
    };
    return Core;
}());

var FORM_PATH_TOKEN = new InjectionToken('@farris/devkit form path token');
var BACK_END_MESSAGE_HANDLER_TOKEN = new InjectionToken('@farris/devkit_back_end_message_handler');
var MESSAGE_SERVICE_TOKEN = new InjectionToken('@farris/message_service_token');
var NOTIFY_SERVICE_TOKEN = new InjectionToken('@farris/notify_service_token');
var NAMESPACE = new InjectionToken('@farris/devkit NAMESPACE');

// export type ClassType = new (...args: any[]) => any;
var BigNumberType = 'BigNumber';
/**
 * 后端消息
 */
// tslint:disable-next-line: no-namespace
var BackEndMessage;
(function (BackEndMessage) {
    /**
     * 消息级别
     */
    var Level;
    (function (Level) {
        Level["Error"] = "Error";
        Level["Info"] = "Info";
        Level["Warning"] = "Warning";
    })(Level = BackEndMessage.Level || (BackEndMessage.Level = {}));
    /**
     * 消息
     * @description 接口执行成功，但有info/warning级别的消息
     */
    var Message = /** @class */ (function () {
        function Message(bizMessages, context) {
            this.bizMessages = bizMessages;
            this.context = context;
        }
        return Message;
    }());
    BackEndMessage.Message = Message;
})(BackEndMessage || (BackEndMessage = {}));

var EFFECTOR_TOKEN = new InjectionToken('@farris/effector_token');

/**
 * 实体副作用器
 * @description 将表达式计算结果赋值给实体属性
 */
var RepositoryEffector = /** @class */ (function () {
    function RepositoryEffector(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.ns = this.viewModelContext.injector.get(NAMESPACE, '');
        this.repository = this.viewModelContext.repository;
        this.bindingData = this.viewModelContext.bindingData;
    }
    RepositoryEffector.prototype.effect = function (path, value, options) {
        if (!options || !options.path) {
            throw new Error('repository effector 需要指定行信息。');
        }
        var propertyPath = options.path;
        var rowId = propertyPath[0] || this.bindingData.list.currentItem.primaryKeyValue;
        var entity = this.repository.entityCollection.getEntityById(rowId);
        if (rowId && !entity) {
            console.error("\u627E\u4E0D\u5230id\uFF1A" + rowId + "\u5BF9\u5E94\u7684\u5B9E\u4F53\uFF01");
            return;
        }
        // propertyPath like : [1, child1s, 1.1, child2s, 1.1.1,propName] or [1,udt,propName] or [1,prop]
        var propName = propertyPath.pop();
        var object = entity;
        for (var index = 1; index < propertyPath.length; index++) {
            var propertyName = propertyPath[index];
            if (object instanceof EntityList) {
                object = object.get(propertyName);
            }
            else {
                object = object[propertyName];
            }
        }
        if (object) {
            if (object[propName] !== value) {
                object[propName] = value;
            }
        }
        else {
            console.error("\u627E\u4E0D\u5230\u5B9E\u4F53\u5BF9\u5E94\u7684\u8DEF\u5F84\uFF1A" + propertyPath.push(propName));
        }
    };
    return RepositoryEffector;
}());

var UIStateEffector = /** @class */ (function () {
    function UIStateEffector(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.ns = this.viewModelContext.injector.get(NAMESPACE, '');
        this.uiState = this.viewModelContext.uiState;
    }
    UIStateEffector.prototype.effect = function (path, value, options) {
        this.uiState.setPropertyValue(path, value);
    };
    return UIStateEffector;
}());

var EffectorRegistry = /** @class */ (function () {
    function EffectorRegistry(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.effectors = this.viewModelContext.injector.get(EFFECTOR_TOKEN);
    }
    return EffectorRegistry;
}());

// tslint:disable-next-line: no-namespace
var Expression;
(function (Expression) {
    /**
     * 表达式绑定字段类型（表达式绑定到实体、UIState?）
     */
    var ExpressionBindingType;
    (function (ExpressionBindingType) {
        ExpressionBindingType["State"] = "State";
        ExpressionBindingType["Field"] = "Field";
    })(ExpressionBindingType = Expression.ExpressionBindingType || (Expression.ExpressionBindingType = {}));
    /**
     * 表达式类型
     */
    var ExpressionType;
    (function (ExpressionType) {
        /**
         * 必填表达式
         */
        ExpressionType["Required"] = "require";
        /**
         * 只读表达式
         */
        ExpressionType["Readonly"] = "readonly";
        /**
         * 计算表达式
         */
        ExpressionType["Compute"] = "compute";
        /**
         * 依赖表达式
         */
        ExpressionType["Dependency"] = "dependency";
        /**
         * 是否可见
         */
        ExpressionType["Visible"] = "visible";
        /**
         * 关联表达式
         */
        ExpressionType["Relative"] = "relative";
        /**
         * 校验表达式
         */
        ExpressionType["Validate"] = "validate";
        /**
         * 帮助前
         */
        ExpressionType["DataPicking"] = "dataPicking";
    })(ExpressionType = Expression.ExpressionType || (Expression.ExpressionType = {}));
    /**
     * 事件类型
     */
    var EventType;
    (function (EventType) {
        EventType["ValueChanged"] = "VALUE_CHANGED";
        EventType["SelectionChanged"] = "SELECTION_CHANGED";
        EventType["Load"] = "Load";
        EventType["Append"] = "Append";
        EventType["Remove"] = "Remove";
        EventType["Update"] = "Update";
    })(EventType = Expression.EventType || (Expression.EventType = {}));
    var EventSource;
    (function (EventSource) {
        EventSource["Field"] = "Field";
        EventSource["State"] = "State";
        EventSource["BindingData"] = "BindingData";
        EventSource["Repository"] = "Repository";
    })(EventSource = Expression.EventSource || (Expression.EventSource = {}));
    var MessageType;
    (function (MessageType) {
        MessageType["error"] = "error";
        MessageType["info"] = "info";
        MessageType["warning"] = "warning";
    })(MessageType = Expression.MessageType || (Expression.MessageType = {}));
    var EffectPath;
    (function (EffectPath) {
        EffectPath[EffectPath["currentRow"] = 0] = "currentRow";
    })(EffectPath = Expression.EffectPath || (Expression.EffectPath = {}));
    Expression.MESSAGE = {
        'zh-CHS': {
            require: "\u8BF7\u8F93\u5165'$property'",
            validate: "'$property'\u6821\u9A8C\u4E0D\u901A\u8FC7"
        },
        en: {
            require: "Please input '$property'",
            validate: "'$property' calibration failed"
        },
        'zh-CHT': {
            require: "\u8ACB\u8F38\u5165'$property'",
            validate: "'$property'\u6821\u9A57\u4E0D\u901A\u904E"
        }
    };
    Expression.DEPENDENCY_SPLITER = '/';
})(Expression || (Expression = {}));

var LISTENER_TOKEN = new InjectionToken('@Farris listener');

/**
 * 变更监听器
 */
var ChangeListener = /** @class */ (function () {
    function ChangeListener() {
        this.subject = new Subject();
    }
    Object.defineProperty(ChangeListener.prototype, "onEvent", {
        get: function () {
            return this.subject;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 找到元数据中所有实体路径
     * @param dataTypeInfo
     * @param results
     * @param paths
     */
    ChangeListener.prototype.findEntityPaths = function (dataTypeInfo, results, paths) {
        var _this = this;
        if (paths === void 0) { paths = []; }
        var list = dataTypeInfo.getPropInfosByGroup(DataPropGroup.List);
        if (list && list.length > 0) {
            list.forEach(function (dataPropInfo) {
                paths.push(dataPropInfo.name);
                var childrens = dataPropInfo.typeInfo.getPropInfosByGroup(DataPropGroup.List);
                if (childrens && childrens.length > 0) {
                    childrens.forEach(function (dataPropInfo) {
                        _this.findEntityPaths(dataPropInfo.typeInfo, results, paths);
                    });
                }
                else {
                    results.push(paths);
                }
            });
        }
        else if (paths && paths.length > 0) {
            results.push(paths);
        }
    };
    return ChangeListener;
}());

/**
 * 监听UIState变更
 */
var UIStateChangeListener = /** @class */ (function (_super) {
    __extends(UIStateChangeListener, _super);
    /**
     * 构造函数
     */
    function UIStateChangeListener(viewModelContext) {
        var _this = _super.call(this) || this;
        _this.viewModelContext = viewModelContext;
        _this.frameId = _this.viewModelContext.id;
        _this.uiState = _this.viewModelContext.uiState;
        _this.namespace = _this.viewModelContext.injector.get(NAMESPACE, null);
        _this.registerEvent();
        return _this;
    }
    UIStateChangeListener.prototype.buildEventPath = function (change) {
        return null;
    };
    UIStateChangeListener.prototype.registerEvent = function () {
        var _this = this;
        if (this.uiState && this.uiState.changes) {
            this.uiState.changes.subscribe(function (change) {
                var modification = {
                    ns: _this.namespace,
                    path: [change.field],
                    type: Expression.EventType.ValueChanged,
                    value: change.value,
                    source: Expression.EventSource.State,
                    frameId: _this.frameId
                };
                // console.log("UIStateChangeListener", modification);
                _this.subject.next(modification);
            });
        }
    };
    return UIStateChangeListener;
}(ChangeListener));

var EventType = Expression.EventType;
var RepositoryChangeListener = /** @class */ (function (_super) {
    __extends(RepositoryChangeListener, _super);
    function RepositoryChangeListener(viewModelContext) {
        var _this = _super.call(this) || this;
        _this.viewModelContext = viewModelContext;
        _this.namespace = _this.viewModelContext.injector.get(NAMESPACE, null);
        _this.repository = _this.viewModelContext.repository;
        _this.bindingData = _this.viewModelContext.bindingData;
        _this.registerEvent();
        return _this;
    }
    RepositoryChangeListener.prototype.registerEvent = function () {
        var _this = this;
        if (this.repository && this.repository.changes) {
            this.repository.changes.subscribe(function (change) {
                var eventType = _this.convertEventType(change);
                if (!eventType) {
                    return;
                }
                var path = _this.buildEventPath(change);
                var modification = {
                    ns: _this.namespace,
                    type: eventType,
                    path: path,
                    value: change.value,
                    source: Expression.EventSource.Field,
                };
                // console.log("RepositoryChangeListener", modification);
                _this.subject.next(modification);
            });
        }
        // repository只监听值变化事件
        if (this.repository && this.repository.entityCollectionChange) {
            this.repository.entityCollectionChange.subscribe(function (change) {
                var eventType = _this.convertEventType(change);
                if (!eventType) {
                    return;
                }
                var path = _this.buildEventPath(change);
                var modification = {
                    ns: _this.namespace,
                    type: eventType,
                    path: path,
                    value: change.value,
                    source: Expression.EventSource.Repository,
                };
                _this.subject.next(modification);
            });
        }
    };
    /**
     * 构建事件路径参数
     * @param event event
     * @description 构建完之后的路径类似[id,prop] or [id,从表名s,从表当前行id,从表属性] or [id,udt,udt_prop]
     * @returns
     */
    RepositoryChangeListener.prototype.buildEventPath = function (event) {
        var _this = this;
        var paths = event.path;
        var result = [];
        if (!paths || paths.length < 1) {
            // 主表新增时path为空
            return result;
        }
        // 过滤掉udt的冒号，关联字段的id
        result = paths.filter(function (path, index) {
            if (index % 2 === 0 && path.includes(':')) {
                if (path === ':') {
                    return false;
                }
                var primaryKey = path.split(':')[0];
                if (primaryKey !== _this.repository.primaryKey) {
                    return false;
                }
            }
            return true;
        });
        // 移除路径中的id字符串
        // result = paths.map((path: string, index: number) => {
        //   if (path.includes(':') && index % 2 === 0) {
        //     return path.split(':')[1];
        //   }
        //   return path;
        // });
        // 此时result中不应该有冒号
        return result;
    };
    RepositoryChangeListener.prototype.convertEventType = function (change) {
        var eventType = null;
        if (change.type === ModifyType.Add || change.type === ModifyType.AddData || change.type === ModifyType.Insert) {
            // eventType = Expression.EventType.Append;
            // 不处理新增
        }
        else if (change.type === ModifyType.Remove || change.type === ModifyType.RemoveData) {
            // eventType = Expression.EventType.Remove;
        }
        else if (change.type === ModifyType.Load) {
            // eventType = Expression.EventType.Load;
        }
        else if (change.type === ModifyType.ValueChange) {
            //eventType = Expression.EventType.ValueChanged;
            // 不处理值变化
        }
        else if (change.type === ModifyType.Update) {
            eventType = Expression.EventType.Update;
        }
        return eventType;
    };
    return RepositoryChangeListener;
}(ChangeListener));

var ListenerRegistry = /** @class */ (function () {
    /**
     * 构造函数
     */
    function ListenerRegistry(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.listeners = this.viewModelContext.injector.get(LISTENER_TOKEN);
    }
    return ListenerRegistry;
}());

var EventType$1 = Expression.EventType;
/**
 * 监听bindingList变更
 * @description 主要用于监听行切换等事件
 */
var BindingDataChangeListener = /** @class */ (function (_super) {
    __extends(BindingDataChangeListener, _super);
    /**
     * 构造函数
     */
    function BindingDataChangeListener(viewModelContext) {
        var _this = _super.call(this) || this;
        _this.viewModelContext = viewModelContext;
        /**
         * 实体仓库
         */
        _this.repository = null;
        _this.namespace = _this.viewModelContext.injector.get(NAMESPACE, '');
        _this.repository = _this.viewModelContext.repository;
        _this.bindingData = _this.viewModelContext.bindingData;
        _this.registerEvent();
        return _this;
    }
    /**
     * 注册值变化事件
     */
    BindingDataChangeListener.prototype.registerEvent = function () {
        var _this = this;
        if (this.bindingData && this.bindingData.changes && typeof this.bindingData.changes.subscribe === 'function') {
            this.bindingData.changes.subscribe(function (change) {
                if (change.type === ChangeType.Append || change.type === ChangeType.ValueChanged || change.type === ChangeType.Remove || change.type === ChangeType.Load || change.type === ChangeType.SelectionChanged) {
                    var eventType = null;
                    if (change.type === ChangeType.Append) {
                        eventType = EventType$1.Append;
                    }
                    else if (change.type === ChangeType.ValueChanged) {
                        eventType = EventType$1.ValueChanged;
                    }
                    else if (change.type === ChangeType.Remove) {
                        eventType = EventType$1.Remove;
                    }
                    else if (change.type === ChangeType.Load) {
                        // 主表新增
                        if (change.create === true) {
                            eventType = EventType$1.Append;
                        }
                        else {
                            eventType = EventType$1.Load;
                        }
                    }
                    else if (change.type === ChangeType.SelectionChanged) {
                        eventType = EventType$1.SelectionChanged;
                    }
                    var path = _this.buildEventPath(change);
                    var modification = {
                        ns: _this.namespace,
                        path: path,
                        type: eventType,
                        source: Expression.EventSource.BindingData,
                        value: change.value,
                        id: change.id
                    };
                    // console.log("BindingDataChangeListener", modification);
                    _this.subject.next(modification);
                }
            });
        }
    };
    BindingDataChangeListener.prototype.buildEventPath = function (change) {
        var path = change.path;
        var paths = [];
        // if (!path || path.length < 1) {
        //   return paths;
        // }
        var primaryValue = this.bindingData.list.currentItem.primaryKeyValue;
        if (primaryValue) {
            if (!(change.type === ChangeType.Load && change.path.length === 0)) {
                paths.push(this.bindingData.list.primaryKey + ":" + primaryValue);
            }
        }
        var currentPath = [];
        for (var index = 0; index < path.length; index++) {
            var propertyName = path[index];
            currentPath.push(propertyName);
            var item = this.bindingData.getValue(currentPath);
            paths.push(propertyName);
            if (item instanceof BindingList) {
                if (currentPath.length < path.length) {
                    var bindingList = item;
                    var currentId = bindingList.currentItem.primaryKeyValue;
                    if (index === path.length - 2 && change.id) {
                        currentId = change.id;
                    }
                    paths.push(this.bindingData.list.primaryKey + ":" + currentId);
                }
            }
        }
        return paths;
    };
    return BindingDataChangeListener;
}(ChangeListener));

/**
 * 监听器
 * @description 监听bindingList、UIState变更
 */
var Listeners = /** @class */ (function () {
    /**
     * 构造函数
     */
    function Listeners(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.subject = new Subject();
        this.registry = this.viewModelContext.injector.get(ListenerRegistry, null);
        this.regist();
    }
    Object.defineProperty(Listeners.prototype, "onEvent", {
        get: function () {
            return this.subject;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 注册Listender
     */
    Listeners.prototype.regist = function () {
        var _this = this;
        var listeners = this.registry && this.registry.listeners || [];
        if (listeners && listeners.length > 0) {
            listeners.forEach(function (listener) {
                listener.onEvent.subscribe(function (modification) {
                    _this.subject.next(modification);
                });
            });
        }
    };
    return Listeners;
}());

/**
 * 事件监听器主要有以下几种类型的事件：
 * 1、值变化
 * 2、行切换
 *    行切换使用场景为需要为数据计算依赖当前行时
 * 3、数据加载
 */
var ExpressionEventEmitter = /** @class */ (function () {
    function ExpressionEventEmitter(viewModelContext) {
        var _this = this;
        this.viewModelContext = viewModelContext;
        this.listeners = this.viewModelContext.injector.get(Listeners);
        this.events = new Array();
        this.listeners.onEvent.subscribe(function (eventArgs) {
            if (_this.onEvent && _this.onEvent.observers.length > 0) {
                var events = [];
                if (_this.events.length > 0) {
                    events = __spread(_this.events);
                }
                events.push(eventArgs);
                _this.onEvent.next(events);
                _this.events = [];
            }
            else {
                _this.events.push(eventArgs);
            }
        });
    }
    ExpressionEventEmitter.prototype.attach = function () {
        if (!this.onEvent) {
            this.onEvent = new BehaviorSubject(this.events);
        }
        return this.onEvent.asObservable();
    };
    return ExpressionEventEmitter;
}());

var TranslateToken = createInjectionToken('@farris/devkit TranslateToken');

var FORM_MANIFEST_SERVICE_TOKEN = new InjectionToken('@farris/form_manifest_service');
var FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN = new InjectionToken('@farris/form_expression_manifest_service');

var ExpressionRegistry = /** @class */ (function () {
    function ExpressionRegistry(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this._expressions = null;
        this.injector = this.viewModelContext.injector;
        this.formExpressionManifestService = this.injector.get(FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN, null);
        this.translate = this.injector.get(TranslateToken, null);
    }
    /**
     * 加载表达式文件
     */
    ExpressionRegistry.prototype.load = function () {
        var _this = this;
        return this.formExpressionManifestService.load().pipe(switchMap(function (describe) {
            var expressions = _this.setExpressions(describe);
            _this.cleanSpecialCharacters();
            return of(expressions);
        }), catchError(function (e) {
            return of([]);
        }));
    };
    ExpressionRegistry.prototype.setExpressions = function (describe) {
        var _this = this;
        var expressions = [];
        var exprs = Array.from(describe);
        var appContext = this.viewModelContext.injector.get(AppContext);
        exprs.forEach(function (expr) {
            expr.expressions.forEach(function (expression) {
                var _a, _b;
                var expressionObject = {
                    id: expression.id,
                    ns: expr.ns,
                    viewModelId: expr.viewModelId,
                    path: expr.path,
                    bindingType: expr.type,
                    type: expression.type,
                    expression: expression.value || expression.expr || '',
                    message: expression.message || null,
                    messageType: expression.messageType || null,
                    deps: []
                };
                if (expression.type === Expression.ExpressionType.Required) {
                    var b = { type: "requiredExpression", constraints: [expression.id], message: expression.message };
                    appContext.validationManager[expr.path] = __assign({}, (appContext.validationManager[expr.path] || {}), (_a = {}, _a[expression.id] = b, _a));
                }
                if (expression.type === Expression.ExpressionType.Validate) {
                    var b = { type: "expression", constraints: [expression.id], message: expression.message };
                    appContext.validationManager[expr.path] = __assign({}, (appContext.validationManager[expr.path] || {}), (_b = {}, _b[expression.id] = b, _b));
                }
                if ((expression.type === Expression.ExpressionType.Required || expression.type === Expression.ExpressionType.Validate)) {
                    if (!expression.message) {
                        expressionObject.message = _this.getExpressionMessage(expression.type);
                    }
                    if (!expression.messageType) {
                        expressionObject.messageType = 'error';
                    }
                }
                if (expressionObject.message) {
                    _this.transform(expressionObject);
                }
                expressions.push(expressionObject);
            });
        });
        this._expressions = expressions;
        return expressions;
    };
    Object.defineProperty(ExpressionRegistry.prototype, "expressions", {
        /**
         * 获取所有表达式
         */
        get: function () {
            if (this._expressions) {
                return of(this._expressions);
            }
            // 短路，实现功能
            if (window['__expressions__']) {
                this.setExpressions(window['__expressions__']);
                return of(this._expressions);
            }
            return this.load();
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 根据表达式id获取对应的表达式对象
     * @param id 表达式id
     * @returns
     */
    ExpressionRegistry.prototype.getExpressionById = function (id) {
        if (!this._expressions || this._expressions.length < 1) {
            return null;
        }
        return this._expressions.find(function (expressionObject) { return expressionObject.id === id; });
    };
    ExpressionRegistry.prototype.getExpressionMessage = function (expressionType, defaultValue) {
        if (!(expressionType === Expression.ExpressionType.Validate || expressionType === Expression.ExpressionType.Required)) {
            return null;
        }
        if (!this.translate) {
            return defaultValue;
        }
        var currentLanguage = this.translate.getCurrentLanguage() || 'zh-CHS';
        return Expression.MESSAGE[currentLanguage][expressionType];
    };
    ExpressionRegistry.prototype.transform = function (expressionObject) {
        if (!this.translate) {
            return;
        }
        if (expressionObject.message && expressionObject.message.startsWith('{{') && expressionObject.message.endsWith('}}')) {
            expressionObject.message = this.translate.transform(expressionObject.message.substr(2, expressionObject.message.length - 4), null) || this.getExpressionMessage(expressionObject.type);
        }
    };
    ExpressionRegistry.prototype.cleanSpecialCharacters = function () {
        var _this = this;
        if (!this._expressions || this._expressions.length < 1 || !Array.isArray(this._expressions)) {
            return;
        }
        var repository = this.viewModelContext.repository;
        if (!repository) {
            return;
        }
        var entityTypeInfo = repository.entityTypeInfo;
        var regex = new RegExp("[\\'\\\"]?\\s*(" + entityTypeInfo.entityInfo.nodeCode + "|" + entityTypeInfo.entityInfo.originalCode + ")[\\.\\[\\]a-zA-Z0-9_]+\\s*[\\'\\\"]?", 'g');
        this._expressions.forEach(function (expressionObject) {
            var expr = expressionObject.expression;
            var entityPropertyExpressions = expr.match(regex);
            if (Array.isArray(entityPropertyExpressions) && entityPropertyExpressions.length > 0) {
                // 解析出所有实体相关的字符串，以主实体名字开头，包含主实体属性或子表
                entityPropertyExpressions.forEach(function (item) {
                    if (item.indexOf('.') === -1) {
                        console.warn("\u65E0\u6548\u7684\u5B9E\u4F53\u8868\u8FBE\u5F0F:" + item);
                        return;
                    }
                    // 去数组
                    if (/\[\d\]/g.test(item)) {
                        var replacer = item.replace(/\[\d\]/g, '');
                        expressionObject.expression = _this.replaceAll(expressionObject.expression, item, replacer);
                    }
                    // 去星号
                    if (/\*/g.test(item)) {
                        var replacer = item.replace(/\*/g, '');
                        expressionObject.expression = _this.replaceAll(expressionObject.expression, item, replacer);
                    }
                });
            }
        });
    };
    ExpressionRegistry.prototype.replaceAll = function (originalValue, search, replacer) {
        return originalValue.split(search).join(replacer);
    };
    return ExpressionRegistry;
}());

var ExpressionExecutor = /** @class */ (function () {
    function ExpressionExecutor() {
    }
    /**
     * 编译执行
     * @param expression
     * @param context
     * @returns
     */
    ExpressionExecutor.prototype.compile = function (expressionObject, context) {
        if (Object.prototype.toString.call(context) !== '[object Object]') {
            throw new Error('上下文必须为对象！');
        }
        var expressionContext = this.buildContext(context);
        if (!expressionObject.factory) {
            var expression_1 = new Expression$1(expressionObject.expression, expressionContext);
            expressionObject.factory = expression_1.compile();
        }
        var expression = expressionObject.factory;
        return expression.eval(expressionContext);
    };
    /**
     * 解析
     * @param expression
     * @param context
     * @returns
     */
    ExpressionExecutor.prototype.eval = function (expression, context) {
        if (Object.prototype.toString.call(context) !== '[object Object]') {
            throw new Error('上下文必须为对象！');
        }
        var expressionContext = this.buildContext(context);
        var expressionEngine = new ExpressionEngine(expressionContext);
        return expressionEngine.eval(expression);
    };
    /**
     * 构造表达式上下文
     * @param context
     * @returns
     */
    ExpressionExecutor.prototype.buildContext = function (context) {
        var expressionContext = new ExpressionContext();
        if (context && Object.keys(context).length > 0) {
            Object.keys(context).forEach(function (key) {
                expressionContext.set(key, context[key]);
            });
        }
        return expressionContext;
    };
    return ExpressionExecutor;
}());

var EventHandler = /** @class */ (function () {
    function EventHandler(frameContext) {
        this.frameContext = frameContext;
        this.injector = frameContext.injector;
        this.repository = frameContext.repository;
        this.bindingData = frameContext.bindingData;
        this.expressionRegistry = this.injector.get(ExpressionRegistry, null);
        this.effectorFactory = this.injector.get(EffectorFactory, null);
        this.expressionExecutor = this.injector.get(ExpressionExecutor);
        this.expressionResult = this.injector.get(ExpressionResult, null);
    }
    EventHandler.prototype.handleEvent = function (event, expressionObjects) {
        event = Object.assign({}, event);
        this.expressionObjects = expressionObjects;
        this.dispatch(event);
    };
    Object.defineProperty(EventHandler.prototype, "primaryValue", {
        //#endregion
        //#region 属性
        /**
         * 主表主键值
         */
        get: function () {
            return this.bindingData.list.currentItem.primaryKeyValue;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EventHandler.prototype, "entityOriginalNodeCode", {
        /**
         * 获取主实体原始字段名
         */
        get: function () {
            return this.repository && this.repository.entityTypeInfo && this.repository.entityTypeInfo.entityInfo && this.repository.entityTypeInfo.entityInfo.originalCode || null;
        },
        enumerable: true,
        configurable: true
    });
    //#endregion
    //#region 表达式核心
    /**
     * 执行表达式计算
     * @param expression 表达式
     * @param context 上下文
     * @returns any
     */
    EventHandler.prototype.perform = function (expressionObject, context) {
        return this.expressionExecutor.compile(expressionObject, context);
    };
    /**
     * 副作用
     * @param event event
     * @param expressionObject expressionObject
     */
    EventHandler.prototype.effect = function (event, expressionObject) {
        var effectTo = expressionObject.bindingType;
        var effector = this.effectorFactory.getEffector(expressionObject);
        if (!effector) {
            // console.warn(`EventHandler 没有对应的副作用器。${expressionObject.type}`);
            return;
        }
        if (effectTo === Expression.ExpressionBindingType.Field) {
            var effectPaths = expressionObject.effectPaths || [];
            if (effectPaths.length > 0) {
                effectPaths.forEach(function (path) {
                    var effectPath = path.split('/');
                    var effectOptions = { path: effectPath, message: expressionObject.message, expressionId: expressionObject.id, eventType: event.type, viewModelId: expressionObject.viewModelId };
                    effector.effect(expressionObject.path, expressionObject.result, effectOptions);
                });
            }
            else if (expressionObject.type === Expression.ExpressionType.Required || expressionObject.type === Expression.ExpressionType.Validate || expressionObject.type === Expression.ExpressionType.Readonly || expressionObject.type === Expression.ExpressionType.Visible) {
                var effectOptions = { message: expressionObject.message, expressionId: expressionObject.id, eventType: event.type, viewModelId: expressionObject.viewModelId };
                effector.effect(expressionObject.path, expressionObject.result, effectOptions);
            }
        }
        else {
            throw new Error('not supported！');
        }
    };
    //#endregion
    //#region util
    EventHandler.prototype.isValidateOrRequiredExpression = function (expressionObject) {
        return expressionObject && (expressionObject.type === Expression.ExpressionType.Validate || expressionObject.type === Expression.ExpressionType.Required);
    };
    /**
     * 以事件参数为依据构建实体路径
     * @param event event
     * @returns
     */
    EventHandler.prototype.getEntityPathFromEvent = function (event) {
        event = JSON.parse(JSON.stringify(event));
        if (!event || !event.path || event.path.length < 1) {
            return [];
        }
        var paths = event.path;
        return this.getEntityPath(paths);
    };
    /**
     * 获取事件路径中的实体路径
     * @param path path
     * @returns
     */
    EventHandler.prototype.getEntityPath = function (path) {
        var paths = path.filter(function (value, index) {
            if (index % 2 === 0 && value.includes(':')) {
                return false;
            }
            else {
                return true;
            }
        });
        return paths;
    };
    /**
     * 构造实体路径
     * @param path path
     * @description 删除路径中的id字段
     * @returns
     */
    EventHandler.prototype.buildEntityPath = function (path) {
        var paths = path.filter(function (value, index) {
            if (index % 2 === 0 && value.includes(':')) {
                return false;
            }
            else {
                return true;
            }
        });
        return paths;
    };
    /**
     * 清理事件路径中的id主键标识
     * @param path path
     * @returns
     */
    EventHandler.prototype.cleanEventPath = function (path) {
        path = path.filter(function (p) {
            if (p && p !== ':') {
                return true;
            }
            else {
                return false;
            }
        });
        return path.map(function (item) {
            if (item.includes(':')) {
                return item.split(':')[1];
            }
            else {
                return item;
            }
        });
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    EventHandler.prototype.getCurrentRowByPaths = function (paths) {
        var result = null;
        var bindingList = this.bindingData.getValue(paths);
        if (bindingList && bindingList.length > 0) {
            var primaryValue = bindingList.currentItem.primaryKeyValue || null;
            if (primaryValue) {
                var bindingObject = bindingList.findById(primaryValue);
                if (bindingObject) {
                    result = bindingObject.toJSON();
                }
            }
        }
        return result;
    };
    /**
     * 获取事件路径中指定子表的事件行
     * @param path
     * @param tableCode
     * @returns
     */
    EventHandler.prototype.getEventId = function (path, tableCode) {
        if (!path || path.length < 1) {
            throw new Error('invalid path!');
        }
        var propertyIndex = path.findIndex(function (p) { return p === tableCode; });
        if (propertyIndex === -1) {
            return null;
        }
        var idIndex = propertyIndex + 1;
        if (idIndex > path.length - 1) {
            throw new Error('invalid propertyName or path');
        }
        var id = path[idIndex];
        if (id.indexOf(':') === -1) {
            throw new Error('compute error.');
        }
        return id.split(':')[1];
    };
    //#endregion
    //#region  构造上下文
    /**
     * 构造变量上下文
     * @param event
     * @returns
     */
    EventHandler.prototype.buildStateContext = function (event) {
        var ns = event.ns;
        var appContext = this.injector.get(AppContext, null);
        var frameContexts = appContext.viewModelContextManager.getContextsByNamespace(ns);
        var result = {};
        if (frameContexts && frameContexts.length > 0) {
            var anonymousFrameContext = frameContexts[0];
            var rootFrameContext = anonymousFrameContext.getVirtualRootFrameContext();
            if (rootFrameContext) {
                var uiState_1 = rootFrameContext.viewModel.uiState;
                var propertyNames = Object.getOwnPropertyNames(uiState_1) || [];
                propertyNames.forEach(function (prop) {
                    if (prop.match(/^[a-zA-Z0-9_\$]+$/g) !== null) {
                        result[prop] = uiState_1[prop];
                    }
                });
            }
        }
        return result;
    };
    /**
     * 获取事件实体
     * @param event
     * @returns
     */
    EventHandler.prototype.buildEntityContext = function (event, expressionObject, currentRows) {
        var _this = this;
        var expressionBindingType = expressionObject.bindingType;
        if (expressionBindingType === Expression.ExpressionBindingType.Field) {
            var entityTypeInfo = this.repository.entityTypeInfo;
            var childrenEntityPaths = [];
            ExpressionUtil.getChildrenEntityPaths(entityTypeInfo, childrenEntityPaths);
            // 获取当前行
            var row = currentRows && currentRows.find(function (row) { return row.bindingPath === '' || row.bindingPath === '/'; }) || null;
            var primaryValue = row && row.primaryValue || this.bindingData.list.currentId;
            var entity = this.bindingData.list.findById(primaryValue);
            if (!entity) {
                return null;
            }
            var object_1 = entity.toJSON();
            object_1['__type__'] = 'Entity';
            if (!childrenEntityPaths || childrenEntityPaths.length < 1) {
                return object_1;
            }
            childrenEntityPaths.sort(function (v1, v2) { return v1.length - v2.length; });
            // 找到所有子表
            childrenEntityPaths.forEach(function (paths) {
                var bindingList = _this.bindingData.getValue(paths);
                var currentRowId = bindingList.currentId;
                var propertyName = paths[paths.length - 1];
                // parent 为entity或entitylist或null
                var parent = paths.slice(0, paths.length - 1).reduce(function (object, path) {
                    return object && object[path] || null;
                }, object_1);
                if (!parent) {
                    return;
                }
                var data = parent;
                var node = null;
                if (!currentRowId) {
                    // 当前表没有数据
                    node = { __items__: [], __type__: 'List' };
                    node.length = function () { return node.__items__.length; };
                }
                else {
                    // 纠正当前行
                    if (currentRows && currentRows.length > 0) {
                        // 是否指定了当前行
                        var userAssignCurrentRow = currentRows.find(function (row) {
                            var bindingPaths = row.bindingPath.split('/').filter(function (p) { return p; });
                            return bindingPaths.join('/') === paths.join('/');
                        });
                        if (userAssignCurrentRow) {
                            currentRowId = userAssignCurrentRow.primaryValue;
                        }
                    }
                    // 子表当前行
                    var row_1 = bindingList.findById(currentRowId);
                    // 找到子表当前行的上级
                    var list = parent[propertyName];
                    node = __assign({ __items__: [] }, row_1 && row_1.toJSON() || {}, { __type__: 'List' });
                    node.length = function () { return node.__items__.length; };
                    if (list && Array.isArray(list)) {
                        node.__items__ = [].concat(list);
                    }
                }
                data[propertyName] = node;
            });
            return object_1;
        }
        else if (expressionBindingType === Expression.ExpressionBindingType.State) {
            // todo: 支持状态表达式
        }
        else {
            return null;
        }
    };
    /**
     * 构造表达式计算上下文
     * @param expressionObject 表达式
     * @param event 事件
     * @param entityContext 实体上下文
     * @param currentRows 当前行
     * @returns
     */
    EventHandler.prototype.buildContext = function (expressionObject, event, entityContext, currentRows) {
        var _a;
        var context = [];
        if (entityContext) {
            context.push(entityContext);
        }
        else {
            var entity_1 = this.buildEntityContext(event, expressionObject, currentRows);
            context.push(entity_1);
        }
        var stateContext = this.buildStateContext(event);
        var entityCode = this.entityOriginalNodeCode;
        var entity = null;
        if (context.length === 1) {
            entity = context.pop();
        }
        else {
            entity = context[0];
            if (!entity['__type__']) {
                entity['__type__'] = 'Entity';
            }
            entity['__items__'] = context;
        }
        return __assign((_a = {}, _a[entityCode] = entity, _a), stateContext, { frameContext: this.frameContext, bindingData: this.bindingData, repository: this.repository });
    };
    //#endregion
    /**
     * 构造副作用路径
     * @param event
     * @param expressionObject
     * @returns
     */
    EventHandler.prototype.buildEffectPath = function (event, expressionObject) {
        var expressionPaths = expressionObject.path.split('/').filter(function (p) { return p; });
        var primaryValue = event.path[0] && event.path[0].split(':')[1];
        if (!primaryValue) {
            throw new Error('Invalid event path!');
        }
        if (expressionPaths.length === 1) {
            // 主表简单字段
            return [primaryValue, expressionPaths.pop()];
        }
        else {
            var result = [primaryValue];
            for (var index = 0; index < expressionPaths.length; index++) {
                var propertyName = expressionPaths[index];
                result.push(propertyName);
                var currentPaths = expressionPaths.slice(0, index + 1);
                var propertyInfo = this.repository.entityTypeInfo.getPropInfoByPath(currentPaths);
                if (propertyInfo.group === 'List') {
                    var id = this.getEventId(event.path, propertyInfo.name) || null;
                    // 事件和表达式不是同一个表
                    if (!id) {
                        var bindingList = this.bindingData.getValue(currentPaths);
                        if (bindingList) {
                            id = bindingList.currentId;
                        }
                    }
                    result.push(id);
                }
            }
            return result;
        }
    };
    //#region 辅助方法
    EventHandler.prototype.getPathInfo = function (path) {
        var paths = path.split('/').filter(function (p) { return p; });
        // 获取最大实体层级，其余为属性（简单属性、udt、关联、关联嵌套关联）
        var entityPath = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(paths, this.repository.entityTypeInfo);
        var propertyName = paths.slice(entityPath.length).join('/');
        return { path: entityPath.join('/'), propertyName: propertyName, paths: entityPath, propertyNames: propertyName.split('/').filter(function (p) { return p; }) };
    };
    /**
     * get table paths from event paths
     * @param paths event paths
     * @returns
     */
    EventHandler.prototype.getTablePathsFromEventPaths = function (paths) {
        paths = this.getEntityPath(paths);
        var entityPaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(paths, this.repository.entityTypeInfo);
        return entityPaths;
    };
    /**
     * get property paths from event paths
     * @param paths event paths
     * @returns
     */
    EventHandler.prototype.getPropertyPathsFromEventPaths = function (paths) {
        paths = this.getEntityPath(paths);
        var tablePaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(paths, this.repository.entityTypeInfo);
        return paths.slice(tablePaths.length);
    };
    /**
     * 分析事件和表达式的关系
     */
    EventHandler.prototype.analysis = function (event, expressionObject) {
        var expressionPathInfo = this.getPathInfo(expressionObject.path);
        var eventPaths = this.getEntityPath(event.path.slice(0));
        var eventPathInfo = this.getPathInfo(eventPaths.join('/'));
        if (!expressionPathInfo || !eventPathInfo) {
            console.warn("\u8868\u8FBE\u5F0F\u8DEF\u5F84\u6216\u4E8B\u4EF6\u8DEF\u5F84\u9519\u8BEF\uFF0C\u83B7\u53D6\u8DEF\u5F84\u4FE1\u606F\u5931\u8D25\u3002");
            return null;
        }
        var expressionTablePaths = expressionPathInfo.path.split('/').filter(function (p) { return p; });
        var expressionPropertyNames = expressionPathInfo.propertyName.split('/').filter(function (p) { return p; });
        var eventTablePaths = eventPathInfo.path.split('/').filter(function (p) { return p; });
        var eventPropertyNames = eventPathInfo.propertyName.split('/').filter(function (p) { return p; });
        var result = {
            distance: undefined,
            eventFromChildren: undefined,
            eventFromParent: undefined,
            expressionTablePaths: expressionTablePaths,
            expressionPropertyNames: expressionPropertyNames,
            eventTablePaths: eventTablePaths,
            eventPropertyNames: eventPropertyNames,
            isSameTable: false
        };
        result.distance = Math.abs(expressionTablePaths.length - eventTablePaths.length);
        if (result.distance === 1) {
            result.eventFromChildren = eventTablePaths.length > expressionTablePaths.length && eventTablePaths.join('/').startsWith(expressionTablePaths.join('/'));
            result.eventFromParent = eventTablePaths.length < expressionTablePaths.length && expressionTablePaths.join('/').startsWith(eventTablePaths.join('/'));
        }
        result.isSameTable = expressionTablePaths.join('/') === eventTablePaths.join('/');
        return result;
    };
    EventHandler.prototype.buildCurrentRows = function (tablePaths, fullPaths) {
        var currentRows = new Array();
        if (!tablePaths || tablePaths.length < 1) {
            currentRows.push({
                bindingPath: '/',
                primaryValue: fullPaths[0]
            });
        }
        else {
            var paths_1 = [];
            tablePaths.forEach(function (path, index) {
                if (index === 0) {
                    currentRows.push({
                        bindingPath: '/',
                        primaryValue: fullPaths[0]
                    });
                }
                paths_1.push(path);
                var primaryValue = fullPaths[index * 2 + 2];
                currentRows.push({
                    bindingPath: paths_1.join('/'),
                    primaryValue: primaryValue
                });
            });
        }
        return currentRows;
    };
    return EventHandler;
}());

/**
 * 实体值变化处理器
 */
var EntityValueChangedEventHandler = /** @class */ (function (_super) {
    __extends(EntityValueChangedEventHandler, _super);
    function EntityValueChangedEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    /**
     * 获取相关表达式
     * @param event event
     */
    EntityValueChangedEventHandler.prototype.filter = function (event) {
        return null;
    };
    /**
     * 发布事件
     * @param event event
     */
    EntityValueChangedEventHandler.prototype.dispatch = function (event) {
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    EntityValueChangedEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        return this.getCurrentRowByPaths(paths);
    };
    return EntityValueChangedEventHandler;
}(EventHandler));

var EffectorManager = /** @class */ (function () {
    function EffectorManager() {
    }
    /**
     * 批量副作用
     * @param effector effector
     * @param expressionObject 表达式
     * @param paths 作用路径
     * @returns
     */
    EffectorManager.effect = function (effector, expressionObject, paths) {
        if (!paths || paths.length < 1) {
            return;
        }
        paths.forEach(function (path) {
            var effectOptions = { path: path, message: expressionObject.message, expressionId: expressionObject.id, viewModelId: expressionObject.viewModelId, eventType: expressionObject.eventType };
            effector.effect(expressionObject.path, expressionObject.result, effectOptions);
        });
    };
    return EffectorManager;
}());

var StateValueChangedEventHandler = /** @class */ (function (_super) {
    __extends(StateValueChangedEventHandler, _super);
    function StateValueChangedEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    /**
     * 获取相关表达式
     * @param event event
     */
    StateValueChangedEventHandler.prototype.filter = function (event) {
        var _this = this;
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            return this.expressionObjects.filter(function (expressionObject) {
                var deps = expressionObject.deps;
                if (!deps || deps.length < 1 || event.ns !== expressionObject.ns) {
                    return false;
                }
                var changePaths = _this.cleanEventPath(event.path);
                changePaths.splice(0, 0, STATE_TEMPLATE);
                var eventPath = changePaths.join('/');
                if (deps.includes(eventPath)) {
                    return true;
                }
                else {
                    return false;
                }
            });
        }
        return null;
    };
    /**
     * 发布事件
     * @param event event
     */
    StateValueChangedEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                // const entityContext = this.buildEntityContext(event, expressionObject);
                var context = _this.buildContext(expressionObject, event);
                var result = _this.perform(expressionObject, context);
                if (result === undefined && !_this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = result;
                if (expressionObject.id) {
                    _this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                _this.effect(event, expressionObject);
            });
        }
    };
    /**
     * 副作用
     * @param event event
     * @param expressionObject expressionObject
     */
    StateValueChangedEventHandler.prototype.effect = function (event, expressionObject) {
        var _this = this;
        var effector = this.effectorFactory.getEffector(expressionObject);
        var bindingType = expressionObject.bindingType;
        if (bindingType === Expression.ExpressionBindingType.State) {
            // 如果表达式作用于uistate
            effector.effect(expressionObject.path, expressionObject.result, { message: expressionObject.message, eventType: event.type, viewModelId: expressionObject.viewModelId });
        }
        else if (bindingType === Expression.ExpressionBindingType.Field) {
            // 表达式作用于实体属性
            var expressionPathInfo = this.getPathInfo(expressionObject.path);
            var bindingPaths = expressionPathInfo.paths;
            var entities = this.repository.entityCollection.getAllEntities();
            this.effectRows(entities, bindingPaths, expressionPathInfo.propertyNames, function (currentRows, paths) {
                _this.output(event, expressionObject, currentRows, effector, [paths]);
            });
        }
    };
    StateValueChangedEventHandler.prototype.output = function (event, expressionObject, currentRows, effector, paths) {
        var context = this.buildContext(expressionObject, event, null, currentRows);
        var value = this.perform(expressionObject, context);
        if (value === undefined) {
            return;
        }
        expressionObject.result = value;
        if (expressionObject.id) {
            this.expressionResult.set(expressionObject.id, expressionObject.result);
        }
        EffectorManager.effect(effector, expressionObject, paths);
    };
    StateValueChangedEventHandler.prototype.effectRows = function (entities, bindingPaths, propertyNames, callback, currentRows, prevPaths, paths) {
        var _this = this;
        if (currentRows === void 0) { currentRows = []; }
        if (prevPaths === void 0) { prevPaths = []; }
        if (paths === void 0) { paths = []; }
        if (!bindingPaths || bindingPaths.length < 1) {
            entities.forEach(function (entity) {
                if (!entity || !entity.primaryValue) {
                    return;
                }
                var currentPaths = paths.concat([entity.primaryValue]).concat(propertyNames);
                var currentCurrentRows = currentRows.concat([{ bindingPath: prevPaths.join('/') || '/', primaryValue: entity.primaryValue }]);
                callback(currentCurrentRows, currentPaths);
            });
            currentRows.length = 0;
            paths.length = 0;
        }
        else {
            var flag_1 = false;
            var nextPrevPaths_1 = prevPaths;
            entities.forEach(function (entity) {
                var prop = bindingPaths[0];
                var entityList = entity[prop];
                if (!entityList || entityList.count() < 1) {
                    return;
                }
                currentRows.push({ bindingPath: prevPaths.join('/') || '/', primaryValue: entity.primaryValue });
                paths.push(entity.primaryValue);
                paths.push(prop);
                if (flag_1 === false) {
                    flag_1 = true;
                    nextPrevPaths_1.push(prop);
                }
                var nextBindingPaths = bindingPaths.slice(1);
                _this.effectRows(entityList.items, nextBindingPaths, propertyNames, callback, currentRows, nextPrevPaths_1, paths);
            });
        }
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    StateValueChangedEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        return this.getCurrentRowByPaths(paths);
    };
    return StateValueChangedEventHandler;
}(EventHandler));

var RepositoryAddEntityEventHandler = /** @class */ (function (_super) {
    __extends(RepositoryAddEntityEventHandler, _super);
    function RepositoryAddEntityEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    /**
     * 获取相关表达式
     * @param event event
     * @description 不支持主表直接依赖子表属性的情况，只能聚合子表的字段
     */
    RepositoryAddEntityEventHandler.prototype.filter = function (event) {
        return null;
    };
    /**
     * 发布事件
     * @param event event
     */
    RepositoryAddEntityEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                var entityContext = _this.buildEntityContext(event, expressionObject);
                var context = _this.buildContext(expressionObject, event, entityContext);
                var result = _this.perform(expressionObject, context);
                if (result === undefined && !_this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = result;
                if (expressionObject.id) {
                    _this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                _this.effect(event, expressionObject);
            });
        }
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    RepositoryAddEntityEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        return this.getCurrentRowByPaths(paths);
    };
    return RepositoryAddEntityEventHandler;
}(EventHandler));

var RepositoryRemoveEntityEventHandler = /** @class */ (function (_super) {
    __extends(RepositoryRemoveEntityEventHandler, _super);
    function RepositoryRemoveEntityEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    /**
     * 获取相关表达式
     * @param event event
     */
    RepositoryRemoveEntityEventHandler.prototype.filter = function (event) {
        return null;
    };
    /**
     * 发布事件
     * @param event event
     */
    RepositoryRemoveEntityEventHandler.prototype.dispatch = function (event) {
    };
    return RepositoryRemoveEntityEventHandler;
}(EventHandler));

var RepositoryLoadEventHandler = /** @class */ (function (_super) {
    __extends(RepositoryLoadEventHandler, _super);
    function RepositoryLoadEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    RepositoryLoadEventHandler.prototype.filter = function (event) {
        return null;
    };
    /**
     * 发布事件
     * @param event event
     */
    RepositoryLoadEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                var entityContext = _this.buildEntityContext(event, expressionObject);
                var context = _this.buildContext(expressionObject, event, entityContext);
                var result = _this.perform(expressionObject, context);
                if (result === undefined && !_this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = result;
                if (expressionObject.id) {
                    _this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                else {
                    console.warn("EventHandler \u8868\u8FBE\u5F0F\u672A\u8BBE\u7F6E\u552F\u4E00\u6807\u8BC6\uFF0C\u65E0\u6CD5\u66F4\u65B0\u8868\u8FBE\u5F0F\u503C\u3002");
                }
                _this.effect(event, expressionObject);
            });
        }
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    RepositoryLoadEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        return this.getCurrentRowByPaths(paths);
    };
    return RepositoryLoadEventHandler;
}(EventHandler));

var EntityUpdateEventHandler = /** @class */ (function (_super) {
    __extends(EntityUpdateEventHandler, _super);
    function EntityUpdateEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    EntityUpdateEventHandler.prototype.filter = function (event) {
        var _this = this;
        return this.expressionObjects.filter(function (expressionObject) {
            // 重新加载实体时不计算计算表达式，只处理只读、必填等
            if (expressionObject.ns !== event.ns || !expressionObject.deps || expressionObject.deps.length === 0 || expressionObject.type === Expression.ExpressionType.Compute || expressionObject.type === Expression.ExpressionType.Dependency || expressionObject.type === Expression.ExpressionType.DataPicking) {
                return false;
            }
            var result = _this.analysis(event, expressionObject);
            if (!result) {
                return false;
            }
            // 必须是主表表达式
            if (result.expressionTablePaths.length !== 0) {
                return false;
            }
            var index = expressionObject.deps.findIndex(function (dep) {
                if (!dep.startsWith(ENTITY_TEMPLATE)) {
                    return false;
                }
                var deps = dep.split(Expression.DEPENDENCY_SPLITER).filter(function (p) { return p; }).slice(1);
                var depPathInfo = _this.getPathInfo(deps.join('/'));
                if (!depPathInfo) {
                    return false;
                }
                if (depPathInfo.paths.length !== 0) {
                    return false;
                }
                return true;
            });
            return index === -1 ? false : true;
        });
    };
    /**
     * 发布事件
     * @param event event
     */
    EntityUpdateEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                var entityContext = _this.buildEntityContext(event, expressionObject);
                var context = _this.buildContext(expressionObject, event, entityContext);
                var result = _this.perform(expressionObject, context);
                if (result === undefined && !_this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = result;
                if (expressionObject.id) {
                    _this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                else {
                    console.warn("EventHandler \u8868\u8FBE\u5F0F\u672A\u8BBE\u7F6E\u552F\u4E00\u6807\u8BC6\uFF0C\u65E0\u6CD5\u66F4\u65B0\u8868\u8FBE\u5F0F\u503C\u3002");
                }
                _this.effect(event, expressionObject);
            });
        }
    };
    EntityUpdateEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        var result = null;
        var bindingList = this.bindingData.getValue(paths);
        var eventEntityPath = this.getEntityPath(event.path);
        if (bindingList && bindingList.length > 0) {
            var primaryValue = bindingList.currentItem.primaryKeyValue || null;
            // 使用事件中的主键
            var childrenPaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(eventEntityPath, this.repository.entityTypeInfo);
            if (childrenPaths && childrenPaths.toString() === paths.toString()) {
                // 发生值变化的数据位于要获取当前行的子表中，此时事件行应该是发生值变化的数据id，而不是当前行id
                primaryValue = event.id || null;
                if (!primaryValue) {
                    primaryValue = this.getEventId(event.path, paths[paths.length - 1]);
                }
            }
            if (primaryValue) {
                var bindingObject = bindingList.findById(primaryValue);
                if (bindingObject) {
                    result = bindingObject.toJSON();
                }
            }
        }
        return result;
    };
    return EntityUpdateEventHandler;
}(EventHandler));

var BindingDataAppendObjectEventHandler = /** @class */ (function (_super) {
    __extends(BindingDataAppendObjectEventHandler, _super);
    function BindingDataAppendObjectEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    /**
     * 过滤出需要计算的表达式
     * @param event event
     * @returns
     */
    BindingDataAppendObjectEventHandler.prototype.filter = function (event) {
        var _this = this;
        // event.path like ["id:7dd77e50-ebed-4639-b483-d12004603640", "formEEUR1E1s"] or undefined or []
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            // const fullEventPath = event.path || [];
            // 找到聚合相关表达式(依赖新增表的表达式),聚合的前提是表达式path位于事件路径的上方
            // 给实体属性或vo变量设置了聚合相关的表达式，此时表达式依赖中路径到子表属性
            var groupExpressions = this.expressionObjects.filter(function (expressionObject) {
                if (expressionObject.ns !== event.ns || !expressionObject.deps || expressionObject.deps.length < 1) {
                    return false;
                }
                var eventTablePaths = _this.buildEntityPath(event.path);
                var info = _this.analysis(event, expressionObject);
                if (!info) {
                    return false;
                }
                // const eventEntityPath = this.buildEntityPath(event.path);
                // 主表新增
                if (eventTablePaths.length === 0) {
                    if (expressionObject.bindingType === Expression.ExpressionBindingType.Field) {
                        // 认为主表新增时不需要处理聚合函数
                        return false;
                    }
                }
                // 从表或从从表新增
                eventTablePaths.splice(0, 0, ENTITY_TEMPLATE);
                // eventEntityPath like ['ENTITY~','formEEUR1E1s'] // 从表新增
                // deps like ['ENTITY~/formEEUR1E1s/udt/udt_field','ENTITY~/formEEUR1E1s/ref/ref_udt/ref_udt_field']
                // 仅处理上级表达式
                if (info.eventTablePaths.length - 1 !== info.expressionTablePaths.length) {
                    return false;
                }
                // 不支持跨表
                if (!info.eventTablePaths.join(Expression.DEPENDENCY_SPLITER).startsWith(info.expressionTablePaths.join(Expression.DEPENDENCY_SPLITER))) {
                    return false;
                }
                var index = expressionObject.deps.findIndex(function (dep) {
                    // 依赖
                    if (!dep.startsWith(eventTablePaths.join(Expression.DEPENDENCY_SPLITER))) {
                        return false;
                    }
                    var deps = dep.split(Expression.DEPENDENCY_SPLITER).filter(function (p) { return p; }).slice(1);
                    var dependPathInfo = _this.getPathInfo(deps.join(Expression.DEPENDENCY_SPLITER));
                    if (dependPathInfo && dependPathInfo.paths.join(Expression.DEPENDENCY_SPLITER) === info.eventTablePaths.join(Expression.DEPENDENCY_SPLITER)) {
                        return true;
                    }
                    return false;
                });
                return index === -1 ? false : true;
            });
            var eventTablePaths_1 = this.buildEntityPath(event.path);
            // 事件表中表达式（事件表本身的表达式）
            var relativeExpressions = this.expressionObjects.filter(function (expressionObject) {
                // expressionObject.bindingType !== Expression.ExpressionBindingType.Field 暂不支持State表达式
                if (expressionObject.ns !== event.ns) {
                    return false;
                }
                var expressionPathInfo = _this.getPathInfo(expressionObject.path);
                // 过滤掉非当前表的表达式
                if (expressionPathInfo.paths.join(Expression.DEPENDENCY_SPLITER) !== eventTablePaths_1.join(Expression.DEPENDENCY_SPLITER)) {
                    return false;
                }
                // 没有依赖的表达式
                if (!expressionObject.deps || expressionObject.deps.length < 1) {
                    return true;
                }
                // 仅依赖State
                var onlyDependOnState = expressionObject.deps.every(function (dep) { return dep.startsWith(STATE_TEMPLATE); });
                // 仅依赖当前表或上级表
                // const onlyDependOnCurrentTable = expressionObject.deps.every((dep: string) => {
                //   if (!dep.startsWith(ENTITY_TEMPLATE)) {
                //     return false;
                //   }
                //   const deps = dep.split(Expression.DEPENDENCY_SPLITER).slice(1);
                //   const dependPathInfo = this.getPathInfo(deps.join(Expression.DEPENDENCY_SPLITER));
                //   return dependPathInfo.paths.join(Expression.DEPENDENCY_SPLITER) === eventTablePaths.join(Expression.DEPENDENCY_SPLITER) || eventTablePaths.join(Expression.DEPENDENCY_SPLITER).startsWith(dependPathInfo.paths.join(Expression.DEPENDENCY_SPLITER)) && dependPathInfo.paths.length + 1 == eventTablePaths.length;
                // });
                // if (onlyDependOnState || onlyDependOnCurrentTable) {
                //   return true;
                // }
                if (onlyDependOnState) {
                    return true;
                }
                var result = _this.analysis(event, expressionObject);
                if (result && result.distance === 0 && result.isSameTable) {
                    return true;
                }
                // 事件表表达式，但依赖下级表的未计算
                return false;
            });
            return groupExpressions.concat(relativeExpressions);
        }
        return null;
    };
    /**
     * 发布事件
     * @param event event
     */
    BindingDataAppendObjectEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                var entityContext = _this.buildEntityContext(event, expressionObject);
                var context = _this.buildContext(expressionObject, event, entityContext);
                var result = _this.perform(expressionObject, context);
                if (result === undefined && !_this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = result;
                if (expressionObject.id) {
                    _this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                else {
                    console.warn("EventHandler \u8868\u8FBE\u5F0F\u672A\u8BBE\u7F6E\u552F\u4E00\u6807\u8BC6\uFF0C\u65E0\u6CD5\u66F4\u65B0\u8868\u8FBE\u5F0F\u503C\u3002");
                }
                _this.effect(event, expressionObject);
            });
        }
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    BindingDataAppendObjectEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        return this.getCurrentRowByPaths(paths);
    };
    /**
     * 新增副作用器
     * @param event event
     * @param expressionObject 表达式
     * @returns
     */
    BindingDataAppendObjectEventHandler.prototype.effect = function (event, expressionObject) {
        var _this = this;
        var effectTo = expressionObject.bindingType;
        var eventPath = this.cleanEventPath(event.path);
        var effector = this.effectorFactory.getEffector(expressionObject);
        if (!effector) {
            return;
        }
        var info = this.analysis(event, expressionObject);
        if (!info) {
            console.warn("[BindingDataAppendObjectEventHandler][analysis]\u83B7\u53D6\u8DEF\u5F84\u4FE1\u606F\u5931\u8D25\u3002");
            return;
        }
        var expressionPaths = expressionObject.path.split('/').filter(function (p) { return p; });
        if (effectTo === Expression.ExpressionBindingType.Field) {
            var paths_1 = [];
            var propertyPaths_1 = expressionPaths.slice(info.expressionTablePaths.length);
            // 新增场景仅需要计算事件表及事件表上面的表
            if (info.distance === 0) {
                if (!info.isSameTable) {
                    return;
                }
                // 表达式和事件在同一个表
                var prevPaths_1 = eventPath.slice(0);
                if (eventPath.length === 1) {
                    // 主表新增，此时事件路径中有主键，直接拼接属性就是完整路径
                    if (event.value && Array.isArray(event.value)) {
                        event.value.forEach(function (bindingObject) {
                            paths_1.push([bindingObject.primaryKeyValue].concat(propertyPaths_1));
                        });
                    }
                    else {
                        var path = prevPaths_1.concat(propertyPaths_1);
                        paths_1.push(path);
                    }
                }
                else {
                    // 从表或从从表新增，此时事件路径中缺少最后一个层级的主键
                    if (event.value && Array.isArray(event.value)) {
                        event.value.forEach(function (bindingObject) {
                            paths_1.push(prevPaths_1.concat([bindingObject.primaryKeyValue]).concat(propertyPaths_1));
                        });
                    }
                    else {
                        var bindingList = this.bindingData.getValue(info.eventTablePaths);
                        if (bindingList && bindingList.currentId) {
                            paths_1.push(prevPaths_1.concat(bindingList.currentId).concat(propertyPaths_1));
                        }
                    }
                }
            }
            else {
                // 表达式和事件不在同一个表，即下级表新增或批量新增了一批数据
                if (info.eventFromParent === true) {
                    // 在过滤时这种情况的应该就排除掉了
                    console.warn("[BindingDataAppendObjectEventHandler][effect_error]");
                    return;
                }
                else if (info.eventFromChildren === true) {
                    var prevPaths = eventPath.slice(0, eventPath.length - 1);
                    var path = prevPaths.concat(propertyPaths_1);
                    paths_1.push(path);
                }
                else {
                    console.warn("[BindingDataAppendObjectEventHandler][effect_error]");
                    return;
                }
            }
            paths_1.forEach(function (path) {
                var currentRows = _this.buildCurrentRows(info.expressionTablePaths, path);
                _this.output(event, expressionObject, currentRows, effector, [path]);
            });
        }
        else if (effectTo === Expression.ExpressionBindingType.State) {
            console.error('not supported！');
        }
    };
    BindingDataAppendObjectEventHandler.prototype.output = function (event, expressionObject, currentRows, effector, paths) {
        var context = this.buildContext(expressionObject, event, null, currentRows);
        var value = this.perform(expressionObject, context);
        if (value === undefined) {
            return;
        }
        expressionObject.result = value;
        if (expressionObject.id) {
            this.expressionResult.set(expressionObject.id, expressionObject.result);
        }
        EffectorManager.effect(effector, __assign({ eventType: event.type }, expressionObject), paths);
    };
    return BindingDataAppendObjectEventHandler;
}(EventHandler));

var BindingDataValueChangeEventHandler = /** @class */ (function (_super) {
    __extends(BindingDataValueChangeEventHandler, _super);
    function BindingDataValueChangeEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    BindingDataValueChangeEventHandler.prototype.filter = function (event) {
        var _this = this;
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            return this.expressionObjects.filter(function (expressionObject) {
                var deps = expressionObject.deps;
                if (!deps || deps.length < 1 || event.ns !== expressionObject.ns) {
                    return false;
                }
                var eventEntityPaths = _this.getEntityPath(event.path);
                eventEntityPaths.splice(0, 0, ENTITY_TEMPLATE);
                return deps.includes(eventEntityPaths.join('/'));
            });
        }
        return null;
    };
    /**
     * 发布事件
     * @param event event
     */
    BindingDataValueChangeEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                _this.effect(event, expressionObject);
            });
        }
    };
    /**
     * 输出副作用
     * @param event event
     * @param expressionObject 表达式
     * @returns
     */
    BindingDataValueChangeEventHandler.prototype.effect = function (event, expressionObject) {
        var e_1, _a;
        // 首先计算当前表达式和事件会影响那些路径
        var effector = this.effectorFactory.getEffector(expressionObject);
        if (!effector) {
            return;
        }
        var result = this.analysis(event, expressionObject);
        if (!result) {
            return;
        }
        var eventPaths = this.cleanEventPath(event.path);
        var paths = [];
        if (result.distance === 0) {
            // 值变化之后影响到了一个表内字段或影响到了同级表字段
            if (result.isSameTable === false) {
                // 同级表跳过
                console.warn("[BindingDataValueChangeEventHandler]\u4E0D\u652F\u6301\u591A\u5BF9\u591A\u5173\u7CFB\u3002");
                return;
            }
            var prevPaths = eventPaths.slice(0, eventPaths.length - result.eventPropertyNames.length);
            var path = prevPaths.concat(result.expressionPropertyNames);
            var currentRows = this.buildCurrentRows(result.eventTablePaths, path);
            paths.push(path);
            this.output(event, expressionObject, currentRows, effector, paths);
        }
        else {
            if (result.eventFromChildren === true) {
                if (result.distance > 1) {
                    return;
                }
                // 下级表值变化影响到了上级表的表达式
                var prevPaths = eventPaths.slice(0, eventPaths.length - result.eventPropertyNames.length - 2);
                var path = prevPaths.concat(result.expressionPropertyNames);
                paths.push(path);
                var currentRows = this.buildCurrentRows(result.eventTablePaths, eventPaths);
                this.output(event, expressionObject, currentRows, effector, paths);
            }
            else if (result.eventFromParent === true) {
                if (result.distance > 1) {
                    console.warn("[BindingDataValueChangeEventHandler]\u4E0D\u652F\u6301\u591A\u5BF9\u591A\u5173\u7CFB\u3002");
                    return;
                }
                // 上级表值变化影响到了下级表的表达式
                var prevPaths = eventPaths.slice(0, eventPaths.length - result.eventPropertyNames.length);
                // 添加下级表nodecode到路径中
                prevPaths.push(result.expressionTablePaths.slice(0).pop());
                // 遍历子表
                var bindingPaths = result.expressionTablePaths;
                var primaryKeyValue = eventPaths[0];
                if (!primaryKeyValue) {
                    return;
                }
                var object = this.frameContext.repository.entityCollection.getEntityById(primaryKeyValue);
                // prevPaths like [1,c,1.1,cc]
                for (var index = 1; index < prevPaths.length; index++) {
                    var propertyName = prevPaths[index];
                    if (object instanceof EntityList) {
                        object = object.get(propertyName);
                    }
                    else {
                        object = object[propertyName];
                    }
                }
                var list = object;
                if (list && list instanceof EntityList && list.count() > 0) {
                    try {
                        for (var list_1 = __values(list), list_1_1 = list_1.next(); !list_1_1.done; list_1_1 = list_1.next()) {
                            var entity = list_1_1.value;
                            if (entity && entity.primaryValue) {
                                var path = prevPaths.concat([entity.primaryValue]).concat(result.expressionPropertyNames);
                                var currentRows = this.buildCurrentRows(result.expressionTablePaths, path);
                                this.output(event, expressionObject, currentRows, effector, [path]);
                            }
                        }
                    }
                    catch (e_1_1) { e_1 = { error: e_1_1 }; }
                    finally {
                        try {
                            if (list_1_1 && !list_1_1.done && (_a = list_1.return)) _a.call(list_1);
                        }
                        finally { if (e_1) throw e_1.error; }
                    }
                }
            }
            else {
                // 跨表
            }
        }
    };
    BindingDataValueChangeEventHandler.prototype.output = function (event, expressionObject, currentRows, effector, paths) {
        var context = this.buildContext(expressionObject, event, null, currentRows);
        var value = this.perform(expressionObject, context);
        if (value === undefined) {
            return;
        }
        expressionObject.result = value;
        if (expressionObject.id) {
            this.expressionResult.set(expressionObject.id, expressionObject.result);
        }
        EffectorManager.effect(effector, expressionObject, paths);
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    BindingDataValueChangeEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        event = JSON.parse(JSON.stringify(event));
        var result = null;
        var bindingList = this.bindingData.getValue(paths);
        var eventEntityPath = this.getEntityPath(event.path);
        if (bindingList && bindingList.length > 0) {
            var primaryValue = bindingList.currentItem.primaryKeyValue || null;
            // 使用事件中的主键
            var childrenPaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(eventEntityPath, this.repository.entityTypeInfo);
            if (childrenPaths && childrenPaths.toString() === paths.toString()) {
                // 发生值变化的数据位于要获取当前行的子表中，此时事件行应该是发生值变化的数据id，而不是当前行id
                primaryValue = event.id || null;
                if (!primaryValue) {
                    primaryValue = this.getEventId(event.path, paths[paths.length - 1]);
                }
            }
            if (primaryValue) {
                var bindingObject = bindingList.findById(primaryValue);
                if (bindingObject) {
                    result = bindingObject.toJSON();
                }
            }
        }
        return result;
    };
    return BindingDataValueChangeEventHandler;
}(EventHandler));

/**
 * 删除数据时需要计算的表达式
 * 1、依赖被删除数据表的上级表达式（不考虑同表内的聚合依赖）
 */
var BindingDataRemoveObjectEventHandler = /** @class */ (function (_super) {
    __extends(BindingDataRemoveObjectEventHandler, _super);
    function BindingDataRemoveObjectEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    /**
     * 过滤出需要计算的表达式
     * @param event event
     * @returns
     */
    BindingDataRemoveObjectEventHandler.prototype.filter = function (event) {
        var _this = this;
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            // 找到聚合相关表达式
            var expressions = this.expressionObjects.filter(function (expressionObject) {
                if (expressionObject.ns !== event.ns || !expressionObject.deps || expressionObject.deps.length < 1) {
                    return false;
                }
                var info = _this.analysis(event, expressionObject);
                if (!info) {
                    return false;
                }
                // event.path like [id:xxxx] or [id:xxxx,子表s]
                var eventTablePaths = _this.buildEntityPath(event.path);
                // 主表删除
                if (eventTablePaths.length === 0) {
                    if (expressionObject.bindingType === Expression.ExpressionBindingType.Field) {
                        return false;
                    }
                }
                // 从表或从从表删除
                eventTablePaths.splice(0, 0, ENTITY_TEMPLATE);
                // eventEntityPath like ['ENTITY~','formEEUR1E1s'] // 从表新增
                // deps like ['ENTITY~/formEEUR1E1s/udt/udt_field','ENTITY~/formEEUR1E1s/ref/ref_udt/ref_udt_field']
                // 仅处理上级表达式
                if (info.eventTablePaths.length - 1 !== info.expressionTablePaths.length) {
                    return false;
                }
                // 不支持跨表
                if (!info.eventTablePaths.join(Expression.DEPENDENCY_SPLITER).startsWith(info.expressionTablePaths.join(Expression.DEPENDENCY_SPLITER))) {
                    return false;
                }
                var index = expressionObject.deps.findIndex(function (dep) {
                    // 依赖
                    if (!dep.startsWith(eventTablePaths.join(Expression.DEPENDENCY_SPLITER))) {
                        return false;
                    }
                    var deps = dep.split(Expression.DEPENDENCY_SPLITER).filter(function (p) { return p; }).slice(1);
                    var dependPathInfo = _this.getPathInfo(deps.join(Expression.DEPENDENCY_SPLITER));
                    if (dependPathInfo && dependPathInfo.paths.join(Expression.DEPENDENCY_SPLITER) === info.eventTablePaths.join(Expression.DEPENDENCY_SPLITER)) {
                        return true;
                    }
                    return false;
                });
                return index === -1 ? false : true;
            });
            return expressions;
        }
    };
    /**
     * 发布事件
     * @param event event
     */
    BindingDataRemoveObjectEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                var entityContext = _this.buildEntityContext(event, expressionObject);
                var context = _this.buildContext(expressionObject, event, entityContext);
                var result = _this.perform(expressionObject, context);
                if (result === undefined && !_this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = result;
                if (expressionObject.id) {
                    _this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                _this.effect(event, expressionObject);
            });
        }
    };
    /**
     * 删除副作用器
     * @param event event
     * @param expressionObject 表达式
     * @returns
     */
    BindingDataRemoveObjectEventHandler.prototype.effect = function (event, expressionObject) {
        var effectTo = expressionObject.bindingType;
        var eventPath = this.cleanEventPath(event.path);
        var effector = this.effectorFactory.getEffector(expressionObject);
        if (!effector) {
            return;
        }
        var info = this.analysis(event, expressionObject);
        if (!info) {
            console.warn("[BindingDataRemoveObjectEventHandler][analysis]\u83B7\u53D6\u8DEF\u5F84\u4FE1\u606F\u5931\u8D25\u3002");
            return;
        }
        var expressionPaths = expressionObject.path.split('/').filter(function (p) { return p; });
        if (effectTo === Expression.ExpressionBindingType.Field) {
            var paths = [];
            var propertyPaths = expressionPaths.slice(info.expressionTablePaths.length);
            // 删除场景仅需要计算事件表上面的表
            if (info.distance !== 0) {
                // 表达式和事件不在同一个表，即下级表删除了一批数据
                if (info.eventFromParent === true) {
                    // 在过滤时这种情况的应该就排除掉了
                    console.warn("[BindingDataRemoveObjectEventHandler][effect_error]");
                    return;
                }
                else if (info.eventFromChildren === true) {
                    var prevPaths = eventPath.slice(0, eventPath.length - 1);
                    var path = prevPaths.concat(propertyPaths);
                    paths.push(path);
                }
                else {
                    console.warn("[BindingDataRemoveObjectEventHandler][effect_error]");
                    return;
                }
            }
            EffectorManager.effect(effector, expressionObject, paths);
        }
        else if (effectTo === Expression.ExpressionBindingType.State) {
            console.error('not supported！');
        }
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    BindingDataRemoveObjectEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        return this.getCurrentRowByPaths(paths);
    };
    return BindingDataRemoveObjectEventHandler;
}(EventHandler));

var BindingDataLoadEventHandler = /** @class */ (function (_super) {
    __extends(BindingDataLoadEventHandler, _super);
    function BindingDataLoadEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    BindingDataLoadEventHandler.prototype.filter = function (event) {
        var _this = this;
        // 过滤第一次空load
        if ((!event.path || event.path.length === 0) && event.value && Array.isArray(event.value) && event.value.length === 0) {
            return null;
        }
        // 数据加载完成后需要计算当前绑定路径下的只读、必填、校验表达式
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            var expressions = this.expressionObjects.filter(function (expressionObject) {
                if (expressionObject.ns !== event.ns || (expressionObject.type !== Expression.ExpressionType.Readonly && expressionObject.type !== Expression.ExpressionType.Visible && expressionObject.type !== Expression.ExpressionType.Required && expressionObject.type !== Expression.ExpressionType.Validate)) {
                    return false;
                }
                var result = _this.analysis(event, expressionObject);
                if (!result) {
                    return false;
                }
                return result.distance === 0 && result.isSameTable;
            });
            return expressions;
        }
        else {
            return null;
        }
    };
    /**
     * 发布事件
     * @param event event
     */
    BindingDataLoadEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                var entityContext = _this.buildEntityContext(event, expressionObject);
                var context = _this.buildContext(expressionObject, event, entityContext);
                var result = _this.perform(expressionObject, context);
                if (result === undefined && !_this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = result;
                if (expressionObject.id) {
                    _this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                _this.effect(event, expressionObject);
            });
        }
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    BindingDataLoadEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        return this.getCurrentRowByPaths(paths);
    };
    return BindingDataLoadEventHandler;
}(EventHandler));

var BindingDataSelectionChangedEventHandler = /** @class */ (function (_super) {
    __extends(BindingDataSelectionChangedEventHandler, _super);
    function BindingDataSelectionChangedEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    /**
     * 过滤出需要计算的表达式
     * @param event event
     * @returns
     */
    BindingDataSelectionChangedEventHandler.prototype.filter = function (event) {
        var _this = this;
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            return this.expressionObjects.filter(function (expressionObject) {
                var deps = expressionObject.deps;
                // 没有依赖的表达式不需要关注
                if (!deps || deps.length < 1) {
                    return false;
                }
                // 不依赖实体的表达式不需要关注
                var index = deps.findIndex(function (dep) { return dep.startsWith(ENTITY_TEMPLATE); });
                if (index === -1) {
                    return false;
                }
                var result = _this.analysis(event, expressionObject);
                if (!result) {
                    return false;
                }
                // 只关注从表行切换
                if (result.eventTablePaths.length !== 1) {
                    return false;
                }
                // 只关注从从表表达式
                if (result.expressionTablePaths.length !== 2) {
                    return false;
                }
                // 只关注事件直接下级的表达式，跨表的不需要关注
                if (!result.expressionTablePaths.join('/').startsWith(result.eventTablePaths.join('/'))) {
                    return false;
                }
                // 从从表表达式需要依赖上级表
                index = deps.findIndex(function (dep) { return dep.startsWith(ENTITY_TEMPLATE + "/" + result.eventTablePaths[0]); });
                if (index === -1) {
                    return false;
                }
                return true;
            });
        }
        return null;
    };
    BindingDataSelectionChangedEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                var entityContext = _this.buildEntityContext(event, expressionObject);
                var context = _this.buildContext(expressionObject, event, entityContext);
                var result = _this.perform(expressionObject, context);
                if (result === undefined && !_this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = result;
                if (expressionObject.id) {
                    _this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                _this.effect(event, expressionObject);
            });
        }
    };
    return BindingDataSelectionChangedEventHandler;
}(EventHandler));

/**
 * 表单模块路径
 */
var ASSIGNER_TOKEN = new InjectionToken('@Farris expression assigner');
var EVENT_HANDLER_TOKEN = new InjectionToken('@Farris_event_handler');

var EventHandlerRegistry = /** @class */ (function () {
    function EventHandlerRegistry(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.handlers = this.viewModelContext.injector.get(EVENT_HANDLER_TOKEN);
    }
    Object.defineProperty(EventHandlerRegistry.prototype, "entityValueChangedEventHandler", {
        /**
         * 实体值变化处理器
         */
        get: function () {
            return this.handlers && this.handlers.find(function (handler) { return handler instanceof EntityValueChangedEventHandler; });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EventHandlerRegistry.prototype, "stateValueChangedEventHandler", {
        /**
         * 状态值变化处理器
         */
        get: function () {
            return this.handlers && this.handlers.find(function (handler) { return handler instanceof StateValueChangedEventHandler; });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EventHandlerRegistry.prototype, "repositoryAddEntityEventHandler", {
        get: function () {
            return this.handlers && this.handlers.find(function (handler) { return handler instanceof RepositoryAddEntityEventHandler; });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EventHandlerRegistry.prototype, "repositoryRemoveEntityEventHandler", {
        get: function () {
            return this.handlers && this.handlers.find(function (handler) { return handler instanceof RepositoryRemoveEntityEventHandler; });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EventHandlerRegistry.prototype, "entityUpdateEventHandler", {
        get: function () {
            return this.handlers && this.handlers.find(function (handler) { return handler instanceof EntityUpdateEventHandler; });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EventHandlerRegistry.prototype, "repositoryLoadEventHandler", {
        get: function () {
            return this.handlers && this.handlers.find(function (handler) { return handler instanceof RepositoryLoadEventHandler; });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EventHandlerRegistry.prototype, "bindingDataAppendEntityEventHandler", {
        get: function () {
            return this.handlers && this.handlers.find(function (handler) { return handler instanceof BindingDataAppendObjectEventHandler; });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EventHandlerRegistry.prototype, "bindingDataValueChangeEventHandler", {
        get: function () {
            return this.handlers && this.handlers.find(function (handler) { return handler instanceof BindingDataValueChangeEventHandler; });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EventHandlerRegistry.prototype, "bindingDataRemoveObjectEventHandler", {
        get: function () {
            return this.handlers && this.handlers.find(function (handler) { return handler instanceof BindingDataRemoveObjectEventHandler; });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EventHandlerRegistry.prototype, "bindingDataLoadEventHandler", {
        get: function () {
            return this.handlers && this.handlers.find(function (handler) { return handler instanceof BindingDataLoadEventHandler; });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EventHandlerRegistry.prototype, "bindingDataSelectionChangedHandler", {
        get: function () {
            return this.handlers && this.handlers.find(function (handler) { return handler instanceof BindingDataSelectionChangedEventHandler; });
        },
        enumerable: true,
        configurable: true
    });
    return EventHandlerRegistry;
}());

var ExpressionEngineImpl = /** @class */ (function () {
    function ExpressionEngineImpl(viewModelContext) {
        var _this = this;
        this.viewModelContext = viewModelContext;
        this.expressionObjects = new Array();
        this.injector = this.viewModelContext.injector;
        this.expressionRegistry = this.injector.get(ExpressionRegistry);
        this.expressionEventEmitter = this.injector.get(ExpressionEventEmitter);
        this.resolverRegistry = this.injector.get(ResolverRegistry);
        this.eventHandlerRegistry = this.injector.get(EventHandlerRegistry);
        this.resolveService = this.injector.get(ResolveService);
        this.expressionRegistry.expressions.subscribe(function (exprs) {
            if (exprs && exprs.length > 0) {
                _this.expressionObjects = exprs;
                // 解析表达式依赖
                _this.resolveDependency();
            }
            _this.attachEvent();
        });
    }
    ExpressionEngineImpl.prototype.attachEvent = function () {
        var _this = this;
        this.expressionEventEmitter.attach().subscribe(function (events) {
            if (!events || events.length < 1 || !_this.expressionObjects || _this.expressionObjects.length < 1) {
                return;
            }
            events.forEach(function (event) {
                var handler = _this.getEventHandler(event);
                if (handler) {
                    handler.handleEvent(event, _this.expressionObjects);
                }
                else {
                    Core.warn("\u6CA1\u6709\u5BF9\u5E94\u7684\u4E8B\u4EF6\u5904\u7406\u5668,event=" + event.type);
                }
            });
        });
    };
    /**
     * 解析表达式依赖
     * @returns
     */
    ExpressionEngineImpl.prototype.resolveDependency = function () {
        var _this = this;
        if (!this.resolverRegistry || !this.resolverRegistry.resolvers || this.resolverRegistry.resolvers.length < 1 || !this.expressionObjects || this.expressionObjects.length < 1 || !Array.isArray(this.expressionObjects)) {
            return;
        }
        this.expressionObjects.forEach(function (expressionObject) {
            var expression = expressionObject.expression;
            var dependencies = _this.resolveService.resolve(expression);
            expressionObject.deps = dependencies;
        });
    };
    /**
     * 获取表达式事件处理器
     * @param event event
     * @returns
     */
    ExpressionEngineImpl.prototype.getEventHandler = function (event) {
        if (event.type === Expression.EventType.ValueChanged) {
            // 实体值变化
            if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataValueChangeEventHandler;
            }
            else if (event.source === Expression.EventSource.Field) {
                return this.eventHandlerRegistry.entityValueChangedEventHandler;
            }
            else if (event.source === Expression.EventSource.State) {
                return this.eventHandlerRegistry.stateValueChangedEventHandler;
            }
        }
        else if (event.type === Expression.EventType.Append) {
            if (event.source === Expression.EventSource.Repository || event.source === Expression.EventSource.Field) {
                return this.eventHandlerRegistry.repositoryAddEntityEventHandler;
            }
            else if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataAppendEntityEventHandler;
            }
        }
        else if (event.type === Expression.EventType.Remove) {
            if (event.source === Expression.EventSource.Repository || event.source === Expression.EventSource.Field) {
                return this.eventHandlerRegistry.repositoryRemoveEntityEventHandler;
            }
            else if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataRemoveObjectEventHandler;
            }
        }
        else if (event.type === Expression.EventType.Update) {
            if (event.source === Expression.EventSource.Repository) {
                return this.eventHandlerRegistry.entityUpdateEventHandler;
            }
        }
        else if (event.type === Expression.EventType.Load) {
            if (event.source === Expression.EventSource.Repository || event.source === Expression.EventSource.Field) {
                return this.eventHandlerRegistry.repositoryLoadEventHandler;
            }
            else if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataLoadEventHandler;
            }
        }
        else if (event.type === Expression.EventType.SelectionChanged) {
            if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataSelectionChangedHandler;
            }
        }
        return null;
    };
    return ExpressionEngineImpl;
}());

/**
 * 表达式计算结果
 */
var ExpressionResult = /** @class */ (function () {
    function ExpressionResult(viewModelContext) {
        this.viewModelContext = viewModelContext;
    }
    /**
     * 更新表达式的值
     * @param expressionId 表达式id
     * @param result
     */
    ExpressionResult.prototype.set = function (expressionId, result) {
        this[expressionId] = result;
    };
    return ExpressionResult;
}());

var ExpressionManager = /** @class */ (function () {
    function ExpressionManager(frameContext) {
        this.frameContext = frameContext;
        this.injector = this.frameContext.injector;
        this.resolveService = this.injector.get(ResolveService);
        this.expressionExecutor = this.injector.get(ExpressionExecutor);
        this.expressionRegistry = this.injector.get(ExpressionRegistry);
        this.expressionResult = this.injector.get(ExpressionResult);
        this.messageService = this.injector.get(MESSAGE_SERVICE_TOKEN, null);
        this.notifyService = this.injector.get(NOTIFY_SERVICE_TOKEN, null);
    }
    /**
     * 根据表达式id进行计算
     * @param expressionId 表达式id
     * @param viewModel viewModel
     * @param rowData rowData
     * @returns
     */
    ExpressionManager.prototype.eval = function (expressionId, viewModel, rowData) {
        var expressionObject = this.expressionRegistry.getExpressionById(expressionId);
        if (expressionObject) {
            var customContext = {};
            var bindingPath = viewModel && viewModel.bindingPath || null;
            if (bindingPath && rowData) {
                var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
                var bindingList = this.frameContext.bindingData.getValue(bindingPaths);
                var primaryKey = 'id';
                if (bindingList) {
                    primaryKey = bindingList.primaryKey;
                }
                var primaryValue = rowData[primaryKey];
                if (primaryValue) {
                    customContext.currentRows = [{ bindingPath: bindingPaths.join('/'), primaryValue: primaryValue }];
                }
            }
            var result = this.execute(expressionObject.expression, customContext);
            this.expressionResult.set(expressionId, result);
            return result;
        }
        else {
            // console.warn('ExpressionManager 执行失败，未获取到表达式!');
        }
        return undefined;
    };
    ExpressionManager.prototype.validate = function (expressionId, options) {
        var expressionObject = this.expressionRegistry.getExpressionById(expressionId);
        if (expressionObject) {
            var patch = options && options.patch || null;
            var customContext = {};
            if (patch) {
                customContext.patch = patch;
            }
            var currentRow = options.currentRow || null;
            if (currentRow) {
                customContext.currentRows = customContext.currentRows || [];
                customContext.currentRows.push(currentRow);
            }
            var result = this.execute(expressionObject.expression, customContext);
            this.expressionResult.set(expressionId, result);
            return result;
        }
        else {
            console.warn('ExpressionManager 执行失败，未获取到表达式!');
        }
        return undefined;
    };
    /**
     * 帮助前封装
     * @param event
     */
    ExpressionManager.prototype.onDataPicking = function (configs) {
        var expressionId = configs && configs.expressionId || null;
        if (!expressionId) {
            console.warn("ExpressionManager \u76F8\u5173\u8868\u8FBE\u5F0F\u8BBE\u7F6E\u9519\u8BEF\uFF0C\u6CA1\u6709\u8868\u8FBE\u5F0F\u7F16\u53F7\u3002");
            return of(true);
        }
        var result = this.eval(expressionId);
        if (!result) {
            var expressionObject = this.expressionRegistry.getExpressionById(expressionId);
            if (!expressionObject) {
                console.warn("ExpressionManager \u65E0\u6CD5\u627E\u5230\u5BF9\u5E94\u7684\u8868\u8FBE\u5F0F" + expressionId);
                return of(true);
            }
            var messageType = expressionObject.messageType || Expression.MessageType.warning;
            var message = expressionObject.message;
            if (message) {
                this.notifyService[messageType](message, { hideTitle: true });
            }
            return EMPTY$1;
        }
        return of(result);
    };
    /**
     * 执行表达式计算
     * @param expression 表达式
     * @param customContext 自定义上下文
     * @returns
     */
    ExpressionManager.prototype.execute = function (expression, customContext) {
        var _a;
        var deps = this.resolveService.resolve(expression);
        var groupDependencies = ExpressionUtil.getGroupFunctionDependency(expression, this.frameContext.repository.entityTypeInfo);
        var entityContext = this.buildEntityContext(deps, groupDependencies, customContext);
        var stateContext = this.buildStateContext();
        var data = customContext && customContext.contexts || null;
        var context = __assign((_a = {}, _a[this.entityOriginalNodeCode] = entityContext, _a), stateContext, { frameContext: this.frameContext, bindingData: this.frameContext.bindingData, repository: this.frameContext.repository }, data);
        if (!entityContext) {
            return undefined;
        }
        return this.expressionExecutor.eval(expression, context);
    };
    /**
     * 执行表达式（返回可观察对象）
     * @param expression 表达式
     * @param customContext 自定义上下文
     * @returns
     */
    ExpressionManager.prototype.executeAsync = function (expression, customContext) {
        var result = this.execute(expression, customContext);
        return of(result);
    };
    /**
     * 构造实体上下文
     * @param deps
     * @param groupDependencies
     * @param context
     * @returns
     */
    ExpressionManager.prototype.buildEntityContext = function (deps, groupDependencies, context) {
        var _this = this;
        var currentRows = context && context.currentRows || null;
        var index = deps.findIndex(function (dep) {
            var isEntityDependency = _this.isEntityDependency(dep);
            // 如果依赖的是state，无需处理，现在需要确定的是返回多少实体的问题，和state没有关系
            // 表达式依赖了实体
            if (isEntityDependency) {
                var isGroupDependency = groupDependencies.findIndex(function (item) { return item === dep; }) !== -1;
                // 是聚合依赖
                if (isGroupDependency) {
                    var dependencyLength = dep.split('/').filter(function (p) { return p; }).length - 1;
                    if (dependencyLength === 1) {
                        // 聚合了主表字段，所有主表数据都需要参与运算，此时已经确定计算的实体上下文了。
                        return true;
                    }
                    else {
                        // 聚合了子表字段，只需要传递当前实体
                        return false;
                    }
                }
                else {
                    // 当前依赖不是聚合，只需要传递当前实体
                    return false;
                }
            }
            return false;
        });
        var isGroupdMainEntity = index !== -1;
        var options = {};
        if (currentRows && currentRows.length > 0) {
            currentRows.forEach(function (currentRow) {
                options[currentRow.bindingPath || '/'] = currentRow.primaryValue;
            });
        }
        var entity = this.getEntity(options);
        var patch = context && context.patch || null;
        if (!entity) {
            return null;
        }
        if (patch && Object.keys(patch).length > 0) {
            Object.keys(patch).forEach(function (key) {
                var paths = key.split('/').filter(function (p) { return p; });
                var value = patch[key];
                _this.setValue(entity, paths, value);
            });
        }
        if (isGroupdMainEntity) {
            var collection = this.frameContext.repository.entityCollection.toJSON();
            entity['__type__'] = 'List';
            entity['__items__'] = collection;
        }
        return entity;
    };
    ExpressionManager.prototype.setValue = function (target, paths, value) {
        if (paths.length === 1) {
            target[paths[0]] = value;
        }
        else {
            var propertyName = paths.pop();
            var result = paths.reduce(function (object, path) {
                return object && object[path];
            }, target);
            result[propertyName] = value;
        }
    };
    /**
     * 是否为实体依赖
     * @param dep
     * @returns
     */
    ExpressionManager.prototype.isEntityDependency = function (dep) {
        return dep.startsWith(ENTITY_TEMPLATE);
    };
    /**
     * 获取实体
     * @param options
     * @returns
     */
    ExpressionManager.prototype.getEntity = function (options) {
        var _this = this;
        var entityTypeInfo = this.frameContext.repository.entityTypeInfo;
        var bindingData = this.frameContext.bindingData;
        var childrenEntityPaths = [];
        var entity = null;
        if (options['/']) {
            // 修正主表
            entity = this.frameContext.bindingData.list.findById(options['/']);
            if (entity) {
                entity = entity.toJSON();
            }
        }
        else {
            entity = this.frameContext.bindingData.list.currentItem.toJSON();
        }
        if (!entity) {
            return null;
        }
        ExpressionUtil.getChildrenEntityPaths(entityTypeInfo, childrenEntityPaths);
        entity['__type__'] = 'Entity';
        if (!childrenEntityPaths || childrenEntityPaths.length < 1) {
            return entity;
        }
        // 找到所有子表
        childrenEntityPaths.forEach(function (paths) {
            var row = null;
            if (options && options[paths.join('/')]) {
                // 不应该使用bindingData，这样就默认使用了当前行
                var bindingList = bindingData.getValue(paths);
                var currentRowId = options[paths.join('/')];
                var currentRow = null;
                if (currentRowId !== bindingList.currentId) {
                    currentRow = bindingList.findById(currentRowId);
                }
                else {
                    currentRow = bindingList.currentItem;
                }
                if (currentRow && currentRow.primaryKeyValue) {
                    row = currentRow.toJSON();
                }
            }
            else {
                // 如果上级表已经切换了当前行，那么下级表也应该切换
                var parentTableCurrentRowChanged = options && !!Object.keys(options).find(function (path) {
                    var fullPath = path.split('/').join('/');
                    return paths.join('/').startsWith(fullPath);
                }) || false;
                if (parentTableCurrentRowChanged) {
                    var primaryValue = options && options['/'] || bindingData.list.currentId;
                    var entity_1 = _this.frameContext.repository.entityCollection.getEntityById(primaryValue);
                    var fullPaths_1 = [];
                    var data = paths.reduce(function (object, path) {
                        fullPaths_1.push(path);
                        var item = object && object[path];
                        if (item) {
                            var currentRowId = options && options[fullPaths_1.join('/')] || item.items[0] && item.items[0].primaryValue || null;
                            if (currentRowId) {
                                var currentRow = item.get(currentRowId);
                                return currentRow || null;
                            }
                        }
                        return null;
                    }, entity_1);
                    if (data) {
                        row = data.toJSON();
                    }
                    else {
                        row = {};
                    }
                }
                else {
                    row = ExpressionUtil.getCurrentRowByPaths(paths, bindingData);
                }
            }
            var propertyName = paths.pop();
            var parent = paths.reduce(function (object, path) {
                return object && object[path] || null;
            }, entity);
            var list = parent[propertyName];
            var node = __assign({ __items__: [] }, row && row || {}, { __type__: 'List' });
            node.length = function () { return node.__items__.length; };
            if (list && Array.isArray(list)) {
                node.__items__ = [].concat(list);
            }
            parent[propertyName] = node;
        });
        return entity;
    };
    Object.defineProperty(ExpressionManager.prototype, "entityOriginalNodeCode", {
        /**
         * 获取主实体原始字段名
         */
        get: function () {
            var repository = this.injector.get(Repository);
            return repository && repository.entityTypeInfo && repository.entityTypeInfo.entityInfo && repository.entityTypeInfo.entityInfo.originalCode || null;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 构造变量上下文
     * @param event
     * @returns
     */
    ExpressionManager.prototype.buildStateContext = function () {
        var result = {};
        if (this.frameContext) {
            var rootFrameContext = this.frameContext.getVirtualRootFrameContext();
            if (rootFrameContext) {
                var uiState_1 = rootFrameContext.viewModel.uiState;
                var propertyNames = Object.getOwnPropertyNames(uiState_1) || [];
                propertyNames.forEach(function (prop) {
                    if (prop.match(/^[a-zA-Z0-9_\$]+$/g) !== null) {
                        result[prop] = uiState_1[prop];
                    }
                });
            }
        }
        return result;
    };
    return ExpressionManager;
}());

;
var ExpressionResultFactory = /** @class */ (function () {
    function ExpressionResultFactory(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.injector = this.viewModelContext.injector;
        this.expressionRegistry = this.injector.get(ExpressionRegistry);
        this.expressionManager = this.injector.get(ExpressionManager);
        this.expressionResult = this.injector.get(ExpressionResult);
        this.registeEvent();
    }
    ExpressionResultFactory.prototype.registeEvent = function () {
        var _this = this;
        this.expressionRegistry.expressions.subscribe(function (expressionObjects) {
            // 加载完表达式之后做一次计算
            expressionObjects.forEach(function (expressionObject) {
                if (expressionObject.deps && expressionObject.deps.length > 0) {
                    return;
                }
                var result = _this.expressionManager.eval(expressionObject.id);
                _this.expressionResult[expressionObject.id] = result;
            });
        });
    };
    return ExpressionResultFactory;
}());

var EffectUtil = /** @class */ (function () {
    function EffectUtil() {
    }
    EffectUtil.getFormValueByPath = function (path, viewModel) {
        if (!viewModel)
            return null;
        if (!path)
            return null;
        if (!viewModel.bindingData)
            return null;
        // 主表
        if (viewModel.bindingData.bindingPath === '/') {
            return viewModel.form.getFormValueByBindPath(path);
        }
        // 子表
        if (viewModel.bindingData.bindingPath && viewModel.bindingData.bindingPath.length > 1) {
            var idnex = path.indexOf(viewModel.bindingData.bindingPath);
            if (idnex == 0) {
                path = path.replace(viewModel.bindingData.bindingPath + '/', '');
                return viewModel.form.getFormValueByBindPath(path);
            }
        }
        return null;
    };
    return EffectUtil;
}());

var ReadonlyEffector = /** @class */ (function () {
    function ReadonlyEffector(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.ns = this.viewModelContext.injector.get(NAMESPACE, '');
    }
    ReadonlyEffector.prototype.effect = function (path, value, options) {
        var viewModelContext;
        if (options.viewModelId) {
            viewModelContext = this.viewModelContext.appContext.viewModelContextManager.getContextById(options.viewModelId);
        }
        else {
            return;
        }
        if (!viewModelContext)
            return;
        if (!viewModelContext.form)
            return;
        var form_anme = EffectUtil.getFormValueByPath(path, viewModelContext).form_name;
        if (!form_anme) {
            return;
        }
        if (value === true) {
            form_anme['readonly'] = true;
        }
        else {
            form_anme['readonly'] = false;
        }
        viewModelContext.form.changes.next({ type: 'validateFieldsFinished' });
    };
    return ReadonlyEffector;
}());

var ValidateEffector = /** @class */ (function () {
    function ValidateEffector(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.ns = this.viewModelContext.injector.get(NAMESPACE, '');
    }
    ValidateEffector.prototype.effect = function (path, value, options) {
        //根据路径寻找字段
        var viewModelContext;
        if (options.viewModelId) {
            viewModelContext = this.viewModelContext.appContext.viewModelContextManager.getContextById(options.viewModelId);
        }
        else {
            return;
        }
        if (!viewModelContext)
            return;
        if (!viewModelContext.form)
            return;
        var formControl = EffectUtil.getFormValueByPath(path, viewModelContext);
        var form_name = formControl.form_name;
        if (!form_name) {
            return;
        }
        // 只认false  为flase认为验证不过
        if (value === false && options.eventType !== Expression.EventType.Append && options.eventType !== Expression.EventType.Load) {
            form_name.validationResult = { passing: !value, message: options.message };
        }
        else if (value === true) {
            form_name.validationResult = { passing: true, message: '' };
        }
        var validators = [{ "type": "expression", "constraints": [options.expressionId], message: options.message }];
        viewModelContext.form.addValidate(formControl.bindingPath, formControl.name);
        form_name.pushValidatorFnforValidate(validators, true);
    };
    return ValidateEffector;
}());

var RequiredEffector = /** @class */ (function () {
    function RequiredEffector(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.ns = this.viewModelContext.injector.get(NAMESPACE, '');
    }
    RequiredEffector.prototype.effect = function (path, value, options) {
        var viewModelContext;
        if (options.viewModelId) {
            viewModelContext = this.viewModelContext.appContext.viewModelContextManager.getContextById(options.viewModelId);
        }
        else {
            return;
        }
        if (!viewModelContext)
            return;
        if (!viewModelContext.form)
            return;
        var formControl = EffectUtil.getFormValueByPath(path, viewModelContext);
        var form_name = formControl.form_name;
        if (!form_name) {
            return;
        }
        var validators = [{ "type": "required", "constraints": [true], message: options.message || '必填' }];
        if (value === true) {
            viewModelContext.form.addValidate(formControl.bindingPath, formControl.name);
            form_name.pushValidatorFnforRequired(validators, true);
            form_name.required = true;
        }
        else if (value === false) {
            form_name.required = false;
            if (form_name.getValidatorFn() && form_name.getValidatorFn().length >= 1) {
                //去除必填
                form_name.resetValidatorFnforRequired();
                if (form_name.validationResult && form_name.validationResult.type === 'required') {
                    form_name.validationResult = { passing: true, message: '' };
                }
            }
        }
        viewModelContext.form.changes.next({ type: 'validateFieldsFinished' });
    };
    return RequiredEffector;
}());

var VisibleEffector = /** @class */ (function () {
    function VisibleEffector(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.ns = this.viewModelContext.injector.get(NAMESPACE, '');
    }
    VisibleEffector.prototype.effect = function (path, value, options) {
        var viewModelContext;
        if (options.viewModelId) {
            viewModelContext = this.viewModelContext.appContext.viewModelContextManager.getContextById(options.viewModelId);
        }
        else {
            return;
        }
        if (!viewModelContext)
            return;
        if (!viewModelContext.form)
            return;
        var form_anme = EffectUtil.getFormValueByPath(path, viewModelContext).form_name;
        if (!form_anme) {
            return;
        }
        if (value === true) {
            form_anme['visible'] = true;
        }
        else {
            form_anme['visible'] = false;
        }
        viewModelContext.form.changes.next({ type: 'validateFieldsFinished' });
    };
    return VisibleEffector;
}());

var DependencyEffector = /** @class */ (function () {
    function DependencyEffector(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.ns = this.viewModelContext.injector.get(NAMESPACE, '');
    }
    DependencyEffector.prototype.effect = function (path, value, options) {
        var viewModelContext;
        if (options.viewModelId) {
            viewModelContext = this.viewModelContext.appContext.viewModelContextManager.getContextById(options.viewModelId);
        }
        else {
            return;
        }
        if (!viewModelContext.form)
            return;
        var formControl = EffectUtil.getFormValueByPath(path, viewModelContext);
        var form_name = formControl.form_name;
        if (!form_name) {
            return;
        }
        if (value === true) {
            form_name.value = null;
            form_name.validationResult = { passing: value, message: '' };
        }
    };
    return DependencyEffector;
}());

var EffectorFactory = /** @class */ (function () {
    function EffectorFactory(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.injector = this.viewModelContext.injector;
        this.effectorRegistry = this.injector.get(EffectorRegistry);
    }
    EffectorFactory.prototype.getEffector = function (expressionObject) {
        var path = expressionObject.path;
        var ns = expressionObject.ns;
        var bindingType = expressionObject.bindingType;
        var type = expressionObject.type;
        var nsEffectors = this.effectorRegistry.effectors.filter(function (effector) { return effector.ns == ns; });
        // 计算表达式
        if (type === Expression.ExpressionType.Compute) {
            if (bindingType === Expression.ExpressionBindingType.Field) {
                return nsEffectors.find(function (effector) { return effector instanceof RepositoryEffector; });
            }
            else if (bindingType === Expression.ExpressionBindingType.State) {
                return nsEffectors.find(function (effector) { return effector instanceof UIStateEffector; });
            }
            else {
                throw new Error("\u4E0D\u652F\u6301\u7684\u7ED1\u5B9A\u5B57\u6BB5\u7C7B\u578B\uFF1A" + bindingType);
            }
        }
        else if (type === Expression.ExpressionType.Readonly) {
            // 只读表达式
            return nsEffectors.find(function (effector) { return effector instanceof ReadonlyEffector; });
        }
        else if (type === Expression.ExpressionType.Dependency) {
            // 依赖表达式
            return nsEffectors.find(function (effector) { return effector instanceof DependencyEffector; });
        }
        else if (type === Expression.ExpressionType.Relative) {
            // 关联表达式
            // return nsEffectors.find((effector: Expression.Effector) => effector instanceof RelativeEffector);
        }
        else if (type === Expression.ExpressionType.Validate) {
            // 校验表达式
            return nsEffectors.find(function (effector) { return effector instanceof ValidateEffector; });
        }
        else if (type === Expression.ExpressionType.Required) {
            // 必填表达式
            return nsEffectors.find(function (effector) { return effector instanceof RequiredEffector; });
        }
        else if (type === Expression.ExpressionType.Visible) {
            // 显隐表达式
            return nsEffectors.find(function (effector) { return effector instanceof VisibleEffector; });
        }
        else {
            // Core.warn(`EffectorFactory 没有找到对应的副作用器 ${type}`);
            return null;
        }
    };
    return EffectorFactory;
}());

/**
 * Resolver
 */
var VIEW_MODEL_EXPRESSION_RESOLVER_PROVIDERS = [
    { provide: RESOLVER_TOKEN, useClass: EntityDependencyResolver, multi: true, deps: [ViewModelContext] },
    { provide: RESOLVER_TOKEN, useClass: StateDependencyResolver, multi: true, deps: [ViewModelContext] },
    { provide: RESOLVER_TOKEN, useClass: CommentDependencyResolver, multi: true, deps: [ViewModelContext] },
];
/**
 * ChangeListener
 */
var VIEW_MODEL_EXPRESSION_LISTENER_PROVIDERS = [
    { provide: LISTENER_TOKEN, useClass: UIStateChangeListener, multi: true, deps: [ViewModelContext] },
    { provide: LISTENER_TOKEN, useClass: RepositoryChangeListener, multi: true, deps: [ViewModelContext] },
    { provide: LISTENER_TOKEN, useClass: BindingDataChangeListener, multi: true, deps: [ViewModelContext] }
];
/**
 * EventHandler
 */
var VIEW_MODEL_EXPRESSION_EVENT_HANDLER_PROVIDERS = [
    { provide: EVENT_HANDLER_TOKEN, useClass: RepositoryAddEntityEventHandler, multi: true, deps: [ViewModelContext] },
    { provide: EVENT_HANDLER_TOKEN, useClass: RepositoryRemoveEntityEventHandler, multi: true, deps: [ViewModelContext] },
    { provide: EVENT_HANDLER_TOKEN, useClass: EntityValueChangedEventHandler, multi: true, deps: [ViewModelContext] },
    { provide: EVENT_HANDLER_TOKEN, useClass: StateValueChangedEventHandler, multi: true, deps: [ViewModelContext] },
    { provide: EVENT_HANDLER_TOKEN, useClass: RepositoryLoadEventHandler, multi: true, deps: [ViewModelContext] },
    { provide: EVENT_HANDLER_TOKEN, useClass: EntityUpdateEventHandler, multi: true, deps: [ViewModelContext] },
    { provide: EVENT_HANDLER_TOKEN, useClass: BindingDataAppendObjectEventHandler, multi: true, deps: [ViewModelContext] },
    { provide: EVENT_HANDLER_TOKEN, useClass: BindingDataValueChangeEventHandler, multi: true, deps: [ViewModelContext] },
    { provide: EVENT_HANDLER_TOKEN, useClass: BindingDataRemoveObjectEventHandler, multi: true, deps: [ViewModelContext] },
    { provide: EVENT_HANDLER_TOKEN, useClass: BindingDataLoadEventHandler, multi: true, deps: [ViewModelContext] },
    { provide: EVENT_HANDLER_TOKEN, useClass: BindingDataSelectionChangedEventHandler, multi: true, deps: [ViewModelContext] },
];
/**
 * Effector
 */
var VIEW_MODEL_EXPRESSION_EFFECTOR_PROVIDERS = [
    { provide: EFFECTOR_TOKEN, useClass: RepositoryEffector, multi: true, deps: [ViewModelContext] },
    { provide: EFFECTOR_TOKEN, useClass: UIStateEffector, multi: true, deps: [ViewModelContext] },
    { provide: EFFECTOR_TOKEN, useClass: ReadonlyEffector, multi: true, deps: [ViewModelContext] },
    { provide: EFFECTOR_TOKEN, useClass: ValidateEffector, multi: true, deps: [ViewModelContext] },
    { provide: EFFECTOR_TOKEN, useClass: RequiredEffector, multi: true, deps: [ViewModelContext] },
    { provide: EFFECTOR_TOKEN, useClass: VisibleEffector, multi: true, deps: [ViewModelContext] },
    { provide: EFFECTOR_TOKEN, useClass: DependencyEffector, multi: true, deps: [ViewModelContext] }
];
var VIEW_MODEL_EXPRESSION_PROVIDERS = __spread([
    { provide: ResolverRegistry, useClass: ResolverRegistry, deps: [ViewModelContext] },
    { provide: ResolveService, useClass: ResolveService, deps: [ViewModelContext] },
    { provide: ListenerRegistry, useClass: ListenerRegistry, deps: [ViewModelContext] },
    { provide: Listeners, useClass: Listeners, deps: [ViewModelContext] },
    { provide: EventHandlerRegistry, useClass: EventHandlerRegistry, deps: [ViewModelContext] },
    { provide: EffectorRegistry, useClass: EffectorRegistry, deps: [ViewModelContext] },
    { provide: EffectorFactory, useClass: EffectorFactory, deps: [ViewModelContext] },
    { provide: ExpressionRegistry, useClass: ExpressionRegistry, deps: [ViewModelContext] },
    { provide: ExpressionEventEmitter, useClass: ExpressionEventEmitter, deps: [ViewModelContext] },
    { provide: ExpressionExecutor, useClass: ExpressionExecutor, deps: [ViewModelContext] },
    { provide: ExpressionManager, useClass: ExpressionManager, deps: [ViewModelContext] },
    { provide: ExpressionResult, useClass: ExpressionResult, deps: [ViewModelContext] },
    { provide: ExpressionResultFactory, useClass: ExpressionResultFactory, deps: [ViewModelContext] },
    { provide: ExpressionEngineImpl, useClass: ExpressionEngineImpl, deps: [ViewModelContext] }
], VIEW_MODEL_EXPRESSION_RESOLVER_PROVIDERS, VIEW_MODEL_EXPRESSION_LISTENER_PROVIDERS, VIEW_MODEL_EXPRESSION_EVENT_HANDLER_PROVIDERS, VIEW_MODEL_EXPRESSION_EFFECTOR_PROVIDERS);

var ControlsProxy = /** @class */ (function () {
    function ControlsProxy() {
        this.controlsProxyMap = new Map();
    }
    ControlsProxy.prototype.setControlProxy = function (key, value) {
        this.controlsProxyMap.set(key, value);
    };
    ControlsProxy.prototype.getControlProxy = function (key) {
        return this.controlsProxyMap.get(key);
    };
    return ControlsProxy;
}());

var ViewModel = /** @class */ (function () {
    /**
     * 构造函数
     */
    function ViewModel(injector, id) {
        /**
         * 扩展命令
         */
        this.extendCommands = new Map();
        this.injector = injector;
        this.id = id;
    }
    /**
     * 初始化
     */
    ViewModel.prototype.init = function () {
        this.initRepository();
        this.initContext();
        this.initBindingData();
        this.initUIState();
        this.intiStateMachine();
        this.initForm();
        this.initCommandBus();
        this.registerWithParent();
        this.initListeners();
        this.closeOldBeSession();
        this.initExpression();
        this.initControlsProxy();
        this.config();
    };
    ViewModel.prototype.config = function () {
        this.uiState.config(this.context);
    };
    ViewModel.prototype.initControlsProxy = function () {
        this.controlsProxy = this.injector.get(ControlsProxy);
    };
    ViewModel.prototype.initRepository = function () {
        this.repository = this.injector.get(Repository);
    };
    ViewModel.prototype.initContext = function () {
        this.context = this.injector.get(ViewModelContext);
        this.context.init(this);
    };
    ViewModel.prototype.initExpression = function () {
        var appContext = this.context.appContext;
        var allViewModelContexts = appContext.viewModelContextManager.getContexts();
        var existedViewModelContext = allViewModelContexts.find(function (viewModelContext) {
            if (viewModelContext.expressionEngineImpl) {
                return true;
            }
            else {
                return false;
            }
        });
        if (existedViewModelContext) {
            this.expressionEngineImpl = existedViewModelContext.expressionEngineImpl;
            this.expressionManager = existedViewModelContext.expressionManager;
            this.expressionResult = existedViewModelContext.expressionResult;
            return;
        }
        this.expressionEngineImpl = this.injector.get(ExpressionEngineImpl, null);
        this.expressionManager = this.injector.get(ExpressionManager, null);
        var expressionResultFactory = this.injector.get(ExpressionResultFactory, null);
        this.expressionResult = this.injector.get(ExpressionResult, null);
    };
    ViewModel.prototype.initBindingData = function () {
        var _this = this;
        this.bindingData = this.context.injector.get(BindingData);
        this.entityValueChangingListeners = new Map();
        this.entityValueChangedListeners = new Map();
        if (this.bindingData) {
            this.bindingData.setValueChangeInvokerFactory(function (paths) {
                return function (preValue, value, entityChanged, primaryValue) {
                    var plainPath = '/' + paths.join('/');
                    var command;
                    if (entityChanged === false) {
                        command = _this.entityValueChangingListeners[plainPath];
                    }
                    else {
                        command = _this.entityValueChangedListeners[plainPath];
                    }
                    if (!!command) {
                        var change_1 = {
                            paths: paths,
                            preValue: preValue,
                            value: value,
                            changed: entityChanged
                        };
                        var commands = command.split(';').filter(function (p) { return p; });
                        var valueChangeSuccess_1 = true;
                        return from(commands).pipe(concatMap(function (item) {
                            if (!valueChangeSuccess_1) {
                                return EMPTY$1;
                            }
                            return _this[item](change_1).pipe(tap(function (result) {
                                valueChangeSuccess_1 = result;
                            }));
                        }), every(function (result) { return result; }));
                    }
                    else {
                        return of(true);
                    }
                };
            });
        }
        var repositoryName = this.repository.name;
        var bindingDataManager = this.context.appContext.bindingDataManager;
        var repositoryBindingData = bindingDataManager.getBindingDataByName(repositoryName);
        this.bindingData.initByBindingList(repositoryBindingData.list, this.context, repositoryBindingData.dataTypeInfo);
    };
    ViewModel.prototype.initUIState = function () {
        this.uiState = this.injector.get(UIState);
    };
    ViewModel.prototype.intiStateMachine = function () {
        this.stateMachine = this.injector.get(StateMachine, null);
        if (!this.stateMachine) {
            return;
        }
        this.stateMachine.init(this.context);
    };
    ViewModel.prototype.initForm = function () {
        this.form = this.injector.get(Form, null);
        this.form.init();
    };
    ViewModel.prototype.initCommandBus = function () {
        this.commandBus = this.injector.get(CommandBus);
        this.extendCommandMethods();
    };
    ViewModel.prototype.extendCommandMethods = function () {
        var _this = this;
        this.ngCommands = MetadataUtil.getPropsMetadatasByName(this.constructor, COMMAND_METHOD_META);
        this.keybindingMap = new Map();
        Object.keys(this.ngCommands).forEach(function (propName) {
            var ngCommand = _this.ngCommands[propName];
            Object.defineProperty(_this, propName, {
                value: function (eventParams) {
                    var command = {
                        name: ngCommand.name,
                        params: ngCommand.params,
                        paramDescriptions: ngCommand.paramDescriptions,
                        eventParam: eventParams || null
                    };
                    return _this.commandBus.dispatch(command);
                }
            });
            if (ngCommand.keyBinding) {
                _this.keybindingMap.set(propName, ngCommand.keyBinding);
            }
        });
    };
    /**
     * 注册扩展命令方法
     */
    ViewModel.prototype.registerExtendCommand = function (commandName, commandHandler) {
        var _this = this;
        Object.defineProperty(this, commandName, {
            value: function (eventParams) {
                return commandHandler(eventParams, _this.context);
            }
        });
        this.extendCommands.set(commandName, commandHandler);
    };
    ViewModel.prototype.registerWithParent = function () {
        var parentContext = this.context.parent;
        if (!parentContext || !parentContext.viewModel || !parentContext.viewModel['childViewModels']) {
            return;
        }
        var parentViewModel = parentContext.viewModel;
        var className = this.constructor.name;
        var propName = parentViewModel['childViewModels'][className];
        parentViewModel[propName] = this;
    };
    /**
     * 关闭老的BeSession
     */
    ViewModel.prototype.closeOldBeSession = function () {
        var allViewModelContexts = this.context.appContext.viewModelContextManager.getContexts();
        if (allViewModelContexts.length === 1 && allViewModelContexts[0] === this.context) {
            this.context.repository.reset();
        }
    };
    /**
   * 从Form获取监听器
   */
    ViewModel.prototype.initListeners = function () {
        var _this = this;
        var extractPath = function (bindingBasePath, bindingPath) {
            return '/' + bindingBasePath.split('/').concat(bindingPath.split('.')).filter(function (item) { return item.length > 0; }).join('/');
        };
        if (this.form) {
            var valueChangingListeners_1 = this.form.getEntityValueChangingListeners();
            Object.keys(valueChangingListeners_1).forEach(function (bindingPath) {
                var plainPath = extractPath(_this.bindingPath, bindingPath);
                _this.entityValueChangingListeners[plainPath] = valueChangingListeners_1[bindingPath];
            });
            var valueChangedListeners_1 = this.form.getEntityValueChangedListeners();
            Object.keys(valueChangedListeners_1).forEach(function (bindingPath) {
                var plainPath = extractPath(_this.bindingPath, bindingPath);
                _this.entityValueChangedListeners[plainPath] = valueChangedListeners_1[bindingPath];
            });
        }
    };
    return ViewModel;
}());

var ViewModelOptions = /** @class */ (function () {
    function ViewModelOptions() {
    }
    return ViewModelOptions;
}());

var AppEventBus = /** @class */ (function () {
    /**
     * 构造函数
     */
    function AppEventBus() {
        this.eventBus = new Subject();
        this.subscriptionsMap = new Map();
    }
    AppEventBus.prototype.triggerEvent = function (event) {
        this.eventBus.next(event);
    };
    AppEventBus.prototype.subscribe = function (componentId, func, funcError) {
        if (this.subscriptionsMap.has(componentId) === false) {
            var subscription = this.eventBus.subscribe(function (value) { return func(value); }, function (value) { return funcError(value); });
            this.subscriptionsMap.set(componentId, subscription);
        }
    };
    AppEventBus.prototype.unsubscribe = function (componentId) {
        if (this.subscriptionsMap.has(componentId) === true) {
            this.subscriptionsMap.get(componentId).unsubscribe();
            this.subscriptionsMap.delete(componentId);
        }
    };
    /**
     * 清除注册得指定key名监听器
     * @param keyStr 监听器key 默认值为listview上注册得
     * @returns
     */
    AppEventBus.prototype.unsubscribeAllListview = function (keyStr) {
        var e_1, _a;
        if (keyStr === void 0) { keyStr = '-listview-extend'; }
        if (this.subscriptionsMap.size == 0) {
            return;
        }
        try {
            // @ts-ignore: Unreachable code error
            for (var _b = __values(this.subscriptionsMap.keys()), _c = _b.next(); !_c.done; _c = _b.next()) {
                var key = _c.value;
                if (key.indexOf(keyStr) > 0) {
                    this.subscriptionsMap.get(key).unsubscribe();
                    this.subscriptionsMap.delete(key);
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_1) throw e_1.error; }
        }
    };
    return AppEventBus;
}());

var APP_BASE_PROVIDERS = [
    { provide: AppEventBus, useClass: AppEventBus, deps: [] },
    { provide: BindingDataManager, useClass: BindingDataManager, deps: [] },
    { provide: RepositoryManager, useClass: RepositoryManager, deps: [] },
    { provide: ViewModelContextManager, useClass: ViewModelContextManager, deps: [] },
    {
        provide: AppContext, useClass: AppContext,
        deps: [Injector, AppEventBus, RepositoryManager, BindingDataManager, ViewModelContextManager]
    }
];

var APP_CONTROL_STATE_PROVIDERS = [
    { provide: ControlStateInterceptorService, useClass: ControlStateInterceptorService, deps: [Injector] }
];
var VIEW_MODEL_CONTROL_STATE_PROVIDERS = [
    { provide: ControlStateListener, useClass: ControlStateListener, deps: [ViewModelContext] },
    { provide: ControlStateUpdater, useClass: ControlStateUpdater, deps: [ViewModelContext] }
];

var App = /** @class */ (function () {
    /**
     * 构造函数
     */
    function App(options) {
        options.providers = options.providers || [];
        var appProviders = __spread(APP_BASE_PROVIDERS, APP_VARIABLE_PROVIDERS, HTTP_PROVIDERS, APP_CONTROL_STATE_PROVIDERS, options.providers);
        var appInjector = createInjector(appProviders);
        this.context = appInjector.get(AppContext);
    }
    /**
     * 启用ViewModel
     */
    App.prototype.createViewModel = function (options) {
        var providers = options.providers || [];
        var parent = options.parent || null;
        var mergedProviders = __spread([
            { provide: ViewModelContext, useClass: ViewModelContext, deps: [] },
            { provide: ControlsProxy, useClass: ControlsProxy, deps: [] }
        ], VIEW_MODEL_COMMAND_PROVIDERS, VIEW_MODEL_EXPRESSION_PROVIDERS, VIEW_MODEL_CONTROL_STATE_PROVIDERS, providers);
        var parentInjector = parent ? parent.injector : this.context.injector;
        var injector = createInjector(mergedProviders, parentInjector);
        var viewModel = injector.get(ViewModel);
        viewModel.init();
        return viewModel;
    };
    return App;
}());

/*
 * StateMachine变量解析
 * @Author: Witt
 * @Date: 2018-12-04 17:09:42
 * @Last Modified by: Witt
 * @Last Modified time: 2019-10-30 11:07:10
 */
/**
 * 解析辅助工具类
 */
var ParseUtil = /** @class */ (function () {
    function ParseUtil() {
    }
    /**
     * 获取应用上下文
     */
    ParseUtil.getAppContext = function (context) {
        if (context instanceof CommandContext) {
            return context.viewModelContext.appContext;
        }
        else if (context instanceof ViewModelContext) {
            return context.appContext;
        }
        else if (context instanceof AppContext) {
            return context;
        }
        else {
            throw new Error('上下文中找不到AppContext，请检查！');
        }
    };
    /**
     * 获取当前Frame的Context
     */
    ParseUtil.getFrameContext = function (context) {
        if (context instanceof CommandContext) {
            return context.viewModelContext;
        }
        else if (context instanceof ViewModelContext) {
            return context;
        }
        else {
            throw new Error('上下文中找不到FrameContext，请检查！');
        }
    };
    /**
     * 获取根Frame的Context
     */
    ParseUtil.getRootFrameContext = function (context) {
        var frameContext = this.getFrameContext(context);
        return frameContext.root;
    };
    /**
     * 根据frameId获取FrameContext
     */
    ParseUtil.getFrameContextById = function (context, frameId) {
        var appContext = this.getAppContext(context);
        return appContext.viewModelContextManager.getContextById(frameId);
    };
    return ParseUtil;
}());

/**
 * 数据变量解析
 */
var DataVariableParser = /** @class */ (function () {
    function DataVariableParser() {
    }
    /**
     * 解析变量
     * @param expression 表达式
     * @param context 上下文
     */
    DataVariableParser.prototype.parse = function (expression, context) {
        var _this = this;
        var appContext = ParseUtil.getAppContext(context);
        var paths = this.extractPaths(expression);
        // 1、单个的表达式：直接求值
        if (paths.length === 1 && expression === "{DATA~" + paths[0] + "}") {
            return this.getValue(paths[0], appContext);
        }
        // 2、其他情况：字符串替换
        paths.forEach(function (path) {
            var searchValue = "{DATA~" + path + "}";
            var replaceValue = _this.getValue(path, appContext);
            expression = expression.replace(searchValue, replaceValue);
        });
        return expression;
    };
    /**
     * 提取路径
     */
    DataVariableParser.prototype.extractPaths = function (expression) {
        var paths = [];
        // 查找所有的uiState变量字符串
        var DATA_PATTERN_G = /\{DATA~(\S+?)\}/g;
        var dataVariables = expression.match(DATA_PATTERN_G);
        if (dataVariables === null) {
            return [];
        }
        // 提取后边的路径
        var DATA_PATTERN = /\{DATA~(\S+?)\}/;
        dataVariables.forEach(function (dataVariable) {
            var pathMatches = dataVariable.match(DATA_PATTERN);
            if (pathMatches != null && pathMatches.length === 2) {
                paths.push(pathMatches[1]);
            }
        });
        return paths;
    };
    /**
     * 获取值
     * @param path 路径：/
     */
    DataVariableParser.prototype.getValue = function (path, appContext) {
        var parts = path.split('/').filter(function (part) {
            return part !== '';
        });
        var frameContext = appContext.viewModelContextManager.getContextById(parts[0]);
        if (!frameContext) {
            throw new Error(path + "\u4E0D\u6B63\u786E\uFF0C\u8BF7\u68C0\u67E5\uFF01");
        }
        var bindingData = frameContext.bindingData;
        if (!bindingData) {
            throw new Error(path + "\u4E0D\u6B63\u786E\uFF0C\u8BF7\u68C0\u67E5\uFF01");
        }
        return bindingData.getValue(parts.slice(1));
    };
    return DataVariableParser;
}());

/**
 * session变量解析
 * @author Witt <jiwt@inspur.com>
 */
/**
 * 数据变量解析
 */
var UIStateVariableParser = /** @class */ (function () {
    function UIStateVariableParser() {
    }
    /**
     * 解析变量
     * @param expression 形如：/frameId/stateName
     * @param context 上下文
     */
    UIStateVariableParser.prototype.parse = function (expression, context) {
        var _this = this;
        var appContext = ParseUtil.getAppContext(context);
        var paths = this.extractPaths(expression);
        // 1、单个的表达式：直接求值
        if (paths.length === 1 && expression === "{UISTATE~" + paths[0] + "}") {
            return this.getUIState(paths[0], appContext);
        }
        // 2、其他情况：字符串替换
        paths.forEach(function (path) {
            var searchValue = "{UISTATE~" + path + "}";
            var replaceValue = _this.getUIState(path, appContext);
            expression = expression.replace(searchValue, replaceValue);
        });
        return expression;
    };
    /**
     * 提取路径
     * 变量格式：{}
     */
    UIStateVariableParser.prototype.extractPaths = function (expression) {
        var paths = [];
        // 查找所有的uiState变量字符串
        var UI_STATE_PATTERN_G = /\{UISTATE~(\S+?)\}/g;
        var uiStateVariables = expression.match(UI_STATE_PATTERN_G);
        if (uiStateVariables === null) {
            return [];
        }
        // 提取后边的路径
        var UI_STATE_PATTERN = /\{UISTATE~(\S+?)\}/;
        uiStateVariables.forEach(function (uiStateVariable) {
            var pathMatches = uiStateVariable.match(UI_STATE_PATTERN);
            if (pathMatches != null && pathMatches.length === 2) {
                paths.push(pathMatches[1]);
            }
        });
        return paths;
    };
    /**
     * 获取UIState
     */
    UIStateVariableParser.prototype.getUIState = function (path, appContext) {
        var parts = path.split('/').filter(function (part) {
            return part !== '';
        });
        var _a = __read(parts, 2), frameId = _a[0], stateName = _a[1];
        var frameContext = appContext.viewModelContextManager.getContextById(frameId);
        var state = frameContext.uiState[stateName];
        if (state && state.constructor.toString().startsWith('function Date()')) {
            return this.formatDate(state);
        }
        for (var i = 2; i < parts.length; i++) {
            state = state[parts[i]];
            // 复杂对象一层层查找下去，如果某一层不存在，结果可以是undefined，但是要直接返回undefined避免报错。
            if (!state) {
                return state;
            }
        }
        return state;
    };
    /**
     * @todo：待删除
     */
    UIStateVariableParser.prototype.formatDate = function (value) {
        if (!value) {
            return '';
        }
        // 年
        var year = value.getFullYear();
        // 月
        var month = (value.getMonth() + 1).toString();
        month = month.length === 1 ? ('0' + month) : month;
        // 日
        var day = value.getDate().toString();
        day = day.length === 1 ? ('0' + day) : day;
        return year + "-" + month + "-" + day;
    };
    return UIStateVariableParser;
}());

/**
 * 状态机变量解析
 * @summary
 *
 * 解析策略：
 * 1、不带frameId，从顶层StateMachine中解析
 * {STATEMACHINE~/states/key}
 * {STATEMACHINE~/renderStates/key}
 *
 * 2、带frameId，从frameId对应的FrameContext的StateMachine中解析
 * {STATEMACHINE~/frameId/states/key}
 * {STATEMACHINE~/frameId/renderStates/key}
 *
 * 存在的问题：
 * 1、不带frameId从顶层StateMachine解析仅为了兼容，将来改为从当前FrameContext的StateMachine中解析；
 * 2、组合表单中顶层StateMachine是主表单的rootFrameContext的StateMachine，显然不合理（既成事实）；
 * 3、farmeId如果是states或renderStates，导致解析失败，几率很小，但又风险。
 */
var StateMachineVariableParser = /** @class */ (function () {
    /**
     * 构造函数
     */
    function StateMachineVariableParser() {
    }
    /**
     * 解析变量
     * @param expression 变量：格式形如：/frameId/componentId/stateName
     * @param context 上下文
     */
    StateMachineVariableParser.prototype.parse = function (expression, context) {
        var _this = this;
        var paths = this.extractPaths(expression);
        // 1、单个的表达式：直接求值
        if (paths.length === 1 && expression === "{STATEMACHINE~" + paths[0] + "}") {
            return this.getValue(paths[0], context);
        }
        // 2、其他情况：字符串替换
        paths.forEach(function (path) {
            var searchValue = "{STATEMACHINE~" + path + "}";
            var replaceValue = _this.getValue(path, context);
            expression = expression.replace(searchValue, replaceValue);
        });
        return expression;
    };
    /**
     * 提取Session变量名
     * 变量格式：{}
     */
    StateMachineVariableParser.prototype.extractPaths = function (expression) {
        var paths = [];
        // 查找所有的StateMachine变量字符串
        var STATE_MACHINE_PATTERN_G = /\{STATEMACHINE~(\S+?)\}/g;
        var stateMachineVariables = expression.match(STATE_MACHINE_PATTERN_G);
        if (stateMachineVariables === null) {
            return [];
        }
        // 提取后边的路径
        var STATE_MACHINE_PATTERN = /\{STATEMACHINE~(\S+?)\}/;
        stateMachineVariables.forEach(function (sessionVariable) {
            var pathMatches = sessionVariable.match(STATE_MACHINE_PATTERN);
            if (pathMatches != null && pathMatches.length === 2) {
                paths.push(pathMatches[1]);
            }
        });
        return paths;
    };
    /**
     * 获取对应的值
     */
    StateMachineVariableParser.prototype.getValue = function (path, context) {
        var pathObj = this.getPathObj(path);
        var stateMachine = this.getTargetStateMachine(pathObj.frameId, context);
        if (pathObj.type === 'currentState') {
            return stateMachine.context.state;
        }
        else if (pathObj.type === 'renderStates') {
            return stateMachine[pathObj.name];
        }
        else {
            throw new Error("\u4E0D\u652F\u7C7B\u578B\u4E3A" + pathObj.type + "\u7684\u72B6\u6001\u673A\u53D8\u91CF");
        }
    };
    /**
     * 解析path，并获取对应的StateMachine实例
     */
    StateMachineVariableParser.prototype.getTargetStateMachine = function (frameId, context) {
        var targetFrameContext;
        if (frameId) {
            targetFrameContext = ParseUtil.getFrameContextById(context, frameId);
        }
        else {
            targetFrameContext = ParseUtil.getRootFrameContext(context);
        }
        if (!targetFrameContext || !targetFrameContext.stateMachine) {
            throw new Error('找不到对应的状态机实例，请检查！');
        }
        return targetFrameContext.stateMachine;
    };
    /**
     * 将Path解析为格式化的Path对象
     */
    StateMachineVariableParser.prototype.getPathObj = function (path) {
        var parsedPathObj;
        var parts = this.splitPath(path);
        if (parts[0] === 'currentState' || parts[0] === 'renderStates') {
            parsedPathObj = {
                frameId: '',
                type: parts[0],
                name: parts[1]
            };
        }
        else {
            parsedPathObj = {
                frameId: parts[0],
                type: parts[1],
                name: parts[2]
            };
        }
        return parsedPathObj;
    };
    /**
     * 分隔Path
     */
    StateMachineVariableParser.prototype.splitPath = function (path) {
        var parts = path.split('/').filter(function (part) {
            return part !== '';
        });
        return parts;
    };
    return StateMachineVariableParser;
}());

/**
 * session变量解析
 * @author Witt <jiwt@inspur.com>
 */
/**
 * 命令变量解析
 * {COMMAND~/params/key}
 * {COMMAND~/results/taskName}
 */
var CommandVariableParser = /** @class */ (function () {
    /**
     * 构造函数
     */
    function CommandVariableParser() {
    }
    /**
     * 解析变量
     * @param expression 变量：格式形如：/frameId/componentId/stateName
     * @param context 上下文
     */
    CommandVariableParser.prototype.parse = function (expression, context) {
        var _this = this;
        var paths = this.extractPaths(expression);
        // 1、单个的表达式：直接求值
        if (paths.length === 1 && expression === "{COMMAND~" + paths[0] + "}") {
            return this.getValue(paths[0], context);
        }
        // 2、其他情况：字符串替换
        paths.forEach(function (path) {
            var searchValue = "{COMMAND~" + path + "}";
            var replaceValue = _this.getValue(path, context);
            expression = expression.replace(searchValue, replaceValue);
        });
        return expression;
    };
    /**
     * 提取Session变量名
     * 变量格式：{}
     */
    CommandVariableParser.prototype.extractPaths = function (expression) {
        var paths = [];
        // 查找所有的uiState变量字符串
        var UI_STATE_PATTERN_G = /\{COMMAND~(\S+?)\}/g;
        var uiStateVariables = expression.match(UI_STATE_PATTERN_G);
        if (uiStateVariables === null) {
            return [];
        }
        // 提取后边的路径
        var UI_STATE_PATTERN = /\{COMMAND~(\S+?)\}/;
        uiStateVariables.forEach(function (sessionVariable) {
            var pathMatches = sessionVariable.match(UI_STATE_PATTERN);
            if (pathMatches != null && pathMatches.length === 2) {
                paths.push(pathMatches[1]);
            }
        });
        return paths;
    };
    /**
     * 获取UIState
     */
    CommandVariableParser.prototype.getValue = function (path, context) {
        if (context instanceof CommandContext === false) {
            throw new Error('当前上下文不支持COMMAND变量，请检查！');
        }
        var parts = path.split('/').filter(function (part) {
            return part !== '';
        });
        var _a = __read(parts, 2), type = _a[0], name = _a[1];
        if (type === 'params') {
            return context.command.params[name];
        }
        else if (type === 'results') {
            return context.results[name];
        }
    };
    return CommandVariableParser;
}());

/**
 * 变量解析服务
 * 职责：
 * 1、解析字符串中的变量，并替换成相应的值；
 * 2、对表达式进行求值。
 *
 * @todo 对表达式求值的部分和表达式功能重叠，是否转移到表达式中？
 */
var VariableParseService = /** @class */ (function () {
    /**
     * 构造变量解析服务
     * @param parsers 解析器集合
     */
    function VariableParseService(parsers) {
        this.parsers = parsers;
    }
    /**
     * 解析表达式
     * @param expression 表达式
     * @param context 上下文
     */
    VariableParseService.prototype.parse = function (target, context) {
        var _this = this;
        if (typeof target === 'string' && target.length > 0) {
            // 字符串，直接解析
            return this.parseExpression(target, context);
        }
        else if (Array.isArray(target)) {
            // 遍历数组
            target.forEach(function (item, itemIndex) {
                if (typeof item === 'string') {
                    target[itemIndex] = _this.parseExpression(item, context);
                }
                else {
                    target[itemIndex] = _this.parse(item, context);
                }
            });
        }
        else if (typeof target === 'object' && target !== null) {
            // 遍历对象可枚举属性
            var keys = Object.keys(target);
            keys.forEach(function (key) {
                if (typeof target[key] === 'string') {
                    target[key] = _this.parseExpression(target[key], context);
                }
                else {
                    target[key] = _this.parse(target[key], context);
                }
            });
        }
        return target;
    };
    /**
     * 表达式求值
     */
    VariableParseService.prototype.evaluate = function (expression, context) {
        var parsedExpression = this.parse(expression, context);
        return (new Function('return ' + parsedExpression))();
    };
    /**
     * 解析表达式
     * @param expression 表达式
     * @param context 上下文
     */
    VariableParseService.prototype.parseExpression = function (expression, context) {
        // 空串直接返回
        if (expression === '') {
            return '';
        }
        this.parsers.forEach(function (parser) {
            if (typeof expression === 'string') {
                expression = parser.parse(expression, context);
            }
        });
        return expression;
    };
    return VariableParseService;
}());

var APP_VARIABLE_PROVIDERS = [
    { provide: VARIABLE_PARSERS, useClass: DataVariableParser, multi: true, deps: [] },
    { provide: VARIABLE_PARSERS, useClass: UIStateVariableParser, multi: true, deps: [] },
    { provide: VARIABLE_PARSERS, useClass: StateMachineVariableParser, multi: true, deps: [] },
    { provide: VARIABLE_PARSERS, useClass: CommandVariableParser, multi: true, deps: [] },
    { provide: VariableParseService, useClass: VariableParseService, deps: [VARIABLE_PARSERS] },
];

/* eslint-disable no-case-declarations */
/**
 * 任务链接
 */
var TaskLink = /** @class */ (function () {
    /**
     * 构造函数
     */
    function TaskLink(from, to, condition) {
        this.from = from;
        this.to = to;
        this.condition = condition;
    }
    /**
     * 是否能够
     */
    TaskLink.prototype.canLink = function (context) {
        var type = typeof this.condition;
        var canLink;
        switch (type) {
            case 'boolean':
                canLink = this.condition;
                break;
            case 'function':
                canLink = this.condition(context);
                break;
            case 'string':
                var parseService = context.viewModelContext.injector.get(VariableParseService);
                canLink = parseService.evaluate(this.condition, context);
                break;
            default:
                canLink = false;
                break;
        }
        return canLink;
    };
    return TaskLink;
}());

/*
 * @Author: Witt
 * @Date: 2018-10-17 14:13:40
 * @Last Modified by: Witt
 * @Last Modified time: 2018-10-17 16:08:34
 */
/**
 * 任务执行流程
 */
var TaskFlow = /** @class */ (function () {
    function TaskFlow() {
        /**
         * 节点集合
         */
        this.nodes = [];
        /**
         * 边集合
         */
        this.links = [];
        // #endregion
    }
    // #region 节点操作
    /**
     * 添加节点
     */
    TaskFlow.prototype.addNode = function (name, func) {
        var node = new TaskNode(name, func);
        this.nodes.push(node);
    };
    /**
     * 批量添加链接
     */
    TaskFlow.prototype.addNodes = function (nodes) {
        this.nodes = this.nodes.concat(nodes);
    };
    /**
     * 在目标节点之前插入一个节点
     * @param target 目标节点名称
     * @param name 名称
     * @param func 函数
     */
    TaskFlow.prototype.insertNode = function (target, name, func) {
        var index = this.findNodeIndex(target);
        var node = this.createNode(name, func);
        this.nodes.splice(index, 0, node);
    };
    /**
     * 在目标节点之前插入一个节点
     */
    TaskFlow.prototype.appendNode = function (target, name, func) {
        var index = this.findNodeIndex(target) + 1;
        var node = this.createNode(name, func);
        this.nodes.splice(index, 0, node);
    };
    /**
     * 获取节点索引
     * @param name 名称
     */
    TaskFlow.prototype.findNodeIndex = function (name) {
        return this.nodes.findIndex(function (node) {
            return node.name === name;
        });
    };
    /**
     * 创建任务节点
     * @param name 名称
     * @param func 函数
     */
    TaskFlow.prototype.createNode = function (name, func) {
        var node = new TaskNode(name, func);
        return node;
    };
    // #endregion
    // #region 链接操作
    /**
     * 添加链接
     * @param name 名称
     * @param func 函数
     */
    TaskFlow.prototype.addLink = function (from, to, condition) {
        var link = this.createLink(from, to, condition);
        this.links.push(link);
    };
    /**
     * 批量添加链接
     */
    TaskFlow.prototype.addLinks = function (links) {
        this.links = this.links.concat(links);
    };
    /**
     * 创建链接
     */
    TaskFlow.prototype.createLink = function (from, to, condition) {
        var link = new TaskLink(from, to, condition);
        return link;
    };
    // #endregion
    // #region 流程控制
    /**
     * 获取下一个节点
     * @param from    源节点名称
     * @param context 上下文
     */
    TaskFlow.prototype.getNext = function (from, context) {
        if (!from) {
            return this.nodes.shift();
        }
        // 符合满足条件的边
        var nextLink = this.links.find(function (link) {
            return link.from === from && link.canLink(context);
        });
        if (!nextLink) {
            return;
        }
        return this.nodes.find(function (node) {
            return node.name === nextLink.to;
        });
    };
    // #endregion
    // #region 其他方法
    /**
     * 克隆任务流
     */
    TaskFlow.prototype.clone = function () {
        var taskFlow = new TaskFlow();
        taskFlow.addNodes(this.nodes);
        taskFlow.addLinks(this.links);
        return taskFlow;
    };
    return TaskFlow;
}());

/**
 * Command上下文
 */
var CommandContext = /** @class */ (function () {
    /**
     * 构造函数
     * @param command 命令
     * @param viewModelContext 视图模型上下文
     */
    function CommandContext(command, viewModelContext) {
        /**
         * 执行结果
         */
        this.results = {};
        this.command = command;
        this.viewModelContext = viewModelContext;
    }
    return CommandContext;
}());

/**
 * 命令处理抽象类，所有具体的命令处理类必须继承它，并实现schedule方法。
 */
var CommandHandler = /** @class */ (function () {
    /**
     * 构造函数
     */
    function CommandHandler() {
    }
    /**
     * 初始化
     */
    CommandHandler.prototype.init = function (viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.parseService = viewModelContext.injector.get(VariableParseService);
        this.taskFlow = new TaskFlow();
        this.schedule();
    };
    /**
     * 执行任务
     * @param command 要执行的命令
     * @return 最后一个任务的执行结果
     * @todo：按功能拆分小函数
     */
    CommandHandler.prototype.execute = function (command) {
        var _this = this;
        var lastTaskResult$ = new Subject();
        var taskFlow = this.taskFlow.clone();
        // setTimeout暂时不能去掉的原因：
        // 1、树表单加载数据，依赖TreeTableBinding里设置的全局变量，需要延后执行加载时机；
        // 2、关闭前命令需要延迟执行。
        setTimeout(function () {
            // 1、解析参数
            // 避免解析变量时修改了原始的command
            var _a = __assign({}, command).eventParam, eventParam = _a === void 0 ? null : _a;
            delete command.eventParam;
            var commandToExecute = JSON.parse(JSON.stringify(command));
            commandToExecute.params = _this.parseService.parse(commandToExecute.params, _this.viewModelContext);
            command.eventParam = eventParam;
            commandToExecute.eventParam = eventParam;
            // 2、串联任务流
            var initContext = new CommandContext(commandToExecute, _this.viewModelContext);
            initContext.eventParams = command.eventParam || null;
            var context$ = new BehaviorSubject(initContext);
            var currentTask = taskFlow.getNext('', initContext);
            var highOrder$ = context$.pipe(concatMap(function (context) {
                var result$ = currentTask.execute(context);
                return result$.pipe(take(1), map(function (result) {
                    // 写入执行结果
                    context.results[currentTask.name] = result;
                    context.latestResult = result;
                    currentTask = taskFlow.getNext(currentTask.name, context);
                    // 操作控制流
                    if (currentTask) {
                        context$.next(context);
                    }
                    else {
                        context$.complete();
                    }
                    // 将结果流转换为context流
                    return context;
                }), throwIfEmpty(function () {
                    context$.complete();
                }));
            }));
            // 3、执行合并后的任务流
            highOrder$.pipe(takeLast(1)).subscribe({
                next: function (context) {
                    lastTaskResult$.next(context.latestResult);
                },
                error: function (error) {
                    _this.displayError(error);
                    lastTaskResult$.error(error);
                },
                complete: function () {
                    lastTaskResult$.complete();
                },
            });
        }, 0);
        return lastTaskResult$;
    };
    /**
     * 显示错误信息
     */
    CommandHandler.prototype.displayError = function (error) {
        if (!console || !console.error) {
            return;
        }
        if (!error) {
            error = 'unknown error';
        }
        console.error(error);
    };
    /**
     * 添加任务，只有子类可以添加任务，外部不能访问
     * @param name  任务名称
     * @param func 任务函数
     */
    CommandHandler.prototype.addTask = function (name, func) {
        this.taskFlow.addNode(name, func);
    };
    /**
     * 添加任务，只有子类可以添加任务，外部不能访问
     * @param name  任务名称
     * @param func 任务函数
     */
    CommandHandler.prototype.addLink = function (from, to, condition) {
        this.taskFlow.addLink(from, to, condition);
    };
    /**
     * 插入任务
     * @param  name 要扩展的任务名称
     * @param  func 扩展函数
     */
    CommandHandler.prototype.insertTask = function (target, name, func) {
        throw new Error('Not Implemented');
    };
    /**
     * 插入任务
     * @param  name 要扩展的任务名称
     * @param  func 扩展函数
     */
    CommandHandler.prototype.afterTask = function (target, name, func) {
        throw new Error('Not Implemented');
    };
    /**
     * 替换任务
     * @param  name 要替换的任务名称
     * @param  func 替换函数
     */
    CommandHandler.prototype.replaceTask = function (name, func) {
        throw new Error('Not Implement');
    };
    /**
     * 调用方法
     */
    CommandHandler.prototype.invoke = function (serviceInstance, method, args, context) {
        this.setContextToServiceInstance(serviceInstance, context);
        var parsedArgs = this.parseService.parse(args, context);
        return serviceInstance[method].apply(serviceInstance, __spread(parsedArgs));
    };
    /**
     * 为服务设置命令上下文
     * @todo
     * 通过这种方式存在很大问题：
     * 1、会覆盖掉已有的context，给开发人员造成困扰和调试成本；
     * 2、服务中依赖了一个没有声明的对象，不符合面向对象的原则。
     * 建议解决方案：
     * 1、将context修改为某个特殊属性名；
     * 2、先检测服务上有没有一个CommandContext类型的context属性，有的话再赋值，
     *    这就要求需要使用context的服务需要是实现一个IContext接口。
     */
    CommandHandler.prototype.setContextToServiceInstance = function (serviceInstance, context) {
        // 如果服务上已经存在context属性，并且该属性不是CommandContext类型，则不能覆盖
        var serviceContext = serviceInstance.context;
        if (serviceContext && (serviceContext instanceof CommandContext === false)) {
            return;
        }
        serviceInstance.context = context;
    };
    return CommandHandler;
}());
/**
 * 命令处理器注入Token
 */
var COMMAND_HANDLERS_TOKEN = createInjectionToken('@Farris/devkit COMMAND_HANDLERS_TOKEN');

/**
 * 命令处理注册器相关定义
 * @author Witt<jiwt@inspur.com>
 */
/**
 * 命令处理注册器
 */
var CommandHandlerRegistry = /** @class */ (function () {
    /**
     * 构造函数
     * @param handlers 命令处理实例数组
     */
    function CommandHandlerRegistry(injector) {
        var _this = this;
        this.injector = injector;
        var handlers = this.injector.get(COMMAND_HANDLERS_TOKEN, null, InjectFlags.Optional);
        this.handlerMap = new Map();
        if (handlers) {
            handlers.forEach(function (handler) {
                _this.regist(handler);
            });
        }
    }
    /**
     * 添加命令处理
     * @param  commandName    命令名称
     * @param  commandHandler 命令处理实例
     */
    CommandHandlerRegistry.prototype.set = function (commandName, commandHandler) {
        if (this.handlerMap.has(commandName)) {
            throw new Error(commandName + '对应的CommandHandler已经存在');
        }
        this.handlerMap.set(commandName, commandHandler);
    };
    /**
     * 获取命令处理
     * @param   commandName 命令名称
     * @returns 命令处理实例
     */
    CommandHandlerRegistry.prototype.get = function (commandName) {
        if (this.handlerMap.has(commandName) === false) {
            throw new Error('找不到' + commandName + '对应的CommandHandler');
        }
        return this.handlerMap.get(commandName);
    };
    /**
     * 注册命令处理
     * @param handlers 命令处理实例
     */
    CommandHandlerRegistry.prototype.regist = function (commandHandler) {
        // 根据metadata获取对应的Command名称
        var handlerMetadata = MetadataUtil.getClassMetadataByName(commandHandler.constructor, COMMAND_HANDLER_META);
        if (!handlerMetadata) {
            throw new Error('CommandHandler必须指定要处理的命令名称');
        }
        var commandName = handlerMetadata.commandName;
        this.set(commandName, commandHandler);
    };
    return CommandHandlerRegistry;
}());

/**
 * 命令处理扩展相关
 * @author Witt<jiwt@inspur.com>
 */
var CommandHandlerExtender = /** @class */ (function () {
    function CommandHandlerExtender() {
    }
    return CommandHandlerExtender;
}());
/**
 * 命令处理器扩展注入Token
 */
var COMMAND_HANDLER_EXTENDERS_TOKEN = createInjectionToken('@farris/devkit COMMAND_HANDLER_EXTENDERS_TOKEN');

/**
 * 命令处理扩展注册器相关定义
 * @author Witt<jiwt@inspur.com>
 */
/**
 * 命令处理扩展注册器
 */
var CommandHandlerExtenderRegistry = /** @class */ (function () {
    /**
     * 构造函数
     * @param extenders 命令扩展实例数组
     */
    function CommandHandlerExtenderRegistry(injector) {
        var _this = this;
        this.injector = injector;
        var extenders = this.injector.get(COMMAND_HANDLER_EXTENDERS_TOKEN, null, InjectFlags.Optional);
        this.extendersMap = new Map();
        if (extenders) {
            extenders.forEach(function (extender) {
                _this.regist(extender);
            });
        }
    }
    /**
     * 获取命令扩展实例数组
     * @param   commandName 命令名称
     * @returns 命令处理扩展实例数组
     */
    CommandHandlerExtenderRegistry.prototype.get = function (commandName) {
        if (this.extendersMap.has(commandName) === false) {
            return [];
        }
        return this.extendersMap.get(commandName);
    };
    /**
     * 添加命令扩展
     * @param commandName Command名称
     * @param extender    CommandHandlerExtender实例
     * @return void
     */
    CommandHandlerExtenderRegistry.prototype.set = function (commandName, extender) {
        if (this.extendersMap.has(commandName)) {
            // 如果commandName对应的扩展已经存在，则在扩展数组中追加
            this.extendersMap.get(commandName).push(extender);
        }
        else {
            // 如果不存在，则创建新的扩展数组，并追加
            this.extendersMap.set(commandName, [extender]);
        }
    };
    /**
     * 注册命令扩展
     * @param extender CommandHandlerExtender实例
     */
    CommandHandlerExtenderRegistry.prototype.regist = function (extender) {
        // 通过元数据获取要扩展的Comamnd名称
        var extenderMetadata = MetadataUtil.getClassMetadataByName(extender.constructor, COMMAND_HANDLER_EXTENDER_META);
        if (!extenderMetadata) {
            throw new Error('CommandHandlerExtender必须指定要扩展的命令名称');
        }
        var commandName = extenderMetadata.commandName;
        // 添加到Map中
        this.set(commandName, extender);
    };
    return CommandHandlerExtenderRegistry;
}());

/**
 * 命令处理器工厂相关定义
 * @author Witt<jiwt@inspur.com>
 */
/**
 * 命令处理器工厂
 */
var CommandHandlerFactory = /** @class */ (function () {
    /**
     * 构造函数
     * @param handlerRegistry  命令处理注册器
     * @param extenderRegistry 命令处理扩展注册器
     */
    function CommandHandlerFactory(handlerRegistry, extenderRegistry, viewModelContext) {
        this.handlerRegistry = handlerRegistry;
        this.extenderRegistry = extenderRegistry;
        this.viewModelContext = viewModelContext;
    }
    /**
     * 创建命令处理器
     * @param   commandName 命令名称
     * @returns 对应的命令处理器实例
     */
    CommandHandlerFactory.prototype.create = function (commandName) {
        var rawHandler = this.handlerRegistry.get(commandName);
        rawHandler.init(this.viewModelContext);
        var extenders = this.extenderRegistry.get(commandName);
        // 遍历extenders，依次对handler进行扩展
        return extenders.reduce(function (handler, extender) {
            return extender.extend(handler);
        }, rawHandler);
    };
    return CommandHandlerFactory;
}());

/**
 * CommandBus相关定义
 * @author Witt<jiwt@inspur.com>
 */
/**
 * CommandBus用于派发Command，它接受一个Command实例，查找对应的CommandHandler，并执行。
 */
var CommandBus = /** @class */ (function () {
    /**
     * 构造函数
     */
    function CommandBus(handlerFactory) {
        this.handlerFactory = handlerFactory;
        this.executingCommands = [];
        this.executingCommandCount$ = new BehaviorSubject(this.executingCommands.length);
    }
    /**
     * 派发命令
     * @param command 要派发的命令
     */
    CommandBus.prototype.dispatch = function (command) {
        var _this = this;
        var commandResult$ = new Subject();
        this.executeCommand(command).subscribe({
            next: function (lastTaskResult) {
                commandResult$.next(lastTaskResult);
                commandResult$.complete();
            },
            complete: function () {
                commandResult$.complete();
                _this.removeCommandFromExecutingQueue(command);
            },
            error: function (error) {
                commandResult$.error(error);
                _this.removeCommandFromExecutingQueue(command);
            }
        });
        return commandResult$;
    };
    /**
     * 执行命令并返回最后一个任务的执行结果流
     */
    CommandBus.prototype.executeCommand = function (command) {
        this.addCommandToExecutingQueue(command);
        var commandName = command.name;
        var handler = this.handlerFactory.create(commandName);
        var lastTaskResult$ = handler.execute(command);
        return lastTaskResult$;
    };
    /**
     * 添加到执行队列
     */
    CommandBus.prototype.addCommandToExecutingQueue = function (command) {
        this.executingCommands.push(command);
        this.executingCommandCount$.next(this.executingCommands.length);
    };
    /**
     * 从执行队列中移除
     */
    CommandBus.prototype.removeCommandFromExecutingQueue = function (command) {
        this.executingCommands = this.executingCommands.filter(function (executingCommand) {
            return executingCommand !== command;
        });
        this.executingCommandCount$.next(this.executingCommands.length);
    };
    return CommandBus;
}());

var VIEW_MODEL_COMMAND_PROVIDERS = [
    {
        provide: CommandHandlerRegistry,
        useClass: CommandHandlerRegistry,
        deps: [Injector]
    },
    {
        provide: CommandHandlerExtenderRegistry,
        useClass: CommandHandlerExtenderRegistry,
        deps: [Injector]
    },
    {
        provide: CommandHandlerFactory,
        useClass: CommandHandlerFactory,
        deps: [CommandHandlerRegistry, CommandHandlerExtenderRegistry, ViewModelContext]
    },
    {
        provide: CommandBus,
        useClass: CommandBus,
        deps: [CommandHandlerFactory]
    }
];

/*
 * @Author: aalizzwell
 * @Date: 2019-05-30 11:08:18
 * @Last Modified by: aalizzwell
 * @Last Modified time: 2019-06-01 17:10:04
 */
var EXCEPTION_HANDLER = '@farris/devkit ExceptionHandler';

/**
 * Generated bundle index. Do not edit.
 */

export { ACTION_METHOD_META, ANNOTATIONS, APP_VARIABLE_PROVIDERS, ASSIGNER_TOKEN, ActionMethodMeta, App, AppContext, AppOptions, ArrayStringValueConverter, ArrayUtil, BACK_END_MESSAGE_HANDLER_TOKEN, BackEndMessage, BigNumberType, BindingData, BindingDataAppendObjectEventHandler, BindingDataChangeListener, BindingDataFactory, BindingDataLoadEventHandler, BindingDataManager, BindingDataRemoveObjectEventHandler, BindingDataSelectionChangedEventHandler, BindingDataValueChangeEventHandler, BindingList, BindingListFactory, BindingObject, BindingObjectFactory, BindingPathComparer, BindingPathConverter, BindingPathTraverser, BindingPropertyType, BindingType, BindingValueAccessorFactory, BoolUtil, COMMAND_HANDLERS_TOKEN, COMMAND_HANDLER_EXTENDERS_TOKEN, COMMAND_HANDLER_EXTENDER_META, COMMAND_HANDLER_META, COMMAND_METHOD_META, CONTROLSTATE_PROP_META, CONTROL_STATE_INTERCEPTOR_TOKEN, ChangeSet, ChangeType, CommandBus, CommandContext, CommandHandler, CommandHandlerExtender, CommandHandlerExtenderMeta, CommandHandlerExtenderRegistry, CommandHandlerFactory, CommandHandlerMeta, CommandHandlerRegistry, CommandMethodMeta, CommandVariableParser, CommentDependencyResolver, Context, ControlStateInterceptorService, ControlStatePropMeta, ControlsProxy, Core, DYNAMIC_PROP_META, DataChangeType, DataPath, DataPathCreator, DataPathNode, DataPathNodeType, DataPathUtil, DataPropGroup, DataPropInfo, DataTypeInfo, DataVariableParser, DateStringValueConverter, DateUtil, DefaultRepository, DependencyEffector, DynamicEntity, DynamicPropMeta, EFFECTOR_TOKEN, ENTITY_META, ENTITY_TEMPLATE, EVENT_HANDLER_TOKEN, EXCEPTION_HANDLER, EffectorFactory, EffectorRegistry, Entity, EntityBindingValueAccessor, EntityCollection, EntityDependencyResolver, EntityFactory, EntityList, EntityManager, EntityMeta, EntityMetadataUtil, EntityPathComparer, EntityPathConverter, EntityUpdateEventHandler, EntityUtil, EntityValueChangedEventHandler, EnumUtil, EnvUtil, EventHandler, EventHandlerRegistry, Expression, ExpressionEngineImpl, ExpressionEventEmitter, ExpressionExecutor, ExpressionManager, ExpressionRegistry, ExpressionResult, ExpressionResultFactory, ExpressionUtil, FORM_CONTROL_PROP_META, FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN, FORM_MANIFEST_SERVICE_TOKEN, FORM_PATH_TOKEN, FieldMetadataUtil, Form, FormControl, FormControlPropMeta, FormPathConverter, GROUP_FUNCTIONS, Guid, HTTP_PROVIDERS, HttpClient, HttpMethods, HttpUtil, INJECTOR, INJECTOR_IMPL, INJECTOR_IMPL__PRE_R3__, INJECTOR_SCOPE, InitContext, InjectFlags, InjectionToken, Injector, InterceptContext, LISTENER_TOKEN, LIST_PROP_META, ListPropMeta, ListenerRegistry, Listeners, MESSAGE_SERVICE_TOKEN, MetadataUtil, Modification, ModifyType, NAMESPACE, NOTIFY_SERVICE_TOKEN, NumberUtil, OBJECT_PROP_META, ObjectPropMeta, ObjectUtil, PARAMETERS, PARENT_CLASS, PARENT_PATH, PRIMITIVE_PROP_META, PROP_METADATA, PrimitivePropMeta, ProcessContext, PropertyUtil, RENDER_STATE_PROP_META, REPOSITORY_META, RESOLVER_TOKEN, ReadonlyEffector, RenderStatePropMeta, Repository, RepositoryAddEntityEventHandler, RepositoryChangeListener, RepositoryEffector, RepositoryLoadEventHandler, RepositoryManager, RepositoryMeta, RepositoryRemoveEntityEventHandler, RequiredEffector, ResolveService, ResolverRegistry, STATE_PROP_META, STATE_TEMPLATE, State, StateDependencyResolver, StateMachine, StateMachineContext, StateMachineVariableParser, StatePropMeta, StateValueChangedEventHandler, StaticInjector, StringUtil, TaskFlow, TaskLink, TaskNode, Type, UISTATE_PROP_META, UIState, UIStateBindingValueAccessor, UIStateChangeListener, UIStateEffector, UIStateMetadataUtil, UIStatePropMeta, UIStateVariableParser, USE_VALUE, UrlUtil, VALIDATION_RULE_TOKEN, VARIABLE_PARSERS, VIEW_MODEL_COMMAND_PROVIDERS, VIEW_MODEL_EXPRESSION_PROVIDERS, ValidateEffector, ValidatorFactory, VariableParseService, ViewChangeType, ViewModel, ViewModelContext, ViewModelContextManager, ViewModelOptions, VisibleEffector, createEntities, createEntity, createInjectionToken, createInjector, initialUIState, isObservable, isType, makeDecorator, makeParamDecorator, makePropDecorator, setCurrentInjector, ɵ0, getClosureSafeProperty as ɵa, Injector as ɵb, createInjectionToken as ɵc, AppEventBus as ɵd, ChangeListener as ɵe };
//# sourceMappingURL=farris-mobile-devkit.js.map
