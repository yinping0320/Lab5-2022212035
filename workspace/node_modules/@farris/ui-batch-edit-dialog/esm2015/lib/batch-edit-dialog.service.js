/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, ComponentFactoryResolver, Injector, EventEmitter } from '@angular/core';
import { BatchEditDialogComponent } from './batch-edit-dialog.component';
import { BsModalService } from '@farris/ui-modal';
import { LocaleService } from '@farris/ui-locale';
import { of, Subject } from 'rxjs';
import { ResultConfirmComponent } from './result-confirm/result-confirm.component';
// tslint:disable: max-line-length
export class BatchEditDialogService {
    /**
     * @param {?} injector
     * @param {?} modalService
     * @param {?} componentFactoryResolver
     * @param {?} localeService
     */
    constructor(injector, modalService, componentFactoryResolver, localeService) {
        this.injector = injector;
        this.modalService = modalService;
        this.componentFactoryResolver = componentFactoryResolver;
        this.localeService = localeService;
        this.dialogRef = null;
        this.componentRef = null;
        // 用户对输入进行确认，此时可以更新bindingData数据
        this.onUserConfirmed = new EventEmitter();
    }
    /**
     * \@description 控件参数格式
     * # 控件参数格式
     * ## textbox
     * ```json
     * {"title":"姓名","field":"name","editor":{"controlType":EditorTypes.TEXTBOX}}
     * ```
     * ## dropdown
     * ```json
     * {"title":"姓名","field":"name","editor":{"controlType":EditorTypes.COMBOLIST,"idField":"id","textField":"text","items":[],"multiSelect":false}}
     * ```
     * ## lookup
     * ```json
     * {"title":"姓名","field":"name","editor":{"controlType":EditorTypes.LOOKUP,"uri":"","idField":"id","textField":"text","valueField":"id","displayType":"LIST","mapFields":{},"singleSelect":true,"dialogTitle":"","hiddenInputName":"","items":[],"multiSelect":false}}
     * ```
     * ## 数值输入框
     * ```json
     * {"title":"数值","field":"name","editor":{"controlType":EditorTypes.NUMBER,"precision":2,"step":1,"min":1,"max":10}}
     * ```
     * @param {?} columns
     * @param {?=} options
     * @return {?}
     */
    batchEdit(columns, options) {
        /** @type {?} */
        const titleText = this.localeService.getValue('batchEditDialog.title');
        /** @type {?} */
        const okText = this.localeService.getValue('batchEditDialog.okText');
        /** @type {?} */
        const cancelText = this.localeService.getValue('batchEditDialog.cancelText');
        const { width = 792, height = 580, title = titleText, rows = 1 } = options || {};
        /** @type {?} */
        const componentFactory = this.componentFactoryResolver.resolveComponentFactory(BatchEditDialogComponent);
        this.componentRef = componentFactory.create(this.injector);
        this.componentRef.instance.fields = this.getFields(columns);
        this.componentRef.instance.eidtors = this.getEditors(columns);
        this.componentRef.instance.title = title;
        this.componentRef.instance.rows = rows;
        this.dialogRef = this.modalService.show(this.componentRef, {
            title,
            width,
            height,
            buttons: [
                {
                    text: cancelText, cls: 'btn btn-secondary', handle: (/**
                     * @return {?}
                     */
                    () => {
                        this.dialogRef.close();
                    })
                },
                {
                    text: okText, cls: 'btn btn-primary',
                    handle: (/**
                     * @return {?}
                     */
                    () => {
                        this.userConfired();
                    })
                }
            ],
            showHeader: false,
            showButtons: false,
        });
        this.componentRef.instance.confirmed.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            this.canConfirm(options).subscribe((/**
             * @param {?} result
             * @return {?}
             */
            (result) => {
                if (result === true) {
                    this.userConfired(options);
                    this.dialogRef.close();
                }
            }));
        }));
        this.componentRef.instance.canceled.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            this.dialogRef.close();
        }));
        this.componentRef.instance.dialogRef = this.dialogRef;
        this.dialogRef.dialog.instance.draggbar.handle = this.componentRef.instance.header.nativeElement;
        return this.dialogRef;
    }
    /**
     * 用户确认修改
     * @param {?=} options
     * @return {?}
     */
    userConfired(options) {
        /** @type {?} */
        const inputs = this.componentRef && this.componentRef.instance && this.componentRef.instance.inputs || [];
        // 针对checkbox做特殊处理
        if (inputs && inputs.length > 0) {
            inputs.forEach((/**
             * @param {?} input
             * @return {?}
             */
            input => {
                const { controlType, dataType } = input;
                if (controlType === 'checkbox' && dataType === 'boolean') {
                    input.value = input.value ? true : false;
                }
            }));
        }
        if (options && options.onConfirm && typeof options.onConfirm === 'function') {
            options.onConfirm(inputs);
        }
        this.onUserConfirmed.next(inputs);
    }
    /**
     * 从dom中获取grid列
     * @private
     * @param {?} columns dom
     * @return {?}
     */
    getFields(columns) {
        /** @type {?} */
        const fields = [];
        if (!columns || columns.length < 1) {
            return fields;
        }
        columns.forEach((/**
         * @param {?} collect
         * @return {?}
         */
        (collect) => {
            // collect为数组
            if (collect && collect.length > 0) {
                collect.forEach((/**
                 * @param {?} column
                 * @return {?}
                 */
                (column) => {
                    const { field = null, title = '', dataType = null, enableBatchEdit = false } = column || {};
                    if (field && enableBatchEdit) {
                        fields.push({ id: field, label: title, dataType });
                    }
                }));
            }
        }));
        return fields;
    }
    /**
     * 从columns中获取编辑器
     * @private
     * @param {?} columns dom
     * @return {?}
     */
    getEditors(columns) {
        /** @type {?} */
        const editors = [];
        if (!columns || columns.length < 1) {
            return editors;
        }
        columns.forEach((/**
         * @param {?} collect
         * @return {?}
         */
        (collect) => {
            // collect为数组
            if (collect && collect.length > 0) {
                collect.forEach((/**
                 * @param {?} column
                 * @return {?}
                 */
                (column) => {
                    const { field = null, editor = {}, enableBatchEdit = false } = column || {};
                    if (editor && field && enableBatchEdit) {
                        editor.controlType = editor.type;
                        editors.push({ field, editor });
                    }
                }));
            }
        }));
        return editors;
    }
    /**
     * @private
     * @param {?=} options
     * @return {?}
     */
    canConfirm(options) {
        /** @type {?} */
        const subject = new Subject();
        /** @type {?} */
        let showNotify = options && options.showNotify;
        const { rows = 1 } = options || {};
        /** @type {?} */
        const valueChanged = this.isValueChanged();
        if (!valueChanged) {
            return of(true);
        }
        if (showNotify === undefined) {
            showNotify = true;
        }
        if (!showNotify) {
            return of(true);
        }
        /** @type {?} */
        let dialogRef = null;
        try {
            /** @type {?} */
            const componentFactory = this.componentFactoryResolver.resolveComponentFactory(ResultConfirmComponent);
            /** @type {?} */
            const componentRef = componentFactory.create(this.injector);
            /** @type {?} */
            const shouldShowNotify = componentRef.instance.showNotify || false;
            componentRef.instance.rows = rows;
            if (shouldShowNotify) {
                dialogRef = this.modalService.show(componentRef, {
                    title: '',
                    width: 500,
                    height: 240,
                    showHeader: false,
                    showButtons: false,
                    buttons: []
                });
                // 确认
                componentRef.instance.confirmed.subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                    if (dialogRef) {
                        dialogRef.close();
                    }
                    subject.next(true);
                }));
                // 取消
                componentRef.instance.canceled.subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                    if (dialogRef) {
                        dialogRef.close();
                    }
                    subject.next(false);
                }));
            }
            else {
                return of(true);
            }
        }
        catch (e) {
            return of(true);
        }
        return subject;
    }
    /**
     * @return {?}
     */
    isValueChanged() {
        /** @type {?} */
        const inputs = this.componentRef && this.componentRef.instance && this.componentRef.instance.inputs || [];
        if (!inputs || inputs.length < 1) {
            return false;
        }
        /** @type {?} */
        const unChanged = inputs.every((/**
         * @param {?} item
         * @return {?}
         */
        (item) => !item.field));
        return !unChanged;
    }
}
BatchEditDialogService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BatchEditDialogService.ctorParameters = () => [
    { type: Injector },
    { type: BsModalService },
    { type: ComponentFactoryResolver },
    { type: LocaleService }
];
if (false) {
    /** @type {?} */
    BatchEditDialogService.prototype.dialogRef;
    /**
     * @type {?}
     * @private
     */
    BatchEditDialogService.prototype.componentRef;
    /** @type {?} */
    BatchEditDialogService.prototype.onUserConfirmed;
    /** @type {?} */
    BatchEditDialogService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    BatchEditDialogService.prototype.modalService;
    /**
     * @type {?}
     * @private
     */
    BatchEditDialogService.prototype.componentFactoryResolver;
    /**
     * @type {?}
     * @private
     */
    BatchEditDialogService.prototype.localeService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmF0Y2gtZWRpdC1kaWFsb2cuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktYmF0Y2gtZWRpdC1kaWFsb2cvIiwic291cmNlcyI6WyJsaWIvYmF0Y2gtZWRpdC1kaWFsb2cuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSx3QkFBd0IsRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFnQixNQUFNLGVBQWUsQ0FBQztBQUMzRyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsY0FBYyxFQUFjLE1BQU0sa0JBQWtCLENBQUM7QUFDOUQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ2xELE9BQU8sRUFBNEIsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM3RCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQzs7QUFHbkYsTUFBTSxPQUFPLHNCQUFzQjs7Ozs7OztJQUtqQyxZQUNTLFFBQWtCLEVBQ2pCLFlBQTRCLEVBQzVCLHdCQUFrRCxFQUNsRCxhQUE0QjtRQUg3QixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2pCLGlCQUFZLEdBQVosWUFBWSxDQUFnQjtRQUM1Qiw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQTBCO1FBQ2xELGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBUi9CLGNBQVMsR0FBZSxJQUFJLENBQUM7UUFDNUIsaUJBQVksR0FBMkMsSUFBSSxDQUFDOztRQUU3RCxvQkFBZSxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO0lBTWhFLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztJQXFCRSxTQUFTLENBQUMsT0FBWSxFQUFFLE9BQXFDOztjQUM1RCxTQUFTLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsdUJBQXVCLENBQUM7O2NBQ2hFLE1B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Ozs7WUEzTUYsVUFBVTs7OztZQVBvQyxRQUFRO1lBRTlDLGNBQWM7WUFGRix3QkFBd0I7WUFHcEMsYUFBYTs7OztJQU1wQiwyQ0FBb0M7Ozs7O0lBQ3BDLDhDQUFvRTs7SUFFcEUsaURBQW9FOztJQUVsRSwwQ0FBeUI7Ozs7O0lBQ3pCLDhDQUFvQzs7Ozs7SUFDcEMsMERBQTBEOzs7OztJQUMxRCwrQ0FBb0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIEluamVjdG9yLCBFdmVudEVtaXR0ZXIsIENvbXBvbmVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBCYXRjaEVkaXREaWFsb2dDb21wb25lbnQgfSBmcm9tICcuL2JhdGNoLWVkaXQtZGlhbG9nLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IEJzTW9kYWxTZXJ2aWNlLCBCc01vZGFsUmVmIH0gZnJvbSAnQGZhcnJpcy91aS1tb2RhbCc7XHJcbmltcG9ydCB7IExvY2FsZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWxvY2FsZSc7XHJcbmltcG9ydCB7IGlzT2JzZXJ2YWJsZSwgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgUmVzdWx0Q29uZmlybUNvbXBvbmVudCB9IGZyb20gJy4vcmVzdWx0LWNvbmZpcm0vcmVzdWx0LWNvbmZpcm0uY29tcG9uZW50JztcclxuLy8gdHNsaW50OmRpc2FibGU6IG1heC1saW5lLWxlbmd0aFxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBCYXRjaEVkaXREaWFsb2dTZXJ2aWNlIHtcclxuICBwdWJsaWMgZGlhbG9nUmVmOiBCc01vZGFsUmVmID0gbnVsbDtcclxuICBwcml2YXRlIGNvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPEJhdGNoRWRpdERpYWxvZ0NvbXBvbmVudD4gPSBudWxsO1xyXG4gIC8vIOeUqOaIt+Wvuei+k+WFpei/m+ihjOehruiupO+8jOatpOaXtuWPr+S7peabtOaWsGJpbmRpbmdEYXRh5pWw5o2uXHJcbiAgcHVibGljIG9uVXNlckNvbmZpcm1lZDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHB1YmxpYyBpbmplY3RvcjogSW5qZWN0b3IsXHJcbiAgICBwcml2YXRlIG1vZGFsU2VydmljZTogQnNNb2RhbFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxyXG4gICAgcHJpdmF0ZSBsb2NhbGVTZXJ2aWNlOiBMb2NhbGVTZXJ2aWNlLFxyXG4gICkgeyB9XHJcbiAgLyoqXHJcbiAgICogQGRlc2NyaXB0aW9uIOaOp+S7tuWPguaVsOagvOW8j1xyXG4gICAqICMg5o6n5Lu25Y+C5pWw5qC85byPXHJcbiAgICogIyMgdGV4dGJveFxyXG4gICAqIGBgYGpzb25cclxuICAgKiB7XCJ0aXRsZVwiOlwi5aeT5ZCNXCIsXCJmaWVsZFwiOlwibmFtZVwiLFwiZWRpdG9yXCI6e1wiY29udHJvbFR5cGVcIjpFZGl0b3JUeXBlcy5URVhUQk9YfX1cclxuICAgKiBgYGBcclxuICAgKiAjIyBkcm9wZG93blxyXG4gICAqIGBgYGpzb25cclxuICAgKiB7XCJ0aXRsZVwiOlwi5aeT5ZCNXCIsXCJmaWVsZFwiOlwibmFtZVwiLFwiZWRpdG9yXCI6e1wiY29udHJvbFR5cGVcIjpFZGl0b3JUeXBlcy5DT01CT0xJU1QsXCJpZEZpZWxkXCI6XCJpZFwiLFwidGV4dEZpZWxkXCI6XCJ0ZXh0XCIsXCJpdGVtc1wiOltdLFwibXVsdGlTZWxlY3RcIjpmYWxzZX19XHJcbiAgICogYGBgXHJcbiAgICogIyMgbG9va3VwXHJcbiAgICogYGBganNvblxyXG4gICAqIHtcInRpdGxlXCI6XCLlp5PlkI1cIixcImZpZWxkXCI6XCJuYW1lXCIsXCJlZGl0b3JcIjp7XCJjb250cm9sVHlwZVwiOkVkaXRvclR5cGVzLkxPT0tVUCxcInVyaVwiOlwiXCIsXCJpZEZpZWxkXCI6XCJpZFwiLFwidGV4dEZpZWxkXCI6XCJ0ZXh0XCIsXCJ2YWx1ZUZpZWxkXCI6XCJpZFwiLFwiZGlzcGxheVR5cGVcIjpcIkxJU1RcIixcIm1hcEZpZWxkc1wiOnt9LFwic2luZ2xlU2VsZWN0XCI6dHJ1ZSxcImRpYWxvZ1RpdGxlXCI6XCJcIixcImhpZGRlbklucHV0TmFtZVwiOlwiXCIsXCJpdGVtc1wiOltdLFwibXVsdGlTZWxlY3RcIjpmYWxzZX19XHJcbiAgICogYGBgXHJcbiAgICogIyMg5pWw5YC86L6T5YWl5qGGXHJcbiAgICogYGBganNvblxyXG4gICAqIHtcInRpdGxlXCI6XCLmlbDlgLxcIixcImZpZWxkXCI6XCJuYW1lXCIsXCJlZGl0b3JcIjp7XCJjb250cm9sVHlwZVwiOkVkaXRvclR5cGVzLk5VTUJFUixcInByZWNpc2lvblwiOjIsXCJzdGVwXCI6MSxcIm1pblwiOjEsXCJtYXhcIjoxMH19XHJcbiAgICogYGBgXHJcbiAgICovXHJcbiAgcHVibGljIGJhdGNoRWRpdChjb2x1bW5zOiBhbnksIG9wdGlvbnM/OiB7IFtwcm9wTmFtZTogc3RyaW5nXTogYW55IH0pOiBCc01vZGFsUmVmIHtcclxuICAgIGNvbnN0IHRpdGxlVGV4dCA9IHRoaXMubG9jYWxlU2VydmljZS5nZXRWYWx1ZSgnYmF0Y2hFZGl0RGlhbG9nLnRpdGxlJyk7XHJcbiAgICBjb25zdCBva1RleHQgPSB0aGlzLmxvY2FsZVNlcnZpY2UuZ2V0VmFsdWUoJ2JhdGNoRWRpdERpYWxvZy5va1RleHQnKTtcclxuICAgIGNvbnN0IGNhbmNlbFRleHQgPSB0aGlzLmxvY2FsZVNlcnZpY2UuZ2V0VmFsdWUoJ2JhdGNoRWRpdERpYWxvZy5jYW5jZWxUZXh0Jyk7XHJcbiAgICBjb25zdCB7IHdpZHRoID0gNzkyLCBoZWlnaHQgPSA1ODAsIHRpdGxlID0gdGl0bGVUZXh0LCByb3dzID0gMSB9ID0gb3B0aW9ucyB8fCB7fTtcclxuICAgIGNvbnN0IGNvbXBvbmVudEZhY3RvcnkgPSB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShCYXRjaEVkaXREaWFsb2dDb21wb25lbnQpO1xyXG4gICAgdGhpcy5jb21wb25lbnRSZWYgPSBjb21wb25lbnRGYWN0b3J5LmNyZWF0ZSh0aGlzLmluamVjdG9yKTtcclxuICAgIHRoaXMuY29tcG9uZW50UmVmLmluc3RhbmNlLmZpZWxkcyA9IHRoaXMuZ2V0RmllbGRzKGNvbHVtbnMpO1xyXG4gICAgdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UuZWlkdG9ycyA9IHRoaXMuZ2V0RWRpdG9ycyhjb2x1bW5zKTtcclxuICAgIHRoaXMuY29tcG9uZW50UmVmLmluc3RhbmNlLnRpdGxlID0gdGl0bGU7XHJcbiAgICB0aGlzLmNvbXBvbmVudFJlZi5pbnN0YW5jZS5yb3dzID0gcm93cztcclxuXHJcbiAgICB0aGlzLmRpYWxvZ1JlZiA9IHRoaXMubW9kYWxTZXJ2aWNlLnNob3codGhpcy5jb21wb25lbnRSZWYsIHtcclxuICAgICAgdGl0bGUsXHJcbiAgICAgIHdpZHRoLFxyXG4gICAgICBoZWlnaHQsXHJcbiAgICAgIGJ1dHRvbnM6IFtcclxuICAgICAgICB7XHJcbiAgICAgICAgICB0ZXh0OiBjYW5jZWxUZXh0LCBjbHM6ICdidG4gYnRuLXNlY29uZGFyeScsIGhhbmRsZTogKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmRpYWxvZ1JlZi5jbG9zZSgpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgdGV4dDogb2tUZXh0LCBjbHM6ICdidG4gYnRuLXByaW1hcnknLFxyXG4gICAgICAgICAgaGFuZGxlOiAoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMudXNlckNvbmZpcmVkKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICBdLFxyXG4gICAgICBzaG93SGVhZGVyOiBmYWxzZSxcclxuICAgICAgc2hvd0J1dHRvbnM6IGZhbHNlLFxyXG4gICAgfSk7XHJcbiAgICB0aGlzLmNvbXBvbmVudFJlZi5pbnN0YW5jZS5jb25maXJtZWQuc3Vic2NyaWJlKChlOiB7IGluc3RhbmNlOiBhbnksIGV2ZW50OiBhbnkgfSkgPT4ge1xyXG4gICAgICB0aGlzLmNhbkNvbmZpcm0ob3B0aW9ucykuc3Vic2NyaWJlKChyZXN1bHQ6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBpZiAocmVzdWx0ID09PSB0cnVlKSB7XHJcbiAgICAgICAgICB0aGlzLnVzZXJDb25maXJlZChvcHRpb25zKTtcclxuICAgICAgICAgIHRoaXMuZGlhbG9nUmVmLmNsb3NlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UuY2FuY2VsZWQuc3Vic2NyaWJlKChlOiB7IGluc3RhbmNlOiBhbnksIGV2ZW50OiBhbnkgfSkgPT4ge1xyXG4gICAgICB0aGlzLmRpYWxvZ1JlZi5jbG9zZSgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UuZGlhbG9nUmVmID0gdGhpcy5kaWFsb2dSZWY7XHJcbiAgICB0aGlzLmRpYWxvZ1JlZi5kaWFsb2cuaW5zdGFuY2UuZHJhZ2diYXIuaGFuZGxlID0gdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UuaGVhZGVyLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICByZXR1cm4gdGhpcy5kaWFsb2dSZWY7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOeUqOaIt+ehruiupOS/ruaUuVxyXG4gICAqL1xyXG4gIHB1YmxpYyB1c2VyQ29uZmlyZWQob3B0aW9ucz86IHsgW3Byb3BOYW1lOiBzdHJpbmddOiBhbnkgfSkge1xyXG4gICAgY29uc3QgaW5wdXRzID0gdGhpcy5jb21wb25lbnRSZWYgJiYgdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UgJiYgdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UuaW5wdXRzIHx8IFtdO1xyXG4gICAgLy8g6ZKI5a+5Y2hlY2tib3jlgZrnibnmrorlpITnkIZcclxuICAgIGlmIChpbnB1dHMgJiYgaW5wdXRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgaW5wdXRzLmZvckVhY2goaW5wdXQgPT4ge1xyXG4gICAgICAgIGNvbnN0IHsgY29udHJvbFR5cGUsIGRhdGFUeXBlIH0gPSBpbnB1dDtcclxuICAgICAgICBpZiAoY29udHJvbFR5cGUgPT09ICdjaGVja2JveCcgJiYgZGF0YVR5cGUgPT09ICdib29sZWFuJykge1xyXG4gICAgICAgICAgaW5wdXQudmFsdWUgPSBpbnB1dC52YWx1ZSA/IHRydWUgOiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5vbkNvbmZpcm0gJiYgdHlwZW9mIG9wdGlvbnMub25Db25maXJtID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIG9wdGlvbnMub25Db25maXJtKGlucHV0cyk7XHJcbiAgICB9XHJcbiAgICB0aGlzLm9uVXNlckNvbmZpcm1lZC5uZXh0KGlucHV0cyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOS7jmRvbeS4reiOt+WPlmdyaWTliJdcclxuICAgKiBAcGFyYW0gY29sdW1ucyBkb21cclxuICAgKi9cclxuICBwcml2YXRlIGdldEZpZWxkcyhjb2x1bW5zOiBhbnkpOiBBcnJheTxhbnk+IHtcclxuICAgIGNvbnN0IGZpZWxkcyA9IFtdO1xyXG4gICAgaWYgKCFjb2x1bW5zIHx8IGNvbHVtbnMubGVuZ3RoIDwgMSkge1xyXG4gICAgICByZXR1cm4gZmllbGRzO1xyXG4gICAgfVxyXG4gICAgY29sdW1ucy5mb3JFYWNoKChjb2xsZWN0OiBBcnJheTxhbnk+KSA9PiB7XHJcbiAgICAgIC8vIGNvbGxlY3TkuLrmlbDnu4RcclxuICAgICAgaWYgKGNvbGxlY3QgJiYgY29sbGVjdC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgY29sbGVjdC5mb3JFYWNoKChjb2x1bW46IGFueSkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgeyBmaWVsZCA9IG51bGwsIHRpdGxlID0gJycsIGRhdGFUeXBlID0gbnVsbCwgZW5hYmxlQmF0Y2hFZGl0ID0gZmFsc2UgfSA9IGNvbHVtbiB8fCB7fTtcclxuICAgICAgICAgIGlmIChmaWVsZCAmJiBlbmFibGVCYXRjaEVkaXQpIHtcclxuICAgICAgICAgICAgZmllbGRzLnB1c2goeyBpZDogZmllbGQsIGxhYmVsOiB0aXRsZSwgZGF0YVR5cGUgfSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGZpZWxkcztcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5LuOY29sdW1uc+S4reiOt+WPlue8lui+keWZqFxyXG4gICAqIEBwYXJhbSBjb2x1bW5zIGRvbVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RWRpdG9ycyhjb2x1bW5zOiBhbnkpOiBBcnJheTxhbnk+IHtcclxuICAgIGNvbnN0IGVkaXRvcnMgPSBbXTtcclxuICAgIGlmICghY29sdW1ucyB8fCBjb2x1bW5zLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIGVkaXRvcnM7XHJcbiAgICB9XHJcbiAgICBjb2x1bW5zLmZvckVhY2goKGNvbGxlY3Q6IEFycmF5PGFueT4pID0+IHtcclxuICAgICAgLy8gY29sbGVjdOS4uuaVsOe7hFxyXG4gICAgICBpZiAoY29sbGVjdCAmJiBjb2xsZWN0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb2xsZWN0LmZvckVhY2goKGNvbHVtbjogYW55KSA9PiB7XHJcbiAgICAgICAgICBjb25zdCB7IGZpZWxkID0gbnVsbCwgZWRpdG9yID0ge30sIGVuYWJsZUJhdGNoRWRpdCA9IGZhbHNlIH0gPSBjb2x1bW4gfHwge307XHJcbiAgICAgICAgICBpZiAoZWRpdG9yICYmIGZpZWxkICYmIGVuYWJsZUJhdGNoRWRpdCkge1xyXG4gICAgICAgICAgICBlZGl0b3IuY29udHJvbFR5cGUgPSBlZGl0b3IudHlwZTtcclxuICAgICAgICAgICAgZWRpdG9ycy5wdXNoKHsgZmllbGQsIGVkaXRvciB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gZWRpdG9ycztcclxuICB9XHJcbiAgcHJpdmF0ZSBjYW5Db25maXJtKG9wdGlvbnM/OiB7IFtwcm9wTmFtZTogc3RyaW5nXTogYW55IH0pIHtcclxuICAgIGNvbnN0IHN1YmplY3QgPSBuZXcgU3ViamVjdDxhbnk+KCk7XHJcbiAgICBsZXQgc2hvd05vdGlmeSA9IG9wdGlvbnMgJiYgb3B0aW9ucy5zaG93Tm90aWZ5O1xyXG4gICAgY29uc3QgeyByb3dzID0gMSB9ID0gb3B0aW9ucyB8fCB7fTtcclxuICAgIGNvbnN0IHZhbHVlQ2hhbmdlZCA9IHRoaXMuaXNWYWx1ZUNoYW5nZWQoKTtcclxuICAgIGlmICghdmFsdWVDaGFuZ2VkKSB7XHJcbiAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgIH1cclxuICAgIGlmIChzaG93Tm90aWZ5ID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgc2hvd05vdGlmeSA9IHRydWU7XHJcbiAgICB9XHJcbiAgICBpZiAoIXNob3dOb3RpZnkpIHtcclxuICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgfVxyXG4gICAgbGV0IGRpYWxvZ1JlZiA9IG51bGw7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBjb21wb25lbnRGYWN0b3J5ID0gdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoUmVzdWx0Q29uZmlybUNvbXBvbmVudCk7XHJcbiAgICAgIGNvbnN0IGNvbXBvbmVudFJlZiA9IGNvbXBvbmVudEZhY3RvcnkuY3JlYXRlKHRoaXMuaW5qZWN0b3IpO1xyXG4gICAgICBjb25zdCBzaG91bGRTaG93Tm90aWZ5ID0gY29tcG9uZW50UmVmLmluc3RhbmNlLnNob3dOb3RpZnkgfHwgZmFsc2U7XHJcblxyXG4gICAgICBjb21wb25lbnRSZWYuaW5zdGFuY2Uucm93cyA9IHJvd3M7XHJcbiAgICAgIGlmIChzaG91bGRTaG93Tm90aWZ5KSB7XHJcbiAgICAgICAgZGlhbG9nUmVmID0gdGhpcy5tb2RhbFNlcnZpY2Uuc2hvdyhjb21wb25lbnRSZWYsIHtcclxuICAgICAgICAgIHRpdGxlOiAnJyxcclxuICAgICAgICAgIHdpZHRoOiA1MDAsXHJcbiAgICAgICAgICBoZWlnaHQ6IDI0MCxcclxuICAgICAgICAgIHNob3dIZWFkZXI6IGZhbHNlLFxyXG4gICAgICAgICAgc2hvd0J1dHRvbnM6IGZhbHNlLFxyXG4gICAgICAgICAgYnV0dG9uczogW11cclxuICAgICAgICB9KTtcclxuICAgICAgICAvLyDnoa7orqRcclxuICAgICAgICBjb21wb25lbnRSZWYuaW5zdGFuY2UuY29uZmlybWVkLnN1YnNjcmliZSgoZTogeyBpbnN0YW5jZTogYW55LCBldmVudDogYW55IH0pID0+IHtcclxuICAgICAgICAgIGlmIChkaWFsb2dSZWYpIHtcclxuICAgICAgICAgICAgZGlhbG9nUmVmLmNsb3NlKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBzdWJqZWN0Lm5leHQodHJ1ZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8g5Y+W5raIXHJcbiAgICAgICAgY29tcG9uZW50UmVmLmluc3RhbmNlLmNhbmNlbGVkLnN1YnNjcmliZSgoZTogeyBpbnN0YW5jZTogYW55LCBldmVudDogYW55IH0pID0+IHtcclxuICAgICAgICAgIGlmIChkaWFsb2dSZWYpIHtcclxuICAgICAgICAgICAgZGlhbG9nUmVmLmNsb3NlKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBzdWJqZWN0Lm5leHQoZmFsc2UpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc3ViamVjdDtcclxuICB9XHJcbiAgcHVibGljIGlzVmFsdWVDaGFuZ2VkKCkge1xyXG4gICAgY29uc3QgaW5wdXRzID0gdGhpcy5jb21wb25lbnRSZWYgJiYgdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UgJiYgdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UuaW5wdXRzIHx8IFtdO1xyXG4gICAgaWYgKCFpbnB1dHMgfHwgaW5wdXRzLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgY29uc3QgdW5DaGFuZ2VkID0gaW5wdXRzLmV2ZXJ5KChpdGVtKSA9PiAhaXRlbS5maWVsZCk7XHJcbiAgICByZXR1cm4gIXVuQ2hhbmdlZDtcclxuICB9XHJcbn1cclxuIl19