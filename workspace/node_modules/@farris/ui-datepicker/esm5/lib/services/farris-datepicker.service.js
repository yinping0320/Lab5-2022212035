/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { PX, EMPTY_STR } from '../constants/constants';
import { Year } from '../enums/year.enum';
import { UtilService } from './farris-datepicker.util.service';
var DatePickerService = /** @class */ (function () {
    function DatePickerService(opts) {
        this._mouseWheelHandle = null;
        this._mouseScrollHandle = null;
        this.opts = opts;
        this.utilService = new UtilService();
    }
    /**
     * @param {?} opts
     * @param {?} defaultOpts
     * @return {?}
     */
    DatePickerService.parseOptions = /**
     * @param {?} opts
     * @param {?} defaultOpts
     * @return {?}
     */
    function (opts, defaultOpts) {
        if (defaultOpts !== undefined) {
            Object.keys(defaultOpts).forEach((/**
             * @param {?} k
             * @return {?}
             */
            function (k) {
                if (defaultOpts[k] !== undefined && defaultOpts[k] !== '') {
                    ((/** @type {?} */ (opts)))[k] = defaultOpts[k];
                }
            }));
        }
        if (opts.minYear < Year.min) {
            opts.minYear = Year.min;
        }
        if (opts.maxYear > Year.max) {
            opts.maxYear = Year.max;
        }
        return opts;
    };
    /**
     * @param {?} value
     * @return {?}
     */
    DatePickerService.prototype.validate = /**
     * @param {?} value
     * @return {?}
     */
    function (value) {
        var dateRange = this.opts.dateRange;
        /** @type {?} */
        var valid = false;
        if (!dateRange) {
            /** @type {?} */
            var date = this.utilService.isDateValid(value, this.opts);
            valid = this.utilService.isInitializedDate(date);
        }
        else {
            /** @type {?} */
            var _dateRange = this.utilService.isDateValidDateRange(value, this.opts);
            var begin = _dateRange.begin, end = _dateRange.end;
            valid = this.utilService.isInitializedDate(begin) && this.utilService.isInitializedDate(end);
        }
        return valid;
    };
    /**
     * @param {?} fn
     * @return {?}
     */
    DatePickerService.prototype.registerScrollEvent = /**
     * @param {?} fn
     * @return {?}
     */
    function (fn) {
        this._mouseScrollHandle = fn;
        document.addEventListener('scroll', this._mouseScrollHandle);
    };
    /**
     * @return {?}
     */
    DatePickerService.prototype.removeMouseEvent = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var container = document.querySelector('.date-overlay-container');
        if (container) {
            container.removeEventListener('mousewheel', this._mouseWheelHandle);
        }
        document.removeEventListener('scroll', this._mouseScrollHandle);
    };
    /**
     * @param {?} elem
     * @return {?}
     */
    DatePickerService.prototype.appendSelector = /**
     * @param {?} elem
     * @return {?}
     */
    function (elem) {
        /** @type {?} */
        var container = document.querySelector('.date-overlay-container');
        if (container) {
            if (container.hasChildNodes()) {
                container.childNodes.forEach((/**
                 * @param {?} el
                 * @return {?}
                 */
                function (el) {
                    if (el !== elem) {
                        container.removeChild(el);
                    }
                }));
            }
        }
        else {
            container = document.createElement('div');
            container.classList.add('date-overlay-container');
            container.classList.add('overlay-container');
            document.body.appendChild(container);
        }
        container.addEventListener('mousewheel', this._mouseWheelHandle = (/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            /** @type {?} */
            var target = (/** @type {?} */ (e.target));
            if (!target.closest('.calendar-time-picker-select')) {
                e.preventDefault();
            }
            return;
        }));
        container.appendChild(elem);
    };
    /**
     * @param {?} elem
     * @param {?=} calendarRef
     * @return {?}
     */
    DatePickerService.prototype.getSelectorPosition = /**
     * @param {?} elem
     * @param {?=} calendarRef
     * @return {?}
     */
    function (elem, calendarRef) {
        if (calendarRef === void 0) { calendarRef = null; }
        /** @type {?} */
        var top = 0;
        /** @type {?} */
        var left = 0;
        /** @type {?} */
        var _selectorHeight = 0;
        /** @type {?} */
        var _selectorWidth = 0;
        var _a = this.opts, selectorHeight = _a.selectorHeight, selectorWidth = _a.selectorWidth, showTime = _a.showTime, dateRange = _a.dateRange, showType = _a.showType, enableDynamic = _a.enableDynamic, showPresent = _a.showPresent, multiSelect = _a.multiSelect, viewType = _a.viewType;
        /** @type {?} */
        var b = document.body.getBoundingClientRect();
        /** @type {?} */
        var e = elem.getBoundingClientRect();
        top = e.top - b.top;
        left = e.left - b.left;
        /** @type {?} */
        var position = 'bottom';
        if ((dateRange || multiSelect || (viewType === 'together' && showTime)) && showType !== 4) {
            _selectorWidth = this.getSelectorDimension(selectorWidth) * 2;
        }
        else {
            _selectorWidth = this.getSelectorDimension(selectorWidth);
        }
        _selectorHeight = this.getSelectorDimension(selectorHeight);
        // if (showTime || enableDynamic) {
        //     top = top - 6;
        // }
        top = top - 6;
        if ((showPresent && (!dateRange || showType === 4)) || showTime || enableDynamic) {
            _selectorHeight += 45;
        }
        if (top + elem.offsetHeight + _selectorHeight > window.innerHeight && top - _selectorHeight - 2 > 0) {
            top = top - _selectorHeight - 2;
            position = 'top';
        }
        else {
            top = top + elem.offsetHeight + 2;
        }
        if (window.innerHeight - top < _selectorHeight) {
            top = top - (_selectorHeight - (window.innerHeight - e.top - e.height - 15));
            if (calendarRef) {
                /** @type {?} */
                var calendarElem = calendarRef.location.nativeElement;
                /** @type {?} */
                var arrow = calendarElem.querySelector('.arrow');
                if (arrow) {
                    arrow.style.display = 'none';
                }
            }
        }
        if (left + _selectorWidth > b.width) {
            left = b.width - _selectorWidth - 15;
        }
        left = left > 0 ? left : 0;
        /** @type {?} */
        var scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
        top -= scrollTop;
        return { top: top, left: left, position: position };
    };
    /**
     * @private
     * @param {?} value
     * @return {?}
     */
    DatePickerService.prototype.getSelectorDimension = /**
     * @private
     * @param {?} value
     * @return {?}
     */
    function (value) {
        return Number(value.replace(PX, EMPTY_STR));
    };
    return DatePickerService;
}());
export { DatePickerService };
if (false) {
    /** @type {?} */
    DatePickerService.prototype.opts;
    /** @type {?} */
    DatePickerService.prototype.utilService;
    /**
     * @type {?}
     * @private
     */
    DatePickerService.prototype._mouseWheelHandle;
    /**
     * @type {?}
     * @private
     */
    DatePickerService.prototype._mouseScrollHandle;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzLWRhdGVwaWNrZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0ZXBpY2tlci8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9mYXJyaXMtZGF0ZXBpY2tlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFDQSxPQUFPLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMxQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFHL0Q7SUFPSSwyQkFBWSxJQUFJO1FBSFIsc0JBQWlCLEdBQUcsSUFBSSxDQUFDO1FBQ3pCLHVCQUFrQixHQUFHLElBQUksQ0FBQztRQUc5QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7SUFDekMsQ0FBQzs7Ozs7O0lBRU0sOEJBQVk7Ozs7O0lBQW5CLFVBQW9CLElBQWdCLEVBQUUsV0FBVztRQUM3QyxJQUFJLFdBQVcsS0FBSyxTQUFTLEVBQUU7WUFDM0IsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPOzs7O1lBQUMsVUFBQSxDQUFDO2dCQUM5QixJQUFJLFdBQVcsQ0FBQyxDQUFDLENBQUMsS0FBSyxTQUFTLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtvQkFDdkQsQ0FBQyxtQkFBQSxJQUFJLEVBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDNUM7WUFDTCxDQUFDLEVBQUMsQ0FBQztTQUNOO1FBQ0QsSUFBSSxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDekIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJ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QyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzs7WUFFckIsU0FBUyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxJQUFJLFFBQVEsQ0FBQyxlQUFlLENBQUMsU0FBUztRQUMvRSxHQUFHLElBQUksU0FBUyxDQUFDO1FBRWpCLE9BQU8sRUFBRSxHQUFHLEtBQUEsRUFBRSxJQUFJLE1BQUEsRUFBRSxRQUFRLFVBQUEsRUFBRSxDQUFDO0lBQ25DLENBQUM7Ozs7OztJQUNPLGdEQUFvQjs7Ozs7SUFBNUIsVUFBNkIsS0FBYTtRQUN0QyxPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFTCx3QkFBQztBQUFELENBQUMsQUFoS0QsSUFnS0M7Ozs7SUEvSkcsaUNBQUs7O0lBQ0wsd0NBQVk7Ozs7O0lBRVosOENBQWlDOzs7OztJQUNqQywrQ0FBa0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJTXlEYXRlLCBJTXlEYXRlUmFuZ2UsIElNeVNlbGVjdG9yUG9zaXRpb24sIElNeU9wdGlvbnMgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3B1YmxpYy1hcGknO1xyXG5pbXBvcnQgeyBQWCwgRU1QVFlfU1RSIH0gZnJvbSAnLi4vY29uc3RhbnRzL2NvbnN0YW50cyc7XHJcbmltcG9ydCB7IFllYXIgfSBmcm9tICcuLi9lbnVtcy95ZWFyLmVudW0nO1xyXG5pbXBvcnQgeyBVdGlsU2VydmljZSB9IGZyb20gJy4vZmFycmlzLWRhdGVwaWNrZXIudXRpbC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ29tcG9uZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG5leHBvcnQgY2xhc3MgRGF0ZVBpY2tlclNlcnZpY2Uge1xyXG4gICAgb3B0cztcclxuICAgIHV0aWxTZXJ2aWNlO1xyXG5cclxuICAgIHByaXZhdGUgX21vdXNlV2hlZWxIYW5kbGUgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBfbW91c2VTY3JvbGxIYW5kbGUgPSBudWxsO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKG9wdHMpIHtcclxuICAgICAgICB0aGlzLm9wdHMgPSBvcHRzO1xyXG4gICAgICAgIHRoaXMudXRpbFNlcnZpY2UgPSBuZXcgVXRpbFNlcnZpY2UoKTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgcGFyc2VPcHRpb25zKG9wdHM6IElNeU9wdGlvbnMsIGRlZmF1bHRPcHRzKTogSU15T3B0aW9ucyB7XHJcbiAgICAgICAgaWYgKGRlZmF1bHRPcHRzICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgT2JqZWN0LmtleXMoZGVmYXVsdE9wdHMpLmZvckVhY2goayA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdE9wdHNba10gIT09IHVuZGVmaW5lZCAmJiBkZWZhdWx0T3B0c1trXSAhPT0gJycpIHtcclxuICAgICAgICAgICAgICAgICAgICAob3B0cyBhcyBJTXlPcHRpb25zKVtrXSA9IGRlZmF1bHRPcHRzW2tdO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG9wdHMubWluWWVhciA8IFllYXIubWluKSB7XHJcbiAgICAgICAgICAgIG9wdHMubWluWWVhciA9IFllYXIubWluO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAob3B0cy5tYXhZZWFyID4gWWVhci5tYXgpIHtcclxuICAgICAgICAgICAgb3B0cy5tYXhZZWFyID0gWWVhci5tYXg7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBvcHRzO1xyXG4gICAgfVxyXG5cclxuICAgIHZhbGlkYXRlKHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCB7IGRhdGVSYW5nZSB9ID0gdGhpcy5vcHRzO1xyXG5cclxuICAgICAgICBsZXQgdmFsaWQgPSBmYWxzZTtcclxuICAgICAgICBpZiAoIWRhdGVSYW5nZSkge1xyXG4gICAgICAgICAgICBjb25zdCBkYXRlOiBJTXlEYXRlID0gdGhpcy51dGlsU2VydmljZS5pc0RhdGVWYWxpZCh2YWx1ZSwgdGhpcy5vcHRzKTtcclxuXHJcbiAgICAgICAgICAgIHZhbGlkID0gdGhpcy51dGlsU2VydmljZS5pc0luaXRpYWxpemVkRGF0ZShkYXRlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBfZGF0ZVJhbmdlOiBJTXlEYXRlUmFuZ2UgPSB0aGlzLnV0aWxTZXJ2aWNlLmlzRGF0ZVZhbGlkRGF0ZVJhbmdlKHZhbHVlLCB0aGlzLm9wdHMpO1xyXG4gICAgICAgICAgICBjb25zdCB7IGJlZ2luLCBlbmQgfSA9IF9kYXRlUmFuZ2U7XHJcbiAgICAgICAgICAgIHZhbGlkID0gdGhpcy51dGlsU2VydmljZS5pc0luaXRpYWxpemVkRGF0ZShiZWdpbikgJiYgdGhpcy51dGlsU2VydmljZS5pc0luaXRpYWxpemVkRGF0ZShlbmQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHZhbGlkO1xyXG4gICAgfVxyXG5cclxuICAgIHJlZ2lzdGVyU2Nyb2xsRXZlbnQoZm4pIHtcclxuICAgICAgICB0aGlzLl9tb3VzZVNjcm9sbEhhbmRsZSA9IGZuO1xyXG4gICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMuX21vdXNlU2Nyb2xsSGFuZGxlKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcmVtb3ZlTW91c2VFdmVudCgpIHtcclxuICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZGF0ZS1vdmVybGF5LWNvbnRhaW5lcicpO1xyXG4gICAgICAgIGlmIChjb250YWluZXIpIHtcclxuICAgICAgICAgICAgY29udGFpbmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNld2hlZWwnLCB0aGlzLl9tb3VzZVdoZWVsSGFuZGxlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMuX21vdXNlU2Nyb2xsSGFuZGxlKTtcclxuICAgIH1cclxuXHJcbiAgICBhcHBlbmRTZWxlY3RvcihlbGVtOiBhbnkpOiB2b2lkIHtcclxuICAgICAgICBsZXQgY29udGFpbmVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmRhdGUtb3ZlcmxheS1jb250YWluZXInKTtcclxuICAgICAgICBpZiAoY29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgIGlmIChjb250YWluZXIuaGFzQ2hpbGROb2RlcygpKSB7XHJcbiAgICAgICAgICAgICAgICBjb250YWluZXIuY2hpbGROb2Rlcy5mb3JFYWNoKGVsID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZWwgIT09IGVsZW0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLnJlbW92ZUNoaWxkKGVsKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LmFkZCgnZGF0ZS1vdmVybGF5LWNvbnRhaW5lcicpO1xyXG4gICAgICAgICAgICBjb250YWluZXIuY2xhc3NMaXN0LmFkZCgnb3ZlcmxheS1jb250YWluZXInKTtcclxuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChjb250YWluZXIpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNld2hlZWwnLCB0aGlzLl9tb3VzZVdoZWVsSGFuZGxlID0gKGU6IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gZS50YXJnZXQgYXMgYW55O1xyXG4gICAgICAgICAgICBpZiAoIXRhcmdldC5jbG9zZXN0KCcuY2FsZW5kYXItdGltZS1waWNrZXItc2VsZWN0JykpIHtcclxuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChlbGVtKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRTZWxlY3RvclBvc2l0aW9uKGVsZW06IGFueSwgY2FsZW5kYXJSZWY6IENvbXBvbmVudFJlZjxhbnk+ICA9IG51bGwpOiBJTXlTZWxlY3RvclBvc2l0aW9uIHtcclxuICAgICAgICBsZXQgdG9wID0gMDtcclxuICAgICAgICBsZXQgbGVmdCA9IDA7XHJcbiAgICAgICAgbGV0IF9zZWxlY3RvckhlaWdodCA9IDA7XHJcbiAgICAgICAgbGV0IF9zZWxlY3RvcldpZHRoID0gMDtcclxuICAgICAgICBjb25zdCB7XHJcbiAgICAgICAgICAgIHNlbGVjdG9ySGVpZ2h0LFxyXG4gICAgICAgICAgICBzZWxlY3RvcldpZHRoLFxyXG4gICAgICAgICAgICBzaG93VGltZSxcclxuICAgICAgICAgICAgZGF0ZVJhbmdlLFxyXG4gICAgICAgICAgICBzaG93VHlwZSxcclxuICAgICAgICAgICAgZW5hYmxlRHluYW1pYyxcclxuICAgICAgICAgICAgc2hvd1ByZXNlbnQsXHJcbiAgICAgICAgICAgIG11bHRpU2VsZWN0LFxyXG4gICAgICAgICAgICB2aWV3VHlwZVxyXG4gICAgICAgIH0gPSB0aGlzLm9wdHM7XHJcblxyXG4gICAgICAgIGNvbnN0IGI6IGFueSA9IGRvY3VtZW50LmJvZHkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgY29uc3QgZTogYW55ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICB0b3AgPSBlLnRvcCAtIGIudG9wO1xyXG4gICAgICAgIGxlZnQgPSBlLmxlZnQgLSBiLmxlZnQ7XHJcbiAgICAgICAgbGV0IHBvc2l0aW9uID0gJ2JvdHRvbSc7XHJcbiAgICAgICAgaWYgKChkYXRlUmFuZ2UgfHwgbXVsdGlTZWxlY3QgfHwgKHZpZXdUeXBlID09PSAndG9nZXRoZXInICYmIHNob3dUaW1lKSkgJiYgc2hvd1R5cGUgIT09IDQpIHtcclxuICAgICAgICAgICAgX3NlbGVjdG9yV2lkdGggPSB0aGlzLmdldFNlbGVjdG9yRGltZW5zaW9uKHNlbGVjdG9yV2lkdGgpICogMjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBfc2VsZWN0b3JXaWR0aCA9IHRoaXMuZ2V0U2VsZWN0b3JEaW1lbnNpb24oc2VsZWN0b3JXaWR0aCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBfc2VsZWN0b3JIZWlnaHQgPSB0aGlzLmdldFNlbGVjdG9yRGltZW5zaW9uKHNlbGVjdG9ySGVpZ2h0KTtcclxuICAgICAgICAvLyBpZiAoc2hvd1RpbWUgfHwgZW5hYmxlRHluYW1pYykge1xyXG4gICAgICAgIC8vICAgICB0b3AgPSB0b3AgLSA2O1xyXG4gICAgICAgIC8vIH1cclxuXHJcbiAgICAgICAgdG9wID0gdG9wIC0gNjtcclxuICAgICAgICBpZiAoKHNob3dQcmVzZW50ICYmICAoIWRhdGVSYW5nZSB8fCBzaG93VHlwZSA9PT0gNCkpIHx8IHNob3dUaW1lIHx8IGVuYWJsZUR5bmFtaWMpIHtcclxuICAgICAgICAgICAgX3NlbGVjdG9ySGVpZ2h0ICs9IDQ1O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRvcCArIGVsZW0ub2Zmc2V0SGVpZ2h0ICsgX3NlbGVjdG9ySGVpZ2h0ID4gd2luZG93LmlubmVySGVpZ2h0ICYmIHRvcCAtIF9zZWxlY3RvckhlaWdodCAtIDIgPiAwKSB7XHJcbiAgICAgICAgICAgIHRvcCA9IHRvcCAtIF9zZWxlY3RvckhlaWdodCAtIDIgO1xyXG4gICAgICAgICAgICBwb3NpdGlvbiA9ICd0b3AnO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRvcCA9IHRvcCArIGVsZW0ub2Zmc2V0SGVpZ2h0ICsgMjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh3aW5kb3cuaW5uZXJIZWlnaHQgLSB0b3AgPCBfc2VsZWN0b3JIZWlnaHQpIHtcclxuICAgICAgICAgICAgdG9wID0gdG9wIC0gKF9zZWxlY3RvckhlaWdodCAtICh3aW5kb3cuaW5uZXJIZWlnaHQgLSBlLnRvcCAtIGUuaGVpZ2h0IC0gMTUpKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChjYWxlbmRhclJlZikge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY2FsZW5kYXJFbGVtID0gY2FsZW5kYXJSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFycm93ID0gY2FsZW5kYXJFbGVtLnF1ZXJ5U2VsZWN0b3IoJy5hcnJvdycpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGFycm93KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXJyb3cuc3R5bGUuZGlzcGxheSA9ICdub25lJztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGxlZnQgKyBfc2VsZWN0b3JXaWR0aCA+IGIud2lkdGgpIHtcclxuICAgICAgICAgICAgbGVmdCA9IGIud2lkdGggLSBfc2VsZWN0b3JXaWR0aCAtIDE1O1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZWZ0ID0gbGVmdCA+IDAgPyBsZWZ0IDogMDtcclxuXHJcbiAgICAgICAgY29uc3Qgc2Nyb2xsVG9wID0gZG9jdW1lbnQuYm9keS5zY3JvbGxUb3AgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcDtcclxuICAgICAgICB0b3AgLT0gc2Nyb2xsVG9wO1xyXG5cclxuICAgICAgICByZXR1cm4geyB0b3AsIGxlZnQsIHBvc2l0aW9uIH07XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGdldFNlbGVjdG9yRGltZW5zaW9uKHZhbHVlOiBzdHJpbmcpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiBOdW1iZXIodmFsdWUucmVwbGFjZShQWCwgRU1QVFlfU1RSKSk7XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==