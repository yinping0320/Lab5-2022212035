/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { PX, EMPTY_STR } from '../constants/constants';
import { Year } from '../enums/year.enum';
import { UtilService } from './farris-datepicker.util.service';
export class DatePickerService {
    /**
     * @param {?} opts
     */
    constructor(opts) {
        this._mouseWheelHandle = null;
        this._mouseScrollHandle = null;
        this.opts = opts;
        this.utilService = new UtilService();
    }
    /**
     * @param {?} opts
     * @param {?} defaultOpts
     * @return {?}
     */
    static parseOptions(opts, defaultOpts) {
        if (defaultOpts !== undefined) {
            Object.keys(defaultOpts).forEach((/**
             * @param {?} k
             * @return {?}
             */
            k => {
                if (defaultOpts[k] !== undefined && defaultOpts[k] !== '') {
                    ((/** @type {?} */ (opts)))[k] = defaultOpts[k];
                }
            }));
        }
        if (opts.minYear < Year.min) {
            opts.minYear = Year.min;
        }
        if (opts.maxYear > Year.max) {
            opts.maxYear = Year.max;
        }
        return opts;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    validate(value) {
        const { dateRange } = this.opts;
        /** @type {?} */
        let valid = false;
        if (!dateRange) {
            /** @type {?} */
            const date = this.utilService.isDateValid(value, this.opts);
            valid = this.utilService.isInitializedDate(date);
        }
        else {
            /** @type {?} */
            const _dateRange = this.utilService.isDateValidDateRange(value, this.opts);
            const { begin, end } = _dateRange;
            valid = this.utilService.isInitializedDate(begin) && this.utilService.isInitializedDate(end);
        }
        return valid;
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    registerScrollEvent(fn) {
        this._mouseScrollHandle = fn;
        document.addEventListener('scroll', this._mouseScrollHandle);
    }
    /**
     * @return {?}
     */
    removeMouseEvent() {
        /** @type {?} */
        const container = document.querySelector('.date-overlay-container');
        if (container) {
            container.removeEventListener('mousewheel', this._mouseWheelHandle);
        }
        document.removeEventListener('scroll', this._mouseScrollHandle);
    }
    /**
     * @param {?} elem
     * @return {?}
     */
    appendSelector(elem) {
        /** @type {?} */
        let container = document.querySelector('.date-overlay-container');
        if (container) {
            if (container.hasChildNodes()) {
                container.childNodes.forEach((/**
                 * @param {?} el
                 * @return {?}
                 */
                el => {
                    if (el !== elem) {
                        container.removeChild(el);
                    }
                }));
            }
        }
        else {
            container = document.createElement('div');
            container.classList.add('date-overlay-container');
            container.classList.add('overlay-container');
            document.body.appendChild(container);
        }
        container.addEventListener('mousewheel', this._mouseWheelHandle = (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            /** @type {?} */
            const target = (/** @type {?} */ (e.target));
            if (!target.closest('.calendar-time-picker-select')) {
                e.preventDefault();
            }
            return;
        }));
        container.appendChild(elem);
    }
    /**
     * @param {?} elem
     * @param {?=} calendarRef
     * @return {?}
     */
    getSelectorPosition(elem, calendarRef = null) {
        /** @type {?} */
        let top = 0;
        /** @type {?} */
        let left = 0;
        /** @type {?} */
        let _selectorHeight = 0;
        /** @type {?} */
        let _selectorWidth = 0;
        const { selectorHeight, selectorWidth, showTime, dateRange, showType, enableDynamic, showPresent, multiSelect, viewType } = this.opts;
        /** @type {?} */
        const b = document.body.getBoundingClientRect();
        /** @type {?} */
        const e = elem.getBoundingClientRect();
        top = e.top - b.top;
        left = e.left - b.left;
        /** @type {?} */
        let position = 'bottom';
        if ((dateRange || multiSelect || (viewType === 'together' && showTime)) && showType !== 4) {
            _selectorWidth = this.getSelectorDimension(selectorWidth) * 2;
        }
        else {
            _selectorWidth = this.getSelectorDimension(selectorWidth);
        }
        _selectorHeight = this.getSelectorDimension(selectorHeight);
        // if (showTime || enableDynamic) {
        //     top = top - 6;
        // }
        top = top - 6;
        if ((showPresent && (!dateRange || showType === 4)) || showTime || enableDynamic) {
            _selectorHeight += 45;
        }
        if (top + elem.offsetHeight + _selectorHeight > window.innerHeight && top - _selectorHeight - 2 > 0) {
            top = top - _selectorHeight - 2;
            position = 'top';
        }
        else {
            top = top + elem.offsetHeight + 2;
        }
        if (window.innerHeight - top < _selectorHeight) {
            top = top - (_selectorHeight - (window.innerHeight - e.top - e.height - 15));
            if (calendarRef) {
                /** @type {?} */
                const calendarElem = calendarRef.location.nativeElement;
                /** @type {?} */
                const arrow = calendarElem.querySelector('.arrow');
                if (arrow) {
                    arrow.style.display = 'none';
                }
            }
        }
        if (left + _selectorWidth > b.width) {
            left = b.width - _selectorWidth - 15;
        }
        left = left > 0 ? left : 0;
        /** @type {?} */
        const scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
        top -= scrollTop;
        return { top, left, position };
    }
    /**
     * @private
     * @param {?} value
     * @return {?}
     */
    getSelectorDimension(value) {
        return Number(value.replace(PX, EMPTY_STR));
    }
}
if (false) {
    /** @type {?} */
    DatePickerService.prototype.opts;
    /** @type {?} */
    DatePickerService.prototype.utilService;
    /**
     * @type {?}
     * @private
     */
    DatePickerService.prototype._mouseWheelHandle;
    /**
     * @type {?}
     * @private
     */
    DatePickerService.prototype._mouseScrollHandle;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzLWRhdGVwaWNrZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0ZXBpY2tlci8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9mYXJyaXMtZGF0ZXBpY2tlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFDQSxPQUFPLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMxQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFHL0QsTUFBTSxPQUFPLGlCQUFpQjs7OztJQU8xQixZQUFZLElBQUk7UUFIUixzQkFBaUIsR0FBRyxJQUFJLENBQUM7UUFDekIsdUJBQWtCLEdBQUcsSUFBSSxDQUFDO1FBRzlCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztJQUN6QyxDQUFDOzs7Ozs7SUFFRCxNQUFNLENBQUMsWUFBWSxDQUFDLElBQWdCLEVBQUUsV0FBVztRQUM3QyxJQUFJLFdBQVcsS0FBSyxTQUFTLEVBQUU7WUFDM0IsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPOzs7O1lBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQ2pDLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLFNBQVMsSUFBSSxXQUFXLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO29CQUN2RCxDQUFDLG1CQUFBLElBQUksRUFBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUM1QztZQUNMLENBQUMsRUFBQyxDQUFDO1NBQ047UUFDRCxJQUFJLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUN6QixJ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QUFHLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDOztjQUVyQixTQUFTLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksUUFBUSxDQUFDLGVBQWUsQ0FBQyxTQUFTO1FBQy9FLEdBQUcsSUFBSSxTQUFTLENBQUM7UUFFakIsT0FBTyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLENBQUM7SUFDbkMsQ0FBQzs7Ozs7O0lBQ08sb0JBQW9CLENBQUMsS0FBYTtRQUN0QyxPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO0lBQ2hELENBQUM7Q0FFSjs7O0lBL0pHLGlDQUFLOztJQUNMLHdDQUFZOzs7OztJQUVaLDhDQUFpQzs7Ozs7SUFDakMsK0NBQWtDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSU15RGF0ZSwgSU15RGF0ZVJhbmdlLCBJTXlTZWxlY3RvclBvc2l0aW9uLCBJTXlPcHRpb25zIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9wdWJsaWMtYXBpJztcclxuaW1wb3J0IHsgUFgsIEVNUFRZX1NUUiB9IGZyb20gJy4uL2NvbnN0YW50cy9jb25zdGFudHMnO1xyXG5pbXBvcnQgeyBZZWFyIH0gZnJvbSAnLi4vZW51bXMveWVhci5lbnVtJztcclxuaW1wb3J0IHsgVXRpbFNlcnZpY2UgfSBmcm9tICcuL2ZhcnJpcy1kYXRlcGlja2VyLnV0aWwuc2VydmljZSc7XHJcbmltcG9ydCB7IENvbXBvbmVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5cclxuZXhwb3J0IGNsYXNzIERhdGVQaWNrZXJTZXJ2aWNlIHtcclxuICAgIG9wdHM7XHJcbiAgICB1dGlsU2VydmljZTtcclxuXHJcbiAgICBwcml2YXRlIF9tb3VzZVdoZWVsSGFuZGxlID0gbnVsbDtcclxuICAgIHByaXZhdGUgX21vdXNlU2Nyb2xsSGFuZGxlID0gbnVsbDtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihvcHRzKSB7XHJcbiAgICAgICAgdGhpcy5vcHRzID0gb3B0cztcclxuICAgICAgICB0aGlzLnV0aWxTZXJ2aWNlID0gbmV3IFV0aWxTZXJ2aWNlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIHBhcnNlT3B0aW9ucyhvcHRzOiBJTXlPcHRpb25zLCBkZWZhdWx0T3B0cyk6IElNeU9wdGlvbnMge1xyXG4gICAgICAgIGlmIChkZWZhdWx0T3B0cyAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKGRlZmF1bHRPcHRzKS5mb3JFYWNoKGsgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGRlZmF1bHRPcHRzW2tdICE9PSB1bmRlZmluZWQgJiYgZGVmYXVsdE9wdHNba10gIT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgKG9wdHMgYXMgSU15T3B0aW9ucylba10gPSBkZWZhdWx0T3B0c1trXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvcHRzLm1pblllYXIgPCBZZWFyLm1pbikge1xyXG4gICAgICAgICAgICBvcHRzLm1pblllYXIgPSBZZWFyLm1pbjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG9wdHMubWF4WWVhciA+IFllYXIubWF4KSB7XHJcbiAgICAgICAgICAgIG9wdHMubWF4WWVhciA9IFllYXIubWF4O1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gb3B0cztcclxuICAgIH1cclxuXHJcbiAgICB2YWxpZGF0ZSh2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgeyBkYXRlUmFuZ2UgfSA9IHRoaXMub3B0cztcclxuXHJcbiAgICAgICAgbGV0IHZhbGlkID0gZmFsc2U7XHJcbiAgICAgICAgaWYgKCFkYXRlUmFuZ2UpIHtcclxuICAgICAgICAgICAgY29uc3QgZGF0ZTogSU15RGF0ZSA9IHRoaXMudXRpbFNlcnZpY2UuaXNEYXRlVmFsaWQodmFsdWUsIHRoaXMub3B0cyk7XHJcblxyXG4gICAgICAgICAgICB2YWxpZCA9IHRoaXMudXRpbFNlcnZpY2UuaXNJbml0aWFsaXplZERhdGUoZGF0ZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgX2RhdGVSYW5nZTogSU15RGF0ZVJhbmdlID0gdGhpcy51dGlsU2VydmljZS5pc0RhdGVWYWxpZERhdGVSYW5nZSh2YWx1ZSwgdGhpcy5vcHRzKTtcclxuICAgICAgICAgICAgY29uc3QgeyBiZWdpbiwgZW5kIH0gPSBfZGF0ZVJhbmdlO1xyXG4gICAgICAgICAgICB2YWxpZCA9IHRoaXMudXRpbFNlcnZpY2UuaXNJbml0aWFsaXplZERhdGUoYmVnaW4pICYmIHRoaXMudXRpbFNlcnZpY2UuaXNJbml0aWFsaXplZERhdGUoZW5kKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB2YWxpZDtcclxuICAgIH1cclxuXHJcbiAgICByZWdpc3RlclNjcm9sbEV2ZW50KGZuKSB7XHJcbiAgICAgICAgdGhpcy5fbW91c2VTY3JvbGxIYW5kbGUgPSBmbjtcclxuICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLl9tb3VzZVNjcm9sbEhhbmRsZSk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHJlbW92ZU1vdXNlRXZlbnQoKSB7XHJcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmRhdGUtb3ZlcmxheS1jb250YWluZXInKTtcclxuICAgICAgICBpZiAoY29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgIGNvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXdoZWVsJywgdGhpcy5fbW91c2VXaGVlbEhhbmRsZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLl9tb3VzZVNjcm9sbEhhbmRsZSk7XHJcbiAgICB9XHJcblxyXG4gICAgYXBwZW5kU2VsZWN0b3IoZWxlbTogYW55KTogdm9pZCB7XHJcbiAgICAgICAgbGV0IGNvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5kYXRlLW92ZXJsYXktY29udGFpbmVyJyk7XHJcbiAgICAgICAgaWYgKGNvbnRhaW5lcikge1xyXG4gICAgICAgICAgICBpZiAoY29udGFpbmVyLmhhc0NoaWxkTm9kZXMoKSkge1xyXG4gICAgICAgICAgICAgICAgY29udGFpbmVyLmNoaWxkTm9kZXMuZm9yRWFjaChlbCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVsICE9PSBlbGVtKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZChlbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICAgICAgY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoJ2RhdGUtb3ZlcmxheS1jb250YWluZXInKTtcclxuICAgICAgICAgICAgY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoJ292ZXJsYXktY29udGFpbmVyJyk7XHJcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoY29udGFpbmVyKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXdoZWVsJywgdGhpcy5fbW91c2VXaGVlbEhhbmRsZSA9IChlOiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IGUudGFyZ2V0IGFzIGFueTtcclxuICAgICAgICAgICAgaWYgKCF0YXJnZXQuY2xvc2VzdCgnLmNhbGVuZGFyLXRpbWUtcGlja2VyLXNlbGVjdCcpKSB7XHJcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZWxlbSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U2VsZWN0b3JQb3NpdGlvbihlbGVtOiBhbnksIGNhbGVuZGFyUmVmOiBDb21wb25lbnRSZWY8YW55PiAgPSBudWxsKTogSU15U2VsZWN0b3JQb3NpdGlvbiB7XHJcbiAgICAgICAgbGV0IHRvcCA9IDA7XHJcbiAgICAgICAgbGV0IGxlZnQgPSAwO1xyXG4gICAgICAgIGxldCBfc2VsZWN0b3JIZWlnaHQgPSAwO1xyXG4gICAgICAgIGxldCBfc2VsZWN0b3JXaWR0aCA9IDA7XHJcbiAgICAgICAgY29uc3Qge1xyXG4gICAgICAgICAgICBzZWxlY3RvckhlaWdodCxcclxuICAgICAgICAgICAgc2VsZWN0b3JXaWR0aCxcclxuICAgICAgICAgICAgc2hvd1RpbWUsXHJcbiAgICAgICAgICAgIGRhdGVSYW5nZSxcclxuICAgICAgICAgICAgc2hvd1R5cGUsXHJcbiAgICAgICAgICAgIGVuYWJsZUR5bmFtaWMsXHJcbiAgICAgICAgICAgIHNob3dQcmVzZW50LFxyXG4gICAgICAgICAgICBtdWx0aVNlbGVjdCxcclxuICAgICAgICAgICAgdmlld1R5cGVcclxuICAgICAgICB9ID0gdGhpcy5vcHRzO1xyXG5cclxuICAgICAgICBjb25zdCBiOiBhbnkgPSBkb2N1bWVudC5ib2R5LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgIGNvbnN0IGU6IGFueSA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgdG9wID0gZS50b3AgLSBiLnRvcDtcclxuICAgICAgICBsZWZ0ID0gZS5sZWZ0IC0gYi5sZWZ0O1xyXG4gICAgICAgIGxldCBwb3NpdGlvbiA9ICdib3R0b20nO1xyXG4gICAgICAgIGlmICgoZGF0ZVJhbmdlIHx8IG11bHRpU2VsZWN0IHx8ICh2aWV3VHlwZSA9PT0gJ3RvZ2V0aGVyJyAmJiBzaG93VGltZSkpICYmIHNob3dUeXBlICE9PSA0KSB7XHJcbiAgICAgICAgICAgIF9zZWxlY3RvcldpZHRoID0gdGhpcy5nZXRTZWxlY3RvckRpbWVuc2lvbihzZWxlY3RvcldpZHRoKSAqIDI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgX3NlbGVjdG9yV2lkdGggPSB0aGlzLmdldFNlbGVjdG9yRGltZW5zaW9uKHNlbGVjdG9yV2lkdGgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgX3NlbGVjdG9ySGVpZ2h0ID0gdGhpcy5nZXRTZWxlY3RvckRpbWVuc2lvbihzZWxlY3RvckhlaWdodCk7XHJcbiAgICAgICAgLy8gaWYgKHNob3dUaW1lIHx8IGVuYWJsZUR5bmFtaWMpIHtcclxuICAgICAgICAvLyAgICAgdG9wID0gdG9wIC0gNjtcclxuICAgICAgICAvLyB9XHJcblxyXG4gICAgICAgIHRvcCA9IHRvcCAtIDY7XHJcbiAgICAgICAgaWYgKChzaG93UHJlc2VudCAmJiAgKCFkYXRlUmFuZ2UgfHwgc2hvd1R5cGUgPT09IDQpKSB8fCBzaG93VGltZSB8fCBlbmFibGVEeW5hbWljKSB7XHJcbiAgICAgICAgICAgIF9zZWxlY3RvckhlaWdodCArPSA0NTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0b3AgKyBlbGVtLm9mZnNldEhlaWdodCArIF9zZWxlY3RvckhlaWdodCA+IHdpbmRvdy5pbm5lckhlaWdodCAmJiB0b3AgLSBfc2VsZWN0b3JIZWlnaHQgLSAyID4gMCkge1xyXG4gICAgICAgICAgICB0b3AgPSB0b3AgLSBfc2VsZWN0b3JIZWlnaHQgLSAyIDtcclxuICAgICAgICAgICAgcG9zaXRpb24gPSAndG9wJztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0b3AgPSB0b3AgKyBlbGVtLm9mZnNldEhlaWdodCArIDI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAod2luZG93LmlubmVySGVpZ2h0IC0gdG9wIDwgX3NlbGVjdG9ySGVpZ2h0KSB7XHJcbiAgICAgICAgICAgIHRvcCA9IHRvcCAtIChfc2VsZWN0b3JIZWlnaHQgLSAod2luZG93LmlubmVySGVpZ2h0IC0gZS50b3AgLSBlLmhlaWdodCAtIDE1KSk7XHJcblxyXG4gICAgICAgICAgICBpZiAoY2FsZW5kYXJSZWYpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNhbGVuZGFyRWxlbSA9IGNhbGVuZGFyUmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhcnJvdyA9IGNhbGVuZGFyRWxlbS5xdWVyeVNlbGVjdG9yKCcuYXJyb3cnKTtcclxuICAgICAgICAgICAgICAgIGlmIChhcnJvdykge1xyXG4gICAgICAgICAgICAgICAgICAgIGFycm93LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChsZWZ0ICsgX3NlbGVjdG9yV2lkdGggPiBiLndpZHRoKSB7XHJcbiAgICAgICAgICAgIGxlZnQgPSBiLndpZHRoIC0gX3NlbGVjdG9yV2lkdGggLSAxNTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGVmdCA9IGxlZnQgPiAwID8gbGVmdCA6IDA7XHJcblxyXG4gICAgICAgIGNvbnN0IHNjcm9sbFRvcCA9IGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wIHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3A7XHJcbiAgICAgICAgdG9wIC09IHNjcm9sbFRvcDtcclxuXHJcbiAgICAgICAgcmV0dXJuIHsgdG9wLCBsZWZ0LCBwb3NpdGlvbiB9O1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBnZXRTZWxlY3RvckRpbWVuc2lvbih2YWx1ZTogc3RyaW5nKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gTnVtYmVyKHZhbHVlLnJlcGxhY2UoUFgsIEVNUFRZX1NUUikpO1xyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=