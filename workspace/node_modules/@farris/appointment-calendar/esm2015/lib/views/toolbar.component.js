/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, EventEmitter, Injector, Input, Output, ViewEncapsulation } from '@angular/core';
import { DateTimeHelperService } from '@farris/ui-common/date';
import { addDays, subDays } from 'date-fns';
import { AppointmentCalendarComponent } from '../appointment-calendar.component';
export class ToolbarComponent {
    /**
     * @param {?} dateHlp
     * @param {?} injector
     * @param {?} calendarRef
     */
    constructor(dateHlp, injector, calendarRef) {
        this.dateHlp = dateHlp;
        this.injector = injector;
        this.calendarRef = calendarRef;
        this.dateChanged = new EventEmitter();
        this.placeChanged = new EventEmitter();
        this.currentDate = '';
        this.currentDateRange = '';
        this.currentWeekDays = [];
        this.currentViewType = 'day';
        this.places = [];
        this.placeIdField = 'id';
        this.placeNameField = 'name';
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.initDate();
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (changes.rooms && !changes.rooms.isFirstChange()) {
            this.places = [{ [this.placeIdField]: '', [this.placeNameField]: '全部场所' }, ...this.places];
        }
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() { }
    /**
     * @private
     * @return {?}
     */
    initDate() {
        if (this.currentViewType === 'week' && !this.currentDateRange) {
            this.currentWeekDays = this.dateHlp.getWeekDate({ baselineDate: new Date() });
            this.currentDateRange = this.currentWeekDays[0].dateStr + '~' + this.currentWeekDays[6].dateStr;
        }
        else {
            if (!this.currentDate) {
                this.currentDate = this.dateHlp.formatTo(new Date(), 'yyyy-MM-dd');
            }
        }
        this._dateChanged();
    }
    /**
     * @param {?} $event
     * @param {?} viewType
     * @return {?}
     */
    changeCalendarView($event, viewType) {
        if ($event) {
            $event.stopPropagation();
        }
        this.currentViewType = viewType;
        this.initDate();
    }
    /**
     * @param {?} $event
     * @param {?} typ
     * @return {?}
     */
    onDateButtonClicked($event, typ) {
        /** @type {?} */
        let baselineDate = new Date();
        if (this.currentViewType === 'day') {
            if (this.currentDate) {
                baselineDate = new Date(this.currentDate);
            }
            /** @type {?} */
            let newDateStr = this.dateHlp.formatTo(new Date(), 'yyyy-MM-dd');
            if (typ === -1) {
                /** @type {?} */
                const d = this.dateHlp.formatTo(subDays(baselineDate, 1), 'yyyy-MM-dd');
                newDateStr = this.dateHlp.formatTo(d);
            }
            else if (typ === 1) {
                /** @type {?} */
                const d = this.dateHlp.formatTo(addDays(baselineDate, 1), 'yyyy-MM-dd');
                newDateStr = this.dateHlp.formatTo(d);
            }
            this.currentDate = newDateStr;
        }
        else {
            if (this.currentWeekDays && this.currentWeekDays.length) {
                baselineDate = this.currentWeekDays[4].date;
            }
            // 下周
            if (typ === 1) {
                this.currentWeekDays = this.dateHlp.getWeekDate({ baselineDate, range: 7 });
            }
            else if (typ === -1) { // 上周
                this.currentWeekDays = this.dateHlp.getWeekDate({ baselineDate, range: -7 });
            }
            else { // 当前周
                baselineDate = new Date();
                this.currentWeekDays = this.dateHlp.getWeekDate({ baselineDate });
            }
            this.currentDateRange = this.currentWeekDays[0].dateStr + '~' + this.currentWeekDays[6].dateStr;
            // console.log(this.currentWeekDays);
        }
        this._dateChanged();
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    onDateChanged($event) {
        /** @type {?} */
        let isChanged = false;
        if (this.currentViewType == 'week') {
            /** @type {?} */
            const _date = $event.split('~')[0];
            this.currentWeekDays = this.dateHlp.getWeekDate({ baselineDate: new Date(_date) });
            isChanged = this.currentDateRange !== $event;
        }
        else {
            isChanged = this.currentDate !== $event;
        }
        if (isChanged) {
            this._dateChanged($event);
        }
    }
    /**
     * @private
     * @param {?=} newDate
     * @return {?}
     */
    _dateChanged(newDate) {
        if (newDate) {
            if (this.currentViewType === 'day') {
                this.currentDate = newDate;
            }
            else {
                this.currentDateRange = newDate;
            }
        }
        this.dateChanged.emit({
            viewType: this.currentViewType,
            dateValue: this.currentViewType === 'day' ? this.currentDate : this.currentDateRange,
            weekDays: this.currentWeekDays
        });
        this.calendarRef.closeDetailPanel();
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    onPlaceSelectChanged($event) {
        const { data } = $event;
        this.placeChanged.emit({
            viewType: this.currentViewType,
            dateValue: this.currentViewType === 'day' ? this.currentDate : this.currentDateRange,
            weekDays: this.currentWeekDays,
            room: data.id ? data : null
        });
    }
}
ToolbarComponent.decorators = [
    { type: Component, args: [{
                selector: 'toolbar',
                template: "<div class=\"toolbar\" style=\"overflow-x: auto ;\">\r\n\r\n    <div class=\"view-type \">\r\n        <button class=\"btn-day\" type=\"button\" [class.btn-active]=\"currentViewType === 'day'\" (click)=\"changeCalendarView($event, 'day')\">{{'appointment.day'|locale}}</button>\r\n        <button class=\"btn-day\" type=\"button\" [class.btn-active]=\"currentViewType === 'week'\" (click)=\"changeCalendarView($event, 'week')\">{{'appointment.week'|locale}}</button>\r\n    </div>\r\n    <span class=\"line\"></span>\r\n    <div class=\"btns\">\r\n        <button class=\"btn-today\" (click)=\"onDateButtonClicked($event, 0)\">{{ currentViewType === 'day'? ('appointment.today'|locale ): ('appointment.thisWeek'|locale)}}</button>\r\n\r\n        <div class=\"btn-group\">\r\n            <button class=\"btn-prev\" (click)=\"onDateButtonClicked($event, -1)\" title=\"{{ currentViewType === 'day'? ('appointment.prevDay'|locale): ('appointment.prevWeek'|locale) }}\">\r\n                <i class=\"f-icon f-icon-arrow-chevron-left\"></i>\r\n            </button>\r\n            <button class=\"btn-next\" (click)=\"onDateButtonClicked($event, 1)\" title=\"{{ currentViewType === 'day'? ('appointment.nextDay'|locale): ('appointment.nextWeek'|locale) }}\">\r\n                <i class=\"f-icon f-icon-arrow-chevron-right\"></i>\r\n            </button>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"inputs d-flex\">\r\n        <div class=\"datebox mr-4\" [style.width.px]=\"currentViewType === 'day'? 180 : 260\">\r\n            <farris-datepicker [ngModel]=\"currentDate\" [editable]=\"false\"\r\n                dateFormat=\"{{'appointment.dateFormat'|locale}}\" returnFormat=\"yyyy-MM-dd\" \r\n                placeholder=\"\u8BF7\u9009\u62E9\" *ngIf=\"currentViewType === 'day'\" [showClear]=\"false\"\r\n                (valueChange)=\"onDateChanged($event.returnFormatted)\"></farris-datepicker>\r\n            <farris-datepicker [ngModel]=\"currentDateRange\"  [editable]=\"false\" [dateRange]=\"true\"\r\n                dateFormat=\"{{'appointment.dateFormat'|locale}}\" returnFormat=\"yyyy-MM-dd\" [showType]=\"4\" \r\n                *ngIf=\"currentViewType === 'week'\" [showClear]=\"false\"\r\n                (valueChange)=\"onDateChanged($event.returnFormatted)\"></farris-datepicker>\r\n        </div>\r\n        <div class=\"roomlist-input\" style=\"width: 176px; display: none;\">\r\n            <farris-combo-list #cmb1 \r\n                [placeholder]=\"'appointment.datePlace'|locale\"\r\n                [enableClear]=\"true\"\r\n                [idField]=\"placeIdField\"\r\n                [textField]=\"placeNameField\"\r\n                [data]=\"places\" \r\n                [panelHeight]=\"260\"\r\n                [readonly]=\"false\"\r\n                [disabled]=\"false\"\r\n                [editable]=\"true\"\r\n                (selectChange)=\"onPlaceSelectChanged($event)\">\r\n            </farris-combo-list>\r\n        </div>\r\n    </div>\r\n\r\n</div>",
                encapsulation: ViewEncapsulation.None
            }] }
];
/** @nocollapse */
ToolbarComponent.ctorParameters = () => [
    { type: DateTimeHelperService },
    { type: Injector },
    { type: AppointmentCalendarComponent }
];
ToolbarComponent.propDecorators = {
    dateChanged: [{ type: Output }],
    placeChanged: [{ type: Output }],
    currentViewType: [{ type: Input }],
    places: [{ type: Input }],
    placeIdField: [{ type: Input }],
    placeNameField: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    ToolbarComponent.prototype.dateChanged;
    /** @type {?} */
    ToolbarComponent.prototype.placeChanged;
    /** @type {?} */
    ToolbarComponent.prototype.currentDate;
    /** @type {?} */
    ToolbarComponent.prototype.currentDateRange;
    /** @type {?} */
    ToolbarComponent.prototype.currentWeekDays;
    /** @type {?} */
    ToolbarComponent.prototype.currentViewType;
    /** @type {?} */
    ToolbarComponent.prototype.places;
    /** @type {?} */
    ToolbarComponent.prototype.placeIdField;
    /** @type {?} */
    ToolbarComponent.prototype.placeNameField;
    /**
     * @type {?}
     * @private
     */
    ToolbarComponent.prototype.dateHlp;
    /**
     * @type {?}
     * @private
     */
    ToolbarComponent.prototype.injector;
    /** @type {?} */
    ToolbarComponent.prototype.calendarRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9vbGJhci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2FwcG9pbnRtZW50LWNhbGVuZGFyLyIsInNvdXJjZXMiOlsibGliL3ZpZXdzL3Rvb2xiYXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQWlCLFNBQVMsRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBcUIsTUFBTSxFQUFpQixpQkFBaUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNySixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUM1QyxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQVNqRixNQUFNLE9BQU8sZ0JBQWdCOzs7Ozs7SUFlekIsWUFBb0IsT0FBOEIsRUFBVSxRQUFrQixFQUFTLFdBQXlDO1FBQTVHLFlBQU8sR0FBUCxPQUFPLENBQXVCO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFTLGdCQUFXLEdBQVgsV0FBVyxDQUE4QjtRQWJ0SCxnQkFBVyxHQUFHLElBQUksWUFBWSxFQUF3QixDQUFDO1FBQ3ZELGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUU1QyxnQkFBVyxHQUFHLEVBQUUsQ0FBQztRQUNqQixxQkFBZ0IsR0FBRyxFQUFFLENBQUM7UUFDdEIsb0JBQWUsR0FBRyxFQUFFLENBQUM7UUFFWixvQkFBZSxHQUFxQixLQUFLLENBQUM7UUFDMUMsV0FBTSxHQUFHLEVBQUUsQ0FBQztRQUNaLGlCQUFZLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLG1CQUFjLEdBQUcsTUFBTSxDQUFDO0lBR21HLENBQUM7Ozs7SUFFckksUUFBUTtRQUNKLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNwQixDQUFDOzs7OztJQUVELFdBQVcsQ0FBQyxPQUFz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RSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUk7U0FDOUIsQ0FBQyxDQUFDO0lBQ1AsQ0FBQzs7O1lBNUlKLFNBQVMsU0FBQztnQkFDUCxRQUFRLEVBQUUsU0FBUztnQkFDbkIsbThGQUFxQztnQkFDckMsYUFBYSxFQUFFLGlCQUFpQixDQUFDLElBQUk7YUFDeEM7Ozs7WUFUUSxxQkFBcUI7WUFEbUIsUUFBUTtZQUdoRCw0QkFBNEI7OzswQkFXaEMsTUFBTTsyQkFDTixNQUFNOzhCQU1OLEtBQUs7cUJBQ0wsS0FBSzsyQkFDTCxLQUFLOzZCQUNMLEtBQUs7Ozs7SUFWTix1Q0FBaUU7O0lBQ2pFLHdDQUE0Qzs7SUFFNUMsdUNBQWlCOztJQUNqQiw0Q0FBc0I7O0lBQ3RCLDJDQUFxQjs7SUFFckIsMkNBQW1EOztJQUNuRCxrQ0FBcUI7O0lBQ3JCLHdDQUE2Qjs7SUFDN0IsMENBQWlDOzs7OztJQUdyQixtQ0FBc0M7Ozs7O0lBQUUsb0NBQTBCOztJQUFFLHVDQUFnRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFmdGVyVmlld0luaXQsIENvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBJbmplY3RvciwgSW5wdXQsIE9uQ2hhbmdlcywgT25Jbml0LCBPdXRwdXQsIFNpbXBsZUNoYW5nZXMsIFZpZXdFbmNhcHN1bGF0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IERhdGVUaW1lSGVscGVyU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktY29tbW9uL2RhdGUnO1xyXG5pbXBvcnQgeyBhZGREYXlzLCBzdWJEYXlzIH0gZnJvbSAnZGF0ZS1mbnMnO1xyXG5pbXBvcnQgeyBBcHBvaW50bWVudENhbGVuZGFyQ29tcG9uZW50IH0gZnJvbSAnLi4vYXBwb2ludG1lbnQtY2FsZW5kYXIuY29tcG9uZW50JztcclxuaW1wb3J0IHsgQ2FsZW5kYXJWaWV3VHlwZSwgVmlld1R5cGVDaGFuZ2VkUGFyYW0gfSBmcm9tICcuLi9tb2RlbHMvY2FsZW5kYXkudHlwZXMnO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgICBzZWxlY3RvcjogJ3Rvb2xiYXInLFxyXG4gICAgdGVtcGxhdGVVcmw6ICd0b29sYmFyLmNvbXBvbmVudC5odG1sJyxcclxuICAgIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmVcclxufSlcclxuXHJcbmV4cG9ydCBjbGFzcyBUb29sYmFyQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMsIEFmdGVyVmlld0luaXQge1xyXG5cclxuICAgIEBPdXRwdXQoKSBkYXRlQ2hhbmdlZCA9IG5ldyBFdmVudEVtaXR0ZXI8Vmlld1R5cGVDaGFuZ2VkUGFyYW0+KCk7XHJcbiAgICBAT3V0cHV0KCkgcGxhY2VDaGFuZ2VkID0gbmV3IEV2ZW50RW1pdHRlcigpO1xyXG5cclxuICAgIGN1cnJlbnREYXRlID0gJyc7XHJcbiAgICBjdXJyZW50RGF0ZVJhbmdlID0gJyc7XHJcbiAgICBjdXJyZW50V2Vla0RheXMgPSBbXTtcclxuICAgIFxyXG4gICAgQElucHV0KCkgY3VycmVudFZpZXdUeXBlOiBDYWxlbmRhclZpZXdUeXBlID0gJ2RheSc7XHJcbiAgICBASW5wdXQoKSBwbGFjZXMgPSBbXTtcclxuICAgIEBJbnB1dCgpIHBsYWNlSWRGaWVsZCA9ICdpZCc7XHJcbiAgICBASW5wdXQoKSBwbGFjZU5hbWVGaWVsZCA9ICduYW1lJztcclxuXHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBkYXRlSGxwOiBEYXRlVGltZUhlbHBlclNlcnZpY2UsIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwdWJsaWMgY2FsZW5kYXJSZWY6IEFwcG9pbnRtZW50Q2FsZW5kYXJDb21wb25lbnQpIHsgfVxyXG5cclxuICAgIG5nT25Jbml0KCkge1xyXG4gICAgICAgIHRoaXMuaW5pdERhdGUoKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKGNoYW5nZXMucm9vbXMgJiYgIWNoYW5nZXMucm9vbXMuaXNGaXJzdENoYW5nZSgpKSB7XHJcbiAgICAgICAgICAgIHRoaXMucGxhY2VzID0gW3sgW3RoaXMucGxhY2VJZEZpZWxkXTogJycsIFt0aGlzLnBsYWNlTmFtZUZpZWxkXTogJ+WFqOmDqOWcuuaJgCcgfSwgLi4udGhpcy5wbGFjZXNdO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBuZ0FmdGVyVmlld0luaXQoKSB7fVxyXG5cclxuICAgIHByaXZhdGUgaW5pdERhdGUoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuY3VycmVudFZpZXdUeXBlID09PSAnd2VlaycgJiYgIXRoaXMuY3VycmVudERhdGVSYW5nZSApIHtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50V2Vla0RheXMgPSB0aGlzLmRhdGVIbHAuZ2V0V2Vla0RhdGUoeyBiYXNlbGluZURhdGU6IG5ldyBEYXRlKCl9KTtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50RGF0ZVJhbmdlID0gdGhpcy5jdXJyZW50V2Vla0RheXNbMF0uZGF0ZVN0ciArICd+JyArIHRoaXMuY3VycmVudFdlZWtEYXlzWzZdLmRhdGVTdHI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmN1cnJlbnREYXRlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnREYXRlID0gdGhpcy5kYXRlSGxwLmZvcm1hdFRvKG5ldyBEYXRlKCksICd5eXl5LU1NLWRkJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2RhdGVDaGFuZ2VkKCk7XHJcbiAgICB9XHJcblxyXG4gICAgY2hhbmdlQ2FsZW5kYXJWaWV3KCRldmVudDogTW91c2VFdmVudCwgdmlld1R5cGU6IENhbGVuZGFyVmlld1R5cGUpIHtcclxuICAgICAgICBpZiAoJGV2ZW50KSB7XHJcbiAgICAgICAgICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jdXJyZW50Vmlld1R5cGUgPSB2aWV3VHlwZTtcclxuICAgICAgICB0aGlzLmluaXREYXRlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgb25EYXRlQnV0dG9uQ2xpY2tlZCgkZXZlbnQ6IE1vdXNlRXZlbnQsIHR5cDogbnVtYmVyKSB7XHJcbiAgICAgICAgbGV0IGJhc2VsaW5lRGF0ZTogYW55ID0gbmV3IERhdGUoKTtcclxuICAgICAgICBpZiAodGhpcy5jdXJyZW50Vmlld1R5cGUgPT09ICdkYXknKSB7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RGF0ZSkge1xyXG4gICAgICAgICAgICAgICAgYmFzZWxpbmVEYXRlID0gbmV3IERhdGUodGhpcy5jdXJyZW50RGF0ZSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGxldCBuZXdEYXRlU3RyID0gdGhpcy5kYXRlSGxwLmZvcm1hdFRvKG5ldyBEYXRlKCksICd5eXl5LU1NLWRkJyk7XHJcbiAgICAgICAgICAgIGlmICh0eXAgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkID0gdGhpcy5kYXRlSGxwLmZvcm1hdFRvKHN1YkRheXMoYmFzZWxpbmVEYXRlLCAxKSwgJ3l5eXktTU0tZGQnKVxyXG4gICAgICAgICAgICAgICAgbmV3RGF0ZVN0ciA9IHRoaXMuZGF0ZUhscC5mb3JtYXRUbyhkKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXAgPT09IDEpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGQgPSB0aGlzLmRhdGVIbHAuZm9ybWF0VG8oYWRkRGF5cyhiYXNlbGluZURhdGUsIDEpLCAneXl5eS1NTS1kZCcpXHJcbiAgICAgICAgICAgICAgICBuZXdEYXRlU3RyID0gdGhpcy5kYXRlSGxwLmZvcm1hdFRvKGQpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnREYXRlID0gbmV3RGF0ZVN0cjtcclxuICAgICAgICAgICBcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudFdlZWtEYXlzICYmIHRoaXMuY3VycmVudFdlZWtEYXlzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgYmFzZWxpbmVEYXRlID0gdGhpcy5jdXJyZW50V2Vla0RheXNbNF0uZGF0ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyDkuIvlkahcclxuICAgICAgICAgICAgaWYgKHR5cCA9PT0gMSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50V2Vla0RheXMgPSB0aGlzLmRhdGVIbHAuZ2V0V2Vla0RhdGUoeyBiYXNlbGluZURhdGUsIHJhbmdlOiA3fSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwID09PSAtMSkgeyAvLyDkuIrlkahcclxuICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFdlZWtEYXlzID0gdGhpcy5kYXRlSGxwLmdldFdlZWtEYXRlKHsgYmFzZWxpbmVEYXRlLCByYW5nZTogLTd9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHsgLy8g5b2T5YmN5ZGoXHJcbiAgICAgICAgICAgICAgICBiYXNlbGluZURhdGUgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50V2Vla0RheXMgPSAgdGhpcy5kYXRlSGxwLmdldFdlZWtEYXRlKHsgYmFzZWxpbmVEYXRlfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudERhdGVSYW5nZSA9IHRoaXMuY3VycmVudFdlZWtEYXlzWzBdLmRhdGVTdHIgKyAnficgKyB0aGlzLmN1cnJlbnRXZWVrRGF5c1s2XS5kYXRlU3RyO1xyXG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyh0aGlzLmN1cnJlbnRXZWVrRGF5cyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLl9kYXRlQ2hhbmdlZCgpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uRGF0ZUNoYW5nZWQoJGV2ZW50OiBzdHJpbmcpIHtcclxuXHJcbiAgICAgICAgbGV0IGlzQ2hhbmdlZCA9IGZhbHNlO1xyXG4gICAgICAgIGlmICh0aGlzLmN1cnJlbnRWaWV3VHlwZSA9PSAnd2VlaycpIHtcclxuICAgICAgICAgICAgY29uc3QgX2RhdGUgPSAkZXZlbnQuc3BsaXQoJ34nKVswXTtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50V2Vla0RheXMgPSAgdGhpcy5kYXRlSGxwLmdldFdlZWtEYXRlKHsgYmFzZWxpbmVEYXRlOiBuZXcgRGF0ZShfZGF0ZSl9KTtcclxuXHJcbiAgICAgICAgICAgIGlzQ2hhbmdlZCA9IHRoaXMuY3VycmVudERhdGVSYW5nZSAhPT0gJGV2ZW50O1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlzQ2hhbmdlZCA9IHRoaXMuY3VycmVudERhdGUgIT09ICRldmVudDtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKGlzQ2hhbmdlZCkge1xyXG4gICAgICAgICAgICB0aGlzLl9kYXRlQ2hhbmdlZCgkZXZlbnQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9kYXRlQ2hhbmdlZChuZXdEYXRlPzogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKG5ld0RhdGUpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudFZpZXdUeXBlID09PSAnZGF5JyApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudERhdGUgPSBuZXdEYXRlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RGF0ZVJhbmdlID0gbmV3RGF0ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5kYXRlQ2hhbmdlZC5lbWl0KHsgXHJcbiAgICAgICAgICAgIHZpZXdUeXBlOiB0aGlzLmN1cnJlbnRWaWV3VHlwZSxcclxuICAgICAgICAgICAgZGF0ZVZhbHVlOiB0aGlzLmN1cnJlbnRWaWV3VHlwZSA9PT0gJ2RheScgPyB0aGlzLmN1cnJlbnREYXRlIDogdGhpcy5jdXJyZW50RGF0ZVJhbmdlLCBcclxuICAgICAgICAgICAgd2Vla0RheXM6IHRoaXMuY3VycmVudFdlZWtEYXlzXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuY2FsZW5kYXJSZWYuY2xvc2VEZXRhaWxQYW5lbCgpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uUGxhY2VTZWxlY3RDaGFuZ2VkKCRldmVudCkge1xyXG4gICAgICAgIGNvbnN0IHsgZGF0YSB9ID0gJGV2ZW50O1xyXG4gICAgICAgIHRoaXMucGxhY2VDaGFuZ2VkLmVtaXQoeyBcclxuICAgICAgICAgICAgdmlld1R5cGU6IHRoaXMuY3VycmVudFZpZXdUeXBlLFxyXG4gICAgICAgICAgICBkYXRlVmFsdWU6IHRoaXMuY3VycmVudFZpZXdUeXBlID09PSAnZGF5JyA/IHRoaXMuY3VycmVudERhdGUgOiB0aGlzLmN1cnJlbnREYXRlUmFuZ2UsIFxyXG4gICAgICAgICAgICB3ZWVrRGF5czogdGhpcy5jdXJyZW50V2Vla0RheXMsXHJcbiAgICAgICAgICAgIHJvb206IGRhdGEuaWQgPyBkYXRhIDogbnVsbFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59Il19