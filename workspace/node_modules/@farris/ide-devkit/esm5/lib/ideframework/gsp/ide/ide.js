/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { ModalFrm } from './modal-frm';
import { forkJoin, Observable, of } from 'rxjs';
import { map } from 'rxjs/operators';
/**
 * 提供ide运行所需的方法，供插件使用
 */
var /**
 * 提供ide运行所需的方法，供插件使用
 */
Ide = /** @class */ (function () {
    function Ide(parent) {
        this.events = new Map();
        this.modal = new ModalFrm();
        this.frameId = this.getParam('frameID');
        if (this.isTop) {
            this.commandData = new Map();
        }
        if (parent) {
            this.msgr = parent.messager;
        }
    }
    Object.defineProperty(Ide.prototype, "isTop", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            return window.top === window;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Ide.prototype, "parentInstance", {
        get: /**
         * @private
         * @template THIS
         * @this {THIS}
         * @return {THIS}
         */
        function () {
            /** @type {?} */
            var instance = (/** @type {?} */ (this));
            /** @type {?} */
            var top = window.top;
            if (top && top['gsp']) {
                instance = top['gsp'].ide;
            }
            return instance;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Ide.prototype, "messager", {
        get: /**
         * @return {?}
         */
        function () {
            return this.msgr;
        },
        enumerable: true,
        configurable: true
    });
    /* #region  frame util */
    /* #region  frame util */
    /**
     * @param {?} key
     * @return {?}
     */
    Ide.prototype.getParam = /* #region  frame util */
    /**
     * @param {?} key
     * @return {?}
     */
    function (key) {
        /** @type {?} */
        var params = new URLSearchParams(window.location.search);
        return unescape(params.get(key));
    };
    /**
     * @param {?=} frameId
     * @return {?}
     */
    Ide.prototype.getInitCommandData = /**
     * @param {?=} frameId
     * @return {?}
     */
    function (frameId) {
        if (!this.isTop) {
            frameId = frameId || this.frameId;
            return this.parentInstance.getInitCommandData(frameId);
        }
        else {
            return this.commandData.get(frameId);
        }
    };
    /**
     * @param {?} frameId
     * @param {?} data
     * @return {?}
     */
    Ide.prototype.setInitCommandData = /**
     * @param {?} frameId
     * @param {?} data
     * @return {?}
     */
    function (frameId, data) {
        if (!this.isTop) {
            this.parentInstance.setInitCommandData(frameId, data);
        }
        else {
            this.commandData.set(frameId, data);
        }
    };
    /**
     * @param {?} messager
     * @return {?}
     */
    Ide.prototype.setMessager = /**
     * @param {?} messager
     * @return {?}
     */
    function (messager) {
        this.msgr = messager;
    };
    /* #endregion */
    /* #region  event */
    /* #endregion */
    /* #region  event */
    /**
     * @param {?} cb
     * @return {?}
     */
    Ide.prototype.onPanelAdded = /* #endregion */
    /* #region  event */
    /**
     * @param {?} cb
     * @return {?}
     */
    function (cb) {
        this.on('panel-added', cb);
    };
    /**
     * @param {?} cb
     * @return {?}
     */
    Ide.prototype.onPanelRemoved = /**
     * @param {?} cb
     * @return {?}
     */
    function (cb) {
        this.on('panel-removed', cb);
    };
    /**
     * @param {?} cb
     * @return {?}
     */
    Ide.prototype.onPanelShown = /**
     * @param {?} cb
     * @return {?}
     */
    function (cb) {
        this.on('panel-shown', cb);
    };
    /**
     * @param {?} cb
     * @return {?}
     */
    Ide.prototype.onPanelHidden = /**
     * @param {?} cb
     * @return {?}
     */
    function (cb) {
        this.on('panel-hidden', cb);
    };
    /**
     * @param {?} cb
     * @return {?}
     */
    Ide.prototype.onModalConfirming = /**
     * @param {?} cb
     * @return {?}
     */
    function (cb) {
        if (this.parentInstance !== this) {
            this.parentInstance.onModalConfirming(cb);
        }
        else {
            this.on('confirm-modal', cb);
        }
    };
    /**
     * @param {?} cb
     * @return {?}
     */
    Ide.prototype.onModalCancelling = /**
     * @param {?} cb
     * @return {?}
     */
    function (cb) {
        this.on('cancel-modal', cb);
    };
    /**
     * @param {?} cb
     * @return {?}
     */
    Ide.prototype.onLeftActivated = /**
     * @param {?} cb
     * @return {?}
     */
    function (cb) {
        if (this.isTop) {
            this.on('activate-left', cb);
        }
        else {
            this.parentInstance.onLeftActivated(cb);
        }
    };
    /**
     * @param {?} cb
     * @return {?}
     */
    Ide.prototype.onNotifyShown = /**
     * @param {?} cb
     * @return {?}
     */
    function (cb) {
        this.on('show-notify', cb);
    };
    /**
     * @param {?} cb
     * @return {?}
     */
    Ide.prototype.onLoadingShown = /**
     * @param {?} cb
     * @return {?}
     */
    function (cb) {
        this.on('show-loading', cb);
    };
    /**
     * @param {?} cb
     * @return {?}
     */
    Ide.prototype.onLoadingHidden = /**
     * @param {?} cb
     * @return {?}
     */
    function (cb) {
        this.on('hide-loading', cb);
    };
    /**
     * @param {?} cb
     * @return {?}
     */
    Ide.prototype.onDesignerStatusSet = /**
     * @param {?} cb
     * @return {?}
     */
    function (cb) {
        this.on('set-designer-status', cb);
    };
    // onBeforeClose(id: string, cb: () => boolean) {
    //   this.on('on-before-close', ({metadataId}) => {
    //     if (id === metadataId) {
    //       return cb();
    //     }
    //     return true;
    //   });
    // }
    // onBeforeClose(id: string, cb: () => boolean) {
    //   this.on('on-before-close', ({metadataId}) => {
    //     if (id === metadataId) {
    //       return cb();
    //     }
    //     return true;
    //   });
    // }
    /**
     * @param {?} id
     * @param {?} cb
     * @return {?}
     */
    Ide.prototype.onCloseTab = 
    // onBeforeClose(id: string, cb: () => boolean) {
    //   this.on('on-before-close', ({metadataId}) => {
    //     if (id === metadataId) {
    //       return cb();
    //     }
    //     return true;
    //   });
    // }
    /**
     * @param {?} id
     * @param {?} cb
     * @return {?}
     */
    function (id, cb) {
        if (!this.isTop) {
            return this.parentInstance.onCloseTab(id, cb);
        }
        this.on('close-tab', function (tabId) {
            if (id === tabId) {
                return cb();
            }
            return true;
        });
    };
    /* #endregion */
    /* #region  panel */
    /* #endregion */
    /* #region  panel */
    /**
     * @param {?} options
     * @return {?}
     */
    Ide.prototype.addPanel = /* #endregion */
    /* #region  panel */
    /**
     * @param {?} options
     * @return {?}
     */
    function (options) {
        this.emit('panel-added', options);
    };
    /* #endregion */
    /* #region  modal */
    /* #endregion */
    /* #region  modal */
    /**
     * @param {?} options
     * @return {?}
     */
    Ide.prototype.addModal = /* #endregion */
    /* #region  modal */
    /**
     * @param {?} options
     * @return {?}
     */
    function (options) {
        this.emit('panel-added', options, 'modal');
    };
    /**
     * @param {?=} id
     * @return {?}
     */
    Ide.prototype.closeModal = /**
     * @param {?=} id
     * @return {?}
     */
    function (id) {
        if (this.parentInstance !== this) {
            this.parentInstance.closeModal(id);
        }
        this.emit('panel-removed', id, 'modal');
    };
    /**
     * @param {?} id
     * @return {?}
     */
    Ide.prototype.confirmModal = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        /** @type {?} */
        var result = true;
        // if (this.parentInstance !== this) {
        //   result = this.parentInstance.confirmModal(id);
        // }
        result = result && (/** @type {?} */ (this.emit('confirm-modal', id)));
        return result;
    };
    /**
     * @param {?} id
     * @return {?}
     */
    Ide.prototype.cancelModal = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        /** @type {?} */
        var result = true;
        if (this.parentInstance !== this) {
            result = this.parentInstance.cancelModal(id);
        }
        result = result && (/** @type {?} */ (this.emit('cancel-modal', id)));
        return result;
    };
    // addLeft    registryOpener....
    /* #endregion */
    /* #region  left rigion */
    // addLeft    registryOpener....
    /* #endregion */
    /* #region  left rigion */
    /**
     * @param {?=} frameId
     * @return {?}
     */
    Ide.prototype.activateLeft = 
    // addLeft    registryOpener....
    /* #endregion */
    /* #region  left rigion */
    /**
     * @param {?=} frameId
     * @return {?}
     */
    function (frameId) {
        frameId = frameId || this.frameId;
        if (this.isTop) {
            this.emit('activate-left', frameId);
        }
        else {
            this.parentInstance.activateLeft(frameId);
        }
    };
    /* #endregion */
    /* #endregion */
    /**
     * @param {?} level
     * @param {?} content
     * @return {?}
     */
    Ide.prototype.notify = /* #endregion */
    /**
     * @param {?} level
     * @param {?} content
     * @return {?}
     */
    function (level, content) {
        if (this.isTop) {
            this.emit('show-notify', level, content);
        }
        else {
            this.parentInstance.notify(level, content);
        }
    };
    /**
     * @param {?=} message
     * @return {?}
     */
    Ide.prototype.loading = /**
     * @param {?=} message
     * @return {?}
     */
    function (message) {
        if (this.isTop) {
            this.emit('show-loading', message);
        }
        else {
            this.parentInstance.loading(message);
        }
    };
    /**
     * @return {?}
     */
    Ide.prototype.loaded = /**
     * @return {?}
     */
    function () {
        if (this.isTop) {
            this.emit('hide-loading');
        }
        else {
            this.parentInstance.loaded();
        }
    };
    /**
     * @param {?} metadataId
     * @param {?} isDirty
     * @return {?}
     */
    Ide.prototype.setDesignerStatus = /**
     * @param {?} metadataId
     * @param {?} isDirty
     * @return {?}
     */
    function (metadataId, isDirty) {
        if (this.isTop) {
            this.emit('set-designer-status', { id: metadataId, isDirty: isDirty });
        }
        else {
            this.parentInstance.setDesignerStatus(metadataId, isDirty);
        }
    };
    // closeDesigner(metadataId: string) {
    //   if (this.isTop) {
    //     this.emit('close-designer', {id: metadataId});
    //   } else {
    //     this.parentInstance.closeDesigner(metadataId);
    //   }
    // }
    // closeDesigner(metadataId: string) {
    //   if (this.isTop) {
    //     this.emit('close-designer', {id: metadataId});
    //   } else {
    //     this.parentInstance.closeDesigner(metadataId);
    //   }
    // }
    /**
     * @param {?} id
     * @return {?}
     */
    Ide.prototype.notifyCloseTab = 
    // closeDesigner(metadataId: string) {
    //   if (this.isTop) {
    //     this.emit('close-designer', {id: metadataId});
    //   } else {
    //     this.parentInstance.closeDesigner(metadataId);
    //   }
    // }
    /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        if (!this.isTop) {
            return this.parentInstance.notifyCloseTab(id);
        }
        /** @type {?} */
        var result = this.emit('close-tab', id);
        if (result == null) {
            return of(true);
        }
        else if (typeof result === 'boolean') {
            return of(result);
        }
        else {
            return result;
        }
    };
    /**
     * @param {?} workspace
     * @return {?}
     */
    Ide.prototype.registerIDE = /**
     * @param {?} workspace
     * @return {?}
     */
    function (workspace) {
        // 用来把ide view实例与gsp对象绑定。
        // TODO： view实例监听gsp对象的操作放在这里。
        if (typeof workspace.onCloseDesigner === 'function') {
            this.on('close-designer', workspace.onCloseDesigner.bind(workspace));
        }
    };
    /* #region  private method */
    /* #region  private method */
    /**
     * @private
     * @param {?} name
     * @param {?} cb
     * @return {?}
     */
    Ide.prototype.on = /* #region  private method */
    /**
     * @private
     * @param {?} name
     * @param {?} cb
     * @return {?}
     */
    function (name, cb) {
        /** @type {?} */
        var callbacks = this.events.get(name);
        if (!callbacks) {
            callbacks = [cb];
            this.events.set(name, callbacks);
        }
        else {
            callbacks.push(cb);
        }
    };
    /**
     * @private
     * @param {?} name
     * @param {...?} params
     * @return {?}
     */
    Ide.prototype.emit = /**
     * @private
     * @param {?} name
     * @param {...?} params
     * @return {?}
     */
    function (name) {
        var params = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            params[_i - 1] = arguments[_i];
        }
        var e_1, _a;
        /** @type {?} */
        var callbacks = this.events.get(name);
        if (!callbacks || !callbacks.length) {
            return;
        }
        /** @type {?} */
        var result = true;
        /** @type {?} */
        var observableResult = new Array();
        try {
            for (var callbacks_1 = tslib_1.__values(callbacks), callbacks_1_1 = callbacks_1.next(); !callbacks_1_1.done; callbacks_1_1 = callbacks_1.next()) {
                var cb = callbacks_1_1.value;
                /** @type {?} */
                var cbResult = cb.apply(void 0, tslib_1.__spread(params));
                if (cbResult == null) {
                    continue;
                }
                if (typeof cbResult === 'boolean') {
                    result = result && cbResult;
                }
                else if (typeof cbResult.subscribe === 'function' && cbResult.constructor.name === Observable.name) {
                    // 判断条件不能使用cbResult instanceof Observable,因为cb可能是来自于不同的iframe环境，导致跟这里的Observable构造函数不一样。
                    observableResult.push(cbResult);
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (callbacks_1_1 && !callbacks_1_1.done && (_a = callbacks_1.return)) _a.call(callbacks_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        if (observableResult.length) {
            return forkJoin(tslib_1.__spread(observableResult, [of(result)])).pipe(map(function (results) {
                return results.reduce(function (previous, current) { return previous && current; });
            }));
        }
        else {
            return result;
        }
    };
    return Ide;
}());
/**
 * 提供ide运行所需的方法，供插件使用
 */
export { Ide };
if (false) {
    /**
     * @type {?}
     * @private
     */
    Ide.prototype.frameId;
    /**
     * @type {?}
     * @private
     */
    Ide.prototype.events;
    /**
     * @type {?}
     * @private
     */
    Ide.prototype.modal;
    /**
     * @type {?}
     * @private
     */
    Ide.prototype.commandData;
    /**
     * @type {?}
     * @private
     */
    Ide.prototype.msgr;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9pZGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2lkZWZyYW1ld29yay9nc3AvaWRlL2lkZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFdkMsT0FBTyxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2hELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQVFyQzs7OztJQXNCRSxhQUFZLE1BQVk7UUFDdEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBaUIsQ0FBQztRQUN2QyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksUUFBUSxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3hDLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNkLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxHQUFHLEVBQWUsQ0FBQztTQUMzQztRQUNELElBQUksTUFBTSxFQUFFO1lBQ1YsSUFBSSxDQUFDLElBQUksR0FBSSxNQUFNLENBQUMsUUFBUSxDQUFDO1NBQzlCO0lBQ0gsQ0FBQztJQTFCRCxzQkFBWSxzQkFBSzs7Ozs7UUFBakI7WUFDRSxPQUFPLE1BQU0sQ0FBQyxHQUFHLEtBQUssTUFBTSxDQUFDO1FBQy9CLENBQUM7OztPQUFBO0lBQ0Qsc0JBQVksK0JBQWM7Ozs7Ozs7UUFBMUI7O2dCQUNNLFFBQVEsR0FBRyxtQkFBQSxJQUFJLEVBQUE7O2dCQUNiLEdBQUcsR0FBRyxNQUFNLENBQUMsR0FBRztZQUN0QixJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0JBQ3JCLFFBQVEsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMs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RjtvQkFDeEYsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2lCQUNqQzthQUNGOzs7Ozs7Ozs7UUFFRCxJQUFJLGdCQUFnQixDQUFDLE1BQU0sRUFBRTtZQUMzQixPQUFPLFFBQVEsa0JBQUssZ0JBQWdCLEdBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxHQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFBLE9BQU87Z0JBQ2pFLE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxVQUFDLFFBQVEsRUFBRSxPQUFPLElBQUssT0FBQSxRQUFRLElBQUksT0FBTyxFQUFuQixDQUFtQixDQUFDLENBQUM7WUFDcEUsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNMO2FBQU07WUFDTCxPQUFPLE1BQU0sQ0FBQztTQUNmO0lBRUgsQ0FBQztJQUVILFVBQUM7QUFBRCxDQUFDLEFBdFNELElBc1NDOzs7Ozs7Ozs7O0lBclNDLHNCQUF3Qjs7Ozs7SUFDeEIscUJBQW1DOzs7OztJQUNuQyxvQkFBd0I7Ozs7O0lBQ3hCLDBCQUFzQzs7Ozs7SUFDdEMsbUJBQXVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWVzc2FnZXIgfSBmcm9tICcuL21lc3NhZ2VyJztcclxuaW1wb3J0IHsgTW9kYWxGcm0gfSBmcm9tICcuL21vZGFsLWZybSc7XHJcbmltcG9ydCB7IE5vdGlmeU9wdGlvbnMgfSBmcm9tICdAZmFycmlzL3VpLW5vdGlmeSc7XHJcbmltcG9ydCB7IGZvcmtKb2luLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5cclxuXHJcbi8qKlxyXG4gKiDmj5DkvptpZGXov5DooYzmiYDpnIDnmoTmlrnms5XvvIzkvpvmj5Lku7bkvb/nlKhcclxuICovXHJcblxyXG5leHBvcnQgY2xhc3MgSWRlIHtcclxuICBwcml2YXRlIGZyYW1lSWQ6IHN0cmluZztcclxuICBwcml2YXRlIGV2ZW50czogTWFwPHN0cmluZywgYW55W10+O1xyXG4gIHByaXZhdGUgbW9kYWw6IE1vZGFsRnJtO1xyXG4gIHByaXZhdGUgY29tbWFuZERhdGE6IE1hcDxzdHJpbmcsIGFueT47XHJcbiAgcHJpdmF0ZSBtc2dyOiBNZXNzYWdlcjtcclxuICBwcml2YXRlIGdldCBpc1RvcCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB3aW5kb3cudG9wID09PSB3aW5kb3c7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0IHBhcmVudEluc3RhbmNlKCkge1xyXG4gICAgbGV0IGluc3RhbmNlID0gdGhpcztcclxuICAgIGNvbnN0IHRvcCA9IHdpbmRvdy50b3A7XHJcbiAgICBpZiAodG9wICYmIHRvcFsnZ3NwJ10pIHtcclxuICAgICAgaW5zdGFuY2UgPSB0b3BbJ2dzcCddLmlkZTtcclxuICAgIH1cclxuICAgIHJldHVybiBpbnN0YW5jZTtcclxuICB9XHJcblxyXG4gIGdldCBtZXNzYWdlcigpOiBNZXNzYWdlciB7XHJcbiAgICByZXR1cm4gdGhpcy5tc2dyO1xyXG4gIH1cclxuXHJcbiAgY29uc3RydWN0b3IocGFyZW50PzogSWRlKSB7XHJcbiAgICB0aGlzLmV2ZW50cyA9IG5ldyBNYXA8c3RyaW5nLCBhbnlbXT4oKTtcclxuICAgIHRoaXMubW9kYWwgPSBuZXcgTW9kYWxGcm0oKTtcclxuICAgIHRoaXMuZnJhbWVJZCA9IHRoaXMuZ2V0UGFyYW0oJ2ZyYW1lSUQnKTtcclxuICAgIGlmICh0aGlzLmlzVG9wKSB7XHJcbiAgICAgIHRoaXMuY29tbWFuZERhdGEgPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xyXG4gICAgfVxyXG4gICAgaWYgKHBhcmVudCkge1xyXG4gICAgICB0aGlzLm1zZ3IgPSAgcGFyZW50Lm1lc3NhZ2VyO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyogI3JlZ2lvbiAgZnJhbWUgdXRpbCAqL1xyXG4gIGdldFBhcmFtKGtleTogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBwYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHdpbmRvdy5sb2NhdGlvbi5zZWFyY2gpO1xyXG4gICAgcmV0dXJuIHVuZXNjYXBlKHBhcmFtcy5nZXQoa2V5KSk7XHJcbiAgfVxyXG5cclxuICBnZXRJbml0Q29tbWFuZERhdGEoZnJhbWVJZD86IHN0cmluZyk6IGFueSB7XHJcbiAgICBpZiAoIXRoaXMuaXNUb3ApIHtcclxuICAgICAgZnJhbWVJZCA9IGZyYW1lSWQgfHwgdGhpcy5mcmFtZUlkO1xyXG4gICAgICByZXR1cm4gdGhpcy5wYXJlbnRJbnN0YW5jZS5nZXRJbml0Q29tbWFuZERhdGEoZnJhbWVJZCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdGhpcy5jb21tYW5kRGF0YS5nZXQoZnJhbWVJZCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzZXRJbml0Q29tbWFuZERhdGEoZnJhbWVJZDogc3RyaW5nLCBkYXRhOiBhbnkpIHtcclxuICAgIGlmICghdGhpcy5pc1RvcCkge1xyXG4gICAgICB0aGlzLnBhcmVudEluc3RhbmNlLnNldEluaXRDb21tYW5kRGF0YShmcmFtZUlkLCBkYXRhKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuY29tbWFuZERhdGEuc2V0KGZyYW1lSWQsIGRhdGEpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgc2V0TWVzc2FnZXIobWVzc2FnZXI6IE1lc3NhZ2VyKSB7XHJcbiAgICB0aGlzLm1zZ3IgPSBtZXNzYWdlcjtcclxuICB9XHJcbiAgLyogI2VuZHJlZ2lvbiAqL1xyXG5cclxuICAvKiAjcmVnaW9uICBldmVudCAqL1xyXG4gIG9uUGFuZWxBZGRlZChjYjogKG9wdGlvbnM6IGFueSwgbG9jYXRpb24/OiBzdHJpbmcpID0+IGFueSkge1xyXG4gICAgdGhpcy5vbigncGFuZWwtYWRkZWQnLCBjYik7XHJcbiAgfVxyXG5cclxuICBvblBhbmVsUmVtb3ZlZChjYjogKGlkOiBzdHJpbmcsIGxhY2F0aW9uOiBzdHJpbmcpID0+IGFueSkge1xyXG4gICAgdGhpcy5vbigncGFuZWwtcmVtb3ZlZCcsIGNiKTtcclxuICB9XHJcblxyXG4gIG9uUGFuZWxTaG93bihjYjogKGlkOiBzdHJpbmcpID0+IGFueSkge1xyXG4gICAgdGhpcy5vbigncGFuZWwtc2hvd24nLCBjYik7XHJcbiAgfVxyXG5cclxuICBvblBhbmVsSGlkZGVuKGNiOiAoaWQ6IHN0cmluZykgPT4gYW55KSB7XHJcbiAgICB0aGlzLm9uKCdwYW5lbC1oaWRkZW4nLCBjYik7XHJcbiAgfVxyXG5cclxuICBvbk1vZGFsQ29uZmlybWluZyhjYjogKGlkOiBzdHJpbmcpID0+IGJvb2xlYW4pIHtcclxuICAgIGlmICh0aGlzLnBhcmVudEluc3RhbmNlICE9PSB0aGlzKSB7XHJcbiAgICAgIHRoaXMucGFyZW50SW5zdGFuY2Uub25Nb2RhbENvbmZpcm1pbmcoY2IpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5vbignY29uZmlybS1tb2RhbCcsIGNiKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG9uTW9kYWxDYW5jZWxsaW5nKGNiOiAoaWQ6IHN0cmluZykgPT4gYm9vbGVhbikge1xyXG4gICAgdGhpcy5vbignY2FuY2VsLW1vZGFsJywgY2IpO1xyXG4gIH1cclxuXHJcbiAgb25MZWZ0QWN0aXZhdGVkKGNiOiAoaWQ6IHN0cmluZykgPT4gYW55KSB7XHJcbiAgICBpZiAodGhpcy5pc1RvcCkge1xyXG4gICAgICB0aGlzLm9uKCdhY3RpdmF0ZS1sZWZ0JywgY2IpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5wYXJlbnRJbnN0YW5jZS5vbkxlZnRBY3RpdmF0ZWQoY2IpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgb25Ob3RpZnlTaG93bihjYjogKGxldmVsOiAnZXJyb3InIHwgJ3dhcm5pbmcnIHwgJ2luZm8nLCBjb250ZW50OiBzdHJpbmcgfCBOb3RpZnlPcHRpb25zKSA9PiBhbnkpIHtcclxuICAgIHRoaXMub24oJ3Nob3ctbm90aWZ5JywgY2IpO1xyXG4gIH1cclxuXHJcbiAgb25Mb2FkaW5nU2hvd24oY2I6IChtZXNzYWdlPzogc3RyaW5nKSA9PiBhbnkpIHtcclxuICAgIHRoaXMub24oJ3Nob3ctbG9hZGluZycsIGNiKTtcclxuICB9XHJcblxyXG4gIG9uTG9hZGluZ0hpZGRlbihjYjogKCkgPT4gYW55KSB7XHJcbiAgICB0aGlzLm9uKCdoaWRlLWxvYWRpbmcnLCBjYik7XHJcbiAgfVxyXG5cclxuICBvbkRlc2lnbmVyU3RhdHVzU2V0KGNiOiAoYXJncykgPT4gYW55KSB7XHJcbiAgICB0aGlzLm9uKCdzZXQtZGVzaWduZXItc3RhdHVzJywgY2IpO1xyXG4gIH1cclxuXHJcbiAgLy8gb25CZWZvcmVDbG9zZShpZDogc3RyaW5nLCBjYjogKCkgPT4gYm9vbGVhbikge1xyXG4gIC8vICAgdGhpcy5vbignb24tYmVmb3JlLWNsb3NlJywgKHttZXRhZGF0YUlkfSkgPT4ge1xyXG4gIC8vICAgICBpZiAoaWQgPT09IG1ldGFkYXRhSWQpIHtcclxuICAvLyAgICAgICByZXR1cm4gY2IoKTtcclxuICAvLyAgICAgfVxyXG4gIC8vICAgICByZXR1cm4gdHJ1ZTtcclxuICAvLyAgIH0pO1xyXG4gIC8vIH1cclxuXHJcbiAgb25DbG9zZVRhYihpZDogc3RyaW5nLCBjYjogKCkgPT4gYm9vbGVhbiB8IE9ic2VydmFibGU8Ym9vbGVhbj4pIHtcclxuICAgIGlmICghdGhpcy5pc1RvcCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5wYXJlbnRJbnN0YW5jZS5vbkNsb3NlVGFiKGlkLCBjYik7XHJcbiAgICB9XHJcbiAgICB0aGlzLm9uKCdjbG9zZS10YWInLCB0YWJJZCA9PiB7XHJcbiAgICAgIGlmIChpZCA9PT0gdGFiSWQpIHtcclxuICAgICAgICByZXR1cm4gY2IoKTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH0pO1xyXG4gIH1cclxuICAvKiAjZW5kcmVnaW9uICovXHJcblxyXG5cclxuICAvKiAjcmVnaW9uICBwYW5lbCAqL1xyXG4gIGFkZFBhbmVsKG9wdGlvbnM6IGFueSkge1xyXG4gICAgdGhpcy5lbWl0KCdwYW5lbC1hZGRlZCcsIG9wdGlvbnMpO1xyXG4gIH1cclxuICAvKiAjZW5kcmVnaW9uICovXHJcblxyXG4gIC8qICNyZWdpb24gIG1vZGFsICovXHJcbiAgYWRkTW9kYWwob3B0aW9uczogYW55KSB7XHJcbiAgICB0aGlzLmVtaXQoJ3BhbmVsLWFkZGVkJywgb3B0aW9ucywgJ21vZGFsJyk7XHJcbiAgfVxyXG5cclxuICBjbG9zZU1vZGFsKGlkPzogc3RyaW5nKSB7XHJcbiAgICBpZiAodGhpcy5wYXJlbnRJbnN0YW5jZSAhPT0gdGhpcykge1xyXG4gICAgICB0aGlzLnBhcmVudEluc3RhbmNlLmNsb3NlTW9kYWwoaWQpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5lbWl0KCdwYW5lbC1yZW1vdmVkJywgaWQsICdtb2RhbCcpO1xyXG4gIH1cclxuXHJcbiAgY29uZmlybU1vZGFsKGlkOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIGxldCByZXN1bHQgPSB0cnVlO1xyXG4gICAgLy8gaWYgKHRoaXMucGFyZW50SW5zdGFuY2UgIT09IHRoaXMpIHtcclxuICAgIC8vICAgcmVzdWx0ID0gdGhpcy5wYXJlbnRJbnN0YW5jZS5jb25maXJtTW9kYWwoaWQpO1xyXG4gICAgLy8gfVxyXG4gICAgcmVzdWx0ID0gcmVzdWx0ICYmIHRoaXMuZW1pdCgnY29uZmlybS1tb2RhbCcsIGlkKSBhcyBib29sZWFuO1xyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcblxyXG4gIGNhbmNlbE1vZGFsKGlkOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIGxldCByZXN1bHQgPSB0cnVlO1xyXG4gICAgaWYgKHRoaXMucGFyZW50SW5zdGFuY2UgIT09IHRoaXMpIHtcclxuICAgICAgcmVzdWx0ID0gdGhpcy5wYXJlbnRJbnN0YW5jZS5jYW5jZWxNb2RhbChpZCk7XHJcbiAgICB9XHJcbiAgICByZXN1bHQgPSByZXN1bHQgJiYgdGhpcy5lbWl0KCdjYW5jZWwtbW9kYWwnLCBpZCkgYXMgYm9vbGVhbjtcclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG5cclxuICAvLyBhZGRMZWZ0ICAgIHJlZ2lzdHJ5T3BlbmVyLi4uLlxyXG4gIC8qICNlbmRyZWdpb24gKi9cclxuXHJcbiAgLyogI3JlZ2lvbiAgbGVmdCByaWdpb24gKi9cclxuXHJcbiAgYWN0aXZhdGVMZWZ0KGZyYW1lSWQ/OiBzdHJpbmcpIHtcclxuICAgIGZyYW1lSWQgPSBmcmFtZUlkIHx8IHRoaXMuZnJhbWVJZDtcclxuICAgIGlmICh0aGlzLmlzVG9wKSB7XHJcbiAgICAgIHRoaXMuZW1pdCgnYWN0aXZhdGUtbGVmdCcsIGZyYW1lSWQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5wYXJlbnRJbnN0YW5jZS5hY3RpdmF0ZUxlZnQoZnJhbWVJZCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qICNlbmRyZWdpb24gKi9cclxuXHJcbiAgbm90aWZ5KGxldmVsOiAnZXJyb3InIHwgJ3dhcm5pbmcnIHwgJ2luZm8nLCBjb250ZW50OiBzdHJpbmcgfCBOb3RpZnlPcHRpb25zKSB7XHJcbiAgICBpZiAodGhpcy5pc1RvcCkge1xyXG4gICAgICB0aGlzLmVtaXQoJ3Nob3ctbm90aWZ5JywgbGV2ZWwsIGNvbnRlbnQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5wYXJlbnRJbnN0YW5jZS5ub3RpZnkobGV2ZWwsIGNvbnRlbnQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbG9hZGluZyhtZXNzYWdlPzogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5pc1RvcCkge1xyXG4gICAgICB0aGlzLmVtaXQoJ3Nob3ctbG9hZGluZycsIG1lc3NhZ2UpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5wYXJlbnRJbnN0YW5jZS5sb2FkaW5nKG1lc3NhZ2UpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbG9hZGVkKCk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMuaXNUb3ApIHtcclxuICAgICAgdGhpcy5lbWl0KCdoaWRlLWxvYWRpbmcnKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMucGFyZW50SW5zdGFuY2UubG9hZGVkKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzZXREZXNpZ25lclN0YXR1cyhtZXRhZGF0YUlkOiBzdHJpbmcsIGlzRGlydHk6IGJvb2xlYW4pIHtcclxuICAgIGlmICh0aGlzLmlzVG9wKSB7XHJcbiAgICAgIHRoaXMuZW1pdCgnc2V0LWRlc2lnbmVyLXN0YXR1cycsIHtpZDogbWV0YWRhdGFJZCwgaXNEaXJ0eX0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5wYXJlbnRJbnN0YW5jZS5zZXREZXNpZ25lclN0YXR1cyhtZXRhZGF0YUlkLCBpc0RpcnR5KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIGNsb3NlRGVzaWduZXIobWV0YWRhdGFJZDogc3RyaW5nKSB7XHJcbiAgLy8gICBpZiAodGhpcy5pc1RvcCkge1xyXG4gIC8vICAgICB0aGlzLmVtaXQoJ2Nsb3NlLWRlc2lnbmVyJywge2lkOiBtZXRhZGF0YUlkfSk7XHJcbiAgLy8gICB9IGVsc2Uge1xyXG4gIC8vICAgICB0aGlzLnBhcmVudEluc3RhbmNlLmNsb3NlRGVzaWduZXIobWV0YWRhdGFJZCk7XHJcbiAgLy8gICB9XHJcbiAgLy8gfVxyXG5cclxuICBub3RpZnlDbG9zZVRhYihpZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICBpZiAoIXRoaXMuaXNUb3ApIHtcclxuICAgICAgcmV0dXJuIHRoaXMucGFyZW50SW5zdGFuY2Uubm90aWZ5Q2xvc2VUYWIoaWQpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuZW1pdCgnY2xvc2UtdGFiJywgaWQpO1xyXG4gICAgaWYgKHJlc3VsdCA9PSBudWxsKSB7XHJcbiAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgIH0gZWxzZSBpZiAodHlwZW9mIHJlc3VsdCA9PT0gJ2Jvb2xlYW4nKSB7XHJcbiAgICAgIHJldHVybiBvZiAocmVzdWx0KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZWdpc3RlcklERSh3b3Jrc3BhY2U6IGFueSkge1xyXG4gICAgLy8g55So5p2l5oqKaWRlIHZpZXflrp7kvovkuI5nc3Dlr7nosaHnu5HlrprjgIJcclxuICAgIC8vIFRPRE/vvJogdmlld+WunuS+i+ebkeWQrGdzcOWvueixoeeahOaTjeS9nOaUvuWcqOi/memHjOOAglxyXG5cclxuICAgIGlmICh0eXBlb2Ygd29ya3NwYWNlLm9uQ2xvc2VEZXNpZ25lciA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICB0aGlzLm9uKCdjbG9zZS1kZXNpZ25lcicsIHdvcmtzcGFjZS5vbkNsb3NlRGVzaWduZXIuYmluZCh3b3Jrc3BhY2UpKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qICNyZWdpb24gIHByaXZhdGUgbWV0aG9kICovXHJcbiAgcHJpdmF0ZSBvbihuYW1lOiBzdHJpbmcsIGNiOiBhbnkpIHtcclxuICAgIGxldCBjYWxsYmFja3MgPSB0aGlzLmV2ZW50cy5nZXQobmFtZSk7XHJcbiAgICBpZiAoIWNhbGxiYWNrcykge1xyXG4gICAgICBjYWxsYmFja3MgPSBbY2JdO1xyXG4gICAgICB0aGlzLmV2ZW50cy5zZXQobmFtZSwgY2FsbGJhY2tzKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNhbGxiYWNrcy5wdXNoKGNiKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZW1pdChuYW1lOiBzdHJpbmcsIC4uLnBhcmFtczogYW55W10pOiBib29sZWFuIHwgT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICBjb25zdCBjYWxsYmFja3MgPSB0aGlzLmV2ZW50cy5nZXQobmFtZSk7XHJcblxyXG4gICAgaWYgKCFjYWxsYmFja3MgfHwgIWNhbGxiYWNrcy5sZW5ndGgpIHsgcmV0dXJuOyB9XHJcblxyXG4gICAgbGV0IHJlc3VsdCA9IHRydWU7XHJcbiAgICBjb25zdCBvYnNlcnZhYmxlUmVzdWx0ID0gbmV3IEFycmF5PE9ic2VydmFibGU8Ym9vbGVhbj4+KCk7IC8vIOWQjOaXtuaUr+aMgei/lOWbnmJvb2xlYW7lkoxPYnNlcnZhYmxlXHJcbiAgICBmb3IgKGNvbnN0IGNiIG9mIGNhbGxiYWNrcykge1xyXG4gICAgICBjb25zdCBjYlJlc3VsdCA9IGNiKC4uLnBhcmFtcyk7XHJcbiAgICAgIGlmIChjYlJlc3VsdCA9PSBudWxsKSB7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHR5cGVvZiBjYlJlc3VsdCA9PT0gJ2Jvb2xlYW4nKSB7XHJcbiAgICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGNiUmVzdWx0O1xyXG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiBjYlJlc3VsdC5zdWJzY3JpYmUgPT09ICdmdW5jdGlvbicgJiYgY2JSZXN1bHQuY29uc3RydWN0b3IubmFtZSA9PT0gT2JzZXJ2YWJsZS5uYW1lKSB7XHJcbiAgICAgICAgLy8g5Yik5pat5p2h5Lu25LiN6IO95L2/55SoY2JSZXN1bHQgaW5zdGFuY2VvZiBPYnNlcnZhYmxlLOWboOS4umNi5Y+v6IO95piv5p2l6Ieq5LqO5LiN5ZCM55qEaWZyYW1l546v5aKD77yM5a+86Ie06Lef6L+Z6YeM55qET2JzZXJ2YWJsZeaehOmAoOWHveaVsOS4jeS4gOagt+OAglxyXG4gICAgICAgIG9ic2VydmFibGVSZXN1bHQucHVzaChjYlJlc3VsdCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAob2JzZXJ2YWJsZVJlc3VsdC5sZW5ndGgpIHtcclxuICAgICAgcmV0dXJuIGZvcmtKb2luKFsuLi5vYnNlcnZhYmxlUmVzdWx0LCBvZihyZXN1bHQpXSkucGlwZShtYXAocmVzdWx0cyA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdHMucmVkdWNlKChwcmV2aW91cywgY3VycmVudCkgPT4gcHJldmlvdXMgJiYgY3VycmVudCk7XHJcbiAgICAgIH0pKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcblxyXG4gIH1cclxuICAvKiAjZW5kcmVnaW9uICovXHJcbn1cclxuXHJcbiJdfQ==