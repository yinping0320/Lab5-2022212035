/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, Type } from '@angular/core';
import { EventBusProxy } from './event-bus-proxy';
import { EventPipe } from './event-pipe';
import { DuplexEventPipe } from './duplex-event-pipe';
var EventBus = /** @class */ (function () {
    function EventBus() {
        this.proxyMap = new Map();
        this.eventMap = new Map();
        this.notificationMap = new Map();
    }
    /**
     * @param {?} ownerType
     * @param {?} eventTokenValueProvider
     * @return {?}
     */
    EventBus.prototype.getProxy = /**
     * @param {?} ownerType
     * @param {?} eventTokenValueProvider
     * @return {?}
     */
    function (ownerType, eventTokenValueProvider) {
        /** @type {?} */
        var ownerName = ownerType.constructor.name;
        if (!this.proxyMap.has(ownerName)) {
            this.proxyMap.set(ownerName, new EventBusProxy(this, ownerType, eventTokenValueProvider));
        }
        return this.proxyMap.get(ownerName);
    };
    /**
     * 发送事件，通知订阅者接收消息。
     */
    /**
     * 发送事件，通知订阅者接收消息。
     * @param {?} emitterType
     * @param {?} tokenValue
     * @param {?} eventName
     * @param {?} eventArgs
     * @return {?}
     */
    EventBus.prototype.post = /**
     * 发送事件，通知订阅者接收消息。
     * @param {?} emitterType
     * @param {?} tokenValue
     * @param {?} eventName
     * @param {?} eventArgs
     * @return {?}
     */
    function (emitterType, tokenValue, eventName, eventArgs) {
        var e_1, _a;
        /** @type {?} */
        var eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            return;
        }
        if (!emitterType) {
            console.error('post方法的参数emitterType不能为空。');
            return;
        }
        /** @type {?} */
        var emitter;
        if (emitterType instanceof Type) {
            emitter = emitterType.name;
        }
        else {
            emitter = emitterType;
        }
        try {
            for (var eventPipeList_1 = tslib_1.__values(eventPipeList), eventPipeList_1_1 = eventPipeList_1.next(); !eventPipeList_1_1.done; eventPipeList_1_1 = eventPipeList_1.next()) {
                var eventPipe = eventPipeList_1_1.value;
                if (eventPipe.matchEmitterToken(emitter, tokenValue)) {
                    eventPipe.post(eventArgs);
                    eventPipe.unSubscribeForOnce();
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (eventPipeList_1_1 && !eventPipeList_1_1.done && (_a = eventPipeList_1.return)) _a.call(eventPipeList_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
    };
    /**
     * 订阅事件
     */
    /**
     * 订阅事件
     * @param {?} target
     * @param {?} tokenValue
     * @param {?} eventName
     * @param {?} caller
     * @param {?} handler
     * @return {?}
     */
    EventBus.prototype.on = /**
     * 订阅事件
     * @param {?} target
     * @param {?} tokenValue
     * @param {?} eventName
     * @param {?} caller
     * @param {?} handler
     * @return {?}
     */
    function (target, tokenValue, eventName, caller, handler) {
        return this.getEventPipe(eventName, target, tokenValue).subscribe(handler, caller);
    };
    /**
     * 订阅一次。接收到一次消息之后自动取消订阅
     */
    /**
     * 订阅一次。接收到一次消息之后自动取消订阅
     * @param {?} target
     * @param {?} tokenValue
     * @param {?} eventName
     * @param {?} caller
     * @param {?} handler
     * @return {?}
     */
    EventBus.prototype.once = /**
     * 订阅一次。接收到一次消息之后自动取消订阅
     * @param {?} target
     * @param {?} tokenValue
     * @param {?} eventName
     * @param {?} caller
     * @param {?} handler
     * @return {?}
     */
    function (target, tokenValue, eventName, caller, handler) {
        return this.getEventPipe(eventName, target, tokenValue).subscribeOnce(handler, caller);
    };
    /**
     * 发送一个请求事件，获取监听者的响应并处理
     */
    /**
     * 发送一个请求事件，获取监听者的响应并处理
     * @param {?} target
     * @param {?} tokenValue
     * @param {?} requestName
     * @param {?} requestValue
     * @param {?} success
     * @param {?=} fail
     * @return {?}
     */
    EventBus.prototype.requestFor = /**
     * 发送一个请求事件，获取监听者的响应并处理
     * @param {?} target
     * @param {?} tokenValue
     * @param {?} requestName
     * @param {?} requestValue
     * @param {?} success
     * @param {?=} fail
     * @return {?}
     */
    function (target, tokenValue, requestName, requestValue, success, fail) {
        /** @type {?} */
        var eventPipe = this.findExistEventPipe(requestName, 'RequestSubject', tokenValue);
        if (eventPipe) {
            this.once(target, tokenValue, requestName, this, function (response) {
                if (response.status === 'success') {
                    success(response.data);
                }
                else {
                    if (fail) {
                        fail('No target responser listening');
                    }
                }
            });
            eventPipe.post({ target: target, token: tokenValue, data: requestValue });
        }
        else {
            if (fail) {
                fail('No target responser listening.');
            }
        }
    };
    /**
     * 监听一个请求事件，给出响应
     */
    /**
     * 监听一个请求事件，给出响应
     * @param {?} responseSubject
     * @param {?} requestName
     * @param {?} callback
     * @return {?}
     */
    EventBus.prototype.responseOn = /**
     * 监听一个请求事件，给出响应
     * @param {?} responseSubject
     * @param {?} requestName
     * @param {?} callback
     * @return {?}
     */
    function (responseSubject, requestName, callback) {
        var _this = this;
        this.on('RequestSubject', null, requestName, this, function (requestObj) {
            /** @type {?} */
            var response = { status: 'fail', data: null };
            if (responseSubject === requestObj.target) {
                response.data = callback(requestObj.data);
                response.status = 'success';
            }
            _this.post(requestObj.target, requestObj.token, requestName, response);
        });
    };
    /**
     * @param {?} eventName
     * @param {?} eventArgs
     * @return {?}
     */
    EventBus.prototype.notify = /**
     * @param {?} eventName
     * @param {?} eventArgs
     * @return {?}
     */
    function (eventName, eventArgs) {
        /** @type {?} */
        var notification = this.notificationMap.get(eventName);
        if (!notification) {
            notification = new DuplexEventPipe(eventName);
            this.notificationMap.set(eventName, notification);
        }
        return notification.notify(eventArgs);
    };
    /**
     * @param {?} eventName
     * @param {?} handler
     * @param {?=} caller
     * @return {?}
     */
    EventBus.prototype.listen = /**
     * @param {?} eventName
     * @param {?} handler
     * @param {?=} caller
     * @return {?}
     */
    function (eventName, handler, caller) {
        /** @type {?} */
        var notification = this.notificationMap.get(eventName);
        if (!notification) {
            notification = new DuplexEventPipe(eventName);
            this.notificationMap.set(eventName, notification);
        }
        return notification.listen(handler, caller);
    };
    /**
     * @private
     * @param {?} eventName
     * @param {?} target
     * @param {?} tokenValue
     * @return {?}
     */
    EventBus.prototype.getEventPipe = /**
     * @private
     * @param {?} eventName
     * @param {?} target
     * @param {?} tokenValue
     * @return {?}
     */
    function (eventName, target, tokenValue) {
        /** @type {?} */
        var eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            eventPipeList = new Array();
            this.eventMap.set(eventName, eventPipeList);
        }
        /** @type {?} */
        var eventPipe = eventPipeList.find(function (item) { return item.examByTargetToken(target, tokenValue); });
        if (!eventPipe) {
            eventPipe = new EventPipe(eventName, tokenValue, target, eventPipeList);
        }
        return eventPipe;
    };
    /**
     * @private
     * @param {?} eventName
     * @param {?} target
     * @param {?} tokenValue
     * @return {?}
     */
    EventBus.prototype.findExistEventPipe = /**
     * @private
     * @param {?} eventName
     * @param {?} target
     * @param {?} tokenValue
     * @return {?}
     */
    function (eventName, target, tokenValue) {
        var e_2, _a;
        /** @type {?} */
        var eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            return null;
        }
        try {
            // return eventPipeList.find(item => item.examByTargetToken(target, tokenValue));
            for (var eventPipeList_2 = tslib_1.__values(eventPipeList), eventPipeList_2_1 = eventPipeList_2.next(); !eventPipeList_2_1.done; eventPipeList_2_1 = eventPipeList_2.next()) {
                var eventPipe = eventPipeList_2_1.value;
                if (eventPipe.matchEmitterToken(target, tokenValue)) {
                    return eventPipe;
                }
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (eventPipeList_2_1 && !eventPipeList_2_1.done && (_a = eventPipeList_2.return)) _a.call(eventPipeList_2);
            }
            finally { if (e_2) throw e_2.error; }
        }
        return null;
    };
    EventBus.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    EventBus.ctorParameters = function () { return []; };
    return EventBus;
}());
export { EventBus };
if (false) {
    /**
     * @type {?}
     * @private
     */
    EventBus.prototype.proxyMap;
    /**
     * @type {?}
     * @private
     */
    EventBus.prototype.eventMap;
    /**
     * @type {?}
     * @private
     */
    EventBus.prototype.notificationMap;
}
var RequestSubject = /** @class */ (function () {
    function RequestSubject() {
    }
    return RequestSubject;
}());
var DataClass = /** @class */ (function () {
    function DataClass() {
    }
    return DataClass;
}());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQtYnVzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9pZGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2lkZWZyYW1ld29yay9ldmVudGJ1cy9ldmVudC1idXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFFLElBQUksRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUMvQyxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sbUJBQW1CLENBQUM7QUFFaEQsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLGNBQWMsQ0FBQztBQUV2QyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFdEQ7SUFNRTtRQUNFLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQXlCLENBQUM7UUFDakQsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLEdBQUcsRUFBNEIsQ0FBQztRQUNwRCxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksR0FBRyxFQUEyQixDQUFDO0lBQzVELENBQUM7Ozs7OztJQUVELDJCQUFROzs7OztJQUFSLFVBQVMsU0FBb0IsRUFBRSx1QkFBa0M7O1lBQ3pELFNBQVMsR0FBRyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUk7UUFDNUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFO1lBQ2pDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxJQUFJLGFBQWEsQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFLHVCQUF1QixDQUFDLENBQUMsQ0FBQztTQUMzRjtRQUNELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUVEOztPQUVHOzs7Ozs7Ozs7SUFDSCx1QkFBSTs7Ozs7Ozs7SUFBSixVQUFLLFdBQStCLEVBQUUsVUFBa0IsRUFBRSxTQUFpQixFQUFF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QUFDO0lBQ2QsQ0FBQzs7Z0JBOUlGLFVBQVU7Ozs7SUErSVgsZUFBQztDQUFBLEFBL0lELElBK0lDO1NBOUlZLFFBQVE7Ozs7OztJQUNuQiw0QkFBNkM7Ozs7O0lBQzdDLDRCQUFnRDs7Ozs7SUFDaEQsbUNBQXNEOztBQTZJeEQ7SUFBQTtJQUFzQixDQUFDO0lBQUQscUJBQUM7QUFBRCxDQUFDLEFBQXZCLElBQXVCO0FBQ3ZCO0lBQUE7SUFBaUIsQ0FBQztJQUFELGdCQUFDO0FBQUQsQ0FBQyxBQUFsQixJQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZSwgVHlwZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7RXZlbnRCdXNQcm94eX0gZnJvbSAnLi9ldmVudC1idXMtcHJveHknO1xyXG5pbXBvcnQgeyBJRGlzcG9zYWJsZSwgSUVtaXRhYmxlLCBJVGhlbmFibGUgfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHtFdmVudFBpcGV9IGZyb20gJy4vZXZlbnQtcGlwZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgRHVwbGV4RXZlbnRQaXBlIH0gZnJvbSAnLi9kdXBsZXgtZXZlbnQtcGlwZSc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBFdmVudEJ1cyBpbXBsZW1lbnRzIElFbWl0YWJsZSB7XHJcbiAgcHJpdmF0ZSBwcm94eU1hcDogTWFwPHN0cmluZywgRXZlbnRCdXNQcm94eT47XHJcbiAgcHJpdmF0ZSBldmVudE1hcDogTWFwPHN0cmluZywgQXJyYXk8RXZlbnRQaXBlPj47XHJcbiAgcHJpdmF0ZSBub3RpZmljYXRpb25NYXA6IE1hcDxzdHJpbmcsIER1cGxleEV2ZW50UGlwZT47XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy5wcm94eU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBFdmVudEJ1c1Byb3h5PigpO1xyXG4gICAgdGhpcy5ldmVudE1hcCA9IG5ldyBNYXA8c3RyaW5nLCBBcnJheTxFdmVudFBpcGU+PigpO1xyXG4gICAgdGhpcy5ub3RpZmljYXRpb25NYXAgPSBuZXcgTWFwPHN0cmluZywgRHVwbGV4RXZlbnRQaXBlPigpO1xyXG4gIH1cclxuXHJcbiAgZ2V0UHJveHkob3duZXJUeXBlOiBUeXBlPGFueT4sIGV2ZW50VG9rZW5WYWx1ZVByb3ZpZGVyOiAoKSA9PiBhbnkpOiBFdmVudEJ1c1Byb3h5IHtcclxuICAgIGNvbnN0IG93bmVyTmFtZSA9IG93bmVyVHlwZS5jb25zdHJ1Y3Rvci5uYW1lO1xyXG4gICAgaWYgKCF0aGlzLnByb3h5TWFwLmhhcyhvd25lck5hbWUpKSB7XHJcbiAgICAgIHRoaXMucHJveHlNYXAuc2V0KG93bmVyTmFtZSwgbmV3IEV2ZW50QnVzUHJveHkodGhpcywgb3duZXJUeXBlLCBldmVudFRva2VuVmFsdWVQcm92aWRlcikpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMucHJveHlNYXAuZ2V0KG93bmVyTmFtZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlj5HpgIHkuovku7bvvIzpgJrnn6XorqLpmIXogIXmjqXmlLbmtojmga/jgIJcclxuICAgKi9cclxuICBwb3N0KGVtaXR0ZXJUeXBlOiBUeXBlPGFueT4gfCBzdHJpbmcsIHRva2VuVmFsdWU6IHN0cmluZywgZXZlbnROYW1lOiBzdHJpbmcsIGV2ZW50QXJnczogYW55KTogdm9pZCB7XHJcbiAgICBjb25zdCBldmVudFBpcGVMaXN0ID0gdGhpcy5ldmVudE1hcC5nZXQoZXZlbnROYW1lKTtcclxuICAgIGlmICghZXZlbnRQaXBlTGlzdCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFlbWl0dGVyVHlwZSkge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdwb3N05pa55rOV55qE5Y+C5pWwZW1pdHRlclR5cGXkuI3og73kuLrnqbrjgIInKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgbGV0IGVtaXR0ZXI6IHN0cmluZztcclxuICAgIGlmIChlbWl0dGVyVHlwZSBpbnN0YW5jZW9mIFR5cGUpIHtcclxuICAgICAgZW1pdHRlciA9IGVtaXR0ZXJUeXBlLm5hbWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBlbWl0dGVyID0gZW1pdHRlclR5cGU7XHJcbiAgICB9XHJcblxyXG4gICAgZm9yIChjb25zdCBldmVudFBpcGUgb2YgZXZlbnRQaXBlTGlzdCkge1xyXG4gICAgICBpZiAoZXZlbnRQaXBlLm1hdGNoRW1pdHRlclRva2VuKGVtaXR0ZXIsIHRva2VuVmFsdWUpKSB7XHJcbiAgICAgICAgZXZlbnRQaXBlLnBvc3QoZXZlbnRBcmdzKTtcclxuICAgICAgICBldmVudFBpcGUudW5TdWJzY3JpYmVGb3JPbmNlKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuoumYheS6i+S7tlxyXG4gICAqL1xyXG4gIG9uKHRhcmdldDogc3RyaW5nLCB0b2tlblZhbHVlOiBzdHJpbmcsIGV2ZW50TmFtZTogc3RyaW5nLCBjYWxsZXI6IG9iamVjdCwgaGFuZGxlcjogKHZhbHVlOiBhbnkpID0+IHZvaWQpOiBJRGlzcG9zYWJsZSB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRFdmVudFBpcGUoZXZlbnROYW1lLCB0YXJnZXQsIHRva2VuVmFsdWUpLnN1YnNjcmliZShoYW5kbGVyLCBjYWxsZXIpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6i6ZiF5LiA5qyh44CC5o6l5pS25Yiw5LiA5qyh5raI5oGv5LmL5ZCO6Ieq5Yqo5Y+W5raI6K6i6ZiFXHJcbiAgICovXHJcbiAgb25jZSh0YXJnZXQ6IHN0cmluZywgdG9rZW5WYWx1ZTogc3RyaW5nLCBldmVudE5hbWU6IHN0cmluZywgY2FsbGVyOiBvYmplY3QsIGhhbmRsZXI6ICh2YWx1ZTogYW55KSA9PiB2b2lkKTogSURpc3Bvc2FibGUge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0RXZlbnRQaXBlKGV2ZW50TmFtZSwgdGFyZ2V0LCB0b2tlblZhbHVlKS5zdWJzY3JpYmVPbmNlKGhhbmRsZXIsIGNhbGxlcik7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlj5HpgIHkuIDkuKror7fmsYLkuovku7bvvIzojrflj5bnm5HlkKzogIXnmoTlk43lupTlubblpITnkIZcclxuICAgKi9cclxuICByZXF1ZXN0Rm9yKHRhcmdldDogc3RyaW5nLCB0b2tlblZhbHVlOiBzdHJpbmcsIHJlcXVlc3ROYW1lOiBzdHJpbmcsIHJlcXVlc3RWYWx1ZTogYW55LCBzdWNjZXNzOiAoYW55KSA9PiBhbnksIGZhaWw/OiAoc3RyaW5nKSA9PiBhbnkpIHtcclxuICAgIGNvbnN0IGV2ZW50UGlwZSA9IHRoaXMuZmluZEV4aXN0RXZlbnRQaXBlKHJlcXVlc3ROYW1lLCAnUmVxdWVzdFN1YmplY3QnLCB0b2tlblZhbHVlKTtcclxuICAgIGlmIChldmVudFBpcGUpIHtcclxuICAgICAgdGhpcy5vbmNlKHRhcmdldCwgdG9rZW5WYWx1ZSwgcmVxdWVzdE5hbWUsIHRoaXMsIChyZXNwb25zZSkgPT4ge1xyXG4gICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09ICdzdWNjZXNzJykge1xyXG4gICAgICAgICAgc3VjY2VzcyhyZXNwb25zZS5kYXRhKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgaWYgKGZhaWwpIHtcclxuICAgICAgICAgICAgZmFpbCgnTm8gdGFyZ2V0IHJlc3BvbnNlciBsaXN0ZW5pbmcnKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICBldmVudFBpcGUucG9zdCh7dGFyZ2V0LCB0b2tlbjogdG9rZW5WYWx1ZSwgZGF0YTogcmVxdWVzdFZhbHVlfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAoZmFpbCkge1xyXG4gICAgICAgIGZhaWwoJ05vIHRhcmdldCByZXNwb25zZXIgbGlzdGVuaW5nLicpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDnm5HlkKzkuIDkuKror7fmsYLkuovku7bvvIznu5nlh7rlk43lupRcclxuICAgKi9cclxuICByZXNwb25zZU9uKHJlc3BvbnNlU3ViamVjdDogc3RyaW5nLCByZXF1ZXN0TmFtZTogc3RyaW5nLCBjYWxsYmFjazogKGFueSkgPT4gYW55KSB7XHJcbiAgICB0aGlzLm9uKCdSZXF1ZXN0U3ViamVjdCcsIG51bGwsIHJlcXVlc3ROYW1lLCB0aGlzLCAocmVxdWVzdE9iaikgPT4ge1xyXG4gICAgICBjb25zdCByZXNwb25zZSA9IHtzdGF0dXM6ICdmYWlsJywgZGF0YTogbnVsbH07XHJcbiAgICAgIGlmIChyZXNwb25zZVN1YmplY3QgPT09IHJlcXVlc3RPYmoudGFyZ2V0KSB7XHJcbiAgICAgICAgcmVzcG9uc2UuZGF0YSA9IGNhbGxiYWNrKHJlcXVlc3RPYmouZGF0YSk7XHJcbiAgICAgICAgcmVzcG9uc2Uuc3RhdHVzID0gJ3N1Y2Nlc3MnO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMucG9zdChyZXF1ZXN0T2JqLnRhcmdldCwgcmVxdWVzdE9iai50b2tlbiwgcmVxdWVzdE5hbWUsIHJlc3BvbnNlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgbm90aWZ5KGV2ZW50TmFtZTogc3RyaW5nLCBldmVudEFyZ3M6IGFueSk6IElUaGVuYWJsZSB7XHJcbiAgICBsZXQgbm90aWZpY2F0aW9uID0gdGhpcy5ub3RpZmljYXRpb25NYXAuZ2V0KGV2ZW50TmFtZSk7XHJcbiAgICBpZiAoIW5vdGlmaWNhdGlvbikge1xyXG4gICAgICBub3RpZmljYXRpb24gPSBuZXcgRHVwbGV4RXZlbnRQaXBlKGV2ZW50TmFtZSk7XHJcbiAgICAgIHRoaXMubm90aWZpY2F0aW9uTWFwLnNldChldmVudE5hbWUsIG5vdGlmaWNhdGlvbik7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbm90aWZpY2F0aW9uLm5vdGlmeShldmVudEFyZ3MpO1xyXG4gIH1cclxuXHJcbiAgbGlzdGVuKGV2ZW50TmFtZTogc3RyaW5nLCBoYW5kbGVyOiAodmFsdWU6IGFueSkgPT4gT2JzZXJ2YWJsZTxib29sZWFuPiB8IGJvb2xlYW4gfCB2b2lkLCBjYWxsZXI/OiBvYmplY3QpOiB2b2lkIHtcclxuICAgIGxldCBub3RpZmljYXRpb24gPSB0aGlzLm5vdGlmaWNhdGlvbk1hcC5nZXQoZXZlbnROYW1lKTtcclxuICAgIGlmICghbm90aWZpY2F0aW9uKSB7XHJcbiAgICAgIG5vdGlmaWNhdGlvbiA9IG5ldyBEdXBsZXhFdmVudFBpcGUoZXZlbnROYW1lKTtcclxuICAgICAgdGhpcy5ub3RpZmljYXRpb25NYXAuc2V0KGV2ZW50TmFtZSwgbm90aWZpY2F0aW9uKTtcclxuICAgIH1cclxuICAgIHJldHVybiBub3RpZmljYXRpb24ubGlzdGVuKGhhbmRsZXIsIGNhbGxlcik7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEV2ZW50UGlwZShldmVudE5hbWU6IHN0cmluZywgdGFyZ2V0OiBzdHJpbmcsIHRva2VuVmFsdWU6IHN0cmluZykge1xyXG4gICAgbGV0IGV2ZW50UGlwZUxpc3QgPSB0aGlzLmV2ZW50TWFwLmdldChldmVudE5hbWUpO1xyXG4gICAgaWYgKCFldmVudFBpcGVMaXN0KSB7XHJcbiAgICAgIGV2ZW50UGlwZUxpc3QgPSBuZXcgQXJyYXk8RXZlbnRQaXBlPigpO1xyXG4gICAgICB0aGlzLmV2ZW50TWFwLnNldChldmVudE5hbWUsIGV2ZW50UGlwZUxpc3QpO1xyXG4gICAgfVxyXG4gICAgbGV0IGV2ZW50UGlwZSA9IGV2ZW50UGlwZUxpc3QuZmluZChpdGVtID0+IGl0ZW0uZXhhbUJ5VGFyZ2V0VG9rZW4odGFyZ2V0LCB0b2tlblZhbHVlKSk7XHJcbiAgICBpZiAoIWV2ZW50UGlwZSkge1xyXG4gICAgICBldmVudFBpcGUgPSBuZXcgRXZlbnRQaXBlKGV2ZW50TmFtZSwgdG9rZW5WYWx1ZSwgdGFyZ2V0LCBldmVudFBpcGVMaXN0KTtcclxuICAgIH1cclxuICAgIHJldHVybiBldmVudFBpcGU7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGZpbmRFeGlzdEV2ZW50UGlwZShldmVudE5hbWU6IHN0cmluZywgdGFyZ2V0OiBzdHJpbmcsIHRva2VuVmFsdWU6IHN0cmluZyk6IEV2ZW50UGlwZSB7XHJcbiAgICBjb25zdCBldmVudFBpcGVMaXN0ID0gdGhpcy5ldmVudE1hcC5nZXQoZXZlbnROYW1lKTtcclxuICAgIGlmICghZXZlbnRQaXBlTGlzdCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIC8vIHJldHVybiBldmVudFBpcGVMaXN0LmZpbmQoaXRlbSA9PiBpdGVtLmV4YW1CeVRhcmdldFRva2VuKHRhcmdldCwgdG9rZW5WYWx1ZSkpO1xyXG4gICAgZm9yIChjb25zdCBldmVudFBpcGUgb2YgZXZlbnRQaXBlTGlzdCkge1xyXG4gICAgICBpZiAoZXZlbnRQaXBlLm1hdGNoRW1pdHRlclRva2VuKHRhcmdldCwgdG9rZW5WYWx1ZSkpIHtcclxuICAgICAgICByZXR1cm4gZXZlbnRQaXBlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcbn1cclxuXHJcbmNsYXNzIFJlcXVlc3RTdWJqZWN0IHt9XHJcbmNsYXNzIERhdGFDbGFzcyB7fVxyXG4iXX0=