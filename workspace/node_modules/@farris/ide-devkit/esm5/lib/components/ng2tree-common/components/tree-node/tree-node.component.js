/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ViewChild, Input, ComponentFactoryResolver, ViewContainerRef } from '@angular/core';
import { TreeNode } from '../../models/tree-node';
import { TreeNodeContentDirective } from '../../directives/tree-node-content.directive';
import { TreeNodeContentItem } from '../../models/tree-node-content-item';
import { TreeNodeContentComponent } from '../tree-node-content/tree-node-content.component';
var TreeNodeComponent = /** @class */ (function () {
    function TreeNodeComponent(componentFactoryResolver, viewContainerRef) {
        this.componentFactoryResolver = componentFactoryResolver;
    }
    // TODO: move to draggable directive
    // TODO: move to draggable directive
    /**
     * @param {?} $event
     * @return {?}
     */
    TreeNodeComponent.prototype.onDragStart = 
    // TODO: move to draggable directive
    /**
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        var _this = this;
        // 设置DragNode: 选择dragNode的父节点作为DragNode，通过index定位到指定的节点
        setTimeout(function () { return _this.node.treeModel.setDragNode({ parentNode: _this.node.parent, index: _this.nodeIndex }); }, 30);
    };
    /**
     * @return {?}
     */
    TreeNodeComponent.prototype.onDragEnd = /**
     * @return {?}
     */
    function () {
        this.node.treeModel.setDragNode(null);
    };
    /**
     * @param {?} $event
     * @return {?}
     */
    TreeNodeComponent.prototype.onDragOver = /**
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        $event.preventDefault();
        this.node.treeModel.setDropLocation({ component: this, parentNode: this.node, index: 0 });
    };
    /**
     * @param {?} $event
     * @return {?}
     */
    TreeNodeComponent.prototype.onDrop = /**
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        $event.preventDefault();
        // this.node.mouseAction('drop', $event, { node: this.node, index: 0 });
        this.node.treeModel.setFocus(true);
        this.node.dropMouseAction($event, { parentNode: this.node, index: 0 });
        console.log("onDrop: tree-node-component");
    };
    /**
     * @param {?} nodeContentWrapper
     * @param {?} $event
     * @return {?}
     */
    TreeNodeComponent.prototype.onDragLeave = /**
     * @param {?} nodeContentWrapper
     * @param {?} $event
     * @return {?}
     */
    function (nodeContentWrapper, $event) {
        if (!this.node.treeModel.isDraggingOver(this)) {
            return;
        }
        /** @type {?} */
        var rect = nodeContentWrapper.getBoundingClientRect();
        // If outside the element
        if ($event.clientX < rect.left || $event.clientX > rect.right ||
            $event.clientY < rect.top || $event.clientY > rect.bottom) {
            this.node.treeModel.setDropLocation(null);
        }
    };
    /**
     * @return {?}
     */
    TreeNodeComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this._loadTreeNodeContent();
        // 触发变更树节点展示文本
        this.node.changeDisplayField.subscribe(function (name) {
            if (_this.componentRef) {
                _this.componentRef.instance.displayData = name;
            }
        });
    };
    /**
     * @return {?}
     */
    TreeNodeComponent.prototype.ngOnChanges = /**
     * @return {?}
     */
    function () {
    };
    // 解决使用动态组件出现ExpressionChangedAfterItHasBeenCheckedError问题：
    // https://github.com/angular/angular/issues/17572
    // 解决使用动态组件出现ExpressionChangedAfterItHasBeenCheckedError问题：
    // https://github.com/angular/angular/issues/17572
    /**
     * @return {?}
     */
    TreeNodeComponent.prototype._loadTreeNodeContent = 
    // 解决使用动态组件出现ExpressionChangedAfterItHasBeenCheckedError问题：
    // https://github.com/angular/angular/issues/17572
    /**
     * @return {?}
     */
    function () {
        var _this = this;
        // 使用Item从逻辑上将TreeNodeContentComponent和data关联起来
        /** @type {?} */
        var treeNodeContentItem = new TreeNodeContentItem(TreeNodeContentComponent, this.node.displayField);
        // 使用 ComponentFactoryResolver 来为每个具体的组件解析出一个 ComponentFactory 
        // 然后 ComponentFactory 会为每一个组件创建一个实例
        /** @type {?} */
        var componentFactory = this.componentFactoryResolver.resolveComponentFactory(treeNodeContentItem.component);
        /** @type {?} */
        var viewContainerRef = this.treeNodeContentHost.viewContainerRef;
        viewContainerRef.clear();
        this.componentRef = viewContainerRef.createComponent(componentFactory);
        this.componentRef.instance.displayData = treeNodeContentItem.displayData; // 传入数据
        this.componentRef.instance.originData = this.node.data;
        this.componentRef.instance.rightMenuClicked.subscribe(function (event) {
            _this.node.rightMenuClicked(event);
        });
    };
    TreeNodeComponent.decorators = [
        { type: Component, args: [{
                    selector: 'ng2tree-node',
                    template: "<div class=\"tree-node tree-node-level-{{ node.level }}\"\r\n[class.tree-node-expanded]=\"node.isExpanded && node.hasChildren\"\r\n[class.tree-node-collapsed]=\"node.isCollapsed && node.hasChildren\"\r\n[class.tree-node-leaf]=\"node.isLeaf\"\r\n[class.tree-node-active]=\"node.isActive\"\r\n[class.tree-node-focused]=\"node.isFocused\">\r\n\r\n<ng2tree-node-drop-slot\r\n  *ngIf=\"nodeIndex === 0\"\r\n  [dropIndex]=\"nodeIndex\"\r\n  [node]=\"node.parent\"\r\n></ng2tree-node-drop-slot>\r\n\r\n<span\r\n  *ngIf=\"node.hasChildren\"\r\n  class=\"toggle-children\"\r\n  (click)=\"node.toggleActivated()\"\r\n  (click)=\"node.toggle()\"\r\n  >\r\n</span>\r\n<span\r\n  *ngIf=\"!node.hasChildren\"\r\n  class=\"toggle-children-placeholder\">\r\n</span>\r\n\r\n<!-- \u8BBE\u7F6Eclick\u4E8B\u4EF6\u7684\u5904\u7406\u5668 -->\r\n<!-- [draggable]=\"node.allowDrag()\"\r\n(dragstart)=\"onDragStart($event)\"\r\n(drop)=\"onDrop($event)\"\r\n(dragend)=\"onDragEnd()\"\r\n(dragover)=\"onDragOver($event)\"\r\n(dragleave)=\"onDragLeave(nodeContentWrapper, $event)\" -->\r\n<div class=\"node-content-wrapper\"\r\n  #nodeContentWrapper\r\n  (click)=\"node.toggleActivated()\"\r\n  (dblclick)=\"node.doublClick($event)\"\r\n  (contextmenu)=\"node.contextMenu($event)\"\r\n\r\n  >\r\n  <!-- \u8BBE\u7F6E\u52A8\u6001\u7EC4\u4EF6\u7684\u951A\u70B9 -->\r\n  <ng-template treeNodeContent-host></ng-template> \r\n</div>\r\n\r\n<div class=\"tree-children\" [hidden]=\"node.isCollapsed\">\r\n  <ng2tree-node\r\n    *ngFor=\"let child of node.childrenField; let i = index\"\r\n    [node]=\"child\"\r\n    [nodeIndex]=\"i\">\r\n  </ng2tree-node>\r\n</div>\r\n\r\n<ng2tree-node-drop-slot\r\n  [dropIndex]=\"nodeIndex + 1\"\r\n  [node]=\"node.parent\"\r\n></ng2tree-node-drop-slot>\r\n\r\n</div>",
                    styles: [".tree-children{padding-left:20px}.node-content-wrapper{display:inline-block;padding:2px 5px;border-radius:2px;transition:background-color .15s,box-shadow .15s;white-space:nowrap}.tree-node-active>.node-content-wrapper{background:#beebff}.tree-node-active.tree-node-focused>.node-content-wrapper{background:#5db0e7}.tree-node-focused>.node-content-wrapper{background:#e7f4f9}.node-content-wrapper:hover{background:#f7fbff}.node-content-wrapper:hover,.tree-node-active>.node-content-wrapper,.tree-node-focused>.node-content-wrapper{box-shadow:inset 0 0 1px #999}.tree-node-expanded .toggle-children{background-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='%23646465' d='M11 10H5.344L11 4.414V10z'/%3E%3C/svg%3E\")}.tree-node-collapsed .toggle-children{background-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='%23646465' d='M6 4v8l4-4-4-4zm1 2.414L8.586 8 7 9.586V6.414z'/%3E%3C/svg%3E\")}.toggle-children{height:16px;width:16px;background-size:16px;display:inline-block;position:relative;background-repeat:no-repeat;background-position:center;right:-6px;top:4px;overflow:hidden}.toggle-children-placeholder{display:inline-block;height:10px;width:10px;position:relative;top:1px}.tree-node-icon{width:1rem}.tree-node{white-space:nowrap}"]
                }] }
    ];
    /** @nocollapse */
    TreeNodeComponent.ctorParameters = function () { return [
        { type: ComponentFactoryResolver },
        { type: ViewContainerRef }
    ]; };
    TreeNodeComponent.propDecorators = {
        node: [{ type: Input }],
        nodeIndex: [{ type: Input }],
        treeNodeContentHost: [{ type: ViewChild, args: [TreeNodeContentDirective,] }]
    };
    return TreeNodeComponent;
}());
export { TreeNodeComponent };
if (false) {
    /** @type {?} */
    TreeNodeComponent.prototype.node;
    /** @type {?} */
    TreeNodeComponent.prototype.nodeIndex;
    /** @type {?} */
    TreeNodeComponent.prototype.componentRef;
    /** @type {?} */
    TreeNodeComponent.prototype.treeNodeContentHost;
    /**
     * @type {?}
     * @private
     */
    TreeNodeComponent.prototype.componentFactoryResolver;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZS1ub2RlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvaWRlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL25nMnRyZWUtY29tbW9uL2NvbXBvbmVudHMvdHJlZS1ub2RlL3RyZWUtbm9kZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFVLEtBQUssRUFBRSx3QkFBd0IsRUFBRSxnQkFBZ0IsRUFBZ0IsTUFBTSxlQUFlLENBQUM7QUFDOUgsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ2xELE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDhDQUE4QyxDQUFDO0FBQ3hGLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQzFFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLGtEQUFrRCxDQUFDO0FBRTVGO0lBc0RFLDJCQUFvQix3QkFBa0QsRUFDcEUsZ0JBQWtDO1FBRGhCLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7SUFHdEUsQ0FBQztJQTVDRCxvQ0FBb0M7Ozs7OztJQUNwQyx1Q0FBVzs7Ozs7O0lBQVgsVUFBWSxNQUFNO1FBQWxCLGlCQUdDO1FBRkMsdURBQXVEO1FBQ3ZELFVBQVUsQ0FBQyxjQUFNLE9BQUEsS0FBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLEVBQUUsVUFBVSxFQUFFLEtBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFJLENBQUMsU0FBUyxFQUFFLENBQUMsRUFBeEYsQ0FBd0YsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNqSCxDQUFDOzs7O0lBRUQscUNBQVM7OztJQUFUO1FBQ0UsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3hDLENBQUM7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QyxTQUFTLENBQUMsVUFBQSxLQUFLO1lBQ3pELEtBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDcEMsQ0FBQyxDQUFDLENBQUM7SUFFTCxDQUFDOztnQkFqR0YsU0FBUyxTQUFDO29CQUNULFFBQVEsRUFBRSxjQUFjO29CQUN4QixvdkRBQXlDOztpQkFFMUM7Ozs7Z0JBVjZDLHdCQUF3QjtnQkFBRSxnQkFBZ0I7Ozt1QkFhckYsS0FBSzs0QkFDTCxLQUFLO3NDQTRDTCxTQUFTLFNBQUMsd0JBQXdCOztJQStDckMsd0JBQUM7Q0FBQSxBQW5HRCxJQW1HQztTQTlGWSxpQkFBaUI7OztJQUU1QixpQ0FBd0I7O0lBQ3hCLHNDQUEyQjs7SUFHM0IseUNBQXFEOztJQXlDckQsZ0RBQW1GOzs7OztJQUV2RSxxREFBMEQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIFZpZXdDaGlsZCwgT25Jbml0LCBJbnB1dCwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBWaWV3Q29udGFpbmVyUmVmLCBDb21wb25lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgVHJlZU5vZGUgfSBmcm9tICcuLi8uLi9tb2RlbHMvdHJlZS1ub2RlJztcclxuaW1wb3J0IHsgVHJlZU5vZGVDb250ZW50RGlyZWN0aXZlIH0gZnJvbSAnLi4vLi4vZGlyZWN0aXZlcy90cmVlLW5vZGUtY29udGVudC5kaXJlY3RpdmUnO1xyXG5pbXBvcnQgeyBUcmVlTm9kZUNvbnRlbnRJdGVtIH0gZnJvbSAnLi4vLi4vbW9kZWxzL3RyZWUtbm9kZS1jb250ZW50LWl0ZW0nO1xyXG5pbXBvcnQgeyBUcmVlTm9kZUNvbnRlbnRDb21wb25lbnQgfSBmcm9tICcuLi90cmVlLW5vZGUtY29udGVudC90cmVlLW5vZGUtY29udGVudC5jb21wb25lbnQnO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICduZzJ0cmVlLW5vZGUnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi90cmVlLW5vZGUuY29tcG9uZW50Lmh0bWwnLFxyXG4gIHN0eWxlVXJsczogWycuL3RyZWUtbm9kZS5jb21wb25lbnQuY3NzJ11cclxufSlcclxuZXhwb3J0IGNsYXNzIFRyZWVOb2RlQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcclxuXHJcbiAgQElucHV0KCkgbm9kZTogVHJlZU5vZGU7XHJcbiAgQElucHV0KCkgbm9kZUluZGV4OiBudW1iZXI7XHJcblxyXG4gIC8vIOiKgueCueWGheWuuee7hOS7tuWunuS+i1xyXG4gIGNvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPFRyZWVOb2RlQ29udGVudENvbXBvbmVudD47XHJcblxyXG4gIC8vIFRPRE86IG1vdmUgdG8gZHJhZ2dhYmxlIGRpcmVjdGl2ZVxyXG4gIG9uRHJhZ1N0YXJ0KCRldmVudCkge1xyXG4gICAgLy8g6K6+572uRHJhZ05vZGU6IOmAieaLqWRyYWdOb2Rl55qE54i26IqC54K55L2c5Li6RHJhZ05vZGXvvIzpgJrov4dpbmRleOWumuS9jeWIsOaMh+WumueahOiKgueCuVxyXG4gICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLm5vZGUudHJlZU1vZGVsLnNldERyYWdOb2RlKHsgcGFyZW50Tm9kZTogdGhpcy5ub2RlLnBhcmVudCwgaW5kZXg6IHRoaXMubm9kZUluZGV4IH0pLCAzMCk7XHJcbiAgfVxyXG5cclxuICBvbkRyYWdFbmQoKSB7XHJcbiAgICB0aGlzLm5vZGUudHJlZU1vZGVsLnNldERyYWdOb2RlKG51bGwpO1xyXG4gIH1cclxuXHJcbiAgb25EcmFnT3ZlcigkZXZlbnQpIHtcclxuICAgICRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgdGhpcy5ub2RlLnRyZWVNb2RlbC5zZXREcm9wTG9jYXRpb24oeyBjb21wb25lbnQ6IHRoaXMsIHBhcmVudE5vZGU6IHRoaXMubm9kZSwgaW5kZXg6IDAgfSk7XHJcbiAgfVxyXG5cclxuICBvbkRyb3AoJGV2ZW50KSB7XHJcbiAgICAkZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgIC8vIHRoaXMubm9kZS5tb3VzZUFjdGlvbignZHJvcCcsICRldmVudCwgeyBub2RlOiB0aGlzLm5vZGUsIGluZGV4OiAwIH0pO1xyXG4gICAgdGhpcy5ub2RlLnRyZWVNb2RlbC5zZXRGb2N1cyh0cnVlKTtcclxuICAgIHRoaXMubm9kZS5kcm9wTW91c2VBY3Rpb24oJGV2ZW50LHsgcGFyZW50Tm9kZTogdGhpcy5ub2RlLCBpbmRleDogMCB9KTtcclxuICAgIGNvbnNvbGUubG9nKFwib25Ecm9wOiB0cmVlLW5vZGUtY29tcG9uZW50XCIpO1xyXG4gIH1cclxuXHJcbiAgb25EcmFnTGVhdmUobm9kZUNvbnRlbnRXcmFwcGVyLCAkZXZlbnQpIHtcclxuICAgIGlmICghdGhpcy5ub2RlLnRyZWVNb2RlbC5pc0RyYWdnaW5nT3Zlcih0aGlzKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGNvbnN0IHJlY3QgPSBub2RlQ29udGVudFdyYXBwZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcblxyXG4gICAgLy8gSWYgb3V0c2lkZSB0aGUgZWxlbWVudFxyXG4gICAgaWYgKCRldmVudC5jbGllbnRYIDwgcmVjdC5sZWZ0IHx8ICRldmVudC5jbGllbnRYID4gcmVjdC5yaWdodCB8fFxyXG4gICAgICAgICRldmVudC5jbGllbnRZIDwgcmVjdC50b3AgfHwgJGV2ZW50LmNsaWVudFkgPiByZWN0LmJvdHRvbSkge1xyXG5cclxuICAgICAgdGhpcy5ub2RlLnRyZWVNb2RlbC5zZXREcm9wTG9jYXRpb24obnVsbCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBWaWV3Q2hpbGQg5piv5bGe5oCn6KOF6aWw5Zmo77yM55So5p2l5LuO5qih5p2/6KeG5Zu+5Lit6I635Y+W5Yy56YWN55qE5YWD57SgXHJcbiAgQFZpZXdDaGlsZChUcmVlTm9kZUNvbnRlbnREaXJlY3RpdmUpIHRyZWVOb2RlQ29udGVudEhvc3Q6IFRyZWVOb2RlQ29udGVudERpcmVjdGl2ZTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcclxuICAgIHZpZXdDb250YWluZXJSZWY6IFZpZXdDb250YWluZXJSZWYpIHtcclxuICAgICAgXHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIHRoaXMuX2xvYWRUcmVlTm9kZUNvbnRlbnQoKTtcclxuXHJcbiAgICAvLyDop6blj5Hlj5jmm7TmoJHoioLngrnlsZXnpLrmlofmnKxcclxuICAgIHRoaXMubm9kZS5jaGFuZ2VEaXNwbGF5RmllbGQuc3Vic2NyaWJlKG5hbWUgPT4ge1xyXG4gICAgICBpZiAodGhpcy5jb21wb25lbnRSZWYpIHtcclxuICAgICAgICB0aGlzLmNvbXBvbmVudFJlZi5pbnN0YW5jZS5kaXNwbGF5RGF0YSA9IG5hbWU7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgbmdPbkNoYW5nZXMoKSB7XHJcblxyXG4gIH1cclxuXHJcbiAgLy8g6Kej5Yaz5L2/55So5Yqo5oCB57uE5Lu25Ye6546wRXhwcmVzc2lvbkNoYW5nZWRBZnRlckl0SGFzQmVlbkNoZWNrZWRFcnJvcumXrumimO+8mlxyXG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIvaXNzdWVzLzE3NTcyXHJcbiAgX2xvYWRUcmVlTm9kZUNvbnRlbnQoKSB7XHJcblxyXG4gICAgLy8g5L2/55SoSXRlbeS7jumAu+i+keS4iuWwhlRyZWVOb2RlQ29udGVudENvbXBvbmVudOWSjGRhdGHlhbPogZTotbfmnaVcclxuICAgIGxldCB0cmVlTm9kZUNvbnRlbnRJdGVtOiBUcmVlTm9kZUNvbnRlbnRJdGVtID0gbmV3IFRyZWVOb2RlQ29udGVudEl0ZW0oXHJcbiAgICAgIFRyZWVOb2RlQ29udGVudENvbXBvbmVudCx0aGlzLm5vZGUuZGlzcGxheUZpZWxkKTtcclxuICAgIFxyXG4gICAgLy8g5L2/55SoIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciDmnaXkuLrmr4/kuKrlhbfkvZPnmoTnu4Tku7bop6PmnpDlh7rkuIDkuKogQ29tcG9uZW50RmFjdG9yeSBcclxuICAgIC8vIOeEtuWQjiBDb21wb25lbnRGYWN0b3J5IOS8muS4uuavj+S4gOS4que7hOS7tuWIm+W7uuS4gOS4quWunuS+i1xyXG4gICAgbGV0IGNvbXBvbmVudEZhY3RvcnkgPSB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeSh0cmVlTm9kZUNvbnRlbnRJdGVtLmNvbXBvbmVudCk7XHJcblxyXG4gICAgbGV0IHZpZXdDb250YWluZXJSZWYgPSB0aGlzLnRyZWVOb2RlQ29udGVudEhvc3Qudmlld0NvbnRhaW5lclJlZjtcclxuICAgIHZpZXdDb250YWluZXJSZWYuY2xlYXIoKTtcclxuXHJcbiAgICB0aGlzLmNvbXBvbmVudFJlZiA9IHZpZXdDb250YWluZXJSZWYuY3JlYXRlQ29tcG9uZW50KGNvbXBvbmVudEZhY3RvcnkpO1xyXG5cclxuICAgIHRoaXMuY29tcG9uZW50UmVmLmluc3RhbmNlLmRpc3BsYXlEYXRhID0gdHJlZU5vZGVDb250ZW50SXRlbS5kaXNwbGF5RGF0YTsgLy8g5Lyg5YWl5pWw5o2uXHJcbiAgICB0aGlzLmNvbXBvbmVudFJlZi5pbnN0YW5jZS5vcmlnaW5EYXRhID0gdGhpcy5ub2RlLmRhdGE7XHJcbiAgICB0aGlzLmNvbXBvbmVudFJlZi5pbnN0YW5jZS5yaWdodE1lbnVDbGlja2VkLnN1YnNjcmliZShldmVudCA9PiB7XHJcbiAgICAgIHRoaXMubm9kZS5yaWdodE1lbnVDbGlja2VkKGV2ZW50KTtcclxuICAgIH0pO1xyXG5cclxuICB9XHJcblxyXG59XHJcbiJdfQ==