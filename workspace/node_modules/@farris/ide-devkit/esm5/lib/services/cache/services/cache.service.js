/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Optional } from '@angular/core';
import { CacheStorageAbstract } from './storage/cache.storage.abstract.service';
import { CacheSessionStorage } from './storage/sessionstorage/cache.sessionstorage.service';
import { CacheLocalStorage } from './storage/localstorage/cache.localstorage.service';
import { CacheMemoryStorage } from './storage/memory/cache.memory.service';
/** @type {?} */
var CACHE_PREFIX = 'CacheService';
/** @type {?} */
var DEFAULT_STORAGE = 2 /* MEMORY */;
/** @type {?} */
var DEFAULT_ENABLED_STORAGE = 1 /* SESSION_STORAGE */;
var CacheService = /** @class */ (function () {
    function CacheService(_storage) {
        this._storage = _storage;
        /**
         * Default cache options
         */
        this._defaultOptions = {
            expires: Number.MAX_VALUE,
            maxAge: Number.MAX_VALUE
        };
        /**
         * Cache prefix
         */
        this._prefix = CACHE_PREFIX;
        this._validateStorage();
    }
    /**
     * Set data to cache
     * @param key key
     * @param value value
     * @param options options
     */
    /**
     * Set data to cache
     * @param {?} key key
     * @param {?} value value
     * @param {?=} options options
     * @return {?}
     */
    CacheService.prototype.set = /**
     * Set data to cache
     * @param {?} key key
     * @param {?} value value
     * @param {?=} options options
     * @return {?}
     */
    function (key, value, options) {
        /** @type {?} */
        var storageKey = this._toStorageKey(key);
        options = options ? options : this._defaultOptions;
        if (this._storage.setItem(storageKey, this._toStorageValue(value, options))) {
            if (!this._isSystemKey(key) && options.tag) {
                this._saveTag(options.tag, storageKey);
            }
            return true;
        }
        return false;
    };
    /**
     * Get data from cache
     * @param key key
     * @returns result
     */
    /**
     * Get data from cache
     * @param {?} key key
     * @return {?} result
     */
    CacheService.prototype.get = /**
     * Get data from cache
     * @param {?} key key
     * @return {?} result
     */
    function (key) {
        /** @type {?} */
        var storageValue = this._storage.getItem(this._toStorageKey(key));
        /** @type {?} */
        var value = null;
        if (storageValue) {
            if (this._validateStorageValue(storageValue)) {
                value = storageValue.value;
            }
            else {
                this.remove(key);
            }
        }
        return value;
    };
    /**
     * Check if value exists
     * @param key key
     * @returns result
     */
    /**
     * Check if value exists
     * @param {?} key key
     * @return {?} result
     */
    CacheService.prototype.exists = /**
     * Check if value exists
     * @param {?} key key
     * @return {?} result
     */
    function (key) {
        return !!this.get(key);
    };
    /**
     * Remove item from cache
     * @param key key
     */
    /**
     * Remove item from cache
     * @param {?} key key
     * @return {?}
     */
    CacheService.prototype.remove = /**
     * Remove item from cache
     * @param {?} key key
     * @return {?}
     */
    function (key) {
        this._storage.removeItem(this._toStorageKey(key));
        this._removeFromTag(this._toStorageKey(key));
    };
    /**
     * Remove all from cache
     */
    /**
     * Remove all from cache
     * @return {?}
     */
    CacheService.prototype.removeAll = /**
     * Remove all from cache
     * @return {?}
     */
    function () {
        this._storage.clear();
    };
    /**
     * Get all tag data
     * @param tag tag
     * @returns result
     */
    /**
     * Get all tag data
     * @param {?} tag tag
     * @return {?} result
     */
    CacheService.prototype.getTagData = /**
     * Get all tag data
     * @param {?} tag tag
     * @return {?} result
     */
    function (tag) {
        var _this = this;
        /** @type {?} */
        var tags = this.get(this._tagsStorageKey()) || {};
        /** @type {?} */
        var result = {};
        if (tags[tag]) {
            tags[tag].forEach(function (key) {
                /** @type {?} */
                var data = _this.get(_this._fromStorageKey(key));
                if (data) {
                    result[_this._fromStorageKey(key)] = data;
                }
            });
        }
        return result;
    };
    /**
     * Create a new instance of cache with needed storage
     * @param type type
     * @returns result
     */
    /**
     * Create a new instance of cache with needed storage
     * @param {?} type type
     * @return {?} result
     */
    CacheService.prototype.useStorage = /**
     * Create a new instance of cache with needed storage
     * @param {?} type type
     * @return {?} result
     */
    function (type) {
        /** @type {?} */
        var service = new CacheService(this._initStorage(type));
        service.setGlobalPrefix(this._getCachePrefix());
        return service;
    };
    /**
     * Remove all by tag
     * @param tag tag
     */
    /**
     * Remove all by tag
     * @param {?} tag tag
     * @return {?}
     */
    CacheService.prototype.removeTag = /**
     * Remove all by tag
     * @param {?} tag tag
     * @return {?}
     */
    function (tag) {
        var _this = this;
        /** @type {?} */
        var tags = this.get(this._tagsStorageKey()) || {};
        if (tags[tag]) {
            tags[tag].forEach(function (key) {
                _this._storage.removeItem(key);
            });
            delete tags[tag];
            this.set(this._tagsStorageKey(), tags);
        }
    };
    /**
     * Set global cache key prefix
     * @param prefix prefix
     */
    /**
     * Set global cache key prefix
     * @param {?} prefix prefix
     * @return {?}
     */
    CacheService.prototype.setGlobalPrefix = /**
     * Set global cache key prefix
     * @param {?} prefix prefix
     * @return {?}
     */
    function (prefix) {
        this._prefix = prefix;
    };
    /**
     * Validate cache storage
     */
    /**
     * Validate cache storage
     * @private
     * @return {?}
     */
    CacheService.prototype._validateStorage = /**
     * Validate cache storage
     * @private
     * @return {?}
     */
    function () {
        if (!this._storage) {
            this._storage = this._initStorage(DEFAULT_STORAGE);
        }
        if (!this._storage.isEnabled()) {
            this._storage = this._initStorage(DEFAULT_ENABLED_STORAGE);
        }
    };
    /**
     * Remove key from tags keys list
     * @param key key
     */
    /**
     * Remove key from tags keys list
     * @private
     * @param {?} key key
     * @return {?}
     */
    CacheService.prototype._removeFromTag = /**
     * Remove key from tags keys list
     * @private
     * @param {?} key key
     * @return {?}
     */
    function (key) {
        // tslint:disable-next-line:prefer-const
        /** @type {?} */
        var tags = this.get(this._tagsStorageKey()) || {};
        /** @type {?} */
        var index;
        // tslint:disable-next-line:forin
        for (var tag in tags) {
            index = tags[tag].indexOf(key);
            if (index !== -1) {
                tags[tag].splice(index, 1);
                this.set(this._tagsStorageKey(), tags);
                break;
            }
        }
    };
    /**
     * Init storage by type
     * @param type type
     */
    /**
     * Init storage by type
     * @private
     * @param {?} type type
     * @return {?}
     */
    CacheService.prototype._initStorage = /**
     * Init storage by type
     * @private
     * @param {?} type type
     * @return {?}
     */
    function (type) {
        /** @type {?} */
        var storage;
        switch (type) {
            case 1 /* SESSION_STORAGE */:
                storage = new CacheSessionStorage();
                break;
            case 0 /* LOCAL_STORAGE */:
                storage = new CacheLocalStorage();
                break;
            default: storage = new CacheMemoryStorage();
        }
        return storage;
    };
    /**
     * @private
     * @param {?} key
     * @return {?}
     */
    CacheService.prototype._toStorageKey = /**
     * @private
     * @param {?} key
     * @return {?}
     */
    function (key) {
        return this._getCachePrefix() + key;
    };
    /**
     * @private
     * @param {?} key
     * @return {?}
     */
    CacheService.prototype._fromStorageKey = /**
     * @private
     * @param {?} key
     * @return {?}
     */
    function (key) {
        return key.replace(this._getCachePrefix(), '');
    };
    /**
     * Prepare value to set to storage
     * @param value value
     * @param options options
     * @returns result
     */
    /**
     * Prepare value to set to storage
     * @private
     * @param {?} value value
     * @param {?} options options
     * @return {?} result
     */
    CacheService.prototype._toStorageValue = /**
     * Prepare value to set to storage
     * @private
     * @param {?} value value
     * @param {?} options options
     * @return {?} result
     */
    function (value, options) {
        return {
            value: value,
            options: this._toStorageOptions(options)
        };
    };
    /**
     * Prepare options to set to storage
     * @param options options
     * @returns result
     */
    /**
     * Prepare options to set to storage
     * @private
     * @param {?} options options
     * @return {?} result
     */
    CacheService.prototype._toStorageOptions = /**
     * Prepare options to set to storage
     * @private
     * @param {?} options options
     * @return {?} result
     */
    function (options) {
        /** @type {?} */
        var storageOptions = {};
        storageOptions.expires = options.expires ? options.expires :
            (options.maxAge ? Date.now() + (options.maxAge * 1000) : this._defaultOptions.expires);
        storageOptions.maxAge = options.maxAge ? options.maxAge : this._defaultOptions.maxAge;
        return storageOptions;
    };
    /**
     * Validate storage value
     * @param value value
     * @returns result
     */
    /**
     * Validate storage value
     * @private
     * @param {?} value value
     * @return {?} result
     */
    CacheService.prototype._validateStorageValue = /**
     * Validate storage value
     * @private
     * @param {?} value value
     * @return {?} result
     */
    function (value) {
        return !!value.options.expires && value.options.expires > Date.now();
    };
    /**
     * check if its system cache key
     * @param key key
     * @returns result
     */
    /**
     * check if its system cache key
     * @private
     * @param {?} key key
     * @return {?} result
     */
    CacheService.prototype._isSystemKey = /**
     * check if its system cache key
     * @private
     * @param {?} key key
     * @return {?} result
     */
    function (key) {
        return [this._tagsStorageKey()].indexOf(key) !== -1;
    };
    /**
     * Save tag to list of tags
     * @param tag tag
     * @param key key
     */
    /**
     * Save tag to list of tags
     * @private
     * @param {?} tag tag
     * @param {?} key key
     * @return {?}
     */
    CacheService.prototype._saveTag = /**
     * Save tag to list of tags
     * @private
     * @param {?} tag tag
     * @param {?} key key
     * @return {?}
     */
    function (tag, key) {
        /** @type {?} */
        var tags = this.get(this._tagsStorageKey()) || {};
        if (!tags[tag]) {
            tags[tag] = [key];
        }
        else {
            tags[tag].push(key);
        }
        this.set(this._tagsStorageKey(), tags);
    };
    /**
     * Get global cache prefix
     * @returns result
     */
    /**
     * Get global cache prefix
     * @private
     * @return {?} result
     */
    CacheService.prototype._getCachePrefix = /**
     * Get global cache prefix
     * @private
     * @return {?} result
     */
    function () {
        return this._prefix;
    };
    /**
     * @private
     * @return {?}
     */
    CacheService.prototype._tagsStorageKey = /**
     * @private
     * @return {?}
     */
    function () {
        return 'CacheService_tags';
    };
    CacheService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    CacheService.ctorParameters = function () { return [
        { type: CacheStorageAbstract, decorators: [{ type: Optional }] }
    ]; };
    return CacheService;
}());
export { CacheService };
if (false) {
    /**
     * Default cache options
     * @type {?}
     * @private
     */
    CacheService.prototype._defaultOptions;
    /**
     * Cache prefix
     * @type {?}
     * @private
     */
    CacheService.prototype._prefix;
    /**
     * @type {?}
     * @private
     */
    CacheService.prototype._storage;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvaWRlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9jYWNoZS9zZXJ2aWNlcy9jYWNoZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUdyRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUNoRixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx1REFBdUQsQ0FBQztBQUM1RixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxtREFBbUQsQ0FBQztBQUN0RixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQzs7SUFHckUsWUFBWSxHQUFHLGNBQWM7O0lBRTdCLGVBQWUsaUJBQTJCOztJQUMxQyx1QkFBdUIsMEJBQW9DO0FBRWpFO0lBZ0JJLHNCQUF1QyxRQUE4QjtRQUE5QixhQUFRLEdBQVIsUUFBUSxDQUFzQjs7OztRQVY3RCxvQkFBZSxHQUEwQjtZQUM3QyxPQUFPLEVBQUUsTUFBTSxDQUFDLFNBQVM7WUFDekIsTUFBTSxFQUFHLE1BQU0sQ0FBQyxTQUFTO1NBQzVCLENBQUM7Ozs7UUFLTSxZQUFPLEdBQVcsWUFBWSxDQUFDO1FBR25DLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFRDs7Ozs7T0FLRzs7Ozs7Ozs7SUFDSSwwQkFBRzs7Ozs7OztJQUFWLFVBQVcsR0FBVyxFQUFFLEtBQVUsRUFBRSxPQUErQjs7WUFDekQsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDO1FBQzFDLE9BQU8sR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQztRQUNuRCxJQUFJLElBQUksQ0FBQyxRQUFRLENB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QUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNaLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3JCO2FBQU07WUFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3ZCO1FBQ0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVEOzs7T0FHRzs7Ozs7O0lBQ0ssc0NBQWU7Ozs7O0lBQXZCO1FBQ0ksT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3hCLENBQUM7Ozs7O0lBRU8sc0NBQWU7Ozs7SUFBdkI7UUFDSSxPQUFPLG1CQUFtQixDQUFDO0lBQy9CLENBQUM7O2dCQXJRSixVQUFVOzs7O2dCQVhGLG9CQUFvQix1QkEyQkwsUUFBUTs7SUF1UGhDLG1CQUFDO0NBQUEsQUF2UUQsSUF1UUM7U0F0UVksWUFBWTs7Ozs7OztJQUtyQix1Q0FHRTs7Ozs7O0lBS0YsK0JBQXVDOzs7OztJQUVwQixnQ0FBa0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBDYWNoZU9wdGlvbnNJbnRlcmZhY2UgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2NhY2hlLm9wdGlvbnMuaW50ZXJmYWNlJztcclxuaW1wb3J0IHsgQ2FjaGVTdG9yYWdlc0VudW0gfSBmcm9tICcuLi9lbnVtcy9jYWNoZS5zdG9yYWdlcy5lbnVtJztcclxuaW1wb3J0IHsgQ2FjaGVTdG9yYWdlQWJzdHJhY3QgfSBmcm9tICcuL3N0b3JhZ2UvY2FjaGUuc3RvcmFnZS5hYnN0cmFjdC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ2FjaGVTZXNzaW9uU3RvcmFnZSB9IGZyb20gJy4vc3RvcmFnZS9zZXNzaW9uc3RvcmFnZS9jYWNoZS5zZXNzaW9uc3RvcmFnZS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ2FjaGVMb2NhbFN0b3JhZ2UgfSBmcm9tICcuL3N0b3JhZ2UvbG9jYWxzdG9yYWdlL2NhY2hlLmxvY2Fsc3RvcmFnZS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ2FjaGVNZW1vcnlTdG9yYWdlIH0gZnJvbSAnLi9zdG9yYWdlL21lbW9yeS9jYWNoZS5tZW1vcnkuc2VydmljZSc7XHJcbmltcG9ydCB7IFN0b3JhZ2VWYWx1ZUludGVyZmFjZSB9IGZyb20gJy4uL2ludGVyZmFjZXMvc3RvcmFnZS52YWx1ZS5pbnRlcmZhY2UnO1xyXG5cclxuY29uc3QgQ0FDSEVfUFJFRklYID0gJ0NhY2hlU2VydmljZSc7XHJcblxyXG5jb25zdCBERUZBVUxUX1NUT1JBR0UgPSBDYWNoZVN0b3JhZ2VzRW51bS5NRU1PUlk7XHJcbmNvbnN0IERFRkFVTFRfRU5BQkxFRF9TVE9SQUdFID0gQ2FjaGVTdG9yYWdlc0VudW0uU0VTU0lPTl9TVE9SQUdFO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQ2FjaGVTZXJ2aWNlIHtcclxuXHJcbiAgICAvKipcclxuICAgICAqIERlZmF1bHQgY2FjaGUgb3B0aW9uc1xyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9kZWZhdWx0T3B0aW9uczogQ2FjaGVPcHRpb25zSW50ZXJmYWNlID0ge1xyXG4gICAgICAgIGV4cGlyZXM6IE51bWJlci5NQVhfVkFMVUUsXHJcbiAgICAgICAgbWF4QWdlIDogTnVtYmVyLk1BWF9WQUxVRVxyXG4gICAgfTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIENhY2hlIHByZWZpeFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9wcmVmaXg6IHN0cmluZyA9IENBQ0hFX1BSRUZJWDtcclxuXHJcbiAgICBwdWJsaWMgY29uc3RydWN0b3IoQE9wdGlvbmFsKCkgcHJpdmF0ZSBfc3RvcmFnZTogQ2FjaGVTdG9yYWdlQWJzdHJhY3QpIHtcclxuICAgICAgICB0aGlzLl92YWxpZGF0ZVN0b3JhZ2UoKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFNldCBkYXRhIHRvIGNhY2hlXHJcbiAgICAgKiBAcGFyYW0ga2V5IGtleVxyXG4gICAgICogQHBhcmFtIHZhbHVlIHZhbHVlXHJcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBvcHRpb25zXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnksIG9wdGlvbnM/OiBDYWNoZU9wdGlvbnNJbnRlcmZhY2UpIHtcclxuICAgICAgICBjb25zdCBzdG9yYWdlS2V5ID0gdGhpcy5fdG9TdG9yYWdlS2V5KGtleSk7XHJcbiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBvcHRpb25zIDogdGhpcy5fZGVmYXVsdE9wdGlvbnM7XHJcbiAgICAgICAgaWYgKHRoaXMuX3N0b3JhZ2Uuc2V0SXRlbShzdG9yYWdlS2V5LCB0aGlzLl90b1N0b3JhZ2VWYWx1ZSh2YWx1ZSwgb3B0aW9ucykpKSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5faXNTeXN0ZW1LZXkoa2V5KSAmJiBvcHRpb25zLnRhZykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fc2F2ZVRhZyhvcHRpb25zLnRhZywgc3RvcmFnZUtleSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBHZXQgZGF0YSBmcm9tIGNhY2hlXHJcbiAgICAgKiBAcGFyYW0ga2V5IGtleVxyXG4gICAgICogQHJldHVybnMgcmVzdWx0XHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBnZXQoa2V5OiBzdHJpbmcpOiBhbnkge1xyXG4gICAgICAgIGNvbnN0IHN0b3JhZ2VWYWx1ZSA9IHRoaXMuX3N0b3JhZ2UuZ2V0SXRlbSh0aGlzLl90b1N0b3JhZ2VLZXkoa2V5KSk7XHJcbiAgICAgICAgbGV0IHZhbHVlOiBhbnkgPSBudWxsO1xyXG4gICAgICAgIGlmIChzdG9yYWdlVmFsdWUpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuX3ZhbGlkYXRlU3RvcmFnZVZhbHVlKHN0b3JhZ2VWYWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gc3RvcmFnZVZhbHVlLnZhbHVlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoa2V5KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDaGVjayBpZiB2YWx1ZSBleGlzdHNcclxuICAgICAqIEBwYXJhbSBrZXkga2V5XHJcbiAgICAgKiBAcmV0dXJucyByZXN1bHRcclxuICAgICAqL1xyXG4gICAgcHVibGljIGV4aXN0cyhrZXk6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiAhIXRoaXMuZ2V0KGtleSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZW1vdmUgaXRlbSBmcm9tIGNhY2hlXHJcbiAgICAgKiBAcGFyYW0ga2V5IGtleVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgcmVtb3ZlKGtleTogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5fc3RvcmFnZS5yZW1vdmVJdGVtKHRoaXMuX3RvU3RvcmFnZUtleShrZXkpKTtcclxuICAgICAgICB0aGlzLl9yZW1vdmVGcm9tVGFnKHRoaXMuX3RvU3RvcmFnZUtleShrZXkpKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJlbW92ZSBhbGwgZnJvbSBjYWNoZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgcmVtb3ZlQWxsKCkge1xyXG4gICAgICAgIHRoaXMuX3N0b3JhZ2UuY2xlYXIoKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldCBhbGwgdGFnIGRhdGFcclxuICAgICAqIEBwYXJhbSB0YWcgdGFnXHJcbiAgICAgKiBAcmV0dXJucyByZXN1bHRcclxuICAgICAqL1xyXG4gICAgcHVibGljIGdldFRhZ0RhdGEodGFnOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCB0YWdzID0gdGhpcy5nZXQodGhpcy5fdGFnc1N0b3JhZ2VLZXkoKSkgfHwge307XHJcbiAgICAgICAgY29uc3QgcmVzdWx0OiB7W2tleTogc3RyaW5nXTogYW55fSA9IHt9O1xyXG4gICAgICAgIGlmICh0YWdzW3RhZ10pIHtcclxuICAgICAgICAgICAgdGFnc1t0YWddLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gdGhpcy5nZXQodGhpcy5fZnJvbVN0b3JhZ2VLZXkoa2V5KSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFt0aGlzLl9mcm9tU3RvcmFnZUtleShrZXkpXSA9IGRhdGE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGNhY2hlIHdpdGggbmVlZGVkIHN0b3JhZ2VcclxuICAgICAqIEBwYXJhbSB0eXBlIHR5cGVcclxuICAgICAqIEByZXR1cm5zIHJlc3VsdFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgdXNlU3RvcmFnZSh0eXBlOiBDYWNoZVN0b3JhZ2VzRW51bSkge1xyXG4gICAgICAgIGNvbnN0IHNlcnZpY2UgPSBuZXcgQ2FjaGVTZXJ2aWNlKHRoaXMuX2luaXRTdG9yYWdlKHR5cGUpKTtcclxuICAgICAgICBzZXJ2aWNlLnNldEdsb2JhbFByZWZpeCh0aGlzLl9nZXRDYWNoZVByZWZpeCgpKTtcclxuICAgICAgICByZXR1cm4gc2VydmljZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJlbW92ZSBhbGwgYnkgdGFnXHJcbiAgICAgKiBAcGFyYW0gdGFnIHRhZ1xyXG4gICAgICovXHJcbiAgICBwdWJsaWMgcmVtb3ZlVGFnKHRhZzogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgdGFncyA9IHRoaXMuZ2V0KHRoaXMuX3RhZ3NTdG9yYWdlS2V5KCkpIHx8IHt9O1xyXG4gICAgICAgIGlmICh0YWdzW3RhZ10pIHtcclxuICAgICAgICAgICAgdGFnc1t0YWddLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9zdG9yYWdlLnJlbW92ZUl0ZW0oa2V5KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGRlbGV0ZSB0YWdzW3RhZ107XHJcbiAgICAgICAgICAgIHRoaXMuc2V0KHRoaXMuX3RhZ3NTdG9yYWdlS2V5KCksIHRhZ3MpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFNldCBnbG9iYWwgY2FjaGUga2V5IHByZWZpeFxyXG4gICAgICogQHBhcmFtIHByZWZpeCBwcmVmaXhcclxuICAgICAqL1xyXG4gICAgcHVibGljIHNldEdsb2JhbFByZWZpeChwcmVmaXg6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuX3ByZWZpeCA9IHByZWZpeDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFZhbGlkYXRlIGNhY2hlIHN0b3JhZ2VcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfdmFsaWRhdGVTdG9yYWdlKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5fc3RvcmFnZSkge1xyXG4gICAgICAgICAgICB0aGlzLl9zdG9yYWdlID0gdGhpcy5faW5pdFN0b3JhZ2UoREVGQVVMVF9TVE9SQUdFKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCF0aGlzLl9zdG9yYWdlLmlzRW5hYmxlZCgpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3N0b3JhZ2UgPSB0aGlzLl9pbml0U3RvcmFnZShERUZBVUxUX0VOQUJMRURfU1RPUkFHRSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmVtb3ZlIGtleSBmcm9tIHRhZ3Mga2V5cyBsaXN0XHJcbiAgICAgKiBAcGFyYW0ga2V5IGtleVxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9yZW1vdmVGcm9tVGFnKGtleTogc3RyaW5nKSB7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnByZWZlci1jb25zdFxyXG4gICAgICAgIGxldCB0YWdzID0gdGhpcy5nZXQodGhpcy5fdGFnc1N0b3JhZ2VLZXkoKSkgfHwge307XHJcbiAgICAgICAgbGV0IGluZGV4OiBudW1iZXI7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmZvcmluXHJcbiAgICAgICAgZm9yIChjb25zdCB0YWcgaW4gdGFncykge1xyXG4gICAgICAgICAgICBpbmRleCA9IHRhZ3NbdGFnXS5pbmRleE9mKGtleSk7XHJcbiAgICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIHRhZ3NbdGFnXS5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXQodGhpcy5fdGFnc1N0b3JhZ2VLZXkoKSwgdGFncyk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEluaXQgc3RvcmFnZSBieSB0eXBlXHJcbiAgICAgKiBAcGFyYW0gdHlwZSB0eXBlXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX2luaXRTdG9yYWdlKHR5cGU6IENhY2hlU3RvcmFnZXNFbnVtKSB7XHJcbiAgICAgICAgbGV0IHN0b3JhZ2U6IENhY2hlU3RvcmFnZUFic3RyYWN0O1xyXG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlIENhY2hlU3RvcmFnZXNFbnVtLlNFU1NJT05fU1RPUkFHRTpcclxuICAgICAgICAgICAgICAgIHN0b3JhZ2UgPSBuZXcgQ2FjaGVTZXNzaW9uU3RvcmFnZSgpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgQ2FjaGVTdG9yYWdlc0VudW0uTE9DQUxfU1RPUkFHRTpcclxuICAgICAgICAgICAgICAgIHN0b3JhZ2UgPSBuZXcgQ2FjaGVMb2NhbFN0b3JhZ2UoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OiBzdG9yYWdlID0gbmV3IENhY2hlTWVtb3J5U3RvcmFnZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc3RvcmFnZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF90b1N0b3JhZ2VLZXkoa2V5OiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0Q2FjaGVQcmVmaXgoKSArIGtleTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9mcm9tU3RvcmFnZUtleShrZXk6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiBrZXkucmVwbGFjZSh0aGlzLl9nZXRDYWNoZVByZWZpeCgpLCAnJyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBQcmVwYXJlIHZhbHVlIHRvIHNldCB0byBzdG9yYWdlXHJcbiAgICAgKiBAcGFyYW0gdmFsdWUgdmFsdWVcclxuICAgICAqIEBwYXJhbSBvcHRpb25zIG9wdGlvbnNcclxuICAgICAqIEByZXR1cm5zIHJlc3VsdFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF90b1N0b3JhZ2VWYWx1ZSh2YWx1ZTogYW55LCBvcHRpb25zOiBDYWNoZU9wdGlvbnNJbnRlcmZhY2UpOiBTdG9yYWdlVmFsdWVJbnRlcmZhY2Uge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHZhbHVlLFxyXG4gICAgICAgICAgICBvcHRpb25zOiB0aGlzLl90b1N0b3JhZ2VPcHRpb25zKG9wdGlvbnMpXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFByZXBhcmUgb3B0aW9ucyB0byBzZXQgdG8gc3RvcmFnZVxyXG4gICAgICogQHBhcmFtIG9wdGlvbnMgb3B0aW9uc1xyXG4gICAgICogQHJldHVybnMgcmVzdWx0XHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX3RvU3RvcmFnZU9wdGlvbnMob3B0aW9uczogQ2FjaGVPcHRpb25zSW50ZXJmYWNlKTogQ2FjaGVPcHRpb25zSW50ZXJmYWNlIHtcclxuICAgICAgICBjb25zdCBzdG9yYWdlT3B0aW9uczogQ2FjaGVPcHRpb25zSW50ZXJmYWNlID0ge307XHJcbiAgICAgICAgc3RvcmFnZU9wdGlvbnMuZXhwaXJlcyA9IG9wdGlvbnMuZXhwaXJlcyA/IG9wdGlvbnMuZXhwaXJlcyA6XHJcbiAgICAgICAgICAgIChvcHRpb25zLm1heEFnZSA/IERhdGUubm93KCkgKyAob3B0aW9ucy5tYXhBZ2UgKiAxMDAwKSA6IHRoaXMuX2RlZmF1bHRPcHRpb25zLmV4cGlyZXMpO1xyXG4gICAgICAgIHN0b3JhZ2VPcHRpb25zLm1heEFnZSA9IG9wdGlvbnMubWF4QWdlID8gb3B0aW9ucy5tYXhBZ2UgOiB0aGlzLl9kZWZhdWx0T3B0aW9ucy5tYXhBZ2U7XHJcbiAgICAgICAgcmV0dXJuIHN0b3JhZ2VPcHRpb25zO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogVmFsaWRhdGUgc3RvcmFnZSB2YWx1ZVxyXG4gICAgICogQHBhcmFtIHZhbHVlIHZhbHVlXHJcbiAgICAgKiBAcmV0dXJucyByZXN1bHRcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfdmFsaWRhdGVTdG9yYWdlVmFsdWUodmFsdWU6IFN0b3JhZ2VWYWx1ZUludGVyZmFjZSkge1xyXG4gICAgICAgIHJldHVybiAhIXZhbHVlLm9wdGlvbnMuZXhwaXJlcyAmJiB2YWx1ZS5vcHRpb25zLmV4cGlyZXMgPiBEYXRlLm5vdygpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogY2hlY2sgaWYgaXRzIHN5c3RlbSBjYWNoZSBrZXlcclxuICAgICAqIEBwYXJhbSBrZXkga2V5XHJcbiAgICAgKiBAcmV0dXJucyByZXN1bHRcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfaXNTeXN0ZW1LZXkoa2V5OiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4gW3RoaXMuX3RhZ3NTdG9yYWdlS2V5KCldLmluZGV4T2Yoa2V5KSAhPT0gLTE7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTYXZlIHRhZyB0byBsaXN0IG9mIHRhZ3NcclxuICAgICAqIEBwYXJhbSB0YWcgdGFnXHJcbiAgICAgKiBAcGFyYW0ga2V5IGtleVxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9zYXZlVGFnKHRhZzogc3RyaW5nLCBrZXk6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IHRhZ3MgPSB0aGlzLmdldCh0aGlzLl90YWdzU3RvcmFnZUtleSgpKSB8fCB7fTtcclxuICAgICAgICBpZiAoIXRhZ3NbdGFnXSkge1xyXG4gICAgICAgICAgICB0YWdzW3RhZ10gPSBba2V5XTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0YWdzW3RhZ10ucHVzaChrZXkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNldCh0aGlzLl90YWdzU3RvcmFnZUtleSgpLCB0YWdzKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldCBnbG9iYWwgY2FjaGUgcHJlZml4XHJcbiAgICAgKiBAcmV0dXJucyByZXN1bHRcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfZ2V0Q2FjaGVQcmVmaXgoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ByZWZpeDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF90YWdzU3RvcmFnZUtleSgpIHtcclxuICAgICAgICByZXR1cm4gJ0NhY2hlU2VydmljZV90YWdzJztcclxuICAgIH1cclxuXHJcbn1cclxuIl19