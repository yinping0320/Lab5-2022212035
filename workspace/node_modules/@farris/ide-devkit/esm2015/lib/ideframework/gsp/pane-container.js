/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Pane } from './pane';
import { ItemRegistry } from './item-registry';
/** @type {?} */
const SERIALIZATION_VERSION = 1;
export class PaneContainer {
    /**
     * @param {?} params
     */
    constructor(params) {
        /** @type {?} */
        let applicationDelegate;
        /** @type {?} */
        let deserializerManager;
        /** @type {?} */
        let notificationManager;
        ({
            config: this.config,
            applicationDelegate,
            notificationManager,
            deserializerManager,
            viewRegistry: this.viewRegistry,
            location: this.location
        } = params);
        this.itemRegistry = new ItemRegistry();
        this.alive = true;
        this.setRoot(new Pane({
            container: this,
            config: this.config,
            applicationDelegate,
            notificationManager,
            deserializerManager,
            viewRegistry: this.viewRegistry
        }));
        this.didActivatePane(this.getRoot());
    }
    /**
     * @return {?}
     */
    getLocation() { return this.location; }
    /**
     * @return {?}
     */
    getElement() {
    }
    /**
     * @return {?}
     */
    destroy() {
        this.alive = false;
        for (const pane of this.getRoot().getPanes()) {
            pane.destroy();
        }
    }
    /**
     * @return {?}
     */
    isAlive() { return this.alive; }
    /**
     * @return {?}
     */
    isDestroyed() { return !this.isAlive(); }
    /**
     * @param {...?} params
     * @return {?}
     */
    serialize(...params) {
        return {
            deserializer: 'PaneContainer',
            version: SERIALIZATION_VERSION,
            root: this.root ? this.root.serialize() : null,
            activePaneId: this.activePane.id
        };
    }
    /**
     * @param {?} state
     * @param {?} deserializerManager
     * @return {?}
     */
    deserialize(state, deserializerManager) {
        if (state.version !== SERIALIZATION_VERSION) {
            return;
        }
        this.setRoot(deserializerManager.deserialize(state.root));
        this.activePane = this.getRoot().getPanes().find(pane => pane.id === state.activePaneId) || this.getPanes()[0];
        if (this.config && this.config.get && this.config.get('core.destroyEmptyPanes')) {
            this.destroyEmptyPanes();
        }
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    onDidChangeRoot(fn) {
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    observeRoot(fn) {
        fn(this.getRoot());
        return this.onDidChangeRoot(fn);
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    onDidAddPane(fn) {
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    observePanes(fn) {
        for (const pane of this.getPanes()) {
            fn(pane);
        }
        return this.onDidAddPane(({ pane }) => fn(pane));
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    onDidDestroyPane(fn) {
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    onWillDestroyPane(fn) {
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    onDidChangeActivePane(fn) {
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    onDidActivatePane(fn) {
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    observeActivePane(fn) {
        fn(this.getActivePane());
        return this.onDidChangeActivePane(fn);
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    onDidAddPaneItem(fn) {
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    observePaneItems(fn) {
        for (const item of this.getPaneItems()) {
            fn(item);
        }
        return this.onDidAddPaneItem(({ item }) => fn(item));
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    onDidChangeActivePaneItem(fn) {
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    onDidStopChangingActivePaneItem(fn) {
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    observeActivePaneItem(fn) {
        fn(this.getActivePaneItem());
        return this.onDidChangeActivePaneItem(fn);
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    onWillDestroyPaneItem(fn) {
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    onDidDestroyPaneItem(fn) {
    }
    /**
     * @return {?}
     */
    getRoot() { return this.root; }
    /**
     * @param {?} root
     * @return {?}
     */
    setRoot(root) {
        this.root = root;
        this.root.setParent(this);
        this.root.setContainer(this);
        if ((this.getActivePane() == null) && this.root instanceof Pane) {
            this.didActivatePane(this.root);
        }
    }
    /**
     * @param {?} oldChild
     * @param {?} newChild
     * @return {?}
     */
    replaceChild(oldChild, newChild) {
        if (oldChild !== this.root) {
            throw new Error('Replacing non-existent child');
        }
        this.setRoot(newChild);
    }
    /**
     * @return {?}
     */
    getPanes() {
        if (this.alive) {
            return this.getRoot().getPanes();
        }
        else {
            return [];
        }
    }
    /**
     * @return {?}
     */
    getPaneItems() {
        return this.getRoot().getItems();
    }
    /**
     * @return {?}
     */
    getActivePane() {
        return this.activePane;
    }
    /**
     * @return {?}
     */
    getActivePaneItem() {
        return this.getActivePane().getActiveItem();
    }
    /**
     * @param {?} uri
     * @return {?}
     */
    paneForURI(uri) {
        return this.getPanes().find(pane => pane.itemForURI(uri) != null);
    }
    /**
     * @param {?} item
     * @return {?}
     */
    paneForItem(item) {
        return this.getPanes().find(pane => pane.getItems().find(it => it === item));
    }
    /**
     * @return {?}
     */
    saveAll() {
        for (const pane of this.getPanes()) {
            pane.saveItems();
        }
    }
    /**
     * @param {?} options
     * @return {?}
     */
    confirmClose(options) {
        /** @type {?} */
        const promises = [];
        for (const pane of this.getPanes()) {
            for (const item of pane.getItems()) {
                promises.push(pane.promptToSaveItem(item, options));
            }
        }
        return Promise.all(promises).then((results) => !results.find(item => item === false));
    }
    /**
     * @return {?}
     */
    activateNextPane() {
        /** @type {?} */
        const panes = this.getPanes();
        if (panes.length > 1) {
            /** @type {?} */
            const currentIndex = panes.indexOf(this.activePane);
            /** @type {?} */
            const nextIndex = (currentIndex + 1) % panes.length;
            panes[nextIndex].activate();
            return true;
        }
        else {
            return false;
        }
    }
    /**
     * @return {?}
     */
    activatePreviousPane() {
        /** @type {?} */
        const panes = this.getPanes();
        if (panes.length > 1) {
            /** @type {?} */
            const currentIndex = panes.indexOf(this.activePane);
            /** @type {?} */
            let previousIndex = currentIndex - 1;
            if (previousIndex < 0) {
                previousIndex = panes.length - 1;
            }
            panes[previousIndex].activate();
            return true;
        }
        else {
            return false;
        }
    }
    /**
     * @param {?} destPane
     * @return {?}
     */
    moveActiveItemToPane(destPane) {
        /** @type {?} */
        const item = this.activePane.getActiveItem();
        if (!destPane.isItemAllowed(item)) {
            return;
        }
        this.activePane.moveItemToPane(item, destPane);
        destPane.setActiveItem(item);
    }
    /**
     * @param {?} destPane
     * @return {?}
     */
    copyActiveItemToPane(destPane) {
        /** @type {?} */
        const item = this.activePane.copyActiveItem();
        if (item && destPane.isItemAllowed(item)) {
            destPane.activateItem(item);
        }
    }
    /**
     * @return {?}
     */
    destroyEmptyPanes() {
        for (const pane of this.getPanes()) {
            if (pane.items.length === 0) {
                pane.destroy();
            }
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    didAddPane(event) {
        /** @type {?} */
        const items = event.pane.getItems();
        for (let i = 0, length = items.length; i < length; i++) {
            /** @type {?} */
            const item = items[i];
            this.didAddPaneItem(item, event.pane, i);
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    willDestroyPane(event) {
    }
    /**
     * @param {?} event
     * @return {?}
     */
    didDestroyPane(event) {
    }
    /**
     * @param {?} activePane
     * @return {?}
     */
    didActivatePane(activePane) {
        if (activePane !== this.activePane) {
            if (!this.getPanes().find(item => item === activePane)) {
                throw new Error('Setting active pane that is not present in pane container');
            }
            this.activePane = activePane;
            this.didChangeActiveItemOnPane(this.activePane, this.activePane.getActiveItem());
        }
        return this.activePane;
    }
    /**
     * @param {?} item
     * @param {?} pane
     * @param {?} index
     * @return {?}
     */
    didAddPaneItem(item, pane, index) {
        this.itemRegistry.addItem(item);
    }
    /**
     * @param {?} event
     * @return {?}
     */
    willDestroyPaneItem(event) {
    }
    /**
     * @param {?} event
     * @return {?}
     */
    didDestroyPaneItem(event) {
        this.itemRegistry.removeItem(event.item);
        // this.emitter.emit('did-destroy-pane-item', event);
    }
    /**
     * @param {?} pane
     * @param {?} activeItem
     * @return {?}
     */
    didChangeActiveItemOnPane(pane, activeItem) {
        if (pane === this.getActivePane()) {
            this.cancelStoppedChangingActivePaneItemTimeout();
            // `setTimeout()` isn't available during the snapshotting phase, but that's okay.
        }
    }
    /**
     * @return {?}
     */
    cancelStoppedChangingActivePaneItemTimeout() {
    }
}
if (false) {
    /** @type {?} */
    PaneContainer.prototype.itemRegistry;
    /** @type {?} */
    PaneContainer.prototype.alive;
    /** @type {?} */
    PaneContainer.prototype.viewRegistry;
    /** @type {?} */
    PaneContainer.prototype.location;
    /** @type {?} */
    PaneContainer.prototype.activePane;
    /** @type {?} */
    PaneContainer.prototype.root;
    /** @type {?} */
    PaneContainer.prototype.config;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuZS1jb250YWluZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2lkZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvaWRlZnJhbWV3b3JrL2dzcC9wYW5lLWNvbnRhaW5lci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUM5QixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7O01BRXpDLHFCQUFxQixHQUFHLENBQUM7QUFFL0IsTUFBTSxPQUFPLGFBQWE7Ozs7SUFTeEIsWUFBWSxNQUFNOztZQUNaLG1CQUFtQjs7WUFBRSxtQkFBbUI7O1lBQUUsbUJBQW1CO1FBQ2pFLENBQUM7WUFDQyxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU07WUFDbkIsbUJBQW1CO1lBQ25CLG1CQUFtQjtZQUNuQixtQkFBbUI7WUFDbkIsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO1lBQy9CLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtTQUN4QixHQUFHLE1BQU0sQ0FBQyxDQUFDO1FBRVosSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBR2xCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLENBQUM7WUFDcEIsU0FBUyxFQUFFLElBQUk7WUFDZixNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU07WUFDbkIsbUJBQW1CO1lBQ25CLG1CQUFtQjtZQUNuQixtQkFBbUI7WUFDbkIsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO1NBQ2hDLENBQUMsQ0FBQyxDQUFDO1FBQ0osSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUN2QyxDQUFDOzs7O0lBRUQsV0FBVyxLQUFLLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7Ozs7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Q3pDLHFEQUFxRDtJQUN2RCxDQUFDOzs7Ozs7SUFFRCx5QkFBeUIsQ0FBQyxJQUFJLEVBQUUsVUFBVTtRQUN4QyxJQUFJLElBQUksS0FBSyxJQUFJLENBQUMsYUFBYSxFQUFFLEVBQUU7WUFFakMsSUFBSSxDQUFDLDBDQUEwQyxFQUFFLENBQUM7WUFDbEQsaUZBQWlGO1NBRWxGO0lBQ0gsQ0FBQzs7OztJQUVELDBDQUEwQztJQUUxQyxDQUFDO0NBQ0Y7OztJQXZSQyxxQ0FBa0I7O0lBQ2xCLDhCQUFlOztJQUNmLHFDQUFrQjs7SUFDbEIsaUNBQWM7O0lBQ2QsbUNBQWdCOztJQUNoQiw2QkFBVTs7SUFDViwrQkFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBhbmUgfSBmcm9tICcuL3BhbmUnO1xyXG5pbXBvcnQgeyBJdGVtUmVnaXN0cnkgfSBmcm9tICcuL2l0ZW0tcmVnaXN0cnknO1xyXG5cclxuY29uc3QgU0VSSUFMSVpBVElPTl9WRVJTSU9OID0gMTtcclxuXHJcbmV4cG9ydCBjbGFzcyBQYW5lQ29udGFpbmVyIHtcclxuICBpdGVtUmVnaXN0cnk6IGFueTtcclxuICBhbGl2ZTogYm9vbGVhbjtcclxuICB2aWV3UmVnaXN0cnk6IGFueTtcclxuICBsb2NhdGlvbjogYW55O1xyXG4gIGFjdGl2ZVBhbmU6IGFueTtcclxuICByb290OiBhbnk7XHJcbiAgY29uZmlnOiBhbnk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHBhcmFtcykge1xyXG4gICAgbGV0IGFwcGxpY2F0aW9uRGVsZWdhdGUsIGRlc2VyaWFsaXplck1hbmFnZXIsIG5vdGlmaWNhdGlvbk1hbmFnZXI7XHJcbiAgICAoe1xyXG4gICAgICBjb25maWc6IHRoaXMuY29uZmlnLFxyXG4gICAgICBhcHBsaWNhdGlvbkRlbGVnYXRlLFxyXG4gICAgICBub3RpZmljYXRpb25NYW5hZ2VyLFxyXG4gICAgICBkZXNlcmlhbGl6ZXJNYW5hZ2VyLFxyXG4gICAgICB2aWV3UmVnaXN0cnk6IHRoaXMudmlld1JlZ2lzdHJ5LFxyXG4gICAgICBsb2NhdGlvbjogdGhpcy5sb2NhdGlvblxyXG4gICAgfSA9IHBhcmFtcyk7XHJcblxyXG4gICAgdGhpcy5pdGVtUmVnaXN0cnkgPSBuZXcgSXRlbVJlZ2lzdHJ5KCk7XHJcbiAgICB0aGlzLmFsaXZlID0gdHJ1ZTtcclxuXHJcblxyXG4gICAgdGhpcy5zZXRSb290KG5ldyBQYW5lKHtcclxuICAgICAgY29udGFpbmVyOiB0aGlzLFxyXG4gICAgICBjb25maWc6IHRoaXMuY29uZmlnLFxyXG4gICAgICBhcHBsaWNhdGlvbkRlbGVnYXRlLFxyXG4gICAgICBub3RpZmljYXRpb25NYW5hZ2VyLFxyXG4gICAgICBkZXNlcmlhbGl6ZXJNYW5hZ2VyLFxyXG4gICAgICB2aWV3UmVnaXN0cnk6IHRoaXMudmlld1JlZ2lzdHJ5XHJcbiAgICB9KSk7XHJcbiAgICB0aGlzLmRpZEFjdGl2YXRlUGFuZSh0aGlzLmdldFJvb3QoKSk7XHJcbiAgfVxyXG5cclxuICBnZXRMb2NhdGlvbigpIHsgcmV0dXJuIHRoaXMubG9jYXRpb247IH1cclxuXHJcbiAgZ2V0RWxlbWVudCgpIHtcclxuICB9XHJcblxyXG4gIGRlc3Ryb3koKSB7XHJcbiAgICB0aGlzLmFsaXZlID0gZmFsc2U7XHJcbiAgICBmb3IgKGNvbnN0IHBhbmUgb2YgdGhpcy5nZXRSb290KCkuZ2V0UGFuZXMoKSkgeyBwYW5lLmRlc3Ryb3koKTsgfVxyXG5cclxuICB9XHJcblxyXG4gIGlzQWxpdmUoKSB7IHJldHVybiB0aGlzLmFsaXZlOyB9XHJcblxyXG4gIGlzRGVzdHJveWVkKCkgeyByZXR1cm4gIXRoaXMuaXNBbGl2ZSgpOyB9XHJcblxyXG4gIHNlcmlhbGl6ZSguLi5wYXJhbXMpIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIGRlc2VyaWFsaXplcjogJ1BhbmVDb250YWluZXInLFxyXG4gICAgICB2ZXJzaW9uOiBTRVJJQUxJWkFUSU9OX1ZFUlNJT04sXHJcbiAgICAgIHJvb3Q6IHRoaXMucm9vdCA/IHRoaXMucm9vdC5zZXJpYWxpemUoKSA6IG51bGwsXHJcbiAgICAgIGFjdGl2ZVBhbmVJZDogdGhpcy5hY3RpdmVQYW5lLmlkXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgZGVzZXJpYWxpemUoc3RhdGUsIGRlc2VyaWFsaXplck1hbmFnZXIpIHtcclxuICAgIGlmIChzdGF0ZS52ZXJzaW9uICE9PSBTRVJJQUxJWkFUSU9OX1ZFUlNJT04pIHsgcmV0dXJuOyB9XHJcbiAgICB0aGlzLnNldFJvb3QoZGVzZXJpYWxpemVyTWFuYWdlci5kZXNlcmlhbGl6ZShzdGF0ZS5yb290KSk7XHJcbiAgICB0aGlzLmFjdGl2ZVBhbmUgPSB0aGlzLmdldFJvb3QoKS5nZXRQYW5lcygpLmZpbmQocGFuZSA9PiBwYW5lLmlkID09PSBzdGF0ZS5hY3RpdmVQYW5lSWQpIHx8IHRoaXMuZ2V0UGFuZXMoKVswXTtcclxuICAgIGlmICh0aGlzLmNvbmZpZyAmJiB0aGlzLmNvbmZpZy5nZXQgJiYgdGhpcy5jb25maWcuZ2V0KCdjb3JlLmRlc3Ryb3lFbXB0eVBhbmVzJykpIHtcclxuICAgICAgdGhpcy5kZXN0cm95RW1wdHlQYW5lcygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgb25EaWRDaGFuZ2VSb290KGZuKSB7XHJcbiAgfVxyXG5cclxuICBvYnNlcnZlUm9vdChmbikge1xyXG4gICAgZm4odGhpcy5nZXRSb290KCkpO1xyXG4gICAgcmV0dXJuIHRoaXMub25EaWRDaGFuZ2VSb290KGZuKTtcclxuICB9XHJcblxyXG4gIG9uRGlkQWRkUGFuZShmbikge1xyXG4gIH1cclxuXHJcbiAgb2JzZXJ2ZVBhbmVzKGZuKSB7XHJcbiAgICBmb3IgKGNvbnN0IHBhbmUgb2YgdGhpcy5nZXRQYW5lcygpKSB7IGZuKHBhbmUpOyB9XHJcbiAgICByZXR1cm4gdGhpcy5vbkRpZEFkZFBhbmUoKHsgcGFuZSB9KSA9PiBmbihwYW5lKSk7XHJcbiAgfVxyXG5cclxuICBvbkRpZERlc3Ryb3lQYW5lKGZuKSB7XHJcbiAgfVxyXG5cclxuICBvbldpbGxEZXN0cm95UGFuZShmbikge1xyXG4gIH1cclxuXHJcbiAgb25EaWRDaGFuZ2VBY3RpdmVQYW5lKGZuKSB7XHJcbiAgfVxyXG5cclxuICBvbkRpZEFjdGl2YXRlUGFuZShmbikge1xyXG4gIH1cclxuXHJcbiAgb2JzZXJ2ZUFjdGl2ZVBhbmUoZm4pIHtcclxuICAgIGZuKHRoaXMuZ2V0QWN0aXZlUGFuZSgpKTtcclxuICAgIHJldHVybiB0aGlzLm9uRGlkQ2hhbmdlQWN0aXZlUGFuZShmbik7XHJcbiAgfVxyXG5cclxuICBvbkRpZEFkZFBhbmVJdGVtKGZuKSB7XHJcbiAgfVxyXG5cclxuICBvYnNlcnZlUGFuZUl0ZW1zKGZuKSB7XHJcbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdGhpcy5nZXRQYW5lSXRlbXMoKSkgeyBmbihpdGVtKTsgfVxyXG4gICAgcmV0dXJuIHRoaXMub25EaWRBZGRQYW5lSXRlbSgoeyBpdGVtIH0pID0+IGZuKGl0ZW0pKTtcclxuICB9XHJcblxyXG4gIG9uRGlkQ2hhbmdlQWN0aXZlUGFuZUl0ZW0oZm4pIHtcclxuICB9XHJcblxyXG4gIG9uRGlkU3RvcENoYW5naW5nQWN0aXZlUGFuZUl0ZW0oZm4pIHtcclxuICB9XHJcblxyXG4gIG9ic2VydmVBY3RpdmVQYW5lSXRlbShmbikge1xyXG4gICAgZm4odGhpcy5nZXRBY3RpdmVQYW5lSXRlbSgpKTtcclxuICAgIHJldHVybiB0aGlzLm9uRGlkQ2hhbmdlQWN0aXZlUGFuZUl0ZW0oZm4pO1xyXG4gIH1cclxuXHJcbiAgb25XaWxsRGVzdHJveVBhbmVJdGVtKGZuKSB7XHJcbiAgfVxyXG5cclxuICBvbkRpZERlc3Ryb3lQYW5lSXRlbShmbikge1xyXG4gIH1cclxuXHJcbiAgZ2V0Um9vdCgpIHsgcmV0dXJuIHRoaXMucm9vdDsgfVxyXG5cclxuICBzZXRSb290KHJvb3QpIHtcclxuICAgIHRoaXMucm9vdCA9IHJvb3Q7XHJcbiAgICB0aGlzLnJvb3Quc2V0UGFyZW50KHRoaXMpO1xyXG4gICAgdGhpcy5yb290LnNldENvbnRhaW5lcih0aGlzKTtcclxuICAgIGlmICgodGhpcy5nZXRBY3RpdmVQYW5lKCkgPT0gbnVsbCkgJiYgdGhpcy5yb290IGluc3RhbmNlb2YgUGFuZSkge1xyXG4gICAgICB0aGlzLmRpZEFjdGl2YXRlUGFuZSh0aGlzLnJvb3QpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmVwbGFjZUNoaWxkKG9sZENoaWxkLCBuZXdDaGlsZCkge1xyXG4gICAgaWYgKG9sZENoaWxkICE9PSB0aGlzLnJvb3QpIHsgdGhyb3cgbmV3IEVycm9yKCdSZXBsYWNpbmcgbm9uLWV4aXN0ZW50IGNoaWxkJyk7IH1cclxuICAgIHRoaXMuc2V0Um9vdChuZXdDaGlsZCk7XHJcbiAgfVxyXG5cclxuICBnZXRQYW5lcygpOiBQYW5lW10ge1xyXG4gICAgaWYgKHRoaXMuYWxpdmUpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZ2V0Um9vdCgpLmdldFBhbmVzKCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnZXRQYW5lSXRlbXMoKTogYW55W10ge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0Um9vdCgpLmdldEl0ZW1zKCk7XHJcbiAgfVxyXG5cclxuICBnZXRBY3RpdmVQYW5lKCk6IFBhbmUge1xyXG4gICAgcmV0dXJuIHRoaXMuYWN0aXZlUGFuZTtcclxuICB9XHJcblxyXG4gIGdldEFjdGl2ZVBhbmVJdGVtKCk6IGFueSB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRBY3RpdmVQYW5lKCkuZ2V0QWN0aXZlSXRlbSgpO1xyXG4gIH1cclxuXHJcbiAgcGFuZUZvclVSSSh1cmkpOiBQYW5lIHtcclxuICAgIHJldHVybiB0aGlzLmdldFBhbmVzKCkuZmluZChwYW5lID0+IHBhbmUuaXRlbUZvclVSSSh1cmkpICE9IG51bGwpO1xyXG4gIH1cclxuXHJcbiAgcGFuZUZvckl0ZW0oaXRlbSk6IFBhbmUge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0UGFuZXMoKS5maW5kKHBhbmUgPT4gcGFuZS5nZXRJdGVtcygpLmZpbmQoaXQgPT4gaXQgPT09IGl0ZW0pKTtcclxuICB9XHJcblxyXG4gIHNhdmVBbGwoKSB7XHJcbiAgICBmb3IgKGNvbnN0IHBhbmUgb2YgdGhpcy5nZXRQYW5lcygpKSB7IHBhbmUuc2F2ZUl0ZW1zKCk7IH1cclxuICB9XHJcblxyXG4gIGNvbmZpcm1DbG9zZShvcHRpb25zKSB7XHJcbiAgICBjb25zdCBwcm9taXNlcyA9IFtdO1xyXG4gICAgZm9yIChjb25zdCBwYW5lIG9mIHRoaXMuZ2V0UGFuZXMoKSkge1xyXG4gICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgcGFuZS5nZXRJdGVtcygpKSB7XHJcbiAgICAgICAgcHJvbWlzZXMucHVzaChwYW5lLnByb21wdFRvU2F2ZUl0ZW0oaXRlbSwgb3B0aW9ucykpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpLnRoZW4oKHJlc3VsdHM6IGJvb2xlYW5bXSkgPT4gIXJlc3VsdHMuZmluZChpdGVtID0+IGl0ZW0gPT09IGZhbHNlKSk7XHJcbiAgfVxyXG5cclxuICBhY3RpdmF0ZU5leHRQYW5lKCkge1xyXG4gICAgY29uc3QgcGFuZXMgPSB0aGlzLmdldFBhbmVzKCk7XHJcbiAgICBpZiAocGFuZXMubGVuZ3RoID4gMSkge1xyXG4gICAgICBjb25zdCBjdXJyZW50SW5kZXggPSBwYW5lcy5pbmRleE9mKHRoaXMuYWN0aXZlUGFuZSk7XHJcbiAgICAgIGNvbnN0IG5leHRJbmRleCA9IChjdXJyZW50SW5kZXggKyAxKSAlIHBhbmVzLmxlbmd0aDtcclxuICAgICAgcGFuZXNbbmV4dEluZGV4XS5hY3RpdmF0ZSgpO1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFjdGl2YXRlUHJldmlvdXNQYW5lKCkge1xyXG4gICAgY29uc3QgcGFuZXMgPSB0aGlzLmdldFBhbmVzKCk7XHJcbiAgICBpZiAocGFuZXMubGVuZ3RoID4gMSkge1xyXG4gICAgICBjb25zdCBjdXJyZW50SW5kZXggPSBwYW5lcy5pbmRleE9mKHRoaXMuYWN0aXZlUGFuZSk7XHJcbiAgICAgIGxldCBwcmV2aW91c0luZGV4ID0gY3VycmVudEluZGV4IC0gMTtcclxuICAgICAgaWYgKHByZXZpb3VzSW5kZXggPCAwKSB7IHByZXZpb3VzSW5kZXggPSBwYW5lcy5sZW5ndGggLSAxOyB9XHJcbiAgICAgIHBhbmVzW3ByZXZpb3VzSW5kZXhdLmFjdGl2YXRlKCk7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbW92ZUFjdGl2ZUl0ZW1Ub1BhbmUoZGVzdFBhbmUpIHtcclxuICAgIGNvbnN0IGl0ZW0gPSB0aGlzLmFjdGl2ZVBhbmUuZ2V0QWN0aXZlSXRlbSgpO1xyXG5cclxuICAgIGlmICghZGVzdFBhbmUuaXNJdGVtQWxsb3dlZChpdGVtKSkgeyByZXR1cm47IH1cclxuXHJcbiAgICB0aGlzLmFjdGl2ZVBhbmUubW92ZUl0ZW1Ub1BhbmUoaXRlbSwgZGVzdFBhbmUpO1xyXG4gICAgZGVzdFBhbmUuc2V0QWN0aXZlSXRlbShpdGVtKTtcclxuICB9XHJcblxyXG4gIGNvcHlBY3RpdmVJdGVtVG9QYW5lKGRlc3RQYW5lKSB7XHJcbiAgICBjb25zdCBpdGVtID0gdGhpcy5hY3RpdmVQYW5lLmNvcHlBY3RpdmVJdGVtKCk7XHJcblxyXG4gICAgaWYgKGl0ZW0gJiYgZGVzdFBhbmUuaXNJdGVtQWxsb3dlZChpdGVtKSkge1xyXG4gICAgICBkZXN0UGFuZS5hY3RpdmF0ZUl0ZW0oaXRlbSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkZXN0cm95RW1wdHlQYW5lcygpIHtcclxuICAgIGZvciAoY29uc3QgcGFuZSBvZiB0aGlzLmdldFBhbmVzKCkpIHsgaWYgKHBhbmUuaXRlbXMubGVuZ3RoID09PSAwKSB7IHBhbmUuZGVzdHJveSgpOyB9IH1cclxuICB9XHJcblxyXG4gIGRpZEFkZFBhbmUoZXZlbnQpIHtcclxuICAgIGNvbnN0IGl0ZW1zID0gZXZlbnQucGFuZS5nZXRJdGVtcygpO1xyXG4gICAgZm9yIChsZXQgaSA9IDAsIGxlbmd0aCA9IGl0ZW1zLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGNvbnN0IGl0ZW0gPSBpdGVtc1tpXTtcclxuICAgICAgdGhpcy5kaWRBZGRQYW5lSXRlbShpdGVtLCBldmVudC5wYW5lLCBpKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHdpbGxEZXN0cm95UGFuZShldmVudCkge1xyXG4gIH1cclxuXHJcbiAgZGlkRGVzdHJveVBhbmUoZXZlbnQpIHtcclxuICB9XHJcblxyXG4gIGRpZEFjdGl2YXRlUGFuZShhY3RpdmVQYW5lKSB7XHJcbiAgICBpZiAoYWN0aXZlUGFuZSAhPT0gdGhpcy5hY3RpdmVQYW5lKSB7XHJcbiAgICAgIGlmICghdGhpcy5nZXRQYW5lcygpLmZpbmQoaXRlbSA9PiBpdGVtID09PSBhY3RpdmVQYW5lKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignU2V0dGluZyBhY3RpdmUgcGFuZSB0aGF0IGlzIG5vdCBwcmVzZW50IGluIHBhbmUgY29udGFpbmVyJyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMuYWN0aXZlUGFuZSA9IGFjdGl2ZVBhbmU7XHJcbiAgICAgIHRoaXMuZGlkQ2hhbmdlQWN0aXZlSXRlbU9uUGFuZSh0aGlzLmFjdGl2ZVBhbmUsIHRoaXMuYWN0aXZlUGFuZS5nZXRBY3RpdmVJdGVtKCkpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuYWN0aXZlUGFuZTtcclxuICB9XHJcblxyXG4gIGRpZEFkZFBhbmVJdGVtKGl0ZW0sIHBhbmUsIGluZGV4KSB7XHJcbiAgICB0aGlzLml0ZW1SZWdpc3RyeS5hZGRJdGVtKGl0ZW0pO1xyXG4gIH1cclxuXHJcbiAgd2lsbERlc3Ryb3lQYW5lSXRlbShldmVudCkge1xyXG4gIH1cclxuXHJcbiAgZGlkRGVzdHJveVBhbmVJdGVtKGV2ZW50KSB7XHJcbiAgICB0aGlzLml0ZW1SZWdpc3RyeS5yZW1vdmVJdGVtKGV2ZW50Lml0ZW0pO1xyXG4gICAgLy8gdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1kZXN0cm95LXBhbmUtaXRlbScsIGV2ZW50KTtcclxuICB9XHJcblxyXG4gIGRpZENoYW5nZUFjdGl2ZUl0ZW1PblBhbmUocGFuZSwgYWN0aXZlSXRlbSkge1xyXG4gICAgaWYgKHBhbmUgPT09IHRoaXMuZ2V0QWN0aXZlUGFuZSgpKSB7XHJcblxyXG4gICAgICB0aGlzLmNhbmNlbFN0b3BwZWRDaGFuZ2luZ0FjdGl2ZVBhbmVJdGVtVGltZW91dCgpO1xyXG4gICAgICAvLyBgc2V0VGltZW91dCgpYCBpc24ndCBhdmFpbGFibGUgZHVyaW5nIHRoZSBzbmFwc2hvdHRpbmcgcGhhc2UsIGJ1dCB0aGF0J3Mgb2theS5cclxuXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjYW5jZWxTdG9wcGVkQ2hhbmdpbmdBY3RpdmVQYW5lSXRlbVRpbWVvdXQoKSB7XHJcblxyXG4gIH1cclxufVxyXG4iXX0=