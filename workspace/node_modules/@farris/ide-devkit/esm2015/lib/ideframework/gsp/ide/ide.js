/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ModalFrm } from './modal-frm';
import { forkJoin, Observable, of } from 'rxjs';
import { map } from 'rxjs/operators';
/**
 * 提供ide运行所需的方法，供插件使用
 */
export class Ide {
    /**
     * @private
     * @return {?}
     */
    get isTop() {
        return window.top === window;
    }
    /**
     * @private
     * @template THIS
     * @this {THIS}
     * @return {THIS}
     */
    get parentInstance() {
        /** @type {?} */
        let instance = (/** @type {?} */ (this));
        /** @type {?} */
        const top = window.top;
        if (top && top['gsp']) {
            instance = top['gsp'].ide;
        }
        return instance;
    }
    /**
     * @return {?}
     */
    get messager() {
        return this.msgr;
    }
    /**
     * @param {?=} parent
     */
    constructor(parent) {
        this.events = new Map();
        this.modal = new ModalFrm();
        this.frameId = this.getParam('frameID');
        if (this.isTop) {
            this.commandData = new Map();
        }
        if (parent) {
            this.msgr = parent.messager;
        }
    }
    /* #region  frame util */
    /**
     * @param {?} key
     * @return {?}
     */
    getParam(key) {
        /** @type {?} */
        const params = new URLSearchParams(window.location.search);
        return unescape(params.get(key));
    }
    /**
     * @param {?=} frameId
     * @return {?}
     */
    getInitCommandData(frameId) {
        if (!this.isTop) {
            frameId = frameId || this.frameId;
            return this.parentInstance.getInitCommandData(frameId);
        }
        else {
            return this.commandData.get(frameId);
        }
    }
    /**
     * @param {?} frameId
     * @param {?} data
     * @return {?}
     */
    setInitCommandData(frameId, data) {
        if (!this.isTop) {
            this.parentInstance.setInitCommandData(frameId, data);
        }
        else {
            this.commandData.set(frameId, data);
        }
    }
    /**
     * @param {?} messager
     * @return {?}
     */
    setMessager(messager) {
        this.msgr = messager;
    }
    /* #endregion */
    /* #region  event */
    /**
     * @param {?} cb
     * @return {?}
     */
    onPanelAdded(cb) {
        this.on('panel-added', cb);
    }
    /**
     * @param {?} cb
     * @return {?}
     */
    onPanelRemoved(cb) {
        this.on('panel-removed', cb);
    }
    /**
     * @param {?} cb
     * @return {?}
     */
    onPanelShown(cb) {
        this.on('panel-shown', cb);
    }
    /**
     * @param {?} cb
     * @return {?}
     */
    onPanelHidden(cb) {
        this.on('panel-hidden', cb);
    }
    /**
     * @param {?} cb
     * @return {?}
     */
    onModalConfirming(cb) {
        if (this.parentInstance !== this) {
            this.parentInstance.onModalConfirming(cb);
        }
        else {
            this.on('confirm-modal', cb);
        }
    }
    /**
     * @param {?} cb
     * @return {?}
     */
    onModalCancelling(cb) {
        this.on('cancel-modal', cb);
    }
    /**
     * @param {?} cb
     * @return {?}
     */
    onLeftActivated(cb) {
        if (this.isTop) {
            this.on('activate-left', cb);
        }
        else {
            this.parentInstance.onLeftActivated(cb);
        }
    }
    /**
     * @param {?} cb
     * @return {?}
     */
    onNotifyShown(cb) {
        this.on('show-notify', cb);
    }
    /**
     * @param {?} cb
     * @return {?}
     */
    onLoadingShown(cb) {
        this.on('show-loading', cb);
    }
    /**
     * @param {?} cb
     * @return {?}
     */
    onLoadingHidden(cb) {
        this.on('hide-loading', cb);
    }
    /**
     * @param {?} cb
     * @return {?}
     */
    onDesignerStatusSet(cb) {
        this.on('set-designer-status', cb);
    }
    // onBeforeClose(id: string, cb: () => boolean) {
    //   this.on('on-before-close', ({metadataId}) => {
    //     if (id === metadataId) {
    //       return cb();
    //     }
    //     return true;
    //   });
    // }
    /**
     * @param {?} id
     * @param {?} cb
     * @return {?}
     */
    onCloseTab(id, cb) {
        if (!this.isTop) {
            return this.parentInstance.onCloseTab(id, cb);
        }
        this.on('close-tab', tabId => {
            if (id === tabId) {
                return cb();
            }
            return true;
        });
    }
    /* #endregion */
    /* #region  panel */
    /**
     * @param {?} options
     * @return {?}
     */
    addPanel(options) {
        this.emit('panel-added', options);
    }
    /* #endregion */
    /* #region  modal */
    /**
     * @param {?} options
     * @return {?}
     */
    addModal(options) {
        this.emit('panel-added', options, 'modal');
    }
    /**
     * @param {?=} id
     * @return {?}
     */
    closeModal(id) {
        if (this.parentInstance !== this) {
            this.parentInstance.closeModal(id);
        }
        this.emit('panel-removed', id, 'modal');
    }
    /**
     * @param {?} id
     * @return {?}
     */
    confirmModal(id) {
        /** @type {?} */
        let result = true;
        // if (this.parentInstance !== this) {
        //   result = this.parentInstance.confirmModal(id);
        // }
        result = result && (/** @type {?} */ (this.emit('confirm-modal', id)));
        return result;
    }
    /**
     * @param {?} id
     * @return {?}
     */
    cancelModal(id) {
        /** @type {?} */
        let result = true;
        if (this.parentInstance !== this) {
            result = this.parentInstance.cancelModal(id);
        }
        result = result && (/** @type {?} */ (this.emit('cancel-modal', id)));
        return result;
    }
    // addLeft    registryOpener....
    /* #endregion */
    /* #region  left rigion */
    /**
     * @param {?=} frameId
     * @return {?}
     */
    activateLeft(frameId) {
        frameId = frameId || this.frameId;
        if (this.isTop) {
            this.emit('activate-left', frameId);
        }
        else {
            this.parentInstance.activateLeft(frameId);
        }
    }
    /* #endregion */
    /**
     * @param {?} level
     * @param {?} content
     * @return {?}
     */
    notify(level, content) {
        if (this.isTop) {
            this.emit('show-notify', level, content);
        }
        else {
            this.parentInstance.notify(level, content);
        }
    }
    /**
     * @param {?=} message
     * @return {?}
     */
    loading(message) {
        if (this.isTop) {
            this.emit('show-loading', message);
        }
        else {
            this.parentInstance.loading(message);
        }
    }
    /**
     * @return {?}
     */
    loaded() {
        if (this.isTop) {
            this.emit('hide-loading');
        }
        else {
            this.parentInstance.loaded();
        }
    }
    /**
     * @param {?} metadataId
     * @param {?} isDirty
     * @return {?}
     */
    setDesignerStatus(metadataId, isDirty) {
        if (this.isTop) {
            this.emit('set-designer-status', { id: metadataId, isDirty });
        }
        else {
            this.parentInstance.setDesignerStatus(metadataId, isDirty);
        }
    }
    // closeDesigner(metadataId: string) {
    //   if (this.isTop) {
    //     this.emit('close-designer', {id: metadataId});
    //   } else {
    //     this.parentInstance.closeDesigner(metadataId);
    //   }
    // }
    /**
     * @param {?} id
     * @return {?}
     */
    notifyCloseTab(id) {
        if (!this.isTop) {
            return this.parentInstance.notifyCloseTab(id);
        }
        /** @type {?} */
        const result = this.emit('close-tab', id);
        if (result == null) {
            return of(true);
        }
        else if (typeof result === 'boolean') {
            return of(result);
        }
        else {
            return result;
        }
    }
    /**
     * @param {?} workspace
     * @return {?}
     */
    registerIDE(workspace) {
        // 用来把ide view实例与gsp对象绑定。
        // TODO： view实例监听gsp对象的操作放在这里。
        if (typeof workspace.onCloseDesigner === 'function') {
            this.on('close-designer', workspace.onCloseDesigner.bind(workspace));
        }
    }
    /* #region  private method */
    /**
     * @private
     * @param {?} name
     * @param {?} cb
     * @return {?}
     */
    on(name, cb) {
        /** @type {?} */
        let callbacks = this.events.get(name);
        if (!callbacks) {
            callbacks = [cb];
            this.events.set(name, callbacks);
        }
        else {
            callbacks.push(cb);
        }
    }
    /**
     * @private
     * @param {?} name
     * @param {...?} params
     * @return {?}
     */
    emit(name, ...params) {
        /** @type {?} */
        const callbacks = this.events.get(name);
        if (!callbacks || !callbacks.length) {
            return;
        }
        /** @type {?} */
        let result = true;
        /** @type {?} */
        const observableResult = new Array();
        for (const cb of callbacks) {
            /** @type {?} */
            const cbResult = cb(...params);
            if (cbResult == null) {
                continue;
            }
            if (typeof cbResult === 'boolean') {
                result = result && cbResult;
            }
            else if (typeof cbResult.subscribe === 'function' && cbResult.constructor.name === Observable.name) {
                // 判断条件不能使用cbResult instanceof Observable,因为cb可能是来自于不同的iframe环境，导致跟这里的Observable构造函数不一样。
                observableResult.push(cbResult);
            }
        }
        if (observableResult.length) {
            return forkJoin([...observableResult, of(result)]).pipe(map(results => {
                return results.reduce((previous, current) => previous && current);
            }));
        }
        else {
            return result;
        }
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    Ide.prototype.frameId;
    /**
     * @type {?}
     * @private
     */
    Ide.prototype.events;
    /**
     * @type {?}
     * @private
     */
    Ide.prototype.modal;
    /**
     * @type {?}
     * @private
     */
    Ide.prototype.commandData;
    /**
     * @type {?}
     * @private
     */
    Ide.prototype.msgr;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9pZGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2lkZWZyYW1ld29yay9nc3AvaWRlL2lkZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQ0EsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUV2QyxPQUFPLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDaEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBUXJDLE1BQU0sT0FBTyxHQUFHOzs7OztJQU1kLElBQVksS0FBSztRQUNmLE9BQU8sTUFBTSxDQUFDLEdBQUcsS0FBSyxNQUFNLENBQUM7SUFDL0IsQ0FBQzs7Ozs7OztJQUNELElBQVksY0FBYzs7WUFDcEIsUUFBUSxHQUFHLG1CQUFBLElBQUksRUFBQTs7Y0FDYixHQUFHLEdBQUcsTUFBTSxDQUFDLEdBQUc7UUFDdEIsSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3JCLFFBQVEsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDO1NBQzNCO1FBQ0QsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQzs7OztJQUVELElBQUksUUFBUTtRQUNWLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUNuQixDQUFDOzs7O0lBRUQsWUFBWSxNQUFZO1FBQ3RCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxHQUFHLEVBQWlCLENBQUM7UUFDdkMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLFFBQVEsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN4QyxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDZCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksR0FBRyxFQUFl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QU0sSUFBSSxRQUFRLENBQUM7YUFDN0I7aUJBQU0sSUFBSSxPQUFPLFFBQVEsQ0FBQyxTQUFTLEtBQUssVUFBVSxJQUFJLFFBQVEsQ0FBQyxXQUFXLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxJQUFJLEVBQUU7Z0JBQ3BHLHdGQUF3RjtnQkFDeEYsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ2pDO1NBQ0Y7UUFFRCxJQUFJLGdCQUFnQixDQUFDLE1BQU0sRUFBRTtZQUMzQixPQUFPLFFBQVEsQ0FBQyxDQUFDLEdBQUcsZ0JBQWdCLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNwRSxPQUFPLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FBQyxRQUFRLElBQUksT0FBTyxDQUFDLENBQUM7WUFDcEUsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNMO2FBQU07WUFDTCxPQUFPLE1BQU0sQ0FBQztTQUNmO0lBRUgsQ0FBQztDQUVGOzs7Ozs7SUFyU0Msc0JBQXdCOzs7OztJQUN4QixxQkFBbUM7Ozs7O0lBQ25DLG9CQUF3Qjs7Ozs7SUFDeEIsMEJBQXNDOzs7OztJQUN0QyxtQkFBdUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNZXNzYWdlciB9IGZyb20gJy4vbWVzc2FnZXInO1xyXG5pbXBvcnQgeyBNb2RhbEZybSB9IGZyb20gJy4vbW9kYWwtZnJtJztcclxuaW1wb3J0IHsgTm90aWZ5T3B0aW9ucyB9IGZyb20gJ0BmYXJyaXMvdWktbm90aWZ5JztcclxuaW1wb3J0IHsgZm9ya0pvaW4sIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcblxyXG5cclxuLyoqXHJcbiAqIOaPkOS+m2lkZei/kOihjOaJgOmcgOeahOaWueazle+8jOS+m+aPkuS7tuS9v+eUqFxyXG4gKi9cclxuXHJcbmV4cG9ydCBjbGFzcyBJZGUge1xyXG4gIHByaXZhdGUgZnJhbWVJZDogc3RyaW5nO1xyXG4gIHByaXZhdGUgZXZlbnRzOiBNYXA8c3RyaW5nLCBhbnlbXT47XHJcbiAgcHJpdmF0ZSBtb2RhbDogTW9kYWxGcm07XHJcbiAgcHJpdmF0ZSBjb21tYW5kRGF0YTogTWFwPHN0cmluZywgYW55PjtcclxuICBwcml2YXRlIG1zZ3I6IE1lc3NhZ2VyO1xyXG4gIHByaXZhdGUgZ2V0IGlzVG9wKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHdpbmRvdy50b3AgPT09IHdpbmRvdztcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXQgcGFyZW50SW5zdGFuY2UoKSB7XHJcbiAgICBsZXQgaW5zdGFuY2UgPSB0aGlzO1xyXG4gICAgY29uc3QgdG9wID0gd2luZG93LnRvcDtcclxuICAgIGlmICh0b3AgJiYgdG9wWydnc3AnXSkge1xyXG4gICAgICBpbnN0YW5jZSA9IHRvcFsnZ3NwJ10uaWRlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGluc3RhbmNlO1xyXG4gIH1cclxuXHJcbiAgZ2V0IG1lc3NhZ2VyKCk6IE1lc3NhZ2VyIHtcclxuICAgIHJldHVybiB0aGlzLm1zZ3I7XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3RvcihwYXJlbnQ/OiBJZGUpIHtcclxuICAgIHRoaXMuZXZlbnRzID0gbmV3IE1hcDxzdHJpbmcsIGFueVtdPigpO1xyXG4gICAgdGhpcy5tb2RhbCA9IG5ldyBNb2RhbEZybSgpO1xyXG4gICAgdGhpcy5mcmFtZUlkID0gdGhpcy5nZXRQYXJhbSgnZnJhbWVJRCcpO1xyXG4gICAgaWYgKHRoaXMuaXNUb3ApIHtcclxuICAgICAgdGhpcy5jb21tYW5kRGF0YSA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcbiAgICB9XHJcbiAgICBpZiAocGFyZW50KSB7XHJcbiAgICAgIHRoaXMubXNnciA9ICBwYXJlbnQubWVzc2FnZXI7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKiAjcmVnaW9uICBmcmFtZSB1dGlsICovXHJcbiAgZ2V0UGFyYW0oa2V5OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHBhcmFtcyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCk7XHJcbiAgICByZXR1cm4gdW5lc2NhcGUocGFyYW1zLmdldChrZXkpKTtcclxuICB9XHJcblxyXG4gIGdldEluaXRDb21tYW5kRGF0YShmcmFtZUlkPzogc3RyaW5nKTogYW55IHtcclxuICAgIGlmICghdGhpcy5pc1RvcCkge1xyXG4gICAgICBmcmFtZUlkID0gZnJhbWVJZCB8fCB0aGlzLmZyYW1lSWQ7XHJcbiAgICAgIHJldHVybiB0aGlzLnBhcmVudEluc3RhbmNlLmdldEluaXRDb21tYW5kRGF0YShmcmFtZUlkKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmNvbW1hbmREYXRhLmdldChmcmFtZUlkKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNldEluaXRDb21tYW5kRGF0YShmcmFtZUlkOiBzdHJpbmcsIGRhdGE6IGFueSkge1xyXG4gICAgaWYgKCF0aGlzLmlzVG9wKSB7XHJcbiAgICAgIHRoaXMucGFyZW50SW5zdGFuY2Uuc2V0SW5pdENvbW1hbmREYXRhKGZyYW1lSWQsIGRhdGEpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5jb21tYW5kRGF0YS5zZXQoZnJhbWVJZCwgZGF0YSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzZXRNZXNzYWdlcihtZXNzYWdlcjogTWVzc2FnZXIpIHtcclxuICAgIHRoaXMubXNnciA9IG1lc3NhZ2VyO1xyXG4gIH1cclxuICAvKiAjZW5kcmVnaW9uICovXHJcblxyXG4gIC8qICNyZWdpb24gIGV2ZW50ICovXHJcbiAgb25QYW5lbEFkZGVkKGNiOiAob3B0aW9uczogYW55LCBsb2NhdGlvbj86IHN0cmluZykgPT4gYW55KSB7XHJcbiAgICB0aGlzLm9uKCdwYW5lbC1hZGRlZCcsIGNiKTtcclxuICB9XHJcblxyXG4gIG9uUGFuZWxSZW1vdmVkKGNiOiAoaWQ6IHN0cmluZywgbGFjYXRpb246IHN0cmluZykgPT4gYW55KSB7XHJcbiAgICB0aGlzLm9uKCdwYW5lbC1yZW1vdmVkJywgY2IpO1xyXG4gIH1cclxuXHJcbiAgb25QYW5lbFNob3duKGNiOiAoaWQ6IHN0cmluZykgPT4gYW55KSB7XHJcbiAgICB0aGlzLm9uKCdwYW5lbC1zaG93bicsIGNiKTtcclxuICB9XHJcblxyXG4gIG9uUGFuZWxIaWRkZW4oY2I6IChpZDogc3RyaW5nKSA9PiBhbnkpIHtcclxuICAgIHRoaXMub24oJ3BhbmVsLWhpZGRlbicsIGNiKTtcclxuICB9XHJcblxyXG4gIG9uTW9kYWxDb25maXJtaW5nKGNiOiAoaWQ6IHN0cmluZykgPT4gYm9vbGVhbikge1xyXG4gICAgaWYgKHRoaXMucGFyZW50SW5zdGFuY2UgIT09IHRoaXMpIHtcclxuICAgICAgdGhpcy5wYXJlbnRJbnN0YW5jZS5vbk1vZGFsQ29uZmlybWluZyhjYik7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLm9uKCdjb25maXJtLW1vZGFsJywgY2IpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgb25Nb2RhbENhbmNlbGxpbmcoY2I6IChpZDogc3RyaW5nKSA9PiBib29sZWFuKSB7XHJcbiAgICB0aGlzLm9uKCdjYW5jZWwtbW9kYWwnLCBjYik7XHJcbiAgfVxyXG5cclxuICBvbkxlZnRBY3RpdmF0ZWQoY2I6IChpZDogc3RyaW5nKSA9PiBhbnkpIHtcclxuICAgIGlmICh0aGlzLmlzVG9wKSB7XHJcbiAgICAgIHRoaXMub24oJ2FjdGl2YXRlLWxlZnQnLCBjYik7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnBhcmVudEluc3RhbmNlLm9uTGVmdEFjdGl2YXRlZChjYik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBvbk5vdGlmeVNob3duKGNiOiAobGV2ZWw6ICdlcnJvcicgfCAnd2FybmluZycgfCAnaW5mbycsIGNvbnRlbnQ6IHN0cmluZyB8IE5vdGlmeU9wdGlvbnMpID0+IGFueSkge1xyXG4gICAgdGhpcy5vbignc2hvdy1ub3RpZnknLCBjYik7XHJcbiAgfVxyXG5cclxuICBvbkxvYWRpbmdTaG93bihjYjogKG1lc3NhZ2U/OiBzdHJpbmcpID0+IGFueSkge1xyXG4gICAgdGhpcy5vbignc2hvdy1sb2FkaW5nJywgY2IpO1xyXG4gIH1cclxuXHJcbiAgb25Mb2FkaW5nSGlkZGVuKGNiOiAoKSA9PiBhbnkpIHtcclxuICAgIHRoaXMub24oJ2hpZGUtbG9hZGluZycsIGNiKTtcclxuICB9XHJcblxyXG4gIG9uRGVzaWduZXJTdGF0dXNTZXQoY2I6IChhcmdzKSA9PiBhbnkpIHtcclxuICAgIHRoaXMub24oJ3NldC1kZXNpZ25lci1zdGF0dXMnLCBjYik7XHJcbiAgfVxyXG5cclxuICAvLyBvbkJlZm9yZUNsb3NlKGlkOiBzdHJpbmcsIGNiOiAoKSA9PiBib29sZWFuKSB7XHJcbiAgLy8gICB0aGlzLm9uKCdvbi1iZWZvcmUtY2xvc2UnLCAoe21ldGFkYXRhSWR9KSA9PiB7XHJcbiAgLy8gICAgIGlmIChpZCA9PT0gbWV0YWRhdGFJZCkge1xyXG4gIC8vICAgICAgIHJldHVybiBjYigpO1xyXG4gIC8vICAgICB9XHJcbiAgLy8gICAgIHJldHVybiB0cnVlO1xyXG4gIC8vICAgfSk7XHJcbiAgLy8gfVxyXG5cclxuICBvbkNsb3NlVGFiKGlkOiBzdHJpbmcsIGNiOiAoKSA9PiBib29sZWFuIHwgT2JzZXJ2YWJsZTxib29sZWFuPikge1xyXG4gICAgaWYgKCF0aGlzLmlzVG9wKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnBhcmVudEluc3RhbmNlLm9uQ2xvc2VUYWIoaWQsIGNiKTtcclxuICAgIH1cclxuICAgIHRoaXMub24oJ2Nsb3NlLXRhYicsIHRhYklkID0+IHtcclxuICAgICAgaWYgKGlkID09PSB0YWJJZCkge1xyXG4gICAgICAgIHJldHVybiBjYigpO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qICNlbmRyZWdpb24gKi9cclxuXHJcblxyXG4gIC8qICNyZWdpb24gIHBhbmVsICovXHJcbiAgYWRkUGFuZWwob3B0aW9uczogYW55KSB7XHJcbiAgICB0aGlzLmVtaXQoJ3BhbmVsLWFkZGVkJywgb3B0aW9ucyk7XHJcbiAgfVxyXG4gIC8qICNlbmRyZWdpb24gKi9cclxuXHJcbiAgLyogI3JlZ2lvbiAgbW9kYWwgKi9cclxuICBhZGRNb2RhbChvcHRpb25zOiBhbnkpIHtcclxuICAgIHRoaXMuZW1pdCgncGFuZWwtYWRkZWQnLCBvcHRpb25zLCAnbW9kYWwnKTtcclxuICB9XHJcblxyXG4gIGNsb3NlTW9kYWwoaWQ/OiBzdHJpbmcpIHtcclxuICAgIGlmICh0aGlzLnBhcmVudEluc3RhbmNlICE9PSB0aGlzKSB7XHJcbiAgICAgIHRoaXMucGFyZW50SW5zdGFuY2UuY2xvc2VNb2RhbChpZCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmVtaXQoJ3BhbmVsLXJlbW92ZWQnLCBpZCwgJ21vZGFsJyk7XHJcbiAgfVxyXG5cclxuICBjb25maXJtTW9kYWwoaWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgbGV0IHJlc3VsdCA9IHRydWU7XHJcbiAgICAvLyBpZiAodGhpcy5wYXJlbnRJbnN0YW5jZSAhPT0gdGhpcykge1xyXG4gICAgLy8gICByZXN1bHQgPSB0aGlzLnBhcmVudEluc3RhbmNlLmNvbmZpcm1Nb2RhbChpZCk7XHJcbiAgICAvLyB9XHJcbiAgICByZXN1bHQgPSByZXN1bHQgJiYgdGhpcy5lbWl0KCdjb25maXJtLW1vZGFsJywgaWQpIGFzIGJvb2xlYW47XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgY2FuY2VsTW9kYWwoaWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgbGV0IHJlc3VsdCA9IHRydWU7XHJcbiAgICBpZiAodGhpcy5wYXJlbnRJbnN0YW5jZSAhPT0gdGhpcykge1xyXG4gICAgICByZXN1bHQgPSB0aGlzLnBhcmVudEluc3RhbmNlLmNhbmNlbE1vZGFsKGlkKTtcclxuICAgIH1cclxuICAgIHJlc3VsdCA9IHJlc3VsdCAmJiB0aGlzLmVtaXQoJ2NhbmNlbC1tb2RhbCcsIGlkKSBhcyBib29sZWFuO1xyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcblxyXG4gIC8vIGFkZExlZnQgICAgcmVnaXN0cnlPcGVuZXIuLi4uXHJcbiAgLyogI2VuZHJlZ2lvbiAqL1xyXG5cclxuICAvKiAjcmVnaW9uICBsZWZ0IHJpZ2lvbiAqL1xyXG5cclxuICBhY3RpdmF0ZUxlZnQoZnJhbWVJZD86IHN0cmluZykge1xyXG4gICAgZnJhbWVJZCA9IGZyYW1lSWQgfHwgdGhpcy5mcmFtZUlkO1xyXG4gICAgaWYgKHRoaXMuaXNUb3ApIHtcclxuICAgICAgdGhpcy5lbWl0KCdhY3RpdmF0ZS1sZWZ0JywgZnJhbWVJZCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnBhcmVudEluc3RhbmNlLmFjdGl2YXRlTGVmdChmcmFtZUlkKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyogI2VuZHJlZ2lvbiAqL1xyXG5cclxuICBub3RpZnkobGV2ZWw6ICdlcnJvcicgfCAnd2FybmluZycgfCAnaW5mbycsIGNvbnRlbnQ6IHN0cmluZyB8IE5vdGlmeU9wdGlvbnMpIHtcclxuICAgIGlmICh0aGlzLmlzVG9wKSB7XHJcbiAgICAgIHRoaXMuZW1pdCgnc2hvdy1ub3RpZnknLCBsZXZlbCwgY29udGVudCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnBhcmVudEluc3RhbmNlLm5vdGlmeShsZXZlbCwgY29udGVudCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBsb2FkaW5nKG1lc3NhZ2U/OiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmlzVG9wKSB7XHJcbiAgICAgIHRoaXMuZW1pdCgnc2hvdy1sb2FkaW5nJywgbWVzc2FnZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnBhcmVudEluc3RhbmNlLmxvYWRpbmcobWVzc2FnZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBsb2FkZWQoKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5pc1RvcCkge1xyXG4gICAgICB0aGlzLmVtaXQoJ2hpZGUtbG9hZGluZycpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5wYXJlbnRJbnN0YW5jZS5sb2FkZWQoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNldERlc2lnbmVyU3RhdHVzKG1ldGFkYXRhSWQ6IHN0cmluZywgaXNEaXJ0eTogYm9vbGVhbikge1xyXG4gICAgaWYgKHRoaXMuaXNUb3ApIHtcclxuICAgICAgdGhpcy5lbWl0KCdzZXQtZGVzaWduZXItc3RhdHVzJywge2lkOiBtZXRhZGF0YUlkLCBpc0RpcnR5fSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnBhcmVudEluc3RhbmNlLnNldERlc2lnbmVyU3RhdHVzKG1ldGFkYXRhSWQsIGlzRGlydHkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gY2xvc2VEZXNpZ25lcihtZXRhZGF0YUlkOiBzdHJpbmcpIHtcclxuICAvLyAgIGlmICh0aGlzLmlzVG9wKSB7XHJcbiAgLy8gICAgIHRoaXMuZW1pdCgnY2xvc2UtZGVzaWduZXInLCB7aWQ6IG1ldGFkYXRhSWR9KTtcclxuICAvLyAgIH0gZWxzZSB7XHJcbiAgLy8gICAgIHRoaXMucGFyZW50SW5zdGFuY2UuY2xvc2VEZXNpZ25lcihtZXRhZGF0YUlkKTtcclxuICAvLyAgIH1cclxuICAvLyB9XHJcblxyXG4gIG5vdGlmeUNsb3NlVGFiKGlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIGlmICghdGhpcy5pc1RvcCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5wYXJlbnRJbnN0YW5jZS5ub3RpZnlDbG9zZVRhYihpZCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5lbWl0KCdjbG9zZS10YWInLCBpZCk7XHJcbiAgICBpZiAocmVzdWx0ID09IG51bGwpIHtcclxuICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgfSBlbHNlIGlmICh0eXBlb2YgcmVzdWx0ID09PSAnYm9vbGVhbicpIHtcclxuICAgICAgcmV0dXJuIG9mIChyZXN1bHQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJlZ2lzdGVySURFKHdvcmtzcGFjZTogYW55KSB7XHJcbiAgICAvLyDnlKjmnaXmioppZGUgdmlld+WunuS+i+S4jmdzcOWvueixoee7keWumuOAglxyXG4gICAgLy8gVE9ET++8miB2aWV35a6e5L6L55uR5ZCsZ3Nw5a+56LGh55qE5pON5L2c5pS+5Zyo6L+Z6YeM44CCXHJcblxyXG4gICAgaWYgKHR5cGVvZiB3b3Jrc3BhY2Uub25DbG9zZURlc2lnbmVyID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIHRoaXMub24oJ2Nsb3NlLWRlc2lnbmVyJywgd29ya3NwYWNlLm9uQ2xvc2VEZXNpZ25lci5iaW5kKHdvcmtzcGFjZSkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyogI3JlZ2lvbiAgcHJpdmF0ZSBtZXRob2QgKi9cclxuICBwcml2YXRlIG9uKG5hbWU6IHN0cmluZywgY2I6IGFueSkge1xyXG4gICAgbGV0IGNhbGxiYWNrcyA9IHRoaXMuZXZlbnRzLmdldChuYW1lKTtcclxuICAgIGlmICghY2FsbGJhY2tzKSB7XHJcbiAgICAgIGNhbGxiYWNrcyA9IFtjYl07XHJcbiAgICAgIHRoaXMuZXZlbnRzLnNldChuYW1lLCBjYWxsYmFja3MpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY2FsbGJhY2tzLnB1c2goY2IpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBlbWl0KG5hbWU6IHN0cmluZywgLi4ucGFyYW1zOiBhbnlbXSk6IGJvb2xlYW4gfCBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIGNvbnN0IGNhbGxiYWNrcyA9IHRoaXMuZXZlbnRzLmdldChuYW1lKTtcclxuXHJcbiAgICBpZiAoIWNhbGxiYWNrcyB8fCAhY2FsbGJhY2tzLmxlbmd0aCkgeyByZXR1cm47IH1cclxuXHJcbiAgICBsZXQgcmVzdWx0ID0gdHJ1ZTtcclxuICAgIGNvbnN0IG9ic2VydmFibGVSZXN1bHQgPSBuZXcgQXJyYXk8T2JzZXJ2YWJsZTxib29sZWFuPj4oKTsgLy8g5ZCM5pe25pSv5oyB6L+U5ZueYm9vbGVhbuWSjE9ic2VydmFibGVcclxuICAgIGZvciAoY29uc3QgY2Igb2YgY2FsbGJhY2tzKSB7XHJcbiAgICAgIGNvbnN0IGNiUmVzdWx0ID0gY2IoLi4ucGFyYW1zKTtcclxuICAgICAgaWYgKGNiUmVzdWx0ID09IG51bGwpIHtcclxuICAgICAgICBjb250aW51ZTtcclxuICAgICAgfVxyXG4gICAgICBpZiAodHlwZW9mIGNiUmVzdWx0ID09PSAnYm9vbGVhbicpIHtcclxuICAgICAgICByZXN1bHQgPSByZXN1bHQgJiYgY2JSZXN1bHQ7XHJcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGNiUmVzdWx0LnN1YnNjcmliZSA9PT0gJ2Z1bmN0aW9uJyAmJiBjYlJlc3VsdC5jb25zdHJ1Y3Rvci5uYW1lID09PSBPYnNlcnZhYmxlLm5hbWUpIHtcclxuICAgICAgICAvLyDliKTmlq3mnaHku7bkuI3og73kvb/nlKhjYlJlc3VsdCBpbnN0YW5jZW9mIE9ic2VydmFibGUs5Zug5Li6Y2Llj6/og73mmK/mnaXoh6rkuo7kuI3lkIznmoRpZnJhbWXnjq/looPvvIzlr7zoh7Tot5/ov5nph4znmoRPYnNlcnZhYmxl5p6E6YCg5Ye95pWw5LiN5LiA5qC344CCXHJcbiAgICAgICAgb2JzZXJ2YWJsZVJlc3VsdC5wdXNoKGNiUmVzdWx0KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChvYnNlcnZhYmxlUmVzdWx0Lmxlbmd0aCkge1xyXG4gICAgICByZXR1cm4gZm9ya0pvaW4oWy4uLm9ic2VydmFibGVSZXN1bHQsIG9mKHJlc3VsdCldKS5waXBlKG1hcChyZXN1bHRzID0+IHtcclxuICAgICAgICByZXR1cm4gcmVzdWx0cy5yZWR1Y2UoKHByZXZpb3VzLCBjdXJyZW50KSA9PiBwcmV2aW91cyAmJiBjdXJyZW50KTtcclxuICAgICAgfSkpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgfVxyXG4gIC8qICNlbmRyZWdpb24gKi9cclxufVxyXG5cclxuIl19