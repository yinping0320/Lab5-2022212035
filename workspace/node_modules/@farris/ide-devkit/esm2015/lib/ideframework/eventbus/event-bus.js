/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Type } from '@angular/core';
import { EventBusProxy } from './event-bus-proxy';
import { EventPipe } from './event-pipe';
import { DuplexEventPipe } from './duplex-event-pipe';
export class EventBus {
    constructor() {
        this.proxyMap = new Map();
        this.eventMap = new Map();
        this.notificationMap = new Map();
    }
    /**
     * @param {?} ownerType
     * @param {?} eventTokenValueProvider
     * @return {?}
     */
    getProxy(ownerType, eventTokenValueProvider) {
        /** @type {?} */
        const ownerName = ownerType.constructor.name;
        if (!this.proxyMap.has(ownerName)) {
            this.proxyMap.set(ownerName, new EventBusProxy(this, ownerType, eventTokenValueProvider));
        }
        return this.proxyMap.get(ownerName);
    }
    /**
     * 发送事件，通知订阅者接收消息。
     * @param {?} emitterType
     * @param {?} tokenValue
     * @param {?} eventName
     * @param {?} eventArgs
     * @return {?}
     */
    post(emitterType, tokenValue, eventName, eventArgs) {
        /** @type {?} */
        const eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            return;
        }
        if (!emitterType) {
            console.error('post方法的参数emitterType不能为空。');
            return;
        }
        /** @type {?} */
        let emitter;
        if (emitterType instanceof Type) {
            emitter = emitterType.name;
        }
        else {
            emitter = emitterType;
        }
        for (const eventPipe of eventPipeList) {
            if (eventPipe.matchEmitterToken(emitter, tokenValue)) {
                eventPipe.post(eventArgs);
                eventPipe.unSubscribeForOnce();
            }
        }
    }
    /**
     * 订阅事件
     * @param {?} target
     * @param {?} tokenValue
     * @param {?} eventName
     * @param {?} caller
     * @param {?} handler
     * @return {?}
     */
    on(target, tokenValue, eventName, caller, handler) {
        return this.getEventPipe(eventName, target, tokenValue).subscribe(handler, caller);
    }
    /**
     * 订阅一次。接收到一次消息之后自动取消订阅
     * @param {?} target
     * @param {?} tokenValue
     * @param {?} eventName
     * @param {?} caller
     * @param {?} handler
     * @return {?}
     */
    once(target, tokenValue, eventName, caller, handler) {
        return this.getEventPipe(eventName, target, tokenValue).subscribeOnce(handler, caller);
    }
    /**
     * 发送一个请求事件，获取监听者的响应并处理
     * @param {?} target
     * @param {?} tokenValue
     * @param {?} requestName
     * @param {?} requestValue
     * @param {?} success
     * @param {?=} fail
     * @return {?}
     */
    requestFor(target, tokenValue, requestName, requestValue, success, fail) {
        /** @type {?} */
        const eventPipe = this.findExistEventPipe(requestName, 'RequestSubject', tokenValue);
        if (eventPipe) {
            this.once(target, tokenValue, requestName, this, (response) => {
                if (response.status === 'success') {
                    success(response.data);
                }
                else {
                    if (fail) {
                        fail('No target responser listening');
                    }
                }
            });
            eventPipe.post({ target, token: tokenValue, data: requestValue });
        }
        else {
            if (fail) {
                fail('No target responser listening.');
            }
        }
    }
    /**
     * 监听一个请求事件，给出响应
     * @param {?} responseSubject
     * @param {?} requestName
     * @param {?} callback
     * @return {?}
     */
    responseOn(responseSubject, requestName, callback) {
        this.on('RequestSubject', null, requestName, this, (requestObj) => {
            /** @type {?} */
            const response = { status: 'fail', data: null };
            if (responseSubject === requestObj.target) {
                response.data = callback(requestObj.data);
                response.status = 'success';
            }
            this.post(requestObj.target, requestObj.token, requestName, response);
        });
    }
    /**
     * @param {?} eventName
     * @param {?} eventArgs
     * @return {?}
     */
    notify(eventName, eventArgs) {
        /** @type {?} */
        let notification = this.notificationMap.get(eventName);
        if (!notification) {
            notification = new DuplexEventPipe(eventName);
            this.notificationMap.set(eventName, notification);
        }
        return notification.notify(eventArgs);
    }
    /**
     * @param {?} eventName
     * @param {?} handler
     * @param {?=} caller
     * @return {?}
     */
    listen(eventName, handler, caller) {
        /** @type {?} */
        let notification = this.notificationMap.get(eventName);
        if (!notification) {
            notification = new DuplexEventPipe(eventName);
            this.notificationMap.set(eventName, notification);
        }
        return notification.listen(handler, caller);
    }
    /**
     * @private
     * @param {?} eventName
     * @param {?} target
     * @param {?} tokenValue
     * @return {?}
     */
    getEventPipe(eventName, target, tokenValue) {
        /** @type {?} */
        let eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            eventPipeList = new Array();
            this.eventMap.set(eventName, eventPipeList);
        }
        /** @type {?} */
        let eventPipe = eventPipeList.find(item => item.examByTargetToken(target, tokenValue));
        if (!eventPipe) {
            eventPipe = new EventPipe(eventName, tokenValue, target, eventPipeList);
        }
        return eventPipe;
    }
    /**
     * @private
     * @param {?} eventName
     * @param {?} target
     * @param {?} tokenValue
     * @return {?}
     */
    findExistEventPipe(eventName, target, tokenValue) {
        /** @type {?} */
        const eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            return null;
        }
        // return eventPipeList.find(item => item.examByTargetToken(target, tokenValue));
        for (const eventPipe of eventPipeList) {
            if (eventPipe.matchEmitterToken(target, tokenValue)) {
                return eventPipe;
            }
        }
        return null;
    }
}
EventBus.decorators = [
    { type: Injectable }
];
/** @nocollapse */
EventBus.ctorParameters = () => [];
if (false) {
    /**
     * @type {?}
     * @private
     */
    EventBus.prototype.proxyMap;
    /**
     * @type {?}
     * @private
     */
    EventBus.prototype.eventMap;
    /**
     * @type {?}
     * @private
     */
    EventBus.prototype.notificationMap;
}
class RequestSubject {
}
class DataClass {
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQtYnVzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9pZGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2lkZWZyYW1ld29yay9ldmVudGJ1cy9ldmVudC1idXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUUsSUFBSSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQy9DLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUVoRCxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sY0FBYyxDQUFDO0FBRXZDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUd0RCxNQUFNLE9BQU8sUUFBUTtJQUtuQjtRQUNFLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQXlCLENBQUM7UUFDakQsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLEdBQUcsRUFBNEIsQ0FBQztRQUNwRCxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksR0FBRyxFQUEyQixDQUFDO0lBQzVELENBQUM7Ozs7OztJQUVELFFBQVEsQ0FBQyxTQUFvQixFQUFFLHVCQUFrQzs7Y0FDekQsU0FBUyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSTtRQUM1QyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDakMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLElBQUksYUFBYSxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsdUJBQXVCLENBQUMsQ0FBQyxDQUFDO1NBQzNGO1FBQ0QsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN0QyxDQUFDOzs7Ozs7Ozs7SUFLRCxJQUFJLENBQUMsV0FBK0IsRUFBRSxVQUFrQixFQUFFLFNBQWlCLEVBQUUsU0FBYzs7Y0FDbkYsYUFBYSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQztRQUNsRCxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ2xCLE9BQU87U0FDUjtRQUVELElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDaEIsT0FBTyxDQUFDLEtBQUssQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1lBQzNDLE9BQU87U0FDUjs7WUFDRyxPQUFlO1FBQ25CLElBQUksV0FBVyxZQUFZLElBQUksRUFBRTtZQUMvQixPQUFPLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQztTQUM1QjthQUFNO1lBQ0wsT0FBTyxHQUFHLFdBQVcsQ0FBQztTQUN2QjtRQUVELEtBQUssTUFBTSxTQUFTLElBQUksYUFBYSxFQUFFO1lBQ3JDLElBQUksU0FBUyxDQUFDLGlCQUFpQixDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsRUFBRTtnQkFDcEQsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDMUIsU0FBUyxDQUFDLGtCQUFrQixFQUFFLENBQUM7YUFDaEM7U0FDRjtJQUNILENBQUM7Ozs7Ozs7Ozs7SUFLRCxFQUFFLENBQUMsTUFBYyxFQUFFLFVBQWtCLEVBQUUsU0FBaUIsRUFBRSxNQUFjLEVBQUUsT0FBNkI7UUFDckcsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNyRixDQUFDOzs7Ozs7Ozs7O0lBS0QsSUFBSSxDQUFDLE1BQWMsRUFBRSxVQUFrQixFQUFFLFNBQWlCLEVBQUUsTUFBYyxFQUFFLE9BQTZCO1FBQ3ZHLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDekYsQ0FBQzs7Ozs7Ozs7Ozs7SUFLRCxVQUFVLENBQUMsTUFBYyxFQUFFLFVBQWtCLEVBQUUsV0FBbUIsRUFBRSxZQUFpQixFQUFFLE9BQXFCLEVBQUUsSUFBc0I7O2NBQzVILFNBQVMsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsV0FBVyxFQUFFLGdCQUFnQixFQUFFLFVBQVUsQ0FBQztRQUNwRixJQUFJLFNBQVMsRUFBRTtZQUNiLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLENBQUMsUUFBUSxFQUFFLEVBQUU7Z0JBQzVELElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUU7b0JBQ2pDLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQ3hCO3FCQUFNO29CQUNMLElBQUksSUFBSSxFQUFFO3dCQUNSLElBQUksQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO3FCQUN2QztpQkFDRjtZQUNILENBQUMsQ0FBQyxDQUFDO1lBQ0gsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUMsQ0FBQyxDQUFDO1NBQ2pFO2FBQU07WUFDTCxJQUFJLElBQUksRUFBRTtnQkFDUixJQUFJLENBQUMsZ0NBQWdDLENBQUMsQ0FBQzthQUN4QztTQUNGO0lBQ0gsQ0FBQzs7Ozs7Ozs7SUFLRCxVQUFVLENBQUMsZUFBdUIsRUFBRSxXQUFtQixFQUFFLFFBQXNCO1FBQzdFLElBQUksQ0FBQyxFQUFFLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxVQUFVLEVBQUUsRUFBRTs7a0JBQzFELFFBQVEsR0FBRyxFQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBQztZQUM3QyxJQUFJLGVBQWUsS0FBSyxVQUFVLENBQUMsTUFBTSxFQUFFO2dCQUN6QyxRQUFRLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDO2FBQzdCO1lBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3hFLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQzs7Ozs7O0lBRUQsTUFBTSxDQUFDLFNBQWlCLEVBQUUsU0FBYzs7WUFDbEMsWUFBWSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQztRQUN0RCxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ2pCLFlBQVksR0FBRyxJQUFJLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUM5QyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLENBQUM7U0FDbkQ7UUFDRCxPQUFPLFlBQVksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDeEMsQ0FBQzs7Ozs7OztJQUVELE1BQU0sQ0FBQyxTQUFpQixFQUFFLE9BQTZELEVBQUUsTUFBZTs7WUFDbEcsWUFBWSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQztRQUN0RCxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ2pCLFlBQVksR0FBRyxJQUFJLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUM5QyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLENBQUM7U0FDbkQ7UUFDRCxPQUFPLFlBQVksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQzlDLENBQUM7Ozs7Ozs7O0lBRU8sWUFBWSxDQUFDLFNBQWlCLEVBQUUsTUFBYyxFQUFFLFVBQWtCOztZQUNwRSxhQUFhLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDO1FBQ2hELElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDbEIsYUFBYSxHQUFHLElBQUksS0FBSyxFQUFhLENBQUM7WUFDdkMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1NBQzdDOztZQUNHLFNBQVMsR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sRUFBRSxVQUFVLENBQUMsQ0FBQztRQUN0RixJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2QsU0FBUyxHQUFHLElBQUksU0FBUyxDQUFDLFNBQVMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1NBQ3pFO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQzs7Ozs7Ozs7SUFFTyxrQkFBa0IsQ0FBQyxTQUFpQixFQUFFLE1BQWMsRUFBRSxVQUFrQjs7Y0FDeEUsYUFBYSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQztRQUNsRCxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ2xCLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxpRkFBaUY7UUFDakYsS0FBSyxNQUFNLFNBQVMsSUFBSSxhQUFhLEVBQUU7WUFDckMsSUFBSSxTQUFTLENBQUMsaUJBQWlCLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxFQUFFO2dCQUNuRCxPQUFPLFNBQVMsQ0FBQzthQUNsQjtTQUNGO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDOzs7WUE5SUYsVUFBVTs7Ozs7Ozs7O0lBRVQsNEJBQTZDOzs7OztJQUM3Qyw0QkFBZ0Q7Ozs7O0lBQ2hELG1DQUFzRDs7QUE2SXhELE1BQU0sY0FBYztDQUFHO0FBQ3ZCLE1BQU0sU0FBUztDQUFHIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlLCBUeXBlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtFdmVudEJ1c1Byb3h5fSBmcm9tICcuL2V2ZW50LWJ1cy1wcm94eSc7XHJcbmltcG9ydCB7IElEaXNwb3NhYmxlLCBJRW1pdGFibGUsIElUaGVuYWJsZSB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQge0V2ZW50UGlwZX0gZnJvbSAnLi9ldmVudC1waXBlJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBEdXBsZXhFdmVudFBpcGUgfSBmcm9tICcuL2R1cGxleC1ldmVudC1waXBlJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEV2ZW50QnVzIGltcGxlbWVudHMgSUVtaXRhYmxlIHtcclxuICBwcml2YXRlIHByb3h5TWFwOiBNYXA8c3RyaW5nLCBFdmVudEJ1c1Byb3h5PjtcclxuICBwcml2YXRlIGV2ZW50TWFwOiBNYXA8c3RyaW5nLCBBcnJheTxFdmVudFBpcGU+PjtcclxuICBwcml2YXRlIG5vdGlmaWNhdGlvbk1hcDogTWFwPHN0cmluZywgRHVwbGV4RXZlbnRQaXBlPjtcclxuXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICB0aGlzLnByb3h5TWFwID0gbmV3IE1hcDxzdHJpbmcsIEV2ZW50QnVzUHJveHk+KCk7XHJcbiAgICB0aGlzLmV2ZW50TWFwID0gbmV3IE1hcDxzdHJpbmcsIEFycmF5PEV2ZW50UGlwZT4+KCk7XHJcbiAgICB0aGlzLm5vdGlmaWNhdGlvbk1hcCA9IG5ldyBNYXA8c3RyaW5nLCBEdXBsZXhFdmVudFBpcGU+KCk7XHJcbiAgfVxyXG5cclxuICBnZXRQcm94eShvd25lclR5cGU6IFR5cGU8YW55PiwgZXZlbnRUb2tlblZhbHVlUHJvdmlkZXI6ICgpID0+IGFueSk6IEV2ZW50QnVzUHJveHkge1xyXG4gICAgY29uc3Qgb3duZXJOYW1lID0gb3duZXJUeXBlLmNvbnN0cnVjdG9yLm5hbWU7XHJcbiAgICBpZiAoIXRoaXMucHJveHlNYXAuaGFzKG93bmVyTmFtZSkpIHtcclxuICAgICAgdGhpcy5wcm94eU1hcC5zZXQob3duZXJOYW1lLCBuZXcgRXZlbnRCdXNQcm94eSh0aGlzLCBvd25lclR5cGUsIGV2ZW50VG9rZW5WYWx1ZVByb3ZpZGVyKSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5wcm94eU1hcC5nZXQob3duZXJOYW1lKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWPkemAgeS6i+S7tu+8jOmAmuefpeiuoumYheiAheaOpeaUtua2iOaBr+OAglxyXG4gICAqL1xyXG4gIHBvc3QoZW1pdHRlclR5cGU6IFR5cGU8YW55PiB8IHN0cmluZywgdG9rZW5WYWx1ZTogc3RyaW5nLCBldmVudE5hbWU6IHN0cmluZywgZXZlbnRBcmdzOiBhbnkpOiB2b2lkIHtcclxuICAgIGNvbnN0IGV2ZW50UGlwZUxpc3QgPSB0aGlzLmV2ZW50TWFwLmdldChldmVudE5hbWUpO1xyXG4gICAgaWYgKCFldmVudFBpcGVMaXN0KSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIWVtaXR0ZXJUeXBlKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ3Bvc3Tmlrnms5XnmoTlj4LmlbBlbWl0dGVyVHlwZeS4jeiDveS4uuepuuOAgicpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBsZXQgZW1pdHRlcjogc3RyaW5nO1xyXG4gICAgaWYgKGVtaXR0ZXJUeXBlIGluc3RhbmNlb2YgVHlwZSkge1xyXG4gICAgICBlbWl0dGVyID0gZW1pdHRlclR5cGUubmFtZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGVtaXR0ZXIgPSBlbWl0dGVyVHlwZTtcclxuICAgIH1cclxuXHJcbiAgICBmb3IgKGNvbnN0IGV2ZW50UGlwZSBvZiBldmVudFBpcGVMaXN0KSB7XHJcbiAgICAgIGlmIChldmVudFBpcGUubWF0Y2hFbWl0dGVyVG9rZW4oZW1pdHRlciwgdG9rZW5WYWx1ZSkpIHtcclxuICAgICAgICBldmVudFBpcGUucG9zdChldmVudEFyZ3MpO1xyXG4gICAgICAgIGV2ZW50UGlwZS51blN1YnNjcmliZUZvck9uY2UoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6i6ZiF5LqL5Lu2XHJcbiAgICovXHJcbiAgb24odGFyZ2V0OiBzdHJpbmcsIHRva2VuVmFsdWU6IHN0cmluZywgZXZlbnROYW1lOiBzdHJpbmcsIGNhbGxlcjogb2JqZWN0LCBoYW5kbGVyOiAodmFsdWU6IGFueSkgPT4gdm9pZCk6IElEaXNwb3NhYmxlIHtcclxuICAgIHJldHVybiB0aGlzLmdldEV2ZW50UGlwZShldmVudE5hbWUsIHRhcmdldCwgdG9rZW5WYWx1ZSkuc3Vic2NyaWJlKGhhbmRsZXIsIGNhbGxlcik7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDorqLpmIXkuIDmrKHjgILmjqXmlLbliLDkuIDmrKHmtojmga/kuYvlkI7oh6rliqjlj5bmtojorqLpmIVcclxuICAgKi9cclxuICBvbmNlKHRhcmdldDogc3RyaW5nLCB0b2tlblZhbHVlOiBzdHJpbmcsIGV2ZW50TmFtZTogc3RyaW5nLCBjYWxsZXI6IG9iamVjdCwgaGFuZGxlcjogKHZhbHVlOiBhbnkpID0+IHZvaWQpOiBJRGlzcG9zYWJsZSB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRFdmVudFBpcGUoZXZlbnROYW1lLCB0YXJnZXQsIHRva2VuVmFsdWUpLnN1YnNjcmliZU9uY2UoaGFuZGxlciwgY2FsbGVyKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWPkemAgeS4gOS4quivt+axguS6i+S7tu+8jOiOt+WPluebkeWQrOiAheeahOWTjeW6lOW5tuWkhOeQhlxyXG4gICAqL1xyXG4gIHJlcXVlc3RGb3IodGFyZ2V0OiBzdHJpbmcsIHRva2VuVmFsdWU6IHN0cmluZywgcmVxdWVzdE5hbWU6IHN0cmluZywgcmVxdWVzdFZhbHVlOiBhbnksIHN1Y2Nlc3M6IChhbnkpID0+IGFueSwgZmFpbD86IChzdHJpbmcpID0+IGFueSkge1xyXG4gICAgY29uc3QgZXZlbnRQaXBlID0gdGhpcy5maW5kRXhpc3RFdmVudFBpcGUocmVxdWVzdE5hbWUsICdSZXF1ZXN0U3ViamVjdCcsIHRva2VuVmFsdWUpO1xyXG4gICAgaWYgKGV2ZW50UGlwZSkge1xyXG4gICAgICB0aGlzLm9uY2UodGFyZ2V0LCB0b2tlblZhbHVlLCByZXF1ZXN0TmFtZSwgdGhpcywgKHJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gJ3N1Y2Nlc3MnKSB7XHJcbiAgICAgICAgICBzdWNjZXNzKHJlc3BvbnNlLmRhdGEpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBpZiAoZmFpbCkge1xyXG4gICAgICAgICAgICBmYWlsKCdObyB0YXJnZXQgcmVzcG9uc2VyIGxpc3RlbmluZycpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIGV2ZW50UGlwZS5wb3N0KHt0YXJnZXQsIHRva2VuOiB0b2tlblZhbHVlLCBkYXRhOiByZXF1ZXN0VmFsdWV9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmIChmYWlsKSB7XHJcbiAgICAgICAgZmFpbCgnTm8gdGFyZ2V0IHJlc3BvbnNlciBsaXN0ZW5pbmcuJyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOebkeWQrOS4gOS4quivt+axguS6i+S7tu+8jOe7meWHuuWTjeW6lFxyXG4gICAqL1xyXG4gIHJlc3BvbnNlT24ocmVzcG9uc2VTdWJqZWN0OiBzdHJpbmcsIHJlcXVlc3ROYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiAoYW55KSA9PiBhbnkpIHtcclxuICAgIHRoaXMub24oJ1JlcXVlc3RTdWJqZWN0JywgbnVsbCwgcmVxdWVzdE5hbWUsIHRoaXMsIChyZXF1ZXN0T2JqKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0ge3N0YXR1czogJ2ZhaWwnLCBkYXRhOiBudWxsfTtcclxuICAgICAgaWYgKHJlc3BvbnNlU3ViamVjdCA9PT0gcmVxdWVzdE9iai50YXJnZXQpIHtcclxuICAgICAgICByZXNwb25zZS5kYXRhID0gY2FsbGJhY2socmVxdWVzdE9iai5kYXRhKTtcclxuICAgICAgICByZXNwb25zZS5zdGF0dXMgPSAnc3VjY2Vzcyc7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5wb3N0KHJlcXVlc3RPYmoudGFyZ2V0LCByZXF1ZXN0T2JqLnRva2VuLCByZXF1ZXN0TmFtZSwgcmVzcG9uc2UpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBub3RpZnkoZXZlbnROYW1lOiBzdHJpbmcsIGV2ZW50QXJnczogYW55KTogSVRoZW5hYmxlIHtcclxuICAgIGxldCBub3RpZmljYXRpb24gPSB0aGlzLm5vdGlmaWNhdGlvbk1hcC5nZXQoZXZlbnROYW1lKTtcclxuICAgIGlmICghbm90aWZpY2F0aW9uKSB7XHJcbiAgICAgIG5vdGlmaWNhdGlvbiA9IG5ldyBEdXBsZXhFdmVudFBpcGUoZXZlbnROYW1lKTtcclxuICAgICAgdGhpcy5ub3RpZmljYXRpb25NYXAuc2V0KGV2ZW50TmFtZSwgbm90aWZpY2F0aW9uKTtcclxuICAgIH1cclxuICAgIHJldHVybiBub3RpZmljYXRpb24ubm90aWZ5KGV2ZW50QXJncyk7XHJcbiAgfVxyXG5cclxuICBsaXN0ZW4oZXZlbnROYW1lOiBzdHJpbmcsIGhhbmRsZXI6ICh2YWx1ZTogYW55KSA9PiBPYnNlcnZhYmxlPGJvb2xlYW4+IHwgYm9vbGVhbiB8IHZvaWQsIGNhbGxlcj86IG9iamVjdCk6IHZvaWQge1xyXG4gICAgbGV0IG5vdGlmaWNhdGlvbiA9IHRoaXMubm90aWZpY2F0aW9uTWFwLmdldChldmVudE5hbWUpO1xyXG4gICAgaWYgKCFub3RpZmljYXRpb24pIHtcclxuICAgICAgbm90aWZpY2F0aW9uID0gbmV3IER1cGxleEV2ZW50UGlwZShldmVudE5hbWUpO1xyXG4gICAgICB0aGlzLm5vdGlmaWNhdGlvbk1hcC5zZXQoZXZlbnROYW1lLCBub3RpZmljYXRpb24pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG5vdGlmaWNhdGlvbi5saXN0ZW4oaGFuZGxlciwgY2FsbGVyKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0RXZlbnRQaXBlKGV2ZW50TmFtZTogc3RyaW5nLCB0YXJnZXQ6IHN0cmluZywgdG9rZW5WYWx1ZTogc3RyaW5nKSB7XHJcbiAgICBsZXQgZXZlbnRQaXBlTGlzdCA9IHRoaXMuZXZlbnRNYXAuZ2V0KGV2ZW50TmFtZSk7XHJcbiAgICBpZiAoIWV2ZW50UGlwZUxpc3QpIHtcclxuICAgICAgZXZlbnRQaXBlTGlzdCA9IG5ldyBBcnJheTxFdmVudFBpcGU+KCk7XHJcbiAgICAgIHRoaXMuZXZlbnRNYXAuc2V0KGV2ZW50TmFtZSwgZXZlbnRQaXBlTGlzdCk7XHJcbiAgICB9XHJcbiAgICBsZXQgZXZlbnRQaXBlID0gZXZlbnRQaXBlTGlzdC5maW5kKGl0ZW0gPT4gaXRlbS5leGFtQnlUYXJnZXRUb2tlbih0YXJnZXQsIHRva2VuVmFsdWUpKTtcclxuICAgIGlmICghZXZlbnRQaXBlKSB7XHJcbiAgICAgIGV2ZW50UGlwZSA9IG5ldyBFdmVudFBpcGUoZXZlbnROYW1lLCB0b2tlblZhbHVlLCB0YXJnZXQsIGV2ZW50UGlwZUxpc3QpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGV2ZW50UGlwZTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZmluZEV4aXN0RXZlbnRQaXBlKGV2ZW50TmFtZTogc3RyaW5nLCB0YXJnZXQ6IHN0cmluZywgdG9rZW5WYWx1ZTogc3RyaW5nKTogRXZlbnRQaXBlIHtcclxuICAgIGNvbnN0IGV2ZW50UGlwZUxpc3QgPSB0aGlzLmV2ZW50TWFwLmdldChldmVudE5hbWUpO1xyXG4gICAgaWYgKCFldmVudFBpcGVMaXN0KSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgLy8gcmV0dXJuIGV2ZW50UGlwZUxpc3QuZmluZChpdGVtID0+IGl0ZW0uZXhhbUJ5VGFyZ2V0VG9rZW4odGFyZ2V0LCB0b2tlblZhbHVlKSk7XHJcbiAgICBmb3IgKGNvbnN0IGV2ZW50UGlwZSBvZiBldmVudFBpcGVMaXN0KSB7XHJcbiAgICAgIGlmIChldmVudFBpcGUubWF0Y2hFbWl0dGVyVG9rZW4odGFyZ2V0LCB0b2tlblZhbHVlKSkge1xyXG4gICAgICAgIHJldHVybiBldmVudFBpcGU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxufVxyXG5cclxuY2xhc3MgUmVxdWVzdFN1YmplY3Qge31cclxuY2xhc3MgRGF0YUNsYXNzIHt9XHJcbiJdfQ==