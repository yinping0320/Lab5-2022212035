/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { TreeNode } from './tree-node';
import { TreeOptions } from './tree-options';
import { TREE_EVENTS } from '../constants/events';
import { first, last } from 'lodash-es';
export class TreeModel {
    constructor() {
        this.options = new TreeOptions();
        // focused Node may be not actived 
        // actived Node must be focused
        this.focusedNode = null; // be chosen node
        // be chosen node
        this.activeNode = null; // be chosen and actived node
        this.eventNames = Object.keys(TREE_EVENTS);
        this.firstUpdate = true;
        this._dragNode = null;
        this._dropLocation = null;
    }
    /**
     * @param {?} __0
     * @return {?}
     */
    setData({ nodes, options, events }) {
        this.options = new TreeOptions(options);
        this.events = events;
        this.update(nodes);
    }
    /**
     * @param {?} nodes
     * @return {?}
     */
    update(nodes) {
        // Update the tree:
        this.virtualRoot = new TreeNode({ isVirtualRoot: true }, null, this);
        this.roots = nodes && nodes.map(child => new TreeNode(child, this.virtualRoot, this));
        this.virtualRoot[this.options.childrenField] = this.roots;
        this._loadTreeNodeContentComponent();
        // Fire event:
        if (this.firstUpdate) {
            if (this.roots) {
                this.fireEvent({ eventName: TREE_EVENTS.onInitialized });
                this.firstUpdate = false;
            }
        }
        else {
            this.fireEvent({ eventName: TREE_EVENTS.onUpdateData });
        }
    }
    //Used for code test
    /**
     * @return {?}
     */
    addStaticTreeNode() {
        this.createAndAddTreeNode({
            id: 1,
            name: 'root1',
            subTitle: 'the root',
            type: 'type1'
        }, this.focusedNode);
    }
    /**
     * @param {?} data
     * @param {?} parentNode
     * @param {?=} index
     * @return {?}
     */
    createAndAddTreeNode(data, parentNode, index) {
        /** @type {?} */
        const createdNode = this.createTreeNode(data, parentNode);
        this.addTreeNode(createdNode, parentNode, index);
    }
    /**
     * @param {?} data
     * @param {?} parent
     * @return {?}
     */
    createTreeNode(data, parent) {
        /** @type {?} */
        let createdNode = new TreeNode(data, parent, this);
        return createdNode;
    }
    /**
     * @param {?} addedNode
     * @param {?} parentNode
     * @param {?=} index
     * @return {?}
     */
    addTreeNode(addedNode, parentNode, index) {
        if (addedNode == null) {
            return;
        }
        if (parentNode == null) { // 增加顶级树节点（没有父节点的树节点）
            this.roots.push(addedNode);
        }
        else {
            if (index === null || index === undefined) {
                parentNode.childrenField.push(addedNode);
            }
            else {
                parentNode.childrenField.splice(index, 0, addedNode);
            }
        }
        this.update(this.roots);
        this.fireEvent({ eventName: TREE_EVENTS.onAddNode, addedNode, parentNode });
    }
    /**
     * @return {?}
     */
    removeFocusedTreeNode() {
        this.removeTreeNode(this.focusedNode);
    }
    //移除选中的已知节点
    /**
     * @param {?} selectedTreeNode
     * @return {?}
     */
    removeTreeNode(selectedTreeNode) {
        if (selectedTreeNode == null) {
            return;
        }
        /** @type {?} */
        const parent = selectedTreeNode.parent;
        if (parent == null) { //移除顶级树节点（没有父节点的树节点）
            //移除顶级树节点（没有父节点的树节点）
            /** @type {?} */
            let index = this.roots.indexOf(selectedTreeNode);
            this.roots.splice(index, 1); //移除数组中某一指定节点
        }
        else {
            if (parent.childrenField.length <= 0) {
                console.log("RemoveTreeNode Warning: it is impossible to remove element from an empty array");
                return;
            }
            //移除数组中某一指定节点
            /** @type {?} */
            let index = parent.childrenField.indexOf(selectedTreeNode);
            parent.childrenField.splice(index, 1);
        }
        this.update(this.roots);
        this.fireEvent({ eventName: TREE_EVENTS.onRemoveNode, selectedTreeNode, parent });
    }
    /**
     * 定位指定树节点
     * @param {?} needLocatedNode 待定位节点
     * @return {?}
     */
    locateTreeNode(needLocatedNode) {
        if (needLocatedNode == null) {
            return;
        }
        /** @type {?} */
        let parentNode = needLocatedNode.parent;
        while (parentNode != null) {
            parentNode.isExpanded = true;
            parentNode = parentNode.parent;
        }
        needLocatedNode.isActive = false;
        needLocatedNode.toggleActivated();
    }
    /**
     * 通过ID定位树节点
     * @param {?} nodeID 待查找并定位节点的ID
     * @return {?}
     */
    locateNodeByID(nodeID) {
        /** @type {?} */
        let node = this.searchTreeNodeByID(nodeID);
        if (node == null) {
            return false;
        }
        this.locateTreeNode(node);
        return true;
    }
    /**
     * 查找指定树节点
     * @param {?} nodeID 待查找节点ID
     * @return {?}
     */
    searchTreeNodeByID(nodeID) {
        return this.searchTreeNode(this.roots, nodeID);
    }
    /**
     * 在指定集合中，根据ID查找树节点
     * @param {?} nodes 树集合
     * @param {?} nodeID 待查找节点ID
     * @return {?}
     */
    searchTreeNode(nodes, nodeID) {
        if (nodes == null || nodes.length <= 0) {
            return null;
        }
        if (nodeID == null || nodeID.length < 0) {
            return null;
        }
        /** @type {?} */
        let searchedTreeNode = null;
        nodes.forEach(node => {
            if (node.idField == nodeID) { //回归
                searchedTreeNode = node;
                return;
            }
            if (node.childrenField == null || node.childrenField.length < 0) { //回归
                return;
            }
            /** @type {?} */
            const searchedNodeInChildren = this.searchTreeNode(node.childrenField, nodeID);
            if (searchedNodeInChildren != null) {
                searchedTreeNode = searchedNodeInChildren;
            }
            return; //回归
        });
        return searchedTreeNode; //返回
    }
    /**
     * @return {?}
     */
    get treeNodeContentComponent() { return this._treeNodeContentComponent; }
    ;
    // if treeNodeTemplate is a component - use it,
    // otherwise - it's a template, so wrap it with an AdHoc component
    /**
     * @return {?}
     */
    _loadTreeNodeContentComponent() {
        this._treeNodeContentComponent = this.options.treeNodeTemplate;
        if (typeof this._treeNodeContentComponent === 'string') {
            // this._treeNodeContentComponent = this._createAdHocComponent(this._treeNodeContentComponent);
        }
    }
    // _createAdHocComponent(templateStr) {
    //     @Component({
    //         selector: 'TreeNodeTemplate',
    //         template: templateStr
    //     })
    //     class AdHocTreeNodeTemplateComponent {
    //         @Input() node: TreeNode;
    //     }
    //     return AdHocTreeNodeTemplateComponent;
    // }
    /**
     * @return {?}
     */
    get isFocused() {
        return TreeModel.focusedTree === this;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    setFocus(value) {
        TreeModel.focusedTree = value ? this : null;
    }
    /**
     * @return {?}
     */
    getFirstRoot() {
        return first(this.roots);
    }
    /**
     * @return {?}
     */
    getLastRoot() {
        return last(this.roots);
    }
    /**
     * @return {?}
     */
    focusNextNode() {
        /** @type {?} */
        let previousNode = this.focusedNode;
        /** @type {?} */
        let nextNode = previousNode ? previousNode.findNextNode() : this.getFirstRoot();
        nextNode && nextNode.focus(); // Short-circuit evaluation
    }
    /**
     * @return {?}
     */
    focusPreviousNode() {
        /** @type {?} */
        let previousNode = this.focusedNode;
        /** @type {?} */
        let nextNode = previousNode ? previousNode.findPreviousNode() : this.getLastRoot();
        nextNode && nextNode.focus();
    }
    /**
     * @return {?}
     */
    focusDrillUp() {
        /** @type {?} */
        let previousNode = this.focusedNode;
        /** @type {?} */
        let nextNode = previousNode && previousNode.realParent;
        nextNode && nextNode.focus();
    }
    /**
     * @return {?}
     */
    focusDrillDown() {
        /** @type {?} */
        let previousNode = this.focusedNode;
        /** @type {?} */
        let nextNode = previousNode && previousNode.getFirstChild();
        nextNode && nextNode.focus();
    }
    /**
     * @param {?} event
     * @return {?}
     */
    fireEvent(event) {
        // https://stackoverflow.com/questions/35840576/differencse-between-eventemitter-next-and-eventemitter-emit-in-angular-2
        //  abandon next() function, begin to use emit() function
        // this.events[event.eventName].next(event);
        // this.events[event.eventName].emit(event,alert(event.eventName));//发射事件，并传递事件的对象
        this.events[event.eventName].emit(event);
    }
    /**
     * 判断是否执行移动节点操作，可以移动返回true，否则返回false
     * @param {?} __0
     * @return {?}
     */
    canMoveNode({ from, to }) {
        // same node
        if (from.parentNode === to.parentNode && from.index === to.index) {
            return false;
        }
        /** @type {?} */
        const fromChildren = from.parentNode.children;
        /** @type {?} */
        const fromNode = fromChildren[from.index];
        return !to.parentNode.isDescendantOf(fromNode);
    }
    /**
     * 移动节点
     * @param {?} __0
     * @return {?}
     */
    moveNode({ from, to }) {
        if (!this.canMoveNode({ from, to }))
            return;
        /** @type {?} */
        const fromChildren = from.parentNode.childrenField;
        // If node doesn't have children - create children array
        if (!to.parentNode.childrenField) {
            to.parentNode.childrenField = [];
        }
        /** @type {?} */
        const toChildren = to.parentNode.childrenField;
        // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/splice
        // The splice() method changes the contents of an array by removing existing elements and/or adding new elements.
        /** @type {?} */
        const node = fromChildren.splice(from.index, 1)[0];
        // Compensate for index if already removed from parent:
        /** @type {?} */
        let toIndex = (from.parentNode === to.parentNode && to.index > from.index) ? to.index - 1 : to.index;
        toChildren.splice(toIndex, 0, node);
        // console.log("toChildren:" + toChildren);
        // console.log("AfterMoveNode:" + this.roots);
        this.update(this.roots); // 实现node moved后，重新刷新这棵树
        this.fireEvent({ eventName: TREE_EVENTS.onMoveNode, node, to });
    }
    // TODO: move to a different service:
    /**
     * @param {?} dragNode
     * @return {?}
     */
    setDragNode(dragNode) {
        this._dragNode = dragNode;
    }
    /**
     * @return {?}
     */
    getDragNode() {
        return this._dragNode || { parentNode: null, index: null };
    }
    /**
     * @return {?}
     */
    isDragging() {
        return this.getDragNode().parentNode;
    }
    /**
     * @param {?} dropLocation
     * @return {?}
     */
    setDropLocation(dropLocation) {
        this._dropLocation = dropLocation;
    }
    /**
     * @return {?}
     */
    getDropLocation() {
        return this._dropLocation || { component: null, parentNode: null, index: null };
    }
    /**
     * @param {?} component
     * @return {?}
     */
    isDraggingOver(component) {
        return this.getDropLocation().component === component;
    }
    /**
     * @return {?}
     */
    cancelDrag() {
        this.setDropLocation(null);
        this.setDragNode(null);
    }
}
TreeModel.focusedTree = null;
TreeModel.decorators = [
    { type: Injectable }
];
if (false) {
    /** @type {?} */
    TreeModel.focusedTree;
    /** @type {?} */
    TreeModel.prototype.roots;
    /** @type {?} */
    TreeModel.prototype.options;
    /** @type {?} */
    TreeModel.prototype.focusedNode;
    /** @type {?} */
    TreeModel.prototype.activeNode;
    /**
     * @type {?}
     * @private
     */
    TreeModel.prototype.events;
    /** @type {?} */
    TreeModel.prototype.eventNames;
    /** @type {?} */
    TreeModel.prototype.firstUpdate;
    /** @type {?} */
    TreeModel.prototype._dragNode;
    /** @type {?} */
    TreeModel.prototype._dropLocation;
    /** @type {?} */
    TreeModel.prototype.virtualRoot;
    /**
     * @type {?}
     * @private
     */
    TreeModel.prototype._treeNodeContentComponent;
    /* Skipping unhandled member: ;*/
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZS1tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvaWRlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL25nMnRyZWUtY29tbW9uL21vZGVscy90cmVlLW1vZGVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBOEIsTUFBTSxXQUFXLENBQUM7QUFHcEUsTUFBTSxPQUFPLFNBQVM7SUFEdEI7UUFHSSxZQUFPLEdBQWdCLElBQUksV0FBVyxFQUFFLENBQUM7OztRQUl6QyxnQkFBVyxHQUFhLElBQUksQ0FBQyxDQUFBLGlCQUFpQjs7UUFDOUMsZUFBVSxHQUFhLElBQUksQ0FBQyxDQUFBLDZCQUE2QjtRQUV6RCxlQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUV0QyxnQkFBVyxHQUFHLElBQUksQ0FBQztRQUNuQixjQUFTLEdBQTRDLElBQUksQ0FBQztRQUMxRCxrQkFBYSxHQUEyRCxJQUFJLENBQUM7SUF3VWpGLENBQUM7Ozs7O0lBdFVHLE9BQU8sQ0FBQyxFQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFDO1FBRTVCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDeEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFFckIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN2QixDQUFDOzs7OztJQUdELE1BQU0sQ0FBQyxLQUFLO1FB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RDtRQUN4RCxJQUFJLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQztJQUM5QixDQUFDOzs7O0lBRUQsV0FBVztRQUNQLE9BQU8sSUFBSSxDQUFDLFNBQVMsSUFBSSxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDO0lBQy9ELENBQUM7Ozs7SUFFRCxVQUFVO1FBQ04sT0FBTyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsVUFBVSxDQUFDO0lBQ3pDLENBQUM7Ozs7O0lBRUQsZUFBZSxDQUFDLFlBQXFFO1FBQ2pGLElBQUksQ0FBQyxhQUFhLEdBQUcsWUFBWSxDQUFDO0lBQ3RDLENBQUM7Ozs7SUFFRCxlQUFlO1FBQ1gsT0FBTyxJQUFJLENBQUMsYUFBYSxJQUFJLEVBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUMsQ0FBQztJQUNsRixDQUFDOzs7OztJQUVELGNBQWMsQ0FBQyxTQUFTO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLFNBQVMsS0FBSyxTQUFTLENBQUM7SUFDMUQsQ0FBQzs7OztJQUVELFVBQVU7UUFDTixJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzNCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0IsQ0FBQzs7QUFqVk0scUJBQVcsR0FBRyxJQUFJLENBQUM7O1lBSjdCLFVBQVU7Ozs7SUFJUCxzQkFBMEI7O0lBRjFCLDBCQUFrQjs7SUFDbEIsNEJBQXlDOztJQUl6QyxnQ0FBNkI7O0lBQzdCLCtCQUE0Qjs7Ozs7SUFDNUIsMkJBQW1COztJQUNuQiwrQkFBc0M7O0lBRXRDLGdDQUFtQjs7SUFDbkIsOEJBQTBEOztJQUMxRCxrQ0FBNkU7O0lBVTdFLGdDQUFzQjs7Ozs7SUEwS3RCLDhDQUFzQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgVHJlZU5vZGUgfSBmcm9tICcuL3RyZWUtbm9kZSc7XHJcbmltcG9ydCB7IFRyZWVPcHRpb25zIH0gZnJvbSAnLi90cmVlLW9wdGlvbnMnO1xyXG5pbXBvcnQgeyBUUkVFX0VWRU5UUyB9IGZyb20gJy4uL2NvbnN0YW50cy9ldmVudHMnO1xyXG5pbXBvcnQgeyBmaXJzdCwgbGFzdCwgaW5kZXhPZiwgZmluZEluZGV4LCBzb3J0QnkgfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgVHJlZU1vZGVsIHtcclxuICAgIHJvb3RzOiBUcmVlTm9kZVtdO1xyXG4gICAgb3B0aW9uczogVHJlZU9wdGlvbnMgPSBuZXcgVHJlZU9wdGlvbnMoKTtcclxuICAgIHN0YXRpYyBmb2N1c2VkVHJlZSA9IG51bGw7XHJcbiAgICAvLyBmb2N1c2VkIE5vZGUgbWF5IGJlIG5vdCBhY3RpdmVkIFxyXG4gICAgLy8gYWN0aXZlZCBOb2RlIG11c3QgYmUgZm9jdXNlZFxyXG4gICAgZm9jdXNlZE5vZGU6IFRyZWVOb2RlID0gbnVsbDsvLyBiZSBjaG9zZW4gbm9kZVxyXG4gICAgYWN0aXZlTm9kZTogVHJlZU5vZGUgPSBudWxsOy8vIGJlIGNob3NlbiBhbmQgYWN0aXZlZCBub2RlXHJcbiAgICBwcml2YXRlIGV2ZW50czphbnk7XHJcbiAgICBldmVudE5hbWVzID0gT2JqZWN0LmtleXMoVFJFRV9FVkVOVFMpO1xyXG5cclxuICAgIGZpcnN0VXBkYXRlID0gdHJ1ZTtcclxuICAgIF9kcmFnTm9kZTogeyBwYXJlbnROb2RlOiBUcmVlTm9kZSwgaW5kZXg6IG51bWJlciB9ID0gbnVsbDtcclxuICAgIF9kcm9wTG9jYXRpb246eyBjb21wb25lbnQ6IGFueSwgcGFyZW50Tm9kZTogVHJlZU5vZGUsIGluZGV4OiBudW1iZXIgfSA9IG51bGw7XHJcblxyXG4gICAgc2V0RGF0YSh7bm9kZXMsIG9wdGlvbnMsIGV2ZW50c30pe1xyXG5cclxuICAgICAgICB0aGlzLm9wdGlvbnMgPSBuZXcgVHJlZU9wdGlvbnMob3B0aW9ucyk7XHJcbiAgICAgICAgdGhpcy5ldmVudHMgPSBldmVudHM7XHJcblxyXG4gICAgICAgIHRoaXMudXBkYXRlKG5vZGVzKTtcclxuICAgIH1cclxuXHJcbiAgICB2aXJ0dWFsUm9vdDogVHJlZU5vZGU7XHJcbiAgICB1cGRhdGUobm9kZXMpe1xyXG4gICAgICAgIC8vIFVwZGF0ZSB0aGUgdHJlZTpcclxuXHJcbiAgICAgICAgdGhpcy52aXJ0dWFsUm9vdCA9IG5ldyBUcmVlTm9kZSh7IGlzVmlydHVhbFJvb3Q6IHRydWUgfSwgbnVsbCx0aGlzKTtcclxuXHJcbiAgICAgICAgdGhpcy5yb290cyA9IG5vZGVzICYmIG5vZGVzLm1hcChjaGlsZCA9PiBuZXcgVHJlZU5vZGUoY2hpbGQsIHRoaXMudmlydHVhbFJvb3QsIHRoaXMpKTtcclxuXHJcbiAgICAgICAgdGhpcy52aXJ0dWFsUm9vdFt0aGlzLm9wdGlvbnMuY2hpbGRyZW5GaWVsZF0gPSB0aGlzLnJvb3RzO1xyXG4gIFxyXG4gICAgICAgIHRoaXMuX2xvYWRUcmVlTm9kZUNvbnRlbnRDb21wb25lbnQoKTtcclxuICAgIFxyXG4gICAgICAgIC8vIEZpcmUgZXZlbnQ6XHJcbiAgICAgICAgaWYgKHRoaXMuZmlyc3RVcGRhdGUpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMucm9vdHMpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KHsgZXZlbnROYW1lOiBUUkVFX0VWRU5UUy5vbkluaXRpYWxpemVkIH0pO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5maXJzdFVwZGF0ZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoeyBldmVudE5hbWU6IFRSRUVfRVZFTlRTLm9uVXBkYXRlRGF0YSB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy9Vc2VkIGZvciBjb2RlIHRlc3RcclxuICAgIGFkZFN0YXRpY1RyZWVOb2RlKCl7XHJcbiAgICAgICAgdGhpcy5jcmVhdGVBbmRBZGRUcmVlTm9kZSh7ICAgICAgICBcclxuICAgICAgICAgICAgaWQ6IDEsXHJcbiAgICAgICAgICAgIG5hbWU6ICdyb290MScsXHJcbiAgICAgICAgICAgIHN1YlRpdGxlOiAndGhlIHJvb3QnLFxyXG4gICAgICAgICAgICB0eXBlOiAndHlwZTEnXHJcbiAgICAgICAgfSx0aGlzLmZvY3VzZWROb2RlKTtcclxuICAgIH1cclxuXHJcbiAgICBjcmVhdGVBbmRBZGRUcmVlTm9kZShkYXRhLCBwYXJlbnROb2RlOiBUcmVlTm9kZSwgaW5kZXg/KXtcclxuICAgICAgICBjb25zdCBjcmVhdGVkTm9kZSA9IHRoaXMuY3JlYXRlVHJlZU5vZGUoZGF0YSwgcGFyZW50Tm9kZSk7XHJcbiAgICAgICAgdGhpcy5hZGRUcmVlTm9kZShjcmVhdGVkTm9kZSwgcGFyZW50Tm9kZSwgaW5kZXgpO1xyXG4gICAgfVxyXG5cclxuICAgIGNyZWF0ZVRyZWVOb2RlKGRhdGEsIHBhcmVudDogVHJlZU5vZGUpOiBUcmVlTm9kZXtcclxuICAgICAgICBsZXQgY3JlYXRlZE5vZGUgPSAgbmV3IFRyZWVOb2RlKGRhdGEsIHBhcmVudCwgdGhpcyk7XHJcbiAgICAgICAgcmV0dXJuIGNyZWF0ZWROb2RlO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBhZGRUcmVlTm9kZShhZGRlZE5vZGU6IFRyZWVOb2RlLCBwYXJlbnROb2RlOiBUcmVlTm9kZSwgaW5kZXg/KXtcclxuICAgICAgICBpZiAoYWRkZWROb2RlID09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHBhcmVudE5vZGUgPT0gbnVsbCkgey8vIOWinuWKoOmhtue6p+agkeiKgueCue+8iOayoeacieeItuiKgueCueeahOagkeiKgueCue+8iVxyXG4gICAgICAgICAgICB0aGlzLnJvb3RzLnB1c2goYWRkZWROb2RlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoaW5kZXggPT09IG51bGwgfHwgaW5kZXggPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgcGFyZW50Tm9kZS5jaGlsZHJlbkZpZWxkLnB1c2goYWRkZWROb2RlKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHBhcmVudE5vZGUuY2hpbGRyZW5GaWVsZC5zcGxpY2UoaW5kZXgsIDAsIGFkZGVkTm9kZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMudXBkYXRlKHRoaXMucm9vdHMpO1xyXG5cclxuICAgICAgICB0aGlzLmZpcmVFdmVudCh7IGV2ZW50TmFtZTogVFJFRV9FVkVOVFMub25BZGROb2RlLCBhZGRlZE5vZGUsIHBhcmVudE5vZGV9KTtcclxuICAgIH1cclxuXHJcbiAgICByZW1vdmVGb2N1c2VkVHJlZU5vZGUoKXtcclxuICAgICAgICB0aGlzLnJlbW92ZVRyZWVOb2RlKHRoaXMuZm9jdXNlZE5vZGUpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICAvL+enu+mZpOmAieS4reeahOW3suefpeiKgueCuVxyXG4gICAgcmVtb3ZlVHJlZU5vZGUoc2VsZWN0ZWRUcmVlTm9kZTogVHJlZU5vZGUpe1xyXG4gICAgICAgIGlmKHNlbGVjdGVkVHJlZU5vZGUgPT0gbnVsbCl7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHBhcmVudCA9IHNlbGVjdGVkVHJlZU5vZGUucGFyZW50O1xyXG4gICAgICAgIGlmKHBhcmVudCA9PSBudWxsKXsvL+enu+mZpOmhtue6p+agkeiKgueCue+8iOayoeacieeItuiKgueCueeahOagkeiKgueCue+8iVxyXG4gICAgICAgICAgICBsZXQgaW5kZXggPSB0aGlzLnJvb3RzLmluZGV4T2Yoc2VsZWN0ZWRUcmVlTm9kZSk7XHJcbiAgICAgICAgICAgIHRoaXMucm9vdHMuc3BsaWNlKGluZGV4LCAxKTsvL+enu+mZpOaVsOe7hOS4reafkOS4gOaMh+WumuiKgueCuVxyXG4gICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICBpZihwYXJlbnQuY2hpbGRyZW5GaWVsZC5sZW5ndGggPD0gMCl7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlJlbW92ZVRyZWVOb2RlIFdhcm5pbmc6IGl0IGlzIGltcG9zc2libGUgdG8gcmVtb3ZlIGVsZW1lbnQgZnJvbSBhbiBlbXB0eSBhcnJheVwiKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvL+enu+mZpOaVsOe7hOS4reafkOS4gOaMh+WumuiKgueCuVxyXG4gICAgICAgICAgICBsZXQgaW5kZXggPSBwYXJlbnQuY2hpbGRyZW5GaWVsZC5pbmRleE9mKHNlbGVjdGVkVHJlZU5vZGUpO1xyXG4gICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW5GaWVsZC5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy51cGRhdGUodGhpcy5yb290cyk7XHJcblxyXG4gICAgICAgIHRoaXMuZmlyZUV2ZW50KHsgZXZlbnROYW1lOiBUUkVFX0VWRU5UUy5vblJlbW92ZU5vZGUsIHNlbGVjdGVkVHJlZU5vZGUsIHBhcmVudH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5a6a5L2N5oyH5a6a5qCR6IqC54K5XHJcbiAgICAgKiBAcGFyYW0gbmVlZExvY2F0ZWROb2RlIOW+heWumuS9jeiKgueCuSBcclxuICAgICAqL1xyXG4gICAgbG9jYXRlVHJlZU5vZGUobmVlZExvY2F0ZWROb2RlOiBUcmVlTm9kZSl7XHJcbiAgICAgICAgaWYobmVlZExvY2F0ZWROb2RlID09IG51bGwpe1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgcGFyZW50Tm9kZSA9IG5lZWRMb2NhdGVkTm9kZS5wYXJlbnQ7XHJcbiAgICAgICAgd2hpbGUoIHBhcmVudE5vZGUgIT0gbnVsbCl7XHJcbiAgICAgICAgICAgIHBhcmVudE5vZGUuaXNFeHBhbmRlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIHBhcmVudE5vZGUgPSBwYXJlbnROb2RlLnBhcmVudDtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgbmVlZExvY2F0ZWROb2RlLmlzQWN0aXZlID0gZmFsc2U7XHJcbiAgICAgICAgbmVlZExvY2F0ZWROb2RlLnRvZ2dsZUFjdGl2YXRlZCgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6YCa6L+HSUTlrprkvY3moJHoioLngrlcclxuICAgICAqIEBwYXJhbSBub2RlSUQg5b6F5p+l5om+5bm25a6a5L2N6IqC54K555qESURcclxuICAgICAqL1xyXG4gICAgbG9jYXRlTm9kZUJ5SUQobm9kZUlEOiBzdHJpbmcpOiBib29sZWFue1xyXG4gICAgICAgIGxldCBub2RlID0gdGhpcy5zZWFyY2hUcmVlTm9kZUJ5SUQobm9kZUlEKTtcclxuICAgICAgICBpZihub2RlID09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmxvY2F0ZVRyZWVOb2RlKG5vZGUpO1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICAvKipcclxuICAgICAqIOafpeaJvuaMh+WumuagkeiKgueCuVxyXG4gICAgICogQHBhcmFtIG5vZGVJRCDlvoXmn6Xmib7oioLngrlJRFxyXG4gICAgICovXHJcbiAgICBzZWFyY2hUcmVlTm9kZUJ5SUQobm9kZUlEOiBzdHJpbmcpOiBUcmVlTm9kZXtcclxuICAgICAgICByZXR1cm4gdGhpcy5zZWFyY2hUcmVlTm9kZSh0aGlzLnJvb3RzLCBub2RlSUQpO1xyXG4gICAgfVxyXG5cclxuICAgIFxyXG4gICAgLyoqXHJcbiAgICAgKiDlnKjmjIflrprpm4blkIjkuK3vvIzmoLnmja5JROafpeaJvuagkeiKgueCuVxyXG4gICAgICogQHBhcmFtIG5vZGVzIOagkembhuWQiFxyXG4gICAgICogQHBhcmFtIG5vZGVJRCDlvoXmn6Xmib7oioLngrlJRFxyXG4gICAgICovXHJcbiAgICBzZWFyY2hUcmVlTm9kZShub2RlczogVHJlZU5vZGVbXSwgbm9kZUlEOiBzdHJpbmcpOiBUcmVlTm9kZXtcclxuXHJcbiAgICAgICAgaWYobm9kZXMgPT0gbnVsbCB8fCBub2Rlcy5sZW5ndGggPD0gMCl7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYobm9kZUlEID09IG51bGwgfHwgbm9kZUlELmxlbmd0aCA8IDApe1xyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBzZWFyY2hlZFRyZWVOb2RlOiBUcmVlTm9kZSA9IG51bGw7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbm9kZXMuZm9yRWFjaChub2RlID0+IHtcclxuICAgICAgICAgICAgaWYobm9kZS5pZEZpZWxkID09IG5vZGVJRCl7IC8v5Zue5b2SXHJcbiAgICAgICAgICAgICAgICBzZWFyY2hlZFRyZWVOb2RlID0gbm9kZTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYobm9kZS5jaGlsZHJlbkZpZWxkID09IG51bGwgfHwgbm9kZS5jaGlsZHJlbkZpZWxkLmxlbmd0aCA8IDApeyAvL+WbnuW9klxyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBzZWFyY2hlZE5vZGVJbkNoaWxkcmVuID0gdGhpcy5zZWFyY2hUcmVlTm9kZShub2RlLmNoaWxkcmVuRmllbGQsIG5vZGVJRCk7Ly/pgJLmjqhcclxuICAgICAgICAgICAgaWYoc2VhcmNoZWROb2RlSW5DaGlsZHJlbiAhPSBudWxsKXtcclxuICAgICAgICAgICAgICAgIHNlYXJjaGVkVHJlZU5vZGUgPSBzZWFyY2hlZE5vZGVJbkNoaWxkcmVuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybjsvL+WbnuW9klxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gc2VhcmNoZWRUcmVlTm9kZTsgLy/ov5Tlm55cclxuICAgIH1cclxuICAgIFxyXG4gICAgcHJpdmF0ZSBfdHJlZU5vZGVDb250ZW50Q29tcG9uZW50OmFueTtcclxuICAgIGdldCB0cmVlTm9kZUNvbnRlbnRDb21wb25lbnQoKSB7IHJldHVybiB0aGlzLl90cmVlTm9kZUNvbnRlbnRDb21wb25lbnQgfTtcclxuICAgIC8vIGlmIHRyZWVOb2RlVGVtcGxhdGUgaXMgYSBjb21wb25lbnQgLSB1c2UgaXQsXHJcbiAgICAvLyBvdGhlcndpc2UgLSBpdCdzIGEgdGVtcGxhdGUsIHNvIHdyYXAgaXQgd2l0aCBhbiBBZEhvYyBjb21wb25lbnRcclxuICAgIF9sb2FkVHJlZU5vZGVDb250ZW50Q29tcG9uZW50KCkge1xyXG4gICAgICAgIHRoaXMuX3RyZWVOb2RlQ29udGVudENvbXBvbmVudCA9IHRoaXMub3B0aW9ucy50cmVlTm9kZVRlbXBsYXRlO1xyXG4gICAgICAgIGlmICh0eXBlb2YgdGhpcy5fdHJlZU5vZGVDb250ZW50Q29tcG9uZW50ID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgIC8vIHRoaXMuX3RyZWVOb2RlQ29udGVudENvbXBvbmVudCA9IHRoaXMuX2NyZWF0ZUFkSG9jQ29tcG9uZW50KHRoaXMuX3RyZWVOb2RlQ29udGVudENvbXBvbmVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIF9jcmVhdGVBZEhvY0NvbXBvbmVudCh0ZW1wbGF0ZVN0cikge1xyXG4gICAgLy8gICAgIEBDb21wb25lbnQoe1xyXG4gICAgLy8gICAgICAgICBzZWxlY3RvcjogJ1RyZWVOb2RlVGVtcGxhdGUnLFxyXG4gICAgLy8gICAgICAgICB0ZW1wbGF0ZTogdGVtcGxhdGVTdHJcclxuICAgIC8vICAgICB9KVxyXG4gICAgLy8gICAgIGNsYXNzIEFkSG9jVHJlZU5vZGVUZW1wbGF0ZUNvbXBvbmVudCB7XHJcbiAgICAvLyAgICAgICAgIEBJbnB1dCgpIG5vZGU6IFRyZWVOb2RlO1xyXG4gICAgLy8gICAgIH1cclxuICAgIC8vICAgICByZXR1cm4gQWRIb2NUcmVlTm9kZVRlbXBsYXRlQ29tcG9uZW50O1xyXG4gICAgLy8gfVxyXG5cclxuICAgIGdldCBpc0ZvY3VzZWQoKVxyXG4gICAge1xyXG4gICAgICAgIHJldHVybiBUcmVlTW9kZWwuZm9jdXNlZFRyZWUgPT09IHRoaXM7XHJcbiAgICB9XHJcbiAgICBzZXRGb2N1cyh2YWx1ZSl7XHJcbiAgICAgICAgVHJlZU1vZGVsLmZvY3VzZWRUcmVlID0gdmFsdWUgPyB0aGlzIDogbnVsbDtcclxuICAgIH1cclxuICAgIGdldEZpcnN0Um9vdCgpe1xyXG4gICAgICAgIHJldHVybiBmaXJzdCh0aGlzLnJvb3RzKTtcclxuICAgIH1cclxuICAgIGdldExhc3RSb290KCl7XHJcbiAgICAgICAgcmV0dXJuIGxhc3QodGhpcy5yb290cyk7XHJcbiAgICB9XHJcbiAgICBmb2N1c05leHROb2RlKCkge1xyXG4gICAgICAgIGxldCBwcmV2aW91c05vZGUgPSB0aGlzLmZvY3VzZWROb2RlO1xyXG4gICAgICAgIGxldCBuZXh0Tm9kZSA9IHByZXZpb3VzTm9kZSA/IHByZXZpb3VzTm9kZS5maW5kTmV4dE5vZGUoKSA6IHRoaXMuZ2V0Rmlyc3RSb290KCk7XHJcbiAgICAgICAgbmV4dE5vZGUgJiYgbmV4dE5vZGUuZm9jdXMoKSAvLyBTaG9ydC1jaXJjdWl0IGV2YWx1YXRpb25cclxuICAgIH1cclxuXHJcbiAgICBmb2N1c1ByZXZpb3VzTm9kZSgpIHtcclxuICAgICAgICBsZXQgcHJldmlvdXNOb2RlID0gdGhpcy5mb2N1c2VkTm9kZTtcclxuICAgICAgICBsZXQgbmV4dE5vZGUgPSBwcmV2aW91c05vZGUgPyBwcmV2aW91c05vZGUuZmluZFByZXZpb3VzTm9kZSgpIDogdGhpcy5nZXRMYXN0Um9vdCgpO1xyXG4gICAgICAgIG5leHROb2RlICYmIG5leHROb2RlLmZvY3VzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZm9jdXNEcmlsbFVwKCl7XHJcbiAgICAgICAgbGV0IHByZXZpb3VzTm9kZSA9IHRoaXMuZm9jdXNlZE5vZGU7XHJcbiAgICAgICAgbGV0IG5leHROb2RlID0gcHJldmlvdXNOb2RlICYmIHByZXZpb3VzTm9kZS5yZWFsUGFyZW50O1xyXG4gICAgICAgIG5leHROb2RlICYmIG5leHROb2RlLmZvY3VzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZm9jdXNEcmlsbERvd24oKSB7XHJcbiAgICAgICAgbGV0IHByZXZpb3VzTm9kZSA9IHRoaXMuZm9jdXNlZE5vZGU7XHJcbiAgICAgICAgbGV0IG5leHROb2RlID0gcHJldmlvdXNOb2RlICYmIHByZXZpb3VzTm9kZS5nZXRGaXJzdENoaWxkKCk7XHJcbiAgICAgICAgbmV4dE5vZGUgJiYgbmV4dE5vZGUuZm9jdXMoKTtcclxuICAgIH1cclxuXHJcbiAgICBmaXJlRXZlbnQoZXZlbnQpIHtcclxuICAgICAgICAvLyBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zNTg0MDU3Ni9kaWZmZXJlbmNzZS1iZXR3ZWVuLWV2ZW50ZW1pdHRlci1uZXh0LWFuZC1ldmVudGVtaXR0ZXItZW1pdC1pbi1hbmd1bGFyLTJcclxuICAgICAgICAvLyAgYWJhbmRvbiBuZXh0KCkgZnVuY3Rpb24sIGJlZ2luIHRvIHVzZSBlbWl0KCkgZnVuY3Rpb25cclxuICAgICAgICAvLyB0aGlzLmV2ZW50c1tldmVudC5ldmVudE5hbWVdLm5leHQoZXZlbnQpO1xyXG4gICAgICAgIC8vIHRoaXMuZXZlbnRzW2V2ZW50LmV2ZW50TmFtZV0uZW1pdChldmVudCxhbGVydChldmVudC5ldmVudE5hbWUpKTsvL+WPkeWwhOS6i+S7tu+8jOW5tuS8oOmAkuS6i+S7tueahOWvueixoVxyXG4gICAgICAgIHRoaXMuZXZlbnRzW2V2ZW50LmV2ZW50TmFtZV0uZW1pdChldmVudCk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yik5pat5piv5ZCm5omn6KGM56e75Yqo6IqC54K55pON5L2c77yM5Y+v5Lul56e75Yqo6L+U5ZuedHJ1Ze+8jOWQpuWImei/lOWbnmZhbHNlXHJcbiAgICAgKiBAcGFyYW0gcGFyYW0wIHBhcmFtMC5mcm9tIOW+heenu+WKqOiKgueCueeahOWOn+acieeItuiKgueCuVxyXG4gICAgICogICAgICAgICAgICAgICBwYXJhbTAudG8g5b6F56e75Yqo6IqC54K555qE5paw54i26IqC54K5XHJcbiAgICAgKi9cclxuICAgIGNhbk1vdmVOb2RlKHsgZnJvbSwgdG8gfSkge1xyXG4gICAgICAgIC8vIHNhbWUgbm9kZVxyXG4gICAgICAgIGlmIChmcm9tLnBhcmVudE5vZGUgPT09IHRvLnBhcmVudE5vZGUgJiYgZnJvbS5pbmRleCA9PT0gdG8uaW5kZXgpIHtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICBcclxuICAgICAgICBjb25zdCBmcm9tQ2hpbGRyZW4gPSBmcm9tLnBhcmVudE5vZGUuY2hpbGRyZW47XHJcbiAgICAgICAgY29uc3QgZnJvbU5vZGUgPSBmcm9tQ2hpbGRyZW5bZnJvbS5pbmRleF07XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmV0dXJuICF0by5wYXJlbnROb2RlLmlzRGVzY2VuZGFudE9mKGZyb21Ob2RlKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOenu+WKqOiKgueCuVxyXG4gICAgICogQHBhcmFtIHBhcmFtMCBwYXJhbTAuZnJvbSDlvoXnp7vliqjoioLngrnnmoTljp/mnInniLboioLngrlcclxuICAgICAqICAgICAgICAgICAgICAgcGFyYW0wLnRvIOW+heenu+WKqOiKgueCueeahOaWsOeItuiKgueCuVxyXG4gICAgICovXHJcbiAgICBtb3ZlTm9kZSh7IGZyb20sIHRvIH0pIHtcclxuICAgICAgICBpZiAoIXRoaXMuY2FuTW92ZU5vZGUoeyBmcm9tICwgdG8gfSkpIHJldHVybjtcclxuICAgIFxyXG4gICAgICAgIGNvbnN0IGZyb21DaGlsZHJlbiA9IGZyb20ucGFyZW50Tm9kZS5jaGlsZHJlbkZpZWxkO1xyXG4gICAgXHJcbiAgICAgICAgLy8gSWYgbm9kZSBkb2Vzbid0IGhhdmUgY2hpbGRyZW4gLSBjcmVhdGUgY2hpbGRyZW4gYXJyYXlcclxuICAgICAgICBpZiAoIXRvLnBhcmVudE5vZGUuY2hpbGRyZW5GaWVsZCkge1xyXG4gICAgICAgICAgdG8ucGFyZW50Tm9kZS5jaGlsZHJlbkZpZWxkID0gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHRvQ2hpbGRyZW4gPSB0by5wYXJlbnROb2RlLmNoaWxkcmVuRmllbGQ7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvQXJyYXkvc3BsaWNlXHJcbiAgICAgICAgLy8gVGhlIHNwbGljZSgpIG1ldGhvZCBjaGFuZ2VzIHRoZSBjb250ZW50cyBvZiBhbiBhcnJheSBieSByZW1vdmluZyBleGlzdGluZyBlbGVtZW50cyBhbmQvb3IgYWRkaW5nIG5ldyBlbGVtZW50cy5cclxuICAgICAgICBjb25zdCBub2RlID0gZnJvbUNoaWxkcmVuLnNwbGljZShmcm9tLmluZGV4LCAxKVswXTtcclxuICAgIFxyXG4gICAgICAgIC8vIENvbXBlbnNhdGUgZm9yIGluZGV4IGlmIGFscmVhZHkgcmVtb3ZlZCBmcm9tIHBhcmVudDpcclxuICAgICAgICBsZXQgdG9JbmRleCA9IChmcm9tLnBhcmVudE5vZGUgPT09IHRvLnBhcmVudE5vZGUgJiYgdG8uaW5kZXggPiBmcm9tLmluZGV4KSA/IHRvLmluZGV4IC0gMSA6IHRvLmluZGV4O1xyXG4gICAgXHJcbiAgICAgICAgdG9DaGlsZHJlbi5zcGxpY2UodG9JbmRleCwgMCwgbm9kZSk7XHJcblxyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwidG9DaGlsZHJlbjpcIiArIHRvQ2hpbGRyZW4pO1xyXG5cclxuICAgICAgICAvLyBjb25zb2xlLmxvZyhcIkFmdGVyTW92ZU5vZGU6XCIgKyB0aGlzLnJvb3RzKTtcclxuICAgIFxyXG4gICAgICAgIHRoaXMudXBkYXRlKHRoaXMucm9vdHMpOy8vIOWunueOsG5vZGUgbW92ZWTlkI7vvIzph43mlrDliLfmlrDov5nmo7XmoJFcclxuICAgIFxyXG4gICAgICAgIHRoaXMuZmlyZUV2ZW50KHsgZXZlbnROYW1lOiBUUkVFX0VWRU5UUy5vbk1vdmVOb2RlLCBub2RlLCB0byB9KTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gVE9ETzogbW92ZSB0byBhIGRpZmZlcmVudCBzZXJ2aWNlOlxyXG4gICAgc2V0RHJhZ05vZGUoZHJhZ05vZGU6eyBwYXJlbnROb2RlOiBUcmVlTm9kZSwgaW5kZXg6IG51bWJlciB9KSB7XHJcbiAgICAgICAgdGhpcy5fZHJhZ05vZGUgPSBkcmFnTm9kZTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgZ2V0RHJhZ05vZGUoKTp7IHBhcmVudE5vZGU6IFRyZWVOb2RlLCBpbmRleDpudW1iZXIgfSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RyYWdOb2RlIHx8IHsgcGFyZW50Tm9kZTogbnVsbCwgaW5kZXg6IG51bGwgfTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgaXNEcmFnZ2luZygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXREcmFnTm9kZSgpLnBhcmVudE5vZGU7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHNldERyb3BMb2NhdGlvbihkcm9wTG9jYXRpb246IHsgY29tcG9uZW50OiBhbnksIHBhcmVudE5vZGU6IFRyZWVOb2RlLCBpbmRleDogbnVtYmVyIH0pIHtcclxuICAgICAgICB0aGlzLl9kcm9wTG9jYXRpb24gPSBkcm9wTG9jYXRpb247XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGdldERyb3BMb2NhdGlvbigpOiB7IGNvbXBvbmVudDogYW55LCBwYXJlbnROb2RlOiBUcmVlTm9kZSwgaW5kZXg6IG51bWJlciB9IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZHJvcExvY2F0aW9uIHx8IHtjb21wb25lbnQ6IG51bGwsIHBhcmVudE5vZGU6IG51bGwsIGluZGV4OiBudWxsfTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgaXNEcmFnZ2luZ092ZXIoY29tcG9uZW50KSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RHJvcExvY2F0aW9uKCkuY29tcG9uZW50ID09PSBjb21wb25lbnQ7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGNhbmNlbERyYWcoKSB7XHJcbiAgICAgICAgdGhpcy5zZXREcm9wTG9jYXRpb24obnVsbCk7XHJcbiAgICAgICAgdGhpcy5zZXREcmFnTm9kZShudWxsKTtcclxuICAgIH1cclxufSJdfQ==