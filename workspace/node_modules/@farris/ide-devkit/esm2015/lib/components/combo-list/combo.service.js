/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { BehaviorSubject, Subject } from 'rxjs';
export class ComboService {
    constructor() {
        this.innerData = [];
        this.selected$ = new Subject();
        this.isOpen$ = new BehaviorSubject(false);
        this.data$ = new BehaviorSubject('');
        // initData() {
        //     // this.loadDataTable(this.data || []);
        //     // switch (this.displayType) {
        //     //     case 'TreeList': {
        //     //         this.getData().subscribe(data => this.loadDataTree(data));
        //     //         break;
        //     //     }
        //     //     case 'LIST': {
        //     //         // List
        //     //         this.getData().subscribe(data => this.loadDataTable(data));
        //     //         break;
        //     //     }
        //     //     // case 'LOOKUPLIST': {
        //     //     //     // List
        //     //     //     this.getData().subscribe(data =>
        //     //     //         this.loadLookUpDataTable(data)
        //     //     //     );
        //     //     //     break;
        //     //     // }
        //     //     // case 'LOOKUPTREELIST': {
        //     //     //     // List
        //     //     //     this.getData().subscribe(data => this.loadLookUpDataTree(data));
        //     //     //     break;
        //     //     // }
        //     // }
        // }
        // getData(): Observable<any> {
        //     // if (this.uri) {
        //     //     const params = {};
        //     //     this.showLoading();
        //     //     if (this.comboHttp) {
        //     //         return this.comboHttp.getData(this.uri);
        //     //     } else {
        //     //         return this.http.get(this.uri);
        //     //     }
        //     // } else {
        //         if (this.data) {
        //             return of(this.data);
        //         } else {
        //             return of([]);
        //         }
        //     // }
        // }
        // loadDataTable(data: any) {
        //     if (data instanceof Array) {
        //         this.data = data;
        //     } else {
        //         this.data = data.returnValue;
        //     }
        //     this.loadData(this.data, this.selectedValues, (dataArr, val) => {
        //         // tslint:disable-next-line:triple-equals
        //         return dataArr.find(d => d[this.idField] + '' == val);
        //     });
        //     // this.closeLoading();
        // }
        // loadDataTree(data: any) {
        //     if (data instanceof Array) {
        //         this.data = data;
        //     } else {
        //         this.data = data.returnValue;
        //     }
        //     this.loadData(this.data, this.selectedValues, (dataArr, val) => {
        //         return eachData(dataArr, val, this.idField);
        //         function eachData(paramData, paramVal, idField) {
        //             let rtnData: any = '';
        //             paramData.find(d => {
        //                 // tslint:disable-next-line:triple-equals
        //                 if (d.data[idField] == paramVal) {
        //                     rtnData = d.data;
        //                     return true;
        //                 } else if (d.children && d.children.length) {
        //                     rtnData = eachData(d.children, paramVal, idField);
        //                 } else {
        //                     return false;
        //                 }
        //             });
        //             return rtnData;
        //         }
        //     });
        //     // this.closeLoading();
        // }
        // loadLookUpDataTable(resData: any) {
        //     if (resData.returnValue) {
        //         resData = resData.returnValue;
        //     }
        //     this.columns = resData.columns;
        //     this.pageInfo = resData.pageInfo;
        //     this.data = resData.items;
        //     this.loadData(this.data, this.selectedValues, (dataArr, val) => {
        //         // tslint:disable-next-line: triple-equals
        //         return dataArr.find(d => d[this.idField] + '' == val);
        //     });
        //     this.closeLoading();
        // }
        // loadLookUpDataTree(resData: any) {
        //     if (resData.returnValue) {
        //         resData = resData.returnValue;
        //     }
        //     this.columns = resData.columns;
        //     const treeInfo = resData.treeInfo;
        //     // tslint:disable-next-line: no-string-literal
        //     if (!treeInfo['treeDataIsInit']) {
        //         if (treeInfo.layerType.toLowerCase() === 'pathcode') {
        //             this.data = this.lookupUtils.makeTree(resData.items, treeInfo);
        //         } else {
        //             this.data = this.lookupUtils.makeTreeWithParentID(
        //                 resData.items,
        //                 '',
        //                 `${treeInfo.dataField}.${treeInfo.parentField}`,
        //                 this.idField
        //             );
        //         }
        //     }
        //     this.loadData(this.data, this.selectedValues, (dataArr, val) => {
        //         return eachData(dataArr, val, this.idField);
        //         function eachData(paramData, paramVal, idField) {
        //             let rtnData: any = '';
        //             paramData.find(d => {
        //                 // tslint:disable-next-line:triple-equals
        //                 if (d.data[idField] == paramVal) {
        //                     rtnData = d.data;
        //                     return true;
        //                 } else if (d.children && d.children.length) {
        //                     rtnData = eachData(d.children, paramVal, idField);
        //                 } else {
        //                     return false;
        //                 }
        //             });
        //             return rtnData;
        //         }
        //     });
        //     this.closeLoading();
        // }
        // private showLoading() {
        //     this.loading = this.loadingService.show();
        // }
        // closeLoading() {
        //     if (this.loading) {
        //         this.loading.close();
        //         this.loading = null;
        //     }
        // }
    }
    /**
     * @return {?}
     */
    get data() {
        return this.innerData;
    }
    /**
     * @param {?} val
     * @return {?}
     */
    set data(val) {
        this.innerData = val;
        this.data$.next(val);
    }
    // columns: any;
    // injectService() {
    //     if (this.injector && !this.comboHttp) {
    //         this.lookupUtils = this.injector.get(LookupUtils, null);
    //         if (this.displayType.indexOf('LOOKUP') > -1) {
    //             this.comboHttp = this.injector.get(ServerSideToken, null);
    //         } else {
    //             this.comboHttp = this.injector.get(ComboServerSideToken, null);
    //         }
    //     }
    // }
    /**
     * @param {?} value
     * @return {?}
     */
    toBoolean(value) {
        return value != null && `${value}` !== 'false';
    }
    /**
     * @param {?} data
     * @param {?=} index
     * @return {?}
     */
    selectItem(data, index) {
        this.isOpen$.next(false);
        this.selectedValue = data;
        this.selected$.next(this.selectedValue);
    }
    /**
     * @param {?} data
     * @return {?}
     */
    unSelectItem(data) {
        this.selectedValue = null;
        this.selected$.next(null);
    }
    /**
     * @param {?} id
     * @return {?}
     */
    isSelect(id) {
        return false;
    }
    // loadData(data: any, selectValues: string = '', callback) {
    //     if (data) {
    //         if (selectValues) {
    //             if (selectValues.split) {
    //                 // key 是字符串，可能是拼起来的
    //                 const selectedItems = selectValues.split(',').map(val => {
    //                     return callback(data, val);
    //                 });
    //
    //                 this.selections = selectedItems;
    //             } else {
    //                 // key不可split
    //                 this.selections = [selectValues];
    //             }
    //         } else {
    //             this.selections = [];
    //         }
    //         // this.selections$.next(this.selections);
    //         // const _data = this.initData(data);
    //         // this.updateState({...this._state, data: _data});
    //     } else {
    //         // this.updateState({ data: [], selections: [] });
    //     }
    // }
    // filterData(val: string, filed: any = 'text') {
    //     if (val) {
    //         const data = this.data
    //             ? this.data.filter(item => {
    //                 if (item[filed]) {
    //                     return String(item[filed]).indexOf(val) > -1;
    //                 } else if (item.data && item.data[filed]) {
    //                     return String(item.data[filed]).indexOf(val) > -1;
    //                 }
    //               })
    //             : [];
    //         this.data$.next(data);
    //     }
    // }
    /**
     * @return {?}
     */
    getSelected() {
        return this.selectedValue;
    }
    // filterSelections(displayText: string) {
    //     if (displayText && this.selections) {
    //         const selections = displayText
    //             .split(',')
    //             .map(val => {
    //                 return this.selections.find(d => d[this.textField] === val);
    //             })
    //             .filter(val => !!val);
    //         this.selectedValues = this.getValue(this.valueField, selections);
    //         this.selections = selections;
    //     }
    // }
    // clearSelections() {
    //     this.selections = [];
    // }
    /**
     * @param {?} prop
     * @param {?=} selections
     * @return {?}
     */
    getValue(prop, selections) {
        // selections = selections ? selections : this.selections;
        // if (selections && selections.length) {
        //     // if (this.mapFields) {
        //     //     const helpFields = Object.keys(this.mapFields);
        //     //     helpFields.forEach( (f: any) => {
        //     //         if (this.mapFields[f] === prop) {
        //     //             prop = f;
        //     //             return;
        //     //         }
        //     //     });
        //     // }
        //
        //     // if (selections.length === 1) {
        //     //     return this.getValueByObj(prop, selections[0]);
        //     // }
        //
        //     const tmp = selections
        //         .map(item => {
        //             return this.getValueByObj(prop, item);
        //         })
        //         .join(',');
        //     return tmp;
        // }
        if (this.selectedValue) {
            return this.getValueByObj(prop, this.selectedValue);
        }
        return '';
    }
    /**
     * @param {?} field
     * @param {?} data
     * @return {?}
     */
    getValueByObj(field, data) {
        if (!data) {
            return '';
        }
        /** @type {?} */
        let resultVal = '';
        if (field.indexOf('.') === -1) {
            resultVal = data[field];
        }
        else {
            resultVal = field.split('.').reduce((obj, key) => {
                if (obj) {
                    return obj[key];
                }
                else {
                    return null;
                }
            }, data);
        }
        return resultVal;
    }
}
ComboService.decorators = [
    { type: Injectable }
];
if (false) {
    /** @type {?} */
    ComboService.prototype.idField;
    /** @type {?} */
    ComboService.prototype.valueField;
    /** @type {?} */
    ComboService.prototype.textField;
    /** @type {?} */
    ComboService.prototype.mapFields;
    /**
     * @type {?}
     * @private
     */
    ComboService.prototype.innerData;
    /** @type {?} */
    ComboService.prototype.selectedValue;
    /** @type {?} */
    ComboService.prototype.selected$;
    /** @type {?} */
    ComboService.prototype.isOpen$;
    /** @type {?} */
    ComboService.prototype.data$;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tYm8uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvaWRlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2NvbWJvLWxpc3QvY29tYm8uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBWSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE9BQU8sRUFBa0IsTUFBTSxNQUFNLENBQUM7QUFLaEUsTUFBTSxPQUFPLFlBQVk7SUFEekI7UUFNWSxjQUFTLEdBQVEsRUFBRSxDQUFDO1FBUzVCLGNBQVMsR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDO1FBQy9CLFlBQU8sR0FBRyxJQUFJLGVBQWUsQ0FBVSxLQUFLLENBQUMsQ0FBQztRQUM5QyxVQUFLLEdBQUcsSUFBSSxlQUFlLENBQU0sRUFBRSxDQUFDLENBQUM7UUF5SXJDLGVBQWU7UUFDZiw4Q0FBOEM7UUFDOUMscUNBQXFDO1FBQ3JDLGdDQUFnQztRQUNoQyw0RUFBNEU7UUFDNUUsd0JBQXdCO1FBQ3hCLGVBQWU7UUFDZiw0QkFBNEI7UUFDNUIseUJBQXlCO1FBQ3pCLDZFQUE2RTtRQUM3RSx3QkFBd0I7UUFDeEIsZUFBZTtRQUNmLHFDQUFxQztRQUNyQyw0QkFBNEI7UUFDNUIscURBQXFEO1FBQ3JELHVEQUF1RDtRQUN2RCx1QkFBdUI7UUFDdkIsMkJBQTJCO1FBQzNCLGtCQUFrQjtRQUNsQix5Q0FBeUM7UUFDekMsNEJBQTRCO1FBQzVCLHFGQUFxRjtRQUNyRiwyQkFBMkI7UUFDM0Isa0JBQWtCO1FBQ2xCLFdBQVc7UUFDWCxJQUFJO1FBRUosK0JBQStCO1FBQy9CLHlCQUF5QjtRQUN6QixnQ0FBZ0M7UUFDaEMsaUNBQWlDO1FBQ2pDLG1DQUFtQztRQUNuQywwREFBMEQ7UUFDMUQsc0JBQXNCO1FBQ3RCLGlEQUFpRDtRQUNqRCxlQUFlO1FBQ2Ysa0JBQWtCO1FBQ2xCLDJCQUEyQjtR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LFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDM0I7YUFBTTtZQUNILFNBQVMsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtnQkFDN0MsSUFBSSxHQUFHLEVBQUU7b0JBQ0wsT0FBTyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ25CO3FCQUFNO29CQUNILE9BQU8sSUFBSSxDQUFDO2lCQUNmO1lBQ0wsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ1o7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNyQixDQUFDOzs7WUF4SkosVUFBVTs7OztJQUVQLCtCQUFnQjs7SUFDaEIsa0NBQW1COztJQUNuQixpQ0FBa0I7O0lBQ2xCLGlDQUE2Qzs7Ozs7SUFDN0MsaUNBQTRCOztJQVE1QixxQ0FBbUI7O0lBQ25CLGlDQUErQjs7SUFDL0IsK0JBQThDOztJQUM5Qyw2QkFBcUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIFN1YmplY3QsIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IGRlYm91bmNlVGltZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIENvbWJvU2VydmljZSB7XHJcbiAgICBpZEZpZWxkOiBzdHJpbmc7XHJcbiAgICB2YWx1ZUZpZWxkOiBzdHJpbmc7XHJcbiAgICB0ZXh0RmllbGQ6IHN0cmluZztcclxuICAgIG1hcEZpZWxkczogeyBbc291cmNlRmllbGQ6IHN0cmluZ106IHN0cmluZyB9O1xyXG4gICAgcHJpdmF0ZSBpbm5lckRhdGE6IGFueSA9IFtdO1xyXG4gICAgZ2V0IGRhdGEoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaW5uZXJEYXRhO1xyXG4gICAgfVxyXG4gICAgc2V0IGRhdGEodmFsKSB7XHJcbiAgICAgICAgdGhpcy5pbm5lckRhdGEgPSB2YWw7XHJcbiAgICAgICAgdGhpcy5kYXRhJC5uZXh0KHZhbCk7XHJcbiAgICB9XHJcbiAgICBzZWxlY3RlZFZhbHVlOiBhbnk7XHJcbiAgICBzZWxlY3RlZCQgPSBuZXcgU3ViamVjdDxhbnk+KCk7XHJcbiAgICBpc09wZW4kID0gbmV3IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPihmYWxzZSk7XHJcbiAgICBkYXRhJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8YW55PignJyk7XHJcbiAgICAvLyBjb2x1bW5zOiBhbnk7XHJcblxyXG4gICAgLy8gaW5qZWN0U2VydmljZSgpIHtcclxuICAgIC8vICAgICBpZiAodGhpcy5pbmplY3RvciAmJiAhdGhpcy5jb21ib0h0dHApIHtcclxuICAgIC8vICAgICAgICAgdGhpcy5sb29rdXBVdGlscyA9IHRoaXMuaW5qZWN0b3IuZ2V0KExvb2t1cFV0aWxzLCBudWxsKTtcclxuICAgIC8vICAgICAgICAgaWYgKHRoaXMuZGlzcGxheVR5cGUuaW5kZXhPZignTE9PS1VQJykgPiAtMSkge1xyXG4gICAgLy8gICAgICAgICAgICAgdGhpcy5jb21ib0h0dHAgPSB0aGlzLmluamVjdG9yLmdldChTZXJ2ZXJTaWRlVG9rZW4sIG51bGwpO1xyXG4gICAgLy8gICAgICAgICB9IGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgICAgdGhpcy5jb21ib0h0dHAgPSB0aGlzLmluamVjdG9yLmdldChDb21ib1NlcnZlclNpZGVUb2tlbiwgbnVsbCk7XHJcbiAgICAvLyAgICAgICAgIH1cclxuICAgIC8vICAgICB9XHJcbiAgICAvLyB9XHJcbiAgICB0b0Jvb2xlYW4odmFsdWU6IGFueSk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB2YWx1ZSAhPSBudWxsICYmIGAke3ZhbHVlfWAgIT09ICdmYWxzZSc7XHJcbiAgICB9XHJcbiAgICBzZWxlY3RJdGVtKGRhdGE6IGFueSwgaW5kZXg/OiBudW1iZXIpIHtcclxuICAgICAgICB0aGlzLmlzT3BlbiQubmV4dChmYWxzZSk7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RlZFZhbHVlID0gZGF0YTtcclxuICAgICAgICB0aGlzLnNlbGVjdGVkJC5uZXh0KHRoaXMuc2VsZWN0ZWRWYWx1ZSk7XHJcbiAgICB9XHJcbiAgICB1blNlbGVjdEl0ZW0oZGF0YTogYW55KSB7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RlZFZhbHVlID0gbnVsbDtcclxuICAgICAgICB0aGlzLnNlbGVjdGVkJC5uZXh0KG51bGwpO1xyXG4gICAgfVxyXG4gICAgaXNTZWxlY3QoaWQ6IGFueSkge1xyXG5cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gbG9hZERhdGEoZGF0YTogYW55LCBzZWxlY3RWYWx1ZXM6IHN0cmluZyA9ICcnLCBjYWxsYmFjaykge1xyXG4gICAgLy8gICAgIGlmIChkYXRhKSB7XHJcbiAgICAvLyAgICAgICAgIGlmIChzZWxlY3RWYWx1ZXMpIHtcclxuICAgIC8vICAgICAgICAgICAgIGlmIChzZWxlY3RWYWx1ZXMuc3BsaXQpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAvLyBrZXkg5piv5a2X56ym5Liy77yM5Y+v6IO95piv5ou86LW35p2l55qEXHJcbiAgICAvLyAgICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRJdGVtcyA9IHNlbGVjdFZhbHVlcy5zcGxpdCgnLCcpLm1hcCh2YWwgPT4ge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZGF0YSwgdmFsKTtcclxuICAgIC8vICAgICAgICAgICAgICAgICB9KTtcclxuICAgIC8vXHJcbiAgICAvLyAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3Rpb25zID0gc2VsZWN0ZWRJdGVtcztcclxuICAgIC8vICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgLy8ga2V55LiN5Y+vc3BsaXRcclxuICAgIC8vICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGlvbnMgPSBbc2VsZWN0VmFsdWVzXTtcclxuICAgIC8vICAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICAgfSBlbHNlIHtcclxuICAgIC8vICAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9ucyA9IFtdO1xyXG4gICAgLy8gICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgIC8vIHRoaXMuc2VsZWN0aW9ucyQubmV4dCh0aGlzLnNlbGVjdGlvbnMpO1xyXG4gICAgLy8gICAgICAgICAvLyBjb25zdCBfZGF0YSA9IHRoaXMuaW5pdERhdGEoZGF0YSk7XHJcbiAgICAvLyAgICAgICAgIC8vIHRoaXMudXBkYXRlU3RhdGUoey4uLnRoaXMuX3N0YXRlLCBkYXRhOiBfZGF0YX0pO1xyXG4gICAgLy8gICAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgIC8vIHRoaXMudXBkYXRlU3RhdGUoeyBkYXRhOiBbXSwgc2VsZWN0aW9uczogW10gfSk7XHJcbiAgICAvLyAgICAgfVxyXG4gICAgLy8gfVxyXG4gICAgLy8gZmlsdGVyRGF0YSh2YWw6IHN0cmluZywgZmlsZWQ6IGFueSA9ICd0ZXh0Jykge1xyXG4gICAgLy8gICAgIGlmICh2YWwpIHtcclxuICAgIC8vICAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YVxyXG4gICAgLy8gICAgICAgICAgICAgPyB0aGlzLmRhdGEuZmlsdGVyKGl0ZW0gPT4ge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIGlmIChpdGVtW2ZpbGVkXSkge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKGl0ZW1bZmlsZWRdKS5pbmRleE9mKHZhbCkgPiAtMTtcclxuICAgIC8vICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGl0ZW0uZGF0YSAmJiBpdGVtLmRhdGFbZmlsZWRdKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgIHJldHVybiBTdHJpbmcoaXRlbS5kYXRhW2ZpbGVkXSkuaW5kZXhPZih2YWwpID4gLTE7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICAgICAgICB9KVxyXG4gICAgLy8gICAgICAgICAgICAgOiBbXTtcclxuICAgIC8vICAgICAgICAgdGhpcy5kYXRhJC5uZXh0KGRhdGEpO1xyXG4gICAgLy8gICAgIH1cclxuICAgIC8vIH1cclxuICAgIGdldFNlbGVjdGVkKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNlbGVjdGVkVmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gZmlsdGVyU2VsZWN0aW9ucyhkaXNwbGF5VGV4dDogc3RyaW5nKSB7XHJcbiAgICAvLyAgICAgaWYgKGRpc3BsYXlUZXh0ICYmIHRoaXMuc2VsZWN0aW9ucykge1xyXG4gICAgLy8gICAgICAgICBjb25zdCBzZWxlY3Rpb25zID0gZGlzcGxheVRleHRcclxuICAgIC8vICAgICAgICAgICAgIC5zcGxpdCgnLCcpXHJcbiAgICAvLyAgICAgICAgICAgICAubWFwKHZhbCA9PiB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0aW9ucy5maW5kKGQgPT4gZFt0aGlzLnRleHRGaWVsZF0gPT09IHZhbCk7XHJcbiAgICAvLyAgICAgICAgICAgICB9KVxyXG4gICAgLy8gICAgICAgICAgICAgLmZpbHRlcih2YWwgPT4gISF2YWwpO1xyXG4gICAgLy8gICAgICAgICB0aGlzLnNlbGVjdGVkVmFsdWVzID0gdGhpcy5nZXRWYWx1ZSh0aGlzLnZhbHVlRmllbGQsIHNlbGVjdGlvbnMpO1xyXG4gICAgLy8gICAgICAgICB0aGlzLnNlbGVjdGlvbnMgPSBzZWxlY3Rpb25zO1xyXG4gICAgLy8gICAgIH1cclxuICAgIC8vIH1cclxuXHJcbiAgICAvLyBjbGVhclNlbGVjdGlvbnMoKSB7XHJcbiAgICAvLyAgICAgdGhpcy5zZWxlY3Rpb25zID0gW107XHJcbiAgICAvLyB9XHJcblxyXG4gICAgZ2V0VmFsdWUocHJvcDogc3RyaW5nLCBzZWxlY3Rpb25zPzogYW55KTogYW55IHtcclxuICAgICAgICAvLyBzZWxlY3Rpb25zID0gc2VsZWN0aW9ucyA/IHNlbGVjdGlvbnMgOiB0aGlzLnNlbGVjdGlvbnM7XHJcbiAgICAgICAgLy8gaWYgKHNlbGVjdGlvbnMgJiYgc2VsZWN0aW9ucy5sZW5ndGgpIHtcclxuICAgICAgICAvLyAgICAgLy8gaWYgKHRoaXMubWFwRmllbGRzKSB7XHJcbiAgICAgICAgLy8gICAgIC8vICAgICBjb25zdCBoZWxwRmllbGRzID0gT2JqZWN0LmtleXModGhpcy5tYXBGaWVsZHMpO1xyXG4gICAgICAgIC8vICAgICAvLyAgICAgaGVscEZpZWxkcy5mb3JFYWNoKCAoZjogYW55KSA9PiB7XHJcbiAgICAgICAgLy8gICAgIC8vICAgICAgICAgaWYgKHRoaXMubWFwRmllbGRzW2ZdID09PSBwcm9wKSB7XHJcbiAgICAgICAgLy8gICAgIC8vICAgICAgICAgICAgIHByb3AgPSBmO1xyXG4gICAgICAgIC8vICAgICAvLyAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgLy8gICAgIC8vICAgICAgICAgfVxyXG4gICAgICAgIC8vICAgICAvLyAgICAgfSk7XHJcbiAgICAgICAgLy8gICAgIC8vIH1cclxuICAgICAgICAvL1xyXG4gICAgICAgIC8vICAgICAvLyBpZiAoc2VsZWN0aW9ucy5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICAvLyAgICAgLy8gICAgIHJldHVybiB0aGlzLmdldFZhbHVlQnlPYmoocHJvcCwgc2VsZWN0aW9uc1swXSk7XHJcbiAgICAgICAgLy8gICAgIC8vIH1cclxuICAgICAgICAvL1xyXG4gICAgICAgIC8vICAgICBjb25zdCB0bXAgPSBzZWxlY3Rpb25zXHJcbiAgICAgICAgLy8gICAgICAgICAubWFwKGl0ZW0gPT4ge1xyXG4gICAgICAgIC8vICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFZhbHVlQnlPYmoocHJvcCwgaXRlbSk7XHJcbiAgICAgICAgLy8gICAgICAgICB9KVxyXG4gICAgICAgIC8vICAgICAgICAgLmpvaW4oJywnKTtcclxuICAgICAgICAvLyAgICAgcmV0dXJuIHRtcDtcclxuICAgICAgICAvLyB9XHJcbiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWRWYWx1ZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRWYWx1ZUJ5T2JqKHByb3AsIHRoaXMuc2VsZWN0ZWRWYWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIGdldFZhbHVlQnlPYmooZmllbGQ6IHN0cmluZywgZGF0YTogYW55KSB7XHJcbiAgICAgICAgaWYgKCFkYXRhKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAnJztcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHJlc3VsdFZhbCA9ICcnO1xyXG4gICAgICAgIGlmIChmaWVsZC5pbmRleE9mKCcuJykgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdFZhbCA9IGRhdGFbZmllbGRdO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJlc3VsdFZhbCA9IGZpZWxkLnNwbGl0KCcuJykucmVkdWNlKChvYmosIGtleSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKG9iaikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmpba2V5XTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sIGRhdGEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0VmFsO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGluaXREYXRhKCkge1xyXG4gICAgLy8gICAgIC8vIHRoaXMubG9hZERhdGFUYWJsZSh0aGlzLmRhdGEgfHwgW10pO1xyXG4gICAgLy8gICAgIC8vIHN3aXRjaCAodGhpcy5kaXNwbGF5VHlwZSkge1xyXG4gICAgLy8gICAgIC8vICAgICBjYXNlICdUcmVlTGlzdCc6IHtcclxuICAgIC8vICAgICAvLyAgICAgICAgIHRoaXMuZ2V0RGF0YSgpLnN1YnNjcmliZShkYXRhID0+IHRoaXMubG9hZERhdGFUcmVlKGRhdGEpKTtcclxuICAgIC8vICAgICAvLyAgICAgICAgIGJyZWFrO1xyXG4gICAgLy8gICAgIC8vICAgICB9XHJcbiAgICAvLyAgICAgLy8gICAgIGNhc2UgJ0xJU1QnOiB7XHJcbiAgICAvLyAgICAgLy8gICAgICAgICAvLyBMaXN0XHJcbiAgICAvLyAgICAgLy8gICAgICAgICB0aGlzLmdldERhdGEoKS5zdWJzY3JpYmUoZGF0YSA9PiB0aGlzLmxvYWREYXRhVGFibGUoZGF0YSkpO1xyXG4gICAgLy8gICAgIC8vICAgICAgICAgYnJlYWs7XHJcbiAgICAvLyAgICAgLy8gICAgIH1cclxuICAgIC8vICAgICAvLyAgICAgLy8gY2FzZSAnTE9PS1VQTElTVCc6IHtcclxuICAgIC8vICAgICAvLyAgICAgLy8gICAgIC8vIExpc3RcclxuICAgIC8vICAgICAvLyAgICAgLy8gICAgIHRoaXMuZ2V0RGF0YSgpLnN1YnNjcmliZShkYXRhID0+XHJcbiAgICAvLyAgICAgLy8gICAgIC8vICAgICAgICAgdGhpcy5sb2FkTG9va1VwRGF0YVRhYmxlKGRhdGEpXHJcbiAgICAvLyAgICAgLy8gICAgIC8vICAgICApO1xyXG4gICAgLy8gICAgIC8vICAgICAvLyAgICAgYnJlYWs7XHJcbiAgICAvLyAgICAgLy8gICAgIC8vIH1cclxuICAgIC8vICAgICAvLyAgICAgLy8gY2FzZSAnTE9PS1VQVFJFRUxJU1QnOiB7XHJcbiAgICAvLyAgICAgLy8gICAgIC8vICAgICAvLyBMaXN0XHJcbiAgICAvLyAgICAgLy8gICAgIC8vICAgICB0aGlzLmdldERhdGEoKS5zdWJzY3JpYmUoZGF0YSA9PiB0aGlzLmxvYWRMb29rVXBEYXRhVHJlZShkYXRhKSk7XHJcbiAgICAvLyAgICAgLy8gICAgIC8vICAgICBicmVhaztcclxuICAgIC8vICAgICAvLyAgICAgLy8gfVxyXG4gICAgLy8gICAgIC8vIH1cclxuICAgIC8vIH1cclxuXHJcbiAgICAvLyBnZXREYXRhKCk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICAvLyAgICAgLy8gaWYgKHRoaXMudXJpKSB7XHJcbiAgICAvLyAgICAgLy8gICAgIGNvbnN0IHBhcmFtcyA9IHt9O1xyXG4gICAgLy8gICAgIC8vICAgICB0aGlzLnNob3dMb2FkaW5nKCk7XHJcbiAgICAvLyAgICAgLy8gICAgIGlmICh0aGlzLmNvbWJvSHR0cCkge1xyXG4gICAgLy8gICAgIC8vICAgICAgICAgcmV0dXJuIHRoaXMuY29tYm9IdHRwLmdldERhdGEodGhpcy51cmkpO1xyXG4gICAgLy8gICAgIC8vICAgICB9IGVsc2Uge1xyXG4gICAgLy8gICAgIC8vICAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodGhpcy51cmkpO1xyXG4gICAgLy8gICAgIC8vICAgICB9XHJcbiAgICAvLyAgICAgLy8gfSBlbHNlIHtcclxuICAgIC8vICAgICAgICAgaWYgKHRoaXMuZGF0YSkge1xyXG4gICAgLy8gICAgICAgICAgICAgcmV0dXJuIG9mKHRoaXMuZGF0YSk7XHJcbiAgICAvLyAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgICAgICByZXR1cm4gb2YoW10pO1xyXG4gICAgLy8gICAgICAgICB9XHJcbiAgICAvLyAgICAgLy8gfVxyXG4gICAgLy8gfVxyXG4gICAgLy8gbG9hZERhdGFUYWJsZShkYXRhOiBhbnkpIHtcclxuICAgIC8vICAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIEFycmF5KSB7XHJcbiAgICAvLyAgICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7XHJcbiAgICAvLyAgICAgfSBlbHNlIHtcclxuICAgIC8vICAgICAgICAgdGhpcy5kYXRhID0gZGF0YS5yZXR1cm5WYWx1ZTtcclxuICAgIC8vICAgICB9XHJcbiAgICAvLyAgICAgdGhpcy5sb2FkRGF0YSh0aGlzLmRhdGEsIHRoaXMuc2VsZWN0ZWRWYWx1ZXMsIChkYXRhQXJyLCB2YWwpID0+IHtcclxuICAgIC8vICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnRyaXBsZS1lcXVhbHNcclxuICAgIC8vICAgICAgICAgcmV0dXJuIGRhdGFBcnIuZmluZChkID0+IGRbdGhpcy5pZEZpZWxkXSArICcnID09IHZhbCk7XHJcbiAgICAvLyAgICAgfSk7XHJcbiAgICAvLyAgICAgLy8gdGhpcy5jbG9zZUxvYWRpbmcoKTtcclxuICAgIC8vIH1cclxuICAgIC8vIGxvYWREYXRhVHJlZShkYXRhOiBhbnkpIHtcclxuICAgIC8vICAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIEFycmF5KSB7XHJcbiAgICAvLyAgICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7XHJcbiAgICAvLyAgICAgfSBlbHNlIHtcclxuICAgIC8vICAgICAgICAgdGhpcy5kYXRhID0gZGF0YS5yZXR1cm5WYWx1ZTtcclxuICAgIC8vICAgICB9XHJcbiAgICAvLyAgICAgdGhpcy5sb2FkRGF0YSh0aGlzLmRhdGEsIHRoaXMuc2VsZWN0ZWRWYWx1ZXMsIChkYXRhQXJyLCB2YWwpID0+IHtcclxuICAgIC8vICAgICAgICAgcmV0dXJuIGVhY2hEYXRhKGRhdGFBcnIsIHZhbCwgdGhpcy5pZEZpZWxkKTtcclxuICAgIC8vICAgICAgICAgZnVuY3Rpb24gZWFjaERhdGEocGFyYW1EYXRhLCBwYXJhbVZhbCwgaWRGaWVsZCkge1xyXG4gICAgLy8gICAgICAgICAgICAgbGV0IHJ0bkRhdGE6IGFueSA9ICcnO1xyXG4gICAgLy8gICAgICAgICAgICAgcGFyYW1EYXRhLmZpbmQoZCA9PiB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnRyaXBsZS1lcXVhbHNcclxuICAgIC8vICAgICAgICAgICAgICAgICBpZiAoZC5kYXRhW2lkRmllbGRdID09IHBhcmFtVmFsKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgIHJ0bkRhdGEgPSBkLmRhdGE7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZC5jaGlsZHJlbiAmJiBkLmNoaWxkcmVuLmxlbmd0aCkge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICBydG5EYXRhID0gZWFjaERhdGEoZC5jaGlsZHJlbiwgcGFyYW1WYWwsIGlkRmllbGQpO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIC8vICAgICAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgICAgICB9KTtcclxuICAgIC8vICAgICAgICAgICAgIHJldHVybiBydG5EYXRhO1xyXG4gICAgLy8gICAgICAgICB9XHJcbiAgICAvLyAgICAgfSk7XHJcbiAgICAvLyAgICAgLy8gdGhpcy5jbG9zZUxvYWRpbmcoKTtcclxuICAgIC8vIH1cclxuICAgIC8vIGxvYWRMb29rVXBEYXRhVGFibGUocmVzRGF0YTogYW55KSB7XHJcbiAgICAvLyAgICAgaWYgKHJlc0RhdGEucmV0dXJuVmFsdWUpIHtcclxuICAgIC8vICAgICAgICAgcmVzRGF0YSA9IHJlc0RhdGEucmV0dXJuVmFsdWU7XHJcbiAgICAvLyAgICAgfVxyXG4gICAgLy8gICAgIHRoaXMuY29sdW1ucyA9IHJlc0RhdGEuY29sdW1ucztcclxuICAgIC8vICAgICB0aGlzLnBhZ2VJbmZvID0gcmVzRGF0YS5wYWdlSW5mbztcclxuICAgIC8vICAgICB0aGlzLmRhdGEgPSByZXNEYXRhLml0ZW1zO1xyXG4gICAgLy8gICAgIHRoaXMubG9hZERhdGEodGhpcy5kYXRhLCB0aGlzLnNlbGVjdGVkVmFsdWVzLCAoZGF0YUFyciwgdmFsKSA9PiB7XHJcbiAgICAvLyAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogdHJpcGxlLWVxdWFsc1xyXG4gICAgLy8gICAgICAgICByZXR1cm4gZGF0YUFyci5maW5kKGQgPT4gZFt0aGlzLmlkRmllbGRdICsgJycgPT0gdmFsKTtcclxuICAgIC8vICAgICB9KTtcclxuICAgIC8vICAgICB0aGlzLmNsb3NlTG9hZGluZygpO1xyXG4gICAgLy8gfVxyXG4gICAgLy8gbG9hZExvb2tVcERhdGFUcmVlKHJlc0RhdGE6IGFueSkge1xyXG4gICAgLy8gICAgIGlmIChyZXNEYXRhLnJldHVyblZhbHVlKSB7XHJcbiAgICAvLyAgICAgICAgIHJlc0RhdGEgPSByZXNEYXRhLnJldHVyblZhbHVlO1xyXG4gICAgLy8gICAgIH1cclxuICAgIC8vICAgICB0aGlzLmNvbHVtbnMgPSByZXNEYXRhLmNvbHVtbnM7XHJcbiAgICAvLyAgICAgY29uc3QgdHJlZUluZm8gPSByZXNEYXRhLnRyZWVJbmZvO1xyXG4gICAgLy8gICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tc3RyaW5nLWxpdGVyYWxcclxuICAgIC8vICAgICBpZiAoIXRyZWVJbmZvWyd0cmVlRGF0YUlzSW5pdCddKSB7XHJcbiAgICAvLyAgICAgICAgIGlmICh0cmVlSW5mby5sYXllclR5cGUudG9Mb3dlckNhc2UoKSA9PT0gJ3BhdGhjb2RlJykge1xyXG4gICAgLy8gICAgICAgICAgICAgdGhpcy5kYXRhID0gdGhpcy5sb29rdXBVdGlscy5tYWtlVHJlZShyZXNEYXRhLml0ZW1zLCB0cmVlSW5mbyk7XHJcbiAgICAvLyAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgICAgICB0aGlzLmRhdGEgPSB0aGlzLmxvb2t1cFV0aWxzLm1ha2VUcmVlV2l0aFBhcmVudElEKFxyXG4gICAgLy8gICAgICAgICAgICAgICAgIHJlc0RhdGEuaXRlbXMsXHJcbiAgICAvLyAgICAgICAgICAgICAgICAgJycsXHJcbiAgICAvLyAgICAgICAgICAgICAgICAgYCR7dHJlZUluZm8uZGF0YUZpZWxkfS4ke3RyZWVJbmZvLnBhcmVudEZpZWxkfWAsXHJcbiAgICAvLyAgICAgICAgICAgICAgICAgdGhpcy5pZEZpZWxkXHJcbiAgICAvLyAgICAgICAgICAgICApO1xyXG4gICAgLy8gICAgICAgICB9XHJcbiAgICAvLyAgICAgfVxyXG4gICAgLy8gICAgIHRoaXMubG9hZERhdGEodGhpcy5kYXRhLCB0aGlzLnNlbGVjdGVkVmFsdWVzLCAoZGF0YUFyciwgdmFsKSA9PiB7XHJcbiAgICAvLyAgICAgICAgIHJldHVybiBlYWNoRGF0YShkYXRhQXJyLCB2YWwsIHRoaXMuaWRGaWVsZCk7XHJcbiAgICAvLyAgICAgICAgIGZ1bmN0aW9uIGVhY2hEYXRhKHBhcmFtRGF0YSwgcGFyYW1WYWwsIGlkRmllbGQpIHtcclxuICAgIC8vICAgICAgICAgICAgIGxldCBydG5EYXRhOiBhbnkgPSAnJztcclxuICAgIC8vICAgICAgICAgICAgIHBhcmFtRGF0YS5maW5kKGQgPT4ge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTp0cmlwbGUtZXF1YWxzXHJcbiAgICAvLyAgICAgICAgICAgICAgICAgaWYgKGQuZGF0YVtpZEZpZWxkXSA9PSBwYXJhbVZhbCkge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICBydG5EYXRhID0gZC5kYXRhO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIC8vICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGQuY2hpbGRyZW4gJiYgZC5jaGlsZHJlbi5sZW5ndGgpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgcnRuRGF0YSA9IGVhY2hEYXRhKGQuY2hpbGRyZW4sIHBhcmFtVmFsLCBpZEZpZWxkKTtcclxuICAgIC8vICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICAgICAgfSk7XHJcbiAgICAvLyAgICAgICAgICAgICByZXR1cm4gcnRuRGF0YTtcclxuICAgIC8vICAgICAgICAgfVxyXG4gICAgLy8gICAgIH0pO1xyXG4gICAgLy8gICAgIHRoaXMuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAvLyB9XHJcbiAgICAvLyBwcml2YXRlIHNob3dMb2FkaW5nKCkge1xyXG4gICAgLy8gICAgIHRoaXMubG9hZGluZyA9IHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xyXG4gICAgLy8gfVxyXG4gICAgLy8gY2xvc2VMb2FkaW5nKCkge1xyXG4gICAgLy8gICAgIGlmICh0aGlzLmxvYWRpbmcpIHtcclxuICAgIC8vICAgICAgICAgdGhpcy5sb2FkaW5nLmNsb3NlKCk7XHJcbiAgICAvLyAgICAgICAgIHRoaXMubG9hZGluZyA9IG51bGw7XHJcbiAgICAvLyAgICAgfVxyXG4gICAgLy8gfVxyXG59XHJcbiJdfQ==