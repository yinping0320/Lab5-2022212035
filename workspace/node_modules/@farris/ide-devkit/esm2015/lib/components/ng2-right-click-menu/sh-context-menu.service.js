/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { Overlay } from '@angular/cdk/overlay';
import { TemplatePortal } from '@angular/cdk/portal';
import { fromEvent } from 'rxjs/observable/fromEvent';
export class ShContextMenuService {
    /**
     * @param {?} overlay
     */
    constructor(overlay) {
        this.overlay = overlay;
        this.activeOverlays = [];
    }
    /**
     * @param {?} ctxEvent
     * @return {?}
     */
    openMenu(ctxEvent) {
        this.closeCurrentOverlays();
        const { menu, mouseEvent, targetElement, data } = ctxEvent;
        this.activeMenu = menu;
        mouseEvent.preventDefault();
        mouseEvent.stopPropagation();
        this.overrideGetBoundingClientRect(targetElement, mouseEvent);
        /** @type {?} */
        const scrollStrategy = this.buildCloseScrollStrategy();
        /** @type {?} */
        const positionStrategy = this.buildConnectedPositionStrategy(targetElement);
        this.attachContextToItems(menu, data);
        /** @type {?} */
        const overlayRef = this.createAndAttachOverlay(positionStrategy, scrollStrategy, menu, true);
        this.attachOverlayRef(menu, overlayRef);
        this.registerBackdropEvents(overlayRef);
    }
    /**
     * @param {?} ctxEvent
     * @return {?}
     */
    openSubMenu(ctxEvent) {
        const { menu, mouseEvent, targetElement, data, parentMenu } = ctxEvent;
        mouseEvent.preventDefault();
        mouseEvent.stopPropagation();
        /** @type {?} */
        const scrollStrategy = this.buildCloseScrollStrategy();
        /** @type {?} */
        const positionStrategy = this.buildConnectedPositionStrategyForSubMenu(targetElement);
        /** @type {?} */
        const overlayRef = this.createAndAttachOverlay(positionStrategy, scrollStrategy, menu, false);
        this.attachContextToItems(menu, data);
        this.attachThisContext(menu, parentMenu);
        this.attachOverlayRef(menu, overlayRef);
    }
    /**
     * @return {?}
     */
    destroy() {
        this.closeCurrentOverlays();
        this.backDropSub.unsubscribe();
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.destroy();
    }
    /**
     * @param {?} menu
     * @return {?}
     */
    closeSubMenus(menu) {
        /** @type {?} */
        const itemsWithSubMenus = menu
            .menuItems
            .filter(i => !!i.subMenu && !!i.subMenu.overlayRef);
        if (itemsWithSubMenus.length) {
            itemsWithSubMenus.forEach(sm => this.closeSubMenus(sm.subMenu));
            /** @type {?} */
            const overlayRefs = itemsWithSubMenus
                .map(i => i.subMenu.overlayRef);
            overlayRefs.forEach(r => r.dispose());
        }
    }
    /**
     * @private
     * @param {?} overlayRef
     * @return {?}
     */
    registerBackdropEvents(overlayRef) {
        /** @type {?} */
        const elm = overlayRef.backdropElement;
        this.backDropSub = fromEvent(elm, 'mousedown')
            .subscribe(this.closeCurrentOverlays.bind(this));
    }
    /**
     * @private
     * @param {?} positionStrategy
     * @param {?} scrollStrategy
     * @param {?} menu
     * @param {?=} hasBackdrop
     * @return {?}
     */
    createAndAttachOverlay(positionStrategy, scrollStrategy, menu, hasBackdrop = true) {
        /** @type {?} */
        const overlayRef = this.overlay.create({
            positionStrategy,
            scrollStrategy,
            hasBackdrop: hasBackdrop,
            backdropClass: 'sh-backdrop'
        });
        /*
             TODO: try passing the TemplatePortal context (data)
             and then injecting it to the *ngTemplateOutlet in the component template
            */
        /** @type {?} */
        const menuPortal = new TemplatePortal(menu.menuTemplate, menu.menuContainer);
        overlayRef.attach(menuPortal);
        this.activeOverlays.push(overlayRef);
        return overlayRef;
    }
    /**
     * @private
     * @return {?}
     */
    buildCloseScrollStrategy() {
        return this.overlay.scrollStrategies.close();
    }
    /**
     * @private
     * @param {?} elm
     * @return {?}
     */
    buildConnectedPositionStrategy(elm) {
        return this
            .overlay
            .position()
            .connectedTo(elm, { originX: 'start', originY: 'bottom' }, { overlayX: 'start', overlayY: 'top' })
            .withFallbackPosition({ originX: 'start', originY: 'top' }, { overlayX: 'start', overlayY: 'bottom' })
            .withFallbackPosition({ originX: 'end', originY: 'top' }, { overlayX: 'start', overlayY: 'top' })
            .withFallbackPosition({ originX: 'start', originY: 'top' }, { overlayX: 'end', overlayY: 'top' })
            .withFallbackPosition({ originX: 'end', originY: 'center' }, { overlayX: 'start', overlayY: 'center' })
            .withFallbackPosition({ originX: 'start', originY: 'center' }, { overlayX: 'end', overlayY: 'center' });
    }
    /**
     * @private
     * @param {?} elm
     * @return {?}
     */
    buildConnectedPositionStrategyForSubMenu(elm) {
        return this
            .overlay
            .position()
            .connectedTo(elm, { originX: 'end', originY: 'top' }, { overlayX: 'start', overlayY: 'top' })
            .withFallbackPosition({ originX: 'start', originY: 'top' }, { overlayX: 'end', overlayY: 'top' })
            .withFallbackPosition({ originX: 'end', originY: 'bottom' }, { overlayX: 'start', overlayY: 'bottom' })
            .withFallbackPosition({ originX: 'start', originY: 'bottom' }, { overlayX: 'end', overlayY: 'bottom' });
    }
    /*
        we need to override getBoundingClientRect() to return the position of the menu.
        this is done because @angular/cdk use this function internally to determine where the overlay should be positioned
        https://github.com/angular/material2/blob/master/src/cdk/overlay/position/connected-position-strategy.ts#L288
       */
    /**
     * @private
     * @param {?} elm
     * @param {?} event
     * @return {?}
     */
    overrideGetBoundingClientRect(elm, event) {
        const { clientX, clientY } = event;
        elm.nativeElement.getBoundingClientRect = () => {
            return {
                bottom: clientY,
                height: 0,
                left: clientX,
                right: clientX,
                top: clientY,
                width: 0
            };
        };
    }
    /**
     * @private
     * @return {?}
     */
    closeCurrentOverlays() {
        this.activeOverlays.forEach((o) => {
            o.detach();
            o.dispose();
        });
        this.activeOverlays = [];
        // TODO: create close subject and emit.
        // subscribe in component
        if (this.activeMenu) {
            this.activeMenu.close();
        }
    }
    /**
     * @private
     * @param {?} menu
     * @param {?} data
     * @return {?}
     */
    attachContextToItems(menu, data) {
        menu.menuItems.forEach(i => i.context.$implicit = data);
    }
    /**
     * @private
     * @param {?} menu
     * @param {?} parentMenu
     * @return {?}
     */
    attachThisContext(menu, parentMenu) {
        menu.thisContext = parentMenu.thisContext;
    }
    /**
     * @private
     * @param {?} menu
     * @param {?} overlayRef
     * @return {?}
     */
    attachOverlayRef(menu, overlayRef) {
        menu.overlayRef = overlayRef;
    }
}
ShContextMenuService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ShContextMenuService.ctorParameters = () => [
    { type: Overlay }
];
if (false) {
    /** @type {?} */
    ShContextMenuService.prototype.activeOverlays;
    /** @type {?} */
    ShContextMenuService.prototype.backDropSub;
    /** @type {?} */
    ShContextMenuService.prototype.activeMenu;
    /**
     * @type {?}
     * @private
     */
    ShContextMenuService.prototype.overlay;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2gtY29udGV4dC1tZW51LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2lkZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9uZzItcmlnaHQtY2xpY2stbWVudS9zaC1jb250ZXh0LW1lbnUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFhLFVBQVUsRUFBWSxNQUFNLGVBQWUsQ0FBQztBQUVoRSxPQUFPLEVBQXNCLE9BQU8sRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ2xFLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUluRCxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sMkJBQTJCLENBQUM7QUFJcEQsTUFBTSxPQUFPLG9CQUFvQjs7OztJQU0vQixZQUFvQixPQUFnQjtRQUFoQixZQUFPLEdBQVAsT0FBTyxDQUFTO1FBTHBDLG1CQUFjLEdBQWlCLEVBQUUsQ0FBQztJQU1sQyxDQUFDOzs7OztJQUVELFFBQVEsQ0FBQyxRQUE0QjtRQUNuQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztjQUN0QixFQUFDLElBQUksRUFBRSxVQUFVLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBQyxHQUFHLFFBQVE7UUFFeEQsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7UUFFdkIsVUFBVSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQzVCLFVBQVUsQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUU3QixJQUFJLENBQUMsNkJBQTZCLENBQUMsYUFBYSxFQUFFLFVBQVUsQ0FBQyxDQUFDOztjQUV4RCxjQUFjLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixFQUFFOztjQUNoRCxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsOEJBQThCLENBQUMsYUFBYSxDQUFDO1FBRTNFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7O2NBRWhDLFVBQVUsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsZ0JBQWdCLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUM7UUFDNUYsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQztRQUV4QyxJQUFJLENBQUMsc0JBQXNCLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDMUMsQ0FBQzs7Ozs7SUFFRCxXQUFXLENBQUMsUUFBK0I7Y0FDbkMsRUFBQyxJQUFJLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFDLEdBQUcsUUFBUTtRQUVwRSxVQUFVLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDNUIsVUFBVSxDQUFDLGVBQWUsRUFBRSxDQUFDOztjQUV2QixjQUFjLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixFQUFFOztjQUNoRCxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsd0NBQXdDLENBQUMsYUFBYSxDQUFDOztjQUMvRSxVQUFVLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLGdCQUFnQixFQUFFLGNBQWMsRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDO1FBRTdGLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDdEMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQztRQUN6QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQzFDLENBQUM7Ozs7SUFFRCxPQUFPO1FBQ0wsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNqQyxDQUFDOzs7O0lBRUQsV0FBVztRQUNULElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNqQixDQUFDOzs7OztJQUVELGFBQWEsQ0FBQyxJQUE0Qjs7Y0FDbEMsaUJBQWlCLEdBQUcsSUFBSTthQUMzQixTQUFTO2FBQ1QsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDO1FBRXJELElBQUksaUJBQWlCLENBQUMsTUFBTSxFQUFFO1lBQzVCLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7O2tCQUUxRCxXQUFXLEdBQUcsaUJBQWlCO2lCQUNsQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQztZQUVqQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7U0FDdkM7SUFDSCxDQUFDOzs7Ozs7SUFFTyxzQkFBc0IsQ0FBQyxVQUFzQjs7Y0FDN0MsR0FBRyxHQUFHLFVBQVUsQ0FBQyxlQUFlO1FBRXRDLElBQUksQ0FBQyxXQUFXLEdBQUcsU0FBUyxDQUFDLEdBQUcsRUFBRSxXQUFXLENBQUM7YUFDM0MsU0FBUyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUNyRCxDQUFDOzs7Ozs7Ozs7SUFFTyxzQkFBc0IsQ0FBQyxnQkFBMkMsRUFDM0MsY0FBbUMsRUFDbkMsSUFBNEIsRUFDNUIsY0FBdUIsSUFBSTs7Y0FFbEQsVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDO1lBQ3JDLGdCQUFnQjtZQUNoQixjQUFjO1lBQ2QsV0FBVyxFQUFFLFdBQVc7WUFDeEIsYUFBYSxFQUFFLGFBQWE7U0FDN0IsQ0FBQzs7Ozs7O2NBTUksVUFBVSxHQUFHLElBQUksY0FBYyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQztRQUM1RSxVQUFVLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRTlCLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRXJDLE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7Ozs7O0lBRU8sd0JBQXdCO1FBQzlCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUMvQyxDQUFDOzs7Ozs7SUFFTyw4QkFBOEIsQ0FBQyxHQUFlO1FBQ3BELE9BQU8sSUFBSTthQUNSLE9BQU87YUFDUCxRQUFRLEVBQUU7YUFDVixXQUFXLENBQUMsR0FBRyxFQUNkLEVBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFDLEVBQ3JDLEVBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFDLENBQUM7YUFDdEMsb0JBQW9CLENBQ25CLEVBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFDLEVBQ2xDLEVBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFDLENBQUM7YUFDekMsb0JBQW9CLENBQ25CLEVBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFDLEVBQ2hDLEVBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFDLENBQUM7YUFDdEMsb0JBQW9CLENBQ25CLEVBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFDLEVBQ2xDLEVBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFDLENBQUM7YUFDcEMsb0JBQW9CLENBQ25CLEVBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFDLEVBQ25DLEVBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFDLENBQUM7YUFDekMsb0JBQW9CLENBQ25CLEVBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFDLEVBQ3JDLEVBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFDLENBQUMsQ0FBQztJQUM3QyxDQUFDOzs7Ozs7SUFFTyx3Q0FBd0MsQ0FBQyxHQUFlO1FBQzlELE9BQU8sSUFBSTthQUNSLE9BQU87YUFDUCxRQUFRLEVBQUU7YUFDVixXQUFXLENBQUMsR0FBRyxFQUNkLEVBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFDLEVBQ2hDLEVBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFDLENBQUM7YUFDdEMsb0JBQW9CLENBQ25CLEVBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFDLEVBQ2xDLEVBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFDLENBQUM7YUFDcEMsb0JBQW9CLENBQ25CLEVBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFDLEVBQ25DLEVBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFDLENBQUM7YUFDekMsb0JBQW9CLENBQ25CLEVBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFDLEVBQ3JDLEVBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFDLENBQUMsQ0FBQztJQUM3QyxDQUFDOzs7Ozs7Ozs7Ozs7SUFPTyw2QkFBNkIsQ0FBQyxHQUFlLEVBQUUsS0FBaUI7Y0FDaEUsRUFBQyxPQUFPLEVBQUUsT0FBTyxFQUFDLEdBQUcsS0FBSztRQUVoQyxHQUFHLENBQUMsYUFBYSxDQUFDLHFCQUFxQixHQUFHLEdBQWUsRUFBRTtZQUN6RCxPQUFPO2dCQUNMLE1BQU0sRUFBRSxPQUFPO2dCQUNmLE1BQU0sRUFBRSxDQUFDO2dCQUNULElBQUksRUFBRSxPQUFPO2dCQUNiLEtBQUssRUFBRSxPQUFPO2dCQUNkLEdBQUcsRUFBRSxPQUFPO2dCQUNaLEtBQUssRUFBRSxDQUFDO2FBQ1QsQ0FBQztRQUNKLENBQUMsQ0FBQztJQUNKLENBQUM7Ozs7O0lBRU8sb0JBQW9CO1FBQzFCLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDaEMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ1gsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2QsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsY0FBYyxHQUFHLEVBQUUsQ0FBQztRQUV6Qix1Q0FBdUM7UUFDdkMseUJBQXlCO1FBQ3pCLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNuQixJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ3pCO0lBQ0gsQ0FBQzs7Ozs7OztJQUVPLG9CQUFvQixDQUFDLElBQTRCLEVBQUUsSUFBUztRQUNsRSxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxDQUFDO0lBQzFELENBQUM7Ozs7Ozs7SUFFTyxpQkFBaUIsQ0FBQyxJQUE0QixFQUFFLFVBQWtDO1FBQ3hGLElBQUksQ0FBQyxXQUFXLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQztJQUM1QyxDQUFDOzs7Ozs7O0lBRU8sZ0JBQWdCLENBQUMsSUFBNEIsRUFBRSxVQUFzQjtRQUMzRSxJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztJQUMvQixDQUFDOzs7WUFqTUYsVUFBVTs7OztZQVJrQixPQUFPOzs7O0lBVWxDLDhDQUFrQzs7SUFDbEMsMkNBQTBCOztJQUUxQiwwQ0FBbUM7Ozs7O0lBRXZCLHVDQUF3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RWxlbWVudFJlZiwgSW5qZWN0YWJsZSwgT25EZXN0cm95fSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtTaENvbnRleHRNZW51Q29tcG9uZW50fSBmcm9tICcuL3NoLWNvbnRleHQtbWVudS5jb21wb25lbnQnO1xyXG5pbXBvcnQge0Nsb3NlU2Nyb2xsU3RyYXRlZ3ksIE92ZXJsYXl9IGZyb20gJ0Bhbmd1bGFyL2Nkay9vdmVybGF5JztcclxuaW1wb3J0IHtUZW1wbGF0ZVBvcnRhbH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3BvcnRhbCc7XHJcbmltcG9ydCB7Q29ubmVjdGVkUG9zaXRpb25TdHJhdGVneX0gZnJvbSAnQGFuZ3VsYXIvY2RrL292ZXJsYXkvdHlwaW5ncy9wb3NpdGlvbi9jb25uZWN0ZWQtcG9zaXRpb24tc3RyYXRlZ3knO1xyXG5pbXBvcnQge1NoQ29udGV4dE1lbnVFdmVudCwgU2hDb250ZXh0U3ViTWVudUV2ZW50fSBmcm9tICcuL3NoLWNvbnRleHQtbWVudS5tb2RlbHMnO1xyXG5pbXBvcnQge092ZXJsYXlSZWZ9IGZyb20gJ0Bhbmd1bGFyL2Nkay9vdmVybGF5JztcclxuaW1wb3J0IHtmcm9tRXZlbnR9IGZyb20gJ3J4anMvb2JzZXJ2YWJsZS9mcm9tRXZlbnQnO1xyXG5pbXBvcnQge1N1YnNjcmlwdGlvbn0gZnJvbSAncnhqcy9TdWJzY3JpcHRpb24nO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgU2hDb250ZXh0TWVudVNlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xyXG4gIGFjdGl2ZU92ZXJsYXlzOiBPdmVybGF5UmVmW10gPSBbXTtcclxuICBiYWNrRHJvcFN1YjogU3Vic2NyaXB0aW9uO1xyXG5cclxuICBhY3RpdmVNZW51OiBTaENvbnRleHRNZW51Q29tcG9uZW50O1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG92ZXJsYXk6IE92ZXJsYXkpIHtcclxuICB9XHJcblxyXG4gIG9wZW5NZW51KGN0eEV2ZW50OiBTaENvbnRleHRNZW51RXZlbnQpIHtcclxuICAgIHRoaXMuY2xvc2VDdXJyZW50T3ZlcmxheXMoKTtcclxuICAgIGNvbnN0IHttZW51LCBtb3VzZUV2ZW50LCB0YXJnZXRFbGVtZW50LCBkYXRhfSA9IGN0eEV2ZW50O1xyXG5cclxuICAgIHRoaXMuYWN0aXZlTWVudSA9IG1lbnU7XHJcblxyXG4gICAgbW91c2VFdmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgbW91c2VFdmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHJcbiAgICB0aGlzLm92ZXJyaWRlR2V0Qm91bmRpbmdDbGllbnRSZWN0KHRhcmdldEVsZW1lbnQsIG1vdXNlRXZlbnQpO1xyXG5cclxuICAgIGNvbnN0IHNjcm9sbFN0cmF0ZWd5ID0gdGhpcy5idWlsZENsb3NlU2Nyb2xsU3RyYXRlZ3koKTtcclxuICAgIGNvbnN0IHBvc2l0aW9uU3RyYXRlZ3kgPSB0aGlzLmJ1aWxkQ29ubmVjdGVkUG9zaXRpb25TdHJhdGVneSh0YXJnZXRFbGVtZW50KTtcclxuXHJcbiAgICB0aGlzLmF0dGFjaENvbnRleHRUb0l0ZW1zKG1lbnUsIGRhdGEpO1xyXG5cclxuICAgIGNvbnN0IG92ZXJsYXlSZWYgPSB0aGlzLmNyZWF0ZUFuZEF0dGFjaE92ZXJsYXkocG9zaXRpb25TdHJhdGVneSwgc2Nyb2xsU3RyYXRlZ3ksIG1lbnUsIHRydWUpO1xyXG4gICAgdGhpcy5hdHRhY2hPdmVybGF5UmVmKG1lbnUsIG92ZXJsYXlSZWYpO1xyXG5cclxuICAgIHRoaXMucmVnaXN0ZXJCYWNrZHJvcEV2ZW50cyhvdmVybGF5UmVmKTtcclxuICB9XHJcblxyXG4gIG9wZW5TdWJNZW51KGN0eEV2ZW50OiBTaENvbnRleHRTdWJNZW51RXZlbnQpOiBhbnkge1xyXG4gICAgY29uc3Qge21lbnUsIG1vdXNlRXZlbnQsIHRhcmdldEVsZW1lbnQsIGRhdGEsIHBhcmVudE1lbnV9ID0gY3R4RXZlbnQ7XHJcblxyXG4gICAgbW91c2VFdmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgbW91c2VFdmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHJcbiAgICBjb25zdCBzY3JvbGxTdHJhdGVneSA9IHRoaXMuYnVpbGRDbG9zZVNjcm9sbFN0cmF0ZWd5KCk7XHJcbiAgICBjb25zdCBwb3NpdGlvblN0cmF0ZWd5ID0gdGhpcy5idWlsZENvbm5lY3RlZFBvc2l0aW9uU3RyYXRlZ3lGb3JTdWJNZW51KHRhcmdldEVsZW1lbnQpO1xyXG4gICAgY29uc3Qgb3ZlcmxheVJlZiA9IHRoaXMuY3JlYXRlQW5kQXR0YWNoT3ZlcmxheShwb3NpdGlvblN0cmF0ZWd5LCBzY3JvbGxTdHJhdGVneSwgbWVudSwgZmFsc2UpO1xyXG5cclxuICAgIHRoaXMuYXR0YWNoQ29udGV4dFRvSXRlbXMobWVudSwgZGF0YSk7XHJcbiAgICB0aGlzLmF0dGFjaFRoaXNDb250ZXh0KG1lbnUsIHBhcmVudE1lbnUpO1xyXG4gICAgdGhpcy5hdHRhY2hPdmVybGF5UmVmKG1lbnUsIG92ZXJsYXlSZWYpO1xyXG4gIH1cclxuXHJcbiAgZGVzdHJveSgpIHtcclxuICAgIHRoaXMuY2xvc2VDdXJyZW50T3ZlcmxheXMoKTtcclxuICAgIHRoaXMuYmFja0Ryb3BTdWIudW5zdWJzY3JpYmUoKTtcclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgdGhpcy5kZXN0cm95KCk7XHJcbiAgfVxyXG5cclxuICBjbG9zZVN1Yk1lbnVzKG1lbnU6IFNoQ29udGV4dE1lbnVDb21wb25lbnQpIHtcclxuICAgIGNvbnN0IGl0ZW1zV2l0aFN1Yk1lbnVzID0gbWVudVxyXG4gICAgICAubWVudUl0ZW1zXHJcbiAgICAgIC5maWx0ZXIoaSA9PiAhIWkuc3ViTWVudSAmJiAhIWkuc3ViTWVudS5vdmVybGF5UmVmKTtcclxuXHJcbiAgICBpZiAoaXRlbXNXaXRoU3ViTWVudXMubGVuZ3RoKSB7XHJcbiAgICAgIGl0ZW1zV2l0aFN1Yk1lbnVzLmZvckVhY2goc20gPT4gdGhpcy5jbG9zZVN1Yk1lbnVzKHNtLnN1Yk1lbnUpKTtcclxuXHJcbiAgICAgIGNvbnN0IG92ZXJsYXlSZWZzID0gaXRlbXNXaXRoU3ViTWVudXNcclxuICAgICAgICAubWFwKGkgPT4gaS5zdWJNZW51Lm92ZXJsYXlSZWYpO1xyXG5cclxuICAgICAgb3ZlcmxheVJlZnMuZm9yRWFjaChyID0+IHIuZGlzcG9zZSgpKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVnaXN0ZXJCYWNrZHJvcEV2ZW50cyhvdmVybGF5UmVmOiBPdmVybGF5UmVmKSB7XHJcbiAgICBjb25zdCBlbG0gPSBvdmVybGF5UmVmLmJhY2tkcm9wRWxlbWVudDtcclxuXHJcbiAgICB0aGlzLmJhY2tEcm9wU3ViID0gZnJvbUV2ZW50KGVsbSwgJ21vdXNlZG93bicpXHJcbiAgICAgIC5zdWJzY3JpYmUodGhpcy5jbG9zZUN1cnJlbnRPdmVybGF5cy5iaW5kKHRoaXMpKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlQW5kQXR0YWNoT3ZlcmxheShwb3NpdGlvblN0cmF0ZWd5OiBDb25uZWN0ZWRQb3NpdGlvblN0cmF0ZWd5LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxTdHJhdGVneTogQ2xvc2VTY3JvbGxTdHJhdGVneSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVudTogU2hDb250ZXh0TWVudUNvbXBvbmVudCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzQmFja2Ryb3A6IGJvb2xlYW4gPSB0cnVlKSB7XHJcblxyXG4gICAgY29uc3Qgb3ZlcmxheVJlZiA9IHRoaXMub3ZlcmxheS5jcmVhdGUoe1xyXG4gICAgICBwb3NpdGlvblN0cmF0ZWd5LFxyXG4gICAgICBzY3JvbGxTdHJhdGVneSxcclxuICAgICAgaGFzQmFja2Ryb3A6IGhhc0JhY2tkcm9wLFxyXG4gICAgICBiYWNrZHJvcENsYXNzOiAnc2gtYmFja2Ryb3AnXHJcbiAgICB9KTtcclxuXHJcbiAgICAvKlxyXG4gICAgIFRPRE86IHRyeSBwYXNzaW5nIHRoZSBUZW1wbGF0ZVBvcnRhbCBjb250ZXh0IChkYXRhKVxyXG4gICAgIGFuZCB0aGVuIGluamVjdGluZyBpdCB0byB0aGUgKm5nVGVtcGxhdGVPdXRsZXQgaW4gdGhlIGNvbXBvbmVudCB0ZW1wbGF0ZVxyXG4gICAgKi9cclxuICAgIGNvbnN0IG1lbnVQb3J0YWwgPSBuZXcgVGVtcGxhdGVQb3J0YWwobWVudS5tZW51VGVtcGxhdGUsIG1lbnUubWVudUNvbnRhaW5lcik7XHJcbiAgICBvdmVybGF5UmVmLmF0dGFjaChtZW51UG9ydGFsKTtcclxuXHJcbiAgICB0aGlzLmFjdGl2ZU92ZXJsYXlzLnB1c2gob3ZlcmxheVJlZik7XHJcblxyXG4gICAgcmV0dXJuIG92ZXJsYXlSZWY7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGJ1aWxkQ2xvc2VTY3JvbGxTdHJhdGVneSgpIHtcclxuICAgIHJldHVybiB0aGlzLm92ZXJsYXkuc2Nyb2xsU3RyYXRlZ2llcy5jbG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBidWlsZENvbm5lY3RlZFBvc2l0aW9uU3RyYXRlZ3koZWxtOiBFbGVtZW50UmVmKTogQ29ubmVjdGVkUG9zaXRpb25TdHJhdGVneSB7XHJcbiAgICByZXR1cm4gdGhpc1xyXG4gICAgICAub3ZlcmxheVxyXG4gICAgICAucG9zaXRpb24oKVxyXG4gICAgICAuY29ubmVjdGVkVG8oZWxtLFxyXG4gICAgICAgIHtvcmlnaW5YOiAnc3RhcnQnLCBvcmlnaW5ZOiAnYm90dG9tJ30sXHJcbiAgICAgICAge292ZXJsYXlYOiAnc3RhcnQnLCBvdmVybGF5WTogJ3RvcCd9KVxyXG4gICAgICAud2l0aEZhbGxiYWNrUG9zaXRpb24oXHJcbiAgICAgICAge29yaWdpblg6ICdzdGFydCcsIG9yaWdpblk6ICd0b3AnfSxcclxuICAgICAgICB7b3ZlcmxheVg6ICdzdGFydCcsIG92ZXJsYXlZOiAnYm90dG9tJ30pXHJcbiAgICAgIC53aXRoRmFsbGJhY2tQb3NpdGlvbihcclxuICAgICAgICB7b3JpZ2luWDogJ2VuZCcsIG9yaWdpblk6ICd0b3AnfSxcclxuICAgICAgICB7b3ZlcmxheVg6ICdzdGFydCcsIG92ZXJsYXlZOiAndG9wJ30pXHJcbiAgICAgIC53aXRoRmFsbGJhY2tQb3NpdGlvbihcclxuICAgICAgICB7b3JpZ2luWDogJ3N0YXJ0Jywgb3JpZ2luWTogJ3RvcCd9LFxyXG4gICAgICAgIHtvdmVybGF5WDogJ2VuZCcsIG92ZXJsYXlZOiAndG9wJ30pXHJcbiAgICAgIC53aXRoRmFsbGJhY2tQb3NpdGlvbihcclxuICAgICAgICB7b3JpZ2luWDogJ2VuZCcsIG9yaWdpblk6ICdjZW50ZXInfSxcclxuICAgICAgICB7b3ZlcmxheVg6ICdzdGFydCcsIG92ZXJsYXlZOiAnY2VudGVyJ30pXHJcbiAgICAgIC53aXRoRmFsbGJhY2tQb3NpdGlvbihcclxuICAgICAgICB7b3JpZ2luWDogJ3N0YXJ0Jywgb3JpZ2luWTogJ2NlbnRlcid9LFxyXG4gICAgICAgIHtvdmVybGF5WDogJ2VuZCcsIG92ZXJsYXlZOiAnY2VudGVyJ30pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBidWlsZENvbm5lY3RlZFBvc2l0aW9uU3RyYXRlZ3lGb3JTdWJNZW51KGVsbTogRWxlbWVudFJlZik6IENvbm5lY3RlZFBvc2l0aW9uU3RyYXRlZ3kge1xyXG4gICAgcmV0dXJuIHRoaXNcclxuICAgICAgLm92ZXJsYXlcclxuICAgICAgLnBvc2l0aW9uKClcclxuICAgICAgLmNvbm5lY3RlZFRvKGVsbSxcclxuICAgICAgICB7b3JpZ2luWDogJ2VuZCcsIG9yaWdpblk6ICd0b3AnfSxcclxuICAgICAgICB7b3ZlcmxheVg6ICdzdGFydCcsIG92ZXJsYXlZOiAndG9wJ30pXHJcbiAgICAgIC53aXRoRmFsbGJhY2tQb3NpdGlvbihcclxuICAgICAgICB7b3JpZ2luWDogJ3N0YXJ0Jywgb3JpZ2luWTogJ3RvcCd9LFxyXG4gICAgICAgIHtvdmVybGF5WDogJ2VuZCcsIG92ZXJsYXlZOiAndG9wJ30pXHJcbiAgICAgIC53aXRoRmFsbGJhY2tQb3NpdGlvbihcclxuICAgICAgICB7b3JpZ2luWDogJ2VuZCcsIG9yaWdpblk6ICdib3R0b20nfSxcclxuICAgICAgICB7b3ZlcmxheVg6ICdzdGFydCcsIG92ZXJsYXlZOiAnYm90dG9tJ30pXHJcbiAgICAgIC53aXRoRmFsbGJhY2tQb3NpdGlvbihcclxuICAgICAgICB7b3JpZ2luWDogJ3N0YXJ0Jywgb3JpZ2luWTogJ2JvdHRvbSd9LFxyXG4gICAgICAgIHtvdmVybGF5WDogJ2VuZCcsIG92ZXJsYXlZOiAnYm90dG9tJ30pO1xyXG4gIH1cclxuXHJcbiAgLypcclxuICAgIHdlIG5lZWQgdG8gb3ZlcnJpZGUgZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkgdG8gcmV0dXJuIHRoZSBwb3NpdGlvbiBvZiB0aGUgbWVudS5cclxuICAgIHRoaXMgaXMgZG9uZSBiZWNhdXNlIEBhbmd1bGFyL2NkayB1c2UgdGhpcyBmdW5jdGlvbiBpbnRlcm5hbGx5IHRvIGRldGVybWluZSB3aGVyZSB0aGUgb3ZlcmxheSBzaG91bGQgYmUgcG9zaXRpb25lZFxyXG4gICAgaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvbWF0ZXJpYWwyL2Jsb2IvbWFzdGVyL3NyYy9jZGsvb3ZlcmxheS9wb3NpdGlvbi9jb25uZWN0ZWQtcG9zaXRpb24tc3RyYXRlZ3kudHMjTDI4OFxyXG4gICAqL1xyXG4gIHByaXZhdGUgb3ZlcnJpZGVHZXRCb3VuZGluZ0NsaWVudFJlY3QoZWxtOiBFbGVtZW50UmVmLCBldmVudDogTW91c2VFdmVudCkge1xyXG4gICAgY29uc3Qge2NsaWVudFgsIGNsaWVudFl9ID0gZXZlbnQ7XHJcblxyXG4gICAgZWxtLm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0ID0gKCk6IENsaWVudFJlY3QgPT4ge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIGJvdHRvbTogY2xpZW50WSxcclxuICAgICAgICBoZWlnaHQ6IDAsXHJcbiAgICAgICAgbGVmdDogY2xpZW50WCxcclxuICAgICAgICByaWdodDogY2xpZW50WCxcclxuICAgICAgICB0b3A6IGNsaWVudFksXHJcbiAgICAgICAgd2lkdGg6IDBcclxuICAgICAgfTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNsb3NlQ3VycmVudE92ZXJsYXlzKCkge1xyXG4gICAgdGhpcy5hY3RpdmVPdmVybGF5cy5mb3JFYWNoKChvKSA9PiB7XHJcbiAgICAgIG8uZGV0YWNoKCk7XHJcbiAgICAgIG8uZGlzcG9zZSgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy5hY3RpdmVPdmVybGF5cyA9IFtdO1xyXG5cclxuICAgIC8vIFRPRE86IGNyZWF0ZSBjbG9zZSBzdWJqZWN0IGFuZCBlbWl0LlxyXG4gICAgLy8gc3Vic2NyaWJlIGluIGNvbXBvbmVudFxyXG4gICAgaWYgKHRoaXMuYWN0aXZlTWVudSkge1xyXG4gICAgICB0aGlzLmFjdGl2ZU1lbnUuY2xvc2UoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXR0YWNoQ29udGV4dFRvSXRlbXMobWVudTogU2hDb250ZXh0TWVudUNvbXBvbmVudCwgZGF0YTogYW55KSB7XHJcbiAgICBtZW51Lm1lbnVJdGVtcy5mb3JFYWNoKGkgPT4gaS5jb250ZXh0LiRpbXBsaWNpdCA9IGRhdGEpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhdHRhY2hUaGlzQ29udGV4dChtZW51OiBTaENvbnRleHRNZW51Q29tcG9uZW50LCBwYXJlbnRNZW51OiBTaENvbnRleHRNZW51Q29tcG9uZW50KSB7XHJcbiAgICBtZW51LnRoaXNDb250ZXh0ID0gcGFyZW50TWVudS50aGlzQ29udGV4dDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXR0YWNoT3ZlcmxheVJlZihtZW51OiBTaENvbnRleHRNZW51Q29tcG9uZW50LCBvdmVybGF5UmVmOiBPdmVybGF5UmVmKSB7XHJcbiAgICBtZW51Lm92ZXJsYXlSZWYgPSBvdmVybGF5UmVmO1xyXG4gIH1cclxufVxyXG4iXX0=