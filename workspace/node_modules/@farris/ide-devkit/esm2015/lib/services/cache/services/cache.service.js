/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Optional } from '@angular/core';
import { CacheStorageAbstract } from './storage/cache.storage.abstract.service';
import { CacheSessionStorage } from './storage/sessionstorage/cache.sessionstorage.service';
import { CacheLocalStorage } from './storage/localstorage/cache.localstorage.service';
import { CacheMemoryStorage } from './storage/memory/cache.memory.service';
/** @type {?} */
const CACHE_PREFIX = 'CacheService';
/** @type {?} */
const DEFAULT_STORAGE = 2 /* MEMORY */;
/** @type {?} */
const DEFAULT_ENABLED_STORAGE = 1 /* SESSION_STORAGE */;
export class CacheService {
    /**
     * @param {?} _storage
     */
    constructor(_storage) {
        this._storage = _storage;
        /**
         * Default cache options
         */
        this._defaultOptions = {
            expires: Number.MAX_VALUE,
            maxAge: Number.MAX_VALUE
        };
        /**
         * Cache prefix
         */
        this._prefix = CACHE_PREFIX;
        this._validateStorage();
    }
    /**
     * Set data to cache
     * @param {?} key key
     * @param {?} value value
     * @param {?=} options options
     * @return {?}
     */
    set(key, value, options) {
        /** @type {?} */
        const storageKey = this._toStorageKey(key);
        options = options ? options : this._defaultOptions;
        if (this._storage.setItem(storageKey, this._toStorageValue(value, options))) {
            if (!this._isSystemKey(key) && options.tag) {
                this._saveTag(options.tag, storageKey);
            }
            return true;
        }
        return false;
    }
    /**
     * Get data from cache
     * @param {?} key key
     * @return {?} result
     */
    get(key) {
        /** @type {?} */
        const storageValue = this._storage.getItem(this._toStorageKey(key));
        /** @type {?} */
        let value = null;
        if (storageValue) {
            if (this._validateStorageValue(storageValue)) {
                value = storageValue.value;
            }
            else {
                this.remove(key);
            }
        }
        return value;
    }
    /**
     * Check if value exists
     * @param {?} key key
     * @return {?} result
     */
    exists(key) {
        return !!this.get(key);
    }
    /**
     * Remove item from cache
     * @param {?} key key
     * @return {?}
     */
    remove(key) {
        this._storage.removeItem(this._toStorageKey(key));
        this._removeFromTag(this._toStorageKey(key));
    }
    /**
     * Remove all from cache
     * @return {?}
     */
    removeAll() {
        this._storage.clear();
    }
    /**
     * Get all tag data
     * @param {?} tag tag
     * @return {?} result
     */
    getTagData(tag) {
        /** @type {?} */
        const tags = this.get(this._tagsStorageKey()) || {};
        /** @type {?} */
        const result = {};
        if (tags[tag]) {
            tags[tag].forEach((key) => {
                /** @type {?} */
                const data = this.get(this._fromStorageKey(key));
                if (data) {
                    result[this._fromStorageKey(key)] = data;
                }
            });
        }
        return result;
    }
    /**
     * Create a new instance of cache with needed storage
     * @param {?} type type
     * @return {?} result
     */
    useStorage(type) {
        /** @type {?} */
        const service = new CacheService(this._initStorage(type));
        service.setGlobalPrefix(this._getCachePrefix());
        return service;
    }
    /**
     * Remove all by tag
     * @param {?} tag tag
     * @return {?}
     */
    removeTag(tag) {
        /** @type {?} */
        const tags = this.get(this._tagsStorageKey()) || {};
        if (tags[tag]) {
            tags[tag].forEach((key) => {
                this._storage.removeItem(key);
            });
            delete tags[tag];
            this.set(this._tagsStorageKey(), tags);
        }
    }
    /**
     * Set global cache key prefix
     * @param {?} prefix prefix
     * @return {?}
     */
    setGlobalPrefix(prefix) {
        this._prefix = prefix;
    }
    /**
     * Validate cache storage
     * @private
     * @return {?}
     */
    _validateStorage() {
        if (!this._storage) {
            this._storage = this._initStorage(DEFAULT_STORAGE);
        }
        if (!this._storage.isEnabled()) {
            this._storage = this._initStorage(DEFAULT_ENABLED_STORAGE);
        }
    }
    /**
     * Remove key from tags keys list
     * @private
     * @param {?} key key
     * @return {?}
     */
    _removeFromTag(key) {
        // tslint:disable-next-line:prefer-const
        /** @type {?} */
        let tags = this.get(this._tagsStorageKey()) || {};
        /** @type {?} */
        let index;
        // tslint:disable-next-line:forin
        for (const tag in tags) {
            index = tags[tag].indexOf(key);
            if (index !== -1) {
                tags[tag].splice(index, 1);
                this.set(this._tagsStorageKey(), tags);
                break;
            }
        }
    }
    /**
     * Init storage by type
     * @private
     * @param {?} type type
     * @return {?}
     */
    _initStorage(type) {
        /** @type {?} */
        let storage;
        switch (type) {
            case 1 /* SESSION_STORAGE */:
                storage = new CacheSessionStorage();
                break;
            case 0 /* LOCAL_STORAGE */:
                storage = new CacheLocalStorage();
                break;
            default: storage = new CacheMemoryStorage();
        }
        return storage;
    }
    /**
     * @private
     * @param {?} key
     * @return {?}
     */
    _toStorageKey(key) {
        return this._getCachePrefix() + key;
    }
    /**
     * @private
     * @param {?} key
     * @return {?}
     */
    _fromStorageKey(key) {
        return key.replace(this._getCachePrefix(), '');
    }
    /**
     * Prepare value to set to storage
     * @private
     * @param {?} value value
     * @param {?} options options
     * @return {?} result
     */
    _toStorageValue(value, options) {
        return {
            value,
            options: this._toStorageOptions(options)
        };
    }
    /**
     * Prepare options to set to storage
     * @private
     * @param {?} options options
     * @return {?} result
     */
    _toStorageOptions(options) {
        /** @type {?} */
        const storageOptions = {};
        storageOptions.expires = options.expires ? options.expires :
            (options.maxAge ? Date.now() + (options.maxAge * 1000) : this._defaultOptions.expires);
        storageOptions.maxAge = options.maxAge ? options.maxAge : this._defaultOptions.maxAge;
        return storageOptions;
    }
    /**
     * Validate storage value
     * @private
     * @param {?} value value
     * @return {?} result
     */
    _validateStorageValue(value) {
        return !!value.options.expires && value.options.expires > Date.now();
    }
    /**
     * check if its system cache key
     * @private
     * @param {?} key key
     * @return {?} result
     */
    _isSystemKey(key) {
        return [this._tagsStorageKey()].indexOf(key) !== -1;
    }
    /**
     * Save tag to list of tags
     * @private
     * @param {?} tag tag
     * @param {?} key key
     * @return {?}
     */
    _saveTag(tag, key) {
        /** @type {?} */
        const tags = this.get(this._tagsStorageKey()) || {};
        if (!tags[tag]) {
            tags[tag] = [key];
        }
        else {
            tags[tag].push(key);
        }
        this.set(this._tagsStorageKey(), tags);
    }
    /**
     * Get global cache prefix
     * @private
     * @return {?} result
     */
    _getCachePrefix() {
        return this._prefix;
    }
    /**
     * @private
     * @return {?}
     */
    _tagsStorageKey() {
        return 'CacheService_tags';
    }
}
CacheService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
CacheService.ctorParameters = () => [
    { type: CacheStorageAbstract, decorators: [{ type: Optional }] }
];
if (false) {
    /**
     * Default cache options
     * @type {?}
     * @private
     */
    CacheService.prototype._defaultOptions;
    /**
     * Cache prefix
     * @type {?}
     * @private
     */
    CacheService.prototype._prefix;
    /**
     * @type {?}
     * @private
     */
    CacheService.prototype._storage;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvaWRlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9jYWNoZS9zZXJ2aWNlcy9jYWNoZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUdyRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUNoRixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx1REFBdUQsQ0FBQztBQUM1RixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxtREFBbUQsQ0FBQztBQUN0RixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQzs7TUFHckUsWUFBWSxHQUFHLGNBQWM7O01BRTdCLGVBQWUsaUJBQTJCOztNQUMxQyx1QkFBdUIsMEJBQW9DO0FBR2pFLE1BQU0sT0FBTyxZQUFZOzs7O0lBZXJCLFlBQXVDLFFBQThCO1FBQTlCLGFBQVEsR0FBUixRQUFRLENBQXNCOzs7O1FBVjdELG9CQUFlLEdBQTBCO1lBQzdDLE9BQU8sRUFBRSxNQUFNLENBQUMsU0FBUztZQUN6QixNQUFNLEVBQUcsTUFBTSxDQUFDLFNBQVM7U0FDNUIsQ0FBQzs7OztRQUtNLFlBQU8sR0FBVyxZQUFZLENBQUM7UUFHbkMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDNUIsQ0FBQzs7Ozs7Ozs7SUFRTSxHQUFHLENBQUMsR0FBVyxFQUFFLEtBQVUsRUFBRSxPQUErQjs7Y0FDekQsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDO1FBQzFDLE9BQU8sR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQztRQUNuRCxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxD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b3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBDYWNoZU9wdGlvbnNJbnRlcmZhY2UgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2NhY2hlLm9wdGlvbnMuaW50ZXJmYWNlJztcclxuaW1wb3J0IHsgQ2FjaGVTdG9yYWdlc0VudW0gfSBmcm9tICcuLi9lbnVtcy9jYWNoZS5zdG9yYWdlcy5lbnVtJztcclxuaW1wb3J0IHsgQ2FjaGVTdG9yYWdlQWJzdHJhY3QgfSBmcm9tICcuL3N0b3JhZ2UvY2FjaGUuc3RvcmFnZS5hYnN0cmFjdC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ2FjaGVTZXNzaW9uU3RvcmFnZSB9IGZyb20gJy4vc3RvcmFnZS9zZXNzaW9uc3RvcmFnZS9jYWNoZS5zZXNzaW9uc3RvcmFnZS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ2FjaGVMb2NhbFN0b3JhZ2UgfSBmcm9tICcuL3N0b3JhZ2UvbG9jYWxzdG9yYWdlL2NhY2hlLmxvY2Fsc3RvcmFnZS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ2FjaGVNZW1vcnlTdG9yYWdlIH0gZnJvbSAnLi9zdG9yYWdlL21lbW9yeS9jYWNoZS5tZW1vcnkuc2VydmljZSc7XHJcbmltcG9ydCB7IFN0b3JhZ2VWYWx1ZUludGVyZmFjZSB9IGZyb20gJy4uL2ludGVyZmFjZXMvc3RvcmFnZS52YWx1ZS5pbnRlcmZhY2UnO1xyXG5cclxuY29uc3QgQ0FDSEVfUFJFRklYID0gJ0NhY2hlU2VydmljZSc7XHJcblxyXG5jb25zdCBERUZBVUxUX1NUT1JBR0UgPSBDYWNoZVN0b3JhZ2VzRW51bS5NRU1PUlk7XHJcbmNvbnN0IERFRkFVTFRfRU5BQkxFRF9TVE9SQUdFID0gQ2FjaGVTdG9yYWdlc0VudW0uU0VTU0lPTl9TVE9SQUdFO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQ2FjaGVTZXJ2aWNlIHtcclxuXHJcbiAgICAvKipcclxuICAgICAqIERlZmF1bHQgY2FjaGUgb3B0aW9uc1xyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9kZWZhdWx0T3B0aW9uczogQ2FjaGVPcHRpb25zSW50ZXJmYWNlID0ge1xyXG4gICAgICAgIGV4cGlyZXM6IE51bWJlci5NQVhfVkFMVUUsXHJcbiAgICAgICAgbWF4QWdlIDogTnVtYmVyLk1BWF9WQUxVRVxyXG4gICAgfTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIENhY2hlIHByZWZpeFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9wcmVmaXg6IHN0cmluZyA9IENBQ0hFX1BSRUZJWDtcclxuXHJcbiAgICBwdWJsaWMgY29uc3RydWN0b3IoQE9wdGlvbmFsKCkgcHJpdmF0ZSBfc3RvcmFnZTogQ2FjaGVTdG9yYWdlQWJzdHJhY3QpIHtcclxuICAgICAgICB0aGlzLl92YWxpZGF0ZVN0b3JhZ2UoKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFNldCBkYXRhIHRvIGNhY2hlXHJcbiAgICAgKiBAcGFyYW0ga2V5IGtleVxyXG4gICAgICogQHBhcmFtIHZhbHVlIHZhbHVlXHJcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBvcHRpb25zXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnksIG9wdGlvbnM/OiBDYWNoZU9wdGlvbnNJbnRlcmZhY2UpIHtcclxuICAgICAgICBjb25zdCBzdG9yYWdlS2V5ID0gdGhpcy5fdG9TdG9yYWdlS2V5KGtleSk7XHJcbiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBvcHRpb25zIDogdGhpcy5fZGVmYXVsdE9wdGlvbnM7XHJcbiAgICAgICAgaWYgKHRoaXMuX3N0b3JhZ2Uuc2V0SXRlbShzdG9yYWdlS2V5LCB0aGlzLl90b1N0b3JhZ2VWYWx1ZSh2YWx1ZSwgb3B0aW9ucykpKSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5faXNTeXN0ZW1LZXkoa2V5KSAmJiBvcHRpb25zLnRhZykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fc2F2ZVRhZyhvcHRpb25zLnRhZywgc3RvcmFnZUtleSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBHZXQgZGF0YSBmcm9tIGNhY2hlXHJcbiAgICAgKiBAcGFyYW0ga2V5IGtleVxyXG4gICAgICogQHJldHVybnMgcmVzdWx0XHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBnZXQoa2V5OiBzdHJpbmcpOiBhbnkge1xyXG4gICAgICAgIGNvbnN0IHN0b3JhZ2VWYWx1ZSA9IHRoaXMuX3N0b3JhZ2UuZ2V0SXRlbSh0aGlzLl90b1N0b3JhZ2VLZXkoa2V5KSk7XHJcbiAgICAgICAgbGV0IHZhbHVlOiBhbnkgPSBudWxsO1xyXG4gICAgICAgIGlmIChzdG9yYWdlVmFsdWUpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuX3ZhbGlkYXRlU3RvcmFnZVZhbHVlKHN0b3JhZ2VWYWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gc3RvcmFnZVZhbHVlLnZhbHVlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoa2V5KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDaGVjayBpZiB2YWx1ZSBleGlzdHNcclxuICAgICAqIEBwYXJhbSBrZXkga2V5XHJcbiAgICAgKiBAcmV0dXJucyByZXN1bHRcclxuICAgICAqL1xyXG4gICAgcHVibGljIGV4aXN0cyhrZXk6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiAhIXRoaXMuZ2V0KGtleSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZW1vdmUgaXRlbSBmcm9tIGNhY2hlXHJcbiAgICAgKiBAcGFyYW0ga2V5IGtleVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgcmVtb3ZlKGtleTogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5fc3RvcmFnZS5yZW1vdmVJdGVtKHRoaXMuX3RvU3RvcmFnZUtleShrZXkpKTtcclxuICAgICAgICB0aGlzLl9yZW1vdmVGcm9tVGFnKHRoaXMuX3RvU3RvcmFnZUtleShrZXkpKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJlbW92ZSBhbGwgZnJvbSBjYWNoZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgcmVtb3ZlQWxsKCkge1xyXG4gICAgICAgIHRoaXMuX3N0b3JhZ2UuY2xlYXIoKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldCBhbGwgdGFnIGRhdGFcclxuICAgICAqIEBwYXJhbSB0YWcgdGFnXHJcbiAgICAgKiBAcmV0dXJucyByZXN1bHRcclxuICAgICAqL1xyXG4gICAgcHVibGljIGdldFRhZ0RhdGEodGFnOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCB0YWdzID0gdGhpcy5nZXQodGhpcy5fdGFnc1N0b3JhZ2VLZXkoKSkgfHwge307XHJcbiAgICAgICAgY29uc3QgcmVzdWx0OiB7W2tleTogc3RyaW5nXTogYW55fSA9IHt9O1xyXG4gICAgICAgIGlmICh0YWdzW3RhZ10pIHtcclxuICAgICAgICAgICAgdGFnc1t0YWddLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gdGhpcy5nZXQodGhpcy5fZnJvbVN0b3JhZ2VLZXkoa2V5KSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFt0aGlzLl9mcm9tU3RvcmFnZUtleShrZXkpXSA9IGRhdGE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGNhY2hlIHdpdGggbmVlZGVkIHN0b3JhZ2VcclxuICAgICAqIEBwYXJhbSB0eXBlIHR5cGVcclxuICAgICAqIEByZXR1cm5zIHJlc3VsdFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgdXNlU3RvcmFnZSh0eXBlOiBDYWNoZVN0b3JhZ2VzRW51bSkge1xyXG4gICAgICAgIGNvbnN0IHNlcnZpY2UgPSBuZXcgQ2FjaGVTZXJ2aWNlKHRoaXMuX2luaXRTdG9yYWdlKHR5cGUpKTtcclxuICAgICAgICBzZXJ2aWNlLnNldEdsb2JhbFByZWZpeCh0aGlzLl9nZXRDYWNoZVByZWZpeCgpKTtcclxuICAgICAgICByZXR1cm4gc2VydmljZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJlbW92ZSBhbGwgYnkgdGFnXHJcbiAgICAgKiBAcGFyYW0gdGFnIHRhZ1xyXG4gICAgICovXHJcbiAgICBwdWJsaWMgcmVtb3ZlVGFnKHRhZzogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgdGFncyA9IHRoaXMuZ2V0KHRoaXMuX3RhZ3NTdG9yYWdlS2V5KCkpIHx8IHt9O1xyXG4gICAgICAgIGlmICh0YWdzW3RhZ10pIHtcclxuICAgICAgICAgICAgdGFnc1t0YWddLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9zdG9yYWdlLnJlbW92ZUl0ZW0oa2V5KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGRlbGV0ZSB0YWdzW3RhZ107XHJcbiAgICAgICAgICAgIHRoaXMuc2V0KHRoaXMuX3RhZ3NTdG9yYWdlS2V5KCksIHRhZ3MpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFNldCBnbG9iYWwgY2FjaGUga2V5IHByZWZpeFxyXG4gICAgICogQHBhcmFtIHByZWZpeCBwcmVmaXhcclxuICAgICAqL1xyXG4gICAgcHVibGljIHNldEdsb2JhbFByZWZpeChwcmVmaXg6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuX3ByZWZpeCA9IHByZWZpeDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFZhbGlkYXRlIGNhY2hlIHN0b3JhZ2VcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfdmFsaWRhdGVTdG9yYWdlKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5fc3RvcmFnZSkge1xyXG4gICAgICAgICAgICB0aGlzLl9zdG9yYWdlID0gdGhpcy5faW5pdFN0b3JhZ2UoREVGQVVMVF9TVE9SQUdFKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCF0aGlzLl9zdG9yYWdlLmlzRW5hYmxlZCgpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3N0b3JhZ2UgPSB0aGlzLl9pbml0U3RvcmFnZShERUZBVUxUX0VOQUJMRURfU1RPUkFHRSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmVtb3ZlIGtleSBmcm9tIHRhZ3Mga2V5cyBsaXN0XHJcbiAgICAgKiBAcGFyYW0ga2V5IGtleVxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9yZW1vdmVGcm9tVGFnKGtleTogc3RyaW5nKSB7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnByZWZlci1jb25zdFxyXG4gICAgICAgIGxldCB0YWdzID0gdGhpcy5nZXQodGhpcy5fdGFnc1N0b3JhZ2VLZXkoKSkgfHwge307XHJcbiAgICAgICAgbGV0IGluZGV4OiBudW1iZXI7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmZvcmluXHJcbiAgICAgICAgZm9yIChjb25zdCB0YWcgaW4gdGFncykge1xyXG4gICAgICAgICAgICBpbmRleCA9IHRhZ3NbdGFnXS5pbmRleE9mKGtleSk7XHJcbiAgICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIHRhZ3NbdGFnXS5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXQodGhpcy5fdGFnc1N0b3JhZ2VLZXkoKSwgdGFncyk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEluaXQgc3RvcmFnZSBieSB0eXBlXHJcbiAgICAgKiBAcGFyYW0gdHlwZSB0eXBlXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX2luaXRTdG9yYWdlKHR5cGU6IENhY2hlU3RvcmFnZXNFbnVtKSB7XHJcbiAgICAgICAgbGV0IHN0b3JhZ2U6IENhY2hlU3RvcmFnZUFic3RyYWN0O1xyXG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlIENhY2hlU3RvcmFnZXNFbnVtLlNFU1NJT05fU1RPUkFHRTpcclxuICAgICAgICAgICAgICAgIHN0b3JhZ2UgPSBuZXcgQ2FjaGVTZXNzaW9uU3RvcmFnZSgpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgQ2FjaGVTdG9yYWdlc0VudW0uTE9DQUxfU1RPUkFHRTpcclxuICAgICAgICAgICAgICAgIHN0b3JhZ2UgPSBuZXcgQ2FjaGVMb2NhbFN0b3JhZ2UoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OiBzdG9yYWdlID0gbmV3IENhY2hlTWVtb3J5U3RvcmFnZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc3RvcmFnZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF90b1N0b3JhZ2VLZXkoa2V5OiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0Q2FjaGVQcmVmaXgoKSArIGtleTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9mcm9tU3RvcmFnZUtleShrZXk6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiBrZXkucmVwbGFjZSh0aGlzLl9nZXRDYWNoZVByZWZpeCgpLCAnJyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBQcmVwYXJlIHZhbHVlIHRvIHNldCB0byBzdG9yYWdlXHJcbiAgICAgKiBAcGFyYW0gdmFsdWUgdmFsdWVcclxuICAgICAqIEBwYXJhbSBvcHRpb25zIG9wdGlvbnNcclxuICAgICAqIEByZXR1cm5zIHJlc3VsdFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF90b1N0b3JhZ2VWYWx1ZSh2YWx1ZTogYW55LCBvcHRpb25zOiBDYWNoZU9wdGlvbnNJbnRlcmZhY2UpOiBTdG9yYWdlVmFsdWVJbnRlcmZhY2Uge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHZhbHVlLFxyXG4gICAgICAgICAgICBvcHRpb25zOiB0aGlzLl90b1N0b3JhZ2VPcHRpb25zKG9wdGlvbnMpXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFByZXBhcmUgb3B0aW9ucyB0byBzZXQgdG8gc3RvcmFnZVxyXG4gICAgICogQHBhcmFtIG9wdGlvbnMgb3B0aW9uc1xyXG4gICAgICogQHJldHVybnMgcmVzdWx0XHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX3RvU3RvcmFnZU9wdGlvbnMob3B0aW9uczogQ2FjaGVPcHRpb25zSW50ZXJmYWNlKTogQ2FjaGVPcHRpb25zSW50ZXJmYWNlIHtcclxuICAgICAgICBjb25zdCBzdG9yYWdlT3B0aW9uczogQ2FjaGVPcHRpb25zSW50ZXJmYWNlID0ge307XHJcbiAgICAgICAgc3RvcmFnZU9wdGlvbnMuZXhwaXJlcyA9IG9wdGlvbnMuZXhwaXJlcyA/IG9wdGlvbnMuZXhwaXJlcyA6XHJcbiAgICAgICAgICAgIChvcHRpb25zLm1heEFnZSA/IERhdGUubm93KCkgKyAob3B0aW9ucy5tYXhBZ2UgKiAxMDAwKSA6IHRoaXMuX2RlZmF1bHRPcHRpb25zLmV4cGlyZXMpO1xyXG4gICAgICAgIHN0b3JhZ2VPcHRpb25zLm1heEFnZSA9IG9wdGlvbnMubWF4QWdlID8gb3B0aW9ucy5tYXhBZ2UgOiB0aGlzLl9kZWZhdWx0T3B0aW9ucy5tYXhBZ2U7XHJcbiAgICAgICAgcmV0dXJuIHN0b3JhZ2VPcHRpb25zO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogVmFsaWRhdGUgc3RvcmFnZSB2YWx1ZVxyXG4gICAgICogQHBhcmFtIHZhbHVlIHZhbHVlXHJcbiAgICAgKiBAcmV0dXJucyByZXN1bHRcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfdmFsaWRhdGVTdG9yYWdlVmFsdWUodmFsdWU6IFN0b3JhZ2VWYWx1ZUludGVyZmFjZSkge1xyXG4gICAgICAgIHJldHVybiAhIXZhbHVlLm9wdGlvbnMuZXhwaXJlcyAmJiB2YWx1ZS5vcHRpb25zLmV4cGlyZXMgPiBEYXRlLm5vdygpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogY2hlY2sgaWYgaXRzIHN5c3RlbSBjYWNoZSBrZXlcclxuICAgICAqIEBwYXJhbSBrZXkga2V5XHJcbiAgICAgKiBAcmV0dXJucyByZXN1bHRcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfaXNTeXN0ZW1LZXkoa2V5OiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4gW3RoaXMuX3RhZ3NTdG9yYWdlS2V5KCldLmluZGV4T2Yoa2V5KSAhPT0gLTE7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTYXZlIHRhZyB0byBsaXN0IG9mIHRhZ3NcclxuICAgICAqIEBwYXJhbSB0YWcgdGFnXHJcbiAgICAgKiBAcGFyYW0ga2V5IGtleVxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9zYXZlVGFnKHRhZzogc3RyaW5nLCBrZXk6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IHRhZ3MgPSB0aGlzLmdldCh0aGlzLl90YWdzU3RvcmFnZUtleSgpKSB8fCB7fTtcclxuICAgICAgICBpZiAoIXRhZ3NbdGFnXSkge1xyXG4gICAgICAgICAgICB0YWdzW3RhZ10gPSBba2V5XTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0YWdzW3RhZ10ucHVzaChrZXkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNldCh0aGlzLl90YWdzU3RvcmFnZUtleSgpLCB0YWdzKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldCBnbG9iYWwgY2FjaGUgcHJlZml4XHJcbiAgICAgKiBAcmV0dXJucyByZXN1bHRcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfZ2V0Q2FjaGVQcmVmaXgoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ByZWZpeDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF90YWdzU3RvcmFnZUtleSgpIHtcclxuICAgICAgICByZXR1cm4gJ0NhY2hlU2VydmljZV90YWdzJztcclxuICAgIH1cclxuXHJcbn1cclxuIl19