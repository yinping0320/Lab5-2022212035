/**
 * @fileoverview added by tsickle
 * Generated from: lib/ffilepreview-adapt-unifile.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Injector, Optional } from '@angular/core';
import { NotifyService } from '@farris/ui-notify';
import { FileViewerService } from '@gsp-svc/file-viewer';
import { DownloadService } from '@gsp-svc/formdoc-upload';
import { FFileUploadAdaptUnifileConfigService } from './ffileupload-adapt-unifile.config';
import { WEBAPI_PREFIX_TOKEN } from '@farris/ui-common';
import * as i0 from "@angular/core";
import * as i1 from "@gsp-svc/file-viewer";
import * as i2 from "./ffileupload-adapt-unifile.config";
import * as i3 from "@gsp-svc/formdoc-upload";
export class FfilepreviewAdaptUnifileService {
    /**
     * @param {?} fileviewSer
     * @param {?} configSer
     * @param {?} downloadSer
     * @param {?} inject
     */
    constructor(fileviewSer, configSer, downloadSer, inject) {
        this.fileviewSer = fileviewSer;
        this.configSer = configSer;
        this.downloadSer = downloadSer;
        this.inject = inject;
        // 暂时用于简单合并
        this.previewExtendServerConfig = null;
        this.notifySer = null;
        this.perfixStr = '';
        this.extendData = this.configSer.getConfig();
        this.notifySer = this.fileviewSer['injector'].get(NotifyService, null);
        if (this.notifySer) {
            this.configSer.setLocalState(this.notifySer.localeService);
        }
        // 此处inject的时机和upload服务里的一样，此处不用再判断多语言
        if (this.inject) {
            if (WEBAPI_PREFIX_TOKEN) {
                this.perfixStr = this.inject.get(WEBAPI_PREFIX_TOKEN, '');
                this.configSer.setBasePath(this.perfixStr);
            }
        }
    }
    /**
     * 返回最终属性值
     * @private
     * @param {?} key
     * @param {?} extendValue
     * @return {?}
     */
    getFinallyConfig(key, extendValue) {
        if (extendValue && extendValue.hasOwnProperty(key)) {
            return extendValue[key];
        }
        // 避免下载等其他指令再传入扩展配置
        if (this.previewExtendServerConfig && this.previewExtendServerConfig.hasOwnProperty(key)) {
            return this.previewExtendServerConfig[key];
        }
        // 来自module中forRoot的配置
        if (this.extendData.hasOwnProperty(key)) {
            return this.extendData[key];
        }
        return null;
    }
    /**
     * 预览单个文件
     * @param {?} info
     * @param {?} extendService
     * @return {?}
     */
    previewFile(info, extendService) {
        return this.previewFileList([info], extendService);
    }
    /**
     * 预览整个列表
     * @param {?} infos
     * @param {?} extendService
     * @return {?}
     */
    previewFileList(infos, extendService) {
        //metadataIdList: string[]
        /** @type {?} */
        let rootId = this.getFinallyConfig('rootId', extendService);
        /** @type {?} */
        let metadataIdList = [];
        infos.forEach((/**
         * @param {?} item
         * @return {?}
         */
        item => {
            metadataIdList.push(item.extend['metadataId']);
        }));
        /** @type {?} */
        let options = this.getFinallyConfig('options', extendService);
        if (options) {
            return this.fileviewSer.viewerFileList(metadataIdList, rootId, options);
        }
        else {
            return this.fileviewSer.viewerFileList(metadataIdList, rootId);
        }
    }
    /**
     * 下载附件
     * @param {?} info
     * @param {?} extendService
     * @return {?}
     */
    downloadFile(info, extendService) {
        if (!info.id) {
            /** @type {?} */
            let failMsg = this.getLocalStr('uploadAdapt.needFile');
            if (this.notifySer) {
                this.notifySer.warning(failMsg);
                return;
            }
            else {
                throw new Error(failMsg);
            }
        }
        window.open(this.getImgSrc(info, extendService));
    }
    /**
     * 下载附件
     * @param {?} infos
     * @param {?} extendService
     * @return {?}
     */
    multiDownloadFiles(infos, extendService) {
        //metadataIdList: string[]
        if (infos.length == 1) {
            this.downloadFile(infos[0], extendService);
        }
        else {
            /** @type {?} */
            let rootId = this.getFinallyConfig('rootId', extendService);
            /** @type {?} */
            let metadataIdList = [];
            infos.forEach((/**
             * @param {?} item
             * @return {?}
             */
            item => {
                metadataIdList.push(item.extend['metadataId']);
            }));
            /** @type {?} */
            let url = this.downloadSer.getMultipleDownloadUrl(JSON.stringify(metadataIdList), rootId);
            window.open(url);
        }
    }
    /**
     * @param {?} infos
     * @param {?=} name
     * @param {?=} extendService
     * @return {?}
     */
    multiDownloadFilesWidthName(infos, name = "", extendService) {
        //metadataIdList: string[]
        if (infos.length == 1) {
            this.downloadFile(infos[0], extendService);
        }
        else {
            /** @type {?} */
            let rootId = this.getFinallyConfig('rootId', extendService);
            /** @type {?} */
            let metadataIdList = [];
            infos.forEach((/**
             * @param {?} item
             * @return {?}
             */
            item => {
                metadataIdList.push(item.extend['metadataId']);
            }));
            /** @type {?} */
            let url = this.downloadSer.getMultipleDownloadUrlWithName(JSON.stringify(metadataIdList), rootId, name);
            window.open(url);
        }
    }
    /**
     * 获取下载链接
     * @param {?} info
     * @param {?} extendService
     * @return {?}
     */
    getImgSrc(info, extendService) {
        if (!info.id) {
            /** @type {?} */
            let failMsg = this.getLocalStr('uploadAdapt.needFile');
            if (this.notifySer) {
                this.notifySer.warning(failMsg);
                return;
            }
            else {
                throw new Error(failMsg);
            }
        }
        /** @type {?} */
        let url = '';
        /** @type {?} */
        let attachId = info.extend['metadataId'];
        /** @type {?} */
        let rootId = this.getFinallyConfig('rootId', extendService);
        // 文档服务服务单元名进行规范性调整，由document修改为dfs
        if (this.downloadSer) {
            if (rootId) {
                url = this.downloadSer.getDownloadUrl(attachId, rootId);
            }
        }
        else if (rootId) {
            console.warn(this.getLocalStr('uploadAdapt.recompile'));
            url = `${this.perfixStr}/api/runtime/dfs/v1.0/formdoc/filecontent?metadataid=${attachId}&rootid=${rootId}`;
        }
        return url;
    }
    /**
     * 根据预览指令的扩展配置获取
     * @param {?} value
     * @return {?}
     */
    setPreviwExtendServerConfig(value) {
        this.previewExtendServerConfig = value;
    }
    /**
     * @return {?}
     */
    getPreviewExtendServerConfig() {
        return this.previewExtendServerConfig;
    }
    /**
     * @param {?} lanKey
     * @return {?}
     */
    getLocalStr(lanKey) {
        return this.configSer.getLocalStr(lanKey);
    }
}
FfilepreviewAdaptUnifileService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
FfilepreviewAdaptUnifileService.ctorParameters = () => [
    { type: FileViewerService },
    { type: FFileUploadAdaptUnifileConfigService },
    { type: DownloadService, decorators: [{ type: Optional }] },
    { type: Injector, decorators: [{ type: Optional }] }
];
/** @nocollapse */ FfilepreviewAdaptUnifileService.ngInjectableDef = i0.defineInjectable({ factory: function FfilepreviewAdaptUnifileService_Factory() { return new FfilepreviewAdaptUnifileService(i0.inject(i1.FileViewerService), i0.inject(i2.FFileUploadAdaptUnifileConfigService), i0.inject(i3.DownloadService, 8), i0.inject(i0.INJECTOR, 8)); }, token: FfilepreviewAdaptUnifileService, providedIn: "root" });
if (false) {
    /** @type {?} */
    FfilepreviewAdaptUnifileService.prototype.extendData;
    /**
     * @type {?}
     * @private
     */
    FfilepreviewAdaptUnifileService.prototype.previewExtendServerConfig;
    /** @type {?} */
    FfilepreviewAdaptUnifileService.prototype.notifySer;
    /**
     * @type {?}
     * @private
     */
    FfilepreviewAdaptUnifileService.prototype.perfixStr;
    /**
     * @type {?}
     * @private
     */
    FfilepreviewAdaptUnifileService.prototype.fileviewSer;
    /**
     * @type {?}
     * @private
     */
    FfilepreviewAdaptUnifileService.prototype.configSer;
    /**
     * @type {?}
     * @private
     */
    FfilepreviewAdaptUnifileService.prototype.downloadSer;
    /**
     * @type {?}
     * @private
     */
    FfilepreviewAdaptUnifileService.prototype.inject;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmZpbGVwcmV2aWV3LWFkYXB0LXVuaWZpbGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZXh0ZW5kLWZpbGV1cGxvYWQtYWRhcHQtdW5pZmlsZS8iLCJzb3VyY2VzIjpbImxpYi9mZmlsZXByZXZpZXctYWRhcHQtdW5pZmlsZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRS9ELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDMUQsT0FBTyxFQUFFLG9DQUFvQyxFQUFpQyxNQUFNLG9DQUFvQyxDQUFDO0FBQ3pILE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLG1CQUFtQixDQUFDOzs7OztBQUt4RCxNQUFNLE9BQU8sK0JBQStCOzs7Ozs7O0lBS3hDLFlBQW9CLFdBQThCLEVBQVUsU0FBK0MsRUFBc0IsV0FBNEIsRUFBcUIsTUFBZTtRQUE3SyxnQkFBVyxHQUFYLFdBQVcsQ0FBbUI7UUFBVSxjQUFTLEdBQVQsU0FBUyxDQUFzQztRQUFzQixnQkFBVyxHQUFYLFdBQVcsQ0FBaUI7UUFBcUIsV0FBTSxHQUFOLE1BQU0sQ0FBUzs7UUFIekwsOEJBQXlCLEdBQWtDLElBQUksQ0FBQztRQUN4RSxjQUFTLEdBQWtCLElBQUksQ0FBQztRQUN4QixjQUFTLEdBQUMsRUFBRSxDQUFDO1FBRWpCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUM3QyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxDQUFDLGFBQWEs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RyxDQUFDO0lBQ2YsQ0FBQzs7Ozs7O0lBS0QsMkJBQTJCLENBQUMsS0FBSztRQUM3QixJQUFJLENBQUMseUJBQXlCLEdBQUcsS0FBSyxDQUFDO0lBQzNDLENBQUM7Ozs7SUFDRCw0QkFBNEI7UUFDeEIsT0FBTyxJQUFJLENBQUMseUJBQXlCLENBQUM7SUFDMUMsQ0FBQzs7Ozs7SUFDRCxXQUFXLENBQUMsTUFBYTtRQUNyQixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzlDLENBQUM7OztZQTNKSixVQUFVLFNBQUM7Z0JBQ1IsVUFBVSxFQUFFLE1BQU07YUFDckI7Ozs7WUFQUSxpQkFBaUI7WUFFakIsb0NBQW9DO1lBRHBDLGVBQWUsdUJBWTBGLFFBQVE7WUFoQnJHLFFBQVEsdUJBZ0JzSSxRQUFROzs7OztJQUp2SyxxREFBVzs7Ozs7SUFDWCxvRUFBd0U7O0lBQ3hFLG9EQUFnQzs7Ozs7SUFDaEMsb0RBQXFCOzs7OztJQUNULHNEQUFzQzs7Ozs7SUFBRSxvREFBdUQ7Ozs7O0lBQUUsc0RBQWdEOzs7OztJQUFDLGlEQUFtQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBGVXBsb2FkRmlsZUV4dGVuZCB9IGZyb20gJ0BmYXJyaXMvZXh0ZW5kLWZpbGUtdXBsb2FkJztcclxuaW1wb3J0IHsgTm90aWZ5U2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbm90aWZ5JztcclxuaW1wb3J0IHsgRmlsZVZpZXdlclNlcnZpY2UgfSBmcm9tICdAZ3NwLXN2Yy9maWxlLXZpZXdlcic7XHJcbmltcG9ydCB7IERvd25sb2FkU2VydmljZSB9IGZyb20gJ0Bnc3Atc3ZjL2Zvcm1kb2MtdXBsb2FkJztcclxuaW1wb3J0IHsgRkZpbGVVcGxvYWRBZGFwdFVuaWZpbGVDb25maWdTZXJ2aWNlLCBGRmlsZVVwbG9hZEFkYXB0VW5pZmlsZUNvbmZpZyB9IGZyb20gJy4vZmZpbGV1cGxvYWQtYWRhcHQtdW5pZmlsZS5jb25maWcnO1xyXG5pbXBvcnQgeyBXRUJBUElfUFJFRklYX1RPS0VOIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24nO1xyXG5pbXBvcnQgeyBMb2NhbGVTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1sb2NhbGUnO1xyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIEZmaWxlcHJldmlld0FkYXB0VW5pZmlsZVNlcnZpY2Uge1xyXG4gICAgZXh0ZW5kRGF0YTsvLyDmmoLml7bnlKjkuo7nroDljZXlkIjlubZcclxuICAgIHByaXZhdGUgcHJldmlld0V4dGVuZFNlcnZlckNvbmZpZzogRkZpbGVVcGxvYWRBZGFwdFVuaWZpbGVDb25maWcgPSBudWxsO1xyXG4gICAgbm90aWZ5U2VyOiBOb3RpZnlTZXJ2aWNlID0gbnVsbDtcclxuICAgIHByaXZhdGUgcGVyZml4U3RyPScnO1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBmaWxldmlld1NlcjogRmlsZVZpZXdlclNlcnZpY2UsIHByaXZhdGUgY29uZmlnU2VyOiBGRmlsZVVwbG9hZEFkYXB0VW5pZmlsZUNvbmZpZ1NlcnZpY2UsIEBPcHRpb25hbCgpIHByaXZhdGUgZG93bmxvYWRTZXI6IERvd25sb2FkU2VydmljZSxAT3B0aW9uYWwoKSBwcml2YXRlIGluamVjdDpJbmplY3Rvcikge1xyXG4gICAgICAgIHRoaXMuZXh0ZW5kRGF0YSA9IHRoaXMuY29uZmlnU2VyLmdldENvbmZpZygpO1xyXG4gICAgICAgIHRoaXMubm90aWZ5U2VyID0gdGhpcy5maWxldmlld1NlclsnaW5qZWN0b3InXS5nZXQoTm90aWZ5U2VydmljZSwgbnVsbCk7XHJcbiAgICAgICAgaWYodGhpcy5ub3RpZnlTZXIpe1xyXG4gICAgICAgICAgICB0aGlzLmNvbmZpZ1Nlci5zZXRMb2NhbFN0YXRlKHRoaXMubm90aWZ5U2VyLmxvY2FsZVNlcnZpY2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDmraTlpIRpbmplY3TnmoTml7bmnLrlkox1cGxvYWTmnI3liqHph4znmoTkuIDmoLfvvIzmraTlpITkuI3nlKjlho3liKTmlq3lpJror63oqIBcclxuICAgICAgICBpZiggdGhpcy5pbmplY3Qpe1xyXG4gICAgICAgICAgICBpZihXRUJBUElfUFJFRklYX1RPS0VOKXtcclxuICAgICAgICAgICAgICAgIHRoaXMucGVyZml4U3RyID0gdGhpcy5pbmplY3QuZ2V0KFdFQkFQSV9QUkVGSVhfVE9LRU4sICcnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnU2VyLnNldEJhc2VQYXRoKHRoaXMucGVyZml4U3RyKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOi/lOWbnuacgOe7iOWxnuaAp+WAvFxyXG4gICAgICogQHBhcmFtIGtleSBcclxuICAgICAqIEBwYXJhbSBjb25maWdWYWx1ZSBcclxuICAgICAqIEBwYXJhbSBleHRlbmRWYWx1ZSBcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBnZXRGaW5hbGx5Q29uZmlnKGtleSwgZXh0ZW5kVmFsdWUpIHtcclxuICAgICAgICBpZiAoZXh0ZW5kVmFsdWUgJiYgZXh0ZW5kVmFsdWUuaGFzT3duUHJvcGVydHkoa2V5KSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZXh0ZW5kVmFsdWVba2V5XTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g6YG/5YWN5LiL6L29562J5YW25LuW5oyH5Luk5YaN5Lyg5YWl5omp5bGV6YWN572uXHJcbiAgICAgICAgaWYgKHRoaXMucHJldmlld0V4dGVuZFNlcnZlckNvbmZpZyAmJiB0aGlzLnByZXZpZXdFeHRlbmRTZXJ2ZXJDb25maWcuaGFzT3duUHJvcGVydHkoa2V5KSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wcmV2aWV3RXh0ZW5kU2VydmVyQ29uZmlnW2tleV07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOadpeiHqm1vZHVsZeS4rWZvclJvb3TnmoTphY3nva5cclxuICAgICAgICBpZiAodGhpcy5leHRlbmREYXRhLmhhc093blByb3BlcnR5KGtleSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXh0ZW5kRGF0YVtrZXldO1xyXG4gICAgICAgIH1cclxuICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICBcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog6aKE6KeI5Y2V5Liq5paH5Lu2XHJcbiAgICAgKiBAcGFyYW0gaW5mbyBcclxuICAgICAqL1xyXG4gICAgcHJldmlld0ZpbGUoaW5mbzogRlVwbG9hZEZpbGVFeHRlbmQsIGV4dGVuZFNlcnZpY2U6IEZGaWxlVXBsb2FkQWRhcHRVbmlmaWxlQ29uZmlnKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucHJldmlld0ZpbGVMaXN0KFtpbmZvXSwgZXh0ZW5kU2VydmljZSk7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOmihOiniOaVtOS4quWIl+ihqFxyXG4gICAgICogQHBhcmFtIGluZm9zIFxyXG4gICAgICovXHJcbiAgICBwcmV2aWV3RmlsZUxpc3QoaW5mb3M6IEZVcGxvYWRGaWxlRXh0ZW5kW10sIGV4dGVuZFNlcnZpY2U6IEZGaWxlVXBsb2FkQWRhcHRVbmlmaWxlQ29uZmlnKSB7XHJcbiAgICAgICAgLy9tZXRhZGF0YUlkTGlzdDogc3RyaW5nW11cclxuICAgICAgICBsZXQgcm9vdElkID0gdGhpcy5nZXRGaW5hbGx5Q29uZmlnKCdyb290SWQnLCBleHRlbmRTZXJ2aWNlKTtcclxuICAgICAgICBsZXQgbWV0YWRhdGFJZExpc3QgPSBbXTtcclxuICAgICAgICBpbmZvcy5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICBtZXRhZGF0YUlkTGlzdC5wdXNoKGl0ZW0uZXh0ZW5kWydtZXRhZGF0YUlkJ10pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxldCBvcHRpb25zID0gdGhpcy5nZXRGaW5hbGx5Q29uZmlnKCdvcHRpb25zJywgZXh0ZW5kU2VydmljZSk7XHJcbiAgICAgICAgaWYob3B0aW9ucyl7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmZpbGV2aWV3U2VyLnZpZXdlckZpbGVMaXN0KG1ldGFkYXRhSWRMaXN0LCByb290SWQsIG9wdGlvbnMpO1xyXG4gICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5maWxldmlld1Nlci52aWV3ZXJGaWxlTGlzdChtZXRhZGF0YUlkTGlzdCwgcm9vdElkKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOS4i+i9vemZhOS7tlxyXG4gICAgICogQHBhcmFtIGluZm8gXHJcbiAgICAgKi9cclxuICAgIGRvd25sb2FkRmlsZShpbmZvOiBGVXBsb2FkRmlsZUV4dGVuZCwgZXh0ZW5kU2VydmljZTogRkZpbGVVcGxvYWRBZGFwdFVuaWZpbGVDb25maWcpIHtcclxuICAgICAgICBpZiAoIWluZm8uaWQpIHtcclxuICAgICAgICAgICAgbGV0IGZhaWxNc2c9dGhpcy5nZXRMb2NhbFN0cigndXBsb2FkQWRhcHQubmVlZEZpbGUnKTtcclxuICAgICAgICAgICAgaWYodGhpcy5ub3RpZnlTZXIpe1xyXG4gICAgICAgICAgICAgICAgdGhpcy5ub3RpZnlTZXIud2FybmluZyhmYWlsTXNnKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFpbE1zZyk7XHJcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcclxuICAgICAgICB9XHJcbiAgICAgICAgd2luZG93Lm9wZW4odGhpcy5nZXRJbWdTcmMoaW5mbywgZXh0ZW5kU2VydmljZSkpO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICog5LiL6L296ZmE5Lu2XHJcbiAgICogQHBhcmFtIGluZm8gXHJcbiAgICovXHJcbiAgICBtdWx0aURvd25sb2FkRmlsZXMoaW5mb3M6IEZVcGxvYWRGaWxlRXh0ZW5kW10sIGV4dGVuZFNlcnZpY2U6IEZGaWxlVXBsb2FkQWRhcHRVbmlmaWxlQ29uZmlnKSB7XHJcbiAgICAgICAgLy9tZXRhZGF0YUlkTGlzdDogc3RyaW5nW11cclxuICAgICAgICBpZiAoaW5mb3MubGVuZ3RoID09IDEpIHtcclxuICAgICAgICAgICAgdGhpcy5kb3dubG9hZEZpbGUoaW5mb3NbMF0sIGV4dGVuZFNlcnZpY2UpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxldCByb290SWQgPSB0aGlzLmdldEZpbmFsbHlDb25maWcoJ3Jvb3RJZCcsIGV4dGVuZFNlcnZpY2UpO1xyXG4gICAgICAgICAgICBsZXQgbWV0YWRhdGFJZExpc3QgPSBbXTtcclxuICAgICAgICAgICAgaW5mb3MuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICAgICAgICAgIG1ldGFkYXRhSWRMaXN0LnB1c2goaXRlbS5leHRlbmRbJ21ldGFkYXRhSWQnXSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBsZXQgdXJsID0gdGhpcy5kb3dubG9hZFNlci5nZXRNdWx0aXBsZURvd25sb2FkVXJsKEpTT04uc3RyaW5naWZ5KG1ldGFkYXRhSWRMaXN0KSwgcm9vdElkKTtcclxuICAgICAgICAgICAgd2luZG93Lm9wZW4odXJsKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBtdWx0aURvd25sb2FkRmlsZXNXaWR0aE5hbWUoaW5mb3M6IEZVcGxvYWRGaWxlRXh0ZW5kW10sIG5hbWUgPSBcIlwiLCBleHRlbmRTZXJ2aWNlOiBGRmlsZVVwbG9hZEFkYXB0VW5pZmlsZUNvbmZpZykge1xyXG4gICAgICAgIC8vbWV0YWRhdGFJZExpc3Q6IHN0cmluZ1tdXHJcbiAgICAgICAgaWYgKGluZm9zLmxlbmd0aCA9PSAxKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZG93bmxvYWRGaWxlKGluZm9zWzBdLCBleHRlbmRTZXJ2aWNlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsZXQgcm9vdElkID0gdGhpcy5nZXRGaW5hbGx5Q29uZmlnKCdyb290SWQnLCBleHRlbmRTZXJ2aWNlKTtcclxuICAgICAgICAgICAgbGV0IG1ldGFkYXRhSWRMaXN0ID0gW107XHJcbiAgICAgICAgICAgIGluZm9zLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICAgICAgICBtZXRhZGF0YUlkTGlzdC5wdXNoKGl0ZW0uZXh0ZW5kWydtZXRhZGF0YUlkJ10pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgbGV0IHVybCA9IHRoaXMuZG93bmxvYWRTZXIuZ2V0TXVsdGlwbGVEb3dubG9hZFVybFdpdGhOYW1lKEpTT04uc3RyaW5naWZ5KG1ldGFkYXRhSWRMaXN0KSwgcm9vdElkLCBuYW1lKTtcclxuICAgICAgICAgICAgd2luZG93Lm9wZW4odXJsKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPluS4i+i9vemTvuaOpVxyXG4gICAgKi9cclxuICAgIGdldEltZ1NyYyhpbmZvOiBGVXBsb2FkRmlsZUV4dGVuZCwgZXh0ZW5kU2VydmljZTogRkZpbGVVcGxvYWRBZGFwdFVuaWZpbGVDb25maWcpIHtcclxuICAgICAgICBpZiAoIWluZm8uaWQpIHsgICAgICAgICAgICBcclxuICAgICAgICAgICAgbGV0IGZhaWxNc2c9dGhpcy5nZXRMb2NhbFN0cigndXBsb2FkQWRhcHQubmVlZEZpbGUnKTtcclxuICAgICAgICAgICAgaWYodGhpcy5ub3RpZnlTZXIpe1xyXG4gICAgICAgICAgICAgICAgdGhpcy5ub3RpZnlTZXIud2FybmluZyhmYWlsTXNnKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFpbE1zZyk7XHJcbiAgICAgICAgICAgIH0gICBcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHVybCA9ICcnO1xyXG4gICAgICAgIGxldCBhdHRhY2hJZCA9IGluZm8uZXh0ZW5kWydtZXRhZGF0YUlkJ107XHJcbiAgICAgICAgbGV0IHJvb3RJZCA9IHRoaXMuZ2V0RmluYWxseUNvbmZpZygncm9vdElkJywgZXh0ZW5kU2VydmljZSk7XHJcbiAgICAgICAgLy8g5paH5qGj5pyN5Yqh5pyN5Yqh5Y2V5YWD5ZCN6L+b6KGM6KeE6IyD5oCn6LCD5pW077yM55SxZG9jdW1lbnTkv67mlLnkuLpkZnNcclxuICAgICAgICBpZiAodGhpcy5kb3dubG9hZFNlcikge1xyXG4gICAgICAgICAgICBpZiAocm9vdElkKSB7XHJcbiAgICAgICAgICAgICAgICB1cmwgPSB0aGlzLmRvd25sb2FkU2VyLmdldERvd25sb2FkVXJsKGF0dGFjaElkLCByb290SWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIGlmIChyb290SWQpIHtcclxuICAgICAgICAgICAgY29uc29sZS53YXJuKHRoaXMuZ2V0TG9jYWxTdHIoJ3VwbG9hZEFkYXB0LnJlY29tcGlsZScpKTtcclxuICAgICAgICAgICAgdXJsID0gYCR7dGhpcy5wZXJmaXhTdHJ9L2FwaS9ydW50aW1lL2Rmcy92MS4wL2Zvcm1kb2MvZmlsZWNvbnRlbnQ/bWV0YWRhdGFpZD0ke2F0dGFjaElkfSZyb290aWQ9JHtyb290SWR9YDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHVybDtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog5qC55o2u6aKE6KeI5oyH5Luk55qE5omp5bGV6YWN572u6I635Y+WXHJcbiAgICAgKiBAcGFyYW0gdmFsdWUgXHJcbiAgICAgKi9cclxuICAgIHNldFByZXZpd0V4dGVuZFNlcnZlckNvbmZpZyh2YWx1ZSkge1xyXG4gICAgICAgIHRoaXMucHJldmlld0V4dGVuZFNlcnZlckNvbmZpZyA9IHZhbHVlO1xyXG4gICAgfVxyXG4gICAgZ2V0UHJldmlld0V4dGVuZFNlcnZlckNvbmZpZygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wcmV2aWV3RXh0ZW5kU2VydmVyQ29uZmlnO1xyXG4gICAgfVxyXG4gICAgZ2V0TG9jYWxTdHIobGFuS2V5OnN0cmluZyl7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY29uZmlnU2VyLmdldExvY2FsU3RyKGxhbktleSk7XHJcbiAgICB9XHJcbn0iXX0=