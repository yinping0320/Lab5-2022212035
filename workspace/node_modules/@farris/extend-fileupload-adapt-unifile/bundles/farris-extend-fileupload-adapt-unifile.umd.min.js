!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@farris/ui-notify"),require("@gsp-svc/file-viewer"),require("@gsp-svc/formdoc-upload"),require("@farris/ui-common"),require("@farris/extend-file-upload"),require("rxjs"),require("rxjs/operators"),require("@farris/ui-locale"),require("@angular/common")):"function"==typeof define&&define.amd?define("@farris/extend-fileupload-adapt-unifile",["exports","@angular/core","@farris/ui-notify","@gsp-svc/file-viewer","@gsp-svc/formdoc-upload","@farris/ui-common","@farris/extend-file-upload","rxjs","rxjs/operators","@farris/ui-locale","@angular/common"],t):t(((e=e||self).farris=e.farris||{},e.farris["extend-fileupload-adapt-unifile"]={}),e.ng.core,e.uiNotify,e.fileViewer,e.formdocUpload,e.uiCommon,e.extendFileUpload,e.rxjs,e.rxjs.operators,e.uiLocale,e.ng.common)}(this,(function(e,t,r,i,o,n,a,l,s,p,d){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var f=function(e,t){return(f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};var u=function(){return(u=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function c(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var i,o,n=r.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(i=n.next()).done;)a.push(i.value)}catch(e){o={error:e}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(o)throw o.error}}return a}var h={en:{uploadAdapt:{needFile:"Please set the attachment to be downloaded",recompile:"Due to security issues, the attachment download provides a security verification mechanism, and the attachment download function needs to be recompiled",uploadError:"Upload failed"},previewAdapt:{notSupport:"This file does not support preview"}},"zh-CHS":{uploadAdapt:{needFile:"请设置要下载的附件",recompile:"因为安全问题，附件下载提供安全校验机制，附件下载功能需要重新编译",uploadError:"上传失败"},previewAdapt:{notSupport:"此文件不支持预览"}},"zh-CHT":{uploadAdapt:{needFile:"請設定要下載的附件",recompile:"因為安全問題，附件下載提供安全校驗機制，附件下載功能需要重新編譯",uploadError:"上傳失敗"},previewAdapt:{notSupport:"此檔案不支持預覽"}}};var g=new t.InjectionToken("MFFileUploadAdaptUnifileConfig"),v=function(){function e(e){this.config={rootId:"",formId:"",mode:0},this.basePerfixStr="",e&&Object.assign(this.config,e)}return e.prototype.getConfig=function(){return this.config},e.prototype.setConfig=function(e,t){this.config[e]=t},e.prototype.setBasePath=function(e){this.basePerfixStr=e},e.prototype.getBasePath=function(){return this.basePerfixStr},e.prototype.setLocalState=function(e){return!!this.localSerStorage||!(!e||this.localSerStorage)&&(e.setLocaleData(h),this.localSerStorage=e,!0)},e.prototype.getLocalStr=function(e){var t="",r="en";return this.localSerStorage?t=this.localSerStorage.getValue(e):r=localStorage.getItem("languageCode")||"zh-CHS",t||(t=e.split(".").reduce((function(e,t){return e?e[t]:null}),h[r])),t},e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:void 0,decorators:[{type:t.Optional},{type:t.Inject,args:[g]}]}]},e.ngInjectableDef=t.defineInjectable({factory:function(){return new e(t.inject(g,8))},token:e,providedIn:"root"}),e}();var m=function(){function e(e,t,i,o){this.fileviewSer=e,this.configSer=t,this.downloadSer=i,this.inject=o,this.previewExtendServerConfig=null,this.notifySer=null,this.perfixStr="",this.extendData=this.configSer.getConfig(),this.notifySer=this.fileviewSer.injector.get(r.NotifyService,null),this.notifySer&&this.configSer.setLocalState(this.notifySer.localeService),this.inject&&n.WEBAPI_PREFIX_TOKEN&&(this.perfixStr=this.inject.get(n.WEBAPI_PREFIX_TOKEN,""),this.configSer.setBasePath(this.perfixStr))}return e.prototype.getFinallyConfig=function(e,t){return t&&t.hasOwnProperty(e)?t[e]:this.previewExtendServerConfig&&this.previewExtendServerConfig.hasOwnProperty(e)?this.previewExtendServerConfig[e]:this.extendData.hasOwnProperty(e)?this.extendData[e]:null},e.prototype.previewFile=function(e,t){return this.previewFileList([e],t)},e.prototype.previewFileList=function(e,t){var r=this.getFinallyConfig("rootId",t),i=[];e.forEach((function(e){i.push(e.extend.metadataId)}));var o=this.getFinallyConfig("options",t);return o?this.fileviewSer.viewerFileList(i,r,o):this.fileviewSer.viewerFileList(i,r)},e.prototype.downloadFile=function(e,t){if(!e.id){var r=this.getLocalStr("uploadAdapt.needFile");if(this.notifySer)return void this.notifySer.warning(r);throw new Error(r)}window.open(this.getImgSrc(e,t))},e.prototype.multiDownloadFiles=function(e,t){if(1==e.length)this.downloadFile(e[0],t);else{var r=this.getFinallyConfig("rootId",t),i=[];e.forEach((function(e){i.push(e.extend.metadataId)}));var o=this.downloadSer.getMultipleDownloadUrl(JSON.stringify(i),r);window.open(o)}},e.prototype.multiDownloadFilesWidthName=function(e,t,r){if(void 0===t&&(t=""),1==e.length)this.downloadFile(e[0],r);else{var i=this.getFinallyConfig("rootId",r),o=[];e.forEach((function(e){o.push(e.extend.metadataId)}));var n=this.downloadSer.getMultipleDownloadUrlWithName(JSON.stringify(o),i,t);window.open(n)}},e.prototype.getImgSrc=function(e,t){if(!e.id){var r=this.getLocalStr("uploadAdapt.needFile");if(this.notifySer)return void this.notifySer.warning(r);throw new Error(r)}var i="",o=e.extend.metadataId,n=this.getFinallyConfig("rootId",t);return this.downloadSer?n&&(i=this.downloadSer.getDownloadUrl(o,n)):n&&(console.warn(this.getLocalStr("uploadAdapt.recompile")),i=this.perfixStr+"/api/runtime/dfs/v1.0/formdoc/filecontent?metadataid="+o+"&rootid="+n),i},e.prototype.setPreviwExtendServerConfig=function(e){this.previewExtendServerConfig=e},e.prototype.getPreviewExtendServerConfig=function(){return this.previewExtendServerConfig},e.prototype.getLocalStr=function(e){return this.configSer.getLocalStr(e)},e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:i.FileViewerService},{type:v},{type:o.DownloadService,decorators:[{type:t.Optional}]},{type:t.Injector,decorators:[{type:t.Optional}]}]},e.ngInjectableDef=t.defineInjectable({factory:function(){return new e(t.inject(i.FileViewerService),t.inject(v),t.inject(o.DownloadService,8),t.inject(t.INJECTOR,8))},token:e,providedIn:"root"}),e}();var y=function(){function e(e){this.previewSer=e,this.viewDisabled=!1,this.extendServerConfig=null}return e.prototype.filePreviewEventHandler=function(){this.fileInfo&&!this.viewDisabled&&this.previewSer.previewFile(this.fileInfo,this.extendServerConfig)},e.decorators=[{type:t.Directive,args:[{selector:"[fFileAdaptPreviewFile]"}]}],e.ctorParameters=function(){return[{type:m}]},e.propDecorators={fileInfo:[{type:t.Input,args:["fFileAdaptPreviewFile"]}],filePreviewEventHandler:[{type:t.HostListener,args:["click",["$event"]]}],viewDisabled:[{type:t.Input}],extendServerConfig:[{type:t.Input}]},e}();var S=function(){function e(e){this.previewSer=e,this.zipName="",this.downloadDisabled=!1,this.extendServerConfig=null,this.enableMulti=!1}return e.prototype.filePreviewEventHandler=function(){this.fileInfo&&!this.downloadDisabled&&(this.enableMulti&&this.fileInfo instanceof Array?this.previewSer.multiDownloadFilesWidthName(this.fileInfo,this.zipName,this.extendServerConfig):this.previewSer.downloadFile(this.fileInfo,this.extendServerConfig))},e.decorators=[{type:t.Directive,args:[{selector:"[fFileAdaptDownloadFile]"}]}],e.ctorParameters=function(){return[{type:m}]},e.propDecorators={fileInfo:[{type:t.Input,args:["fFileAdaptDownloadFile"]}],filePreviewEventHandler:[{type:t.HostListener,args:["click",["$event"]]}],zipName:[{type:t.Input}],downloadDisabled:[{type:t.Input}],extendServerConfig:[{type:t.Input}],enableMulti:[{type:t.Input}]},e}();var w=function(){function e(e,t){this.adpSer=e,this.elementRef=t,this.cls=!0,this.enableThumbnail=!1,this.clsPrefix="ffilepreview--filetype",this.supportImgSuffix="jpeg,jpg,gif,png,bmp",this.iconWidth=38,this.maxThumbnailWidth="100%",this.maxThumbnailHeight="100%",this.extendServerConfig=null}return e.prototype.ngOnInit=function(){},e.prototype.imgSrc=function(){return this.adpSer.getImgSrc(this.fileInfo,this.extendServerConfig)},e.prototype.isImage=function(){if(!this.fileInfo)return!1;var e=this.fileInfo.name;if(!e)return!1;var t=e.lastIndexOf("."),r="";return t>-1&&(r=e.substring(t+1).toLocaleLowerCase()),!!r&&this.supportImgSuffix.split(",").findIndex((function(e){return e==r}))>-1},e.prototype.getFileTypeClassName=function(){var e=this.clsPrefix;if(!this.fileInfo||!this.fileInfo.name)return e+"-any";var t=this.fileInfo.name,r=t.lastIndexOf("."),i="";switch(r>-1&&(i=t.substring(r+1).toLocaleLowerCase()),i){case"pdf":e+="-pdf";break;case"jpeg":case"jpg":case"gif":case"png":case"bmp":e+="-img";break;case"ppt":e+="-ppt";break;case"doc":case"docx":e+="-doc";break;case"xls":case"xlsx":e+="-xls";break;case"txt":e+="-txt";break;case"zip":e+="-zip";break;default:e+="-any"}return e},e.decorators=[{type:t.Component,args:[{selector:"ffilepreview-adapt-seeimg",template:'<div class="ffilepreview-seeimg--wrapper" [ngClass]="{\'ffilepreview-seeimg--thumbnail\':enableThumbnail}">\r\n  <ng-container *ngIf="enableThumbnail&&isImage();else notImage">\r\n    <img class="ffilepreview-seeimg--img" [src]="imgSrc()" [ngStyle]="{\'maxWidth\':maxThumbnailWidth,\'maxHeight\':maxThumbnailHeight}"/>\r\n  </ng-container>\r\n</div>\r\n<ng-template #notImage>\r\n  <span class="ffilepreview--filetype-icon" [ngClass]="getFileTypeClassName()" [ngStyle]="{\'width\':iconWidth+\'px\',\'height\':iconWidth+\'px\'}"></span>\r\n</ng-template>',styles:[":host{height:100%;width:100%;position:relative}.ffilepreview-seeimg--thumbnail{top:0;bottom:0;position:absolute;right:0;left:0;display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center}.ffilepreview-seeimg--wrapper:hover{opacity:.8}.ffilepreview-seeimg--img{max-width:100%;max-height:100%;border-radius:4px}"]}]}],e.ctorParameters=function(){return[{type:m},{type:t.ElementRef}]},e.propDecorators={cls:[{type:t.HostBinding,args:["class.ffilepreview-adapt-seeimg"]}],enableThumbnail:[{type:t.Input}],clsPrefix:[{type:t.Input}],supportImgSuffix:[{type:t.Input}],fileInfo:[{type:t.Input}],iconWidth:[{type:t.Input}],maxThumbnailWidth:[{type:t.Input}],maxThumbnailHeight:[{type:t.Input}],extendServerConfig:[{type:t.Input}]},e}();var I=function(e){function r(t,r,i){var o=e.call(this)||this;o.uploadSer=t,o.configSer=r,o.inject=i,o.bufferSize=1048576,o.uploadedChunk={},o.fileTotalChunk={},o.serverConfig=null,o.extendData=o.configSer.getConfig();var n=o.configSer.setLocalState(null);return o.inject&&!n&&o.configSer.setLocalState(o.inject.get(p.LocaleService,null)),o}return function(e,t){function r(){this.constructor=e}f(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(r,e),r.prototype.getPrefixStr=function(){return this.configSer.getBasePath()},r.prototype.uuid=function(){var e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},r.prototype.remove=function(e,t,r){return this.innerRemoveList(e,t,r)},r.prototype.innerRemoveList=function(e,t,r){var i=this;return void 0===r&&(r=null),new l.Observable((function(t){var n=new o.GspFormRemoveListEntity,a=[];e.forEach((function(e){e.response&&a.push(e.response.metadataId)})),n.mode=i.getFinallyConfig("mode",r);var l=i.getFinallyConfig("rootId",r);n.metadataIdList=[].concat(a),i.uploadSer.removeList(a,l).subscribe((function(r){t.next({type:"removed",files:e})}),(function(e){t.error(e),t.complete()}),(function(){t.complete()}))}))},r.prototype.upload=function(e,t,r){var i=this;if(this.formId=this.getFinallyConfig("formId",r),this.rootId=this.getFinallyConfig("rootId",r),"sliceUpload"==t.type){var o=function(){return i.serverConfig&&i.serverConfig.allowedMultiUpload?i.serverConfig.sameNameAllowed?i.uploadBigFile2(e,t,r):i.uploadSer.getUploadedFileInfoList(i.formId,i.rootId).pipe(s.switchMap((function(o){return null!=o&&null==o.error?(i.serverConfig.uploadedFileInfoList=o,i.serverConfig.oldUploadedFileList=JSON.parse(JSON.stringify(o)),i.uploadBigFile2(e,t,r)):l.of(o)}))):i.uploadBigFile(e,t,r)};return this.serverConfig?o():this.getServerConfig(this.rootId).pipe(s.switchMap((function(e){return null!=e&&null==e.error&&(i.serverConfig={sameNameAllowed:e.sameNameAllowed,allowedMultiUpload:e.allowedMultiUpload,maxFileSize:parseInt(JSON.parse(e.validateConfiguration).maxFileSize)}),o()})))}return this.innerUploadList(e,t,r)},r.prototype.innerUploadList=function(e,t,r){var i=this;return new l.Observable((function(n){var s=new o.GspFormUploadListEntity;s.formId=i.getFinallyConfig("formId",r),s.mode=i.getFinallyConfig("mode",r);var p=i.getFinallyConfig("rootId",r);s.docInfoList=[];var d=[];e.forEach((function(e){var r=new l.Observable((function(r){var i=new FileReader;i.readAsBinaryString(e.nativeFile),i.onload=function(o){var n={fileName:"",fileContent:""};n.fileName=e.name,n.fileContent=btoa(i.result.toString()),t.hasOwnProperty("data")&&t.data&&t.data.hasOwnProperty("extProperty")&&(n.extProperty=t.data.extProperty),s.docInfoList.push(n),r.next(),r.complete()}}));d.push(r)})),l.forkJoin(d).subscribe((function(t){i.uploadSer.uploadList(s,p).subscribe((function(t){if(t.error)return n.error(i.errorInfoFormat(t.error,e)),void n.complete();t.forEach((function(t){var r=i.findFileIndexByFileName(e,t.fileName);r>-1&&(e[r].response=t,e[r].progress.status=a.UploadStatus.Done)})),n.next({type:"done",files:e})}),(function(t){n.error(i.errorInfoFormat(t,e)),n.complete()}),(function(){n.complete()}))}))}))},r.prototype.multipartUpload=function(e,t,r){var i=this;return new l.Observable((function(n){var l=i.uuid(),s=e.name,p=Math.ceil(e.size/i.bufferSize);i.fileTotalChunk[l]=p;var d=0;i.uploadedChunk[l]=0;for(var f=function(){var f=new o.GspFormUploadEntity;f.mode=o.OperatingModes.Temp,f.formId=i.getFinallyConfig("formId",r),f.rootId=i.getFinallyConfig("rootId",r);var u=new o.GspFormDocInfo;u.fileName=s,u.metadataId=l,u.total=p,t.hasOwnProperty("data")&&t.data&&t.data.hasOwnProperty("extProperty")&&(u.extProperty=t.data.extProperty);var c=Math.min((d+1)*i.bufferSize,e.size),h=e.nativeFile.slice(d*i.bufferSize,c),g=new FileReader;g.readAsBinaryString(h);var v=d;g.onload=function(){u.fileContent=btoa(g.result.toString()),u.index=v,f.docInfo=u;var t=f;i.uploadSer.uploadFile(t).subscribe((function(t){if(t&&t.error)return n.error(i.errorInfoFormat(t.error,[e])),void n.complete();if(i.uploadedChunk[l]++,i.uploadedChunk[u.metadataId]==i.fileTotalChunk[u.metadataId])e.progress={status:a.UploadStatus.Done,data:{percentage:100}},e.response=u,delete i.uploadedChunk[l],delete i.fileTotalChunk[l],n.next({type:"done",files:[e]}),n.complete();else{var r=Number.parseInt((i.uploadedChunk[l]/i.fileTotalChunk[l]*100).toFixed(0));e.progress={status:a.UploadStatus.Uploading,data:{percentage:r}},n.next({type:"uploading",files:[e]})}}),(function(t){delete i.uploadedChunk[l],delete i.fileTotalChunk[l],n.error(i.errorInfoFormat(t,[e])),n.complete()}))},d+=1};d<p;)f()}))},r.prototype.formatFileSize=function(e){return e<102400?(e/1024).toFixed(1)+"K":e<1048576?(e/1024).toFixed(0)+"K":e<104857600?(e/1024/1024).toFixed(1)+"M":e<1073741824?(e/1024/1024).toFixed(0)+"M":(e/1024/1024/1024).toFixed(1)+"G"},r.prototype.getMultipartDisplayName=function(e){return e.length<=10?e:e.substring(0,2)+"…"+e.substring(e.lastIndexOf(".")-2)},r.prototype.errorInfoFormat=function(e,t){var r=t.map((function(e){return{id:e.id,name:e.name}})),i=this.configSer.getLocalStr("uploadAdapt.uploadError");return e?Object.assign(e,{files:r},{message:e.Message||e.extensionMessage||i,type:"error"}):Object.assign({files:r},{message:i,type:"error"})},r.prototype.getFinallyConfig=function(e,t){return t&&t.hasOwnProperty(e)?t[e]:this.extendData[e]},r.prototype.findFileIndexByFileName=function(e,t){return e.findIndex((function(e){return e.name==t}))},r.prototype.uploadBigFile=function(e,t,r){var i=this,o=new l.Subject,n=e.map((function(e){var o=i._getBigFileChunks(e,t,r);return u({},e,o)})).map((function(e){return i.uploadChunks(e,o)}));return l.concat.apply(void 0,function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(c(arguments[t]));return e}(n)).subscribe((function(e){e.progress={status:a.UploadStatus.Done,data:{percentage:100}},e.response=JSON.parse(e.chunks[0].get("docInfo")),o.next({type:"done",files:[e]})}),(function(t){o.error(i.errorInfoFormat(t,e)),o.complete()}),(function(){o.complete()})),o.asObservable()},r.prototype.uploadFileChunk=function(e){var t=this.getPrefixStr()+"/api/runtime/dfs/v1.0/formdoc/slice";return this.uploadSer.http.http.post(t,e.chunks[e.total]).pipe(s.switchMap((function(){return l.of(e)})),s.catchError((function(e){return l.of(e)})))},r.prototype.uploadChunks=function(e,t){var r,i=this;return(r=e,l.of(r)).pipe(s.expand((function(r){return--e.total>-1?function(e){return i.uploadFileChunk(e).pipe(s.delay(100),s.map((function(e){return e.progress={status:a.UploadStatus.Uploading,data:{percentage:(e.total/e.chunks.length*100).toFixed(0)}},t.next({type:"uploading",files:[e]}),e})))}(e):l.EMPTY})),s.last(),s.switchMap((function(t){return function(e){return l.of(e)}(e)})))},r.prototype._getBigFileChunks=function(e,t,r){for(var i=this.uuid(),n=this.getFinallyConfig("formId",r),a=this.getFinallyConfig("rootId",r),l=(t.chunkSize||1)*this.bufferSize,s=Math.ceil(e.size/l),p=0,d={chunks:[],total:s};p<s;){var f=new o.GspFormUploadEntity;f.mode=o.OperatingModes.Temp,f.formId=n,f.rootId=a;var u=new o.GspFormDocInfo;u.fileName=e.name,u.metadataId=i,u.total=s;var c=Math.min((p+1)*l,e.size),h=e.nativeFile.slice(p*l,c);u.size=e.size,u.index=p,u.fileContent="",t.hasOwnProperty("data")&&t.data&&t.data.hasOwnProperty("extProperty")&&(u.extProperty=t.data.extProperty),f.docInfo=u;var g=new FormData;g.append("uploadInfo",JSON.stringify(f)),g.append("docInfo",JSON.stringify(u)),g.append("file",h),d.chunks.push(g),p+=1}return d},r.prototype.getServerConfig=function(e){return this.uploadSer.getUploadInfo(e)},r.prototype.unorderedUploadBigFile=function(e,t){var r=this;e.partList||(e.partList=[]),this.initMultiUpload(e).subscribe((function(i){if(i&&i.error)return t.error(r.errorInfoFormat(i.error,[e])),void t.complete();e.chunks.forEach((function(o){r.multiUpload(o,i).subscribe((function(i){if(i&&i.error)return t.error(r.errorInfoFormat(i.error,[e])),void t.complete();if(e.progress={status:a.UploadStatus.Uploading,data:{percentage:(i.index/e.chunks.length*100).toFixed(0)}},t.next({type:"uploading",files:[e]}),i&&i.result&&e.partList.push(i.result),e.partList.length===e.chunks.length){var o={};o.metadataId=e.metadataId,o.partList=e.partList,o.rootId=r.rootId,o.uploadId=e.uploadId,o.size=e.size,r.completeMultiUpload(o).subscribe((function(i){if(i&&200!=i.status)return t.error(r.errorInfoFormat(i.error,[e])),void t.complete();e.progress={status:a.UploadStatus.Done,data:{percentage:100}},e.response=JSON.parse(e.chunks[0].get("docInfo")),t.next({type:"done",files:[e]})}),(function(i){t.error(r.errorInfoFormat(i,[e])),t.complete()}))}}))}))}))},r.prototype.uploadBigFile2=function(e,t,r){var i=this,o=new l.Subject,n=this.getFinallyConfig("formId",r),a=this.getFinallyConfig("rootId",r);return e.map((function(e){var o=i._getBigFileChunks2(e,t,r);return u({},e,o,{formId:n,rootId:a})})).forEach((function(e){i.unorderedUploadBigFile(e,o)})),o.asObservable()},r.prototype.initMultiUpload=function(e){var t={};t.path=e.formId,t.metadataId=this.uuid(),t.rootId=e.rootId,t.size=e.size,t.fileName=e.name;var r=this.getPrefixStr()+"/api/runtime/dfs/v1.0/formdoc/multi/init";return this.uploadSer.http.http.post(r,t).pipe(s.tap((function(r){e.metadataId=t.metadataId,e.uploadId=r.uploadId})),s.catchError((function(e){return l.of(e)})),s.map((function(e){return e.metadataId=t.metadataId,e})))},r.prototype.completeMultiUpload=function(e){var t=this.getPrefixStr()+"/api/runtime/dfs/v1.0/formdoc/multi/complete";return this.uploadSer.http.http.post(t,e).pipe(s.tap((function(e){})),s.catchError((function(e){return l.of(e)})))},r.prototype.multiUpload=function(e,t){var r=this.getPrefixStr()+"/api/runtime/dfs/v1.0/formdoc/multi/upload",i=JSON.parse(e.get("multiRequest"));i.uploadId=t.uploadId,i.metadataId=t.metadataId,e.set("multiRequest",JSON.stringify(i));var o=JSON.parse(e.get("docInfo"));return o.metadataId=t.metadataId,e.set("docInfo",JSON.stringify(o)),this.uploadSer.http.http.post(r,e).pipe(s.tap((function(e){})),s.catchError((function(e){return l.of(e)})))},r.prototype.uploadChunks2=function(e,t){var r,i=this,o=e.total,n=-1;return(r=e,i.initMultiUpload(r)).pipe(s.expand((function(r){return++n<o?function(r,o){return i.multiUpload(r,o).pipe(s.delay(100),s.map((function(r){return e.progress={status:a.UploadStatus.Uploading,data:{percentage:(r.index/e.chunks.length*100).toFixed(0)}},t.next({type:"uploading",files:[e]}),r&&r.result&&(e.partList||(e.partList=[]),e.partList.push(r.result)),e})))}(e.chunks[n],r):l.EMPTY})),s.last(),s.switchMap((function(t){return function(e){return l.of(e)}(e)})))},r.prototype._getBigFileChunks2=function(e,t,r){for(var i=this.uuid(),n=Math.max(t.chunkSize,5)*this.bufferSize,a=Math.ceil(e.size/n),l=0,s={chunks:[],total:a},p=this.getFinallyConfig("rootId",r);l<a;){var d=Math.min((l+1)*n,e.size),f=e.nativeFile.slice(l*n,d),u={};u.metadataId=i,u.rootId=p,u.index=l,u.total=a,u.size=f.size;var c=new FormData;c.append("multiRequest",JSON.stringify(u)),c.append("file",f);var h=new o.GspFormDocInfo;h.fileName=e.name,h.metadataId=i,h.total=a,h.size=e.size,h.index=l,h.fileContent="",c.append("docInfo",JSON.stringify(h)),t.hasOwnProperty("data")&&t.data&&t.data.hasOwnProperty("extProperty")&&(h.extProperty=t.data.extProperty),s.chunks.push(c),l+=1}return s},r.previous=0,r.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],r.ctorParameters=function(){return[{type:o.UploadService},{type:v},{type:t.Injector,decorators:[{type:t.Optional}]}]},r.ngInjectableDef=t.defineInjectable({factory:function(){return new r(t.inject(o.UploadService),t.inject(v),t.inject(t.INJECTOR,8))},token:r,providedIn:"root"}),r}(a.UploadServerService);var x=function(){function e(e){this.previewSer=e,this._extendServeConfig=null}return e.prototype.filePreviewEventHandler=function(e){var t=Object.assign(this.extendServerConfig||{});t.options=Object.assign(t.options||{},{showDownload:!!e.showDownload},{showComments:!!e.showComments},{modeless:!!e.modeless}),void 0===t.options.showHeader&&(t.options.showHeader=!0),void 0===t.options.showFileList&&(t.options.showFileList=!0),void 0===t.options.showComments&&(t.options.showComments=!1),void 0===t.options.modeless&&(t.options.modeless=!1);var r=e.name.substr(e.name.lastIndexOf(".")+1).toLowerCase();if(["doc","docx","xls","xlsx","ppt","pptx","jpg","jpeg","png","gif","bmp","pdf","txt","wps","wpt","et","dps"].includes(r))this.previewSer.previewFile(e,t);else{var i=this.previewSer.getLocalStr("previewAdapt.notSupport");this.previewSer.notifySer?this.previewSer.notifySer.warning(i):alert(i)}},e.prototype.fileDownloadEventHandler=function(e){e&&e.fileInfos.length>0&&(e.fileInfos.length>1?this.previewSer.multiDownloadFilesWidthName(e.fileInfos,e.name,this.extendServerConfig):this.previewSer.downloadFile(e.fileInfos[0],this.extendServerConfig))},Object.defineProperty(e.prototype,"extendServerConfig",{get:function(){return this._extendServeConfig},set:function(e){this._extendServeConfig=e,this.previewSer.setPreviwExtendServerConfig(e)},enumerable:!0,configurable:!0}),e.decorators=[{type:t.Directive,args:[{selector:"[fFilePreviewAdaptUnifile]",providers:[m]}]}],e.ctorParameters=function(){return[{type:m}]},e.propDecorators={filePreviewEventHandler:[{type:t.HostListener,args:["filePreviewEvent",["$event"]]}],fileDownloadEventHandler:[{type:t.HostListener,args:["fileDownloadEvent",["$event"]]}],extendServerConfig:[{type:t.Input}]},e}();var F=function(){function e(){}return e.forRoot=function(t){return{ngModule:e,providers:[{provide:g,useValue:t},v,m,i.FileViewerService]}},e.decorators=[{type:t.NgModule,args:[{declarations:[x,w,S,y],imports:[d.CommonModule,o.UploadDialogMoudle,i.FileListModule,a.FFileUploadModule.forRoot(null,I),n.FarrisCommonModule,p.LocaleModule.forRoot()],exports:[a.FFileUploadModule,x,w,S,y],providers:[v,m,i.FileViewerService]}]}],e}();e.FFileAdaptDownloadFileDirective=S,e.FFileAdaptPreviewFileDirective=y,e.FFilePreviewAdaptUnifileDirective=x,e.FFileUploadAdaptUnifileConfigService=v,e.FFileUploadAdaptUnifileConfigToken=g,e.FfilepreviewAdaptSeeimgComponent=w,e.FfilepreviewAdaptUnifileService=m,e.FfileuploadAdaptUnifileModule=F,e.FfileuploadAdaptUnifileService=I,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=farris-extend-fileupload-adapt-unifile.umd.min.js.map