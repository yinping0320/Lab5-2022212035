/**
 * @fileoverview added by tsickle
 * Generated from: lib/ffilepreview-adapt-unifile.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Injector, Optional } from '@angular/core';
import { NotifyService } from '@farris/ui-notify';
import { FileViewerService } from '@gsp-svc/file-viewer';
import { DownloadService } from '@gsp-svc/formdoc-upload';
import { FFileUploadAdaptUnifileConfigService } from './ffileupload-adapt-unifile.config';
import { WEBAPI_PREFIX_TOKEN } from '@farris/ui-common';
import * as i0 from "@angular/core";
import * as i1 from "@gsp-svc/file-viewer";
import * as i2 from "./ffileupload-adapt-unifile.config";
import * as i3 from "@gsp-svc/formdoc-upload";
var FfilepreviewAdaptUnifileService = /** @class */ (function () {
    function FfilepreviewAdaptUnifileService(fileviewSer, configSer, downloadSer, inject) {
        this.fileviewSer = fileviewSer;
        this.configSer = configSer;
        this.downloadSer = downloadSer;
        this.inject = inject;
        // 暂时用于简单合并
        this.previewExtendServerConfig = null;
        this.notifySer = null;
        this.perfixStr = '';
        this.extendData = this.configSer.getConfig();
        this.notifySer = this.fileviewSer['injector'].get(NotifyService, null);
        if (this.notifySer) {
            this.configSer.setLocalState(this.notifySer.localeService);
        }
        // 此处inject的时机和upload服务里的一样，此处不用再判断多语言
        if (this.inject) {
            if (WEBAPI_PREFIX_TOKEN) {
                this.perfixStr = this.inject.get(WEBAPI_PREFIX_TOKEN, '');
                this.configSer.setBasePath(this.perfixStr);
            }
        }
    }
    /**
     * 返回最终属性值
     * @param key
     * @param configValue
     * @param extendValue
     */
    /**
     * 返回最终属性值
     * @private
     * @param {?} key
     * @param {?} extendValue
     * @return {?}
     */
    FfilepreviewAdaptUnifileService.prototype.getFinallyConfig = /**
     * 返回最终属性值
     * @private
     * @param {?} key
     * @param {?} extendValue
     * @return {?}
     */
    function (key, extendValue) {
        if (extendValue && extendValue.hasOwnProperty(key)) {
            return extendValue[key];
        }
        // 避免下载等其他指令再传入扩展配置
        if (this.previewExtendServerConfig && this.previewExtendServerConfig.hasOwnProperty(key)) {
            return this.previewExtendServerConfig[key];
        }
        // 来自module中forRoot的配置
        if (this.extendData.hasOwnProperty(key)) {
            return this.extendData[key];
        }
        return null;
    };
    /**
     * 预览单个文件
     * @param info
     */
    /**
     * 预览单个文件
     * @param {?} info
     * @param {?} extendService
     * @return {?}
     */
    FfilepreviewAdaptUnifileService.prototype.previewFile = /**
     * 预览单个文件
     * @param {?} info
     * @param {?} extendService
     * @return {?}
     */
    function (info, extendService) {
        return this.previewFileList([info], extendService);
    };
    /**
     * 预览整个列表
     * @param infos
     */
    /**
     * 预览整个列表
     * @param {?} infos
     * @param {?} extendService
     * @return {?}
     */
    FfilepreviewAdaptUnifileService.prototype.previewFileList = /**
     * 预览整个列表
     * @param {?} infos
     * @param {?} extendService
     * @return {?}
     */
    function (infos, extendService) {
        //metadataIdList: string[]
        /** @type {?} */
        var rootId = this.getFinallyConfig('rootId', extendService);
        /** @type {?} */
        var metadataIdList = [];
        infos.forEach((/**
         * @param {?} item
         * @return {?}
         */
        function (item) {
            metadataIdList.push(item.extend['metadataId']);
        }));
        /** @type {?} */
        var options = this.getFinallyConfig('options', extendService);
        if (options) {
            return this.fileviewSer.viewerFileList(metadataIdList, rootId, options);
        }
        else {
            return this.fileviewSer.viewerFileList(metadataIdList, rootId);
        }
    };
    /**
     * 下载附件
     * @param info
     */
    /**
     * 下载附件
     * @param {?} info
     * @param {?} extendService
     * @return {?}
     */
    FfilepreviewAdaptUnifileService.prototype.downloadFile = /**
     * 下载附件
     * @param {?} info
     * @param {?} extendService
     * @return {?}
     */
    function (info, extendService) {
        if (!info.id) {
            /** @type {?} */
            var failMsg = this.getLocalStr('uploadAdapt.needFile');
            if (this.notifySer) {
                this.notifySer.warning(failMsg);
                return;
            }
            else {
                throw new Error(failMsg);
            }
        }
        window.open(this.getImgSrc(info, extendService));
    };
    /**
   * 下载附件
   * @param info
   */
    /**
     * 下载附件
     * @param {?} infos
     * @param {?} extendService
     * @return {?}
     */
    FfilepreviewAdaptUnifileService.prototype.multiDownloadFiles = /**
     * 下载附件
     * @param {?} infos
     * @param {?} extendService
     * @return {?}
     */
    function (infos, extendService) {
        //metadataIdList: string[]
        if (infos.length == 1) {
            this.downloadFile(infos[0], extendService);
        }
        else {
            /** @type {?} */
            var rootId = this.getFinallyConfig('rootId', extendService);
            /** @type {?} */
            var metadataIdList_1 = [];
            infos.forEach((/**
             * @param {?} item
             * @return {?}
             */
            function (item) {
                metadataIdList_1.push(item.extend['metadataId']);
            }));
            /** @type {?} */
            var url = this.downloadSer.getMultipleDownloadUrl(JSON.stringify(metadataIdList_1), rootId);
            window.open(url);
        }
    };
    /**
     * @param {?} infos
     * @param {?=} name
     * @param {?=} extendService
     * @return {?}
     */
    FfilepreviewAdaptUnifileService.prototype.multiDownloadFilesWidthName = /**
     * @param {?} infos
     * @param {?=} name
     * @param {?=} extendService
     * @return {?}
     */
    function (infos, name, extendService) {
        if (name === void 0) { name = ""; }
        //metadataIdList: string[]
        if (infos.length == 1) {
            this.downloadFile(infos[0], extendService);
        }
        else {
            /** @type {?} */
            var rootId = this.getFinallyConfig('rootId', extendService);
            /** @type {?} */
            var metadataIdList_2 = [];
            infos.forEach((/**
             * @param {?} item
             * @return {?}
             */
            function (item) {
                metadataIdList_2.push(item.extend['metadataId']);
            }));
            /** @type {?} */
            var url = this.downloadSer.getMultipleDownloadUrlWithName(JSON.stringify(metadataIdList_2), rootId, name);
            window.open(url);
        }
    };
    /**
     * 获取下载链接
    */
    /**
     * 获取下载链接
     * @param {?} info
     * @param {?} extendService
     * @return {?}
     */
    FfilepreviewAdaptUnifileService.prototype.getImgSrc = /**
     * 获取下载链接
     * @param {?} info
     * @param {?} extendService
     * @return {?}
     */
    function (info, extendService) {
        if (!info.id) {
            /** @type {?} */
            var failMsg = this.getLocalStr('uploadAdapt.needFile');
            if (this.notifySer) {
                this.notifySer.warning(failMsg);
                return;
            }
            else {
                throw new Error(failMsg);
            }
        }
        /** @type {?} */
        var url = '';
        /** @type {?} */
        var attachId = info.extend['metadataId'];
        /** @type {?} */
        var rootId = this.getFinallyConfig('rootId', extendService);
        // 文档服务服务单元名进行规范性调整，由document修改为dfs
        if (this.downloadSer) {
            if (rootId) {
                url = this.downloadSer.getDownloadUrl(attachId, rootId);
            }
        }
        else if (rootId) {
            console.warn(this.getLocalStr('uploadAdapt.recompile'));
            url = this.perfixStr + "/api/runtime/dfs/v1.0/formdoc/filecontent?metadataid=" + attachId + "&rootid=" + rootId;
        }
        return url;
    };
    /**
     * 根据预览指令的扩展配置获取
     * @param value
     */
    /**
     * 根据预览指令的扩展配置获取
     * @param {?} value
     * @return {?}
     */
    FfilepreviewAdaptUnifileService.prototype.setPreviwExtendServerConfig = /**
     * 根据预览指令的扩展配置获取
     * @param {?} value
     * @return {?}
     */
    function (value) {
        this.previewExtendServerConfig = value;
    };
    /**
     * @return {?}
     */
    FfilepreviewAdaptUnifileService.prototype.getPreviewExtendServerConfig = /**
     * @return {?}
     */
    function () {
        return this.previewExtendServerConfig;
    };
    /**
     * @param {?} lanKey
     * @return {?}
     */
    FfilepreviewAdaptUnifileService.prototype.getLocalStr = /**
     * @param {?} lanKey
     * @return {?}
     */
    function (lanKey) {
        return this.configSer.getLocalStr(lanKey);
    };
    FfilepreviewAdaptUnifileService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    FfilepreviewAdaptUnifileService.ctorParameters = function () { return [
        { type: FileViewerService },
        { type: FFileUploadAdaptUnifileConfigService },
        { type: DownloadService, decorators: [{ type: Optional }] },
        { type: Injector, decorators: [{ type: Optional }] }
    ]; };
    /** @nocollapse */ FfilepreviewAdaptUnifileService.ngInjectableDef = i0.defineInjectable({ factory: function FfilepreviewAdaptUnifileService_Factory() { return new FfilepreviewAdaptUnifileService(i0.inject(i1.FileViewerService), i0.inject(i2.FFileUploadAdaptUnifileConfigService), i0.inject(i3.DownloadService, 8), i0.inject(i0.INJECTOR, 8)); }, token: FfilepreviewAdaptUnifileService, providedIn: "root" });
    return FfilepreviewAdaptUnifileService;
}());
export { FfilepreviewAdaptUnifileService };
if (false) {
    /** @type {?} */
    FfilepreviewAdaptUnifileService.prototype.extendData;
    /**
     * @type {?}
     * @private
     */
    FfilepreviewAdaptUnifileService.prototype.previewExtendServerConfig;
    /** @type {?} */
    FfilepreviewAdaptUnifileService.prototype.notifySer;
    /**
     * @type {?}
     * @private
     */
    FfilepreviewAdaptUnifileService.prototype.perfixStr;
    /**
     * @type {?}
     * @private
     */
    FfilepreviewAdaptUnifileService.prototype.fileviewSer;
    /**
     * @type {?}
     * @private
     */
    FfilepreviewAdaptUnifileService.prototype.configSer;
    /**
     * @type {?}
     * @private
     */
    FfilepreviewAdaptUnifileService.prototype.downloadSer;
    /**
     * @type {?}
     * @private
     */
    FfilepreviewAdaptUnifileService.prototype.inject;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmZpbGVwcmV2aWV3LWFkYXB0LXVuaWZpbGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZXh0ZW5kLWZpbGV1cGxvYWQtYWRhcHQtdW5pZmlsZS8iLCJzb3VyY2VzIjpbImxpYi9mZmlsZXByZXZpZXctYWRhcHQtdW5pZmlsZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRS9ELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDMUQsT0FBTyxFQUFFLG9DQUFvQyxFQUFpQyxNQUFNLG9DQUFvQyxDQUFDO0FBQ3pILE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLG1CQUFtQixDQUFDOzs7OztBQUV4RDtJQVFJLHlDQUFvQixXQUE4QixFQUFVLFNBQStDLEVBQXNCLFdBQTRCLEVBQXFCLE1BQWU7UUFBN0ssZ0JBQVcsR0FBWCxXQUFXLENBQW1CO1FBQVUsY0FBUyxHQUFULFNBQVMsQ0FBc0M7UUFBc0IsZ0JBQVcsR0FBWCxXQUFXLENBQWlCO1FBQXFCLFdBQU0sR0FBTixNQUFNLENBQVM7O1FBSHpMLDhCQUF5QixHQUFrQyxJQUFJLENBQUM7UUFDeEUsY0FBUyxHQUFrQixJQUFJLENBQUM7UUFDeEIsY0FBUyxHQUFDLEVBQUUsQ0FBQztRQUVqQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDN0MsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDdkUsSUFBRyxJQUFJLENBQUMsU0FBUyxFQUFDO1lBQ2QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUM5RDtRQUNELHNDQUFzQztRQUN0QyxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUM7WUFDWixJQUFHLG1CQUFtQixFQUFDO2dCQUNuQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLG1CQUFtQixFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUMxRCxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDOUM7U0FDSDtJQUNOLENBQUM7SUFDRDs7Ozs7T0FLRzs7Ozs7Ozs7SUFDSywwREFBZ0I7Ozs7Ozs7SUFBeEIsVUFBeUIsR0FBRyxFQUFFLFdBQVc7UUFDckMsSUFBSSxXQUFXLElBQUksV0FBVyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNoRCxPQUFPLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUMzQjtRQUNELG1CQUFtQjtRQUNuQixJQUFJLElBQUksQ0FBQyx5QkFBeUIsSUFBSSxJQUFJLENBQUMseUJBQXlCLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3RGLE9BQU8sSUFBSSxDQUFDLHlCQUF5QixDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQzlDO1FBQ0Qsc0JBQXNCO1FBQ3RCLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDckMsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQy9CO1FBQ0UsT0FBTyxJQUFJLENBQUM7SUFFbkIsQ0FBQztJQUNEOzs7T0FHRzs7Ozs7OztJQUNILHFEQUFXOzs7Ozs7SUFBWCxVQUFZLElBQXVCLEVBQUUsYUFBNEM7UUFDN0UsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUNEOzs7T0FHRzs7Ozs7OztJQUNILHlEQUFlOzs7Ozs7SUFBZixVQUFnQixLQUEwQixFQUFFLGFBQTRDOzs7WUFFaEYsTUFBTSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsYUFBYSxDQUFDOztZQUN2RCxjQUFjLEdBQUcsRUFBRTtRQUN2QixLQUFLLENBQUMsT0FBTzs7OztRQUFDLFVBQUEsSUFBSTtZQUNkLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1FBQ25ELENBQUMsRUFBQyxDQUFDOztZQUNDLE9BQU8sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLGFBQWEsQ0FBQztRQUM3RCxJQUFHLE9BQU8sRUFBQztZQUNQLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsY0FBYyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztTQUMzRTthQUFJO1lBQ0QsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxjQUFjLEVBQUUsTUFBTSxDQUFDLENBQUM7U0FDbEU7SUFDTCxDQUFDO0lBQ0Q7OztPQUdHOzs7Ozs7O0lBQ0gsc0RBQVk7Ozs7OztJQUFaLFVBQWEsSUFBdUIsRUFBRSxhQUE0QztRQUM5RSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRTs7Z0JBQ04sT0FBTyxHQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsc0JBQXNCLENBQUM7WUFDcEQsSUFBRyxJQUFJLENBQUMsU0FBUyxFQUFDO2dCQUNkLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNoQyxPQUFPO2FBQ1Y7aUJBQUk7Z0JBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUM1QjtTQUNKO1FBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFDRDs7O0tBR0M7Ozs7Ozs7SUFDRCw0REFBa0I7Ozs7OztJQUFsQixVQUFtQixLQUEwQixFQUFFLGFBQTRDO1FBQ3ZGLDBCQUEwQjtRQUMxQixJQUFJLEtBQUssQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFO1lBQ25CLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1NBQzlDO2FBQU07O2dCQUNDLE1BQU0sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLGFBQWEsQ0FBQzs7Z0JBQ3ZELGdCQUFjLEdBQUcsRUFBRTtZQUN2QixLQUFLLENBQUMsT0FBTzs7OztZQUFDLFVBQUEsSUFBSTtnQkFDZCxnQkFBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7WUFDbkQsQ0FBQyxFQUFDLENBQUM7O2dCQUNDLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsZ0JBQWMsQ0FBQyxFQUFFLE1BQU0sQ0FBQztZQUN6RixNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3BCO0lBQ0wsQ0FBQzs7Ozs7OztJQUNELHFFQUEyQjs7Ozs7O0lBQTNCLFVBQTRCLEtBQTBCLEVBQUUsSUFBUyxFQUFFLGFBQTRDO1FBQXZELHFCQUFBLEVBQUEsU0FBUztRQUM3RCwwQkFBMEI7UUFDMUIsSUFBSSxLQUFLLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRTtZQUNuQixJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxhQUFhLENBQUMsQ0FBQztTQUM5QzthQUFNOztnQkFDQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxhQUFhLENBQUM7O2dCQUN2RCxnQkFBYyxHQUFHLEVBQUU7WUFDdkIsS0FBSyxDQUFDLE9BQU87Ozs7WUFBQyxVQUFBLElBQUk7Z0JBQ2QsZ0JBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1lBQ25ELENBQUMsRUFBQyxDQUFDOztnQkFDQyxHQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyw4QkFBOEIsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLGdCQUFjLENBQUMsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDO1lBQ3ZHLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDcEI7SUFDTCxDQUFDO0lBQ0Q7O01BRUU7Ozs7Ozs7SUFDRixtREFBUzs7Ozs7O0lBQVQsVUFBVSxJQUF1QixFQUFFLGFBQTRDO1FBQzNFLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFOztnQkFDTixPQUFPLEdBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxzQkFBc0IsQ0FBQztZQUNwRCxJQUFHLElBQUksQ0FBQyxTQUFTLEVBQUM7Z0JBQ2QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ2hDLE9BQU87YUFDVjtpQkFBSTtnQkFDRCxNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQzVCO1NBQ0o7O1lBQ0csR0FBRyxHQUFHLEVBQUU7O1lBQ1IsUUFBUSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDOztZQUNwQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxhQUFhLENBQUM7UUFDM0QsbUNBQW1DO1FBQ25DLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNsQixJQUFJLE1BQU0sRUFBRTtnQkFDUixHQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO2FBQzNEO1NBQ0o7YUFBTSxJQUFJLE1BQU0sRUFBRTtZQUNmLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLENBQUM7WUFDeEQsR0FBRyxHQUFNLElBQUksQ0FBQyxTQUFTLDZEQUF3RCxRQUFRLGdCQUFXLE1BQVEsQ0FBQztTQUM5RztRQUNELE9BQU8sR0FBRyxDQUFDO0lBQ2YsQ0FBQztJQUNEOzs7T0FHRzs7Ozs7O0lBQ0gscUVBQTJCOzs7OztJQUEzQixVQUE0QixLQUFLO1FBQzdCLElBQUksQ0FBQyx5QkFBeUIsR0FBRyxLQUFLLENBQUM7SUFDM0MsQ0FBQzs7OztJQUNELHNFQUE0Qjs7O0lBQTVCO1FBQ0ksT0FBTyxJQUFJLENBQUMseUJBQXlCLENBQUM7SUFDMUMsQ0FBQzs7Ozs7SUFDRCxxREFBVzs7OztJQUFYLFVBQVksTUFBYTtRQUNyQixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzlDLENBQUM7O2dCQTNKSixVQUFVLFNBQUM7b0JBQ1IsVUFBVSxFQUFFLE1BQU07aUJBQ3JCOzs7O2dCQVBRLGlCQUFpQjtnQkFFakIsb0NBQW9DO2dCQURwQyxlQUFlLHVCQVkwRixRQUFRO2dCQWhCckcsUUFBUSx1QkFnQnNJLFFBQVE7OzswQ0FoQjNLO0NBb0tDLEFBNUpELElBNEpDO1NBekpZLCtCQUErQjs7O0lBQ3hDLHFEQUFXOzs7OztJQUNYLG9FQUF3RTs7SUFDeEUsb0RBQWdDOzs7OztJQUNoQyxvREFBcUI7Ozs7O0lBQ1Qsc0RBQXNDOzs7OztJQUFFLG9EQUF1RDs7Ozs7SUFBRSxzREFBZ0Q7Ozs7O0lBQUMsaURBQW1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEZVcGxvYWRGaWxlRXh0ZW5kIH0gZnJvbSAnQGZhcnJpcy9leHRlbmQtZmlsZS11cGxvYWQnO1xyXG5pbXBvcnQgeyBOb3RpZnlTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1ub3RpZnknO1xyXG5pbXBvcnQgeyBGaWxlVmlld2VyU2VydmljZSB9IGZyb20gJ0Bnc3Atc3ZjL2ZpbGUtdmlld2VyJztcclxuaW1wb3J0IHsgRG93bmxvYWRTZXJ2aWNlIH0gZnJvbSAnQGdzcC1zdmMvZm9ybWRvYy11cGxvYWQnO1xyXG5pbXBvcnQgeyBGRmlsZVVwbG9hZEFkYXB0VW5pZmlsZUNvbmZpZ1NlcnZpY2UsIEZGaWxlVXBsb2FkQWRhcHRVbmlmaWxlQ29uZmlnIH0gZnJvbSAnLi9mZmlsZXVwbG9hZC1hZGFwdC11bmlmaWxlLmNvbmZpZyc7XHJcbmltcG9ydCB7IFdFQkFQSV9QUkVGSVhfVE9LRU4gfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbic7XHJcbmltcG9ydCB7IExvY2FsZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWxvY2FsZSc7XHJcbkBJbmplY3RhYmxlKHtcclxuICAgIHByb3ZpZGVkSW46ICdyb290J1xyXG59KVxyXG5leHBvcnQgY2xhc3MgRmZpbGVwcmV2aWV3QWRhcHRVbmlmaWxlU2VydmljZSB7XHJcbiAgICBleHRlbmREYXRhOy8vIOaaguaXtueUqOS6jueugOWNleWQiOW5tlxyXG4gICAgcHJpdmF0ZSBwcmV2aWV3RXh0ZW5kU2VydmVyQ29uZmlnOiBGRmlsZVVwbG9hZEFkYXB0VW5pZmlsZUNvbmZpZyA9IG51bGw7XHJcbiAgICBub3RpZnlTZXI6IE5vdGlmeVNlcnZpY2UgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBwZXJmaXhTdHI9Jyc7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGZpbGV2aWV3U2VyOiBGaWxlVmlld2VyU2VydmljZSwgcHJpdmF0ZSBjb25maWdTZXI6IEZGaWxlVXBsb2FkQWRhcHRVbmlmaWxlQ29uZmlnU2VydmljZSwgQE9wdGlvbmFsKCkgcHJpdmF0ZSBkb3dubG9hZFNlcjogRG93bmxvYWRTZXJ2aWNlLEBPcHRpb25hbCgpIHByaXZhdGUgaW5qZWN0OkluamVjdG9yKSB7XHJcbiAgICAgICAgdGhpcy5leHRlbmREYXRhID0gdGhpcy5jb25maWdTZXIuZ2V0Q29uZmlnKCk7XHJcbiAgICAgICAgdGhpcy5ub3RpZnlTZXIgPSB0aGlzLmZpbGV2aWV3U2VyWydpbmplY3RvciddLmdldChOb3RpZnlTZXJ2aWNlLCBudWxsKTtcclxuICAgICAgICBpZih0aGlzLm5vdGlmeVNlcil7XHJcbiAgICAgICAgICAgIHRoaXMuY29uZmlnU2VyLnNldExvY2FsU3RhdGUodGhpcy5ub3RpZnlTZXIubG9jYWxlU2VydmljZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOatpOWkhGluamVjdOeahOaXtuacuuWSjHVwbG9hZOacjeWKoemHjOeahOS4gOagt++8jOatpOWkhOS4jeeUqOWGjeWIpOaWreWkmuivreiogFxyXG4gICAgICAgIGlmKCB0aGlzLmluamVjdCl7XHJcbiAgICAgICAgICAgIGlmKFdFQkFQSV9QUkVGSVhfVE9LRU4pe1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wZXJmaXhTdHIgPSB0aGlzLmluamVjdC5nZXQoV0VCQVBJX1BSRUZJWF9UT0tFTiwgJycpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb25maWdTZXIuc2V0QmFzZVBhdGgodGhpcy5wZXJmaXhTdHIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgIH1cclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog6L+U5Zue5pyA57uI5bGe5oCn5YC8XHJcbiAgICAgKiBAcGFyYW0ga2V5IFxyXG4gICAgICogQHBhcmFtIGNvbmZpZ1ZhbHVlIFxyXG4gICAgICogQHBhcmFtIGV4dGVuZFZhbHVlIFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGdldEZpbmFsbHlDb25maWcoa2V5LCBleHRlbmRWYWx1ZSkge1xyXG4gICAgICAgIGlmIChleHRlbmRWYWx1ZSAmJiBleHRlbmRWYWx1ZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBleHRlbmRWYWx1ZVtrZXldO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDpgb/lhY3kuIvovb3nrYnlhbbku5bmjIfku6Tlho3kvKDlhaXmianlsZXphY3nva5cclxuICAgICAgICBpZiAodGhpcy5wcmV2aWV3RXh0ZW5kU2VydmVyQ29uZmlnICYmIHRoaXMucHJldmlld0V4dGVuZFNlcnZlckNvbmZpZy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnByZXZpZXdFeHRlbmRTZXJ2ZXJDb25maWdba2V5XTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5p2l6IeqbW9kdWxl5LitZm9yUm9vdOeahOmFjee9rlxyXG4gICAgICAgIGlmICh0aGlzLmV4dGVuZERhdGEuaGFzT3duUHJvcGVydHkoa2V5KSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5leHRlbmREYXRhW2tleV07XHJcbiAgICAgICAgfVxyXG4gICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIFxyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDpooTop4jljZXkuKrmlofku7ZcclxuICAgICAqIEBwYXJhbSBpbmZvIFxyXG4gICAgICovXHJcbiAgICBwcmV2aWV3RmlsZShpbmZvOiBGVXBsb2FkRmlsZUV4dGVuZCwgZXh0ZW5kU2VydmljZTogRkZpbGVVcGxvYWRBZGFwdFVuaWZpbGVDb25maWcpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wcmV2aWV3RmlsZUxpc3QoW2luZm9dLCBleHRlbmRTZXJ2aWNlKTtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog6aKE6KeI5pW05Liq5YiX6KGoXHJcbiAgICAgKiBAcGFyYW0gaW5mb3MgXHJcbiAgICAgKi9cclxuICAgIHByZXZpZXdGaWxlTGlzdChpbmZvczogRlVwbG9hZEZpbGVFeHRlbmRbXSwgZXh0ZW5kU2VydmljZTogRkZpbGVVcGxvYWRBZGFwdFVuaWZpbGVDb25maWcpIHtcclxuICAgICAgICAvL21ldGFkYXRhSWRMaXN0OiBzdHJpbmdbXVxyXG4gICAgICAgIGxldCByb290SWQgPSB0aGlzLmdldEZpbmFsbHlDb25maWcoJ3Jvb3RJZCcsIGV4dGVuZFNlcnZpY2UpO1xyXG4gICAgICAgIGxldCBtZXRhZGF0YUlkTGlzdCA9IFtdO1xyXG4gICAgICAgIGluZm9zLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICAgIG1ldGFkYXRhSWRMaXN0LnB1c2goaXRlbS5leHRlbmRbJ21ldGFkYXRhSWQnXSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbGV0IG9wdGlvbnMgPSB0aGlzLmdldEZpbmFsbHlDb25maWcoJ29wdGlvbnMnLCBleHRlbmRTZXJ2aWNlKTtcclxuICAgICAgICBpZihvcHRpb25zKXtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmlsZXZpZXdTZXIudmlld2VyRmlsZUxpc3QobWV0YWRhdGFJZExpc3QsIHJvb3RJZCwgb3B0aW9ucyk7XHJcbiAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmZpbGV2aWV3U2VyLnZpZXdlckZpbGVMaXN0KG1ldGFkYXRhSWRMaXN0LCByb290SWQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog5LiL6L296ZmE5Lu2XHJcbiAgICAgKiBAcGFyYW0gaW5mbyBcclxuICAgICAqL1xyXG4gICAgZG93bmxvYWRGaWxlKGluZm86IEZVcGxvYWRGaWxlRXh0ZW5kLCBleHRlbmRTZXJ2aWNlOiBGRmlsZVVwbG9hZEFkYXB0VW5pZmlsZUNvbmZpZykge1xyXG4gICAgICAgIGlmICghaW5mby5pZCkge1xyXG4gICAgICAgICAgICBsZXQgZmFpbE1zZz10aGlzLmdldExvY2FsU3RyKCd1cGxvYWRBZGFwdC5uZWVkRmlsZScpO1xyXG4gICAgICAgICAgICBpZih0aGlzLm5vdGlmeVNlcil7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeVNlci53YXJuaW5nKGZhaWxNc2cpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWlsTXNnKTtcclxuICAgICAgICAgICAgfSAgICAgICAgICAgIFxyXG4gICAgICAgIH1cclxuICAgICAgICB3aW5kb3cub3Blbih0aGlzLmdldEltZ1NyYyhpbmZvLCBleHRlbmRTZXJ2aWNlKSk7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgKiDkuIvovb3pmYTku7ZcclxuICAgKiBAcGFyYW0gaW5mbyBcclxuICAgKi9cclxuICAgIG11bHRpRG93bmxvYWRGaWxlcyhpbmZvczogRlVwbG9hZEZpbGVFeHRlbmRbXSwgZXh0ZW5kU2VydmljZTogRkZpbGVVcGxvYWRBZGFwdFVuaWZpbGVDb25maWcpIHtcclxuICAgICAgICAvL21ldGFkYXRhSWRMaXN0OiBzdHJpbmdbXVxyXG4gICAgICAgIGlmIChpbmZvcy5sZW5ndGggPT0gMSkge1xyXG4gICAgICAgICAgICB0aGlzLmRvd25sb2FkRmlsZShpbmZvc1swXSwgZXh0ZW5kU2VydmljZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbGV0IHJvb3RJZCA9IHRoaXMuZ2V0RmluYWxseUNvbmZpZygncm9vdElkJywgZXh0ZW5kU2VydmljZSk7XHJcbiAgICAgICAgICAgIGxldCBtZXRhZGF0YUlkTGlzdCA9IFtdO1xyXG4gICAgICAgICAgICBpbmZvcy5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICAgICAgbWV0YWRhdGFJZExpc3QucHVzaChpdGVtLmV4dGVuZFsnbWV0YWRhdGFJZCddKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGxldCB1cmwgPSB0aGlzLmRvd25sb2FkU2VyLmdldE11bHRpcGxlRG93bmxvYWRVcmwoSlNPTi5zdHJpbmdpZnkobWV0YWRhdGFJZExpc3QpLCByb290SWQpO1xyXG4gICAgICAgICAgICB3aW5kb3cub3Blbih1cmwpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIG11bHRpRG93bmxvYWRGaWxlc1dpZHRoTmFtZShpbmZvczogRlVwbG9hZEZpbGVFeHRlbmRbXSwgbmFtZSA9IFwiXCIsIGV4dGVuZFNlcnZpY2U6IEZGaWxlVXBsb2FkQWRhcHRVbmlmaWxlQ29uZmlnKSB7XHJcbiAgICAgICAgLy9tZXRhZGF0YUlkTGlzdDogc3RyaW5nW11cclxuICAgICAgICBpZiAoaW5mb3MubGVuZ3RoID09IDEpIHtcclxuICAgICAgICAgICAgdGhpcy5kb3dubG9hZEZpbGUoaW5mb3NbMF0sIGV4dGVuZFNlcnZpY2UpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxldCByb290SWQgPSB0aGlzLmdldEZpbmFsbHlDb25maWcoJ3Jvb3RJZCcsIGV4dGVuZFNlcnZpY2UpO1xyXG4gICAgICAgICAgICBsZXQgbWV0YWRhdGFJZExpc3QgPSBbXTtcclxuICAgICAgICAgICAgaW5mb3MuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICAgICAgICAgIG1ldGFkYXRhSWRMaXN0LnB1c2goaXRlbS5leHRlbmRbJ21ldGFkYXRhSWQnXSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBsZXQgdXJsID0gdGhpcy5kb3dubG9hZFNlci5nZXRNdWx0aXBsZURvd25sb2FkVXJsV2l0aE5hbWUoSlNPTi5zdHJpbmdpZnkobWV0YWRhdGFJZExpc3QpLCByb290SWQsIG5hbWUpO1xyXG4gICAgICAgICAgICB3aW5kb3cub3Blbih1cmwpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog6I635Y+W5LiL6L296ZO+5o6lXHJcbiAgICAqL1xyXG4gICAgZ2V0SW1nU3JjKGluZm86IEZVcGxvYWRGaWxlRXh0ZW5kLCBleHRlbmRTZXJ2aWNlOiBGRmlsZVVwbG9hZEFkYXB0VW5pZmlsZUNvbmZpZykge1xyXG4gICAgICAgIGlmICghaW5mby5pZCkgeyAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBsZXQgZmFpbE1zZz10aGlzLmdldExvY2FsU3RyKCd1cGxvYWRBZGFwdC5uZWVkRmlsZScpO1xyXG4gICAgICAgICAgICBpZih0aGlzLm5vdGlmeVNlcil7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeVNlci53YXJuaW5nKGZhaWxNc2cpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWlsTXNnKTtcclxuICAgICAgICAgICAgfSAgIFxyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgdXJsID0gJyc7XHJcbiAgICAgICAgbGV0IGF0dGFjaElkID0gaW5mby5leHRlbmRbJ21ldGFkYXRhSWQnXTtcclxuICAgICAgICBsZXQgcm9vdElkID0gdGhpcy5nZXRGaW5hbGx5Q29uZmlnKCdyb290SWQnLCBleHRlbmRTZXJ2aWNlKTtcclxuICAgICAgICAvLyDmlofmoaPmnI3liqHmnI3liqHljZXlhYPlkI3ov5vooYzop4TojIPmgKfosIPmlbTvvIznlLFkb2N1bWVudOS/ruaUueS4umRmc1xyXG4gICAgICAgIGlmICh0aGlzLmRvd25sb2FkU2VyKSB7XHJcbiAgICAgICAgICAgIGlmIChyb290SWQpIHtcclxuICAgICAgICAgICAgICAgIHVybCA9IHRoaXMuZG93bmxvYWRTZXIuZ2V0RG93bmxvYWRVcmwoYXR0YWNoSWQsIHJvb3RJZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2UgaWYgKHJvb3RJZCkge1xyXG4gICAgICAgICAgICBjb25zb2xlLndhcm4odGhpcy5nZXRMb2NhbFN0cigndXBsb2FkQWRhcHQucmVjb21waWxlJykpO1xyXG4gICAgICAgICAgICB1cmwgPSBgJHt0aGlzLnBlcmZpeFN0cn0vYXBpL3J1bnRpbWUvZGZzL3YxLjAvZm9ybWRvYy9maWxlY29udGVudD9tZXRhZGF0YWlkPSR7YXR0YWNoSWR9JnJvb3RpZD0ke3Jvb3RJZH1gO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdXJsO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDmoLnmja7pooTop4jmjIfku6TnmoTmianlsZXphY3nva7ojrflj5ZcclxuICAgICAqIEBwYXJhbSB2YWx1ZSBcclxuICAgICAqL1xyXG4gICAgc2V0UHJldml3RXh0ZW5kU2VydmVyQ29uZmlnKHZhbHVlKSB7XHJcbiAgICAgICAgdGhpcy5wcmV2aWV3RXh0ZW5kU2VydmVyQ29uZmlnID0gdmFsdWU7XHJcbiAgICB9XHJcbiAgICBnZXRQcmV2aWV3RXh0ZW5kU2VydmVyQ29uZmlnKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnByZXZpZXdFeHRlbmRTZXJ2ZXJDb25maWc7XHJcbiAgICB9XHJcbiAgICBnZXRMb2NhbFN0cihsYW5LZXk6c3RyaW5nKXtcclxuICAgICAgICByZXR1cm4gdGhpcy5jb25maWdTZXIuZ2V0TG9jYWxTdHIobGFuS2V5KTtcclxuICAgIH1cclxufSJdfQ==