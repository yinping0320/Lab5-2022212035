/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*
 * @Author: 疯狂秀才(Lucas Huang)
 * @Date: 2019-09-02 17:55:57
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-10-23 16:57:28
 * @QQ: 1055818239
 * @Version: v0.0.1
 */
import { addDays, differenceInMinutes, format, isValid, parseISO, subDays } from "date-fns";
import { Injectable } from "@angular/core";
import { MyDateConverter } from "./myDateConverter";
import { format as timeagoFmt } from './timeago/timeago';
import * as i0 from "@angular/core";
var DateTimeHelperService = /** @class */ (function () {
    function DateTimeHelperService() {
        this.$D = null;
        this.$D = new MyDateConverter();
    }
    /**
     * @param {?} date
     * @param {?=} locale
     * @return {?}
     */
    DateTimeHelperService.prototype.relativeTime = /**
     * @param {?} date
     * @param {?=} locale
     * @return {?}
     */
    function (date, locale) {
        if (locale === void 0) { locale = 'zh-CHS'; }
        if (date) {
            return timeagoFmt(date, locale);
        }
        return '';
    };
    /**
     * @param {?} date
     * @param {?} days
     * @return {?}
     */
    DateTimeHelperService.prototype.addDays = /**
     * @param {?} date
     * @param {?} days
     * @return {?}
     */
    function (date, days) {
        return addDays(date, days);
    };
    /**
     * @param {?} date
     * @param {?} days
     * @return {?}
     */
    DateTimeHelperService.prototype.subDays = /**
     * @param {?} date
     * @param {?} days
     * @return {?}
     */
    function (date, days) {
        return subDays(date, days);
    };
    /**
     * @param {?} dateLeft
     * @param {?} dateRight
     * @return {?}
     */
    DateTimeHelperService.prototype.differenceInMinutes = /**
     * @param {?} dateLeft
     * @param {?} dateRight
     * @return {?}
     */
    function (dateLeft, dateRight) {
        return differenceInMinutes(dateLeft, dateRight);
    };
    /**
     * @param value 要转换格式的日期
     * @param fmt 格式化字符串
     *
     * 更多的格式化请参考
     * [点我点我](https://date-fns.org/v1.30.1/docs/format)
     */
    /**
     * @param {?} value 要转换格式的日期
     * @param {?=} fmt 格式化字符串
     *
     * 更多的格式化请参考
     * [点我点我](https://date-fns.org/v1.30.1/docs/format)
     * @return {?}
     */
    DateTimeHelperService.prototype.formatTo = /**
     * @param {?} value 要转换格式的日期
     * @param {?=} fmt 格式化字符串
     *
     * 更多的格式化请参考
     * [点我点我](https://date-fns.org/v1.30.1/docs/format)
     * @return {?}
     */
    function (value, fmt) {
        if (fmt === void 0) { fmt = "yyyy-MM-dd"; }
        if (!value) {
            return "";
        }
        if (typeof value === "string" && value.indexOf("0001") === 0) {
            return "";
        }
        if (value instanceof Date) {
            return format(value, fmt);
        }
        /** @type {?} */
        var _d = parseISO(value);
        if (_d == "Invalid Date") {
            _d = this.createDate(value) || new Date(value);
        }
        // const d = parseISO(value);
        if (isValid(_d)) {
            /** @type {?} */
            var d = parseISO(format(_d, "yyyy-MM-dd HH:mm:ss"));
            return format(d, fmt);
        }
        else {
            // console.error(`${value} 转换为Date时失败。`);
            if (fmt.indexOf("HH") === 0 || fmt.indexOf("hh") === 0) {
                // 仅有时间部分
                // 提取时间
                /** @type {?} */
                var _time = value
                    .match(/\d*/g)
                    .filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return n !== ""; }))
                    .join(":");
                if (fmt === "HH" || fmt === "hh") {
                    fmt = fmt += ":mm";
                }
                // const fullDateTime = new Date('2022-11-25 ' + _time);
                /** @type {?} */
                var fullDateTime = parseISO("2022-11-25 " + _time);
                return format(fullDateTime, fmt);
            }
            return "";
        }
    };
    /**
     * @private
     * @param {?} val
     * @return {?}
     */
    DateTimeHelperService.prototype.createDate = /**
     * @private
     * @param {?} val
     * @return {?}
     */
    function (val) {
        return this.$D.create(val);
    };
    // 根据参数日期获取具体日期信息
    // 根据参数日期获取具体日期信息
    /**
     * @private
     * @param {?=} date
     * @param {?=} firstDayOfWeek
     * @return {?}
     */
    DateTimeHelperService.prototype.formatDate = 
    // 根据参数日期获取具体日期信息
    /**
     * @private
     * @param {?=} date
     * @param {?=} firstDayOfWeek
     * @return {?}
     */
    function (date, firstDayOfWeek) {
        if (date === void 0) { date = new Date(); }
        if (firstDayOfWeek === void 0) { firstDayOfWeek = '一'; }
        /** @type {?} */
        var year = date.getFullYear();
        /** @type {?} */
        var month = date.getMonth() + 1;
        /** @type {?} */
        var day = date.getDate();
        /** @type {?} */
        var weekDay = date.getDay();
        if (firstDayOfWeek === '一') {
            if (!weekDay) {
                weekDay = 6;
            }
            else {
                weekDay = weekDay - 1;
            }
        }
        /** @type {?} */
        var week = ["一", "二", "三", "四", "五", "六", "日"][weekDay];
        /** @type {?} */
        var dateInfo = {
            date: new Date(date),
            dateStr: year + "-" + month.toString().padStart(2, "0") + "-" + day
                .toString()
                .padStart(2, "0"),
            year: year,
            month: month,
            day: day,
            week: week,
            isToday: false,
        };
        /** @type {?} */
        var today = new Date();
        // 判断是否为当天
        if (today.getFullYear() === year &&
            today.getMonth() + 1 === month &&
            today.getDate() === day) {
            dateInfo["isToday"] = true;
        }
        return dateInfo;
    };
    // 根据基准日期，获取长度为dayLenth的日期数组
    // 根据基准日期，获取长度为dayLenth的日期数组
    /**
     * @private
     * @param {?=} date
     * @param {?=} step
     * @param {?=} firstDayOfWeek
     * @return {?}
     */
    DateTimeHelperService.prototype.setDate = 
    // 根据基准日期，获取长度为dayLenth的日期数组
    /**
     * @private
     * @param {?=} date
     * @param {?=} step
     * @param {?=} firstDayOfWeek
     * @return {?}
     */
    function (date, step, firstDayOfWeek) {
        if (date === void 0) { date = new Date(); }
        if (step === void 0) { step = 7; }
        if (firstDayOfWeek === void 0) { firstDayOfWeek = '一'; }
        /** @type {?} */
        var weekData = [];
        /** @type {?} */
        var week = date.getDay() - 1;
        /** @type {?} */
        var _rangeDays = week * -1;
        if (firstDayOfWeek === '日') {
            _rangeDays = _rangeDays - 1;
        }
        date = this.getDateByDate(date, _rangeDays); // 以周日为第1天时 -1
        for (var i = 0; i < step; i++) {
            weekData.push(this.formatDate(i == 0 ? date : this.getDateByDate(date, 1), firstDayOfWeek));
        }
        return weekData;
    };
    // 根据基准日期获取前后某天的日期对象
    // 根据基准日期获取前后某天的日期对象
    /**
     * @private
     * @param {?=} date
     * @param {?=} range
     * @return {?}
     */
    DateTimeHelperService.prototype.getDateByDate = 
    // 根据基准日期获取前后某天的日期对象
    /**
     * @private
     * @param {?=} date
     * @param {?=} range
     * @return {?}
     */
    function (date, range) {
        if (date === void 0) { date = new Date(); }
        if (range === void 0) { range = 0; }
        date.setDate(date.getDate() + range);
        return date;
    };
    /*
    获取以baselineDate所在周的一周、前一周、下一周的日期和星期信息(切换周期也可通过参数dayLenth自行设置)
    baselineDate: 设置的基准日期(返回的日期列表的第一个日期)
    range: 以 baselineDate 为基准日期的前后天数范围(如基准日期的range为0，需要返回前7天日期，则range为-7，后7天则range为7)
    step: 需要获取的日期信息周期天数，默认获取baselineDate所在周的一周日期信息
    firstDayOfWeek: 每周第一天 是 周一，还是周日，默认为 周一
   */
    /*
        获取以baselineDate所在周的一周、前一周、下一周的日期和星期信息(切换周期也可通过参数dayLenth自行设置)
        baselineDate: 设置的基准日期(返回的日期列表的第一个日期)
        range: 以 baselineDate 为基准日期的前后天数范围(如基准日期的range为0，需要返回前7天日期，则range为-7，后7天则range为7)
        step: 需要获取的日期信息周期天数，默认获取baselineDate所在周的一周日期信息
        firstDayOfWeek: 每周第一天 是 周一，还是周日，默认为 周一
       */
    /**
     * @param {?} __0
     * @param {?=} firstDayOfWeek
     * @return {?}
     */
    DateTimeHelperService.prototype.getWeekDate = /*
        获取以baselineDate所在周的一周、前一周、下一周的日期和星期信息(切换周期也可通过参数dayLenth自行设置)
        baselineDate: 设置的基准日期(返回的日期列表的第一个日期)
        range: 以 baselineDate 为基准日期的前后天数范围(如基准日期的range为0，需要返回前7天日期，则range为-7，后7天则range为7)
        step: 需要获取的日期信息周期天数，默认获取baselineDate所在周的一周日期信息
        firstDayOfWeek: 每周第一天 是 周一，还是周日，默认为 周一
       */
    /**
     * @param {?} __0
     * @param {?=} firstDayOfWeek
     * @return {?}
     */
    function (_a, firstDayOfWeek) {
        var _b = _a.baselineDate, baselineDate = _b === void 0 ? new Date() : _b, _c = _a.range, range = _c === void 0 ? 0 : _c, _e = _a.step, step = _e === void 0 ? 7 : _e;
        if (firstDayOfWeek === void 0) { firstDayOfWeek = '一'; }
        return this.setDate(this.getDateByDate(baselineDate, range), step, firstDayOfWeek);
    };
    /** 根据当前日期，获取当前是所在年的第几周 */
    /**
     * 根据当前日期，获取当前是所在年的第几周
     * @param {?} year
     * @param {?} month
     * @param {?} day
     * @return {?}
     */
    DateTimeHelperService.prototype.getYearWeek = /**
     * 根据当前日期，获取当前是所在年的第几周
     * @param {?} year
     * @param {?} month
     * @param {?} day
     * @return {?}
     */
    function (year, month, day) {
        //a为年 b为月 c为日
        /*
                date1是当前日期
                date2是当年第一天
                d是当前日期是今年第多少天
                用d + 当前年的第一天的周差距的和在除以7就是本年第几周
                */
        /** @type {?} */
        var date1 = new Date(year, parseInt(month) - 1, day);
        /** @type {?} */
        var date2 = new Date(year, 0, 1);
        /** @type {?} */
        var d = Math.round((date1.valueOf() - date2.valueOf()) / 86400000);
        return Math.ceil((d + ((date2.getDay() + 1) - 1)) / 7);
    };
    /**
     * @param {?} year
     * @param {?} month
     * @param {?} day
     * @return {?}
     */
    DateTimeHelperService.prototype.getMonthWeek = /**
     * @param {?} year
     * @param {?} month
     * @param {?} day
     * @return {?}
     */
    function (year, month, day) {
        /**
         * a = d = 当前日期
         * b = 6 - w = 当前周的还有几天过完(不算今天)
         * a + b 的和在除以7 就是当天是当前月份的第几周
         * @type {?}
         */
        var date = new Date(year, parseInt(month) - 1, day);
        /** @type {?} */
        var w = date.getDay();
        /** @type {?} */
        var d = date.getDate();
        if (w == 0) {
            w = 7;
        }
        /** @type {?} */
        var config = {
            getMonth: date.getMonth() + 1,
            getYear: date.getFullYear(),
            getWeek: Math.ceil((d + 6 - w) / 7),
        };
        return config;
    };
    /**
     * @param {?} date
     * @param {?} firstDayOfWeek
     * @return {?}
     */
    DateTimeHelperService.prototype.getNowWeekTime = /**
     * @param {?} date
     * @param {?} firstDayOfWeek
     * @return {?}
     */
    function (date, firstDayOfWeek) {
        date.setDate(date.getDate() - ((date.getDay() + 6) % 7));
        /** @type {?} */
        var begin = {
            year: date.getFullYear(),
            month: date.getMonth() + 1,
            day: date.getDate()
        };
        date.setDate(date.getDate() + 6);
        /** @type {?} */
        var end = {
            year: date.getFullYear(),
            month: date.getMonth() + 1,
            day: date.getDate()
        };
        if (firstDayOfWeek === '一') {
            return { begin: begin, end: end };
        }
        else {
            if (date.getDay() != 0) {
                date.setDate(date.getDate() - date.getDay());
            }
            /** @type {?} */
            var _begin = {
                year: date.getFullYear(),
                month: date.getMonth() + 1,
                day: date.getDate()
            };
            date.setDate(date.getDate() + 6 - date.getDay());
            /** @type {?} */
            var _end = {
                year: date.getFullYear(),
                month: date.getMonth() + 1,
                day: date.getDate()
            };
            return {
                begin: _begin,
                end: _end
            };
        }
    };
    DateTimeHelperService.decorators = [
        { type: Injectable, args: [{
                    providedIn: "root",
                },] }
    ];
    /** @nocollapse */
    DateTimeHelperService.ctorParameters = function () { return []; };
    /** @nocollapse */ DateTimeHelperService.ngInjectableDef = i0.defineInjectable({ factory: function DateTimeHelperService_Factory() { return new DateTimeHelperService(); }, token: DateTimeHelperService, providedIn: "root" });
    return DateTimeHelperService;
}());
export { DateTimeHelperService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    DateTimeHelperService.prototype.$D;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS1oZWxwZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktY29tbW9uL2RhdGUvIiwic291cmNlcyI6WyJsaWIvZGF0ZS1oZWxwZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFRQSxPQUFPLEVBQUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUM1RixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUVwRCxPQUFPLEVBQUUsTUFBTSxJQUFJLFVBQVUsRUFBUyxNQUFNLG1CQUFtQixDQUFDOztBQUtoRTtJQU1JO1FBRlEsT0FBRSxHQUFHLElBQUksQ0FBQztRQUdkLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxlQUFlLEVBQUUsQ0FBQztJQUNwQyxDQUFDOzs7Ozs7SUFFRCw0Q0FBWTs7Ozs7SUFBWixVQUFhLElBQVcsRUFBRSxNQUF5QztRQUF6Qyx1QkFBQSxFQUFBLGlCQUF5QztRQUMvRCxJQUFJLElBQUksRUFBRTtZQUNOLE9BQU8sVUFBVSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztTQUNuQztRQUNELE9BQU8sRUFBRSxDQUFDO0lBQ2QsQ0FBQzs7Ozs7O0lBRUQsdUNBQU87Ozs7O0lBQVAsVUFBUSxJQUFVLEVBQUUsSUFBWTtRQUM1QixPQUFPLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDL0IsQ0FBQzs7Ozs7O0lBRUQsdUNBQU87Ozs7O0lBQVAsVUFBUSxJQUFVLEVBQUUsSUFBWTtRQUM1QixPQUFPLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDL0IsQ0FBQzs7Ozs7O0lBRUQsbURBQW1COzs7OztJQUFuQixVQUFvQixRQUF1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QUU7YUFDdEI7WUFFRCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7O2dCQUMzQyxJQUFJLEdBQUc7Z0JBQ1QsSUFBSSxFQUFFLElBQUksQ0FBQyxXQUFXLEVBQUU7Z0JBQ3hCLEtBQUssRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQztnQkFDMUIsR0FBRyxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUU7YUFDdEI7WUFFRCxPQUFPO2dCQUNILEtBQUssRUFBRSxNQUFNO2dCQUNiLEdBQUcsRUFBRSxJQUFJO2FBQ1osQ0FBQTtTQUNKO0lBQ0wsQ0FBQzs7Z0JBN09KLFVBQVUsU0FBQztvQkFDUixVQUFVLEVBQUUsTUFBTTtpQkFDckI7Ozs7O2dDQW5CRDtDQStQQyxBQTlPRCxJQThPQztTQTNPWSxxQkFBcUI7Ozs7OztJQUM5QixtQ0FBa0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiDnlq/ni4Lnp4DmiY0oTHVjYXMgSHVhbmcpXHJcbiAqIEBEYXRlOiAyMDE5LTA5LTAyIDE3OjU1OjU3XHJcbiAqIEBMYXN0RWRpdG9yczog55av54uC56eA5omNKEx1Y2FzIEh1YW5nKVxyXG4gKiBATGFzdEVkaXRUaW1lOiAyMDE5LTEwLTIzIDE2OjU3OjI4XHJcbiAqIEBRUTogMTA1NTgxODIzOVxyXG4gKiBAVmVyc2lvbjogdjAuMC4xXHJcbiAqL1xyXG5pbXBvcnQgeyBhZGREYXlzLCBkaWZmZXJlbmNlSW5NaW51dGVzLCBmb3JtYXQsIGlzVmFsaWQsIHBhcnNlSVNPLCBzdWJEYXlzIH0gZnJvbSBcImRhdGUtZm5zXCI7XHJcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBNeURhdGVDb252ZXJ0ZXIgfSBmcm9tIFwiLi9teURhdGVDb252ZXJ0ZXJcIjtcclxuXHJcbmltcG9ydCB7IGZvcm1hdCBhcyB0aW1lYWdvRm10LCBURGF0ZSB9IGZyb20gJy4vdGltZWFnby90aW1lYWdvJztcclxuXHJcblxyXG5leHBvcnQgdHlwZSBGaXJzdERheU9mV2VlayA9ICfkuIAnIHwgJ+aXpSc7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiBcInJvb3RcIixcclxufSlcclxuZXhwb3J0IGNsYXNzIERhdGVUaW1lSGVscGVyU2VydmljZSB7XHJcbiAgICBwcml2YXRlICREID0gbnVsbDtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLiREID0gbmV3IE15RGF0ZUNvbnZlcnRlcigpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlbGF0aXZlVGltZShkYXRlOiBURGF0ZSwgbG9jYWxlOiAnZW4nfCd6aC1DSFMnfCd6aC1DSFQnID0gJ3poLUNIUycpIHtcclxuICAgICAgICBpZiAoZGF0ZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGltZWFnb0ZtdChkYXRlLCBsb2NhbGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkRGF5cyhkYXRlOiBEYXRlLCBkYXlzOiBudW1iZXIpIHtcclxuICAgICAgICByZXR1cm4gYWRkRGF5cyhkYXRlLCBkYXlzKTtcclxuICAgIH1cclxuXHJcbiAgICBzdWJEYXlzKGRhdGU6IERhdGUsIGRheXM6IG51bWJlcikge1xyXG4gICAgICAgIHJldHVybiBzdWJEYXlzKGRhdGUsIGRheXMpO1xyXG4gICAgfVxyXG5cclxuICAgIGRpZmZlcmVuY2VJbk1pbnV0ZXMoZGF0ZUxlZnQ6IERhdGUgfCBudW1iZXIsIGRhdGVSaWdodDogRGF0ZSB8IG51bWJlcikge1xyXG4gICAgICAgIHJldHVybiBkaWZmZXJlbmNlSW5NaW51dGVzKGRhdGVMZWZ0LCBkYXRlUmlnaHQpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQHBhcmFtIHZhbHVlIOimgei9rOaNouagvOW8j+eahOaXpeacn1xyXG4gICAgICogQHBhcmFtIGZtdCDmoLzlvI/ljJblrZfnrKbkuLJcclxuICAgICAqXHJcbiAgICAgKiDmm7TlpJrnmoTmoLzlvI/ljJbor7flj4LogINcclxuICAgICAqIFvngrnmiJHngrnmiJFdKGh0dHBzOi8vZGF0ZS1mbnMub3JnL3YxLjMwLjEvZG9jcy9mb3JtYXQpXHJcbiAgICAgKi9cclxuICAgIGZvcm1hdFRvKHZhbHVlOiBhbnksIGZtdDogc3RyaW5nID0gXCJ5eXl5LU1NLWRkXCIpIHtcclxuICAgICAgICBpZiAoIXZhbHVlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBcIlwiO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJzdHJpbmdcIiAmJiB2YWx1ZS5pbmRleE9mKFwiMDAwMVwiKSA9PT0gMCkge1xyXG4gICAgICAgICAgICByZXR1cm4gXCJcIjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERhdGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZvcm1hdCh2YWx1ZSwgZm10KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBfZDogYW55ID0gcGFyc2VJU08odmFsdWUpO1xyXG5cclxuICAgICAgICBpZiAoX2QgPT0gXCJJbnZhbGlkIERhdGVcIikge1xyXG4gICAgICAgICAgICBfZCA9IHRoaXMuY3JlYXRlRGF0ZSh2YWx1ZSkgfHwgbmV3IERhdGUodmFsdWUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gY29uc3QgZCA9IHBhcnNlSVNPKHZhbHVlKTtcclxuICAgICAgICBpZiAoaXNWYWxpZChfZCkpIHtcclxuICAgICAgICAgICAgY29uc3QgZCA9IHBhcnNlSVNPKGZvcm1hdChfZCwgXCJ5eXl5LU1NLWRkIEhIOm1tOnNzXCIpKTtcclxuICAgICAgICAgICAgcmV0dXJuIGZvcm1hdChkLCBmbXQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIGNvbnNvbGUuZXJyb3IoYCR7dmFsdWV9IOi9rOaNouS4ukRhdGXml7blpLHotKXjgIJgKTtcclxuICAgICAgICAgICAgaWYgKGZtdC5pbmRleE9mKFwiSEhcIikgPT09IDAgfHwgZm10LmluZGV4T2YoXCJoaFwiKSA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgLy8g5LuF5pyJ5pe26Ze06YOo5YiGXHJcbiAgICAgICAgICAgICAgICAvLyDmj5Dlj5bml7bpl7RcclxuICAgICAgICAgICAgICAgIGNvbnN0IF90aW1lID0gdmFsdWVcclxuICAgICAgICAgICAgICAgICAgICAubWF0Y2goL1xcZCovZylcclxuICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKChuKSA9PiBuICE9PSBcIlwiKVxyXG4gICAgICAgICAgICAgICAgICAgIC5qb2luKFwiOlwiKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoZm10ID09PSBcIkhIXCIgfHwgZm10ID09PSBcImhoXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICBmbXQgPSBmbXQgKz0gXCI6bW1cIjtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAvLyBjb25zdCBmdWxsRGF0ZVRpbWUgPSBuZXcgRGF0ZSgnMjAyMi0xMS0yNSAnICsgX3RpbWUpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZnVsbERhdGVUaW1lID0gcGFyc2VJU08oXCIyMDIyLTExLTI1IFwiICsgX3RpbWUpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZvcm1hdChmdWxsRGF0ZVRpbWUsIGZtdCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIFwiXCI7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY3JlYXRlRGF0ZSh2YWwpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy4kRC5jcmVhdGUodmFsKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDmoLnmja7lj4LmlbDml6XmnJ/ojrflj5blhbfkvZPml6XmnJ/kv6Hmga9cclxuICAgIHByaXZhdGUgZm9ybWF0RGF0ZShkYXRlID0gbmV3IERhdGUoKSwgZmlyc3REYXlPZldlZWs6IEZpcnN0RGF5T2ZXZWVrID0gJ+S4gCcpIHtcclxuICAgICAgICBsZXQgeWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKTtcclxuICAgICAgICBsZXQgbW9udGggPSBkYXRlLmdldE1vbnRoKCkgKyAxO1xyXG4gICAgICAgIGxldCBkYXkgPSBkYXRlLmdldERhdGUoKTtcclxuXHJcbiAgICAgICAgbGV0IHdlZWtEYXkgPSBkYXRlLmdldERheSgpO1xyXG4gICAgICAgIGlmIChmaXJzdERheU9mV2VlayA9PT0gJ+S4gCcpIHtcclxuICAgICAgICAgICAgaWYgKCF3ZWVrRGF5KSB7XHJcbiAgICAgICAgICAgICAgICB3ZWVrRGF5ID0gNjtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHdlZWtEYXkgPSB3ZWVrRGF5IC0gMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHdlZWsgPSBbXCLkuIBcIiwgXCLkuoxcIiwgXCLkuIlcIiwgXCLlm5tcIiwgXCLkupRcIiwgXCLlha1cIiwgXCLml6VcIl1bd2Vla0RheV07XHJcblxyXG4gICAgICAgIGNvbnN0IGRhdGVJbmZvID0ge1xyXG4gICAgICAgICAgICBkYXRlOiBuZXcgRGF0ZShkYXRlKSxcclxuICAgICAgICAgICAgZGF0ZVN0cjogYCR7eWVhcn0tJHttb250aC50b1N0cmluZygpLnBhZFN0YXJ0KDIsIFwiMFwiKX0tJHtkYXlcclxuICAgICAgICAgICAgICAgIC50b1N0cmluZygpXHJcbiAgICAgICAgICAgICAgICAucGFkU3RhcnQoMiwgXCIwXCIpfWAsXHJcbiAgICAgICAgICAgIHllYXIsXHJcbiAgICAgICAgICAgIG1vbnRoLFxyXG4gICAgICAgICAgICBkYXksXHJcbiAgICAgICAgICAgIHdlZWssXHJcbiAgICAgICAgICAgIGlzVG9kYXk6IGZhbHNlLFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGNvbnN0IHRvZGF5ID0gbmV3IERhdGUoKTtcclxuICAgICAgICAvLyDliKTmlq3mmK/lkKbkuLrlvZPlpKlcclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICAgIHRvZGF5LmdldEZ1bGxZZWFyKCkgPT09IHllYXIgJiZcclxuICAgICAgICAgICAgdG9kYXkuZ2V0TW9udGgoKSArIDEgPT09IG1vbnRoICYmXHJcbiAgICAgICAgICAgIHRvZGF5LmdldERhdGUoKSA9PT0gZGF5XHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICAgIGRhdGVJbmZvW1wiaXNUb2RheVwiXSA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBkYXRlSW5mbztcclxuICAgIH1cclxuXHJcbiAgICAvLyDmoLnmja7ln7rlh4bml6XmnJ/vvIzojrflj5bplb/luqbkuLpkYXlMZW50aOeahOaXpeacn+aVsOe7hFxyXG4gICAgcHJpdmF0ZSBzZXREYXRlKGRhdGUgPSBuZXcgRGF0ZSgpLCBzdGVwID0gNywgZmlyc3REYXlPZldlZWs6IEZpcnN0RGF5T2ZXZWVrID0gJ+S4gCcpIHtcclxuICAgICAgICBsZXQgd2Vla0RhdGEgPSBbXTtcclxuICAgICAgICBjb25zdCB3ZWVrID0gZGF0ZS5nZXREYXkoKSAtIDE7XHJcblxyXG5cclxuICAgICAgICBsZXQgX3JhbmdlRGF5cyA9IHdlZWsgKiAtMTsgLy8g5Lul5ZGo5LiA5Li656ysMeWkqVxyXG5cclxuICAgICAgICBpZiAoZmlyc3REYXlPZldlZWsgPT09ICfml6UnKSB7XHJcbiAgICAgICAgICAgIF9yYW5nZURheXMgPSBfcmFuZ2VEYXlzIC0gMTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZGF0ZSA9IHRoaXMuZ2V0RGF0ZUJ5RGF0ZShkYXRlLCBfcmFuZ2VEYXlzKTsgLy8g5Lul5ZGo5pel5Li656ysMeWkqeaXtiAtMVxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3RlcDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHdlZWtEYXRhLnB1c2goXHJcbiAgICAgICAgICAgICAgICB0aGlzLmZvcm1hdERhdGUoaSA9PSAwID8gZGF0ZSA6IHRoaXMuZ2V0RGF0ZUJ5RGF0ZShkYXRlLCAxKSwgZmlyc3REYXlPZldlZWspXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB3ZWVrRGF0YTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDmoLnmja7ln7rlh4bml6XmnJ/ojrflj5bliY3lkI7mn5DlpKnnmoTml6XmnJ/lr7nosaFcclxuICAgIHByaXZhdGUgZ2V0RGF0ZUJ5RGF0ZShkYXRlID0gbmV3IERhdGUoKSwgcmFuZ2UgPSAwKSB7XHJcbiAgICAgICAgZGF0ZS5zZXREYXRlKGRhdGUuZ2V0RGF0ZSgpICsgcmFuZ2UpO1xyXG4gICAgICAgIHJldHVybiBkYXRlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qIFxyXG4gICAg6I635Y+W5LulYmFzZWxpbmVEYXRl5omA5Zyo5ZGo55qE5LiA5ZGo44CB5YmN5LiA5ZGo44CB5LiL5LiA5ZGo55qE5pel5pyf5ZKM5pif5pyf5L+h5oGvKOWIh+aNouWRqOacn+S5n+WPr+mAmui/h+WPguaVsGRheUxlbnRo6Ieq6KGM6K6+572uKVxyXG4gICAgYmFzZWxpbmVEYXRlOiDorr7nva7nmoTln7rlh4bml6XmnJ8o6L+U5Zue55qE5pel5pyf5YiX6KGo55qE56ys5LiA5Liq5pel5pyfKVxyXG4gICAgcmFuZ2U6IOS7pSBiYXNlbGluZURhdGUg5Li65Z+65YeG5pel5pyf55qE5YmN5ZCO5aSp5pWw6IyD5Zu0KOWmguWfuuWHhuaXpeacn+eahHJhbmdl5Li6MO+8jOmcgOimgei/lOWbnuWJjTflpKnml6XmnJ/vvIzliJlyYW5nZeS4ui0377yM5ZCON+WkqeWImXJhbmdl5Li6NylcclxuICAgIHN0ZXA6IOmcgOimgeiOt+WPlueahOaXpeacn+S/oeaBr+WRqOacn+WkqeaVsO+8jOm7mOiupOiOt+WPlmJhc2VsaW5lRGF0ZeaJgOWcqOWRqOeahOS4gOWRqOaXpeacn+S/oeaBr1xyXG4gICAgZmlyc3REYXlPZldlZWs6IOavj+WRqOesrOS4gOWkqSDmmK8g5ZGo5LiA77yM6L+Y5piv5ZGo5pel77yM6buY6K6k5Li6IOWRqOS4gFxyXG4gICAqL1xyXG4gICAgZ2V0V2Vla0RhdGUoeyBiYXNlbGluZURhdGUgPSBuZXcgRGF0ZSgpLCByYW5nZSA9IDAsIHN0ZXAgPSA3IH0sIGZpcnN0RGF5T2ZXZWVrOiBGaXJzdERheU9mV2VlayA9ICfkuIAnKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2V0RGF0ZSh0aGlzLmdldERhdGVCeURhdGUoYmFzZWxpbmVEYXRlLCByYW5nZSksIHN0ZXAsIGZpcnN0RGF5T2ZXZWVrKTtcclxuICAgIH1cclxuXHJcbiAgICAvKiog5qC55o2u5b2T5YmN5pel5pyf77yM6I635Y+W5b2T5YmN5piv5omA5Zyo5bm055qE56ys5Yeg5ZGoICovXHJcbiAgICBnZXRZZWFyV2Vlayh5ZWFyLCBtb250aCwgZGF5KSB7Ly9h5Li65bm0IGLkuLrmnIggY+S4uuaXpVxyXG4gICAgICAgIC8qICBcclxuICAgICAgICBkYXRlMeaYr+W9k+WJjeaXpeacnyAgXHJcbiAgICAgICAgZGF0ZTLmmK/lvZPlubTnrKzkuIDlpKkgIFxyXG4gICAgICAgIGTmmK/lvZPliY3ml6XmnJ/mmK/ku4rlubTnrKzlpJrlsJHlpKkgIFxyXG4gICAgICAgIOeUqGQgKyDlvZPliY3lubTnmoTnrKzkuIDlpKnnmoTlkajlt67ot53nmoTlkozlnKjpmaTku6U35bCx5piv5pys5bm056ys5Yeg5ZGoICBcclxuICAgICAgICAqL1xyXG4gICAgICAgIHZhciBkYXRlMSA9IG5ldyBEYXRlKHllYXIsIHBhcnNlSW50KG1vbnRoKSAtIDEsIGRheSksXHJcbiAgICAgICAgICAgIGRhdGUyID0gbmV3IERhdGUoeWVhciwgMCwgMSksXHJcbiAgICAgICAgICAgIGQgPSBNYXRoLnJvdW5kKChkYXRlMS52YWx1ZU9mKCkgLSBkYXRlMi52YWx1ZU9mKCkpIC8gODY0MDAwMDApO1xyXG4gICAgICAgIHJldHVybiBNYXRoLmNlaWwoKGQgKyAoKGRhdGUyLmdldERheSgpICsgMSkgLSAxKSkgLyA3KTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRNb250aFdlZWsoeWVhciwgbW9udGgsIGRheSkge1xyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICogYSA9IGQgPSDlvZPliY3ml6XmnJ9cclxuICAgICAgICAqIGIgPSA2IC0gdyA9IOW9k+WJjeWRqOeahOi/mOacieWHoOWkqei/h+WujCjkuI3nrpfku4rlpKkpXHJcbiAgICAgICAgKiBhICsgYiDnmoTlkozlnKjpmaTku6U3IOWwseaYr+W9k+WkqeaYr+W9k+WJjeaciOS7veeahOesrOWHoOWRqFxyXG4gICAgICAgICovXHJcbiAgICAgICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSh5ZWFyLCBwYXJzZUludChtb250aCkgLSAxLCBkYXkpLFxyXG4gICAgICAgICAgICB3ID0gZGF0ZS5nZXREYXkoKSxcclxuICAgICAgICAgICAgZCA9IGRhdGUuZ2V0RGF0ZSgpO1xyXG4gICAgICAgIGlmICh3ID09IDApIHtcclxuICAgICAgICAgICAgdyA9IDc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBjb25maWcgPSB7XHJcbiAgICAgICAgICAgIGdldE1vbnRoOiBkYXRlLmdldE1vbnRoKCkgKyAxLFxyXG4gICAgICAgICAgICBnZXRZZWFyOiBkYXRlLmdldEZ1bGxZZWFyKCksXHJcbiAgICAgICAgICAgIGdldFdlZWs6IE1hdGguY2VpbCgoZCArIDYgLSB3KSAvIDcpLFxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gY29uZmlnO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBnZXROb3dXZWVrVGltZShkYXRlOiBEYXRlLCBmaXJzdERheU9mV2VlazogRmlyc3REYXlPZldlZWspIHtcclxuICAgICAgICBkYXRlLnNldERhdGUoZGF0ZS5nZXREYXRlKCkgLSAoKGRhdGUuZ2V0RGF5KCkgKyA2KSAlIDcpKTtcclxuICAgICAgICBjb25zdCBiZWdpbiA9IHtcclxuICAgICAgICAgICAgeWVhcjogZGF0ZS5nZXRGdWxsWWVhcigpLFxyXG4gICAgICAgICAgICBtb250aDogZGF0ZS5nZXRNb250aCgpICsgMSxcclxuICAgICAgICAgICAgZGF5OiBkYXRlLmdldERhdGUoKVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgZGF0ZS5zZXREYXRlKGRhdGUuZ2V0RGF0ZSgpICsgNik7XHJcbiAgICAgICAgY29uc3QgZW5kID0ge1xyXG4gICAgICAgICAgICB5ZWFyOiBkYXRlLmdldEZ1bGxZZWFyKCksXHJcbiAgICAgICAgICAgIG1vbnRoOiBkYXRlLmdldE1vbnRoKCkgKyAxLFxyXG4gICAgICAgICAgICBkYXk6IGRhdGUuZ2V0RGF0ZSgpXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaWYgKGZpcnN0RGF5T2ZXZWVrID09PSAn5LiAJykge1xyXG4gICAgICAgICAgICByZXR1cm4geyBiZWdpbiwgZW5kIH07XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKGRhdGUuZ2V0RGF5KCkgIT0gMCkge1xyXG4gICAgICAgICAgICAgICAgZGF0ZS5zZXREYXRlKGRhdGUuZ2V0RGF0ZSgpIC0gZGF0ZS5nZXREYXkoKSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IF9iZWdpbiA9IHtcclxuICAgICAgICAgICAgICAgIHllYXI6IGRhdGUuZ2V0RnVsbFllYXIoKSxcclxuICAgICAgICAgICAgICAgIG1vbnRoOiBkYXRlLmdldE1vbnRoKCkgKyAxLFxyXG4gICAgICAgICAgICAgICAgZGF5OiBkYXRlLmdldERhdGUoKVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgZGF0ZS5zZXREYXRlKGRhdGUuZ2V0RGF0ZSgpICsgNiAtIGRhdGUuZ2V0RGF5KCkpO1xyXG4gICAgICAgICAgICBjb25zdCBfZW5kID0ge1xyXG4gICAgICAgICAgICAgICAgeWVhcjogZGF0ZS5nZXRGdWxsWWVhcigpLFxyXG4gICAgICAgICAgICAgICAgbW9udGg6IGRhdGUuZ2V0TW9udGgoKSArIDEsXHJcbiAgICAgICAgICAgICAgICBkYXk6IGRhdGUuZ2V0RGF0ZSgpXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBiZWdpbjogX2JlZ2luLFxyXG4gICAgICAgICAgICAgICAgZW5kOiBfZW5kXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19