/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { NumberHelperService } from '@farris/ui-common/number';
import { DateTimeHelperService } from '@farris/ui-common/date';
import { Compare, FilterRelation, CompareOperators, SortType } from '@farris/ui-common/types';
import * as i0 from "@angular/core";
import * as i1 from "@farris/ui-common/date";
import * as i2 from "@farris/ui-common/number";
/*
 * @Author: 疯狂秀才(Lucas Huang)
 * @Date: 2019-01-02 14:12:47
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-10-18 13:59:34
 * @Company: Inspur
 * @Version: v0.0.1
 */
var ColumnFormatService = /** @class */ (function () {
    function ColumnFormatService(datehelper, numberhelper) {
        this.datehelper = datehelper;
        this.numberhelper = numberhelper;
    }
    /**
     * @param {?} value
     * @param {?=} data
     * @param {?=} formatter
     * @param {?=} context
     * @return {?}
     */
    ColumnFormatService.prototype.format = /**
     * @param {?} value
     * @param {?=} data
     * @param {?=} formatter
     * @param {?=} context
     * @return {?}
     */
    function (value, data, formatter, context) {
        if (formatter) {
            if (typeof (formatter) === 'function') {
                context = context || {};
                return formatter(value, data, tslib_1.__assign({ date: this.datehelper, number: this.numberhelper, format: this }, context));
            }
            else {
                if (formatter['type']) {
                    /** @type {?} */
                    var fmt = (/** @type {?} */ (formatter));
                    switch (fmt.type) {
                        case 'datetime':
                            return this.dateTimeFormat(value, fmt.options);
                        case 'timeago':
                            var locale = fmt.options.locale;
                            return this.datehelper.relativeTime(value, locale || 'zh-CHS');
                        case 'number':
                            return this.numberFormat(value, fmt.options);
                        case 'enum':
                            return this.enumFormat(value, fmt.options);
                        case 'image':
                            return this.imageFormat(value, fmt.options);
                        case 'boolean':
                        case 'boolean2':
                            return this.booleanFormat(value, fmt.options);
                        default:
                            return value;
                    }
                }
            }
        }
        return value;
    };
    /**
     * @private
     * @param {?} value
     * @param {?} opts
     * @return {?}
     */
    ColumnFormatService.prototype.dateTimeFormat = /**
     * @private
     * @param {?} value
     * @param {?} opts
     * @return {?}
     */
    function (value, opts) {
        if (value) {
            /** @type {?} */
            var fmt = 'yyyy-MM-dd';
            if (typeof (opts) === 'string') {
                fmt = opts;
            }
            else if (typeof (opts) === 'object') {
                fmt = opts.format || 'yyyy-MM-dd';
            }
            fmt = fmt.replace('YYYY', 'yyyy').replace('-DD', '-dd');
            if (typeof (opts) === 'object' && opts.dateRange) {
                /** @type {?} */
                var splitStr = opts.dateRangeDatesDelimiter || '~';
                var _a = tslib_1.__read(value.split(splitStr), 2), beginDate = _a[0], endDate = _a[1];
                beginDate = this.datehelper.formatTo(beginDate, fmt);
                endDate = this.datehelper.formatTo(endDate, fmt);
                return beginDate + splitStr + endDate;
            }
            return this.datehelper.formatTo(value, fmt);
        }
        return value;
    };
    /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    ColumnFormatService.prototype.numberFormat = /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    function (value, opts) {
        return this.numberhelper.formatNumber(value, opts);
        // if (value !== undefined && value !== '' && value !== NaN) {
        //     return this.numberhelper.formatMoney(value, opts);
        // }
        // return value;
    };
    /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    ColumnFormatService.prototype.enumFormat = /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    function (value, opts) {
        if (value === undefined || value === null) {
            value = '';
        }
        if (opts && opts.data && opts.data.length) {
            /** @type {?} */
            var val = value.toString();
            /** @type {?} */
            var arr = [val];
            if (val.indexOf(',') > -1) { // 多选
                arr = val.split(',');
            }
            /** @type {?} */
            var str_1 = [];
            arr.forEach((/**
             * @param {?} v
             * @return {?}
             */
            function (v) {
                /** @type {?} */
                var n = opts.data.find((/**
                 * @param {?} item
                 * @return {?}
                 */
                function (item) { return item[opts.valueField].toString() == v; }));
                if (n) {
                    str_1.push(n[opts.textField]);
                }
            }));
            if (str_1.length) {
                return str_1.join(',');
            }
            return value;
        }
        return value;
    };
    /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    ColumnFormatService.prototype.imageFormat = /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    function (value, opts) {
        if (value) {
            if (opts) {
                /** @type {?} */
                var arrStr = ["<img src=\"" + value + "\" "];
                if (opts.width) {
                    arrStr.push("width=\"" + opts.width + "\"");
                }
                if (opts.height) {
                    arrStr.push("height=\"" + opts.height + "\"");
                }
                arrStr.push('>');
                return arrStr.join('');
            }
            else {
                return "<img src=\"" + value + "\">";
            }
        }
        return value;
    };
    /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    ColumnFormatService.prototype.booleanFormat = /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    function (value, opts) {
        if (value !== undefined) {
            if (opts) {
                /** @type {?} */
                var val = value ? opts.trueText : opts.falseText;
                if (val === null || val === undefined) {
                    return value;
                }
                return val;
            }
            else {
                return value;
            }
        }
        return '';
    };
    /**
     * @private
     * @param {?} val
     * @return {?}
     */
    ColumnFormatService.prototype.convertCompare = /**
     * @private
     * @param {?} val
     * @return {?}
     */
    function (val) {
        /** @type {?} */
        var op = CompareOperators.find((/**
         * @param {?} item
         * @return {?}
         */
        function (item) { return item.value === val; }));
        if (op) {
            return op.label;
        }
    };
    /**
     * @param {?} sorts
     * @return {?}
     */
    ColumnFormatService.prototype.buildSortString = /**
     * @param {?} sorts
     * @return {?}
     */
    function (sorts) {
        if (sorts && sorts.length) {
            /** @type {?} */
            var str = sorts.map((/**
             * @param {?} s
             * @return {?}
             */
            function (s) {
                return s.sortField + " " + SortType[s.sortType].toString().toLowerCase() + ",";
            })).join(' ');
            if (str) {
                str = str.substr(0, str.length - 1);
            }
            return str;
        }
        return '';
    };
    /**
     * @param {?} conditions
     * @return {?}
     */
    ColumnFormatService.prototype.buildSqlWhere = /**
     * @param {?} conditions
     * @return {?}
     */
    function (conditions) {
        var _this = this;
        if (conditions && conditions.length) {
            /** @type {?} */
            var result_1 = [];
            /** @type {?} */
            var conditionList_1 = conditions.filter((/**
             * @param {?} c
             * @return {?}
             */
            function (c) { return c.filterField !== ''; }));
            conditionList_1.forEach((/**
             * @param {?} condition
             * @param {?} index
             * @return {?}
             */
            function (condition, index) {
                if (!condition.filterField) {
                    return;
                }
                result_1.push(condition.lbracket);
                result_1.push(condition.filterField);
                /** @type {?} */
                var opCode = parseInt(condition.compare.toString(), 10);
                /** @type {?} */
                var op = _this.convertCompare(opCode);
                result_1.push(' ' + op.replace(/\%/g, '').replace('...', ''));
                if (opCode === Compare.Like || opCode === Compare.NotLike
                    || opCode === Compare.NotLikeEndWith
                    || opCode === Compare.LikeEndWith) {
                    result_1.push('\'');
                    result_1.push('%');
                }
                else {
                    result_1.push(' ');
                    result_1.push('\'');
                }
                if (opCode === Compare.In || opCode === Compare.NotIn) {
                    result_1.push(condition.value.replace(/\r\n/g, ','));
                }
                else {
                    result_1.push(condition.value);
                }
                if (opCode === Compare.Like || opCode === Compare.NotLike
                    || opCode === Compare.LikeStartWith || opCode === Compare.NotLikeStartWith) {
                    result_1.push('%');
                }
                result_1.push('\'');
                result_1.push(condition.rbracket);
                result_1.push(' ');
                if (index !== conditionList_1.length - 1) {
                    result_1.push(condition.relation === FilterRelation.Empty ? '' :
                        FilterRelation[condition.relation].toString().toLowerCase());
                    result_1.push(' ');
                }
            }));
            return result_1.join('');
        }
        return '';
    };
    ColumnFormatService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    ColumnFormatService.ctorParameters = function () { return [
        { type: DateTimeHelperService },
        { type: NumberHelperService }
    ]; };
    /** @nocollapse */ ColumnFormatService.ngInjectableDef = i0.defineInjectable({ factory: function ColumnFormatService_Factory() { return new ColumnFormatService(i0.inject(i1.DateTimeHelperService), i0.inject(i2.NumberHelperService)); }, token: ColumnFormatService, providedIn: "root" });
    return ColumnFormatService;
}());
export { ColumnFormatService };
if (false) {
    /** @type {?} */
    ColumnFormatService.prototype.datehelper;
    /** @type {?} */
    ColumnFormatService.prototype.numberhelper;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sdW1uLWZvcm1hdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1jb21tb24vY29sdW1uLyIsInNvdXJjZXMiOlsiY29sdW1uLWZvcm1hdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBc0IsTUFBTSxlQUFlLENBQUM7QUFDL0QsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDL0QsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFFL0QsT0FBTyxFQUFtQixPQUFPLEVBQUUsY0FBYyxFQUFFLGdCQUFnQixFQUFpQixRQUFRLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQzs7Ozs7Ozs7Ozs7O0FBUzlIO0lBSUksNkJBQW1CLFVBQWlDLEVBQVMsWUFBaUM7UUFBM0UsZUFBVSxHQUFWLFVBQVUsQ0FBdUI7UUFBUyxpQkFBWSxHQUFaLFlBQVksQ0FBcUI7SUFDOUYsQ0FBQzs7Ozs7Ozs7SUFFRCxvQ0FBTTs7Ozs7OztJQUFOLFVBQU8sS0FBVSxFQUFFLElBQVUsRUFBRSxTQUF5QixFQUFFLE9BQWE7UUFDbkUsSUFBSSxTQUFTLEVBQUU7WUFDWCxJQUFJLE9BQU0sQ0FBQyxTQUFTLENBQUMsS0FBSyxVQUFVLEVBQUU7Z0JBQ2xDLE9BQU8sR0FBRyxPQUFPLElBQUksRUFBRSxDQUFDO2dCQUN4QixPQUFPLFNBQVMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxxQkFBSSxJQUFJLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxNQUFNLEVBQUUsSUFBSSxJQUFLLE9BQU8sRUFBRyxDQUFDO2FBQ2pIO2lCQUFNO2dCQUNILElBQUksU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFOzt3QkFDYixHQUFHLEdBQUcsbUJBQUEsU0FBUyxFQUFtQjtvQkFDeEMsUUFBUSxHQUFHLENBQUMsSUFBSSxF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QUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDbEIsUUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ2hDLFFBQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBRWpCLElBQUksS0FBSyxLQUFLLGVBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO29CQUNwQyxRQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLEtBQUssY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7d0JBQzlCLGNBQWMsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztvQkFDN0YsUUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztpQkFDcEI7WUFDTCxDQUFDLEVBQUMsQ0FBQztZQUVILE9BQU8sUUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUMxQjtRQUVELE9BQU8sRUFBRSxDQUFDO0lBQ2QsQ0FBQzs7Z0JBdk5KLFVBQVUsU0FBQztvQkFDUixVQUFVLEVBQUUsTUFBTTtpQkFDckI7Ozs7Z0JBYlEscUJBQXFCO2dCQURyQixtQkFBbUI7Ozs4QkFENUI7Q0FxT0MsQUF4TkQsSUF3TkM7U0FyTlksbUJBQW1COzs7SUFDaEIseUNBQXdDOztJQUFFLDJDQUF3QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBOdW1iZXJIZWxwZXJTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24vbnVtYmVyJztcclxuaW1wb3J0IHsgRGF0ZVRpbWVIZWxwZXJTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24vZGF0ZSc7XHJcbmltcG9ydCB7IENvbHVtbkZvcm1hdHRlciwgTnVtYmVyRm9ybWF0T3B0aW9ucywgRW51bUZvcm1hdE9wdGlvbnMsIEltYWdlRm9ybWF0T3B0aW9ucywgQm9vbGVhbkZvcm1hdE9wdGlvbnMsIERhdGFGb3JtYXR0ZXIgfSBmcm9tICcuL2NvbHVtbi1mb3JtYXQub3B0aW9ucyc7XHJcbmltcG9ydCB7IEZpbHRlckNvbmRpdGlvbiwgQ29tcGFyZSwgRmlsdGVyUmVsYXRpb24sIENvbXBhcmVPcGVyYXRvcnMsIFNvcnRDb25kaXRpb24sIFNvcnRUeXBlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24vdHlwZXMnO1xyXG4vKlxyXG4gKiBAQXV0aG9yOiDnlq/ni4Lnp4DmiY0oTHVjYXMgSHVhbmcpXHJcbiAqIEBEYXRlOiAyMDE5LTAxLTAyIDE0OjEyOjQ3XHJcbiAqIEBMYXN0RWRpdG9yczog55av54uC56eA5omNKEx1Y2FzIEh1YW5nKVxyXG4gKiBATGFzdEVkaXRUaW1lOiAyMDE5LTEwLTE4IDEzOjU5OjM0XHJcbiAqIEBDb21wYW55OiBJbnNwdXJcclxuICogQFZlcnNpb246IHYwLjAuMVxyXG4gKi9cclxuQEluamVjdGFibGUoe1xyXG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBDb2x1bW5Gb3JtYXRTZXJ2aWNlIHtcclxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBkYXRlaGVscGVyOiBEYXRlVGltZUhlbHBlclNlcnZpY2UsIHB1YmxpYyBudW1iZXJoZWxwZXI6IE51bWJlckhlbHBlclNlcnZpY2UpIHtcclxuICAgIH1cclxuXHJcbiAgICBmb3JtYXQodmFsdWU6IGFueSwgZGF0YT86IGFueSwgZm9ybWF0dGVyPzogRGF0YUZvcm1hdHRlciwgY29udGV4dD86IGFueSkge1xyXG4gICAgICAgIGlmIChmb3JtYXR0ZXIpIHtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZihmb3JtYXR0ZXIpID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCB7fTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmb3JtYXR0ZXIodmFsdWUsIGRhdGEsIHsgZGF0ZTogdGhpcy5kYXRlaGVscGVyLCBudW1iZXI6IHRoaXMubnVtYmVyaGVscGVyLCBmb3JtYXQ6IHRoaXMsIC4uLmNvbnRleHQgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZm9ybWF0dGVyWyd0eXBlJ10pIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBmbXQgPSBmb3JtYXR0ZXIgYXMgQ29sdW1uRm9ybWF0dGVyO1xyXG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZm10LnR5cGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZGF0ZXRpbWUnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0ZVRpbWVGb3JtYXQodmFsdWUsIGZtdC5vcHRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAndGltZWFnbyc6IFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qge2xvY2FsZX0gPSBmbXQub3B0aW9ucztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRhdGVoZWxwZXIucmVsYXRpdmVUaW1lKHZhbHVlLCBsb2NhbGUgfHwgJ3poLUNIUycpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubnVtYmVyRm9ybWF0KHZhbHVlLCBmbXQub3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW51bUZvcm1hdCh2YWx1ZSwgZm10Lm9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdpbWFnZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbWFnZUZvcm1hdCh2YWx1ZSwgZm10Lm9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdib29sZWFuJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnYm9vbGVhbjInOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYm9vbGVhbkZvcm1hdCh2YWx1ZSwgZm10Lm9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBkYXRlVGltZUZvcm1hdCh2YWx1ZTogYW55LCBvcHRzOiBhbnkpIHtcclxuICAgICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICAgICAgbGV0IGZtdCA9ICd5eXl5LU1NLWRkJztcclxuICAgICAgICAgICAgaWYgKHR5cGVvZihvcHRzKSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgICAgIGZtdCA9IG9wdHM7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mKG9wdHMpID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICAgICAgZm10ID0gb3B0cy5mb3JtYXQgfHwgJ3l5eXktTU0tZGQnO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBmbXQgPSBmbXQucmVwbGFjZSgnWVlZWScsICd5eXl5JykucmVwbGFjZSgnLUREJywgJy1kZCcpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHR5cGVvZihvcHRzKSA9PT0gJ29iamVjdCcgJiYgb3B0cy5kYXRlUmFuZ2UpIHtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBzcGxpdFN0ciA9IG9wdHMuZGF0ZVJhbmdlRGF0ZXNEZWxpbWl0ZXIgfHwgJ34nO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBbYmVnaW5EYXRlLCBlbmREYXRlIF0gPSB2YWx1ZS5zcGxpdChzcGxpdFN0cik7XHJcbiAgICAgICAgICAgICAgICBiZWdpbkRhdGUgPSB0aGlzLmRhdGVoZWxwZXIuZm9ybWF0VG8oYmVnaW5EYXRlLCBmbXQpO1xyXG4gICAgICAgICAgICAgICAgZW5kRGF0ZSA9IHRoaXMuZGF0ZWhlbHBlci5mb3JtYXRUbyhlbmREYXRlLCBmbXQpO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBiZWdpbkRhdGUgKyBzcGxpdFN0ciArICBlbmREYXRlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRlaGVscGVyLmZvcm1hdFRvKHZhbHVlLCBmbXQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbnVtYmVyRm9ybWF0KHZhbHVlOiBhbnksIG9wdHM/OiBOdW1iZXJGb3JtYXRPcHRpb25zKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubnVtYmVyaGVscGVyLmZvcm1hdE51bWJlcih2YWx1ZSwgb3B0cyk7XHJcbiAgICAgICAgLy8gaWYgKHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09ICcnICYmIHZhbHVlICE9PSBOYU4pIHtcclxuICAgICAgICAvLyAgICAgcmV0dXJuIHRoaXMubnVtYmVyaGVscGVyLmZvcm1hdE1vbmV5KHZhbHVlLCBvcHRzKTtcclxuICAgICAgICAvLyB9XHJcbiAgICAgICAgLy8gcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZW51bUZvcm1hdCh2YWx1ZTogYW55LCBvcHRzPzogRW51bUZvcm1hdE9wdGlvbnMpIHtcclxuICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCApIHtcclxuICAgICAgICAgICAgdmFsdWUgPSAnJztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChvcHRzICYmIG9wdHMuZGF0YSAmJiBvcHRzLmRhdGEubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbCA9IHZhbHVlLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgIGxldCBhcnIgPSBbdmFsXTtcclxuICAgICAgICAgICAgaWYgKHZhbC5pbmRleE9mKCcsJykgPiAtMSkgeyAgLy8g5aSa6YCJXHJcbiAgICAgICAgICAgICAgICBhcnIgPSB2YWwuc3BsaXQoJywnKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3Qgc3RyID0gW107XHJcbiAgICAgICAgICAgIGFyci5mb3JFYWNoKHYgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbiA9IG9wdHMuZGF0YS5maW5kKGl0ZW0gPT4gaXRlbVtvcHRzLnZhbHVlRmllbGRdLnRvU3RyaW5nKCkgPT0gdik7XHJcbiAgICAgICAgICAgICAgICBpZiAobikge1xyXG4gICAgICAgICAgICAgICAgICAgIHN0ci5wdXNoKG5bb3B0cy50ZXh0RmllbGRdKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBpZiAoc3RyLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0ci5qb2luKCcsJyk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaW1hZ2VGb3JtYXQodmFsdWUsIG9wdHM/OiBJbWFnZUZvcm1hdE9wdGlvbnMpIHtcclxuICAgICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICAgICAgaWYgKG9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFyclN0ciA9IFsgYDxpbWcgc3JjPVwiJHt2YWx1ZX1cIiBgXTtcclxuICAgICAgICAgICAgICAgIGlmIChvcHRzLndpZHRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXJyU3RyLnB1c2goYHdpZHRoPVwiJHtvcHRzLndpZHRofVwiYCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAob3B0cy5oZWlnaHQpIHtcclxuICAgICAgICAgICAgICAgICAgICBhcnJTdHIucHVzaChgaGVpZ2h0PVwiJHtvcHRzLmhlaWdodH1cImApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGFyclN0ci5wdXNoKCc+Jyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYXJyU3RyLmpvaW4oJycpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGA8aW1nIHNyYz1cIiR7dmFsdWV9XCI+YDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYm9vbGVhbkZvcm1hdCh2YWx1ZSwgb3B0cz86IEJvb2xlYW5Gb3JtYXRPcHRpb25zKSB7XHJcbiAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgaWYgKG9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IHZhbHVlID8gb3B0cy50cnVlVGV4dCA6IG9wdHMuZmFsc2VUZXh0O1xyXG4gICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gbnVsbCB8fCB2YWwgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdmFsO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBjb252ZXJ0Q29tcGFyZSh2YWw6IG51bWJlcikge1xyXG4gICAgICAgIGNvbnN0IG9wID0gQ29tcGFyZU9wZXJhdG9ycy5maW5kKCAoaXRlbTogYW55KSA9PiBpdGVtLnZhbHVlID09PSB2YWwpO1xyXG4gICAgICAgIGlmIChvcCkge1xyXG4gICAgICAgICAgICByZXR1cm4gb3AubGFiZWw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGJ1aWxkU29ydFN0cmluZyhzb3J0czogU29ydENvbmRpdGlvbltdKTogc3RyaW5nIHtcclxuICAgICAgICBpZiAoc29ydHMgJiYgc29ydHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGxldCBzdHIgPSBzb3J0cy5tYXAocyA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYCR7cy5zb3J0RmllbGR9ICR7U29ydFR5cGVbcy5zb3J0VHlwZV0udG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpfSxgO1xyXG4gICAgICAgICAgICB9KS5qb2luKCcgJyk7XHJcblxyXG4gICAgICAgICAgICBpZiAoc3RyKSB7XHJcbiAgICAgICAgICAgICAgICBzdHIgPSBzdHIuc3Vic3RyKDAsIHN0ci5sZW5ndGggLSAxKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHN0cjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbiAgICBidWlsZFNxbFdoZXJlKGNvbmRpdGlvbnM6IEZpbHRlckNvbmRpdGlvbltdKTogc3RyaW5nIHtcclxuICAgICAgICBpZiAoY29uZGl0aW9ucyAmJiBjb25kaXRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBbXTtcclxuICAgICAgICAgICAgY29uc3QgY29uZGl0aW9uTGlzdCA9IGNvbmRpdGlvbnMuZmlsdGVyKGMgPT4gYy5maWx0ZXJGaWVsZCAhPT0gJycpO1xyXG4gICAgICAgICAgICBjb25kaXRpb25MaXN0LmZvckVhY2goKGNvbmRpdGlvbiwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICghY29uZGl0aW9uLmZpbHRlckZpZWxkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goY29uZGl0aW9uLmxicmFja2V0KTtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGNvbmRpdGlvbi5maWx0ZXJGaWVsZCk7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3Qgb3BDb2RlID0gcGFyc2VJbnQoY29uZGl0aW9uLmNvbXBhcmUudG9TdHJpbmcoKSwgMTApO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgb3AgPSB0aGlzLmNvbnZlcnRDb21wYXJlKG9wQ29kZSk7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnICcgKyBvcC5yZXBsYWNlKC9cXCUvZywgJycpLnJlcGxhY2UoJy4uLicsICcnKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKG9wQ29kZSA9PT0gQ29tcGFyZS5MaWtlIHx8IG9wQ29kZSA9PT0gQ29tcGFyZS5Ob3RMaWtlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IG9wQ29kZSA9PT0gQ29tcGFyZS5Ob3RMaWtlRW5kV2l0aFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCBvcENvZGUgPT09IENvbXBhcmUuTGlrZUVuZFdpdGgpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnXFwnJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJyUnKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJyAnKTtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnXFwnJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKG9wQ29kZSA9PT0gQ29tcGFyZS5JbiB8fCBvcENvZGUgPT09IENvbXBhcmUuTm90SW4pIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChjb25kaXRpb24udmFsdWUucmVwbGFjZSgvXFxyXFxuL2csICcsJykpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChjb25kaXRpb24udmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChvcENvZGUgPT09IENvbXBhcmUuTGlrZSB8fCBvcENvZGUgPT09IENvbXBhcmUuTm90TGlrZVxyXG4gICAgICAgICAgICAgICAgICAgIHx8IG9wQ29kZSA9PT0gQ29tcGFyZS5MaWtlU3RhcnRXaXRoIHx8IG9wQ29kZSA9PT0gQ29tcGFyZS5Ob3RMaWtlU3RhcnRXaXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJyUnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKCdcXCcnKTtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGNvbmRpdGlvbi5yYnJhY2tldCk7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnICcpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChpbmRleCAhPT0gY29uZGl0aW9uTGlzdC5sZW5ndGggLSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goY29uZGl0aW9uLnJlbGF0aW9uID09PSBGaWx0ZXJSZWxhdGlvbi5FbXB0eSA/ICcnIDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZpbHRlclJlbGF0aW9uW2NvbmRpdGlvbi5yZWxhdGlvbl0udG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpKTtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnICcpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQuam9pbignJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcbn1cclxuIl19