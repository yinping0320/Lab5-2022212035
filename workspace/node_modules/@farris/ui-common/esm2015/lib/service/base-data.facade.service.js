/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { BehaviorSubject } from 'rxjs';
import { map } from 'rxjs/operators';
/**
 * @template T
 */
export class BaseDataFacadeService {
    /**
     * @param {?} _initState
     */
    constructor(_initState) {
        this._initState = _initState;
        this._state = this._initState;
        this.store = new BehaviorSubject(this._state);
        this.state$ = this.store.asObservable();
        this.data$ = this.state$.pipe(map((/**
         * @param {?} state
         * @return {?}
         */
        (state) => state.data)));
    }
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    initData(data) {
        return data.map((/**
         * @param {?} d
         * @return {?}
         */
        d => {
            /** @type {?} */
            const _id = d[this._state.idField];
            /** @type {?} */
            const disable = (/**
             * @return {?}
             */
            () => {
                return this.disableExpress ? this.disableExpress(d) : d[this._state.disabledField] ? true : false;
            });
            return {
                id: _id,
                data: d,
                disabled: disable(),
            };
        }));
    }
    /**
     * @protected
     * @param {?} state
     * @return {?}
     */
    updateState(state) {
        /** @type {?} */
        const newState = Object.assign({}, this._state, state);
        this.store.next(this._state = newState);
    }
    /**
     * @param {?} state
     * @return {?}
     */
    initState(state) {
        this.updateState(state);
    }
    /**
     * @param {?} id
     * @return {?}
     */
    isSelect(id) {
        if (this._state.selections && this._state.selections.length) {
            return this._state.selections.find((/**
             * @param {?} item
             * @return {?}
             */
            item => !!item ? item[this._state.idField] == id : false)) !== undefined;
        }
        return false;
    }
    /**
     * @param {?} data
     * @param {?=} selectValues
     * @param {?=} separator
     * @return {?}
     */
    loadData(data, selectValues = '', separator = ',') {
        if (data) {
            /** @type {?} */
            const _data = this.initData(data);
            this.updateState(Object.assign({}, this._state, { data: _data }));
            if (selectValues) {
                this.setSelections(selectValues, separator);
            }
            else {
                this._state.selections = [];
            }
        }
        else {
            this.updateState({ data: [], selections: [] });
        }
    }
    /**
     * @return {?}
     */
    getSelections() {
        return this._state.selections;
    }
    /**
     * @param {?} selectValues
     * @param {?=} separator
     * @return {?}
     */
    setSelections(selectValues, separator = ',') {
        if (selectValues) {
            /** @type {?} */
            let selectedItems = [];
            if (this._state.multiSelect) {
                selectedItems = selectValues.split(separator).map((/**
                 * @param {?} val
                 * @return {?}
                 */
                val => {
                    return this._state.data.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    d => d.data[this._state.valueField] + '' == val));
                })).map((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => {
                    return n ? n.data : '';
                })).filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n));
            }
            else {
                selectedItems = [this._state.data.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    d => d.data[this._state.valueField] + '' == selectValues))];
            }
            this.updateState({ selections: selectedItems });
        }
    }
    /**
     * @return {?}
     */
    selectAll() {
        this.updateState({ selections: this._state.data.map((/**
             * @param {?} n
             * @return {?}
             */
            n => n.data)) });
    }
    /**
     * @return {?}
     */
    unSelectAll() {
        this.clearSelections();
    }
    /**
     * @param {?} data
     * @param {?=} index
     * @return {?}
     */
    selectItem(data, index) {
        /** @type {?} */
        const idfield = this._state.idField;
        /** @type {?} */
        let selections = this.getSelections();
        /** @type {?} */
        const id = data[idfield];
        if (!this._state.multiSelect) {
            if (!this.isSelect(id)) {
                selections = [data];
            }
        }
        else {
            if (!this.isSelect(id)) {
                selections.push(data);
            }
        }
        /** @type {?} */
        const items = this.cloneArray(selections);
        this.updateState({ selections: items });
    }
    /**
     * @param {?} data
     * @return {?}
     */
    unSelectItem(data) {
        /** @type {?} */
        const idfield = this._state.idField;
        /** @type {?} */
        let selections = this.getSelections();
        /** @type {?} */
        const id = data[idfield];
        if (!this._state.multiSelect) {
            selections = [];
        }
        else {
            selections = selections.filter((/**
             * @param {?} n
             * @return {?}
             */
            n => n[idfield] != id));
        }
        /** @type {?} */
        const items = this.cloneArray(selections);
        this.updateState({ selections: items });
    }
    /**
     * @return {?}
     */
    clearSelections() {
        this.updateState({ selections: [] });
    }
    /**
     * @private
     * @param {?} arr
     * @return {?}
     */
    cloneArray(arr) {
        if (arr && arr.length) {
            return arr.map((/**
             * @param {?} n
             * @return {?}
             */
            n => n));
        }
        return arr;
    }
}
if (false) {
    /**
     * @type {?}
     * @protected
     */
    BaseDataFacadeService.prototype._state;
    /** @type {?} */
    BaseDataFacadeService.prototype.disableExpress;
    /** @type {?} */
    BaseDataFacadeService.prototype.store;
    /** @type {?} */
    BaseDataFacadeService.prototype.state$;
    /** @type {?} */
    BaseDataFacadeService.prototype.data$;
    /**
     * @type {?}
     * @private
     */
    BaseDataFacadeService.prototype._initState;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1kYXRhLmZhY2FkZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1jb21tb24vIiwic291cmNlcyI6WyJsaWIvc2VydmljZS9iYXNlLWRhdGEuZmFjYWRlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLE9BQU8sRUFBRSxlQUFlLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDbkQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBRXJDLE1BQU0sT0FBTyxxQkFBcUI7Ozs7SUFTOUIsWUFBb0IsVUFBYTtRQUFiLGVBQVUsR0FBVixVQUFVLENBQUc7UUFSdkIsV0FBTSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7UUFHMUIsVUFBSyxHQUFJLElBQUksZUFBZSxDQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM3QyxXQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUU1QyxVQUFLLEdBQW9CLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUc7Ozs7UUFBQyxDQUFDLEtBQVEsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksRUFBQyxDQUFDLENBQUM7SUFHekUsQ0FBQzs7Ozs7O0lBRU8sUUFBUSxDQUFDLElBQVM7UUFDdEIsT0FBTyxJQUFJLENBQUMsR0FBRzs7OztRQUFDLENBQUMsQ0FBQyxFQUFFOztrQkFDVixHQUFHLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDOztrQkFDNUIsT0FBTzs7O1lBQUcsR0FBRyxFQUFFO2dCQUNqQixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJ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c0NvbnRlbnQiOlsiaW1wb3J0IHsgRmFycmlzRGF0YVN0YXRlIH0gZnJvbSAnLi9mYXJyaXMtZGF0YWl0ZW0nO1xyXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuZXhwb3J0IGNsYXNzIEJhc2VEYXRhRmFjYWRlU2VydmljZTxUIGV4dGVuZHMgRmFycmlzRGF0YVN0YXRlPiB7XHJcbiAgICBwcm90ZWN0ZWQgX3N0YXRlID0gdGhpcy5faW5pdFN0YXRlO1xyXG4gICAgZGlzYWJsZUV4cHJlc3M6IChpdGVtKSA9PiBib29sZWFuO1xyXG5cclxuICAgIHJlYWRvbmx5IHN0b3JlICA9IG5ldyBCZWhhdmlvclN1YmplY3Q8VD4odGhpcy5fc3RhdGUpO1xyXG4gICAgcmVhZG9ubHkgc3RhdGUkID0gdGhpcy5zdG9yZS5hc09ic2VydmFibGUoKTtcclxuXHJcbiAgICBkYXRhJDogT2JzZXJ2YWJsZTxhbnk+ID0gdGhpcy5zdGF0ZSQucGlwZShtYXAoKHN0YXRlOiBUKSA9PiBzdGF0ZS5kYXRhKSk7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfaW5pdFN0YXRlOiBUKSB7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0RGF0YShkYXRhOiBhbnkpIHtcclxuICAgICAgICByZXR1cm4gZGF0YS5tYXAoZCA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IF9pZCA9IGRbdGhpcy5fc3RhdGUuaWRGaWVsZF07XHJcbiAgICAgICAgICAgIGNvbnN0IGRpc2FibGUgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kaXNhYmxlRXhwcmVzcyA/IHRoaXMuZGlzYWJsZUV4cHJlc3MoZCkgOiBkW3RoaXMuX3N0YXRlLmRpc2FibGVkRmllbGRdID8gdHJ1ZTogZmFsc2U7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBpZDogX2lkLFxyXG4gICAgICAgICAgICAgICAgZGF0YTogZCxcclxuICAgICAgICAgICAgICAgIGRpc2FibGVkOiBkaXNhYmxlKCksXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHVwZGF0ZVN0YXRlKHN0YXRlOiBhbnkpIHtcclxuICAgICAgICBjb25zdCBuZXdTdGF0ZSA9IHsuLi50aGlzLl9zdGF0ZSwgLi4uc3RhdGV9O1xyXG4gICAgICAgIHRoaXMuc3RvcmUubmV4dCh0aGlzLl9zdGF0ZSA9IG5ld1N0YXRlKTtcclxuICAgIH1cclxuXHJcbiAgICBpbml0U3RhdGUoc3RhdGU6IGFueSkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlU3RhdGUoc3RhdGUpO1xyXG4gICAgfVxyXG5cclxuICAgIGlzU2VsZWN0KGlkOiBhbnkpIHtcclxuICAgICAgICBpZiAodGhpcy5fc3RhdGUuc2VsZWN0aW9ucyAmJiB0aGlzLl9zdGF0ZS5zZWxlY3Rpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fc3RhdGUuc2VsZWN0aW9ucy5maW5kKGl0ZW0gPT4gISFpdGVtID8gaXRlbVt0aGlzLl9zdGF0ZS5pZEZpZWxkXSA9PSBpZCA6IGZhbHNlKSAhPT0gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGxvYWREYXRhKGRhdGE6IGFueSwgc2VsZWN0VmFsdWVzOiBzdHJpbmcgPSAnJywgc2VwYXJhdG9yID0gJywnKSB7XHJcbiAgICAgICAgaWYgKGRhdGEpIHtcclxuICAgICAgICAgICAgY29uc3QgX2RhdGEgPSB0aGlzLmluaXREYXRhKGRhdGEpO1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHsuLi50aGlzLl9zdGF0ZSwgZGF0YTogX2RhdGF9KTtcclxuXHJcbiAgICAgICAgICAgIGlmIChzZWxlY3RWYWx1ZXMpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0U2VsZWN0aW9ucyhzZWxlY3RWYWx1ZXMsIHNlcGFyYXRvcik7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9zdGF0ZS5zZWxlY3Rpb25zID0gW107XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHsgZGF0YTogW10sIHNlbGVjdGlvbnM6IFtdIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRTZWxlY3Rpb25zKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9zdGF0ZS5zZWxlY3Rpb25zO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFNlbGVjdGlvbnMoc2VsZWN0VmFsdWVzOiBzdHJpbmcsIHNlcGFyYXRvciA9ICcsJykge1xyXG4gICAgICAgIGlmIChzZWxlY3RWYWx1ZXMpIHtcclxuICAgICAgICAgICAgbGV0IHNlbGVjdGVkSXRlbXMgPSBbXTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuX3N0YXRlLm11bHRpU2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICBzZWxlY3RlZEl0ZW1zID0gc2VsZWN0VmFsdWVzLnNwbGl0KHNlcGFyYXRvcikubWFwKCB2YWwgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9zdGF0ZS5kYXRhLmZpbmQoZCA9PiBkLmRhdGFbdGhpcy5fc3RhdGUudmFsdWVGaWVsZF0gKyAnJyA9PSB2YWwpO1xyXG4gICAgICAgICAgICAgICAgfSkubWFwKCBuID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbiA/IG4uZGF0YSA6ICcnO1xyXG4gICAgICAgICAgICAgICAgfSkuZmlsdGVyKG4gPT4gbik7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBzZWxlY3RlZEl0ZW1zID0gW3RoaXMuX3N0YXRlLmRhdGEuZmluZChkID0+IGQuZGF0YVt0aGlzLl9zdGF0ZS52YWx1ZUZpZWxkXSArICcnID09IHNlbGVjdFZhbHVlcyldO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe3NlbGVjdGlvbnM6IHNlbGVjdGVkSXRlbXMgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNlbGVjdEFsbCgpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtzZWxlY3Rpb25zOiB0aGlzLl9zdGF0ZS5kYXRhLm1hcChuID0+IG4uZGF0YSkgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgdW5TZWxlY3RBbGwoKSB7XHJcbiAgICAgICAgdGhpcy5jbGVhclNlbGVjdGlvbnMoKTtcclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3RJdGVtKGRhdGE6IGFueSwgaW5kZXg/OiBudW1iZXIpIHtcclxuICAgICAgICBjb25zdCBpZGZpZWxkID0gdGhpcy5fc3RhdGUuaWRGaWVsZDtcclxuICAgICAgICBsZXQgc2VsZWN0aW9ucyA9IHRoaXMuZ2V0U2VsZWN0aW9ucygpO1xyXG5cclxuICAgICAgICBjb25zdCBpZCA9IGRhdGFbaWRmaWVsZF07XHJcbiAgICAgICAgaWYgKCF0aGlzLl9zdGF0ZS5tdWx0aVNlbGVjdCkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuaXNTZWxlY3QoaWQpKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxlY3Rpb25zID0gWyBkYXRhIF07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuaXNTZWxlY3QoaWQpKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxlY3Rpb25zLnB1c2goZGF0YSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGl0ZW1zID0gdGhpcy5jbG9uZUFycmF5KHNlbGVjdGlvbnMpO1xyXG5cclxuICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtzZWxlY3Rpb25zOiBpdGVtc30pO1xyXG4gICAgfVxyXG5cclxuICAgIHVuU2VsZWN0SXRlbShkYXRhOiBhbnkpIHtcclxuICAgICAgICBjb25zdCBpZGZpZWxkID0gdGhpcy5fc3RhdGUuaWRGaWVsZDtcclxuICAgICAgICBsZXQgc2VsZWN0aW9ucyA9IHRoaXMuZ2V0U2VsZWN0aW9ucygpO1xyXG4gICAgICAgIGNvbnN0IGlkID0gZGF0YVtpZGZpZWxkXTtcclxuICAgICAgICBpZiAoIXRoaXMuX3N0YXRlLm11bHRpU2VsZWN0KSB7XHJcbiAgICAgICAgICAgIHNlbGVjdGlvbnMgPSBbXTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzZWxlY3Rpb25zID0gc2VsZWN0aW9ucy5maWx0ZXIobiA9PiBuW2lkZmllbGRdICE9IGlkKSA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBpdGVtcyA9IHRoaXMuY2xvbmVBcnJheShzZWxlY3Rpb25zKTtcclxuICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtzZWxlY3Rpb25zOiBpdGVtc30pO1xyXG4gICAgfVxyXG5cclxuICAgIGNsZWFyU2VsZWN0aW9ucygpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtzZWxlY3Rpb25zOiBbXX0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2xvbmVBcnJheShhcnI6IGFueVtdKSB7XHJcbiAgICAgICAgaWYgKGFyciAmJiBhcnIubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBhcnIubWFwKCBuID0+IG4pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGFycjtcclxuICAgIH1cclxufVxyXG4iXX0=