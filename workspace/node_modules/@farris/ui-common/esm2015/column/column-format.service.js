/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { NumberHelperService } from '@farris/ui-common/number';
import { DateTimeHelperService } from '@farris/ui-common/date';
import { Compare, FilterRelation, CompareOperators, SortType } from '@farris/ui-common/types';
import * as i0 from "@angular/core";
import * as i1 from "@farris/ui-common/date";
import * as i2 from "@farris/ui-common/number";
/*
 * @Author: 疯狂秀才(Lucas Huang)
 * @Date: 2019-01-02 14:12:47
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-10-18 13:59:34
 * @Company: Inspur
 * @Version: v0.0.1
 */
export class ColumnFormatService {
    /**
     * @param {?} datehelper
     * @param {?} numberhelper
     */
    constructor(datehelper, numberhelper) {
        this.datehelper = datehelper;
        this.numberhelper = numberhelper;
    }
    /**
     * @param {?} value
     * @param {?=} data
     * @param {?=} formatter
     * @param {?=} context
     * @return {?}
     */
    format(value, data, formatter, context) {
        if (formatter) {
            if (typeof (formatter) === 'function') {
                context = context || {};
                return formatter(value, data, Object.assign({ date: this.datehelper, number: this.numberhelper, format: this }, context));
            }
            else {
                if (formatter['type']) {
                    /** @type {?} */
                    const fmt = (/** @type {?} */ (formatter));
                    switch (fmt.type) {
                        case 'datetime':
                            return this.dateTimeFormat(value, fmt.options);
                        case 'timeago':
                            const { locale } = fmt.options;
                            return this.datehelper.relativeTime(value, locale || 'zh-CHS');
                        case 'number':
                            return this.numberFormat(value, fmt.options);
                        case 'enum':
                            return this.enumFormat(value, fmt.options);
                        case 'image':
                            return this.imageFormat(value, fmt.options);
                        case 'boolean':
                        case 'boolean2':
                            return this.booleanFormat(value, fmt.options);
                        default:
                            return value;
                    }
                }
            }
        }
        return value;
    }
    /**
     * @private
     * @param {?} value
     * @param {?} opts
     * @return {?}
     */
    dateTimeFormat(value, opts) {
        if (value) {
            /** @type {?} */
            let fmt = 'yyyy-MM-dd';
            if (typeof (opts) === 'string') {
                fmt = opts;
            }
            else if (typeof (opts) === 'object') {
                fmt = opts.format || 'yyyy-MM-dd';
            }
            fmt = fmt.replace('YYYY', 'yyyy').replace('-DD', '-dd');
            if (typeof (opts) === 'object' && opts.dateRange) {
                /** @type {?} */
                const splitStr = opts.dateRangeDatesDelimiter || '~';
                let [beginDate, endDate] = value.split(splitStr);
                beginDate = this.datehelper.formatTo(beginDate, fmt);
                endDate = this.datehelper.formatTo(endDate, fmt);
                return beginDate + splitStr + endDate;
            }
            return this.datehelper.formatTo(value, fmt);
        }
        return value;
    }
    /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    numberFormat(value, opts) {
        return this.numberhelper.formatNumber(value, opts);
        // if (value !== undefined && value !== '' && value !== NaN) {
        //     return this.numberhelper.formatMoney(value, opts);
        // }
        // return value;
    }
    /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    enumFormat(value, opts) {
        if (value === undefined || value === null) {
            value = '';
        }
        if (opts && opts.data && opts.data.length) {
            /** @type {?} */
            const val = value.toString();
            /** @type {?} */
            let arr = [val];
            if (val.indexOf(',') > -1) { // 多选
                arr = val.split(',');
            }
            /** @type {?} */
            const str = [];
            arr.forEach((/**
             * @param {?} v
             * @return {?}
             */
            v => {
                /** @type {?} */
                const n = opts.data.find((/**
                 * @param {?} item
                 * @return {?}
                 */
                item => item[opts.valueField].toString() == v));
                if (n) {
                    str.push(n[opts.textField]);
                }
            }));
            if (str.length) {
                return str.join(',');
            }
            return value;
        }
        return value;
    }
    /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    imageFormat(value, opts) {
        if (value) {
            if (opts) {
                /** @type {?} */
                const arrStr = [`<img src="${value}" `];
                if (opts.width) {
                    arrStr.push(`width="${opts.width}"`);
                }
                if (opts.height) {
                    arrStr.push(`height="${opts.height}"`);
                }
                arrStr.push('>');
                return arrStr.join('');
            }
            else {
                return `<img src="${value}">`;
            }
        }
        return value;
    }
    /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    booleanFormat(value, opts) {
        if (value !== undefined) {
            if (opts) {
                /** @type {?} */
                const val = value ? opts.trueText : opts.falseText;
                if (val === null || val === undefined) {
                    return value;
                }
                return val;
            }
            else {
                return value;
            }
        }
        return '';
    }
    /**
     * @private
     * @param {?} val
     * @return {?}
     */
    convertCompare(val) {
        /** @type {?} */
        const op = CompareOperators.find((/**
         * @param {?} item
         * @return {?}
         */
        (item) => item.value === val));
        if (op) {
            return op.label;
        }
    }
    /**
     * @param {?} sorts
     * @return {?}
     */
    buildSortString(sorts) {
        if (sorts && sorts.length) {
            /** @type {?} */
            let str = sorts.map((/**
             * @param {?} s
             * @return {?}
             */
            s => {
                return `${s.sortField} ${SortType[s.sortType].toString().toLowerCase()},`;
            })).join(' ');
            if (str) {
                str = str.substr(0, str.length - 1);
            }
            return str;
        }
        return '';
    }
    /**
     * @param {?} conditions
     * @return {?}
     */
    buildSqlWhere(conditions) {
        if (conditions && conditions.length) {
            /** @type {?} */
            const result = [];
            /** @type {?} */
            const conditionList = conditions.filter((/**
             * @param {?} c
             * @return {?}
             */
            c => c.filterField !== ''));
            conditionList.forEach((/**
             * @param {?} condition
             * @param {?} index
             * @return {?}
             */
            (condition, index) => {
                if (!condition.filterField) {
                    return;
                }
                result.push(condition.lbracket);
                result.push(condition.filterField);
                /** @type {?} */
                const opCode = parseInt(condition.compare.toString(), 10);
                /** @type {?} */
                const op = this.convertCompare(opCode);
                result.push(' ' + op.replace(/\%/g, '').replace('...', ''));
                if (opCode === Compare.Like || opCode === Compare.NotLike
                    || opCode === Compare.NotLikeEndWith
                    || opCode === Compare.LikeEndWith) {
                    result.push('\'');
                    result.push('%');
                }
                else {
                    result.push(' ');
                    result.push('\'');
                }
                if (opCode === Compare.In || opCode === Compare.NotIn) {
                    result.push(condition.value.replace(/\r\n/g, ','));
                }
                else {
                    result.push(condition.value);
                }
                if (opCode === Compare.Like || opCode === Compare.NotLike
                    || opCode === Compare.LikeStartWith || opCode === Compare.NotLikeStartWith) {
                    result.push('%');
                }
                result.push('\'');
                result.push(condition.rbracket);
                result.push(' ');
                if (index !== conditionList.length - 1) {
                    result.push(condition.relation === FilterRelation.Empty ? '' :
                        FilterRelation[condition.relation].toString().toLowerCase());
                    result.push(' ');
                }
            }));
            return result.join('');
        }
        return '';
    }
}
ColumnFormatService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
ColumnFormatService.ctorParameters = () => [
    { type: DateTimeHelperService },
    { type: NumberHelperService }
];
/** @nocollapse */ ColumnFormatService.ngInjectableDef = i0.defineInjectable({ factory: function ColumnFormatService_Factory() { return new ColumnFormatService(i0.inject(i1.DateTimeHelperService), i0.inject(i2.NumberHelperService)); }, token: ColumnFormatService, providedIn: "root" });
if (false) {
    /** @type {?} */
    ColumnFormatService.prototype.datehelper;
    /** @type {?} */
    ColumnFormatService.prototype.numberhelper;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sdW1uLWZvcm1hdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1jb21tb24vY29sdW1uLyIsInNvdXJjZXMiOlsiY29sdW1uLWZvcm1hdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFzQixNQUFNLGVBQWUsQ0FBQztBQUMvRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUMvRCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUUvRCxPQUFPLEVBQW1CLE9BQU8sRUFBRSxjQUFjLEVBQUUsZ0JBQWdCLEVBQWlCLFFBQVEsRUFBRSxNQUFNLHlCQUF5QixDQUFDOzs7Ozs7Ozs7Ozs7QUFZOUgsTUFBTSxPQUFPLG1CQUFtQjs7Ozs7SUFDNUIsWUFBbUIsVUFBaUMsRUFBUyxZQUFpQztRQUEzRSxlQUFVLEdBQVYsVUFBVSxDQUF1QjtRQUFTLGlCQUFZLEdBQVosWUFBWSxDQUFxQjtJQUM5RixDQUFDOzs7Ozs7OztJQUVELE1BQU0sQ0FBQyxLQUFVLEVBQUUsSUFBVSxFQUFFLFNBQXlCLEVBQUUsT0FBYTtRQUNuRSxJQUFJLFNBQVMsRUFBRTtZQUNYLElBQUksT0FBTSxDQUFDLFNBQVMsQ0FBQyxLQUFLLFVBQVUsRUFBRTtnQkFDbEMsT0FBTyxHQUFHLE9BQU8sSUFBSSxFQUFFLENBQUM7Z0JBQ3hCLE9BQU8sU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLGtCQUFJLElBQUksRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLE1BQU0sRUFBRSxJQUFJLElBQUssT0FBTyxFQUFHLENBQUM7YUFDakg7aUJBQU07Z0JBQ0gsSUFBSSxTQUFTLENBQUMsTUFBTSxDQUFDLEVBQUU7OzBCQUNiLEdBQUcsR0FBRyxtQkFBQSxTQUFTLEVBQW1CO29CQUN4QyxRQUFRLEdBQUcsQ0FB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LFFBQVEsQ0FBQyxDQUFDO2dCQUNoQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUVqQixJQUFJLEtBQUssS0FBSyxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtvQkFDcEMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxLQUFLLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO3dCQUM5QixjQUFjLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7b0JBQzdGLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ3BCO1lBQ0wsQ0FBQyxFQUFDLENBQUM7WUFFSCxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDMUI7UUFFRCxPQUFPLEVBQUUsQ0FBQztJQUNkLENBQUM7OztZQXZOSixVQUFVLFNBQUM7Z0JBQ1IsVUFBVSxFQUFFLE1BQU07YUFDckI7Ozs7WUFiUSxxQkFBcUI7WUFEckIsbUJBQW1COzs7OztJQWdCWix5Q0FBd0M7O0lBQUUsMkNBQXdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE51bWJlckhlbHBlclNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbi9udW1iZXInO1xyXG5pbXBvcnQgeyBEYXRlVGltZUhlbHBlclNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbi9kYXRlJztcclxuaW1wb3J0IHsgQ29sdW1uRm9ybWF0dGVyLCBOdW1iZXJGb3JtYXRPcHRpb25zLCBFbnVtRm9ybWF0T3B0aW9ucywgSW1hZ2VGb3JtYXRPcHRpb25zLCBCb29sZWFuRm9ybWF0T3B0aW9ucywgRGF0YUZvcm1hdHRlciB9IGZyb20gJy4vY29sdW1uLWZvcm1hdC5vcHRpb25zJztcclxuaW1wb3J0IHsgRmlsdGVyQ29uZGl0aW9uLCBDb21wYXJlLCBGaWx0ZXJSZWxhdGlvbiwgQ29tcGFyZU9wZXJhdG9ycywgU29ydENvbmRpdGlvbiwgU29ydFR5cGUgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbi90eXBlcyc7XHJcbi8qXHJcbiAqIEBBdXRob3I6IOeWr+eLguengOaJjShMdWNhcyBIdWFuZylcclxuICogQERhdGU6IDIwMTktMDEtMDIgMTQ6MTI6NDdcclxuICogQExhc3RFZGl0b3JzOiDnlq/ni4Lnp4DmiY0oTHVjYXMgSHVhbmcpXHJcbiAqIEBMYXN0RWRpdFRpbWU6IDIwMTktMTAtMTggMTM6NTk6MzRcclxuICogQENvbXBhbnk6IEluc3B1clxyXG4gKiBAVmVyc2lvbjogdjAuMC4xXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIENvbHVtbkZvcm1hdFNlcnZpY2Uge1xyXG4gICAgY29uc3RydWN0b3IocHVibGljIGRhdGVoZWxwZXI6IERhdGVUaW1lSGVscGVyU2VydmljZSwgcHVibGljIG51bWJlcmhlbHBlcjogTnVtYmVySGVscGVyU2VydmljZSkge1xyXG4gICAgfVxyXG5cclxuICAgIGZvcm1hdCh2YWx1ZTogYW55LCBkYXRhPzogYW55LCBmb3JtYXR0ZXI/OiBEYXRhRm9ybWF0dGVyLCBjb250ZXh0PzogYW55KSB7XHJcbiAgICAgICAgaWYgKGZvcm1hdHRlcikge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mKGZvcm1hdHRlcikgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRleHQgPSBjb250ZXh0IHx8IHt9O1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZvcm1hdHRlcih2YWx1ZSwgZGF0YSwgeyBkYXRlOiB0aGlzLmRhdGVoZWxwZXIsIG51bWJlcjogdGhpcy5udW1iZXJoZWxwZXIsIGZvcm1hdDogdGhpcywgLi4uY29udGV4dCB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChmb3JtYXR0ZXJbJ3R5cGUnXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZtdCA9IGZvcm1hdHRlciBhcyBDb2x1bW5Gb3JtYXR0ZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChmbXQudHlwZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdkYXRldGltZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRlVGltZUZvcm1hdCh2YWx1ZSwgZm10Lm9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd0aW1lYWdvJzogXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB7bG9jYWxlfSA9IGZtdC5vcHRpb25zO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0ZWhlbHBlci5yZWxhdGl2ZVRpbWUodmFsdWUsIGxvY2FsZSB8fCAnemgtQ0hTJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5udW1iZXJGb3JtYXQodmFsdWUsIGZtdC5vcHRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZW51bSc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbnVtRm9ybWF0KHZhbHVlLCBmbXQub3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ltYWdlJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmltYWdlRm9ybWF0KHZhbHVlLCBmbXQub3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2Jvb2xlYW4nOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdib29sZWFuMic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ib29sZWFuRm9ybWF0KHZhbHVlLCBmbXQub3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGRhdGVUaW1lRm9ybWF0KHZhbHVlOiBhbnksIG9wdHM6IGFueSkge1xyXG4gICAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgICAgICBsZXQgZm10ID0gJ3l5eXktTU0tZGQnO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mKG9wdHMpID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICAgICAgZm10ID0gb3B0cztcclxuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Yob3B0cykgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgICAgICBmbXQgPSBvcHRzLmZvcm1hdCB8fCAneXl5eS1NTS1kZCc7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGZtdCA9IGZtdC5yZXBsYWNlKCdZWVlZJywgJ3l5eXknKS5yZXBsYWNlKCctREQnLCAnLWRkJyk7XHJcblxyXG4gICAgICAgICAgICBpZiAodHlwZW9mKG9wdHMpID09PSAnb2JqZWN0JyAmJiBvcHRzLmRhdGVSYW5nZSkge1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHNwbGl0U3RyID0gb3B0cy5kYXRlUmFuZ2VEYXRlc0RlbGltaXRlciB8fCAnfic7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IFtiZWdpbkRhdGUsIGVuZERhdGUgXSA9IHZhbHVlLnNwbGl0KHNwbGl0U3RyKTtcclxuICAgICAgICAgICAgICAgIGJlZ2luRGF0ZSA9IHRoaXMuZGF0ZWhlbHBlci5mb3JtYXRUbyhiZWdpbkRhdGUsIGZtdCk7XHJcbiAgICAgICAgICAgICAgICBlbmREYXRlID0gdGhpcy5kYXRlaGVscGVyLmZvcm1hdFRvKGVuZERhdGUsIGZtdCk7XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGJlZ2luRGF0ZSArIHNwbGl0U3RyICsgIGVuZERhdGU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmRhdGVoZWxwZXIuZm9ybWF0VG8odmFsdWUsIGZtdCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBudW1iZXJGb3JtYXQodmFsdWU6IGFueSwgb3B0cz86IE51bWJlckZvcm1hdE9wdGlvbnMpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5udW1iZXJoZWxwZXIuZm9ybWF0TnVtYmVyKHZhbHVlLCBvcHRzKTtcclxuICAgICAgICAvLyBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gJycgJiYgdmFsdWUgIT09IE5hTikge1xyXG4gICAgICAgIC8vICAgICByZXR1cm4gdGhpcy5udW1iZXJoZWxwZXIuZm9ybWF0TW9uZXkodmFsdWUsIG9wdHMpO1xyXG4gICAgICAgIC8vIH1cclxuICAgICAgICAvLyByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBlbnVtRm9ybWF0KHZhbHVlOiBhbnksIG9wdHM/OiBFbnVtRm9ybWF0T3B0aW9ucykge1xyXG4gICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsICkge1xyXG4gICAgICAgICAgICB2YWx1ZSA9ICcnO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKG9wdHMgJiYgb3B0cy5kYXRhICYmIG9wdHMuZGF0YS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgY29uc3QgdmFsID0gdmFsdWUudG9TdHJpbmcoKTtcclxuICAgICAgICAgICAgbGV0IGFyciA9IFt2YWxdO1xyXG4gICAgICAgICAgICBpZiAodmFsLmluZGV4T2YoJywnKSA+IC0xKSB7ICAvLyDlpJrpgIlcclxuICAgICAgICAgICAgICAgIGFyciA9IHZhbC5zcGxpdCgnLCcpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBzdHIgPSBbXTtcclxuICAgICAgICAgICAgYXJyLmZvckVhY2godiA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBuID0gb3B0cy5kYXRhLmZpbmQoaXRlbSA9PiBpdGVtW29wdHMudmFsdWVGaWVsZF0udG9TdHJpbmcoKSA9PSB2KTtcclxuICAgICAgICAgICAgICAgIGlmIChuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3RyLnB1c2gobltvcHRzLnRleHRGaWVsZF0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGlmIChzdHIubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RyLmpvaW4oJywnKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbWFnZUZvcm1hdCh2YWx1ZSwgb3B0cz86IEltYWdlRm9ybWF0T3B0aW9ucykge1xyXG4gICAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgICAgICBpZiAob3B0cykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYXJyU3RyID0gWyBgPGltZyBzcmM9XCIke3ZhbHVlfVwiIGBdO1xyXG4gICAgICAgICAgICAgICAgaWYgKG9wdHMud2lkdGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBhcnJTdHIucHVzaChgd2lkdGg9XCIke29wdHMud2lkdGh9XCJgKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChvcHRzLmhlaWdodCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFyclN0ci5wdXNoKGBoZWlnaHQ9XCIke29wdHMuaGVpZ2h0fVwiYCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgYXJyU3RyLnB1c2goJz4nKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhcnJTdHIuam9pbignJyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYDxpbWcgc3JjPVwiJHt2YWx1ZX1cIj5gO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBib29sZWFuRm9ybWF0KHZhbHVlLCBvcHRzPzogQm9vbGVhbkZvcm1hdE9wdGlvbnMpIHtcclxuICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBpZiAob3B0cykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdmFsID0gdmFsdWUgPyBvcHRzLnRydWVUZXh0IDogb3B0cy5mYWxzZVRleHQ7XHJcbiAgICAgICAgICAgICAgICBpZiAodmFsID09PSBudWxsIHx8IHZhbCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWw7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIGNvbnZlcnRDb21wYXJlKHZhbDogbnVtYmVyKSB7XHJcbiAgICAgICAgY29uc3Qgb3AgPSBDb21wYXJlT3BlcmF0b3JzLmZpbmQoIChpdGVtOiBhbnkpID0+IGl0ZW0udmFsdWUgPT09IHZhbCk7XHJcbiAgICAgICAgaWYgKG9wKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBvcC5sYWJlbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgYnVpbGRTb3J0U3RyaW5nKHNvcnRzOiBTb3J0Q29uZGl0aW9uW10pOiBzdHJpbmcge1xyXG4gICAgICAgIGlmIChzb3J0cyAmJiBzb3J0cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgbGV0IHN0ciA9IHNvcnRzLm1hcChzID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBgJHtzLnNvcnRGaWVsZH0gJHtTb3J0VHlwZVtzLnNvcnRUeXBlXS50b1N0cmluZygpLnRvTG93ZXJDYXNlKCl9LGA7XHJcbiAgICAgICAgICAgIH0pLmpvaW4oJyAnKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChzdHIpIHtcclxuICAgICAgICAgICAgICAgIHN0ciA9IHN0ci5zdWJzdHIoMCwgc3RyLmxlbmd0aCAtIDEpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gc3RyO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG5cclxuICAgIGJ1aWxkU3FsV2hlcmUoY29uZGl0aW9uczogRmlsdGVyQ29uZGl0aW9uW10pOiBzdHJpbmcge1xyXG4gICAgICAgIGlmIChjb25kaXRpb25zICYmIGNvbmRpdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xyXG4gICAgICAgICAgICBjb25zdCBjb25kaXRpb25MaXN0ID0gY29uZGl0aW9ucy5maWx0ZXIoYyA9PiBjLmZpbHRlckZpZWxkICE9PSAnJyk7XHJcbiAgICAgICAgICAgIGNvbmRpdGlvbkxpc3QuZm9yRWFjaCgoY29uZGl0aW9uLCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFjb25kaXRpb24uZmlsdGVyRmllbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChjb25kaXRpb24ubGJyYWNrZXQpO1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goY29uZGl0aW9uLmZpbHRlckZpZWxkKTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBvcENvZGUgPSBwYXJzZUludChjb25kaXRpb24uY29tcGFyZS50b1N0cmluZygpLCAxMCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBvcCA9IHRoaXMuY29udmVydENvbXBhcmUob3BDb2RlKTtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKCcgJyArIG9wLnJlcGxhY2UoL1xcJS9nLCAnJykucmVwbGFjZSgnLi4uJywgJycpKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAob3BDb2RlID09PSBDb21wYXJlLkxpa2UgfHwgb3BDb2RlID09PSBDb21wYXJlLk5vdExpa2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgb3BDb2RlID09PSBDb21wYXJlLk5vdExpa2VFbmRXaXRoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IG9wQ29kZSA9PT0gQ29tcGFyZS5MaWtlRW5kV2l0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKCdcXCcnKTtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnJScpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnICcpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKCdcXCcnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAob3BDb2RlID09PSBDb21wYXJlLkluIHx8IG9wQ29kZSA9PT0gQ29tcGFyZS5Ob3RJbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGNvbmRpdGlvbi52YWx1ZS5yZXBsYWNlKC9cXHJcXG4vZywgJywnKSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGNvbmRpdGlvbi52YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKG9wQ29kZSA9PT0gQ29tcGFyZS5MaWtlIHx8IG9wQ29kZSA9PT0gQ29tcGFyZS5Ob3RMaWtlXHJcbiAgICAgICAgICAgICAgICAgICAgfHwgb3BDb2RlID09PSBDb21wYXJlLkxpa2VTdGFydFdpdGggfHwgb3BDb2RlID09PSBDb21wYXJlLk5vdExpa2VTdGFydFdpdGgpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnJScpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJ1xcJycpO1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goY29uZGl0aW9uLnJicmFja2V0KTtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKCcgJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ICE9PSBjb25kaXRpb25MaXN0Lmxlbmd0aCAtIDEpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChjb25kaXRpb24ucmVsYXRpb24gPT09IEZpbHRlclJlbGF0aW9uLkVtcHR5ID8gJycgOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRmlsdGVyUmVsYXRpb25bY29uZGl0aW9uLnJlbGF0aW9uXS50b1N0cmluZygpLnRvTG93ZXJDYXNlKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKCcgJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5qb2luKCcnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxufVxyXG4iXX0=