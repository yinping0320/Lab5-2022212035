/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import DefaultOptions from './DefaultOptions';
import { DisplaySize } from './modules/DisplaySize';
import { Toolbar } from './modules/Toolbar';
import { Resize } from './modules/Resize';
import Quill from 'quill';
/** @type {?} */
const knownModules = { DisplaySize, Toolbar, Resize };
/**
 * Custom module for quilljs to allow user to resize <img> elements
 * (Works on Chrome, Edge, Safari and replaces Firefox's native resize behavior)
 * @see https://quilljs.com/blog/building-a-custom-module/
 */
export class ImageResize {
    /**
     * @param {?} quill
     * @param {?=} options
     */
    constructor(quill, options = {}) {
        this.initializeModules = (/**
         * @return {?}
         */
        () => {
            this.removeModules();
            this.modules = this.moduleClasses.map((/**
             * @param {?} ModuleClass
             * @return {?}
             */
            ModuleClass => new (knownModules[ModuleClass] || ModuleClass)(this)));
            this.modules.forEach((/**
             * @param {?} module
             * @return {?}
             */
            module => {
                module.onCreate();
            }));
            this.onUpdate();
        });
        this.onUpdate = (/**
         * @return {?}
         */
        () => {
            this.repositionElements();
            this.modules.forEach((/**
             * @param {?} module
             * @return {?}
             */
            module => {
                module.onUpdate();
            }));
        });
        this.removeModules = (/**
         * @return {?}
         */
        () => {
            this.modules.forEach((/**
             * @param {?} module
             * @return {?}
             */
            module => {
                module.onDestroy();
            }));
            this.modules = [];
        });
        this.handleClick = (/**
         * @param {?} evt
         * @return {?}
         */
        evt => {
            if (evt.target &&
                evt.target.tagName &&
                evt.target.tagName.toUpperCase() === 'IMG') {
                if (this.img === evt.target) {
                    // we are already focused on this image
                    return;
                }
                if (this.img) {
                    // we were just focused on another image
                    this.hide();
                }
                // clicked on an image inside the editor
                this.show(evt.target);
            }
            else if (this.img) {
                // clicked on a non image
                this.hide();
            }
        });
        this.show = (/**
         * @param {?} img
         * @return {?}
         */
        img => {
            if (!this.quill.isEnabled()) {
                return;
            }
            // keep track of this img element
            this.img = img;
            this.showOverlay();
            this.initializeModules();
        });
        this.showOverlay = (/**
         * @return {?}
         */
        () => {
            if (this.overlay) {
                this.hideOverlay();
            }
            this.quill.setSelection(null);
            // prevent spurious text selection
            this.setUserSelect('none');
            // listen for the image being deleted or moved
            document.addEventListener('keyup', this.checkImage, true);
            this.quill.root.addEventListener('input', this.checkImage, true);
            // Create and add the overlay
            this.overlay = document.createElement('div');
            Object.assign(this.overlay.style, this.options.overlayStyles);
            this.quill.root.parentNode.appendChild(this.overlay);
            this.repositionElements();
        });
        this.hideOverlay = (/**
         * @return {?}
         */
        () => {
            if (!this.overlay) {
                return;
            }
            // Remove the overlay
            this.quill.root.parentNode.removeChild(this.overlay);
            this.overlay = undefined;
            // stop listening for image deletion or movement
            document.removeEventListener('keyup', this.checkImage);
            this.quill.root.removeEventListener('input', this.checkImage);
            // reset user-select
            this.setUserSelect('');
        });
        this.repositionElements = (/**
         * @return {?}
         */
        () => {
            if (!this.overlay || !this.img) {
                return;
            }
            // position the overlay over the image
            /** @type {?} */
            const parent = this.quill.root.parentNode;
            /** @type {?} */
            const imgRect = this.img.getBoundingClientRect();
            /** @type {?} */
            const containerRect = parent.getBoundingClientRect();
            Object.assign(this.overlay.style, {
                left: `${imgRect.left -
                    containerRect.left +
                    parent.scrollLeft -
                    2}px`,
                top: `${imgRect.top - containerRect.top + parent.scrollTop - 2}px`,
                width: `${imgRect.width + 2}px`,
                height: `${imgRect.height + 2}px`
            });
        });
        this.hide = (/**
         * @return {?}
         */
        () => {
            this.hideOverlay();
            this.removeModules();
            this.img = undefined;
        });
        this.setUserSelect = (/**
         * @param {?} value
         * @return {?}
         */
        value => {
            [
                'userSelect',
                'mozUserSelect',
                'webkitUserSelect',
                'msUserSelect'
            ].forEach((/**
             * @param {?} prop
             * @return {?}
             */
            prop => {
                // set on contenteditable element and <html>
                this.quill.root.style[prop] = value;
                document.documentElement.style[prop] = value;
            }));
        });
        this.checkImage = (/**
         * @param {?} evt
         * @return {?}
         */
        evt => {
            if (this.img) {
                if (evt.keyCode == 46 || evt.keyCode == 8) {
                    Quill.find(this.img).deleteAt(0);
                }
                this.hide();
            }
        });
        // save the quill reference and options
        this.quill = quill;
        // Apply the options to our defaults, and stash them for later
        // defaultsDeep doesn't do arrays as you'd expect, so we'll need to apply the classes array from options separately
        /** @type {?} */
        let moduleClasses = false;
        // tslint:disable-next-line:object-literal-key-quotes
        if (options['modules']) {
            moduleClasses = options['modules'].slice();
        }
        // Apply options to default options
        //this.options = defaultsDeep({}, options, DefaultOptions);
        this.options = Object.assign({}, options, DefaultOptions);
        // (see above about moduleClasses)
        if (moduleClasses !== false) {
            this.options.modules = moduleClasses;
        }
        // disable native image resizing on firefox
        document.execCommand('enableObjectResizing', false, 'false');
        // respond to clicks inside the editor
        this.quill.root.addEventListener('click', this.handleClick, false);
        this.quill.root.parentNode.style.position =
            this.quill.root.parentNode.style.position || 'relative';
        // setup modules
        this.moduleClasses = this.options.modules;
        //console.log('this.options.modules', this.options.modules)
        this.modules = [];
    }
}
if (false) {
    /** @type {?} */
    ImageResize.prototype.quill;
    /** @type {?} */
    ImageResize.prototype.options;
    /** @type {?} */
    ImageResize.prototype.moduleClasses;
    /** @type {?} */
    ImageResize.prototype.modules;
    /** @type {?} */
    ImageResize.prototype.img;
    /** @type {?} */
    ImageResize.prototype.overlay;
    /** @type {?} */
    ImageResize.prototype.initializeModules;
    /** @type {?} */
    ImageResize.prototype.onUpdate;
    /** @type {?} */
    ImageResize.prototype.removeModules;
    /** @type {?} */
    ImageResize.prototype.handleClick;
    /** @type {?} */
    ImageResize.prototype.show;
    /** @type {?} */
    ImageResize.prototype.showOverlay;
    /** @type {?} */
    ImageResize.prototype.hideOverlay;
    /** @type {?} */
    ImageResize.prototype.repositionElements;
    /** @type {?} */
    ImageResize.prototype.hide;
    /** @type {?} */
    ImageResize.prototype.setUserSelect;
    /** @type {?} */
    ImageResize.prototype.checkImage;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW1hZ2VSZXNpemUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWh0bWwtZWRpdG9yLyIsInNvdXJjZXMiOlsibGliL2ltYWdlLXJlc2l6ZS1tb2R1bGUvSW1hZ2VSZXNpemUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLE9BQU8sY0FBYyxNQUFNLGtCQUFrQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDNUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzFDLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQzs7TUFDcEIsWUFBWSxHQUFHLEVBQUUsV0FBVyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUU7Ozs7OztBQU9yRCxNQUFNLE9BQU8sV0FBVzs7Ozs7SUFPcEIsWUFBWSxLQUFLLEVBQUUsT0FBTyxHQUFHLEVBQUU7UUFvQy9CLHNCQUFpQjs7O1FBQUcsR0FBRyxFQUFFO1lBQ3JCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUVyQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRzs7OztZQUNqQyxXQUFXLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLElBQUksV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQ3RFLENBQUM7WUFFRixJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU87Ozs7WUFBQyxNQUFNLENBQUMsRUFBRTtnQkFDMUIsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ3RCLENBQUMsRUFBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3BCLENBQUMsRUFBQztRQUVGLGFBQVE7OztRQUFHLEdBQUcsRUFBRTtZQUNaLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1lBQzFC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OztJQUVGLG9DQVdFOztJQUVGLGlDQU9FIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCBEZWZhdWx0T3B0aW9ucyBmcm9tICcuL0RlZmF1bHRPcHRpb25zJztcclxuaW1wb3J0IHsgRGlzcGxheVNpemUgfSBmcm9tICcuL21vZHVsZXMvRGlzcGxheVNpemUnO1xyXG5pbXBvcnQgeyBUb29sYmFyIH0gZnJvbSAnLi9tb2R1bGVzL1Rvb2xiYXInO1xyXG5pbXBvcnQgeyBSZXNpemUgfSBmcm9tICcuL21vZHVsZXMvUmVzaXplJztcclxuaW1wb3J0IFF1aWxsIGZyb20gJ3F1aWxsJztcclxuY29uc3Qga25vd25Nb2R1bGVzID0geyBEaXNwbGF5U2l6ZSwgVG9vbGJhciwgUmVzaXplIH07XHJcblxyXG4vKipcclxuICogQ3VzdG9tIG1vZHVsZSBmb3IgcXVpbGxqcyB0byBhbGxvdyB1c2VyIHRvIHJlc2l6ZSA8aW1nPiBlbGVtZW50c1xyXG4gKiAoV29ya3Mgb24gQ2hyb21lLCBFZGdlLCBTYWZhcmkgYW5kIHJlcGxhY2VzIEZpcmVmb3gncyBuYXRpdmUgcmVzaXplIGJlaGF2aW9yKVxyXG4gKiBAc2VlIGh0dHBzOi8vcXVpbGxqcy5jb20vYmxvZy9idWlsZGluZy1hLWN1c3RvbS1tb2R1bGUvXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgSW1hZ2VSZXNpemUge1xyXG4gICAgcXVpbGw6IGFueTtcclxuICAgIG9wdGlvbnM6IGFueTtcclxuICAgIG1vZHVsZUNsYXNzZXM6IGFueTtcclxuICAgIG1vZHVsZXM6IGFueTtcclxuICAgIGltZzogYW55O1xyXG4gICAgb3ZlcmxheTogYW55O1xyXG4gICAgY29uc3RydWN0b3IocXVpbGwsIG9wdGlvbnMgPSB7fSkge1xyXG4gICAgICAgIC8vIHNhdmUgdGhlIHF1aWxsIHJlZmVyZW5jZSBhbmQgb3B0aW9uc1xyXG4gICAgICAgIHRoaXMucXVpbGwgPSBxdWlsbDtcclxuICAgICAgICAvLyBBcHBseSB0aGUgb3B0aW9ucyB0byBvdXIgZGVmYXVsdHMsIGFuZCBzdGFzaCB0aGVtIGZvciBsYXRlclxyXG4gICAgICAgIC8vIGRlZmF1bHRzRGVlcCBkb2Vzbid0IGRvIGFycmF5cyBhcyB5b3UnZCBleHBlY3QsIHNvIHdlJ2xsIG5lZWQgdG8gYXBwbHkgdGhlIGNsYXNzZXMgYXJyYXkgZnJvbSBvcHRpb25zIHNlcGFyYXRlbHlcclxuICAgICAgICBsZXQgbW9kdWxlQ2xhc3NlcyA9IGZhbHNlO1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpvYmplY3QtbGl0ZXJhbC1rZXktcXVvdGVzXHJcbiAgICAgICAgaWYgKG9wdGlvbnNbJ21vZHVsZXMnXSkge1xyXG4gICAgICAgICAgICBtb2R1bGVDbGFzc2VzID0gb3B0aW9uc1snbW9kdWxlcyddLnNsaWNlKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBBcHBseSBvcHRpb25zIHRvIGRlZmF1bHQgb3B0aW9uc1xyXG4gICAgICAgIC8vdGhpcy5vcHRpb25zID0gZGVmYXVsdHNEZWVwKHt9LCBvcHRpb25zLCBEZWZhdWx0T3B0aW9ucyk7XHJcbiAgICAgICAgdGhpcy5vcHRpb25zID1PYmplY3QuYXNzaWduKHt9LCBvcHRpb25zLCBEZWZhdWx0T3B0aW9ucyk7XHJcblxyXG4gICAgICAgIC8vIChzZWUgYWJvdmUgYWJvdXQgbW9kdWxlQ2xhc3NlcylcclxuICAgICAgICBpZiAobW9kdWxlQ2xhc3NlcyAhPT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zLm1vZHVsZXMgPSBtb2R1bGVDbGFzc2VzO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gZGlzYWJsZSBuYXRpdmUgaW1hZ2UgcmVzaXppbmcgb24gZmlyZWZveFxyXG4gICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCdlbmFibGVPYmplY3RSZXNpemluZycsIGZhbHNlLCAnZmFsc2UnKTtcclxuXHJcbiAgICAgICAgLy8gcmVzcG9uZCB0byBjbGlja3MgaW5zaWRlIHRoZSBlZGl0b3JcclxuICAgICAgICB0aGlzLnF1aWxsLnJvb3QuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLmhhbmRsZUNsaWNrLCBmYWxzZSk7XHJcblxyXG4gICAgICAgIHRoaXMucXVpbGwucm9vdC5wYXJlbnROb2RlLnN0eWxlLnBvc2l0aW9uID1cclxuICAgICAgICAgICAgdGhpcy5xdWlsbC5yb290LnBhcmVudE5vZGUuc3R5bGUucG9zaXRpb24gfHwgJ3JlbGF0aXZlJztcclxuXHJcbiAgICAgICAgLy8gc2V0dXAgbW9kdWxlc1xyXG4gICAgICAgIHRoaXMubW9kdWxlQ2xhc3NlcyA9IHRoaXMub3B0aW9ucy5tb2R1bGVzO1xyXG4gICAgICAgIC8vY29uc29sZS5sb2coJ3RoaXMub3B0aW9ucy5tb2R1bGVzJywgdGhpcy5vcHRpb25zLm1vZHVsZXMpXHJcblxyXG4gICAgICAgIHRoaXMubW9kdWxlcyA9IFtdO1xyXG4gICAgfVxyXG5cclxuICAgIGluaXRpYWxpemVNb2R1bGVzID0gKCkgPT4ge1xyXG4gICAgICAgIHRoaXMucmVtb3ZlTW9kdWxlcygpO1xyXG5cclxuICAgICAgICB0aGlzLm1vZHVsZXMgPSB0aGlzLm1vZHVsZUNsYXNzZXMubWFwKFxyXG4gICAgICAgICAgICBNb2R1bGVDbGFzcyA9PiBuZXcgKGtub3duTW9kdWxlc1tNb2R1bGVDbGFzc10gfHwgTW9kdWxlQ2xhc3MpKHRoaXMpXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgdGhpcy5tb2R1bGVzLmZvckVhY2gobW9kdWxlID0+IHtcclxuICAgICAgICAgICAgbW9kdWxlLm9uQ3JlYXRlKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMub25VcGRhdGUoKTtcclxuICAgIH07XHJcblxyXG4gICAgb25VcGRhdGUgPSAoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5yZXBvc2l0aW9uRWxlbWVudHMoKTtcclxuICAgICAgICB0aGlzLm1vZHVsZXMuZm9yRWFjaChtb2R1bGUgPT4ge1xyXG4gICAgICAgICAgICBtb2R1bGUub25VcGRhdGUoKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgcmVtb3ZlTW9kdWxlcyA9ICgpID0+IHtcclxuICAgICAgICB0aGlzLm1vZHVsZXMuZm9yRWFjaChtb2R1bGUgPT4ge1xyXG4gICAgICAgICAgICBtb2R1bGUub25EZXN0cm95KCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMubW9kdWxlcyA9IFtdO1xyXG4gICAgfTtcclxuXHJcbiAgICBoYW5kbGVDbGljayA9IGV2dCA9PiB7XHJcbiAgICAgICAgaWYgKFxyXG4gICAgICAgICAgICBldnQudGFyZ2V0ICYmXHJcbiAgICAgICAgICAgIGV2dC50YXJnZXQudGFnTmFtZSAmJlxyXG4gICAgICAgICAgICBldnQudGFyZ2V0LnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PT0gJ0lNRydcclxuICAgICAgICApIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW1nID09PSBldnQudGFyZ2V0KSB7XHJcbiAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgYWxyZWFkeSBmb2N1c2VkIG9uIHRoaXMgaW1hZ2VcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodGhpcy5pbWcpIHtcclxuICAgICAgICAgICAgICAgIC8vIHdlIHdlcmUganVzdCBmb2N1c2VkIG9uIGFub3RoZXIgaW1hZ2VcclxuICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIGNsaWNrZWQgb24gYW4gaW1hZ2UgaW5zaWRlIHRoZSBlZGl0b3JcclxuICAgICAgICAgICAgdGhpcy5zaG93KGV2dC50YXJnZXQpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5pbWcpIHtcclxuICAgICAgICAgICAgLy8gY2xpY2tlZCBvbiBhIG5vbiBpbWFnZVxyXG4gICAgICAgICAgICB0aGlzLmhpZGUoKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgc2hvdyA9IGltZyA9PiB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnF1aWxsLmlzRW5hYmxlZCgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGtlZXAgdHJhY2sgb2YgdGhpcyBpbWcgZWxlbWVudFxyXG4gICAgICAgIHRoaXMuaW1nID0gaW1nO1xyXG5cclxuICAgICAgICB0aGlzLnNob3dPdmVybGF5KCk7XHJcblxyXG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZU1vZHVsZXMoKTtcclxuICAgIH07XHJcblxyXG4gICAgc2hvd092ZXJsYXkgPSAoKSA9PiB7XHJcbiAgICAgICAgaWYgKHRoaXMub3ZlcmxheSkge1xyXG4gICAgICAgICAgICB0aGlzLmhpZGVPdmVybGF5KCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnF1aWxsLnNldFNlbGVjdGlvbihudWxsKTtcclxuXHJcbiAgICAgICAgLy8gcHJldmVudCBzcHVyaW91cyB0ZXh0IHNlbGVjdGlvblxyXG4gICAgICAgIHRoaXMuc2V0VXNlclNlbGVjdCgnbm9uZScpO1xyXG5cclxuICAgICAgICAvLyBsaXN0ZW4gZm9yIHRoZSBpbWFnZSBiZWluZyBkZWxldGVkIG9yIG1vdmVkXHJcbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCB0aGlzLmNoZWNrSW1hZ2UsIHRydWUpO1xyXG4gICAgICAgIHRoaXMucXVpbGwucm9vdC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIHRoaXMuY2hlY2tJbWFnZSwgdHJ1ZSk7XHJcblxyXG4gICAgICAgIC8vIENyZWF0ZSBhbmQgYWRkIHRoZSBvdmVybGF5XHJcbiAgICAgICAgdGhpcy5vdmVybGF5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLm92ZXJsYXkuc3R5bGUsIHRoaXMub3B0aW9ucy5vdmVybGF5U3R5bGVzKTtcclxuXHJcbiAgICAgICAgdGhpcy5xdWlsbC5yb290LnBhcmVudE5vZGUuYXBwZW5kQ2hpbGQodGhpcy5vdmVybGF5KTtcclxuXHJcbiAgICAgICAgdGhpcy5yZXBvc2l0aW9uRWxlbWVudHMoKTtcclxuICAgIH07XHJcblxyXG4gICAgaGlkZU92ZXJsYXkgPSAoKSA9PiB7XHJcbiAgICAgICAgaWYgKCF0aGlzLm92ZXJsYXkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gUmVtb3ZlIHRoZSBvdmVybGF5XHJcbiAgICAgICAgdGhpcy5xdWlsbC5yb290LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcy5vdmVybGF5KTtcclxuICAgICAgICB0aGlzLm92ZXJsYXkgPSB1bmRlZmluZWQ7XHJcblxyXG4gICAgICAgIC8vIHN0b3AgbGlzdGVuaW5nIGZvciBpbWFnZSBkZWxldGlvbiBvciBtb3ZlbWVudFxyXG4gICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleXVwJywgdGhpcy5jaGVja0ltYWdlKTtcclxuICAgICAgICB0aGlzLnF1aWxsLnJvb3QucmVtb3ZlRXZlbnRMaXN0ZW5lcignaW5wdXQnLCB0aGlzLmNoZWNrSW1hZ2UpO1xyXG5cclxuICAgICAgICAvLyByZXNldCB1c2VyLXNlbGVjdFxyXG4gICAgICAgIHRoaXMuc2V0VXNlclNlbGVjdCgnJyk7XHJcbiAgICB9O1xyXG5cclxuICAgIHJlcG9zaXRpb25FbGVtZW50cyA9ICgpID0+IHtcclxuICAgICAgICBpZiAoIXRoaXMub3ZlcmxheSB8fCAhdGhpcy5pbWcpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gcG9zaXRpb24gdGhlIG92ZXJsYXkgb3ZlciB0aGUgaW1hZ2VcclxuICAgICAgICBjb25zdCBwYXJlbnQgPSB0aGlzLnF1aWxsLnJvb3QucGFyZW50Tm9kZTtcclxuICAgICAgICBjb25zdCBpbWdSZWN0ID0gdGhpcy5pbWcuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgY29uc3QgY29udGFpbmVyUmVjdCA9IHBhcmVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuXHJcbiAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLm92ZXJsYXkuc3R5bGUsIHtcclxuICAgICAgICAgICAgbGVmdDogYCR7aW1nUmVjdC5sZWZ0IC1cclxuICAgICAgICAgICAgICAgIGNvbnRhaW5lclJlY3QubGVmdCArXHJcbiAgICAgICAgICAgICAgICBwYXJlbnQuc2Nyb2xsTGVmdCAtXHJcbiAgICAgICAgICAgICAgICAyfXB4YCxcclxuICAgICAgICAgICAgdG9wOiBgJHtpbWdSZWN0LnRvcCAtIGNvbnRhaW5lclJlY3QudG9wICsgcGFyZW50LnNjcm9sbFRvcCAtIDJ9cHhgLFxyXG4gICAgICAgICAgICB3aWR0aDogYCR7aW1nUmVjdC53aWR0aCArIDJ9cHhgLFxyXG4gICAgICAgICAgICBoZWlnaHQ6IGAke2ltZ1JlY3QuaGVpZ2h0ICsgMn1weGBcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgaGlkZSA9ICgpID0+IHtcclxuICAgICAgICB0aGlzLmhpZGVPdmVybGF5KCk7XHJcbiAgICAgICAgdGhpcy5yZW1vdmVNb2R1bGVzKCk7XHJcbiAgICAgICAgdGhpcy5pbWcgPSB1bmRlZmluZWQ7XHJcbiAgICB9O1xyXG5cclxuICAgIHNldFVzZXJTZWxlY3QgPSB2YWx1ZSA9PiB7XHJcbiAgICAgICAgW1xyXG4gICAgICAgICAgICAndXNlclNlbGVjdCcsXHJcbiAgICAgICAgICAgICdtb3pVc2VyU2VsZWN0JyxcclxuICAgICAgICAgICAgJ3dlYmtpdFVzZXJTZWxlY3QnLFxyXG4gICAgICAgICAgICAnbXNVc2VyU2VsZWN0J1xyXG4gICAgICAgIF0uZm9yRWFjaChwcm9wID0+IHtcclxuICAgICAgICAgICAgLy8gc2V0IG9uIGNvbnRlbnRlZGl0YWJsZSBlbGVtZW50IGFuZCA8aHRtbD5cclxuICAgICAgICAgICAgdGhpcy5xdWlsbC5yb290LnN0eWxlW3Byb3BdID0gdmFsdWU7XHJcbiAgICAgICAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZVtwcm9wXSA9IHZhbHVlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBjaGVja0ltYWdlID0gZXZ0ID0+IHtcclxuICAgICAgICBpZiAodGhpcy5pbWcpIHtcclxuICAgICAgICAgICAgaWYgKGV2dC5rZXlDb2RlID09IDQ2IHx8IGV2dC5rZXlDb2RlID09IDgpIHtcclxuICAgICAgICAgICAgICAgIFF1aWxsLmZpbmQodGhpcy5pbWcpLmRlbGV0ZUF0KDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuaGlkZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbn1cclxuLy9jb25zb2xlLmxvZyhJbWFnZVJlc2l6ZSlcclxuLy8gaWYgKFF1aWxsKSB7XHJcbi8vICAgICBRdWlsbC5yZWdpc3RlcignbW9kdWxlcy9pbWFnZVJlc2l6ZScsIEltYWdlUmVzaXplKVxyXG4vLyB9XHJcbiJdfQ==