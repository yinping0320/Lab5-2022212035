/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { tooltips } from './tooltip-list';
import { getScrollParent } from './utils/scrollInfo';
/** @type {?} */
const tooltipStyles = {
    minWidth: '70px',
    position: 'absolute',
    padding: '4px 8px',
    textAlign: 'center',
    backgroundColor: 'rgba(0,0,0,0.7)',
    color: '#fff',
    cursor: 'default',
    borderRadius: '4px',
    fontSize: '12px',
    top: '-9999px',
    visibility: 'hidden',
    'z-index': '9999'
};
export class Tooltip {
    /**
     * @param {?} quill
     * @param {?} ngZone
     */
    constructor(quill, ngZone) {
        this.ngZone = ngZone;
        this.quill = quill;
        this.toolbar = quill.getModule('toolbar');
        this.buttons = null;
        this.selectors = null;
        this.tip = null;
        this.timeout = null;
        this.mouseenterHandler = null;
        this.mouseleaveHandler = null;
        /** @type {?} */
        const toolbarElement = this.toolbar.container;
        if (toolbarElement) {
            // 添加处理事件
            this.buttons = toolbarElement.querySelectorAll('button');
            this.selectors = toolbarElement.querySelectorAll('.ql-picker');
            for (let el of this.buttons) {
                this.addHandler(el);
            }
            for (let el of this.selectors) {
                this.addHandler(el);
            }
            // 创建tooltip
            this.createTooltip();
            // 滚动元素增加handler
            this.scrollElm = getScrollParent(toolbarElement);
            this.scrollElm.addEventListener('scroll', this.mouseleaveHandler);
        }
    }
    /**
     * @return {?}
     */
    createTooltip() {
        this.tip = document.createElement('div');
        this.tip.classList.add('quill-tooltip');
        Object.assign(this.tip.style, tooltipStyles);
        document.body.appendChild(this.tip);
    }
    /**
     * @param {?} el
     * @return {?}
     */
    addHandler(el) {
        this.mouseenterHandler = (/**
         * @return {?}
         */
        () => {
            // this.ngZone.runOutsideAngular(() => {
            //     this.timeout = setTimeout(() => {
            //         this.showTooltip(el);
            //     }, 100);
            // });
            this.timeout = setTimeout((/**
             * @return {?}
             */
            () => {
                this.showTooltip(el);
            }), 100);
        });
        this.mouseleaveHandler = (/**
         * @return {?}
         */
        () => {
            if (this.timeout) {
                // this.ngZone.runOutsideAngular(() => {
                //     clearTimeout(this.timeout);
                // });
                clearTimeout(this.timeout);
            }
            this.hideTooltip();
        });
        // if (this.ngZone && this.ngZone.runOutsideAngular) {
        //     this.ngZone.runOutsideAngular(() => {
        //         el.addEventListener('mouseenter', this.mouseenterHandler);
        //         el.addEventListener('mouseleave', this.mouseleaveHandler);
        //     });
        // }
        el.addEventListener('mouseenter', this.mouseenterHandler);
        el.addEventListener('mouseleave', this.mouseleaveHandler);
    }
    /**
     * @param {?} el
     * @return {?}
     */
    showTooltip(el) {
        // let format = el.className.replace('ql-', '')
        // let format = el.className.replace('ql-', '')
        /** @type {?} */
        const LOCALE_ID = this.quill.options.localeId || 'zh-CHS';
        /** @type {?} */
        const format = [].find
            .call(el.classList, (/**
         * @param {?} className
         * @return {?}
         */
        className => {
            return className.indexOf('ql-') === 0;
        }))
            .replace('ql-', '');
        /** @type {?} */
        const tool = tooltips[LOCALE_ID][format];
        if (tool) {
            if (typeof tool === 'string') {
                this.tip.textContent = tool;
            }
            else {
                /** @type {?} */
                const value = el.value || '';
                if (value != null && tool[value]) {
                    this.tip.textContent = tool[value];
                }
            }
            /** @type {?} */
            const elRect = el.getBoundingClientRect();
            /** @type {?} */
            const tipRect = this.tip.getBoundingClientRect();
            /** @type {?} */
            const body = document.documentElement || document.body;
            /** @type {?} */
            const bodyRect = {
                width: body.scrollWidth,
                height: body.scrollHeight,
                scrollTop: body.scrollTop,
                scrollLeft: body.scrollLeft
            };
            /** @type {?} */
            const offset = 3;
            Object.assign(this.tip.style, {
                top: elRect.top - elRect.height - offset + bodyRect.scrollTop + 'px',
                left: elRect.left - (tipRect.width - elRect.width) / 2 + bodyRect.scrollLeft + 'px',
                visibility: 'visible'
            });
        }
    }
    /**
     * @return {?}
     */
    hideTooltip() {
        Object.assign(this.tip.style, {
            top: '-9999px',
            visibility: 'hidden'
        });
    }
    /**
     * @return {?}
     */
    onDestroy() {
        // console.warn('ondestroy');
        this.destroyTooltip();
        if (this.buttons) {
            for (let el of this.buttons) {
                this.removeHandler(el);
            }
        }
        if (this.selectors) {
            for (let el of this.selectors) {
                this.removeHandler(el);
            }
        }
        if (this.scrollElm) {
            this.scrollElm.removeEventListener('scroll', this.mouseleaveHandler);
        }
    }
    /**
     * @return {?}
     */
    destroyTooltip() {
        if (this.tip.parentNode) {
            this.tip.parentNode.removeChild(this.tip);
        }
    }
    /**
     * @param {?} el
     * @return {?}
     */
    removeHandler(el) {
        el.removeEventListener('mouseenter', this.mouseenterHandler);
        el.removeEventListener('mouseleave', this.mouseleaveHandler);
    }
}
if (false) {
    /** @type {?} */
    Tooltip.prototype.quill;
    /** @type {?} */
    Tooltip.prototype.toolbar;
    /** @type {?} */
    Tooltip.prototype.buttons;
    /** @type {?} */
    Tooltip.prototype.tip;
    /** @type {?} */
    Tooltip.prototype.selectors;
    /** @type {?} */
    Tooltip.prototype.mouseenterHandler;
    /** @type {?} */
    Tooltip.prototype.mouseleaveHandler;
    /** @type {?} */
    Tooltip.prototype.timeout;
    /** @type {?} */
    Tooltip.prototype.scrollElm;
    /**
     * @type {?}
     * @private
     */
    Tooltip.prototype.ngZone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWh0bWwtZWRpdG9yLyIsInNvdXJjZXMiOlsibGliL3Rvb2wtdGlwLW1vZHVsZS9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQ0EsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQzs7TUFDL0MsYUFBYSxHQUFHO0lBQ2xCLFFBQVEsRUFBRSxNQUFNO0lBQ2hCLFFBQVEsRUFBRSxVQUFVO0lBQ3BCLE9BQU8sRUFBRSxTQUFTO0lBQ2xCLFNBQVMsRUFBRSxRQUFRO0lBQ25CLGVBQWUsRUFBRSxpQkFBaUI7SUFDbEMsS0FBSyxFQUFFLE1BQU07SUFDYixNQUFNLEVBQUUsU0FBUztJQUNqQixZQUFZLEVBQUUsS0FBSztJQUNuQixRQUFRLEVBQUUsTUFBTTtJQUNoQixHQUFHLEVBQUUsU0FBUztJQUNkLFVBQVUsRUFBRSxRQUFRO0lBQ3BCLFNBQVMsRUFBRSxNQUFNO0NBQ3BCO0FBQ0QsTUFBTSxPQUFPLE9BQU87Ozs7O0lBVWhCLFlBQVksS0FBSyxFQUFVLE1BQWM7UUFBZCxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ3JDLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUMxQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztRQUNwQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztRQUN0QixJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQztRQUNoQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztRQUNwQixJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDO1FBQzlCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUM7O2NB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Q0FBQztRQUM3RCxFQUFFLENBQUMsbUJBQW1CLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0lBQ2pFLENBQUM7Q0FDSjs7O0lBbkpHLHdCQUFXOztJQUNYLDBCQUFhOztJQUNiLDBCQUFhOztJQUNiLHNCQUFTOztJQUNULDRCQUFlOztJQUNmLG9DQUF1Qjs7SUFDdkIsb0NBQXVCOztJQUN2QiwwQkFBYTs7SUFDYiw0QkFBZTs7Ozs7SUFDSSx5QkFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgdG9vbHRpcHMgfSBmcm9tICcuL3Rvb2x0aXAtbGlzdCc7XHJcbmltcG9ydCB7IGdldFNjcm9sbFBhcmVudCB9IGZyb20gJy4vdXRpbHMvc2Nyb2xsSW5mbyc7XHJcbmNvbnN0IHRvb2x0aXBTdHlsZXMgPSB7XHJcbiAgICBtaW5XaWR0aDogJzcwcHgnLFxyXG4gICAgcG9zaXRpb246ICdhYnNvbHV0ZScsXHJcbiAgICBwYWRkaW5nOiAnNHB4IDhweCcsXHJcbiAgICB0ZXh0QWxpZ246ICdjZW50ZXInLFxyXG4gICAgYmFja2dyb3VuZENvbG9yOiAncmdiYSgwLDAsMCwwLjcpJyxcclxuICAgIGNvbG9yOiAnI2ZmZicsXHJcbiAgICBjdXJzb3I6ICdkZWZhdWx0JyxcclxuICAgIGJvcmRlclJhZGl1czogJzRweCcsXHJcbiAgICBmb250U2l6ZTogJzEycHgnLFxyXG4gICAgdG9wOiAnLTk5OTlweCcsXHJcbiAgICB2aXNpYmlsaXR5OiAnaGlkZGVuJyxcclxuICAgICd6LWluZGV4JzogJzk5OTknXHJcbn07XHJcbmV4cG9ydCBjbGFzcyBUb29sdGlwIHtcclxuICAgIHF1aWxsOiBhbnk7XHJcbiAgICB0b29sYmFyOiBhbnk7XHJcbiAgICBidXR0b25zOiBhbnk7XHJcbiAgICB0aXA6IGFueTtcclxuICAgIHNlbGVjdG9yczogYW55O1xyXG4gICAgbW91c2VlbnRlckhhbmRsZXI6IGFueTtcclxuICAgIG1vdXNlbGVhdmVIYW5kbGVyOiBhbnk7XHJcbiAgICB0aW1lb3V0OiBhbnk7XHJcbiAgICBzY3JvbGxFbG06IGFueTtcclxuICAgIGNvbnN0cnVjdG9yKHF1aWxsLCBwcml2YXRlIG5nWm9uZTogTmdab25lKSB7XHJcbiAgICAgICAgdGhpcy5xdWlsbCA9IHF1aWxsO1xyXG4gICAgICAgIHRoaXMudG9vbGJhciA9IHF1aWxsLmdldE1vZHVsZSgndG9vbGJhcicpO1xyXG4gICAgICAgIHRoaXMuYnV0dG9ucyA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RvcnMgPSBudWxsO1xyXG4gICAgICAgIHRoaXMudGlwID0gbnVsbDtcclxuICAgICAgICB0aGlzLnRpbWVvdXQgPSBudWxsO1xyXG4gICAgICAgIHRoaXMubW91c2VlbnRlckhhbmRsZXIgPSBudWxsO1xyXG4gICAgICAgIHRoaXMubW91c2VsZWF2ZUhhbmRsZXIgPSBudWxsO1xyXG4gICAgICAgIGNvbnN0IHRvb2xiYXJFbGVtZW50ID0gdGhpcy50b29sYmFyLmNvbnRhaW5lcjtcclxuICAgICAgICBpZiAodG9vbGJhckVsZW1lbnQpIHtcclxuICAgICAgICAgICAgLy8g5re75Yqg5aSE55CG5LqL5Lu2XHJcbiAgICAgICAgICAgIHRoaXMuYnV0dG9ucyA9IHRvb2xiYXJFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2J1dHRvbicpO1xyXG4gICAgICAgICAgICB0aGlzLnNlbGVjdG9ycyA9IHRvb2xiYXJFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5xbC1waWNrZXInKTtcclxuICAgICAgICAgICAgZm9yIChsZXQgZWwgb2YgdGhpcy5idXR0b25zKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFkZEhhbmRsZXIoZWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGZvciAobGV0IGVsIG9mIHRoaXMuc2VsZWN0b3JzKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFkZEhhbmRsZXIoZWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIOWIm+W7unRvb2x0aXBcclxuICAgICAgICAgICAgdGhpcy5jcmVhdGVUb29sdGlwKCk7XHJcbiAgICAgICAgICAgIC8vIOa7muWKqOWFg+e0oOWinuWKoGhhbmRsZXJcclxuICAgICAgICAgICAgdGhpcy5zY3JvbGxFbG0gPSBnZXRTY3JvbGxQYXJlbnQodG9vbGJhckVsZW1lbnQpO1xyXG4gICAgICAgICAgICB0aGlzLnNjcm9sbEVsbS5hZGRFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLm1vdXNlbGVhdmVIYW5kbGVyKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY3JlYXRlVG9vbHRpcCgpIHtcclxuICAgICAgICB0aGlzLnRpcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgIHRoaXMudGlwLmNsYXNzTGlzdC5hZGQoJ3F1aWxsLXRvb2x0aXAnKTtcclxuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMudGlwLnN0eWxlLCB0b29sdGlwU3R5bGVzKTtcclxuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMudGlwKTtcclxuICAgIH1cclxuXHJcbiAgICBhZGRIYW5kbGVyKGVsKSB7XHJcbiAgICAgICAgdGhpcy5tb3VzZWVudGVySGFuZGxlciA9ICgpID0+IHtcclxuICAgICAgICAgICAgLy8gdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xyXG4gICAgICAgICAgICAvLyAgICAgdGhpcy50aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgdGhpcy5zaG93VG9vbHRpcChlbCk7XHJcbiAgICAgICAgICAgIC8vICAgICB9LCAxMDApO1xyXG4gICAgICAgICAgICAvLyB9KTtcclxuICAgICAgICAgICAgdGhpcy50aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNob3dUb29sdGlwKGVsKTtcclxuICAgICAgICAgICAgfSwgMTAwKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMubW91c2VsZWF2ZUhhbmRsZXIgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnRpbWVvdXQpIHtcclxuICAgICAgICAgICAgICAgIC8vIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIC8vICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0KTtcclxuICAgICAgICAgICAgICAgIC8vIH0pO1xyXG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5oaWRlVG9vbHRpcCgpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgLy8gaWYgKHRoaXMubmdab25lICYmIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKSB7XHJcbiAgICAgICAgLy8gICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuICAgICAgICAvLyAgICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZW50ZXInLCB0aGlzLm1vdXNlZW50ZXJIYW5kbGVyKTtcclxuICAgICAgICAvLyAgICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCB0aGlzLm1vdXNlbGVhdmVIYW5kbGVyKTtcclxuICAgICAgICAvLyAgICAgfSk7XHJcbiAgICAgICAgLy8gfVxyXG4gICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZW50ZXInLCB0aGlzLm1vdXNlZW50ZXJIYW5kbGVyKTtcclxuICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgdGhpcy5tb3VzZWxlYXZlSGFuZGxlcik7XHJcbiAgICB9XHJcblxyXG4gICAgc2hvd1Rvb2x0aXAoZWwpIHtcclxuICAgICAgICAvLyBsZXQgZm9ybWF0ID0gZWwuY2xhc3NOYW1lLnJlcGxhY2UoJ3FsLScsICcnKVxyXG5cclxuICAgICAgICBjb25zdCBMT0NBTEVfSUQgPSB0aGlzLnF1aWxsLm9wdGlvbnMubG9jYWxlSWQgfHwgJ3poLUNIUyc7XHJcblxyXG4gICAgICAgIGNvbnN0IGZvcm1hdCA9IFtdLmZpbmRcclxuICAgICAgICAgICAgLmNhbGwoZWwuY2xhc3NMaXN0LCBjbGFzc05hbWUgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNsYXNzTmFtZS5pbmRleE9mKCdxbC0nKSA9PT0gMDtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLnJlcGxhY2UoJ3FsLScsICcnKTtcclxuICAgICAgICBjb25zdCB0b29sID0gdG9vbHRpcHNbTE9DQUxFX0lEXVtmb3JtYXRdO1xyXG4gICAgICAgIGlmICh0b29sKSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdG9vbCA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudGlwLnRleHRDb250ZW50ID0gdG9vbDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gZWwudmFsdWUgfHwgJyc7XHJcbiAgICAgICAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCAmJiB0b29sW3ZhbHVlXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGlwLnRleHRDb250ZW50ID0gdG9vbFt2YWx1ZV07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgZWxSZWN0ID0gZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHRpcFJlY3QgPSB0aGlzLnRpcC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICAgICAgY29uc3QgYm9keSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fCBkb2N1bWVudC5ib2R5O1xyXG4gICAgICAgICAgICBjb25zdCBib2R5UmVjdCA9IHtcclxuICAgICAgICAgICAgICAgIHdpZHRoOiBib2R5LnNjcm9sbFdpZHRoLFxyXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiBib2R5LnNjcm9sbEhlaWdodCxcclxuICAgICAgICAgICAgICAgIHNjcm9sbFRvcDogYm9keS5zY3JvbGxUb3AsXHJcbiAgICAgICAgICAgICAgICBzY3JvbGxMZWZ0OiBib2R5LnNjcm9sbExlZnRcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gMztcclxuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLnRpcC5zdHlsZSwge1xyXG4gICAgICAgICAgICAgICAgdG9wOiBlbFJlY3QudG9wIC0gZWxSZWN0LmhlaWdodCAtIG9mZnNldCArIGJvZHlSZWN0LnNjcm9sbFRvcCArICdweCcsXHJcbiAgICAgICAgICAgICAgICBsZWZ0OiBlbFJlY3QubGVmdCAtICh0aXBSZWN0LndpZHRoIC0gZWxSZWN0LndpZHRoKSAvIDIgKyBib2R5UmVjdC5zY3JvbGxMZWZ0ICsgJ3B4JyxcclxuICAgICAgICAgICAgICAgIHZpc2liaWxpdHk6ICd2aXNpYmxlJ1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaGlkZVRvb2x0aXAoKSB7XHJcbiAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLnRpcC5zdHlsZSwge1xyXG4gICAgICAgICAgICB0b3A6ICctOTk5OXB4JyxcclxuICAgICAgICAgICAgdmlzaWJpbGl0eTogJ2hpZGRlbidcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBvbkRlc3Ryb3koKSB7XHJcbiAgICAgICAgLy8gY29uc29sZS53YXJuKCdvbmRlc3Ryb3knKTtcclxuICAgICAgICB0aGlzLmRlc3Ryb3lUb29sdGlwKCk7XHJcbiAgICAgICAgaWYgKHRoaXMuYnV0dG9ucykge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBlbCBvZiB0aGlzLmJ1dHRvbnMpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlSGFuZGxlcihlbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuc2VsZWN0b3JzKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGVsIG9mIHRoaXMuc2VsZWN0b3JzKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUhhbmRsZXIoZWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLnNjcm9sbEVsbSkge1xyXG4gICAgICAgICAgICB0aGlzLnNjcm9sbEVsbS5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLm1vdXNlbGVhdmVIYW5kbGVyKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZGVzdHJveVRvb2x0aXAoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMudGlwLnBhcmVudE5vZGUpIHtcclxuICAgICAgICAgICAgdGhpcy50aXAucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzLnRpcCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZUhhbmRsZXIoZWwpIHtcclxuICAgICAgICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgdGhpcy5tb3VzZWVudGVySGFuZGxlcik7XHJcbiAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsIHRoaXMubW91c2VsZWF2ZUhhbmRsZXIpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==