/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { LocaleService } from '@farris/ui-locale';
import { BsModalService } from '@farris/ui-modal';
import { Injectable, Injector, ComponentFactoryResolver } from '@angular/core';
import { Subject } from 'rxjs';
import { EnumEditorComponent } from './enum-editor.component';
import { cloneDeep } from 'lodash-es';
import * as i0 from "@angular/core";
import * as i1 from "@farris/ui-modal";
import * as i2 from "@farris/ui-locale";
/** @enum {number} */
var EnumOutType = {
    'array': 0,
    'object': 1,
};
export { EnumOutType };
EnumOutType[EnumOutType['array']] = 'array';
EnumOutType[EnumOutType['object']] = 'object';
var EnumEditorService = /** @class */ (function () {
    function EnumEditorService(injector, cfr, modalService, localeService) {
        this.injector = injector;
        this.cfr = cfr;
        this.modalService = modalService;
        this.localeService = localeService;
        this.enumEditorRef = null;
        this.dlgRef = null;
        this.originalData = [];
        this.textField = 'name';
        this.valueField = 'value';
        this.outType = EnumOutType.array;
        this.dataChanged = new Subject();
    }
    /**
     * @param {?=} enumData
     * @param {?=} options
     * @return {?}
     */
    EnumEditorService.prototype.showDialog = /**
     * @param {?=} enumData
     * @param {?=} options
     * @return {?}
     */
    function (enumData, options) {
        var _this = this;
        if (enumData === void 0) { enumData = []; }
        if (options === void 0) { options = {}; }
        enumData = this.toJSON(enumData);
        /** @type {?} */
        var enumEditorFactory = this.cfr.resolveComponentFactory(EnumEditorComponent);
        this.enumEditorRef = enumEditorFactory.create(this.injector);
        this.enumEditorRef.instance.data = enumData;
        this.originalData = cloneDeep(enumData);
        this.textField = options['textField'] || 'name';
        this.valueField = options['valueField'] || 'value';
        this.outType = options['outType'] || EnumOutType.array;
        options['showSortBtns'] = this.outType === EnumOutType.array;
        this.dlgRef = this.modalService.show(this.enumEditorRef, {
            width: 800, height: 500,
            title: this.localeService.getValue('enumEditor.title'), enableScroll: false,
            minHeight: 398, minWidth: 798, iconCls: 'f-icon f-icon-top_developmenttool',
            buttons: [
                {
                    text: this.localeService.getValue('enumEditor.cancelButton'),
                    cls: 'btn btn-outline-secondary',
                    handle: (/**
                     * @return {?}
                     */
                    function () {
                        _this.cancel();
                    })
                },
                {
                    text: this.localeService.getValue('enumEditor.okButton'),
                    cls: 'btn btn-primary',
                    handle: (/**
                     * @return {?}
                     */
                    function () {
                        _this.save();
                    })
                }
            ],
            initialState: options,
            dialogFooterStyles: { background: '#F4F6F9' },
            buttonAlign: 'right',
            closed: (/**
             * @param {?} isCloseButtonClick
             * @return {?}
             */
            function (isCloseButtonClick) {
                if (isCloseButtonClick) {
                    _this.cancel();
                }
            })
        });
        this.enumEditorRef.instance.height = this.dlgRef.dialog.instance.getContainerSize().height;
        this.dlgRef.dialog.instance.resized.subscribe((/**
         * @param {?} size
         * @return {?}
         */
        function (size) {
            _this.enumEditorRef.instance.height = size.containerHeight;
        }));
        this.enumEditorRef.changeDetectorRef.detectChanges();
        this.dlgRef.dialog.changeDetectorRef.reattach();
        // this.openDialog.emit();
    };
    /**
     * @return {?}
     */
    EnumEditorService.prototype.cancel = /**
     * @return {?}
     */
    function () {
        this._dataChanged(this.originalData);
        this.dlgRef.close();
    };
    /**
     * @return {?}
     */
    EnumEditorService.prototype.save = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var enumData = this.enumEditorRef.instance.data;
        this._dataChanged(enumData);
        this.dlgRef.close();
    };
    /**
     * @private
     * @param {?} enumData
     * @return {?}
     */
    EnumEditorService.prototype._dataChanged = /**
     * @private
     * @param {?} enumData
     * @return {?}
     */
    function (enumData) {
        /** @type {?} */
        var str = this.toString(enumData);
        this.dataChanged.next(str);
    };
    /**
     * @param {?} enumData
     * @return {?}
     */
    EnumEditorService.prototype.toString = /**
     * @param {?} enumData
     * @return {?}
     */
    function (enumData) {
        var _this = this;
        if (enumData && enumData.length) {
            if (this.outType === EnumOutType.array) {
                return JSON.stringify(enumData);
            }
            else {
                /** @type {?} */
                var obj = enumData.reduce((/**
                 * @param {?} r
                 * @param {?} c
                 * @return {?}
                 */
                function (r, c) {
                    r[c[_this.valueField]] = c[_this.textField];
                    return r;
                }), {});
                return JSON.stringify(obj);
            }
        }
        return '';
    };
    /**
     * @param {?} val
     * @return {?}
     */
    EnumEditorService.prototype.toJSON = /**
     * @param {?} val
     * @return {?}
     */
    function (val) {
        /** @type {?} */
        var enumData = [];
        if (val) {
            if (typeof val === 'string') {
                try {
                    enumData = JSON.parse(val);
                    if (this.outType === EnumOutType.object) {
                        enumData = this.convertObject2Array(enumData);
                    }
                }
                catch (e) {
                    enumData = [];
                    // console.warn(e);
                }
            }
            else {
                if (Array.isArray(val)) {
                    enumData = val;
                }
                else {
                    enumData = this.convertObject2Array(val);
                }
            }
        }
        return enumData;
    };
    /**
     * @private
     * @param {?} obj
     * @return {?}
     */
    EnumEditorService.prototype.convertObject2Array = /**
     * @private
     * @param {?} obj
     * @return {?}
     */
    function (obj) {
        var _this = this;
        /** @type {?} */
        var _enumData = [];
        Object.keys(obj).forEach((/**
         * @param {?} n
         * @return {?}
         */
        function (n) {
            var _a;
            _enumData.push((_a = {}, _a[_this.valueField] = n, _a[_this.textField] = obj[n], _a));
        }));
        return _enumData;
    };
    EnumEditorService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    EnumEditorService.ctorParameters = function () { return [
        { type: Injector },
        { type: ComponentFactoryResolver },
        { type: BsModalService },
        { type: LocaleService }
    ]; };
    /** @nocollapse */ EnumEditorService.ngInjectableDef = i0.defineInjectable({ factory: function EnumEditorService_Factory() { return new EnumEditorService(i0.inject(i0.INJECTOR), i0.inject(i0.ComponentFactoryResolver), i0.inject(i1.BsModalService), i0.inject(i2.LocaleService)); }, token: EnumEditorService, providedIn: "root" });
    return EnumEditorService;
}());
export { EnumEditorService };
if (false) {
    /** @type {?} */
    EnumEditorService.prototype.enumEditorRef;
    /** @type {?} */
    EnumEditorService.prototype.dlgRef;
    /** @type {?} */
    EnumEditorService.prototype.originalData;
    /** @type {?} */
    EnumEditorService.prototype.textField;
    /** @type {?} */
    EnumEditorService.prototype.valueField;
    /** @type {?} */
    EnumEditorService.prototype.outType;
    /** @type {?} */
    EnumEditorService.prototype.dataChanged;
    /**
     * @type {?}
     * @private
     */
    EnumEditorService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    EnumEditorService.prototype.cfr;
    /**
     * @type {?}
     * @private
     */
    EnumEditorService.prototype.modalService;
    /**
     * @type {?}
     * @private
     */
    EnumEditorService.prototype.localeService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW51bS1lZGl0b3Iuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZW51bS1lZGl0b3IvIiwic291cmNlcyI6WyJsaWIvZW51bS1lZGl0b3Iuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSx3QkFBd0IsRUFBZ0IsTUFBTSxlQUFlLENBQUM7QUFDN0YsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUU5RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDOzs7Ozs7SUFHbEMsVUFBTztJQUNQLFdBQVE7Ozt3QkFEUixPQUFPLEtBQVAsT0FBTzt3QkFDUCxRQUFRLEtBQVIsUUFBUTtBQUlaO0lBZ0JJLDJCQUFvQixRQUFrQixFQUFVLEdBQTZCLEVBQ3pELFlBQTRCLEVBQVUsYUFBNEI7UUFEbEUsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLFFBQUcsR0FBSCxHQUFHLENBQTBCO1FBQ3pELGlCQUFZLEdBQVosWUFBWSxDQUFnQjtRQUFVLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBWnRGLGtCQUFhLEdBQXNDLElBQUksQ0FBQztRQUN4RCxXQUFNLEdBQUcsSUFBSSxDQUFDO1FBQ2QsaUJBQVksR0FBRyxFQUFFLENBQUM7UUFFbEIsY0FBUyxHQUFHLE1BQU0sQ0FBQztRQUNuQixlQUFVLEdBQUcsT0FBTyxDQUFDO1FBQ3JCLFlBQU8sR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDO1FBRTVCLGdCQUFXLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztJQUk4RCxDQUFDOzs7Ozs7SUFHM0Ysc0NBQVU7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Q3ZFLENBQUMsRUFBQyxDQUFDO1FBRUgsT0FBTyxTQUFTLENBQUM7SUFDckIsQ0FBQzs7Z0JBeklKLFVBQVUsU0FBQztvQkFDUixVQUFVLEVBQUUsTUFBTTtpQkFDckI7Ozs7Z0JBZG9CLFFBQVE7Z0JBQUUsd0JBQXdCO2dCQUQ5QyxjQUFjO2dCQURkLGFBQWE7Ozs0QkFBdEI7Q0F3SkMsQUExSUQsSUEwSUM7U0F2SVksaUJBQWlCOzs7SUFFMUIsMENBQXdEOztJQUN4RCxtQ0FBYzs7SUFDZCx5Q0FBa0I7O0lBRWxCLHNDQUFtQjs7SUFDbkIsdUNBQXFCOztJQUNyQixvQ0FBNEI7O0lBRTVCLHdDQUE0Qjs7Ozs7SUFHaEIscUNBQTBCOzs7OztJQUFFLGdDQUFxQzs7Ozs7SUFDakUseUNBQW9DOzs7OztJQUFFLDBDQUFvQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvY2FsZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWxvY2FsZSc7XHJcbmltcG9ydCB7IEJzTW9kYWxTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1tb2RhbCc7XHJcbmltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIENvbXBvbmVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IEVudW1FZGl0b3JDb21wb25lbnQgfSBmcm9tICcuL2VudW0tZWRpdG9yLmNvbXBvbmVudCc7XHJcblxyXG5pbXBvcnQgeyBjbG9uZURlZXAgfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG5cclxuZXhwb3J0IGVudW0gRW51bU91dFR5cGUge1xyXG4gICAgJ2FycmF5JyxcclxuICAgICdvYmplY3QnXHJcbn1cclxuXHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIEVudW1FZGl0b3JTZXJ2aWNlIHtcclxuXHJcbiAgICBlbnVtRWRpdG9yUmVmOiBDb21wb25lbnRSZWY8RW51bUVkaXRvckNvbXBvbmVudD4gPSBudWxsO1xyXG4gICAgZGxnUmVmID0gbnVsbDtcclxuICAgIG9yaWdpbmFsRGF0YSA9IFtdO1xyXG5cclxuICAgIHRleHRGaWVsZCA9ICduYW1lJztcclxuICAgIHZhbHVlRmllbGQgPSAndmFsdWUnO1xyXG4gICAgb3V0VHlwZSA9IEVudW1PdXRUeXBlLmFycmF5O1xyXG5cclxuICAgIGRhdGFDaGFuZ2VkID0gbmV3IFN1YmplY3QoKTtcclxuXHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgY2ZyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIG1vZGFsU2VydmljZTogQnNNb2RhbFNlcnZpY2UsIHByaXZhdGUgbG9jYWxlU2VydmljZTogTG9jYWxlU2VydmljZSkgeyB9XHJcblxyXG5cclxuICAgIHNob3dEaWFsb2coZW51bURhdGEgPSBbXSwgb3B0aW9ucyA9IHt9KSB7XHJcbiAgICAgICAgZW51bURhdGEgPSB0aGlzLnRvSlNPTihlbnVtRGF0YSk7XHJcbiAgICAgICAgY29uc3QgZW51bUVkaXRvckZhY3RvcnkgPSB0aGlzLmNmci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShFbnVtRWRpdG9yQ29tcG9uZW50KTtcclxuICAgICAgICB0aGlzLmVudW1FZGl0b3JSZWYgPSBlbnVtRWRpdG9yRmFjdG9yeS5jcmVhdGUodGhpcy5pbmplY3Rvcik7XHJcbiAgICAgICAgdGhpcy5lbnVtRWRpdG9yUmVmLmluc3RhbmNlLmRhdGEgPSBlbnVtRGF0YTtcclxuICAgICAgICB0aGlzLm9yaWdpbmFsRGF0YSA9IGNsb25lRGVlcChlbnVtRGF0YSk7XHJcblxyXG4gICAgICAgIHRoaXMudGV4dEZpZWxkID0gb3B0aW9uc1sndGV4dEZpZWxkJ10gfHwgJ25hbWUnO1xyXG4gICAgICAgIHRoaXMudmFsdWVGaWVsZCA9IG9wdGlvbnNbJ3ZhbHVlRmllbGQnXSB8fCAndmFsdWUnO1xyXG4gICAgICAgIHRoaXMub3V0VHlwZSA9IG9wdGlvbnNbJ291dFR5cGUnXSB8fCBFbnVtT3V0VHlwZS5hcnJheTtcclxuXHJcbiAgICAgICAgb3B0aW9uc1snc2hvd1NvcnRCdG5zJ10gPSB0aGlzLm91dFR5cGUgPT09IEVudW1PdXRUeXBlLmFycmF5O1xyXG5cclxuICAgICAgICB0aGlzLmRsZ1JlZiA9IHRoaXMubW9kYWxTZXJ2aWNlLnNob3codGhpcy5lbnVtRWRpdG9yUmVmLCB7XHJcbiAgICAgICAgICAgIHdpZHRoOiA4MDAsIGhlaWdodDogNTAwLFxyXG4gICAgICAgICAgICB0aXRsZTogdGhpcy5sb2NhbGVTZXJ2aWNlLmdldFZhbHVlKCdlbnVtRWRpdG9yLnRpdGxlJyksIGVuYWJsZVNjcm9sbDogZmFsc2UsXHJcbiAgICAgICAgICAgIG1pbkhlaWdodDogMzk4LCBtaW5XaWR0aDogNzk4LCBpY29uQ2xzOiAnZi1pY29uIGYtaWNvbi10b3BfZGV2ZWxvcG1lbnR0b29sJyxcclxuICAgICAgICAgICAgYnV0dG9uczogW1xyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHRleHQ6IHRoaXMubG9jYWxlU2VydmljZS5nZXRWYWx1ZSgnZW51bUVkaXRvci5jYW5jZWxCdXR0b24nKSxcclxuICAgICAgICAgICAgICAgICAgICBjbHM6ICdidG4gYnRuLW91dGxpbmUtc2Vjb25kYXJ5JyxcclxuICAgICAgICAgICAgICAgICAgICBoYW5kbGU6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW5jZWwoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHRleHQ6IHRoaXMubG9jYWxlU2VydmljZS5nZXRWYWx1ZSgnZW51bUVkaXRvci5va0J1dHRvbicpLFxyXG4gICAgICAgICAgICAgICAgICAgIGNsczogJ2J0biBidG4tcHJpbWFyeScsXHJcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2F2ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgaW5pdGlhbFN0YXRlOiBvcHRpb25zLFxyXG4gICAgICAgICAgICBkaWFsb2dGb290ZXJTdHlsZXM6IHsgYmFja2dyb3VuZDogJyNGNEY2RjknIH0sXHJcbiAgICAgICAgICAgIGJ1dHRvbkFsaWduOiAncmlnaHQnLFxyXG4gICAgICAgICAgICBjbG9zZWQ6IChpc0Nsb3NlQnV0dG9uQ2xpY2s6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChpc0Nsb3NlQnV0dG9uQ2xpY2spIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbmNlbCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuZW51bUVkaXRvclJlZi5pbnN0YW5jZS5oZWlnaHQgPSB0aGlzLmRsZ1JlZi5kaWFsb2cuaW5zdGFuY2UuZ2V0Q29udGFpbmVyU2l6ZSgpLmhlaWdodDtcclxuXHJcbiAgICAgICAgdGhpcy5kbGdSZWYuZGlhbG9nLmluc3RhbmNlLnJlc2l6ZWQuc3Vic2NyaWJlKHNpemUgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmVudW1FZGl0b3JSZWYuaW5zdGFuY2UuaGVpZ2h0ID0gc2l6ZS5jb250YWluZXJIZWlnaHQ7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuZW51bUVkaXRvclJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcblxyXG4gICAgICAgIHRoaXMuZGxnUmVmLmRpYWxvZy5jaGFuZ2VEZXRlY3RvclJlZi5yZWF0dGFjaCgpO1xyXG4gICAgICAgIC8vIHRoaXMub3BlbkRpYWxvZy5lbWl0KCk7XHJcbiAgICB9XHJcblxyXG4gICAgY2FuY2VsKCkge1xyXG4gICAgICAgIHRoaXMuX2RhdGFDaGFuZ2VkKHRoaXMub3JpZ2luYWxEYXRhKTtcclxuICAgICAgICB0aGlzLmRsZ1JlZi5jbG9zZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHNhdmUoKSB7XHJcbiAgICAgICAgY29uc3QgZW51bURhdGEgPSB0aGlzLmVudW1FZGl0b3JSZWYuaW5zdGFuY2UuZGF0YTtcclxuICAgICAgICB0aGlzLl9kYXRhQ2hhbmdlZChlbnVtRGF0YSk7XHJcbiAgICAgICAgdGhpcy5kbGdSZWYuY2xvc2UoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9kYXRhQ2hhbmdlZChlbnVtRGF0YTogYW55KSB7XHJcbiAgICAgICAgY29uc3Qgc3RyID0gdGhpcy50b1N0cmluZyhlbnVtRGF0YSk7XHJcbiAgICAgICAgdGhpcy5kYXRhQ2hhbmdlZC5uZXh0KHN0cik7XHJcbiAgICB9XHJcblxyXG4gICAgdG9TdHJpbmcoZW51bURhdGE6IGFueSkge1xyXG4gICAgICAgIGlmIChlbnVtRGF0YSAmJiBlbnVtRGF0YS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMub3V0VHlwZSA9PT0gRW51bU91dFR5cGUuYXJyYXkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShlbnVtRGF0YSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBvYmogPSBlbnVtRGF0YS5yZWR1Y2UoKHIsIGMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByW2NbdGhpcy52YWx1ZUZpZWxkXV0gPSBjW3RoaXMudGV4dEZpZWxkXTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcjtcclxuICAgICAgICAgICAgICAgIH0sIHt9KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmopO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbiAgICB0b0pTT04odmFsOiBhbnkpIHtcclxuICAgICAgICBsZXQgZW51bURhdGEgPSBbXTtcclxuICAgICAgICBpZiAodmFsKSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICBlbnVtRGF0YSA9IEpTT04ucGFyc2UodmFsKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdXRUeXBlID09PSBFbnVtT3V0VHlwZS5vYmplY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZW51bURhdGEgPSB0aGlzLmNvbnZlcnRPYmplY3QyQXJyYXkoZW51bURhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBlbnVtRGF0YSA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUud2FybihlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBlbnVtRGF0YSA9IHZhbDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZW51bURhdGEgPSB0aGlzLmNvbnZlcnRPYmplY3QyQXJyYXkodmFsKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZW51bURhdGE7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjb252ZXJ0T2JqZWN0MkFycmF5KG9iajogYW55KSB7XHJcbiAgICAgICAgY29uc3QgX2VudW1EYXRhID0gW107XHJcbiAgICAgICAgT2JqZWN0LmtleXMob2JqKS5mb3JFYWNoKG4gPT4ge1xyXG4gICAgICAgICAgICBfZW51bURhdGEucHVzaCh7IFt0aGlzLnZhbHVlRmllbGRdOiBuLCBbdGhpcy50ZXh0RmllbGRdOiBvYmpbbl0gfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBfZW51bURhdGE7XHJcbiAgICB9XHJcbn1cclxuIl19