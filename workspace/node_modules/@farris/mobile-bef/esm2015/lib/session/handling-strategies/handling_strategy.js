/**
 * @fileoverview added by tsickle
 * Generated from: lib/session/handling-strategies/handling_strategy.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { BehaviorSubject, of, Subject } from 'rxjs';
import { switchMap, tap } from 'rxjs/operators';
import { BefHttpUtil } from '../../utils/index';
/**
 * BefSession处理策略类
 * @abstract
 */
class BefSessionHandlingStrategy {
    /**
     * 构造函数
     * @param {?} storageStrategy
     * @param {?} frmSessionService
     * @param {?} httpClient
     * @param {?} beBaseUrl
     */
    constructor(storageStrategy, frmSessionService, httpClient, beBaseUrl) {
        /**
         * BeSession是否存在
         */
        this.beSessionExisted = false;
        this.storageStrategy = storageStrategy;
        this.frmSessionService = frmSessionService;
        this.httpClient = httpClient;
        this.beBaseUrl = beBaseUrl;
        this.beCreateSessionUrl = `${beBaseUrl}/service/createsession`;
        this.beCloseSessionUrl = `${beBaseUrl}/service/closesession`;
        this.beSessionExisted$ = new BehaviorSubject(this.beSessionExisted);
    }
    /**
     * 框架SessionId（用户的或者功能菜单的）
     * @protected
     * @return {?}
     */
    get frmSessionId() {
        return this.frmSessionService.getCurrentSessionId();
    }
    /**
     * 获取框架SessionId
     * @return {?}
     */
    getFrameworkSessionId() {
        return this.frmSessionId;
    }
    /**
     * 从缓存中获取BeSession
     * @protected
     * @return {?}
     */
    getSessionIdFromStorage() {
        /** @type {?} */
        const sessionStorageKey = this.getSessionStorageKey();
        /** @type {?} */
        const beSessionId = this.storageStrategy.getItem(sessionStorageKey);
        return beSessionId;
    }
    /**
     * 创建BeSessionId
     * @protected
     * @return {?}
     */
    createSession() {
        /** @type {?} */
        const requestConfig = {
            responseType: 'text',
            headers: {
                'Content-Type': 'application/json'
            }
        };
        /** @type {?} */
        const frmSessionId = this.frmSessionId;
        if (frmSessionId) {
            requestConfig.headers = BefHttpUtil.appendSessionId(requestConfig.headers, this.frmSessionId);
            requestConfig.headers = BefHttpUtil.appendCafRuntimeCommonVariable(requestConfig.headers, this.frmSessionId);
        }
        //创建前判断当前的frmsessionid是不是在当前会话下被清除过
        /** @type {?} */
        const ClearItOnce = window.sessionStorage.getItem("ClearItOnce");
        if ('true' !== ClearItOnce && frmSessionId) {
            return this.clear(frmSessionId).pipe(switchMap((/**
             * @return {?}
             */
            () => {
                window.sessionStorage.setItem("ClearItOnce", 'true');
                return this.httpClient.post(this.beCreateSessionUrl, null, requestConfig).pipe(tap((/**
                 * @param {?} beSessionId
                 * @return {?}
                 */
                (beSessionId) => {
                    this.setSessionId(beSessionId);
                    this.setBesessionExisted(true);
                })));
            })));
        }
        return this.httpClient.post(this.beCreateSessionUrl, null, requestConfig).pipe(tap((/**
         * @param {?} beSessionId
         * @return {?}
         */
        (beSessionId) => {
            this.setSessionId(beSessionId);
            this.setBesessionExisted(true);
        })));
    }
    /**
     * @param {?} formToken
     * @return {?}
     */
    clear(formToken) {
        /** @type {?} */
        const subject = new Subject();
        if (formToken && window['frmMobileService']) {
            window['frmMobileService'].rtf.func.clearState({ formToken }, (/**
             * @return {?}
             */
            () => { subject.next(true); }));
        }
        return subject;
    }
    /**
     * @return {?}
     */
    test() {
        /** @type {?} */
        const requestConfig = {
            responseType: 'text',
            headers: {
                'Content-Type': 'application/json'
            }
        };
        if (this.frmSessionId) {
            requestConfig.headers = BefHttpUtil.appendSessionId(requestConfig.headers, this.frmSessionId);
            requestConfig.headers = BefHttpUtil.appendCafRuntimeCommonVariable(requestConfig.headers, this.frmSessionId);
        }
        return this.httpClient.post(this.beCreateSessionUrl, null, requestConfig).pipe(tap((/**
         * @param {?} beSessionId
         * @return {?}
         */
        (beSessionId) => {
            this.setSessionId(beSessionId);
            this.setBesessionExisted(true);
        })));
    }
    /**
     * 关闭BeSessionId
     * @protected
     * @return {?}
     */
    closeOldSession() {
        if (!this.oldBeSessionId) {
            return of(true);
        }
        /** @type {?} */
        const requestConfig = {
            responseType: 'text',
            headers: {
                'Content-Type': 'application/json'
            }
        };
        // headers处理
        requestConfig.headers = BefHttpUtil.appendCafRuntimeContext(requestConfig.headers, this.oldBeSessionId);
        requestConfig.headers = BefHttpUtil.appendSessionId(requestConfig.headers, this.oldBeSessionId);
        if (this.frmSessionId) {
            requestConfig.headers = BefHttpUtil.appendCafRuntimeCommonVariable(requestConfig.headers, this.frmSessionId);
        }
        // 无论是否成功，统一置空cleardBeSessionId
        return this.httpClient.post(this.beCloseSessionUrl, null, requestConfig).pipe(tap((/**
         * @return {?}
         */
        () => {
            this.oldBeSessionId = null;
            return of(true);
        }), (/**
         * @return {?}
         */
        () => {
            this.oldBeSessionId = null;
            return of(true);
        })));
    }
    /**
     * 设置BeSession存在状态，并发出通知
     * @protected
     * @param {?} beSessionExisted
     * @return {?}
     */
    setBesessionExisted(beSessionExisted) {
        if (this.beSessionExisted === beSessionExisted) {
            return;
        }
        this.beSessionExisted = beSessionExisted;
        this.beSessionExisted$.next(beSessionExisted);
    }
    /**
     * 获取BeSession是否存在状态
     * @return {?}
     */
    getBeSessionExisted() {
        return this.beSessionExisted$;
    }
}
if (false) {
    /**
     * 存储策略
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.storageStrategy;
    /**
     * 框架Session服务
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.frmSessionService;
    /**
     * Http客户端
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.httpClient;
    /**
     * 创建Session的的EAPI地址
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.beBaseUrl;
    /**
     * 创建BeSession接口地址
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.beCreateSessionUrl;
    /**
     * 关闭BeSession接口地址
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.beCloseSessionUrl;
    /**
     * 清空的BeSessionId
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.oldBeSessionId;
    /**
     * BeSession是否存在
     * @type {?}
     * @private
     */
    BefSessionHandlingStrategy.prototype.beSessionExisted;
    /**
     * BeSession是否存在流
     * @type {?}
     * @private
     */
    BefSessionHandlingStrategy.prototype.beSessionExisted$;
    /**
     * @abstract
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.getSessionId = function () { };
    /**
     * @abstract
     * @param {?} sessionId
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.setSessionId = function (sessionId) { };
    /**
     * @abstract
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.clearSessionId = function () { };
    /**
     * @abstract
     * @param {?} headers
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.handleRequestHeaders = function (headers) { };
    /**
     * @abstract
     * @param {?} headers
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.handleReponseHeaders = function (headers) { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.getSessionStorageKey = function () { };
}
export { BefSessionHandlingStrategy };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFuZGxpbmdfc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1iZWYvIiwic291cmNlcyI6WyJsaWIvc2Vzc2lvbi9oYW5kbGluZy1zdHJhdGVnaWVzL2hhbmRsaW5nX3N0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFjLGVBQWUsRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHaEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFDOzs7OztBQU9oRCxNQUFlLDBCQUEwQjs7Ozs7Ozs7SUF5RHZDLFlBQ0UsZUFBeUMsRUFBRSxpQkFBMEMsRUFDckYsVUFBc0IsRUFBRSxTQUFpQjs7OztRQVpuQyxxQkFBZ0IsR0FBRyxLQUFLLENBQUM7UUFjL0IsSUFBSSxDQUFDLGVBQWUsR0FBRyxlQUFlLENBQUM7UUFDdkMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLGlCQUFpQixDQUFDO1FBQzNDLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxHQUFHLFNBQVMsd0JBQXdCLENBQUM7UUFDL0QsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEdBQUcsU0FBUyx1QkFBdUIsQ0FBQztRQUM3RCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxlQUFlLENBQVUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDL0UsQ0FBQzs7Ozs7O0lBakNELElBQWMsWUFBWTtRQUN4QixPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO0lBQ3RELENBQUM7Ozs7O0lBMkNNLHFCQUFxQjtRQUMxQixPQUFPLElBQUksQ0FBQyxZQUFZ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YXZpb3JTdWJqZWN0LCBvZiwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBzd2l0Y2hNYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgSHR0cEhlYWRlcnMsIEh0dHBSZXF1ZXN0Q29uZmlnLCBIdHRwQ2xpZW50IH0gZnJvbSAnQGZhcnJpcy9tb2JpbGUtZGV2a2l0JztcclxuXHJcbmltcG9ydCB7IEJlZkh0dHBVdGlsIH0gZnJvbSAnLi4vLi4vdXRpbHMvaW5kZXgnO1xyXG5pbXBvcnQgeyBGcmFtZXdvcmtTZXNzaW9uU2VydmljZSB9IGZyb20gJy4uLy4uL2ZyYW1ld29ya19zZXNzaW9uX3NlcnZpY2UnO1xyXG5pbXBvcnQgeyBCZVNlc3Npb25TdG9yYWdlU3RyYXRlZ3kgfSBmcm9tICcuLi9zdG9yYWdlLXN0cmF0ZWdpZXMvaW5kZXgnO1xyXG5cclxuLyoqXHJcbiAqIEJlZlNlc3Npb27lpITnkIbnrZbnlaXnsbtcclxuICovXHJcbmFic3RyYWN0IGNsYXNzIEJlZlNlc3Npb25IYW5kbGluZ1N0cmF0ZWd5IHtcclxuXHJcbiAgLyoqXHJcbiAgICog5a2Y5YKo562W55WlXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHN0b3JhZ2VTdHJhdGVneTogQmVTZXNzaW9uU3RvcmFnZVN0cmF0ZWd5O1xyXG5cclxuICAvKipcclxuICAgKiDmoYbmnrZTZXNzaW9u5pyN5YqhXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGZybVNlc3Npb25TZXJ2aWNlOiBGcmFtZXdvcmtTZXNzaW9uU2VydmljZTtcclxuXHJcbiAgLyoqXHJcbiAgICogSHR0cOWuouaIt+err1xyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBodHRwQ2xpZW50OiBIdHRwQ2xpZW50O1xyXG5cclxuICAvKipcclxuICAgKiDliJvlu7pTZXNzaW9u55qE55qERUFQSeWcsOWdgFxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBiZUJhc2VVcmw6IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICog5Yib5bu6QmVTZXNzaW9u5o6l5Y+j5Zyw5Z2AXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGJlQ3JlYXRlU2Vzc2lvblVybDogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiDlhbPpl61CZVNlc3Npb27mjqXlj6PlnLDlnYBcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgYmVDbG9zZVNlc3Npb25Vcmw6IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICog5qGG5p62U2Vzc2lvbklk77yI55So5oi355qE5oiW6ICF5Yqf6IO96I+c5Y2V55qE77yJXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGdldCBmcm1TZXNzaW9uSWQoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLmZybVNlc3Npb25TZXJ2aWNlLmdldEN1cnJlbnRTZXNzaW9uSWQoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa4heepuueahEJlU2Vzc2lvbklkXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIG9sZEJlU2Vzc2lvbklkOiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIEJlU2Vzc2lvbuaYr+WQpuWtmOWcqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYmVTZXNzaW9uRXhpc3RlZCA9IGZhbHNlO1xyXG5cclxuICAvKipcclxuICAgKiBCZVNlc3Npb27mmK/lkKblrZjlnKjmtYFcclxuICAgKi9cclxuICBwcml2YXRlIGJlU2Vzc2lvbkV4aXN0ZWQkOiBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj47XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgc3RvcmFnZVN0cmF0ZWd5OiBCZVNlc3Npb25TdG9yYWdlU3RyYXRlZ3ksIGZybVNlc3Npb25TZXJ2aWNlOiBGcmFtZXdvcmtTZXNzaW9uU2VydmljZSxcclxuICAgIGh0dHBDbGllbnQ6IEh0dHBDbGllbnQsIGJlQmFzZVVybDogc3RyaW5nXHJcbiAgKSB7XHJcbiAgICB0aGlzLnN0b3JhZ2VTdHJhdGVneSA9IHN0b3JhZ2VTdHJhdGVneTtcclxuICAgIHRoaXMuZnJtU2Vzc2lvblNlcnZpY2UgPSBmcm1TZXNzaW9uU2VydmljZTtcclxuICAgIHRoaXMuaHR0cENsaWVudCA9IGh0dHBDbGllbnQ7XHJcbiAgICB0aGlzLmJlQmFzZVVybCA9IGJlQmFzZVVybDtcclxuICAgIHRoaXMuYmVDcmVhdGVTZXNzaW9uVXJsID0gYCR7YmVCYXNlVXJsfS9zZXJ2aWNlL2NyZWF0ZXNlc3Npb25gO1xyXG4gICAgdGhpcy5iZUNsb3NlU2Vzc2lvblVybCA9IGAke2JlQmFzZVVybH0vc2VydmljZS9jbG9zZXNlc3Npb25gO1xyXG4gICAgdGhpcy5iZVNlc3Npb25FeGlzdGVkJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4odGhpcy5iZVNlc3Npb25FeGlzdGVkKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhYnN0cmFjdCBnZXRTZXNzaW9uSWQoKTogT2JzZXJ2YWJsZTxzdHJpbmc+O1xyXG4gIHB1YmxpYyBhYnN0cmFjdCBzZXRTZXNzaW9uSWQoc2Vzc2lvbklkKTogdm9pZDtcclxuICBwdWJsaWMgYWJzdHJhY3QgY2xlYXJTZXNzaW9uSWQoKTogdm9pZDtcclxuICBwdWJsaWMgYWJzdHJhY3QgaGFuZGxlUmVxdWVzdEhlYWRlcnMoaGVhZGVyczogSHR0cEhlYWRlcnMpOiBIdHRwSGVhZGVycztcclxuICBwdWJsaWMgYWJzdHJhY3QgaGFuZGxlUmVwb25zZUhlYWRlcnMoaGVhZGVyczogSHR0cEhlYWRlcnMpOiB2b2lkO1xyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXRTZXNzaW9uU3RvcmFnZUtleSgpOiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluahhuaetlNlc3Npb25JZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRGcmFtZXdvcmtTZXNzaW9uSWQoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5mcm1TZXNzaW9uSWQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDku47nvJPlrZjkuK3ojrflj5ZCZVNlc3Npb25cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0U2Vzc2lvbklkRnJvbVN0b3JhZ2UoKSB7XHJcbiAgICBjb25zdCBzZXNzaW9uU3RvcmFnZUtleSA9IHRoaXMuZ2V0U2Vzc2lvblN0b3JhZ2VLZXkoKTtcclxuICAgIGNvbnN0IGJlU2Vzc2lvbklkID0gdGhpcy5zdG9yYWdlU3RyYXRlZ3kuZ2V0SXRlbShzZXNzaW9uU3RvcmFnZUtleSk7XHJcbiAgICByZXR1cm4gYmVTZXNzaW9uSWQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliJvlu7pCZVNlc3Npb25JZFxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBjcmVhdGVTZXNzaW9uKCk6IE9ic2VydmFibGU8c3RyaW5nPiB7XHJcbiAgICBjb25zdCByZXF1ZXN0Q29uZmlnOiBIdHRwUmVxdWVzdENvbmZpZyA9IHtcclxuICAgICAgcmVzcG9uc2VUeXBlOiAndGV4dCcsXHJcbiAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICBjb25zdCBmcm1TZXNzaW9uSWQgPSB0aGlzLmZybVNlc3Npb25JZDtcclxuICAgIGlmIChmcm1TZXNzaW9uSWQpIHtcclxuICAgICAgcmVxdWVzdENvbmZpZy5oZWFkZXJzID0gQmVmSHR0cFV0aWwuYXBwZW5kU2Vzc2lvbklkKHJlcXVlc3RDb25maWcuaGVhZGVycywgdGhpcy5mcm1TZXNzaW9uSWQpO1xyXG4gICAgICByZXF1ZXN0Q29uZmlnLmhlYWRlcnMgPSBCZWZIdHRwVXRpbC5hcHBlbmRDYWZSdW50aW1lQ29tbW9uVmFyaWFibGUocmVxdWVzdENvbmZpZy5oZWFkZXJzLCB0aGlzLmZybVNlc3Npb25JZCk7XHJcbiAgICB9XHJcbiAgICAvL+WIm+W7uuWJjeWIpOaWreW9k+WJjeeahGZybXNlc3Npb25pZOaYr+S4jeaYr+WcqOW9k+WJjeS8muivneS4i+iiq+a4hemZpOi/h1xyXG4gICAgY29uc3QgQ2xlYXJJdE9uY2UgPSB3aW5kb3cuc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShcIkNsZWFySXRPbmNlXCIpO1xyXG4gICAgaWYgKCd0cnVlJyAhPT0gQ2xlYXJJdE9uY2UgICYmIGZybVNlc3Npb25JZCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5jbGVhcihmcm1TZXNzaW9uSWQpLnBpcGUoXHJcbiAgICAgICAgc3dpdGNoTWFwKCgpID0+IHtcclxuICAgICAgICAgIHdpbmRvdy5zZXNzaW9uU3RvcmFnZS5zZXRJdGVtKFwiQ2xlYXJJdE9uY2VcIiwgJ3RydWUnKTtcclxuICAgICAgICAgIHJldHVybiB0aGlzLmh0dHBDbGllbnQucG9zdCh0aGlzLmJlQ3JlYXRlU2Vzc2lvblVybCwgbnVsbCwgcmVxdWVzdENvbmZpZykucGlwZShcclxuICAgICAgICAgICAgdGFwKChiZVNlc3Npb25JZDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgdGhpcy5zZXRTZXNzaW9uSWQoYmVTZXNzaW9uSWQpO1xyXG4gICAgICAgICAgICAgIHRoaXMuc2V0QmVzZXNzaW9uRXhpc3RlZCh0cnVlKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICk7XHJcblxyXG4gICAgICAgIH0pXHJcbiAgICAgIClcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGhpcy5odHRwQ2xpZW50LnBvc3QodGhpcy5iZUNyZWF0ZVNlc3Npb25VcmwsIG51bGwsIHJlcXVlc3RDb25maWcpLnBpcGUoXHJcbiAgICAgIHRhcCgoYmVTZXNzaW9uSWQ6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIHRoaXMuc2V0U2Vzc2lvbklkKGJlU2Vzc2lvbklkKTtcclxuICAgICAgICB0aGlzLnNldEJlc2Vzc2lvbkV4aXN0ZWQodHJ1ZSk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgY2xlYXIoZm9ybVRva2VuKSB7XHJcbiAgICBjb25zdCBzdWJqZWN0ID0gbmV3IFN1YmplY3QoKTtcclxuICAgIGlmIChmb3JtVG9rZW4gJiYgd2luZG93Wydmcm1Nb2JpbGVTZXJ2aWNlJ10pIHtcclxuICAgICAgd2luZG93Wydmcm1Nb2JpbGVTZXJ2aWNlJ10ucnRmLmZ1bmMuY2xlYXJTdGF0ZSh7IGZvcm1Ub2tlbiB9LCAoKSA9PiB7IHN1YmplY3QubmV4dCh0cnVlKSB9LClcclxuICAgIH1cclxuICAgIHJldHVybiBzdWJqZWN0O1xyXG4gIH1cclxuXHJcbiAgdGVzdCgpIHtcclxuICAgIGNvbnN0IHJlcXVlc3RDb25maWc6IEh0dHBSZXF1ZXN0Q29uZmlnID0ge1xyXG4gICAgICByZXNwb25zZVR5cGU6ICd0ZXh0JyxcclxuICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBpZiAodGhpcy5mcm1TZXNzaW9uSWQpIHtcclxuICAgICAgcmVxdWVzdENvbmZpZy5oZWFkZXJzID0gQmVmSHR0cFV0aWwuYXBwZW5kU2Vzc2lvbklkKHJlcXVlc3RDb25maWcuaGVhZGVycywgdGhpcy5mcm1TZXNzaW9uSWQpO1xyXG4gICAgICByZXF1ZXN0Q29uZmlnLmhlYWRlcnMgPSBCZWZIdHRwVXRpbC5hcHBlbmRDYWZSdW50aW1lQ29tbW9uVmFyaWFibGUocmVxdWVzdENvbmZpZy5oZWFkZXJzLCB0aGlzLmZybVNlc3Npb25JZCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuaHR0cENsaWVudC5wb3N0KHRoaXMuYmVDcmVhdGVTZXNzaW9uVXJsLCBudWxsLCByZXF1ZXN0Q29uZmlnKS5waXBlKFxyXG4gICAgICB0YXAoKGJlU2Vzc2lvbklkOiBzdHJpbmcpID0+IHtcclxuICAgICAgICB0aGlzLnNldFNlc3Npb25JZChiZVNlc3Npb25JZCk7XHJcbiAgICAgICAgdGhpcy5zZXRCZXNlc3Npb25FeGlzdGVkKHRydWUpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWFs+mXrUJlU2Vzc2lvbklkXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGNsb3NlT2xkU2Vzc2lvbigpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIGlmICghdGhpcy5vbGRCZVNlc3Npb25JZCkge1xyXG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcmVxdWVzdENvbmZpZzogSHR0cFJlcXVlc3RDb25maWcgPSB7XHJcbiAgICAgIHJlc3BvbnNlVHlwZTogJ3RleHQnLFxyXG4gICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGhlYWRlcnPlpITnkIZcclxuICAgIHJlcXVlc3RDb25maWcuaGVhZGVycyA9IEJlZkh0dHBVdGlsLmFwcGVuZENhZlJ1bnRpbWVDb250ZXh0KHJlcXVlc3RDb25maWcuaGVhZGVycywgdGhpcy5vbGRCZVNlc3Npb25JZCk7XHJcbiAgICByZXF1ZXN0Q29uZmlnLmhlYWRlcnMgPSBCZWZIdHRwVXRpbC5hcHBlbmRTZXNzaW9uSWQocmVxdWVzdENvbmZpZy5oZWFkZXJzLCB0aGlzLm9sZEJlU2Vzc2lvbklkKTtcclxuICAgIGlmICh0aGlzLmZybVNlc3Npb25JZCkge1xyXG4gICAgICByZXF1ZXN0Q29uZmlnLmhlYWRlcnMgPSBCZWZIdHRwVXRpbC5hcHBlbmRDYWZSdW50aW1lQ29tbW9uVmFyaWFibGUocmVxdWVzdENvbmZpZy5oZWFkZXJzLCB0aGlzLmZybVNlc3Npb25JZCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5peg6K665piv5ZCm5oiQ5Yqf77yM57uf5LiA572u56m6Y2xlYXJkQmVTZXNzaW9uSWRcclxuICAgIHJldHVybiB0aGlzLmh0dHBDbGllbnQucG9zdCh0aGlzLmJlQ2xvc2VTZXNzaW9uVXJsLCBudWxsLCByZXF1ZXN0Q29uZmlnKS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5vbGRCZVNlc3Npb25JZCA9IG51bGw7XHJcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLm9sZEJlU2Vzc2lvbklkID0gbnVsbDtcclxuICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDorr7nva5CZVNlc3Npb27lrZjlnKjnirbmgIHvvIzlubblj5Hlh7rpgJrnn6VcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgc2V0QmVzZXNzaW9uRXhpc3RlZChiZVNlc3Npb25FeGlzdGVkOiBib29sZWFuKSB7XHJcbiAgICBpZiAodGhpcy5iZVNlc3Npb25FeGlzdGVkID09PSBiZVNlc3Npb25FeGlzdGVkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuYmVTZXNzaW9uRXhpc3RlZCA9IGJlU2Vzc2lvbkV4aXN0ZWQ7XHJcbiAgICB0aGlzLmJlU2Vzc2lvbkV4aXN0ZWQkLm5leHQoYmVTZXNzaW9uRXhpc3RlZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5ZCZVNlc3Npb27mmK/lkKblrZjlnKjnirbmgIFcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0QmVTZXNzaW9uRXhpc3RlZCgpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIHJldHVybiB0aGlzLmJlU2Vzc2lvbkV4aXN0ZWQkO1xyXG4gIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCB7IEJlZlNlc3Npb25IYW5kbGluZ1N0cmF0ZWd5IH07XHJcbiJdfQ==