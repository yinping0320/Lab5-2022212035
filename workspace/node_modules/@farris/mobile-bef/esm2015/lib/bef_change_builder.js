/**
 * @fileoverview added by tsickle
 * Generated from: lib/bef_change_builder.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ModifyType } from '@farris/mobile-devkit';
import { ChangeDetailType } from './types';
import { EntityUtil } from './utils/index';
/**
 * BEF变更集构造器
 */
class BefChangeBuilder {
    /**
     * 构造函数
     * @param {?} entityType 实体类型
     * @param {?} entityCollection
     */
    constructor(entityType, entityCollection) {
        this.entityType = entityType;
        this.entityCollection = entityCollection;
    }
    /**
     * 构造Bef变更集
     * @param {?} modifications
     * @return {?}
     */
    build(modifications) {
        // 重置changeDetail
        this.changeDetail = {
            ChangeType: ChangeDetailType.Modify,
            ChangeInfo: {
                DataId: ''
            }
        };
        modifications.forEach((/**
         * @param {?} modification
         * @return {?}
         */
        modification => {
            this.buildChangeDetail(modification);
        }));
        return this.changeDetail;
    }
    /**
     * 构造Bef变更详情
     * @param {?} modification
     * @return {?}
     */
    buildChangeDetail(modification) {
        /** @type {?} */
        const paths = modification.path.concat();
        // 设置根节点DataId
        if (!this.changeDetail.ChangeInfo.DataId) {
            this.changeDetail.ChangeInfo.DataId = paths[0].split(':')[1];
        }
        /** @type {?} */
        let parentChangeDetail = this.changeDetail;
        /** @type {?} */
        let parentEntityType = this.entityType;
        for (let i = 1; i < paths.length && parentChangeDetail; i = i + 2) {
            /** @type {?} */
            const parentChangeInfo = this.getChangeInfo(parentChangeDetail);
            /** @type {?} */
            const propName = paths[i];
            const { propType, propEntityType, propMetadata } = EntityUtil.getPropInfo(parentEntityType, propName);
            /** @type {?} */
            const dataField = propMetadata.dataField || propName;
            if (propType === 'NgField') {
                // 不支持主键变更，忽略
                /** @type {?} */
                const primaryKey = EntityUtil.getPrimaryKey(parentEntityType);
                if (propName === primaryKey) {
                    continue;
                }
                if (modification.type !== ModifyType.ValueChange) {
                    throw Error('简单类型的属性上不支持ValueChange类型之外的变更');
                }
                // NgField类型：说明是最后一级
                parentChangeInfo[dataField] = modification.value;
                parentChangeDetail = null;
            }
            else if (propType === 'NgObject') {
                // NgObject属性本身无法触发变更，只有它的子节点才能触发，所以它上边的变更永远是Modify类型的。
                /** @type {?} */
                const childId = paths[i + 1].split(':')[1];
                /** @type {?} */
                const childIdName = paths[i + 1].split(':')[0];
                if (childIdName) {
                    // 有主键（关联对象）：是一个普通的对象
                    /** @type {?} */
                    let changeObject = parentChangeInfo[dataField];
                    // 获取数据
                    /** @type {?} */
                    const entityPath = paths.slice(0, i + 1);
                    /** @type {?} */
                    const changedEntity = this.entityCollection.getEntityByPath(entityPath);
                    changeObject = changedEntity ? changedEntity.toJSON() : {};
                    parentChangeInfo[dataField] = changeObject;
                    parentChangeDetail = null;
                    parentEntityType = null;
                }
                else {
                    // 没有主键（值对象）：是一个完整的ChangeDetail
                    /** @type {?} */
                    let changeDetail = (/** @type {?} */ (parentChangeInfo[dataField]));
                    if (!changeDetail) {
                        changeDetail = {
                            ChangeType: ChangeDetailType.Modify,
                            ChangeInfo: {}
                        };
                    }
                    parentChangeInfo[dataField] = changeDetail;
                    parentChangeDetail = changeDetail;
                    parentEntityType = propEntityType;
                }
            }
            else if (propType === 'NgList') {
                // 如果不存在则创建一个空数组
                if (!parentChangeDetail.ChangeInfo[dataField]) {
                    parentChangeDetail.ChangeInfo[dataField] = [];
                }
                /** @type {?} */
                const changeDetails = (/** @type {?} */ (parentChangeDetail.ChangeInfo[dataField]));
                // 如果这个属性，不是叶子节点，需要查找当前属性是否已经存在对应ChangeDetail：
                // 1、不存在：创建一个Modify类型的ChangeDetail；
                // 2、存在：返回查找到的ChangeDetai，这个ChangeDetail可能是一个Add类型也可能是一个Modify类型；
                // 3、现状：目前BEF不支持Add类型的变更，肯定是一个Modify类型的变更。
                if (i !== paths.length - 1) {
                    // 遍历检查变更是否已经存在
                    /** @type {?} */
                    const dataId = paths[i + 1].split(':')[1];
                    /** @type {?} */
                    let changeDetail = changeDetails.find((/**
                     * @param {?} changeDetailItem
                     * @return {?}
                     */
                    changeDetailItem => {
                        return changeDetailItem.ChangeInfo.DataId === dataId;
                    }));
                    // 如果不存在，则创建并添加
                    if (!changeDetail) {
                        changeDetail = this.createEmptyChangeDetail(ChangeDetailType.Modify, dataId);
                        changeDetails.push(changeDetail);
                    }
                    parentChangeDetail = changeDetail;
                    parentEntityType = propEntityType;
                    continue;
                }
                // 重置
                parentChangeDetail = null;
                parentEntityType = null;
            }
            else if (propType === 'NgDynamic') {
                // 获取数据
                /** @type {?} */
                const entityPath = paths.slice(0, i + 1);
                /** @type {?} */
                const changedEntity = this.entityCollection.getEntityByPath(entityPath);
                parentChangeInfo[dataField] = {
                    ChangeType: ChangeDetailType.Modify,
                    ChangeInfo: changedEntity ? changedEntity.toJSON() : {}
                };
                parentChangeDetail = null;
                parentEntityType = null;
            }
        }
    }
    /**
     * 获取变更信息
     * 在整个ChangeDetail树上，存在两种类型的节点
     * ChangeDetail：实体变更、值对象变更（没有DataID）
     * PlainObject: 关联对象的变更
     * 从这两种节点上拿具体变更信息的时候，需要统一处理，屏蔽这个差异。
     * \@todo：为这两种节点封装ChangeNode基类来解决这个差异。
     * @private
     * @param {?} changeDetail
     * @return {?}
     */
    getChangeInfo(changeDetail) {
        // @todo：可能存在同名属性
        if (changeDetail.hasOwnProperty('ChangeInfo')) {
            return changeDetail.ChangeInfo;
        }
        else {
            return changeDetail;
        }
    }
    /**
     * 创建ChangeDetail
     * @private
     * @param {?} type BEF变更类型
     * @param {?} dataId 数据内码
     * @return {?}
     */
    createEmptyChangeDetail(type, dataId) {
        /** @type {?} */
        const changeDetail = {
            ChangeType: type,
            ChangeInfo: {
                DataId: dataId
            }
        };
        return changeDetail;
    }
}
if (false) {
    /**
     * Bef变更集
     * @type {?}
     */
    BefChangeBuilder.prototype.changeDetail;
    /**
     * @type {?}
     * @private
     */
    BefChangeBuilder.prototype.entityType;
    /**
     * @type {?}
     * @private
     */
    BefChangeBuilder.prototype.entityCollection;
}
export { BefChangeBuilder };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVmX2NoYW5nZV9idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtYmVmLyIsInNvdXJjZXMiOlsibGliL2JlZl9jaGFuZ2VfYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBc0IsVUFBVSxFQUE0QixNQUFNLHVCQUF1QixDQUFDO0FBQ2pHLE9BQU8sRUFBRSxnQkFBZ0IsRUFBZ0IsTUFBTSxTQUFTLENBQUM7QUFDekQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQzs7OztBQU0zQyxNQUFNLGdCQUFnQjs7Ozs7O0lBV3BCLFlBQ1UsVUFBd0IsRUFDeEIsZ0JBQTBDO1FBRDFDLGVBQVUsR0FBVixVQUFVLENBQWM7UUFDeEIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUEwQjtJQUVwRCxDQUFDOzs7Ozs7SUFLTSxLQUFLLENBQUMsYUFBNkI7UUFFeEMsaUJBQWlCO1FBQ2pCLElBQUksQ0FBQyxZQUFZLEdBQUc7WUFDbEIsVUFBVSxFQUFFLGdCQUFnQixDQUFDLE1BQU07WUFDbkMsVUFBVSxFQUFFO2dCQUNWLE1BQU0sRUFBRSxFQUFFO2FBQ1g7U0FDRixDQUFDO1FBRUYsYUFBYSxDQUFDLE9BQU87Ozs7UUFBQyxZQUFZLENBQUMsRUFBRTtZQUNuQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDdkMsQ0FBQyxFQUFDLENBQUM7UUFDSCxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7SUFDM0IsQ0FBQzs7Ozs7O0lBS00saUJBQWlCLENBQUMsWUFBMEI7O2NBRTNDLEtBQUssR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtRQUV4QyxjQUFjO1FBQ2QsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRTtZQUN4QyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFD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Q0FBQyxTQUFTLENBQUMsR0FBRztvQkFDNUIsVUFBVSxFQUFFLGdCQUFnQixDQUFDLE1BQU07b0JBQ25DLFVBQVUsRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRTtpQkFDeEQsQ0FBQztnQkFDRixrQkFBa0IsR0FBRyxJQUFJLENBQUM7Z0JBQzFCLGdCQUFnQixHQUFHLElBQUksQ0FBQzthQUN6QjtTQUNGO0lBQ0gsQ0FBQzs7Ozs7Ozs7Ozs7O0lBV08sYUFBYSxDQUFDLFlBQWlCO1FBRXJDLGlCQUFpQjtRQUNqQixJQUFJLFlBQVksQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDN0MsT0FBTyxZQUFZLENBQUMsVUFBVSxDQUFDO1NBQ2hDO2FBQU07WUFDTCxPQUFPLFlBQVksQ0FBQztTQUNyQjtJQUNILENBQUM7Ozs7Ozs7O0lBUU8sdUJBQXVCLENBQUMsSUFBc0IsRUFBRSxNQUFjOztjQUM5RCxZQUFZLEdBQWlCO1lBQ2pDLFVBQVUsRUFBRSxJQUFJO1lBQ2hCLFVBQVUsRUFBRTtnQkFDVixNQUFNLEVBQUUsTUFBTTthQUNmO1NBQ0Y7UUFDRCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDO0NBRUY7Ozs7OztJQTNMQyx3Q0FBa0M7Ozs7O0lBT2hDLHNDQUFnQzs7Ozs7SUFDaEMsNENBQWtEOztBQXFMdEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUeXBlLCBNb2RpZmljYXRpb24sIE1vZGlmeVR5cGUsIEVudGl0eSwgRW50aXR5Q29sbGVjdGlvbiB9IGZyb20gJ0BmYXJyaXMvbW9iaWxlLWRldmtpdCc7XHJcbmltcG9ydCB7IENoYW5nZURldGFpbFR5cGUsIENoYW5nZURldGFpbCB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBFbnRpdHlVdGlsIH0gZnJvbSAnLi91dGlscy9pbmRleCc7XHJcblxyXG5cclxuLyoqXHJcbiAqIEJFRuWPmOabtOmbhuaehOmAoOWZqFxyXG4gKi9cclxuY2xhc3MgQmVmQ2hhbmdlQnVpbGRlciB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEJlZuWPmOabtOmbhlxyXG4gICAqL1xyXG4gIHB1YmxpYyBjaGFuZ2VEZXRhaWw6IENoYW5nZURldGFpbDtcclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICogQHBhcmFtIGVudGl0eVR5cGUg5a6e5L2T57G75Z6LXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGVudGl0eVR5cGU6IFR5cGU8RW50aXR5PixcclxuICAgIHByaXZhdGUgZW50aXR5Q29sbGVjdGlvbjogRW50aXR5Q29sbGVjdGlvbjxFbnRpdHk+XHJcbiAgKSB7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKBCZWblj5jmm7Tpm4ZcclxuICAgKi9cclxuICBwdWJsaWMgYnVpbGQobW9kaWZpY2F0aW9uczogTW9kaWZpY2F0aW9uW10pOiBDaGFuZ2VEZXRhaWwge1xyXG5cclxuICAgIC8vIOmHjee9rmNoYW5nZURldGFpbFxyXG4gICAgdGhpcy5jaGFuZ2VEZXRhaWwgPSB7XHJcbiAgICAgIENoYW5nZVR5cGU6IENoYW5nZURldGFpbFR5cGUuTW9kaWZ5LFxyXG4gICAgICBDaGFuZ2VJbmZvOiB7XHJcbiAgICAgICAgRGF0YUlkOiAnJ1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIG1vZGlmaWNhdGlvbnMuZm9yRWFjaChtb2RpZmljYXRpb24gPT4ge1xyXG4gICAgICB0aGlzLmJ1aWxkQ2hhbmdlRGV0YWlsKG1vZGlmaWNhdGlvbik7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0aGlzLmNoYW5nZURldGFpbDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoEJlZuWPmOabtOivpuaDhVxyXG4gICAqL1xyXG4gIHB1YmxpYyBidWlsZENoYW5nZURldGFpbChtb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbikge1xyXG5cclxuICAgIGNvbnN0IHBhdGhzID0gbW9kaWZpY2F0aW9uLnBhdGguY29uY2F0KCk7XHJcblxyXG4gICAgLy8g6K6+572u5qC56IqC54K5RGF0YUlkXHJcbiAgICBpZiAoIXRoaXMuY2hhbmdlRGV0YWlsLkNoYW5nZUluZm8uRGF0YUlkKSB7XHJcbiAgICAgIHRoaXMuY2hhbmdlRGV0YWlsLkNoYW5nZUluZm8uRGF0YUlkID0gcGF0aHNbMF0uc3BsaXQoJzonKVsxXTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgcGFyZW50Q2hhbmdlRGV0YWlsID0gdGhpcy5jaGFuZ2VEZXRhaWw7XHJcbiAgICBsZXQgcGFyZW50RW50aXR5VHlwZSA9IHRoaXMuZW50aXR5VHlwZTtcclxuXHJcbiAgICBmb3IgKGxldCBpID0gMTsgaSA8IHBhdGhzLmxlbmd0aCAmJiBwYXJlbnRDaGFuZ2VEZXRhaWw7IGkgPSBpICsgMikge1xyXG5cclxuICAgICAgY29uc3QgcGFyZW50Q2hhbmdlSW5mbyA9IHRoaXMuZ2V0Q2hhbmdlSW5mbyhwYXJlbnRDaGFuZ2VEZXRhaWwpO1xyXG4gICAgICBjb25zdCBwcm9wTmFtZSA9IHBhdGhzW2ldO1xyXG4gICAgICBjb25zdCB7IHByb3BUeXBlLCBwcm9wRW50aXR5VHlwZSwgcHJvcE1ldGFkYXRhIH0gPSBFbnRpdHlVdGlsLmdldFByb3BJbmZvKHBhcmVudEVudGl0eVR5cGUsIHByb3BOYW1lKTtcclxuICAgICAgY29uc3QgZGF0YUZpZWxkID0gcHJvcE1ldGFkYXRhLmRhdGFGaWVsZCB8fCBwcm9wTmFtZTtcclxuXHJcbiAgICAgIGlmIChwcm9wVHlwZSA9PT0gJ05nRmllbGQnKSB7XHJcblxyXG4gICAgICAgIC8vIOS4jeaUr+aMgeS4u+mUruWPmOabtO+8jOW/veeVpVxyXG4gICAgICAgIGNvbnN0IHByaW1hcnlLZXkgPSBFbnRpdHlVdGlsLmdldFByaW1hcnlLZXkocGFyZW50RW50aXR5VHlwZSk7XHJcbiAgICAgICAgaWYgKHByb3BOYW1lID09PSBwcmltYXJ5S2V5KSB7XHJcbiAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChtb2RpZmljYXRpb24udHlwZSAhPT0gTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZSkge1xyXG4gICAgICAgICAgdGhyb3cgRXJyb3IoJ+eugOWNleexu+Wei+eahOWxnuaAp+S4iuS4jeaUr+aMgVZhbHVlQ2hhbmdl57G75Z6L5LmL5aSW55qE5Y+Y5pu0Jyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBOZ0ZpZWxk57G75Z6L77ya6K+05piO5piv5pyA5ZCO5LiA57qnXHJcbiAgICAgICAgcGFyZW50Q2hhbmdlSW5mb1tkYXRhRmllbGRdID0gbW9kaWZpY2F0aW9uLnZhbHVlO1xyXG4gICAgICAgIHBhcmVudENoYW5nZURldGFpbCA9IG51bGw7XHJcblxyXG4gICAgICB9IGVsc2UgaWYgKHByb3BUeXBlID09PSAnTmdPYmplY3QnKSB7XHJcblxyXG4gICAgICAgIC8vIE5nT2JqZWN05bGe5oCn5pys6Lqr5peg5rOV6Kem5Y+R5Y+Y5pu077yM5Y+q5pyJ5a6D55qE5a2Q6IqC54K55omN6IO96Kem5Y+R77yM5omA5Lul5a6D5LiK6L6555qE5Y+Y5pu05rC46L+c5pivTW9kaWZ557G75Z6L55qE44CCXHJcbiAgICAgICAgY29uc3QgY2hpbGRJZCA9IHBhdGhzW2kgKyAxXS5zcGxpdCgnOicpWzFdO1xyXG4gICAgICAgIGNvbnN0IGNoaWxkSWROYW1lID0gcGF0aHNbaSArIDFdLnNwbGl0KCc6JylbMF07XHJcblxyXG4gICAgICAgIGlmIChjaGlsZElkTmFtZSkge1xyXG5cclxuICAgICAgICAgIC8vIOacieS4u+mUru+8iOWFs+iBlOWvueixoe+8ie+8muaYr+S4gOS4quaZrumAmueahOWvueixoVxyXG4gICAgICAgICAgbGV0IGNoYW5nZU9iamVjdCA9IHBhcmVudENoYW5nZUluZm9bZGF0YUZpZWxkXTtcclxuXHJcbiAgICAgICAgICAvLyDojrflj5bmlbDmja5cclxuICAgICAgICAgIGNvbnN0IGVudGl0eVBhdGggPSBwYXRocy5zbGljZSgwLCBpICsgMSk7XHJcbiAgICAgICAgICBjb25zdCBjaGFuZ2VkRW50aXR5ID0gdGhpcy5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0eUJ5UGF0aChlbnRpdHlQYXRoKTtcclxuICAgICAgICAgIGNoYW5nZU9iamVjdCA9IGNoYW5nZWRFbnRpdHkgPyBjaGFuZ2VkRW50aXR5LnRvSlNPTigpIDoge307XHJcbiAgICAgICAgICBwYXJlbnRDaGFuZ2VJbmZvW2RhdGFGaWVsZF0gPSBjaGFuZ2VPYmplY3Q7XHJcbiAgICAgICAgICBwYXJlbnRDaGFuZ2VEZXRhaWwgPSBudWxsO1xyXG4gICAgICAgICAgcGFyZW50RW50aXR5VHlwZSA9IG51bGw7XHJcblxyXG4gICAgICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICAgICAgLy8g5rKh5pyJ5Li76ZSu77yI5YC85a+56LGh77yJ77ya5piv5LiA5Liq5a6M5pW055qEQ2hhbmdlRGV0YWlsXHJcbiAgICAgICAgICBsZXQgY2hhbmdlRGV0YWlsID0gcGFyZW50Q2hhbmdlSW5mb1tkYXRhRmllbGRdIGFzIENoYW5nZURldGFpbDtcclxuICAgICAgICAgIGlmICghY2hhbmdlRGV0YWlsKSB7XHJcbiAgICAgICAgICAgIGNoYW5nZURldGFpbCA9IHtcclxuICAgICAgICAgICAgICBDaGFuZ2VUeXBlOiBDaGFuZ2VEZXRhaWxUeXBlLk1vZGlmeSxcclxuICAgICAgICAgICAgICBDaGFuZ2VJbmZvOiB7fVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcGFyZW50Q2hhbmdlSW5mb1tkYXRhRmllbGRdID0gY2hhbmdlRGV0YWlsO1xyXG4gICAgICAgICAgcGFyZW50Q2hhbmdlRGV0YWlsID0gY2hhbmdlRGV0YWlsO1xyXG4gICAgICAgICAgcGFyZW50RW50aXR5VHlwZSA9IHByb3BFbnRpdHlUeXBlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgIH0gZWxzZSBpZiAocHJvcFR5cGUgPT09ICdOZ0xpc3QnKSB7XHJcblxyXG4gICAgICAgIC8vIOWmguaenOS4jeWtmOWcqOWImeWIm+W7uuS4gOS4quepuuaVsOe7hFxyXG4gICAgICAgIGlmICghcGFyZW50Q2hhbmdlRGV0YWlsLkNoYW5nZUluZm9bZGF0YUZpZWxkXSkge1xyXG4gICAgICAgICAgcGFyZW50Q2hhbmdlRGV0YWlsLkNoYW5nZUluZm9bZGF0YUZpZWxkXSA9IFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBjaGFuZ2VEZXRhaWxzID0gcGFyZW50Q2hhbmdlRGV0YWlsLkNoYW5nZUluZm9bZGF0YUZpZWxkXSBhcyBDaGFuZ2VEZXRhaWxbXTtcclxuXHJcbiAgICAgICAgLy8g5aaC5p6c6L+Z5Liq5bGe5oCn77yM5LiN5piv5Y+25a2Q6IqC54K577yM6ZyA6KaB5p+l5om+5b2T5YmN5bGe5oCn5piv5ZCm5bey57uP5a2Y5Zyo5a+55bqUQ2hhbmdlRGV0YWls77yaXHJcbiAgICAgICAgLy8gMeOAgeS4jeWtmOWcqO+8muWIm+W7uuS4gOS4qk1vZGlmeeexu+Wei+eahENoYW5nZURldGFpbO+8m1xyXG4gICAgICAgIC8vIDLjgIHlrZjlnKjvvJrov5Tlm57mn6Xmib7liLDnmoRDaGFuZ2VEZXRhae+8jOi/meS4qkNoYW5nZURldGFpbOWPr+iDveaYr+S4gOS4qkFkZOexu+Wei+S5n+WPr+iDveaYr+S4gOS4qk1vZGlmeeexu+Wei++8m1xyXG4gICAgICAgIC8vIDPjgIHnjrDnirbvvJrnm67liY1CRUbkuI3mlK/mjIFBZGTnsbvlnovnmoTlj5jmm7TvvIzogq/lrprmmK/kuIDkuKpNb2RpZnnnsbvlnovnmoTlj5jmm7TjgIJcclxuICAgICAgICBpZiAoaSAhPT0gcGF0aHMubGVuZ3RoIC0gMSkge1xyXG5cclxuICAgICAgICAgIC8vIOmBjeWOhuajgOafpeWPmOabtOaYr+WQpuW3sue7j+WtmOWcqFxyXG4gICAgICAgICAgY29uc3QgZGF0YUlkID0gcGF0aHNbaSArIDFdLnNwbGl0KCc6JylbMV07XHJcblxyXG4gICAgICAgICAgbGV0IGNoYW5nZURldGFpbCA9IGNoYW5nZURldGFpbHMuZmluZChjaGFuZ2VEZXRhaWxJdGVtID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGNoYW5nZURldGFpbEl0ZW0uQ2hhbmdlSW5mby5EYXRhSWQgPT09IGRhdGFJZDtcclxuICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgIC8vIOWmguaenOS4jeWtmOWcqO+8jOWImeWIm+W7uuW5tua3u+WKoFxyXG4gICAgICAgICAgaWYgKCFjaGFuZ2VEZXRhaWwpIHtcclxuICAgICAgICAgICAgY2hhbmdlRGV0YWlsID0gdGhpcy5jcmVhdGVFbXB0eUNoYW5nZURldGFpbChDaGFuZ2VEZXRhaWxUeXBlLk1vZGlmeSwgZGF0YUlkKTtcclxuICAgICAgICAgICAgY2hhbmdlRGV0YWlscy5wdXNoKGNoYW5nZURldGFpbCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBwYXJlbnRDaGFuZ2VEZXRhaWwgPSBjaGFuZ2VEZXRhaWw7XHJcbiAgICAgICAgICBwYXJlbnRFbnRpdHlUeXBlID0gcHJvcEVudGl0eVR5cGU7XHJcbiAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOmHjee9rlxyXG4gICAgICAgIHBhcmVudENoYW5nZURldGFpbCA9IG51bGw7XHJcbiAgICAgICAgcGFyZW50RW50aXR5VHlwZSA9IG51bGw7XHJcblxyXG4gICAgICB9IGVsc2UgaWYgKHByb3BUeXBlID09PSAnTmdEeW5hbWljJykge1xyXG4gICAgICAgIC8vIOiOt+WPluaVsOaNrlxyXG4gICAgICAgIGNvbnN0IGVudGl0eVBhdGggPSBwYXRocy5zbGljZSgwLCBpICsgMSk7XHJcbiAgICAgICAgY29uc3QgY2hhbmdlZEVudGl0eSA9IHRoaXMuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdHlCeVBhdGgoZW50aXR5UGF0aCk7XHJcbiAgICAgICAgcGFyZW50Q2hhbmdlSW5mb1tkYXRhRmllbGRdID0ge1xyXG4gICAgICAgICAgQ2hhbmdlVHlwZTogQ2hhbmdlRGV0YWlsVHlwZS5Nb2RpZnksXHJcbiAgICAgICAgICBDaGFuZ2VJbmZvOiBjaGFuZ2VkRW50aXR5ID8gY2hhbmdlZEVudGl0eS50b0pTT04oKSA6IHt9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBwYXJlbnRDaGFuZ2VEZXRhaWwgPSBudWxsO1xyXG4gICAgICAgIHBhcmVudEVudGl0eVR5cGUgPSBudWxsO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5Y+Y5pu05L+h5oGvXHJcbiAgICog5Zyo5pW05LiqQ2hhbmdlRGV0YWls5qCR5LiK77yM5a2Y5Zyo5Lik56eN57G75Z6L55qE6IqC54K5XHJcbiAgICogQ2hhbmdlRGV0YWls77ya5a6e5L2T5Y+Y5pu044CB5YC85a+56LGh5Y+Y5pu077yI5rKh5pyJRGF0YUlE77yJXHJcbiAgICogUGxhaW5PYmplY3Q6IOWFs+iBlOWvueixoeeahOWPmOabtFxyXG4gICAqIOS7jui/meS4pOenjeiKgueCueS4iuaLv+WFt+S9k+WPmOabtOS/oeaBr+eahOaXtuWAme+8jOmcgOimgee7n+S4gOWkhOeQhu+8jOWxj+iUvei/meS4quW3ruW8guOAglxyXG4gICAqIEB0b2Rv77ya5Li66L+Z5Lik56eN6IqC54K55bCB6KOFQ2hhbmdlTm9kZeWfuuexu+adpeino+WGs+i/meS4quW3ruW8guOAglxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Q2hhbmdlSW5mbyhjaGFuZ2VEZXRhaWw6IGFueSk6IGFueSB7XHJcblxyXG4gICAgLy8gQHRvZG/vvJrlj6/og73lrZjlnKjlkIzlkI3lsZ7mgKdcclxuICAgIGlmIChjaGFuZ2VEZXRhaWwuaGFzT3duUHJvcGVydHkoJ0NoYW5nZUluZm8nKSkge1xyXG4gICAgICByZXR1cm4gY2hhbmdlRGV0YWlsLkNoYW5nZUluZm87XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gY2hhbmdlRGV0YWlsO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOWIm+W7ukNoYW5nZURldGFpbFxyXG4gICAqIEBwYXJhbSB0eXBlIEJFRuWPmOabtOexu+Wei1xyXG4gICAqIEBwYXJhbSBkYXRhSWQg5pWw5o2u5YaF56CBXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjcmVhdGVFbXB0eUNoYW5nZURldGFpbCh0eXBlOiBDaGFuZ2VEZXRhaWxUeXBlLCBkYXRhSWQ6IHN0cmluZyk6IENoYW5nZURldGFpbCB7XHJcbiAgICBjb25zdCBjaGFuZ2VEZXRhaWw6IENoYW5nZURldGFpbCA9IHtcclxuICAgICAgQ2hhbmdlVHlwZTogdHlwZSxcclxuICAgICAgQ2hhbmdlSW5mbzoge1xyXG4gICAgICAgIERhdGFJZDogZGF0YUlkXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gY2hhbmdlRGV0YWlsO1xyXG4gIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCB7IEJlZkNoYW5nZUJ1aWxkZXIgfTtcclxuIl19