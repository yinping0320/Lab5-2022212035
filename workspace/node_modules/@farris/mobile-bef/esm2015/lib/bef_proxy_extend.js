/**
 * @fileoverview added by tsickle
 * Generated from: lib/bef_proxy_extend.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of, EMPTY } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { RequestInfoUtil } from './utils';
import { BE_ERROR_HANDLER__TOKEN } from './tokens';
/**
 * 代理钩子
 * @record
 */
export function IProxyExtend() { }
if (false) {
    /**
     * @param {?} body
     * @return {?}
     */
    IProxyExtend.prototype.extendBody = function (body) { };
    /**
     * @param {?} headers
     * @return {?}
     */
    IProxyExtend.prototype.extendHeaders = function (headers) { };
    /**
     * @param {?} response
     * @param {?=} ignoreChanges
     * @return {?}
     */
    IProxyExtend.prototype.onResponse = function (response, ignoreChanges) { };
    /**
     * @param {?} error
     * @param {?} selfHandError
     * @param {?} ignoreError
     * @return {?}
     */
    IProxyExtend.prototype.onError = function (error, selfHandError, ignoreError) { };
}
/**
 * Bef代理扩展类
 */
export class BefProxyExtend {
    /**
     * 构造函数
     * @param {?} repository
     */
    constructor(repository) {
        this.repository = repository;
    }
    /**
     * 注入器
     * @private
     * @return {?}
     */
    get injector() {
        return this.repository.getInjector();
    }
    /**
     * 返回结果处理
     * @param {?} response
     * @return {?}
     */
    onResponse(response) {
        this.handleResponseHeaders(response.headers);
        return this.handleResponseBody(response.body);
    }
    /**
     * 处理服务器端返回的headers数据
     * @private
     * @param {?} headers
     * @return {?}
     */
    handleResponseHeaders(headers) {
        this.repository.sessionService.handleResponseHeaders(headers);
    }
    /**
     * 处理服务器端返回的的body数据
     * @private
     * @param {?} responseInfo
     * @return {?}
     */
    handleResponseBody(responseInfo) {
        if (responseInfo && responseInfo.innerDataChange) {
            this.repository.entityManager.handleDataChangeDetails(responseInfo.innerDataChange);
        }
        this.repository.entityManager.clearAllEntityChanges();
        if (responseInfo && responseInfo.hasOwnProperty('returnValue')) {
            return responseInfo.returnValue;
        }
        else {
            return responseInfo;
        }
    }
    /**
     * 错误处理
     * @param {?} error
     * @return {?}
     */
    onError(error) {
        // 获取所有load组件实例，消除
        /** @type {?} */
        const loadingServices = window['DEVKIT_LOADING_SERVICE'];
        if (loadingServices && loadingServices instanceof Array && loadingServices.length > 0) {
            for (const loadingService of loadingServices) {
                if (typeof (loadingService.hide) === 'function') {
                    loadingService.hide();
                }
            }
        }
        // 捕获到异常，处理异常信息
        /** @type {?} */
        const exceptionService = this.injector.get(BE_ERROR_HANDLER__TOKEN, null);
        if (!!exceptionService) {
            exceptionService.show(error);
            return EMPTY;
        }
        else {
            return EMPTY;
        }
    }
    /**
     * 扩展Headers
     * @param {?} headers
     * @return {?}
     */
    extendHeaders(headers) {
        /** @type {?} */
        const $getSessionId = this.repository.sessionService.getBeSessionId();
        return $getSessionId.pipe(switchMap((/**
         * @return {?}
         */
        () => {
            headers = this.repository.sessionService.extendRequestHeaders(headers);
            return of(headers);
        })));
    }
    /**
     * 扩展Body
     * @param {?} body
     * @return {?}
     */
    extendBody(body) {
        return RequestInfoUtil.appendRequestInfoToBody(body, this.repository);
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    BefProxyExtend.prototype.repository;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVmX3Byb3h5X2V4dGVuZC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWJlZi8iLCJzb3VyY2VzIjpbImxpYi9iZWZfcHJveHlfZXh0ZW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFjLEVBQUUsRUFBRSxLQUFLLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDekQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBSTNDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFMUMsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sVUFBVSxDQUFDOzs7OztBQUtuRCxrQ0FLQzs7Ozs7O0lBSkMsd0RBQW1EOzs7OztJQUNuRCw4REFBcUU7Ozs7OztJQUNyRSwyRUFBNkQ7Ozs7Ozs7SUFDN0Qsa0ZBQW9GOzs7OztBQU10RixNQUFNLE9BQU8sY0FBYzs7Ozs7SUFZekIsWUFBb0IsVUFBaUM7UUFBakMsZUFBVSxHQUFWLFVBQVUsQ0FBdUI7SUFBSSxDQUFDOzs7Ozs7SUFQMUQsSUFBWSxRQUFRO1FBQ2xCLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUN2QyxDQUFDOzs7Ozs7SUFVTSxVQUFVLENBQUMsUUFBYTtRQUM3QixJQUFJLENBQUMscUJBQXFCLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzdDLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNoRCxDQUFDOzs7Ozs7O0lBS08scUJBQXFCLENBQUMsT0FBWTtRQUN4QyxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNoRSxDQUFDOzs7Ozs7O0lBS08sa0JBQWtCLENBQUMsWUFBMEI7UUFDbkQsSUFBSSxZQUFZLElBQUksWUFBWSxDQUFDLGVBQWUsRUFBRTtZQUNoRCxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyx1QkFBdUIsQ0FBQyxZQUFZLENBQUMsZUFBZSxDQUFDLENBQUM7U0FDckY7UUFDRCxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBRXRELElBQUksWUFBWSxJQUFJLFlBQVksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLEVBQUU7WUFDOUQsT0FBTyxZQUFZLENBQUMsV0FBVyxDQUFDO1NBQ2pDO2FBQU07WUFDTCxPQUFPLFlBQVksQ0FBQztTQUNyQjtJQUNILENBQUM7Ozs7OztJQUtNLE9BQU8sQ0FBQyxLQUFVOzs7Y0FFakIsZUFBZSxHQUFHLE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQztRQUN4RCxJQUFJLGVBQWUsSUFBSSxlQUFlLFlBQVksS0FBSyxJQUFJLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3JGLEtBQUssTUFBTSxjQUFjLElBQUksZUFBZSxFQUFFO2dCQUM1QyxJQUFJLE9BQU8sQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEtBQUssVUFBVSxFQUFFO29CQUMvQyxjQUFjLENBQUMsSUFBSSxFQUFFLENBQUM7aUJBQ3ZCO2FBQ0Y7U0FDRjs7O2NBRUssZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQWMsdUJBQXVCLEVBQUUsSUFBSSxDQUFDO1FBQ3RGLElBQUksQ0FBQyxDQUFDLGdCQUFnQixFQUFFO1lBQ3RCLGdCQUFnQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQTtZQUM1QixPQUFPLEtBQUssQ0FBQztTQUNkO2FBQU07WUFDTCxPQUFPLEtBQUssQ0FBQztTQUNkO0lBQ0gsQ0FBQzs7Ozs7O0lBS00sYUFBYSxDQUFDLE9BQW9COztjQUNqQyxhQUFhLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsY0FBYyxFQUFFO1FBQ3JFLE9BQU8sYUFBYSxDQUFDLElBQUksQ0FDdkIsU0FBUzs7O1FBQUMsR0FBRyxFQUFFO1lBQ2IsT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3ZFLE9BQU8sRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3JCLENBQUMsRUFBQyxDQUNILENBQUM7SUFDSixDQUFDOzs7Ozs7SUFLTSxVQUFVLENBQUMsSUFBUztRQUN6QixPQUFPLGVBQWUsQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3hFLENBQUM7Q0FFRjs7Ozs7O0lBNUVhLG9DQUF5QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBFTVBUWSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEVudGl0eSwgSHR0cEhlYWRlcnMsIEluamVjdEZsYWdzLCBJbmplY3RvciB9IGZyb20gJ0BmYXJyaXMvbW9iaWxlLWRldmtpdCc7XHJcbmltcG9ydCB7IElFcnJvclNlcnZlLCBSZXNwb25zZUluZm8gfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSB9IGZyb20gJy4vYmVmX3JlcG9zaXRvcnknO1xyXG5pbXBvcnQgeyBSZXF1ZXN0SW5mb1V0aWwgfSBmcm9tICcuL3V0aWxzJztcclxuXHJcbmltcG9ydCB7IEJFX0VSUk9SX0hBTkRMRVJfX1RPS0VOIH0gZnJvbSAnLi90b2tlbnMnO1xyXG5cclxuLyoqXHJcbiAqIOS7o+eQhumSqeWtkFxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBJUHJveHlFeHRlbmQge1xyXG4gIGV4dGVuZEJvZHkoYm9keTogYW55KTogeyBbcHJvcE5hbWU6IHN0cmluZ106IGFueSB9O1xyXG4gIGV4dGVuZEhlYWRlcnMoaGVhZGVyczogeyBbcHJvcE5hbWU6IHN0cmluZ106IGFueSB9KTogT2JzZXJ2YWJsZTxhbnk+O1xyXG4gIG9uUmVzcG9uc2U/KHJlc3BvbnNlOiBSZXNwb25zZUluZm8sIGlnbm9yZUNoYW5nZXM/OiBib29sZWFuKTtcclxuICBvbkVycm9yPyhlcnJvcjogYW55LCBzZWxmSGFuZEVycm9yOiBib29sZWFuLCBpZ25vcmVFcnJvcjogYm9vbGVhbik6IE9ic2VydmFibGU8YW55PjtcclxufVxyXG5cclxuLyoqXHJcbiAqIEJlZuS7o+eQhuaJqeWxleexu1xyXG4gKi9cclxuZXhwb3J0IGNsYXNzIEJlZlByb3h5RXh0ZW5kIGltcGxlbWVudHMgSVByb3h5RXh0ZW5kIHtcclxuXHJcbiAgLyoqXHJcbiAqIOazqOWFpeWZqFxyXG4gKi9cclxuICBwcml2YXRlIGdldCBpbmplY3RvcigpIHtcclxuICAgIHJldHVybiB0aGlzLnJlcG9zaXRvcnkuZ2V0SW5qZWN0b3IoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+KSB7IH1cclxuXHJcbiAgLyoqXHJcbiAgICog6L+U5Zue57uT5p6c5aSE55CGXHJcbiAgICovXHJcbiAgcHVibGljIG9uUmVzcG9uc2UocmVzcG9uc2U6IGFueSk6IFJlc3BvbnNlSW5mbyB7XHJcbiAgICB0aGlzLmhhbmRsZVJlc3BvbnNlSGVhZGVycyhyZXNwb25zZS5oZWFkZXJzKTtcclxuICAgIHJldHVybiB0aGlzLmhhbmRsZVJlc3BvbnNlQm9keShyZXNwb25zZS5ib2R5KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWkhOeQhuacjeWKoeWZqOerr+i/lOWbnueahGhlYWRlcnPmlbDmja5cclxuICAgKi9cclxuICBwcml2YXRlIGhhbmRsZVJlc3BvbnNlSGVhZGVycyhoZWFkZXJzOiBhbnkpOiB2b2lkIHtcclxuICAgIHRoaXMucmVwb3NpdG9yeS5zZXNzaW9uU2VydmljZS5oYW5kbGVSZXNwb25zZUhlYWRlcnMoaGVhZGVycyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlpITnkIbmnI3liqHlmajnq6/ov5Tlm57nmoTnmoRib2R55pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBoYW5kbGVSZXNwb25zZUJvZHkocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pOiBSZXNwb25zZUluZm8ge1xyXG4gICAgaWYgKHJlc3BvbnNlSW5mbyAmJiByZXNwb25zZUluZm8uaW5uZXJEYXRhQ2hhbmdlKSB7XHJcbiAgICAgIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLmhhbmRsZURhdGFDaGFuZ2VEZXRhaWxzKHJlc3BvbnNlSW5mby5pbm5lckRhdGFDaGFuZ2UpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5yZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIuY2xlYXJBbGxFbnRpdHlDaGFuZ2VzKCk7XHJcblxyXG4gICAgaWYgKHJlc3BvbnNlSW5mbyAmJiByZXNwb25zZUluZm8uaGFzT3duUHJvcGVydHkoJ3JldHVyblZhbHVlJykpIHtcclxuICAgICAgcmV0dXJuIHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiByZXNwb25zZUluZm87XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDplJnor6/lpITnkIZcclxuICAgKi9cclxuICBwdWJsaWMgb25FcnJvcihlcnJvcjogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIC8vIOiOt+WPluaJgOaciWxvYWTnu4Tku7blrp7kvovvvIzmtojpmaRcclxuICAgIGNvbnN0IGxvYWRpbmdTZXJ2aWNlcyA9IHdpbmRvd1snREVWS0lUX0xPQURJTkdfU0VSVklDRSddO1xyXG4gICAgaWYgKGxvYWRpbmdTZXJ2aWNlcyAmJiBsb2FkaW5nU2VydmljZXMgaW5zdGFuY2VvZiBBcnJheSAmJiBsb2FkaW5nU2VydmljZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICBmb3IgKGNvbnN0IGxvYWRpbmdTZXJ2aWNlIG9mIGxvYWRpbmdTZXJ2aWNlcykge1xyXG4gICAgICAgIGlmICh0eXBlb2YgKGxvYWRpbmdTZXJ2aWNlLmhpZGUpID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICBsb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICAvLyDmjZXojrfliLDlvILluLjvvIzlpITnkIblvILluLjkv6Hmga9cclxuICAgIGNvbnN0IGV4Y2VwdGlvblNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldDxJRXJyb3JTZXJ2ZT4oQkVfRVJST1JfSEFORExFUl9fVE9LRU4sIG51bGwpXHJcbiAgICBpZiAoISFleGNlcHRpb25TZXJ2aWNlKSB7XHJcbiAgICAgIGV4Y2VwdGlvblNlcnZpY2Uuc2hvdyhlcnJvcilcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5omp5bGVSGVhZGVyc1xyXG4gICAqL1xyXG4gIHB1YmxpYyBleHRlbmRIZWFkZXJzKGhlYWRlcnM6IEh0dHBIZWFkZXJzKTogT2JzZXJ2YWJsZTx7IFtwcm9wTmFtZTogc3RyaW5nXTogYW55IH0+IHtcclxuICAgIGNvbnN0ICRnZXRTZXNzaW9uSWQgPSB0aGlzLnJlcG9zaXRvcnkuc2Vzc2lvblNlcnZpY2UuZ2V0QmVTZXNzaW9uSWQoKTtcclxuICAgIHJldHVybiAkZ2V0U2Vzc2lvbklkLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XHJcbiAgICAgICAgaGVhZGVycyA9IHRoaXMucmVwb3NpdG9yeS5zZXNzaW9uU2VydmljZS5leHRlbmRSZXF1ZXN0SGVhZGVycyhoZWFkZXJzKTtcclxuICAgICAgICByZXR1cm4gb2YoaGVhZGVycyk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5omp5bGVQm9keVxyXG4gICAqL1xyXG4gIHB1YmxpYyBleHRlbmRCb2R5KGJvZHk6IGFueSk6IGFueSB7XHJcbiAgICByZXR1cm4gUmVxdWVzdEluZm9VdGlsLmFwcGVuZFJlcXVlc3RJbmZvVG9Cb2R5KGJvZHksIHRoaXMucmVwb3NpdG9yeSk7XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=