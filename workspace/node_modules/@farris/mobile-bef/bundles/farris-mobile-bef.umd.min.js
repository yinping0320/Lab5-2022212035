!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@farris/mobile-devkit"),require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("@farris/mobile-bef",["exports","@farris/mobile-devkit","rxjs","rxjs/operators"],e):e(((t=t||self).farris=t.farris||{},t.farris["mobile-bef"]={}),t.mobileDevkit,t.rxjs,t.rxjs.operators)}(this,(function(t,e,n,r){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function o(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function a(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function s(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a}var p=function(){function t(){}return t.Added="Added",t.Modify="Modify",t.Deleted="Deleted",t}();var u=new e.InjectionToken("@farris/be BE_SERVER_URL"),y=new e.InjectionToken("@farris/be BE_SESSION_HANDLING_STRATEGY_TOKEN"),h=new e.InjectionToken("@farris/be BE_ERROR_HANDLER__TOKEN"),c=function(){function t(){}return t.appendSessionId=function(t,n){return t=e.HttpUtil.appendHeader(t,"SessionId",n)},t.appendCafRuntimeCommonVariable=function(t,n){return t=e.HttpUtil.appendHeader(t,"X-CAF-Runtime-CommonVariable",n)},t.appendCafRuntimeContext=function(t,n){return t=e.HttpUtil.appendHeader(t,"X-CAF-Runtime-Context",n)},t.appendContextType=function(t,n){return n=n||"application/json",t=e.HttpUtil.appendHeader(t,"Content-Type",n)},t}(),l=function(){function t(){}return t.buildRequestInfo=function(t){return{dataChange:t.entityManager.buildAllEntityChangeDetails(),variableChange:t.variableManager.buildChangeDetail()}},t.appendRequestInfoToBody=function(t,e){if(t.requestInfo)return t;var n=this.buildRequestInfo(e);return t&&0!==Object.keys(t).length?Object.assign({},t,{requestInfo:n}):n},t}(),d=function(){function t(){}return t.unWrapResponseInfo=function(t){if(!t)return t;if(!1===t.hasOwnProperty("returnValue"))return t.hasOwnProperty("result")&&t.hasOwnProperty("pagination")?t.result:t;var e=t.returnValue;return e&&e.hasOwnProperty("result")&&e.hasOwnProperty("pagination")?e.result:t.returnValue},t}(),f=function(){function t(){}return t.createEmpty=function(t,e){var n={ChangeType:t,ChangeInfo:{}};return e&&(n.ChangeInfo.DataId=e),n},t.getChangeInfo=function(t){return!0===this.isChangeDetail(t)?t.ChangeInfo:t},t.isChangeDetail=function(t){var e=Object.keys(t);return 2===e.length&&e.indexOf("ChangeType")>-1&&e.indexOf("ChangeInfo")>-1},t}(),g=function(){function t(){}return t.convertToPathArray=function(t,n){var r=this,i=e.BindingPathConverter.toBindingPathArray(t),o=[],a=n.list.currentItem;return o.push(a.primaryKeyValue),i.forEach((function(t){var n=e.PropertyUtil.getPropertyByName(a.properties,t);if(n.type!==e.BindingPropertyType.List)throw new Error(n.name+"不是子表对应的属性");var i=a[t];a=i.currentItem,o.push(r.trimTrailingS(t)),o.push(a.primaryKeyValue)})),o},t.convertToPathUrl=function(t,e){var n=this.convertToPathArray(t,e);return n.pop(),"/"+n.join("/")},t.convertToObjectCodes=function(t,e){for(var n=this.convertToPathArray(t,e),r=n.length,i=[],o=1;o<r;o+=2)i.push(n[o]);return i},t.convertToDataIdsForUpdate=function(t,e){for(var n=this.convertToPathArray(t,e),r=n.length,i=[],o=0;o<r;o+=2)i.push(n[o]);return i},t.convertToDataIdsForAdd=function(t,e){var n=this.convertToDataIdsForUpdate(t,e);return n.pop(),n},t.convertPathToUrl=function(t){for(var e=t.split("/"),n=e.length-1;n>0;n--)e[n]&&e[n].endsWith("s")&&(e[n]=e[n].substr(0,e[n].length-1));return e.join("/").toLowerCase()},t.trimTrailingS=function(t){return t.substr(0,t.length-1)},t.convertPathsToNodeCodes=function(t){var e=[];return!t||t.length<1?e:(t.filter((function(t){return!!t&&-1===t.indexOf(":")})).forEach((function(t){e.push(t)})),e)},t.convertPathsToIds=function(t){var e=[];return!t||t.length<1?e:(t.filter((function(t){return!!t&&-1!==t.indexOf(":")})).forEach((function(t){e.push(t.split(":")[1])})),e)},t}(),v=function(){function t(){}return t.buildRequestInfo=function(t){return{dataChange:t.entityManager.buildAllEntityChangeDetails(),variableChange:t.variableManager.buildChangeDetail()}},t}(),S=function(){function t(){}return t.isExistUnsaveData=function(t){var e=!1;if(!t||!t.entityCollection)throw new Error("Current Object is null or it's entityCollection is null.");var n=t.entityCollection.toArray();if(t.dataChangeHistory.isChanged())return!0;for(var r=0;r<n.length;r++)if(n[r].changes.length>0){e=!0;break}return e},t}(),I=function(){function t(){}return t.getPropInfo=function(t,n){var r,i,o,a=e.FieldMetadataUtil.getNgFields(t);Object.keys(a).forEach((function(t){t===n&&(r="NgField",i=null,o=a[t])}));var s=e.FieldMetadataUtil.getNgObjects(t);Object.keys(s).forEach((function(t){t===n&&(r="NgObject",i=s[t].type,o=s[t])}));var p=e.FieldMetadataUtil.getNgList(t);Object.keys(p).forEach((function(t){t===n&&(r="NgList",i=p[t].type,o=p[t])}));var u=e.FieldMetadataUtil.getNgDynamic(t);return Object.keys(u).forEach((function(t){t===n&&(r="NgDynamic",i=u[t].type,o=u[t])})),{propType:r,propEntityType:i,propMetadata:o}},t.getPrimaryKey=function(t){var n=e.FieldMetadataUtil.getPrimaryFieldMetadata(t);return n?n.dataField:""},t.isObjectProp=function(t,n){var r=!1,i=e.FieldMetadataUtil.getNgObjects(t);return Object.keys(i).forEach((function(t){t===n&&(r=!0)})),r},t.isDynamicProp=function(t,n){var r=!1,i=e.FieldMetadataUtil.getNgDynamic(t);return Object.keys(i).forEach((function(t){t===n&&(r=!0)})),r},t.appendInitialData=function(t,e){var n=Object.assign({},e);delete n.id,delete n.parentID,t.initialData=n},t}(),C=function(){function t(){}return t.isInFramework=function(){var t=window.location.hash;return!!t&&-1!==t.indexOf("formToken=")},t}(),b=function(){function t(t,e){this.entityType=t,this.entityCollection=e}return t.prototype.build=function(t){var e=this;return this.changeDetail={ChangeType:p.Modify,ChangeInfo:{DataId:""}},t.forEach((function(t){e.buildChangeDetail(t)})),this.changeDetail},t.prototype.buildChangeDetail=function(t){var n=t.path.concat();this.changeDetail.ChangeInfo.DataId||(this.changeDetail.ChangeInfo.DataId=n[0].split(":")[1]);for(var r=this.changeDetail,i=this.entityType,o=function(o){var s=a.getChangeInfo(r),u=n[o],y=I.getPropInfo(i,u),h=y.propType,c=y.propEntityType,l=y.propMetadata.dataField||u;if("NgField"===h){if(u===I.getPrimaryKey(i))return"continue";if(t.type!==e.ModifyType.ValueChange)throw Error("简单类型的属性上不支持ValueChange类型之外的变更");s[l]=t.value,r=null}else if("NgObject"===h){n[o+1].split(":")[1];if(n[o+1].split(":")[0]){var d=s[l],f=n.slice(0,o+1);d=(C=a.entityCollection.getEntityByPath(f))?C.toJSON():{},s[l]=d,r=null,i=null}else{(v=s[l])||(v={ChangeType:p.Modify,ChangeInfo:{}}),s[l]=v,r=v,i=c}}else if("NgList"===h){r.ChangeInfo[l]||(r.ChangeInfo[l]=[]);var g=r.ChangeInfo[l];if(o!==n.length-1){var v,S=n[o+1].split(":")[1];return(v=g.find((function(t){return t.ChangeInfo.DataId===S})))||(v=a.createEmptyChangeDetail(p.Modify,S),g.push(v)),r=v,i=c,"continue"}r=null,i=null}else if("NgDynamic"===h){f=n.slice(0,o+1);var C=a.entityCollection.getEntityByPath(f);s[l]={ChangeType:p.Modify,ChangeInfo:C?C.toJSON():{}},r=null,i=null}},a=this,s=1;s<n.length&&r;s+=2)o(s)},t.prototype.getChangeInfo=function(t){return t.hasOwnProperty("ChangeInfo")?t.ChangeInfo:t},t.prototype.createEmptyChangeDetail=function(t,e){return{ChangeType:t,ChangeInfo:{DataId:e}}},t}();var E=function(){function t(){}return t.prototype.handle=function(t,e,n){this.handleChangeDetails(t,e,n)},t.prototype.handleChangeDetails=function(t,e,n){var r=this;n&&n.forEach((function(n){var i=n.ChangeInfo.dataId||n.ChangeInfo.DataId,o=r.getEntityById(e,i);o&&r.handleChangeDetail(t,o,n)}))},t.prototype.handleChangeDetail=function(t,e,n){var r=this;if(n&&e&&n.ChangeType===p.Modify){var i=n.ChangeInfo;Object.keys(i).forEach((function(n){var o=I.getPropInfo(t,n),a=o.propType,s=o.propEntityType;if("NgField"===a)e[n]=i[n];else if("NgObject"===a){var p=e[n];if(p.primaryKey){var u=i[n];p.load(u)}else{var y=i[n];r.handleChangeDetail(s,p,y)}}else if("NgList"===a){var h=e[n],c=i[n];r.handleChangeDetails(s,h,c)}}))}},t.prototype.getEntityById=function(t,n){return(t instanceof e.EntityCollection?t.getEntityById(n):t.get(n))||null},t}(),m=function(){function t(t,e,r,i){this.beSessionExisted=!1,this.storageStrategy=t,this.frmSessionService=e,this.httpClient=r,this.beBaseUrl=i,this.beCreateSessionUrl=i+"/service/createsession",this.beCloseSessionUrl=i+"/service/closesession",this.beSessionExisted$=new n.BehaviorSubject(this.beSessionExisted)}return Object.defineProperty(t.prototype,"frmSessionId",{get:function(){return this.frmSessionService.getCurrentSessionId()},enumerable:!0,configurable:!0}),t.prototype.getFrameworkSessionId=function(){return this.frmSessionId},t.prototype.getSessionIdFromStorage=function(){var t=this.getSessionStorageKey();return this.storageStrategy.getItem(t)},t.prototype.createSession=function(){var t=this,e={responseType:"text",headers:{"Content-Type":"application/json"}},n=this.frmSessionId;return n&&(e.headers=c.appendSessionId(e.headers,this.frmSessionId),e.headers=c.appendCafRuntimeCommonVariable(e.headers,this.frmSessionId)),"true"!==window.sessionStorage.getItem("ClearItOnce")&&n?this.clear(n).pipe(r.switchMap((function(){return window.sessionStorage.setItem("ClearItOnce","true"),t.httpClient.post(t.beCreateSessionUrl,null,e).pipe(r.tap((function(e){t.setSessionId(e),t.setBesessionExisted(!0)})))}))):this.httpClient.post(this.beCreateSessionUrl,null,e).pipe(r.tap((function(e){t.setSessionId(e),t.setBesessionExisted(!0)})))},t.prototype.clear=function(t){var e=new n.Subject;return t&&window.frmMobileService&&window.frmMobileService.rtf.func.clearState({formToken:t},(function(){e.next(!0)})),e},t.prototype.test=function(){var t=this,e={responseType:"text",headers:{"Content-Type":"application/json"}};return this.frmSessionId&&(e.headers=c.appendSessionId(e.headers,this.frmSessionId),e.headers=c.appendCafRuntimeCommonVariable(e.headers,this.frmSessionId)),this.httpClient.post(this.beCreateSessionUrl,null,e).pipe(r.tap((function(e){t.setSessionId(e),t.setBesessionExisted(!0)})))},t.prototype.closeOldSession=function(){var t=this;if(!this.oldBeSessionId)return n.of(!0);var e={responseType:"text",headers:{"Content-Type":"application/json"}};return e.headers=c.appendCafRuntimeContext(e.headers,this.oldBeSessionId),e.headers=c.appendSessionId(e.headers,this.oldBeSessionId),this.frmSessionId&&(e.headers=c.appendCafRuntimeCommonVariable(e.headers,this.frmSessionId)),this.httpClient.post(this.beCloseSessionUrl,null,e).pipe(r.tap((function(){return t.oldBeSessionId=null,n.of(!0)}),(function(){return t.oldBeSessionId=null,n.of(!0)})))},t.prototype.setBesessionExisted=function(t){this.beSessionExisted!==t&&(this.beSessionExisted=t,this.beSessionExisted$.next(t))},t.prototype.getBeSessionExisted=function(){return this.beSessionExisted$},t}();var B=function(t){function e(e,n,r,i){return t.call(this,e,n,r,i)||this}return o(e,t),e.prototype.getSessionId=function(){var t,e=this.getSessionIdFromStorage();return e?(t=n.of(e),this.setBesessionExisted(!0)):t=this.createSession(),this.closeOldSession().pipe(r.switchMap((function(){return t})))},e.prototype.setSessionId=function(t){var e=this.getSessionStorageKey();this.storageStrategy.setItem(e,t)},e.prototype.clearSessionId=function(){if(!0===C.isInFramework())this.storageStrategy.removeItemsByScope(this.frmSessionId);else{var t=this.getSessionStorageKey();this.oldBeSessionId=this.getSessionIdFromStorage(),this.storageStrategy.removeItem(t)}},e.prototype.handleRequestHeaders=function(t){var e=this.getFrameworkSessionId(),n=this.getSessionIdFromStorage();return e&&(t=c.appendCafRuntimeCommonVariable(t,e)),n&&(t=c.appendCafRuntimeContext(t,n),t=c.appendSessionId(t,n)),t},e.prototype.handleReponseHeaders=function(t){},e.prototype.getSessionStorageKey=function(){return this.frmSessionId+"_"+this.beBaseUrl},e}(m),P=function(t){function e(e,n,r,i){var o=t.call(this,e,n,r,i)||this;return o.beCloseSessionUrl=i+"/service/closesession",o}return o(e,t),e.prototype.getSessionId=function(){var t=this.getSessionStorageKey(),e=this.storageStrategy.getItem(t),i=n.of(e);return this.closeOldSession().pipe(r.switchMap((function(){return i})))},e.prototype.setSessionId=function(t){var e=this.getSessionStorageKey();this.storageStrategy.setItem(e,t)},e.prototype.clearSessionId=function(){var t=this.getSessionStorageKey();this.oldBeSessionId=this.getSessionIdFromStorage(),this.storageStrategy.removeItem(t)},e.prototype.handleRequestHeaders=function(t){var e=this.getFrameworkSessionId();e&&(t=c.appendCafRuntimeCommonVariable(t,e));var n=this.getSessionIdFromStorage();return n&&(t=c.appendCafRuntimeContext(t,n)),t},e.prototype.handleReponseHeaders=function(t){var e=t.befsessionid,n=this.getSessionId();e&&e!==n&&this.setSessionId(e)},e.prototype.getSessionStorageKey=function(){return this.beBaseUrl},e}(m);var x=function(){function t(){this.sessionStorageKey="BE_SESSION_ID"}return t.prototype.getItem=function(t){return this.getAllBeSessions()[t]},t.prototype.setItem=function(t,e){var n=this.getAllBeSessions();n[t]=e,this.setAllBeSessions(n)},t.prototype.removeItem=function(t){var e=this.getAllBeSessions();e[t]&&delete e[t],this.setAllBeSessions(e)},t.prototype.removeItemsByScope=function(t){var e=this.getAllBeSessions();Object.keys(e).forEach((function(n){!0===n.startsWith(t)&&delete e[n]})),this.setAllBeSessions(e)},t.prototype.clear=function(){window.sessionStorage.removeItem(this.sessionStorageKey)},t.prototype.getAllBeSessions=function(){var t=window.sessionStorage.getItem(this.sessionStorageKey);return t?JSON.parse(t):{}},t.prototype.setAllBeSessions=function(t){var e=JSON.stringify(t);window.sessionStorage.setItem(this.sessionStorageKey,e)},t}();var M=function(){function t(){}return t.prototype.create=function(t,e,n,r){var i=this.createStorageStrategy();return"UnifiedSession"===t?new P(i,e,r,n):new B(i,e,r,n)},t.prototype.createStorageStrategy=function(){return new x},t}(),T=function(){function t(t){this.handlingStrategy=t}return Object.defineProperty(t.prototype,"token",{get:function(){return this.handlingStrategy.getFrameworkSessionId()},enumerable:!0,configurable:!0}),t.prototype.getBeSessionId=function(){return this.handlingStrategy.getSessionId()},t.prototype.getBeSessionExisted=function(){return this.handlingStrategy.getBeSessionExisted()},t.prototype.setBeSessionId=function(t){this.handlingStrategy.setSessionId(t)},t.prototype.clearBeSessionId=function(){this.handlingStrategy.clearSessionId()},t.prototype.extendRequestHeaders=function(t){return this.handlingStrategy.handleRequestHeaders(t)},t.prototype.handleResponseHeaders=function(t){return this.handlingStrategy.handleReponseHeaders(t)},t}();var D=function(){function t(t){this.httpClient=t,this.associatedUrlMap=new Map}return t.prototype.setAssociatedUrl=function(t){this.associatedUrlMap.set(t,t)},t.prototype.setProxyExtend=function(t){this.proxyExtend=t},t.prototype.query=function(t){var n=this.baseUrl,r={};if(t){var i=JSON.stringify(t);r.entityFilter=i}var o={params:r};return this.request(e.HttpMethods.GET,n,o)},t.prototype.extendQuery=function(t){var n=this.baseUrl+"/extension/query",r={};if(t){var i=JSON.stringify(t);r.entityFilter=i}var o={params:r};return this.request(e.HttpMethods.PUT,n,o)},t.prototype.retrieve=function(t){var n=this.baseUrl+"/"+t;return this.request(e.HttpMethods.GET,n)},t.prototype.extendRetrieve=function(t){var n=this.baseUrl+"/extension/retrieve/"+t;return this.request(e.HttpMethods.PUT,n)},t.prototype.edit=function(t){var n=this.baseUrl+"/service/edit/"+t;return this.request(e.HttpMethods.PUT,n)},t.prototype.create=function(t,n){var r={body:{defaultValue:t,requestInfo:n}};return this.request(e.HttpMethods.POST,this.baseUrl,r)},t.prototype.createByPath=function(t){var n=g.convertPathToUrl(t),r=""+this.baseUrl+n;return this.request(e.HttpMethods.POST,r)},t.prototype.update=function(t){var n={body:{changeDetail:t}};return this.request(e.HttpMethods.PATCH,this.baseUrl,n)},t.prototype.save=function(){return this.request(e.HttpMethods.PUT,this.baseUrl)},t.prototype.delete=function(t){var n=this.baseUrl+"/"+t;return this.request(e.HttpMethods.DELETE,n)},t.prototype.extendDelete=function(t){var n=this.baseUrl+"/extension/delete/"+t;return this.request(e.HttpMethods.PUT,n)},t.prototype.deleteAndSave=function(t){var n=this.baseUrl+"/service/delete/"+t;return this.request(e.HttpMethods.PUT,n,{})},t.prototype.deletByPath=function(t,n){var r=g.convertPathToUrl(t),i=""+this.baseUrl+r+"/"+n;return this.request(e.HttpMethods.DELETE,i)},t.prototype.extendDeletByPath=function(t,n){var r=g.convertPathToUrl(t),i=this.baseUrl+"/extension"+r+"/"+n;return this.request(e.HttpMethods.PUT,i)},t.prototype.batchDelete=function(t){var n={params:{ids:t.join(",")}};return this.request(e.HttpMethods.DELETE,this.baseUrl,n)},t.prototype.extendBatchDelete=function(t){var n=this.baseUrl+"/extension/batchdelete",r={params:{ids:t.join(",")}};return this.request(e.HttpMethods.PUT,n,r)},t.prototype.cancel=function(){var t=this.baseUrl+"/service/cancel";return this.request(e.HttpMethods.POST,t)},t.prototype.request=function(t,n,i,o){var a=this;if(void 0===o&&(o=!1),i=i||{},!0!==o&&(t===e.HttpMethods.POST||t===e.HttpMethods.PUT||t===e.HttpMethods.PATCH)){var s=i.body||{};i.body=this.proxyExtend.extendBody(s)}return this.proxyExtend.extendHeaders(i.headers).pipe(r.switchMap((function(e){return i.headers=e,i.observe="response",a.httpClient.request(t,n,i).pipe(r.map((function(t){return!0===o?t&&t.body&&t.body.returnValue?t.body.returnValue:t:a.proxyExtend.onResponse(t)})),r.catchError((function(t){return a.proxyExtend.onError(t,!1,!1)})))})),r.catchError((function(t){return a.proxyExtend.onError(t,!1,!1)})))},t}();var w=e.makePropDecorator("@farris/bef VARIABLE_PROP_META",(function(t){return t})),O=function(t){function e(e){var n=t.call(this,e)||this;return n.changeBuilder=new b(n.entityCollection.entityType,n.entityCollection),n.changeHandler=new E,n}return o(e,t),e.prototype.buildAllEntityChangeDetails=function(){var t=this,e=[];return this.entityCollection.getAllEntities().forEach((function(n){if(0!==n.changes.length){var r=t.changeBuilder.build(n.changes);r&&r.ChangeInfo&&r.ChangeInfo.DataId&&e.push(r)}})),e},e.prototype.buildEntityChangeDetailById=function(t){var e=this.entityCollection.getEntityById(t);return 0===e.changes.length?null:this.changeBuilder.build(e.changes)},e.prototype.handleDataChangeDetails=function(t){this.changeHandler.handle(this.entityType,this.entityCollection,t)},e.prototype.reset=function(){this.entityCollection.clear()},e}(e.EntityManager);var U=function(){function t(t){var e=this;this.ngVariables=t,this.ngVariableMap=new Map,this.lastSyncValuesMap=new Map,this.latestVariableValues=new Map,Object.keys(this.ngVariables).forEach((function(n){e.ngVariableMap.set(n,t[n])}))}return t.prototype.setValue=function(t,e){if(!1===this.ngVariableMap.has(t))throw new Error("不存在名为"+t+"的变量");this.latestVariableValues.set(t,e)},t.prototype.getValue=function(t){if(!1===this.ngVariableMap.has(t))throw new Error("不存在名为"+t+"的变量");this.latestVariableValues.get(t)},t.prototype.handleChangeDetail=function(t){},t.prototype.buildChangeDetail=function(){var t=this,e=f.createEmpty(p.Modify);return this.ngVariableMap.forEach((function(n,r){var i=t.latestVariableValues.get(r),o=t.lastSyncValuesMap.get(r);!1===t.isValueEqual(i,o)&&(t.lastSyncValuesMap.set(r,i),t.appendToChangeInfo(e,r,i))})),0===Object.keys(e.ChangeInfo).length?null:e},t.prototype.reset=function(){this.lastSyncValuesMap.clear(),this.latestVariableValues.clear()},t.prototype.appendToChangeInfo=function(t,e,n){if(!0===this.isUdtVariable(n)){var r=f.createEmpty(p.Modify);r.ChangeInfo=n,t.ChangeInfo[e]=r}else t.ChangeInfo[e]=n},t.prototype.isValueEqual=function(t,e){return JSON.stringify(t)===JSON.stringify(e)},t.prototype.isUdtVariable=function(t){return t&&t.constructor&&"[object Object]"===t.toString()&&t.constructor.prototype.hasOwnProperty("isPrototypeOf")},t}();var R=function(){function t(t){this.repository=t}return Object.defineProperty(t.prototype,"apiProxy",{get:function(){return this.repository.apiProxy},enumerable:!0,configurable:!0}),t.prototype.getList=function(t,e,n,i){var o=this,a=this.buildEntityFilter(t,e,n,i);return this.apiProxy.extendQuery(a).pipe(r.map((function(t){o.repository.setPaginationInfo(t.pagination);var e=t.result,n=o.repository.buildEntities(e);return o.determineIsAppend(i)?o.repository.entityCollection.addEntities(n):o.repository.entityCollection.loadEntities(n),n})))},t.prototype.determineIsAppend=function(t){return t>1},t.prototype.getById=function(t){var e=this;return this.apiProxy.extendRetrieve(t).pipe(r.map((function(t){var n=t,r=e.repository.buildEntity(n);return e.repository.entityCollection.loadEntities([r]),r})))},t.prototype.editById=function(t){var e=this;return this.repository.entityCollection.getEntityById(t)?this.apiProxy.edit(t).pipe(r.map((function(n){var r=n.data,i=e.repository.entityCollection.getEntityById(t);return i&&r&&e.reloadEntityData(i,r),i}))):n.of(null)},t.prototype.updateById=function(t){var e=this;return this.repository.entityCollection.getEntityById(t)?this.apiProxy.extendRetrieve(t).pipe(r.map((function(n){var r=n,i=e.repository.entityCollection.getEntityById(t);return e.reloadEntityData(i,r),i}))):n.EMPTY},t.prototype.reloadEntityData=function(t,e){t&&(t.load(e),t.changes.splice(0,t.changes.length))},t.prototype.create=function(t){var n=this;return this.apiProxy.create(t).pipe(r.map((function(t){var r=t,i=n.repository.buildEntity(r);return n.repository.entityCollection.loadEntities([i]),n.repository.dataChangeHistory.addChange({dataId:i.primaryValue,changeType:e.DataChangeType.Add}),i})))},t.prototype.append=function(t){var e=this;return this.apiProxy.create(t).pipe(r.map((function(t){var n=t,r=e.repository.buildEntity(n);return e.repository.entityCollection.addEntity(r),r})))},t.prototype.appendByPath=function(t){var e=this;return this.apiProxy.createByPath(t).pipe(r.map((function(n){var r=n;return e.repository.entityManager.appendEntityByPath(t,r,r)})))},t.prototype.removeById=function(t,i){var o=this;return i=void 0===i||i,this.apiProxy.extendDelete(t).pipe(r.switchMap((function(){return!0===i?o.applyChangesById(t).pipe(r.tap((function(e){e&&o.repository.entityCollection.removeEntityById(t)}))):(o.repository.entityCollection.removeEntityById(t),o.repository.dataChangeHistory.addChange({dataId:t,changeType:e.DataChangeType.Delete}),n.of(!0))})))},t.prototype.removeAndSaveById=function(t){var e=this;return this.apiProxy.deleteAndSave(t).pipe(r.switchMap((function(){return e.repository.entityCollection.removeEntityById(t),n.of(!0)})))},t.prototype.removeByIds=function(t){var e=this;return this.apiProxy.extendBatchDelete(t).pipe(r.switchMap((function(){return e.applyChangesByIdArray(t).pipe(r.tap((function(n){n&&e.repository.entityCollection.removeEntities((function(n){return e.checkEntityValueExists(n,t)}))})))})))},t.prototype.checkEntityValueExists=function(t,e){for(var n=!1,r=0;r<e.length;r++)if(t.primaryValue===e[r]){n=!0;break}return n},t.prototype.removeByPath=function(t,n){var i=this;return this.apiProxy.extendDeletByPath(t,n).pipe(r.map((function(){return i.repository.entityManager.removeEntityByPath(t,n),i.repository.dataChangeHistory.addChange({fpath:t,dataId:n,changeType:e.DataChangeType.Delete}),!0})))},t.prototype.updateChangesById=function(t){var e=this,i=this.repository.entityCollection.getEntityById(t);if(!i.changes||0===i.changes.length)return n.of(!0);var o=this.repository.entityManager.buildEntityChangeDetailById(t);return this.apiProxy.update(o).pipe(r.tap((function(){e.repository.entityManager.clearEntityChangesById(t)})),r.map((function(){return!0})))},t.prototype.updateAllChanges=function(){var t=this,e=[],i=this.repository.entityCollection.toArray();return 0===i.length?n.of(!0):(i.forEach((function(n){var r=t.updateChangesById(n.primaryValue);e.push(r)})),n.zip.apply(void 0,function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(s(arguments[e]));return t}(e)).pipe(r.map((function(){return!0}))))},t.prototype.applyChanges=function(){var t=this;return this.apiProxy.save().pipe(r.tap((function(){t.repository.entityManager.clearAllEntityChanges(),t.repository.dataChangeHistory.clear()})),r.map((function(){return!0})))},t.prototype.applyChangesByIdArray=function(t){var e=this;return this.apiProxy.save().pipe(r.tap((function(){e.repository.entityManager.clearEntityChangesByIds(t),e.repository.dataChangeHistory.clearByIds(t)})),r.map((function(){return!0})))},t.prototype.applyChangesById=function(t){var e=this;return this.apiProxy.save().pipe(r.tap((function(){e.repository.entityManager.clearEntityChangesById(t),e.repository.dataChangeHistory.clearByIds([t])})),r.map((function(){return!0})))},t.prototype.cancelChanges=function(){var t=this;return this.apiProxy.cancel().pipe(r.tap((function(){t.repository.entityManager.clearAllEntityChanges(),t.repository.dataChangeHistory.clear()})),r.map((function(){return!0})))},t.prototype.buildEntityFilter=function(t,e,n,r){return{FilterConditions:t,SortConditions:e,IsUsePagination:0!==n,Pagination:{PageIndex:r,PageSize:n,PageCount:0,TotalCount:0}}},t}();var A=function(){function t(){}return t.prototype.getUserSessionId=function(){return window.localStorage.getItem("sessionId")},t.prototype.getFuncSessionId=function(){var t=window.frmMobileService;return t?t.rtf.commonVariable.formToken():null},t.prototype.getCurrentSessionId=function(){var t=window.sessionStorage.getItem("FuncSessionId"),e=this.getFuncSessionId();return e&&e!==t&&(t=null),t||(t=this.getFuncSessionId())&&window.sessionStorage.setItem("FuncSessionId",t),t},t}();var H=function(){function t(t){this.repository=t}return Object.defineProperty(t.prototype,"injector",{get:function(){return this.repository.getInjector()},enumerable:!0,configurable:!0}),t.prototype.onResponse=function(t){return this.handleResponseHeaders(t.headers),this.handleResponseBody(t.body)},t.prototype.handleResponseHeaders=function(t){this.repository.sessionService.handleResponseHeaders(t)},t.prototype.handleResponseBody=function(t){return t&&t.innerDataChange&&this.repository.entityManager.handleDataChangeDetails(t.innerDataChange),this.repository.entityManager.clearAllEntityChanges(),t&&t.hasOwnProperty("returnValue")?t.returnValue:t},t.prototype.onError=function(t){var e,r,i=window.DEVKIT_LOADING_SERVICE;if(i&&i instanceof Array&&i.length>0)try{for(var o=a(i),s=o.next();!s.done;s=o.next()){var p=s.value;"function"==typeof p.hide&&p.hide()}}catch(t){e={error:t}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}var u=this.injector.get(h,null);return u?(u.show(t),n.EMPTY):n.EMPTY},t.prototype.extendHeaders=function(t){var e=this;return this.repository.sessionService.getBeSessionId().pipe(r.switchMap((function(){return t=e.repository.sessionService.extendRequestHeaders(t),n.of(t)})))},t.prototype.extendBody=function(t){return l.appendRequestInfoToBody(t,this.repository)},t}();var j=function(){function t(t){this.repository=t}return Object.defineProperty(t.prototype,"injector",{get:function(){return this.repository.getInjector()},enumerable:!0,configurable:!0}),t.prototype.init=function(){this.initAppContext(),this.initEntityManager(),this.initVariableManager(),this.initApiProxy(),this.initSessionService(),this.initDataService()},t.prototype.initAppContext=function(){this.repository.appContext=this.injector.get(e.AppContext)},t.prototype.initEntityManager=function(){this.repository.entityManager=new O(this.repository.entityCollection)},t.prototype.initVariableManager=function(){var t=e.MetadataUtil.getPropsMetadatasByName(this.repository.constructor,"@farris/bef VARIABLE_PROP_META");this.repository.variableManager=new U(t)},t.prototype.initApiProxy=function(){this.repository.apiProxy=this.injector.get(this.repository.apiProxyType);var t=new H(this.repository);this.repository.apiProxy.setProxyExtend(t)},t.prototype.initSessionService=function(){var t=this.injector.get(y,null,e.InjectFlags.Optional);t=t||"SeparatedSession";var n=this.injector.get(A),r=this.injector.get(e.HttpClient),i=""+this.repository.apiProxy.baseUrl,o=(new M).create(t,n,i,r);this.repository.sessionService=new T(o)},t.prototype.initDataService=function(){this.repository.dataService=new R(this.repository)},t}();var V=function(t){function e(e){var n=t.call(this)||this;return n.injector=e,n}return o(e,t),e.prototype.init=function(){t.prototype.init.call(this),new j(this).init()},e.prototype.getInjector=function(){return this.injector},e.prototype.getEntities=function(t,e,n,r){return this.dataService.getList(t,e,n,r)},e.prototype.getEntityById=function(t){return this.dataService.getById(t)},e.prototype.updateEntityById=function(t){return this.dataService.updateById(t)},e.prototype.editEntityById=function(t){return this.dataService.editById(t)},e.prototype.createEntity=function(t){return this.dataService.create(t)},e.prototype.appendEntity=function(t){return this.dataService.append(t)},e.prototype.appendEntityByPath=function(t){return this.dataService.appendByPath(t)},e.prototype.removeEntityById=function(t,e){return this.dataService.removeById(t,e)},e.prototype.removeEntitiesByIds=function(t){return this.dataService.removeByIds(t)},e.prototype.removeEntityAndSaveById=function(t){return this.dataService.removeAndSaveById(t)},e.prototype.removeEntityByPath=function(t,e){return this.dataService.removeByPath(t,e)},e.prototype.saveEntityById=function(t){return this.dataService.applyChangesById(t)},e.prototype.saveEntities=function(){return this.dataService.applyChanges()},e.prototype.cancelEntityChanges=function(){return this.dataService.cancelChanges()},e.prototype.reset=function(){this.entityManager.reset(),this.variableManager.reset(),this.sessionService.clearBeSessionId()},e}(e.Repository);var q=function(){function t(t){this.viewModelContext=t,this.befRepository=this.viewModelContext.repository}return t.prototype.getData=function(t,e){var n=t.split(".")[0],r=t.split(".")[1];return e=e||{},this.extendGetHelpData(r,n,e)},t.prototype.extendGetHelpData=function(t,n,i){var o=this.befRepository.apiProxy.baseUrl+"/extension/elementhelps",a={body:{labelId:t,nodeCode:n,queryParam:i,requestInfo:l.buildRequestInfo(this.befRepository)}};return this.befRepository.apiProxy.request(e.HttpMethods.PUT,o,a).pipe(r.map((function(t){return t})))},t}();t.BE_ERROR_HANDLER__TOKEN=h,t.BE_SERVER_URI_TOKEN=u,t.BE_SESSION_HANDLING_STRATEGY_TOKEN=y,t.BefChangeBuilder=b,t.BefChangeHandler=E,t.BefChangeUtil=f,t.BefDataPathUtil=g,t.BefEnvUtil=C,t.BefHttpUtil=c,t.BefLookupDataService=q,t.BefProxy=D,t.BefProxyUtil=v,t.BefRepository=V,t.BefRepositoryUtil=S,t.BefSeparatedSessionHandlingStrategy=B,t.BefSessionHandlingStrategy=m,t.BefSessionHandlingStrategyFactory=M,t.BefSessionService=T,t.BefUnifiedSessionHandlingStrategy=P,t.ChangeDetailType=p,t.EntityUtil=I,t.FrameworkSessionService=A,t.RequestInfoUtil=l,t.ResponseInfoUtil=d,t.SessionStorageBeSessionStorageStrategy=x,t.VARIABLE_PROP_META="@farris/bef VARIABLE_PROP_META",t.VariablePropMeta=w,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=farris-mobile-bef.umd.min.js.map