/**
 * @fileoverview added by tsickle
 * Generated from: lib/session/handling-strategies/handling_strategy.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { BehaviorSubject, of, Subject } from 'rxjs';
import { switchMap, tap } from 'rxjs/operators';
import { BefHttpUtil } from '../../utils/index';
/**
 * BefSession处理策略类
 * @abstract
 */
var /**
 * BefSession处理策略类
 * @abstract
 */
BefSessionHandlingStrategy = /** @class */ (function () {
    /**
     * 构造函数
     */
    function BefSessionHandlingStrategy(storageStrategy, frmSessionService, httpClient, beBaseUrl) {
        /**
         * BeSession是否存在
         */
        this.beSessionExisted = false;
        this.storageStrategy = storageStrategy;
        this.frmSessionService = frmSessionService;
        this.httpClient = httpClient;
        this.beBaseUrl = beBaseUrl;
        this.beCreateSessionUrl = beBaseUrl + "/service/createsession";
        this.beCloseSessionUrl = beBaseUrl + "/service/closesession";
        this.beSessionExisted$ = new BehaviorSubject(this.beSessionExisted);
    }
    Object.defineProperty(BefSessionHandlingStrategy.prototype, "frmSessionId", {
        /**
         * 框架SessionId（用户的或者功能菜单的）
         */
        get: /**
         * 框架SessionId（用户的或者功能菜单的）
         * @protected
         * @return {?}
         */
        function () {
            return this.frmSessionService.getCurrentSessionId();
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 获取框架SessionId
     */
    /**
     * 获取框架SessionId
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.getFrameworkSessionId = /**
     * 获取框架SessionId
     * @return {?}
     */
    function () {
        return this.frmSessionId;
    };
    /**
     * 从缓存中获取BeSession
     */
    /**
     * 从缓存中获取BeSession
     * @protected
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.getSessionIdFromStorage = /**
     * 从缓存中获取BeSession
     * @protected
     * @return {?}
     */
    function () {
        /** @type {?} */
        var sessionStorageKey = this.getSessionStorageKey();
        /** @type {?} */
        var beSessionId = this.storageStrategy.getItem(sessionStorageKey);
        return beSessionId;
    };
    /**
     * 创建BeSessionId
     */
    /**
     * 创建BeSessionId
     * @protected
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.createSession = /**
     * 创建BeSessionId
     * @protected
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var requestConfig = {
            responseType: 'text',
            headers: {
                'Content-Type': 'application/json'
            }
        };
        /** @type {?} */
        var frmSessionId = this.frmSessionId;
        if (frmSessionId) {
            requestConfig.headers = BefHttpUtil.appendSessionId(requestConfig.headers, this.frmSessionId);
            requestConfig.headers = BefHttpUtil.appendCafRuntimeCommonVariable(requestConfig.headers, this.frmSessionId);
        }
        //创建前判断当前的frmsessionid是不是在当前会话下被清除过
        /** @type {?} */
        var ClearItOnce = window.sessionStorage.getItem("ClearItOnce");
        if ('true' !== ClearItOnce && frmSessionId) {
            return this.clear(frmSessionId).pipe(switchMap((/**
             * @return {?}
             */
            function () {
                window.sessionStorage.setItem("ClearItOnce", 'true');
                return _this.httpClient.post(_this.beCreateSessionUrl, null, requestConfig).pipe(tap((/**
                 * @param {?} beSessionId
                 * @return {?}
                 */
                function (beSessionId) {
                    _this.setSessionId(beSessionId);
                    _this.setBesessionExisted(true);
                })));
            })));
        }
        return this.httpClient.post(this.beCreateSessionUrl, null, requestConfig).pipe(tap((/**
         * @param {?} beSessionId
         * @return {?}
         */
        function (beSessionId) {
            _this.setSessionId(beSessionId);
            _this.setBesessionExisted(true);
        })));
    };
    /**
     * @param {?} formToken
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.clear = /**
     * @param {?} formToken
     * @return {?}
     */
    function (formToken) {
        /** @type {?} */
        var subject = new Subject();
        if (formToken && window['frmMobileService']) {
            window['frmMobileService'].rtf.func.clearState({ formToken: formToken }, (/**
             * @return {?}
             */
            function () { subject.next(true); }));
        }
        return subject;
    };
    /**
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.test = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var requestConfig = {
            responseType: 'text',
            headers: {
                'Content-Type': 'application/json'
            }
        };
        if (this.frmSessionId) {
            requestConfig.headers = BefHttpUtil.appendSessionId(requestConfig.headers, this.frmSessionId);
            requestConfig.headers = BefHttpUtil.appendCafRuntimeCommonVariable(requestConfig.headers, this.frmSessionId);
        }
        return this.httpClient.post(this.beCreateSessionUrl, null, requestConfig).pipe(tap((/**
         * @param {?} beSessionId
         * @return {?}
         */
        function (beSessionId) {
            _this.setSessionId(beSessionId);
            _this.setBesessionExisted(true);
        })));
    };
    /**
     * 关闭BeSessionId
     */
    /**
     * 关闭BeSessionId
     * @protected
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.closeOldSession = /**
     * 关闭BeSessionId
     * @protected
     * @return {?}
     */
    function () {
        var _this = this;
        if (!this.oldBeSessionId) {
            return of(true);
        }
        /** @type {?} */
        var requestConfig = {
            responseType: 'text',
            headers: {
                'Content-Type': 'application/json'
            }
        };
        // headers处理
        requestConfig.headers = BefHttpUtil.appendCafRuntimeContext(requestConfig.headers, this.oldBeSessionId);
        requestConfig.headers = BefHttpUtil.appendSessionId(requestConfig.headers, this.oldBeSessionId);
        if (this.frmSessionId) {
            requestConfig.headers = BefHttpUtil.appendCafRuntimeCommonVariable(requestConfig.headers, this.frmSessionId);
        }
        // 无论是否成功，统一置空cleardBeSessionId
        return this.httpClient.post(this.beCloseSessionUrl, null, requestConfig).pipe(tap((/**
         * @return {?}
         */
        function () {
            _this.oldBeSessionId = null;
            return of(true);
        }), (/**
         * @return {?}
         */
        function () {
            _this.oldBeSessionId = null;
            return of(true);
        })));
    };
    /**
     * 设置BeSession存在状态，并发出通知
     */
    /**
     * 设置BeSession存在状态，并发出通知
     * @protected
     * @param {?} beSessionExisted
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.setBesessionExisted = /**
     * 设置BeSession存在状态，并发出通知
     * @protected
     * @param {?} beSessionExisted
     * @return {?}
     */
    function (beSessionExisted) {
        if (this.beSessionExisted === beSessionExisted) {
            return;
        }
        this.beSessionExisted = beSessionExisted;
        this.beSessionExisted$.next(beSessionExisted);
    };
    /**
     * 获取BeSession是否存在状态
     */
    /**
     * 获取BeSession是否存在状态
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.getBeSessionExisted = /**
     * 获取BeSession是否存在状态
     * @return {?}
     */
    function () {
        return this.beSessionExisted$;
    };
    return BefSessionHandlingStrategy;
}());
if (false) {
    /**
     * 存储策略
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.storageStrategy;
    /**
     * 框架Session服务
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.frmSessionService;
    /**
     * Http客户端
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.httpClient;
    /**
     * 创建Session的的EAPI地址
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.beBaseUrl;
    /**
     * 创建BeSession接口地址
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.beCreateSessionUrl;
    /**
     * 关闭BeSession接口地址
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.beCloseSessionUrl;
    /**
     * 清空的BeSessionId
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.oldBeSessionId;
    /**
     * BeSession是否存在
     * @type {?}
     * @private
     */
    BefSessionHandlingStrategy.prototype.beSessionExisted;
    /**
     * BeSession是否存在流
     * @type {?}
     * @private
     */
    BefSessionHandlingStrategy.prototype.beSessionExisted$;
    /**
     * @abstract
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.getSessionId = function () { };
    /**
     * @abstract
     * @param {?} sessionId
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.setSessionId = function (sessionId) { };
    /**
     * @abstract
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.clearSessionId = function () { };
    /**
     * @abstract
     * @param {?} headers
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.handleRequestHeaders = function (headers) { };
    /**
     * @abstract
     * @param {?} headers
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.handleReponseHeaders = function (headers) { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.getSessionStorageKey = function () { };
}
export { BefSessionHandlingStrategy };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFuZGxpbmdfc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1iZWYvIiwic291cmNlcyI6WyJsaWIvc2Vzc2lvbi9oYW5kbGluZy1zdHJhdGVnaWVzL2hhbmRsaW5nX3N0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFjLGVBQWUsRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHaEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFDOzs7OztBQU9oRDs7Ozs7SUFzREU7O09BRUc7SUFDSCxvQ0FDRSxlQUF5QyxFQUFFLGlCQUEwQyxFQUNyRixVQUFzQixFQUFFLFNBQWlCOzs7O1FBWm5DLHFCQUFnQixHQUFHLEtBQUssQ0FBQztRQWMvQixJQUFJLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQztRQUN2QyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsaUJBQWlCLENBQUM7UUFDM0MsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDN0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsSUFBSSxDQUFDLGtCQUFrQixHQUFNLFNBQVMsMkJBQXdCLENBQUM7UUFDL0QsSUFBSSxDQUFDLGlCQUFpQixHQUFNLFNBQVMsMEJBQXVCLENBQUM7UUFDN0QsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksZUFBZSxDQUFVLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFqQ0Qsc0JBQWMsb0RBQVk7UUFIMUI7O1dBRUc7Ozs7OztRQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUN0RCxDQUFDOzs7T0FBQTtJQXdDRDs7T0FFRzs7Ozs7SUFDSSwwREFBcUI7Ozs7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QThDOzs7OztJQUM5QyxzRUFBdUM7Ozs7OztJQUN2QyxtRkFBd0U7Ozs7OztJQUN4RSxtRkFBaUU7Ozs7OztJQUNqRSw0RUFBa0Q7O0FBZ0pwRCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIEJlaGF2aW9yU3ViamVjdCwgb2YsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgc3dpdGNoTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEh0dHBIZWFkZXJzLCBIdHRwUmVxdWVzdENvbmZpZywgSHR0cENsaWVudCB9IGZyb20gJ0BmYXJyaXMvbW9iaWxlLWRldmtpdCc7XHJcblxyXG5pbXBvcnQgeyBCZWZIdHRwVXRpbCB9IGZyb20gJy4uLy4uL3V0aWxzL2luZGV4JztcclxuaW1wb3J0IHsgRnJhbWV3b3JrU2Vzc2lvblNlcnZpY2UgfSBmcm9tICcuLi8uLi9mcmFtZXdvcmtfc2Vzc2lvbl9zZXJ2aWNlJztcclxuaW1wb3J0IHsgQmVTZXNzaW9uU3RvcmFnZVN0cmF0ZWd5IH0gZnJvbSAnLi4vc3RvcmFnZS1zdHJhdGVnaWVzL2luZGV4JztcclxuXHJcbi8qKlxyXG4gKiBCZWZTZXNzaW9u5aSE55CG562W55Wl57G7XHJcbiAqL1xyXG5hYnN0cmFjdCBjbGFzcyBCZWZTZXNzaW9uSGFuZGxpbmdTdHJhdGVneSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOWtmOWCqOetlueVpVxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBzdG9yYWdlU3RyYXRlZ3k6IEJlU2Vzc2lvblN0b3JhZ2VTdHJhdGVneTtcclxuXHJcbiAgLyoqXHJcbiAgICog5qGG5p62U2Vzc2lvbuacjeWKoVxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBmcm1TZXNzaW9uU2VydmljZTogRnJhbWV3b3JrU2Vzc2lvblNlcnZpY2U7XHJcblxyXG4gIC8qKlxyXG4gICAqIEh0dHDlrqLmiLfnq69cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgaHR0cENsaWVudDogSHR0cENsaWVudDtcclxuXHJcbiAgLyoqXHJcbiAgICog5Yib5bu6U2Vzc2lvbueahOeahEVBUEnlnLDlnYBcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgYmVCYXNlVXJsOiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIm+W7ukJlU2Vzc2lvbuaOpeWPo+WcsOWdgFxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBiZUNyZWF0ZVNlc3Npb25Vcmw6IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICog5YWz6ZetQmVTZXNzaW9u5o6l5Y+j5Zyw5Z2AXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGJlQ2xvc2VTZXNzaW9uVXJsOiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIOahhuaetlNlc3Npb25JZO+8iOeUqOaIt+eahOaIluiAheWKn+iDveiPnOWNleeahO+8iVxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBnZXQgZnJtU2Vzc2lvbklkKCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5mcm1TZXNzaW9uU2VydmljZS5nZXRDdXJyZW50U2Vzc2lvbklkKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmuIXnqbrnmoRCZVNlc3Npb25JZFxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBvbGRCZVNlc3Npb25JZDogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiBCZVNlc3Npb27mmK/lkKblrZjlnKhcclxuICAgKi9cclxuICBwcml2YXRlIGJlU2Vzc2lvbkV4aXN0ZWQgPSBmYWxzZTtcclxuXHJcbiAgLyoqXHJcbiAgICogQmVTZXNzaW9u5piv5ZCm5a2Y5Zyo5rWBXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBiZVNlc3Npb25FeGlzdGVkJDogQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+O1xyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHN0b3JhZ2VTdHJhdGVneTogQmVTZXNzaW9uU3RvcmFnZVN0cmF0ZWd5LCBmcm1TZXNzaW9uU2VydmljZTogRnJhbWV3b3JrU2Vzc2lvblNlcnZpY2UsXHJcbiAgICBodHRwQ2xpZW50OiBIdHRwQ2xpZW50LCBiZUJhc2VVcmw6IHN0cmluZ1xyXG4gICkge1xyXG4gICAgdGhpcy5zdG9yYWdlU3RyYXRlZ3kgPSBzdG9yYWdlU3RyYXRlZ3k7XHJcbiAgICB0aGlzLmZybVNlc3Npb25TZXJ2aWNlID0gZnJtU2Vzc2lvblNlcnZpY2U7XHJcbiAgICB0aGlzLmh0dHBDbGllbnQgPSBodHRwQ2xpZW50O1xyXG4gICAgdGhpcy5iZUJhc2VVcmwgPSBiZUJhc2VVcmw7XHJcbiAgICB0aGlzLmJlQ3JlYXRlU2Vzc2lvblVybCA9IGAke2JlQmFzZVVybH0vc2VydmljZS9jcmVhdGVzZXNzaW9uYDtcclxuICAgIHRoaXMuYmVDbG9zZVNlc3Npb25VcmwgPSBgJHtiZUJhc2VVcmx9L3NlcnZpY2UvY2xvc2VzZXNzaW9uYDtcclxuICAgIHRoaXMuYmVTZXNzaW9uRXhpc3RlZCQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KHRoaXMuYmVTZXNzaW9uRXhpc3RlZCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYWJzdHJhY3QgZ2V0U2Vzc2lvbklkKCk6IE9ic2VydmFibGU8c3RyaW5nPjtcclxuICBwdWJsaWMgYWJzdHJhY3Qgc2V0U2Vzc2lvbklkKHNlc3Npb25JZCk6IHZvaWQ7XHJcbiAgcHVibGljIGFic3RyYWN0IGNsZWFyU2Vzc2lvbklkKCk6IHZvaWQ7XHJcbiAgcHVibGljIGFic3RyYWN0IGhhbmRsZVJlcXVlc3RIZWFkZXJzKGhlYWRlcnM6IEh0dHBIZWFkZXJzKTogSHR0cEhlYWRlcnM7XHJcbiAgcHVibGljIGFic3RyYWN0IGhhbmRsZVJlcG9uc2VIZWFkZXJzKGhlYWRlcnM6IEh0dHBIZWFkZXJzKTogdm9pZDtcclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0U2Vzc2lvblN0b3JhZ2VLZXkoKTogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiDojrflj5bmoYbmnrZTZXNzaW9uSWRcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RnJhbWV3b3JrU2Vzc2lvbklkKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZnJtU2Vzc2lvbklkO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5LuO57yT5a2Y5Lit6I635Y+WQmVTZXNzaW9uXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGdldFNlc3Npb25JZEZyb21TdG9yYWdlKCkge1xyXG4gICAgY29uc3Qgc2Vzc2lvblN0b3JhZ2VLZXkgPSB0aGlzLmdldFNlc3Npb25TdG9yYWdlS2V5KCk7XHJcbiAgICBjb25zdCBiZVNlc3Npb25JZCA9IHRoaXMuc3RvcmFnZVN0cmF0ZWd5LmdldEl0ZW0oc2Vzc2lvblN0b3JhZ2VLZXkpO1xyXG4gICAgcmV0dXJuIGJlU2Vzc2lvbklkO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yib5bu6QmVTZXNzaW9uSWRcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgY3JlYXRlU2Vzc2lvbigpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xyXG4gICAgY29uc3QgcmVxdWVzdENvbmZpZzogSHR0cFJlcXVlc3RDb25maWcgPSB7XHJcbiAgICAgIHJlc3BvbnNlVHlwZTogJ3RleHQnLFxyXG4gICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gICAgY29uc3QgZnJtU2Vzc2lvbklkID0gdGhpcy5mcm1TZXNzaW9uSWQ7XHJcbiAgICBpZiAoZnJtU2Vzc2lvbklkKSB7XHJcbiAgICAgIHJlcXVlc3RDb25maWcuaGVhZGVycyA9IEJlZkh0dHBVdGlsLmFwcGVuZFNlc3Npb25JZChyZXF1ZXN0Q29uZmlnLmhlYWRlcnMsIHRoaXMuZnJtU2Vzc2lvbklkKTtcclxuICAgICAgcmVxdWVzdENvbmZpZy5oZWFkZXJzID0gQmVmSHR0cFV0aWwuYXBwZW5kQ2FmUnVudGltZUNvbW1vblZhcmlhYmxlKHJlcXVlc3RDb25maWcuaGVhZGVycywgdGhpcy5mcm1TZXNzaW9uSWQpO1xyXG4gICAgfVxyXG4gICAgLy/liJvlu7rliY3liKTmlq3lvZPliY3nmoRmcm1zZXNzaW9uaWTmmK/kuI3mmK/lnKjlvZPliY3kvJror53kuIvooqvmuIXpmaTov4dcclxuICAgIGNvbnN0IENsZWFySXRPbmNlID0gd2luZG93LnNlc3Npb25TdG9yYWdlLmdldEl0ZW0oXCJDbGVhckl0T25jZVwiKTtcclxuICAgIGlmICgndHJ1ZScgIT09IENsZWFySXRPbmNlICAmJiBmcm1TZXNzaW9uSWQpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuY2xlYXIoZnJtU2Vzc2lvbklkKS5waXBlKFxyXG4gICAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XHJcbiAgICAgICAgICB3aW5kb3cuc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShcIkNsZWFySXRPbmNlXCIsICd0cnVlJyk7XHJcbiAgICAgICAgICByZXR1cm4gdGhpcy5odHRwQ2xpZW50LnBvc3QodGhpcy5iZUNyZWF0ZVNlc3Npb25VcmwsIG51bGwsIHJlcXVlc3RDb25maWcpLnBpcGUoXHJcbiAgICAgICAgICAgIHRhcCgoYmVTZXNzaW9uSWQ6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICAgIHRoaXMuc2V0U2Vzc2lvbklkKGJlU2Vzc2lvbklkKTtcclxuICAgICAgICAgICAgICB0aGlzLnNldEJlc2Vzc2lvbkV4aXN0ZWQodHJ1ZSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICApO1xyXG5cclxuICAgICAgICB9KVxyXG4gICAgICApXHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuaHR0cENsaWVudC5wb3N0KHRoaXMuYmVDcmVhdGVTZXNzaW9uVXJsLCBudWxsLCByZXF1ZXN0Q29uZmlnKS5waXBlKFxyXG4gICAgICB0YXAoKGJlU2Vzc2lvbklkOiBzdHJpbmcpID0+IHtcclxuICAgICAgICB0aGlzLnNldFNlc3Npb25JZChiZVNlc3Npb25JZCk7XHJcbiAgICAgICAgdGhpcy5zZXRCZXNlc3Npb25FeGlzdGVkKHRydWUpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGNsZWFyKGZvcm1Ub2tlbikge1xyXG4gICAgY29uc3Qgc3ViamVjdCA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgICBpZiAoZm9ybVRva2VuICYmIHdpbmRvd1snZnJtTW9iaWxlU2VydmljZSddKSB7XHJcbiAgICAgIHdpbmRvd1snZnJtTW9iaWxlU2VydmljZSddLnJ0Zi5mdW5jLmNsZWFyU3RhdGUoeyBmb3JtVG9rZW4gfSwgKCkgPT4geyBzdWJqZWN0Lm5leHQodHJ1ZSkgfSwpXHJcbiAgICB9XHJcbiAgICByZXR1cm4gc3ViamVjdDtcclxuICB9XHJcblxyXG4gIHRlc3QoKSB7XHJcbiAgICBjb25zdCByZXF1ZXN0Q29uZmlnOiBIdHRwUmVxdWVzdENvbmZpZyA9IHtcclxuICAgICAgcmVzcG9uc2VUeXBlOiAndGV4dCcsXHJcbiAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nXHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgaWYgKHRoaXMuZnJtU2Vzc2lvbklkKSB7XHJcbiAgICAgIHJlcXVlc3RDb25maWcuaGVhZGVycyA9IEJlZkh0dHBVdGlsLmFwcGVuZFNlc3Npb25JZChyZXF1ZXN0Q29uZmlnLmhlYWRlcnMsIHRoaXMuZnJtU2Vzc2lvbklkKTtcclxuICAgICAgcmVxdWVzdENvbmZpZy5oZWFkZXJzID0gQmVmSHR0cFV0aWwuYXBwZW5kQ2FmUnVudGltZUNvbW1vblZhcmlhYmxlKHJlcXVlc3RDb25maWcuaGVhZGVycywgdGhpcy5mcm1TZXNzaW9uSWQpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0aGlzLmh0dHBDbGllbnQucG9zdCh0aGlzLmJlQ3JlYXRlU2Vzc2lvblVybCwgbnVsbCwgcmVxdWVzdENvbmZpZykucGlwZShcclxuICAgICAgdGFwKChiZVNlc3Npb25JZDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgdGhpcy5zZXRTZXNzaW9uSWQoYmVTZXNzaW9uSWQpO1xyXG4gICAgICAgIHRoaXMuc2V0QmVzZXNzaW9uRXhpc3RlZCh0cnVlKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlhbPpl61CZVNlc3Npb25JZFxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBjbG9zZU9sZFNlc3Npb24oKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICBpZiAoIXRoaXMub2xkQmVTZXNzaW9uSWQpIHtcclxuICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHJlcXVlc3RDb25maWc6IEh0dHBSZXF1ZXN0Q29uZmlnID0ge1xyXG4gICAgICByZXNwb25zZVR5cGU6ICd0ZXh0JyxcclxuICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICAvLyBoZWFkZXJz5aSE55CGXHJcbiAgICByZXF1ZXN0Q29uZmlnLmhlYWRlcnMgPSBCZWZIdHRwVXRpbC5hcHBlbmRDYWZSdW50aW1lQ29udGV4dChyZXF1ZXN0Q29uZmlnLmhlYWRlcnMsIHRoaXMub2xkQmVTZXNzaW9uSWQpO1xyXG4gICAgcmVxdWVzdENvbmZpZy5oZWFkZXJzID0gQmVmSHR0cFV0aWwuYXBwZW5kU2Vzc2lvbklkKHJlcXVlc3RDb25maWcuaGVhZGVycywgdGhpcy5vbGRCZVNlc3Npb25JZCk7XHJcbiAgICBpZiAodGhpcy5mcm1TZXNzaW9uSWQpIHtcclxuICAgICAgcmVxdWVzdENvbmZpZy5oZWFkZXJzID0gQmVmSHR0cFV0aWwuYXBwZW5kQ2FmUnVudGltZUNvbW1vblZhcmlhYmxlKHJlcXVlc3RDb25maWcuaGVhZGVycywgdGhpcy5mcm1TZXNzaW9uSWQpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOaXoOiuuuaYr+WQpuaIkOWKn++8jOe7n+S4gOe9ruepumNsZWFyZEJlU2Vzc2lvbklkXHJcbiAgICByZXR1cm4gdGhpcy5odHRwQ2xpZW50LnBvc3QodGhpcy5iZUNsb3NlU2Vzc2lvblVybCwgbnVsbCwgcmVxdWVzdENvbmZpZykucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgICgpID0+IHtcclxuICAgICAgICAgIHRoaXMub2xkQmVTZXNzaW9uSWQgPSBudWxsO1xyXG4gICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5vbGRCZVNlc3Npb25JZCA9IG51bGw7XHJcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572uQmVTZXNzaW9u5a2Y5Zyo54q25oCB77yM5bm25Y+R5Ye66YCa55+lXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHNldEJlc2Vzc2lvbkV4aXN0ZWQoYmVTZXNzaW9uRXhpc3RlZDogYm9vbGVhbikge1xyXG4gICAgaWYgKHRoaXMuYmVTZXNzaW9uRXhpc3RlZCA9PT0gYmVTZXNzaW9uRXhpc3RlZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLmJlU2Vzc2lvbkV4aXN0ZWQgPSBiZVNlc3Npb25FeGlzdGVkO1xyXG4gICAgdGhpcy5iZVNlc3Npb25FeGlzdGVkJC5uZXh0KGJlU2Vzc2lvbkV4aXN0ZWQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+WQmVTZXNzaW9u5piv5ZCm5a2Y5Zyo54q25oCBXHJcbiAgICovXHJcbiAgcHVibGljIGdldEJlU2Vzc2lvbkV4aXN0ZWQoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICByZXR1cm4gdGhpcy5iZVNlc3Npb25FeGlzdGVkJDtcclxuICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQgeyBCZWZTZXNzaW9uSGFuZGxpbmdTdHJhdGVneSB9O1xyXG4iXX0=