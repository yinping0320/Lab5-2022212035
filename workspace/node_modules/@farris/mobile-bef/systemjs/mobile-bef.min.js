System.register(["@farris/mobile-devkit","rxjs","rxjs/operators"],(function(t){"use strict";var e,n,r,i,o,a,s,p,u,y,c,h,l,f,d,g,v,S,I,C,E,b,m,B,x,P;return{setters:[function(t){e=t.InjectionToken,n=t.EntityCollection,r=t.HttpMethods,i=t.makePropDecorator,o=t.DataChangeType,a=t.AppContext,s=t.MetadataUtil,p=t.InjectFlags,u=t.HttpClient,y=t.Repository,c=t.HttpUtil,h=t.BindingPathConverter,l=t.PropertyUtil,f=t.BindingPropertyType,d=t.FieldMetadataUtil,g=t.ModifyType,v=t.EntityManager},function(t){S=t.Subject,I=t.of,C=t.EMPTY,E=t.zip,b=t.BehaviorSubject},function(t){m=t.switchMap,B=t.tap,x=t.map,P=t.catchError}],execute:function(){var T=function(t,e){return(T=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function D(t,e){function n(){this.constructor=t}T(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function w(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a}var O=t("ChangeDetailType",function(){function t(){}return t.Added="Added",t.Modify="Modify",t.Deleted="Deleted",t}()),U=(t("BE_SERVER_URI_TOKEN",new e("@farris/be BE_SERVER_URL")),t("BE_SESSION_HANDLING_STRATEGY_TOKEN",new e("@farris/be BE_SESSION_HANDLING_STRATEGY_TOKEN"))),R=t("BE_ERROR_HANDLER__TOKEN",new e("@farris/be BE_ERROR_HANDLER__TOKEN")),M=t("BefHttpUtil",function(){function t(){}return t.appendSessionId=function(t,e){return t=c.appendHeader(t,"SessionId",e)},t.appendCafRuntimeCommonVariable=function(t,e){return t=c.appendHeader(t,"X-CAF-Runtime-CommonVariable",e)},t.appendCafRuntimeContext=function(t,e){return t=c.appendHeader(t,"X-CAF-Runtime-Context",e)},t.appendContextType=function(t,e){return e=e||"application/json",t=c.appendHeader(t,"Content-Type",e)},t}()),A=t("RequestInfoUtil",function(){function t(){}return t.buildRequestInfo=function(t){return{dataChange:t.entityManager.buildAllEntityChangeDetails(),variableChange:t.variableManager.buildChangeDetail()}},t.appendRequestInfoToBody=function(t,e){if(t.requestInfo)return t;var n=this.buildRequestInfo(e);return t&&0!==Object.keys(t).length?Object.assign({},t,{requestInfo:n}):n},t}()),V=(t("ResponseInfoUtil",function(){function t(){}return t.unWrapResponseInfo=function(t){if(!t)return t;if(!1===t.hasOwnProperty("returnValue"))return t.hasOwnProperty("result")&&t.hasOwnProperty("pagination")?t.result:t;var e=t.returnValue;return e&&e.hasOwnProperty("result")&&e.hasOwnProperty("pagination")?e.result:t.returnValue},t}()),t("BefChangeUtil",function(){function t(){}return t.createEmpty=function(t,e){var n={ChangeType:t,ChangeInfo:{}};return e&&(n.ChangeInfo.DataId=e),n},t.getChangeInfo=function(t){return!0===this.isChangeDetail(t)?t.ChangeInfo:t},t.isChangeDetail=function(t){var e=Object.keys(t);return 2===e.length&&e.indexOf("ChangeType")>-1&&e.indexOf("ChangeInfo")>-1},t}())),j=t("BefDataPathUtil",function(){function t(){}return t.convertToPathArray=function(t,e){var n=this,r=h.toBindingPathArray(t),i=[],o=e.list.currentItem;return i.push(o.primaryKeyValue),r.forEach((function(t){var e=l.getPropertyByName(o.properties,t);if(e.type!==f.List)throw new Error(e.name+"不是子表对应的属性");var r=o[t];o=r.currentItem,i.push(n.trimTrailingS(t)),i.push(o.primaryKeyValue)})),i},t.convertToPathUrl=function(t,e){var n=this.convertToPathArray(t,e);return n.pop(),"/"+n.join("/")},t.convertToObjectCodes=function(t,e){for(var n=this.convertToPathArray(t,e),r=n.length,i=[],o=1;o<r;o+=2)i.push(n[o]);return i},t.convertToDataIdsForUpdate=function(t,e){for(var n=this.convertToPathArray(t,e),r=n.length,i=[],o=0;o<r;o+=2)i.push(n[o]);return i},t.convertToDataIdsForAdd=function(t,e){var n=this.convertToDataIdsForUpdate(t,e);return n.pop(),n},t.convertPathToUrl=function(t){for(var e=t.split("/"),n=e.length-1;n>0;n--)e[n]&&e[n].endsWith("s")&&(e[n]=e[n].substr(0,e[n].length-1));return e.join("/").toLowerCase()},t.trimTrailingS=function(t){return t.substr(0,t.length-1)},t.convertPathsToNodeCodes=function(t){var e=[];return!t||t.length<1||t.filter((function(t){return!!t&&-1===t.indexOf(":")})).forEach((function(t){e.push(t)})),e},t.convertPathsToIds=function(t){var e=[];return!t||t.length<1||t.filter((function(t){return!!t&&-1!==t.indexOf(":")})).forEach((function(t){e.push(t.split(":")[1])})),e},t}()),H=(t("BefProxyUtil",function(){function t(){}return t.buildRequestInfo=function(t){return{dataChange:t.entityManager.buildAllEntityChangeDetails(),variableChange:t.variableManager.buildChangeDetail()}},t}()),t("BefRepositoryUtil",function(){function t(){}return t.isExistUnsaveData=function(t){var e=!1;if(!t||!t.entityCollection)throw new Error("Current Object is null or it's entityCollection is null.");var n=t.entityCollection.toArray();if(t.dataChangeHistory.isChanged())return!0;for(var r=0;r<n.length;r++)if(n[r].changes.length>0){e=!0;break}return e},t}()),t("EntityUtil",function(){function t(){}return t.getPropInfo=function(t,e){var n,r,i,o=d.getNgFields(t);Object.keys(o).forEach((function(t){t===e&&(n="NgField",r=null,i=o[t])}));var a=d.getNgObjects(t);Object.keys(a).forEach((function(t){t===e&&(n="NgObject",r=a[t].type,i=a[t])}));var s=d.getNgList(t);Object.keys(s).forEach((function(t){t===e&&(n="NgList",r=s[t].type,i=s[t])}));var p=d.getNgDynamic(t);return Object.keys(p).forEach((function(t){t===e&&(n="NgDynamic",r=p[t].type,i=p[t])})),{propType:n,propEntityType:r,propMetadata:i}},t.getPrimaryKey=function(t){var e=d.getPrimaryFieldMetadata(t);return e?e.dataField:""},t.isObjectProp=function(t,e){var n=!1,r=d.getNgObjects(t);return Object.keys(r).forEach((function(t){t===e&&(n=!0)})),n},t.isDynamicProp=function(t,e){var n=!1,r=d.getNgDynamic(t);return Object.keys(r).forEach((function(t){t===e&&(n=!0)})),n},t.appendInitialData=function(t,e){var n=Object.assign({},e);delete n.id,delete n.parentID,t.initialData=n},t}())),N=t("BefEnvUtil",function(){function t(){}return t.isInFramework=function(){var t=window.location.hash;return!!t&&-1!==t.indexOf("formToken=")},t}()),q=t("BefChangeBuilder",function(){function t(t,e){this.entityType=t,this.entityCollection=e}return t.prototype.build=function(t){var e=this;return this.changeDetail={ChangeType:O.Modify,ChangeInfo:{DataId:""}},t.forEach((function(t){e.buildChangeDetail(t)})),this.changeDetail},t.prototype.buildChangeDetail=function(t){var e=t.path.concat();this.changeDetail.ChangeInfo.DataId||(this.changeDetail.ChangeInfo.DataId=e[0].split(":")[1]);for(var n=this.changeDetail,r=this.entityType,i=function(i){var a=o.getChangeInfo(n),s=e[i],p=H.getPropInfo(r,s),u=p.propType,y=p.propEntityType,c=p.propMetadata.dataField||s;if("NgField"===u){if(s===H.getPrimaryKey(r))return"continue";if(t.type!==g.ValueChange)throw Error("简单类型的属性上不支持ValueChange类型之外的变更");a[c]=t.value,n=null}else if("NgObject"===u){if(e[i+1].split(":")[1],e[i+1].split(":")[0]){var h=a[c],l=e.slice(0,i+1);h=(S=o.entityCollection.getEntityByPath(l))?S.toJSON():{},a[c]=h,n=null,r=null}else{(d=a[c])||(d={ChangeType:O.Modify,ChangeInfo:{}}),a[c]=d,n=d,r=y}}else if("NgList"===u){n.ChangeInfo[c]||(n.ChangeInfo[c]=[]);var f=n.ChangeInfo[c];if(i!==e.length-1){var d,v=e[i+1].split(":")[1];return(d=f.find((function(t){return t.ChangeInfo.DataId===v})))||(d=o.createEmptyChangeDetail(O.Modify,v),f.push(d)),n=d,r=y,"continue"}n=null,r=null}else if("NgDynamic"===u){l=e.slice(0,i+1);var S=o.entityCollection.getEntityByPath(l);a[c]={ChangeType:O.Modify,ChangeInfo:S?S.toJSON():{}},n=null,r=null}},o=this,a=1;a<e.length&&n;a+=2)i(a)},t.prototype.getChangeInfo=function(t){return t.hasOwnProperty("ChangeInfo")?t.ChangeInfo:t},t.prototype.createEmptyChangeDetail=function(t,e){return{ChangeType:t,ChangeInfo:{DataId:e}}},t}()),F=t("BefChangeHandler",function(){function t(){}return t.prototype.handle=function(t,e,n){this.handleChangeDetails(t,e,n)},t.prototype.handleChangeDetails=function(t,e,n){var r=this;n&&n.forEach((function(n){var i=n.ChangeInfo.dataId||n.ChangeInfo.DataId,o=r.getEntityById(e,i);o&&r.handleChangeDetail(t,o,n)}))},t.prototype.handleChangeDetail=function(t,e,n){var r=this;if(n&&e&&n.ChangeType===O.Modify){var i=n.ChangeInfo;Object.keys(i).forEach((function(n){var o=H.getPropInfo(t,n),a=o.propType,s=o.propEntityType;if("NgField"===a)e[n]=i[n];else if("NgObject"===a){var p=e[n];if(p.primaryKey){var u=i[n];p.load(u)}else{var y=i[n];r.handleChangeDetail(s,p,y)}}else if("NgList"===a){var c=e[n],h=i[n];r.handleChangeDetails(s,c,h)}}))}},t.prototype.getEntityById=function(t,e){return(t instanceof n?t.getEntityById(e):t.get(e))||null},t}()),_=t("BefSessionHandlingStrategy",function(){function t(t,e,n,r){this.beSessionExisted=!1,this.storageStrategy=t,this.frmSessionService=e,this.httpClient=n,this.beBaseUrl=r,this.beCreateSessionUrl=r+"/service/createsession",this.beCloseSessionUrl=r+"/service/closesession",this.beSessionExisted$=new b(this.beSessionExisted)}return Object.defineProperty(t.prototype,"frmSessionId",{get:function(){return this.frmSessionService.getCurrentSessionId()},enumerable:!0,configurable:!0}),t.prototype.getFrameworkSessionId=function(){return this.frmSessionId},t.prototype.getSessionIdFromStorage=function(){var t=this.getSessionStorageKey();return this.storageStrategy.getItem(t)},t.prototype.createSession=function(){var t=this,e={responseType:"text",headers:{"Content-Type":"application/json"}},n=this.frmSessionId;return n&&(e.headers=M.appendSessionId(e.headers,this.frmSessionId),e.headers=M.appendCafRuntimeCommonVariable(e.headers,this.frmSessionId)),"true"!==window.sessionStorage.getItem("ClearItOnce")&&n?this.clear(n).pipe(m((function(){return window.sessionStorage.setItem("ClearItOnce","true"),t.httpClient.post(t.beCreateSessionUrl,null,e).pipe(B((function(e){t.setSessionId(e),t.setBesessionExisted(!0)})))}))):this.httpClient.post(this.beCreateSessionUrl,null,e).pipe(B((function(e){t.setSessionId(e),t.setBesessionExisted(!0)})))},t.prototype.clear=function(t){var e=new S;return t&&window.frmMobileService&&window.frmMobileService.rtf.func.clearState({formToken:t},(function(){e.next(!0)})),e},t.prototype.test=function(){var t=this,e={responseType:"text",headers:{"Content-Type":"application/json"}};return this.frmSessionId&&(e.headers=M.appendSessionId(e.headers,this.frmSessionId),e.headers=M.appendCafRuntimeCommonVariable(e.headers,this.frmSessionId)),this.httpClient.post(this.beCreateSessionUrl,null,e).pipe(B((function(e){t.setSessionId(e),t.setBesessionExisted(!0)})))},t.prototype.closeOldSession=function(){var t=this;if(!this.oldBeSessionId)return I(!0);var e={responseType:"text",headers:{"Content-Type":"application/json"}};return e.headers=M.appendCafRuntimeContext(e.headers,this.oldBeSessionId),e.headers=M.appendSessionId(e.headers,this.oldBeSessionId),this.frmSessionId&&(e.headers=M.appendCafRuntimeCommonVariable(e.headers,this.frmSessionId)),this.httpClient.post(this.beCloseSessionUrl,null,e).pipe(B((function(){return t.oldBeSessionId=null,I(!0)}),(function(){return t.oldBeSessionId=null,I(!0)})))},t.prototype.setBesessionExisted=function(t){this.beSessionExisted!==t&&(this.beSessionExisted=t,this.beSessionExisted$.next(t))},t.prototype.getBeSessionExisted=function(){return this.beSessionExisted$},t}()),k=t("BefSeparatedSessionHandlingStrategy",function(t){function e(e,n,r,i){return t.call(this,e,n,r,i)||this}return D(e,t),e.prototype.getSessionId=function(){var t,e=this.getSessionIdFromStorage();return e?(t=I(e),this.setBesessionExisted(!0)):t=this.createSession(),this.closeOldSession().pipe(m((function(){return t})))},e.prototype.setSessionId=function(t){var e=this.getSessionStorageKey();this.storageStrategy.setItem(e,t)},e.prototype.clearSessionId=function(){if(!0===N.isInFramework())this.storageStrategy.removeItemsByScope(this.frmSessionId);else{var t=this.getSessionStorageKey();this.oldBeSessionId=this.getSessionIdFromStorage(),this.storageStrategy.removeItem(t)}},e.prototype.handleRequestHeaders=function(t){var e=this.getFrameworkSessionId(),n=this.getSessionIdFromStorage();return e&&(t=M.appendCafRuntimeCommonVariable(t,e)),n&&(t=M.appendCafRuntimeContext(t,n),t=M.appendSessionId(t,n)),t},e.prototype.handleReponseHeaders=function(t){},e.prototype.getSessionStorageKey=function(){return this.frmSessionId+"_"+this.beBaseUrl},e}(_)),K=t("BefUnifiedSessionHandlingStrategy",function(t){function e(e,n,r,i){var o=t.call(this,e,n,r,i)||this;return o.beCloseSessionUrl=i+"/service/closesession",o}return D(e,t),e.prototype.getSessionId=function(){var t=this.getSessionStorageKey(),e=this.storageStrategy.getItem(t),n=I(e);return this.closeOldSession().pipe(m((function(){return n})))},e.prototype.setSessionId=function(t){var e=this.getSessionStorageKey();this.storageStrategy.setItem(e,t)},e.prototype.clearSessionId=function(){var t=this.getSessionStorageKey();this.oldBeSessionId=this.getSessionIdFromStorage(),this.storageStrategy.removeItem(t)},e.prototype.handleRequestHeaders=function(t){var e=this.getFrameworkSessionId();e&&(t=M.appendCafRuntimeCommonVariable(t,e));var n=this.getSessionIdFromStorage();return n&&(t=M.appendCafRuntimeContext(t,n)),t},e.prototype.handleReponseHeaders=function(t){var e=t.befsessionid,n=this.getSessionId();e&&e!==n&&this.setSessionId(e)},e.prototype.getSessionStorageKey=function(){return this.beBaseUrl},e}(_)),L=t("SessionStorageBeSessionStorageStrategy",function(){function t(){this.sessionStorageKey="BE_SESSION_ID"}return t.prototype.getItem=function(t){return this.getAllBeSessions()[t]},t.prototype.setItem=function(t,e){var n=this.getAllBeSessions();n[t]=e,this.setAllBeSessions(n)},t.prototype.removeItem=function(t){var e=this.getAllBeSessions();e[t]&&delete e[t],this.setAllBeSessions(e)},t.prototype.removeItemsByScope=function(t){var e=this.getAllBeSessions();Object.keys(e).forEach((function(n){!0===n.startsWith(t)&&delete e[n]})),this.setAllBeSessions(e)},t.prototype.clear=function(){window.sessionStorage.removeItem(this.sessionStorageKey)},t.prototype.getAllBeSessions=function(){var t=window.sessionStorage.getItem(this.sessionStorageKey);return t?JSON.parse(t):{}},t.prototype.setAllBeSessions=function(t){var e=JSON.stringify(t);window.sessionStorage.setItem(this.sessionStorageKey,e)},t}()),G=t("BefSessionHandlingStrategyFactory",function(){function t(){}return t.prototype.create=function(t,e,n,r){var i=this.createStorageStrategy();return"UnifiedSession"===t?new K(i,e,r,n):new k(i,e,r,n)},t.prototype.createStorageStrategy=function(){return new L},t}()),J=t("BefSessionService",function(){function t(t){this.handlingStrategy=t}return Object.defineProperty(t.prototype,"token",{get:function(){return this.handlingStrategy.getFrameworkSessionId()},enumerable:!0,configurable:!0}),t.prototype.getBeSessionId=function(){return this.handlingStrategy.getSessionId()},t.prototype.getBeSessionExisted=function(){return this.handlingStrategy.getBeSessionExisted()},t.prototype.setBeSessionId=function(t){this.handlingStrategy.setSessionId(t)},t.prototype.clearBeSessionId=function(){this.handlingStrategy.clearSessionId()},t.prototype.extendRequestHeaders=function(t){return this.handlingStrategy.handleRequestHeaders(t)},t.prototype.handleResponseHeaders=function(t){return this.handlingStrategy.handleReponseHeaders(t)},t}()),W=(t("BefProxy",function(){function t(t){this.httpClient=t,this.associatedUrlMap=new Map}return t.prototype.setAssociatedUrl=function(t){this.associatedUrlMap.set(t,t)},t.prototype.setProxyExtend=function(t){this.proxyExtend=t},t.prototype.query=function(t){var e=this.baseUrl,n={};if(t){var i=JSON.stringify(t);n.entityFilter=i}var o={params:n};return this.request(r.GET,e,o)},t.prototype.extendQuery=function(t){var e=this.baseUrl+"/extension/query",n={};if(t){var i=JSON.stringify(t);n.entityFilter=i}var o={params:n};return this.request(r.PUT,e,o)},t.prototype.retrieve=function(t){var e=this.baseUrl+"/"+t;return this.request(r.GET,e)},t.prototype.extendRetrieve=function(t){var e=this.baseUrl+"/extension/retrieve/"+t;return this.request(r.PUT,e)},t.prototype.edit=function(t){var e=this.baseUrl+"/service/edit/"+t;return this.request(r.PUT,e)},t.prototype.create=function(t,e){var n={body:{defaultValue:t,requestInfo:e}};return this.request(r.POST,this.baseUrl,n)},t.prototype.createByPath=function(t){var e=j.convertPathToUrl(t),n=""+this.baseUrl+e;return this.request(r.POST,n)},t.prototype.update=function(t){var e={body:{changeDetail:t}};return this.request(r.PATCH,this.baseUrl,e)},t.prototype.save=function(){return this.request(r.PUT,this.baseUrl)},t.prototype.delete=function(t){var e=this.baseUrl+"/"+t;return this.request(r.DELETE,e)},t.prototype.extendDelete=function(t){var e=this.baseUrl+"/extension/delete/"+t;return this.request(r.PUT,e)},t.prototype.deleteAndSave=function(t){var e=this.baseUrl+"/service/delete/"+t;return this.request(r.PUT,e,{})},t.prototype.deletByPath=function(t,e){var n=j.convertPathToUrl(t),i=""+this.baseUrl+n+"/"+e;return this.request(r.DELETE,i)},t.prototype.extendDeletByPath=function(t,e){var n=j.convertPathToUrl(t),i=this.baseUrl+"/extension"+n+"/"+e;return this.request(r.PUT,i)},t.prototype.batchDelete=function(t){var e={params:{ids:t.join(",")}};return this.request(r.DELETE,this.baseUrl,e)},t.prototype.extendBatchDelete=function(t){var e=this.baseUrl+"/extension/batchdelete",n={params:{ids:t.join(",")}};return this.request(r.PUT,e,n)},t.prototype.cancel=function(){var t=this.baseUrl+"/service/cancel";return this.request(r.POST,t)},t.prototype.request=function(t,e,n,i){var o=this;if(void 0===i&&(i=!1),n=n||{},!0!==i&&(t===r.POST||t===r.PUT||t===r.PATCH)){var a=n.body||{};n.body=this.proxyExtend.extendBody(a)}return this.proxyExtend.extendHeaders(n.headers).pipe(m((function(r){return n.headers=r,n.observe="response",o.httpClient.request(t,e,n).pipe(x((function(t){return!0===i?t&&t.body&&t.body.returnValue?t.body.returnValue:t:o.proxyExtend.onResponse(t)})),P((function(t){return o.proxyExtend.onError(t,!1,!1)})))})),P((function(t){return o.proxyExtend.onError(t,!1,!1)})))},t}()),t("VARIABLE_PROP_META","@farris/bef VARIABLE_PROP_META")),Y=(t("VariablePropMeta",i(W,(function(t){return t}))),function(t){function e(e){var n=t.call(this,e)||this;return n.changeBuilder=new q(n.entityCollection.entityType,n.entityCollection),n.changeHandler=new F,n}return D(e,t),e.prototype.buildAllEntityChangeDetails=function(){var t=this,e=[];return this.entityCollection.getAllEntities().forEach((function(n){if(0!==n.changes.length){var r=t.changeBuilder.build(n.changes);r&&r.ChangeInfo&&r.ChangeInfo.DataId&&e.push(r)}})),e},e.prototype.buildEntityChangeDetailById=function(t){var e=this.entityCollection.getEntityById(t);return 0===e.changes.length?null:this.changeBuilder.build(e.changes)},e.prototype.handleDataChangeDetails=function(t){this.changeHandler.handle(this.entityType,this.entityCollection,t)},e.prototype.reset=function(){this.entityCollection.clear()},e}(v)),$=function(){function t(t){var e=this;this.ngVariables=t,this.ngVariableMap=new Map,this.lastSyncValuesMap=new Map,this.latestVariableValues=new Map,Object.keys(this.ngVariables).forEach((function(n){e.ngVariableMap.set(n,t[n])}))}return t.prototype.setValue=function(t,e){if(!1===this.ngVariableMap.has(t))throw new Error("不存在名为"+t+"的变量");this.latestVariableValues.set(t,e)},t.prototype.getValue=function(t){if(!1===this.ngVariableMap.has(t))throw new Error("不存在名为"+t+"的变量");this.latestVariableValues.get(t)},t.prototype.handleChangeDetail=function(t){},t.prototype.buildChangeDetail=function(){var t=this,e=V.createEmpty(O.Modify);return this.ngVariableMap.forEach((function(n,r){var i=t.latestVariableValues.get(r),o=t.lastSyncValuesMap.get(r);!1===t.isValueEqual(i,o)&&(t.lastSyncValuesMap.set(r,i),t.appendToChangeInfo(e,r,i))})),0===Object.keys(e.ChangeInfo).length?null:e},t.prototype.reset=function(){this.lastSyncValuesMap.clear(),this.latestVariableValues.clear()},t.prototype.appendToChangeInfo=function(t,e,n){if(!0===this.isUdtVariable(n)){var r=V.createEmpty(O.Modify);r.ChangeInfo=n,t.ChangeInfo[e]=r}else t.ChangeInfo[e]=n},t.prototype.isValueEqual=function(t,e){return JSON.stringify(t)===JSON.stringify(e)},t.prototype.isUdtVariable=function(t){return t&&t.constructor&&"[object Object]"===t.toString()&&t.constructor.prototype.hasOwnProperty("isPrototypeOf")},t}(),z=function(){function t(t){this.repository=t}return Object.defineProperty(t.prototype,"apiProxy",{get:function(){return this.repository.apiProxy},enumerable:!0,configurable:!0}),t.prototype.getList=function(t,e,n,r){var i=this,o=this.buildEntityFilter(t,e,n,r);return this.apiProxy.extendQuery(o).pipe(x((function(t){i.repository.setPaginationInfo(t.pagination);var e=t.result,n=i.repository.buildEntities(e);return i.determineIsAppend(r)?i.repository.entityCollection.addEntities(n):i.repository.entityCollection.loadEntities(n),n})))},t.prototype.determineIsAppend=function(t){return t>1},t.prototype.getById=function(t){var e=this;return this.apiProxy.extendRetrieve(t).pipe(x((function(t){var n=t,r=e.repository.buildEntity(n);return e.repository.entityCollection.loadEntities([r]),r})))},t.prototype.editById=function(t){var e=this;return this.repository.entityCollection.getEntityById(t)?this.apiProxy.edit(t).pipe(x((function(n){var r=n.data,i=e.repository.entityCollection.getEntityById(t);return i&&r&&e.reloadEntityData(i,r),i}))):I(null)},t.prototype.updateById=function(t){var e=this;return this.repository.entityCollection.getEntityById(t)?this.apiProxy.extendRetrieve(t).pipe(x((function(n){var r=n,i=e.repository.entityCollection.getEntityById(t);return e.reloadEntityData(i,r),i}))):C},t.prototype.reloadEntityData=function(t,e){t&&(t.load(e),t.changes.splice(0,t.changes.length))},t.prototype.create=function(t){var e=this;return this.apiProxy.create(t).pipe(x((function(t){var n=t,r=e.repository.buildEntity(n);return e.repository.entityCollection.loadEntities([r]),e.repository.dataChangeHistory.addChange({dataId:r.primaryValue,changeType:o.Add}),r})))},t.prototype.append=function(t){var e=this;return this.apiProxy.create(t).pipe(x((function(t){var n=t,r=e.repository.buildEntity(n);return e.repository.entityCollection.addEntity(r),r})))},t.prototype.appendByPath=function(t){var e=this;return this.apiProxy.createByPath(t).pipe(x((function(n){var r=n;return e.repository.entityManager.appendEntityByPath(t,r,r)})))},t.prototype.removeById=function(t,e){var n=this;return e=void 0===e||e,this.apiProxy.extendDelete(t).pipe(m((function(){return!0===e?n.applyChangesById(t).pipe(B((function(e){e&&n.repository.entityCollection.removeEntityById(t)}))):(n.repository.entityCollection.removeEntityById(t),n.repository.dataChangeHistory.addChange({dataId:t,changeType:o.Delete}),I(!0))})))},t.prototype.removeAndSaveById=function(t){var e=this;return this.apiProxy.deleteAndSave(t).pipe(m((function(){return e.repository.entityCollection.removeEntityById(t),I(!0)})))},t.prototype.removeByIds=function(t){var e=this;return this.apiProxy.extendBatchDelete(t).pipe(m((function(){return e.applyChangesByIdArray(t).pipe(B((function(n){n&&e.repository.entityCollection.removeEntities((function(n){return e.checkEntityValueExists(n,t)}))})))})))},t.prototype.checkEntityValueExists=function(t,e){for(var n=!1,r=0;r<e.length;r++)if(t.primaryValue===e[r]){n=!0;break}return n},t.prototype.removeByPath=function(t,e){var n=this;return this.apiProxy.extendDeletByPath(t,e).pipe(x((function(){return n.repository.entityManager.removeEntityByPath(t,e),n.repository.dataChangeHistory.addChange({fpath:t,dataId:e,changeType:o.Delete}),!0})))},t.prototype.updateChangesById=function(t){var e=this,n=this.repository.entityCollection.getEntityById(t);if(!n.changes||0===n.changes.length)return I(!0);var r=this.repository.entityManager.buildEntityChangeDetailById(t);return this.apiProxy.update(r).pipe(B((function(){e.repository.entityManager.clearEntityChangesById(t)})),x((function(){return!0})))},t.prototype.updateAllChanges=function(){var t=this,e=[],n=this.repository.entityCollection.toArray();return 0===n.length?I(!0):(n.forEach((function(n){var r=t.updateChangesById(n.primaryValue);e.push(r)})),E.apply(void 0,function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(w(arguments[e]));return t}(e)).pipe(x((function(){return!0}))))},t.prototype.applyChanges=function(){var t=this;return this.apiProxy.save().pipe(B((function(){t.repository.entityManager.clearAllEntityChanges(),t.repository.dataChangeHistory.clear()})),x((function(){return!0})))},t.prototype.applyChangesByIdArray=function(t){var e=this;return this.apiProxy.save().pipe(B((function(){e.repository.entityManager.clearEntityChangesByIds(t),e.repository.dataChangeHistory.clearByIds(t)})),x((function(){return!0})))},t.prototype.applyChangesById=function(t){var e=this;return this.apiProxy.save().pipe(B((function(){e.repository.entityManager.clearEntityChangesById(t),e.repository.dataChangeHistory.clearByIds([t])})),x((function(){return!0})))},t.prototype.cancelChanges=function(){var t=this;return this.apiProxy.cancel().pipe(B((function(){t.repository.entityManager.clearAllEntityChanges(),t.repository.dataChangeHistory.clear()})),x((function(){return!0})))},t.prototype.buildEntityFilter=function(t,e,n,r){return{FilterConditions:t,SortConditions:e,IsUsePagination:0!==n,Pagination:{PageIndex:r,PageSize:n,PageCount:0,TotalCount:0}}},t}(),Q=t("FrameworkSessionService",function(){function t(){}return t.prototype.getUserSessionId=function(){return window.localStorage.getItem("sessionId")},t.prototype.getFuncSessionId=function(){var t=window.frmMobileService;return t?t.rtf.commonVariable.formToken():null},t.prototype.getCurrentSessionId=function(){var t=window.sessionStorage.getItem("FuncSessionId"),e=this.getFuncSessionId();return e&&e!==t&&(t=null),t||(t=this.getFuncSessionId())&&window.sessionStorage.setItem("FuncSessionId",t),t},t}()),X=function(){function t(t){this.repository=t}return Object.defineProperty(t.prototype,"injector",{get:function(){return this.repository.getInjector()},enumerable:!0,configurable:!0}),t.prototype.onResponse=function(t){return this.handleResponseHeaders(t.headers),this.handleResponseBody(t.body)},t.prototype.handleResponseHeaders=function(t){this.repository.sessionService.handleResponseHeaders(t)},t.prototype.handleResponseBody=function(t){return t&&t.innerDataChange&&this.repository.entityManager.handleDataChangeDetails(t.innerDataChange),this.repository.entityManager.clearAllEntityChanges(),t&&t.hasOwnProperty("returnValue")?t.returnValue:t},t.prototype.onError=function(t){var e,n,r=window.DEVKIT_LOADING_SERVICE;if(r&&r instanceof Array&&r.length>0)try{for(var i=function(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}(r),o=i.next();!o.done;o=i.next()){var a=o.value;"function"==typeof a.hide&&a.hide()}}catch(t){e={error:t}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}var s=this.injector.get(R,null);return s?(s.show(t),C):C},t.prototype.extendHeaders=function(t){var e=this;return this.repository.sessionService.getBeSessionId().pipe(m((function(){return t=e.repository.sessionService.extendRequestHeaders(t),I(t)})))},t.prototype.extendBody=function(t){return A.appendRequestInfoToBody(t,this.repository)},t}(),Z=function(){function t(t){this.repository=t}return Object.defineProperty(t.prototype,"injector",{get:function(){return this.repository.getInjector()},enumerable:!0,configurable:!0}),t.prototype.init=function(){this.initAppContext(),this.initEntityManager(),this.initVariableManager(),this.initApiProxy(),this.initSessionService(),this.initDataService()},t.prototype.initAppContext=function(){this.repository.appContext=this.injector.get(a)},t.prototype.initEntityManager=function(){this.repository.entityManager=new Y(this.repository.entityCollection)},t.prototype.initVariableManager=function(){var t=s.getPropsMetadatasByName(this.repository.constructor,W);this.repository.variableManager=new $(t)},t.prototype.initApiProxy=function(){this.repository.apiProxy=this.injector.get(this.repository.apiProxyType);var t=new X(this.repository);this.repository.apiProxy.setProxyExtend(t)},t.prototype.initSessionService=function(){var t=this.injector.get(U,null,p.Optional);t=t||"SeparatedSession";var e=this.injector.get(Q),n=this.injector.get(u),r=""+this.repository.apiProxy.baseUrl,i=(new G).create(t,e,r,n);this.repository.sessionService=new J(i)},t.prototype.initDataService=function(){this.repository.dataService=new z(this.repository)},t}();t("BefRepository",function(t){function e(e){var n=t.call(this)||this;return n.injector=e,n}return D(e,t),e.prototype.init=function(){t.prototype.init.call(this),new Z(this).init()},e.prototype.getInjector=function(){return this.injector},e.prototype.getEntities=function(t,e,n,r){return this.dataService.getList(t,e,n,r)},e.prototype.getEntityById=function(t){return this.dataService.getById(t)},e.prototype.updateEntityById=function(t){return this.dataService.updateById(t)},e.prototype.editEntityById=function(t){return this.dataService.editById(t)},e.prototype.createEntity=function(t){return this.dataService.create(t)},e.prototype.appendEntity=function(t){return this.dataService.append(t)},e.prototype.appendEntityByPath=function(t){return this.dataService.appendByPath(t)},e.prototype.removeEntityById=function(t,e){return this.dataService.removeById(t,e)},e.prototype.removeEntitiesByIds=function(t){return this.dataService.removeByIds(t)},e.prototype.removeEntityAndSaveById=function(t){return this.dataService.removeAndSaveById(t)},e.prototype.removeEntityByPath=function(t,e){return this.dataService.removeByPath(t,e)},e.prototype.saveEntityById=function(t){return this.dataService.applyChangesById(t)},e.prototype.saveEntities=function(){return this.dataService.applyChanges()},e.prototype.cancelEntityChanges=function(){return this.dataService.cancelChanges()},e.prototype.reset=function(){this.entityManager.reset(),this.variableManager.reset(),this.sessionService.clearBeSessionId()},e}(y)),t("BefLookupDataService",function(){function t(t){this.viewModelContext=t,this.befRepository=this.viewModelContext.repository}return t.prototype.getData=function(t,e){var n=t.split(".")[0],r=t.split(".")[1];return e=e||{},this.extendGetHelpData(r,n,e)},t.prototype.extendGetHelpData=function(t,e,n){var i=this.befRepository.apiProxy.baseUrl+"/extension/elementhelps",o={body:{labelId:t,nodeCode:e,queryParam:n,requestInfo:A.buildRequestInfo(this.befRepository)}};return this.befRepository.apiProxy.request(r.PUT,i,o).pipe(x((function(t){return t})))},t}())}}}));
