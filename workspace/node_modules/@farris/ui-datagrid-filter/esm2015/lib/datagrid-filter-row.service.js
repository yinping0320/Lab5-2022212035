/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, EventEmitter } from '@angular/core';
import { Subject } from 'rxjs';
import { ColumnFilterType, DatagridUtils } from '@farris/ui-datagrid';
import { FilterOperator } from './operations/operators';
export class DatagridFilterRowService {
    constructor() {
        this.columnConditionSubject = new Subject();
        this.filterRowConditions$ = this.columnConditionSubject.asObservable();
        this.columnConditions = {};
        this.filterTextboxChanged = new EventEmitter();
        this.removeField = new EventEmitter();
    }
    /**
     * @param {?} frp
     * @return {?}
     */
    setFilterPanel(frp) {
        this.currentFilterPanel = frp;
    }
    /**
     * @return {?}
     */
    hasFilterPanel() {
        return !!this.currentFilterPanel;
    }
    /**
     * @return {?}
     */
    closeFilterPanel() {
        if (this.hasFilterPanel()) {
            if (this.currentFilterPanel.instance.documentClickHandle) {
                this.currentFilterPanel.instance.documentClickHandle();
            }
            document.body.removeChild(this.currentFilterPanel.location.nativeElement);
            this.currentFilterPanel.destroy();
            this.currentFilterPanel = null;
            // document.body.style.overflow = 'auto';
        }
    }
    /**
     * @param {?=} emitEvent
     * @return {?}
     */
    clear(emitEvent = true) {
        this.columnConditions = {};
        if (emitEvent) {
            this.columnConditionSubject.next({});
        }
    }
    /**
     * @param {?} field
     * @param {?=} opts
     * @return {?}
     */
    removeFilterField(field, opts) {
        if (this.columnConditions) {
            delete this.columnConditions[field];
            this.removeField.emit(field);
            if (!opts || (opts && opts.emitEvent)) {
                this.emitColumnConditionChanged(this.columnConditions, field);
            }
        }
    }
    /**
     * @param {?} field
     * @param {?} colCondition
     * @return {?}
     */
    _updateColumnConditions(field, colCondition) {
        /** @type {?} */
        const currentCondition = this.columnConditions[field];
        if (!currentCondition) {
            this.columnConditions = Object.assign(this.columnConditions, { [field]: colCondition });
        }
        else {
            if (JSON.stringify(currentCondition) !== JSON.stringify(colCondition)) {
                this.columnConditions = Object.assign(this.columnConditions, { [field]: colCondition });
            }
        }
        // 值为 ‘’ ，则代表着不参与查询
        Object.keys(this.columnConditions).forEach((/**
         * @param {?} k
         * @return {?}
         */
        k => {
            if (!this.columnConditions[k]) {
                // delete this.columnConditions[k];
                this.columnConditions[k] = null;
            }
        }));
    }
    /**
     * @param {?} field
     * @param {?} colCondition
     * @return {?}
     */
    updateColumnConditions(field, colCondition) {
        this._updateColumnConditions(field, colCondition);
        this.emitColumnConditionChanged(this.columnConditions);
    }
    /**
     * @private
     * @param {?} conditions
     * @param {?=} removedFields
     * @return {?}
     */
    emitColumnConditionChanged(conditions, removedFields) {
        // const farr = this.gridInstance.remoteFilter ? this.convert2FilterArray(this.columnConditions) : this.columnConditions;
        this.columnConditionSubject.next({ conditions, removedFields });
    }
    // 获取过滤行显示文本
    /**
     * @param {?} column
     * @param {?} condition
     * @return {?}
     */
    condition2string(column, condition) {
        if (!condition || typeof condition === 'string') {
            return '';
        }
        /** @type {?} */
        const andText = this.gridInstance.localeService.getValue('datagrid.filter.and');
        /** @type {?} */
        const orText = this.gridInstance.localeService.getValue('datagrid.filter.or');
        /** @type {?} */
        const getRelationLabel = (/**
         * @param {?} r
         * @return {?}
         */
        (r) => {
            if (r === 'and') {
                return andText;
            }
            else if (r === 'or') {
                return orText;
            }
            else {
                return '';
            }
        });
        /** @type {?} */
        let filterPreViewString = '';
        if (column.filter.type === ColumnFilterType.fromdata) {
            filterPreViewString = `(${condition.value1.length})`;
            if (condition.value1) {
                filterPreViewString += ` ${condition.value1.join(',')}`;
            }
        }
        else if (column.filter.type === ColumnFilterType.enum) {
            /** @type {?} */
            const enumOpts = (/** @type {?} */ (this.getEnumOptions(column)));
            const { valueField, textField, data } = enumOpts;
            filterPreViewString = `(${condition.value1.length})`;
            if (condition.value1) {
                filterPreViewString += ` ${condition.value1.map((/**
                 * @param {?} v
                 * @return {?}
                 */
                v => {
                    /** @type {?} */
                    const enumItem = data.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    d => d[valueField] == v));
                    return enumItem[textField];
                })).join(',')}`;
            }
        }
        else {
            if (condition) {
                /** @type {?} */
                const operator1Label = this.getOperatorLabel(condition.operator1);
                if (!this.isEmpty(condition.value1)) {
                    filterPreViewString = `${operator1Label} ${condition.value1}`;
                    /** @type {?} */
                    const operator2Label = this.getOperatorLabel(condition.operator2);
                    if (!this.isEmpty(condition.value2)) {
                        filterPreViewString += ` ${getRelationLabel(condition.relation)} ${operator2Label} ${condition.value2}`;
                    }
                    else {
                        if (condition.operator2 !== undefined) {
                            /** @type {?} */
                            const op2 = parseInt('' + condition.operator2, 10);
                            if (op2 === FilterOperator.Empty || op2 === FilterOperator.NotEmpty) {
                                filterPreViewString += ` ${getRelationLabel(condition.relation)} ${operator2Label}`;
                            }
                        }
                    }
                }
                else {
                    /** @type {?} */
                    const op1 = parseInt('' + condition.operator1, 10);
                    if (op1 === FilterOperator.Empty || op1 === FilterOperator.NotEmpty) {
                        filterPreViewString = `${operator1Label}`;
                    }
                }
            }
        }
        return filterPreViewString;
    }
    /**
     * @private
     * @param {?} v
     * @return {?}
     */
    isEmpty(v) {
        return v === '' || v === undefined || v === null;
    }
    /**
     * @param {?} column
     * @return {?}
     */
    getEnumOptions(column) {
        /** @type {?} */
        const colFilter = (/** @type {?} */ (column.filter));
        /** @type {?} */
        const datatype = colFilter.type;
        /** @type {?} */
        let enumSetting = null;
        if (datatype === ColumnFilterType.enum) {
            /** @type {?} */
            const fmt = (/** @type {?} */ (column.formatter));
            if (fmt) {
                enumSetting = fmt.options;
            }
            else {
                if (colFilter.options) {
                    enumSetting = colFilter.options;
                }
            }
        }
        else { // enum 数据源来自grid 数据列表
            // enum 数据源来自grid 数据列表
            /** @type {?} */
            const columnData = this.gridInstance.dfs.getData(true).map((/**
             * @param {?} n
             * @return {?}
             */
            n => {
                return DatagridUtils.getValue(column.field, n);
            }));
            // 去除重复
            /** @type {?} */
            const enumData = Array.from(new Set(columnData)).map((/**
             * @param {?} n
             * @return {?}
             */
            n => {
                return {
                    value: n, label: n
                };
            }));
            enumSetting = {
                valueField: 'value', textField: 'label', data: enumData, idField: 'value'
            };
        }
        return enumSetting;
    }
    // 获取操作符标签
    /**
     * @param {?} code
     * @return {?}
     */
    getOperatorLabel(code) {
        /** @type {?} */
        const strOper = FilterOperator[code];
        if (strOper) {
            /** @type {?} */
            const operName = strOper[0].toLowerCase() + strOper.substr(1);
            /** @type {?} */
            const key = `datagrid.filter.operators.${operName}`;
            return this.gridInstance.localeService.getValue(key);
        }
        return '';
    }
}
DatagridFilterRowService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
DatagridFilterRowService.ctorParameters = () => [];
if (false) {
    /**
     * @type {?}
     * @private
     */
    DatagridFilterRowService.prototype.columnConditionSubject;
    /** @type {?} */
    DatagridFilterRowService.prototype.filterRowConditions$;
    /** @type {?} */
    DatagridFilterRowService.prototype.columnConditions;
    /** @type {?} */
    DatagridFilterRowService.prototype.currentFilterPanel;
    /** @type {?} */
    DatagridFilterRowService.prototype.gridInstance;
    /** @type {?} */
    DatagridFilterRowService.prototype.filterTextboxChanged;
    /** @type {?} */
    DatagridFilterRowService.prototype.removeField;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtZmlsdGVyLXJvdy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC1maWx0ZXIvIiwic291cmNlcyI6WyJsaWIvZGF0YWdyaWQtZmlsdGVyLXJvdy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFnQixZQUFZLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUvQixPQUFPLEVBQUMsZ0JBQWdCLEVBQWMsYUFBYSxFQUFtQyxNQUFNLHFCQUFxQixDQUFDO0FBRWxILE9BQU8sRUFDZ0IsY0FBYyxFQUFjLE1BQU0sd0JBQXdCLENBQUM7QUFJbEYsTUFBTSxPQUFPLHdCQUF3QjtJQVdqQztRQVZRLDJCQUFzQixHQUFHLElBQUksT0FBTyxFQUFzQixDQUFDO1FBQ25FLHlCQUFvQixHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNsRSxxQkFBZ0IsR0FBMEIsRUFBRSxDQUFDO1FBSzdDLHlCQUFvQixHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDMUMsZ0JBQVcsR0FBRyxJQUFJLFlBQVksRUFBVSxDQUFDO0lBRXpCLENBQUM7Ozs7O0lBRWpCLGNBQWMsQ0FBQyxHQUEwQztRQUNyRCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsR0FBRyxDQUFDO0lBQ2xDLENBQUM7Ozs7SUFFRCxjQUFjO1FBQ1YsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDO0lBQ3JDLENBQUM7Ozs7SUFFRCxnQkFBZ0I7UUFDWixJQUFJLElBQUksQ0FBQyxjQUFjLEVBQUUsRUFBRTtZQUN2QixJQUFJLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsbUJBQW1CLEVBQUU7Z0JBQ3RELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsbUJBQW1CLEVB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YSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ25ELENBQUMsRUFBQzs7O2tCQUVJLFFBQVEsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRzs7OztZQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUNyRCxPQUFPO29CQUNILEtBQUssRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUM7aUJBQ3JCLENBQUM7WUFDTixDQUFDLEVBQUM7WUFDRixXQUFXLEdBQUc7Z0JBQ1YsVUFBVSxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLE9BQU87YUFDNUUsQ0FBQztTQUNMO1FBRUQsT0FBTyxXQUFXLENBQUM7SUFFdkIsQ0FBQzs7Ozs7O0lBR0QsZ0JBQWdCLENBQUMsSUFBUzs7Y0FDaEIsT0FBTyxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUM7UUFDcEMsSUFBSSxPQUFPLEVBQUU7O2tCQUNILFFBQVEsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7O2tCQUN2RCxHQUFHLEdBQUcsNkJBQTZCLFFBQVEsRUFBRTtZQUNuRCxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN4RDtRQUNELE9BQU8sRUFBRSxDQUFDO0lBQ2QsQ0FBQzs7O1lBNUxKLFVBQVU7Ozs7Ozs7OztJQUVQLDBEQUFtRTs7SUFDbkUsd0RBQWtFOztJQUNsRSxvREFBNkM7O0lBQzdDLHNEQUEwRDs7SUFFMUQsZ0RBQWdDOztJQUVoQyx3REFBMEM7O0lBQzFDLCtDQUF5QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIENvbXBvbmVudFJlZiwgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuXHJcbmltcG9ydCB7Q29sdW1uRmlsdGVyVHlwZSwgRGF0YUNvbHVtbiwgRGF0YWdyaWRVdGlscywgRGF0YWdyaWRDb21wb25lbnQsIENvbHVtbkZpbHRlciB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YWdyaWQnO1xyXG5cclxuaW1wb3J0IHsgQ29sdW1uRmlsdGVyQ29uZGl0aW9uLCBGaWx0ZXJDb25kaXRpb24sIEZpbHRlckNvbmRpdGlvblZhbHVlLCBBbGxGaWx0ZXJPcGVyYXRvcixcclxuICAgIEZpbHRlckVudW1TZXR0aW5nLCBGaWx0ZXJPcGVyYXRvciwgRmlsdGVyRGF0YSB9IGZyb20gJy4vb3BlcmF0aW9ucy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBGaWx0ZXJSb3dQYW5lbENvbXBvbmVudCB9IGZyb20gJy4vZmlsdGVyLWVkaXRvcnMvZmlsdGVyLXJvdy1wYW5lbC5jb21wb25lbnQnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRGF0YWdyaWRGaWx0ZXJSb3dTZXJ2aWNlIHtcclxuICAgIHByaXZhdGUgY29sdW1uQ29uZGl0aW9uU3ViamVjdCA9IG5ldyBTdWJqZWN0PEZpbHRlckRhdGFbXSB8IGFueT4oKTtcclxuICAgIGZpbHRlclJvd0NvbmRpdGlvbnMkID0gdGhpcy5jb2x1bW5Db25kaXRpb25TdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xyXG4gICAgY29sdW1uQ29uZGl0aW9uczogQ29sdW1uRmlsdGVyQ29uZGl0aW9uID0ge307XHJcbiAgICBjdXJyZW50RmlsdGVyUGFuZWw6IENvbXBvbmVudFJlZjxGaWx0ZXJSb3dQYW5lbENvbXBvbmVudD47XHJcblxyXG4gICAgZ3JpZEluc3RhbmNlOiBEYXRhZ3JpZENvbXBvbmVudDtcclxuXHJcbiAgICBmaWx0ZXJUZXh0Ym94Q2hhbmdlZCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcclxuICAgIHJlbW92ZUZpZWxkID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7IH1cclxuXHJcbiAgICBzZXRGaWx0ZXJQYW5lbChmcnA6IENvbXBvbmVudFJlZjxGaWx0ZXJSb3dQYW5lbENvbXBvbmVudD4pIHtcclxuICAgICAgICB0aGlzLmN1cnJlbnRGaWx0ZXJQYW5lbCA9IGZycDtcclxuICAgIH1cclxuXHJcbiAgICBoYXNGaWx0ZXJQYW5lbCgpIHtcclxuICAgICAgICByZXR1cm4gISF0aGlzLmN1cnJlbnRGaWx0ZXJQYW5lbDtcclxuICAgIH1cclxuXHJcbiAgICBjbG9zZUZpbHRlclBhbmVsKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmhhc0ZpbHRlclBhbmVsKCkpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEZpbHRlclBhbmVsLmluc3RhbmNlLmRvY3VtZW50Q2xpY2tIYW5kbGUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEZpbHRlclBhbmVsLmluc3RhbmNlLmRvY3VtZW50Q2xpY2tIYW5kbGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuY3VycmVudEZpbHRlclBhbmVsLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRGaWx0ZXJQYW5lbC5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudEZpbHRlclBhbmVsID0gbnVsbDtcclxuXHJcbiAgICAgICAgICAgIC8vIGRvY3VtZW50LmJvZHkuc3R5bGUub3ZlcmZsb3cgPSAnYXV0byc7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNsZWFyKGVtaXRFdmVudCA9IHRydWUpIHtcclxuICAgICAgICB0aGlzLmNvbHVtbkNvbmRpdGlvbnMgPSB7fTtcclxuICAgICAgICBpZiAoZW1pdEV2ZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29sdW1uQ29uZGl0aW9uU3ViamVjdC5uZXh0KHt9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlRmlsdGVyRmllbGQoZmllbGQ6IHN0cmluZywgb3B0cz86IHtlbWl0RXZlbnQ6IGJvb2xlYW59KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuY29sdW1uQ29uZGl0aW9ucykge1xyXG4gICAgICAgICAgICBkZWxldGUgdGhpcy5jb2x1bW5Db25kaXRpb25zW2ZpZWxkXTtcclxuICAgICAgICAgICAgdGhpcy5yZW1vdmVGaWVsZC5lbWl0KGZpZWxkKTtcclxuICAgICAgICAgICAgaWYgKCFvcHRzIHx8IChvcHRzICYmIG9wdHMuZW1pdEV2ZW50KSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0Q29sdW1uQ29uZGl0aW9uQ2hhbmdlZCh0aGlzLmNvbHVtbkNvbmRpdGlvbnMsIGZpZWxkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBfdXBkYXRlQ29sdW1uQ29uZGl0aW9ucyhmaWVsZDogc3RyaW5nLCBjb2xDb25kaXRpb246IEZpbHRlckNvbmRpdGlvbiB8IEZpbHRlckNvbmRpdGlvblZhbHVlICkge1xyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRDb25kaXRpb24gPSB0aGlzLmNvbHVtbkNvbmRpdGlvbnNbZmllbGRdO1xyXG4gICAgICAgIGlmICghY3VycmVudENvbmRpdGlvbikge1xyXG4gICAgICAgICAgICB0aGlzLmNvbHVtbkNvbmRpdGlvbnMgPSBPYmplY3QuYXNzaWduKHRoaXMuY29sdW1uQ29uZGl0aW9ucywge1tmaWVsZF06IGNvbENvbmRpdGlvbn0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChKU09OLnN0cmluZ2lmeShjdXJyZW50Q29uZGl0aW9uKSAhPT0gSlNPTi5zdHJpbmdpZnkoY29sQ29uZGl0aW9uKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb2x1bW5Db25kaXRpb25zID0gT2JqZWN0LmFzc2lnbih0aGlzLmNvbHVtbkNvbmRpdGlvbnMsIHtbZmllbGRdOiBjb2xDb25kaXRpb259KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDlgLzkuLog4oCY4oCZIO+8jOWImeS7o+ihqOedgOS4jeWPguS4juafpeivolxyXG4gICAgICAgIE9iamVjdC5rZXlzKHRoaXMuY29sdW1uQ29uZGl0aW9ucykuZm9yRWFjaChrID0+IHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmNvbHVtbkNvbmRpdGlvbnNba10pIHtcclxuICAgICAgICAgICAgICAgIC8vIGRlbGV0ZSB0aGlzLmNvbHVtbkNvbmRpdGlvbnNba107XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbHVtbkNvbmRpdGlvbnNba10gPSBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlQ29sdW1uQ29uZGl0aW9ucyhmaWVsZDogc3RyaW5nLCBjb2xDb25kaXRpb246IEZpbHRlckNvbmRpdGlvbiB8IEZpbHRlckNvbmRpdGlvblZhbHVlICkge1xyXG4gICAgICAgIHRoaXMuX3VwZGF0ZUNvbHVtbkNvbmRpdGlvbnMoZmllbGQsIGNvbENvbmRpdGlvbik7XHJcbiAgICAgICAgdGhpcy5lbWl0Q29sdW1uQ29uZGl0aW9uQ2hhbmdlZCh0aGlzLmNvbHVtbkNvbmRpdGlvbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZW1pdENvbHVtbkNvbmRpdGlvbkNoYW5nZWQoY29uZGl0aW9ucywgcmVtb3ZlZEZpZWxkcz86IHN0cmluZykge1xyXG4gICAgICAgIC8vIGNvbnN0IGZhcnIgPSB0aGlzLmdyaWRJbnN0YW5jZS5yZW1vdGVGaWx0ZXIgPyB0aGlzLmNvbnZlcnQyRmlsdGVyQXJyYXkodGhpcy5jb2x1bW5Db25kaXRpb25zKSA6IHRoaXMuY29sdW1uQ29uZGl0aW9ucztcclxuICAgICAgICB0aGlzLmNvbHVtbkNvbmRpdGlvblN1YmplY3QubmV4dCh7Y29uZGl0aW9ucywgcmVtb3ZlZEZpZWxkc30pO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOiOt+WPlui/h+a7pOihjOaYvuekuuaWh+acrFxyXG4gICAgY29uZGl0aW9uMnN0cmluZyhjb2x1bW46IERhdGFDb2x1bW4sIGNvbmRpdGlvbjogRmlsdGVyQ29uZGl0aW9uKSB7XHJcbiAgICAgICAgaWYgKCFjb25kaXRpb24gfHwgdHlwZW9mIGNvbmRpdGlvbiA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgYW5kVGV4dCA9IHRoaXMuZ3JpZEluc3RhbmNlLmxvY2FsZVNlcnZpY2UuZ2V0VmFsdWUoJ2RhdGFncmlkLmZpbHRlci5hbmQnKTtcclxuICAgICAgICBjb25zdCBvclRleHQgPSB0aGlzLmdyaWRJbnN0YW5jZS5sb2NhbGVTZXJ2aWNlLmdldFZhbHVlKCdkYXRhZ3JpZC5maWx0ZXIub3InKTtcclxuXHJcbiAgICAgICAgY29uc3QgZ2V0UmVsYXRpb25MYWJlbCA9IChyKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChyID09PSAnYW5kJykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFuZFRleHQ7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAociA9PT0gJ29yJykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9yVGV4dDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAgJyc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBsZXQgZmlsdGVyUHJlVmlld1N0cmluZyA9ICcnO1xyXG4gICAgICAgIGlmIChjb2x1bW4uZmlsdGVyLnR5cGUgPT09IENvbHVtbkZpbHRlclR5cGUuZnJvbWRhdGEpIHtcclxuICAgICAgICAgICAgZmlsdGVyUHJlVmlld1N0cmluZyA9IGAoJHtjb25kaXRpb24udmFsdWUxLmxlbmd0aH0pYDtcclxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi52YWx1ZTEpIHtcclxuICAgICAgICAgICAgICAgIGZpbHRlclByZVZpZXdTdHJpbmcgKz0gYCAke2NvbmRpdGlvbi52YWx1ZTEuam9pbignLCcpfWA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbi5maWx0ZXIudHlwZSA9PT0gQ29sdW1uRmlsdGVyVHlwZS5lbnVtKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGVudW1PcHRzID0gdGhpcy5nZXRFbnVtT3B0aW9ucyhjb2x1bW4pIGFzIEZpbHRlckVudW1TZXR0aW5nO1xyXG4gICAgICAgICAgICBjb25zdCB7IHZhbHVlRmllbGQsIHRleHRGaWVsZCwgZGF0YSB9ID0gZW51bU9wdHM7XHJcbiAgICAgICAgICAgIGZpbHRlclByZVZpZXdTdHJpbmcgPSBgKCR7Y29uZGl0aW9uLnZhbHVlMS5sZW5ndGh9KWA7XHJcbiAgICAgICAgICAgIGlmIChjb25kaXRpb24udmFsdWUxKSB7XHJcbiAgICAgICAgICAgICAgICBmaWx0ZXJQcmVWaWV3U3RyaW5nICs9IGAgJHtjb25kaXRpb24udmFsdWUxLm1hcCh2ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBlbnVtSXRlbSA9IGRhdGEuZmluZChkID0+IGRbdmFsdWVGaWVsZF0gPT0gdik7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVudW1JdGVtW3RleHRGaWVsZF07XHJcbiAgICAgICAgICAgICAgICB9KS5qb2luKCcsJyl9YDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChjb25kaXRpb24pIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG9wZXJhdG9yMUxhYmVsID0gdGhpcy5nZXRPcGVyYXRvckxhYmVsKGNvbmRpdGlvbi5vcGVyYXRvcjEpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCAhdGhpcy5pc0VtcHR5KGNvbmRpdGlvbi52YWx1ZTEpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyUHJlVmlld1N0cmluZyA9IGAke29wZXJhdG9yMUxhYmVsfSAke2NvbmRpdGlvbi52YWx1ZTF9YDtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBvcGVyYXRvcjJMYWJlbCA9IHRoaXMuZ2V0T3BlcmF0b3JMYWJlbChjb25kaXRpb24ub3BlcmF0b3IyKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNFbXB0eShjb25kaXRpb24udmFsdWUyKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJQcmVWaWV3U3RyaW5nICs9IGAgJHtnZXRSZWxhdGlvbkxhYmVsKGNvbmRpdGlvbi5yZWxhdGlvbil9ICR7b3BlcmF0b3IyTGFiZWx9ICR7Y29uZGl0aW9uLnZhbHVlMn1gO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb25kaXRpb24ub3BlcmF0b3IyICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9wMiA9IHBhcnNlSW50KCcnICsgY29uZGl0aW9uLm9wZXJhdG9yMiwgMTApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wMiA9PT0gRmlsdGVyT3BlcmF0b3IuRW1wdHkgfHwgb3AyID09PSBGaWx0ZXJPcGVyYXRvci5Ob3RFbXB0eSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlclByZVZpZXdTdHJpbmcgKz0gYCAke2dldFJlbGF0aW9uTGFiZWwoY29uZGl0aW9uLnJlbGF0aW9uKX0gJHtvcGVyYXRvcjJMYWJlbH1gO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBvcDEgPSBwYXJzZUludCgnJyArIGNvbmRpdGlvbi5vcGVyYXRvcjEsIDEwKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAob3AxID09PSBGaWx0ZXJPcGVyYXRvci5FbXB0eSB8fCBvcDEgPT09IEZpbHRlck9wZXJhdG9yLk5vdEVtcHR5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlclByZVZpZXdTdHJpbmcgPSBgJHtvcGVyYXRvcjFMYWJlbH1gO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmlsdGVyUHJlVmlld1N0cmluZztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGlzRW1wdHkodikge1xyXG4gICAgICAgIHJldHVybiB2ID09PSAnJyB8fCB2ID09PSB1bmRlZmluZWQgfHwgdiA9PT0gbnVsbDtcclxuICAgIH1cclxuXHJcblxyXG4gICAgZ2V0RW51bU9wdGlvbnMoY29sdW1uOiBEYXRhQ29sdW1uKSB7XHJcbiAgICAgICAgY29uc3QgY29sRmlsdGVyID0gY29sdW1uLmZpbHRlciBhcyBDb2x1bW5GaWx0ZXI7XHJcbiAgICAgICAgY29uc3QgZGF0YXR5cGUgPSBjb2xGaWx0ZXIudHlwZTtcclxuICAgICAgICBsZXQgZW51bVNldHRpbmcgPSBudWxsO1xyXG4gICAgICAgIGlmIChkYXRhdHlwZSA9PT0gQ29sdW1uRmlsdGVyVHlwZS5lbnVtKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZtdCA9IGNvbHVtbi5mb3JtYXR0ZXIgYXMgYW55O1xyXG4gICAgICAgICAgICBpZiAoZm10KSB7XHJcbiAgICAgICAgICAgICAgICBlbnVtU2V0dGluZyA9IGZtdC5vcHRpb25zO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKGNvbEZpbHRlci5vcHRpb25zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZW51bVNldHRpbmcgPSBjb2xGaWx0ZXIub3B0aW9ucztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7IC8vIGVudW0g5pWw5o2u5rqQ5p2l6IeqZ3JpZCDmlbDmja7liJfooahcclxuICAgICAgICAgICAgY29uc3QgY29sdW1uRGF0YTogc3RyaW5nW10gPSB0aGlzLmdyaWRJbnN0YW5jZS5kZnMuZ2V0RGF0YSh0cnVlKS5tYXAobiA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gRGF0YWdyaWRVdGlscy5nZXRWYWx1ZShjb2x1bW4uZmllbGQsIG4pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgLy8g5Y676Zmk6YeN5aSNXHJcbiAgICAgICAgICAgIGNvbnN0IGVudW1EYXRhID0gQXJyYXkuZnJvbShuZXcgU2V0KGNvbHVtbkRhdGEpKS5tYXAobiA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiBuLCBsYWJlbDogblxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGVudW1TZXR0aW5nID0ge1xyXG4gICAgICAgICAgICAgICAgdmFsdWVGaWVsZDogJ3ZhbHVlJywgdGV4dEZpZWxkOiAnbGFiZWwnLCBkYXRhOiBlbnVtRGF0YSwgaWRGaWVsZDogJ3ZhbHVlJ1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGVudW1TZXR0aW5nO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICAvLyDojrflj5bmk43kvZznrKbmoIfnrb5cclxuICAgIGdldE9wZXJhdG9yTGFiZWwoY29kZTogYW55KSB7XHJcbiAgICAgICAgY29uc3Qgc3RyT3BlciA9IEZpbHRlck9wZXJhdG9yW2NvZGVdO1xyXG4gICAgICAgIGlmIChzdHJPcGVyKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG9wZXJOYW1lID0gc3RyT3BlclswXS50b0xvd2VyQ2FzZSgpICsgc3RyT3Blci5zdWJzdHIoMSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGtleSA9IGBkYXRhZ3JpZC5maWx0ZXIub3BlcmF0b3JzLiR7b3Blck5hbWV9YDtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ3JpZEluc3RhbmNlLmxvY2FsZVNlcnZpY2UuZ2V0VmFsdWUoa2V5KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=