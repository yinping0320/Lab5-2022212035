/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { FormControl, FormBuilder } from '@angular/forms';
import { ColumnFilterType } from '@farris/ui-datagrid';
import { Component, Input, Output, EventEmitter, Injector, ChangeDetectorRef } from '@angular/core';
import { FilterOperator } from '../operations/operators';
export class ConditionEditorComponent {
    /**
     * @param {?} inject
     * @param {?} cd
     * @param {?} fb
     */
    constructor(inject, cd, fb) {
        this.inject = inject;
        this.cd = cd;
        this.fb = fb;
        this.datatype = ColumnFilterType.string;
        this.condition = {
            operator1: 0,
            value1: '',
            relation: '',
            operator2: 0,
            value2: ''
        };
        this.filterOptions = {};
        this.conditionChange = new EventEmitter();
        this.panelHeightChange = new EventEmitter();
        this.emptyCondition = Object.assign({}, this.condition);
        this.formValueChangesSubscription = null;
        this.originalCondition = {};
        this.form = this.fb.group({
            operator1: new FormControl(0),
            value1: new FormControl(''),
            relation: new FormControl(''),
            operator2: new FormControl(0),
            value2: new FormControl(''),
        });
        this.emptyConditonString = JSON.stringify(this.emptyCondition);
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.originalCondition = Object.assign({}, this.condition);
        this.form.patchValue(this.condition);
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        if (this.formValueChangesSubscription) {
            this.formValueChangesSubscription.unsubscribe();
            this.formValueChangesSubscription = null;
        }
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
    }
    /**
     * @private
     * @param {?} v
     * @return {?}
     */
    emitConditionChange(v) {
        this.condition = v;
        /** @type {?} */
        const filter = this.checkFilterOperator();
        this.conditionChange.emit(filter);
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.form.valueChanges.subscribe((/**
         * @param {?} v
         * @return {?}
         */
        (v) => {
            this.condition = Object.assign(this.emptyCondition, this.condition);
            if (v.operator1 > 1000) {
                this.emitConditionChange(v);
                return;
            }
            /** @type {?} */
            const currentFilterJSON = JSON.stringify(v);
            if (this.emptyConditonString === currentFilterJSON) {
                this.emitConditionChange(v);
            }
            else {
                // if (this.condition.value1 != v.value1 || (this.condition.value2 !== undefined && this.condition.value2 != v.value2)) {
                if (JSON.stringify(this.condition) !== currentFilterJSON) {
                    this.emitConditionChange(v);
                    if (v.value2 == '') {
                        this.emitPanelHeightChanged();
                    }
                }
                else {
                    if ((this.condition.operator1 != v.operator1) ||
                        (this.condition.relation != v.relation || this.condition.operator2 != v.operator2)) {
                        this.emitConditionChange(v);
                    }
                }
            }
        }));
    }
    /**
     * @private
     * @return {?}
     */
    checkFilterOperator() {
        /** @type {?} */
        const filter = Object.assign({}, this.condition);
        /** @type {?} */
        const op1 = parseInt('' + filter.operator1, 10);
        /** @type {?} */
        const f1 = { operator1: filter.operator1, value1: filter.value1 };
        if (op1 === FilterOperator.Empty || op1 === FilterOperator.NotEmpty) {
            filter.value1 = '';
            f1.value1 = '';
        }
        if ((filter.value1 === '' || filter.value1 === null) && op1 !== FilterOperator.Empty && op1 !== FilterOperator.NotEmpty) {
            return '';
        }
        if (!filter.relation) {
            return f1;
        }
        else {
            /** @type {?} */
            const op2 = parseInt('' + filter.operator2, 10);
            if (op2 === FilterOperator.Empty || op2 === FilterOperator.NotEmpty) {
                filter.value2 = '';
                return filter;
            }
            else {
                if (filter.value2 == null || filter.value2 == undefined || filter.value2 === '') {
                    return f1;
                }
            }
        }
        return filter;
    }
    /**
     * @param {?} relation
     * @param {?} $event
     * @return {?}
     */
    chooseRelation(relation, $event) {
        $event.stopPropagation();
        /** @type {?} */
        const emit = !this.form.get('relation').value;
        this.form.get('relation').setValue(relation);
        this.condition.relation = relation;
        if (this.condition.operator2 === undefined) {
            this.condition.operator2 = 0;
        }
        if (emit) {
            this.emitPanelHeightChanged();
        }
        this.cd.detectChanges();
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    resetFilters($event) {
        if (this.emptyConditonString !== JSON.stringify(this.condition)) {
            this.condition = JSON.parse(this.emptyConditonString);
            this.form.reset(this.condition);
            this.emitPanelHeightChanged();
        }
    }
    /**
     * @private
     * @return {?}
     */
    emitPanelHeightChanged() {
        if (this['panelHeightChangedTimer']) {
            clearTimeout(this['panelHeightChangedTimer']);
        }
        this['panelHeightChangedTimer'] = setTimeout((/**
         * @return {?}
         */
        () => {
            this.panelHeightChange.emit();
        }), 20);
    }
}
ConditionEditorComponent.decorators = [
    { type: Component, args: [{
                selector: 'condition-editor',
                template: "<form [formGroup]=\"form\">\r\n<ul class=\"list-group filter-condition\">\r\n    <li class=\"list-group-item border-0\">\r\n        <select class=\"form-control form-control-sm\" formControlName=\"operator1\" single-select [panelRef]=\"selectpanel\">\r\n            <!-- <option *ngFor=\"let o of operators\" [selected]=\"o.isDefault\" [value]=\"o.code\">{{ o.label }}</option> -->\r\n        </select>\r\n        <div #selectpanel class=\"single-select-panel f-area-hide\">\r\n            <ul class=\"dropdown-menu show\">\r\n                <li class=\"dropdown-item\" *ngFor=\"let col of operators\" [attr.value]=\"col.code\" [class.active]=\"condition.operator1 === col.code\">{{ col.label }}</li>\r\n            </ul>\r\n        </div>\r\n    </li>\r\n    <li class=\"list-group-item border-0\" [ngSwitch]=\"datatype\" *ngIf=\"condition.operator1 < 1000\">\r\n        <!-- <farris-time-picker #timepicker formControlName=\"value1\" [readonly]= \"false\" [editable]= \"true\"\r\n        [hourStep] = \"1\" [minuteStep] = \"1\"  *ngSwitchCase=\"'4'\" [format]=\"filterOptions?.format\" [secondStep] = \"1\"></farris-time-picker> -->\r\n\r\n        <farris-datepicker formControlName=\"value1\" [dateFormat]=\"filterOptions?.dateFormat\" [returnFormat]=\"filterOptions?.returnFormat\" [useDefault]=\"false\" [showTime]=\"false\" *ngSwitchCase=\"'3'\" ></farris-datepicker>\r\n        <farris-datepicker formControlName=\"value1\" [dateFormat]=\"filterOptions?.dateFormat\" [returnFormat]=\"filterOptions?.returnFormat\" [useDefault]=\"false\" [showTime]=\"true\" *ngSwitchCase=\"'5'\" ></farris-datepicker>\r\n        <!-- <farris-number-spinner  name=\"value1\" [(ngModel)]=\"condition.value1\" *ngSwitchCase=\"'1'\"></farris-number-spinner> -->\r\n        <div class=\"f-datagrid-cell-formgroup farris-group-auto flex-fill\"  *ngSwitchCase=\"'1'\">\r\n            <input formControlName=\"value1\" class=\"form-control no-number-button\" type=\"number\" >\r\n        </div>\r\n        <div class=\"f-datagrid-cell-formgroup farris-group-auto flex-fill\"  *ngSwitchCase=\"'4'\">\r\n            <input formControlName=\"value1\" class=\"form-control\" type=\"time\" >\r\n        </div>\r\n\r\n        <input class=\"form-control form-control-sm\" formControlName=\"value1\" *ngSwitchDefault type=\"text\" >\r\n    </li>\r\n\r\n    <ng-container *ngIf=\"condition.value1 !== '' && condition.value1 !== null && condition.value1 !== undefined\">\r\n        \r\n        <li class=\"list-group-item border-0\">\r\n            <div class=\"custom-control custom-radio custom-control-inline\" style=\"margin-right: 0;\">\r\n                <input type=\"radio\" id=\"customRadioInline1\" formControlName=\"relation\" value=\"and\" class=\"custom-control-input\">\r\n                <label class=\"custom-control-label\" for=\"customRadioInline1\" (click)=\"chooseRelation('and', $event)\">{{ 'datagrid.filter.and' | locale }}</label>\r\n            </div>\r\n            <div class=\"custom-control custom-radio custom-control-inline\">\r\n                <input type=\"radio\" id=\"customRadioInline2\" formControlName=\"relation\" value=\"or\" class=\"custom-control-input\">\r\n                <label class=\"custom-control-label\" for=\"customRadioInline2\"  (click)=\"chooseRelation('or', $event)\">{{ 'datagrid.filter.or' | locale }}</label>\r\n            </div>\r\n        </li>\r\n        <ng-container *ngIf=\"condition.relation\">\r\n            \r\n            <li class=\"list-group-item border-0\">\r\n                <!-- <select class=\"form-control form-control-sm\" formControlName=\"operator2\" >\r\n                    <option *ngFor=\"let o of operators\" [selected]=\"o.isDefault\" [value]=\"o.code\">{{ o.label }}</option>\r\n                </select> -->\r\n\r\n                <select class=\"form-control form-control-sm\" formControlName=\"operator2\" single-select [panelRef]=\"selectpanel2\">\r\n                </select>\r\n                <div #selectpanel2 class=\"single-select-panel f-area-hide\">\r\n                    <ul class=\"dropdown-menu show\">\r\n                        <li class=\"dropdown-item\" *ngFor=\"let col of operators\" [attr.value]=\"col.code\" [class.active]=\"condition.operator2 === col.code\">{{ col.label }}</li>\r\n                    </ul>\r\n                </div>\r\n\r\n\r\n\r\n            </li>\r\n            <li class=\"list-group-item border-0\" [ngSwitch]=\"datatype\" *ngIf=\"condition.operator2 < 1000\">\r\n                <!-- <farris-time-picker #timepicker formControlName=\"value2\" [readonly]= \"false\" [editable]= \"false\"\r\n                [hourStep] = \"1\" [minuteStep] = \"1\"  *ngSwitchCase=\"'4'\" [format]=\"filterOptions?.format\"[secondStep] = \"1\"></farris-time-picker> -->\r\n                <farris-datepicker formControlName=\"value2\" [dateFormat]=\"filterOptions?.dateFormat\" [useDefault]=\"false\" [showTime]=\"false\" *ngSwitchCase=\"'3'\" ></farris-datepicker>\r\n                <farris-datepicker formControlName=\"value2\" [dateFormat]=\"filterOptions?.dateFormat\" [useDefault]=\"false\" [showTime]=\"true\"  *ngSwitchCase=\"'5'\" ></farris-datepicker>\r\n                <!-- <farris-number-spinner  name=\"value2\" [(ngModel)]=\"condition.value2\" *ngSwitchCase=\"'1'\"></farris-number-spinner> -->\r\n                <div class=\"f-datagrid-cell-formgroup farris-group-auto flex-fill\"  *ngSwitchCase=\"'1'\">\r\n                    <input formControlName=\"value2\" class=\"form-control no-number-button\" type=\"number\" >\r\n                </div>\r\n                <div class=\"f-datagrid-cell-formgroup farris-group-auto flex-fill\"  *ngSwitchCase=\"'4'\">\r\n                    <input formControlName=\"value2\" class=\"form-control\" type=\"time\" >\r\n                </div>\r\n                <input class=\"form-control form-control-sm\" formControlName=\"value2\" *ngSwitchDefault type=\"text\" >\r\n            </li>\r\n        </ng-container>\r\n    </ng-container>\r\n    \r\n    <li class=\"list-group-item border-0\">\r\n        <div class=\"d-flex\">\r\n            <!-- <div class=\"p-2 \"><button type=\"button\" class=\"btn btn-light\">\u9AD8\u7EA7</button></div> -->\r\n            <div class=\"ml-auto\">\r\n                <button type=\"button\" style=\"position: unset;\" (click)=\"resetFilters($event)\" class=\"btn btn-primary\">{{ 'datagrid.filter.clear' | locale }}</button>\r\n            </div>\r\n        </div>\r\n   </li>\r\n</ul>\r\n</form>",
                styles: [`
        .no-number-button{-moz-appearance: textfield;}
        .no-number-button::-webkit-outer-spin-button, .no-number-button::-webkit-inner-spin-button {
              -webkit-appearance: none!important;
        }`]
            }] }
];
/** @nocollapse */
ConditionEditorComponent.ctorParameters = () => [
    { type: Injector },
    { type: ChangeDetectorRef },
    { type: FormBuilder }
];
ConditionEditorComponent.propDecorators = {
    operators: [{ type: Input }],
    datatype: [{ type: Input }],
    condition: [{ type: Input }],
    filterOptions: [{ type: Input }],
    conditionChange: [{ type: Output }],
    panelHeightChange: [{ type: Output }]
};
if (false) {
    /** @type {?} */
    ConditionEditorComponent.prototype.operators;
    /** @type {?} */
    ConditionEditorComponent.prototype.datatype;
    /** @type {?} */
    ConditionEditorComponent.prototype.condition;
    /** @type {?} */
    ConditionEditorComponent.prototype.filterOptions;
    /** @type {?} */
    ConditionEditorComponent.prototype.conditionChange;
    /** @type {?} */
    ConditionEditorComponent.prototype.panelHeightChange;
    /** @type {?} */
    ConditionEditorComponent.prototype.emptyCondition;
    /** @type {?} */
    ConditionEditorComponent.prototype.formValueChangesSubscription;
    /** @type {?} */
    ConditionEditorComponent.prototype.originalCondition;
    /** @type {?} */
    ConditionEditorComponent.prototype.form;
    /**
     * @type {?}
     * @private
     */
    ConditionEditorComponent.prototype.emptyConditonString;
    /**
     * @type {?}
     * @private
     */
    ConditionEditorComponent.prototype.inject;
    /**
     * @type {?}
     * @private
     */
    ConditionEditorComponent.prototype.cd;
    /**
     * @type {?}
     * @private
     */
    ConditionEditorComponent.prototype.fb;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZGl0aW9uLWVkaXRvci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRhdGFncmlkLWZpbHRlci8iLCJzb3VyY2VzIjpbImxpYi9maWx0ZXItZWRpdG9ycy9jb25kaXRpb24tZWRpdG9yLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFVLFdBQVcsRUFBRSxXQUFXLEVBQWEsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3RSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUd2RCxPQUFPLEVBQUUsU0FBUyxFQUFVLEtBQUssRUFDN0IsTUFBTSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQWEsaUJBQWlCLEVBQWlCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZHLE9BQU8sRUFBdUMsY0FBYyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFjOUYsTUFBTSxPQUFPLHdCQUF3Qjs7Ozs7O0lBaUNqQyxZQUFvQixNQUFnQixFQUFVLEVBQXFCLEVBQVUsRUFBZTtRQUF4RSxXQUFNLEdBQU4sTUFBTSxDQUFVO1FBQVUsT0FBRSxHQUFGLEVBQUUsQ0FBbUI7UUFBVSxPQUFFLEdBQUYsRUFBRSxDQUFhO1FBL0JuRixhQUFRLEdBQXFCLGdCQUFnQixDQUFDLE1BQU0sQ0FBQztRQUVyRCxjQUFTLEdBQW9CO1lBQ2xDLFNBQVMsRUFBRSxDQUFDO1lBQ1osTUFBTSxFQUFFLEVBQUU7WUFDVixRQUFRLEVBQUUsRUFBRTtZQUNaLFNBQVMsRUFBRSxDQUFDO1lBQ1osTUFBTSxFQUFFLEVBQUU7U0FDYixDQUFDO1FBRU8sa0JBQWEsR0FBUSxFQUFFLENBQUM7UUFFdkIsb0JBQWUsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBRXJDLHNCQUFpQixHQUFJLElBQUksWUFBWSxFQUFFLENBQUM7UUFFbEQsbUJBQWMscUJBQVEsSUFBSSxDQUFDLFNBQVMsRUFBRTtRQUV0QyxpQ0FBNEIsR0FBaUIsSUFB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QUFJLENBQUMseUJBQXlCLENBQUMsQ0FBQyxDQUFDO1NBQ2pEO1FBQ0QsSUFBSSxDQUFDLHlCQUF5QixDQUFDLEdBQUcsVUFBVTs7O1FBQUMsR0FBRyxFQUFFO1lBQzlDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNsQyxDQUFDLEdBQUUsRUFBRSxDQUFDLENBQUM7SUFDWCxDQUFDOzs7WUFoS0osU0FBUyxTQUFDO2dCQUNQLFFBQVEsRUFBRSxrQkFBa0I7Z0JBQzVCLCsxTUFBZ0Q7eUJBRTVDOzs7O1VBSUU7YUFFVDs7OztZQWR5QixRQUFRO1lBQWEsaUJBQWlCO1lBTGxDLFdBQVc7Ozt3QkFxQnBDLEtBQUs7dUJBQ0wsS0FBSzt3QkFFTCxLQUFLOzRCQVFMLEtBQUs7OEJBRUwsTUFBTTtnQ0FFTixNQUFNOzs7O0lBZlAsNkNBQXdDOztJQUN4Qyw0Q0FBOEQ7O0lBRTlELDZDQU1FOztJQUVGLGlEQUFpQzs7SUFFakMsbURBQStDOztJQUUvQyxxREFBa0Q7O0lBRWxELGtEQUFzQzs7SUFFdEMsZ0VBQWtEOztJQUNsRCxxREFBd0M7O0lBRXhDLHdDQU1HOzs7OztJQUVILHVEQUFrRTs7Ozs7SUFFdEQsMENBQXdCOzs7OztJQUFFLHNDQUE2Qjs7Ozs7SUFBRSxzQ0FBdUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOZ0Zvcm0sIEZvcm1Db250cm9sLCBGb3JtQnVpbGRlciwgRm9ybUdyb3VwIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQgeyBDb2x1bW5GaWx0ZXJUeXBlIH0gZnJvbSAnQGZhcnJpcy91aS1kYXRhZ3JpZCc7XHJcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiwgb2YsIG1lcmdlIH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgSW5wdXQsIE9uQ2hhbmdlcywgU2ltcGxlQ2hhbmdlcywgVmlld0NoaWxkLFxyXG4gICAgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIEluamVjdG9yLCBPbkRlc3Ryb3ksIENoYW5nZURldGVjdG9yUmVmLCBBZnRlclZpZXdJbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEZpbHRlclJvd09wZXJhdG9yLCAgRmlsdGVyQ29uZGl0aW9uLCBGaWx0ZXJPcGVyYXRvciB9IGZyb20gJy4uL29wZXJhdGlvbnMvb3BlcmF0b3JzJztcclxuXHJcblxyXG5AQ29tcG9uZW50KHtcclxuICAgIHNlbGVjdG9yOiAnY29uZGl0aW9uLWVkaXRvcicsXHJcbiAgICB0ZW1wbGF0ZVVybDogJy4vY29uZGl0aW9uLWVkaXRvci5jb21wb25lbnQuaHRtbCcsXHJcbiAgICBzdHlsZXM6IFtcclxuICAgICAgICBgXHJcbiAgICAgICAgLm5vLW51bWJlci1idXR0b257LW1vei1hcHBlYXJhbmNlOiB0ZXh0ZmllbGQ7fVxyXG4gICAgICAgIC5uby1udW1iZXItYnV0dG9uOjotd2Via2l0LW91dGVyLXNwaW4tYnV0dG9uLCAubm8tbnVtYmVyLWJ1dHRvbjo6LXdlYmtpdC1pbm5lci1zcGluLWJ1dHRvbiB7XHJcbiAgICAgICAgICAgICAgLXdlYmtpdC1hcHBlYXJhbmNlOiBub25lIWltcG9ydGFudDtcclxuICAgICAgICB9YFxyXG4gICAgXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgQ29uZGl0aW9uRWRpdG9yQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSwgQWZ0ZXJWaWV3SW5pdCB7XHJcbiAgICBASW5wdXQoKSBvcGVyYXRvcnM6IEZpbHRlclJvd09wZXJhdG9yW107XHJcbiAgICBASW5wdXQoKSBkYXRhdHlwZTogQ29sdW1uRmlsdGVyVHlwZSA9IENvbHVtbkZpbHRlclR5cGUuc3RyaW5nO1xyXG5cclxuICAgIEBJbnB1dCgpIGNvbmRpdGlvbjogRmlsdGVyQ29uZGl0aW9uID0ge1xyXG4gICAgICAgIG9wZXJhdG9yMTogMCxcclxuICAgICAgICB2YWx1ZTE6ICcnLFxyXG4gICAgICAgIHJlbGF0aW9uOiAnJyxcclxuICAgICAgICBvcGVyYXRvcjI6IDAsXHJcbiAgICAgICAgdmFsdWUyOiAnJ1xyXG4gICAgfTtcclxuXHJcbiAgICBASW5wdXQoKSBmaWx0ZXJPcHRpb25zOiBhbnkgPSB7fTtcclxuXHJcbiAgICBAT3V0cHV0KCkgY29uZGl0aW9uQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcigpO1xyXG5cclxuICAgIEBPdXRwdXQoKSBwYW5lbEhlaWdodENoYW5nZSA9ICBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcblxyXG4gICAgZW1wdHlDb25kaXRpb24gPSAgey4uLnRoaXMuY29uZGl0aW9ufTtcclxuXHJcbiAgICBmb3JtVmFsdWVDaGFuZ2VzU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb24gPSBudWxsO1xyXG4gICAgb3JpZ2luYWxDb25kaXRpb246IEZpbHRlckNvbmRpdGlvbiA9IHt9O1xyXG5cclxuICAgIGZvcm06IEZvcm1Hcm91cCA9IHRoaXMuZmIuZ3JvdXAoe1xyXG4gICAgICAgIG9wZXJhdG9yMTogbmV3IEZvcm1Db250cm9sKDApLFxyXG4gICAgICAgIHZhbHVlMTogbmV3IEZvcm1Db250cm9sKCcnKSxcclxuICAgICAgICByZWxhdGlvbjogbmV3IEZvcm1Db250cm9sKCcnKSxcclxuICAgICAgICBvcGVyYXRvcjI6IG5ldyBGb3JtQ29udHJvbCgwKSxcclxuICAgICAgICB2YWx1ZTI6IG5ldyBGb3JtQ29udHJvbCgnJyksXHJcbiAgICB9KTtcclxuXHJcbiAgICBwcml2YXRlIGVtcHR5Q29uZGl0b25TdHJpbmcgPSBKU09OLnN0cmluZ2lmeSh0aGlzLmVtcHR5Q29uZGl0aW9uKTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdDogSW5qZWN0b3IsIHByaXZhdGUgY2Q6IENoYW5nZURldGVjdG9yUmVmLCBwcml2YXRlIGZiOiBGb3JtQnVpbGRlcikgeyB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5vcmlnaW5hbENvbmRpdGlvbiA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuY29uZGl0aW9uKTtcclxuICAgICAgICB0aGlzLmZvcm0ucGF0Y2hWYWx1ZSh0aGlzLmNvbmRpdGlvbik7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZm9ybVZhbHVlQ2hhbmdlc1N1YnNjcmlwdGlvbikge1xyXG4gICAgICAgICAgICB0aGlzLmZvcm1WYWx1ZUNoYW5nZXNTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgICAgICAgICAgdGhpcy5mb3JtVmFsdWVDaGFuZ2VzU3Vic2NyaXB0aW9uID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIGVtaXRDb25kaXRpb25DaGFuZ2UodjogYW55KSB7XHJcbiAgICAgICAgdGhpcy5jb25kaXRpb24gPSB2O1xyXG4gICAgICAgIGNvbnN0IGZpbHRlciA9IHRoaXMuY2hlY2tGaWx0ZXJPcGVyYXRvcigpO1xyXG4gICAgICAgIHRoaXMuY29uZGl0aW9uQ2hhbmdlLmVtaXQoZmlsdGVyKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ0FmdGVyVmlld0luaXQoKSB7XHJcbiAgICAgICAgdGhpcy5mb3JtLnZhbHVlQ2hhbmdlcy5zdWJzY3JpYmUoKHY6IEZpbHRlckNvbmRpdGlvbikgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmNvbmRpdGlvbiA9IE9iamVjdC5hc3NpZ24odGhpcy5lbXB0eUNvbmRpdGlvbiwgdGhpcy5jb25kaXRpb24pO1xyXG5cclxuICAgICAgICAgICAgaWYgKHYub3BlcmF0b3IxID4gMTAwMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0Q29uZGl0aW9uQ2hhbmdlKHYpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBjdXJyZW50RmlsdGVySlNPTiA9IEpTT04uc3RyaW5naWZ5KHYpO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5lbXB0eUNvbmRpdG9uU3RyaW5nID09PSBjdXJyZW50RmlsdGVySlNPTikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0Q29uZGl0aW9uQ2hhbmdlKHYpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8gaWYgKHRoaXMuY29uZGl0aW9uLnZhbHVlMSAhPSB2LnZhbHVlMSB8fCAodGhpcy5jb25kaXRpb24udmFsdWUyICE9PSB1bmRlZmluZWQgJiYgdGhpcy5jb25kaXRpb24udmFsdWUyICE9IHYudmFsdWUyKSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKEpTT04uc3RyaW5naWZ5KHRoaXMuY29uZGl0aW9uKSAhPT0gY3VycmVudEZpbHRlckpTT04pIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXRDb25kaXRpb25DaGFuZ2Uodik7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHYudmFsdWUyID09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdFBhbmVsSGVpZ2h0Q2hhbmdlZCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCh0aGlzLmNvbmRpdGlvbi5vcGVyYXRvcjEgIT0gdi5vcGVyYXRvcjEpIHx8IFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAodGhpcy5jb25kaXRpb24ucmVsYXRpb24gIT0gdi5yZWxhdGlvbiAgfHwgdGhpcy5jb25kaXRpb24ub3BlcmF0b3IyICE9IHYub3BlcmF0b3IyKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXRDb25kaXRpb25DaGFuZ2Uodik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjaGVja0ZpbHRlck9wZXJhdG9yKCkge1xyXG4gICAgICAgIGNvbnN0IGZpbHRlciA9IHsuLi50aGlzLmNvbmRpdGlvbn07XHJcbiAgICAgICAgY29uc3Qgb3AxID0gcGFyc2VJbnQoJycgKyBmaWx0ZXIub3BlcmF0b3IxLCAxMCk7XHJcbiAgICAgICAgY29uc3QgZjEgPSB7b3BlcmF0b3IxOiBmaWx0ZXIub3BlcmF0b3IxLCB2YWx1ZTE6IGZpbHRlci52YWx1ZTF9O1xyXG5cclxuICAgICAgICBpZiAob3AxID09PSBGaWx0ZXJPcGVyYXRvci5FbXB0eSB8fCBvcDEgPT09IEZpbHRlck9wZXJhdG9yLk5vdEVtcHR5KSB7XHJcbiAgICAgICAgICAgIGZpbHRlci52YWx1ZTEgPSAnJztcclxuICAgICAgICAgICAgZjEudmFsdWUxID0gJyc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoKGZpbHRlci52YWx1ZTEgPT09ICcnIHx8IGZpbHRlci52YWx1ZTEgPT09IG51bGwpICYmIG9wMSAhPT0gRmlsdGVyT3BlcmF0b3IuRW1wdHkgJiYgb3AxICE9PSBGaWx0ZXJPcGVyYXRvci5Ob3RFbXB0eSkge1xyXG4gICAgICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIWZpbHRlci5yZWxhdGlvbikge1xyXG4gICAgICAgICAgICByZXR1cm4gZjE7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3Qgb3AyID0gcGFyc2VJbnQoJycgKyBmaWx0ZXIub3BlcmF0b3IyLCAxMCk7XHJcbiAgICAgICAgICAgIGlmIChvcDIgPT09IEZpbHRlck9wZXJhdG9yLkVtcHR5IHx8IG9wMiA9PT0gRmlsdGVyT3BlcmF0b3IuTm90RW1wdHkpIHtcclxuICAgICAgICAgICAgICAgIGZpbHRlci52YWx1ZTIgPSAnJztcclxuICAgICAgICAgICAgICAgIHJldHVybiBmaWx0ZXI7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZmlsdGVyLnZhbHVlMiA9PSBudWxsIHx8IGZpbHRlci52YWx1ZTIgPT0gdW5kZWZpbmVkIHx8IGZpbHRlci52YWx1ZTIgPT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGYxO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZmlsdGVyO1xyXG4gICAgfVxyXG5cclxuICAgIGNob29zZVJlbGF0aW9uKHJlbGF0aW9uOiAnYW5kJyB8ICdvcicsICRldmVudDogTW91c2VFdmVudCkge1xyXG4gICAgICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICBjb25zdCBlbWl0ID0gIXRoaXMuZm9ybS5nZXQoJ3JlbGF0aW9uJykudmFsdWU7XHJcbiAgICAgICAgdGhpcy5mb3JtLmdldCgncmVsYXRpb24nKS5zZXRWYWx1ZShyZWxhdGlvbik7XHJcbiAgICAgICAgdGhpcy5jb25kaXRpb24ucmVsYXRpb24gPSByZWxhdGlvbjtcclxuICAgICAgICBpZiAodGhpcy5jb25kaXRpb24ub3BlcmF0b3IyID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5jb25kaXRpb24ub3BlcmF0b3IyID0gMDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChlbWl0KSB7XHJcbiAgICAgICAgICAgIHRoaXMuZW1pdFBhbmVsSGVpZ2h0Q2hhbmdlZCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICB0aGlzLmNkLmRldGVjdENoYW5nZXMoKTtcclxuICAgIH1cclxuXHJcbiAgICByZXNldEZpbHRlcnMoJGV2ZW50OiBNb3VzZUV2ZW50KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZW1wdHlDb25kaXRvblN0cmluZyAhPT0gSlNPTi5zdHJpbmdpZnkodGhpcy5jb25kaXRpb24pKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29uZGl0aW9uID0gSlNPTi5wYXJzZSh0aGlzLmVtcHR5Q29uZGl0b25TdHJpbmcpO1xyXG4gICAgICAgICAgICB0aGlzLmZvcm0ucmVzZXQodGhpcy5jb25kaXRpb24pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5lbWl0UGFuZWxIZWlnaHRDaGFuZ2VkKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZW1pdFBhbmVsSGVpZ2h0Q2hhbmdlZCgpIHtcclxuICAgICAgICBpZiAodGhpc1sncGFuZWxIZWlnaHRDaGFuZ2VkVGltZXInXSkge1xyXG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpc1sncGFuZWxIZWlnaHRDaGFuZ2VkVGltZXInXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXNbJ3BhbmVsSGVpZ2h0Q2hhbmdlZFRpbWVyJ10gPSBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5wYW5lbEhlaWdodENoYW5nZS5lbWl0KCk7XHJcbiAgICAgICAgfSwgMjApO1xyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=