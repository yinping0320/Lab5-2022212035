/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ComponentFactoryResolver, Directive, ElementRef, Injector, Input, Renderer2 } from "@angular/core";
import { NgControl } from "@angular/forms";
import { CommonUtils, OverLayHiddenService } from "@farris/ui-common";
import { LocaleService } from "@farris/ui-locale";
import { CommentsHttpToken } from "./comments/get-data.interface";
import { SingleListComponent } from "./comments/single-list.component";
export class TextareaCommentsDirective {
    /**
     * @param {?} injector
     * @param {?} el
     * @param {?} render
     * @param {?} localeSer
     * @param {?} cfr
     */
    constructor(injector, el, render, localeSer, cfr) {
        this.injector = injector;
        this.el = el;
        this.render = render;
        this.localeSer = localeSer;
        this.cfr = cfr;
        this.useComments = true;
        this.maxHeight = 300;
        this.title = '';
        this.mgrText = '';
        this.commentsBtnElement = null;
        this.singListRef = null;
        this.listPanelElRef = null;
        this.commentSer = this.injector.get(CommentsHttpToken, null);
        this.overlaySer = this.injector.get(OverLayHiddenService, null);
        this.commonUtil = this.injector.get(CommonUtils, null);
        if (!this.overlaySer) {
            this.overlaySer = new OverLayHiddenService();
        }
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.ngControl = this.injector.get(NgControl, null);
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.init();
        this.listenAttributesChanged();
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (changes.useComments && !changes.useComments.isFirstChange()) {
            this.init();
        }
    }
    /**
     * @private
     * @return {?}
     */
    init() {
        /** @type {?} */
        const readonly = this.el.nativeElement.readOnly;
        /** @type {?} */
        const disabled = this.el.nativeElement.disabled;
        if (this.useComments && (!readonly && !disabled)) {
            this.createCommentsButton();
        }
        else {
            this.destroy();
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.destroy();
        this.hideListPanel();
        // 停止观察属性变化
        this.observer.disconnect();
        this.observer = null;
    }
    /**
     * @return {?}
     */
    listenAttributesChanged() {
        // 选择需要观察变动的节点
        /** @type {?} */
        const targetNode = this.el.nativeElement;
        // 观察器的配置（需要观察什么变动）
        /** @type {?} */
        const config = { attributes: true };
        // 当观察到变动时执行的回调函数
        /** @type {?} */
        const callback = (/**
         * @param {?} mutationsList
         * @param {?} observer
         * @return {?}
         */
        (mutationsList, observer) => {
            // Use traditional 'for loops' for IE 11
            for (let mutation of mutationsList) {
                if (mutation.type === 'attributes' && (mutation.attributeName === 'readonly' || mutation.attributeName === 'disabled')) {
                    this.init();
                }
            }
        });
        // 创建一个观察器实例并传入回调函数
        this.observer = new MutationObserver(callback);
        // 以上述配置开始观察目标节点
        this.observer.observe(targetNode, config);
    }
    /**
     * @return {?}
     */
    destroy() {
        if (this.commentsBtnElement) {
            this.commentsBtnElement.remove();
        }
    }
    /**
     * @private
     * @return {?}
     */
    createID() {
        /** @type {?} */
        const tagName = this.el.nativeElement.tagName;
        if (this.ngControl) {
            /** @type {?} */
            const ctrlName = this.ngControl.name;
            return `${tagName}_COMMENTS_${ctrlName}`;
        }
        else {
            if (this.el.nativeElement.id) {
                return `${tagName}_COMMENTS_${this.el.nativeElement.id}`;
            }
        }
        return '';
    }
    /**
     * @private
     * @return {?}
     */
    createCommentsButton() {
        /** @type {?} */
        const commentsBtn = this.render.createElement('span');
        commentsBtn.className = 'dropdown-toggle';
        commentsBtn.title = this.title ? this.title : (this.localeSer.getValue('text.comments.title') || '常用意见');
        /** @type {?} */
        const id = this.createID();
        if (id) {
            commentsBtn.id = id;
        }
        this.render.setStyle(commentsBtn, 'position', 'absolute');
        this.render.setStyle(commentsBtn, 'left', '3px');
        this.render.setStyle(commentsBtn, 'bottom', '0px');
        this.render.setStyle(commentsBtn, 'cursor', 'pointer');
        /** @type {?} */
        const icon = this.render.createElement('span');
        this.render.appendChild(commentsBtn, icon);
        icon.className = 'f-icon f-icon-message';
        this.render.setStyle(icon, 'position', 'relative');
        // this.render.setStyle(icon, 'margin-right', '3px');
        this.render.setStyle(icon, 'top', '1px');
        this.render.setStyle(icon, 'font-size', '13px');
        this.el.nativeElement.after(commentsBtn);
        this.commentsBtnElement = commentsBtn;
        this.render.listen(commentsBtn, 'click', (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            e.stopPropagation();
            if (!this.listPanelElRef) {
                this.showListPanel();
            }
            else {
                this.hideListPanel();
            }
        }));
    }
    /**
     * @private
     * @return {?}
     */
    showListPanel() {
        /** @type {?} */
        const listPanelEl = this.render.createElement('div');
        /** @type {?} */
        const zindex = this.commonUtil.getFloatingLayerIndex();
        const { left, bottom } = this.commentsBtnElement.getBoundingClientRect();
        this.render.setStyle(listPanelEl, 'width', '200px');
        this.render.setStyle(listPanelEl, 'max-height', `${this.maxHeight}px`);
        this.render.setStyle(listPanelEl, 'position', 'absolute');
        this.render.setStyle(listPanelEl, 'left', `${left}px`);
        this.render.setStyle(listPanelEl, 'top', '0px');
        this.render.setStyle(listPanelEl, 'z-index', zindex);
        this.render.setStyle(listPanelEl, 'box-shadow', '0 2px 8px 0 #dedede');
        this.render.setStyle(listPanelEl, 'border-radius', '6px');
        this.render.setStyle(listPanelEl, 'background', 'white');
        this.render.setStyle(listPanelEl, 'visibility', 'hidden');
        document.body.append(listPanelEl);
        this.listPanelElRef = listPanelEl;
        /** @type {?} */
        const singListCmf = this.cfr.resolveComponentFactory(SingleListComponent);
        this.singListRef = singListCmf.create(this.injector);
        this.singListRef.instance.showButtons = true;
        this.singListRef.instance.emptyDataMsg = this.localeSer.getValue('text.comments.empty');
        this.singListRef.instance.buttons = [
            {
                text: this.mgrText ? this.mgrText : this.localeSer.getValue('text.comments.manager'),
                iconCls: 'f-icon f-icon-home-setup', handler: (/**
                 * @return {?}
                 */
                () => {
                    if (this.commentSer) {
                        this.hideListPanel();
                        this.commentSer.showCommentManageDialog({ type: 'forms' }).subscribe((/**
                         * @param {?} e
                         * @return {?}
                         */
                        (e) => {
                            console.log(e);
                        }));
                    }
                })
            }
        ];
        this.singListRef.instance.textField = 'message';
        this.singListRef.instance.maxItems = 999999;
        this.singListRef.instance.itemClick.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            /** @type {?} */
            const val = e.data['message'];
            /** @type {?} */
            let _text = this.el.nativeElement.value || '';
            _text += val;
            if (this.ngControl) {
                this.ngControl.control.patchValue(_text);
            }
            else {
                this.el.nativeElement.value = _text;
            }
            this.hideListPanel();
        }));
        listPanelEl.appendChild(this.singListRef.location.nativeElement);
        this.singListRef.changeDetectorRef.detectChanges();
        this.loadData(this.singListRef);
        this.overlaySer.registerMouseEvent(listPanelEl, (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (this.listPanelElRef.contains(e.target) || this.commentsBtnElement === e.target || this.commentsBtnElement.contains(e.target)) {
                return;
            }
            this.hideListPanel();
        }));
    }
    /**
     * @return {?}
     */
    hideListPanel() {
        if (this.singListRef) {
            this.singListRef.destroy();
            this.singListRef = null;
        }
        if (this.listPanelElRef) {
            this.listPanelElRef.remove();
            this.overlaySer.destory(this.listPanelElRef);
            this.listPanelElRef = null;
        }
    }
    /**
     * @private
     * @param {?} singListRef
     * @return {?}
     */
    loadData(singListRef) {
        if (this.commentSer) {
            this.commentSer.getCommonComments({ type: 'forms' }).subscribe((/**
             * @param {?} data
             * @return {?}
             */
            (data) => {
                singListRef.instance.loadData(data);
                setTimeout((/**
                 * @return {?}
                 */
                () => {
                    this.resetPosition();
                }));
            }));
        }
    }
    /**
     * @private
     * @return {?}
     */
    resetPosition() {
        const { top, bottom, left } = this.commentsBtnElement.getBoundingClientRect();
        /** @type {?} */
        const panelHeight = this.listPanelElRef.offsetHeight;
        if (window.innerHeight - bottom > this.maxHeight || window.innerHeight - bottom > panelHeight) {
            this.render.setStyle(this.listPanelElRef, 'top', `${bottom}px`);
            this.render.removeStyle(this.listPanelElRef, 'visibility');
            return;
        }
        else {
            if (top > this.maxHeight || top > panelHeight) {
                this.render.setStyle(this.listPanelElRef, 'top', `${top - panelHeight}px`);
            }
            else {
                this.render.setStyle(this.listPanelElRef, 'top', '0px');
                if (left > 200) {
                    this.render.setStyle(this.listPanelElRef, 'left', `${left - 200}px`);
                }
            }
            this.render.removeStyle(this.listPanelElRef, 'visibility');
        }
    }
}
TextareaCommentsDirective.decorators = [
    { type: Directive, args: [{
                selector: '[common-comments]',
            },] }
];
/** @nocollapse */
TextareaCommentsDirective.ctorParameters = () => [
    { type: Injector },
    { type: ElementRef },
    { type: Renderer2 },
    { type: LocaleService },
    { type: ComponentFactoryResolver }
];
TextareaCommentsDirective.propDecorators = {
    useComments: [{ type: Input, args: ['common-comments',] }],
    maxHeight: [{ type: Input }],
    title: [{ type: Input }],
    mgrText: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    TextareaCommentsDirective.prototype.useComments;
    /** @type {?} */
    TextareaCommentsDirective.prototype.maxHeight;
    /** @type {?} */
    TextareaCommentsDirective.prototype.title;
    /** @type {?} */
    TextareaCommentsDirective.prototype.mgrText;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.commentSer;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.eventManager;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.ngControl;
    /** @type {?} */
    TextareaCommentsDirective.prototype.commentsBtnElement;
    /** @type {?} */
    TextareaCommentsDirective.prototype.singListRef;
    /** @type {?} */
    TextareaCommentsDirective.prototype.listPanelElRef;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.overlaySer;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.observer;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.commonUtil;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.localeSer;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.cfr;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dGFyZWEtY29tbWVudHMuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1mb3Jtcy8iLCJzb3VyY2VzIjpbImxpYi90ZXh0YXJlYS1jb21tZW50cy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBaUIsd0JBQXdCLEVBQWdCLFNBQVMsRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBZ0MsU0FBUyxFQUFpQixNQUFNLGVBQWUsQ0FBQztBQUN0TCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0MsT0FBTyxFQUFFLFdBQVcsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3RFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsaUJBQWlCLEVBQXdCLE1BQU0sK0JBQStCLENBQUM7QUFDeEYsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFNdkUsTUFBTSxPQUFPLHlCQUF5Qjs7Ozs7Ozs7SUFpQmxDLFlBQW9CLFFBQWtCLEVBQVUsRUFBYyxFQUFVLE1BQWlCLEVBQzdFLFNBQXdCLEVBQVUsR0FBNkI7UUFEdkQsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLE9BQUUsR0FBRixFQUFFLENBQVk7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQzdFLGNBQVMsR0FBVCxTQUFTLENBQWU7UUFBVSxRQUFHLEdBQUgsR0FBRyxDQUEwQjtRQWhCakQsZ0JBQVcsR0FBRyxJQUFJLENBQUM7UUFDcEMsY0FBUyxHQUFHLEdBQUcsQ0FBQztRQUNoQixVQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ1gsWUFBTyxHQUFHLEVBQUUsQ0FBQztRQUt0Qix1QkFBa0IsR0FBRyxJQUFJLENBQUM7UUFDMUIsZ0JBQVcsR0FBc0MsSUFBSSxDQUFDO1FBQ3RELG1CQUFjLEdBQUcsSUFBSSxD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SUFFdEIsK0NBQXlDOzs7OztJQUN6QyxpREFBbUM7Ozs7O0lBQ25DLDhDQUE2Qjs7SUFDN0IsdURBQTBCOztJQUMxQixnREFBc0Q7O0lBQ3RELG1EQUFzQjs7Ozs7SUFDdEIsK0NBQXlDOzs7OztJQUV6Qyw2Q0FBbUM7Ozs7O0lBQ25DLCtDQUFnQzs7Ozs7SUFDcEIsNkNBQTBCOzs7OztJQUFFLHVDQUFzQjs7Ozs7SUFBRSwyQ0FBeUI7Ozs7O0lBQ3JGLDhDQUFnQzs7Ozs7SUFBRSx3Q0FBcUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlclZpZXdJbml0LCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIENvbXBvbmVudFJlZiwgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBJbmplY3RvciwgSW5wdXQsIE9uQ2hhbmdlcywgT25EZXN0cm95LCBPbkluaXQsIFJlbmRlcmVyMiwgU2ltcGxlQ2hhbmdlcyB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IE5nQ29udHJvbCB9IGZyb20gXCJAYW5ndWxhci9mb3Jtc1wiO1xyXG5pbXBvcnQgeyBFdmVudE1hbmFnZXIgfSBmcm9tIFwiQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3NlclwiO1xyXG5pbXBvcnQgeyBDb21tb25VdGlscywgT3ZlckxheUhpZGRlblNlcnZpY2UgfSBmcm9tIFwiQGZhcnJpcy91aS1jb21tb25cIjtcclxuaW1wb3J0IHsgTG9jYWxlU2VydmljZSB9IGZyb20gXCJAZmFycmlzL3VpLWxvY2FsZVwiO1xyXG5pbXBvcnQgeyBDb21tZW50c0h0dHBUb2tlbiwgSUNvbW1lbnRzSHR0cFNlcnZpY2UgfSBmcm9tIFwiLi9jb21tZW50cy9nZXQtZGF0YS5pbnRlcmZhY2VcIjtcclxuaW1wb3J0IHsgU2luZ2xlTGlzdENvbXBvbmVudCB9IGZyb20gXCIuL2NvbW1lbnRzL3NpbmdsZS1saXN0LmNvbXBvbmVudFwiO1xyXG5cclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gICAgc2VsZWN0b3I6ICdbY29tbW9uLWNvbW1lbnRzXScsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBUZXh0YXJlYUNvbW1lbnRzRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XHJcblxyXG4gICAgQElucHV0KCdjb21tb24tY29tbWVudHMnKSB1c2VDb21tZW50cyA9IHRydWU7XHJcbiAgICBASW5wdXQoKSBtYXhIZWlnaHQgPSAzMDA7XHJcbiAgICBASW5wdXQoKSB0aXRsZSA9ICcnO1xyXG4gICAgQElucHV0KCkgbWdyVGV4dCA9ICcnO1xyXG5cclxuICAgIHByaXZhdGUgY29tbWVudFNlcjogSUNvbW1lbnRzSHR0cFNlcnZpY2U7XHJcbiAgICBwcml2YXRlIGV2ZW50TWFuYWdlcjogRXZlbnRNYW5hZ2VyO1xyXG4gICAgcHJpdmF0ZSBuZ0NvbnRyb2w6IE5nQ29udHJvbDtcclxuICAgIGNvbW1lbnRzQnRuRWxlbWVudCA9IG51bGw7XHJcbiAgICBzaW5nTGlzdFJlZjogQ29tcG9uZW50UmVmPFNpbmdsZUxpc3RDb21wb25lbnQ+ID0gbnVsbDtcclxuICAgIGxpc3RQYW5lbEVsUmVmID0gbnVsbDtcclxuICAgIHByaXZhdGUgb3ZlcmxheVNlcjogT3ZlckxheUhpZGRlblNlcnZpY2U7XHJcblxyXG4gICAgcHJpdmF0ZSBvYnNlcnZlcjogTXV0YXRpb25PYnNlcnZlcjtcclxuICAgIHByaXZhdGUgY29tbW9uVXRpbDogQ29tbW9uVXRpbHM7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSBlbDogRWxlbWVudFJlZiwgcHJpdmF0ZSByZW5kZXI6IFJlbmRlcmVyMiwgXHJcbiAgICAgICAgcHJpdmF0ZSBsb2NhbGVTZXI6IExvY2FsZVNlcnZpY2UsIHByaXZhdGUgY2ZyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpIHtcclxuICAgICAgICB0aGlzLmNvbW1lbnRTZXIgPSB0aGlzLmluamVjdG9yLmdldChDb21tZW50c0h0dHBUb2tlbiwgbnVsbCk7XHJcbiAgICAgICAgdGhpcy5vdmVybGF5U2VyID0gdGhpcy5pbmplY3Rvci5nZXQoT3ZlckxheUhpZGRlblNlcnZpY2UsIG51bGwpO1xyXG4gICAgICAgIHRoaXMuY29tbW9uVXRpbCA9IHRoaXMuaW5qZWN0b3IuZ2V0KENvbW1vblV0aWxzLCBudWxsKTtcclxuICAgICAgICBpZiAoIXRoaXMub3ZlcmxheVNlcikge1xyXG4gICAgICAgICAgICB0aGlzLm92ZXJsYXlTZXIgPSBuZXcgT3ZlckxheUhpZGRlblNlcnZpY2UoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5uZ0NvbnRyb2wgPSB0aGlzLmluamVjdG9yLmdldChOZ0NvbnRyb2wsIG51bGwpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcclxuICAgICAgICB0aGlzLmluaXQoKTtcclxuICAgICAgICB0aGlzLmxpc3RlbkF0dHJpYnV0ZXNDaGFuZ2VkKCk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xyXG4gICAgICAgIGlmIChjaGFuZ2VzLnVzZUNvbW1lbnRzICYmICFjaGFuZ2VzLnVzZUNvbW1lbnRzLmlzRmlyc3RDaGFuZ2UoKSkge1xyXG4gICAgICAgICAgICB0aGlzLmluaXQoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0KCkge1xyXG4gICAgICAgIGNvbnN0IHJlYWRvbmx5ID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50LnJlYWRPbmx5O1xyXG4gICAgICAgIGNvbnN0IGRpc2FibGVkID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50LmRpc2FibGVkO1xyXG4gICAgICAgIGlmICh0aGlzLnVzZUNvbW1lbnRzICYmICghcmVhZG9ubHkgJiYgIWRpc2FibGVkKSkge1xyXG4gICAgICAgICAgICB0aGlzLmNyZWF0ZUNvbW1lbnRzQnV0dG9uKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuZGVzdHJveSgpO1xyXG4gICAgICAgIHRoaXMuaGlkZUxpc3RQYW5lbCgpO1xyXG4gICAgICAgIC8vIOWBnOatouinguWvn+WxnuaAp+WPmOWMllxyXG4gICAgICAgIHRoaXMub2JzZXJ2ZXIuZGlzY29ubmVjdCgpO1xyXG4gICAgICAgIHRoaXMub2JzZXJ2ZXIgPSBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIGxpc3RlbkF0dHJpYnV0ZXNDaGFuZ2VkKCkge1xyXG4gICAgICAgIC8vIOmAieaLqemcgOimgeinguWvn+WPmOWKqOeahOiKgueCuVxyXG4gICAgICAgIGNvbnN0IHRhcmdldE5vZGUgPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQ7XHJcblxyXG4gICAgICAgIC8vIOinguWvn+WZqOeahOmFjee9ru+8iOmcgOimgeinguWvn+S7gOS5iOWPmOWKqO+8iVxyXG4gICAgICAgIGNvbnN0IGNvbmZpZyA9IHsgYXR0cmlidXRlczogdHJ1ZSB9O1xyXG5cclxuICAgICAgICAvLyDlvZPop4Llr5/liLDlj5jliqjml7bmiafooYznmoTlm57osIPlh73mlbBcclxuICAgICAgICBjb25zdCBjYWxsYmFjayA9IChtdXRhdGlvbnNMaXN0LCBvYnNlcnZlcikgPT4ge1xyXG4gICAgICAgICAgICAvLyBVc2UgdHJhZGl0aW9uYWwgJ2ZvciBsb29wcycgZm9yIElFIDExXHJcbiAgICAgICAgICAgIGZvcihsZXQgbXV0YXRpb24gb2YgbXV0YXRpb25zTGlzdCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKG11dGF0aW9uLnR5cGUgPT09ICdhdHRyaWJ1dGVzJyAmJiAobXV0YXRpb24uYXR0cmlidXRlTmFtZSA9PT0gJ3JlYWRvbmx5JyB8fCBtdXRhdGlvbi5hdHRyaWJ1dGVOYW1lID09PSAnZGlzYWJsZWQnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5pdCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLy8g5Yib5bu65LiA5Liq6KeC5a+f5Zmo5a6e5L6L5bm25Lyg5YWl5Zue6LCD5Ye95pWwXHJcbiAgICAgICAgdGhpcy5vYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKGNhbGxiYWNrKTtcclxuXHJcbiAgICAgICAgLy8g5Lul5LiK6L+w6YWN572u5byA5aeL6KeC5a+f55uu5qCH6IqC54K5XHJcbiAgICAgICAgdGhpcy5vYnNlcnZlci5vYnNlcnZlKHRhcmdldE5vZGUsIGNvbmZpZyk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGRlc3Ryb3koKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuY29tbWVudHNCdG5FbGVtZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29tbWVudHNCdG5FbGVtZW50LnJlbW92ZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNyZWF0ZUlEKCkge1xyXG4gICAgICAgIGNvbnN0IHRhZ05hbWUgPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQudGFnTmFtZTtcclxuICAgICAgICBpZiAodGhpcy5uZ0NvbnRyb2wpIHtcclxuICAgICAgICAgICAgY29uc3QgY3RybE5hbWUgPSB0aGlzLm5nQ29udHJvbC5uYW1lO1xyXG4gICAgICAgICAgICByZXR1cm4gYCR7dGFnTmFtZX1fQ09NTUVOVFNfJHtjdHJsTmFtZX1gO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuaWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBgJHt0YWdOYW1lfV9DT01NRU5UU18ke3RoaXMuZWwubmF0aXZlRWxlbWVudC5pZH1gO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNyZWF0ZUNvbW1lbnRzQnV0dG9uKCkge1xyXG4gICAgICAgIGNvbnN0IGNvbW1lbnRzQnRuID0gdGhpcy5yZW5kZXIuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xyXG4gICAgICAgIGNvbW1lbnRzQnRuLmNsYXNzTmFtZSA9ICdkcm9wZG93bi10b2dnbGUnO1xyXG4gICAgICAgIGNvbW1lbnRzQnRuLnRpdGxlID0gdGhpcy50aXRsZSA/IHRoaXMudGl0bGUgOiAodGhpcy5sb2NhbGVTZXIuZ2V0VmFsdWUoJ3RleHQuY29tbWVudHMudGl0bGUnKSB8fCAn5bi455So5oSP6KeBJyk7XHJcbiAgICAgICAgY29uc3QgaWQgPSB0aGlzLmNyZWF0ZUlEKCk7XHJcbiAgICAgICAgaWYgKGlkKSB7XHJcbiAgICAgICAgICAgIGNvbW1lbnRzQnRuLmlkID0gaWQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShjb21tZW50c0J0biwgJ3Bvc2l0aW9uJywgJ2Fic29sdXRlJyk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUoY29tbWVudHNCdG4sICdsZWZ0JywgJzNweCcpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGNvbW1lbnRzQnRuLCAnYm90dG9tJywgJzBweCcpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGNvbW1lbnRzQnRuLCAnY3Vyc29yJywgJ3BvaW50ZXInKTtcclxuXHJcbiAgICAgICAgY29uc3QgaWNvbiA9IHRoaXMucmVuZGVyLmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5hcHBlbmRDaGlsZChjb21tZW50c0J0biwgaWNvbik7XHJcblxyXG4gICAgICAgIGljb24uY2xhc3NOYW1lID0gJ2YtaWNvbiBmLWljb24tbWVzc2FnZSc7XHJcbiAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUoaWNvbiwgJ3Bvc2l0aW9uJywgJ3JlbGF0aXZlJyk7XHJcbiAgICAgICAgLy8gdGhpcy5yZW5kZXIuc2V0U3R5bGUoaWNvbiwgJ21hcmdpbi1yaWdodCcsICczcHgnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShpY29uLCAndG9wJywgJzFweCcpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGljb24sICdmb250LXNpemUnLCAnMTNweCcpO1xyXG5cclxuICAgICAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuYWZ0ZXIoY29tbWVudHNCdG4pO1xyXG4gICAgICAgIHRoaXMuY29tbWVudHNCdG5FbGVtZW50ID0gY29tbWVudHNCdG47XHJcblxyXG4gICAgICAgIHRoaXMucmVuZGVyLmxpc3Rlbihjb21tZW50c0J0biwgJ2NsaWNrJywgKGU6IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmxpc3RQYW5lbEVsUmVmKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNob3dMaXN0UGFuZWwoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaGlkZUxpc3RQYW5lbCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNob3dMaXN0UGFuZWwoKSB7XHJcbiAgICAgICAgY29uc3QgbGlzdFBhbmVsRWwgPSB0aGlzLnJlbmRlci5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuXHJcblxyXG4gICAgICAgIGNvbnN0IHppbmRleCA9IHRoaXMuY29tbW9uVXRpbC5nZXRGbG9hdGluZ0xheWVySW5kZXgoKTtcclxuXHJcbiAgICAgICAgY29uc3QgeyBsZWZ0LCBib3R0b20gfSA9IHRoaXMuY29tbWVudHNCdG5FbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGxpc3RQYW5lbEVsLCAnd2lkdGgnLCAnMjAwcHgnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShsaXN0UGFuZWxFbCwgJ21heC1oZWlnaHQnLCBgJHt0aGlzLm1heEhlaWdodH1weGApO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGxpc3RQYW5lbEVsLCAncG9zaXRpb24nLCAnYWJzb2x1dGUnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShsaXN0UGFuZWxFbCwgJ2xlZnQnLCBgJHtsZWZ0fXB4YCk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUobGlzdFBhbmVsRWwsICd0b3AnLCAnMHB4Jyk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUobGlzdFBhbmVsRWwsICd6LWluZGV4JywgemluZGV4KTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShsaXN0UGFuZWxFbCwgJ2JveC1zaGFkb3cnLCAnMCAycHggOHB4IDAgI2RlZGVkZScpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGxpc3RQYW5lbEVsLCAnYm9yZGVyLXJhZGl1cycsICc2cHgnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShsaXN0UGFuZWxFbCwgJ2JhY2tncm91bmQnLCAnd2hpdGUnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShsaXN0UGFuZWxFbCwgJ3Zpc2liaWxpdHknLCAnaGlkZGVuJyk7XHJcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmQobGlzdFBhbmVsRWwpO1xyXG5cclxuICAgICAgICB0aGlzLmxpc3RQYW5lbEVsUmVmID0gbGlzdFBhbmVsRWw7XHJcblxyXG4gICAgICAgIGNvbnN0IHNpbmdMaXN0Q21mID0gdGhpcy5jZnIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoU2luZ2xlTGlzdENvbXBvbmVudCk7XHJcbiAgICAgICAgdGhpcy5zaW5nTGlzdFJlZiA9IHNpbmdMaXN0Q21mLmNyZWF0ZSh0aGlzLmluamVjdG9yKTtcclxuXHJcbiAgICAgICAgdGhpcy5zaW5nTGlzdFJlZi5pbnN0YW5jZS5zaG93QnV0dG9ucyA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5zaW5nTGlzdFJlZi5pbnN0YW5jZS5lbXB0eURhdGFNc2cgPSB0aGlzLmxvY2FsZVNlci5nZXRWYWx1ZSgndGV4dC5jb21tZW50cy5lbXB0eScpO1xyXG4gICAgICAgIHRoaXMuc2luZ0xpc3RSZWYuaW5zdGFuY2UuYnV0dG9ucyA9IFtcclxuICAgICAgICAgICAgeyBcclxuICAgICAgICAgICAgICAgIHRleHQ6IHRoaXMubWdyVGV4dCA/IHRoaXMubWdyVGV4dCA6IHRoaXMubG9jYWxlU2VyLmdldFZhbHVlKCd0ZXh0LmNvbW1lbnRzLm1hbmFnZXInKSwgXHJcbiAgICAgICAgICAgICAgICBpY29uQ2xzOiAnZi1pY29uIGYtaWNvbi1ob21lLXNldHVwJywgaGFuZGxlcjogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNvbW1lbnRTZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlTGlzdFBhbmVsKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29tbWVudFNlci5zaG93Q29tbWVudE1hbmFnZURpYWxvZyh7dHlwZTogJ2Zvcm1zJ30pLnN1YnNjcmliZSgoZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgXTtcclxuICAgICAgICB0aGlzLnNpbmdMaXN0UmVmLmluc3RhbmNlLnRleHRGaWVsZCA9ICdtZXNzYWdlJztcclxuICAgICAgICB0aGlzLnNpbmdMaXN0UmVmLmluc3RhbmNlLm1heEl0ZW1zID0gOTk5OTk5O1xyXG5cclxuICAgICAgICB0aGlzLnNpbmdMaXN0UmVmLmluc3RhbmNlLml0ZW1DbGljay5zdWJzY3JpYmUoKGUpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdmFsID0gZS5kYXRhWydtZXNzYWdlJ107XHJcbiAgICAgICAgICAgIGxldCBfdGV4dCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC52YWx1ZSB8fCAnJztcclxuICAgICAgICAgICAgX3RleHQgKz0gdmFsO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5uZ0NvbnRyb2wpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubmdDb250cm9sLmNvbnRyb2wucGF0Y2hWYWx1ZShfdGV4dCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQudmFsdWUgPSBfdGV4dDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5oaWRlTGlzdFBhbmVsKCk7XHJcbiAgICAgICAgfSlcclxuXHJcbiAgICAgICAgbGlzdFBhbmVsRWwuYXBwZW5kQ2hpbGQodGhpcy5zaW5nTGlzdFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgICB0aGlzLnNpbmdMaXN0UmVmLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcclxuXHJcbiAgICAgICAgdGhpcy5sb2FkRGF0YSh0aGlzLnNpbmdMaXN0UmVmKTtcclxuXHJcblxyXG4gICAgICAgIHRoaXMub3ZlcmxheVNlci5yZWdpc3Rlck1vdXNlRXZlbnQobGlzdFBhbmVsRWwsIChlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmxpc3RQYW5lbEVsUmVmLmNvbnRhaW5zKGUudGFyZ2V0KSB8fCB0aGlzLmNvbW1lbnRzQnRuRWxlbWVudCA9PT0gZS50YXJnZXQgfHwgdGhpcy5jb21tZW50c0J0bkVsZW1lbnQuY29udGFpbnMoZS50YXJnZXQpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5oaWRlTGlzdFBhbmVsKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgaGlkZUxpc3RQYW5lbCgpIHtcclxuICAgICAgICBpZiAodGhpcy5zaW5nTGlzdFJlZikge1xyXG4gICAgICAgICAgICB0aGlzLnNpbmdMaXN0UmVmLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgdGhpcy5zaW5nTGlzdFJlZiA9IG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5saXN0UGFuZWxFbFJlZikge1xyXG4gICAgICAgICAgICB0aGlzLmxpc3RQYW5lbEVsUmVmLnJlbW92ZSgpO1xyXG4gICAgICAgICAgICB0aGlzLm92ZXJsYXlTZXIuZGVzdG9yeSh0aGlzLmxpc3RQYW5lbEVsUmVmKTtcclxuICAgICAgICAgICAgdGhpcy5saXN0UGFuZWxFbFJlZiA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbG9hZERhdGEoc2luZ0xpc3RSZWY6IENvbXBvbmVudFJlZjxTaW5nbGVMaXN0Q29tcG9uZW50Pikge1xyXG4gICAgICAgIGlmICh0aGlzLmNvbW1lbnRTZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5jb21tZW50U2VyLmdldENvbW1vbkNvbW1lbnRzKHt0eXBlOiAnZm9ybXMnfSkuc3Vic2NyaWJlKChkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBzaW5nTGlzdFJlZi5pbnN0YW5jZS5sb2FkRGF0YShkYXRhKTtcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVzZXRQb3NpdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlc2V0UG9zaXRpb24oKSB7XHJcbiAgICAgICAgY29uc3QgeyB0b3AsIGJvdHRvbSwgbGVmdCB9ID0gdGhpcy5jb21tZW50c0J0bkVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgY29uc3QgcGFuZWxIZWlnaHQgPSB0aGlzLmxpc3RQYW5lbEVsUmVmLm9mZnNldEhlaWdodDtcclxuICAgICAgICBpZiAod2luZG93LmlubmVySGVpZ2h0IC0gYm90dG9tICA+IHRoaXMubWF4SGVpZ2h0IHx8IHdpbmRvdy5pbm5lckhlaWdodCAtIGJvdHRvbSA+IHBhbmVsSGVpZ2h0KSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKHRoaXMubGlzdFBhbmVsRWxSZWYsICd0b3AnLCBgJHtib3R0b219cHhgKTtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXIucmVtb3ZlU3R5bGUodGhpcy5saXN0UGFuZWxFbFJlZiwgJ3Zpc2liaWxpdHknKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0b3AgPiB0aGlzLm1heEhlaWdodCB8fCB0b3AgPiBwYW5lbEhlaWdodCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUodGhpcy5saXN0UGFuZWxFbFJlZiwgJ3RvcCcsIGAke3RvcCAtIHBhbmVsSGVpZ2h0fXB4YCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZSh0aGlzLmxpc3RQYW5lbEVsUmVmLCAndG9wJywgJzBweCcpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGxlZnQgPiAyMDApIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZSh0aGlzLmxpc3RQYW5lbEVsUmVmLCAnbGVmdCcsIGAkeyBsZWZ0IC0gMjAwIH1weGAgKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnJlbmRlci5yZW1vdmVTdHlsZSh0aGlzLmxpc3RQYW5lbEVsUmVmLCAndmlzaWJpbGl0eScpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufSJdfQ==