/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, Input, Injector, ElementRef, HostListener } from '@angular/core';
import { NgControl } from '@angular/forms';
export class TextareaAutoSizeDirective {
    /**
     * @param {?} el
     * @param {?} ngControl
     * @param {?} injector
     */
    constructor(el, ngControl, injector) {
        this.el = el;
        this.ngControl = ngControl;
        this.injector = injector;
        this.enable = true;
        this.previousValue = null;
        this.isUserResized = false;
        this.textarea = this.el.nativeElement;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.init();
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (changes.enable && !changes.enable.isFirstChange()) {
            this.sizeToFit();
        }
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        if (!this.enable) {
            return;
        }
        if (this.maxHeight) {
            this.textarea.style.maxHeight = `${this.maxHeight}px`;
        }
        this.minHeight = this.textarea.getBoundingClientRect().height;
        if (this.minHeight) {
            this.textarea.style.minHeight = `${this.minHeight}px`;
        }
    }
    /**
     * @private
     * @return {?}
     */
    init() {
        if (this.enable) {
            this.document = this.textarea.ownerDocument;
            this.documentElement = this.document.documentElement;
            if (this.textarea) {
                if (this.textarea.value) {
                    this.sizeToFit();
                }
            }
            if (this.ngControl) {
                this.ngControl.valueChanges.subscribe((/**
                 * @param {?} v
                 * @return {?}
                 */
                v => {
                    if (v !== this.previousValue) {
                        this.sizeToFit();
                    }
                }));
            }
        }
    }
    /**
     * @return {?}
     */
    onInput() {
        this.sizeToFit();
    }
    /**
     * @return {?}
     */
    onValueChange() {
        this.sizeToFit();
    }
    /**
     * @private
     * @return {?}
     */
    overflowOffset() {
        /** @type {?} */
        let offsetTop = 0;
        /** @type {?} */
        let el = this.textarea;
        while (el !== document.body && el !== null) {
            offsetTop += el.offsetTop || 0;
            el = el.offsetParent;
        }
        /** @type {?} */
        const top = offsetTop - document.defaultView.pageYOffset;
        /** @type {?} */
        const bottom = this.documentElement.clientHeight - (top + this.textarea.offsetHeight);
        return { top, bottom };
    }
    /**
     * @private
     * @return {?}
     */
    sizeToFit() {
        if (!this.enable) {
            return;
        }
        /** @type {?} */
        const textarea = this.textarea;
        /** @type {?} */
        const viewportMarginBottom = 100;
        if (this.isUserResized) {
            return;
        }
        if (this.textarea.value === this.previousValue) {
            return;
        }
        if (this.textarea.offsetWidth <= 0 && this.textarea.offsetHeight <= 0) {
            return;
        }
        // const { top, bottom } = this.overflowOffset();
        // if (top < 0 || bottom < 0) {
        //     return;
        // }
        /** @type {?} */
        const textareaStyle = getComputedStyle(textarea);
        /** @type {?} */
        const topBorderWidth = Number(textareaStyle.borderTopWidth.replace(/px/, ''));
        /** @type {?} */
        const bottomBorderWidth = Number(textareaStyle.borderBottomWidth.replace(/px/, ''));
        /** @type {?} */
        const isBorderBox = textareaStyle.boxSizing === 'border-box';
        /** @type {?} */
        const borderAddOn = isBorderBox ? topBorderWidth + bottomBorderWidth : 0;
        // const maxHeight = Number(textareaStyle.height.replace(/px/, '')) + bottom;
        // const adjustedViewportMarginBottom = bottom < viewportMarginBottom ? bottom : viewportMarginBottom;
        // textarea.style.maxHeight = `${maxHeight - adjustedViewportMarginBottom}px`;
        /** @type {?} */
        const container = textarea.parentElement;
        if (container instanceof HTMLElement) {
            /** @type {?} */
            const containerHeight = container.style.height;
            container.style.height = getComputedStyle(container).height;
            textarea.style.height = 'auto';
            /** @type {?} */
            let h = textarea.scrollHeight + borderAddOn;
            if (this.minHeight > h) {
                h = this.minHeight;
            }
            textarea.style.height = `${h}px`;
            container.style.height = containerHeight;
        }
        this.previousValue = textarea.value;
    }
}
TextareaAutoSizeDirective.decorators = [
    { type: Directive, args: [{
                selector: '[auto-size]',
            },] }
];
/** @nocollapse */
TextareaAutoSizeDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: NgControl },
    { type: Injector }
];
TextareaAutoSizeDirective.propDecorators = {
    enable: [{ type: Input, args: ['auto-size',] }],
    maxHeight: [{ type: Input }],
    onInput: [{ type: HostListener, args: ['input',] }],
    onValueChange: [{ type: HostListener, args: ['change',] }]
};
if (false) {
    /** @type {?} */
    TextareaAutoSizeDirective.prototype.enable;
    /** @type {?} */
    TextareaAutoSizeDirective.prototype.maxHeight;
    /**
     * @type {?}
     * @private
     */
    TextareaAutoSizeDirective.prototype.previousValue;
    /**
     * @type {?}
     * @private
     */
    TextareaAutoSizeDirective.prototype.isUserResized;
    /**
     * @type {?}
     * @private
     */
    TextareaAutoSizeDirective.prototype.textarea;
    /**
     * @type {?}
     * @private
     */
    TextareaAutoSizeDirective.prototype.document;
    /**
     * @type {?}
     * @private
     */
    TextareaAutoSizeDirective.prototype.documentElement;
    /**
     * @type {?}
     * @private
     */
    TextareaAutoSizeDirective.prototype.minHeight;
    /**
     * @type {?}
     * @private
     */
    TextareaAutoSizeDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    TextareaAutoSizeDirective.prototype.ngControl;
    /**
     * @type {?}
     * @private
     */
    TextareaAutoSizeDirective.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dGFyZWEtYXV0b3NpemUuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1mb3Jtcy8iLCJzb3VyY2VzIjpbImxpYi90ZXh0YXJlYS1hdXRvc2l6ZS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBVSxVQUFVLEVBQUUsWUFBWSxFQUEyQyxNQUFNLGVBQWUsQ0FBQztBQUN0SSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFLM0MsTUFBTSxPQUFPLHlCQUF5Qjs7Ozs7O0lBWWxDLFlBQW9CLEVBQWMsRUFBVSxTQUFvQixFQUFVLFFBQWtCO1FBQXhFLE9BQUUsR0FBRixFQUFFLENBQVk7UUFBVSxjQUFTLEdBQVQsU0FBUyxDQUFXO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQVh4RSxXQUFNLEdBQUcsSUFBSSxDQUFDO1FBRzFCLGtCQUFhLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLGtCQUFhLEdBQUcsS0FBSyxDQUFDO1FBUTFCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUM7SUFDMUMsQ0FBQzs7OztJQUVELFFBQVE7UUFDSixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDaEIsQ0FBQzs7Ozs7SUFFRCxXQUFXLENBQUMsT0FBc0I7UUFDOUIsSUFBSSxPQUFPLENBQUMsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUUsRUFBRTtZQUNuRCxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7U0FDcEI7SUFDTCxDQUFDOzs7O0lBRUQsZUFBZTtRQUNYLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ2QsT0FBTztTQUNWO1FBRUQsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2hCLElBQUksQ0FBQyxRQUFRLENBQUMsS0FB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Q0FBaUI7Ozs7O0lBQ2pCLG9EQUF3Qjs7Ozs7SUFDeEIsOENBQWtCOzs7OztJQUVOLHVDQUFzQjs7Ozs7SUFBRSw4Q0FBNEI7Ozs7O0lBQUUsNkNBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBJbnB1dCwgSW5qZWN0b3IsIE9uSW5pdCwgRWxlbWVudFJlZiwgSG9zdExpc3RlbmVyLCBBZnRlclZpZXdJbml0LCBPbkNoYW5nZXMsIFNpbXBsZUNoYW5nZXMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTmdDb250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogJ1thdXRvLXNpemVdJyxcclxufSlcclxuZXhwb3J0IGNsYXNzIFRleHRhcmVhQXV0b1NpemVEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQsIE9uQ2hhbmdlc3tcclxuICAgIEBJbnB1dCgnYXV0by1zaXplJykgZW5hYmxlID0gdHJ1ZTtcclxuICAgIEBJbnB1dCgpIG1heEhlaWdodDogbnVtYmVyO1xyXG5cclxuICAgIHByaXZhdGUgcHJldmlvdXNWYWx1ZSA9IG51bGw7XHJcbiAgICBwcml2YXRlIGlzVXNlclJlc2l6ZWQgPSBmYWxzZTtcclxuXHJcbiAgICBwcml2YXRlIHRleHRhcmVhO1xyXG4gICAgcHJpdmF0ZSBkb2N1bWVudDtcclxuICAgIHByaXZhdGUgZG9jdW1lbnRFbGVtZW50O1xyXG4gICAgcHJpdmF0ZSBtaW5IZWlnaHQ7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBlbDogRWxlbWVudFJlZiwgcHJpdmF0ZSBuZ0NvbnRyb2w6IE5nQ29udHJvbCwgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuICAgICAgICB0aGlzLnRleHRhcmVhID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50O1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25Jbml0KCkge1xyXG4gICAgICAgIHRoaXMuaW5pdCgpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcclxuICAgICAgICBpZiAoY2hhbmdlcy5lbmFibGUgJiYgIWNoYW5nZXMuZW5hYmxlLmlzRmlyc3RDaGFuZ2UoKSkge1xyXG4gICAgICAgICAgICB0aGlzLnNpemVUb0ZpdCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBuZ0FmdGVyVmlld0luaXQoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGlmICh0aGlzLm1heEhlaWdodCkge1xyXG4gICAgICAgICAgICB0aGlzLnRleHRhcmVhLnN0eWxlLm1heEhlaWdodCA9IGAke3RoaXMubWF4SGVpZ2h0fXB4YDtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgdGhpcy5taW5IZWlnaHQgPSB0aGlzLnRleHRhcmVhLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmhlaWdodDtcclxuICAgICAgICBpZiAodGhpcy5taW5IZWlnaHQpIHtcclxuICAgICAgICAgICAgdGhpcy50ZXh0YXJlYS5zdHlsZS5taW5IZWlnaHQgPSBgJHt0aGlzLm1pbkhlaWdodH1weGA7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaW5pdCgpIHtcclxuICAgICAgICBpZiAodGhpcy5lbmFibGUpIHtcclxuICAgICAgICAgICAgdGhpcy5kb2N1bWVudCA9IHRoaXMudGV4dGFyZWEub3duZXJEb2N1bWVudDtcclxuICAgICAgICAgICAgdGhpcy5kb2N1bWVudEVsZW1lbnQgPSB0aGlzLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudDtcclxuICAgICAgICAgICAgaWYgKHRoaXMudGV4dGFyZWEpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnRleHRhcmVhLnZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaXplVG9GaXQoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMubmdDb250cm9sKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm5nQ29udHJvbC52YWx1ZUNoYW5nZXMuc3Vic2NyaWJlKHYgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh2ICE9PSB0aGlzLnByZXZpb3VzVmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaXplVG9GaXQoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBASG9zdExpc3RlbmVyKCdpbnB1dCcpXHJcbiAgICBvbklucHV0KCkge1xyXG4gICAgICAgIHRoaXMuc2l6ZVRvRml0KCk7XHJcbiAgICB9XHJcblxyXG4gICAgQEhvc3RMaXN0ZW5lcignY2hhbmdlJylcclxuICAgIG9uVmFsdWVDaGFuZ2UoKSB7XHJcbiAgICAgICAgdGhpcy5zaXplVG9GaXQoKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBvdmVyZmxvd09mZnNldCgpIHtcclxuICAgICAgICBsZXQgb2Zmc2V0VG9wID0gMDtcclxuICAgICAgICBsZXQgZWwgPSB0aGlzLnRleHRhcmVhO1xyXG5cclxuICAgICAgICB3aGlsZSAoZWwgIT09IGRvY3VtZW50LmJvZHkgJiYgZWwgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgb2Zmc2V0VG9wICs9IGVsLm9mZnNldFRvcCB8fCAwO1xyXG4gICAgICAgICAgICBlbCA9IGVsLm9mZnNldFBhcmVudDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHRvcCA9IG9mZnNldFRvcCAtIGRvY3VtZW50LmRlZmF1bHRWaWV3LnBhZ2VZT2Zmc2V0O1xyXG4gICAgICAgIGNvbnN0IGJvdHRvbSA9IHRoaXMuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCAtICh0b3AgKyB0aGlzLnRleHRhcmVhLm9mZnNldEhlaWdodCk7XHJcbiAgICAgICAgcmV0dXJuIHsgdG9wLCBib3R0b20gfTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNpemVUb0ZpdCgpIHtcclxuICAgICAgICBpZiAoIXRoaXMuZW5hYmxlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHRleHRhcmVhID0gdGhpcy50ZXh0YXJlYTtcclxuICAgICAgICBjb25zdCB2aWV3cG9ydE1hcmdpbkJvdHRvbSA9IDEwMDtcclxuICAgICAgICBpZiAodGhpcy5pc1VzZXJSZXNpemVkKSB7IHJldHVybjsgfVxyXG4gICAgICAgIGlmICh0aGlzLnRleHRhcmVhLnZhbHVlID09PSB0aGlzLnByZXZpb3VzVmFsdWUpIHsgcmV0dXJuOyB9XHJcbiAgICAgICAgaWYgKHRoaXMudGV4dGFyZWEub2Zmc2V0V2lkdGggPD0gMCAmJiB0aGlzLnRleHRhcmVhLm9mZnNldEhlaWdodCA8PSAwKSB7IHJldHVybjsgfVxyXG5cclxuICAgICAgICAvLyBjb25zdCB7IHRvcCwgYm90dG9tIH0gPSB0aGlzLm92ZXJmbG93T2Zmc2V0KCk7XHJcbiAgICAgICAgLy8gaWYgKHRvcCA8IDAgfHwgYm90dG9tIDwgMCkge1xyXG4gICAgICAgIC8vICAgICByZXR1cm47XHJcbiAgICAgICAgLy8gfVxyXG5cclxuICAgICAgICBjb25zdCB0ZXh0YXJlYVN0eWxlID0gZ2V0Q29tcHV0ZWRTdHlsZSh0ZXh0YXJlYSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHRvcEJvcmRlcldpZHRoID0gTnVtYmVyKHRleHRhcmVhU3R5bGUuYm9yZGVyVG9wV2lkdGgucmVwbGFjZSgvcHgvLCAnJykpO1xyXG4gICAgICAgIGNvbnN0IGJvdHRvbUJvcmRlcldpZHRoID0gTnVtYmVyKHRleHRhcmVhU3R5bGUuYm9yZGVyQm90dG9tV2lkdGgucmVwbGFjZSgvcHgvLCAnJykpO1xyXG5cclxuICAgICAgICBjb25zdCBpc0JvcmRlckJveCA9IHRleHRhcmVhU3R5bGUuYm94U2l6aW5nID09PSAnYm9yZGVyLWJveCc7XHJcbiAgICAgICAgY29uc3QgYm9yZGVyQWRkT24gPSBpc0JvcmRlckJveCA/IHRvcEJvcmRlcldpZHRoICsgYm90dG9tQm9yZGVyV2lkdGggOiAwO1xyXG5cclxuICAgICAgICAvLyBjb25zdCBtYXhIZWlnaHQgPSBOdW1iZXIodGV4dGFyZWFTdHlsZS5oZWlnaHQucmVwbGFjZSgvcHgvLCAnJykpICsgYm90dG9tO1xyXG4gICAgICAgIC8vIGNvbnN0IGFkanVzdGVkVmlld3BvcnRNYXJnaW5Cb3R0b20gPSBib3R0b20gPCB2aWV3cG9ydE1hcmdpbkJvdHRvbSA/IGJvdHRvbSA6IHZpZXdwb3J0TWFyZ2luQm90dG9tO1xyXG4gICAgICAgIC8vIHRleHRhcmVhLnN0eWxlLm1heEhlaWdodCA9IGAke21heEhlaWdodCAtIGFkanVzdGVkVmlld3BvcnRNYXJnaW5Cb3R0b219cHhgO1xyXG5cclxuXHJcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGV4dGFyZWEucGFyZW50RWxlbWVudDtcclxuICAgICAgICBpZiAoY29udGFpbmVyIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHtcclxuICAgICAgICAgICAgY29uc3QgY29udGFpbmVySGVpZ2h0ID0gY29udGFpbmVyLnN0eWxlLmhlaWdodDtcclxuICAgICAgICAgICAgY29udGFpbmVyLnN0eWxlLmhlaWdodCA9IGdldENvbXB1dGVkU3R5bGUoY29udGFpbmVyKS5oZWlnaHQ7XHJcbiAgICAgICAgICAgIHRleHRhcmVhLnN0eWxlLmhlaWdodCA9ICdhdXRvJztcclxuXHJcbiAgICAgICAgICAgIGxldCBoID0gdGV4dGFyZWEuc2Nyb2xsSGVpZ2h0ICsgYm9yZGVyQWRkT247XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm1pbkhlaWdodCA+IGgpIHtcclxuICAgICAgICAgICAgICAgIGggPSB0aGlzLm1pbkhlaWdodDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0ZXh0YXJlYS5zdHlsZS5oZWlnaHQgPSBgJHtofXB4YDtcclxuICAgICAgICAgICAgY29udGFpbmVyLnN0eWxlLmhlaWdodCA9IGNvbnRhaW5lckhlaWdodDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMucHJldmlvdXNWYWx1ZSA9IHRleHRhcmVhLnZhbHVlO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==