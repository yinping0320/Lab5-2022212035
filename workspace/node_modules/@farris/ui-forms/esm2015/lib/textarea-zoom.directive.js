/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { TextareaWordcountDirective } from './textarea-wordcount.directive';
import { NgControl } from '@angular/forms';
import { Directive, ElementRef, Renderer2, Injector, Input, Optional } from '@angular/core';
import { EventManager } from '@angular/platform-browser';
import { MessagerService } from '@farris/ui-messager';
import { LocaleService } from '@farris/ui-locale';
export class TextareaZoomDirective {
    /**
     * @param {?} el
     * @param {?} render
     * @param {?} injector
     * @param {?} wordCountRef
     */
    constructor(el, render, injector, wordCountRef) {
        this.el = el;
        this.render = render;
        this.injector = injector;
        this.wordCountRef = wordCountRef;
        this.useZoom = true;
        this.dialogWidth = 500;
        this.dialogHeight = 400;
        this.fullscreen = false;
        this.title = '';
        this.value = '';
        this.onMouseEnter = null;
        this.onMouseLeave = null;
        this.onClick = null;
        this.altEnterHandler = null;
        this.zoomButtonElement = null;
        this.messagerService = this.injector.get(MessagerService);
        this.eventManager = this.injector.get(EventManager);
        this.localeSer = this.injector.get(LocaleService, null);
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.ngControl = this.injector.get(NgControl, null);
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (changes.useZoom && !changes.useZoom.isFirstChange()) {
            if (this.useZoom) {
                this.createZoomButton();
            }
            else {
                this.destroy();
            }
        }
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        if (this.useZoom) {
            this.createZoomButton();
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.destroy();
    }
    /**
     * @private
     * @return {?}
     */
    destroy() {
        if (this.onMouseEnter) {
            this.onMouseEnter();
        }
        if (this.onMouseLeave) {
            this.onMouseLeave();
        }
        if (this.onClick) {
            this.onClick();
        }
        if (this.altEnterHandler) {
            this.altEnterHandler();
        }
        if (this.zoomButtonElement) {
            this.zoomButtonElement.remove();
        }
    }
    /**
     * @private
     * @return {?}
     */
    bindEventHandler() {
        this.altEnterHandler = this.eventManager.addEventListener(this.el.nativeElement, 'keydown.alt.enter', (/**
         * @param {?} event
         * @return {?}
         */
        (event) => {
            /** @type {?} */
            const target = ((/** @type {?} */ (event.target)));
            /** @type {?} */
            const val = target.value + '\n';
            target.value = val;
            event.preventDefault();
            event.stopPropagation();
            return false;
        }));
    }
    /**
     * @private
     * @return {?}
     */
    createZoombarID() {
        /** @type {?} */
        const tagName = this.el.nativeElement.tagName;
        if (this.ngControl) {
            /** @type {?} */
            const ctrlName = this.ngControl.name;
            return `${tagName}_ZOOMBAR_${ctrlName}`;
        }
        else {
            if (this.el.nativeElement.id) {
                return `${tagName}_ZOOMBAR_${this.el.nativeElement.id}`;
            }
        }
        return '';
    }
    /**
     * @private
     * @return {?}
     */
    createZoomButton() {
        /** @type {?} */
        const zoomSPAN = this.render.createElement('span');
        zoomSPAN.className = 'f-icon modal_maximize textarea-zoom';
        zoomSPAN.title = this.localeSer.getValue('text.zoom') || '点击后弹出进行编辑';
        /** @type {?} */
        const id = this.createZoombarID();
        if (id) {
            zoomSPAN.id = id;
        }
        this.render.setStyle(zoomSPAN, 'position', 'absolute');
        this.render.setStyle(zoomSPAN, 'top', '2px');
        const { width } = this.el.nativeElement.getBoundingClientRect();
        const { width: parentWidth } = this.el.nativeElement.parentElement.getBoundingClientRect();
        if (parentWidth !== width) {
            this.render.setStyle(zoomSPAN, 'left', `${width - 18}px`);
        }
        else {
            this.render.setStyle(zoomSPAN, 'right', '2px');
        }
        this.render.setStyle(zoomSPAN, 'cursor', 'pointer');
        this.el.nativeElement.after(zoomSPAN);
        this.zoomButtonElement = zoomSPAN;
        this.onMouseEnter = this.render.listen(zoomSPAN, 'mouseenter', (/**
         * @return {?}
         */
        () => {
            this.render.setStyle(zoomSPAN, 'fontSize', '22px');
        }));
        this.onMouseLeave = this.render.listen(zoomSPAN, 'mouseleave', (/**
         * @return {?}
         */
        () => {
            this.render.setStyle(zoomSPAN, 'fontSize', '1rem');
        }));
        this.onClick = this.render.listen(zoomSPAN, 'click', (/**
         * @return {?}
         */
        () => {
            this.zoomTextarea();
        }));
    }
    /**
     * @private
     * @return {?}
     */
    zoomTextarea() {
        /** @type {?} */
        const opts = {
            width: this.dialogWidth || 500,
            height: this.dialogHeight || 400,
            showFontSize: true,
            inputType: 'textarea',
            saveSize: true // 启用个性化存储，localStorage
        };
        if (window.localStorage) {
            /** @type {?} */
            const key = this.messagerService.getKeyString();
            /** @type {?} */
            const val = localStorage.getItem(key);
            if (val) {
                /** @type {?} */
                const lastSetting = JSON.parse(val);
                opts.fontSize = lastSetting.fontSize || 18;
                opts.width = lastSetting.width || opts.width;
                opts.height = lastSetting.height || opts.height;
            }
        }
        /** @type {?} */
        const tagName = this.el.nativeElement.tagName;
        /** @type {?} */
        let showText = this.el.nativeElement.value;
        if (this.ngControl) {
            showText = this.ngControl.value;
        }
        else {
            showText = this.el.nativeElement.value;
        }
        showText = this.value || showText;
        if (tagName === 'FARRIS-TEXT' || this.el.nativeElement.readOnly || this.el.nativeElement.disabled) {
            opts.readonly = true;
            opts.showOkButton = false;
            this.messagerService.prompt2(this.title, showText, opts).subscribe();
        }
        else {
            opts.maxLength = this.el.nativeElement.maxLength;
            opts.enableWordCount = this.wordCountRef ? this.wordCountRef.useWordCount : false;
            opts.countType = this.wordCountRef ? this.wordCountRef.countType : 'length';
            this.messagerService.prompt2(this.title, showText, opts).subscribe((/**
             * @param {?} v
             * @return {?}
             */
            v => {
                if (typeof v === 'boolean' && !v) {
                    return;
                }
                else {
                    this.ngControl.control.setValue(v);
                    if (this.wordCountRef) {
                        this.wordCountRef.updateWordsCount();
                    }
                }
            }));
        }
    }
}
TextareaZoomDirective.decorators = [
    { type: Directive, args: [{
                selector: '[textarea-zoom]',
            },] }
];
/** @nocollapse */
TextareaZoomDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: Injector },
    { type: TextareaWordcountDirective, decorators: [{ type: Optional }] }
];
TextareaZoomDirective.propDecorators = {
    useZoom: [{ type: Input, args: ['textarea-zoom',] }],
    dialogWidth: [{ type: Input }],
    dialogHeight: [{ type: Input }],
    fullscreen: [{ type: Input }],
    title: [{ type: Input }],
    value: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    TextareaZoomDirective.prototype.useZoom;
    /** @type {?} */
    TextareaZoomDirective.prototype.dialogWidth;
    /** @type {?} */
    TextareaZoomDirective.prototype.dialogHeight;
    /** @type {?} */
    TextareaZoomDirective.prototype.fullscreen;
    /** @type {?} */
    TextareaZoomDirective.prototype.title;
    /** @type {?} */
    TextareaZoomDirective.prototype.value;
    /** @type {?} */
    TextareaZoomDirective.prototype.onMouseEnter;
    /** @type {?} */
    TextareaZoomDirective.prototype.onMouseLeave;
    /** @type {?} */
    TextareaZoomDirective.prototype.onClick;
    /** @type {?} */
    TextareaZoomDirective.prototype.altEnterHandler;
    /** @type {?} */
    TextareaZoomDirective.prototype.zoomButtonElement;
    /**
     * @type {?}
     * @private
     */
    TextareaZoomDirective.prototype.messagerService;
    /**
     * @type {?}
     * @private
     */
    TextareaZoomDirective.prototype.eventManager;
    /**
     * @type {?}
     * @private
     */
    TextareaZoomDirective.prototype.ngControl;
    /**
     * @type {?}
     * @private
     */
    TextareaZoomDirective.prototype.localeSer;
    /**
     * @type {?}
     * @private
     */
    TextareaZoomDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    TextareaZoomDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    TextareaZoomDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    TextareaZoomDirective.prototype.wordCountRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dGFyZWEtem9vbS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWZvcm1zLyIsInNvdXJjZXMiOlsibGliL3RleHRhcmVhLXpvb20uZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUM1RSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBVSxLQUFLLEVBQ0YsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hHLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBSWxELE1BQU0sT0FBTyxxQkFBcUI7Ozs7Ozs7SUFrQjlCLFlBQW9CLEVBQWMsRUFBVSxNQUFpQixFQUFVLFFBQWtCLEVBQ3pELFlBQXdDO1FBRHBELE9BQUUsR0FBRixFQUFFLENBQVk7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUN6RCxpQkFBWSxHQUFaLFlBQVksQ0FBNEI7UUFsQmhELFlBQU8sR0FBRyxJQUFJLENBQUM7UUFDOUIsZ0JBQVcsR0FBRyxHQUFHLENBQUM7UUFDbEIsaUJBQVksR0FBRyxHQUFHLENBQUM7UUFDbkIsZUFBVSxHQUFHLEtBQUssQ0FBQztRQUNuQixVQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ1gsVUFBSyxHQUFHLEVBQUUsQ0FBQztRQUVwQixpQkFBWSxHQUFHLElBQUksQ0FBQztRQUNwQixpQkFBWSxHQUFHLElBQUksQ0FBQztRQUNwQixZQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ2Ysb0JBQWUs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OztJQUM1QixzQ0FBb0I7O0lBQ3BCLHNDQUFvQjs7SUFFcEIsNkNBQW9COztJQUNwQiw2Q0FBb0I7O0lBQ3BCLHdDQUFlOztJQUNmLGdEQUF1Qjs7SUFFdkIsa0RBQXlCOzs7OztJQUN6QixnREFBeUM7Ozs7O0lBQ3pDLDZDQUFtQzs7Ozs7SUFDbkMsMENBQTZCOzs7OztJQUM3QiwwQ0FBZ0M7Ozs7O0lBQ3BCLG1DQUFzQjs7Ozs7SUFBRSx1Q0FBeUI7Ozs7O0lBQUUseUNBQTBCOzs7OztJQUM3RSw2Q0FBNEQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXh0YXJlYVdvcmRjb3VudERpcmVjdGl2ZSB9IGZyb20gJy4vdGV4dGFyZWEtd29yZGNvdW50LmRpcmVjdGl2ZSc7XHJcbmltcG9ydCB7IE5nQ29udHJvbCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcclxuaW1wb3J0IHsgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBSZW5kZXJlcjIsIEluamVjdG9yLCBPbkluaXQsIElucHV0LFxyXG4gICAgICAgICAgICBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3ksIE9uQ2hhbmdlcywgU2ltcGxlQ2hhbmdlcywgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRXZlbnRNYW5hZ2VyIH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlcic7XHJcbmltcG9ydCB7IE1lc3NhZ2VyU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbWVzc2FnZXInO1xyXG5pbXBvcnQgeyBMb2NhbGVTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1sb2NhbGUnO1xyXG5ARGlyZWN0aXZlKHtcclxuICAgIHNlbGVjdG9yOiAnW3RleHRhcmVhLXpvb21dJyxcclxufSlcclxuZXhwb3J0IGNsYXNzIFRleHRhcmVhWm9vbURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95LCBPbkNoYW5nZXMge1xyXG4gICAgQElucHV0KCd0ZXh0YXJlYS16b29tJykgdXNlWm9vbSA9IHRydWU7XHJcbiAgICBASW5wdXQoKSBkaWFsb2dXaWR0aCA9IDUwMDtcclxuICAgIEBJbnB1dCgpIGRpYWxvZ0hlaWdodCA9IDQwMDtcclxuICAgIEBJbnB1dCgpIGZ1bGxzY3JlZW4gPSBmYWxzZTtcclxuICAgIEBJbnB1dCgpIHRpdGxlID0gJyc7XHJcbiAgICBASW5wdXQoKSB2YWx1ZSA9ICcnO1xyXG5cclxuICAgIG9uTW91c2VFbnRlciA9IG51bGw7XHJcbiAgICBvbk1vdXNlTGVhdmUgPSBudWxsO1xyXG4gICAgb25DbGljayA9IG51bGw7XHJcbiAgICBhbHRFbnRlckhhbmRsZXIgPSBudWxsO1xyXG5cclxuICAgIHpvb21CdXR0b25FbGVtZW50ID0gbnVsbDtcclxuICAgIHByaXZhdGUgbWVzc2FnZXJTZXJ2aWNlOiBNZXNzYWdlclNlcnZpY2U7XHJcbiAgICBwcml2YXRlIGV2ZW50TWFuYWdlcjogRXZlbnRNYW5hZ2VyO1xyXG4gICAgcHJpdmF0ZSBuZ0NvbnRyb2w6IE5nQ29udHJvbDtcclxuICAgIHByaXZhdGUgbG9jYWxlU2VyOiBMb2NhbGVTZXJ2aWNlXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsOiBFbGVtZW50UmVmLCBwcml2YXRlIHJlbmRlcjogUmVuZGVyZXIyLCBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcixcclxuICAgICAgICAgICAgICAgIEBPcHRpb25hbCgpIHByaXZhdGUgd29yZENvdW50UmVmOiBUZXh0YXJlYVdvcmRjb3VudERpcmVjdGl2ZSApIHtcclxuICAgICAgICB0aGlzLm1lc3NhZ2VyU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KE1lc3NhZ2VyU2VydmljZSk7XHJcbiAgICAgICAgdGhpcy5ldmVudE1hbmFnZXIgPSB0aGlzLmluamVjdG9yLmdldChFdmVudE1hbmFnZXIpO1xyXG4gICAgICAgIHRoaXMubG9jYWxlU2VyID0gdGhpcy5pbmplY3Rvci5nZXQoTG9jYWxlU2VydmljZSwgbnVsbCk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKSB7XHJcbiAgICAgICAgdGhpcy5uZ0NvbnRyb2wgPSB0aGlzLmluamVjdG9yLmdldChOZ0NvbnRyb2wsIG51bGwpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcclxuICAgICAgICBpZiAoY2hhbmdlcy51c2Vab29tICYmICFjaGFuZ2VzLnVzZVpvb20uaXNGaXJzdENoYW5nZSgpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnVzZVpvb20pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlWm9vbUJ1dHRvbigpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdJbml0KCkge1xyXG4gICAgICAgIGlmICh0aGlzLnVzZVpvb20pIHtcclxuICAgICAgICAgICAgdGhpcy5jcmVhdGVab29tQnV0dG9uKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCkge1xyXG4gICAgICAgIHRoaXMuZGVzdHJveSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZGVzdHJveSgpIHtcclxuICAgICAgICBpZiAodGhpcy5vbk1vdXNlRW50ZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5vbk1vdXNlRW50ZXIoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMub25Nb3VzZUxlYXZlKSB7XHJcbiAgICAgICAgICAgIHRoaXMub25Nb3VzZUxlYXZlKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5vbkNsaWNrKSB7XHJcbiAgICAgICAgICAgIHRoaXMub25DbGljaygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5hbHRFbnRlckhhbmRsZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5hbHRFbnRlckhhbmRsZXIoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnpvb21CdXR0b25FbGVtZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMuem9vbUJ1dHRvbkVsZW1lbnQucmVtb3ZlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYmluZEV2ZW50SGFuZGxlcigpIHtcclxuICAgICAgICB0aGlzLmFsdEVudGVySGFuZGxlciA9IHRoaXMuZXZlbnRNYW5hZ2VyLmFkZEV2ZW50TGlzdGVuZXIodGhpcy5lbC5uYXRpdmVFbGVtZW50LCAna2V5ZG93bi5hbHQuZW50ZXInLFxyXG4gICAgICAgIChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0YXJnZXQgPSAoZXZlbnQudGFyZ2V0IGFzIGFueSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbCA9IHRhcmdldC52YWx1ZSArICdcXG4nO1xyXG4gICAgICAgICAgICB0YXJnZXQudmFsdWUgPSB2YWw7XHJcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjcmVhdGVab29tYmFySUQoKSB7XHJcbiAgICAgICAgY29uc3QgdGFnTmFtZSA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC50YWdOYW1lO1xyXG4gICAgICAgIGlmICh0aGlzLm5nQ29udHJvbCkge1xyXG4gICAgICAgICAgICBjb25zdCBjdHJsTmFtZSA9IHRoaXMubmdDb250cm9sLm5hbWU7XHJcbiAgICAgICAgICAgIHJldHVybiBgJHt0YWdOYW1lfV9aT09NQkFSXyR7Y3RybE5hbWV9YDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5lbC5uYXRpdmVFbGVtZW50LmlkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYCR7dGFnTmFtZX1fWk9PTUJBUl8ke3RoaXMuZWwubmF0aXZlRWxlbWVudC5pZH1gO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNyZWF0ZVpvb21CdXR0b24oKSB7XHJcbiAgICAgICAgY29uc3Qgem9vbVNQQU4gPSB0aGlzLnJlbmRlci5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XHJcbiAgICAgICAgem9vbVNQQU4uY2xhc3NOYW1lID0gJ2YtaWNvbiBtb2RhbF9tYXhpbWl6ZSB0ZXh0YXJlYS16b29tJztcclxuICAgICAgICB6b29tU1BBTi50aXRsZSA9ICB0aGlzLmxvY2FsZVNlci5nZXRWYWx1ZSgndGV4dC56b29tJykgfHwgJ+eCueWHu+WQjuW8ueWHuui/m+ihjOe8lui+kSc7XHJcblxyXG4gICAgICAgIFxyXG5cclxuICAgICAgICBjb25zdCBpZCA9IHRoaXMuY3JlYXRlWm9vbWJhcklEKCk7XHJcbiAgICAgICAgaWYgKGlkKSB7XHJcbiAgICAgICAgICAgIHpvb21TUEFOLmlkID0gaWQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZSh6b29tU1BBTiwgJ3Bvc2l0aW9uJywgJ2Fic29sdXRlJyk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUoem9vbVNQQU4sICd0b3AnLCAnMnB4Jyk7XHJcblxyXG4gICAgICAgIGNvbnN0IHsgd2lkdGggfSA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICBjb25zdCB7IHdpZHRoOiBwYXJlbnRXaWR0aCB9ID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50LnBhcmVudEVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgaWYgKHBhcmVudFdpZHRoICE9PSB3aWR0aCkge1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZSh6b29tU1BBTiwgJ2xlZnQnLCBgJHt3aWR0aCAtIDE4fXB4YCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUoem9vbVNQQU4sICdyaWdodCcsICcycHgnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUoem9vbVNQQU4sICdjdXJzb3InLCAncG9pbnRlcicpO1xyXG5cclxuICAgICAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuYWZ0ZXIoem9vbVNQQU4pO1xyXG5cclxuICAgICAgICB0aGlzLnpvb21CdXR0b25FbGVtZW50ID0gem9vbVNQQU47XHJcblxyXG4gICAgICAgIHRoaXMub25Nb3VzZUVudGVyID0gdGhpcy5yZW5kZXIubGlzdGVuKHpvb21TUEFOLCAnbW91c2VlbnRlcicsICgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUoem9vbVNQQU4sICdmb250U2l6ZScsICcyMnB4Jyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5vbk1vdXNlTGVhdmUgPSB0aGlzLnJlbmRlci5saXN0ZW4oem9vbVNQQU4sICdtb3VzZWxlYXZlJywgKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZSh6b29tU1BBTiwgJ2ZvbnRTaXplJywgJzFyZW0nKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5vbkNsaWNrID0gdGhpcy5yZW5kZXIubGlzdGVuKHpvb21TUEFOLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuem9vbVRleHRhcmVhKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB6b29tVGV4dGFyZWEoKSB7XHJcbiAgICAgICAgY29uc3Qgb3B0czogYW55ID0ge1xyXG4gICAgICAgICAgICB3aWR0aDogdGhpcy5kaWFsb2dXaWR0aCB8fCA1MDAsXHJcbiAgICAgICAgICAgIGhlaWdodDogdGhpcy5kaWFsb2dIZWlnaHQgfHwgNDAwLFxyXG4gICAgICAgICAgICBzaG93Rm9udFNpemU6IHRydWUsXHJcbiAgICAgICAgICAgIGlucHV0VHlwZTogJ3RleHRhcmVhJyxcclxuICAgICAgICAgICAgc2F2ZVNpemU6IHRydWUgICAgLy8g5ZCv55So5Liq5oCn5YyW5a2Y5YKo77yMbG9jYWxTdG9yYWdlXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaWYgKHdpbmRvdy5sb2NhbFN0b3JhZ2UpIHtcclxuICAgICAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5tZXNzYWdlclNlcnZpY2UuZ2V0S2V5U3RyaW5nKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSk7XHJcbiAgICAgICAgICAgIGlmICh2YWwpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxhc3RTZXR0aW5nID0gSlNPTi5wYXJzZSh2YWwpO1xyXG4gICAgICAgICAgICAgICAgb3B0cy5mb250U2l6ZSA9IGxhc3RTZXR0aW5nLmZvbnRTaXplIHx8IDE4O1xyXG4gICAgICAgICAgICAgICAgb3B0cy53aWR0aCA9IGxhc3RTZXR0aW5nLndpZHRoIHx8IG9wdHMud2lkdGg7XHJcbiAgICAgICAgICAgICAgICBvcHRzLmhlaWdodCA9IGxhc3RTZXR0aW5nLmhlaWdodCB8fCBvcHRzLmhlaWdodDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgdGFnTmFtZSA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC50YWdOYW1lO1xyXG4gICAgICAgIGxldCBzaG93VGV4dCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC52YWx1ZTtcclxuICAgICAgICBpZiAodGhpcy5uZ0NvbnRyb2wpIHtcclxuICAgICAgICAgICAgc2hvd1RleHQgPSB0aGlzLm5nQ29udHJvbC52YWx1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzaG93VGV4dCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC52YWx1ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHNob3dUZXh0ID0gdGhpcy52YWx1ZSB8fCBzaG93VGV4dDtcclxuXHJcblxyXG4gICAgICAgIGlmICh0YWdOYW1lID09PSAnRkFSUklTLVRFWFQnIHx8IHRoaXMuZWwubmF0aXZlRWxlbWVudC5yZWFkT25seSB8fCB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuZGlzYWJsZWQpIHtcclxuICAgICAgICAgICAgb3B0cy5yZWFkb25seSA9IHRydWU7XHJcbiAgICAgICAgICAgIG9wdHMuc2hvd09rQnV0dG9uID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHRoaXMubWVzc2FnZXJTZXJ2aWNlLnByb21wdDIodGhpcy50aXRsZSwgc2hvd1RleHQsIG9wdHMpLnN1YnNjcmliZSgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIG9wdHMubWF4TGVuZ3RoID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50Lm1heExlbmd0aDtcclxuICAgICAgICAgICAgb3B0cy5lbmFibGVXb3JkQ291bnQgPSB0aGlzLndvcmRDb3VudFJlZiA/IHRoaXMud29yZENvdW50UmVmLnVzZVdvcmRDb3VudCA6IGZhbHNlO1xyXG4gICAgICAgICAgICBvcHRzLmNvdW50VHlwZSA9IHRoaXMud29yZENvdW50UmVmID8gdGhpcy53b3JkQ291bnRSZWYuY291bnRUeXBlIDogJ2xlbmd0aCc7XHJcbiAgICAgICAgICAgIHRoaXMubWVzc2FnZXJTZXJ2aWNlLnByb21wdDIodGhpcy50aXRsZSwgc2hvd1RleHQsIG9wdHMpLnN1YnNjcmliZSh2ID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gJ2Jvb2xlYW4nICYmICF2KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm5nQ29udHJvbC5jb250cm9sLnNldFZhbHVlKHYpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLndvcmRDb3VudFJlZikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLndvcmRDb3VudFJlZi51cGRhdGVXb3Jkc0NvdW50KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==