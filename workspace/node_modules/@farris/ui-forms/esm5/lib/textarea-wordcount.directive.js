/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, ElementRef, Injector, Input, Renderer2 } from '@angular/core';
import { NgControl } from '@angular/forms';
import { LocaleService } from '@farris/ui-locale';
import { EventManager } from '@angular/platform-browser';
import ResizeObserver from 'resize-observer-polyfill';
var TextareaWordcountDirective = /** @class */ (function () {
    function TextareaWordcountDirective(el, render, injector) {
        this.el = el;
        this.render = render;
        this.injector = injector;
        this.useWordCount = true;
        /**
         * 统计字数的方式； surplus 剩余可输入字数; length: 当前已输入字数；
         *
         * 默认为 surplus
         */
        this.countType = 'surplus';
        this.onlyShowInDialog = false;
        this.wordCountElement = null;
        // 当前字数
        this.currentLengthElement = null;
        this.onInput = null;
        this.ro = null;
        this.eventManager = this.injector.get(EventManager);
        this.localeSer = this.injector.get(LocaleService);
    }
    /**
     * @return {?}
     */
    TextareaWordcountDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.ngControl = this.injector.get(NgControl, null);
    };
    /**
     * @return {?}
     */
    TextareaWordcountDirective.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.initWordCount();
        if (this.ngControl && this.useWordCount) {
            this.ngControl.control.valueChanges.subscribe((/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                _this.updateWordsCount();
            }));
        }
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    TextareaWordcountDirective.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        if (changes.useWordCount && !changes.useWordCount.isFirstChange()) {
            if (this.useWordCount) {
                this.initWordCount();
            }
            else {
                this.destroy();
            }
        }
    };
    /**
     * @return {?}
     */
    TextareaWordcountDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.destroy();
        if (this.ro) {
            this.ro.disconnect();
            this.ro.unobserve(this.el.nativeElement.parentElement);
        }
    };
    /**
     * @private
     * @return {?}
     */
    TextareaWordcountDirective.prototype.destroy = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.onInput) {
            this.onInput();
        }
        if (this.wordCountElement) {
            this.wordCountElement.remove();
        }
    };
    /**
     * @return {?}
     */
    TextareaWordcountDirective.prototype.initWordCount = /**
     * @return {?}
     */
    function () {
        if (this.useWordCount && !this.onlyShowInDialog) {
            this.createWordCountElement();
        }
    };
    /**
     * @private
     * @return {?}
     */
    TextareaWordcountDirective.prototype.createWordCountID = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var tagName = this.el.nativeElement.tagName;
        if (this.ngControl) {
            /** @type {?} */
            var ctrlName = this.ngControl.name;
            return tagName + "_WORDCOUNT_" + ctrlName;
        }
        else {
            if (this.el.nativeElement.id) {
                return tagName + "_WORDCOUNT_" + this.el.nativeElement.id;
            }
        }
        return '';
    };
    /**
     * @private
     * @return {?}
     */
    TextareaWordcountDirective.prototype.createWordCountElement = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var max = this.el.nativeElement.maxLength;
        if (!max || max < 0) {
            // console.info('未设置最大字符数，计数功能失效。');
            return;
        }
        /** @type {?} */
        var wordCountSPAN = this.render.createElement('span');
        wordCountSPAN.className = 'textarea-wordcount';
        /** @type {?} */
        var id = this.createWordCountID();
        if (id) {
            wordCountSPAN.id = id;
        }
        this.render.setStyle(wordCountSPAN, 'position', 'absolute');
        this.render.setStyle(wordCountSPAN, 'bottom', '0px');
        var _a = this.el.nativeElement.getBoundingClientRect(), width = _a.width, right = _a.right;
        var parentWidth = this.el.nativeElement.parentElement.getBoundingClientRect().width;
        if (parentWidth !== width) {
            this.render.setStyle(wordCountSPAN, 'right', parentWidth - width + 10 + "px");
            this.ro = new ResizeObserver((/**
             * @param {?} entries
             * @param {?} observer
             * @return {?}
             */
            function (entries, observer) {
                if (entries && entries[0]) {
                    /** @type {?} */
                    var _pw = entries[0].contentRect.width;
                    _this.render.setStyle(wordCountSPAN, 'right', _pw - width + 10 + "px");
                }
            }));
            this.ro.observe(this.el.nativeElement.parentElement);
        }
        else {
            this.render.setStyle(wordCountSPAN, 'right', '10px');
        }
        this.render.setStyle(wordCountSPAN, 'cursor', 'pointer');
        this.el.nativeElement.after(wordCountSPAN);
        this.wordCountElement = wordCountSPAN;
        /** @type {?} */
        var currentLengthSPAN = this.render.createElement('span');
        wordCountSPAN.appendChild(currentLengthSPAN);
        this.currentLengthElement = currentLengthSPAN;
        currentLengthSPAN.after(" / " + max);
        this.updateWordsCount();
        this.onInput = this.render.listen(this.el.nativeElement, 'input', (/**
         * @return {?}
         */
        function () {
            // value.replace(/\n|\r/gi, '') // 移除换行符
            _this.updateWordsCount();
        }));
    };
    /**
     * @return {?}
     */
    TextareaWordcountDirective.prototype.updateWordsCount = /**
     * @return {?}
     */
    function () {
        if (!this.useWordCount || !this.currentLengthElement) {
            return;
        }
        /** @type {?} */
        var max = this.el.nativeElement.maxLength;
        /** @type {?} */
        var val = this.countType === 'surplus' ? max - this.el.nativeElement.value.length : this.el.nativeElement.value.length;
        /** @type {?} */
        var tip = 'messager.prompt.tips.' + this.countType;
        this.currentLengthElement.innerText = val;
        this.wordCountElement.title = this.localeSer.getValue(tip).replace('{0}', val);
    };
    TextareaWordcountDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[word-count]',
                    exportAs: 'WordCountRef'
                },] }
    ];
    /** @nocollapse */
    TextareaWordcountDirective.ctorParameters = function () { return [
        { type: ElementRef },
        { type: Renderer2 },
        { type: Injector }
    ]; };
    TextareaWordcountDirective.propDecorators = {
        useWordCount: [{ type: Input, args: ['word-count',] }],
        countType: [{ type: Input }],
        onlyShowInDialog: [{ type: Input }]
    };
    return TextareaWordcountDirective;
}());
export { TextareaWordcountDirective };
if (false) {
    /** @type {?} */
    TextareaWordcountDirective.prototype.useWordCount;
    /**
     * 统计字数的方式； surplus 剩余可输入字数; length: 当前已输入字数；
     *
     * 默认为 surplus
     * @type {?}
     */
    TextareaWordcountDirective.prototype.countType;
    /** @type {?} */
    TextareaWordcountDirective.prototype.onlyShowInDialog;
    /** @type {?} */
    TextareaWordcountDirective.prototype.wordCountElement;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.currentLengthElement;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.eventManager;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.ngControl;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.onInput;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.localeSer;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.ro;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dGFyZWEtd29yZGNvdW50LmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZm9ybXMvIiwic291cmNlcyI6WyJsaWIvdGV4dGFyZWEtd29yZGNvdW50LmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQ00sTUFBTSxlQUFlLENBQUM7QUFDdEYsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDekQsT0FBTyxjQUFjLE1BQU0sMEJBQTBCLENBQUM7QUFDdEQ7SUF1Qkksb0NBQW9CLEVBQWMsRUFBVSxNQUFpQixFQUFVLFFBQWtCO1FBQXJFLE9BQUUsR0FBRixFQUFFLENBQVk7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQWxCcEUsaUJBQVksR0FBRyxJQUFJLENBQUM7Ozs7OztRQU1oQyxjQUFTLEdBQXlCLFNBQVMsQ0FBQztRQUU1QyxxQkFBZ0IsR0FBRyxLQUFLLENBQUM7UUFFbEMscUJBQWdCLEdBQUcsSUFBSSxDQUFDOztRQUVoQix5QkFBb0IsR0FBRyxJQUFJLENBQUM7UUFHNUIsWUFBTyxHQUFHLElBQUksQ0FBQztRQUVmLE9BQUUsR0FBbUIsSUFBSSxDQUFDO1FBRTlCLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDcEQsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUN0RCxDQUFDOzs7O0lBRUQsNkNBQVE7OztJQUFSO1FBQ0ksSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDeEQsQ0FBQzs7OztJQUVELG9EQUFlOzs7SUFBZjtRQUFBLGlCQU9DO1FBTkcsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3JCLElBQUksSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3JDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxTQUFTOzs7O1lBQUMsVUFBQyxDQUFDO2dCQUM1QyxLQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUM1QixDQUFDLEVBQUMsQ0FBQztTQUNOO0lBQ0wsQ0FBQzs7Ozs7SUFFRCxnREFBVzs7OztJQUFYLFVBQVksT0FBc0I7UUFFOUIsSUFBSSxPQUFPLENBQUMsWUFBWSxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxhQUFhLEVBQUUsRUFBRTtZQUMvRCxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7Z0JBQ25CLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQzthQUN4QjtpQkFBTTtnQkFDSCxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7YUFDbEI7U0FDSjtJQUNMLENBQUM7Ozs7SUFFRCxnREFBVzs7O0lBQVg7UUFDSSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFZixJQUFHLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDUixJQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ3JCLElBQUksQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQzFEO0lBQ0wsQ0FBQzs7Ozs7SUFHTyw0Q0FBTzs7OztJQUFmO1FBQ0ksSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ2QsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ2xCO1FBRUQsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDdkIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQ2xDO0lBQ0wsQ0FBQzs7OztJQUVELGtEQUFhOzs7SUFBYjtRQUNJLElBQUksSUFBSSxDQUFDLFlBQVksSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtZQUM3QyxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztTQUNqQztJQUNMLENBQUM7Ozs7O0lBRU8sc0RBQWlCOzs7O0lBQXpCOztZQUNVLE9BQU8sR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxPQUFPO1FBQzdDLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTs7Z0JBQ1YsUUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSTtZQUNwQyxPQUFVLE9BQU8sbUJBQWMsUUFBVSxDQUFDO1NBQzdDO2FBQU07WUFDSCxJQUFJLElBQUksQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLEVBQUUsRUFBRTtnQkFDMUIsT0FBVSxPQUFPLG1CQUFjLElBQUksQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLEVBQUksQ0FBQzthQUM3RDtTQUNKO1FBQ0QsT0FBTyxFQUFFLENBQUM7SUFDZCxDQUFDOzs7OztJQUVPLDJEQUFzQjs7OztJQUE5QjtRQUFBLGlCQWtEQzs7WUFqRFMsR0FBRyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLFNBQVM7UUFDM0MsSUFBSSxDQUFDLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQyxFQUFFO1lBQ2pCLG9DQUFvQztZQUNwQyxPQUFPO1NBQ1Y7O1lBRUssYUFBYSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQztRQUN2RCxhQUFhLENBQUMsU0FBUyxHQUFHLG9CQUFvQixDQUFDOztZQUV6QyxFQUFFLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixFQUFFO1FBQ25DLElBQUksRUFBRSxFQUFFO1lBQ0osYUFBYSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7U0FDekI7UUFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxhQUFhLEVBQUUsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQzVELElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFL0MsSUFBQSxrREFBZ0UsRUFBOUQsZ0JBQUssRUFBRSxnQkFBdUQ7UUFDOUQsSUFBQSwrRUFBa0I7UUFDMUIsSUFBSSxXQUFXLEtBQUssS0FBSyxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxPQUFPLEVBQUssV0FBVyxHQUFHLEtBQUssR0FBRyxFQUFFLE9BQUksQ0FBQyxDQUFDO1lBRTlFLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxjQUFjOzs7OztZQUFDLFVBQUMsT0FBTyxFQUFFLFFBQVE7Z0JBQzNDLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRTs7d0JBQ2pCLEdBQUcsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLEtBQUs7b0JBRXhDLEtBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxPQUFPLEVBQUssR0FBRyxHQUFHLEtBQUssR0FBRyxFQUFFLE9BQUksQ0FBQyxDQUFDO2lCQUN6RTtZQUNMLENBQUMsRUFBQyxDQUFDO1lBQ0gsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUM7U0FFeEQ7YUFBTTtZQUNILElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7U0FDeEQ7UUFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxhQUFhLEVBQUUsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBRXpELElBQUksQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUMzQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsYUFBYSxDQUFDOztZQUVoQyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUM7UUFDM0QsYUFBYSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQzdDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxpQkFBaUIsQ0FBQztRQUM5QyxpQkFBaUIsQ0FBQyxLQUFLLENBQUUsUUFBTSxHQUFLLENBQUUsQ0FBQztRQUV2QyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsYUFBYSxFQUFFLE9BQU87OztRQUFFO1lBQzlELHdDQUF3QztZQUN4QyxLQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUM1QixDQUFDLEVBQUMsQ0FBQztJQUNQLENBQUM7Ozs7SUFFRCxxREFBZ0I7OztJQUFoQjtRQUNJLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixFQUFFO1lBQ2xELE9BQU87U0FDVjs7WUFDSyxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsU0FBUzs7WUFDckMsR0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLE1BQU07O1lBQ2xILEdBQUcsR0FBRyx1QkFBdUIsR0FBRyxJQUFJLENBQUMsU0FBUztRQUVwRCxJQUFJLENBQUMsb0JBQW9CLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQztRQUMxQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDbkYsQ0FBQzs7Z0JBekpKLFNBQVMsU0FBQztvQkFDUCxRQUFRLEVBQUUsY0FBYztvQkFDeEIsUUFBUSxFQUFFLGNBQWM7aUJBQzNCOzs7O2dCQVRtQixVQUFVO2dCQUFtQixTQUFTO2dCQUExQixRQUFROzs7K0JBV25DLEtBQUssU0FBQyxZQUFZOzRCQU1sQixLQUFLO21DQUVMLEtBQUs7O0lBNklWLGlDQUFDO0NBQUEsQUExSkQsSUEwSkM7U0F0SlksMEJBQTBCOzs7SUFDbkMsa0RBQXlDOzs7Ozs7O0lBTXpDLCtDQUFxRDs7SUFFckQsc0RBQWtDOztJQUVsQyxzREFBd0I7Ozs7O0lBRXhCLDBEQUFvQzs7Ozs7SUFDcEMsa0RBQW1DOzs7OztJQUNuQywrQ0FBNkI7Ozs7O0lBQzdCLDZDQUF1Qjs7Ozs7SUFDdkIsK0NBQWlDOzs7OztJQUNqQyx3Q0FBa0M7Ozs7O0lBQ3RCLHdDQUFzQjs7Ozs7SUFBRSw0Q0FBeUI7Ozs7O0lBQUUsOENBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBJbmplY3RvciwgSW5wdXQsIFJlbmRlcmVyMixcclxuICAgIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95LCBPbkNoYW5nZXMsIFNpbXBsZUNoYW5nZXMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTmdDb250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQgeyBMb2NhbGVTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1sb2NhbGUnO1xyXG5pbXBvcnQgeyBFdmVudE1hbmFnZXIgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcclxuaW1wb3J0IFJlc2l6ZU9ic2VydmVyIGZyb20gJ3Jlc2l6ZS1vYnNlcnZlci1wb2x5ZmlsbCc7XHJcbkBEaXJlY3RpdmUoe1xyXG4gICAgc2VsZWN0b3I6ICdbd29yZC1jb3VudF0nLFxyXG4gICAgZXhwb3J0QXM6ICdXb3JkQ291bnRSZWYnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBUZXh0YXJlYVdvcmRjb3VudERpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95LCBPbkNoYW5nZXMge1xyXG4gICAgQElucHV0KCd3b3JkLWNvdW50JykgdXNlV29yZENvdW50ID0gdHJ1ZTtcclxuICAgIC8qKlxyXG4gICAgICog57uf6K6h5a2X5pWw55qE5pa55byP77ybIHN1cnBsdXMg5Ymp5L2Z5Y+v6L6T5YWl5a2X5pWwOyBsZW5ndGg6IOW9k+WJjeW3sui+k+WFpeWtl+aVsO+8m1xyXG4gICAgICpcclxuICAgICAqIOm7mOiupOS4uiBzdXJwbHVzXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIGNvdW50VHlwZTogJ3N1cnBsdXMnIHwgJ2xlbmd0aCcgPSAnc3VycGx1cyc7XHJcblxyXG4gICAgQElucHV0KCkgb25seVNob3dJbkRpYWxvZyA9IGZhbHNlO1xyXG5cclxuICAgIHdvcmRDb3VudEVsZW1lbnQgPSBudWxsO1xyXG4gICAgLy8g5b2T5YmN5a2X5pWwXHJcbiAgICBwcml2YXRlIGN1cnJlbnRMZW5ndGhFbGVtZW50ID0gbnVsbDtcclxuICAgIHByaXZhdGUgZXZlbnRNYW5hZ2VyOiBFdmVudE1hbmFnZXI7XHJcbiAgICBwcml2YXRlIG5nQ29udHJvbDogTmdDb250cm9sO1xyXG4gICAgcHJpdmF0ZSBvbklucHV0ID0gbnVsbDtcclxuICAgIHByaXZhdGUgbG9jYWxlU2VyOiBMb2NhbGVTZXJ2aWNlO1xyXG4gICAgcHJpdmF0ZSBybzogUmVzaXplT2JzZXJ2ZXIgPSBudWxsO1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBlbDogRWxlbWVudFJlZiwgcHJpdmF0ZSByZW5kZXI6IFJlbmRlcmVyMiwgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuICAgICAgICB0aGlzLmV2ZW50TWFuYWdlciA9IHRoaXMuaW5qZWN0b3IuZ2V0KEV2ZW50TWFuYWdlcik7XHJcbiAgICAgICAgdGhpcy5sb2NhbGVTZXIgPSB0aGlzLmluamVjdG9yLmdldChMb2NhbGVTZXJ2aWNlKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uSW5pdCgpIHtcclxuICAgICAgICB0aGlzLm5nQ29udHJvbCA9IHRoaXMuaW5qZWN0b3IuZ2V0KE5nQ29udHJvbCwgbnVsbCk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdJbml0KCkge1xyXG4gICAgICAgIHRoaXMuaW5pdFdvcmRDb3VudCgpO1xyXG4gICAgICAgIGlmICh0aGlzLm5nQ29udHJvbCAmJiB0aGlzLnVzZVdvcmRDb3VudCkge1xyXG4gICAgICAgICAgICB0aGlzLm5nQ29udHJvbC5jb250cm9sLnZhbHVlQ2hhbmdlcy5zdWJzY3JpYmUoKGUpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlV29yZHNDb3VudCgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG5cclxuICAgICAgICBpZiAoY2hhbmdlcy51c2VXb3JkQ291bnQgJiYgIWNoYW5nZXMudXNlV29yZENvdW50LmlzRmlyc3RDaGFuZ2UoKSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy51c2VXb3JkQ291bnQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5pdFdvcmRDb3VudCgpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICAgICAgdGhpcy5kZXN0cm95KCk7XHJcblxyXG4gICAgICAgIGlmKHRoaXMucm8pIHtcclxuICAgICAgICAgICAgdGhpcy5yby5kaXNjb25uZWN0KCk7XHJcbiAgICAgICAgICAgIHRoaXMucm8udW5vYnNlcnZlKHRoaXMuZWwubmF0aXZlRWxlbWVudC5wYXJlbnRFbGVtZW50KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgZGVzdHJveSgpIHtcclxuICAgICAgICBpZiAodGhpcy5vbklucHV0KSB7XHJcbiAgICAgICAgICAgIHRoaXMub25JbnB1dCgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMud29yZENvdW50RWxlbWVudCkge1xyXG4gICAgICAgICAgICB0aGlzLndvcmRDb3VudEVsZW1lbnQucmVtb3ZlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGluaXRXb3JkQ291bnQoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMudXNlV29yZENvdW50ICYmICF0aGlzLm9ubHlTaG93SW5EaWFsb2cpIHtcclxuICAgICAgICAgICAgdGhpcy5jcmVhdGVXb3JkQ291bnRFbGVtZW50KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY3JlYXRlV29yZENvdW50SUQoKSB7XHJcbiAgICAgICAgY29uc3QgdGFnTmFtZSA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC50YWdOYW1lO1xyXG4gICAgICAgIGlmICh0aGlzLm5nQ29udHJvbCkge1xyXG4gICAgICAgICAgICBjb25zdCBjdHJsTmFtZSA9IHRoaXMubmdDb250cm9sLm5hbWU7XHJcbiAgICAgICAgICAgIHJldHVybiBgJHt0YWdOYW1lfV9XT1JEQ09VTlRfJHtjdHJsTmFtZX1gO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuaWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBgJHt0YWdOYW1lfV9XT1JEQ09VTlRfJHt0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuaWR9YDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjcmVhdGVXb3JkQ291bnRFbGVtZW50KCkge1xyXG4gICAgICAgIGNvbnN0IG1heCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC5tYXhMZW5ndGg7XHJcbiAgICAgICAgaWYgKCFtYXggfHwgbWF4IDwgMCkge1xyXG4gICAgICAgICAgICAvLyBjb25zb2xlLmluZm8oJ+acquiuvue9ruacgOWkp+Wtl+espuaVsO+8jOiuoeaVsOWKn+iDveWkseaViOOAgicpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB3b3JkQ291bnRTUEFOID0gdGhpcy5yZW5kZXIuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xyXG4gICAgICAgIHdvcmRDb3VudFNQQU4uY2xhc3NOYW1lID0gJ3RleHRhcmVhLXdvcmRjb3VudCc7XHJcblxyXG4gICAgICAgIGNvbnN0IGlkID0gdGhpcy5jcmVhdGVXb3JkQ291bnRJRCgpO1xyXG4gICAgICAgIGlmIChpZCkge1xyXG4gICAgICAgICAgICB3b3JkQ291bnRTUEFOLmlkID0gaWQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZSh3b3JkQ291bnRTUEFOLCAncG9zaXRpb24nLCAnYWJzb2x1dGUnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZSh3b3JkQ291bnRTUEFOLCAnYm90dG9tJywgJzBweCcpO1xyXG5cclxuICAgICAgICBjb25zdCB7IHdpZHRoLCByaWdodCB9ID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgIGNvbnN0IHsgd2lkdGg6IHBhcmVudFdpZHRoIH0gPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQucGFyZW50RWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICBpZiAocGFyZW50V2lkdGggIT09IHdpZHRoKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKHdvcmRDb3VudFNQQU4sICdyaWdodCcsIGAke3BhcmVudFdpZHRoIC0gd2lkdGggKyAxMH1weGApO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5ybyA9IG5ldyBSZXNpemVPYnNlcnZlcigoZW50cmllcywgb2JzZXJ2ZXIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlbnRyaWVzICYmIGVudHJpZXNbMF0pIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBfcHcgPSBlbnRyaWVzWzBdLmNvbnRlbnRSZWN0LndpZHRoO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZSh3b3JkQ291bnRTUEFOLCAncmlnaHQnLCBgJHtfcHcgLSB3aWR0aCArIDEwfXB4YCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLnJvLm9ic2VydmUodGhpcy5lbC5uYXRpdmVFbGVtZW50LnBhcmVudEVsZW1lbnQpO1xyXG5cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZSh3b3JkQ291bnRTUEFOLCAncmlnaHQnLCAnMTBweCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZSh3b3JkQ291bnRTUEFOLCAnY3Vyc29yJywgJ3BvaW50ZXInKTtcclxuXHJcbiAgICAgICAgdGhpcy5lbC5uYXRpdmVFbGVtZW50LmFmdGVyKHdvcmRDb3VudFNQQU4pO1xyXG4gICAgICAgIHRoaXMud29yZENvdW50RWxlbWVudCA9IHdvcmRDb3VudFNQQU47XHJcblxyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRMZW5ndGhTUEFOID0gdGhpcy5yZW5kZXIuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xyXG4gICAgICAgIHdvcmRDb3VudFNQQU4uYXBwZW5kQ2hpbGQoY3VycmVudExlbmd0aFNQQU4pO1xyXG4gICAgICAgIHRoaXMuY3VycmVudExlbmd0aEVsZW1lbnQgPSBjdXJyZW50TGVuZ3RoU1BBTjtcclxuICAgICAgICBjdXJyZW50TGVuZ3RoU1BBTi5hZnRlciggYCAvICR7bWF4fWAgKTtcclxuXHJcbiAgICAgICAgdGhpcy51cGRhdGVXb3Jkc0NvdW50KCk7XHJcbiAgICAgICAgdGhpcy5vbklucHV0ID0gdGhpcy5yZW5kZXIubGlzdGVuKHRoaXMuZWwubmF0aXZlRWxlbWVudCwgJ2lucHV0JywgKCkgPT4ge1xyXG4gICAgICAgICAgICAvLyB2YWx1ZS5yZXBsYWNlKC9cXG58XFxyL2dpLCAnJykgLy8g56e76Zmk5o2i6KGM56ymXHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlV29yZHNDb3VudCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZVdvcmRzQ291bnQoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnVzZVdvcmRDb3VudCB8fCAhdGhpcy5jdXJyZW50TGVuZ3RoRWxlbWVudCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IG1heCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC5tYXhMZW5ndGg7XHJcbiAgICAgICAgY29uc3QgdmFsID0gdGhpcy5jb3VudFR5cGUgPT09ICdzdXJwbHVzJyA/IG1heCAtIHRoaXMuZWwubmF0aXZlRWxlbWVudC52YWx1ZS5sZW5ndGggOiB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQudmFsdWUubGVuZ3RoO1xyXG4gICAgICAgIGNvbnN0IHRpcCA9ICdtZXNzYWdlci5wcm9tcHQudGlwcy4nICsgdGhpcy5jb3VudFR5cGU7XHJcblxyXG4gICAgICAgIHRoaXMuY3VycmVudExlbmd0aEVsZW1lbnQuaW5uZXJUZXh0ID0gdmFsO1xyXG4gICAgICAgIHRoaXMud29yZENvdW50RWxlbWVudC50aXRsZSA9IHRoaXMubG9jYWxlU2VyLmdldFZhbHVlKHRpcCkucmVwbGFjZSgnezB9JywgdmFsKTtcclxuICAgIH1cclxufVxyXG4iXX0=