/**
 * @fileoverview added by tsickle
 * Generated from: lib/directives/adminorganization-selector-data-mapping.directive.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, Optional, Self, Input, Injector } from '@angular/core';
import { ViewModel } from '@farris/devkit';
import { AdminOrganizationSelectorComponent } from '@farris/ui-adminorganization-selector';
export class AdminOrganizationSelectorDataMappingDirective {
    /**
     * @param {?} vm
     * @param {?} targetComponent
     * @param {?} injector
     */
    constructor(vm, targetComponent, injector) {
        this.vm = vm;
        this.targetComponent = targetComponent;
        this.injector = injector;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.targetComponent.selectionsChange.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            /** @type {?} */
            const mapfields = this.mapFields;
            if (data.selections && data.selections.length) {
                this.mappingData(data.selections, mapfields);
            }
            else {
                this.mappingData(null, mapfields);
            }
        }));
        this.targetComponent.inputClear.subscribe((/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            const mapfields = this.mapFields;
            this.mappingData(null, mapfields);
        }));
        this.targetComponent.tagRemoved.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            /** @type {?} */
            const mapfields = this.mapFields;
            this.tagRemovedMappingData(data.deleteIndex, mapfields);
            // if (this.targetComponent.selections && this.targetComponent.selections.length) {
            //     this.mappingData(this.targetComponent.selections, mapfields);
            // } else {
            //     this.mappingData(null, mapfields);
            // }
        }));
        if (!this.targetComponent.mapFields) {
            this.targetComponent.mapFields = this.mapFields;
        }
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
    }
    /**
     * @private
     * @return {?}
     */
    getFieldBinding() {
        /** @type {?} */
        const ngControl = this.targetComponent && this.targetComponent.ngControl && this.targetComponent.ngControl;
        /** @type {?} */
        const ngFormControls = ngControl && ngControl.formDirective && ngControl.formDirective.form
            && ngControl.formDirective.form && ngControl.formDirective.form.ngFormControls;
        /** @type {?} */
        const name = ngControl && ngControl.name;
        return ngFormControls && ngFormControls[name] && ngFormControls[name].binding;
    }
    /**
     * @param {?} index
     * @param {?} mapFields
     * @return {?}
     */
    tagRemovedMappingData(index, mapFields) {
        if (!mapFields) {
            return;
        }
        if (this.targetComponent.ngControl &&
            this.targetComponent.ngControl.formDirective &&
            this.targetComponent.ngControl.formDirective.form &&
            this.targetComponent.ngControl.formDirective.form.bindingData) {
            /** @type {?} */
            const bindingData = this.targetComponent.ngControl.formDirective.form.bindingData;
            if (bindingData.setValue) {
                // 关闭变更检测
                /** @type {?} */
                const appContext = this.vm.frameContext.appContext;
                appContext.changeDetectionController.detach();
                /** @type {?} */
                let helpFields = Object.keys(mapFields);
                /** @type {?} */
                const idIndex = helpFields.findIndex((/**
                 * @param {?} item
                 * @return {?}
                 */
                item => item === 'id'));
                if (helpFields.includes('id') && idIndex !== 0) {
                    helpFields.splice(idIndex, 1);
                    helpFields = ['id', ...helpFields];
                }
                /** @type {?} */
                const pathArr = this.getBindingPathArray();
                /** @type {?} */
                const anyFieldArr = this.mapFields[helpFields[0]].split(',');
                /** @type {?} */
                const formAnyData = bindingData.getValue(pathArr.concat(anyFieldArr[0]));
                if (!formAnyData || formAnyData.split(',').length < 2) {
                    helpFields.reverse();
                }
                helpFields.forEach((/**
                 * @param {?} helpField
                 * @return {?}
                 */
                (helpField) => {
                    this.mapFields[helpField].split(',').forEach((/**
                     * @param {?} fieldPath
                     * @return {?}
                     */
                    fieldPath => {
                        /** @type {?} */
                        const path = pathArr.concat(fieldPath.split('.'));
                        // todo udt关联问题
                        if (this.getFieldBinding() === fieldPath) {
                            return;
                        }
                        /** @type {?} */
                        const resStr = bindingData.getValue(path);
                        if (!resStr) {
                            bindingData.clearValue(path, true, true);
                        }
                        else {
                            /** @type {?} */
                            const resArr = resStr.split(',');
                            resArr.splice(index, 1);
                            /** @type {?} */
                            const result = resArr.join();
                            if (!result) {
                                bindingData.clearValue(path, true, true);
                            }
                            else {
                                bindingData.setValue(path, result, true, true);
                            }
                        }
                    }));
                }));
                // 重新打开变更检测
                appContext.changeDetectionController.reattach();
            }
        }
    }
    /**
     *
     * @param {?} helpData 清空时，值为null
     * @param {?} mapFields 格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"}
     * @return {?}
     */
    mappingData(helpData, mapFields) {
        if (!mapFields) {
            return;
        }
        // 关闭变更检测
        /** @type {?} */
        const appContext = this.vm.frameContext.appContext;
        appContext.changeDetectionController.detach();
        /** @type {?} */
        let helpFields = Object.keys(mapFields);
        /** @type {?} */
        const idIndex = helpFields.findIndex((/**
         * @param {?} item
         * @return {?}
         */
        item => item === 'id'));
        if (helpFields.includes('id') && idIndex !== 0) {
            helpFields.splice(idIndex, 1);
            helpFields = ['id', ...helpFields];
        }
        if (!helpData) {
            helpFields.reverse();
        }
        helpFields.forEach((/**
         * @param {?} f
         * @return {?}
         */
        (f) => {
            // 1、获取字段值
            // 如果helpData有选中值，则获取帮助数据源里对应你字段的值；
            // 如果helpData没有值（清空场景），则返回一个空字符串
            /** @type {?} */
            let val = '';
            if (helpData) {
                if (helpData instanceof Array) {
                    val = helpData.map((/**
                     * @param {?} h
                     * @return {?}
                     */
                    (h) => {
                        return this.getValue(f, h);
                    })).join(',');
                }
                else {
                    val = this.getValue(f, helpData);
                }
            }
            // 2、设置字段值
            // 如果helpData不存在（清空场景），获取BindingData里对应字段的值，如果是数值，则设置0，其他设置上一步中的空字符串；
            // 如果helpData存在：直接设置上一步中获取的值。
            /** @type {?} */
            const pathArr = this.getBindingPathArray();
            mapFields[f].split(',').forEach((/**
             * @param {?} ff
             * @return {?}
             */
            (ff) => {
                if (this.getFieldBinding() === ff) {
                    return;
                }
                if (!helpData) {
                    this.vm.bindingData.clearValue(pathArr.concat(ff.split('.')), true, true);
                }
                else {
                    this.vm.bindingData.setValue(pathArr.concat(ff.split('.')), val, true, true);
                }
            }));
        }));
        // 重新打开变更检测
        appContext.changeDetectionController.reattach();
    }
    /**
     * @private
     * @param {?} f
     * @param {?} data
     * @return {?}
     */
    getValue(f, data) {
        /** @type {?} */
        let val = '';
        if (f.indexOf('.') === -1) {
            val = data[f];
        }
        else {
            val = f.split('.').reduce((/**
             * @param {?} a
             * @param {?} b
             * @return {?}
             */
            (a, b) => {
                return a[b];
            }), data);
        }
        return val;
    }
    /**
     * @private
     * @return {?}
     */
    getBindingPathArray() {
        /** @type {?} */
        const path = this.vm.bindingPath;
        if (path) {
            return path.split('/').filter((/**
             * @param {?} n
             * @return {?}
             */
            n => n !== ''));
        }
        return [];
    }
}
AdminOrganizationSelectorDataMappingDirective.decorators = [
    { type: Directive, args: [{
                selector: '[adminorganization-selector-data-mapping]'
            },] }
];
/** @nocollapse */
AdminOrganizationSelectorDataMappingDirective.ctorParameters = () => [
    { type: ViewModel, decorators: [{ type: Optional }] },
    { type: AdminOrganizationSelectorComponent, decorators: [{ type: Optional }, { type: Self }] },
    { type: Injector }
];
AdminOrganizationSelectorDataMappingDirective.propDecorators = {
    mapFields: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    AdminOrganizationSelectorDataMappingDirective.prototype.mapFields;
    /**
     * @type {?}
     * @private
     */
    AdminOrganizationSelectorDataMappingDirective.prototype.vm;
    /**
     * @type {?}
     * @private
     */
    AdminOrganizationSelectorDataMappingDirective.prototype.targetComponent;
    /**
     * @type {?}
     * @private
     */
    AdminOrganizationSelectorDataMappingDirective.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRtaW5vcmdhbml6YXRpb24tc2VsZWN0b3ItZGF0YS1tYXBwaW5nLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGZmLWRhdGEtYmluZGluZy8iLCJzb3VyY2VzIjpbImxpYi9kaXJlY3RpdmVzL2FkbWlub3JnYW5pemF0aW9uLXNlbGVjdG9yLWRhdGEtbWFwcGluZy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLFFBQVEsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUE0QixRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0csT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxrQ0FBa0MsRUFBRSxNQUFPLHVDQUF1QyxDQUFDO0FBTTVGLE1BQU0sT0FBTyw2Q0FBNkM7Ozs7OztJQUl4RCxZQUN3QixFQUFhLEVBQ0wsZUFBbUQsRUFDdkUsUUFBa0I7UUFGTixPQUFFLEdBQUYsRUFBRSxDQUFXO1FBQ0wsb0JBQWUsR0FBZixlQUFlLENBQW9DO1FBQ3ZFLGFBQVEsR0FBUixRQUFRLENBQVU7SUFDMUIsQ0FBQzs7OztJQUVMLFFBQVE7UUFDSixJQUFJLENBQUMsZUFBZSxDQUFDLGdCQUFnQixDQUFDLFNBQVM7Ozs7UUFBQyxDQUFDLElBQVMsRUFBRSxFQUFFOztrQkFDcEQsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTO1lBQ2hDLElBQUksSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRTtnQkFDM0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxDQUFDO2FBQ2hEO2lCQUFNO2dCQUNILElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO2FBQ3JDO1FBQ0wsQ0FBQyxFQUFDLENBQUM7UUFFSCxJQUFJLENBQUMs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WUFDN0IsR0FBRyxHQUFHLEVBQUU7UUFDWixJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDdkIsR0FBRyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNqQjthQUFNO1lBQ0gsR0FBRyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTTs7Ozs7WUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDL0IsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEIsQ0FBQyxHQUFFLElBQUksQ0FBQyxDQUFDO1NBQ1o7UUFFRCxPQUFPLEdBQUcsQ0FBQztJQUNmLENBQUM7Ozs7O0lBRU8sbUJBQW1COztjQUNqQixJQUFJLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxXQUFXO1FBQ2hDLElBQUksSUFBSSxFQUFFO1lBQ04sT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU07Ozs7WUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUMsQ0FBQztTQUNoRDtRQUNELE9BQU8sRUFBRSxDQUFDO0lBQ2QsQ0FBQzs7O1lBak1GLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsMkNBQTJDO2FBQ3REOzs7O1lBTFEsU0FBUyx1QkFZWCxRQUFRO1lBWE4sa0NBQWtDLHVCQVlwQyxRQUFRLFlBQUksSUFBSTtZQWRzRCxRQUFROzs7d0JBVWxGLEtBQUs7Ozs7SUFBTixrRUFBd0I7Ozs7O0lBR3BCLDJEQUFpQzs7Ozs7SUFDakMsd0VBQStFOzs7OztJQUMvRSxpRUFBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIE9uSW5pdCwgT3B0aW9uYWwsIFNlbGYsIElucHV0LCBPbkRlc3Ryb3ksIEFmdGVyVmlld0luaXQsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFZpZXdNb2RlbCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgQWRtaW5Pcmdhbml6YXRpb25TZWxlY3RvckNvbXBvbmVudCB9ICBmcm9tICdAZmFycmlzL3VpLWFkbWlub3JnYW5pemF0aW9uLXNlbGVjdG9yJztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW2FkbWlub3JnYW5pemF0aW9uLXNlbGVjdG9yLWRhdGEtbWFwcGluZ10nXHJcbn0pXHJcblxyXG5leHBvcnQgY2xhc3MgQWRtaW5Pcmdhbml6YXRpb25TZWxlY3RvckRhdGFNYXBwaW5nRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xyXG5cclxuICBASW5wdXQoKSBtYXBGaWVsZHM6IGFueTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICAgIEBPcHRpb25hbCgpIHByaXZhdGUgdm06IFZpZXdNb2RlbCxcclxuICAgICAgQE9wdGlvbmFsKCkgQFNlbGYoKSBwcml2YXRlIHRhcmdldENvbXBvbmVudDogQWRtaW5Pcmdhbml6YXRpb25TZWxlY3RvckNvbXBvbmVudCxcclxuICAgICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3JcclxuICApIHsgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgICAgdGhpcy50YXJnZXRDb21wb25lbnQuc2VsZWN0aW9uc0NoYW5nZS5zdWJzY3JpYmUoKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgbWFwZmllbGRzID0gdGhpcy5tYXBGaWVsZHM7XHJcbiAgICAgICAgICBpZiAoZGF0YS5zZWxlY3Rpb25zICYmIGRhdGEuc2VsZWN0aW9ucy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICB0aGlzLm1hcHBpbmdEYXRhKGRhdGEuc2VsZWN0aW9ucywgbWFwZmllbGRzKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5tYXBwaW5nRGF0YShudWxsLCBtYXBmaWVsZHMpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHRoaXMudGFyZ2V0Q29tcG9uZW50LmlucHV0Q2xlYXIuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgIGNvbnN0IG1hcGZpZWxkcyA9IHRoaXMubWFwRmllbGRzO1xyXG4gICAgICAgICAgdGhpcy5tYXBwaW5nRGF0YShudWxsLCBtYXBmaWVsZHMpO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHRoaXMudGFyZ2V0Q29tcG9uZW50LnRhZ1JlbW92ZWQuc3Vic2NyaWJlKChkYXRhKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBtYXBmaWVsZHMgPSB0aGlzLm1hcEZpZWxkcztcclxuICAgICAgICAgIHRoaXMudGFnUmVtb3ZlZE1hcHBpbmdEYXRhKGRhdGEuZGVsZXRlSW5kZXgsIG1hcGZpZWxkcyk7XHJcbiAgICAgICAgICAvLyBpZiAodGhpcy50YXJnZXRDb21wb25lbnQuc2VsZWN0aW9ucyAmJiB0aGlzLnRhcmdldENvbXBvbmVudC5zZWxlY3Rpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgLy8gICAgIHRoaXMubWFwcGluZ0RhdGEodGhpcy50YXJnZXRDb21wb25lbnQuc2VsZWN0aW9ucywgbWFwZmllbGRzKTtcclxuICAgICAgICAgIC8vIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyAgICAgdGhpcy5tYXBwaW5nRGF0YShudWxsLCBtYXBmaWVsZHMpO1xyXG4gICAgICAgICAgLy8gfVxyXG4gICAgICB9KTtcclxuICAgICAgaWYgKCF0aGlzLnRhcmdldENvbXBvbmVudC5tYXBGaWVsZHMpIHtcclxuICAgICAgICAgIHRoaXMudGFyZ2V0Q29tcG9uZW50Lm1hcEZpZWxkcyA9IHRoaXMubWFwRmllbGRzO1xyXG4gICAgICB9XHJcbiAgfVxyXG5cclxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XHJcblxyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcblxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRGaWVsZEJpbmRpbmcoKSB7XHJcbiAgICAgIGNvbnN0IG5nQ29udHJvbCA9IHRoaXMudGFyZ2V0Q29tcG9uZW50ICYmIHRoaXMudGFyZ2V0Q29tcG9uZW50Lm5nQ29udHJvbCAmJiB0aGlzLnRhcmdldENvbXBvbmVudC5uZ0NvbnRyb2w7XHJcbiAgICAgIGNvbnN0IG5nRm9ybUNvbnRyb2xzID0gbmdDb250cm9sICYmIG5nQ29udHJvbC5mb3JtRGlyZWN0aXZlICYmIG5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm1cclxuICAgICAgICAgICYmIG5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0gJiYgbmdDb250cm9sLmZvcm1EaXJlY3RpdmUuZm9ybS5uZ0Zvcm1Db250cm9scztcclxuICAgICAgY29uc3QgbmFtZSA9IG5nQ29udHJvbCAmJiBuZ0NvbnRyb2wubmFtZTtcclxuICAgICAgcmV0dXJuIG5nRm9ybUNvbnRyb2xzICYmIG5nRm9ybUNvbnRyb2xzW25hbWVdICYmIG5nRm9ybUNvbnRyb2xzW25hbWVdLmJpbmRpbmc7XHJcbiAgfVxyXG5cclxuICB0YWdSZW1vdmVkTWFwcGluZ0RhdGEoaW5kZXgsIG1hcEZpZWxkcykge1xyXG4gICAgICBpZiAoIW1hcEZpZWxkcykge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChcclxuICAgICAgICAgIHRoaXMudGFyZ2V0Q29tcG9uZW50Lm5nQ29udHJvbCAmJlxyXG4gICAgICAgICAgdGhpcy50YXJnZXRDb21wb25lbnQubmdDb250cm9sLmZvcm1EaXJlY3RpdmUgJiZcclxuICAgICAgICAgIHRoaXMudGFyZ2V0Q29tcG9uZW50Lm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0gJiZcclxuICAgICAgICAgIHRoaXMudGFyZ2V0Q29tcG9uZW50Lm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0uYmluZGluZ0RhdGFcclxuICAgICAgKSB7XHJcbiAgICAgICAgICBjb25zdCBiaW5kaW5nRGF0YSA9IHRoaXMudGFyZ2V0Q29tcG9uZW50Lm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0uYmluZGluZ0RhdGE7XHJcbiAgICAgICAgICBpZiAoYmluZGluZ0RhdGEuc2V0VmFsdWUpIHtcclxuICAgICAgICAgICAgICAvLyDlhbPpl63lj5jmm7Tmo4DmtYtcclxuICAgICAgICAgICAgICBjb25zdCBhcHBDb250ZXh0ID0gdGhpcy52bS5mcmFtZUNvbnRleHQuYXBwQ29udGV4dDtcclxuICAgICAgICAgICAgICBhcHBDb250ZXh0LmNoYW5nZURldGVjdGlvbkNvbnRyb2xsZXIuZGV0YWNoKCk7XHJcblxyXG4gICAgICAgICAgICAgIGxldCBoZWxwRmllbGRzID0gT2JqZWN0LmtleXMobWFwRmllbGRzKTtcclxuICAgICAgICAgICAgICBjb25zdCBpZEluZGV4ID0gaGVscEZpZWxkcy5maW5kSW5kZXgoaXRlbSA9PiBpdGVtID09PSAnaWQnKTtcclxuICAgICAgICAgICAgICBpZiAoaGVscEZpZWxkcy5pbmNsdWRlcygnaWQnKSAmJiBpZEluZGV4ICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgIGhlbHBGaWVsZHMuc3BsaWNlKGlkSW5kZXgsIDEpO1xyXG4gICAgICAgICAgICAgICAgICBoZWxwRmllbGRzID0gWydpZCcsIC4uLmhlbHBGaWVsZHNdO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBjb25zdCBwYXRoQXJyID0gdGhpcy5nZXRCaW5kaW5nUGF0aEFycmF5KCk7XHJcbiAgICAgICAgICAgICAgY29uc3QgYW55RmllbGRBcnIgPSB0aGlzLm1hcEZpZWxkc1toZWxwRmllbGRzWzBdXS5zcGxpdCgnLCcpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGZvcm1BbnlEYXRhID0gYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aEFyci5jb25jYXQoYW55RmllbGRBcnJbMF0pKTtcclxuXHJcbiAgICAgICAgICAgICAgaWYgKCFmb3JtQW55RGF0YSB8fCBmb3JtQW55RGF0YS5zcGxpdCgnLCcpLmxlbmd0aCA8IDIpIHtcclxuICAgICAgICAgICAgICAgICAgaGVscEZpZWxkcy5yZXZlcnNlKCk7XHJcbiAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICBoZWxwRmllbGRzLmZvckVhY2goKGhlbHBGaWVsZDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIHRoaXMubWFwRmllbGRzW2hlbHBGaWVsZF0uc3BsaXQoJywnKS5mb3JFYWNoKGZpZWxkUGF0aCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXRoID0gcGF0aEFyci5jb25jYXQoZmllbGRQYXRoLnNwbGl0KCcuJykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgLy8gdG9kbyB1ZHTlhbPogZTpl67pophcclxuICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldEZpZWxkQmluZGluZygpID09PSBmaWVsZFBhdGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNTdHIgPSBiaW5kaW5nRGF0YS5nZXRWYWx1ZShwYXRoKTtcclxuICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVzU3RyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZGluZ0RhdGEuY2xlYXJWYWx1ZShwYXRoLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzQXJyID0gcmVzU3RyLnNwbGl0KCcsJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzQXJyLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gcmVzQXJyLmpvaW4oKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nRGF0YS5jbGVhclZhbHVlKHBhdGgsIHRydWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdEYXRhLnNldFZhbHVlKHBhdGgsIHJlc3VsdCwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAvLyDph43mlrDmiZPlvIDlj5jmm7Tmo4DmtYtcclxuICAgICAgICAgICAgICBhcHBDb250ZXh0LmNoYW5nZURldGVjdGlvbkNvbnRyb2xsZXIucmVhdHRhY2goKTtcclxuICAgICAgICAgIH1cclxuICAgICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKlxyXG4gICAqIEBwYXJhbSBoZWxwRGF0YSDmuIXnqbrml7bvvIzlgLzkuLpudWxsXHJcbiAgICogQHBhcmFtIG1hcEZpZWxkcyDmoLzlvI/lvaLlpoLvvJp7aWQ6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZFwiLCBjb2RlOiBcImFzc29GaWVsZC5hc3NvRmllbGRfQ29kZVwiLCBuYW1lOiBcImFzc29GaWVsZC5hc3NvRmllbGRfTmFtZVwifVxyXG4gICAqL1xyXG4gIG1hcHBpbmdEYXRhKGhlbHBEYXRhOiBhbnksIG1hcEZpZWxkczogYW55KSB7XHJcbiAgICAgIGlmICghbWFwRmllbGRzKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIOWFs+mXreWPmOabtOajgOa1i1xyXG4gICAgICBjb25zdCBhcHBDb250ZXh0ID0gdGhpcy52bS5mcmFtZUNvbnRleHQuYXBwQ29udGV4dDtcclxuICAgICAgYXBwQ29udGV4dC5jaGFuZ2VEZXRlY3Rpb25Db250cm9sbGVyLmRldGFjaCgpO1xyXG5cclxuICAgICAgbGV0IGhlbHBGaWVsZHMgPSBPYmplY3Qua2V5cyhtYXBGaWVsZHMpO1xyXG4gICAgICBjb25zdCBpZEluZGV4ID0gaGVscEZpZWxkcy5maW5kSW5kZXgoaXRlbSA9PiBpdGVtID09PSAnaWQnKTtcclxuICAgICAgaWYgKGhlbHBGaWVsZHMuaW5jbHVkZXMoJ2lkJykgJiYgaWRJbmRleCAhPT0gMCkge1xyXG4gICAgICAgICAgaGVscEZpZWxkcy5zcGxpY2UoaWRJbmRleCwgMSk7XHJcbiAgICAgICAgICBoZWxwRmllbGRzID0gWydpZCcsIC4uLmhlbHBGaWVsZHNdO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICghaGVscERhdGEpIHtcclxuICAgICAgICAgIGhlbHBGaWVsZHMucmV2ZXJzZSgpO1xyXG4gICAgICB9XHJcbiAgICAgIGhlbHBGaWVsZHMuZm9yRWFjaCgoZjogYW55KSA9PiB7XHJcbiAgICAgICAgICAvLyAx44CB6I635Y+W5a2X5q615YC8XHJcbiAgICAgICAgICAvLyDlpoLmnpxoZWxwRGF0YeaciemAieS4reWAvO+8jOWImeiOt+WPluW4ruWKqeaVsOaNrua6kOmHjOWvueW6lOS9oOWtl+auteeahOWAvO+8m1xyXG4gICAgICAgICAgLy8g5aaC5p6caGVscERhdGHmsqHmnInlgLzvvIjmuIXnqbrlnLrmma/vvInvvIzliJnov5Tlm57kuIDkuKrnqbrlrZfnrKbkuLJcclxuICAgICAgICAgIGxldCB2YWw6IGFueSA9ICcnO1xyXG4gICAgICAgICAgaWYgKGhlbHBEYXRhKSB7XHJcbiAgICAgICAgICAgICAgaWYgKGhlbHBEYXRhIGluc3RhbmNlb2YgQXJyYXkpIHtcclxuICAgICAgICAgICAgICAgICAgdmFsID0gaGVscERhdGEubWFwKChoOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFZhbHVlKGYsIGgpO1xyXG4gICAgICAgICAgICAgICAgICB9KS5qb2luKCcsJyk7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgdmFsID0gdGhpcy5nZXRWYWx1ZShmLCBoZWxwRGF0YSk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIC8vIDLjgIHorr7nva7lrZfmrrXlgLxcclxuICAgICAgICAgIC8vIOWmguaenGhlbHBEYXRh5LiN5a2Y5Zyo77yI5riF56m65Zy65pmv77yJ77yM6I635Y+WQmluZGluZ0RhdGHph4zlr7nlupTlrZfmrrXnmoTlgLzvvIzlpoLmnpzmmK/mlbDlgLzvvIzliJnorr7nva4w77yM5YW25LuW6K6+572u5LiK5LiA5q2l5Lit55qE56m65a2X56ym5Liy77ybXHJcbiAgICAgICAgICAvLyDlpoLmnpxoZWxwRGF0YeWtmOWcqO+8muebtOaOpeiuvue9ruS4iuS4gOatpeS4reiOt+WPlueahOWAvOOAglxyXG4gICAgICAgICAgY29uc3QgcGF0aEFyciA9IHRoaXMuZ2V0QmluZGluZ1BhdGhBcnJheSgpO1xyXG4gICAgICAgICAgbWFwRmllbGRzW2ZdLnNwbGl0KCcsJykuZm9yRWFjaCgoZmY6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgIGlmICh0aGlzLmdldEZpZWxkQmluZGluZygpID09PSBmZikge1xyXG4gICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIGlmICghaGVscERhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgdGhpcy52bS5iaW5kaW5nRGF0YS5jbGVhclZhbHVlKHBhdGhBcnIuY29uY2F0KGZmLnNwbGl0KCcuJykpLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICB0aGlzLnZtLmJpbmRpbmdEYXRhLnNldFZhbHVlKHBhdGhBcnIuY29uY2F0KGZmLnNwbGl0KCcuJykpLCB2YWwsIHRydWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIC8vIOmHjeaWsOaJk+W8gOWPmOabtOajgOa1i1xyXG4gICAgICBhcHBDb250ZXh0LmNoYW5nZURldGVjdGlvbkNvbnRyb2xsZXIucmVhdHRhY2goKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0VmFsdWUoZjogc3RyaW5nLCBkYXRhOiBhbnkpIHtcclxuICAgICAgbGV0IHZhbCA9ICcnO1xyXG4gICAgICBpZiAoZi5pbmRleE9mKCcuJykgPT09IC0xKSB7XHJcbiAgICAgICAgICB2YWwgPSBkYXRhW2ZdO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdmFsID0gZi5zcGxpdCgnLicpLnJlZHVjZSgoYSwgYikgPT4ge1xyXG4gICAgICAgICAgICAgIHJldHVybiBhW2JdO1xyXG4gICAgICAgICAgfSwgZGF0YSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiB2YWw7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEJpbmRpbmdQYXRoQXJyYXkoKTogYW55W10ge1xyXG4gICAgICBjb25zdCBwYXRoID0gdGhpcy52bS5iaW5kaW5nUGF0aDtcclxuICAgICAgaWYgKHBhdGgpIHtcclxuICAgICAgICAgIHJldHVybiBwYXRoLnNwbGl0KCcvJykuZmlsdGVyKG4gPT4gbiAhPT0gJycpO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBbXTtcclxuICB9XHJcblxyXG59XHJcbiJdfQ==