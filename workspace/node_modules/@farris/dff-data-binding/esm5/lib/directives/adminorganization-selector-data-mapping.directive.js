/**
 * @fileoverview added by tsickle
 * Generated from: lib/directives/adminorganization-selector-data-mapping.directive.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Directive, Optional, Self, Input, Injector } from '@angular/core';
import { ViewModel } from '@farris/devkit';
import { AdminOrganizationSelectorComponent } from '@farris/ui-adminorganization-selector';
var AdminOrganizationSelectorDataMappingDirective = /** @class */ (function () {
    function AdminOrganizationSelectorDataMappingDirective(vm, targetComponent, injector) {
        this.vm = vm;
        this.targetComponent = targetComponent;
        this.injector = injector;
    }
    /**
     * @return {?}
     */
    AdminOrganizationSelectorDataMappingDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.targetComponent.selectionsChange.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            /** @type {?} */
            var mapfields = _this.mapFields;
            if (data.selections && data.selections.length) {
                _this.mappingData(data.selections, mapfields);
            }
            else {
                _this.mappingData(null, mapfields);
            }
        }));
        this.targetComponent.inputClear.subscribe((/**
         * @return {?}
         */
        function () {
            /** @type {?} */
            var mapfields = _this.mapFields;
            _this.mappingData(null, mapfields);
        }));
        this.targetComponent.tagRemoved.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            /** @type {?} */
            var mapfields = _this.mapFields;
            _this.tagRemovedMappingData(data.deleteIndex, mapfields);
            // if (this.targetComponent.selections && this.targetComponent.selections.length) {
            //     this.mappingData(this.targetComponent.selections, mapfields);
            // } else {
            //     this.mappingData(null, mapfields);
            // }
        }));
        if (!this.targetComponent.mapFields) {
            this.targetComponent.mapFields = this.mapFields;
        }
    };
    /**
     * @return {?}
     */
    AdminOrganizationSelectorDataMappingDirective.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @return {?}
     */
    AdminOrganizationSelectorDataMappingDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @private
     * @return {?}
     */
    AdminOrganizationSelectorDataMappingDirective.prototype.getFieldBinding = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var ngControl = this.targetComponent && this.targetComponent.ngControl && this.targetComponent.ngControl;
        /** @type {?} */
        var ngFormControls = ngControl && ngControl.formDirective && ngControl.formDirective.form
            && ngControl.formDirective.form && ngControl.formDirective.form.ngFormControls;
        /** @type {?} */
        var name = ngControl && ngControl.name;
        return ngFormControls && ngFormControls[name] && ngFormControls[name].binding;
    };
    /**
     * @param {?} index
     * @param {?} mapFields
     * @return {?}
     */
    AdminOrganizationSelectorDataMappingDirective.prototype.tagRemovedMappingData = /**
     * @param {?} index
     * @param {?} mapFields
     * @return {?}
     */
    function (index, mapFields) {
        var _this = this;
        if (!mapFields) {
            return;
        }
        if (this.targetComponent.ngControl &&
            this.targetComponent.ngControl.formDirective &&
            this.targetComponent.ngControl.formDirective.form &&
            this.targetComponent.ngControl.formDirective.form.bindingData) {
            /** @type {?} */
            var bindingData_1 = this.targetComponent.ngControl.formDirective.form.bindingData;
            if (bindingData_1.setValue) {
                // 关闭变更检测
                /** @type {?} */
                var appContext = this.vm.frameContext.appContext;
                appContext.changeDetectionController.detach();
                /** @type {?} */
                var helpFields = Object.keys(mapFields);
                /** @type {?} */
                var idIndex = helpFields.findIndex((/**
                 * @param {?} item
                 * @return {?}
                 */
                function (item) { return item === 'id'; }));
                if (helpFields.includes('id') && idIndex !== 0) {
                    helpFields.splice(idIndex, 1);
                    helpFields = tslib_1.__spread(['id'], helpFields);
                }
                /** @type {?} */
                var pathArr_1 = this.getBindingPathArray();
                /** @type {?} */
                var anyFieldArr = this.mapFields[helpFields[0]].split(',');
                /** @type {?} */
                var formAnyData = bindingData_1.getValue(pathArr_1.concat(anyFieldArr[0]));
                if (!formAnyData || formAnyData.split(',').length < 2) {
                    helpFields.reverse();
                }
                helpFields.forEach((/**
                 * @param {?} helpField
                 * @return {?}
                 */
                function (helpField) {
                    _this.mapFields[helpField].split(',').forEach((/**
                     * @param {?} fieldPath
                     * @return {?}
                     */
                    function (fieldPath) {
                        /** @type {?} */
                        var path = pathArr_1.concat(fieldPath.split('.'));
                        // todo udt关联问题
                        if (_this.getFieldBinding() === fieldPath) {
                            return;
                        }
                        /** @type {?} */
                        var resStr = bindingData_1.getValue(path);
                        if (!resStr) {
                            bindingData_1.clearValue(path, true, true);
                        }
                        else {
                            /** @type {?} */
                            var resArr = resStr.split(',');
                            resArr.splice(index, 1);
                            /** @type {?} */
                            var result = resArr.join();
                            if (!result) {
                                bindingData_1.clearValue(path, true, true);
                            }
                            else {
                                bindingData_1.setValue(path, result, true, true);
                            }
                        }
                    }));
                }));
                // 重新打开变更检测
                appContext.changeDetectionController.reattach();
            }
        }
    };
    /**
     *
     * @param helpData 清空时，值为null
     * @param mapFields 格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"}
     */
    /**
     *
     * @param {?} helpData 清空时，值为null
     * @param {?} mapFields 格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"}
     * @return {?}
     */
    AdminOrganizationSelectorDataMappingDirective.prototype.mappingData = /**
     *
     * @param {?} helpData 清空时，值为null
     * @param {?} mapFields 格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"}
     * @return {?}
     */
    function (helpData, mapFields) {
        var _this = this;
        if (!mapFields) {
            return;
        }
        // 关闭变更检测
        /** @type {?} */
        var appContext = this.vm.frameContext.appContext;
        appContext.changeDetectionController.detach();
        /** @type {?} */
        var helpFields = Object.keys(mapFields);
        /** @type {?} */
        var idIndex = helpFields.findIndex((/**
         * @param {?} item
         * @return {?}
         */
        function (item) { return item === 'id'; }));
        if (helpFields.includes('id') && idIndex !== 0) {
            helpFields.splice(idIndex, 1);
            helpFields = tslib_1.__spread(['id'], helpFields);
        }
        if (!helpData) {
            helpFields.reverse();
        }
        helpFields.forEach((/**
         * @param {?} f
         * @return {?}
         */
        function (f) {
            // 1、获取字段值
            // 如果helpData有选中值，则获取帮助数据源里对应你字段的值；
            // 如果helpData没有值（清空场景），则返回一个空字符串
            /** @type {?} */
            var val = '';
            if (helpData) {
                if (helpData instanceof Array) {
                    val = helpData.map((/**
                     * @param {?} h
                     * @return {?}
                     */
                    function (h) {
                        return _this.getValue(f, h);
                    })).join(',');
                }
                else {
                    val = _this.getValue(f, helpData);
                }
            }
            // 2、设置字段值
            // 如果helpData不存在（清空场景），获取BindingData里对应字段的值，如果是数值，则设置0，其他设置上一步中的空字符串；
            // 如果helpData存在：直接设置上一步中获取的值。
            /** @type {?} */
            var pathArr = _this.getBindingPathArray();
            mapFields[f].split(',').forEach((/**
             * @param {?} ff
             * @return {?}
             */
            function (ff) {
                if (_this.getFieldBinding() === ff) {
                    return;
                }
                if (!helpData) {
                    _this.vm.bindingData.clearValue(pathArr.concat(ff.split('.')), true, true);
                }
                else {
                    _this.vm.bindingData.setValue(pathArr.concat(ff.split('.')), val, true, true);
                }
            }));
        }));
        // 重新打开变更检测
        appContext.changeDetectionController.reattach();
    };
    /**
     * @private
     * @param {?} f
     * @param {?} data
     * @return {?}
     */
    AdminOrganizationSelectorDataMappingDirective.prototype.getValue = /**
     * @private
     * @param {?} f
     * @param {?} data
     * @return {?}
     */
    function (f, data) {
        /** @type {?} */
        var val = '';
        if (f.indexOf('.') === -1) {
            val = data[f];
        }
        else {
            val = f.split('.').reduce((/**
             * @param {?} a
             * @param {?} b
             * @return {?}
             */
            function (a, b) {
                return a[b];
            }), data);
        }
        return val;
    };
    /**
     * @private
     * @return {?}
     */
    AdminOrganizationSelectorDataMappingDirective.prototype.getBindingPathArray = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var path = this.vm.bindingPath;
        if (path) {
            return path.split('/').filter((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n !== ''; }));
        }
        return [];
    };
    AdminOrganizationSelectorDataMappingDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[adminorganization-selector-data-mapping]'
                },] }
    ];
    /** @nocollapse */
    AdminOrganizationSelectorDataMappingDirective.ctorParameters = function () { return [
        { type: ViewModel, decorators: [{ type: Optional }] },
        { type: AdminOrganizationSelectorComponent, decorators: [{ type: Optional }, { type: Self }] },
        { type: Injector }
    ]; };
    AdminOrganizationSelectorDataMappingDirective.propDecorators = {
        mapFields: [{ type: Input }]
    };
    return AdminOrganizationSelectorDataMappingDirective;
}());
export { AdminOrganizationSelectorDataMappingDirective };
if (false) {
    /** @type {?} */
    AdminOrganizationSelectorDataMappingDirective.prototype.mapFields;
    /**
     * @type {?}
     * @private
     */
    AdminOrganizationSelectorDataMappingDirective.prototype.vm;
    /**
     * @type {?}
     * @private
     */
    AdminOrganizationSelectorDataMappingDirective.prototype.targetComponent;
    /**
     * @type {?}
     * @private
     */
    AdminOrganizationSelectorDataMappingDirective.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRtaW5vcmdhbml6YXRpb24tc2VsZWN0b3ItZGF0YS1tYXBwaW5nLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGZmLWRhdGEtYmluZGluZy8iLCJzb3VyY2VzIjpbImxpYi9kaXJlY3RpdmVzL2FkbWlub3JnYW5pemF0aW9uLXNlbGVjdG9yLWRhdGEtbWFwcGluZy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxRQUFRLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBNEIsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdHLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsa0NBQWtDLEVBQUUsTUFBTyx1Q0FBdUMsQ0FBQztBQUU1RjtJQVFFLHVEQUN3QixFQUFhLEVBQ0wsZUFBbUQsRUFDdkUsUUFBa0I7UUFGTixPQUFFLEdBQUYsRUFBRSxDQUFXO1FBQ0wsb0JBQWUsR0FBZixlQUFlLENBQW9DO1FBQ3ZFLGFBQVEsR0FBUixRQUFRLENBQVU7SUFDMUIsQ0FBQzs7OztJQUVMLGdFQUFROzs7SUFBUjtRQUFBLGlCQTJCQztRQTFCRyxJQUFJLENBQUMsZUFBZSxDQUFDLGdCQUFnQixDQUFDLFNBQVM7Ozs7UUFBQyxVQUFDLElBQVM7O2dCQUNoRCxTQUFTLEdBQUcsS0FBSSxDQUFDLFNBQVM7WUFDaEMsSUFBSSxJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFO2dCQUMzQyxLQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsU0FBUyxDQUFDLENBQUM7YUFDaEQ7aUJBQU07Z0JBQ0gsS0FBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7YUFDckM7UUFDTCxDQUFDLEVBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxlQUFlLENBQUMs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QUFoQixVQUFpQixDQUFTLEVBQUUsSUFBUzs7WUFDN0IsR0FBRyxHQUFHLEVBQUU7UUFDWixJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDdkIsR0FBRyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNqQjthQUFNO1lBQ0gsR0FBRyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTTs7Ozs7WUFBQyxVQUFDLENBQUMsRUFBRSxDQUFDO2dCQUMzQixPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNoQixDQUFDLEdBQUUsSUFBSSxDQUFDLENBQUM7U0FDWjtRQUVELE9BQU8sR0FBRyxDQUFDO0lBQ2YsQ0FBQzs7Ozs7SUFFTywyRUFBbUI7Ozs7SUFBM0I7O1lBQ1UsSUFBSSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsV0FBVztRQUNoQyxJQUFJLElBQUksRUFBRTtZQUNOLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNOzs7O1lBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEtBQUssRUFBRSxFQUFSLENBQVEsRUFBQyxDQUFDO1NBQ2hEO1FBQ0QsT0FBTyxFQUFFLENBQUM7SUFDZCxDQUFDOztnQkFqTUYsU0FBUyxTQUFDO29CQUNULFFBQVEsRUFBRSwyQ0FBMkM7aUJBQ3REOzs7O2dCQUxRLFNBQVMsdUJBWVgsUUFBUTtnQkFYTixrQ0FBa0MsdUJBWXBDLFFBQVEsWUFBSSxJQUFJO2dCQWRzRCxRQUFROzs7NEJBVWxGLEtBQUs7O0lBNkxSLG9EQUFDO0NBQUEsQUFuTUQsSUFtTUM7U0EvTFksNkNBQTZDOzs7SUFFeEQsa0VBQXdCOzs7OztJQUdwQiwyREFBaUM7Ozs7O0lBQ2pDLHdFQUErRTs7Ozs7SUFDL0UsaUVBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBPbkluaXQsIE9wdGlvbmFsLCBTZWxmLCBJbnB1dCwgT25EZXN0cm95LCBBZnRlclZpZXdJbml0LCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBWaWV3TW9kZWwgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IEFkbWluT3JnYW5pemF0aW9uU2VsZWN0b3JDb21wb25lbnQgfSAgZnJvbSAnQGZhcnJpcy91aS1hZG1pbm9yZ2FuaXphdGlvbi1zZWxlY3Rvcic7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1thZG1pbm9yZ2FuaXphdGlvbi1zZWxlY3Rvci1kYXRhLW1hcHBpbmddJ1xyXG59KVxyXG5cclxuZXhwb3J0IGNsYXNzIEFkbWluT3JnYW5pemF0aW9uU2VsZWN0b3JEYXRhTWFwcGluZ0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95IHtcclxuXHJcbiAgQElucHV0KCkgbWFwRmllbGRzOiBhbnk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHZtOiBWaWV3TW9kZWwsXHJcbiAgICAgIEBPcHRpb25hbCgpIEBTZWxmKCkgcHJpdmF0ZSB0YXJnZXRDb21wb25lbnQ6IEFkbWluT3JnYW5pemF0aW9uU2VsZWN0b3JDb21wb25lbnQsXHJcbiAgICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yXHJcbiAgKSB7IH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICAgIHRoaXMudGFyZ2V0Q29tcG9uZW50LnNlbGVjdGlvbnNDaGFuZ2Uuc3Vic2NyaWJlKChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgICAgIGNvbnN0IG1hcGZpZWxkcyA9IHRoaXMubWFwRmllbGRzO1xyXG4gICAgICAgICAgaWYgKGRhdGEuc2VsZWN0aW9ucyAmJiBkYXRhLnNlbGVjdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5tYXBwaW5nRGF0YShkYXRhLnNlbGVjdGlvbnMsIG1hcGZpZWxkcyk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIHRoaXMubWFwcGluZ0RhdGEobnVsbCwgbWFwZmllbGRzKTtcclxuICAgICAgICAgIH1cclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0aGlzLnRhcmdldENvbXBvbmVudC5pbnB1dENsZWFyLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBtYXBmaWVsZHMgPSB0aGlzLm1hcEZpZWxkcztcclxuICAgICAgICAgIHRoaXMubWFwcGluZ0RhdGEobnVsbCwgbWFwZmllbGRzKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0aGlzLnRhcmdldENvbXBvbmVudC50YWdSZW1vdmVkLnN1YnNjcmliZSgoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgbWFwZmllbGRzID0gdGhpcy5tYXBGaWVsZHM7XHJcbiAgICAgICAgICB0aGlzLnRhZ1JlbW92ZWRNYXBwaW5nRGF0YShkYXRhLmRlbGV0ZUluZGV4LCBtYXBmaWVsZHMpO1xyXG4gICAgICAgICAgLy8gaWYgKHRoaXMudGFyZ2V0Q29tcG9uZW50LnNlbGVjdGlvbnMgJiYgdGhpcy50YXJnZXRDb21wb25lbnQuc2VsZWN0aW9ucy5sZW5ndGgpIHtcclxuICAgICAgICAgIC8vICAgICB0aGlzLm1hcHBpbmdEYXRhKHRoaXMudGFyZ2V0Q29tcG9uZW50LnNlbGVjdGlvbnMsIG1hcGZpZWxkcyk7XHJcbiAgICAgICAgICAvLyB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8gICAgIHRoaXMubWFwcGluZ0RhdGEobnVsbCwgbWFwZmllbGRzKTtcclxuICAgICAgICAgIC8vIH1cclxuICAgICAgfSk7XHJcbiAgICAgIGlmICghdGhpcy50YXJnZXRDb21wb25lbnQubWFwRmllbGRzKSB7XHJcbiAgICAgICAgICB0aGlzLnRhcmdldENvbXBvbmVudC5tYXBGaWVsZHMgPSB0aGlzLm1hcEZpZWxkcztcclxuICAgICAgfVxyXG4gIH1cclxuXHJcbiAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xyXG5cclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG5cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0RmllbGRCaW5kaW5nKCkge1xyXG4gICAgICBjb25zdCBuZ0NvbnRyb2wgPSB0aGlzLnRhcmdldENvbXBvbmVudCAmJiB0aGlzLnRhcmdldENvbXBvbmVudC5uZ0NvbnRyb2wgJiYgdGhpcy50YXJnZXRDb21wb25lbnQubmdDb250cm9sO1xyXG4gICAgICBjb25zdCBuZ0Zvcm1Db250cm9scyA9IG5nQ29udHJvbCAmJiBuZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZSAmJiBuZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtXHJcbiAgICAgICAgICAmJiBuZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtICYmIG5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0ubmdGb3JtQ29udHJvbHM7XHJcbiAgICAgIGNvbnN0IG5hbWUgPSBuZ0NvbnRyb2wgJiYgbmdDb250cm9sLm5hbWU7XHJcbiAgICAgIHJldHVybiBuZ0Zvcm1Db250cm9scyAmJiBuZ0Zvcm1Db250cm9sc1tuYW1lXSAmJiBuZ0Zvcm1Db250cm9sc1tuYW1lXS5iaW5kaW5nO1xyXG4gIH1cclxuXHJcbiAgdGFnUmVtb3ZlZE1hcHBpbmdEYXRhKGluZGV4LCBtYXBGaWVsZHMpIHtcclxuICAgICAgaWYgKCFtYXBGaWVsZHMpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBpZiAoXHJcbiAgICAgICAgICB0aGlzLnRhcmdldENvbXBvbmVudC5uZ0NvbnRyb2wgJiZcclxuICAgICAgICAgIHRoaXMudGFyZ2V0Q29tcG9uZW50Lm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlICYmXHJcbiAgICAgICAgICB0aGlzLnRhcmdldENvbXBvbmVudC5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtICYmXHJcbiAgICAgICAgICB0aGlzLnRhcmdldENvbXBvbmVudC5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtLmJpbmRpbmdEYXRhXHJcbiAgICAgICkge1xyXG4gICAgICAgICAgY29uc3QgYmluZGluZ0RhdGEgPSB0aGlzLnRhcmdldENvbXBvbmVudC5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtLmJpbmRpbmdEYXRhO1xyXG4gICAgICAgICAgaWYgKGJpbmRpbmdEYXRhLnNldFZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgLy8g5YWz6Zet5Y+Y5pu05qOA5rWLXHJcbiAgICAgICAgICAgICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMudm0uZnJhbWVDb250ZXh0LmFwcENvbnRleHQ7XHJcbiAgICAgICAgICAgICAgYXBwQ29udGV4dC5jaGFuZ2VEZXRlY3Rpb25Db250cm9sbGVyLmRldGFjaCgpO1xyXG5cclxuICAgICAgICAgICAgICBsZXQgaGVscEZpZWxkcyA9IE9iamVjdC5rZXlzKG1hcEZpZWxkcyk7XHJcbiAgICAgICAgICAgICAgY29uc3QgaWRJbmRleCA9IGhlbHBGaWVsZHMuZmluZEluZGV4KGl0ZW0gPT4gaXRlbSA9PT0gJ2lkJyk7XHJcbiAgICAgICAgICAgICAgaWYgKGhlbHBGaWVsZHMuaW5jbHVkZXMoJ2lkJykgJiYgaWRJbmRleCAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICBoZWxwRmllbGRzLnNwbGljZShpZEluZGV4LCAxKTtcclxuICAgICAgICAgICAgICAgICAgaGVscEZpZWxkcyA9IFsnaWQnLCAuLi5oZWxwRmllbGRzXTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgY29uc3QgcGF0aEFyciA9IHRoaXMuZ2V0QmluZGluZ1BhdGhBcnJheSgpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGFueUZpZWxkQXJyID0gdGhpcy5tYXBGaWVsZHNbaGVscEZpZWxkc1swXV0uc3BsaXQoJywnKTtcclxuICAgICAgICAgICAgICBjb25zdCBmb3JtQW55RGF0YSA9IGJpbmRpbmdEYXRhLmdldFZhbHVlKHBhdGhBcnIuY29uY2F0KGFueUZpZWxkQXJyWzBdKSk7XHJcblxyXG4gICAgICAgICAgICAgIGlmICghZm9ybUFueURhdGEgfHwgZm9ybUFueURhdGEuc3BsaXQoJywnKS5sZW5ndGggPCAyKSB7XHJcbiAgICAgICAgICAgICAgICAgIGhlbHBGaWVsZHMucmV2ZXJzZSgpO1xyXG4gICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgaGVscEZpZWxkcy5mb3JFYWNoKChoZWxwRmllbGQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICB0aGlzLm1hcEZpZWxkc1toZWxwRmllbGRdLnNwbGl0KCcsJykuZm9yRWFjaChmaWVsZFBhdGggPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGF0aCA9IHBhdGhBcnIuY29uY2F0KGZpZWxkUGF0aC5zcGxpdCgnLicpKTtcclxuICAgICAgICAgICAgICAgICAgICAgIC8vIHRvZG8gdWR05YWz6IGU6Zeu6aKYXHJcbiAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXRGaWVsZEJpbmRpbmcoKSA9PT0gZmllbGRQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzU3RyID0gYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc1N0cikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdEYXRhLmNsZWFyVmFsdWUocGF0aCwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc0FyciA9IHJlc1N0ci5zcGxpdCgnLCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJlc0Fyci5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHJlc0Fyci5qb2luKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZGluZ0RhdGEuY2xlYXJWYWx1ZShwYXRoLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nRGF0YS5zZXRWYWx1ZShwYXRoLCByZXN1bHQsIHRydWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgLy8g6YeN5paw5omT5byA5Y+Y5pu05qOA5rWLXHJcbiAgICAgICAgICAgICAgYXBwQ29udGV4dC5jaGFuZ2VEZXRlY3Rpb25Db250cm9sbGVyLnJlYXR0YWNoKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICpcclxuICAgKiBAcGFyYW0gaGVscERhdGEg5riF56m65pe277yM5YC85Li6bnVsbFxyXG4gICAqIEBwYXJhbSBtYXBGaWVsZHMg5qC85byP5b2i5aaC77yae2lkOiBcImFzc29GaWVsZC5hc3NvRmllbGRcIiwgY29kZTogXCJhc3NvRmllbGQuYXNzb0ZpZWxkX0NvZGVcIiwgbmFtZTogXCJhc3NvRmllbGQuYXNzb0ZpZWxkX05hbWVcIn1cclxuICAgKi9cclxuICBtYXBwaW5nRGF0YShoZWxwRGF0YTogYW55LCBtYXBGaWVsZHM6IGFueSkge1xyXG4gICAgICBpZiAoIW1hcEZpZWxkcykge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyDlhbPpl63lj5jmm7Tmo4DmtYtcclxuICAgICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMudm0uZnJhbWVDb250ZXh0LmFwcENvbnRleHQ7XHJcbiAgICAgIGFwcENvbnRleHQuY2hhbmdlRGV0ZWN0aW9uQ29udHJvbGxlci5kZXRhY2goKTtcclxuXHJcbiAgICAgIGxldCBoZWxwRmllbGRzID0gT2JqZWN0LmtleXMobWFwRmllbGRzKTtcclxuICAgICAgY29uc3QgaWRJbmRleCA9IGhlbHBGaWVsZHMuZmluZEluZGV4KGl0ZW0gPT4gaXRlbSA9PT0gJ2lkJyk7XHJcbiAgICAgIGlmIChoZWxwRmllbGRzLmluY2x1ZGVzKCdpZCcpICYmIGlkSW5kZXggIT09IDApIHtcclxuICAgICAgICAgIGhlbHBGaWVsZHMuc3BsaWNlKGlkSW5kZXgsIDEpO1xyXG4gICAgICAgICAgaGVscEZpZWxkcyA9IFsnaWQnLCAuLi5oZWxwRmllbGRzXTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoIWhlbHBEYXRhKSB7XHJcbiAgICAgICAgICBoZWxwRmllbGRzLnJldmVyc2UoKTtcclxuICAgICAgfVxyXG4gICAgICBoZWxwRmllbGRzLmZvckVhY2goKGY6IGFueSkgPT4ge1xyXG4gICAgICAgICAgLy8gMeOAgeiOt+WPluWtl+auteWAvFxyXG4gICAgICAgICAgLy8g5aaC5p6caGVscERhdGHmnInpgInkuK3lgLzvvIzliJnojrflj5bluK7liqnmlbDmja7mupDph4zlr7nlupTkvaDlrZfmrrXnmoTlgLzvvJtcclxuICAgICAgICAgIC8vIOWmguaenGhlbHBEYXRh5rKh5pyJ5YC877yI5riF56m65Zy65pmv77yJ77yM5YiZ6L+U5Zue5LiA5Liq56m65a2X56ym5LiyXHJcbiAgICAgICAgICBsZXQgdmFsOiBhbnkgPSAnJztcclxuICAgICAgICAgIGlmIChoZWxwRGF0YSkge1xyXG4gICAgICAgICAgICAgIGlmIChoZWxwRGF0YSBpbnN0YW5jZW9mIEFycmF5KSB7XHJcbiAgICAgICAgICAgICAgICAgIHZhbCA9IGhlbHBEYXRhLm1hcCgoaDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRWYWx1ZShmLCBoKTtcclxuICAgICAgICAgICAgICAgICAgfSkuam9pbignLCcpO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgIHZhbCA9IHRoaXMuZ2V0VmFsdWUoZiwgaGVscERhdGEpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAvLyAy44CB6K6+572u5a2X5q615YC8XHJcbiAgICAgICAgICAvLyDlpoLmnpxoZWxwRGF0YeS4jeWtmOWcqO+8iOa4heepuuWcuuaZr++8ie+8jOiOt+WPlkJpbmRpbmdEYXRh6YeM5a+55bqU5a2X5q6155qE5YC877yM5aaC5p6c5piv5pWw5YC877yM5YiZ6K6+572uMO+8jOWFtuS7luiuvue9ruS4iuS4gOatpeS4reeahOepuuWtl+espuS4su+8m1xyXG4gICAgICAgICAgLy8g5aaC5p6caGVscERhdGHlrZjlnKjvvJrnm7TmjqXorr7nva7kuIrkuIDmraXkuK3ojrflj5bnmoTlgLzjgIJcclxuICAgICAgICAgIGNvbnN0IHBhdGhBcnIgPSB0aGlzLmdldEJpbmRpbmdQYXRoQXJyYXkoKTtcclxuICAgICAgICAgIG1hcEZpZWxkc1tmXS5zcGxpdCgnLCcpLmZvckVhY2goKGZmOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICBpZiAodGhpcy5nZXRGaWVsZEJpbmRpbmcoKSA9PT0gZmYpIHtcclxuICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBpZiAoIWhlbHBEYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgIHRoaXMudm0uYmluZGluZ0RhdGEuY2xlYXJWYWx1ZShwYXRoQXJyLmNvbmNhdChmZi5zcGxpdCgnLicpKSwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgdGhpcy52bS5iaW5kaW5nRGF0YS5zZXRWYWx1ZShwYXRoQXJyLmNvbmNhdChmZi5zcGxpdCgnLicpKSwgdmFsLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICAvLyDph43mlrDmiZPlvIDlj5jmm7Tmo4DmtYtcclxuICAgICAgYXBwQ29udGV4dC5jaGFuZ2VEZXRlY3Rpb25Db250cm9sbGVyLnJlYXR0YWNoKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldFZhbHVlKGY6IHN0cmluZywgZGF0YTogYW55KSB7XHJcbiAgICAgIGxldCB2YWwgPSAnJztcclxuICAgICAgaWYgKGYuaW5kZXhPZignLicpID09PSAtMSkge1xyXG4gICAgICAgICAgdmFsID0gZGF0YVtmXTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHZhbCA9IGYuc3BsaXQoJy4nKS5yZWR1Y2UoKGEsIGIpID0+IHtcclxuICAgICAgICAgICAgICByZXR1cm4gYVtiXTtcclxuICAgICAgICAgIH0sIGRhdGEpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gdmFsO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRCaW5kaW5nUGF0aEFycmF5KCk6IGFueVtdIHtcclxuICAgICAgY29uc3QgcGF0aCA9IHRoaXMudm0uYmluZGluZ1BhdGg7XHJcbiAgICAgIGlmIChwYXRoKSB7XHJcbiAgICAgICAgICByZXR1cm4gcGF0aC5zcGxpdCgnLycpLmZpbHRlcihuID0+IG4gIT09ICcnKTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gW107XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=