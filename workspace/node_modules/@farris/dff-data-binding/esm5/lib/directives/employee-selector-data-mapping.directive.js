/**
 * @fileoverview added by tsickle
 * Generated from: lib/directives/employee-selector-data-mapping.directive.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Directive, Optional, Self, Input, Injector } from '@angular/core';
import { ViewModel } from '@farris/devkit';
import { EmployeeSelectorComponent } from '@farris/ui-employee-selector';
var EmployeeSelectorDataMappingDirective = /** @class */ (function () {
    function EmployeeSelectorDataMappingDirective(vm, targetComponent, injector) {
        this.vm = vm;
        this.targetComponent = targetComponent;
        this.injector = injector;
    }
    /**
     * @return {?}
     */
    EmployeeSelectorDataMappingDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.targetComponent.selectionsChange.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            /** @type {?} */
            var mapfields = _this.mapFields;
            if (data.data && data.data.length) {
                _this.mappingData(data.data, mapfields);
            }
            else {
                _this.mappingData(null, mapfields);
            }
        }));
        this.targetComponent.inputClear.subscribe((/**
         * @return {?}
         */
        function () {
            /** @type {?} */
            var mapfields = _this.mapFields;
            _this.mappingData(null, mapfields);
        }));
        this.targetComponent.tagRemoved.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            /** @type {?} */
            var mapfields = _this.mapFields;
            _this.tagRemovedMappingData(data.deleteIndex, mapfields);
            // if (this.targetComponent.selections && this.targetComponent.selections.length) {
            //     this.mappingData(this.targetComponent.selections, mapfields);
            // } else {
            //     this.mappingData(null, mapfields);
            // }
        }));
        if (!this.targetComponent.mapFields) {
            this.targetComponent.mapFields = this.mapFields;
        }
    };
    /**
     * @return {?}
     */
    EmployeeSelectorDataMappingDirective.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @return {?}
     */
    EmployeeSelectorDataMappingDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @private
     * @return {?}
     */
    EmployeeSelectorDataMappingDirective.prototype.getFieldBinding = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var ngControl = this.targetComponent && this.targetComponent.ngControl && this.targetComponent.ngControl;
        /** @type {?} */
        var ngFormControls = ngControl && ngControl.formDirective && ngControl.formDirective.form
            && ngControl.formDirective.form && ngControl.formDirective.form.ngFormControls;
        /** @type {?} */
        var name = ngControl && ngControl.name;
        return ngFormControls && ngFormControls[name] && ngFormControls[name].binding;
    };
    /**
     * @param {?} index
     * @param {?} mapFields
     * @return {?}
     */
    EmployeeSelectorDataMappingDirective.prototype.tagRemovedMappingData = /**
     * @param {?} index
     * @param {?} mapFields
     * @return {?}
     */
    function (index, mapFields) {
        var _this = this;
        if (!mapFields) {
            return;
        }
        if (this.targetComponent.ngControl &&
            this.targetComponent.ngControl.formDirective &&
            this.targetComponent.ngControl.formDirective.form &&
            this.targetComponent.ngControl.formDirective.form.bindingData) {
            /** @type {?} */
            var bindingData_1 = this.targetComponent.ngControl.formDirective.form.bindingData;
            if (bindingData_1.setValue) {
                // 关闭变更检测
                /** @type {?} */
                var appContext = this.vm.frameContext.appContext;
                appContext.changeDetectionController.detach();
                /** @type {?} */
                var helpFields = Object.keys(mapFields);
                /** @type {?} */
                var idIndex = helpFields.findIndex((/**
                 * @param {?} item
                 * @return {?}
                 */
                function (item) { return item === 'id'; }));
                if (helpFields.includes('id') && idIndex !== 0) {
                    helpFields.splice(idIndex, 1);
                    helpFields = tslib_1.__spread(['id'], helpFields);
                }
                /** @type {?} */
                var pathArr_1 = this.getBindingPathArray();
                /** @type {?} */
                var anyFieldArr = this.mapFields[helpFields[0]].split(',');
                /** @type {?} */
                var formAnyData = bindingData_1.getValue(pathArr_1.concat(anyFieldArr[0]));
                if (!formAnyData || formAnyData.split(',').length < 2) {
                    helpFields.reverse();
                }
                helpFields.forEach((/**
                 * @param {?} helpField
                 * @return {?}
                 */
                function (helpField) {
                    _this.mapFields[helpField].split(',').forEach((/**
                     * @param {?} fieldPath
                     * @return {?}
                     */
                    function (fieldPath) {
                        /** @type {?} */
                        var path = pathArr_1.concat(fieldPath.split('.'));
                        // todo udt关联问题
                        if (_this.getFieldBinding() === fieldPath) {
                            return;
                        }
                        /** @type {?} */
                        var resStr = bindingData_1.getValue(path);
                        if (!resStr) {
                            bindingData_1.clearValue(path, true, true);
                        }
                        else {
                            /** @type {?} */
                            var resArr = resStr.split(',');
                            resArr.splice(index, 1);
                            /** @type {?} */
                            var result = resArr.join();
                            if (!result) {
                                bindingData_1.clearValue(path, true, true);
                            }
                            else {
                                bindingData_1.setValue(path, result, true, true);
                            }
                        }
                    }));
                }));
                // 重新打开变更检测
                appContext.changeDetectionController.reattach();
            }
        }
    };
    /**
     *
     * @param helpData 清空时，值为null
     * @param mapFields 格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"}
     */
    /**
     *
     * @param {?} helpData 清空时，值为null
     * @param {?} mapFields 格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"}
     * @return {?}
     */
    EmployeeSelectorDataMappingDirective.prototype.mappingData = /**
     *
     * @param {?} helpData 清空时，值为null
     * @param {?} mapFields 格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"}
     * @return {?}
     */
    function (helpData, mapFields) {
        var _this = this;
        if (!mapFields) {
            return;
        }
        // 关闭变更检测
        /** @type {?} */
        var appContext = this.vm.frameContext.appContext;
        appContext.changeDetectionController.detach();
        /** @type {?} */
        var helpFields = Object.keys(mapFields);
        /** @type {?} */
        var idIndex = helpFields.findIndex((/**
         * @param {?} item
         * @return {?}
         */
        function (item) { return item === 'id'; }));
        if (helpFields.includes('id') && idIndex !== 0) {
            helpFields.splice(idIndex, 1);
            helpFields = tslib_1.__spread(['id'], helpFields);
        }
        if (!helpData) {
            helpFields.reverse();
        }
        helpFields.forEach((/**
         * @param {?} f
         * @return {?}
         */
        function (f) {
            // 1、获取字段值
            // 如果helpData有选中值，则获取帮助数据源里对应你字段的值；
            // 如果helpData没有值（清空场景），则返回一个空字符串
            /** @type {?} */
            var val = '';
            if (helpData) {
                if (helpData instanceof Array) {
                    val = helpData.map((/**
                     * @param {?} h
                     * @return {?}
                     */
                    function (h) {
                        return _this.getValue(f, h);
                    })).join(',');
                }
                else {
                    val = _this.getValue(f, helpData);
                }
            }
            // 2、设置字段值
            // 如果helpData不存在（清空场景），获取BindingData里对应字段的值，如果是数值，则设置0，其他设置上一步中的空字符串；
            // 如果helpData存在：直接设置上一步中获取的值。
            /** @type {?} */
            var pathArr = _this.getBindingPathArray();
            mapFields[f].split(',').forEach((/**
             * @param {?} ff
             * @return {?}
             */
            function (ff) {
                if (_this.getFieldBinding() === ff) {
                    return;
                }
                if (!helpData) {
                    _this.vm.bindingData.clearValue(pathArr.concat(ff.split('.')), true, true);
                }
                else {
                    _this.vm.bindingData.setValue(pathArr.concat(ff.split('.')), val, true, true);
                }
            }));
        }));
        // 重新打开变更检测
        appContext.changeDetectionController.reattach();
    };
    /**
     * @private
     * @param {?} f
     * @param {?} data
     * @return {?}
     */
    EmployeeSelectorDataMappingDirective.prototype.getValue = /**
     * @private
     * @param {?} f
     * @param {?} data
     * @return {?}
     */
    function (f, data) {
        /** @type {?} */
        var val = '';
        if (f.indexOf('.') === -1) {
            val = data[f];
        }
        else {
            val = f.split('.').reduce((/**
             * @param {?} a
             * @param {?} b
             * @return {?}
             */
            function (a, b) {
                return a[b];
            }), data);
        }
        return val;
    };
    /**
     * @private
     * @return {?}
     */
    EmployeeSelectorDataMappingDirective.prototype.getBindingPathArray = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var path = this.vm.bindingPath;
        if (path) {
            return path.split('/').filter((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n !== ''; }));
        }
        return [];
    };
    EmployeeSelectorDataMappingDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[employee-selector-data-mapping]'
                },] }
    ];
    /** @nocollapse */
    EmployeeSelectorDataMappingDirective.ctorParameters = function () { return [
        { type: ViewModel, decorators: [{ type: Optional }] },
        { type: EmployeeSelectorComponent, decorators: [{ type: Optional }, { type: Self }] },
        { type: Injector }
    ]; };
    EmployeeSelectorDataMappingDirective.propDecorators = {
        mapFields: [{ type: Input }]
    };
    return EmployeeSelectorDataMappingDirective;
}());
export { EmployeeSelectorDataMappingDirective };
if (false) {
    /** @type {?} */
    EmployeeSelectorDataMappingDirective.prototype.mapFields;
    /**
     * @type {?}
     * @private
     */
    EmployeeSelectorDataMappingDirective.prototype.vm;
    /**
     * @type {?}
     * @private
     */
    EmployeeSelectorDataMappingDirective.prototype.targetComponent;
    /**
     * @type {?}
     * @private
     */
    EmployeeSelectorDataMappingDirective.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1wbG95ZWUtc2VsZWN0b3ItZGF0YS1tYXBwaW5nLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGZmLWRhdGEtYmluZGluZy8iLCJzb3VyY2VzIjpbImxpYi9kaXJlY3RpdmVzL2VtcGxveWVlLXNlbGVjdG9yLWRhdGEtbWFwcGluZy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxRQUFRLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBNEIsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdHLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUV6RTtJQU9JLDhDQUN3QixFQUFhLEVBQ0wsZUFBMEMsRUFDOUQsUUFBa0I7UUFGTixPQUFFLEdBQUYsRUFBRSxDQUFXO1FBQ0wsb0JBQWUsR0FBZixlQUFlLENBQTJCO1FBQzlELGFBQVEsR0FBUixRQUFRLENBQVU7SUFDMUIsQ0FBQzs7OztJQUVMLHVEQUFROzs7SUFBUjtRQUFBLGlCQTJCQztRQTFCRyxJQUFJLENBQUMsZUFBZSxDQUFDLGdCQUFnQixDQUFDLFNBQVM7Ozs7UUFBQyxVQUFDLElBQVM7O2dCQUNoRCxTQUFTLEdBQUcsS0FBSSxDQUFDLFNBQVM7WUFDaEMsSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUMvQixLQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7YUFDMUM7aUJBQU07Z0JBQ0gsS0FBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7YUFDckM7UUFDTCxDQUFDLEVBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDLFNBQVM7OztR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QUUsSUFBUzs7WUFDN0IsR0FBRyxHQUFHLEVBQUU7UUFDWixJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDdkIsR0FBRyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNqQjthQUFNO1lBQ0gsR0FBRyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTTs7Ozs7WUFBQyxVQUFDLENBQUMsRUFBRSxDQUFDO2dCQUMzQixPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNoQixDQUFDLEdBQUUsSUFBSSxDQUFDLENBQUM7U0FDWjtRQUVELE9BQU8sR0FBRyxDQUFDO0lBQ2YsQ0FBQzs7Ozs7SUFFTyxrRUFBbUI7Ozs7SUFBM0I7O1lBQ1UsSUFBSSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsV0FBVztRQUNoQyxJQUFJLElBQUksRUFBRTtZQUNOLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNOzs7O1lBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEtBQUssRUFBRSxFQUFSLENBQVEsRUFBQyxDQUFDO1NBQ2hEO1FBQ0QsT0FBTyxFQUFFLENBQUM7SUFDZCxDQUFDOztnQkFoTUosU0FBUyxTQUFDO29CQUNULFFBQVEsRUFBRSxrQ0FBa0M7aUJBQzdDOzs7O2dCQUxRLFNBQVMsdUJBV1QsUUFBUTtnQkFWUix5QkFBeUIsdUJBV3pCLFFBQVEsWUFBSSxJQUFJO2dCQWJvRCxRQUFROzs7NEJBU2hGLEtBQUs7O0lBNkxWLDJDQUFDO0NBQUEsQUFsTUQsSUFrTUM7U0EvTFksb0NBQW9DOzs7SUFFN0MseURBQXdCOzs7OztJQUdwQixrREFBaUM7Ozs7O0lBQ2pDLCtEQUFzRTs7Ozs7SUFDdEUsd0RBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBPbkluaXQsIE9wdGlvbmFsLCBTZWxmLCBJbnB1dCwgT25EZXN0cm95LCBBZnRlclZpZXdJbml0LCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBWaWV3TW9kZWwgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IEVtcGxveWVlU2VsZWN0b3JDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWVtcGxveWVlLXNlbGVjdG9yJztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW2VtcGxveWVlLXNlbGVjdG9yLWRhdGEtbWFwcGluZ10nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBFbXBsb3llZVNlbGVjdG9yRGF0YU1hcHBpbmdEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSwgQWZ0ZXJWaWV3SW5pdCB7XHJcblxyXG4gICAgQElucHV0KCkgbWFwRmllbGRzOiBhbnk7XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSB2bTogVmlld01vZGVsLFxyXG4gICAgICAgIEBPcHRpb25hbCgpIEBTZWxmKCkgcHJpdmF0ZSB0YXJnZXRDb21wb25lbnQ6IEVtcGxveWVlU2VsZWN0b3JDb21wb25lbnQsXHJcbiAgICAgICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3JcclxuICAgICkgeyB9XHJcblxyXG4gICAgbmdPbkluaXQoKSB7XHJcbiAgICAgICAgdGhpcy50YXJnZXRDb21wb25lbnQuc2VsZWN0aW9uc0NoYW5nZS5zdWJzY3JpYmUoKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBtYXBmaWVsZHMgPSB0aGlzLm1hcEZpZWxkcztcclxuICAgICAgICAgICAgaWYgKGRhdGEuZGF0YSAmJiBkYXRhLmRhdGEubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1hcHBpbmdEYXRhKGRhdGEuZGF0YSwgbWFwZmllbGRzKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubWFwcGluZ0RhdGEobnVsbCwgbWFwZmllbGRzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLnRhcmdldENvbXBvbmVudC5pbnB1dENsZWFyLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1hcGZpZWxkcyA9IHRoaXMubWFwRmllbGRzO1xyXG4gICAgICAgICAgICB0aGlzLm1hcHBpbmdEYXRhKG51bGwsIG1hcGZpZWxkcyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMudGFyZ2V0Q29tcG9uZW50LnRhZ1JlbW92ZWQuc3Vic2NyaWJlKChkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1hcGZpZWxkcyA9IHRoaXMubWFwRmllbGRzO1xyXG4gICAgICAgICAgICB0aGlzLnRhZ1JlbW92ZWRNYXBwaW5nRGF0YShkYXRhLmRlbGV0ZUluZGV4LCBtYXBmaWVsZHMpO1xyXG4gICAgICAgICAgICAvLyBpZiAodGhpcy50YXJnZXRDb21wb25lbnQuc2VsZWN0aW9ucyAmJiB0aGlzLnRhcmdldENvbXBvbmVudC5zZWxlY3Rpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAvLyAgICAgdGhpcy5tYXBwaW5nRGF0YSh0aGlzLnRhcmdldENvbXBvbmVudC5zZWxlY3Rpb25zLCBtYXBmaWVsZHMpO1xyXG4gICAgICAgICAgICAvLyB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyAgICAgdGhpcy5tYXBwaW5nRGF0YShudWxsLCBtYXBmaWVsZHMpO1xyXG4gICAgICAgICAgICAvLyB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKCF0aGlzLnRhcmdldENvbXBvbmVudC5tYXBGaWVsZHMpIHtcclxuICAgICAgICAgICAgdGhpcy50YXJnZXRDb21wb25lbnQubWFwRmllbGRzID0gdGhpcy5tYXBGaWVsZHM7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0RmllbGRCaW5kaW5nKCkge1xyXG4gICAgICAgIGNvbnN0IG5nQ29udHJvbCA9IHRoaXMudGFyZ2V0Q29tcG9uZW50ICYmIHRoaXMudGFyZ2V0Q29tcG9uZW50Lm5nQ29udHJvbCAmJiB0aGlzLnRhcmdldENvbXBvbmVudC5uZ0NvbnRyb2w7XHJcbiAgICAgICAgY29uc3QgbmdGb3JtQ29udHJvbHMgPSBuZ0NvbnRyb2wgJiYgbmdDb250cm9sLmZvcm1EaXJlY3RpdmUgJiYgbmdDb250cm9sLmZvcm1EaXJlY3RpdmUuZm9ybVxyXG4gICAgICAgICAgICAmJiBuZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtICYmIG5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0ubmdGb3JtQ29udHJvbHM7XHJcbiAgICAgICAgY29uc3QgbmFtZSA9IG5nQ29udHJvbCAmJiBuZ0NvbnRyb2wubmFtZTtcclxuICAgICAgICByZXR1cm4gbmdGb3JtQ29udHJvbHMgJiYgbmdGb3JtQ29udHJvbHNbbmFtZV0gJiYgbmdGb3JtQ29udHJvbHNbbmFtZV0uYmluZGluZztcclxuICAgIH1cclxuXHJcbiAgICB0YWdSZW1vdmVkTWFwcGluZ0RhdGEoaW5kZXgsIG1hcEZpZWxkcykge1xyXG4gICAgICAgIGlmICghbWFwRmllbGRzKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKFxyXG4gICAgICAgICAgICB0aGlzLnRhcmdldENvbXBvbmVudC5uZ0NvbnRyb2wgJiZcclxuICAgICAgICAgICAgdGhpcy50YXJnZXRDb21wb25lbnQubmdDb250cm9sLmZvcm1EaXJlY3RpdmUgJiZcclxuICAgICAgICAgICAgdGhpcy50YXJnZXRDb21wb25lbnQubmdDb250cm9sLmZvcm1EaXJlY3RpdmUuZm9ybSAmJlxyXG4gICAgICAgICAgICB0aGlzLnRhcmdldENvbXBvbmVudC5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtLmJpbmRpbmdEYXRhXHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdEYXRhID0gdGhpcy50YXJnZXRDb21wb25lbnQubmdDb250cm9sLmZvcm1EaXJlY3RpdmUuZm9ybS5iaW5kaW5nRGF0YTtcclxuICAgICAgICAgICAgaWYgKGJpbmRpbmdEYXRhLnNldFZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAvLyDlhbPpl63lj5jmm7Tmo4DmtYtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLnZtLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0O1xyXG4gICAgICAgICAgICAgICAgYXBwQ29udGV4dC5jaGFuZ2VEZXRlY3Rpb25Db250cm9sbGVyLmRldGFjaCgpO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBoZWxwRmllbGRzID0gT2JqZWN0LmtleXMobWFwRmllbGRzKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGlkSW5kZXggPSBoZWxwRmllbGRzLmZpbmRJbmRleChpdGVtID0+IGl0ZW0gPT09ICdpZCcpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGhlbHBGaWVsZHMuaW5jbHVkZXMoJ2lkJykgJiYgaWRJbmRleCAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGhlbHBGaWVsZHMuc3BsaWNlKGlkSW5kZXgsIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGhlbHBGaWVsZHMgPSBbJ2lkJywgLi4uaGVscEZpZWxkc107XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXRoQXJyID0gdGhpcy5nZXRCaW5kaW5nUGF0aEFycmF5KCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhbnlGaWVsZEFyciA9IHRoaXMubWFwRmllbGRzW2hlbHBGaWVsZHNbMF1dLnNwbGl0KCcsJyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmb3JtQW55RGF0YSA9IGJpbmRpbmdEYXRhLmdldFZhbHVlKHBhdGhBcnIuY29uY2F0KGFueUZpZWxkQXJyWzBdKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCFmb3JtQW55RGF0YSB8fCBmb3JtQW55RGF0YS5zcGxpdCgnLCcpLmxlbmd0aCA8IDIpIHtcclxuICAgICAgICAgICAgICAgICAgICBoZWxwRmllbGRzLnJldmVyc2UoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBoZWxwRmllbGRzLmZvckVhY2goKGhlbHBGaWVsZDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXBGaWVsZHNbaGVscEZpZWxkXS5zcGxpdCgnLCcpLmZvckVhY2goZmllbGRQYXRoID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGF0aCA9IHBhdGhBcnIuY29uY2F0KGZpZWxkUGF0aC5zcGxpdCgnLicpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG9kbyB1ZHTlhbPogZTpl67pophcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2V0RmllbGRCaW5kaW5nKCkgPT09IGZpZWxkUGF0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc1N0ciA9IGJpbmRpbmdEYXRhLmdldFZhbHVlKHBhdGgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc1N0cikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZGluZ0RhdGEuY2xlYXJWYWx1ZShwYXRoLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc0FyciA9IHJlc1N0ci5zcGxpdCgnLCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzQXJyLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSByZXNBcnIuam9pbigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nRGF0YS5jbGVhclZhbHVlKHBhdGgsIHRydWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nRGF0YS5zZXRWYWx1ZShwYXRoLCByZXN1bHQsIHRydWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIC8vIOmHjeaWsOaJk+W8gOWPmOabtOajgOa1i1xyXG4gICAgICAgICAgICAgICAgYXBwQ29udGV4dC5jaGFuZ2VEZXRlY3Rpb25Db250cm9sbGVyLnJlYXR0YWNoKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqXHJcbiAgICAgKiBAcGFyYW0gaGVscERhdGEg5riF56m65pe277yM5YC85Li6bnVsbFxyXG4gICAgICogQHBhcmFtIG1hcEZpZWxkcyDmoLzlvI/lvaLlpoLvvJp7aWQ6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZFwiLCBjb2RlOiBcImFzc29GaWVsZC5hc3NvRmllbGRfQ29kZVwiLCBuYW1lOiBcImFzc29GaWVsZC5hc3NvRmllbGRfTmFtZVwifVxyXG4gICAgICovXHJcbiAgICBtYXBwaW5nRGF0YShoZWxwRGF0YTogYW55LCBtYXBGaWVsZHM6IGFueSkge1xyXG4gICAgICAgIGlmICghbWFwRmllbGRzKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOWFs+mXreWPmOabtOajgOa1i1xyXG4gICAgICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLnZtLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0O1xyXG4gICAgICAgIGFwcENvbnRleHQuY2hhbmdlRGV0ZWN0aW9uQ29udHJvbGxlci5kZXRhY2goKTtcclxuXHJcbiAgICAgICAgbGV0IGhlbHBGaWVsZHMgPSBPYmplY3Qua2V5cyhtYXBGaWVsZHMpO1xyXG4gICAgICAgIGNvbnN0IGlkSW5kZXggPSBoZWxwRmllbGRzLmZpbmRJbmRleChpdGVtID0+IGl0ZW0gPT09ICdpZCcpO1xyXG4gICAgICAgIGlmIChoZWxwRmllbGRzLmluY2x1ZGVzKCdpZCcpICYmIGlkSW5kZXggIT09IDApIHtcclxuICAgICAgICAgICAgaGVscEZpZWxkcy5zcGxpY2UoaWRJbmRleCwgMSk7XHJcbiAgICAgICAgICAgIGhlbHBGaWVsZHMgPSBbJ2lkJywgLi4uaGVscEZpZWxkc107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghaGVscERhdGEpIHtcclxuICAgICAgICAgICAgaGVscEZpZWxkcy5yZXZlcnNlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGhlbHBGaWVsZHMuZm9yRWFjaCgoZjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIC8vIDHjgIHojrflj5blrZfmrrXlgLxcclxuICAgICAgICAgICAgLy8g5aaC5p6caGVscERhdGHmnInpgInkuK3lgLzvvIzliJnojrflj5bluK7liqnmlbDmja7mupDph4zlr7nlupTkvaDlrZfmrrXnmoTlgLzvvJtcclxuICAgICAgICAgICAgLy8g5aaC5p6caGVscERhdGHmsqHmnInlgLzvvIjmuIXnqbrlnLrmma/vvInvvIzliJnov5Tlm57kuIDkuKrnqbrlrZfnrKbkuLJcclxuICAgICAgICAgICAgbGV0IHZhbDogYW55ID0gJyc7XHJcbiAgICAgICAgICAgIGlmIChoZWxwRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGhlbHBEYXRhIGluc3RhbmNlb2YgQXJyYXkpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YWwgPSBoZWxwRGF0YS5tYXAoKGg6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRWYWx1ZShmLCBoKTtcclxuICAgICAgICAgICAgICAgICAgICB9KS5qb2luKCcsJyk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhbCA9IHRoaXMuZ2V0VmFsdWUoZiwgaGVscERhdGEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyAy44CB6K6+572u5a2X5q615YC8XHJcbiAgICAgICAgICAgIC8vIOWmguaenGhlbHBEYXRh5LiN5a2Y5Zyo77yI5riF56m65Zy65pmv77yJ77yM6I635Y+WQmluZGluZ0RhdGHph4zlr7nlupTlrZfmrrXnmoTlgLzvvIzlpoLmnpzmmK/mlbDlgLzvvIzliJnorr7nva4w77yM5YW25LuW6K6+572u5LiK5LiA5q2l5Lit55qE56m65a2X56ym5Liy77ybXHJcbiAgICAgICAgICAgIC8vIOWmguaenGhlbHBEYXRh5a2Y5Zyo77ya55u05o6l6K6+572u5LiK5LiA5q2l5Lit6I635Y+W55qE5YC844CCXHJcbiAgICAgICAgICAgIGNvbnN0IHBhdGhBcnIgPSB0aGlzLmdldEJpbmRpbmdQYXRoQXJyYXkoKTtcclxuICAgICAgICAgICAgbWFwRmllbGRzW2ZdLnNwbGl0KCcsJykuZm9yRWFjaCgoZmY6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2V0RmllbGRCaW5kaW5nKCkgPT09IGZmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKCFoZWxwRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudm0uYmluZGluZ0RhdGEuY2xlYXJWYWx1ZShwYXRoQXJyLmNvbmNhdChmZi5zcGxpdCgnLicpKSwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudm0uYmluZGluZ0RhdGEuc2V0VmFsdWUocGF0aEFyci5jb25jYXQoZmYuc3BsaXQoJy4nKSksIHZhbCwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyDph43mlrDmiZPlvIDlj5jmm7Tmo4DmtYtcclxuICAgICAgICBhcHBDb250ZXh0LmNoYW5nZURldGVjdGlvbkNvbnRyb2xsZXIucmVhdHRhY2goKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFZhbHVlKGY6IHN0cmluZywgZGF0YTogYW55KSB7XHJcbiAgICAgICAgbGV0IHZhbCA9ICcnO1xyXG4gICAgICAgIGlmIChmLmluZGV4T2YoJy4nKSA9PT0gLTEpIHtcclxuICAgICAgICAgICAgdmFsID0gZGF0YVtmXTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB2YWwgPSBmLnNwbGl0KCcuJykucmVkdWNlKChhLCBiKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYVtiXTtcclxuICAgICAgICAgICAgfSwgZGF0YSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdmFsO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0QmluZGluZ1BhdGhBcnJheSgpOiBhbnlbXSB7XHJcbiAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMudm0uYmluZGluZ1BhdGg7XHJcbiAgICAgICAgaWYgKHBhdGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHBhdGguc3BsaXQoJy8nKS5maWx0ZXIobiA9PiBuICE9PSAnJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuXHJcbn1cclxuIl19