/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { cloneDeep, flatten } from "lodash-es";
/**
 * @param {?} c
 * @return {?}
 */
function _setColumnId(c) {
    c.id = c.id || c.field;
    if (c.colspan && c.colspan > 1) {
        c.groupHeader = true;
        c.id = 'groupHeader_' + c.id;
    }
}
/**
 * @param {?} node
 * @param {?} cols
 * @return {?}
 */
function _columnsToTreeNodes2(node, cols) {
    if (node.data.colspan) {
        if (cols[node.level + 1] && cols[node.level + 1].length) {
            /** @type {?} */
            var i = 0;
            do {
                /** @type {?} */
                let col = cols[node.level + 1].splice(0, 1)[0];
                i += col.colspan || 1;
                _setColumnId(col);
                /** @type {?} */
                const child = { data: col, children: [], level: node.level + 1, expanded: true, visible: true };
                node.children.push(child);
                if (col.colspan && col.colspan > 1) {
                    _columnsToTreeNodes2(child, cols);
                }
            } while (i < node.data.colspan && cols[node.level + 1].length);
        }
    }
}
/**
 * 将多表头列信息，转换为树结构
 * @param {?} cols
 * @return {?}
 */
export function columnsToTreeNodes(cols) {
    /** @type {?} */
    var nodes = [];
    cols[0].filter((/**
     * @param {?} n
     * @return {?}
     */
    n => n.field !== '_datagrid-setting-control_')).forEach((/**
     * @param {?} c
     * @return {?}
     */
    c => {
        _setColumnId(c);
        /** @type {?} */
        var node = { data: c, children: [], level: 0, expanded: true, visible: true };
        nodes.push(node);
    }));
    nodes.forEach((/**
     * @param {?} n
     * @return {?}
     */
    n => {
        _columnsToTreeNodes2(n, cols);
    }));
    return nodes;
}
// 多表头列设置恢复默认
/** @type {?} */
export const reset2DefaultForMultiHeaders = (/**
 * @param {?} gridInstance
 * @return {?}
 */
(gridInstance) => {
    /** @type {?} */
    const options = gridInstance.dfs['_state'].initialOptions;
    /** @type {?} */
    const settings = {
        viewColumns: [],
        columnFormat: []
    };
    if (options.sort) {
        /** @type {?} */
        const sortOrders = options.sort.sortOrder ? options.sort.sortOrder.split(',') : [];
        /** @type {?} */
        const sortNames = options.sort.sortName ? options.sort.sortName.split(',') : [];
        settings.sortInfo = { sortName: sortNames, sortOrder: sortOrders };
    }
    else {
        settings.sortInfo = {};
    }
    settings.groupField = options.groupField ? options.groupField.split(',') : [];
    settings.expandGroupRows = !!options.expandGroupRows;
    settings.multiHeaders = {
        treeData: null,
        viewCols: []
    };
    return {
        settings,
        multiHeaderOptions: {
            columns: options.groupHeaderFields,
            treeData: null
        }
    };
})
/** 为新的展示列合并原列中的设置，如 格式化，单元格样式、模板 */
;
/**
 * 为新的展示列合并原列中的设置，如 格式化，单元格样式、模板
 * @param {?} viewCols
 * @param {?} gridInitOptions
 * @return {?}
 */
export function mergetColumnOptions(viewCols, gridInitOptions) {
    if (viewCols && gridInitOptions) {
        /** @type {?} */
        const dataFields = flatten(gridInitOptions['designerColumns']);
        /** @type {?} */
        const _cols = cloneDeep(viewCols).map((/**
         * @param {?} cols
         * @return {?}
         */
        (cols) => {
            return cols.map((/**
             * @param {?} col
             * @return {?}
             */
            (col) => {
                if (!col.field || col.field.indexOf('farris-datagrid-column_') > -1) {
                    col.filter = false;
                }
                if (!col.colspan || col.colspan === 1) { // 数据字段
                    // 数据字段
                    /** @type {?} */
                    const old = dataFields.find((/**
                     * @param {?} n
                     * @return {?}
                     */
                    (n) => n.field === col.field || n.field === col.id));
                    if (old) {
                        /** @type {?} */
                        const _col = Object.assign({}, old, col);
                        if (!col.colspan) {
                            delete _col.colspan;
                        }
                        if (!_col.rowspan) {
                            delete _col.rowspan;
                        }
                        return _col;
                    }
                }
                return col;
            })).filter((/**
             * @param {?} n
             * @return {?}
             */
            n => n));
        }));
        return _cols;
    }
}
/**
 * @param {?} gridInstance
 * @param {?} newColumns
 * @return {?}
 */
export function refreshGridColumns(gridInstance, newColumns) {
    if (!gridInstance) {
        return;
    }
    /** @type {?} */
    const gridInitOptions = gridInstance.dfs['_state'].initialOptions;
    if (newColumns && gridInitOptions) {
        gridInstance.columns = mergetColumnOptions(newColumns, gridInitOptions);
    }
}
/**
 * 将排序信息合并到列上
 * @param {?} newColumns
 * @param {?} sortInfo
 * @return {?}
 */
export function mergeSortInfo(newColumns, sortInfo) {
    if (sortInfo && Object.keys(sortInfo).length) {
        const { sortName, sortOrder } = sortInfo;
        if (sortName && sortName.length) {
            newColumns.forEach((/**
             * @param {?} cols
             * @return {?}
             */
            (cols) => {
                cols.forEach((/**
                 * @param {?} col
                 * @return {?}
                 */
                (col) => {
                    /** @type {?} */
                    const i = sortName.indexOf(col.field);
                    if (i > -1) {
                        col.sortable = true;
                        col.order = sortOrder[i] || 'asc';
                    }
                    else {
                        col.order = '';
                    }
                }));
            }));
        }
    }
}
/**
 * @param {?} multiHeaderColumns
 * @return {?}
 */
export function multiHeadersHasDataFields(multiHeaderColumns) {
    if (multiHeaderColumns && multiHeaderColumns.length) {
        return flatten(multiHeaderColumns).filter((/**
         * @param {?} n
         * @return {?}
         */
        (n) => n.field && (!n.colspan || n.colspan === 1))).length;
    }
    return false;
}
/**
 * @param {?} groupHeaderCols
 * @return {?}
 */
export function getDataFieldsForMultiHeaders(groupHeaderCols) {
    return flatten(groupHeaderCols).filter((/**
     * @param {?} n
     * @return {?}
     */
    (n) => n.field && (!n.colspan || n.colspan === 1)));
}
/**
 * @param {?} viewCols
 * @param {?} groupFields
 * @return {?}
 */
export function cleanGroupFields(viewCols, groupFields) {
    /** @type {?} */
    const cols = getDataFieldsForMultiHeaders(viewCols);
    /** @type {?} */
    const groupColumns = groupFields.map((/**
     * @param {?} f
     * @return {?}
     */
    f => {
        /** @type {?} */
        const col = cols.find((/**
         * @param {?} col
         * @return {?}
         */
        col => col.field === f));
        return col;
    })).filter((/**
     * @param {?} n
     * @return {?}
     */
    n => n));
    return groupColumns.map((/**
     * @param {?} n
     * @return {?}
     */
    n => n.field));
}
/**
 * @param {?} viewCols
 * @param {?} sortInfo
 * @return {?}
 */
export function cleanSortFields(viewCols, sortInfo) {
    /** @type {?} */
    const cols = getDataFieldsForMultiHeaders(viewCols);
    /** @type {?} */
    const sortNames = sortInfo.sortName.map((/**
     * @param {?} f
     * @param {?} i
     * @return {?}
     */
    (f, i) => {
        /** @type {?} */
        const col = cols.find((/**
         * @param {?} col
         * @return {?}
         */
        col => col.field === f));
        if (!col) {
            sortInfo.sortOrder.splice(i, 1);
        }
        return col;
    })).filter((/**
     * @param {?} n
     * @return {?}
     */
    n => n));
    return {
        sortName: sortNames.map((/**
         * @param {?} n
         * @return {?}
         */
        n => n.field)),
        sortOrder: sortInfo.sortOrder
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXV0bGktaGVhZGVycy5oZWxwZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRhdGFncmlkLXNldHRpbmdzLyIsInNvdXJjZXMiOlsibGliL211dGxpLWhlYWRlcnMuaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQzs7Ozs7QUFHL0MsU0FBUyxZQUFZLENBQUMsQ0FBQztJQUNuQixDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQztJQUN2QixJQUFJLENBQUMsQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLEVBQUU7UUFDNUIsQ0FBQyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDckIsQ0FBQyxDQUFDLEVBQUUsR0FBRyxjQUFjLEdBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztLQUMvQjtBQUNMLENBQUM7Ozs7OztBQUdELFNBQVMsb0JBQW9CLENBQUMsSUFBSSxFQUFFLElBQUk7SUFDdkMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRTtRQUNoQixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRTs7Z0JBQ2pELENBQUMsR0FBRyxDQUFDO1lBQ1QsR0FBRzs7b0JBQ0ssR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM5QyxDQUFDLElBQUksR0FBRyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUM7Z0JBQ3RCLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQzs7c0JBQ1os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R0FBRyxJQUFJLENBQUMsSUFBSTs7OztRQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEtBQUssS0FBSyxDQUFDLEVBQUM7UUFDN0MsT0FBTyxHQUFHLENBQUM7SUFDZixDQUFDLEVBQUMsQ0FBQyxNQUFNOzs7O0lBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUM7SUFFakIsT0FBTyxZQUFZLENBQUMsR0FBRzs7OztJQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBQyxDQUFDO0FBQzFDLENBQUM7Ozs7OztBQUdELE1BQU0sVUFBVSxlQUFlLENBQUMsUUFBYSxFQUFFLFFBQXlDOztVQUM5RSxJQUFJLEdBQVEsNEJBQTRCLENBQUMsUUFBUSxDQUFDOztVQUNsRCxTQUFTLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHOzs7OztJQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFOztjQUN4QyxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUk7Ozs7UUFBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEtBQUssQ0FBQyxFQUFDO1FBQzdDLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDTixRQUFRLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDbkM7UUFDRCxPQUFPLEdBQUcsQ0FBQztJQUNmLENBQUMsRUFBQyxDQUFDLE1BQU07Ozs7SUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBQztJQUVqQixPQUFPO1FBQ0gsUUFBUSxFQUFFLFNBQVMsQ0FBQyxHQUFHOzs7O1FBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFDO1FBQ3JDLFNBQVMsRUFBRSxRQUFRLENBQUMsU0FBUztLQUNoQyxDQUFDO0FBQ04sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNsb25lRGVlcCwgZmxhdHRlbiB9IGZyb20gXCJsb2Rhc2gtZXNcIjtcclxuXHJcblxyXG5mdW5jdGlvbiBfc2V0Q29sdW1uSWQoYykge1xyXG4gICAgYy5pZCA9IGMuaWQgfHwgYy5maWVsZDtcclxuICAgIGlmIChjLmNvbHNwYW4gJiYgYy5jb2xzcGFuID4gMSkge1xyXG4gICAgICAgIGMuZ3JvdXBIZWFkZXIgPSB0cnVlO1xyXG4gICAgICAgIGMuaWQgPSAnZ3JvdXBIZWFkZXJfJysgYy5pZDtcclxuICAgIH1cclxufVxyXG5cclxuXHJcbmZ1bmN0aW9uIF9jb2x1bW5zVG9UcmVlTm9kZXMyKG5vZGUsIGNvbHMpIHtcclxuXHRpZiAobm9kZS5kYXRhLmNvbHNwYW4pIHtcclxuICAgICAgICBpZiAoY29sc1tub2RlLmxldmVsICsgMV0gJiYgY29sc1tub2RlLmxldmVsICsgMV0ubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHZhciBpID0gMDtcclxuICAgICAgICAgICAgZG8ge1xyXG4gICAgICAgICAgICAgICAgbGV0IGNvbCA9IGNvbHNbbm9kZS5sZXZlbCArIDFdLnNwbGljZSgwLCAxKVswXTtcclxuICAgICAgICAgICAgICAgIGkgKz0gY29sLmNvbHNwYW4gfHwgMTtcclxuICAgICAgICAgICAgICAgIF9zZXRDb2x1bW5JZChjb2wpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY2hpbGQgPSB7IGRhdGE6IGNvbCwgY2hpbGRyZW46IFtdLCBsZXZlbDogbm9kZS5sZXZlbCArIDEsIGV4cGFuZGVkOiB0cnVlLCB2aXNpYmxlOiB0cnVlIH07XHJcbiAgICAgICAgICAgICAgICBub2RlLmNoaWxkcmVuLnB1c2goY2hpbGQpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChjb2wuY29sc3BhbiAmJiBjb2wuY29sc3BhbiA+IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICBfY29sdW1uc1RvVHJlZU5vZGVzMihjaGlsZCwgY29scyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9IHdoaWxlKGk8IG5vZGUuZGF0YS5jb2xzcGFuICYmIGNvbHNbbm9kZS5sZXZlbCArIDFdLmxlbmd0aClcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbi8qKiDlsIblpJrooajlpLTliJfkv6Hmga/vvIzovazmjaLkuLrmoJHnu5PmnoQgKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGNvbHVtbnNUb1RyZWVOb2Rlcyhjb2xzKSB7XHJcblx0dmFyIG5vZGVzID0gW107XHJcblx0Y29sc1swXS5maWx0ZXIobiA9PiBuLmZpZWxkICE9PSAnX2RhdGFncmlkLXNldHRpbmctY29udHJvbF8nKS5mb3JFYWNoKGMgPT4ge1xyXG4gICAgICAgIF9zZXRDb2x1bW5JZChjKTtcclxuXHQgICAgdmFyIG5vZGUgPSB7IGRhdGE6IGMsIGNoaWxkcmVuOiBbXSwgbGV2ZWw6IDAsIGV4cGFuZGVkOiB0cnVlLCB2aXNpYmxlOiB0cnVlIH07XHJcblx0ICAgIG5vZGVzLnB1c2gobm9kZSk7XHJcblx0fSk7XHJcbiAgICBub2Rlcy5mb3JFYWNoKG4gPT4ge1xyXG4gICAgXHRfY29sdW1uc1RvVHJlZU5vZGVzMihuLCBjb2xzKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBub2RlcztcclxufVxyXG5cclxuXHJcblxyXG5cclxuXHJcbi8vIOWkmuihqOWktOWIl+iuvue9ruaBouWkjem7mOiupFxyXG5leHBvcnQgY29uc3QgcmVzZXQyRGVmYXVsdEZvck11bHRpSGVhZGVycyA9IChncmlkSW5zdGFuY2UpID0+IHtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSBncmlkSW5zdGFuY2UuZGZzWydfc3RhdGUnXS5pbml0aWFsT3B0aW9ucztcclxuICAgIGNvbnN0IHNldHRpbmdzOiBhbnkgPSB7XHJcbiAgICAgICAgdmlld0NvbHVtbnM6IFtdLFxyXG4gICAgICAgIGNvbHVtbkZvcm1hdDogW11cclxuICAgIH07XHJcblxyXG4gICAgaWYgKG9wdGlvbnMuc29ydCkge1xyXG4gICAgICAgIGNvbnN0IHNvcnRPcmRlcnMgPSBvcHRpb25zLnNvcnQuc29ydE9yZGVyPyBvcHRpb25zLnNvcnQuc29ydE9yZGVyLnNwbGl0KCcsJykgOiBbXTtcclxuICAgICAgICBjb25zdCBzb3J0TmFtZXMgPSBvcHRpb25zLnNvcnQuc29ydE5hbWUgPyBvcHRpb25zLnNvcnQuc29ydE5hbWUuc3BsaXQoJywnKSA6IFtdO1xyXG4gICAgICAgIHNldHRpbmdzLnNvcnRJbmZvID0geyBzb3J0TmFtZTogc29ydE5hbWVzLCBzb3J0T3JkZXI6ICBzb3J0T3JkZXJzIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHNldHRpbmdzLnNvcnRJbmZvID0ge307XHJcbiAgICB9XHJcbiAgICBzZXR0aW5ncy5ncm91cEZpZWxkID0gIG9wdGlvbnMuZ3JvdXBGaWVsZCA/IG9wdGlvbnMuZ3JvdXBGaWVsZC5zcGxpdCgnLCcpIDogW107XHJcbiAgICBzZXR0aW5ncy5leHBhbmRHcm91cFJvd3MgPSAhIW9wdGlvbnMuZXhwYW5kR3JvdXBSb3dzO1xyXG5cclxuICAgIHNldHRpbmdzLm11bHRpSGVhZGVycyA9IHtcclxuICAgICAgICB0cmVlRGF0YTogbnVsbCxcclxuICAgICAgICB2aWV3Q29sczogW11cclxuICAgIH07XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBzZXR0aW5ncyxcclxuICAgICAgICBtdWx0aUhlYWRlck9wdGlvbnM6IHtcclxuICAgICAgICAgICAgY29sdW1uczogb3B0aW9ucy5ncm91cEhlYWRlckZpZWxkcyxcclxuICAgICAgICAgICAgdHJlZURhdGE6IG51bGxcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbi8qKiDkuLrmlrDnmoTlsZXnpLrliJflkIjlubbljp/liJfkuK3nmoTorr7nva7vvIzlpoIg5qC85byP5YyW77yM5Y2V5YWD5qC85qC35byP44CB5qih5p2/ICovXHJcbmV4cG9ydCBmdW5jdGlvbiBtZXJnZXRDb2x1bW5PcHRpb25zKHZpZXdDb2xzOiBhbnksIGdyaWRJbml0T3B0aW9uczogYW55KSB7XHJcbiAgICBpZiAodmlld0NvbHMgJiYgZ3JpZEluaXRPcHRpb25zKSB7XHJcbiAgICAgICAgY29uc3QgZGF0YUZpZWxkcyA9IGZsYXR0ZW4oZ3JpZEluaXRPcHRpb25zWydkZXNpZ25lckNvbHVtbnMnXSk7XHJcbiAgICAgICAgY29uc3QgX2NvbHMgPSBjbG9uZURlZXAodmlld0NvbHMpLm1hcCgoY29sczogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBjb2xzLm1hcCgoY29sOiBhbnkpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIWNvbC5maWVsZCB8fCBjb2wuZmllbGQuaW5kZXhPZignZmFycmlzLWRhdGFncmlkLWNvbHVtbl8nKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29sLmZpbHRlciA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICghY29sLmNvbHNwYW4gfHwgY29sLmNvbHNwYW4gPT09IDEpIHsgLy8g5pWw5o2u5a2X5q61XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2xkID0gZGF0YUZpZWxkcy5maW5kKChuOiBhbnkpID0+IG4uZmllbGQgPT09IGNvbC5maWVsZCB8fCBuLmZpZWxkID09PSBjb2wuaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgX2NvbCA9IE9iamVjdC5hc3NpZ24oe30sb2xkLCBjb2wpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbC5jb2xzcGFuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgX2NvbC5jb2xzcGFuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghX2NvbC5yb3dzcGFuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgX2NvbC5yb3dzcGFuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gY29sO1xyXG4gICAgICAgICAgICB9KS5maWx0ZXIobiA9PiBuKVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gX2NvbHM7XHJcbiAgICB9XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmVmcmVzaEdyaWRDb2x1bW5zKGdyaWRJbnN0YW5jZTogYW55LCBuZXdDb2x1bW5zOiBhbnkpIHtcclxuICAgIGlmKCFncmlkSW5zdGFuY2UpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBncmlkSW5pdE9wdGlvbnMgPSBncmlkSW5zdGFuY2UuZGZzWydfc3RhdGUnXS5pbml0aWFsT3B0aW9ucztcclxuICAgIGlmIChuZXdDb2x1bW5zICYmIGdyaWRJbml0T3B0aW9ucykge1xyXG4gICAgICAgIGdyaWRJbnN0YW5jZS5jb2x1bW5zID0gbWVyZ2V0Q29sdW1uT3B0aW9ucyhuZXdDb2x1bW5zLCBncmlkSW5pdE9wdGlvbnMpXHJcbiAgICB9XHJcbn1cclxuXHJcbi8qKiDlsIbmjpLluo/kv6Hmga/lkIjlubbliLDliJfkuIogKi9cclxuZXhwb3J0IGZ1bmN0aW9uICBtZXJnZVNvcnRJbmZvKG5ld0NvbHVtbnM6IGFueSwgc29ydEluZm86IGFueSkge1xyXG4gICAgaWYgKHNvcnRJbmZvICYmIE9iamVjdC5rZXlzKHNvcnRJbmZvKS5sZW5ndGgpIHtcclxuICAgICAgICBjb25zdCB7IHNvcnROYW1lLCBzb3J0T3JkZXIgfSA9IHNvcnRJbmZvO1xyXG4gICAgICAgIGlmIChzb3J0TmFtZSAmJiBzb3J0TmFtZS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgbmV3Q29sdW1ucy5mb3JFYWNoKChjb2xzOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbHMuZm9yRWFjaCgoY29sOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpID0gc29ydE5hbWUuaW5kZXhPZihjb2wuZmllbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sLnNvcnRhYmxlID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sLm9yZGVyID0gc29ydE9yZGVyW2ldIHx8ICdhc2MnO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbC5vcmRlciA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG11bHRpSGVhZGVyc0hhc0RhdGFGaWVsZHMobXVsdGlIZWFkZXJDb2x1bW5zOiBhbnkpIHtcclxuICAgIGlmIChtdWx0aUhlYWRlckNvbHVtbnMgJiYgbXVsdGlIZWFkZXJDb2x1bW5zLmxlbmd0aCkge1xyXG4gICAgICAgIHJldHVybiBmbGF0dGVuKG11bHRpSGVhZGVyQ29sdW1ucykuZmlsdGVyKChuOiBhbnkpID0+IG4uZmllbGQgJiYoICFuLmNvbHNwYW4gfHwgbi5jb2xzcGFuID09PSAxKSApLmxlbmd0aDtcclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxufVxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXREYXRhRmllbGRzRm9yTXVsdGlIZWFkZXJzKGdyb3VwSGVhZGVyQ29scykge1xyXG4gICAgcmV0dXJuIGZsYXR0ZW4oZ3JvdXBIZWFkZXJDb2xzKS5maWx0ZXIoKG46IGFueSkgPT4gbi5maWVsZCAmJiAoICFuLmNvbHNwYW4gfHwgbi5jb2xzcGFuID09PSAxKSk7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY2xlYW5Hcm91cEZpZWxkcyh2aWV3Q29sczogYW55LCBncm91cEZpZWxkczogYW55KSB7XHJcbiAgICBjb25zdCBjb2xzOiBhbnkgPSBnZXREYXRhRmllbGRzRm9yTXVsdGlIZWFkZXJzKHZpZXdDb2xzKTtcclxuICAgIGNvbnN0IGdyb3VwQ29sdW1ucyA9IGdyb3VwRmllbGRzLm1hcCggZiA9PiB7XHJcbiAgICAgICAgY29uc3QgY29sID0gY29scy5maW5kKGNvbCA9PiBjb2wuZmllbGQgPT09IGYpO1xyXG4gICAgICAgIHJldHVybiBjb2w7XHJcbiAgICB9KS5maWx0ZXIobiA9PiBuKTtcclxuXHJcbiAgICByZXR1cm4gZ3JvdXBDb2x1bW5zLm1hcChuID0+IG4uZmllbGQpO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNsZWFuU29ydEZpZWxkcyh2aWV3Q29sczogYW55LCBzb3J0SW5mbzogeyBzb3J0TmFtZTogW10sIHNvcnRPcmRlcjogW10gfSkge1xyXG4gICAgY29uc3QgY29sczogYW55ID0gZ2V0RGF0YUZpZWxkc0Zvck11bHRpSGVhZGVycyh2aWV3Q29scyk7XHJcbiAgICBjb25zdCBzb3J0TmFtZXMgPSBzb3J0SW5mby5zb3J0TmFtZS5tYXAoIChmLCBpKSA9PiB7XHJcbiAgICAgICAgY29uc3QgY29sID0gY29scy5maW5kKGNvbCA9PiBjb2wuZmllbGQgPT09IGYpO1xyXG4gICAgICAgIGlmICghY29sKSB7XHJcbiAgICAgICAgICAgIHNvcnRJbmZvLnNvcnRPcmRlci5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBjb2w7XHJcbiAgICB9KS5maWx0ZXIobiA9PiBuKTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHNvcnROYW1lOiBzb3J0TmFtZXMubWFwKG4gPT4gbi5maWVsZCksXHJcbiAgICAgICAgc29ydE9yZGVyOiBzb3J0SW5mby5zb3J0T3JkZXJcclxuICAgIH07XHJcbn0iXX0=