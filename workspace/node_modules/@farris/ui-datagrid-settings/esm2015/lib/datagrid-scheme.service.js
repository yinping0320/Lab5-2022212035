/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { appendPerfixForUri, IdService } from "@farris/ui-common";
import { of, Subject } from "rxjs";
import { IS_MULTI_HEADER_STRING } from "./setting.model";
import { cloneDeep } from "lodash-es";
/**
 * 保存方案API
 * @type {?}
 */
const SCHEME_WEBAPI = '/api/runtime/sys/v1.0/querysolution';
/**
 * 获取方案列表API
 * @type {?}
 */
const SCHEME_WEBAPI_QUERY = `${SCHEME_WEBAPI}/belongId/`;
/**
 * 方案列表管理- 设默认、删除 API
 * @type {?}
 */
const SCHEME_WEBAPI_UPDATE = `${SCHEME_WEBAPI}/batch`;
/**
 * 权限验证
 * @type {?}
 */
const SCHEME_WEBAPI_Auth = '/api/runtime/sys/v1.0/querysolution/componentType/Datagrid';
/** @type {?} */
const LANGUAGE_WEBAPI = '/api/runtime/sys/v1.0/loginInfo?infoType=supportedLanguage';
export class DatagridSchemeService {
    /**
     * @param {?} inject
     */
    constructor(inject) {
        this.inject = inject;
        this.restService = null;
        this.state = {};
        this.perfixStr = '';
        this.schemeList$ = new Subject();
        this.schemeApi = {
            SCHEME_WEBAPI,
            /** 获取方案列表API */
            SCHEME_WEBAPI_QUERY,
            /** 方案列表管理- 设默认、删除 API */
            SCHEME_WEBAPI_UPDATE,
            /** 权限验证 */
            SCHEME_WEBAPI_Auth,
            LANGUAGE_WEBAPI
        };
        this.schemeKey = {};
        this.currentSchemeSettings = null;
    }
    /**
     * @param {?} perfixStr
     * @return {?}
     */
    setUriPerfix(perfixStr) {
        this.perfixStr = perfixStr || '';
    }
    /**
     * @param {?} d
     * @param {?} gridId
     * @return {?}
     */
    update(d, gridId) {
        if (!this.state[gridId]) {
            this.state[gridId] = {};
        }
        this.state[gridId] = Object.assign(this.state[gridId], d);
    }
    /**
     * @param {?} httpSer
     * @return {?}
     */
    setRestService(httpSer) {
        if (httpSer && httpSer['befRepository']) {
            this.restService = httpSer['befRepository']['restService'];
        }
    }
    /**
     * @private
     * @param {?} uri
     * @param {?} perfix
     * @return {?}
     */
    mergeUri(uri, perfix) {
        return appendPerfixForUri ? appendPerfixForUri(uri, perfix) : uri;
    }
    /**
     * @private
     * @return {?}
     */
    getWebFormKey() {
        /** @type {?} */
        const webformHash = window.location.hash.split('?')[0];
        return webformHash.substring(webformHash.lastIndexOf('/') + 1);
    }
    /**
     * @param {?} gridId
     * @return {?}
     */
    destory(gridId) {
        delete this.schemeKey[gridId];
    }
    /**
     * @param {?} gridId
     * @return {?}
     */
    getSchemeKey(gridId) {
        if (!this.schemeKey[gridId]) {
            /** @type {?} */
            const formKey = this.getWebFormKey();
            this.schemeKey[gridId] = `${formKey}_DatagridScheme_${gridId}`;
        }
        return this.schemeKey[gridId];
    }
    /**
     * @param {?} gridID
     * @param {?=} isMultiHeader
     * @return {?}
     */
    getSchemeList(gridID, isMultiHeader = false) {
        /** @type {?} */
        let uri = this.schemeApi.SCHEME_WEBAPI_QUERY + this.getBelongId(gridID, isMultiHeader);
        uri = this.mergeUri(uri, this.perfixStr);
        if (this.restService) {
            return this.restService.invoke(uri, 'GET', null, null, false);
        }
    }
    /**
     * @param {?} gridID
     * @param {?} schemeData
     * @return {?}
     */
    updateSchemeData(gridID, schemeData) {
        /** @type {?} */
        let schemeList = this.getStateValue(gridID, 'list');
        schemeList = schemeList.filter((/**
         * @param {?} n
         * @return {?}
         */
        n => n.id !== schemeData.id));
        schemeList.push(schemeData);
        this.setSchemeList(gridID, schemeList);
    }
    /**
     * @private
     * @param {?} gridID
     * @param {?=} isMultiHeader
     * @return {?}
     */
    getBelongId(gridID, isMultiHeader = false) {
        /** @type {?} */
        let id = this.getSchemeKey(gridID);
        if (isMultiHeader) {
            id = id + IS_MULTI_HEADER_STRING;
        }
        return id;
    }
    /**
     * @param {?} scheme
     * @param {?} gridID
     * @param {?=} isUpdate
     * @param {?=} isMultiHeader
     * @return {?}
     */
    saveScheme(scheme, gridID, isUpdate = false, isMultiHeader = false) {
        if (this.restService) {
            /** @type {?} */
            const httpMethod = isUpdate ? 'PUT' : 'POST';
            scheme.belongId = this.getBelongId(gridID, isMultiHeader);
            /** @type {?} */
            const uri = this.mergeUri(this.schemeApi.SCHEME_WEBAPI, this.perfixStr);
            return this.restService.invoke(uri, httpMethod, null, { body: scheme }, false);
        }
    }
    /**
     * @param {?} param
     * @param {?} gridID
     * @param {?=} isMultiHeader
     * @return {?}
     */
    updateScheme(param, gridID, isMultiHeader = false) {
        if (!param) {
            return of(false);
        }
        /** @type {?} */
        const belongId = this.getBelongId(gridID, isMultiHeader);
        param.belongId = belongId;
        if (param.belongId) {
            /** @type {?} */
            const uri = this.mergeUri(this.schemeApi.SCHEME_WEBAPI_UPDATE, this.perfixStr);
            return this.restService.invoke(uri, 'PUT', null, { body: param }, false);
        }
    }
    /**
     * @param {?} gridId
     * @param {...?} statePro
     * @return {?}
     */
    getStateValue(gridId, ...statePro) {
        /** @type {?} */
        const dgState = this.state[gridId];
        if (dgState) {
            if (statePro && statePro.length) {
                return statePro.reduce((/**
                 * @param {?} r
                 * @param {?} c
                 * @return {?}
                 */
                (r, c) => {
                    return r[c];
                }), dgState);
            }
            return dgState;
        }
        return null;
    }
    /**
     * @private
     * @param {?} gridId
     * @param {?} propertyName
     * @param {?} value
     * @return {?}
     */
    updateStateValue(gridId, propertyName, value) {
        this.update({ [propertyName]: value }, gridId);
    }
    /**
     * @param {?} gridId
     * @param {?} newSchemeList
     * @return {?}
     */
    setSchemeList(gridId, newSchemeList) {
        this.updateStateValue(gridId, 'list', newSchemeList);
        this.schemeList$.next(newSchemeList);
    }
    /**
     * @param {?} gridId
     * @param {?} schemeName
     * @return {?}
     */
    hasSchemeName(gridId, schemeName) {
        /** @type {?} */
        const schemeList = this.getStateValue(gridId, 'list');
        if (!schemeList || !schemeList.length) {
            return false;
        }
        if (typeof schemeName === 'string') {
            return !!schemeList.find((/**
             * @param {?} n
             * @return {?}
             */
            n => n.name === schemeName.trim()));
        }
        else {
            if (typeof schemeName === 'object') {
                /** @type {?} */
                const replayNames = [];
                schemeList.forEach((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => {
                    if (n.name) {
                        /** @type {?} */
                        const nameObj = JSON.parse(n.name);
                        // const currentNames = Object.values(nameObj);
                        for (let k in schemeName) {
                            if (nameObj[k] === schemeName[k]) {
                                replayNames.push(k);
                            }
                        }
                    }
                }));
                return replayNames;
            }
        }
    }
    /**
     * @return {?}
     */
    checkAuthority() {
        /** @type {?} */
        const uri = this.mergeUri(this.schemeApi.SCHEME_WEBAPI_Auth, this.perfixStr);
        return this.restService.invoke(uri, 'GET', null, null, false);
    }
    /**
     * @return {?}
     */
    getLanguages() {
        if (this.restService) {
            /** @type {?} */
            const uri = this.mergeUri(this.schemeApi.LANGUAGE_WEBAPI, this.perfixStr);
            return this.restService.invoke(uri, 'GET', null, null, false);
        }
        else {
            return of([]);
        }
    }
    /**
     * @return {?}
     */
    createSchemeTaskID() {
        /** @type {?} */
        const idService = new IdService();
        this['SCHEME_TASK_ID'] = idService.guid();
        this.currentSchemeSettings = null;
    }
    /**
     * @param {?} configs
     * @return {?}
     */
    setSettings(configs) {
        this.currentSchemeSettings = {
            taskid: this['SCHEME_TASK_ID'],
            values: cloneDeep(configs)
        };
    }
    /**
     * @return {?}
     */
    getSettings() {
        return this.currentSchemeSettings;
    }
    /**
     * @param {?} nowSettings
     * @param {?} isMultiHeader
     * @return {?}
     */
    isSchemeChanged(nowSettings, isMultiHeader) {
        let { sortInfo, viewColumns, groupField, columnFormat, expandGroupRows, multiHeaders } = nowSettings;
        let { sortInfo: sortInfo1, viewColumns: viewColumns1, groupField: groupField1, columnFormat: columnFormat1, expandGroupRows: expandGroupRows1, multiHeaders: multiHeaders1 } = this.getSettings().values;
        /** @type {?} */
        const checkSortInfo = (/**
         * @param {?} _sortInfo
         * @return {?}
         */
        (_sortInfo) => {
            if (!_sortInfo || !Object.keys(_sortInfo).length) {
                _sortInfo = {
                    sortName: [],
                    sortOrder: []
                };
            }
            return _sortInfo;
        });
        sortInfo = checkSortInfo(sortInfo);
        sortInfo1 = checkSortInfo(sortInfo1);
        /** @type {?} */
        const checkGroupField = (/**
         * @param {?} _groupField
         * @return {?}
         */
        (_groupField) => {
            if (!_groupField) {
                _groupField = [];
            }
            return _groupField;
        });
        groupField = checkGroupField(groupField);
        groupField1 = checkGroupField(groupField1);
        /** @type {?} */
        let nowconfig;
        /** @type {?} */
        let initConfig;
        if (isMultiHeader) {
            nowconfig = { sortInfo, expandGroupRows, groupField, multiHeaders };
            initConfig = { sortInfo: sortInfo1, expandGroupRows: expandGroupRows1, groupField: groupField1, multiHeaders: multiHeaders1 };
        }
        else {
            nowconfig = { columnFormat, expandGroupRows, groupField, sortInfo, viewColumns };
            initConfig = {
                columnFormat: columnFormat1,
                expandGroupRows: expandGroupRows1,
                groupField: groupField1,
                sortInfo: sortInfo1,
                viewColumns: viewColumns1
            };
        }
        /** @type {?} */
        const _clearData = (/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            return JSON.stringify(data).replace(/UNFIXED/g, '').replace(/"calculationType":-1,/g, '').replace(/"calculationType":-1/g, '');
        });
        return _clearData(nowconfig) != _clearData(initConfig);
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    DatagridSchemeService.prototype.restService;
    /**
     * @type {?}
     * @private
     */
    DatagridSchemeService.prototype.state;
    /**
     * @type {?}
     * @private
     */
    DatagridSchemeService.prototype.perfixStr;
    /** @type {?} */
    DatagridSchemeService.prototype.schemeList$;
    /**
     * @type {?}
     * @private
     */
    DatagridSchemeService.prototype.schemeApi;
    /**
     * @type {?}
     * @private
     */
    DatagridSchemeService.prototype.schemeKey;
    /**
     * @type {?}
     * @private
     */
    DatagridSchemeService.prototype.currentSchemeSettings;
    /**
     * @type {?}
     * @private
     */
    DatagridSchemeService.prototype.inject;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtc2NoZW1lLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRhdGFncmlkLXNldHRpbmdzLyIsInNvdXJjZXMiOlsibGliL2RhdGFncmlkLXNjaGVtZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFDQSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsU0FBUyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbEUsT0FBTyxFQUFjLEVBQUUsRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFL0MsT0FBTyxFQUFtRCxzQkFBc0IsRUFBOEMsTUFBTSxpQkFBaUIsQ0FBQztBQUN0SixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDOzs7OztNQUloQyxhQUFhLEdBQUcscUNBQXFDOzs7OztNQUVyRCxtQkFBbUIsR0FBRyxHQUFHLGFBQWEsWUFBWTs7Ozs7TUFFbEQsb0JBQW9CLEdBQUcsR0FBRyxhQUFhLFFBQVE7Ozs7O01BRS9DLGtCQUFrQixHQUFHLDREQUE0RDs7TUFFakYsZUFBZSxHQUFHLDREQUE0RDtBQUdwRixNQUFNLE9BQU8scUJBQXFCOzs7O0lBc0I5QixZQUFvQixNQUFnQjtRQUFoQixXQUFNLEdBQU4sTUFBTSxDQUFVO1FBckI1QixnQkFBVyxHQUFHLElBQUksQ0FBQztRQUNuQixVQUFLLEdBQWtCLEVBQUUsQ0FBQztRQUMxQixjQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLGdCQUFXLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUVwQixjQUFTLEdBQUc7WUFDaEIsYUFBYTtZQUNiLGdCQUFnQjtZQUNoQixtQkFBbUI7WUFDbkIseUJBQXlCO1lBQ3pCLG9CQUFvQjtZQUNwQixXQUFXO1lBQ1gsa0JBQWtCO1lBRWxCLGVBQWU7U0FDbEIsQ0FBQztRQUVNLGNBQVMsR0FBUSxFQUFFLENBQUM7UUFFcEIsMEJBQXFCLEdBQUcsSUFBSSxDQUFDO0lBR3JDLENBQUM7Ozs7O0lB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QkFDWCxZQUFZLEVBQUUsYUFBYTtnQkFDM0IsZUFBZSxFQUFFLGdCQUFnQjtnQkFDakMsVUFBVSxFQUFDLFdBQVc7Z0JBQ3RCLFFBQVEsRUFBRSxTQUFTO2dCQUNuQixXQUFXLEVBQUUsWUFBWTthQUM1QixDQUFDO1NBQ0w7O2NBRUssVUFBVTs7OztRQUFHLENBQUMsSUFBSSxFQUFFLEVBQUU7WUFDeEIsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLHdCQUF3QixFQUFFLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyx1QkFBdUIsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNuSSxDQUFDLENBQUE7UUFFRCxPQUFPLFVBQVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDM0QsQ0FBQztDQUNKOzs7Ozs7SUFoUEcsNENBQTJCOzs7OztJQUMzQixzQ0FBa0M7Ozs7O0lBQ2xDLDBDQUF1Qjs7SUFDdkIsNENBQTRCOzs7OztJQUU1QiwwQ0FVRTs7Ozs7SUFFRiwwQ0FBNEI7Ozs7O0lBRTVCLHNEQUFxQzs7Ozs7SUFFekIsdUNBQXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0b3IgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBhcHBlbmRQZXJmaXhGb3JVcmksIElkU2VydmljZSB9IGZyb20gXCJAZmFycmlzL3VpLWNvbW1vblwiO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgU3ViamVjdCB9IGZyb20gXCJyeGpzXCI7XHJcbmltcG9ydCB7IG1hcCB9IGZyb20gXCJyeGpzL29wZXJhdG9yc1wiO1xyXG5pbXBvcnQgeyBCYXRjaFNjaGVtZSwgRGF0YWdyaWRTY2hlbWVNb2RlbCwgRGdTY2hlbWVTdGF0ZSwgSVNfTVVMVElfSEVBREVSX1NUUklORywgU2NoZW1lQXV0aE1vZGVsLCBTY2hlbWVTdGF0ZSwgU2V0dGluZ01vZGVsIH0gZnJvbSBcIi4vc2V0dGluZy5tb2RlbFwiO1xyXG5pbXBvcnQgeyBjbG9uZURlZXAgfSBmcm9tIFwibG9kYXNoLWVzXCI7XHJcblxyXG5cclxuLyoqIOS/neWtmOaWueahiEFQSSAqL1xyXG5jb25zdCBTQ0hFTUVfV0VCQVBJID0gJy9hcGkvcnVudGltZS9zeXMvdjEuMC9xdWVyeXNvbHV0aW9uJztcclxuLyoqIOiOt+WPluaWueahiOWIl+ihqEFQSSAqL1xyXG5jb25zdCBTQ0hFTUVfV0VCQVBJX1FVRVJZID0gYCR7U0NIRU1FX1dFQkFQSX0vYmVsb25nSWQvYDtcclxuLyoqIOaWueahiOWIl+ihqOeuoeeQhi0g6K6+6buY6K6k44CB5Yig6ZmkIEFQSSAqL1xyXG5jb25zdCBTQ0hFTUVfV0VCQVBJX1VQREFURSA9IGAke1NDSEVNRV9XRUJBUEl9L2JhdGNoYDtcclxuLyoqIOadg+mZkOmqjOivgSAqL1xyXG5jb25zdCBTQ0hFTUVfV0VCQVBJX0F1dGggPSAnL2FwaS9ydW50aW1lL3N5cy92MS4wL3F1ZXJ5c29sdXRpb24vY29tcG9uZW50VHlwZS9EYXRhZ3JpZCc7XHJcblxyXG5jb25zdCBMQU5HVUFHRV9XRUJBUEkgPSAnL2FwaS9ydW50aW1lL3N5cy92MS4wL2xvZ2luSW5mbz9pbmZvVHlwZT1zdXBwb3J0ZWRMYW5ndWFnZSc7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIERhdGFncmlkU2NoZW1lU2VydmljZSB7XHJcbiAgICBwcml2YXRlIHJlc3RTZXJ2aWNlID0gbnVsbDtcclxuICAgIHByaXZhdGUgc3RhdGU6IERnU2NoZW1lU3RhdGUgPSB7fTtcclxuICAgIHByaXZhdGUgcGVyZml4U3RyID0gJyc7XHJcbiAgICBzY2hlbWVMaXN0JCA9IG5ldyBTdWJqZWN0KCk7XHJcblxyXG4gICAgcHJpdmF0ZSBzY2hlbWVBcGkgPSB7XHJcbiAgICAgICAgU0NIRU1FX1dFQkFQSSxcclxuICAgICAgICAvKiog6I635Y+W5pa55qGI5YiX6KGoQVBJICovXHJcbiAgICAgICAgU0NIRU1FX1dFQkFQSV9RVUVSWSxcclxuICAgICAgICAvKiog5pa55qGI5YiX6KGo566h55CGLSDorr7pu5jorqTjgIHliKDpmaQgQVBJICovXHJcbiAgICAgICAgU0NIRU1FX1dFQkFQSV9VUERBVEUsXHJcbiAgICAgICAgLyoqIOadg+mZkOmqjOivgSAqL1xyXG4gICAgICAgIFNDSEVNRV9XRUJBUElfQXV0aCxcclxuXHJcbiAgICAgICAgTEFOR1VBR0VfV0VCQVBJXHJcbiAgICB9O1xyXG5cclxuICAgIHByaXZhdGUgc2NoZW1lS2V5OiBhbnkgPSB7fTtcclxuXHJcbiAgICBwcml2YXRlIGN1cnJlbnRTY2hlbWVTZXR0aW5ncyA9IG51bGw7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3Q6IEluamVjdG9yKSB7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0VXJpUGVyZml4KHBlcmZpeFN0cjogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5wZXJmaXhTdHIgPSBwZXJmaXhTdHIgfHwgJyc7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlKGQ6IFNjaGVtZVN0YXRlLCBncmlkSWQ6IHN0cmluZykge1xyXG4gICAgICAgIGlmICghdGhpcy5zdGF0ZVtncmlkSWRdKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3RhdGVbZ3JpZElkXSA9IHt9O1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnN0YXRlW2dyaWRJZF0gPSBPYmplY3QuYXNzaWduKHRoaXMuc3RhdGVbZ3JpZElkXSwgZCk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0UmVzdFNlcnZpY2UoaHR0cFNlcjogYW55KSB7XHJcbiAgICAgICAgaWYgKGh0dHBTZXIgJiYgaHR0cFNlclsnYmVmUmVwb3NpdG9yeSddKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVzdFNlcnZpY2UgPSBodHRwU2VyWydiZWZSZXBvc2l0b3J5J11bJ3Jlc3RTZXJ2aWNlJ107XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbWVyZ2VVcmkodXJpLCBwZXJmaXgpIHtcclxuICAgICAgICByZXR1cm4gYXBwZW5kUGVyZml4Rm9yVXJpID8gYXBwZW5kUGVyZml4Rm9yVXJpKHVyaSwgcGVyZml4KTogdXJpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0V2ViRm9ybUtleSgpIHtcclxuICAgICAgICBjb25zdCB3ZWJmb3JtSGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnNwbGl0KCc/JylbMF07XHJcbiAgICAgICAgcmV0dXJuIHdlYmZvcm1IYXNoLnN1YnN0cmluZyh3ZWJmb3JtSGFzaC5sYXN0SW5kZXhPZignLycpICsgMSk7XHJcbiAgICB9XHJcblxyXG4gICAgZGVzdG9yeShncmlkSWQ6IHN0cmluZykge1xyXG4gICAgICAgIGRlbGV0ZSB0aGlzLnNjaGVtZUtleVtncmlkSWRdO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFNjaGVtZUtleShncmlkSWQ6IHN0cmluZykge1xyXG4gICAgICAgIGlmICghdGhpcy5zY2hlbWVLZXlbZ3JpZElkXSkge1xyXG4gICAgICAgICAgICBjb25zdCBmb3JtS2V5ID0gdGhpcy5nZXRXZWJGb3JtS2V5KCk7XHJcbiAgICAgICAgICAgIHRoaXMuc2NoZW1lS2V5W2dyaWRJZF0gPSBgJHtmb3JtS2V5fV9EYXRhZ3JpZFNjaGVtZV8ke2dyaWRJZH1gO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5zY2hlbWVLZXlbZ3JpZElkXTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRTY2hlbWVMaXN0KGdyaWRJRDogc3RyaW5nLCBpc011bHRpSGVhZGVyID0gZmFsc2UpOiBPYnNlcnZhYmxlPERhdGFncmlkU2NoZW1lTW9kZWxbXT4ge1xyXG4gICAgICAgIGxldCB1cmkgPSB0aGlzLnNjaGVtZUFwaS5TQ0hFTUVfV0VCQVBJX1FVRVJZICsgdGhpcy5nZXRCZWxvbmdJZChncmlkSUQsIGlzTXVsdGlIZWFkZXIpO1xyXG4gICAgICAgIHVyaSA9IHRoaXMubWVyZ2VVcmkodXJpLCB0aGlzLnBlcmZpeFN0cik7XHJcbiAgICAgICAgaWYgKHRoaXMucmVzdFNlcnZpY2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuaW52b2tlKHVyaSwgJ0dFVCcsIG51bGwsIG51bGwsIGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlU2NoZW1lRGF0YShncmlkSUQ6IHN0cmluZywgc2NoZW1lRGF0YSkge1xyXG4gICAgICAgIGxldCBzY2hlbWVMaXN0ID0gdGhpcy5nZXRTdGF0ZVZhbHVlKGdyaWRJRCwgJ2xpc3QnKTtcclxuICAgICAgICBzY2hlbWVMaXN0ID0gc2NoZW1lTGlzdC5maWx0ZXIobiA9PiBuLmlkICE9PSBzY2hlbWVEYXRhLmlkKTtcclxuICAgICAgICBzY2hlbWVMaXN0LnB1c2goc2NoZW1lRGF0YSk7XHJcbiAgICAgICAgdGhpcy5zZXRTY2hlbWVMaXN0KGdyaWRJRCwgc2NoZW1lTGlzdCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRCZWxvbmdJZChncmlkSUQ6IHN0cmluZywgaXNNdWx0aUhlYWRlciA9IGZhbHNlKSB7XHJcbiAgICAgICAgbGV0IGlkID0gdGhpcy5nZXRTY2hlbWVLZXkoZ3JpZElEKTtcclxuICAgICAgICBpZiAoaXNNdWx0aUhlYWRlcikge1xyXG4gICAgICAgICAgICBpZCA9IGlkICsgSVNfTVVMVElfSEVBREVSX1NUUklORztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBpZDtcclxuICAgIH1cclxuXHJcbiAgICBzYXZlU2NoZW1lKHNjaGVtZTogRGF0YWdyaWRTY2hlbWVNb2RlbCwgZ3JpZElEOiBzdHJpbmcsIGlzVXBkYXRlID0gZmFsc2UsIGlzTXVsdGlIZWFkZXIgPSBmYWxzZSkge1xyXG4gICAgICAgIGlmICh0aGlzLnJlc3RTZXJ2aWNlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGh0dHBNZXRob2QgPSBpc1VwZGF0ZSA/ICdQVVQnOiAnUE9TVCc7XHJcbiAgICAgICAgICAgIHNjaGVtZS5iZWxvbmdJZCA9IHRoaXMuZ2V0QmVsb25nSWQoZ3JpZElELCBpc011bHRpSGVhZGVyKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHVyaSA9IHRoaXMubWVyZ2VVcmkodGhpcy5zY2hlbWVBcGkuU0NIRU1FX1dFQkFQSSwgdGhpcy5wZXJmaXhTdHIpO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5pbnZva2UodXJpLCBodHRwTWV0aG9kLCBudWxsLCB7IGJvZHk6IHNjaGVtZX0sIGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlU2NoZW1lKHBhcmFtOiBCYXRjaFNjaGVtZSwgZ3JpZElEOiBzdHJpbmcsIGlzTXVsdGlIZWFkZXIgPSBmYWxzZSk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICAgICAgaWYgKCFwYXJhbSkge1xyXG4gICAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBiZWxvbmdJZCA9IHRoaXMuZ2V0QmVsb25nSWQoZ3JpZElELCBpc011bHRpSGVhZGVyKTtcclxuICAgICAgICBwYXJhbS5iZWxvbmdJZCA9IGJlbG9uZ0lkXHJcblxyXG4gICAgICAgIGlmIChwYXJhbS5iZWxvbmdJZCkge1xyXG4gICAgICAgICAgICBjb25zdCB1cmkgPSB0aGlzLm1lcmdlVXJpKHRoaXMuc2NoZW1lQXBpLlNDSEVNRV9XRUJBUElfVVBEQVRFLCB0aGlzLnBlcmZpeFN0cik7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlc3RTZXJ2aWNlLmludm9rZSh1cmksICdQVVQnLCBudWxsLCB7Ym9keTogcGFyYW19LCBmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldFN0YXRlVmFsdWUoZ3JpZElkLCAuLi5zdGF0ZVBybykge1xyXG4gICAgICAgIGNvbnN0IGRnU3RhdGUgPSB0aGlzLnN0YXRlW2dyaWRJZF07XHJcbiAgICAgICAgaWYgKGRnU3RhdGUpIHtcclxuICAgICAgICAgICAgaWYgKHN0YXRlUHJvICYmIHN0YXRlUHJvLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlUHJvLnJlZHVjZSgociwgYykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByW2NdO1xyXG4gICAgICAgICAgICAgICAgfSwgZGdTdGF0ZSlcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIGRnU3RhdGU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdXBkYXRlU3RhdGVWYWx1ZShncmlkSWQsIHByb3BlcnR5TmFtZSwgdmFsdWUpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZSh7W3Byb3BlcnR5TmFtZV06IHZhbHVlfSwgZ3JpZElkKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRTY2hlbWVMaXN0KGdyaWRJZCwgbmV3U2NoZW1lTGlzdCkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlU3RhdGVWYWx1ZShncmlkSWQsICdsaXN0JywgbmV3U2NoZW1lTGlzdCk7XHJcbiAgICAgICAgdGhpcy5zY2hlbWVMaXN0JC5uZXh0KG5ld1NjaGVtZUxpc3QpO1xyXG4gICAgfVxyXG5cclxuICAgIGhhc1NjaGVtZU5hbWUoZ3JpZElkLCBzY2hlbWVOYW1lOiBhbnkpIHtcclxuICAgICAgICBjb25zdCBzY2hlbWVMaXN0ID0gdGhpcy5nZXRTdGF0ZVZhbHVlKGdyaWRJZCwgJ2xpc3QnKTtcclxuICAgICAgICBpZiAoIXNjaGVtZUxpc3QgfHwgIXNjaGVtZUxpc3QubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0eXBlb2Ygc2NoZW1lTmFtZSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgcmV0dXJuICEhc2NoZW1lTGlzdC5maW5kKG4gPT4gbi5uYW1lID09PSBzY2hlbWVOYW1lLnRyaW0oKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBzY2hlbWVOYW1lID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVwbGF5TmFtZXMgPSBbXTtcclxuICAgICAgICAgICAgICAgIHNjaGVtZUxpc3QuZm9yRWFjaChuID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobi5uYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWVPYmogPSBKU09OLnBhcnNlKG4ubmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnN0IGN1cnJlbnROYW1lcyA9IE9iamVjdC52YWx1ZXMobmFtZU9iaik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgayBpbiBzY2hlbWVOYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmFtZU9ialtrXSA9PT0gc2NoZW1lTmFtZVtrXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxheU5hbWVzLnB1c2goayk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVwbGF5TmFtZXM7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY2hlY2tBdXRob3JpdHkoKTogT2JzZXJ2YWJsZTxTY2hlbWVBdXRoTW9kZWw+IHtcclxuICAgICAgICBjb25zdCB1cmkgPSB0aGlzLm1lcmdlVXJpKHRoaXMuc2NoZW1lQXBpLlNDSEVNRV9XRUJBUElfQXV0aCwgdGhpcy5wZXJmaXhTdHIpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLnJlc3RTZXJ2aWNlLmludm9rZSh1cmksICdHRVQnLCBudWxsLCBudWxsLCBmYWxzZSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0TGFuZ3VhZ2VzKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnJlc3RTZXJ2aWNlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHVyaSA9IHRoaXMubWVyZ2VVcmkodGhpcy5zY2hlbWVBcGkuTEFOR1VBR0VfV0VCQVBJLCB0aGlzLnBlcmZpeFN0cik7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlc3RTZXJ2aWNlLmludm9rZSh1cmksICdHRVQnLCBudWxsLCBudWxsLCBmYWxzZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9mKFtdKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY3JlYXRlU2NoZW1lVGFza0lEKCkge1xyXG4gICAgICAgIGNvbnN0IGlkU2VydmljZTogSWRTZXJ2aWNlID0gbmV3IElkU2VydmljZSgpO1xyXG4gICAgICAgIHRoaXNbJ1NDSEVNRV9UQVNLX0lEJ10gPSBpZFNlcnZpY2UuZ3VpZCgpO1xyXG4gICAgICAgIHRoaXMuY3VycmVudFNjaGVtZVNldHRpbmdzID0gbnVsbDtcclxuICAgIH1cclxuXHJcblxyXG4gICAgc2V0U2V0dGluZ3MoY29uZmlnczogYW55KSB7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50U2NoZW1lU2V0dGluZ3MgPSB7XHJcbiAgICAgICAgICAgIHRhc2tpZDogdGhpc1snU0NIRU1FX1RBU0tfSUQnXSxcclxuICAgICAgICAgICAgdmFsdWVzOiBjbG9uZURlZXAoY29uZmlncylcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U2V0dGluZ3MoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFNjaGVtZVNldHRpbmdzO1xyXG4gICAgfVxyXG5cclxuICAgIGlzU2NoZW1lQ2hhbmdlZChub3dTZXR0aW5nczogU2V0dGluZ01vZGVsLCBpc011bHRpSGVhZGVyOiBib29sZWFuKSA6IGJvb2xlYW4ge1xyXG4gICAgICAgIGxldCB7IHNvcnRJbmZvLCB2aWV3Q29sdW1ucywgZ3JvdXBGaWVsZCwgY29sdW1uRm9ybWF0LCBleHBhbmRHcm91cFJvd3MsIG11bHRpSGVhZGVycyB9ID0gbm93U2V0dGluZ3M7XHJcbiAgICAgICAgbGV0IHsgc29ydEluZm86IHNvcnRJbmZvMSwgdmlld0NvbHVtbnM6IHZpZXdDb2x1bW5zMSwgZ3JvdXBGaWVsZDogZ3JvdXBGaWVsZDEsIGNvbHVtbkZvcm1hdDogY29sdW1uRm9ybWF0MSwgZXhwYW5kR3JvdXBSb3dzOiBleHBhbmRHcm91cFJvd3MxLCBtdWx0aUhlYWRlcnM6IG11bHRpSGVhZGVyczEgfSA9IHRoaXMuZ2V0U2V0dGluZ3MoKS52YWx1ZXM7XHJcblxyXG4gICAgICAgIGNvbnN0IGNoZWNrU29ydEluZm8gPSAoX3NvcnRJbmZvKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICghX3NvcnRJbmZvIHx8ICFPYmplY3Qua2V5cyhfc29ydEluZm8pLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgX3NvcnRJbmZvID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHNvcnROYW1lOiBbXSxcclxuICAgICAgICAgICAgICAgICAgICBzb3J0T3JkZXI6IFtdXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gX3NvcnRJbmZvO1xyXG4gICAgICAgIH1cclxuICAgICAgICBzb3J0SW5mbyA9IGNoZWNrU29ydEluZm8oc29ydEluZm8pO1xyXG4gICAgICAgIHNvcnRJbmZvMSA9IGNoZWNrU29ydEluZm8oc29ydEluZm8xKTtcclxuXHJcbiAgICAgICAgY29uc3QgY2hlY2tHcm91cEZpZWxkID0gKF9ncm91cEZpZWxkKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICghX2dyb3VwRmllbGQpIHtcclxuICAgICAgICAgICAgICAgIF9ncm91cEZpZWxkID0gW107XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIF9ncm91cEZpZWxkO1xyXG4gICAgICAgIH1cclxuICAgICAgICBncm91cEZpZWxkID0gY2hlY2tHcm91cEZpZWxkKGdyb3VwRmllbGQpO1xyXG4gICAgICAgIGdyb3VwRmllbGQxID0gY2hlY2tHcm91cEZpZWxkKGdyb3VwRmllbGQxKTtcclxuXHJcblxyXG4gICAgICAgIGxldCBub3djb25maWcsIGluaXRDb25maWc7XHJcbiAgICAgICAgaWYgKGlzTXVsdGlIZWFkZXIpIHtcclxuICAgICAgICAgICAgbm93Y29uZmlnID0gIHsgc29ydEluZm8sIGV4cGFuZEdyb3VwUm93cywgZ3JvdXBGaWVsZCwgbXVsdGlIZWFkZXJzIH07XHJcbiAgICAgICAgICAgIGluaXRDb25maWcgID0gIHsgc29ydEluZm86IHNvcnRJbmZvMSwgZXhwYW5kR3JvdXBSb3dzOiBleHBhbmRHcm91cFJvd3MxLCBncm91cEZpZWxkOmdyb3VwRmllbGQxLCBtdWx0aUhlYWRlcnM6IG11bHRpSGVhZGVyczEgfTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBub3djb25maWcgPSAgeyBjb2x1bW5Gb3JtYXQsZXhwYW5kR3JvdXBSb3dzLGdyb3VwRmllbGQsIHNvcnRJbmZvLCB2aWV3Q29sdW1ucyB9O1xyXG4gICAgICAgICAgICBpbml0Q29uZmlnICA9ICB7IFxyXG4gICAgICAgICAgICAgICAgY29sdW1uRm9ybWF0OiBjb2x1bW5Gb3JtYXQxLFxyXG4gICAgICAgICAgICAgICAgZXhwYW5kR3JvdXBSb3dzOiBleHBhbmRHcm91cFJvd3MxLCBcclxuICAgICAgICAgICAgICAgIGdyb3VwRmllbGQ6Z3JvdXBGaWVsZDEsXHJcbiAgICAgICAgICAgICAgICBzb3J0SW5mbzogc29ydEluZm8xLFxyXG4gICAgICAgICAgICAgICAgdmlld0NvbHVtbnM6IHZpZXdDb2x1bW5zMVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgX2NsZWFyRGF0YSA9IChkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShkYXRhKS5yZXBsYWNlKC9VTkZJWEVEL2csICcnKS5yZXBsYWNlKC9cImNhbGN1bGF0aW9uVHlwZVwiOi0xLC9nLCAnJykucmVwbGFjZSgvXCJjYWxjdWxhdGlvblR5cGVcIjotMS9nLCAnJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gX2NsZWFyRGF0YShub3djb25maWcpICE9IF9jbGVhckRhdGEoaW5pdENvbmZpZyk7XHJcbiAgICB9XHJcbn1cclxuIl19