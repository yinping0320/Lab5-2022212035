/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ComponentFactoryResolver, EventEmitter, Injectable, Injector, LOCALE_ID } from '@angular/core';
import { BsModalService } from '@farris/ui-modal';
import { LocaleService } from '@farris/ui-locale';
import { FeatureEditorComponent } from './feature-editor.component';
import { I18nService } from './i18n-service';
import { isObservable, of } from 'rxjs';
import { EventManager } from '@angular/platform-browser';
export class FeatureEditorService {
    /**
     * @param {?} injector
     * @param {?} modalService
     * @param {?} componentFactoryResolver
     * @param {?} localeService
     * @param {?} languageService
     */
    constructor(injector, modalService, componentFactoryResolver, localeService, languageService) {
        this.injector = injector;
        this.modalService = modalService;
        this.componentFactoryResolver = componentFactoryResolver;
        this.localeService = localeService;
        this.languageService = languageService;
        this.dialog = null;
        this.componentRef = null;
        this.keyDownHandler = null;
        this.onUserConfirmed = new EventEmitter();
        if (!this.languageService) {
            /** @type {?} */
            const localeId = this.injector.get(LOCALE_ID, 'zh-CHS');
            this.languageService = new I18nService(localeId);
        }
        this.eventManager = this.injector.get(EventManager, null);
    }
    /**
     * 弹出特性编辑器
     * @param {?} features 特征数组
     * @param {?=} options 弹窗配置
     * @return {?}
     */
    show(features, options) {
        if (!features || features.length < 1) {
            return;
        }
        this.canOpen(options).subscribe((/**
         * @param {?} canOpen
         * @return {?}
         */
        (canOpen) => {
            if (!canOpen) {
                return;
            }
            /** @type {?} */
            const componentFactory = this.componentFactoryResolver.resolveComponentFactory(FeatureEditorComponent);
            this.componentRef = componentFactory.create(this.injector);
            this.componentRef.instance.features = features;
            /** @type {?} */
            const titleText = this.languageService.title;
            /** @type {?} */
            const okText = this.localeService.getValue('batchEditDialog.okText');
            /** @type {?} */
            const cancelText = this.localeService.getValue('batchEditDialog.cancelText');
            const { width = 470, height = 500, title = titleText } = options || {};
            /** @type {?} */
            const modalOptions = {
                title,
                width,
                height,
                buttons: [
                    {
                        text: cancelText, cls: 'btn btn-secondary', handle: (/**
                         * @return {?}
                         */
                        () => {
                            this.dialog.close();
                        })
                    },
                    {
                        text: okText, cls: 'btn btn-primary',
                        handle: (/**
                         * @return {?}
                         */
                        () => {
                            this.onConfirmClick(options);
                        })
                    }
                ],
                showButtons: true,
                areaResponse: true,
                opened: (/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                    this.registerShortcutKey(options, e.instance);
                }),
                closed: (/**
                 * @return {?}
                 */
                () => {
                    if (this.keyDownHandler) {
                        this.keyDownHandler();
                        this.keyDownHandler = null;
                    }
                })
            };
            this.dialog = this.modalService.show(this.componentRef, modalOptions);
        }));
    }
    /**
     * @private
     * @param {?} options
     * @param {?} dialogRef
     * @return {?}
     */
    registerShortcutKey(options, dialogRef) {
        // 回车，与确定按钮处理逻辑一至。
        /** @type {?} */
        const dlgContainerDom = dialogRef.dialog.location.nativeElement;
        if (dlgContainerDom && !this.keyDownHandler) {
            this.keyDownHandler = this.eventManager.addEventListener(dlgContainerDom, 'keydown', (/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                e.stopPropagation();
                if (e.key === 'Enter') {
                    // if (e.target['nodeName'] === 'INPUT' && !e.ctrlKey) {
                    //     return;
                    // }
                    this.onConfirmClick(options);
                }
                else if (e.key === 'Escape') {
                    this.dialog.close();
                }
                else if (e.key === 'Tab') {
                    this.onTabKeydownHandler(e.target);
                }
            }));
        }
        if (this.componentRef) {
            this.setFirstInputFocus();
        }
    }
    /**
     * @private
     * @return {?}
     */
    setFirstInputFocus() {
        /** @type {?} */
        const firstInputEl = this.componentRef.location.nativeElement.querySelector('input,textarea');
        if (firstInputEl) {
            firstInputEl.focus();
        }
    }
    /**
     * @private
     * @param {?} currentTarget
     * @return {?}
     */
    onTabKeydownHandler(currentTarget) {
        /** @type {?} */
        let allInputs = this.componentRef.location.nativeElement.querySelectorAll('input,textarea');
        allInputs = Array.from(allInputs);
        /** @type {?} */
        const currentInputIndex = allInputs.findIndex((/**
         * @param {?} n
         * @return {?}
         */
        n => n === currentTarget));
        /** @type {?} */
        let nextInputIndex = currentInputIndex + 1;
        if (nextInputIndex >= allInputs.length) {
            nextInputIndex = 0;
        }
        /** @type {?} */
        const nextInputTarget = allInputs[nextInputIndex];
        if (nextInputTarget) {
            setTimeout((/**
             * @return {?}
             */
            () => {
                nextInputTarget.focus();
            }));
        }
    }
    /**
     * 用户点击确认按钮
     * @private
     * @param {?=} options
     * @return {?}
     */
    onConfirmClick(options) {
        this.canClose(options).subscribe((/**
         * @param {?} result
         * @return {?}
         */
        (result) => {
            if (result === true) {
                this.onConfirm(options);
            }
        }));
    }
    /**
     * 确认
     * @private
     * @param {?=} options options
     * @return {?}
     */
    onConfirm(options) {
        /** @type {?} */
        const features = this.componentRef && this.componentRef.instance && this.componentRef.instance.features || [];
        this.dialog.close();
        if (options.onConfirm && typeof options.onConfirm) {
            options.onConfirm(features);
        }
        this.onUserConfirmed.next(features);
    }
    /**
     * 是否可以关闭
     * @private
     * @param {?=} options options
     * @return {?}
     */
    canClose(options) {
        /** @type {?} */
        const features = this.componentRef && this.componentRef.instance && this.componentRef.instance.features || [];
        /** @type {?} */
        const onConfirmingRef = options && options.onConfirming || null;
        if (!onConfirmingRef) {
            return of(true);
        }
        // 有确认前事件
        /** @type {?} */
        const onConfirming = onConfirmingRef(features);
        if (isObservable(onConfirming)) {
            return onConfirming;
        }
        else {
            return of(onConfirming);
        }
    }
    /**
     * 是否可以弹出特性编辑器
     * @private
     * @param {?=} options options
     * @return {?}
     */
    canOpen(options) {
        /** @type {?} */
        const onOpeningHandlerRef = options && options.onOpening || null;
        if (!onOpeningHandlerRef) {
            return of(true);
        }
        /** @type {?} */
        const onOpeningHandler = onOpeningHandlerRef(options);
        if (isObservable(onOpeningHandler)) {
            return onOpeningHandler;
        }
        else {
            return of(onOpeningHandler);
        }
    }
}
FeatureEditorService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
FeatureEditorService.ctorParameters = () => [
    { type: Injector },
    { type: BsModalService },
    { type: ComponentFactoryResolver },
    { type: LocaleService },
    { type: I18nService }
];
if (false) {
    /** @type {?} */
    FeatureEditorService.prototype.dialog;
    /**
     * @type {?}
     * @private
     */
    FeatureEditorService.prototype.componentRef;
    /**
     * @type {?}
     * @private
     */
    FeatureEditorService.prototype.keyDownHandler;
    /** @type {?} */
    FeatureEditorService.prototype.onUserConfirmed;
    /**
     * @type {?}
     * @private
     */
    FeatureEditorService.prototype.eventManager;
    /** @type {?} */
    FeatureEditorService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    FeatureEditorService.prototype.modalService;
    /**
     * @type {?}
     * @private
     */
    FeatureEditorService.prototype.componentFactoryResolver;
    /**
     * @type {?}
     * @private
     */
    FeatureEditorService.prototype.localeService;
    /**
     * @type {?}
     * @private
     */
    FeatureEditorService.prototype.languageService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmVhdHVyZS1lZGl0b3Iuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZmVhdHVyZS1lZGl0b3IvIiwic291cmNlcyI6WyJsaWIvZmVhdHVyZS1lZGl0b3Iuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLHdCQUF3QixFQUFnQixZQUFZLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdEgsT0FBTyxFQUFFLGNBQWMsRUFBYyxNQUFNLGtCQUFrQixDQUFDO0FBQzlELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUVsRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0MsT0FBTyxFQUFFLFlBQVksRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDcEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBR3pELE1BQU0sT0FBTyxvQkFBb0I7Ozs7Ozs7O0lBTTdCLFlBQ1csUUFBa0IsRUFDakIsWUFBNEIsRUFDNUIsd0JBQWtELEVBQ2xELGFBQTRCLEVBQzVCLGVBQTRCO1FBSjdCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDakIsaUJBQVksR0FBWixZQUFZLENBQWdCO1FBQzVCLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsb0JBQWUsR0FBZixlQUFlLENBQWE7UUFWakMsV0FBTSxHQUFlLElBQUksQ0FBQztRQUN6QixpQkFBWSxHQUF5QyxJQUFJLENBQUM7UUFDMUQsbUJBQWMsR0FBRyxJQUFJLENBQUM7UUFDOUIsb0JBQWUsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQVN6RCxJQUFJLENBQUMsSUFBSSxDQUFDLGVB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QUUvQix3Q0FBeUI7Ozs7O0lBQ3pCLDRDQUFvQzs7Ozs7SUFDcEMsd0RBQTBEOzs7OztJQUMxRCw2Q0FBb0M7Ozs7O0lBQ3BDLCtDQUFvQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgQ29tcG9uZW50UmVmLCBFdmVudEVtaXR0ZXIsIEluamVjdGFibGUsIEluamVjdG9yLCBMT0NBTEVfSUQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQnNNb2RhbFNlcnZpY2UsIEJzTW9kYWxSZWYgfSBmcm9tICdAZmFycmlzL3VpLW1vZGFsJztcclxuaW1wb3J0IHsgTG9jYWxlU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbG9jYWxlJztcclxuaW1wb3J0IHsgSUZlYXR1cmUsIElGZWF0dXJlRWRpdG9yT3B0aW9ucyB9IGZyb20gJy4vdHlwZSc7XHJcbmltcG9ydCB7IEZlYXR1cmVFZGl0b3JDb21wb25lbnQgfSBmcm9tICcuL2ZlYXR1cmUtZWRpdG9yLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IEkxOG5TZXJ2aWNlIH0gZnJvbSAnLi9pMThuLXNlcnZpY2UnO1xyXG5pbXBvcnQgeyBpc09ic2VydmFibGUsIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IEV2ZW50TWFuYWdlciB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRmVhdHVyZUVkaXRvclNlcnZpY2Uge1xyXG4gICAgcHVibGljIGRpYWxvZzogQnNNb2RhbFJlZiA9IG51bGw7XHJcbiAgICBwcml2YXRlIGNvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPEZlYXR1cmVFZGl0b3JDb21wb25lbnQ+ID0gbnVsbDtcclxuICAgIHByaXZhdGUga2V5RG93bkhhbmRsZXIgPSBudWxsO1xyXG4gICAgb25Vc2VyQ29uZmlybWVkOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG4gICAgcHJpdmF0ZSBldmVudE1hbmFnZXI6IEV2ZW50TWFuYWdlcjtcclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHB1YmxpYyBpbmplY3RvcjogSW5qZWN0b3IsXHJcbiAgICAgICAgcHJpdmF0ZSBtb2RhbFNlcnZpY2U6IEJzTW9kYWxTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICAgICAgcHJpdmF0ZSBsb2NhbGVTZXJ2aWNlOiBMb2NhbGVTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBJMThuU2VydmljZVxyXG4gICAgKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmxhbmd1YWdlU2VydmljZSkge1xyXG4gICAgICAgICAgICBjb25zdCBsb2NhbGVJZCA9IHRoaXMuaW5qZWN0b3IuZ2V0PHN0cmluZz4oTE9DQUxFX0lELCAnemgtQ0hTJyk7XHJcbiAgICAgICAgICAgIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlID0gbmV3IEkxOG5TZXJ2aWNlKGxvY2FsZUlkKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuZXZlbnRNYW5hZ2VyID0gdGhpcy5pbmplY3Rvci5nZXQoRXZlbnRNYW5hZ2VyLCBudWxsKTtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog5by55Ye654m55oCn57yW6L6R5ZmoXHJcbiAgICAgKiBAcGFyYW0gZmVhdHVyZXMg54m55b6B5pWw57uEXHJcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyDlvLnnqpfphY3nva5cclxuICAgICAqIEByZXR1cm5zIFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgc2hvdyhmZWF0dXJlczogQXJyYXk8SUZlYXR1cmU+LCBvcHRpb25zPzogSUZlYXR1cmVFZGl0b3JPcHRpb25zKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKCFmZWF0dXJlcyB8fCBmZWF0dXJlcy5sZW5ndGggPCAxKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jYW5PcGVuKG9wdGlvbnMpLnN1YnNjcmliZSgoY2FuT3BlbjogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIWNhbk9wZW4pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBjb21wb25lbnRGYWN0b3J5ID0gdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoRmVhdHVyZUVkaXRvckNvbXBvbmVudCk7XHJcbiAgICAgICAgICAgIHRoaXMuY29tcG9uZW50UmVmID0gY29tcG9uZW50RmFjdG9yeS5jcmVhdGUodGhpcy5pbmplY3Rvcik7XHJcbiAgICAgICAgICAgIHRoaXMuY29tcG9uZW50UmVmLmluc3RhbmNlLmZlYXR1cmVzID0gZmVhdHVyZXM7XHJcbiAgICAgICAgICAgIGNvbnN0IHRpdGxlVGV4dCA9IHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnRpdGxlO1xyXG4gICAgICAgICAgICBjb25zdCBva1RleHQgPSB0aGlzLmxvY2FsZVNlcnZpY2UuZ2V0VmFsdWUoJ2JhdGNoRWRpdERpYWxvZy5va1RleHQnKTtcclxuICAgICAgICAgICAgY29uc3QgY2FuY2VsVGV4dCA9IHRoaXMubG9jYWxlU2VydmljZS5nZXRWYWx1ZSgnYmF0Y2hFZGl0RGlhbG9nLmNhbmNlbFRleHQnKTtcclxuICAgICAgICAgICAgY29uc3QgeyB3aWR0aCA9IDQ3MCwgaGVpZ2h0ID0gNTAwLCB0aXRsZSA9IHRpdGxlVGV4dCB9ID0gb3B0aW9ucyB8fCB7fTtcclxuICAgICAgICAgICAgY29uc3QgbW9kYWxPcHRpb25zOiBhbnkgPSB7XHJcbiAgICAgICAgICAgICAgICB0aXRsZSxcclxuICAgICAgICAgICAgICAgIHdpZHRoLFxyXG4gICAgICAgICAgICAgICAgaGVpZ2h0LFxyXG4gICAgICAgICAgICAgICAgYnV0dG9uczogW1xyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogY2FuY2VsVGV4dCwgY2xzOiAnYnRuIGJ0bi1zZWNvbmRhcnknLCBoYW5kbGU6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGlhbG9nLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogb2tUZXh0LCBjbHM6ICdidG4gYnRuLXByaW1hcnknLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGU6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25Db25maXJtQ2xpY2sob3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBdLFxyXG4gICAgICAgICAgICAgICAgc2hvd0J1dHRvbnM6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBhcmVhUmVzcG9uc2U6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBvcGVuZWQ6IChlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RlclNob3J0Y3V0S2V5KG9wdGlvbnMsIGUuaW5zdGFuY2UpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGNsb3NlZDogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmtleURvd25IYW5kbGVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMua2V5RG93bkhhbmRsZXIoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5rZXlEb3duSGFuZGxlciA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB0aGlzLmRpYWxvZyA9IHRoaXMubW9kYWxTZXJ2aWNlLnNob3codGhpcy5jb21wb25lbnRSZWYsIG1vZGFsT3B0aW9ucyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgcmVnaXN0ZXJTaG9ydGN1dEtleShvcHRpb25zLCBkaWFsb2dSZWYpIHtcclxuICAgICAgICAvLyDlm57ovabvvIzkuI7noa7lrprmjInpkq7lpITnkIbpgLvovpHkuIDoh7PjgIJcclxuICAgICAgICBjb25zdCBkbGdDb250YWluZXJEb20gPSBkaWFsb2dSZWYuZGlhbG9nLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQ7XHJcblxyXG4gICAgICAgIGlmIChkbGdDb250YWluZXJEb20gJiYgIXRoaXMua2V5RG93bkhhbmRsZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5rZXlEb3duSGFuZGxlciA9IHRoaXMuZXZlbnRNYW5hZ2VyLmFkZEV2ZW50TGlzdGVuZXIoZGxnQ29udGFpbmVyRG9tLCAna2V5ZG93bicsIChlOiBLZXlib2FyZEV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGUua2V5ID09PSAnRW50ZXInKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gaWYgKGUudGFyZ2V0Wydub2RlTmFtZSddID09PSAnSU5QVVQnICYmICFlLmN0cmxLZXkpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIH1cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uQ29uZmlybUNsaWNrKG9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlLmtleSA9PT0gJ0VzY2FwZScpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRpYWxvZy5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlLmtleSA9PT0gJ1RhYicpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uVGFiS2V5ZG93bkhhbmRsZXIoZS50YXJnZXQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmNvbXBvbmVudFJlZikge1xyXG4gICAgICAgICAgICB0aGlzLnNldEZpcnN0SW5wdXRGb2N1cygpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNldEZpcnN0SW5wdXRGb2N1cygpIHtcclxuICAgICAgICBjb25zdCBmaXJzdElucHV0RWwgPSB0aGlzLmNvbXBvbmVudFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ2lucHV0LHRleHRhcmVhJyk7XHJcbiAgICAgICAgaWYgKGZpcnN0SW5wdXRFbCkge1xyXG4gICAgICAgICAgICBmaXJzdElucHV0RWwuZm9jdXMoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBvblRhYktleWRvd25IYW5kbGVyKGN1cnJlbnRUYXJnZXQpIHtcclxuICAgICAgICBsZXQgYWxsSW5wdXRzID0gdGhpcy5jb21wb25lbnRSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdpbnB1dCx0ZXh0YXJlYScpO1xyXG4gICAgICAgIGFsbElucHV0cyA9IEFycmF5LmZyb20oYWxsSW5wdXRzKTtcclxuICAgICAgICBjb25zdCBjdXJyZW50SW5wdXRJbmRleCA9IGFsbElucHV0cy5maW5kSW5kZXgobiA9PiBuID09PSBjdXJyZW50VGFyZ2V0KTtcclxuICAgICAgICBsZXQgbmV4dElucHV0SW5kZXggPSBjdXJyZW50SW5wdXRJbmRleCArIDE7XHJcbiAgICAgICAgaWYgKG5leHRJbnB1dEluZGV4ID49IGFsbElucHV0cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgbmV4dElucHV0SW5kZXggPSAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBuZXh0SW5wdXRUYXJnZXQgPSBhbGxJbnB1dHNbbmV4dElucHV0SW5kZXhdO1xyXG4gICAgICAgIGlmIChuZXh0SW5wdXRUYXJnZXQpIHtcclxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBuZXh0SW5wdXRUYXJnZXQuZm9jdXMoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog55So5oi354K55Ye756Gu6K6k5oyJ6ZKuXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgb25Db25maXJtQ2xpY2sob3B0aW9ucz86IElGZWF0dXJlRWRpdG9yT3B0aW9ucykge1xyXG4gICAgICAgIHRoaXMuY2FuQ2xvc2Uob3B0aW9ucykuc3Vic2NyaWJlKChyZXN1bHQ6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vbkNvbmZpcm0ob3B0aW9ucyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog56Gu6K6kXHJcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBvcHRpb25zXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgb25Db25maXJtKG9wdGlvbnM/OiBJRmVhdHVyZUVkaXRvck9wdGlvbnMpIHtcclxuICAgICAgICBjb25zdCBmZWF0dXJlcyA9IHRoaXMuY29tcG9uZW50UmVmICYmIHRoaXMuY29tcG9uZW50UmVmLmluc3RhbmNlICYmIHRoaXMuY29tcG9uZW50UmVmLmluc3RhbmNlLmZlYXR1cmVzIHx8IFtdO1xyXG4gICAgICAgIHRoaXMuZGlhbG9nLmNsb3NlKCk7XHJcbiAgICAgICAgaWYgKG9wdGlvbnMub25Db25maXJtICYmIHR5cGVvZiBvcHRpb25zLm9uQ29uZmlybSkge1xyXG4gICAgICAgICAgICBvcHRpb25zLm9uQ29uZmlybShmZWF0dXJlcyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMub25Vc2VyQ29uZmlybWVkLm5leHQoZmVhdHVyZXMpO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDmmK/lkKblj6/ku6XlhbPpl61cclxuICAgICAqIEBwYXJhbSBvcHRpb25zIG9wdGlvbnNcclxuICAgICAqIEByZXR1cm5zIFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGNhbkNsb3NlKG9wdGlvbnM/OiBJRmVhdHVyZUVkaXRvck9wdGlvbnMpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgICAgIGNvbnN0IGZlYXR1cmVzID0gdGhpcy5jb21wb25lbnRSZWYgJiYgdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UgJiYgdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UuZmVhdHVyZXMgfHwgW107XHJcbiAgICAgICAgY29uc3Qgb25Db25maXJtaW5nUmVmID0gb3B0aW9ucyAmJiBvcHRpb25zLm9uQ29uZmlybWluZyB8fCBudWxsO1xyXG4gICAgICAgIGlmICghb25Db25maXJtaW5nUmVmKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5pyJ56Gu6K6k5YmN5LqL5Lu2XHJcbiAgICAgICAgY29uc3Qgb25Db25maXJtaW5nID0gb25Db25maXJtaW5nUmVmKGZlYXR1cmVzKTtcclxuICAgICAgICBpZiAoaXNPYnNlcnZhYmxlKG9uQ29uZmlybWluZykpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9uQ29uZmlybWluZztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gb2Yob25Db25maXJtaW5nKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOaYr+WQpuWPr+S7peW8ueWHuueJueaAp+e8lui+keWZqFxyXG4gICAgICogQHBhcmFtIG9wdGlvbnMgb3B0aW9uc1xyXG4gICAgICogQHJldHVybnMgXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgY2FuT3BlbihvcHRpb25zPzogSUZlYXR1cmVFZGl0b3JPcHRpb25zKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgICAgICBjb25zdCBvbk9wZW5pbmdIYW5kbGVyUmVmID0gb3B0aW9ucyAmJiBvcHRpb25zLm9uT3BlbmluZyB8fCBudWxsO1xyXG4gICAgICAgIGlmICghb25PcGVuaW5nSGFuZGxlclJlZikge1xyXG4gICAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IG9uT3BlbmluZ0hhbmRsZXIgPSBvbk9wZW5pbmdIYW5kbGVyUmVmKG9wdGlvbnMpO1xyXG4gICAgICAgIGlmIChpc09ic2VydmFibGUob25PcGVuaW5nSGFuZGxlcikpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9uT3BlbmluZ0hhbmRsZXI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9mKG9uT3BlbmluZ0hhbmRsZXIpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=