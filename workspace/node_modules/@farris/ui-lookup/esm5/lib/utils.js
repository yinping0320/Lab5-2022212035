/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, NgZone } from '@angular/core';
import { CommonUtils, RuntimeStateService } from '@farris/ui-common';
import { FilterRelation, Compare } from '@farris/ui-common/types';
import { cloneDeep } from 'lodash-es';
var LookupUtils = /** @class */ (function () {
    function LookupUtils(utils, rts, ngZone) {
        this.utils = utils;
        this.rts = rts;
        this.ngZone = ngZone;
    }
    /**
     * @param {?} lookupIns
     * @return {?}
     */
    LookupUtils.prototype.setActiveLookupInstance = /**
     * @param {?} lookupIns
     * @return {?}
     */
    function (lookupIns) {
        if (this.rts) {
            this.rts.setLookupInstance(lookupIns);
        }
    };
    /**
     * @return {?}
     */
    LookupUtils.prototype.destroy = /**
     * @return {?}
     */
    function () {
        this.rts.destroy();
    };
    /**
     * @return {?}
     */
    LookupUtils.prototype.pendingStart = /**
     * @return {?}
     */
    function () {
        if (this.rts) {
            this.rts.updateFormState({
                lookup: {
                    pending: true
                }
            });
            // 禁用页面的所有鼠标事件
            document.body.style['pointer-events'] = 'none';
        }
    };
    /**
     * @return {?}
     */
    LookupUtils.prototype.pendingEnd = /**
     * @return {?}
     */
    function () {
        if (this.rts) {
            this.rts.updateFormState({
                lookup: {
                    pending: false
                }
            });
            // 激活鼠标事件
            document.body.style['pointer-events'] = '';
        }
    };
    /**
     * @param {?} data
     * @param {?=} treeInfo
     * @return {?}
     */
    LookupUtils.prototype.getPathCode = /**
     * @param {?} data
     * @param {?=} treeInfo
     * @return {?}
     */
    function (data, treeInfo) {
        if (treeInfo === void 0) { treeInfo = null; }
        var dataField = treeInfo.dataField, pathField = treeInfo.pathField;
        if (dataField) {
            return data[dataField][pathField];
        }
        else {
            return this.utils.getValue(pathField, data);
        }
    };
    /**
     * @param {?} data
     * @param {?=} treeInfo
     * @return {?}
     */
    LookupUtils.prototype.getLayerData = /**
     * @param {?} data
     * @param {?=} treeInfo
     * @return {?}
     */
    function (data, treeInfo) {
        if (treeInfo === void 0) { treeInfo = null; }
        var dataField = treeInfo.dataField, layerField = treeInfo.layerField;
        if (dataField) {
            return data[dataField][layerField];
        }
        else {
            return this.utils.getValue(layerField, data);
        }
    };
    /**
     * @private
     * @param {?} field
     * @param {?} value
     * @return {?}
     */
    LookupUtils.prototype.createFilterCondition = /**
     * @private
     * @param {?} field
     * @param {?} value
     * @return {?}
     */
    function (field, value) {
        return {
            filterField: field,
            value: value,
            lbracket: '',
            rbracket: '',
            relation: FilterRelation.Or,
            compare: Compare.Like
        };
    };
    /**
     * @param {?} condition
     * @param {?} fields
     * @param {?} searchData
     * @return {?}
     */
    LookupUtils.prototype.mergeCondition = /**
     * @param {?} condition
     * @param {?} fields
     * @param {?} searchData
     * @return {?}
     */
    function (condition, fields, searchData) {
        var _this = this;
        if (!condition) {
            condition = {
                pagination: {
                    pageIndex: 1,
                    pageSize: 20
                },
                filterConditions: [],
                sortConditions: []
            };
        }
        else {
            condition = cloneDeep(condition);
        }
        var _a = tslib_1.__assign({}, searchData), _b = _a.field, field = _b === void 0 ? '*' : _b, _c = _a.value, value = _c === void 0 ? '' : _c;
        if (value) {
            if (field === '*') {
                if (fields && fields.length) {
                    /** @type {?} */
                    var searchConditions = fields.map((/**
                     * @param {?} f
                     * @return {?}
                     */
                    function (f) {
                        return _this.createFilterCondition(f, value);
                    }));
                    if (searchConditions.length) {
                        searchConditions[0].lbracket = '(';
                        /** @type {?} */
                        var lastSearchConditions = searchConditions[searchConditions.length - 1];
                        lastSearchConditions.rbracket = ')';
                        lastSearchConditions.relation = FilterRelation.Empty;
                    }
                    if (condition.filterConditions && condition.filterConditions.length) {
                        condition.filterConditions[condition.filterConditions.length - 1].relation = FilterRelation.And;
                        condition.filterConditions = condition.filterConditions.concat(searchConditions);
                    }
                    else {
                        condition.filterConditions = searchConditions;
                    }
                }
            }
            else {
                /** @type {?} */
                var searchCondition = this.createFilterCondition(field, value);
                searchCondition.relation = FilterRelation.Empty;
                if (condition.filterConditions && condition.filterConditions.length) {
                    condition.filterConditions[condition.filterConditions.length - 1].relation = FilterRelation.And;
                    condition.filterConditions.push(searchCondition);
                }
                else {
                    condition.filterConditions = [searchCondition];
                }
            }
        }
        return condition;
    };
    /**
     * @private
     * @param {?} n
     * @return {?}
     */
    LookupUtils.prototype.canSelectable = /**
     * @private
     * @param {?} n
     * @return {?}
     */
    function (n) {
        if (n.hasOwnProperty('farris_selectable')) {
            return !!n['farris_selectable'];
        }
        return true;
    };
    /** 将数据转树形结构 */
    /**
     * 将数据转树形结构
     * @param {?} data
     * @param {?} parentId
     * @param {?=} parentIdField
     * @param {?=} idField
     * @return {?}
     */
    LookupUtils.prototype.makeTreeWithParentID = /**
     * 将数据转树形结构
     * @param {?} data
     * @param {?} parentId
     * @param {?=} parentIdField
     * @param {?=} idField
     * @return {?}
     */
    function (data, parentId, parentIdField, idField) {
        var _this = this;
        if (parentIdField === void 0) { parentIdField = 'parentId'; }
        if (idField === void 0) { idField = 'id'; }
        /** @type {?} */
        var nodes = new Map();
        /** @type {?} */
        var result = [];
        /** @type {?} */
        var unattached = [];
        data.forEach((/**
         * @param {?} t
         * @return {?}
         */
        function (t) {
            /** @type {?} */
            var node = {
                data: t,
                children: [],
                selectable: _this.canSelectable(t),
                parent: null,
                parents: []
            };
            /** @type {?} */
            var id = t[idField];
            nodes.set(id, node);
            /** @type {?} */
            var PID = _this.utils.getValue(parentIdField, t);
            if (PID === parentId) {
                result.push(node);
            }
            else {
                /** @type {?} */
                var parent_1 = nodes.get(PID);
                if (parent_1) {
                    node.parent = PID;
                    node.parents = tslib_1.__spread(parent_1.parents, [PID]);
                    parent_1.children.push(node);
                }
                else {
                    unattached.push(node);
                }
            }
        }));
        unattached.forEach((/**
         * @param {?} n
         * @return {?}
         */
        function (n) {
            /** @type {?} */
            var pid = _this.utils.getValue(parentIdField, n.data);
            /** @type {?} */
            var parent = nodes.get(pid);
            if (parent) {
                n.parent = pid;
                n.parents = tslib_1.__spread(parent.parents, [pid]);
                parent.children.push(n);
            }
        }));
        return result;
    };
    /**
     * @param {?} data
     * @param {?} treeInfo
     * @return {?}
     */
    LookupUtils.prototype.makeTree = /**
     * @param {?} data
     * @param {?} treeInfo
     * @return {?}
     */
    function (data, treeInfo) {
        // const treeInfoField = treeInfo.dataField;
        // const layerField = treeInfo.layerField;
        // const pathField = treeInfo.pathField;
        var _this = this;
        // const treeInfoField = treeInfo.dataField;
        // const layerField = treeInfo.layerField;
        // const pathField = treeInfo.pathField;
        /** @type {?} */
        var nodes = new Map();
        /** @type {?} */
        var result = [];
        /** @type {?} */
        var unattached = [];
        data.forEach((/**
         * @param {?} t
         * @return {?}
         */
        function (t) {
            /** @type {?} */
            var node = {
                data: t,
                children: [],
                selectable: _this.canSelectable(t)
            };
            /** @type {?} */
            var pathCode = _this.getPathCode(t, treeInfo);
            nodes.set(pathCode, node);
            if (_this.getLayerData(t, treeInfo) === 1) {
                result.push(node);
            }
            else {
                /** @type {?} */
                var parentPathCode = pathCode.substr(0, pathCode.length - 4);
                /** @type {?} */
                var parent_2 = nodes.get(parentPathCode);
                if (parent_2) {
                    parent_2.children.push(node);
                }
                else {
                    unattached.push(node);
                }
            }
        }));
        unattached.forEach((/**
         * @param {?} n
         * @return {?}
         */
        function (n) {
            // const pathCode = n.data[treeInfoField][pathField];
            /** @type {?} */
            var pathCode = _this.getPathCode(n.data, treeInfo);
            /** @type {?} */
            var parent = nodes.get(pathCode.substr(0, pathCode.length - 4));
            if (parent) {
                parent.children.push(n);
            }
        }));
        return result;
    };
    LookupUtils.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    LookupUtils.ctorParameters = function () { return [
        { type: CommonUtils },
        { type: RuntimeStateService },
        { type: NgZone }
    ]; };
    return LookupUtils;
}());
export { LookupUtils };
if (false) {
    /**
     * @type {?}
     * @private
     */
    LookupUtils.prototype.utils;
    /**
     * @type {?}
     * @private
     */
    LookupUtils.prototype.rts;
    /**
     * @type {?}
     * @private
     */
    LookupUtils.prototype.ngZone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi91dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxXQUFXLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNyRSxPQUFPLEVBQUUsY0FBYyxFQUFtQixPQUFPLEVBQWdCLE1BQU0seUJBQXlCLENBQUM7QUFDakcsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUd0QztJQUdJLHFCQUFvQixLQUFrQixFQUFVLEdBQXdCLEVBQVUsTUFBYztRQUE1RSxVQUFLLEdBQUwsS0FBSyxDQUFhO1FBQVUsUUFBRyxHQUFILEdBQUcsQ0FBcUI7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFRO0lBQUksQ0FBQzs7Ozs7SUFFckcsNkNBQXVCOzs7O0lBQXZCLFVBQXdCLFNBQWM7UUFDbEMsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ1YsSUFBSSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUN6QztJQUNMLENBQUM7Ozs7SUFHRCw2QkFBTzs7O0lBQVA7UUFDSSxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3ZCLENBQUM7Ozs7SUFFRCxrQ0FBWTs7O0lBQVo7UUFDSSxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDVixJQUFJLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQztnQkFDckIsTUFBTSxFQUFFO29CQUNKLE9BQU8sRUFBRSxJQUFJO2lCQUNoQjthQUNKLENBQUMsQ0FBQztZQUVILGNBQWM7WUFDZCxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLE1BQU0sQ0FBQztTQUNsRDtJQUNMLENBQUM7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Q29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQ29tbW9uVXRpbHMsIFJ1bnRpbWVTdGF0ZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbic7XHJcbmltcG9ydCB7IEZpbHRlclJlbGF0aW9uLCBGaWx0ZXJDb25kaXRpb24sIENvbXBhcmUsIEVudGl0eUZpbHRlciB9IGZyb20gJ0BmYXJyaXMvdWktY29tbW9uL3R5cGVzJztcclxuaW1wb3J0IHsgY2xvbmVEZWVwIH0gZnJvbSAnbG9kYXNoLWVzJztcclxuaW1wb3J0IHsgVHJlZUluZm8gfSBmcm9tICcuL2xvb2t1cC1ncmlkLW9wdGlvbnMnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgTG9va3VwVXRpbHMge1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgdXRpbHM6IENvbW1vblV0aWxzLCBwcml2YXRlIHJ0czogUnVudGltZVN0YXRlU2VydmljZSwgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZSkgeyB9XHJcblxyXG4gICAgc2V0QWN0aXZlTG9va3VwSW5zdGFuY2UobG9va3VwSW5zOiBhbnkpIHtcclxuICAgICAgICBpZiAodGhpcy5ydHMpIHtcclxuICAgICAgICAgICAgdGhpcy5ydHMuc2V0TG9va3VwSW5zdGFuY2UobG9va3VwSW5zKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGRlc3Ryb3koKSB7XHJcbiAgICAgICAgdGhpcy5ydHMuZGVzdHJveSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHBlbmRpbmdTdGFydCgpIHtcclxuICAgICAgICBpZiAodGhpcy5ydHMpIHtcclxuICAgICAgICAgICAgdGhpcy5ydHMudXBkYXRlRm9ybVN0YXRlKHtcclxuICAgICAgICAgICAgICAgIGxvb2t1cDoge1xyXG4gICAgICAgICAgICAgICAgICAgIHBlbmRpbmc6IHRydWVcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAvLyDnpoHnlKjpobXpnaLnmoTmiYDmnInpvKDmoIfkuovku7ZcclxuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZVsncG9pbnRlci1ldmVudHMnXSA9ICdub25lJztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcGVuZGluZ0VuZCgpIHtcclxuICAgICAgICBpZiAodGhpcy5ydHMpIHtcclxuICAgICAgICAgICAgdGhpcy5ydHMudXBkYXRlRm9ybVN0YXRlKHtcclxuICAgICAgICAgICAgICAgIGxvb2t1cDoge1xyXG4gICAgICAgICAgICAgICAgICAgIHBlbmRpbmc6IGZhbHNlXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8g5r+A5rS76byg5qCH5LqL5Lu2XHJcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGVbJ3BvaW50ZXItZXZlbnRzJ10gPSAnJztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UGF0aENvZGUoZGF0YSwgdHJlZUluZm8gPSBudWxsKSB7XHJcbiAgICAgICAgY29uc3QgeyBkYXRhRmllbGQsIHBhdGhGaWVsZCB9ID0gIHRyZWVJbmZvIDtcclxuICAgICAgICBpZiAoZGF0YUZpZWxkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBkYXRhW2RhdGFGaWVsZF1bcGF0aEZpZWxkXTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy51dGlscy5nZXRWYWx1ZShwYXRoRmllbGQsIGRhdGEpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGdldExheWVyRGF0YShkYXRhLCB0cmVlSW5mbyA9IG51bGwgKSB7XHJcbiAgICAgICAgY29uc3QgeyBkYXRhRmllbGQsIGxheWVyRmllbGQgfSA9IHRyZWVJbmZvO1xyXG4gICAgICAgIGlmIChkYXRhRmllbGQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGRhdGFbZGF0YUZpZWxkXVtsYXllckZpZWxkXTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy51dGlscy5nZXRWYWx1ZShsYXllckZpZWxkLCBkYXRhKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgY3JlYXRlRmlsdGVyQ29uZGl0aW9uKGZpZWxkOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBmaWx0ZXJGaWVsZDogZmllbGQsXHJcbiAgICAgICAgICAgIHZhbHVlLFxyXG4gICAgICAgICAgICBsYnJhY2tldDogJycsXHJcbiAgICAgICAgICAgIHJicmFja2V0OiAnJyxcclxuICAgICAgICAgICAgcmVsYXRpb246IEZpbHRlclJlbGF0aW9uLk9yLFxyXG4gICAgICAgICAgICBjb21wYXJlOiBDb21wYXJlLkxpa2VcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIG1lcmdlQ29uZGl0aW9uKGNvbmRpdGlvbjogRW50aXR5RmlsdGVyLCBmaWVsZHM6IHN0cmluZ1tdLCBzZWFyY2hEYXRhOiB7IGZpZWxkOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfSkge1xyXG4gICAgICAgIGlmICghY29uZGl0aW9uKSB7XHJcbiAgICAgICAgICAgIGNvbmRpdGlvbiA9IHtcclxuICAgICAgICAgICAgICAgIHBhZ2luYXRpb246IHtcclxuICAgICAgICAgICAgICAgICAgICBwYWdlSW5kZXg6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgcGFnZVNpemU6IDIwXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgZmlsdGVyQ29uZGl0aW9uczogW10sXHJcbiAgICAgICAgICAgICAgICBzb3J0Q29uZGl0aW9uczogW11cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25kaXRpb24gPSBjbG9uZURlZXAoY29uZGl0aW9uKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHsgZmllbGQgPSAnKicsIHZhbHVlID0gJycgfSA9IHsgLi4uc2VhcmNoRGF0YSB9O1xyXG5cclxuICAgICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICAgICAgaWYgKGZpZWxkID09PSAnKicpIHtcclxuICAgICAgICAgICAgICAgIGlmIChmaWVsZHMgJiYgZmllbGRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlYXJjaENvbmRpdGlvbnM6IEZpbHRlckNvbmRpdGlvbltdID0gZmllbGRzLm1hcCgoZjogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUZpbHRlckNvbmRpdGlvbihmLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWFyY2hDb25kaXRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWFyY2hDb25kaXRpb25zWzBdLmxicmFja2V0ID0gJygnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0U2VhcmNoQ29uZGl0aW9ucyA9IHNlYXJjaENvbmRpdGlvbnNbc2VhcmNoQ29uZGl0aW9ucy5sZW5ndGggLSAxXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNlYXJjaENvbmRpdGlvbnMucmJyYWNrZXQgPSAnKSc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTZWFyY2hDb25kaXRpb25zLnJlbGF0aW9uID0gRmlsdGVyUmVsYXRpb24uRW1wdHk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uLmZpbHRlckNvbmRpdGlvbnMgJiYgY29uZGl0aW9uLmZpbHRlckNvbmRpdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zW2NvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zLmxlbmd0aCAtIDFdLnJlbGF0aW9uID0gRmlsdGVyUmVsYXRpb24uQW5kO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25kaXRpb24uZmlsdGVyQ29uZGl0aW9ucyA9IGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zLmNvbmNhdChzZWFyY2hDb25kaXRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25kaXRpb24uZmlsdGVyQ29uZGl0aW9ucyA9IHNlYXJjaENvbmRpdGlvbnM7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VhcmNoQ29uZGl0aW9uID0gdGhpcy5jcmVhdGVGaWx0ZXJDb25kaXRpb24oZmllbGQsIHZhbHVlKTtcclxuICAgICAgICAgICAgICAgIHNlYXJjaENvbmRpdGlvbi5yZWxhdGlvbiA9IEZpbHRlclJlbGF0aW9uLkVtcHR5O1xyXG4gICAgICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zICYmIGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zW2NvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zLmxlbmd0aCAtIDFdLnJlbGF0aW9uID0gRmlsdGVyUmVsYXRpb24uQW5kO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zLnB1c2goc2VhcmNoQ29uZGl0aW9uKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uLmZpbHRlckNvbmRpdGlvbnMgPSBbc2VhcmNoQ29uZGl0aW9uXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGNvbmRpdGlvbjtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNhblNlbGVjdGFibGUobjogYW55KSB7XHJcbiAgICAgICAgaWYgKG4uaGFzT3duUHJvcGVydHkoJ2ZhcnJpc19zZWxlY3RhYmxlJykpIHtcclxuICAgICAgICAgICAgcmV0dXJuICEhblsnZmFycmlzX3NlbGVjdGFibGUnXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIOWwhuaVsOaNrui9rOagkeW9oue7k+aehCAqL1xyXG4gICAgbWFrZVRyZWVXaXRoUGFyZW50SUQoZGF0YTogYW55W10sIHBhcmVudElkLCBwYXJlbnRJZEZpZWxkID0gJ3BhcmVudElkJywgaWRGaWVsZCA9ICdpZCcpIHtcclxuICAgICAgICBjb25zdCBub2RlcyA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gW107XHJcbiAgICAgICAgY29uc3QgdW5hdHRhY2hlZCA9IFtdO1xyXG4gICAgICAgIGRhdGEuZm9yRWFjaCh0ID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgbm9kZSA9IHtcclxuICAgICAgICAgICAgICAgIGRhdGE6IHQsXHJcbiAgICAgICAgICAgICAgICBjaGlsZHJlbjogW10sXHJcbiAgICAgICAgICAgICAgICBzZWxlY3RhYmxlOiB0aGlzLmNhblNlbGVjdGFibGUodCksXHJcbiAgICAgICAgICAgICAgICBwYXJlbnQ6IG51bGwsXHJcbiAgICAgICAgICAgICAgICBwYXJlbnRzOiBbXVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjb25zdCBpZCA9IHRbaWRGaWVsZF07XHJcbiAgICAgICAgICAgIG5vZGVzLnNldChpZCwgbm9kZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IFBJRCA9IHRoaXMudXRpbHMuZ2V0VmFsdWUocGFyZW50SWRGaWVsZCwgdCk7XHJcbiAgICAgICAgICAgIGlmIChQSUQgPT09IHBhcmVudElkKSB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChub2RlKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IG5vZGVzLmdldChQSUQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUucGFyZW50ID0gUElEO1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUucGFyZW50cyA9IFsuLi5wYXJlbnQucGFyZW50cywgUElEXTtcclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChub2RlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdW5hdHRhY2hlZC5wdXNoKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHVuYXR0YWNoZWQuZm9yRWFjaChuID0+IHtcclxuICAgICAgICAgICAgY29uc3QgcGlkID0gdGhpcy51dGlscy5nZXRWYWx1ZShwYXJlbnRJZEZpZWxkLCBuLmRhdGEpO1xyXG4gICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2Rlcy5nZXQocGlkKTtcclxuICAgICAgICAgICAgaWYgKHBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgbi5wYXJlbnQgPSBwaWQ7XHJcbiAgICAgICAgICAgICAgICBuLnBhcmVudHMgPSBbLi4ucGFyZW50LnBhcmVudHMsIHBpZF07XHJcbiAgICAgICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChuKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIG1ha2VUcmVlKGRhdGEsIHRyZWVJbmZvOiBUcmVlSW5mbykge1xyXG4gICAgICAgIC8vIGNvbnN0IHRyZWVJbmZvRmllbGQgPSB0cmVlSW5mby5kYXRhRmllbGQ7XHJcbiAgICAgICAgLy8gY29uc3QgbGF5ZXJGaWVsZCA9IHRyZWVJbmZvLmxheWVyRmllbGQ7XHJcbiAgICAgICAgLy8gY29uc3QgcGF0aEZpZWxkID0gdHJlZUluZm8ucGF0aEZpZWxkO1xyXG5cclxuICAgICAgICBjb25zdCBub2RlcyA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gW107XHJcbiAgICAgICAgY29uc3QgdW5hdHRhY2hlZCA9IFtdO1xyXG4gICAgICAgIGRhdGEuZm9yRWFjaCh0ID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgbm9kZSA9IHtcclxuICAgICAgICAgICAgICAgIGRhdGE6IHQsXHJcbiAgICAgICAgICAgICAgICBjaGlsZHJlbjogW10sXHJcbiAgICAgICAgICAgICAgICBzZWxlY3RhYmxlOiB0aGlzLmNhblNlbGVjdGFibGUodClcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgY29uc3QgcGF0aENvZGUgPSB0aGlzLmdldFBhdGhDb2RlKHQsIHRyZWVJbmZvKTtcclxuICAgICAgICAgICAgbm9kZXMuc2V0KHBhdGhDb2RlLCBub2RlKTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmdldExheWVyRGF0YSh0LCB0cmVlSW5mbykgPT09IDEpIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5vZGUpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcGFyZW50UGF0aENvZGUgPSBwYXRoQ29kZS5zdWJzdHIoMCwgcGF0aENvZGUubGVuZ3RoIC0gNCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2Rlcy5nZXQocGFyZW50UGF0aENvZGUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudC5jaGlsZHJlbi5wdXNoKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB1bmF0dGFjaGVkLnB1c2gobm9kZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIHVuYXR0YWNoZWQuZm9yRWFjaChuID0+IHtcclxuICAgICAgICAgICAgLy8gY29uc3QgcGF0aENvZGUgPSBuLmRhdGFbdHJlZUluZm9GaWVsZF1bcGF0aEZpZWxkXTtcclxuICAgICAgICAgICAgY29uc3QgcGF0aENvZGUgPSB0aGlzLmdldFBhdGhDb2RlKG4uZGF0YSwgdHJlZUluZm8pO1xyXG4gICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2Rlcy5nZXQocGF0aENvZGUuc3Vic3RyKDAsIHBhdGhDb2RlLmxlbmd0aCAtIDQpKTtcclxuICAgICAgICAgICAgaWYgKHBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgcGFyZW50LmNoaWxkcmVuLnB1c2gobik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxufVxyXG4iXX0=