/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
var SelectionManager = /** @class */ (function () {
    function SelectionManager(ins) {
        this.ins = ins;
    }
    /**
     * @return {?}
     */
    SelectionManager.prototype.destroy = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @return {?}
     */
    SelectionManager.prototype.getBindingData = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var jsonData = this.ins.bindingData;
        if (this.ins.ngControl &&
            this.ins.ngControl.formDirective &&
            this.ins.ngControl.formDirective.form &&
            this.ins.ngControl.formDirective.form.bindingData) {
            /** @type {?} */
            var bindingData = this.ins.ngControl.formDirective.form.bindingData;
            jsonData = bindingData;
            if (bindingData.getObject) {
                jsonData = bindingData.getObject().toJSON();
            }
        }
        return jsonData;
    };
    /**
     * @return {?}
     */
    SelectionManager.prototype.initDisplayValue = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var jsonData = this.getBindingData();
        if (jsonData && this.ins.mapFields) {
            /** @type {?} */
            var idField = this.ins.idField;
            /** @type {?} */
            var targetField = this.ins.mapFields[idField];
            if (targetField) {
                if (targetField.indexOf(',') > -1) {
                    targetField = targetField.split(',')[0];
                }
                /** @type {?} */
                var val = this.ins.utils.getValue(targetField, jsonData);
                if (val) {
                    this.ins.displayValue = val;
                }
            }
        }
    };
    /**
     * @private
     * @return {?}
     */
    SelectionManager.prototype._clearSelections = /**
     * @private
     * @return {?}
     */
    function () {
        var t = this.getDataCmpInstance().cmpRefInstance;
        if (t) {
            if (this.ins.isTree()) {
                // 树表
                t.clearAll(false);
                if (!t.cdRef.destroyed) {
                    t.cdRef.detectChanges();
                }
            }
            else {
                // 列表
                t.dtBody.selectedRowIndex = -1;
                t.dtBody.selections = undefined;
                if (!t.cd.destroyed) {
                    t.cd.detectChanges();
                }
            }
        }
    };
    /**
     * 帮助窗口打开后，根据 displayValue 选中数据
     */
    /**
     * 帮助窗口打开后，根据 displayValue 选中数据
     * @param {?=} selectedIds
     * @return {?}
     */
    SelectionManager.prototype.selectCurrentValue = /**
     * 帮助窗口打开后，根据 displayValue 选中数据
     * @param {?=} selectedIds
     * @return {?}
     */
    function (selectedIds) {
        var _this = this;
        if (selectedIds === void 0) { selectedIds = []; }
        if (!this.ins.enableToSelect) {
            return;
        }
        var _a = this.getDataCmpInstance(), t = _a.cmpRefInstance, items = _a.items;
        if (!t || !items || !items.length) {
            return;
        }
        this._clearSelections();
        if (!selectedIds || !selectedIds.length) {
            /** @type {?} */
            var selectedRows = this.ins.lookupSelectionSer.getSelections();
            if (selectedRows.length) {
                selectedIds = selectedRows.map((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return n[_this.ins.idField]; }));
            }
        }
        // const _ids = this.getSelectedIds();
        // selectedIds = selectedIds.concat(_ids);
        // selectedIds = Array.from(new Set(selectedIds));
        if (selectedIds && selectedIds.length) {
            if (this.ins.isTree()) {
                // 树表
                this.selected4Treetable(t, selectedIds);
                if (!t.cdRef.destroyed) {
                    t.cdRef.detectChanges();
                }
            }
            else {
                // 列表
                this.selected4Datatable(t, items, selectedIds);
                if (!t.cd.destroyed) {
                    t.cd.detectChanges();
                }
            }
        }
    };
    /**
     * @private
     * @return {?}
     */
    SelectionManager.prototype.getDataCmpInstance = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var ref = null;
        /** @type {?} */
        var items = null;
        if (this.ins.activeTab === 'datalist') {
            if (this.ins.isTree()) {
                ref = this.ins.lookupCmpMgr.getComponentInstance('treetable');
                items = ((/** @type {?} */ (ref))).serializedValue;
            }
            else {
                items = this.ins.items;
                ref = this.ins.lookupCmpMgr.getComponentInstance();
            }
        }
        else if (this.ins.activeTab === 'favorite') {
            ref = this.ins.lookupCmpMgr.getComponentInstance('fav');
            items = this.ins.favoriteItems;
        }
        return { cmpRefInstance: ref, items: items };
    };
    /**
     * @private
     * @param {?} t
     * @param {?} items
     * @param {?} values
     * @return {?}
     */
    SelectionManager.prototype.selected4Datatable = /**
     * @private
     * @param {?} t
     * @param {?} items
     * @param {?} values
     * @return {?}
     */
    function (t, items, values) {
        var _this = this;
        if (this.ins.singleSelect) {
            items.forEach((/**
             * @param {?} item
             * @param {?} index
             * @return {?}
             */
            function (item, index) {
                if (item[_this.ins.idField] === values[0]) {
                    if (!t.dtBody.isSelected(item)) {
                        t.dtBody.selectedRowIndex = -1;
                        t.dtBody.selectedRow('', index, item);
                    }
                }
            }));
        }
        else {
            // const values = this.getSelectedIds();
            values.forEach((/**
             * @param {?} id
             * @return {?}
             */
            function (id) {
                /** @type {?} */
                var r = items.find((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return n[_this.ins.idField] == id; }));
                if (r) {
                    t.checkRow(id);
                }
            }));
        }
    };
    /**
     * @private
     * @param {?} t
     * @param {?} valueArr
     * @return {?}
     */
    SelectionManager.prototype.selected4Treetable = /**
     * @private
     * @param {?} t
     * @param {?} valueArr
     * @return {?}
     */
    function (t, valueArr) {
        if (this.ins.singleSelect) {
            t.selectNode(valueArr[0], false, false);
        }
        else {
            // const valueArr = this.getSelectedIds();
            t.checkedNodes(valueArr, false, false, true);
            t.selectNodes(valueArr);
        }
    };
    /**
     * @return {?}
     */
    SelectionManager.prototype.getSelectedIds = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var values = [];
        /** @type {?} */
        var s = this.ins.multipleChoiceSeparator;
        if (!this.ins.singleSelect && this.ins.displayValue && ('' + this.ins.displayValue).indexOf(s) > -1) {
            values = this.ins.displayValue.split(s);
        }
        else {
            if (this.ins.displayValue !== null && this.ins.displayValue !== '' && this.ins.displayValue !== undefined) {
                values = [this.ins.displayValue];
            }
        }
        // // 启用显示多选列表
        // if (this.ins.showSelected) {
        //     const rows = this.ins.lookupSelectionSer.getSelections();
        //     if (rows && rows.length) {
        //         values = rows.map(n => n[this.ins.idField]);
        //     }
        // }
        return values;
    };
    return SelectionManager;
}());
export { SelectionManager };
if (false) {
    /**
     * @type {?}
     * @private
     */
    SelectionManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0aW9uLW1hbmFnZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9zZWxlY3Rpb24tbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBSUE7SUFDSSwwQkFBb0IsR0FBd0I7UUFBeEIsUUFBRyxHQUFILEdBQUcsQ0FBcUI7SUFFNUMsQ0FBQzs7OztJQUVELGtDQUFPOzs7SUFBUDtJQUNBLENBQUM7Ozs7SUFFRCx5Q0FBYzs7O0lBQWQ7O1lBQ1EsUUFBUSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVztRQUNuQyxJQUNJLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUztZQUNsQixJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxhQUFhO1lBQ2hDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxJQUFJO1lBQ3JDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUNuRDs7Z0JBQ1EsV0FBVyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsV0FBVztZQUNyRSxRQUFRLEdBQUcsV0FBVyxDQUFDO1lBRXZCLElBQUksV0FBVyxDQUFDLFNBQVMsRUFBRTtnQkFDdkIsUUFBUSxHQUFHLFdBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQzthQUMvQztTQUNKO1FBQ0QsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQzs7OztJQUVELDJDQUFnQjs7O0lBQWhCOztZQUNVLFFBQVEsR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFO1FBQ3RDLElBQUksUUFBUSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFOztnQkFDMUIsT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTzs7Z0JBQzVCLFdBQVcs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SyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztZQUM3QyxDQUFDLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQzNCO0lBQ0wsQ0FBQzs7OztJQUVELHlDQUFjOzs7SUFBZDs7WUFDUSxNQUFNLEdBQUcsRUFBRTs7WUFDVCxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyx1QkFBdUI7UUFDMUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO1lBQ2pHLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDM0M7YUFBTTtZQUNILElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEtBQUssSUFBSSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxLQUFLLEVBQUUsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksS0FBSyxTQUFTLEVBQUU7Z0JBQ3ZHLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDcEM7U0FDSjtRQUVELGNBQWM7UUFDZCwrQkFBK0I7UUFDL0IsZ0VBQWdFO1FBQ2hFLGlDQUFpQztRQUNqQyx1REFBdUQ7UUFDdkQsUUFBUTtRQUNSLElBQUk7UUFFSixPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBQ0wsdUJBQUM7QUFBRCxDQUFDLEFBcExELElBb0xDOzs7Ozs7O0lBbkxlLCtCQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRyZWVUYWJsZUNvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktdHJlZXRhYmxlJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLmNvbXBvbmVudCc7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIFNlbGVjdGlvbk1hbmFnZXIge1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbnM6IExvb2t1cEdyaWRDb21wb25lbnQpIHtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgZGVzdHJveSgpIHtcclxuICAgIH1cclxuXHJcbiAgICBnZXRCaW5kaW5nRGF0YSgpIHtcclxuICAgICAgICBsZXQganNvbkRhdGEgPSB0aGlzLmlucy5iaW5kaW5nRGF0YTtcclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICAgIHRoaXMuaW5zLm5nQ29udHJvbCAmJlxyXG4gICAgICAgICAgICB0aGlzLmlucy5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZSAmJlxyXG4gICAgICAgICAgICB0aGlzLmlucy5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtICYmXHJcbiAgICAgICAgICAgIHRoaXMuaW5zLm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0uYmluZGluZ0RhdGFcclxuICAgICAgICApIHtcclxuICAgICAgICAgICAgY29uc3QgYmluZGluZ0RhdGEgPSB0aGlzLmlucy5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtLmJpbmRpbmdEYXRhO1xyXG4gICAgICAgICAgICBqc29uRGF0YSA9IGJpbmRpbmdEYXRhO1xyXG5cclxuICAgICAgICAgICAgaWYgKGJpbmRpbmdEYXRhLmdldE9iamVjdCkge1xyXG4gICAgICAgICAgICAgICAganNvbkRhdGEgPSBiaW5kaW5nRGF0YS5nZXRPYmplY3QoKS50b0pTT04oKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4ganNvbkRhdGE7XHJcbiAgICB9XHJcblxyXG4gICAgaW5pdERpc3BsYXlWYWx1ZSgpIHtcclxuICAgICAgICBjb25zdCBqc29uRGF0YSA9IHRoaXMuZ2V0QmluZGluZ0RhdGEoKTtcclxuICAgICAgICBpZiAoanNvbkRhdGEgJiYgdGhpcy5pbnMubWFwRmllbGRzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGlkRmllbGQgPSB0aGlzLmlucy5pZEZpZWxkO1xyXG4gICAgICAgICAgICBsZXQgdGFyZ2V0RmllbGQgPSB0aGlzLmlucy5tYXBGaWVsZHNbaWRGaWVsZF07XHJcblxyXG4gICAgICAgICAgICBpZiAodGFyZ2V0RmllbGQpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0YXJnZXRGaWVsZC5pbmRleE9mKCcsJykgPiAtMSApIHtcclxuICAgICAgICAgICAgICAgICAgICB0YXJnZXRGaWVsZCA9IHRhcmdldEZpZWxkLnNwbGl0KCcsJylbMF07XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgdmFsID0gdGhpcy5pbnMudXRpbHMuZ2V0VmFsdWUodGFyZ2V0RmllbGQsIGpzb25EYXRhKTtcclxuICAgICAgICAgICAgICAgIGlmICh2YWwpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5kaXNwbGF5VmFsdWUgPSB2YWw7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfY2xlYXJTZWxlY3Rpb25zKCkge1xyXG4gICAgICAgIGNvbnN0IHsgY21wUmVmSW5zdGFuY2U6IHQgfSA9IHRoaXMuZ2V0RGF0YUNtcEluc3RhbmNlKCk7XHJcbiAgICAgICAgaWYgKHQpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmlzVHJlZSgpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyDmoJHooahcclxuICAgICAgICAgICAgICAgIHQuY2xlYXJBbGwoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0LmNkUmVmLmRlc3Ryb3llZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHQuY2RSZWYuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8g5YiX6KGoXHJcbiAgICAgICAgICAgICAgICB0LmR0Qm9keS5zZWxlY3RlZFJvd0luZGV4ID0gLTE7XHJcbiAgICAgICAgICAgICAgICB0LmR0Qm9keS5zZWxlY3Rpb25zID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0LmNkLmRlc3Ryb3llZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHQuY2QuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5biu5Yqp56qX5Y+j5omT5byA5ZCO77yM5qC55o2uIGRpc3BsYXlWYWx1ZSDpgInkuK3mlbDmja5cclxuICAgICAqL1xyXG4gICAgc2VsZWN0Q3VycmVudFZhbHVlKHNlbGVjdGVkSWRzID0gW10pIHtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLmlucy5lbmFibGVUb1NlbGVjdCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgY29uc3QgeyBjbXBSZWZJbnN0YW5jZTogdCwgaXRlbXMgfSA9IHRoaXMuZ2V0RGF0YUNtcEluc3RhbmNlKCk7XHJcbiAgICAgICAgaWYgKCF0IHx8ICFpdGVtcyB8fCAhaXRlbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2NsZWFyU2VsZWN0aW9ucygpO1xyXG5cclxuICAgICAgICBpZiAoIXNlbGVjdGVkSWRzIHx8ICFzZWxlY3RlZElkcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRSb3dzID0gdGhpcy5pbnMubG9va3VwU2VsZWN0aW9uU2VyLmdldFNlbGVjdGlvbnMoKTtcclxuICAgICAgICAgICAgaWYgKHNlbGVjdGVkUm93cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHNlbGVjdGVkSWRzID0gc2VsZWN0ZWRSb3dzLm1hcChuID0+IG5bdGhpcy5pbnMuaWRGaWVsZF0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBjb25zdCBfaWRzID0gdGhpcy5nZXRTZWxlY3RlZElkcygpO1xyXG4gICAgICAgIC8vIHNlbGVjdGVkSWRzID0gc2VsZWN0ZWRJZHMuY29uY2F0KF9pZHMpO1xyXG4gICAgICAgIC8vIHNlbGVjdGVkSWRzID0gQXJyYXkuZnJvbShuZXcgU2V0KHNlbGVjdGVkSWRzKSk7XHJcblxyXG4gICAgICAgIGlmIChzZWxlY3RlZElkcyAmJiBzZWxlY3RlZElkcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmlzVHJlZSgpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyDmoJHooahcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWQ0VHJlZXRhYmxlKHQsIHNlbGVjdGVkSWRzKTtcclxuICAgICAgICAgICAgICAgIGlmICghdC5jZFJlZi5kZXN0cm95ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0LmNkUmVmLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIOWIl+ihqFxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZDREYXRhdGFibGUodCwgaXRlbXMsIHNlbGVjdGVkSWRzKTtcclxuICAgICAgICAgICAgICAgIGlmICghdC5jZC5kZXN0cm95ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0LmNkLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldERhdGFDbXBJbnN0YW5jZSgpIHtcclxuICAgICAgICBsZXQgcmVmID0gbnVsbDtcclxuICAgICAgICBsZXQgaXRlbXMgPSBudWxsO1xyXG4gICAgICAgIGlmICh0aGlzLmlucy5hY3RpdmVUYWIgPT09ICdkYXRhbGlzdCcpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmlzVHJlZSgpKSB7XHJcbiAgICAgICAgICAgICAgICByZWYgPSB0aGlzLmlucy5sb29rdXBDbXBNZ3IuZ2V0Q29tcG9uZW50SW5zdGFuY2UoJ3RyZWV0YWJsZScpO1xyXG4gICAgICAgICAgICAgICAgaXRlbXMgPSAocmVmIGFzIFRyZWVUYWJsZUNvbXBvbmVudCkuc2VyaWFsaXplZFZhbHVlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaXRlbXMgPSB0aGlzLmlucy5pdGVtcztcclxuICAgICAgICAgICAgICAgIHJlZiA9IHRoaXMuaW5zLmxvb2t1cENtcE1nci5nZXRDb21wb25lbnRJbnN0YW5jZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlucy5hY3RpdmVUYWIgPT09ICdmYXZvcml0ZScpIHtcclxuICAgICAgICAgICAgcmVmID0gdGhpcy5pbnMubG9va3VwQ21wTWdyLmdldENvbXBvbmVudEluc3RhbmNlKCdmYXYnKTtcclxuICAgICAgICAgICAgaXRlbXMgPSB0aGlzLmlucy5mYXZvcml0ZUl0ZW1zO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4geyBjbXBSZWZJbnN0YW5jZTogcmVmLCBpdGVtcyB9O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2VsZWN0ZWQ0RGF0YXRhYmxlKHQ6IGFueSwgaXRlbXM6IGFueSwgdmFsdWVzOiBhbnkpIHtcclxuICAgICAgICBpZiAodGhpcy5pbnMuc2luZ2xlU2VsZWN0KSB7XHJcbiAgICAgICAgICAgIGl0ZW1zLmZvckVhY2goKGl0ZW0sIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXRlbVt0aGlzLmlucy5pZEZpZWxkXSA9PT0gdmFsdWVzWzBdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0LmR0Qm9keS5pc1NlbGVjdGVkKGl0ZW0pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHQuZHRCb2R5LnNlbGVjdGVkUm93SW5kZXggPSAtMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdC5kdEJvZHkuc2VsZWN0ZWRSb3coJycsIGluZGV4LCBpdGVtKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIGNvbnN0IHZhbHVlcyA9IHRoaXMuZ2V0U2VsZWN0ZWRJZHMoKTtcclxuICAgICAgICAgICAgdmFsdWVzLmZvckVhY2goaWQgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgciA9IGl0ZW1zLmZpbmQobiA9PiBuW3RoaXMuaW5zLmlkRmllbGRdID09IGlkKTtcclxuICAgICAgICAgICAgICAgIGlmIChyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdC5jaGVja1JvdyhpZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNlbGVjdGVkNFRyZWV0YWJsZSh0OiBhbnksIHZhbHVlQXJyOiBhbnkpIHtcclxuICAgICAgICBpZiAodGhpcy5pbnMuc2luZ2xlU2VsZWN0KSB7XHJcbiAgICAgICAgICAgIHQuc2VsZWN0Tm9kZSh2YWx1ZUFyclswXSwgZmFsc2UsIGZhbHNlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyBjb25zdCB2YWx1ZUFyciA9IHRoaXMuZ2V0U2VsZWN0ZWRJZHMoKTtcclxuICAgICAgICAgICAgdC5jaGVja2VkTm9kZXModmFsdWVBcnIsIGZhbHNlLCBmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIHQuc2VsZWN0Tm9kZXModmFsdWVBcnIpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRTZWxlY3RlZElkcygpIHtcclxuICAgICAgICBsZXQgdmFsdWVzID0gW107XHJcbiAgICAgICAgY29uc3QgcyA9IHRoaXMuaW5zLm11bHRpcGxlQ2hvaWNlU2VwYXJhdG9yOyAvLyDlpJrpgInliIbpmpTnrKZcclxuICAgICAgICBpZiAoIXRoaXMuaW5zLnNpbmdsZVNlbGVjdCAmJiB0aGlzLmlucy5kaXNwbGF5VmFsdWUgJiYgKCcnICsgdGhpcy5pbnMuZGlzcGxheVZhbHVlKS5pbmRleE9mKHMpID4gLTEpIHtcclxuICAgICAgICAgICAgdmFsdWVzID0gdGhpcy5pbnMuZGlzcGxheVZhbHVlLnNwbGl0KHMpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5kaXNwbGF5VmFsdWUgIT09IG51bGwgJiYgdGhpcy5pbnMuZGlzcGxheVZhbHVlICE9PSAnJyAmJiB0aGlzLmlucy5kaXNwbGF5VmFsdWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgdmFsdWVzID0gW3RoaXMuaW5zLmRpc3BsYXlWYWx1ZV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIC8vIOWQr+eUqOaYvuekuuWkmumAieWIl+ihqFxyXG4gICAgICAgIC8vIGlmICh0aGlzLmlucy5zaG93U2VsZWN0ZWQpIHtcclxuICAgICAgICAvLyAgICAgY29uc3Qgcm93cyA9IHRoaXMuaW5zLmxvb2t1cFNlbGVjdGlvblNlci5nZXRTZWxlY3Rpb25zKCk7XHJcbiAgICAgICAgLy8gICAgIGlmIChyb3dzICYmIHJvd3MubGVuZ3RoKSB7XHJcbiAgICAgICAgLy8gICAgICAgICB2YWx1ZXMgPSByb3dzLm1hcChuID0+IG5bdGhpcy5pbnMuaWRGaWVsZF0pO1xyXG4gICAgICAgIC8vICAgICB9XHJcbiAgICAgICAgLy8gfVxyXG5cclxuICAgICAgICByZXR1cm4gdmFsdWVzO1xyXG4gICAgfVxyXG59XHJcblxyXG5cclxuXHJcbiJdfQ==