/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
var TreeNodeHelper = /** @class */ (function () {
    function TreeNodeHelper(instance) {
        this.instance = instance;
        this.flatAllNodes = [];
    }
    /**
     * @param {?} treeNode
     * @return {?}
     */
    TreeNodeHelper.prototype.getTreeInfo = /**
     * @param {?} treeNode
     * @return {?}
     */
    function (treeNode) {
        if (treeNode.data[this.treeInfo.dataField]) {
            return treeNode.data[this.treeInfo.dataField];
        }
        /** @type {?} */
        var data = treeNode.data;
        if (data && this.treeInfo.dataField) {
            /** @type {?} */
            var treeInfoDataField_1 = this.treeInfo.dataField.toLowerCase();
            /** @type {?} */
            var dataField = Object.keys(treeNode.data).find((/**
             * @param {?} n
             * @return {?}
             */
            function (n) {
                return n.toLowerCase() === treeInfoDataField_1;
            }));
            if (dataField) {
                return data[dataField];
            }
            else {
                this.instance.writeConsole("\u672A\u627E\u5230\u6811\u5F62\u4FE1\u606F\u6570\u636E\u5B57\u6BB5\u3010" + this.treeInfo.dataField + "\u3011", 'error');
            }
        }
        else {
            this.instance.writeConsole("\u672A\u627E\u5230\u6811\u5F62\u4FE1\u606F\u6570\u636E\u5B57\u6BB5\u3010" + this.treeInfo.dataField + "\u3011", 'error');
        }
    };
    /**
     * @param {?} treeNode
     * @return {?}
     */
    TreeNodeHelper.prototype.getTreeNodeLayer = /**
     * @param {?} treeNode
     * @return {?}
     */
    function (treeNode) {
        return this.getTreeInfo(treeNode)[this.treeInfo.layerField];
    };
    /** 更新节点的展开状态。 根据组件中 expandLevel 的值决定
     * -1：不展开，0：全部展开，>0 展开到指定级数
     */
    /**
     * 更新节点的展开状态。 根据组件中 expandLevel 的值决定
     * -1：不展开，0：全部展开，>0 展开到指定级数
     * @param {?} treeNodes
     * @param {?=} treeInfo
     * @return {?}
     */
    TreeNodeHelper.prototype.updateTreeNodeExpanded = /**
     * 更新节点的展开状态。 根据组件中 expandLevel 的值决定
     * -1：不展开，0：全部展开，>0 展开到指定级数
     * @param {?} treeNodes
     * @param {?=} treeInfo
     * @return {?}
     */
    function (treeNodes, treeInfo) {
        var _this = this;
        if (treeInfo === void 0) { treeInfo = null; }
        if (treeInfo) {
            this.treeInfo = treeInfo;
        }
        else {
            this.treeInfo = this.instance.treeInfo;
        }
        /** @type {?} */
        var expandLevel = this.instance.expandLevel;
        if (expandLevel === -1) {
            return;
        }
        if (!this.flatAllNodes.length) {
            this.flatAllNodes = this.treeData2Flat(null, treeNodes, 0, []);
        }
        treeNodes.forEach((/**
         * @param {?} tn
         * @return {?}
         */
        function (tn) {
            tn.expanded = _this.shoudExpand(expandLevel, _this.getTreeNodeLayer(tn));
            if (_this.isSelectNodeParent(tn)) {
                tn.expanded = true;
            }
            if (tn.children && tn.children.length) {
                _this.updateTreeNodeExpanded(tn.children, treeInfo);
            }
            else {
                tn.leaf = true;
            }
        }));
    };
    /**
     * @private
     * @param {?} parent
     * @param {?} nodes
     * @param {?} level
     * @param {?} parentIds
     * @return {?}
     */
    TreeNodeHelper.prototype.treeData2Flat = /**
     * @private
     * @param {?} parent
     * @param {?} nodes
     * @param {?} level
     * @param {?} parentIds
     * @return {?}
     */
    function (parent, nodes, level, parentIds) {
        var _this = this;
        /** @type {?} */
        var idField = this.instance.idField;
        /** @type {?} */
        var arr = [];
        if (nodes && nodes.length) {
            nodes.forEach((/**
             * @param {?} node
             * @param {?} index
             * @return {?}
             */
            function (node, index) {
                // node.parent = parent;
                // node.parent = parent;
                /** @type {?} */
                var parents = [];
                if (parent) {
                    /** @type {?} */
                    var parentID = parent.data[idField];
                    /** @type {?} */
                    var _parents = parentIds || [];
                    parents = parents.concat(_parents.map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    function (n) { return n; })));
                    parents.push(parentID);
                }
                /** @type {?} */
                var rowNode = {
                    id: node.data[idField],
                    node: node,
                    level: level,
                    parents: parents,
                };
                arr.push(rowNode);
                arr = arr.concat(_this.treeData2Flat(node, node.children, level + 1, parents));
            }));
        }
        return arr;
    };
    /**
     * @private
     * @param {?} expandLevel
     * @param {?} nodeLayer
     * @return {?}
     */
    TreeNodeHelper.prototype.shoudExpand = /**
     * @private
     * @param {?} expandLevel
     * @param {?} nodeLayer
     * @return {?}
     */
    function (expandLevel, nodeLayer) {
        if (expandLevel === -1) {
            // -1 为不展开
            return false;
        }
        else if (expandLevel === 0) {
            // 0 为全部展开
            return true;
        }
        else {
            // 没有启用分层加载，通过展开层级确定是否展开该节点
            return nodeLayer <= expandLevel;
        }
    };
    /**
     * @private
     * @param {?} treeNode
     * @return {?}
     */
    TreeNodeHelper.prototype.isSelectNodeParent = /**
     * @private
     * @param {?} treeNode
     * @return {?}
     */
    function (treeNode) {
        var _this = this;
        if (this.instance.navSelectedIds) {
            /** @type {?} */
            var allParentIds = this.flatAllNodes.find((/**
             * @param {?} f
             * @return {?}
             */
            function (f) { return f.id === _this.instance.navSelectedIds; })).parents;
            if (allParentIds && allParentIds.length) {
                return allParentIds.includes(treeNode.id);
            }
            return false;
        }
        return false;
    };
    /**
     * @param {?} treeNode
     * @return {?}
     */
    TreeNodeHelper.prototype.getLeafNode = /**
     * @param {?} treeNode
     * @return {?}
     */
    function (treeNode) {
        if (treeNode && (!treeNode.children || !treeNode.children.length)) {
            return treeNode;
        }
        else {
            if (treeNode.children.length === 1) {
                return this.getLeafNode(treeNode.children[0]);
            }
            else {
                return treeNode.children;
            }
        }
    };
    /**
     * @param {?} items
     * @param {?=} result
     * @return {?}
     */
    TreeNodeHelper.prototype.flatTreeNodes = /**
     * @param {?} items
     * @param {?=} result
     * @return {?}
     */
    function (items, result) {
        var _this = this;
        if (result === void 0) { result = []; }
        items = items || [];
        return items.reduce((/**
         * @param {?} c
         * @param {?} n
         * @return {?}
         */
        function (c, n) {
            c.push(n);
            if (n.children && n.children.length) {
                _this.flatTreeNodes(n.children, c);
            }
            return c;
        }), result);
    };
    return TreeNodeHelper;
}());
export { TreeNodeHelper };
if (false) {
    /** @type {?} */
    TreeNodeHelper.prototype.treeInfo;
    /** @type {?} */
    TreeNodeHelper.prototype.flatAllNodes;
    /**
     * @type {?}
     * @private
     */
    TreeNodeHelper.prototype.instance;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZW5vZGUuaGVscGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvdHJlZW5vZGUuaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFJQTtJQUdJLHdCQUFvQixRQUE2QjtRQUE3QixhQUFRLEdBQVIsUUFBUSxDQUFxQjtRQURqRCxpQkFBWSxHQUFHLEVBQUUsQ0FBQztJQUNtQyxDQUFDOzs7OztJQUV0RCxvQ0FBVzs7OztJQUFYLFVBQVksUUFBa0I7UUFDMUIsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDeEMsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDakQ7O1lBRUssSUFBSSxHQUFHLFFBQVEsQ0FBQyxJQUFJO1FBQzFCLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFOztnQkFFM0IsbUJBQWlCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFOztnQkFDekQsU0FBUyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUk7Ozs7WUFBQyxVQUFBLENBQUM7Z0JBQy9DLE9BQU8sQ0FBQyxDQUFDLFdBQVcsRUFBRSxLQUFLLG1CQUFpQixDQUFDO1lBQ2pELENBQUMsRUFBQztZQUNGLElBQUksU0FBUyxFQUFFO2dCQUNYLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQzFCO2lCQUFNO2dCQUNILElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLDZFQUFlLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxXQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7YUFDbEY7U0FDSjthQUFNO1lBQ0gsSUFBSSxDQUFDLFFB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QUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUMvRCxPQUFPLFFBQVEsQ0FBQztTQUNuQjthQUFNO1lBQ0gsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7Z0JBQ2hDLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDakQ7aUJBQU07Z0JBQ0gsT0FBTyxRQUFRLENBQUMsUUFBUSxDQUFDO2FBQzVCO1NBQ0o7SUFDTCxDQUFDOzs7Ozs7SUFFRCxzQ0FBYTs7Ozs7SUFBYixVQUFjLEtBQUssRUFBRSxNQUFXO1FBQWhDLGlCQVNDO1FBVG9CLHVCQUFBLEVBQUEsV0FBVztRQUM1QixLQUFLLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUNwQixPQUFRLEtBQUssQ0FBQyxNQUFNOzs7OztRQUFDLFVBQUMsQ0FBQyxFQUFFLENBQUM7WUFDdEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNWLElBQUksQ0FBQyxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRTtnQkFDakMsS0FBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ3JDO1lBQ0QsT0FBTyxDQUFDLENBQUM7UUFDYixDQUFDLEdBQUUsTUFBTSxDQUFDLENBQUM7SUFDZixDQUFDO0lBQ0wscUJBQUM7QUFBRCxDQUFDLEFBdElELElBc0lDOzs7O0lBcklHLGtDQUFtQjs7SUFDbkIsc0NBQWtCOzs7OztJQUNOLGtDQUFxQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRyZWVOb2RlIH0gZnJvbSAnQGZhcnJpcy91aS10cmVldGFibGUnO1xyXG5pbXBvcnQgeyBMb29rdXBHcmlkQ29tcG9uZW50IH0gZnJvbSAnLi4vbG9va3VwLWdyaWQuY29tcG9uZW50JztcclxuaW1wb3J0IHsgVHJlZUluZm8gfSBmcm9tICcuLi9sb29rdXAtZ3JpZC1vcHRpb25zJztcclxuXHJcbmV4cG9ydCBjbGFzcyBUcmVlTm9kZUhlbHBlciB7XHJcbiAgICB0cmVlSW5mbzogVHJlZUluZm87XHJcbiAgICBmbGF0QWxsTm9kZXMgPSBbXTtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5zdGFuY2U6IExvb2t1cEdyaWRDb21wb25lbnQpIHsgfVxyXG5cclxuICAgIGdldFRyZWVJbmZvKHRyZWVOb2RlOiBUcmVlTm9kZSkge1xyXG4gICAgICAgIGlmICh0cmVlTm9kZS5kYXRhW3RoaXMudHJlZUluZm8uZGF0YUZpZWxkXSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJlZU5vZGUuZGF0YVt0aGlzLnRyZWVJbmZvLmRhdGFGaWVsZF07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBkYXRhID0gdHJlZU5vZGUuZGF0YTtcclxuICAgICAgICBpZiAoZGF0YSAmJiB0aGlzLnRyZWVJbmZvLmRhdGFGaWVsZCkge1xyXG5cclxuICAgICAgICAgICAgY29uc3QgdHJlZUluZm9EYXRhRmllbGQgPSB0aGlzLnRyZWVJbmZvLmRhdGFGaWVsZC50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgICBjb25zdCBkYXRhRmllbGQgPSBPYmplY3Qua2V5cyh0cmVlTm9kZS5kYXRhKS5maW5kKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG4udG9Mb3dlckNhc2UoKSA9PT0gdHJlZUluZm9EYXRhRmllbGQ7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBpZiAoZGF0YUZpZWxkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YVtkYXRhRmllbGRdO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnN0YW5jZS53cml0ZUNvbnNvbGUoYOacquaJvuWIsOagkeW9ouS/oeaBr+aVsOaNruWtl+auteOAkCR7dGhpcy50cmVlSW5mby5kYXRhRmllbGR944CRYCwgJ2Vycm9yJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmluc3RhbmNlLndyaXRlQ29uc29sZShg5pyq5om+5Yiw5qCR5b2i5L+h5oGv5pWw5o2u5a2X5q6144CQJHt0aGlzLnRyZWVJbmZvLmRhdGFGaWVsZH3jgJFgLCAnZXJyb3InKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VHJlZU5vZGVMYXllcih0cmVlTm9kZTogVHJlZU5vZGUpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRUcmVlSW5mbyh0cmVlTm9kZSlbdGhpcy50cmVlSW5mby5sYXllckZpZWxkXTtcclxuICAgIH1cclxuICAgIC8qKiDmm7TmlrDoioLngrnnmoTlsZXlvIDnirbmgIHjgIIg5qC55o2u57uE5Lu25LitIGV4cGFuZExldmVsIOeahOWAvOWGs+WumlxyXG4gICAgICogLTHvvJrkuI3lsZXlvIDvvIww77ya5YWo6YOo5bGV5byA77yMPjAg5bGV5byA5Yiw5oyH5a6a57qn5pWwXHJcbiAgICAgKi9cclxuICAgIHVwZGF0ZVRyZWVOb2RlRXhwYW5kZWQodHJlZU5vZGVzOiBUcmVlTm9kZVtdLCB0cmVlSW5mbzogVHJlZUluZm8gPSBudWxsKSB7XHJcbiAgICAgICAgaWYgKHRyZWVJbmZvKSB7XHJcbiAgICAgICAgICAgIHRoaXMudHJlZUluZm8gPSB0cmVlSW5mbztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnRyZWVJbmZvID0gdGhpcy5pbnN0YW5jZS50cmVlSW5mbztcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZXhwYW5kTGV2ZWwgPSB0aGlzLmluc3RhbmNlLmV4cGFuZExldmVsO1xyXG4gICAgICAgIGlmIChleHBhbmRMZXZlbCA9PT0gLTEpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRoaXMuZmxhdEFsbE5vZGVzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICB0aGlzLmZsYXRBbGxOb2RlcyA9IHRoaXMudHJlZURhdGEyRmxhdChudWxsLCB0cmVlTm9kZXMsIDAsIFtdKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRyZWVOb2Rlcy5mb3JFYWNoKCh0bjogVHJlZU5vZGUpID0+IHtcclxuICAgICAgICAgICAgdG4uZXhwYW5kZWQgPSB0aGlzLnNob3VkRXhwYW5kKGV4cGFuZExldmVsLCB0aGlzLmdldFRyZWVOb2RlTGF5ZXIodG4pKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaXNTZWxlY3ROb2RlUGFyZW50KHRuKSkge1xyXG4gICAgICAgICAgICAgICAgdG4uZXhwYW5kZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0bi5jaGlsZHJlbiAmJiB0bi5jaGlsZHJlbi5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlVHJlZU5vZGVFeHBhbmRlZCh0bi5jaGlsZHJlbiwgdHJlZUluZm8pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdG4ubGVhZiA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHRyZWVEYXRhMkZsYXQocGFyZW50LCBub2RlcywgbGV2ZWwsIHBhcmVudElkcykge1xyXG4gICAgICAgIGNvbnN0IGlkRmllbGQgPSB0aGlzLmluc3RhbmNlLmlkRmllbGQ7XHJcbiAgICAgICAgbGV0IGFyciA9IFtdO1xyXG4gICAgICAgIGlmIChub2RlcyAmJiBub2Rlcy5sZW5ndGgpIHtcclxuXHJcbiAgICAgICAgICAgIG5vZGVzLmZvckVhY2goKG5vZGUsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyBub2RlLnBhcmVudCA9IHBhcmVudDtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgcGFyZW50cyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgaWYgKHBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudElEID0gcGFyZW50LmRhdGFbaWRGaWVsZF07XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgX3BhcmVudHMgPSBwYXJlbnRJZHMgfHwgW107XHJcbiAgICAgICAgICAgICAgICAgICAgcGFyZW50cyA9IHBhcmVudHMuY29uY2F0KF9wYXJlbnRzLm1hcChuID0+IG4pKTtcclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnRzLnB1c2gocGFyZW50SUQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY29uc3Qgcm93Tm9kZSA9IHtcclxuICAgICAgICAgICAgICAgICAgICBpZDogbm9kZS5kYXRhW2lkRmllbGRdLFxyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUsXHJcbiAgICAgICAgICAgICAgICAgICAgbGV2ZWwsXHJcbiAgICAgICAgICAgICAgICAgICAgcGFyZW50cyxcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICBhcnIucHVzaChyb3dOb2RlKTtcclxuICAgICAgICAgICAgICAgIGFyciA9IGFyci5jb25jYXQodGhpcy50cmVlRGF0YTJGbGF0KG5vZGUsIG5vZGUuY2hpbGRyZW4sIGxldmVsICsgMSwgcGFyZW50cykpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGFycjtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNob3VkRXhwYW5kKGV4cGFuZExldmVsOiBudW1iZXIsIG5vZGVMYXllcjogbnVtYmVyKSB7XHJcbiAgICAgICAgaWYgKGV4cGFuZExldmVsID09PSAtMSkge1xyXG4gICAgICAgICAgICAvLyAtMSDkuLrkuI3lsZXlvIBcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoZXhwYW5kTGV2ZWwgPT09IDApIHtcclxuICAgICAgICAgICAgLy8gMCDkuLrlhajpg6jlsZXlvIBcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8g5rKh5pyJ5ZCv55So5YiG5bGC5Yqg6L2977yM6YCa6L+H5bGV5byA5bGC57qn56Gu5a6a5piv5ZCm5bGV5byA6K+l6IqC54K5XHJcbiAgICAgICAgICAgIHJldHVybiBub2RlTGF5ZXIgPD0gZXhwYW5kTGV2ZWw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaXNTZWxlY3ROb2RlUGFyZW50KHRyZWVOb2RlKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zdGFuY2UubmF2U2VsZWN0ZWRJZHMpIHtcclxuICAgICAgICAgICAgY29uc3QgYWxsUGFyZW50SWRzOiBzdHJpbmdbXSA9IHRoaXMuZmxhdEFsbE5vZGVzLmZpbmQoZiA9PiBmLmlkID09PSB0aGlzLmluc3RhbmNlLm5hdlNlbGVjdGVkSWRzKS5wYXJlbnRzO1xyXG4gICAgICAgICAgICBpZiAoYWxsUGFyZW50SWRzICYmIGFsbFBhcmVudElkcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhbGxQYXJlbnRJZHMuaW5jbHVkZXModHJlZU5vZGUuaWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldExlYWZOb2RlKHRyZWVOb2RlOiBUcmVlTm9kZSkge1xyXG4gICAgICAgIGlmICh0cmVlTm9kZSAmJiAoIXRyZWVOb2RlLmNoaWxkcmVuIHx8ICF0cmVlTm9kZS5jaGlsZHJlbi5sZW5ndGgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cmVlTm9kZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodHJlZU5vZGUuY2hpbGRyZW4ubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRMZWFmTm9kZSh0cmVlTm9kZS5jaGlsZHJlblswXSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJlZU5vZGUuY2hpbGRyZW47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZmxhdFRyZWVOb2RlcyhpdGVtcywgcmVzdWx0ID0gW10pIHtcclxuICAgICAgICBpdGVtcyA9IGl0ZW1zIHx8IFtdO1xyXG4gICAgICAgIHJldHVybiAgaXRlbXMucmVkdWNlKChjLCBuKSA9PiB7XHJcbiAgICAgICAgICAgIGMucHVzaChuKTtcclxuICAgICAgICAgICAgaWYgKG4uY2hpbGRyZW4gJiYgbi5jaGlsZHJlbi5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZmxhdFRyZWVOb2RlcyhuLmNoaWxkcmVuLCBjKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gYztcclxuICAgICAgICB9LCByZXN1bHQpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==