/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of } from 'rxjs';
import { switchMap } from 'rxjs/operators';
/**
 * 检查帮助输入框值变化后返回的查询结果
 * @param {?=} data
 * @return {?}
 */
function checkSearchResult(data) {
    if (data === void 0) { data = null; }
    if (this.searchOnServer) {
        // this._searchResult = data;
        // this.showDialog();
        this.isShow = true;
    }
    else {
        if (data === false) {
            this.cancelSelect();
        }
        else {
            this.setModelValue(this.displayText);
            this.runDictPickedEvent(null);
        }
    }
}
/**
 * @return {?}
 */
export function onTextChanged() {
    var _this = this;
    /** @type {?} */
    var self = this;
    /** @type {?} */
    var isPending = (/**
     * @return {?}
     */
    function () {
        return _this.lookupUtils.rts.getFormState('lookup.pending');
    });
    /** @type {?} */
    var searchData = (/**
     * @param {?} e
     * @return {?}
     */
    function (e) {
        if (_this.isShow) {
            return;
        }
        if (_this.isTextChange && _this.displayText && (!_this.nosearch || e.originalEvent) && !isPending()) {
            _this.lookupUtils.pendingStart();
            _this.dictPickingSubscription = _this.dictPicking({
                instance: _this
            }).pipe(switchMap((/**
             * @param {?} pr
             * @return {?}
             */
            function (pr) {
                /** @type {?} */
                var o = true;
                if (pr === undefined || pr === null) {
                    o = true;
                }
                if (typeof pr === 'boolean') {
                    o = pr;
                }
                if (typeof pr === 'object') {
                    if (pr.showDialog === undefined) {
                        o = true;
                    }
                    else {
                        o = pr.showDialog;
                    }
                    if (pr.data) {
                        /** 保存帮助前传递的数据 */
                        _this.customData = pr.data;
                    }
                }
                if (o) {
                    return _this.httpMgr.getData({
                        search: {
                            field: '*',
                            value: _this.displayText,
                            type: 'equal'
                        }
                    }, 'search');
                }
                else {
                    return of({ SHOWDIALOG: o, MESSAGE: pr.message || '' });
                }
            }))).subscribe((/**
             * @param {?} data
             * @return {?}
             */
            function (data) {
                _this.closeLoading();
                _this.lookupUtils.pendingEnd();
                if (data.hasOwnProperty('SHOWDIALOG')) {
                    if (data.SHOWDIALOG && data.MESSAGE) {
                        _this.notifyService.warning(data.MESSAGE);
                    }
                    return;
                }
                if (data.items && data.items.length === 1 && (!data.items[0].children || !data.items[0].children.length)) {
                    /** @type {?} */
                    var rowdata = data.items[0];
                    if (_this.isTree()) {
                        /** @type {?} */
                        var leafNode = _this.treeNodeHelper.getLeafNode(rowdata);
                        /** @type {?} */
                        var isOnlySelectLeaf = false;
                        if (!_this.treeInfo) {
                            _this.setTreeInfo(data);
                        }
                        if (typeof _this.treeInfo.onlySelectLeaf === 'boolean') {
                            isOnlySelectLeaf = _this.treeInfo.onlySelectLeaf;
                        }
                        else if (typeof _this.treeInfo.onlySelectLeaf === 'string') {
                            if (_this.treeInfo.onlySelectLeaf === 'yes') {
                                isOnlySelectLeaf = true;
                            }
                            else if (_this.treeInfo.onlySelectLeaf === 'no') {
                                isOnlySelectLeaf = false;
                            }
                            else {
                                if (_this.treeInfo.onlySelectLeaf === 'default') {
                                    isOnlySelectLeaf = data.treeInfo.onlySelectLeaf;
                                }
                            }
                        }
                        if (isOnlySelectLeaf && !leafNode.leaf) {
                            // this.displayText = '';
                            checkSearchResult.bind(self, data)();
                            return;
                        }
                        if (Array.isArray(leafNode)) {
                            checkSearchResult.bind(self, data)();
                            return;
                        }
                        else {
                            rowdata = leafNode.data;
                        }
                    }
                    if (!_this.singleSelect) {
                        rowdata = [rowdata];
                    }
                    _this.selectItem(rowdata);
                    _this.dialogClosed.emit();
                }
                else {
                    checkSearchResult.bind(self, data)();
                }
            }), (/**
             * @param {?} err
             * @return {?}
             */
            function (err) {
                _this.closeLoading();
                _this.lookupUtils.pendingEnd();
                _this.messagerService.error(err ? err.Message : err);
            }));
        }
    });
    /** @type {?} */
    var inputBlurHandler = null;
    if (this.inputGroup && this.inputGroup.textbox && !this.nosearch) {
        this.lookupUtils.setActiveLookupInstance(this);
        inputBlurHandler = this.render2.listen(this.inputGroup.textbox.nativeElement, 'blur', searchData);
    }
    if (this.inputGroup) {
        this.inputGroup.enterHandle.subscribe(searchData);
        this.inputGroup.keydownHandle.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            /** @type {?} */
            var canOpen = false;
            if (e.code === 'ArrowRight') {
                if (_this.quickSelect && !_this.quickSelect.enable) {
                    _this.writeConsole('启用快捷选择后，右方向键禁用打开帮助', 'warn');
                    return;
                }
                if (_this.editable) {
                    canOpen = !e.target.value || e.target.selectionStart === e.target.value.length;
                }
                else {
                    canOpen = true;
                }
            }
            else {
                canOpen = e.code === _this.shortcutKey.open;
            }
            if (canOpen) {
                e.stopPropagation();
                e.preventDefault();
                _this.showDialog();
            }
        }));
    }
    return inputBlurHandler;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib24tdGV4dC1jaGFuZ2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9vbi10ZXh0LWNoYW5nZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFTLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7Ozs7OztBQU0zQyxTQUFTLGlCQUFpQixDQUFDLElBQVc7SUFBWCxxQkFBQSxFQUFBLFdBQVc7SUFDbEMsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFO1FBQ3JCLDZCQUE2QjtRQUM3QixxQkFBcUI7UUFDckIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7S0FDdEI7U0FBTTtRQUNILElBQUksSUFBSSxLQUFLLEtBQUssRUFBRTtZQUNoQixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7U0FDdkI7YUFBTTtZQUNILElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3JDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNqQztLQUNKO0FBQ0wsQ0FBQzs7OztBQUVELE1BQU0sVUFBVSxhQUFhO0lBQTdCLGlCQW9LQzs7UUFsS1MsSUFBSSxHQUFHLElBQUk7O1FBRVgsU0FBUzs7O0lBQUc7UUFDZCxPQUFPLEtBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQy9ELENBQUMsQ0FBQTs7UUFFSyxVQUFVOzs7O0lBQUcsVUFBQyxDQUFDO1FBRWpCLElBQUksS0FBSSxDQUFDLE1BQU0sRUFBRTtZQUNiLE9BQU87U0FDVjtRQUVELElBQUksS0FBSSxDQUFDLFlBQVksSUFBSSxLQUFJLENBQUMsV0FBVyxJQUFJLENBQUMsQ0FBQyxLQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsQ0FB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QUFJLEtBQUksQ0FBQyxRQUFRLEVBQUU7b0JBQ2YsT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxjQUFjLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO2lCQUNsRjtxQkFBTTtvQkFDSCxPQUFPLEdBQUcsSUFBSSxDQUFDO2lCQUNsQjthQUNKO2lCQUFNO2dCQUNILE9BQU8sR0FBRyxDQUFDLENBQUMsSUFBSSxLQUFLLEtBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO2FBQzlDO1lBQ0QsSUFBSSxPQUFPLEVBQUU7Z0JBQ1QsQ0FBQyxDQUFDLGVBQWUsRUFBRSxDQUFDO2dCQUNwQixDQUFDLENBQUMsY0FBYyxFQUFFLENBQUM7Z0JBQ25CLEtBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQzthQUNyQjtRQUNMLENBQUMsRUFBQyxDQUFDO0tBQ047SUFFRCxPQUFPLGdCQUFnQixDQUFDO0FBRTVCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFTVBUWSwgb2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBMb29rdXBHcmlkUmVzdWx0LCBQaWNraW5nUmVzdWx0IH0gZnJvbSAnLi4vbG9va3VwLWdyaWQtb3B0aW9ucyc7XHJcblxyXG5cclxuXHJcbiAvKiog5qOA5p+l5biu5Yqp6L6T5YWl5qGG5YC85Y+Y5YyW5ZCO6L+U5Zue55qE5p+l6K+i57uT5p6cICovXHJcbmZ1bmN0aW9uIGNoZWNrU2VhcmNoUmVzdWx0KGRhdGEgPSBudWxsKSB7XHJcbiAgICBpZiAodGhpcy5zZWFyY2hPblNlcnZlcikge1xyXG4gICAgICAgIC8vIHRoaXMuX3NlYXJjaFJlc3VsdCA9IGRhdGE7XHJcbiAgICAgICAgLy8gdGhpcy5zaG93RGlhbG9nKCk7XHJcbiAgICAgICAgdGhpcy5pc1Nob3cgPSB0cnVlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoZGF0YSA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgdGhpcy5jYW5jZWxTZWxlY3QoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnNldE1vZGVsVmFsdWUodGhpcy5kaXNwbGF5VGV4dCk7XHJcbiAgICAgICAgICAgIHRoaXMucnVuRGljdFBpY2tlZEV2ZW50KG51bGwpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG9uVGV4dENoYW5nZWQoKSB7XHJcblxyXG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgY29uc3QgaXNQZW5kaW5nID0gKCkgPT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmxvb2t1cFV0aWxzLnJ0cy5nZXRGb3JtU3RhdGUoJ2xvb2t1cC5wZW5kaW5nJyk7XHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IHNlYXJjaERhdGEgPSAoZSkgPT4ge1xyXG5cclxuICAgICAgICBpZiAodGhpcy5pc1Nob3cpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaXNUZXh0Q2hhbmdlICYmIHRoaXMuZGlzcGxheVRleHQgJiYgKCF0aGlzLm5vc2VhcmNoIHx8IGUub3JpZ2luYWxFdmVudCkgJiYgIWlzUGVuZGluZygpKSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwVXRpbHMucGVuZGluZ1N0YXJ0KCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRpY3RQaWNraW5nU3Vic2NyaXB0aW9uID0gdGhpcy5kaWN0UGlja2luZyh7XHJcbiAgICAgICAgICAgICAgICBpbnN0YW5jZTogdGhpc1xyXG4gICAgICAgICAgICB9KS5waXBlKFxyXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKChwcjogUGlja2luZ1Jlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBvID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocHIgPT09IHVuZGVmaW5lZCB8fCBwciA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcHIgPT09ICdib29sZWFuJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvID0gcHI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHByID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHIuc2hvd0RpYWxvZyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8gPSBwci5zaG93RGlhbG9nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHIuZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLyoqIOS/neWtmOW4ruWKqeWJjeS8oOmAkueahOaVsOaNriAqL1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXN0b21EYXRhID0gcHIuZGF0YTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG8pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaHR0cE1nci5nZXREYXRhKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlYXJjaDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZDogJyonLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5kaXNwbGF5VGV4dCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2VxdWFsJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc2VhcmNoJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZih7IFNIT1dESUFMT0c6IG8sIE1FU1NBR0U6ICBwci5tZXNzYWdlIHx8ICcnIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICkuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29rdXBVdGlscy5wZW5kaW5nRW5kKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuaGFzT3duUHJvcGVydHkoJ1NIT1dESUFMT0cnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5TSE9XRElBTE9HICYmIGRhdGEuTUVTU0FHRSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcoZGF0YS5NRVNTQUdFKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuaXRlbXMgJiYgZGF0YS5pdGVtcy5sZW5ndGggPT09IDEgJiYgKCFkYXRhLml0ZW1zWzBdLmNoaWxkcmVuIHx8ICFkYXRhLml0ZW1zWzBdLmNoaWxkcmVuLmxlbmd0aCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJvd2RhdGEgPSBkYXRhLml0ZW1zWzBdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1RyZWUoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVhZk5vZGUgPSB0aGlzLnRyZWVOb2RlSGVscGVyLmdldExlYWZOb2RlKHJvd2RhdGEpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpc09ubHlTZWxlY3RMZWFmID0gZmFsc2U7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLnRyZWVJbmZvKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRUcmVlSW5mbyhkYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMudHJlZUluZm8ub25seVNlbGVjdExlYWYgPT09ICdib29sZWFuJyApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc09ubHlTZWxlY3RMZWFmID0gdGhpcy50cmVlSW5mby5vbmx5U2VsZWN0TGVhZjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHRoaXMudHJlZUluZm8ub25seVNlbGVjdExlYWYgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudHJlZUluZm8ub25seVNlbGVjdExlYWYgPT09ICd5ZXMnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzT25seVNlbGVjdExlYWYgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50cmVlSW5mby5vbmx5U2VsZWN0TGVhZiA9PT0gJ25vJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc09ubHlTZWxlY3RMZWFmID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudHJlZUluZm8ub25seVNlbGVjdExlYWYgPT09ICdkZWZhdWx0Jykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNPbmx5U2VsZWN0TGVhZiA9IGRhdGEudHJlZUluZm8ub25seVNlbGVjdExlYWY7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzT25seVNlbGVjdExlYWYgJiYgIWxlYWZOb2RlLmxlYWYpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLmRpc3BsYXlUZXh0ID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tTZWFyY2hSZXN1bHQuYmluZChzZWxmLCBkYXRhKSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGxlYWZOb2RlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrU2VhcmNoUmVzdWx0LmJpbmQoc2VsZiwgZGF0YSkoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvd2RhdGEgPSBsZWFmTm9kZS5kYXRhO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5zaW5nbGVTZWxlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvd2RhdGEgPSBbIHJvd2RhdGEgXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdEl0ZW0ocm93ZGF0YSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRpYWxvZ0Nsb3NlZC5lbWl0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tTZWFyY2hSZXN1bHQuYmluZChzZWxmLCBkYXRhKSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sIChlcnI6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29rdXBVdGlscy5wZW5kaW5nRW5kKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNzYWdlclNlcnZpY2UuZXJyb3IoZXJyID8gZXJyLk1lc3NhZ2UgOiBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgbGV0IGlucHV0Qmx1ckhhbmRsZXIgPSBudWxsO1xyXG5cclxuICAgIGlmICh0aGlzLmlucHV0R3JvdXAgJiYgdGhpcy5pbnB1dEdyb3VwLnRleHRib3ggJiYgIXRoaXMubm9zZWFyY2gpIHtcclxuICAgICAgICB0aGlzLmxvb2t1cFV0aWxzLnNldEFjdGl2ZUxvb2t1cEluc3RhbmNlKHRoaXMpO1xyXG4gICAgICAgIGlucHV0Qmx1ckhhbmRsZXIgPSB0aGlzLnJlbmRlcjIubGlzdGVuKHRoaXMuaW5wdXRHcm91cC50ZXh0Ym94Lm5hdGl2ZUVsZW1lbnQsICdibHVyJywgc2VhcmNoRGF0YSApO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmlucHV0R3JvdXApIHtcclxuICAgICAgICB0aGlzLmlucHV0R3JvdXAuZW50ZXJIYW5kbGUuc3Vic2NyaWJlKCBzZWFyY2hEYXRhKTtcclxuXHJcbiAgICAgICAgdGhpcy5pbnB1dEdyb3VwLmtleWRvd25IYW5kbGUuc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgbGV0IGNhbk9wZW4gPSBmYWxzZTtcclxuICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ0Fycm93UmlnaHQnKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucXVpY2tTZWxlY3QgJiYgIXRoaXMucXVpY2tTZWxlY3QuZW5hYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy53cml0ZUNvbnNvbGUoJ+WQr+eUqOW/q+aNt+mAieaLqeWQju+8jOWPs+aWueWQkemUruemgeeUqOaJk+W8gOW4ruWKqScsICd3YXJuJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmVkaXRhYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FuT3BlbiA9ICFlLnRhcmdldC52YWx1ZSB8fCBlLnRhcmdldC5zZWxlY3Rpb25TdGFydCA9PT0gZS50YXJnZXQudmFsdWUubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjYW5PcGVuID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNhbk9wZW4gPSBlLmNvZGUgPT09IHRoaXMuc2hvcnRjdXRLZXkub3BlbjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoY2FuT3Blbikge1xyXG4gICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2hvd0RpYWxvZygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGlucHV0Qmx1ckhhbmRsZXI7XHJcblxyXG59XHJcbiJdfQ==