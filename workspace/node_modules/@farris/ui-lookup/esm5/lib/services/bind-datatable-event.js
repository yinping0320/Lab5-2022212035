/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { of } from 'rxjs';
import { catchError, tap } from 'rxjs/operators';
import { FavoriteAction, FAVORITE_FIELD_NAME } from '../lookup-displaytype';
var DataTableEventManager = /** @class */ (function () {
    function DataTableEventManager(ins) {
        this.ins = ins;
        this._sortState = null;
        this.lookupSelectionSer = this.ins.lookupSelectionSer;
    }
    /**
     * @param {?} conditions
     * @return {?}
     */
    DataTableEventManager.prototype.conditionsChange = /**
     * @param {?} conditions
     * @return {?}
     */
    function (conditions) {
        this.ins.conditions = conditions;
        if (conditions && conditions.length === 1 && conditions[0].code == '*') {
            this.ins.conditions = [];
            this.onSearch({ field: '*', value: conditions[0].value });
        }
        else {
            this.onSearch();
        }
    };
    /**
     * @param {?=} $event
     * @return {?}
     */
    DataTableEventManager.prototype.onSearch = /**
     * @param {?=} $event
     * @return {?}
     */
    function ($event) {
        var _this = this;
        if ($event === void 0) { $event = { field: '*', value: '' }; }
        if ($event && $event.field !== '*' && !$event.value) {
            this.ins.messagerService.warning(this.ins.mustWriteSomething);
            return;
        }
        /** @type {?} */
        var p = {
            pageInfo: { pageIndex: 1, pageSize: this.ins.gridOptions.pageSize },
            search: $event
        };
        if (this._sortState) {
            var _a = this._sortState, sortName = _a.sortName, sortOrder = _a.sortOrder;
            if (sortName) {
                p['sortName'] = sortName;
                p['sortOrder'] = sortOrder;
            }
        }
        if (this.ins.uri) {
            if (!this.ins.searching) {
                this.ins.searching = true;
                if (this.ins['navNodePathCode']) {
                    p['navNodePathCode'] = this.ins['navNodePathCode'];
                }
                this.ins.httpMgr.getData(p, 'list').pipe(catchError((/**
                 * @param {?} err
                 * @return {?}
                 */
                function (err) {
                    _this.ins.searching = false;
                    return of({ "_ERROR_": err });
                })), tap((/**
                 * @return {?}
                 */
                function () {
                    _this.ins.searching = false;
                }))).subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                function (data) {
                    _this.ins.searching = false;
                    _this.ins.closeLoading();
                    if (!data['_ERROR_']) {
                        _this._loadData(data);
                    }
                    else {
                        throw new Error(data['_ERROR_']);
                    }
                }));
            }
        }
        else {
            if (this.ins.enableMultiFieldSearch) {
                this.ins.query.emit({ conditions: this.ins.conditions, instance: this.ins });
            }
            else {
                this.ins.search.emit(p);
            }
        }
    };
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    DataTableEventManager.prototype._loadData = /**
     * @private
     * @param {?} data
     * @return {?}
     */
    function (data) {
        /** @type {?} */
        var self = this.ins;
        self.closeLoading();
        self.favHelper.updateFavoritesStatus(data.items);
        self.loadDataTableData(data);
        // 选中数据
        this.ins.selectionMgr.selectCurrentValue();
    };
    /**
     * @return {?}
     */
    DataTableEventManager.prototype.bindDataTableEvent = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var self = this.ins;
        /** @type {?} */
        var dt = (/** @type {?} */ (self.componentRef.instance));
        dt.selectedRow.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (_this.ins.singleSelect) {
                _this.lookupSelectionSer.clearSelections();
            }
            _this.ins.checkedChange.emit({ data: [e.data], isCheck: true });
            _this.lookupSelectionSer.updateSelections([e.data]);
            dt.cd.detectChanges();
        }));
        dt.unSelectRow.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            _this.lookupSelectionSer.unSelect(e.data[self.idField]);
            _this.ins.checkedChange.emit({ data: [e.data], isCheck: false });
        }));
        dt.checkAll.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            _this.lookupSelectionSer.updateSelections(dt.data, e);
            _this.ins.checkedChange.emit({ data: dt.data, isCheck: e });
        }));
        dt.pageChanged.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (self.uri) {
                self.httpMgr.getData(e, 'list').subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                function (data) {
                    _this._loadData(data);
                }));
            }
            else {
                self.pagerChanged.emit(self.httpMgr.buildQueryParams(e, 'list'));
            }
        }));
        dt.pageSizeChanged.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (self.uri) {
                self.httpMgr.getData(e, 'list').subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                function (data) {
                    _this._loadData(data);
                }), (/**
                 * @param {?} err
                 * @return {?}
                 */
                function (err) {
                    self.closeLoading();
                }));
            }
            else {
                self.pagerChanged.emit(self.httpMgr.buildQueryParams(e, 'list'));
            }
        }));
        dt.search.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            // if (JSON.stringify(self._searchState || {}) !== JSON.stringify(e || {})) {
            //     this.ins.searching = false;
            // }
            self._searchState = tslib_1.__assign({}, (e || {}));
            _this.onSearch(e);
        }));
        dt.searchValueChange.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (e && e.value) {
                self._searchState = tslib_1.__assign({}, e);
            }
            else {
                self._searchState = null;
            }
        }));
        // 双击事件
        dt.rowDblClick.subscribe((/**
         * @param {?} rowData
         * @return {?}
         */
        function (rowData) {
            if (self.gridOptions.singleSelect) {
                // this.lookupSelectionSer.updateSelections([rowData]);
                self.selectItem(rowData);
            }
        }));
        // 收藏事件
        if (!dt.cellClick.observers.length) {
            dt.cellClick.subscribe((/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                if (e.col.field === FAVORITE_FIELD_NAME) {
                    /** @type {?} */
                    var classList = e.event.target['classList'];
                    if (classList.contains('f-lookup-favorite')) {
                        e.event.stopPropagation();
                        self.items.forEach((/**
                         * @param {?} item
                         * @return {?}
                         */
                        function (item) {
                            /** @type {?} */
                            var id = self.utils.getValue(self.idField, item);
                            if (id === self.utils.getValue(self.idField, e.row)) {
                                item[FAVORITE_FIELD_NAME] = !item[FAVORITE_FIELD_NAME];
                            }
                        }));
                        dt.loadData({
                            pageSize: self.gridOptions.pageSize,
                            pageIndex: self.gridOptions.pageIndex,
                            total: self.gridOptions.total,
                            data: self.gridOptions.items
                        });
                        // 更新收藏数据
                        /** @type {?} */
                        var faction = e.row[FAVORITE_FIELD_NAME] ? FavoriteAction.add : FavoriteAction.delete;
                        if (faction === FavoriteAction.add) {
                            _this.ins.favoriteItems = tslib_1.__spread(_this.ins.favoriteItems, [e.row]);
                        }
                        else {
                            _this.ins.favoriteItems = _this.ins.favoriteItems.filter((/**
                             * @param {?} n
                             * @return {?}
                             */
                            function (n) {
                                return self.utils.getValue(self.idField, n) !== self.utils.getValue(self.idField, e.row);
                            }));
                        }
                        _this.lookupSelectionSer.updateFavoriteData(e.row, faction);
                    }
                }
            }));
        }
        dt.columnSorted.subscribe((/**
         * @param {?} sort
         * @return {?}
         */
        function (sort) {
            _this._sortState = sort;
            if (!_this.ins.remoteSort) {
                return;
            }
            var _a = tslib_1.__assign({}, sort), sortName = _a.sortName, sortOrder = _a.sortOrder;
            /** @type {?} */
            var col = _this.ins.columns.find((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n.field === sortName; }));
            /** @type {?} */
            var _sortName = col ? col.fieldPath ? col.fieldPath : col.field : sortName;
            /** @type {?} */
            var param = {
                sortName: _sortName,
                sortOrder: sortOrder,
                search: self._searchState,
                pageInfo: {
                    pageSize: self.pageSize,
                    pageIndex: 1
                }
            };
            self.httpMgr.getData(param, 'search').subscribe((/**
             * @param {?} d
             * @return {?}
             */
            function (d) {
                self.loadDataTableData(d);
                self.closeLoading();
                // 选中数据 TFS 615008
                _this.ins.selectionMgr.selectCurrentValue();
            }));
        }));
        dt.clearSearchValue.subscribe((/**
         * @return {?}
         */
        function () {
            self._searchState = null;
            _this.onSearch();
        }));
        dt.cellStyler = (/**
         * @param {?} val
         * @return {?}
         */
        function (val) {
            var field = val.field;
            if (field === FAVORITE_FIELD_NAME) {
                return {
                    'text-overflow': 'unset'
                };
            }
            return null;
        });
    };
    return DataTableEventManager;
}());
export { DataTableEventManager };
if (false) {
    /**
     * @type {?}
     * @private
     */
    DataTableEventManager.prototype.lookupSelectionSer;
    /**
     * @type {?}
     * @private
     */
    DataTableEventManager.prototype._sortState;
    /**
     * @type {?}
     * @private
     */
    DataTableEventManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZC1kYXRhdGFibGUtZXZlbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9iaW5kLWRhdGF0YWJsZS1ldmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDMUIsT0FBTyxFQUFFLFVBQVUsRUFBUSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN2RCxPQUFPLEVBQUUsY0FBYyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFLNUU7SUFNSSwrQkFBb0IsR0FBd0I7UUFBeEIsUUFBRyxHQUFILEdBQUcsQ0FBcUI7UUFGcEMsZUFBVSxHQUFHLElBQUksQ0FBQztRQUd0QixJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQztJQUMxRCxDQUFDOzs7OztJQUVELGdEQUFnQjs7OztJQUFoQixVQUFpQixVQUFVO1FBQ3ZCLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUNqQyxJQUFJLFVBQVUsSUFBSSxVQUFVLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLEdBQUcsRUFBRTtZQUNwRSxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7WUFDekIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1NBQzdEO2FBQU07WUFDSCxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7U0FDbkI7SUFDTCxDQUFDOzs7OztJQUVELHdDQUFROzs7O0lBQVIsVUFBUyxNQUFvRTtRQUE3RSxpQkFzREM7UUF0RFEs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bnQiOlsiaW1wb3J0IHsgRGF0YVRhYmxlQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1kYXRhdGFibGUnO1xyXG5pbXBvcnQgeyBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBjYXRjaEVycm9yLCB0YWtlLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEZhdm9yaXRlQWN0aW9uLCBGQVZPUklURV9GSUVMRF9OQU1FIH0gZnJvbSAnLi4vbG9va3VwLWRpc3BsYXl0eXBlJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZFJlc3VsdCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLW9wdGlvbnMnO1xyXG5pbXBvcnQgeyBMb29rdXBHcmlkQ29tcG9uZW50IH0gZnJvbSAnLi4vbG9va3VwLWdyaWQuY29tcG9uZW50JztcclxuaW1wb3J0IHsgTG9va3VwU2VsZWN0aW9uU2VydmljZSB9IGZyb20gJy4vbG9va3VwLXNlbGVjdGlvbi5zZXJ2aWNlJztcclxuXHJcbmV4cG9ydCBjbGFzcyBEYXRhVGFibGVFdmVudE1hbmFnZXIge1xyXG5cclxuICAgIHByaXZhdGUgbG9va3VwU2VsZWN0aW9uU2VyOiBMb29rdXBTZWxlY3Rpb25TZXJ2aWNlO1xyXG5cclxuICAgIHByaXZhdGUgX3NvcnRTdGF0ZSA9IG51bGw7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbnM6IExvb2t1cEdyaWRDb21wb25lbnQpIHtcclxuICAgICAgICB0aGlzLmxvb2t1cFNlbGVjdGlvblNlciA9IHRoaXMuaW5zLmxvb2t1cFNlbGVjdGlvblNlcjtcclxuICAgIH1cclxuXHJcbiAgICBjb25kaXRpb25zQ2hhbmdlKGNvbmRpdGlvbnMpIHtcclxuICAgICAgICB0aGlzLmlucy5jb25kaXRpb25zID0gY29uZGl0aW9ucztcclxuICAgICAgICBpZiAoY29uZGl0aW9ucyAmJiBjb25kaXRpb25zLmxlbmd0aCA9PT0gMSAmJiBjb25kaXRpb25zWzBdLmNvZGUgPT0gJyonKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmNvbmRpdGlvbnMgPSBbXTtcclxuICAgICAgICAgICAgdGhpcy5vblNlYXJjaCh7IGZpZWxkOiAnKicsIHZhbHVlOiBjb25kaXRpb25zWzBdLnZhbHVlIH0pOyAgICBcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLm9uU2VhcmNoKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG9uU2VhcmNoKCRldmVudDogeyBmaWVsZDogc3RyaW5nOyB2YWx1ZTogc3RyaW5nIH0gPSB7IGZpZWxkOiAnKicsIHZhbHVlOiAnJyB9KSB7XHJcbiAgICAgICAgaWYgKCRldmVudCAmJiAkZXZlbnQuZmllbGQgIT09ICcqJyAmJiAhJGV2ZW50LnZhbHVlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLm1lc3NhZ2VyU2VydmljZS53YXJuaW5nKHRoaXMuaW5zLm11c3RXcml0ZVNvbWV0aGluZyk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHAgPSB7XHJcbiAgICAgICAgICAgIHBhZ2VJbmZvOiB7IHBhZ2VJbmRleDogMSwgcGFnZVNpemU6IHRoaXMuaW5zLmdyaWRPcHRpb25zLnBhZ2VTaXplIH0sXHJcbiAgICAgICAgICAgIHNlYXJjaDogJGV2ZW50XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuX3NvcnRTdGF0ZSkge1xyXG4gICAgICAgICAgICBjb25zdCB7c29ydE5hbWUsIHNvcnRPcmRlcn0gPSB0aGlzLl9zb3J0U3RhdGU7XHJcbiAgICAgICAgICAgIGlmIChzb3J0TmFtZSkge1xyXG4gICAgICAgICAgICAgICAgcFsnc29ydE5hbWUnXSA9IHNvcnROYW1lO1xyXG4gICAgICAgICAgICAgICAgcFsnc29ydE9yZGVyJ10gPSBzb3J0T3JkZXI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy51cmkpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmlucy5zZWFyY2hpbmcpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNlYXJjaGluZyA9IHRydWU7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zWyduYXZOb2RlUGF0aENvZGUnXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBbJ25hdk5vZGVQYXRoQ29kZSddID0gdGhpcy5pbnNbJ25hdk5vZGVQYXRoQ29kZSddO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLmh0dHBNZ3IuZ2V0RGF0YShwLCAnbGlzdCcpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgY2F0Y2hFcnJvcihlcnIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5zZWFyY2hpbmcgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKHsgXCJfRVJST1JfXCI6IGVyciB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5zZWFyY2hpbmcgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgKS5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNlYXJjaGluZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5jbG9zZUxvYWRpbmcoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkYXRhWydfRVJST1JfJ10pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvYWREYXRhKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGRhdGFbJ19FUlJPUl8nXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmVuYWJsZU11bHRpRmllbGRTZWFyY2gpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLnF1ZXJ5LmVtaXQoeyBjb25kaXRpb25zOiB0aGlzLmlucy5jb25kaXRpb25zLCBpbnN0YW5jZTogdGhpcy5pbnMgfSlcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNlYXJjaC5lbWl0KHApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2xvYWREYXRhKGRhdGE6IExvb2t1cEdyaWRSZXN1bHQpIHtcclxuICAgICAgICBjb25zdCBzZWxmID0gdGhpcy5pbnM7XHJcbiAgICAgICAgc2VsZi5jbG9zZUxvYWRpbmcoKTtcclxuICAgICAgICBzZWxmLmZhdkhlbHBlci51cGRhdGVGYXZvcml0ZXNTdGF0dXMoZGF0YS5pdGVtcyk7XHJcbiAgICAgICAgc2VsZi5sb2FkRGF0YVRhYmxlRGF0YShkYXRhKTtcclxuICAgICAgICAvLyDpgInkuK3mlbDmja5cclxuICAgICAgICB0aGlzLmlucy5zZWxlY3Rpb25NZ3Iuc2VsZWN0Q3VycmVudFZhbHVlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgYmluZERhdGFUYWJsZUV2ZW50KCkge1xyXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzLmlucztcclxuICAgICAgICBjb25zdCBkdCA9IHNlbGYuY29tcG9uZW50UmVmLmluc3RhbmNlIGFzIERhdGFUYWJsZUNvbXBvbmVudDtcclxuXHJcbiAgICAgXHJcbiAgICAgICAgZHQuc2VsZWN0ZWRSb3cuc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLnNpbmdsZVNlbGVjdCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIuY2xlYXJTZWxlY3Rpb25zKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5pbnMuY2hlY2tlZENoYW5nZS5lbWl0KHsgZGF0YTogW2UuZGF0YV0sIGlzQ2hlY2s6IHRydWUgfSk7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwU2VsZWN0aW9uU2VyLnVwZGF0ZVNlbGVjdGlvbnMoW2UuZGF0YV0pO1xyXG4gICAgICAgICAgICBkdC5jZC5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICBcclxuXHJcbiAgICAgICAgZHQudW5TZWxlY3RSb3cuc3Vic2NyaWJlKGUgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmxvb2t1cFNlbGVjdGlvblNlci51blNlbGVjdChlLmRhdGFbc2VsZi5pZEZpZWxkXSk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmNoZWNrZWRDaGFuZ2UuZW1pdCh7IGRhdGE6IFtlLmRhdGFdLCBpc0NoZWNrOiBmYWxzZSB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZHQuY2hlY2tBbGwuc3Vic2NyaWJlKChlOiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwU2VsZWN0aW9uU2VyLnVwZGF0ZVNlbGVjdGlvbnMoZHQuZGF0YSwgZSk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmNoZWNrZWRDaGFuZ2UuZW1pdCh7IGRhdGE6IGR0LmRhdGEsIGlzQ2hlY2s6IGUgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGR0LnBhZ2VDaGFuZ2VkLnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChzZWxmLnVyaSkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5odHRwTWdyLmdldERhdGEoZSwgJ2xpc3QnKS5zdWJzY3JpYmUoKGRhdGE6IExvb2t1cEdyaWRSZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2FkRGF0YShkYXRhKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5wYWdlckNoYW5nZWQuZW1pdChzZWxmLmh0dHBNZ3IuYnVpbGRRdWVyeVBhcmFtcyhlLCAnbGlzdCcpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkdC5wYWdlU2l6ZUNoYW5nZWQuc3Vic2NyaWJlKGUgPT4ge1xyXG4gICAgICAgICAgICBpZiAoc2VsZi51cmkpIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuaHR0cE1nci5nZXREYXRhKGUsICdsaXN0Jykuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2FkRGF0YShkYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNlbGYucGFnZXJDaGFuZ2VkLmVtaXQoc2VsZi5odHRwTWdyLmJ1aWxkUXVlcnlQYXJhbXMoZSwgJ2xpc3QnKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZHQuc2VhcmNoLnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIC8vIGlmIChKU09OLnN0cmluZ2lmeShzZWxmLl9zZWFyY2hTdGF0ZSB8fCB7fSkgIT09IEpTT04uc3RyaW5naWZ5KGUgfHwge30pKSB7XHJcbiAgICAgICAgICAgIC8vICAgICB0aGlzLmlucy5zZWFyY2hpbmcgPSBmYWxzZTtcclxuICAgICAgICAgICAgLy8gfVxyXG4gICAgICAgICAgICBzZWxmLl9zZWFyY2hTdGF0ZSA9IHsuLi4oZSB8fCB7fSl9O1xyXG4gICAgICAgICAgICB0aGlzLm9uU2VhcmNoKGUpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkdC5zZWFyY2hWYWx1ZUNoYW5nZS5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZSAmJiBlLnZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLl9zZWFyY2hTdGF0ZSA9IHsuLi5lfTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuX3NlYXJjaFN0YXRlID0gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyDlj4zlh7vkuovku7ZcclxuICAgICAgICBkdC5yb3dEYmxDbGljay5zdWJzY3JpYmUoKHJvd0RhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoc2VsZi5ncmlkT3B0aW9ucy5zaW5nbGVTZWxlY3QpIHtcclxuICAgICAgICAgICAgICAgIC8vIHRoaXMubG9va3VwU2VsZWN0aW9uU2VyLnVwZGF0ZVNlbGVjdGlvbnMoW3Jvd0RhdGFdKTtcclxuICAgICAgICAgICAgICAgIHNlbGYuc2VsZWN0SXRlbShyb3dEYXRhKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyDmlLbol4/kuovku7ZcclxuICAgICAgICBpZighZHQuY2VsbENsaWNrLm9ic2VydmVycy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgZHQuY2VsbENsaWNrLnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZS5jb2wuZmllbGQgPT09IEZBVk9SSVRFX0ZJRUxEX05BTUUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjbGFzc0xpc3QgPSBlLmV2ZW50LnRhcmdldFsnY2xhc3NMaXN0J107XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNsYXNzTGlzdC5jb250YWlucygnZi1sb29rdXAtZmF2b3JpdGUnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlLmV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmLml0ZW1zLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpZCA9IHNlbGYudXRpbHMuZ2V0VmFsdWUoc2VsZi5pZEZpZWxkLCBpdGVtKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpZCA9PT0gc2VsZi51dGlscy5nZXRWYWx1ZShzZWxmLmlkRmllbGQsIGUucm93KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1bRkFWT1JJVEVfRklFTERfTkFNRV0gPSAhaXRlbVtGQVZPUklURV9GSUVMRF9OQU1FXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGR0LmxvYWREYXRhKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VTaXplOiBzZWxmLmdyaWRPcHRpb25zLnBhZ2VTaXplLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUluZGV4OiBzZWxmLmdyaWRPcHRpb25zLnBhZ2VJbmRleCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsOiBzZWxmLmdyaWRPcHRpb25zLnRvdGFsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogc2VsZi5ncmlkT3B0aW9ucy5pdGVtc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOabtOaWsOaUtuiXj+aVsOaNrlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmYWN0aW9uID0gZS5yb3dbRkFWT1JJVEVfRklFTERfTkFNRV0gPyBGYXZvcml0ZUFjdGlvbi5hZGQgOiBGYXZvcml0ZUFjdGlvbi5kZWxldGU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmFjdGlvbiA9PT0gIEZhdm9yaXRlQWN0aW9uLmFkZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuZmF2b3JpdGVJdGVtcyA9IFsuLi50aGlzLmlucy5mYXZvcml0ZUl0ZW1zLCBlLnJvd107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5mYXZvcml0ZUl0ZW1zID0gdGhpcy5pbnMuZmF2b3JpdGVJdGVtcy5maWx0ZXIobiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYudXRpbHMuZ2V0VmFsdWUoc2VsZi5pZEZpZWxkLCBuKSAhPT0gc2VsZi51dGlscy5nZXRWYWx1ZShzZWxmLmlkRmllbGQsIGUucm93KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvb2t1cFNlbGVjdGlvblNlci51cGRhdGVGYXZvcml0ZURhdGEoZS5yb3csIGZhY3Rpb24pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBkdC5jb2x1bW5Tb3J0ZWQuc3Vic2NyaWJlKChzb3J0OiB7IHNvcnROYW1lOiBzdHJpbmc7IHNvcnRPcmRlcjogYW55IH0pID0+IHtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuX3NvcnRTdGF0ZSA9IHNvcnQ7XHJcblxyXG4gICAgICAgICAgICBpZiAoIXRoaXMuaW5zLnJlbW90ZVNvcnQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgeyBzb3J0TmFtZSwgc29ydE9yZGVyIH0gPSB7IC4uLnNvcnQgfTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGNvbCA9IHRoaXMuaW5zLmNvbHVtbnMuZmluZChuID0+IG4uZmllbGQgPT09IHNvcnROYW1lKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IF9zb3J0TmFtZSA9IGNvbCA/IGNvbC5maWVsZFBhdGggPyBjb2wuZmllbGRQYXRoIDogY29sLmZpZWxkIDogc29ydE5hbWU7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBwYXJhbSA9IHtcclxuICAgICAgICAgICAgICAgIHNvcnROYW1lOiBfc29ydE5hbWUsXHJcbiAgICAgICAgICAgICAgICBzb3J0T3JkZXIsXHJcbiAgICAgICAgICAgICAgICBzZWFyY2g6IHNlbGYuX3NlYXJjaFN0YXRlLFxyXG4gICAgICAgICAgICAgICAgcGFnZUluZm86IHtcclxuICAgICAgICAgICAgICAgICAgICBwYWdlU2l6ZTogc2VsZi5wYWdlU2l6ZSxcclxuICAgICAgICAgICAgICAgICAgICBwYWdlSW5kZXg6IDFcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHNlbGYuaHR0cE1nci5nZXREYXRhKHBhcmFtLCAnc2VhcmNoJykuc3Vic2NyaWJlKGQgPT4ge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5sb2FkRGF0YVRhYmxlRGF0YShkKTtcclxuICAgICAgICAgICAgICAgIHNlbGYuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAvLyDpgInkuK3mlbDmja4gVEZTIDYxNTAwOFxyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMuc2VsZWN0aW9uTWdyLnNlbGVjdEN1cnJlbnRWYWx1ZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZHQuY2xlYXJTZWFyY2hWYWx1ZS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICBzZWxmLl9zZWFyY2hTdGF0ZSA9IG51bGw7XHJcbiAgICAgICAgICAgIHRoaXMub25TZWFyY2goKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZHQuY2VsbFN0eWxlciA9ICh2YWw6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB7IGZpZWxkIH0gPSB2YWw7XHJcbiAgICAgICAgICAgIGlmIChmaWVsZCA9PT0gRkFWT1JJVEVfRklFTERfTkFNRSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAndGV4dC1vdmVyZmxvdyc6ICd1bnNldCdcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuIl19