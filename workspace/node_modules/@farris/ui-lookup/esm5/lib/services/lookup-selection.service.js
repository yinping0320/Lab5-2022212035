/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { of, BehaviorSubject, Subject } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { FavoriteAction } from '../lookup-displaytype';
/**
 * @record
 */
export function SelectionState() { }
if (false) {
    /** @type {?} */
    SelectionState.prototype.selecteditems;
    /** @type {?} */
    SelectionState.prototype.favoriteItems;
    /** @type {?} */
    SelectionState.prototype.quickItems;
}
var LookupSelectionService = /** @class */ (function () {
    function LookupSelectionService(ins) {
        this.ins = ins;
        this.state = {
            selecteditems: [],
            favoriteItems: [],
            quickItems: []
        };
        this.state$ = new BehaviorSubject(this.state);
        this.selected$ = this.state$.pipe(switchMap((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return of(n.selecteditems); })));
        this.favoriteItems$ = new BehaviorSubject({ items: this.state.favoriteItems, action: null });
        this.quickItems$ = this.state$.pipe(switchMap((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return of(n.quickItems); })));
        this.selectionChanged$ = new Subject();
    }
    Object.defineProperty(LookupSelectionService.prototype, "idField", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            return this.ins.idField;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @param {?} items
     * @return {?}
     */
    LookupSelectionService.prototype.initFavoriteItems = /**
     * @param {?} items
     * @return {?}
     */
    function (items) {
        this.state.favoriteItems = items || [];
    };
    //#region 收藏数据
    //#region 收藏数据
    /**
     * @param {?} data
     * @param {?} action
     * @return {?}
     */
    LookupSelectionService.prototype.updateFavoriteData = 
    //#region 收藏数据
    /**
     * @param {?} data
     * @param {?} action
     * @return {?}
     */
    function (data, action) {
        var _this = this;
        if (this.ins.savingFaoriteData) {
            return;
        }
        if (action === FavoriteAction.add) {
            this.state.favoriteItems = this.state.favoriteItems.concat([data]);
        }
        else {
            this.state.favoriteItems = this.state.favoriteItems.filter((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n[_this.idField] !== data[_this.idField]; }));
        }
        this.favoriteItems$.next({ items: this.state.favoriteItems, action: action, data: data });
    };
    //#endregion
    //#region 多选数据
    //#endregion
    //#region 多选数据
    /**
     * @param {?} data
     * @return {?}
     */
    LookupSelectionService.prototype.loadSelections = 
    //#endregion
    //#region 多选数据
    /**
     * @param {?} data
     * @return {?}
     */
    function (data) {
        this.state.selecteditems = tslib_1.__spread(data);
        this.state$.next(this.state);
    };
    /**
     * @return {?}
     */
    LookupSelectionService.prototype.getSelections = /**
     * @return {?}
     */
    function () {
        return tslib_1.__spread(this.state.selecteditems);
    };
    /**
     * @param {?} item
     * @return {?}
     */
    LookupSelectionService.prototype.select = /**
     * @param {?} item
     * @return {?}
     */
    function (item) {
        if (item) {
            this.state.selecteditems = tslib_1.__spread(this.state.selecteditems, [item]);
            this.state$.next(this.state);
            this.selectionChanged$.next({ data: [item[this.idField]], selected: true });
        }
    };
    /**
     * @param {?} pathcode
     * @return {?}
     */
    LookupSelectionService.prototype.unselectByPathcode = /**
     * @param {?} pathcode
     * @return {?}
     */
    function (pathcode) {
        var _this = this;
        /** @type {?} */
        var ids = [];
        this.state.selecteditems = this.state.selecteditems.filter((/**
         * @param {?} n
         * @return {?}
         */
        function (n) {
            /** @type {?} */
            var _pathcode = _this.ins.getPathCode(n, _this.ins.treeInfo);
            /** @type {?} */
            var r = _pathcode && _pathcode.indexOf(pathcode) !== 0;
            if (!r) {
                ids.push(n[_this.idField]);
            }
            return r;
        }));
        this.selectionChanged$.next({ data: ids, selected: false });
    };
    /**
     * @param {?} data
     * @param {?=} checked
     * @return {?}
     */
    LookupSelectionService.prototype.updateSelections = /**
     * @param {?} data
     * @param {?=} checked
     * @return {?}
     */
    function (data, checked) {
        var _this = this;
        if (checked === void 0) { checked = true; }
        if (!Array.isArray(data)) {
            data = [data];
        }
        /** @type {?} */
        var items = tslib_1.__spread(data);
        /** @type {?} */
        var idField = this.idField;
        /** @type {?} */
        var ids = items.map((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return n[idField]; }));
        if (checked) {
            if (this.state.selecteditems && !this.state.selecteditems.length) {
                this.state.selecteditems = items;
            }
            else {
                ids.forEach((/**
                 * @param {?} n
                 * @param {?} i
                 * @return {?}
                 */
                function (n, i) {
                    if (!_this.state.selecteditems.find((/**
                     * @param {?} r
                     * @return {?}
                     */
                    function (r) { return r[idField] == n; }))) {
                        _this.state.selecteditems.push(items[i]);
                    }
                }));
            }
        }
        else {
            if (data) {
                this.state.selecteditems = this.state.selecteditems.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) {
                    return ids.indexOf(n[idField]) === -1;
                }));
            }
        }
        this.state$.next(this.state);
        this.selectionChanged$.next({ data: ids, selected: checked });
    };
    /**
     * @param {?} id
     * @return {?}
     */
    LookupSelectionService.prototype.unSelect = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        var _this = this;
        if (id) {
            if (Array.isArray(id)) {
                this.state.selecteditems = this.state.selecteditems.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) {
                    return id.indexOf(n[_this.idField]) === -1;
                }));
                this.selectionChanged$.next({ data: id, selected: false });
            }
            else {
                this.state.selecteditems = this.state.selecteditems.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return n[_this.idField] != id; }));
                this.selectionChanged$.next({ data: [id], selected: false });
            }
            this.state$.next(this.state);
        }
    };
    /**
     * @return {?}
     */
    LookupSelectionService.prototype.clearSelections = /**
     * @return {?}
     */
    function () {
        this.state.selecteditems = [];
        this.state$.next(this.state);
    };
    return LookupSelectionService;
}());
export { LookupSelectionService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    LookupSelectionService.prototype.state;
    /** @type {?} */
    LookupSelectionService.prototype.state$;
    /** @type {?} */
    LookupSelectionService.prototype.selected$;
    /** @type {?} */
    LookupSelectionService.prototype.favoriteItems$;
    /** @type {?} */
    LookupSelectionService.prototype.quickItems$;
    /** @type {?} */
    LookupSelectionService.prototype.selectionChanged$;
    /**
     * @type {?}
     * @private
     */
    LookupSelectionService.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9va3VwLXNlbGVjdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvbG9va3VwLXNlbGVjdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFjLEVBQUUsRUFBRSxlQUFlLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7Ozs7QUFHdkQsb0NBSUM7OztJQUhHLHVDQUFxQjs7SUFDckIsdUNBQXFCOztJQUNyQixvQ0FBa0I7O0FBR3RCO0lBMEJJLGdDQUFvQixHQUF3QjtRQUF4QixRQUFHLEdBQUgsR0FBRyxDQUFxQjtRQXhCcEMsVUFBSyxHQUFtQjtZQUM1QixhQUFhLEVBQUUsRUFBRTtZQUNqQixhQUFhLEVBQUUsRUFBRTtZQUNqQixVQUFVLEVBQUUsRUFBRTtTQUNqQixDQUFDO1FBRUYsV0FBTSxHQUFvQyxJQUFJLGVBQWUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFMUUsY0FBUyxHQUFzQixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDM0MsU0FBUzs7OztRQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsRUFBRSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsRUFBbkIsQ0FBbUIsRUFBQyxDQUN0QyxDQUFDO1FBRUYsbUJBQWMsR0FBeUIsSUFBSSxlQUFlLENBQUMsRUFBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFFN0csZ0JBQVcsR0FBc0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQzdDLFNBQVM7Ozs7UUFBQyxVQUFBLENBQUMsSUFBSSxP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RSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO2FBQzlEO2lCQUFNO2dCQUNILElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLE1BQU07Ozs7Z0JBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsS0FBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBckIsQ0FBcUIsRUFBQyxDQUFDO2dCQUN2RixJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7YUFDaEU7WUFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDaEM7SUFDTCxDQUFDOzs7O0lBRUQsZ0RBQWU7OztJQUFmO1FBQ0ksSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBSUwsNkJBQUM7QUFBRCxDQUFDLEFBOUlELElBOElDOzs7Ozs7O0lBNUlHLHVDQUlFOztJQUVGLHdDQUEwRTs7SUFFMUUsMkNBRUU7O0lBRUYsZ0RBQTZHOztJQUU3Ryw2Q0FFRTs7SUFFRixtREFBa0M7Ozs7O0lBTXRCLHFDQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBCZWhhdmlvclN1YmplY3QsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBGYXZvcml0ZUFjdGlvbiB9IGZyb20gJy4uL2xvb2t1cC1kaXNwbGF5dHlwZSc7XHJcbmltcG9ydCB7IExvb2t1cEdyaWRDb21wb25lbnQgfSBmcm9tICcuLi9sb29rdXAtZ3JpZC5jb21wb25lbnQnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBTZWxlY3Rpb25TdGF0ZSB7XHJcbiAgICBzZWxlY3RlZGl0ZW1zOiBhbnlbXTtcclxuICAgIGZhdm9yaXRlSXRlbXM6IGFueVtdO1xyXG4gICAgcXVpY2tJdGVtczogYW55W107XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBMb29rdXBTZWxlY3Rpb25TZXJ2aWNlIHtcclxuXHJcbiAgICBwcml2YXRlIHN0YXRlOiBTZWxlY3Rpb25TdGF0ZSA9IHtcclxuICAgICAgICBzZWxlY3RlZGl0ZW1zOiBbXSxcclxuICAgICAgICBmYXZvcml0ZUl0ZW1zOiBbXSxcclxuICAgICAgICBxdWlja0l0ZW1zOiBbXVxyXG4gICAgfTtcclxuXHJcbiAgICBzdGF0ZSQ6IEJlaGF2aW9yU3ViamVjdDxTZWxlY3Rpb25TdGF0ZT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KHRoaXMuc3RhdGUpO1xyXG5cclxuICAgIHNlbGVjdGVkJDogT2JzZXJ2YWJsZTxhbnlbXT4gPSB0aGlzLnN0YXRlJC5waXBlKFxyXG4gICAgICAgIHN3aXRjaE1hcChuID0+IG9mKG4uc2VsZWN0ZWRpdGVtcykpXHJcbiAgICApO1xyXG5cclxuICAgIGZhdm9yaXRlSXRlbXMkOiBCZWhhdmlvclN1YmplY3Q8YW55PiA9IG5ldyBCZWhhdmlvclN1YmplY3Qoe2l0ZW1zOiB0aGlzLnN0YXRlLmZhdm9yaXRlSXRlbXMsIGFjdGlvbjogbnVsbCB9KTtcclxuXHJcbiAgICBxdWlja0l0ZW1zJDogT2JzZXJ2YWJsZTxhbnlbXT4gPSB0aGlzLnN0YXRlJC5waXBlKFxyXG4gICAgICAgIHN3aXRjaE1hcChuID0+IG9mKG4ucXVpY2tJdGVtcykpXHJcbiAgICApO1xyXG5cclxuICAgIHNlbGVjdGlvbkNoYW5nZWQkID0gbmV3IFN1YmplY3QoKTtcclxuXHJcbiAgICBwcml2YXRlIGdldCBpZEZpZWxkKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmlucy5pZEZpZWxkO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5zOiBMb29rdXBHcmlkQ29tcG9uZW50KSB7XHJcbiAgICB9XHJcblxyXG4gICAgaW5pdEZhdm9yaXRlSXRlbXMoaXRlbXM6IGFueVtdKSB7XHJcbiAgICAgICAgdGhpcy5zdGF0ZS5mYXZvcml0ZUl0ZW1zID0gaXRlbXMgfHwgW107XHJcbiAgICB9XHJcblxyXG5cclxuICAgIC8vI3JlZ2lvbiDmlLbol4/mlbDmja5cclxuXHJcbiAgICB1cGRhdGVGYXZvcml0ZURhdGEoZGF0YTogYW55LCBhY3Rpb246IEZhdm9yaXRlQWN0aW9uKSB7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5zYXZpbmdGYW9yaXRlRGF0YSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoYWN0aW9uID09PSBGYXZvcml0ZUFjdGlvbi5hZGQpIHtcclxuICAgICAgICAgICAgdGhpcy5zdGF0ZS5mYXZvcml0ZUl0ZW1zID0gdGhpcy5zdGF0ZS5mYXZvcml0ZUl0ZW1zLmNvbmNhdChbZGF0YV0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3RhdGUuZmF2b3JpdGVJdGVtcyA9IHRoaXMuc3RhdGUuZmF2b3JpdGVJdGVtcy5maWx0ZXIobiA9PiBuW3RoaXMuaWRGaWVsZF0gIT09IGRhdGFbdGhpcy5pZEZpZWxkXSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmZhdm9yaXRlSXRlbXMkLm5leHQoeyBpdGVtczogdGhpcy5zdGF0ZS5mYXZvcml0ZUl0ZW1zLCBhY3Rpb24sIGRhdGEgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8jZW5kcmVnaW9uXHJcblxyXG4gICAgLy8jcmVnaW9uIOWkmumAieaVsOaNrlxyXG5cclxuICAgIGxvYWRTZWxlY3Rpb25zKCBkYXRhOiBbXSkge1xyXG4gICAgICAgIHRoaXMuc3RhdGUuc2VsZWN0ZWRpdGVtcyA9IFsuLi5kYXRhXTtcclxuICAgICAgICB0aGlzLnN0YXRlJC5uZXh0KHRoaXMuc3RhdGUpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFNlbGVjdGlvbnMoKSB7XHJcbiAgICAgICAgcmV0dXJuIFsuLi50aGlzLnN0YXRlLnNlbGVjdGVkaXRlbXNdO1xyXG4gICAgfVxyXG5cclxuICAgIHNlbGVjdChpdGVtOiBhbnkpIHtcclxuICAgICAgICBpZiAoaXRlbSkge1xyXG4gICAgICAgICAgICB0aGlzLnN0YXRlLnNlbGVjdGVkaXRlbXMgPSBbLi4udGhpcy5zdGF0ZS5zZWxlY3RlZGl0ZW1zLCBpdGVtXTtcclxuICAgICAgICAgICAgdGhpcy5zdGF0ZSQubmV4dCh0aGlzLnN0YXRlKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uQ2hhbmdlZCQubmV4dCh7IGRhdGE6IFtpdGVtW3RoaXMuaWRGaWVsZF1dLCBzZWxlY3RlZDogdHJ1ZSB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdW5zZWxlY3RCeVBhdGhjb2RlKHBhdGhjb2RlOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBpZHMgPSBbXTtcclxuICAgICAgICB0aGlzLnN0YXRlLnNlbGVjdGVkaXRlbXMgPSB0aGlzLnN0YXRlLnNlbGVjdGVkaXRlbXMuZmlsdGVyKG4gPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBfcGF0aGNvZGUgPSB0aGlzLmlucy5nZXRQYXRoQ29kZShuLCB0aGlzLmlucy50cmVlSW5mbyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHIgPSBfcGF0aGNvZGUgJiYgX3BhdGhjb2RlLmluZGV4T2YocGF0aGNvZGUpICE9PSAwO1xyXG4gICAgICAgICAgICBpZiAoIXIpIHtcclxuICAgICAgICAgICAgICAgIGlkcy5wdXNoKG5bdGhpcy5pZEZpZWxkXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHI7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuc2VsZWN0aW9uQ2hhbmdlZCQubmV4dCh7IGRhdGE6IGlkcywgc2VsZWN0ZWQ6IGZhbHNlIH0pO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVTZWxlY3Rpb25zKGRhdGE6IGFueSwgY2hlY2tlZCA9IHRydWUpIHtcclxuXHJcbiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGRhdGEpKSB7XHJcbiAgICAgICAgICAgIGRhdGEgPSBbZGF0YV07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBpdGVtcyA9IFsgLi4uZGF0YSBdO1xyXG4gICAgICAgIGNvbnN0IGlkRmllbGQgPSB0aGlzLmlkRmllbGQ7XHJcbiAgICAgICAgY29uc3QgaWRzID0gaXRlbXMubWFwKG4gPT4gbltpZEZpZWxkXSk7XHJcbiAgICAgICAgaWYgKGNoZWNrZWQpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUuc2VsZWN0ZWRpdGVtcyAmJiAhdGhpcy5zdGF0ZS5zZWxlY3RlZGl0ZW1zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5zZWxlY3RlZGl0ZW1zID0gaXRlbXM7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZHMuZm9yRWFjaCgobiwgaSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5zdGF0ZS5zZWxlY3RlZGl0ZW1zLmZpbmQociA9PiByW2lkRmllbGRdID09IG4pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUuc2VsZWN0ZWRpdGVtcy5wdXNoKGl0ZW1zW2ldKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnNlbGVjdGVkaXRlbXMgPSB0aGlzLnN0YXRlLnNlbGVjdGVkaXRlbXMuZmlsdGVyKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpZHMuaW5kZXhPZihuW2lkRmllbGRdKSA9PT0gLTE7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5zdGF0ZSQubmV4dCh0aGlzLnN0YXRlKTtcclxuICAgICAgICB0aGlzLnNlbGVjdGlvbkNoYW5nZWQkLm5leHQoeyBkYXRhOiBpZHMsIHNlbGVjdGVkOiBjaGVja2VkIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHVuU2VsZWN0KGlkOiBhbnkpIHtcclxuICAgICAgICBpZiAoaWQpIHtcclxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaWQpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnNlbGVjdGVkaXRlbXMgPSB0aGlzLnN0YXRlLnNlbGVjdGVkaXRlbXMuZmlsdGVyKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpZC5pbmRleE9mKG5bdGhpcy5pZEZpZWxkXSkgPT09IC0xO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGlvbkNoYW5nZWQkLm5leHQoeyBkYXRhOiBpZCwgc2VsZWN0ZWQ6IGZhbHNlIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5zZWxlY3RlZGl0ZW1zID0gdGhpcy5zdGF0ZS5zZWxlY3RlZGl0ZW1zLmZpbHRlcihuID0+IG5bdGhpcy5pZEZpZWxkXSAhPSBpZCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGlvbkNoYW5nZWQkLm5leHQoeyBkYXRhOiBbaWRdLCBzZWxlY3RlZDogZmFsc2UgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMuc3RhdGUkLm5leHQodGhpcy5zdGF0ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNsZWFyU2VsZWN0aW9ucygpIHtcclxuICAgICAgICB0aGlzLnN0YXRlLnNlbGVjdGVkaXRlbXMgPSBbXTtcclxuICAgICAgICB0aGlzLnN0YXRlJC5uZXh0KHRoaXMuc3RhdGUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vI2VuZHJlZ2lvblxyXG5cclxufVxyXG4iXX0=