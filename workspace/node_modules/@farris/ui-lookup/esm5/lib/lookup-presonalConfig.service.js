/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { IdService } from '@farris/ui-common';
import { Subject } from 'rxjs';
var PersonalConfigService = /** @class */ (function () {
    function PersonalConfigService(idService) {
        this.idService = idService;
        this.selectItemObser$ = new Subject();
        this.displayType = 'LIST';
        this.singleSelect = true;
        // 个性化配置KEY
        this._key = '';
        this._newKey = '';
        // 组件ID
        this.controlID = '';
    }
    Object.defineProperty(PersonalConfigService.prototype, "personalConfigKey", {
        get: /**
         * @return {?}
         */
        function () {
            return this._key;
        },
        set: /**
         * @param {?} val
         * @return {?}
         */
        function (val) {
            if (val) {
                this._key = this.buildKey(val);
                if (this.controlID) {
                    this._newKey = this.buildKey(this.controlID + '_' + val);
                }
                else {
                    this._newKey = this._key;
                }
            }
            else {
                this._newKey = this.buildKey(this.controlID);
            }
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @private
     * @param {?} str
     * @return {?}
     */
    PersonalConfigService.prototype.buildKey = /**
     * @private
     * @param {?} str
     * @return {?}
     */
    function (str) {
        /** @type {?} */
        var prefix = '';
        if (location.hash) {
            /** @type {?} */
            var pathArr = location.hash.split('?');
            prefix = pathArr ? pathArr[0] : '';
        }
        else {
            /** @type {?} */
            var pathArr = location.pathname.split('/');
            prefix = pathArr ? pathArr[pathArr.length - 1] : '';
        }
        return this.idService.encrypt(prefix + str);
    };
    /**
     * @param {?} obj
     * @return {?}
     */
    PersonalConfigService.prototype.initPersonalConf = /**
     * @param {?} obj
     * @return {?}
     */
    function (obj) {
        Object.assign(this, obj);
    };
    /**
     * @param {?=} key
     * @return {?}
     */
    PersonalConfigService.prototype.getPersonalData = /**
     * @param {?=} key
     * @return {?}
     */
    function (key) {
        if (key) {
            this._key = key;
        }
        if (this.personalConfigKey) {
            /** @type {?} */
            var conf = localStorage.getItem(this.personalConfigKey);
            if (conf && conf !== 'undefined' && conf !== 'null') {
                this.personalConf = conf ? JSON.parse(conf) : {};
                this._updatePersonalConfig(this.personalConf);
                if (this.controlID) {
                    if (this._key !== this._newKey) {
                        localStorage.removeItem(this._key);
                    }
                    this.savePersonalConfig(this.personalConf);
                }
                return this.personalConf;
            }
            else {
                return null;
            }
        }
        return null;
    };
    /**
     * @param {?=} localeId
     * @return {?}
     */
    PersonalConfigService.prototype.getQuickSelected = /**
     * @param {?=} localeId
     * @return {?}
     */
    function (localeId) {
        /** @type {?} */
        var d = this.getPersonalData();
        /** @type {?} */
        var qs = d ? d.quickSelected : null;
        if (localeId) {
            if (qs) {
                /** @type {?} */
                var items = qs[localeId];
                if (items && items.length) {
                    return items;
                }
            }
            return null;
        }
        return qs;
    };
    /**
     * @return {?}
     */
    PersonalConfigService.prototype.getDialogSize = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var d = this.getPersonalData();
        return d ? d.size : null;
    };
    /**
     * @param {?} cfg
     * @return {?}
     */
    PersonalConfigService.prototype.updatePersonalConfig = /**
     * @param {?} cfg
     * @return {?}
     */
    function (cfg) {
        /** @type {?} */
        var data = Object.assign(this.personalConf || {}, cfg);
        this.savePersonalConfig(data);
    };
    /**
     * @param {?} data
     * @return {?}
     */
    PersonalConfigService.prototype.savePersonalConfig = /**
     * @param {?} data
     * @return {?}
     */
    function (data) {
        if (this._newKey) {
            /** @type {?} */
            var _data_1 = (/** @type {?} */ (localStorage.getItem(this._newKey)));
            if (_data_1) {
                _data_1 = (/** @type {?} */ (JSON.parse(_data_1)));
                if (_data_1.favorite) {
                    if (!data.favorite) {
                        data.favorite = _data_1.favorite;
                    }
                    else {
                        Object.keys(_data_1.favorite).forEach((/**
                         * @param {?} lang
                         * @return {?}
                         */
                        function (lang) {
                            data.favorite[lang] = data.favorite[lang] || [];
                            if (_data_1.favorite[lang]) {
                                /** @type {?} */
                                var arr = Array.from(new Set(tslib_1.__spread(data.favorite[lang], _data_1.favorite[lang])));
                                data.favorite[lang] = arr;
                            }
                        }));
                    }
                }
            }
            localStorage.setItem(this._newKey, JSON.stringify(data));
            this.personalConf = data;
            return true;
        }
        return false;
    };
    /**
     * @param {?=} tabName
     * @return {?}
     */
    PersonalConfigService.prototype.getActiveTabIndex = /**
     * @param {?=} tabName
     * @return {?}
     */
    function (tabName) {
        /** @type {?} */
        var d = this.getPersonalData();
        if (!tabName) {
            return d && d.tabIndex ? d.tabIndex : 'datalist';
        }
        return tabName;
    };
    /**
     * @param {?} selectedRow
     * @param {?} localeId
     * @return {?}
     */
    PersonalConfigService.prototype.updateQueckSelected = /**
     * @param {?} selectedRow
     * @param {?} localeId
     * @return {?}
     */
    function (selectedRow, localeId) {
        var _this = this;
        var _a, _b;
        /** @type {?} */
        var quickItems = this.getQuickSelected(localeId);
        if (quickItems && quickItems.length) {
            /** @type {?} */
            var selectedIndex_1 = [];
            quickItems.forEach((/**
             * @param {?} element
             * @param {?} index
             * @return {?}
             */
            function (element, index) {
                if (_this.singleSelect) {
                    if (element && selectedRow && element[_this.idField] === selectedRow[_this.idField]) {
                        selectedIndex_1.push(index);
                    }
                }
                else {
                    if (selectedRow) {
                        selectedRow.forEach((/**
                         * @param {?} item
                         * @return {?}
                         */
                        function (item) {
                            if (element && element[_this.idField] === item[_this.idField]) {
                                selectedIndex_1.push(index);
                            }
                        }));
                    }
                }
            }));
            selectedIndex_1.forEach((/**
             * @param {?} index
             * @return {?}
             */
            function (index) {
                quickItems[index] = null;
            }));
            this.personalConf.quickSelected[localeId] =
                this.personalConf.quickSelected[localeId].filter((/**
                 * @param {?} v
                 * @return {?}
                 */
                function (v) { return v !== null; }));
            if (this.singleSelect) {
                this.personalConf.quickSelected[localeId].unshift(selectedRow);
            }
            else {
                if (selectedRow) {
                    selectedRow.forEach((/**
                     * @param {?} element
                     * @return {?}
                     */
                    function (element) {
                        _this.personalConf.quickSelected[localeId].unshift(element);
                    }));
                }
            }
            this.personalConf.quickSelected[localeId].length =
                this.personalConf.quickSelected[localeId].length > 5 ?
                    5 : this.personalConf.quickSelected[localeId].length;
        }
        else {
            /** @type {?} */
            var _qs = this.personalConf.quickSelected || {};
            /** @type {?} */
            var newData = void 0;
            if (this.singleSelect) {
                newData = Object.assign(_qs, (_a = {}, _a[localeId] = [selectedRow], _a));
            }
            else {
                selectedRow.length = selectedRow.length > 5 ? 5 : selectedRow.length;
                newData = Object.assign(_qs, (_b = {}, _b[localeId] = selectedRow, _b));
            }
            this.personalConf.quickSelected = newData;
        }
        this.savePersonalConfig(this.personalConf);
    };
    /**
     *  更新数据结构，现有个性化数据均转为 中文环境下数据；
     */
    /**
     *  更新数据结构，现有个性化数据均转为 中文环境下数据；
     * @param {?} per
     * @return {?}
     */
    PersonalConfigService.prototype._updatePersonalConfig = /**
     *  更新数据结构，现有个性化数据均转为 中文环境下数据；
     * @param {?} per
     * @return {?}
     */
    function (per) {
        if (per) {
            /** @type {?} */
            var flag = false;
            // 更新收藏数据
            if (per.favorite && Array.isArray(per.favorite)) {
                per.favorite = { 'zh-CHS': tslib_1.__spread(per.favorite) };
                delete per.favorite;
                flag = true;
            }
            // 更新快捷录入数据
            if (per.selected) {
                if (Array.isArray(per.selected)) {
                    per.quickSelected = { 'zh-CHS': tslib_1.__spread(per.selected) };
                }
                delete per.selected;
                flag = true;
            }
            if (flag) {
                this.savePersonalConfig(per);
            }
        }
    };
    PersonalConfigService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    PersonalConfigService.ctorParameters = function () { return [
        { type: IdService }
    ]; };
    return PersonalConfigService;
}());
export { PersonalConfigService };
if (false) {
    /** @type {?} */
    PersonalConfigService.prototype.personalConf;
    /** @type {?} */
    PersonalConfigService.prototype.selectItemObser$;
    /** @type {?} */
    PersonalConfigService.prototype.displayType;
    /** @type {?} */
    PersonalConfigService.prototype.singleSelect;
    /** @type {?} */
    PersonalConfigService.prototype.idField;
    /** @type {?} */
    PersonalConfigService.prototype.textField;
    /** @type {?} */
    PersonalConfigService.prototype.mapFields;
    /**
     * @type {?}
     * @private
     */
    PersonalConfigService.prototype._key;
    /** @type {?} */
    PersonalConfigService.prototype._newKey;
    /** @type {?} */
    PersonalConfigService.prototype.controlID;
    /**
     * @type {?}
     * @private
     */
    PersonalConfigService.prototype.idService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9va3VwLXByZXNvbmFsQ29uZmlnLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9sb29rdXAtcHJlc29uYWxDb25maWcuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFJL0I7SUFvQ0ksK0JBQW9CLFNBQW9CO1FBQXBCLGNBQVMsR0FBVCxTQUFTLENBQVc7UUEvQnhDLHFCQUFnQixHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7UUFFakMsZ0JBQVcsR0FBRyxNQUFNLENBQUM7UUFFckIsaUJBQVksR0FBRyxJQUFJLENBQUM7O1FBTVosU0FBSSxHQUFHLEVBQUUsQ0FBQztRQUNsQixZQUFPLEdBQUcsRUFBRSxDQUFDOztRQWtCYixjQUFTLEdBQUcsRUFBRSxDQUFDO0lBRTRCLENBQUM7SUFuQjVDLHNCQUFJLG9EQUFpQjs7OztRQUFyQjtZQUNJLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztRQUNyQixDQUFDOzs7OztRQUNELFVBQXNCLEdBQUc7WUFDckIsSUFBSSxHQUFHLEVBQUU7Z0JBQ0wsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUMvQixJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7b0JBQ2hCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQztpQkFDNUQ7cUJBQU07b0JBQ0gsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO2lCQUM1QjthQUNKO2lC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LEdBQUcsRUFBRSxRQUFRLG1CQUFNLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO2dCQUMvQyxPQUFPLEdBQUcsQ0FBQyxRQUFRLENBQUM7Z0JBRXBCLElBQUksR0FBRyxJQUFJLENBQUM7YUFDZjtZQUNELFdBQVc7WUFDWCxJQUFJLEdBQUcsQ0FBQyxRQUFRLEVBQUU7Z0JBQ2QsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRTtvQkFDN0IsR0FBRyxDQUFDLGFBQWEsR0FBRyxFQUFFLFFBQVEsbUJBQU0sR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7aUJBQ3ZEO2dCQUNELE9BQU8sR0FBRyxDQUFDLFFBQVEsQ0FBQztnQkFDcEIsSUFBSSxHQUFHLElBQUksQ0FBQzthQUNmO1lBRUQsSUFBSSxJQUFJLEVBQUU7Z0JBQ04sSUFBSSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ2hDO1NBQ0o7SUFDTCxDQUFDOztnQkFqT0osVUFBVTs7OztnQkFMRixTQUFTOztJQXdPbEIsNEJBQUM7Q0FBQSxBQW5PRCxJQW1PQztTQWxPWSxxQkFBcUI7OztJQUU5Qiw2Q0FBNkI7O0lBRTdCLGlEQUFpQzs7SUFFakMsNENBQXFCOztJQUVyQiw2Q0FBb0I7O0lBQ3BCLHdDQUFnQjs7SUFDaEIsMENBQWtCOztJQUNsQiwwQ0FBZTs7Ozs7SUFHZixxQ0FBa0I7O0lBQ2xCLHdDQUFhOztJQWtCYiwwQ0FBZTs7Ozs7SUFFSCwwQ0FBNEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IElkU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktY29tbW9uJztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBQZXJzb25hbENvbmZpZyB9IGZyb20gJy4vbG9va3VwLWdyaWQtb3B0aW9ucyc7XHJcblxyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgUGVyc29uYWxDb25maWdTZXJ2aWNlIHtcclxuICAgIC8vIOS4quaAp+WMlumFjee9rlxyXG4gICAgcGVyc29uYWxDb25mOiBQZXJzb25hbENvbmZpZztcclxuXHJcbiAgICBzZWxlY3RJdGVtT2JzZXIkID0gbmV3IFN1YmplY3QoKTtcclxuXHJcbiAgICBkaXNwbGF5VHlwZSA9ICdMSVNUJztcclxuXHJcbiAgICBzaW5nbGVTZWxlY3QgPSB0cnVlO1xyXG4gICAgaWRGaWVsZDogc3RyaW5nO1xyXG4gICAgdGV4dEZpZWxkOiBzdHJpbmc7XHJcbiAgICBtYXBGaWVsZHM6IGFueTtcclxuXHJcbiAgICAvLyDkuKrmgKfljJbphY3nva5LRVlcclxuICAgIHByaXZhdGUgX2tleSA9ICcnO1xyXG4gICAgX25ld0tleSA9ICcnO1xyXG4gICAgZ2V0IHBlcnNvbmFsQ29uZmlnS2V5KCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9rZXk7XHJcbiAgICB9XHJcbiAgICBzZXQgcGVyc29uYWxDb25maWdLZXkodmFsKSB7XHJcbiAgICAgICAgaWYgKHZhbCkge1xyXG4gICAgICAgICAgICB0aGlzLl9rZXkgPSB0aGlzLmJ1aWxkS2V5KHZhbCk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmNvbnRyb2xJRCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fbmV3S2V5ID0gdGhpcy5idWlsZEtleSh0aGlzLmNvbnRyb2xJRCArICdfJyArIHZhbCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9uZXdLZXkgPSB0aGlzLl9rZXk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLl9uZXdLZXkgPSB0aGlzLmJ1aWxkS2V5KHRoaXMuY29udHJvbElEKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8g57uE5Lu2SURcclxuICAgIGNvbnRyb2xJRCA9ICcnO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaWRTZXJ2aWNlOiBJZFNlcnZpY2UpIHt9XHJcblxyXG4gICAgcHJpdmF0ZSBidWlsZEtleShzdHIpIHtcclxuICAgICAgICBsZXQgcHJlZml4ID0gJyc7XHJcbiAgICAgICAgaWYgKGxvY2F0aW9uLmhhc2gpIHtcclxuICAgICAgICAgICAgY29uc3QgcGF0aEFyciA9IGxvY2F0aW9uLmhhc2guc3BsaXQoJz8nKTtcclxuICAgICAgICAgICAgcHJlZml4ID0gcGF0aEFyciA/IHBhdGhBcnJbMF0gOiAnJztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBwYXRoQXJyICA9IGxvY2F0aW9uLnBhdGhuYW1lLnNwbGl0KCcvJyk7XHJcbiAgICAgICAgICAgIHByZWZpeCA9IHBhdGhBcnIgPyBwYXRoQXJyW3BhdGhBcnIubGVuZ3RoIC0gMV0gOiAnJztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaWRTZXJ2aWNlLmVuY3J5cHQocHJlZml4ICsgc3RyKTtcclxuICAgIH1cclxuXHJcbiAgICBpbml0UGVyc29uYWxDb25mKG9iaikge1xyXG4gICAgICAgIE9iamVjdC5hc3NpZ24odGhpcywgb2JqKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRQZXJzb25hbERhdGEoa2V5Pzogc3RyaW5nKTogUGVyc29uYWxDb25maWcge1xyXG4gICAgICAgIGlmIChrZXkpIHtcclxuICAgICAgICAgICAgdGhpcy5fa2V5ID0ga2V5O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMucGVyc29uYWxDb25maWdLZXkpIHtcclxuICAgICAgICAgICAgY29uc3QgY29uZiA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMucGVyc29uYWxDb25maWdLZXkpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGNvbmYgJiYgY29uZiAhPT0gJ3VuZGVmaW5lZCcgJiYgY29uZiAhPT0gJ251bGwnKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBlcnNvbmFsQ29uZiA9IGNvbmYgPyBKU09OLnBhcnNlKGNvbmYpIDoge307XHJcbiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVQZXJzb25hbENvbmZpZyh0aGlzLnBlcnNvbmFsQ29uZik7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuY29udHJvbElEKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2tleSAhPT0gdGhpcy5fbmV3S2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKHRoaXMuX2tleSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2F2ZVBlcnNvbmFsQ29uZmlnKHRoaXMucGVyc29uYWxDb25mKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wZXJzb25hbENvbmY7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UXVpY2tTZWxlY3RlZChsb2NhbGVJZD86IHN0cmluZyk6IGFueSB7XHJcbiAgICAgICAgY29uc3QgZCA9IHRoaXMuZ2V0UGVyc29uYWxEYXRhKCk7XHJcbiAgICAgICAgY29uc3QgcXMgPSAgZCA/IGQucXVpY2tTZWxlY3RlZCA6IG51bGw7XHJcblxyXG4gICAgICAgIGlmIChsb2NhbGVJZCkge1xyXG4gICAgICAgICAgICBpZiAocXMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW1zID0gcXNbbG9jYWxlSWRdO1xyXG4gICAgICAgICAgICAgICAgaWYgKGl0ZW1zICYmIGl0ZW1zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpdGVtcztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHFzO1xyXG4gICAgfVxyXG5cclxuICAgIGdldERpYWxvZ1NpemUoKSB7XHJcbiAgICAgICAgY29uc3QgZCA9IHRoaXMuZ2V0UGVyc29uYWxEYXRhKCk7XHJcbiAgICAgICAgcmV0dXJuIGQgPyBkLnNpemUgOiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZVBlcnNvbmFsQ29uZmlnKGNmZzogUGFydGlhbDxQZXJzb25hbENvbmZpZz4pIHtcclxuICAgICAgICBjb25zdCBkYXRhID0gT2JqZWN0LmFzc2lnbih0aGlzLnBlcnNvbmFsQ29uZiB8fCB7fSwgY2ZnKTtcclxuICAgICAgICB0aGlzLnNhdmVQZXJzb25hbENvbmZpZyhkYXRhKTtcclxuICAgIH1cclxuXHJcbiAgICBzYXZlUGVyc29uYWxDb25maWcoZGF0YTogUGVyc29uYWxDb25maWcpIHtcclxuICAgICAgICBpZiAodGhpcy5fbmV3S2V5KSB7XHJcbiAgICAgICAgICAgIGxldCBfZGF0YSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMuX25ld0tleSkgYXMgYW55O1xyXG4gICAgICAgICAgICBpZiAoX2RhdGEpIHtcclxuICAgICAgICAgICAgICAgIF9kYXRhID0gSlNPTi5wYXJzZShfZGF0YSkgYXMgUGVyc29uYWxDb25maWc7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKF9kYXRhLmZhdm9yaXRlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFkYXRhLmZhdm9yaXRlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZmF2b3JpdGUgPSBfZGF0YS5mYXZvcml0ZTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBPYmplY3Qua2V5cyhfZGF0YS5mYXZvcml0ZSkuZm9yRWFjaCgobGFuZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5mYXZvcml0ZVtsYW5nXSA9IGRhdGEuZmF2b3JpdGVbbGFuZ10gfHwgW107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2RhdGEuZmF2b3JpdGVbbGFuZ10pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhcnIgPSBBcnJheS5mcm9tKG5ldyBTZXQoWy4uLmRhdGEuZmF2b3JpdGVbbGFuZ10sIC4uLl9kYXRhLmZhdm9yaXRlW2xhbmddXSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZmF2b3JpdGVbbGFuZ10gPSBhcnI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5fbmV3S2V5LCBKU09OLnN0cmluZ2lmeShkYXRhKSk7XHJcbiAgICAgICAgICAgIHRoaXMucGVyc29uYWxDb25mID0gZGF0YTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0QWN0aXZlVGFiSW5kZXgodGFiTmFtZT86IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGQgPSB0aGlzLmdldFBlcnNvbmFsRGF0YSgpO1xyXG4gICAgICAgIGlmICghdGFiTmFtZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZCAmJiBkLnRhYkluZGV4ID8gZC50YWJJbmRleCAgOiAnZGF0YWxpc3QnO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGFiTmFtZTtcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVRdWVja1NlbGVjdGVkKHNlbGVjdGVkUm93OiBhbnksIGxvY2FsZUlkOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBxdWlja0l0ZW1zID0gdGhpcy5nZXRRdWlja1NlbGVjdGVkKGxvY2FsZUlkKTtcclxuXHJcbiAgICAgICAgaWYgKHF1aWNrSXRlbXMgJiYgcXVpY2tJdGVtcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRJbmRleCA9IFtdO1xyXG4gICAgICAgICAgICBxdWlja0l0ZW1zLmZvckVhY2goKGVsZW1lbnQsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaW5nbGVTZWxlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudCAmJiBzZWxlY3RlZFJvdyAmJiBlbGVtZW50W3RoaXMuaWRGaWVsZF0gPT09IHNlbGVjdGVkUm93W3RoaXMuaWRGaWVsZF0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRJbmRleC5wdXNoKGluZGV4KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZFJvdykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFJvdy5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudFt0aGlzLmlkRmllbGRdID09PSBpdGVtW3RoaXMuaWRGaWVsZF0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEluZGV4LnB1c2goaW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgc2VsZWN0ZWRJbmRleC5mb3JFYWNoKGluZGV4ID0+IHtcclxuICAgICAgICAgICAgICAgIHF1aWNrSXRlbXNbaW5kZXhdID0gbnVsbDtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnBlcnNvbmFsQ29uZi5xdWlja1NlbGVjdGVkW2xvY2FsZUlkXSA9XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBlcnNvbmFsQ29uZi5xdWlja1NlbGVjdGVkW2xvY2FsZUlkXS5maWx0ZXIodiA9PiB2ICE9PSBudWxsKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc2luZ2xlU2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBlcnNvbmFsQ29uZi5xdWlja1NlbGVjdGVkW2xvY2FsZUlkXS51bnNoaWZ0KHNlbGVjdGVkUm93KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZFJvdykge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkUm93LmZvckVhY2goZWxlbWVudCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGVyc29uYWxDb25mLnF1aWNrU2VsZWN0ZWRbbG9jYWxlSWRdLnVuc2hpZnQoZWxlbWVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5wZXJzb25hbENvbmYucXVpY2tTZWxlY3RlZFtsb2NhbGVJZF0ubGVuZ3RoID1cclxuICAgICAgICAgICAgICAgIHRoaXMucGVyc29uYWxDb25mLnF1aWNrU2VsZWN0ZWRbbG9jYWxlSWRdLmxlbmd0aCA+IDUgP1xyXG4gICAgICAgICAgICAgICAgICAgIDUgOiB0aGlzLnBlcnNvbmFsQ29uZi5xdWlja1NlbGVjdGVkW2xvY2FsZUlkXS5sZW5ndGg7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgX3FzID0gdGhpcy5wZXJzb25hbENvbmYucXVpY2tTZWxlY3RlZCB8fCB7fTtcclxuICAgICAgICAgICAgbGV0IG5ld0RhdGE7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNpbmdsZVNlbGVjdCkge1xyXG4gICAgICAgICAgICAgICAgbmV3RGF0YSA9IE9iamVjdC5hc3NpZ24oX3FzLCB7IFtsb2NhbGVJZF06IFtzZWxlY3RlZFJvd10gfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBzZWxlY3RlZFJvdy5sZW5ndGggPSBzZWxlY3RlZFJvdy5sZW5ndGggPiA1ID8gNSA6IHNlbGVjdGVkUm93Lmxlbmd0aDtcclxuICAgICAgICAgICAgICAgIG5ld0RhdGEgPSBPYmplY3QuYXNzaWduKF9xcywgeyBbbG9jYWxlSWRdOiBzZWxlY3RlZFJvdyB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnBlcnNvbmFsQ29uZi5xdWlja1NlbGVjdGVkID0gbmV3RGF0YTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuc2F2ZVBlcnNvbmFsQ29uZmlnKHRoaXMucGVyc29uYWxDb25mKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqICDmm7TmlrDmlbDmja7nu5PmnoTvvIznjrDmnInkuKrmgKfljJbmlbDmja7lnYfovazkuLog5Lit5paH546v5aKD5LiL5pWw5o2u77ybXHJcbiAgICAgKi9cclxuICAgIF91cGRhdGVQZXJzb25hbENvbmZpZyhwZXI6IFBlcnNvbmFsQ29uZmlnKSB7XHJcbiAgICAgICAgaWYgKHBlcikge1xyXG4gICAgICAgICAgICBsZXQgZmxhZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAvLyDmm7TmlrDmlLbol4/mlbDmja5cclxuICAgICAgICAgICAgaWYgKHBlci5mYXZvcml0ZSAmJiBBcnJheS5pc0FycmF5KHBlci5mYXZvcml0ZSkpIHtcclxuICAgICAgICAgICAgICAgIHBlci5mYXZvcml0ZSA9IHsgJ3poLUNIUyc6IFsuLi5wZXIuZmF2b3JpdGVdIH07XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgcGVyLmZhdm9yaXRlO1xyXG5cclxuICAgICAgICAgICAgICAgIGZsYWcgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIOabtOaWsOW/q+aNt+W9leWFpeaVsOaNrlxyXG4gICAgICAgICAgICBpZiAocGVyLnNlbGVjdGVkKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShwZXIuc2VsZWN0ZWQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGVyLnF1aWNrU2VsZWN0ZWQgPSB7ICd6aC1DSFMnOiBbLi4ucGVyLnNlbGVjdGVkXSB9O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZGVsZXRlIHBlci5zZWxlY3RlZDtcclxuICAgICAgICAgICAgICAgIGZsYWcgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoZmxhZykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zYXZlUGVyc29uYWxDb25maWcocGVyKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbn1cclxuIl19