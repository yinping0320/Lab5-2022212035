/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChangeDetectorRef, Component, ElementRef, EventEmitter, Injector, Input, Output, ViewChild } from '@angular/core';
import { DialogComponent } from '@farris/ui-dialog';
import { SearchBoxComponent, SearchFieldsComponent } from '@farris/ui-search-box';
import { LookupGridComponent } from '../lookup-grid.component';
import { SearchBarMode } from '../lookup-displaytype';
export class LookupFilterBarComponent {
    /**
     * @param {?} injector
     * @param {?} cd
     * @param {?} lookIns
     */
    constructor(injector, cd, lookIns) {
        this.injector = injector;
        this.cd = cd;
        this.lookIns = lookIns;
        this.fields = [];
        this.filterFields = [];
        this.searchAnyField = true;
        this.columns = [];
        this.viewType = SearchBarMode.both;
        this.isNav = false;
        this.searchFields = [];
        this.conditionsChange = new EventEmitter();
        this.textConditions = [];
        this.fieldConditons = [];
        this.dialogRef = this.injector.get(DialogComponent, null);
        this.el = this.injector.get(ElementRef);
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.searchFields = this.searchFields || [];
        this.convertColumnsToSearchFields();
        if (this.dialogRef && this.searchboxRef) {
            this.dialogRef.moving.subscribe((/**
             * @return {?}
             */
            () => {
                this.searchboxRef.updateShadowBoxPosition();
            }));
        }
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (changes.columns && !changes.columns.isFirstChange()) {
            this.convertColumnsToSearchFields();
            setTimeout((/**
             * @return {?}
             */
            () => {
                this.initSearchValue();
            }), 100);
        }
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
    }
    /**
     * @private
     * @return {?}
     */
    initSearchValue() {
        if (this.lookIns._searchState && !this.isNav && this.searchboxRef) {
            const { field, value } = this.lookIns._searchState;
            if (field === '*' && value != '' && value !== null && value !== undefined) {
                /** @type {?} */
                const alltitle = this.lookIns.localService.getValue('lookup.anyFields');
                /** @type {?} */
                const _conditions = [{ code: '*', name: alltitle, value }];
                this.searchboxRef.setValue(_conditions, false);
                this.textConditions = this.searchboxRef.expandStarFieldToAllFields();
            }
        }
    }
    /**
     * @private
     * @param {?} n
     * @return {?}
     */
    converColumnToFilterField(n) {
        /** @type {?} */
        const t = {};
        t.id = n.field;
        t.labelCode = n.field;
        t.code = n.fieldPath;
        t.name = n.title;
        /** @type {?} */
        const options = n.formatter ? n.formatter.options : null;
        // 数字
        if (n.fieldType === 'NumericType') {
            /** @type {?} */
            const _options = Object.assign({}, (options || {}));
            n.precision = n.precision || 0;
            _options.precision = _options.precision || 0;
            if (n.precision != _options.precision) {
                _options.precision = n.precision;
            }
            t.control = Object.assign({
                "controltype": "number",
                "bigNumber": false,
                "placeHolder": '请输入数字',
                single: true
            }, _options);
            t.beginPlaceHolder = "开始数值";
            t.endPlaceHolder = "结束数值";
        }
        // 枚举
        if (n.fieldType === 'EnumType') {
            t.control = {
                "controltype": "enum",
                "enumValues": n.formatter.options.data,
                single: true
            };
        }
        // 布尔
        if (n.fieldType === 'BooleanType') {
            /** @type {?} */
            let trueText = options ? options.trueText || 'True' : 'True';
            /** @type {?} */
            let falseText = options ? options.falseText || 'False' : 'False';
            t.control = {
                controltype: 'dropdown',
                enumValues: [
                    { value: 1, name: trueText },
                    { value: 0, name: falseText },
                ],
                single: true
            };
        }
        // 日期
        if (n.fieldType === "DateType" || n.fieldType === 'DateTimeType') {
            /** @type {?} */
            let dateFormat = 'yyyy-MM-dd';
            /** @type {?} */
            let showTime = false;
            /** @type {?} */
            let showType = '1';
            if (options) {
                if (options.format) {
                    dateFormat = options.format;
                }
            }
            if (n.fieldType === 'DateTimeType') {
                showTime = true;
            }
            if (dateFormat === 'yyyy') {
                showType = '2';
            }
            if (dateFormat === 'yyyy-MM') {
                showType = '3';
            }
            t.control = {
                "controltype": "datetime",
                "placeholder": "请选择日期",
                single: true,
                dateFormat,
                showTime,
                showType
            };
        }
        return t;
    }
    /**
     * @private
     * @return {?}
     */
    convertColumnsToSearchFields() {
        if (this.columns && this.columns.length) {
            this.fields = this.columns.filter((/**
             * @param {?} n
             * @return {?}
             */
            n => n.fieldType && (n.fieldType === 'StringType' || n.fieldType === 'TextType'))).map((/**
             * @param {?} n
             * @return {?}
             */
            n => {
                return {
                    code: n.fieldPath,
                    name: n.title
                };
            }));
            if (!this.fields.length && this.searchFields.length) {
                this.fields = this.searchFields.map((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => {
                    return {
                        code: n.value,
                        name: n.label
                    };
                }));
            }
            if (this.viewType === 'both' || this.viewType === 'onlyfield') {
                this.filterFields = this.columns.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n.fieldType && n.fieldType !== 'StringType' && n.fieldType !== 'TextType' && n.field)).map((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => {
                    return this.converColumnToFilterField(n);
                }));
            }
            if (this.lookIns && this.lookIns.allowQueryFields) {
                const { nav, main } = this.lookIns.allowQueryFields;
                /** @type {?} */
                let queryFields = main;
                if (this.isNav) {
                    queryFields = nav;
                }
                if (queryFields) {
                    /** @type {?} */
                    const _queryFields = queryFields.split(',');
                    this.fields = this.fields.filter((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => _queryFields.findIndex((/**
                     * @param {?} f
                     * @return {?}
                     */
                    f => f === n.code)) > -1));
                    this.filterFields = this.filterFields.filter((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => _queryFields.findIndex((/**
                     * @param {?} f
                     * @return {?}
                     */
                    (f) => f === n.code)) > -1));
                }
            }
            this.cd.markForCheck();
        }
    }
    /**
     * @param {?} $event
     * @param {?=} isString
     * @return {?}
     */
    onConditionChange($event, isString = true) {
        if (isString) {
            this.textConditions = $event;
        }
        else {
            this.fieldConditons = $event;
        }
        this.textConditions = this.textConditions || [];
        /** @type {?} */
        const _conditions$ = this.fieldConditons.concat([]);
        if (this.fieldConditons && this.fieldConditons.length && this.textConditions.length) {
            _conditions$[0].lbracket = this.fieldConditons[0].lbracket + '(';
            _conditions$[_conditions$.length - 1].relation = 1;
            _conditions$[_conditions$.length - 1].rbracket = _conditions$[_conditions$.length - 1].rbracket + ')';
        }
        /** @type {?} */
        const _conditions = _conditions$.concat(this.textConditions);
        this.conditionsChange.emit(_conditions);
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    onClearConditions($event) {
        $event.stopPropagation();
        this.textConditions = [];
        this.fieldConditons = [];
        if (this.searchboxRef) {
            this.searchboxRef.clearConditions(false);
        }
        if (this.searchfieldsRef) {
            this.filterFields.forEach((/**
             * @param {?} n
             * @return {?}
             */
            n => {
                n.value = null;
            }));
            this.searchfieldsRef.clearConditions(false);
        }
        this.cd.detectChanges();
        this.conditionsChange.emit([]);
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    onEsc($event) {
        this.lookIns.closeLoading();
        this.lookIns.closeDialog();
    }
}
LookupFilterBarComponent.decorators = [
    { type: Component, args: [{
                selector: '[lookup-filter-bar]',
                template: `
    <div class="d-flex flex-row">
        <farris-search-fields #searchfields [fields]="filterFields" class="mr-2 f-utils-fill"  
        *ngIf="filterFields && filterFields.length && (viewType == 'both' || viewType=== 'onlyfield')" 
        (conditionChange)="onConditionChange($event, false)"></farris-search-fields>

        <div style="min-width:40%;" class="d-flex flex-row" [class.w-100]="!filterFields || !filterFields.length" [style.maxWidth]="filterFields && filterFields.length?'70%': '100%'">
            <farris-search-box #searchbox [fields]="fields" [useAnyField]="searchAnyField"
            (conditionChange)="onConditionChange($event, true)" class="f-cmp-inputgroup f-utils-fill" 
            *ngIf="(viewType == 'both' || viewType=== 'onlyinput')" (escHandler)="onEsc($event)"></farris-search-box>
            <span class="f-icon f-icon-remove clear-search-fields" 
                [ngStyle]="((textConditions && textConditions.length) || (fieldConditons && fieldConditons.length)) ? { }: {opacity: '0.3',pointerEvents: 'none'}"
                (click)="onClearConditions($event)" title="{{ 'lookup.clearAllConditions' | locale }}" style="min-width:28px;border: 0;"></span>
        </div>
    </div>
    `
            }] }
];
/** @nocollapse */
LookupFilterBarComponent.ctorParameters = () => [
    { type: Injector },
    { type: ChangeDetectorRef },
    { type: LookupGridComponent }
];
LookupFilterBarComponent.propDecorators = {
    searchAnyField: [{ type: Input }],
    columns: [{ type: Input }],
    viewType: [{ type: Input }],
    isNav: [{ type: Input }],
    searchFields: [{ type: Input }],
    conditionsChange: [{ type: Output }],
    searchboxRef: [{ type: ViewChild, args: ['searchbox',] }],
    searchfieldsRef: [{ type: ViewChild, args: ['searchfields',] }]
};
if (false) {
    /** @type {?} */
    LookupFilterBarComponent.prototype.fields;
    /** @type {?} */
    LookupFilterBarComponent.prototype.filterFields;
    /** @type {?} */
    LookupFilterBarComponent.prototype.searchAnyField;
    /** @type {?} */
    LookupFilterBarComponent.prototype.columns;
    /** @type {?} */
    LookupFilterBarComponent.prototype.viewType;
    /** @type {?} */
    LookupFilterBarComponent.prototype.isNav;
    /** @type {?} */
    LookupFilterBarComponent.prototype.searchFields;
    /** @type {?} */
    LookupFilterBarComponent.prototype.conditionsChange;
    /** @type {?} */
    LookupFilterBarComponent.prototype.searchboxRef;
    /** @type {?} */
    LookupFilterBarComponent.prototype.searchfieldsRef;
    /** @type {?} */
    LookupFilterBarComponent.prototype.textConditions;
    /** @type {?} */
    LookupFilterBarComponent.prototype.fieldConditons;
    /** @type {?} */
    LookupFilterBarComponent.prototype.dialogRef;
    /**
     * @type {?}
     * @private
     */
    LookupFilterBarComponent.prototype.el;
    /**
     * @type {?}
     * @private
     */
    LookupFilterBarComponent.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    LookupFilterBarComponent.prototype.cd;
    /**
     * @type {?}
     * @private
     */
    LookupFilterBarComponent.prototype.lookIns;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9va3VwLWZpbHRlci1iYXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvYWR2YW5jZWQtbGF5b3V0L2xvb2t1cC1maWx0ZXItYmFyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFpQixpQkFBaUIsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFxQixNQUFNLEVBQWlCLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1SyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLHFCQUFxQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDbEYsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDL0QsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBc0J0RCxNQUFNLE9BQU8sd0JBQXdCOzs7Ozs7SUFzQmpDLFlBQW9CLFFBQWtCLEVBQVUsRUFBcUIsRUFBVSxPQUE0QjtRQUF2RixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsT0FBRSxHQUFGLEVBQUUsQ0FBbUI7UUFBVSxZQUFPLEdBQVAsT0FBTyxDQUFxQjtRQXBCM0csV0FBTSxHQUFHLEVBQUUsQ0FBQztRQUNaLGlCQUFZLEdBQUcsRUFBRSxDQUFDO1FBQ1QsbUJBQWMsR0FBRyxJQUFJLENBQUM7UUFDdEIsWUFBTyxHQUFHLEVBQUUsQ0FBQztRQUNiLGFBQVEsR0FBa0IsYUFBYSxDQUFDLElBQUksQ0FBQztRQUM3QyxVQUFLLEdBQUcsS0FBSyxDQUFDO1FBRWQsaUJBQVksR0FBRyxFQUFFLENBQUM7UUFFakIscUJBQWdCLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUtoRCxtQkFBYyxHQUFHLEVBQUUsQ0FBQztRQUNwQixt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U0FDL0M7UUFFRCxJQUFJLENBQUMsRUFBRSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDbkMsQ0FBQzs7Ozs7SUFFRCxLQUFLLENBQUMsTUFBTTtRQUNSLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUMvQixDQUFDOzs7WUF4UEosU0FBUyxTQUFDO2dCQUNQLFFBQVEsRUFBRSxxQkFBcUI7Z0JBQy9CLFFBQVEsRUFBRTs7Ozs7Ozs7Ozs7Ozs7O0tBZVQ7YUFDSjs7OztZQXhCK0UsUUFBUTtZQUFoRSxpQkFBaUI7WUFHaEMsbUJBQW1COzs7NkJBMkJ2QixLQUFLO3NCQUNMLEtBQUs7dUJBQ0wsS0FBSztvQkFDTCxLQUFLOzJCQUVMLEtBQUs7K0JBRUwsTUFBTTsyQkFFTixTQUFTLFNBQUMsV0FBVzs4QkFDckIsU0FBUyxTQUFDLGNBQWM7Ozs7SUFaekIsMENBQVk7O0lBQ1osZ0RBQWtCOztJQUNsQixrREFBK0I7O0lBQy9CLDJDQUFzQjs7SUFDdEIsNENBQXNEOztJQUN0RCx5Q0FBdUI7O0lBRXZCLGdEQUEyQjs7SUFFM0Isb0RBQWdEOztJQUVoRCxnREFBeUQ7O0lBQ3pELG1EQUFrRTs7SUFFbEUsa0RBQW9COztJQUNwQixrREFBb0I7O0lBR3BCLDZDQUEyQjs7Ozs7SUFDM0Isc0NBQXVCOzs7OztJQUNYLDRDQUEwQjs7Ozs7SUFBRSxzQ0FBNkI7Ozs7O0lBQUUsMkNBQW9DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWZ0ZXJWaWV3SW5pdCwgQ2hhbmdlRGV0ZWN0b3JSZWYsIENvbXBvbmVudCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBJbmplY3RvciwgSW5wdXQsIE9uQ2hhbmdlcywgT25Jbml0LCBPdXRwdXQsIFNpbXBsZUNoYW5nZXMsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBEaWFsb2dDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWRpYWxvZyc7XHJcbmltcG9ydCB7IFNlYXJjaEJveENvbXBvbmVudCwgU2VhcmNoRmllbGRzQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1zZWFyY2gtYm94JztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IFNlYXJjaEJhck1vZGUgfSBmcm9tICcuLi9sb29rdXAtZGlzcGxheXR5cGUnO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgICBzZWxlY3RvcjogJ1tsb29rdXAtZmlsdGVyLWJhcl0nLFxyXG4gICAgdGVtcGxhdGU6IGBcclxuICAgIDxkaXYgY2xhc3M9XCJkLWZsZXggZmxleC1yb3dcIj5cclxuICAgICAgICA8ZmFycmlzLXNlYXJjaC1maWVsZHMgI3NlYXJjaGZpZWxkcyBbZmllbGRzXT1cImZpbHRlckZpZWxkc1wiIGNsYXNzPVwibXItMiBmLXV0aWxzLWZpbGxcIiAgXHJcbiAgICAgICAgKm5nSWY9XCJmaWx0ZXJGaWVsZHMgJiYgZmlsdGVyRmllbGRzLmxlbmd0aCAmJiAodmlld1R5cGUgPT0gJ2JvdGgnIHx8IHZpZXdUeXBlPT09ICdvbmx5ZmllbGQnKVwiIFxyXG4gICAgICAgIChjb25kaXRpb25DaGFuZ2UpPVwib25Db25kaXRpb25DaGFuZ2UoJGV2ZW50LCBmYWxzZSlcIj48L2ZhcnJpcy1zZWFyY2gtZmllbGRzPlxyXG5cclxuICAgICAgICA8ZGl2IHN0eWxlPVwibWluLXdpZHRoOjQwJTtcIiBjbGFzcz1cImQtZmxleCBmbGV4LXJvd1wiIFtjbGFzcy53LTEwMF09XCIhZmlsdGVyRmllbGRzIHx8ICFmaWx0ZXJGaWVsZHMubGVuZ3RoXCIgW3N0eWxlLm1heFdpZHRoXT1cImZpbHRlckZpZWxkcyAmJiBmaWx0ZXJGaWVsZHMubGVuZ3RoPyc3MCUnOiAnMTAwJSdcIj5cclxuICAgICAgICAgICAgPGZhcnJpcy1zZWFyY2gtYm94ICNzZWFyY2hib3ggW2ZpZWxkc109XCJmaWVsZHNcIiBbdXNlQW55RmllbGRdPVwic2VhcmNoQW55RmllbGRcIlxyXG4gICAgICAgICAgICAoY29uZGl0aW9uQ2hhbmdlKT1cIm9uQ29uZGl0aW9uQ2hhbmdlKCRldmVudCwgdHJ1ZSlcIiBjbGFzcz1cImYtY21wLWlucHV0Z3JvdXAgZi11dGlscy1maWxsXCIgXHJcbiAgICAgICAgICAgICpuZ0lmPVwiKHZpZXdUeXBlID09ICdib3RoJyB8fCB2aWV3VHlwZT09PSAnb25seWlucHV0JylcIiAoZXNjSGFuZGxlcik9XCJvbkVzYygkZXZlbnQpXCI+PC9mYXJyaXMtc2VhcmNoLWJveD5cclxuICAgICAgICAgICAgPHNwYW4gY2xhc3M9XCJmLWljb24gZi1pY29uLXJlbW92ZSBjbGVhci1zZWFyY2gtZmllbGRzXCIgXHJcbiAgICAgICAgICAgICAgICBbbmdTdHlsZV09XCIoKHRleHRDb25kaXRpb25zICYmIHRleHRDb25kaXRpb25zLmxlbmd0aCkgfHwgKGZpZWxkQ29uZGl0b25zICYmIGZpZWxkQ29uZGl0b25zLmxlbmd0aCkpID8geyB9OiB7b3BhY2l0eTogJzAuMycscG9pbnRlckV2ZW50czogJ25vbmUnfVwiXHJcbiAgICAgICAgICAgICAgICAoY2xpY2spPVwib25DbGVhckNvbmRpdGlvbnMoJGV2ZW50KVwiIHRpdGxlPVwie3sgJ2xvb2t1cC5jbGVhckFsbENvbmRpdGlvbnMnIHwgbG9jYWxlIH19XCIgc3R5bGU9XCJtaW4td2lkdGg6MjhweDtib3JkZXI6IDA7XCI+PC9zcGFuPlxyXG4gICAgICAgIDwvZGl2PlxyXG4gICAgPC9kaXY+XHJcbiAgICBgXHJcbn0pXHJcblxyXG5leHBvcnQgY2xhc3MgTG9va3VwRmlsdGVyQmFyQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMsIEFmdGVyVmlld0luaXQge1xyXG5cclxuICAgIGZpZWxkcyA9IFtdO1xyXG4gICAgZmlsdGVyRmllbGRzID0gW107XHJcbiAgICBASW5wdXQoKSBzZWFyY2hBbnlGaWVsZCA9IHRydWU7XHJcbiAgICBASW5wdXQoKSBjb2x1bW5zID0gW107XHJcbiAgICBASW5wdXQoKSB2aWV3VHlwZTogU2VhcmNoQmFyTW9kZSA9IFNlYXJjaEJhck1vZGUuYm90aDtcclxuICAgIEBJbnB1dCgpIGlzTmF2ID0gZmFsc2U7XHJcblxyXG4gICAgQElucHV0KCkgc2VhcmNoRmllbGRzID0gW107XHJcblxyXG4gICAgQE91dHB1dCgpIGNvbmRpdGlvbnNDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcblxyXG4gICAgQFZpZXdDaGlsZCgnc2VhcmNoYm94Jykgc2VhcmNoYm94UmVmOiBTZWFyY2hCb3hDb21wb25lbnQ7XHJcbiAgICBAVmlld0NoaWxkKCdzZWFyY2hmaWVsZHMnKSBzZWFyY2hmaWVsZHNSZWY6IFNlYXJjaEZpZWxkc0NvbXBvbmVudDtcclxuXHJcbiAgICB0ZXh0Q29uZGl0aW9ucyA9IFtdO1xyXG4gICAgZmllbGRDb25kaXRvbnMgPSBbXTtcclxuICAgIFxyXG5cclxuICAgIGRpYWxvZ1JlZjogRGlhbG9nQ29tcG9uZW50O1xyXG4gICAgcHJpdmF0ZSBlbDogRWxlbWVudFJlZjtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIGNkOiBDaGFuZ2VEZXRlY3RvclJlZiwgcHJpdmF0ZSBsb29rSW5zOiBMb29rdXBHcmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgdGhpcy5kaWFsb2dSZWYgPSB0aGlzLmluamVjdG9yLmdldChEaWFsb2dDb21wb25lbnQsIG51bGwpO1xyXG4gICAgICAgIHRoaXMuZWwgPSB0aGlzLmluamVjdG9yLmdldChFbGVtZW50UmVmKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uSW5pdCgpIHtcclxuICAgICAgICB0aGlzLnNlYXJjaEZpZWxkcyA9IHRoaXMuc2VhcmNoRmllbGRzIHx8IFtdO1xyXG4gICAgICAgIHRoaXMuY29udmVydENvbHVtbnNUb1NlYXJjaEZpZWxkcygpO1xyXG5cclxuICAgICAgICBpZih0aGlzLmRpYWxvZ1JlZiAmJiB0aGlzLnNlYXJjaGJveFJlZikge1xyXG4gICAgICAgICAgICB0aGlzLmRpYWxvZ1JlZi5tb3Zpbmcuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoYm94UmVmLnVwZGF0ZVNoYWRvd0JveFBvc2l0aW9uKCk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcclxuICAgICAgICBpZiAoY2hhbmdlcy5jb2x1bW5zICYmICFjaGFuZ2VzLmNvbHVtbnMuaXNGaXJzdENoYW5nZSgpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udmVydENvbHVtbnNUb1NlYXJjaEZpZWxkcygpO1xyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5pdFNlYXJjaFZhbHVlKCk7XHJcbiAgICAgICAgICAgIH0sIDEwMClcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdJbml0KCkge1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaW5pdFNlYXJjaFZhbHVlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmxvb2tJbnMuX3NlYXJjaFN0YXRlICYmICF0aGlzLmlzTmF2ICYmIHRoaXMuc2VhcmNoYm94UmVmKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgZmllbGQsIHZhbHVlfSA9IHRoaXMubG9va0lucy5fc2VhcmNoU3RhdGU7XHJcbiAgICAgICAgICAgIGlmIChmaWVsZCA9PT0gJyonICYmIHZhbHVlICE9ICcnICYmIHZhbHVlICE9PSBudWxsICYmIHZhbHVlIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYWxsdGl0bGUgPSB0aGlzLmxvb2tJbnMubG9jYWxTZXJ2aWNlLmdldFZhbHVlKCdsb29rdXAuYW55RmllbGRzJylcclxuICAgICAgICAgICAgICAgIGNvbnN0IF9jb25kaXRpb25zID0gW3sgY29kZTogJyonLCBuYW1lOiBhbGx0aXRsZSwgdmFsdWUgfV07XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaGJveFJlZi5zZXRWYWx1ZShfY29uZGl0aW9ucywgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy50ZXh0Q29uZGl0aW9ucyA9IHRoaXMuc2VhcmNoYm94UmVmLmV4cGFuZFN0YXJGaWVsZFRvQWxsRmllbGRzKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjb252ZXJDb2x1bW5Ub0ZpbHRlckZpZWxkKG46IGFueSkge1xyXG4gICAgICAgIGNvbnN0IHQ6IGFueSA9IHt9O1xyXG4gICAgICAgIHQuaWQgPSBuLmZpZWxkO1xyXG4gICAgICAgIHQubGFiZWxDb2RlID0gbi5maWVsZDtcclxuICAgICAgICB0LmNvZGUgPSBuLmZpZWxkUGF0aDtcclxuICAgICAgICB0Lm5hbWUgPSBuLnRpdGxlO1xyXG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSBuLmZvcm1hdHRlciA/IG4uZm9ybWF0dGVyLm9wdGlvbnMgOiBudWxsO1xyXG4gICAgICAgIC8vIOaVsOWtl1xyXG4gICAgICAgIGlmIChuLmZpZWxkVHlwZSA9PT0gJ051bWVyaWNUeXBlJykge1xyXG4gICAgICAgICAgICBjb25zdCBfb3B0aW9ucyA9IHsuLi4ob3B0aW9ucyB8fCB7fSl9O1xyXG4gICAgICAgICAgICBuLnByZWNpc2lvbiA9IG4ucHJlY2lzaW9uIHx8IDA7XHJcbiAgICAgICAgICAgIF9vcHRpb25zLnByZWNpc2lvbiA9IF9vcHRpb25zLnByZWNpc2lvbiB8fCAwO1xyXG4gICAgICAgICAgICBpZiAobi5wcmVjaXNpb24gIT0gX29wdGlvbnMucHJlY2lzaW9uKSB7XHJcbiAgICAgICAgICAgICAgICBfb3B0aW9ucy5wcmVjaXNpb24gPSBuLnByZWNpc2lvbjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdC5jb250cm9sID0gT2JqZWN0LmFzc2lnbih7IFxyXG4gICAgICAgICAgICAgICAgXCJjb250cm9sdHlwZVwiOiBcIm51bWJlclwiLCBcclxuICAgICAgICAgICAgICAgIFwiYmlnTnVtYmVyXCI6IGZhbHNlLCBcclxuICAgICAgICAgICAgICAgIFwicGxhY2VIb2xkZXJcIjogJ+ivt+i+k+WFpeaVsOWtlycsIFxyXG4gICAgICAgICAgICAgICAgc2luZ2xlOiB0cnVlIFxyXG4gICAgICAgICAgICB9LCBfb3B0aW9ucyk7XHJcbiAgICAgICAgICAgIHQuYmVnaW5QbGFjZUhvbGRlciA9IFwi5byA5aeL5pWw5YC8XCI7XHJcbiAgICAgICAgICAgIHQuZW5kUGxhY2VIb2xkZXIgPSBcIue7k+adn+aVsOWAvFwiO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDmnprkuL5cclxuICAgICAgICBpZiAobi5maWVsZFR5cGUgPT09ICdFbnVtVHlwZScpIHtcclxuICAgICAgICAgICAgdC5jb250cm9sID0ge1xyXG4gICAgICAgICAgICAgICAgXCJjb250cm9sdHlwZVwiOiBcImVudW1cIixcclxuICAgICAgICAgICAgICAgIFwiZW51bVZhbHVlc1wiOiBuLmZvcm1hdHRlci5vcHRpb25zLmRhdGEsXHJcbiAgICAgICAgICAgICAgICBzaW5nbGU6IHRydWVcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOW4g+WwlFxyXG4gICAgICAgIGlmIChuLmZpZWxkVHlwZSA9PT0gJ0Jvb2xlYW5UeXBlJykge1xyXG4gICAgICAgICAgICBsZXQgdHJ1ZVRleHQgPSBvcHRpb25zID8gb3B0aW9ucy50cnVlVGV4dCB8fCAnVHJ1ZScgOiAnVHJ1ZSc7XHJcblxyXG4gICAgICAgICAgICBsZXQgZmFsc2VUZXh0ID0gb3B0aW9ucyA/IG9wdGlvbnMuZmFsc2VUZXh0IHx8ICdGYWxzZScgOiAnRmFsc2UnO1xyXG4gICAgICAgICAgICB0LmNvbnRyb2wgPSB7XHJcbiAgICAgICAgICAgICAgICBjb250cm9sdHlwZTogJ2Ryb3Bkb3duJyxcclxuICAgICAgICAgICAgICAgIGVudW1WYWx1ZXM6IFtcclxuICAgICAgICAgICAgICAgICAgICB7IHZhbHVlOiAxLCBuYW1lOiB0cnVlVGV4dCB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHsgdmFsdWU6IDAsIG5hbWU6IGZhbHNlVGV4dCB9LFxyXG4gICAgICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgICAgIHNpbmdsZTogdHJ1ZVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g5pel5pyfXHJcbiAgICAgICAgaWYgKG4uZmllbGRUeXBlID09PSBcIkRhdGVUeXBlXCIgfHwgbi5maWVsZFR5cGUgPT09ICdEYXRlVGltZVR5cGUnKSB7XHJcblxyXG4gICAgICAgICAgICBsZXQgZGF0ZUZvcm1hdCA9ICd5eXl5LU1NLWRkJztcclxuICAgICAgICAgICAgbGV0IHNob3dUaW1lID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGxldCBzaG93VHlwZSA9ICcxJztcclxuICAgICAgICAgICAgaWYgKG9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmZvcm1hdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdGVGb3JtYXQgPSBvcHRpb25zLmZvcm1hdDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAobi5maWVsZFR5cGUgPT09ICdEYXRlVGltZVR5cGUnKSB7XHJcbiAgICAgICAgICAgICAgICBzaG93VGltZSA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGRhdGVGb3JtYXQgPT09ICd5eXl5Jykge1xyXG4gICAgICAgICAgICAgICAgc2hvd1R5cGUgPSAnMic7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGRhdGVGb3JtYXQgPT09ICd5eXl5LU1NJykge1xyXG4gICAgICAgICAgICAgICAgc2hvd1R5cGUgPSAnMyc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdC5jb250cm9sID0ge1xyXG4gICAgICAgICAgICAgICAgXCJjb250cm9sdHlwZVwiOiBcImRhdGV0aW1lXCIsXHJcbiAgICAgICAgICAgICAgICBcInBsYWNlaG9sZGVyXCI6IFwi6K+36YCJ5oup5pel5pyfXCIsXHJcbiAgICAgICAgICAgICAgICBzaW5nbGU6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBkYXRlRm9ybWF0LFxyXG4gICAgICAgICAgICAgICAgc2hvd1RpbWUsXHJcbiAgICAgICAgICAgICAgICBzaG93VHlwZVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNvbnZlcnRDb2x1bW5zVG9TZWFyY2hGaWVsZHMoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuY29sdW1ucyAmJiB0aGlzLmNvbHVtbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZmllbGRzID0gdGhpcy5jb2x1bW5zLmZpbHRlcihuID0+IG4uZmllbGRUeXBlICYmIChuLmZpZWxkVHlwZSA9PT0gJ1N0cmluZ1R5cGUnIHx8IG4uZmllbGRUeXBlID09PSAnVGV4dFR5cGUnKSkubWFwKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICBjb2RlOiBuLmZpZWxkUGF0aCxcclxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBuLnRpdGxlXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGlmICghdGhpcy5maWVsZHMubGVuZ3RoICYmIHRoaXMuc2VhcmNoRmllbGRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5maWVsZHMgPSB0aGlzLnNlYXJjaEZpZWxkcy5tYXAobiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogbi52YWx1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbi5sYWJlbFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy52aWV3VHlwZSA9PT0gJ2JvdGgnIHx8IHRoaXMudmlld1R5cGUgPT09ICdvbmx5ZmllbGQnKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZpbHRlckZpZWxkcyA9IHRoaXMuY29sdW1ucy5maWx0ZXIobiA9PiBuLmZpZWxkVHlwZSAmJiBuLmZpZWxkVHlwZSAhPT0gJ1N0cmluZ1R5cGUnICYmIG4uZmllbGRUeXBlICE9PSAnVGV4dFR5cGUnICYmIG4uZmllbGQpLm1hcChuID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jb252ZXJDb2x1bW5Ub0ZpbHRlckZpZWxkKG4pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmxvb2tJbnMgJiYgdGhpcy5sb29rSW5zLmFsbG93UXVlcnlGaWVsZHMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHsgbmF2LCBtYWluIH0gPSB0aGlzLmxvb2tJbnMuYWxsb3dRdWVyeUZpZWxkcztcclxuICAgICAgICAgICAgICAgIGxldCBxdWVyeUZpZWxkcyA9IG1haW47XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc05hdikge1xyXG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5RmllbGRzID0gbmF2O1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChxdWVyeUZpZWxkcykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IF9xdWVyeUZpZWxkcyA9IHF1ZXJ5RmllbGRzLnNwbGl0KCcsJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5maWVsZHMgPSB0aGlzLmZpZWxkcy5maWx0ZXIobiA9PiBfcXVlcnlGaWVsZHMuZmluZEluZGV4KGYgPT4gZiA9PT0gbi5jb2RlKSA+IC0xKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmZpbHRlckZpZWxkcyA9IHRoaXMuZmlsdGVyRmllbGRzLmZpbHRlcihuID0+IF9xdWVyeUZpZWxkcy5maW5kSW5kZXgoKGY6IGFueSkgPT4gZiA9PT0gbi5jb2RlKSA+IC0xKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5jZC5tYXJrRm9yQ2hlY2soKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgb25Db25kaXRpb25DaGFuZ2UoJGV2ZW50LCBpc1N0cmluZyA9IHRydWUpIHtcclxuICAgICAgICBpZiAoaXNTdHJpbmcpIHtcclxuICAgICAgICAgICAgdGhpcy50ZXh0Q29uZGl0aW9ucyA9ICRldmVudDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmZpZWxkQ29uZGl0b25zID0gJGV2ZW50O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy50ZXh0Q29uZGl0aW9ucyA9IHRoaXMudGV4dENvbmRpdGlvbnMgfHwgW107XHJcbiAgICAgICAgY29uc3QgX2NvbmRpdGlvbnMkID0gIHRoaXMuZmllbGRDb25kaXRvbnMuY29uY2F0KFtdKTtcclxuICAgICAgICBpZiAodGhpcy5maWVsZENvbmRpdG9ucyAmJiB0aGlzLmZpZWxkQ29uZGl0b25zLmxlbmd0aCAmJiB0aGlzLnRleHRDb25kaXRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBfY29uZGl0aW9ucyRbMF0ubGJyYWNrZXQgPSAgdGhpcy5maWVsZENvbmRpdG9uc1swXS5sYnJhY2tldCArICcoJztcclxuICAgICAgICAgICAgX2NvbmRpdGlvbnMkW19jb25kaXRpb25zJC5sZW5ndGggLSAxXS5yZWxhdGlvbiA9IDE7XHJcbiAgICAgICAgICAgIF9jb25kaXRpb25zJFtfY29uZGl0aW9ucyQubGVuZ3RoIC0gMV0ucmJyYWNrZXQgPSAgX2NvbmRpdGlvbnMkW19jb25kaXRpb25zJC5sZW5ndGggLSAxXS5yYnJhY2tldCArICcpJztcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgX2NvbmRpdGlvbnMgPSBfY29uZGl0aW9ucyQuY29uY2F0KHRoaXMudGV4dENvbmRpdGlvbnMpO1xyXG4gICAgICAgIHRoaXMuY29uZGl0aW9uc0NoYW5nZS5lbWl0KF9jb25kaXRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBvbkNsZWFyQ29uZGl0aW9ucygkZXZlbnQ6IE1vdXNlRXZlbnQpIHtcclxuICAgICAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgdGhpcy50ZXh0Q29uZGl0aW9ucyA9IFtdO1xyXG4gICAgICAgIHRoaXMuZmllbGRDb25kaXRvbnMgPSBbXTtcclxuXHJcblxyXG4gICAgICAgIGlmICh0aGlzLnNlYXJjaGJveFJlZikge1xyXG4gICAgICAgICAgICB0aGlzLnNlYXJjaGJveFJlZi5jbGVhckNvbmRpdGlvbnMoZmFsc2UpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuc2VhcmNoZmllbGRzUmVmKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyRmllbGRzLmZvckVhY2gobiA9PiB7XHJcbiAgICAgICAgICAgICAgICBuLnZhbHVlID0gbnVsbDtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXMuc2VhcmNoZmllbGRzUmVmLmNsZWFyQ29uZGl0aW9ucyhmYWxzZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmNkLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICB0aGlzLmNvbmRpdGlvbnNDaGFuZ2UuZW1pdChbXSk7XHJcbiAgICB9XHJcblxyXG4gICAgb25Fc2MoJGV2ZW50KSB7XHJcbiAgICAgICAgdGhpcy5sb29rSW5zLmNsb3NlTG9hZGluZygpO1xyXG4gICAgICAgIHRoaXMubG9va0lucy5jbG9zZURpYWxvZygpO1xyXG4gICAgfVxyXG59Il19