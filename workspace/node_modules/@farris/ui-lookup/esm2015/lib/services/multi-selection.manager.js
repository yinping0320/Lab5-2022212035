/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { FavoriteIcon, FAVORITE_FIELD_NAME } from '../lookup-displaytype';
import { cloneDeep } from 'lodash-es';
export class MultiSelectionManager {
    /**
     * @param {?} ins
     */
    constructor(ins) {
        this.ins = ins;
    }
    /**
     * @param {?} e
     * @return {?}
     */
    onSelectedTableCellClick(e) {
        if (e.col.field === FAVORITE_FIELD_NAME) {
            e.event.stopPropagation();
            /** @type {?} */
            const classList = e.event.target['classList'];
            if (classList.contains('f-lookup-unfavorite') || classList.contains('f-icon-minus-circle')) {
                /** @type {?} */
                const rid = e.row[this.ins.idField];
                this.ins.lookupSelectionSer.unSelect(rid);
                // 取消选中 主列表 收藏列表 中的数据
                if (this.ins.isTree()) {
                    /** @type {?} */
                    const tt = (/** @type {?} */ (this.ins.lookupCmpMgr.getComponentInstance('treetable')));
                    tt.unCheckedNode(rid);
                    tt.unSelectNode(rid);
                    if (this.ins.useFavorite) {
                        /** @type {?} */
                        const _tt = (/** @type {?} */ (this.ins.lookupCmpMgr.getComponentInstance('fav')));
                        if (_tt && _tt.data && _tt.data.length && _tt.findRowNode(rid)) {
                            _tt.unCheckedNode(rid);
                            _tt.unSelectNode(rid);
                        }
                    }
                }
                else {
                    /** @type {?} */
                    const dt = (/** @type {?} */ (this.ins.lookupCmpMgr.getComponentInstance()));
                    dt.unCheckRow(rid);
                    if (this.ins.useFavorite) {
                        /** @type {?} */
                        const _dt = (/** @type {?} */ (this.ins.lookupCmpMgr.getComponentInstance('fav')));
                        if (_dt && _dt.data && _dt.data.length) {
                            _dt.unCheckRow(rid);
                        }
                    }
                }
            }
        }
    }
    /**
     * 初始化已选数据列信息
     * @return {?}
     */
    initSelectedColumns() {
        /** @type {?} */
        let selectedColumns = [];
        if (this.ins.showSelected && !this.ins.singleSelect) {
            selectedColumns = cloneDeep(this.ins.gridOptions.columns);
            /** @type {?} */
            const favcol = selectedColumns.find((/**
             * @param {?} n
             * @return {?}
             */
            n => n.field === FAVORITE_FIELD_NAME));
            if (favcol) {
                favcol.formatter = (/**
                 * @return {?}
                 */
                () => {
                    return FavoriteIcon.remove;
                });
            }
            else {
                selectedColumns = selectedColumns.concat([
                    { field: FAVORITE_FIELD_NAME, width: 80, formatter: (/**
                         * @return {?}
                         */
                        () => {
                            return FavoriteIcon.remove;
                        })
                    }
                ]);
            }
            this.ins.initColumnWidth(selectedColumns, 'sel');
        }
        return selectedColumns;
    }
    /**
     * @param {?} data
     * @return {?}
     */
    updateSelections(data) {
        if (Array.isArray(data)) {
            this.ins.lookupSelectionSer.updateSelections(data, true);
        }
        else {
            this.ins.lookupSelectionSer.select(data);
        }
    }
    /**
     * @param {?} id
     * @return {?}
     */
    remove(id) {
        if (id) {
            this.ins.lookupSelectionSer.unSelect(id);
        }
    }
    /**
     * @param {?} data
     * @return {?}
     */
    deleteSelectedItems(data) {
        if (!data || !data.length) {
            return;
        }
        this.ins.lookupSelectionSer.updateSelections(data, false);
        if (!this.ins.isShow) {
            return;
        }
        /** @type {?} */
        const ids = data.map((/**
         * @param {?} n
         * @return {?}
         */
        n => n[this.ins.idField]));
        if (this.ins.isTree()) {
            /** @type {?} */
            const tt = (/** @type {?} */ (this.ins.lookupCmpMgr.getComponentInstance('treetable')));
            tt && tt.unCheckedAndSelected(ids);
            if (this.ins.useFavorite) {
                /** @type {?} */
                const _tt = (/** @type {?} */ (this.ins.lookupCmpMgr.getComponentInstance('fav')));
                _tt && _tt.unCheckedNodes(ids, true, false);
            }
        }
        else {
            /** @type {?} */
            const dt = (/** @type {?} */ (this.ins.lookupCmpMgr.getComponentInstance()));
            dt && dt.unCheckRows(ids);
            if (this.ins.useFavorite) {
                /** @type {?} */
                const _dt = (/** @type {?} */ (this.ins.lookupCmpMgr.getComponentInstance('fav')));
                _dt && _dt.unCheckRows(ids);
            }
        }
    }
    /**
     * @return {?}
     */
    clear() {
        this.ins.lookupSelectionSer.clearSelections();
        if (!this.ins.isShow) {
            return;
        }
        if (this.ins.isTree()) {
            /** @type {?} */
            const tt = (/** @type {?} */ (this.ins.lookupCmpMgr.getComponentInstance('treetable')));
            tt && tt.clearAll();
            if (this.ins.useFavorite) {
                /** @type {?} */
                const _tt = (/** @type {?} */ (this.ins.lookupCmpMgr.getComponentInstance('fav')));
                _tt && _tt.clearAll();
            }
        }
        else {
            /** @type {?} */
            const dt = (/** @type {?} */ (this.ins.lookupCmpMgr.getComponentInstance()));
            dt && dt.clearSelections();
            if (this.ins.useFavorite) {
                /** @type {?} */
                const _dt = (/** @type {?} */ (this.ins.lookupCmpMgr.getComponentInstance('fav')));
                _dt && _dt.clearSelections();
            }
        }
    }
    /**
     * @param {?} rows
     * @return {?}
     */
    save(rows) {
        if (this.ins.showSelected) {
            this.ins.personalConf.selections = rows;
            this.ins.personalConfigService.savePersonalConfig(this.ins.personalConf);
        }
    }
    /**
     * @return {?}
     */
    loadData() {
        /** @type {?} */
        let items = this.ins.personalConf ? (this.ins.personalConf.selections || []) : [];
        if (!items.length) {
            items = this.ins.lookupSelectionSer.getSelections();
        }
        this.ins.lookupSelectionSer.loadSelections(items);
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    MultiSelectionManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXVsdGktc2VsZWN0aW9uLm1hbmFnZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9tdWx0aS1zZWxlY3Rpb24ubWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQ0EsT0FBTyxFQUFFLFlBQVksRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRTFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFHdEMsTUFBTSxPQUFPLHFCQUFxQjs7OztJQUM5QixZQUFvQixHQUF3QjtRQUF4QixRQUFHLEdBQUgsR0FBRyxDQUFxQjtJQUFHLENBQUM7Ozs7O0lBRWhELHdCQUF3QixDQUFDLENBQU07UUFDM0IsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssS0FBSyxtQkFBbUIsRUFBRTtZQUNyQyxDQUFDLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDOztrQkFDcEIsU0FBUyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQztZQUM3QyxJQUFJLFNBQVMsQ0FBQyxRQUFRLENBQUMscUJBQXFCLENBQUMsSUFBSSxTQUFTLENBQUMsUUFBUSxDQUFDLHFCQUFxQixDQUFDLEVBQUU7O3NCQUNsRixHQUFHLEdBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQztnQkFDcEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzFDLHFCQUFxQjtnQkFDckIsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxFQUFFOzswQkFDYixFQUFFLEdBQUcsbUJBQUEsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsb0JBQW9CLENBQUMsV0FBVyxDQUFDLEVBQXNCO29CQUN4RixFQUFFLENBQUMs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RixHQUFHLElBQUUsR0FBRyxDQUFDLGVBQWUsRUFBRSxDQUFDO2FBQzlCO1NBQ0o7SUFDTCxDQUFDOzs7OztJQUVELElBQUksQ0FBQyxJQUFTO1FBQ1YsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRTtZQUN2QixJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1lBQ3hDLElBQUksQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztTQUM1RTtJQUNMLENBQUM7Ozs7SUFFRCxRQUFROztZQUNBLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxVQUFVLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDakYsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUU7WUFDZixLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUN2RDtRQUNELElBQUksQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3RELENBQUM7Q0FDSjs7Ozs7O0lBMUllLG9DQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRyZWVUYWJsZUNvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktdHJlZXRhYmxlJztcclxuaW1wb3J0IHsgRmF2b3JpdGVJY29uLCBGQVZPUklURV9GSUVMRF9OQU1FIH0gZnJvbSAnLi4vbG9va3VwLWRpc3BsYXl0eXBlJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IERhdGFUYWJsZUNvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YXRhYmxlJztcclxuXHJcbmV4cG9ydCBjbGFzcyBNdWx0aVNlbGVjdGlvbk1hbmFnZXIge1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbnM6IExvb2t1cEdyaWRDb21wb25lbnQpIHt9XHJcblxyXG4gICAgb25TZWxlY3RlZFRhYmxlQ2VsbENsaWNrKGU6IGFueSkge1xyXG4gICAgICAgIGlmIChlLmNvbC5maWVsZCA9PT0gRkFWT1JJVEVfRklFTERfTkFNRSkge1xyXG4gICAgICAgICAgICBlLmV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICBjb25zdCBjbGFzc0xpc3QgPSBlLmV2ZW50LnRhcmdldFsnY2xhc3NMaXN0J107XHJcbiAgICAgICAgICAgIGlmIChjbGFzc0xpc3QuY29udGFpbnMoJ2YtbG9va3VwLXVuZmF2b3JpdGUnKSB8fCBjbGFzc0xpc3QuY29udGFpbnMoJ2YtaWNvbi1taW51cy1jaXJjbGUnKSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmlkID0gIGUucm93W3RoaXMuaW5zLmlkRmllbGRdO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMubG9va3VwU2VsZWN0aW9uU2VyLnVuU2VsZWN0KHJpZCk7XHJcbiAgICAgICAgICAgICAgICAvLyDlj5bmtojpgInkuK0g5Li75YiX6KGoIOaUtuiXj+WIl+ihqCDkuK3nmoTmlbDmja5cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmlucy5pc1RyZWUoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHR0ID0gdGhpcy5pbnMubG9va3VwQ21wTWdyLmdldENvbXBvbmVudEluc3RhbmNlKCd0cmVldGFibGUnKSBhcyBUcmVlVGFibGVDb21wb25lbnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgdHQudW5DaGVja2VkTm9kZShyaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHR0LnVuU2VsZWN0Tm9kZShyaWQpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnMudXNlRmF2b3JpdGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgX3R0ID0gdGhpcy5pbnMubG9va3VwQ21wTWdyLmdldENvbXBvbmVudEluc3RhbmNlKCdmYXYnKSBhcyBUcmVlVGFibGVDb21wb25lbnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdHQgJiYgX3R0LmRhdGEgJiYgX3R0LmRhdGEubGVuZ3RoICYmIF90dC5maW5kUm93Tm9kZShyaWQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdHQudW5DaGVja2VkTm9kZShyaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX3R0LnVuU2VsZWN0Tm9kZShyaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkdCA9IHRoaXMuaW5zLmxvb2t1cENtcE1nci5nZXRDb21wb25lbnRJbnN0YW5jZSgpIGFzIERhdGFUYWJsZUNvbXBvbmVudDtcclxuICAgICAgICAgICAgICAgICAgICBkdC51bkNoZWNrUm93KHJpZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zLnVzZUZhdm9yaXRlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IF9kdCA9IHRoaXMuaW5zLmxvb2t1cENtcE1nci5nZXRDb21wb25lbnRJbnN0YW5jZSgnZmF2JykgYXMgRGF0YVRhYmxlQ29tcG9uZW50O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2R0ICYmIF9kdC5kYXRhICYmIF9kdC5kYXRhLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX2R0LnVuQ2hlY2tSb3cocmlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKiog5Yid5aeL5YyW5bey6YCJ5pWw5o2u5YiX5L+h5oGvICovXHJcbiAgICBpbml0U2VsZWN0ZWRDb2x1bW5zKCkge1xyXG4gICAgICAgIGxldCBzZWxlY3RlZENvbHVtbnMgPSBbXTtcclxuICAgICAgICBpZiAodGhpcy5pbnMuc2hvd1NlbGVjdGVkICYmICF0aGlzLmlucy5zaW5nbGVTZWxlY3QpIHtcclxuICAgICAgICAgICAgc2VsZWN0ZWRDb2x1bW5zID0gY2xvbmVEZWVwKHRoaXMuaW5zLmdyaWRPcHRpb25zLmNvbHVtbnMpO1xyXG4gICAgICAgICAgICBjb25zdCBmYXZjb2wgPSBzZWxlY3RlZENvbHVtbnMuZmluZChuID0+IG4uZmllbGQgPT09IEZBVk9SSVRFX0ZJRUxEX05BTUUpO1xyXG4gICAgICAgICAgICBpZiAoZmF2Y29sKSB7XHJcbiAgICAgICAgICAgICAgICBmYXZjb2wuZm9ybWF0dGVyID0gKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBGYXZvcml0ZUljb24ucmVtb3ZlO1xyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNlbGVjdGVkQ29sdW1ucyA9IHNlbGVjdGVkQ29sdW1ucy5jb25jYXQoW1xyXG4gICAgICAgICAgICAgICAgICAgIHsgZmllbGQ6IEZBVk9SSVRFX0ZJRUxEX05BTUUsIHdpZHRoOiA4MCwgZm9ybWF0dGVyOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmF2b3JpdGVJY29uLnJlbW92ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIF0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmluaXRDb2x1bW5XaWR0aChzZWxlY3RlZENvbHVtbnMsICdzZWwnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBzZWxlY3RlZENvbHVtbnM7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlU2VsZWN0aW9ucyhkYXRhKSB7XHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMubG9va3VwU2VsZWN0aW9uU2VyLnVwZGF0ZVNlbGVjdGlvbnMoZGF0YSwgdHJ1ZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMubG9va3VwU2VsZWN0aW9uU2VyLnNlbGVjdChkYXRhKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlKGlkOiBhbnkpIHtcclxuICAgICAgICBpZiAoaWQpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMubG9va3VwU2VsZWN0aW9uU2VyLnVuU2VsZWN0KGlkKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZGVsZXRlU2VsZWN0ZWRJdGVtcyhkYXRhOiBhbnkpIHtcclxuICAgICAgICBpZiAoIWRhdGEgfHwgIWRhdGEubGVuZ3RoKSB7cmV0dXJuO31cclxuICAgICAgICB0aGlzLmlucy5sb29rdXBTZWxlY3Rpb25TZXIudXBkYXRlU2VsZWN0aW9ucyhkYXRhLCBmYWxzZSk7XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5pbnMuaXNTaG93KSB7cmV0dXJuO31cclxuICAgICAgICBjb25zdCBpZHMgPSBkYXRhLm1hcChuID0+IG5bdGhpcy5pbnMuaWRGaWVsZF0pO1xyXG4gICAgICAgIGlmICh0aGlzLmlucy5pc1RyZWUoKSkge1xyXG4gICAgICAgICAgICBjb25zdCB0dCA9IHRoaXMuaW5zLmxvb2t1cENtcE1nci5nZXRDb21wb25lbnRJbnN0YW5jZSgndHJlZXRhYmxlJykgYXMgVHJlZVRhYmxlQ29tcG9uZW50O1xyXG4gICAgICAgICAgICB0dCYmIHR0LnVuQ2hlY2tlZEFuZFNlbGVjdGVkKGlkcyk7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5pbnMudXNlRmF2b3JpdGUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IF90dCA9IHRoaXMuaW5zLmxvb2t1cENtcE1nci5nZXRDb21wb25lbnRJbnN0YW5jZSgnZmF2JykgYXMgVHJlZVRhYmxlQ29tcG9uZW50O1xyXG4gICAgICAgICAgICAgICAgX3R0ICYmIF90dC51bkNoZWNrZWROb2RlcyhpZHMsIHRydWUsIGZhbHNlKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBkdCA9IHRoaXMuaW5zLmxvb2t1cENtcE1nci5nZXRDb21wb25lbnRJbnN0YW5jZSgpIGFzIERhdGFUYWJsZUNvbXBvbmVudDtcclxuICAgICAgICAgICAgZHQgJiYgZHQudW5DaGVja1Jvd3MoaWRzKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLnVzZUZhdm9yaXRlKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBfZHQgPSB0aGlzLmlucy5sb29rdXBDbXBNZ3IuZ2V0Q29tcG9uZW50SW5zdGFuY2UoJ2ZhdicpIGFzIERhdGFUYWJsZUNvbXBvbmVudDtcclxuICAgICAgICAgICAgICAgIF9kdCAmJiBfZHQudW5DaGVja1Jvd3MoaWRzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgY2xlYXIoKSB7XHJcbiAgICAgICAgdGhpcy5pbnMubG9va3VwU2VsZWN0aW9uU2VyLmNsZWFyU2VsZWN0aW9ucygpO1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMuaW5zLmlzU2hvdykge3JldHVybjt9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5pc1RyZWUoKSkge1xyXG4gICAgICAgICAgICBjb25zdCB0dCA9IHRoaXMuaW5zLmxvb2t1cENtcE1nci5nZXRDb21wb25lbnRJbnN0YW5jZSgndHJlZXRhYmxlJykgYXMgVHJlZVRhYmxlQ29tcG9uZW50O1xyXG4gICAgICAgICAgICB0dCYmdHQuY2xlYXJBbGwoKTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy51c2VGYXZvcml0ZSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgX3R0ID0gdGhpcy5pbnMubG9va3VwQ21wTWdyLmdldENvbXBvbmVudEluc3RhbmNlKCdmYXYnKSBhcyBUcmVlVGFibGVDb21wb25lbnQ7XHJcbiAgICAgICAgICAgICAgICBfdHQmJl90dC5jbGVhckFsbCgpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGR0ID0gdGhpcy5pbnMubG9va3VwQ21wTWdyLmdldENvbXBvbmVudEluc3RhbmNlKCkgYXMgRGF0YVRhYmxlQ29tcG9uZW50O1xyXG4gICAgICAgICAgICBkdCYmZHQuY2xlYXJTZWxlY3Rpb25zKCk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy51c2VGYXZvcml0ZSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgX2R0ID0gdGhpcy5pbnMubG9va3VwQ21wTWdyLmdldENvbXBvbmVudEluc3RhbmNlKCdmYXYnKSBhcyBEYXRhVGFibGVDb21wb25lbnQ7XHJcbiAgICAgICAgICAgICAgICBfZHQmJl9kdC5jbGVhclNlbGVjdGlvbnMoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzYXZlKHJvd3M6IGFueSkge1xyXG4gICAgICAgIGlmICh0aGlzLmlucy5zaG93U2VsZWN0ZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMucGVyc29uYWxDb25mLnNlbGVjdGlvbnMgPSByb3dzO1xyXG4gICAgICAgICAgICB0aGlzLmlucy5wZXJzb25hbENvbmZpZ1NlcnZpY2Uuc2F2ZVBlcnNvbmFsQ29uZmlnKHRoaXMuaW5zLnBlcnNvbmFsQ29uZik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGxvYWREYXRhKCkge1xyXG4gICAgICAgIGxldCBpdGVtcyA9IHRoaXMuaW5zLnBlcnNvbmFsQ29uZiA/ICh0aGlzLmlucy5wZXJzb25hbENvbmYuc2VsZWN0aW9ucyB8fCBbXSkgOiBbXTtcclxuICAgICAgICBpZiAoIWl0ZW1zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBpdGVtcyA9IHRoaXMuaW5zLmxvb2t1cFNlbGVjdGlvblNlci5nZXRTZWxlY3Rpb25zKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaW5zLmxvb2t1cFNlbGVjdGlvblNlci5sb2FkU2VsZWN0aW9ucyhpdGVtcyk7XHJcbiAgICB9XHJcbn1cclxuIl19