/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
export class SelectionManager {
    /**
     * @param {?} ins
     */
    constructor(ins) {
        this.ins = ins;
    }
    /**
     * @return {?}
     */
    destroy() {
    }
    /**
     * @return {?}
     */
    getBindingData() {
        /** @type {?} */
        let jsonData = this.ins.bindingData;
        if (this.ins.ngControl &&
            this.ins.ngControl.formDirective &&
            this.ins.ngControl.formDirective.form &&
            this.ins.ngControl.formDirective.form.bindingData) {
            /** @type {?} */
            const bindingData = this.ins.ngControl.formDirective.form.bindingData;
            jsonData = bindingData;
            if (bindingData.getObject) {
                jsonData = bindingData.getObject().toJSON();
            }
        }
        return jsonData;
    }
    /**
     * @return {?}
     */
    initDisplayValue() {
        /** @type {?} */
        const jsonData = this.getBindingData();
        if (jsonData && this.ins.mapFields) {
            /** @type {?} */
            const idField = this.ins.idField;
            /** @type {?} */
            let targetField = this.ins.mapFields[idField];
            if (targetField) {
                if (targetField.indexOf(',') > -1) {
                    targetField = targetField.split(',')[0];
                }
                /** @type {?} */
                const val = this.ins.utils.getValue(targetField, jsonData);
                if (val) {
                    this.ins.displayValue = val;
                }
            }
        }
    }
    /**
     * @private
     * @return {?}
     */
    _clearSelections() {
        const { cmpRefInstance: t } = this.getDataCmpInstance();
        if (t) {
            if (this.ins.isTree()) {
                // 树表
                t.clearAll(false);
                if (!t.cdRef.destroyed) {
                    t.cdRef.detectChanges();
                }
            }
            else {
                // 列表
                t.dtBody.selectedRowIndex = -1;
                t.dtBody.selections = undefined;
                if (!t.cd.destroyed) {
                    t.cd.detectChanges();
                }
            }
        }
    }
    /**
     * 帮助窗口打开后，根据 displayValue 选中数据
     * @param {?=} selectedIds
     * @return {?}
     */
    selectCurrentValue(selectedIds = []) {
        if (!this.ins.enableToSelect) {
            return;
        }
        const { cmpRefInstance: t, items } = this.getDataCmpInstance();
        if (!t || !items || !items.length) {
            return;
        }
        this._clearSelections();
        if (!selectedIds || !selectedIds.length) {
            /** @type {?} */
            const selectedRows = this.ins.lookupSelectionSer.getSelections();
            if (selectedRows.length) {
                selectedIds = selectedRows.map((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n[this.ins.idField]));
            }
        }
        // const _ids = this.getSelectedIds();
        // selectedIds = selectedIds.concat(_ids);
        // selectedIds = Array.from(new Set(selectedIds));
        if (selectedIds && selectedIds.length) {
            if (this.ins.isTree()) {
                // 树表
                this.selected4Treetable(t, selectedIds);
                if (!t.cdRef.destroyed) {
                    t.cdRef.detectChanges();
                }
            }
            else {
                // 列表
                this.selected4Datatable(t, items, selectedIds);
                if (!t.cd.destroyed) {
                    t.cd.detectChanges();
                }
            }
        }
    }
    /**
     * @private
     * @return {?}
     */
    getDataCmpInstance() {
        /** @type {?} */
        let ref = null;
        /** @type {?} */
        let items = null;
        if (this.ins.activeTab === 'datalist') {
            if (this.ins.isTree()) {
                ref = this.ins.lookupCmpMgr.getComponentInstance('treetable');
                items = ((/** @type {?} */ (ref))).serializedValue;
            }
            else {
                items = this.ins.items;
                ref = this.ins.lookupCmpMgr.getComponentInstance();
            }
        }
        else if (this.ins.activeTab === 'favorite') {
            ref = this.ins.lookupCmpMgr.getComponentInstance('fav');
            items = this.ins.favoriteItems;
        }
        return { cmpRefInstance: ref, items };
    }
    /**
     * @private
     * @param {?} t
     * @param {?} items
     * @param {?} values
     * @return {?}
     */
    selected4Datatable(t, items, values) {
        if (this.ins.singleSelect) {
            items.forEach((/**
             * @param {?} item
             * @param {?} index
             * @return {?}
             */
            (item, index) => {
                if (item[this.ins.idField] === values[0]) {
                    if (!t.dtBody.isSelected(item)) {
                        t.dtBody.selectedRowIndex = -1;
                        t.dtBody.selectedRow('', index, item);
                    }
                }
            }));
        }
        else {
            // const values = this.getSelectedIds();
            values.forEach((/**
             * @param {?} id
             * @return {?}
             */
            id => {
                /** @type {?} */
                const r = items.find((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n[this.ins.idField] == id));
                if (r) {
                    t.checkRow(id);
                }
            }));
        }
    }
    /**
     * @private
     * @param {?} t
     * @param {?} valueArr
     * @return {?}
     */
    selected4Treetable(t, valueArr) {
        if (this.ins.singleSelect) {
            t.selectNode(valueArr[0], false, false);
        }
        else {
            // const valueArr = this.getSelectedIds();
            t.checkedNodes(valueArr, false, false, true);
            t.selectNodes(valueArr);
        }
    }
    /**
     * @return {?}
     */
    getSelectedIds() {
        /** @type {?} */
        let values = [];
        /** @type {?} */
        const s = this.ins.multipleChoiceSeparator;
        if (!this.ins.singleSelect && this.ins.displayValue && ('' + this.ins.displayValue).indexOf(s) > -1) {
            values = this.ins.displayValue.split(s);
        }
        else {
            if (this.ins.displayValue !== null && this.ins.displayValue !== '' && this.ins.displayValue !== undefined) {
                values = [this.ins.displayValue];
            }
        }
        // // 启用显示多选列表
        // if (this.ins.showSelected) {
        //     const rows = this.ins.lookupSelectionSer.getSelections();
        //     if (rows && rows.length) {
        //         values = rows.map(n => n[this.ins.idField]);
        //     }
        // }
        return values;
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    SelectionManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0aW9uLW1hbmFnZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9zZWxlY3Rpb24tbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBSUEsTUFBTSxPQUFPLGdCQUFnQjs7OztJQUN6QixZQUFvQixHQUF3QjtRQUF4QixRQUFHLEdBQUgsR0FBRyxDQUFxQjtJQUU1QyxDQUFDOzs7O0lBRUQsT0FBTztJQUNQLENBQUM7Ozs7SUFFRCxjQUFjOztZQUNOLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVc7UUFDbkMsSUFDSSxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVM7WUFDbEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsYUFBYTtZQUNoQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsSUFBSTtZQUNyQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFDbkQ7O2tCQUNRLFdBQVcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFdBQVc7WUFDckUsUUFBUSxHQUFHLFdBQVcsQ0FBQztZQUV2QixJQUFJLFdBQVcsQ0FBQyxTQUFTLEVBQUU7Z0JBQ3ZCLFFBQVEsR0FBRyxXQUFXLENBQUMsU0FBUyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUM7YUFDL0M7U0FDSjtRQUNELE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7Ozs7SUFFRCxnQkFBZ0I7O2NBQ04sUUFBUSxHQUFHLElBQUksQ0FBQyxjQUFjLEVBQUU7UUFDdEMsSUFBSSxRQUFRLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUU7O2tCQUMxQixPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPOztnQkFDNUIsV0FBVyxHQUFH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QUFRLENBQUMsQ0FBQztTQUMzQjtJQUNMLENBQUM7Ozs7SUFFRCxjQUFjOztZQUNOLE1BQU0sR0FBRyxFQUFFOztjQUNULENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLHVCQUF1QjtRQUMxQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7WUFDakcsTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUMzQzthQUFNO1lBQ0gsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksS0FBSyxJQUFJLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEtBQUssRUFBRSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxLQUFLLFNBQVMsRUFBRTtnQkFDdkcsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUNwQztTQUNKO1FBRUQsY0FBYztRQUNkLCtCQUErQjtRQUMvQixnRUFBZ0U7UUFDaEUsaUNBQWlDO1FBQ2pDLHVEQUF1RDtRQUN2RCxRQUFRO1FBQ1IsSUFBSTtRQUVKLE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7Q0FDSjs7Ozs7O0lBbkxlLCtCQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRyZWVUYWJsZUNvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktdHJlZXRhYmxlJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLmNvbXBvbmVudCc7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIFNlbGVjdGlvbk1hbmFnZXIge1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbnM6IExvb2t1cEdyaWRDb21wb25lbnQpIHtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgZGVzdHJveSgpIHtcclxuICAgIH1cclxuXHJcbiAgICBnZXRCaW5kaW5nRGF0YSgpIHtcclxuICAgICAgICBsZXQganNvbkRhdGEgPSB0aGlzLmlucy5iaW5kaW5nRGF0YTtcclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICAgIHRoaXMuaW5zLm5nQ29udHJvbCAmJlxyXG4gICAgICAgICAgICB0aGlzLmlucy5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZSAmJlxyXG4gICAgICAgICAgICB0aGlzLmlucy5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtICYmXHJcbiAgICAgICAgICAgIHRoaXMuaW5zLm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0uYmluZGluZ0RhdGFcclxuICAgICAgICApIHtcclxuICAgICAgICAgICAgY29uc3QgYmluZGluZ0RhdGEgPSB0aGlzLmlucy5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtLmJpbmRpbmdEYXRhO1xyXG4gICAgICAgICAgICBqc29uRGF0YSA9IGJpbmRpbmdEYXRhO1xyXG5cclxuICAgICAgICAgICAgaWYgKGJpbmRpbmdEYXRhLmdldE9iamVjdCkge1xyXG4gICAgICAgICAgICAgICAganNvbkRhdGEgPSBiaW5kaW5nRGF0YS5nZXRPYmplY3QoKS50b0pTT04oKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4ganNvbkRhdGE7XHJcbiAgICB9XHJcblxyXG4gICAgaW5pdERpc3BsYXlWYWx1ZSgpIHtcclxuICAgICAgICBjb25zdCBqc29uRGF0YSA9IHRoaXMuZ2V0QmluZGluZ0RhdGEoKTtcclxuICAgICAgICBpZiAoanNvbkRhdGEgJiYgdGhpcy5pbnMubWFwRmllbGRzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGlkRmllbGQgPSB0aGlzLmlucy5pZEZpZWxkO1xyXG4gICAgICAgICAgICBsZXQgdGFyZ2V0RmllbGQgPSB0aGlzLmlucy5tYXBGaWVsZHNbaWRGaWVsZF07XHJcblxyXG4gICAgICAgICAgICBpZiAodGFyZ2V0RmllbGQpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0YXJnZXRGaWVsZC5pbmRleE9mKCcsJykgPiAtMSApIHtcclxuICAgICAgICAgICAgICAgICAgICB0YXJnZXRGaWVsZCA9IHRhcmdldEZpZWxkLnNwbGl0KCcsJylbMF07XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgdmFsID0gdGhpcy5pbnMudXRpbHMuZ2V0VmFsdWUodGFyZ2V0RmllbGQsIGpzb25EYXRhKTtcclxuICAgICAgICAgICAgICAgIGlmICh2YWwpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5kaXNwbGF5VmFsdWUgPSB2YWw7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfY2xlYXJTZWxlY3Rpb25zKCkge1xyXG4gICAgICAgIGNvbnN0IHsgY21wUmVmSW5zdGFuY2U6IHQgfSA9IHRoaXMuZ2V0RGF0YUNtcEluc3RhbmNlKCk7XHJcbiAgICAgICAgaWYgKHQpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmlzVHJlZSgpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyDmoJHooahcclxuICAgICAgICAgICAgICAgIHQuY2xlYXJBbGwoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0LmNkUmVmLmRlc3Ryb3llZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHQuY2RSZWYuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8g5YiX6KGoXHJcbiAgICAgICAgICAgICAgICB0LmR0Qm9keS5zZWxlY3RlZFJvd0luZGV4ID0gLTE7XHJcbiAgICAgICAgICAgICAgICB0LmR0Qm9keS5zZWxlY3Rpb25zID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0LmNkLmRlc3Ryb3llZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHQuY2QuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5biu5Yqp56qX5Y+j5omT5byA5ZCO77yM5qC55o2uIGRpc3BsYXlWYWx1ZSDpgInkuK3mlbDmja5cclxuICAgICAqL1xyXG4gICAgc2VsZWN0Q3VycmVudFZhbHVlKHNlbGVjdGVkSWRzID0gW10pIHtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLmlucy5lbmFibGVUb1NlbGVjdCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgY29uc3QgeyBjbXBSZWZJbnN0YW5jZTogdCwgaXRlbXMgfSA9IHRoaXMuZ2V0RGF0YUNtcEluc3RhbmNlKCk7XHJcbiAgICAgICAgaWYgKCF0IHx8ICFpdGVtcyB8fCAhaXRlbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2NsZWFyU2VsZWN0aW9ucygpO1xyXG5cclxuICAgICAgICBpZiAoIXNlbGVjdGVkSWRzIHx8ICFzZWxlY3RlZElkcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRSb3dzID0gdGhpcy5pbnMubG9va3VwU2VsZWN0aW9uU2VyLmdldFNlbGVjdGlvbnMoKTtcclxuICAgICAgICAgICAgaWYgKHNlbGVjdGVkUm93cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHNlbGVjdGVkSWRzID0gc2VsZWN0ZWRSb3dzLm1hcChuID0+IG5bdGhpcy5pbnMuaWRGaWVsZF0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBjb25zdCBfaWRzID0gdGhpcy5nZXRTZWxlY3RlZElkcygpO1xyXG4gICAgICAgIC8vIHNlbGVjdGVkSWRzID0gc2VsZWN0ZWRJZHMuY29uY2F0KF9pZHMpO1xyXG4gICAgICAgIC8vIHNlbGVjdGVkSWRzID0gQXJyYXkuZnJvbShuZXcgU2V0KHNlbGVjdGVkSWRzKSk7XHJcblxyXG4gICAgICAgIGlmIChzZWxlY3RlZElkcyAmJiBzZWxlY3RlZElkcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmlzVHJlZSgpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyDmoJHooahcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWQ0VHJlZXRhYmxlKHQsIHNlbGVjdGVkSWRzKTtcclxuICAgICAgICAgICAgICAgIGlmICghdC5jZFJlZi5kZXN0cm95ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0LmNkUmVmLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIOWIl+ihqFxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZDREYXRhdGFibGUodCwgaXRlbXMsIHNlbGVjdGVkSWRzKTtcclxuICAgICAgICAgICAgICAgIGlmICghdC5jZC5kZXN0cm95ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0LmNkLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldERhdGFDbXBJbnN0YW5jZSgpIHtcclxuICAgICAgICBsZXQgcmVmID0gbnVsbDtcclxuICAgICAgICBsZXQgaXRlbXMgPSBudWxsO1xyXG4gICAgICAgIGlmICh0aGlzLmlucy5hY3RpdmVUYWIgPT09ICdkYXRhbGlzdCcpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmlzVHJlZSgpKSB7XHJcbiAgICAgICAgICAgICAgICByZWYgPSB0aGlzLmlucy5sb29rdXBDbXBNZ3IuZ2V0Q29tcG9uZW50SW5zdGFuY2UoJ3RyZWV0YWJsZScpO1xyXG4gICAgICAgICAgICAgICAgaXRlbXMgPSAocmVmIGFzIFRyZWVUYWJsZUNvbXBvbmVudCkuc2VyaWFsaXplZFZhbHVlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaXRlbXMgPSB0aGlzLmlucy5pdGVtcztcclxuICAgICAgICAgICAgICAgIHJlZiA9IHRoaXMuaW5zLmxvb2t1cENtcE1nci5nZXRDb21wb25lbnRJbnN0YW5jZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlucy5hY3RpdmVUYWIgPT09ICdmYXZvcml0ZScpIHtcclxuICAgICAgICAgICAgcmVmID0gdGhpcy5pbnMubG9va3VwQ21wTWdyLmdldENvbXBvbmVudEluc3RhbmNlKCdmYXYnKTtcclxuICAgICAgICAgICAgaXRlbXMgPSB0aGlzLmlucy5mYXZvcml0ZUl0ZW1zO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4geyBjbXBSZWZJbnN0YW5jZTogcmVmLCBpdGVtcyB9O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2VsZWN0ZWQ0RGF0YXRhYmxlKHQ6IGFueSwgaXRlbXM6IGFueSwgdmFsdWVzOiBhbnkpIHtcclxuICAgICAgICBpZiAodGhpcy5pbnMuc2luZ2xlU2VsZWN0KSB7XHJcbiAgICAgICAgICAgIGl0ZW1zLmZvckVhY2goKGl0ZW0sIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXRlbVt0aGlzLmlucy5pZEZpZWxkXSA9PT0gdmFsdWVzWzBdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0LmR0Qm9keS5pc1NlbGVjdGVkKGl0ZW0pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHQuZHRCb2R5LnNlbGVjdGVkUm93SW5kZXggPSAtMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdC5kdEJvZHkuc2VsZWN0ZWRSb3coJycsIGluZGV4LCBpdGVtKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIGNvbnN0IHZhbHVlcyA9IHRoaXMuZ2V0U2VsZWN0ZWRJZHMoKTtcclxuICAgICAgICAgICAgdmFsdWVzLmZvckVhY2goaWQgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgciA9IGl0ZW1zLmZpbmQobiA9PiBuW3RoaXMuaW5zLmlkRmllbGRdID09IGlkKTtcclxuICAgICAgICAgICAgICAgIGlmIChyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdC5jaGVja1JvdyhpZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNlbGVjdGVkNFRyZWV0YWJsZSh0OiBhbnksIHZhbHVlQXJyOiBhbnkpIHtcclxuICAgICAgICBpZiAodGhpcy5pbnMuc2luZ2xlU2VsZWN0KSB7XHJcbiAgICAgICAgICAgIHQuc2VsZWN0Tm9kZSh2YWx1ZUFyclswXSwgZmFsc2UsIGZhbHNlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyBjb25zdCB2YWx1ZUFyciA9IHRoaXMuZ2V0U2VsZWN0ZWRJZHMoKTtcclxuICAgICAgICAgICAgdC5jaGVja2VkTm9kZXModmFsdWVBcnIsIGZhbHNlLCBmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIHQuc2VsZWN0Tm9kZXModmFsdWVBcnIpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRTZWxlY3RlZElkcygpIHtcclxuICAgICAgICBsZXQgdmFsdWVzID0gW107XHJcbiAgICAgICAgY29uc3QgcyA9IHRoaXMuaW5zLm11bHRpcGxlQ2hvaWNlU2VwYXJhdG9yOyAvLyDlpJrpgInliIbpmpTnrKZcclxuICAgICAgICBpZiAoIXRoaXMuaW5zLnNpbmdsZVNlbGVjdCAmJiB0aGlzLmlucy5kaXNwbGF5VmFsdWUgJiYgKCcnICsgdGhpcy5pbnMuZGlzcGxheVZhbHVlKS5pbmRleE9mKHMpID4gLTEpIHtcclxuICAgICAgICAgICAgdmFsdWVzID0gdGhpcy5pbnMuZGlzcGxheVZhbHVlLnNwbGl0KHMpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5kaXNwbGF5VmFsdWUgIT09IG51bGwgJiYgdGhpcy5pbnMuZGlzcGxheVZhbHVlICE9PSAnJyAmJiB0aGlzLmlucy5kaXNwbGF5VmFsdWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgdmFsdWVzID0gW3RoaXMuaW5zLmRpc3BsYXlWYWx1ZV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIC8vIOWQr+eUqOaYvuekuuWkmumAieWIl+ihqFxyXG4gICAgICAgIC8vIGlmICh0aGlzLmlucy5zaG93U2VsZWN0ZWQpIHtcclxuICAgICAgICAvLyAgICAgY29uc3Qgcm93cyA9IHRoaXMuaW5zLmxvb2t1cFNlbGVjdGlvblNlci5nZXRTZWxlY3Rpb25zKCk7XHJcbiAgICAgICAgLy8gICAgIGlmIChyb3dzICYmIHJvd3MubGVuZ3RoKSB7XHJcbiAgICAgICAgLy8gICAgICAgICB2YWx1ZXMgPSByb3dzLm1hcChuID0+IG5bdGhpcy5pbnMuaWRGaWVsZF0pO1xyXG4gICAgICAgIC8vICAgICB9XHJcbiAgICAgICAgLy8gfVxyXG5cclxuICAgICAgICByZXR1cm4gdmFsdWVzO1xyXG4gICAgfVxyXG59XHJcblxyXG5cclxuXHJcbiJdfQ==