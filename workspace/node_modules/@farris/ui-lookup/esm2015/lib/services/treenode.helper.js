/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
export class TreeNodeHelper {
    /**
     * @param {?} instance
     */
    constructor(instance) {
        this.instance = instance;
        this.flatAllNodes = [];
    }
    /**
     * @param {?} treeNode
     * @return {?}
     */
    getTreeInfo(treeNode) {
        if (treeNode.data[this.treeInfo.dataField]) {
            return treeNode.data[this.treeInfo.dataField];
        }
        /** @type {?} */
        const data = treeNode.data;
        if (data && this.treeInfo.dataField) {
            /** @type {?} */
            const treeInfoDataField = this.treeInfo.dataField.toLowerCase();
            /** @type {?} */
            const dataField = Object.keys(treeNode.data).find((/**
             * @param {?} n
             * @return {?}
             */
            n => {
                return n.toLowerCase() === treeInfoDataField;
            }));
            if (dataField) {
                return data[dataField];
            }
            else {
                this.instance.writeConsole(`未找到树形信息数据字段【${this.treeInfo.dataField}】`, 'error');
            }
        }
        else {
            this.instance.writeConsole(`未找到树形信息数据字段【${this.treeInfo.dataField}】`, 'error');
        }
    }
    /**
     * @param {?} treeNode
     * @return {?}
     */
    getTreeNodeLayer(treeNode) {
        return this.getTreeInfo(treeNode)[this.treeInfo.layerField];
    }
    /**
     * 更新节点的展开状态。 根据组件中 expandLevel 的值决定
     * -1：不展开，0：全部展开，>0 展开到指定级数
     * @param {?} treeNodes
     * @param {?=} treeInfo
     * @return {?}
     */
    updateTreeNodeExpanded(treeNodes, treeInfo = null) {
        if (treeInfo) {
            this.treeInfo = treeInfo;
        }
        else {
            this.treeInfo = this.instance.treeInfo;
        }
        /** @type {?} */
        const expandLevel = this.instance.expandLevel;
        if (expandLevel === -1) {
            return;
        }
        if (!this.flatAllNodes.length) {
            this.flatAllNodes = this.treeData2Flat(null, treeNodes, 0, []);
        }
        treeNodes.forEach((/**
         * @param {?} tn
         * @return {?}
         */
        (tn) => {
            tn.expanded = this.shoudExpand(expandLevel, this.getTreeNodeLayer(tn));
            if (this.isSelectNodeParent(tn)) {
                tn.expanded = true;
            }
            if (tn.children && tn.children.length) {
                this.updateTreeNodeExpanded(tn.children, treeInfo);
            }
            else {
                tn.leaf = true;
            }
        }));
    }
    /**
     * @private
     * @param {?} parent
     * @param {?} nodes
     * @param {?} level
     * @param {?} parentIds
     * @return {?}
     */
    treeData2Flat(parent, nodes, level, parentIds) {
        /** @type {?} */
        const idField = this.instance.idField;
        /** @type {?} */
        let arr = [];
        if (nodes && nodes.length) {
            nodes.forEach((/**
             * @param {?} node
             * @param {?} index
             * @return {?}
             */
            (node, index) => {
                // node.parent = parent;
                // node.parent = parent;
                /** @type {?} */
                let parents = [];
                if (parent) {
                    /** @type {?} */
                    const parentID = parent.data[idField];
                    /** @type {?} */
                    const _parents = parentIds || [];
                    parents = parents.concat(_parents.map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => n)));
                    parents.push(parentID);
                }
                /** @type {?} */
                const rowNode = {
                    id: node.data[idField],
                    node,
                    level,
                    parents,
                };
                arr.push(rowNode);
                arr = arr.concat(this.treeData2Flat(node, node.children, level + 1, parents));
            }));
        }
        return arr;
    }
    /**
     * @private
     * @param {?} expandLevel
     * @param {?} nodeLayer
     * @return {?}
     */
    shoudExpand(expandLevel, nodeLayer) {
        if (expandLevel === -1) {
            // -1 为不展开
            return false;
        }
        else if (expandLevel === 0) {
            // 0 为全部展开
            return true;
        }
        else {
            // 没有启用分层加载，通过展开层级确定是否展开该节点
            return nodeLayer <= expandLevel;
        }
    }
    /**
     * @private
     * @param {?} treeNode
     * @return {?}
     */
    isSelectNodeParent(treeNode) {
        if (this.instance.navSelectedIds) {
            /** @type {?} */
            const allParentIds = this.flatAllNodes.find((/**
             * @param {?} f
             * @return {?}
             */
            f => f.id === this.instance.navSelectedIds)).parents;
            if (allParentIds && allParentIds.length) {
                return allParentIds.includes(treeNode.id);
            }
            return false;
        }
        return false;
    }
    /**
     * @param {?} treeNode
     * @return {?}
     */
    getLeafNode(treeNode) {
        if (treeNode && (!treeNode.children || !treeNode.children.length)) {
            return treeNode;
        }
        else {
            if (treeNode.children.length === 1) {
                return this.getLeafNode(treeNode.children[0]);
            }
            else {
                return treeNode.children;
            }
        }
    }
    /**
     * @param {?} items
     * @param {?=} result
     * @return {?}
     */
    flatTreeNodes(items, result = []) {
        items = items || [];
        return items.reduce((/**
         * @param {?} c
         * @param {?} n
         * @return {?}
         */
        (c, n) => {
            c.push(n);
            if (n.children && n.children.length) {
                this.flatTreeNodes(n.children, c);
            }
            return c;
        }), result);
    }
}
if (false) {
    /** @type {?} */
    TreeNodeHelper.prototype.treeInfo;
    /** @type {?} */
    TreeNodeHelper.prototype.flatAllNodes;
    /**
     * @type {?}
     * @private
     */
    TreeNodeHelper.prototype.instance;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZW5vZGUuaGVscGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvdHJlZW5vZGUuaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFJQSxNQUFNLE9BQU8sY0FBYzs7OztJQUd2QixZQUFvQixRQUE2QjtRQUE3QixhQUFRLEdBQVIsUUFBUSxDQUFxQjtRQURqRCxpQkFBWSxHQUFHLEVBQUUsQ0FBQztJQUNtQyxDQUFDOzs7OztJQUV0RCxXQUFXLENBQUMsUUFBa0I7UUFDMUIsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDeEMsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDakQ7O2NBRUssSUFBSSxHQUFHLFFBQVEsQ0FBQyxJQUFJO1FBQzFCLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFOztrQkFFM0IsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFOztrQkFDekQsU0FBUyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUk7Ozs7WUFBQyxDQUFDLENBQUMsRUFBRTtnQkFDbEQsT0FBTyxDQUFDLENBQUMsV0FBVyxFQUFFLEtBQUssaUJBQWlCLENBQUM7WUFDakQsQ0FBQyxFQUFDO1lBQ0YsSUFBSSxTQUFTLEVBQUU7Z0JBQ1gsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDMUI7aUJBQU07Z0JBQ0gsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsZUFBZSxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO2FBQ2xGO1NBQ0o7YUFBTTtZQUNI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QUssQ0FBQyxFQUFFO2dCQUNoQyxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ2pEO2lCQUFNO2dCQUNILE9BQU8sUUFBUSxDQUFDLFFBQVEsQ0FBQzthQUM1QjtTQUNKO0lBQ0wsQ0FBQzs7Ozs7O0lBRUQsYUFBYSxDQUFDLEtBQUssRUFBRSxNQUFNLEdBQUcsRUFBRTtRQUM1QixLQUFLLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUNwQixPQUFRLEtBQUssQ0FBQyxNQUFNOzs7OztRQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzFCLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDVixJQUFJLENBQUMsQ0FBQyxRQUFRLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUU7Z0JBQ2pDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQzthQUNyQztZQUNELE9BQU8sQ0FBQyxDQUFDO1FBQ2IsQ0FBQyxHQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ2YsQ0FBQztDQUNKOzs7SUFySUcsa0NBQW1COztJQUNuQixzQ0FBa0I7Ozs7O0lBQ04sa0NBQXFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVHJlZU5vZGUgfSBmcm9tICdAZmFycmlzL3VpLXRyZWV0YWJsZSc7XHJcbmltcG9ydCB7IExvb2t1cEdyaWRDb21wb25lbnQgfSBmcm9tICcuLi9sb29rdXAtZ3JpZC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBUcmVlSW5mbyB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLW9wdGlvbnMnO1xyXG5cclxuZXhwb3J0IGNsYXNzIFRyZWVOb2RlSGVscGVyIHtcclxuICAgIHRyZWVJbmZvOiBUcmVlSW5mbztcclxuICAgIGZsYXRBbGxOb2RlcyA9IFtdO1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbnN0YW5jZTogTG9va3VwR3JpZENvbXBvbmVudCkgeyB9XHJcblxyXG4gICAgZ2V0VHJlZUluZm8odHJlZU5vZGU6IFRyZWVOb2RlKSB7XHJcbiAgICAgICAgaWYgKHRyZWVOb2RlLmRhdGFbdGhpcy50cmVlSW5mby5kYXRhRmllbGRdKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cmVlTm9kZS5kYXRhW3RoaXMudHJlZUluZm8uZGF0YUZpZWxkXTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGRhdGEgPSB0cmVlTm9kZS5kYXRhO1xyXG4gICAgICAgIGlmIChkYXRhICYmIHRoaXMudHJlZUluZm8uZGF0YUZpZWxkKSB7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB0cmVlSW5mb0RhdGFGaWVsZCA9IHRoaXMudHJlZUluZm8uZGF0YUZpZWxkLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IE9iamVjdC5rZXlzKHRyZWVOb2RlLmRhdGEpLmZpbmQobiA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbi50b0xvd2VyQ2FzZSgpID09PSB0cmVlSW5mb0RhdGFGaWVsZDtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGlmIChkYXRhRmllbGQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBkYXRhW2RhdGFGaWVsZF07XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmluc3RhbmNlLndyaXRlQ29uc29sZShg5pyq5om+5Yiw5qCR5b2i5L+h5oGv5pWw5o2u5a2X5q6144CQJHt0aGlzLnRyZWVJbmZvLmRhdGFGaWVsZH3jgJFgLCAnZXJyb3InKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zdGFuY2Uud3JpdGVDb25zb2xlKGDmnKrmib7liLDmoJHlvaLkv6Hmga/mlbDmja7lrZfmrrXjgJAke3RoaXMudHJlZUluZm8uZGF0YUZpZWxkfeOAkWAsICdlcnJvcicpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRUcmVlTm9kZUxheWVyKHRyZWVOb2RlOiBUcmVlTm9kZSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldFRyZWVJbmZvKHRyZWVOb2RlKVt0aGlzLnRyZWVJbmZvLmxheWVyRmllbGRdO1xyXG4gICAgfVxyXG4gICAgLyoqIOabtOaWsOiKgueCueeahOWxleW8gOeKtuaAgeOAgiDmoLnmja7nu4Tku7bkuK0gZXhwYW5kTGV2ZWwg55qE5YC85Yaz5a6aXHJcbiAgICAgKiAtMe+8muS4jeWxleW8gO+8jDDvvJrlhajpg6jlsZXlvIDvvIw+MCDlsZXlvIDliLDmjIflrprnuqfmlbBcclxuICAgICAqL1xyXG4gICAgdXBkYXRlVHJlZU5vZGVFeHBhbmRlZCh0cmVlTm9kZXM6IFRyZWVOb2RlW10sIHRyZWVJbmZvOiBUcmVlSW5mbyA9IG51bGwpIHtcclxuICAgICAgICBpZiAodHJlZUluZm8pIHtcclxuICAgICAgICAgICAgdGhpcy50cmVlSW5mbyA9IHRyZWVJbmZvO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMudHJlZUluZm8gPSB0aGlzLmluc3RhbmNlLnRyZWVJbmZvO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBleHBhbmRMZXZlbCA9IHRoaXMuaW5zdGFuY2UuZXhwYW5kTGV2ZWw7XHJcbiAgICAgICAgaWYgKGV4cGFuZExldmVsID09PSAtMSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghdGhpcy5mbGF0QWxsTm9kZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZmxhdEFsbE5vZGVzID0gdGhpcy50cmVlRGF0YTJGbGF0KG51bGwsIHRyZWVOb2RlcywgMCwgW10pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdHJlZU5vZGVzLmZvckVhY2goKHRuOiBUcmVlTm9kZSkgPT4ge1xyXG4gICAgICAgICAgICB0bi5leHBhbmRlZCA9IHRoaXMuc2hvdWRFeHBhbmQoZXhwYW5kTGV2ZWwsIHRoaXMuZ2V0VHJlZU5vZGVMYXllcih0bikpO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pc1NlbGVjdE5vZGVQYXJlbnQodG4pKSB7XHJcbiAgICAgICAgICAgICAgICB0bi5leHBhbmRlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHRuLmNoaWxkcmVuICYmIHRuLmNoaWxkcmVuLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVUcmVlTm9kZUV4cGFuZGVkKHRuLmNoaWxkcmVuLCB0cmVlSW5mbyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0bi5sZWFmID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdHJlZURhdGEyRmxhdChwYXJlbnQsIG5vZGVzLCBsZXZlbCwgcGFyZW50SWRzKSB7XHJcbiAgICAgICAgY29uc3QgaWRGaWVsZCA9IHRoaXMuaW5zdGFuY2UuaWRGaWVsZDtcclxuICAgICAgICBsZXQgYXJyID0gW107XHJcbiAgICAgICAgaWYgKG5vZGVzICYmIG5vZGVzLmxlbmd0aCkge1xyXG5cclxuICAgICAgICAgICAgbm9kZXMuZm9yRWFjaCgobm9kZSwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIG5vZGUucGFyZW50ID0gcGFyZW50O1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBwYXJlbnRzID0gW107XHJcbiAgICAgICAgICAgICAgICBpZiAocGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50SUQgPSBwYXJlbnQuZGF0YVtpZEZpZWxkXTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBfcGFyZW50cyA9IHBhcmVudElkcyB8fCBbXTtcclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnRzID0gcGFyZW50cy5jb25jYXQoX3BhcmVudHMubWFwKG4gPT4gbikpO1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudHMucHVzaChwYXJlbnRJRCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCByb3dOb2RlID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlkOiBub2RlLmRhdGFbaWRGaWVsZF0sXHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZSxcclxuICAgICAgICAgICAgICAgICAgICBsZXZlbCxcclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnRzLFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIGFyci5wdXNoKHJvd05vZGUpO1xyXG4gICAgICAgICAgICAgICAgYXJyID0gYXJyLmNvbmNhdCh0aGlzLnRyZWVEYXRhMkZsYXQobm9kZSwgbm9kZS5jaGlsZHJlbiwgbGV2ZWwgKyAxLCBwYXJlbnRzKSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYXJyO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2hvdWRFeHBhbmQoZXhwYW5kTGV2ZWw6IG51bWJlciwgbm9kZUxheWVyOiBudW1iZXIpIHtcclxuICAgICAgICBpZiAoZXhwYW5kTGV2ZWwgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIC8vIC0xIOS4uuS4jeWxleW8gFxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfSBlbHNlIGlmIChleHBhbmRMZXZlbCA9PT0gMCkge1xyXG4gICAgICAgICAgICAvLyAwIOS4uuWFqOmDqOWxleW8gFxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyDmsqHmnInlkK/nlKjliIblsYLliqDovb3vvIzpgJrov4flsZXlvIDlsYLnuqfnoa7lrprmmK/lkKblsZXlvIDor6XoioLngrlcclxuICAgICAgICAgICAgcmV0dXJuIG5vZGVMYXllciA8PSBleHBhbmRMZXZlbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpc1NlbGVjdE5vZGVQYXJlbnQodHJlZU5vZGUpIHtcclxuICAgICAgICBpZiAodGhpcy5pbnN0YW5jZS5uYXZTZWxlY3RlZElkcykge1xyXG4gICAgICAgICAgICBjb25zdCBhbGxQYXJlbnRJZHM6IHN0cmluZ1tdID0gdGhpcy5mbGF0QWxsTm9kZXMuZmluZChmID0+IGYuaWQgPT09IHRoaXMuaW5zdGFuY2UubmF2U2VsZWN0ZWRJZHMpLnBhcmVudHM7XHJcbiAgICAgICAgICAgIGlmIChhbGxQYXJlbnRJZHMgJiYgYWxsUGFyZW50SWRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFsbFBhcmVudElkcy5pbmNsdWRlcyh0cmVlTm9kZS5pZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0TGVhZk5vZGUodHJlZU5vZGU6IFRyZWVOb2RlKSB7XHJcbiAgICAgICAgaWYgKHRyZWVOb2RlICYmICghdHJlZU5vZGUuY2hpbGRyZW4gfHwgIXRyZWVOb2RlLmNoaWxkcmVuLmxlbmd0aCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRyZWVOb2RlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0cmVlTm9kZS5jaGlsZHJlbi5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldExlYWZOb2RlKHRyZWVOb2RlLmNoaWxkcmVuWzBdKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cmVlTm9kZS5jaGlsZHJlbjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmbGF0VHJlZU5vZGVzKGl0ZW1zLCByZXN1bHQgPSBbXSkge1xyXG4gICAgICAgIGl0ZW1zID0gaXRlbXMgfHwgW107XHJcbiAgICAgICAgcmV0dXJuICBpdGVtcy5yZWR1Y2UoKGMsIG4pID0+IHtcclxuICAgICAgICAgICAgYy5wdXNoKG4pO1xyXG4gICAgICAgICAgICBpZiAobi5jaGlsZHJlbiAmJiBuLmNoaWxkcmVuLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5mbGF0VHJlZU5vZGVzKG4uY2hpbGRyZW4sIGMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBjO1xyXG4gICAgICAgIH0sIHJlc3VsdCk7XHJcbiAgICB9XHJcbn1cclxuIl19