/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { cloneDeep } from 'lodash-es';
import { FavoriteAction, FAVORITE_FIELD_NAME, LookupGridDisplayType } from '../lookup-displaytype';
import { of } from 'rxjs';
import { map, switchMap, tap } from 'rxjs/operators';
// 帮助默认个性化数据
/** @type {?} */
const DefaultUserConfig = {
    tabIndex: 'datalist',
    favorite: null,
    size: null
};
export class LookupHttpManager {
    /**
     * @param {?} ins
     */
    constructor(ins) {
        this.ins = ins;
        // 每次帮助打开后，更新此值，做为个性化数据的初始值；
        // 关闭窗口时，与此进行对比。如果一样，则不保存；
        this._originalPersonalConfig = DefaultUserConfig;
    }
    /**
     * @private
     * @return {?}
     */
    disablePagination() {
        return {
            pageIndex: 1,
            pageSize: 500
        };
    }
    /**
     * 构造查询参数
     * @param {?=} event
     * @param {?=} type
     * @return {?}
     */
    buildQueryParams(event, type = 'all') {
        /** @type {?} */
        const params = {};
        if (event.navConditions && event.navConditions.length) {
            if (event.navConditions && event.navConditions.length === 1 && event.navConditions[0].code == '*') {
                event.search = { field: '*', value: event.navConditions[0].value };
            }
            else {
                params.navSearchConditions = event.navConditions;
            }
        }
        if (this.ins.conditions && this.ins.conditions.length && type !== 'fav') {
            params.searchConditions = cloneDeep(this.ins.conditions);
        }
        /** @type {?} */
        const searchParam = { category: type };
        if (type !== 'fav') {
            if (this.ins.isDoublleList() && this.ins.navigationFilter && type !== 'all') {
                if (this.ins.navigationFilter.idValue && type !== 'textchange') {
                    params.relationFilter = [...this.ins.navigationFilter.idValue];
                }
            }
        }
        if (event) {
            if (type === 'fav' || type === 'selected') {
                event.pageInfo = this.disablePagination();
            }
            if (event.pageInfo) {
                params.pageIndex = event.pageInfo.pageIndex;
                params.pageSize = event.pageInfo.pageSize;
            }
            if (event.search) {
                /** @type {?} */
                let sfield = event.search.field;
                if (sfield && sfield === '*') {
                    sfield = '*';
                }
                if (event.search.value) {
                    event.search.value = event.search.value.trim();
                }
                searchParam.searchField = sfield;
                searchParam.searchValue = event.search.value;
                searchParam.searchType = event.search.type || 'like';
                if (event.search.value === '' && searchParam.category === 'search' && (!params.searchConditions && !params.navSearchConditions)) {
                    searchParam.category = 'all';
                }
            }
            if (event.sortName) {
                searchParam.sortName = event.sortName;
            }
            if (event.sortOrder) {
                searchParam.sortOrder = event.sortOrder;
            }
            // 分层加载支持设置展开层级
            if (!isNaN(Number(event.expandLevel)) && this.ins.isTree()) {
                // 前端 -1 不展开   0 全展开
                // 后端  0 不展开  -1 全展开
                if (event.expandLevel) {
                    if (event.expandLevel === -1) {
                        event.expandLevel = 0;
                    }
                }
                else {
                    event.expandLevel = -1;
                }
                searchParam['layerNum'] = event.expandLevel;
            }
        }
        if (type === 'fav' && event.favoriteIds) {
            searchParam.favoriteIds = event.favoriteIds;
        }
        if (this.ins.isTree() || this.ins.displayType === LookupGridDisplayType.NavTreeList) {
            params.enableFullTree = this.ins.enableFullTree;
        }
        params.treeToList = this.ins.treeToList;
        params.navTreeToList = this.ins.navTreeToList;
        // 查询时不构造完整树
        if (type === 'textchange') {
            params.enableFullTree = false;
        }
        if (type === 'selected') {
            searchParam.category = 'fav';
            params.enableFullTree = false;
            searchParam.favoriteIds = event.favoriteIds;
        }
        params.searchValue = JSON.stringify(searchParam);
        params.loadTreeDataType = this.ins.loadTreeDataType;
        params.customData = this.ins.customData;
        if (this.ins.helpId) {
            params.helpId = this.ins.helpId;
        }
        if (event.selectedInfo) {
            params.selectedInfo = event.selectedInfo;
        }
        if (event.navNodePathCode !== undefined) {
            params.navPathCode = event.navNodePathCode;
        }
        else {
            if (type === 'navAllChildren') {
                if (this.ins.includeSubordinates && this.ins['navNodePathCode']) {
                    params.navPathCode = this.ins['navNodePathCode'];
                }
            }
        }
        return params;
    }
    /**
     * @param {?=} event
     * @param {?=} type
     * @return {?}
     */
    getData(event, type = 'all') {
        /** @type {?} */
        const uri = this.ins.gridOptions.uri;
        if (this.ins.isDoublleList() && this.ins.navigationFilter && this.ins.navigationFilter.idValue && type !== 'fav') {
            if (this.ins.includeSubordinates && this.ins.navigationOptions.treeInfo.loadDataType === 'async') {
                type = 'navAllChildren';
            }
            else {
                type = 'list';
            }
        }
        /** @type {?} */
        const params = this.buildQueryParams(event, type);
        if (uri || this.ins.beUri) {
            if (this.ins.beUri && this.ins.columns && this.ins.columns.length) {
                /** @type {?} */
                const allSearchFields = this.ins.columns.map((/**
                 * @param {?} col
                 * @return {?}
                 */
                col => col.searchField)).filter((/**
                 * @param {?} f
                 * @return {?}
                 */
                f => f));
                if (!params.condition) {
                    params.condition = {};
                }
                if (!this.ins.isTree() && this.ins.pagination) {
                    const { pageSize = this.ins.pageSize || 20, pageIndex } = Object.assign({}, params);
                    params.condition.pagination = { pageSize, pageIndex };
                }
                else {
                    params.condition.pagination = { isUsePagination: false };
                }
                /** @type {?} */
                const searchParam = JSON.parse(params.searchValue);
                if (searchParam.searchValue) {
                    params.condition = this.ins.lookupUtils.mergeCondition(params.condition, allSearchFields, {
                        field: searchParam.searchField,
                        value: searchParam.searchValue
                    });
                }
            }
            /** @type {?} */
            const _uri = this.ins.beUri || uri;
            if (this.ins.http) {
                this.ins.http.context = this.ins.context;
            }
            if (this.ins._searchResult) {
                return of(this.ins._searchResult);
            }
            if (type !== 'allChildren') {
                return this.ins.http.getData(_uri, params);
            }
            else {
                /** @type {?} */
                const params1 = {
                    searchValue: JSON.stringify({ category: type }),
                    parentsIds: event.parentsIds,
                    customData: params.customData,
                    helpId: params.helpId
                };
                return this.ins.http.getData(_uri, params1);
            }
        }
        else {
            return of(false);
        }
    }
    // getFavoriteData(params) {
    //     return this.getData(params, 'fav');
    // }
    /**
     * @param {?} selIds
     * @return {?}
     */
    getSelecedItems(selIds) {
        return this.getData({ favoriteIds: selIds }, 'selected');
    }
    /**
     * @return {?}
     */
    getPersonalConfig() {
        /** @type {?} */
        const defaultConf = cloneDeep(DefaultUserConfig);
        // if (this.ins.customData) {
        //     const wrapKeyData = JSON.stringify({ key: this.ins.customData });
        //     const configKeyString = this.ins.getLookupBindingFields() + wrapKeyData;
        //     this.ins.personalConfigService.personalConfigKey = configKeyString;
        // }
        /** @type {?} */
        const key = this.ins.personalConfigService._newKey;
        /** @type {?} */
        let _conf = this.ins.personalConfigService.getPersonalData(key);
        if (!_conf || !Object.keys(_conf).length) {
            _conf = defaultConf;
        }
        /** @type {?} */
        const req = of(_conf);
        if (this.ins.favoriteDataFrom === 'locale' || this.ins.isTabChanged) {
            return req;
        }
        if (this.ins.http && this.ins.http['getUserSettings']) {
            return this.ins.http['getUserSettings'](key).pipe(tap((/**
             * @param {?} r
             * @return {?}
             */
            (r) => {
                if (r && r.textValue) {
                    localStorage.setItem(key, r.textValue);
                }
                else {
                    localStorage.setItem(key, JSON.stringify(defaultConf));
                }
            })), map((/**
             * @param {?} ucs
             * @return {?}
             */
            (ucs) => {
                if (ucs) {
                    return ucs.textValue ? JSON.parse(ucs.textValue) : defaultConf;
                }
                return defaultConf;
            })));
        }
        else {
            return req;
        }
    }
    /**
     * @param {?=} event
     * @param {?=} type
     * @param {?=} isQuickSelect
     * @return {?}
     */
    lookupRequest(event, type = 'all', isQuickSelect = false) {
        if (!this.ins.usePersionalConf || isQuickSelect) {
            return this.getData(event, type);
        }
        /** @type {?} */
        const req = this.getPersonalConfig();
        return req.pipe(tap((/**
         * @param {?} c
         * @return {?}
         */
        (c) => {
            this.ins.personalConf = c;
            this.ins.personalConfigService.savePersonalConfig(c);
            if (!this.ins.isTabChanged) {
                this._originalPersonalConfig = cloneDeep(c);
            }
        })), switchMap((/**
         * @param {?} c
         * @return {?}
         */
        (c) => {
            const { tabIndex, favorite, size, cascadeStatus } = c;
            if (!this.ins.isTabChanged) {
                this.ins.activeTab = tabIndex || 'datalist';
            }
            if (size) {
                this.ins.dialogWidth = size.width;
                this.ins.dialogHeight = size.height;
                if (!this.ins.isTabChanged) {
                    this.ins.dialog.reSize({ width: size.width, height: size.height });
                }
            }
            if (this.ins.cascadeStatus) {
                if (cascadeStatus && this.ins.enableCascade && this.ins.showCascadeControl) {
                    this.ins.cascadeStatus = cascadeStatus;
                }
                if (this.ins.cascadeItems) {
                    /** @type {?} */
                    const keys = ['enable', 'up', 'down', 'disable'];
                    keys.forEach((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => {
                        if (this.ins.cascadeItems[n] === undefined) {
                            this.ins.cascadeItems[n] = true;
                        }
                    }));
                    if (!this.ins.cascadeItems[this.ins.cascadeStatus]) {
                        /** @type {?} */
                        const keys = Object.keys(this.ins.cascadeItems).map((/**
                         * @param {?} n
                         * @return {?}
                         */
                        n => {
                            return this.ins.cascadeItems[n] ? n : '';
                        })).filter((/**
                         * @param {?} n
                         * @return {?}
                         */
                        n => n));
                        this.ins.cascadeStatus = (/** @type {?} */ (keys[0]));
                    }
                }
            }
            if (this.ins.activeTab === 'datalist') {
                return this.getData(event, type);
            }
            else if (this.ins.activeTab === 'favorite') {
                /** @type {?} */
                const favIds = favorite ? favorite[this.ins.localService.localeId] : [];
                if ((!favIds || !favIds.length) && !this.ins.isTabChanged) {
                    return this.getData(event, 'all').pipe(map((/**
                     * @param {?} r
                     * @return {?}
                     */
                    r => {
                        if (r && !r.items) {
                            r.items = [];
                        }
                        r.activeTab = 'datalist';
                        return r;
                    })));
                }
                // const _fids = favIds.filter(n => n);
                event.favoriteIds = favIds;
                event.search = null;
                return this.getData(event, 'fav').pipe(switchMap((/**
                 * @param {?} r
                 * @return {?}
                 */
                r => {
                    /** @type {?} */
                    const items = r ? r.items || [] : [];
                    // 加入数据权限后，没有返回数据且第1次打开窗口，非手动点击收藏标签时
                    if (!items.length && !this.ins.isTabChanged) {
                        return this.getData(event, 'all').pipe(map((/**
                         * @param {?} a
                         * @return {?}
                         */
                        a => {
                            if (a && !a.items) {
                                a.items = [];
                            }
                            a.activeTab = 'datalist';
                            return a;
                        })));
                    }
                    else {
                        return of(r);
                    }
                })));
            }
            else if (this.ins.activeTab === 'selected') {
                /** @type {?} */
                const selIds = this.ins.displayValue ? this.ins.displayValue.split(',') : [];
                /** @type {?} */
                const _sids = selIds.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n));
                return this.getSelecedItems(_sids);
            }
        })));
    }
    // 保存个性化数据
    /**
     * @param {?} action
     * @return {?}
     */
    submitFavoriteData(action) {
        // 保存列宽度
        this.ins.personalConf.colSizeInfo = this.getColumnSizeInfo();
        // 如果数据与默认的数据一至则不保存。
        if (JSON.stringify(this.ins.personalConf) === JSON.stringify(this._originalPersonalConfig)) {
            return;
        }
        /** @type {?} */
        let msg = '';
        if (action === FavoriteAction.add) {
            msg = this.ins.addFavoriteSuccess;
        }
        else if (action === FavoriteAction.delete) {
            msg = this.ins.delFavoriteSuccess;
        }
        // 更新本地缓存
        localStorage.setItem(this.ins.personalConfigService._newKey, JSON.stringify(this.ins.personalConf));
        this.ins.personalConfigService.savePersonalConfig(this.ins.personalConf || {});
        if (this.ins.favoriteDataFrom !== 'locale') {
            this._originalPersonalConfig = cloneDeep(this.ins.personalConf);
            /** @type {?} */
            const configData = {
                configkey1: this.ins.personalConfigService.personalConfigKey,
                configkey2: '',
                configkey3: '',
                textvalue: JSON.stringify(this.ins.personalConf)
            };
            if (this.ins.http && this.ins.http['saveUserSettings']) {
                this.ins.savingFaoriteData = true;
                this.ins.showLoading();
                return this.ins.http['saveUserSettings'](configData).subscribe((/**
                 * @param {?} r
                 * @return {?}
                 */
                (r) => {
                    this.ins.savingFaoriteData = false;
                    this.ins.closeLoading();
                    if (msg) {
                        this.ins.notifyService.success(msg);
                    }
                }));
            }
            else {
                if (msg) {
                    this.ins.notifyService.success(msg);
                }
            }
        }
        else {
            if (msg) {
                this.ins.notifyService.success(msg);
            }
        }
    }
    /**
     * @private
     * @return {?}
     */
    getColumnSizeInfo() {
        /** @type {?} */
        const colSizeInfo = { data: {}, nav: {}, fav: {}, sel: {} };
        colSizeInfo.data = this.ins.columns.filter((/**
         * @param {?} c
         * @return {?}
         */
        (c) => c.field !== FAVORITE_FIELD_NAME)).reduce((/**
         * @param {?} r
         * @param {?} n
         * @return {?}
         */
        (r, n) => {
            r[n.field] = n.width;
            return r;
        }), {});
        if (this.ins.favoriteColumns && this.ins.favoriteColumns.length) {
            colSizeInfo.fav = this.ins.favoriteColumns.filter((/**
             * @param {?} c
             * @return {?}
             */
            (c) => c.field !== FAVORITE_FIELD_NAME)).reduce((/**
             * @param {?} r
             * @param {?} n
             * @return {?}
             */
            (r, n) => {
                r[n.field] = n.width;
                return r;
            }), {});
        }
        if (this.ins.navigationOptions && this.ins.navigationOptions.columns && this.ins.navigationOptions.columns.length) {
            colSizeInfo.nav = this.ins.navigationOptions.columns.filter((/**
             * @param {?} c
             * @return {?}
             */
            (c) => c.field !== FAVORITE_FIELD_NAME)).reduce((/**
             * @param {?} r
             * @param {?} n
             * @return {?}
             */
            (r, n) => {
                r[n.field] = n.width;
                return r;
            }), {});
        }
        if (this.ins.selectedColumns && this.ins.selectedColumns.length && this.ins.showSelected) {
            colSizeInfo.sel = this.ins.selectedColumns.filter((/**
             * @param {?} c
             * @return {?}
             */
            (c) => c.field !== FAVORITE_FIELD_NAME)).reduce((/**
             * @param {?} r
             * @param {?} n
             * @return {?}
             */
            (r, n) => {
                r[n.field] = n.width;
                return r;
            }), {});
        }
        return colSizeInfo;
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    LookupHttpManager.prototype._originalPersonalConfig;
    /**
     * @type {?}
     * @private
     */
    LookupHttpManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC1tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvaHR0cC1tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFHQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxjQUFjLEVBQUUsbUJBQW1CLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNuRyxPQUFPLEVBQWMsRUFBRSxFQUFZLE1BQU0sTUFBTSxDQUFDO0FBQ2hELE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBZ0IsTUFBTSxnQkFBZ0IsQ0FBQzs7O01BRzdELGlCQUFpQixHQUFHO0lBQ3RCLFFBQVEsRUFBRSxVQUFVO0lBQ3BCLFFBQVEsRUFBRSxJQUFJO0lBQ2QsSUFBSSxFQUFFLElBQUk7Q0FDYjtBQUNELE1BQU0sT0FBTyxpQkFBaUI7Ozs7SUFLMUIsWUFBb0IsR0FBd0I7UUFBeEIsUUFBRyxHQUFILEdBQUcsQ0FBcUI7OztRQUZwQyw0QkFBdUIsR0FBRyxpQkFBaUIsQ0FBQztJQUVKLENBQUM7Ozs7O0lBRXpDLGlCQUFpQjtRQUNyQixPQUFPO1lBQ0gsU0FBUyxFQUFFLENBQUM7WUFDWixRQUFRLEVBQUUsR0FBRztTQUNoQixDQUFDO0lBQ04sQ0FBQzs7Ozs7OztJQUdELGdCQUFnQixDQUFDLEtBQVcsRUFBRSxPQUF1QixLQUFLOztjQUNoRCxNQUFNLEdBQWlCLEVBQUU7UUFFL0IsSUFBSSxLQUFLLENBQUMsYUFBYSxJQUFJLEtBQUssQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFO1lBQ25ELElBQUksS0FBSyxDQUFDLGFBQWEsSUFBSSxLQUFLLENBQUMsYUFBYSxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksR0FBRyxFQUFFO2dCQUMvRixLQUFLLENBQUMsTUFBTSxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUMsQ0FBQzthQUNyRTtpQkFBTTtnQkFDSCxNQUFNLENBQUMsbUJBQW1CLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQzthQUNwRDtTQUNKO1FBRUQsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxNQUFNLElBQUksSUFBSSxLQUFLLEtBQUssRUFBRTtZQUNyRSxNQUFNLENBQUMsZ0JBQWdCLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDNUQ7O2NBRUssV0FBVyxHQUFnQixFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUU7UUFFbkQsSUFBSSxJQUFJLEtBQUssS0FBSyxFQUFFO1lBQ2hCLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixJQUFJLElBQUksS0FBSyxLQUFLLEVBQUU7Z0JBQ3pFLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLElBQUksSUFBSSxLQUFLLFlBQVksRUFBRTtvQkFDNUQsTUFBTSxDQUFDLGNBQWMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztpQkFDbEU7YUFDSjtTQUNKO1FBRUQsSUFBSSxLQUFLLEVBQUU7WUFDUCxJQUFJLElBQUksS0FBSyxLQUFLLElBQUksSUFBSSxLQUFLLFVBQVUsRUFBRTtnQkFDdkMsS0FBSyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQzthQUM3QztZQUVELElBQUksS0FBSyxDQUFDLFFBQVEsRUFBRTtnQkFDaEIsTUFBTSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQztnQkFDNUMsTUFBTSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQzthQUM3QztZQUVELElBQUksS0FBSyxDQUFDLE1BQU0sRUFBRTs7b0JBQ1YsTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSztnQkFDL0IsSUFBSSxNQUFNLElBQUksTUFBTSxLQUFLLEdBQUcsRUFBRTtvQkFDMUIsTUFBTSxHQUFHLEdBQUcsQ0FBQztpQkFDaEI7Z0JBRUQsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRTtvQkFDcEIsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7aUJBQ2xEO2dCQUVELFdBQVcsQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDO2dCQUNqQyxXQUFXLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO2dCQUM3QyxXQUFXLENBQUMsVUFBVSxHQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxJQUFJLE1BQU0sQ0FBQztnQkFFdEQsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssS0FBSyxFQUFFLElBQUksV0FBVyxDQUFDLFFBQVEsS0FBSyxRQUFRLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFO29CQUM3SCxXQUFXLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztpQkFDaEM7YUFDSjtZQUVELElBQUksS0FBSyxDQUFDLFFBQVEsRUFBRTtnQkFDaEIsV0FBVyxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDO2FBQ3pDO1lBQ0QsSUFBSSxLQUFLLENBQUMsU0FBUyxFQUFFO2dCQUNqQixXQUFXLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUM7YUFDM0M7WUFFRCxlQUFlO1lBQ2YsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsRUFBRTtnQkFDeEQsb0JBQW9CO2dCQUNwQixvQkFBb0I7Z0JBQ3BCLElBQUksS0FBSyxDQUFDLFdBQVcsRUFBRTtvQkFDbkIsSUFBSSxLQUFLLENBQUMsV0FBVyxLQUFLLENBQUMsQ0FBQyxFQUFFO3dCQUMxQixLQUFLLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQztxQkFDekI7aUJBQ0o7cUJBQU07b0JBQ0gsS0FBSyxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUMsQ0FBQztpQkFDMUI7Z0JBQ0QsV0FBVyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUM7YUFDL0M7U0FDSjtRQUVELElBQUksSUFBSSxLQUFLLEtBQUssSUFBSSxLQUFLLENBQUMsV0FBVyxFQUFFO1lBQ3JDLFdBQVcsQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQztTQUMvQztRQUVELElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsS0FBSyxxQkFBcUIsQ0FBQyxXQUFXLEVBQUU7WUFDakYsTUFBTSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQztTQUNuRDtRQUVELE1BQU0sQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUM7UUFDeEMsTUFBTSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQztRQUU5QyxZQUFZO1FBQ1osSUFBSSxJQUFJLEtBQUssWUFBWSxFQUFFO1lBQ3ZCLE1BQU0sQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDO1NBQ2pDO1FBRUQsSUFBSSxJQUFJLEtBQUssVUFBVSxFQUFFO1lBQ3JCLFdBQVcsQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO1lBQzdCLE1BQU0sQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDO1lBQzlCLFdBQVcsQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQztTQUMvQztRQUVELE1BQU0sQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNqRCxNQUFNLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQztRQUVwRCxNQUFNLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDO1FBRXhDLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUU7WUFDakIsTUFBTSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQztTQUNuQztRQUVELElBQUksS0FBSyxDQUFDLFlBQVksRUFBRTtZQUNwQixNQUFNLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQyxZQUFZLENBQUM7U0FDNUM7UUFFRCxJQUFJLEtBQUssQ0FBQyxlQUFlLEtBQUssU0FBUyxFQUFFO1lBQ3JDLE1BQU0sQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLGVBQWUsQ0FBQztTQUM5QzthQUFNO1lBQ0gsSUFBSSxJQUFJLEtBQUssZ0JBQWdCLEVBQUU7Z0JBQzNCLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLEVBQUU7b0JBQzdELE1BQU0sQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO2lCQUNwRDthQUNKO1NBQ0o7UUFFRCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDOzs7Ozs7SUFHRCxPQUFPLENBQUMsS0FBVyxFQUFFLE9BQXVCLEtBQUs7O2NBQ3ZDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxHQUFHO1FBRXBDLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsSUFBSyxJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxJQUFJLElBQUksS0FBSyxLQUFLLEVBQUU7WUFDL0csSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLFlBQVksS0FBSyxPQUFPLEVBQUU7Z0JBQzlGLElBQUksR0FBRyxnQkFBZ0IsQ0FBQzthQUMzQjtpQkFBTTtnQkFDSCxJQUFJLEdBQUcsTUFBTSxDQUFDO2FBQ2pCO1NBQ0o7O2NBRUssTUFBTSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDO1FBRWpELElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFO1lBQ3ZCLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFOztzQkFDekQsZUFBZSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUc7Ozs7Z0JBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFDLENBQUMsTUFBTTs7OztnQkFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBQztnQkFDbkYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUU7b0JBQ25CLE1BQU0sQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO2lCQUN6QjtnQkFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRTswQkFDckMsRUFBRSxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLElBQUksRUFBRSxFQUFFLFNBQVMsRUFBRSxxQkFBUSxNQUFNLENBQUU7b0JBQ3ZFLE1BQU0sQ0FBQyxTQUFTLENBQUMsVUFBVSxHQUFHLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxDQUFDO2lCQUN6RDtxQkFBTTtvQkFDSCxNQUFNLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxFQUFFLGVBQWUsRUFBRSxLQUFLLEVBQUUsQ0FBQztpQkFDNUQ7O3NCQUNLLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUM7Z0JBQ2xELElBQUksV0FBVyxDQUFDLFdBQVcsRUFBRTtvQkFDekIsTUFBTSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxlQUFlLEVBQUU7d0JBQ3RGLEtBQUssRUFBRSxXQUFXLENBQUMsV0FBVzt3QkFDOUIsS0FBSyxFQUFFLFdBQVcsQ0FBQyxXQUFXO3FCQUNqQyxDQUFDLENBQUM7aUJBQ047YUFDSjs7a0JBRUssSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxJQUFJLEdBQUc7WUFFbEMsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRTtnQkFDZixJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUM7YUFDNUM7WUFDRCxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFO2dCQUN4QixPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO2FBQ3JDO1lBRUQsSUFBSSxJQUFJLEtBQUssYUFBYSxFQUFFO2dCQUN4QixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7YUFDOUM7aUJBQU07O3NCQUNHLE9BQU8sR0FBRztvQkFDWixXQUFXLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQztvQkFDL0MsVUFBVSxFQUFFLEtBQUssQ0FBQyxVQUFVO29CQUM1QixVQUFVLEVBQUUsTUFBTSxDQUFDLFVBQVU7b0JBQzdCLE1BQU0sRUFBRSxNQUFNLENBQUMsTUFBTTtpQkFDeEI7Z0JBQ0QsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO2FBQy9DO1NBQ0o7YUFBTTtZQUNILE9BQU8sRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3BCO0lBQ0wsQ0FBQzs7Ozs7Ozs7SUFNRCxlQUFlLENBQUMsTUFBYTtRQUN6QixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDN0QsQ0FBQzs7OztJQUVELGlCQUFpQjs7Y0FDUCxXQUFXLEdBQUcsU0FBUyxDQUFDLGlCQUFpQixDQUFDOzs7Ozs7O2NBTzFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLE9BQU87O1lBRTlDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUM7UUFFL0QsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxFQUFFO1lBQ3RDLEtBQUssR0FBRyxXQUFXLENBQUM7U0FDdkI7O2NBQ0ssR0FBRyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUM7UUFFckIsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixLQUFLLFFBQVEsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRTtZQUNqRSxPQUFPLEdBQUcsQ0FBQztTQUNkO1FBRUQsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFO1lBQ25ELE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQzdDLEdBQUc7Ozs7WUFBQyxDQUFDLENBQU0sRUFBRSxFQUFFO2dCQUNYLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFTLEVBQUU7b0JBQ2xCLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQztpQkFDMUM7cUJBQU07b0JBQ0gsWUFBWSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO2lCQUMxRDtZQUNMLENBQUMsRUFBQyxFQUNGLEdBQUc7Ozs7WUFBQyxDQUFDLEdBQVEsRUFBRSxFQUFFO2dCQUNiLElBQUksR0FBRyxFQUFFO29CQUNMLE9BQU8sR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQztpQkFDbEU7Z0JBQ0QsT0FBTyxXQUFXLENBQUM7WUFDdkIsQ0FBQyxFQUFDLENBQ0wsQ0FBQztTQUNMO2FBQU07WUFDSCxPQUFPLEdBQUcsQ0FBQztTQUNkO0lBQ0wsQ0FBQzs7Ozs7OztJQUVELGFBQWEsQ0FBQyxLQUFXLEVBQUUsT0FBdUIsS0FBSyxFQUFFLGFBQWEsR0FBRyxLQUFLO1FBQzFFLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixJQUFJLGFBQWEsRUFBRTtZQUM3QyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ3BDOztjQUVLLEdBQUcsR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUU7UUFFcEMsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUNYLEdBQUc7Ozs7UUFBQyxDQUFDLENBQU0sRUFBRSxFQUFFO1lBQ1gsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDO1lBQzFCLElBQUksQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckQsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFO2dCQUN4QixJQUFJLENBQUMsdUJBQXVCLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQy9DO1FBQ0wsQ0FBQyxFQUFDLEVBQ0YsU0FBUzs7OztRQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUU7a0JBQ1gsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUUsR0FBRyxDQUFDO1lBRXJELElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRTtnQkFDeEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEdBQUcsUUFBUSxJQUFJLFVBQVUsQ0FBQzthQUMvQztZQUVELElBQUksSUFBSSxFQUFFO2dCQUNOLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7Z0JBQ2xDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7Z0JBRXBDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRTtvQkFDeEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO2lCQUN0RTthQUNKO1lBR0QsSUFBSyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRTtnQkFDekIsSUFBSSxhQUFhLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsRUFBRTtvQkFDeEUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEdBQUcsYUFBYSxDQUFDO2lCQUMxQztnQkFFRCxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFOzswQkFDakIsSUFBSSxHQUFHLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsU0FBUyxDQUFDO29CQUNoRCxJQUFJLENBQUMsT0FBTzs7OztvQkFBQyxDQUFDLENBQUMsRUFBRTt3QkFDYixJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxLQUFLLFNBQVMsRUFBRTs0QkFDeEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO3lCQUNuQztvQkFDTCxDQUFDLEVBQUMsQ0FBQztvQkFFSCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsRUFBRzs7OEJBQzNDLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsR0FBRzs7Ozt3QkFBQyxDQUFDLENBQUMsRUFBRTs0QkFDcEQsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBLENBQUMsQ0FBQyxFQUFFLENBQUM7d0JBQzVDLENBQUMsRUFBQyxDQUFDLE1BQU07Ozs7d0JBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUM7d0JBQ2pCLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxHQUFHLG1CQUFBLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBTyxDQUFDO3FCQUMzQztpQkFDSjthQUNKO1lBRUQsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsS0FBSyxVQUFVLEVBQUU7Z0JBQ25DLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDcEM7aUJBQU0sSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsS0FBSyxVQUFVLEVBQUU7O3NCQUNwQyxNQUFNLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQ3ZFLElBQUksQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFO29CQUN2RCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FDbEMsR0FBRzs7OztvQkFBQyxDQUFDLENBQUMsRUFBRTt3QkFDSixJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUU7NEJBQ2YsQ0FBQyxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7eUJBQ2hCO3dCQUNELENBQUMsQ0FBQyxTQUFTLEdBQUcsVUFBVSxDQUFDO3dCQUN6QixPQUFPLENBQUMsQ0FBQztvQkFDYixDQUFDLEVBQUMsQ0FDTCxDQUFDO2lCQUNMO2dCQUVELHVDQUF1QztnQkFDdkMsS0FBSyxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUM7Z0JBQzNCLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO2dCQUNwQixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FDbEMsU0FBUzs7OztnQkFBQyxDQUFDLENBQUMsRUFBRTs7MEJBQ0osS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUU7b0JBQ3BDLG9DQUFvQztvQkFDcEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRTt3QkFDekMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQ2xDLEdBQUc7Ozs7d0JBQUMsQ0FBQyxDQUFDLEVBQUU7NEJBQ0osSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFO2dDQUNmLENBQUMsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDOzZCQUNoQjs0QkFFRCxDQUFDLENBQUMsU0FBUyxHQUFHLFVBQVUsQ0FBQzs0QkFDekIsT0FBTyxDQUFDLENBQUM7d0JBQ2IsQ0FBQyxFQUFDLENBQ0wsQ0FBQztxQkFDTDt5QkFBTTt3QkFDSCxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztxQkFDaEI7Z0JBQ0wsQ0FBQyxFQUFDLENBQ0wsQ0FBQzthQUNMO2lCQUFNLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEtBQUssVUFBVSxFQUFFOztzQkFDcEMsTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7O3NCQUN0RSxLQUFLLEdBQUcsTUFBTSxDQUFDLE1BQU07Ozs7Z0JBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUM7Z0JBQ25DLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUN0QztRQUNMLENBQUMsRUFBQyxDQUNMLENBQUM7SUFDTixDQUFDOzs7Ozs7SUFHRCxrQkFBa0IsQ0FBQyxNQUE0QjtRQUUzQyxRQUFRO1FBQ1IsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBRTdELG9CQUFvQjtRQUNwQixJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxFQUFFO1lBQ3hGLE9BQU87U0FDVjs7WUFFRyxHQUFHLEdBQUcsRUFBRTtRQUNaLElBQUksTUFBTSxLQUFLLGNBQWMsQ0FBQyxHQUFHLEVBQUU7WUFDL0IsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUM7U0FDckM7YUFBTSxJQUFJLE1BQU0sS0FBSyxjQUFjLENBQUMsTUFBTSxFQUFFO1lBQ3pDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDO1NBQ3JDO1FBQ0QsU0FBUztRQUNULFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7UUFDcEcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUMsQ0FBQztRQUUvRSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEtBQUssUUFBUSxFQUFFO1lBQ3hDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQzs7a0JBRTFELFVBQVUsR0FBcUI7Z0JBQ2pDLFVBQVUsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLGlCQUFpQjtnQkFDNUQsVUFBVSxFQUFFLEVBQUU7Z0JBQ2QsVUFBVSxFQUFFLEVBQUU7Z0JBQ2QsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUM7YUFDbkQ7WUFFRCxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEVBQUU7Z0JBQ3BELElBQUksQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDO2dCQUNsQyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUN2QixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsU0FBUzs7OztnQkFBQyxDQUFDLENBQUMsRUFBRSxFQUFFO29CQUNqRSxJQUFJLENBQUMsR0FBRyxDQUFDLGlCQUFpQixHQUFHLEtBQUssQ0FBQztvQkFDbkMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztvQkFDeEIsSUFBSSxHQUFHLEVBQUU7d0JBQ0wsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO3FCQUN2QztnQkFDTCxDQUFDLEVBQUMsQ0FBQzthQUNOO2lCQUFNO2dCQUNILElBQUksR0FBRyxFQUFFO29CQUNMLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztpQkFDdkM7YUFDSjtTQUNKO2FBQU07WUFDSCxJQUFJLEdBQUcsRUFBRTtnQkFDTCxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDdkM7U0FDSjtJQUNMLENBQUM7Ozs7O0lBRU8saUJBQWlCOztjQUNmLFdBQVcsR0FBRyxFQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUM7UUFDekQsV0FBVyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNOzs7O1FBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEtBQUssbUJBQW1CLEVBQUMsQ0FBQyxNQUFNOzs7OztRQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQy9GLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztZQUNyQixPQUFPLENBQUMsQ0FBQztRQUNiLENBQUMsR0FBRSxFQUFFLENBQUMsQ0FBQztRQUVQLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFlLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFO1lBQzdELFdBQVcsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsTUFBTTs7OztZQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxLQUFLLG1CQUFtQixFQUFDLENBQUMsTUFBTTs7Ozs7WUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDdEcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO2dCQUNyQixPQUFPLENBQUMsQ0FBQztZQUNiLENBQUMsR0FBRSxFQUFFLENBQUMsQ0FBQztTQUNWO1FBRUQsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLGlCQUFpQixJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUMvRyxXQUFXLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLE1BQU07Ozs7WUFBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssS0FBSyxtQkFBbUIsRUFBQyxDQUFDLE1BQU07Ozs7O1lBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQ2hILENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztnQkFDckIsT0FBTyxDQUFDLENBQUM7WUFDYixDQUFDLEdBQUUsRUFBRSxDQUFDLENBQUM7U0FDVjtRQUVELElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFlLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFO1lBQ3RGLFdBQVcsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsTUFBTTs7OztZQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxLQUFLLG1CQUFtQixFQUFDLENBQUMsTUFBTTs7Ozs7WUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDdEcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO2dCQUNyQixPQUFPLENBQUMsQ0FBQztZQUNiLENBQUMsR0FBRSxFQUFFLENBQUMsQ0FBQztTQUNWO1FBRUQsT0FBTyxXQUFXLENBQUM7SUFDdkIsQ0FBQztDQUVKOzs7Ozs7SUFqYkcsb0RBQW9EOzs7OztJQUV4QyxnQ0FBZ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZW1vdGVQYXJhbXMsIFNlYXJjaFBhcmFtLCBVc2VyRmF2b3JpdGVEYXRhIH0gZnJvbSAnLi4vaHR0cC9SZW1vdGVQYXJhbXMnO1xyXG5pbXBvcnQgeyBMT0FEX0RBVEFfVFlQRSB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLW9wdGlvbnMnO1xyXG5pbXBvcnQgeyBMb29rdXBHcmlkQ29tcG9uZW50IH0gZnJvbSAnLi4vbG9va3VwLWdyaWQuY29tcG9uZW50JztcclxuaW1wb3J0IHsgY2xvbmVEZWVwIH0gZnJvbSAnbG9kYXNoLWVzJztcclxuaW1wb3J0IHsgRmF2b3JpdGVBY3Rpb24sIEZBVk9SSVRFX0ZJRUxEX05BTUUsIExvb2t1cEdyaWREaXNwbGF5VHlwZSB9IGZyb20gJy4uL2xvb2t1cC1kaXNwbGF5dHlwZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBmb3JrSm9pbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBtYXAsIHN3aXRjaE1hcCwgdGFwLCBkZWJvdW5jZVRpbWUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG4vLyDluK7liqnpu5jorqTkuKrmgKfljJbmlbDmja5cclxuY29uc3QgRGVmYXVsdFVzZXJDb25maWcgPSB7XHJcbiAgICB0YWJJbmRleDogJ2RhdGFsaXN0JyxcclxuICAgIGZhdm9yaXRlOiBudWxsLFxyXG4gICAgc2l6ZTogbnVsbFxyXG59O1xyXG5leHBvcnQgY2xhc3MgTG9va3VwSHR0cE1hbmFnZXIge1xyXG4gICAgLy8g5q+P5qyh5biu5Yqp5omT5byA5ZCO77yM5pu05paw5q2k5YC877yM5YGa5Li65Liq5oCn5YyW5pWw5o2u55qE5Yid5aeL5YC877ybXHJcbiAgICAvLyDlhbPpl63nqpflj6Pml7bvvIzkuI7mraTov5vooYzlr7nmr5TjgILlpoLmnpzkuIDmoLfvvIzliJnkuI3kv53lrZjvvJtcclxuICAgIHByaXZhdGUgX29yaWdpbmFsUGVyc29uYWxDb25maWcgPSBEZWZhdWx0VXNlckNvbmZpZztcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluczogTG9va3VwR3JpZENvbXBvbmVudCkgeyB9XHJcblxyXG4gICAgcHJpdmF0ZSBkaXNhYmxlUGFnaW5hdGlvbigpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBwYWdlSW5kZXg6IDEsXHJcbiAgICAgICAgICAgIHBhZ2VTaXplOiA1MDBcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKiDmnoTpgKDmn6Xor6Llj4LmlbAgKi9cclxuICAgIGJ1aWxkUXVlcnlQYXJhbXMoZXZlbnQ/OiBhbnksIHR5cGU6IExPQURfREFUQV9UWVBFID0gJ2FsbCcpIHtcclxuICAgICAgICBjb25zdCBwYXJhbXM6IFJlbW90ZVBhcmFtcyA9IHt9O1xyXG5cclxuICAgICAgICBpZiAoZXZlbnQubmF2Q29uZGl0aW9ucyAmJiBldmVudC5uYXZDb25kaXRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBpZiAoZXZlbnQubmF2Q29uZGl0aW9ucyAmJiBldmVudC5uYXZDb25kaXRpb25zLmxlbmd0aCA9PT0gMSAmJiBldmVudC5uYXZDb25kaXRpb25zWzBdLmNvZGUgPT0gJyonKSB7XHJcbiAgICAgICAgICAgICAgICBldmVudC5zZWFyY2ggPSB7IGZpZWxkOiAnKicsIHZhbHVlOiBldmVudC5uYXZDb25kaXRpb25zWzBdLnZhbHVlfTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHBhcmFtcy5uYXZTZWFyY2hDb25kaXRpb25zID0gZXZlbnQubmF2Q29uZGl0aW9ucztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmNvbmRpdGlvbnMgJiYgdGhpcy5pbnMuY29uZGl0aW9ucy5sZW5ndGggJiYgdHlwZSAhPT0gJ2ZhdicpIHtcclxuICAgICAgICAgICAgcGFyYW1zLnNlYXJjaENvbmRpdGlvbnMgPSBjbG9uZURlZXAodGhpcy5pbnMuY29uZGl0aW9ucyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBzZWFyY2hQYXJhbTogU2VhcmNoUGFyYW0gPSB7IGNhdGVnb3J5OiB0eXBlIH07XHJcblxyXG4gICAgICAgIGlmICh0eXBlICE9PSAnZmF2Jykge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pbnMuaXNEb3VibGxlTGlzdCgpICYmIHRoaXMuaW5zLm5hdmlnYXRpb25GaWx0ZXIgJiYgdHlwZSAhPT0gJ2FsbCcpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmlucy5uYXZpZ2F0aW9uRmlsdGVyLmlkVmFsdWUgJiYgdHlwZSAhPT0gJ3RleHRjaGFuZ2UnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zLnJlbGF0aW9uRmlsdGVyID0gWy4uLnRoaXMuaW5zLm5hdmlnYXRpb25GaWx0ZXIuaWRWYWx1ZV07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChldmVudCkge1xyXG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2ZhdicgfHwgdHlwZSA9PT0gJ3NlbGVjdGVkJykge1xyXG4gICAgICAgICAgICAgICAgZXZlbnQucGFnZUluZm8gPSB0aGlzLmRpc2FibGVQYWdpbmF0aW9uKCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChldmVudC5wYWdlSW5mbykge1xyXG4gICAgICAgICAgICAgICAgcGFyYW1zLnBhZ2VJbmRleCA9IGV2ZW50LnBhZ2VJbmZvLnBhZ2VJbmRleDtcclxuICAgICAgICAgICAgICAgIHBhcmFtcy5wYWdlU2l6ZSA9IGV2ZW50LnBhZ2VJbmZvLnBhZ2VTaXplO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoZXZlbnQuc2VhcmNoKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgc2ZpZWxkID0gZXZlbnQuc2VhcmNoLmZpZWxkO1xyXG4gICAgICAgICAgICAgICAgaWYgKHNmaWVsZCAmJiBzZmllbGQgPT09ICcqJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHNmaWVsZCA9ICcqJztcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQuc2VhcmNoLnZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQuc2VhcmNoLnZhbHVlID0gZXZlbnQuc2VhcmNoLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBzZWFyY2hQYXJhbS5zZWFyY2hGaWVsZCA9IHNmaWVsZDtcclxuICAgICAgICAgICAgICAgIHNlYXJjaFBhcmFtLnNlYXJjaFZhbHVlID0gZXZlbnQuc2VhcmNoLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgc2VhcmNoUGFyYW0uc2VhcmNoVHlwZSA9ICBldmVudC5zZWFyY2gudHlwZSB8fCAnbGlrZSc7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LnNlYXJjaC52YWx1ZSA9PT0gJycgJiYgc2VhcmNoUGFyYW0uY2F0ZWdvcnkgPT09ICdzZWFyY2gnICYmICghcGFyYW1zLnNlYXJjaENvbmRpdGlvbnMgJiYgIXBhcmFtcy5uYXZTZWFyY2hDb25kaXRpb25zKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlYXJjaFBhcmFtLmNhdGVnb3J5ID0gJ2FsbCc7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChldmVudC5zb3J0TmFtZSkge1xyXG4gICAgICAgICAgICAgICAgc2VhcmNoUGFyYW0uc29ydE5hbWUgPSBldmVudC5zb3J0TmFtZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoZXZlbnQuc29ydE9yZGVyKSB7XHJcbiAgICAgICAgICAgICAgICBzZWFyY2hQYXJhbS5zb3J0T3JkZXIgPSBldmVudC5zb3J0T3JkZXI7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIOWIhuWxguWKoOi9veaUr+aMgeiuvue9ruWxleW8gOWxgue6p1xyXG4gICAgICAgICAgICBpZiAoIWlzTmFOKE51bWJlcihldmVudC5leHBhbmRMZXZlbCkpICYmIHRoaXMuaW5zLmlzVHJlZSgpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyDliY3nq68gLTEg5LiN5bGV5byAICAgMCDlhajlsZXlvIBcclxuICAgICAgICAgICAgICAgIC8vIOWQjuerryAgMCDkuI3lsZXlvIAgIC0xIOWFqOWxleW8gFxyXG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LmV4cGFuZExldmVsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50LmV4cGFuZExldmVsID09PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBldmVudC5leHBhbmRMZXZlbCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC5leHBhbmRMZXZlbCA9IC0xO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgc2VhcmNoUGFyYW1bJ2xheWVyTnVtJ10gPSBldmVudC5leHBhbmRMZXZlbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHR5cGUgPT09ICdmYXYnICYmIGV2ZW50LmZhdm9yaXRlSWRzKSB7XHJcbiAgICAgICAgICAgIHNlYXJjaFBhcmFtLmZhdm9yaXRlSWRzID0gZXZlbnQuZmF2b3JpdGVJZHM7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuaXNUcmVlKCkgfHwgdGhpcy5pbnMuZGlzcGxheVR5cGUgPT09IExvb2t1cEdyaWREaXNwbGF5VHlwZS5OYXZUcmVlTGlzdCkge1xyXG4gICAgICAgICAgICBwYXJhbXMuZW5hYmxlRnVsbFRyZWUgPSB0aGlzLmlucy5lbmFibGVGdWxsVHJlZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHBhcmFtcy50cmVlVG9MaXN0ID0gdGhpcy5pbnMudHJlZVRvTGlzdDtcclxuICAgICAgICBwYXJhbXMubmF2VHJlZVRvTGlzdCA9IHRoaXMuaW5zLm5hdlRyZWVUb0xpc3Q7XHJcblxyXG4gICAgICAgIC8vIOafpeivouaXtuS4jeaehOmAoOWujOaVtOagkVxyXG4gICAgICAgIGlmICh0eXBlID09PSAndGV4dGNoYW5nZScpIHtcclxuICAgICAgICAgICAgcGFyYW1zLmVuYWJsZUZ1bGxUcmVlID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodHlwZSA9PT0gJ3NlbGVjdGVkJykge1xyXG4gICAgICAgICAgICBzZWFyY2hQYXJhbS5jYXRlZ29yeSA9ICdmYXYnO1xyXG4gICAgICAgICAgICBwYXJhbXMuZW5hYmxlRnVsbFRyZWUgPSBmYWxzZTtcclxuICAgICAgICAgICAgc2VhcmNoUGFyYW0uZmF2b3JpdGVJZHMgPSBldmVudC5mYXZvcml0ZUlkcztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHBhcmFtcy5zZWFyY2hWYWx1ZSA9IEpTT04uc3RyaW5naWZ5KHNlYXJjaFBhcmFtKTtcclxuICAgICAgICBwYXJhbXMubG9hZFRyZWVEYXRhVHlwZSA9IHRoaXMuaW5zLmxvYWRUcmVlRGF0YVR5cGU7XHJcblxyXG4gICAgICAgIHBhcmFtcy5jdXN0b21EYXRhID0gdGhpcy5pbnMuY3VzdG9tRGF0YTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmhlbHBJZCkge1xyXG4gICAgICAgICAgICBwYXJhbXMuaGVscElkID0gdGhpcy5pbnMuaGVscElkO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGV2ZW50LnNlbGVjdGVkSW5mbykge1xyXG4gICAgICAgICAgICBwYXJhbXMuc2VsZWN0ZWRJbmZvID0gZXZlbnQuc2VsZWN0ZWRJbmZvO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGV2ZW50Lm5hdk5vZGVQYXRoQ29kZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHBhcmFtcy5uYXZQYXRoQ29kZSA9IGV2ZW50Lm5hdk5vZGVQYXRoQ29kZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gJ25hdkFsbENoaWxkcmVuJykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmluY2x1ZGVTdWJvcmRpbmF0ZXMgJiYgdGhpcy5pbnNbJ25hdk5vZGVQYXRoQ29kZSddKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zLm5hdlBhdGhDb2RlID0gdGhpcy5pbnNbJ25hdk5vZGVQYXRoQ29kZSddO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gcGFyYW1zO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBnZXREYXRhKGV2ZW50PzogYW55LCB0eXBlOiBMT0FEX0RBVEFfVFlQRSA9ICdhbGwnKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgICAgICBjb25zdCB1cmkgPSB0aGlzLmlucy5ncmlkT3B0aW9ucy51cmk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5pc0RvdWJsbGVMaXN0KCkgJiYgIHRoaXMuaW5zLm5hdmlnYXRpb25GaWx0ZXIgJiYgdGhpcy5pbnMubmF2aWdhdGlvbkZpbHRlci5pZFZhbHVlICYmIHR5cGUgIT09ICdmYXYnKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5pbmNsdWRlU3Vib3JkaW5hdGVzICYmIHRoaXMuaW5zLm5hdmlnYXRpb25PcHRpb25zLnRyZWVJbmZvLmxvYWREYXRhVHlwZSA9PT0gJ2FzeW5jJykge1xyXG4gICAgICAgICAgICAgICAgdHlwZSA9ICduYXZBbGxDaGlsZHJlbic7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0eXBlID0gJ2xpc3QnO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBwYXJhbXMgPSB0aGlzLmJ1aWxkUXVlcnlQYXJhbXMoZXZlbnQsIHR5cGUpO1xyXG5cclxuICAgICAgICBpZiAodXJpIHx8IHRoaXMuaW5zLmJlVXJpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5iZVVyaSAmJiB0aGlzLmlucy5jb2x1bW5zICYmIHRoaXMuaW5zLmNvbHVtbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhbGxTZWFyY2hGaWVsZHMgPSB0aGlzLmlucy5jb2x1bW5zLm1hcChjb2wgPT4gY29sLnNlYXJjaEZpZWxkKS5maWx0ZXIoZiA9PiBmKTtcclxuICAgICAgICAgICAgICAgIGlmICghcGFyYW1zLmNvbmRpdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtcy5jb25kaXRpb24gPSB7fTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaW5zLmlzVHJlZSgpICYmIHRoaXMuaW5zLnBhZ2luYXRpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB7IHBhZ2VTaXplID0gdGhpcy5pbnMucGFnZVNpemUgfHwgMjAsIHBhZ2VJbmRleCB9ID0geyAuLi5wYXJhbXMgfTtcclxuICAgICAgICAgICAgICAgICAgICBwYXJhbXMuY29uZGl0aW9uLnBhZ2luYXRpb24gPSB7IHBhZ2VTaXplLCBwYWdlSW5kZXggfTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zLmNvbmRpdGlvbi5wYWdpbmF0aW9uID0geyBpc1VzZVBhZ2luYXRpb246IGZhbHNlIH07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzZWFyY2hQYXJhbSA9IEpTT04ucGFyc2UocGFyYW1zLnNlYXJjaFZhbHVlKTtcclxuICAgICAgICAgICAgICAgIGlmIChzZWFyY2hQYXJhbS5zZWFyY2hWYWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtcy5jb25kaXRpb24gPSB0aGlzLmlucy5sb29rdXBVdGlscy5tZXJnZUNvbmRpdGlvbihwYXJhbXMuY29uZGl0aW9uLCBhbGxTZWFyY2hGaWVsZHMsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQ6IHNlYXJjaFBhcmFtLnNlYXJjaEZpZWxkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogc2VhcmNoUGFyYW0uc2VhcmNoVmFsdWVcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgX3VyaSA9IHRoaXMuaW5zLmJlVXJpIHx8IHVyaTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5odHRwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5odHRwLmNvbnRleHQgPSB0aGlzLmlucy5jb250ZXh0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5fc2VhcmNoUmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb2YodGhpcy5pbnMuX3NlYXJjaFJlc3VsdCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICh0eXBlICE9PSAnYWxsQ2hpbGRyZW4nKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbnMuaHR0cC5nZXREYXRhKF91cmksIHBhcmFtcyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJhbXMxID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlYXJjaFZhbHVlOiBKU09OLnN0cmluZ2lmeSh7IGNhdGVnb3J5OiB0eXBlIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudHNJZHM6IGV2ZW50LnBhcmVudHNJZHMsXHJcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRGF0YTogcGFyYW1zLmN1c3RvbURhdGEsXHJcbiAgICAgICAgICAgICAgICAgICAgaGVscElkOiBwYXJhbXMuaGVscElkXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5zLmh0dHAuZ2V0RGF0YShfdXJpLCBwYXJhbXMxKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIGdldEZhdm9yaXRlRGF0YShwYXJhbXMpIHtcclxuICAgIC8vICAgICByZXR1cm4gdGhpcy5nZXREYXRhKHBhcmFtcywgJ2ZhdicpO1xyXG4gICAgLy8gfVxyXG5cclxuICAgIGdldFNlbGVjZWRJdGVtcyhzZWxJZHM6IGFueVtdKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGF0YSh7IGZhdm9yaXRlSWRzOiBzZWxJZHMgfSwgJ3NlbGVjdGVkJyk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UGVyc29uYWxDb25maWcoKSB7XHJcbiAgICAgICAgY29uc3QgZGVmYXVsdENvbmYgPSBjbG9uZURlZXAoRGVmYXVsdFVzZXJDb25maWcpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIGlmICh0aGlzLmlucy5jdXN0b21EYXRhKSB7XHJcbiAgICAgICAgLy8gICAgIGNvbnN0IHdyYXBLZXlEYXRhID0gSlNPTi5zdHJpbmdpZnkoeyBrZXk6IHRoaXMuaW5zLmN1c3RvbURhdGEgfSk7XHJcbiAgICAgICAgLy8gICAgIGNvbnN0IGNvbmZpZ0tleVN0cmluZyA9IHRoaXMuaW5zLmdldExvb2t1cEJpbmRpbmdGaWVsZHMoKSArIHdyYXBLZXlEYXRhO1xyXG4gICAgICAgIC8vICAgICB0aGlzLmlucy5wZXJzb25hbENvbmZpZ1NlcnZpY2UucGVyc29uYWxDb25maWdLZXkgPSBjb25maWdLZXlTdHJpbmc7XHJcbiAgICAgICAgLy8gfVxyXG4gICAgICAgIGNvbnN0IGtleSA9IHRoaXMuaW5zLnBlcnNvbmFsQ29uZmlnU2VydmljZS5fbmV3S2V5O1xyXG5cclxuICAgICAgICBsZXQgX2NvbmYgPSB0aGlzLmlucy5wZXJzb25hbENvbmZpZ1NlcnZpY2UuZ2V0UGVyc29uYWxEYXRhKGtleSk7XHJcblxyXG4gICAgICAgIGlmICghX2NvbmYgfHwgIU9iamVjdC5rZXlzKF9jb25mKS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgX2NvbmYgPSBkZWZhdWx0Q29uZjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcmVxID0gb2YoX2NvbmYpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuZmF2b3JpdGVEYXRhRnJvbSA9PT0gJ2xvY2FsZScgfHwgdGhpcy5pbnMuaXNUYWJDaGFuZ2VkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXE7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuaHR0cCAmJiB0aGlzLmlucy5odHRwWydnZXRVc2VyU2V0dGluZ3MnXSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pbnMuaHR0cFsnZ2V0VXNlclNldHRpbmdzJ10oa2V5KS5waXBlKFxyXG4gICAgICAgICAgICAgICAgdGFwKChyOiBhbnkpID0+IHsgLy8gVEZTIDYxMTk1M1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyICYmIHIudGV4dFZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleSwgci50ZXh0VmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleSwgSlNPTi5zdHJpbmdpZnkoZGVmYXVsdENvbmYpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgIG1hcCgodWNzOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodWNzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1Y3MudGV4dFZhbHVlID8gSlNPTi5wYXJzZSh1Y3MudGV4dFZhbHVlKSA6IGRlZmF1bHRDb25mO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdENvbmY7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXE7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGxvb2t1cFJlcXVlc3QoZXZlbnQ/OiBhbnksIHR5cGU6IExPQURfREFUQV9UWVBFID0gJ2FsbCcsIGlzUXVpY2tTZWxlY3QgPSBmYWxzZSkge1xyXG4gICAgICAgIGlmICghdGhpcy5pbnMudXNlUGVyc2lvbmFsQ29uZiB8fCBpc1F1aWNrU2VsZWN0KSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERhdGEoZXZlbnQsIHR5cGUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgcmVxID0gdGhpcy5nZXRQZXJzb25hbENvbmZpZygpO1xyXG5cclxuICAgICAgICByZXR1cm4gcmVxLnBpcGUoXHJcbiAgICAgICAgICAgIHRhcCgoYzogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5wZXJzb25hbENvbmYgPSBjO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMucGVyc29uYWxDb25maWdTZXJ2aWNlLnNhdmVQZXJzb25hbENvbmZpZyhjKTtcclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5pbnMuaXNUYWJDaGFuZ2VkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fb3JpZ2luYWxQZXJzb25hbENvbmZpZyA9IGNsb25lRGVlcChjKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoYzogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB7IHRhYkluZGV4LCBmYXZvcml0ZSwgc2l6ZSwgY2FzY2FkZVN0YXR1cyB9ID0gYztcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaW5zLmlzVGFiQ2hhbmdlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmFjdGl2ZVRhYiA9IHRhYkluZGV4IHx8ICdkYXRhbGlzdCc7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHNpemUpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5kaWFsb2dXaWR0aCA9IHNpemUud2lkdGg7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuZGlhbG9nSGVpZ2h0ID0gc2l6ZS5oZWlnaHQ7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pbnMuaXNUYWJDaGFuZ2VkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmRpYWxvZy5yZVNpemUoeyB3aWR0aDogc2l6ZS53aWR0aCwgaGVpZ2h0OiBzaXplLmhlaWdodCB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAgICAgICAgIGlmICggdGhpcy5pbnMuY2FzY2FkZVN0YXR1cykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjYXNjYWRlU3RhdHVzICYmIHRoaXMuaW5zLmVuYWJsZUNhc2NhZGUgJiYgdGhpcy5pbnMuc2hvd0Nhc2NhZGVDb250cm9sKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmNhc2NhZGVTdGF0dXMgPSBjYXNjYWRlU3RhdHVzO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmNhc2NhZGVJdGVtcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBrZXlzID0gWydlbmFibGUnLCAndXAnLCAnZG93bicsICdkaXNhYmxlJ107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleXMuZm9yRWFjaChuID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlucy5jYXNjYWRlSXRlbXNbbl0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmNhc2NhZGVJdGVtc1tuXSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlucy5jYXNjYWRlSXRlbXNbdGhpcy5pbnMuY2FzY2FkZVN0YXR1c10gKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXModGhpcy5pbnMuY2FzY2FkZUl0ZW1zKS5tYXAobiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5zLmNhc2NhZGVJdGVtc1tuXSA/IG46ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkuZmlsdGVyKG4gPT4gbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5jYXNjYWRlU3RhdHVzID0ga2V5c1swXSBhcyBhbnk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmFjdGl2ZVRhYiA9PT0gJ2RhdGFsaXN0Jykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERhdGEoZXZlbnQsIHR5cGUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlucy5hY3RpdmVUYWIgPT09ICdmYXZvcml0ZScpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBmYXZJZHMgPSBmYXZvcml0ZSA/IGZhdm9yaXRlW3RoaXMuaW5zLmxvY2FsU2VydmljZS5sb2NhbGVJZF0gOiBbXTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoKCFmYXZJZHMgfHwgIWZhdklkcy5sZW5ndGgpICYmICF0aGlzLmlucy5pc1RhYkNoYW5nZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGF0YShldmVudCwgJ2FsbCcpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXAociA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHIgJiYgIXIuaXRlbXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgci5pdGVtcyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByLmFjdGl2ZVRhYiA9ICdkYXRhbGlzdCc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gY29uc3QgX2ZpZHMgPSBmYXZJZHMuZmlsdGVyKG4gPT4gbik7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQuZmF2b3JpdGVJZHMgPSBmYXZJZHM7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQuc2VhcmNoID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXREYXRhKGV2ZW50LCAnZmF2JykucGlwZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoTWFwKHIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXRlbXMgPSByID8gci5pdGVtcyB8fCBbXSA6IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8g5Yqg5YWl5pWw5o2u5p2D6ZmQ5ZCO77yM5rKh5pyJ6L+U5Zue5pWw5o2u5LiU56ysMeasoeaJk+W8gOeql+WPo++8jOmdnuaJi+WKqOeCueWHu+aUtuiXj+agh+etvuaXtlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpdGVtcy5sZW5ndGggJiYgIXRoaXMuaW5zLmlzVGFiQ2hhbmdlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERhdGEoZXZlbnQsICdhbGwnKS5waXBlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXAoYSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYSAmJiAhYS5pdGVtcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEuaXRlbXMgPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEuYWN0aXZlVGFiID0gJ2RhdGFsaXN0JztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlucy5hY3RpdmVUYWIgPT09ICdzZWxlY3RlZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzZWxJZHMgPSB0aGlzLmlucy5kaXNwbGF5VmFsdWUgPyB0aGlzLmlucy5kaXNwbGF5VmFsdWUuc3BsaXQoJywnKSA6IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IF9zaWRzID0gc2VsSWRzLmZpbHRlcihuID0+IG4pO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFNlbGVjZWRJdGVtcyhfc2lkcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDkv53lrZjkuKrmgKfljJbmlbDmja5cclxuICAgIHN1Ym1pdEZhdm9yaXRlRGF0YShhY3Rpb246IGFueSB8IEZhdm9yaXRlQWN0aW9uKSB7XHJcblxyXG4gICAgICAgIC8vIOS/neWtmOWIl+WuveW6plxyXG4gICAgICAgIHRoaXMuaW5zLnBlcnNvbmFsQ29uZi5jb2xTaXplSW5mbyA9IHRoaXMuZ2V0Q29sdW1uU2l6ZUluZm8oKTtcclxuXHJcbiAgICAgICAgLy8g5aaC5p6c5pWw5o2u5LiO6buY6K6k55qE5pWw5o2u5LiA6Iez5YiZ5LiN5L+d5a2Y44CCXHJcbiAgICAgICAgaWYgKEpTT04uc3RyaW5naWZ5KHRoaXMuaW5zLnBlcnNvbmFsQ29uZikgPT09IEpTT04uc3RyaW5naWZ5KHRoaXMuX29yaWdpbmFsUGVyc29uYWxDb25maWcpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBtc2cgPSAnJztcclxuICAgICAgICBpZiAoYWN0aW9uID09PSBGYXZvcml0ZUFjdGlvbi5hZGQpIHtcclxuICAgICAgICAgICAgbXNnID0gdGhpcy5pbnMuYWRkRmF2b3JpdGVTdWNjZXNzO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSBGYXZvcml0ZUFjdGlvbi5kZWxldGUpIHtcclxuICAgICAgICAgICAgbXNnID0gdGhpcy5pbnMuZGVsRmF2b3JpdGVTdWNjZXNzO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDmm7TmlrDmnKzlnLDnvJPlrZhcclxuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmlucy5wZXJzb25hbENvbmZpZ1NlcnZpY2UuX25ld0tleSwgSlNPTi5zdHJpbmdpZnkodGhpcy5pbnMucGVyc29uYWxDb25mKSk7XHJcbiAgICAgICAgdGhpcy5pbnMucGVyc29uYWxDb25maWdTZXJ2aWNlLnNhdmVQZXJzb25hbENvbmZpZyh0aGlzLmlucy5wZXJzb25hbENvbmYgfHwge30pO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuZmF2b3JpdGVEYXRhRnJvbSAhPT0gJ2xvY2FsZScpIHtcclxuICAgICAgICAgICAgdGhpcy5fb3JpZ2luYWxQZXJzb25hbENvbmZpZyA9IGNsb25lRGVlcCh0aGlzLmlucy5wZXJzb25hbENvbmYpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgY29uZmlnRGF0YTogVXNlckZhdm9yaXRlRGF0YSA9IHtcclxuICAgICAgICAgICAgICAgIGNvbmZpZ2tleTE6IHRoaXMuaW5zLnBlcnNvbmFsQ29uZmlnU2VydmljZS5wZXJzb25hbENvbmZpZ0tleSxcclxuICAgICAgICAgICAgICAgIGNvbmZpZ2tleTI6ICcnLFxyXG4gICAgICAgICAgICAgICAgY29uZmlna2V5MzogJycsXHJcbiAgICAgICAgICAgICAgICB0ZXh0dmFsdWU6IEpTT04uc3RyaW5naWZ5KHRoaXMuaW5zLnBlcnNvbmFsQ29uZilcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5odHRwICYmIHRoaXMuaW5zLmh0dHBbJ3NhdmVVc2VyU2V0dGluZ3MnXSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMuc2F2aW5nRmFvcml0ZURhdGEgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMuc2hvd0xvYWRpbmcoKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmlucy5odHRwWydzYXZlVXNlclNldHRpbmdzJ10oY29uZmlnRGF0YSkuc3Vic2NyaWJlKChyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuc2F2aW5nRmFvcml0ZURhdGEgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5jbG9zZUxvYWRpbmcoKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobXNnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLm5vdGlmeVNlcnZpY2Uuc3VjY2Vzcyhtc2cpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKG1zZykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLm5vdGlmeVNlcnZpY2Uuc3VjY2Vzcyhtc2cpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKG1zZykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMubm90aWZ5U2VydmljZS5zdWNjZXNzKG1zZyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRDb2x1bW5TaXplSW5mbygpIHtcclxuICAgICAgICBjb25zdCBjb2xTaXplSW5mbyA9IHtkYXRhOiB7fSwgbmF2OiB7fSwgZmF2OiB7fSwgc2VsOiB7fX07XHJcbiAgICAgICAgY29sU2l6ZUluZm8uZGF0YSA9IHRoaXMuaW5zLmNvbHVtbnMuZmlsdGVyKChjKSA9PiBjLmZpZWxkICE9PSBGQVZPUklURV9GSUVMRF9OQU1FKS5yZWR1Y2UoKHIsIG4pID0+IHtcclxuICAgICAgICAgICAgcltuLmZpZWxkXSA9IG4ud2lkdGg7XHJcbiAgICAgICAgICAgIHJldHVybiByO1xyXG4gICAgICAgIH0sIHt9KTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmZhdm9yaXRlQ29sdW1ucyAmJiB0aGlzLmlucy5mYXZvcml0ZUNvbHVtbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGNvbFNpemVJbmZvLmZhdiA9IHRoaXMuaW5zLmZhdm9yaXRlQ29sdW1ucy5maWx0ZXIoKGMpID0+IGMuZmllbGQgIT09IEZBVk9SSVRFX0ZJRUxEX05BTUUpLnJlZHVjZSgociwgbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgcltuLmZpZWxkXSA9IG4ud2lkdGg7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcjtcclxuICAgICAgICAgICAgfSwge30pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLm5hdmlnYXRpb25PcHRpb25zICYmIHRoaXMuaW5zLm5hdmlnYXRpb25PcHRpb25zLmNvbHVtbnMgJiYgdGhpcy5pbnMubmF2aWdhdGlvbk9wdGlvbnMuY29sdW1ucy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgY29sU2l6ZUluZm8ubmF2ID0gdGhpcy5pbnMubmF2aWdhdGlvbk9wdGlvbnMuY29sdW1ucy5maWx0ZXIoKGMpID0+IGMuZmllbGQgIT09IEZBVk9SSVRFX0ZJRUxEX05BTUUpLnJlZHVjZSgociwgbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgcltuLmZpZWxkXSA9IG4ud2lkdGg7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcjtcclxuICAgICAgICAgICAgfSwge30pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLnNlbGVjdGVkQ29sdW1ucyAmJiB0aGlzLmlucy5zZWxlY3RlZENvbHVtbnMubGVuZ3RoICYmIHRoaXMuaW5zLnNob3dTZWxlY3RlZCkge1xyXG4gICAgICAgICAgICBjb2xTaXplSW5mby5zZWwgPSB0aGlzLmlucy5zZWxlY3RlZENvbHVtbnMuZmlsdGVyKChjKSA9PiBjLmZpZWxkICE9PSBGQVZPUklURV9GSUVMRF9OQU1FKS5yZWR1Y2UoKHIsIG4pID0+IHtcclxuICAgICAgICAgICAgICAgIHJbbi5maWVsZF0gPSBuLndpZHRoO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHI7XHJcbiAgICAgICAgICAgIH0sIHt9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmV0dXJuIGNvbFNpemVJbmZvO1xyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=