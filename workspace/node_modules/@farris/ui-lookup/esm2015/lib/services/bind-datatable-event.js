/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of } from 'rxjs';
import { catchError, tap } from 'rxjs/operators';
import { FavoriteAction, FAVORITE_FIELD_NAME } from '../lookup-displaytype';
export class DataTableEventManager {
    /**
     * @param {?} ins
     */
    constructor(ins) {
        this.ins = ins;
        this._sortState = null;
        this.lookupSelectionSer = this.ins.lookupSelectionSer;
    }
    /**
     * @param {?} conditions
     * @return {?}
     */
    conditionsChange(conditions) {
        this.ins.conditions = conditions;
        if (conditions && conditions.length === 1 && conditions[0].code == '*') {
            this.ins.conditions = [];
            this.onSearch({ field: '*', value: conditions[0].value });
        }
        else {
            this.onSearch();
        }
    }
    /**
     * @param {?=} $event
     * @return {?}
     */
    onSearch($event = { field: '*', value: '' }) {
        if ($event && $event.field !== '*' && !$event.value) {
            this.ins.messagerService.warning(this.ins.mustWriteSomething);
            return;
        }
        /** @type {?} */
        const p = {
            pageInfo: { pageIndex: 1, pageSize: this.ins.gridOptions.pageSize },
            search: $event
        };
        if (this._sortState) {
            const { sortName, sortOrder } = this._sortState;
            if (sortName) {
                p['sortName'] = sortName;
                p['sortOrder'] = sortOrder;
            }
        }
        if (this.ins.uri) {
            if (!this.ins.searching) {
                this.ins.searching = true;
                if (this.ins['navNodePathCode']) {
                    p['navNodePathCode'] = this.ins['navNodePathCode'];
                }
                this.ins.httpMgr.getData(p, 'list').pipe(catchError((/**
                 * @param {?} err
                 * @return {?}
                 */
                err => {
                    this.ins.searching = false;
                    return of({ "_ERROR_": err });
                })), tap((/**
                 * @return {?}
                 */
                () => {
                    this.ins.searching = false;
                }))).subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                data => {
                    this.ins.searching = false;
                    this.ins.closeLoading();
                    if (!data['_ERROR_']) {
                        this._loadData(data);
                    }
                    else {
                        throw new Error(data['_ERROR_']);
                    }
                }));
            }
        }
        else {
            if (this.ins.enableMultiFieldSearch) {
                this.ins.query.emit({ conditions: this.ins.conditions, instance: this.ins });
            }
            else {
                this.ins.search.emit(p);
            }
        }
    }
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    _loadData(data) {
        /** @type {?} */
        const self = this.ins;
        self.closeLoading();
        self.favHelper.updateFavoritesStatus(data.items);
        self.loadDataTableData(data);
        // 选中数据
        this.ins.selectionMgr.selectCurrentValue();
    }
    /**
     * @return {?}
     */
    bindDataTableEvent() {
        /** @type {?} */
        const self = this.ins;
        /** @type {?} */
        const dt = (/** @type {?} */ (self.componentRef.instance));
        dt.selectedRow.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (this.ins.singleSelect) {
                this.lookupSelectionSer.clearSelections();
            }
            this.ins.checkedChange.emit({ data: [e.data], isCheck: true });
            this.lookupSelectionSer.updateSelections([e.data]);
            dt.cd.detectChanges();
        }));
        dt.unSelectRow.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        e => {
            this.lookupSelectionSer.unSelect(e.data[self.idField]);
            this.ins.checkedChange.emit({ data: [e.data], isCheck: false });
        }));
        dt.checkAll.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            this.lookupSelectionSer.updateSelections(dt.data, e);
            this.ins.checkedChange.emit({ data: dt.data, isCheck: e });
        }));
        dt.pageChanged.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (self.uri) {
                self.httpMgr.getData(e, 'list').subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                (data) => {
                    this._loadData(data);
                }));
            }
            else {
                self.pagerChanged.emit(self.httpMgr.buildQueryParams(e, 'list'));
            }
        }));
        dt.pageSizeChanged.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        e => {
            if (self.uri) {
                self.httpMgr.getData(e, 'list').subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                data => {
                    this._loadData(data);
                }), (/**
                 * @param {?} err
                 * @return {?}
                 */
                err => {
                    self.closeLoading();
                }));
            }
            else {
                self.pagerChanged.emit(self.httpMgr.buildQueryParams(e, 'list'));
            }
        }));
        dt.search.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            // if (JSON.stringify(self._searchState || {}) !== JSON.stringify(e || {})) {
            //     this.ins.searching = false;
            // }
            self._searchState = Object.assign({}, (e || {}));
            this.onSearch(e);
        }));
        dt.searchValueChange.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (e && e.value) {
                self._searchState = Object.assign({}, e);
            }
            else {
                self._searchState = null;
            }
        }));
        // 双击事件
        dt.rowDblClick.subscribe((/**
         * @param {?} rowData
         * @return {?}
         */
        (rowData) => {
            if (self.gridOptions.singleSelect) {
                // this.lookupSelectionSer.updateSelections([rowData]);
                self.selectItem(rowData);
            }
        }));
        // 收藏事件
        if (!dt.cellClick.observers.length) {
            dt.cellClick.subscribe((/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                if (e.col.field === FAVORITE_FIELD_NAME) {
                    /** @type {?} */
                    const classList = e.event.target['classList'];
                    if (classList.contains('f-lookup-favorite')) {
                        e.event.stopPropagation();
                        self.items.forEach((/**
                         * @param {?} item
                         * @return {?}
                         */
                        item => {
                            /** @type {?} */
                            const id = self.utils.getValue(self.idField, item);
                            if (id === self.utils.getValue(self.idField, e.row)) {
                                item[FAVORITE_FIELD_NAME] = !item[FAVORITE_FIELD_NAME];
                            }
                        }));
                        dt.loadData({
                            pageSize: self.gridOptions.pageSize,
                            pageIndex: self.gridOptions.pageIndex,
                            total: self.gridOptions.total,
                            data: self.gridOptions.items
                        });
                        // 更新收藏数据
                        /** @type {?} */
                        const faction = e.row[FAVORITE_FIELD_NAME] ? FavoriteAction.add : FavoriteAction.delete;
                        if (faction === FavoriteAction.add) {
                            this.ins.favoriteItems = [...this.ins.favoriteItems, e.row];
                        }
                        else {
                            this.ins.favoriteItems = this.ins.favoriteItems.filter((/**
                             * @param {?} n
                             * @return {?}
                             */
                            n => {
                                return self.utils.getValue(self.idField, n) !== self.utils.getValue(self.idField, e.row);
                            }));
                        }
                        this.lookupSelectionSer.updateFavoriteData(e.row, faction);
                    }
                }
            }));
        }
        dt.columnSorted.subscribe((/**
         * @param {?} sort
         * @return {?}
         */
        (sort) => {
            this._sortState = sort;
            if (!this.ins.remoteSort) {
                return;
            }
            const { sortName, sortOrder } = Object.assign({}, sort);
            /** @type {?} */
            const col = this.ins.columns.find((/**
             * @param {?} n
             * @return {?}
             */
            n => n.field === sortName));
            /** @type {?} */
            const _sortName = col ? col.fieldPath ? col.fieldPath : col.field : sortName;
            /** @type {?} */
            const param = {
                sortName: _sortName,
                sortOrder,
                search: self._searchState,
                pageInfo: {
                    pageSize: self.pageSize,
                    pageIndex: 1
                }
            };
            self.httpMgr.getData(param, 'search').subscribe((/**
             * @param {?} d
             * @return {?}
             */
            d => {
                self.loadDataTableData(d);
                self.closeLoading();
                // 选中数据 TFS 615008
                this.ins.selectionMgr.selectCurrentValue();
            }));
        }));
        dt.clearSearchValue.subscribe((/**
         * @return {?}
         */
        () => {
            self._searchState = null;
            this.onSearch();
        }));
        dt.cellStyler = (/**
         * @param {?} val
         * @return {?}
         */
        (val) => {
            const { field } = val;
            if (field === FAVORITE_FIELD_NAME) {
                return {
                    'text-overflow': 'unset'
                };
            }
            return null;
        });
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    DataTableEventManager.prototype.lookupSelectionSer;
    /**
     * @type {?}
     * @private
     */
    DataTableEventManager.prototype._sortState;
    /**
     * @type {?}
     * @private
     */
    DataTableEventManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZC1kYXRhdGFibGUtZXZlbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9iaW5kLWRhdGF0YWJsZS1ldmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQ0EsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxQixPQUFPLEVBQUUsVUFBVSxFQUFRLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxjQUFjLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUs1RSxNQUFNLE9BQU8scUJBQXFCOzs7O0lBTTlCLFlBQW9CLEdBQXdCO1FBQXhCLFFBQUcsR0FBSCxHQUFHLENBQXFCO1FBRnBDLGVBQVUsR0FBRyxJQUFJLENBQUM7UUFHdEIsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUM7SUFDMUQsQ0FBQzs7Ozs7SUFFRCxnQkFBZ0IsQ0FBQyxVQUFVO1FBQ3ZCLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUNqQyxJQUFJLFVBQVUsSUFBSSxVQUFVLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLEdBQUcsRUFBRTtZQUNwRSxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7WUFDekIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1NBQzdEO2FBQU07WUFDSCxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7U0FDbkI7SUFDTCxDQUFDOzs7OztJQUVELFFBQVEsQ0FBQyxTQUEyQyxFQUFFLEtBQUssRUFBRSxHQUFH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aEIsQ0FBQyxDQUFBLENBQUE7SUFDTCxDQUFDO0NBQ0o7Ozs7OztJQWxQRyxtREFBbUQ7Ozs7O0lBRW5ELDJDQUEwQjs7Ozs7SUFFZCxvQ0FBZ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEYXRhVGFibGVDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWRhdGF0YWJsZSc7XHJcbmltcG9ydCB7IG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGNhdGNoRXJyb3IsIHRha2UsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgRmF2b3JpdGVBY3Rpb24sIEZBVk9SSVRFX0ZJRUxEX05BTUUgfSBmcm9tICcuLi9sb29rdXAtZGlzcGxheXR5cGUnO1xyXG5pbXBvcnQgeyBMb29rdXBHcmlkUmVzdWx0IH0gZnJvbSAnLi4vbG9va3VwLWdyaWQtb3B0aW9ucyc7XHJcbmltcG9ydCB7IExvb2t1cEdyaWRDb21wb25lbnQgfSBmcm9tICcuLi9sb29rdXAtZ3JpZC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBMb29rdXBTZWxlY3Rpb25TZXJ2aWNlIH0gZnJvbSAnLi9sb29rdXAtc2VsZWN0aW9uLnNlcnZpY2UnO1xyXG5cclxuZXhwb3J0IGNsYXNzIERhdGFUYWJsZUV2ZW50TWFuYWdlciB7XHJcblxyXG4gICAgcHJpdmF0ZSBsb29rdXBTZWxlY3Rpb25TZXI6IExvb2t1cFNlbGVjdGlvblNlcnZpY2U7XHJcblxyXG4gICAgcHJpdmF0ZSBfc29ydFN0YXRlID0gbnVsbDtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluczogTG9va3VwR3JpZENvbXBvbmVudCkge1xyXG4gICAgICAgIHRoaXMubG9va3VwU2VsZWN0aW9uU2VyID0gdGhpcy5pbnMubG9va3VwU2VsZWN0aW9uU2VyO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbmRpdGlvbnNDaGFuZ2UoY29uZGl0aW9ucykge1xyXG4gICAgICAgIHRoaXMuaW5zLmNvbmRpdGlvbnMgPSBjb25kaXRpb25zO1xyXG4gICAgICAgIGlmIChjb25kaXRpb25zICYmIGNvbmRpdGlvbnMubGVuZ3RoID09PSAxICYmIGNvbmRpdGlvbnNbMF0uY29kZSA9PSAnKicpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMuY29uZGl0aW9ucyA9IFtdO1xyXG4gICAgICAgICAgICB0aGlzLm9uU2VhcmNoKHsgZmllbGQ6ICcqJywgdmFsdWU6IGNvbmRpdGlvbnNbMF0udmFsdWUgfSk7ICAgIFxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMub25TZWFyY2goKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgb25TZWFyY2goJGV2ZW50OiB7IGZpZWxkOiBzdHJpbmc7IHZhbHVlOiBzdHJpbmcgfSA9IHsgZmllbGQ6ICcqJywgdmFsdWU6ICcnIH0pIHtcclxuICAgICAgICBpZiAoJGV2ZW50ICYmICRldmVudC5maWVsZCAhPT0gJyonICYmICEkZXZlbnQudmFsdWUpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMubWVzc2FnZXJTZXJ2aWNlLndhcm5pbmcodGhpcy5pbnMubXVzdFdyaXRlU29tZXRoaW5nKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgcCA9IHtcclxuICAgICAgICAgICAgcGFnZUluZm86IHsgcGFnZUluZGV4OiAxLCBwYWdlU2l6ZTogdGhpcy5pbnMuZ3JpZE9wdGlvbnMucGFnZVNpemUgfSxcclxuICAgICAgICAgICAgc2VhcmNoOiAkZXZlbnRcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpZiAodGhpcy5fc29ydFN0YXRlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHtzb3J0TmFtZSwgc29ydE9yZGVyfSA9IHRoaXMuX3NvcnRTdGF0ZTtcclxuICAgICAgICAgICAgaWYgKHNvcnROYW1lKSB7XHJcbiAgICAgICAgICAgICAgICBwWydzb3J0TmFtZSddID0gc29ydE5hbWU7XHJcbiAgICAgICAgICAgICAgICBwWydzb3J0T3JkZXInXSA9IHNvcnRPcmRlcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLnVyaSkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuaW5zLnNlYXJjaGluZykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMuc2VhcmNoaW5nID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnNbJ25hdk5vZGVQYXRoQ29kZSddKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcFsnbmF2Tm9kZVBhdGhDb2RlJ10gPSB0aGlzLmluc1snbmF2Tm9kZVBhdGhDb2RlJ107XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMuaHR0cE1nci5nZXREYXRhKHAsICdsaXN0JykucGlwZShcclxuICAgICAgICAgICAgICAgICAgICBjYXRjaEVycm9yKGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNlYXJjaGluZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoeyBcIl9FUlJPUl9cIjogZXJyIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNlYXJjaGluZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICApLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgICAgICBkYXRhID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuc2VhcmNoaW5nID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmNsb3NlTG9hZGluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWRhdGFbJ19FUlJPUl8nXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9hZERhdGEoZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZGF0YVsnX0VSUk9SXyddKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pbnMuZW5hYmxlTXVsdGlGaWVsZFNlYXJjaCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMucXVlcnkuZW1pdCh7IGNvbmRpdGlvbnM6IHRoaXMuaW5zLmNvbmRpdGlvbnMsIGluc3RhbmNlOiB0aGlzLmlucyB9KVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMuc2VhcmNoLmVtaXQocCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfbG9hZERhdGEoZGF0YTogTG9va3VwR3JpZFJlc3VsdCkge1xyXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzLmlucztcclxuICAgICAgICBzZWxmLmNsb3NlTG9hZGluZygpO1xyXG4gICAgICAgIHNlbGYuZmF2SGVscGVyLnVwZGF0ZUZhdm9yaXRlc1N0YXR1cyhkYXRhLml0ZW1zKTtcclxuICAgICAgICBzZWxmLmxvYWREYXRhVGFibGVEYXRhKGRhdGEpO1xyXG4gICAgICAgIC8vIOmAieS4reaVsOaNrlxyXG4gICAgICAgIHRoaXMuaW5zLnNlbGVjdGlvbk1nci5zZWxlY3RDdXJyZW50VmFsdWUoKTtcclxuICAgIH1cclxuXHJcbiAgICBiaW5kRGF0YVRhYmxlRXZlbnQoKSB7XHJcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXMuaW5zO1xyXG4gICAgICAgIGNvbnN0IGR0ID0gc2VsZi5jb21wb25lbnRSZWYuaW5zdGFuY2UgYXMgRGF0YVRhYmxlQ29tcG9uZW50O1xyXG5cclxuICAgICBcclxuICAgICAgICBkdC5zZWxlY3RlZFJvdy5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pbnMuc2luZ2xlU2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvb2t1cFNlbGVjdGlvblNlci5jbGVhclNlbGVjdGlvbnMoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmlucy5jaGVja2VkQ2hhbmdlLmVtaXQoeyBkYXRhOiBbZS5kYXRhXSwgaXNDaGVjazogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIudXBkYXRlU2VsZWN0aW9ucyhbZS5kYXRhXSk7XHJcbiAgICAgICAgICAgIGR0LmNkLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICB9KTtcclxuICAgIFxyXG5cclxuICAgICAgICBkdC51blNlbGVjdFJvdy5zdWJzY3JpYmUoZSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwU2VsZWN0aW9uU2VyLnVuU2VsZWN0KGUuZGF0YVtzZWxmLmlkRmllbGRdKTtcclxuICAgICAgICAgICAgdGhpcy5pbnMuY2hlY2tlZENoYW5nZS5lbWl0KHsgZGF0YTogW2UuZGF0YV0sIGlzQ2hlY2s6IGZhbHNlIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkdC5jaGVja0FsbC5zdWJzY3JpYmUoKGU6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIudXBkYXRlU2VsZWN0aW9ucyhkdC5kYXRhLCBlKTtcclxuICAgICAgICAgICAgdGhpcy5pbnMuY2hlY2tlZENoYW5nZS5lbWl0KHsgZGF0YTogZHQuZGF0YSwgaXNDaGVjazogZSB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZHQucGFnZUNoYW5nZWQuc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHNlbGYudXJpKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLmh0dHBNZ3IuZ2V0RGF0YShlLCAnbGlzdCcpLnN1YnNjcmliZSgoZGF0YTogTG9va3VwR3JpZFJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvYWREYXRhKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLnBhZ2VyQ2hhbmdlZC5lbWl0KHNlbGYuaHR0cE1nci5idWlsZFF1ZXJ5UGFyYW1zKGUsICdsaXN0JykpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGR0LnBhZ2VTaXplQ2hhbmdlZC5zdWJzY3JpYmUoZSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChzZWxmLnVyaSkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5odHRwTWdyLmdldERhdGEoZSwgJ2xpc3QnKS5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvYWREYXRhKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZXJyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jbG9zZUxvYWRpbmcoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5wYWdlckNoYW5nZWQuZW1pdChzZWxmLmh0dHBNZ3IuYnVpbGRRdWVyeVBhcmFtcyhlLCAnbGlzdCcpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkdC5zZWFyY2guc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgLy8gaWYgKEpTT04uc3RyaW5naWZ5KHNlbGYuX3NlYXJjaFN0YXRlIHx8IHt9KSAhPT0gSlNPTi5zdHJpbmdpZnkoZSB8fCB7fSkpIHtcclxuICAgICAgICAgICAgLy8gICAgIHRoaXMuaW5zLnNlYXJjaGluZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAvLyB9XHJcbiAgICAgICAgICAgIHNlbGYuX3NlYXJjaFN0YXRlID0gey4uLihlIHx8IHt9KX07XHJcbiAgICAgICAgICAgIHRoaXMub25TZWFyY2goZSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGR0LnNlYXJjaFZhbHVlQ2hhbmdlLnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlICYmIGUudmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuX3NlYXJjaFN0YXRlID0gey4uLmV9O1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5fc2VhcmNoU3RhdGUgPSBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIOWPjOWHu+S6i+S7tlxyXG4gICAgICAgIGR0LnJvd0RibENsaWNrLnN1YnNjcmliZSgocm93RGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChzZWxmLmdyaWRPcHRpb25zLnNpbmdsZVNlbGVjdCkge1xyXG4gICAgICAgICAgICAgICAgLy8gdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIudXBkYXRlU2VsZWN0aW9ucyhbcm93RGF0YV0pO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5zZWxlY3RJdGVtKHJvd0RhdGEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIOaUtuiXj+S6i+S7tlxyXG4gICAgICAgIGlmKCFkdC5jZWxsQ2xpY2sub2JzZXJ2ZXJzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBkdC5jZWxsQ2xpY2suc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlLmNvbC5maWVsZCA9PT0gRkFWT1JJVEVfRklFTERfTkFNRSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNsYXNzTGlzdCA9IGUuZXZlbnQudGFyZ2V0WydjbGFzc0xpc3QnXTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY2xhc3NMaXN0LmNvbnRhaW5zKCdmLWxvb2t1cC1mYXZvcml0ZScpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGUuZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaXRlbXMuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlkID0gc2VsZi51dGlscy5nZXRWYWx1ZShzZWxmLmlkRmllbGQsIGl0ZW0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlkID09PSBzZWxmLnV0aWxzLmdldFZhbHVlKHNlbGYuaWRGaWVsZCwgZS5yb3cpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVtGQVZPUklURV9GSUVMRF9OQU1FXSA9ICFpdGVtW0ZBVk9SSVRFX0ZJRUxEX05BTUVdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZHQubG9hZERhdGEoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnZVNpemU6IHNlbGYuZ3JpZE9wdGlvbnMucGFnZVNpemUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlSW5kZXg6IHNlbGYuZ3JpZE9wdGlvbnMucGFnZUluZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWw6IHNlbGYuZ3JpZE9wdGlvbnMudG90YWwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBzZWxmLmdyaWRPcHRpb25zLml0ZW1zXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8g5pu05paw5pS26JeP5pWw5o2uXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZhY3Rpb24gPSBlLnJvd1tGQVZPUklURV9GSUVMRF9OQU1FXSA/IEZhdm9yaXRlQWN0aW9uLmFkZCA6IEZhdm9yaXRlQWN0aW9uLmRlbGV0ZTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmYWN0aW9uID09PSAgRmF2b3JpdGVBY3Rpb24uYWRkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5mYXZvcml0ZUl0ZW1zID0gWy4uLnRoaXMuaW5zLmZhdm9yaXRlSXRlbXMsIGUucm93XTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmZhdm9yaXRlSXRlbXMgPSB0aGlzLmlucy5mYXZvcml0ZUl0ZW1zLmZpbHRlcihuID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi51dGlscy5nZXRWYWx1ZShzZWxmLmlkRmllbGQsIG4pICE9PSBzZWxmLnV0aWxzLmdldFZhbHVlKHNlbGYuaWRGaWVsZCwgZS5yb3cpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9va3VwU2VsZWN0aW9uU2VyLnVwZGF0ZUZhdm9yaXRlRGF0YShlLnJvdywgZmFjdGlvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGR0LmNvbHVtblNvcnRlZC5zdWJzY3JpYmUoKHNvcnQ6IHsgc29ydE5hbWU6IHN0cmluZzsgc29ydE9yZGVyOiBhbnkgfSkgPT4ge1xyXG5cclxuICAgICAgICAgICAgdGhpcy5fc29ydFN0YXRlID0gc29ydDtcclxuXHJcbiAgICAgICAgICAgIGlmICghdGhpcy5pbnMucmVtb3RlU29ydCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCB7IHNvcnROYW1lLCBzb3J0T3JkZXIgfSA9IHsgLi4uc29ydCB9O1xyXG5cclxuICAgICAgICAgICAgY29uc3QgY29sID0gdGhpcy5pbnMuY29sdW1ucy5maW5kKG4gPT4gbi5maWVsZCA9PT0gc29ydE5hbWUpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgX3NvcnROYW1lID0gY29sID8gY29sLmZpZWxkUGF0aCA/IGNvbC5maWVsZFBhdGggOiBjb2wuZmllbGQgOiBzb3J0TmFtZTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHBhcmFtID0ge1xyXG4gICAgICAgICAgICAgICAgc29ydE5hbWU6IF9zb3J0TmFtZSxcclxuICAgICAgICAgICAgICAgIHNvcnRPcmRlcixcclxuICAgICAgICAgICAgICAgIHNlYXJjaDogc2VsZi5fc2VhcmNoU3RhdGUsXHJcbiAgICAgICAgICAgICAgICBwYWdlSW5mbzoge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VTaXplOiBzZWxmLnBhZ2VTaXplLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VJbmRleDogMVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgc2VsZi5odHRwTWdyLmdldERhdGEocGFyYW0sICdzZWFyY2gnKS5zdWJzY3JpYmUoZCA9PiB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLmxvYWREYXRhVGFibGVEYXRhKGQpO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5jbG9zZUxvYWRpbmcoKTtcclxuICAgICAgICAgICAgICAgIC8vIOmAieS4reaVsOaNriBURlMgNjE1MDA4XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5zZWxlY3Rpb25NZ3Iuc2VsZWN0Q3VycmVudFZhbHVlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkdC5jbGVhclNlYXJjaFZhbHVlLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgICAgIHNlbGYuX3NlYXJjaFN0YXRlID0gbnVsbDtcclxuICAgICAgICAgICAgdGhpcy5vblNlYXJjaCgpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkdC5jZWxsU3R5bGVyID0gKHZhbDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgZmllbGQgfSA9IHZhbDtcclxuICAgICAgICAgICAgaWYgKGZpZWxkID09PSBGQVZPUklURV9GSUVMRF9OQU1FKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgICd0ZXh0LW92ZXJmbG93JzogJ3Vuc2V0J1xyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG4iXX0=