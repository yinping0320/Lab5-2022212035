/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of } from 'rxjs';
import { switchMap } from 'rxjs/operators';
/**
 * 检查帮助输入框值变化后返回的查询结果
 * @param {?=} data
 * @return {?}
 */
function checkSearchResult(data = null) {
    if (this.searchOnServer) {
        // this._searchResult = data;
        // this.showDialog();
        this.isShow = true;
    }
    else {
        if (data === false) {
            this.cancelSelect();
        }
        else {
            this.setModelValue(this.displayText);
            this.runDictPickedEvent(null);
        }
    }
}
/**
 * @return {?}
 */
export function onTextChanged() {
    /** @type {?} */
    const self = this;
    /** @type {?} */
    const isPending = (/**
     * @return {?}
     */
    () => {
        return this.lookupUtils.rts.getFormState('lookup.pending');
    });
    /** @type {?} */
    const searchData = (/**
     * @param {?} e
     * @return {?}
     */
    (e) => {
        if (this.isShow) {
            return;
        }
        if (this.isTextChange && this.displayText && (!this.nosearch || e.originalEvent) && !isPending()) {
            this.lookupUtils.pendingStart();
            this.dictPickingSubscription = this.dictPicking({
                instance: this
            }).pipe(switchMap((/**
             * @param {?} pr
             * @return {?}
             */
            (pr) => {
                /** @type {?} */
                let o = true;
                if (pr === undefined || pr === null) {
                    o = true;
                }
                if (typeof pr === 'boolean') {
                    o = pr;
                }
                if (typeof pr === 'object') {
                    if (pr.showDialog === undefined) {
                        o = true;
                    }
                    else {
                        o = pr.showDialog;
                    }
                    if (pr.data) {
                        /** 保存帮助前传递的数据 */
                        this.customData = pr.data;
                    }
                }
                if (o) {
                    return this.httpMgr.getData({
                        search: {
                            field: '*',
                            value: this.displayText,
                            type: 'equal'
                        }
                    }, 'search');
                }
                else {
                    return of({ SHOWDIALOG: o, MESSAGE: pr.message || '' });
                }
            }))).subscribe((/**
             * @param {?} data
             * @return {?}
             */
            (data) => {
                this.closeLoading();
                this.lookupUtils.pendingEnd();
                if (data.hasOwnProperty('SHOWDIALOG')) {
                    if (data.SHOWDIALOG && data.MESSAGE) {
                        this.notifyService.warning(data.MESSAGE);
                    }
                    return;
                }
                if (data.items && data.items.length === 1 && (!data.items[0].children || !data.items[0].children.length)) {
                    /** @type {?} */
                    let rowdata = data.items[0];
                    if (this.isTree()) {
                        /** @type {?} */
                        const leafNode = this.treeNodeHelper.getLeafNode(rowdata);
                        /** @type {?} */
                        let isOnlySelectLeaf = false;
                        if (!this.treeInfo) {
                            this.setTreeInfo(data);
                        }
                        if (typeof this.treeInfo.onlySelectLeaf === 'boolean') {
                            isOnlySelectLeaf = this.treeInfo.onlySelectLeaf;
                        }
                        else if (typeof this.treeInfo.onlySelectLeaf === 'string') {
                            if (this.treeInfo.onlySelectLeaf === 'yes') {
                                isOnlySelectLeaf = true;
                            }
                            else if (this.treeInfo.onlySelectLeaf === 'no') {
                                isOnlySelectLeaf = false;
                            }
                            else {
                                if (this.treeInfo.onlySelectLeaf === 'default') {
                                    isOnlySelectLeaf = data.treeInfo.onlySelectLeaf;
                                }
                            }
                        }
                        if (isOnlySelectLeaf && !leafNode.leaf) {
                            // this.displayText = '';
                            checkSearchResult.bind(self, data)();
                            return;
                        }
                        if (Array.isArray(leafNode)) {
                            checkSearchResult.bind(self, data)();
                            return;
                        }
                        else {
                            rowdata = leafNode.data;
                        }
                    }
                    if (!this.singleSelect) {
                        rowdata = [rowdata];
                    }
                    this.selectItem(rowdata);
                    this.dialogClosed.emit();
                }
                else {
                    checkSearchResult.bind(self, data)();
                }
            }), (/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                this.closeLoading();
                this.lookupUtils.pendingEnd();
                this.messagerService.error(err ? err.Message : err);
            }));
        }
    });
    /** @type {?} */
    let inputBlurHandler = null;
    if (this.inputGroup && this.inputGroup.textbox && !this.nosearch) {
        this.lookupUtils.setActiveLookupInstance(this);
        inputBlurHandler = this.render2.listen(this.inputGroup.textbox.nativeElement, 'blur', searchData);
    }
    if (this.inputGroup) {
        this.inputGroup.enterHandle.subscribe(searchData);
        this.inputGroup.keydownHandle.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            /** @type {?} */
            let canOpen = false;
            if (e.code === 'ArrowRight') {
                if (this.quickSelect && !this.quickSelect.enable) {
                    this.writeConsole('启用快捷选择后，右方向键禁用打开帮助', 'warn');
                    return;
                }
                if (this.editable) {
                    canOpen = !e.target.value || e.target.selectionStart === e.target.value.length;
                }
                else {
                    canOpen = true;
                }
            }
            else {
                canOpen = e.code === this.shortcutKey.open;
            }
            if (canOpen) {
                e.stopPropagation();
                e.preventDefault();
                this.showDialog();
            }
        }));
    }
    return inputBlurHandler;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib24tdGV4dC1jaGFuZ2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9vbi10ZXh0LWNoYW5nZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFTLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7Ozs7OztBQU0zQyxTQUFTLGlCQUFpQixDQUFDLElBQUksR0FBRyxJQUFJO0lBQ2xDLElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRTtRQUNyQiw2QkFBNkI7UUFDN0IscUJBQXFCO1FBQ3JCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO0tBQ3RCO1NBQU07UUFDSCxJQUFJLElBQUksS0FBSyxLQUFLLEVBQUU7WUFDaEIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1NBQ3ZCO2FBQU07WUFDSCxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUNyQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDakM7S0FDSjtBQUNMLENBQUM7Ozs7QUFFRCxNQUFNLFVBQVUsYUFBYTs7VUFFbkIsSUFBSSxHQUFHLElBQUk7O1VBRVgsU0FBUzs7O0lBQUcsR0FBRyxFQUFFO1FBQ25CLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDL0QsQ0FBQyxDQUFBOztVQUVLLFVBQVU7Ozs7SUFBRyxDQUFDLENBQUMsRUFBRSxFQUFFO1FBRXJCLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNiLE9BQU87U0FDVjtRQUVELElBQUksSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsQ0FBQyxh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TSxDQUFDLENBQUM7b0JBQ2hELE9BQU87aUJBQ1Y7Z0JBRUQsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO29CQUNmLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsY0FBYyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQztpQkFDbEY7cUJBQU07b0JBQ0gsT0FBTyxHQUFHLElBQUksQ0FBQztpQkFDbEI7YUFDSjtpQkFBTTtnQkFDSCxPQUFPLEdBQUcsQ0FBQyxDQUFDLElBQUksS0FBSyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQzthQUM5QztZQUNELElBQUksT0FBTyxFQUFFO2dCQUNULENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQztnQkFDcEIsQ0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDO2dCQUNuQixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7YUFDckI7UUFDTCxDQUFDLEVBQUMsQ0FBQztLQUNOO0lBRUQsT0FBTyxnQkFBZ0IsQ0FBQztBQUU1QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRU1QVFksIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZFJlc3VsdCwgUGlja2luZ1Jlc3VsdCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLW9wdGlvbnMnO1xyXG5cclxuXHJcblxyXG4gLyoqIOajgOafpeW4ruWKqei+k+WFpeahhuWAvOWPmOWMluWQjui/lOWbnueahOafpeivoue7k+aenCAqL1xyXG5mdW5jdGlvbiBjaGVja1NlYXJjaFJlc3VsdChkYXRhID0gbnVsbCkge1xyXG4gICAgaWYgKHRoaXMuc2VhcmNoT25TZXJ2ZXIpIHtcclxuICAgICAgICAvLyB0aGlzLl9zZWFyY2hSZXN1bHQgPSBkYXRhO1xyXG4gICAgICAgIC8vIHRoaXMuc2hvd0RpYWxvZygpO1xyXG4gICAgICAgIHRoaXMuaXNTaG93ID0gdHJ1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWYgKGRhdGEgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2FuY2VsU2VsZWN0KCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5zZXRNb2RlbFZhbHVlKHRoaXMuZGlzcGxheVRleHQpO1xyXG4gICAgICAgICAgICB0aGlzLnJ1bkRpY3RQaWNrZWRFdmVudChudWxsKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBvblRleHRDaGFuZ2VkKCkge1xyXG5cclxuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIGNvbnN0IGlzUGVuZGluZyA9ICgpID0+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5sb29rdXBVdGlscy5ydHMuZ2V0Rm9ybVN0YXRlKCdsb29rdXAucGVuZGluZycpO1xyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCBzZWFyY2hEYXRhID0gKGUpID0+IHtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaXNTaG93KSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlzVGV4dENoYW5nZSAmJiB0aGlzLmRpc3BsYXlUZXh0ICYmICghdGhpcy5ub3NlYXJjaCB8fCBlLm9yaWdpbmFsRXZlbnQpICYmICFpc1BlbmRpbmcoKSkge1xyXG4gICAgICAgICAgICB0aGlzLmxvb2t1cFV0aWxzLnBlbmRpbmdTdGFydCgpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5kaWN0UGlja2luZ1N1YnNjcmlwdGlvbiA9IHRoaXMuZGljdFBpY2tpbmcoe1xyXG4gICAgICAgICAgICAgICAgaW5zdGFuY2U6IHRoaXNcclxuICAgICAgICAgICAgfSkucGlwZShcclxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgocHI6IFBpY2tpbmdSZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgbyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByID09PSB1bmRlZmluZWQgfHwgcHIgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHByID09PSAnYm9vbGVhbicpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbyA9IHByO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwciA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByLnNob3dEaWFsb2cgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvID0gcHIuc2hvd0RpYWxvZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByLmRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qKiDkv53lrZjluK7liqnliY3kvKDpgJLnmoTmlbDmja4gKi9cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3VzdG9tRGF0YSA9IHByLmRhdGE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmh0dHBNZ3IuZ2V0RGF0YShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWFyY2g6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQ6ICcqJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRoaXMuZGlzcGxheVRleHQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdlcXVhbCdcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3NlYXJjaCdcclxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoeyBTSE9XRElBTE9HOiBvLCBNRVNTQUdFOiAgcHIubWVzc2FnZSB8fCAnJyB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICApLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgIChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlTG9hZGluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9va3VwVXRpbHMucGVuZGluZ0VuZCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLmhhc093blByb3BlcnR5KCdTSE9XRElBTE9HJykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuU0hPV0RJQUxPRyAmJiBkYXRhLk1FU1NBR0UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKGRhdGEuTUVTU0FHRSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLml0ZW1zICYmIGRhdGEuaXRlbXMubGVuZ3RoID09PSAxICYmICghZGF0YS5pdGVtc1swXS5jaGlsZHJlbiB8fCAhZGF0YS5pdGVtc1swXS5jaGlsZHJlbi5sZW5ndGgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByb3dkYXRhID0gZGF0YS5pdGVtc1swXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNUcmVlKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlYWZOb2RlID0gdGhpcy50cmVlTm9kZUhlbHBlci5nZXRMZWFmTm9kZShyb3dkYXRhKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgaXNPbmx5U2VsZWN0TGVhZiA9IGZhbHNlO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy50cmVlSW5mbykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0VHJlZUluZm8oZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLnRyZWVJbmZvLm9ubHlTZWxlY3RMZWFmID09PSAnYm9vbGVhbicgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNPbmx5U2VsZWN0TGVhZiA9IHRoaXMudHJlZUluZm8ub25seVNlbGVjdExlYWY7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0aGlzLnRyZWVJbmZvLm9ubHlTZWxlY3RMZWFmID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRyZWVJbmZvLm9ubHlTZWxlY3RMZWFmID09PSAneWVzJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc09ubHlTZWxlY3RMZWFmID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudHJlZUluZm8ub25seVNlbGVjdExlYWYgPT09ICdubycpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNPbmx5U2VsZWN0TGVhZiA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRyZWVJbmZvLm9ubHlTZWxlY3RMZWFmID09PSAnZGVmYXVsdCcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzT25seVNlbGVjdExlYWYgPSBkYXRhLnRyZWVJbmZvLm9ubHlTZWxlY3RMZWFmO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc09ubHlTZWxlY3RMZWFmICYmICFsZWFmTm9kZS5sZWFmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5kaXNwbGF5VGV4dCA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrU2VhcmNoUmVzdWx0LmJpbmQoc2VsZiwgZGF0YSkoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShsZWFmTm9kZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja1NlYXJjaFJlc3VsdC5iaW5kKHNlbGYsIGRhdGEpKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3dkYXRhID0gbGVhZk5vZGUuZGF0YTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuc2luZ2xlU2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3dkYXRhID0gWyByb3dkYXRhIF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RJdGVtKHJvd2RhdGEpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kaWFsb2dDbG9zZWQuZW1pdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrU2VhcmNoUmVzdWx0LmJpbmQoc2VsZiwgZGF0YSkoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LCAoZXJyOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlTG9hZGluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9va3VwVXRpbHMucGVuZGluZ0VuZCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZXJTZXJ2aWNlLmVycm9yKGVyciA/IGVyci5NZXNzYWdlIDogZXJyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGxldCBpbnB1dEJsdXJIYW5kbGVyID0gbnVsbDtcclxuXHJcbiAgICBpZiAodGhpcy5pbnB1dEdyb3VwICYmIHRoaXMuaW5wdXRHcm91cC50ZXh0Ym94ICYmICF0aGlzLm5vc2VhcmNoKSB7XHJcbiAgICAgICAgdGhpcy5sb29rdXBVdGlscy5zZXRBY3RpdmVMb29rdXBJbnN0YW5jZSh0aGlzKTtcclxuICAgICAgICBpbnB1dEJsdXJIYW5kbGVyID0gdGhpcy5yZW5kZXIyLmxpc3Rlbih0aGlzLmlucHV0R3JvdXAudGV4dGJveC5uYXRpdmVFbGVtZW50LCAnYmx1cicsIHNlYXJjaERhdGEgKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5pbnB1dEdyb3VwKSB7XHJcbiAgICAgICAgdGhpcy5pbnB1dEdyb3VwLmVudGVySGFuZGxlLnN1YnNjcmliZSggc2VhcmNoRGF0YSk7XHJcblxyXG4gICAgICAgIHRoaXMuaW5wdXRHcm91cC5rZXlkb3duSGFuZGxlLnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBjYW5PcGVuID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGlmIChlLmNvZGUgPT09ICdBcnJvd1JpZ2h0Jykge1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnF1aWNrU2VsZWN0ICYmICF0aGlzLnF1aWNrU2VsZWN0LmVuYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMud3JpdGVDb25zb2xlKCflkK/nlKjlv6vmjbfpgInmi6nlkI7vvIzlj7PmlrnlkJHplK7npoHnlKjmiZPlvIDluK7liqknLCAnd2FybicpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5lZGl0YWJsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbk9wZW4gPSAhZS50YXJnZXQudmFsdWUgfHwgZS50YXJnZXQuc2VsZWN0aW9uU3RhcnQgPT09IGUudGFyZ2V0LnZhbHVlLmxlbmd0aDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FuT3BlbiA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjYW5PcGVuID0gZS5jb2RlID09PSB0aGlzLnNob3J0Y3V0S2V5Lm9wZW47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGNhbk9wZW4pIHtcclxuICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNob3dEaWFsb2coKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBpbnB1dEJsdXJIYW5kbGVyO1xyXG5cclxufVxyXG4iXX0=