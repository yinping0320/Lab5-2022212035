/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, Renderer2, Injector, Input } from '@angular/core';
import { InputGroupComponent } from '@farris/ui-input-group';
import { PersonalConfigService } from './lookup-presonalConfig.service';
import { delay } from 'rxjs/operators';
import { LocaleService } from '@farris/ui-locale';
export class LookupTipDirective {
    /**
     * @param {?} inputRef
     * @param {?} renderer
     * @param {?} injector
     */
    constructor(inputRef, renderer, injector) {
        this.inputRef = inputRef;
        this.renderer = renderer;
        this.injector = injector;
        this.enableTip = false;
        this.isInTipPanel = false;
        this.tipText = '您要找的是不是这些？';
        this.personalConfigService = this.injector.get(PersonalConfigService, null);
        this.localService = this.injector.get(LocaleService);
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.tipText = this.localService.getValue('lookup.tipText');
        this.enableTip = false; // 因数据权限问题，此功能暂屏蔽 tfs: 403924
        if (this.enableTip) {
            this.inputRef.iconMouseEnter.subscribe((/**
             * @param {?} e
             * @return {?}
             */
            e => {
                this.creatPanel();
            }));
            this.inputRef.iconMouseLeave.pipe(delay(200)).subscribe((/**
             * @param {?} e
             * @return {?}
             */
            e => {
                if (!this.isInTipPanel) {
                    this.removePanel();
                }
            }));
            this.inputRef.clickHandle.subscribe((/**
             * @param {?} e
             * @return {?}
             */
            e => {
                this.removePanel();
            }));
        }
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() { }
    // 获取快捷输入数据
    /**
     * @private
     * @return {?}
     */
    getQuickSelectedByLocaleId() {
        /** @type {?} */
        const localeid = this.localService.localeId;
        /** @type {?} */
        const personalConf = this.personalConfigService.getPersonalData();
        if (personalConf && personalConf.quickSelected) {
            /** @type {?} */
            const items = personalConf.quickSelected[localeid];
            if (items && items.length) {
                return items;
            }
        }
        return null;
    }
    /**
     * @return {?}
     */
    creatPanel() {
        this.selected = this.getQuickSelectedByLocaleId();
        if (this.tipPanel || !this.selected || (this.selected && this.selected.length === 0)) {
            return;
        }
        /** @type {?} */
        const pos = this.setPosition();
        /** @type {?} */
        const ul = this.renderer.createElement('ul');
        /** @type {?} */
        const path = this.personalConfigService.textField.split('.');
        this.selected.forEach((/**
         * @param {?} item
         * @param {?} index
         * @return {?}
         */
        (item, index) => {
            /** @type {?} */
            const li = this.renderer.createElement('li');
            li.innerHTML = this.find(item, this.personalConfigService.textField);
            this.renderer.setProperty(li, 'id', index);
            this.renderer.appendChild(ul, li);
        }));
        /** @type {?} */
        const header = this.renderer.createElement('div');
        this.renderer.addClass(header, 'lookup-tip-header');
        header.innerHTML = this.tipText;
        this.tipPanel = this.renderer.createElement('div');
        this.renderer.appendChild(this.tipPanel, header);
        this.renderer.appendChild(this.tipPanel, ul);
        this.renderer.addClass(this.tipPanel, 'lookup-tip');
        this.renderer.setStyle(this.tipPanel, 'top', pos.top);
        this.renderer.setStyle(this.tipPanel, 'left', pos.left);
        this.renderer.setStyle(this.tipPanel, 'width', pos.width);
        this.renderer.appendChild(document.body, this.tipPanel);
        this.leaveEvent = this.renderer.listen(this.tipPanel, 'mouseleave', (/**
         * @return {?}
         */
        () => {
            this.removePanel();
        }));
        this.enterEvent = this.renderer.listen(this.tipPanel, 'mouseenter', (/**
         * @return {?}
         */
        () => {
            this.isInTipPanel = true;
        }));
        this.clickEvent = this.renderer.listen(this.tipPanel, 'click', (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (e.target.nodeName === 'LI') {
                this.selectItem(e.target.id);
            }
        }));
    }
    /**
     * @return {?}
     */
    removePanel() {
        if (document.body.contains(this.tipPanel)) {
            this.renderer.removeChild(document.body, this.tipPanel);
            this.tipPanel = null;
            this.isInTipPanel = false;
            this.leaveEvent();
            this.enterEvent();
            this.clickEvent();
        }
    }
    /**
     * @return {?}
     */
    setPosition() {
        const { left, top, width, height } = this.inputRef.inputGroup.nativeElement.getBoundingClientRect();
        return {
            left: left + 'px',
            top: top + height + 'px',
            width: width + 'px'
        };
    }
    /**
     * @param {?} val
     * @return {?}
     */
    selectItem(val) {
        /** @type {?} */
        const item = this.selected.find((/**
         * @param {?} el
         * @param {?} index
         * @return {?}
         */
        (el, index) => Number(val) === index));
        this.removePanel();
        if (this.personalConfigService.singleSelect) {
            this.personalConfigService.selectItemObser$.next(item);
        }
        else {
            this.personalConfigService.selectItemObser$.next([item]);
        }
    }
    /**
     * @param {?} obj
     * @param {?} keys
     * @return {?}
     */
    find(obj, keys) {
        /** @type {?} */
        const keyArr = keys.split('.');
        /** @type {?} */
        const key = keyArr[0];
        /** @type {?} */
        const target = obj[key];
        if (target instanceof Object) {
            keyArr.shift();
            return this.find(target, keyArr.join('.'));
        }
        else {
            return target;
        }
    }
}
LookupTipDirective.decorators = [
    { type: Directive, args: [{
                selector: '[lookup-tip]'
            },] }
];
/** @nocollapse */
LookupTipDirective.ctorParameters = () => [
    { type: InputGroupComponent },
    { type: Renderer2 },
    { type: Injector }
];
LookupTipDirective.propDecorators = {
    enableTip: [{ type: Input, args: ['lookup-tip',] }]
};
if (false) {
    /** @type {?} */
    LookupTipDirective.prototype.enableTip;
    /**
     * @type {?}
     * @private
     */
    LookupTipDirective.prototype.tipPanel;
    /**
     * @type {?}
     * @private
     */
    LookupTipDirective.prototype.leaveEvent;
    /**
     * @type {?}
     * @private
     */
    LookupTipDirective.prototype.enterEvent;
    /**
     * @type {?}
     * @private
     */
    LookupTipDirective.prototype.clickEvent;
    /**
     * @type {?}
     * @private
     */
    LookupTipDirective.prototype.isInTipPanel;
    /**
     * @type {?}
     * @private
     */
    LookupTipDirective.prototype.selected;
    /**
     * @type {?}
     * @private
     */
    LookupTipDirective.prototype.personalConfigService;
    /** @type {?} */
    LookupTipDirective.prototype.localService;
    /**
     * @type {?}
     * @private
     */
    LookupTipDirective.prototype.tipText;
    /**
     * @type {?}
     * @private
     */
    LookupTipDirective.prototype.inputRef;
    /**
     * @type {?}
     * @private
     */
    LookupTipDirective.prototype.renderer;
    /** @type {?} */
    LookupTipDirective.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9va3VwLXRpcC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9sb29rdXAtdGlwLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBeUIsU0FBUyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDNUYsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDN0QsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDeEUsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUlsRCxNQUFNLE9BQU8sa0JBQWtCOzs7Ozs7SUFXM0IsWUFDWSxRQUE2QixFQUM3QixRQUFtQixFQUNwQixRQUFrQjtRQUZqQixhQUFRLEdBQVIsUUFBUSxDQUFxQjtRQUM3QixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQ3BCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFiUixjQUFTLEdBQUcsS0FBSyxDQUFDO1FBSy9CLGlCQUFZLEdBQUcsS0FBSyxDQUFDO1FBSXJCLFlBQU8sR0FBRyxZQUFZLENBQUM7UUFNM0IsSUFBSSxDQUFDLHFCQUFxQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLHFCQUFxQixFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzVFLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDekQsQ0FBQzs7OztJQUVELFFBQVE7UUFDSixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDNUQsSUFBSSxDQUFDLFNBQVMs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QUNyRCwwQ0FBbUM7Ozs7O0lBQ25DLHFDQUErQjs7Ozs7SUFFM0Isc0NBQXFDOzs7OztJQUNyQyxzQ0FBMkI7O0lBQzNCLHNDQUF5QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgT25Jbml0LCBBZnRlclZpZXdJbml0LCBSZW5kZXJlcjIsIEluamVjdG9yLCBJbnB1dH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IElucHV0R3JvdXBDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWlucHV0LWdyb3VwJztcclxuaW1wb3J0IHsgUGVyc29uYWxDb25maWdTZXJ2aWNlIH0gZnJvbSAnLi9sb29rdXAtcHJlc29uYWxDb25maWcuc2VydmljZSc7XHJcbmltcG9ydCB7IGRlbGF5IH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBMb2NhbGVTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1sb2NhbGUnO1xyXG5ARGlyZWN0aXZlKHtcclxuICAgIHNlbGVjdG9yOiAnW2xvb2t1cC10aXBdJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgTG9va3VwVGlwRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcclxuICAgIEBJbnB1dCgnbG9va3VwLXRpcCcpIGVuYWJsZVRpcCA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSB0aXBQYW5lbDogRWxlbWVudDtcclxuICAgIHByaXZhdGUgbGVhdmVFdmVudDogYW55O1xyXG4gICAgcHJpdmF0ZSBlbnRlckV2ZW50OiBhbnk7XHJcbiAgICBwcml2YXRlIGNsaWNrRXZlbnQ6IGFueTtcclxuICAgIHByaXZhdGUgaXNJblRpcFBhbmVsID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIHNlbGVjdGVkOiBhbnlbXTtcclxuICAgIHByaXZhdGUgcGVyc29uYWxDb25maWdTZXJ2aWNlOiBQZXJzb25hbENvbmZpZ1NlcnZpY2U7XHJcbiAgICBwdWJsaWMgbG9jYWxTZXJ2aWNlOiBMb2NhbGVTZXJ2aWNlO1xyXG4gICAgcHJpdmF0ZSB0aXBUZXh0ID0gJ+aCqOimgeaJvueahOaYr+S4jeaYr+i/meS6m++8nyc7XHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlIGlucHV0UmVmOiBJbnB1dEdyb3VwQ29tcG9uZW50LFxyXG4gICAgICAgIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMixcclxuICAgICAgICBwdWJsaWMgaW5qZWN0b3I6IEluamVjdG9yXHJcbiAgICApIHtcclxuICAgICAgICB0aGlzLnBlcnNvbmFsQ29uZmlnU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KFBlcnNvbmFsQ29uZmlnU2VydmljZSwgbnVsbCk7XHJcbiAgICAgICAgdGhpcy5sb2NhbFNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChMb2NhbGVTZXJ2aWNlKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnRpcFRleHQgPSB0aGlzLmxvY2FsU2VydmljZS5nZXRWYWx1ZSgnbG9va3VwLnRpcFRleHQnKTtcclxuICAgICAgICB0aGlzLmVuYWJsZVRpcCA9IGZhbHNlOyAvLyDlm6DmlbDmja7mnYPpmZDpl67popjvvIzmraTlip/og73mmoLlsY/olL0gdGZzOiA0MDM5MjRcclxuICAgICAgICBpZiAodGhpcy5lbmFibGVUaXApIHtcclxuICAgICAgICAgICAgdGhpcy5pbnB1dFJlZi5pY29uTW91c2VFbnRlci5zdWJzY3JpYmUoZSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNyZWF0UGFuZWwoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5wdXRSZWYuaWNvbk1vdXNlTGVhdmUucGlwZShkZWxheSgyMDApKS5zdWJzY3JpYmUoZSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNJblRpcFBhbmVsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVQYW5lbCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5pbnB1dFJlZi5jbGlja0hhbmRsZS5zdWJzY3JpYmUoZSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZVBhbmVsKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7IH1cclxuXHJcbiAgICAvLyDojrflj5blv6vmjbfovpPlhaXmlbDmja5cclxuICAgIHByaXZhdGUgZ2V0UXVpY2tTZWxlY3RlZEJ5TG9jYWxlSWQoKSB7XHJcbiAgICAgICAgY29uc3QgbG9jYWxlaWQgPSB0aGlzLmxvY2FsU2VydmljZS5sb2NhbGVJZDtcclxuICAgICAgICBjb25zdCBwZXJzb25hbENvbmYgPSB0aGlzLnBlcnNvbmFsQ29uZmlnU2VydmljZS5nZXRQZXJzb25hbERhdGEoKTtcclxuICAgICAgICBpZiAocGVyc29uYWxDb25mICYmIHBlcnNvbmFsQ29uZi5xdWlja1NlbGVjdGVkKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1zID0gcGVyc29uYWxDb25mLnF1aWNrU2VsZWN0ZWRbbG9jYWxlaWRdO1xyXG4gICAgICAgICAgICBpZiAoaXRlbXMgJiYgaXRlbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaXRlbXM7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIGNyZWF0UGFuZWwoKSB7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RlZCA9IHRoaXMuZ2V0UXVpY2tTZWxlY3RlZEJ5TG9jYWxlSWQoKTtcclxuICAgICAgICBpZiAodGhpcy50aXBQYW5lbCB8fCAhdGhpcy5zZWxlY3RlZCB8fCAodGhpcy5zZWxlY3RlZCAmJiB0aGlzLnNlbGVjdGVkLmxlbmd0aCA9PT0gMCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBwb3MgPSB0aGlzLnNldFBvc2l0aW9uKCk7XHJcbiAgICAgICAgY29uc3QgdWwgPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ3VsJyk7XHJcbiAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMucGVyc29uYWxDb25maWdTZXJ2aWNlLnRleHRGaWVsZC5zcGxpdCgnLicpO1xyXG4gICAgICAgIHRoaXMuc2VsZWN0ZWQuZm9yRWFjaCgoaXRlbSwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbGkgPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ2xpJyk7XHJcbiAgICAgICAgICAgIGxpLmlubmVySFRNTCA9IHRoaXMuZmluZChpdGVtLCB0aGlzLnBlcnNvbmFsQ29uZmlnU2VydmljZS50ZXh0RmllbGQpO1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFByb3BlcnR5KGxpLCAnaWQnLCBpbmRleCk7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuYXBwZW5kQ2hpbGQodWwsIGxpKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBjb25zdCBoZWFkZXIgPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3MoaGVhZGVyLCAnbG9va3VwLXRpcC1oZWFkZXInKTtcclxuICAgICAgICBoZWFkZXIuaW5uZXJIVE1MID0gdGhpcy50aXBUZXh0O1xyXG4gICAgICAgIHRoaXMudGlwUGFuZWwgPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyZXIuYXBwZW5kQ2hpbGQodGhpcy50aXBQYW5lbCwgaGVhZGVyKTtcclxuICAgICAgICB0aGlzLnJlbmRlcmVyLmFwcGVuZENoaWxkKHRoaXMudGlwUGFuZWwsIHVsKTtcclxuICAgICAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMudGlwUGFuZWwsICdsb29rdXAtdGlwJyk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLnRpcFBhbmVsLCAndG9wJywgcG9zLnRvcCk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLnRpcFBhbmVsLCAnbGVmdCcsIHBvcy5sZWZ0KTtcclxuICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMudGlwUGFuZWwsICd3aWR0aCcsIHBvcy53aWR0aCk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5hcHBlbmRDaGlsZChkb2N1bWVudC5ib2R5LCB0aGlzLnRpcFBhbmVsKTtcclxuICAgICAgICB0aGlzLmxlYXZlRXZlbnQgPSB0aGlzLnJlbmRlcmVyLmxpc3Rlbih0aGlzLnRpcFBhbmVsLCAnbW91c2VsZWF2ZScsICgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5yZW1vdmVQYW5lbCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuZW50ZXJFdmVudCA9IHRoaXMucmVuZGVyZXIubGlzdGVuKHRoaXMudGlwUGFuZWwsICdtb3VzZWVudGVyJywgKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmlzSW5UaXBQYW5lbCA9IHRydWU7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5jbGlja0V2ZW50ID0gdGhpcy5yZW5kZXJlci5saXN0ZW4odGhpcy50aXBQYW5lbCwgJ2NsaWNrJywgKGUpID0+IHtcclxuICAgICAgICAgICAgaWYgKGUudGFyZ2V0Lm5vZGVOYW1lID09PSAnTEknKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdEl0ZW0oZS50YXJnZXQuaWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlUGFuZWwoKSB7XHJcbiAgICAgICAgaWYgKGRvY3VtZW50LmJvZHkuY29udGFpbnModGhpcy50aXBQYW5lbCkpIHtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDaGlsZChkb2N1bWVudC5ib2R5LCB0aGlzLnRpcFBhbmVsKTtcclxuICAgICAgICAgICAgdGhpcy50aXBQYW5lbCA9IG51bGw7XHJcbiAgICAgICAgICAgIHRoaXMuaXNJblRpcFBhbmVsID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHRoaXMubGVhdmVFdmVudCgpO1xyXG4gICAgICAgICAgICB0aGlzLmVudGVyRXZlbnQoKTtcclxuICAgICAgICAgICAgdGhpcy5jbGlja0V2ZW50KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNldFBvc2l0aW9uKCkge1xyXG4gICAgICAgIGNvbnN0IHsgbGVmdCwgdG9wLCB3aWR0aCwgaGVpZ2h0IH0gPSB0aGlzLmlucHV0UmVmLmlucHV0R3JvdXAubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBsZWZ0OiBsZWZ0ICsgJ3B4JyxcclxuICAgICAgICAgICAgdG9wOiB0b3AgKyBoZWlnaHQgKyAncHgnLFxyXG4gICAgICAgICAgICB3aWR0aDogd2lkdGggKyAncHgnXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3RJdGVtKHZhbCkge1xyXG4gICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLnNlbGVjdGVkLmZpbmQoKGVsLCBpbmRleCkgPT4gTnVtYmVyKHZhbCkgPT09IGluZGV4KTtcclxuICAgICAgICB0aGlzLnJlbW92ZVBhbmVsKCk7XHJcbiAgICAgICAgaWYgKHRoaXMucGVyc29uYWxDb25maWdTZXJ2aWNlLnNpbmdsZVNlbGVjdCkge1xyXG4gICAgICAgICAgICB0aGlzLnBlcnNvbmFsQ29uZmlnU2VydmljZS5zZWxlY3RJdGVtT2JzZXIkLm5leHQoaXRlbSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5wZXJzb25hbENvbmZpZ1NlcnZpY2Uuc2VsZWN0SXRlbU9ic2VyJC5uZXh0KFtpdGVtXSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZpbmQob2JqLCBrZXlzKSB7XHJcbiAgICAgICAgY29uc3Qga2V5QXJyID0ga2V5cy5zcGxpdCgnLicpO1xyXG4gICAgICAgIGNvbnN0IGtleSA9IGtleUFyclswXTtcclxuICAgICAgICBjb25zdCB0YXJnZXQgPSBvYmpba2V5XTtcclxuICAgICAgICBpZiAodGFyZ2V0IGluc3RhbmNlb2YgT2JqZWN0KSB7XHJcbiAgICAgICAgICAgIGtleUFyci5zaGlmdCgpO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5maW5kKHRhcmdldCwga2V5QXJyLmpvaW4oJy4nKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRhcmdldDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19