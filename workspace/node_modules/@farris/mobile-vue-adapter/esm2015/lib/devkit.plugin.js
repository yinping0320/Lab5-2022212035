/**
 * @fileoverview added by tsickle
 * Generated from: lib/devkit.plugin.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { App } from '@farris/mobile-devkit';
import { BindingStates } from './binding-states';
import { ComponentExtenderManager } from './component-extenders/index';
import { EventUtil } from './utils/index';
import formatUtils from './utils/format-uitl';
import { RouterService, HistoryBackService } from '@farris/mobile-command-services';
const ɵ0 = /**
 * @param {?} app
 * @param {?} options
 * @return {?}
 */
function (app, options) {
    /**
     * 注册事件
     * @todo：暂时强制绑定，暂时无法根据特性灵活区分
     */
    app.config.globalProperties.$on = (/**
     * @param {?} eventName
     * @param {?} eventHandler
     * @return {?}
     */
    function (eventName, eventHandler) {
        /** @type {?} */
        const vnodeProps = this._.vnode.props;
        /** @type {?} */
        const eventHandlerKey = EventUtil.toHandlerKey(eventName);
        /** @type {?} */
        const oldEventHandler = vnodeProps[eventHandlerKey];
        if (oldEventHandler) {
            vnodeProps[eventHandlerKey] = (/**
             * @param {?} $event
             * @return {?}
             */
            function ($event) {
                eventHandler($event);
                oldEventHandler($event);
            });
        }
        else {
            vnodeProps[eventHandlerKey] = eventHandler;
        }
    });
    /**
     * 清空事件注册
     * @todo：暂时强制清空
     */
    app.config.globalProperties.$off = (/**
     * @param {?} eventName
     * @return {?}
     */
    function (eventName) {
        /** @type {?} */
        const vnodeProps = this._.vnode.props;
        /** @type {?} */
        const eventHandlerKey = EventUtil.toHandlerKey(eventName);
        vnodeProps[eventHandlerKey] = null;
    });
    /**
     * 组件的App实例
     */
    app.config.globalProperties.$app = null;
    /**
     * 组件的ViewModel实例
     */
    app.config.globalProperties.$viewModel = null;
    /**
     * 绑定状态
     */
    app.config.globalProperties.$bindingStates = null;
    /**
     * 绑定状态
     */
    app.config.globalProperties.$componentExtenderManager = null;
    /**
     * 组件App工厂方法
     */
    app.config.globalProperties.$createApp = (/**
     * @param {?} appOptions
     * @return {?}
     */
    function (appOptions) {
        if (this.$app) {
            throw new Error('App已经存在');
        }
        /** @type {?} */
        const historyBackService = new HistoryBackService();
        historyBackService.init();
        historyBackService.proxyBack();
        this.$app = new App(appOptions);
        /**
         * @param {?} event
         * @return {?}
         */
        function receiveMessage(event) {
            /** @type {?} */
            const commandOptions = this.$app.context.injector.get('DECLARATIONS_TOKEN');
            /** @type {?} */
            var messageData = JSON.parse(event.data);
            /** @type {?} */
            const commandName = messageData.data.command;
            /** @type {?} */
            const command = commandOptions.commands[commandName];
            /** @type {?} */
            var origin = event.origin;
            /** @type {?} */
            var source = event.source;
            /** @type {?} */
            const viewModelContext = this.$app.context.viewModelContextManager.getContextById(command.viewModelId);
            if (!!viewModelContext) {
                /** @type {?} */
                const methodResult$ = viewModelContext.viewModel[command.command]();
                methodResult$.pipe((/**
                 * @return {?}
                 */
                () => { }), (/**
                 * @return {?}
                 */
                () => { }), (/**
                 * @return {?}
                 */
                () => {
                    window.parent && window.parent.postMessage('success', event.origin);
                }));
            }
        }
        if (!window['IsDddedMessageEventListener']) {
            window.addEventListener("message", receiveMessage.bind(this), false);
            window['IsDddedMessageEventListener'] = true;
        }
    });
    /**
     * 获取AppContext
     */
    app.config.globalProperties.$getApp = (/**
     * @return {?}
     */
    function () {
        /** @type {?} */
        let app = this.$app;
        /** @type {?} */
        let currentCmp = this;
        while (!app && currentCmp.$parent) {
            currentCmp = currentCmp.$parent;
            app = currentCmp.$app;
        }
        return app;
    });
    /**
     * 组件ViewModel工厂方法
     */
    app.config.globalProperties.$createViewModel = (/**
     * @param {?} viewModelOptions
     * @return {?}
     */
    function (viewModelOptions) {
        this.$app = this.$getApp();
        if (!this.$app) {
            throw new Error('请先创建App');
        }
        // 如果viewModel已经存在，则使用已有的
        /** @type {?} */
        const viewModelId = viewModelOptions.id;
        if (viewModelId) {
            /** @type {?} */
            const existedViewModelContext = this.$app.context.viewModelContextManager.getContextById(viewModelId);
            if (existedViewModelContext) {
                this.$viewModel = existedViewModelContext.viewModel;
            }
        }
        // 如果viewModel不存在，则创建新的viewModel，并建立父子关系
        if (!this.$viewModel) {
            /** @type {?} */
            const parentViewModel = this.$getViewModel();
            if (!viewModelOptions.parent) {
                viewModelOptions.parent = parentViewModel;
            }
            this.$viewModel = this.$app.createViewModel(viewModelOptions);
        }
        // 设置绑定状态
        this.$bindingStates = new BindingStates(this);
        // 映射路由状态
        /** @type {?} */
        const routerService = this.$viewModel.injector.get(RouterService);
        routerService.mappingToUIState();
        // 根据路由参数清理卡片缓存数据
        if (this.$viewModel && this.$viewModel.uiState && this.$viewModel.uiState.routerState && this.$viewModel.uiState.routerState.queryParams && this.$viewModel.uiState.routerState.queryParams.clearCachedDataForCard) {
            //清一下bingdingdate上的东西
            this.$viewModel.context.bindingData.getList().currentId = null;
        }
        // 根据路由参数清理列表缓存数据
        if (this.$viewModel && this.$viewModel.uiState && this.$viewModel.uiState.routerState && this.$viewModel.uiState.routerState.queryParams && this.$viewModel.uiState.routerState.queryParams.clearCachedDataForList) {
            //清一下bingdingdate上的东西
            this.$viewModel.repository.entityCollection.clear();
        }
    });
    /**
     * 获取ViewModel
     */
    app.config.globalProperties.$getViewModel = (/**
     * @return {?}
     */
    function () {
        /** @type {?} */
        let currentCmp = this;
        /** @type {?} */
        let viewModel = currentCmp.$viewModel;
        while (!viewModel && currentCmp.$parent) {
            currentCmp = currentCmp.$parent;
            viewModel = currentCmp.$viewModel;
        }
        return viewModel;
    });
    /**
     * 初始化组件扩展管理
     */
    app.config.globalProperties.$initComponentExtenderManager = (/**
     * @return {?}
     */
    function () {
        /** @type {?} */
        const viewModel = this.$getViewModel();
        this.$componentExtenderManager = new ComponentExtenderManager(viewModel.context);
    });
    /**
     * 获取组件扩展管理器
     */
    app.config.globalProperties.$getComponentExtenderManager = (/**
     * @return {?}
     */
    function () {
        /** @type {?} */
        let currentCmp = this;
        /** @type {?} */
        let extenderManager = currentCmp.$componentExtenderManager;
        while (!extenderManager && currentCmp.$parent) {
            currentCmp = currentCmp.$parent;
            extenderManager = currentCmp.$componentExtenderManager;
        }
        return extenderManager;
    });
    app.config.globalProperties.$bindComponentExtenders = (/**
     * @param {?} refs
     * @return {?}
     */
    function (refs) {
        if (!this.$refs) {
            return;
        }
        /** @type {?} */
        const componentInstances = Object.values(this.$refs);
        componentInstances.forEach((/**
         * @param {?} componentInstance
         * @return {?}
         */
        (componentInstance) => {
            /** @type {?} */
            const componentType = componentInstance._.type.name;
            this.$bindComponentExtender(componentInstance, componentType);
        }));
    });
    /**
     * 绑定组件扩展器
     */
    app.config.globalProperties.$bindComponentExtender = (/**
     * @param {?} componentInstance
     * @param {?} componentType
     * @return {?}
     */
    function (componentInstance, componentType) {
        if (componentInstance.$__component_extended === true) {
            return;
        }
        /** @type {?} */
        const extenderManager = this.$getComponentExtenderManager();
        /** @type {?} */
        const extender = extenderManager.getExtender(componentInstance, componentType);
        if (extender) {
            extender.extend();
            componentInstance.$__component_extended === true;
        }
    });
    /**
     * 清理所有组件扩展器
     * @param refs
     */
    app.config.globalProperties.$unbindComponentExtenders = (/**
     * @param {?} refs
     * @return {?}
     */
    function (refs) {
        if (!this.$refs) {
            return;
        }
        /** @type {?} */
        const componentInstances = Object.values(this.$refs);
        componentInstances.forEach((/**
         * @param {?} componentInstance
         * @return {?}
         */
        (componentInstance) => {
            this.$unbindComponentExtender(componentInstance);
        }));
    });
    /**
     * 清理组件扩展器状态
     */
    app.config.globalProperties.$unbindComponentExtender = (/**
     * @param {?} componentInstance
     * @return {?}
     */
    function (componentInstance) {
        /** @type {?} */
        const extenderManager = this.$getComponentExtenderManager();
        /** @type {?} */
        const extender = extenderManager.getExtender(componentInstance);
        if (extender) {
            extender.dispose();
        }
    });
    app.config.globalProperties.$initPage = (/**
     * @param {?} viewModelOptions
     * @return {?}
     */
    function (viewModelOptions) {
        this.$createViewModel(viewModelOptions);
        this.$initComponentExtenderManager();
        this.$viewModel.uiState.pageTitle && this.$changeDocumentTitle(this.$viewModel.uiState.pageTitle);
        this.$initUistate();
    });
    app.config.globalProperties.$changeDocumentTitle = (/**
     * @param {?} title
     * @return {?}
     */
    function (title) {
        document.title = title || document.title;
    });
    /**
     * VUE上格式化工具类
     */
    app.config.globalProperties.$formatUtils = formatUtils;
    /**
     * 初始化uistate上记录的状态
     */
    app.config.globalProperties.$initUistate = (/**
     * @return {?}
     */
    function () {
        this.$viewModel.uiState.listaviewState = { refreshLoading: false, loadMoreLoading: false, loadMoreFinished: false };
        this.$viewModel.uiState.searchState = { keyword: '' };
        this.$viewModel.uiState.filterState = { filters: '', filterData: '' };
        this.$viewModel.uiState.tabState = { currentTab: '' };
    });
};
/** @type {?} */
const DevkitPlugin = {
    install: (ɵ0)
};
export { DevkitPlugin };
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2a2l0LnBsdWdpbi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLXZ1ZS1hZGFwdGVyLyIsInNvdXJjZXMiOlsibGliL2RldmtpdC5wbHVnaW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDNUMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDMUMsT0FBTyxXQUFXLE1BQU0scUJBQXFCLENBQUE7QUFDN0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGlDQUFpQyxDQUFDOzs7Ozs7QUFLekUsVUFBVSxHQUFRLEVBQUUsT0FBWTtJQUV2Qzs7O09BR0c7SUFDSCxHQUFHLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLEdBQUc7Ozs7O0lBQUcsVUFBVSxTQUFpQixFQUFFLFlBQWlCOztjQUN4RSxVQUFVLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSzs7Y0FDL0IsZUFBZSxHQUFHLFNBQVMsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDOztjQUNuRCxlQUFlLEdBQUcsVUFBVSxDQUFDLGVBQWUsQ0FBQztRQUNuRCxJQUFJLGVBQWUsRUFBRTtZQUNuQixVQUFVLENBQUMsZUFBZSxDQUFDOzs7O1lBQUcsVUFBVSxNQUFNO2dCQUM1QyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQ3JCLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMxQixDQUFDLENBQUEsQ0FBQTtTQUNGO2FBQU07WUFDTCxVQUFVLENBQUMsZUFBZSxDQUFDLEdBQUcsWUFBWSxDQUFDO1NBQzVDO0lBQ0gsQ0FBQyxDQUFBLENBQUE7SUFFRDs7O09BR0c7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RyxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUUsQ0FBQztRQUN0RCxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEdBQUcsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsQ0FBQztRQUN0RSxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEdBQUcsRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLENBQUM7SUFDeEQsQ0FBQyxDQUFBLENBQUM7QUFFSixDQUFDOztNQTVRRyxZQUFZLEdBQUc7SUFFbkIsT0FBTyxNQTBRTjtDQUNGO0FBRUQsT0FBTyxFQUFFLFlBQVksRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwIH0gZnJvbSAnQGZhcnJpcy9tb2JpbGUtZGV2a2l0JztcclxuaW1wb3J0IHsgQmluZGluZ1N0YXRlcyB9IGZyb20gJy4vYmluZGluZy1zdGF0ZXMnO1xyXG5pbXBvcnQgeyBDb21wb25lbnRFeHRlbmRlck1hbmFnZXIgfSBmcm9tICcuL2NvbXBvbmVudC1leHRlbmRlcnMvaW5kZXgnO1xyXG5pbXBvcnQgeyBFdmVudFV0aWwgfSBmcm9tICcuL3V0aWxzL2luZGV4JztcclxuaW1wb3J0IGZvcm1hdFV0aWxzIGZyb20gJy4vdXRpbHMvZm9ybWF0LXVpdGwnXHJcbmltcG9ydCB7IFJvdXRlclNlcnZpY2UsIEhpc3RvcnlCYWNrU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvbW9iaWxlLWNvbW1hbmQtc2VydmljZXMnO1xyXG5cclxuXHJcbmNvbnN0IERldmtpdFBsdWdpbiA9IHtcclxuXHJcbiAgaW5zdGFsbDogZnVuY3Rpb24gKGFwcDogYW55LCBvcHRpb25zOiBhbnkpIHtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOazqOWGjOS6i+S7tlxyXG4gICAgICogQHRvZG/vvJrmmoLml7blvLrliLbnu5HlrprvvIzmmoLml7bml6Dms5XmoLnmja7nibnmgKfngbXmtLvljLrliIZcclxuICAgICAqL1xyXG4gICAgYXBwLmNvbmZpZy5nbG9iYWxQcm9wZXJ0aWVzLiRvbiA9IGZ1bmN0aW9uIChldmVudE5hbWU6IHN0cmluZywgZXZlbnRIYW5kbGVyOiBhbnkpIHtcclxuICAgICAgY29uc3Qgdm5vZGVQcm9wcyA9IHRoaXMuXy52bm9kZS5wcm9wcztcclxuICAgICAgY29uc3QgZXZlbnRIYW5kbGVyS2V5ID0gRXZlbnRVdGlsLnRvSGFuZGxlcktleShldmVudE5hbWUpO1xyXG4gICAgICBjb25zdCBvbGRFdmVudEhhbmRsZXIgPSB2bm9kZVByb3BzW2V2ZW50SGFuZGxlcktleV07XHJcbiAgICAgIGlmIChvbGRFdmVudEhhbmRsZXIpIHtcclxuICAgICAgICB2bm9kZVByb3BzW2V2ZW50SGFuZGxlcktleV0gPSBmdW5jdGlvbiAoJGV2ZW50KSB7XHJcbiAgICAgICAgICBldmVudEhhbmRsZXIoJGV2ZW50KTtcclxuICAgICAgICAgIG9sZEV2ZW50SGFuZGxlcigkZXZlbnQpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB2bm9kZVByb3BzW2V2ZW50SGFuZGxlcktleV0gPSBldmVudEhhbmRsZXI7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOa4heepuuS6i+S7tuazqOWGjFxyXG4gICAgICogQHRvZG/vvJrmmoLml7blvLrliLbmuIXnqbpcclxuICAgICAqL1xyXG4gICAgYXBwLmNvbmZpZy5nbG9iYWxQcm9wZXJ0aWVzLiRvZmYgPSBmdW5jdGlvbiAoZXZlbnROYW1lOiBzdHJpbmcpIHtcclxuICAgICAgY29uc3Qgdm5vZGVQcm9wcyA9IHRoaXMuXy52bm9kZS5wcm9wcztcclxuICAgICAgY29uc3QgZXZlbnRIYW5kbGVyS2V5ID0gRXZlbnRVdGlsLnRvSGFuZGxlcktleShldmVudE5hbWUpO1xyXG4gICAgICB2bm9kZVByb3BzW2V2ZW50SGFuZGxlcktleV0gPSBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog57uE5Lu255qEQXBw5a6e5L6LXHJcbiAgICAgKi9cclxuICAgIGFwcC5jb25maWcuZ2xvYmFsUHJvcGVydGllcy4kYXBwID0gbnVsbDtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOe7hOS7tueahFZpZXdNb2RlbOWunuS+i1xyXG4gICAgICovXHJcbiAgICBhcHAuY29uZmlnLmdsb2JhbFByb3BlcnRpZXMuJHZpZXdNb2RlbCA9IG51bGw7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnu5HlrprnirbmgIFcclxuICAgICAqL1xyXG4gICAgYXBwLmNvbmZpZy5nbG9iYWxQcm9wZXJ0aWVzLiRiaW5kaW5nU3RhdGVzID0gbnVsbDtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOe7keWumueKtuaAgVxyXG4gICAgICovXHJcbiAgICBhcHAuY29uZmlnLmdsb2JhbFByb3BlcnRpZXMuJGNvbXBvbmVudEV4dGVuZGVyTWFuYWdlciA9IG51bGw7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnu4Tku7ZBcHDlt6XljoLmlrnms5VcclxuICAgICAqL1xyXG4gICAgYXBwLmNvbmZpZy5nbG9iYWxQcm9wZXJ0aWVzLiRjcmVhdGVBcHAgPSBmdW5jdGlvbiAoYXBwT3B0aW9ucykge1xyXG4gICAgICBpZiAodGhpcy4kYXBwKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBcHDlt7Lnu4/lrZjlnKgnKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgaGlzdG9yeUJhY2tTZXJ2aWNlID0gbmV3IEhpc3RvcnlCYWNrU2VydmljZSgpO1xyXG5cclxuICAgICAgaGlzdG9yeUJhY2tTZXJ2aWNlLmluaXQoKTtcclxuICAgICAgXHJcbiAgICAgIGhpc3RvcnlCYWNrU2VydmljZS5wcm94eUJhY2soKTtcclxuXHJcbiAgICAgIHRoaXMuJGFwcCA9IG5ldyBBcHAoYXBwT3B0aW9ucyk7XHJcbiAgICAgIGZ1bmN0aW9uIHJlY2VpdmVNZXNzYWdlKGV2ZW50KSB7XHJcbiAgICAgICAgY29uc3QgY29tbWFuZE9wdGlvbnMgPSB0aGlzLiRhcHAuY29udGV4dC5pbmplY3Rvci5nZXQoJ0RFQ0xBUkFUSU9OU19UT0tFTicpO1xyXG4gICAgICAgIHZhciBtZXNzYWdlRGF0YSA9IEpTT04ucGFyc2UoZXZlbnQuZGF0YSk7XHJcbiAgICAgICAgY29uc3QgY29tbWFuZE5hbWUgPSBtZXNzYWdlRGF0YS5kYXRhLmNvbW1hbmQ7XHJcbiAgICAgICAgY29uc3QgY29tbWFuZCA9IGNvbW1hbmRPcHRpb25zLmNvbW1hbmRzW2NvbW1hbmROYW1lXTtcclxuICAgICAgICB2YXIgb3JpZ2luID0gZXZlbnQub3JpZ2luO1xyXG4gICAgICAgIHZhciBzb3VyY2UgPSBldmVudC5zb3VyY2U7XHJcbiAgICAgICAgY29uc3Qgdmlld01vZGVsQ29udGV4dCA9IHRoaXMuJGFwcC5jb250ZXh0LnZpZXdNb2RlbENvbnRleHRNYW5hZ2VyLmdldENvbnRleHRCeUlkKGNvbW1hbmQudmlld01vZGVsSWQpXHJcbiAgICAgICAgaWYgKCEhdmlld01vZGVsQ29udGV4dCkge1xyXG4gICAgICAgICAgY29uc3QgbWV0aG9kUmVzdWx0JCA9IHZpZXdNb2RlbENvbnRleHQudmlld01vZGVsW2NvbW1hbmQuY29tbWFuZF0oKTtcclxuICAgICAgICAgIG1ldGhvZFJlc3VsdCQucGlwZShcclxuICAgICAgICAgICAgKCkgPT4geyB9LFxyXG4gICAgICAgICAgICAoKSA9PiB7IH0sXHJcbiAgICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgICB3aW5kb3cucGFyZW50ICYmIHdpbmRvdy5wYXJlbnQucG9zdE1lc3NhZ2UoJ3N1Y2Nlc3MnLCBldmVudC5vcmlnaW4pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICApXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGlmICghd2luZG93WydJc0RkZGVkTWVzc2FnZUV2ZW50TGlzdGVuZXInXSkge1xyXG4gICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwibWVzc2FnZVwiLCByZWNlaXZlTWVzc2FnZS5iaW5kKHRoaXMpLCBmYWxzZSlcclxuICAgICAgICB3aW5kb3dbJ0lzRGRkZWRNZXNzYWdlRXZlbnRMaXN0ZW5lciddID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPlkFwcENvbnRleHRcclxuICAgICAqL1xyXG4gICAgYXBwLmNvbmZpZy5nbG9iYWxQcm9wZXJ0aWVzLiRnZXRBcHAgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGxldCBhcHAgPSB0aGlzLiRhcHA7XHJcbiAgICAgIGxldCBjdXJyZW50Q21wID0gdGhpcztcclxuICAgICAgd2hpbGUgKCFhcHAgJiYgY3VycmVudENtcC4kcGFyZW50KSB7XHJcbiAgICAgICAgY3VycmVudENtcCA9IGN1cnJlbnRDbXAuJHBhcmVudDtcclxuICAgICAgICBhcHAgPSBjdXJyZW50Q21wLiRhcHA7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGFwcDtcclxuICAgIH07XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnu4Tku7ZWaWV3TW9kZWzlt6XljoLmlrnms5VcclxuICAgICAqL1xyXG4gICAgYXBwLmNvbmZpZy5nbG9iYWxQcm9wZXJ0aWVzLiRjcmVhdGVWaWV3TW9kZWwgPSBmdW5jdGlvbiAodmlld01vZGVsT3B0aW9ucykge1xyXG4gICAgICB0aGlzLiRhcHAgPSB0aGlzLiRnZXRBcHAoKTtcclxuICAgICAgaWYgKCF0aGlzLiRhcHApIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ+ivt+WFiOWIm+W7ukFwcCcpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyDlpoLmnpx2aWV3TW9kZWzlt7Lnu4/lrZjlnKjvvIzliJnkvb/nlKjlt7LmnInnmoRcclxuICAgICAgY29uc3Qgdmlld01vZGVsSWQgPSB2aWV3TW9kZWxPcHRpb25zLmlkO1xyXG4gICAgICBpZiAodmlld01vZGVsSWQpIHtcclxuICAgICAgICBjb25zdCBleGlzdGVkVmlld01vZGVsQ29udGV4dCA9IHRoaXMuJGFwcC5jb250ZXh0LnZpZXdNb2RlbENvbnRleHRNYW5hZ2VyLmdldENvbnRleHRCeUlkKHZpZXdNb2RlbElkKTtcclxuICAgICAgICBpZiAoZXhpc3RlZFZpZXdNb2RlbENvbnRleHQpIHtcclxuICAgICAgICAgIHRoaXMuJHZpZXdNb2RlbCA9IGV4aXN0ZWRWaWV3TW9kZWxDb250ZXh0LnZpZXdNb2RlbDtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIOWmguaenHZpZXdNb2RlbOS4jeWtmOWcqO+8jOWImeWIm+W7uuaWsOeahHZpZXdNb2RlbO+8jOW5tuW7uueri+eItuWtkOWFs+ezu1xyXG4gICAgICBpZiAoIXRoaXMuJHZpZXdNb2RlbCkge1xyXG4gICAgICAgIGNvbnN0IHBhcmVudFZpZXdNb2RlbCA9IHRoaXMuJGdldFZpZXdNb2RlbCgpO1xyXG4gICAgICAgIGlmICghdmlld01vZGVsT3B0aW9ucy5wYXJlbnQpIHtcclxuICAgICAgICAgIHZpZXdNb2RlbE9wdGlvbnMucGFyZW50ID0gcGFyZW50Vmlld01vZGVsO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLiR2aWV3TW9kZWwgPSB0aGlzLiRhcHAuY3JlYXRlVmlld01vZGVsKHZpZXdNb2RlbE9wdGlvbnMpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyDorr7nva7nu5HlrprnirbmgIFcclxuICAgICAgdGhpcy4kYmluZGluZ1N0YXRlcyA9IG5ldyBCaW5kaW5nU3RhdGVzKHRoaXMpO1xyXG5cclxuICAgICAgLy8g5pig5bCE6Lev55Sx54q25oCBXHJcbiAgICAgIGNvbnN0IHJvdXRlclNlcnZpY2UgPSB0aGlzLiR2aWV3TW9kZWwuaW5qZWN0b3IuZ2V0KFJvdXRlclNlcnZpY2UpO1xyXG4gICAgICByb3V0ZXJTZXJ2aWNlLm1hcHBpbmdUb1VJU3RhdGUoKTtcclxuXHJcbiAgICAgIC8vIOagueaNrui3r+eUseWPguaVsOa4heeQhuWNoeeJh+e8k+WtmOaVsOaNrlxyXG4gICAgICBpZiAodGhpcy4kdmlld01vZGVsICYmIHRoaXMuJHZpZXdNb2RlbC51aVN0YXRlICYmIHRoaXMuJHZpZXdNb2RlbC51aVN0YXRlLnJvdXRlclN0YXRlICYmIHRoaXMuJHZpZXdNb2RlbC51aVN0YXRlLnJvdXRlclN0YXRlLnF1ZXJ5UGFyYW1zICYmIHRoaXMuJHZpZXdNb2RlbC51aVN0YXRlLnJvdXRlclN0YXRlLnF1ZXJ5UGFyYW1zLmNsZWFyQ2FjaGVkRGF0YUZvckNhcmQpIHtcclxuICAgICAgICAvL+a4heS4gOS4i2JpbmdkaW5nZGF0ZeS4iueahOS4nOilv1xyXG4gICAgICAgIHRoaXMuJHZpZXdNb2RlbC5jb250ZXh0LmJpbmRpbmdEYXRhLmdldExpc3QoKS5jdXJyZW50SWQgPSBudWxsO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyDmoLnmja7ot6/nlLHlj4LmlbDmuIXnkIbliJfooajnvJPlrZjmlbDmja5cclxuICAgICAgaWYgKHRoaXMuJHZpZXdNb2RlbCAmJiB0aGlzLiR2aWV3TW9kZWwudWlTdGF0ZSAmJiB0aGlzLiR2aWV3TW9kZWwudWlTdGF0ZS5yb3V0ZXJTdGF0ZSAmJiB0aGlzLiR2aWV3TW9kZWwudWlTdGF0ZS5yb3V0ZXJTdGF0ZS5xdWVyeVBhcmFtcyAmJiB0aGlzLiR2aWV3TW9kZWwudWlTdGF0ZS5yb3V0ZXJTdGF0ZS5xdWVyeVBhcmFtcy5jbGVhckNhY2hlZERhdGFGb3JMaXN0KSB7XHJcbiAgICAgICAgLy/muIXkuIDkuItiaW5nZGluZ2RhdGXkuIrnmoTkuJzopb9cclxuICAgICAgICB0aGlzLiR2aWV3TW9kZWwucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmNsZWFyKCk7XHJcbiAgICAgIH1cclxuXHJcblxyXG4gICAgfTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPllZpZXdNb2RlbFxyXG4gICAgICovXHJcbiAgICBhcHAuY29uZmlnLmdsb2JhbFByb3BlcnRpZXMuJGdldFZpZXdNb2RlbCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgbGV0IGN1cnJlbnRDbXAgPSB0aGlzO1xyXG4gICAgICBsZXQgdmlld01vZGVsID0gY3VycmVudENtcC4kdmlld01vZGVsO1xyXG4gICAgICB3aGlsZSAoIXZpZXdNb2RlbCAmJiBjdXJyZW50Q21wLiRwYXJlbnQpIHtcclxuICAgICAgICBjdXJyZW50Q21wID0gY3VycmVudENtcC4kcGFyZW50O1xyXG4gICAgICAgIHZpZXdNb2RlbCA9IGN1cnJlbnRDbXAuJHZpZXdNb2RlbDtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdmlld01vZGVsO1xyXG4gICAgfTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOWIneWni+WMlue7hOS7tuaJqeWxleeuoeeQhlxyXG4gICAgICovXHJcbiAgICBhcHAuY29uZmlnLmdsb2JhbFByb3BlcnRpZXMuJGluaXRDb21wb25lbnRFeHRlbmRlck1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGNvbnN0IHZpZXdNb2RlbCA9IHRoaXMuJGdldFZpZXdNb2RlbCgpO1xyXG4gICAgICB0aGlzLiRjb21wb25lbnRFeHRlbmRlck1hbmFnZXIgPSBuZXcgQ29tcG9uZW50RXh0ZW5kZXJNYW5hZ2VyKHZpZXdNb2RlbC5jb250ZXh0KTtcclxuICAgIH07XHJcblxyXG5cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPlue7hOS7tuaJqeWxleeuoeeQhuWZqFxyXG4gICAgICovXHJcbiAgICBhcHAuY29uZmlnLmdsb2JhbFByb3BlcnRpZXMuJGdldENvbXBvbmVudEV4dGVuZGVyTWFuYWdlciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgbGV0IGN1cnJlbnRDbXAgPSB0aGlzO1xyXG4gICAgICBsZXQgZXh0ZW5kZXJNYW5hZ2VyID0gY3VycmVudENtcC4kY29tcG9uZW50RXh0ZW5kZXJNYW5hZ2VyO1xyXG4gICAgICB3aGlsZSAoIWV4dGVuZGVyTWFuYWdlciAmJiBjdXJyZW50Q21wLiRwYXJlbnQpIHtcclxuICAgICAgICBjdXJyZW50Q21wID0gY3VycmVudENtcC4kcGFyZW50O1xyXG4gICAgICAgIGV4dGVuZGVyTWFuYWdlciA9IGN1cnJlbnRDbXAuJGNvbXBvbmVudEV4dGVuZGVyTWFuYWdlcjtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gZXh0ZW5kZXJNYW5hZ2VyO1xyXG4gICAgfTtcclxuXHJcbiAgICBhcHAuY29uZmlnLmdsb2JhbFByb3BlcnRpZXMuJGJpbmRDb21wb25lbnRFeHRlbmRlcnMgPSBmdW5jdGlvbiAocmVmczogYW55KSB7XHJcbiAgICAgIGlmICghdGhpcy4kcmVmcykge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBjb21wb25lbnRJbnN0YW5jZXMgPSBPYmplY3QudmFsdWVzKHRoaXMuJHJlZnMpO1xyXG4gICAgICBjb21wb25lbnRJbnN0YW5jZXMuZm9yRWFjaCgoY29tcG9uZW50SW5zdGFuY2U6IGFueSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNvbXBvbmVudFR5cGUgPSBjb21wb25lbnRJbnN0YW5jZS5fLnR5cGUubmFtZTtcclxuICAgICAgICB0aGlzLiRiaW5kQ29tcG9uZW50RXh0ZW5kZXIoY29tcG9uZW50SW5zdGFuY2UsIGNvbXBvbmVudFR5cGUpO1xyXG4gICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnu5Hlrprnu4Tku7bmianlsZXlmahcclxuICAgICAqL1xyXG4gICAgYXBwLmNvbmZpZy5nbG9iYWxQcm9wZXJ0aWVzLiRiaW5kQ29tcG9uZW50RXh0ZW5kZXIgPSBmdW5jdGlvbiAoY29tcG9uZW50SW5zdGFuY2UsIGNvbXBvbmVudFR5cGUpIHtcclxuICAgICAgaWYgKGNvbXBvbmVudEluc3RhbmNlLiRfX2NvbXBvbmVudF9leHRlbmRlZCA9PT0gdHJ1ZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgZXh0ZW5kZXJNYW5hZ2VyID0gdGhpcy4kZ2V0Q29tcG9uZW50RXh0ZW5kZXJNYW5hZ2VyKCk7XHJcbiAgICAgIGNvbnN0IGV4dGVuZGVyID0gZXh0ZW5kZXJNYW5hZ2VyLmdldEV4dGVuZGVyKGNvbXBvbmVudEluc3RhbmNlLCBjb21wb25lbnRUeXBlKTtcclxuICAgICAgaWYgKGV4dGVuZGVyKSB7XHJcbiAgICAgICAgZXh0ZW5kZXIuZXh0ZW5kKCk7XHJcbiAgICAgICAgY29tcG9uZW50SW5zdGFuY2UuJF9fY29tcG9uZW50X2V4dGVuZGVkID09PSB0cnVlXHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmuIXnkIbmiYDmnInnu4Tku7bmianlsZXlmahcclxuICAgICAqIEBwYXJhbSByZWZzIFxyXG4gICAgICovXHJcbiAgICBhcHAuY29uZmlnLmdsb2JhbFByb3BlcnRpZXMuJHVuYmluZENvbXBvbmVudEV4dGVuZGVycyA9IGZ1bmN0aW9uIChyZWZzOiBhbnkpIHtcclxuICAgICAgaWYgKCF0aGlzLiRyZWZzKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IGNvbXBvbmVudEluc3RhbmNlcyA9IE9iamVjdC52YWx1ZXModGhpcy4kcmVmcyk7XHJcbiAgICAgIGNvbXBvbmVudEluc3RhbmNlcy5mb3JFYWNoKChjb21wb25lbnRJbnN0YW5jZTogYW55KSA9PiB7XHJcbiAgICAgICAgdGhpcy4kdW5iaW5kQ29tcG9uZW50RXh0ZW5kZXIoY29tcG9uZW50SW5zdGFuY2UpO1xyXG4gICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmuIXnkIbnu4Tku7bmianlsZXlmajnirbmgIFcclxuICAgICAqL1xyXG4gICAgYXBwLmNvbmZpZy5nbG9iYWxQcm9wZXJ0aWVzLiR1bmJpbmRDb21wb25lbnRFeHRlbmRlciA9IGZ1bmN0aW9uIChjb21wb25lbnRJbnN0YW5jZSkge1xyXG4gICAgICBjb25zdCBleHRlbmRlck1hbmFnZXIgPSB0aGlzLiRnZXRDb21wb25lbnRFeHRlbmRlck1hbmFnZXIoKTtcclxuICAgICAgY29uc3QgZXh0ZW5kZXIgPSBleHRlbmRlck1hbmFnZXIuZ2V0RXh0ZW5kZXIoY29tcG9uZW50SW5zdGFuY2UpO1xyXG4gICAgICBpZiAoZXh0ZW5kZXIpIHtcclxuICAgICAgICBleHRlbmRlci5kaXNwb3NlKCk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgYXBwLmNvbmZpZy5nbG9iYWxQcm9wZXJ0aWVzLiRpbml0UGFnZSA9IGZ1bmN0aW9uICh2aWV3TW9kZWxPcHRpb25zKSB7XHJcbiAgICAgIHRoaXMuJGNyZWF0ZVZpZXdNb2RlbCh2aWV3TW9kZWxPcHRpb25zKTtcclxuICAgICAgdGhpcy4kaW5pdENvbXBvbmVudEV4dGVuZGVyTWFuYWdlcigpO1xyXG4gICAgICB0aGlzLiR2aWV3TW9kZWwudWlTdGF0ZS5wYWdlVGl0bGUgJiYgdGhpcy4kY2hhbmdlRG9jdW1lbnRUaXRsZSh0aGlzLiR2aWV3TW9kZWwudWlTdGF0ZS5wYWdlVGl0bGUpO1xyXG4gICAgICB0aGlzLiRpbml0VWlzdGF0ZSgpO1xyXG4gICAgfTtcclxuXHJcbiAgICBhcHAuY29uZmlnLmdsb2JhbFByb3BlcnRpZXMuJGNoYW5nZURvY3VtZW50VGl0bGUgPSBmdW5jdGlvbiAodGl0bGU6IHN0cmluZykge1xyXG4gICAgICBkb2N1bWVudC50aXRsZSA9IHRpdGxlIHx8IGRvY3VtZW50LnRpdGxlXHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBWVUXkuIrmoLzlvI/ljJblt6XlhbfnsbtcclxuICAgICAqL1xyXG4gICAgYXBwLmNvbmZpZy5nbG9iYWxQcm9wZXJ0aWVzLiRmb3JtYXRVdGlscyA9IGZvcm1hdFV0aWxzO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yid5aeL5YyWdWlzdGF0ZeS4iuiusOW9leeahOeKtuaAgVxyXG4gICAgICovXHJcbiAgICBhcHAuY29uZmlnLmdsb2JhbFByb3BlcnRpZXMuJGluaXRVaXN0YXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICB0aGlzLiR2aWV3TW9kZWwudWlTdGF0ZS5saXN0YXZpZXdTdGF0ZSA9IHsgcmVmcmVzaExvYWRpbmc6IGZhbHNlLCBsb2FkTW9yZUxvYWRpbmc6IGZhbHNlLCBsb2FkTW9yZUZpbmlzaGVkOiBmYWxzZSB9O1xyXG4gICAgICB0aGlzLiR2aWV3TW9kZWwudWlTdGF0ZS5zZWFyY2hTdGF0ZSA9IHsga2V5d29yZDogJycgfTtcclxuICAgICAgdGhpcy4kdmlld01vZGVsLnVpU3RhdGUuZmlsdGVyU3RhdGUgPSB7IGZpbHRlcnM6ICcnLCBmaWx0ZXJEYXRhOiAnJyB9O1xyXG4gICAgICB0aGlzLiR2aWV3TW9kZWwudWlTdGF0ZS50YWJTdGF0ZSA9IHsgY3VycmVudFRhYjogJycgfTtcclxuICAgIH07XHJcblxyXG4gIH1cclxufTtcclxuXHJcbmV4cG9ydCB7IERldmtpdFBsdWdpbiB9O1xyXG4iXX0=