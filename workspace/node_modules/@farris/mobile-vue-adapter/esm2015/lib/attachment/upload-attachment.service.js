/**
 * @fileoverview added by tsickle
 * Generated from: lib/attachment/upload-attachment.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { HttpMethods } from '@farris/mobile-devkit';
import { forkJoin } from 'rxjs';
import { map, mergeMap } from 'rxjs/operators';
import { getToken, mergeString } from '../utils';
export class UploadAttachmentService {
    /**
     * @param {?} befRepository
     */
    constructor(befRepository) {
        this.befRepository = befRepository;
    }
    /**
     * 缓存附件
     * @param {?} originFiles
     * @param {?} uploadInfo
     * @return {?}
     */
    upload(originFiles, uploadInfo) {
        /** @type {?} */
        const apiProxy = this.befRepository.apiProxy;
        /** @type {?} */
        const uploadUrl = `/api/runtime/dfs/v1.0/formdoc`;
        /** @type {?} */
        const parametersArr = originFiles.map((/**
         * @param {?} ele
         * @return {?}
         */
        ele => {
            return {
                docInfo: {
                    fileContent: ele.content.substring(ele.content.indexOf(',') + 1),
                    fileName: ele.file.name,
                    index: 0,
                    total: 1,
                    metadataId: ele.id
                },
                formId: uploadInfo.parentDirName,
                mode: 1,
                rootId: uploadInfo.rootId || 'default-root'
            };
        }));
        /** @type {?} */
        const requestList = parametersArr.map((/**
         * @param {?} ele
         * @return {?}
         */
        ele => {
            /** @type {?} */
            const params = { body: ele };
            return apiProxy.request(HttpMethods.POST, uploadUrl, params, true);
        }));
        return forkJoin(requestList);
    }
    /**
     * 预览附件pdf
     * @param {?} rootId
     * @param {?} metadataIdList
     * @return {?}
     */
    previewPdf(rootId, metadataIdList) {
        /** @type {?} */
        const baseUrl = '/platform/runtime/dfs/web/pdfjs/viewer.html?file=';
        /** @type {?} */
        const apiProxy = this.befRepository.apiProxy;
        /** @type {?} */
        const fileListUrl = '/api/runtime/dfs/v1.0/fileviewer/filelist';
        /** @type {?} */
        const params = {
            storageType: 2, filePath: JSON.stringify({
                rootId,
                metadataIdList
            })
        };
        /** @type {?} */
        const body = { body: params };
        // 预览
        return apiProxy.request(HttpMethods.POST, fileListUrl, body).pipe(map((/**
         * @param {?} res
         * @return {?}
         */
        res => baseUrl + encodeURIComponent(res[0].filePath))));
    }
    /**
     * 预览office txt文档
     * @param {?} rootId
     * @param {?} metadataIdList
     * @return {?}
     */
    previewDoc(rootId, metadataIdList) {
        /** @type {?} */
        const apiProxy = this.befRepository.apiProxy;
        /** @type {?} */
        const fileListUrl = '/api/runtime/dfs/v1.0/fileviewer/filelist';
        /** @type {?} */
        const loadDocUrl = '/api/runtime/dfs/v1.0/docviewer/loaddocument';
        /** @type {?} */
        const params = {
            storageType: 2, filePath: JSON.stringify({
                rootId,
                metadataIdList
            })
        };
        /** @type {?} */
        const body = { body: params };
        // 根据文件类型 调用不同的预览接口
        return apiProxy.request(HttpMethods.POST, fileListUrl, body)
            .pipe(mergeMap((/**
         * @param {?} res
         * @return {?}
         */
        res => apiProxy.request(HttpMethods.POST, loadDocUrl, { body: { filePath: res[0].filePath } }))), map((/**
         * @param {?} res
         * @return {?}
         */
        res => res.pages)));
    }
    /**
     * 获取图片url
     * @param {?} attachmentId  附件id
     * @param {?} rootId 根目录id
     * @return {?}
     */
    getAttachmentPath(attachmentId, rootId) {
        return `/api/runtime/dfs/v1.0/doc/filecontent?metadataid=${attachmentId}&rootid=${rootId}&token=${getToken(mergeString(attachmentId, rootId))}`;
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    UploadAttachmentService.prototype.befRepository;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkLWF0dGFjaG1lbnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLXZ1ZS1hZGFwdGVyLyIsInNvdXJjZXMiOlsibGliL2F0dGFjaG1lbnQvdXBsb2FkLWF0dGFjaG1lbnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNwRCxPQUFPLEVBQWMsUUFBUSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVDLE9BQU8sRUFBVSxHQUFHLEVBQUUsUUFBUSxFQUFPLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFakQsTUFBTSxPQUFPLHVCQUF1Qjs7OztJQUNoQyxZQUFvQixhQUFpQztRQUFqQyxrQkFBYSxHQUFiLGFBQWEsQ0FBb0I7SUFFckQsQ0FBQzs7Ozs7OztJQU9ELE1BQU0sQ0FBQyxXQUFrQixFQUFFLFVBQWU7O2NBQ2hDLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVE7O2NBQ3RDLFNBQVMsR0FBRywrQkFBK0I7O2NBQzNDLGFBQWEsR0FBRyxXQUFXLENBQUMsR0FBRzs7OztRQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3hDLE9BQU87Z0JBQ0gsT0FBTyxFQUFFO29CQUNMLFdBQVcsRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FDOUIsR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUMvQjtvQkFDRCxRQUFRLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJO29CQUN2QixLQUFLLEVBQUUsQ0FBQztvQkFDUixLQUFLLEVBQUUsQ0FBQztvQkFDUixVQUFVLEVBQUUsR0FBRyxDQUFDLEVBQUU7aUJBQ3JCO2dCQUNELE1BQU0sRUFBRSxVQUFVLENBQUMsYUFBYTtnQkFDaEMsSUFBSSxFQUFFLENBQUM7Z0JBQ1AsTUFBTSxFQUFFLFVBQVUsQ0FBQyxNQUFNLElBQUksY0FBYzthQUM5QyxDQUFDO1FBQ04sQ0FBQyxFQUFDOztjQUNJLFdBQVcsR0FBRyxhQUFhLENBQUMsR0FBRzs7OztRQUFDLEdBQUcsQ0FBQyxFQUFFOztrQkFDbEMsTUFBTSxHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRTtZQUM1QixPQUFPLFFBQVEsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3ZFLENBQUMsRUFBQztRQUNGLE9BQU8sUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7Ozs7Ozs7SUFRRCxVQUFVLENBQUMsTUFBYyxFQUFFLGNBQXdCOztjQUN6QyxPQUFPLEdBQUcsbURBQW1EOztjQUM3RCxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFROztjQUN0QyxXQUFXLEdBQUcsMkNBQTJDOztjQUN6RCxNQUFNLEdBQUc7WUFDWCxXQUFXLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO2dCQUNyQyxNQUFNO2dCQUNOLGNBQWM7YUFDakIsQ0FBQztTQUNMOztjQUNLLElBQUksR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUU7UUFDN0IsS0FBSztRQUNMLE9BQU8sUUFBUSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQzdELEdBQUc7Ozs7UUFBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE9BQU8sR0FBRyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUMsQ0FDNUQsQ0FBQztJQUNOLENBQUM7Ozs7Ozs7SUFPRCxVQUFVLENBQUMsTUFBYyxFQUFFLGNBQXdCOztjQUN6QyxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFROztjQUN0QyxXQUFXLEdBQUcsMkNBQTJDOztjQUN6RCxVQUFVLEdBQUcsOENBQThDOztjQUMzRCxNQUFNLEdBQUc7WUFDWCxXQUFXLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO2dCQUNyQyxNQUFNO2dCQUNOLGNBQWM7YUFDakIsQ0FBQztTQUNMOztjQUNLLElBQUksR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUU7UUFDN0IsbUJBQW1CO1FBQ25CLE9BQU8sUUFBUSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUM7YUFDdkQsSUFBSSxDQUNELFFBQVE7Ozs7UUFBQyxHQUFHLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxVQUFVLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsRUFBQyxFQUN4RyxHQUFHOzs7O1FBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFDLENBQ3hCLENBQUM7SUFDVixDQUFDOzs7Ozs7O0lBU0QsaUJBQWlCLENBQUMsWUFBb0IsRUFBRSxNQUFjO1FBQ2xELE9BQU8sb0RBQW9ELFlBQVksV0FBVyxNQUFNLFVBQVUsUUFBUSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQ3BKLENBQUM7Q0FDSjs7Ozs7O0lBNUZlLGdEQUF5QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJlZlJlcG9zaXRvcnkgfSBmcm9tICdAZmFycmlzL21vYmlsZS1iZWYnO1xyXG5pbXBvcnQgeyBIdHRwTWV0aG9kcyB9IGZyb20gJ0BmYXJyaXMvbW9iaWxlLWRldmtpdCc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIGZvcmtKb2luIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGZpbHRlciwgbWFwLCBtZXJnZU1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBnZXRUb2tlbiwgbWVyZ2VTdHJpbmcgfSBmcm9tICcuLi91dGlscyc7XHJcblxyXG5leHBvcnQgY2xhc3MgVXBsb2FkQXR0YWNobWVudFNlcnZpY2Uge1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBiZWZSZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PGFueT4pIHtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnvJPlrZjpmYTku7ZcclxuICAgICAqIEBwYXJhbSBvcmlnaW5GaWxlc1xyXG4gICAgICogQHBhcmFtIHVwbG9hZEluZm9cclxuICAgICAqL1xyXG4gICAgdXBsb2FkKG9yaWdpbkZpbGVzOiBhbnlbXSwgdXBsb2FkSW5mbzogYW55KSB7XHJcbiAgICAgICAgY29uc3QgYXBpUHJveHkgPSB0aGlzLmJlZlJlcG9zaXRvcnkuYXBpUHJveHk7XHJcbiAgICAgICAgY29uc3QgdXBsb2FkVXJsID0gYC9hcGkvcnVudGltZS9kZnMvdjEuMC9mb3JtZG9jYDtcclxuICAgICAgICBjb25zdCBwYXJhbWV0ZXJzQXJyID0gb3JpZ2luRmlsZXMubWFwKGVsZSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBkb2NJbmZvOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmlsZUNvbnRlbnQ6IGVsZS5jb250ZW50LnN1YnN0cmluZyhcclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxlLmNvbnRlbnQuaW5kZXhPZignLCcpICsgMVxyXG4gICAgICAgICAgICAgICAgICAgICksXHJcbiAgICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IGVsZS5maWxlLm5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgaW5kZXg6IDAsXHJcbiAgICAgICAgICAgICAgICAgICAgdG90YWw6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgbWV0YWRhdGFJZDogZWxlLmlkXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgZm9ybUlkOiB1cGxvYWRJbmZvLnBhcmVudERpck5hbWUsXHJcbiAgICAgICAgICAgICAgICBtb2RlOiAxLFxyXG4gICAgICAgICAgICAgICAgcm9vdElkOiB1cGxvYWRJbmZvLnJvb3RJZCB8fCAnZGVmYXVsdC1yb290J1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IHJlcXVlc3RMaXN0ID0gcGFyYW1ldGVyc0Fyci5tYXAoZWxlID0+IHtcclxuICAgICAgICAgICAgY29uc3QgcGFyYW1zID0geyBib2R5OiBlbGUgfTtcclxuICAgICAgICAgICAgcmV0dXJuIGFwaVByb3h5LnJlcXVlc3QoSHR0cE1ldGhvZHMuUE9TVCwgdXBsb2FkVXJsLCBwYXJhbXMsIHRydWUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBmb3JrSm9pbihyZXF1ZXN0TGlzdCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDpooTop4jpmYTku7ZwZGZcclxuICAgICAqIEBwYXJhbSBmaWxlVHlwZVxyXG4gICAgICogQHBhcmFtIHJvb3RJZFxyXG4gICAgICogQHBhcmFtIG1ldGFkYXRhSWRMaXN0XHJcbiAgICAgKi9cclxuICAgIHByZXZpZXdQZGYocm9vdElkOiBzdHJpbmcsIG1ldGFkYXRhSWRMaXN0OiBzdHJpbmdbXSkge1xyXG4gICAgICAgIGNvbnN0IGJhc2VVcmwgPSAnL3BsYXRmb3JtL3J1bnRpbWUvZGZzL3dlYi9wZGZqcy92aWV3ZXIuaHRtbD9maWxlPSc7XHJcbiAgICAgICAgY29uc3QgYXBpUHJveHkgPSB0aGlzLmJlZlJlcG9zaXRvcnkuYXBpUHJveHk7XHJcbiAgICAgICAgY29uc3QgZmlsZUxpc3RVcmwgPSAnL2FwaS9ydW50aW1lL2Rmcy92MS4wL2ZpbGV2aWV3ZXIvZmlsZWxpc3QnO1xyXG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHtcclxuICAgICAgICAgICAgc3RvcmFnZVR5cGU6IDIsIGZpbGVQYXRoOiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICAgICAgICByb290SWQsXHJcbiAgICAgICAgICAgICAgICBtZXRhZGF0YUlkTGlzdFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgY29uc3QgYm9keSA9IHsgYm9keTogcGFyYW1zIH07XHJcbiAgICAgICAgLy8g6aKE6KeIXHJcbiAgICAgICAgcmV0dXJuIGFwaVByb3h5LnJlcXVlc3QoSHR0cE1ldGhvZHMuUE9TVCwgZmlsZUxpc3RVcmwsIGJvZHkpLnBpcGUoXHJcbiAgICAgICAgICAgIG1hcChyZXMgPT4gYmFzZVVybCArIGVuY29kZVVSSUNvbXBvbmVudChyZXNbMF0uZmlsZVBhdGgpKVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDpooTop4hvZmZpY2UgdHh05paH5qGjXHJcbiAgICAgKiBAcGFyYW0gcm9vdElkXHJcbiAgICAgKiBAcGFyYW0gbWV0YWRhdGFJZExpc3RcclxuICAgICAqL1xyXG4gICAgcHJldmlld0RvYyhyb290SWQ6IHN0cmluZywgbWV0YWRhdGFJZExpc3Q6IHN0cmluZ1tdKSB7XHJcbiAgICAgICAgY29uc3QgYXBpUHJveHkgPSB0aGlzLmJlZlJlcG9zaXRvcnkuYXBpUHJveHk7XHJcbiAgICAgICAgY29uc3QgZmlsZUxpc3RVcmwgPSAnL2FwaS9ydW50aW1lL2Rmcy92MS4wL2ZpbGV2aWV3ZXIvZmlsZWxpc3QnO1xyXG4gICAgICAgIGNvbnN0IGxvYWREb2NVcmwgPSAnL2FwaS9ydW50aW1lL2Rmcy92MS4wL2RvY3ZpZXdlci9sb2FkZG9jdW1lbnQnO1xyXG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHtcclxuICAgICAgICAgICAgc3RvcmFnZVR5cGU6IDIsIGZpbGVQYXRoOiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICAgICAgICByb290SWQsXHJcbiAgICAgICAgICAgICAgICBtZXRhZGF0YUlkTGlzdFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgY29uc3QgYm9keSA9IHsgYm9keTogcGFyYW1zIH07XHJcbiAgICAgICAgLy8g5qC55o2u5paH5Lu257G75Z6LIOiwg+eUqOS4jeWQjOeahOmihOiniOaOpeWPo1xyXG4gICAgICAgIHJldHVybiBhcGlQcm94eS5yZXF1ZXN0KEh0dHBNZXRob2RzLlBPU1QsIGZpbGVMaXN0VXJsLCBib2R5KVxyXG4gICAgICAgICAgICAucGlwZShcclxuICAgICAgICAgICAgICAgIG1lcmdlTWFwKHJlcyA9PiBhcGlQcm94eS5yZXF1ZXN0KEh0dHBNZXRob2RzLlBPU1QsIGxvYWREb2NVcmwsIHsgYm9keTogeyBmaWxlUGF0aDogcmVzWzBdLmZpbGVQYXRoIH0gfSkpLFxyXG4gICAgICAgICAgICAgICAgbWFwKHJlcyA9PiByZXMucGFnZXMpXHJcbiAgICAgICAgICAgICk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6I635Y+W5Zu+54mHdXJsXHJcbiAgICAgKiBAcGFyYW0gYXR0YWNobWVudElkICDpmYTku7ZpZFxyXG4gICAgICogQHBhcmFtIHJvb3RJZCDmoLnnm67lvZVpZFxyXG4gICAgICogQHJldHVybnMgXHJcbiAgICAgKi9cclxuICAgIGdldEF0dGFjaG1lbnRQYXRoKGF0dGFjaG1lbnRJZDogc3RyaW5nLCByb290SWQ6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiBgL2FwaS9ydW50aW1lL2Rmcy92MS4wL2RvYy9maWxlY29udGVudD9tZXRhZGF0YWlkPSR7YXR0YWNobWVudElkfSZyb290aWQ9JHtyb290SWR9JnRva2VuPSR7Z2V0VG9rZW4obWVyZ2VTdHJpbmcoYXR0YWNobWVudElkLCByb290SWQpKX1gO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==