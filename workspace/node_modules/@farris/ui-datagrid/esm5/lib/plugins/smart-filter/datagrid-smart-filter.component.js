/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { cloneDeep } from 'lodash-es';
import { IdService } from '@farris/ui-common';
import { Component, ViewChild, TemplateRef, Renderer2, ElementRef, NgZone, Injector, Input, HostListener, Optional } from '@angular/core';
import { FilterPanelService } from '@farris/ui-filter-panel';
import { DatagridComponent } from '../../datagrid.component';
import { DatagridSmartFilterService } from '../../services/datagrid-smart-filter.service';
var DatagridSmartFilterComponent = /** @class */ (function () {
    function DatagridSmartFilterComponent(render, el, zone, inject, filterPanelService, smartFilterSer, dg) {
        this.render = render;
        this.el = el;
        this.zone = zone;
        this.inject = inject;
        this.filterPanelService = filterPanelService;
        this.smartFilterSer = smartFilterSer;
        this.dg = dg;
        this.filterData = null;
        this.disabled = false;
        this.smartFilterDataChanged$ = null;
        this.removeFilter$ = null;
        this.clearAllFilter$ = null;
        this.smartFilterEvents = [];
        this.idService = this.inject.get(IdService, null);
    }
    /**
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (!this.removeFilter$) {
            this.removeFilter$ = this.smartFilterSer.removeFilter.subscribe((/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                if (e && e.labelCode === _this.column.field) {
                    _this.filterData = null;
                    _this.render.removeClass(_this.el.nativeElement, 'active');
                }
            }));
            this.smartFilterEvents.push(this.removeFilter$);
        }
        if (!this.clearAllFilter$) {
            this.clearAllFilter$ = this.smartFilterSer.clearAllFilter.subscribe((/**
             * @return {?}
             */
            function () {
                _this.filterData = null;
                _this.render.removeClass(_this.el.nativeElement, 'active');
            }));
            this.smartFilterEvents.push(this.clearAllFilter$);
        }
        if (this.dg && !this.smartFilterDataChanged$) {
            this.smartFilterDataChanged$ = this.dg.dgs['smartFilterDataChange'].subscribe((/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                if (e && _this.column.field === e.fieldCode) {
                    _this.filterData.value = e.value;
                    _this.filterData.control.single = e.control.single;
                }
            }));
            this.smartFilterEvents.push(this.smartFilterDataChanged$);
        }
        this.dg.dgs.clearFilter.subscribe((/**
         * @return {?}
         */
        function () {
            _this.filterData = null;
            _this.dg.smartFilterResult = { controlData: [], conditions: [] };
            _this.smartFilterSer.clearAll();
            _this.render.removeClass(_this.el.nativeElement, 'active');
        }));
    };
    /**
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (this.filterPanelRef) {
            this.filterPanelService.hidePanel();
            this.filterPanelRef = null;
        }
        if (this.smartFilterEvents && this.smartFilterEvents.length) {
            this.smartFilterEvents.forEach((/**
             * @param {?} n
             * @return {?}
             */
            function (n) {
                n.unsubscribe();
                n = null;
            }));
            this.smartFilterEvents = [];
        }
    };
    /**
     * @private
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.getFilterData = /**
     * @private
     * @return {?}
     */
    function () {
        var _a = this.column, field = _a.field, title = _a.title;
        if (!this.filterData) {
            this.filterData = this.smartFilterSer.controlData.find((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n.id === field; }));
        }
        if (!this.filterData) {
            this.filterData = {
                id: field,
                labelCode: field,
                code: field,
                name: title,
                control: this.smartFilterSer.getColumnFilterData(this.column),
                placeHolder: '',
                value: {
                    value: ''
                }
            };
        }
        // tfs 578285
        if (this.filterData.value && this.filterData.control.controltype.indexOf('flexible') > -1) {
            if (this.filterData.value.single) {
                delete this.filterData.value.startValue;
                delete this.filterData.value.endValue;
            }
            else {
                this.filterData.value.value = '';
            }
        }
        return cloneDeep(this.filterData);
    };
    /**
     * @private
     * @param {?} $event
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.getPanelPosition = /**
     * @private
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        /** @type {?} */
        var x = $event.pageX - 33;
        /** @type {?} */
        var y = $event.pageY + 9;
        /** @type {?} */
        var targetRect = $event.target.getBoundingClientRect();
        /** @type {?} */
        var moveArrow = 0;
        if (window.innerWidth - x < 380) {
            /** @type {?} */
            var i = 380 - (window.innerWidth - x);
            x = x - i - 20;
            moveArrow = targetRect.left - x;
        }
        return { x: x, y: y, moveArrow: moveArrow };
    };
    /**
     * @private
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.hideFilterPanel = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.filterPanelRef) {
            this.filterPanelService.hidePanel();
            this.filterPanelRef = null;
            if (!this.filterData || (this.filterData.control.controltype === 'bool-check' ? !this.filterData.value.value : !this.filterData.valueText)) {
                this.render.removeClass(this.el.nativeElement, 'active');
            }
        }
    };
    /**
     * @private
     * @param {?} e
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.clearColumnFilter = /**
     * @private
     * @param {?} e
     * @return {?}
     */
    function (e) {
        this.filterData = null;
        this.hideFilterPanel();
        this.smartFilterSer.removeCondition(e);
    };
    /**
     * @param {?} $event
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.showFilterPanel = /**
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        var _this = this;
        $event.stopPropagation();
        this.render.addClass(this.el.nativeElement, 'active');
        var _a = this.getPanelPosition($event), x = _a.x, y = _a.y, moveArrow = _a.moveArrow;
        this.filterPanelRef = this.filterPanelService.showPanel({
            left: x,
            top: y,
            item: this.getFilterData(),
            panelExtendTemplate: this.column.sortable ? this.sortTmp : null,
            localStorageKey: 'smartfilter_' + this.dg.dgs.createConfigKey(this.dg.id),
            target: $event.target
        });
        if (moveArrow) {
            /** @type {?} */
            var arrowEl = this.filterPanelRef['el'].querySelector('.f-filter-panel-arrow');
            if (arrowEl) {
                this.render.setStyle(arrowEl, 'left', moveArrow + "px");
            }
        }
        this.filterPanelRef.dataChange.subscribe((/**
         * @param {?} item
         * @return {?}
         */
        function (item) {
            if (_this.filterData && _this.filterData.id == item.id) {
                if (item.value && item.value.single !== undefined) {
                    _this.filterData.value = item.value;
                    _this.filterData.control.single = item.value.single;
                }
            }
        }));
        this.filterPanelRef.hidePanel.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            _this.hideFilterPanel();
        }));
        this.filterPanelRef.filterSubmit.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (e.filter && e.filter.length) {
                _this.filterData = e.item || null;
                _this.hideFilterPanel();
                _this.smartFilterSer.filterConditionChanged({ conditions: e.filter, controlData: e.item, from: 'panel' });
            }
            else {
                _this.clearColumnFilter(e.item);
            }
        }));
        this.filterPanelRef.clearFilter.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            _this.clearColumnFilter(e);
        }));
    };
    /**
     * @param {?} $event
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.onClick = /**
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        $event.stopPropagation();
        if (this.disabled) {
            return;
        }
        this.showFilterPanel($event);
        return false;
    };
    /**
     * @param {?} $event
     * @param {?} order
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.onSort = /**
     * @param {?} $event
     * @param {?} order
     * @return {?}
     */
    function ($event, order) {
        var _this = this;
        $event.stopPropagation();
        if (this.column.order === order) {
            this.column.order = '';
        }
        else {
            this.column.order = order;
        }
        /** @type {?} */
        var sortName = this.dg.sortName;
        /** @type {?} */
        var sortOrder = this.dg.sortOrder;
        /** @type {?} */
        var sortFields = [];
        /** @type {?} */
        var sortOrders = [];
        if (sortName) {
            sortFields = sortName.split(',');
            sortOrders = sortOrder.split(',');
        }
        /** @type {?} */
        var newOrder = this.column.order;
        /** @type {?} */
        var i = sortFields.findIndex((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return n === _this.column.field; }));
        if (i >= 0) {
            if (newOrder === '') {
                newOrder = undefined;
                sortFields.splice(i, 1);
                sortOrders.splice(i, 1);
            }
            else {
                sortOrders[i] = newOrder;
            }
        }
        else {
            if (this.dg.multiSort) {
                sortFields.push(this.column.field);
                sortOrders.push(newOrder);
            }
            else {
                sortFields = [this.column.field];
                sortOrders = [newOrder];
            }
        }
        this.hideFilterPanel();
        this.dg.sortName = sortFields.join(',');
        this.dg.sortOrder = sortOrders.join(',');
        this.dg.dfs.setSortInfo(this.dg.sortName, this.dg.sortOrder);
        this.dg.beforeSortColumn(this.dg.sortName, this.dg.sortOrder, this.dg).subscribe((/**
         * @return {?}
         */
        function () {
            _this.dg.onColumnSorted();
        }));
    };
    DatagridSmartFilterComponent.decorators = [
        { type: Component, args: [{
                    selector: 'datagrid-smart-filter, [datagrid-smart-filter]',
                    template: "<ng-template #sort>\r\n    <div class=\"f-filter-panel-sort-wrapper f-filter-panel-sort-wrapper-hasfilter\">\r\n        <div class=\"f-filter-panel-sort\">\r\n            <div class=\"panel-sort-up panel-sort-item\" [class.active]=\"column?.order === 'asc'\" (click)=\"onSort($event, 'asc')\">\r\n                <span class=\"panel-sort-item-icon f-icon f-icon-col-ascendingorder\"></span>\r\n                <span class=\"panel-sort-item-text\">{{ 'datagrid.settings.asc' | locale: '\u5347\u5E8F' }}</span>\r\n            </div>\r\n            <div class=\"panel-sort-down panel-sort-item\" [class.active]=\"column?.order === 'desc'\"  (click)=\"onSort($event, 'desc')\">\r\n                <span class=\"panel-sort-item-icon f-icon f-icon-col-descendingorder\"></span>\r\n                <span class=\"panel-sort-item-text\">{{ 'datagrid.settings.desc' | locale: '\u964D\u5E8F' }}</span>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</ng-template>",
                    providers: [
                        FilterPanelService
                    ]
                }] }
    ];
    /** @nocollapse */
    DatagridSmartFilterComponent.ctorParameters = function () { return [
        { type: Renderer2 },
        { type: ElementRef },
        { type: NgZone },
        { type: Injector },
        { type: FilterPanelService },
        { type: DatagridSmartFilterService },
        { type: DatagridComponent, decorators: [{ type: Optional }] }
    ]; };
    DatagridSmartFilterComponent.propDecorators = {
        column: [{ type: Input }],
        filterData: [{ type: Input }],
        disabled: [{ type: Input }],
        sortTmp: [{ type: ViewChild, args: ['sort',] }],
        onClick: [{ type: HostListener, args: ['click', ['$event'],] }]
    };
    return DatagridSmartFilterComponent;
}());
export { DatagridSmartFilterComponent };
if (false) {
    /** @type {?} */
    DatagridSmartFilterComponent.prototype.column;
    /** @type {?} */
    DatagridSmartFilterComponent.prototype.filterData;
    /** @type {?} */
    DatagridSmartFilterComponent.prototype.disabled;
    /** @type {?} */
    DatagridSmartFilterComponent.prototype.sortTmp;
    /** @type {?} */
    DatagridSmartFilterComponent.prototype.filterPanelRef;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.idService;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.smartFilterDataChanged$;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.removeFilter$;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.clearAllFilter$;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.smartFilterEvents;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.render;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.el;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.zone;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.inject;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.filterPanelService;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.smartFilterSer;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.dg;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtc21hcnQtZmlsdGVyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0YWdyaWQvIiwic291cmNlcyI6WyJsaWIvcGx1Z2lucy9zbWFydC1maWx0ZXIvZGF0YWdyaWQtc21hcnQtZmlsdGVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN0QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDOUMsT0FBTyxFQUNILFNBQVMsRUFBVSxTQUFTLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQ2hFLE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFhLFlBQVksRUFBRSxRQUFRLEVBQzdELE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxrQkFBa0IsRUFBd0IsTUFBTSx5QkFBeUIsQ0FBQztBQUNuRixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSw4Q0FBOEMsQ0FBQztBQUUxRjtJQW9CSSxzQ0FDWSxNQUFpQixFQUFVLEVBQWMsRUFDekMsSUFBWSxFQUFVLE1BQWdCLEVBQ3RDLGtCQUFzQyxFQUN0QyxjQUEwQyxFQUM5QixFQUFxQjtRQUpqQyxXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQVUsT0FBRSxHQUFGLEVBQUUsQ0FBWTtRQUN6QyxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBVTtRQUN0Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLG1CQUFjLEdBQWQsY0FBYyxDQUE0QjtRQUM5QixPQUFFLEdBQUYsRUFBRSxDQUFtQjtRQWhCcEMsZUFBVSxHQUFHLElBQUksQ0FBQztRQUNsQixhQUFRLEdBQUcsS0FBSyxDQUFDO1FBTWxCLDRCQUF1QixH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T0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDOztJQTJEckMsbUNBQUM7Q0FBQSxBQW5RRCxJQW1RQztTQTVQWSw0QkFBNEI7OztJQUNyQyw4Q0FBZ0I7O0lBQ2hCLGtEQUEyQjs7SUFDM0IsZ0RBQTBCOztJQUUxQiwrQ0FBNkM7O0lBRTdDLHNEQUFxQzs7Ozs7SUFDckMsaURBQTZCOzs7OztJQUM3QiwrREFBdUM7Ozs7O0lBQ3ZDLHFEQUE2Qjs7Ozs7SUFDN0IsdURBQStCOzs7OztJQUMvQix5REFBK0I7Ozs7O0lBRTNCLDhDQUF5Qjs7Ozs7SUFBRSwwQ0FBc0I7Ozs7O0lBQ2pELDRDQUFvQjs7Ozs7SUFBRSw4Q0FBd0I7Ozs7O0lBQzlDLDBEQUE4Qzs7Ozs7SUFDOUMsc0RBQWtEOzs7OztJQUNsRCwwQ0FBeUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjbG9uZURlZXAgfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG5pbXBvcnQgeyBJZFNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbic7XHJcbmltcG9ydCB7XHJcbiAgICBDb21wb25lbnQsIE9uSW5pdCwgVmlld0NoaWxkLCBUZW1wbGF0ZVJlZiwgUmVuZGVyZXIyLCBFbGVtZW50UmVmLFxyXG4gICAgTmdab25lLCBJbmplY3RvciwgSW5wdXQsIE9uRGVzdHJveSwgSG9zdExpc3RlbmVyLCBPcHRpb25hbFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBGaWx0ZXJQYW5lbFNlcnZpY2UsIEZpbHRlclBhbmVsQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1maWx0ZXItcGFuZWwnO1xyXG5pbXBvcnQgeyBEYXRhZ3JpZENvbXBvbmVudCB9IGZyb20gJy4uLy4uL2RhdGFncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IERhdGFncmlkU21hcnRGaWx0ZXJTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvZGF0YWdyaWQtc21hcnQtZmlsdGVyLnNlcnZpY2UnO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgICBzZWxlY3RvcjogJ2RhdGFncmlkLXNtYXJ0LWZpbHRlciwgW2RhdGFncmlkLXNtYXJ0LWZpbHRlcl0nLFxyXG4gICAgdGVtcGxhdGVVcmw6ICdkYXRhZ3JpZC1zbWFydC1maWx0ZXIuY29tcG9uZW50Lmh0bWwnLFxyXG4gICAgcHJvdmlkZXJzOiBbXHJcbiAgICAgICAgRmlsdGVyUGFuZWxTZXJ2aWNlXHJcbiAgICBdXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBEYXRhZ3JpZFNtYXJ0RmlsdGVyQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xyXG4gICAgQElucHV0KCkgY29sdW1uO1xyXG4gICAgQElucHV0KCkgZmlsdGVyRGF0YSA9IG51bGw7XHJcbiAgICBASW5wdXQoKSBkaXNhYmxlZCA9IGZhbHNlO1xyXG5cclxuICAgIEBWaWV3Q2hpbGQoJ3NvcnQnKSBzb3J0VG1wOiBUZW1wbGF0ZVJlZjxhbnk+O1xyXG5cclxuICAgIGZpbHRlclBhbmVsUmVmOiBGaWx0ZXJQYW5lbENvbXBvbmVudDtcclxuICAgIHByaXZhdGUgaWRTZXJ2aWNlOiBJZFNlcnZpY2U7XHJcbiAgICBwcml2YXRlIHNtYXJ0RmlsdGVyRGF0YUNoYW5nZWQkID0gbnVsbDtcclxuICAgIHByaXZhdGUgcmVtb3ZlRmlsdGVyJCA9IG51bGw7XHJcbiAgICBwcml2YXRlIGNsZWFyQWxsRmlsdGVyJCA9IG51bGw7XHJcbiAgICBwcml2YXRlIHNtYXJ0RmlsdGVyRXZlbnRzID0gW107XHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlIHJlbmRlcjogUmVuZGVyZXIyLCBwcml2YXRlIGVsOiBFbGVtZW50UmVmLFxyXG4gICAgICAgIHByaXZhdGUgem9uZTogTmdab25lLCBwcml2YXRlIGluamVjdDogSW5qZWN0b3IsXHJcbiAgICAgICAgcHJpdmF0ZSBmaWx0ZXJQYW5lbFNlcnZpY2U6IEZpbHRlclBhbmVsU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIHNtYXJ0RmlsdGVyU2VyOiBEYXRhZ3JpZFNtYXJ0RmlsdGVyU2VydmljZSxcclxuICAgICAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGRnOiBEYXRhZ3JpZENvbXBvbmVudFxyXG4gICAgICAgICkge1xyXG4gICAgICAgICAgICB0aGlzLmlkU2VydmljZSA9IHRoaXMuaW5qZWN0LmdldChJZFNlcnZpY2UsIG51bGwpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICBuZ09uSW5pdCgpIHtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLnJlbW92ZUZpbHRlciQpIHtcclxuICAgICAgICAgICAgdGhpcy5yZW1vdmVGaWx0ZXIkID0gdGhpcy5zbWFydEZpbHRlclNlci5yZW1vdmVGaWx0ZXIuc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlICYmIGUubGFiZWxDb2RlICA9PT0gdGhpcy5jb2x1bW4uZmllbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmZpbHRlckRhdGEgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyLnJlbW92ZUNsYXNzKHRoaXMuZWwubmF0aXZlRWxlbWVudCwgJ2FjdGl2ZScpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuc21hcnRGaWx0ZXJFdmVudHMucHVzaCh0aGlzLnJlbW92ZUZpbHRlciQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLmNsZWFyQWxsRmlsdGVyJCkge1xyXG4gICAgICAgICAgICB0aGlzLmNsZWFyQWxsRmlsdGVyJCA9IHRoaXMuc21hcnRGaWx0ZXJTZXIuY2xlYXJBbGxGaWx0ZXIuc3Vic2NyaWJlKCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZpbHRlckRhdGEgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIucmVtb3ZlQ2xhc3ModGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnYWN0aXZlJyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5zbWFydEZpbHRlckV2ZW50cy5wdXNoKHRoaXMuY2xlYXJBbGxGaWx0ZXIkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuZGcgJiYgIXRoaXMuc21hcnRGaWx0ZXJEYXRhQ2hhbmdlZCQpIHtcclxuICAgICAgICAgICAgdGhpcy5zbWFydEZpbHRlckRhdGFDaGFuZ2VkJCA9IHRoaXMuZGcuZGdzWydzbWFydEZpbHRlckRhdGFDaGFuZ2UnXS5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGUgJiYgdGhpcy5jb2x1bW4uZmllbGQgPT09IGUuZmllbGRDb2RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5maWx0ZXJEYXRhLnZhbHVlID0gZS52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmZpbHRlckRhdGEuY29udHJvbC5zaW5nbGUgPSBlLmNvbnRyb2wuc2luZ2xlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5zbWFydEZpbHRlckV2ZW50cy5wdXNoKHRoaXMuc21hcnRGaWx0ZXJEYXRhQ2hhbmdlZCQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5kZy5kZ3MuY2xlYXJGaWx0ZXIuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5maWx0ZXJEYXRhID0gbnVsbDtcclxuICAgICAgICAgICAgdGhpcy5kZy5zbWFydEZpbHRlclJlc3VsdCA9IHsgY29udHJvbERhdGE6IFtdLCBjb25kaXRpb25zOiBbXSB9O1xyXG4gICAgICAgICAgICB0aGlzLnNtYXJ0RmlsdGVyU2VyLmNsZWFyQWxsKCk7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLnJlbW92ZUNsYXNzKHRoaXMuZWwubmF0aXZlRWxlbWVudCwgJ2FjdGl2ZScpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCkge1xyXG4gICAgICAgIGlmICh0aGlzLmZpbHRlclBhbmVsUmVmKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyUGFuZWxTZXJ2aWNlLmhpZGVQYW5lbCgpO1xyXG4gICAgICAgICAgICB0aGlzLmZpbHRlclBhbmVsUmVmID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnNtYXJ0RmlsdGVyRXZlbnRzICYmIHRoaXMuc21hcnRGaWx0ZXJFdmVudHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc21hcnRGaWx0ZXJFdmVudHMuZm9yRWFjaChuID0+IHtcclxuICAgICAgICAgICAgICAgIG4udW5zdWJzY3JpYmUoKTtcclxuICAgICAgICAgICAgICAgIG4gPSBudWxsO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuc21hcnRGaWx0ZXJFdmVudHMgPSBbXTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuXHJcbiAgICBwcml2YXRlIGdldEZpbHRlckRhdGEoKSB7XHJcbiAgICAgICAgY29uc3QgeyBmaWVsZCwgdGl0bGUgfSA9IHRoaXMuY29sdW1uO1xyXG4gICAgICAgIGlmICghdGhpcy5maWx0ZXJEYXRhKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YSA9IHRoaXMuc21hcnRGaWx0ZXJTZXIuY29udHJvbERhdGEuZmluZChuID0+IG4uaWQgPT09IGZpZWxkKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5maWx0ZXJEYXRhKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YSA9IHtcclxuICAgICAgICAgICAgICAgIGlkOiBmaWVsZCxcclxuICAgICAgICAgICAgICAgIGxhYmVsQ29kZTogZmllbGQsXHJcbiAgICAgICAgICAgICAgICBjb2RlOiBmaWVsZCxcclxuICAgICAgICAgICAgICAgIG5hbWU6IHRpdGxlLFxyXG4gICAgICAgICAgICAgICAgY29udHJvbDogdGhpcy5zbWFydEZpbHRlclNlci5nZXRDb2x1bW5GaWx0ZXJEYXRhKHRoaXMuY29sdW1uKSxcclxuICAgICAgICAgICAgICAgIHBsYWNlSG9sZGVyOiAnJyxcclxuICAgICAgICAgICAgICAgIHZhbHVlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICcnXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHRmcyA1NzgyODVcclxuICAgICAgICBpZiAodGhpcy5maWx0ZXJEYXRhLnZhbHVlICYmIHRoaXMuZmlsdGVyRGF0YS5jb250cm9sLmNvbnRyb2x0eXBlLmluZGV4T2YoJ2ZsZXhpYmxlJykgPiAtMSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5maWx0ZXJEYXRhLnZhbHVlLnNpbmdsZSkge1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuZmlsdGVyRGF0YS52YWx1ZS5zdGFydFZhbHVlO1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlICB0aGlzLmZpbHRlckRhdGEudmFsdWUuZW5kVmFsdWU7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZpbHRlckRhdGEudmFsdWUudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGNsb25lRGVlcCh0aGlzLmZpbHRlckRhdGEpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIGdldFBhbmVsUG9zaXRpb24oJGV2ZW50KSB7XHJcbiAgICAgICAgbGV0IHggPSAkZXZlbnQucGFnZVggLSAzMztcclxuICAgICAgICBjb25zdCB5ID0gJGV2ZW50LnBhZ2VZICsgIDk7XHJcbiAgICAgICAgY29uc3QgdGFyZ2V0UmVjdCA9ICRldmVudC50YXJnZXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgbGV0IG1vdmVBcnJvdyA9IDA7XHJcbiAgICAgICAgaWYgKHdpbmRvdy5pbm5lcldpZHRoIC0geCA8IDM4MCkge1xyXG4gICAgICAgICAgICBjb25zdCBpID0gMzgwIC0gKHdpbmRvdy5pbm5lcldpZHRoIC0geCk7XHJcbiAgICAgICAgICAgIHggPSB4IC0gaSAtIDIwO1xyXG4gICAgICAgICAgICBtb3ZlQXJyb3cgPSB0YXJnZXRSZWN0LmxlZnQgLSB4O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHsgeCwgeSwgbW92ZUFycm93fTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGhpZGVGaWx0ZXJQYW5lbCgpIHtcclxuICAgICAgICBpZiAodGhpcy5maWx0ZXJQYW5lbFJlZikge1xyXG4gICAgICAgICAgICB0aGlzLmZpbHRlclBhbmVsU2VydmljZS5oaWRlUGFuZWwoKTtcclxuICAgICAgICAgICAgdGhpcy5maWx0ZXJQYW5lbFJlZiA9IG51bGw7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5maWx0ZXJEYXRhIHx8ICAodGhpcy5maWx0ZXJEYXRhLmNvbnRyb2wuY29udHJvbHR5cGUgPT09ICdib29sLWNoZWNrJyA/ICF0aGlzLmZpbHRlckRhdGEudmFsdWUudmFsdWUgOiAhdGhpcy5maWx0ZXJEYXRhLnZhbHVlVGV4dCkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyLnJlbW92ZUNsYXNzKHRoaXMuZWwubmF0aXZlRWxlbWVudCwgJ2FjdGl2ZScpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2xlYXJDb2x1bW5GaWx0ZXIoZSkge1xyXG4gICAgICAgIHRoaXMuZmlsdGVyRGF0YSA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5oaWRlRmlsdGVyUGFuZWwoKTtcclxuICAgICAgICB0aGlzLnNtYXJ0RmlsdGVyU2VyLnJlbW92ZUNvbmRpdGlvbihlKTtcclxuICAgIH1cclxuXHJcbiAgICBzaG93RmlsdGVyUGFuZWwoJGV2ZW50KSB7XHJcbiAgICAgICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG5cclxuICAgICAgICB0aGlzLnJlbmRlci5hZGRDbGFzcyh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsICdhY3RpdmUnKTtcclxuICAgICAgICBjb25zdCB7IHgsIHksIG1vdmVBcnJvdyB9ID0gdGhpcy5nZXRQYW5lbFBvc2l0aW9uKCRldmVudCk7XHJcbiAgICAgICAgdGhpcy5maWx0ZXJQYW5lbFJlZiA9IHRoaXMuZmlsdGVyUGFuZWxTZXJ2aWNlLnNob3dQYW5lbCh7XHJcbiAgICAgICAgICAgIGxlZnQ6IHgsXHJcbiAgICAgICAgICAgIHRvcDogeSxcclxuICAgICAgICAgICAgaXRlbTogdGhpcy5nZXRGaWx0ZXJEYXRhKCksXHJcbiAgICAgICAgICAgIHBhbmVsRXh0ZW5kVGVtcGxhdGU6IHRoaXMuY29sdW1uLnNvcnRhYmxlID8gdGhpcy5zb3J0VG1wIDogbnVsbCxcclxuICAgICAgICAgICAgbG9jYWxTdG9yYWdlS2V5OiAnc21hcnRmaWx0ZXJfJyArIHRoaXMuZGcuZGdzLmNyZWF0ZUNvbmZpZ0tleSh0aGlzLmRnLmlkKSxcclxuICAgICAgICAgICAgdGFyZ2V0OiAkZXZlbnQudGFyZ2V0XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGlmIChtb3ZlQXJyb3cpIHtcclxuICAgICAgICAgICAgY29uc3QgYXJyb3dFbCA9IHRoaXMuZmlsdGVyUGFuZWxSZWZbJ2VsJ10ucXVlcnlTZWxlY3RvcignLmYtZmlsdGVyLXBhbmVsLWFycm93Jyk7XHJcbiAgICAgICAgICAgIGlmIChhcnJvd0VsKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShhcnJvd0VsLCAnbGVmdCcsIGAke21vdmVBcnJvd31weGApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmZpbHRlclBhbmVsUmVmLmRhdGFDaGFuZ2Uuc3Vic2NyaWJlKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5maWx0ZXJEYXRhICYmIHRoaXMuZmlsdGVyRGF0YS5pZCA9PSBpdGVtLmlkKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXRlbS52YWx1ZSAmJiBpdGVtLnZhbHVlLnNpbmdsZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5maWx0ZXJEYXRhLnZhbHVlID0gaXRlbS52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmZpbHRlckRhdGEuY29udHJvbC5zaW5nbGUgPSBpdGVtLnZhbHVlLnNpbmdsZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIHRoaXMuZmlsdGVyUGFuZWxSZWYuaGlkZVBhbmVsLnN1YnNjcmliZShlID0+IHtcclxuICAgICAgICAgICAgdGhpcy5oaWRlRmlsdGVyUGFuZWwoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5maWx0ZXJQYW5lbFJlZi5maWx0ZXJTdWJtaXQuc3Vic2NyaWJlKGUgPT4ge1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaWYgKGUuZmlsdGVyICYmIGUuZmlsdGVyLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5maWx0ZXJEYXRhID0gZS5pdGVtIHx8IG51bGw7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmhpZGVGaWx0ZXJQYW5lbCgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zbWFydEZpbHRlclNlci5maWx0ZXJDb25kaXRpb25DaGFuZ2VkKHsgY29uZGl0aW9uczogZS5maWx0ZXIsIGNvbnRyb2xEYXRhOiBlLml0ZW0gLCBmcm9tOiAncGFuZWwnfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyQ29sdW1uRmlsdGVyKGUuaXRlbSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5maWx0ZXJQYW5lbFJlZi5jbGVhckZpbHRlci5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmNsZWFyQ29sdW1uRmlsdGVyKGUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIEBIb3N0TGlzdGVuZXIoJ2NsaWNrJywgWyckZXZlbnQnXSlcclxuICAgIG9uQ2xpY2soJGV2ZW50KSB7XHJcbiAgICAgICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgIGlmICh0aGlzLmRpc2FibGVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5zaG93RmlsdGVyUGFuZWwoJGV2ZW50KTtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgb25Tb3J0KCRldmVudCwgb3JkZXIpIHtcclxuICAgICAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmNvbHVtbi5vcmRlciA9PT0gb3JkZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5jb2x1bW4ub3JkZXIgPSAnJztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmNvbHVtbi5vcmRlciA9IG9yZGVyO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3Qgc29ydE5hbWUgPSB0aGlzLmRnLnNvcnROYW1lO1xyXG4gICAgICAgIGNvbnN0IHNvcnRPcmRlciA9IHRoaXMuZGcuc29ydE9yZGVyO1xyXG4gICAgICAgIGxldCBzb3J0RmllbGRzID0gW107XHJcbiAgICAgICAgbGV0IHNvcnRPcmRlcnMgPSBbXTtcclxuICAgICAgICBpZiAoc29ydE5hbWUpIHtcclxuICAgICAgICAgICAgc29ydEZpZWxkcyA9IHNvcnROYW1lLnNwbGl0KCcsJyk7XHJcbiAgICAgICAgICAgIHNvcnRPcmRlcnMgPSBzb3J0T3JkZXIuc3BsaXQoJywnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBuZXdPcmRlciA9ICB0aGlzLmNvbHVtbi5vcmRlcjtcclxuICAgICAgICBjb25zdCBpID0gc29ydEZpZWxkcy5maW5kSW5kZXgobiA9PiBuID09PSB0aGlzLmNvbHVtbi5maWVsZCk7XHJcbiAgICAgICAgaWYgKGkgPj0gMCkge1xyXG4gICAgICAgICAgICBpZiAobmV3T3JkZXIgPT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICBuZXdPcmRlciA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgICAgIHNvcnRGaWVsZHMuc3BsaWNlKGksIDEpO1xyXG4gICAgICAgICAgICAgICAgc29ydE9yZGVycy5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBzb3J0T3JkZXJzW2ldID0gbmV3T3JkZXI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5kZy5tdWx0aVNvcnQpIHtcclxuICAgICAgICAgICAgICAgIHNvcnRGaWVsZHMucHVzaCh0aGlzLmNvbHVtbi5maWVsZCk7XHJcbiAgICAgICAgICAgICAgICBzb3J0T3JkZXJzLnB1c2gobmV3T3JkZXIpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc29ydEZpZWxkcyA9IFt0aGlzLmNvbHVtbi5maWVsZF07XHJcbiAgICAgICAgICAgICAgICBzb3J0T3JkZXJzID0gW25ld09yZGVyXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5oaWRlRmlsdGVyUGFuZWwoKTtcclxuXHJcblxyXG4gICAgICAgIHRoaXMuZGcuc29ydE5hbWUgPSBzb3J0RmllbGRzLmpvaW4oJywnKTtcclxuICAgICAgICB0aGlzLmRnLnNvcnRPcmRlciA9IHNvcnRPcmRlcnMuam9pbignLCcpO1xyXG4gICAgICAgIHRoaXMuZGcuZGZzLnNldFNvcnRJbmZvKHRoaXMuZGcuc29ydE5hbWUsIHRoaXMuZGcuc29ydE9yZGVyKTtcclxuXHJcbiAgICAgICAgdGhpcy5kZy5iZWZvcmVTb3J0Q29sdW1uKHRoaXMuZGcuc29ydE5hbWUsIHRoaXMuZGcuc29ydE9yZGVyLCB0aGlzLmRnKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmRnLm9uQ29sdW1uU29ydGVkKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuIl19