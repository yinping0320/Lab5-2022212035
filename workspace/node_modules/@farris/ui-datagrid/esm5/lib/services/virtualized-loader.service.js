/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
var VirtualizedLoaderService = /** @class */ (function () {
    function VirtualizedLoaderService() {
    }
    /**
     * @return {?}
     */
    VirtualizedLoaderService.prototype.getTableHeight = /**
     * @return {?}
     */
    function () {
        return this.state.height;
    };
    /**
     * @return {?}
     */
    VirtualizedLoaderService.prototype.getTableHeaderHeight = /**
     * @return {?}
     */
    function () {
        return this.state.headerHeight;
    };
    /**
     * @return {?}
     */
    VirtualizedLoaderService.prototype.getTableBodyHeight = /**
     * @return {?}
     */
    function () {
        return this.getTableHeight() - this.getTableHeaderHeight();
    };
    /**
     * @return {?}
     */
    VirtualizedLoaderService.prototype.getTableWidth = /**
     * @return {?}
     */
    function () {
        return this.state.width;
    };
    /**
     * @return {?}
     */
    VirtualizedLoaderService.prototype.getRowHeight = /**
     * @return {?}
     */
    function () {
        return this.state.rowHeight;
    };
    /**
     * @return {?}
     */
    VirtualizedLoaderService.prototype.displayRowsCount = /**
     * @return {?}
     */
    function () {
        return Math.floor(this.getTableHeight() / this.getRowHeight());
    };
    /**
     * @return {?}
     */
    VirtualizedLoaderService.prototype.getTotal = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var total = this.state.total;
        /** @type {?} */
        var data = this.state.data || [];
        /** @type {?} */
        var pagination = this.state.pagination;
        /** @type {?} */
        var count = data.length;
        if (pagination) {
            total = count;
        }
        return total;
    };
    /**
     * @return {?}
     */
    VirtualizedLoaderService.prototype.reload = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var rowHeight = this.getRowHeight();
        /** @type {?} */
        var scroTop = this.state.virtual.scrollTop;
        /** @type {?} */
        var res = this.getRows(scroTop);
        /** @type {?} */
        var total = this.getTotal();
        res.topHideHeight = scroTop;
        if (res.bottomHideHeight !== 0) {
            res.bottomHideHeight = total * rowHeight - res.virtualRows.length * rowHeight - res.topHideHeight;
        }
        return res;
    };
    /**
     * @param {?} scrollTop
     * @return {?}
     */
    VirtualizedLoaderService.prototype.getRows = /**
     * @param {?} scrollTop
     * @return {?}
     */
    function (scrollTop) {
        var _this = this;
        var e_1, _a;
        /** @type {?} */
        var minTop = Math.abs(scrollTop);
        /** @type {?} */
        var rowHeight = this.getRowHeight();
        /** @type {?} */
        var maxTop = minTop + this.getTableHeight();
        /** @type {?} */
        var top = (!this.state.virtualizedAsyncLoad) ? 0 : this.state.virtual.rowIndex * rowHeight;
        /** @type {?} */
        var rows = [];
        /** @type {?} */
        var topHideHeight = 0;
        /** @type {?} */
        var bottomHideHeight = 0;
        /** @type {?} */
        var data = this.state.data;
        /** @type {?} */
        var total = this.getTotal();
        try {
            for (var data_1 = tslib_1.__values(data), data_1_1 = data_1.next(); !data_1_1.done; data_1_1 = data_1.next()) {
                var n = data_1_1.value;
                top += rowHeight;
                if (top + rowHeight < minTop) {
                    topHideHeight += rowHeight;
                    continue;
                }
                else {
                    if (top > maxTop) {
                        bottomHideHeight += rowHeight;
                        continue;
                    }
                }
                rows.push(n);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (data_1_1 && !data_1_1.done && (_a = data_1.return)) _a.call(data_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        if (this.state.virtualizedAsyncLoad) {
            topHideHeight = this.state.virtual.rowIndex * rowHeight + topHideHeight;
            bottomHideHeight = total * rowHeight - rows.length * rowHeight - topHideHeight;
        }
        /** @type {?} */
        var startIndex = this.state.virtual.rowIndex;
        if (data && data.length && rows && rows.length) {
            /** @type {?} */
            var rid_1 = rows[0][this.state.idField];
            startIndex = this.state.virtual.rowIndex + data.findIndex((/**
             * @param {?} r
             * @return {?}
             */
            function (r) { return r[_this.state.idField] === rid_1; }));
        }
        return {
            startIndex: startIndex,
            virtualRows: rows,
            topHideHeight: topHideHeight,
            bottomHideHeight: bottomHideHeight
        };
    };
    /**
     * @param {?} scrollTop
     * @param {?} itemsCount
     * @param {?} firstRowIndex
     * @return {?}
     */
    VirtualizedLoaderService.prototype.getRowsCount = /**
     * @param {?} scrollTop
     * @param {?} itemsCount
     * @param {?} firstRowIndex
     * @return {?}
     */
    function (scrollTop, itemsCount, firstRowIndex) {
        /** @type {?} */
        var rowHeight = this.getRowHeight();
        /** @type {?} */
        var total = this.getTotal();
        /** @type {?} */
        var maxTop = scrollTop + this.getTableBodyHeight();
        /** @type {?} */
        var top = firstRowIndex * rowHeight;
        /** @type {?} */
        var rowsLength = 0;
        /** @type {?} */
        var topHideHeight = 0;
        /** @type {?} */
        var bottomHideHeight = 0;
        for (var i = 0; i < itemsCount; i++) {
            top += rowHeight;
            if (top + rowHeight < scrollTop) {
                topHideHeight += rowHeight;
                continue;
            }
            else {
                if (top > maxTop) {
                    continue;
                }
            }
            rowsLength++;
        }
        bottomHideHeight = total * rowHeight - rowsLength * rowHeight - topHideHeight;
        return { rowsLength: rowsLength, top: topHideHeight, bottom: bottomHideHeight };
    };
    return VirtualizedLoaderService;
}());
export { VirtualizedLoaderService };
if (false) {
    /** @type {?} */
    VirtualizedLoaderService.prototype.state;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlydHVhbGl6ZWQtbG9hZGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRhdGFncmlkLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL3ZpcnR1YWxpemVkLWxvYWRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUE7SUFBQTtJQTJIQSxDQUFDOzs7O0lBeEhHLGlEQUFjOzs7SUFBZDtRQUNJLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7SUFDN0IsQ0FBQzs7OztJQUNELHVEQUFvQjs7O0lBQXBCO1FBQ0ksT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQztJQUNuQyxDQUFDOzs7O0lBQ0QscURBQWtCOzs7SUFBbEI7UUFDSSxPQUFPLElBQUksQ0FBQyxjQUFjLEVBQUUsR0FBRyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztJQUMvRCxDQUFDOzs7O0lBQ0QsZ0RBQWE7OztJQUFiO1FBQ0ksT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztJQUM1QixDQUFDOzs7O0lBRUQsK0NBQVk7OztJQUFaO1FBQ0ksT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQztJQUNoQyxDQUFDOzs7O0lBRUQsbURBQWdCOzs7SUFBaEI7UUFDSSxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDO0lBQ25FLENBQUM7Ozs7SUFFRCwyQ0FBUTs7O0lBQVI7O1lBQ1EsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSzs7WUFDdEIsSUFBSSxHQUFVLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLEVBQUU7O1lBQ25DLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVU7O1lBQ2xDLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTTtRQUN6QixJ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QTFIRyx5Q0FBb0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGYXJyaXNEYXRhZ3JpZFN0YXRlIH0gZnJvbSAnLi9zdGF0ZSc7XHJcblxyXG5leHBvcnQgY2xhc3MgVmlydHVhbGl6ZWRMb2FkZXJTZXJ2aWNlIHtcclxuICAgIHN0YXRlOiBQYXJ0aWFsPEZhcnJpc0RhdGFncmlkU3RhdGU+O1xyXG5cclxuICAgIGdldFRhYmxlSGVpZ2h0KCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLmhlaWdodDtcclxuICAgIH1cclxuICAgIGdldFRhYmxlSGVhZGVySGVpZ2h0KCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLmhlYWRlckhlaWdodDtcclxuICAgIH1cclxuICAgIGdldFRhYmxlQm9keUhlaWdodCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRUYWJsZUhlaWdodCgpIC0gdGhpcy5nZXRUYWJsZUhlYWRlckhlaWdodCgpO1xyXG4gICAgfVxyXG4gICAgZ2V0VGFibGVXaWR0aCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZS53aWR0aDtcclxuICAgIH1cclxuXHJcbiAgICBnZXRSb3dIZWlnaHQoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUucm93SGVpZ2h0O1xyXG4gICAgfVxyXG5cclxuICAgIGRpc3BsYXlSb3dzQ291bnQoKSB7XHJcbiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodGhpcy5nZXRUYWJsZUhlaWdodCgpIC8gdGhpcy5nZXRSb3dIZWlnaHQoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VG90YWwoKSB7XHJcbiAgICAgICAgbGV0IHRvdGFsID0gdGhpcy5zdGF0ZS50b3RhbDtcclxuICAgICAgICBjb25zdCBkYXRhOiBhbnlbXSA9IHRoaXMuc3RhdGUuZGF0YSB8fCBbXTtcclxuICAgICAgICBjb25zdCBwYWdpbmF0aW9uID0gdGhpcy5zdGF0ZS5wYWdpbmF0aW9uO1xyXG4gICAgICAgIGNvbnN0IGNvdW50ID0gZGF0YS5sZW5ndGg7XHJcbiAgICAgICAgaWYgKHBhZ2luYXRpb24pIHtcclxuICAgICAgICAgICAgdG90YWwgPSBjb3VudDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0b3RhbDtcclxuICAgIH1cclxuXHJcbiAgICByZWxvYWQoKSB7XHJcbiAgICAgICAgY29uc3Qgcm93SGVpZ2h0ID0gdGhpcy5nZXRSb3dIZWlnaHQoKTtcclxuICAgICAgICBjb25zdCBzY3JvVG9wID0gdGhpcy5zdGF0ZS52aXJ0dWFsLnNjcm9sbFRvcDtcclxuICAgICAgICBjb25zdCByZXMgPSB0aGlzLmdldFJvd3Moc2Nyb1RvcCk7XHJcbiAgICAgICAgY29uc3QgdG90YWwgPSB0aGlzLmdldFRvdGFsKCk7XHJcblxyXG4gICAgICAgIHJlcy50b3BIaWRlSGVpZ2h0ID0gc2Nyb1RvcDtcclxuICAgICAgICBpZiAocmVzLmJvdHRvbUhpZGVIZWlnaHQgIT09IDApIHtcclxuICAgICAgICAgICAgcmVzLmJvdHRvbUhpZGVIZWlnaHQgPSB0b3RhbCAqIHJvd0hlaWdodCAtIHJlcy52aXJ0dWFsUm93cy5sZW5ndGggKiByb3dIZWlnaHQgLSByZXMudG9wSGlkZUhlaWdodDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlcztcclxuICAgIH1cclxuXHJcbiAgICBnZXRSb3dzKHNjcm9sbFRvcDogbnVtYmVyKSB7XHJcbiAgICAgICAgY29uc3QgbWluVG9wID0gIE1hdGguYWJzKHNjcm9sbFRvcCk7XHJcbiAgICAgICAgY29uc3Qgcm93SGVpZ2h0ID0gdGhpcy5nZXRSb3dIZWlnaHQoKTtcclxuICAgICAgICBjb25zdCBtYXhUb3AgPSBtaW5Ub3AgKyB0aGlzLmdldFRhYmxlSGVpZ2h0KCk7XHJcblxyXG4gICAgICAgIGxldCB0b3AgPSAoIXRoaXMuc3RhdGUudmlydHVhbGl6ZWRBc3luY0xvYWQpID8gMCA6IHRoaXMuc3RhdGUudmlydHVhbC5yb3dJbmRleCAqIHJvd0hlaWdodCA7XHJcblxyXG4gICAgICAgIGNvbnN0IHJvd3MgPSBbXTtcclxuICAgICAgICBsZXQgdG9wSGlkZUhlaWdodCA9IDA7XHJcbiAgICAgICAgbGV0IGJvdHRvbUhpZGVIZWlnaHQgPSAwO1xyXG5cclxuICAgICAgICBjb25zdCBkYXRhOiBhbnlbXSA9IHRoaXMuc3RhdGUuZGF0YTtcclxuICAgICAgICBjb25zdCB0b3RhbCA9IHRoaXMuZ2V0VG90YWwoKTtcclxuXHJcbiAgICAgICAgZm9yIChjb25zdCBuIG9mIGRhdGEpIHtcclxuICAgICAgICAgICAgdG9wICs9IHJvd0hlaWdodDtcclxuICAgICAgICAgICAgaWYgKHRvcCArIHJvd0hlaWdodCA8IG1pblRvcCkge1xyXG4gICAgICAgICAgICAgICAgdG9wSGlkZUhlaWdodCArPSByb3dIZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmICh0b3AgPiBtYXhUb3ApIHtcclxuICAgICAgICAgICAgICAgICAgICBib3R0b21IaWRlSGVpZ2h0ICs9IHJvd0hlaWdodDtcclxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcm93cy5wdXNoKG4pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUudmlydHVhbGl6ZWRBc3luY0xvYWQpIHtcclxuICAgICAgICAgICAgdG9wSGlkZUhlaWdodCA9IHRoaXMuc3RhdGUudmlydHVhbC5yb3dJbmRleCAqIHJvd0hlaWdodCAgKyB0b3BIaWRlSGVpZ2h0O1xyXG4gICAgICAgICAgICBib3R0b21IaWRlSGVpZ2h0ID0gdG90YWwgKiByb3dIZWlnaHQgLSByb3dzLmxlbmd0aCAqIHJvd0hlaWdodCAtIHRvcEhpZGVIZWlnaHQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgc3RhcnRJbmRleCA9IHRoaXMuc3RhdGUudmlydHVhbC5yb3dJbmRleDtcclxuICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLmxlbmd0aCAmJiByb3dzICYmIHJvd3MubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJpZCA9ICByb3dzWzBdW3RoaXMuc3RhdGUuaWRGaWVsZF07XHJcbiAgICAgICAgICAgIHN0YXJ0SW5kZXggPSB0aGlzLnN0YXRlLnZpcnR1YWwucm93SW5kZXggKyBkYXRhLmZpbmRJbmRleChyID0+IHJbdGhpcy5zdGF0ZS5pZEZpZWxkXSA9PT0gcmlkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgc3RhcnRJbmRleCxcclxuICAgICAgICAgICAgdmlydHVhbFJvd3M6IHJvd3MsXHJcbiAgICAgICAgICAgIHRvcEhpZGVIZWlnaHQsXHJcbiAgICAgICAgICAgIGJvdHRvbUhpZGVIZWlnaHRcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGdldFJvd3NDb3VudChzY3JvbGxUb3AsIGl0ZW1zQ291bnQsIGZpcnN0Um93SW5kZXgpIHtcclxuICAgICAgICBjb25zdCByb3dIZWlnaHQgPSB0aGlzLmdldFJvd0hlaWdodCgpO1xyXG4gICAgICAgIGNvbnN0IHRvdGFsID0gdGhpcy5nZXRUb3RhbCgpO1xyXG5cclxuICAgICAgICBjb25zdCBtYXhUb3AgPSBzY3JvbGxUb3AgKyB0aGlzLmdldFRhYmxlQm9keUhlaWdodCgpO1xyXG4gICAgICAgIGxldCB0b3AgPSBmaXJzdFJvd0luZGV4ICogcm93SGVpZ2h0O1xyXG4gICAgICAgIGxldCByb3dzTGVuZ3RoID0gMDtcclxuICAgICAgICBsZXQgdG9wSGlkZUhlaWdodCA9IDA7XHJcbiAgICAgICAgbGV0IGJvdHRvbUhpZGVIZWlnaHQgPSAwO1xyXG5cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGl0ZW1zQ291bnQ7IGkrKyApIHtcclxuICAgICAgICAgICAgdG9wICs9IHJvd0hlaWdodDtcclxuICAgICAgICAgICAgaWYgKHRvcCArIHJvd0hlaWdodCA8IHNjcm9sbFRvcCkge1xyXG4gICAgICAgICAgICAgICAgdG9wSGlkZUhlaWdodCArPSByb3dIZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmICh0b3AgPiBtYXhUb3ApIHtcclxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcm93c0xlbmd0aCsrO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgYm90dG9tSGlkZUhlaWdodCA9IHRvdGFsICogcm93SGVpZ2h0IC0gcm93c0xlbmd0aCAqIHJvd0hlaWdodCAtIHRvcEhpZGVIZWlnaHQ7XHJcbiAgICAgICAgcmV0dXJuIHtyb3dzTGVuZ3RoLCB0b3A6IHRvcEhpZGVIZWlnaHQsIGJvdHRvbTogYm90dG9tSGlkZUhlaWdodH07XHJcbiAgICB9XHJcbn1cclxuIl19