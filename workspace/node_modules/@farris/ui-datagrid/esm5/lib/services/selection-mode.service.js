/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { DatagridComponent } from './../datagrid.component';
import { Injectable } from '@angular/core';
import { delay } from 'rxjs/operators';
import { of } from 'rxjs';
var SelectionModeService = /** @class */ (function () {
    function SelectionModeService(grid) {
        var _this = this;
        this.dgRef = null;
        this.oldSettings = null;
        this.selectStartEvent = null;
        this.events = null;
        this.dgRef = grid;
        if (this.dgRef.selectionMode === 'default') {
            grid.zone.runOutsideAngular((/**
             * @return {?}
             */
            function () {
                _this.removeEvents();
                _this.events = _this.registerStopSelectionEvent();
            }));
        }
    }
    /**
     * @return {?}
     */
    SelectionModeService.prototype.destroy = /**
     * @return {?}
     */
    function () {
        this.dgRef = null;
        this.removeEvents();
    };
    /**
     * @return {?}
     */
    SelectionModeService.prototype.removeEvents = /**
     * @return {?}
     */
    function () {
        if (this.events && this.events.length) {
            this.events.forEach((/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                e();
            }));
            this.events = null;
        }
    };
    /**
     * @return {?}
     */
    SelectionModeService.prototype.toggleMode = /**
     * @return {?}
     */
    function () {
        if (this.dgRef) {
            if (this.dgRef.selectionMode === 'default') {
                this.enableWindowsSelectionMode();
            }
            else {
                this.restoreSettings();
            }
        }
    };
    /**
     * @return {?}
     */
    SelectionModeService.prototype.enableWindowsSelectionMode = /**
     * @return {?}
     */
    function () {
        if (this.dgRef) {
            this.oldSettings = {
                showCheckbox: this.dgRef.showCheckbox,
                keepSelect: this.dgRef.keepSelect,
                onlySelectSelf: this.dgRef.onlySelectSelf,
                selectOnCheck: this.dgRef.selectOnCheck,
                checkOnSelect: this.dgRef.checkOnSelect
            };
            this.dgRef.showCheckbox = true;
            this.dgRef.keepSelect = true;
            this.dgRef.onlySelectSelf = false;
            this.dgRef.selectOnCheck = true;
            this.dgRef.checkOnSelect = true;
            this.dgRef.dfs.updateProperty('keepSelect', true);
            this.dgRef.dfs.updateProperty('onlySelectSelf', false);
            this.dgRef.dfs.updateProperty('selectOnCheck', true);
            this.dgRef.dfs.updateProperty('checkOnSelect', true);
        }
    };
    /**
     * @return {?}
     */
    SelectionModeService.prototype.restoreSettings = /**
     * @return {?}
     */
    function () {
        if (this.dgRef && this.oldSettings) {
            this.dgRef.showCheckbox = this.oldSettings.showCheckbox;
            this.dgRef.keepSelect = this.oldSettings.keepSelect;
            this.dgRef.onlySelectSelf = this.oldSettings.onlySelectSelf;
            this.dgRef.selectOnCheck = this.oldSettings.selectOnCheck;
            this.dgRef.checkOnSelect = this.oldSettings.checkOnSelect;
            this.dgRef.dfs.updateProperty('keepSelect', this.oldSettings.keepSelect);
            this.dgRef.dfs.updateProperty('onlySelectSelf', this.oldSettings.onlySelectSelf);
            this.dgRef.dfs.updateProperty('selectOnCheck', this.oldSettings.selectOnCheck);
            this.dgRef.dfs.updateProperty('checkOnSelect', this.oldSettings.checkOnSelect);
        }
    };
    /**
     * @private
     * @return {?}
     */
    SelectionModeService.prototype.registerStopSelectionEvent = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var kd = this.dgRef.render2.listen(document, 'keydown', (/**
         * @param {?} event
         * @return {?}
         */
        function (event) {
            if (event.ctrlKey || event.shiftKey) {
                _this.unselectable();
            }
        }));
        /** @type {?} */
        var ku = this.dgRef.render2.listen(document, 'keyup', (/**
         * @param {?} event
         * @return {?}
         */
        function (event) {
            if (event.ctrlKey || event.shiftKey || event.keyCode === 17 || event.keyCode === 16) {
                _this.enableSelectable();
            }
        }));
        return [kd, ku];
    };
    /**
     * @private
     * @return {?}
     */
    SelectionModeService.prototype.unselectable = /**
     * @private
     * @return {?}
     */
    function () {
        this.dgRef.render2.setAttribute(this.dgRef.dgContainer.nativeElement, 'unselectable', 'on');
        this.dgRef.render2.setAttribute(this.dgRef.dgContainer.nativeElement, 'onselectstart', 'return false');
        this.dgRef.render2.setStyle(this.dgRef.dgContainer.nativeElement, '-moz-user-select', 'none');
    };
    /**
     * @private
     * @return {?}
     */
    SelectionModeService.prototype.enableSelectable = /**
     * @private
     * @return {?}
     */
    function () {
        this.dgRef.render2.removeAttribute(this.dgRef.dgContainer.nativeElement, 'unselectable');
        this.dgRef.render2.removeAttribute(this.dgRef.dgContainer.nativeElement, 'onselectstart');
        this.dgRef.render2.removeStyle(this.dgRef.dgContainer.nativeElement, '-moz-user-select');
    };
    /**
     * @param {?} param
     * @return {?}
     */
    SelectionModeService.prototype.beforRowClick = /**
     * @param {?} param
     * @return {?}
     */
    function (param) {
        var _this = this;
        if (this.dgRef && this.dgRef.selectionMode === 'default') {
            /** @type {?} */
            var isSelected = this.dgRef.dfs.isRowSelected(param.id);
            /** @type {?} */
            var isCtrlKey = param.e.ctrlKey;
            /** @type {?} */
            var isShiftKey = param.e.shiftKey;
            this.dgRef.endEditing();
            if (!isCtrlKey && !isShiftKey) {
                if (!isSelected) {
                    this.dgRef.clearCheckeds();
                }
                else {
                    // 如果有多条选，移除其他选中行
                    /** @type {?} */
                    var currentPagerIds_1 = this.dgRef.getRows().map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    function (n) { return n.id; }));
                    /** @type {?} */
                    var unCheckIDs = this.dgRef.checkValues.filter((/**
                     * @param {?} i
                     * @return {?}
                     */
                    function (i) { return currentPagerIds_1.includes(i) && i != param.id; }));
                    /** @type {?} */
                    var unSelectIds = this.dgRef.checkValues.filter((/**
                     * @param {?} n
                     * @return {?}
                     */
                    function (n) { return !currentPagerIds_1.includes(n); }));
                    // const unCheckIDs = this.dgRef.checkValues.filter(n => n != param.id);
                    if (unCheckIDs && unCheckIDs.length) {
                        this.dgRef.unCheckRows(unCheckIDs, true);
                        this.dgRef.clearSelections(tslib_1.__spread([param.id], unSelectIds));
                    }
                }
            }
            else {
                if (isShiftKey) {
                    /** @type {?} */
                    var focusIndex = this.dgRef.focusRowIndex;
                    if (focusIndex === -1) {
                        focusIndex = 0;
                    }
                    /** @type {?} */
                    var endIndex = param.rowIndex;
                    /** @type {?} */
                    var start = focusIndex;
                    /** @type {?} */
                    var end = endIndex;
                    if (focusIndex > endIndex) {
                        start = endIndex;
                        end = focusIndex;
                    }
                    /** @type {?} */
                    var data = this.dgRef.getRows();
                    /** @type {?} */
                    var checkedItems = tslib_1.__spread(data).splice(start, end - start + 1);
                    /** @type {?} */
                    var willCheckIds = checkedItems.map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    function (n) {
                        return _this.dgRef.dfs.primaryId(n);
                    }));
                    if (!isCtrlKey) {
                        this.dgRef.clearCheckeds(false, false);
                    }
                    // this.dgRef.selectValues = willCheckIds;
                    this.dgRef.checkRows(willCheckIds, true);
                    return true;
                }
            }
            if (isSelected && isCtrlKey) {
                param.e.stopPropagation();
                // 执行取消选择
                this.dgRef.unCheckRow(param.id);
                return true;
            }
            /** @type {?} */
            var zoneClick = param.cellref ? param.cellref['zoneClick'] : '';
            /** @type {?} */
            var _timer_1 = zoneClick && zoneClick.length ? 100 : 0;
            /** @type {?} */
            var r$ = of(true);
            if (this.dgRef.beforeSelect) {
                /** @type {?} */
                var r = this.dgRef.beforeSelect(param);
                if (r && r.subscribe) {
                    r$ = r;
                }
            }
            r$.pipe(delay(_timer_1)).subscribe((/**
             * @param {?} canSelect
             * @return {?}
             */
            function (canSelect) {
                if (canSelect) {
                    _this.dgRef.dfs.selectRow(param.rowIndex, param.rowData);
                    if (_this.dgRef.selectedRow) {
                        _this.dgRef.selectedRow.dr = param.dr;
                    }
                }
                _this.dgRef.rowClick.emit({ data: param.rowData, grid: _this.dgRef, dblclick: false });
                _this.dgRef.dgs.setSelecedRow.emit({ selected: true, id: _this.dgRef.dfs.primaryId(param.rowData) });
                if (_timer_1) {
                    if (param.cellref && param.cellref.runZoneClick) {
                        param.cellref.runZoneClick(param.e);
                    }
                }
            }));
            return true;
        }
        return false;
    };
    /**
     * @return {?}
     */
    SelectionModeService.prototype.endRowClick = /**
     * @return {?}
     */
    function () {
        if (this.dgRef && this.dgRef.selectionMode === 'default') {
            this.dgRef.checkOnSelect = false;
        }
    };
    SelectionModeService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    SelectionModeService.ctorParameters = function () { return [
        { type: DatagridComponent }
    ]; };
    return SelectionModeService;
}());
export { SelectionModeService };
if (false) {
    /** @type {?} */
    SelectionModeService.prototype.dgRef;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.oldSettings;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.selectStartEvent;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.events;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0aW9uLW1vZGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0YWdyaWQvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvc2VsZWN0aW9uLW1vZGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzVELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZDLE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFdEM7SUFNSSw4QkFBWSxJQUF1QjtRQUFuQyxpQkFRQztRQVpELFVBQUssR0FBc0IsSUFBSSxDQUFDO1FBQ3hCLGdCQUFXLEdBQVEsSUFBSSxDQUFDO1FBQ3hCLHFCQUFnQixHQUFRLElBQUksQ0FBQztRQUM3QixXQUFNLEdBQUcsSUFBSSxDQUFDO1FBRWxCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEtBQUssU0FBUyxFQUFFO1lBQ3hDLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCOzs7WUFBQztnQkFDeEIsS0FBSSxDQUFDLFlBQVksRUFBRSxDQUFDO2dCQUNwQixLQUFJLENBQUMsTUFBTSxHQUFHLEtBQUksQ0FBQywwQkFBMEIsRUFBRSxDQUFDO1lBQ3BELENBQUMsRUFBQyxDQUFDO1NBQ047SUFDTCxDQUFDOzs7O0lBRUQsc0NBQU87OztJQUFQO1FBQ0ksSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDbEIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3hCLENBQUM7Ozs7SUFFRCwyQ0FBWTs7O0lBQVo7UUFDSSxJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUU7WUFDbkMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPOzs7O1lBQUMsVUFBQSxDQUFDO2dCQUNqQixDQUFDLEVBQUUsQ0FBQztZQUNSLENBQUMsRUFBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7U0FDdEI7SUFDTCxDQUFDOzs7O0lBRU0seUNBQVU7OztJQUFqQjtRQUNJLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNaLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEtBQUssU0FBUyxFQUFFO2dCQUN4QyxJQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQzthQUNyQztpQkFBTTtnQkFDSCxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7YUFDMUI7U0FDSjtJQUNMLENBQUM7Ozs7SUFFTSx5REFBMEI7OztJQUFqQztRQUNJLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNaLElBQUksQ0FBQyxXQUFXLEdBQUc7Z0JBQ2YsWUFBWSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWTtnQkFDckMsVUFBVSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVTtnQkFDakMsY0FBYyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYztnQkFDekMsYUFBYSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYTtnQkFDdkMsYUFBYSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYTthQUMxQyxDQUFDO1lBRUYsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1lBQy9CLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztZQUM3QixJQUFJLENBQUMsS0FBSyxDQUFDLGNBQWMsR0FBRyxLQUFLLENBQUM7WUFDbEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO1lBQ2hDLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQztZQUVoQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ2xELElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxnQkFBZ0IsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUN2RCxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3JELElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDeEQ7SUFDTCxDQUFDOzs7O0lBRU0sOENBQWU7OztJQUF0QjtRQUNJLElBQUksSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ2hDLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDO1lBQ3hELElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDO1lBQ3BELElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDO1lBQzVELElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDO1lBQzFELElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDO1lBRzFELElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUN6RSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUNqRixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDL0UsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQ2xGO0lBQ0wsQ0FBQzs7Ozs7SUFHTyx5REFBMEI7Ozs7SUFBbEM7UUFBQSxpQkFjQzs7WUFiUyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxTQUFTOzs7O1FBQUUsVUFBQyxLQUFVO1lBQ2pFLElBQUksS0FBSyxDQUFDLE9BQU8sSUFBSSxLQUFLLENBQUMsUUFBUSxFQUFFO2dCQUNqQyxLQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7YUFDdkI7UUFDTCxDQUFDLEVBQUM7O1lBRUksRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsT0FBTzs7OztRQUFFLFVBQUMsS0FBVTtZQUMvRCxJQUFJLEtBQUssQ0FBQyxPQUFPLElBQUksS0FBSyxDQUFDLFFBQVEsSUFBSSxLQUFLLENBQUMsT0FBTyxLQUFLLEVBQUUsSUFBSSxLQUFLLENBQUMsT0FBTyxLQUFLLEVBQUUsRUFBRTtnQkFDakYsS0FBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7YUFDM0I7UUFDTCxDQUFDLEVBQUM7UUFFRixPQUFPLENBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3JCLENBQUM7Ozs7O0lBRU8sMkNBQVk7Ozs7SUFBcEI7UUFDSSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM1RixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFLGVBQWUsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUN2RyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFLGtCQUFrQixFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ2xHLENBQUM7Ozs7O0lBRU8sK0NBQWdCOzs7O0lBQXhCO1FBQ0ksSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLGFBQWEsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUN6RixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBQzFGLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxhQUFhLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztJQUM3RixDQUFDOzs7OztJQUVELDRDQUFhOzs7O0lBQWIsVUFBYyxLQUFVO1FBQXhCLGlCQXlGQztRQXhGRyxJQUFJLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEtBQUssU0FBUyxFQUFFOztnQkFDaEQsVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDOztnQkFDbkQsU0FBUyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsT0FBTzs7Z0JBQzNCLFVBQVUsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLFFBQVE7WUFFbkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUV4QixJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsVUFBVSxFQUFFO2dCQUMzQixJQUFJLENBQUMsVUFBVSxFQUFFO29CQUNiLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUFFLENBQUM7aUJBQzlCO3FCQUFNOzs7d0JBRUcsaUJBQWUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLEdBQUc7Ozs7b0JBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsRUFBRSxFQUFKLENBQUksRUFBQzs7d0JBQ3JELFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxNQUFNOzs7O29CQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsaUJBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssQ0FBQyxFQUFFLEVBQTVDLENBQTRDLEVBQUM7O3dCQUM3RixXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsTUFBTTs7OztvQkFBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsaUJBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQTVCLENBQTRCLEVBQUM7b0JBQ3BGLHdFQUF3RTtvQkFDeEUsSUFBSSxVQUFVLElBQUksVUFBVSxDQUFDLE1BQU0sRUFBRTt3QkFDakMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO3dCQUN6QyxJQUFJLENBQUMsS0FBSyxDQUFDLGVBQWUsbUJBQUUsS0FBSyxDQUFDLEVBQUUsR0FBSyxXQUFXLEVBQUUsQ0FBQztxQkFDMUQ7aUJBQ0o7YUFDSjtpQkFBTTtnQkFDSCxJQUFJLFVBQVUsRUFBRTs7d0JBQ1IsVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYTtvQkFDekMsSUFBSSxVQUFVLEtBQUssQ0FBQyxDQUFDLEVBQUU7d0JBQ25CLFVBQVUsR0FBRyxDQUFDLENBQUM7cUJBQ2xCOzt3QkFFSyxRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVE7O3dCQUMzQixLQUFLLEdBQUcsVUFBVTs7d0JBQ2xCLEdBQUcsR0FBRyxRQUFRO29CQUNsQixJQUFJLFVBQVUsR0FBRyxRQUFRLEVBQUU7d0JBQ3ZCLEtBQUssR0FBRyxRQUFRLENBQUM7d0JBQ2pCLEdBQUcsR0FBRyxVQUFVLENBQUM7cUJBQ3BCOzt3QkFFSyxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUU7O3dCQUMzQixZQUFZLEdBQUcsaUJBQUksSUFBSSxFQUFFLE1BQU0sQ0FBQyxLQUFLLEVBQUUsR0FBRyxHQUFHLEtBQUssR0FBRyxDQUFDLENBQUM7O3dCQUN2RCxZQUFZLEdBQUcsWUFBWSxDQUFDLEdBQUc7Ozs7b0JBQUMsVUFBQSxDQUFDO3dCQUNuQyxPQUFPLEtBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDdkMsQ0FBQyxFQUFDO29CQUVGLElBQUksQ0FBQyxTQUFTLEVBQUU7d0JBQ1osSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO3FCQUMxQztvQkFDRCwwQ0FBMEM7b0JBQzFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsQ0FBQztvQkFDekMsT0FBTyxJQUFJLENBQUM7aUJBQ2Y7YUFDSjtZQUVELElBQUksVUFBVSxJQUFJLFNBQVMsRUFBRTtnQkFDekIsS0FBSyxDQUFDLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQztnQkFDMUIsU0FBUztnQkFDVCxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ2hDLE9BQU8sSUFBSSxDQUFDO2FBQ2Y7O2dCQUVLLFNBQVMsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFOztnQkFDM0QsUUFBTSxHQUFHLFNBQVMsSUFBSSxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUEsQ0FBQyxDQUFDLENBQUM7O2dCQUVqRCxFQUFFLEdBQW9CLEVBQUUsQ0FBQyxJQUFJLENBQUM7WUFDbEMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRTs7b0JBQ25CLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUM7Z0JBQ3hDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFTLEVBQUU7b0JBQ2xCLEVBQUUsR0FBRyxDQUFDLENBQUM7aUJBQ1Y7YUFDSjtZQUNELEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQU0sQ0FBQyxDQUFDLENBQUMsU0FBUzs7OztZQUFDLFVBQUMsU0FBa0I7Z0JBQ2hELElBQUksU0FBUyxFQUFFO29CQUNYLEtBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztvQkFDeEQsSUFBSSxLQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRTt3QkFDeEIsS0FBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsRUFBRSxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUM7cUJBQ3hDO2lCQUNKO2dCQUNELEtBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFJLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO2dCQUNyRixLQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsS0FBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBRW5HLElBQUksUUFBTSxFQUFFO29CQUNSLElBQUksS0FBSyxDQUFDLE9BQU8sSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRTt3QkFDN0MsS0FBSyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO3FCQUN2QztpQkFDSjtZQUNMLENBQUMsRUFBQyxDQUFDO1lBRUgsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Ozs7SUFFRCwwQ0FBVzs7O0lBQVg7UUFDSSxJQUFJLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEtBQUssU0FBUyxFQUFFO1lBQ3RELElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztTQUNwQztJQUNMLENBQUM7O2dCQTVNSixVQUFVOzs7O2dCQUxGLGlCQUFpQjs7SUFrTjFCLDJCQUFDO0NBQUEsQUE3TUQsSUE2TUM7U0E1TVksb0JBQW9COzs7SUFDN0IscUNBQWdDOzs7OztJQUNoQywyQ0FBZ0M7Ozs7O0lBQ2hDLGdEQUFxQzs7Ozs7SUFDckMsc0NBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGF0YWdyaWRDb21wb25lbnQgfSBmcm9tICcuLy4uL2RhdGFncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgZGVsYXkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBTZWxlY3Rpb25Nb2RlU2VydmljZSB7XHJcbiAgICBkZ1JlZjogRGF0YWdyaWRDb21wb25lbnQgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBvbGRTZXR0aW5nczogYW55ID0gbnVsbDtcclxuICAgIHByaXZhdGUgc2VsZWN0U3RhcnRFdmVudDogYW55ID0gbnVsbDtcclxuICAgIHByaXZhdGUgZXZlbnRzID0gbnVsbDtcclxuICAgIGNvbnN0cnVjdG9yKGdyaWQ6IERhdGFncmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgdGhpcy5kZ1JlZiA9IGdyaWQ7XHJcbiAgICAgICAgaWYgKHRoaXMuZGdSZWYuc2VsZWN0aW9uTW9kZSA9PT0gJ2RlZmF1bHQnKSB7XHJcbiAgICAgICAgICAgIGdyaWQuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUV2ZW50cygpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5ldmVudHMgPSB0aGlzLnJlZ2lzdGVyU3RvcFNlbGVjdGlvbkV2ZW50KCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBkZXN0cm95KCkge1xyXG4gICAgICAgIHRoaXMuZGdSZWYgPSBudWxsO1xyXG4gICAgICAgIHRoaXMucmVtb3ZlRXZlbnRzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlRXZlbnRzKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmV2ZW50cyAmJiB0aGlzLmV2ZW50cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgdGhpcy5ldmVudHMuZm9yRWFjaChlID0+IHtcclxuICAgICAgICAgICAgICAgIGUoKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmV2ZW50cyA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyB0b2dnbGVNb2RlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmRnUmVmKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmRnUmVmLnNlbGVjdGlvbk1vZGUgPT09ICdkZWZhdWx0Jykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbmFibGVXaW5kb3dzU2VsZWN0aW9uTW9kZSgpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZXN0b3JlU2V0dGluZ3MoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZW5hYmxlV2luZG93c1NlbGVjdGlvbk1vZGUoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZGdSZWYpIHtcclxuICAgICAgICAgICAgdGhpcy5vbGRTZXR0aW5ncyA9IHtcclxuICAgICAgICAgICAgICAgIHNob3dDaGVja2JveDogdGhpcy5kZ1JlZi5zaG93Q2hlY2tib3gsXHJcbiAgICAgICAgICAgICAgICBrZWVwU2VsZWN0OiB0aGlzLmRnUmVmLmtlZXBTZWxlY3QsXHJcbiAgICAgICAgICAgICAgICBvbmx5U2VsZWN0U2VsZjogdGhpcy5kZ1JlZi5vbmx5U2VsZWN0U2VsZixcclxuICAgICAgICAgICAgICAgIHNlbGVjdE9uQ2hlY2s6IHRoaXMuZGdSZWYuc2VsZWN0T25DaGVjayxcclxuICAgICAgICAgICAgICAgIGNoZWNrT25TZWxlY3Q6IHRoaXMuZGdSZWYuY2hlY2tPblNlbGVjdFxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5zaG93Q2hlY2tib3ggPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmtlZXBTZWxlY3QgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLm9ubHlTZWxlY3RTZWxmID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuc2VsZWN0T25DaGVjayA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuY2hlY2tPblNlbGVjdCA9IHRydWU7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy51cGRhdGVQcm9wZXJ0eSgna2VlcFNlbGVjdCcsIHRydWUpO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy51cGRhdGVQcm9wZXJ0eSgnb25seVNlbGVjdFNlbGYnLCBmYWxzZSk7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnVwZGF0ZVByb3BlcnR5KCdzZWxlY3RPbkNoZWNrJywgdHJ1ZSk7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnVwZGF0ZVByb3BlcnR5KCdjaGVja09uU2VsZWN0JywgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyByZXN0b3JlU2V0dGluZ3MoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZGdSZWYgJiYgdGhpcy5vbGRTZXR0aW5ncykge1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLnNob3dDaGVja2JveCA9IHRoaXMub2xkU2V0dGluZ3Muc2hvd0NoZWNrYm94O1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmtlZXBTZWxlY3QgPSB0aGlzLm9sZFNldHRpbmdzLmtlZXBTZWxlY3Q7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYub25seVNlbGVjdFNlbGYgPSB0aGlzLm9sZFNldHRpbmdzLm9ubHlTZWxlY3RTZWxmO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLnNlbGVjdE9uQ2hlY2sgPSB0aGlzLm9sZFNldHRpbmdzLnNlbGVjdE9uQ2hlY2s7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuY2hlY2tPblNlbGVjdCA9IHRoaXMub2xkU2V0dGluZ3MuY2hlY2tPblNlbGVjdDtcclxuXHJcblxyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy51cGRhdGVQcm9wZXJ0eSgna2VlcFNlbGVjdCcsIHRoaXMub2xkU2V0dGluZ3Mua2VlcFNlbGVjdCk7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnVwZGF0ZVByb3BlcnR5KCdvbmx5U2VsZWN0U2VsZicsIHRoaXMub2xkU2V0dGluZ3Mub25seVNlbGVjdFNlbGYpO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy51cGRhdGVQcm9wZXJ0eSgnc2VsZWN0T25DaGVjaycsIHRoaXMub2xkU2V0dGluZ3Muc2VsZWN0T25DaGVjayk7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnVwZGF0ZVByb3BlcnR5KCdjaGVja09uU2VsZWN0JywgdGhpcy5vbGRTZXR0aW5ncy5jaGVja09uU2VsZWN0KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgcmVnaXN0ZXJTdG9wU2VsZWN0aW9uRXZlbnQoKSB7XHJcbiAgICAgICAgY29uc3Qga2QgPSB0aGlzLmRnUmVmLnJlbmRlcjIubGlzdGVuKGRvY3VtZW50LCAna2V5ZG93bicsIChldmVudDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChldmVudC5jdHJsS2V5IHx8IGV2ZW50LnNoaWZ0S2V5KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVuc2VsZWN0YWJsZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGt1ID0gdGhpcy5kZ1JlZi5yZW5kZXIyLmxpc3Rlbihkb2N1bWVudCwgJ2tleXVwJywgKGV2ZW50OiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQuc2hpZnRLZXkgfHwgZXZlbnQua2V5Q29kZSA9PT0gMTcgfHwgZXZlbnQua2V5Q29kZSA9PT0gMTYpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZW5hYmxlU2VsZWN0YWJsZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBbIGtkLCBrdV07XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB1bnNlbGVjdGFibGUoKSB7XHJcbiAgICAgICAgdGhpcy5kZ1JlZi5yZW5kZXIyLnNldEF0dHJpYnV0ZSh0aGlzLmRnUmVmLmRnQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICd1bnNlbGVjdGFibGUnLCAnb24nKTtcclxuICAgICAgICB0aGlzLmRnUmVmLnJlbmRlcjIuc2V0QXR0cmlidXRlKHRoaXMuZGdSZWYuZGdDb250YWluZXIubmF0aXZlRWxlbWVudCwgJ29uc2VsZWN0c3RhcnQnLCAncmV0dXJuIGZhbHNlJyk7XHJcbiAgICAgICAgdGhpcy5kZ1JlZi5yZW5kZXIyLnNldFN0eWxlKHRoaXMuZGdSZWYuZGdDb250YWluZXIubmF0aXZlRWxlbWVudCwgJy1tb3otdXNlci1zZWxlY3QnLCAnbm9uZScpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZW5hYmxlU2VsZWN0YWJsZSgpIHtcclxuICAgICAgICB0aGlzLmRnUmVmLnJlbmRlcjIucmVtb3ZlQXR0cmlidXRlKHRoaXMuZGdSZWYuZGdDb250YWluZXIubmF0aXZlRWxlbWVudCwgJ3Vuc2VsZWN0YWJsZScpO1xyXG4gICAgICAgIHRoaXMuZGdSZWYucmVuZGVyMi5yZW1vdmVBdHRyaWJ1dGUodGhpcy5kZ1JlZi5kZ0NvbnRhaW5lci5uYXRpdmVFbGVtZW50LCAnb25zZWxlY3RzdGFydCcpO1xyXG4gICAgICAgIHRoaXMuZGdSZWYucmVuZGVyMi5yZW1vdmVTdHlsZSh0aGlzLmRnUmVmLmRnQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICctbW96LXVzZXItc2VsZWN0Jyk7XHJcbiAgICB9XHJcblxyXG4gICAgYmVmb3JSb3dDbGljayhwYXJhbTogYW55KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZGdSZWYgJiYgdGhpcy5kZ1JlZi5zZWxlY3Rpb25Nb2RlID09PSAnZGVmYXVsdCcpIHtcclxuICAgICAgICAgICAgY29uc3QgaXNTZWxlY3RlZCA9IHRoaXMuZGdSZWYuZGZzLmlzUm93U2VsZWN0ZWQocGFyYW0uaWQpO1xyXG4gICAgICAgICAgICBjb25zdCBpc0N0cmxLZXkgPSBwYXJhbS5lLmN0cmxLZXk7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzU2hpZnRLZXkgPSBwYXJhbS5lLnNoaWZ0S2V5O1xyXG5cclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5lbmRFZGl0aW5nKCk7XHJcblxyXG4gICAgICAgICAgICBpZiAoIWlzQ3RybEtleSAmJiAhaXNTaGlmdEtleSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFpc1NlbGVjdGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5jbGVhckNoZWNrZWRzKCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOWmguaenOacieWkmuadoemAie+8jOenu+mZpOWFtuS7lumAieS4reihjFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRQYWdlcklkcyA9IHRoaXMuZGdSZWYuZ2V0Um93cygpLm1hcChuID0+IG4uaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHVuQ2hlY2tJRHMgPSB0aGlzLmRnUmVmLmNoZWNrVmFsdWVzLmZpbHRlcihpID0+IGN1cnJlbnRQYWdlcklkcy5pbmNsdWRlcyhpKSAmJiBpICE9IHBhcmFtLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB1blNlbGVjdElkcyA9IHRoaXMuZGdSZWYuY2hlY2tWYWx1ZXMuZmlsdGVyKG4gPT4gIWN1cnJlbnRQYWdlcklkcy5pbmNsdWRlcyhuKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gY29uc3QgdW5DaGVja0lEcyA9IHRoaXMuZGdSZWYuY2hlY2tWYWx1ZXMuZmlsdGVyKG4gPT4gbiAhPSBwYXJhbS5pZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHVuQ2hlY2tJRHMgJiYgdW5DaGVja0lEcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi51bkNoZWNrUm93cyh1bkNoZWNrSURzLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5jbGVhclNlbGVjdGlvbnMoW3BhcmFtLmlkLCAuLi51blNlbGVjdElkc10pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChpc1NoaWZ0S2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZvY3VzSW5kZXggPSB0aGlzLmRnUmVmLmZvY3VzUm93SW5kZXg7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvY3VzSW5kZXggPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvY3VzSW5kZXggPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kSW5kZXggPSBwYXJhbS5yb3dJbmRleDtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgc3RhcnQgPSBmb2N1c0luZGV4O1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBlbmQgPSBlbmRJbmRleDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZm9jdXNJbmRleCA+IGVuZEluZGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gZW5kSW5kZXg7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZCA9IGZvY3VzSW5kZXg7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gdGhpcy5kZ1JlZi5nZXRSb3dzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hlY2tlZEl0ZW1zID0gWy4uLmRhdGFdLnNwbGljZShzdGFydCwgZW5kIC0gc3RhcnQgKyAxKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB3aWxsQ2hlY2tJZHMgPSBjaGVja2VkSXRlbXMubWFwKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kZ1JlZi5kZnMucHJpbWFyeUlkKG4pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzQ3RybEtleSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLmNsZWFyQ2hlY2tlZHMoZmFsc2UsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5kZ1JlZi5zZWxlY3RWYWx1ZXMgPSB3aWxsQ2hlY2tJZHM7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5jaGVja1Jvd3Mod2lsbENoZWNrSWRzLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGlzU2VsZWN0ZWQgJiYgaXNDdHJsS2V5KSB7XHJcbiAgICAgICAgICAgICAgICBwYXJhbS5lLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgLy8g5omn6KGM5Y+W5raI6YCJ5oupXHJcbiAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLnVuQ2hlY2tSb3cocGFyYW0uaWQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHpvbmVDbGljayA9IHBhcmFtLmNlbGxyZWYgPyBwYXJhbS5jZWxscmVmWyd6b25lQ2xpY2snXSA6ICcnOyAgXHJcbiAgICAgICAgICAgIGNvbnN0IF90aW1lciA9IHpvbmVDbGljayAmJiB6b25lQ2xpY2subGVuZ3RoID8gMTAwOiAwO1xyXG5cclxuICAgICAgICAgICAgbGV0IHIkOiBPYnNlcnZhYmxlPGFueT4gPSBvZih0cnVlKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZGdSZWYuYmVmb3JlU2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByID0gdGhpcy5kZ1JlZi5iZWZvcmVTZWxlY3QocGFyYW0pO1xyXG4gICAgICAgICAgICAgICAgaWYgKHIgJiYgci5zdWJzY3JpYmUpIHtcclxuICAgICAgICAgICAgICAgICAgICByJCA9IHI7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgciQucGlwZShkZWxheShfdGltZXIpKS5zdWJzY3JpYmUoKGNhblNlbGVjdDogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGNhblNlbGVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnNlbGVjdFJvdyhwYXJhbS5yb3dJbmRleCwgcGFyYW0ucm93RGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGdSZWYuc2VsZWN0ZWRSb3cpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5zZWxlY3RlZFJvdy5kciA9IHBhcmFtLmRyO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYucm93Q2xpY2suZW1pdCh7IGRhdGE6IHBhcmFtLnJvd0RhdGEsIGdyaWQ6IHRoaXMuZGdSZWYsIGRibGNsaWNrOiBmYWxzZSB9KTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYuZGdzLnNldFNlbGVjZWRSb3cuZW1pdCh7IHNlbGVjdGVkOiB0cnVlLCBpZDogdGhpcy5kZ1JlZi5kZnMucHJpbWFyeUlkKHBhcmFtLnJvd0RhdGEpIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChfdGltZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocGFyYW0uY2VsbHJlZiAmJiBwYXJhbS5jZWxscmVmLnJ1blpvbmVDbGljaykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJhbS5jZWxscmVmLnJ1blpvbmVDbGljayhwYXJhbS5lKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBlbmRSb3dDbGljaygpIHtcclxuICAgICAgICBpZiAodGhpcy5kZ1JlZiAmJiB0aGlzLmRnUmVmLnNlbGVjdGlvbk1vZGUgPT09ICdkZWZhdWx0Jykge1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmNoZWNrT25TZWxlY3QgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbiJdfQ==