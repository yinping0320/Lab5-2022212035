/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ColumnFormatService } from '@farris/ui-common/column';
/*
 * @Author: 疯狂秀才(Lucas Huang)
 * @Date: 2019-07-29 08:14:22
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-10-11 11:38:58
 * @QQ: 1055818239
 * @Version: v0.0.1
 */
import { DatagridComponent } from './../../datagrid.component';
import { ComponentFactoryResolver, Directive, Input, ViewContainerRef, Inject, forwardRef, ApplicationRef } from '@angular/core';
import { FormGroup, FormBuilder } from '@angular/forms';
var GridCellEditorDirective = /** @class */ (function () {
    function GridCellEditorDirective(resolver, container, app, fb, dg) {
        this.resolver = resolver;
        this.container = container;
        this.app = app;
        this.fb = fb;
        this.dg = dg;
        this.cfs = null;
        this.timer = null;
        this.cfs = this.dg.inject.get(ColumnFormatService);
    }
    /**
     * @return {?}
     */
    GridCellEditorDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        if (this.column.editor) {
            this.createCellEditor();
        }
    };
    /**
     * @return {?}
     */
    GridCellEditorDirective.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        this.dg.dgs.cellEditorCreated.emit({ editorRef: this.componentRef, column: this.column, cellEditorRef: this });
    };
    /**
     * @return {?}
     */
    GridCellEditorDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.dg.dgs.cellEditorDestory.emit({ editorRef: this.componentRef, column: this.column, cellEditorRef: this });
        if (this.componentRef) {
            this.componentRef.destroy();
        }
        this.componentRef = null;
        if (this.timer) {
            clearTimeout(this.timer);
        }
    };
    /**
     * @private
     * @return {?}
     */
    GridCellEditorDirective.prototype.createCellEditor = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var editorType = this.column.editor.type;
        if (!this.dg.editors[editorType]) {
            this.dg.writeConsole("\u627E\u4E0D\u5230\u540D\u79F0\u4E3A " + editorType + " \u5BF9\u5E94\u7684\u7C7B\u3002", 'error');
            return;
        }
        /** @type {?} */
        var factory = this.resolver.resolveComponentFactory(this.dg.editors[editorType]);
        this.componentRef = this.container.createComponent(factory);
        // this.componentRef.instance.dg = this.dg;
        // this.app.attachView(this.componentRef.hostView);
        this.componentRef.instance.column = this.column;
        this.componentRef.instance.group = this.group;
        this.componentRef.instance.height = this.height;
        this.componentRef.instance.controlId = (this.dg.id || 'DATAGRID_EDITOR') + '_' + this.column.field;
        this.updateControlValue();
        this.componentRef.changeDetectorRef.markForCheck();
        this.componentRef.changeDetectorRef.detectChanges();
        // this.app.tick();
        if (this.timer) {
            clearTimeout(this.timer);
        }
        this.timer = setTimeout((/**
         * @return {?}
         */
        function () {
            if (_this.componentRef.instance.instance) {
                if (editorType === 'lookup') {
                    if (!_this.componentRef.instance.instance.changeDetector.destroyed) {
                        _this.componentRef.instance.instance.changeDetector.detectChanges();
                    }
                    // this.componentRef.instance['bindingData'] = this.rowData;
                }
                // if (editorType === 'textarea') {
                //     const textareaEl = this.componentRef.instance.inputElement;
                //     textareaEl.style.height = textareaEl.closest('tr').style.height;
                // }
            }
        }));
    };
    /**
     * @private
     * @return {?}
     */
    GridCellEditorDirective.prototype.updateControlValue = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.group) {
            this.group['bindingData'] = this.rowData;
            if (this.group.controls[this.column.field]) {
                // if (this.column.editor.type === 'datepicker') {
                //     const dateRef = this.componentRef.instance.instance;
                //     if (dateRef) {
                //         setTimeout(() => {
                //             const { dateFormat } = dateRef.dateOpts;
                //             const val = this.cfs.format(this.value, this.rowData, {type: 'datetime', options: { format: dateFormat}});
                //             this.group.controls[this.column.field].setValue(val, { emitEvent: true });
                //         });
                //     }
                // } else {
                //     this.group.controls[this.column.field].setValue(this.value, { emitEvent: true });
                // }
                this.group.controls[this.column.field].setValue(this.value, { emitEvent: true });
            }
        }
    };
    /**
     * @return {?}
     */
    GridCellEditorDirective.prototype.hideCover = /**
     * @return {?}
     */
    function () {
        if (this.componentRef && this.column.editor && (this.column.editor.type === 'combolist' || this.column.editor.type === 'combo-lookup')) {
            this.componentRef.instance.hide(!1);
        }
    };
    GridCellEditorDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[cell-editor]',
                },] }
    ];
    /** @nocollapse */
    GridCellEditorDirective.ctorParameters = function () { return [
        { type: ComponentFactoryResolver },
        { type: ViewContainerRef },
        { type: ApplicationRef },
        { type: FormBuilder },
        { type: DatagridComponent, decorators: [{ type: Inject, args: [forwardRef((/**
                         * @return {?}
                         */
                        function () { return DatagridComponent; })),] }] }
    ]; };
    GridCellEditorDirective.propDecorators = {
        column: [{ type: Input }],
        group: [{ type: Input }],
        rowData: [{ type: Input }],
        value: [{ type: Input }],
        height: [{ type: Input }]
    };
    return GridCellEditorDirective;
}());
export { GridCellEditorDirective };
if (false) {
    /** @type {?} */
    GridCellEditorDirective.prototype.column;
    /** @type {?} */
    GridCellEditorDirective.prototype.group;
    /** @type {?} */
    GridCellEditorDirective.prototype.rowData;
    /** @type {?} */
    GridCellEditorDirective.prototype.value;
    /** @type {?} */
    GridCellEditorDirective.prototype.height;
    /** @type {?} */
    GridCellEditorDirective.prototype.componentRef;
    /**
     * @type {?}
     * @private
     */
    GridCellEditorDirective.prototype.cfs;
    /**
     * @type {?}
     * @private
     */
    GridCellEditorDirective.prototype.timer;
    /**
     * @type {?}
     * @private
     */
    GridCellEditorDirective.prototype.resolver;
    /**
     * @type {?}
     * @private
     */
    GridCellEditorDirective.prototype.container;
    /**
     * @type {?}
     * @private
     */
    GridCellEditorDirective.prototype.app;
    /**
     * @type {?}
     * @private
     */
    GridCellEditorDirective.prototype.fb;
    /** @type {?} */
    GridCellEditorDirective.prototype.dg;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2VsbC1lZGl0b3IuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2VkaXRvcnMvY2VsbC1lZGl0b3IuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQzs7Ozs7Ozs7O0FBUy9ELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQy9ELE9BQU8sRUFDSCx3QkFBd0IsRUFFeEIsU0FBUyxFQUNULEtBQUssRUFHTCxnQkFBZ0IsRUFHaEIsTUFBTSxFQUNOLFVBQVUsRUFDVixjQUFjLEVBQ2pCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHeEQ7SUFZSSxpQ0FDWSxRQUFrQyxFQUNsQyxTQUEyQixFQUMzQixHQUFtQixFQUNuQixFQUFlLEVBQzZCLEVBQXFCO1FBSmpFLGFBQVEsR0FBUixRQUFRLENBQTBCO1FBQ2xDLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQzNCLFFBQUcsR0FBSCxHQUFHLENBQWdCO1FBQ25CLE9BQUUsR0FBRixFQUFFLENBQWE7UUFDNkIsT0FBRSxHQUFGLEVBQUUsQ0FBbUI7UUFQckUsUUFBRyxHQUF3QixJQUFJLENBQUM7UUFDaEMsVUFBSyxHQUFHLElBQUksQ0FBQztRQVFqQixJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7Ozs7SUFFRCwwQ0FBUTs7O0lBQVI7UUFDSSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFO1lBQ3BCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1NBQzNCO0lBQ0wsQ0FBQzs7OztJ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SUFDTCxDQUFDOztnQkFqSEosU0FBUyxTQUFDO29CQUNQLFFBQVEsRUFBRSxlQUFlO2lCQUM1Qjs7OztnQkFsQkcsd0JBQXdCO2dCQU14QixnQkFBZ0I7Z0JBS2hCLGNBQWM7Z0JBRUUsV0FBVztnQkFmdEIsaUJBQWlCLHVCQW1DakIsTUFBTSxTQUFDLFVBQVU7Ozt3QkFBQyxjQUFNLE9BQUEsaUJBQWlCLEVBQWpCLENBQWlCLEVBQUM7Ozt5QkFiOUMsS0FBSzt3QkFDTCxLQUFLOzBCQUNMLEtBQUs7d0JBQ0wsS0FBSzt5QkFDTCxLQUFLOztJQTBHViw4QkFBQztDQUFBLEFBbEhELElBa0hDO1NBL0dZLHVCQUF1Qjs7O0lBQ2hDLHlDQUE0Qjs7SUFDNUIsd0NBQTBCOztJQUMxQiwwQ0FBc0I7O0lBQ3RCLHdDQUFvQjs7SUFDcEIseUNBQXFCOztJQUNyQiwrQ0FBZ0M7Ozs7O0lBQ2hDLHNDQUF3Qzs7Ozs7SUFDeEMsd0NBQXFCOzs7OztJQUVqQiwyQ0FBMEM7Ozs7O0lBQzFDLDRDQUFtQzs7Ozs7SUFDbkMsc0NBQTJCOzs7OztJQUMzQixxQ0FBdUI7O0lBQ3ZCLHFDQUF5RSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbHVtbkZvcm1hdFNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbi9jb2x1bW4nO1xyXG4vKlxyXG4gKiBAQXV0aG9yOiDnlq/ni4Lnp4DmiY0oTHVjYXMgSHVhbmcpXHJcbiAqIEBEYXRlOiAyMDE5LTA3LTI5IDA4OjE0OjIyXHJcbiAqIEBMYXN0RWRpdG9yczog55av54uC56eA5omNKEx1Y2FzIEh1YW5nKVxyXG4gKiBATGFzdEVkaXRUaW1lOiAyMDE5LTEwLTExIDExOjM4OjU4XHJcbiAqIEBRUTogMTA1NTgxODIzOVxyXG4gKiBAVmVyc2lvbjogdjAuMC4xXHJcbiAqL1xyXG5pbXBvcnQgeyBEYXRhZ3JpZENvbXBvbmVudCB9IGZyb20gJy4vLi4vLi4vZGF0YWdyaWQuY29tcG9uZW50JztcclxuaW1wb3J0IHtcclxuICAgIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcclxuICAgIENvbXBvbmVudFJlZixcclxuICAgIERpcmVjdGl2ZSxcclxuICAgIElucHV0LFxyXG4gICAgT25Jbml0LFxyXG4gICAgQWZ0ZXJWaWV3SW5pdCxcclxuICAgIFZpZXdDb250YWluZXJSZWYsXHJcbiAgICBJbmplY3RvcixcclxuICAgIE9uRGVzdHJveSxcclxuICAgIEluamVjdCxcclxuICAgIGZvcndhcmRSZWYsXHJcbiAgICBBcHBsaWNhdGlvblJlZlxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBGb3JtR3JvdXAsIEZvcm1CdWlsZGVyIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQgeyBEYXRhQ29sdW1uIH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogJ1tjZWxsLWVkaXRvcl0nLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgR3JpZENlbGxFZGl0b3JEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSB7XHJcbiAgICBASW5wdXQoKSBjb2x1bW46IERhdGFDb2x1bW47XHJcbiAgICBASW5wdXQoKSBncm91cDogRm9ybUdyb3VwO1xyXG4gICAgQElucHV0KCkgcm93RGF0YTogYW55O1xyXG4gICAgQElucHV0KCkgdmFsdWU6IGFueTtcclxuICAgIEBJbnB1dCgpIGhlaWdodDogYW55O1xyXG4gICAgY29tcG9uZW50UmVmOiBDb21wb25lbnRSZWY8YW55PjtcclxuICAgIHByaXZhdGUgY2ZzOiBDb2x1bW5Gb3JtYXRTZXJ2aWNlID0gbnVsbDtcclxuICAgIHByaXZhdGUgdGltZXIgPSBudWxsO1xyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSByZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxyXG4gICAgICAgIHByaXZhdGUgY29udGFpbmVyOiBWaWV3Q29udGFpbmVyUmVmLFxyXG4gICAgICAgIHByaXZhdGUgYXBwOiBBcHBsaWNhdGlvblJlZixcclxuICAgICAgICBwcml2YXRlIGZiOiBGb3JtQnVpbGRlcixcclxuICAgICAgICBASW5qZWN0KGZvcndhcmRSZWYoKCkgPT4gRGF0YWdyaWRDb21wb25lbnQpKSBwdWJsaWMgZGc6IERhdGFncmlkQ29tcG9uZW50XHJcbiAgICApIHtcclxuICAgICAgICB0aGlzLmNmcyA9IHRoaXMuZGcuaW5qZWN0LmdldChDb2x1bW5Gb3JtYXRTZXJ2aWNlKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uSW5pdCgpIHtcclxuICAgICAgICBpZiAodGhpcy5jb2x1bW4uZWRpdG9yKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlQ2VsbEVkaXRvcigpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBuZ0FmdGVyVmlld0luaXQoKSB7XHJcbiAgICAgICAgdGhpcy5kZy5kZ3MuY2VsbEVkaXRvckNyZWF0ZWQuZW1pdCh7IGVkaXRvclJlZjogdGhpcy5jb21wb25lbnRSZWYsIGNvbHVtbjogdGhpcy5jb2x1bW4sIGNlbGxFZGl0b3JSZWY6IHRoaXN9KTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpIHtcclxuICAgICAgICB0aGlzLmRnLmRncy5jZWxsRWRpdG9yRGVzdG9yeS5lbWl0KHsgZWRpdG9yUmVmOiB0aGlzLmNvbXBvbmVudFJlZiwgY29sdW1uOiB0aGlzLmNvbHVtbiwgY2VsbEVkaXRvclJlZjogdGhpc30pO1xyXG4gICAgICAgIGlmICh0aGlzLmNvbXBvbmVudFJlZikge1xyXG4gICAgICAgICAgICB0aGlzLmNvbXBvbmVudFJlZi5kZXN0cm95KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY29tcG9uZW50UmVmID0gbnVsbDtcclxuICAgICAgICBpZiAodGhpcy50aW1lcikge1xyXG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lcik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY3JlYXRlQ2VsbEVkaXRvcigpIHtcclxuXHJcbiAgICAgICAgY29uc3QgZWRpdG9yVHlwZSA9IHRoaXMuY29sdW1uLmVkaXRvci50eXBlO1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMuZGcuZWRpdG9yc1tlZGl0b3JUeXBlXSkge1xyXG4gICAgICAgICAgICB0aGlzLmRnLndyaXRlQ29uc29sZShg5om+5LiN5Yiw5ZCN56ew5Li6ICR7ZWRpdG9yVHlwZX0g5a+55bqU55qE57G744CCYCwgJ2Vycm9yJyk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGZhY3RvcnkgPSB0aGlzLnJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KFxyXG4gICAgICAgICAgICB0aGlzLmRnLmVkaXRvcnNbZWRpdG9yVHlwZV1cclxuICAgICAgICApO1xyXG4gICAgICAgIHRoaXMuY29tcG9uZW50UmVmID0gdGhpcy5jb250YWluZXIuY3JlYXRlQ29tcG9uZW50KGZhY3RvcnkpO1xyXG5cclxuICAgICAgICAvLyB0aGlzLmNvbXBvbmVudFJlZi5pbnN0YW5jZS5kZyA9IHRoaXMuZGc7XHJcbiAgICAgICAgLy8gdGhpcy5hcHAuYXR0YWNoVmlldyh0aGlzLmNvbXBvbmVudFJlZi5ob3N0Vmlldyk7XHJcbiAgICAgICAgdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UuY29sdW1uID0gdGhpcy5jb2x1bW47XHJcbiAgICAgICAgdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UuZ3JvdXAgPSB0aGlzLmdyb3VwO1xyXG4gICAgICAgIHRoaXMuY29tcG9uZW50UmVmLmluc3RhbmNlLmhlaWdodCA9IHRoaXMuaGVpZ2h0O1xyXG4gICAgICAgIHRoaXMuY29tcG9uZW50UmVmLmluc3RhbmNlLmNvbnRyb2xJZCA9ICh0aGlzLmRnLmlkIHx8ICdEQVRBR1JJRF9FRElUT1InKSArICdfJyArIHRoaXMuY29sdW1uLmZpZWxkO1xyXG5cclxuICAgICAgICB0aGlzLnVwZGF0ZUNvbnRyb2xWYWx1ZSgpO1xyXG4gICAgICAgIHRoaXMuY29tcG9uZW50UmVmLmNoYW5nZURldGVjdG9yUmVmLm1hcmtGb3JDaGVjaygpO1xyXG4gICAgICAgIHRoaXMuY29tcG9uZW50UmVmLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICAvLyB0aGlzLmFwcC50aWNrKCk7XHJcbiAgICAgICAgaWYgKHRoaXMudGltZXIpIHtcclxuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmNvbXBvbmVudFJlZi5pbnN0YW5jZS5pbnN0YW5jZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVkaXRvclR5cGUgPT09ICdsb29rdXAnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmNvbXBvbmVudFJlZi5pbnN0YW5jZS5pbnN0YW5jZS5jaGFuZ2VEZXRlY3Rvci5kZXN0cm95ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UuaW5zdGFuY2UuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLmNvbXBvbmVudFJlZi5pbnN0YW5jZVsnYmluZGluZ0RhdGEnXSA9IHRoaXMucm93RGF0YTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vIGlmIChlZGl0b3JUeXBlID09PSAndGV4dGFyZWEnKSB7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgY29uc3QgdGV4dGFyZWFFbCA9IHRoaXMuY29tcG9uZW50UmVmLmluc3RhbmNlLmlucHV0RWxlbWVudDtcclxuICAgICAgICAgICAgICAgIC8vICAgICB0ZXh0YXJlYUVsLnN0eWxlLmhlaWdodCA9IHRleHRhcmVhRWwuY2xvc2VzdCgndHInKS5zdHlsZS5oZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICAvLyB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHVwZGF0ZUNvbnRyb2xWYWx1ZSgpIHtcclxuICAgICAgICBpZiAodGhpcy5ncm91cCkge1xyXG4gICAgICAgICAgICB0aGlzLmdyb3VwWydiaW5kaW5nRGF0YSddID0gdGhpcy5yb3dEYXRhO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5ncm91cC5jb250cm9sc1t0aGlzLmNvbHVtbi5maWVsZF0pIHtcclxuICAgICAgICAgICAgICAgIC8vIGlmICh0aGlzLmNvbHVtbi5lZGl0b3IudHlwZSA9PT0gJ2RhdGVwaWNrZXInKSB7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgY29uc3QgZGF0ZVJlZiA9IHRoaXMuY29tcG9uZW50UmVmLmluc3RhbmNlLmluc3RhbmNlO1xyXG4gICAgICAgICAgICAgICAgLy8gICAgIGlmIChkYXRlUmVmKSB7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8gICAgICAgICAgICAgY29uc3QgeyBkYXRlRm9ybWF0IH0gPSBkYXRlUmVmLmRhdGVPcHRzO1xyXG4gICAgICAgICAgICAgICAgLy8gICAgICAgICAgICAgY29uc3QgdmFsID0gdGhpcy5jZnMuZm9ybWF0KHRoaXMudmFsdWUsIHRoaXMucm93RGF0YSwge3R5cGU6ICdkYXRldGltZScsIG9wdGlvbnM6IHsgZm9ybWF0OiBkYXRlRm9ybWF0fX0pO1xyXG4gICAgICAgICAgICAgICAgLy8gICAgICAgICAgICAgdGhpcy5ncm91cC5jb250cm9sc1t0aGlzLmNvbHVtbi5maWVsZF0uc2V0VmFsdWUodmFsLCB7IGVtaXRFdmVudDogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgICAgIC8vICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vICAgICB0aGlzLmdyb3VwLmNvbnRyb2xzW3RoaXMuY29sdW1uLmZpZWxkXS5zZXRWYWx1ZSh0aGlzLnZhbHVlLCB7IGVtaXRFdmVudDogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgICAgIC8vIH1cclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLmdyb3VwLmNvbnRyb2xzW3RoaXMuY29sdW1uLmZpZWxkXS5zZXRWYWx1ZSh0aGlzLnZhbHVlLCB7IGVtaXRFdmVudDogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBoaWRlQ292ZXIoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuY29tcG9uZW50UmVmICYmIHRoaXMuY29sdW1uLmVkaXRvciAmJiAodGhpcy5jb2x1bW4uZWRpdG9yLnR5cGUgPT09ICdjb21ib2xpc3QnIHx8IHRoaXMuY29sdW1uLmVkaXRvci50eXBlID09PSAnY29tYm8tbG9va3VwJykpIHtcclxuICAgICAgICAgICAgdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UuaGlkZSghMSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcbiJdfQ==