/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { DatagridComponent } from './../datagrid.component';
import { LocaleService } from '@farris/ui-locale';
import { Pipe, Injector, Optional, ElementRef, LOCALE_ID } from '@angular/core';
import { Utils } from './utils';
import { ColumnFormatService } from '@farris/ui-common/column';
var FormatCellDataPipe = /** @class */ (function () {
    function FormatCellDataPipe(cfs, injector) {
        this.cfs = cfs;
        this.injector = injector;
        this.localeId = 'ZH-CHS';
        this.localeId = this.injector.get(LOCALE_ID);
    }
    /**
     * @param {?} col
     * @param {?} rowData
     * @param {?=} groupFooter
     * @param {?=} footer
     * @return {?}
     */
    FormatCellDataPipe.prototype.transform = /**
     * @param {?} col
     * @param {?} rowData
     * @param {?=} groupFooter
     * @param {?=} footer
     * @return {?}
     */
    function (col, rowData, groupFooter, footer) {
        if (groupFooter === void 0) { groupFooter = false; }
        if (footer === void 0) { footer = false; }
        if (rowData && col && col.field) {
            /** @type {?} */
            var value = Utils.getValue(col.field, rowData);
            if (col.editor && col.editor.options && col.editor.options.isPassword && !col.formatter) {
                return value ? '******' : '';
            }
            /** @type {?} */
            var formatterFn = col.formatter;
            if (groupFooter) {
                formatterFn = col.groupFooter ? col.groupFooter.formatter : undefined;
            }
            else if (footer) {
                formatterFn = col.footer ? col.footer.formatter : undefined;
                if (typeof formatterFn === 'object') {
                    if (!formatterFn.options) {
                        /** @type {?} */
                        var opts = { type: formatterFn.type, options: formatterFn };
                        formatterFn = opts;
                    }
                }
            }
            if (!formatterFn) {
                /** @type {?} */
                var resoultStr = value;
                if (col.isMultilingualField) {
                    resoultStr = this.getMultilingualValue(value);
                }
                else {
                    if (value !== null && value !== undefined && value !== '0' && typeof value === 'string') {
                        this.getDatagridInstance();
                        if (value.indexOf('\n') > -1) {
                            // return value.replace(/\n/g, '<br>');
                            if (this.dataGrid && this.dataGrid.nowrap) {
                                resoultStr = value.replace(/\n/g, ' ');
                            }
                        }
                        this.setFooterCellTitle(resoultStr, footer, col.field);
                    }
                    // value.replace(/ /g, '&ensp;');
                }
                return this.setPlaceHolderWhenEnableEditCellStyle(col, resoultStr, rowData, groupFooter || footer);
            }
            else {
                if (formatterFn) {
                    if (formatterFn.type === 'number') {
                        if (!formatterFn.options || !Object.keys(formatterFn.options).length) {
                            formatterFn.options = {
                                thousand: ',',
                                precision: 2
                            };
                        }
                    }
                    if (formatterFn.type === 'datetime') {
                        if (formatterFn.options) {
                            if (col.editor && col.editor.options) {
                                var _a = col.editor.options, dateRange = _a.dateRange, dateRangeDatesDelimiter = _a.dateRangeDatesDelimiter;
                                formatterFn.options = Object.assign({ dateRange: dateRange, dateRangeDatesDelimiter: dateRangeDatesDelimiter }, formatterFn.options);
                            }
                        }
                    }
                    if (formatterFn.type === 'timeago') {
                        if (formatterFn.options) {
                            formatterFn.options.locale = formatterFn.options.locale || this.localeId;
                        }
                        else {
                            formatterFn.options = {
                                locale: this.localeId
                            };
                        }
                    }
                }
                this.getDatagridInstance();
                /** @type {?} */
                var r = '';
                if (this.dataGrid) {
                    r = this.cfs.format(value, rowData, formatterFn, { utils: this.dataGrid.commonUtils, locale: this.localeId });
                    this.setFooterCellTitle(r, footer, col.field);
                    return this.setPlaceHolderWhenEnableEditCellStyle(col, r, rowData, groupFooter || footer);
                }
                else {
                    r = this.cfs.format(value, rowData, formatterFn, { locale: this.localeId });
                    this.setFooterCellTitle(r, footer, col.field);
                    return r;
                }
            }
        }
        return '';
    };
    /**
     * @private
     * @param {?} text
     * @param {?} isFooter
     * @param {?} field
     * @return {?}
     */
    FormatCellDataPipe.prototype.setFooterCellTitle = /**
     * @private
     * @param {?} text
     * @param {?} isFooter
     * @param {?} field
     * @return {?}
     */
    function (text, isFooter, field) {
        if (text && isFooter && this.elRef) {
            /** @type {?} */
            var span = this.elRef.nativeElement.querySelector("td[field=\"" + field + "\"] .f-datagrid-footer-cell");
            if (span) {
                span.title = text;
            }
        }
    };
    // 获取多语数据
    // 获取多语数据
    /**
     * @private
     * @param {?} valObj
     * @return {?}
     */
    FormatCellDataPipe.prototype.getMultilingualValue = 
    // 获取多语数据
    /**
     * @private
     * @param {?} valObj
     * @return {?}
     */
    function (valObj) {
        if (valObj && typeof valObj === 'object' && Object.keys(valObj).length > 0) {
            if (this.injector) {
                this.localeService = this.injector.get(LocaleService);
            }
            if (this.localeService) {
                /** @type {?} */
                var localeId = this.localeService.localeId;
                return Utils.getMultilingualValue(valObj, localeId);
            }
            else {
                return valObj['zh-CHS'];
            }
        }
        else {
            return '';
        }
    };
    // 启用标识可编辑单元格时，内容为空时设置提示语
    // 启用标识可编辑单元格时，内容为空时设置提示语
    /**
     * @private
     * @param {?} col
     * @param {?} val
     * @param {?} rowData
     * @param {?} isFooter
     * @return {?}
     */
    FormatCellDataPipe.prototype.setPlaceHolderWhenEnableEditCellStyle = 
    // 启用标识可编辑单元格时，内容为空时设置提示语
    /**
     * @private
     * @param {?} col
     * @param {?} val
     * @param {?} rowData
     * @param {?} isFooter
     * @return {?}
     */
    function (col, val, rowData, isFooter) {
        this.getDatagridInstance();
        if (this.dataGrid) {
            /*
            if (!this.dataGrid.editable || (val !== null && val !== undefined && val !== '') || isFooter || this.cellIsReadOnly(col, rowData)) {
                if (this.elRef) {
                    const span = this.elRef.nativeElement.querySelector('.cell-text-box');
                    if (span && span.className.indexOf('cell-empty') > -1) {
                        span.className = span.className.replace('cell-empty', ' ');
                    }
                }

                return val;
            }
*/
            if (this.dataGrid.enableEditCellStyle) {
                if (!this.dataGrid.editable || (val !== null && val !== undefined && val !== '') || isFooter || this.cellIsReadOnly(col, rowData)) {
                    if (this.elRef) {
                        /** @type {?} */
                        var span = this.elRef.nativeElement.querySelector('.cell-text-box');
                        if (span && span.className.indexOf('cell-empty') > -1) {
                            span.className = span.className.replace('cell-empty', ' ');
                        }
                    }
                    return val;
                }
                if (this.elRef) {
                    /** @type {?} */
                    var span = this.elRef.nativeElement.querySelector('.cell-text-box');
                    if (span && span.className.indexOf('cell-empty') === -1) {
                        span.className = span.className + ' cell-empty';
                    }
                }
                return Utils.getWhenEmptyText(col, this.localeId);
            }
            return val;
        }
        return val;
    };
    /**
     * @private
     * @return {?}
     */
    FormatCellDataPipe.prototype.getDatagridInstance = /**
     * @private
     * @return {?}
     */
    function () {
        if (!this.dataGrid) {
            this.dataGrid = this.injector.get(DatagridComponent, null);
        }
        if (!this.elRef) {
            this.elRef = this.injector.get(ElementRef, null);
        }
    };
    /**
     * @param {?} col
     * @param {?} rowData
     * @return {?}
     */
    FormatCellDataPipe.prototype.cellIsReadOnly = /**
     * @param {?} col
     * @param {?} rowData
     * @return {?}
     */
    function (col, rowData) {
        return this.dataGrid.cellIsReadOnly(col, rowData);
    };
    FormatCellDataPipe.decorators = [
        { type: Pipe, args: [{ name: 'formatCellData', pure: false },] }
    ];
    /** @nocollapse */
    FormatCellDataPipe.ctorParameters = function () { return [
        { type: ColumnFormatService },
        { type: Injector, decorators: [{ type: Optional }] }
    ]; };
    return FormatCellDataPipe;
}());
export { FormatCellDataPipe };
if (false) {
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.localeService;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.dataGrid;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.elRef;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.localeId;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.cfs;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWF0LWNlbGwtZGF0YS5waXBlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC8iLCJzb3VyY2VzIjpbImxpYi91dGlscy9mb3JtYXQtY2VsbC1kYXRhLnBpcGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzVELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsSUFBSSxFQUFpQixRQUFRLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0YsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNoQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUcvRDtJQU9JLDRCQUFvQixHQUF3QixFQUFzQixRQUFtQjtRQUFqRSxRQUFHLEdBQUgsR0FBRyxDQUFxQjtRQUFzQixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBRDdFLGFBQVEsR0FBRyxRQUFRLENBQUM7UUFFeEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNqRCxDQUFDOzs7Ozs7OztJQUVELHNDQUFTOzs7Ozs7O0lBQVQsVUFBVSxHQUFRLEVBQUUsT0FBWSxFQUFFLFdBQW1CLEVBQUUsTUFBYztRQUFuQyw0QkFBQSxFQUFBLG1CQUFtQjtRQUFFLHVCQUFBLEVBQUEsY0FBYztRQUNqRSxJQUFJLE9BQU8sSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRTs7Z0JBQ3ZCLEtBQUssR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDO1lBQ2hELElBQUksR0FBRyxDQUFDLE1BQU0sSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFD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LENBQUM7cUJBQ25EO2lCQUNKO2dCQUNELE9BQU8sS0FBSyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDckQ7WUFFRCxPQUFPLEdBQUcsQ0FBQztTQUNkO1FBRUQsT0FBTyxHQUFHLENBQUM7SUFDZixDQUFDOzs7OztJQUVPLGdEQUFtQjs7OztJQUEzQjtRQUNJLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2hCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDOUQ7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNiLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ3BEO0lBQ0wsQ0FBQzs7Ozs7O0lBRUQsMkNBQWM7Ozs7O0lBQWQsVUFBZSxHQUFlLEVBQUUsT0FBTztRQUNuQyxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUN0RCxDQUFDOztnQkFwTEosSUFBSSxTQUFDLEVBQUMsSUFBSSxFQUFFLGdCQUFnQixFQUFFLElBQUksRUFBRSxLQUFLLEVBQUM7Ozs7Z0JBSGxDLG1CQUFtQjtnQkFGRSxRQUFRLHVCQVlhLFFBQVE7O0lBOEszRCx5QkFBQztDQUFBLEFBckxELElBcUxDO1NBcExZLGtCQUFrQjs7Ozs7O0lBRTNCLDJDQUFxQzs7Ozs7SUFDckMsc0NBQW9DOzs7OztJQUNwQyxtQ0FBMEI7Ozs7O0lBQzFCLHNDQUE0Qjs7Ozs7SUFDaEIsaUNBQWdDOzs7OztJQUFFLHNDQUF1QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERhdGFncmlkQ29tcG9uZW50IH0gZnJvbSAnLi8uLi9kYXRhZ3JpZC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBMb2NhbGVTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1sb2NhbGUnO1xyXG5pbXBvcnQgeyBQaXBlLCBQaXBlVHJhbnNmb3JtLCBJbmplY3RvciwgT3B0aW9uYWwsIEVsZW1lbnRSZWYsIExPQ0FMRV9JRCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBVdGlscyB9IGZyb20gJy4vdXRpbHMnO1xyXG5pbXBvcnQgeyBDb2x1bW5Gb3JtYXRTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24vY29sdW1uJztcclxuaW1wb3J0IHsgRGF0YUNvbHVtbiB9IGZyb20gJy4uL3R5cGVzL2RhdGEtY29sdW1uJztcclxuXHJcbkBQaXBlKHtuYW1lOiAnZm9ybWF0Q2VsbERhdGEnLCBwdXJlOiBmYWxzZX0pXHJcbmV4cG9ydCBjbGFzcyBGb3JtYXRDZWxsRGF0YVBpcGUgaW1wbGVtZW50cyBQaXBlVHJhbnNmb3JtIHtcclxuXHJcbiAgICBwcml2YXRlIGxvY2FsZVNlcnZpY2U6IExvY2FsZVNlcnZpY2U7XHJcbiAgICBwcml2YXRlIGRhdGFHcmlkOiBEYXRhZ3JpZENvbXBvbmVudDtcclxuICAgIHByaXZhdGUgZWxSZWY6IEVsZW1lbnRSZWY7XHJcbiAgICBwcml2YXRlIGxvY2FsZUlkID0gJ1pILUNIUyc7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNmczogQ29sdW1uRm9ybWF0U2VydmljZSwgQE9wdGlvbmFsKCkgcHJpdmF0ZSBpbmplY3Rvcj86IEluamVjdG9yKSB7XHJcbiAgICAgICAgdGhpcy5sb2NhbGVJZCA9IHRoaXMuaW5qZWN0b3IuZ2V0KExPQ0FMRV9JRCk7XHJcbiAgICB9XHJcblxyXG4gICAgdHJhbnNmb3JtKGNvbDogYW55LCByb3dEYXRhOiBhbnksIGdyb3VwRm9vdGVyID0gZmFsc2UsIGZvb3RlciA9IGZhbHNlKTogYW55IHtcclxuICAgICAgICBpZiAocm93RGF0YSAmJiBjb2wgJiYgY29sLmZpZWxkKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gVXRpbHMuZ2V0VmFsdWUoY29sLmZpZWxkLCByb3dEYXRhKTtcclxuICAgICAgICAgICAgaWYgKGNvbC5lZGl0b3IgJiYgY29sLmVkaXRvci5vcHRpb25zICYmIGNvbC5lZGl0b3Iub3B0aW9ucy5pc1Bhc3N3b3JkICYmICFjb2wuZm9ybWF0dGVyKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gIHZhbHVlID8gJyoqKioqKicgOiAnJztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IGZvcm1hdHRlckZuID0gY29sLmZvcm1hdHRlcjtcclxuICAgICAgICAgICAgaWYgKGdyb3VwRm9vdGVyKSB7XHJcbiAgICAgICAgICAgICAgICBmb3JtYXR0ZXJGbiA9IGNvbC5ncm91cEZvb3RlciA/IGNvbC5ncm91cEZvb3Rlci5mb3JtYXR0ZXIgOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZm9vdGVyKSB7XHJcbiAgICAgICAgICAgICAgICBmb3JtYXR0ZXJGbiA9IGNvbC5mb290ZXIgPyBjb2wuZm9vdGVyLmZvcm1hdHRlciA6IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm9ybWF0dGVyRm4gPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFmb3JtYXR0ZXJGbi5vcHRpb25zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9wdHMgPSB7IHR5cGU6IGZvcm1hdHRlckZuLnR5cGUsIG9wdGlvbnM6IGZvcm1hdHRlckZuIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlckZuID0gb3B0cztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICghZm9ybWF0dGVyRm4pIHtcclxuICAgICAgICAgICAgICAgIGxldCByZXNvdWx0U3RyID0gdmFsdWU7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29sLmlzTXVsdGlsaW5ndWFsRmllbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXNvdWx0U3RyID0gdGhpcy5nZXRNdWx0aWxpbmd1YWxWYWx1ZSh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlICE9PSAnMCcgJiYgdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdldERhdGFncmlkSW5zdGFuY2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlLmluZGV4T2YoJ1xcbicpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJldHVybiB2YWx1ZS5yZXBsYWNlKC9cXG4vZywgJzxicj4nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhdGFHcmlkICYmIHRoaXMuZGF0YUdyaWQubm93cmFwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VsdFN0ciA9IHZhbHVlLnJlcGxhY2UoL1xcbi9nLCAnICcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEZvb3RlckNlbGxUaXRsZShyZXNvdWx0U3RyLCBmb290ZXIsIGNvbC5maWVsZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIHZhbHVlLnJlcGxhY2UoLyAvZywgJyZlbnNwOycpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0UGxhY2VIb2xkZXJXaGVuRW5hYmxlRWRpdENlbGxTdHlsZShjb2wsIHJlc291bHRTdHIsIHJvd0RhdGEsIGdyb3VwRm9vdGVyIHx8IGZvb3Rlcik7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZm9ybWF0dGVyRm4pIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIGZvcm1hdHRlckZuLnR5cGUgPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZm9ybWF0dGVyRm4ub3B0aW9ucyB8fCAhT2JqZWN0LmtleXMoZm9ybWF0dGVyRm4ub3B0aW9ucykubGVuZ3RoICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyRm4ub3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aG91c2FuZDogJywnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWNpc2lvbjogMlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoIGZvcm1hdHRlckZuLnR5cGUgPT09ICdkYXRldGltZScpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm1hdHRlckZuLm9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2wuZWRpdG9yICYmIGNvbC5lZGl0b3Iub3B0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgZGF0ZVJhbmdlLCBkYXRlUmFuZ2VEYXRlc0RlbGltaXRlciB9ID0gY29sLmVkaXRvci5vcHRpb25zO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlckZuLm9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHsgZGF0ZVJhbmdlLCBkYXRlUmFuZ2VEYXRlc0RlbGltaXRlciB9LCBmb3JtYXR0ZXJGbi5vcHRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm1hdHRlckZuLnR5cGUgPT09ICd0aW1lYWdvJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybWF0dGVyRm4ub3B0aW9ucyApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlckZuLm9wdGlvbnMubG9jYWxlID0gZm9ybWF0dGVyRm4ub3B0aW9ucy5sb2NhbGUgfHwgdGhpcy5sb2NhbGVJZDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlckZuLm9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxlOiB0aGlzLmxvY2FsZUlkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5nZXREYXRhZ3JpZEluc3RhbmNlKCk7XHJcbiAgICAgICAgICAgICAgICBsZXQgciA9ICcnO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZGF0YUdyaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICByID0gdGhpcy5jZnMuZm9ybWF0KHZhbHVlLCByb3dEYXRhLCBmb3JtYXR0ZXJGbiwgeyB1dGlsczogdGhpcy5kYXRhR3JpZC5jb21tb25VdGlscywgbG9jYWxlOiB0aGlzLmxvY2FsZUlkIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0Rm9vdGVyQ2VsbFRpdGxlKHIsIGZvb3RlciwgY29sLmZpZWxkKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zZXRQbGFjZUhvbGRlcldoZW5FbmFibGVFZGl0Q2VsbFN0eWxlKGNvbCwgciwgcm93RGF0YSwgZ3JvdXBGb290ZXIgfHwgZm9vdGVyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgciA9IHRoaXMuY2ZzLmZvcm1hdCh2YWx1ZSwgcm93RGF0YSwgZm9ybWF0dGVyRm4sIHtsb2NhbGU6IHRoaXMubG9jYWxlSWQgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRGb290ZXJDZWxsVGl0bGUociwgZm9vdGVyLCBjb2wuZmllbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZXRGb290ZXJDZWxsVGl0bGUodGV4dDogc3RyaW5nLCBpc0Zvb3RlcjogYm9vbGVhbiwgZmllbGQ6IHN0cmluZykge1xyXG4gICAgICAgIGlmICh0ZXh0ICYmIGlzRm9vdGVyICYmIHRoaXMuZWxSZWYpIHtcclxuICAgICAgICAgICAgY29uc3Qgc3BhbiA9IHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKGB0ZFtmaWVsZD1cIiR7ZmllbGR9XCJdIC5mLWRhdGFncmlkLWZvb3Rlci1jZWxsYCk7XHJcbiAgICAgICAgICAgIGlmIChzcGFuKSB7XHJcbiAgICAgICAgICAgICAgICBzcGFuLnRpdGxlID0gdGV4dDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyDojrflj5blpJror63mlbDmja5cclxuICAgIHByaXZhdGUgZ2V0TXVsdGlsaW5ndWFsVmFsdWUodmFsT2JqKSB7XHJcbiAgICAgICAgaWYgKHZhbE9iaiAmJiB0eXBlb2YgdmFsT2JqID09PSAnb2JqZWN0JyAmJiBPYmplY3Qua2V5cyh2YWxPYmopLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5qZWN0b3IpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9jYWxlU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KExvY2FsZVNlcnZpY2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmxvY2FsZVNlcnZpY2UpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxvY2FsZUlkID0gdGhpcy5sb2NhbGVTZXJ2aWNlLmxvY2FsZUlkO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFV0aWxzLmdldE11bHRpbGluZ3VhbFZhbHVlKHZhbE9iaiwgbG9jYWxlSWQpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbE9ialsnemgtQ0hTJ107XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIOWQr+eUqOagh+ivhuWPr+e8lui+keWNleWFg+agvOaXtu+8jOWGheWuueS4uuepuuaXtuiuvue9ruaPkOekuuivrVxyXG4gICAgcHJpdmF0ZSBzZXRQbGFjZUhvbGRlcldoZW5FbmFibGVFZGl0Q2VsbFN0eWxlKGNvbCwgdmFsLCByb3dEYXRhLCBpc0Zvb3Rlcikge1xyXG4gICAgICAgIHRoaXMuZ2V0RGF0YWdyaWRJbnN0YW5jZSgpO1xyXG4gICAgICAgIGlmICh0aGlzLmRhdGFHcmlkKSB7XHJcbiAgICAgICAgICAgIC8qXHJcbiAgICAgICAgICAgIGlmICghdGhpcy5kYXRhR3JpZC5lZGl0YWJsZSB8fCAodmFsICE9PSBudWxsICYmIHZhbCAhPT0gdW5kZWZpbmVkICYmIHZhbCAhPT0gJycpIHx8IGlzRm9vdGVyIHx8IHRoaXMuY2VsbElzUmVhZE9ubHkoY29sLCByb3dEYXRhKSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZWxSZWYpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGFuID0gdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5jZWxsLXRleHQtYm94Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNwYW4gJiYgc3Bhbi5jbGFzc05hbWUuaW5kZXhPZignY2VsbC1lbXB0eScpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3Bhbi5jbGFzc05hbWUgPSBzcGFuLmNsYXNzTmFtZS5yZXBsYWNlKCdjZWxsLWVtcHR5JywgJyAnKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbDtcclxuICAgICAgICAgICAgfVxyXG4qL1xyXG4gICAgICAgICAgICBpZiAodGhpcy5kYXRhR3JpZC5lbmFibGVFZGl0Q2VsbFN0eWxlICkge1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5kYXRhR3JpZC5lZGl0YWJsZSB8fCAodmFsICE9PSBudWxsICYmIHZhbCAhPT0gdW5kZWZpbmVkICYmIHZhbCAhPT0gJycpIHx8IGlzRm9vdGVyIHx8IHRoaXMuY2VsbElzUmVhZE9ubHkoY29sLCByb3dEYXRhKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsUmVmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwYW4gPSB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignLmNlbGwtdGV4dC1ib3gnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNwYW4gJiYgc3Bhbi5jbGFzc05hbWUuaW5kZXhPZignY2VsbC1lbXB0eScpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4uY2xhc3NOYW1lID0gc3Bhbi5jbGFzc05hbWUucmVwbGFjZSgnY2VsbC1lbXB0eScsICcgJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICBcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5lbFJlZikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwYW4gPSB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignLmNlbGwtdGV4dC1ib3gnKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3BhbiAmJiBzcGFuLmNsYXNzTmFtZS5pbmRleE9mKCdjZWxsLWVtcHR5JykgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4uY2xhc3NOYW1lID0gc3Bhbi5jbGFzc05hbWUgKyAnIGNlbGwtZW1wdHknO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBVdGlscy5nZXRXaGVuRW1wdHlUZXh0KGNvbCwgdGhpcy5sb2NhbGVJZCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiB2YWw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdmFsO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0RGF0YWdyaWRJbnN0YW5jZSgpIHtcclxuICAgICAgICBpZiAoIXRoaXMuZGF0YUdyaWQpIHtcclxuICAgICAgICAgICAgdGhpcy5kYXRhR3JpZCA9IHRoaXMuaW5qZWN0b3IuZ2V0KERhdGFncmlkQ29tcG9uZW50LCBudWxsKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5lbFJlZikge1xyXG4gICAgICAgICAgICB0aGlzLmVsUmVmID0gdGhpcy5pbmplY3Rvci5nZXQoRWxlbWVudFJlZiwgbnVsbCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNlbGxJc1JlYWRPbmx5KGNvbDogRGF0YUNvbHVtbiwgcm93RGF0YSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmRhdGFHcmlkLmNlbGxJc1JlYWRPbmx5KGNvbCwgcm93RGF0YSk7XHJcbiAgICB9XHJcbn1cclxuIl19