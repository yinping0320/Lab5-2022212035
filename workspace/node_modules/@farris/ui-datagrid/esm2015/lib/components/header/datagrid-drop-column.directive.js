/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, NgZone, Injector, Renderer2, ElementRef, Input } from '@angular/core';
import { dropHandlers, smoothDnD, constants } from '@farris/smooth-dnd';
import { DatagridComponent } from './../../datagrid.component';
import { DragDropColumnService } from './drag-drop-column.service';
smoothDnD.dropHandler = dropHandlers.reactDropHandler().handler;
smoothDnD.wrapChild = false;
const { wrapperClass, animationClass } = constants;
export class DropColumnDirective {
    /**
     * @param {?} ngzone
     * @param {?} injector
     * @param {?} render
     * @param {?} el
     * @param {?} dg
     * @param {?} dndSer
     */
    constructor(ngzone, injector, render, el, dg, dndSer) {
        this.ngzone = ngzone;
        this.injector = injector;
        this.render = render;
        this.el = el;
        this.dg = dg;
        this.dndSer = dndSer;
        this.options = {
            orientation: 'horizontal',
            behaviour: 'move',
            dragHandleSelector: '.group-field',
            dropPlaceholder: {
                className: 'drop-group-field',
            },
            getGhostParent: (/**
             * @return {?}
             */
            () => {
                return document.body;
            }),
            shouldAcceptDrop: (/**
             * @param {?} sourceContainerOptions
             * @param {?} payload
             * @return {?}
             */
            (sourceContainerOptions, payload) => {
                if (payload === undefined || payload === null) {
                    return false;
                }
                if (typeof payload === 'number') {
                    return true;
                }
                if (this.getGroupFields().length < 3) {
                    return payload.allowGrouping === undefined || payload.allowGrouping;
                }
                return false;
            }),
            getChildPayload: (/**
             * @param {?} index
             * @return {?}
             */
            (index) => {
                return index;
            }),
            // dragClass: 'drag-column-moving',
            onDropReady: (/**
             * @param {?} dropResult
             * @return {?}
             */
            (dropResult) => {
                this.ngzone.run((/**
                 * @return {?}
                 */
                () => {
                    this.onDropReady(dropResult);
                }));
            }),
            onDrop: (/**
             * @param {?} dropResult
             * @return {?}
             */
            (dropResult) => {
                this.ngzone.run((/**
                 * @return {?}
                 */
                () => {
                    this.onDrop(dropResult);
                }));
            }),
            onDragEnter: (/**
             * @return {?}
             */
            () => {
                this.ngzone.run((/**
                 * @return {?}
                 */
                () => {
                    this.onDragEnter();
                }));
            }),
            onDragStart: (/**
             * @param {?} info
             * @return {?}
             */
            (info) => {
                this.ngzone.run((/**
                 * @return {?}
                 */
                () => {
                    this.onDragStart(info);
                }));
            }),
            onDragEnd: (/**
             * @param {?} info
             * @return {?}
             */
            (info) => {
                this.ngzone.run((/**
                 * @return {?}
                 */
                () => {
                    this.onDragEnd(info);
                }));
            })
        };
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.initDnD();
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.disposeDnd();
    }
    /**
     * @private
     * @return {?}
     */
    disposeDnd() {
        if (this.container) {
            this.container.dispose();
            this.container = null;
        }
    }
    /**
     * @private
     * @return {?}
     */
    initDnD() {
        this.disposeDnd();
        if (this.dg.showRowGroupPanel) {
            this.container = smoothDnD(this.el.nativeElement, this.options);
        }
    }
    /**
     * @private
     * @param {?} dropResult
     * @return {?}
     */
    onDropReady(dropResult) {
    }
    /**
     * @private
     * @return {?}
     */
    getGroupFields() {
        return this.dg.groupField ? this.dg.groupField.split(',') : [];
    }
    /**
     * @private
     * @param {?} dropResult
     * @return {?}
     */
    onDrop(dropResult) {
        const { addedIndex, payload, removedIndex } = dropResult;
        if (addedIndex === null) {
            return;
        }
        /** @type {?} */
        const newGroupFields = this.getGroupFields();
        if (removedIndex === null) {
            if (!newGroupFields.some((/**
             * @param {?} v
             * @return {?}
             */
            (v) => v === payload.field))) {
                // newGroupFields.splice(0, 0, payload.field);
                newGroupFields.push(payload.field);
            }
        }
        else {
            this.dndSer.moveItem(newGroupFields, addedIndex, removedIndex);
        }
        this.dg.groupField = newGroupFields.join(',');
        // this.dg.toggleVisibleColumn([this.dg.groupField], false);
        if (this.dg.useControlPanel && this.dg.settingService) {
            this.dg.checkSettingHttp();
            this.dg.settingService.saveUserConfig(this.dg.id).subscribe((/**
             * @return {?}
             */
            () => {
                this.dg.columnsChanged();
            }));
        }
        else {
            this.dg.columnsChanged();
        }
        this.dg.groupFieldChange.emit({ newGroupField: this.dg.groupField, grid: this.dg });
    }
    /**
     * @private
     * @param {?} info
     * @return {?}
     */
    onDragStart(info) {
    }
    /**
     * @private
     * @param {?} info
     * @return {?}
     */
    onDragEnd(info) {
    }
    /**
     * @private
     * @return {?}
     */
    onDragEnter() {
    }
}
DropColumnDirective.decorators = [
    { type: Directive, args: [{
                selector: '[drop-column]',
                providers: [
                    DragDropColumnService
                ]
            },] }
];
/** @nocollapse */
DropColumnDirective.ctorParameters = () => [
    { type: NgZone },
    { type: Injector },
    { type: Renderer2 },
    { type: ElementRef },
    { type: DatagridComponent },
    { type: DragDropColumnService }
];
DropColumnDirective.propDecorators = {
    options: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    DropColumnDirective.prototype.options;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.container;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.ngzone;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.dg;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.dndSer;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtZHJvcC1jb2x1bW4uZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2hlYWRlci9kYXRhZ3JpZC1kcm9wLWNvbHVtbi5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFpQixLQUFLLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDcEgsT0FBTyxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQWdDLFNBQVMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3RHLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRS9ELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBR25FLFNBQVMsQ0FBQyxXQUFXLEdBQUcsWUFBWSxDQUFDLGdCQUFnQixFQUFFLENBQUMsT0FBTyxDQUFDO0FBQ2hFLFNBQVMsQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO01BQ3RCLEVBQUUsWUFBWSxFQUFFLGNBQWMsRUFBRSxHQUFHLFNBQVM7QUFRbEQsTUFBTSxPQUFPLG1CQUFtQjs7Ozs7Ozs7O0lBd0Q1QixZQUFvQixNQUFjLEVBQVUsUUFBa0IsRUFBVSxNQUFpQixFQUFVLEVBQWMsRUFDN0YsRUFBcUIsRUFBVSxNQUE2QjtRQUQ1RCxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLFdBQU0sR0FBTixNQUFNLENBQVc7UUFBVSxPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQzdGLE9BQUUsR0FBRixFQUFFLENBQW1CO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBdUI7UUF4RHZFLFlBQU8sR0FBcUI7WUFDakMsV0FBVyxFQUFFLFlBQVk7WUFDekIsU0FBUyxFQUFFLE1BQU07WUFD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QUFDLEVBQUUsQ0FBQyxjQUFjLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUzs7O1lBQUUsR0FBRyxFQUFFO2dCQUM5RCxJQUFJLENBQUMsRUFBRSxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQzdCLENBQUMsRUFBQyxDQUFDO1NBQ047YUFBTTtZQUNILElBQUksQ0FBQyxFQUFFLENBQUMsY0FBYyxFQUFFLENBQUM7U0FDNUI7UUFFRCxJQUFJLENBQUMsRUFBRSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxFQUFFLGFBQWEsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDeEYsQ0FBQzs7Ozs7O0lBRU8sV0FBVyxDQUFDLElBQUk7SUFDeEIsQ0FBQzs7Ozs7O0lBRU8sU0FBUyxDQUFDLElBQUk7SUFDdEIsQ0FBQzs7Ozs7SUFHTyxXQUFXO0lBQ25CLENBQUM7OztZQTFJSixTQUFTLFNBQUM7Z0JBQ1AsUUFBUSxFQUFFLGVBQWU7Z0JBQ3pCLFNBQVMsRUFBRTtvQkFDUCxxQkFBcUI7aUJBQ3hCO2FBQ0o7Ozs7WUFoQm1CLE1BQU07WUFBRSxRQUFRO1lBQUUsU0FBUztZQUFFLFVBQVU7WUFFbEQsaUJBQWlCO1lBRWpCLHFCQUFxQjs7O3NCQWN6QixLQUFLOzs7O0lBQU4sc0NBb0RFOzs7OztJQUVGLHdDQUF1Qjs7Ozs7SUFDWCxxQ0FBc0I7Ozs7O0lBQUUsdUNBQTBCOzs7OztJQUFFLHFDQUF5Qjs7Ozs7SUFBRSxpQ0FBc0I7Ozs7O0lBQ3JHLGlDQUE2Qjs7Ozs7SUFBRSxxQ0FBcUMiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuaW1wb3J0IHsgRGlyZWN0aXZlLCBOZ1pvbmUsIEluamVjdG9yLCBSZW5kZXJlcjIsIEVsZW1lbnRSZWYsIEFmdGVyVmlld0luaXQsIElucHV0LCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgZHJvcEhhbmRsZXJzLCBzbW9vdGhEbkQsIERyb3BSZXN1bHQsIENvbnRhaW5lck9wdGlvbnMsIGNvbnN0YW50cyB9IGZyb20gJ0BmYXJyaXMvc21vb3RoLWRuZCc7XHJcbmltcG9ydCB7IERhdGFncmlkQ29tcG9uZW50IH0gZnJvbSAnLi8uLi8uLi9kYXRhZ3JpZC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBEcmFnU3RhcnRFbmRJbmZvIH0gZnJvbSAnLi9kYXRhZ3JpZC1kcmFnLWNvbHVtbi5kaXJlY3RpdmUnO1xyXG5pbXBvcnQgeyBEcmFnRHJvcENvbHVtblNlcnZpY2UgfSBmcm9tICcuL2RyYWctZHJvcC1jb2x1bW4uc2VydmljZSc7XHJcblxyXG5cclxuc21vb3RoRG5ELmRyb3BIYW5kbGVyID0gZHJvcEhhbmRsZXJzLnJlYWN0RHJvcEhhbmRsZXIoKS5oYW5kbGVyO1xyXG5zbW9vdGhEbkQud3JhcENoaWxkID0gZmFsc2U7XHJcbmNvbnN0IHsgd3JhcHBlckNsYXNzLCBhbmltYXRpb25DbGFzcyB9ID0gY29uc3RhbnRzO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogJ1tkcm9wLWNvbHVtbl0nLFxyXG4gICAgcHJvdmlkZXJzOiBbXHJcbiAgICAgICAgRHJhZ0Ryb3BDb2x1bW5TZXJ2aWNlXHJcbiAgICBdXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBEcm9wQ29sdW1uRGlyZWN0aXZlIGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95IHtcclxuICAgIEBJbnB1dCgpIG9wdGlvbnM6IENvbnRhaW5lck9wdGlvbnMgPSB7XHJcbiAgICAgICAgb3JpZW50YXRpb246ICdob3Jpem9udGFsJyxcclxuICAgICAgICBiZWhhdmlvdXI6ICdtb3ZlJyxcclxuICAgICAgICBkcmFnSGFuZGxlU2VsZWN0b3I6ICcuZ3JvdXAtZmllbGQnLFxyXG4gICAgICAgIGRyb3BQbGFjZWhvbGRlcjoge1xyXG4gICAgICAgICAgICBjbGFzc05hbWU6ICdkcm9wLWdyb3VwLWZpZWxkJyxcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldEdob3N0UGFyZW50OiAoKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5ib2R5O1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2hvdWxkQWNjZXB0RHJvcDogKHNvdXJjZUNvbnRhaW5lck9wdGlvbnMsIHBheWxvYWQpID0+IHtcclxuICAgICAgICAgICAgaWYocGF5bG9hZCA9PT0gdW5kZWZpbmVkIHx8IHBheWxvYWQgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHBheWxvYWQgPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuZ2V0R3JvdXBGaWVsZHMoKS5sZW5ndGggPCAzKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcGF5bG9hZC5hbGxvd0dyb3VwaW5nID09PSB1bmRlZmluZWQgfHwgcGF5bG9hZC5hbGxvd0dyb3VwaW5nO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldENoaWxkUGF5bG9hZDogKGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBpbmRleDtcclxuICAgICAgICB9LFxyXG4gICAgICAgIC8vIGRyYWdDbGFzczogJ2RyYWctY29sdW1uLW1vdmluZycsXHJcbiAgICAgICAgb25Ecm9wUmVhZHk6IChkcm9wUmVzdWx0OiBEcm9wUmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubmd6b25lLnJ1bigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9uRHJvcFJlYWR5KGRyb3BSZXN1bHQpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG9uRHJvcDogKGRyb3BSZXN1bHQ6IERyb3BSZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5uZ3pvbmUucnVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMub25Ecm9wKGRyb3BSZXN1bHQpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG9uRHJhZ0VudGVyOiAoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubmd6b25lLnJ1bigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9uRHJhZ0VudGVyKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgb25EcmFnU3RhcnQ6IChpbmZvOiBEcmFnU3RhcnRFbmRJbmZvKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubmd6b25lLnJ1bigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9uRHJhZ1N0YXJ0KGluZm8pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG9uRHJhZ0VuZDogKGluZm86IERyYWdTdGFydEVuZEluZm8pID0+IHtcclxuICAgICAgICAgICAgdGhpcy5uZ3pvbmUucnVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMub25EcmFnRW5kKGluZm8pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIHByaXZhdGUgY29udGFpbmVyOiBhbnk7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5nem9uZTogTmdab25lLCBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSByZW5kZXI6IFJlbmRlcmVyMiwgcHJpdmF0ZSBlbDogRWxlbWVudFJlZixcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgZGc6IERhdGFncmlkQ29tcG9uZW50LCBwcml2YXRlIGRuZFNlcjogRHJhZ0Ryb3BDb2x1bW5TZXJ2aWNlKSB7IH1cclxuXHJcbiAgICBuZ0FmdGVyVmlld0luaXQoKSB7XHJcbiAgICAgICAgdGhpcy5pbml0RG5EKCk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NlRG5kKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBkaXNwb3NlRG5kKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmNvbnRhaW5lcikge1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5kaXNwb3NlKCk7XHJcbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0RG5EKCkge1xyXG4gICAgICAgIHRoaXMuZGlzcG9zZURuZCgpO1xyXG4gICAgICAgIGlmICh0aGlzLmRnLnNob3dSb3dHcm91cFBhbmVsKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gc21vb3RoRG5EKFxyXG4gICAgICAgICAgICAgICAgdGhpcy5lbC5uYXRpdmVFbGVtZW50LFxyXG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgb25Ecm9wUmVhZHkoZHJvcFJlc3VsdCkge1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0R3JvdXBGaWVsZHMoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZGcuZ3JvdXBGaWVsZCA/IHRoaXMuZGcuZ3JvdXBGaWVsZC5zcGxpdCgnLCcpIDogW107XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgb25Ecm9wKGRyb3BSZXN1bHQ6IERyb3BSZXN1bHQpIHtcclxuICAgICAgICBjb25zdCB7IGFkZGVkSW5kZXgsIHBheWxvYWQsIHJlbW92ZWRJbmRleCB9ID0gZHJvcFJlc3VsdDtcclxuXHJcbiAgICAgICAgaWYgKGFkZGVkSW5kZXggPT09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgbmV3R3JvdXBGaWVsZHMgPSB0aGlzLmdldEdyb3VwRmllbGRzKCk7XHJcblxyXG4gICAgICAgIGlmIChyZW1vdmVkSW5kZXggPT09IG51bGwpIHtcclxuICAgICAgICAgICAgaWYgKCFuZXdHcm91cEZpZWxkcy5zb21lKCh2KSA9PiB2ID09PSBwYXlsb2FkLmZpZWxkKSkge1xyXG4gICAgICAgICAgICAgICAgLy8gbmV3R3JvdXBGaWVsZHMuc3BsaWNlKDAsIDAsIHBheWxvYWQuZmllbGQpO1xyXG4gICAgICAgICAgICAgICAgbmV3R3JvdXBGaWVsZHMucHVzaChwYXlsb2FkLmZpZWxkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZG5kU2VyLm1vdmVJdGVtKG5ld0dyb3VwRmllbGRzLCBhZGRlZEluZGV4LCByZW1vdmVkSW5kZXgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmRnLmdyb3VwRmllbGQgPSBuZXdHcm91cEZpZWxkcy5qb2luKCcsJyk7XHJcbiAgICAgICAgLy8gdGhpcy5kZy50b2dnbGVWaXNpYmxlQ29sdW1uKFt0aGlzLmRnLmdyb3VwRmllbGRdLCBmYWxzZSk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmRnLnVzZUNvbnRyb2xQYW5lbCAmJiB0aGlzLmRnLnNldHRpbmdTZXJ2aWNlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGcuY2hlY2tTZXR0aW5nSHR0cCgpO1xyXG4gICAgICAgICAgICB0aGlzLmRnLnNldHRpbmdTZXJ2aWNlLnNhdmVVc2VyQ29uZmlnKHRoaXMuZGcuaWQpLnN1YnNjcmliZSggKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZy5jb2x1bW5zQ2hhbmdlZCgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmRnLmNvbHVtbnNDaGFuZ2VkKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmRnLmdyb3VwRmllbGRDaGFuZ2UuZW1pdCh7IG5ld0dyb3VwRmllbGQ6IHRoaXMuZGcuZ3JvdXBGaWVsZCwgZ3JpZDogdGhpcy5kZyB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIG9uRHJhZ1N0YXJ0KGluZm8pIHtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIG9uRHJhZ0VuZChpbmZvKSB7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgb25EcmFnRW50ZXIoKSB7XHJcbiAgICB9XHJcbn1cclxuIl19