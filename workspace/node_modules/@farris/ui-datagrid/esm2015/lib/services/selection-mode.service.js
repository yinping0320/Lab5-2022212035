/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { DatagridComponent } from './../datagrid.component';
import { Injectable } from '@angular/core';
import { delay } from 'rxjs/operators';
import { of } from 'rxjs';
export class SelectionModeService {
    /**
     * @param {?} grid
     */
    constructor(grid) {
        this.dgRef = null;
        this.oldSettings = null;
        this.selectStartEvent = null;
        this.events = null;
        this.dgRef = grid;
        if (this.dgRef.selectionMode === 'default') {
            grid.zone.runOutsideAngular((/**
             * @return {?}
             */
            () => {
                this.removeEvents();
                this.events = this.registerStopSelectionEvent();
            }));
        }
    }
    /**
     * @return {?}
     */
    destroy() {
        this.dgRef = null;
        this.removeEvents();
    }
    /**
     * @return {?}
     */
    removeEvents() {
        if (this.events && this.events.length) {
            this.events.forEach((/**
             * @param {?} e
             * @return {?}
             */
            e => {
                e();
            }));
            this.events = null;
        }
    }
    /**
     * @return {?}
     */
    toggleMode() {
        if (this.dgRef) {
            if (this.dgRef.selectionMode === 'default') {
                this.enableWindowsSelectionMode();
            }
            else {
                this.restoreSettings();
            }
        }
    }
    /**
     * @return {?}
     */
    enableWindowsSelectionMode() {
        if (this.dgRef) {
            this.oldSettings = {
                showCheckbox: this.dgRef.showCheckbox,
                keepSelect: this.dgRef.keepSelect,
                onlySelectSelf: this.dgRef.onlySelectSelf,
                selectOnCheck: this.dgRef.selectOnCheck,
                checkOnSelect: this.dgRef.checkOnSelect
            };
            this.dgRef.showCheckbox = true;
            this.dgRef.keepSelect = true;
            this.dgRef.onlySelectSelf = false;
            this.dgRef.selectOnCheck = true;
            this.dgRef.checkOnSelect = true;
            this.dgRef.dfs.updateProperty('keepSelect', true);
            this.dgRef.dfs.updateProperty('onlySelectSelf', false);
            this.dgRef.dfs.updateProperty('selectOnCheck', true);
            this.dgRef.dfs.updateProperty('checkOnSelect', true);
        }
    }
    /**
     * @return {?}
     */
    restoreSettings() {
        if (this.dgRef && this.oldSettings) {
            this.dgRef.showCheckbox = this.oldSettings.showCheckbox;
            this.dgRef.keepSelect = this.oldSettings.keepSelect;
            this.dgRef.onlySelectSelf = this.oldSettings.onlySelectSelf;
            this.dgRef.selectOnCheck = this.oldSettings.selectOnCheck;
            this.dgRef.checkOnSelect = this.oldSettings.checkOnSelect;
            this.dgRef.dfs.updateProperty('keepSelect', this.oldSettings.keepSelect);
            this.dgRef.dfs.updateProperty('onlySelectSelf', this.oldSettings.onlySelectSelf);
            this.dgRef.dfs.updateProperty('selectOnCheck', this.oldSettings.selectOnCheck);
            this.dgRef.dfs.updateProperty('checkOnSelect', this.oldSettings.checkOnSelect);
        }
    }
    /**
     * @private
     * @return {?}
     */
    registerStopSelectionEvent() {
        /** @type {?} */
        const kd = this.dgRef.render2.listen(document, 'keydown', (/**
         * @param {?} event
         * @return {?}
         */
        (event) => {
            if (event.ctrlKey || event.shiftKey) {
                this.unselectable();
            }
        }));
        /** @type {?} */
        const ku = this.dgRef.render2.listen(document, 'keyup', (/**
         * @param {?} event
         * @return {?}
         */
        (event) => {
            if (event.ctrlKey || event.shiftKey || event.keyCode === 17 || event.keyCode === 16) {
                this.enableSelectable();
            }
        }));
        return [kd, ku];
    }
    /**
     * @private
     * @return {?}
     */
    unselectable() {
        this.dgRef.render2.setAttribute(this.dgRef.dgContainer.nativeElement, 'unselectable', 'on');
        this.dgRef.render2.setAttribute(this.dgRef.dgContainer.nativeElement, 'onselectstart', 'return false');
        this.dgRef.render2.setStyle(this.dgRef.dgContainer.nativeElement, '-moz-user-select', 'none');
    }
    /**
     * @private
     * @return {?}
     */
    enableSelectable() {
        this.dgRef.render2.removeAttribute(this.dgRef.dgContainer.nativeElement, 'unselectable');
        this.dgRef.render2.removeAttribute(this.dgRef.dgContainer.nativeElement, 'onselectstart');
        this.dgRef.render2.removeStyle(this.dgRef.dgContainer.nativeElement, '-moz-user-select');
    }
    /**
     * @param {?} param
     * @return {?}
     */
    beforRowClick(param) {
        if (this.dgRef && this.dgRef.selectionMode === 'default') {
            /** @type {?} */
            const isSelected = this.dgRef.dfs.isRowSelected(param.id);
            /** @type {?} */
            const isCtrlKey = param.e.ctrlKey;
            /** @type {?} */
            const isShiftKey = param.e.shiftKey;
            this.dgRef.endEditing();
            if (!isCtrlKey && !isShiftKey) {
                if (!isSelected) {
                    this.dgRef.clearCheckeds();
                }
                else {
                    // 如果有多条选，移除其他选中行
                    /** @type {?} */
                    const currentPagerIds = this.dgRef.getRows().map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => n.id));
                    /** @type {?} */
                    const unCheckIDs = this.dgRef.checkValues.filter((/**
                     * @param {?} i
                     * @return {?}
                     */
                    i => currentPagerIds.includes(i) && i != param.id));
                    /** @type {?} */
                    const unSelectIds = this.dgRef.checkValues.filter((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => !currentPagerIds.includes(n)));
                    // const unCheckIDs = this.dgRef.checkValues.filter(n => n != param.id);
                    if (unCheckIDs && unCheckIDs.length) {
                        this.dgRef.unCheckRows(unCheckIDs, true);
                        this.dgRef.clearSelections([param.id, ...unSelectIds]);
                    }
                }
            }
            else {
                if (isShiftKey) {
                    /** @type {?} */
                    let focusIndex = this.dgRef.focusRowIndex;
                    if (focusIndex === -1) {
                        focusIndex = 0;
                    }
                    /** @type {?} */
                    const endIndex = param.rowIndex;
                    /** @type {?} */
                    let start = focusIndex;
                    /** @type {?} */
                    let end = endIndex;
                    if (focusIndex > endIndex) {
                        start = endIndex;
                        end = focusIndex;
                    }
                    /** @type {?} */
                    const data = this.dgRef.getRows();
                    /** @type {?} */
                    const checkedItems = [...data].splice(start, end - start + 1);
                    /** @type {?} */
                    const willCheckIds = checkedItems.map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => {
                        return this.dgRef.dfs.primaryId(n);
                    }));
                    if (!isCtrlKey) {
                        this.dgRef.clearCheckeds(false, false);
                    }
                    // this.dgRef.selectValues = willCheckIds;
                    this.dgRef.checkRows(willCheckIds, true);
                    return true;
                }
            }
            if (isSelected && isCtrlKey) {
                param.e.stopPropagation();
                // 执行取消选择
                this.dgRef.unCheckRow(param.id);
                return true;
            }
            /** @type {?} */
            const zoneClick = param.cellref ? param.cellref['zoneClick'] : '';
            /** @type {?} */
            const _timer = zoneClick && zoneClick.length ? 100 : 0;
            /** @type {?} */
            let r$ = of(true);
            if (this.dgRef.beforeSelect) {
                /** @type {?} */
                const r = this.dgRef.beforeSelect(param);
                if (r && r.subscribe) {
                    r$ = r;
                }
            }
            r$.pipe(delay(_timer)).subscribe((/**
             * @param {?} canSelect
             * @return {?}
             */
            (canSelect) => {
                if (canSelect) {
                    this.dgRef.dfs.selectRow(param.rowIndex, param.rowData);
                    if (this.dgRef.selectedRow) {
                        this.dgRef.selectedRow.dr = param.dr;
                    }
                }
                this.dgRef.rowClick.emit({ data: param.rowData, grid: this.dgRef, dblclick: false });
                this.dgRef.dgs.setSelecedRow.emit({ selected: true, id: this.dgRef.dfs.primaryId(param.rowData) });
                if (_timer) {
                    if (param.cellref && param.cellref.runZoneClick) {
                        param.cellref.runZoneClick(param.e);
                    }
                }
            }));
            return true;
        }
        return false;
    }
    /**
     * @return {?}
     */
    endRowClick() {
        if (this.dgRef && this.dgRef.selectionMode === 'default') {
            this.dgRef.checkOnSelect = false;
        }
    }
}
SelectionModeService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
SelectionModeService.ctorParameters = () => [
    { type: DatagridComponent }
];
if (false) {
    /** @type {?} */
    SelectionModeService.prototype.dgRef;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.oldSettings;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.selectStartEvent;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.events;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0aW9uLW1vZGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0YWdyaWQvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvc2VsZWN0aW9uLW1vZGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDNUQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkMsT0FBTyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUd0QyxNQUFNLE9BQU8sb0JBQW9COzs7O0lBSzdCLFlBQVksSUFBdUI7UUFKbkMsVUFBSyxHQUFzQixJQUFJLENBQUM7UUFDeEIsZ0JBQVcsR0FBUSxJQUFJLENBQUM7UUFDeEIscUJBQWdCLEdBQVEsSUFBSSxDQUFDO1FBQzdCLFdBQU0sR0FBRyxJQUFJLENBQUM7UUFFbEIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDbEIsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsS0FBSyxTQUFTLEVBQUU7WUFDeEMsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUI7OztZQUFDLEdBQUcsRUFBRTtnQkFDN0IsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO2dCQUNwQixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQywwQkFBMEIsRUFBRSxDQUFDO1lBQ3BELENBQUMsRUFBQyxDQUFDO1NBQ047SUFDTCxDQUFDOzs7O0lBRUQsT0FBTztRQUNILElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUN4QixDQUFDOzs7O0lBRUQsWUFBWTtRQUNSLElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFD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QyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO3FCQUN2QztpQkFDSjtZQUNMLENBQUMsRUFBQyxDQUFDO1lBRUgsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Ozs7SUFFRCxXQUFXO1FBQ1AsSUFBSSxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxLQUFLLFNBQVMsRUFBRTtZQUN0RCxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUM7U0FDcEM7SUFDTCxDQUFDOzs7WUE1TUosVUFBVTs7OztZQUxGLGlCQUFpQjs7OztJQU90QixxQ0FBZ0M7Ozs7O0lBQ2hDLDJDQUFnQzs7Ozs7SUFDaEMsZ0RBQXFDOzs7OztJQUNyQyxzQ0FBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEYXRhZ3JpZENvbXBvbmVudCB9IGZyb20gJy4vLi4vZGF0YWdyaWQuY29tcG9uZW50JztcclxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBkZWxheSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFNlbGVjdGlvbk1vZGVTZXJ2aWNlIHtcclxuICAgIGRnUmVmOiBEYXRhZ3JpZENvbXBvbmVudCA9IG51bGw7XHJcbiAgICBwcml2YXRlIG9sZFNldHRpbmdzOiBhbnkgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBzZWxlY3RTdGFydEV2ZW50OiBhbnkgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBldmVudHMgPSBudWxsO1xyXG4gICAgY29uc3RydWN0b3IoZ3JpZDogRGF0YWdyaWRDb21wb25lbnQpIHtcclxuICAgICAgICB0aGlzLmRnUmVmID0gZ3JpZDtcclxuICAgICAgICBpZiAodGhpcy5kZ1JlZi5zZWxlY3Rpb25Nb2RlID09PSAnZGVmYXVsdCcpIHtcclxuICAgICAgICAgICAgZ3JpZC56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlRXZlbnRzKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50cyA9IHRoaXMucmVnaXN0ZXJTdG9wU2VsZWN0aW9uRXZlbnQoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGRlc3Ryb3koKSB7XHJcbiAgICAgICAgdGhpcy5kZ1JlZiA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5yZW1vdmVFdmVudHMoKTtcclxuICAgIH1cclxuXHJcbiAgICByZW1vdmVFdmVudHMoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZXZlbnRzICYmIHRoaXMuZXZlbnRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICB0aGlzLmV2ZW50cy5mb3JFYWNoKGUgPT4ge1xyXG4gICAgICAgICAgICAgICAgZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZXZlbnRzID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHRvZ2dsZU1vZGUoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZGdSZWYpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZGdSZWYuc2VsZWN0aW9uTW9kZSA9PT0gJ2RlZmF1bHQnKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVuYWJsZVdpbmRvd3NTZWxlY3Rpb25Nb2RlKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlc3RvcmVTZXR0aW5ncygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBlbmFibGVXaW5kb3dzU2VsZWN0aW9uTW9kZSgpIHtcclxuICAgICAgICBpZiAodGhpcy5kZ1JlZikge1xyXG4gICAgICAgICAgICB0aGlzLm9sZFNldHRpbmdzID0ge1xyXG4gICAgICAgICAgICAgICAgc2hvd0NoZWNrYm94OiB0aGlzLmRnUmVmLnNob3dDaGVja2JveCxcclxuICAgICAgICAgICAgICAgIGtlZXBTZWxlY3Q6IHRoaXMuZGdSZWYua2VlcFNlbGVjdCxcclxuICAgICAgICAgICAgICAgIG9ubHlTZWxlY3RTZWxmOiB0aGlzLmRnUmVmLm9ubHlTZWxlY3RTZWxmLFxyXG4gICAgICAgICAgICAgICAgc2VsZWN0T25DaGVjazogdGhpcy5kZ1JlZi5zZWxlY3RPbkNoZWNrLFxyXG4gICAgICAgICAgICAgICAgY2hlY2tPblNlbGVjdDogdGhpcy5kZ1JlZi5jaGVja09uU2VsZWN0XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLnNob3dDaGVja2JveCA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYua2VlcFNlbGVjdCA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYub25seVNlbGVjdFNlbGYgPSBmYWxzZTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5zZWxlY3RPbkNoZWNrID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5jaGVja09uU2VsZWN0ID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnVwZGF0ZVByb3BlcnR5KCdrZWVwU2VsZWN0JywgdHJ1ZSk7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnVwZGF0ZVByb3BlcnR5KCdvbmx5U2VsZWN0U2VsZicsIGZhbHNlKTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMudXBkYXRlUHJvcGVydHkoJ3NlbGVjdE9uQ2hlY2snLCB0cnVlKTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMudXBkYXRlUHJvcGVydHkoJ2NoZWNrT25TZWxlY3QnLCB0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHJlc3RvcmVTZXR0aW5ncygpIHtcclxuICAgICAgICBpZiAodGhpcy5kZ1JlZiAmJiB0aGlzLm9sZFNldHRpbmdzKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuc2hvd0NoZWNrYm94ID0gdGhpcy5vbGRTZXR0aW5ncy5zaG93Q2hlY2tib3g7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYua2VlcFNlbGVjdCA9IHRoaXMub2xkU2V0dGluZ3Mua2VlcFNlbGVjdDtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5vbmx5U2VsZWN0U2VsZiA9IHRoaXMub2xkU2V0dGluZ3Mub25seVNlbGVjdFNlbGY7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuc2VsZWN0T25DaGVjayA9IHRoaXMub2xkU2V0dGluZ3Muc2VsZWN0T25DaGVjaztcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5jaGVja09uU2VsZWN0ID0gdGhpcy5vbGRTZXR0aW5ncy5jaGVja09uU2VsZWN0O1xyXG5cclxuXHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnVwZGF0ZVByb3BlcnR5KCdrZWVwU2VsZWN0JywgdGhpcy5vbGRTZXR0aW5ncy5rZWVwU2VsZWN0KTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMudXBkYXRlUHJvcGVydHkoJ29ubHlTZWxlY3RTZWxmJywgdGhpcy5vbGRTZXR0aW5ncy5vbmx5U2VsZWN0U2VsZik7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnVwZGF0ZVByb3BlcnR5KCdzZWxlY3RPbkNoZWNrJywgdGhpcy5vbGRTZXR0aW5ncy5zZWxlY3RPbkNoZWNrKTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMudXBkYXRlUHJvcGVydHkoJ2NoZWNrT25TZWxlY3QnLCB0aGlzLm9sZFNldHRpbmdzLmNoZWNrT25TZWxlY3QpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSByZWdpc3RlclN0b3BTZWxlY3Rpb25FdmVudCgpIHtcclxuICAgICAgICBjb25zdCBrZCA9IHRoaXMuZGdSZWYucmVuZGVyMi5saXN0ZW4oZG9jdW1lbnQsICdrZXlkb3duJywgKGV2ZW50OiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQuc2hpZnRLZXkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudW5zZWxlY3RhYmxlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3Qga3UgPSB0aGlzLmRnUmVmLnJlbmRlcjIubGlzdGVuKGRvY3VtZW50LCAna2V5dXAnLCAoZXZlbnQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXZlbnQuY3RybEtleSB8fCBldmVudC5zaGlmdEtleSB8fCBldmVudC5rZXlDb2RlID09PSAxNyB8fCBldmVudC5rZXlDb2RlID09PSAxNikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbmFibGVTZWxlY3RhYmxlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIFsga2QsIGt1XTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHVuc2VsZWN0YWJsZSgpIHtcclxuICAgICAgICB0aGlzLmRnUmVmLnJlbmRlcjIuc2V0QXR0cmlidXRlKHRoaXMuZGdSZWYuZGdDb250YWluZXIubmF0aXZlRWxlbWVudCwgJ3Vuc2VsZWN0YWJsZScsICdvbicpO1xyXG4gICAgICAgIHRoaXMuZGdSZWYucmVuZGVyMi5zZXRBdHRyaWJ1dGUodGhpcy5kZ1JlZi5kZ0NvbnRhaW5lci5uYXRpdmVFbGVtZW50LCAnb25zZWxlY3RzdGFydCcsICdyZXR1cm4gZmFsc2UnKTtcclxuICAgICAgICB0aGlzLmRnUmVmLnJlbmRlcjIuc2V0U3R5bGUodGhpcy5kZ1JlZi5kZ0NvbnRhaW5lci5uYXRpdmVFbGVtZW50LCAnLW1vei11c2VyLXNlbGVjdCcsICdub25lJyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBlbmFibGVTZWxlY3RhYmxlKCkge1xyXG4gICAgICAgIHRoaXMuZGdSZWYucmVuZGVyMi5yZW1vdmVBdHRyaWJ1dGUodGhpcy5kZ1JlZi5kZ0NvbnRhaW5lci5uYXRpdmVFbGVtZW50LCAndW5zZWxlY3RhYmxlJyk7XHJcbiAgICAgICAgdGhpcy5kZ1JlZi5yZW5kZXIyLnJlbW92ZUF0dHJpYnV0ZSh0aGlzLmRnUmVmLmRnQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICdvbnNlbGVjdHN0YXJ0Jyk7XHJcbiAgICAgICAgdGhpcy5kZ1JlZi5yZW5kZXIyLnJlbW92ZVN0eWxlKHRoaXMuZGdSZWYuZGdDb250YWluZXIubmF0aXZlRWxlbWVudCwgJy1tb3otdXNlci1zZWxlY3QnKTtcclxuICAgIH1cclxuXHJcbiAgICBiZWZvclJvd0NsaWNrKHBhcmFtOiBhbnkpIHtcclxuICAgICAgICBpZiAodGhpcy5kZ1JlZiAmJiB0aGlzLmRnUmVmLnNlbGVjdGlvbk1vZGUgPT09ICdkZWZhdWx0Jykge1xyXG4gICAgICAgICAgICBjb25zdCBpc1NlbGVjdGVkID0gdGhpcy5kZ1JlZi5kZnMuaXNSb3dTZWxlY3RlZChwYXJhbS5pZCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzQ3RybEtleSA9IHBhcmFtLmUuY3RybEtleTtcclxuICAgICAgICAgICAgY29uc3QgaXNTaGlmdEtleSA9IHBhcmFtLmUuc2hpZnRLZXk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmVuZEVkaXRpbmcoKTtcclxuXHJcbiAgICAgICAgICAgIGlmICghaXNDdHJsS2V5ICYmICFpc1NoaWZ0S2V5KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWlzU2VsZWN0ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLmNsZWFyQ2hlY2tlZHMoKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5aaC5p6c5pyJ5aSa5p2h6YCJ77yM56e76Zmk5YW25LuW6YCJ5Lit6KGMXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFBhZ2VySWRzID0gdGhpcy5kZ1JlZi5nZXRSb3dzKCkubWFwKG4gPT4gbi5pZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5DaGVja0lEcyA9IHRoaXMuZGdSZWYuY2hlY2tWYWx1ZXMuZmlsdGVyKGkgPT4gY3VycmVudFBhZ2VySWRzLmluY2x1ZGVzKGkpICYmIGkgIT0gcGFyYW0uaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHVuU2VsZWN0SWRzID0gdGhpcy5kZ1JlZi5jaGVja1ZhbHVlcy5maWx0ZXIobiA9PiAhY3VycmVudFBhZ2VySWRzLmluY2x1ZGVzKG4pKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBjb25zdCB1bkNoZWNrSURzID0gdGhpcy5kZ1JlZi5jaGVja1ZhbHVlcy5maWx0ZXIobiA9PiBuICE9IHBhcmFtLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodW5DaGVja0lEcyAmJiB1bkNoZWNrSURzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLnVuQ2hlY2tSb3dzKHVuQ2hlY2tJRHMsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLmNsZWFyU2VsZWN0aW9ucyhbcGFyYW0uaWQsIC4uLnVuU2VsZWN0SWRzXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKGlzU2hpZnRLZXkpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgZm9jdXNJbmRleCA9IHRoaXMuZGdSZWYuZm9jdXNSb3dJbmRleDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZm9jdXNJbmRleCA9PT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9jdXNJbmRleCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBlbmRJbmRleCA9IHBhcmFtLnJvd0luZGV4O1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzdGFydCA9IGZvY3VzSW5kZXg7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGVuZCA9IGVuZEluZGV4O1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmb2N1c0luZGV4ID4gZW5kSW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBlbmRJbmRleDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZW5kID0gZm9jdXNJbmRleDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRnUmVmLmdldFJvd3MoKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGVja2VkSXRlbXMgPSBbLi4uZGF0YV0uc3BsaWNlKHN0YXJ0LCBlbmQgLSBzdGFydCArIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHdpbGxDaGVja0lkcyA9IGNoZWNrZWRJdGVtcy5tYXAobiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRnUmVmLmRmcy5wcmltYXJ5SWQobik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghaXNDdHJsS2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYuY2xlYXJDaGVja2VkcyhmYWxzZSwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLmRnUmVmLnNlbGVjdFZhbHVlcyA9IHdpbGxDaGVja0lkcztcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLmNoZWNrUm93cyh3aWxsQ2hlY2tJZHMsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoaXNTZWxlY3RlZCAmJiBpc0N0cmxLZXkpIHtcclxuICAgICAgICAgICAgICAgIHBhcmFtLmUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICAvLyDmiafooYzlj5bmtojpgInmi6lcclxuICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYudW5DaGVja1JvdyhwYXJhbS5pZCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3Qgem9uZUNsaWNrID0gcGFyYW0uY2VsbHJlZiA/IHBhcmFtLmNlbGxyZWZbJ3pvbmVDbGljayddIDogJyc7ICBcclxuICAgICAgICAgICAgY29uc3QgX3RpbWVyID0gem9uZUNsaWNrICYmIHpvbmVDbGljay5sZW5ndGggPyAxMDA6IDA7XHJcblxyXG4gICAgICAgICAgICBsZXQgciQ6IE9ic2VydmFibGU8YW55PiA9IG9mKHRydWUpO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5kZ1JlZi5iZWZvcmVTZWxlY3QpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHIgPSB0aGlzLmRnUmVmLmJlZm9yZVNlbGVjdChwYXJhbSk7XHJcbiAgICAgICAgICAgICAgICBpZiAociAmJiByLnN1YnNjcmliZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHIkID0gcjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByJC5waXBlKGRlbGF5KF90aW1lcikpLnN1YnNjcmliZSgoY2FuU2VsZWN0OiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2FuU2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMuc2VsZWN0Um93KHBhcmFtLnJvd0luZGV4LCBwYXJhbS5yb3dEYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kZ1JlZi5zZWxlY3RlZFJvdykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLnNlbGVjdGVkUm93LmRyID0gcGFyYW0uZHI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5yb3dDbGljay5lbWl0KHsgZGF0YTogcGFyYW0ucm93RGF0YSwgZ3JpZDogdGhpcy5kZ1JlZiwgZGJsY2xpY2s6IGZhbHNlIH0pO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZ3Muc2V0U2VsZWNlZFJvdy5lbWl0KHsgc2VsZWN0ZWQ6IHRydWUsIGlkOiB0aGlzLmRnUmVmLmRmcy5wcmltYXJ5SWQocGFyYW0ucm93RGF0YSkgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKF90aW1lcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJhbS5jZWxscmVmICYmIHBhcmFtLmNlbGxyZWYucnVuWm9uZUNsaWNrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtLmNlbGxyZWYucnVuWm9uZUNsaWNrKHBhcmFtLmUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGVuZFJvd0NsaWNrKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmRnUmVmICYmIHRoaXMuZGdSZWYuc2VsZWN0aW9uTW9kZSA9PT0gJ2RlZmF1bHQnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuY2hlY2tPblNlbGVjdCA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuIl19