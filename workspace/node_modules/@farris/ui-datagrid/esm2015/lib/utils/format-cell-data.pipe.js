/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { DatagridComponent } from './../datagrid.component';
import { LocaleService } from '@farris/ui-locale';
import { Pipe, Injector, Optional, ElementRef, LOCALE_ID } from '@angular/core';
import { Utils } from './utils';
import { ColumnFormatService } from '@farris/ui-common/column';
export class FormatCellDataPipe {
    /**
     * @param {?} cfs
     * @param {?=} injector
     */
    constructor(cfs, injector) {
        this.cfs = cfs;
        this.injector = injector;
        this.localeId = 'ZH-CHS';
        this.localeId = this.injector.get(LOCALE_ID);
    }
    /**
     * @param {?} col
     * @param {?} rowData
     * @param {?=} groupFooter
     * @param {?=} footer
     * @return {?}
     */
    transform(col, rowData, groupFooter = false, footer = false) {
        if (rowData && col && col.field) {
            /** @type {?} */
            const value = Utils.getValue(col.field, rowData);
            if (col.editor && col.editor.options && col.editor.options.isPassword && !col.formatter) {
                return value ? '******' : '';
            }
            /** @type {?} */
            let formatterFn = col.formatter;
            if (groupFooter) {
                formatterFn = col.groupFooter ? col.groupFooter.formatter : undefined;
            }
            else if (footer) {
                formatterFn = col.footer ? col.footer.formatter : undefined;
                if (typeof formatterFn === 'object') {
                    if (!formatterFn.options) {
                        /** @type {?} */
                        const opts = { type: formatterFn.type, options: formatterFn };
                        formatterFn = opts;
                    }
                }
            }
            if (!formatterFn) {
                /** @type {?} */
                let resoultStr = value;
                if (col.isMultilingualField) {
                    resoultStr = this.getMultilingualValue(value);
                }
                else {
                    if (value !== null && value !== undefined && value !== '0' && typeof value === 'string') {
                        this.getDatagridInstance();
                        if (value.indexOf('\n') > -1) {
                            // return value.replace(/\n/g, '<br>');
                            if (this.dataGrid && this.dataGrid.nowrap) {
                                resoultStr = value.replace(/\n/g, ' ');
                            }
                        }
                        this.setFooterCellTitle(resoultStr, footer, col.field);
                    }
                    // value.replace(/ /g, '&ensp;');
                }
                return this.setPlaceHolderWhenEnableEditCellStyle(col, resoultStr, rowData, groupFooter || footer);
            }
            else {
                if (formatterFn) {
                    if (formatterFn.type === 'number') {
                        if (!formatterFn.options || !Object.keys(formatterFn.options).length) {
                            formatterFn.options = {
                                thousand: ',',
                                precision: 2
                            };
                        }
                    }
                    if (formatterFn.type === 'datetime') {
                        if (formatterFn.options) {
                            if (col.editor && col.editor.options) {
                                const { dateRange, dateRangeDatesDelimiter } = col.editor.options;
                                formatterFn.options = Object.assign({ dateRange, dateRangeDatesDelimiter }, formatterFn.options);
                            }
                        }
                    }
                    if (formatterFn.type === 'timeago') {
                        if (formatterFn.options) {
                            formatterFn.options.locale = formatterFn.options.locale || this.localeId;
                        }
                        else {
                            formatterFn.options = {
                                locale: this.localeId
                            };
                        }
                    }
                }
                this.getDatagridInstance();
                /** @type {?} */
                let r = '';
                if (this.dataGrid) {
                    r = this.cfs.format(value, rowData, formatterFn, { utils: this.dataGrid.commonUtils, locale: this.localeId });
                    this.setFooterCellTitle(r, footer, col.field);
                    return this.setPlaceHolderWhenEnableEditCellStyle(col, r, rowData, groupFooter || footer);
                }
                else {
                    r = this.cfs.format(value, rowData, formatterFn, { locale: this.localeId });
                    this.setFooterCellTitle(r, footer, col.field);
                    return r;
                }
            }
        }
        return '';
    }
    /**
     * @private
     * @param {?} text
     * @param {?} isFooter
     * @param {?} field
     * @return {?}
     */
    setFooterCellTitle(text, isFooter, field) {
        if (text && isFooter && this.elRef) {
            /** @type {?} */
            const span = this.elRef.nativeElement.querySelector(`td[field="${field}"] .f-datagrid-footer-cell`);
            if (span) {
                span.title = text;
            }
        }
    }
    // 获取多语数据
    /**
     * @private
     * @param {?} valObj
     * @return {?}
     */
    getMultilingualValue(valObj) {
        if (valObj && typeof valObj === 'object' && Object.keys(valObj).length > 0) {
            if (this.injector) {
                this.localeService = this.injector.get(LocaleService);
            }
            if (this.localeService) {
                /** @type {?} */
                const localeId = this.localeService.localeId;
                return Utils.getMultilingualValue(valObj, localeId);
            }
            else {
                return valObj['zh-CHS'];
            }
        }
        else {
            return '';
        }
    }
    // 启用标识可编辑单元格时，内容为空时设置提示语
    /**
     * @private
     * @param {?} col
     * @param {?} val
     * @param {?} rowData
     * @param {?} isFooter
     * @return {?}
     */
    setPlaceHolderWhenEnableEditCellStyle(col, val, rowData, isFooter) {
        this.getDatagridInstance();
        if (this.dataGrid) {
            /*
            if (!this.dataGrid.editable || (val !== null && val !== undefined && val !== '') || isFooter || this.cellIsReadOnly(col, rowData)) {
                if (this.elRef) {
                    const span = this.elRef.nativeElement.querySelector('.cell-text-box');
                    if (span && span.className.indexOf('cell-empty') > -1) {
                        span.className = span.className.replace('cell-empty', ' ');
                    }
                }

                return val;
            }
*/
            if (this.dataGrid.enableEditCellStyle) {
                if (!this.dataGrid.editable || (val !== null && val !== undefined && val !== '') || isFooter || this.cellIsReadOnly(col, rowData)) {
                    if (this.elRef) {
                        /** @type {?} */
                        const span = this.elRef.nativeElement.querySelector('.cell-text-box');
                        if (span && span.className.indexOf('cell-empty') > -1) {
                            span.className = span.className.replace('cell-empty', ' ');
                        }
                    }
                    return val;
                }
                if (this.elRef) {
                    /** @type {?} */
                    const span = this.elRef.nativeElement.querySelector('.cell-text-box');
                    if (span && span.className.indexOf('cell-empty') === -1) {
                        span.className = span.className + ' cell-empty';
                    }
                }
                return Utils.getWhenEmptyText(col, this.localeId);
            }
            return val;
        }
        return val;
    }
    /**
     * @private
     * @return {?}
     */
    getDatagridInstance() {
        if (!this.dataGrid) {
            this.dataGrid = this.injector.get(DatagridComponent, null);
        }
        if (!this.elRef) {
            this.elRef = this.injector.get(ElementRef, null);
        }
    }
    /**
     * @param {?} col
     * @param {?} rowData
     * @return {?}
     */
    cellIsReadOnly(col, rowData) {
        return this.dataGrid.cellIsReadOnly(col, rowData);
    }
}
FormatCellDataPipe.decorators = [
    { type: Pipe, args: [{ name: 'formatCellData', pure: false },] }
];
/** @nocollapse */
FormatCellDataPipe.ctorParameters = () => [
    { type: ColumnFormatService },
    { type: Injector, decorators: [{ type: Optional }] }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.localeService;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.dataGrid;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.elRef;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.localeId;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.cfs;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWF0LWNlbGwtZGF0YS5waXBlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC8iLCJzb3VyY2VzIjpbImxpYi91dGlscy9mb3JtYXQtY2VsbC1kYXRhLnBpcGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzVELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsSUFBSSxFQUFpQixRQUFRLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0YsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNoQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUkvRCxNQUFNLE9BQU8sa0JBQWtCOzs7OztJQU0zQixZQUFvQixHQUF3QixFQUFzQixRQUFtQjtRQUFqRSxRQUFHLEdBQUgsR0FBRyxDQUFxQjtRQUFzQixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBRDdFLGFBQVEsR0FBRyxRQUFRLENBQUM7UUFFeEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNqRCxDQUFDOzs7Ozs7OztJQUVELFNBQVMsQ0FBQyxHQUFRLEVBQUUsT0FBWSxFQUFFLFdBQVcsR0FBRyxLQUFLLEVBQUUsTUFBTSxHQUFHLEtBQUs7UUFDakUsSUFBSSxPQUFPLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUU7O2tCQUN2QixLQUFLLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQztZQUNoRCxJQUFJLEdBQUcsQ0FBQyxNQUFNLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLElBQUksR0FBRyxD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QUFRLENBQUMsQ0FBQzthQUNyRDtZQUVELE9BQU8sR0FBRyxDQUFDO1NBQ2Q7UUFFRCxPQUFPLEdBQUcsQ0FBQztJQUNmLENBQUM7Ozs7O0lBRU8sbUJBQW1CO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2hCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDOUQ7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNiLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ3BEO0lBQ0wsQ0FBQzs7Ozs7O0lBRUQsY0FBYyxDQUFDLEdBQWUsRUFBRSxPQUFPO1FBQ25DLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3RELENBQUM7OztZQXBMSixJQUFJLFNBQUMsRUFBQyxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBQzs7OztZQUhsQyxtQkFBbUI7WUFGRSxRQUFRLHVCQVlhLFFBQVE7Ozs7Ozs7SUFKdkQsMkNBQXFDOzs7OztJQUNyQyxzQ0FBb0M7Ozs7O0lBQ3BDLG1DQUEwQjs7Ozs7SUFDMUIsc0NBQTRCOzs7OztJQUNoQixpQ0FBZ0M7Ozs7O0lBQUUsc0NBQXVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGF0YWdyaWRDb21wb25lbnQgfSBmcm9tICcuLy4uL2RhdGFncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IExvY2FsZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWxvY2FsZSc7XHJcbmltcG9ydCB7IFBpcGUsIFBpcGVUcmFuc2Zvcm0sIEluamVjdG9yLCBPcHRpb25hbCwgRWxlbWVudFJlZiwgTE9DQUxFX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFV0aWxzIH0gZnJvbSAnLi91dGlscyc7XHJcbmltcG9ydCB7IENvbHVtbkZvcm1hdFNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbi9jb2x1bW4nO1xyXG5pbXBvcnQgeyBEYXRhQ29sdW1uIH0gZnJvbSAnLi4vdHlwZXMvZGF0YS1jb2x1bW4nO1xyXG5cclxuQFBpcGUoe25hbWU6ICdmb3JtYXRDZWxsRGF0YScsIHB1cmU6IGZhbHNlfSlcclxuZXhwb3J0IGNsYXNzIEZvcm1hdENlbGxEYXRhUGlwZSBpbXBsZW1lbnRzIFBpcGVUcmFuc2Zvcm0ge1xyXG5cclxuICAgIHByaXZhdGUgbG9jYWxlU2VydmljZTogTG9jYWxlU2VydmljZTtcclxuICAgIHByaXZhdGUgZGF0YUdyaWQ6IERhdGFncmlkQ29tcG9uZW50O1xyXG4gICAgcHJpdmF0ZSBlbFJlZjogRWxlbWVudFJlZjtcclxuICAgIHByaXZhdGUgbG9jYWxlSWQgPSAnWkgtQ0hTJztcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgY2ZzOiBDb2x1bW5Gb3JtYXRTZXJ2aWNlLCBAT3B0aW9uYWwoKSBwcml2YXRlIGluamVjdG9yPzogSW5qZWN0b3IpIHtcclxuICAgICAgICB0aGlzLmxvY2FsZUlkID0gdGhpcy5pbmplY3Rvci5nZXQoTE9DQUxFX0lEKTtcclxuICAgIH1cclxuXHJcbiAgICB0cmFuc2Zvcm0oY29sOiBhbnksIHJvd0RhdGE6IGFueSwgZ3JvdXBGb290ZXIgPSBmYWxzZSwgZm9vdGVyID0gZmFsc2UpOiBhbnkge1xyXG4gICAgICAgIGlmIChyb3dEYXRhICYmIGNvbCAmJiBjb2wuZmllbGQpIHtcclxuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBVdGlscy5nZXRWYWx1ZShjb2wuZmllbGQsIHJvd0RhdGEpO1xyXG4gICAgICAgICAgICBpZiAoY29sLmVkaXRvciAmJiBjb2wuZWRpdG9yLm9wdGlvbnMgJiYgY29sLmVkaXRvci5vcHRpb25zLmlzUGFzc3dvcmQgJiYgIWNvbC5mb3JtYXR0ZXIpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAgdmFsdWUgPyAnKioqKioqJyA6ICcnO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsZXQgZm9ybWF0dGVyRm4gPSBjb2wuZm9ybWF0dGVyO1xyXG4gICAgICAgICAgICBpZiAoZ3JvdXBGb290ZXIpIHtcclxuICAgICAgICAgICAgICAgIGZvcm1hdHRlckZuID0gY29sLmdyb3VwRm9vdGVyID8gY29sLmdyb3VwRm9vdGVyLmZvcm1hdHRlciA6IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChmb290ZXIpIHtcclxuICAgICAgICAgICAgICAgIGZvcm1hdHRlckZuID0gY29sLmZvb3RlciA/IGNvbC5mb290ZXIuZm9ybWF0dGVyIDogdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmb3JtYXR0ZXJGbiA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWZvcm1hdHRlckZuLm9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3B0cyA9IHsgdHlwZTogZm9ybWF0dGVyRm4udHlwZSwgb3B0aW9uczogZm9ybWF0dGVyRm4gfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyRm4gPSBvcHRzO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKCFmb3JtYXR0ZXJGbikge1xyXG4gICAgICAgICAgICAgICAgbGV0IHJlc291bHRTdHIgPSB2YWx1ZTtcclxuICAgICAgICAgICAgICAgIGlmIChjb2wuaXNNdWx0aWxpbmd1YWxGaWVsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc291bHRTdHIgPSB0aGlzLmdldE11bHRpbGluZ3VhbFZhbHVlKHZhbHVlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsICYmIHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09ICcwJyAmJiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0RGF0YWdyaWRJbnN0YW5jZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUuaW5kZXhPZignXFxuJykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIHZhbHVlLnJlcGxhY2UoL1xcbi9nLCAnPGJyPicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGF0YUdyaWQgJiYgdGhpcy5kYXRhR3JpZC5ub3dyYXApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvdWx0U3RyID0gdmFsdWUucmVwbGFjZSgvXFxuL2csICcgJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0Rm9vdGVyQ2VsbFRpdGxlKHJlc291bHRTdHIsIGZvb3RlciwgY29sLmZpZWxkKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gdmFsdWUucmVwbGFjZSgvIC9nLCAnJmVuc3A7Jyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zZXRQbGFjZUhvbGRlcldoZW5FbmFibGVFZGl0Q2VsbFN0eWxlKGNvbCwgcmVzb3VsdFN0ciwgcm93RGF0YSwgZ3JvdXBGb290ZXIgfHwgZm9vdGVyKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChmb3JtYXR0ZXJGbikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICggZm9ybWF0dGVyRm4udHlwZSA9PT0gJ251bWJlcicpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFmb3JtYXR0ZXJGbi5vcHRpb25zIHx8ICFPYmplY3Qua2V5cyhmb3JtYXR0ZXJGbi5vcHRpb25zKS5sZW5ndGggKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXJGbi5vcHRpb25zID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRob3VzYW5kOiAnLCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlY2lzaW9uOiAyXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICggZm9ybWF0dGVyRm4udHlwZSA9PT0gJ2RhdGV0aW1lJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybWF0dGVyRm4ub3B0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbC5lZGl0b3IgJiYgY29sLmVkaXRvci5vcHRpb25zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBkYXRlUmFuZ2UsIGRhdGVSYW5nZURhdGVzRGVsaW1pdGVyIH0gPSBjb2wuZWRpdG9yLm9wdGlvbnM7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyRm4ub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBkYXRlUmFuZ2UsIGRhdGVSYW5nZURhdGVzRGVsaW1pdGVyIH0sIGZvcm1hdHRlckZuLm9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybWF0dGVyRm4udHlwZSA9PT0gJ3RpbWVhZ28nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3JtYXR0ZXJGbi5vcHRpb25zICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyRm4ub3B0aW9ucy5sb2NhbGUgPSBmb3JtYXR0ZXJGbi5vcHRpb25zLmxvY2FsZSB8fCB0aGlzLmxvY2FsZUlkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyRm4ub3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbGU6IHRoaXMubG9jYWxlSWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLmdldERhdGFncmlkSW5zdGFuY2UoKTtcclxuICAgICAgICAgICAgICAgIGxldCByID0gJyc7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXRhR3JpZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHIgPSB0aGlzLmNmcy5mb3JtYXQodmFsdWUsIHJvd0RhdGEsIGZvcm1hdHRlckZuLCB7IHV0aWxzOiB0aGlzLmRhdGFHcmlkLmNvbW1vblV0aWxzLCBsb2NhbGU6IHRoaXMubG9jYWxlSWQgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRGb290ZXJDZWxsVGl0bGUociwgZm9vdGVyLCBjb2wuZmllbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldFBsYWNlSG9sZGVyV2hlbkVuYWJsZUVkaXRDZWxsU3R5bGUoY29sLCByLCByb3dEYXRhLCBncm91cEZvb3RlciB8fCBmb290ZXIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByID0gdGhpcy5jZnMuZm9ybWF0KHZhbHVlLCByb3dEYXRhLCBmb3JtYXR0ZXJGbiwge2xvY2FsZTogdGhpcy5sb2NhbGVJZCB9KTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEZvb3RlckNlbGxUaXRsZShyLCBmb290ZXIsIGNvbC5maWVsZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHI7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNldEZvb3RlckNlbGxUaXRsZSh0ZXh0OiBzdHJpbmcsIGlzRm9vdGVyOiBib29sZWFuLCBmaWVsZDogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKHRleHQgJiYgaXNGb290ZXIgJiYgdGhpcy5lbFJlZikge1xyXG4gICAgICAgICAgICBjb25zdCBzcGFuID0gdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoYHRkW2ZpZWxkPVwiJHtmaWVsZH1cIl0gLmYtZGF0YWdyaWQtZm9vdGVyLWNlbGxgKTtcclxuICAgICAgICAgICAgaWYgKHNwYW4pIHtcclxuICAgICAgICAgICAgICAgIHNwYW4udGl0bGUgPSB0ZXh0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIOiOt+WPluWkmuivreaVsOaNrlxyXG4gICAgcHJpdmF0ZSBnZXRNdWx0aWxpbmd1YWxWYWx1ZSh2YWxPYmopIHtcclxuICAgICAgICBpZiAodmFsT2JqICYmIHR5cGVvZiB2YWxPYmogPT09ICdvYmplY3QnICYmIE9iamVjdC5rZXlzKHZhbE9iaikubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pbmplY3Rvcikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2NhbGVTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQoTG9jYWxlU2VydmljZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHRoaXMubG9jYWxlU2VydmljZSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbG9jYWxlSWQgPSB0aGlzLmxvY2FsZVNlcnZpY2UubG9jYWxlSWQ7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gVXRpbHMuZ2V0TXVsdGlsaW5ndWFsVmFsdWUodmFsT2JqLCBsb2NhbGVJZCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdmFsT2JqWyd6aC1DSFMnXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiAnJztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5ZCv55So5qCH6K+G5Y+v57yW6L6R5Y2V5YWD5qC85pe277yM5YaF5a655Li656m65pe26K6+572u5o+Q56S66K+tXHJcbiAgICBwcml2YXRlIHNldFBsYWNlSG9sZGVyV2hlbkVuYWJsZUVkaXRDZWxsU3R5bGUoY29sLCB2YWwsIHJvd0RhdGEsIGlzRm9vdGVyKSB7XHJcbiAgICAgICAgdGhpcy5nZXREYXRhZ3JpZEluc3RhbmNlKCk7XHJcbiAgICAgICAgaWYgKHRoaXMuZGF0YUdyaWQpIHtcclxuICAgICAgICAgICAgLypcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmRhdGFHcmlkLmVkaXRhYmxlIHx8ICh2YWwgIT09IG51bGwgJiYgdmFsICE9PSB1bmRlZmluZWQgJiYgdmFsICE9PSAnJykgfHwgaXNGb290ZXIgfHwgdGhpcy5jZWxsSXNSZWFkT25seShjb2wsIHJvd0RhdGEpKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5lbFJlZikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwYW4gPSB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignLmNlbGwtdGV4dC1ib3gnKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3BhbiAmJiBzcGFuLmNsYXNzTmFtZS5pbmRleE9mKCdjZWxsLWVtcHR5JykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzcGFuLmNsYXNzTmFtZSA9IHNwYW4uY2xhc3NOYW1lLnJlcGxhY2UoJ2NlbGwtZW1wdHknLCAnICcpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdmFsO1xyXG4gICAgICAgICAgICB9XHJcbiovXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmRhdGFHcmlkLmVuYWJsZUVkaXRDZWxsU3R5bGUgKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmRhdGFHcmlkLmVkaXRhYmxlIHx8ICh2YWwgIT09IG51bGwgJiYgdmFsICE9PSB1bmRlZmluZWQgJiYgdmFsICE9PSAnJykgfHwgaXNGb290ZXIgfHwgdGhpcy5jZWxsSXNSZWFkT25seShjb2wsIHJvd0RhdGEpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZWxSZWYpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BhbiA9IHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCcuY2VsbC10ZXh0LWJveCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BhbiAmJiBzcGFuLmNsYXNzTmFtZS5pbmRleE9mKCdjZWxsLWVtcHR5JykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Bhbi5jbGFzc05hbWUgPSBzcGFuLmNsYXNzTmFtZS5yZXBsYWNlKCdjZWxsLWVtcHR5JywgJyAnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWw7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsUmVmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BhbiA9IHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCcuY2VsbC10ZXh0LWJveCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzcGFuICYmIHNwYW4uY2xhc3NOYW1lLmluZGV4T2YoJ2NlbGwtZW1wdHknKSA9PT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3Bhbi5jbGFzc05hbWUgPSBzcGFuLmNsYXNzTmFtZSArICcgY2VsbC1lbXB0eSc7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFV0aWxzLmdldFdoZW5FbXB0eVRleHQoY29sLCB0aGlzLmxvY2FsZUlkKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHZhbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB2YWw7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXREYXRhZ3JpZEluc3RhbmNlKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5kYXRhR3JpZCkge1xyXG4gICAgICAgICAgICB0aGlzLmRhdGFHcmlkID0gdGhpcy5pbmplY3Rvci5nZXQoRGF0YWdyaWRDb21wb25lbnQsIG51bGwpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLmVsUmVmKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZWxSZWYgPSB0aGlzLmluamVjdG9yLmdldChFbGVtZW50UmVmLCBudWxsKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY2VsbElzUmVhZE9ubHkoY29sOiBEYXRhQ29sdW1uLCByb3dEYXRhKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZGF0YUdyaWQuY2VsbElzUmVhZE9ubHkoY29sLCByb3dEYXRhKTtcclxuICAgIH1cclxufVxyXG4iXX0=