/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*
 * @Author: 疯狂秀才(Lucas Huang)
 * @Date: 2019-08-12 11:07:01
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-10-02 15:23:45
 * @QQ: 1055818239
 * @Version: v0.0.1
 */
import { Directive, Renderer2, ElementRef, Input, Injector, NgZone, HostBinding } from '@angular/core';
import { DatagridComponent, ValidatorMessagerService, DatagridFacadeService } from '@farris/ui-datagrid';
var DatagridBaseEditorDirective = /** @class */ (function () {
    function DatagridBaseEditorDirective(render, el, injector) {
        var _this = this;
        this.render = render;
        this.el = el;
        this.injector = injector;
        this.placeholder = '';
        // 组件高度
        this.height = '';
        this.options = {};
        /**
         * 是否正在向server 发送请求
         */
        this.pending = false;
        /**
         * 禁止事件冒泡
         */
        this.stopPropagation = true;
        /**
         * 默认焦点
         */
        this.focus = true;
        this.validators = [];
        this._inputKeydown = null;
        this._editorClickEvent = null;
        this.cls = 'datagrid-editor';
        this.width = '100%';
        this.focusTimer = null;
        this.eventParams = (/**
         * @param {?} $event
         * @return {?}
         */
        function ($event) {
            /** @type {?} */
            var rowData = null;
            /** @type {?} */
            var rowId = null;
            if (_this.dr) {
                rowData = _this.dr.rowData;
                rowId = _this.dr.rowId;
            }
            return {
                rowData: rowData,
                rowId: rowId,
                value: $event,
                form: _this.group,
                formControl: _this.formControl
            };
        });
        this.vms = this.injector.get(ValidatorMessagerService);
        this.dg = this.injector.get(DatagridComponent);
        this.dfs = this.injector.get(DatagridFacadeService);
        this.ngZone = this.injector.get(NgZone);
    }
    Object.defineProperty(DatagridBaseEditorDirective.prototype, "dr", {
        get: /**
         * @return {?}
         */
        function () {
            return this.dg.selectedRow.dr;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    DatagridBaseEditorDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.column && this.column.editor) {
            this.options = this.column.editor.options;
            this.validators = this.column.editor.validators || [];
            // 启用任意输入后，字符最大长度属性值验证
            // 当maxLength <= 0 时认为此属性无效
            if (this.options && this.options.nosearch !== undefined && this.options.nosearch) {
                if (this.options.maxLength !== undefined && this.options.maxLength <= 0) {
                    this.options.maxLength = undefined;
                }
            }
        }
        this.clickEvent = this.render.listen(this.el.nativeElement, 'click', (/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            e.stopPropagation();
            _this.dg['focusElement'] = _this.inputElement;
        }));
        this.mouseDownEvent = this.render.listen(this.el.nativeElement, 'mousedown', (/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            _this._editorClickEvent = e;
        }));
        this.mouseUpEvent = this.render.listen(this.el.nativeElement, 'mouseup', (/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            _this._editorClickEvent = null;
        }));
        if (this.group) {
            this.formControl = (/** @type {?} */ (this.group.controls[this.column.field]));
        }
        // this.dblClickEvent = this.render.listen(this.el.nativeElement, 'dblclick', (e: MouseEvent) => {
        //     e.stopPropagation();
        //     e.preventDefault();
        // });
    };
    /**
     * @return {?}
     */
    DatagridBaseEditorDirective.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.setFocus();
        if (this['instance']) {
            this['instance'].inDatagrid = true;
        }
        this.setErrorMessage();
        this._inputKeydown = this.render.listen(this.inputElement, 'keydown', (/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (e.ctrlKey || e.shiftKey) {
                e.stopPropagation();
            }
        }));
        if (this.formControl) {
            this.formControl.valueChanges.subscribe((/**
             * @param {?} val
             * @return {?}
             */
            function (val) {
                var _a;
                // 记录变更集
                if (!_this.formControl.pristine) {
                    /** @type {?} */
                    var rowId = _this.dg.selectedRow ? _this.dg.selectedRow.id : '';
                    if (rowId) {
                        /** @type {?} */
                        var keyField = _this.dg.idField;
                        /** @type {?} */
                        var changeData = (_a = {}, _a[keyField] = rowId, _a[_this.column.field] = val, _a);
                        _this.dfs.appendChanges(changeData);
                    }
                }
                _this.setErrorMessage();
            }));
        }
    };
    /**
     * @return {?}
     */
    DatagridBaseEditorDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (this.clickEvent) {
            this.clickEvent();
        }
        if (this.dblClickEvent) {
            this.dblClickEvent();
        }
        if (this.mouseDownEvent) {
            this.mouseDownEvent();
        }
        if (this.mouseUpEvent) {
            this.mouseUpEvent();
        }
        if (this.dg) {
            this.dg['focusElement'] = null;
        }
        if (this._inputKeydown) {
            this._inputKeydown();
            this._inputKeydown = null;
            this.inputElement = null;
        }
    };
    /**
     * @private
     * @return {?}
     */
    DatagridBaseEditorDirective.prototype.setErrorMessage = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.formControl && this.formControl.invalid) {
            Object.keys(this.formControl.errors).forEach((/**
             * @param {?} key
             * @return {?}
             */
            function (key) {
                _this.errorMessage = _this.vms.getValidatorErrorMessage(key, _this.validators);
            }));
        }
    };
    /**
     * @private
     * @return {?}
     */
    DatagridBaseEditorDirective.prototype.setFocus = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        if (!this.focus) {
            return;
        }
        if (this.ngZone) {
            this.ngZone.runOutsideAngular((/**
             * @return {?}
             */
            function () {
                if (_this.focusTimer) {
                    clearTimeout(_this.focusTimer);
                }
                _this.focusTimer = setTimeout((/**
                 * @return {?}
                 */
                function () {
                    if (_this.inputElement && _this.dg.editMode === 'cell') {
                        if (_this.dg && _this.dg.selectOnEditing) {
                            if (_this.inputElement.select) {
                                _this.inputElement.select();
                            }
                        }
                        else {
                            _this.inputElement.focus();
                        }
                        _this.dg['focusElement'] = _this.inputElement;
                    }
                }), 10);
            }));
        }
    };
    /**
     * @param {?} $event
     * @return {?}
     */
    DatagridBaseEditorDirective.prototype.onValueChange = /**
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        if (this.options.valueChange) {
            this.options.valueChange(this.eventParams($event));
        }
    };
    /**
     * @return {?}
     */
    DatagridBaseEditorDirective.prototype.startPending = /**
     * @return {?}
     */
    function () {
        this.pending = true;
        this.dg.pending = true;
    };
    /**
     * @return {?}
     */
    DatagridBaseEditorDirective.prototype.endPending = /**
     * @return {?}
     */
    function () {
        this.pending = false;
        this.dg.pending = false;
    };
    DatagridBaseEditorDirective.decorators = [
        { type: Directive, args: [{
                    selector: 'datagrid-editor',
                },] }
    ];
    /** @nocollapse */
    DatagridBaseEditorDirective.ctorParameters = function () { return [
        { type: Renderer2 },
        { type: ElementRef },
        { type: Injector }
    ]; };
    DatagridBaseEditorDirective.propDecorators = {
        placeholder: [{ type: Input }],
        height: [{ type: Input }],
        cls: [{ type: HostBinding, args: ['class',] }],
        width: [{ type: HostBinding, args: ['style.width',] }]
    };
    return DatagridBaseEditorDirective;
}());
export { DatagridBaseEditorDirective };
if (false) {
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.placeholder;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.height;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.controlId;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.type;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.options;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.group;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.column;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.formControl;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.inputElement;
    /**
     * 是否正在向server 发送请求
     * @type {?}
     */
    DatagridBaseEditorDirective.prototype.pending;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.errorMessage;
    /**
     * 禁止事件冒泡
     * @type {?}
     */
    DatagridBaseEditorDirective.prototype.stopPropagation;
    /**
     * 默认焦点
     * @type {?}
     */
    DatagridBaseEditorDirective.prototype.focus;
    /**
     * @type {?}
     * @private
     */
    DatagridBaseEditorDirective.prototype.clickEvent;
    /**
     * @type {?}
     * @private
     */
    DatagridBaseEditorDirective.prototype.mouseDownEvent;
    /**
     * @type {?}
     * @private
     */
    DatagridBaseEditorDirective.prototype.mouseUpEvent;
    /**
     * @type {?}
     * @private
     */
    DatagridBaseEditorDirective.prototype.dblClickEvent;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.vms;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.dg;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.dfs;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.validators;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.ngZone;
    /**
     * @type {?}
     * @private
     */
    DatagridBaseEditorDirective.prototype._inputKeydown;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype._editorClickEvent;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.cls;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.width;
    /**
     * @type {?}
     * @private
     */
    DatagridBaseEditorDirective.prototype.focusTimer;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.eventParams;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.render;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.el;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtYmFzZS1lZGl0b3IuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC1lZGl0b3JzLyIsInNvdXJjZXMiOlsibGliL2RhdGFncmlkLWJhc2UtZWRpdG9yLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFRQSxPQUFPLEVBQUUsU0FBUyxFQUFvQyxTQUFTLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUV4SSxPQUFPLEVBQWMsaUJBQWlCLEVBQUUsd0JBQXdCLEVBQUUscUJBQXFCLEVBQXdCLE1BQU0scUJBQXFCLENBQUM7QUFFM0k7SUE2Q0kscUNBQW1CLE1BQWlCLEVBQVMsRUFBYyxFQUFTLFFBQWtCO1FBQXRGLGlCQUtDO1FBTGtCLFdBQU0sR0FBTixNQUFNLENBQVc7UUFBUyxPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQVMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQXhDN0UsZ0JBQVcsR0FBRyxFQUFFLENBQUM7O1FBRWpCLFdBQU0sR0FBRyxFQUFFLENBQUM7UUFHckIsWUFBTyxHQUFRLEVBQUUsQ0FBQzs7OztRQU9sQixZQUFPLEdBQUcsS0FBSyxDQUFDOzs7O1FBS2hCLG9CQUFlLEdBQUcsSUFBSSxDQUFDOzs7O1FBRXZCLFVBQUssR0FBRyxJQUFJLENBQUM7UUFTYixlQUFVLEdBQUcsRUFBRSxDQUFDO1FBR1Isa0JBQWEsR0FBRyxJQUFJLENBQUM7UUFFN0Isc0JBQWlCLEdBQWUsSUFBSSxDQUFDO1FBQ2YsUUFBRyxHQUFHLGlCQUFpQixDQUFDO1FBQ2xCLFVBQUssR0FBRyxNQUFNLENBQUM7UUFJbkMsZUFBVSxHQUFHLElBQUksQ0FBQztRQTBJMUIsZ0JBQVc7Ozs7UUFBRyxVQUFDLE1BQU07O2dCQUNiLE9BQU8sR0FBRyxJQUFJOztnQkFDZCxLQUFLLEdBQUcsSUFBSTtZ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QTBCOztJQTBJMUIsa0RBZUM7O0lBeEpXLDZDQUF3Qjs7SUFBRSx5Q0FBcUI7O0lBQUUsK0NBQXlCIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogQEF1dGhvcjog55av54uC56eA5omNKEx1Y2FzIEh1YW5nKVxyXG4gKiBARGF0ZTogMjAxOS0wOC0xMiAxMTowNzowMVxyXG4gKiBATGFzdEVkaXRvcnM6IOeWr+eLguengOaJjShMdWNhcyBIdWFuZylcclxuICogQExhc3RFZGl0VGltZTogMjAxOS0xMC0wMiAxNToyMzo0NVxyXG4gKiBAUVE6IDEwNTU4MTgyMzlcclxuICogQFZlcnNpb246IHYwLjAuMVxyXG4gKi9cclxuaW1wb3J0IHsgRGlyZWN0aXZlLCBPbkluaXQsIE9uRGVzdHJveSwgQWZ0ZXJWaWV3SW5pdCwgUmVuZGVyZXIyLCBFbGVtZW50UmVmLCBJbnB1dCwgSW5qZWN0b3IsIE5nWm9uZSwgSG9zdEJpbmRpbmd9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBGb3JtR3JvdXAsIEZvcm1Db250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQgeyBEYXRhQ29sdW1uLCBEYXRhZ3JpZENvbXBvbmVudCwgVmFsaWRhdG9yTWVzc2FnZXJTZXJ2aWNlLCBEYXRhZ3JpZEZhY2FkZVNlcnZpY2UsIERhdGFncmlkUm93RGlyZWN0aXZlIH0gZnJvbSAnQGZhcnJpcy91aS1kYXRhZ3JpZCc7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICAgIHNlbGVjdG9yOiAnZGF0YWdyaWQtZWRpdG9yJyxcclxufSlcclxuZXhwb3J0IGNsYXNzIERhdGFncmlkQmFzZUVkaXRvckRpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95LCBBZnRlclZpZXdJbml0IHtcclxuXHJcbiAgICBASW5wdXQoKSBwbGFjZWhvbGRlciA9ICcnO1xyXG4gICAgLy8g57uE5Lu26auY5bqmXHJcbiAgICBASW5wdXQoKSBoZWlnaHQgPSAnJztcclxuICAgIGNvbnRyb2xJZDogc3RyaW5nO1xyXG4gICAgdHlwZTogc3RyaW5nO1xyXG4gICAgb3B0aW9uczogYW55ID0ge307XHJcbiAgICBncm91cDogRm9ybUdyb3VwO1xyXG4gICAgY29sdW1uOiBEYXRhQ29sdW1uO1xyXG4gICAgZm9ybUNvbnRyb2w6IEZvcm1Db250cm9sO1xyXG5cclxuICAgIGlucHV0RWxlbWVudDogYW55O1xyXG4gICAgLyoqIOaYr+WQpuato+WcqOWQkXNlcnZlciDlj5HpgIHor7fmsYIgKi9cclxuICAgIHBlbmRpbmcgPSBmYWxzZTtcclxuXHJcbiAgICBlcnJvck1lc3NhZ2U6IHN0cmluZztcclxuXHJcbiAgICAvKiog56aB5q2i5LqL5Lu25YaS5rOhICovXHJcbiAgICBzdG9wUHJvcGFnYXRpb24gPSB0cnVlO1xyXG4gICAgLyoqIOm7mOiupOeEpueCuSAqL1xyXG4gICAgZm9jdXMgPSB0cnVlO1xyXG5cclxuICAgIHByaXZhdGUgY2xpY2tFdmVudDogYW55O1xyXG4gICAgcHJpdmF0ZSBtb3VzZURvd25FdmVudDogYW55O1xyXG4gICAgcHJpdmF0ZSBtb3VzZVVwRXZlbnQ6IGFueTtcclxuICAgIHByaXZhdGUgZGJsQ2xpY2tFdmVudDogYW55O1xyXG4gICAgdm1zOiBWYWxpZGF0b3JNZXNzYWdlclNlcnZpY2U7XHJcbiAgICBkZzogRGF0YWdyaWRDb21wb25lbnQ7XHJcbiAgICBkZnM6IERhdGFncmlkRmFjYWRlU2VydmljZTtcclxuICAgIHZhbGlkYXRvcnMgPSBbXTtcclxuXHJcbiAgICBuZ1pvbmU6IE5nWm9uZTtcclxuICAgIHByaXZhdGUgX2lucHV0S2V5ZG93biA9IG51bGw7XHJcblxyXG4gICAgX2VkaXRvckNsaWNrRXZlbnQ6IE1vdXNlRXZlbnQgPSBudWxsO1xyXG4gICAgQEhvc3RCaW5kaW5nKCdjbGFzcycpIGNscyA9ICdkYXRhZ3JpZC1lZGl0b3InO1xyXG4gICAgQEhvc3RCaW5kaW5nKCdzdHlsZS53aWR0aCcpIHdpZHRoID0gJzEwMCUnO1xyXG4gICAgZ2V0IGRyKCk6IERhdGFncmlkUm93RGlyZWN0aXZlIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5kZy5zZWxlY3RlZFJvdy5kcjtcclxuICAgIH1cclxuICAgIHByaXZhdGUgZm9jdXNUaW1lciA9IG51bGw7XHJcbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgcmVuZGVyOiBSZW5kZXJlcjIsIHB1YmxpYyBlbDogRWxlbWVudFJlZiwgcHVibGljIGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gICAgICAgIHRoaXMudm1zID0gdGhpcy5pbmplY3Rvci5nZXQoVmFsaWRhdG9yTWVzc2FnZXJTZXJ2aWNlKTtcclxuICAgICAgICB0aGlzLmRnID0gdGhpcy5pbmplY3Rvci5nZXQoRGF0YWdyaWRDb21wb25lbnQpO1xyXG4gICAgICAgIHRoaXMuZGZzID0gdGhpcy5pbmplY3Rvci5nZXQoRGF0YWdyaWRGYWNhZGVTZXJ2aWNlKTtcclxuICAgICAgICB0aGlzLm5nWm9uZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KE5nWm9uZSk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmNvbHVtbiAmJiB0aGlzLmNvbHVtbi5lZGl0b3IpIHtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gdGhpcy5jb2x1bW4uZWRpdG9yLm9wdGlvbnM7XHJcbiAgICAgICAgICAgIHRoaXMudmFsaWRhdG9ycyA9IHRoaXMuY29sdW1uLmVkaXRvci52YWxpZGF0b3JzIHx8IFtdO1xyXG5cclxuICAgICAgICAgICAgLy8g5ZCv55So5Lu75oSP6L6T5YWl5ZCO77yM5a2X56ym5pyA5aSn6ZW/5bqm5bGe5oCn5YC86aqM6K+BXHJcbiAgICAgICAgICAgIC8vIOW9k21heExlbmd0aCA8PSAwIOaXtuiupOS4uuatpOWxnuaAp+aXoOaViFxyXG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zICYmIHRoaXMub3B0aW9ucy5ub3NlYXJjaCAhPT0gdW5kZWZpbmVkICYmIHRoaXMub3B0aW9ucy5ub3NlYXJjaCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCB0aGlzLm9wdGlvbnMubWF4TGVuZ3RoICE9PSB1bmRlZmluZWQgJiYgdGhpcy5vcHRpb25zLm1heExlbmd0aCA8PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLm1heExlbmd0aCA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5jbGlja0V2ZW50ID0gdGhpcy5yZW5kZXIubGlzdGVuKHRoaXMuZWwubmF0aXZlRWxlbWVudCwgJ2NsaWNrJywgKGU6IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgdGhpcy5kZ1snZm9jdXNFbGVtZW50J10gPSB0aGlzLmlucHV0RWxlbWVudDtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5tb3VzZURvd25FdmVudCA9IHRoaXMucmVuZGVyLmxpc3Rlbih0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsICdtb3VzZWRvd24nLCAoZTogTW91c2VFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLl9lZGl0b3JDbGlja0V2ZW50ID0gZTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5tb3VzZVVwRXZlbnQgPSB0aGlzLnJlbmRlci5saXN0ZW4odGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnbW91c2V1cCcsIChlOiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuX2VkaXRvckNsaWNrRXZlbnQgPSBudWxsO1xyXG4gICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuZ3JvdXApIHtcclxuICAgICAgICAgICAgdGhpcy5mb3JtQ29udHJvbCA9IHRoaXMuZ3JvdXAuY29udHJvbHNbdGhpcy5jb2x1bW4uZmllbGRdIGFzIEZvcm1Db250cm9sO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyB0aGlzLmRibENsaWNrRXZlbnQgPSB0aGlzLnJlbmRlci5saXN0ZW4odGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnZGJsY2xpY2snLCAoZTogTW91c2VFdmVudCkgPT4ge1xyXG4gICAgICAgIC8vICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgIC8vICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgLy8gfSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcclxuICAgICAgICB0aGlzLnNldEZvY3VzKCk7XHJcbiAgICAgICAgaWYgKHRoaXNbJ2luc3RhbmNlJ10pIHtcclxuICAgICAgICAgICAgdGhpc1snaW5zdGFuY2UnXS5pbkRhdGFncmlkID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5zZXRFcnJvck1lc3NhZ2UoKTtcclxuXHJcbiAgICAgICAgdGhpcy5faW5wdXRLZXlkb3duID0gIHRoaXMucmVuZGVyLmxpc3Rlbih0aGlzLmlucHV0RWxlbWVudCwgJ2tleWRvd24nLCAoZSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZS5jdHJsS2V5IHx8IGUuc2hpZnRLZXkpIHtcclxuICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuZm9ybUNvbnRyb2wpIHtcclxuICAgICAgICAgICAgdGhpcy5mb3JtQ29udHJvbC52YWx1ZUNoYW5nZXMuc3Vic2NyaWJlKCAodmFsOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIOiusOW9leWPmOabtOmbhlxyXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmZvcm1Db250cm9sLnByaXN0aW5lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm93SWQgPSB0aGlzLmRnLnNlbGVjdGVkUm93ID8gdGhpcy5kZy5zZWxlY3RlZFJvdy5pZCA6ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyb3dJZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBrZXlGaWVsZCA9IHRoaXMuZGcuaWRGaWVsZDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hhbmdlRGF0YSA9IHsgW2tleUZpZWxkXTogcm93SWQsIFt0aGlzLmNvbHVtbi5maWVsZF06IHZhbCB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRmcy5hcHBlbmRDaGFuZ2VzKGNoYW5nZURhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RXJyb3JNZXNzYWdlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpIHtcclxuICAgICAgICBpZiAodGhpcy5jbGlja0V2ZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2xpY2tFdmVudCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5kYmxDbGlja0V2ZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGJsQ2xpY2tFdmVudCgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMubW91c2VEb3duRXZlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy5tb3VzZURvd25FdmVudCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5tb3VzZVVwRXZlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy5tb3VzZVVwRXZlbnQoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmRnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGdbJ2ZvY3VzRWxlbWVudCddID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuX2lucHV0S2V5ZG93bikge1xyXG4gICAgICAgICAgICB0aGlzLl9pbnB1dEtleWRvd24oKTtcclxuICAgICAgICAgICAgdGhpcy5faW5wdXRLZXlkb3duID0gbnVsbDtcclxuICAgICAgICAgICAgdGhpcy5pbnB1dEVsZW1lbnQgPSBudWxsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZXRFcnJvck1lc3NhZ2UoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZm9ybUNvbnRyb2wgJiYgdGhpcy5mb3JtQ29udHJvbC5pbnZhbGlkKSB7XHJcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKHRoaXMuZm9ybUNvbnRyb2wuZXJyb3JzKS5mb3JFYWNoKCAoa2V5OiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZXJyb3JNZXNzYWdlID0gdGhpcy52bXMuZ2V0VmFsaWRhdG9yRXJyb3JNZXNzYWdlKGtleSwgdGhpcy52YWxpZGF0b3JzKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2V0Rm9jdXMoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmZvY3VzKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLm5nWm9uZSkge1xyXG4gICAgICAgICAgICB0aGlzLm5nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5mb2N1c1RpbWVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuZm9jdXNUaW1lcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzVGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnB1dEVsZW1lbnQgJiYgdGhpcy5kZy5lZGl0TW9kZSA9PT0gJ2NlbGwnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRnICYmIHRoaXMuZGcuc2VsZWN0T25FZGl0aW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnB1dEVsZW1lbnQuc2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnB1dEVsZW1lbnQuc2VsZWN0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucHV0RWxlbWVudC5mb2N1cygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRnWydmb2N1c0VsZW1lbnQnXSA9IHRoaXMuaW5wdXRFbGVtZW50O1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sIDEwKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBldmVudFBhcmFtcyA9ICgkZXZlbnQpID0+IHtcclxuICAgICAgICBsZXQgcm93RGF0YSA9IG51bGw7XHJcbiAgICAgICAgbGV0IHJvd0lkID0gbnVsbDtcclxuICAgICAgICBpZiAodGhpcy5kcikge1xyXG4gICAgICAgICAgICByb3dEYXRhID0gdGhpcy5kci5yb3dEYXRhO1xyXG4gICAgICAgICAgICByb3dJZCA9IHRoaXMuZHIucm93SWQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICByb3dEYXRhLFxyXG4gICAgICAgICAgICByb3dJZCxcclxuICAgICAgICAgICAgdmFsdWU6ICRldmVudCxcclxuICAgICAgICAgICAgZm9ybTogdGhpcy5ncm91cCxcclxuICAgICAgICAgICAgZm9ybUNvbnRyb2w6IHRoaXMuZm9ybUNvbnRyb2xcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIG9uVmFsdWVDaGFuZ2UoJGV2ZW50KSB7XHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy52YWx1ZUNoYW5nZSkge1xyXG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMudmFsdWVDaGFuZ2UodGhpcy5ldmVudFBhcmFtcygkZXZlbnQpKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc3RhcnRQZW5kaW5nKCkge1xyXG4gICAgICAgIHRoaXMucGVuZGluZyA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5kZy5wZW5kaW5nID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBlbmRQZW5kaW5nKCkge1xyXG4gICAgICAgIHRoaXMucGVuZGluZyA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuZGcucGVuZGluZyA9IGZhbHNlO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==