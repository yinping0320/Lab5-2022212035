/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*
 * @Author: 疯狂秀才(Lucas Huang)
 * @Date: 2019-08-12 11:07:01
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-10-02 15:23:45
 * @QQ: 1055818239
 * @Version: v0.0.1
 */
import { Directive, Renderer2, ElementRef, Input, Injector, NgZone, HostBinding } from '@angular/core';
import { DatagridComponent, ValidatorMessagerService, DatagridFacadeService } from '@farris/ui-datagrid';
export class DatagridBaseEditorDirective {
    /**
     * @param {?} render
     * @param {?} el
     * @param {?} injector
     */
    constructor(render, el, injector) {
        this.render = render;
        this.el = el;
        this.injector = injector;
        this.placeholder = '';
        // 组件高度
        this.height = '';
        this.options = {};
        /**
         * 是否正在向server 发送请求
         */
        this.pending = false;
        /**
         * 禁止事件冒泡
         */
        this.stopPropagation = true;
        /**
         * 默认焦点
         */
        this.focus = true;
        this.validators = [];
        this._inputKeydown = null;
        this._editorClickEvent = null;
        this.cls = 'datagrid-editor';
        this.width = '100%';
        this.focusTimer = null;
        this.eventParams = (/**
         * @param {?} $event
         * @return {?}
         */
        ($event) => {
            /** @type {?} */
            let rowData = null;
            /** @type {?} */
            let rowId = null;
            if (this.dr) {
                rowData = this.dr.rowData;
                rowId = this.dr.rowId;
            }
            return {
                rowData,
                rowId,
                value: $event,
                form: this.group,
                formControl: this.formControl
            };
        });
        this.vms = this.injector.get(ValidatorMessagerService);
        this.dg = this.injector.get(DatagridComponent);
        this.dfs = this.injector.get(DatagridFacadeService);
        this.ngZone = this.injector.get(NgZone);
    }
    /**
     * @return {?}
     */
    get dr() {
        return this.dg.selectedRow.dr;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        if (this.column && this.column.editor) {
            this.options = this.column.editor.options;
            this.validators = this.column.editor.validators || [];
            // 启用任意输入后，字符最大长度属性值验证
            // 当maxLength <= 0 时认为此属性无效
            if (this.options && this.options.nosearch !== undefined && this.options.nosearch) {
                if (this.options.maxLength !== undefined && this.options.maxLength <= 0) {
                    this.options.maxLength = undefined;
                }
            }
        }
        this.clickEvent = this.render.listen(this.el.nativeElement, 'click', (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            e.stopPropagation();
            this.dg['focusElement'] = this.inputElement;
        }));
        this.mouseDownEvent = this.render.listen(this.el.nativeElement, 'mousedown', (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            this._editorClickEvent = e;
        }));
        this.mouseUpEvent = this.render.listen(this.el.nativeElement, 'mouseup', (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            this._editorClickEvent = null;
        }));
        if (this.group) {
            this.formControl = (/** @type {?} */ (this.group.controls[this.column.field]));
        }
        // this.dblClickEvent = this.render.listen(this.el.nativeElement, 'dblclick', (e: MouseEvent) => {
        //     e.stopPropagation();
        //     e.preventDefault();
        // });
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.setFocus();
        if (this['instance']) {
            this['instance'].inDatagrid = true;
        }
        this.setErrorMessage();
        this._inputKeydown = this.render.listen(this.inputElement, 'keydown', (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (e.ctrlKey || e.shiftKey) {
                e.stopPropagation();
            }
        }));
        if (this.formControl) {
            this.formControl.valueChanges.subscribe((/**
             * @param {?} val
             * @return {?}
             */
            (val) => {
                // 记录变更集
                if (!this.formControl.pristine) {
                    /** @type {?} */
                    const rowId = this.dg.selectedRow ? this.dg.selectedRow.id : '';
                    if (rowId) {
                        /** @type {?} */
                        const keyField = this.dg.idField;
                        /** @type {?} */
                        const changeData = { [keyField]: rowId, [this.column.field]: val };
                        this.dfs.appendChanges(changeData);
                    }
                }
                this.setErrorMessage();
            }));
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        if (this.clickEvent) {
            this.clickEvent();
        }
        if (this.dblClickEvent) {
            this.dblClickEvent();
        }
        if (this.mouseDownEvent) {
            this.mouseDownEvent();
        }
        if (this.mouseUpEvent) {
            this.mouseUpEvent();
        }
        if (this.dg) {
            this.dg['focusElement'] = null;
        }
        if (this._inputKeydown) {
            this._inputKeydown();
            this._inputKeydown = null;
            this.inputElement = null;
        }
    }
    /**
     * @private
     * @return {?}
     */
    setErrorMessage() {
        if (this.formControl && this.formControl.invalid) {
            Object.keys(this.formControl.errors).forEach((/**
             * @param {?} key
             * @return {?}
             */
            (key) => {
                this.errorMessage = this.vms.getValidatorErrorMessage(key, this.validators);
            }));
        }
    }
    /**
     * @private
     * @return {?}
     */
    setFocus() {
        if (!this.focus) {
            return;
        }
        if (this.ngZone) {
            this.ngZone.runOutsideAngular((/**
             * @return {?}
             */
            () => {
                if (this.focusTimer) {
                    clearTimeout(this.focusTimer);
                }
                this.focusTimer = setTimeout((/**
                 * @return {?}
                 */
                () => {
                    if (this.inputElement && this.dg.editMode === 'cell') {
                        if (this.dg && this.dg.selectOnEditing) {
                            if (this.inputElement.select) {
                                this.inputElement.select();
                            }
                        }
                        else {
                            this.inputElement.focus();
                        }
                        this.dg['focusElement'] = this.inputElement;
                    }
                }), 10);
            }));
        }
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    onValueChange($event) {
        if (this.options.valueChange) {
            this.options.valueChange(this.eventParams($event));
        }
    }
    /**
     * @return {?}
     */
    startPending() {
        this.pending = true;
        this.dg.pending = true;
    }
    /**
     * @return {?}
     */
    endPending() {
        this.pending = false;
        this.dg.pending = false;
    }
}
DatagridBaseEditorDirective.decorators = [
    { type: Directive, args: [{
                selector: 'datagrid-editor',
            },] }
];
/** @nocollapse */
DatagridBaseEditorDirective.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef },
    { type: Injector }
];
DatagridBaseEditorDirective.propDecorators = {
    placeholder: [{ type: Input }],
    height: [{ type: Input }],
    cls: [{ type: HostBinding, args: ['class',] }],
    width: [{ type: HostBinding, args: ['style.width',] }]
};
if (false) {
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.placeholder;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.height;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.controlId;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.type;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.options;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.group;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.column;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.formControl;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.inputElement;
    /**
     * 是否正在向server 发送请求
     * @type {?}
     */
    DatagridBaseEditorDirective.prototype.pending;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.errorMessage;
    /**
     * 禁止事件冒泡
     * @type {?}
     */
    DatagridBaseEditorDirective.prototype.stopPropagation;
    /**
     * 默认焦点
     * @type {?}
     */
    DatagridBaseEditorDirective.prototype.focus;
    /**
     * @type {?}
     * @private
     */
    DatagridBaseEditorDirective.prototype.clickEvent;
    /**
     * @type {?}
     * @private
     */
    DatagridBaseEditorDirective.prototype.mouseDownEvent;
    /**
     * @type {?}
     * @private
     */
    DatagridBaseEditorDirective.prototype.mouseUpEvent;
    /**
     * @type {?}
     * @private
     */
    DatagridBaseEditorDirective.prototype.dblClickEvent;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.vms;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.dg;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.dfs;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.validators;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.ngZone;
    /**
     * @type {?}
     * @private
     */
    DatagridBaseEditorDirective.prototype._inputKeydown;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype._editorClickEvent;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.cls;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.width;
    /**
     * @type {?}
     * @private
     */
    DatagridBaseEditorDirective.prototype.focusTimer;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.eventParams;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.render;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.el;
    /** @type {?} */
    DatagridBaseEditorDirective.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtYmFzZS1lZGl0b3IuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC1lZGl0b3JzLyIsInNvdXJjZXMiOlsibGliL2RhdGFncmlkLWJhc2UtZWRpdG9yLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFRQSxPQUFPLEVBQUUsU0FBUyxFQUFvQyxTQUFTLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUV4SSxPQUFPLEVBQWMsaUJBQWlCLEVBQUUsd0JBQXdCLEVBQUUscUJBQXFCLEVBQXdCLE1BQU0scUJBQXFCLENBQUM7QUFLM0ksTUFBTSxPQUFPLDJCQUEyQjs7Ozs7O0lBMENwQyxZQUFtQixNQUFpQixFQUFTLEVBQWMsRUFBUyxRQUFrQjtRQUFuRSxXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQVMsT0FBRSxHQUFGLEVBQUUsQ0FBWTtRQUFTLGFBQVEsR0FBUixRQUFRLENBQVU7UUF4QzdFLGdCQUFXLEdBQUcsRUFBRSxDQUFDOztRQUVqQixXQUFNLEdBQUcsRUFBRSxDQUFDO1FBR3JCLFlBQU8sR0FBUSxFQUFFLENBQUM7Ozs7UUFPbEIsWUFBTyxHQUFHLEtBQUssQ0FBQzs7OztRQUtoQixvQkFBZSxHQUFHLElBQUksQ0FBQzs7OztRQUV2QixVQUFLLEdBQUcsSUFBSSxDQUFDO1FBU2IsZUFBVSxHQUFHLEVBQUUsQ0FBQztRQUdSLGtCQUFhLEdBQUcsSUFBSSxDQUFDO1FBRTdCLHNCQUFpQixHQUFlLElBQUksQ0FBQztRQUNmLFFBQUcsR0FBRyxpQkFBaUIsQ0FBQztRQUNsQixVQUFLLEdBQUcsTUFBTSxDQUFDO1FBSW5DLGVBQVUsR0FBRyxJQUFJLENBQUM7UUEwSTFCLGdCQUFXOzs7O1FBQUcsQ0FBQyxNQUFNLEVBQUUsRUFBRTs7Z0JBQ2pCLE9BQU8sR0FBRyxJQUFJOztn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dCI6WyIvKlxyXG4gKiBAQXV0aG9yOiDnlq/ni4Lnp4DmiY0oTHVjYXMgSHVhbmcpXHJcbiAqIEBEYXRlOiAyMDE5LTA4LTEyIDExOjA3OjAxXHJcbiAqIEBMYXN0RWRpdG9yczog55av54uC56eA5omNKEx1Y2FzIEh1YW5nKVxyXG4gKiBATGFzdEVkaXRUaW1lOiAyMDE5LTEwLTAyIDE1OjIzOjQ1XHJcbiAqIEBRUTogMTA1NTgxODIzOVxyXG4gKiBAVmVyc2lvbjogdjAuMC4xXHJcbiAqL1xyXG5pbXBvcnQgeyBEaXJlY3RpdmUsIE9uSW5pdCwgT25EZXN0cm95LCBBZnRlclZpZXdJbml0LCBSZW5kZXJlcjIsIEVsZW1lbnRSZWYsIElucHV0LCBJbmplY3RvciwgTmdab25lLCBIb3N0QmluZGluZ30gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEZvcm1Hcm91cCwgRm9ybUNvbnRyb2wgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XHJcbmltcG9ydCB7IERhdGFDb2x1bW4sIERhdGFncmlkQ29tcG9uZW50LCBWYWxpZGF0b3JNZXNzYWdlclNlcnZpY2UsIERhdGFncmlkRmFjYWRlU2VydmljZSwgRGF0YWdyaWRSb3dEaXJlY3RpdmUgfSBmcm9tICdAZmFycmlzL3VpLWRhdGFncmlkJztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gICAgc2VsZWN0b3I6ICdkYXRhZ3JpZC1lZGl0b3InLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgRGF0YWdyaWRCYXNlRWRpdG9yRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIEFmdGVyVmlld0luaXQge1xyXG5cclxuICAgIEBJbnB1dCgpIHBsYWNlaG9sZGVyID0gJyc7XHJcbiAgICAvLyDnu4Tku7bpq5jluqZcclxuICAgIEBJbnB1dCgpIGhlaWdodCA9ICcnO1xyXG4gICAgY29udHJvbElkOiBzdHJpbmc7XHJcbiAgICB0eXBlOiBzdHJpbmc7XHJcbiAgICBvcHRpb25zOiBhbnkgPSB7fTtcclxuICAgIGdyb3VwOiBGb3JtR3JvdXA7XHJcbiAgICBjb2x1bW46IERhdGFDb2x1bW47XHJcbiAgICBmb3JtQ29udHJvbDogRm9ybUNvbnRyb2w7XHJcblxyXG4gICAgaW5wdXRFbGVtZW50OiBhbnk7XHJcbiAgICAvKiog5piv5ZCm5q2j5Zyo5ZCRc2VydmVyIOWPkemAgeivt+axgiAqL1xyXG4gICAgcGVuZGluZyA9IGZhbHNlO1xyXG5cclxuICAgIGVycm9yTWVzc2FnZTogc3RyaW5nO1xyXG5cclxuICAgIC8qKiDnpoHmraLkuovku7blhpLms6EgKi9cclxuICAgIHN0b3BQcm9wYWdhdGlvbiA9IHRydWU7XHJcbiAgICAvKiog6buY6K6k54Sm54K5ICovXHJcbiAgICBmb2N1cyA9IHRydWU7XHJcblxyXG4gICAgcHJpdmF0ZSBjbGlja0V2ZW50OiBhbnk7XHJcbiAgICBwcml2YXRlIG1vdXNlRG93bkV2ZW50OiBhbnk7XHJcbiAgICBwcml2YXRlIG1vdXNlVXBFdmVudDogYW55O1xyXG4gICAgcHJpdmF0ZSBkYmxDbGlja0V2ZW50OiBhbnk7XHJcbiAgICB2bXM6IFZhbGlkYXRvck1lc3NhZ2VyU2VydmljZTtcclxuICAgIGRnOiBEYXRhZ3JpZENvbXBvbmVudDtcclxuICAgIGRmczogRGF0YWdyaWRGYWNhZGVTZXJ2aWNlO1xyXG4gICAgdmFsaWRhdG9ycyA9IFtdO1xyXG5cclxuICAgIG5nWm9uZTogTmdab25lO1xyXG4gICAgcHJpdmF0ZSBfaW5wdXRLZXlkb3duID0gbnVsbDtcclxuXHJcbiAgICBfZWRpdG9yQ2xpY2tFdmVudDogTW91c2VFdmVudCA9IG51bGw7XHJcbiAgICBASG9zdEJpbmRpbmcoJ2NsYXNzJykgY2xzID0gJ2RhdGFncmlkLWVkaXRvcic7XHJcbiAgICBASG9zdEJpbmRpbmcoJ3N0eWxlLndpZHRoJykgd2lkdGggPSAnMTAwJSc7XHJcbiAgICBnZXQgZHIoKTogRGF0YWdyaWRSb3dEaXJlY3RpdmUge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmRnLnNlbGVjdGVkUm93LmRyO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBmb2N1c1RpbWVyID0gbnVsbDtcclxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyByZW5kZXI6IFJlbmRlcmVyMiwgcHVibGljIGVsOiBFbGVtZW50UmVmLCBwdWJsaWMgaW5qZWN0b3I6IEluamVjdG9yKSB7XHJcbiAgICAgICAgdGhpcy52bXMgPSB0aGlzLmluamVjdG9yLmdldChWYWxpZGF0b3JNZXNzYWdlclNlcnZpY2UpO1xyXG4gICAgICAgIHRoaXMuZGcgPSB0aGlzLmluamVjdG9yLmdldChEYXRhZ3JpZENvbXBvbmVudCk7XHJcbiAgICAgICAgdGhpcy5kZnMgPSB0aGlzLmluamVjdG9yLmdldChEYXRhZ3JpZEZhY2FkZVNlcnZpY2UpO1xyXG4gICAgICAgIHRoaXMubmdab25lID0gdGhpcy5pbmplY3Rvci5nZXQoTmdab25lKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuY29sdW1uICYmIHRoaXMuY29sdW1uLmVkaXRvcikge1xyXG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMgPSB0aGlzLmNvbHVtbi5lZGl0b3Iub3B0aW9ucztcclxuICAgICAgICAgICAgdGhpcy52YWxpZGF0b3JzID0gdGhpcy5jb2x1bW4uZWRpdG9yLnZhbGlkYXRvcnMgfHwgW107XHJcblxyXG4gICAgICAgICAgICAvLyDlkK/nlKjku7vmhI/ovpPlhaXlkI7vvIzlrZfnrKbmnIDlpKfplb/luqblsZ7mgKflgLzpqozor4FcclxuICAgICAgICAgICAgLy8g5b2TbWF4TGVuZ3RoIDw9IDAg5pe26K6k5Li65q2k5bGe5oCn5peg5pWIXHJcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMgJiYgdGhpcy5vcHRpb25zLm5vc2VhcmNoICE9PSB1bmRlZmluZWQgJiYgdGhpcy5vcHRpb25zLm5vc2VhcmNoKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIHRoaXMub3B0aW9ucy5tYXhMZW5ndGggIT09IHVuZGVmaW5lZCAmJiB0aGlzLm9wdGlvbnMubWF4TGVuZ3RoIDw9IDApIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMubWF4TGVuZ3RoID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmNsaWNrRXZlbnQgPSB0aGlzLnJlbmRlci5saXN0ZW4odGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnY2xpY2snLCAoZTogTW91c2VFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICB0aGlzLmRnWydmb2N1c0VsZW1lbnQnXSA9IHRoaXMuaW5wdXRFbGVtZW50O1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLm1vdXNlRG93bkV2ZW50ID0gdGhpcy5yZW5kZXIubGlzdGVuKHRoaXMuZWwubmF0aXZlRWxlbWVudCwgJ21vdXNlZG93bicsIChlOiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuX2VkaXRvckNsaWNrRXZlbnQgPSBlO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLm1vdXNlVXBFdmVudCA9IHRoaXMucmVuZGVyLmxpc3Rlbih0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsICdtb3VzZXVwJywgKGU6IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5fZWRpdG9yQ2xpY2tFdmVudCA9IG51bGw7XHJcbiAgICAgICAgfSk7XHJcblxyXG5cclxuICAgICAgICBpZiAodGhpcy5ncm91cCkge1xyXG4gICAgICAgICAgICB0aGlzLmZvcm1Db250cm9sID0gdGhpcy5ncm91cC5jb250cm9sc1t0aGlzLmNvbHVtbi5maWVsZF0gYXMgRm9ybUNvbnRyb2w7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHRoaXMuZGJsQ2xpY2tFdmVudCA9IHRoaXMucmVuZGVyLmxpc3Rlbih0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsICdkYmxjbGljaycsIChlOiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgLy8gICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgLy8gICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAvLyB9KTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdJbml0KCkge1xyXG4gICAgICAgIHRoaXMuc2V0Rm9jdXMoKTtcclxuICAgICAgICBpZiAodGhpc1snaW5zdGFuY2UnXSkge1xyXG4gICAgICAgICAgICB0aGlzWydpbnN0YW5jZSddLmluRGF0YWdyaWQgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNldEVycm9yTWVzc2FnZSgpO1xyXG5cclxuICAgICAgICB0aGlzLl9pbnB1dEtleWRvd24gPSAgdGhpcy5yZW5kZXIubGlzdGVuKHRoaXMuaW5wdXRFbGVtZW50LCAna2V5ZG93bicsIChlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlLmN0cmxLZXkgfHwgZS5zaGlmdEtleSkge1xyXG4gICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5mb3JtQ29udHJvbCkge1xyXG4gICAgICAgICAgICB0aGlzLmZvcm1Db250cm9sLnZhbHVlQ2hhbmdlcy5zdWJzY3JpYmUoICh2YWw6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8g6K6w5b2V5Y+Y5pu06ZuGXHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuZm9ybUNvbnRyb2wucHJpc3RpbmUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByb3dJZCA9IHRoaXMuZGcuc2VsZWN0ZWRSb3cgPyB0aGlzLmRnLnNlbGVjdGVkUm93LmlkIDogJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJvd0lkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGtleUZpZWxkID0gdGhpcy5kZy5pZEZpZWxkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFuZ2VEYXRhID0geyBba2V5RmllbGRdOiByb3dJZCwgW3RoaXMuY29sdW1uLmZpZWxkXTogdmFsIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGZzLmFwcGVuZENoYW5nZXMoY2hhbmdlRGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRFcnJvck1lc3NhZ2UoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCkge1xyXG4gICAgICAgIGlmICh0aGlzLmNsaWNrRXZlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy5jbGlja0V2ZW50KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmRibENsaWNrRXZlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy5kYmxDbGlja0V2ZW50KCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5tb3VzZURvd25FdmVudCkge1xyXG4gICAgICAgICAgICB0aGlzLm1vdXNlRG93bkV2ZW50KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLm1vdXNlVXBFdmVudCkge1xyXG4gICAgICAgICAgICB0aGlzLm1vdXNlVXBFdmVudCgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuZGcpIHtcclxuICAgICAgICAgICAgdGhpcy5kZ1snZm9jdXNFbGVtZW50J10gPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5faW5wdXRLZXlkb3duKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2lucHV0S2V5ZG93bigpO1xyXG4gICAgICAgICAgICB0aGlzLl9pbnB1dEtleWRvd24gPSBudWxsO1xyXG4gICAgICAgICAgICB0aGlzLmlucHV0RWxlbWVudCA9IG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNldEVycm9yTWVzc2FnZSgpIHtcclxuICAgICAgICBpZiAodGhpcy5mb3JtQ29udHJvbCAmJiB0aGlzLmZvcm1Db250cm9sLmludmFsaWQpIHtcclxuICAgICAgICAgICAgT2JqZWN0LmtleXModGhpcy5mb3JtQ29udHJvbC5lcnJvcnMpLmZvckVhY2goIChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lcnJvck1lc3NhZ2UgPSB0aGlzLnZtcy5nZXRWYWxpZGF0b3JFcnJvck1lc3NhZ2Uoa2V5LCB0aGlzLnZhbGlkYXRvcnMpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZXRGb2N1cygpIHtcclxuICAgICAgICBpZiAoIXRoaXMuZm9jdXMpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMubmdab25lKSB7XHJcbiAgICAgICAgICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmZvY3VzVGltZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5mb2N1c1RpbWVyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlucHV0RWxlbWVudCAmJiB0aGlzLmRnLmVkaXRNb2RlID09PSAnY2VsbCcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGcgJiYgdGhpcy5kZy5zZWxlY3RPbkVkaXRpbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlucHV0RWxlbWVudC5zZWxlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucHV0RWxlbWVudC5zZWxlY3QoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5wdXRFbGVtZW50LmZvY3VzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGdbJ2ZvY3VzRWxlbWVudCddID0gdGhpcy5pbnB1dEVsZW1lbnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSwgMTApO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGV2ZW50UGFyYW1zID0gKCRldmVudCkgPT4ge1xyXG4gICAgICAgIGxldCByb3dEYXRhID0gbnVsbDtcclxuICAgICAgICBsZXQgcm93SWQgPSBudWxsO1xyXG4gICAgICAgIGlmICh0aGlzLmRyKSB7XHJcbiAgICAgICAgICAgIHJvd0RhdGEgPSB0aGlzLmRyLnJvd0RhdGE7XHJcbiAgICAgICAgICAgIHJvd0lkID0gdGhpcy5kci5yb3dJZDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHJvd0RhdGEsXHJcbiAgICAgICAgICAgIHJvd0lkLFxyXG4gICAgICAgICAgICB2YWx1ZTogJGV2ZW50LFxyXG4gICAgICAgICAgICBmb3JtOiB0aGlzLmdyb3VwLFxyXG4gICAgICAgICAgICBmb3JtQ29udHJvbDogdGhpcy5mb3JtQ29udHJvbFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgb25WYWx1ZUNoYW5nZSgkZXZlbnQpIHtcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLnZhbHVlQ2hhbmdlKSB7XHJcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy52YWx1ZUNoYW5nZSh0aGlzLmV2ZW50UGFyYW1zKCRldmVudCkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzdGFydFBlbmRpbmcoKSB7XHJcbiAgICAgICAgdGhpcy5wZW5kaW5nID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLmRnLnBlbmRpbmcgPSB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIGVuZFBlbmRpbmcoKSB7XHJcbiAgICAgICAgdGhpcy5wZW5kaW5nID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5kZy5wZW5kaW5nID0gZmFsc2U7XHJcbiAgICB9XHJcbn1cclxuIl19