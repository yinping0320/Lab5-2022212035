/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { debounceTime } from 'rxjs/operators';
import { Injector } from '@angular/core';
/*
 * @Author: 疯狂秀才(Lucas Huang)
 * @Date: 2019-08-14 11:41:00
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-10-14 13:00:48
 * @QQ: 1055818239
 * @Version: v0.0.1
 */
import { Component, Renderer2, ElementRef, ViewChild } from '@angular/core';
import { DatagridBaseEditorDirective } from '../datagrid-base-editor.directive';
import { LookupDefaultOptions } from '../editor-default-options';
import { LookupGridComponent } from '@farris/ui-lookup';
import { RuntimeStateService } from '@farris/ui-common';
// 
export class DatagridLookupComponent extends DatagridBaseEditorDirective {
    /**
     * @param {?} render
     * @param {?} el
     * @param {?} rts
     * @param {?} injector
     */
    constructor(render, el, rts, injector) {
        super(render, el, injector);
        this.rts = rts;
        this.stopPropagation = false;
        this.extInfoFormatter = (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (this.options.extInfoFormatter) {
                return this.options.extInfoFormatter({ bindingData: this.dr.rowData, instance: e.instance });
            }
            return '';
        });
    }
    /**
     * @param {?} id
     * @return {?}
     */
    set controlId(id) {
        this.instance.controlId = id;
        if (this.instance.uri) {
            this.instance.controlId += '_' + this.instance.uri;
        }
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        super.ngOnInit();
        if (!this.options.valueField) {
            this.options.valueField = this.options.idField;
        }
        if (this.options.showNavigation === undefined || this.options.showNavigation === null) {
            this.options.showNavigation = true;
        }
        this.options = Object.assign({}, LookupDefaultOptions, this.options);
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.instance.changeDetector.detectChanges();
        if (this.options.viewType === 'tag') {
            this.inputElement = this.instance.tagbox.nativeElement;
        }
        else {
            this.inputElement = this.instance.inputGroup.textbox.nativeElement;
        }
        super.ngAfterViewInit();
        if (this.options.loader) {
            if (this.instance['http']) {
                /** @type {?} */
                const getDataFn = this.instance['http'];
                this.instance['http'] = Object.assign({}, getDataFn, { getData: this.options.loader });
            }
            else {
                this.instance['http'] = { getData: this.options.loader };
            }
        }
        this.instance['host'] = this.dg;
        this.rts.state$.pipe(debounceTime(10)).subscribe((/**
         * @param {?} state
         * @return {?}
         */
        state => {
            if (state && state.form && state.form.lookup && this.dg) {
                this.pending = state.form.lookup.pending;
                this.dg.pending = this.pending;
            }
        }));
    }
    /**
     * @return {?}
     */
    onDialogClosed() {
        // this.lookup.changeDetector.detectChanges();
    }
    /**
     * @return {?}
     */
    onDialogOpen() {
        this.instance.changeDetector.detectChanges();
    }
    /**
     * @return {?}
     */
    onLoadSuccess() {
        this.instance.changeDetector.detectChanges();
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onClear(event) {
        // const rowData = this.instance.selectionMgr.getBindingData();
        // this.instance['defaultMapping'].lookupFieldMap(null, this.instance.mapFields, rowData);
        this.instance.changeDetector.detectChanges();
        if (this.options.clear) {
            this.options.clear();
        }
    }
    /**
     * @param {?} $evnet
     * @return {?}
     */
    onTagRemoved($evnet) {
        if (this.options.tagRemoved) {
            this.options.tagRemoved($evnet);
        }
    }
}
DatagridLookupComponent.decorators = [
    { type: Component, args: [{
                selector: 'grid-editor-lookup',
                template: `
    <div [formGroup]="group" class="f-datagrid-cell-formgroup farris-group-auto">
        <datagrid-tooltip [control]="formControl" [tooltipPosition]="'top-left'" [message]="errorMessage">
            <farris-lookup-grid #lookup style="width: 100%"
                id="{{ controlId }}"
                [formControlName]="column.field"
                [uri]="options.uri"
                [helpId]="options.helpId"
                [displayType]="options.displayType"
                [singleSelect]="options.singleSelect"
                [idField]="options.idField"
                [pageSize]="options.pageSize || 20"
                [pageIndex]="options.pageSize || 1"
                [pagination]="options.pageination"
                [textField]="options.textField"
                [valueField]="options.valueField"
                [title]="options.title"
                [useFavorite]="options.useFavorite"
                [isRecordSize]="options.isRecordSize"
                [useTip]="options.useTip"
                [editable]="options.editable"
                [readonly]="options.readonly"
                [dialogWidth]="options.dialogWidth"
                [dialogHeight]="options.dialogHeight"
                [showMaxButton]="options.showMaxButton"
                [showCloseButton]="options.showCloseButton"
                [resizable]="options.resizable"
                [buttonAlign]="options.buttonAlign"
                [enableClear]="options.enableClear"
                [searchOnServer]="options.searchOnServer"
                [nosearch]="options.nosearch"
                [maxLength]="options.maxLength"
                [mappingFn]="options.mappingFn"
                [mapFields]="options.mapFields"
                [context]="options.context"
                [expandLevel]="options.expandLevel"
                [dictPicking]="options.dictPicking"
                [dictPicked]="options.dictPicked"
                [enableFullTree]="options.enableFullTree"
                [loadTreeDataType]="options.loadTreeDataType"
                [enableCascade]="options.enableCascade"
                [cascadeStatus]="options.cascadeStatus"
                [useExtendInfo]="options.useExtendInfo"
                [extInfoFields]="options.extInfoFields"
                [extInfoFormatter]="options.extInfoFormatter"
                [textAlign]="options.textAlign"
                [loadDataWhenOpen]="options.loadDataWhenOpen"
                [selectFirstInNav]="options.selectFirstInNav"
                [customNavFormatter]="options.customNavFormatter"
                [customFormatter]="options.customFormatter"
                [treeInfo]="options?.treeInfo"
                [treeTableOptions]="options?.treeTableOptions"
                [showCheckAll]="options?.showCheckAll"
                [viewType]="options?.viewType"
                [quickSelect]="options?.quickSelect"
                [treeToList]="options?.treeToList"
                [navTreeToList]="options?.navTreeToList"
                [showCascadeControl]="options.showCascadeControl"
                [showNavigation]="options.showNavigation"
                [showSelected]="options.showSelected"
                [beforeLoadData]="options.beforeLoadData"
                [beforeSelectData]="options.beforeSelectData"
                [searchBarMode]="options.searchBarMode"
                [enableMultiFieldSearch]="options.enableMultiFieldSearch"
                [useNewLayout]="options.useNewLayout"
                (dialogClosed)="onDialogClosed()"
                (dialogOpened)="onDialogOpen()"
                (clear)="onClear($event)"
                (loadSuccess)="onLoadSuccess()"
                (tagRemoved)="onTagRemoved($event)"
                [multipleChoiceSeparator]="options.multipleChoiceSeparator"
                [labels]="options.labels"
                [allowQueryFields]="options.allowQueryFields"
            ></farris-lookup-grid>
        </datagrid-tooltip>
    </div>
    `
            }] }
];
/** @nocollapse */
DatagridLookupComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef },
    { type: RuntimeStateService },
    { type: Injector }
];
DatagridLookupComponent.propDecorators = {
    instance: [{ type: ViewChild, args: ['lookup',] }]
};
if (false) {
    /** @type {?} */
    DatagridLookupComponent.prototype.instance;
    /** @type {?} */
    DatagridLookupComponent.prototype.stopPropagation;
    /** @type {?} */
    DatagridLookupComponent.prototype.extInfoFormatter;
    /**
     * @type {?}
     * @private
     */
    DatagridLookupComponent.prototype.rts;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtbG9va3VwLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0YWdyaWQtZWRpdG9ycy8iLCJzb3VyY2VzIjpbImxpYi9lZGl0b3JzL2RhdGFncmlkLWxvb2t1cC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5QyxPQUFPLEVBQXFELFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQzs7Ozs7Ozs7O0FBUzVGLE9BQU8sRUFBRSxTQUFTLEVBQVUsU0FBUyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDcEYsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFDaEYsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDakUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDeEQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7O0FBb0Z4RCxNQUFNLE9BQU8sdUJBQXdCLFNBQVEsMkJBQTJCOzs7Ozs7O0lBWXBFLFlBQVksTUFBaUIsRUFBRSxFQUFjLEVBQVUsR0FBd0IsRUFDbkUsUUFBa0I7UUFDMUIsS0FBSyxDQUFDLE1BQU0sRUFBRSxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFGdUIsUUFBRyxHQUFILEdBQUcsQ0FBcUI7UUFEL0Usb0JBQWUsR0FBRyxLQUFLLENBQUM7UUE2RXhCLHFCQUFnQjs7OztRQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDckIsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFO2dCQUMvQixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxXQUFXLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsUUFB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QUFDOzs7O0lBRUQsWUFBWTtRQUNSLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ2pELENBQUM7Ozs7SUFFRCxhQUFhO1FBQ1QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDakQsQ0FBQzs7Ozs7SUFFRCxPQUFPLENBQUMsS0FBaUI7UUFDckIsK0RBQStEO1FBQy9ELDBGQUEwRjtRQUUxRixJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUM3QyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFO1lBQ3BCLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDeEI7SUFDTCxDQUFDOzs7OztJQUVELFlBQVksQ0FBQyxNQUFNO1FBQ2YsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRTtZQUN6QixJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNuQztJQUNMLENBQUM7OztZQXRLSixTQUFTLFNBQUM7Z0JBQ1AsUUFBUSxFQUFFLG9CQUFvQjtnQkFDOUIsUUFBUSxFQUFFOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0tBNEVUO2FBQ0o7Ozs7WUF2RjJCLFNBQVM7WUFBRSxVQUFVO1lBSXhDLG1CQUFtQjtZQWJnQyxRQUFROzs7dUJBa0cvRCxTQUFTLFNBQUMsUUFBUTs7OztJQUFuQiwyQ0FBbUQ7O0lBVW5ELGtEQUF3Qjs7SUE2RXhCLG1EQU1DOzs7OztJQWxGOEMsc0NBQWdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGVib3VuY2VUaW1lIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBBZnRlclZpZXdJbml0LCBBcHBsaWNhdGlvblJlZiwgSW5qZWN0LCBmb3J3YXJkUmVmLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG4vKlxyXG4gKiBAQXV0aG9yOiDnlq/ni4Lnp4DmiY0oTHVjYXMgSHVhbmcpXHJcbiAqIEBEYXRlOiAyMDE5LTA4LTE0IDExOjQxOjAwXHJcbiAqIEBMYXN0RWRpdG9yczog55av54uC56eA5omNKEx1Y2FzIEh1YW5nKVxyXG4gKiBATGFzdEVkaXRUaW1lOiAyMDE5LTEwLTE0IDEzOjAwOjQ4XHJcbiAqIEBRUTogMTA1NTgxODIzOVxyXG4gKiBAVmVyc2lvbjogdjAuMC4xXHJcbiAqL1xyXG5pbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgUmVuZGVyZXIyLCBFbGVtZW50UmVmLCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRGF0YWdyaWRCYXNlRWRpdG9yRGlyZWN0aXZlIH0gZnJvbSAnLi4vZGF0YWdyaWQtYmFzZS1lZGl0b3IuZGlyZWN0aXZlJztcclxuaW1wb3J0IHsgTG9va3VwRGVmYXVsdE9wdGlvbnMgfSBmcm9tICcuLi9lZGl0b3ItZGVmYXVsdC1vcHRpb25zJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktbG9va3VwJztcclxuaW1wb3J0IHsgUnVudGltZVN0YXRlU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktY29tbW9uJztcclxuXHJcblxyXG4vLyBcclxuQENvbXBvbmVudCh7XHJcbiAgICBzZWxlY3RvcjogJ2dyaWQtZWRpdG9yLWxvb2t1cCcsXHJcbiAgICB0ZW1wbGF0ZTogYFxyXG4gICAgPGRpdiBbZm9ybUdyb3VwXT1cImdyb3VwXCIgY2xhc3M9XCJmLWRhdGFncmlkLWNlbGwtZm9ybWdyb3VwIGZhcnJpcy1ncm91cC1hdXRvXCI+XHJcbiAgICAgICAgPGRhdGFncmlkLXRvb2x0aXAgW2NvbnRyb2xdPVwiZm9ybUNvbnRyb2xcIiBbdG9vbHRpcFBvc2l0aW9uXT1cIid0b3AtbGVmdCdcIiBbbWVzc2FnZV09XCJlcnJvck1lc3NhZ2VcIj5cclxuICAgICAgICAgICAgPGZhcnJpcy1sb29rdXAtZ3JpZCAjbG9va3VwIHN0eWxlPVwid2lkdGg6IDEwMCVcIlxyXG4gICAgICAgICAgICAgICAgaWQ9XCJ7eyBjb250cm9sSWQgfX1cIlxyXG4gICAgICAgICAgICAgICAgW2Zvcm1Db250cm9sTmFtZV09XCJjb2x1bW4uZmllbGRcIlxyXG4gICAgICAgICAgICAgICAgW3VyaV09XCJvcHRpb25zLnVyaVwiXHJcbiAgICAgICAgICAgICAgICBbaGVscElkXT1cIm9wdGlvbnMuaGVscElkXCJcclxuICAgICAgICAgICAgICAgIFtkaXNwbGF5VHlwZV09XCJvcHRpb25zLmRpc3BsYXlUeXBlXCJcclxuICAgICAgICAgICAgICAgIFtzaW5nbGVTZWxlY3RdPVwib3B0aW9ucy5zaW5nbGVTZWxlY3RcIlxyXG4gICAgICAgICAgICAgICAgW2lkRmllbGRdPVwib3B0aW9ucy5pZEZpZWxkXCJcclxuICAgICAgICAgICAgICAgIFtwYWdlU2l6ZV09XCJvcHRpb25zLnBhZ2VTaXplIHx8IDIwXCJcclxuICAgICAgICAgICAgICAgIFtwYWdlSW5kZXhdPVwib3B0aW9ucy5wYWdlU2l6ZSB8fCAxXCJcclxuICAgICAgICAgICAgICAgIFtwYWdpbmF0aW9uXT1cIm9wdGlvbnMucGFnZWluYXRpb25cIlxyXG4gICAgICAgICAgICAgICAgW3RleHRGaWVsZF09XCJvcHRpb25zLnRleHRGaWVsZFwiXHJcbiAgICAgICAgICAgICAgICBbdmFsdWVGaWVsZF09XCJvcHRpb25zLnZhbHVlRmllbGRcIlxyXG4gICAgICAgICAgICAgICAgW3RpdGxlXT1cIm9wdGlvbnMudGl0bGVcIlxyXG4gICAgICAgICAgICAgICAgW3VzZUZhdm9yaXRlXT1cIm9wdGlvbnMudXNlRmF2b3JpdGVcIlxyXG4gICAgICAgICAgICAgICAgW2lzUmVjb3JkU2l6ZV09XCJvcHRpb25zLmlzUmVjb3JkU2l6ZVwiXHJcbiAgICAgICAgICAgICAgICBbdXNlVGlwXT1cIm9wdGlvbnMudXNlVGlwXCJcclxuICAgICAgICAgICAgICAgIFtlZGl0YWJsZV09XCJvcHRpb25zLmVkaXRhYmxlXCJcclxuICAgICAgICAgICAgICAgIFtyZWFkb25seV09XCJvcHRpb25zLnJlYWRvbmx5XCJcclxuICAgICAgICAgICAgICAgIFtkaWFsb2dXaWR0aF09XCJvcHRpb25zLmRpYWxvZ1dpZHRoXCJcclxuICAgICAgICAgICAgICAgIFtkaWFsb2dIZWlnaHRdPVwib3B0aW9ucy5kaWFsb2dIZWlnaHRcIlxyXG4gICAgICAgICAgICAgICAgW3Nob3dNYXhCdXR0b25dPVwib3B0aW9ucy5zaG93TWF4QnV0dG9uXCJcclxuICAgICAgICAgICAgICAgIFtzaG93Q2xvc2VCdXR0b25dPVwib3B0aW9ucy5zaG93Q2xvc2VCdXR0b25cIlxyXG4gICAgICAgICAgICAgICAgW3Jlc2l6YWJsZV09XCJvcHRpb25zLnJlc2l6YWJsZVwiXHJcbiAgICAgICAgICAgICAgICBbYnV0dG9uQWxpZ25dPVwib3B0aW9ucy5idXR0b25BbGlnblwiXHJcbiAgICAgICAgICAgICAgICBbZW5hYmxlQ2xlYXJdPVwib3B0aW9ucy5lbmFibGVDbGVhclwiXHJcbiAgICAgICAgICAgICAgICBbc2VhcmNoT25TZXJ2ZXJdPVwib3B0aW9ucy5zZWFyY2hPblNlcnZlclwiXHJcbiAgICAgICAgICAgICAgICBbbm9zZWFyY2hdPVwib3B0aW9ucy5ub3NlYXJjaFwiXHJcbiAgICAgICAgICAgICAgICBbbWF4TGVuZ3RoXT1cIm9wdGlvbnMubWF4TGVuZ3RoXCJcclxuICAgICAgICAgICAgICAgIFttYXBwaW5nRm5dPVwib3B0aW9ucy5tYXBwaW5nRm5cIlxyXG4gICAgICAgICAgICAgICAgW21hcEZpZWxkc109XCJvcHRpb25zLm1hcEZpZWxkc1wiXHJcbiAgICAgICAgICAgICAgICBbY29udGV4dF09XCJvcHRpb25zLmNvbnRleHRcIlxyXG4gICAgICAgICAgICAgICAgW2V4cGFuZExldmVsXT1cIm9wdGlvbnMuZXhwYW5kTGV2ZWxcIlxyXG4gICAgICAgICAgICAgICAgW2RpY3RQaWNraW5nXT1cIm9wdGlvbnMuZGljdFBpY2tpbmdcIlxyXG4gICAgICAgICAgICAgICAgW2RpY3RQaWNrZWRdPVwib3B0aW9ucy5kaWN0UGlja2VkXCJcclxuICAgICAgICAgICAgICAgIFtlbmFibGVGdWxsVHJlZV09XCJvcHRpb25zLmVuYWJsZUZ1bGxUcmVlXCJcclxuICAgICAgICAgICAgICAgIFtsb2FkVHJlZURhdGFUeXBlXT1cIm9wdGlvbnMubG9hZFRyZWVEYXRhVHlwZVwiXHJcbiAgICAgICAgICAgICAgICBbZW5hYmxlQ2FzY2FkZV09XCJvcHRpb25zLmVuYWJsZUNhc2NhZGVcIlxyXG4gICAgICAgICAgICAgICAgW2Nhc2NhZGVTdGF0dXNdPVwib3B0aW9ucy5jYXNjYWRlU3RhdHVzXCJcclxuICAgICAgICAgICAgICAgIFt1c2VFeHRlbmRJbmZvXT1cIm9wdGlvbnMudXNlRXh0ZW5kSW5mb1wiXHJcbiAgICAgICAgICAgICAgICBbZXh0SW5mb0ZpZWxkc109XCJvcHRpb25zLmV4dEluZm9GaWVsZHNcIlxyXG4gICAgICAgICAgICAgICAgW2V4dEluZm9Gb3JtYXR0ZXJdPVwib3B0aW9ucy5leHRJbmZvRm9ybWF0dGVyXCJcclxuICAgICAgICAgICAgICAgIFt0ZXh0QWxpZ25dPVwib3B0aW9ucy50ZXh0QWxpZ25cIlxyXG4gICAgICAgICAgICAgICAgW2xvYWREYXRhV2hlbk9wZW5dPVwib3B0aW9ucy5sb2FkRGF0YVdoZW5PcGVuXCJcclxuICAgICAgICAgICAgICAgIFtzZWxlY3RGaXJzdEluTmF2XT1cIm9wdGlvbnMuc2VsZWN0Rmlyc3RJbk5hdlwiXHJcbiAgICAgICAgICAgICAgICBbY3VzdG9tTmF2Rm9ybWF0dGVyXT1cIm9wdGlvbnMuY3VzdG9tTmF2Rm9ybWF0dGVyXCJcclxuICAgICAgICAgICAgICAgIFtjdXN0b21Gb3JtYXR0ZXJdPVwib3B0aW9ucy5jdXN0b21Gb3JtYXR0ZXJcIlxyXG4gICAgICAgICAgICAgICAgW3RyZWVJbmZvXT1cIm9wdGlvbnM/LnRyZWVJbmZvXCJcclxuICAgICAgICAgICAgICAgIFt0cmVlVGFibGVPcHRpb25zXT1cIm9wdGlvbnM/LnRyZWVUYWJsZU9wdGlvbnNcIlxyXG4gICAgICAgICAgICAgICAgW3Nob3dDaGVja0FsbF09XCJvcHRpb25zPy5zaG93Q2hlY2tBbGxcIlxyXG4gICAgICAgICAgICAgICAgW3ZpZXdUeXBlXT1cIm9wdGlvbnM/LnZpZXdUeXBlXCJcclxuICAgICAgICAgICAgICAgIFtxdWlja1NlbGVjdF09XCJvcHRpb25zPy5xdWlja1NlbGVjdFwiXHJcbiAgICAgICAgICAgICAgICBbdHJlZVRvTGlzdF09XCJvcHRpb25zPy50cmVlVG9MaXN0XCJcclxuICAgICAgICAgICAgICAgIFtuYXZUcmVlVG9MaXN0XT1cIm9wdGlvbnM/Lm5hdlRyZWVUb0xpc3RcIlxyXG4gICAgICAgICAgICAgICAgW3Nob3dDYXNjYWRlQ29udHJvbF09XCJvcHRpb25zLnNob3dDYXNjYWRlQ29udHJvbFwiXHJcbiAgICAgICAgICAgICAgICBbc2hvd05hdmlnYXRpb25dPVwib3B0aW9ucy5zaG93TmF2aWdhdGlvblwiXHJcbiAgICAgICAgICAgICAgICBbc2hvd1NlbGVjdGVkXT1cIm9wdGlvbnMuc2hvd1NlbGVjdGVkXCJcclxuICAgICAgICAgICAgICAgIFtiZWZvcmVMb2FkRGF0YV09XCJvcHRpb25zLmJlZm9yZUxvYWREYXRhXCJcclxuICAgICAgICAgICAgICAgIFtiZWZvcmVTZWxlY3REYXRhXT1cIm9wdGlvbnMuYmVmb3JlU2VsZWN0RGF0YVwiXHJcbiAgICAgICAgICAgICAgICBbc2VhcmNoQmFyTW9kZV09XCJvcHRpb25zLnNlYXJjaEJhck1vZGVcIlxyXG4gICAgICAgICAgICAgICAgW2VuYWJsZU11bHRpRmllbGRTZWFyY2hdPVwib3B0aW9ucy5lbmFibGVNdWx0aUZpZWxkU2VhcmNoXCJcclxuICAgICAgICAgICAgICAgIFt1c2VOZXdMYXlvdXRdPVwib3B0aW9ucy51c2VOZXdMYXlvdXRcIlxyXG4gICAgICAgICAgICAgICAgKGRpYWxvZ0Nsb3NlZCk9XCJvbkRpYWxvZ0Nsb3NlZCgpXCJcclxuICAgICAgICAgICAgICAgIChkaWFsb2dPcGVuZWQpPVwib25EaWFsb2dPcGVuKClcIlxyXG4gICAgICAgICAgICAgICAgKGNsZWFyKT1cIm9uQ2xlYXIoJGV2ZW50KVwiXHJcbiAgICAgICAgICAgICAgICAobG9hZFN1Y2Nlc3MpPVwib25Mb2FkU3VjY2VzcygpXCJcclxuICAgICAgICAgICAgICAgICh0YWdSZW1vdmVkKT1cIm9uVGFnUmVtb3ZlZCgkZXZlbnQpXCJcclxuICAgICAgICAgICAgICAgIFttdWx0aXBsZUNob2ljZVNlcGFyYXRvcl09XCJvcHRpb25zLm11bHRpcGxlQ2hvaWNlU2VwYXJhdG9yXCJcclxuICAgICAgICAgICAgICAgIFtsYWJlbHNdPVwib3B0aW9ucy5sYWJlbHNcIlxyXG4gICAgICAgICAgICAgICAgW2FsbG93UXVlcnlGaWVsZHNdPVwib3B0aW9ucy5hbGxvd1F1ZXJ5RmllbGRzXCJcclxuICAgICAgICAgICAgPjwvZmFycmlzLWxvb2t1cC1ncmlkPlxyXG4gICAgICAgIDwvZGF0YWdyaWQtdG9vbHRpcD5cclxuICAgIDwvZGl2PlxyXG4gICAgYCxcclxufSlcclxuZXhwb3J0IGNsYXNzIERhdGFncmlkTG9va3VwQ29tcG9uZW50IGV4dGVuZHMgRGF0YWdyaWRCYXNlRWRpdG9yRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcclxuICAgIEBWaWV3Q2hpbGQoJ2xvb2t1cCcpIGluc3RhbmNlOiBMb29rdXBHcmlkQ29tcG9uZW50O1xyXG5cclxuXHJcbiAgICBzZXQgY29udHJvbElkKGlkKSB7XHJcbiAgICAgICAgdGhpcy5pbnN0YW5jZS5jb250cm9sSWQgPSBpZDtcclxuICAgICAgICBpZiAodGhpcy5pbnN0YW5jZS51cmkpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnN0YW5jZS5jb250cm9sSWQgKz0gJ18nICsgdGhpcy5pbnN0YW5jZS51cmk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHN0b3BQcm9wYWdhdGlvbiA9IGZhbHNlO1xyXG4gICAgY29uc3RydWN0b3IocmVuZGVyOiBSZW5kZXJlcjIsIGVsOiBFbGVtZW50UmVmLCBwcml2YXRlIHJ0czogUnVudGltZVN0YXRlU2VydmljZSxcclxuICAgICAgICAgICAgICAgIGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gICAgICAgIHN1cGVyKHJlbmRlciwgZWwsIGluamVjdG9yKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgICAgICBzdXBlci5uZ09uSW5pdCgpO1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy52YWx1ZUZpZWxkKSB7XHJcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy52YWx1ZUZpZWxkID0gdGhpcy5vcHRpb25zLmlkRmllbGRcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMuc2hvd05hdmlnYXRpb24gPT09IHVuZGVmaW5lZCB8fCB0aGlzLm9wdGlvbnMuc2hvd05hdmlnYXRpb24gPT09IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zLnNob3dOYXZpZ2F0aW9uID0gdHJ1ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oIHt9ICwgTG9va3VwRGVmYXVsdE9wdGlvbnMsIHRoaXMub3B0aW9ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdJbml0KCkge1xyXG4gICAgICAgIHRoaXMuaW5zdGFuY2UuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMudmlld1R5cGUgPT09ICd0YWcnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5wdXRFbGVtZW50ID0gdGhpcy5pbnN0YW5jZS50YWdib3gubmF0aXZlRWxlbWVudDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmlucHV0RWxlbWVudCA9IHRoaXMuaW5zdGFuY2UuaW5wdXRHcm91cC50ZXh0Ym94Lm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHN1cGVyLm5nQWZ0ZXJWaWV3SW5pdCgpO1xyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9hZGVyKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmluc3RhbmNlWydodHRwJ10pIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGdldERhdGFGbiA9IHRoaXMuaW5zdGFuY2VbJ2h0dHAnXTtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zdGFuY2VbJ2h0dHAnXSA9IHsuLi5nZXREYXRhRm4sIGdldERhdGE6IHRoaXMub3B0aW9ucy5sb2FkZXJ9O1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnN0YW5jZVsnaHR0cCddID0ge2dldERhdGE6IHRoaXMub3B0aW9ucy5sb2FkZXJ9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmluc3RhbmNlWydob3N0J10gPSB0aGlzLmRnO1xyXG5cclxuICAgICAgICB0aGlzLnJ0cy5zdGF0ZSQucGlwZShcclxuICAgICAgICAgICAgZGVib3VuY2VUaW1lKDEwKVxyXG4gICAgICAgICkuc3Vic2NyaWJlKHN0YXRlID0+IHtcclxuICAgICAgICAgICAgaWYgKHN0YXRlICYmIHN0YXRlLmZvcm0gJiYgc3RhdGUuZm9ybS5sb29rdXAgJiYgdGhpcy5kZykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wZW5kaW5nID0gc3RhdGUuZm9ybS5sb29rdXAucGVuZGluZztcclxuICAgICAgICAgICAgICAgIHRoaXMuZGcucGVuZGluZyA9IHRoaXMucGVuZGluZztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIG9uRGlhbG9nQ2xvc2VkKCkge1xyXG4gICAgICAgIC8vIHRoaXMubG9va3VwLmNoYW5nZURldGVjdG9yLmRldGVjdENoYW5nZXMoKTtcclxuICAgIH1cclxuXHJcbiAgICBvbkRpYWxvZ09wZW4oKSB7XHJcbiAgICAgICAgdGhpcy5pbnN0YW5jZS5jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgb25Mb2FkU3VjY2VzcygpIHtcclxuICAgICAgICB0aGlzLmluc3RhbmNlLmNoYW5nZURldGVjdG9yLmRldGVjdENoYW5nZXMoKTtcclxuICAgIH1cclxuXHJcbiAgICBvbkNsZWFyKGV2ZW50OiBNb3VzZUV2ZW50KSB7XHJcbiAgICAgICAgLy8gY29uc3Qgcm93RGF0YSA9IHRoaXMuaW5zdGFuY2Uuc2VsZWN0aW9uTWdyLmdldEJpbmRpbmdEYXRhKCk7XHJcbiAgICAgICAgLy8gdGhpcy5pbnN0YW5jZVsnZGVmYXVsdE1hcHBpbmcnXS5sb29rdXBGaWVsZE1hcChudWxsLCB0aGlzLmluc3RhbmNlLm1hcEZpZWxkcywgcm93RGF0YSk7XHJcblxyXG4gICAgICAgIHRoaXMuaW5zdGFuY2UuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMuY2xlYXIpIHtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zLmNsZWFyKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG9uVGFnUmVtb3ZlZCgkZXZuZXQpIHtcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLnRhZ1JlbW92ZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zLnRhZ1JlbW92ZWQoJGV2bmV0KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZXh0SW5mb0Zvcm1hdHRlciA9IChlKSA9PiB7XHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5leHRJbmZvRm9ybWF0dGVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuZXh0SW5mb0Zvcm1hdHRlcih7IGJpbmRpbmdEYXRhOiB0aGlzLmRyLnJvd0RhdGEsIGluc3RhbmNlOiBlLmluc3RhbmNlIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==