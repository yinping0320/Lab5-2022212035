import { Injectable } from '@angular/core';
import { StateMachine } from './state_machine';
/**
 * 状态机事件，监听uistate的变化和entity的变化
 */
export class StateMachineEvent {
    constructor(stateMachine) {
        this.stateMachine = stateMachine;
        this.uiFieldList = [];
        this.dataFieldList = [];
        this.frameContextMap = new Map();
        this.dataFrameContextMap = new Map();
    }
    get appContext() {
        return this.stateMachine.appContext;
    }
    initialize(frameContext) {
        this.frameContext = frameContext;
    }
    /**
     * 暂时把这个方法放了这个地方，等季老师共用方法调整后，直接引用他的方法，该方法可删除
     */
    extractPaths(expression) {
        let path = '';
        const UI_STATE_PATTERN_G = /\{UISTATE~(\S+?)\}$/g;
        const DATA_PATTERN_G = /\{DATA~(\S+?)\}$/g;
        if (typeof expression === 'string') {
            const uiStateVariables = expression.match(UI_STATE_PATTERN_G);
            const dataVariables = expression.match(DATA_PATTERN_G);
            if (uiStateVariables !== null) {
                const UI_STATE_PATTERN = /\{UISTATE~(\S+?)\}$/;
                uiStateVariables.forEach((uiStateVariable) => {
                    const pathMatches = uiStateVariable.match(UI_STATE_PATTERN);
                    if (pathMatches != null && pathMatches.length === 2) {
                        path = pathMatches[1];
                    }
                });
            }
            if (dataVariables !== null) {
                const DATA_PATTERN = /\{DATA~(\S+?)\}$/;
                dataVariables.forEach((dataVariable) => {
                    const pathMatches = dataVariable.match(DATA_PATTERN);
                    if (pathMatches != null && pathMatches.length === 2) {
                        path = pathMatches[1];
                    }
                });
            }
        }
        return path;
    }
    // 根据表达式返回当前组件的frameContext
    getFrameContext(expression) {
        let frameId = this.extractPaths(expression).split('/')[1] || '';
        if (frameId.startsWith('#{') && frameId.endsWith('}') && this.frameContext) {
            const relativeFrameId = frameId.substring(2, frameId.length - 1);
            frameId = this.frameContext.namespace ? `${this.frameContext.namespace}_${relativeFrameId}` : relativeFrameId;
        }
        return this.appContext.getFrameContext(frameId);
    }
    // 根据表达式返回当前组件的字段(可能是实体字段也可能是uistate的字段)
    getFrameField(expression) {
        return this.extractPaths(expression).split('/')[2];
    }
    // 监听表单变量的变化
    ListenUIStateChange(frameContext, expression) {
        const frameField = this.getFrameField(expression);
        if (!this.frameContextMap.has(frameContext)) {
            this.frameContextMap.set(frameContext, this.uiFieldList);
            frameContext.uiState.changes.subscribe((data) => {
                if (data.field && this.frameContextMap.get(frameContext).indexOf(data.field) > -1) {
                    this.stateMachine.render();
                }
            });
        }
        if (this.frameContextMap.get(frameContext).indexOf(frameField) === -1) {
            this.uiFieldList.push(frameField);
        }
    }
    // 监听实体数据的变化
    ListenEntityChange(frameContext, expression) {
        if (!this.dataFrameContextMap.has(frameContext)) {
            this.dataFrameContextMap.set(frameContext, this.dataFieldList);
            frameContext.bindingData.changes.subscribe((change) => {
                // 切换当前行用到的是
                if (change.type === 'Load' || change.type === 'SelectionChanged') {
                    this.stateMachine.render();
                }
                if (change.path.join() && this.isAccordingValue(this.dataFrameContextMap.get(frameContext), change.path.join('/'))) {
                    this.stateMachine.render();
                }
            });
        }
        if (this.dataFrameContextMap.get(frameContext).indexOf(expression) === -1) {
            this.dataFieldList.push(expression);
        }
    }
    // 监听是否是解析的数据发生变化
    isAccordingValue(arr, path) {
        return arr.find(item => {
            return item.indexOf(path) > -1;
        }) === undefined ? false : true;
    }
}
StateMachineEvent.decorators = [
    { type: Injectable }
];
/** @nocollapse */
StateMachineEvent.ctorParameters = () => [
    { type: StateMachine }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVfbWFjaGluZV9ldmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3N0YXRlLW1hY2hpbmUvc3RhdGVfbWFjaGluZV9ldmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUsvQzs7R0FFRztBQUVILE1BQU0sT0FBTyxpQkFBaUI7SUFnQjVCLFlBQW1CLFlBQTBCO1FBQTFCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBUjdDLGdCQUFXLEdBQWtCLEVBQUUsQ0FBQztRQUloQyxrQkFBYSxHQUFrQixFQUFFLENBQUM7UUFLaEMsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLEdBQUcsRUFBcUIsQ0FBQztRQUNwRCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxHQUFHLEVBQXFCLENBQUM7SUFDMUQsQ0FBQztJQWZELElBQUksVUFBVTtRQUNaLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUF3QixDQUFDO0lBQ3BELENBQUM7SUFlRCxVQUFVLENBQUMsWUFBMEI7UUFDbkMsSUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUM7SUFDbkMsQ0FBQztJQUVEOztPQUVHO0lBQ0ssWUFBWSxDQUFDLFVBQWtCO1FBQ3JDLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNkLE1BQU0sa0JBQWtCLEdBQUcsc0JBQXNCLENBQUM7UUFDbEQsTUFBTSxjQUFjLEdBQUcsbUJBQW1CLENBQUM7UUFDM0MsSUFBSSxPQUFPLFVBQVUsS0FBSyxRQUFRLEVBQUU7WUFDbEMsTUFBTSxnQkFBZ0IsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFDOUQsTUFBTSxhQUFhLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FB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QUMsYUFBYSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUNyQztJQUNILENBQUM7SUFDRCxpQkFBaUI7SUFDakIsZ0JBQWdCLENBQUMsR0FBUSxFQUFFLElBQVk7UUFDckMsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3JCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNqQyxDQUFDLENBQUMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ2xDLENBQUM7OztZQWpIRixVQUFVOzs7O1lBUkYsWUFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgU3RhdGVNYWNoaW5lIH0gZnJvbSAnLi9zdGF0ZV9tYWNoaW5lJztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0IH0gZnJvbSAnLi4vZnJhbWUvaW5kZXgnO1xyXG5pbXBvcnQgeyBDaGFuZ2UgfSBmcm9tICcuLi9iaW5kaW5nLWRhdGEvY2hhbmdlcyc7XHJcbmltcG9ydCB7IEFwcENvbnRleHQgfSBmcm9tICcuLi9hcHAnO1xyXG5cclxuLyoqXHJcbiAqIOeKtuaAgeacuuS6i+S7tu+8jOebkeWQrHVpc3RhdGXnmoTlj5jljJblkoxlbnRpdHnnmoTlj5jljJZcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFN0YXRlTWFjaGluZUV2ZW50IHtcclxuXHJcbiAgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQ7XHJcblxyXG4gIGdldCBhcHBDb250ZXh0KCk6IEFwcENvbnRleHQge1xyXG4gICAgcmV0dXJuIHRoaXMuc3RhdGVNYWNoaW5lLmFwcENvbnRleHQgYXMgQXBwQ29udGV4dDtcclxuICB9XHJcblxyXG4gIHVpRmllbGRMaXN0OiBBcnJheTxzdHJpbmc+ID0gW107XHJcblxyXG4gIGZyYW1lQ29udGV4dE1hcDogTWFwPEZyYW1lQ29udGV4dCwgQXJyYXk8c3RyaW5nPj47XHJcblxyXG4gIGRhdGFGaWVsZExpc3Q6IEFycmF5PHN0cmluZz4gPSBbXTtcclxuXHJcbiAgZGF0YUZyYW1lQ29udGV4dE1hcDogTWFwPEZyYW1lQ29udGV4dCwgQXJyYXk8c3RyaW5nPj47XHJcblxyXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBzdGF0ZU1hY2hpbmU6IFN0YXRlTWFjaGluZSkge1xyXG4gICAgdGhpcy5mcmFtZUNvbnRleHRNYXAgPSBuZXcgTWFwPEZyYW1lQ29udGV4dCwgYW55PigpO1xyXG4gICAgdGhpcy5kYXRhRnJhbWVDb250ZXh0TWFwID0gbmV3IE1hcDxGcmFtZUNvbnRleHQsIGFueT4oKTtcclxuICB9XHJcblxyXG4gIGluaXRpYWxpemUoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpIHtcclxuICAgIHRoaXMuZnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5pqC5pe25oqK6L+Z5Liq5pa55rOV5pS+5LqG6L+Z5Liq5Zyw5pa577yM562J5a2j6ICB5biI5YWx55So5pa55rOV6LCD5pW05ZCO77yM55u05o6l5byV55So5LuW55qE5pa55rOV77yM6K+l5pa55rOV5Y+v5Yig6ZmkXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBleHRyYWN0UGF0aHMoZXhwcmVzc2lvbjogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGxldCBwYXRoID0gJyc7XHJcbiAgICBjb25zdCBVSV9TVEFURV9QQVRURVJOX0cgPSAvXFx7VUlTVEFURX4oXFxTKz8pXFx9JC9nO1xyXG4gICAgY29uc3QgREFUQV9QQVRURVJOX0cgPSAvXFx7REFUQX4oXFxTKz8pXFx9JC9nO1xyXG4gICAgaWYgKHR5cGVvZiBleHByZXNzaW9uID09PSAnc3RyaW5nJykge1xyXG4gICAgICBjb25zdCB1aVN0YXRlVmFyaWFibGVzID0gZXhwcmVzc2lvbi5tYXRjaChVSV9TVEFURV9QQVRURVJOX0cpO1xyXG4gICAgICBjb25zdCBkYXRhVmFyaWFibGVzID0gZXhwcmVzc2lvbi5tYXRjaChEQVRBX1BBVFRFUk5fRyk7XHJcbiAgICAgIGlmICh1aVN0YXRlVmFyaWFibGVzICE9PSBudWxsKSB7XHJcbiAgICAgICAgY29uc3QgVUlfU1RBVEVfUEFUVEVSTiA9IC9cXHtVSVNUQVRFfihcXFMrPylcXH0kLztcclxuICAgICAgICB1aVN0YXRlVmFyaWFibGVzLmZvckVhY2goKHVpU3RhdGVWYXJpYWJsZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBwYXRoTWF0Y2hlcyA9IHVpU3RhdGVWYXJpYWJsZS5tYXRjaChVSV9TVEFURV9QQVRURVJOKTtcclxuICAgICAgICAgIGlmIChwYXRoTWF0Y2hlcyAhPSBudWxsICYmIHBhdGhNYXRjaGVzLmxlbmd0aCA9PT0gMikge1xyXG4gICAgICAgICAgICBwYXRoID0gcGF0aE1hdGNoZXNbMV07XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGRhdGFWYXJpYWJsZXMgIT09IG51bGwpIHtcclxuICAgICAgICBjb25zdCBEQVRBX1BBVFRFUk4gPSAvXFx7REFUQX4oXFxTKz8pXFx9JC87XHJcbiAgICAgICAgZGF0YVZhcmlhYmxlcy5mb3JFYWNoKChkYXRhVmFyaWFibGU6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgY29uc3QgcGF0aE1hdGNoZXMgPSBkYXRhVmFyaWFibGUubWF0Y2goREFUQV9QQVRURVJOKTtcclxuICAgICAgICAgIGlmIChwYXRoTWF0Y2hlcyAhPSBudWxsICYmIHBhdGhNYXRjaGVzLmxlbmd0aCA9PT0gMikge1xyXG4gICAgICAgICAgICBwYXRoID0gcGF0aE1hdGNoZXNbMV07XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBwYXRoO1xyXG4gIH1cclxuXHJcbiAgLy8g5qC55o2u6KGo6L6+5byP6L+U5Zue5b2T5YmN57uE5Lu255qEZnJhbWVDb250ZXh0XHJcbiAgZ2V0RnJhbWVDb250ZXh0KGV4cHJlc3Npb246IGFueSk6IEZyYW1lQ29udGV4dCB7XHJcbiAgICBsZXQgZnJhbWVJZCA9IHRoaXMuZXh0cmFjdFBhdGhzKGV4cHJlc3Npb24pLnNwbGl0KCcvJylbMV0gfHwgJyc7XHJcbiAgICBpZiAoZnJhbWVJZC5zdGFydHNXaXRoKCcjeycpICYmIGZyYW1lSWQuZW5kc1dpdGgoJ30nKSAmJiB0aGlzLmZyYW1lQ29udGV4dCkge1xyXG4gICAgICBjb25zdCByZWxhdGl2ZUZyYW1lSWQgPSBmcmFtZUlkLnN1YnN0cmluZygyLCBmcmFtZUlkLmxlbmd0aCAtIDEpO1xyXG4gICAgICBmcmFtZUlkID0gdGhpcy5mcmFtZUNvbnRleHQubmFtZXNwYWNlID8gYCR7dGhpcy5mcmFtZUNvbnRleHQubmFtZXNwYWNlfV8ke3JlbGF0aXZlRnJhbWVJZH1gIDogcmVsYXRpdmVGcmFtZUlkO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuYXBwQ29udGV4dC5nZXRGcmFtZUNvbnRleHQoZnJhbWVJZCk7XHJcbiAgfVxyXG5cclxuICAvLyDmoLnmja7ooajovr7lvI/ov5Tlm57lvZPliY3nu4Tku7bnmoTlrZfmrrUo5Y+v6IO95piv5a6e5L2T5a2X5q615Lmf5Y+v6IO95pivdWlzdGF0ZeeahOWtl+autSlcclxuICBnZXRGcmFtZUZpZWxkKGV4cHJlc3Npb246IGFueSkge1xyXG4gICAgcmV0dXJuIHRoaXMuZXh0cmFjdFBhdGhzKGV4cHJlc3Npb24pLnNwbGl0KCcvJylbMl07XHJcbiAgfVxyXG5cclxuICAvLyDnm5HlkKzooajljZXlj5jph4/nmoTlj5jljJZcclxuICBMaXN0ZW5VSVN0YXRlQ2hhbmdlKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBleHByZXNzaW9uOiBhbnkpIHtcclxuICAgIGNvbnN0IGZyYW1lRmllbGQgPSB0aGlzLmdldEZyYW1lRmllbGQoZXhwcmVzc2lvbik7XHJcbiAgICBpZiAoIXRoaXMuZnJhbWVDb250ZXh0TWFwLmhhcyhmcmFtZUNvbnRleHQpKSB7XHJcbiAgICAgIHRoaXMuZnJhbWVDb250ZXh0TWFwLnNldChmcmFtZUNvbnRleHQsIHRoaXMudWlGaWVsZExpc3QpO1xyXG4gICAgICBmcmFtZUNvbnRleHQudWlTdGF0ZS5jaGFuZ2VzLnN1YnNjcmliZSgoZGF0YSkgPT4ge1xyXG4gICAgICAgIGlmIChkYXRhLmZpZWxkICYmIHRoaXMuZnJhbWVDb250ZXh0TWFwLmdldChmcmFtZUNvbnRleHQpLmluZGV4T2YoZGF0YS5maWVsZCkgPiAtMSkge1xyXG4gICAgICAgICAgdGhpcy5zdGF0ZU1hY2hpbmUucmVuZGVyKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmZyYW1lQ29udGV4dE1hcC5nZXQoZnJhbWVDb250ZXh0KS5pbmRleE9mKGZyYW1lRmllbGQpID09PSAtMSkge1xyXG4gICAgICB0aGlzLnVpRmllbGRMaXN0LnB1c2goZnJhbWVGaWVsZCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcbiAgLy8g55uR5ZCs5a6e5L2T5pWw5o2u55qE5Y+Y5YyWXHJcbiAgTGlzdGVuRW50aXR5Q2hhbmdlKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBleHByZXNzaW9uOiBhbnkpIHtcclxuICAgIGlmICghdGhpcy5kYXRhRnJhbWVDb250ZXh0TWFwLmhhcyhmcmFtZUNvbnRleHQpKSB7XHJcbiAgICAgIHRoaXMuZGF0YUZyYW1lQ29udGV4dE1hcC5zZXQoZnJhbWVDb250ZXh0LCB0aGlzLmRhdGFGaWVsZExpc3QpO1xyXG4gICAgICBmcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuY2hhbmdlcy5zdWJzY3JpYmUoKGNoYW5nZTogQ2hhbmdlKSA9PiB7XHJcbiAgICAgICAgLy8g5YiH5o2i5b2T5YmN6KGM55So5Yiw55qE5pivXHJcbiAgICAgICAgaWYgKGNoYW5nZS50eXBlID09PSAnTG9hZCcgfHwgY2hhbmdlLnR5cGUgPT09ICdTZWxlY3Rpb25DaGFuZ2VkJykge1xyXG4gICAgICAgICAgdGhpcy5zdGF0ZU1hY2hpbmUucmVuZGVyKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjaGFuZ2UucGF0aC5qb2luKCkgJiYgdGhpcy5pc0FjY29yZGluZ1ZhbHVlKHRoaXMuZGF0YUZyYW1lQ29udGV4dE1hcC5nZXQoZnJhbWVDb250ZXh0KSwgY2hhbmdlLnBhdGguam9pbignLycpKSkge1xyXG4gICAgICAgICAgdGhpcy5zdGF0ZU1hY2hpbmUucmVuZGVyKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmRhdGFGcmFtZUNvbnRleHRNYXAuZ2V0KGZyYW1lQ29udGV4dCkuaW5kZXhPZihleHByZXNzaW9uKSA9PT0gLTEpIHtcclxuICAgICAgdGhpcy5kYXRhRmllbGRMaXN0LnB1c2goZXhwcmVzc2lvbik7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8vIOebkeWQrOaYr+WQpuaYr+ino+aekOeahOaVsOaNruWPkeeUn+WPmOWMllxyXG4gIGlzQWNjb3JkaW5nVmFsdWUoYXJyOiBhbnksIHBhdGg6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIGFyci5maW5kKGl0ZW0gPT4ge1xyXG4gICAgICByZXR1cm4gaXRlbS5pbmRleE9mKHBhdGgpID4gLTE7XHJcbiAgICB9KSA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiB0cnVlO1xyXG4gIH1cclxufSJdfQ==