import { BehaviorSubject } from 'rxjs';
import { MetadataUtil } from '../metadata/index';
import { StateMachineContext } from './context';
import { State, initialUIState } from './types';
import { StateMachineEvent } from './state_machine_event';
/**
 * 预置界面效果处理
 */
export const effectHandlers = {
    /**
     * 预置状态迁移处理
     */
    transit: {
        /**
         * 执行状态迁移
         * @param stateMachine  状态机对象
         * @param stateName     下一状态的名称
         * @param preconditions 迁移条件
         */
        // tslint:disable-next-line: only-arrow-functions
        perform: function (statemachine, stateName, preconditons = []) {
            const nextState = statemachine.states[stateName];
            statemachine.context.transitTo(nextState.name);
            statemachine.render();
        }
    }
};
/**
 * 状态机
 *
 * ### 基本概念
 * 状态机中有三个重要的概念：
 * - 页面状态（State）：页面的整体状态，比如查看状态、编辑状态；
 * - 控件状态（RenderState）：控制具体控件的状态；
 * - 迁移动作（Action）：当动作发生时，将页面切换到指定的页面状态。
 *
 * ### 定义状态机
 *
 * **基本步骤**
 *
 * - 继承StateMachine基类，并添加NgStatemachine注解；
 * - 定义页面状态、控件状态、迁移动作。
 *
 * **状态机中的注解**
 *
 * - NgStatemachine：将类标记为状态机，并进行扩展；
 * - NgState：将属性标记为页面状态，通过initialState可以标记此状态是否为初始状态；
 * - NgRenderState：将属性标记为控件状态，通过render方法指定控件状态的切换规则，
 *   一般情况下是通过对页面状态进行逻辑运算来确定。
 * - NgAction：将属性标记为迁移动作，通过transitTo指定动作执行时要迁移到哪个页面状态。
 *
 * ```ts
 * @Injectable()
 * @NgStatemachine()
 * class SimpleStateMachine extends StateMachine {
 *
 *   // 查看状态，设置为初始状态
 *   @NgState({ initialState: true })
 *   viewState: State;
 *
 *   // 编辑状态
 *   @NgState()
 *   editState: State;
 *
 *   // 编辑按钮是否允许点击
 *   @NgRenderState({
 *     render: (context) => context.state === 'viewState'
 *   })
 *   canEdit: RenderState;
 *
 *   // 保存按钮是否允许点击
 *   @NgRenderState({
 *     render: (context) => context.state === 'editState'
 *   })
 *   canSave: RenderState;
 *
 *   // 输入控件是否允许输入
 *   @NgRenderState({
 *     render: (context) => context.state === 'editState'
 *   })
 *   canInput: RenderState;
 *
 *   // 迁移到编辑状态
 *   @NgAction({ transitTo: 'editState' })
 *   edit: Action;
 *
 *   // 迁移到查看状态
 *   @NgAction({ transitTo: 'viewState' })
 *   view: Action;
 * }
 * ```
 * 在上边的代码中做了如下定义：
 * - 两个页面状态：查看状态、编辑状态，
 * - 三个控件状态：分别用来控制编辑按钮、保存按钮、输入控件的状态，
 * - 两个迁移动作：view动作用来将页面切换到查看状态，edit动作用来将页面切换到编辑状态。
 *
 *
 * ### 在模板中使用状态机
 *
 * 模板中我们主要使用的是控件状态，多个控件可以共享一个控件状态。
 *
 * ```html
 * <button type="button" [disabled]="!viewModel.stateMachine.canEdit">编辑</button>
 * <button type="button" [disabled]="!viewModel.stateMachine.canSave">保存</button>
 * <input id="code" [disabled]="!viewModel.stateMachine.canInput" />
 * <input id="name" [disabled]="!viewModel.stateMachine.canInput" />
 * ```
 *
 * ### 执行状态迁移
 * 通过执行状态机上的动作来将页面切换到页面状态，进而改变控件状态。
 * 假设我们有这么一个场景，当用户点击保存按钮的时候，我们先执行保存，保存完成后将状态迁移到查看状态。
 * 我们可以定义一个CommandHandler，添加两个对应的任务，具体代码如下：
 * ```ts
 * @Injectable()
 * @NgCommandHandler({
 *   commandName: 'save'
 * })
 * class SaveHandler extends CommandHandler {
 *
 *   schedule() {
 *     this.addTask('save', () => {
 *       // 实现保存
 *     });
 *
 *     // 状态迁移
 *     this.addTask('transitState', ) => {
 *       this.stateMachine['view']();
 *     });
 *   }
 * }
 * ```
 */
export class StateMachine {
    /**
     * 构造函数
     */
    constructor() {
        this.isStateInited = false;
        this.isDisposed = false;
        const propsMetadatas = MetadataUtil.getPropsMetadatas(this.constructor);
        // 遍历所有属性装饰器，并调用相应的build方法
        if (propsMetadatas) {
            Object.keys(propsMetadatas).forEach((propName) => {
                const propMetadatas = propsMetadatas[propName];
                propMetadatas.forEach(propMetadata => {
                    this['build' + propMetadata.ngMetadataName](propName, propMetadata);
                });
            });
        }
        // if (!this.initialState) {
        //   throw new Error('请在NgState注解中指定状态机的初始状态。');
        // }
        this.stateChange = new BehaviorSubject(false);
        this.context = new StateMachineContext(this);
        this.stateMachineEvent = new StateMachineEvent(this);
    }
    dispose(options) {
        this.isDisposed = true;
        this.frameContext = null;
        this.appContext = null;
        this.context = null;
        this.stateMachineEvent = null;
        this.metadatas = null;
    }
    ngOnDestroy() {
        this.dispose();
    }
    // 状态机变更，为了在绑定数据之后执行状态机的操作，把render方法延后执行。
    initialize(frameContext, variableParseService) {
        this.appContext = frameContext.appContext;
        this.frameContext = frameContext;
        const stateMachineMetadata = this.appContext.metadata.stateMachine || this.collectionMetadata();
        this.metadatas = stateMachineMetadata;
        this.buildStateMachine(stateMachineMetadata);
        // if (!this.initialState) {
        //   throw new Error('请在NgState注解中指定状态机的初始状态。');
        // }
        this.context.initialize(variableParseService, this.initialState);
        this.stateMachineEvent.initialize(this.frameContext);
        this.render();
    }
    collectionMetadata() {
        const stateMachineMetadata = {
            states: {},
            renderStates: {},
            actions: {}
        };
        const propsMetadatas = MetadataUtil.getPropsMetadatas(this.constructor);
        if (propsMetadatas) {
            Object.keys(propsMetadatas).forEach((propName) => {
                const propMetadatas = propsMetadatas[propName];
                propMetadatas.forEach(propMetadata => {
                    switch (propMetadata.ngMetadataName) {
                        case 'NgState':
                            stateMachineMetadata.states[propName] = propMetadata;
                            break;
                        case 'NgRenderState':
                            stateMachineMetadata.renderStates[propName] = propMetadata;
                            break;
                        case 'NgAction':
                            stateMachineMetadata.actions[propName] = propMetadata;
                            break;
                    }
                });
            });
        }
        return stateMachineMetadata;
    }
    buildStateMachine(metadata) {
        Object.keys(metadata.states).forEach((stateName) => {
            this.buildNgState(stateName, metadata.states[stateName]);
        });
        Object.keys(metadata.renderStates).forEach((renderStateName) => {
            this.buildNgRenderState(renderStateName, metadata.renderStates[renderStateName]);
        });
        Object.keys(metadata.actions).forEach((actionName) => {
            this.buildNgAction(actionName, metadata.actions[actionName]);
        });
    }
    /**
     * 构造状态
     * @param stateName 状态名称
     * @param ngState   状态对象
     */
    buildNgState(stateName, ngState) {
        this.states = this.states || {};
        this[stateName] = new State(stateName);
        this.states[stateName] = this[stateName];
        if (ngState.initialState) {
            this.initialState = this[stateName];
        }
    }
    /**
     * 构造界面状态
     * @param renderStateName 渲染状态名称
     * @param ngRenderState   渲染状态元数据
     */
    buildNgRenderState(renderStateName, ngRenderState) {
        this.renderStates = this.renderStates || {};
        this[renderStateName] = initialUIState;
        this.renderStates[renderStateName] = this[renderStateName];
        // 将renderState上指定的render加入到renders中
        this.renders = this.renders || {};
        this.renders[renderStateName] = ngRenderState.render;
    }
    /**
     * 构造动作
     * @param actionName 动作名称
     * @param ngAction   动作元数据
     */
    buildNgAction(actionName, ngAction) {
        this[actionName] = () => {
            effectHandlers.transit.perform(this, ngAction.transitTo, ngAction.precondition);
        };
    }
    /**
     * 重新计算所有渲染状态的值
     * 当 state切换的时候，调用遍历所有的render方法，更改renderState
     */
    render() {
        if (this.isDisposed) {
            return;
        }
        for (const renderStateName in this.renderStates) {
            if (this.renderStates.hasOwnProperty(renderStateName) === false) {
                continue;
            }
            const stateRender = this.renders[renderStateName];
            if (!stateRender) {
                continue;
            }
            // 调用render方法，更新renderState
            this.renderStates[renderStateName] = stateRender(this.context);
            this[renderStateName] = this.renderStates[renderStateName];
        }
        this.stateChange.next(this.context.state);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVfbWFjaGluZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3N0YXRlLW1hY2hpbmUvc3RhdGVfbWFjaGluZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFaEQsT0FBTyxFQUNMLEtBQUssRUFBRSxjQUFjLEVBRXRCLE1BQU0sU0FBUyxDQUFDO0FBRWpCLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBMEIxRDs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLGNBQWMsR0FBRztJQUU1Qjs7T0FFRztJQUNILE9BQU8sRUFBRTtRQUVQOzs7OztXQUtHO1FBQ0gsaURBQWlEO1FBQ2pELE9BQU8sRUFBRSxVQUFVLFlBQTBCLEVBQUUsU0FBaUIsRUFBRSxlQUFzQixFQUFFO1lBQ3hGLE1BQU0sU0FBUyxHQUFVLFlBQVksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDeEQsWUFBWSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQy9DLFlBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUN4QixDQUFDO0tBQ0Y7Q0FDRixDQUFDO0FBRUY7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBd0dHO0FBQ0gsTUFBTSxPQUFPLFlBQVk7SUE2Q3ZCOztPQUVHO0lBQ0g7UUEvQ1Esa0JBQWEsR0FBRyxLQUFLLENBQUM7UUEyQ3RCLGVBQVUsR0FBRyxLQUFLLENBQUM7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RztJQUNILE1BQU07UUFDSixJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDbkIsT0FBTztTQUNSO1FBQ0QsS0FBSyxNQUFNLGVBQWUsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQy9DLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxjQUFjLENBQUMsZUFBZSxDQUFDLEtBQUssS0FBSyxFQUFFO2dCQUMvRCxTQUFTO2FBQ1Y7WUFDRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ2xELElBQUksQ0FBQyxXQUFXLEVBQUU7Z0JBQ2hCLFNBQVM7YUFDVjtZQUNELDJCQUEyQjtZQUMzQixJQUFJLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDL0QsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsZUFBZSxDQUFDLENBQUM7U0FDNUQ7UUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzVDLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBNZXRhZGF0YVV0aWwgfSBmcm9tICcuLi9tZXRhZGF0YS9pbmRleCc7XHJcbmltcG9ydCB7IFN0YXRlTWFjaGluZUNvbnRleHQgfSBmcm9tICcuL2NvbnRleHQnO1xyXG5pbXBvcnQgeyBOZ1N0YXRlLCBOZ0FjdGlvbiwgTmdSZW5kZXJTdGF0ZSB9IGZyb20gJy4vZGVjb3JhdG9ycyc7XHJcbmltcG9ydCB7XHJcbiAgU3RhdGUsIGluaXRpYWxVSVN0YXRlLCBFZmZlY3QsIFJlbmRlcixcclxuICBTdGF0ZURpY3Rpb25hcnksIFJlbmRlclN0YXRlRGljdGlvbmFyeSwgUmVuZGVyRGljdGlvbmFyeVxyXG59IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQgfSBmcm9tICcuLi9mcmFtZS9pbmRleCc7XHJcbmltcG9ydCB7IFN0YXRlTWFjaGluZUV2ZW50IH0gZnJvbSAnLi9zdGF0ZV9tYWNoaW5lX2V2ZW50JztcclxuaW1wb3J0IHsgVmFyaWFibGVQYXJzZVNlcnZpY2UgfSBmcm9tICcuLi92YXJpYWJsZS92YXJpYWJsZV9wYXJzZV9zZXJ2aWNlJztcclxuaW1wb3J0IHsgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IElEaXNwb3NhYmxlIH0gZnJvbSAnLi4vY29yZSc7XHJcblxyXG4vKipcclxuICog54q25oCB5py65Yid5aeL5YyW6YWN572u5a+56LGhXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIFN0YXRlTWFjaGluZU9wdGlvbiB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOeVjOmdoua4suafk+aPj+i/sFxyXG4gICAqL1xyXG4gIHJlbmRlcnM/OiB7IFtpbmRleDogc3RyaW5nXTogUmVuZGVyIH07XHJcblxyXG4gIC8qKlxyXG4gICAqIOeKtuaAgembhuWQiFxyXG4gICAqL1xyXG4gIHN0YXRlcz86IHN0cmluZ1tdO1xyXG5cclxuICAvKipcclxuICAgKiDnirbmgIHmnLrnlYzpnaLmjqfliLbmlYjmnpxcclxuICAgKi9cclxuICBlZmZlY3RzPzogeyBbaW5kZXg6IHN0cmluZ106IEVmZmVjdCB9O1xyXG59XHJcblxyXG4vKipcclxuICog6aKE572u55WM6Z2i5pWI5p6c5aSE55CGXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgZWZmZWN0SGFuZGxlcnMgPSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOmihOe9rueKtuaAgei/geenu+WkhOeQhlxyXG4gICAqL1xyXG4gIHRyYW5zaXQ6IHtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOaJp+ihjOeKtuaAgei/geenu1xyXG4gICAgICogQHBhcmFtIHN0YXRlTWFjaGluZSAg54q25oCB5py65a+56LGhXHJcbiAgICAgKiBAcGFyYW0gc3RhdGVOYW1lICAgICDkuIvkuIDnirbmgIHnmoTlkI3np7BcclxuICAgICAqIEBwYXJhbSBwcmVjb25kaXRpb25zIOi/geenu+adoeS7tlxyXG4gICAgICovXHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG9ubHktYXJyb3ctZnVuY3Rpb25zXHJcbiAgICBwZXJmb3JtOiBmdW5jdGlvbiAoc3RhdGVtYWNoaW5lOiBTdGF0ZU1hY2hpbmUsIHN0YXRlTmFtZTogc3RyaW5nLCBwcmVjb25kaXRvbnM6IGFueVtdID0gW10pIHtcclxuICAgICAgY29uc3QgbmV4dFN0YXRlOiBTdGF0ZSA9IHN0YXRlbWFjaGluZS5zdGF0ZXNbc3RhdGVOYW1lXTtcclxuICAgICAgc3RhdGVtYWNoaW5lLmNvbnRleHQudHJhbnNpdFRvKG5leHRTdGF0ZS5uYW1lKTtcclxuICAgICAgc3RhdGVtYWNoaW5lLnJlbmRlcigpO1xyXG4gICAgfVxyXG4gIH1cclxufTtcclxuXHJcbi8qKlxyXG4gKiDnirbmgIHmnLpcclxuICpcclxuICogIyMjIOWfuuacrOamguW/tVxyXG4gKiDnirbmgIHmnLrkuK3mnInkuInkuKrph43opoHnmoTmpoLlv7XvvJpcclxuICogLSDpobXpnaLnirbmgIHvvIhTdGF0Ze+8ie+8mumhtemdoueahOaVtOS9k+eKtuaAge+8jOavlOWmguafpeeci+eKtuaAgeOAgee8lui+keeKtuaAge+8m1xyXG4gKiAtIOaOp+S7tueKtuaAge+8iFJlbmRlclN0YXRl77yJ77ya5o6n5Yi25YW35L2T5o6n5Lu255qE54q25oCB77ybXHJcbiAqIC0g6L+B56e75Yqo5L2c77yIQWN0aW9u77yJ77ya5b2T5Yqo5L2c5Y+R55Sf5pe277yM5bCG6aG16Z2i5YiH5o2i5Yiw5oyH5a6a55qE6aG16Z2i54q25oCB44CCXHJcbiAqXHJcbiAqICMjIyDlrprkuYnnirbmgIHmnLpcclxuICpcclxuICogKirln7rmnKzmraXpqqQqKlxyXG4gKlxyXG4gKiAtIOe7p+aJv1N0YXRlTWFjaGluZeWfuuexu++8jOW5tua3u+WKoE5nU3RhdGVtYWNoaW5l5rOo6Kej77ybXHJcbiAqIC0g5a6a5LmJ6aG16Z2i54q25oCB44CB5o6n5Lu254q25oCB44CB6L+B56e75Yqo5L2c44CCXHJcbiAqXHJcbiAqICoq54q25oCB5py65Lit55qE5rOo6KejKipcclxuICpcclxuICogLSBOZ1N0YXRlbWFjaGluZe+8muWwhuexu+agh+iusOS4uueKtuaAgeacuu+8jOW5tui/m+ihjOaJqeWxle+8m1xyXG4gKiAtIE5nU3RhdGXvvJrlsIblsZ7mgKfmoIforrDkuLrpobXpnaLnirbmgIHvvIzpgJrov4dpbml0aWFsU3RhdGXlj6/ku6XmoIforrDmraTnirbmgIHmmK/lkKbkuLrliJ3lp4vnirbmgIHvvJtcclxuICogLSBOZ1JlbmRlclN0YXRl77ya5bCG5bGe5oCn5qCH6K6w5Li65o6n5Lu254q25oCB77yM6YCa6L+HcmVuZGVy5pa55rOV5oyH5a6a5o6n5Lu254q25oCB55qE5YiH5o2i6KeE5YiZ77yMXHJcbiAqICAg5LiA6Iis5oOF5Ya15LiL5piv6YCa6L+H5a+56aG16Z2i54q25oCB6L+b6KGM6YC76L6R6L+Q566X5p2l56Gu5a6a44CCXHJcbiAqIC0gTmdBY3Rpb27vvJrlsIblsZ7mgKfmoIforrDkuLrov4Hnp7vliqjkvZzvvIzpgJrov4d0cmFuc2l0VG/mjIflrprliqjkvZzmiafooYzml7bopoHov4Hnp7vliLDlk6rkuKrpobXpnaLnirbmgIHjgIJcclxuICpcclxuICogYGBgdHNcclxuICogQEluamVjdGFibGUoKVxyXG4gKiBATmdTdGF0ZW1hY2hpbmUoKVxyXG4gKiBjbGFzcyBTaW1wbGVTdGF0ZU1hY2hpbmUgZXh0ZW5kcyBTdGF0ZU1hY2hpbmUge1xyXG4gKlxyXG4gKiAgIC8vIOafpeeci+eKtuaAge+8jOiuvue9ruS4uuWIneWni+eKtuaAgVxyXG4gKiAgIEBOZ1N0YXRlKHsgaW5pdGlhbFN0YXRlOiB0cnVlIH0pXHJcbiAqICAgdmlld1N0YXRlOiBTdGF0ZTtcclxuICpcclxuICogICAvLyDnvJbovpHnirbmgIFcclxuICogICBATmdTdGF0ZSgpXHJcbiAqICAgZWRpdFN0YXRlOiBTdGF0ZTtcclxuICpcclxuICogICAvLyDnvJbovpHmjInpkq7mmK/lkKblhYHorrjngrnlh7tcclxuICogICBATmdSZW5kZXJTdGF0ZSh7XHJcbiAqICAgICByZW5kZXI6IChjb250ZXh0KSA9PiBjb250ZXh0LnN0YXRlID09PSAndmlld1N0YXRlJ1xyXG4gKiAgIH0pXHJcbiAqICAgY2FuRWRpdDogUmVuZGVyU3RhdGU7XHJcbiAqXHJcbiAqICAgLy8g5L+d5a2Y5oyJ6ZKu5piv5ZCm5YWB6K6454K55Ye7XHJcbiAqICAgQE5nUmVuZGVyU3RhdGUoe1xyXG4gKiAgICAgcmVuZGVyOiAoY29udGV4dCkgPT4gY29udGV4dC5zdGF0ZSA9PT0gJ2VkaXRTdGF0ZSdcclxuICogICB9KVxyXG4gKiAgIGNhblNhdmU6IFJlbmRlclN0YXRlO1xyXG4gKlxyXG4gKiAgIC8vIOi+k+WFpeaOp+S7tuaYr+WQpuWFgeiuuOi+k+WFpVxyXG4gKiAgIEBOZ1JlbmRlclN0YXRlKHtcclxuICogICAgIHJlbmRlcjogKGNvbnRleHQpID0+IGNvbnRleHQuc3RhdGUgPT09ICdlZGl0U3RhdGUnXHJcbiAqICAgfSlcclxuICogICBjYW5JbnB1dDogUmVuZGVyU3RhdGU7XHJcbiAqXHJcbiAqICAgLy8g6L+B56e75Yiw57yW6L6R54q25oCBXHJcbiAqICAgQE5nQWN0aW9uKHsgdHJhbnNpdFRvOiAnZWRpdFN0YXRlJyB9KVxyXG4gKiAgIGVkaXQ6IEFjdGlvbjtcclxuICpcclxuICogICAvLyDov4Hnp7vliLDmn6XnnIvnirbmgIFcclxuICogICBATmdBY3Rpb24oeyB0cmFuc2l0VG86ICd2aWV3U3RhdGUnIH0pXHJcbiAqICAgdmlldzogQWN0aW9uO1xyXG4gKiB9XHJcbiAqIGBgYFxyXG4gKiDlnKjkuIrovrnnmoTku6PnoIHkuK3lgZrkuoblpoLkuIvlrprkuYnvvJpcclxuICogLSDkuKTkuKrpobXpnaLnirbmgIHvvJrmn6XnnIvnirbmgIHjgIHnvJbovpHnirbmgIHvvIxcclxuICogLSDkuInkuKrmjqfku7bnirbmgIHvvJrliIbliKvnlKjmnaXmjqfliLbnvJbovpHmjInpkq7jgIHkv53lrZjmjInpkq7jgIHovpPlhaXmjqfku7bnmoTnirbmgIHvvIxcclxuICogLSDkuKTkuKrov4Hnp7vliqjkvZzvvJp2aWV35Yqo5L2c55So5p2l5bCG6aG16Z2i5YiH5o2i5Yiw5p+l55yL54q25oCB77yMZWRpdOWKqOS9nOeUqOadpeWwhumhtemdouWIh+aNouWIsOe8lui+keeKtuaAgeOAglxyXG4gKlxyXG4gKlxyXG4gKiAjIyMg5Zyo5qih5p2/5Lit5L2/55So54q25oCB5py6XHJcbiAqXHJcbiAqIOaooeadv+S4reaIkeS7rOS4u+imgeS9v+eUqOeahOaYr+aOp+S7tueKtuaAge+8jOWkmuS4quaOp+S7tuWPr+S7peWFseS6q+S4gOS4quaOp+S7tueKtuaAgeOAglxyXG4gKlxyXG4gKiBgYGBodG1sXHJcbiAqIDxidXR0b24gdHlwZT1cImJ1dHRvblwiIFtkaXNhYmxlZF09XCIhdmlld01vZGVsLnN0YXRlTWFjaGluZS5jYW5FZGl0XCI+57yW6L6RPC9idXR0b24+XHJcbiAqIDxidXR0b24gdHlwZT1cImJ1dHRvblwiIFtkaXNhYmxlZF09XCIhdmlld01vZGVsLnN0YXRlTWFjaGluZS5jYW5TYXZlXCI+5L+d5a2YPC9idXR0b24+XHJcbiAqIDxpbnB1dCBpZD1cImNvZGVcIiBbZGlzYWJsZWRdPVwiIXZpZXdNb2RlbC5zdGF0ZU1hY2hpbmUuY2FuSW5wdXRcIiAvPlxyXG4gKiA8aW5wdXQgaWQ9XCJuYW1lXCIgW2Rpc2FibGVkXT1cIiF2aWV3TW9kZWwuc3RhdGVNYWNoaW5lLmNhbklucHV0XCIgLz5cclxuICogYGBgXHJcbiAqXHJcbiAqICMjIyDmiafooYznirbmgIHov4Hnp7tcclxuICog6YCa6L+H5omn6KGM54q25oCB5py65LiK55qE5Yqo5L2c5p2l5bCG6aG16Z2i5YiH5o2i5Yiw6aG16Z2i54q25oCB77yM6L+b6ICM5pS55Y+Y5o6n5Lu254q25oCB44CCXHJcbiAqIOWBh+iuvuaIkeS7rOaciei/meS5iOS4gOS4quWcuuaZr++8jOW9k+eUqOaIt+eCueWHu+S/neWtmOaMiemSrueahOaXtuWAme+8jOaIkeS7rOWFiOaJp+ihjOS/neWtmO+8jOS/neWtmOWujOaIkOWQjuWwhueKtuaAgei/geenu+WIsOafpeeci+eKtuaAgeOAglxyXG4gKiDmiJHku6zlj6/ku6XlrprkuYnkuIDkuKpDb21tYW5kSGFuZGxlcu+8jOa3u+WKoOS4pOS4quWvueW6lOeahOS7u+WKoe+8jOWFt+S9k+S7o+eggeWmguS4i++8mlxyXG4gKiBgYGB0c1xyXG4gKiBASW5qZWN0YWJsZSgpXHJcbiAqIEBOZ0NvbW1hbmRIYW5kbGVyKHtcclxuICogICBjb21tYW5kTmFtZTogJ3NhdmUnXHJcbiAqIH0pXHJcbiAqIGNsYXNzIFNhdmVIYW5kbGVyIGV4dGVuZHMgQ29tbWFuZEhhbmRsZXIge1xyXG4gKlxyXG4gKiAgIHNjaGVkdWxlKCkge1xyXG4gKiAgICAgdGhpcy5hZGRUYXNrKCdzYXZlJywgKCkgPT4ge1xyXG4gKiAgICAgICAvLyDlrp7njrDkv53lrZhcclxuICogICAgIH0pO1xyXG4gKlxyXG4gKiAgICAgLy8g54q25oCB6L+B56e7XHJcbiAqICAgICB0aGlzLmFkZFRhc2soJ3RyYW5zaXRTdGF0ZScsICkgPT4ge1xyXG4gKiAgICAgICB0aGlzLnN0YXRlTWFjaGluZVsndmlldyddKCk7XHJcbiAqICAgICB9KTtcclxuICogICB9XHJcbiAqIH1cclxuICogYGBgXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgU3RhdGVNYWNoaW5lIGltcGxlbWVudHMgT25EZXN0cm95LCBJRGlzcG9zYWJsZSB7XHJcbiAgcHJpdmF0ZSBpc1N0YXRlSW5pdGVkID0gZmFsc2U7XHJcbiAgLyoqXHJcbiAgICog5Yid5aeL54q25oCBXHJcbiAgICovXHJcbiAgcHVibGljIGluaXRpYWxTdGF0ZTogU3RhdGU7XHJcblxyXG4gIC8qKlxyXG4gICAqIOeKtuaAgeWtl+WFuFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGF0ZXM6IFN0YXRlRGljdGlvbmFyeTtcclxuXHJcbiAgLyoqXHJcbiAgICog5riy5p+T54q25oCB5a2X5YW4XHJcbiAgICovXHJcbiAgcHVibGljIHJlbmRlclN0YXRlczogUmVuZGVyU3RhdGVEaWN0aW9uYXJ5O1xyXG5cclxuICAvKipcclxuICAgKiDmuLLmn5PlmajlrZflhbhcclxuICAgKi9cclxuICBwdWJsaWMgcmVuZGVyczogUmVuZGVyRGljdGlvbmFyeTtcclxuXHJcbiAgLyoqXHJcbiAgICog54q25oCB5py65LiK5LiL5paHXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnRleHQ6IFN0YXRlTWFjaGluZUNvbnRleHQ7XHJcblxyXG4gIC8qKlxyXG4gICAqIOeKtuaAgeWPmOabtFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGF0ZUNoYW5nZTogQmVoYXZpb3JTdWJqZWN0PHN0cmluZz47XHJcblxyXG4gIHB1YmxpYyBhcHBDb250ZXh0OiBhbnk7XHJcblxyXG4gIHB1YmxpYyBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dDtcclxuXHJcbiAgLyoqXHJcbiAgICog54q25oCB5py65LqL5Lu255uR5ZCsXHJcbiAgICovXHJcbiAgcHVibGljIHN0YXRlTWFjaGluZUV2ZW50OiBTdGF0ZU1hY2hpbmVFdmVudDtcclxuICAvKipcclxuICAgKiDnirbmgIHmnLrlhYPmlbDmja5cclxuICAgKi9cclxuICBwdWJsaWMgbWV0YWRhdGFzOiB7IHN0YXRlczogeyBbc3RhdGVOYW1lOiBzdHJpbmddOiBOZ1N0YXRlIH0sIHJlbmRlclN0YXRlczogeyBbcmVuZGVyU3RhdGVOYW1lOiBzdHJpbmddOiBOZ1JlbmRlclN0YXRlIH0sIGFjdGlvbnM6IHsgW2FjdGlvbk5hbWU6IHN0cmluZ106IE5nQWN0aW9uIH0gfTtcclxuICBwcml2YXRlIGlzRGlzcG9zZWQgPSBmYWxzZTtcclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIGNvbnN0IHByb3BzTWV0YWRhdGFzID0gTWV0YWRhdGFVdGlsLmdldFByb3BzTWV0YWRhdGFzKHRoaXMuY29uc3RydWN0b3IpO1xyXG5cclxuICAgIC8vIOmBjeWOhuaJgOacieWxnuaAp+ijhemlsOWZqO+8jOW5tuiwg+eUqOebuOW6lOeahGJ1aWxk5pa55rOVXHJcbiAgICBpZiAocHJvcHNNZXRhZGF0YXMpIHtcclxuICAgICAgT2JqZWN0LmtleXMocHJvcHNNZXRhZGF0YXMpLmZvckVhY2goKHByb3BOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgICBjb25zdCBwcm9wTWV0YWRhdGFzID0gcHJvcHNNZXRhZGF0YXNbcHJvcE5hbWVdO1xyXG4gICAgICAgIHByb3BNZXRhZGF0YXMuZm9yRWFjaChwcm9wTWV0YWRhdGEgPT4ge1xyXG4gICAgICAgICAgdGhpc1snYnVpbGQnICsgcHJvcE1ldGFkYXRhLm5nTWV0YWRhdGFOYW1lXShwcm9wTmFtZSwgcHJvcE1ldGFkYXRhKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gaWYgKCF0aGlzLmluaXRpYWxTdGF0ZSkge1xyXG4gICAgLy8gICB0aHJvdyBuZXcgRXJyb3IoJ+ivt+WcqE5nU3RhdGXms6jop6PkuK3mjIflrprnirbmgIHmnLrnmoTliJ3lp4vnirbmgIHjgIInKTtcclxuICAgIC8vIH1cclxuXHJcbiAgICB0aGlzLnN0YXRlQ2hhbmdlID0gbmV3IEJlaGF2aW9yU3ViamVjdDxhbnk+KGZhbHNlKTtcclxuICAgIHRoaXMuY29udGV4dCA9IG5ldyBTdGF0ZU1hY2hpbmVDb250ZXh0KHRoaXMpO1xyXG4gICAgdGhpcy5zdGF0ZU1hY2hpbmVFdmVudCA9IG5ldyBTdGF0ZU1hY2hpbmVFdmVudCh0aGlzKTtcclxuICB9XHJcbiAgcHVibGljIGRpc3Bvc2Uob3B0aW9ucz86IGFueSkge1xyXG4gICAgdGhpcy5pc0Rpc3Bvc2VkID0gdHJ1ZTtcclxuICAgIHRoaXMuZnJhbWVDb250ZXh0ID0gbnVsbDtcclxuICAgIHRoaXMuYXBwQ29udGV4dCA9IG51bGw7XHJcbiAgICB0aGlzLmNvbnRleHQgPSBudWxsO1xyXG4gICAgdGhpcy5zdGF0ZU1hY2hpbmVFdmVudCA9IG51bGw7XHJcbiAgICB0aGlzLm1ldGFkYXRhcyA9IG51bGw7XHJcbiAgfVxyXG4gIHB1YmxpYyBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZGlzcG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgLy8g54q25oCB5py65Y+Y5pu077yM5Li65LqG5Zyo57uR5a6a5pWw5o2u5LmL5ZCO5omn6KGM54q25oCB5py655qE5pON5L2c77yM5oqKcmVuZGVy5pa55rOV5bu25ZCO5omn6KGM44CCXHJcbiAgaW5pdGlhbGl6ZShmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgdmFyaWFibGVQYXJzZVNlcnZpY2U6IFZhcmlhYmxlUGFyc2VTZXJ2aWNlKSB7XHJcbiAgICB0aGlzLmFwcENvbnRleHQgPSBmcmFtZUNvbnRleHQuYXBwQ29udGV4dDtcclxuICAgIHRoaXMuZnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0O1xyXG4gICAgY29uc3Qgc3RhdGVNYWNoaW5lTWV0YWRhdGEgPSB0aGlzLmFwcENvbnRleHQubWV0YWRhdGEuc3RhdGVNYWNoaW5lIHx8IHRoaXMuY29sbGVjdGlvbk1ldGFkYXRhKCk7XHJcbiAgICB0aGlzLm1ldGFkYXRhcyA9IHN0YXRlTWFjaGluZU1ldGFkYXRhO1xyXG4gICAgdGhpcy5idWlsZFN0YXRlTWFjaGluZShzdGF0ZU1hY2hpbmVNZXRhZGF0YSk7XHJcbiAgICAvLyBpZiAoIXRoaXMuaW5pdGlhbFN0YXRlKSB7XHJcbiAgICAvLyAgIHRocm93IG5ldyBFcnJvcign6K+35ZyoTmdTdGF0ZeazqOino+S4reaMh+WumueKtuaAgeacuueahOWIneWni+eKtuaAgeOAgicpO1xyXG4gICAgLy8gfVxyXG4gICAgdGhpcy5jb250ZXh0LmluaXRpYWxpemUodmFyaWFibGVQYXJzZVNlcnZpY2UsIHRoaXMuaW5pdGlhbFN0YXRlKTtcclxuICAgIHRoaXMuc3RhdGVNYWNoaW5lRXZlbnQuaW5pdGlhbGl6ZSh0aGlzLmZyYW1lQ29udGV4dCk7XHJcbiAgICB0aGlzLnJlbmRlcigpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjb2xsZWN0aW9uTWV0YWRhdGEoKToge1xyXG4gICAgc3RhdGVzOiB7IFtzdGF0ZU5hbWU6IHN0cmluZ106IE5nU3RhdGUgfSxcclxuICAgIHJlbmRlclN0YXRlczogeyBbcmVuZGVyU3RhdGVOYW1lOiBzdHJpbmddOiBOZ1JlbmRlclN0YXRlIH0sXHJcbiAgICBhY3Rpb25zOiB7IFthY3Rpb25OYW1lOiBzdHJpbmddOiBOZ0FjdGlvbiB9XHJcbiAgfSB7XHJcbiAgICBjb25zdCBzdGF0ZU1hY2hpbmVNZXRhZGF0YSA9IHtcclxuICAgICAgc3RhdGVzOiB7fSxcclxuICAgICAgcmVuZGVyU3RhdGVzOiB7fSxcclxuICAgICAgYWN0aW9uczoge31cclxuICAgIH07XHJcbiAgICBjb25zdCBwcm9wc01ldGFkYXRhcyA9IE1ldGFkYXRhVXRpbC5nZXRQcm9wc01ldGFkYXRhcyh0aGlzLmNvbnN0cnVjdG9yKTtcclxuICAgIGlmIChwcm9wc01ldGFkYXRhcykge1xyXG4gICAgICBPYmplY3Qua2V5cyhwcm9wc01ldGFkYXRhcykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGNvbnN0IHByb3BNZXRhZGF0YXMgPSBwcm9wc01ldGFkYXRhc1twcm9wTmFtZV07XHJcbiAgICAgICAgcHJvcE1ldGFkYXRhcy5mb3JFYWNoKHByb3BNZXRhZGF0YSA9PiB7XHJcbiAgICAgICAgICBzd2l0Y2ggKHByb3BNZXRhZGF0YS5uZ01ldGFkYXRhTmFtZSkge1xyXG4gICAgICAgICAgICBjYXNlICdOZ1N0YXRlJzpcclxuICAgICAgICAgICAgICBzdGF0ZU1hY2hpbmVNZXRhZGF0YS5zdGF0ZXNbcHJvcE5hbWVdID0gcHJvcE1ldGFkYXRhO1xyXG4gICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdOZ1JlbmRlclN0YXRlJzpcclxuICAgICAgICAgICAgICBzdGF0ZU1hY2hpbmVNZXRhZGF0YS5yZW5kZXJTdGF0ZXNbcHJvcE5hbWVdID0gcHJvcE1ldGFkYXRhO1xyXG4gICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdOZ0FjdGlvbic6XHJcbiAgICAgICAgICAgICAgc3RhdGVNYWNoaW5lTWV0YWRhdGEuYWN0aW9uc1twcm9wTmFtZV0gPSBwcm9wTWV0YWRhdGE7XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHN0YXRlTWFjaGluZU1ldGFkYXRhO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBidWlsZFN0YXRlTWFjaGluZShtZXRhZGF0YToge1xyXG4gICAgc3RhdGVzOiB7IFtzdGF0ZU5hbWU6IHN0cmluZ106IE5nU3RhdGUgfSxcclxuICAgIHJlbmRlclN0YXRlczogeyBbcmVuZGVyU3RhdGVOYW1lOiBzdHJpbmddOiBOZ1JlbmRlclN0YXRlIH0sXHJcbiAgICBhY3Rpb25zOiB7IFthY3Rpb25OYW1lOiBzdHJpbmddOiBOZ0FjdGlvbiB9XHJcbiAgfSkge1xyXG4gICAgT2JqZWN0LmtleXMobWV0YWRhdGEuc3RhdGVzKS5mb3JFYWNoKChzdGF0ZU5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICB0aGlzLmJ1aWxkTmdTdGF0ZShzdGF0ZU5hbWUsIG1ldGFkYXRhLnN0YXRlc1tzdGF0ZU5hbWVdKTtcclxuICAgIH0pO1xyXG5cclxuICAgIE9iamVjdC5rZXlzKG1ldGFkYXRhLnJlbmRlclN0YXRlcykuZm9yRWFjaCgocmVuZGVyU3RhdGVOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgdGhpcy5idWlsZE5nUmVuZGVyU3RhdGUocmVuZGVyU3RhdGVOYW1lLCBtZXRhZGF0YS5yZW5kZXJTdGF0ZXNbcmVuZGVyU3RhdGVOYW1lXSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBPYmplY3Qua2V5cyhtZXRhZGF0YS5hY3Rpb25zKS5mb3JFYWNoKChhY3Rpb25OYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgdGhpcy5idWlsZE5nQWN0aW9uKGFjdGlvbk5hbWUsIG1ldGFkYXRhLmFjdGlvbnNbYWN0aW9uTmFtZV0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDnirbmgIFcclxuICAgKiBAcGFyYW0gc3RhdGVOYW1lIOeKtuaAgeWQjeensFxyXG4gICAqIEBwYXJhbSBuZ1N0YXRlICAg54q25oCB5a+56LGhXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZE5nU3RhdGUoc3RhdGVOYW1lOiBzdHJpbmcsIG5nU3RhdGU6IE5nU3RhdGUpIHtcclxuICAgIHRoaXMuc3RhdGVzID0gdGhpcy5zdGF0ZXMgfHwge307XHJcbiAgICB0aGlzW3N0YXRlTmFtZV0gPSBuZXcgU3RhdGUoc3RhdGVOYW1lKTtcclxuICAgIHRoaXMuc3RhdGVzW3N0YXRlTmFtZV0gPSB0aGlzW3N0YXRlTmFtZV07XHJcbiAgICBpZiAobmdTdGF0ZS5pbml0aWFsU3RhdGUpIHtcclxuICAgICAgdGhpcy5pbml0aWFsU3RhdGUgPSB0aGlzW3N0YXRlTmFtZV07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDnlYzpnaLnirbmgIFcclxuICAgKiBAcGFyYW0gcmVuZGVyU3RhdGVOYW1lIOa4suafk+eKtuaAgeWQjeensFxyXG4gICAqIEBwYXJhbSBuZ1JlbmRlclN0YXRlICAg5riy5p+T54q25oCB5YWD5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZE5nUmVuZGVyU3RhdGUocmVuZGVyU3RhdGVOYW1lOiBzdHJpbmcsIG5nUmVuZGVyU3RhdGU6IE5nUmVuZGVyU3RhdGUpIHtcclxuICAgIHRoaXMucmVuZGVyU3RhdGVzID0gdGhpcy5yZW5kZXJTdGF0ZXMgfHwge307XHJcbiAgICB0aGlzW3JlbmRlclN0YXRlTmFtZV0gPSBpbml0aWFsVUlTdGF0ZTtcclxuICAgIHRoaXMucmVuZGVyU3RhdGVzW3JlbmRlclN0YXRlTmFtZV0gPSB0aGlzW3JlbmRlclN0YXRlTmFtZV07XHJcblxyXG4gICAgLy8g5bCGcmVuZGVyU3RhdGXkuIrmjIflrprnmoRyZW5kZXLliqDlhaXliLByZW5kZXJz5LitXHJcbiAgICB0aGlzLnJlbmRlcnMgPSB0aGlzLnJlbmRlcnMgfHwge307XHJcbiAgICB0aGlzLnJlbmRlcnNbcmVuZGVyU3RhdGVOYW1lXSA9IG5nUmVuZGVyU3RhdGUucmVuZGVyO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Yqo5L2cXHJcbiAgICogQHBhcmFtIGFjdGlvbk5hbWUg5Yqo5L2c5ZCN56ewXHJcbiAgICogQHBhcmFtIG5nQWN0aW9uICAg5Yqo5L2c5YWD5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZE5nQWN0aW9uKGFjdGlvbk5hbWU6IHN0cmluZywgbmdBY3Rpb246IE5nQWN0aW9uKSB7XHJcbiAgICB0aGlzW2FjdGlvbk5hbWVdID0gKCkgPT4ge1xyXG4gICAgICBlZmZlY3RIYW5kbGVycy50cmFuc2l0LnBlcmZvcm0odGhpcywgbmdBY3Rpb24udHJhbnNpdFRvLCBuZ0FjdGlvbi5wcmVjb25kaXRpb24pO1xyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOmHjeaWsOiuoeeul+aJgOaciea4suafk+eKtuaAgeeahOWAvFxyXG4gICAqIOW9kyBzdGF0ZeWIh+aNoueahOaXtuWAme+8jOiwg+eUqOmBjeWOhuaJgOacieeahHJlbmRlcuaWueazle+8jOabtOaUuXJlbmRlclN0YXRlXHJcbiAgICovXHJcbiAgcmVuZGVyKCkge1xyXG4gICAgaWYgKHRoaXMuaXNEaXNwb3NlZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBmb3IgKGNvbnN0IHJlbmRlclN0YXRlTmFtZSBpbiB0aGlzLnJlbmRlclN0YXRlcykge1xyXG4gICAgICBpZiAodGhpcy5yZW5kZXJTdGF0ZXMuaGFzT3duUHJvcGVydHkocmVuZGVyU3RhdGVOYW1lKSA9PT0gZmFsc2UpIHtcclxuICAgICAgICBjb250aW51ZTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBzdGF0ZVJlbmRlciA9IHRoaXMucmVuZGVyc1tyZW5kZXJTdGF0ZU5hbWVdO1xyXG4gICAgICBpZiAoIXN0YXRlUmVuZGVyKSB7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuICAgICAgLy8g6LCD55SocmVuZGVy5pa55rOV77yM5pu05pawcmVuZGVyU3RhdGVcclxuICAgICAgdGhpcy5yZW5kZXJTdGF0ZXNbcmVuZGVyU3RhdGVOYW1lXSA9IHN0YXRlUmVuZGVyKHRoaXMuY29udGV4dCk7XHJcbiAgICAgIHRoaXNbcmVuZGVyU3RhdGVOYW1lXSA9IHRoaXMucmVuZGVyU3RhdGVzW3JlbmRlclN0YXRlTmFtZV07XHJcbiAgICB9XHJcbiAgICB0aGlzLnN0YXRlQ2hhbmdlLm5leHQodGhpcy5jb250ZXh0LnN0YXRlKTtcclxuICB9XHJcbn1cclxuIl19