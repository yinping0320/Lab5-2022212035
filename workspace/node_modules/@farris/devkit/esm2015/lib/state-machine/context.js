/**
 * 状态机上下文
 */
export class StateMachineContext {
    /**
     * 构造函数
     * @param stateMachine 状态机
     * @param initialState 初始状态
     */
    constructor(stateMachine) {
        this.stateMachine = stateMachine;
        // this.state = initialState.name;
    }
    initialize(variableParseService, initialState) {
        this.frameContext = this.stateMachine && this.stateMachine.frameContext || null;
        this.state = this.state || (initialState ? initialState.name : '');
        this.parser = variableParseService;
        this.stateMachineEvent = this.stateMachine.stateMachineEvent;
    }
    /**
     * 状态迁移
     * @param stateName 下一状态的名称
     */
    transitTo(stateName) {
        const nextState = this.stateMachine.states[stateName];
        if (nextState) {
            this.state = nextState.name;
            this.stateMachine.render();
        }
    }
    parse(expression, targetType) {
        if (expression === null || expression === undefined) {
            return expression;
        }
        const context = this.stateMachineEvent.getFrameContext(expression) || this.stateMachine.frameContext;
        switch (targetType) {
            case 'source':
                return this.parseSourceValue(expression, context);
            case 'target':
                return this.parser.parse(expression, context);
        }
    }
    parseSourceValue(expression, context) {
        if (expression === null || expression === undefined) {
            return expression;
        }
        let result = expression.trim();
        result = this.parser.parse(result, context);
        if (result === 'state') {
            result = this.state;
        }
        return result;
    }
    // 兼容旧版本
    get(expression) {
        return this.getUIState(expression);
    }
    // 解析uistate变量表达式并返回表达式的值
    getUIState(expression) {
        if (!expression) {
            return;
        }
        const frameContext = this.stateMachineEvent.getFrameContext(expression);
        if (!frameContext) {
            return;
        }
        this.stateMachineEvent.ListenUIStateChange(frameContext, expression);
        if (this.parser) {
            const value = this.parser.parse(expression, frameContext);
            if (value === null) {
                return null;
            }
            if (typeof value === 'object' && Object.keys(value).length === 0) {
                return null;
            }
            return value;
        }
        else {
            throw new Error('未初始化变量解析器。');
        }
    }
    // 解析data变量表达式并返回表达式的值
    getData(expression) {
        if (!expression) {
            return;
        }
        const frameContext = this.stateMachineEvent.getFrameContext(expression);
        if (!frameContext) {
            return;
        }
        this.stateMachineEvent.ListenEntityChange(frameContext, expression);
        if (this.parser) {
            const value = this.parser.parse(expression, frameContext);
            if (value === null) {
                return null;
            }
            if (typeof value === 'object' && Object.keys(value).length === 0) {
                return null;
            }
            return value;
        }
        else {
            throw new Error('未初始化变量解析器。');
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3N0YXRlLW1hY2hpbmUvY29udGV4dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFPQTs7R0FFRztBQUNILE1BQU0sT0FBTyxtQkFBbUI7SUFjOUI7Ozs7T0FJRztJQUNILFlBQW1CLFlBQTBCO1FBQTFCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzNDLGtDQUFrQztJQUNwQyxDQUFDO0lBRUQsVUFBVSxDQUFDLG9CQUEwQyxFQUFFLFlBQW1CO1FBQ3hFLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUM7UUFDaEYsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNuRSxJQUFJLENBQUMsTUFBTSxHQUFHLG9CQUFvQixDQUFDO1FBQ25DLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLGlCQUFpQixDQUFDO0lBQy9ELENBQUM7SUFFRDs7O09BR0c7SUFDSCxTQUFTLENBQUMsU0FBaUI7UUFDekIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDdEQsSUFBSSxTQUFTLEVBQUU7WUFDYixJQUFJLENBQUMsS0FBSyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUM7WUFDNUIsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUM1QjtJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsVUFBa0IsRUFBRSxVQUErQjtRQUN2RCxJQUFJLFVBQVUsS0FBSyxJQUFJLElBQUksVUFBVSxLQUFLLFNBQVMsRUFBRTtZ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TSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUNoRSxPQUFPLElBQUksQ0FBQzthQUNiO1lBQ0QsT0FBTyxLQUFLLENBQUM7U0FDZDthQUFNO1lBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQztTQUMvQjtJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN0YXRlTWFjaGluZSB9IGZyb20gJy4vc3RhdGVfbWFjaGluZSc7XHJcbmltcG9ydCB7IFN0YXRlIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IENvbnRleHQgfSBmcm9tICcuLi9jb250ZXh0L2NvbnRleHQnO1xyXG5pbXBvcnQgeyBWYXJpYWJsZVBhcnNlU2VydmljZSB9IGZyb20gJy4uL3ZhcmlhYmxlL2luZGV4JztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0IH0gZnJvbSAnLi4vZnJhbWUvaW5kZXgnO1xyXG5pbXBvcnQgeyBTdGF0ZU1hY2hpbmVFdmVudCB9IGZyb20gJy4vc3RhdGVfbWFjaGluZV9ldmVudCc7XHJcblxyXG4vKipcclxuICog54q25oCB5py65LiK5LiL5paHXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgU3RhdGVNYWNoaW5lQ29udGV4dCB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOW9k+WJjeeKtuaAgeWQjeensFxyXG4gICAqL1xyXG4gIHN0YXRlOiBzdHJpbmc7XHJcblxyXG4gIHBhcmVudDogQ29udGV4dDtcclxuXHJcbiAgcGFyc2VyOiBWYXJpYWJsZVBhcnNlU2VydmljZTtcclxuXHJcbiAgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQ7XHJcblxyXG4gIHN0YXRlTWFjaGluZUV2ZW50OiBTdGF0ZU1hY2hpbmVFdmVudDtcclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKiBAcGFyYW0gc3RhdGVNYWNoaW5lIOeKtuaAgeaculxyXG4gICAqIEBwYXJhbSBpbml0aWFsU3RhdGUg5Yid5aeL54q25oCBXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IocHVibGljIHN0YXRlTWFjaGluZTogU3RhdGVNYWNoaW5lKSB7XHJcbiAgICAvLyB0aGlzLnN0YXRlID0gaW5pdGlhbFN0YXRlLm5hbWU7XHJcbiAgfVxyXG5cclxuICBpbml0aWFsaXplKHZhcmlhYmxlUGFyc2VTZXJ2aWNlOiBWYXJpYWJsZVBhcnNlU2VydmljZSwgaW5pdGlhbFN0YXRlOiBTdGF0ZSkge1xyXG4gICAgdGhpcy5mcmFtZUNvbnRleHQgPSB0aGlzLnN0YXRlTWFjaGluZSAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQgfHwgbnVsbDtcclxuICAgIHRoaXMuc3RhdGUgPSB0aGlzLnN0YXRlIHx8IChpbml0aWFsU3RhdGUgPyBpbml0aWFsU3RhdGUubmFtZSA6ICcnKTtcclxuICAgIHRoaXMucGFyc2VyID0gdmFyaWFibGVQYXJzZVNlcnZpY2U7XHJcbiAgICB0aGlzLnN0YXRlTWFjaGluZUV2ZW50ID0gdGhpcy5zdGF0ZU1hY2hpbmUuc3RhdGVNYWNoaW5lRXZlbnQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDnirbmgIHov4Hnp7tcclxuICAgKiBAcGFyYW0gc3RhdGVOYW1lIOS4i+S4gOeKtuaAgeeahOWQjeensFxyXG4gICAqL1xyXG4gIHRyYW5zaXRUbyhzdGF0ZU5hbWU6IHN0cmluZykge1xyXG4gICAgY29uc3QgbmV4dFN0YXRlID0gdGhpcy5zdGF0ZU1hY2hpbmUuc3RhdGVzW3N0YXRlTmFtZV07XHJcbiAgICBpZiAobmV4dFN0YXRlKSB7XHJcbiAgICAgIHRoaXMuc3RhdGUgPSBuZXh0U3RhdGUubmFtZTtcclxuICAgICAgdGhpcy5zdGF0ZU1hY2hpbmUucmVuZGVyKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwYXJzZShleHByZXNzaW9uOiBzdHJpbmcsIHRhcmdldFR5cGU6ICdzb3VyY2UnIHwgJ3RhcmdldCcpOiBhbnkge1xyXG4gICAgaWYgKGV4cHJlc3Npb24gPT09IG51bGwgfHwgZXhwcmVzc2lvbiA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHJldHVybiBleHByZXNzaW9uO1xyXG4gICAgfVxyXG4gICAgY29uc3QgY29udGV4dCA9IHRoaXMuc3RhdGVNYWNoaW5lRXZlbnQuZ2V0RnJhbWVDb250ZXh0KGV4cHJlc3Npb24pIHx8IHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dDtcclxuICAgIHN3aXRjaCAodGFyZ2V0VHlwZSkge1xyXG4gICAgICBjYXNlICdzb3VyY2UnOlxyXG4gICAgICAgIHJldHVybiB0aGlzLnBhcnNlU291cmNlVmFsdWUoZXhwcmVzc2lvbiwgY29udGV4dCk7XHJcbiAgICAgIGNhc2UgJ3RhcmdldCc6XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VyLnBhcnNlKGV4cHJlc3Npb24sIGNvbnRleHQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwYXJzZVNvdXJjZVZhbHVlKGV4cHJlc3Npb246IHN0cmluZywgY29udGV4dDogYW55KTogYW55IHtcclxuICAgIGlmIChleHByZXNzaW9uID09PSBudWxsIHx8IGV4cHJlc3Npb24gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICByZXR1cm4gZXhwcmVzc2lvbjtcclxuICAgIH1cclxuICAgIGxldCByZXN1bHQgPSBleHByZXNzaW9uLnRyaW0oKTtcclxuICAgIHJlc3VsdCA9IHRoaXMucGFyc2VyLnBhcnNlKHJlc3VsdCwgY29udGV4dCk7XHJcbiAgICBpZiAocmVzdWx0ID09PSAnc3RhdGUnKSB7XHJcbiAgICAgIHJlc3VsdCA9IHRoaXMuc3RhdGU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgLy8g5YW85a655pen54mI5pysXHJcbiAgZ2V0KGV4cHJlc3Npb246IHN0cmluZyk6IGFueSB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRVSVN0YXRlKGV4cHJlc3Npb24pO1xyXG4gIH1cclxuICAvLyDop6PmnpB1aXN0YXRl5Y+Y6YeP6KGo6L6+5byP5bm26L+U5Zue6KGo6L6+5byP55qE5YC8XHJcbiAgZ2V0VUlTdGF0ZShleHByZXNzaW9uOiBzdHJpbmcpOiBhbnkge1xyXG4gICAgaWYgKCFleHByZXNzaW9uKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuc3RhdGVNYWNoaW5lRXZlbnQuZ2V0RnJhbWVDb250ZXh0KGV4cHJlc3Npb24pO1xyXG4gICAgaWYgKCFmcmFtZUNvbnRleHQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zdGF0ZU1hY2hpbmVFdmVudC5MaXN0ZW5VSVN0YXRlQ2hhbmdlKGZyYW1lQ29udGV4dCwgZXhwcmVzc2lvbik7XHJcbiAgICBpZiAodGhpcy5wYXJzZXIpIHtcclxuICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLnBhcnNlci5wYXJzZShleHByZXNzaW9uLCBmcmFtZUNvbnRleHQpO1xyXG4gICAgICBpZiAodmFsdWUgPT09IG51bGwpIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgfVxyXG4gICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiBPYmplY3Qua2V5cyh2YWx1ZSkubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCfmnKrliJ3lp4vljJblj5jph4/op6PmnpDlmajjgIInKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOino+aekGRhdGHlj5jph4/ooajovr7lvI/lubbov5Tlm57ooajovr7lvI/nmoTlgLxcclxuICBnZXREYXRhKGV4cHJlc3Npb246IHN0cmluZyk6IGFueSB7XHJcbiAgICBpZiAoIWV4cHJlc3Npb24pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gdGhpcy5zdGF0ZU1hY2hpbmVFdmVudC5nZXRGcmFtZUNvbnRleHQoZXhwcmVzc2lvbik7XHJcbiAgICBpZiAoIWZyYW1lQ29udGV4dCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLnN0YXRlTWFjaGluZUV2ZW50Lkxpc3RlbkVudGl0eUNoYW5nZShmcmFtZUNvbnRleHQsIGV4cHJlc3Npb24pO1xyXG4gICAgaWYgKHRoaXMucGFyc2VyKSB7XHJcbiAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5wYXJzZXIucGFyc2UoZXhwcmVzc2lvbiwgZnJhbWVDb250ZXh0KTtcclxuICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgT2JqZWN0LmtleXModmFsdWUpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcign5pyq5Yid5aeL5YyW5Y+Y6YeP6Kej5p6Q5Zmo44CCJyk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==