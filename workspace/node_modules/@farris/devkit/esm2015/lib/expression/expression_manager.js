import { Inject, Injectable, Injector } from "@angular/core";
import { BigNumber } from 'bignumber.js';
import { EMPTY, of } from "rxjs";
import { FrameContext } from "../frame/index";
import { Repository } from "../repository/index";
import { ENTITY_TEMPLATE, ResolveService } from "../resolver/index";
import { ExpressionUtil } from "../utils/expression_util";
import { ExpressionExecutor } from "./expression_executor";
import { ExpressionRegistry } from "./expression_registry";
import { Expression } from './types';
import { ExpressionResult } from "./expression_result";
import { MESSAGE_SERVICE_TOKEN, NOTIFY_SERVICE_TOKEN } from "../core/index";
import { TranslateToken } from "../i18n";
export class ExpressionManager {
    constructor(injector, resolveService, expressionExecutor, expressionRegistry, expressionResult, messageService, notifyService) {
        this.injector = injector;
        this.resolveService = resolveService;
        this.expressionExecutor = expressionExecutor;
        this.expressionRegistry = expressionRegistry;
        this.expressionResult = expressionResult;
        this.messageService = messageService;
        this.notifyService = notifyService;
        this.frameContext = null;
        this.frameContext = this.injector.get(FrameContext, null);
    }
    /**
     * 根据表达式id进行计算
     * @param expressionId 表达式id
     * @param viewModel viewModel
     * @param rowData rowData
     * @returns
     */
    eval(expressionId, viewModel, rowData) {
        const expressionObject = this.expressionRegistry.getExpressionById(expressionId);
        if (expressionObject) {
            const customContext = {};
            const bindingPath = viewModel && viewModel.bindingPath || null;
            if (bindingPath && rowData) {
                const bindingPaths = bindingPath.split('/').filter(p => p);
                const bindingList = this.frameContext.bindingData.getValue(bindingPaths);
                let primaryKey = 'id';
                if (bindingList) {
                    primaryKey = bindingList.primaryKey;
                }
                const primaryValue = rowData[primaryKey] || bindingList.currentId;
                if (primaryValue) {
                    customContext.currentRows = [{ bindingPath: bindingPaths.join('/'), primaryValue }];
                }
            }
            let result = this.execute(expressionObject.expression, customContext);
            if (expressionObject.type === Expression.ExpressionType.Readonly || expressionObject.type === Expression.ExpressionType.Required || expressionObject.type === Expression.ExpressionType.Visible) {
                result = result === true ? true : false;
            }
            this.expressionResult.set(expressionId, result);
            return result;
        }
        else {
            // console.warn('ExpressionManager 执行失败，未获取到表达式!');
        }
        return undefined;
    }
    validate(expressionId, options) {
        const expressionObject = this.expressionRegistry.getExpressionById(expressionId);
        if (expressionObject) {
            const patch = options && options.patch || null;
            const customContext = {};
            if (patch) {
                customContext.patch = patch;
            }
            const currentRow = options.currentRow || null;
            const currentRows = options.currentRows || [];
            if (currentRow) {
                customContext.currentRows = customContext.currentRows || [];
                customContext.currentRows.push(currentRow);
            }
            if (currentRows && currentRows.length > 0) {
                customContext.currentRows = customContext.currentRows || [];
                Array.prototype.push.apply(customContext.currentRows, currentRows);
            }
            const result = this.execute(expressionObject.expression, customContext);
            this.expressionResult.set(expressionId, result);
            return result;
        }
        else {
        }
        return undefined;
    }
    /**
     * 帮助前封装
     * @param event
     */
    onDataPicking(configs) {
        const expressionId = configs && configs.expressionId || null;
        if (!expressionId) {
            return of(true);
        }
        const result = this.eval(expressionId);
        if (!result) {
            const expressionObject = this.expressionRegistry.getExpressionById(expressionId);
            if (!expressionObject) {
                return of(true);
            }
            const messageType = expressionObject.messageType || Expression.MessageType.warning;
            const message = expressionObject.message;
            if (message) {
                this.notifyService[messageType](message, { hideTitle: true });
            }
            return EMPTY;
        }
        return of(result);
    }
    /**
     * 执行表达式计算
     * @param expression 表达式
     * @param customContext 自定义上下文
     * @returns
     */
    execute(expression, customContext) {
        const deps = this.resolveService.resolve(expression);
        const groupDependencies = ExpressionUtil.getGroupFunctionDependency(expression, this.frameContext.repository.entityTypeInfo);
        const entityContext = this.buildEntityContext(deps, groupDependencies, customContext);
        const stateContext = this.buildStateContext();
        const data = customContext && customContext.contexts || null;
        const translate = this.injector.get(TranslateToken, null);
        const context = Object.assign({ [this.entityOriginalNodeCode]: entityContext }, stateContext, { BigNumber, frameContext: this.frameContext, bindingData: this.frameContext.bindingData, repository: this.frameContext.repository, CurrentLanguage: translate.getCurrentLanguage() || 'zh-CHS' }, data);
        if (!entityContext) {
            return undefined;
        }
        return this.expressionExecutor.eval(expression, context);
    }
    /**
     * 执行表达式（返回可观察对象）
     * @param expression 表达式
     * @param customContext 自定义上下文
     * @returns
     */
    executeAsync(expression, customContext) {
        const result = this.execute(expression, customContext);
        return of(result);
    }
    /**
     * 构造实体上下文
     * @param deps
     * @param groupDependencies
     * @param context
     * @returns
     */
    buildEntityContext(deps, groupDependencies, context) {
        const currentRows = context && context.currentRows || null;
        const index = deps.findIndex((dep) => {
            const isEntityDependency = this.isEntityDependency(dep);
            // 如果依赖的是state，无需处理，现在需要确定的是返回多少实体的问题，和state没有关系
            // 表达式依赖了实体
            if (isEntityDependency) {
                const isGroupDependency = groupDependencies.findIndex(item => item === dep) !== -1;
                // 是聚合依赖
                if (isGroupDependency) {
                    const dependencyLength = dep.split('/').filter(p => p).length - 1;
                    if (dependencyLength === 1) {
                        // 聚合了主表字段，所有主表数据都需要参与运算，此时已经确定计算的实体上下文了。
                        return true;
                    }
                    else {
                        // 聚合了子表字段，只需要传递当前实体
                        return false;
                    }
                }
                else {
                    // 当前依赖不是聚合，只需要传递当前实体
                    return false;
                }
            }
            return false;
        });
        const isGroupdMainEntity = index !== -1;
        const options = {};
        if (currentRows && currentRows.length > 0) {
            currentRows.forEach((currentRow) => {
                options[currentRow.bindingPath || '/'] = currentRow.primaryValue;
            });
        }
        const entity = this.getEntity(options);
        const patch = context && context.patch || null;
        if (!entity) {
            return {};
        }
        if (patch && Object.keys(patch).length > 0) {
            Object.keys(patch).forEach((key) => {
                const paths = key.split('/').filter(p => p);
                const value = patch[key];
                this.setValue(entity, paths, value);
            });
        }
        if (isGroupdMainEntity) {
            const collection = this.frameContext.repository.entityCollection.toJSON();
            entity['__type__'] = 'List';
            entity['__items__'] = collection;
        }
        return entity;
    }
    setValue(target, paths, value) {
        if (paths.length === 1) {
            target[paths[0]] = value;
        }
        else {
            const propertyName = paths.pop();
            const result = paths.reduce((object, path) => {
                return object && object[path];
            }, target);
            result[propertyName] = value;
        }
    }
    /**
     * 是否为实体依赖
     * @param dep
     * @returns
     */
    isEntityDependency(dep) {
        return dep.startsWith(ENTITY_TEMPLATE);
    }
    /**
     * 获取实体
     * @param options
     * @returns
     */
    getEntity(options) {
        const entityTypeInfo = this.frameContext.repository.entityTypeInfo;
        const bindingData = this.frameContext.bindingData;
        const childrenEntityPaths = [];
        let entity = null;
        if (options['/']) {
            // 修正主表
            entity = this.frameContext.bindingData.list.findById(options['/']);
            if (entity) {
                entity = entity.toJSON();
            }
        }
        else {
            entity = this.frameContext.bindingData.list.currentItem.toJSON();
        }
        if (!entity) {
            return null;
        }
        ExpressionUtil.getChildrenEntityPaths(entityTypeInfo, childrenEntityPaths);
        entity['__type__'] = 'Entity';
        if (!childrenEntityPaths || childrenEntityPaths.length < 1) {
            return entity;
        }
        // 找到所有子表
        childrenEntityPaths.forEach((paths) => {
            let row = null;
            if (options && options[paths.join('/')]) {
                const parentPaths = paths.slice(0, 1);
                if (paths.length == 2 && options[parentPaths.join('/')]) {
                    const parentRow = options[parentPaths.join('/')];
                    // 从从表
                    // 需要切换上级表
                    row = this.getPropertyValue(entity, parentPaths.concat([parentRow, paths[1], options[paths.join('/')]]));
                }
                else {
                    // 不应该使用bindingData，这样就默认使用了当前行
                    const bindingList = bindingData.getValue(paths);
                    const currentRowId = options[paths.join('/')];
                    let currentRow = null;
                    if (currentRowId !== bindingList.currentId) {
                        currentRow = bindingList.findById(currentRowId);
                    }
                    else {
                        currentRow = bindingList.currentItem;
                    }
                    if (currentRow && currentRow.primaryKeyValue) {
                        row = currentRow.toJSON();
                    }
                }
            }
            else {
                // 如果上级表已经切换了当前行，那么下级表也应该切换
                const parentTableCurrentRowChanged = options && !!Object.keys(options).find(path => {
                    const fullPath = path.split('/').join('/');
                    return paths.join('/').startsWith(fullPath);
                }) || false;
                if (parentTableCurrentRowChanged) {
                    const primaryValue = options && options['/'] || bindingData.list.currentId;
                    const entity = this.frameContext.repository.entityCollection.getEntityById(primaryValue);
                    const fullPaths = [];
                    const data = paths.reduce((object, path) => {
                        fullPaths.push(path);
                        const item = object && object[path];
                        if (item) {
                            const currentRowId = options && options[fullPaths.join('/')] || item.items[0] && item.items[0].primaryValue || null;
                            if (currentRowId) {
                                const currentRow = item.get(currentRowId);
                                return currentRow || null;
                            }
                        }
                        return null;
                    }, entity);
                    if (data) {
                        row = data.toJSON();
                    }
                    else {
                        row = {};
                    }
                }
                else {
                    row = ExpressionUtil.getCurrentRowByPaths(paths, bindingData);
                }
            }
            const propertyName = paths.pop();
            let parent = paths.reduce((object, path) => {
                return object && object[path] || null;
            }, entity);
            const list = parent[propertyName];
            const node = Object.assign({ __items__: [] }, row && row || {}, { __type__: 'List' });
            node.length = () => node.__items__.length;
            if (list && Array.isArray(list)) {
                node.__items__ = [].concat(list);
            }
            parent[propertyName] = node;
        });
        return entity;
    }
    getPropertyValue(entity, paths) {
        return paths.reduce((object, path) => {
            if (object['__type__'] === 'List') {
                return object['__items__'].find(item => item.id === path);
            }
            else if (Array.isArray(object)) {
                return object.find(item => item.id === path);
            }
            else {
                return object && object[path];
            }
        }, entity);
    }
    /**
     * 获取主实体原始字段名
     */
    get entityOriginalNodeCode() {
        const repository = this.injector.get(Repository);
        return repository && repository.entityTypeInfo && repository.entityTypeInfo.entityInfo && repository.entityTypeInfo.entityInfo.originalCode || null;
    }
    /**
     * 构造变量上下文
     * @param event
     * @returns
     */
    buildStateContext() {
        const result = {};
        if (this.frameContext) {
            const rootFrameContext = this.frameContext.getVirtualRootFrameContext();
            if (rootFrameContext) {
                const uiState = rootFrameContext.viewModel.uiState;
                const propertyNames = Object.getOwnPropertyNames(uiState) || [];
                propertyNames.forEach((prop) => {
                    if (prop.match(/^[a-zA-Z0-9_\$]+$/g) !== null) {
                        result[prop] = uiState[prop];
                    }
                });
            }
        }
        return result;
    }
}
ExpressionManager.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ExpressionManager.ctorParameters = () => [
    { type: Injector },
    { type: ResolveService },
    { type: ExpressionExecutor },
    { type: ExpressionRegistry },
    { type: ExpressionResult },
    { type: undefined, decorators: [{ type: Inject, args: [MESSAGE_SERVICE_TOKEN,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [NOTIFY_SERVICE_TOKEN,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl9tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZXhwcmVzc2lvbi9leHByZXNzaW9uX21hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFekMsT0FBTyxFQUFFLEtBQUssRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFN0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRXJDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFBbUMscUJBQXFCLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFN0csT0FBTyxFQUFhLGNBQWMsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUdwRCxNQUFNLE9BQU8saUJBQWlCO0lBRTVCLFlBQW9CLFFBQWtCLEVBQVUsY0FBOEIsRUFBVSxrQkFBc0MsRUFBVSxrQkFBc0MsRUFBVSxnQkFBa0MsRUFBeUMsY0FBK0IsRUFBd0MsYUFBNkI7UUFBblYsYUFBUSxHQUFSLFFBQVEsQ0FBVTtR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QWMsQ0FBQyxVQUFVLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQztJQUN0SixDQUFDO0lBQ0Q7Ozs7T0FJRztJQUNJLGlCQUFpQjtRQUN0QixNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFDbEIsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3JCLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQywwQkFBMEIsRUFBRSxDQUFDO1lBQ3hFLElBQUksZ0JBQWdCLEVBQUU7Z0JBQ3BCLE1BQU0sT0FBTyxHQUFHLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUM7Z0JBQ25ELE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ2hFLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFZLEVBQUUsRUFBRTtvQkFDckMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLEtBQUssSUFBSSxFQUFFO3dCQUM3QyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO3FCQUM5QjtnQkFDSCxDQUFDLENBQUMsQ0FBQzthQUNKO1NBQ0Y7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDOzs7WUF0VkYsVUFBVTs7OztZQWxCa0IsUUFBUTtZQU9YLGNBQWM7WUFFL0Isa0JBQWtCO1lBQ2xCLGtCQUFrQjtZQUdsQixnQkFBZ0I7NENBUXNNLE1BQU0sU0FBQyxxQkFBcUI7NENBQTRDLE1BQU0sU0FBQyxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgQmlnTnVtYmVyIH0gZnJvbSAnYmlnbnVtYmVyLmpzJztcclxuaW1wb3J0IHsgQmluZGluZ0RhdGEsIEJpbmRpbmdMaXN0LCBCaW5kaW5nT2JqZWN0IH0gZnJvbSBcIi4uL2JpbmRpbmctZGF0YS9pbmRleFwiO1xyXG5pbXBvcnQgeyBFTVBUWSwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tIFwicnhqc1wiO1xyXG5pbXBvcnQgeyBBcHBDb250ZXh0IH0gZnJvbSBcIi4uL2FwcC9pbmRleFwiO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQgfSBmcm9tIFwiLi4vZnJhbWUvaW5kZXhcIjtcclxuaW1wb3J0IHsgUmVwb3NpdG9yeSB9IGZyb20gXCIuLi9yZXBvc2l0b3J5L2luZGV4XCI7XHJcbmltcG9ydCB7IEVOVElUWV9URU1QTEFURSwgUmVzb2x2ZVNlcnZpY2UgfSBmcm9tIFwiLi4vcmVzb2x2ZXIvaW5kZXhcIjtcclxuaW1wb3J0IHsgRXhwcmVzc2lvblV0aWwgfSBmcm9tIFwiLi4vdXRpbHMvZXhwcmVzc2lvbl91dGlsXCI7XHJcbmltcG9ydCB7IEV4cHJlc3Npb25FeGVjdXRvciB9IGZyb20gXCIuL2V4cHJlc3Npb25fZXhlY3V0b3JcIjtcclxuaW1wb3J0IHsgRXhwcmVzc2lvblJlZ2lzdHJ5IH0gZnJvbSBcIi4vZXhwcmVzc2lvbl9yZWdpc3RyeVwiO1xyXG5pbXBvcnQgeyBFeHByZXNzaW9uIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IFZpZXdNb2RlbCB9IGZyb20gXCIuLi92aWV3LW1vZGVsL2luZGV4XCI7XHJcbmltcG9ydCB7IEV4cHJlc3Npb25SZXN1bHQgfSBmcm9tIFwiLi9leHByZXNzaW9uX3Jlc3VsdFwiO1xyXG5pbXBvcnQgeyBJTWVzc2FnZVNlcnZpY2UsIElOb3RpZnlTZXJ2aWNlLCBNRVNTQUdFX1NFUlZJQ0VfVE9LRU4sIE5PVElGWV9TRVJWSUNFX1RPS0VOIH0gZnJvbSBcIi4uL2NvcmUvaW5kZXhcIjtcclxuaW1wb3J0IHsgRW50aXR5LCBFbnRpdHlMaXN0IH0gZnJvbSBcIi4uL2VudGl0eVwiO1xyXG5pbXBvcnQgeyBUcmFuc2xhdGUsIFRyYW5zbGF0ZVRva2VuIH0gZnJvbSBcIi4uL2kxOG5cIjtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEV4cHJlc3Npb25NYW5hZ2VyIHtcclxuICBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0ID0gbnVsbDtcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSByZXNvbHZlU2VydmljZTogUmVzb2x2ZVNlcnZpY2UsIHByaXZhdGUgZXhwcmVzc2lvbkV4ZWN1dG9yOiBFeHByZXNzaW9uRXhlY3V0b3IsIHByaXZhdGUgZXhwcmVzc2lvblJlZ2lzdHJ5OiBFeHByZXNzaW9uUmVnaXN0cnksIHByaXZhdGUgZXhwcmVzc2lvblJlc3VsdDogRXhwcmVzc2lvblJlc3VsdCwgQEluamVjdChNRVNTQUdFX1NFUlZJQ0VfVE9LRU4pIHByaXZhdGUgbWVzc2FnZVNlcnZpY2U6IElNZXNzYWdlU2VydmljZSwgQEluamVjdChOT1RJRllfU0VSVklDRV9UT0tFTikgcHJpdmF0ZSBub3RpZnlTZXJ2aWNlOiBJTm90aWZ5U2VydmljZSkge1xyXG4gICAgdGhpcy5mcmFtZUNvbnRleHQgPSB0aGlzLmluamVjdG9yLmdldDxGcmFtZUNvbnRleHQ+KEZyYW1lQ29udGV4dCwgbnVsbCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOagueaNruihqOi+vuW8j2lk6L+b6KGM6K6h566XXHJcbiAgICogQHBhcmFtIGV4cHJlc3Npb25JZCDooajovr7lvI9pZFxyXG4gICAqIEBwYXJhbSB2aWV3TW9kZWwgdmlld01vZGVsXHJcbiAgICogQHBhcmFtIHJvd0RhdGEgcm93RGF0YVxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBldmFsKGV4cHJlc3Npb25JZDogc3RyaW5nLCB2aWV3TW9kZWw/OiBWaWV3TW9kZWwsIHJvd0RhdGE/OiBhbnkpIHtcclxuICAgIGNvbnN0IGV4cHJlc3Npb25PYmplY3QgPSB0aGlzLmV4cHJlc3Npb25SZWdpc3RyeS5nZXRFeHByZXNzaW9uQnlJZChleHByZXNzaW9uSWQpO1xyXG4gICAgaWYgKGV4cHJlc3Npb25PYmplY3QpIHtcclxuICAgICAgY29uc3QgY3VzdG9tQ29udGV4dDogRXhwcmVzc2lvbi5JQ3VzdG9tQ29udGV4dCA9IHt9O1xyXG4gICAgICBjb25zdCBiaW5kaW5nUGF0aCA9IHZpZXdNb2RlbCAmJiB2aWV3TW9kZWwuYmluZGluZ1BhdGggfHwgbnVsbDtcclxuICAgICAgaWYgKGJpbmRpbmdQYXRoICYmIHJvd0RhdGEpIHtcclxuICAgICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgICAgIGNvbnN0IGJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0VmFsdWUoYmluZGluZ1BhdGhzKSBhcyBCaW5kaW5nTGlzdDtcclxuICAgICAgICBsZXQgcHJpbWFyeUtleSA9ICdpZCc7XHJcbiAgICAgICAgaWYgKGJpbmRpbmdMaXN0KSB7XHJcbiAgICAgICAgICBwcmltYXJ5S2V5ID0gYmluZGluZ0xpc3QucHJpbWFyeUtleTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcHJpbWFyeVZhbHVlID0gcm93RGF0YVtwcmltYXJ5S2V5XSB8fCBiaW5kaW5nTGlzdC5jdXJyZW50SWQ7XHJcbiAgICAgICAgaWYgKHByaW1hcnlWYWx1ZSkge1xyXG4gICAgICAgICAgY3VzdG9tQ29udGV4dC5jdXJyZW50Um93cyA9IFt7IGJpbmRpbmdQYXRoOiBiaW5kaW5nUGF0aHMuam9pbignLycpLCBwcmltYXJ5VmFsdWUgfV07XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGxldCByZXN1bHQgPSB0aGlzLmV4ZWN1dGUoZXhwcmVzc2lvbk9iamVjdC5leHByZXNzaW9uLCBjdXN0b21Db250ZXh0KTtcclxuICAgICAgaWYgKGV4cHJlc3Npb25PYmplY3QudHlwZSA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5SZWFkb25seSB8fCBleHByZXNzaW9uT2JqZWN0LnR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuUmVxdWlyZWQgfHwgZXhwcmVzc2lvbk9iamVjdC50eXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLlZpc2libGUpIHtcclxuICAgICAgICByZXN1bHQgPSByZXN1bHQgPT09IHRydWUgPyB0cnVlIDogZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5leHByZXNzaW9uUmVzdWx0LnNldChleHByZXNzaW9uSWQsIHJlc3VsdCk7XHJcbiAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyBjb25zb2xlLndhcm4oJ0V4cHJlc3Npb25NYW5hZ2VyIOaJp+ihjOWksei0pe+8jOacquiOt+WPluWIsOihqOi+vuW8jyEnKTtcclxuICAgIH1cclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgfVxyXG4gIHB1YmxpYyB2YWxpZGF0ZShleHByZXNzaW9uSWQ6IHN0cmluZywgb3B0aW9uczogYW55KSB7XHJcbiAgICBjb25zdCBleHByZXNzaW9uT2JqZWN0ID0gdGhpcy5leHByZXNzaW9uUmVnaXN0cnkuZ2V0RXhwcmVzc2lvbkJ5SWQoZXhwcmVzc2lvbklkKTtcclxuICAgIGlmIChleHByZXNzaW9uT2JqZWN0KSB7XHJcbiAgICAgIGNvbnN0IHBhdGNoID0gb3B0aW9ucyAmJiBvcHRpb25zLnBhdGNoIHx8IG51bGw7XHJcbiAgICAgIGNvbnN0IGN1c3RvbUNvbnRleHQ6IEV4cHJlc3Npb24uSUN1c3RvbUNvbnRleHQgPSB7fTtcclxuICAgICAgaWYgKHBhdGNoKSB7XHJcbiAgICAgICAgY3VzdG9tQ29udGV4dC5wYXRjaCA9IHBhdGNoO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IGN1cnJlbnRSb3cgPSBvcHRpb25zLmN1cnJlbnRSb3cgfHwgbnVsbDtcclxuICAgICAgY29uc3QgY3VycmVudFJvd3MgPSBvcHRpb25zLmN1cnJlbnRSb3dzIHx8IFtdO1xyXG4gICAgICBpZiAoY3VycmVudFJvdykge1xyXG4gICAgICAgIGN1c3RvbUNvbnRleHQuY3VycmVudFJvd3MgPSBjdXN0b21Db250ZXh0LmN1cnJlbnRSb3dzIHx8IFtdO1xyXG4gICAgICAgIGN1c3RvbUNvbnRleHQuY3VycmVudFJvd3MucHVzaChjdXJyZW50Um93KTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoY3VycmVudFJvd3MgJiYgY3VycmVudFJvd3MubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGN1c3RvbUNvbnRleHQuY3VycmVudFJvd3MgPSBjdXN0b21Db250ZXh0LmN1cnJlbnRSb3dzIHx8IFtdO1xyXG4gICAgICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KGN1c3RvbUNvbnRleHQuY3VycmVudFJvd3MsIGN1cnJlbnRSb3dzKVxyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuZXhlY3V0ZShleHByZXNzaW9uT2JqZWN0LmV4cHJlc3Npb24sIGN1c3RvbUNvbnRleHQpO1xyXG4gICAgICB0aGlzLmV4cHJlc3Npb25SZXN1bHQuc2V0KGV4cHJlc3Npb25JZCwgcmVzdWx0KTtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDluK7liqnliY3lsIHoo4VcclxuICAgKiBAcGFyYW0gZXZlbnQgXHJcbiAgICovXHJcbiAgcHVibGljIG9uRGF0YVBpY2tpbmcoY29uZmlnczogeyBleHByZXNzaW9uSWQ6IHN0cmluZyB9KSB7XHJcbiAgICBjb25zdCBleHByZXNzaW9uSWQgPSBjb25maWdzICYmIGNvbmZpZ3MuZXhwcmVzc2lvbklkIHx8IG51bGw7XHJcbiAgICBpZiAoIWV4cHJlc3Npb25JZCkge1xyXG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmV2YWwoZXhwcmVzc2lvbklkKTtcclxuICAgIGlmICghcmVzdWx0KSB7XHJcbiAgICAgIGNvbnN0IGV4cHJlc3Npb25PYmplY3QgPSB0aGlzLmV4cHJlc3Npb25SZWdpc3RyeS5nZXRFeHByZXNzaW9uQnlJZChleHByZXNzaW9uSWQpO1xyXG4gICAgICBpZiAoIWV4cHJlc3Npb25PYmplY3QpIHtcclxuICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgbWVzc2FnZVR5cGUgPSBleHByZXNzaW9uT2JqZWN0Lm1lc3NhZ2VUeXBlIHx8IEV4cHJlc3Npb24uTWVzc2FnZVR5cGUud2FybmluZztcclxuICAgICAgY29uc3QgbWVzc2FnZSA9IGV4cHJlc3Npb25PYmplY3QubWVzc2FnZTtcclxuICAgICAgaWYgKG1lc3NhZ2UpIHtcclxuICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2VbbWVzc2FnZVR5cGVdKG1lc3NhZ2UsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIHJldHVybiBvZihyZXN1bHQpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmiafooYzooajovr7lvI/orqHnrpdcclxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbiDooajovr7lvI9cclxuICAgKiBAcGFyYW0gY3VzdG9tQ29udGV4dCDoh6rlrprkuYnkuIrkuIvmlodcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwcml2YXRlIGV4ZWN1dGUoZXhwcmVzc2lvbjogc3RyaW5nLCBjdXN0b21Db250ZXh0PzogRXhwcmVzc2lvbi5JQ3VzdG9tQ29udGV4dCk6IGFueSB7XHJcbiAgICBjb25zdCBkZXBzID0gdGhpcy5yZXNvbHZlU2VydmljZS5yZXNvbHZlKGV4cHJlc3Npb24pO1xyXG4gICAgY29uc3QgZ3JvdXBEZXBlbmRlbmNpZXMgPSBFeHByZXNzaW9uVXRpbC5nZXRHcm91cEZ1bmN0aW9uRGVwZW5kZW5jeShleHByZXNzaW9uLCB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvKTtcclxuICAgIGNvbnN0IGVudGl0eUNvbnRleHQgPSB0aGlzLmJ1aWxkRW50aXR5Q29udGV4dChkZXBzLCBncm91cERlcGVuZGVuY2llcywgY3VzdG9tQ29udGV4dCk7XHJcbiAgICBjb25zdCBzdGF0ZUNvbnRleHQgPSB0aGlzLmJ1aWxkU3RhdGVDb250ZXh0KCk7XHJcbiAgICBjb25zdCBkYXRhID0gY3VzdG9tQ29udGV4dCAmJiBjdXN0b21Db250ZXh0LmNvbnRleHRzIHx8IG51bGw7XHJcbiAgICBjb25zdCB0cmFuc2xhdGUgPSB0aGlzLmluamVjdG9yLmdldDxUcmFuc2xhdGU+KFRyYW5zbGF0ZVRva2VuLCBudWxsKTtcclxuICAgIGNvbnN0IGNvbnRleHQgPSB7XHJcbiAgICAgIFt0aGlzLmVudGl0eU9yaWdpbmFsTm9kZUNvZGVdOiBlbnRpdHlDb250ZXh0LFxyXG4gICAgICAuLi5zdGF0ZUNvbnRleHQsXHJcbiAgICAgIEJpZ051bWJlcixcclxuICAgICAgZnJhbWVDb250ZXh0OiB0aGlzLmZyYW1lQ29udGV4dCxcclxuICAgICAgYmluZGluZ0RhdGE6IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLFxyXG4gICAgICByZXBvc2l0b3J5OiB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LFxyXG4gICAgICBDdXJyZW50TGFuZ3VhZ2U6IHRyYW5zbGF0ZS5nZXRDdXJyZW50TGFuZ3VhZ2UoKSB8fCAnemgtQ0hTJyxcclxuICAgICAgLi4uZGF0YVxyXG4gICAgfVxyXG4gICAgaWYgKCFlbnRpdHlDb250ZXh0KSB7XHJcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5leHByZXNzaW9uRXhlY3V0b3IuZXZhbChleHByZXNzaW9uLCBjb250ZXh0KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5omn6KGM6KGo6L6+5byP77yI6L+U5Zue5Y+v6KeC5a+f5a+56LGh77yJXHJcbiAgICogQHBhcmFtIGV4cHJlc3Npb24g6KGo6L6+5byPXHJcbiAgICogQHBhcmFtIGN1c3RvbUNvbnRleHQg6Ieq5a6a5LmJ5LiK5LiL5paHXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBleGVjdXRlQXN5bmMoZXhwcmVzc2lvbjogc3RyaW5nLCBjdXN0b21Db250ZXh0PzogRXhwcmVzc2lvbi5JQ3VzdG9tQ29udGV4dCk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmV4ZWN1dGUoZXhwcmVzc2lvbiwgY3VzdG9tQ29udGV4dCk7XHJcbiAgICByZXR1cm4gb2YocmVzdWx0KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5a6e5L2T5LiK5LiL5paHXHJcbiAgICogQHBhcmFtIGRlcHMgXHJcbiAgICogQHBhcmFtIGdyb3VwRGVwZW5kZW5jaWVzIFxyXG4gICAqIEBwYXJhbSBjb250ZXh0IFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGRFbnRpdHlDb250ZXh0KGRlcHM6IHN0cmluZ1tdLCBncm91cERlcGVuZGVuY2llczogc3RyaW5nW10sIGNvbnRleHQ/OiBFeHByZXNzaW9uLklDdXN0b21Db250ZXh0KSB7XHJcblxyXG4gICAgY29uc3QgY3VycmVudFJvd3MgPSBjb250ZXh0ICYmIGNvbnRleHQuY3VycmVudFJvd3MgfHwgbnVsbDtcclxuICAgIGNvbnN0IGluZGV4ID0gZGVwcy5maW5kSW5kZXgoKGRlcDogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IGlzRW50aXR5RGVwZW5kZW5jeSA9IHRoaXMuaXNFbnRpdHlEZXBlbmRlbmN5KGRlcCk7XHJcbiAgICAgIC8vIOWmguaenOS+nei1lueahOaYr3N0YXRl77yM5peg6ZyA5aSE55CG77yM546w5Zyo6ZyA6KaB56Gu5a6a55qE5piv6L+U5Zue5aSa5bCR5a6e5L2T55qE6Zeu6aKY77yM5ZKMc3RhdGXmsqHmnInlhbPns7tcclxuICAgICAgLy8g6KGo6L6+5byP5L6d6LWW5LqG5a6e5L2TXHJcbiAgICAgIGlmIChpc0VudGl0eURlcGVuZGVuY3kpIHtcclxuICAgICAgICBjb25zdCBpc0dyb3VwRGVwZW5kZW5jeSA9IGdyb3VwRGVwZW5kZW5jaWVzLmZpbmRJbmRleChpdGVtID0+IGl0ZW0gPT09IGRlcCkgIT09IC0xO1xyXG4gICAgICAgIC8vIOaYr+iBmuWQiOS+nei1llxyXG4gICAgICAgIGlmIChpc0dyb3VwRGVwZW5kZW5jeSkge1xyXG4gICAgICAgICAgY29uc3QgZGVwZW5kZW5jeUxlbmd0aCA9IGRlcC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLmxlbmd0aCAtIDE7XHJcbiAgICAgICAgICBpZiAoZGVwZW5kZW5jeUxlbmd0aCA9PT0gMSkge1xyXG4gICAgICAgICAgICAvLyDogZrlkIjkuobkuLvooajlrZfmrrXvvIzmiYDmnInkuLvooajmlbDmja7pg73pnIDopoHlj4LkuI7ov5DnrpfvvIzmraTml7blt7Lnu4/noa7lrprorqHnrpfnmoTlrp7kvZPkuIrkuIvmlofkuobjgIJcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyDogZrlkIjkuoblrZDooajlrZfmrrXvvIzlj6rpnIDopoHkvKDpgJLlvZPliY3lrp7kvZNcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyDlvZPliY3kvp3otZbkuI3mmK/ogZrlkIjvvIzlj6rpnIDopoHkvKDpgJLlvZPliY3lrp7kvZNcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfSlcclxuICAgIGNvbnN0IGlzR3JvdXBkTWFpbkVudGl0eSA9IGluZGV4ICE9PSAtMTtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0ge307XHJcbiAgICBpZiAoY3VycmVudFJvd3MgJiYgY3VycmVudFJvd3MubGVuZ3RoID4gMCkge1xyXG4gICAgICBjdXJyZW50Um93cy5mb3JFYWNoKChjdXJyZW50Um93OiBFeHByZXNzaW9uLklDdXJyZW50Um93KSA9PiB7XHJcbiAgICAgICAgb3B0aW9uc1tjdXJyZW50Um93LmJpbmRpbmdQYXRoIHx8ICcvJ10gPSBjdXJyZW50Um93LnByaW1hcnlWYWx1ZTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBlbnRpdHkgPSB0aGlzLmdldEVudGl0eShvcHRpb25zKTtcclxuICAgIGNvbnN0IHBhdGNoID0gY29udGV4dCAmJiBjb250ZXh0LnBhdGNoIHx8IG51bGw7XHJcbiAgICBpZiAoIWVudGl0eSkge1xyXG4gICAgICByZXR1cm4ge307XHJcbiAgICB9XHJcbiAgICBpZiAocGF0Y2ggJiYgT2JqZWN0LmtleXMocGF0Y2gpLmxlbmd0aCA+IDApIHtcclxuICAgICAgT2JqZWN0LmtleXMocGF0Y2gpLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgY29uc3QgcGF0aHMgPSBrZXkuc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgICAgICBjb25zdCB2YWx1ZSA9IHBhdGNoW2tleV07XHJcbiAgICAgICAgdGhpcy5zZXRWYWx1ZShlbnRpdHksIHBhdGhzLCB2YWx1ZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKGlzR3JvdXBkTWFpbkVudGl0eSkge1xyXG4gICAgICBjb25zdCBjb2xsZWN0aW9uID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLnRvSlNPTigpO1xyXG4gICAgICBlbnRpdHlbJ19fdHlwZV9fJ10gPSAnTGlzdCc7XHJcbiAgICAgIGVudGl0eVsnX19pdGVtc19fJ10gPSBjb2xsZWN0aW9uO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGVudGl0eTtcclxuICB9XHJcbiAgcHJpdmF0ZSBzZXRWYWx1ZSh0YXJnZXQ6IGFueSwgcGF0aHM6IHN0cmluZ1tdLCB2YWx1ZTogYW55KSB7XHJcbiAgICBpZiAocGF0aHMubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgIHRhcmdldFtwYXRoc1swXV0gPSB2YWx1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHBhdGhzLnBvcCgpO1xyXG4gICAgICBjb25zdCByZXN1bHQgPSBwYXRocy5yZWR1Y2UoKG9iamVjdDogYW55LCBwYXRoOiBzdHJpbmcpID0+IHtcclxuICAgICAgICByZXR1cm4gb2JqZWN0ICYmIG9iamVjdFtwYXRoXTtcclxuICAgICAgfSwgdGFyZ2V0KTtcclxuICAgICAgcmVzdWx0W3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5piv5ZCm5Li65a6e5L2T5L6d6LWWXHJcbiAgICogQHBhcmFtIGRlcCBcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwcml2YXRlIGlzRW50aXR5RGVwZW5kZW5jeShkZXA6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIGRlcC5zdGFydHNXaXRoKEVOVElUWV9URU1QTEFURSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWunuS9k1xyXG4gICAqIEBwYXJhbSBvcHRpb25zIFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRFbnRpdHkob3B0aW9uczogeyBbYmluZGluZ1BhdGg6IHN0cmluZ106IHN0cmluZyB9KSB7XHJcbiAgICBjb25zdCBlbnRpdHlUeXBlSW5mbyA9IHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm87XHJcbiAgICBjb25zdCBiaW5kaW5nRGF0YSA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhO1xyXG4gICAgY29uc3QgY2hpbGRyZW5FbnRpdHlQYXRocyA9IFtdO1xyXG5cclxuICAgIGxldCBlbnRpdHkgPSBudWxsO1xyXG4gICAgaWYgKG9wdGlvbnNbJy8nXSkge1xyXG4gICAgICAvLyDkv67mraPkuLvooahcclxuICAgICAgZW50aXR5ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5maW5kQnlJZChvcHRpb25zWycvJ10pO1xyXG4gICAgICBpZiAoZW50aXR5KSB7XHJcbiAgICAgICAgZW50aXR5ID0gZW50aXR5LnRvSlNPTigpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBlbnRpdHkgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJdGVtLnRvSlNPTigpO1xyXG4gICAgfVxyXG4gICAgaWYgKCFlbnRpdHkpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBFeHByZXNzaW9uVXRpbC5nZXRDaGlsZHJlbkVudGl0eVBhdGhzKGVudGl0eVR5cGVJbmZvLCBjaGlsZHJlbkVudGl0eVBhdGhzKTtcclxuICAgIGVudGl0eVsnX190eXBlX18nXSA9ICdFbnRpdHknO1xyXG4gICAgaWYgKCFjaGlsZHJlbkVudGl0eVBhdGhzIHx8IGNoaWxkcmVuRW50aXR5UGF0aHMubGVuZ3RoIDwgMSkge1xyXG4gICAgICByZXR1cm4gZW50aXR5O1xyXG4gICAgfVxyXG4gICAgLy8g5om+5Yiw5omA5pyJ5a2Q6KGoXHJcbiAgICBjaGlsZHJlbkVudGl0eVBhdGhzLmZvckVhY2goKHBhdGhzOiBzdHJpbmdbXSkgPT4ge1xyXG4gICAgICBsZXQgcm93ID0gbnVsbDtcclxuICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9uc1twYXRocy5qb2luKCcvJyldKSB7XHJcbiAgICAgICAgY29uc3QgcGFyZW50UGF0aHMgPSBwYXRocy5zbGljZSgwLCAxKTtcclxuICAgICAgICBpZiAocGF0aHMubGVuZ3RoID09IDIgJiYgb3B0aW9uc1twYXJlbnRQYXRocy5qb2luKCcvJyldKSB7XHJcbiAgICAgICAgICBjb25zdCBwYXJlbnRSb3cgPSBvcHRpb25zW3BhcmVudFBhdGhzLmpvaW4oJy8nKV07XHJcbiAgICAgICAgICAvLyDku47ku47ooahcclxuICAgICAgICAgIC8vIOmcgOimgeWIh+aNouS4iue6p+ihqFxyXG4gICAgICAgICAgcm93ID0gdGhpcy5nZXRQcm9wZXJ0eVZhbHVlKGVudGl0eSwgcGFyZW50UGF0aHMuY29uY2F0KFtwYXJlbnRSb3csIHBhdGhzWzFdLCBvcHRpb25zW3BhdGhzLmpvaW4oJy8nKV1dKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIC8vIOS4jeW6lOivpeS9v+eUqGJpbmRpbmdEYXRh77yM6L+Z5qC35bCx6buY6K6k5L2/55So5LqG5b2T5YmN6KGMXHJcbiAgICAgICAgICBjb25zdCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QgPSBiaW5kaW5nRGF0YS5nZXRWYWx1ZShwYXRocykgYXMgQmluZGluZ0xpc3Q7XHJcbiAgICAgICAgICBjb25zdCBjdXJyZW50Um93SWQgPSBvcHRpb25zW3BhdGhzLmpvaW4oJy8nKV07XHJcbiAgICAgICAgICBsZXQgY3VycmVudFJvdzogQmluZGluZ09iamVjdCA9IG51bGw7XHJcbiAgICAgICAgICBpZiAoY3VycmVudFJvd0lkICE9PSBiaW5kaW5nTGlzdC5jdXJyZW50SWQpIHtcclxuICAgICAgICAgICAgY3VycmVudFJvdyA9IGJpbmRpbmdMaXN0LmZpbmRCeUlkKGN1cnJlbnRSb3dJZCk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjdXJyZW50Um93ID0gYmluZGluZ0xpc3QuY3VycmVudEl0ZW07XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBpZiAoY3VycmVudFJvdyAmJiBjdXJyZW50Um93LnByaW1hcnlLZXlWYWx1ZSkge1xyXG4gICAgICAgICAgICByb3cgPSBjdXJyZW50Um93LnRvSlNPTigpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyDlpoLmnpzkuIrnuqfooajlt7Lnu4/liIfmjaLkuoblvZPliY3ooYzvvIzpgqPkuYjkuIvnuqfooajkuZ/lupTor6XliIfmjaJcclxuICAgICAgICBjb25zdCBwYXJlbnRUYWJsZUN1cnJlbnRSb3dDaGFuZ2VkID0gb3B0aW9ucyAmJiAhIU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbmQocGF0aCA9PiB7XHJcbiAgICAgICAgICBjb25zdCBmdWxsUGF0aCA9IHBhdGguc3BsaXQoJy8nKS5qb2luKCcvJyk7XHJcbiAgICAgICAgICByZXR1cm4gcGF0aHMuam9pbignLycpLnN0YXJ0c1dpdGgoZnVsbFBhdGgpO1xyXG4gICAgICAgIH0pIHx8IGZhbHNlO1xyXG4gICAgICAgIGlmIChwYXJlbnRUYWJsZUN1cnJlbnRSb3dDaGFuZ2VkKSB7XHJcbiAgICAgICAgICBjb25zdCBwcmltYXJ5VmFsdWUgPSBvcHRpb25zICYmIG9wdGlvbnNbJy8nXSB8fCBiaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZDtcclxuICAgICAgICAgIGNvbnN0IGVudGl0eSA9IHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdHlCeUlkKHByaW1hcnlWYWx1ZSk7XHJcbiAgICAgICAgICBjb25zdCBmdWxsUGF0aHMgPSBbXTtcclxuICAgICAgICAgIGNvbnN0IGRhdGEgPSBwYXRocy5yZWR1Y2UoKG9iamVjdCwgcGF0aCkgPT4ge1xyXG4gICAgICAgICAgICBmdWxsUGF0aHMucHVzaChwYXRoKTtcclxuICAgICAgICAgICAgY29uc3QgaXRlbSA9IG9iamVjdCAmJiBvYmplY3RbcGF0aF0gYXMgRW50aXR5TGlzdDxFbnRpdHk+O1xyXG4gICAgICAgICAgICBpZiAoaXRlbSkge1xyXG4gICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRSb3dJZCA9IG9wdGlvbnMgJiYgb3B0aW9uc1tmdWxsUGF0aHMuam9pbignLycpXSB8fCBpdGVtLml0ZW1zWzBdICYmIGl0ZW0uaXRlbXNbMF0ucHJpbWFyeVZhbHVlIHx8IG51bGw7XHJcbiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRSb3dJZCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFJvdyA9IGl0ZW0uZ2V0KGN1cnJlbnRSb3dJZCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFJvdyB8fCBudWxsO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgIH0sIGVudGl0eSkgYXMgRW50aXR5O1xyXG4gICAgICAgICAgaWYgKGRhdGEpIHtcclxuICAgICAgICAgICAgcm93ID0gZGF0YS50b0pTT04oKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJvdyA9IHt9O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByb3cgPSBFeHByZXNzaW9uVXRpbC5nZXRDdXJyZW50Um93QnlQYXRocyhwYXRocywgYmluZGluZ0RhdGEpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwYXRocy5wb3AoKTtcclxuICAgICAgbGV0IHBhcmVudCA9IHBhdGhzLnJlZHVjZSgob2JqZWN0OiBhbnksIHBhdGg6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIHJldHVybiBvYmplY3QgJiYgb2JqZWN0W3BhdGhdIHx8IG51bGw7XHJcbiAgICAgIH0sIGVudGl0eSk7XHJcbiAgICAgIGNvbnN0IGxpc3QgPSBwYXJlbnRbcHJvcGVydHlOYW1lXTtcclxuICAgICAgY29uc3Qgbm9kZTogYW55ID0geyBfX2l0ZW1zX186IFtdLCAuLi5yb3cgJiYgcm93IHx8IHt9LCBfX3R5cGVfXzogJ0xpc3QnIH07XHJcbiAgICAgIG5vZGUubGVuZ3RoID0gKCkgPT4gbm9kZS5fX2l0ZW1zX18ubGVuZ3RoO1xyXG4gICAgICBpZiAobGlzdCAmJiBBcnJheS5pc0FycmF5KGxpc3QpKSB7XHJcbiAgICAgICAgbm9kZS5fX2l0ZW1zX18gPSBbXS5jb25jYXQobGlzdCk7XHJcbiAgICAgIH1cclxuICAgICAgcGFyZW50W3Byb3BlcnR5TmFtZV0gPSBub2RlO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gZW50aXR5O1xyXG4gIH1cclxuICBwcml2YXRlIGdldFByb3BlcnR5VmFsdWUoZW50aXR5OiBhbnksIHBhdGhzOiBzdHJpbmdbXSkge1xyXG4gICAgcmV0dXJuIHBhdGhzLnJlZHVjZSgob2JqZWN0OiBhbnksIHBhdGg6IHN0cmluZykgPT4ge1xyXG4gICAgICBpZiAob2JqZWN0WydfX3R5cGVfXyddID09PSAnTGlzdCcpIHtcclxuICAgICAgICByZXR1cm4gb2JqZWN0WydfX2l0ZW1zX18nXS5maW5kKGl0ZW0gPT4gaXRlbS5pZCA9PT0gcGF0aCk7XHJcbiAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShvYmplY3QpKSB7XHJcbiAgICAgICAgcmV0dXJuIG9iamVjdC5maW5kKGl0ZW0gPT4gaXRlbS5pZCA9PT0gcGF0aCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIG9iamVjdCAmJiBvYmplY3RbcGF0aF07XHJcbiAgICAgIH1cclxuICAgIH0sIGVudGl0eSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluS4u+WunuS9k+WOn+Wni+Wtl+auteWQjVxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBnZXQgZW50aXR5T3JpZ2luYWxOb2RlQ29kZSgpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgcmVwb3NpdG9yeSA9IHRoaXMuaW5qZWN0b3IuZ2V0KFJlcG9zaXRvcnkpO1xyXG4gICAgcmV0dXJuIHJlcG9zaXRvcnkgJiYgcmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbyAmJiByZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvLmVudGl0eUluZm8gJiYgcmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mby5lbnRpdHlJbmZvLm9yaWdpbmFsQ29kZSB8fCBudWxsO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmnoTpgKDlj5jph4/kuIrkuIvmlodcclxuICAgKiBAcGFyYW0gZXZlbnQgXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIGJ1aWxkU3RhdGVDb250ZXh0KCkge1xyXG4gICAgY29uc3QgcmVzdWx0ID0ge307XHJcbiAgICBpZiAodGhpcy5mcmFtZUNvbnRleHQpIHtcclxuICAgICAgY29uc3Qgcm9vdEZyYW1lQ29udGV4dCA9IHRoaXMuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XHJcbiAgICAgIGlmIChyb290RnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgY29uc3QgdWlTdGF0ZSA9IHJvb3RGcmFtZUNvbnRleHQudmlld01vZGVsLnVpU3RhdGU7XHJcbiAgICAgICAgY29uc3QgcHJvcGVydHlOYW1lcyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHVpU3RhdGUpIHx8IFtdO1xyXG4gICAgICAgIHByb3BlcnR5TmFtZXMuZm9yRWFjaCgocHJvcDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICBpZiAocHJvcC5tYXRjaCgvXlthLXpBLVowLTlfXFwkXSskL2cpICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdFtwcm9wXSA9IHVpU3RhdGVbcHJvcF07XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG59Il19