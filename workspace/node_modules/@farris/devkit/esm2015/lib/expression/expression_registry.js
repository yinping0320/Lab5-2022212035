import { Inject, Injectable, Injector, Optional } from "@angular/core";
import { of } from "rxjs";
import { catchError, switchMap } from "rxjs/operators";
import { Expression } from './types';
import { FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN } from "../manifest/index";
import { TranslateToken } from "../i18n/index";
import { Repository } from "../repository/index";
export class ExpressionRegistry {
    constructor(injector, formExpressionManifestService, translate) {
        this.injector = injector;
        this.formExpressionManifestService = formExpressionManifestService;
        this.translate = translate;
        this._expressions = null;
    }
    /**
     * 加载表达式文件
     */
    load() {
        return this.formExpressionManifestService.load().pipe(switchMap((describe) => {
            const expressions = [];
            const exprs = Array.from(describe);
            exprs.forEach((expr) => {
                expr.expressions.forEach((expression) => {
                    const expressionObject = {
                        id: expression.id,
                        ns: expr.ns,
                        path: expr.path,
                        bindingType: expr.type,
                        type: expression.type,
                        expression: expression.value || expression.expr || '',
                        message: expression.message || null,
                        messageType: expression.messageType || null,
                        deps: []
                    };
                    if ((expression.type === Expression.ExpressionType.Required || expression.type === Expression.ExpressionType.Validate || expression.type === Expression.ExpressionType.DataPicking)) {
                        if (!expression.message) {
                            expressionObject.message = this.getExpressionMessage(expression.type);
                        }
                        if (!expression.messageType) {
                            expressionObject.messageType = 'error';
                        }
                    }
                    if (expressionObject.message) {
                        this.transform(expressionObject);
                    }
                    expressions.push(expressionObject);
                });
            });
            this._expressions = expressions;
            this.cleanSpecialCharacters();
            return of(expressions);
        }), catchError((e) => {
            return of([]);
        }));
    }
    /**
     * 获取所有表达式
     */
    get expressions() {
        if (this._expressions) {
            return of(this._expressions);
        }
        return this.load();
    }
    /**
     * 根据表达式id获取对应的表达式对象
     * @param id 表达式id
     * @returns
     */
    getExpressionById(id) {
        if (!this._expressions || this._expressions.length < 1) {
            return null;
        }
        return this._expressions.find((expressionObject) => expressionObject.id === id);
    }
    getExpressionMessage(expressionType, defaultValue) {
        if (!(expressionType === Expression.ExpressionType.Validate || expressionType === Expression.ExpressionType.Required || expressionType === Expression.ExpressionType.DataPicking)) {
            return null;
        }
        if (!this.translate) {
            return defaultValue;
        }
        const currentLanguage = this.translate.getCurrentLanguage() || 'zh-CHS';
        return Expression.MESSAGE[currentLanguage][expressionType];
    }
    transform(expressionObject) {
        if (!this.translate) {
            return;
        }
        if (expressionObject.message && expressionObject.message.startsWith('{{') && expressionObject.message.endsWith('}}')) {
            expressionObject.message = this.translate.transform(expressionObject.message.substr(2, expressionObject.message.length - 4), null) || this.getExpressionMessage(expressionObject.type);
        }
    }
    cleanSpecialCharacters() {
        if (!this._expressions || this._expressions.length < 1 || !Array.isArray(this._expressions)) {
            return;
        }
        const repository = this.injector.get(Repository, null);
        if (!repository) {
            return;
        }
        const entityTypeInfo = repository.entityTypeInfo;
        const regex = new RegExp(`[\\'\\"]?\\s*(${entityTypeInfo.entityInfo.nodeCode}|${entityTypeInfo.entityInfo.originalCode})[\\.\\[\\]a-zA-Z0-9_]+\\s*[\\'\\"]?`, 'g');
        this._expressions.forEach((expressionObject) => {
            const expr = expressionObject.expression;
            const entityPropertyExpressions = expr.match(regex);
            if (Array.isArray(entityPropertyExpressions) && entityPropertyExpressions.length > 0) {
                // 解析出所有实体相关的字符串，以主实体名字开头，包含主实体属性或子表
                entityPropertyExpressions.forEach((item) => {
                    if (item.indexOf('.') === -1) {
                        return;
                    }
                    // 去数组
                    if (/\[\d\]/g.test(item)) {
                        const replacer = item.replace(/\[\d\]/g, '');
                        expressionObject.expression = this.replaceAll(expressionObject.expression, item, replacer);
                    }
                    // 去星号
                    if (/\*/g.test(item)) {
                        const replacer = item.replace(/\*/g, '');
                        expressionObject.expression = this.replaceAll(expressionObject.expression, item, replacer);
                    }
                });
            }
        });
    }
    replaceAll(originalValue, search, replacer) {
        return originalValue.split(search).join(replacer);
    }
}
ExpressionRegistry.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ExpressionRegistry.ctorParameters = () => [
    { type: Injector },
    { type: undefined, decorators: [{ type: Inject, args: [FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [TranslateToken,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl9yZWdpc3RyeS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2V4cHJlc3Npb24vZXhwcmVzc2lvbl9yZWdpc3RyeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZFLE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN2RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxzQ0FBc0MsRUFBa0MsTUFBTSxtQkFBbUIsQ0FBQztBQUMzRyxPQUFPLEVBQWEsY0FBYyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUdqRCxNQUFNLE9BQU8sa0JBQWtCO0lBRTdCLFlBQ1UsUUFBa0IsRUFDOEIsNkJBQTZELEVBQ3pFLFNBQW9CO1FBRnhELGFBQVEsR0FBUixRQUFRLENBQVU7UUFDOEIsa0NBQTZCLEdBQTdCLDZCQUE2QixDQUFnQztRQUN6RSxjQUFTLEdBQVQsU0FBUyxDQUFXO1FBSjFELGlCQUFZLEdBQWtDLElBQUksQ0FBQztJQU0zRCxDQUFDO0lBQ0Q7O09BRUc7SUFDSSxJQUFJO1FBQ1QsT0FBTyxJQUFJLENBQUMsNkJBQTZCLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUNuRCxTQUFTLENBQUMsQ0FBQyxRQUFvQixFQUFFLEVBQUU7WUFDakMsTUFBTSxXQUFXLEdBQXVDLEVBQUUsQ0FBQztZQUMzRCxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ25DLEtBQUssQ0FBQyxPQUFPLENB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QyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7d0JBQ3pDLGdCQUFnQixDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7cUJBQzVGO2dCQUNILENBQUMsQ0FBQyxDQUFDO2FBQ0o7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDTyxVQUFVLENBQUMsYUFBcUIsRUFBRSxNQUFjLEVBQUUsUUFBZ0I7UUFDeEUsT0FBTyxhQUFhLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNwRCxDQUFDOzs7WUE5SEYsVUFBVTs7OztZQVJrQixRQUFROzRDQWFoQyxNQUFNLFNBQUMsc0NBQXNDOzRDQUM3QyxRQUFRLFlBQUksTUFBTSxTQUFDLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yLCBPcHRpb25hbCB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSBcInJ4anNcIjtcclxuaW1wb3J0IHsgY2F0Y2hFcnJvciwgc3dpdGNoTWFwIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XHJcbmltcG9ydCB7IEV4cHJlc3Npb24gfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgRk9STV9FWFBSRVNTSU9OX01BTklGRVNUX1NFUlZJQ0VfVE9LRU4sIElGb3JtRXhwcmVzc2lvbk1hbmlmZXN0U2VydmljZSB9IGZyb20gXCIuLi9tYW5pZmVzdC9pbmRleFwiO1xyXG5pbXBvcnQgeyBUcmFuc2xhdGUsIFRyYW5zbGF0ZVRva2VuIH0gZnJvbSBcIi4uL2kxOG4vaW5kZXhcIjtcclxuaW1wb3J0IHsgUmVwb3NpdG9yeSB9IGZyb20gXCIuLi9yZXBvc2l0b3J5L2luZGV4XCI7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBFeHByZXNzaW9uUmVnaXN0cnkge1xyXG4gIHByaXZhdGUgX2V4cHJlc3Npb25zOiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3RbXSA9IG51bGw7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcixcclxuICAgIEBJbmplY3QoRk9STV9FWFBSRVNTSU9OX01BTklGRVNUX1NFUlZJQ0VfVE9LRU4pIHByaXZhdGUgZm9ybUV4cHJlc3Npb25NYW5pZmVzdFNlcnZpY2U6IElGb3JtRXhwcmVzc2lvbk1hbmlmZXN0U2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoVHJhbnNsYXRlVG9rZW4pIHByaXZhdGUgdHJhbnNsYXRlOiBUcmFuc2xhdGVcclxuICApIHtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yqg6L296KGo6L6+5byP5paH5Lu2XHJcbiAgICovXHJcbiAgcHVibGljIGxvYWQoKTogT2JzZXJ2YWJsZTxFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3RbXT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZm9ybUV4cHJlc3Npb25NYW5pZmVzdFNlcnZpY2UubG9hZCgpLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcCgoZGVzY3JpYmU6IEFycmF5PGFueT4pID0+IHtcclxuICAgICAgICBjb25zdCBleHByZXNzaW9uczogQXJyYXk8RXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0PiA9IFtdO1xyXG4gICAgICAgIGNvbnN0IGV4cHJzID0gQXJyYXkuZnJvbShkZXNjcmliZSk7XHJcbiAgICAgICAgZXhwcnMuZm9yRWFjaCgoZXhwcjogYW55KSA9PiB7XHJcbiAgICAgICAgICBleHByLmV4cHJlc3Npb25zLmZvckVhY2goKGV4cHJlc3Npb246IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QgPSB7XHJcbiAgICAgICAgICAgICAgaWQ6IGV4cHJlc3Npb24uaWQsXHJcbiAgICAgICAgICAgICAgbnM6IGV4cHIubnMsXHJcbiAgICAgICAgICAgICAgcGF0aDogZXhwci5wYXRoLFxyXG4gICAgICAgICAgICAgIGJpbmRpbmdUeXBlOiBleHByLnR5cGUsXHJcbiAgICAgICAgICAgICAgdHlwZTogZXhwcmVzc2lvbi50eXBlLFxyXG4gICAgICAgICAgICAgIGV4cHJlc3Npb246IGV4cHJlc3Npb24udmFsdWUgfHwgZXhwcmVzc2lvbi5leHByIHx8ICcnLFxyXG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGV4cHJlc3Npb24ubWVzc2FnZSB8fCBudWxsLFxyXG4gICAgICAgICAgICAgIG1lc3NhZ2VUeXBlOiBleHByZXNzaW9uLm1lc3NhZ2VUeXBlIHx8IG51bGwsXHJcbiAgICAgICAgICAgICAgZGVwczogW11cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgaWYgKChleHByZXNzaW9uLnR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuUmVxdWlyZWQgfHwgZXhwcmVzc2lvbi50eXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLlZhbGlkYXRlIHx8IGV4cHJlc3Npb24udHlwZSA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5EYXRhUGlja2luZykpIHtcclxuICAgICAgICAgICAgICBpZiAoIWV4cHJlc3Npb24ubWVzc2FnZSkge1xyXG4gICAgICAgICAgICAgICAgZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlID0gdGhpcy5nZXRFeHByZXNzaW9uTWVzc2FnZShleHByZXNzaW9uLnR5cGUpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBpZiAoIWV4cHJlc3Npb24ubWVzc2FnZVR5cGUpIHtcclxuICAgICAgICAgICAgICAgIGV4cHJlc3Npb25PYmplY3QubWVzc2FnZVR5cGUgPSAnZXJyb3InO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy50cmFuc2Zvcm0oZXhwcmVzc2lvbk9iamVjdCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZXhwcmVzc2lvbnMucHVzaChleHByZXNzaW9uT2JqZWN0KTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuX2V4cHJlc3Npb25zID0gZXhwcmVzc2lvbnM7XHJcbiAgICAgICAgdGhpcy5jbGVhblNwZWNpYWxDaGFyYWN0ZXJzKCk7XHJcbiAgICAgICAgcmV0dXJuIG9mKGV4cHJlc3Npb25zKTtcclxuICAgICAgfSksXHJcbiAgICAgIGNhdGNoRXJyb3IoKGUpID0+IHtcclxuICAgICAgICByZXR1cm4gb2YoW10pO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5omA5pyJ6KGo6L6+5byPXHJcbiAgICovXHJcbiAgcHVibGljIGdldCBleHByZXNzaW9ucygpOiBPYnNlcnZhYmxlPEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdFtdPiB7XHJcbiAgICBpZiAodGhpcy5fZXhwcmVzc2lvbnMpIHtcclxuICAgICAgcmV0dXJuIG9mKHRoaXMuX2V4cHJlc3Npb25zKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLmxvYWQoKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5qC55o2u6KGo6L6+5byPaWTojrflj5blr7nlupTnmoTooajovr7lvI/lr7nosaFcclxuICAgKiBAcGFyYW0gaWQg6KGo6L6+5byPaWRcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RXhwcmVzc2lvbkJ5SWQoaWQ6IHN0cmluZyk6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCB7XHJcbiAgICBpZiAoIXRoaXMuX2V4cHJlc3Npb25zIHx8IHRoaXMuX2V4cHJlc3Npb25zLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5fZXhwcmVzc2lvbnMuZmluZCgoZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KSA9PiBleHByZXNzaW9uT2JqZWN0LmlkID09PSBpZCk7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0RXhwcmVzc2lvbk1lc3NhZ2UoZXhwcmVzc2lvblR5cGU6IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUsIGRlZmF1bHRWYWx1ZT86IHN0cmluZykge1xyXG4gICAgaWYgKCEoZXhwcmVzc2lvblR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuVmFsaWRhdGUgfHwgZXhwcmVzc2lvblR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuUmVxdWlyZWQgfHwgZXhwcmVzc2lvblR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuRGF0YVBpY2tpbmcpKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgaWYgKCF0aGlzLnRyYW5zbGF0ZSkge1xyXG4gICAgICByZXR1cm4gZGVmYXVsdFZhbHVlO1xyXG4gICAgfVxyXG4gICAgY29uc3QgY3VycmVudExhbmd1YWdlID0gdGhpcy50cmFuc2xhdGUuZ2V0Q3VycmVudExhbmd1YWdlKCkgfHwgJ3poLUNIUyc7XHJcbiAgICByZXR1cm4gRXhwcmVzc2lvbi5NRVNTQUdFW2N1cnJlbnRMYW5ndWFnZV1bZXhwcmVzc2lvblR5cGVdO1xyXG4gIH1cclxuICBwcml2YXRlIHRyYW5zZm9ybShleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpIHtcclxuICAgIGlmICghdGhpcy50cmFuc2xhdGUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKGV4cHJlc3Npb25PYmplY3QubWVzc2FnZSAmJiBleHByZXNzaW9uT2JqZWN0Lm1lc3NhZ2Uuc3RhcnRzV2l0aCgne3snKSAmJiBleHByZXNzaW9uT2JqZWN0Lm1lc3NhZ2UuZW5kc1dpdGgoJ319JykpIHtcclxuICAgICAgZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlID0gdGhpcy50cmFuc2xhdGUudHJhbnNmb3JtKGV4cHJlc3Npb25PYmplY3QubWVzc2FnZS5zdWJzdHIoMiwgZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlLmxlbmd0aCAtIDQpLCBudWxsKSB8fCB0aGlzLmdldEV4cHJlc3Npb25NZXNzYWdlKGV4cHJlc3Npb25PYmplY3QudHlwZSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgY2xlYW5TcGVjaWFsQ2hhcmFjdGVycygpIHtcclxuICAgIGlmICghdGhpcy5fZXhwcmVzc2lvbnMgfHwgdGhpcy5fZXhwcmVzc2lvbnMubGVuZ3RoIDwgMSB8fCAhQXJyYXkuaXNBcnJheSh0aGlzLl9leHByZXNzaW9ucykpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+ID0gdGhpcy5pbmplY3Rvci5nZXQoUmVwb3NpdG9yeSwgbnVsbCk7XHJcbiAgICBpZiAoIXJlcG9zaXRvcnkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZW50aXR5VHlwZUluZm8gPSByZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvO1xyXG4gICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKGBbXFxcXCdcXFxcXCJdP1xcXFxzKigke2VudGl0eVR5cGVJbmZvLmVudGl0eUluZm8ubm9kZUNvZGV9fCR7ZW50aXR5VHlwZUluZm8uZW50aXR5SW5mby5vcmlnaW5hbENvZGV9KVtcXFxcLlxcXFxbXFxcXF1hLXpBLVowLTlfXStcXFxccypbXFxcXCdcXFxcXCJdP2AsICdnJyk7XHJcbiAgICB0aGlzLl9leHByZXNzaW9ucy5mb3JFYWNoKChleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpID0+IHtcclxuICAgICAgY29uc3QgZXhwciA9IGV4cHJlc3Npb25PYmplY3QuZXhwcmVzc2lvbjtcclxuICAgICAgY29uc3QgZW50aXR5UHJvcGVydHlFeHByZXNzaW9uczogUmVnRXhwTWF0Y2hBcnJheSA9IGV4cHIubWF0Y2gocmVnZXgpO1xyXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShlbnRpdHlQcm9wZXJ0eUV4cHJlc3Npb25zKSAmJiBlbnRpdHlQcm9wZXJ0eUV4cHJlc3Npb25zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAvLyDop6PmnpDlh7rmiYDmnInlrp7kvZPnm7jlhbPnmoTlrZfnrKbkuLLvvIzku6XkuLvlrp7kvZPlkI3lrZflvIDlpLTvvIzljIXlkKvkuLvlrp7kvZPlsZ7mgKfmiJblrZDooahcclxuICAgICAgICBlbnRpdHlQcm9wZXJ0eUV4cHJlc3Npb25zLmZvckVhY2goKGl0ZW06IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgaWYgKGl0ZW0uaW5kZXhPZignLicpID09PSAtMSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyDljrvmlbDnu4RcclxuICAgICAgICAgIGlmICgvXFxbXFxkXFxdL2cudGVzdChpdGVtKSkge1xyXG4gICAgICAgICAgICBjb25zdCByZXBsYWNlciA9IGl0ZW0ucmVwbGFjZSgvXFxbXFxkXFxdL2csICcnKTtcclxuICAgICAgICAgICAgZXhwcmVzc2lvbk9iamVjdC5leHByZXNzaW9uID0gdGhpcy5yZXBsYWNlQWxsKGV4cHJlc3Npb25PYmplY3QuZXhwcmVzc2lvbiwgaXRlbSwgcmVwbGFjZXIpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgLy8g5Y675pif5Y+3XHJcbiAgICAgICAgICBpZiAoL1xcKi9nLnRlc3QoaXRlbSkpIHtcclxuICAgICAgICAgICAgY29uc3QgcmVwbGFjZXIgPSBpdGVtLnJlcGxhY2UoL1xcKi9nLCAnJyk7XHJcbiAgICAgICAgICAgIGV4cHJlc3Npb25PYmplY3QuZXhwcmVzc2lvbiA9IHRoaXMucmVwbGFjZUFsbChleHByZXNzaW9uT2JqZWN0LmV4cHJlc3Npb24sIGl0ZW0sIHJlcGxhY2VyKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgcmVwbGFjZUFsbChvcmlnaW5hbFZhbHVlOiBzdHJpbmcsIHNlYXJjaDogc3RyaW5nLCByZXBsYWNlcjogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gb3JpZ2luYWxWYWx1ZS5zcGxpdChzZWFyY2gpLmpvaW4ocmVwbGFjZXIpO1xyXG4gIH1cclxufSJdfQ==