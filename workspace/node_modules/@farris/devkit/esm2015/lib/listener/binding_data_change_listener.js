import { Inject, Injectable, Injector } from '@angular/core';
import { BindingData, BindingList, ChangeType } from '../binding-data/index';
import { ChangeListener } from './change_listener';
import { Expression } from '../expression/index';
import { NAMESPACE } from '../frame/index';
import { Repository } from '../repository/index';
const EventType = Expression.EventType;
/**
 * 监听bindingList变更
 * @description 主要用于监听行切换等事件
 */
class BindingDataChangeListener extends ChangeListener {
    constructor(injector, bindingData, namespace) {
        super();
        this.injector = injector;
        this.bindingData = bindingData;
        this.namespace = namespace;
        this.repository = null;
        this.repository = this.injector.get(Repository, null);
        this.registerEvent();
    }
    /**
     * 注册值变化事件
     */
    registerEvent() {
        if (this.bindingData && this.bindingData.changes && typeof this.bindingData.changes.subscribe === 'function') {
            this.bindingData.changes.subscribe((change) => {
                if ((change.type === ChangeType.Append && change.isCloned !== true) || change.type === ChangeType.ValueChanged || change.type === ChangeType.Remove || change.type === ChangeType.Load || change.type === ChangeType.SelectionChanged) {
                    let eventType = null;
                    if (change.type === ChangeType.Append) {
                        eventType = EventType.Append;
                    }
                    else if (change.type === ChangeType.ValueChanged) {
                        eventType = EventType.ValueChanged;
                    }
                    else if (change.type === ChangeType.Remove) {
                        eventType = EventType.Remove;
                    }
                    else if (change.type === ChangeType.Load) {
                        // 主表新增
                        if (change.create === true) {
                            eventType = EventType.Append;
                        }
                        else {
                            eventType = EventType.Load;
                        }
                    }
                    else if (change.type === ChangeType.SelectionChanged) {
                        eventType = EventType.SelectionChanged;
                    }
                    const path = this.buildEventPath(change);
                    const modification = {
                        ns: this.namespace,
                        path: path,
                        type: eventType,
                        source: Expression.EventSource.BindingData,
                        value: change.value,
                        id: change.id,
                        isTreeNodeLoadScene: change.isTreeNodeLoadScene
                    };
                    // console.log("BindingDataChangeListener", modification);
                    this.subject.next(modification);
                }
            });
        }
    }
    buildEventPath(change) {
        const path = change.path;
        const paths = [];
        // if (!path || path.length < 1) {
        //   return paths;
        // }
        const primaryValue = this.bindingData.list.currentItem.primaryKeyValue || change.id;
        if (primaryValue) {
            if (!(change.type === ChangeType.Load && change.path.length === 0)) {
                paths.push(`${this.bindingData.list.primaryKey}:${primaryValue}`);
            }
        }
        const currentPath = [];
        for (let index = 0; index < path.length; index++) {
            const propertyName = path[index];
            currentPath.push(propertyName);
            const item = this.bindingData.getValue(currentPath);
            paths.push(propertyName);
            if (item instanceof BindingList) {
                if (currentPath.length < path.length) {
                    const bindingList = item;
                    let currentId = bindingList.currentItem.primaryKeyValue;
                    if (index === path.length - 2 && change.id) {
                        currentId = change.id;
                    }
                    paths.push(`${this.bindingData.list.primaryKey}:${currentId}`);
                }
            }
        }
        return paths;
    }
}
BindingDataChangeListener.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BindingDataChangeListener.ctorParameters = () => [
    { type: Injector },
    { type: BindingData },
    { type: undefined, decorators: [{ type: Inject, args: [NAMESPACE,] }] }
];
export { BindingDataChangeListener };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19kYXRhX2NoYW5nZV9saXN0ZW5lci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2xpc3RlbmVyL2JpbmRpbmdfZGF0YV9jaGFuZ2VfbGlzdGVuZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFVLFVBQVUsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3JGLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDakQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUdqRCxNQUFNLFNBQVMsR0FBRyxVQUFVLENBQUMsU0FBUyxDQUFDO0FBQ3ZDOzs7R0FHRztBQUNILE1BQ00seUJBQTBCLFNBQVEsY0FBYztJQUVwRCxZQUFvQixRQUFrQixFQUFVLFdBQXdCLEVBQTZCLFNBQVM7UUFDNUcsS0FBSyxFQUFFLENBQUM7UUFEVSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFBNkIsY0FBUyxHQUFULFNBQVMsQ0FBQTtRQUR0RyxlQUFVLEdBQW9CLElBQUksQ0FBQztRQUd6QyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN0RCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVEOztPQUVHO0lBQ0ssYUFBYTtRQUNuQixJQUFJLElBQUksQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLFdB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dXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQmluZGluZ0RhdGEsIEJpbmRpbmdMaXN0LCBDaGFuZ2UsIENoYW5nZVR5cGUgfSBmcm9tICcuLi9iaW5kaW5nLWRhdGEvaW5kZXgnO1xyXG5pbXBvcnQgeyBDaGFuZ2VMaXN0ZW5lciB9IGZyb20gJy4vY2hhbmdlX2xpc3RlbmVyJztcclxuaW1wb3J0IHsgRXhwcmVzc2lvbiB9IGZyb20gJy4uL2V4cHJlc3Npb24vaW5kZXgnO1xyXG5pbXBvcnQgeyBOQU1FU1BBQ0UgfSBmcm9tICcuLi9mcmFtZS9pbmRleCc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tICcuLi9yZXBvc2l0b3J5L2luZGV4JztcclxuXHJcbnR5cGUgRXZlbnRBcmdzID0gRXhwcmVzc2lvbi5FdmVudEFyZ3M7XHJcbmNvbnN0IEV2ZW50VHlwZSA9IEV4cHJlc3Npb24uRXZlbnRUeXBlO1xyXG4vKipcclxuICog55uR5ZCsYmluZGluZ0xpc3Tlj5jmm7RcclxuICogQGRlc2NyaXB0aW9uIOS4u+imgeeUqOS6juebkeWQrOihjOWIh+aNouetieS6i+S7tlxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5jbGFzcyBCaW5kaW5nRGF0YUNoYW5nZUxpc3RlbmVyIGV4dGVuZHMgQ2hhbmdlTGlzdGVuZXIge1xyXG4gIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+ID0gbnVsbDtcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSBiaW5kaW5nRGF0YTogQmluZGluZ0RhdGEsIEBJbmplY3QoTkFNRVNQQUNFKSBwcml2YXRlIG5hbWVzcGFjZSkge1xyXG4gICAgc3VwZXIoKTtcclxuICAgIHRoaXMucmVwb3NpdG9yeSA9IHRoaXMuaW5qZWN0b3IuZ2V0KFJlcG9zaXRvcnksIG51bGwpO1xyXG4gICAgdGhpcy5yZWdpc3RlckV2ZW50KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDms6jlhozlgLzlj5jljJbkuovku7ZcclxuICAgKi9cclxuICBwcml2YXRlIHJlZ2lzdGVyRXZlbnQoKSB7XHJcbiAgICBpZiAodGhpcy5iaW5kaW5nRGF0YSAmJiB0aGlzLmJpbmRpbmdEYXRhLmNoYW5nZXMgJiYgdHlwZW9mIHRoaXMuYmluZGluZ0RhdGEuY2hhbmdlcy5zdWJzY3JpYmUgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5iaW5kaW5nRGF0YS5jaGFuZ2VzLnN1YnNjcmliZSgoY2hhbmdlOiBDaGFuZ2UpID0+IHtcclxuICAgICAgICBpZiAoKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLkFwcGVuZCAmJiBjaGFuZ2UuaXNDbG9uZWQgIT09IHRydWUpIHx8IGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlZhbHVlQ2hhbmdlZCB8fCBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5SZW1vdmUgfHwgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuTG9hZCB8fCBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5TZWxlY3Rpb25DaGFuZ2VkKSB7XHJcbiAgICAgICAgICBsZXQgZXZlbnRUeXBlID0gbnVsbDtcclxuICAgICAgICAgIGlmIChjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5BcHBlbmQpIHtcclxuICAgICAgICAgICAgZXZlbnRUeXBlID0gRXZlbnRUeXBlLkFwcGVuZDtcclxuICAgICAgICAgIH0gZWxzZSBpZiAoY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuVmFsdWVDaGFuZ2VkKSB7XHJcbiAgICAgICAgICAgIGV2ZW50VHlwZSA9IEV2ZW50VHlwZS5WYWx1ZUNoYW5nZWQ7XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlJlbW92ZSkge1xyXG4gICAgICAgICAgICBldmVudFR5cGUgPSBFdmVudFR5cGUuUmVtb3ZlO1xyXG4gICAgICAgICAgfSBlbHNlIGlmIChjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5Mb2FkKSB7XHJcbiAgICAgICAgICAgIC8vIOS4u+ihqOaWsOWinlxyXG4gICAgICAgICAgICBpZiAoY2hhbmdlLmNyZWF0ZSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgIGV2ZW50VHlwZSA9IEV2ZW50VHlwZS5BcHBlbmQ7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgZXZlbnRUeXBlID0gRXZlbnRUeXBlLkxvYWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSBpZiAoY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuU2VsZWN0aW9uQ2hhbmdlZCkge1xyXG4gICAgICAgICAgICBldmVudFR5cGUgPSBFdmVudFR5cGUuU2VsZWN0aW9uQ2hhbmdlZFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuYnVpbGRFdmVudFBhdGgoY2hhbmdlKTtcclxuICAgICAgICAgIGNvbnN0IG1vZGlmaWNhdGlvbjogRXZlbnRBcmdzID0ge1xyXG4gICAgICAgICAgICBuczogdGhpcy5uYW1lc3BhY2UsXHJcbiAgICAgICAgICAgIHBhdGg6IHBhdGgsXHJcbiAgICAgICAgICAgIHR5cGU6IGV2ZW50VHlwZSxcclxuICAgICAgICAgICAgc291cmNlOiBFeHByZXNzaW9uLkV2ZW50U291cmNlLkJpbmRpbmdEYXRhLFxyXG4gICAgICAgICAgICB2YWx1ZTogY2hhbmdlLnZhbHVlLFxyXG4gICAgICAgICAgICBpZDogY2hhbmdlLmlkLFxyXG4gICAgICAgICAgICBpc1RyZWVOb2RlTG9hZFNjZW5lOiBjaGFuZ2UuaXNUcmVlTm9kZUxvYWRTY2VuZVxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiQmluZGluZ0RhdGFDaGFuZ2VMaXN0ZW5lclwiLCBtb2RpZmljYXRpb24pO1xyXG4gICAgICAgICAgdGhpcy5zdWJqZWN0Lm5leHQobW9kaWZpY2F0aW9uKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGJ1aWxkRXZlbnRQYXRoKGNoYW5nZTogQ2hhbmdlKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3QgcGF0aCA9IGNoYW5nZS5wYXRoO1xyXG4gICAgY29uc3QgcGF0aHMgPSBbXTtcclxuICAgIC8vIGlmICghcGF0aCB8fCBwYXRoLmxlbmd0aCA8IDEpIHtcclxuICAgIC8vICAgcmV0dXJuIHBhdGhzO1xyXG4gICAgLy8gfVxyXG4gICAgY29uc3QgcHJpbWFyeVZhbHVlID0gdGhpcy5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZSB8fCBjaGFuZ2UuaWQ7XHJcbiAgICBpZiAocHJpbWFyeVZhbHVlKSB7XHJcbiAgICAgIGlmICghKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLkxvYWQgJiYgY2hhbmdlLnBhdGgubGVuZ3RoID09PSAwKSkge1xyXG4gICAgICAgIHBhdGhzLnB1c2goYCR7dGhpcy5iaW5kaW5nRGF0YS5saXN0LnByaW1hcnlLZXl9OiR7cHJpbWFyeVZhbHVlfWApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBjb25zdCBjdXJyZW50UGF0aCA9IFtdO1xyXG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHBhdGgubGVuZ3RoOyBpbmRleCsrKSB7XHJcbiAgICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHBhdGhbaW5kZXhdO1xyXG4gICAgICBjdXJyZW50UGF0aC5wdXNoKHByb3BlcnR5TmFtZSk7XHJcbiAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLmJpbmRpbmdEYXRhLmdldFZhbHVlKGN1cnJlbnRQYXRoKTtcclxuICAgICAgcGF0aHMucHVzaChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIEJpbmRpbmdMaXN0KSB7XHJcbiAgICAgICAgaWYgKGN1cnJlbnRQYXRoLmxlbmd0aCA8IHBhdGgubGVuZ3RoKSB7XHJcbiAgICAgICAgICBjb25zdCBiaW5kaW5nTGlzdCA9IGl0ZW0gYXMgQmluZGluZ0xpc3Q7XHJcbiAgICAgICAgICBsZXQgY3VycmVudElkID0gYmluZGluZ0xpc3QuY3VycmVudEl0ZW0ucHJpbWFyeUtleVZhbHVlO1xyXG4gICAgICAgICAgaWYgKGluZGV4ID09PSBwYXRoLmxlbmd0aCAtIDIgJiYgY2hhbmdlLmlkKSB7XHJcbiAgICAgICAgICAgIGN1cnJlbnRJZCA9IGNoYW5nZS5pZDtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHBhdGhzLnB1c2goYCR7dGhpcy5iaW5kaW5nRGF0YS5saXN0LnByaW1hcnlLZXl9OiR7Y3VycmVudElkfWApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHBhdGhzO1xyXG4gIH1cclxufVxyXG5leHBvcnQgeyBCaW5kaW5nRGF0YUNoYW5nZUxpc3RlbmVyIH07XHJcbiJdfQ==