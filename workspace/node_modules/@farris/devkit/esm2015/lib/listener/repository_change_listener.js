import { Inject, Injectable, Injector } from '@angular/core';
import { ModifyType } from '../changeset/index';
import { Repository } from '../repository/index';
import { ChangeListener } from './change_listener';
import { Expression } from '../expression/index';
import { BindingData } from '../binding-data/index';
import { NAMESPACE } from '../frame/tokens';
const EventType = Expression.EventType;
class RepositoryChangeListener extends ChangeListener {
    constructor(injector, repository, namespace) {
        super();
        this.injector = injector;
        this.repository = repository;
        this.namespace = namespace;
        this.bindingData = this.injector.get(BindingData, null);
        this.registerEvent();
    }
    registerEvent() {
        if (this.repository && this.repository.changes) {
            this.repository.changes.subscribe((change) => {
                let eventType = this.convertEventType(change);
                if (!eventType) {
                    return;
                }
                const path = this.buildEventPath(change);
                const modification = {
                    ns: this.namespace,
                    type: eventType,
                    path: path,
                    value: change.value,
                    source: Expression.EventSource.Field,
                };
                // console.log("RepositoryChangeListener", modification);
                this.subject.next(modification);
            });
        }
        // repository只监听值变化事件
        if (this.repository && this.repository.entityCollectionChange) {
            this.repository.entityCollectionChange.subscribe((change) => {
                let eventType = this.convertEventType(change);
                if (!eventType) {
                    return;
                }
                const path = this.buildEventPath(change);
                const modification = {
                    ns: this.namespace,
                    type: eventType,
                    path: path,
                    value: change.value,
                    source: Expression.EventSource.Repository,
                };
                this.subject.next(modification);
            });
        }
    }
    /**
     * 构建事件路径参数
     * @param event event
     * @description 构建完之后的路径类似[id,prop] or [id,从表名s,从表当前行id,从表属性] or [id,udt,udt_prop]
     * @returns
     */
    buildEventPath(event) {
        const paths = event.path;
        let result = [];
        if (!paths || paths.length < 1) {
            // 主表新增时path为空
            return result;
        }
        // 过滤掉udt的冒号，关联字段的id
        result = paths.filter((path, index) => {
            if (index % 2 === 0 && path.includes(':')) {
                if (path === ':') {
                    return false;
                }
                const primaryKey = path.split(':')[0];
                if (primaryKey !== this.repository.primaryKey) {
                    return false;
                }
            }
            return true;
        });
        // 移除路径中的id字符串
        // result = paths.map((path: string, index: number) => {
        //   if (path.includes(':') && index % 2 === 0) {
        //     return path.split(':')[1];
        //   }
        //   return path;
        // });
        // 此时result中不应该有冒号
        return result;
    }
    convertEventType(change) {
        let eventType = null;
        if (change.type === ModifyType.Add || change.type === ModifyType.AddData || change.type === ModifyType.Insert) {
            // eventType = Expression.EventType.Append;
            // 不处理新增
        }
        else if (change.type === ModifyType.Remove || change.type === ModifyType.RemoveData) {
            // eventType = Expression.EventType.Remove;
        }
        else if (change.type === ModifyType.Load) {
            // eventType = Expression.EventType.Load;
        }
        else if (change.type === ModifyType.ValueChange) {
            //eventType = Expression.EventType.ValueChanged;
            // 不处理值变化
        }
        else if (change.type === ModifyType.Update) {
            eventType = Expression.EventType.Update;
        }
        return eventType;
    }
}
RepositoryChangeListener.decorators = [
    { type: Injectable }
];
/** @nocollapse */
RepositoryChangeListener.ctorParameters = () => [
    { type: Injector },
    { type: Repository },
    { type: undefined, decorators: [{ type: Inject, args: [NAMESPACE,] }] }
];
export { RepositoryChangeListener };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3NpdG9yeV9jaGFuZ2VfbGlzdGVuZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9saXN0ZW5lci9yZXBvc2l0b3J5X2NoYW5nZV9saXN0ZW5lci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0QsT0FBTyxFQUFnQixVQUFVLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUU5RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDakQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDcEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRzVDLE1BQU0sU0FBUyxHQUFHLFVBQVUsQ0FBQyxTQUFTLENBQUM7QUFFdkMsTUFDTSx3QkFBeUIsU0FBUSxjQUFjO0lBRW5ELFlBQW9CLFFBQWtCLEVBQVUsVUFBOEIsRUFBNkIsU0FBUztRQUNsSCxLQUFLLEVBQUUsQ0FBQztRQURVLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxlQUFVLEdBQVYsVUFBVSxDQUFvQjtRQUE2QixjQUFTLEdBQVQsU0FBUyxDQUFBO1FBRWxILElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQWMsV0FBVyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3JFLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBRU8sYUFBYTtRQUNuQixJQUFJLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUU7WUFDOUMsSUFBSSxD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QkFBZ0IsQ0FBQyxNQUFvQjtRQUMzQyxJQUFJLFNBQVMsR0FBRyxJQUFJLENBQUM7UUFDckIsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsT0FBTyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLE1BQU0sRUFBRTtZQUM3RywyQ0FBMkM7WUFDM0MsUUFBUTtTQUNUO2FBQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsVUFBVSxFQUFFO1lBQ3JGLDJDQUEyQztTQUM1QzthQUFNLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsSUFBSSxFQUFFO1lBQzFDLHlDQUF5QztTQUMxQzthQUFNLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsV0FBVyxFQUFFO1lBQ2pELGdEQUFnRDtZQUNoRCxTQUFTO1NBQ1Y7YUFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLE1BQU0sRUFBRTtZQUM1QyxTQUFTLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUE7U0FDeEM7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDOzs7WUFuR0YsVUFBVTs7OztZQVprQixRQUFRO1lBRzVCLFVBQVU7NENBWWdFLE1BQU0sU0FBQyxTQUFTOztBQW1HbkcsT0FBTyxFQUFFLHdCQUF3QixFQUFFLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE1vZGlmaWNhdGlvbiwgTW9kaWZ5VHlwZSB9IGZyb20gJy4uL2NoYW5nZXNldC9pbmRleCc7XHJcbmltcG9ydCB7IEVudGl0eSB9IGZyb20gJy4uL2VudGl0eSc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tICcuLi9yZXBvc2l0b3J5L2luZGV4JztcclxuaW1wb3J0IHsgQ2hhbmdlTGlzdGVuZXIgfSBmcm9tICcuL2NoYW5nZV9saXN0ZW5lcic7XHJcbmltcG9ydCB7IEV4cHJlc3Npb24gfSBmcm9tICcuLi9leHByZXNzaW9uL2luZGV4JztcclxuaW1wb3J0IHsgQmluZGluZ0RhdGEgfSBmcm9tICcuLi9iaW5kaW5nLWRhdGEvaW5kZXgnO1xyXG5pbXBvcnQgeyBOQU1FU1BBQ0UgfSBmcm9tICcuLi9mcmFtZS90b2tlbnMnO1xyXG5cclxudHlwZSBFdmVudEFyZ3MgPSBFeHByZXNzaW9uLkV2ZW50QXJncztcclxuY29uc3QgRXZlbnRUeXBlID0gRXhwcmVzc2lvbi5FdmVudFR5cGU7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmNsYXNzIFJlcG9zaXRvcnlDaGFuZ2VMaXN0ZW5lciBleHRlbmRzIENoYW5nZUxpc3RlbmVyIHtcclxuICBwcml2YXRlIGJpbmRpbmdEYXRhOiBCaW5kaW5nRGF0YTtcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PEVudGl0eT4sIEBJbmplY3QoTkFNRVNQQUNFKSBwcml2YXRlIG5hbWVzcGFjZSkge1xyXG4gICAgc3VwZXIoKTtcclxuICAgIHRoaXMuYmluZGluZ0RhdGEgPSB0aGlzLmluamVjdG9yLmdldDxCaW5kaW5nRGF0YT4oQmluZGluZ0RhdGEsIG51bGwpO1xyXG4gICAgdGhpcy5yZWdpc3RlckV2ZW50KCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlZ2lzdGVyRXZlbnQoKSB7XHJcbiAgICBpZiAodGhpcy5yZXBvc2l0b3J5ICYmIHRoaXMucmVwb3NpdG9yeS5jaGFuZ2VzKSB7XHJcbiAgICAgIHRoaXMucmVwb3NpdG9yeS5jaGFuZ2VzLnN1YnNjcmliZSgoY2hhbmdlOiBNb2RpZmljYXRpb24pID0+IHtcclxuICAgICAgICBsZXQgZXZlbnRUeXBlID0gdGhpcy5jb252ZXJ0RXZlbnRUeXBlKGNoYW5nZSk7XHJcbiAgICAgICAgaWYgKCFldmVudFR5cGUpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuYnVpbGRFdmVudFBhdGgoY2hhbmdlKTtcclxuICAgICAgICBjb25zdCBtb2RpZmljYXRpb246IEV2ZW50QXJncyA9IHtcclxuICAgICAgICAgIG5zOiB0aGlzLm5hbWVzcGFjZSxcclxuICAgICAgICAgIHR5cGU6IGV2ZW50VHlwZSxcclxuICAgICAgICAgIHBhdGg6IHBhdGgsXHJcbiAgICAgICAgICB2YWx1ZTogY2hhbmdlLnZhbHVlLFxyXG4gICAgICAgICAgc291cmNlOiBFeHByZXNzaW9uLkV2ZW50U291cmNlLkZpZWxkLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJSZXBvc2l0b3J5Q2hhbmdlTGlzdGVuZXJcIiwgbW9kaWZpY2F0aW9uKTtcclxuICAgICAgICB0aGlzLnN1YmplY3QubmV4dChtb2RpZmljYXRpb24pO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIC8vIHJlcG9zaXRvcnnlj6rnm5HlkKzlgLzlj5jljJbkuovku7ZcclxuICAgIGlmICh0aGlzLnJlcG9zaXRvcnkgJiYgdGhpcy5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb25DaGFuZ2UpIHtcclxuICAgICAgdGhpcy5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb25DaGFuZ2Uuc3Vic2NyaWJlKChjaGFuZ2U6IE1vZGlmaWNhdGlvbikgPT4ge1xyXG4gICAgICAgIGxldCBldmVudFR5cGUgPSB0aGlzLmNvbnZlcnRFdmVudFR5cGUoY2hhbmdlKTtcclxuICAgICAgICBpZiAoIWV2ZW50VHlwZSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBwYXRoID0gdGhpcy5idWlsZEV2ZW50UGF0aChjaGFuZ2UpO1xyXG4gICAgICAgIGNvbnN0IG1vZGlmaWNhdGlvbjogRXZlbnRBcmdzID0ge1xyXG4gICAgICAgICAgbnM6IHRoaXMubmFtZXNwYWNlLFxyXG4gICAgICAgICAgdHlwZTogZXZlbnRUeXBlLFxyXG4gICAgICAgICAgcGF0aDogcGF0aCxcclxuICAgICAgICAgIHZhbHVlOiBjaGFuZ2UudmFsdWUsXHJcbiAgICAgICAgICBzb3VyY2U6IEV4cHJlc3Npb24uRXZlbnRTb3VyY2UuUmVwb3NpdG9yeSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuc3ViamVjdC5uZXh0KG1vZGlmaWNhdGlvbik7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDmnoTlu7rkuovku7bot6/lvoTlj4LmlbBcclxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcclxuICAgKiBAZGVzY3JpcHRpb24g5p6E5bu65a6M5LmL5ZCO55qE6Lev5b6E57G75Ly8W2lkLHByb3BdIG9yIFtpZCzku47ooajlkI1zLOS7juihqOW9k+WJjeihjGlkLOS7juihqOWxnuaAp10gb3IgW2lkLHVkdCx1ZHRfcHJvcF1cclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgYnVpbGRFdmVudFBhdGgoZXZlbnQ6IE1vZGlmaWNhdGlvbik6IHN0cmluZ1tdIHtcclxuICAgIGNvbnN0IHBhdGhzID0gZXZlbnQucGF0aDtcclxuICAgIGxldCByZXN1bHQgPSBbXTtcclxuICAgIGlmICghcGF0aHMgfHwgcGF0aHMubGVuZ3RoIDwgMSkge1xyXG4gICAgICAvLyDkuLvooajmlrDlop7ml7ZwYXRo5Li656m6XHJcbiAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcbiAgICAvLyDov4fmu6Tmjol1ZHTnmoTlhpLlj7fvvIzlhbPogZTlrZfmrrXnmoRpZFxyXG4gICAgcmVzdWx0ID0gcGF0aHMuZmlsdGVyKChwYXRoOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgaWYgKGluZGV4ICUgMiA9PT0gMCAmJiBwYXRoLmluY2x1ZGVzKCc6JykpIHtcclxuICAgICAgICBpZiAocGF0aCA9PT0gJzonKSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHByaW1hcnlLZXkgPSBwYXRoLnNwbGl0KCc6JylbMF07XHJcbiAgICAgICAgaWYgKHByaW1hcnlLZXkgIT09IHRoaXMucmVwb3NpdG9yeS5wcmltYXJ5S2V5KSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfSk7XHJcbiAgICAvLyDnp7vpmaTot6/lvoTkuK3nmoRpZOWtl+espuS4slxyXG4gICAgLy8gcmVzdWx0ID0gcGF0aHMubWFwKChwYXRoOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpID0+IHtcclxuICAgIC8vICAgaWYgKHBhdGguaW5jbHVkZXMoJzonKSAmJiBpbmRleCAlIDIgPT09IDApIHtcclxuICAgIC8vICAgICByZXR1cm4gcGF0aC5zcGxpdCgnOicpWzFdO1xyXG4gICAgLy8gICB9XHJcbiAgICAvLyAgIHJldHVybiBwYXRoO1xyXG4gICAgLy8gfSk7XHJcbiAgICAvLyDmraTml7ZyZXN1bHTkuK3kuI3lupTor6XmnInlhpLlj7dcclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG4gIHByaXZhdGUgY29udmVydEV2ZW50VHlwZShjaGFuZ2U6IE1vZGlmaWNhdGlvbik6IEV4cHJlc3Npb24uRXZlbnRUeXBlIHtcclxuICAgIGxldCBldmVudFR5cGUgPSBudWxsO1xyXG4gICAgaWYgKGNoYW5nZS50eXBlID09PSBNb2RpZnlUeXBlLkFkZCB8fCBjaGFuZ2UudHlwZSA9PT0gTW9kaWZ5VHlwZS5BZGREYXRhIHx8IGNoYW5nZS50eXBlID09PSBNb2RpZnlUeXBlLkluc2VydCkge1xyXG4gICAgICAvLyBldmVudFR5cGUgPSBFeHByZXNzaW9uLkV2ZW50VHlwZS5BcHBlbmQ7XHJcbiAgICAgIC8vIOS4jeWkhOeQhuaWsOWinlxyXG4gICAgfSBlbHNlIGlmIChjaGFuZ2UudHlwZSA9PT0gTW9kaWZ5VHlwZS5SZW1vdmUgfHwgY2hhbmdlLnR5cGUgPT09IE1vZGlmeVR5cGUuUmVtb3ZlRGF0YSkge1xyXG4gICAgICAvLyBldmVudFR5cGUgPSBFeHByZXNzaW9uLkV2ZW50VHlwZS5SZW1vdmU7XHJcbiAgICB9IGVsc2UgaWYgKGNoYW5nZS50eXBlID09PSBNb2RpZnlUeXBlLkxvYWQpIHtcclxuICAgICAgLy8gZXZlbnRUeXBlID0gRXhwcmVzc2lvbi5FdmVudFR5cGUuTG9hZDtcclxuICAgIH0gZWxzZSBpZiAoY2hhbmdlLnR5cGUgPT09IE1vZGlmeVR5cGUuVmFsdWVDaGFuZ2UpIHtcclxuICAgICAgLy9ldmVudFR5cGUgPSBFeHByZXNzaW9uLkV2ZW50VHlwZS5WYWx1ZUNoYW5nZWQ7XHJcbiAgICAgIC8vIOS4jeWkhOeQhuWAvOWPmOWMllxyXG4gICAgfSBlbHNlIGlmIChjaGFuZ2UudHlwZSA9PT0gTW9kaWZ5VHlwZS5VcGRhdGUpIHtcclxuICAgICAgZXZlbnRUeXBlID0gRXhwcmVzc2lvbi5FdmVudFR5cGUuVXBkYXRlXHJcbiAgICB9XHJcbiAgICByZXR1cm4gZXZlbnRUeXBlO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgUmVwb3NpdG9yeUNoYW5nZUxpc3RlbmVyIH0iXX0=