import { Injectable } from "@angular/core";
import { EffectorManager } from "../effector/effector_manager";
import { Expression } from "../expression/index";
import { STATE_TEMPLATE } from "../resolver/index";
import { EventHandler } from "./event_handler";
export class StateValueChangedEventHandler extends EventHandler {
    /**
     * 获取相关表达式
     * @param event event
     */
    filter(event) {
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            return this.expressionObjects.filter((expressionObject) => {
                const deps = expressionObject.deps;
                if (!deps || deps.length < 1 || event.ns !== expressionObject.ns) {
                    return false;
                }
                const changePaths = this.cleanEventPath(event.path);
                changePaths.splice(0, 0, STATE_TEMPLATE);
                const eventPath = changePaths.join('/');
                if (deps.includes(eventPath)) {
                    return true;
                }
                else {
                    return false;
                }
            });
        }
        return null;
    }
    /**
     * 发布事件
     * @param event event
     */
    dispatch(event) {
        const expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach((expressionObject) => {
                // const entityContext = this.buildEntityContext(event, expressionObject);
                const context = this.buildContext(expressionObject, event);
                const result = this.perform(expressionObject, context);
                if (result === undefined && !this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = this.convertBooleanTypeExpressionResult(expressionObject, result);
                ;
                if (expressionObject.id) {
                    this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                this.effect(event, expressionObject);
            });
        }
    }
    /**
     * 副作用
     * @param event event
     * @param expressionObject expressionObject
     */
    effect(event, expressionObject) {
        const effector = this.effectorFactory.getEffector(expressionObject);
        const bindingType = expressionObject.bindingType;
        if (!effector) {
            return;
        }
        if (bindingType === Expression.ExpressionBindingType.State) {
            // 如果表达式作用于uistate
            effector.effect(expressionObject.path, expressionObject.result, { message: expressionObject.message });
        }
        else if (bindingType === Expression.ExpressionBindingType.Field) {
            // 表达式作用于实体属性
            const expressionPathInfo = this.getPathInfo(expressionObject.path);
            const bindingPaths = expressionPathInfo.paths;
            const entities = this.repository.entityCollection.getAllEntities();
            if (!entities || entities.length < 1 || expressionObject.type === Expression.ExpressionType.Visible) {
                effector.effect(expressionObject.path, expressionObject.result, { message: expressionObject.message });
            }
            else {
                this.effectRows(entities, bindingPaths, expressionPathInfo.propertyNames, (currentRows, paths) => {
                    this.output(event, expressionObject, currentRows, effector, [paths]);
                });
            }
        }
    }
    output(event, expressionObject, currentRows, effector, paths) {
        const context = this.buildContext(expressionObject, event, null, currentRows);
        const value = this.perform(expressionObject, context);
        if (value === undefined) {
            return;
        }
        expressionObject.result = value;
        if (expressionObject.id) {
            this.expressionResult.set(expressionObject.id, expressionObject.result);
        }
        EffectorManager.effect(effector, expressionObject, paths);
    }
    effectRows(entities, bindingPaths, propertyNames, callback, currentRows = [], prevPaths = [], paths = []) {
        if (!bindingPaths || bindingPaths.length < 1) {
            entities.forEach((entity) => {
                if (!entity || !entity.primaryValue) {
                    return;
                }
                const currentPaths = paths.concat([entity.primaryValue]).concat(propertyNames);
                const currentCurrentRows = currentRows.concat([{ bindingPath: prevPaths.join('/') || '/', primaryValue: entity.primaryValue }]);
                callback(currentCurrentRows, currentPaths);
            });
            currentRows.length = 0;
            paths.length = 0;
        }
        else {
            let flag = false;
            let nextPrevPaths = prevPaths;
            entities.forEach((entity) => {
                const prop = bindingPaths[0];
                const entityList = entity[prop];
                if (!entityList || entityList.count() < 1) {
                    // 下级表没有数据
                    return;
                }
                currentRows.push({ bindingPath: prevPaths.join('/') || '/', primaryValue: entity.primaryValue });
                paths.push(entity.primaryValue);
                paths.push(prop);
                if (flag === false) {
                    flag = true;
                    nextPrevPaths.push(prop);
                }
                const nextBindingPaths = bindingPaths.slice(1);
                this.effectRows(entityList.items, nextBindingPaths, propertyNames, callback, currentRows, nextPrevPaths, paths);
            });
        }
    }
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    getCurrentRowByEvent(paths, event) {
        return this.getCurrentRowByPaths(paths);
    }
}
StateValueChangedEventHandler.decorators = [
    { type: Injectable }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVfdmFsdWVfY2hhbmdlZF9ldmVudF9oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZXZlbnQtaGFuZGxlci9zdGF0ZV92YWx1ZV9jaGFuZ2VkX2V2ZW50X2hhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFFL0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFHL0MsTUFBTSxPQUFPLDZCQUE4QixTQUFRLFlBQVk7SUFFN0Q7OztPQUdHO0lBQ0ksTUFBTSxDQUFDLEtBQTJCO1FBQ3ZDLElBQUksSUFBSSxDQUFDLGlCQUFpQixJQUFJLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQy9ELE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxDQUFDLGdCQUE2QyxFQUFFLEVBQUU7Z0JBQ3JGLE1BQU0sSUFBSSxHQUFHLGdCQUFnQixDQUFDLElBQUksQ0FBQztnQkFDbkMsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxLQUFLLENBQUMsRUFBRSxLQUFLLGdCQUFnQixDQUFDLEVBQUUsRUFBRTtvQkFDaEUsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7Z0JBQ0QsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3BELFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxjQUFjLENBQUMsQ0FBQztnQkFDekMsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDeEMsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxFQUFFO29CQUM1QixPQUFPLElBQUksQ0FBQztpQkFDYjtxQkFBTTtvQkFDTCxPQUFPLEtBQUssQ0FBQztpQkFDZDtZQUNILENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFDRDs7O09BR0c7SUFDSSxRQUFRLENBQUMsS0FBMkI7UUFDekMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN2QyxJQUFJLFdBQVcsSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN6QyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsZ0JBQTZDLEVBQUUsRUFBRTtnQkFDcEUsMEVBQTBFO2dCQUMxRSxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUMzRCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFLE9BQU8sQ0FBQyxDQUFDO2dCQUN2RCxJQUFJLE1BQU0sS0FBSyxTQUFTLElBQUksQ0FBQyxJQUFJLENBQUMsOEJBQThCLENBQUMsZ0JBQWdCLENBQUMsRUFBRTtvQkFDbEYsT0FBTztpQkFDUjtnQkFDRCxnQkFBZ0IsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGtDQUFrQyxDQUFDLGdCQUFnQixFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUFBLENBQUM7Z0JBQzdGLElBQUksZ0JBQWdCLENBQUMsRUFBRSxFQUFFO29CQUN2QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsRUFBRSxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztpQkFDekU7Z0JBQ0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztZQUN2QyxDQUFDLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQztJQUNEOzs7O09BSUc7SUFDSSxNQUFNLENBQUMsS0FBMkIsRUFBRSxnQkFBNkM7UUFDdEYsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUNwRSxNQUFNLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUM7UUFDakQsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNiLE9BQU87U0FDUjtRQUNELElBQUksV0FBVyxLQUFLLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLEVBQUU7WUFDMUQsa0JBQWtCO1lBQ2xCLFFBQVEsQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxFQUFFLE9BQU8sRUFBRSxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1NBQ3hHO2FBQU0sSUFBSSxXQUFXLEtBQUssVUFBVSxDQUFDLHFCQUFxQixDQUFDLEtBQUssRUFBRTtZQUNqRSxhQUFhO1lBQ2IsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ25FLE1BQU0sWUFBWSxHQUFHLGtCQUFrQixDQUFDLEtBQUssQ0FBQztZQUM5QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ25FLElBQUksQ0FBQyxRQUFRLElBQUksUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksZ0JBQWdCLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFO2dCQUNuRyxRQUFRLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsRUFBRSxPQUFPLEVBQUUsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQzthQUN4RztpQkFBTTtnQkFDTCxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxZQUFZLEVBQUUsa0JBQWtCLENBQUMsYUFBYSxFQUFFLENBQUMsV0FBcUMsRUFBRSxLQUFlLEVBQUUsRUFBRTtvQkFDbkksSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZFLENBQUMsQ0FBQyxDQUFDO2FBQ0o7U0FDRjtJQUNILENBQUM7SUFDTSxNQUFNLENBQUMsS0FBMkIsRUFBRSxnQkFBNkMsRUFBRSxXQUFxQyxFQUFFLFFBQTZCLEVBQUUsS0FBYztRQUM1SyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDOUUsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN0RCxJQUFJLEtBQUssS0FBSyxTQUFTLEVBQUU7WUFDdkIsT0FBTztTQUNSO1FBQ0QsZ0JBQWdCLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNoQyxJQUFJLGdCQUFnQixDQUFDLEVBQUUsRUFBRTtZQUN2QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsRUFBRSxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUN6RTtRQUNELGVBQWUsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLGdCQUFnQixFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFDTyxVQUFVLENBQUMsUUFBa0IsRUFBRSxZQUFzQixFQUFFLGFBQXVCLEVBQUUsUUFBMEUsRUFBRSxjQUF3QyxFQUFFLEVBQUUsWUFBc0IsRUFBRSxFQUFFLFFBQWtCLEVBQUU7UUFDNVAsSUFBSSxDQUFDLFlBQVksSUFBSSxZQUFZLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUM1QyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBYyxFQUFFLEVBQUU7Z0JBQ2xDLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFO29CQUNuQyxPQUFPO2lCQUNSO2dCQUNELE1BQU0sWUFBWSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBQy9FLE1BQU0sa0JBQWtCLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsV0FBVyxFQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxFQUFFLFlBQVksRUFBRSxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUNoSSxRQUFRLENBQUMsa0JBQWtCLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDN0MsQ0FBQyxDQUFDLENBQUM7WUFDSCxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztZQUN2QixLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztTQUNsQjthQUFNO1lBQ0wsSUFBSSxJQUFJLEdBQUcsS0FBSyxDQUFDO1lBQ2pCLElBQUksYUFBYSxHQUFHLFNBQVMsQ0FBQztZQUM5QixRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBYyxFQUFFLEVBQUU7Z0JBQ2xDLE1BQU0sSUFBSSxHQUFHLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDN0IsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBdUIsQ0FBQztnQkFDdEQsSUFBSSxDQUFDLFVBQVUsSUFBSSxVQUFVLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxFQUFFO29CQUN6QyxVQUFVO29CQUNWLE9BQU87aUJBQ1I7Z0JBQ0QsV0FBVyxDQUFDLElBQUksQ0FBQyxFQUFFLFdBQVcsRUFBRSxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsRUFBRSxZQUFZLEVBQUUsTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7Z0JBQ2pHLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUNoQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNqQixJQUFJLElBQUksS0FBSyxLQUFLLEVBQUU7b0JBQ2xCLElBQUksR0FBRyxJQUFJLENBQUM7b0JBQ1osYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDMUI7Z0JBQ0QsTUFBTSxnQkFBZ0IsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUMvQyxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ2xILENBQUMsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDO0lBQ0Q7Ozs7O09BS0c7SUFDSSxvQkFBb0IsQ0FBQyxLQUFlLEVBQUUsS0FBMkI7UUFDdEUsT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDMUMsQ0FBQzs7O1lBbElGLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgRWZmZWN0b3JNYW5hZ2VyIH0gZnJvbSBcIi4uL2VmZmVjdG9yL2VmZmVjdG9yX21hbmFnZXJcIjtcclxuaW1wb3J0IHsgRW50aXR5LCBFbnRpdHlMaXN0IH0gZnJvbSBcIi4uL2VudGl0eS9pbmRleFwiO1xyXG5pbXBvcnQgeyBFeHByZXNzaW9uIH0gZnJvbSBcIi4uL2V4cHJlc3Npb24vaW5kZXhcIjtcclxuaW1wb3J0IHsgU1RBVEVfVEVNUExBVEUgfSBmcm9tIFwiLi4vcmVzb2x2ZXIvaW5kZXhcIjtcclxuaW1wb3J0IHsgRXZlbnRIYW5kbGVyIH0gZnJvbSBcIi4vZXZlbnRfaGFuZGxlclwiO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgU3RhdGVWYWx1ZUNoYW5nZWRFdmVudEhhbmRsZXIgZXh0ZW5kcyBFdmVudEhhbmRsZXIge1xyXG5cclxuICAvKipcclxuICAgKiDojrflj5bnm7jlhbPooajovr7lvI9cclxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcclxuICAgKi9cclxuICBwdWJsaWMgZmlsdGVyKGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncykge1xyXG4gICAgaWYgKHRoaXMuZXhwcmVzc2lvbk9iamVjdHMgJiYgdGhpcy5leHByZXNzaW9uT2JqZWN0cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmV4cHJlc3Npb25PYmplY3RzLmZpbHRlcigoZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KSA9PiB7XHJcbiAgICAgICAgY29uc3QgZGVwcyA9IGV4cHJlc3Npb25PYmplY3QuZGVwcztcclxuICAgICAgICBpZiAoIWRlcHMgfHwgZGVwcy5sZW5ndGggPCAxIHx8IGV2ZW50Lm5zICE9PSBleHByZXNzaW9uT2JqZWN0Lm5zKSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGNoYW5nZVBhdGhzID0gdGhpcy5jbGVhbkV2ZW50UGF0aChldmVudC5wYXRoKTtcclxuICAgICAgICBjaGFuZ2VQYXRocy5zcGxpY2UoMCwgMCwgU1RBVEVfVEVNUExBVEUpO1xyXG4gICAgICAgIGNvbnN0IGV2ZW50UGF0aCA9IGNoYW5nZVBhdGhzLmpvaW4oJy8nKTtcclxuICAgICAgICBpZiAoZGVwcy5pbmNsdWRlcyhldmVudFBhdGgpKSB7XHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Y+R5biD5LqL5Lu2XHJcbiAgICogQHBhcmFtIGV2ZW50IGV2ZW50XHJcbiAgICovXHJcbiAgcHVibGljIGRpc3BhdGNoKGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncykge1xyXG4gICAgY29uc3QgZXhwcmVzc2lvbnMgPSB0aGlzLmZpbHRlcihldmVudCk7XHJcbiAgICBpZiAoZXhwcmVzc2lvbnMgJiYgZXhwcmVzc2lvbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICBleHByZXNzaW9ucy5mb3JFYWNoKChleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpID0+IHtcclxuICAgICAgICAvLyBjb25zdCBlbnRpdHlDb250ZXh0ID0gdGhpcy5idWlsZEVudGl0eUNvbnRleHQoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QpO1xyXG4gICAgICAgIGNvbnN0IGNvbnRleHQgPSB0aGlzLmJ1aWxkQ29udGV4dChleHByZXNzaW9uT2JqZWN0LCBldmVudCk7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5wZXJmb3JtKGV4cHJlc3Npb25PYmplY3QsIGNvbnRleHQpO1xyXG4gICAgICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCAmJiAhdGhpcy5pc1ZhbGlkYXRlT3JSZXF1aXJlZEV4cHJlc3Npb24oZXhwcmVzc2lvbk9iamVjdCkpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgZXhwcmVzc2lvbk9iamVjdC5yZXN1bHQgPSB0aGlzLmNvbnZlcnRCb29sZWFuVHlwZUV4cHJlc3Npb25SZXN1bHQoZXhwcmVzc2lvbk9iamVjdCwgcmVzdWx0KTs7XHJcbiAgICAgICAgaWYgKGV4cHJlc3Npb25PYmplY3QuaWQpIHtcclxuICAgICAgICAgIHRoaXMuZXhwcmVzc2lvblJlc3VsdC5zZXQoZXhwcmVzc2lvbk9iamVjdC5pZCwgZXhwcmVzc2lvbk9iamVjdC5yZXN1bHQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmVmZmVjdChldmVudCwgZXhwcmVzc2lvbk9iamVjdCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDlia/kvZznlKhcclxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcclxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbk9iamVjdCBleHByZXNzaW9uT2JqZWN0XHJcbiAgICovXHJcbiAgcHVibGljIGVmZmVjdChldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MsIGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCk6IHZvaWQge1xyXG4gICAgY29uc3QgZWZmZWN0b3IgPSB0aGlzLmVmZmVjdG9yRmFjdG9yeS5nZXRFZmZlY3RvcihleHByZXNzaW9uT2JqZWN0KTtcclxuICAgIGNvbnN0IGJpbmRpbmdUeXBlID0gZXhwcmVzc2lvbk9iamVjdC5iaW5kaW5nVHlwZTtcclxuICAgIGlmICghZWZmZWN0b3IpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKGJpbmRpbmdUeXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25CaW5kaW5nVHlwZS5TdGF0ZSkge1xyXG4gICAgICAvLyDlpoLmnpzooajovr7lvI/kvZznlKjkuo51aXN0YXRlXHJcbiAgICAgIGVmZmVjdG9yLmVmZmVjdChleHByZXNzaW9uT2JqZWN0LnBhdGgsIGV4cHJlc3Npb25PYmplY3QucmVzdWx0LCB7IG1lc3NhZ2U6IGV4cHJlc3Npb25PYmplY3QubWVzc2FnZSB9KTtcclxuICAgIH0gZWxzZSBpZiAoYmluZGluZ1R5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvbkJpbmRpbmdUeXBlLkZpZWxkKSB7XHJcbiAgICAgIC8vIOihqOi+vuW8j+S9nOeUqOS6juWunuS9k+WxnuaAp1xyXG4gICAgICBjb25zdCBleHByZXNzaW9uUGF0aEluZm8gPSB0aGlzLmdldFBhdGhJbmZvKGV4cHJlc3Npb25PYmplY3QucGF0aCk7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGV4cHJlc3Npb25QYXRoSW5mby5wYXRocztcclxuICAgICAgY29uc3QgZW50aXRpZXMgPSB0aGlzLnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRBbGxFbnRpdGllcygpO1xyXG4gICAgICBpZiAoIWVudGl0aWVzIHx8IGVudGl0aWVzLmxlbmd0aCA8IDEgfHwgZXhwcmVzc2lvbk9iamVjdC50eXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLlZpc2libGUpIHtcclxuICAgICAgICBlZmZlY3Rvci5lZmZlY3QoZXhwcmVzc2lvbk9iamVjdC5wYXRoLCBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCwgeyBtZXNzYWdlOiBleHByZXNzaW9uT2JqZWN0Lm1lc3NhZ2UgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5lZmZlY3RSb3dzKGVudGl0aWVzLCBiaW5kaW5nUGF0aHMsIGV4cHJlc3Npb25QYXRoSW5mby5wcm9wZXJ0eU5hbWVzLCAoY3VycmVudFJvd3M6IEV4cHJlc3Npb24uSUN1cnJlbnRSb3dbXSwgcGF0aHM6IHN0cmluZ1tdKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLm91dHB1dChldmVudCwgZXhwcmVzc2lvbk9iamVjdCwgY3VycmVudFJvd3MsIGVmZmVjdG9yLCBbcGF0aHNdKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICBwdWJsaWMgb3V0cHV0KGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncywgZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0LCBjdXJyZW50Um93czogRXhwcmVzc2lvbi5JQ3VycmVudFJvd1tdLCBlZmZlY3RvcjogRXhwcmVzc2lvbi5FZmZlY3RvciwgcGF0aHM6IGFueVtdW10pIHtcclxuICAgIGNvbnN0IGNvbnRleHQgPSB0aGlzLmJ1aWxkQ29udGV4dChleHByZXNzaW9uT2JqZWN0LCBldmVudCwgbnVsbCwgY3VycmVudFJvd3MpO1xyXG4gICAgY29uc3QgdmFsdWUgPSB0aGlzLnBlcmZvcm0oZXhwcmVzc2lvbk9iamVjdCwgY29udGV4dCk7XHJcbiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCA9IHZhbHVlO1xyXG4gICAgaWYgKGV4cHJlc3Npb25PYmplY3QuaWQpIHtcclxuICAgICAgdGhpcy5leHByZXNzaW9uUmVzdWx0LnNldChleHByZXNzaW9uT2JqZWN0LmlkLCBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCk7XHJcbiAgICB9XHJcbiAgICBFZmZlY3Rvck1hbmFnZXIuZWZmZWN0KGVmZmVjdG9yLCBleHByZXNzaW9uT2JqZWN0LCBwYXRocyk7XHJcbiAgfVxyXG4gIHByaXZhdGUgZWZmZWN0Um93cyhlbnRpdGllczogRW50aXR5W10sIGJpbmRpbmdQYXRoczogc3RyaW5nW10sIHByb3BlcnR5TmFtZXM6IHN0cmluZ1tdLCBjYWxsYmFjazogKGN1cnJlbnRSb3dzOiBFeHByZXNzaW9uLklDdXJyZW50Um93W10sIHBhdGhzOiBzdHJpbmdbXSkgPT4gdm9pZCwgY3VycmVudFJvd3M6IEV4cHJlc3Npb24uSUN1cnJlbnRSb3dbXSA9IFtdLCBwcmV2UGF0aHM6IHN0cmluZ1tdID0gW10sIHBhdGhzOiBzdHJpbmdbXSA9IFtdKSB7XHJcbiAgICBpZiAoIWJpbmRpbmdQYXRocyB8fCBiaW5kaW5nUGF0aHMubGVuZ3RoIDwgMSkge1xyXG4gICAgICBlbnRpdGllcy5mb3JFYWNoKChlbnRpdHk6IEVudGl0eSkgPT4ge1xyXG4gICAgICAgIGlmICghZW50aXR5IHx8ICFlbnRpdHkucHJpbWFyeVZhbHVlKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRQYXRocyA9IHBhdGhzLmNvbmNhdChbZW50aXR5LnByaW1hcnlWYWx1ZV0pLmNvbmNhdChwcm9wZXJ0eU5hbWVzKTtcclxuICAgICAgICBjb25zdCBjdXJyZW50Q3VycmVudFJvd3MgPSBjdXJyZW50Um93cy5jb25jYXQoW3sgYmluZGluZ1BhdGg6IHByZXZQYXRocy5qb2luKCcvJykgfHwgJy8nLCBwcmltYXJ5VmFsdWU6IGVudGl0eS5wcmltYXJ5VmFsdWUgfV0pO1xyXG4gICAgICAgIGNhbGxiYWNrKGN1cnJlbnRDdXJyZW50Um93cywgY3VycmVudFBhdGhzKTtcclxuICAgICAgfSk7XHJcbiAgICAgIGN1cnJlbnRSb3dzLmxlbmd0aCA9IDA7XHJcbiAgICAgIHBhdGhzLmxlbmd0aCA9IDA7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBsZXQgZmxhZyA9IGZhbHNlO1xyXG4gICAgICBsZXQgbmV4dFByZXZQYXRocyA9IHByZXZQYXRocztcclxuICAgICAgZW50aXRpZXMuZm9yRWFjaCgoZW50aXR5OiBFbnRpdHkpID0+IHtcclxuICAgICAgICBjb25zdCBwcm9wID0gYmluZGluZ1BhdGhzWzBdO1xyXG4gICAgICAgIGNvbnN0IGVudGl0eUxpc3QgPSBlbnRpdHlbcHJvcF0gYXMgRW50aXR5TGlzdDxFbnRpdHk+O1xyXG4gICAgICAgIGlmICghZW50aXR5TGlzdCB8fCBlbnRpdHlMaXN0LmNvdW50KCkgPCAxKSB7XHJcbiAgICAgICAgICAvLyDkuIvnuqfooajmsqHmnInmlbDmja5cclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY3VycmVudFJvd3MucHVzaCh7IGJpbmRpbmdQYXRoOiBwcmV2UGF0aHMuam9pbignLycpIHx8ICcvJywgcHJpbWFyeVZhbHVlOiBlbnRpdHkucHJpbWFyeVZhbHVlIH0pO1xyXG4gICAgICAgIHBhdGhzLnB1c2goZW50aXR5LnByaW1hcnlWYWx1ZSk7XHJcbiAgICAgICAgcGF0aHMucHVzaChwcm9wKTtcclxuICAgICAgICBpZiAoZmxhZyA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgIGZsYWcgPSB0cnVlO1xyXG4gICAgICAgICAgbmV4dFByZXZQYXRocy5wdXNoKHByb3ApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBuZXh0QmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGhzLnNsaWNlKDEpO1xyXG4gICAgICAgIHRoaXMuZWZmZWN0Um93cyhlbnRpdHlMaXN0Lml0ZW1zLCBuZXh0QmluZGluZ1BhdGhzLCBwcm9wZXJ0eU5hbWVzLCBjYWxsYmFjaywgY3VycmVudFJvd3MsIG5leHRQcmV2UGF0aHMsIHBhdGhzKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWtkOihqOS6i+S7tuihjFxyXG4gICAqIEBwYXJhbSBwYXRoc1xyXG4gICAqIEBwYXJhbSBldmVudFxyXG4gICAqIEByZXR1cm5zXHJcbiAgICovXHJcbiAgcHVibGljIGdldEN1cnJlbnRSb3dCeUV2ZW50KHBhdGhzOiBzdHJpbmdbXSwgZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKTogeyBbcHJvcDogc3RyaW5nXTogYW55OyB9IHtcclxuICAgIHJldHVybiB0aGlzLmdldEN1cnJlbnRSb3dCeVBhdGhzKHBhdGhzKTtcclxuICB9XHJcbn1cclxuIl19