import { Subject, of } from 'rxjs';
import { Map } from 'immutable';
import { ChangeType, ViewChangeType } from './changes';
import { BindingPropertyType } from './binding_property';
import { BindingList } from './binding_list';
/**
 * 绑定对象基类
 */
class BaseBindingObject {
    // private __differ__ = this.differ();
    constructor() {
        this.__type__ = 'BindingObject';
        /**
         * 绑定到实体
         */
        this.fromEntity = undefined;
        /**
         * 标识是否提交过
         */
        this.isShowValidationMsg = false;
        /**
         * 销毁流
         */
        this.unsubscribe = new Subject();
        /**
         * 以{ [propertyName]: FormControl }的形式存放每条数据的control
         */
        this.controlMap = {};
        this.innerValues = Map();
        this.changes = new Subject();
        this.viewChanges = new Subject();
    }
    /**
     * 主键值
     */
    get primaryKeyValue() {
        return this.primaryKey ? this.getValue(this.primaryKey) : '';
    }
    /**
     * 数据行的主键值
     */
    get rowPrimaryKeyValue() {
        const row = this.getRow(this);
        return row && row.primaryKeyValue || null;
    }
    /**
     * 设置是否提交过
     */
    setShowValidationMsg(flag) {
        this.isShowValidationMsg = flag;
    }
    // public abstract load(data: any);
    /**
     * 根据属性名获取属性值
     * @param   propertyName 属性名
     * @returns 属性值
     */
    getValue(propertyName) {
        return this.innerValues.get(propertyName);
    }
    /**
     * 设置属性值
     * @param propertyName        属性名
     * @param propertyValue       属性值
     * @param emitEventToView     是否通知View层去更新界面，默认为false
     * @param emitEventToEntity   是否通知Entity层去更新值，默认为false
     * @param errors              错误消息
     * @param invokeOnValueChange 值变化事件执行句柄
     */
    setValue(propertyName, propertyValue, emitEventToView = false, emitEventToEntity = false, errors, invokeOnValueChange, context) {
        // 屏蔽掉无效的赋值，防止后续赋值对比时跳过，导致实体无法赋值
        // if (this.primaryKey && !this.primaryKeyValue && this.primaryKey !== propertyName) {
        //   return;
        // }
        const oldPropertyValue = this.getValue(propertyName);
        // 由于特定原因（@邵珠强），无法屏蔽oldPropertyValue === propertyValue
        // if (oldPropertyValue === propertyValue) {
        //   return;
        // }
        if (!invokeOnValueChange || oldPropertyValue === propertyValue) {
            // 设定缺省
            invokeOnValueChange = function (preValue, value, entityChanged, primaryValue) {
                return of(true);
            };
        }
        if (emitEventToEntity === true) {
            // BUG 322301，删除@2019.08.10; 如果无对应实体，则中止值传递; 这种情况发生在带从表的单据新增，从表响应Load变化的情况；
            // if(!this.innerValues.has(propertyName)) {
            //   return;
            // }
            // 执行实体值变化前事件
            invokeOnValueChange(oldPropertyValue, propertyValue, false, this.rowPrimaryKeyValue).subscribe((result) => {
                if (result) {
                    //this.__differ__.onValueChange();
                    // 如果成功，执行变化，并通知实体变化
                    this.innerValues = this.innerValues.set(propertyName, propertyValue);
                    // this.data[propertyName] = propertyValue;
                    const viewChange = this.buildViewChangesContext(propertyName, propertyValue, oldPropertyValue, errors, context);
                    this.viewChanges.next(viewChange);
                    // 如果需要通知视图，通知视图相应修改
                    if (emitEventToView === true) {
                        const change = this.buildChangesContext(propertyName, propertyValue, context, errors);
                        this.changes.next(change);
                    }
                    // 执行实体值变化后事件
                    invokeOnValueChange(oldPropertyValue, propertyValue, true, this.rowPrimaryKeyValue).subscribe();
                }
                else {
                    // 如果失败，不再通知实体变化
                    // 并执行界面回滚操作
                    const change = this.buildChangesContext(propertyName, oldPropertyValue, context, errors);
                    this.changes.next(change);
                }
            });
        }
        else {
            //this.__differ__.onValueChange();
            // `emitEventToEntity === false`, 则认定实体值已经发生变化，通知视图变化，并触发实体值变化后事件
            this.innerValues = this.innerValues.set(propertyName, propertyValue);
            // this.data[propertyName] = propertyValue;
            if (emitEventToView === true) {
                const change = this.buildChangesContext(propertyName, propertyValue, context, errors);
                this.changes.next(change);
            }
            // 执行实体值变化后事件
            invokeOnValueChange(oldPropertyValue, propertyValue, true, this.rowPrimaryKeyValue).subscribe();
        }
    }
    /**
     * 将BindingObject实例转换成JSON对象
     */
    toJSON(options) {
        //if (!this.__differ__.isChange()) {
        //  return this.__differ__.value();
        //}
        const langCode = this.getCurrentLanguage(); //window.localStorage.getItem('languageCode') || 'zh-CHS';
        const result = {};
        this.properties.forEach((property) => {
            const propName = property.name;
            if (property.type === BindingPropertyType.List) {
                const list = this[propName];
                result[propName] = list.toJSON(options);
            }
            else if (property.type === BindingPropertyType.Object) {
                const object = this[propName];
                result[propName] = object.toJSON(options);
            }
            else if (property.type === BindingPropertyType.Dynamic) {
                const object = this[propName];
                result[propName] = object.toJSON(options);
            }
            else {
                // 1、对于多语录入字段；
                // 2、传入ignoreMultiLangInput标志，则取当前语言的值给控件。
                if (property.enableMultiLangInput === true) {
                    // 忽略多语字段，只返回当前语言
                    if (options && options.ignoreMultiLangInput === true) {
                        const multiLangValueObj = this.getValue(propName);
                        if (multiLangValueObj) {
                            result[propName] = multiLangValueObj[langCode];
                        }
                        else {
                            result[propName] = multiLangValueObj;
                        }
                    }
                    else if (options && options.useFullMultiLangProperty) {
                        // 给审批提供的扩展 @2021-10-13
                        const multiLangValueObj = this.getValue(propName);
                        if (multiLangValueObj) {
                            result[`${propName}_MULTILANGUAGE`] = multiLangValueObj;
                            // 除返回多语字段外，将当前语言也返回
                            result[propName] = multiLangValueObj[langCode];
                        }
                    }
                    else {
                        const multiLangValueObj = this.getValue(propName);
                        if (!multiLangValueObj) {
                            result[propName] = { [langCode]: multiLangValueObj };
                        }
                        else {
                            result[propName] = multiLangValueObj;
                        }
                    }
                }
                else {
                    result[propName] = this.getValue(propName);
                }
            }
        });
        // this.__differ__.update(result);
        return result;
    }
    /**
     * 获取当前语言
     * @returns
     */
    getCurrentLanguage() {
        this.currentLanguage = this.currentLanguage || window.localStorage.getItem('languageCode') || 'zh-CHS';
        return this.currentLanguage;
    }
    /**
     * 构造bindignData变更上下文
     * @param propertyName
     * @param propertyValue
     * @param context
     * @param errors
     * @param type
     * @returns
     */
    buildChangesContext(propertyName, propertyValue, context, errors, type = ChangeType.ValueChanged) {
        const object = this.getRow(this);
        const id = object ? object.primaryKeyValue : null;
        return {
            type: type,
            path: [propertyName],
            value: propertyValue,
            id: id,
            errors: errors,
            context
        };
    }
    /**
     * 构造viewChanges上下文
     * @param propertyName
     * @param value
     * @param preValue
     * @param errors
     * @param context
     * @param type
     * @returns
     */
    buildViewChangesContext(propertyName, value, preValue, errors, context, type = ViewChangeType.ValueChanged) {
        return {
            type: type,
            path: [propertyName],
            value: value,
            preValue: preValue,
            errors: errors,
            context
        };
    }
    getRow(bindingObject) {
        if (bindingObject && bindingObject.fromEntity) {
            return bindingObject;
        }
        if (bindingObject.parent && !(bindingObject.parent instanceof BindingList)) {
            return this.getRow(bindingObject.parent);
        }
        else {
            return bindingObject;
        }
    }
    makeHash() {
        var text = "";
        var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        for (var i = 0; i < 10; i++)
            text += possible.charAt(Math.floor(Math.random() * possible.length));
        return text;
    }
    differ() {
        let previous, next, value;
        return {
            onValueChange: () => {
                next = this.makeHash();
            },
            isChange: () => {
                return next !== previous;
            },
            update: (result) => {
                value = result;
                previous = next;
            },
            value: () => {
                return value;
            }
        };
    }
}
export { BaseBindingObject };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZV9iaW5kaW5nX29iamVjdC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2JpbmRpbmctZGF0YS9iYXNlX2JpbmRpbmdfb2JqZWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ25DLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDaEMsT0FBTyxFQUFVLFVBQVUsRUFBYyxjQUFjLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDM0UsT0FBTyxFQUFtQixtQkFBbUIsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUc3Qzs7R0FFRztBQUNILE1BQWUsaUJBQWlCO0lBaUU5QixzQ0FBc0M7SUFDdEM7UUFqRU8sYUFBUSxHQUFHLGVBQWUsQ0FBQztRQWdEbEM7O1dBRUc7UUFDSSxlQUFVLEdBQVksU0FBUyxDQUFDO1FBQ3ZDOztXQUVHO1FBQ0ksd0JBQW1CLEdBQUcsS0FBSyxDQUFDO1FBQ25DOztXQUVHO1FBQ0ksZ0JBQVcsR0FBaUIsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUNqRDs7V0FFRztRQUNJLGVBQVUsR0FBUSxFQUFFLENBQUM7UUFHMUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxHQUFHLEVBQWUsQ0FBQztRQUN0QyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksT0FBTyxFQUFVLENBQUM7UUFDckMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLE9BQU8sRUFBYyxDQUFDO0lBQy9DLENBQUM7SUFsQ0Q7O09BRUc7SUFDSCxJQUFXLGVBQWU7UUFDeEIsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxD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LElBQUksUUFBUSxFQUFFLElBQUksRUFBRSxLQUFLLENBQUM7UUFDMUIsT0FBTztZQUNMLGFBQWEsRUFBRSxHQUFHLEVBQUU7Z0JBQ2xCLElBQUksR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDekIsQ0FBQztZQUNELFFBQVEsRUFBRSxHQUFHLEVBQUU7Z0JBQ2IsT0FBTyxJQUFJLEtBQUssUUFBUSxDQUFDO1lBQzNCLENBQUM7WUFDRCxNQUFNLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRTtnQkFDakIsS0FBSyxHQUFHLE1BQU0sQ0FBQztnQkFDZixRQUFRLEdBQUcsSUFBSSxDQUFDO1lBQ2xCLENBQUM7WUFDRCxLQUFLLEVBQUUsR0FBRyxFQUFFO2dCQUNWLE9BQU8sS0FBSyxDQUFDO1lBQ2YsQ0FBQztTQUNGLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUFDRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YmplY3QsIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IE1hcCB9IGZyb20gJ2ltbXV0YWJsZSc7XHJcbmltcG9ydCB7IENoYW5nZSwgQ2hhbmdlVHlwZSwgVmlld0NoYW5nZSwgVmlld0NoYW5nZVR5cGUgfSBmcm9tICcuL2NoYW5nZXMnO1xyXG5pbXBvcnQgeyBCaW5kaW5nUHJvcGVydHksIEJpbmRpbmdQcm9wZXJ0eVR5cGUgfSBmcm9tICcuL2JpbmRpbmdfcHJvcGVydHknO1xyXG5pbXBvcnQgeyBCaW5kaW5nTGlzdCB9IGZyb20gJy4vYmluZGluZ19saXN0JztcclxuaW1wb3J0IHsgSW52b2tlT25WYWx1ZUNoYW5nZSB9IGZyb20gJy4vdHlwZXMnO1xyXG5cclxuLyoqXHJcbiAqIOe7keWumuWvueixoeWfuuexu1xyXG4gKi9cclxuYWJzdHJhY3QgY2xhc3MgQmFzZUJpbmRpbmdPYmplY3Qge1xyXG4gIHB1YmxpYyBfX3R5cGVfXyA9ICdCaW5kaW5nT2JqZWN0JztcclxuICAvLyBwcm90ZWN0ZWQgZGF0YTogYW55ID0gdW5kZWZpbmVkO1xyXG4gIC8qKlxyXG4gICAqIGltbXV0YWJsZeWAvOWvueixoVxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBpbm5lclZhbHVlczogTWFwPHN0cmluZywgYW55PjtcclxuICAvKipcclxuICAgKiDlvZPliY3or63oqIBcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgY3VycmVudExhbmd1YWdlOiBzdHJpbmc7XHJcbiAgLyoqXHJcbiAgICog54i25a+56LGh5oiW54i25YiX6KGoXHJcbiAgICovXHJcbiAgcHVibGljIHBhcmVudDogQmluZGluZ0xpc3QgfCBCYXNlQmluZGluZ09iamVjdDtcclxuXHJcbiAgLyoqXHJcbiAgICog5a6e5L2T5byV6LW355qE5Y+Y5pu0XHJcbiAgICovXHJcbiAgcHVibGljIGNoYW5nZXM6IFN1YmplY3Q8Q2hhbmdlPjtcclxuXHJcbiAgLyoqXHJcbiAgICog55WM6Z2i5bGC5byV6LW355qE5Y+Y5pu05rWBXHJcbiAgICovXHJcbiAgcHVibGljIHZpZXdDaGFuZ2VzOiBTdWJqZWN0PFZpZXdDaGFuZ2U+O1xyXG5cclxuICAvKipcclxuICAgKiAg5bGe5oCn6ZuG5ZCIXHJcbiAgICovXHJcbiAgcHVibGljIHByb3BlcnRpZXM6IEJpbmRpbmdQcm9wZXJ0eVtdO1xyXG5cclxuICAvKipcclxuICAgKiDkuLvplK7lkI1cclxuICAgKi9cclxuICBwdWJsaWMgcHJpbWFyeUtleTogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiDkuLvplK7lgLxcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0IHByaW1hcnlLZXlWYWx1ZSgpIHtcclxuICAgIHJldHVybiB0aGlzLnByaW1hcnlLZXkgPyB0aGlzLmdldFZhbHVlKHRoaXMucHJpbWFyeUtleSkgOiAnJztcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5pWw5o2u6KGM55qE5Li76ZSu5YC8XHJcbiAgICovXHJcbiAgcHVibGljIGdldCByb3dQcmltYXJ5S2V5VmFsdWUoKSB7XHJcbiAgICBjb25zdCByb3cgPSB0aGlzLmdldFJvdyh0aGlzKTtcclxuICAgIHJldHVybiByb3cgJiYgcm93LnByaW1hcnlLZXlWYWx1ZSB8fCBudWxsO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDnu5HlrprliLDlrp7kvZNcclxuICAgKi9cclxuICBwdWJsaWMgZnJvbUVudGl0eTogYm9vbGVhbiA9IHVuZGVmaW5lZDtcclxuICAvKipcclxuICAgKiDmoIfor4bmmK/lkKbmj5DkuqTov4dcclxuICAgKi9cclxuICBwdWJsaWMgaXNTaG93VmFsaWRhdGlvbk1zZyA9IGZhbHNlO1xyXG4gIC8qKlxyXG4gICAqIOmUgOavgea1gVxyXG4gICAqL1xyXG4gIHB1YmxpYyB1bnN1YnNjcmliZTogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3QoKTtcclxuICAvKipcclxuICAgKiDku6V7IFtwcm9wZXJ0eU5hbWVdOiBGb3JtQ29udHJvbCB955qE5b2i5byP5a2Y5pS+5q+P5p2h5pWw5o2u55qEY29udHJvbFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjb250cm9sTWFwOiBhbnkgPSB7fTtcclxuICAvLyBwcml2YXRlIF9fZGlmZmVyX18gPSB0aGlzLmRpZmZlcigpO1xyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy5pbm5lclZhbHVlcyA9IE1hcDxzdHJpbmcsIGFueT4oKTtcclxuICAgIHRoaXMuY2hhbmdlcyA9IG5ldyBTdWJqZWN0PENoYW5nZT4oKTtcclxuICAgIHRoaXMudmlld0NoYW5nZXMgPSBuZXcgU3ViamVjdDxWaWV3Q2hhbmdlPigpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDorr7nva7mmK/lkKbmj5DkuqTov4dcclxuICAgKi9cclxuICBwdWJsaWMgc2V0U2hvd1ZhbGlkYXRpb25Nc2coZmxhZzogYm9vbGVhbikge1xyXG4gICAgdGhpcy5pc1Nob3dWYWxpZGF0aW9uTXNnID0gZmxhZztcclxuICB9XHJcbiAgLy8gcHVibGljIGFic3RyYWN0IGxvYWQoZGF0YTogYW55KTtcclxuICAvKipcclxuICAgKiDmoLnmja7lsZ7mgKflkI3ojrflj5blsZ7mgKflgLxcclxuICAgKiBAcGFyYW0gICBwcm9wZXJ0eU5hbWUg5bGe5oCn5ZCNXHJcbiAgICogQHJldHVybnMg5bGe5oCn5YC8XHJcbiAgICovXHJcbiAgcHVibGljIGdldFZhbHVlKHByb3BlcnR5TmFtZTogc3RyaW5nKTogYW55IHtcclxuICAgIHJldHVybiB0aGlzLmlubmVyVmFsdWVzLmdldChwcm9wZXJ0eU5hbWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572u5bGe5oCn5YC8XHJcbiAgICogQHBhcmFtIHByb3BlcnR5TmFtZSAgICAgICAg5bGe5oCn5ZCNXHJcbiAgICogQHBhcmFtIHByb3BlcnR5VmFsdWUgICAgICAg5bGe5oCn5YC8XHJcbiAgICogQHBhcmFtIGVtaXRFdmVudFRvVmlldyAgICAg5piv5ZCm6YCa55+lVmlld+WxguWOu+abtOaWsOeVjOmdou+8jOm7mOiupOS4umZhbHNlXHJcbiAgICogQHBhcmFtIGVtaXRFdmVudFRvRW50aXR5ICAg5piv5ZCm6YCa55+lRW50aXR55bGC5Y675pu05paw5YC877yM6buY6K6k5Li6ZmFsc2VcclxuICAgKiBAcGFyYW0gZXJyb3JzICAgICAgICAgICAgICDplJnor6/mtojmga9cclxuICAgKiBAcGFyYW0gaW52b2tlT25WYWx1ZUNoYW5nZSDlgLzlj5jljJbkuovku7bmiafooYzlj6Xmn4RcclxuICAgKi9cclxuICBwdWJsaWMgc2V0VmFsdWUocHJvcGVydHlOYW1lOiBzdHJpbmcsIHByb3BlcnR5VmFsdWU6IGFueSwgZW1pdEV2ZW50VG9WaWV3OiBib29sZWFuID0gZmFsc2UsIGVtaXRFdmVudFRvRW50aXR5OiBib29sZWFuID0gZmFsc2UsIGVycm9ycz86IGFueSwgaW52b2tlT25WYWx1ZUNoYW5nZT86IEludm9rZU9uVmFsdWVDaGFuZ2UsIGNvbnRleHQ/OiBhbnkpOiB2b2lkIHtcclxuICAgIC8vIOWxj+iUveaOieaXoOaViOeahOi1i+WAvO+8jOmYsuatouWQjue7rei1i+WAvOWvueavlOaXtui3s+i/h++8jOWvvOiHtOWunuS9k+aXoOazlei1i+WAvFxyXG4gICAgLy8gaWYgKHRoaXMucHJpbWFyeUtleSAmJiAhdGhpcy5wcmltYXJ5S2V5VmFsdWUgJiYgdGhpcy5wcmltYXJ5S2V5ICE9PSBwcm9wZXJ0eU5hbWUpIHtcclxuICAgIC8vICAgcmV0dXJuO1xyXG4gICAgLy8gfVxyXG4gICAgY29uc3Qgb2xkUHJvcGVydHlWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUocHJvcGVydHlOYW1lKTtcclxuICAgIC8vIOeUseS6jueJueWumuWOn+WboO+8iEDpgrXnj6DlvLrvvInvvIzml6Dms5XlsY/olL1vbGRQcm9wZXJ0eVZhbHVlID09PSBwcm9wZXJ0eVZhbHVlXHJcbiAgICAvLyBpZiAob2xkUHJvcGVydHlWYWx1ZSA9PT0gcHJvcGVydHlWYWx1ZSkge1xyXG4gICAgLy8gICByZXR1cm47XHJcbiAgICAvLyB9XHJcbiAgICBpZiAoIWludm9rZU9uVmFsdWVDaGFuZ2UgfHwgb2xkUHJvcGVydHlWYWx1ZSA9PT0gcHJvcGVydHlWYWx1ZSkge1xyXG4gICAgICAvLyDorr7lrprnvLrnnIFcclxuICAgICAgaW52b2tlT25WYWx1ZUNoYW5nZSA9IGZ1bmN0aW9uIChwcmVWYWx1ZSwgdmFsdWUsIGVudGl0eUNoYW5nZWQ6IGJvb2xlYW4sIHByaW1hcnlWYWx1ZT86IGFueSkge1xyXG4gICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgfTtcclxuICAgIH1cclxuICAgIGlmIChlbWl0RXZlbnRUb0VudGl0eSA9PT0gdHJ1ZSkge1xyXG4gICAgICAvLyBCVUcgMzIyMzAx77yM5Yig6ZmkQDIwMTkuMDguMTA7IOWmguaenOaXoOWvueW6lOWunuS9k++8jOWImeS4reatouWAvOS8oOmAkjsg6L+Z56eN5oOF5Ya15Y+R55Sf5Zyo5bim5LuO6KGo55qE5Y2V5o2u5paw5aKe77yM5LuO6KGo5ZON5bqUTG9hZOWPmOWMlueahOaDheWGte+8m1xyXG4gICAgICAvLyBpZighdGhpcy5pbm5lclZhbHVlcy5oYXMocHJvcGVydHlOYW1lKSkge1xyXG4gICAgICAvLyAgIHJldHVybjtcclxuICAgICAgLy8gfVxyXG4gICAgICAvLyDmiafooYzlrp7kvZPlgLzlj5jljJbliY3kuovku7ZcclxuICAgICAgaW52b2tlT25WYWx1ZUNoYW5nZShvbGRQcm9wZXJ0eVZhbHVlLCBwcm9wZXJ0eVZhbHVlLCBmYWxzZSwgdGhpcy5yb3dQcmltYXJ5S2V5VmFsdWUpLnN1YnNjcmliZSgocmVzdWx0KSA9PiB7XHJcbiAgICAgICAgaWYgKHJlc3VsdCkge1xyXG4gICAgICAgICAgLy90aGlzLl9fZGlmZmVyX18ub25WYWx1ZUNoYW5nZSgpO1xyXG4gICAgICAgICAgLy8g5aaC5p6c5oiQ5Yqf77yM5omn6KGM5Y+Y5YyW77yM5bm26YCa55+l5a6e5L2T5Y+Y5YyWXHJcbiAgICAgICAgICB0aGlzLmlubmVyVmFsdWVzID0gdGhpcy5pbm5lclZhbHVlcy5zZXQocHJvcGVydHlOYW1lLCBwcm9wZXJ0eVZhbHVlKTtcclxuICAgICAgICAgIC8vIHRoaXMuZGF0YVtwcm9wZXJ0eU5hbWVdID0gcHJvcGVydHlWYWx1ZTtcclxuICAgICAgICAgIGNvbnN0IHZpZXdDaGFuZ2UgPSB0aGlzLmJ1aWxkVmlld0NoYW5nZXNDb250ZXh0KHByb3BlcnR5TmFtZSwgcHJvcGVydHlWYWx1ZSwgb2xkUHJvcGVydHlWYWx1ZSwgZXJyb3JzLCBjb250ZXh0KTtcclxuICAgICAgICAgIHRoaXMudmlld0NoYW5nZXMubmV4dCh2aWV3Q2hhbmdlKTtcclxuICAgICAgICAgIC8vIOWmguaenOmcgOimgemAmuefpeinhuWbvu+8jOmAmuefpeinhuWbvuebuOW6lOS/ruaUuVxyXG4gICAgICAgICAgaWYgKGVtaXRFdmVudFRvVmlldyA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICBjb25zdCBjaGFuZ2UgPSB0aGlzLmJ1aWxkQ2hhbmdlc0NvbnRleHQocHJvcGVydHlOYW1lLCBwcm9wZXJ0eVZhbHVlLCBjb250ZXh0LCBlcnJvcnMpO1xyXG4gICAgICAgICAgICB0aGlzLmNoYW5nZXMubmV4dChjaGFuZ2UpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgLy8g5omn6KGM5a6e5L2T5YC85Y+Y5YyW5ZCO5LqL5Lu2XHJcbiAgICAgICAgICBpbnZva2VPblZhbHVlQ2hhbmdlKG9sZFByb3BlcnR5VmFsdWUsIHByb3BlcnR5VmFsdWUsIHRydWUsIHRoaXMucm93UHJpbWFyeUtleVZhbHVlKS5zdWJzY3JpYmUoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8g5aaC5p6c5aSx6LSl77yM5LiN5YaN6YCa55+l5a6e5L2T5Y+Y5YyWXHJcbiAgICAgICAgICAvLyDlubbmiafooYznlYzpnaLlm57mu5rmk43kvZxcclxuICAgICAgICAgIGNvbnN0IGNoYW5nZSA9IHRoaXMuYnVpbGRDaGFuZ2VzQ29udGV4dChwcm9wZXJ0eU5hbWUsIG9sZFByb3BlcnR5VmFsdWUsIGNvbnRleHQsIGVycm9ycyk7XHJcbiAgICAgICAgICB0aGlzLmNoYW5nZXMubmV4dChjaGFuZ2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvL3RoaXMuX19kaWZmZXJfXy5vblZhbHVlQ2hhbmdlKCk7XHJcbiAgICAgIC8vIGBlbWl0RXZlbnRUb0VudGl0eSA9PT0gZmFsc2VgLCDliJnorqTlrprlrp7kvZPlgLzlt7Lnu4/lj5HnlJ/lj5jljJbvvIzpgJrnn6Xop4blm77lj5jljJbvvIzlubbop6blj5Hlrp7kvZPlgLzlj5jljJblkI7kuovku7ZcclxuICAgICAgdGhpcy5pbm5lclZhbHVlcyA9IHRoaXMuaW5uZXJWYWx1ZXMuc2V0KHByb3BlcnR5TmFtZSwgcHJvcGVydHlWYWx1ZSk7XHJcbiAgICAgIC8vIHRoaXMuZGF0YVtwcm9wZXJ0eU5hbWVdID0gcHJvcGVydHlWYWx1ZTtcclxuICAgICAgaWYgKGVtaXRFdmVudFRvVmlldyA9PT0gdHJ1ZSkge1xyXG4gICAgICAgIGNvbnN0IGNoYW5nZSA9IHRoaXMuYnVpbGRDaGFuZ2VzQ29udGV4dChwcm9wZXJ0eU5hbWUsIHByb3BlcnR5VmFsdWUsIGNvbnRleHQsIGVycm9ycyk7XHJcbiAgICAgICAgdGhpcy5jaGFuZ2VzLm5leHQoY2hhbmdlKTtcclxuICAgICAgfVxyXG4gICAgICAvLyDmiafooYzlrp7kvZPlgLzlj5jljJblkI7kuovku7ZcclxuICAgICAgaW52b2tlT25WYWx1ZUNoYW5nZShvbGRQcm9wZXJ0eVZhbHVlLCBwcm9wZXJ0eVZhbHVlLCB0cnVlLCB0aGlzLnJvd1ByaW1hcnlLZXlWYWx1ZSkuc3Vic2NyaWJlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWwhkJpbmRpbmdPYmplY3Tlrp7kvovovazmjaLmiJBKU09O5a+56LGhXHJcbiAgICovXHJcbiAgcHVibGljIHRvSlNPTihvcHRpb25zPzogYW55KTogYW55IHtcclxuICAgIC8vaWYgKCF0aGlzLl9fZGlmZmVyX18uaXNDaGFuZ2UoKSkge1xyXG4gICAgLy8gIHJldHVybiB0aGlzLl9fZGlmZmVyX18udmFsdWUoKTtcclxuICAgIC8vfVxyXG4gICAgY29uc3QgbGFuZ0NvZGUgPSB0aGlzLmdldEN1cnJlbnRMYW5ndWFnZSgpOy8vd2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKCdsYW5ndWFnZUNvZGUnKSB8fCAnemgtQ0hTJztcclxuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xyXG4gICAgdGhpcy5wcm9wZXJ0aWVzLmZvckVhY2goKHByb3BlcnR5OiBCaW5kaW5nUHJvcGVydHkpID0+IHtcclxuICAgICAgY29uc3QgcHJvcE5hbWUgPSBwcm9wZXJ0eS5uYW1lO1xyXG4gICAgICBpZiAocHJvcGVydHkudHlwZSA9PT0gQmluZGluZ1Byb3BlcnR5VHlwZS5MaXN0KSB7XHJcbiAgICAgICAgY29uc3QgbGlzdDogQmluZGluZ0xpc3QgPSB0aGlzW3Byb3BOYW1lXTtcclxuICAgICAgICByZXN1bHRbcHJvcE5hbWVdID0gbGlzdC50b0pTT04ob3B0aW9ucyk7XHJcbiAgICAgIH0gZWxzZSBpZiAocHJvcGVydHkudHlwZSA9PT0gQmluZGluZ1Byb3BlcnR5VHlwZS5PYmplY3QpIHtcclxuICAgICAgICBjb25zdCBvYmplY3Q6IEJhc2VCaW5kaW5nT2JqZWN0ID0gdGhpc1twcm9wTmFtZV07XHJcbiAgICAgICAgcmVzdWx0W3Byb3BOYW1lXSA9IG9iamVjdC50b0pTT04ob3B0aW9ucyk7XHJcbiAgICAgIH0gZWxzZSBpZiAocHJvcGVydHkudHlwZSA9PT0gQmluZGluZ1Byb3BlcnR5VHlwZS5EeW5hbWljKSB7XHJcbiAgICAgICAgY29uc3Qgb2JqZWN0OiBCYXNlQmluZGluZ09iamVjdCA9IHRoaXNbcHJvcE5hbWVdO1xyXG4gICAgICAgIHJlc3VsdFtwcm9wTmFtZV0gPSBvYmplY3QudG9KU09OKG9wdGlvbnMpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIDHjgIHlr7nkuo7lpJror63lvZXlhaXlrZfmrrXvvJtcclxuICAgICAgICAvLyAy44CB5Lyg5YWlaWdub3JlTXVsdGlMYW5nSW5wdXTmoIflv5fvvIzliJnlj5blvZPliY3or63oqIDnmoTlgLznu5nmjqfku7bjgIJcclxuICAgICAgICBpZiAocHJvcGVydHkuZW5hYmxlTXVsdGlMYW5nSW5wdXQgPT09IHRydWUpIHtcclxuICAgICAgICAgIC8vIOW/veeVpeWkmuivreWtl+aute+8jOWPqui/lOWbnuW9k+WJjeivreiogFxyXG4gICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5pZ25vcmVNdWx0aUxhbmdJbnB1dCA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICBjb25zdCBtdWx0aUxhbmdWYWx1ZU9iaiA9IHRoaXMuZ2V0VmFsdWUocHJvcE5hbWUpO1xyXG4gICAgICAgICAgICBpZiAobXVsdGlMYW5nVmFsdWVPYmopIHtcclxuICAgICAgICAgICAgICByZXN1bHRbcHJvcE5hbWVdID0gbXVsdGlMYW5nVmFsdWVPYmpbbGFuZ0NvZGVdO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIHJlc3VsdFtwcm9wTmFtZV0gPSBtdWx0aUxhbmdWYWx1ZU9iajtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zICYmIG9wdGlvbnMudXNlRnVsbE11bHRpTGFuZ1Byb3BlcnR5KSB7XHJcbiAgICAgICAgICAgIC8vIOe7meWuoeaJueaPkOS+m+eahOaJqeWxlSBAMjAyMS0xMC0xM1xyXG4gICAgICAgICAgICBjb25zdCBtdWx0aUxhbmdWYWx1ZU9iaiA9IHRoaXMuZ2V0VmFsdWUocHJvcE5hbWUpO1xyXG4gICAgICAgICAgICBpZiAobXVsdGlMYW5nVmFsdWVPYmopIHtcclxuICAgICAgICAgICAgICByZXN1bHRbYCR7cHJvcE5hbWV9X01VTFRJTEFOR1VBR0VgXSA9IG11bHRpTGFuZ1ZhbHVlT2JqO1xyXG4gICAgICAgICAgICAgIC8vIOmZpOi/lOWbnuWkmuivreWtl+auteWklu+8jOWwhuW9k+WJjeivreiogOS5n+i/lOWbnlxyXG4gICAgICAgICAgICAgIHJlc3VsdFtwcm9wTmFtZV0gPSBtdWx0aUxhbmdWYWx1ZU9ialtsYW5nQ29kZV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG11bHRpTGFuZ1ZhbHVlT2JqID0gdGhpcy5nZXRWYWx1ZShwcm9wTmFtZSk7XHJcbiAgICAgICAgICAgIGlmICghbXVsdGlMYW5nVmFsdWVPYmopIHtcclxuICAgICAgICAgICAgICByZXN1bHRbcHJvcE5hbWVdID0geyBbbGFuZ0NvZGVdOiBtdWx0aUxhbmdWYWx1ZU9iaiB9O1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIHJlc3VsdFtwcm9wTmFtZV0gPSBtdWx0aUxhbmdWYWx1ZU9iajtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXN1bHRbcHJvcE5hbWVdID0gdGhpcy5nZXRWYWx1ZShwcm9wTmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIC8vIHRoaXMuX19kaWZmZXJfXy51cGRhdGUocmVzdWx0KTtcclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluW9k+WJjeivreiogFxyXG4gICAqIEByZXR1cm5zXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGdldEN1cnJlbnRMYW5ndWFnZSgpIHtcclxuICAgIHRoaXMuY3VycmVudExhbmd1YWdlID0gdGhpcy5jdXJyZW50TGFuZ3VhZ2UgfHwgd2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKCdsYW5ndWFnZUNvZGUnKSB8fCAnemgtQ0hTJztcclxuICAgIHJldHVybiB0aGlzLmN1cnJlbnRMYW5ndWFnZTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p6E6YCgYmluZGlnbkRhdGHlj5jmm7TkuIrkuIvmlodcclxuICAgKiBAcGFyYW0gcHJvcGVydHlOYW1lXHJcbiAgICogQHBhcmFtIHByb3BlcnR5VmFsdWVcclxuICAgKiBAcGFyYW0gY29udGV4dFxyXG4gICAqIEBwYXJhbSBlcnJvcnNcclxuICAgKiBAcGFyYW0gdHlwZVxyXG4gICAqIEByZXR1cm5zXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZENoYW5nZXNDb250ZXh0KHByb3BlcnR5TmFtZTogc3RyaW5nLCBwcm9wZXJ0eVZhbHVlOiBhbnksIGNvbnRleHQ/OiBhbnksIGVycm9ycz86IGFueSwgdHlwZTogQ2hhbmdlVHlwZSA9IENoYW5nZVR5cGUuVmFsdWVDaGFuZ2VkKTogQ2hhbmdlIHtcclxuICAgIGNvbnN0IG9iamVjdCA9IHRoaXMuZ2V0Um93KHRoaXMpO1xyXG4gICAgY29uc3QgaWQgPSBvYmplY3QgPyBvYmplY3QucHJpbWFyeUtleVZhbHVlIDogbnVsbDtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHR5cGU6IHR5cGUsXHJcbiAgICAgIHBhdGg6IFtwcm9wZXJ0eU5hbWVdLFxyXG4gICAgICB2YWx1ZTogcHJvcGVydHlWYWx1ZSxcclxuICAgICAgaWQ6IGlkLFxyXG4gICAgICBlcnJvcnM6IGVycm9ycyxcclxuICAgICAgY29udGV4dFxyXG4gICAgfTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p6E6YCgdmlld0NoYW5nZXPkuIrkuIvmlodcclxuICAgKiBAcGFyYW0gcHJvcGVydHlOYW1lXHJcbiAgICogQHBhcmFtIHZhbHVlXHJcbiAgICogQHBhcmFtIHByZVZhbHVlXHJcbiAgICogQHBhcmFtIGVycm9yc1xyXG4gICAqIEBwYXJhbSBjb250ZXh0XHJcbiAgICogQHBhcmFtIHR5cGVcclxuICAgKiBAcmV0dXJuc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGRWaWV3Q2hhbmdlc0NvbnRleHQocHJvcGVydHlOYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnksIHByZVZhbHVlOiBhbnksIGVycm9ycz86IGFueSwgY29udGV4dD86IGFueSwgdHlwZTogVmlld0NoYW5nZVR5cGUgPSBWaWV3Q2hhbmdlVHlwZS5WYWx1ZUNoYW5nZWQpOiBWaWV3Q2hhbmdlIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHR5cGU6IHR5cGUsXHJcbiAgICAgIHBhdGg6IFtwcm9wZXJ0eU5hbWVdLFxyXG4gICAgICB2YWx1ZTogdmFsdWUsXHJcbiAgICAgIHByZVZhbHVlOiBwcmVWYWx1ZSxcclxuICAgICAgZXJyb3JzOiBlcnJvcnMsXHJcbiAgICAgIGNvbnRleHRcclxuICAgIH07XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0Um93KGJpbmRpbmdPYmplY3Q6IEJhc2VCaW5kaW5nT2JqZWN0KTogQmFzZUJpbmRpbmdPYmplY3Qge1xyXG4gICAgaWYgKGJpbmRpbmdPYmplY3QgJiYgYmluZGluZ09iamVjdC5mcm9tRW50aXR5KSB7XHJcbiAgICAgIHJldHVybiBiaW5kaW5nT2JqZWN0O1xyXG4gICAgfVxyXG4gICAgaWYgKGJpbmRpbmdPYmplY3QucGFyZW50ICYmICEoYmluZGluZ09iamVjdC5wYXJlbnQgaW5zdGFuY2VvZiBCaW5kaW5nTGlzdCkpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZ2V0Um93KGJpbmRpbmdPYmplY3QucGFyZW50KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBiaW5kaW5nT2JqZWN0O1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIG1ha2VIYXNoKCkge1xyXG4gICAgdmFyIHRleHQgPSBcIlwiO1xyXG4gICAgdmFyIHBvc3NpYmxlID0gXCJBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OVwiO1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCAxMDsgaSsrKVxyXG4gICAgICB0ZXh0ICs9IHBvc3NpYmxlLmNoYXJBdChNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBwb3NzaWJsZS5sZW5ndGgpKTtcclxuICAgIHJldHVybiB0ZXh0O1xyXG4gIH1cclxuICBwcml2YXRlIGRpZmZlcigpIHtcclxuICAgIGxldCBwcmV2aW91cywgbmV4dCwgdmFsdWU7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBvblZhbHVlQ2hhbmdlOiAoKSA9PiB7XHJcbiAgICAgICAgbmV4dCA9IHRoaXMubWFrZUhhc2goKTtcclxuICAgICAgfSxcclxuICAgICAgaXNDaGFuZ2U6ICgpID0+IHtcclxuICAgICAgICByZXR1cm4gbmV4dCAhPT0gcHJldmlvdXM7XHJcbiAgICAgIH0sXHJcbiAgICAgIHVwZGF0ZTogKHJlc3VsdCkgPT4ge1xyXG4gICAgICAgIHZhbHVlID0gcmVzdWx0O1xyXG4gICAgICAgIHByZXZpb3VzID0gbmV4dDtcclxuICAgICAgfSxcclxuICAgICAgdmFsdWU6ICgpID0+IHtcclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgfVxyXG59XHJcbmV4cG9ydCB7IEJhc2VCaW5kaW5nT2JqZWN0IH1cclxuIl19