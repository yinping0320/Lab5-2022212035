import { BindingPropertyType } from './binding_property';
import { PropertyUtil } from './property_util';
import { BaseBindingObject } from './base_binding_object';
import { BindingListFactory } from './binding_list_factory';
import { TranslateService } from '../i18n/translate_service';
// import { BindingObjectFactory } from './binding_object_factory';
/**
 * BindingObjectTypeFactory
 */
export class BindingObjectTypeFactory {
    /**
     * 创建BindingObject
     * @param properties
     * @returns
     */
    static create(properties) {
        const bindingObjectType = this.getType(properties);
        return new bindingObjectType();
    }
    /**
     * 创建原型类型
     * @param properties
     * @returns
     */
    static createType(properties) {
        // 继承原绑定对象所有属性
        const bindingObjectType = class BindingObjectType extends BaseBindingObject {
            constructor() {
                super();
                // this.innerValues = ImmutableMap(Object.assign({}, data));
            }
        };
        // 获取主键
        const primaryKey = PropertyUtil.getPrimaryKey(properties);
        // 设置主键
        bindingObjectType.prototype.primaryKey = primaryKey;
        bindingObjectType.prototype.properties = properties;
        // 将属性扩展到原型对象上
        this.extendProperties(bindingObjectType.prototype, properties);
        return bindingObjectType;
    }
    /**
     * 扩展原型属性
     * @param typePrototype
     * @param properties
     */
    static extendProperties(typePrototype, properties) {
        // 扩展BindingObject属性
        properties.forEach((property) => {
            if (property.type === BindingPropertyType.List) {
                this.extendListProperty(typePrototype, property);
            }
            else if (property.type === BindingPropertyType.Object) {
                this.extendObjectProperty(typePrototype, property);
            }
            else if (property.type === BindingPropertyType.Dynamic) {
                this.extendDynamicObjectProperty(typePrototype, property);
            }
            else {
                this.extendPlainProperty(typePrototype, property);
            }
        });
    }
    /**
     * 扩展原型列表属性
     * @param typePrototype
     * @param property
     */
    static extendListProperty(typePrototype, property) {
        const propertyName = property.name;
        const childListProperties = PropertyUtil.getProperties(property.entityType);
        const key = `_${propertyName}_`;
        // 将子的BindingList实例赋值给当前属性
        Object.defineProperty(typePrototype, propertyName, {
            get: function () {
                let bindingList = this[key];
                if (!bindingList) {
                    bindingList = BindingListFactory.create(childListProperties);
                    this[key] = bindingList;
                    // 加载数据
                    const data = this.getValue(propertyName);
                    if (data) {
                        const bindingObjects = data.map((item) => {
                            const bindingObject = BindingObjectTypeFactory.create(childListProperties);
                            return bindingObject;
                        });
                        bindingList.load(bindingObjects);
                    }
                    // 指定子List的parent、监听子List的changes事件
                    bindingList.parent = this;
                    bindingList.changes.subscribe((change) => {
                        change.path.unshift(propertyName);
                        change.isBindingListTransmited = true;
                        this.changes.next(change);
                    });
                }
                return bindingList;
            },
            set: function (bindingList) {
                this[key] = bindingList;
            }
        });
    }
    /**
     * 扩展原型对象属性
     * @param typePrototype
     * @param property
     */
    static extendObjectProperty(typePrototype, property) {
        const propertyName = property.name;
        const childObjectProperties = PropertyUtil.getProperties(property.entityType);
        const key = `_${propertyName}_`;
        Object.defineProperty(typePrototype, propertyName, {
            get: function () {
                let bindingObject = this[key];
                if (!bindingObject) {
                    const value = this.getValue(propertyName) || {};
                    bindingObject = BindingObjectTypeFactory.create(childObjectProperties);
                    this[key] = bindingObject;
                    // 指定子Object的parent、监听子Object的changes事件
                    bindingObject.parent = this;
                    bindingObject.changes.subscribe((change) => {
                        change.path.unshift(propertyName);
                        this.changes.next(change);
                    });
                }
                return bindingObject;
            },
            set: function (value) {
                this[key] = value;
            }
        });
    }
    /**
     * 扩展原型动态属性
     * @param typePrototype
     * @param property
     */
    static extendDynamicObjectProperty(typePrototype, property) {
        const propertyName = property.name;
        // Object.defineProperty(typePrototype, propertyName, {
        //   value: null
        // });
        typePrototype[propertyName] = null;
    }
    /**
     * 扩展原型简单属性
     * @param typePrototype
     * @param property
     */
    static extendPlainProperty(typePrototype, property) {
        const propertyName = property.name;
        Object.defineProperty(typePrototype, propertyName, {
            get: function () {
                if (property.enableMultiLangInput === true) {
                    let value = this.getValue(propertyName, false);
                    if (!value) {
                        value = this.getValue(propertyName, false);
                        const langCode = TranslateService.getCurrentLanguage();
                        return { [langCode]: value };
                    }
                    return value;
                }
                else {
                    const value = this.getValue(propertyName);
                    return value;
                }
            },
            set: function (value) {
                const oldValue = this.getValue(propertyName);
                if (value === oldValue) {
                    return;
                }
                this.setValue(propertyName, value, true, true);
            }
        });
    }
    /**
     * 获取缓存的bindingList模板类
     * @param properties bindingList属性
     * @returns
     */
    static getType(properties) {
        if (this.provider.has(properties)) {
            return this.provider.get(properties);
        }
        const bindingObjectType = this.createType(properties);
        this.provider.set(properties, bindingObjectType);
        return bindingObjectType;
    }
}
BindingObjectTypeFactory.provider = new Map();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19vYmplY3RfdHlwZV9mYWN0b3J5LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvYmluZGluZy1kYXRhL2JpbmRpbmdfb2JqZWN0X3R5cGVfZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQW1CLG1CQUFtQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFMUUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQy9DLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzFELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRzVELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzdELG1FQUFtRTtBQUVuRTs7R0FFRztBQUNILE1BQU0sT0FBTyx3QkFBd0I7SUFFbkM7Ozs7T0FJRztJQUNJLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBNkI7UUFDaEQsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ25ELE9BQU8sSUFBSSxpQkFBaUIsRUFBRSxDQUFDO0lBQ2pDLENBQUM7SUFDRDs7OztPQUlHO0lBQ0ssTUFBTSxDQUFDLFVBQVUsQ0FBQyxVQUE2QjtRQUNyRCxjQUFjO1FBQ2QsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLGlCQUFrQixTQUFRLGlCQUFpQjtZQUN6RTtnQkFDRSxLQUFLLEVBQUUsQ0FBQztnQkFDUiw0REFBNEQ7WUFFOUQsQ0FBQztTQWdFRixDQUFDO1FBQ0YsT0FBTztRQUNQLE1BQU0sVUFBVSxHQUFHLFlBQVksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDMUQsT0FBTztRQUNQLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQ3BELGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQ3BELGNBQWM7UUFDZCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsaUJBQWlCLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQy9ELE9BQU8saUJBQWlCLENBQUM7SUFDM0IsQ0FBQztJQUNEOzs7O09BSUc7SUFDSyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsYUFBZ0MsRUFBRSxVQUE2QjtRQUM3RixvQkFBb0I7UUFDcEIsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQXlCLEVBQUUsRUFBRTtZQUMvQyxJQUFJLFFBQVEsQ0FBQyxJQUFJLEtBQUssbUJBQW1CLENBQUMsSUFBSSxFQUFFO2dCQUM5QyxJQUFJLENBQUMsa0JBQWtCLENBQUMsYUFBYSxFQUFFLFFBQVEsQ0FBQyxDQUFDO2FBQ2xEO2lCQUFNLElBQUksUUFBUSxDQUFDLElBQUksS0FBSyxtQkFBbUIsQ0FBQyxNQUFNLEVBQUU7Z0JBQ3ZELElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxhQUFhLEVBQUUsUUFBUSxDQUFDLENBQUM7YUFDcEQ7aUJBQU0sSUFBSSxRQUFRLENBQUMsSUFBSSxLQUFLLG1CQUFtQixDQUFDLE9BQU8sRUFBRTtnQkFDeEQsSUFBSSxDQUFDLDJCQUEyQixDQUFDLGFBQWEsRUFBRSxRQUFRLENBQUMsQ0FBQzthQUMzRDtpQkFBTTtnQkFDTCxJQUFJLENBQUMsbUJBQW1CLENBQUMsYUFBYSxFQUFFLFFBQVEsQ0FBQyxDQUFDO2FBQ25EO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0Q7Ozs7T0FJRztJQUNLLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxhQUFnQyxFQUFFLFFBQXlCO1FBQzNGLE1BQU0sWUFBWSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUM7UUFDbkMsTUFBTSxtQkFBbUIsR0FBRyxZQUFZLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUM1RSxNQUFNLEdBQUcsR0FBRyxJQUFJLFlBQVksR0FBRyxDQUFDO1FBQ2hDLDBCQUEwQjtRQUMxQixNQUFNLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRSxZQUFZLEVBQUU7WUFDakQsR0FBRyxFQUFFO2dCQUNILElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDNUIsSUFBSSxDQUFDLFdBQVcsRUFBRTtvQkFDaEIsV0FBVyxHQUFHLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO29CQUM3RCxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsV0FBVyxDQUFDO29CQUN4QixPQUFPO29CQUNQLE1BQU0sSUFBSSxHQUFVLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7b0JBQ2hELElBQUksSUFBSSxFQUFFO3dCQUNSLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTs0QkFDdkMsTUFBTSxhQUFhLEdBQUcsd0JBQXdCLENBQUMsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUM7NEJBQzNFLE9BQU8sYUFBYSxDQUFDO3dCQUN2QixDQUFDLENBQUMsQ0FBQzt3QkFDSCxXQUFXLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO3FCQUNsQztvQkFDRCxtQ0FBbUM7b0JBQ25DLFdBQVcsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO29CQUMxQixXQUFXLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQWMsRUFBRSxFQUFFO3dCQUMvQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQzt3QkFDbEMsTUFBTSxDQUFDLHVCQUF1QixHQUFHLElBQUksQ0FBQzt3QkFDdEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7b0JBQzVCLENBQUMsQ0FBQyxDQUFDO2lCQUNKO2dCQUNELE9BQU8sV0FBVyxDQUFDO1lBQ3JCLENBQUM7WUFDRCxHQUFHLEVBQUUsVUFBVSxXQUF3QjtnQkFDckMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFdBQVcsQ0FBQztZQUMxQixDQUFDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNEOzs7O09BSUc7SUFDSyxNQUFNLENBQUMsb0JBQW9CLENBQUMsYUFBZ0MsRUFBRSxRQUF5QjtRQUM3RixNQUFNLFlBQVksR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDO1FBQ25DLE1BQU0scUJBQXFCLEdBQUcsWUFBWSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDOUUsTUFBTSxHQUFHLEdBQUcsSUFBSSxZQUFZLEdBQUcsQ0FBQztRQUNoQyxNQUFNLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRSxZQUFZLEVBQUU7WUFDakQsR0FBRyxFQUFFO2dCQUNILElBQUksYUFBYSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDOUIsSUFBSSxDQUFDLGFBQWEsRUFBRTtvQkFDbEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUM7b0JBQ2hELGFBQWEsR0FBRyx3QkFBd0IsQ0FBQyxNQUFNLENBQUMscUJBQXFCLENBQUMsQ0FBQztvQkFDdkUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLGFBQWEsQ0FBQztvQkFDMUIsdUNBQXVDO29CQUN2QyxhQUFhLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztvQkFDNUIsYUFBYSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFjLEVBQUUsRUFBRTt3QkFDakQsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7d0JBQ2xDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUM1QixDQUFDLENBQUMsQ0FBQztpQkFDSjtnQkFDRCxPQUFPLGFBQWEsQ0FBQztZQUN2QixDQUFDO1lBQ0QsR0FBRyxFQUFFLFVBQVUsS0FBd0I7Z0JBQ3JDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUM7WUFDcEIsQ0FBQztTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDRDs7OztPQUlHO0lBQ0ssTUFBTSxDQUFDLDJCQUEyQixDQUFDLGFBQWdDLEVBQUUsUUFBeUI7UUFDcEcsTUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQztRQUNuQyx1REFBdUQ7UUFDdkQsZ0JBQWdCO1FBQ2hCLE1BQU07UUFDTixhQUFhLENBQUMsWUFBWSxDQUFDLEdBQUcsSUFBSSxDQUFDO0lBQ3JDLENBQUM7SUFDRDs7OztPQUlHO0lBQ0ssTUFBTSxDQUFDLG1CQUFtQixDQUFDLGFBQWdDLEVBQUUsUUFBeUI7UUFDNUYsTUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQztRQUNuQyxNQUFNLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRSxZQUFZLEVBQUU7WUFDakQsR0FBRyxFQUFFO2dCQUNILElBQUksUUFBUSxDQUFDLG9CQUFvQixLQUFLLElBQUksRUFBRTtvQkFDMUMsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsS0FBSyxDQUFDLENBQUM7b0JBQy9DLElBQUksQ0FBQyxLQUFLLEVBQUU7d0JBQ1YsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxDQUFDO3dCQUMzQyxNQUFNLFFBQVEsR0FBRyxnQkFBZ0IsQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO3dCQUN2RCxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQztxQkFDOUI7b0JBQ0QsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7cUJBQU07b0JBQ0wsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQztvQkFDMUMsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7WUFDSCxDQUFDO1lBQ0QsR0FBRyxFQUFFLFVBQVUsS0FBVTtnQkFDdkIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQztnQkFDN0MsSUFBSSxLQUFLLEtBQUssUUFBUSxFQUFFO29CQUN0QixPQUFPO2lCQUNSO2dCQUNELElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDakQsQ0FBQztTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDRDs7OztPQUlHO0lBQ0ssTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUE2QjtRQUNsRCxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQ2pDLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDdEM7UUFDRCxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDdEQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFDakQsT0FBTyxpQkFBaUIsQ0FBQztJQUMzQixDQUFDOztBQWhQYyxpQ0FBUSxHQUFnRCxJQUFJLEdBQUcsRUFBMEMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFR5cGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuLy9pbXBvcnQgeyBNYXAgYXMgSW1tdXRhYmxlTWFwIH0gZnJvbSAnaW1tdXRhYmxlJztcclxuaW1wb3J0IHsgQ2hhbmdlIH0gZnJvbSAnLi9jaGFuZ2VzJztcclxuaW1wb3J0IHsgQmluZGluZ1Byb3BlcnR5LCBCaW5kaW5nUHJvcGVydHlUeXBlIH0gZnJvbSAnLi9iaW5kaW5nX3Byb3BlcnR5JztcclxuaW1wb3J0IHsgQmluZGluZ0xpc3QgfSBmcm9tICcuL2JpbmRpbmdfbGlzdCc7XHJcbmltcG9ydCB7IFByb3BlcnR5VXRpbCB9IGZyb20gJy4vcHJvcGVydHlfdXRpbCc7XHJcbmltcG9ydCB7IEJhc2VCaW5kaW5nT2JqZWN0IH0gZnJvbSAnLi9iYXNlX2JpbmRpbmdfb2JqZWN0JztcclxuaW1wb3J0IHsgQmluZGluZ0xpc3RGYWN0b3J5IH0gZnJvbSAnLi9iaW5kaW5nX2xpc3RfZmFjdG9yeSc7XHJcbmltcG9ydCB7IENsYXNzVHlwZSB9IGZyb20gJy4uL2VudGl0eSc7XHJcbmltcG9ydCB7IEJpbmRpbmdPYmplY3QgfSBmcm9tICcuL2JpbmRpbmdfb2JqZWN0JztcclxuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJy4uL2kxOG4vdHJhbnNsYXRlX3NlcnZpY2UnO1xyXG4vLyBpbXBvcnQgeyBCaW5kaW5nT2JqZWN0RmFjdG9yeSB9IGZyb20gJy4vYmluZGluZ19vYmplY3RfZmFjdG9yeSc7XHJcblxyXG4vKipcclxuICogQmluZGluZ09iamVjdFR5cGVGYWN0b3J5XHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgQmluZGluZ09iamVjdFR5cGVGYWN0b3J5IHtcclxuICBwcml2YXRlIHN0YXRpYyBwcm92aWRlcjogTWFwPEJpbmRpbmdQcm9wZXJ0eVtdLCBUeXBlPEJpbmRpbmdPYmplY3Q+PiA9IG5ldyBNYXA8QmluZGluZ1Byb3BlcnR5W10sIFR5cGU8QmluZGluZ09iamVjdD4+KCk7XHJcbiAgLyoqXHJcbiAgICog5Yib5bu6QmluZGluZ09iamVjdFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0aWVzXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGljIGNyZWF0ZShwcm9wZXJ0aWVzOiBCaW5kaW5nUHJvcGVydHlbXSkge1xyXG4gICAgY29uc3QgYmluZGluZ09iamVjdFR5cGUgPSB0aGlzLmdldFR5cGUocHJvcGVydGllcyk7XHJcbiAgICByZXR1cm4gbmV3IGJpbmRpbmdPYmplY3RUeXBlKCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWIm+W7uuWOn+Wei+exu+Wei1xyXG4gICAqIEBwYXJhbSBwcm9wZXJ0aWVzXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBjcmVhdGVUeXBlKHByb3BlcnRpZXM6IEJpbmRpbmdQcm9wZXJ0eVtdKTogQ2xhc3NUeXBlPEJpbmRpbmdPYmplY3Q+IHtcclxuICAgIC8vIOe7p+aJv+WOn+e7keWumuWvueixoeaJgOacieWxnuaAp1xyXG4gICAgY29uc3QgYmluZGluZ09iamVjdFR5cGUgPSBjbGFzcyBCaW5kaW5nT2JqZWN0VHlwZSBleHRlbmRzIEJhc2VCaW5kaW5nT2JqZWN0IHtcclxuICAgICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgc3VwZXIoKTtcclxuICAgICAgICAvLyB0aGlzLmlubmVyVmFsdWVzID0gSW1tdXRhYmxlTWFwKE9iamVjdC5hc3NpZ24oe30sIGRhdGEpKTtcclxuXHJcbiAgICAgIH1cclxuICAgICAgLy8jZW5kcmVnaW9uIGxvYWRcclxuXHJcbiAgICAgIC8qXHJcbiAgICAgIHB1YmxpYyBsb2FkKGRhdGE6IGFueSkge1xyXG4gICAgICAgIC8vIGRhdGHljIXlkKvlpJror63lrZfmrrVcclxuICAgICAgICB0aGlzLmlubmVyVmFsdWVzID0gSW1tdXRhYmxlTWFwKE9iamVjdC5hc3NpZ24oe30sIGRhdGEpKTtcclxuICAgICAgICB0aGlzLnByb3BlcnRpZXMuZm9yRWFjaCgocHJvcGVydHk6IEJpbmRpbmdQcm9wZXJ0eSkgPT4ge1xyXG4gICAgICAgICAgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuTGlzdCkge1xyXG4gICAgICAgICAgICB0aGlzLmxvYWRMaXN0cyhwcm9wZXJ0eSk7XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuT2JqZWN0KSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9hZE9iamVjdHMocHJvcGVydHkpO1xyXG4gICAgICAgICAgfSBlbHNlIGlmIChwcm9wZXJ0eS50eXBlID09PSBCaW5kaW5nUHJvcGVydHlUeXBlLkR5bmFtaWMpIHtcclxuICAgICAgICAgICAgdGhpcy5sb2FkRHluYW1pY09iamVjdHMocHJvcGVydHkpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5sb2FkRmllbGRzKHByb3BlcnR5KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgICBwcml2YXRlIGxvYWRGaWVsZHMocHJvcGVydHk6IEJpbmRpbmdQcm9wZXJ0eSkge1xyXG4gICAgICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHByb3BlcnR5Lm5hbWU7XHJcbiAgICAgICAgY29uc3QgZGF0YUZpZWxkID0gcHJvcGVydHkuZGF0YUZpZWxkIHx8IHByb3BlcnR5TmFtZTtcclxuICAgICAgICBsZXQgdmFsdWU7XHJcbiAgICAgICAgaWYgKHByb3BlcnR5LmVuYWJsZU11bHRpTGFuZ0lucHV0KSB7XHJcbiAgICAgICAgICB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWUoZGF0YUZpZWxkLCBmYWxzZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHZhbHVlID0gdGhpcy5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzW3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTtcclxuICAgICAgfVxyXG4gICAgICBwcml2YXRlIGxvYWRMaXN0cyhwcm9wZXJ0eTogQmluZGluZ1Byb3BlcnR5KSB7XHJcbiAgICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gcHJvcGVydHkubmFtZTtcclxuICAgICAgICBjb25zdCBrZXkgPSBgXyR7cHJvcGVydHlOYW1lfV9gO1xyXG4gICAgICAgIGNvbnN0IGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCA9IHRoaXNba2V5XTtcclxuICAgICAgICBpZiAoYmluZGluZ0xpc3QpIHtcclxuICAgICAgICAgIGNvbnN0IGNoaWxkTGlzdFByb3BlcnRpZXMgPSBQcm9wZXJ0eVV0aWwuZ2V0UHJvcGVydGllcyhwcm9wZXJ0eS5lbnRpdHlUeXBlKTtcclxuICAgICAgICAgIGNvbnN0IGRhdGE6IGFueVtdID0gdGhpcy5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgaWYgKGRhdGEpIHtcclxuICAgICAgICAgICAgY29uc3QgYmluZGluZ09iamVjdHMgPSBkYXRhLm1hcChpdGVtID0+IHtcclxuICAgICAgICAgICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gQmluZGluZ09iamVjdFR5cGVGYWN0b3J5LmNyZWF0ZShjaGlsZExpc3RQcm9wZXJ0aWVzKTtcclxuICAgICAgICAgICAgICByZXR1cm4gYmluZGluZ09iamVjdDtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGJpbmRpbmdMaXN0LmxvYWQoYmluZGluZ09iamVjdHMpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBwcml2YXRlIGxvYWRPYmplY3RzKHByb3BlcnR5OiBCaW5kaW5nUHJvcGVydHkpIHtcclxuICAgICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eS5uYW1lO1xyXG4gICAgICAgIGNvbnN0IGtleSA9IGBfJHtwcm9wZXJ0eU5hbWV9X2A7XHJcbiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldFZhbHVlKHByb3BlcnR5TmFtZSkgfHwge307XHJcbiAgICAgICAgY29uc3QgY2hpbGRPYmplY3RQcm9wZXJ0aWVzID0gUHJvcGVydHlVdGlsLmdldFByb3BlcnRpZXMocHJvcGVydHkuZW50aXR5VHlwZSk7XHJcbiAgICAgICAgY29uc3QgYmluZGluZ09iamVjdCA9IEJpbmRpbmdPYmplY3RUeXBlRmFjdG9yeS5jcmVhdGUoY2hpbGRPYmplY3RQcm9wZXJ0aWVzKTtcclxuICAgICAgICB0aGlzW2tleV0gPSBiaW5kaW5nT2JqZWN0O1xyXG5cclxuICAgICAgfVxyXG4gICAgICBwcml2YXRlIGxvYWREeW5hbWljT2JqZWN0cyhwcm9wZXJ0eTogQmluZGluZ1Byb3BlcnR5KSB7XHJcbiAgICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gcHJvcGVydHkubmFtZTtcclxuICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWUocHJvcGVydHlOYW1lKSB8fCB7fTtcclxuICAgICAgICBjb25zdCBkeW5hbWljT2JqZWN0ID0gQmluZGluZ09iamVjdEZhY3RvcnkuY3JlYXRlRHluYW1pY0JpbmRpbmdPYmplY3QodmFsdWUpO1xyXG4gICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgICAgICAgIHZhbHVlOiBkeW5hbWljT2JqZWN0XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0qL1xyXG4gICAgICAvLyNlbmRyZWdpb25cclxuICAgIH07XHJcbiAgICAvLyDojrflj5bkuLvplK5cclxuICAgIGNvbnN0IHByaW1hcnlLZXkgPSBQcm9wZXJ0eVV0aWwuZ2V0UHJpbWFyeUtleShwcm9wZXJ0aWVzKTtcclxuICAgIC8vIOiuvue9ruS4u+mUrlxyXG4gICAgYmluZGluZ09iamVjdFR5cGUucHJvdG90eXBlLnByaW1hcnlLZXkgPSBwcmltYXJ5S2V5O1xyXG4gICAgYmluZGluZ09iamVjdFR5cGUucHJvdG90eXBlLnByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzO1xyXG4gICAgLy8g5bCG5bGe5oCn5omp5bGV5Yiw5Y6f5Z6L5a+56LGh5LiKXHJcbiAgICB0aGlzLmV4dGVuZFByb3BlcnRpZXMoYmluZGluZ09iamVjdFR5cGUucHJvdG90eXBlLCBwcm9wZXJ0aWVzKTtcclxuICAgIHJldHVybiBiaW5kaW5nT2JqZWN0VHlwZTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5omp5bGV5Y6f5Z6L5bGe5oCnXHJcbiAgICogQHBhcmFtIHR5cGVQcm90b3R5cGVcclxuICAgKiBAcGFyYW0gcHJvcGVydGllc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZFByb3BlcnRpZXModHlwZVByb3RvdHlwZTogQmFzZUJpbmRpbmdPYmplY3QsIHByb3BlcnRpZXM6IEJpbmRpbmdQcm9wZXJ0eVtdKSB7XHJcbiAgICAvLyDmianlsZVCaW5kaW5nT2JqZWN05bGe5oCnXHJcbiAgICBwcm9wZXJ0aWVzLmZvckVhY2goKHByb3BlcnR5OiBCaW5kaW5nUHJvcGVydHkpID0+IHtcclxuICAgICAgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuTGlzdCkge1xyXG4gICAgICAgIHRoaXMuZXh0ZW5kTGlzdFByb3BlcnR5KHR5cGVQcm90b3R5cGUsIHByb3BlcnR5KTtcclxuICAgICAgfSBlbHNlIGlmIChwcm9wZXJ0eS50eXBlID09PSBCaW5kaW5nUHJvcGVydHlUeXBlLk9iamVjdCkge1xyXG4gICAgICAgIHRoaXMuZXh0ZW5kT2JqZWN0UHJvcGVydHkodHlwZVByb3RvdHlwZSwgcHJvcGVydHkpO1xyXG4gICAgICB9IGVsc2UgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuRHluYW1pYykge1xyXG4gICAgICAgIHRoaXMuZXh0ZW5kRHluYW1pY09iamVjdFByb3BlcnR5KHR5cGVQcm90b3R5cGUsIHByb3BlcnR5KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLmV4dGVuZFBsYWluUHJvcGVydHkodHlwZVByb3RvdHlwZSwgcHJvcGVydHkpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5omp5bGV5Y6f5Z6L5YiX6KGo5bGe5oCnXHJcbiAgICogQHBhcmFtIHR5cGVQcm90b3R5cGVcclxuICAgKiBAcGFyYW0gcHJvcGVydHlcclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBleHRlbmRMaXN0UHJvcGVydHkodHlwZVByb3RvdHlwZTogQmFzZUJpbmRpbmdPYmplY3QsIHByb3BlcnR5OiBCaW5kaW5nUHJvcGVydHkpIHtcclxuICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHByb3BlcnR5Lm5hbWU7XHJcbiAgICBjb25zdCBjaGlsZExpc3RQcm9wZXJ0aWVzID0gUHJvcGVydHlVdGlsLmdldFByb3BlcnRpZXMocHJvcGVydHkuZW50aXR5VHlwZSk7XHJcbiAgICBjb25zdCBrZXkgPSBgXyR7cHJvcGVydHlOYW1lfV9gO1xyXG4gICAgLy8g5bCG5a2Q55qEQmluZGluZ0xpc3Tlrp7kvovotYvlgLznu5nlvZPliY3lsZ7mgKdcclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0eXBlUHJvdG90eXBlLCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgbGV0IGJpbmRpbmdMaXN0ID0gdGhpc1trZXldO1xyXG4gICAgICAgIGlmICghYmluZGluZ0xpc3QpIHtcclxuICAgICAgICAgIGJpbmRpbmdMaXN0ID0gQmluZGluZ0xpc3RGYWN0b3J5LmNyZWF0ZShjaGlsZExpc3RQcm9wZXJ0aWVzKTtcclxuICAgICAgICAgIHRoaXNba2V5XSA9IGJpbmRpbmdMaXN0O1xyXG4gICAgICAgICAgLy8g5Yqg6L295pWw5o2uXHJcbiAgICAgICAgICBjb25zdCBkYXRhOiBhbnlbXSA9IHRoaXMuZ2V0VmFsdWUocHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgIGlmIChkYXRhKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3RzID0gZGF0YS5tYXAoKGl0ZW0pID0+IHtcclxuICAgICAgICAgICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gQmluZGluZ09iamVjdFR5cGVGYWN0b3J5LmNyZWF0ZShjaGlsZExpc3RQcm9wZXJ0aWVzKTtcclxuICAgICAgICAgICAgICByZXR1cm4gYmluZGluZ09iamVjdDtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGJpbmRpbmdMaXN0LmxvYWQoYmluZGluZ09iamVjdHMpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgLy8g5oyH5a6a5a2QTGlzdOeahHBhcmVudOOAgeebkeWQrOWtkExpc3TnmoRjaGFuZ2Vz5LqL5Lu2XHJcbiAgICAgICAgICBiaW5kaW5nTGlzdC5wYXJlbnQgPSB0aGlzO1xyXG4gICAgICAgICAgYmluZGluZ0xpc3QuY2hhbmdlcy5zdWJzY3JpYmUoKGNoYW5nZTogQ2hhbmdlKSA9PiB7XHJcbiAgICAgICAgICAgIGNoYW5nZS5wYXRoLnVuc2hpZnQocHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgICAgY2hhbmdlLmlzQmluZGluZ0xpc3RUcmFuc21pdGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhpcy5jaGFuZ2VzLm5leHQoY2hhbmdlKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYmluZGluZ0xpc3Q7XHJcbiAgICAgIH0sXHJcbiAgICAgIHNldDogZnVuY3Rpb24gKGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCkge1xyXG4gICAgICAgIHRoaXNba2V5XSA9IGJpbmRpbmdMaXN0O1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5omp5bGV5Y6f5Z6L5a+56LGh5bGe5oCnXHJcbiAgICogQHBhcmFtIHR5cGVQcm90b3R5cGVcclxuICAgKiBAcGFyYW0gcHJvcGVydHlcclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBleHRlbmRPYmplY3RQcm9wZXJ0eSh0eXBlUHJvdG90eXBlOiBCYXNlQmluZGluZ09iamVjdCwgcHJvcGVydHk6IEJpbmRpbmdQcm9wZXJ0eSk6IHZvaWQge1xyXG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gcHJvcGVydHkubmFtZTtcclxuICAgIGNvbnN0IGNoaWxkT2JqZWN0UHJvcGVydGllcyA9IFByb3BlcnR5VXRpbC5nZXRQcm9wZXJ0aWVzKHByb3BlcnR5LmVudGl0eVR5cGUpO1xyXG4gICAgY29uc3Qga2V5ID0gYF8ke3Byb3BlcnR5TmFtZX1fYDtcclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0eXBlUHJvdG90eXBlLCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgbGV0IGJpbmRpbmdPYmplY3QgPSB0aGlzW2tleV07XHJcbiAgICAgICAgaWYgKCFiaW5kaW5nT2JqZWN0KSB7XHJcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWUocHJvcGVydHlOYW1lKSB8fCB7fTtcclxuICAgICAgICAgIGJpbmRpbmdPYmplY3QgPSBCaW5kaW5nT2JqZWN0VHlwZUZhY3RvcnkuY3JlYXRlKGNoaWxkT2JqZWN0UHJvcGVydGllcyk7XHJcbiAgICAgICAgICB0aGlzW2tleV0gPSBiaW5kaW5nT2JqZWN0O1xyXG4gICAgICAgICAgLy8g5oyH5a6a5a2QT2JqZWN055qEcGFyZW5044CB55uR5ZCs5a2QT2JqZWN055qEY2hhbmdlc+S6i+S7tlxyXG4gICAgICAgICAgYmluZGluZ09iamVjdC5wYXJlbnQgPSB0aGlzO1xyXG4gICAgICAgICAgYmluZGluZ09iamVjdC5jaGFuZ2VzLnN1YnNjcmliZSgoY2hhbmdlOiBDaGFuZ2UpID0+IHtcclxuICAgICAgICAgICAgY2hhbmdlLnBhdGgudW5zaGlmdChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgICB0aGlzLmNoYW5nZXMubmV4dChjaGFuZ2UpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBiaW5kaW5nT2JqZWN0O1xyXG4gICAgICB9LFxyXG4gICAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZTogQmFzZUJpbmRpbmdPYmplY3QpIHtcclxuICAgICAgICB0aGlzW2tleV0gPSB2YWx1ZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJqeWxleWOn+Wei+WKqOaAgeWxnuaAp1xyXG4gICAqIEBwYXJhbSB0eXBlUHJvdG90eXBlXHJcbiAgICogQHBhcmFtIHByb3BlcnR5XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGF0aWMgZXh0ZW5kRHluYW1pY09iamVjdFByb3BlcnR5KHR5cGVQcm90b3R5cGU6IEJhc2VCaW5kaW5nT2JqZWN0LCBwcm9wZXJ0eTogQmluZGluZ1Byb3BlcnR5KTogdm9pZCB7XHJcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eS5uYW1lO1xyXG4gICAgLy8gT2JqZWN0LmRlZmluZVByb3BlcnR5KHR5cGVQcm90b3R5cGUsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgLy8gICB2YWx1ZTogbnVsbFxyXG4gICAgLy8gfSk7XHJcbiAgICB0eXBlUHJvdG90eXBlW3Byb3BlcnR5TmFtZV0gPSBudWxsO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmianlsZXljp/lnovnroDljZXlsZ7mgKdcclxuICAgKiBAcGFyYW0gdHlwZVByb3RvdHlwZVxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eVxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZFBsYWluUHJvcGVydHkodHlwZVByb3RvdHlwZTogQmFzZUJpbmRpbmdPYmplY3QsIHByb3BlcnR5OiBCaW5kaW5nUHJvcGVydHkpOiB2b2lkIHtcclxuICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHByb3BlcnR5Lm5hbWU7XHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodHlwZVByb3RvdHlwZSwgcHJvcGVydHlOYW1lLCB7XHJcbiAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmIChwcm9wZXJ0eS5lbmFibGVNdWx0aUxhbmdJbnB1dCA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUsIGZhbHNlKTtcclxuICAgICAgICAgIGlmICghdmFsdWUpIHtcclxuICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmdldFZhbHVlKHByb3BlcnR5TmFtZSwgZmFsc2UpO1xyXG4gICAgICAgICAgICBjb25zdCBsYW5nQ29kZSA9IFRyYW5zbGF0ZVNlcnZpY2UuZ2V0Q3VycmVudExhbmd1YWdlKCk7XHJcbiAgICAgICAgICAgIHJldHVybiB7IFtsYW5nQ29kZV06IHZhbHVlIH07XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWU6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpcy5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgIGlmICh2YWx1ZSA9PT0gb2xkVmFsdWUpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5zZXRWYWx1ZShwcm9wZXJ0eU5hbWUsIHZhbHVlLCB0cnVlLCB0cnVlKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlue8k+WtmOeahGJpbmRpbmdMaXN05qih5p2/57G7XHJcbiAgICogQHBhcmFtIHByb3BlcnRpZXMgYmluZGluZ0xpc3TlsZ7mgKdcclxuICAgKiBAcmV0dXJuc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIGdldFR5cGUocHJvcGVydGllczogQmluZGluZ1Byb3BlcnR5W10pOiBUeXBlPEJpbmRpbmdPYmplY3Q+IHtcclxuICAgIGlmICh0aGlzLnByb3ZpZGVyLmhhcyhwcm9wZXJ0aWVzKSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5wcm92aWRlci5nZXQocHJvcGVydGllcyk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBiaW5kaW5nT2JqZWN0VHlwZSA9IHRoaXMuY3JlYXRlVHlwZShwcm9wZXJ0aWVzKTtcclxuICAgIHRoaXMucHJvdmlkZXIuc2V0KHByb3BlcnRpZXMsIGJpbmRpbmdPYmplY3RUeXBlKTtcclxuICAgIHJldHVybiBiaW5kaW5nT2JqZWN0VHlwZTtcclxuICB9XHJcbn1cclxuIl19