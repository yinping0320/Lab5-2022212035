import { PARENT_CLASS, FieldMetadataUtil } from '../entity/index';
import { ModifyType } from '../changeset/index';
import { ChangeType } from './changes';
import { BindingPropertyType } from './binding_property';
import { BindingObjectFactory } from './binding_object_factory';
import { Form } from '../form/index';
import { takeUntil } from 'rxjs/operators';
/**
 * 实体操作工具类
 */
class EntityUtil {
    /**
     * 将entity的数据加载到bindingObject中，并保持两者同步。
     * @param entity        实体对象
     * @param bindingObject 绑定对象
     */
    static loadEntity(entity, bindingObject) {
        // 遍历bindingObject的properties进行赋值
        bindingObject.properties.forEach((property) => {
            const propertyName = property.name;
            if (property.type === BindingPropertyType.List) {
                this.loadEntityList(entity[propertyName] || entity[PARENT_CLASS], bindingObject[propertyName]);
            }
            else if (property.type === BindingPropertyType.Object) {
                if (entity && entity[propertyName] && this.isEffectiveField(entity, propertyName)) {
                    this.loadEntity(entity[propertyName], bindingObject[propertyName]);
                }
            }
            else if (property.type === BindingPropertyType.Dynamic) {
                if (entity && entity[propertyName]) {
                    const dynamicObject = BindingObjectFactory.createDynamicBindingObject(entity[propertyName].data);
                    BindingObjectFactory.attachDynamicObjectProperty(bindingObject, propertyName, dynamicObject);
                    this.loadEntity(entity[propertyName], bindingObject[propertyName]);
                }
            }
            else {
                if (this.isEffectiveField(entity, propertyName)) {
                    const value = entity[propertyName];
                    bindingObject.setValue(propertyName, value, false, false);
                }
            }
        });
        this.setUpEntityPipeline(entity, bindingObject);
    }
    /**
     * 建立entity和bindingObject之间的关联
     * @param entity        实体对象
     * @param bindingObject 绑定对象
     */
    static setUpEntityPipeline(entity, bindingObject) {
        if (!entity || !bindingObject) {
            return;
        }
        // 监听entity变更
        entity.onValueChanged.pipe(takeUntil(entity.unsubscribe)).subscribe((modification) => {
            if (modification.type !== ModifyType.ValueChange || modification.path.length === 0 || modification.fromParent === true) {
                return;
            }
            const propertyName = modification.path[modification.path.length - 1];
            const primaryKeyPath = modification.path[modification.path.length - 2];
            // 验证主键是否匹配
            // 存在主键并且主键不是id时才检查（值对象、关联对象不检查）
            if (bindingObject.primaryKey && bindingObject.primaryKey === 'id') {
                const primaryKey = bindingObject.primaryKey;
                const primaryKeyValue = bindingObject.getValue(primaryKey);
                if (primaryKeyPath !== `${primaryKey}:${primaryKeyValue}`) {
                    return;
                }
            }
            // TODO:修复动态列不触发变更的问题，临时方案，应该有单独的dynamicBindingObject类
            if (modification.dynamic) {
                if (bindingObject['__original__']) {
                    return;
                }
                const value = modification.value;
                const target = bindingObject[propertyName];
                if (!target) {
                    return;
                }
                Object.keys(value).forEach((key) => {
                    if (target.getValue(key) === value[key]) {
                        return;
                    }
                    target.setValue(key, value[key], true, false);
                });
            }
            else {
                // 值没有发生变化，不再设置
                // TODO: 通过bindingObject修改entity属性值时，entity总会触发一个变更回来，如果不截获这个重复的变更，会导致重复或死循环
                if (bindingObject.getValue(propertyName) === modification.value) {
                    return;
                }
                bindingObject.setValue(propertyName, modification.value, true, false, modification.errors);
            }
        });
        // 监听bindingObject变更
        bindingObject.viewChanges.pipe(takeUntil(bindingObject.unsubscribe)).subscribe((viewChange) => {
            const value = viewChange.value;
            const propertyName = viewChange.path[0];
            let pathPrefix = '';
            const pathData = entity.getPaths();
            const paths = pathData.path;
            let id = bindingObject['id'];
            bindingObject['__original__'] = true;
            // if (pathData.isUdt) {
            // grid中udt没有id，从父级中取出id，以便存放验证信息
            const getParentId = (target) => {
                let parentId = '';
                const findId = (item) => {
                    if (item && item && item['id']) {
                        parentId = item['id'];
                        return;
                    }
                    else if (item['parent']) {
                        findId(item['parent']);
                    }
                };
                findId(target);
                return parentId;
            };
            id = getParentId(bindingObject);
            // if (pathData.isGrid) {
            //   // grid 将从表主字段去除
            //   paths.pop();
            // }
            if (paths.length) {
                pathPrefix = paths.join('.') + '.';
            }
            // }
            const controlProp = pathPrefix + propertyName;
            // 调用实体验证，并将错误信息合并到formControl上
            const entityValidate = (callback) => {
                const enableValidate = Object.values(Form.insMap).find(item => item && item.enableValidate);
                if (!enableValidate) {
                    if (typeof callback === 'function') {
                        callback(null);
                    }
                    return;
                }
                entity.validateFromUtilSync(propertyName, value, result => {
                    const errorObj = {};
                    if (result.errors && result.errors.length > 0) {
                        result.errors.forEach((error) => {
                            if (error.constraints) {
                                Object.keys(error.constraints).forEach(key => {
                                    errorObj[key] = {
                                        value: value,
                                        name: error.constraints[key],
                                        error: error
                                    };
                                });
                            }
                        });
                    }
                    // 先设置实体验证信息，再设置form验证信息，然后在form.isFormValid内部整合实体验证form验证信息
                    Form.updateErrors(controlProp, errorObj, id, value, pathData.isGrid);
                    const formErrors = viewChange['errors'] || {};
                    const mergedErrors = Object.assign({}, formErrors, errorObj);
                    let validateError = null;
                    if (Object.keys(mergedErrors).length > 0) {
                        validateError = { [propertyName]: mergedErrors };
                    }
                    if (typeof (callback) === 'function') {
                        callback(validateError);
                    }
                }, viewChange.context);
            };
            // 不是主键值字段时，要先检查主键是否存在，并且主键是否相等（防止后代变更冒泡上来）
            // 非主键属性变更时，要先检查主键是否匹配（如果主键也修改了，要求先修改主键再修改其他值）
            if (bindingObject.primaryKey) {
                const primaryKey = bindingObject.primaryKey;
                if (propertyName !== primaryKey) {
                    if (!entity[primaryKey] || entity[primaryKey] !== bindingObject[primaryKey]) {
                        entityValidate();
                        return;
                    }
                }
                else if (entity[propertyName] !== value) {
                    // todo: 因异步校验未结束实体主键没有被赋值，导致实体其他属性无法赋值，待后续前端校验重构时去掉
                    entity[propertyName] = value;
                    entityValidate();
                    return;
                }
            }
            // 如果BindingObject上的属性值和Entity上对应属性值一样，则不再设置
            if (entity[propertyName] === value) {
                entityValidate();
                return;
            }
            // 调用表单验证,通过后调用实体验证
            // bingdingObject变化后，先调用实体上的验证，通过后再设置实体的变动
            entityValidate((errors) => {
                entity.errors = errors;
                entity[propertyName] = value;
            });
        });
    }
    /**
     * 将entityList中的Entity对象转换为BindingObject对象，加载到bindingList中，并保持entityList和bindingList同步。
     * @param entityList  实体列表
     * @param bindingList 绑定列表
     */
    static loadEntityList(entityList, bindingList) {
        this.loadEntities(entityList.items, bindingList);
        this.setUpEntityListPipeline(entityList, bindingList);
    }
    /**
     * 建立entityList和bindingList之间的关联
     * @param entityList  实体列表
     * @param bindingList 绑定列表
     */
    static setUpEntityListPipeline(entityList, bindingList) {
        entityList.onListChanged.subscribe((modification) => {
            const target = modification['target'];
            if (target && target !== entityList) {
                return;
            }
            switch (modification.type) {
                // 添加实体
                case ModifyType.Add:
                case ModifyType.Clone:
                    {
                        const entitiesToAdd = modification.value;
                        if (entitiesToAdd.length === 0) {
                            return;
                        }
                        // 检查父id是否一致，冒泡导致的变更不处理
                        const paths = modification.path;
                        const parentPath = paths[paths.length - 2];
                        const parentId = bindingList.parent.primaryKeyValue;
                        if (parentPath.indexOf(parentId) === -1) {
                            return;
                        }
                        this.appendEntities(modification.value, bindingList, modification.type === ModifyType.Clone);
                    }
                    break;
                case ModifyType.Insert:
                    {
                        // 检查父id是否一致，冒泡导致的变更不处理
                        const paths = modification.path;
                        const parentPath = paths[paths.length - 2];
                        const parentId = bindingList.parent.primaryKeyValue;
                        const position = modification.position;
                        if (parentPath.indexOf(parentId) === -1) {
                            return;
                        }
                        this.insertEntity(modification.value[0], bindingList, position);
                    }
                    break;
                // 删除实体
                case ModifyType.Remove:
                    {
                        // 检查父id是否一致，冒泡导致的变更不处理
                        const paths = modification.path;
                        const parentPath = paths[paths.length - 2];
                        const parentId = bindingList.parent.primaryKeyValue;
                        if (parentPath.indexOf(parentId) === -1) {
                            return;
                        }
                        // 删除实体（value格式待商榷，目前value的格式为 { primaryKey: primaryValue}）
                        const id = modification.value[bindingList.primaryKey];
                        bindingList.removeByIds([id]);
                        // this.removeEntities(<Entity[]>modification.value, bindingList);
                    }
                    break;
                // 加载实体
                case ModifyType.Load:
                    // 检查父id是否一致，冒泡导致的变更不处理
                    const paths = modification.path;
                    const parentPath = paths[paths.length - 2];
                    const parentId = bindingList.parent.primaryKeyValue;
                    if (parentPath.indexOf(parentId) === -1) {
                        return;
                    }
                    const entities = modification.value;
                    this.loadEntities(entities, bindingList);
                    break;
                default:
                    break;
            }
        });
    }
    /**
     * 监听repository变化，保持repository和bindingList同步。
     * @param repository  实体仓库
     * @param bindingList 绑定列表
     */
    static loadRepository(repository, bindingList) {
        // 初次加载
        const entities = Array.from(repository.entityCollection.toArray());
        this.loadEntities(entities, bindingList);
        // 监听变化
        repository.entityCollectionChange.pipe(takeUntil(repository.destroy$)).subscribe((modification) => {
            switch (modification.type) {
                case ModifyType.Load:
                    bindingList.clear(true);
                    this.loadEntities(modification.value, bindingList, modification.entityCreate);
                    break;
                case ModifyType.Add:
                case ModifyType.Clone:
                    this.appendEntities(modification.value, bindingList, modification.type === ModifyType.Clone, { isTreeNodeLoadScene: modification.isTreeNodeLoadScene });
                    break;
                case ModifyType.AddData:
                    this.addData(modification.value, bindingList, { isTreeNodeLoadScene: modification.isTreeNodeLoadScene });
                    break;
                case ModifyType.Insert:
                    this.insertEntity(modification.value, bindingList, modification.position);
                    break;
                case ModifyType.Remove:
                    this.removeEntities(modification.value, bindingList);
                    break;
                case ModifyType.RemoveData:
                    this.removeData(modification.value, bindingList);
                    break;
                case ModifyType.PaginationInfoChange:
                    // 分页信息无需同步到bindingList，放到bindingData即可。保留此处只是为了兼容产品部可能使用bindingList上分页信息的场景
                    bindingList.paginationInfo = modification.value;
                    break;
                default:
                    break;
            }
        });
        // 监听BindingList数据变化
        bindingList.changes.pipe(takeUntil(bindingList.destroy$)).subscribe((change) => {
            if (change.type === ChangeType.PaginationInfoChange) {
                const entityCollection = repository.entityCollection;
                // const entityTypeName = entityCollection.entityTypeName;
                // const original = entityCollection.paginationInfo[entityTypeName];
                // const entityPaginationInfo = Object.assign({}, original, change.value);
                entityCollection.paginationInfo = Object.assign({}, entityCollection.paginationInfo, change.value);
            }
        });
    }
    /**
     * 将entities中的Entity对象转换为BindingObject对象，并加载到bindingList中
     * @param entities    实体数组
     * @param bindingList 绑定列表
     */
    static loadEntities(entities, bindingList, entityCreate = false) {
        const bindingObjects = this.createBindingObjects(entities, bindingList);
        bindingList.load(bindingObjects, entityCreate);
    }
    /**
     * 将entities中的Entity对象转换为BIndingObject对象，并追加到bindingList中
     * @param entities    实体数组
     * @param bindingList 绑定列表
     * @param isCloned 是否克隆数据
     * @param options 上下文
     */
    static appendEntities(entities, bindingList, isCloned = false, options = null) {
        const bindingObjects = this.createBindingObjects(entities, bindingList);
        bindingList.append(bindingObjects, isCloned, options);
    }
    /**
     * 是否是有效的字段
     * @param entity 实体
     * @param propertyName 字段
     * @returns
     */
    static isEffectiveField(entity, propertyName) {
        if (!entity || !propertyName) {
            return false;
        }
        propertyName = propertyName.toLowerCase();
        if (entity['__farris_effective_fields__']) {
            return entity['__farris_effective_fields__'].includes(propertyName);
        }
        if (entity['farris_effective_fields'] && typeof entity['farris_effective_fields'] === 'string') {
            const effectiveFields = entity['farris_effective_fields'].split(',').filter(p => p).map(item => item.toLowerCase());
            entity['__farris_effective_fields__'] = effectiveFields;
            return effectiveFields.includes(propertyName);
        }
        return true;
    }
    /**
     * 增加实体数据（不切换当前行）
     * @param entities
     * @param bindingList
     */
    static addData(entities, bindingList, options = null) {
        const bindingObjects = this.createBindingObjects(entities, bindingList);
        bindingList.addData(bindingObjects, options);
    }
    static insertEntity(entity, bindingList, position) {
        const bindingObject = this.createBindingObject(entity, bindingList);
        bindingList.insert(bindingObject, position);
    }
    /**
     * 从bindingList移除entities对应的BindingObject对象
     * @param entities    实体数组
     * @param bindingList 绑定列表
     */
    static removeEntities(entities, bindingList) {
        if (entities === null || entities.length === 0) {
            return;
        }
        // 归集要删除的id数组
        const primaryKey = bindingList.primaryKey;
        const ids = [];
        entities.forEach((entity) => {
            ids.push(entity[primaryKey]);
        });
        bindingList.removeByIds(ids);
    }
    static removeData(entities, bindingList) {
        if (entities === null || entities.length === 0) {
            return;
        }
        // 归集要删除的id数组
        const primaryKey = bindingList.primaryKey;
        const ids = [];
        entities.forEach((entity) => {
            ids.push(entity[primaryKey]);
        });
        bindingList.removeDataByIds(ids);
    }
    /**
     * 将entities中的Entity对象转换为BindingObject对象
     * @param entities    实体数组
     * @param bindingList 绑定列表
     */
    static createBindingObjects(entities, bindingList) {
        if (entities === null || entities.length === 0) {
            return [];
        }
        const bindingObjects = [];
        entities.forEach((entity) => {
            const bindingObject = BindingObjectFactory.create(bindingList.properties, true);
            // bindingObject['_ENTITY_'] = entity;
            this.loadEntity(entity, bindingObject);
            // // 为bindingObject设置默认值initialData属性
            // if (entity['initialData']) {
            //   bindingObject['initialData'] = entity['initialData'];
            // }
            bindingObjects.push(bindingObject);
        });
        return bindingObjects;
    }
    static createBindingObject(entity, bindingList) {
        const bindingObject = BindingObjectFactory.create(bindingList.properties, true);
        this.loadEntity(entity, bindingObject);
        return bindingObject;
    }
    static watchReposiroty(repository, bindingData) {
        // reposiroty => bindingData
        repository.entityCollectionChange.subscribe((modification) => {
            switch (modification.type) {
                case ModifyType.PaginationInfoChange:
                    bindingData.pagingInfo = modification.value;
                    break;
                default:
                    break;
            }
        });
    }
    /**
     * 查找属性的类型
     * @param entityType 实体类型
     * @param targetPropName 属性名称
     * @return 属性信息，包含属性类型（NgField、NgObject、NgList）和属性对应的实体类型（当NgField类型时为null）
     */
    static getPropInfo(entityType, targetPropName) {
        let propType;
        let propEntityType;
        // NgField
        const ngFieldProperties = FieldMetadataUtil.getNgFields(entityType);
        Object.keys(ngFieldProperties).forEach((propName) => {
            if (propName === targetPropName) {
                propType = 'NgField';
                propEntityType = null;
            }
        });
        // NgObject
        const ngObjectProperties = FieldMetadataUtil.getNgObjects(entityType);
        Object.keys(ngObjectProperties).forEach((propName) => {
            if (propName === targetPropName) {
                propType = 'NgObject';
                propEntityType = ngObjectProperties[propName].type;
            }
        });
        // NgList
        const ngListProperties = FieldMetadataUtil.getNgList(entityType);
        Object.keys(ngListProperties).forEach((propName) => {
            if (propName === targetPropName) {
                propType = 'NgList';
                propEntityType = ngListProperties[propName].type;
            }
        });
        const ngDynamicProperties = FieldMetadataUtil.getNgDynamic(entityType);
        Object.keys(ngDynamicProperties).forEach((propName) => {
            if (propName === targetPropName) {
                propType = 'NgDynamic';
                propEntityType = ngDynamicProperties[propName].type;
            }
        });
        return { propType, propEntityType };
    }
    /**
     * 获取实体的主键名
     * @param entityType 实体类型
     */
    static getPrimaryKey(entityType) {
        const primaryNgFiledProp = FieldMetadataUtil.getPrimaryFieldMetadata(entityType);
        if (primaryNgFiledProp) {
            return primaryNgFiledProp.dataField;
        }
        else {
            return '';
        }
    }
    /**
     * 是否为对象属性
     */
    static isObjectProp(entityType, targetPropName) {
        let isObjectProp = false;
        const ngObjectProperties = FieldMetadataUtil.getNgObjects(entityType);
        Object.keys(ngObjectProperties).forEach((propName) => {
            if (propName === targetPropName) {
                isObjectProp = true;
            }
        });
        return isObjectProp;
    }
    /**
     * 检查是否是动态列属性
     */
    static isDynamicProp(entityType, targetPropName) {
        let isDynamicProp = false;
        const ngDynamicProperties = FieldMetadataUtil.getNgDynamic(entityType);
        Object.keys(ngDynamicProperties).forEach((propName) => {
            if (propName === targetPropName) {
                isDynamicProp = true;
            }
        });
        return isDynamicProp;
    }
    /**
     * 为实体增加initialData属性
     * @param entity 实体实例
     * @param initialData 默认值对象
     */
    static appendInitialData(entity, initialData) {
        const data = Object.assign({}, initialData);
        delete data.id;
        delete data.parentID;
        entity['initialData'] = data;
    }
}
export { EntityUtil };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X3V0aWwuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9iaW5kaW5nLWRhdGEvZW50aXR5X3V0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFzQixZQUFZLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN0RixPQUFPLEVBQWdCLFVBQVUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzlELE9BQU8sRUFBc0IsVUFBVSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRzNELE9BQU8sRUFBbUIsbUJBQW1CLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMxRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBR3JDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUUzQzs7R0FFRztBQUNILE1BQU0sVUFBVTtJQUVkOzs7O09BSUc7SUFDSCxNQUFNLENBQUMsVUFBVSxDQUFDLE1BQWMsRUFBRSxhQUE0QjtRQUM1RCxpQ0FBaUM7UUFDakMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUF5QixFQUFFLEVBQUU7WUFDN0QsTUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQztZQUNuQyxJQUFJLFFBQVEsQ0FBQyxJQUFJLEtBQUssbUJBQW1CLENBQUMsSUFBSSxFQUFFO2dCQUM5QyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLEVBQUUsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7YUFDaEc7aUJBQU0sSUFBSSxRQUFRLENBQUMsSUFBSSxLQUFLLG1CQUFtQixDQUFDLE1BQU0sRUFBRTtnQkFDdkQsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFD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QyxDQUFDLFFBQWdCLEVBQUUsRUFBRTtZQUMzRCxJQUFJLFFBQVEsS0FBSyxjQUFjLEVBQUU7Z0JBQy9CLFlBQVksR0FBRyxJQUFJLENBQUM7YUFDckI7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sWUFBWSxDQUFDO0lBQ3RCLENBQUM7SUFFRDs7T0FFRztJQUNILE1BQU0sQ0FBQyxhQUFhLENBQUMsVUFBZSxFQUFFLGNBQXNCO1FBQzFELElBQUksYUFBYSxHQUFHLEtBQUssQ0FBQztRQUMxQixNQUFNLG1CQUFtQixHQUFHLGlCQUFpQixDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN2RSxNQUFNLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBZ0IsRUFBRSxFQUFFO1lBQzVELElBQUksUUFBUSxLQUFLLGNBQWMsRUFBRTtnQkFDL0IsYUFBYSxHQUFHLElBQUksQ0FBQzthQUN0QjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxhQUFhLENBQUM7SUFDdkIsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxNQUFNLENBQUMsaUJBQWlCLENBQUMsTUFBTSxFQUFFLFdBQVc7UUFDMUMsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDNUMsT0FBTyxJQUFJLENBQUMsRUFBRSxDQUFDO1FBQ2YsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQ3JCLE1BQU0sQ0FBQyxhQUFhLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDL0IsQ0FBQztDQUNGO0FBRUQsT0FBTyxFQUFFLFVBQVUsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVwb3NpdG9yeSB9IGZyb20gJy4uL3JlcG9zaXRvcnkvaW5kZXgnO1xyXG5pbXBvcnQgeyBFbnRpdHksIEVudGl0eUxpc3QsIFBBUkVOVF9DTEFTUywgRmllbGRNZXRhZGF0YVV0aWwgfSBmcm9tICcuLi9lbnRpdHkvaW5kZXgnO1xyXG5pbXBvcnQgeyBNb2RpZmljYXRpb24sIE1vZGlmeVR5cGUgfSBmcm9tICcuLi9jaGFuZ2VzZXQvaW5kZXgnO1xyXG5pbXBvcnQgeyBWaWV3Q2hhbmdlLCBDaGFuZ2UsIENoYW5nZVR5cGUgfSBmcm9tICcuL2NoYW5nZXMnO1xyXG5pbXBvcnQgeyBCaW5kaW5nTGlzdCB9IGZyb20gJy4vYmluZGluZ19saXN0JztcclxuaW1wb3J0IHsgQmluZGluZ09iamVjdCB9IGZyb20gJy4vYmluZGluZ19vYmplY3QnO1xyXG5pbXBvcnQgeyBCaW5kaW5nUHJvcGVydHksIEJpbmRpbmdQcm9wZXJ0eVR5cGUgfSBmcm9tICcuL2JpbmRpbmdfcHJvcGVydHknO1xyXG5pbXBvcnQgeyBCaW5kaW5nT2JqZWN0RmFjdG9yeSB9IGZyb20gJy4vYmluZGluZ19vYmplY3RfZmFjdG9yeSc7XHJcbmltcG9ydCB7IEZvcm0gfSBmcm9tICcuLi9mb3JtL2luZGV4JztcclxuaW1wb3J0IHsgUGFnaW5hdGlvbiB9IGZyb20gJy4uL2NvcmUnO1xyXG5pbXBvcnQgeyBCaW5kaW5nRGF0YSB9IGZyb20gJy4vYmluZGluZ19kYXRhJztcclxuaW1wb3J0IHsgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuLyoqXHJcbiAqIOWunuS9k+aTjeS9nOW3peWFt+exu1xyXG4gKi9cclxuY2xhc3MgRW50aXR5VXRpbCB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOWwhmVudGl0eeeahOaVsOaNruWKoOi9veWIsGJpbmRpbmdPYmplY3TkuK3vvIzlubbkv53mjIHkuKTogIXlkIzmraXjgIJcclxuICAgKiBAcGFyYW0gZW50aXR5ICAgICAgICDlrp7kvZPlr7nosaFcclxuICAgKiBAcGFyYW0gYmluZGluZ09iamVjdCDnu5Hlrprlr7nosaFcclxuICAgKi9cclxuICBzdGF0aWMgbG9hZEVudGl0eShlbnRpdHk6IEVudGl0eSwgYmluZGluZ09iamVjdDogQmluZGluZ09iamVjdCkge1xyXG4gICAgLy8g6YGN5Y6GYmluZGluZ09iamVjdOeahHByb3BlcnRpZXPov5vooYzotYvlgLxcclxuICAgIGJpbmRpbmdPYmplY3QucHJvcGVydGllcy5mb3JFYWNoKChwcm9wZXJ0eTogQmluZGluZ1Byb3BlcnR5KSA9PiB7XHJcbiAgICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHByb3BlcnR5Lm5hbWU7XHJcbiAgICAgIGlmIChwcm9wZXJ0eS50eXBlID09PSBCaW5kaW5nUHJvcGVydHlUeXBlLkxpc3QpIHtcclxuICAgICAgICB0aGlzLmxvYWRFbnRpdHlMaXN0KGVudGl0eVtwcm9wZXJ0eU5hbWVdIHx8IGVudGl0eVtQQVJFTlRfQ0xBU1NdLCBiaW5kaW5nT2JqZWN0W3Byb3BlcnR5TmFtZV0pO1xyXG4gICAgICB9IGVsc2UgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuT2JqZWN0KSB7XHJcbiAgICAgICAgaWYgKGVudGl0eSAmJiBlbnRpdHlbcHJvcGVydHlOYW1lXSAmJiB0aGlzLmlzRWZmZWN0aXZlRmllbGQoZW50aXR5LCBwcm9wZXJ0eU5hbWUpKSB7XHJcbiAgICAgICAgICB0aGlzLmxvYWRFbnRpdHkoZW50aXR5W3Byb3BlcnR5TmFtZV0sIGJpbmRpbmdPYmplY3RbcHJvcGVydHlOYW1lXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2UgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuRHluYW1pYykge1xyXG4gICAgICAgIGlmIChlbnRpdHkgJiYgZW50aXR5W3Byb3BlcnR5TmFtZV0pIHtcclxuICAgICAgICAgIGNvbnN0IGR5bmFtaWNPYmplY3QgPSBCaW5kaW5nT2JqZWN0RmFjdG9yeS5jcmVhdGVEeW5hbWljQmluZGluZ09iamVjdChlbnRpdHlbcHJvcGVydHlOYW1lXS5kYXRhKTtcclxuICAgICAgICAgIEJpbmRpbmdPYmplY3RGYWN0b3J5LmF0dGFjaER5bmFtaWNPYmplY3RQcm9wZXJ0eShiaW5kaW5nT2JqZWN0LCBwcm9wZXJ0eU5hbWUsIGR5bmFtaWNPYmplY3QpO1xyXG4gICAgICAgICAgdGhpcy5sb2FkRW50aXR5KGVudGl0eVtwcm9wZXJ0eU5hbWVdLCBiaW5kaW5nT2JqZWN0W3Byb3BlcnR5TmFtZV0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAodGhpcy5pc0VmZmVjdGl2ZUZpZWxkKGVudGl0eSwgcHJvcGVydHlOYW1lKSkge1xyXG4gICAgICAgICAgY29uc3QgdmFsdWUgPSBlbnRpdHlbcHJvcGVydHlOYW1lXTtcclxuICAgICAgICAgIGJpbmRpbmdPYmplY3Quc2V0VmFsdWUocHJvcGVydHlOYW1lLCB2YWx1ZSwgZmFsc2UsIGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMuc2V0VXBFbnRpdHlQaXBlbGluZShlbnRpdHksIGJpbmRpbmdPYmplY3QpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bu656uLZW50aXR55ZKMYmluZGluZ09iamVjdOS5i+mXtOeahOWFs+iBlFxyXG4gICAqIEBwYXJhbSBlbnRpdHkgICAgICAgIOWunuS9k+WvueixoVxyXG4gICAqIEBwYXJhbSBiaW5kaW5nT2JqZWN0IOe7keWumuWvueixoVxyXG4gICAqL1xyXG4gIHN0YXRpYyBzZXRVcEVudGl0eVBpcGVsaW5lKGVudGl0eTogRW50aXR5LCBiaW5kaW5nT2JqZWN0OiBCaW5kaW5nT2JqZWN0KSB7XHJcbiAgICBpZiAoIWVudGl0eSB8fCAhYmluZGluZ09iamVjdCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDnm5HlkKxlbnRpdHnlj5jmm7RcclxuICAgIGVudGl0eS5vblZhbHVlQ2hhbmdlZC5waXBlKHRha2VVbnRpbChlbnRpdHkudW5zdWJzY3JpYmUpKS5zdWJzY3JpYmUoKG1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSA9PiB7XHJcbiAgICAgIGlmIChtb2RpZmljYXRpb24udHlwZSAhPT0gTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZSB8fCBtb2RpZmljYXRpb24ucGF0aC5sZW5ndGggPT09IDAgfHwgbW9kaWZpY2F0aW9uLmZyb21QYXJlbnQgPT09IHRydWUpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gbW9kaWZpY2F0aW9uLnBhdGhbbW9kaWZpY2F0aW9uLnBhdGgubGVuZ3RoIC0gMV07XHJcbiAgICAgIGNvbnN0IHByaW1hcnlLZXlQYXRoID0gbW9kaWZpY2F0aW9uLnBhdGhbbW9kaWZpY2F0aW9uLnBhdGgubGVuZ3RoIC0gMl07XHJcblxyXG4gICAgICAvLyDpqozor4HkuLvplK7mmK/lkKbljLnphY1cclxuICAgICAgLy8g5a2Y5Zyo5Li76ZSu5bm25LiU5Li76ZSu5LiN5pivaWTml7bmiY3mo4Dmn6XvvIjlgLzlr7nosaHjgIHlhbPogZTlr7nosaHkuI3mo4Dmn6XvvIlcclxuICAgICAgaWYgKGJpbmRpbmdPYmplY3QucHJpbWFyeUtleSAmJiBiaW5kaW5nT2JqZWN0LnByaW1hcnlLZXkgPT09ICdpZCcpIHtcclxuICAgICAgICBjb25zdCBwcmltYXJ5S2V5ID0gYmluZGluZ09iamVjdC5wcmltYXJ5S2V5O1xyXG4gICAgICAgIGNvbnN0IHByaW1hcnlLZXlWYWx1ZSA9IGJpbmRpbmdPYmplY3QuZ2V0VmFsdWUocHJpbWFyeUtleSk7XHJcbiAgICAgICAgaWYgKHByaW1hcnlLZXlQYXRoICE9PSBgJHtwcmltYXJ5S2V5fToke3ByaW1hcnlLZXlWYWx1ZX1gKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIC8vIFRPRE865L+u5aSN5Yqo5oCB5YiX5LiN6Kem5Y+R5Y+Y5pu055qE6Zeu6aKY77yM5Li05pe25pa55qGI77yM5bqU6K+l5pyJ5Y2V54us55qEZHluYW1pY0JpbmRpbmdPYmplY3TnsbtcclxuICAgICAgaWYgKG1vZGlmaWNhdGlvbi5keW5hbWljKSB7XHJcbiAgICAgICAgaWYgKGJpbmRpbmdPYmplY3RbJ19fb3JpZ2luYWxfXyddKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHZhbHVlID0gbW9kaWZpY2F0aW9uLnZhbHVlO1xyXG4gICAgICAgIGNvbnN0IHRhcmdldCA9IGJpbmRpbmdPYmplY3RbcHJvcGVydHlOYW1lXTtcclxuICAgICAgICBpZiAoIXRhcmdldCkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBPYmplY3Qua2V5cyh2YWx1ZSkuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgIGlmICh0YXJnZXQuZ2V0VmFsdWUoa2V5KSA9PT0gdmFsdWVba2V5XSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICB0YXJnZXQuc2V0VmFsdWUoa2V5LCB2YWx1ZVtrZXldLCB0cnVlLCBmYWxzZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8g5YC85rKh5pyJ5Y+R55Sf5Y+Y5YyW77yM5LiN5YaN6K6+572uXHJcbiAgICAgICAgLy8gVE9ETzog6YCa6L+HYmluZGluZ09iamVjdOS/ruaUuWVudGl0eeWxnuaAp+WAvOaXtu+8jGVudGl0eeaAu+S8muinpuWPkeS4gOS4quWPmOabtOWbnuadpe+8jOWmguaenOS4jeaIquiOt+i/meS4qumHjeWkjeeahOWPmOabtO+8jOS8muWvvOiHtOmHjeWkjeaIluatu+W+queOr1xyXG4gICAgICAgIGlmIChiaW5kaW5nT2JqZWN0LmdldFZhbHVlKHByb3BlcnR5TmFtZSkgPT09IG1vZGlmaWNhdGlvbi52YWx1ZSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBiaW5kaW5nT2JqZWN0LnNldFZhbHVlKHByb3BlcnR5TmFtZSwgbW9kaWZpY2F0aW9uLnZhbHVlLCB0cnVlLCBmYWxzZSwgbW9kaWZpY2F0aW9uLmVycm9ycyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgLy8g55uR5ZCsYmluZGluZ09iamVjdOWPmOabtFxyXG4gICAgYmluZGluZ09iamVjdC52aWV3Q2hhbmdlcy5waXBlKHRha2VVbnRpbChiaW5kaW5nT2JqZWN0LnVuc3Vic2NyaWJlKSkuc3Vic2NyaWJlKCh2aWV3Q2hhbmdlOiBWaWV3Q2hhbmdlKSA9PiB7XHJcbiAgICAgIGNvbnN0IHZhbHVlID0gdmlld0NoYW5nZS52YWx1ZTtcclxuICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gdmlld0NoYW5nZS5wYXRoWzBdO1xyXG5cclxuICAgICAgbGV0IHBhdGhQcmVmaXggPSAnJztcclxuICAgICAgY29uc3QgcGF0aERhdGEgPSBlbnRpdHkuZ2V0UGF0aHMoKTtcclxuICAgICAgY29uc3QgcGF0aHMgPSBwYXRoRGF0YS5wYXRoO1xyXG4gICAgICBsZXQgaWQgPSBiaW5kaW5nT2JqZWN0WydpZCddO1xyXG4gICAgICBiaW5kaW5nT2JqZWN0WydfX29yaWdpbmFsX18nXSA9IHRydWU7XHJcbiAgICAgIC8vIGlmIChwYXRoRGF0YS5pc1VkdCkge1xyXG4gICAgICAvLyBncmlk5LitdWR05rKh5pyJaWTvvIzku47niLbnuqfkuK3lj5blh7ppZO+8jOS7peS+v+WtmOaUvumqjOivgeS/oeaBr1xyXG4gICAgICBjb25zdCBnZXRQYXJlbnRJZCA9ICh0YXJnZXQ6IGFueSkgPT4ge1xyXG4gICAgICAgIGxldCBwYXJlbnRJZCA9ICcnO1xyXG4gICAgICAgIGNvbnN0IGZpbmRJZCA9IChpdGVtOiBhbnkpID0+IHtcclxuICAgICAgICAgIGlmIChpdGVtICYmIGl0ZW0gJiYgaXRlbVsnaWQnXSkge1xyXG4gICAgICAgICAgICBwYXJlbnRJZCA9IGl0ZW1bJ2lkJ107XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH0gZWxzZSBpZiAoaXRlbVsncGFyZW50J10pIHtcclxuICAgICAgICAgICAgZmluZElkKGl0ZW1bJ3BhcmVudCddKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIGZpbmRJZCh0YXJnZXQpO1xyXG4gICAgICAgIHJldHVybiBwYXJlbnRJZDtcclxuICAgICAgfTtcclxuICAgICAgaWQgPSBnZXRQYXJlbnRJZChiaW5kaW5nT2JqZWN0KTtcclxuICAgICAgLy8gaWYgKHBhdGhEYXRhLmlzR3JpZCkge1xyXG4gICAgICAvLyAgIC8vIGdyaWQg5bCG5LuO6KGo5Li75a2X5q615Y676ZmkXHJcbiAgICAgIC8vICAgcGF0aHMucG9wKCk7XHJcbiAgICAgIC8vIH1cclxuICAgICAgaWYgKHBhdGhzLmxlbmd0aCkge1xyXG4gICAgICAgIHBhdGhQcmVmaXggPSBwYXRocy5qb2luKCcuJykgKyAnLic7XHJcbiAgICAgIH1cclxuICAgICAgLy8gfVxyXG4gICAgICBjb25zdCBjb250cm9sUHJvcCA9IHBhdGhQcmVmaXggKyBwcm9wZXJ0eU5hbWU7XHJcbiAgICAgIC8vIOiwg+eUqOWunuS9k+mqjOivge+8jOW5tuWwhumUmeivr+S/oeaBr+WQiOW5tuWIsGZvcm1Db250cm9s5LiKXHJcbiAgICAgIGNvbnN0IGVudGl0eVZhbGlkYXRlID0gKGNhbGxiYWNrPzogKGVycm9yOiBhbnkpID0+IHZvaWQpID0+IHtcclxuICAgICAgICBjb25zdCBlbmFibGVWYWxpZGF0ZSA9IE9iamVjdC52YWx1ZXMoRm9ybS5pbnNNYXApLmZpbmQoaXRlbSA9PiBpdGVtICYmIGl0ZW0uZW5hYmxlVmFsaWRhdGUpO1xyXG4gICAgICAgIGlmICghZW5hYmxlVmFsaWRhdGUpIHtcclxuICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgY2FsbGJhY2sobnVsbCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVudGl0eS52YWxpZGF0ZUZyb21VdGlsU3luYyhwcm9wZXJ0eU5hbWUsIHZhbHVlLCByZXN1bHQgPT4ge1xyXG4gICAgICAgICAgY29uc3QgZXJyb3JPYmogPSB7fTtcclxuICAgICAgICAgIGlmIChyZXN1bHQuZXJyb3JzICYmIHJlc3VsdC5lcnJvcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICByZXN1bHQuZXJyb3JzLmZvckVhY2goKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICBpZiAoZXJyb3IuY29uc3RyYWludHMpIHtcclxuICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKGVycm9yLmNvbnN0cmFpbnRzKS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIGVycm9yT2JqW2tleV0gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLFxyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IGVycm9yLmNvbnN0cmFpbnRzW2tleV0sXHJcbiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yXHJcbiAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgLy8g5YWI6K6+572u5a6e5L2T6aqM6K+B5L+h5oGv77yM5YaN6K6+572uZm9ybemqjOivgeS/oeaBr++8jOeEtuWQjuWcqGZvcm0uaXNGb3JtVmFsaWTlhoXpg6jmlbTlkIjlrp7kvZPpqozor4Fmb3Jt6aqM6K+B5L+h5oGvXHJcbiAgICAgICAgICBGb3JtLnVwZGF0ZUVycm9ycyhjb250cm9sUHJvcCwgZXJyb3JPYmosIGlkLCB2YWx1ZSwgcGF0aERhdGEuaXNHcmlkKTtcclxuICAgICAgICAgIGNvbnN0IGZvcm1FcnJvcnMgPSB2aWV3Q2hhbmdlWydlcnJvcnMnXSB8fCB7fTtcclxuICAgICAgICAgIGNvbnN0IG1lcmdlZEVycm9ycyA9IE9iamVjdC5hc3NpZ24oe30sIGZvcm1FcnJvcnMsIGVycm9yT2JqKTtcclxuICAgICAgICAgIGxldCB2YWxpZGF0ZUVycm9yID0gbnVsbDtcclxuICAgICAgICAgIGlmIChPYmplY3Qua2V5cyhtZXJnZWRFcnJvcnMpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgdmFsaWRhdGVFcnJvciA9IHsgW3Byb3BlcnR5TmFtZV06IG1lcmdlZEVycm9ycyB9O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgaWYgKHR5cGVvZiAoY2FsbGJhY2spID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKHZhbGlkYXRlRXJyb3IpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0sIHZpZXdDaGFuZ2UuY29udGV4dCk7XHJcbiAgICAgIH07XHJcblxyXG4gICAgICAvLyDkuI3mmK/kuLvplK7lgLzlrZfmrrXml7bvvIzopoHlhYjmo4Dmn6XkuLvplK7mmK/lkKblrZjlnKjvvIzlubbkuJTkuLvplK7mmK/lkKbnm7jnrYnvvIjpmLLmraLlkI7ku6Plj5jmm7TlhpLms6HkuIrmnaXvvIlcclxuICAgICAgLy8g6Z2e5Li76ZSu5bGe5oCn5Y+Y5pu05pe277yM6KaB5YWI5qOA5p+l5Li76ZSu5piv5ZCm5Yy56YWN77yI5aaC5p6c5Li76ZSu5Lmf5L+u5pS55LqG77yM6KaB5rGC5YWI5L+u5pS55Li76ZSu5YaN5L+u5pS55YW25LuW5YC877yJXHJcbiAgICAgIGlmIChiaW5kaW5nT2JqZWN0LnByaW1hcnlLZXkpIHtcclxuICAgICAgICBjb25zdCBwcmltYXJ5S2V5ID0gYmluZGluZ09iamVjdC5wcmltYXJ5S2V5O1xyXG4gICAgICAgIGlmIChwcm9wZXJ0eU5hbWUgIT09IHByaW1hcnlLZXkpIHtcclxuICAgICAgICAgIGlmICghZW50aXR5W3ByaW1hcnlLZXldIHx8IGVudGl0eVtwcmltYXJ5S2V5XSAhPT0gYmluZGluZ09iamVjdFtwcmltYXJ5S2V5XSkge1xyXG4gICAgICAgICAgICBlbnRpdHlWYWxpZGF0ZSgpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIGlmIChlbnRpdHlbcHJvcGVydHlOYW1lXSAhPT0gdmFsdWUpIHtcclxuICAgICAgICAgIC8vIHRvZG86IOWboOW8guatpeagoemqjOacque7k+adn+WunuS9k+S4u+mUruayoeacieiiq+i1i+WAvO+8jOWvvOiHtOWunuS9k+WFtuS7luWxnuaAp+aXoOazlei1i+WAvO+8jOW+heWQjue7reWJjeerr+agoemqjOmHjeaehOaXtuWOu+aOiVxyXG4gICAgICAgICAgZW50aXR5W3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTtcclxuICAgICAgICAgIGVudGl0eVZhbGlkYXRlKCk7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyDlpoLmnpxCaW5kaW5nT2JqZWN05LiK55qE5bGe5oCn5YC85ZKMRW50aXR55LiK5a+55bqU5bGe5oCn5YC85LiA5qC377yM5YiZ5LiN5YaN6K6+572uXHJcbiAgICAgIGlmIChlbnRpdHlbcHJvcGVydHlOYW1lXSA9PT0gdmFsdWUpIHtcclxuICAgICAgICBlbnRpdHlWYWxpZGF0ZSgpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8g6LCD55So6KGo5Y2V6aqM6K+BLOmAmui/h+WQjuiwg+eUqOWunuS9k+mqjOivgVxyXG4gICAgICAvLyBiaW5nZGluZ09iamVjdOWPmOWMluWQju+8jOWFiOiwg+eUqOWunuS9k+S4iueahOmqjOivge+8jOmAmui/h+WQjuWGjeiuvue9ruWunuS9k+eahOWPmOWKqFxyXG4gICAgICBlbnRpdHlWYWxpZGF0ZSgoZXJyb3JzOiBhbnkpID0+IHtcclxuICAgICAgICBlbnRpdHkuZXJyb3JzID0gZXJyb3JzO1xyXG4gICAgICAgIGVudGl0eVtwcm9wZXJ0eU5hbWVdID0gdmFsdWU7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlsIZlbnRpdHlMaXN05Lit55qERW50aXR55a+56LGh6L2s5o2i5Li6QmluZGluZ09iamVjdOWvueixoe+8jOWKoOi9veWIsGJpbmRpbmdMaXN05Lit77yM5bm25L+d5oyBZW50aXR5TGlzdOWSjGJpbmRpbmdMaXN05ZCM5q2l44CCXHJcbiAgICogQHBhcmFtIGVudGl0eUxpc3QgIOWunuS9k+WIl+ihqFxyXG4gICAqIEBwYXJhbSBiaW5kaW5nTGlzdCDnu5HlrprliJfooahcclxuICAgKi9cclxuICBzdGF0aWMgbG9hZEVudGl0eUxpc3QoZW50aXR5TGlzdDogRW50aXR5TGlzdDxhbnk+LCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QpIHtcclxuICAgIHRoaXMubG9hZEVudGl0aWVzKGVudGl0eUxpc3QuaXRlbXMsIGJpbmRpbmdMaXN0KTtcclxuICAgIHRoaXMuc2V0VXBFbnRpdHlMaXN0UGlwZWxpbmUoZW50aXR5TGlzdCwgYmluZGluZ0xpc3QpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bu656uLZW50aXR5TGlzdOWSjGJpbmRpbmdMaXN05LmL6Ze055qE5YWz6IGUXHJcbiAgICogQHBhcmFtIGVudGl0eUxpc3QgIOWunuS9k+WIl+ihqFxyXG4gICAqIEBwYXJhbSBiaW5kaW5nTGlzdCDnu5HlrprliJfooahcclxuICAgKi9cclxuICBzdGF0aWMgc2V0VXBFbnRpdHlMaXN0UGlwZWxpbmUoZW50aXR5TGlzdDogRW50aXR5TGlzdDxhbnk+LCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QpIHtcclxuICAgIGVudGl0eUxpc3Qub25MaXN0Q2hhbmdlZC5zdWJzY3JpYmUoKG1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRhcmdldCA9IG1vZGlmaWNhdGlvblsndGFyZ2V0J107XHJcbiAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0ICE9PSBlbnRpdHlMaXN0KSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIHN3aXRjaCAobW9kaWZpY2F0aW9uLnR5cGUpIHtcclxuICAgICAgICAvLyDmt7vliqDlrp7kvZNcclxuICAgICAgICBjYXNlIE1vZGlmeVR5cGUuQWRkOlxyXG4gICAgICAgIGNhc2UgTW9kaWZ5VHlwZS5DbG9uZTpcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgY29uc3QgZW50aXRpZXNUb0FkZCA9IDxFbnRpdHlbXT5tb2RpZmljYXRpb24udmFsdWU7XHJcbiAgICAgICAgICAgIGlmIChlbnRpdGllc1RvQWRkLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyDmo4Dmn6XniLZpZOaYr+WQpuS4gOiHtO+8jOWGkuazoeWvvOiHtOeahOWPmOabtOS4jeWkhOeQhlxyXG4gICAgICAgICAgICBjb25zdCBwYXRocyA9IG1vZGlmaWNhdGlvbi5wYXRoO1xyXG4gICAgICAgICAgICBjb25zdCBwYXJlbnRQYXRoID0gcGF0aHNbcGF0aHMubGVuZ3RoIC0gMl07XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudElkID0gYmluZGluZ0xpc3QucGFyZW50LnByaW1hcnlLZXlWYWx1ZTtcclxuICAgICAgICAgICAgaWYgKHBhcmVudFBhdGguaW5kZXhPZihwYXJlbnRJZCkgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLmFwcGVuZEVudGl0aWVzKDxFbnRpdHlbXT5tb2RpZmljYXRpb24udmFsdWUsIGJpbmRpbmdMaXN0LCBtb2RpZmljYXRpb24udHlwZSA9PT0gTW9kaWZ5VHlwZS5DbG9uZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlIE1vZGlmeVR5cGUuSW5zZXJ0OlxyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICAvLyDmo4Dmn6XniLZpZOaYr+WQpuS4gOiHtO+8jOWGkuazoeWvvOiHtOeahOWPmOabtOS4jeWkhOeQhlxyXG4gICAgICAgICAgICBjb25zdCBwYXRocyA9IG1vZGlmaWNhdGlvbi5wYXRoO1xyXG4gICAgICAgICAgICBjb25zdCBwYXJlbnRQYXRoID0gcGF0aHNbcGF0aHMubGVuZ3RoIC0gMl07XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudElkID0gYmluZGluZ0xpc3QucGFyZW50LnByaW1hcnlLZXlWYWx1ZTtcclxuICAgICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBtb2RpZmljYXRpb24ucG9zaXRpb247XHJcbiAgICAgICAgICAgIGlmIChwYXJlbnRQYXRoLmluZGV4T2YocGFyZW50SWQpID09PSAtMSkge1xyXG4gICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmluc2VydEVudGl0eShtb2RpZmljYXRpb24udmFsdWVbMF0sIGJpbmRpbmdMaXN0LCBwb3NpdGlvbik7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICAvLyDliKDpmaTlrp7kvZNcclxuICAgICAgICBjYXNlIE1vZGlmeVR5cGUuUmVtb3ZlOlxyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICAvLyDmo4Dmn6XniLZpZOaYr+WQpuS4gOiHtO+8jOWGkuazoeWvvOiHtOeahOWPmOabtOS4jeWkhOeQhlxyXG4gICAgICAgICAgICBjb25zdCBwYXRocyA9IG1vZGlmaWNhdGlvbi5wYXRoO1xyXG4gICAgICAgICAgICBjb25zdCBwYXJlbnRQYXRoID0gcGF0aHNbcGF0aHMubGVuZ3RoIC0gMl07XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudElkID0gYmluZGluZ0xpc3QucGFyZW50LnByaW1hcnlLZXlWYWx1ZTtcclxuICAgICAgICAgICAgaWYgKHBhcmVudFBhdGguaW5kZXhPZihwYXJlbnRJZCkgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIOWIoOmZpOWunuS9k++8iHZhbHVl5qC85byP5b6F5ZWG5qa377yM55uu5YmNdmFsdWXnmoTmoLzlvI/kuLogeyBwcmltYXJ5S2V5OiBwcmltYXJ5VmFsdWV977yJXHJcbiAgICAgICAgICAgIGNvbnN0IGlkID0gbW9kaWZpY2F0aW9uLnZhbHVlW2JpbmRpbmdMaXN0LnByaW1hcnlLZXldO1xyXG4gICAgICAgICAgICBiaW5kaW5nTGlzdC5yZW1vdmVCeUlkcyhbaWRdKTtcclxuICAgICAgICAgICAgLy8gdGhpcy5yZW1vdmVFbnRpdGllcyg8RW50aXR5W10+bW9kaWZpY2F0aW9uLnZhbHVlLCBiaW5kaW5nTGlzdCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgLy8g5Yqg6L295a6e5L2TXHJcbiAgICAgICAgY2FzZSBNb2RpZnlUeXBlLkxvYWQ6XHJcbiAgICAgICAgICAvLyDmo4Dmn6XniLZpZOaYr+WQpuS4gOiHtO+8jOWGkuazoeWvvOiHtOeahOWPmOabtOS4jeWkhOeQhlxyXG4gICAgICAgICAgY29uc3QgcGF0aHMgPSBtb2RpZmljYXRpb24ucGF0aDtcclxuICAgICAgICAgIGNvbnN0IHBhcmVudFBhdGggPSBwYXRoc1twYXRocy5sZW5ndGggLSAyXTtcclxuICAgICAgICAgIGNvbnN0IHBhcmVudElkID0gYmluZGluZ0xpc3QucGFyZW50LnByaW1hcnlLZXlWYWx1ZTtcclxuICAgICAgICAgIGlmIChwYXJlbnRQYXRoLmluZGV4T2YocGFyZW50SWQpID09PSAtMSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjb25zdCBlbnRpdGllcyA9IG1vZGlmaWNhdGlvbi52YWx1ZTtcclxuICAgICAgICAgIHRoaXMubG9hZEVudGl0aWVzKGVudGl0aWVzLCBiaW5kaW5nTGlzdCk7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog55uR5ZCscmVwb3NpdG9yeeWPmOWMlu+8jOS/neaMgXJlcG9zaXRvcnnlkoxiaW5kaW5nTGlzdOWQjOatpeOAglxyXG4gICAqIEBwYXJhbSByZXBvc2l0b3J5ICDlrp7kvZPku5PlupNcclxuICAgKiBAcGFyYW0gYmluZGluZ0xpc3Qg57uR5a6a5YiX6KGoXHJcbiAgICovXHJcbiAgc3RhdGljIGxvYWRSZXBvc2l0b3J5KHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55PiwgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0KSB7XHJcbiAgICAvLyDliJ3mrKHliqDovb1cclxuICAgIGNvbnN0IGVudGl0aWVzID0gQXJyYXkuZnJvbShyZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24udG9BcnJheSgpKTtcclxuICAgIHRoaXMubG9hZEVudGl0aWVzKGVudGl0aWVzLCBiaW5kaW5nTGlzdCk7XHJcblxyXG4gICAgLy8g55uR5ZCs5Y+Y5YyWXHJcbiAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb25DaGFuZ2UucGlwZSh0YWtlVW50aWwocmVwb3NpdG9yeS5kZXN0cm95JCkpLnN1YnNjcmliZSgobW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pID0+IHtcclxuICAgICAgc3dpdGNoIChtb2RpZmljYXRpb24udHlwZSkge1xyXG4gICAgICAgIGNhc2UgTW9kaWZ5VHlwZS5Mb2FkOlxyXG4gICAgICAgICAgYmluZGluZ0xpc3QuY2xlYXIodHJ1ZSk7XHJcbiAgICAgICAgICB0aGlzLmxvYWRFbnRpdGllcyg8RW50aXR5W10+bW9kaWZpY2F0aW9uLnZhbHVlLCBiaW5kaW5nTGlzdCwgbW9kaWZpY2F0aW9uLmVudGl0eUNyZWF0ZSk7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlIE1vZGlmeVR5cGUuQWRkOlxyXG4gICAgICAgIGNhc2UgTW9kaWZ5VHlwZS5DbG9uZTpcclxuICAgICAgICAgIHRoaXMuYXBwZW5kRW50aXRpZXMoPEVudGl0eVtdPm1vZGlmaWNhdGlvbi52YWx1ZSwgYmluZGluZ0xpc3QsIG1vZGlmaWNhdGlvbi50eXBlID09PSBNb2RpZnlUeXBlLkNsb25lLCB7IGlzVHJlZU5vZGVMb2FkU2NlbmU6IG1vZGlmaWNhdGlvbi5pc1RyZWVOb2RlTG9hZFNjZW5lIH0pO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBNb2RpZnlUeXBlLkFkZERhdGE6XHJcbiAgICAgICAgICB0aGlzLmFkZERhdGEoPEVudGl0eVtdPm1vZGlmaWNhdGlvbi52YWx1ZSwgYmluZGluZ0xpc3QsIHsgaXNUcmVlTm9kZUxvYWRTY2VuZTogbW9kaWZpY2F0aW9uLmlzVHJlZU5vZGVMb2FkU2NlbmUgfSk7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlIE1vZGlmeVR5cGUuSW5zZXJ0OlxyXG4gICAgICAgICAgdGhpcy5pbnNlcnRFbnRpdHkobW9kaWZpY2F0aW9uLnZhbHVlLCBiaW5kaW5nTGlzdCwgbW9kaWZpY2F0aW9uLnBvc2l0aW9uKTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgTW9kaWZ5VHlwZS5SZW1vdmU6XHJcbiAgICAgICAgICB0aGlzLnJlbW92ZUVudGl0aWVzKDxFbnRpdHlbXT5tb2RpZmljYXRpb24udmFsdWUsIGJpbmRpbmdMaXN0KTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgTW9kaWZ5VHlwZS5SZW1vdmVEYXRhOlxyXG4gICAgICAgICAgdGhpcy5yZW1vdmVEYXRhKDxFbnRpdHlbXT5tb2RpZmljYXRpb24udmFsdWUsIGJpbmRpbmdMaXN0KTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgTW9kaWZ5VHlwZS5QYWdpbmF0aW9uSW5mb0NoYW5nZTpcclxuICAgICAgICAgIC8vIOWIhumhteS/oeaBr+aXoOmcgOWQjOatpeWIsGJpbmRpbmdMaXN077yM5pS+5YiwYmluZGluZ0RhdGHljbPlj6/jgILkv53nlZnmraTlpITlj6rmmK/kuLrkuoblhbzlrrnkuqflk4Hpg6jlj6/og73kvb/nlKhiaW5kaW5nTGlzdOS4iuWIhumhteS/oeaBr+eahOWcuuaZr1xyXG4gICAgICAgICAgYmluZGluZ0xpc3QucGFnaW5hdGlvbkluZm8gPSA8UGFnaW5hdGlvbj5tb2RpZmljYXRpb24udmFsdWU7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOebkeWQrEJpbmRpbmdMaXN05pWw5o2u5Y+Y5YyWXHJcbiAgICBiaW5kaW5nTGlzdC5jaGFuZ2VzLnBpcGUodGFrZVVudGlsKGJpbmRpbmdMaXN0LmRlc3Ryb3kkKSkuc3Vic2NyaWJlKChjaGFuZ2U6IENoYW5nZSkgPT4ge1xyXG4gICAgICBpZiAoY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuUGFnaW5hdGlvbkluZm9DaGFuZ2UpIHtcclxuICAgICAgICBjb25zdCBlbnRpdHlDb2xsZWN0aW9uID0gcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uO1xyXG4gICAgICAgIC8vIGNvbnN0IGVudGl0eVR5cGVOYW1lID0gZW50aXR5Q29sbGVjdGlvbi5lbnRpdHlUeXBlTmFtZTtcclxuICAgICAgICAvLyBjb25zdCBvcmlnaW5hbCA9IGVudGl0eUNvbGxlY3Rpb24ucGFnaW5hdGlvbkluZm9bZW50aXR5VHlwZU5hbWVdO1xyXG4gICAgICAgIC8vIGNvbnN0IGVudGl0eVBhZ2luYXRpb25JbmZvID0gT2JqZWN0LmFzc2lnbih7fSwgb3JpZ2luYWwsIGNoYW5nZS52YWx1ZSk7XHJcbiAgICAgICAgZW50aXR5Q29sbGVjdGlvbi5wYWdpbmF0aW9uSW5mbyA9IE9iamVjdC5hc3NpZ24oe30sIGVudGl0eUNvbGxlY3Rpb24ucGFnaW5hdGlvbkluZm8sIGNoYW5nZS52YWx1ZSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bCGZW50aXRpZXPkuK3nmoRFbnRpdHnlr7nosaHovazmjaLkuLpCaW5kaW5nT2JqZWN05a+56LGh77yM5bm25Yqg6L295YiwYmluZGluZ0xpc3TkuK1cclxuICAgKiBAcGFyYW0gZW50aXRpZXMgICAg5a6e5L2T5pWw57uEXHJcbiAgICogQHBhcmFtIGJpbmRpbmdMaXN0IOe7keWumuWIl+ihqFxyXG4gICAqL1xyXG4gIHN0YXRpYyBsb2FkRW50aXRpZXMoZW50aXRpZXM6IEVudGl0eVtdLCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QsIGVudGl0eUNyZWF0ZTogYm9vbGVhbiA9IGZhbHNlKSB7XHJcbiAgICBjb25zdCBiaW5kaW5nT2JqZWN0cyA9IHRoaXMuY3JlYXRlQmluZGluZ09iamVjdHMoZW50aXRpZXMsIGJpbmRpbmdMaXN0KTtcclxuICAgIGJpbmRpbmdMaXN0LmxvYWQoYmluZGluZ09iamVjdHMsIGVudGl0eUNyZWF0ZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlsIZlbnRpdGllc+S4reeahEVudGl0eeWvueixoei9rOaNouS4ukJJbmRpbmdPYmplY3Tlr7nosaHvvIzlubbov73liqDliLBiaW5kaW5nTGlzdOS4rVxyXG4gICAqIEBwYXJhbSBlbnRpdGllcyAgICDlrp7kvZPmlbDnu4RcclxuICAgKiBAcGFyYW0gYmluZGluZ0xpc3Qg57uR5a6a5YiX6KGoXHJcbiAgICogQHBhcmFtIGlzQ2xvbmVkIOaYr+WQpuWFi+mahuaVsOaNrlxyXG4gICAqIEBwYXJhbSBvcHRpb25zIOS4iuS4i+aWh1xyXG4gICAqL1xyXG4gIHN0YXRpYyBhcHBlbmRFbnRpdGllcyhlbnRpdGllczogRW50aXR5W10sIGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCwgaXNDbG9uZWQ6IGJvb2xlYW4gPSBmYWxzZSwgb3B0aW9uczogYW55ID0gbnVsbCkge1xyXG4gICAgY29uc3QgYmluZGluZ09iamVjdHMgPSB0aGlzLmNyZWF0ZUJpbmRpbmdPYmplY3RzKGVudGl0aWVzLCBiaW5kaW5nTGlzdCk7XHJcbiAgICBiaW5kaW5nTGlzdC5hcHBlbmQoYmluZGluZ09iamVjdHMsIGlzQ2xvbmVkLCBvcHRpb25zKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5piv5ZCm5piv5pyJ5pWI55qE5a2X5q61XHJcbiAgICogQHBhcmFtIGVudGl0eSDlrp7kvZNcclxuICAgKiBAcGFyYW0gcHJvcGVydHlOYW1lIOWtl+autVxyXG4gICAqIEByZXR1cm5zXHJcbiAgICovXHJcbiAgc3RhdGljIGlzRWZmZWN0aXZlRmllbGQoZW50aXR5OiBFbnRpdHksIHByb3BlcnR5TmFtZTogc3RyaW5nKSB7XHJcbiAgICBpZiAoIWVudGl0eSB8fCAhcHJvcGVydHlOYW1lKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIHByb3BlcnR5TmFtZSA9IHByb3BlcnR5TmFtZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgaWYgKGVudGl0eVsnX19mYXJyaXNfZWZmZWN0aXZlX2ZpZWxkc19fJ10pIHtcclxuICAgICAgcmV0dXJuIGVudGl0eVsnX19mYXJyaXNfZWZmZWN0aXZlX2ZpZWxkc19fJ10uaW5jbHVkZXMocHJvcGVydHlOYW1lKTtcclxuICAgIH1cclxuICAgIGlmIChlbnRpdHlbJ2ZhcnJpc19lZmZlY3RpdmVfZmllbGRzJ10gJiYgdHlwZW9mIGVudGl0eVsnZmFycmlzX2VmZmVjdGl2ZV9maWVsZHMnXSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgY29uc3QgZWZmZWN0aXZlRmllbGRzID0gZW50aXR5WydmYXJyaXNfZWZmZWN0aXZlX2ZpZWxkcyddLnNwbGl0KCcsJykuZmlsdGVyKHAgPT4gcCkubWFwKGl0ZW0gPT4gaXRlbS50b0xvd2VyQ2FzZSgpKTtcclxuICAgICAgZW50aXR5WydfX2ZhcnJpc19lZmZlY3RpdmVfZmllbGRzX18nXSA9IGVmZmVjdGl2ZUZpZWxkcztcclxuICAgICAgcmV0dXJuIGVmZmVjdGl2ZUZpZWxkcy5pbmNsdWRlcyhwcm9wZXJ0eU5hbWUpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWinuWKoOWunuS9k+aVsOaNru+8iOS4jeWIh+aNouW9k+WJjeihjO+8iVxyXG4gICAqIEBwYXJhbSBlbnRpdGllc1xyXG4gICAqIEBwYXJhbSBiaW5kaW5nTGlzdFxyXG4gICAqL1xyXG4gIHN0YXRpYyBhZGREYXRhKGVudGl0aWVzOiBFbnRpdHlbXSwgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0LCBvcHRpb25zOiBhbnkgPSBudWxsKSB7XHJcbiAgICBjb25zdCBiaW5kaW5nT2JqZWN0cyA9IHRoaXMuY3JlYXRlQmluZGluZ09iamVjdHMoZW50aXRpZXMsIGJpbmRpbmdMaXN0KTtcclxuICAgIGJpbmRpbmdMaXN0LmFkZERhdGEoYmluZGluZ09iamVjdHMsIG9wdGlvbnMpO1xyXG4gIH1cclxuICBzdGF0aWMgaW5zZXJ0RW50aXR5KGVudGl0eTogRW50aXR5LCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QsIHBvc2l0aW9uOiAtMSB8IDEpIHtcclxuICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSB0aGlzLmNyZWF0ZUJpbmRpbmdPYmplY3QoZW50aXR5LCBiaW5kaW5nTGlzdCk7XHJcbiAgICBiaW5kaW5nTGlzdC5pbnNlcnQoYmluZGluZ09iamVjdCwgcG9zaXRpb24pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDku45iaW5kaW5nTGlzdOenu+mZpGVudGl0aWVz5a+55bqU55qEQmluZGluZ09iamVjdOWvueixoVxyXG4gICAqIEBwYXJhbSBlbnRpdGllcyAgICDlrp7kvZPmlbDnu4RcclxuICAgKiBAcGFyYW0gYmluZGluZ0xpc3Qg57uR5a6a5YiX6KGoXHJcbiAgICovXHJcbiAgc3RhdGljIHJlbW92ZUVudGl0aWVzKGVudGl0aWVzOiBFbnRpdHlbXSwgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0KSB7XHJcbiAgICBpZiAoZW50aXRpZXMgPT09IG51bGwgfHwgZW50aXRpZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICAvLyDlvZLpm4bopoHliKDpmaTnmoRpZOaVsOe7hFxyXG4gICAgY29uc3QgcHJpbWFyeUtleSA9IGJpbmRpbmdMaXN0LnByaW1hcnlLZXk7XHJcbiAgICBjb25zdCBpZHMgPSBbXTtcclxuICAgIGVudGl0aWVzLmZvckVhY2goKGVudGl0eTogRW50aXR5KSA9PiB7XHJcbiAgICAgIGlkcy5wdXNoKGVudGl0eVtwcmltYXJ5S2V5XSk7XHJcbiAgICB9KTtcclxuICAgIGJpbmRpbmdMaXN0LnJlbW92ZUJ5SWRzKGlkcyk7XHJcbiAgfVxyXG4gIHN0YXRpYyByZW1vdmVEYXRhKGVudGl0aWVzOiBFbnRpdHlbXSwgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0KSB7XHJcbiAgICBpZiAoZW50aXRpZXMgPT09IG51bGwgfHwgZW50aXRpZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIOW9kumbhuimgeWIoOmZpOeahGlk5pWw57uEXHJcbiAgICBjb25zdCBwcmltYXJ5S2V5ID0gYmluZGluZ0xpc3QucHJpbWFyeUtleTtcclxuICAgIGNvbnN0IGlkcyA9IFtdO1xyXG4gICAgZW50aXRpZXMuZm9yRWFjaCgoZW50aXR5OiBFbnRpdHkpID0+IHtcclxuICAgICAgaWRzLnB1c2goZW50aXR5W3ByaW1hcnlLZXldKTtcclxuICAgIH0pO1xyXG4gICAgYmluZGluZ0xpc3QucmVtb3ZlRGF0YUJ5SWRzKGlkcyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWwhmVudGl0aWVz5Lit55qERW50aXR55a+56LGh6L2s5o2i5Li6QmluZGluZ09iamVjdOWvueixoVxyXG4gICAqIEBwYXJhbSBlbnRpdGllcyAgICDlrp7kvZPmlbDnu4RcclxuICAgKiBAcGFyYW0gYmluZGluZ0xpc3Qg57uR5a6a5YiX6KGoXHJcbiAgICovXHJcbiAgc3RhdGljIGNyZWF0ZUJpbmRpbmdPYmplY3RzKGVudGl0aWVzOiBFbnRpdHlbXSwgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0KSB7XHJcbiAgICBpZiAoZW50aXRpZXMgPT09IG51bGwgfHwgZW50aXRpZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuICAgIGNvbnN0IGJpbmRpbmdPYmplY3RzID0gW107XHJcbiAgICBlbnRpdGllcy5mb3JFYWNoKChlbnRpdHk6IEVudGl0eSkgPT4ge1xyXG4gICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gQmluZGluZ09iamVjdEZhY3RvcnkuY3JlYXRlKGJpbmRpbmdMaXN0LnByb3BlcnRpZXMsIHRydWUpO1xyXG4gICAgICAvLyBiaW5kaW5nT2JqZWN0WydfRU5USVRZXyddID0gZW50aXR5O1xyXG4gICAgICB0aGlzLmxvYWRFbnRpdHkoZW50aXR5LCBiaW5kaW5nT2JqZWN0KTtcclxuXHJcbiAgICAgIC8vIC8vIOS4umJpbmRpbmdPYmplY3Torr7nva7pu5jorqTlgLxpbml0aWFsRGF0YeWxnuaAp1xyXG4gICAgICAvLyBpZiAoZW50aXR5Wydpbml0aWFsRGF0YSddKSB7XHJcbiAgICAgIC8vICAgYmluZGluZ09iamVjdFsnaW5pdGlhbERhdGEnXSA9IGVudGl0eVsnaW5pdGlhbERhdGEnXTtcclxuICAgICAgLy8gfVxyXG4gICAgICBiaW5kaW5nT2JqZWN0cy5wdXNoKGJpbmRpbmdPYmplY3QpO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gYmluZGluZ09iamVjdHM7XHJcbiAgfVxyXG4gIHN0YXRpYyBjcmVhdGVCaW5kaW5nT2JqZWN0KGVudGl0eTogRW50aXR5LCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QpIHtcclxuICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBCaW5kaW5nT2JqZWN0RmFjdG9yeS5jcmVhdGUoYmluZGluZ0xpc3QucHJvcGVydGllcywgdHJ1ZSk7XHJcbiAgICB0aGlzLmxvYWRFbnRpdHkoZW50aXR5LCBiaW5kaW5nT2JqZWN0KTtcclxuICAgIHJldHVybiBiaW5kaW5nT2JqZWN0O1xyXG4gIH1cclxuICBwdWJsaWMgc3RhdGljIHdhdGNoUmVwb3Npcm90eShyZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4sIGJpbmRpbmdEYXRhOiBCaW5kaW5nRGF0YSkge1xyXG4gICAgLy8gcmVwb3Npcm90eSA9PiBiaW5kaW5nRGF0YVxyXG4gICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uQ2hhbmdlLnN1YnNjcmliZSgobW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pID0+IHtcclxuICAgICAgc3dpdGNoIChtb2RpZmljYXRpb24udHlwZSkge1xyXG4gICAgICAgIGNhc2UgTW9kaWZ5VHlwZS5QYWdpbmF0aW9uSW5mb0NoYW5nZTpcclxuICAgICAgICAgIGJpbmRpbmdEYXRhLnBhZ2luZ0luZm8gPSBtb2RpZmljYXRpb24udmFsdWU7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmn6Xmib7lsZ7mgKfnmoTnsbvlnotcclxuICAgKiBAcGFyYW0gZW50aXR5VHlwZSDlrp7kvZPnsbvlnotcclxuICAgKiBAcGFyYW0gdGFyZ2V0UHJvcE5hbWUg5bGe5oCn5ZCN56ewXHJcbiAgICogQHJldHVybiDlsZ7mgKfkv6Hmga/vvIzljIXlkKvlsZ7mgKfnsbvlnovvvIhOZ0ZpZWxk44CBTmdPYmplY3TjgIFOZ0xpc3TvvInlkozlsZ7mgKflr7nlupTnmoTlrp7kvZPnsbvlnovvvIjlvZNOZ0ZpZWxk57G75Z6L5pe25Li6bnVsbO+8iVxyXG4gICAqL1xyXG4gIHN0YXRpYyBnZXRQcm9wSW5mbyhlbnRpdHlUeXBlOiBhbnksIHRhcmdldFByb3BOYW1lOiBzdHJpbmcpOiB7IHByb3BUeXBlOiBzdHJpbmcsIHByb3BFbnRpdHlUeXBlOiBhbnkgfSB7XHJcblxyXG4gICAgbGV0IHByb3BUeXBlOiBzdHJpbmc7XHJcbiAgICBsZXQgcHJvcEVudGl0eVR5cGU6IGFueTtcclxuXHJcbiAgICAvLyBOZ0ZpZWxkXHJcbiAgICBjb25zdCBuZ0ZpZWxkUHJvcGVydGllcyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nRmllbGRzKGVudGl0eVR5cGUpO1xyXG4gICAgT2JqZWN0LmtleXMobmdGaWVsZFByb3BlcnRpZXMpLmZvckVhY2goKHByb3BOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgaWYgKHByb3BOYW1lID09PSB0YXJnZXRQcm9wTmFtZSkge1xyXG4gICAgICAgIHByb3BUeXBlID0gJ05nRmllbGQnO1xyXG4gICAgICAgIHByb3BFbnRpdHlUeXBlID0gbnVsbDtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gTmdPYmplY3RcclxuICAgIGNvbnN0IG5nT2JqZWN0UHJvcGVydGllcyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nT2JqZWN0cyhlbnRpdHlUeXBlKTtcclxuICAgIE9iamVjdC5rZXlzKG5nT2JqZWN0UHJvcGVydGllcykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICBpZiAocHJvcE5hbWUgPT09IHRhcmdldFByb3BOYW1lKSB7XHJcbiAgICAgICAgcHJvcFR5cGUgPSAnTmdPYmplY3QnO1xyXG4gICAgICAgIHByb3BFbnRpdHlUeXBlID0gbmdPYmplY3RQcm9wZXJ0aWVzW3Byb3BOYW1lXS50eXBlO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBOZ0xpc3RcclxuICAgIGNvbnN0IG5nTGlzdFByb3BlcnRpZXMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0xpc3QoZW50aXR5VHlwZSk7XHJcbiAgICBPYmplY3Qua2V5cyhuZ0xpc3RQcm9wZXJ0aWVzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGlmIChwcm9wTmFtZSA9PT0gdGFyZ2V0UHJvcE5hbWUpIHtcclxuICAgICAgICBwcm9wVHlwZSA9ICdOZ0xpc3QnO1xyXG4gICAgICAgIHByb3BFbnRpdHlUeXBlID0gbmdMaXN0UHJvcGVydGllc1twcm9wTmFtZV0udHlwZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgbmdEeW5hbWljUHJvcGVydGllcyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nRHluYW1pYyhlbnRpdHlUeXBlKTtcclxuICAgIE9iamVjdC5rZXlzKG5nRHluYW1pY1Byb3BlcnRpZXMpLmZvckVhY2goKHByb3BOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgaWYgKHByb3BOYW1lID09PSB0YXJnZXRQcm9wTmFtZSkge1xyXG4gICAgICAgIHByb3BUeXBlID0gJ05nRHluYW1pYyc7XHJcbiAgICAgICAgcHJvcEVudGl0eVR5cGUgPSBuZ0R5bmFtaWNQcm9wZXJ0aWVzW3Byb3BOYW1lXS50eXBlO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4geyBwcm9wVHlwZSwgcHJvcEVudGl0eVR5cGUgfTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWunuS9k+eahOS4u+mUruWQjVxyXG4gICAqIEBwYXJhbSBlbnRpdHlUeXBlIOWunuS9k+exu+Wei1xyXG4gICAqL1xyXG4gIHN0YXRpYyBnZXRQcmltYXJ5S2V5KGVudGl0eVR5cGU6IGFueSkge1xyXG4gICAgY29uc3QgcHJpbWFyeU5nRmlsZWRQcm9wID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0UHJpbWFyeUZpZWxkTWV0YWRhdGEoZW50aXR5VHlwZSk7XHJcbiAgICBpZiAocHJpbWFyeU5nRmlsZWRQcm9wKSB7XHJcbiAgICAgIHJldHVybiBwcmltYXJ5TmdGaWxlZFByb3AuZGF0YUZpZWxkO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5piv5ZCm5Li65a+56LGh5bGe5oCnXHJcbiAgICovXHJcbiAgc3RhdGljIGlzT2JqZWN0UHJvcChlbnRpdHlUeXBlOiBhbnksIHRhcmdldFByb3BOYW1lOiBzdHJpbmcsKSB7XHJcbiAgICBsZXQgaXNPYmplY3RQcm9wID0gZmFsc2U7XHJcbiAgICBjb25zdCBuZ09iamVjdFByb3BlcnRpZXMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ09iamVjdHMoZW50aXR5VHlwZSk7XHJcbiAgICBPYmplY3Qua2V5cyhuZ09iamVjdFByb3BlcnRpZXMpLmZvckVhY2goKHByb3BOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgaWYgKHByb3BOYW1lID09PSB0YXJnZXRQcm9wTmFtZSkge1xyXG4gICAgICAgIGlzT2JqZWN0UHJvcCA9IHRydWU7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGlzT2JqZWN0UHJvcDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOajgOafpeaYr+WQpuaYr+WKqOaAgeWIl+WxnuaAp1xyXG4gICAqL1xyXG4gIHN0YXRpYyBpc0R5bmFtaWNQcm9wKGVudGl0eVR5cGU6IGFueSwgdGFyZ2V0UHJvcE5hbWU6IHN0cmluZykge1xyXG4gICAgbGV0IGlzRHluYW1pY1Byb3AgPSBmYWxzZTtcclxuICAgIGNvbnN0IG5nRHluYW1pY1Byb3BlcnRpZXMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0R5bmFtaWMoZW50aXR5VHlwZSk7XHJcbiAgICBPYmplY3Qua2V5cyhuZ0R5bmFtaWNQcm9wZXJ0aWVzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGlmIChwcm9wTmFtZSA9PT0gdGFyZ2V0UHJvcE5hbWUpIHtcclxuICAgICAgICBpc0R5bmFtaWNQcm9wID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gaXNEeW5hbWljUHJvcDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOS4uuWunuS9k+WinuWKoGluaXRpYWxEYXRh5bGe5oCnXHJcbiAgICogQHBhcmFtIGVudGl0eSDlrp7kvZPlrp7kvotcclxuICAgKiBAcGFyYW0gaW5pdGlhbERhdGEg6buY6K6k5YC85a+56LGhXHJcbiAgICovXHJcbiAgc3RhdGljIGFwcGVuZEluaXRpYWxEYXRhKGVudGl0eSwgaW5pdGlhbERhdGEpIHtcclxuICAgIGNvbnN0IGRhdGEgPSBPYmplY3QuYXNzaWduKHt9LCBpbml0aWFsRGF0YSk7XHJcbiAgICBkZWxldGUgZGF0YS5pZDtcclxuICAgIGRlbGV0ZSBkYXRhLnBhcmVudElEO1xyXG4gICAgZW50aXR5Wydpbml0aWFsRGF0YSddID0gZGF0YTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IEVudGl0eVV0aWwgfTtcclxuIl19