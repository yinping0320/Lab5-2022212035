import { ModifyType } from "../changeset";
import { Entity } from "./entity";
import { DynamicFactory, EntityFactory } from "./entity_factory";
import { EntityList } from "./entity_list";
import { FieldMetadataUtil } from "./metadata";
import { PARENT_CLASS, PARENT_PATH } from "./types";
export class EntityTypeCreator {
    static create(constructor, data) {
        const entityType = this.getType(constructor);
        const entity = new entityType(data);
        entity.constructor = constructor;
        return entity;
    }
    // @Cache({ key: ((context: any, args: any[]) => { return args[0] }), provider: new MemoryCacheProvider() })
    static createType(constructor) {
        const entityType = class EntityType extends Entity {
            constructor(data) {
                super(data);
            }
        };
        const entityPrototype = entityType.prototype;
        this.extendProperties(constructor, entityPrototype);
        return entityType;
    }
    static extendProperties(constructor, entityPrototype) {
        const ngFields = FieldMetadataUtil.getNgFields(constructor);
        const ngObjects = FieldMetadataUtil.getNgObjects(constructor);
        const ngLists = FieldMetadataUtil.getNgList(constructor);
        const ngDynamic = FieldMetadataUtil.getNgDynamic(constructor);
        this.extendPlainProperty(entityPrototype, ngFields);
        this.extendListProperty(entityPrototype, ngLists);
        this.extendObjectProperty(entityPrototype, ngObjects);
        this.extendDynamicProperty(entityPrototype, ngDynamic);
    }
    static extendPlainProperty(entityPrototype, ngFields) {
        Object.keys(ngFields).forEach(function (propName) {
            const ngField = ngFields[propName];
            // const dataField = ngField.dataField || propName;
            Object.defineProperty(entityPrototype, propName, {
                get: function () {
                    const value = this.getPropValue(propName, ngField);
                    return value;
                },
                set: function (newPropValue) {
                    // 值相同时不触发变更。
                    const oldPropValue = this.getPropValue(propName, ngField);
                    if (this.isPropValueChanged(propName, ngField, newPropValue, oldPropValue) === false) {
                        return;
                    }
                    this.setPropValue(propName, ngField, newPropValue);
                    const changeSetValue = this.preparePropValue(propName, ngField, newPropValue);
                    this.emitValueChange(propName, ngField, newPropValue, oldPropValue, changeSetValue);
                }
            });
        });
    }
    static extendListProperty(entityPrototype, ngListMetadata) {
        Object.keys(ngListMetadata).forEach(function (propertyName) {
            const key = `__${propertyName}__`;
            Object.defineProperty(entityPrototype, propertyName, {
                get: function () {
                    let entityList = this[key];
                    if (!entityList) {
                        const fieldMetadata = ngListMetadata[propertyName];
                        const path = this.createPath(propertyName);
                        const dataField = fieldMetadata.dataField || propertyName;
                        const val = this.data[dataField];
                        entityList = new EntityList();
                        entityList[PARENT_CLASS] = this;
                        entityList[PARENT_PATH] = path;
                        if (val) {
                            const entities = val.map(v => EntityFactory(fieldMetadata.type, v));
                            entityList.loadEntities(entities);
                        }
                        entityList.onListChanged.subscribe(value => {
                            if (value) {
                                if (entityList[PARENT_PATH][0] !== value.path[0]) {
                                    value.path = entityList[PARENT_PATH].concat(value.path);
                                }
                                this.setChanges(value);
                            }
                        });
                        this[key] = entityList;
                    }
                    return entityList;
                },
                set: function (value) {
                    this[key] = value;
                }
            });
        });
    }
    static extendObjectProperty(entityPrototype, ngObjectMetadata) {
        Object.keys(ngObjectMetadata).forEach(function (propertyName) {
            const fieldMetadata = ngObjectMetadata[propertyName];
            const key = `__${propertyName}__`;
            // 如果没有值用一个空对象代替
            Object.defineProperty(entityPrototype, propertyName, {
                get: function () {
                    let childEntity = this[key];
                    const path = this.createPath(propertyName);
                    if (!childEntity) {
                        const dataField = fieldMetadata.dataField || propertyName;
                        // val不存在时，用空对象代替
                        const val = this.data[dataField] || {};
                        childEntity = EntityTypeCreator.buildEntity(path, val, this, fieldMetadata);
                        this[key] = childEntity;
                    }
                    return childEntity;
                },
                set: function (value) {
                    const path = this.createPath(propertyName);
                    const modifyInfo = {
                        path: path,
                        value: value.data,
                        preValue: this[propertyName].data,
                        type: ModifyType.ValueChange
                    };
                    const childEntity = EntityTypeCreator.buildEntity(path, value, this, fieldMetadata);
                    this[key] = childEntity;
                    this.setChanges(modifyInfo);
                }
            });
        });
    }
    static extendDynamicProperty(entityPrototype, ngDynamicMetadata) {
        Object.keys(ngDynamicMetadata).forEach(function (propertyName) {
            const fieldMetadata = ngDynamicMetadata[propertyName];
            const key = `__${propertyName}__`;
            Object.defineProperty(entityPrototype, propertyName, {
                get: function () {
                    let dynamicEntity = this[key];
                    const path = this.createPath(propertyName);
                    if (!dynamicEntity) {
                        const dataField = fieldMetadata.dataField || propertyName;
                        const originalData = this.data[dataField] || {};
                        dynamicEntity = EntityTypeCreator.buildDynamic(path, originalData, this, fieldMetadata);
                        this[key] = dynamicEntity;
                    }
                    return dynamicEntity;
                },
                set: function (value) {
                    const path = this.createPath(propertyName);
                    const modifyInfo = {
                        path: path,
                        value: value.data,
                        preValue: this[propertyName].data,
                        type: ModifyType.ValueChange
                    };
                    let dynamicEntity = EntityTypeCreator.buildDynamic(path, value, this, fieldMetadata);
                    this[key] = dynamicEntity;
                    this.setChanges(modifyInfo);
                }
            });
        });
    }
    static getType(constructor) {
        if (this.buffer.has(constructor)) {
            return this.buffer.get(constructor);
        }
        const entityType = this.createType(constructor);
        this.buffer.set(constructor, entityType);
        return entityType;
    }
    static buildEntity(parentPath, value, parent, fieldMetadata) {
        let instance;
        if (value instanceof fieldMetadata.type) {
            instance = value;
        }
        else {
            instance = EntityFactory(fieldMetadata.type, value);
        }
        instance[PARENT_CLASS] = parent;
        instance[PARENT_PATH] = parentPath;
        instance.onValueChanged.subscribe(changes => {
            if (changes) {
                changes.path = (parent[PARENT_PATH] || []).concat(changes.path);
                const change = Object.assign({}, changes, { fromParent: true });
                parent.setChanges(change);
            }
        });
        return instance;
    }
    static buildDynamic(parentPath, value, parent, fieldMetadata) {
        let instance;
        if (value instanceof fieldMetadata.type) {
            instance = value;
        }
        else {
            instance = DynamicFactory(fieldMetadata.type, value);
        }
        instance[PARENT_CLASS] = parent;
        instance[PARENT_PATH] = parentPath;
        instance.onValueChanged.subscribe(changes => {
            if (changes) {
                changes.path = (parent[PARENT_PATH] || []).concat(changes.path);
                parent.setChanges(changes);
            }
        });
        return instance;
    }
}
EntityTypeCreator.buffer = new Map();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X3R5cGVfY3JlYXRvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2VudGl0eS9lbnRpdHlfdHlwZV9jcmVhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDMUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNsQyxPQUFPLEVBQUUsY0FBYyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGlCQUFpQixFQUF3RSxNQUFNLFlBQVksQ0FBQztBQUNySCxPQUFPLEVBQWEsWUFBWSxFQUFFLFdBQVcsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUUvRCxNQUFNLE9BQU8saUJBQWlCO0lBRXJCLE1BQU0sQ0FBQyxNQUFNLENBQUMsV0FBcUIsRUFBRSxJQUFTO1FBQ25ELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDN0MsTUFBTSxNQUFNLEdBQUcsSUFBSSxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDcEMsTUFBTSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7UUFDakMsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUNELDRHQUE0RztJQUNyRyxNQUFNLENBQUMsVUFBVSxDQUFDLFdBQXFCO1FBQzVDLE1BQU0sVUFBVSxHQUFHLE1BQU0sVUFBVyxTQUFRLE1BQU07WUFDaEQsWUFBWSxJQUFTO2dCQUNuQixLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDZCxDQUFDO1NBQ0YsQ0FBQztRQUNGLE1BQU0sZUFBZSxHQUFHLFVBQVUsQ0FBQyxTQUFTLENBQUM7UUFDN0MsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxlQUFlLENB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QUFDO1FBQ25DLFFBQVEsQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQzFDLElBQUksT0FBTyxFQUFFO2dCQUNYLE9BQU8sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDaEUsTUFBTSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUM1QjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQzs7QUFsTWMsd0JBQU0sR0FBRyxJQUFJLEdBQUcsRUFBWSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTW9kaWZ5VHlwZSB9IGZyb20gXCIuLi9jaGFuZ2VzZXRcIjtcclxuaW1wb3J0IHsgRW50aXR5IH0gZnJvbSBcIi4vZW50aXR5XCI7XHJcbmltcG9ydCB7IER5bmFtaWNGYWN0b3J5LCBFbnRpdHlGYWN0b3J5IH0gZnJvbSBcIi4vZW50aXR5X2ZhY3RvcnlcIjtcclxuaW1wb3J0IHsgRW50aXR5TGlzdCB9IGZyb20gXCIuL2VudGl0eV9saXN0XCI7XHJcbmltcG9ydCB7IEZpZWxkTWV0YWRhdGFVdGlsLCBOZ0R5bmFtaWNQcm9wZXJ0eSwgTmdGaWVsZFByb3BlcnR5LCBOZ0xpc3RQcm9wZXJ0eSwgTmdPYmplY3RQcm9wZXJ0eSB9IGZyb20gXCIuL21ldGFkYXRhXCI7XHJcbmltcG9ydCB7IENsYXNzVHlwZSwgUEFSRU5UX0NMQVNTLCBQQVJFTlRfUEFUSCB9IGZyb20gXCIuL3R5cGVzXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgRW50aXR5VHlwZUNyZWF0b3Ige1xyXG4gIHByaXZhdGUgc3RhdGljIGJ1ZmZlciA9IG5ldyBNYXA8YW55LCBhbnk+KCk7XHJcbiAgcHVibGljIHN0YXRpYyBjcmVhdGUoY29uc3RydWN0b3I6IEZ1bmN0aW9uLCBkYXRhOiBhbnkpOiBFbnRpdHkge1xyXG4gICAgY29uc3QgZW50aXR5VHlwZSA9IHRoaXMuZ2V0VHlwZShjb25zdHJ1Y3Rvcik7XHJcbiAgICBjb25zdCBlbnRpdHkgPSBuZXcgZW50aXR5VHlwZShkYXRhKTtcclxuICAgIGVudGl0eS5jb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yO1xyXG4gICAgcmV0dXJuIGVudGl0eTtcclxuICB9XHJcbiAgLy8gQENhY2hlKHsga2V5OiAoKGNvbnRleHQ6IGFueSwgYXJnczogYW55W10pID0+IHsgcmV0dXJuIGFyZ3NbMF0gfSksIHByb3ZpZGVyOiBuZXcgTWVtb3J5Q2FjaGVQcm92aWRlcigpIH0pXHJcbiAgcHVibGljIHN0YXRpYyBjcmVhdGVUeXBlKGNvbnN0cnVjdG9yOiBGdW5jdGlvbik6IENsYXNzVHlwZTxFbnRpdHk+IHtcclxuICAgIGNvbnN0IGVudGl0eVR5cGUgPSBjbGFzcyBFbnRpdHlUeXBlIGV4dGVuZHMgRW50aXR5IHtcclxuICAgICAgY29uc3RydWN0b3IoZGF0YTogYW55KSB7XHJcbiAgICAgICAgc3VwZXIoZGF0YSk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICBjb25zdCBlbnRpdHlQcm90b3R5cGUgPSBlbnRpdHlUeXBlLnByb3RvdHlwZTtcclxuICAgIHRoaXMuZXh0ZW5kUHJvcGVydGllcyhjb25zdHJ1Y3RvciwgZW50aXR5UHJvdG90eXBlKTtcclxuICAgIHJldHVybiBlbnRpdHlUeXBlO1xyXG4gIH1cclxuICBwcml2YXRlIHN0YXRpYyBleHRlbmRQcm9wZXJ0aWVzKGNvbnN0cnVjdG9yOiBGdW5jdGlvbiwgZW50aXR5UHJvdG90eXBlOiBFbnRpdHkpIHtcclxuICAgIGNvbnN0IG5nRmllbGRzID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdGaWVsZHMoY29uc3RydWN0b3IpO1xyXG4gICAgY29uc3QgbmdPYmplY3RzID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdPYmplY3RzKGNvbnN0cnVjdG9yKTtcclxuICAgIGNvbnN0IG5nTGlzdHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0xpc3QoY29uc3RydWN0b3IpO1xyXG4gICAgY29uc3QgbmdEeW5hbWljID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdEeW5hbWljKGNvbnN0cnVjdG9yKTtcclxuICAgIHRoaXMuZXh0ZW5kUGxhaW5Qcm9wZXJ0eShlbnRpdHlQcm90b3R5cGUsIG5nRmllbGRzKTtcclxuICAgIHRoaXMuZXh0ZW5kTGlzdFByb3BlcnR5KGVudGl0eVByb3RvdHlwZSwgbmdMaXN0cyk7XHJcbiAgICB0aGlzLmV4dGVuZE9iamVjdFByb3BlcnR5KGVudGl0eVByb3RvdHlwZSwgbmdPYmplY3RzKTtcclxuICAgIHRoaXMuZXh0ZW5kRHluYW1pY1Byb3BlcnR5KGVudGl0eVByb3RvdHlwZSwgbmdEeW5hbWljKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZFBsYWluUHJvcGVydHkoZW50aXR5UHJvdG90eXBlOiBFbnRpdHksIG5nRmllbGRzOiB7IFtrZXk6IHN0cmluZ106IE5nRmllbGRQcm9wZXJ0eSB9KTogdm9pZCB7XHJcbiAgICBPYmplY3Qua2V5cyhuZ0ZpZWxkcykuZm9yRWFjaChmdW5jdGlvbiAocHJvcE5hbWUpIHtcclxuICAgICAgY29uc3QgbmdGaWVsZCA9IG5nRmllbGRzW3Byb3BOYW1lXSBhcyBOZ0ZpZWxkUHJvcGVydHk7XHJcbiAgICAgIC8vIGNvbnN0IGRhdGFGaWVsZCA9IG5nRmllbGQuZGF0YUZpZWxkIHx8IHByb3BOYW1lO1xyXG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZW50aXR5UHJvdG90eXBlLCBwcm9wTmFtZSwge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldFByb3BWYWx1ZShwcm9wTmFtZSwgbmdGaWVsZCk7XHJcbiAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXQ6IGZ1bmN0aW9uIChuZXdQcm9wVmFsdWUpIHtcclxuICAgICAgICAgIC8vIOWAvOebuOWQjOaXtuS4jeinpuWPkeWPmOabtOOAglxyXG4gICAgICAgICAgY29uc3Qgb2xkUHJvcFZhbHVlID0gdGhpcy5nZXRQcm9wVmFsdWUocHJvcE5hbWUsIG5nRmllbGQpO1xyXG4gICAgICAgICAgaWYgKHRoaXMuaXNQcm9wVmFsdWVDaGFuZ2VkKHByb3BOYW1lLCBuZ0ZpZWxkLCBuZXdQcm9wVmFsdWUsIG9sZFByb3BWYWx1ZSkgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHRoaXMuc2V0UHJvcFZhbHVlKHByb3BOYW1lLCBuZ0ZpZWxkLCBuZXdQcm9wVmFsdWUpO1xyXG4gICAgICAgICAgY29uc3QgY2hhbmdlU2V0VmFsdWUgPSB0aGlzLnByZXBhcmVQcm9wVmFsdWUocHJvcE5hbWUsIG5nRmllbGQsIG5ld1Byb3BWYWx1ZSk7XHJcbiAgICAgICAgICB0aGlzLmVtaXRWYWx1ZUNoYW5nZShwcm9wTmFtZSwgbmdGaWVsZCwgbmV3UHJvcFZhbHVlLCBvbGRQcm9wVmFsdWUsIGNoYW5nZVNldFZhbHVlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZExpc3RQcm9wZXJ0eShlbnRpdHlQcm90b3R5cGU6IEVudGl0eSwgbmdMaXN0TWV0YWRhdGE6IHsgW2tleTogc3RyaW5nXTogTmdMaXN0UHJvcGVydHkgfSk6IHZvaWQge1xyXG4gICAgT2JqZWN0LmtleXMobmdMaXN0TWV0YWRhdGEpLmZvckVhY2goZnVuY3Rpb24gKHByb3BlcnR5TmFtZSkge1xyXG4gICAgICBjb25zdCBrZXkgPSBgX18ke3Byb3BlcnR5TmFtZX1fX2A7XHJcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbnRpdHlQcm90b3R5cGUsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgbGV0IGVudGl0eUxpc3QgPSB0aGlzW2tleV07XHJcbiAgICAgICAgICBpZiAoIWVudGl0eUxpc3QpIHtcclxuICAgICAgICAgICAgY29uc3QgZmllbGRNZXRhZGF0YSA9IG5nTGlzdE1ldGFkYXRhW3Byb3BlcnR5TmFtZV0gYXMgTmdMaXN0UHJvcGVydHk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmNyZWF0ZVBhdGgocHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgICAgY29uc3QgZGF0YUZpZWxkID0gZmllbGRNZXRhZGF0YS5kYXRhRmllbGQgfHwgcHJvcGVydHlOYW1lO1xyXG4gICAgICAgICAgICBjb25zdCB2YWwgPSB0aGlzLmRhdGFbZGF0YUZpZWxkXTtcclxuICAgICAgICAgICAgZW50aXR5TGlzdCA9IG5ldyBFbnRpdHlMaXN0PHR5cGVvZiBmaWVsZE1ldGFkYXRhLnR5cGU+KCk7XHJcbiAgICAgICAgICAgIGVudGl0eUxpc3RbUEFSRU5UX0NMQVNTXSA9IHRoaXM7XHJcbiAgICAgICAgICAgIGVudGl0eUxpc3RbUEFSRU5UX1BBVEhdID0gcGF0aDtcclxuICAgICAgICAgICAgaWYgKHZhbCkge1xyXG4gICAgICAgICAgICAgIGNvbnN0IGVudGl0aWVzID0gdmFsLm1hcCh2ID0+IEVudGl0eUZhY3Rvcnk8dHlwZW9mIGZpZWxkTWV0YWRhdGEudHlwZT4oZmllbGRNZXRhZGF0YS50eXBlLCB2KSk7XHJcbiAgICAgICAgICAgICAgZW50aXR5TGlzdC5sb2FkRW50aXRpZXMoZW50aXRpZXMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVudGl0eUxpc3Qub25MaXN0Q2hhbmdlZC5zdWJzY3JpYmUodmFsdWUgPT4ge1xyXG4gICAgICAgICAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVudGl0eUxpc3RbUEFSRU5UX1BBVEhdWzBdICE9PSB2YWx1ZS5wYXRoWzBdKSB7XHJcbiAgICAgICAgICAgICAgICAgIHZhbHVlLnBhdGggPSBlbnRpdHlMaXN0W1BBUkVOVF9QQVRIXS5jb25jYXQodmFsdWUucGF0aCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldENoYW5nZXModmFsdWUpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXNba2V5XSA9IGVudGl0eUxpc3Q7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gZW50aXR5TGlzdDtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7XHJcbiAgICAgICAgICB0aGlzW2tleV0gPSB2YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZE9iamVjdFByb3BlcnR5KGVudGl0eVByb3RvdHlwZTogRW50aXR5LCBuZ09iamVjdE1ldGFkYXRhOiB7IFtrZXk6IHN0cmluZ106IE5nT2JqZWN0UHJvcGVydHkgfSkge1xyXG4gICAgT2JqZWN0LmtleXMobmdPYmplY3RNZXRhZGF0YSkuZm9yRWFjaChmdW5jdGlvbiAocHJvcGVydHlOYW1lKSB7XHJcbiAgICAgIGNvbnN0IGZpZWxkTWV0YWRhdGEgPSBuZ09iamVjdE1ldGFkYXRhW3Byb3BlcnR5TmFtZV0gYXMgTmdPYmplY3RQcm9wZXJ0eTtcclxuICAgICAgY29uc3Qga2V5ID0gYF9fJHtwcm9wZXJ0eU5hbWV9X19gO1xyXG4gICAgICAvLyDlpoLmnpzmsqHmnInlgLznlKjkuIDkuKrnqbrlr7nosaHku6Pmm79cclxuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVudGl0eVByb3RvdHlwZSwgcHJvcGVydHlOYW1lLCB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICBsZXQgY2hpbGRFbnRpdHkgPSB0aGlzW2tleV07XHJcbiAgICAgICAgICBjb25zdCBwYXRoID0gdGhpcy5jcmVhdGVQYXRoKHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICBpZiAoIWNoaWxkRW50aXR5KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IGZpZWxkTWV0YWRhdGEuZGF0YUZpZWxkIHx8IHByb3BlcnR5TmFtZTtcclxuICAgICAgICAgICAgLy8gdmFs5LiN5a2Y5Zyo5pe277yM55So56m65a+56LGh5Luj5pu/XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbCA9IHRoaXMuZGF0YVtkYXRhRmllbGRdIHx8IHt9O1xyXG4gICAgICAgICAgICBjaGlsZEVudGl0eSA9IEVudGl0eVR5cGVDcmVhdG9yLmJ1aWxkRW50aXR5KHBhdGgsIHZhbCwgdGhpcywgZmllbGRNZXRhZGF0YSk7XHJcbiAgICAgICAgICAgIHRoaXNba2V5XSA9IGNoaWxkRW50aXR5O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIGNoaWxkRW50aXR5O1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWU6IGFueSkge1xyXG4gICAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuY3JlYXRlUGF0aChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgY29uc3QgbW9kaWZ5SW5mbyA9IHtcclxuICAgICAgICAgICAgcGF0aDogcGF0aCxcclxuICAgICAgICAgICAgdmFsdWU6IHZhbHVlLmRhdGEsXHJcbiAgICAgICAgICAgIHByZVZhbHVlOiB0aGlzW3Byb3BlcnR5TmFtZV0uZGF0YSxcclxuICAgICAgICAgICAgdHlwZTogTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZVxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIGNvbnN0IGNoaWxkRW50aXR5ID0gRW50aXR5VHlwZUNyZWF0b3IuYnVpbGRFbnRpdHkocGF0aCwgdmFsdWUsIHRoaXMsIGZpZWxkTWV0YWRhdGEpO1xyXG4gICAgICAgICAgdGhpc1trZXldID0gY2hpbGRFbnRpdHk7XHJcbiAgICAgICAgICB0aGlzLnNldENoYW5nZXMobW9kaWZ5SW5mbyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIHN0YXRpYyBleHRlbmREeW5hbWljUHJvcGVydHkoZW50aXR5UHJvdG90eXBlOiBFbnRpdHksIG5nRHluYW1pY01ldGFkYXRhOiB7IFtrZXk6IHN0cmluZ106IE5nRHluYW1pY1Byb3BlcnR5IH0pIHtcclxuICAgIE9iamVjdC5rZXlzKG5nRHluYW1pY01ldGFkYXRhKS5mb3JFYWNoKGZ1bmN0aW9uIChwcm9wZXJ0eU5hbWUpIHtcclxuICAgICAgY29uc3QgZmllbGRNZXRhZGF0YSA9IG5nRHluYW1pY01ldGFkYXRhW3Byb3BlcnR5TmFtZV0gYXMgTmdEeW5hbWljUHJvcGVydHk7XHJcbiAgICAgIGNvbnN0IGtleSA9IGBfXyR7cHJvcGVydHlOYW1lfV9fYDtcclxuXHJcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbnRpdHlQcm90b3R5cGUsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgbGV0IGR5bmFtaWNFbnRpdHkgPSB0aGlzW2tleV07XHJcbiAgICAgICAgICBjb25zdCBwYXRoID0gdGhpcy5jcmVhdGVQYXRoKHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICBpZiAoIWR5bmFtaWNFbnRpdHkpIHtcclxuICAgICAgICAgICAgY29uc3QgZGF0YUZpZWxkID0gZmllbGRNZXRhZGF0YS5kYXRhRmllbGQgfHwgcHJvcGVydHlOYW1lO1xyXG4gICAgICAgICAgICBjb25zdCBvcmlnaW5hbERhdGEgPSB0aGlzLmRhdGFbZGF0YUZpZWxkXSB8fCB7fTtcclxuICAgICAgICAgICAgZHluYW1pY0VudGl0eSA9IEVudGl0eVR5cGVDcmVhdG9yLmJ1aWxkRHluYW1pYyhwYXRoLCBvcmlnaW5hbERhdGEsIHRoaXMsIGZpZWxkTWV0YWRhdGEpO1xyXG4gICAgICAgICAgICB0aGlzW2tleV0gPSBkeW5hbWljRW50aXR5O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIGR5bmFtaWNFbnRpdHk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuY3JlYXRlUGF0aChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgY29uc3QgbW9kaWZ5SW5mbyA9IHtcclxuICAgICAgICAgICAgcGF0aDogcGF0aCxcclxuICAgICAgICAgICAgdmFsdWU6IHZhbHVlLmRhdGEsXHJcbiAgICAgICAgICAgIHByZVZhbHVlOiB0aGlzW3Byb3BlcnR5TmFtZV0uZGF0YSxcclxuICAgICAgICAgICAgdHlwZTogTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZVxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIGxldCBkeW5hbWljRW50aXR5ID0gRW50aXR5VHlwZUNyZWF0b3IuYnVpbGREeW5hbWljKHBhdGgsIHZhbHVlLCB0aGlzLCBmaWVsZE1ldGFkYXRhKTtcclxuICAgICAgICAgIHRoaXNba2V5XSA9IGR5bmFtaWNFbnRpdHk7XHJcbiAgICAgICAgICB0aGlzLnNldENoYW5nZXMobW9kaWZ5SW5mbyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIHN0YXRpYyBnZXRUeXBlKGNvbnN0cnVjdG9yOiBGdW5jdGlvbikge1xyXG4gICAgaWYgKHRoaXMuYnVmZmVyLmhhcyhjb25zdHJ1Y3RvcikpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuYnVmZmVyLmdldChjb25zdHJ1Y3Rvcik7XHJcbiAgICB9XHJcbiAgICBjb25zdCBlbnRpdHlUeXBlID0gdGhpcy5jcmVhdGVUeXBlKGNvbnN0cnVjdG9yKTtcclxuICAgIHRoaXMuYnVmZmVyLnNldChjb25zdHJ1Y3RvciwgZW50aXR5VHlwZSk7XHJcbiAgICByZXR1cm4gZW50aXR5VHlwZTtcclxuICB9XHJcbiAgcHJpdmF0ZSBzdGF0aWMgYnVpbGRFbnRpdHkocGFyZW50UGF0aDogc3RyaW5nW10sIHZhbHVlOiBhbnksIHBhcmVudDogYW55LCBmaWVsZE1ldGFkYXRhOiBOZ09iamVjdFByb3BlcnR5IHwgTmdEeW5hbWljUHJvcGVydHkpIHtcclxuICAgIGxldCBpbnN0YW5jZTtcclxuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGZpZWxkTWV0YWRhdGEudHlwZSkge1xyXG4gICAgICBpbnN0YW5jZSA9IHZhbHVlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaW5zdGFuY2UgPSBFbnRpdHlGYWN0b3J5KGZpZWxkTWV0YWRhdGEudHlwZSwgdmFsdWUpO1xyXG4gICAgfVxyXG4gICAgaW5zdGFuY2VbUEFSRU5UX0NMQVNTXSA9IHBhcmVudDtcclxuICAgIGluc3RhbmNlW1BBUkVOVF9QQVRIXSA9IHBhcmVudFBhdGg7XHJcbiAgICBpbnN0YW5jZS5vblZhbHVlQ2hhbmdlZC5zdWJzY3JpYmUoY2hhbmdlcyA9PiB7XHJcbiAgICAgIGlmIChjaGFuZ2VzKSB7XHJcbiAgICAgICAgY2hhbmdlcy5wYXRoID0gKHBhcmVudFtQQVJFTlRfUEFUSF0gfHwgW10pLmNvbmNhdChjaGFuZ2VzLnBhdGgpO1xyXG4gICAgICAgIGNvbnN0IGNoYW5nZSA9IE9iamVjdC5hc3NpZ24oe30sIGNoYW5nZXMsIHsgZnJvbVBhcmVudDogdHJ1ZSB9KTtcclxuICAgICAgICBwYXJlbnQuc2V0Q2hhbmdlcyhjaGFuZ2UpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBpbnN0YW5jZTtcclxuICB9XHJcbiAgcHJpdmF0ZSBzdGF0aWMgYnVpbGREeW5hbWljKHBhcmVudFBhdGg6IHN0cmluZ1tdLCB2YWx1ZTogYW55LCBwYXJlbnQ6IGFueSwgZmllbGRNZXRhZGF0YTogTmdPYmplY3RQcm9wZXJ0eSB8IE5nRHluYW1pY1Byb3BlcnR5KSB7XHJcbiAgICBsZXQgaW5zdGFuY2U7XHJcbiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBmaWVsZE1ldGFkYXRhLnR5cGUpIHtcclxuICAgICAgaW5zdGFuY2UgPSB2YWx1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGluc3RhbmNlID0gRHluYW1pY0ZhY3RvcnkoZmllbGRNZXRhZGF0YS50eXBlLCB2YWx1ZSk7XHJcbiAgICB9XHJcbiAgICBpbnN0YW5jZVtQQVJFTlRfQ0xBU1NdID0gcGFyZW50O1xyXG4gICAgaW5zdGFuY2VbUEFSRU5UX1BBVEhdID0gcGFyZW50UGF0aDtcclxuICAgIGluc3RhbmNlLm9uVmFsdWVDaGFuZ2VkLnN1YnNjcmliZShjaGFuZ2VzID0+IHtcclxuICAgICAgaWYgKGNoYW5nZXMpIHtcclxuICAgICAgICBjaGFuZ2VzLnBhdGggPSAocGFyZW50W1BBUkVOVF9QQVRIXSB8fCBbXSkuY29uY2F0KGNoYW5nZXMucGF0aCk7XHJcbiAgICAgICAgcGFyZW50LnNldENoYW5nZXMoY2hhbmdlcyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGluc3RhbmNlO1xyXG4gIH1cclxufSJdfQ==