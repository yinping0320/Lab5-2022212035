import { ModifyType } from '../changeset/types';
import { PARENT_PATH, PARENT_CLASS } from './types';
import { Entity } from './entity';
import { takeUntil } from 'rxjs/operators';
/**
 * 支持动态字段集合的动态实体
 */
export class DynamicEntity extends Entity {
    /**
     * 是否是嵌套的动态实体
     */
    get IsNested() {
        return this[PARENT_CLASS] instanceof DynamicEntity;
    }
    /**
     * @param data JSON数据
     */
    constructor(data) {
        super(data);
        this.loadDynamicData(data);
    }
    loadDynamicData(dynamicData) {
        this.initializeDynamicField(dynamicData);
        // super.loadFields(dynamicData);
    }
    /**
     * 初始化动态数据
     * @param dynamicData 动态数据
     */
    initializeDynamicField(dynamicData) {
        // 遍历动态数据的key，创建动态实体属性。
        Object.keys(dynamicData).forEach(propertyName => {
            const dataField = propertyName;
            if (delete this[propertyName]) {
                if (dynamicData[propertyName] instanceof Object) {
                    const path = this.createPath(propertyName);
                    let dynamicEntity = this.createDynamicEntityFromJsonData(dynamicData[propertyName], path);
                    // this.constructor['__prop__metadata__'] = this.constructor['__prop__metadata__'] || {};
                    // NgObject({
                    //     /** 字段名称 */
                    //     dataField: propertyName,
                    //     /** 原始字段名称 */
                    //     originalDataField: propertyName,
                    //     /** 是否为外键 */
                    //     type: DynamicEntity
                    // })(this, propertyName);
                    Object.defineProperty(this, propertyName, {
                        get: function () {
                            return dynamicEntity;
                        },
                        set: function (value) {
                            const modifyInfo = {
                                path: dynamicEntity[PARENT_PATH],
                                value: value.data,
                                preValue: this[propertyName].data,
                                type: ModifyType.ValueChange
                            };
                            dynamicEntity = this.createDynamicEntityFromJsonData(value, path);
                            this.setChanges(modifyInfo);
                        }
                    });
                }
                else {
                    // this.constructor['__prop__metadata__'] = this.constructor['__prop__metadata__'] || {};
                    // NgField({
                    //     /** 字段名称 */
                    //     dataField: propertyName,
                    //     /** 原始字段名称 */
                    //     originalDataField: propertyName,
                    //     /** 是否为主键 */
                    //     primary: false,
                    //     /** 是否为外键 */
                    //     foreign: false
                    // })(this, propertyName);
                    Object.defineProperty(this, propertyName, {
                        // 定义返回数据方法。
                        get: function () {
                            // 从初始数据返回字段值。
                            return this.data[dataField];
                        },
                        set: function (value) {
                            // 值相同时不触发变更。
                            const oldValue = this.data[dataField];
                            if (oldValue === value) {
                                return;
                            }
                            // 更新元数据数据。
                            this.data[dataField] = value;
                            // 变更集
                            const changes = {
                                type: ModifyType.ValueChange,
                                path: this.createPath(propertyName),
                                value: value,
                                preValue: oldValue
                            };
                            if (this[PARENT_PATH]) {
                                changes.path = this[PARENT_PATH].concat(changes.path);
                            }
                            this.setChanges(changes);
                        }
                    });
                }
            }
        });
    }
    createDynamicEntityFromJsonData(value, parentPath) {
        let instance;
        if (value instanceof DynamicEntity) {
            instance = value;
        }
        else {
            instance = new DynamicEntity(value);
            instance.constructor = DynamicEntity;
        }
        instance[PARENT_CLASS] = this;
        instance[PARENT_PATH] = parentPath;
        instance.onValueChanged.pipe(takeUntil(this.unsubscribe)).subscribe(changes => {
            if (changes) {
                changes.path = (this[PARENT_PATH] || []).concat(changes.path);
                this.setChanges(changes);
            }
        });
        return instance;
    }
    /**
     * 将变更记录保存至变更集中
     * @param value 变更记录
     * @todo
     * 1、preValue的处理有问题，下级传递上来的变更这样可以，根DyanmicaEntity上的，data已经发生变化，prevalue和value是一样了；
     * 2、当value是下级冒泡上来的，需要根据value去更新当前层级的data，该逻辑不应该放在setChagnes，待修改。
     */
    setChanges(value) {
        const propertyName = value.path[value.path.length - 1];
        const preValue = Object.assign({}, this.data);
        this.newData = Object.assign(this.newData, { [propertyName]: value.value });
        let parentPath = value.path;
        if (value.path.length > 2) {
            parentPath = value.path.slice(0, value.path.length - 2);
        }
        // 统一不使用构造函数（保持和其他位置对Modification的构造一致）
        // const parentModification = new Modification(this.data, value.type, parentPath, preValue);
        const parentModification = {
            path: parentPath,
            value: this.data,
            preValue: preValue,
            type: value.type,
            dynamic: true
        };
        this.valueChanged.next(parentModification);
        this.changeSet.append(value);
    }
    /**
     * toJSON
     */
    toJSON() {
        return this.data;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pY19lbnRpdHkuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9lbnRpdHkvZHluYW1pY19lbnRpdHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBZ0IsTUFBTSxvQkFBb0IsQ0FBQztBQUM5RCxPQUFPLEVBQUUsV0FBVyxFQUFXLFlBQVksRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUM3RCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ2xDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUUzQzs7R0FFRztBQUNILE1BQU0sT0FBTyxhQUFjLFNBQVEsTUFBTTtJQUV2Qzs7T0FFRztJQUNILElBQVcsUUFBUTtRQUNqQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxhQUFhLENBQUM7SUFDckQsQ0FBQztJQUVEOztPQUVHO0lBQ0gsWUFBWSxJQUFTO1FBQ25CLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNaLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUVNLGVBQWUsQ0FBQyxXQUFnQjtRQUNyQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDekMsaUNBQWlDO0lBQ25DLENBQUM7SUFFRDs7O09BR0c7SUFDSyxzQkFBc0IsQ0FBQyxXQUFnQjtRQUM3Qyx1QkFBdUI7UUFDdkIsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDOUMsTUFBTSxTQUFTLEdBQUcsWUFBWSxDQUFDO1lBQy9CLElBQUksT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUU7Z0JBQzdCLElBQUksV0FBVyxDQUFDLFlBQVksQ0FBQyxZQUFZLE1BQU0sRUFBRTtvQkFDL0MsTUFBTSxJQUFJLEdBQUcsSUFB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TUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQ3pEO1FBRUQsdUNBQXVDO1FBQ3ZDLDRGQUE0RjtRQUM1RixNQUFNLGtCQUFrQixHQUFpQjtZQUN2QyxJQUFJLEVBQUUsVUFBVTtZQUNoQixLQUFLLEVBQUUsSUFBSSxDQUFDLElBQUk7WUFDaEIsUUFBUSxFQUFFLFFBQVE7WUFDbEIsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJO1lBQ2hCLE9BQU8sRUFBRSxJQUFJO1NBQ2QsQ0FBQztRQUVGLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVEOztPQUVHO0lBQ0ksTUFBTTtRQUNYLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUNuQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNb2RpZnlUeXBlLCBNb2RpZmljYXRpb24gfSBmcm9tICcuLi9jaGFuZ2VzZXQvdHlwZXMnO1xyXG5pbXBvcnQgeyBQQVJFTlRfUEFUSCwgRHluYW1pYywgUEFSRU5UX0NMQVNTIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IEVudGl0eSB9IGZyb20gJy4vZW50aXR5JztcclxuaW1wb3J0IHsgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuLyoqXHJcbiAqIOaUr+aMgeWKqOaAgeWtl+autembhuWQiOeahOWKqOaAgeWunuS9k1xyXG4gKi9cclxuZXhwb3J0IGNsYXNzIER5bmFtaWNFbnRpdHkgZXh0ZW5kcyBFbnRpdHkgaW1wbGVtZW50cyBEeW5hbWljIHtcclxuXHJcbiAgLyoqXHJcbiAgICog5piv5ZCm5piv5bWM5aWX55qE5Yqo5oCB5a6e5L2TXHJcbiAgICovXHJcbiAgcHVibGljIGdldCBJc05lc3RlZCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzW1BBUkVOVF9DTEFTU10gaW5zdGFuY2VvZiBEeW5hbWljRW50aXR5O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIGRhdGEgSlNPTuaVsOaNrlxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKGRhdGE6IGFueSkge1xyXG4gICAgc3VwZXIoZGF0YSk7XHJcbiAgICB0aGlzLmxvYWREeW5hbWljRGF0YShkYXRhKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBsb2FkRHluYW1pY0RhdGEoZHluYW1pY0RhdGE6IGFueSkge1xyXG4gICAgdGhpcy5pbml0aWFsaXplRHluYW1pY0ZpZWxkKGR5bmFtaWNEYXRhKTtcclxuICAgIC8vIHN1cGVyLmxvYWRGaWVsZHMoZHluYW1pY0RhdGEpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yid5aeL5YyW5Yqo5oCB5pWw5o2uXHJcbiAgICogQHBhcmFtIGR5bmFtaWNEYXRhIOWKqOaAgeaVsOaNrlxyXG4gICAqL1xyXG4gIHByaXZhdGUgaW5pdGlhbGl6ZUR5bmFtaWNGaWVsZChkeW5hbWljRGF0YTogYW55KTogdm9pZCB7XHJcbiAgICAvLyDpgY3ljobliqjmgIHmlbDmja7nmoRrZXnvvIzliJvlu7rliqjmgIHlrp7kvZPlsZ7mgKfjgIJcclxuICAgIE9iamVjdC5rZXlzKGR5bmFtaWNEYXRhKS5mb3JFYWNoKHByb3BlcnR5TmFtZSA9PiB7XHJcbiAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IHByb3BlcnR5TmFtZTtcclxuICAgICAgaWYgKGRlbGV0ZSB0aGlzW3Byb3BlcnR5TmFtZV0pIHtcclxuICAgICAgICBpZiAoZHluYW1pY0RhdGFbcHJvcGVydHlOYW1lXSBpbnN0YW5jZW9mIE9iamVjdCkge1xyXG4gICAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuY3JlYXRlUGF0aChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgbGV0IGR5bmFtaWNFbnRpdHkgPSB0aGlzLmNyZWF0ZUR5bmFtaWNFbnRpdHlGcm9tSnNvbkRhdGEoZHluYW1pY0RhdGFbcHJvcGVydHlOYW1lXSwgcGF0aCk7XHJcbiAgICAgICAgICAvLyB0aGlzLmNvbnN0cnVjdG9yWydfX3Byb3BfX21ldGFkYXRhX18nXSA9IHRoaXMuY29uc3RydWN0b3JbJ19fcHJvcF9fbWV0YWRhdGFfXyddIHx8IHt9O1xyXG4gICAgICAgICAgLy8gTmdPYmplY3Qoe1xyXG4gICAgICAgICAgLy8gICAgIC8qKiDlrZfmrrXlkI3np7AgKi9cclxuICAgICAgICAgIC8vICAgICBkYXRhRmllbGQ6IHByb3BlcnR5TmFtZSxcclxuICAgICAgICAgIC8vICAgICAvKiog5Y6f5aeL5a2X5q615ZCN56ewICovXHJcbiAgICAgICAgICAvLyAgICAgb3JpZ2luYWxEYXRhRmllbGQ6IHByb3BlcnR5TmFtZSxcclxuICAgICAgICAgIC8vICAgICAvKiog5piv5ZCm5Li65aSW6ZSuICovXHJcbiAgICAgICAgICAvLyAgICAgdHlwZTogRHluYW1pY0VudGl0eVxyXG4gICAgICAgICAgLy8gfSkodGhpcywgcHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGR5bmFtaWNFbnRpdHk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgY29uc3QgbW9kaWZ5SW5mbyA9IHtcclxuICAgICAgICAgICAgICAgIHBhdGg6IGR5bmFtaWNFbnRpdHlbUEFSRU5UX1BBVEhdLFxyXG4gICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLmRhdGEsXHJcbiAgICAgICAgICAgICAgICBwcmVWYWx1ZTogdGhpc1twcm9wZXJ0eU5hbWVdLmRhdGEsXHJcbiAgICAgICAgICAgICAgICB0eXBlOiBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlXHJcbiAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICBkeW5hbWljRW50aXR5ID0gdGhpcy5jcmVhdGVEeW5hbWljRW50aXR5RnJvbUpzb25EYXRhKHZhbHVlLCBwYXRoKTtcclxuICAgICAgICAgICAgICB0aGlzLnNldENoYW5nZXMobW9kaWZ5SW5mbyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyB0aGlzLmNvbnN0cnVjdG9yWydfX3Byb3BfX21ldGFkYXRhX18nXSA9IHRoaXMuY29uc3RydWN0b3JbJ19fcHJvcF9fbWV0YWRhdGFfXyddIHx8IHt9O1xyXG4gICAgICAgICAgLy8gTmdGaWVsZCh7XHJcbiAgICAgICAgICAvLyAgICAgLyoqIOWtl+auteWQjeensCAqL1xyXG4gICAgICAgICAgLy8gICAgIGRhdGFGaWVsZDogcHJvcGVydHlOYW1lLFxyXG4gICAgICAgICAgLy8gICAgIC8qKiDljp/lp4vlrZfmrrXlkI3np7AgKi9cclxuICAgICAgICAgIC8vICAgICBvcmlnaW5hbERhdGFGaWVsZDogcHJvcGVydHlOYW1lLFxyXG4gICAgICAgICAgLy8gICAgIC8qKiDmmK/lkKbkuLrkuLvplK4gKi9cclxuICAgICAgICAgIC8vICAgICBwcmltYXJ5OiBmYWxzZSxcclxuICAgICAgICAgIC8vICAgICAvKiog5piv5ZCm5Li65aSW6ZSuICovXHJcbiAgICAgICAgICAvLyAgICAgZm9yZWlnbjogZmFsc2VcclxuICAgICAgICAgIC8vIH0pKHRoaXMsIHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgcHJvcGVydHlOYW1lLCB7XHJcbiAgICAgICAgICAgIC8vIOWumuS5iei/lOWbnuaVsOaNruaWueazleOAglxyXG4gICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAvLyDku47liJ3lp4vmlbDmja7ov5Tlm57lrZfmrrXlgLzjgIJcclxuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRhW2RhdGFGaWVsZF07XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgLy8g5YC855u45ZCM5pe25LiN6Kem5Y+R5Y+Y5pu044CCXHJcbiAgICAgICAgICAgICAgY29uc3Qgb2xkVmFsdWUgPSB0aGlzLmRhdGFbZGF0YUZpZWxkXTtcclxuICAgICAgICAgICAgICBpZiAob2xkVmFsdWUgPT09IHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIC8vIOabtOaWsOWFg+aVsOaNruaVsOaNruOAglxyXG4gICAgICAgICAgICAgIHRoaXMuZGF0YVtkYXRhRmllbGRdID0gdmFsdWU7XHJcbiAgICAgICAgICAgICAgLy8g5Y+Y5pu06ZuGXHJcbiAgICAgICAgICAgICAgY29uc3QgY2hhbmdlcyA9IHtcclxuICAgICAgICAgICAgICAgIHR5cGU6IE1vZGlmeVR5cGUuVmFsdWVDaGFuZ2UsXHJcbiAgICAgICAgICAgICAgICBwYXRoOiB0aGlzLmNyZWF0ZVBhdGgocHJvcGVydHlOYW1lKSxcclxuICAgICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSxcclxuICAgICAgICAgICAgICAgIHByZVZhbHVlOiBvbGRWYWx1ZVxyXG4gICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgIGlmICh0aGlzW1BBUkVOVF9QQVRIXSkge1xyXG4gICAgICAgICAgICAgICAgY2hhbmdlcy5wYXRoID0gdGhpc1tQQVJFTlRfUEFUSF0uY29uY2F0KGNoYW5nZXMucGF0aCk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlRHluYW1pY0VudGl0eUZyb21Kc29uRGF0YSh2YWx1ZTogYW55LCBwYXJlbnRQYXRoOiBzdHJpbmdbXSkge1xyXG4gICAgbGV0IGluc3RhbmNlOiBEeW5hbWljRW50aXR5O1xyXG4gICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRHluYW1pY0VudGl0eSkge1xyXG4gICAgICBpbnN0YW5jZSA9IHZhbHVlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaW5zdGFuY2UgPSBuZXcgRHluYW1pY0VudGl0eSh2YWx1ZSk7XHJcbiAgICAgIGluc3RhbmNlLmNvbnN0cnVjdG9yID0gRHluYW1pY0VudGl0eTtcclxuICAgIH1cclxuICAgIGluc3RhbmNlW1BBUkVOVF9DTEFTU10gPSB0aGlzO1xyXG4gICAgaW5zdGFuY2VbUEFSRU5UX1BBVEhdID0gcGFyZW50UGF0aDtcclxuICAgIGluc3RhbmNlLm9uVmFsdWVDaGFuZ2VkLnBpcGUodGFrZVVudGlsKHRoaXMudW5zdWJzY3JpYmUpKS5zdWJzY3JpYmUoY2hhbmdlcyA9PiB7XHJcbiAgICAgIGlmIChjaGFuZ2VzKSB7XHJcbiAgICAgICAgY2hhbmdlcy5wYXRoID0gKHRoaXNbUEFSRU5UX1BBVEhdIHx8IFtdKS5jb25jYXQoY2hhbmdlcy5wYXRoKTtcclxuICAgICAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlcyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBpbnN0YW5jZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWwhuWPmOabtOiusOW9leS/neWtmOiHs+WPmOabtOmbhuS4rVxyXG4gICAqIEBwYXJhbSB2YWx1ZSDlj5jmm7TorrDlvZVcclxuICAgKiBAdG9kb1xyXG4gICAqIDHjgIFwcmVWYWx1ZeeahOWkhOeQhuaciemXrumimO+8jOS4i+e6p+S8oOmAkuS4iuadpeeahOWPmOabtOi/meagt+WPr+S7pe+8jOaguUR5YW5taWNhRW50aXR55LiK55qE77yMZGF0YeW3sue7j+WPkeeUn+WPmOWMlu+8jHByZXZhbHVl5ZKMdmFsdWXmmK/kuIDmoLfkuobvvJtcclxuICAgKiAy44CB5b2TdmFsdWXmmK/kuIvnuqflhpLms6HkuIrmnaXnmoTvvIzpnIDopoHmoLnmja52YWx1ZeWOu+abtOaWsOW9k+WJjeWxgue6p+eahGRhdGHvvIzor6XpgLvovpHkuI3lupTor6XmlL7lnKhzZXRDaGFnbmVz77yM5b6F5L+u5pS544CCXHJcbiAgICovXHJcbiAgc2V0Q2hhbmdlcyh2YWx1ZTogTW9kaWZpY2F0aW9uKTogdm9pZCB7XHJcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSB2YWx1ZS5wYXRoW3ZhbHVlLnBhdGgubGVuZ3RoIC0gMV07XHJcbiAgICBjb25zdCBwcmVWYWx1ZSA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuZGF0YSk7XHJcbiAgICB0aGlzLm5ld0RhdGEgPSBPYmplY3QuYXNzaWduKHRoaXMubmV3RGF0YSwgeyBbcHJvcGVydHlOYW1lXTogdmFsdWUudmFsdWUgfSk7XHJcbiAgICBsZXQgcGFyZW50UGF0aCA9IHZhbHVlLnBhdGg7XHJcbiAgICBpZiAodmFsdWUucGF0aC5sZW5ndGggPiAyKSB7XHJcbiAgICAgIHBhcmVudFBhdGggPSB2YWx1ZS5wYXRoLnNsaWNlKDAsIHZhbHVlLnBhdGgubGVuZ3RoIC0gMik7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g57uf5LiA5LiN5L2/55So5p6E6YCg5Ye95pWw77yI5L+d5oyB5ZKM5YW25LuW5L2N572u5a+5TW9kaWZpY2F0aW9u55qE5p6E6YCg5LiA6Ie077yJXHJcbiAgICAvLyBjb25zdCBwYXJlbnRNb2RpZmljYXRpb24gPSBuZXcgTW9kaWZpY2F0aW9uKHRoaXMuZGF0YSwgdmFsdWUudHlwZSwgcGFyZW50UGF0aCwgcHJlVmFsdWUpO1xyXG4gICAgY29uc3QgcGFyZW50TW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24gPSB7XHJcbiAgICAgIHBhdGg6IHBhcmVudFBhdGgsXHJcbiAgICAgIHZhbHVlOiB0aGlzLmRhdGEsXHJcbiAgICAgIHByZVZhbHVlOiBwcmVWYWx1ZSxcclxuICAgICAgdHlwZTogdmFsdWUudHlwZSxcclxuICAgICAgZHluYW1pYzogdHJ1ZVxyXG4gICAgfTtcclxuXHJcbiAgICB0aGlzLnZhbHVlQ2hhbmdlZC5uZXh0KHBhcmVudE1vZGlmaWNhdGlvbik7XHJcbiAgICB0aGlzLmNoYW5nZVNldC5hcHBlbmQodmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogdG9KU09OXHJcbiAgICovXHJcbiAgcHVibGljIHRvSlNPTigpIHtcclxuICAgIHJldHVybiB0aGlzLmRhdGE7XHJcbiAgfVxyXG59XHJcbiJdfQ==