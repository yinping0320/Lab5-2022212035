import { from } from 'rxjs';
import { tap } from 'rxjs/operators';
import { ModifyType } from '../changeset';
import { EntityList } from './entity_list';
import { FieldMetadataUtil } from './metadata/field_metadata_util';
import { PARENT_CLASS, PARENT_PATH } from './types';
import { ValidationUtils } from './validator/validation_utils';
export const entityPrototype = {
    /**
     * 获取属性值
     */
    getFieldValue: function (schemaField) {
        const fieldName = schemaField.label;
        const value = this.data[fieldName];
        // 对多语录入字段，query不返回问题进行兼容
        if (schemaField.multiLanguage === true && !value) {
            const langCode = window.localStorage.getItem('languageCode') || 'zh-CHS';
            const originDataField = fieldName.replace('_MULTILANGUAGE', '');
            return {
                [langCode]: this.data[originDataField]
            };
        }
        return value;
    },
    /**
     * 设置属性值
     */
    setFieldValue: function (schemaField, propertyValue) {
        const fieldName = schemaField.label;
        this.data[fieldName] = propertyValue;
    },
    /**
     * 获取复杂类型对象的值
     * @param schemaField Schema字段描述
     * @returns 复杂类型对象的值
     */
    getComplexFieldValue: function (schemaField) {
        const fieldName = schemaField.label;
        const objectPropertyValue = this.innerEntities[fieldName];
        return objectPropertyValue;
    },
    /**
     * 向实体复杂类型字段赋值
     * @param schemaField Schema字段描述
     * @param ComplexField 复杂类型字段的类型定义
     * @param propertyValue 属性值
     */
    setComplexFieldValue: function (schemaField, ComplexField, propertyValue) {
        // 提取字段名
        const fieldName = schemaField.label;
        let complexFieldInstance = null;
        if (propertyValue instanceof ComplexField) {
            complexFieldInstance = propertyValue;
        }
        else {
            complexFieldInstance = new ComplexField(propertyValue);
            complexFieldInstance.constructor = ComplexField;
        }
        // 提取复杂类型对象的值
        const objectPropertyValue = this.innerEntities[fieldName];
        const propertyPath = (objectPropertyValue && objectPropertyValue[PARENT_PATH]) || complexFieldInstance[PARENT_PATH];
        // 构造变更信息
        const changeInfo = {
            // 提取变更对象相对于根实体的路径
            path: propertyPath,
            // 记录对象最新值
            value: propertyValue,
            // 记录对象历史值
            preValue: (this[fieldName] && this[fieldName].data) || null,
            // 标记这是一个值变化变更
            type: ModifyType.ValueChange
        };
        // 创建新的对象
        this.innerEntities[fieldName] = complexFieldInstance;
        // this.innerEntities[fieldName] = new ComplexField(propertyValue);
        // 记录本次数据变更
        if (!this.isInitializing) {
            this.setChanges(changeInfo);
        }
    },
    /**
     * 获取指定的子实体列表
     * @param schemaEntity 实体描述
     * @returns 子实体列表
     */
    getEntities: function (schemaEntity) {
        const dataField = schemaEntity.label;
        const listPropertyValue = this.innerEntities[dataField];
        return listPropertyValue;
    },
    /**
     * 更新指定子实体的值
     * @param schemaEntity 实体描述
     * @param propertyValue 实体列表
     */
    setEntities: function (schemaEntity, propertyValue) {
        const dataField = schemaEntity.label;
        this.innerEntities[dataField] = propertyValue;
    },
    /**
     * 检查属性值是否发生变化
     */
    isFieldValueChanged: function (schemaField, newPropValue, oldPropValue) {
        if (schemaField.multiLanguage === true) {
            if (this.isEmptyMultiLangPropValue(newPropValue) === true && this.isEmptyMultiLangPropValue(oldPropValue) === true) {
                return false;
            }
            return JSON.stringify(newPropValue) !== JSON.stringify(oldPropValue);
        }
        else {
            return newPropValue !== oldPropValue;
        }
    },
    /**
     * 多语录入字段的值是否为空
     */
    isEmptyMultiLangPropValue(value) {
        if (!value) {
            return true;
        }
        const keys = Object.keys(value);
        if (keys.length === 0) {
            return true;
        }
        // 值全部为空，视为空
        const vals = Object.values(value);
        const allEmptyVal = vals.every((val) => {
            return !val;
        });
        if (allEmptyVal === true) {
            return true;
        }
        return false;
    },
    /**
     * 发送值变更
     */
    emitFieldValueChange: function (schemaField, newPropValue, oldPropValue) {
        if (!this.isInitializing) {
            const fieldName = schemaField.label;
            const changeInfo = {
                path: this.createPath(fieldName),
                value: newPropValue,
                preValue: oldPropValue,
                type: ModifyType.ValueChange
            };
            if (this[PARENT_PATH]) {
                changeInfo.path = this[PARENT_PATH].concat(changeInfo.path);
            }
            this.setChanges(changeInfo);
        }
    },
    /**
     * 将变更记录保存至变更集中
     * @param value 变更记录
     */
    setChanges: function (value) {
        const propertyName = value.path[value.path.length - 1];
        // @todo：事件会从下级向上冒泡，change可能是下级的，不能和当前Entity的newData合并。
        // this.newData = Object.assign(this.newData, { [propertyName]: value.value });
        this.valueChanged.next(value);
        if (!(this.validErrors && Object.keys(this.validErrors).includes(propertyName))) {
            this.changeSet.append(value);
        }
    },
    /**
     * 创建path
     * @param propertyName 属性名称
     */
    createPath: function (propertyName) {
        if (this.primaryKey) {
            return [this.primaryKey + ':' + this.primaryValue, propertyName];
        }
        else {
            return [':', propertyName];
        }
    },
    getPaths() {
        const pathObj = {
            path: [],
            isUdt: false,
            isGrid: false
        };
        const handleParent = item => {
            const parentPaths = item[PARENT_PATH];
            if (parentPaths) {
                const prop = parentPaths[parentPaths.length - 1];
                // 父级所在实体包含的ngObject，存在当前实体字段，则判断为UDt字段
                if (Object.keys(FieldMetadataUtil.getNgObjects(item[PARENT_CLASS].constructor)).indexOf(prop) > -1) {
                    pathObj.isUdt = true;
                }
                // 存在类型为ngList，则判断为grid
                if (item instanceof EntityList === true) {
                    pathObj.isGrid = true;
                }
                else {
                    pathObj.path.push(prop);
                }
            }
            if (item[PARENT_CLASS]) {
                handleParent(item[PARENT_CLASS]);
            }
        };
        handleParent(this);
        pathObj.path = pathObj.path.reverse();
        return pathObj;
    },
    validate(propertyName, value, externalRules, index) {
        return from(this.validator.validate(this, propertyName, value, externalRules, index)).pipe(tap((result) => {
            if (!result.isValid) {
                this.validErrors = ValidationUtils.convertErrorsToNormalObject(result.errors, {});
            }
            else {
                this.validErrors = {};
            }
        }));
    },
    validateAll(validateContext) {
    },
    /**
     * 用于在entity_util中调用，如果有错误，会将验证结果传入回调cb
     */
    validateFromUtil(propertyName, value, cb) {
        this.validErrors = {};
        from(this.validator.validate(this, propertyName, value)).subscribe((result) => {
            if (!result.isValid) {
                this.validErrors = ValidationUtils.convertErrorsToNormalObject(result.errors, {});
            }
            // 不应重新赋值，这里仅是实体校验通过
            /*else {
              // 如果BindingObject上的属性值和Entity上对应属性值一样，则不再设置
              if (this[propertyName] === value) {
                return;
              }
              this[propertyName] = value;
            }*/
            cb(result);
        });
    },
    /**
     * 将实体数据转换为JSON格式
     */
    toJSON(buildChanges) {
        // 声明转换初始值
        const result = {};
        // 提取简单类型字段的值
        const ngFields = FieldMetadataUtil.getNgFields(this.constructor);
        Object.keys(ngFields).forEach((propName) => {
            const ngField = ngFields[propName];
            const dataField = ngField.dataField || propName;
            if (buildChanges === true && ngField.enableTimeZone === true) {
                result[dataField] = this.data[propName];
            }
            else {
                result[dataField] = this[propName];
            }
        });
        // 提取对象类型字段的值
        const ngObjects = FieldMetadataUtil.getNgObjects(this.constructor);
        Object.keys(ngObjects).forEach((propName) => {
            const ngObject = ngObjects[propName];
            const dataField = ngObject.dataField || propName;
            result[dataField] = this[propName] ? this[propName].toJSON(buildChanges) : {};
        });
        // 提取动态属性字段的值
        const ngDynamics = FieldMetadataUtil.getNgDynamic(this.constructor);
        Object.keys(ngDynamics).forEach((propName) => {
            const ngDynamic = ngDynamics[propName];
            const dataField = ngDynamic.dataField || propName;
            result[dataField] = this[propName] ? this[propName].toJSON(buildChanges) : {};
        });
        // 提取列表字段的属性
        const ngLists = FieldMetadataUtil.getNgList(this.constructor);
        Object.keys(ngLists).forEach((propName) => {
            const ngList = ngLists[propName];
            const dataField = ngList.dataField || propName;
            result[dataField] = this[propName] ? this[propName].toJSON(buildChanges) : {};
        });
        return result;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X3Byb3RvdHlwZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2VudGl0eS9lbnRpdHlfcHJvdG90eXBlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxJQUFJLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDeEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JDLE9BQU8sRUFBZ0IsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBS3hELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDbkUsT0FBTyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFcEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBRS9ELE1BQU0sQ0FBQyxNQUFNLGVBQWUsR0FBRztJQUM3Qjs7T0FFRztJQUNILGFBQWEsRUFBRSxVQUFTLFdBQThCO1FBQ3BELE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUM7UUFDcEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNuQyx5QkFBeUI7UUFDekIsSUFBSSxXQUFXLENBQUMsYUFBYSxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNoRCxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsSUFBSSxRQUFRLENBQUM7WUFDekUsTUFBTSxlQUFlLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUNoRSxPQUFPO2dCQUNMLENBQUMsUUFBUSxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUM7YUFD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QUMsQ0FBQyxRQUFnQixFQUFFLEVBQUU7WUFDbkQsTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sU0FBUyxHQUFHLFNBQVMsQ0FBQyxTQUFTLElBQUksUUFBUSxDQUFDO1lBQ2xELE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUNoRixDQUFDLENBQUMsQ0FBQztRQUNILFlBQVk7UUFDWixNQUFNLE9BQU8sR0FBRyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzlELE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBZ0IsRUFBRSxFQUFFO1lBQ2hELE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNqQyxNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxJQUFJLFFBQVEsQ0FBQztZQUMvQyxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDaEYsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0NBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZyb20sIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBNb2RpZmljYXRpb24sIE1vZGlmeVR5cGUgfSBmcm9tICcuLi9jaGFuZ2VzZXQnO1xyXG5pbXBvcnQgeyBVc2VyU2V0dGluZ3NTZXJ2aWNlIH0gZnJvbSAnLi4vaTE4bi91c2VyX3NldHRpbmdzX3NlcnZpY2UnO1xyXG5pbXBvcnQgeyBab25lZFRpbWUgfSBmcm9tICcuLi9pMThuL3pvbmVkX3RpbWUnO1xyXG5pbXBvcnQgeyBTY2hlbWFFbnRpdHksIFNjaGVtYUVudGl0eUZpZWxkIH0gZnJvbSAnLi4vc2NoZW1hL3NjaGVtYSc7XHJcbmltcG9ydCB7IEVudGl0eSB9IGZyb20gJy4vZW50aXR5JztcclxuaW1wb3J0IHsgRW50aXR5TGlzdCB9IGZyb20gJy4vZW50aXR5X2xpc3QnO1xyXG5pbXBvcnQgeyBGaWVsZE1ldGFkYXRhVXRpbCB9IGZyb20gJy4vbWV0YWRhdGEvZmllbGRfbWV0YWRhdGFfdXRpbCc7XHJcbmltcG9ydCB7IFBBUkVOVF9DTEFTUywgUEFSRU5UX1BBVEggfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgVmFsaWRhdGVSdWxlLCBWYWxpZGF0aW9uUmVzdWx0IH0gZnJvbSAnLi92YWxpZGF0b3IvdHlwZXMnO1xyXG5pbXBvcnQgeyBWYWxpZGF0aW9uVXRpbHMgfSBmcm9tICcuL3ZhbGlkYXRvci92YWxpZGF0aW9uX3V0aWxzJztcclxuXHJcbmV4cG9ydCBjb25zdCBlbnRpdHlQcm90b3R5cGUgPSB7XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5bGe5oCn5YC8XHJcbiAgICovXHJcbiAgZ2V0RmllbGRWYWx1ZTogZnVuY3Rpb24oc2NoZW1hRmllbGQ6IFNjaGVtYUVudGl0eUZpZWxkKSB7XHJcbiAgICBjb25zdCBmaWVsZE5hbWUgPSBzY2hlbWFGaWVsZC5sYWJlbDtcclxuICAgIGNvbnN0IHZhbHVlID0gdGhpcy5kYXRhW2ZpZWxkTmFtZV07XHJcbiAgICAvLyDlr7nlpJror63lvZXlhaXlrZfmrrXvvIxxdWVyeeS4jei/lOWbnumXrumimOi/m+ihjOWFvOWuuVxyXG4gICAgaWYgKHNjaGVtYUZpZWxkLm11bHRpTGFuZ3VhZ2UgPT09IHRydWUgJiYgIXZhbHVlKSB7XHJcbiAgICAgIGNvbnN0IGxhbmdDb2RlID0gd2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKCdsYW5ndWFnZUNvZGUnKSB8fCAnemgtQ0hTJztcclxuICAgICAgY29uc3Qgb3JpZ2luRGF0YUZpZWxkID0gZmllbGROYW1lLnJlcGxhY2UoJ19NVUxUSUxBTkdVQUdFJywgJycpO1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIFtsYW5nQ29kZV06IHRoaXMuZGF0YVtvcmlnaW5EYXRhRmllbGRdXHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdmFsdWU7XHJcbiAgfSxcclxuICAvKipcclxuICAgKiDorr7nva7lsZ7mgKflgLxcclxuICAgKi9cclxuICBzZXRGaWVsZFZhbHVlOiBmdW5jdGlvbihzY2hlbWFGaWVsZDogU2NoZW1hRW50aXR5RmllbGQsIHByb3BlcnR5VmFsdWU6IGFueSkge1xyXG4gICAgY29uc3QgZmllbGROYW1lID0gc2NoZW1hRmllbGQubGFiZWw7XHJcbiAgICB0aGlzLmRhdGFbZmllbGROYW1lXSA9IHByb3BlcnR5VmFsdWU7XHJcbiAgfSxcclxuICAvKipcclxuICAgKiDojrflj5blpI3mnYLnsbvlnovlr7nosaHnmoTlgLxcclxuICAgKiBAcGFyYW0gc2NoZW1hRmllbGQgU2NoZW1h5a2X5q615o+P6L+wXHJcbiAgICogQHJldHVybnMg5aSN5p2C57G75Z6L5a+56LGh55qE5YC8XHJcbiAgICovXHJcbiAgZ2V0Q29tcGxleEZpZWxkVmFsdWU6IGZ1bmN0aW9uKHNjaGVtYUZpZWxkOiBTY2hlbWFFbnRpdHlGaWVsZCkge1xyXG4gICAgY29uc3QgZmllbGROYW1lID0gc2NoZW1hRmllbGQubGFiZWw7XHJcbiAgICBjb25zdCBvYmplY3RQcm9wZXJ0eVZhbHVlID0gdGhpcy5pbm5lckVudGl0aWVzW2ZpZWxkTmFtZV07XHJcbiAgICByZXR1cm4gb2JqZWN0UHJvcGVydHlWYWx1ZTtcclxuICB9LFxyXG4gIC8qKlxyXG4gICAqIOWQkeWunuS9k+Wkjeadguexu+Wei+Wtl+autei1i+WAvFxyXG4gICAqIEBwYXJhbSBzY2hlbWFGaWVsZCBTY2hlbWHlrZfmrrXmj4/ov7BcclxuICAgKiBAcGFyYW0gQ29tcGxleEZpZWxkIOWkjeadguexu+Wei+Wtl+auteeahOexu+Wei+WumuS5iVxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eVZhbHVlIOWxnuaAp+WAvFxyXG4gICAqL1xyXG4gIHNldENvbXBsZXhGaWVsZFZhbHVlOiBmdW5jdGlvbihzY2hlbWFGaWVsZDogU2NoZW1hRW50aXR5RmllbGQsIENvbXBsZXhGaWVsZDogYW55LCBwcm9wZXJ0eVZhbHVlOiBhbnkpIHtcclxuICAgIC8vIOaPkOWPluWtl+auteWQjVxyXG4gICAgY29uc3QgZmllbGROYW1lID0gc2NoZW1hRmllbGQubGFiZWw7XHJcbiAgICBsZXQgY29tcGxleEZpZWxkSW5zdGFuY2UgPSBudWxsO1xyXG4gICAgaWYgKHByb3BlcnR5VmFsdWUgaW5zdGFuY2VvZiBDb21wbGV4RmllbGQpIHtcclxuICAgICAgY29tcGxleEZpZWxkSW5zdGFuY2UgPSBwcm9wZXJ0eVZhbHVlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29tcGxleEZpZWxkSW5zdGFuY2UgPSBuZXcgQ29tcGxleEZpZWxkKHByb3BlcnR5VmFsdWUpO1xyXG4gICAgICBjb21wbGV4RmllbGRJbnN0YW5jZS5jb25zdHJ1Y3RvciA9IENvbXBsZXhGaWVsZDtcclxuICAgIH1cclxuICAgIC8vIOaPkOWPluWkjeadguexu+Wei+WvueixoeeahOWAvFxyXG4gICAgY29uc3Qgb2JqZWN0UHJvcGVydHlWYWx1ZSA9IHRoaXMuaW5uZXJFbnRpdGllc1tmaWVsZE5hbWVdO1xyXG4gICAgY29uc3QgcHJvcGVydHlQYXRoID0gKG9iamVjdFByb3BlcnR5VmFsdWUgJiYgb2JqZWN0UHJvcGVydHlWYWx1ZVtQQVJFTlRfUEFUSF0pIHx8IGNvbXBsZXhGaWVsZEluc3RhbmNlW1BBUkVOVF9QQVRIXTtcclxuICAgIC8vIOaehOmAoOWPmOabtOS/oeaBr1xyXG4gICAgY29uc3QgY2hhbmdlSW5mbyA9IHtcclxuICAgICAgLy8g5o+Q5Y+W5Y+Y5pu05a+56LGh55u45a+55LqO5qC55a6e5L2T55qE6Lev5b6EXHJcbiAgICAgIHBhdGg6IHByb3BlcnR5UGF0aCxcclxuICAgICAgLy8g6K6w5b2V5a+56LGh5pyA5paw5YC8XHJcbiAgICAgIHZhbHVlOiBwcm9wZXJ0eVZhbHVlLFxyXG4gICAgICAvLyDorrDlvZXlr7nosaHljoblj7LlgLxcclxuICAgICAgcHJlVmFsdWU6ICh0aGlzW2ZpZWxkTmFtZV0gJiYgdGhpc1tmaWVsZE5hbWVdLmRhdGEpIHx8IG51bGwsXHJcbiAgICAgIC8vIOagh+iusOi/meaYr+S4gOS4quWAvOWPmOWMluWPmOabtFxyXG4gICAgICB0eXBlOiBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlXHJcbiAgICB9O1xyXG4gICAgLy8g5Yib5bu65paw55qE5a+56LGhXHJcbiAgICB0aGlzLmlubmVyRW50aXRpZXNbZmllbGROYW1lXSA9IGNvbXBsZXhGaWVsZEluc3RhbmNlO1xyXG4gICAgLy8gdGhpcy5pbm5lckVudGl0aWVzW2ZpZWxkTmFtZV0gPSBuZXcgQ29tcGxleEZpZWxkKHByb3BlcnR5VmFsdWUpO1xyXG4gICAgLy8g6K6w5b2V5pys5qyh5pWw5o2u5Y+Y5pu0XHJcbiAgICBpZiAoIXRoaXMuaXNJbml0aWFsaXppbmcpIHtcclxuICAgICAgdGhpcy5zZXRDaGFuZ2VzKGNoYW5nZUluZm8pO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5oyH5a6a55qE5a2Q5a6e5L2T5YiX6KGoXHJcbiAgICogQHBhcmFtIHNjaGVtYUVudGl0eSDlrp7kvZPmj4/ov7BcclxuICAgKiBAcmV0dXJucyDlrZDlrp7kvZPliJfooahcclxuICAgKi9cclxuICBnZXRFbnRpdGllczogZnVuY3Rpb24oc2NoZW1hRW50aXR5OiBTY2hlbWFFbnRpdHkpIHtcclxuICAgIGNvbnN0IGRhdGFGaWVsZCA9IHNjaGVtYUVudGl0eS5sYWJlbDtcclxuICAgIGNvbnN0IGxpc3RQcm9wZXJ0eVZhbHVlID0gdGhpcy5pbm5lckVudGl0aWVzW2RhdGFGaWVsZF07XHJcbiAgICByZXR1cm4gbGlzdFByb3BlcnR5VmFsdWU7XHJcbiAgfSxcclxuICAvKipcclxuICAgKiDmm7TmlrDmjIflrprlrZDlrp7kvZPnmoTlgLxcclxuICAgKiBAcGFyYW0gc2NoZW1hRW50aXR5IOWunuS9k+aPj+i/sFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eVZhbHVlIOWunuS9k+WIl+ihqFxyXG4gICAqL1xyXG4gIHNldEVudGl0aWVzOiBmdW5jdGlvbihzY2hlbWFFbnRpdHk6IFNjaGVtYUVudGl0eSwgcHJvcGVydHlWYWx1ZTogYW55KSB7XHJcbiAgICBjb25zdCBkYXRhRmllbGQgPSBzY2hlbWFFbnRpdHkubGFiZWw7XHJcbiAgICB0aGlzLmlubmVyRW50aXRpZXNbZGF0YUZpZWxkXSA9IHByb3BlcnR5VmFsdWU7XHJcbiAgfSxcclxuICAvKipcclxuICAgKiDmo4Dmn6XlsZ7mgKflgLzmmK/lkKblj5HnlJ/lj5jljJZcclxuICAgKi9cclxuICBpc0ZpZWxkVmFsdWVDaGFuZ2VkOiBmdW5jdGlvbihzY2hlbWFGaWVsZDogU2NoZW1hRW50aXR5RmllbGQsIG5ld1Byb3BWYWx1ZTogYW55LCBvbGRQcm9wVmFsdWU6IGFueSkge1xyXG4gICAgaWYgKHNjaGVtYUZpZWxkLm11bHRpTGFuZ3VhZ2UgPT09IHRydWUpIHtcclxuICAgICAgaWYgKHRoaXMuaXNFbXB0eU11bHRpTGFuZ1Byb3BWYWx1ZShuZXdQcm9wVmFsdWUpID09PSB0cnVlICYmIHRoaXMuaXNFbXB0eU11bHRpTGFuZ1Byb3BWYWx1ZShvbGRQcm9wVmFsdWUpID09PSB0cnVlKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShuZXdQcm9wVmFsdWUpICE9PSBKU09OLnN0cmluZ2lmeShvbGRQcm9wVmFsdWUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIG5ld1Byb3BWYWx1ZSAhPT0gb2xkUHJvcFZhbHVlO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgLyoqXHJcbiAgICog5aSa6K+t5b2V5YWl5a2X5q6155qE5YC85piv5ZCm5Li656m6XHJcbiAgICovXHJcbiAgaXNFbXB0eU11bHRpTGFuZ1Byb3BWYWx1ZSh2YWx1ZTogYW55KSB7XHJcbiAgICBpZiAoIXZhbHVlKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7XHJcbiAgICBpZiAoa2V5cy5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5YC85YWo6YOo5Li656m677yM6KeG5Li656m6XHJcbiAgICBjb25zdCB2YWxzID0gT2JqZWN0LnZhbHVlcyh2YWx1ZSk7XHJcbiAgICBjb25zdCBhbGxFbXB0eVZhbCA9IHZhbHMuZXZlcnkoKHZhbCkgPT4ge1xyXG4gICAgICByZXR1cm4gIXZhbDtcclxuICAgIH0pO1xyXG4gICAgaWYgKGFsbEVtcHR5VmFsID09PSB0cnVlKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9LFxyXG4gIC8qKlxyXG4gICAqIOWPkemAgeWAvOWPmOabtFxyXG4gICAqL1xyXG4gIGVtaXRGaWVsZFZhbHVlQ2hhbmdlOiBmdW5jdGlvbihzY2hlbWFGaWVsZDogU2NoZW1hRW50aXR5RmllbGQsIG5ld1Byb3BWYWx1ZTogYW55LCBvbGRQcm9wVmFsdWU6IGFueSk6IHZvaWQge1xyXG4gICAgaWYgKCF0aGlzLmlzSW5pdGlhbGl6aW5nKSB7XHJcbiAgICAgIGNvbnN0IGZpZWxkTmFtZSA9IHNjaGVtYUZpZWxkLmxhYmVsO1xyXG4gICAgICBjb25zdCBjaGFuZ2VJbmZvID0ge1xyXG4gICAgICAgIHBhdGg6IHRoaXMuY3JlYXRlUGF0aChmaWVsZE5hbWUpLFxyXG4gICAgICAgIHZhbHVlOiBuZXdQcm9wVmFsdWUsXHJcbiAgICAgICAgcHJlVmFsdWU6IG9sZFByb3BWYWx1ZSxcclxuICAgICAgICB0eXBlOiBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBpZiAodGhpc1tQQVJFTlRfUEFUSF0pIHtcclxuICAgICAgICBjaGFuZ2VJbmZvLnBhdGggPSB0aGlzW1BBUkVOVF9QQVRIXS5jb25jYXQoY2hhbmdlSW5mby5wYXRoKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlSW5mbyk7XHJcbiAgICB9XHJcbiAgfSxcclxuICAvKipcclxuICAgKiDlsIblj5jmm7TorrDlvZXkv53lrZjoh7Plj5jmm7Tpm4bkuK1cclxuICAgKiBAcGFyYW0gdmFsdWUg5Y+Y5pu06K6w5b2VXHJcbiAgICovXHJcbiAgc2V0Q2hhbmdlczogZnVuY3Rpb24odmFsdWU6IE1vZGlmaWNhdGlvbik6IHZvaWQge1xyXG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gdmFsdWUucGF0aFt2YWx1ZS5wYXRoLmxlbmd0aCAtIDFdO1xyXG5cclxuICAgIC8vIEB0b2Rv77ya5LqL5Lu25Lya5LuO5LiL57qn5ZCR5LiK5YaS5rOh77yMY2hhbmdl5Y+v6IO95piv5LiL57qn55qE77yM5LiN6IO95ZKM5b2T5YmNRW50aXR555qEbmV3RGF0YeWQiOW5tuOAglxyXG4gICAgLy8gdGhpcy5uZXdEYXRhID0gT2JqZWN0LmFzc2lnbih0aGlzLm5ld0RhdGEsIHsgW3Byb3BlcnR5TmFtZV06IHZhbHVlLnZhbHVlIH0pO1xyXG5cclxuICAgIHRoaXMudmFsdWVDaGFuZ2VkLm5leHQodmFsdWUpO1xyXG4gICAgaWYgKCEodGhpcy52YWxpZEVycm9ycyAmJiBPYmplY3Qua2V5cyh0aGlzLnZhbGlkRXJyb3JzKS5pbmNsdWRlcyhwcm9wZXJ0eU5hbWUpKSkge1xyXG4gICAgICB0aGlzLmNoYW5nZVNldC5hcHBlbmQodmFsdWUpO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgLyoqXHJcbiAgICog5Yib5bu6cGF0aFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eU5hbWUg5bGe5oCn5ZCN56ewXHJcbiAgICovXHJcbiAgY3JlYXRlUGF0aDogZnVuY3Rpb24ocHJvcGVydHlOYW1lOiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgICBpZiAodGhpcy5wcmltYXJ5S2V5KSB7XHJcbiAgICAgIHJldHVybiBbdGhpcy5wcmltYXJ5S2V5ICsgJzonICsgdGhpcy5wcmltYXJ5VmFsdWUsIHByb3BlcnR5TmFtZV07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gWyc6JywgcHJvcGVydHlOYW1lXTtcclxuICAgIH1cclxuICB9LFxyXG4gIGdldFBhdGhzKCkge1xyXG4gICAgY29uc3QgcGF0aE9iaiA9IHtcclxuICAgICAgcGF0aDogW10sXHJcbiAgICAgIGlzVWR0OiBmYWxzZSxcclxuICAgICAgaXNHcmlkOiBmYWxzZVxyXG4gICAgfTtcclxuICAgIGNvbnN0IGhhbmRsZVBhcmVudCA9IGl0ZW0gPT4ge1xyXG4gICAgICBjb25zdCBwYXJlbnRQYXRocyA9IGl0ZW1bUEFSRU5UX1BBVEhdO1xyXG4gICAgICBpZiAocGFyZW50UGF0aHMpIHtcclxuICAgICAgICBjb25zdCBwcm9wID0gcGFyZW50UGF0aHNbcGFyZW50UGF0aHMubGVuZ3RoIC0gMV07XHJcbiAgICAgICAgLy8g54i257qn5omA5Zyo5a6e5L2T5YyF5ZCr55qEbmdPYmplY3TvvIzlrZjlnKjlvZPliY3lrp7kvZPlrZfmrrXvvIzliJnliKTmlq3kuLpVRHTlrZfmrrVcclxuICAgICAgICBpZiAoT2JqZWN0LmtleXMoRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdPYmplY3RzKGl0ZW1bUEFSRU5UX0NMQVNTXS5jb25zdHJ1Y3RvcikpLmluZGV4T2YocHJvcCkgPiAtMSkge1xyXG4gICAgICAgICAgcGF0aE9iai5pc1VkdCA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOWtmOWcqOexu+Wei+S4um5nTGlzdO+8jOWImeWIpOaWreS4umdyaWRcclxuICAgICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIEVudGl0eUxpc3QgPT09IHRydWUpIHtcclxuICAgICAgICAgIHBhdGhPYmouaXNHcmlkID0gdHJ1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcGF0aE9iai5wYXRoLnB1c2gocHJvcCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgfVxyXG4gICAgICBpZiAoaXRlbVtQQVJFTlRfQ0xBU1NdKSB7XHJcbiAgICAgICAgaGFuZGxlUGFyZW50KGl0ZW1bUEFSRU5UX0NMQVNTXSk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICBoYW5kbGVQYXJlbnQodGhpcyk7XHJcbiAgICBwYXRoT2JqLnBhdGggPSBwYXRoT2JqLnBhdGgucmV2ZXJzZSgpO1xyXG4gICAgcmV0dXJuIHBhdGhPYmo7XHJcbiAgfSxcclxuICB2YWxpZGF0ZShwcm9wZXJ0eU5hbWU/OiBzdHJpbmcsIHZhbHVlPywgZXh0ZXJuYWxSdWxlcz86IE1hcDxzdHJpbmcsIFZhbGlkYXRlUnVsZVtdPiwgaW5kZXg/OiBudW1iZXIpOiBPYnNlcnZhYmxlPFZhbGlkYXRpb25SZXN1bHQ+IHtcclxuICAgIHJldHVybiBmcm9tKHRoaXMudmFsaWRhdG9yLnZhbGlkYXRlKHRoaXMsIHByb3BlcnR5TmFtZSwgdmFsdWUsIGV4dGVybmFsUnVsZXMsIGluZGV4KSkucGlwZShcclxuICAgICAgdGFwKChyZXN1bHQ6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmICghcmVzdWx0LmlzVmFsaWQpIHtcclxuICAgICAgICAgIHRoaXMudmFsaWRFcnJvcnMgPSBWYWxpZGF0aW9uVXRpbHMuY29udmVydEVycm9yc1RvTm9ybWFsT2JqZWN0KHJlc3VsdC5lcnJvcnMsIHt9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy52YWxpZEVycm9ycyA9IHt9O1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfSxcclxuICB2YWxpZGF0ZUFsbCh2YWxpZGF0ZUNvbnRleHQ/OiBNYXA8c3RyaW5nLCBWYWxpZGF0ZVJ1bGVbXT4pIHtcclxuXHJcbiAgfSxcclxuICAvKipcclxuICAgKiDnlKjkuo7lnKhlbnRpdHlfdXRpbOS4reiwg+eUqO+8jOWmguaenOaciemUmeivr++8jOS8muWwhumqjOivgee7k+aenOS8oOWFpeWbnuiwg2NiXHJcbiAgICovXHJcbiAgdmFsaWRhdGVGcm9tVXRpbChwcm9wZXJ0eU5hbWU6IHN0cmluZywgdmFsdWU6IGFueSwgY2I6IGFueSkge1xyXG4gICAgdGhpcy52YWxpZEVycm9ycyA9IHt9O1xyXG4gICAgZnJvbSh0aGlzLnZhbGlkYXRvci52YWxpZGF0ZSh0aGlzLCBwcm9wZXJ0eU5hbWUsIHZhbHVlKSkuc3Vic2NyaWJlKChyZXN1bHQ6IGFueSkgPT4ge1xyXG4gICAgICBpZiAoIXJlc3VsdC5pc1ZhbGlkKSB7XHJcbiAgICAgICAgdGhpcy52YWxpZEVycm9ycyA9IFZhbGlkYXRpb25VdGlscy5jb252ZXJ0RXJyb3JzVG9Ob3JtYWxPYmplY3QocmVzdWx0LmVycm9ycywge30pO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIOS4jeW6lOmHjeaWsOi1i+WAvO+8jOi/memHjOS7heaYr+WunuS9k+agoemqjOmAmui/h1xyXG4gICAgICAvKmVsc2Uge1xyXG4gICAgICAgIC8vIOWmguaenEJpbmRpbmdPYmplY3TkuIrnmoTlsZ7mgKflgLzlkoxFbnRpdHnkuIrlr7nlupTlsZ7mgKflgLzkuIDmoLfvvIzliJnkuI3lho3orr7nva5cclxuICAgICAgICBpZiAodGhpc1twcm9wZXJ0eU5hbWVdID09PSB2YWx1ZSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzW3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTtcclxuICAgICAgfSovXHJcbiAgICAgIGNiKHJlc3VsdCk7XHJcbiAgICB9KTtcclxuICB9LFxyXG4gIC8qKlxyXG4gICAqIOWwhuWunuS9k+aVsOaNrui9rOaNouS4ukpTT07moLzlvI9cclxuICAgKi9cclxuICB0b0pTT04oYnVpbGRDaGFuZ2VzPzogYm9vbGVhbikge1xyXG4gICAgLy8g5aOw5piO6L2s5o2i5Yid5aeL5YC8XHJcbiAgICBjb25zdCByZXN1bHQgPSB7fTtcclxuICAgIC8vIOaPkOWPlueugOWNleexu+Wei+Wtl+auteeahOWAvFxyXG4gICAgY29uc3QgbmdGaWVsZHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0ZpZWxkcyh0aGlzLmNvbnN0cnVjdG9yKTtcclxuICAgIE9iamVjdC5rZXlzKG5nRmllbGRzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5nRmllbGQgPSBuZ0ZpZWxkc1twcm9wTmFtZV07XHJcbiAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IG5nRmllbGQuZGF0YUZpZWxkIHx8IHByb3BOYW1lO1xyXG4gICAgICBpZiAoYnVpbGRDaGFuZ2VzID09PSB0cnVlICYmIG5nRmllbGQuZW5hYmxlVGltZVpvbmUgPT09IHRydWUpIHtcclxuICAgICAgICByZXN1bHRbZGF0YUZpZWxkXSA9IHRoaXMuZGF0YVtwcm9wTmFtZV07XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVzdWx0W2RhdGFGaWVsZF0gPSB0aGlzW3Byb3BOYW1lXTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICAvLyDmj5Dlj5blr7nosaHnsbvlnovlrZfmrrXnmoTlgLxcclxuICAgIGNvbnN0IG5nT2JqZWN0cyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nT2JqZWN0cyh0aGlzLmNvbnN0cnVjdG9yKTtcclxuICAgIE9iamVjdC5rZXlzKG5nT2JqZWN0cykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBuZ09iamVjdCA9IG5nT2JqZWN0c1twcm9wTmFtZV07XHJcbiAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IG5nT2JqZWN0LmRhdGFGaWVsZCB8fCBwcm9wTmFtZTtcclxuICAgICAgcmVzdWx0W2RhdGFGaWVsZF0gPSB0aGlzW3Byb3BOYW1lXSA/IHRoaXNbcHJvcE5hbWVdLnRvSlNPTihidWlsZENoYW5nZXMpIDoge307XHJcbiAgICB9KTtcclxuICAgIC8vIOaPkOWPluWKqOaAgeWxnuaAp+Wtl+auteeahOWAvFxyXG4gICAgY29uc3QgbmdEeW5hbWljcyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nRHluYW1pYyh0aGlzLmNvbnN0cnVjdG9yKTtcclxuICAgIE9iamVjdC5rZXlzKG5nRHluYW1pY3MpLmZvckVhY2goKHByb3BOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgY29uc3QgbmdEeW5hbWljID0gbmdEeW5hbWljc1twcm9wTmFtZV07XHJcbiAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IG5nRHluYW1pYy5kYXRhRmllbGQgfHwgcHJvcE5hbWU7XHJcbiAgICAgIHJlc3VsdFtkYXRhRmllbGRdID0gdGhpc1twcm9wTmFtZV0gPyB0aGlzW3Byb3BOYW1lXS50b0pTT04oYnVpbGRDaGFuZ2VzKSA6IHt9O1xyXG4gICAgfSk7XHJcbiAgICAvLyDmj5Dlj5bliJfooajlrZfmrrXnmoTlsZ7mgKdcclxuICAgIGNvbnN0IG5nTGlzdHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0xpc3QodGhpcy5jb25zdHJ1Y3Rvcik7XHJcbiAgICBPYmplY3Qua2V5cyhuZ0xpc3RzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5nTGlzdCA9IG5nTGlzdHNbcHJvcE5hbWVdO1xyXG4gICAgICBjb25zdCBkYXRhRmllbGQgPSBuZ0xpc3QuZGF0YUZpZWxkIHx8IHByb3BOYW1lO1xyXG4gICAgICByZXN1bHRbZGF0YUZpZWxkXSA9IHRoaXNbcHJvcE5hbWVdID8gdGhpc1twcm9wTmFtZV0udG9KU09OKGJ1aWxkQ2hhbmdlcykgOiB7fTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG59O1xyXG4iXX0=