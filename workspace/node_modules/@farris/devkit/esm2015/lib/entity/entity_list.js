import { Subject, from } from 'rxjs';
import { ChangeSet } from '../changeset/change_set';
import { ModifyType } from '../changeset/types';
import { Entity } from './entity';
import { EntityFactory } from './entity_creator';
import { PARENT_CLASS, PARENT_PATH } from './types';
import { Validator } from './validator/validator';
/**
 * 实体集合列表
 */
export class EntityList {
    // #endregion
    /**
     * @param data JSON数据集合
     * @param type 集合中的实体类型
     */
    constructor(data, type) {
        this.__type__ = 'EntityList';
        // #region 私有属性
        this.originalData = [];
        /**
         * 已废弃：请勿使用
         */
        this.listChanged = new Subject();
        /**
         * 已废弃：请勿使用
         */
        this.changeSet = new ChangeSet();
        /**
         * 已废弃：请勿使用
         */
        this.validator = new Validator();
        // #endregion
        // #region 公有属性
        /**
         * 集合改变时触发(新增、行记录修改、删除)
         * @event
         */
        this.onListChanged = this.listChanged.asObservable();
        this.clear();
        if (data) {
            // this.loadEntities(data);
            data.forEach(item => {
                this.initEntity(EntityFactory(type, item));
            });
        }
    }
    /**
     * 获取项集合
     */
    get items() {
        return this.rawData;
    }
    /**
     * 列表变更集
     */
    get changes() {
        return this.changeSet.changes;
    }
    /**
     * 迭代器
     */
    *[Symbol.iterator]() {
        yield* this.items;
    }
    // #region 公有方法
    /** 加载实体列表 */
    loadEntities(entities) {
        this.clear();
        entities.forEach(entity => {
            this.initEntity(entity);
        });
        // 发送Load变更
        const changeItem = {
            path: [],
            value: entities,
            preValue: undefined,
            type: ModifyType.Load,
            target: this
        };
        this.setChanges(changeItem);
    }
    /**
     * 清空
     */
    clear() {
        this.rawData = [];
        this.originalData = [];
    }
    /**
     * 添加实体对象到集合中，并返回新加的对象
     * @param entity 实体对象
     * @param isCloned 克隆
     */
    appendNew(entity, isCloned = false) {
        const newEntity = this.initEntity(entity, true);
        // 新增变更
        const changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Add
        };
        if (isCloned === true) {
            changeItem.type = ModifyType.Clone;
        }
        this.setChanges(changeItem);
        return newEntity;
    }
    /**
     * 在指定位置插入实体
     * @param entity 实体
     * @param position 插入位置
     */
    insert(entity, position) {
        const newEntity = this.initEntity(entity, true);
        // 新增变更
        const changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Insert,
            position: position,
        };
        this.setChanges(changeItem);
        return newEntity;
    }
    /**
     * 追加实体
     */
    appendEntity(entity) {
        const newEntity = this.initEntity(entity, true);
        // 新增变更
        const changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Add
        };
        this.setChanges(changeItem);
    }
    /**
     * 批量追加实体
     */
    appendEntities(entities) {
        const newEntites = entities.map((entity) => {
            return this.initEntity(entity, true);
        });
        const changeItem = {
            path: [],
            value: newEntites,
            preValue: undefined,
            type: ModifyType.Add
        };
        this.setChanges(changeItem);
    }
    /**
     * 删除指定主键ID 的实体对象，返回布尔，true 删除成功，false 删除失败
     * @param primaryId 主键ID
     */
    remove(primaryId) {
        const total = this.count();
        const indexToRemove = this.rawData.findIndex((entity) => {
            return entity.primaryValue === primaryId;
        });
        if (indexToRemove === -1) {
            return false;
        }
        const entityToRemove = this.rawData[indexToRemove];
        this.rawData.splice(indexToRemove, 1);
        // 删除变更
        const changeItem = {
            path: [],
            value: { [entityToRemove.primaryProperty.dataField]: primaryId },
            preValue: undefined,
            type: ModifyType.Remove
        };
        this.updateIndex(total);
        this.setChanges(changeItem);
        return true;
    }
    /**
     * 从集合中获取指定ID值的实体对象
     * @param id 主键值
     */
    get(id) {
        return this.items.find(item => {
            return item.primaryValue === id;
        });
    }
    /**
     * 将变更记录添加到集合变更集中
     * @param value 变更记录
     */
    setChanges(modinfo) {
        // 向app层发送的变更
        this.listChanged.next(modinfo);
        // 构造向changeSet中添加的chagne
        const change = Object.assign({}, modinfo);
        if ((modinfo.type === ModifyType.Add || modinfo.type === ModifyType.Insert || modinfo.type === ModifyType.Clone) && modinfo.value[0] instanceof Entity) {
            change.value = [modinfo.value[0].data];
        }
        this.changeSet.append(change);
    }
    /** 集合总记录数 */
    count() {
        return this.items.length;
    }
    /**
     * 获取实体对象的索引值
     */
    indexOf(entity) {
        return this.items.indexOf(entity);
    }
    /**
     * 计算集合中某个属性的总和
     * @param propertyName 属性名称
     */
    sum(propertyName) {
        if (this.count() === 0) {
            return 0;
        }
        return this.items.reduce((val, curr) => {
            return val + curr[propertyName];
        }, 0);
    }
    /**
     * 集合数据验证
     */
    validate() {
        const propertyName = this.getPropertyName();
        return from(this.validator.validate(this[PARENT_CLASS], propertyName));
    }
    /**
     * 已废弃：请使用toJSON方法代替
     * @deprecated
     */
    toJson() {
        return this.rawData;
    }
    /**
     * 转换为JSON格式
     */
    toJSON() {
        const result = [];
        this.items.forEach((entity) => {
            result.push(entity.toJSON());
        });
        return result;
    }
    toArray() {
        return this.items;
    }
    // #endregion
    // #region 私有方法
    /**
     * 实体初始化
     * @param entity 实体
     */
    initEntity(entity, isNewEntity = false) {
        entity[PARENT_CLASS] = this;
        entity[PARENT_PATH] = this[PARENT_PATH];
        entity.onValueChanged.subscribe((v) => {
            const path = v.path;
            const value = v.value;
            const preValue = v.preValue;
            const operator = v.type;
            const subChanges = { path, value, preValue, type: operator };
            if (v.changeSetValue !== undefined) {
                subChanges['changeSetValue'] = v.changeSetValue;
            }
            this.setChanges(subChanges);
        });
        // TODO: 添加数据验证逻辑代码
        const newLength = this.rawData.push(entity);
        this[newLength - 1] = entity;
        if (!isNewEntity) {
            this.originalData.push(entity.toJSON());
        }
        return entity;
    }
    /**
     * 更新索引
     * @param total 总记录数
     */
    updateIndex(total) {
        for (let i = 0; i < total; i++) {
            delete this[i];
        }
        this.rawData.forEach((entity, index) => {
            this[index] = entity;
        });
    }
    /**
     * 获取属性名称
     */
    getPropertyName() {
        const path = this[PARENT_PATH];
        if (path && path.length) {
            const name = path[path.length - 1];
            return name;
        }
        return undefined;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X2xpc3QuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9lbnRpdHkvZW50aXR5X2xpc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE9BQU8sRUFBYyxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDakQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3BELE9BQU8sRUFBZ0IsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDOUQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNsQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakQsT0FBTyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQWEsTUFBTSxTQUFTLENBQUM7QUFDL0QsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBTWxEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLFVBQVU7SUE4RHJCLGFBQWE7SUFHYjs7O09BR0c7SUFDSCxZQUFZLElBQVksRUFBRSxJQUFnQjtRQXBFbkMsYUFBUSxHQUFHLFlBQVksQ0FBQztRQUUvQixlQUFlO1FBQ1AsaUJBQVksR0FBVSxFQUFFLENBQUM7UUFNakM7O1dBRUc7UUFDSyxnQkFBVyxHQUFHLElBQUksT0FBTyxFQUFnQixDQUFDO1FBRWxEOztXQUVHO1FBQ0ssY0FBUyxHQUFHLElBQUksU0FBUyxFQUFFLENBQUM7UUFFcEM7O1dBRUc7UUFDSyxjQUFTLEdBQUcsSUFBSSxTQUFTLEVBQUssQ0FBQztRQUV2QyxhQUFhO1FBR2IsZUFBZTtRQUVmOzs7V0FHRztRQUNJLGtCQUFhLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQW9DckQsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2IsSUFBSSxJQUFJLEVBQUU7WUFDUiwyQkFBMkI7WUFDM0IsSUFBSSxD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RCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssV0FBVyxDQUFDLEtBQWE7UUFDL0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUM5QixPQUFPLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNoQjtRQUNELElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQ3JDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxNQUFNLENBQUM7UUFDdkIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxlQUFlO1FBQ3JCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUMvQixJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ3ZCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ25DLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0NBSUYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJqZWN0LCBPYnNlcnZhYmxlLCBmcm9tIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IENoYW5nZVNldCB9IGZyb20gJy4uL2NoYW5nZXNldC9jaGFuZ2Vfc2V0JztcclxuaW1wb3J0IHsgTW9kaWZpY2F0aW9uLCBNb2RpZnlUeXBlIH0gZnJvbSAnLi4vY2hhbmdlc2V0L3R5cGVzJztcclxuaW1wb3J0IHsgRW50aXR5IH0gZnJvbSAnLi9lbnRpdHknO1xyXG5pbXBvcnQgeyBFbnRpdHlGYWN0b3J5IH0gZnJvbSAnLi9lbnRpdHlfY3JlYXRvcic7XHJcbmltcG9ydCB7IFBBUkVOVF9DTEFTUywgUEFSRU5UX1BBVEgsIENsYXNzVHlwZSB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBWYWxpZGF0b3IgfSBmcm9tICcuL3ZhbGlkYXRvci92YWxpZGF0b3InO1xyXG5pbXBvcnQgeyBWYWxpZGF0aW9uUmVzdWx0IH0gZnJvbSAnLi92YWxpZGF0b3IvdHlwZXMnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJTGlzdDxUPiB7XHJcbiAgW2luZGV4OiBudW1iZXJdOiBUO1xyXG59XHJcbi8qKlxyXG4gKiDlrp7kvZPpm4blkIjliJfooahcclxuICovXHJcbmV4cG9ydCBjbGFzcyBFbnRpdHlMaXN0PFQgZXh0ZW5kcyBFbnRpdHk+IGltcGxlbWVudHMgSUxpc3Q8VD4sIEl0ZXJhYmxlPFQ+IHtcclxuICBwdWJsaWMgX190eXBlX18gPSAnRW50aXR5TGlzdCc7XHJcblxyXG4gIC8vICNyZWdpb24g56eB5pyJ5bGe5oCnXHJcbiAgcHJpdmF0ZSBvcmlnaW5hbERhdGE6IGFueVtdID0gW107XHJcbiAgLyoqXHJcbiAgICog5bey5bqf5byD77ya6K+35Yu/5L2/55SoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByYXdEYXRhOiBUW107XHJcblxyXG4gIC8qKlxyXG4gICAqIOW3suW6n+W8g++8muivt+WLv+S9v+eUqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgbGlzdENoYW5nZWQgPSBuZXcgU3ViamVjdDxNb2RpZmljYXRpb24+KCk7XHJcblxyXG4gIC8qKlxyXG4gICAqIOW3suW6n+W8g++8muivt+WLv+S9v+eUqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgY2hhbmdlU2V0ID0gbmV3IENoYW5nZVNldCgpO1xyXG5cclxuICAvKipcclxuICAgKiDlt7Llup/lvIPvvJror7fli7/kvb/nlKhcclxuICAgKi9cclxuICBwcml2YXRlIHZhbGlkYXRvciA9IG5ldyBWYWxpZGF0b3I8VD4oKTtcclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLy8gI3JlZ2lvbiDlhazmnInlsZ7mgKdcclxuXHJcbiAgLyoqXHJcbiAgICog6ZuG5ZCI5pS55Y+Y5pe26Kem5Y+RKOaWsOWinuOAgeihjOiusOW9leS/ruaUueOAgeWIoOmZpClcclxuICAgKiBAZXZlbnRcclxuICAgKi9cclxuICBwdWJsaWMgb25MaXN0Q2hhbmdlZCA9IHRoaXMubGlzdENoYW5nZWQuYXNPYnNlcnZhYmxlKCk7XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlumhuembhuWQiFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQgaXRlbXMoKTogVFtdIHtcclxuICAgIHJldHVybiB0aGlzLnJhd0RhdGE7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliJfooajlj5jmm7Tpm4ZcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0IGNoYW5nZXMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5jaGFuZ2VTZXQuY2hhbmdlcztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluaMh+Wumue0ouW8leWkhOeahOWAvFxyXG4gICAqL1xyXG4gIFtpbmRleDogbnVtYmVyXTogVDtcclxuXHJcbiAgLyoqXHJcbiAgICog6L+t5Luj5ZmoXHJcbiAgICovXHJcbiAgKltTeW1ib2wuaXRlcmF0b3JdKCk6IEl0ZXJhdG9yPFQ+IHtcclxuICAgIHlpZWxkKiB0aGlzLml0ZW1zO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIGRhdGEgSlNPTuaVsOaNrumbhuWQiFxyXG4gICAqIEBwYXJhbSB0eXBlIOmbhuWQiOS4reeahOWunuS9k+exu+Wei1xyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKGRhdGE/OiBhbnlbXSwgdHlwZT86IENsYXNzVHlwZSkge1xyXG4gICAgdGhpcy5jbGVhcigpO1xyXG4gICAgaWYgKGRhdGEpIHtcclxuICAgICAgLy8gdGhpcy5sb2FkRW50aXRpZXMoZGF0YSk7XHJcbiAgICAgIGRhdGEuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICB0aGlzLmluaXRFbnRpdHkoRW50aXR5RmFjdG9yeSh0eXBlLCBpdGVtKSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG4gIC8vICNyZWdpb24g5YWs5pyJ5pa55rOVXHJcblxyXG4gIC8qKiDliqDovb3lrp7kvZPliJfooaggKi9cclxuICBwdWJsaWMgbG9hZEVudGl0aWVzKGVudGl0aWVzOiBUW10pIHtcclxuICAgIHRoaXMuY2xlYXIoKTtcclxuXHJcbiAgICBlbnRpdGllcy5mb3JFYWNoKGVudGl0eSA9PiB7XHJcbiAgICAgIHRoaXMuaW5pdEVudGl0eShlbnRpdHkpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g5Y+R6YCBTG9hZOWPmOabtFxyXG4gICAgY29uc3QgY2hhbmdlSXRlbSA9IHtcclxuICAgICAgcGF0aDogW10sXHJcbiAgICAgIHZhbHVlOiBlbnRpdGllcyxcclxuICAgICAgcHJlVmFsdWU6IHVuZGVmaW5lZCxcclxuICAgICAgdHlwZTogTW9kaWZ5VHlwZS5Mb2FkLFxyXG4gICAgICB0YXJnZXQ6IHRoaXNcclxuICAgIH07XHJcbiAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlSXRlbSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOa4heepulxyXG4gICAqL1xyXG4gIHB1YmxpYyBjbGVhcigpIHtcclxuICAgIHRoaXMucmF3RGF0YSA9IFtdO1xyXG4gICAgdGhpcy5vcmlnaW5hbERhdGEgPSBbXTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOWunuS9k+WvueixoeWIsOmbhuWQiOS4re+8jOW5tui/lOWbnuaWsOWKoOeahOWvueixoVxyXG4gICAqIEBwYXJhbSBlbnRpdHkg5a6e5L2T5a+56LGhXHJcbiAgICogQHBhcmFtIGlzQ2xvbmVkIOWFi+mahlxyXG4gICAqL1xyXG4gIHB1YmxpYyBhcHBlbmROZXcoZW50aXR5OiBULCBpc0Nsb25lZDogYm9vbGVhbiA9IGZhbHNlKTogVCB7XHJcbiAgICBjb25zdCBuZXdFbnRpdHkgPSB0aGlzLmluaXRFbnRpdHkoZW50aXR5LCB0cnVlKTtcclxuICAgIC8vIOaWsOWinuWPmOabtFxyXG4gICAgY29uc3QgY2hhbmdlSXRlbSA9IHtcclxuICAgICAgcGF0aDogW10sXHJcbiAgICAgIHZhbHVlOiBbbmV3RW50aXR5XSxcclxuICAgICAgcHJlVmFsdWU6IHVuZGVmaW5lZCxcclxuICAgICAgdHlwZTogTW9kaWZ5VHlwZS5BZGRcclxuICAgIH07XHJcbiAgICBpZiAoaXNDbG9uZWQgPT09IHRydWUpIHtcclxuICAgICAgY2hhbmdlSXRlbS50eXBlID0gTW9kaWZ5VHlwZS5DbG9uZTtcclxuICAgIH1cclxuICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VJdGVtKTtcclxuICAgIHJldHVybiBuZXdFbnRpdHk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWcqOaMh+WumuS9jee9ruaPkuWFpeWunuS9k1xyXG4gICAqIEBwYXJhbSBlbnRpdHkg5a6e5L2TXHJcbiAgICogQHBhcmFtIHBvc2l0aW9uIOaPkuWFpeS9jee9rlxyXG4gICAqL1xyXG4gIHB1YmxpYyBpbnNlcnQoZW50aXR5OiBULCBwb3NpdGlvbj86IDEgfCAtMSk6IFQge1xyXG4gICAgY29uc3QgbmV3RW50aXR5ID0gdGhpcy5pbml0RW50aXR5KGVudGl0eSwgdHJ1ZSk7XHJcblxyXG4gICAgLy8g5paw5aKe5Y+Y5pu0XHJcbiAgICBjb25zdCBjaGFuZ2VJdGVtID0ge1xyXG4gICAgICBwYXRoOiBbXSxcclxuICAgICAgdmFsdWU6IFtuZXdFbnRpdHldLFxyXG4gICAgICBwcmVWYWx1ZTogdW5kZWZpbmVkLFxyXG4gICAgICB0eXBlOiBNb2RpZnlUeXBlLkluc2VydCxcclxuICAgICAgcG9zaXRpb246IHBvc2l0aW9uLFxyXG4gICAgfTtcclxuXHJcbiAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlSXRlbSk7XHJcbiAgICByZXR1cm4gbmV3RW50aXR5O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDov73liqDlrp7kvZNcclxuICAgKi9cclxuICBwdWJsaWMgYXBwZW5kRW50aXR5KGVudGl0eTogVCk6IHZvaWQge1xyXG4gICAgY29uc3QgbmV3RW50aXR5ID0gdGhpcy5pbml0RW50aXR5KGVudGl0eSwgdHJ1ZSk7XHJcbiAgICAvLyDmlrDlop7lj5jmm7RcclxuICAgIGNvbnN0IGNoYW5nZUl0ZW0gPSB7XHJcbiAgICAgIHBhdGg6IFtdLFxyXG4gICAgICB2YWx1ZTogW25ld0VudGl0eV0sXHJcbiAgICAgIHByZVZhbHVlOiB1bmRlZmluZWQsXHJcbiAgICAgIHR5cGU6IE1vZGlmeVR5cGUuQWRkXHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VJdGVtKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJuemHj+i/veWKoOWunuS9k1xyXG4gICAqL1xyXG4gIHB1YmxpYyBhcHBlbmRFbnRpdGllcyhlbnRpdGllczogVFtdKTogdm9pZCB7XHJcbiAgICBjb25zdCBuZXdFbnRpdGVzID0gZW50aXRpZXMubWFwKChlbnRpdHk6IFQpID0+IHtcclxuICAgICAgcmV0dXJuIHRoaXMuaW5pdEVudGl0eShlbnRpdHksIHRydWUpO1xyXG4gICAgfSk7XHJcbiAgICBjb25zdCBjaGFuZ2VJdGVtID0ge1xyXG4gICAgICBwYXRoOiBbXSxcclxuICAgICAgdmFsdWU6IG5ld0VudGl0ZXMsXHJcbiAgICAgIHByZVZhbHVlOiB1bmRlZmluZWQsXHJcbiAgICAgIHR5cGU6IE1vZGlmeVR5cGUuQWRkXHJcbiAgICB9O1xyXG4gICAgdGhpcy5zZXRDaGFuZ2VzKGNoYW5nZUl0ZW0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yig6Zmk5oyH5a6a5Li76ZSuSUQg55qE5a6e5L2T5a+56LGh77yM6L+U5Zue5biD5bCU77yMdHJ1ZSDliKDpmaTmiJDlip/vvIxmYWxzZSDliKDpmaTlpLHotKVcclxuICAgKiBAcGFyYW0gcHJpbWFyeUlkIOS4u+mUrklEXHJcbiAgICovXHJcbiAgcHVibGljIHJlbW92ZShwcmltYXJ5SWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgY29uc3QgdG90YWwgPSB0aGlzLmNvdW50KCk7XHJcbiAgICBjb25zdCBpbmRleFRvUmVtb3ZlID0gdGhpcy5yYXdEYXRhLmZpbmRJbmRleCgoZW50aXR5OiBFbnRpdHkpID0+IHtcclxuICAgICAgcmV0dXJuIGVudGl0eS5wcmltYXJ5VmFsdWUgPT09IHByaW1hcnlJZDtcclxuICAgIH0pO1xyXG4gICAgaWYgKGluZGV4VG9SZW1vdmUgPT09IC0xKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGNvbnN0IGVudGl0eVRvUmVtb3ZlID0gdGhpcy5yYXdEYXRhW2luZGV4VG9SZW1vdmVdO1xyXG4gICAgdGhpcy5yYXdEYXRhLnNwbGljZShpbmRleFRvUmVtb3ZlLCAxKTtcclxuXHJcbiAgICAvLyDliKDpmaTlj5jmm7RcclxuICAgIGNvbnN0IGNoYW5nZUl0ZW0gPSB7XHJcbiAgICAgIHBhdGg6IFtdLFxyXG4gICAgICB2YWx1ZTogeyBbZW50aXR5VG9SZW1vdmUucHJpbWFyeVByb3BlcnR5LmRhdGFGaWVsZF06IHByaW1hcnlJZCB9LFxyXG4gICAgICBwcmVWYWx1ZTogdW5kZWZpbmVkLFxyXG4gICAgICB0eXBlOiBNb2RpZnlUeXBlLlJlbW92ZVxyXG4gICAgfTtcclxuXHJcbiAgICB0aGlzLnVwZGF0ZUluZGV4KHRvdGFsKTtcclxuICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VJdGVtKTtcclxuXHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOS7jumbhuWQiOS4reiOt+WPluaMh+WumklE5YC855qE5a6e5L2T5a+56LGhXHJcbiAgICogQHBhcmFtIGlkIOS4u+mUruWAvFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQoaWQ6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIHRoaXMuaXRlbXMuZmluZChpdGVtID0+IHtcclxuICAgICAgcmV0dXJuIGl0ZW0ucHJpbWFyeVZhbHVlID09PSBpZDtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bCG5Y+Y5pu06K6w5b2V5re75Yqg5Yiw6ZuG5ZCI5Y+Y5pu06ZuG5LitXHJcbiAgICogQHBhcmFtIHZhbHVlIOWPmOabtOiusOW9lVxyXG4gICAqL1xyXG4gIHB1YmxpYyBzZXRDaGFuZ2VzKG1vZGluZm86IE1vZGlmaWNhdGlvbikge1xyXG5cclxuICAgIC8vIOWQkWFwcOWxguWPkemAgeeahOWPmOabtFxyXG4gICAgdGhpcy5saXN0Q2hhbmdlZC5uZXh0KG1vZGluZm8pO1xyXG5cclxuICAgIC8vIOaehOmAoOWQkWNoYW5nZVNldOS4rea3u+WKoOeahGNoYWduZVxyXG4gICAgY29uc3QgY2hhbmdlID0gT2JqZWN0LmFzc2lnbih7fSwgbW9kaW5mbyk7XHJcbiAgICBpZiAoKG1vZGluZm8udHlwZSA9PT0gTW9kaWZ5VHlwZS5BZGQgfHwgbW9kaW5mby50eXBlID09PSBNb2RpZnlUeXBlLkluc2VydCB8fCBtb2RpbmZvLnR5cGUgPT09IE1vZGlmeVR5cGUuQ2xvbmUpICYmIG1vZGluZm8udmFsdWVbMF0gaW5zdGFuY2VvZiBFbnRpdHkpIHtcclxuICAgICAgY2hhbmdlLnZhbHVlID0gW21vZGluZm8udmFsdWVbMF0uZGF0YV07XHJcbiAgICB9XHJcbiAgICB0aGlzLmNoYW5nZVNldC5hcHBlbmQoY2hhbmdlKTtcclxuICB9XHJcblxyXG4gIC8qKiDpm4blkIjmgLvorrDlvZXmlbAgKi9cclxuICBwdWJsaWMgY291bnQoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5pdGVtcy5sZW5ndGg7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blrp7kvZPlr7nosaHnmoTntKLlvJXlgLxcclxuICAgKi9cclxuICBwdWJsaWMgaW5kZXhPZihlbnRpdHk6IFQpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIHRoaXMuaXRlbXMuaW5kZXhPZihlbnRpdHkpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6h566X6ZuG5ZCI5Lit5p+Q5Liq5bGe5oCn55qE5oC75ZKMXHJcbiAgICogQHBhcmFtIHByb3BlcnR5TmFtZSDlsZ7mgKflkI3np7BcclxuICAgKi9cclxuICBwdWJsaWMgc3VtKHByb3BlcnR5TmFtZTogc3RyaW5nKTogbnVtYmVyIHtcclxuICAgIGlmICh0aGlzLmNvdW50KCkgPT09IDApIHtcclxuICAgICAgcmV0dXJuIDA7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5pdGVtcy5yZWR1Y2UoKHZhbCwgY3VycjogVCkgPT4ge1xyXG4gICAgICByZXR1cm4gdmFsICsgY3Vycltwcm9wZXJ0eU5hbWVdO1xyXG4gICAgfSwgMCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDpm4blkIjmlbDmja7pqozor4FcclxuICAgKi9cclxuICBwdWJsaWMgdmFsaWRhdGUoKTogT2JzZXJ2YWJsZTxWYWxpZGF0aW9uUmVzdWx0PiB7XHJcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSB0aGlzLmdldFByb3BlcnR5TmFtZSgpO1xyXG4gICAgcmV0dXJuIGZyb20odGhpcy52YWxpZGF0b3IudmFsaWRhdGUodGhpc1tQQVJFTlRfQ0xBU1NdLCBwcm9wZXJ0eU5hbWUpKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOW3suW6n+W8g++8muivt+S9v+eUqHRvSlNPTuaWueazleS7o+abv1xyXG4gICAqIEBkZXByZWNhdGVkXHJcbiAgICovXHJcbiAgcHVibGljIHRvSnNvbigpIHtcclxuICAgIHJldHVybiB0aGlzLnJhd0RhdGE7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDovazmjaLkuLpKU09O5qC85byPXHJcbiAgICovXHJcbiAgcHVibGljIHRvSlNPTigpOiBhbnlbXSB7XHJcbiAgICBjb25zdCByZXN1bHQgPSBbXTtcclxuICAgIHRoaXMuaXRlbXMuZm9yRWFjaCgoZW50aXR5OiBFbnRpdHkpID0+IHtcclxuICAgICAgcmVzdWx0LnB1c2goZW50aXR5LnRvSlNPTigpKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcblxyXG4gIHB1YmxpYyB0b0FycmF5KCk6IFRbXSB7XHJcbiAgICByZXR1cm4gdGhpcy5pdGVtcztcclxuICB9XHJcblxyXG4gIC8vICNlbmRyZWdpb25cclxuXHJcblxyXG4gIC8vICNyZWdpb24g56eB5pyJ5pa55rOVXHJcblxyXG4gIC8qKlxyXG4gICAqIOWunuS9k+WIneWni+WMllxyXG4gICAqIEBwYXJhbSBlbnRpdHkg5a6e5L2TXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpbml0RW50aXR5KGVudGl0eTogVCwgaXNOZXdFbnRpdHk6IGJvb2xlYW4gPSBmYWxzZSk6IFQge1xyXG4gICAgZW50aXR5W1BBUkVOVF9DTEFTU10gPSB0aGlzO1xyXG4gICAgZW50aXR5W1BBUkVOVF9QQVRIXSA9IHRoaXNbUEFSRU5UX1BBVEhdO1xyXG4gICAgZW50aXR5Lm9uVmFsdWVDaGFuZ2VkLnN1YnNjcmliZSgodjogTW9kaWZpY2F0aW9uKSA9PiB7XHJcbiAgICAgIGNvbnN0IHBhdGggPSB2LnBhdGg7XHJcbiAgICAgIGNvbnN0IHZhbHVlID0gdi52YWx1ZTtcclxuICAgICAgY29uc3QgcHJlVmFsdWUgPSB2LnByZVZhbHVlO1xyXG4gICAgICBjb25zdCBvcGVyYXRvciA9IHYudHlwZTtcclxuICAgICAgY29uc3Qgc3ViQ2hhbmdlcyA9IHsgcGF0aCwgdmFsdWUsIHByZVZhbHVlLCB0eXBlOiBvcGVyYXRvciB9O1xyXG4gICAgICBpZiAodi5jaGFuZ2VTZXRWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgc3ViQ2hhbmdlc1snY2hhbmdlU2V0VmFsdWUnXSA9IHYuY2hhbmdlU2V0VmFsdWU7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5zZXRDaGFuZ2VzKHN1YkNoYW5nZXMpO1xyXG4gICAgfSk7XHJcbiAgICAvLyBUT0RPOiDmt7vliqDmlbDmja7pqozor4HpgLvovpHku6PnoIFcclxuICAgIGNvbnN0IG5ld0xlbmd0aCA9IHRoaXMucmF3RGF0YS5wdXNoKGVudGl0eSk7XHJcbiAgICB0aGlzW25ld0xlbmd0aCAtIDFdID0gZW50aXR5O1xyXG4gICAgaWYgKCFpc05ld0VudGl0eSkge1xyXG4gICAgICB0aGlzLm9yaWdpbmFsRGF0YS5wdXNoKGVudGl0eS50b0pTT04oKSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZW50aXR5O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5pu05paw57Si5byVXHJcbiAgICogQHBhcmFtIHRvdGFsIOaAu+iusOW9leaVsFxyXG4gICAqL1xyXG4gIHByaXZhdGUgdXBkYXRlSW5kZXgodG90YWw6IG51bWJlcikge1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0b3RhbDsgaSsrKSB7XHJcbiAgICAgIGRlbGV0ZSB0aGlzW2ldO1xyXG4gICAgfVxyXG4gICAgdGhpcy5yYXdEYXRhLmZvckVhY2goKGVudGl0eSwgaW5kZXgpID0+IHtcclxuICAgICAgdGhpc1tpbmRleF0gPSBlbnRpdHk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWxnuaAp+WQjeensFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0UHJvcGVydHlOYW1lKCkge1xyXG4gICAgY29uc3QgcGF0aCA9IHRoaXNbUEFSRU5UX1BBVEhdO1xyXG4gICAgaWYgKHBhdGggJiYgcGF0aC5sZW5ndGgpIHtcclxuICAgICAgY29uc3QgbmFtZSA9IHBhdGhbcGF0aC5sZW5ndGggLSAxXTtcclxuICAgICAgcmV0dXJuIG5hbWU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxufVxyXG4iXX0=