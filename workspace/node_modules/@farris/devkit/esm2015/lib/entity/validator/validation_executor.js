import { ValidationError } from './validation_error';
import { ValidationTypes } from './validation_types';
import { EntityList } from '../entity_list';
import { FieldMetadataUtil } from '../metadata/index';
/**
 * 执行数据验证
 */
export class ValidationExecutor {
    constructor(validator) {
        this.validator = validator;
        /** 异步验证请求集合 */
        this.awaitingPromises = [];
    }
    /**
     * 将信息中的关键字替换为具体实体对象中的信息
     * @param message 验证信息
     * @param metadata 验证规则
     * @param value 待验证的值
     */
    static replaceMessageSpecialTokens(message, metadata, value) {
        let messageString;
        if (message instanceof Function) {
            messageString = message(metadata);
        }
        else if (typeof message === 'string') {
            messageString = message;
        }
        if (messageString && metadata.constraints instanceof Array) {
            metadata.constraints.forEach((constraint, index) => {
                messageString = messageString.replace(new RegExp(`\\$constraint${index + 1}`, 'g'), constraint);
            });
        }
        if (messageString && value !== undefined && value !== null) {
            messageString = messageString.replace(/\$value/g, value);
        }
        if (messageString) {
            messageString = messageString.replace(/\$property/g, metadata.property);
        }
        if (messageString) {
            messageString = messageString.replace(/\$target/g, metadata.targetName);
        }
        return messageString;
    }
    /**
     * 验证实例对象
     * @param object 验证实例对象
     * @param newValue 实体将要更新的值
     * @param validationErrors 验证信息集合
     * @param propertyName 实例对象属性
     * @param index 所属集合实例中索引
     */
    execute(object, newValue, validationErrors, propertyName, index, externalRules, currentRowId, frameContext) {
        // if (!currentRowId) {
        //   currentRowId = object.primaryValue;
        // }
        if (!externalRules && frameContext) {
            externalRules = frameContext.form.getValidationRules();
        }
        // 提取实体上定义的验证描述
        // 格式{key:[rule1,rule2]}
        let validateMetadatas = FieldMetadataUtil.getValidationMetadataWithPath(object);
        const remainedExternalRules = new Map();
        // 合并额外验证规则
        if (externalRules) {
            // const parentPathArray: string[] = object['__PARENT_PATH__'] ? [...object['__PARENT_PATH__']] : [''];
            // if (parentPathArray.length > 1) {
            //   parentPathArray[0] = '';
            // }
            const parentPathArray = [];
            let objectCursor = object;
            while (objectCursor && objectCursor !== objectCursor['__PARENT__']) {
                const cursorParentPath = objectCursor['__PARENT_PATH__'] ? objectCursor['__PARENT_PATH__'][1] : '';
                // if (parentPathArray[parentPathArray.length - 1] !== cursorParentPath) {
                parentPathArray.push(cursorParentPath);
                // }
                objectCursor = objectCursor['__PARENT__'];
                if (objectCursor instanceof EntityList) {
                    objectCursor = objectCursor['__PARENT__'];
                }
            }
            const parentPath = parentPathArray.reverse().join('/');
            externalRules.forEach((rules, path) => {
                if (path) {
                    // 提取额外验证规则字段路径
                    const pathArray = path.split('/');
                    // 提取字段名称
                    const fieldName = pathArray.pop();
                    // 提取字段父路径
                    const fieldParentPath = pathArray.join('/');
                    // 匹配外部验证规则和实体验证规则父路径
                    if (parentPath === fieldParentPath) {
                        validateMetadatas[fieldName] = [...(validateMetadatas[fieldName] || [])];
                        // 合并外部校验规则到实体校验规则，并同步外部验证规则显示信息至实体验证规则，如：中英文字段描述、字段所在位置。
                        if (rules.length) {
                            let targetId = '';
                            rules.forEach(rule => {
                                if (rule.targetId && rule.targetId.length > targetId.length) {
                                    targetId = rule.targetId;
                                }
                                validateMetadatas[fieldName].push(rule);
                            });
                            validateMetadatas[fieldName].forEach((validateRule) => {
                                validateRule.targetId = targetId;
                                validateRule.targetName = rules[0].targetName;
                                validateRule.property = rules[0].property;
                                if (rules[0].frameContext) {
                                    validateRule.frameContext = rules[0].frameContext;
                                }
                                validateRule.fullPath = rules[0].fullPath;
                                validateRule['initialized'] = true;
                            });
                        }
                    }
                    else {
                        remainedExternalRules.set(path, rules);
                    }
                }
            });
        }
        // 处理校验规则中的属性名称
        // 场景为前端未开启校验或form校验规则中对应绑定路径中对应控件未开启校验，导致上一步骤中组件名、字段名未能同步为对应中文
        if (validateMetadatas && Object.keys(validateMetadatas).length > 0) {
            Object.keys(validateMetadatas).forEach((fieldName) => {
                const validateRules = validateMetadatas[fieldName];
                if (validateRules && validateRules.length > 0) {
                    const firstValidateRule = validateRules[0];
                    const path = firstValidateRule['path'];
                    if (path) {
                        validateRules.forEach((validateRule) => {
                            // 将initialized判断外移减少代码执行次数
                            if (validateRule['initialized'] !== true) {
                                const bindingPaths = path.split('.');
                                const form = this.getForm(bindingPaths, frameContext);
                                const formControl = this.getFormControl(bindingPaths, frameContext);
                                if (formControl) {
                                    validateRule.targetId = formControl.id;
                                    validateRule.targetName = form && form.formGroupName;
                                    validateRule.property = formControl.name || formControl.defaultI18nValue || '';
                                }
                            }
                        });
                    }
                }
            });
        }
        // 过滤出当前验证属性的验证规则
        if (propertyName) {
            validateMetadatas = Object.keys(validateMetadatas)
                .filter(key => key === propertyName)
                .reduce((val, curr) => Object.assign({}, val, { [curr]: validateMetadatas[curr] }), {});
        }
        // validateMetadatas = {rule:当前属性的所有校验规则}
        Object.keys(validateMetadatas).filter((key) => object && (object.hasOwnProperty(key) ||
            (object.constructor.prototype &&
                object.constructor.prototype.typeName &&
                object.constructor.prototype.hasOwnProperty(key)) ||
            object['__proto__'].hasOwnProperty(key))).forEach(key => {
            // todo: 没用兼容value是undefined的情况
            let value = newValue;
            if (newValue === undefined) {
                value = object[key];
            }
            let isMultLanguageField = false;
            const multiLangFields = this.getMultiLanguageFields(object);
            if (multiLangFields && multiLangFields.length > 0) {
                if (multiLangFields.includes(key)) {
                    isMultLanguageField = true;
                }
            }
            // const value = newValue ||
            const validateRules = validateMetadatas[key];
            if (validateRules.length) {
                const { property: fieldName, targetId: field, frameContext, fullPath } = validateRules[0];
                // const fieldContainerName = Number.isInteger(index) ?
                // `${validateRules[0].targetName} 第${index + 1}行` : validateRules[0].targetName;
                const fieldContainerName = Number.isInteger(index) ?
                    ValidationExecutor.replaceMessageSpecialTokens(ValidationTypes.getMessage(ValidationTypes.FIELD_CONTAINER), validateRules[0], index + 1) : validateRules[0].targetName;
                const validationDisplayName = fieldContainerName ? `${fieldContainerName} - ${fieldName}` : `${fieldName}`;
                // const property = validateRules['path'] || key;
                const validationError = this.generateValidationError(object, value, key, validationDisplayName, index, field, frameContext, fullPath);
                if (index !== undefined) {
                    validationError['index'] = index;
                }
                validationErrors.push(validationError);
                this.defaultValidations(object, value, validateRules, validationError, isMultLanguageField, currentRowId);
            }
        });
        this.objectValidations(object, validationErrors, propertyName, index, remainedExternalRules, currentRowId, frameContext);
        this.listValidations(object, validationErrors, propertyName, index, remainedExternalRules, frameContext);
        // this.sortValidationErrors(validationErrors);
        // todo 存在某些ngObject类型的数据，界面上没有，实体中有，实体设置了必填，导致验证不通过无法保存的问题
        // if (!propertyName) {
        //     this.objectValidations(object, validationErrors);
        // }
    }
    getMultiLanguageFields(entity) {
        if (entity && entity.constructor) {
            const ngFields = FieldMetadataUtil.getNgFields(entity.constructor);
            return Object.keys(ngFields).filter((fieldName) => ngFields[fieldName].enableMultiLangInput);
        }
        return null;
    }
    /**
     * 清除通过验证信息
     * @param errors 验证失败信息
     */
    stripEmptyErrors(errors) {
        return errors.filter(error => {
            if (error.children) {
                error.children = this.stripEmptyErrors(error.children);
            }
            if (Object.keys(error.constraints).length === 0) {
                if (error.children.length === 0) {
                    return false;
                }
                else {
                    delete error.constraints;
                }
            }
            return true;
        });
    }
    /**
     * 生成未通过验证的对象
     * @param object 要验证的实体实例对象
     * @param value 要验证的值
     * @param propertyName 待验证的实体属性名称
     * @param index 验证数据索引
     * @param field 待验证字段
     */
    generateValidationError(object, value, property, propertyName, index, field, frameContext, fullPath) {
        const validationError = new ValidationError();
        validationError.target = object;
        validationError.value = value;
        validationError.property = property;
        validationError.propertyName = propertyName;
        validationError.field = field;
        validationError.index = index;
        validationError.children = [];
        validationError.constraints = {};
        if (frameContext) {
            validationError.frameContext = frameContext;
        }
        validationError.fullPath = fullPath;
        return validationError;
    }
    /**
     * 验证实体中的属性
     * @param object 要验证的实体实例对象
     * @param value 要验证的值
     * @param validateRules 验证规则
     * @param errorMap 难证信息。{[key]: message}
     *
     * key: 验证规则名称
     * message: 验证信息
     */
    defaultValidations(object, value, validateRules, validationError, isMultLanguageField, currentRowId) {
        const errorMap = validationError.constraints;
        return validateRules
            .filter((validateRule) => {
            // 验证实体属性是否符合规则
            const validValue = this.validator.validateValueByMetadata(object, value, validateRule, isMultLanguageField, currentRowId);
            if (validValue instanceof Promise) {
                const promise = validValue.then((isValid) => {
                    if (!isValid) {
                        const { type, messageString: message } = this.createValidationError(object, value, validateRule);
                        errorMap[type] = message;
                        validationError.rule = validateRule;
                    }
                });
                this.awaitingPromises.push(promise);
            }
            return !validValue;
        })
            .forEach((validateRule) => {
            // 不符合规则，生成错误信息
            const { type: key, messageString: message } = this.createValidationError(object, value, validateRule);
            errorMap[key] = message;
            validationError.rule = validateRule;
        });
    }
    /**
     * 验证列表中的每条记录
     * @param object 要验证的实体实例对象
     * @param errors 验证失败的信息集合
     * @param property 属性名称
     * @param parentIndex 当前集合的父对象所属集合列表中的索引。
     */
    listValidations(object, errors, property, parentIndex, externalRules, frameContext) {
        const INDEX_LABEL = "__ACTUAL_INDEX__";
        const listFields = FieldMetadataUtil.getNgList(object.constructor);
        if (!listFields) {
            return;
        }
        let keys = Object.keys(listFields);
        if (property) {
            keys = keys.filter(key => key === property);
        }
        keys.forEach(propertyName => {
            const metadata = listFields[propertyName];
            const clzType = metadata.type;
            const value = object[propertyName];
            if (value) {
                const parentPaths = object.getPaths().path || [];
                parentPaths.push(propertyName);
                const validationError = this.generateValidationError(object, value.items, parentPaths.join('.'), propertyName, parentIndex);
                validationError.isArray = true;
                errors.push(validationError);
                value.items.forEach((entity, index) => {
                    let actualIndex = entity[INDEX_LABEL] ? entity[INDEX_LABEL] : index;
                    this.execute(entity, undefined, validationError.children, undefined, actualIndex, externalRules, entity.primaryValue, frameContext);
                });
            }
        });
    }
    /**
     * 验证实体中的引用对象
     * @param object 要验证的实体对象
     * @param errors 错误信息集合
     */
    objectValidations(object, errors, property, parentIndex, externalRules, currentRowId, frameContext) {
        const objectFields = FieldMetadataUtil.getNgObjects(object.constructor);
        if (!objectFields || Object.keys(objectFields).length < 1) {
            return;
        }
        let keys = Object.keys(objectFields);
        if (property) {
            keys = keys.filter(key => key === property);
        }
        keys.forEach(propertyName => {
            const metadata = objectFields[propertyName];
            const objectType = metadata.type;
            const value = object[propertyName];
            if (value) {
                this.execute(value, undefined, errors, undefined, parentIndex, externalRules, currentRowId, frameContext);
            }
        });
    }
    /**
     * 创建验证规则信息
     * @param object 要验证的实体对象
     * @param value 验证的值
     * @param metadata 验证规则
     */
    createValidationError(object, value, metadata) {
        // const targetName = object.constructor ? (object.constructor as any).name : undefined;
        const type = metadata.type;
        // 获取校验提示信息：先使用内置规则获取，获取不到时使用元数据上的提示，以兼容表达式场景
        let message = ValidationTypes.getMessage(type);
        if (!message) {
            message = metadata.message;
        }
        if (ValidationTypes.isValidType(type) && (type === ValidationTypes.MAXVALUE || type === ValidationTypes.MINVALUE)) {
            if (this.isDateString(value) && metadata.constraints && metadata.constraints.length) {
                // 获取日期类型的提示信息
                const extType = type === ValidationTypes.MINVALUE ? ValidationTypes.MIN_DATE : ValidationTypes.MAX_DATE;
                message = ValidationTypes.getMessage(extType);
                /*if (metadata.constraints[0]) {
                  metadata.constraints[0] = DateUtil.format(metadata.constraints[0], 'yyyy-MM-dd HH:mm:ss');
                }*/
            }
        }
        const messageString = ValidationExecutor.replaceMessageSpecialTokens(message, metadata, value);
        return { type, messageString, metadata };
    }
    getFrameContext(bindingPaths, eventFrameContext) {
        if (!bindingPaths || bindingPaths.length < 1 || !eventFrameContext) {
            return null;
        }
        const paths = bindingPaths.concat([]);
        paths.pop();
        const bindingPath = paths.join('/');
        const frameContext = eventFrameContext.appContext.frameContextManager.getFrameContexts().find((context) => context && context.viewModel && context.viewModel.bindingPath && context.viewModel.bindingPath.split('/').filter(p => p).join('/') === bindingPath);
        return frameContext || null;
    }
    getForm(bindingPaths, eventFrameContext) {
        if (!bindingPaths || bindingPaths.length < 1 || !eventFrameContext) {
            return null;
        }
        const frameContext = this.getFrameContext(bindingPaths, eventFrameContext);
        return frameContext && frameContext.form || null;
    }
    getFormControl(bindingPaths, eventFrameContext) {
        if (!bindingPaths || bindingPaths.length < 1 || !eventFrameContext) {
            return null;
        }
        const paths = bindingPaths.concat([]);
        const propertyName = paths.pop();
        const frameContext = this.getFrameContext(bindingPaths, eventFrameContext);
        const formControl = frameContext && frameContext.form && frameContext.form.ngFormControls && frameContext.form.ngFormControls[propertyName] || null;
        return formControl;
    }
    isDateString(value) {
        const regex = /\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])(T|\s?)?(([0-2]\d:[0-5]\d)?(:[0-5]\d(?:\.\d+)))?(?:Z|\+[0-2]\d(?:\:[0-5]\d)?)?/g;
        return regex.test(value);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGlvbl9leGVjdXRvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2VudGl0eS92YWxpZGF0b3IvdmFsaWRhdGlvbl9leGVjdXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFckQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM1QyxPQUFPLEVBQUUsaUJBQWlCLEVBQW1CLE1BQU0sbUJBQW1CLENBQUM7QUFJdkU7O0dBRUc7QUFDSCxNQUFNLE9BQU8sa0JBQWtCO0lBRTdCLFlBQW9CLFNBQXVCO1FBQXZCLGNBQVMsR0FBVCxTQUFTLENBQWM7UUFFM0MsZUFBZTtRQUNmLHFCQUFnQixHQUFtQixFQUFFLENBQUM7SUFIUyxDQUFDO0lBSWhEOzs7OztPQUtHO0lBQ0ksTUFBTSxDQUFDLDJCQUEyQixDQUFDLE9BQVksRUFBRSxRQUFzQixFQUFFLEtBQVU7UUFDeEYsSUFBSSxhQUFxQixDQUFDO1FBQzFCLElBQUksT0FBTyxZQUFZLFFBQVEsRUFBRTtZQUMvQixhQUFhLEdBQUksT0FBMEMsQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUN2RTthQUFNLElBQUksT0FBTyxPQUFPLEtBQUssUUFBUSxFQUFFO1lBQ3RDLGFBQWEsR0FBRyxPQUFpQixDQUFDO1NBQ25DO1FBRUQsSUFBSSxhQUFhLElBQUksUUFBUSxDQUFDLFdBQVcsWUFBWSxLQUFLLEVBQUU7WUFDMUQsUUFBUSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLEVBQUU7Z0JBQ2pELGFBQWEsR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksTUFBTSxDQUFDLGdCQUFnQixLQUFLLEdBQUcsQ0FBQyxFQUFFLEVBQUUs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ZS1sZW5ndGhcclxuaW1wb3J0IHsgVmFsaWRhdG9yIH0gZnJvbSAnLi92YWxpZGF0b3InO1xyXG5pbXBvcnQgeyBWYWxpZGF0ZVJ1bGUgfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgVmFsaWRhdGlvbkVycm9yIH0gZnJvbSAnLi92YWxpZGF0aW9uX2Vycm9yJztcclxuaW1wb3J0IHsgRW50aXR5IH0gZnJvbSAnLi4vZW50aXR5JztcclxuaW1wb3J0IHsgVmFsaWRhdGlvblR5cGVzIH0gZnJvbSAnLi92YWxpZGF0aW9uX3R5cGVzJztcclxuaW1wb3J0IHsgRW50aXR5TGlzdCB9IGZyb20gJy4uL2VudGl0eV9saXN0JztcclxuaW1wb3J0IHsgRmllbGRNZXRhZGF0YVV0aWwsIE5nRmllbGRQcm9wZXJ0eSB9IGZyb20gJy4uL21ldGFkYXRhL2luZGV4JztcclxuaW1wb3J0IHsgRGF0ZVV0aWwgfSBmcm9tICcuLi8uLi91dGlscy9kYXRlX3V0aWwnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQgfSBmcm9tICcuLi8uLi9mcmFtZS9pbmRleCc7XHJcblxyXG4vKipcclxuICog5omn6KGM5pWw5o2u6aqM6K+BXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgVmFsaWRhdGlvbkV4ZWN1dG9yPFQgZXh0ZW5kcyBFbnRpdHk+IHtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSB2YWxpZGF0b3I6IFZhbGlkYXRvcjxUPikgeyB9XHJcblxyXG4gIC8qKiDlvILmraXpqozor4Hor7fmsYLpm4blkIggKi9cclxuICBhd2FpdGluZ1Byb21pc2VzOiBQcm9taXNlPGFueT5bXSA9IFtdO1xyXG4gIC8qKlxyXG4gICAqIOWwhuS/oeaBr+S4reeahOWFs+mUruWtl+abv+aNouS4uuWFt+S9k+WunuS9k+WvueixoeS4reeahOS/oeaBr1xyXG4gICAqIEBwYXJhbSBtZXNzYWdlIOmqjOivgeS/oeaBr1xyXG4gICAqIEBwYXJhbSBtZXRhZGF0YSDpqozor4Hop4TliJlcclxuICAgKiBAcGFyYW0gdmFsdWUg5b6F6aqM6K+B55qE5YC8XHJcbiAgICovXHJcbiAgcHVibGljIHN0YXRpYyByZXBsYWNlTWVzc2FnZVNwZWNpYWxUb2tlbnMobWVzc2FnZTogYW55LCBtZXRhZGF0YTogVmFsaWRhdGVSdWxlLCB2YWx1ZTogYW55KSB7XHJcbiAgICBsZXQgbWVzc2FnZVN0cmluZzogc3RyaW5nO1xyXG4gICAgaWYgKG1lc3NhZ2UgaW5zdGFuY2VvZiBGdW5jdGlvbikge1xyXG4gICAgICBtZXNzYWdlU3RyaW5nID0gKG1lc3NhZ2UgYXMgKGFyZ3M6IFZhbGlkYXRlUnVsZSkgPT4gc3RyaW5nKShtZXRhZGF0YSk7XHJcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBtZXNzYWdlID09PSAnc3RyaW5nJykge1xyXG4gICAgICBtZXNzYWdlU3RyaW5nID0gbWVzc2FnZSBhcyBzdHJpbmc7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG1lc3NhZ2VTdHJpbmcgJiYgbWV0YWRhdGEuY29uc3RyYWludHMgaW5zdGFuY2VvZiBBcnJheSkge1xyXG4gICAgICBtZXRhZGF0YS5jb25zdHJhaW50cy5mb3JFYWNoKChjb25zdHJhaW50LCBpbmRleCkgPT4ge1xyXG4gICAgICAgIG1lc3NhZ2VTdHJpbmcgPSBtZXNzYWdlU3RyaW5nLnJlcGxhY2UobmV3IFJlZ0V4cChgXFxcXCRjb25zdHJhaW50JHtpbmRleCArIDF9YCwgJ2cnKSwgY29uc3RyYWludCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChtZXNzYWdlU3RyaW5nICYmIHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09IG51bGwpIHtcclxuICAgICAgbWVzc2FnZVN0cmluZyA9IG1lc3NhZ2VTdHJpbmcucmVwbGFjZSgvXFwkdmFsdWUvZywgdmFsdWUpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChtZXNzYWdlU3RyaW5nKSB7XHJcbiAgICAgIG1lc3NhZ2VTdHJpbmcgPSBtZXNzYWdlU3RyaW5nLnJlcGxhY2UoL1xcJHByb3BlcnR5L2csIG1ldGFkYXRhLnByb3BlcnR5KTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAobWVzc2FnZVN0cmluZykge1xyXG4gICAgICBtZXNzYWdlU3RyaW5nID0gbWVzc2FnZVN0cmluZy5yZXBsYWNlKC9cXCR0YXJnZXQvZywgbWV0YWRhdGEudGFyZ2V0TmFtZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG1lc3NhZ2VTdHJpbmc7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDpqozor4Hlrp7kvovlr7nosaFcclxuICAgKiBAcGFyYW0gb2JqZWN0IOmqjOivgeWunuS+i+WvueixoVxyXG4gICAqIEBwYXJhbSBuZXdWYWx1ZSDlrp7kvZPlsIbopoHmm7TmlrDnmoTlgLxcclxuICAgKiBAcGFyYW0gdmFsaWRhdGlvbkVycm9ycyDpqozor4Hkv6Hmga/pm4blkIhcclxuICAgKiBAcGFyYW0gcHJvcGVydHlOYW1lIOWunuS+i+WvueixoeWxnuaAp1xyXG4gICAqIEBwYXJhbSBpbmRleCDmiYDlsZ7pm4blkIjlrp7kvovkuK3ntKLlvJVcclxuICAgKi9cclxuICBleGVjdXRlKG9iamVjdDogVCwgbmV3VmFsdWUsIHZhbGlkYXRpb25FcnJvcnM6IFZhbGlkYXRpb25FcnJvcltdLCBwcm9wZXJ0eU5hbWU/OiBzdHJpbmcsIGluZGV4PzogYW55LCBleHRlcm5hbFJ1bGVzPzogTWFwPHN0cmluZywgVmFsaWRhdGVSdWxlW10+LCBjdXJyZW50Um93SWQ/OiBzdHJpbmcsIGZyYW1lQ29udGV4dD86IEZyYW1lQ29udGV4dCkge1xyXG4gICAgLy8gaWYgKCFjdXJyZW50Um93SWQpIHtcclxuICAgIC8vICAgY3VycmVudFJvd0lkID0gb2JqZWN0LnByaW1hcnlWYWx1ZTtcclxuICAgIC8vIH1cclxuICAgIGlmICghZXh0ZXJuYWxSdWxlcyAmJiBmcmFtZUNvbnRleHQpIHtcclxuICAgICAgZXh0ZXJuYWxSdWxlcyA9IGZyYW1lQ29udGV4dC5mb3JtLmdldFZhbGlkYXRpb25SdWxlcygpO1xyXG4gICAgfVxyXG4gICAgLy8g5o+Q5Y+W5a6e5L2T5LiK5a6a5LmJ55qE6aqM6K+B5o+P6L+wXHJcbiAgICAvLyDmoLzlvI97a2V5OltydWxlMSxydWxlMl19XHJcbiAgICBsZXQgdmFsaWRhdGVNZXRhZGF0YXMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXRWYWxpZGF0aW9uTWV0YWRhdGFXaXRoUGF0aChvYmplY3QpO1xyXG4gICAgY29uc3QgcmVtYWluZWRFeHRlcm5hbFJ1bGVzID0gbmV3IE1hcDxzdHJpbmcsIFZhbGlkYXRlUnVsZVtdPigpO1xyXG5cclxuICAgIC8vIOWQiOW5tumineWklumqjOivgeinhOWImVxyXG4gICAgaWYgKGV4dGVybmFsUnVsZXMpIHtcclxuICAgICAgLy8gY29uc3QgcGFyZW50UGF0aEFycmF5OiBzdHJpbmdbXSA9IG9iamVjdFsnX19QQVJFTlRfUEFUSF9fJ10gPyBbLi4ub2JqZWN0WydfX1BBUkVOVF9QQVRIX18nXV0gOiBbJyddO1xyXG4gICAgICAvLyBpZiAocGFyZW50UGF0aEFycmF5Lmxlbmd0aCA+IDEpIHtcclxuICAgICAgLy8gICBwYXJlbnRQYXRoQXJyYXlbMF0gPSAnJztcclxuICAgICAgLy8gfVxyXG4gICAgICBjb25zdCBwYXJlbnRQYXRoQXJyYXkgPSBbXTtcclxuICAgICAgbGV0IG9iamVjdEN1cnNvciA9IG9iamVjdDtcclxuICAgICAgd2hpbGUgKG9iamVjdEN1cnNvciAmJiBvYmplY3RDdXJzb3IgIT09IG9iamVjdEN1cnNvclsnX19QQVJFTlRfXyddKSB7XHJcbiAgICAgICAgY29uc3QgY3Vyc29yUGFyZW50UGF0aCA9IG9iamVjdEN1cnNvclsnX19QQVJFTlRfUEFUSF9fJ10gPyBvYmplY3RDdXJzb3JbJ19fUEFSRU5UX1BBVEhfXyddWzFdIDogJyc7XHJcbiAgICAgICAgLy8gaWYgKHBhcmVudFBhdGhBcnJheVtwYXJlbnRQYXRoQXJyYXkubGVuZ3RoIC0gMV0gIT09IGN1cnNvclBhcmVudFBhdGgpIHtcclxuICAgICAgICBwYXJlbnRQYXRoQXJyYXkucHVzaChjdXJzb3JQYXJlbnRQYXRoKTtcclxuICAgICAgICAvLyB9XHJcbiAgICAgICAgb2JqZWN0Q3Vyc29yID0gb2JqZWN0Q3Vyc29yWydfX1BBUkVOVF9fJ107XHJcbiAgICAgICAgaWYgKG9iamVjdEN1cnNvciBpbnN0YW5jZW9mIEVudGl0eUxpc3QpIHtcclxuICAgICAgICAgIG9iamVjdEN1cnNvciA9IG9iamVjdEN1cnNvclsnX19QQVJFTlRfXyddO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBjb25zdCBwYXJlbnRQYXRoID0gcGFyZW50UGF0aEFycmF5LnJldmVyc2UoKS5qb2luKCcvJyk7XHJcblxyXG4gICAgICBleHRlcm5hbFJ1bGVzLmZvckVhY2goKHJ1bGVzLCBwYXRoKSA9PiB7XHJcbiAgICAgICAgaWYgKHBhdGgpIHtcclxuICAgICAgICAgIC8vIOaPkOWPlumineWklumqjOivgeinhOWImeWtl+autei3r+W+hFxyXG4gICAgICAgICAgY29uc3QgcGF0aEFycmF5ID0gcGF0aC5zcGxpdCgnLycpO1xyXG4gICAgICAgICAgLy8g5o+Q5Y+W5a2X5q615ZCN56ewXHJcbiAgICAgICAgICBjb25zdCBmaWVsZE5hbWUgPSBwYXRoQXJyYXkucG9wKCk7XHJcbiAgICAgICAgICAvLyDmj5Dlj5blrZfmrrXniLbot6/lvoRcclxuICAgICAgICAgIGNvbnN0IGZpZWxkUGFyZW50UGF0aCA9IHBhdGhBcnJheS5qb2luKCcvJyk7XHJcbiAgICAgICAgICAvLyDljLnphY3lpJbpg6jpqozor4Hop4TliJnlkozlrp7kvZPpqozor4Hop4TliJnniLbot6/lvoRcclxuICAgICAgICAgIGlmIChwYXJlbnRQYXRoID09PSBmaWVsZFBhcmVudFBhdGgpIHtcclxuICAgICAgICAgICAgdmFsaWRhdGVNZXRhZGF0YXNbZmllbGROYW1lXSA9IFsuLi4odmFsaWRhdGVNZXRhZGF0YXNbZmllbGROYW1lXSB8fCBbXSldO1xyXG4gICAgICAgICAgICAvLyDlkIjlubblpJbpg6jmoKHpqozop4TliJnliLDlrp7kvZPmoKHpqozop4TliJnvvIzlubblkIzmraXlpJbpg6jpqozor4Hop4TliJnmmL7npLrkv6Hmga/oh7Plrp7kvZPpqozor4Hop4TliJnvvIzlpoLvvJrkuK3oi7HmloflrZfmrrXmj4/ov7DjgIHlrZfmrrXmiYDlnKjkvY3nva7jgIJcclxuICAgICAgICAgICAgaWYgKHJ1bGVzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgIGxldCB0YXJnZXRJZCA9ICcnO1xyXG4gICAgICAgICAgICAgIHJ1bGVzLmZvckVhY2gocnVsZSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAocnVsZS50YXJnZXRJZCAmJiBydWxlLnRhcmdldElkLmxlbmd0aCA+IHRhcmdldElkLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICB0YXJnZXRJZCA9IHJ1bGUudGFyZ2V0SWQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB2YWxpZGF0ZU1ldGFkYXRhc1tmaWVsZE5hbWVdLnB1c2gocnVsZSk7XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgdmFsaWRhdGVNZXRhZGF0YXNbZmllbGROYW1lXS5mb3JFYWNoKCh2YWxpZGF0ZVJ1bGU6IFZhbGlkYXRlUnVsZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdmFsaWRhdGVSdWxlLnRhcmdldElkID0gdGFyZ2V0SWQ7XHJcbiAgICAgICAgICAgICAgICB2YWxpZGF0ZVJ1bGUudGFyZ2V0TmFtZSA9IHJ1bGVzWzBdLnRhcmdldE5hbWU7XHJcbiAgICAgICAgICAgICAgICB2YWxpZGF0ZVJ1bGUucHJvcGVydHkgPSBydWxlc1swXS5wcm9wZXJ0eTtcclxuICAgICAgICAgICAgICAgIGlmIChydWxlc1swXS5mcmFtZUNvbnRleHQpIHtcclxuICAgICAgICAgICAgICAgICAgdmFsaWRhdGVSdWxlLmZyYW1lQ29udGV4dCA9IHJ1bGVzWzBdLmZyYW1lQ29udGV4dDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHZhbGlkYXRlUnVsZS5mdWxsUGF0aCA9IHJ1bGVzWzBdLmZ1bGxQYXRoO1xyXG4gICAgICAgICAgICAgICAgdmFsaWRhdGVSdWxlWydpbml0aWFsaXplZCddID0gdHJ1ZTtcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmVtYWluZWRFeHRlcm5hbFJ1bGVzLnNldChwYXRoLCBydWxlcyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIC8vIOWkhOeQhuagoemqjOinhOWImeS4reeahOWxnuaAp+WQjeensFxyXG4gICAgLy8g5Zy65pmv5Li65YmN56uv5pyq5byA5ZCv5qCh6aqM5oiWZm9ybeagoemqjOinhOWImeS4reWvueW6lOe7keWumui3r+W+hOS4reWvueW6lOaOp+S7tuacquW8gOWQr+agoemqjO+8jOWvvOiHtOS4iuS4gOatpemqpOS4ree7hOS7tuWQjeOAgeWtl+auteWQjeacquiDveWQjOatpeS4uuWvueW6lOS4reaWh1xyXG4gICAgaWYgKHZhbGlkYXRlTWV0YWRhdGFzICYmIE9iamVjdC5rZXlzKHZhbGlkYXRlTWV0YWRhdGFzKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgIE9iamVjdC5rZXlzKHZhbGlkYXRlTWV0YWRhdGFzKS5mb3JFYWNoKChmaWVsZE5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGNvbnN0IHZhbGlkYXRlUnVsZXMgPSB2YWxpZGF0ZU1ldGFkYXRhc1tmaWVsZE5hbWVdO1xyXG4gICAgICAgIGlmICh2YWxpZGF0ZVJ1bGVzICYmIHZhbGlkYXRlUnVsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgY29uc3QgZmlyc3RWYWxpZGF0ZVJ1bGUgPSB2YWxpZGF0ZVJ1bGVzWzBdO1xyXG4gICAgICAgICAgY29uc3QgcGF0aCA9IGZpcnN0VmFsaWRhdGVSdWxlWydwYXRoJ107XHJcbiAgICAgICAgICBpZiAocGF0aCkge1xyXG4gICAgICAgICAgICB2YWxpZGF0ZVJ1bGVzLmZvckVhY2goKHZhbGlkYXRlUnVsZTogVmFsaWRhdGVSdWxlKSA9PiB7XHJcbiAgICAgICAgICAgICAgLy8g5bCGaW5pdGlhbGl6ZWTliKTmlq3lpJbnp7vlh4/lsJHku6PnoIHmiafooYzmrKHmlbBcclxuICAgICAgICAgICAgICBpZiAodmFsaWRhdGVSdWxlWydpbml0aWFsaXplZCddICE9PSB0cnVlKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBwYXRoLnNwbGl0KCcuJyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmb3JtID0gdGhpcy5nZXRGb3JtKGJpbmRpbmdQYXRocywgZnJhbWVDb250ZXh0KTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZvcm1Db250cm9sID0gdGhpcy5nZXRGb3JtQ29udHJvbChiaW5kaW5nUGF0aHMsIGZyYW1lQ29udGV4dCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoZm9ybUNvbnRyb2wpIHtcclxuICAgICAgICAgICAgICAgICAgdmFsaWRhdGVSdWxlLnRhcmdldElkID0gZm9ybUNvbnRyb2wuaWQ7XHJcbiAgICAgICAgICAgICAgICAgIHZhbGlkYXRlUnVsZS50YXJnZXROYW1lID0gZm9ybSAmJiBmb3JtLmZvcm1Hcm91cE5hbWU7XHJcbiAgICAgICAgICAgICAgICAgIHZhbGlkYXRlUnVsZS5wcm9wZXJ0eSA9IGZvcm1Db250cm9sLm5hbWUgfHwgZm9ybUNvbnRyb2wuZGVmYXVsdEkxOG5WYWx1ZSB8fCAnJztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICAvLyDov4fmu6Tlh7rlvZPliY3pqozor4HlsZ7mgKfnmoTpqozor4Hop4TliJlcclxuICAgIGlmIChwcm9wZXJ0eU5hbWUpIHtcclxuICAgICAgdmFsaWRhdGVNZXRhZGF0YXMgPSBPYmplY3Qua2V5cyh2YWxpZGF0ZU1ldGFkYXRhcylcclxuICAgICAgICAuZmlsdGVyKGtleSA9PiBrZXkgPT09IHByb3BlcnR5TmFtZSlcclxuICAgICAgICAucmVkdWNlKCh2YWwsIGN1cnIpID0+IE9iamVjdC5hc3NpZ24oe30sIHZhbCwgeyBbY3Vycl06IHZhbGlkYXRlTWV0YWRhdGFzW2N1cnJdIH0pLCB7fSk7XHJcbiAgICB9XHJcbiAgICAvLyB2YWxpZGF0ZU1ldGFkYXRhcyA9IHtydWxlOuW9k+WJjeWxnuaAp+eahOaJgOacieagoemqjOinhOWImX1cclxuICAgIE9iamVjdC5rZXlzKHZhbGlkYXRlTWV0YWRhdGFzKS5maWx0ZXIoKGtleTogc3RyaW5nKSA9PlxyXG4gICAgICBvYmplY3QgJiYgKFxyXG4gICAgICAgIG9iamVjdC5oYXNPd25Qcm9wZXJ0eShrZXkpIHx8XHJcbiAgICAgICAgKFxyXG4gICAgICAgICAgb2JqZWN0LmNvbnN0cnVjdG9yLnByb3RvdHlwZSAmJlxyXG4gICAgICAgICAgb2JqZWN0LmNvbnN0cnVjdG9yLnByb3RvdHlwZS50eXBlTmFtZSAmJlxyXG4gICAgICAgICAgb2JqZWN0LmNvbnN0cnVjdG9yLnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eShrZXkpXHJcbiAgICAgICAgKSB8fFxyXG4gICAgICAgIG9iamVjdFsnX19wcm90b19fJ10uaGFzT3duUHJvcGVydHkoa2V5KVxyXG4gICAgICApXHJcbiAgICApLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgLy8gdG9kbzog5rKh55So5YW85a65dmFsdWXmmK91bmRlZmluZWTnmoTmg4XlhrVcclxuICAgICAgbGV0IHZhbHVlID0gbmV3VmFsdWU7XHJcbiAgICAgIGlmIChuZXdWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgdmFsdWUgPSAob2JqZWN0IGFzIGFueSlba2V5XTtcclxuICAgICAgfVxyXG4gICAgICBsZXQgaXNNdWx0TGFuZ3VhZ2VGaWVsZCA9IGZhbHNlO1xyXG4gICAgICBjb25zdCBtdWx0aUxhbmdGaWVsZHMgPSB0aGlzLmdldE11bHRpTGFuZ3VhZ2VGaWVsZHMob2JqZWN0KTtcclxuICAgICAgaWYgKG11bHRpTGFuZ0ZpZWxkcyAmJiBtdWx0aUxhbmdGaWVsZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGlmIChtdWx0aUxhbmdGaWVsZHMuaW5jbHVkZXMoa2V5KSkge1xyXG4gICAgICAgICAgaXNNdWx0TGFuZ3VhZ2VGaWVsZCA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIC8vIGNvbnN0IHZhbHVlID0gbmV3VmFsdWUgfHxcclxuICAgICAgY29uc3QgdmFsaWRhdGVSdWxlczogVmFsaWRhdGVSdWxlW10gPSB2YWxpZGF0ZU1ldGFkYXRhc1trZXldO1xyXG4gICAgICBpZiAodmFsaWRhdGVSdWxlcy5sZW5ndGgpIHtcclxuICAgICAgICBjb25zdCB7IHByb3BlcnR5OiBmaWVsZE5hbWUsIHRhcmdldElkOiBmaWVsZCwgZnJhbWVDb250ZXh0LCBmdWxsUGF0aCB9ID0gdmFsaWRhdGVSdWxlc1swXTtcclxuICAgICAgICAvLyBjb25zdCBmaWVsZENvbnRhaW5lck5hbWUgPSBOdW1iZXIuaXNJbnRlZ2VyKGluZGV4KSA/XHJcbiAgICAgICAgLy8gYCR7dmFsaWRhdGVSdWxlc1swXS50YXJnZXROYW1lfSDnrKwke2luZGV4ICsgMX3ooYxgIDogdmFsaWRhdGVSdWxlc1swXS50YXJnZXROYW1lO1xyXG4gICAgICAgIGNvbnN0IGZpZWxkQ29udGFpbmVyTmFtZSA9IE51bWJlci5pc0ludGVnZXIoaW5kZXgpID9cclxuICAgICAgICAgIFZhbGlkYXRpb25FeGVjdXRvci5yZXBsYWNlTWVzc2FnZVNwZWNpYWxUb2tlbnMoXHJcbiAgICAgICAgICAgIFZhbGlkYXRpb25UeXBlcy5nZXRNZXNzYWdlKFZhbGlkYXRpb25UeXBlcy5GSUVMRF9DT05UQUlORVIpLFxyXG4gICAgICAgICAgICB2YWxpZGF0ZVJ1bGVzWzBdLCBpbmRleCArIDFcclxuICAgICAgICAgICkgOiB2YWxpZGF0ZVJ1bGVzWzBdLnRhcmdldE5hbWU7XHJcbiAgICAgICAgY29uc3QgdmFsaWRhdGlvbkRpc3BsYXlOYW1lID0gZmllbGRDb250YWluZXJOYW1lID8gYCR7ZmllbGRDb250YWluZXJOYW1lfSAtICR7ZmllbGROYW1lfWAgOiBgJHtmaWVsZE5hbWV9YDtcclxuICAgICAgICAvLyBjb25zdCBwcm9wZXJ0eSA9IHZhbGlkYXRlUnVsZXNbJ3BhdGgnXSB8fCBrZXk7XHJcbiAgICAgICAgY29uc3QgdmFsaWRhdGlvbkVycm9yID0gdGhpcy5nZW5lcmF0ZVZhbGlkYXRpb25FcnJvcihvYmplY3QsIHZhbHVlLCBrZXksIHZhbGlkYXRpb25EaXNwbGF5TmFtZSwgaW5kZXgsIGZpZWxkLCBmcmFtZUNvbnRleHQsIGZ1bGxQYXRoKTtcclxuICAgICAgICBpZiAoaW5kZXggIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgdmFsaWRhdGlvbkVycm9yWydpbmRleCddID0gaW5kZXg7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhbGlkYXRpb25FcnJvcnMucHVzaCh2YWxpZGF0aW9uRXJyb3IpO1xyXG4gICAgICAgIHRoaXMuZGVmYXVsdFZhbGlkYXRpb25zKG9iamVjdCwgdmFsdWUsIHZhbGlkYXRlUnVsZXMsIHZhbGlkYXRpb25FcnJvciwgaXNNdWx0TGFuZ3VhZ2VGaWVsZCwgY3VycmVudFJvd0lkKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy5vYmplY3RWYWxpZGF0aW9ucyhvYmplY3QsIHZhbGlkYXRpb25FcnJvcnMsIHByb3BlcnR5TmFtZSwgaW5kZXgsIHJlbWFpbmVkRXh0ZXJuYWxSdWxlcywgY3VycmVudFJvd0lkLCBmcmFtZUNvbnRleHQpO1xyXG5cclxuICAgIHRoaXMubGlzdFZhbGlkYXRpb25zKG9iamVjdCwgdmFsaWRhdGlvbkVycm9ycywgcHJvcGVydHlOYW1lLCBpbmRleCwgcmVtYWluZWRFeHRlcm5hbFJ1bGVzLCBmcmFtZUNvbnRleHQpO1xyXG4gICAgLy8gdGhpcy5zb3J0VmFsaWRhdGlvbkVycm9ycyh2YWxpZGF0aW9uRXJyb3JzKTtcclxuXHJcbiAgICAvLyB0b2RvIOWtmOWcqOafkOS6m25nT2JqZWN057G75Z6L55qE5pWw5o2u77yM55WM6Z2i5LiK5rKh5pyJ77yM5a6e5L2T5Lit5pyJ77yM5a6e5L2T6K6+572u5LqG5b+F5aGr77yM5a+86Ie06aqM6K+B5LiN6YCa6L+H5peg5rOV5L+d5a2Y55qE6Zeu6aKYXHJcbiAgICAvLyBpZiAoIXByb3BlcnR5TmFtZSkge1xyXG4gICAgLy8gICAgIHRoaXMub2JqZWN0VmFsaWRhdGlvbnMob2JqZWN0LCB2YWxpZGF0aW9uRXJyb3JzKTtcclxuICAgIC8vIH1cclxuICB9XHJcblxyXG5cclxuXHJcbiAgcHJpdmF0ZSBnZXRNdWx0aUxhbmd1YWdlRmllbGRzKGVudGl0eTogYW55KSB7XHJcbiAgICBpZiAoZW50aXR5ICYmIGVudGl0eS5jb25zdHJ1Y3Rvcikge1xyXG4gICAgICBjb25zdCBuZ0ZpZWxkcyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nRmllbGRzKGVudGl0eS5jb25zdHJ1Y3Rvcik7XHJcbiAgICAgIHJldHVybiBPYmplY3Qua2V5cyhuZ0ZpZWxkcykuZmlsdGVyKChmaWVsZE5hbWU6IHN0cmluZykgPT4gbmdGaWVsZHNbZmllbGROYW1lXS5lbmFibGVNdWx0aUxhbmdJbnB1dCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5riF6Zmk6YCa6L+H6aqM6K+B5L+h5oGvXHJcbiAgICogQHBhcmFtIGVycm9ycyDpqozor4HlpLHotKXkv6Hmga9cclxuICAgKi9cclxuICBzdHJpcEVtcHR5RXJyb3JzKGVycm9yczogVmFsaWRhdGlvbkVycm9yW10pIHtcclxuICAgIHJldHVybiBlcnJvcnMuZmlsdGVyKGVycm9yID0+IHtcclxuICAgICAgaWYgKGVycm9yLmNoaWxkcmVuKSB7XHJcbiAgICAgICAgZXJyb3IuY2hpbGRyZW4gPSB0aGlzLnN0cmlwRW1wdHlFcnJvcnMoZXJyb3IuY2hpbGRyZW4pO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoT2JqZWN0LmtleXMoZXJyb3IuY29uc3RyYWludHMpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIGlmIChlcnJvci5jaGlsZHJlbi5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgZGVsZXRlIGVycm9yLmNvbnN0cmFpbnRzO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOeUn+aIkOacqumAmui/h+mqjOivgeeahOWvueixoVxyXG4gICAqIEBwYXJhbSBvYmplY3Qg6KaB6aqM6K+B55qE5a6e5L2T5a6e5L6L5a+56LGhXHJcbiAgICogQHBhcmFtIHZhbHVlIOimgemqjOivgeeahOWAvFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eU5hbWUg5b6F6aqM6K+B55qE5a6e5L2T5bGe5oCn5ZCN56ewXHJcbiAgICogQHBhcmFtIGluZGV4IOmqjOivgeaVsOaNrue0ouW8lVxyXG4gICAqIEBwYXJhbSBmaWVsZCDlvoXpqozor4HlrZfmrrVcclxuICAgKi9cclxuICBwcml2YXRlIGdlbmVyYXRlVmFsaWRhdGlvbkVycm9yKG9iamVjdDogYW55LCB2YWx1ZTogYW55LCBwcm9wZXJ0eTogc3RyaW5nLCBwcm9wZXJ0eU5hbWU/OiBzdHJpbmcsIGluZGV4PzogbnVtYmVyLCBmaWVsZD86IHN0cmluZywgZnJhbWVDb250ZXh0PzogRnJhbWVDb250ZXh0LCBmdWxsUGF0aD86IHN0cmluZykge1xyXG4gICAgY29uc3QgdmFsaWRhdGlvbkVycm9yID0gbmV3IFZhbGlkYXRpb25FcnJvcigpO1xyXG5cclxuICAgIHZhbGlkYXRpb25FcnJvci50YXJnZXQgPSBvYmplY3Q7XHJcbiAgICB2YWxpZGF0aW9uRXJyb3IudmFsdWUgPSB2YWx1ZTtcclxuXHJcbiAgICB2YWxpZGF0aW9uRXJyb3IucHJvcGVydHkgPSBwcm9wZXJ0eTtcclxuICAgIHZhbGlkYXRpb25FcnJvci5wcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eU5hbWU7XHJcbiAgICB2YWxpZGF0aW9uRXJyb3IuZmllbGQgPSBmaWVsZDtcclxuICAgIHZhbGlkYXRpb25FcnJvci5pbmRleCA9IGluZGV4O1xyXG4gICAgdmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuID0gW107XHJcbiAgICB2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHMgPSB7fTtcclxuICAgIGlmIChmcmFtZUNvbnRleHQpIHtcclxuICAgICAgdmFsaWRhdGlvbkVycm9yLmZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dDtcclxuICAgIH1cclxuICAgIHZhbGlkYXRpb25FcnJvci5mdWxsUGF0aCA9IGZ1bGxQYXRoO1xyXG4gICAgcmV0dXJuIHZhbGlkYXRpb25FcnJvcjtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOmqjOivgeWunuS9k+S4reeahOWxnuaAp1xyXG4gICAqIEBwYXJhbSBvYmplY3Qg6KaB6aqM6K+B55qE5a6e5L2T5a6e5L6L5a+56LGhXHJcbiAgICogQHBhcmFtIHZhbHVlIOimgemqjOivgeeahOWAvFxyXG4gICAqIEBwYXJhbSB2YWxpZGF0ZVJ1bGVzIOmqjOivgeinhOWImVxyXG4gICAqIEBwYXJhbSBlcnJvck1hcCDpmr7or4Hkv6Hmga/jgIJ7W2tleV06IG1lc3NhZ2V9XHJcbiAgICpcclxuICAgKiBrZXk6IOmqjOivgeinhOWImeWQjeensFxyXG4gICAqIG1lc3NhZ2U6IOmqjOivgeS/oeaBr1xyXG4gICAqL1xyXG4gIHByaXZhdGUgZGVmYXVsdFZhbGlkYXRpb25zKG9iamVjdDogVCwgdmFsdWU6IGFueSwgdmFsaWRhdGVSdWxlczogVmFsaWRhdGVSdWxlW10sIHZhbGlkYXRpb25FcnJvcjogVmFsaWRhdGlvbkVycm9yLCBpc011bHRMYW5ndWFnZUZpZWxkPzogYm9vbGVhbiwgY3VycmVudFJvd0lkPzogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBlcnJvck1hcCA9IHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50cztcclxuICAgIHJldHVybiB2YWxpZGF0ZVJ1bGVzXHJcbiAgICAgIC5maWx0ZXIoKHZhbGlkYXRlUnVsZSkgPT4ge1xyXG4gICAgICAgIC8vIOmqjOivgeWunuS9k+WxnuaAp+aYr+WQpuespuWQiOinhOWImVxyXG4gICAgICAgIGNvbnN0IHZhbGlkVmFsdWUgPSB0aGlzLnZhbGlkYXRvci52YWxpZGF0ZVZhbHVlQnlNZXRhZGF0YShvYmplY3QsIHZhbHVlLCB2YWxpZGF0ZVJ1bGUsIGlzTXVsdExhbmd1YWdlRmllbGQsIGN1cnJlbnRSb3dJZCk7XHJcbiAgICAgICAgaWYgKHZhbGlkVmFsdWUgaW5zdGFuY2VvZiBQcm9taXNlKSB7XHJcbiAgICAgICAgICBjb25zdCBwcm9taXNlID0gdmFsaWRWYWx1ZS50aGVuKChpc1ZhbGlkKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICghaXNWYWxpZCkge1xyXG4gICAgICAgICAgICAgIGNvbnN0IHsgdHlwZSwgbWVzc2FnZVN0cmluZzogbWVzc2FnZSB9ID0gdGhpcy5jcmVhdGVWYWxpZGF0aW9uRXJyb3Iob2JqZWN0LCB2YWx1ZSwgdmFsaWRhdGVSdWxlKTtcclxuICAgICAgICAgICAgICBlcnJvck1hcFt0eXBlXSA9IG1lc3NhZ2U7XHJcbiAgICAgICAgICAgICAgdmFsaWRhdGlvbkVycm9yLnJ1bGUgPSB2YWxpZGF0ZVJ1bGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgdGhpcy5hd2FpdGluZ1Byb21pc2VzLnB1c2gocHJvbWlzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAhdmFsaWRWYWx1ZTtcclxuICAgICAgfSlcclxuICAgICAgLmZvckVhY2goKHZhbGlkYXRlUnVsZSkgPT4ge1xyXG4gICAgICAgIC8vIOS4jeespuWQiOinhOWIme+8jOeUn+aIkOmUmeivr+S/oeaBr1xyXG4gICAgICAgIGNvbnN0IHsgdHlwZToga2V5LCBtZXNzYWdlU3RyaW5nOiBtZXNzYWdlIH0gPSB0aGlzLmNyZWF0ZVZhbGlkYXRpb25FcnJvcihvYmplY3QsIHZhbHVlLCB2YWxpZGF0ZVJ1bGUpO1xyXG4gICAgICAgIGVycm9yTWFwW2tleV0gPSBtZXNzYWdlO1xyXG4gICAgICAgIHZhbGlkYXRpb25FcnJvci5ydWxlID0gdmFsaWRhdGVSdWxlO1xyXG4gICAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOmqjOivgeWIl+ihqOS4reeahOavj+adoeiusOW9lVxyXG4gICAqIEBwYXJhbSBvYmplY3Qg6KaB6aqM6K+B55qE5a6e5L2T5a6e5L6L5a+56LGhXHJcbiAgICogQHBhcmFtIGVycm9ycyDpqozor4HlpLHotKXnmoTkv6Hmga/pm4blkIhcclxuICAgKiBAcGFyYW0gcHJvcGVydHkg5bGe5oCn5ZCN56ewXHJcbiAgICogQHBhcmFtIHBhcmVudEluZGV4IOW9k+WJjembhuWQiOeahOeItuWvueixoeaJgOWxnumbhuWQiOWIl+ihqOS4reeahOe0ouW8leOAglxyXG4gICAqL1xyXG4gIHByaXZhdGUgbGlzdFZhbGlkYXRpb25zKFxyXG4gICAgb2JqZWN0OiBhbnksXHJcbiAgICBlcnJvcnM6IFZhbGlkYXRpb25FcnJvcltdLFxyXG4gICAgcHJvcGVydHk/OiBzdHJpbmcsXHJcbiAgICBwYXJlbnRJbmRleD86IGFueSxcclxuICAgIGV4dGVybmFsUnVsZXM/OiBNYXA8c3RyaW5nLCBWYWxpZGF0ZVJ1bGVbXT4sXHJcbiAgICBmcmFtZUNvbnRleHQ/OiBGcmFtZUNvbnRleHRcclxuICApIHtcclxuICAgIGNvbnN0IElOREVYX0xBQkVMID0gXCJfX0FDVFVBTF9JTkRFWF9fXCI7XHJcbiAgICBjb25zdCBsaXN0RmllbGRzID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdMaXN0KG9iamVjdC5jb25zdHJ1Y3Rvcik7XHJcbiAgICBpZiAoIWxpc3RGaWVsZHMpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgbGV0IGtleXMgPSBPYmplY3Qua2V5cyhsaXN0RmllbGRzKTtcclxuICAgIGlmIChwcm9wZXJ0eSkge1xyXG4gICAgICBrZXlzID0ga2V5cy5maWx0ZXIoa2V5ID0+IGtleSA9PT0gcHJvcGVydHkpO1xyXG4gICAgfVxyXG4gICAga2V5cy5mb3JFYWNoKHByb3BlcnR5TmFtZSA9PiB7XHJcbiAgICAgIGNvbnN0IG1ldGFkYXRhID0gbGlzdEZpZWxkc1twcm9wZXJ0eU5hbWVdO1xyXG4gICAgICBjb25zdCBjbHpUeXBlID0gbWV0YWRhdGEudHlwZTtcclxuICAgICAgY29uc3QgdmFsdWUgPSBvYmplY3RbcHJvcGVydHlOYW1lXSBhcyBFbnRpdHlMaXN0PFQ+O1xyXG4gICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICBjb25zdCBwYXJlbnRQYXRocyA9IG9iamVjdC5nZXRQYXRocygpLnBhdGggfHwgW107XHJcbiAgICAgICAgcGFyZW50UGF0aHMucHVzaChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgIGNvbnN0IHZhbGlkYXRpb25FcnJvciA9IHRoaXMuZ2VuZXJhdGVWYWxpZGF0aW9uRXJyb3Iob2JqZWN0LCB2YWx1ZS5pdGVtcywgcGFyZW50UGF0aHMuam9pbignLicpLCBwcm9wZXJ0eU5hbWUsIHBhcmVudEluZGV4KTtcclxuICAgICAgICB2YWxpZGF0aW9uRXJyb3IuaXNBcnJheSA9IHRydWU7XHJcbiAgICAgICAgZXJyb3JzLnB1c2godmFsaWRhdGlvbkVycm9yKTtcclxuICAgICAgICB2YWx1ZS5pdGVtcy5mb3JFYWNoKChlbnRpdHksIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICBsZXQgYWN0dWFsSW5kZXggPSBlbnRpdHlbSU5ERVhfTEFCRUxdID8gZW50aXR5W0lOREVYX0xBQkVMXSA6IGluZGV4O1xyXG4gICAgICAgICAgdGhpcy5leGVjdXRlKGVudGl0eSwgdW5kZWZpbmVkLCB2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4sIHVuZGVmaW5lZCwgYWN0dWFsSW5kZXgsIGV4dGVybmFsUnVsZXMsIGVudGl0eS5wcmltYXJ5VmFsdWUsIGZyYW1lQ29udGV4dCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6aqM6K+B5a6e5L2T5Lit55qE5byV55So5a+56LGhXHJcbiAgICogQHBhcmFtIG9iamVjdCDopoHpqozor4HnmoTlrp7kvZPlr7nosaFcclxuICAgKiBAcGFyYW0gZXJyb3JzIOmUmeivr+S/oeaBr+mbhuWQiFxyXG4gICAqL1xyXG4gIHByaXZhdGUgb2JqZWN0VmFsaWRhdGlvbnMob2JqZWN0OiBULCBlcnJvcnM6IFZhbGlkYXRpb25FcnJvcltdLCBwcm9wZXJ0eT86IHN0cmluZywgcGFyZW50SW5kZXg/OiBhbnksIGV4dGVybmFsUnVsZXM/OiBNYXA8c3RyaW5nLCBWYWxpZGF0ZVJ1bGVbXT4sIGN1cnJlbnRSb3dJZD86IHN0cmluZywgZnJhbWVDb250ZXh0PzogRnJhbWVDb250ZXh0KSB7XHJcbiAgICBjb25zdCBvYmplY3RGaWVsZHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ09iamVjdHMob2JqZWN0LmNvbnN0cnVjdG9yKTtcclxuICAgIGlmICghb2JqZWN0RmllbGRzIHx8IE9iamVjdC5rZXlzKG9iamVjdEZpZWxkcykubGVuZ3RoIDwgMSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGtleXMgPSBPYmplY3Qua2V5cyhvYmplY3RGaWVsZHMpO1xyXG4gICAgaWYgKHByb3BlcnR5KSB7XHJcbiAgICAgIGtleXMgPSBrZXlzLmZpbHRlcihrZXkgPT4ga2V5ID09PSBwcm9wZXJ0eSk7XHJcbiAgICB9XHJcbiAgICBrZXlzLmZvckVhY2gocHJvcGVydHlOYW1lID0+IHtcclxuICAgICAgY29uc3QgbWV0YWRhdGEgPSBvYmplY3RGaWVsZHNbcHJvcGVydHlOYW1lXTtcclxuICAgICAgY29uc3Qgb2JqZWN0VHlwZSA9IG1ldGFkYXRhLnR5cGU7XHJcbiAgICAgIGNvbnN0IHZhbHVlID0gb2JqZWN0W3Byb3BlcnR5TmFtZV07XHJcbiAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgIHRoaXMuZXhlY3V0ZSh2YWx1ZSwgdW5kZWZpbmVkLCBlcnJvcnMsIHVuZGVmaW5lZCwgcGFyZW50SW5kZXgsIGV4dGVybmFsUnVsZXMsIGN1cnJlbnRSb3dJZCwgZnJhbWVDb250ZXh0KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliJvlu7rpqozor4Hop4TliJnkv6Hmga9cclxuICAgKiBAcGFyYW0gb2JqZWN0IOimgemqjOivgeeahOWunuS9k+WvueixoVxyXG4gICAqIEBwYXJhbSB2YWx1ZSDpqozor4HnmoTlgLxcclxuICAgKiBAcGFyYW0gbWV0YWRhdGEg6aqM6K+B6KeE5YiZXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjcmVhdGVWYWxpZGF0aW9uRXJyb3Iob2JqZWN0OiBULCB2YWx1ZTogYW55LCBtZXRhZGF0YTogVmFsaWRhdGVSdWxlKSB7XHJcbiAgICAvLyBjb25zdCB0YXJnZXROYW1lID0gb2JqZWN0LmNvbnN0cnVjdG9yID8gKG9iamVjdC5jb25zdHJ1Y3RvciBhcyBhbnkpLm5hbWUgOiB1bmRlZmluZWQ7XHJcbiAgICBjb25zdCB0eXBlID0gbWV0YWRhdGEudHlwZTtcclxuICAgIC8vIOiOt+WPluagoemqjOaPkOekuuS/oeaBr++8muWFiOS9v+eUqOWGhee9ruinhOWImeiOt+WPlu+8jOiOt+WPluS4jeWIsOaXtuS9v+eUqOWFg+aVsOaNruS4iueahOaPkOekuu+8jOS7peWFvOWuueihqOi+vuW8j+WcuuaZr1xyXG4gICAgbGV0IG1lc3NhZ2UgPSBWYWxpZGF0aW9uVHlwZXMuZ2V0TWVzc2FnZSh0eXBlKTtcclxuXHJcbiAgICBpZiAoIW1lc3NhZ2UpIHtcclxuICAgICAgbWVzc2FnZSA9IG1ldGFkYXRhLm1lc3NhZ2U7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKFZhbGlkYXRpb25UeXBlcy5pc1ZhbGlkVHlwZSh0eXBlKSAmJiAodHlwZSA9PT0gVmFsaWRhdGlvblR5cGVzLk1BWFZBTFVFIHx8IHR5cGUgPT09IFZhbGlkYXRpb25UeXBlcy5NSU5WQUxVRSkpIHtcclxuICAgICAgaWYgKHRoaXMuaXNEYXRlU3RyaW5nKHZhbHVlKSAmJiBtZXRhZGF0YS5jb25zdHJhaW50cyAmJiBtZXRhZGF0YS5jb25zdHJhaW50cy5sZW5ndGgpIHtcclxuICAgICAgICAvLyDojrflj5bml6XmnJ/nsbvlnovnmoTmj5DnpLrkv6Hmga9cclxuICAgICAgICBjb25zdCBleHRUeXBlID0gdHlwZSA9PT0gVmFsaWRhdGlvblR5cGVzLk1JTlZBTFVFID8gVmFsaWRhdGlvblR5cGVzLk1JTl9EQVRFIDogVmFsaWRhdGlvblR5cGVzLk1BWF9EQVRFO1xyXG4gICAgICAgIG1lc3NhZ2UgPSBWYWxpZGF0aW9uVHlwZXMuZ2V0TWVzc2FnZShleHRUeXBlKTtcclxuICAgICAgICAvKmlmIChtZXRhZGF0YS5jb25zdHJhaW50c1swXSkge1xyXG4gICAgICAgICAgbWV0YWRhdGEuY29uc3RyYWludHNbMF0gPSBEYXRlVXRpbC5mb3JtYXQobWV0YWRhdGEuY29uc3RyYWludHNbMF0sICd5eXl5LU1NLWRkIEhIOm1tOnNzJyk7XHJcbiAgICAgICAgfSovXHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBtZXNzYWdlU3RyaW5nID0gVmFsaWRhdGlvbkV4ZWN1dG9yLnJlcGxhY2VNZXNzYWdlU3BlY2lhbFRva2VucyhtZXNzYWdlLCBtZXRhZGF0YSwgdmFsdWUpO1xyXG4gICAgcmV0dXJuIHsgdHlwZSwgbWVzc2FnZVN0cmluZywgbWV0YWRhdGEgfTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRGcmFtZUNvbnRleHQoYmluZGluZ1BhdGhzOiBzdHJpbmdbXSwgZXZlbnRGcmFtZUNvbnRleHQ/OiBGcmFtZUNvbnRleHQpIHtcclxuICAgIGlmICghYmluZGluZ1BhdGhzIHx8IGJpbmRpbmdQYXRocy5sZW5ndGggPCAxIHx8ICFldmVudEZyYW1lQ29udGV4dCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IHBhdGhzID0gYmluZGluZ1BhdGhzLmNvbmNhdChbXSk7XHJcbiAgICBwYXRocy5wb3AoKTtcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gcGF0aHMuam9pbignLycpO1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gZXZlbnRGcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHMoKS5maW5kKChjb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IGNvbnRleHQgJiYgY29udGV4dC52aWV3TW9kZWwgJiYgY29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggJiYgY29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS5qb2luKCcvJykgPT09IGJpbmRpbmdQYXRoKTtcclxuICAgIHJldHVybiBmcmFtZUNvbnRleHQgfHwgbnVsbDtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRGb3JtKGJpbmRpbmdQYXRoczogc3RyaW5nW10sIGV2ZW50RnJhbWVDb250ZXh0PzogRnJhbWVDb250ZXh0KSB7XHJcbiAgICBpZiAoIWJpbmRpbmdQYXRocyB8fCBiaW5kaW5nUGF0aHMubGVuZ3RoIDwgMSB8fCAhZXZlbnRGcmFtZUNvbnRleHQpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSB0aGlzLmdldEZyYW1lQ29udGV4dChiaW5kaW5nUGF0aHMsIGV2ZW50RnJhbWVDb250ZXh0KTtcclxuICAgIHJldHVybiBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LmZvcm0gfHwgbnVsbDtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRGb3JtQ29udHJvbChiaW5kaW5nUGF0aHM6IHN0cmluZ1tdLCBldmVudEZyYW1lQ29udGV4dD86IEZyYW1lQ29udGV4dCkge1xyXG4gICAgaWYgKCFiaW5kaW5nUGF0aHMgfHwgYmluZGluZ1BhdGhzLmxlbmd0aCA8IDEgfHwgIWV2ZW50RnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcGF0aHMgPSBiaW5kaW5nUGF0aHMuY29uY2F0KFtdKTtcclxuICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHBhdGhzLnBvcCgpO1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gdGhpcy5nZXRGcmFtZUNvbnRleHQoYmluZGluZ1BhdGhzLCBldmVudEZyYW1lQ29udGV4dCk7XHJcbiAgICBjb25zdCBmb3JtQ29udHJvbCA9IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQuZm9ybSAmJiBmcmFtZUNvbnRleHQuZm9ybS5uZ0Zvcm1Db250cm9scyAmJiBmcmFtZUNvbnRleHQuZm9ybS5uZ0Zvcm1Db250cm9sc1twcm9wZXJ0eU5hbWVdIHx8IG51bGw7XHJcbiAgICByZXR1cm4gZm9ybUNvbnRyb2w7XHJcbiAgfVxyXG4gIGlzRGF0ZVN0cmluZyh2YWx1ZTogYW55KTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCByZWdleCA9IC9cXGR7NH0tKDBbMS05XXwxWzAtMl0pLSgwWzEtOV18WzEtMl1bMC05XXwzWzAtMV0pKFR8XFxzPyk/KChbMC0yXVxcZDpbMC01XVxcZCk/KDpbMC01XVxcZCg/OlxcLlxcZCspKSk/KD86WnxcXCtbMC0yXVxcZCg/OlxcOlswLTVdXFxkKT8pPy9nO1xyXG4gICAgcmV0dXJuIHJlZ2V4LnRlc3QodmFsdWUpO1xyXG4gIH1cclxufVxyXG4iXX0=