/*
 * @Author: Lucus, Witt
 * @Date: 2018-10-30 15:53:59
 * @Last Modified by: Witt
 * @Last Modified time: 2018-11-08 17:25:08
 */
import { ModifyType } from './types';
import { isEqual } from 'lodash-es';
// function isEqual(value: any, other: any) {
//   return JSON.stringify(value) === JSON.stringify(other);
// }
/**
 * 实体数据变更集
 */
class ChangeSet {
    constructor() {
        /**
         * 变更集合
         */
        this.modifications = [];
    }
    /**
     *  获取所有的变更记录
     */
    get changes() {
        return this.modifications;
    }
    /**
     * 将变更集添加到集合中
     * ### 使用示例
     * ```
     * const changeSet = new ChangeSet();
     * const modify = new Modification('newValue', ModifyType.ValueChange, [1, 'title'], 'oldValue');
     * changeSet.append(modify)
     * ```
     * @param changeItem 变更数据
     */
    append(modification) {
        switch (modification.type) {
            case ModifyType.ValueChange:
                this.appendValueChangeModification(modification);
                break;
            case ModifyType.Add:
            case ModifyType.Insert:
            case ModifyType.Clone:
                this.appendAddModification(modification);
                break;
            case ModifyType.Remove:
                this.appendRemoveModification(modification);
                break;
            case ModifyType.Load:
                break;
            default:
                break;
        }
    }
    /**
     * 添加值变化变更
     */
    appendValueChangeModification(modification) {
        const value = modification.value;
        const path = modification.path.join('/');
        const existedModification = this.findModifyItemsPath(modification.path);
        if (existedModification) {
            // 如果存在相同路径的ValueChange类型的变更集，则更新值；
            existedModification.value = value;
        }
        else {
            const existedAddModification = this.findNewAddItemsPath(modification.path);
            if (existedAddModification) {
                // @todo：
                // 1、此处逻辑有问题，value是个字符串，不能直接assign；
                // 2、之所以没有出现问题，是因为都是服务器端新增，新增后，客户端清空了所有变更。
                // 如果存在涵盖该ValueChange变更的Add变更，则更新Add变更对应的数据；
                existedAddModification.value = Object.assign({}, existedAddModification.value, value);
            }
            else {
                // 其他情况，新增一条ValueChange变更。
                this.modifications.push(modification);
            }
        }
    }
    /**
     * 添加新增变更
     */
    appendAddModification(modification) {
        const value = modification.value;
        const path = modification.path.join('/');
        const existedModification = this.findNewAddItemsPath(modification.path);
        if (existedModification) {
            // 1、如果已经存在相同路径的Add变更，则合并Value。
            existedModification.value = existedModification.value.concat(value);
        }
        else {
            // 2、如果没有，则新增一条Add变更。
            this.modifications.push(modification);
        }
    }
    /**
     * 添加删除变更
     */
    appendRemoveModification(modification) {
        const path = modification.path;
        const primaryKey = Object.keys(modification.value)[0];
        const primaryKeyValue = modification.value[primaryKey];
        // 1、存在相同path的新增变更，移除新增变更，不需要添加删除变更；
        // @todo：待重构（1、只考虑了主从情况，2、临时用多重循环实现）
        this.modifications.forEach((addModification) => {
            // 只处理新增变更
            if (addModification.type !== ModifyType.Add && addModification.type !== ModifyType.Insert && addModification.type !== ModifyType.Clone) {
                return;
            }
            // @todo 只考虑主从结构，再深的层次暂不考虑
            if (isEqual(addModification.path, path) === false) {
                return;
            }
            // 遍历新增新增变更的value（value是个数组），移除相匹配的新增删除
            addModification.value = addModification.value.filter((addDataItem) => {
                return addDataItem[primaryKey] !== primaryKeyValue;
            });
        });
        // 2、移除对应的修改变更
        const fullRemovePath = path.concat(`${primaryKey}:${primaryKeyValue}`);
        this.modifications = this.modifications.filter((valueModification) => {
            if (valueModification.type !== ModifyType.ValueChange) {
                return true;
            }
            const valueChangePath = Array.from(valueModification.path);
            valueChangePath.pop();
            // 路径相同进行移除
            const isToRemove = isEqual(valueChangePath, fullRemovePath);
            return !isToRemove;
        });
        // 先删除下级删除变更，再插入
        // 主要针对从从表删除之后，又删除子表时，根实体上还存在从从表删除变更的场景
        this.removeDescendantRemoveModifications(modification);
        this.modifications.push(modification);
    }
    /**
     * 清空变更集合
     */
    clear() {
        this.modifications = [];
    }
    /**
     * 根据path获取Add类型的变更记录
     * @param path 变更路径
     */
    findNewAddItemsPath(path) {
        return this.modifications.find((value, index) => {
            return isEqual(path, value.path) && (value.type === ModifyType.Add || value.type === ModifyType.Insert || value.type === ModifyType.Clone);
        });
    }
    /**
     * 根据path获取ValueChange类型的变更记录
     * @param path 变更路径
     */
    findModifyItemsPath(path) {
        return this.modifications.find((value, index) => {
            return isEqual(path, value.path) && value.type === ModifyType.ValueChange;
        });
    }
    /**
     * 删除后代（包括自己）所有的删除变更
     * @todo：临时做一个最小化修改
     */
    removeDescendantRemoveModifications(parentRemoveModification) {
        const parentPathWithId = this.createRemovePathWithId(parentRemoveModification);
        // 删除后代修改变更
        this.modifications = this.modifications.filter((modification) => {
            if (modification.type !== ModifyType.Remove) {
                return true;
            }
            const descendantPathWithId = this.createRemovePathWithId(modification);
            const isDescendant = this.isDescendantPath(parentPathWithId, descendantPathWithId);
            return !isDescendant;
        });
    }
    /**
     * 获取删除路径的完整格式
     * @summary
     * 1、目前删除变更的路径标记到父集合；
     * 2、为了方便比较，将被删除的数据id加入到路径中
     */
    createRemovePathWithId(modification) {
        const path = modification.path;
        const primaryKey = Object.keys(modification.value)[0];
        const primaryKeyValue = modification.value[primaryKey];
        const pathWithId = path.concat([`${primaryKey}:${primaryKeyValue}`]);
        return pathWithId;
    }
    /**
     * 判断是否是后代节点路径
     * @param parentPath 父节点路径
     * @param descendantPath 后代节点
     */
    isDescendantPath(parentPath, descendantPath) {
        if (parentPath.length > descendantPath.length) {
            return false;
        }
        let isDescendantPath = true;
        parentPath.forEach((parentPathItem, parentPathItemIndex) => {
            if (parentPathItem !== descendantPath[parentPathItemIndex]) {
                isDescendantPath = false;
                return;
            }
        });
        return isDescendantPath;
    }
}
export { ChangeSet };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbmdlX3NldC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2NoYW5nZXNldC9jaGFuZ2Vfc2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7OztHQUtHO0FBRUgsT0FBTyxFQUFnQixVQUFVLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDbkQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNwQyw2Q0FBNkM7QUFDN0MsNERBQTREO0FBQzVELElBQUk7QUFFSjs7R0FFRztBQUNILE1BQU0sU0FBUztJQUFmO1FBQ0U7O1dBRUc7UUFDTyxrQkFBYSxHQUFtQixFQUFFLENBQUM7SUFrTi9DLENBQUM7SUFoTkM7O09BRUc7SUFDSCxJQUFXLE9BQU87UUFDaEIsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDO0lBQzVCLENBQUM7SUFFRDs7Ozs7Ozs7O09BU0c7SUFDSSxNQUFNLENBQUMsWUFBMEI7UUFDdEMsUUFBUSxZQUFZLENBQUMsSUFBSSxFQUFFO1lBQ3pCLEtBQUssVUFBVSxDQUFDLFdBQVc7Z0JBQ3pCLElBQUksQ0FBQyw2QkFBNkIsQ0FBQyxZQUFZLENBQUMsQ0FBQztnQkFDakQsTUFBTTtZQUNSLEtBQUssVUFBVSxDQUFDLEdBQUcsQ0FBQztZQUNwQixLQUFLLFVBQVUsQ0FBQyxNQUFNLENBQUM7WUFDdkIsS0FBSyxVQUFVLENBQUMsS0FBSztnQkFDbkIsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUN6QyxNQUFNO1lBQ1IsS0FBSyxVQUFVLENBQUMsTUFBTTtnQkFDcEIsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUM1QyxNQUFNO1lBQ1IsS0FBSyxVQUFVLENBQUMsSUFBSTtnQkFDbEIsTUFBTTtZQUNSO2dCQUNFLE1BQU07U0FDVDtJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLDZCQUE2QixDQUFDLFlBQTBCO1FB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QyxDQUFDO1FBQ3ZELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLFVBQVUsSUFBSSxlQUFlLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDckUsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQztJQUVEOzs7O09BSUc7SUFDSyxnQkFBZ0IsQ0FBQyxVQUFvQixFQUFFLGNBQXdCO1FBQ3JFLElBQUksVUFBVSxDQUFDLE1BQU0sR0FBRyxjQUFjLENBQUMsTUFBTSxFQUFFO1lBQzdDLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFFRCxJQUFJLGdCQUFnQixHQUFHLElBQUksQ0FBQztRQUM1QixVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsY0FBc0IsRUFBRSxtQkFBMkIsRUFBRSxFQUFFO1lBQ3pFLElBQUksY0FBYyxLQUFLLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFO2dCQUMxRCxnQkFBZ0IsR0FBRyxLQUFLLENBQUM7Z0JBQ3pCLE9BQU87YUFDUjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxnQkFBZ0IsQ0FBQztJQUMxQixDQUFDO0NBRUY7QUFFRCxPQUFPLEVBQUUsU0FBUyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiBMdWN1cywgV2l0dFxyXG4gKiBARGF0ZTogMjAxOC0xMC0zMCAxNTo1Mzo1OVxyXG4gKiBATGFzdCBNb2RpZmllZCBieTogV2l0dFxyXG4gKiBATGFzdCBNb2RpZmllZCB0aW1lOiAyMDE4LTExLTA4IDE3OjI1OjA4XHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgTW9kaWZpY2F0aW9uLCBNb2RpZnlUeXBlIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IGlzRXF1YWwgfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG4vLyBmdW5jdGlvbiBpc0VxdWFsKHZhbHVlOiBhbnksIG90aGVyOiBhbnkpIHtcclxuLy8gICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodmFsdWUpID09PSBKU09OLnN0cmluZ2lmeShvdGhlcik7XHJcbi8vIH1cclxuXHJcbi8qKlxyXG4gKiDlrp7kvZPmlbDmja7lj5jmm7Tpm4ZcclxuICovXHJcbmNsYXNzIENoYW5nZVNldCB7XHJcbiAgLyoqXHJcbiAgICog5Y+Y5pu06ZuG5ZCIXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIG1vZGlmaWNhdGlvbnM6IE1vZGlmaWNhdGlvbltdID0gW107XHJcblxyXG4gIC8qKlxyXG4gICAqICDojrflj5bmiYDmnInnmoTlj5jmm7TorrDlvZVcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0IGNoYW5nZXMoKTogTW9kaWZpY2F0aW9uW10ge1xyXG4gICAgcmV0dXJuIHRoaXMubW9kaWZpY2F0aW9ucztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWwhuWPmOabtOmbhua3u+WKoOWIsOmbhuWQiOS4rVxyXG4gICAqICMjIyDkvb/nlKjnpLrkvotcclxuICAgKiBgYGBcclxuICAgKiBjb25zdCBjaGFuZ2VTZXQgPSBuZXcgQ2hhbmdlU2V0KCk7XHJcbiAgICogY29uc3QgbW9kaWZ5ID0gbmV3IE1vZGlmaWNhdGlvbignbmV3VmFsdWUnLCBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlLCBbMSwgJ3RpdGxlJ10sICdvbGRWYWx1ZScpO1xyXG4gICAqIGNoYW5nZVNldC5hcHBlbmQobW9kaWZ5KVxyXG4gICAqIGBgYFxyXG4gICAqIEBwYXJhbSBjaGFuZ2VJdGVtIOWPmOabtOaVsOaNrlxyXG4gICAqL1xyXG4gIHB1YmxpYyBhcHBlbmQobW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pIHtcclxuICAgIHN3aXRjaCAobW9kaWZpY2F0aW9uLnR5cGUpIHtcclxuICAgICAgY2FzZSBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlOlxyXG4gICAgICAgIHRoaXMuYXBwZW5kVmFsdWVDaGFuZ2VNb2RpZmljYXRpb24obW9kaWZpY2F0aW9uKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSBNb2RpZnlUeXBlLkFkZDpcclxuICAgICAgY2FzZSBNb2RpZnlUeXBlLkluc2VydDpcclxuICAgICAgY2FzZSBNb2RpZnlUeXBlLkNsb25lOlxyXG4gICAgICAgIHRoaXMuYXBwZW5kQWRkTW9kaWZpY2F0aW9uKG1vZGlmaWNhdGlvbik7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGNhc2UgTW9kaWZ5VHlwZS5SZW1vdmU6XHJcbiAgICAgICAgdGhpcy5hcHBlbmRSZW1vdmVNb2RpZmljYXRpb24obW9kaWZpY2F0aW9uKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSBNb2RpZnlUeXBlLkxvYWQ6XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmt7vliqDlgLzlj5jljJblj5jmm7RcclxuICAgKi9cclxuICBwcml2YXRlIGFwcGVuZFZhbHVlQ2hhbmdlTW9kaWZpY2F0aW9uKG1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSB7XHJcbiAgICBjb25zdCB2YWx1ZSA9IG1vZGlmaWNhdGlvbi52YWx1ZTtcclxuICAgIGNvbnN0IHBhdGggPSBtb2RpZmljYXRpb24ucGF0aC5qb2luKCcvJyk7XHJcbiAgICBjb25zdCBleGlzdGVkTW9kaWZpY2F0aW9uID0gdGhpcy5maW5kTW9kaWZ5SXRlbXNQYXRoKG1vZGlmaWNhdGlvbi5wYXRoKTtcclxuICAgIGlmIChleGlzdGVkTW9kaWZpY2F0aW9uKSB7XHJcbiAgICAgIC8vIOWmguaenOWtmOWcqOebuOWQjOi3r+W+hOeahFZhbHVlQ2hhbmdl57G75Z6L55qE5Y+Y5pu06ZuG77yM5YiZ5pu05paw5YC877ybXHJcbiAgICAgIGV4aXN0ZWRNb2RpZmljYXRpb24udmFsdWUgPSB2YWx1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IGV4aXN0ZWRBZGRNb2RpZmljYXRpb24gPSB0aGlzLmZpbmROZXdBZGRJdGVtc1BhdGgobW9kaWZpY2F0aW9uLnBhdGgpO1xyXG4gICAgICBpZiAoZXhpc3RlZEFkZE1vZGlmaWNhdGlvbikge1xyXG4gICAgICAgIC8vIEB0b2Rv77yaXHJcbiAgICAgICAgLy8gMeOAgeatpOWkhOmAu+i+keaciemXrumimO+8jHZhbHVl5piv5Liq5a2X56ym5Liy77yM5LiN6IO955u05o6lYXNzaWdu77ybXHJcbiAgICAgICAgLy8gMuOAgeS5i+aJgOS7peayoeacieWHuueOsOmXrumimO+8jOaYr+WboOS4uumDveaYr+acjeWKoeWZqOerr+aWsOWinu+8jOaWsOWinuWQju+8jOWuouaIt+err+a4heepuuS6huaJgOacieWPmOabtOOAglxyXG4gICAgICAgIC8vIOWmguaenOWtmOWcqOa2teebluivpVZhbHVlQ2hhbmdl5Y+Y5pu055qEQWRk5Y+Y5pu077yM5YiZ5pu05pawQWRk5Y+Y5pu05a+55bqU55qE5pWw5o2u77ybXHJcbiAgICAgICAgZXhpc3RlZEFkZE1vZGlmaWNhdGlvbi52YWx1ZSA9IE9iamVjdC5hc3NpZ24oe30sIGV4aXN0ZWRBZGRNb2RpZmljYXRpb24udmFsdWUsIHZhbHVlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyDlhbbku5bmg4XlhrXvvIzmlrDlop7kuIDmnaFWYWx1ZUNoYW5nZeWPmOabtOOAglxyXG4gICAgICAgIHRoaXMubW9kaWZpY2F0aW9ucy5wdXNoKG1vZGlmaWNhdGlvbik7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOaWsOWinuWPmOabtFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYXBwZW5kQWRkTW9kaWZpY2F0aW9uKG1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSB7XHJcbiAgICBjb25zdCB2YWx1ZSA9IG1vZGlmaWNhdGlvbi52YWx1ZTtcclxuICAgIGNvbnN0IHBhdGggPSBtb2RpZmljYXRpb24ucGF0aC5qb2luKCcvJyk7XHJcbiAgICBjb25zdCBleGlzdGVkTW9kaWZpY2F0aW9uID0gdGhpcy5maW5kTmV3QWRkSXRlbXNQYXRoKG1vZGlmaWNhdGlvbi5wYXRoKTtcclxuICAgIGlmIChleGlzdGVkTW9kaWZpY2F0aW9uKSB7XHJcbiAgICAgIC8vIDHjgIHlpoLmnpzlt7Lnu4/lrZjlnKjnm7jlkIzot6/lvoTnmoRBZGTlj5jmm7TvvIzliJnlkIjlubZWYWx1ZeOAglxyXG4gICAgICBleGlzdGVkTW9kaWZpY2F0aW9uLnZhbHVlID0gZXhpc3RlZE1vZGlmaWNhdGlvbi52YWx1ZS5jb25jYXQodmFsdWUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gMuOAgeWmguaenOayoeacie+8jOWImeaWsOWinuS4gOadoUFkZOWPmOabtOOAglxyXG4gICAgICB0aGlzLm1vZGlmaWNhdGlvbnMucHVzaChtb2RpZmljYXRpb24pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5re75Yqg5Yig6Zmk5Y+Y5pu0XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhcHBlbmRSZW1vdmVNb2RpZmljYXRpb24obW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pIHtcclxuXHJcbiAgICBjb25zdCBwYXRoID0gbW9kaWZpY2F0aW9uLnBhdGg7XHJcbiAgICBjb25zdCBwcmltYXJ5S2V5ID0gT2JqZWN0LmtleXMobW9kaWZpY2F0aW9uLnZhbHVlKVswXTtcclxuICAgIGNvbnN0IHByaW1hcnlLZXlWYWx1ZSA9IG1vZGlmaWNhdGlvbi52YWx1ZVtwcmltYXJ5S2V5XTtcclxuXHJcbiAgICAvLyAx44CB5a2Y5Zyo55u45ZCMcGF0aOeahOaWsOWinuWPmOabtO+8jOenu+mZpOaWsOWinuWPmOabtO+8jOS4jemcgOimgea3u+WKoOWIoOmZpOWPmOabtO+8m1xyXG4gICAgLy8gQHRvZG/vvJrlvoXph43mnoTvvIgx44CB5Y+q6ICD6JmR5LqG5Li75LuO5oOF5Ya177yMMuOAgeS4tOaXtueUqOWkmumHjeW+queOr+WunueOsO+8iVxyXG4gICAgdGhpcy5tb2RpZmljYXRpb25zLmZvckVhY2goKGFkZE1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSA9PiB7XHJcbiAgICAgIC8vIOWPquWkhOeQhuaWsOWinuWPmOabtFxyXG4gICAgICBpZiAoYWRkTW9kaWZpY2F0aW9uLnR5cGUgIT09IE1vZGlmeVR5cGUuQWRkICYmIGFkZE1vZGlmaWNhdGlvbi50eXBlICE9PSBNb2RpZnlUeXBlLkluc2VydCAmJiBhZGRNb2RpZmljYXRpb24udHlwZSAhPT0gTW9kaWZ5VHlwZS5DbG9uZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gQHRvZG8g5Y+q6ICD6JmR5Li75LuO57uT5p6E77yM5YaN5rex55qE5bGC5qyh5pqC5LiN6ICD6JmRXHJcbiAgICAgIGlmIChpc0VxdWFsKGFkZE1vZGlmaWNhdGlvbi5wYXRoLCBwYXRoKSA9PT0gZmFsc2UpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIOmBjeWOhuaWsOWinuaWsOWinuWPmOabtOeahHZhbHVl77yIdmFsdWXmmK/kuKrmlbDnu4TvvInvvIznp7vpmaTnm7jljLnphY3nmoTmlrDlop7liKDpmaRcclxuICAgICAgYWRkTW9kaWZpY2F0aW9uLnZhbHVlID0gYWRkTW9kaWZpY2F0aW9uLnZhbHVlLmZpbHRlcigoYWRkRGF0YUl0ZW06IGFueSkgPT4ge1xyXG4gICAgICAgIHJldHVybiBhZGREYXRhSXRlbVtwcmltYXJ5S2V5XSAhPT0gcHJpbWFyeUtleVZhbHVlO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIDLjgIHnp7vpmaTlr7nlupTnmoTkv67mlLnlj5jmm7RcclxuICAgIGNvbnN0IGZ1bGxSZW1vdmVQYXRoID0gcGF0aC5jb25jYXQoYCR7cHJpbWFyeUtleX06JHtwcmltYXJ5S2V5VmFsdWV9YCk7XHJcbiAgICB0aGlzLm1vZGlmaWNhdGlvbnMgPSB0aGlzLm1vZGlmaWNhdGlvbnMuZmlsdGVyKCh2YWx1ZU1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSA9PiB7XHJcbiAgICAgIGlmICh2YWx1ZU1vZGlmaWNhdGlvbi50eXBlICE9PSBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgdmFsdWVDaGFuZ2VQYXRoID0gQXJyYXkuZnJvbSh2YWx1ZU1vZGlmaWNhdGlvbi5wYXRoKTtcclxuICAgICAgdmFsdWVDaGFuZ2VQYXRoLnBvcCgpO1xyXG5cclxuICAgICAgLy8g6Lev5b6E55u45ZCM6L+b6KGM56e76ZmkXHJcbiAgICAgIGNvbnN0IGlzVG9SZW1vdmUgPSBpc0VxdWFsKHZhbHVlQ2hhbmdlUGF0aCwgZnVsbFJlbW92ZVBhdGgpO1xyXG4gICAgICByZXR1cm4gIWlzVG9SZW1vdmU7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyDlhYjliKDpmaTkuIvnuqfliKDpmaTlj5jmm7TvvIzlho3mj5LlhaVcclxuICAgIC8vIOS4u+imgemSiOWvueS7juS7juihqOWIoOmZpOS5i+WQju+8jOWPiOWIoOmZpOWtkOihqOaXtu+8jOagueWunuS9k+S4iui/mOWtmOWcqOS7juS7juihqOWIoOmZpOWPmOabtOeahOWcuuaZr1xyXG4gICAgdGhpcy5yZW1vdmVEZXNjZW5kYW50UmVtb3ZlTW9kaWZpY2F0aW9ucyhtb2RpZmljYXRpb24pO1xyXG4gICAgdGhpcy5tb2RpZmljYXRpb25zLnB1c2gobW9kaWZpY2F0aW9uKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa4heepuuWPmOabtOmbhuWQiFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjbGVhcigpIHtcclxuICAgIHRoaXMubW9kaWZpY2F0aW9ucyA9IFtdO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOagueaNrnBhdGjojrflj5ZBZGTnsbvlnovnmoTlj5jmm7TorrDlvZVcclxuICAgKiBAcGFyYW0gcGF0aCDlj5jmm7Tot6/lvoRcclxuICAgKi9cclxuICBwcml2YXRlIGZpbmROZXdBZGRJdGVtc1BhdGgocGF0aDogYW55W10pIHtcclxuICAgIHJldHVybiB0aGlzLm1vZGlmaWNhdGlvbnMuZmluZCgodmFsdWUsIGluZGV4KSA9PiB7XHJcbiAgICAgIHJldHVybiBpc0VxdWFsKHBhdGgsIHZhbHVlLnBhdGgpICYmICh2YWx1ZS50eXBlID09PSBNb2RpZnlUeXBlLkFkZCB8fCB2YWx1ZS50eXBlID09PSBNb2RpZnlUeXBlLkluc2VydCB8fCB2YWx1ZS50eXBlID09PSBNb2RpZnlUeXBlLkNsb25lKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2ucGF0aOiOt+WPllZhbHVlQ2hhbmdl57G75Z6L55qE5Y+Y5pu06K6w5b2VXHJcbiAgICogQHBhcmFtIHBhdGgg5Y+Y5pu06Lev5b6EXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmaW5kTW9kaWZ5SXRlbXNQYXRoKHBhdGg6IGFueVtdKSB7XHJcbiAgICByZXR1cm4gdGhpcy5tb2RpZmljYXRpb25zLmZpbmQoKHZhbHVlLCBpbmRleCkgPT4ge1xyXG4gICAgICByZXR1cm4gaXNFcXVhbChwYXRoLCB2YWx1ZS5wYXRoKSAmJiB2YWx1ZS50eXBlID09PSBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliKDpmaTlkI7ku6PvvIjljIXmi6zoh6rlt7HvvInmiYDmnInnmoTliKDpmaTlj5jmm7RcclxuICAgKiBAdG9kb++8muS4tOaXtuWBmuS4gOS4quacgOWwj+WMluS/ruaUuVxyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVtb3ZlRGVzY2VuZGFudFJlbW92ZU1vZGlmaWNhdGlvbnMocGFyZW50UmVtb3ZlTW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pOiB2b2lkIHtcclxuXHJcbiAgICBjb25zdCBwYXJlbnRQYXRoV2l0aElkID0gdGhpcy5jcmVhdGVSZW1vdmVQYXRoV2l0aElkKHBhcmVudFJlbW92ZU1vZGlmaWNhdGlvbik7XHJcblxyXG4gICAgLy8g5Yig6Zmk5ZCO5Luj5L+u5pS55Y+Y5pu0XHJcbiAgICB0aGlzLm1vZGlmaWNhdGlvbnMgPSB0aGlzLm1vZGlmaWNhdGlvbnMuZmlsdGVyKChtb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbikgPT4ge1xyXG4gICAgICBpZiAobW9kaWZpY2F0aW9uLnR5cGUgIT09IE1vZGlmeVR5cGUuUmVtb3ZlKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgZGVzY2VuZGFudFBhdGhXaXRoSWQgPSB0aGlzLmNyZWF0ZVJlbW92ZVBhdGhXaXRoSWQobW9kaWZpY2F0aW9uKTtcclxuICAgICAgY29uc3QgaXNEZXNjZW5kYW50ID0gdGhpcy5pc0Rlc2NlbmRhbnRQYXRoKHBhcmVudFBhdGhXaXRoSWQsIGRlc2NlbmRhbnRQYXRoV2l0aElkKTtcclxuICAgICAgcmV0dXJuICFpc0Rlc2NlbmRhbnQ7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWIoOmZpOi3r+W+hOeahOWujOaVtOagvOW8j1xyXG4gICAqIEBzdW1tYXJ5XHJcbiAgICogMeOAgeebruWJjeWIoOmZpOWPmOabtOeahOi3r+W+hOagh+iusOWIsOeItumbhuWQiO+8m1xyXG4gICAqIDLjgIHkuLrkuobmlrnkvr/mr5TovoPvvIzlsIbooqvliKDpmaTnmoTmlbDmja5pZOWKoOWFpeWIsOi3r+W+hOS4rVxyXG4gICAqL1xyXG4gIHByaXZhdGUgY3JlYXRlUmVtb3ZlUGF0aFdpdGhJZChtb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbikge1xyXG4gICAgY29uc3QgcGF0aCA9IG1vZGlmaWNhdGlvbi5wYXRoO1xyXG4gICAgY29uc3QgcHJpbWFyeUtleSA9IE9iamVjdC5rZXlzKG1vZGlmaWNhdGlvbi52YWx1ZSlbMF07XHJcbiAgICBjb25zdCBwcmltYXJ5S2V5VmFsdWUgPSBtb2RpZmljYXRpb24udmFsdWVbcHJpbWFyeUtleV07XHJcbiAgICBjb25zdCBwYXRoV2l0aElkID0gcGF0aC5jb25jYXQoW2Ake3ByaW1hcnlLZXl9OiR7cHJpbWFyeUtleVZhbHVlfWBdKTtcclxuICAgIHJldHVybiBwYXRoV2l0aElkO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yik5pat5piv5ZCm5piv5ZCO5Luj6IqC54K56Lev5b6EXHJcbiAgICogQHBhcmFtIHBhcmVudFBhdGgg54i26IqC54K56Lev5b6EXHJcbiAgICogQHBhcmFtIGRlc2NlbmRhbnRQYXRoIOWQjuS7o+iKgueCuVxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNEZXNjZW5kYW50UGF0aChwYXJlbnRQYXRoOiBzdHJpbmdbXSwgZGVzY2VuZGFudFBhdGg6IHN0cmluZ1tdKSB7XHJcbiAgICBpZiAocGFyZW50UGF0aC5sZW5ndGggPiBkZXNjZW5kYW50UGF0aC5sZW5ndGgpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBpc0Rlc2NlbmRhbnRQYXRoID0gdHJ1ZTtcclxuICAgIHBhcmVudFBhdGguZm9yRWFjaCgocGFyZW50UGF0aEl0ZW06IHN0cmluZywgcGFyZW50UGF0aEl0ZW1JbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICAgIGlmIChwYXJlbnRQYXRoSXRlbSAhPT0gZGVzY2VuZGFudFBhdGhbcGFyZW50UGF0aEl0ZW1JbmRleF0pIHtcclxuICAgICAgICBpc0Rlc2NlbmRhbnRQYXRoID0gZmFsc2U7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gaXNEZXNjZW5kYW50UGF0aDtcclxuICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQgeyBDaGFuZ2VTZXQgfTtcclxuXHJcbiJdfQ==