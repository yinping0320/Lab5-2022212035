/*
 * @Author: Witt
 * @Date: 2018-11-17 13:38:23
 * @Last Modified by: Witt
 * @Last Modified time: 2018-11-17 13:38:50
 * @todo：临时删除原有功能，待重构
 */
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { UIStateMetadataUtil } from './uistate_metadata_util';
/**
 * UI状态
 */
export class UIState {
    constructor() {
        this.paramTypeTransform = false;
        this.changes = new Subject();
        this.innerData = Object.assign({});
        this._init();
    }
    _init() {
        const uiFields = UIStateMetadataUtil.getUIFields(this.constructor);
        this.initializeUIField(uiFields);
    }
    initialize(context) {
        const uiFields = context.metadata.uiStates || UIStateMetadataUtil.getUIFields(this.constructor);
        this.initializeUIField(uiFields);
    }
    initializeUIField(uiFieldMetadata) {
        Object.keys(uiFieldMetadata).forEach(propertyName => {
            const fieldMetadata = uiFieldMetadata[propertyName];
            const uiField = fieldMetadata.stateName || propertyName;
            if (delete this[propertyName]) {
                this.defineProperty(propertyName, uiField);
            }
        });
    }
    isExistProperty(propertyName) {
        if (this.innerData.hasOwnProperty(propertyName) || this.hasOwnProperty(propertyName)) {
            return true;
        }
        return false;
    }
    defineProperty(propertyName, field = null) {
        Object.defineProperty(this, propertyName, {
            get: function () {
                return field !== null ? this.innerData[field] : this.innerData[propertyName];
            },
            set: function (value) {
                // 值相同时不触发变更
                const oldValue = field !== null ? this.innerData[field] : this.innerData[propertyName];
                if (this.paramTypeTransform === true) {
                    const ngParams = UIStateMetadataUtil.getUIFields(this.constructor);
                    const ngParam = ngParams && ngParams[propertyName] || null;
                    const dataType = ngParam && ngParam.originalDataType || null;
                    if (dataType) {
                        value = this.transform(value, dataType);
                    }
                }
                if (oldValue === value) {
                    return;
                }
                if (field !== null) {
                    this.innerData[field] = value;
                }
                else {
                    this.innerData[propertyName] = value;
                }
                this.changes.next({
                    field: propertyName,
                    value: value
                });
            }
        });
    }
    setPropertyValue(propertyName, value) {
        if (propertyName === '' || propertyName === undefined) {
            return;
        }
        if (!this.isExistProperty(propertyName)) {
            this.defineProperty(propertyName);
        }
        this[propertyName] = value;
    }
    transform(target, dataType) {
        if (!dataType) {
            return target;
        }
        dataType = dataType.toLowerCase();
        if (dataType === 'string') {
            if (target === null || target === undefined) {
                return target;
            }
            return target.toString();
        }
        else if (dataType === 'number') {
            if (target === undefined) {
                return undefined;
            }
            const result = Number(target);
            if (isNaN(result)) {
                throw new Error(`${target}无法转换为数字！`);
            }
            return result;
        }
        else if (dataType === 'boolean') {
            if (typeof target === 'boolean') {
                return target;
            }
            else {
                if (target === null || target === undefined) {
                    return false;
                }
                target = target.toString().toLowerCase();
                if (target === 'false') {
                    return false;
                }
                else if (target === 'true') {
                    return true;
                }
                else {
                    throw new Error(`${target}无法转换为布尔类型！`);
                }
            }
        }
        else if (dataType === 'date' || dataType === 'datetime') {
            // 日期、日期时间在前端依然按照字符串处理
            return target;
        }
        else if (dataType === 'object') {
            if (typeof target === 'object') {
                return target;
            }
            else {
                try {
                    return JSON.parse(target);
                }
                catch (_a) {
                    throw new Error(`${target}无法转换为对象！`);
                }
            }
        }
        else {
            return target;
        }
    }
}
UIState.decorators = [
    { type: Injectable }
];
/** @nocollapse */
UIState.ctorParameters = () => [];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidWlfc3RhdGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi91aS1zdGF0ZS91aV9zdGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFFSCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFPOUQ7O0dBRUc7QUFFSCxNQUFNLE9BQU8sT0FBTztJQVNsQjtRQURPLHVCQUFrQixHQUFHLEtBQUssQ0FBQztRQUVoQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksT0FBTyxFQUEwQixDQUFDO1FBQ3JELElBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDZixDQUFDO0lBRUQsS0FBSztRQUNILE1BQU0sUUFBUSxHQUFHLG1CQUFtQixDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDbkUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRCxVQUFVLENBQUMsT0FBWTtRQUNyQixNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLFFBQVEsSUFBSSxtQkFBbUIsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ2hHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRU8saUJBQWlCLENBQUMsZUFBMkM7UUFDbkUsTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDbEQsTUFBTSxhQUFhLEdBQUcs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LHNCQUFzQjtZQUN0QixPQUFPLE1BQU0sQ0FBQztTQUNmO2FBQU0sSUFBSSxRQUFRLEtBQUssUUFBUSxFQUFFO1lBQ2hDLElBQUksT0FBTyxNQUFNLEtBQUssUUFBUSxFQUFFO2dCQUM5QixPQUFPLE1BQU0sQ0FBQzthQUNmO2lCQUFNO2dCQUNMLElBQUk7b0JBQ0YsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUMzQjtnQkFBQyxXQUFNO29CQUNOLE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxNQUFNLFVBQVUsQ0FBQyxDQUFDO2lCQUN0QzthQUNGO1NBQ0Y7YUFBTTtZQUNMLE9BQU8sTUFBTSxDQUFDO1NBQ2Y7SUFDSCxDQUFDOzs7WUF4SUYsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIEBBdXRob3I6IFdpdHRcclxuICogQERhdGU6IDIwMTgtMTEtMTcgMTM6Mzg6MjNcclxuICogQExhc3QgTW9kaWZpZWQgYnk6IFdpdHRcclxuICogQExhc3QgTW9kaWZpZWQgdGltZTogMjAxOC0xMS0xNyAxMzozODo1MFxyXG4gKiBAdG9kb++8muS4tOaXtuWIoOmZpOWOn+acieWKn+iDve+8jOW+hemHjeaehFxyXG4gKi9cclxuXHJcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBVSVN0YXRlTWV0YWRhdGFVdGlsIH0gZnJvbSAnLi91aXN0YXRlX21ldGFkYXRhX3V0aWwnO1xyXG5pbXBvcnQgeyBOZ1BhcmFtIH0gZnJvbSAnLi9kZWNvcmF0b3JzJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgVUlTdGF0ZU9ic2VydmFibGVQYXJhbSB7XHJcbiAgZmllbGQ6IHN0cmluZztcclxuICB2YWx1ZTogYW55O1xyXG59XHJcbi8qKlxyXG4gKiBVSeeKtuaAgVxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgVUlTdGF0ZSB7XHJcbiAgLyoqXHJcbiAgICogQGRlcHJlY2F0ZWQgaW5uZXJEYXRh5Li654q25oCB5py65YaF6YOo5Y+Y6YeP77yM5aSW6YOo6K+35LiN6KaB5L2/55SoXHJcbiAgICovXHJcbiAgaW5uZXJEYXRhOiB7fTtcclxuXHJcbiAgLy8g55uR5ZCs5Y+Y5YyWXHJcbiAgcHVibGljIGNoYW5nZXM6IFN1YmplY3Q8VUlTdGF0ZU9ic2VydmFibGVQYXJhbT47XHJcbiAgcHVibGljIHBhcmFtVHlwZVRyYW5zZm9ybSA9IGZhbHNlO1xyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy5jaGFuZ2VzID0gbmV3IFN1YmplY3Q8VUlTdGF0ZU9ic2VydmFibGVQYXJhbT4oKTtcclxuICAgIHRoaXMuaW5uZXJEYXRhID0gT2JqZWN0LmFzc2lnbih7fSk7XHJcbiAgICB0aGlzLl9pbml0KCk7XHJcbiAgfVxyXG5cclxuICBfaW5pdCgpIHtcclxuICAgIGNvbnN0IHVpRmllbGRzID0gVUlTdGF0ZU1ldGFkYXRhVXRpbC5nZXRVSUZpZWxkcyh0aGlzLmNvbnN0cnVjdG9yKTtcclxuICAgIHRoaXMuaW5pdGlhbGl6ZVVJRmllbGQodWlGaWVsZHMpO1xyXG4gIH1cclxuXHJcbiAgaW5pdGlhbGl6ZShjb250ZXh0OiBhbnkpIHtcclxuICAgIGNvbnN0IHVpRmllbGRzID0gY29udGV4dC5tZXRhZGF0YS51aVN0YXRlcyB8fCBVSVN0YXRlTWV0YWRhdGFVdGlsLmdldFVJRmllbGRzKHRoaXMuY29uc3RydWN0b3IpO1xyXG4gICAgdGhpcy5pbml0aWFsaXplVUlGaWVsZCh1aUZpZWxkcyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRpYWxpemVVSUZpZWxkKHVpRmllbGRNZXRhZGF0YTogeyBba2V5OiBzdHJpbmddOiBOZ1BhcmFtIH0pOiB2b2lkIHtcclxuICAgIE9iamVjdC5rZXlzKHVpRmllbGRNZXRhZGF0YSkuZm9yRWFjaChwcm9wZXJ0eU5hbWUgPT4ge1xyXG4gICAgICBjb25zdCBmaWVsZE1ldGFkYXRhID0gdWlGaWVsZE1ldGFkYXRhW3Byb3BlcnR5TmFtZV0gYXMgTmdQYXJhbTtcclxuICAgICAgY29uc3QgdWlGaWVsZCA9IGZpZWxkTWV0YWRhdGEuc3RhdGVOYW1lIHx8IHByb3BlcnR5TmFtZTtcclxuXHJcbiAgICAgIGlmIChkZWxldGUgdGhpc1twcm9wZXJ0eU5hbWVdKSB7XHJcbiAgICAgICAgdGhpcy5kZWZpbmVQcm9wZXJ0eShwcm9wZXJ0eU5hbWUsIHVpRmllbGQpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBpc0V4aXN0UHJvcGVydHkocHJvcGVydHlOYW1lOiBhbnkpIHtcclxuICAgIGlmICh0aGlzLmlubmVyRGF0YS5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eU5hbWUpIHx8IHRoaXMuaGFzT3duUHJvcGVydHkocHJvcGVydHlOYW1lKSkge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZGVmaW5lUHJvcGVydHkocHJvcGVydHlOYW1lOiBhbnksIGZpZWxkOiBhbnkgPSBudWxsKSB7XHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgcHJvcGVydHlOYW1lLCB7XHJcbiAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiBmaWVsZCAhPT0gbnVsbCA/IHRoaXMuaW5uZXJEYXRhW2ZpZWxkXSA6IHRoaXMuaW5uZXJEYXRhW3Byb3BlcnR5TmFtZV07XHJcbiAgICAgIH0sXHJcbiAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7XHJcbiAgICAgICAgLy8g5YC855u45ZCM5pe25LiN6Kem5Y+R5Y+Y5pu0XHJcbiAgICAgICAgY29uc3Qgb2xkVmFsdWUgPSBmaWVsZCAhPT0gbnVsbCA/IHRoaXMuaW5uZXJEYXRhW2ZpZWxkXSA6IHRoaXMuaW5uZXJEYXRhW3Byb3BlcnR5TmFtZV07XHJcbiAgICAgICAgaWYgKHRoaXMucGFyYW1UeXBlVHJhbnNmb3JtID09PSB0cnVlKSB7XHJcbiAgICAgICAgICBjb25zdCBuZ1BhcmFtcyA9IFVJU3RhdGVNZXRhZGF0YVV0aWwuZ2V0VUlGaWVsZHModGhpcy5jb25zdHJ1Y3Rvcik7XHJcbiAgICAgICAgICBjb25zdCBuZ1BhcmFtID0gbmdQYXJhbXMgJiYgbmdQYXJhbXNbcHJvcGVydHlOYW1lXSB8fCBudWxsO1xyXG4gICAgICAgICAgY29uc3QgZGF0YVR5cGUgPSBuZ1BhcmFtICYmIG5nUGFyYW0ub3JpZ2luYWxEYXRhVHlwZSB8fCBudWxsO1xyXG4gICAgICAgICAgaWYgKGRhdGFUeXBlKSB7XHJcbiAgICAgICAgICAgIHZhbHVlID0gdGhpcy50cmFuc2Zvcm0odmFsdWUsIGRhdGFUeXBlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG9sZFZhbHVlID09PSB2YWx1ZSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZmllbGQgIT09IG51bGwpIHtcclxuICAgICAgICAgIHRoaXMuaW5uZXJEYXRhW2ZpZWxkXSA9IHZhbHVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLmlubmVyRGF0YVtwcm9wZXJ0eU5hbWVdID0gdmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY2hhbmdlcy5uZXh0KHtcclxuICAgICAgICAgIGZpZWxkOiBwcm9wZXJ0eU5hbWUsXHJcbiAgICAgICAgICB2YWx1ZTogdmFsdWVcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2V0UHJvcGVydHlWYWx1ZShwcm9wZXJ0eU5hbWU6IGFueSwgdmFsdWU6IGFueSkge1xyXG4gICAgaWYgKHByb3BlcnR5TmFtZSA9PT0gJycgfHwgcHJvcGVydHlOYW1lID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKCF0aGlzLmlzRXhpc3RQcm9wZXJ0eShwcm9wZXJ0eU5hbWUpKSB7XHJcbiAgICAgIHRoaXMuZGVmaW5lUHJvcGVydHkocHJvcGVydHlOYW1lKTtcclxuICAgIH1cclxuICAgIHRoaXNbcHJvcGVydHlOYW1lXSA9IHZhbHVlO1xyXG4gIH1cclxuICBwcml2YXRlIHRyYW5zZm9ybSh0YXJnZXQ6IGFueSwgZGF0YVR5cGU6IHN0cmluZykge1xyXG4gICAgaWYgKCFkYXRhVHlwZSkge1xyXG4gICAgICByZXR1cm4gdGFyZ2V0O1xyXG4gICAgfVxyXG4gICAgZGF0YVR5cGUgPSBkYXRhVHlwZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgaWYgKGRhdGFUeXBlID09PSAnc3RyaW5nJykge1xyXG4gICAgICBpZiAodGFyZ2V0ID09PSBudWxsIHx8IHRhcmdldCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgcmV0dXJuIHRhcmdldDtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdGFyZ2V0LnRvU3RyaW5nKCk7XHJcbiAgICB9IGVsc2UgaWYgKGRhdGFUeXBlID09PSAnbnVtYmVyJykge1xyXG4gICAgICBpZiAodGFyZ2V0ID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IE51bWJlcih0YXJnZXQpO1xyXG4gICAgICBpZiAoaXNOYU4ocmVzdWx0KSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgJHt0YXJnZXR95peg5rOV6L2s5o2i5Li65pWw5a2X77yBYCk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH0gZWxzZSBpZiAoZGF0YVR5cGUgPT09ICdib29sZWFuJykge1xyXG4gICAgICBpZiAodHlwZW9mIHRhcmdldCA9PT0gJ2Jvb2xlYW4nKSB7XHJcbiAgICAgICAgcmV0dXJuIHRhcmdldDtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAodGFyZ2V0ID09PSBudWxsIHx8IHRhcmdldCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRhcmdldCA9IHRhcmdldC50b1N0cmluZygpLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgaWYgKHRhcmdldCA9PT0gJ2ZhbHNlJykge1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodGFyZ2V0ID09PSAndHJ1ZScpIHtcclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7dGFyZ2V0feaXoOazlei9rOaNouS4uuW4g+WwlOexu+Wei++8gWApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChkYXRhVHlwZSA9PT0gJ2RhdGUnIHx8IGRhdGFUeXBlID09PSAnZGF0ZXRpbWUnKSB7XHJcbiAgICAgIC8vIOaXpeacn+OAgeaXpeacn+aXtumXtOWcqOWJjeerr+S+neeEtuaMieeFp+Wtl+espuS4suWkhOeQhlxyXG4gICAgICByZXR1cm4gdGFyZ2V0O1xyXG4gICAgfSBlbHNlIGlmIChkYXRhVHlwZSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgaWYgKHR5cGVvZiB0YXJnZXQgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgcmV0dXJuIHRhcmdldDtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UodGFyZ2V0KTtcclxuICAgICAgICB9IGNhdGNoIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgJHt0YXJnZXR95peg5rOV6L2s5o2i5Li65a+56LGh77yBYCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdGFyZ2V0O1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=