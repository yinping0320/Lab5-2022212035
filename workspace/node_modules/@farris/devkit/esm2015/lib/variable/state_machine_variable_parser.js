/*
 * StateMachine变量解析
 * @Author: Witt
 * @Date: 2018-12-04 17:09:42
 * @Last Modified by: Witt
 * @Last Modified time: 2019-10-30 11:07:10
 */
import { Injectable } from '@angular/core';
import { ParseUtil } from './parse_util';
/**
 * 状态机变量解析
 * @summary
 *
 * 解析策略：
 * 1、不带frameId，从顶层StateMachine中解析
 * {STATEMACHINE~/states/key}
 * {STATEMACHINE~/renderStates/key}
 *
 * 2、带frameId，从frameId对应的FrameContext的StateMachine中解析
 * {STATEMACHINE~/frameId/states/key}
 * {STATEMACHINE~/frameId/renderStates/key}
 *
 * 存在的问题：
 * 1、不带frameId从顶层StateMachine解析仅为了兼容，将来改为从当前FrameContext的StateMachine中解析；
 * 2、组合表单中顶层StateMachine是主表单的rootFrameContext的StateMachine，显然不合理（既成事实）；
 * 3、farmeId如果是states或renderStates，导致解析失败，几率很小，但又风险。
 */
class StateMachineVariableParser {
    /**
     * 构造函数
     */
    constructor() {
    }
    /**
     * 解析变量
     * @param expression 变量：格式形如：/frameId/componentId/stateName
     * @param context 上下文
     */
    parse(expression, context) {
        const paths = this.extractPaths(expression);
        // 1、单个的表达式：直接求值
        if (paths.length === 1 && expression === `{STATEMACHINE~${paths[0]}}`) {
            return this.getValue(paths[0], context);
        }
        // 2、其他情况：字符串替换
        paths.forEach(path => {
            const searchValue = `{STATEMACHINE~${path}}`;
            const replaceValue = this.getValue(path, context);
            expression = expression.replace(searchValue, replaceValue);
        });
        return expression;
    }
    /**
     * 提取Session变量名
     * 变量格式：{}
     */
    extractPaths(expression) {
        const paths = [];
        // 查找所有的StateMachine变量字符串
        const STATE_MACHINE_PATTERN_G = /\{STATEMACHINE~(\S+?)\}/g;
        const stateMachineVariables = expression.match(STATE_MACHINE_PATTERN_G);
        if (stateMachineVariables === null) {
            return [];
        }
        // 提取后边的路径
        const STATE_MACHINE_PATTERN = /\{STATEMACHINE~(\S+?)\}/;
        stateMachineVariables.forEach(sessionVariable => {
            const pathMatches = sessionVariable.match(STATE_MACHINE_PATTERN);
            if (pathMatches != null && pathMatches.length === 2) {
                paths.push(pathMatches[1]);
            }
        });
        return paths;
    }
    /**
     * 获取对应的值
     */
    getValue(path, context) {
        const pathObj = this.getPathObj(path);
        const stateMachine = this.getTargetStateMachine(pathObj.frameId, context);
        if (pathObj.type === 'currentState') {
            return stateMachine.context.state;
        }
        else if (pathObj.type === 'renderStates') {
            return stateMachine[pathObj.name];
        }
        else {
            throw new Error(`不支类型为${pathObj.type}的状态机变量`);
        }
    }
    /**
     * 解析path，并获取对应的StateMachine实例
     */
    getTargetStateMachine(frameId, context) {
        let targetFrameContext;
        if (frameId) {
            targetFrameContext = ParseUtil.getFrameContextById(context, frameId);
        }
        else {
            targetFrameContext = ParseUtil.getRootFrameContext(context);
        }
        if (!targetFrameContext || !targetFrameContext.stateMachine) {
            throw new Error('找不到对应的状态机实例，请检查！');
        }
        return targetFrameContext.stateMachine;
    }
    /**
     * 将Path解析为格式化的Path对象
     */
    getPathObj(path) {
        let parsedPathObj;
        const parts = this.splitPath(path);
        if (parts[0] === 'currentState' || parts[0] === 'renderStates') {
            parsedPathObj = {
                frameId: '',
                type: parts[0],
                name: parts[1]
            };
        }
        else {
            parsedPathObj = {
                frameId: parts[0],
                type: parts[1],
                name: parts[2]
            };
        }
        return parsedPathObj;
    }
    /**
     * 分隔Path
     */
    splitPath(path) {
        const parts = path.split('/').filter((part) => {
            return part !== '';
        });
        return parts;
    }
}
StateMachineVariableParser.decorators = [
    { type: Injectable }
];
/** @nocollapse */
StateMachineVariableParser.ctorParameters = () => [];
export { StateMachineVariableParser };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVfbWFjaGluZV92YXJpYWJsZV9wYXJzZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi92YXJpYWJsZS9zdGF0ZV9tYWNoaW5lX3ZhcmlhYmxlX3BhcnNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFDSCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBSTNDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFekM7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBaUJHO0FBQ0gsTUFDTSwwQkFBMEI7SUFFOUI7O09BRUc7SUFDSDtJQUNBLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksS0FBSyxDQUFDLFVBQWtCLEVBQUUsT0FBWTtRQUMzQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRTVDLGdCQUFnQjtRQUNoQixJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLFVBQVUsS0FBSyxpQkFBaUIsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUU7WUFDckUsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUN6QztRQUVELGVBQWU7UUFDZixLQUFLLENBQUMsT0FBTyxDQUFFLElBQUksQ0FBQyxFQUFFO1lBQ3BCLE1BQU0sV0FBVyxHQUFHLGlCQUFpQixJQUFJLEdBQUcsQ0FBQztZQUM3QyxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztZQUNsRCxVQUFVLEdBQUcsVUFBVSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDN0QsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFRLFVBQVUsQ0FBQztJQUNyQixDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssWUFBWSxDQUFDLFVBQWtCO1FBQ3JDLE1BQU0sS0FBSyxHQUFjLEVBQUUsQ0FBQztRQUU1Qix5QkFBeUI7UUFDekIsTUFBTSx1QkFBdUIsR0FBRywwQkFBMEIsQ0FBQztRQUMzRCxNQUFNLHFCQUFxQixHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUN4RSxJQUFJLHFCQUFxQixLQUFLLElBQUksRUFBRTtZQUNsQyxPQUFPLEVBQUUsQ0FBQztTQUNYO1FBRUQsVUFBVTtRQUNWLE1BQU0scUJBQXFCLEdBQUcseUJBQXlCLENBQUM7UUFDeEQscUJBQXFCLENBQUMsT0FBTyxDQUFFLGVBQWUsQ0FBQyxFQUFFO1lBQy9DLE1BQU0sV0FBVyxHQUFHLGVBQWUsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsQ0FBQztZQUNqRSxJQUFJLFdBQVcsSUFBSSxJQUFJLElBQUksV0FBVyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7Z0JBQ25ELEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDNUI7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVEOztPQUVHO0lBQ0ssUUFBUSxDQUFDLElBQVksRUFBRSxPQUFZO1FBRXpDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEMsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFFMUUsSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLGNBQWMsRUFBRTtZQUNuQyxPQUFPLFlBQVksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO1NBQ25DO2FBQU0sSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLGNBQWMsRUFBRTtZQUMxQyxPQUFPLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFZLENBQUM7U0FDOUM7YUFBTTtZQUNMLE1BQU0sSUFBSSxLQUFLLENBQUMsUUFBUSxPQUFPLENBQUMsSUFBSSxRQUFRLENBQUMsQ0FBQztTQUMvQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLHFCQUFxQixDQUFDLE9BQWUsRUFBRSxPQUFPO1FBQ3BELElBQUksa0JBQWdDLENBQUM7UUFDckMsSUFBSSxPQUFPLEVBQUU7WUFDWCxrQkFBa0IsR0FBRyxTQUFTLENBQUMsbUJBQW1CLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQ3RFO2FBQU07WUFDTCxrQkFBa0IsR0FBRyxTQUFTLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDN0Q7UUFFRCxJQUFJLENBQUMsa0JBQWtCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLEVBQUU7WUFDM0QsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1NBQ3JDO1FBQ0QsT0FBTyxrQkFBa0IsQ0FBQyxZQUFZLENBQUM7SUFDekMsQ0FBQztJQUVEOztPQUVHO0lBQ0ssVUFBVSxDQUFDLElBQVk7UUFDN0IsSUFBSSxhQUFrQixDQUFDO1FBQ3ZCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFbkMsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssY0FBYyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxjQUFjLEVBQUU7WUFDOUQsYUFBYSxHQUFHO2dCQUNkLE9BQU8sRUFBRSxFQUFFO2dCQUNYLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUNkLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO2FBQ2YsQ0FBQztTQUNIO2FBQU07WUFDTCxhQUFhLEdBQUc7Z0JBQ2QsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ2pCLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUNkLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO2FBQ2YsQ0FBQztTQUNIO1FBRUQsT0FBTyxhQUFhLENBQUM7SUFDdkIsQ0FBQztJQUVEOztPQUVHO0lBQ0ssU0FBUyxDQUFDLElBQVk7UUFDNUIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFZLEVBQUUsRUFBRTtZQUNwRCxPQUFPLElBQUksS0FBSyxFQUFFLENBQUM7UUFDckIsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7OztZQTVIRixVQUFVOzs7O0FBZ0lYLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogU3RhdGVNYWNoaW5l5Y+Y6YeP6Kej5p6QXHJcbiAqIEBBdXRob3I6IFdpdHRcclxuICogQERhdGU6IDIwMTgtMTItMDQgMTc6MDk6NDJcclxuICogQExhc3QgTW9kaWZpZWQgYnk6IFdpdHRcclxuICogQExhc3QgTW9kaWZpZWQgdGltZTogMjAxOS0xMC0zMCAxMTowNzoxMFxyXG4gKi9cclxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQgfSBmcm9tICcuLi9mcmFtZS9pbmRleCc7XHJcbmltcG9ydCB7IFN0YXRlTWFjaGluZSB9IGZyb20gJy4uL3N0YXRlLW1hY2hpbmUvaW5kZXgnO1xyXG5pbXBvcnQgeyBWYXJpYWJsZVBhcnNlciB9IGZyb20gJy4vdmFyaWFibGVfcGFyc2VyJztcclxuaW1wb3J0IHsgUGFyc2VVdGlsIH0gZnJvbSAnLi9wYXJzZV91dGlsJztcclxuXHJcbi8qKlxyXG4gKiDnirbmgIHmnLrlj5jph4/op6PmnpBcclxuICogQHN1bW1hcnlcclxuICpcclxuICog6Kej5p6Q562W55Wl77yaXHJcbiAqIDHjgIHkuI3luKZmcmFtZUlk77yM5LuO6aG25bGCU3RhdGVNYWNoaW5l5Lit6Kej5p6QXHJcbiAqIHtTVEFURU1BQ0hJTkV+L3N0YXRlcy9rZXl9XHJcbiAqIHtTVEFURU1BQ0hJTkV+L3JlbmRlclN0YXRlcy9rZXl9XHJcbiAqXHJcbiAqIDLjgIHluKZmcmFtZUlk77yM5LuOZnJhbWVJZOWvueW6lOeahEZyYW1lQ29udGV4dOeahFN0YXRlTWFjaGluZeS4reino+aekFxyXG4gKiB7U1RBVEVNQUNISU5Ffi9mcmFtZUlkL3N0YXRlcy9rZXl9XHJcbiAqIHtTVEFURU1BQ0hJTkV+L2ZyYW1lSWQvcmVuZGVyU3RhdGVzL2tleX1cclxuICpcclxuICog5a2Y5Zyo55qE6Zeu6aKY77yaXHJcbiAqIDHjgIHkuI3luKZmcmFtZUlk5LuO6aG25bGCU3RhdGVNYWNoaW5l6Kej5p6Q5LuF5Li65LqG5YW85a6577yM5bCG5p2l5pS55Li65LuO5b2T5YmNRnJhbWVDb250ZXh055qEU3RhdGVNYWNoaW5l5Lit6Kej5p6Q77ybXHJcbiAqIDLjgIHnu4TlkIjooajljZXkuK3pobblsYJTdGF0ZU1hY2hpbmXmmK/kuLvooajljZXnmoRyb290RnJhbWVDb250ZXh055qEU3RhdGVNYWNoaW5l77yM5pi+54S25LiN5ZCI55CG77yI5pei5oiQ5LqL5a6e77yJ77ybXHJcbiAqIDPjgIFmYXJtZUlk5aaC5p6c5pivc3RhdGVz5oiWcmVuZGVyU3RhdGVz77yM5a+86Ie06Kej5p6Q5aSx6LSl77yM5Yeg546H5b6I5bCP77yM5L2G5Y+I6aOO6Zmp44CCXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmNsYXNzIFN0YXRlTWFjaGluZVZhcmlhYmxlUGFyc2VyIGltcGxlbWVudHMgVmFyaWFibGVQYXJzZXIge1xyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBwdWJsaWMgY29uc3RydWN0b3IoKSB7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDop6PmnpDlj5jph49cclxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbiDlj5jph4/vvJrmoLzlvI/lvaLlpoLvvJovZnJhbWVJZC9jb21wb25lbnRJZC9zdGF0ZU5hbWVcclxuICAgKiBAcGFyYW0gY29udGV4dCDkuIrkuIvmlodcclxuICAgKi9cclxuICBwdWJsaWMgcGFyc2UoZXhwcmVzc2lvbjogc3RyaW5nLCBjb250ZXh0OiBhbnkpOiBhbnkge1xyXG4gICAgY29uc3QgcGF0aHMgPSB0aGlzLmV4dHJhY3RQYXRocyhleHByZXNzaW9uKTtcclxuXHJcbiAgICAvLyAx44CB5Y2V5Liq55qE6KGo6L6+5byP77ya55u05o6l5rGC5YC8XHJcbiAgICBpZiAocGF0aHMubGVuZ3RoID09PSAxICYmIGV4cHJlc3Npb24gPT09IGB7U1RBVEVNQUNISU5FfiR7cGF0aHNbMF19fWApIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZ2V0VmFsdWUocGF0aHNbMF0sIGNvbnRleHQpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIDLjgIHlhbbku5bmg4XlhrXvvJrlrZfnrKbkuLLmm7/mjaJcclxuICAgIHBhdGhzLmZvckVhY2goIHBhdGggPT4ge1xyXG4gICAgICBjb25zdCBzZWFyY2hWYWx1ZSA9IGB7U1RBVEVNQUNISU5FfiR7cGF0aH19YDtcclxuICAgICAgY29uc3QgcmVwbGFjZVZhbHVlID0gdGhpcy5nZXRWYWx1ZShwYXRoLCBjb250ZXh0KTtcclxuICAgICAgZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24ucmVwbGFjZShzZWFyY2hWYWx1ZSwgcmVwbGFjZVZhbHVlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiAgZXhwcmVzc2lvbjtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaPkOWPllNlc3Npb27lj5jph4/lkI1cclxuICAgKiDlj5jph4/moLzlvI/vvJp7fVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZXh0cmFjdFBhdGhzKGV4cHJlc3Npb246IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICAgIGNvbnN0IHBhdGhzOiBzdHJpbmdbXSAgPSBbXTtcclxuXHJcbiAgICAvLyDmn6Xmib7miYDmnInnmoRTdGF0ZU1hY2hpbmXlj5jph4/lrZfnrKbkuLJcclxuICAgIGNvbnN0IFNUQVRFX01BQ0hJTkVfUEFUVEVSTl9HID0gL1xce1NUQVRFTUFDSElORX4oXFxTKz8pXFx9L2c7XHJcbiAgICBjb25zdCBzdGF0ZU1hY2hpbmVWYXJpYWJsZXMgPSBleHByZXNzaW9uLm1hdGNoKFNUQVRFX01BQ0hJTkVfUEFUVEVSTl9HKTtcclxuICAgIGlmIChzdGF0ZU1hY2hpbmVWYXJpYWJsZXMgPT09IG51bGwpIHtcclxuICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOaPkOWPluWQjui+ueeahOi3r+W+hFxyXG4gICAgY29uc3QgU1RBVEVfTUFDSElORV9QQVRURVJOID0gL1xce1NUQVRFTUFDSElORX4oXFxTKz8pXFx9LztcclxuICAgIHN0YXRlTWFjaGluZVZhcmlhYmxlcy5mb3JFYWNoKCBzZXNzaW9uVmFyaWFibGUgPT4gIHtcclxuICAgICAgY29uc3QgcGF0aE1hdGNoZXMgPSBzZXNzaW9uVmFyaWFibGUubWF0Y2goU1RBVEVfTUFDSElORV9QQVRURVJOKTtcclxuICAgICAgaWYgKHBhdGhNYXRjaGVzICE9IG51bGwgJiYgcGF0aE1hdGNoZXMubGVuZ3RoID09PSAyKSB7XHJcbiAgICAgICAgcGF0aHMucHVzaChwYXRoTWF0Y2hlc1sxXSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBwYXRocztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWvueW6lOeahOWAvFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0VmFsdWUocGF0aDogc3RyaW5nLCBjb250ZXh0OiBhbnkpOiBhbnkge1xyXG5cclxuICAgIGNvbnN0IHBhdGhPYmogPSB0aGlzLmdldFBhdGhPYmoocGF0aCk7XHJcbiAgICBjb25zdCBzdGF0ZU1hY2hpbmUgPSB0aGlzLmdldFRhcmdldFN0YXRlTWFjaGluZShwYXRoT2JqLmZyYW1lSWQsIGNvbnRleHQpO1xyXG5cclxuICAgIGlmIChwYXRoT2JqLnR5cGUgPT09ICdjdXJyZW50U3RhdGUnKSB7XHJcbiAgICAgIHJldHVybiBzdGF0ZU1hY2hpbmUuY29udGV4dC5zdGF0ZTtcclxuICAgIH0gZWxzZSBpZiAocGF0aE9iai50eXBlID09PSAncmVuZGVyU3RhdGVzJykge1xyXG4gICAgICByZXR1cm4gc3RhdGVNYWNoaW5lW3BhdGhPYmoubmFtZV0gYXMgYm9vbGVhbjtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihg5LiN5pSv57G75Z6L5Li6JHtwYXRoT2JqLnR5cGV955qE54q25oCB5py65Y+Y6YePYCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDop6PmnpBwYXRo77yM5bm26I635Y+W5a+55bqU55qEU3RhdGVNYWNoaW5l5a6e5L6LXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRUYXJnZXRTdGF0ZU1hY2hpbmUoZnJhbWVJZDogc3RyaW5nLCBjb250ZXh0KTogU3RhdGVNYWNoaW5lIHtcclxuICAgIGxldCB0YXJnZXRGcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dDtcclxuICAgIGlmIChmcmFtZUlkKSB7XHJcbiAgICAgIHRhcmdldEZyYW1lQ29udGV4dCA9IFBhcnNlVXRpbC5nZXRGcmFtZUNvbnRleHRCeUlkKGNvbnRleHQsIGZyYW1lSWQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGFyZ2V0RnJhbWVDb250ZXh0ID0gUGFyc2VVdGlsLmdldFJvb3RGcmFtZUNvbnRleHQoY29udGV4dCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCF0YXJnZXRGcmFtZUNvbnRleHQgfHwgIXRhcmdldEZyYW1lQ29udGV4dC5zdGF0ZU1hY2hpbmUpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCfmib7kuI3liLDlr7nlupTnmoTnirbmgIHmnLrlrp7kvovvvIzor7fmo4Dmn6XvvIEnKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0YXJnZXRGcmFtZUNvbnRleHQuc3RhdGVNYWNoaW5lO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bCGUGF0aOino+aekOS4uuagvOW8j+WMlueahFBhdGjlr7nosaFcclxuICAgKi9cclxuICBwcml2YXRlIGdldFBhdGhPYmoocGF0aDogc3RyaW5nKTogYW55IHtcclxuICAgIGxldCBwYXJzZWRQYXRoT2JqOiBhbnk7XHJcbiAgICBjb25zdCBwYXJ0cyA9IHRoaXMuc3BsaXRQYXRoKHBhdGgpO1xyXG5cclxuICAgIGlmIChwYXJ0c1swXSA9PT0gJ2N1cnJlbnRTdGF0ZScgfHwgcGFydHNbMF0gPT09ICdyZW5kZXJTdGF0ZXMnKSB7XHJcbiAgICAgIHBhcnNlZFBhdGhPYmogPSB7XHJcbiAgICAgICAgZnJhbWVJZDogJycsXHJcbiAgICAgICAgdHlwZTogcGFydHNbMF0sXHJcbiAgICAgICAgbmFtZTogcGFydHNbMV1cclxuICAgICAgfTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHBhcnNlZFBhdGhPYmogPSB7XHJcbiAgICAgICAgZnJhbWVJZDogcGFydHNbMF0sXHJcbiAgICAgICAgdHlwZTogcGFydHNbMV0sXHJcbiAgICAgICAgbmFtZTogcGFydHNbMl1cclxuICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcGFyc2VkUGF0aE9iajtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIhumalFBhdGhcclxuICAgKi9cclxuICBwcml2YXRlIHNwbGl0UGF0aChwYXRoOiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgICBjb25zdCBwYXJ0cyA9IHBhdGguc3BsaXQoJy8nKS5maWx0ZXIoKHBhcnQ6IHN0cmluZykgPT4ge1xyXG4gICAgICByZXR1cm4gcGFydCAhPT0gJyc7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBwYXJ0cztcclxuICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQgeyBTdGF0ZU1hY2hpbmVWYXJpYWJsZVBhcnNlciB9O1xyXG4iXX0=