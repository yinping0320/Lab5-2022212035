import { Injectable } from '@angular/core';
import { MetadataUtil } from '../metadata/index';
import { NG_COMMAND } from './decorators';
import { of, Subject, from, EMPTY } from 'rxjs';
import { concatMap, tap, every } from 'rxjs/operators';
/**
 * ViewModel是界面层访问应用层的入口。
 *
 * ### 定义ViewModel
 *
 * 定义ViewModel需要以下几个步骤：
 *
 * 1、定义的ViewModel需要继承ViewModel基类
 * 2、使用NgViewModel关联相关对象，比如：绑定数据（SinmpleDemoBindingData）、表单（SimpleDemoForm）、
 *    状态机（SimpleDemoStateMachine）等，但所有这些关联都是可选的，用不到或者自己单独实现时，不指定即可。
 * 3、同时我们需要传递一个injector给基类的构造函数，在ViewModel实例化时，会从injector获取NgViewModel声明的各个类型的实例。
 *
 * 下面我们来定义一个简单的ViewModel，代码如下：
 * ```ts
 * import { Injector, Injectable } from '@angular/core';
 * import { NgViewModel, ViewModel } from '@farris/devkit';
 *
 * @Injectable()
 * @NgViewModel({
 *   children: [],
 *   binding: SimpleDemoBindingData,
 *   form: SimpleDemoForm,
 *   stateMachine: SimpleDemoStateMachine,
 * })
 * class SimpleDemoViewModel extends ViewModel {
 *    constructor(injector: Injector) {
 *      super(injector);
 *    }
 *    @NgCommand({
 *      name: 'formLoad',
 *      params: {
 *        dataId: '1'
 *      }
 *    })
 *    public formLoad() {}
 * }
 * export { SimpleDemoViewModel };
 * ```
 *
 * 通过组件的构造函数，我们将ViewModel注入进组件
 * ```ts
 * @Component({
 *   selector: 'app-simple-demo',
 *   templateUrl: './simple-demo.component.html'
 * })
 * class SimpleDemoComponent implements OnInit {
 *
 *   public viewModel: SimpleDemoViewModel;
 *
 *   constructor(viewModel: SimpleDemoViewModel) {
 *     this.viewModel = viewModel;
 *   }
 * }
 * ```
 *
 * ### 组件模板中使用ViewModel
 *
 * 我们可以在模板中绑定NgViewModel中指定的 BindingData、Form、StateMachine的实例。
 * ```html
 * * <!--绑定数据-->
 * <p>{{viewModel.bindingData.name}}</p>
 *
 * <!--绑定表单-->
 * <form [formGroup]="viewModel.form">
 *   <input type="text" formControlName="name">
 * </form>
 *
 * <!--绑定状态机-->
 * <button type="button" [disabled]="!viewModel.stateMachine.canAdd">新增 </button>
 * * ```
 *
 * 我们在模板中绑定绑定viewModel的一个方法作为事件处理，这个方法可以是普通的方法，也可以是用NgCommand注解修饰过的。
 * ```html
 * <button type="button" (click)="viewModel.add()">新增 </button>
 * ```
 *
 * ### 组合的ViewModle
 *
 * 当界面比较复杂时，我们对界面按一定的粒度进行拆分，拆分出来的各个组成部分分别对应一个ViewModel，这样就形成了一个ViewModel树。
 * 我们在父的ViewModel的NgViewModel注解中通过在children属性中声明它的子ViewModel，将它们关联起来。
 * 假设我们有一个左列表右卡片的界面，我们可以为左列表、右卡片分别定义一个ViewModel，然后在页面的ViewModel中，将它们组合起来，
 * 代码如下：
 * ```ts
 * @Injectable()
 *  @NgViewModel({
 *  children: [LeftListViewModel, RightCardViewModel],
 *    binding: NestedDemoBindingData,
 * })
 * class NestedDemoViewModel extends ViewModel {
 *   constructor(injector: Injector) {
 *     super(injector);
 *   }
 * }
 * export { NestedDemoViewModel };
 * ```
 */
class ViewModel {
    /**
     * kendogrid option
     */
    // constructor(metadata?: IContextMetadata) {
    //   if (!this.bindingPath && metadata && metadata.bindingTo) {
    //     this.bindingPath = metadata.bindingTo;
    //   }
    // }
    constructor() {
        /**
         * 界面验证信息
         */
        this.verifyInformations = [];
        this.verifycationChanged = new Subject();
    }
    /**
     * 表达式服务
     */
    get expression() {
        return this.frameContext.expressionManager;
    }
    /**
     * 表达式结果
     */
    get expressionResult() {
        return this.frameContext.expressionResult;
    }
    ngOnDestroy() {
        this.dispose();
    }
    dispose(options) {
        // this.frameContext = null;
        // this.bindingData = null;
        // this.stateMachine = null;
        this.form = null;
        // this.uiState = null;
        if (this.entityValueChangingListeners) {
            this.entityValueChangingListeners.clear();
        }
        if (this.entityValueChangedListeners) {
            this.entityValueChangedListeners.clear();
        }
        if (this.verifycationChanged) {
            this.verifycationChanged.complete();
            this.verifycationChanged = null;
        }
    }
    setMetadata(metadata) {
        if (!this.bindingPath && metadata && metadata.bindingTo) {
            this.bindingPath = metadata.bindingTo;
        }
    }
    /**
     * 初始化
     */
    init(context) {
        if (!this.name) {
            this.name = context.metadata.viewModelCode || this.constructor.name;
        }
        this.frameContext = context;
        this.bindingData = context.bindingData;
        this.uiState = context.uiState;
        this.form = context.form;
        this.stateMachine = context.stateMachine;
        this.buildCommands(context);
        this.entityValueChangingListeners = new Map();
        this.entityValueChangedListeners = new Map();
        // 为bindingData赋值值变化监听器
        if (this.bindingData) {
            this.bindingData.setValueChangeInvokerFactory((paths) => {
                return (preValue, value, entityChanged, primaryValue) => {
                    const plainPath = '/' + paths.join('/');
                    let command;
                    if (entityChanged === false) {
                        command = this.entityValueChangingListeners[plainPath];
                    }
                    else {
                        command = this.entityValueChangedListeners[plainPath];
                    }
                    if (!!command) {
                        const change = {
                            paths: paths,
                            preValue: preValue,
                            value: value,
                            id: primaryValue,
                            changed: entityChanged
                        };
                        const triggerFlag = 'trigger:';
                        const commands = command.split(';').filter(p => p);
                        // 过滤出所有值变化前后事件
                        const valueChangeCommands = commands.filter(item => !item.startsWith(triggerFlag));
                        // 过滤出所有组件通讯
                        const triggers = commands.filter(item => item.startsWith(triggerFlag));
                        const squence = valueChangeCommands.concat(triggers);
                        let valueChangeSuccess = true;
                        return from(squence).pipe(concatMap(item => {
                            if (!valueChangeSuccess && entityChanged === false) {
                                return EMPTY;
                            }
                            if (item.startsWith(triggerFlag)) {
                                // 值变化前后事件绑定了组件通信
                                const eventName = item.substring(8);
                                this.frameContext.frameComponent.trigger(eventName);
                                valueChangeSuccess = true;
                                return of(true);
                            }
                            else {
                                return this[item](change).pipe(tap((result) => {
                                    valueChangeSuccess = result;
                                }));
                            }
                        }), every((result) => result));
                        // return this[command](change).pipe(map(result => {
                        //   return result === false ? false : true;
                        // }));
                    }
                    else {
                        return of(true);
                    }
                };
            });
        }
        this.initListeners();
    }
    /**
     * 绑定命令
     */
    buildCommands(context) {
        const ngCommands = context.metadata.commands || MetadataUtil.getPropsMetadatasByName(this.constructor, NG_COMMAND);
        this.metadatas = ngCommands;
        this.keybindingMap = new Map();
        Object.keys(ngCommands).forEach((propertyName) => {
            const ngCommand = ngCommands[propertyName];
            // 注册快捷键
            if (ngCommand.keyBinding) {
                this.keybindingMap.set(propertyName, ngCommand.keyBinding);
            }
            Object.defineProperty(this, propertyName, {
                value: (data) => {
                    if (context.isDisposed) {
                        return EMPTY;
                    }
                    // 获取命令处理上下文
                    let targetContext = context;
                    if (ngCommand.frameId) {
                        targetContext = context.appContext.getFrameContext(ngCommand.frameId);
                    }
                    const command = {
                        name: ngCommand.name,
                        params: ngCommand.params,
                        paramDescriptions: ngCommand.paramDescriptions,
                        eventParam: data || null
                    };
                    return targetContext.commandBus.dispatch(command);
                }
            });
        });
    }
    /**
     * 从Form获取监听器
     */
    initListeners() {
        const extractPath = (bindingBasePath, bindingPath) => {
            return '/' + bindingBasePath.split('/').concat(bindingPath.split('.')).filter((item) => item.length > 0).join('/');
        };
        if (this.form) {
            const valueChangingListeners = this.form.getEntityValueChangingListeners();
            Object.keys(valueChangingListeners).forEach((bindingPath) => {
                const plainPath = extractPath(this.bindingPath, bindingPath);
                this.entityValueChangingListeners[plainPath] = valueChangingListeners[bindingPath];
            });
            const valueChangedListeners = this.form.getEntityValueChangedListeners();
            Object.keys(valueChangedListeners).forEach((bindingPath) => {
                const plainPath = extractPath(this.bindingPath, bindingPath);
                this.entityValueChangedListeners[plainPath] = valueChangedListeners[bindingPath];
            });
        }
    }
    bindToParent(parent) {
        if (parent) {
            if (parent.verifycationChanged) {
                parent.verifycationChanged.subscribe(verifyInformations => {
                    if (this.verifycationChanged) {
                        this.verifycationChanged.next(verifyInformations);
                    }
                });
            }
        }
    }
    /**
     * 合并审批及表单表达式并计算结果
     * @param expression 表达式
     * @returns
     */
    transform(expression) {
        if (Array.isArray(expression)) {
            const wfConf = expression.find(item => item && item.source === 'wf');
            if (wfConf && wfConf.value) {
                return this.transform(wfConf.value);
            }
            else {
                return this.transform(expression[0]);
            }
        }
        else {
            if (typeof expression === 'boolean') {
                return expression;
            }
            else if (typeof expression === 'string') {
                return new Function('ctx', `return ${expression}`).apply(this.frameContext, [this]);
            }
            else {
                // 表达式result
                return expression;
            }
        }
    }
}
ViewModel.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ViewModel.ctorParameters = () => [];
export { ViewModel };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld19tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3ZpZXctbW9kZWwvdmlld19tb2RlbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUF1QixNQUFNLGVBQWUsQ0FBQztBQUNoRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFakQsT0FBTyxFQUFFLFVBQVUsRUFBeUIsTUFBTSxjQUFjLENBQUM7QUFNakUsT0FBTyxFQUFjLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1RCxPQUFPLEVBQU8sU0FBUyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQXFDLE1BQU0sZ0JBQWdCLENBQUM7QUFNL0Y7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBK0ZHO0FBQ0gsTUFDTSxTQUFTO0lBcUViOztPQUVHO0lBRUgsNkNBQTZDO0lBQzdDLCtEQUErRDtJQUMvRCw2Q0FBNkM7SUFDN0MsTUFBTTtJQUNOLElBQUk7SUFDSjtRQTlDQTs7V0FFRztRQUNJLHVCQUFrQixHQUFVLEVBQUUsQ0FBQztRQUUvQix3QkFBbUIsR0FBRyxJQUFJLE9BQU8sRUFBUyxDQUFDO0lBeUNsQyxDQUFDO0lBeENqQjs7T0FFRztJQUNILElBQVcsVUFBVTtRQUNuQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsaUJBQWlCLENBQUM7SUFDN0MsQ0FBQztJQUNEOztPQUVHO0lBQ0gsSUFBVyxnQkFBZ0I7UUFDekIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDO0lBQzVDLENBQUM7SUE4QkQsV0FBVztRQUNULElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNqQixDQUFD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UyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUNyQztpQkFBTTtnQkFDTCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDdEM7U0FDRjthQUFNO1lBQ0wsSUFBSSxPQUFPLFVBQVUsS0FBSyxTQUFTLEVBQUU7Z0JBQ25DLE9BQU8sVUFBVSxDQUFDO2FBQ25CO2lCQUFNLElBQUksT0FBTyxVQUFVLEtBQUssUUFBUSxFQUFFO2dCQUN6QyxPQUFPLElBQUksUUFBUSxDQUFDLEtBQUssRUFBRSxVQUFVLFVBQVUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2FBQ3JGO2lCQUFNO2dCQUNMLFlBQVk7Z0JBQ1osT0FBTyxVQUFVLENBQUM7YUFDbkI7U0FDRjtJQUNILENBQUM7OztZQXpSRixVQUFVOzs7O0FBNFJYLE9BQU8sRUFBRSxTQUFTLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yLCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTWV0YWRhdGFVdGlsIH0gZnJvbSAnLi4vbWV0YWRhdGEvaW5kZXgnO1xyXG5pbXBvcnQgeyBDb21tYW5kIH0gZnJvbSAnLi4vY29tbWFuZC9pbmRleCc7XHJcbmltcG9ydCB7IE5HX0NPTU1BTkQsIE5nQ29tbWFuZCwgS2V5YmluZGluZyB9IGZyb20gJy4vZGVjb3JhdG9ycyc7XHJcbmltcG9ydCB7IEJpbmRpbmdEYXRhLCBFbnRpdHlWYWx1ZUNoYW5nZSB9IGZyb20gJy4uL2JpbmRpbmctZGF0YS9pbmRleCc7XHJcbmltcG9ydCB7IFVJU3RhdGUgfSBmcm9tICcuLi91aS1zdGF0ZS9pbmRleCc7XHJcbmltcG9ydCB7IEZvcm0gfSBmcm9tICcuLi9mb3JtL2luZGV4JztcclxuaW1wb3J0IHsgU3RhdGVNYWNoaW5lIH0gZnJvbSAnLi4vc3RhdGUtbWFjaGluZS9pbmRleCc7XHJcbmltcG9ydCB7IEZyYW1lQ29udGV4dCB9IGZyb20gJy4uL2ZyYW1lL2luZGV4JztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QsIGZyb20sIEVNUFRZIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IG1hcCwgY29uY2F0TWFwLCB0YXAsIGV2ZXJ5LCBkZWJvdW5jZVRpbWUsIHN3aXRjaE1hcCwgdGFrZUxhc3QgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEV4cHJlc3Npb25NYW5hZ2VyLCBFeHByZXNzaW9uUmVzdWx0IH0gZnJvbSAnLi4vZXhwcmVzc2lvbi9pbmRleCc7XHJcbmltcG9ydCB7IElDb250ZXh0TWV0YWRhdGEgfSBmcm9tICcuLi9hcHAvYXBwX21ldGFkYXRhJztcclxuaW1wb3J0IHsgSW52b2tlT25WYWx1ZUNoYW5nZSB9IGZyb20gJy4uL2JpbmRpbmctZGF0YS90eXBlcyc7XHJcbmltcG9ydCB7IElEaXNwb3NhYmxlIH0gZnJvbSAnLi4vY29yZS9pbmRleCc7XHJcblxyXG4vKipcclxuICogVmlld01vZGVs5piv55WM6Z2i5bGC6K6/6Zeu5bqU55So5bGC55qE5YWl5Y+j44CCXHJcbiAqXHJcbiAqICMjIyDlrprkuYlWaWV3TW9kZWxcclxuICpcclxuICog5a6a5LmJVmlld01vZGVs6ZyA6KaB5Lul5LiL5Yeg5Liq5q2l6aqk77yaXHJcbiAqXHJcbiAqIDHjgIHlrprkuYnnmoRWaWV3TW9kZWzpnIDopoHnu6fmib9WaWV3TW9kZWzln7rnsbtcclxuICogMuOAgeS9v+eUqE5nVmlld01vZGVs5YWz6IGU55u45YWz5a+56LGh77yM5q+U5aaC77ya57uR5a6a5pWw5o2u77yIU2lubXBsZURlbW9CaW5kaW5nRGF0Ye+8ieOAgeihqOWNle+8iFNpbXBsZURlbW9Gb3Jt77yJ44CBXHJcbiAqICAgIOeKtuaAgeacuu+8iFNpbXBsZURlbW9TdGF0ZU1hY2hpbmXvvInnrYnvvIzkvYbmiYDmnInov5nkupvlhbPogZTpg73mmK/lj6/pgInnmoTvvIznlKjkuI3liLDmiJbogIXoh6rlt7HljZXni6zlrp7njrDml7bvvIzkuI3mjIflrprljbPlj6/jgIJcclxuICogM+OAgeWQjOaXtuaIkeS7rOmcgOimgeS8oOmAkuS4gOS4qmluamVjdG9y57uZ5Z+657G755qE5p6E6YCg5Ye95pWw77yM5ZyoVmlld01vZGVs5a6e5L6L5YyW5pe277yM5Lya5LuOaW5qZWN0b3Lojrflj5ZOZ1ZpZXdNb2RlbOWjsOaYjueahOWQhOS4quexu+Wei+eahOWunuS+i+OAglxyXG4gKlxyXG4gKiDkuIvpnaLmiJHku6zmnaXlrprkuYnkuIDkuKrnroDljZXnmoRWaWV3TW9kZWzvvIzku6PnoIHlpoLkuIvvvJpcclxuICogYGBgdHNcclxuICogaW1wb3J0IHsgSW5qZWN0b3IsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuICogaW1wb3J0IHsgTmdWaWV3TW9kZWwsIFZpZXdNb2RlbCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuICpcclxuICogQEluamVjdGFibGUoKVxyXG4gKiBATmdWaWV3TW9kZWwoe1xyXG4gKiAgIGNoaWxkcmVuOiBbXSxcclxuICogICBiaW5kaW5nOiBTaW1wbGVEZW1vQmluZGluZ0RhdGEsXHJcbiAqICAgZm9ybTogU2ltcGxlRGVtb0Zvcm0sXHJcbiAqICAgc3RhdGVNYWNoaW5lOiBTaW1wbGVEZW1vU3RhdGVNYWNoaW5lLFxyXG4gKiB9KVxyXG4gKiBjbGFzcyBTaW1wbGVEZW1vVmlld01vZGVsIGV4dGVuZHMgVmlld01vZGVsIHtcclxuICogICAgY29uc3RydWN0b3IoaW5qZWN0b3I6IEluamVjdG9yKSB7XHJcbiAqICAgICAgc3VwZXIoaW5qZWN0b3IpO1xyXG4gKiAgICB9XHJcbiAqICAgIEBOZ0NvbW1hbmQoe1xyXG4gKiAgICAgIG5hbWU6ICdmb3JtTG9hZCcsXHJcbiAqICAgICAgcGFyYW1zOiB7XHJcbiAqICAgICAgICBkYXRhSWQ6ICcxJ1xyXG4gKiAgICAgIH1cclxuICogICAgfSlcclxuICogICAgcHVibGljIGZvcm1Mb2FkKCkge31cclxuICogfVxyXG4gKiBleHBvcnQgeyBTaW1wbGVEZW1vVmlld01vZGVsIH07XHJcbiAqIGBgYFxyXG4gKlxyXG4gKiDpgJrov4fnu4Tku7bnmoTmnoTpgKDlh73mlbDvvIzmiJHku6zlsIZWaWV3TW9kZWzms6jlhaXov5vnu4Tku7ZcclxuICogYGBgdHNcclxuICogQENvbXBvbmVudCh7XHJcbiAqICAgc2VsZWN0b3I6ICdhcHAtc2ltcGxlLWRlbW8nLFxyXG4gKiAgIHRlbXBsYXRlVXJsOiAnLi9zaW1wbGUtZGVtby5jb21wb25lbnQuaHRtbCdcclxuICogfSlcclxuICogY2xhc3MgU2ltcGxlRGVtb0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcbiAqXHJcbiAqICAgcHVibGljIHZpZXdNb2RlbDogU2ltcGxlRGVtb1ZpZXdNb2RlbDtcclxuICpcclxuICogICBjb25zdHJ1Y3Rvcih2aWV3TW9kZWw6IFNpbXBsZURlbW9WaWV3TW9kZWwpIHtcclxuICogICAgIHRoaXMudmlld01vZGVsID0gdmlld01vZGVsO1xyXG4gKiAgIH1cclxuICogfVxyXG4gKiBgYGBcclxuICpcclxuICogIyMjIOe7hOS7tuaooeadv+S4reS9v+eUqFZpZXdNb2RlbFxyXG4gKlxyXG4gKiDmiJHku6zlj6/ku6XlnKjmqKHmnb/kuK3nu5HlrppOZ1ZpZXdNb2RlbOS4reaMh+WumueahCBCaW5kaW5nRGF0YeOAgUZvcm3jgIFTdGF0ZU1hY2hpbmXnmoTlrp7kvovjgIJcclxuICogYGBgaHRtbFxyXG4gKiAqIDwhLS3nu5HlrprmlbDmja4tLT5cclxuICogPHA+e3t2aWV3TW9kZWwuYmluZGluZ0RhdGEubmFtZX19PC9wPlxyXG4gKlxyXG4gKiA8IS0t57uR5a6a6KGo5Y2VLS0+XHJcbiAqIDxmb3JtIFtmb3JtR3JvdXBdPVwidmlld01vZGVsLmZvcm1cIj5cclxuICogICA8aW5wdXQgdHlwZT1cInRleHRcIiBmb3JtQ29udHJvbE5hbWU9XCJuYW1lXCI+XHJcbiAqIDwvZm9ybT5cclxuICpcclxuICogPCEtLee7keWumueKtuaAgeacui0tPlxyXG4gKiA8YnV0dG9uIHR5cGU9XCJidXR0b25cIiBbZGlzYWJsZWRdPVwiIXZpZXdNb2RlbC5zdGF0ZU1hY2hpbmUuY2FuQWRkXCI+5paw5aKeIDwvYnV0dG9uPlxyXG4gKiAqIGBgYFxyXG4gKlxyXG4gKiDmiJHku6zlnKjmqKHmnb/kuK3nu5Hlrprnu5Hlrpp2aWV3TW9kZWznmoTkuIDkuKrmlrnms5XkvZzkuLrkuovku7blpITnkIbvvIzov5nkuKrmlrnms5Xlj6/ku6XmmK/mma7pgJrnmoTmlrnms5XvvIzkuZ/lj6/ku6XmmK/nlKhOZ0NvbW1hbmTms6jop6Pkv67ppbDov4fnmoTjgIJcclxuICogYGBgaHRtbFxyXG4gKiA8YnV0dG9uIHR5cGU9XCJidXR0b25cIiAoY2xpY2spPVwidmlld01vZGVsLmFkZCgpXCI+5paw5aKeIDwvYnV0dG9uPlxyXG4gKiBgYGBcclxuICpcclxuICogIyMjIOe7hOWQiOeahFZpZXdNb2RsZVxyXG4gKlxyXG4gKiDlvZPnlYzpnaLmr5TovoPlpI3mnYLml7bvvIzmiJHku6zlr7nnlYzpnaLmjInkuIDlrprnmoTnspLluqbov5vooYzmi4bliIbvvIzmi4bliIblh7rmnaXnmoTlkITkuKrnu4TmiJDpg6jliIbliIbliKvlr7nlupTkuIDkuKpWaWV3TW9kZWzvvIzov5nmoLflsLHlvaLmiJDkuobkuIDkuKpWaWV3TW9kZWzmoJHjgIJcclxuICog5oiR5Lus5Zyo54i255qEVmlld01vZGVs55qETmdWaWV3TW9kZWzms6jop6PkuK3pgJrov4flnKhjaGlsZHJlbuWxnuaAp+S4reWjsOaYjuWug+eahOWtkFZpZXdNb2RlbO+8jOWwhuWug+S7rOWFs+iBlOi1t+adpeOAglxyXG4gKiDlgYforr7miJHku6zmnInkuIDkuKrlt6bliJfooajlj7PljaHniYfnmoTnlYzpnaLvvIzmiJHku6zlj6/ku6XkuLrlt6bliJfooajjgIHlj7PljaHniYfliIbliKvlrprkuYnkuIDkuKpWaWV3TW9kZWzvvIznhLblkI7lnKjpobXpnaLnmoRWaWV3TW9kZWzkuK3vvIzlsIblroPku6znu4TlkIjotbfmnaXvvIxcclxuICog5Luj56CB5aaC5LiL77yaXHJcbiAqIGBgYHRzXHJcbiAqIEBJbmplY3RhYmxlKClcclxuICogIEBOZ1ZpZXdNb2RlbCh7XHJcbiAqICBjaGlsZHJlbjogW0xlZnRMaXN0Vmlld01vZGVsLCBSaWdodENhcmRWaWV3TW9kZWxdLFxyXG4gKiAgICBiaW5kaW5nOiBOZXN0ZWREZW1vQmluZGluZ0RhdGEsXHJcbiAqIH0pXHJcbiAqIGNsYXNzIE5lc3RlZERlbW9WaWV3TW9kZWwgZXh0ZW5kcyBWaWV3TW9kZWwge1xyXG4gKiAgIGNvbnN0cnVjdG9yKGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gKiAgICAgc3VwZXIoaW5qZWN0b3IpO1xyXG4gKiAgIH1cclxuICogfVxyXG4gKiBleHBvcnQgeyBOZXN0ZWREZW1vVmlld01vZGVsIH07XHJcbiAqIGBgYFxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5jbGFzcyBWaWV3TW9kZWwgaW1wbGVtZW50cyBJRGlzcG9zYWJsZSwgT25EZXN0cm95IHtcclxuXHJcbiAgcHVibGljIG5hbWU6IHN0cmluZztcclxuXHJcbiAgcHVibGljIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0O1xyXG5cclxuICAvKipcclxuICAgKiDnu5HlrprmlbDmja5cclxuICAgKi9cclxuICBwdWJsaWMgYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhO1xyXG5cclxuICAvKipcclxuICAgKiDnu5Hlrprot6/lvoRcclxuICAgKiDlvaLlpoLvvJovKOagueWunuS9kynvvIwvZWR1c++8iOS7juihqO+8ie+8jC9lZHVzL2dyYWRlc++8iOS7juS7juihqO+8iVxyXG4gICAqL1xyXG4gIHB1YmxpYyBiaW5kaW5nUGF0aDogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiDnlYzpnaLnirbmgIFcclxuICAgKi9cclxuICBwdWJsaWMgdWlTdGF0ZTogVUlTdGF0ZTtcclxuXHJcbiAgLyoqXHJcbiAgICog6KGo5Y2V5a6a5LmJXHJcbiAgICovXHJcbiAgcHVibGljIGZvcm06IEZvcm07XHJcblxyXG4gIC8qKlxyXG4gICAqIOeKtuaAgeaculxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGF0ZU1hY2hpbmU6IFN0YXRlTWFjaGluZTtcclxuXHJcbiAgLyoqXHJcbiAgICog55WM6Z2i6aqM6K+B5L+h5oGvXHJcbiAgICovXHJcbiAgcHVibGljIHZlcmlmeUluZm9ybWF0aW9uczogYW55W10gPSBbXTtcclxuXHJcbiAgcHVibGljIHZlcmlmeWNhdGlvbkNoYW5nZWQgPSBuZXcgU3ViamVjdDxhbnlbXT4oKTtcclxuICAvKipcclxuICAgKiDooajovr7lvI/mnI3liqFcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0IGV4cHJlc3Npb24oKTogRXhwcmVzc2lvbk1hbmFnZXIge1xyXG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0LmV4cHJlc3Npb25NYW5hZ2VyO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDooajovr7lvI/nu5PmnpxcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0IGV4cHJlc3Npb25SZXN1bHQoKTogRXhwcmVzc2lvblJlc3VsdCB7XHJcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQuZXhwcmVzc2lvblJlc3VsdDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5b+r5o236ZSu5pig5bCEXHJcbiAgICovXHJcbiAgcHVibGljIGtleWJpbmRpbmdNYXA6IE1hcDxzdHJpbmcsIEtleWJpbmRpbmc+O1xyXG5cclxuICAvKipcclxuICAgKiDlgLzlj5jljJbliY3nm5HlkKzlmahcclxuICAgKi9cclxuICBwcml2YXRlIGVudGl0eVZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnM6IE1hcDxzdHJpbmcsIHN0cmluZz47XHJcblxyXG4gIC8qKlxyXG4gICAqIOWAvOWPmOWMluWQjuebkeWQrOWZqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzOiBNYXA8c3RyaW5nLCBzdHJpbmc+O1xyXG4gIC8qKlxyXG4gICAqIOWFg+aVsOaNrlxyXG4gICAqL1xyXG4gIHB1YmxpYyBtZXRhZGF0YXM6IHsgW3Byb3BOYW1lOiBzdHJpbmddOiBOZ0NvbW1hbmQgfTtcclxuXHJcbiAgLyoqXHJcbiAgICoga2VuZG9ncmlkIG9wdGlvblxyXG4gICAqL1xyXG5cclxuICAvLyBjb25zdHJ1Y3RvcihtZXRhZGF0YT86IElDb250ZXh0TWV0YWRhdGEpIHtcclxuICAvLyAgIGlmICghdGhpcy5iaW5kaW5nUGF0aCAmJiBtZXRhZGF0YSAmJiBtZXRhZGF0YS5iaW5kaW5nVG8pIHtcclxuICAvLyAgICAgdGhpcy5iaW5kaW5nUGF0aCA9IG1ldGFkYXRhLmJpbmRpbmdUbztcclxuICAvLyAgIH1cclxuICAvLyB9XHJcbiAgY29uc3RydWN0b3IoKSB7IH1cclxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZGlzcG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgZGlzcG9zZShvcHRpb25zPzogYW55KSB7XHJcbiAgICAvLyB0aGlzLmZyYW1lQ29udGV4dCA9IG51bGw7XHJcbiAgICAvLyB0aGlzLmJpbmRpbmdEYXRhID0gbnVsbDtcclxuICAgIC8vIHRoaXMuc3RhdGVNYWNoaW5lID0gbnVsbDtcclxuICAgIHRoaXMuZm9ybSA9IG51bGw7XHJcbiAgICAvLyB0aGlzLnVpU3RhdGUgPSBudWxsO1xyXG5cclxuICAgIGlmICh0aGlzLmVudGl0eVZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnMpIHtcclxuICAgICAgdGhpcy5lbnRpdHlWYWx1ZUNoYW5naW5nTGlzdGVuZXJzLmNsZWFyKCk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5lbnRpdHlWYWx1ZUNoYW5nZWRMaXN0ZW5lcnMpIHtcclxuICAgICAgdGhpcy5lbnRpdHlWYWx1ZUNoYW5nZWRMaXN0ZW5lcnMuY2xlYXIoKTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLnZlcmlmeWNhdGlvbkNoYW5nZWQpIHtcclxuICAgICAgdGhpcy52ZXJpZnljYXRpb25DaGFuZ2VkLmNvbXBsZXRlKCk7XHJcbiAgICAgIHRoaXMudmVyaWZ5Y2F0aW9uQ2hhbmdlZCA9IG51bGw7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2V0TWV0YWRhdGEobWV0YWRhdGE6IElDb250ZXh0TWV0YWRhdGEpIHtcclxuICAgIGlmICghdGhpcy5iaW5kaW5nUGF0aCAmJiBtZXRhZGF0YSAmJiBtZXRhZGF0YS5iaW5kaW5nVG8pIHtcclxuICAgICAgdGhpcy5iaW5kaW5nUGF0aCA9IG1ldGFkYXRhLmJpbmRpbmdUbztcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yid5aeL5YyWXHJcbiAgICovXHJcbiAgcHVibGljIGluaXQoY29udGV4dDogRnJhbWVDb250ZXh0KSB7XHJcbiAgICBpZiAoIXRoaXMubmFtZSkge1xyXG4gICAgICB0aGlzLm5hbWUgPSBjb250ZXh0Lm1ldGFkYXRhLnZpZXdNb2RlbENvZGUgfHwgdGhpcy5jb25zdHJ1Y3Rvci5uYW1lO1xyXG4gICAgfVxyXG4gICAgdGhpcy5mcmFtZUNvbnRleHQgPSBjb250ZXh0O1xyXG4gICAgdGhpcy5iaW5kaW5nRGF0YSA9IGNvbnRleHQuYmluZGluZ0RhdGE7XHJcbiAgICB0aGlzLnVpU3RhdGUgPSBjb250ZXh0LnVpU3RhdGU7XHJcbiAgICB0aGlzLmZvcm0gPSBjb250ZXh0LmZvcm07XHJcbiAgICB0aGlzLnN0YXRlTWFjaGluZSA9IGNvbnRleHQuc3RhdGVNYWNoaW5lO1xyXG4gICAgdGhpcy5idWlsZENvbW1hbmRzKGNvbnRleHQpO1xyXG4gICAgdGhpcy5lbnRpdHlWYWx1ZUNoYW5naW5nTGlzdGVuZXJzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcclxuICAgIHRoaXMuZW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcclxuICAgIC8vIOS4umJpbmRpbmdEYXRh6LWL5YC85YC85Y+Y5YyW55uR5ZCs5ZmoXHJcbiAgICBpZiAodGhpcy5iaW5kaW5nRGF0YSkge1xyXG4gICAgICB0aGlzLmJpbmRpbmdEYXRhLnNldFZhbHVlQ2hhbmdlSW52b2tlckZhY3RvcnkoKHBhdGhzOiBzdHJpbmdbXSk6IEludm9rZU9uVmFsdWVDaGFuZ2UgPT4ge1xyXG4gICAgICAgIHJldHVybiAocHJlVmFsdWUsIHZhbHVlLCBlbnRpdHlDaGFuZ2VkOiBib29sZWFuLCBwcmltYXJ5VmFsdWU/OiBhbnkpOiBPYnNlcnZhYmxlPGJvb2xlYW4+ID0+IHtcclxuICAgICAgICAgIGNvbnN0IHBsYWluUGF0aCA9ICcvJyArIHBhdGhzLmpvaW4oJy8nKTtcclxuICAgICAgICAgIGxldCBjb21tYW5kOiBzdHJpbmc7XHJcbiAgICAgICAgICBpZiAoZW50aXR5Q2hhbmdlZCA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgY29tbWFuZCA9IHRoaXMuZW50aXR5VmFsdWVDaGFuZ2luZ0xpc3RlbmVyc1twbGFpblBhdGhdO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29tbWFuZCA9IHRoaXMuZW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzW3BsYWluUGF0aF07XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgaWYgKCEhY29tbWFuZCkge1xyXG4gICAgICAgICAgICBjb25zdCBjaGFuZ2U6IEVudGl0eVZhbHVlQ2hhbmdlID0ge1xyXG4gICAgICAgICAgICAgIHBhdGhzOiBwYXRocyxcclxuICAgICAgICAgICAgICBwcmVWYWx1ZTogcHJlVmFsdWUsXHJcbiAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLFxyXG4gICAgICAgICAgICAgIGlkOiBwcmltYXJ5VmFsdWUsXHJcbiAgICAgICAgICAgICAgY2hhbmdlZDogZW50aXR5Q2hhbmdlZFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjb25zdCB0cmlnZ2VyRmxhZyA9ICd0cmlnZ2VyOic7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbW1hbmRzID0gY29tbWFuZC5zcGxpdCgnOycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgICAgICAgICAvLyDov4fmu6Tlh7rmiYDmnInlgLzlj5jljJbliY3lkI7kuovku7ZcclxuICAgICAgICAgICAgY29uc3QgdmFsdWVDaGFuZ2VDb21tYW5kcyA9IGNvbW1hbmRzLmZpbHRlcihpdGVtID0+ICFpdGVtLnN0YXJ0c1dpdGgodHJpZ2dlckZsYWcpKTtcclxuICAgICAgICAgICAgLy8g6L+H5ruk5Ye65omA5pyJ57uE5Lu26YCa6K6vXHJcbiAgICAgICAgICAgIGNvbnN0IHRyaWdnZXJzID0gY29tbWFuZHMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5zdGFydHNXaXRoKHRyaWdnZXJGbGFnKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHNxdWVuY2UgPSB2YWx1ZUNoYW5nZUNvbW1hbmRzLmNvbmNhdCh0cmlnZ2Vycyk7XHJcbiAgICAgICAgICAgIGxldCB2YWx1ZUNoYW5nZVN1Y2Nlc3MgPSB0cnVlO1xyXG4gICAgICAgICAgICByZXR1cm4gZnJvbShzcXVlbmNlKS5waXBlKFxyXG4gICAgICAgICAgICAgIGNvbmNhdE1hcChpdGVtID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICghdmFsdWVDaGFuZ2VTdWNjZXNzICYmIGVudGl0eUNoYW5nZWQgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChpdGVtLnN0YXJ0c1dpdGgodHJpZ2dlckZsYWcpKSB7XHJcbiAgICAgICAgICAgICAgICAgIC8vIOWAvOWPmOWMluWJjeWQjuS6i+S7tue7keWumuS6hue7hOS7tumAmuS/oVxyXG4gICAgICAgICAgICAgICAgICBjb25zdCBldmVudE5hbWUgPSBpdGVtLnN1YnN0cmluZyg4KTtcclxuICAgICAgICAgICAgICAgICAgdGhpcy5mcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnQudHJpZ2dlcihldmVudE5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICB2YWx1ZUNoYW5nZVN1Y2Nlc3MgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1tpdGVtXShjaGFuZ2UpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgdGFwKChyZXN1bHQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgdmFsdWVDaGFuZ2VTdWNjZXNzID0gcmVzdWx0O1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgIGV2ZXJ5KChyZXN1bHQ6IGFueSkgPT4gcmVzdWx0KVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAvLyByZXR1cm4gdGhpc1tjb21tYW5kXShjaGFuZ2UpLnBpcGUobWFwKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICAgIC8vICAgcmV0dXJuIHJlc3VsdCA9PT0gZmFsc2UgPyBmYWxzZSA6IHRydWU7XHJcbiAgICAgICAgICAgIC8vIH0pKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5pbml0TGlzdGVuZXJzKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDnu5Hlrprlkb3ku6RcclxuICAgKi9cclxuICBwdWJsaWMgYnVpbGRDb21tYW5kcyhjb250ZXh0OiBGcmFtZUNvbnRleHQpIHtcclxuICAgIGNvbnN0IG5nQ29tbWFuZHM6IHtcclxuICAgICAgW2NvbW1hbmROYW1lOiBzdHJpbmddOiBOZ0NvbW1hbmRcclxuICAgIH0gPSBjb250ZXh0Lm1ldGFkYXRhLmNvbW1hbmRzIHx8IE1ldGFkYXRhVXRpbC5nZXRQcm9wc01ldGFkYXRhc0J5TmFtZSh0aGlzLmNvbnN0cnVjdG9yLCBOR19DT01NQU5EKTtcclxuICAgIHRoaXMubWV0YWRhdGFzID0gbmdDb21tYW5kcztcclxuICAgIHRoaXMua2V5YmluZGluZ01hcCA9IG5ldyBNYXA8c3RyaW5nLCBLZXliaW5kaW5nPigpO1xyXG4gICAgT2JqZWN0LmtleXMobmdDb21tYW5kcykuZm9yRWFjaCgocHJvcGVydHlOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgY29uc3QgbmdDb21tYW5kOiBOZ0NvbW1hbmQgPSBuZ0NvbW1hbmRzW3Byb3BlcnR5TmFtZV07XHJcbiAgICAgIC8vIOazqOWGjOW/q+aNt+mUrlxyXG4gICAgICBpZiAobmdDb21tYW5kLmtleUJpbmRpbmcpIHtcclxuICAgICAgICB0aGlzLmtleWJpbmRpbmdNYXAuc2V0KHByb3BlcnR5TmFtZSwgbmdDb21tYW5kLmtleUJpbmRpbmcpO1xyXG4gICAgICB9XHJcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgICAgICB2YWx1ZTogKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgaWYgKGNvbnRleHQuaXNEaXNwb3NlZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyDojrflj5blkb3ku6TlpITnkIbkuIrkuIvmlodcclxuICAgICAgICAgIGxldCB0YXJnZXRDb250ZXh0ID0gY29udGV4dDtcclxuICAgICAgICAgIGlmIChuZ0NvbW1hbmQuZnJhbWVJZCkge1xyXG4gICAgICAgICAgICB0YXJnZXRDb250ZXh0ID0gY29udGV4dC5hcHBDb250ZXh0LmdldEZyYW1lQ29udGV4dChuZ0NvbW1hbmQuZnJhbWVJZCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjb25zdCBjb21tYW5kOiBDb21tYW5kID0ge1xyXG4gICAgICAgICAgICBuYW1lOiBuZ0NvbW1hbmQubmFtZSxcclxuICAgICAgICAgICAgcGFyYW1zOiBuZ0NvbW1hbmQucGFyYW1zLFxyXG4gICAgICAgICAgICBwYXJhbURlc2NyaXB0aW9uczogbmdDb21tYW5kLnBhcmFtRGVzY3JpcHRpb25zLFxyXG4gICAgICAgICAgICBldmVudFBhcmFtOiBkYXRhIHx8IG51bGxcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICByZXR1cm4gdGFyZ2V0Q29udGV4dC5jb21tYW5kQnVzLmRpc3BhdGNoKGNvbW1hbmQpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOS7jkZvcm3ojrflj5bnm5HlkKzlmahcclxuICAgKi9cclxuICBwcml2YXRlIGluaXRMaXN0ZW5lcnMoKSB7XHJcbiAgICBjb25zdCBleHRyYWN0UGF0aCA9IChiaW5kaW5nQmFzZVBhdGg6IHN0cmluZywgYmluZGluZ1BhdGg6IHN0cmluZyk6IHN0cmluZyA9PiB7XHJcbiAgICAgIHJldHVybiAnLycgKyBiaW5kaW5nQmFzZVBhdGguc3BsaXQoJy8nKS5jb25jYXQoYmluZGluZ1BhdGguc3BsaXQoJy4nKSkuZmlsdGVyKChpdGVtKSA9PiBpdGVtLmxlbmd0aCA+IDApLmpvaW4oJy8nKTtcclxuICAgIH07XHJcblxyXG4gICAgaWYgKHRoaXMuZm9ybSkge1xyXG4gICAgICBjb25zdCB2YWx1ZUNoYW5naW5nTGlzdGVuZXJzID0gdGhpcy5mb3JtLmdldEVudGl0eVZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnMoKTtcclxuICAgICAgT2JqZWN0LmtleXModmFsdWVDaGFuZ2luZ0xpc3RlbmVycykuZm9yRWFjaCgoYmluZGluZ1BhdGgpID0+IHtcclxuICAgICAgICBjb25zdCBwbGFpblBhdGggPSBleHRyYWN0UGF0aCh0aGlzLmJpbmRpbmdQYXRoLCBiaW5kaW5nUGF0aCk7XHJcbiAgICAgICAgdGhpcy5lbnRpdHlWYWx1ZUNoYW5naW5nTGlzdGVuZXJzW3BsYWluUGF0aF0gPSB2YWx1ZUNoYW5naW5nTGlzdGVuZXJzW2JpbmRpbmdQYXRoXTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCB2YWx1ZUNoYW5nZWRMaXN0ZW5lcnMgPSB0aGlzLmZvcm0uZ2V0RW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzKCk7XHJcbiAgICAgIE9iamVjdC5rZXlzKHZhbHVlQ2hhbmdlZExpc3RlbmVycykuZm9yRWFjaCgoYmluZGluZ1BhdGgpID0+IHtcclxuICAgICAgICBjb25zdCBwbGFpblBhdGggPSBleHRyYWN0UGF0aCh0aGlzLmJpbmRpbmdQYXRoLCBiaW5kaW5nUGF0aCk7XHJcbiAgICAgICAgdGhpcy5lbnRpdHlWYWx1ZUNoYW5nZWRMaXN0ZW5lcnNbcGxhaW5QYXRoXSA9IHZhbHVlQ2hhbmdlZExpc3RlbmVyc1tiaW5kaW5nUGF0aF07XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGJpbmRUb1BhcmVudChwYXJlbnQ6IFZpZXdNb2RlbCkge1xyXG4gICAgaWYgKHBhcmVudCkge1xyXG4gICAgICBpZiAocGFyZW50LnZlcmlmeWNhdGlvbkNoYW5nZWQpIHtcclxuICAgICAgICBwYXJlbnQudmVyaWZ5Y2F0aW9uQ2hhbmdlZC5zdWJzY3JpYmUodmVyaWZ5SW5mb3JtYXRpb25zID0+IHtcclxuICAgICAgICAgIGlmICh0aGlzLnZlcmlmeWNhdGlvbkNoYW5nZWQpIHtcclxuICAgICAgICAgICAgdGhpcy52ZXJpZnljYXRpb25DaGFuZ2VkLm5leHQodmVyaWZ5SW5mb3JtYXRpb25zKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDlkIjlubblrqHmibnlj4rooajljZXooajovr7lvI/lubborqHnrpfnu5PmnpxcclxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbiDooajovr7lvI9cclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgdHJhbnNmb3JtKGV4cHJlc3Npb246IHN0cmluZyB8IGJvb2xlYW4gfCBBcnJheTxhbnk+KTogYW55IHtcclxuICAgIGlmIChBcnJheS5pc0FycmF5KGV4cHJlc3Npb24pKSB7XHJcbiAgICAgIGNvbnN0IHdmQ29uZiA9IGV4cHJlc3Npb24uZmluZChpdGVtID0+IGl0ZW0gJiYgaXRlbS5zb3VyY2UgPT09ICd3ZicpO1xyXG4gICAgICBpZiAod2ZDb25mICYmIHdmQ29uZi52YWx1ZSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnRyYW5zZm9ybSh3ZkNvbmYudmFsdWUpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnRyYW5zZm9ybShleHByZXNzaW9uWzBdKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaWYgKHR5cGVvZiBleHByZXNzaW9uID09PSAnYm9vbGVhbicpIHtcclxuICAgICAgICByZXR1cm4gZXhwcmVzc2lvbjtcclxuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZXhwcmVzc2lvbiA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCdjdHgnLCBgcmV0dXJuICR7ZXhwcmVzc2lvbn1gKS5hcHBseSh0aGlzLmZyYW1lQ29udGV4dCwgW3RoaXNdKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyDooajovr7lvI9yZXN1bHRcclxuICAgICAgICByZXR1cm4gZXhwcmVzc2lvbjtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgVmlld01vZGVsIH07XHJcbiJdfQ==