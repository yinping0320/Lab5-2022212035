/*
 * @Author: Witt
 * @Date: 2019-03-12 14:59:22
 * @Last Modified by: aalizzwell
 * @Last Modified time: 2019-06-15 17:26:07
 */
import { Injector, Injectable, ChangeDetectorRef } from '@angular/core';
import { FrameContext } from './frame_context';
import { Subscription, Declaration } from '../event-mechanism/index';
import { FRAME_COMPONENT_INIT_HANDLER_TOKEN } from './tokens';
import { Subject } from 'rxjs';
class FrameComponent {
    /**
     * 框架构造函数
     * @param injector 注入器
     */
    constructor(injector) {
        this.injector = injector;
        this.initialized = false;
        this.context = this.injector.get(FrameContext, null);
        if (this.context) {
            this.initialize();
        }
        this.destorySignal = new Subject();
        // this.context.init(this);
        // this.viewModel = this.context.viewModel;
        // this.cd = this.getChangeDetectorRef();
        // // 必须先执行context的初始化，然后再初始化Subscription
        // this.initPublicEvent();
        // this.initSubscription();
        // this.restComponent();
    }
    /**
     * 是否为表格组件
     * @description 返回true/false时可以信任，但如果返回的是undefined则不应信任
     * @warning 该属性依赖了生成代码，如果非标准的生成型工程也会导致判断失败。
     */
    get isGridComponent() {
        if (this.context && this.context.viewModel) {
            const dataGridColumnsName = this.context.viewModel['dataGridColumnsName'] || null;
            return dataGridColumnsName ? true : false;
        }
        return undefined;
    }
    dispose(options) {
        if (this.eventPipes) {
            this.eventPipes.forEach((eventPipe) => {
                eventPipe.disposeByCaller(this);
            });
        }
        this.cd = null;
        // this.viewModel = null;
        this.context.dispose();
        if (this.destorySignal) {
            this.destorySignal.next();
            this.destorySignal.complete();
        }
    }
    ngOnInit() {
        this.initialize();
    }
    initialize() {
        if (!this.initialized) {
            this.context.init(this);
            this.viewModel = this.context.viewModel;
            this.cd = this.getChangeDetectorRef();
            // 必须先执行context的初始化，然后再初始化Subscription
            this.initPublicEvent();
            this.initSubscription();
            this.restComponent();
            this.onFrameComponentInit();
            this.initialized = true;
        }
    }
    /**
     * 执行组件初始化
     */
    onFrameComponentInit() {
        const frameComponentInitHandlers = this.injector.get(FRAME_COMPONENT_INIT_HANDLER_TOKEN, null);
        if (frameComponentInitHandlers && Array.isArray(frameComponentInitHandlers) && frameComponentInitHandlers.length > 0) {
            frameComponentInitHandlers.forEach((handler) => {
                handler.onComponentInit(this.context);
            });
        }
    }
    /**
     * 获取变更检测器实例
     * @todo：应该通过注入获取，但注入会引起表单编译。
     */
    getChangeDetectorRef() {
        // const cd = this.get<ChangeDetectorRef>(ChangeDetectorRef, null, InjectFlags.Optional);
        const cd = this.injector.get(ChangeDetectorRef, null);
        return cd;
    }
    /**
     * 将当前组件脱离变更检测树
     */
    detach() {
        if (this.isCdValid() === false) {
            return;
        }
        this.cd.detach();
    }
    /**
     * 将当前组件重新加入变更检测树
     */
    reattach() {
        if (this.isCdValid() === false) {
            return;
        }
        this.cd.reattach();
    }
    /**
     * 对当前组件进行一次变更检查
     */
    detectChanges() {
        if (this.isCdValid() === false) {
            return;
        }
        this.cd.detectChanges();
    }
    /**
     * 检测ChangeDetection是否有效
     * @todo: Can't be depend on the destroyed property, destroyed.
     */
    isCdValid() {
        return this.cd && this.cd['destroyed'] === false || false;
    }
    /**
     * 重置组件状态
     * @todo：AppContext是全局的，
     */
    restComponent() {
        if (this.context !== this.context.root) {
            return;
        }
        // 1、如果AppContext不是root并且父AppContext也不是root不清理;
        // 2、表单Module里注入了FARRIS_DEVKIT_APP_PROVIDERS里面有一个冗余的AppContext注入
        //    导致所有AppContext的根是该冗余的AppContext，所以要检测parent.parent。
        // 只清理根组件的session
        if (this.context.appContext.parent !== null && this.context.appContext.parent.parent !== null) {
            return;
        }
        // Repository被注册到全局了，模块依赖注入中的对象，没有重置时机，临时在根组件中进行注销。
        // @todo：应该清理全部repository，目前缺少全局管理所有Repository的地方。
        this.context.repository.reset();
        // 重置组件绑定数据
        this.context.bindingData.reset();
    }
    ngOnDestroy() {
        this.dispose();
    }
    /**
     * 初始化事件订阅
     */
    initSubscription() {
        this.subscription = this.getSubscription();
        if (!this.subscription) {
            return;
        }
        this.eventPipes = this.subscription.init(this);
    }
    /**
     * 获取component对应的订阅
     * @returns
     */
    getSubscription() {
        return this.injector.get(Subscription, null);
    }
    initPublicEvent() {
        this.declaration = this.getDeclaration();
        if (!this.declaration) {
            return;
        }
        this.declaration.init(this);
    }
    /**
     * 获取当前component对应的declaration
     * @returns
     */
    getDeclaration() {
        return this.injector.get(Declaration, null);
    }
    /**
     * 事件触发器，触发事件发布
     * @param eventName 待发布事件
     */
    trigger(eventName, params) {
        const subscription = this.context.commandBus.executingCommandCount$.subscribe((executingCommandCount) => {
            if (executingCommandCount !== 0) {
                return;
            }
            this.innerTrigger(eventName, params);
            // @todo
            // subscription存在未undefine的情况，待进一步排查。
            if (subscription) {
                subscription.unsubscribe();
            }
            else {
                setTimeout(() => {
                    if (subscription) {
                        subscription.unsubscribe();
                    }
                }, 0);
            }
        });
    }
    /**
     * 内部触发变更检测
     */
    innerTrigger(eventName, params) {
        // 根据事件名，查找对应的事件处理器
        const eventHandler = this.declaration && this.declaration[eventName];
        if (!eventHandler) {
            return;
        }
        // 执行事件
        eventHandler(params);
    }
}
FrameComponent.decorators = [
    { type: Injectable }
];
/** @nocollapse */
FrameComponent.ctorParameters = () => [
    { type: Injector }
];
export { FrameComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJhbWVfY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZnJhbWUvZnJhbWVfY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7OztHQUtHO0FBRUgsT0FBTyxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQXlCLGlCQUFpQixFQUFzRixNQUFNLGVBQWUsQ0FBQztBQUNuTCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFL0MsT0FBTyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUdyRSxPQUFPLEVBQUUsa0NBQWtDLEVBQXdCLE1BQU0sVUFBVSxDQUFDO0FBQ3BGLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFL0IsTUFDZSxjQUFjO0lBOEMzQjs7O09BR0c7SUFDSCxZQUFzQixRQUFrQjtRQUFsQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBYmhDLGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBYzFCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQWUsWUFBWSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ25FLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNoQixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7U0FDbkI7UUFDRCxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksT0FBTyxFQUFPLENBQUM7UUFDeEMsMkJBQTJCO1FBQzNCLDJDQUEyQztRQUMzQyx5Q0FBeUM7UUFFekMseUNBQXlDO1FBQ3pDLDBCQUEwQjtRQUUxQiwyQkFBMkI7UUFFM0Isd0JBQXdCO0lBQzFCLENBQUM7SUFDRDs7OztPQUlHO0lBQ0gsSUFBVyxlQUFlO1FBQ3hCLElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRTtZQUMxQyxNQUFNLG1C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bUJBQW1CO1FBQ25CLE1BQU0sWUFBWSxHQUFRLElBQUksQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUMxRSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ2pCLE9BQU87U0FDUjtRQUNELE9BQU87UUFDUCxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDdkIsQ0FBQzs7O1lBMVJGLFVBQVU7Ozs7WUFURixRQUFROztBQXVTakIsT0FBTyxFQUFFLGNBQWMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogQEF1dGhvcjogV2l0dFxyXG4gKiBARGF0ZTogMjAxOS0wMy0xMiAxNDo1OToyMlxyXG4gKiBATGFzdCBNb2RpZmllZCBieTogYWFsaXp6d2VsbFxyXG4gKiBATGFzdCBNb2RpZmllZCB0aW1lOiAyMDE5LTA2LTE1IDE3OjI2OjA3XHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgSW5qZWN0b3IsIEluamVjdGFibGUsIEluamVjdEZsYWdzLCBPcHRpb25hbCwgQ2hhbmdlRGV0ZWN0b3JSZWYsIE9uRGVzdHJveSwgRWxlbWVudFJlZiwgUmVuZGVyZXIsIFJlbmRlcmVyMiwgUmVuZGVyZXJGYWN0b3J5MiwgQ29tcG9uZW50UmVmLCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0IH0gZnJvbSAnLi9mcmFtZV9jb250ZXh0JztcclxuaW1wb3J0IHsgVmlld01vZGVsIH0gZnJvbSAnLi4vdmlldy1tb2RlbC9pbmRleCc7XHJcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiwgRGVjbGFyYXRpb24gfSBmcm9tICcuLi9ldmVudC1tZWNoYW5pc20vaW5kZXgnO1xyXG5pbXBvcnQgeyBFdmVudFBpcGUgfSBmcm9tICcuLi9ldmVudC1idXMtbmV3L2luZGV4JztcclxuaW1wb3J0IHsgQ29tcG9uZW50VHlwZSwgSURpc3Bvc2FibGUgfSBmcm9tICcuLi9jb3JlL2luZGV4JztcclxuaW1wb3J0IHsgRlJBTUVfQ09NUE9ORU5UX0lOSVRfSEFORExFUl9UT0tFTiwgb25GcmFtZUNvbXBvbmVudEluaXQgfSBmcm9tICcuL3Rva2Vucyc7XHJcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuYWJzdHJhY3QgY2xhc3MgRnJhbWVDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSwgSURpc3Bvc2FibGUge1xyXG5cclxuICAvKipcclxuICAgKiDlj5jmm7Tmo4DmtYvlmahcclxuICAgKi9cclxuICBwcml2YXRlIGNkOiBDaGFuZ2VEZXRlY3RvclJlZjtcclxuXHJcbiAgLyoqXHJcbiAgICog5qGG5p62SURcclxuICAgKi9cclxuICBwdWJsaWMgaWQ6IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICog5qGG5p625LiK5LiL5paHXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnRleHQ6IEZyYW1lQ29udGV4dDtcclxuXHJcbiAgLyoqXHJcbiAgICog6KeG5Zu+5qih5Z6LXHJcbiAgICovXHJcbiAgcHVibGljIHZpZXdNb2RlbDogVmlld01vZGVsO1xyXG5cclxuICAvKipcclxuICAgKiDorqLpmIXkuovku7ZcclxuICAgKi9cclxuICBwdWJsaWMgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XHJcblxyXG4gIC8qKlxyXG4gICAqIOWFrOW8gOS6i+S7tlxyXG4gICAqL1xyXG4gIHB1YmxpYyBkZWNsYXJhdGlvbjogRGVjbGFyYXRpb247XHJcblxyXG4gIC8qKlxyXG4gICAqIOivpee7hOS7tuiuoumYheeahEV2ZW50UGlwZXNcclxuICAgKi9cclxuICBwcml2YXRlIGV2ZW50UGlwZXM6IElEaXNwb3NhYmxlW107XHJcblxyXG4gIHByaXZhdGUgaW5pdGlhbGl6ZWQgPSBmYWxzZTtcclxuICAvKipcclxuICAgKiDnu4Tku7bplIDmr4HmtYFcclxuICAgKi9cclxuICBwdWJsaWMgZGVzdG9yeVNpZ25hbDogU3ViamVjdDxhbnk+O1xyXG4gIC8qKlxyXG4gICAqIOe7hOS7tuexu+Wei1xyXG4gICAqL1xyXG4gIHB1YmxpYyBjb21wb25lbnRUeXBlOiBDb21wb25lbnRUeXBlO1xyXG4gIC8qKlxyXG4gICAqIOahhuaetuaehOmAoOWHveaVsFxyXG4gICAqIEBwYXJhbSBpbmplY3RvciDms6jlhaXlmahcclxuICAgKi9cclxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgaW5qZWN0b3I6IEluamVjdG9yKSB7XHJcbiAgICB0aGlzLmNvbnRleHQgPSB0aGlzLmluamVjdG9yLmdldDxGcmFtZUNvbnRleHQ+KEZyYW1lQ29udGV4dCwgbnVsbCk7XHJcbiAgICBpZiAodGhpcy5jb250ZXh0KSB7XHJcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5kZXN0b3J5U2lnbmFsID0gbmV3IFN1YmplY3Q8YW55PigpO1xyXG4gICAgLy8gdGhpcy5jb250ZXh0LmluaXQodGhpcyk7XHJcbiAgICAvLyB0aGlzLnZpZXdNb2RlbCA9IHRoaXMuY29udGV4dC52aWV3TW9kZWw7XHJcbiAgICAvLyB0aGlzLmNkID0gdGhpcy5nZXRDaGFuZ2VEZXRlY3RvclJlZigpO1xyXG5cclxuICAgIC8vIC8vIOW/hemhu+WFiOaJp+ihjGNvbnRleHTnmoTliJ3lp4vljJbvvIznhLblkI7lho3liJ3lp4vljJZTdWJzY3JpcHRpb25cclxuICAgIC8vIHRoaXMuaW5pdFB1YmxpY0V2ZW50KCk7XHJcblxyXG4gICAgLy8gdGhpcy5pbml0U3Vic2NyaXB0aW9uKCk7XHJcblxyXG4gICAgLy8gdGhpcy5yZXN0Q29tcG9uZW50KCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaYr+WQpuS4uuihqOagvOe7hOS7tlxyXG4gICAqIEBkZXNjcmlwdGlvbiDov5Tlm550cnVlL2ZhbHNl5pe25Y+v5Lul5L+h5Lu777yM5L2G5aaC5p6c6L+U5Zue55qE5pivdW5kZWZpbmVk5YiZ5LiN5bqU5L+h5Lu7XHJcbiAgICogQHdhcm5pbmcg6K+l5bGe5oCn5L6d6LWW5LqG55Sf5oiQ5Luj56CB77yM5aaC5p6c6Z2e5qCH5YeG55qE55Sf5oiQ5Z6L5bel56iL5Lmf5Lya5a+86Ie05Yik5pat5aSx6LSl44CCXHJcbiAgICovXHJcbiAgcHVibGljIGdldCBpc0dyaWRDb21wb25lbnQoKSB7XHJcbiAgICBpZiAodGhpcy5jb250ZXh0ICYmIHRoaXMuY29udGV4dC52aWV3TW9kZWwpIHtcclxuICAgICAgY29uc3QgZGF0YUdyaWRDb2x1bW5zTmFtZSA9IHRoaXMuY29udGV4dC52aWV3TW9kZWxbJ2RhdGFHcmlkQ29sdW1uc05hbWUnXSB8fCBudWxsO1xyXG4gICAgICByZXR1cm4gZGF0YUdyaWRDb2x1bW5zTmFtZSA/IHRydWUgOiBmYWxzZTtcclxuICAgIH1cclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgfVxyXG4gIGRpc3Bvc2Uob3B0aW9ucz86IGFueSkge1xyXG4gICAgaWYgKHRoaXMuZXZlbnRQaXBlcykge1xyXG4gICAgICB0aGlzLmV2ZW50UGlwZXMuZm9yRWFjaCgoZXZlbnRQaXBlOiBJRGlzcG9zYWJsZSkgPT4ge1xyXG4gICAgICAgIChldmVudFBpcGUgYXMgRXZlbnRQaXBlKS5kaXNwb3NlQnlDYWxsZXIodGhpcyk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgdGhpcy5jZCA9IG51bGw7XHJcbiAgICAvLyB0aGlzLnZpZXdNb2RlbCA9IG51bGw7XHJcbiAgICB0aGlzLmNvbnRleHQuZGlzcG9zZSgpO1xyXG4gICAgaWYgKHRoaXMuZGVzdG9yeVNpZ25hbCkge1xyXG4gICAgICB0aGlzLmRlc3RvcnlTaWduYWwubmV4dCgpO1xyXG4gICAgICB0aGlzLmRlc3RvcnlTaWduYWwuY29tcGxldGUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5pbml0aWFsaXplKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRpYWxpemUoKSB7XHJcbiAgICBpZiAoIXRoaXMuaW5pdGlhbGl6ZWQpIHtcclxuICAgICAgdGhpcy5jb250ZXh0LmluaXQodGhpcyk7XHJcbiAgICAgIHRoaXMudmlld01vZGVsID0gdGhpcy5jb250ZXh0LnZpZXdNb2RlbDtcclxuICAgICAgdGhpcy5jZCA9IHRoaXMuZ2V0Q2hhbmdlRGV0ZWN0b3JSZWYoKTtcclxuXHJcbiAgICAgIC8vIOW/hemhu+WFiOaJp+ihjGNvbnRleHTnmoTliJ3lp4vljJbvvIznhLblkI7lho3liJ3lp4vljJZTdWJzY3JpcHRpb25cclxuICAgICAgdGhpcy5pbml0UHVibGljRXZlbnQoKTtcclxuXHJcbiAgICAgIHRoaXMuaW5pdFN1YnNjcmlwdGlvbigpO1xyXG5cclxuICAgICAgdGhpcy5yZXN0Q29tcG9uZW50KCk7XHJcblxyXG4gICAgICB0aGlzLm9uRnJhbWVDb21wb25lbnRJbml0KCk7XHJcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDmiafooYznu4Tku7bliJ3lp4vljJZcclxuICAgKi9cclxuICBwcml2YXRlIG9uRnJhbWVDb21wb25lbnRJbml0KCkge1xyXG4gICAgY29uc3QgZnJhbWVDb21wb25lbnRJbml0SGFuZGxlcnMgPSB0aGlzLmluamVjdG9yLmdldDxvbkZyYW1lQ29tcG9uZW50SW5pdFtdPihGUkFNRV9DT01QT05FTlRfSU5JVF9IQU5ETEVSX1RPS0VOLCBudWxsKTtcclxuICAgIGlmIChmcmFtZUNvbXBvbmVudEluaXRIYW5kbGVycyAmJiBBcnJheS5pc0FycmF5KGZyYW1lQ29tcG9uZW50SW5pdEhhbmRsZXJzKSAmJiBmcmFtZUNvbXBvbmVudEluaXRIYW5kbGVycy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGZyYW1lQ29tcG9uZW50SW5pdEhhbmRsZXJzLmZvckVhY2goKGhhbmRsZXI6IG9uRnJhbWVDb21wb25lbnRJbml0KSA9PiB7XHJcbiAgICAgICAgaGFuZGxlci5vbkNvbXBvbmVudEluaXQodGhpcy5jb250ZXh0KTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWPmOabtOajgOa1i+WZqOWunuS+i1xyXG4gICAqIEB0b2Rv77ya5bqU6K+l6YCa6L+H5rOo5YWl6I635Y+W77yM5L2G5rOo5YWl5Lya5byV6LW36KGo5Y2V57yW6K+R44CCXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRDaGFuZ2VEZXRlY3RvclJlZigpIHtcclxuXHJcbiAgICAvLyBjb25zdCBjZCA9IHRoaXMuZ2V0PENoYW5nZURldGVjdG9yUmVmPihDaGFuZ2VEZXRlY3RvclJlZiwgbnVsbCwgSW5qZWN0RmxhZ3MuT3B0aW9uYWwpO1xyXG4gICAgY29uc3QgY2QgPSB0aGlzLmluamVjdG9yLmdldChDaGFuZ2VEZXRlY3RvclJlZiwgbnVsbCk7XHJcbiAgICByZXR1cm4gY2Q7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlsIblvZPliY3nu4Tku7bohLHnprvlj5jmm7Tmo4DmtYvmoJFcclxuICAgKi9cclxuICBwdWJsaWMgZGV0YWNoKCkge1xyXG4gICAgaWYgKHRoaXMuaXNDZFZhbGlkKCkgPT09IGZhbHNlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuY2QuZGV0YWNoKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlsIblvZPliY3nu4Tku7bph43mlrDliqDlhaXlj5jmm7Tmo4DmtYvmoJFcclxuICAgKi9cclxuICBwdWJsaWMgcmVhdHRhY2goKSB7XHJcbiAgICBpZiAodGhpcy5pc0NkVmFsaWQoKSA9PT0gZmFsc2UpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5jZC5yZWF0dGFjaCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5a+55b2T5YmN57uE5Lu26L+b6KGM5LiA5qyh5Y+Y5pu05qOA5p+lXHJcbiAgICovXHJcbiAgcHVibGljIGRldGVjdENoYW5nZXMoKSB7XHJcbiAgICBpZiAodGhpcy5pc0NkVmFsaWQoKSA9PT0gZmFsc2UpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5jZC5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmo4DmtYtDaGFuZ2VEZXRlY3Rpb27mmK/lkKbmnInmlYhcclxuICAgKiBAdG9kbzogQ2FuJ3QgYmUgZGVwZW5kIG9uIHRoZSBkZXN0cm95ZWQgcHJvcGVydHksIGRlc3Ryb3llZC5cclxuICAgKi9cclxuICBwcml2YXRlIGlzQ2RWYWxpZCgpIHtcclxuICAgIHJldHVybiB0aGlzLmNkICYmIHRoaXMuY2RbJ2Rlc3Ryb3llZCddID09PSBmYWxzZSB8fCBmYWxzZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOmHjee9rue7hOS7tueKtuaAgVxyXG4gICAqIEB0b2Rv77yaQXBwQ29udGV4dOaYr+WFqOWxgOeahO+8jFxyXG4gICAqL1xyXG4gIHB1YmxpYyByZXN0Q29tcG9uZW50KCkge1xyXG5cclxuICAgIGlmICh0aGlzLmNvbnRleHQgIT09IHRoaXMuY29udGV4dC5yb290KSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICAvLyAx44CB5aaC5p6cQXBwQ29udGV4dOS4jeaYr3Jvb3TlubbkuJTniLZBcHBDb250ZXh05Lmf5LiN5pivcm9vdOS4jea4heeQhjtcclxuICAgIC8vIDLjgIHooajljZVNb2R1bGXph4zms6jlhaXkuoZGQVJSSVNfREVWS0lUX0FQUF9QUk9WSURFUlPph4zpnaLmnInkuIDkuKrlhpfkvZnnmoRBcHBDb250ZXh05rOo5YWlXHJcbiAgICAvLyAgICDlr7zoh7TmiYDmnIlBcHBDb250ZXh055qE5qC55piv6K+l5YaX5L2Z55qEQXBwQ29udGV4dO+8jOaJgOS7peimgeajgOa1i3BhcmVudC5wYXJlbnTjgIJcclxuICAgIC8vIOWPqua4heeQhuaguee7hOS7tueahHNlc3Npb25cclxuICAgIGlmICh0aGlzLmNvbnRleHQuYXBwQ29udGV4dC5wYXJlbnQgIT09IG51bGwgJiYgdGhpcy5jb250ZXh0LmFwcENvbnRleHQucGFyZW50LnBhcmVudCAhPT0gbnVsbCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUmVwb3NpdG9yeeiiq+azqOWGjOWIsOWFqOWxgOS6hu+8jOaooeWdl+S+nei1luazqOWFpeS4reeahOWvueixoe+8jOayoeaciemHjee9ruaXtuacuu+8jOS4tOaXtuWcqOaguee7hOS7tuS4rei/m+ihjOazqOmUgOOAglxyXG4gICAgLy8gQHRvZG/vvJrlupTor6XmuIXnkIblhajpg6hyZXBvc2l0b3J577yM55uu5YmN57y65bCR5YWo5bGA566h55CG5omA5pyJUmVwb3NpdG9yeeeahOWcsOaWueOAglxyXG4gICAgdGhpcy5jb250ZXh0LnJlcG9zaXRvcnkucmVzZXQoKTtcclxuICAgIC8vIOmHjee9rue7hOS7tue7keWumuaVsOaNrlxyXG4gICAgdGhpcy5jb250ZXh0LmJpbmRpbmdEYXRhLnJlc2V0KCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICB0aGlzLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIneWni+WMluS6i+S7tuiuoumYhVxyXG4gICAqL1xyXG4gIHByaXZhdGUgaW5pdFN1YnNjcmlwdGlvbigpIHtcclxuICAgIHRoaXMuc3Vic2NyaXB0aW9uID0gdGhpcy5nZXRTdWJzY3JpcHRpb24oKTtcclxuICAgIGlmICghdGhpcy5zdWJzY3JpcHRpb24pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuZXZlbnRQaXBlcyA9IHRoaXMuc3Vic2NyaXB0aW9uLmluaXQodGhpcyk7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+WY29tcG9uZW505a+55bqU55qE6K6i6ZiFXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIGdldFN1YnNjcmlwdGlvbigpIHtcclxuICAgIHJldHVybiB0aGlzLmluamVjdG9yLmdldDxTdWJzY3JpcHRpb24+KFN1YnNjcmlwdGlvbiwgbnVsbCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRQdWJsaWNFdmVudCgpIHtcclxuXHJcbiAgICB0aGlzLmRlY2xhcmF0aW9uID0gdGhpcy5nZXREZWNsYXJhdGlvbigpO1xyXG4gICAgaWYgKCF0aGlzLmRlY2xhcmF0aW9uKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmRlY2xhcmF0aW9uLmluaXQodGhpcyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blvZPliY1jb21wb25lbnTlr7nlupTnmoRkZWNsYXJhdGlvblxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXREZWNsYXJhdGlvbigpIHtcclxuICAgIHJldHVybiB0aGlzLmluamVjdG9yLmdldDxEZWNsYXJhdGlvbj4oRGVjbGFyYXRpb24sIG51bGwpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5LqL5Lu26Kem5Y+R5Zmo77yM6Kem5Y+R5LqL5Lu25Y+R5biDXHJcbiAgICogQHBhcmFtIGV2ZW50TmFtZSDlvoXlj5HluIPkuovku7ZcclxuICAgKi9cclxuICBwdWJsaWMgdHJpZ2dlcihldmVudE5hbWU6IHN0cmluZywgcGFyYW1zPzogYW55KSB7XHJcbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLmNvbnRleHQuY29tbWFuZEJ1cy5leGVjdXRpbmdDb21tYW5kQ291bnQkLnN1YnNjcmliZSgoZXhlY3V0aW5nQ29tbWFuZENvdW50OiBudW1iZXIpID0+IHtcclxuICAgICAgaWYgKGV4ZWN1dGluZ0NvbW1hbmRDb3VudCAhPT0gMCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLmlubmVyVHJpZ2dlcihldmVudE5hbWUsIHBhcmFtcyk7XHJcblxyXG4gICAgICAvLyBAdG9kb1xyXG4gICAgICAvLyBzdWJzY3JpcHRpb27lrZjlnKjmnKp1bmRlZmluZeeahOaDheWGte+8jOW+hei/m+S4gOatpeaOkuafpeOAglxyXG4gICAgICBpZiAoc3Vic2NyaXB0aW9uKSB7XHJcbiAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICBpZiAoc3Vic2NyaXB0aW9uKSB7XHJcbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0sIDApO1xyXG4gICAgICB9XHJcblxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlhoXpg6jop6blj5Hlj5jmm7Tmo4DmtYtcclxuICAgKi9cclxuICBwcml2YXRlIGlubmVyVHJpZ2dlcihldmVudE5hbWU6IHN0cmluZywgcGFyYW1zPzogYW55KSB7XHJcblxyXG4gICAgLy8g5qC55o2u5LqL5Lu25ZCN77yM5p+l5om+5a+55bqU55qE5LqL5Lu25aSE55CG5ZmoXHJcbiAgICBjb25zdCBldmVudEhhbmRsZXI6IGFueSA9IHRoaXMuZGVjbGFyYXRpb24gJiYgdGhpcy5kZWNsYXJhdGlvbltldmVudE5hbWVdO1xyXG4gICAgaWYgKCFldmVudEhhbmRsZXIpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgLy8g5omn6KGM5LqL5Lu2XHJcbiAgICBldmVudEhhbmRsZXIocGFyYW1zKTtcclxuICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQgeyBGcmFtZUNvbXBvbmVudCB9O1xyXG4iXX0=