/*
 * @Author: Witt
 * @Date: 2018-10-17 14:13:40
 * @Last Modified by: Witt
 * @Last Modified time: 2018-10-17 16:08:34
 */
import { TaskNode } from './task_node';
import { TaskLink } from './task_link';
/**
 * 任务执行流程
 */
class TaskFlow {
    constructor() {
        /**
         * 节点集合
         */
        this.nodes = [];
        /**
         * 边集合
         */
        this.links = [];
        // #endregion
    }
    // #region 节点操作
    /**
     * 添加节点
     */
    addNode(name, func) {
        const node = new TaskNode(name, func);
        this.nodes.push(node);
    }
    /**
     * 批量添加链接
     */
    addNodes(nodes) {
        this.nodes = this.nodes.concat(nodes);
    }
    /**
     * 在目标节点之前插入一个节点
     * @param target 目标节点名称
     * @param name 名称
     * @param func 函数
     */
    insertNode(target, name, func) {
        const index = this.findNodeIndex(target);
        const node = this.createNode(name, func);
        this.nodes.splice(index, 0, node);
    }
    /**
     * 在目标节点之前插入一个节点
     */
    appendNode(target, name, func) {
        const index = this.findNodeIndex(target) + 1;
        const node = this.createNode(name, func);
        this.nodes.splice(index, 0, node);
    }
    /**
     * 获取节点索引
     * @param name 名称
     */
    findNodeIndex(name) {
        return this.nodes.findIndex((node) => {
            return node.name === name;
        });
    }
    /**
     * 创建任务节点
     * @param name 名称
     * @param func 函数
     */
    createNode(name, func) {
        const node = new TaskNode(name, func);
        return node;
    }
    // #endregion
    // #region 链接操作
    /**
     * 添加链接
     * @param name 名称
     * @param func 函数
     */
    addLink(from, to, condition) {
        const link = this.createLink(from, to, condition);
        this.links.push(link);
    }
    /**
     * 批量添加链接
     */
    addLinks(links) {
        this.links = this.links.concat(links);
    }
    /**
     * 创建链接
     */
    createLink(from, to, condition) {
        const link = new TaskLink(from, to, condition);
        return link;
    }
    // #endregion
    // #region 流程控制
    /**
     * 获取下一个节点
     * @param from    源节点名称
     * @param context 上下文
     */
    getNext(from, context) {
        if (!from) {
            return this.nodes.shift();
        }
        // 符合满足条件的边
        const nextLink = this.links.find((link) => {
            return link.from === from && link.canLink(context);
        });
        if (!nextLink) {
            return;
        }
        return this.nodes.find((node) => {
            return node.name === nextLink.to;
        });
    }
    // #endregion
    // #region 其他方法
    /**
     * 克隆任务流
     */
    clone() {
        const taskFlow = new TaskFlow();
        taskFlow.addNodes(this.nodes);
        taskFlow.addLinks(this.links);
        return taskFlow;
    }
}
export { TaskFlow };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFza19mbG93LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvY29tbWFuZC9mbG93L3Rhc2tfZmxvdy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7R0FLRztBQUVILE9BQU8sRUFBWSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDakQsT0FBTyxFQUFZLFFBQVEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUdqRDs7R0FFRztBQUNILE1BQU0sUUFBUTtJQUFkO1FBRUU7O1dBRUc7UUFDSyxVQUFLLEdBQWUsRUFBRSxDQUFDO1FBRS9COztXQUVHO1FBQ0ssVUFBSyxHQUFlLEVBQUUsQ0FBQztRQXFJL0IsYUFBYTtJQUNmLENBQUM7SUFuSUMsZUFBZTtJQUVmOztPQUVHO0lBQ0ksT0FBTyxDQUFDLElBQVksRUFBRSxJQUFjO1FBQ3pDLE1BQU0sSUFBSSxHQUFHLElBQUksUUFBUSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN0QyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN4QixDQUFDO0lBR0Q7O09BRUc7SUFDSSxRQUFRLENBQUMsS0FBaUI7UUFDL0IsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSSxVQUFVLENBQUMsTUFBYyxFQUFFLElBQVksRUFBRSxJQUFjO1FBQzVELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDekMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNw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QyIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIEBBdXRob3I6IFdpdHRcclxuICogQERhdGU6IDIwMTgtMTAtMTcgMTQ6MTM6NDBcclxuICogQExhc3QgTW9kaWZpZWQgYnk6IFdpdHRcclxuICogQExhc3QgTW9kaWZpZWQgdGltZTogMjAxOC0xMC0xNyAxNjowODozNFxyXG4gKi9cclxuXHJcbmltcG9ydCB7IFRhc2tGdW5jLCBUYXNrTm9kZSB9IGZyb20gJy4vdGFza19ub2RlJztcclxuaW1wb3J0IHsgTGlua0Z1bmMsIFRhc2tMaW5rIH0gZnJvbSAnLi90YXNrX2xpbmsnO1xyXG5pbXBvcnQgeyBDb21tYW5kQ29udGV4dCB9IGZyb20gJy4uL2NvbW1hbmRfY29udGV4dCc7XHJcblxyXG4vKipcclxuICog5Lu75Yqh5omn6KGM5rWB56iLXHJcbiAqL1xyXG5jbGFzcyBUYXNrRmxvdyB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOiKgueCuembhuWQiFxyXG4gICAqL1xyXG4gIHByaXZhdGUgbm9kZXM6IFRhc2tOb2RlW10gPSBbXTtcclxuXHJcbiAgLyoqXHJcbiAgICog6L656ZuG5ZCIXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBsaW5rczogVGFza0xpbmtbXSA9IFtdO1xyXG5cclxuXHJcbiAgLy8gI3JlZ2lvbiDoioLngrnmk43kvZxcclxuXHJcbiAgLyoqXHJcbiAgICog5re75Yqg6IqC54K5XHJcbiAgICovXHJcbiAgcHVibGljIGFkZE5vZGUobmFtZTogc3RyaW5nLCBmdW5jOiBUYXNrRnVuYyk6IHZvaWQge1xyXG4gICAgY29uc3Qgbm9kZSA9IG5ldyBUYXNrTm9kZShuYW1lLCBmdW5jKTtcclxuICAgIHRoaXMubm9kZXMucHVzaChub2RlKTtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiDmibnph4/mt7vliqDpk77mjqVcclxuICAgKi9cclxuICBwdWJsaWMgYWRkTm9kZXMobm9kZXM6IFRhc2tOb2RlW10pIHtcclxuICAgIHRoaXMubm9kZXMgPSB0aGlzLm5vZGVzLmNvbmNhdChub2Rlcyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlnKjnm67moIfoioLngrnkuYvliY3mj5LlhaXkuIDkuKroioLngrlcclxuICAgKiBAcGFyYW0gdGFyZ2V0IOebruagh+iKgueCueWQjeensFxyXG4gICAqIEBwYXJhbSBuYW1lIOWQjeensFxyXG4gICAqIEBwYXJhbSBmdW5jIOWHveaVsFxyXG4gICAqL1xyXG4gIHB1YmxpYyBpbnNlcnROb2RlKHRhcmdldDogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIGZ1bmM6IFRhc2tGdW5jKTogdm9pZCB7XHJcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuZmluZE5vZGVJbmRleCh0YXJnZXQpO1xyXG4gICAgY29uc3Qgbm9kZSA9IHRoaXMuY3JlYXRlTm9kZShuYW1lLCBmdW5jKTtcclxuICAgIHRoaXMubm9kZXMuc3BsaWNlKGluZGV4LCAwLCBub2RlKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWcqOebruagh+iKgueCueS5i+WJjeaPkuWFpeS4gOS4quiKgueCuVxyXG4gICAqL1xyXG4gIHB1YmxpYyBhcHBlbmROb2RlKHRhcmdldDogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIGZ1bmM6IFRhc2tGdW5jKSB7XHJcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuZmluZE5vZGVJbmRleCh0YXJnZXQpICsgMTtcclxuICAgIGNvbnN0IG5vZGUgPSB0aGlzLmNyZWF0ZU5vZGUobmFtZSwgZnVuYyk7XHJcbiAgICB0aGlzLm5vZGVzLnNwbGljZShpbmRleCwgMCwgbm9kZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5boioLngrnntKLlvJVcclxuICAgKiBAcGFyYW0gbmFtZSDlkI3np7BcclxuICAgKi9cclxuICBwcml2YXRlIGZpbmROb2RlSW5kZXgobmFtZTogc3RyaW5nKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLm5vZGVzLmZpbmRJbmRleCgobm9kZTogVGFza05vZGUpID0+IHtcclxuICAgICAgcmV0dXJuIG5vZGUubmFtZSA9PT0gbmFtZTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yib5bu65Lu75Yqh6IqC54K5XHJcbiAgICogQHBhcmFtIG5hbWUg5ZCN56ewXHJcbiAgICogQHBhcmFtIGZ1bmMg5Ye95pWwXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjcmVhdGVOb2RlKG5hbWU6IHN0cmluZywgZnVuYzogVGFza0Z1bmMpOiBUYXNrTm9kZSB7XHJcbiAgICBjb25zdCBub2RlID0gbmV3IFRhc2tOb2RlKG5hbWUsIGZ1bmMpO1xyXG4gICAgcmV0dXJuIG5vZGU7XHJcbiAgfVxyXG5cclxuICAvLyAjZW5kcmVnaW9uXHJcblxyXG5cclxuICAvLyAjcmVnaW9uIOmTvuaOpeaTjeS9nFxyXG5cclxuICAvKipcclxuICAgKiDmt7vliqDpk77mjqVcclxuICAgKiBAcGFyYW0gbmFtZSDlkI3np7BcclxuICAgKiBAcGFyYW0gZnVuYyDlh73mlbBcclxuICAgKi9cclxuICBwdWJsaWMgYWRkTGluayhmcm9tOiBzdHJpbmcsIHRvOiBzdHJpbmcsIGNvbmRpdGlvbjogc3RyaW5nIHwgYm9vbGVhbikge1xyXG4gICAgY29uc3QgbGluayA9IHRoaXMuY3JlYXRlTGluayhmcm9tLCB0bywgY29uZGl0aW9uKTtcclxuICAgIHRoaXMubGlua3MucHVzaChsaW5rKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJuemHj+a3u+WKoOmTvuaOpVxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZGRMaW5rcyhsaW5rczogVGFza0xpbmtbXSkge1xyXG4gICAgdGhpcy5saW5rcyA9IHRoaXMubGlua3MuY29uY2F0KGxpbmtzKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIm+W7uumTvuaOpVxyXG4gICAqL1xyXG4gIHByaXZhdGUgY3JlYXRlTGluayhmcm9tOiBzdHJpbmcsIHRvOiBzdHJpbmcsIGNvbmRpdGlvbjogc3RyaW5nIHwgYm9vbGVhbikge1xyXG4gICAgY29uc3QgbGluayA9IG5ldyBUYXNrTGluayhmcm9tLCB0bywgY29uZGl0aW9uKTtcclxuICAgIHJldHVybiBsaW5rO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLy8gI3JlZ2lvbiDmtYHnqIvmjqfliLZcclxuICAvKipcclxuICAgKiDojrflj5bkuIvkuIDkuKroioLngrlcclxuICAgKiBAcGFyYW0gZnJvbSAgICDmupDoioLngrnlkI3np7BcclxuICAgKiBAcGFyYW0gY29udGV4dCDkuIrkuIvmlodcclxuICAgKi9cclxuICBnZXROZXh0KGZyb20/OiBzdHJpbmcsIGNvbnRleHQ/OiBDb21tYW5kQ29udGV4dCk6IFRhc2tOb2RlIHtcclxuICAgIGlmICghZnJvbSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5ub2Rlcy5zaGlmdCgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOespuWQiOa7oei2s+adoeS7tueahOi+uVxyXG4gICAgY29uc3QgbmV4dExpbmsgPSB0aGlzLmxpbmtzLmZpbmQoKGxpbms6IFRhc2tMaW5rKSA9PiB7XHJcbiAgICAgIHJldHVybiBsaW5rLmZyb20gPT09IGZyb20gJiYgbGluay5jYW5MaW5rKGNvbnRleHQpO1xyXG4gICAgfSk7XHJcbiAgICBpZiAoIW5leHRMaW5rKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGhpcy5ub2Rlcy5maW5kKChub2RlOiBUYXNrTm9kZSkgPT4ge1xyXG4gICAgICByZXR1cm4gbm9kZS5uYW1lID09PSBuZXh0TGluay50bztcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuICAvLyAjcmVnaW9uIOWFtuS7luaWueazlVxyXG5cclxuICAvKipcclxuICAgKiDlhYvpmobku7vliqHmtYFcclxuICAgKi9cclxuICBjbG9uZSgpIHtcclxuICAgIGNvbnN0IHRhc2tGbG93ID0gbmV3IFRhc2tGbG93KCk7XHJcbiAgICB0YXNrRmxvdy5hZGROb2Rlcyh0aGlzLm5vZGVzKTtcclxuICAgIHRhc2tGbG93LmFkZExpbmtzKHRoaXMubGlua3MpO1xyXG4gICAgcmV0dXJuIHRhc2tGbG93O1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG59XHJcblxyXG5leHBvcnQgeyBUYXNrRmxvdyB9O1xyXG4iXX0=