import { ReflectiveInjector } from '@angular/core';
import { isObservable, of, Subject } from 'rxjs';
import { CommandHandler } from './command_handler';
/**
 * @Injectable()
 * @NgCommandHandler({
 *     commandName: 'add1'
 * })
 * export class add1Handler extends CommandHandler {
 *     constructor(
 *         public _ListDataService1: ListDataService1,
 *         public _StateMachineService1: StateMachineService1
 *     ) {
 *         super();
 *     }
 *
 *     schedule() {
 *         this.addTask('append', (context: CommandContext) => {
 *             const args = [];
 *             return this.invoke(this._ListDataService1, 'append', args, context);
 *         });
 *
 *         this.addTask('transit', (context: CommandContext) => {
 *             const args = [
 *                 'Create'
 *                     ];
 *             return this.invoke(this._StateMachineService1, 'transit', args, context);
 *         });
 *
 *         this.addLink('append', 'transit', `1==1`);
 *     }
 * }
 */
const controllerMap = {
    imports: {}
};
export class DynamicCommandHandler extends CommandHandler {
    constructor(commandName, method) {
        super();
        this.commandName = commandName;
        this.method = method;
    }
    dynamicInvoke(serviceTocken, method, args, context) {
        const serviceInstance = context.frameContext.injector.get(serviceTocken, null);
        if (serviceInstance) {
            this.setContextToServiceInstance(serviceInstance, context);
            const parsedStageParams = this.parseService.parse(args, context);
            const parsedArgs = parsedStageParams.map(param => param.expression);
            // tslint:disable-next-line: ban-types
            const serviceMethod = serviceInstance[method];
            return serviceMethod.apply(serviceInstance, parsedArgs);
        }
    }
    dynamicInvoke2(methodObject, context) {
        const { source: serviceUri, service: serviceName, method } = methodObject;
        const args = methodObject.params.map(stageParam => {
            return Object.assign({}, stageParam);
        });
        const result$ = new Subject();
        const serviceSpecifer = serviceUri && serviceUri.toLowerCase();
        if (serviceSpecifer) {
            let serviceModule = controllerMap.imports[serviceSpecifer];
            if (serviceModule) {
                // 表示缓存中存在
                setTimeout(() => {
                    this.executeWithServiceModule(serviceModule, serviceName, context, args, method, result$);
                }, 0);
            }
            else {
                //  表示不存在
                System.import(serviceSpecifer)
                    .then((serviceModule) => {
                    if (serviceModule) {
                        controllerMap.imports[serviceSpecifer] = serviceModule;
                    }
                    this.executeWithServiceModule(serviceModule, serviceName, context, args, method, result$);
                });
            }
        }
        return result$;
    }
    executeWithServiceModule(serviceModule, serviceName, context, args, method, result$) {
        const serviceConstructor = serviceModule[serviceName];
        if (serviceConstructor) {
            const originalContextInjector = context.frameContext.injector;
            let serviceInstance;
            // const resolvedReflectiveProviders = ReflectiveInjector.resolve([{ provide: serviceName, useClass: serviceConstructor }]);
            if (context.frameContext.injector.get(serviceName, null)) {
                serviceInstance = context.frameContext.injector.get(serviceName);
            }
            else {
                const resolvedReflectiveProviders = this.loadProvidersFromModule(serviceModule);
                const reflectiveInjector = ReflectiveInjector.fromResolvedProviders(resolvedReflectiveProviders, context.frameContext.injector);
                context.frameContext.injector = reflectiveInjector;
                serviceInstance = reflectiveInjector.get(serviceName, null);
            }
            if (serviceInstance) {
                this.setContextToServiceInstance(serviceInstance, context);
                const parsedStageParams = this.parseService.parse(args, context);
                const parsedArgs = parsedStageParams.map(param => param.expression);
                // tslint:disable-next-line: ban-types
                const serviceMethod = serviceInstance[method];
                if (!serviceMethod) {
                    console.error("未找到对应的命令:" + method);
                    return;
                }
                const serviceMethodResult = serviceMethod.apply(serviceInstance, parsedArgs);
                const result$$ = isObservable(serviceMethodResult) ? serviceMethodResult : of(serviceMethodResult);
                result$$.subscribe({
                    next: (result) => {
                        result$.next(result);
                    },
                    error: (error) => {
                        result$.error(error);
                    },
                    complete: () => {
                        result$.complete();
                        context.frameContext.injector = originalContextInjector;
                    },
                });
                // return serviceMethod.apply(serviceInstance, parsedArgs);
            }
        }
    }
    schedule() {
        this.scheduleStages(this.method.stages, null);
        // this.method.stages.reduce((preStage: MethodStage, currentStage: MethodStage) => {
        //   if (currentStage.type === '0') {
        //     this.addTask(currentStage.name, (context: CommandContext) => {
        //       return this.dynamicInvoke2(currentStage as ExecutingStage, context);
        //     });
        //     if (preStage) {
        //       this.addLink(preStage.name, currentStage.name, `1===1`);
        //     }
        //   } else if (currentStage.type === '2') {
        //   } else {
        //     throw new Error(`unknow method stage type, the ${currentStage.name}'s type is ${currentStage.type}`);
        //   }
        //   return currentStage;
        // }, null);
    }
    scheduleStages(stages, initialStage) {
        stages.reduce((preStage, currentStage) => {
            if (currentStage.type === 'executing') {
                this.addTask(currentStage.name, (context) => {
                    return this.dynamicInvoke2(currentStage, context);
                });
            }
            else if (currentStage.type === 'fork') {
                const forkStages = currentStage.stages;
                forkStages.forEach(forkStage => {
                    this.scheduleStages(forkStage.stages, forkStage);
                });
                this.scheduleStages(currentStage.stages, currentStage);
            }
            else if (currentStage.type === 'determing') {
                this.addTask(currentStage.name, (context) => {
                    return of(true);
                });
            }
            else {
                throw new Error(`unknow method stage type, the ${currentStage.name}'s type is ${currentStage.type}`);
            }
            if (preStage) {
                const condition = preStage.type === 'determing' ? preStage.condition : `1===1`;
                this.addLink(preStage.name, currentStage.name, condition);
            }
            return currentStage;
        }, initialStage);
    }
    loadProvidersFromModule(serviceModule) {
        const providerArray = [];
        for (const propertyName in serviceModule) {
            if (Object.prototype.hasOwnProperty.call(serviceModule, propertyName)) {
                const propertyValue = serviceModule[propertyName];
                if (this.isInjectableService(propertyValue)) {
                    // const providerName = propertyValue.name === 'e' ? propertyName : propertyValue.name;
                    const providerName = propertyName;
                    providerArray.push({ provide: providerName, useClass: propertyValue });
                    providerArray.push(propertyValue);
                }
            }
        }
        const resolvedReflectiveProviders = ReflectiveInjector.resolve(providerArray);
        return resolvedReflectiveProviders;
    }
    isInjectableService(propertyValue) {
        let hasInjectableDecorator = false;
        const isFunction = propertyValue instanceof Function;
        if (isFunction && propertyValue.hasOwnProperty('decorators')) {
            const decorators = propertyValue.decorators;
            const injectableDecorators = decorators.filter(decorator => {
                if (decorator.type && decorator.type.prototype && decorator.type.prototype.ngMetadataName === 'Injectable') {
                    return decorator;
                }
            });
            hasInjectableDecorator = injectableDecorators && injectableDecorators.length > 0;
        }
        else if (isFunction && propertyValue.hasOwnProperty('__annotations__')) {
            const decorators = propertyValue.__annotations__;
            const injectableDecorators = decorators.filter(decoratorFactory => {
                if (decoratorFactory && decoratorFactory.ngMetadataName && decoratorFactory.ngMetadataName === 'Injectable') {
                    return decoratorFactory;
                }
            });
            hasInjectableDecorator = injectableDecorators && injectableDecorators.length > 0;
        }
        return hasInjectableDecorator;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pY19jb21tYW5kX2hhbmRsZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kL2R5bmFtaWNfY29tbWFuZF9oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsWUFBWSxFQUFFLEVBQUUsRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFakQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBTW5EOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQTZCRztBQUVILE1BQU0sYUFBYSxHQUFHO0lBQ3BCLE9BQU8sRUFBRSxFQUVSO0NBQ0YsQ0FBQztBQUlGLE1BQU0sT0FBTyxxQkFBc0IsU0FBUSxjQUFjO0lBRXZELFlBQW1CLFdBQW1CLEVBQVUsTUFBd0I7UUFDdEUsS0FBSyxFQUFFLENBQUM7UUFEUyxnQkFBVyxHQUFYLFdBQVcsQ0FBUTtRQUFVLFdBQU0sR0FBTixNQUFNLENBQWtCO0lBRXhFLENBQUM7SUFFTSxhQUFhLENBQUMsYUFBcUIsRUFBRSxNQUFjLEVBQUUsSUFBa0IsRUFBRSxPQUF1QjtRQUNyRyxNQUFNLGVBQWUsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQy9FLElBQUksZUFBZSxFQUFFO1lBQ25CLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxlQUFlLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDM0QsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFpQixDQUFDO1lBQ2pGLE1BQU0sVUFBVSxHQUFHLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtB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QUFzQixHQUFHLG9CQUFvQixJQUFJLG9CQUFvQixDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7U0FDbEY7UUFDRCxPQUFPLHNCQUFzQixDQUFDO0lBQ2hDLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlZmxlY3RpdmVJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBpc09ic2VydmFibGUsIG9mLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IENvbW1hbmRDb250ZXh0IH0gZnJvbSAnLi9jb21tYW5kX2NvbnRleHQnO1xyXG5pbXBvcnQgeyBDb21tYW5kSGFuZGxlciB9IGZyb20gJy4vY29tbWFuZF9oYW5kbGVyJztcclxuaW1wb3J0IHtcclxuICBDb250cm9sbGVyTWV0aG9kLCBEZXRlcm1pbmluZ1N0YWdlLCBFeGVjdXRpbmdTdGFnZSxcclxuICBGb3JrU3RhZ2UsIE1ldGhvZFN0YWdlLCBTdGFnZVBhcmFtXHJcbn0gZnJvbSAnLi9keW5hbWljX2NvbW1hbmRfaGFuZGxlcl9tZXRhZGF0YSc7XHJcblxyXG4vKipcclxuICogQEluamVjdGFibGUoKVxyXG4gKiBATmdDb21tYW5kSGFuZGxlcih7XHJcbiAqICAgICBjb21tYW5kTmFtZTogJ2FkZDEnXHJcbiAqIH0pXHJcbiAqIGV4cG9ydCBjbGFzcyBhZGQxSGFuZGxlciBleHRlbmRzIENvbW1hbmRIYW5kbGVyIHtcclxuICogICAgIGNvbnN0cnVjdG9yKFxyXG4gKiAgICAgICAgIHB1YmxpYyBfTGlzdERhdGFTZXJ2aWNlMTogTGlzdERhdGFTZXJ2aWNlMSxcclxuICogICAgICAgICBwdWJsaWMgX1N0YXRlTWFjaGluZVNlcnZpY2UxOiBTdGF0ZU1hY2hpbmVTZXJ2aWNlMVxyXG4gKiAgICAgKSB7XHJcbiAqICAgICAgICAgc3VwZXIoKTtcclxuICogICAgIH1cclxuICpcclxuICogICAgIHNjaGVkdWxlKCkge1xyXG4gKiAgICAgICAgIHRoaXMuYWRkVGFzaygnYXBwZW5kJywgKGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSA9PiB7XHJcbiAqICAgICAgICAgICAgIGNvbnN0IGFyZ3MgPSBbXTtcclxuICogICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW52b2tlKHRoaXMuX0xpc3REYXRhU2VydmljZTEsICdhcHBlbmQnLCBhcmdzLCBjb250ZXh0KTtcclxuICogICAgICAgICB9KTtcclxuICpcclxuICogICAgICAgICB0aGlzLmFkZFRhc2soJ3RyYW5zaXQnLCAoY29udGV4dDogQ29tbWFuZENvbnRleHQpID0+IHtcclxuICogICAgICAgICAgICAgY29uc3QgYXJncyA9IFtcclxuICogICAgICAgICAgICAgICAgICdDcmVhdGUnXHJcbiAqICAgICAgICAgICAgICAgICAgICAgXTtcclxuICogICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW52b2tlKHRoaXMuX1N0YXRlTWFjaGluZVNlcnZpY2UxLCAndHJhbnNpdCcsIGFyZ3MsIGNvbnRleHQpO1xyXG4gKiAgICAgICAgIH0pO1xyXG4gKlxyXG4gKiAgICAgICAgIHRoaXMuYWRkTGluaygnYXBwZW5kJywgJ3RyYW5zaXQnLCBgMT09MWApO1xyXG4gKiAgICAgfVxyXG4gKiB9XHJcbiAqL1xyXG5cclxuY29uc3QgY29udHJvbGxlck1hcCA9IHtcclxuICBpbXBvcnRzOiB7XHJcblxyXG4gIH1cclxufTtcclxuXHJcbmRlY2xhcmUgY29uc3QgU3lzdGVtOiBhbnk7XHJcblxyXG5leHBvcnQgY2xhc3MgRHluYW1pY0NvbW1hbmRIYW5kbGVyIGV4dGVuZHMgQ29tbWFuZEhhbmRsZXIge1xyXG5cclxuICBjb25zdHJ1Y3RvcihwdWJsaWMgY29tbWFuZE5hbWU6IHN0cmluZywgcHJpdmF0ZSBtZXRob2Q6IENvbnRyb2xsZXJNZXRob2QpIHtcclxuICAgIHN1cGVyKCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZHluYW1pY0ludm9rZShzZXJ2aWNlVG9ja2VuOiBzdHJpbmcsIG1ldGhvZDogc3RyaW5nLCBhcmdzOiBTdGFnZVBhcmFtW10sIGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSB7XHJcbiAgICBjb25zdCBzZXJ2aWNlSW5zdGFuY2UgPSBjb250ZXh0LmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQoc2VydmljZVRvY2tlbiwgbnVsbCk7XHJcbiAgICBpZiAoc2VydmljZUluc3RhbmNlKSB7XHJcbiAgICAgIHRoaXMuc2V0Q29udGV4dFRvU2VydmljZUluc3RhbmNlKHNlcnZpY2VJbnN0YW5jZSwgY29udGV4dCk7XHJcbiAgICAgIGNvbnN0IHBhcnNlZFN0YWdlUGFyYW1zID0gdGhpcy5wYXJzZVNlcnZpY2UucGFyc2UoYXJncywgY29udGV4dCkgYXMgU3RhZ2VQYXJhbVtdO1xyXG4gICAgICBjb25zdCBwYXJzZWRBcmdzID0gcGFyc2VkU3RhZ2VQYXJhbXMubWFwKHBhcmFtID0+IHBhcmFtLmV4cHJlc3Npb24pO1xyXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGJhbi10eXBlc1xyXG4gICAgICBjb25zdCBzZXJ2aWNlTWV0aG9kID0gc2VydmljZUluc3RhbmNlW21ldGhvZF0gYXMgRnVuY3Rpb247XHJcbiAgICAgIHJldHVybiBzZXJ2aWNlTWV0aG9kLmFwcGx5KHNlcnZpY2VJbnN0YW5jZSwgcGFyc2VkQXJncyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZHluYW1pY0ludm9rZTIobWV0aG9kT2JqZWN0OiBFeGVjdXRpbmdTdGFnZSwgY29udGV4dDogQ29tbWFuZENvbnRleHQpIHtcclxuICAgIGNvbnN0IHsgc291cmNlOiBzZXJ2aWNlVXJpLCBzZXJ2aWNlOiBzZXJ2aWNlTmFtZSwgbWV0aG9kIH0gPSBtZXRob2RPYmplY3Q7XHJcbiAgICBjb25zdCBhcmdzID0gbWV0aG9kT2JqZWN0LnBhcmFtcy5tYXAoc3RhZ2VQYXJhbSA9PiB7XHJcbiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBzdGFnZVBhcmFtKTtcclxuICAgIH0pO1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgICBjb25zdCBzZXJ2aWNlU3BlY2lmZXIgPSBzZXJ2aWNlVXJpICYmIHNlcnZpY2VVcmkudG9Mb3dlckNhc2UoKTtcclxuICAgIGlmIChzZXJ2aWNlU3BlY2lmZXIpIHtcclxuICAgICAgbGV0IHNlcnZpY2VNb2R1bGUgPSBjb250cm9sbGVyTWFwLmltcG9ydHNbc2VydmljZVNwZWNpZmVyXTtcclxuICAgICAgaWYgKHNlcnZpY2VNb2R1bGUpIHtcclxuICAgICAgICAvLyDooajnpLrnvJPlrZjkuK3lrZjlnKhcclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgIHRoaXMuZXhlY3V0ZVdpdGhTZXJ2aWNlTW9kdWxlKHNlcnZpY2VNb2R1bGUsIHNlcnZpY2VOYW1lLCBjb250ZXh0LCBhcmdzLCBtZXRob2QsIHJlc3VsdCQpO1xyXG4gICAgICAgIH0sIDApO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vICDooajnpLrkuI3lrZjlnKhcclxuICAgICAgICBTeXN0ZW0uaW1wb3J0KHNlcnZpY2VTcGVjaWZlcilcclxuICAgICAgICAgIC50aGVuKChzZXJ2aWNlTW9kdWxlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHNlcnZpY2VNb2R1bGUpIHtcclxuICAgICAgICAgICAgICBjb250cm9sbGVyTWFwLmltcG9ydHNbc2VydmljZVNwZWNpZmVyXSA9IHNlcnZpY2VNb2R1bGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5leGVjdXRlV2l0aFNlcnZpY2VNb2R1bGUoc2VydmljZU1vZHVsZSwgc2VydmljZU5hbWUsIGNvbnRleHQsIGFyZ3MsIG1ldGhvZCwgcmVzdWx0JCk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdCQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGV4ZWN1dGVXaXRoU2VydmljZU1vZHVsZShzZXJ2aWNlTW9kdWxlOiBhbnksIHNlcnZpY2VOYW1lOiBzdHJpbmcsIGNvbnRleHQ6IENvbW1hbmRDb250ZXh0LCBhcmdzOiBTdGFnZVBhcmFtW10sIG1ldGhvZDogc3RyaW5nLCByZXN1bHQkOiBTdWJqZWN0PHVua25vd24+KSB7XHJcbiAgICBjb25zdCBzZXJ2aWNlQ29uc3RydWN0b3IgPSBzZXJ2aWNlTW9kdWxlW3NlcnZpY2VOYW1lXTtcclxuICAgIGlmIChzZXJ2aWNlQ29uc3RydWN0b3IpIHtcclxuICAgICAgY29uc3Qgb3JpZ2luYWxDb250ZXh0SW5qZWN0b3IgPSBjb250ZXh0LmZyYW1lQ29udGV4dC5pbmplY3RvcjtcclxuICAgICAgbGV0IHNlcnZpY2VJbnN0YW5jZTtcclxuICAgICAgLy8gY29uc3QgcmVzb2x2ZWRSZWZsZWN0aXZlUHJvdmlkZXJzID0gUmVmbGVjdGl2ZUluamVjdG9yLnJlc29sdmUoW3sgcHJvdmlkZTogc2VydmljZU5hbWUsIHVzZUNsYXNzOiBzZXJ2aWNlQ29uc3RydWN0b3IgfV0pO1xyXG4gICAgICBpZiAoY29udGV4dC5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0KHNlcnZpY2VOYW1lLCBudWxsKSkge1xyXG4gICAgICAgIHNlcnZpY2VJbnN0YW5jZSA9IGNvbnRleHQuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldChzZXJ2aWNlTmFtZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgcmVzb2x2ZWRSZWZsZWN0aXZlUHJvdmlkZXJzID0gdGhpcy5sb2FkUHJvdmlkZXJzRnJvbU1vZHVsZShzZXJ2aWNlTW9kdWxlKTtcclxuICAgICAgICBjb25zdCByZWZsZWN0aXZlSW5qZWN0b3IgPSBSZWZsZWN0aXZlSW5qZWN0b3IuZnJvbVJlc29sdmVkUHJvdmlkZXJzKHJlc29sdmVkUmVmbGVjdGl2ZVByb3ZpZGVycywgY29udGV4dC5mcmFtZUNvbnRleHQuaW5qZWN0b3IpO1xyXG4gICAgICAgIGNvbnRleHQuZnJhbWVDb250ZXh0LmluamVjdG9yID0gcmVmbGVjdGl2ZUluamVjdG9yO1xyXG4gICAgICAgIHNlcnZpY2VJbnN0YW5jZSA9IHJlZmxlY3RpdmVJbmplY3Rvci5nZXQoc2VydmljZU5hbWUsIG51bGwpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoc2VydmljZUluc3RhbmNlKSB7XHJcbiAgICAgICAgdGhpcy5zZXRDb250ZXh0VG9TZXJ2aWNlSW5zdGFuY2Uoc2VydmljZUluc3RhbmNlLCBjb250ZXh0KTtcclxuICAgICAgICBjb25zdCBwYXJzZWRTdGFnZVBhcmFtcyA9IHRoaXMucGFyc2VTZXJ2aWNlLnBhcnNlKGFyZ3MsIGNvbnRleHQpIGFzIFN0YWdlUGFyYW1bXTtcclxuICAgICAgICBjb25zdCBwYXJzZWRBcmdzID0gcGFyc2VkU3RhZ2VQYXJhbXMubWFwKHBhcmFtID0+IHBhcmFtLmV4cHJlc3Npb24pO1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogYmFuLXR5cGVzXHJcbiAgICAgICAgY29uc3Qgc2VydmljZU1ldGhvZCA9IHNlcnZpY2VJbnN0YW5jZVttZXRob2RdIGFzIEZ1bmN0aW9uO1xyXG4gICAgICAgIGlmICghc2VydmljZU1ldGhvZCkge1xyXG4gICAgICAgICAgY29uc29sZS5lcnJvcihcIuacquaJvuWIsOWvueW6lOeahOWRveS7pDpcIiArIG1ldGhvZCk7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHNlcnZpY2VNZXRob2RSZXN1bHQgPSBzZXJ2aWNlTWV0aG9kLmFwcGx5KHNlcnZpY2VJbnN0YW5jZSwgcGFyc2VkQXJncyk7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0JCQgPSBpc09ic2VydmFibGUoc2VydmljZU1ldGhvZFJlc3VsdCkgPyBzZXJ2aWNlTWV0aG9kUmVzdWx0IDogb2Yoc2VydmljZU1ldGhvZFJlc3VsdCk7XHJcbiAgICAgICAgcmVzdWx0JCQuc3Vic2NyaWJlKHtcclxuICAgICAgICAgIG5leHQ6IChyZXN1bHQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICByZXN1bHQkLm5leHQocmVzdWx0KTtcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBlcnJvcjogKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgcmVzdWx0JC5lcnJvcihlcnJvcik7XHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgY29tcGxldGU6ICgpID0+IHtcclxuICAgICAgICAgICAgcmVzdWx0JC5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICBjb250ZXh0LmZyYW1lQ29udGV4dC5pbmplY3RvciA9IG9yaWdpbmFsQ29udGV4dEluamVjdG9yO1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9KTtcclxuICAgICAgICAvLyByZXR1cm4gc2VydmljZU1ldGhvZC5hcHBseShzZXJ2aWNlSW5zdGFuY2UsIHBhcnNlZEFyZ3MpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzY2hlZHVsZSgpIHtcclxuICAgIHRoaXMuc2NoZWR1bGVTdGFnZXModGhpcy5tZXRob2Quc3RhZ2VzLCBudWxsKTtcclxuICAgIC8vIHRoaXMubWV0aG9kLnN0YWdlcy5yZWR1Y2UoKHByZVN0YWdlOiBNZXRob2RTdGFnZSwgY3VycmVudFN0YWdlOiBNZXRob2RTdGFnZSkgPT4ge1xyXG4gICAgLy8gICBpZiAoY3VycmVudFN0YWdlLnR5cGUgPT09ICcwJykge1xyXG4gICAgLy8gICAgIHRoaXMuYWRkVGFzayhjdXJyZW50U3RhZ2UubmFtZSwgKGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSA9PiB7XHJcbiAgICAvLyAgICAgICByZXR1cm4gdGhpcy5keW5hbWljSW52b2tlMihjdXJyZW50U3RhZ2UgYXMgRXhlY3V0aW5nU3RhZ2UsIGNvbnRleHQpO1xyXG4gICAgLy8gICAgIH0pO1xyXG4gICAgLy8gICAgIGlmIChwcmVTdGFnZSkge1xyXG4gICAgLy8gICAgICAgdGhpcy5hZGRMaW5rKHByZVN0YWdlLm5hbWUsIGN1cnJlbnRTdGFnZS5uYW1lLCBgMT09PTFgKTtcclxuICAgIC8vICAgICB9XHJcbiAgICAvLyAgIH0gZWxzZSBpZiAoY3VycmVudFN0YWdlLnR5cGUgPT09ICcyJykge1xyXG5cclxuICAgIC8vICAgfSBlbHNlIHtcclxuICAgIC8vICAgICB0aHJvdyBuZXcgRXJyb3IoYHVua25vdyBtZXRob2Qgc3RhZ2UgdHlwZSwgdGhlICR7Y3VycmVudFN0YWdlLm5hbWV9J3MgdHlwZSBpcyAke2N1cnJlbnRTdGFnZS50eXBlfWApO1xyXG4gICAgLy8gICB9XHJcbiAgICAvLyAgIHJldHVybiBjdXJyZW50U3RhZ2U7XHJcbiAgICAvLyB9LCBudWxsKTtcclxuICB9XHJcblxyXG4gIHNjaGVkdWxlU3RhZ2VzKHN0YWdlczogTWV0aG9kU3RhZ2VbXSwgaW5pdGlhbFN0YWdlOiBNZXRob2RTdGFnZSkge1xyXG4gICAgc3RhZ2VzLnJlZHVjZSgocHJlU3RhZ2U6IE1ldGhvZFN0YWdlLCBjdXJyZW50U3RhZ2U6IE1ldGhvZFN0YWdlKSA9PiB7XHJcbiAgICAgIGlmIChjdXJyZW50U3RhZ2UudHlwZSA9PT0gJ2V4ZWN1dGluZycpIHtcclxuICAgICAgICB0aGlzLmFkZFRhc2soY3VycmVudFN0YWdlLm5hbWUsIChjb250ZXh0OiBDb21tYW5kQ29udGV4dCkgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIHRoaXMuZHluYW1pY0ludm9rZTIoY3VycmVudFN0YWdlIGFzIEV4ZWN1dGluZ1N0YWdlLCBjb250ZXh0KTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSBlbHNlIGlmIChjdXJyZW50U3RhZ2UudHlwZSA9PT0gJ2ZvcmsnKSB7XHJcbiAgICAgICAgY29uc3QgZm9ya1N0YWdlcyA9IChjdXJyZW50U3RhZ2UgYXMgRm9ya1N0YWdlKS5zdGFnZXM7XHJcbiAgICAgICAgZm9ya1N0YWdlcy5mb3JFYWNoKGZvcmtTdGFnZSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnNjaGVkdWxlU3RhZ2VzKGZvcmtTdGFnZS5zdGFnZXMsIGZvcmtTdGFnZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5zY2hlZHVsZVN0YWdlcygoY3VycmVudFN0YWdlIGFzIERldGVybWluaW5nU3RhZ2UpLnN0YWdlcywgY3VycmVudFN0YWdlKTtcclxuICAgICAgfSBlbHNlIGlmIChjdXJyZW50U3RhZ2UudHlwZSA9PT0gJ2RldGVybWluZycpIHtcclxuICAgICAgICB0aGlzLmFkZFRhc2soY3VycmVudFN0YWdlLm5hbWUsIChjb250ZXh0OiBDb21tYW5kQ29udGV4dCkgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgdW5rbm93IG1ldGhvZCBzdGFnZSB0eXBlLCB0aGUgJHtjdXJyZW50U3RhZ2UubmFtZX0ncyB0eXBlIGlzICR7Y3VycmVudFN0YWdlLnR5cGV9YCk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHByZVN0YWdlKSB7XHJcbiAgICAgICAgY29uc3QgY29uZGl0aW9uID0gcHJlU3RhZ2UudHlwZSA9PT0gJ2RldGVybWluZycgPyAocHJlU3RhZ2UgYXMgRGV0ZXJtaW5pbmdTdGFnZSkuY29uZGl0aW9uIDogYDE9PT0xYDtcclxuICAgICAgICB0aGlzLmFkZExpbmsocHJlU3RhZ2UubmFtZSwgY3VycmVudFN0YWdlLm5hbWUsIGNvbmRpdGlvbik7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGN1cnJlbnRTdGFnZTtcclxuICAgIH0sIGluaXRpYWxTdGFnZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGxvYWRQcm92aWRlcnNGcm9tTW9kdWxlKHNlcnZpY2VNb2R1bGU6IHsgW3Byb3BlcnR5TmFtZTogc3RyaW5nXTogYW55IH0pIHtcclxuICAgIGNvbnN0IHByb3ZpZGVyQXJyYXkgPSBbXTtcclxuICAgIGZvciAoY29uc3QgcHJvcGVydHlOYW1lIGluIHNlcnZpY2VNb2R1bGUpIHtcclxuICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzZXJ2aWNlTW9kdWxlLCBwcm9wZXJ0eU5hbWUpKSB7XHJcbiAgICAgICAgY29uc3QgcHJvcGVydHlWYWx1ZSA9IHNlcnZpY2VNb2R1bGVbcHJvcGVydHlOYW1lXTtcclxuICAgICAgICBpZiAodGhpcy5pc0luamVjdGFibGVTZXJ2aWNlKHByb3BlcnR5VmFsdWUpKSB7XHJcbiAgICAgICAgICAvLyBjb25zdCBwcm92aWRlck5hbWUgPSBwcm9wZXJ0eVZhbHVlLm5hbWUgPT09ICdlJyA/IHByb3BlcnR5TmFtZSA6IHByb3BlcnR5VmFsdWUubmFtZTtcclxuICAgICAgICAgIGNvbnN0IHByb3ZpZGVyTmFtZSA9IHByb3BlcnR5TmFtZTtcclxuICAgICAgICAgIHByb3ZpZGVyQXJyYXkucHVzaCh7IHByb3ZpZGU6IHByb3ZpZGVyTmFtZSwgdXNlQ2xhc3M6IHByb3BlcnR5VmFsdWUgfSk7XHJcbiAgICAgICAgICBwcm92aWRlckFycmF5LnB1c2gocHJvcGVydHlWYWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXNvbHZlZFJlZmxlY3RpdmVQcm92aWRlcnMgPSBSZWZsZWN0aXZlSW5qZWN0b3IucmVzb2x2ZShwcm92aWRlckFycmF5KTtcclxuICAgIHJldHVybiByZXNvbHZlZFJlZmxlY3RpdmVQcm92aWRlcnM7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGlzSW5qZWN0YWJsZVNlcnZpY2UocHJvcGVydHlWYWx1ZTogYW55KSB7XHJcbiAgICBsZXQgaGFzSW5qZWN0YWJsZURlY29yYXRvciA9IGZhbHNlO1xyXG4gICAgY29uc3QgaXNGdW5jdGlvbiA9IHByb3BlcnR5VmFsdWUgaW5zdGFuY2VvZiBGdW5jdGlvbjtcclxuICAgIGlmIChpc0Z1bmN0aW9uICYmIHByb3BlcnR5VmFsdWUuaGFzT3duUHJvcGVydHkoJ2RlY29yYXRvcnMnKSkge1xyXG4gICAgICBjb25zdCBkZWNvcmF0b3JzID0gcHJvcGVydHlWYWx1ZS5kZWNvcmF0b3JzIGFzIGFueVtdO1xyXG4gICAgICBjb25zdCBpbmplY3RhYmxlRGVjb3JhdG9ycyA9IGRlY29yYXRvcnMuZmlsdGVyKGRlY29yYXRvciA9PiB7XHJcbiAgICAgICAgaWYgKGRlY29yYXRvci50eXBlICYmIGRlY29yYXRvci50eXBlLnByb3RvdHlwZSAmJiBkZWNvcmF0b3IudHlwZS5wcm90b3R5cGUubmdNZXRhZGF0YU5hbWUgPT09ICdJbmplY3RhYmxlJykge1xyXG4gICAgICAgICAgcmV0dXJuIGRlY29yYXRvcjtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICBoYXNJbmplY3RhYmxlRGVjb3JhdG9yID0gaW5qZWN0YWJsZURlY29yYXRvcnMgJiYgaW5qZWN0YWJsZURlY29yYXRvcnMubGVuZ3RoID4gMDtcclxuICAgIH0gZWxzZSBpZiAoaXNGdW5jdGlvbiAmJiBwcm9wZXJ0eVZhbHVlLmhhc093blByb3BlcnR5KCdfX2Fubm90YXRpb25zX18nKSkge1xyXG4gICAgICBjb25zdCBkZWNvcmF0b3JzID0gcHJvcGVydHlWYWx1ZS5fX2Fubm90YXRpb25zX18gYXMgYW55W107XHJcbiAgICAgIGNvbnN0IGluamVjdGFibGVEZWNvcmF0b3JzID0gZGVjb3JhdG9ycy5maWx0ZXIoZGVjb3JhdG9yRmFjdG9yeSA9PiB7XHJcbiAgICAgICAgaWYgKGRlY29yYXRvckZhY3RvcnkgJiYgZGVjb3JhdG9yRmFjdG9yeS5uZ01ldGFkYXRhTmFtZSAmJiBkZWNvcmF0b3JGYWN0b3J5Lm5nTWV0YWRhdGFOYW1lID09PSAnSW5qZWN0YWJsZScpIHtcclxuICAgICAgICAgIHJldHVybiBkZWNvcmF0b3JGYWN0b3J5O1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIGhhc0luamVjdGFibGVEZWNvcmF0b3IgPSBpbmplY3RhYmxlRGVjb3JhdG9ycyAmJiBpbmplY3RhYmxlRGVjb3JhdG9ycy5sZW5ndGggPiAwO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGhhc0luamVjdGFibGVEZWNvcmF0b3I7XHJcbiAgfVxyXG59XHJcbiJdfQ==