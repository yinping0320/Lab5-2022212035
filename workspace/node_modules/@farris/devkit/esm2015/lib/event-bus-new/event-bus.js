import { Injectable, Type } from '@angular/core';
import { EventBusProxy } from './event-bus-proxy';
import { EventPipe } from './event-pipe';
export class EventBus {
    constructor() {
        this.proxyMap = new Map();
        this.eventMap = new Map();
    }
    getProxy(ownerType, eventTokenValueProvider) {
        const ownerName = ownerType.constructor.typeName || ownerType.constructor.name;
        if (!this.proxyMap.has(ownerName)) {
            this.proxyMap.set(ownerName, new EventBusProxy(this, ownerType, eventTokenValueProvider));
        }
        return this.proxyMap.get(ownerName);
    }
    /**
     * 发送事件，通知订阅者接收消息。
     */
    // tslint:disable-next-line: max-line-length
    post(emitterType, tokenValue, eventName, eventArgs, sender, eventType, eventId) {
        const eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            return;
        }
        if (!emitterType) {
            console.error('post方法的参数emitterType不能为空。');
            return;
        }
        let emitter;
        if (emitterType instanceof Type) {
            emitter = emitterType.typeName || emitterType.name;
        }
        else {
            emitter = emitterType;
        }
        if (typeof eventId === 'undefined') {
            eventId = new Date().valueOf();
        }
        for (const eventPipe of eventPipeList) {
            if (eventPipe.matchEmitterToken(emitter, tokenValue)) {
                eventPipe.post(eventArgs, sender, eventType, eventId);
                eventPipe.unSubscribeForOnce();
            }
        }
    }
    /**
     * 订阅事件
     */
    on(target, tokenValue, eventName, caller, handler) {
        return this.getEventPipe(eventName, target, tokenValue).subscribe(handler, caller);
    }
    /**
     * 注销监听
     * @param target
     * @param tokenValue
     * @param eventName
     * @param caller
     */
    off(target, tokenValue, eventName, caller) {
        const eventPipeList = this.eventMap.get(eventName);
        if (eventPipeList) {
            const index = eventPipeList.findIndex((eventPipe) => {
                if (eventPipe.subscriptions.get(caller)) {
                    return eventPipe.name === eventName && eventPipe.tokenValue === tokenValue && eventPipe.emitter === target;
                }
                return false;
            });
            if (index !== -1) {
                eventPipeList.splice(index, 1);
            }
        }
    }
    /**
     * 订阅一次。接收到一次消息之后自动取消订阅
     */
    once(target, tokenValue, eventName, caller, handler) {
        return this.getEventPipe(eventName, target, tokenValue).subscribeOnce(handler, caller);
    }
    /**
     * 发送一个请求事件，获取监听者的响应并处理
     */
    requestFor(target, tokenValue, requestName, requestValue, success, fail) {
        const eventPipe = this.findExistEventPipe(requestName, 'RequestSubject', tokenValue);
        if (eventPipe) {
            this.once(target, tokenValue, requestName, this, (response) => {
                if (response.status === 'success') {
                    success(response.data);
                }
                else {
                    if (fail) {
                        fail('No target responser listening');
                    }
                }
            });
            eventPipe.post({ target: target, token: tokenValue, data: requestValue });
        }
        else {
            if (fail) {
                fail('No target responser listening.');
            }
        }
    }
    /**
     * 监听一个请求事件，给出响应
     */
    responseOn(responseSubject, requestName, callback) {
        this.on('RequestSubject', null, requestName, this, (requestObj) => {
            const response = { status: 'fail', data: null };
            if (responseSubject === requestObj.target) {
                response.data = callback(requestObj.data);
                response.status = 'success';
            }
            this.post(requestObj.target, requestObj.token, requestName, response);
        });
    }
    getEventPipe(eventName, target, tokenValue) {
        let eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            eventPipeList = new Array();
            this.eventMap.set(eventName, eventPipeList);
        }
        // 1、一个事件不允许多个订阅
        // let eventPipe = eventPipeList.find(item => item.examByTargetToken(target, tokenValue));
        // if (!eventPipe) {
        //   eventPipe = new EventPipe(eventName, tokenValue, target, eventPipeList);
        // }
        // 2、一个事件允许多个订阅
        const eventPipe = new EventPipe(eventName, tokenValue, target, eventPipeList);
        return eventPipe;
    }
    findExistEventPipe(eventName, target, tokenValue) {
        const eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            return null;
        }
        // return eventPipeList.find(item => item.examByTargetToken(target, tokenValue));
        for (const eventPipe of eventPipeList) {
            if (eventPipe.matchEmitterToken(target, tokenValue)) {
                return eventPipe;
            }
        }
        return null;
    }
}
EventBus.decorators = [
    { type: Injectable }
];
/** @nocollapse */
EventBus.ctorParameters = () => [];
export class EventCache {
    static setToken(key, value) {
        EventCache.tokens.set(key, value);
    }
    static getToken(key) {
        return EventCache.tokens.get(key);
    }
}
EventCache.tokens = new Map();
class RequestSubject {
}
class DataClass {
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQtYnVzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZXZlbnQtYnVzLW5ldy9ldmVudC1idXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDakQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRWxELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFJekMsTUFBTSxPQUFPLFFBQVE7SUFJbkI7UUFDRSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksR0FBRyxFQUF5QixDQUFDO1FBQ2pELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQTRCLENBQUM7SUFDdEQsQ0FBQztJQUVELFFBQVEsQ0FBQyxTQUFjLEVBQUUsdUJBQWtDO1FBQ3pELE1BQU0sU0FBUyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsUUFBUSxJQUFJLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO1FBQy9FLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUNqQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsSUFBSSxhQUFhLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSx1QkFBdUIsQ0FBQyxDQUFDLENBQUM7U0FDM0Y7UUFDRCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFRDs7T0FFRztJQUNILDRDQUE0QztJQUM1QyxJQUFJLENBQUMsV0FBeUIsRUFBRSxVQUFrQixFQUFFLFNBQWlCLEVBQUUsU0FBYyxFQUFFLE1BQVksRUFBRSxTQUFlLEVBQUUsT0FBZ0I7UUFDcEksTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FB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R0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7O0FBUmMsaUJBQU0sR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBV3BDLE1BQU0sY0FBYztDQUFJO0FBQ3hCLE1BQU0sU0FBUztDQUFJIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgVHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBFdmVudEJ1c1Byb3h5IH0gZnJvbSAnLi9ldmVudC1idXMtcHJveHknO1xyXG5pbXBvcnQgeyBJRW1pdGFibGUgfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgRXZlbnRQaXBlIH0gZnJvbSAnLi9ldmVudC1waXBlJztcclxuaW1wb3J0IHsgSURpc3Bvc2FibGUgfSBmcm9tICcuLi9jb3JlL2luZGV4JztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEV2ZW50QnVzIGltcGxlbWVudHMgSUVtaXRhYmxlIHtcclxuICBwcml2YXRlIHByb3h5TWFwOiBNYXA8c3RyaW5nLCBFdmVudEJ1c1Byb3h5PjtcclxuICBwcml2YXRlIGV2ZW50TWFwOiBNYXA8c3RyaW5nLCBBcnJheTxFdmVudFBpcGU+PjtcclxuXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICB0aGlzLnByb3h5TWFwID0gbmV3IE1hcDxzdHJpbmcsIEV2ZW50QnVzUHJveHk+KCk7XHJcbiAgICB0aGlzLmV2ZW50TWFwID0gbmV3IE1hcDxzdHJpbmcsIEFycmF5PEV2ZW50UGlwZT4+KCk7XHJcbiAgfVxyXG5cclxuICBnZXRQcm94eShvd25lclR5cGU6IGFueSwgZXZlbnRUb2tlblZhbHVlUHJvdmlkZXI6ICgpID0+IGFueSk6IEV2ZW50QnVzUHJveHkge1xyXG4gICAgY29uc3Qgb3duZXJOYW1lID0gb3duZXJUeXBlLmNvbnN0cnVjdG9yLnR5cGVOYW1lIHx8IG93bmVyVHlwZS5jb25zdHJ1Y3Rvci5uYW1lO1xyXG4gICAgaWYgKCF0aGlzLnByb3h5TWFwLmhhcyhvd25lck5hbWUpKSB7XHJcbiAgICAgIHRoaXMucHJveHlNYXAuc2V0KG93bmVyTmFtZSwgbmV3IEV2ZW50QnVzUHJveHkodGhpcywgb3duZXJUeXBlLCBldmVudFRva2VuVmFsdWVQcm92aWRlcikpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMucHJveHlNYXAuZ2V0KG93bmVyTmFtZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlj5HpgIHkuovku7bvvIzpgJrnn6XorqLpmIXogIXmjqXmlLbmtojmga/jgIJcclxuICAgKi9cclxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1heC1saW5lLWxlbmd0aFxyXG4gIHBvc3QoZW1pdHRlclR5cGU6IGFueSB8IHN0cmluZywgdG9rZW5WYWx1ZTogc3RyaW5nLCBldmVudE5hbWU6IHN0cmluZywgZXZlbnRBcmdzOiBhbnksIHNlbmRlcj86IGFueSwgZXZlbnRUeXBlPzogYW55LCBldmVudElkPzogbnVtYmVyKTogdm9pZCB7XHJcbiAgICBjb25zdCBldmVudFBpcGVMaXN0ID0gdGhpcy5ldmVudE1hcC5nZXQoZXZlbnROYW1lKTtcclxuICAgIGlmICghZXZlbnRQaXBlTGlzdCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFlbWl0dGVyVHlwZSkge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdwb3N05pa55rOV55qE5Y+C5pWwZW1pdHRlclR5cGXkuI3og73kuLrnqbrjgIInKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgbGV0IGVtaXR0ZXI6IHN0cmluZztcclxuICAgIGlmIChlbWl0dGVyVHlwZSBpbnN0YW5jZW9mIFR5cGUpIHtcclxuICAgICAgZW1pdHRlciA9IGVtaXR0ZXJUeXBlLnR5cGVOYW1lIHx8IGVtaXR0ZXJUeXBlLm5hbWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBlbWl0dGVyID0gZW1pdHRlclR5cGU7XHJcbiAgICB9XHJcbiAgICBpZiAodHlwZW9mIGV2ZW50SWQgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIGV2ZW50SWQgPSBuZXcgRGF0ZSgpLnZhbHVlT2YoKTtcclxuICAgIH1cclxuICAgIGZvciAoY29uc3QgZXZlbnRQaXBlIG9mIGV2ZW50UGlwZUxpc3QpIHtcclxuICAgICAgaWYgKGV2ZW50UGlwZS5tYXRjaEVtaXR0ZXJUb2tlbihlbWl0dGVyLCB0b2tlblZhbHVlKSkge1xyXG4gICAgICAgIGV2ZW50UGlwZS5wb3N0KGV2ZW50QXJncywgc2VuZGVyLCBldmVudFR5cGUsIGV2ZW50SWQpO1xyXG4gICAgICAgIGV2ZW50UGlwZS51blN1YnNjcmliZUZvck9uY2UoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6i6ZiF5LqL5Lu2XHJcbiAgICovXHJcbiAgb24odGFyZ2V0OiBzdHJpbmcsIHRva2VuVmFsdWU6IHN0cmluZywgZXZlbnROYW1lOiBzdHJpbmcsIGNhbGxlcjogT2JqZWN0LCBoYW5kbGVyOiAodmFsdWU6IGFueSkgPT4gdm9pZCk6IElEaXNwb3NhYmxlIHtcclxuICAgIHJldHVybiB0aGlzLmdldEV2ZW50UGlwZShldmVudE5hbWUsIHRhcmdldCwgdG9rZW5WYWx1ZSkuc3Vic2NyaWJlKGhhbmRsZXIsIGNhbGxlcik7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDms6jplIDnm5HlkKxcclxuICAgKiBAcGFyYW0gdGFyZ2V0IFxyXG4gICAqIEBwYXJhbSB0b2tlblZhbHVlIFxyXG4gICAqIEBwYXJhbSBldmVudE5hbWUgXHJcbiAgICogQHBhcmFtIGNhbGxlciBcclxuICAgKi9cclxuICBwdWJsaWMgb2ZmKHRhcmdldDogc3RyaW5nLCB0b2tlblZhbHVlOiBzdHJpbmcsIGV2ZW50TmFtZTogc3RyaW5nLCBjYWxsZXI6IE9iamVjdCkge1xyXG4gICAgY29uc3QgZXZlbnRQaXBlTGlzdCA9IHRoaXMuZXZlbnRNYXAuZ2V0KGV2ZW50TmFtZSk7XHJcbiAgICBpZiAoZXZlbnRQaXBlTGlzdCkge1xyXG4gICAgICBjb25zdCBpbmRleCA9IGV2ZW50UGlwZUxpc3QuZmluZEluZGV4KChldmVudFBpcGU6IEV2ZW50UGlwZSkgPT4ge1xyXG4gICAgICAgIGlmIChldmVudFBpcGUuc3Vic2NyaXB0aW9ucy5nZXQoY2FsbGVyKSkge1xyXG4gICAgICAgICAgcmV0dXJuIGV2ZW50UGlwZS5uYW1lID09PSBldmVudE5hbWUgJiYgZXZlbnRQaXBlLnRva2VuVmFsdWUgPT09IHRva2VuVmFsdWUgJiYgZXZlbnRQaXBlLmVtaXR0ZXIgPT09IHRhcmdldDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9KTtcclxuICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xyXG4gICAgICAgIGV2ZW50UGlwZUxpc3Quc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDorqLpmIXkuIDmrKHjgILmjqXmlLbliLDkuIDmrKHmtojmga/kuYvlkI7oh6rliqjlj5bmtojorqLpmIVcclxuICAgKi9cclxuICBvbmNlKHRhcmdldDogc3RyaW5nLCB0b2tlblZhbHVlOiBzdHJpbmcsIGV2ZW50TmFtZTogc3RyaW5nLCBjYWxsZXI6IE9iamVjdCwgaGFuZGxlcjogKHZhbHVlOiBhbnkpID0+IHZvaWQpOiBJRGlzcG9zYWJsZSB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRFdmVudFBpcGUoZXZlbnROYW1lLCB0YXJnZXQsIHRva2VuVmFsdWUpLnN1YnNjcmliZU9uY2UoaGFuZGxlciwgY2FsbGVyKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWPkemAgeS4gOS4quivt+axguS6i+S7tu+8jOiOt+WPluebkeWQrOiAheeahOWTjeW6lOW5tuWkhOeQhlxyXG4gICAqL1xyXG4gIHJlcXVlc3RGb3IodGFyZ2V0OiBzdHJpbmcsIHRva2VuVmFsdWU6IHN0cmluZywgcmVxdWVzdE5hbWU6IHN0cmluZywgcmVxdWVzdFZhbHVlOiBhbnksIHN1Y2Nlc3M6IChhbnkpID0+IGFueSwgZmFpbD86IChzdHJpbmcpID0+IGFueSkge1xyXG4gICAgY29uc3QgZXZlbnRQaXBlID0gdGhpcy5maW5kRXhpc3RFdmVudFBpcGUocmVxdWVzdE5hbWUsICdSZXF1ZXN0U3ViamVjdCcsIHRva2VuVmFsdWUpO1xyXG4gICAgaWYgKGV2ZW50UGlwZSkge1xyXG4gICAgICB0aGlzLm9uY2UodGFyZ2V0LCB0b2tlblZhbHVlLCByZXF1ZXN0TmFtZSwgdGhpcywgKHJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gJ3N1Y2Nlc3MnKSB7XHJcbiAgICAgICAgICBzdWNjZXNzKHJlc3BvbnNlLmRhdGEpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBpZiAoZmFpbCkge1xyXG4gICAgICAgICAgICBmYWlsKCdObyB0YXJnZXQgcmVzcG9uc2VyIGxpc3RlbmluZycpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIGV2ZW50UGlwZS5wb3N0KHsgdGFyZ2V0OiB0YXJnZXQsIHRva2VuOiB0b2tlblZhbHVlLCBkYXRhOiByZXF1ZXN0VmFsdWUgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAoZmFpbCkge1xyXG4gICAgICAgIGZhaWwoJ05vIHRhcmdldCByZXNwb25zZXIgbGlzdGVuaW5nLicpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDnm5HlkKzkuIDkuKror7fmsYLkuovku7bvvIznu5nlh7rlk43lupRcclxuICAgKi9cclxuICByZXNwb25zZU9uKHJlc3BvbnNlU3ViamVjdDogc3RyaW5nLCByZXF1ZXN0TmFtZTogc3RyaW5nLCBjYWxsYmFjazogKGFueSkgPT4gYW55KSB7XHJcbiAgICB0aGlzLm9uKCdSZXF1ZXN0U3ViamVjdCcsIG51bGwsIHJlcXVlc3ROYW1lLCB0aGlzLCAocmVxdWVzdE9iaikgPT4ge1xyXG4gICAgICBjb25zdCByZXNwb25zZSA9IHsgc3RhdHVzOiAnZmFpbCcsIGRhdGE6IG51bGwgfTtcclxuICAgICAgaWYgKHJlc3BvbnNlU3ViamVjdCA9PT0gcmVxdWVzdE9iai50YXJnZXQpIHtcclxuICAgICAgICByZXNwb25zZS5kYXRhID0gY2FsbGJhY2socmVxdWVzdE9iai5kYXRhKTtcclxuICAgICAgICByZXNwb25zZS5zdGF0dXMgPSAnc3VjY2Vzcyc7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5wb3N0KHJlcXVlc3RPYmoudGFyZ2V0LCByZXF1ZXN0T2JqLnRva2VuLCByZXF1ZXN0TmFtZSwgcmVzcG9uc2UpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEV2ZW50UGlwZShldmVudE5hbWU6IHN0cmluZywgdGFyZ2V0OiBzdHJpbmcsIHRva2VuVmFsdWU6IHN0cmluZykge1xyXG4gICAgbGV0IGV2ZW50UGlwZUxpc3QgPSB0aGlzLmV2ZW50TWFwLmdldChldmVudE5hbWUpO1xyXG4gICAgaWYgKCFldmVudFBpcGVMaXN0KSB7XHJcbiAgICAgIGV2ZW50UGlwZUxpc3QgPSBuZXcgQXJyYXk8RXZlbnRQaXBlPigpO1xyXG4gICAgICB0aGlzLmV2ZW50TWFwLnNldChldmVudE5hbWUsIGV2ZW50UGlwZUxpc3QpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIDHjgIHkuIDkuKrkuovku7bkuI3lhYHorrjlpJrkuKrorqLpmIVcclxuICAgIC8vIGxldCBldmVudFBpcGUgPSBldmVudFBpcGVMaXN0LmZpbmQoaXRlbSA9PiBpdGVtLmV4YW1CeVRhcmdldFRva2VuKHRhcmdldCwgdG9rZW5WYWx1ZSkpO1xyXG4gICAgLy8gaWYgKCFldmVudFBpcGUpIHtcclxuICAgIC8vICAgZXZlbnRQaXBlID0gbmV3IEV2ZW50UGlwZShldmVudE5hbWUsIHRva2VuVmFsdWUsIHRhcmdldCwgZXZlbnRQaXBlTGlzdCk7XHJcbiAgICAvLyB9XHJcblxyXG4gICAgLy8gMuOAgeS4gOS4quS6i+S7tuWFgeiuuOWkmuS4quiuoumYhVxyXG4gICAgY29uc3QgZXZlbnRQaXBlID0gbmV3IEV2ZW50UGlwZShldmVudE5hbWUsIHRva2VuVmFsdWUsIHRhcmdldCwgZXZlbnRQaXBlTGlzdCk7XHJcblxyXG4gICAgcmV0dXJuIGV2ZW50UGlwZTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZmluZEV4aXN0RXZlbnRQaXBlKGV2ZW50TmFtZTogc3RyaW5nLCB0YXJnZXQ6IHN0cmluZywgdG9rZW5WYWx1ZTogc3RyaW5nKTogRXZlbnRQaXBlIHtcclxuICAgIGNvbnN0IGV2ZW50UGlwZUxpc3QgPSB0aGlzLmV2ZW50TWFwLmdldChldmVudE5hbWUpO1xyXG4gICAgaWYgKCFldmVudFBpcGVMaXN0KSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgLy8gcmV0dXJuIGV2ZW50UGlwZUxpc3QuZmluZChpdGVtID0+IGl0ZW0uZXhhbUJ5VGFyZ2V0VG9rZW4odGFyZ2V0LCB0b2tlblZhbHVlKSk7XHJcbiAgICBmb3IgKGNvbnN0IGV2ZW50UGlwZSBvZiBldmVudFBpcGVMaXN0KSB7XHJcbiAgICAgIGlmIChldmVudFBpcGUubWF0Y2hFbWl0dGVyVG9rZW4odGFyZ2V0LCB0b2tlblZhbHVlKSkge1xyXG4gICAgICAgIHJldHVybiBldmVudFBpcGU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEV2ZW50Q2FjaGUge1xyXG4gIHByaXZhdGUgc3RhdGljIHRva2VucyA9IG5ldyBNYXAoKTtcclxuXHJcbiAgcHVibGljIHN0YXRpYyBzZXRUb2tlbihrZXk6IHN0cmluZywgdmFsdWU6IGFueSkge1xyXG4gICAgRXZlbnRDYWNoZS50b2tlbnMuc2V0KGtleSwgdmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHN0YXRpYyBnZXRUb2tlbihrZXk6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIEV2ZW50Q2FjaGUudG9rZW5zLmdldChrZXkpO1xyXG4gIH1cclxufVxyXG5cclxuY2xhc3MgUmVxdWVzdFN1YmplY3QgeyB9XHJcbmNsYXNzIERhdGFDbGFzcyB7IH1cclxuIl19