import { Subject } from 'rxjs';
import { EventTypeEnum } from '../event-mechanism';
import { EventPipeType } from './event-pipe-type';
export class EventPipe {
    constructor(name, tokenValue, emitter, parentEventPipeList) {
        this.name = name;
        this.tokenValue = tokenValue;
        this.emitter = emitter;
        this.parentEventPipeList = parentEventPipeList;
        this.lastEventId = -1;
        /**
         * EventPipe类型，编译类型表单检查是否在同一上下文中，解析类型表单不判断
         */
        this.eventPipeType = EventPipeType.Compile;
        this.eventSubject = new Subject();
        this.subscriptionMap = new Map();
        this.onceSubscriptionMap = new Map();
        if (this.parentEventPipeList) {
            this.parentEventPipeList.push(this);
        }
    }
    get subscriptions() {
        return this.subscriptionMap;
    }
    /**
     * 发送事件
     */
    post(args, sender, eventType, eventId) {
        const eventData = {
            args: args,
            sender: sender,
            eventType,
            eventId
        };
        this.eventSubject.next(eventData);
    }
    /**
     * 订阅事件
     */
    subscribe(eventHandler, receiver) {
        // 对于弹窗，caller是弹窗中的组件，每次caller不同，但还是会重复注册。
        // 重复订阅检测
        const subscriptionInMap = this.subscriptionMap.get(receiver);
        if (subscriptionInMap != null) {
            subscriptionInMap.unsubscribe();
            this.subscriptionMap.delete(receiver);
        }
        const subscription = this.eventSubject.subscribe((eventData) => {
            const args = eventData.args;
            const sender = eventData.sender;
            const eventType = eventData.eventType || null;
            const eventId = eventData.eventId || 0;
            if (this.lastEventId >= eventId) {
                return;
            }
            this.lastEventId = eventId;
            // 判断sender和receiver的关系，如果在同一个AppContext或者在在一棵树上，则处理
            // 该判断主要解决SPA模式下，一个页面被打开多次的场景。
            if (!(eventType === EventTypeEnum.ROUTE)) {
                if (this.isInSampeScope(sender, receiver) === false) {
                    return;
                }
            }
            eventHandler.call(receiver, args);
        });
        this.subscriptionMap.set(receiver, subscription);
        return this;
    }
    subscribeOnce(eventHandler, caller) {
        const subscription = this.eventSubject.subscribe((value) => eventHandler.call(caller, value));
        this.onceSubscriptionMap.set(caller, subscription);
        return this;
    }
    unSubscribe(subscriber) {
        let subscription = this.subscriptionMap.get(subscriber);
        if (subscription) {
            subscription.unsubscribe();
            subscription = null;
            this.subscriptionMap.delete(subscriber);
        }
        else {
            subscription = this.onceSubscriptionMap.get(subscriber);
            if (subscription) {
                subscription.unsubscribe();
                subscription = null;
                this.onceSubscriptionMap.delete(subscriber);
            }
        }
    }
    // 注销使用once方法注册的订阅。
    unSubscribeForOnce() {
        for (const subscriber of Array.from(this.onceSubscriptionMap.keys())) {
            this.unSubscribe(subscriber);
        }
    }
    matchEmitterToken(emitter, tokenValue) {
        if (this.emitter && emitter && this.emitter !== emitter) {
            return false;
        }
        if (this.tokenValue && tokenValue && this.tokenValue !== tokenValue) {
            return false;
        }
        return true;
    }
    examByTargetToken(target, tokenValue) {
        if (this.emitter !== target) {
            return false;
        }
        if (this.tokenValue !== tokenValue) {
            return false;
        }
        return true;
    }
    dispose(subscriber) {
        this.unSubscribe(subscriber);
        if (this.subscriptionMap.size === 0 && this.parentEventPipeList) {
            const location = this.parentEventPipeList.findIndex(item => item === this);
            if (location !== -1) {
                this.parentEventPipeList.splice(location, 1);
            }
        }
    }
    /**
     * 根据caller进行注销
     */
    disposeByCaller(caller) {
        const subscriptionInMap = this.subscriptionMap.get(caller);
        if (subscriptionInMap != null) {
            subscriptionInMap.unsubscribe();
            this.subscriptionMap.delete(caller);
        }
    }
    /**
     * 检查是否在同一个上下文中
     * @todo
     * 1、强识别了sender和receiver的结构来判断，不合理；
     * 2、应该声明一个接口来约束结构。
     */
    isInSampeScope(sender, receiver) {
        // 用来区分编译类型的表单，还是解析类型的表单
        if (this.eventPipeType === EventPipeType.Parsing) {
            return true;
        }
        // 兼容老代码，sender不存在时，不进行检测
        if (!sender) {
            return true;
        }
        // 异常处理场景
        if (sender === receiver) {
            return true;
        }
        // 判断是否是FrameContext
        if (!sender.context || !sender.context.appContext ||
            !receiver.context || !receiver.context.appContext) {
            return false;
        }
        const senderAppContext = sender.context.appContext;
        const receiverAppContext = receiver.context.appContext;
        // 情况1：现状
        // 对于老表单，在模块上注入了一个AppContext；
        // 组合表单中主表单的root-component（被组合的表单的root-componetn上没有注入）上注入了AppContext
        // SPA模式下，如法通过Root AppContext区分，是不是同一个菜单内的事件；
        // 只能判断根组件上的AppContext来判断
        // 判断根AppContext是否一致
        if (senderAppContext === receiverAppContext) {
            return true;
        }
        // 情况2：注入改造后
        // 如果以后注入关系改造了，模块上的AppContext移除掉
        // 组合表单中每个root-component都拥有一个AppContext;
        // 组合表单中主表单的root-component的AppContext为Root AppContext
        // if (senderAppContext.root === receiverAppContext.root) {
        //   return true;
        // }
        // 情况3：注入改造后老表单兼容
        // 如果以后注入关系改造了，但产品部没有重新编译;
        // 和情况2类似，不同的是模块上还遗留了一个AppContext；
        // 此时Root Appcontext还是模块上的，如何来判断？
        // 1、考虑通过sender的injector一直网上找，找到模块之前的那个组件injector，从其中拿AppContext来判断；
        // 2、找一个全部重新编译的时机再改造。
        if ((senderAppContext.useIsoluteEventBus && senderAppContext.isoluteEventBus) ||
            (receiverAppContext.useIsoluteEventBus && receiverAppContext.isoluteEventBus)) {
            // 如果存在独立加载js  那么
            return true;
        }
        return false;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQtcGlwZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2V2ZW50LWJ1cy1uZXcvZXZlbnQtcGlwZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFnQixNQUFNLE1BQU0sQ0FBQztBQUU3QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDbkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRWxELE1BQU0sT0FBTyxTQUFTO0lBMEJwQixZQUNTLElBQVksRUFDWixVQUFrQixFQUNsQixPQUFlLEVBQ2QsbUJBQXFDO1FBSHRDLFNBQUksR0FBSixJQUFJLENBQVE7UUFDWixlQUFVLEdBQVYsVUFBVSxDQUFRO1FBQ2xCLFlBQU8sR0FBUCxPQUFPLENBQVE7UUFDZCx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQWtCO1FBN0J2QyxnQkFBVyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBa0J6Qjs7V0FFRztRQUNJLGtCQUFhLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FBQztRQVUzQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksT0FBTyxFQUFPLENBQUM7UUFDdkMsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLEdBQUcsRUFBd0IsQ0FBQztRQUN2RCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxHQUFHLEVBQXdCLENBQUM7UUFDM0QsSUFBSSxJQUFJLENBQUMsbUJBQW1CLEVBQUU7WUFDNUIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNyQztJQUNILENBQUM7SUFmRCxJQUFXLGFBQWE7UUFDdEIsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDO0lBQzlCLENBQUM7SUFlRDs7T0FFRztJQUNILElBQUksQ0FBQyxJQUFTLEVBQUUsTUFBWSxFQUFFLFNBQWUsRUFBRSxPQUFnQjtRQUM3RCxN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UUFDcEIsSUFBSSxnQkFBZ0IsS0FBSyxrQkFBa0IsRUFBRTtZQUMzQyxPQUFPLElBQUksQ0FBQztTQUNiO1FBRUQsWUFBWTtRQUNaLGdDQUFnQztRQUNoQyx3Q0FBd0M7UUFDeEMscURBQXFEO1FBQ3JELDJEQUEyRDtRQUMzRCxpQkFBaUI7UUFDakIsSUFBSTtRQUVKLGlCQUFpQjtRQUNqQiwwQkFBMEI7UUFDMUIsa0NBQWtDO1FBQ2xDLGlDQUFpQztRQUNqQyxvRUFBb0U7UUFDcEUscUJBQXFCO1FBRXJCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxrQkFBa0IsSUFBSSxnQkFBZ0IsQ0FBQyxlQUFlLENBQUM7WUFDM0UsQ0FBQyxrQkFBa0IsQ0FBQyxrQkFBa0IsSUFBSSxrQkFBa0IsQ0FBQyxlQUFlLENBQUMsRUFBRTtZQUMvRSxpQkFBaUI7WUFDakIsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3ViamVjdCwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IElEaXNwb3NhYmxlIH0gZnJvbSAnLi4vY29yZS9pbmRleCc7XHJcbmltcG9ydCB7IEV2ZW50VHlwZUVudW0gfSBmcm9tICcuLi9ldmVudC1tZWNoYW5pc20nO1xyXG5pbXBvcnQgeyBFdmVudFBpcGVUeXBlIH0gZnJvbSAnLi9ldmVudC1waXBlLXR5cGUnO1xyXG5cclxuZXhwb3J0IGNsYXNzIEV2ZW50UGlwZSBpbXBsZW1lbnRzIElEaXNwb3NhYmxlIHtcclxuICBwcml2YXRlIGxhc3RFdmVudElkID0gLTE7XHJcbiAgLyoqXHJcbiAgICog5LqL5Lu25a+56LGhXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBldmVudFN1YmplY3Q6IFN1YmplY3Q8YW55PjtcclxuXHJcbiAgLyoqXHJcbiAgICog6K6i6ZiF5a+56LGhTWFwXHJcbiAgICoga2V5PeiuoumYheaJgOWcqOeahEZyYW1lQ29tcG9uZW50XHJcbiAgICogdmFsdWXvvJrorqLpmIVldmV0blN1YmplY3TkuqfnlJ/nmoRTdWJzY3JpcHRpb27lr7nosaHvvIhyeGpz55qE77yJXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb25NYXA6IE1hcDxvYmplY3QsIFN1YnNjcmlwdGlvbj47XHJcblxyXG4gIC8qKlxyXG4gICAqIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgb25jZVN1YnNjcmlwdGlvbk1hcDogTWFwPG9iamVjdCwgU3Vic2NyaXB0aW9uPjtcclxuXHJcbiAgLyoqXHJcbiAgICogRXZlbnRQaXBl57G75Z6L77yM57yW6K+R57G75Z6L6KGo5Y2V5qOA5p+l5piv5ZCm5Zyo5ZCM5LiA5LiK5LiL5paH5Lit77yM6Kej5p6Q57G75Z6L6KGo5Y2V5LiN5Yik5patXHJcbiAgICovXHJcbiAgcHVibGljIGV2ZW50UGlwZVR5cGUgPSBFdmVudFBpcGVUeXBlLkNvbXBpbGU7IFxyXG4gIHB1YmxpYyBnZXQgc3Vic2NyaXB0aW9ucygpOiBNYXA8b2JqZWN0LCBTdWJzY3JpcHRpb24+IHtcclxuICAgIHJldHVybiB0aGlzLnN1YnNjcmlwdGlvbk1hcDtcclxuICB9XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwdWJsaWMgbmFtZTogc3RyaW5nLFxyXG4gICAgcHVibGljIHRva2VuVmFsdWU6IHN0cmluZyxcclxuICAgIHB1YmxpYyBlbWl0dGVyOiBzdHJpbmcsXHJcbiAgICBwcml2YXRlIHBhcmVudEV2ZW50UGlwZUxpc3Q6IEFycmF5PEV2ZW50UGlwZT5cclxuICApIHtcclxuICAgIHRoaXMuZXZlbnRTdWJqZWN0ID0gbmV3IFN1YmplY3Q8YW55PigpO1xyXG4gICAgdGhpcy5zdWJzY3JpcHRpb25NYXAgPSBuZXcgTWFwPG9iamVjdCwgU3Vic2NyaXB0aW9uPigpO1xyXG4gICAgdGhpcy5vbmNlU3Vic2NyaXB0aW9uTWFwID0gbmV3IE1hcDxvYmplY3QsIFN1YnNjcmlwdGlvbj4oKTtcclxuICAgIGlmICh0aGlzLnBhcmVudEV2ZW50UGlwZUxpc3QpIHtcclxuICAgICAgdGhpcy5wYXJlbnRFdmVudFBpcGVMaXN0LnB1c2godGhpcyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlj5HpgIHkuovku7ZcclxuICAgKi9cclxuICBwb3N0KGFyZ3M6IGFueSwgc2VuZGVyPzogYW55LCBldmVudFR5cGU/OiBhbnksIGV2ZW50SWQ/OiBudW1iZXIpIHtcclxuICAgIGNvbnN0IGV2ZW50RGF0YSA9IHtcclxuICAgICAgYXJnczogYXJncyxcclxuICAgICAgc2VuZGVyOiBzZW5kZXIsXHJcbiAgICAgIGV2ZW50VHlwZSxcclxuICAgICAgZXZlbnRJZFxyXG4gICAgfTtcclxuICAgIHRoaXMuZXZlbnRTdWJqZWN0Lm5leHQoZXZlbnREYXRhKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuoumYheS6i+S7tlxyXG4gICAqL1xyXG4gIHN1YnNjcmliZShldmVudEhhbmRsZXI6ICh2YWx1ZTogYW55KSA9PiB2b2lkLCByZWNlaXZlcjogb2JqZWN0KTogSURpc3Bvc2FibGUge1xyXG5cclxuICAgIC8vIOWvueS6juW8ueeql++8jGNhbGxlcuaYr+W8ueeql+S4reeahOe7hOS7tu+8jOavj+asoWNhbGxlcuS4jeWQjO+8jOS9hui/mOaYr+S8mumHjeWkjeazqOWGjOOAglxyXG4gICAgLy8g6YeN5aSN6K6i6ZiF5qOA5rWLXHJcbiAgICBjb25zdCBzdWJzY3JpcHRpb25Jbk1hcCA9IHRoaXMuc3Vic2NyaXB0aW9uTWFwLmdldChyZWNlaXZlcik7XHJcbiAgICBpZiAoc3Vic2NyaXB0aW9uSW5NYXAgIT0gbnVsbCkge1xyXG4gICAgICBzdWJzY3JpcHRpb25Jbk1hcC51bnN1YnNjcmliZSgpO1xyXG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbk1hcC5kZWxldGUocmVjZWl2ZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHRoaXMuZXZlbnRTdWJqZWN0LnN1YnNjcmliZSgoZXZlbnREYXRhOiBhbnkpID0+IHtcclxuICAgICAgY29uc3QgYXJncyA9IGV2ZW50RGF0YS5hcmdzO1xyXG4gICAgICBjb25zdCBzZW5kZXIgPSBldmVudERhdGEuc2VuZGVyO1xyXG4gICAgICBjb25zdCBldmVudFR5cGUgPSBldmVudERhdGEuZXZlbnRUeXBlIHx8IG51bGw7XHJcbiAgICAgIGNvbnN0IGV2ZW50SWQgPSBldmVudERhdGEuZXZlbnRJZCB8fCAwO1xyXG4gICAgICBpZiAodGhpcy5sYXN0RXZlbnRJZCA+PSBldmVudElkKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMubGFzdEV2ZW50SWQgPSBldmVudElkO1xyXG4gICAgICAvLyDliKTmlq1zZW5kZXLlkoxyZWNlaXZlcueahOWFs+ezu++8jOWmguaenOWcqOWQjOS4gOS4qkFwcENvbnRleHTmiJbogIXlnKjlnKjkuIDmo7XmoJHkuIrvvIzliJnlpITnkIZcclxuICAgICAgLy8g6K+l5Yik5pat5Li76KaB6Kej5YazU1BB5qih5byP5LiL77yM5LiA5Liq6aG16Z2i6KKr5omT5byA5aSa5qyh55qE5Zy65pmv44CCXHJcbiAgICAgIGlmICghKGV2ZW50VHlwZSA9PT0gRXZlbnRUeXBlRW51bS5ST1VURSkpIHtcclxuICAgICAgICBpZiAodGhpcy5pc0luU2FtcGVTY29wZShzZW5kZXIsIHJlY2VpdmVyKSA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgZXZlbnRIYW5kbGVyLmNhbGwocmVjZWl2ZXIsIGFyZ3MpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy5zdWJzY3JpcHRpb25NYXAuc2V0KFxyXG4gICAgICByZWNlaXZlcixcclxuICAgICAgc3Vic2NyaXB0aW9uXHJcbiAgICApO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfVxyXG5cclxuICBzdWJzY3JpYmVPbmNlKGV2ZW50SGFuZGxlcjogKHZhbHVlOiBhbnkpID0+IHZvaWQsIGNhbGxlcjogb2JqZWN0KTogSURpc3Bvc2FibGUge1xyXG4gICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gdGhpcy5ldmVudFN1YmplY3Quc3Vic2NyaWJlKCh2YWx1ZSkgPT4gZXZlbnRIYW5kbGVyLmNhbGwoY2FsbGVyLCB2YWx1ZSkpO1xyXG4gICAgdGhpcy5vbmNlU3Vic2NyaXB0aW9uTWFwLnNldChcclxuICAgICAgY2FsbGVyLFxyXG4gICAgICBzdWJzY3JpcHRpb25cclxuICAgICk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9XHJcblxyXG4gIHVuU3Vic2NyaWJlKHN1YnNjcmliZXI6IG9iamVjdCkge1xyXG4gICAgbGV0IHN1YnNjcmlwdGlvbiA9IHRoaXMuc3Vic2NyaXB0aW9uTWFwLmdldChzdWJzY3JpYmVyKTtcclxuICAgIGlmIChzdWJzY3JpcHRpb24pIHtcclxuICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgIHN1YnNjcmlwdGlvbiA9IG51bGw7XHJcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9uTWFwLmRlbGV0ZShzdWJzY3JpYmVyKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHN1YnNjcmlwdGlvbiA9IHRoaXMub25jZVN1YnNjcmlwdGlvbk1hcC5nZXQoc3Vic2NyaWJlcik7XHJcbiAgICAgIGlmIChzdWJzY3JpcHRpb24pIHtcclxuICAgICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgICAgICBzdWJzY3JpcHRpb24gPSBudWxsO1xyXG4gICAgICAgIHRoaXMub25jZVN1YnNjcmlwdGlvbk1hcC5kZWxldGUoc3Vic2NyaWJlcik7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOazqOmUgOS9v+eUqG9uY2Xmlrnms5Xms6jlhoznmoTorqLpmIXjgIJcclxuICB1blN1YnNjcmliZUZvck9uY2UoKSB7XHJcbiAgICBmb3IgKGNvbnN0IHN1YnNjcmliZXIgb2YgQXJyYXkuZnJvbSh0aGlzLm9uY2VTdWJzY3JpcHRpb25NYXAua2V5cygpKSkge1xyXG4gICAgICB0aGlzLnVuU3Vic2NyaWJlKHN1YnNjcmliZXIpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbWF0Y2hFbWl0dGVyVG9rZW4oZW1pdHRlcjogc3RyaW5nLCB0b2tlblZhbHVlOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIGlmICh0aGlzLmVtaXR0ZXIgJiYgZW1pdHRlciAmJiB0aGlzLmVtaXR0ZXIgIT09IGVtaXR0ZXIpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMudG9rZW5WYWx1ZSAmJiB0b2tlblZhbHVlICYmIHRoaXMudG9rZW5WYWx1ZSAhPT0gdG9rZW5WYWx1ZSkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIGV4YW1CeVRhcmdldFRva2VuKHRhcmdldDogc3RyaW5nLCB0b2tlblZhbHVlOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIGlmICh0aGlzLmVtaXR0ZXIgIT09IHRhcmdldCkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy50b2tlblZhbHVlICE9PSB0b2tlblZhbHVlKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgZGlzcG9zZShzdWJzY3JpYmVyOiBvYmplY3QpOiB2b2lkIHtcclxuICAgIHRoaXMudW5TdWJzY3JpYmUoc3Vic2NyaWJlcik7XHJcbiAgICBpZiAodGhpcy5zdWJzY3JpcHRpb25NYXAuc2l6ZSA9PT0gMCAmJiB0aGlzLnBhcmVudEV2ZW50UGlwZUxpc3QpIHtcclxuICAgICAgY29uc3QgbG9jYXRpb24gPSB0aGlzLnBhcmVudEV2ZW50UGlwZUxpc3QuZmluZEluZGV4KGl0ZW0gPT4gaXRlbSA9PT0gdGhpcyk7XHJcbiAgICAgIGlmIChsb2NhdGlvbiAhPT0gLTEpIHtcclxuICAgICAgICB0aGlzLnBhcmVudEV2ZW50UGlwZUxpc3Quc3BsaWNlKGxvY2F0aW9uLCAxKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2uY2FsbGVy6L+b6KGM5rOo6ZSAXHJcbiAgICovXHJcbiAgZGlzcG9zZUJ5Q2FsbGVyKGNhbGxlcjogYW55KSB7XHJcbiAgICBjb25zdCBzdWJzY3JpcHRpb25Jbk1hcCA9IHRoaXMuc3Vic2NyaXB0aW9uTWFwLmdldChjYWxsZXIpO1xyXG4gICAgaWYgKHN1YnNjcmlwdGlvbkluTWFwICE9IG51bGwpIHtcclxuICAgICAgc3Vic2NyaXB0aW9uSW5NYXAudW5zdWJzY3JpYmUoKTtcclxuICAgICAgdGhpcy5zdWJzY3JpcHRpb25NYXAuZGVsZXRlKGNhbGxlcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmo4Dmn6XmmK/lkKblnKjlkIzkuIDkuKrkuIrkuIvmlofkuK1cclxuICAgKiBAdG9kb1xyXG4gICAqIDHjgIHlvLror4bliKvkuoZzZW5kZXLlkoxyZWNlaXZlcueahOe7k+aehOadpeWIpOaWre+8jOS4jeWQiOeQhu+8m1xyXG4gICAqIDLjgIHlupTor6Xlo7DmmI7kuIDkuKrmjqXlj6PmnaXnuqbmnZ/nu5PmnoTjgIJcclxuICAgKi9cclxuICBwcml2YXRlIGlzSW5TYW1wZVNjb3BlKHNlbmRlcjogYW55LCByZWNlaXZlcjogYW55KTogYm9vbGVhbiB7XHJcbiAgICAvLyDnlKjmnaXljLrliIbnvJbor5HnsbvlnovnmoTooajljZXvvIzov5jmmK/op6PmnpDnsbvlnovnmoTooajljZVcclxuICAgIGlmICh0aGlzLmV2ZW50UGlwZVR5cGUgPT09IEV2ZW50UGlwZVR5cGUuUGFyc2luZykge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDlhbzlrrnogIHku6PnoIHvvIxzZW5kZXLkuI3lrZjlnKjml7bvvIzkuI3ov5vooYzmo4DmtYtcclxuICAgIGlmICghc2VuZGVyKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOW8guW4uOWkhOeQhuWcuuaZr1xyXG4gICAgaWYgKHNlbmRlciA9PT0gcmVjZWl2ZXIpIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5Yik5pat5piv5ZCm5pivRnJhbWVDb250ZXh0XHJcbiAgICBpZiAoIXNlbmRlci5jb250ZXh0IHx8ICFzZW5kZXIuY29udGV4dC5hcHBDb250ZXh0IHx8XHJcbiAgICAgICFyZWNlaXZlci5jb250ZXh0IHx8ICFyZWNlaXZlci5jb250ZXh0LmFwcENvbnRleHQpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHNlbmRlckFwcENvbnRleHQgPSBzZW5kZXIuY29udGV4dC5hcHBDb250ZXh0O1xyXG4gICAgY29uc3QgcmVjZWl2ZXJBcHBDb250ZXh0ID0gcmVjZWl2ZXIuY29udGV4dC5hcHBDb250ZXh0O1xyXG5cclxuICAgIC8vIOaDheWGtTHvvJrnjrDnirZcclxuICAgIC8vIOWvueS6juiAgeihqOWNle+8jOWcqOaooeWdl+S4iuazqOWFpeS6huS4gOS4qkFwcENvbnRleHTvvJtcclxuICAgIC8vIOe7hOWQiOihqOWNleS4reS4u+ihqOWNleeahHJvb3QtY29tcG9uZW5077yI6KKr57uE5ZCI55qE6KGo5Y2V55qEcm9vdC1jb21wb25ldG7kuIrmsqHmnInms6jlhaXvvInkuIrms6jlhaXkuoZBcHBDb250ZXh0XHJcbiAgICAvLyBTUEHmqKHlvI/kuIvvvIzlpoLms5XpgJrov4dSb290IEFwcENvbnRleHTljLrliIbvvIzmmK/kuI3mmK/lkIzkuIDkuKroj5zljZXlhoXnmoTkuovku7bvvJtcclxuICAgIC8vIOWPquiDveWIpOaWreaguee7hOS7tuS4iueahEFwcENvbnRleHTmnaXliKTmlq1cclxuICAgIC8vIOWIpOaWreaguUFwcENvbnRleHTmmK/lkKbkuIDoh7RcclxuICAgIGlmIChzZW5kZXJBcHBDb250ZXh0ID09PSByZWNlaXZlckFwcENvbnRleHQpIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5oOF5Ya1Mu+8muazqOWFpeaUuemAoOWQjlxyXG4gICAgLy8g5aaC5p6c5Lul5ZCO5rOo5YWl5YWz57O75pS56YCg5LqG77yM5qih5Z2X5LiK55qEQXBwQ29udGV4dOenu+mZpOaOiVxyXG4gICAgLy8g57uE5ZCI6KGo5Y2V5Lit5q+P5Liqcm9vdC1jb21wb25lbnTpg73mi6XmnInkuIDkuKpBcHBDb250ZXh0O1xyXG4gICAgLy8g57uE5ZCI6KGo5Y2V5Lit5Li76KGo5Y2V55qEcm9vdC1jb21wb25lbnTnmoRBcHBDb250ZXh05Li6Um9vdCBBcHBDb250ZXh0XHJcbiAgICAvLyBpZiAoc2VuZGVyQXBwQ29udGV4dC5yb290ID09PSByZWNlaXZlckFwcENvbnRleHQucm9vdCkge1xyXG4gICAgLy8gICByZXR1cm4gdHJ1ZTtcclxuICAgIC8vIH1cclxuXHJcbiAgICAvLyDmg4XlhrUz77ya5rOo5YWl5pS56YCg5ZCO6ICB6KGo5Y2V5YW85a65XHJcbiAgICAvLyDlpoLmnpzku6XlkI7ms6jlhaXlhbPns7vmlLnpgKDkuobvvIzkvYbkuqflk4Hpg6jmsqHmnInph43mlrDnvJbor5E7XHJcbiAgICAvLyDlkozmg4XlhrUy57G75Ly877yM5LiN5ZCM55qE5piv5qih5Z2X5LiK6L+Y6YGX55WZ5LqG5LiA5LiqQXBwQ29udGV4dO+8m1xyXG4gICAgLy8g5q2k5pe2Um9vdCBBcHBjb250ZXh06L+Y5piv5qih5Z2X5LiK55qE77yM5aaC5L2V5p2l5Yik5pat77yfXHJcbiAgICAvLyAx44CB6ICD6JmR6YCa6L+Hc2VuZGVy55qEaW5qZWN0b3LkuIDnm7TnvZHkuIrmib7vvIzmib7liLDmqKHlnZfkuYvliY3nmoTpgqPkuKrnu4Tku7ZpbmplY3Rvcu+8jOS7juWFtuS4reaLv0FwcENvbnRleHTmnaXliKTmlq3vvJtcclxuICAgIC8vIDLjgIHmib7kuIDkuKrlhajpg6jph43mlrDnvJbor5HnmoTml7bmnLrlho3mlLnpgKDjgIJcclxuXHJcbiAgICBpZiAoKHNlbmRlckFwcENvbnRleHQudXNlSXNvbHV0ZUV2ZW50QnVzICYmIHNlbmRlckFwcENvbnRleHQuaXNvbHV0ZUV2ZW50QnVzKSB8fFxyXG4gICAgICAocmVjZWl2ZXJBcHBDb250ZXh0LnVzZUlzb2x1dGVFdmVudEJ1cyAmJiByZWNlaXZlckFwcENvbnRleHQuaXNvbHV0ZUV2ZW50QnVzKSkge1xyXG4gICAgICAvLyDlpoLmnpzlrZjlnKjni6znq4vliqDovb1qcyAg6YKj5LmIXHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxufVxyXG4iXX0=