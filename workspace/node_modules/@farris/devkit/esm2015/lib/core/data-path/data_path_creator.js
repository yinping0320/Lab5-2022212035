import { DataTypeInfo, DataPropGroup } from '../../core/index';
import { DataPathNodeType } from './data_path_node';
import { DataPath } from './data_path';
/**
 * 数据Path工厂类
 */
class DataPathCreator {
    /**
     * 将长路径数组或字符串转换为
     * @param fullPathArrayOrString 路径数组或字符串
     * @param repository 实体仓库
     * @summary
     * 1、长路径格式说明参考：data-path.md
     */
    static createByLongPathFromRoot(fullPathArrayOrString, entityManager) {
        const dataPath = new DataPath();
        const fullPathArray = fullPathArrayOrString;
        if (!fullPathArray || fullPathArray.length === 0) {
            return dataPath;
        }
        let currentNodeInfo = {
            nodeValue: fullPathArray.shift(),
            nodeType: DataPathNodeType.DataId,
            entityTypeInfo: new DataTypeInfo(entityManager.entityType)
        };
        while (currentNodeInfo) {
            dataPath.push(currentNodeInfo.nodeType, currentNodeInfo.nodeValue);
            // 处理下一个节点
            const nextNodeValue = fullPathArray.shift();
            if (!nextNodeValue || !currentNodeInfo.entityTypeInfo) {
                break;
            }
            currentNodeInfo = this.getNextPathNodeInfo(currentNodeInfo, nextNodeValue);
        }
        return dataPath;
    }
    /**
     * 获取下一个路径节点的信息
     * @param parentNodeInfo 当前路径节点信息
     * @param nextNodeValue 下一个路径节点的值
     * @summary
     * 1、这个递归写的很绕，说明数据结构设计不合理；
     * 2、多个因素混用了一个结构；
     */
    static getNextPathNodeInfo(parentNodeInfo, nextNodeValue) {
        const parentNodeValue = parentNodeInfo.nodeValue;
        const parentNodeType = parentNodeInfo.nodeType;
        const parentEntityTypeInfo = parentNodeInfo.entityTypeInfo;
        if (!nextNodeValue || !parentEntityTypeInfo) {
            return null;
        }
        const nextPathNodeInfo = {
            nodeValue: nextNodeValue,
            nodeType: null,
            entityTypeInfo: null
        };
        // DataNodeType=List：下一节点肯定是Object，并且EntityTypeInfo不变
        if (parentNodeType === DataPathNodeType.DataId) {
            nextPathNodeInfo.nodeType = DataPathNodeType.PropName;
            nextPathNodeInfo.entityTypeInfo = parentEntityTypeInfo;
        }
        else {
            // DataNodeType=Object：必然对应一个属性信息
            const nextPropInfo = parentEntityTypeInfo.getPropInfoByName(parentNodeValue);
            if (nextPropInfo.group === DataPropGroup.List) {
                // EntityPropGroup=EntityList：下一个节点是List类型。
                nextPathNodeInfo.nodeType = DataPathNodeType.DataId;
                nextPathNodeInfo.entityTypeInfo = nextPropInfo.typeInfo;
            }
            else {
                // EntityPropGroup=Entity：       下级entityTypeInfo为
                // EntityPropGroup=Dynamic|Plain：null
                nextPathNodeInfo.nodeType = DataPathNodeType.PropName;
                nextPathNodeInfo.entityTypeInfo = nextPropInfo.group === DataPropGroup.Object ? nextPropInfo.typeInfo : null;
            }
        }
        return nextPathNodeInfo;
    }
    /**
     * @param fullPathArrayOrString 路径数组或字符串
     * @param repository 实体仓库
     * @summary
     * 1、长路径格式说明参考：data-path.md
     * 2、shortPathArrayOrString暂时只支持字符串数组
     */
    static createByShortPathFromRoot(shortPathArrayOrString, entityManager, bindingData) {
        const dataPath = new DataPath();
        const shortPathArray = shortPathArrayOrString;
        // 根节点
        let currentBindingObject = bindingData.list.currentItem;
        let currentEntityTypeInfo = new DataTypeInfo(entityManager.entityType);
        dataPath.push(DataPathNodeType.DataId, currentBindingObject.primaryKeyValue);
        // 遍历下级节点
        shortPathArray.forEach((propName) => {
            const propInfo = currentEntityTypeInfo.getPropInfoByName(propName);
            switch (propInfo.group) {
                case DataPropGroup.Plain:
                    dataPath.push(DataPathNodeType.PropName, propName);
                    break;
                case DataPropGroup.Object:
                    currentBindingObject = currentBindingObject[propName];
                    currentEntityTypeInfo = propInfo.typeInfo;
                    dataPath.push(DataPathNodeType.PropName, propName);
                    break;
                case DataPropGroup.List:
                    const currentBindingList = currentBindingObject[propName];
                    currentBindingObject = currentBindingList.currentItem;
                    currentEntityTypeInfo = propInfo.typeInfo;
                    dataPath.push(DataPathNodeType.PropName, propName);
                    dataPath.push(DataPathNodeType.DataId, currentBindingObject.primaryKeyValue);
                    break;
                default:
                    break;
            }
        });
        return dataPath;
    }
}
export { DataPathCreator };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YV9wYXRoX2NyZWF0b3IuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9jb3JlL2RhdGEtcGF0aC9kYXRhX3BhdGhfY3JlYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsWUFBWSxFQUFFLGFBQWEsRUFBRyxNQUFNLGtCQUFrQixDQUFDO0FBSWhFLE9BQU8sRUFBZ0IsZ0JBQWdCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNsRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRXZDOztHQUVHO0FBQ0gsTUFBTSxlQUFlO0lBRW5COzs7Ozs7T0FNRztJQUNJLE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQyxxQkFBd0MsRUFBRSxhQUFvQztRQUNuSCxNQUFNLFFBQVEsR0FBRyxJQUFJLFFBQVEsRUFBRSxDQUFDO1FBQ2hDLE1BQU0sYUFBYSxHQUFHLHFCQUFpQyxDQUFDO1FBQ3hELElBQUksQ0FBQyxhQUFhLElBQUksYUFBYSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDaEQsT0FBTyxRQUFRLENBQUM7U0FDakI7UUFFRCxJQUFJLGVBQWUsR0FBRztZQUNwQixTQUFTLEVBQUUsYUFBYSxDQUFDLEtBQUssRUFBRTtZQUNoQyxRQUFRLEVBQUUsZ0JBQWdCLENBQUMsTUFBTTtZQUNqQyxjQUFjLEVBQUUsSUFBSSxZQUFZLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQztTQUMzRCxDQUFDO1FBQ0YsT0FBTyxlQUFlLEVBQUU7WUFDdEIsUUFBUSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxFQUFFLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUVuRSxVQUFVO1lBQ1YsTUFBTSxhQUFhLEdBQUcsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQzVDLElBQUksQ0FBQyxhQUFhLElBQUksQ0FBQyxlQUFlLENBQUMsY0FBYyxFQUFFO2dCQUNyRCxNQUFN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QUFRLENBQUM7b0JBQzFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO29CQUVuRCxNQUFNO2dCQUNSLEtBQUssYUFBYSxDQUFDLElBQUk7b0JBQ3JCLE1BQU0sa0JBQWtCLEdBQUcsb0JBQW9CLENBQUMsUUFBUSxDQUFDLENBQUM7b0JBQzFELG9CQUFvQixHQUFHLGtCQUFrQixDQUFDLFdBQVcsQ0FBQztvQkFDdEQscUJBQXFCLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQztvQkFFMUMsUUFBUSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7b0JBQ25ELFFBQVEsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLG9CQUFvQixDQUFDLGVBQWUsQ0FBQyxDQUFDO29CQUM3RSxNQUFNO2dCQUNSO29CQUNJLE1BQU07YUFDWDtRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztDQUVGO0FBRUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7IERhdGFUeXBlSW5mbywgRGF0YVByb3BHcm91cCAgfSBmcm9tICcuLi8uLi9jb3JlL2luZGV4JztcclxuaW1wb3J0IHsgRW50aXR5ICB9IGZyb20gJy4uLy4uL2VudGl0eS9pbmRleCc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnksIEVudGl0eU1hbmFnZXIgfSBmcm9tICcuLi8uLi9yZXBvc2l0b3J5L2luZGV4JztcclxuaW1wb3J0IHsgQmluZGluZ0RhdGEgfSBmcm9tICcuLi8uLi9iaW5kaW5nLWRhdGEvaW5kZXgnO1xyXG5pbXBvcnQgeyBEYXRhUGF0aE5vZGUsIERhdGFQYXRoTm9kZVR5cGUgfSBmcm9tICcuL2RhdGFfcGF0aF9ub2RlJztcclxuaW1wb3J0IHsgRGF0YVBhdGggfSBmcm9tICcuL2RhdGFfcGF0aCc7XHJcblxyXG4vKipcclxuICog5pWw5o2uUGF0aOW3peWOguexu1xyXG4gKi9cclxuY2xhc3MgRGF0YVBhdGhDcmVhdG9yIHtcclxuXHJcbiAgLyoqXHJcbiAgICog5bCG6ZW/6Lev5b6E5pWw57uE5oiW5a2X56ym5Liy6L2s5o2i5Li6XHJcbiAgICogQHBhcmFtIGZ1bGxQYXRoQXJyYXlPclN0cmluZyDot6/lvoTmlbDnu4TmiJblrZfnrKbkuLJcclxuICAgKiBAcGFyYW0gcmVwb3NpdG9yeSDlrp7kvZPku5PlupNcclxuICAgKiBAc3VtbWFyeVxyXG4gICAqIDHjgIHplb/ot6/lvoTmoLzlvI/or7TmmI7lj4LogIPvvJpkYXRhLXBhdGgubWRcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGljIGNyZWF0ZUJ5TG9uZ1BhdGhGcm9tUm9vdChmdWxsUGF0aEFycmF5T3JTdHJpbmc6IHN0cmluZ1tdIHwgc3RyaW5nLCBlbnRpdHlNYW5hZ2VyOiBFbnRpdHlNYW5hZ2VyPEVudGl0eT4pOiBEYXRhUGF0aCB7XHJcbiAgICBjb25zdCBkYXRhUGF0aCA9IG5ldyBEYXRhUGF0aCgpO1xyXG4gICAgY29uc3QgZnVsbFBhdGhBcnJheSA9IGZ1bGxQYXRoQXJyYXlPclN0cmluZyBhcyBzdHJpbmdbXTtcclxuICAgIGlmICghZnVsbFBhdGhBcnJheSB8fCBmdWxsUGF0aEFycmF5Lmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm4gZGF0YVBhdGg7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGN1cnJlbnROb2RlSW5mbyA9IHtcclxuICAgICAgbm9kZVZhbHVlOiBmdWxsUGF0aEFycmF5LnNoaWZ0KCksXHJcbiAgICAgIG5vZGVUeXBlOiBEYXRhUGF0aE5vZGVUeXBlLkRhdGFJZCxcclxuICAgICAgZW50aXR5VHlwZUluZm86IG5ldyBEYXRhVHlwZUluZm8oZW50aXR5TWFuYWdlci5lbnRpdHlUeXBlKVxyXG4gICAgfTtcclxuICAgIHdoaWxlIChjdXJyZW50Tm9kZUluZm8pIHtcclxuICAgICAgZGF0YVBhdGgucHVzaChjdXJyZW50Tm9kZUluZm8ubm9kZVR5cGUsIGN1cnJlbnROb2RlSW5mby5ub2RlVmFsdWUpO1xyXG5cclxuICAgICAgLy8g5aSE55CG5LiL5LiA5Liq6IqC54K5XHJcbiAgICAgIGNvbnN0IG5leHROb2RlVmFsdWUgPSBmdWxsUGF0aEFycmF5LnNoaWZ0KCk7XHJcbiAgICAgIGlmICghbmV4dE5vZGVWYWx1ZSB8fCAhY3VycmVudE5vZGVJbmZvLmVudGl0eVR5cGVJbmZvKSB7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgICAgY3VycmVudE5vZGVJbmZvID0gdGhpcy5nZXROZXh0UGF0aE5vZGVJbmZvKGN1cnJlbnROb2RlSW5mbywgbmV4dE5vZGVWYWx1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGRhdGFQYXRoO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5LiL5LiA5Liq6Lev5b6E6IqC54K555qE5L+h5oGvXHJcbiAgICogQHBhcmFtIHBhcmVudE5vZGVJbmZvIOW9k+WJjei3r+W+hOiKgueCueS/oeaBr1xyXG4gICAqIEBwYXJhbSBuZXh0Tm9kZVZhbHVlIOS4i+S4gOS4qui3r+W+hOiKgueCueeahOWAvFxyXG4gICAqIEBzdW1tYXJ5XHJcbiAgICogMeOAgei/meS4qumAkuW9kuWGmeeahOW+iOe7le+8jOivtOaYjuaVsOaNrue7k+aehOiuvuiuoeS4jeWQiOeQhu+8m1xyXG4gICAqIDLjgIHlpJrkuKrlm6DntKDmt7fnlKjkuobkuIDkuKrnu5PmnoTvvJtcclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBnZXROZXh0UGF0aE5vZGVJbmZvKHBhcmVudE5vZGVJbmZvOiBhbnksIG5leHROb2RlVmFsdWU6IHN0cmluZyk6IGFueSB7XHJcblxyXG4gICAgY29uc3QgcGFyZW50Tm9kZVZhbHVlID0gcGFyZW50Tm9kZUluZm8ubm9kZVZhbHVlO1xyXG4gICAgY29uc3QgcGFyZW50Tm9kZVR5cGUgPSBwYXJlbnROb2RlSW5mby5ub2RlVHlwZTtcclxuICAgIGNvbnN0IHBhcmVudEVudGl0eVR5cGVJbmZvID0gcGFyZW50Tm9kZUluZm8uZW50aXR5VHlwZUluZm87XHJcblxyXG4gICAgaWYgKCFuZXh0Tm9kZVZhbHVlIHx8ICFwYXJlbnRFbnRpdHlUeXBlSW5mbykge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBuZXh0UGF0aE5vZGVJbmZvID0ge1xyXG4gICAgICBub2RlVmFsdWU6IG5leHROb2RlVmFsdWUsXHJcbiAgICAgIG5vZGVUeXBlOiBudWxsLFxyXG4gICAgICBlbnRpdHlUeXBlSW5mbzogbnVsbFxyXG4gICAgfTtcclxuXHJcblxyXG4gICAgLy8gRGF0YU5vZGVUeXBlPUxpc3TvvJrkuIvkuIDoioLngrnogq/lrprmmK9PYmplY3TvvIzlubbkuJRFbnRpdHlUeXBlSW5mb+S4jeWPmFxyXG4gICAgaWYgKHBhcmVudE5vZGVUeXBlID09PSBEYXRhUGF0aE5vZGVUeXBlLkRhdGFJZCkge1xyXG4gICAgICBuZXh0UGF0aE5vZGVJbmZvLm5vZGVUeXBlID0gRGF0YVBhdGhOb2RlVHlwZS5Qcm9wTmFtZTtcclxuICAgICAgbmV4dFBhdGhOb2RlSW5mby5lbnRpdHlUeXBlSW5mbyA9IHBhcmVudEVudGl0eVR5cGVJbmZvO1xyXG4gICAgfSBlbHNlIHtcclxuXHJcbiAgICAgIC8vIERhdGFOb2RlVHlwZT1PYmplY3TvvJrlv4XnhLblr7nlupTkuIDkuKrlsZ7mgKfkv6Hmga9cclxuICAgICAgY29uc3QgbmV4dFByb3BJbmZvID0gcGFyZW50RW50aXR5VHlwZUluZm8uZ2V0UHJvcEluZm9CeU5hbWUocGFyZW50Tm9kZVZhbHVlKTtcclxuICAgICAgaWYgKG5leHRQcm9wSW5mby5ncm91cCA9PT0gRGF0YVByb3BHcm91cC5MaXN0KSB7XHJcblxyXG4gICAgICAgIC8vIEVudGl0eVByb3BHcm91cD1FbnRpdHlMaXN077ya5LiL5LiA5Liq6IqC54K55pivTGlzdOexu+Wei+OAglxyXG4gICAgICAgIG5leHRQYXRoTm9kZUluZm8ubm9kZVR5cGUgPSBEYXRhUGF0aE5vZGVUeXBlLkRhdGFJZDtcclxuICAgICAgICBuZXh0UGF0aE5vZGVJbmZvLmVudGl0eVR5cGVJbmZvID0gbmV4dFByb3BJbmZvLnR5cGVJbmZvO1xyXG4gICAgICB9IGVsc2Uge1xyXG5cclxuICAgICAgICAvLyBFbnRpdHlQcm9wR3JvdXA9RW50aXR577yaICAgICAgIOS4i+e6p2VudGl0eVR5cGVJbmZv5Li6XHJcbiAgICAgICAgLy8gRW50aXR5UHJvcEdyb3VwPUR5bmFtaWN8UGxhaW7vvJpudWxsXHJcbiAgICAgICAgbmV4dFBhdGhOb2RlSW5mby5ub2RlVHlwZSA9IERhdGFQYXRoTm9kZVR5cGUuUHJvcE5hbWU7XHJcbiAgICAgICAgbmV4dFBhdGhOb2RlSW5mby5lbnRpdHlUeXBlSW5mbyA9IG5leHRQcm9wSW5mby5ncm91cCA9PT0gRGF0YVByb3BHcm91cC5PYmplY3QgPyBuZXh0UHJvcEluZm8udHlwZUluZm8gOiBudWxsO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5leHRQYXRoTm9kZUluZm87XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gZnVsbFBhdGhBcnJheU9yU3RyaW5nIOi3r+W+hOaVsOe7hOaIluWtl+espuS4slxyXG4gICAqIEBwYXJhbSByZXBvc2l0b3J5IOWunuS9k+S7k+W6k1xyXG4gICAqIEBzdW1tYXJ5XHJcbiAgICogMeOAgemVv+i3r+W+hOagvOW8j+ivtOaYjuWPguiAg++8mmRhdGEtcGF0aC5tZFxyXG4gICAqIDLjgIFzaG9ydFBhdGhBcnJheU9yU3RyaW5n5pqC5pe25Y+q5pSv5oyB5a2X56ym5Liy5pWw57uEXHJcbiAgICovXHJcbiAgcHVibGljIHN0YXRpYyBjcmVhdGVCeVNob3J0UGF0aEZyb21Sb290KFxyXG4gICAgc2hvcnRQYXRoQXJyYXlPclN0cmluZzogc3RyaW5nW10gfCBzdHJpbmcsIGVudGl0eU1hbmFnZXI6IEVudGl0eU1hbmFnZXI8RW50aXR5PiwgYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhXHJcbiAgKTogRGF0YVBhdGgge1xyXG5cclxuICAgIGNvbnN0IGRhdGFQYXRoID0gbmV3IERhdGFQYXRoKCk7XHJcbiAgICBjb25zdCBzaG9ydFBhdGhBcnJheTogc3RyaW5nW10gPSBzaG9ydFBhdGhBcnJheU9yU3RyaW5nIGFzIHN0cmluZ1tdO1xyXG5cclxuICAgIC8vIOagueiKgueCuVxyXG4gICAgbGV0IGN1cnJlbnRCaW5kaW5nT2JqZWN0ID0gYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SXRlbTtcclxuICAgIGxldCBjdXJyZW50RW50aXR5VHlwZUluZm8gPSBuZXcgRGF0YVR5cGVJbmZvKGVudGl0eU1hbmFnZXIuZW50aXR5VHlwZSk7XHJcbiAgICBkYXRhUGF0aC5wdXNoKERhdGFQYXRoTm9kZVR5cGUuRGF0YUlkLCBjdXJyZW50QmluZGluZ09iamVjdC5wcmltYXJ5S2V5VmFsdWUpO1xyXG5cclxuICAgIC8vIOmBjeWOhuS4i+e6p+iKgueCuVxyXG4gICAgc2hvcnRQYXRoQXJyYXkuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBwcm9wSW5mbyA9IGN1cnJlbnRFbnRpdHlUeXBlSW5mby5nZXRQcm9wSW5mb0J5TmFtZShwcm9wTmFtZSk7XHJcbiAgICAgIHN3aXRjaCAocHJvcEluZm8uZ3JvdXApIHtcclxuICAgICAgICBjYXNlIERhdGFQcm9wR3JvdXAuUGxhaW46XHJcbiAgICAgICAgICBkYXRhUGF0aC5wdXNoKERhdGFQYXRoTm9kZVR5cGUuUHJvcE5hbWUsIHByb3BOYW1lKTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgRGF0YVByb3BHcm91cC5PYmplY3Q6XHJcbiAgICAgICAgICBjdXJyZW50QmluZGluZ09iamVjdCA9IGN1cnJlbnRCaW5kaW5nT2JqZWN0W3Byb3BOYW1lXTtcclxuICAgICAgICAgIGN1cnJlbnRFbnRpdHlUeXBlSW5mbyA9IHByb3BJbmZvLnR5cGVJbmZvO1xyXG4gICAgICAgICAgZGF0YVBhdGgucHVzaChEYXRhUGF0aE5vZGVUeXBlLlByb3BOYW1lLCBwcm9wTmFtZSk7XHJcblxyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBEYXRhUHJvcEdyb3VwLkxpc3Q6XHJcbiAgICAgICAgICBjb25zdCBjdXJyZW50QmluZGluZ0xpc3QgPSBjdXJyZW50QmluZGluZ09iamVjdFtwcm9wTmFtZV07XHJcbiAgICAgICAgICBjdXJyZW50QmluZGluZ09iamVjdCA9IGN1cnJlbnRCaW5kaW5nTGlzdC5jdXJyZW50SXRlbTtcclxuICAgICAgICAgIGN1cnJlbnRFbnRpdHlUeXBlSW5mbyA9IHByb3BJbmZvLnR5cGVJbmZvO1xyXG5cclxuICAgICAgICAgIGRhdGFQYXRoLnB1c2goRGF0YVBhdGhOb2RlVHlwZS5Qcm9wTmFtZSwgcHJvcE5hbWUpO1xyXG4gICAgICAgICAgZGF0YVBhdGgucHVzaChEYXRhUGF0aE5vZGVUeXBlLkRhdGFJZCwgY3VycmVudEJpbmRpbmdPYmplY3QucHJpbWFyeUtleVZhbHVlKTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gZGF0YVBhdGg7XHJcbiAgfVxyXG5cclxufVxyXG5cclxuZXhwb3J0IHsgRGF0YVBhdGhDcmVhdG9yIH07XHJcbiJdfQ==