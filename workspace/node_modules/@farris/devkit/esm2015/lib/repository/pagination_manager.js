import { Injectable } from '@angular/core';
import { FieldMetadataUtil } from '../entity/index';
// tslint:disable: no-bitwise
export class PaginationManager {
    constructor(entityType, paginationConfig) {
        this.entityType = entityType;
        this.paginationConfig = paginationConfig;
        if (this.paginationConfig === null || this.paginationConfig === undefined) {
            this.paginationConfig = this.getNgListProperties();
        }
        // 兼容老表单，将之前的主表分页信息展开到分页配置根中
        this.expandMainEntityConfig();
        this.deleteMainEntityConfig();
        this.removeLasts();
    }
    /**
     * 主表分页信息展开到分页配置根中
     */
    expandMainEntityConfig() {
        const entityName = this.entityType.typeName || this.entityType.name;
        if (this.paginationConfig.hasOwnProperty(entityName)) {
            const entityConfig = this.paginationConfig[entityName];
            this.paginationConfig = Object.assign(this.paginationConfig, entityConfig);
        }
        else {
            this.paginationConfig = Object.assign(this.paginationConfig, { pageSize: this.paginationConfig['pageSize'] || 0 });
        }
    }
    /**
     * 删除子表分页配置key后面的s
     */
    removeLasts() {
        const entityName = this.entityType.typeName || this.entityType.name;
        Object.keys(this.paginationConfig).forEach(key => {
            if (key !== entityName && key.endsWith('s')) {
                const newKey = key.substring(0, key.length - 1);
                this.paginationConfig[newKey] = this.paginationConfig[key];
                delete this.paginationConfig[key];
            }
        });
    }
    /**
     * 删除主表实体配置信息
     */
    deleteMainEntityConfig() {
        const entityName = this.entityType.typeName || this.entityType.name;
        delete this.paginationConfig[entityName];
    }
    /**
     * 获取分页信息
     */
    get pagination() {
        return this.paginationConfig;
    }
    /**
     * 获取分页信息
     * @param path 路径
     * @param defaultValue 默认值
     */
    getPaginationConfigByPath(path, defaultValue) {
        if (!path || path === '/') {
            return this.paginationConfig;
        }
        if (typeof path !== 'string') {
            throw new Error('路径必须为字符串！');
        }
        path = path.substring(1);
        const paths = path.split('/').filter(item => !!item && item.trim().length > 0);
        let config = this.paginationConfig;
        paths.forEach(item => {
            if (config && config.hasOwnProperty(item)) {
                config = config[item];
            }
            else {
                config = null;
            }
        });
        return !!config ? config : typeof defaultValue !== 'undefined' ? defaultValue : undefined;
    }
    /**
     * 设置分页信息
     * @param path 路径
     * @param value 值
     */
    setPaginationConfigByPath(path, value) {
        if (!Array.isArray(path)) {
            path = path.toString().match(/[^/[\]]+/g) || [];
        }
        path.slice(0, -1).reduce((prev, current, index) => Object(prev[current]) === prev[current]
            ? prev[current]
            : prev[current] = Math.abs(path[index + 1]) >> 0 === +path[index + 1]
                ? []
                : {}, this.paginationConfig)[path[path.length - 1]] = value;
        return this.paginationConfig;
    }
    /**
     * 递归获取当前实体的所有NgList属性
     * @param defaultPageSize defaultPageSize
     */
    getNgListProperties(defaultPageSize = 0) {
        const getChilds = (objectType) => {
            const listProperties = FieldMetadataUtil.getNgList(objectType);
            let result = {};
            if (Object.keys(listProperties).length < 1) {
                return result;
            }
            Object.keys(listProperties).forEach(prop => {
                let itemTypeName = listProperties[prop].dataField;
                // 去掉尾部的s
                if (itemTypeName.endsWith('s')) {
                    itemTypeName = itemTypeName.substring(0, itemTypeName.length - 1);
                }
                result[itemTypeName] = {
                    pageSize: defaultPageSize
                };
                const child = getChilds(listProperties[prop].type);
                if (child !== null && Object.keys(child).length > 0) {
                    result = Object.assign({}, result, child);
                }
            });
            return result;
        };
        const childs = getChilds(this.entityType);
        const root = Object.assign({}, { pageSize: defaultPageSize }, childs);
        return root;
    }
}
PaginationManager.decorators = [
    { type: Injectable }
];
/** @nocollapse */
PaginationManager.ctorParameters = () => [
    { type: undefined },
    { type: undefined }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnaW5hdGlvbl9tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvcmVwb3NpdG9yeS9wYWdpbmF0aW9uX21hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFRLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNqRCxPQUFPLEVBQVUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM1RCw2QkFBNkI7QUFFN0IsTUFBTSxPQUFPLGlCQUFpQjtJQUU1QixZQUFvQixVQUFlLEVBQVUsZ0JBQXFCO1FBQTlDLGVBQVUsR0FBVixVQUFVLENBQUs7UUFBVSxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQUs7UUFDaEUsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEtBQUssSUFBSSxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsS0FBSyxTQUFTLEVBQUU7WUFDekUsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1NBQ3BEO1FBQ0QsNEJBQTRCO1FBQzVCLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBQ0Q7O09BRUc7SUFDSyxzQkFBc0I7UUFDNUIsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUM7UUFDcEUsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQ3BELE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUN2RCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdC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LE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUN6QyxJQUFJLFlBQVksR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsU0FBUyxDQUFDO2dCQUNsRCxTQUFTO2dCQUNULElBQUksWUFBWSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRTtvQkFDOUIsWUFBWSxHQUFHLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLFlBQVksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7aUJBQ25FO2dCQUNELE1BQU0sQ0FBQyxZQUFZLENBQUMsR0FBRztvQkFDckIsUUFBUSxFQUFFLGVBQWU7aUJBQzFCLENBQUM7Z0JBQ0YsTUFBTSxLQUFLLEdBQUcsU0FBUyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDbkQsSUFBSSxLQUFLLEtBQUssSUFBSSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtvQkFDbkQsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztpQkFDM0M7WUFDSCxDQUFDLENBQUMsQ0FBQztZQUNILE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUMsQ0FBQztRQUNGLE1BQU0sTUFBTSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDMUMsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxRQUFRLEVBQUUsZUFBZSxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDdEUsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDOzs7WUE3SEYsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFR5cGUsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRW50aXR5LCBGaWVsZE1ldGFkYXRhVXRpbCB9IGZyb20gJy4uL2VudGl0eS9pbmRleCc7XHJcbi8vIHRzbGludDpkaXNhYmxlOiBuby1iaXR3aXNlXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFBhZ2luYXRpb25NYW5hZ2VyPFQgZXh0ZW5kcyBFbnRpdHk+IHtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBlbnRpdHlUeXBlOiBhbnksIHByaXZhdGUgcGFnaW5hdGlvbkNvbmZpZzogYW55KSB7XHJcbiAgICBpZiAodGhpcy5wYWdpbmF0aW9uQ29uZmlnID09PSBudWxsIHx8IHRoaXMucGFnaW5hdGlvbkNvbmZpZyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHRoaXMucGFnaW5hdGlvbkNvbmZpZyA9IHRoaXMuZ2V0TmdMaXN0UHJvcGVydGllcygpO1xyXG4gICAgfVxyXG4gICAgLy8g5YW85a656ICB6KGo5Y2V77yM5bCG5LmL5YmN55qE5Li76KGo5YiG6aG15L+h5oGv5bGV5byA5Yiw5YiG6aG16YWN572u5qC55LitXHJcbiAgICB0aGlzLmV4cGFuZE1haW5FbnRpdHlDb25maWcoKTtcclxuICAgIHRoaXMuZGVsZXRlTWFpbkVudGl0eUNvbmZpZygpO1xyXG4gICAgdGhpcy5yZW1vdmVMYXN0cygpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDkuLvooajliIbpobXkv6Hmga/lsZXlvIDliLDliIbpobXphY3nva7moLnkuK1cclxuICAgKi9cclxuICBwcml2YXRlIGV4cGFuZE1haW5FbnRpdHlDb25maWcoKSB7XHJcbiAgICBjb25zdCBlbnRpdHlOYW1lID0gdGhpcy5lbnRpdHlUeXBlLnR5cGVOYW1lIHx8IHRoaXMuZW50aXR5VHlwZS5uYW1lO1xyXG4gICAgaWYgKHRoaXMucGFnaW5hdGlvbkNvbmZpZy5oYXNPd25Qcm9wZXJ0eShlbnRpdHlOYW1lKSkge1xyXG4gICAgICBjb25zdCBlbnRpdHlDb25maWcgPSB0aGlzLnBhZ2luYXRpb25Db25maWdbZW50aXR5TmFtZV07XHJcbiAgICAgIHRoaXMucGFnaW5hdGlvbkNvbmZpZyA9IE9iamVjdC5hc3NpZ24odGhpcy5wYWdpbmF0aW9uQ29uZmlnLCBlbnRpdHlDb25maWcpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5wYWdpbmF0aW9uQ29uZmlnID0gT2JqZWN0LmFzc2lnbih0aGlzLnBhZ2luYXRpb25Db25maWcsIHsgcGFnZVNpemU6IHRoaXMucGFnaW5hdGlvbkNvbmZpZ1sncGFnZVNpemUnXSB8fCAwIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDliKDpmaTlrZDooajliIbpobXphY3nva5rZXnlkI7pnaLnmoRzXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZW1vdmVMYXN0cygpIHtcclxuICAgIGNvbnN0IGVudGl0eU5hbWUgPSB0aGlzLmVudGl0eVR5cGUudHlwZU5hbWUgfHwgdGhpcy5lbnRpdHlUeXBlLm5hbWU7XHJcbiAgICBPYmplY3Qua2V5cyh0aGlzLnBhZ2luYXRpb25Db25maWcpLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgaWYgKGtleSAhPT0gZW50aXR5TmFtZSAmJiBrZXkuZW5kc1dpdGgoJ3MnKSkge1xyXG4gICAgICAgIGNvbnN0IG5ld0tleSA9IGtleS5zdWJzdHJpbmcoMCwga2V5Lmxlbmd0aCAtIDEpO1xyXG4gICAgICAgIHRoaXMucGFnaW5hdGlvbkNvbmZpZ1tuZXdLZXldID0gdGhpcy5wYWdpbmF0aW9uQ29uZmlnW2tleV07XHJcbiAgICAgICAgZGVsZXRlIHRoaXMucGFnaW5hdGlvbkNvbmZpZ1trZXldO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yig6Zmk5Li76KGo5a6e5L2T6YWN572u5L+h5oGvXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBkZWxldGVNYWluRW50aXR5Q29uZmlnKCkge1xyXG4gICAgY29uc3QgZW50aXR5TmFtZSA9IHRoaXMuZW50aXR5VHlwZS50eXBlTmFtZSB8fCB0aGlzLmVudGl0eVR5cGUubmFtZTtcclxuICAgIGRlbGV0ZSB0aGlzLnBhZ2luYXRpb25Db25maWdbZW50aXR5TmFtZV07XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWIhumhteS/oeaBr1xyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQgcGFnaW5hdGlvbigpIHtcclxuICAgIHJldHVybiB0aGlzLnBhZ2luYXRpb25Db25maWc7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWIhumhteS/oeaBr1xyXG4gICAqIEBwYXJhbSBwYXRoIOi3r+W+hFxyXG4gICAqIEBwYXJhbSBkZWZhdWx0VmFsdWUg6buY6K6k5YC8XHJcbiAgICovXHJcbiAgcHVibGljIGdldFBhZ2luYXRpb25Db25maWdCeVBhdGgocGF0aDogc3RyaW5nLCBkZWZhdWx0VmFsdWU/OiBhbnkpIHtcclxuICAgIGlmICghcGF0aCB8fCBwYXRoID09PSAnLycpIHtcclxuICAgICAgcmV0dXJuIHRoaXMucGFnaW5hdGlvbkNvbmZpZztcclxuICAgIH1cclxuICAgIGlmICh0eXBlb2YgcGF0aCAhPT0gJ3N0cmluZycpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCfot6/lvoTlv4XpobvkuLrlrZfnrKbkuLLvvIEnKTtcclxuICAgIH1cclxuICAgIHBhdGggPSBwYXRoLnN1YnN0cmluZygxKTtcclxuICAgIGNvbnN0IHBhdGhzID0gcGF0aC5zcGxpdCgnLycpLmZpbHRlcihpdGVtID0+ICEhaXRlbSAmJiBpdGVtLnRyaW0oKS5sZW5ndGggPiAwKTtcclxuICAgIGxldCBjb25maWcgPSB0aGlzLnBhZ2luYXRpb25Db25maWc7XHJcbiAgICBwYXRocy5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICBpZiAoY29uZmlnICYmIGNvbmZpZy5oYXNPd25Qcm9wZXJ0eShpdGVtKSkge1xyXG4gICAgICAgIGNvbmZpZyA9IGNvbmZpZ1tpdGVtXTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25maWcgPSBudWxsO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiAhIWNvbmZpZyA/IGNvbmZpZyA6IHR5cGVvZiBkZWZhdWx0VmFsdWUgIT09ICd1bmRlZmluZWQnID8gZGVmYXVsdFZhbHVlIDogdW5kZWZpbmVkO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDorr7nva7liIbpobXkv6Hmga9cclxuICAgKiBAcGFyYW0gcGF0aCDot6/lvoRcclxuICAgKiBAcGFyYW0gdmFsdWUg5YC8XHJcbiAgICovXHJcbiAgcHVibGljIHNldFBhZ2luYXRpb25Db25maWdCeVBhdGgocGF0aDogc3RyaW5nIHwgQXJyYXk8YW55PiwgdmFsdWU6IGFueSkge1xyXG4gICAgaWYgKCFBcnJheS5pc0FycmF5KHBhdGgpKSB7XHJcbiAgICAgIHBhdGggPSBwYXRoLnRvU3RyaW5nKCkubWF0Y2goL1teL1tcXF1dKy9nKSB8fCBbXTtcclxuICAgIH1cclxuICAgIHBhdGguc2xpY2UoMCwgLTEpLnJlZHVjZSgocHJldiwgY3VycmVudCwgaW5kZXgpID0+XHJcbiAgICAgIE9iamVjdChwcmV2W2N1cnJlbnRdKSA9PT0gcHJldltjdXJyZW50XVxyXG4gICAgICAgID8gcHJldltjdXJyZW50XVxyXG4gICAgICAgIDogcHJldltjdXJyZW50XSA9IE1hdGguYWJzKHBhdGhbaW5kZXggKyAxXSkgPj4gMCA9PT0gK3BhdGhbaW5kZXggKyAxXVxyXG4gICAgICAgICAgPyBbXVxyXG4gICAgICAgICAgOiB7fSxcclxuICAgICAgdGhpcy5wYWdpbmF0aW9uQ29uZmlnKVtwYXRoW3BhdGgubGVuZ3RoIC0gMV1dID0gdmFsdWU7XHJcbiAgICByZXR1cm4gdGhpcy5wYWdpbmF0aW9uQ29uZmlnO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6YCS5b2S6I635Y+W5b2T5YmN5a6e5L2T55qE5omA5pyJTmdMaXN05bGe5oCnXHJcbiAgICogQHBhcmFtIGRlZmF1bHRQYWdlU2l6ZSBkZWZhdWx0UGFnZVNpemVcclxuICAgKi9cclxuICBwcml2YXRlIGdldE5nTGlzdFByb3BlcnRpZXMoZGVmYXVsdFBhZ2VTaXplOiBudW1iZXIgPSAwKSB7XHJcblxyXG4gICAgY29uc3QgZ2V0Q2hpbGRzID0gKG9iamVjdFR5cGU6IFR5cGU8RW50aXR5PikgPT4ge1xyXG4gICAgICBjb25zdCBsaXN0UHJvcGVydGllcyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nTGlzdChvYmplY3RUeXBlKTtcclxuICAgICAgbGV0IHJlc3VsdCA9IHt9O1xyXG4gICAgICBpZiAoT2JqZWN0LmtleXMobGlzdFByb3BlcnRpZXMpLmxlbmd0aCA8IDEpIHtcclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICB9XHJcblxyXG4gICAgICBPYmplY3Qua2V5cyhsaXN0UHJvcGVydGllcykuZm9yRWFjaChwcm9wID0+IHtcclxuICAgICAgICBsZXQgaXRlbVR5cGVOYW1lID0gbGlzdFByb3BlcnRpZXNbcHJvcF0uZGF0YUZpZWxkO1xyXG4gICAgICAgIC8vIOWOu+aOieWwvumDqOeahHNcclxuICAgICAgICBpZiAoaXRlbVR5cGVOYW1lLmVuZHNXaXRoKCdzJykpIHtcclxuICAgICAgICAgIGl0ZW1UeXBlTmFtZSA9IGl0ZW1UeXBlTmFtZS5zdWJzdHJpbmcoMCwgaXRlbVR5cGVOYW1lLmxlbmd0aCAtIDEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXN1bHRbaXRlbVR5cGVOYW1lXSA9IHtcclxuICAgICAgICAgIHBhZ2VTaXplOiBkZWZhdWx0UGFnZVNpemVcclxuICAgICAgICB9O1xyXG4gICAgICAgIGNvbnN0IGNoaWxkID0gZ2V0Q2hpbGRzKGxpc3RQcm9wZXJ0aWVzW3Byb3BdLnR5cGUpO1xyXG4gICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyhjaGlsZCkubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgcmVzdWx0ID0gT2JqZWN0LmFzc2lnbih7fSwgcmVzdWx0LCBjaGlsZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH07XHJcbiAgICBjb25zdCBjaGlsZHMgPSBnZXRDaGlsZHModGhpcy5lbnRpdHlUeXBlKTtcclxuICAgIGNvbnN0IHJvb3QgPSBPYmplY3QuYXNzaWduKHt9LCB7IHBhZ2VTaXplOiBkZWZhdWx0UGFnZVNpemUgfSwgY2hpbGRzKTtcclxuICAgIHJldHVybiByb290O1xyXG4gIH1cclxuXHJcbn1cclxuIl19