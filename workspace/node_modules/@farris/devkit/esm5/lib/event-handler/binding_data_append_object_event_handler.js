import * as tslib_1 from "tslib";
import { Injectable } from "@angular/core";
import { EffectorManager } from "../effector/effector_manager";
import { Expression } from "../expression/index";
import { ENTITY_TEMPLATE, STATE_TEMPLATE } from "../resolver/index";
import { EventHandler } from "./event_handler";
var BindingDataAppendObjectEventHandler = /** @class */ (function (_super) {
    tslib_1.__extends(BindingDataAppendObjectEventHandler, _super);
    function BindingDataAppendObjectEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    /**
     * 过滤出需要计算的表达式
     * @param event event
     * @returns
     */
    BindingDataAppendObjectEventHandler.prototype.filter = function (event) {
        var _this = this;
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            // const fullEventPath = event.path || [];
            // event.path like ["id:7dd77e50-ebed-4639-b483-d12004603640", "formEEUR1E1s"] or undefined or []
            // eventTablePaths like [] or ["子表s"]
            // 找到聚合相关表达式(依赖新增表的表达式),聚合的前提是表达式path位于事件路径的上方
            // 给实体属性或vo变量设置了聚合相关的表达式，此时表达式依赖中路径到子表属性
            var groupExpressions = this.expressionObjects.filter(function (expressionObject) {
                if (expressionObject.ns !== event.ns || !expressionObject.deps || expressionObject.deps.length < 1) {
                    return false;
                }
                var eventTablePaths = _this.buildEntityPath(event.path);
                var info = _this.analysis(event, expressionObject);
                if (!info) {
                    return false;
                }
                // const eventEntityPath = this.buildEntityPath(event.path);
                // 主表新增
                if (eventTablePaths.length === 0) {
                    if (expressionObject.bindingType === Expression.ExpressionBindingType.Field) {
                        // 认为主表新增时不需要处理聚合函数
                        return false;
                    }
                }
                // 从表或从从表新增
                eventTablePaths.splice(0, 0, ENTITY_TEMPLATE);
                // eventEntityPath like ['ENTITY~','formEEUR1E1s'] // 从表新增
                // deps like ['ENTITY~/formEEUR1E1s/udt/udt_field','ENTITY~/formEEUR1E1s/ref/ref_udt/ref_udt_field']
                // 仅处理上级表达式
                if (info.eventTablePaths.length - 1 !== info.expressionTablePaths.length) {
                    return false;
                }
                // 不支持跨表
                if (!info.eventTablePaths.join(Expression.DEPENDENCY_SPLITER).startsWith(info.expressionTablePaths.join(Expression.DEPENDENCY_SPLITER))) {
                    return false;
                }
                var index = expressionObject.deps.findIndex(function (dep) {
                    // 依赖
                    if (!dep.startsWith(eventTablePaths.join(Expression.DEPENDENCY_SPLITER))) {
                        return false;
                    }
                    var deps = dep.split(Expression.DEPENDENCY_SPLITER).filter(function (p) { return p; }).slice(1);
                    var dependPathInfo = _this.getPathInfo(deps.join(Expression.DEPENDENCY_SPLITER));
                    if (dependPathInfo && dependPathInfo.paths.join(Expression.DEPENDENCY_SPLITER) === info.eventTablePaths.join(Expression.DEPENDENCY_SPLITER)) {
                        return true;
                    }
                    return false;
                });
                return index === -1 ? false : true;
            });
            var eventTablePaths_1 = this.buildEntityPath(event.path);
            // 事件表中表达式（事件表本身的表达式）
            var relativeExpressions = this.expressionObjects.filter(function (expressionObject) {
                // expressionObject.bindingType !== Expression.ExpressionBindingType.Field 暂不支持State表达式
                if (expressionObject.ns !== event.ns) {
                    return false;
                }
                var expressionPathInfo = _this.getPathInfo(expressionObject.path);
                // 过滤掉非当前表的表达式
                if (expressionPathInfo.paths.join(Expression.DEPENDENCY_SPLITER) !== eventTablePaths_1.join(Expression.DEPENDENCY_SPLITER)) {
                    return false;
                }
                // 表达式是计算或依赖表达式并且是分层加载场景，不计算，仅当依赖变化时计算
                if ((expressionObject.type === Expression.ExpressionType.Compute || expressionObject.type === Expression.ExpressionType.Dependency) && event.isTreeNodeLoadScene) {
                    return false;
                }
                // 没有依赖的表达式
                if (!expressionObject.deps || expressionObject.deps.length < 1) {
                    return true;
                }
                // 仅依赖State
                var onlyDependOnState = expressionObject.deps.every(function (dep) { return dep.startsWith(STATE_TEMPLATE); });
                // 仅依赖当前表或上级表
                // const onlyDependOnCurrentTable = expressionObject.deps.every((dep: string) => {
                //   if (!dep.startsWith(ENTITY_TEMPLATE)) {
                //     return false;
                //   }
                //   const deps = dep.split(Expression.DEPENDENCY_SPLITER).slice(1);
                //   const dependPathInfo = this.getPathInfo(deps.join(Expression.DEPENDENCY_SPLITER));
                //   return dependPathInfo.paths.join(Expression.DEPENDENCY_SPLITER) === eventTablePaths.join(Expression.DEPENDENCY_SPLITER) || eventTablePaths.join(Expression.DEPENDENCY_SPLITER).startsWith(dependPathInfo.paths.join(Expression.DEPENDENCY_SPLITER)) && dependPathInfo.paths.length + 1 == eventTablePaths.length;
                // });
                // if (onlyDependOnState || onlyDependOnCurrentTable) {
                //   return true;
                // }
                if (onlyDependOnState) {
                    return true;
                }
                var result = _this.analysis(event, expressionObject);
                if (result && result.distance === 0 && result.isSameTable) {
                    return true;
                }
                // 事件表表达式，但依赖下级表的未计算
                return false;
            });
            // 依赖当前加载数据的表达式
            var depExpressions = this.expressionObjects.filter(function (expressionObject) {
                if (expressionObject.ns !== event.ns || !expressionObject.deps || expressionObject.deps.length < 1 || (expressionObject.type !== Expression.ExpressionType.Visible && expressionObject.type !== Expression.ExpressionType.Required && expressionObject.type !== Expression.ExpressionType.Validate)) {
                    return false;
                }
                // 过滤出所有实体依赖
                var deps = expressionObject.deps.filter(function (dep) { return dep.startsWith(ENTITY_TEMPLATE); });
                if (!deps || deps.length < 1) {
                    return false;
                }
                var result = _this.analysis(event, expressionObject);
                if (!result) {
                    return false;
                }
                // 表达式依赖了字段，需要确认依赖的字段所在的表是否是事件表
                // 1、计算事件表路径
                var eventPath = event.path.filter(function (p) { return p; }).join('/');
                // 2、获取依赖字段的表路径
                var index = deps.findIndex(function (dep) {
                    // 去掉ENTITY~前缀
                    var depPath = dep.split('/').slice(1).join('/');
                    // 获取依赖字段所在的表路径
                    var path = _this.getPathInfo(depPath).path;
                    return path === eventPath;
                });
                return index !== -1;
            });
            return groupExpressions.concat(relativeExpressions, depExpressions);
        }
        return null;
    };
    /**
     * 发布事件
     * @param event event
     */
    BindingDataAppendObjectEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                var entityContext = _this.buildEntityContext(event, expressionObject);
                var context = _this.buildContext(expressionObject, event, entityContext);
                var result = _this.perform(expressionObject, context);
                if (result === undefined && !_this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = _this.convertBooleanTypeExpressionResult(expressionObject, result);
                if (expressionObject.id) {
                    _this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                else {
                    // console.warn(`EventHandler 表达式未设置唯一标识，无法更新表达式值。`);
                }
                _this.effect(event, expressionObject);
            });
        }
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    BindingDataAppendObjectEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        return this.getCurrentRowByPaths(paths);
    };
    /**
     * 新增副作用器
     * @param event event
     * @param expressionObject 表达式
     * @returns
     */
    BindingDataAppendObjectEventHandler.prototype.effect = function (event, expressionObject) {
        var _this = this;
        var effectTo = expressionObject.bindingType;
        var eventPath = this.cleanEventPath(event.path);
        var effector = this.effectorFactory.getEffector(expressionObject);
        if (!effector) {
            return;
        }
        var info = this.analysis(event, expressionObject);
        if (!info) {
            return;
        }
        var expressionPaths = expressionObject.path.split('/').filter(function (p) { return p; });
        if (effectTo === Expression.ExpressionBindingType.Field) {
            var paths_1 = [];
            var propertyPaths_1 = expressionPaths.slice(info.expressionTablePaths.length);
            // 新增场景需要计算事件表\事件表上面的表\下层表的可见、必填、校验
            if (info.distance === 0) {
                if (!info.isSameTable) {
                    return;
                }
                // 表达式和事件在同一个表
                var prevPaths_1 = eventPath.slice(0);
                if (eventPath.length === 1) {
                    // 主表新增，此时事件路径中有主键，直接拼接属性就是完整路径
                    if (event.value && Array.isArray(event.value)) {
                        event.value.forEach(function (bindingObject) {
                            paths_1.push([bindingObject.primaryKeyValue].concat(propertyPaths_1));
                        });
                    }
                    else {
                        var path = prevPaths_1.concat(propertyPaths_1);
                        paths_1.push(path);
                    }
                }
                else {
                    // 从表或从从表新增，此时事件路径中缺少最后一个层级的主键
                    if (event.value && Array.isArray(event.value)) {
                        event.value.forEach(function (bindingObject) {
                            paths_1.push(prevPaths_1.concat([bindingObject.primaryKeyValue]).concat(propertyPaths_1));
                        });
                    }
                    else {
                        var bindingList = this.bindingData.getValue(info.eventTablePaths);
                        if (bindingList && bindingList.currentId) {
                            paths_1.push(prevPaths_1.concat(bindingList.currentId).concat(propertyPaths_1));
                        }
                    }
                }
            }
            else {
                // 表达式和事件不在同一个表，即下级表新增或批量新增了一批数据
                if (info.eventFromParent === true) {
                    // 仅处理下级表，跨表跳过
                    if (info.expressionTablePaths.length > 1) {
                        return;
                    }
                    // 下层表的可见、必填、校验
                    var prevPaths = eventPath.slice(0, eventPath.length);
                    // 子表新增
                    if (eventPath && eventPath.length > 0) {
                        prevPaths = eventPath.slice(0, eventPath.length);
                    }
                    else {
                        // 主表新增
                        prevPaths = [this.bindingData.list.currentId, info.expressionTablePaths[0], null];
                    }
                    var path = prevPaths.concat(propertyPaths_1);
                    paths_1.push(path);
                }
                else if (info.eventFromChildren === true) {
                    var prevPaths = eventPath.slice(0, eventPath.length - 1);
                    var path = prevPaths.concat(propertyPaths_1);
                    paths_1.push(path);
                }
                else {
                    return;
                }
            }
            paths_1.forEach(function (path) {
                var currentRows = _this.buildCurrentRows(info.expressionTablePaths, path);
                _this.output(event, expressionObject, currentRows, effector, [path]);
            });
        }
        else if (effectTo === Expression.ExpressionBindingType.State) {
            console.error('not supported！');
        }
    };
    BindingDataAppendObjectEventHandler.prototype.output = function (event, expressionObject, currentRows, effector, paths) {
        var context = this.buildContext(expressionObject, event, null, currentRows);
        var value = this.perform(expressionObject, context);
        if (value === undefined) {
            return;
        }
        expressionObject.result = value;
        if (expressionObject.id) {
            this.expressionResult.set(expressionObject.id, expressionObject.result);
        }
        EffectorManager.effect(effector, expressionObject, paths);
    };
    BindingDataAppendObjectEventHandler.decorators = [
        { type: Injectable }
    ];
    return BindingDataAppendObjectEventHandler;
}(EventHandler));
export { BindingDataAppendObjectEventHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19kYXRhX2FwcGVuZF9vYmplY3RfZXZlbnRfaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2V2ZW50LWhhbmRsZXIvYmluZGluZ19kYXRhX2FwcGVuZF9vYmplY3RfZXZlbnRfaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDL0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRS9DO0lBQ3lELCtEQUFZO0lBRHJFOztJQTJRQSxDQUFDO0lBelFDOzs7O09BSUc7SUFDSSxvREFBTSxHQUFiLFVBQWMsS0FBMkI7UUFBekMsaUJBZ0lDO1FBOUhDLElBQUksSUFBSSxDQUFDLGlCQUFpQixJQUFJLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQy9ELDBDQUEwQztZQUMxQyxpR0FBaUc7WUFDakcscUNBQXFDO1lBRXJDLDhDQUE4QztZQUM5Qyx3Q0FBd0M7WUFDeEMsSUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLFVBQUMsZ0JBQTZDO2dCQUNuRyxJQUFJLGdCQUFnQixDQUFDLEVBQUUsS0FBSyxLQUFLLENBQUMsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxJQUFJLGdCQUFnQixDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO29CQUNsRyxPQUFPLEtBQUssQ0FBQztpQkFDZDtnQkFDRCxJQUFNLGVBQWUsR0FBRyxLQUFJLENB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LENBQUM7SUFDTSxvREFBTSxHQUFiLFVBQWMsS0FBMkIsRUFBRSxnQkFBNkMsRUFBRSxXQUFxQyxFQUFFLFFBQTZCLEVBQUUsS0FBYztRQUM1SyxJQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDOUUsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN0RCxJQUFJLEtBQUssS0FBSyxTQUFTLEVBQUU7WUFDdkIsT0FBTztTQUNSO1FBQ0QsZ0JBQWdCLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNoQyxJQUFJLGdCQUFnQixDQUFDLEVBQUUsRUFBRTtZQUN2QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsRUFBRSxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUN6RTtRQUNELGVBQWUsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLGdCQUFnQixFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzVELENBQUM7O2dCQTFRRixVQUFVOztJQTJRWCwwQ0FBQztDQUFBLEFBM1FELENBQ3lELFlBQVksR0EwUXBFO1NBMVFZLG1DQUFtQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBCaW5kaW5nTGlzdCwgQmluZGluZ09iamVjdCB9IGZyb20gXCIuLi9iaW5kaW5nLWRhdGEvaW5kZXhcIjtcclxuaW1wb3J0IHsgRWZmZWN0b3JNYW5hZ2VyIH0gZnJvbSBcIi4uL2VmZmVjdG9yL2VmZmVjdG9yX21hbmFnZXJcIjtcclxuaW1wb3J0IHsgRXhwcmVzc2lvbiB9IGZyb20gXCIuLi9leHByZXNzaW9uL2luZGV4XCI7XHJcbmltcG9ydCB7IEVOVElUWV9URU1QTEFURSwgU1RBVEVfVEVNUExBVEUgfSBmcm9tIFwiLi4vcmVzb2x2ZXIvaW5kZXhcIjtcclxuaW1wb3J0IHsgRXZlbnRIYW5kbGVyIH0gZnJvbSBcIi4vZXZlbnRfaGFuZGxlclwiO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQmluZGluZ0RhdGFBcHBlbmRPYmplY3RFdmVudEhhbmRsZXIgZXh0ZW5kcyBFdmVudEhhbmRsZXIge1xyXG4gIC8qKlxyXG4gICAqIOi/h+a7pOWHuumcgOimgeiuoeeul+eahOihqOi+vuW8j1xyXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBmaWx0ZXIoZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKTogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0W10ge1xyXG5cclxuICAgIGlmICh0aGlzLmV4cHJlc3Npb25PYmplY3RzICYmIHRoaXMuZXhwcmVzc2lvbk9iamVjdHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAvLyBjb25zdCBmdWxsRXZlbnRQYXRoID0gZXZlbnQucGF0aCB8fCBbXTtcclxuICAgICAgLy8gZXZlbnQucGF0aCBsaWtlIFtcImlkOjdkZDc3ZTUwLWViZWQtNDYzOS1iNDgzLWQxMjAwNDYwMzY0MFwiLCBcImZvcm1FRVVSMUUxc1wiXSBvciB1bmRlZmluZWQgb3IgW11cclxuICAgICAgLy8gZXZlbnRUYWJsZVBhdGhzIGxpa2UgW10gb3IgW1wi5a2Q6KGoc1wiXVxyXG5cclxuICAgICAgLy8g5om+5Yiw6IGa5ZCI55u45YWz6KGo6L6+5byPKOS+nei1luaWsOWinuihqOeahOihqOi+vuW8jyks6IGa5ZCI55qE5YmN5o+Q5piv6KGo6L6+5byPcGF0aOS9jeS6juS6i+S7tui3r+W+hOeahOS4iuaWuVxyXG4gICAgICAvLyDnu5nlrp7kvZPlsZ7mgKfmiJZ2b+WPmOmHj+iuvue9ruS6huiBmuWQiOebuOWFs+eahOihqOi+vuW8j++8jOatpOaXtuihqOi+vuW8j+S+nei1luS4rei3r+W+hOWIsOWtkOihqOWxnuaAp1xyXG4gICAgICBjb25zdCBncm91cEV4cHJlc3Npb25zID0gdGhpcy5leHByZXNzaW9uT2JqZWN0cy5maWx0ZXIoKGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkgPT4ge1xyXG4gICAgICAgIGlmIChleHByZXNzaW9uT2JqZWN0Lm5zICE9PSBldmVudC5ucyB8fCAhZXhwcmVzc2lvbk9iamVjdC5kZXBzIHx8IGV4cHJlc3Npb25PYmplY3QuZGVwcy5sZW5ndGggPCAxKSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGV2ZW50VGFibGVQYXRocyA9IHRoaXMuYnVpbGRFbnRpdHlQYXRoKGV2ZW50LnBhdGgpO1xyXG4gICAgICAgIGNvbnN0IGluZm8gPSB0aGlzLmFuYWx5c2lzKGV2ZW50LCBleHByZXNzaW9uT2JqZWN0KTtcclxuICAgICAgICBpZiAoIWluZm8pIHtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gY29uc3QgZXZlbnRFbnRpdHlQYXRoID0gdGhpcy5idWlsZEVudGl0eVBhdGgoZXZlbnQucGF0aCk7XHJcbiAgICAgICAgLy8g5Li76KGo5paw5aKeXHJcbiAgICAgICAgaWYgKGV2ZW50VGFibGVQYXRocy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgIGlmIChleHByZXNzaW9uT2JqZWN0LmJpbmRpbmdUeXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25CaW5kaW5nVHlwZS5GaWVsZCkge1xyXG4gICAgICAgICAgICAvLyDorqTkuLrkuLvooajmlrDlop7ml7bkuI3pnIDopoHlpITnkIbogZrlkIjlh73mlbBcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDku47ooajmiJbku47ku47ooajmlrDlop5cclxuICAgICAgICBldmVudFRhYmxlUGF0aHMuc3BsaWNlKDAsIDAsIEVOVElUWV9URU1QTEFURSk7XHJcbiAgICAgICAgLy8gZXZlbnRFbnRpdHlQYXRoIGxpa2UgWydFTlRJVFl+JywnZm9ybUVFVVIxRTFzJ10gLy8g5LuO6KGo5paw5aKeXHJcbiAgICAgICAgLy8gZGVwcyBsaWtlIFsnRU5USVRZfi9mb3JtRUVVUjFFMXMvdWR0L3VkdF9maWVsZCcsJ0VOVElUWX4vZm9ybUVFVVIxRTFzL3JlZi9yZWZfdWR0L3JlZl91ZHRfZmllbGQnXVxyXG4gICAgICAgIC8vIOS7heWkhOeQhuS4iue6p+ihqOi+vuW8j1xyXG4gICAgICAgIGlmIChpbmZvLmV2ZW50VGFibGVQYXRocy5sZW5ndGggLSAxICE9PSBpbmZvLmV4cHJlc3Npb25UYWJsZVBhdGhzLmxlbmd0aCkge1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDkuI3mlK/mjIHot6jooahcclxuICAgICAgICBpZiAoIWluZm8uZXZlbnRUYWJsZVBhdGhzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpLnN0YXJ0c1dpdGgoaW5mby5leHByZXNzaW9uVGFibGVQYXRocy5qb2luKEV4cHJlc3Npb24uREVQRU5ERU5DWV9TUExJVEVSKSkpIHtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgaW5kZXggPSBleHByZXNzaW9uT2JqZWN0LmRlcHMuZmluZEluZGV4KChkZXA6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgLy8g5L6d6LWWXHJcbiAgICAgICAgICBpZiAoIWRlcC5zdGFydHNXaXRoKGV2ZW50VGFibGVQYXRocy5qb2luKEV4cHJlc3Npb24uREVQRU5ERU5DWV9TUExJVEVSKSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgZGVwcyA9IGRlcC5zcGxpdChFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikuZmlsdGVyKHAgPT4gcCkuc2xpY2UoMSk7XHJcbiAgICAgICAgICBjb25zdCBkZXBlbmRQYXRoSW5mbyA9IHRoaXMuZ2V0UGF0aEluZm8oZGVwcy5qb2luKEV4cHJlc3Npb24uREVQRU5ERU5DWV9TUExJVEVSKSk7XHJcbiAgICAgICAgICBpZiAoZGVwZW5kUGF0aEluZm8gJiYgZGVwZW5kUGF0aEluZm8ucGF0aHMuam9pbihFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikgPT09IGluZm8uZXZlbnRUYWJsZVBhdGhzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBpbmRleCA9PT0gLTEgPyBmYWxzZSA6IHRydWU7XHJcbiAgICAgIH0pO1xyXG4gICAgICBjb25zdCBldmVudFRhYmxlUGF0aHMgPSB0aGlzLmJ1aWxkRW50aXR5UGF0aChldmVudC5wYXRoKTtcclxuICAgICAgLy8g5LqL5Lu26KGo5Lit6KGo6L6+5byP77yI5LqL5Lu26KGo5pys6Lqr55qE6KGo6L6+5byP77yJXHJcbiAgICAgIGNvbnN0IHJlbGF0aXZlRXhwcmVzc2lvbnMgPSB0aGlzLmV4cHJlc3Npb25PYmplY3RzLmZpbHRlcigoZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KSA9PiB7XHJcbiAgICAgICAgLy8gZXhwcmVzc2lvbk9iamVjdC5iaW5kaW5nVHlwZSAhPT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uQmluZGluZ1R5cGUuRmllbGQg5pqC5LiN5pSv5oyBU3RhdGXooajovr7lvI9cclxuICAgICAgICBpZiAoZXhwcmVzc2lvbk9iamVjdC5ucyAhPT0gZXZlbnQubnMpIHtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZXhwcmVzc2lvblBhdGhJbmZvID0gdGhpcy5nZXRQYXRoSW5mbyhleHByZXNzaW9uT2JqZWN0LnBhdGgpO1xyXG4gICAgICAgIC8vIOi/h+a7pOaOiemdnuW9k+WJjeihqOeahOihqOi+vuW8j1xyXG4gICAgICAgIGlmIChleHByZXNzaW9uUGF0aEluZm8ucGF0aHMuam9pbihFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikgIT09IGV2ZW50VGFibGVQYXRocy5qb2luKEV4cHJlc3Npb24uREVQRU5ERU5DWV9TUExJVEVSKSkge1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDooajovr7lvI/mmK/orqHnrpfmiJbkvp3otZbooajovr7lvI/lubbkuJTmmK/liIblsYLliqDovb3lnLrmma/vvIzkuI3orqHnrpfvvIzku4XlvZPkvp3otZblj5jljJbml7borqHnrpdcclxuICAgICAgICBpZiAoKGV4cHJlc3Npb25PYmplY3QudHlwZSA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5Db21wdXRlIHx8IGV4cHJlc3Npb25PYmplY3QudHlwZSA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5EZXBlbmRlbmN5KSAmJiBldmVudC5pc1RyZWVOb2RlTG9hZFNjZW5lKSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOayoeacieS+nei1lueahOihqOi+vuW8j1xyXG4gICAgICAgIGlmICghZXhwcmVzc2lvbk9iamVjdC5kZXBzIHx8IGV4cHJlc3Npb25PYmplY3QuZGVwcy5sZW5ndGggPCAxKSB7XHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5LuF5L6d6LWWU3RhdGVcclxuICAgICAgICBjb25zdCBvbmx5RGVwZW5kT25TdGF0ZSA9IGV4cHJlc3Npb25PYmplY3QuZGVwcy5ldmVyeSgoZGVwOiBzdHJpbmcpID0+IGRlcC5zdGFydHNXaXRoKFNUQVRFX1RFTVBMQVRFKSk7XHJcbiAgICAgICAgLy8g5LuF5L6d6LWW5b2T5YmN6KGo5oiW5LiK57qn6KGoXHJcbiAgICAgICAgLy8gY29uc3Qgb25seURlcGVuZE9uQ3VycmVudFRhYmxlID0gZXhwcmVzc2lvbk9iamVjdC5kZXBzLmV2ZXJ5KChkZXA6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIC8vICAgaWYgKCFkZXAuc3RhcnRzV2l0aChFTlRJVFlfVEVNUExBVEUpKSB7XHJcbiAgICAgICAgLy8gICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAvLyAgIH1cclxuICAgICAgICAvLyAgIGNvbnN0IGRlcHMgPSBkZXAuc3BsaXQoRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpLnNsaWNlKDEpO1xyXG4gICAgICAgIC8vICAgY29uc3QgZGVwZW5kUGF0aEluZm8gPSB0aGlzLmdldFBhdGhJbmZvKGRlcHMuam9pbihFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikpO1xyXG4gICAgICAgIC8vICAgcmV0dXJuIGRlcGVuZFBhdGhJbmZvLnBhdGhzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpID09PSBldmVudFRhYmxlUGF0aHMuam9pbihFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikgfHwgZXZlbnRUYWJsZVBhdGhzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpLnN0YXJ0c1dpdGgoZGVwZW5kUGF0aEluZm8ucGF0aHMuam9pbihFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikpICYmIGRlcGVuZFBhdGhJbmZvLnBhdGhzLmxlbmd0aCArIDEgPT0gZXZlbnRUYWJsZVBhdGhzLmxlbmd0aDtcclxuICAgICAgICAvLyB9KTtcclxuICAgICAgICAvLyBpZiAob25seURlcGVuZE9uU3RhdGUgfHwgb25seURlcGVuZE9uQ3VycmVudFRhYmxlKSB7XHJcbiAgICAgICAgLy8gICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAvLyB9XHJcbiAgICAgICAgaWYgKG9ubHlEZXBlbmRPblN0YXRlKSB7XHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuYW5hbHlzaXMoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QpO1xyXG4gICAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LmRpc3RhbmNlID09PSAwICYmIHJlc3VsdC5pc1NhbWVUYWJsZSkge1xyXG4gICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOS6i+S7tuihqOihqOi+vuW8j++8jOS9huS+nei1luS4i+e6p+ihqOeahOacquiuoeeul1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICAvLyDkvp3otZblvZPliY3liqDovb3mlbDmja7nmoTooajovr7lvI9cclxuICAgICAgY29uc3QgZGVwRXhwcmVzc2lvbnMgPSB0aGlzLmV4cHJlc3Npb25PYmplY3RzLmZpbHRlcigoZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KSA9PiB7XHJcbiAgICAgICAgaWYgKGV4cHJlc3Npb25PYmplY3QubnMgIT09IGV2ZW50Lm5zIHx8ICFleHByZXNzaW9uT2JqZWN0LmRlcHMgfHwgZXhwcmVzc2lvbk9iamVjdC5kZXBzLmxlbmd0aCA8IDEgfHwgKGV4cHJlc3Npb25PYmplY3QudHlwZSAhPT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5WaXNpYmxlICYmIGV4cHJlc3Npb25PYmplY3QudHlwZSAhPT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5SZXF1aXJlZCAmJiBleHByZXNzaW9uT2JqZWN0LnR5cGUgIT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuVmFsaWRhdGUpKSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOi/h+a7pOWHuuaJgOacieWunuS9k+S+nei1llxyXG4gICAgICAgIGNvbnN0IGRlcHMgPSBleHByZXNzaW9uT2JqZWN0LmRlcHMuZmlsdGVyKChkZXA6IHN0cmluZykgPT4gZGVwLnN0YXJ0c1dpdGgoRU5USVRZX1RFTVBMQVRFKSk7XHJcbiAgICAgICAgaWYgKCFkZXBzIHx8IGRlcHMubGVuZ3RoIDwgMSkge1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLmFuYWx5c2lzKGV2ZW50LCBleHByZXNzaW9uT2JqZWN0KTtcclxuICAgICAgICBpZiAoIXJlc3VsdCkge1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDooajovr7lvI/kvp3otZbkuoblrZfmrrXvvIzpnIDopoHnoa7orqTkvp3otZbnmoTlrZfmrrXmiYDlnKjnmoTooajmmK/lkKbmmK/kuovku7booahcclxuICAgICAgICAvLyAx44CB6K6h566X5LqL5Lu26KGo6Lev5b6EXHJcbiAgICAgICAgY29uc3QgZXZlbnRQYXRoID0gZXZlbnQucGF0aC5maWx0ZXIocCA9PiBwKS5qb2luKCcvJyk7XHJcbiAgICAgICAgLy8gMuOAgeiOt+WPluS+nei1luWtl+auteeahOihqOi3r+W+hFxyXG4gICAgICAgIGNvbnN0IGluZGV4ID0gZGVwcy5maW5kSW5kZXgoKGRlcDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAvLyDljrvmjolFTlRJVFl+5YmN57yAXHJcbiAgICAgICAgICBjb25zdCBkZXBQYXRoID0gZGVwLnNwbGl0KCcvJykuc2xpY2UoMSkuam9pbignLycpO1xyXG4gICAgICAgICAgLy8g6I635Y+W5L6d6LWW5a2X5q615omA5Zyo55qE6KGo6Lev5b6EXHJcbiAgICAgICAgICBjb25zdCB7IHBhdGggfSA9IHRoaXMuZ2V0UGF0aEluZm8oZGVwUGF0aCk7XHJcbiAgICAgICAgICByZXR1cm4gcGF0aCA9PT0gZXZlbnRQYXRoO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBpbmRleCAhPT0gLTE7XHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gZ3JvdXBFeHByZXNzaW9ucy5jb25jYXQocmVsYXRpdmVFeHByZXNzaW9ucywgZGVwRXhwcmVzc2lvbnMpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWPkeW4g+S6i+S7tlxyXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxyXG4gICAqL1xyXG4gIHB1YmxpYyBkaXNwYXRjaChldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MpIHtcclxuICAgIGNvbnN0IGV4cHJlc3Npb25zID0gdGhpcy5maWx0ZXIoZXZlbnQpO1xyXG4gICAgaWYgKGV4cHJlc3Npb25zICYmIGV4cHJlc3Npb25zLmxlbmd0aCA+IDApIHtcclxuICAgICAgZXhwcmVzc2lvbnMuZm9yRWFjaCgoZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KSA9PiB7XHJcbiAgICAgICAgY29uc3QgZW50aXR5Q29udGV4dCA9IHRoaXMuYnVpbGRFbnRpdHlDb250ZXh0KGV2ZW50LCBleHByZXNzaW9uT2JqZWN0KTtcclxuICAgICAgICBjb25zdCBjb250ZXh0ID0gdGhpcy5idWlsZENvbnRleHQoZXhwcmVzc2lvbk9iamVjdCwgZXZlbnQsIGVudGl0eUNvbnRleHQpO1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMucGVyZm9ybShleHByZXNzaW9uT2JqZWN0LCBjb250ZXh0KTtcclxuICAgICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQgJiYgIXRoaXMuaXNWYWxpZGF0ZU9yUmVxdWlyZWRFeHByZXNzaW9uKGV4cHJlc3Npb25PYmplY3QpKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGV4cHJlc3Npb25PYmplY3QucmVzdWx0ID0gdGhpcy5jb252ZXJ0Qm9vbGVhblR5cGVFeHByZXNzaW9uUmVzdWx0KGV4cHJlc3Npb25PYmplY3QsIHJlc3VsdCk7XHJcbiAgICAgICAgaWYgKGV4cHJlc3Npb25PYmplY3QuaWQpIHtcclxuICAgICAgICAgIHRoaXMuZXhwcmVzc2lvblJlc3VsdC5zZXQoZXhwcmVzc2lvbk9iamVjdC5pZCwgZXhwcmVzc2lvbk9iamVjdC5yZXN1bHQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyBjb25zb2xlLndhcm4oYEV2ZW50SGFuZGxlciDooajovr7lvI/mnKrorr7nva7llK/kuIDmoIfor4bvvIzml6Dms5Xmm7TmlrDooajovr7lvI/lgLzjgIJgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5lZmZlY3QoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5a2Q6KGo5LqL5Lu26KGMXHJcbiAgICogQHBhcmFtIHBhdGhzIFxyXG4gICAqIEBwYXJhbSBldmVudCBcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0Q3VycmVudFJvd0J5RXZlbnQocGF0aHM6IHN0cmluZ1tdLCBldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MpOiBudWxsIHwgeyBbcHJvcDogc3RyaW5nXTogYW55IH0ge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0Q3VycmVudFJvd0J5UGF0aHMocGF0aHMpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmlrDlop7lia/kvZznlKjlmahcclxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcclxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbk9iamVjdCDooajovr7lvI9cclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZWZmZWN0KGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncywgZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KTogdm9pZCB7XHJcbiAgICBjb25zdCBlZmZlY3RUbyA9IGV4cHJlc3Npb25PYmplY3QuYmluZGluZ1R5cGU7XHJcbiAgICBjb25zdCBldmVudFBhdGggPSB0aGlzLmNsZWFuRXZlbnRQYXRoKGV2ZW50LnBhdGgpO1xyXG4gICAgY29uc3QgZWZmZWN0b3IgPSB0aGlzLmVmZmVjdG9yRmFjdG9yeS5nZXRFZmZlY3RvcihleHByZXNzaW9uT2JqZWN0KTtcclxuICAgIGlmICghZWZmZWN0b3IpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgaW5mbyA9IHRoaXMuYW5hbHlzaXMoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QpO1xyXG4gICAgaWYgKCFpbmZvKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGV4cHJlc3Npb25QYXRocyA9IGV4cHJlc3Npb25PYmplY3QucGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgaWYgKGVmZmVjdFRvID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25CaW5kaW5nVHlwZS5GaWVsZCkge1xyXG4gICAgICBjb25zdCBwYXRoczogYW55W11bXSA9IFtdO1xyXG4gICAgICBjb25zdCBwcm9wZXJ0eVBhdGhzID0gZXhwcmVzc2lvblBhdGhzLnNsaWNlKGluZm8uZXhwcmVzc2lvblRhYmxlUGF0aHMubGVuZ3RoKTtcclxuICAgICAgLy8g5paw5aKe5Zy65pmv6ZyA6KaB6K6h566X5LqL5Lu26KGoXFzkuovku7booajkuIrpnaLnmoTooahcXOS4i+WxguihqOeahOWPr+ingeOAgeW/heWhq+OAgeagoemqjFxyXG4gICAgICBpZiAoaW5mby5kaXN0YW5jZSA9PT0gMCkge1xyXG4gICAgICAgIGlmICghaW5mby5pc1NhbWVUYWJsZSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDooajovr7lvI/lkozkuovku7blnKjlkIzkuIDkuKrooahcclxuICAgICAgICBjb25zdCBwcmV2UGF0aHMgPSBldmVudFBhdGguc2xpY2UoMCk7XHJcbiAgICAgICAgaWYgKGV2ZW50UGF0aC5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICAgIC8vIOS4u+ihqOaWsOWinu+8jOatpOaXtuS6i+S7tui3r+W+hOS4reacieS4u+mUru+8jOebtOaOpeaLvOaOpeWxnuaAp+WwseaYr+WujOaVtOi3r+W+hFxyXG4gICAgICAgICAgaWYgKGV2ZW50LnZhbHVlICYmIEFycmF5LmlzQXJyYXkoZXZlbnQudmFsdWUpKSB7XHJcbiAgICAgICAgICAgIGV2ZW50LnZhbHVlLmZvckVhY2goKGJpbmRpbmdPYmplY3Q6IEJpbmRpbmdPYmplY3QpID0+IHtcclxuICAgICAgICAgICAgICBwYXRocy5wdXNoKFtiaW5kaW5nT2JqZWN0LnByaW1hcnlLZXlWYWx1ZV0uY29uY2F0KHByb3BlcnR5UGF0aHMpKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBwYXRoID0gcHJldlBhdGhzLmNvbmNhdChwcm9wZXJ0eVBhdGhzKTtcclxuICAgICAgICAgICAgcGF0aHMucHVzaChwYXRoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8g5LuO6KGo5oiW5LuO5LuO6KGo5paw5aKe77yM5q2k5pe25LqL5Lu26Lev5b6E5Lit57y65bCR5pyA5ZCO5LiA5Liq5bGC57qn55qE5Li76ZSuXHJcbiAgICAgICAgICBpZiAoZXZlbnQudmFsdWUgJiYgQXJyYXkuaXNBcnJheShldmVudC52YWx1ZSkpIHtcclxuICAgICAgICAgICAgZXZlbnQudmFsdWUuZm9yRWFjaCgoYmluZGluZ09iamVjdDogQmluZGluZ09iamVjdCkgPT4ge1xyXG4gICAgICAgICAgICAgIHBhdGhzLnB1c2gocHJldlBhdGhzLmNvbmNhdChbYmluZGluZ09iamVjdC5wcmltYXJ5S2V5VmFsdWVdKS5jb25jYXQocHJvcGVydHlQYXRocykpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdMaXN0ID0gdGhpcy5iaW5kaW5nRGF0YS5nZXRWYWx1ZShpbmZvLmV2ZW50VGFibGVQYXRocykgYXMgQmluZGluZ0xpc3Q7XHJcbiAgICAgICAgICAgIGlmIChiaW5kaW5nTGlzdCAmJiBiaW5kaW5nTGlzdC5jdXJyZW50SWQpIHtcclxuICAgICAgICAgICAgICBwYXRocy5wdXNoKHByZXZQYXRocy5jb25jYXQoYmluZGluZ0xpc3QuY3VycmVudElkKS5jb25jYXQocHJvcGVydHlQYXRocykpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIOihqOi+vuW8j+WSjOS6i+S7tuS4jeWcqOWQjOS4gOS4quihqO+8jOWNs+S4i+e6p+ihqOaWsOWinuaIluaJuemHj+aWsOWinuS6huS4gOaJueaVsOaNrlxyXG4gICAgICAgIGlmIChpbmZvLmV2ZW50RnJvbVBhcmVudCA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgLy8g5LuF5aSE55CG5LiL57qn6KGo77yM6Leo6KGo6Lez6L+HXHJcbiAgICAgICAgICBpZiAoaW5mby5leHByZXNzaW9uVGFibGVQYXRocy5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIC8vIOS4i+WxguihqOeahOWPr+ingeOAgeW/heWhq+OAgeagoemqjFxyXG4gICAgICAgICAgbGV0IHByZXZQYXRocyA9IGV2ZW50UGF0aC5zbGljZSgwLCBldmVudFBhdGgubGVuZ3RoKTtcclxuICAgICAgICAgIC8vIOWtkOihqOaWsOWinlxyXG4gICAgICAgICAgaWYgKGV2ZW50UGF0aCAmJiBldmVudFBhdGgubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBwcmV2UGF0aHMgPSBldmVudFBhdGguc2xpY2UoMCwgZXZlbnRQYXRoLmxlbmd0aCk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyDkuLvooajmlrDlop5cclxuICAgICAgICAgICAgcHJldlBhdGhzID0gW3RoaXMuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQsIGluZm8uZXhwcmVzc2lvblRhYmxlUGF0aHNbMF0sIG51bGxdO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIGNvbnN0IHBhdGggPSBwcmV2UGF0aHMuY29uY2F0KHByb3BlcnR5UGF0aHMpO1xyXG4gICAgICAgICAgcGF0aHMucHVzaChwYXRoKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGluZm8uZXZlbnRGcm9tQ2hpbGRyZW4gPT09IHRydWUpIHtcclxuICAgICAgICAgIGNvbnN0IHByZXZQYXRocyA9IGV2ZW50UGF0aC5zbGljZSgwLCBldmVudFBhdGgubGVuZ3RoIC0gMSk7XHJcbiAgICAgICAgICBjb25zdCBwYXRoID0gcHJldlBhdGhzLmNvbmNhdChwcm9wZXJ0eVBhdGhzKTtcclxuICAgICAgICAgIHBhdGhzLnB1c2gocGF0aCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcGF0aHMuZm9yRWFjaCgocGF0aDogYW55W10pID0+IHtcclxuICAgICAgICBjb25zdCBjdXJyZW50Um93cyA9IHRoaXMuYnVpbGRDdXJyZW50Um93cyhpbmZvLmV4cHJlc3Npb25UYWJsZVBhdGhzLCBwYXRoKTtcclxuICAgICAgICB0aGlzLm91dHB1dChldmVudCwgZXhwcmVzc2lvbk9iamVjdCwgY3VycmVudFJvd3MsIGVmZmVjdG9yLCBbcGF0aF0pO1xyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSBpZiAoZWZmZWN0VG8gPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvbkJpbmRpbmdUeXBlLlN0YXRlKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ25vdCBzdXBwb3J0ZWTvvIEnKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHVibGljIG91dHB1dChldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MsIGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCwgY3VycmVudFJvd3M6IEV4cHJlc3Npb24uSUN1cnJlbnRSb3dbXSwgZWZmZWN0b3I6IEV4cHJlc3Npb24uRWZmZWN0b3IsIHBhdGhzOiBhbnlbXVtdKSB7XHJcbiAgICBjb25zdCBjb250ZXh0ID0gdGhpcy5idWlsZENvbnRleHQoZXhwcmVzc2lvbk9iamVjdCwgZXZlbnQsIG51bGwsIGN1cnJlbnRSb3dzKTtcclxuICAgIGNvbnN0IHZhbHVlID0gdGhpcy5wZXJmb3JtKGV4cHJlc3Npb25PYmplY3QsIGNvbnRleHQpO1xyXG4gICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgZXhwcmVzc2lvbk9iamVjdC5yZXN1bHQgPSB2YWx1ZTtcclxuICAgIGlmIChleHByZXNzaW9uT2JqZWN0LmlkKSB7XHJcbiAgICAgIHRoaXMuZXhwcmVzc2lvblJlc3VsdC5zZXQoZXhwcmVzc2lvbk9iamVjdC5pZCwgZXhwcmVzc2lvbk9iamVjdC5yZXN1bHQpO1xyXG4gICAgfVxyXG4gICAgRWZmZWN0b3JNYW5hZ2VyLmVmZmVjdChlZmZlY3RvciwgZXhwcmVzc2lvbk9iamVjdCwgcGF0aHMpO1xyXG4gIH1cclxufSJdfQ==