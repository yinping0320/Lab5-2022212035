import * as tslib_1 from "tslib";
import { Injectable } from "@angular/core";
import { Expression } from "../expression/index";
import { ENTITY_TEMPLATE } from "../resolver/index";
import { ExpressionUtil } from "../utils/expression_util";
import { EventHandler } from "./event_handler";
var EntityUpdateEventHandler = /** @class */ (function (_super) {
    tslib_1.__extends(EntityUpdateEventHandler, _super);
    function EntityUpdateEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    EntityUpdateEventHandler.prototype.filter = function (event) {
        var _this = this;
        return this.expressionObjects.filter(function (expressionObject) {
            // 重新加载实体时不计算计算表达式，只处理只读、必填等
            if (expressionObject.ns !== event.ns || !expressionObject.deps || expressionObject.deps.length === 0 || expressionObject.type === Expression.ExpressionType.Compute || expressionObject.type === Expression.ExpressionType.Dependency || expressionObject.type === Expression.ExpressionType.DataPicking) {
                return false;
            }
            var result = _this.analysis(event, expressionObject);
            if (!result) {
                return false;
            }
            // 必须是主表表达式
            if (result.expressionTablePaths.length !== 0) {
                return false;
            }
            var index = expressionObject.deps.findIndex(function (dep) {
                if (!dep.startsWith(ENTITY_TEMPLATE)) {
                    return false;
                }
                var deps = dep.split(Expression.DEPENDENCY_SPLITER).filter(function (p) { return p; }).slice(1);
                var depPathInfo = _this.getPathInfo(deps.join('/'));
                if (!depPathInfo) {
                    return false;
                }
                if (depPathInfo.paths.length !== 0) {
                    return false;
                }
                return true;
            });
            return index === -1 ? false : true;
        });
    };
    /**
     * 发布事件
     * @param event event
     */
    EntityUpdateEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                var entityContext = _this.buildEntityContext(event, expressionObject);
                var context = _this.buildContext(expressionObject, event, entityContext);
                var result = _this.perform(expressionObject, context);
                if (result === undefined && !_this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = _this.convertBooleanTypeExpressionResult(expressionObject, result);
                ;
                if (expressionObject.id) {
                    _this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                else {
                }
                _this.effect(event, expressionObject);
            });
        }
    };
    EntityUpdateEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        var result = null;
        var bindingList = this.bindingData.getValue(paths);
        var eventEntityPath = this.getEntityPath(event.path);
        if (bindingList && bindingList.length > 0) {
            var primaryValue = bindingList.currentItem.primaryKeyValue || null;
            // 使用事件中的主键
            var childrenPaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(eventEntityPath, this.repository.entityTypeInfo);
            if (childrenPaths && childrenPaths.toString() === paths.toString()) {
                // 发生值变化的数据位于要获取当前行的子表中，此时事件行应该是发生值变化的数据id，而不是当前行id
                primaryValue = event.id || null;
                if (!primaryValue) {
                    primaryValue = this.getEventId(event.path, paths[paths.length - 1]);
                }
            }
            if (primaryValue) {
                var bindingObject = bindingList.findById(primaryValue);
                if (bindingObject) {
                    result = bindingObject.toJSON();
                }
            }
        }
        return result;
    };
    EntityUpdateEventHandler.decorators = [
        { type: Injectable }
    ];
    return EntityUpdateEventHandler;
}(EventHandler));
export { EntityUpdateEventHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X3VwZGF0ZV9ldmVudF9oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZXZlbnQtaGFuZGxlci9lbnRpdHlfdXBkYXRlX2V2ZW50X2hhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDMUQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRS9DO0lBQzhDLG9EQUFZO0lBRDFEOztJQWdGQSxDQUFDO0lBOUVRLHlDQUFNLEdBQWIsVUFBYyxLQUEyQjtRQUF6QyxpQkE4QkM7UUE3QkMsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLFVBQUMsZ0JBQTZDO1lBQ2pGLDRCQUE0QjtZQUM1QixJQUFJLGdCQUFnQixDQUFDLEVBQUUsS0FBSyxLQUFLLENBQUMsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxJQUFJLGdCQUFnQixDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLGdCQUFnQixDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsY0FBYyxDQUFDLE9BQU8sSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLGNBQWMsQ0FBQyxVQUFVLElBQUksZ0JBQWdCLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFO2dCQUN4UyxPQUFPLEtBQUssQ0FBQzthQUNkO1lBQ0QsSUFBTSxNQUFNLEdBQUcsS0FBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLENBQUMs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QWEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkQsSUFBSSxXQUFXLElBQUksV0FBVyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDekMsSUFBSSxZQUFZLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQyxlQUFlLElBQUksSUFBSSxDQUFDO1lBQ25FLFdBQVc7WUFDWCxJQUFNLGFBQWEsR0FBRyxjQUFjLENBQUMsd0NBQXdDLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDL0gsSUFBSSxhQUFhLElBQUksYUFBYSxDQUFDLFFBQVEsRUFBRSxLQUFLLEtBQUssQ0FBQyxRQUFRLEVBQUUsRUFBRTtnQkFDbEUsbURBQW1EO2dCQUNuRCxZQUFZLEdBQUcsS0FBSyxDQUFDLEVBQUUsSUFBSSxJQUFJLENBQUM7Z0JBQ2hDLElBQUksQ0FBQyxZQUFZLEVBQUU7b0JBQ2pCLFlBQVksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDckU7YUFDRjtZQUNELElBQUksWUFBWSxFQUFFO2dCQUNoQixJQUFNLGFBQWEsR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUN6RCxJQUFJLGFBQWEsRUFBRTtvQkFDakIsTUFBTSxHQUFHLGFBQWEsQ0FBQyxNQUFNLEVBQUUsQ0FBQztpQkFDakM7YUFDRjtTQUNGO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQzs7Z0JBL0VGLFVBQVU7O0lBZ0ZYLCtCQUFDO0NBQUEsQUFoRkQsQ0FDOEMsWUFBWSxHQStFekQ7U0EvRVksd0JBQXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IEJpbmRpbmdMaXN0IH0gZnJvbSBcIi4uL2JpbmRpbmctZGF0YS9pbmRleFwiO1xyXG5pbXBvcnQgeyBFeHByZXNzaW9uIH0gZnJvbSBcIi4uL2V4cHJlc3Npb24vaW5kZXhcIjtcclxuaW1wb3J0IHsgRU5USVRZX1RFTVBMQVRFIH0gZnJvbSBcIi4uL3Jlc29sdmVyL2luZGV4XCI7XHJcbmltcG9ydCB7IEV4cHJlc3Npb25VdGlsIH0gZnJvbSBcIi4uL3V0aWxzL2V4cHJlc3Npb25fdXRpbFwiO1xyXG5pbXBvcnQgeyBFdmVudEhhbmRsZXIgfSBmcm9tIFwiLi9ldmVudF9oYW5kbGVyXCI7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBFbnRpdHlVcGRhdGVFdmVudEhhbmRsZXIgZXh0ZW5kcyBFdmVudEhhbmRsZXIge1xyXG4gIHB1YmxpYyBmaWx0ZXIoZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKSB7XHJcbiAgICByZXR1cm4gdGhpcy5leHByZXNzaW9uT2JqZWN0cy5maWx0ZXIoKGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkgPT4ge1xyXG4gICAgICAvLyDph43mlrDliqDovb3lrp7kvZPml7bkuI3orqHnrpforqHnrpfooajovr7lvI/vvIzlj6rlpITnkIblj6ror7vjgIHlv4XloavnrYlcclxuICAgICAgaWYgKGV4cHJlc3Npb25PYmplY3QubnMgIT09IGV2ZW50Lm5zIHx8ICFleHByZXNzaW9uT2JqZWN0LmRlcHMgfHwgZXhwcmVzc2lvbk9iamVjdC5kZXBzLmxlbmd0aCA9PT0gMCB8fCBleHByZXNzaW9uT2JqZWN0LnR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuQ29tcHV0ZSB8fCBleHByZXNzaW9uT2JqZWN0LnR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuRGVwZW5kZW5jeSB8fCBleHByZXNzaW9uT2JqZWN0LnR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuRGF0YVBpY2tpbmcpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5hbmFseXNpcyhldmVudCwgZXhwcmVzc2lvbk9iamVjdCk7XHJcbiAgICAgIGlmICghcmVzdWx0KSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIOW/hemhu+aYr+S4u+ihqOihqOi+vuW8j1xyXG4gICAgICBpZiAocmVzdWx0LmV4cHJlc3Npb25UYWJsZVBhdGhzLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBpbmRleCA9IGV4cHJlc3Npb25PYmplY3QuZGVwcy5maW5kSW5kZXgoKGRlcDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgaWYgKCFkZXAuc3RhcnRzV2l0aChFTlRJVFlfVEVNUExBVEUpKSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGRlcHMgPSBkZXAuc3BsaXQoRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpLmZpbHRlcihwID0+IHApLnNsaWNlKDEpO1xyXG4gICAgICAgIGNvbnN0IGRlcFBhdGhJbmZvID0gdGhpcy5nZXRQYXRoSW5mbyhkZXBzLmpvaW4oJy8nKSk7XHJcbiAgICAgICAgaWYgKCFkZXBQYXRoSW5mbykge1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZGVwUGF0aEluZm8ucGF0aHMubGVuZ3RoICE9PSAwKSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuIGluZGV4ID09PSAtMSA/IGZhbHNlIDogdHJ1ZTtcclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlj5HluIPkuovku7ZcclxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcclxuICAgKi9cclxuICBwdWJsaWMgZGlzcGF0Y2goZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKSB7XHJcbiAgICBjb25zdCBleHByZXNzaW9ucyA9IHRoaXMuZmlsdGVyKGV2ZW50KTtcclxuICAgIGlmIChleHByZXNzaW9ucyAmJiBleHByZXNzaW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGV4cHJlc3Npb25zLmZvckVhY2goKGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGVudGl0eUNvbnRleHQgPSB0aGlzLmJ1aWxkRW50aXR5Q29udGV4dChldmVudCwgZXhwcmVzc2lvbk9iamVjdCk7XHJcbiAgICAgICAgY29uc3QgY29udGV4dCA9IHRoaXMuYnVpbGRDb250ZXh0KGV4cHJlc3Npb25PYmplY3QsIGV2ZW50LCBlbnRpdHlDb250ZXh0KTtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnBlcmZvcm0oZXhwcmVzc2lvbk9iamVjdCwgY29udGV4dCk7XHJcbiAgICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkICYmICF0aGlzLmlzVmFsaWRhdGVPclJlcXVpcmVkRXhwcmVzc2lvbihleHByZXNzaW9uT2JqZWN0KSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCA9IHRoaXMuY29udmVydEJvb2xlYW5UeXBlRXhwcmVzc2lvblJlc3VsdChleHByZXNzaW9uT2JqZWN0LCByZXN1bHQpOztcclxuICAgICAgICBpZiAoZXhwcmVzc2lvbk9iamVjdC5pZCkge1xyXG4gICAgICAgICAgdGhpcy5leHByZXNzaW9uUmVzdWx0LnNldChleHByZXNzaW9uT2JqZWN0LmlkLCBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5lZmZlY3QoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgcHVibGljIGdldEN1cnJlbnRSb3dCeUV2ZW50KHBhdGhzOiBzdHJpbmdbXSwgZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKSB7XHJcbiAgICBsZXQgcmVzdWx0ID0gbnVsbDtcclxuICAgIGNvbnN0IGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCA9IHRoaXMuYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xyXG4gICAgY29uc3QgZXZlbnRFbnRpdHlQYXRoID0gdGhpcy5nZXRFbnRpdHlQYXRoKGV2ZW50LnBhdGgpO1xyXG4gICAgaWYgKGJpbmRpbmdMaXN0ICYmIGJpbmRpbmdMaXN0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgbGV0IHByaW1hcnlWYWx1ZSA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZSB8fCBudWxsO1xyXG4gICAgICAvLyDkvb/nlKjkuovku7bkuK3nmoTkuLvplK5cclxuICAgICAgY29uc3QgY2hpbGRyZW5QYXRocyA9IEV4cHJlc3Npb25VdGlsLmdldEF2YWlsYWJsZUNoaWxkcmVuUGF0aHNGcm9tRW50aXR5UGF0aHMoZXZlbnRFbnRpdHlQYXRoLCB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8pO1xyXG4gICAgICBpZiAoY2hpbGRyZW5QYXRocyAmJiBjaGlsZHJlblBhdGhzLnRvU3RyaW5nKCkgPT09IHBhdGhzLnRvU3RyaW5nKCkpIHtcclxuICAgICAgICAvLyDlj5HnlJ/lgLzlj5jljJbnmoTmlbDmja7kvY3kuo7opoHojrflj5blvZPliY3ooYznmoTlrZDooajkuK3vvIzmraTml7bkuovku7booYzlupTor6XmmK/lj5HnlJ/lgLzlj5jljJbnmoTmlbDmja5pZO+8jOiAjOS4jeaYr+W9k+WJjeihjGlkXHJcbiAgICAgICAgcHJpbWFyeVZhbHVlID0gZXZlbnQuaWQgfHwgbnVsbDtcclxuICAgICAgICBpZiAoIXByaW1hcnlWYWx1ZSkge1xyXG4gICAgICAgICAgcHJpbWFyeVZhbHVlID0gdGhpcy5nZXRFdmVudElkKGV2ZW50LnBhdGgsIHBhdGhzW3BhdGhzLmxlbmd0aCAtIDFdKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHByaW1hcnlWYWx1ZSkge1xyXG4gICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBiaW5kaW5nTGlzdC5maW5kQnlJZChwcmltYXJ5VmFsdWUpO1xyXG4gICAgICAgIGlmIChiaW5kaW5nT2JqZWN0KSB7XHJcbiAgICAgICAgICByZXN1bHQgPSBiaW5kaW5nT2JqZWN0LnRvSlNPTigpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcbn0iXX0=