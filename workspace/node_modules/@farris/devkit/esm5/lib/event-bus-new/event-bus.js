import * as tslib_1 from "tslib";
import { Injectable, Type } from '@angular/core';
import { EventBusProxy } from './event-bus-proxy';
import { EventPipe } from './event-pipe';
var EventBus = /** @class */ (function () {
    function EventBus() {
        this.proxyMap = new Map();
        this.eventMap = new Map();
    }
    EventBus.prototype.getProxy = function (ownerType, eventTokenValueProvider) {
        var ownerName = ownerType.constructor.typeName || ownerType.constructor.name;
        if (!this.proxyMap.has(ownerName)) {
            this.proxyMap.set(ownerName, new EventBusProxy(this, ownerType, eventTokenValueProvider));
        }
        return this.proxyMap.get(ownerName);
    };
    /**
     * 发送事件，通知订阅者接收消息。
     */
    // tslint:disable-next-line: max-line-length
    EventBus.prototype.post = function (emitterType, tokenValue, eventName, eventArgs, sender, eventType, eventId) {
        var e_1, _a;
        var eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            return;
        }
        if (!emitterType) {
            console.error('post方法的参数emitterType不能为空。');
            return;
        }
        var emitter;
        if (emitterType instanceof Type) {
            emitter = emitterType.typeName || emitterType.name;
        }
        else {
            emitter = emitterType;
        }
        if (typeof eventId === 'undefined') {
            eventId = new Date().valueOf();
        }
        try {
            for (var eventPipeList_1 = tslib_1.__values(eventPipeList), eventPipeList_1_1 = eventPipeList_1.next(); !eventPipeList_1_1.done; eventPipeList_1_1 = eventPipeList_1.next()) {
                var eventPipe = eventPipeList_1_1.value;
                if (eventPipe.matchEmitterToken(emitter, tokenValue)) {
                    eventPipe.post(eventArgs, sender, eventType, eventId);
                    eventPipe.unSubscribeForOnce();
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (eventPipeList_1_1 && !eventPipeList_1_1.done && (_a = eventPipeList_1.return)) _a.call(eventPipeList_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
    };
    /**
     * 订阅事件
     */
    EventBus.prototype.on = function (target, tokenValue, eventName, caller, handler) {
        return this.getEventPipe(eventName, target, tokenValue).subscribe(handler, caller);
    };
    /**
     * 注销监听
     * @param target
     * @param tokenValue
     * @param eventName
     * @param caller
     */
    EventBus.prototype.off = function (target, tokenValue, eventName, caller) {
        var eventPipeList = this.eventMap.get(eventName);
        if (eventPipeList) {
            var index = eventPipeList.findIndex(function (eventPipe) {
                if (eventPipe.subscriptions.get(caller)) {
                    return eventPipe.name === eventName && eventPipe.tokenValue === tokenValue && eventPipe.emitter === target;
                }
                return false;
            });
            if (index !== -1) {
                eventPipeList.splice(index, 1);
            }
        }
    };
    /**
     * 订阅一次。接收到一次消息之后自动取消订阅
     */
    EventBus.prototype.once = function (target, tokenValue, eventName, caller, handler) {
        return this.getEventPipe(eventName, target, tokenValue).subscribeOnce(handler, caller);
    };
    /**
     * 发送一个请求事件，获取监听者的响应并处理
     */
    EventBus.prototype.requestFor = function (target, tokenValue, requestName, requestValue, success, fail) {
        var eventPipe = this.findExistEventPipe(requestName, 'RequestSubject', tokenValue);
        if (eventPipe) {
            this.once(target, tokenValue, requestName, this, function (response) {
                if (response.status === 'success') {
                    success(response.data);
                }
                else {
                    if (fail) {
                        fail('No target responser listening');
                    }
                }
            });
            eventPipe.post({ target: target, token: tokenValue, data: requestValue });
        }
        else {
            if (fail) {
                fail('No target responser listening.');
            }
        }
    };
    /**
     * 监听一个请求事件，给出响应
     */
    EventBus.prototype.responseOn = function (responseSubject, requestName, callback) {
        var _this = this;
        this.on('RequestSubject', null, requestName, this, function (requestObj) {
            var response = { status: 'fail', data: null };
            if (responseSubject === requestObj.target) {
                response.data = callback(requestObj.data);
                response.status = 'success';
            }
            _this.post(requestObj.target, requestObj.token, requestName, response);
        });
    };
    EventBus.prototype.getEventPipe = function (eventName, target, tokenValue) {
        var eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            eventPipeList = new Array();
            this.eventMap.set(eventName, eventPipeList);
        }
        // 1、一个事件不允许多个订阅
        // let eventPipe = eventPipeList.find(item => item.examByTargetToken(target, tokenValue));
        // if (!eventPipe) {
        //   eventPipe = new EventPipe(eventName, tokenValue, target, eventPipeList);
        // }
        // 2、一个事件允许多个订阅
        var eventPipe = new EventPipe(eventName, tokenValue, target, eventPipeList);
        return eventPipe;
    };
    EventBus.prototype.findExistEventPipe = function (eventName, target, tokenValue) {
        var e_2, _a;
        var eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            return null;
        }
        try {
            // return eventPipeList.find(item => item.examByTargetToken(target, tokenValue));
            for (var eventPipeList_2 = tslib_1.__values(eventPipeList), eventPipeList_2_1 = eventPipeList_2.next(); !eventPipeList_2_1.done; eventPipeList_2_1 = eventPipeList_2.next()) {
                var eventPipe = eventPipeList_2_1.value;
                if (eventPipe.matchEmitterToken(target, tokenValue)) {
                    return eventPipe;
                }
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (eventPipeList_2_1 && !eventPipeList_2_1.done && (_a = eventPipeList_2.return)) _a.call(eventPipeList_2);
            }
            finally { if (e_2) throw e_2.error; }
        }
        return null;
    };
    EventBus.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    EventBus.ctorParameters = function () { return []; };
    return EventBus;
}());
export { EventBus };
var EventCache = /** @class */ (function () {
    function EventCache() {
    }
    EventCache.setToken = function (key, value) {
        EventCache.tokens.set(key, value);
    };
    EventCache.getToken = function (key) {
        return EventCache.tokens.get(key);
    };
    EventCache.tokens = new Map();
    return EventCache;
}());
export { EventCache };
var RequestSubject = /** @class */ (function () {
    function RequestSubject() {
    }
    return RequestSubject;
}());
var DataClass = /** @class */ (function () {
    function DataClass() {
    }
    return DataClass;
}());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQtYnVzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZXZlbnQtYnVzLW5ldy9ldmVudC1idXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2pELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUVsRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBR3pDO0lBS0U7UUFDRSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksR0FBRyxFQUF5QixDQUFDO1FBQ2pELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQTRCLENBQUM7SUFDdEQsQ0FBQztJQUVELDJCQUFRLEdBQVIsVUFBUyxTQUFjLEVBQUUsdUJBQWtDO1FBQ3pELElBQU0sU0FBUyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsUUFBUSxJQUFJLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO1FBQy9FLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUNqQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsSUFBSSxhQUFhLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSx1QkFBdUIsQ0FBQyxDQUFDLENBQUM7U0FDM0Y7UUFDRCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFRDs7T0FFRztJQUNILDRDQUE0QztJQUM1Qyx1QkFBSSxHQUFKLFVBQUssV0FBeUIsRUFBRSxVQUFrQixFQUFFLFNBQWlCLEVBQUUsU0FBYyxFQUFFLE1BQVksRUFBRSxTQUFlLEVBQUUsT0FBZ0I7O1FBQ3BJLElBQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMs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LEdBQXRCLFVBQXVCLEdBQVcsRUFBRSxLQUFVO1FBQzVDLFVBQVUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRWEsbUJBQVEsR0FBdEIsVUFBdUIsR0FBVztRQUNoQyxPQUFPLFVBQVUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFSYyxpQkFBTSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7SUFTcEMsaUJBQUM7Q0FBQSxBQVZELElBVUM7U0FWWSxVQUFVO0FBWXZCO0lBQUE7SUFBdUIsQ0FBQztJQUFELHFCQUFDO0FBQUQsQ0FBQyxBQUF4QixJQUF3QjtBQUN4QjtJQUFBO0lBQWtCLENBQUM7SUFBRCxnQkFBQztBQUFELENBQUMsQUFBbkIsSUFBbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBUeXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEV2ZW50QnVzUHJveHkgfSBmcm9tICcuL2V2ZW50LWJ1cy1wcm94eSc7XHJcbmltcG9ydCB7IElFbWl0YWJsZSB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBFdmVudFBpcGUgfSBmcm9tICcuL2V2ZW50LXBpcGUnO1xyXG5pbXBvcnQgeyBJRGlzcG9zYWJsZSB9IGZyb20gJy4uL2NvcmUvaW5kZXgnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRXZlbnRCdXMgaW1wbGVtZW50cyBJRW1pdGFibGUge1xyXG4gIHByaXZhdGUgcHJveHlNYXA6IE1hcDxzdHJpbmcsIEV2ZW50QnVzUHJveHk+O1xyXG4gIHByaXZhdGUgZXZlbnRNYXA6IE1hcDxzdHJpbmcsIEFycmF5PEV2ZW50UGlwZT4+O1xyXG5cclxuICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIHRoaXMucHJveHlNYXAgPSBuZXcgTWFwPHN0cmluZywgRXZlbnRCdXNQcm94eT4oKTtcclxuICAgIHRoaXMuZXZlbnRNYXAgPSBuZXcgTWFwPHN0cmluZywgQXJyYXk8RXZlbnRQaXBlPj4oKTtcclxuICB9XHJcblxyXG4gIGdldFByb3h5KG93bmVyVHlwZTogYW55LCBldmVudFRva2VuVmFsdWVQcm92aWRlcjogKCkgPT4gYW55KTogRXZlbnRCdXNQcm94eSB7XHJcbiAgICBjb25zdCBvd25lck5hbWUgPSBvd25lclR5cGUuY29uc3RydWN0b3IudHlwZU5hbWUgfHwgb3duZXJUeXBlLmNvbnN0cnVjdG9yLm5hbWU7XHJcbiAgICBpZiAoIXRoaXMucHJveHlNYXAuaGFzKG93bmVyTmFtZSkpIHtcclxuICAgICAgdGhpcy5wcm94eU1hcC5zZXQob3duZXJOYW1lLCBuZXcgRXZlbnRCdXNQcm94eSh0aGlzLCBvd25lclR5cGUsIGV2ZW50VG9rZW5WYWx1ZVByb3ZpZGVyKSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5wcm94eU1hcC5nZXQob3duZXJOYW1lKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWPkemAgeS6i+S7tu+8jOmAmuefpeiuoumYheiAheaOpeaUtua2iOaBr+OAglxyXG4gICAqL1xyXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbWF4LWxpbmUtbGVuZ3RoXHJcbiAgcG9zdChlbWl0dGVyVHlwZTogYW55IHwgc3RyaW5nLCB0b2tlblZhbHVlOiBzdHJpbmcsIGV2ZW50TmFtZTogc3RyaW5nLCBldmVudEFyZ3M6IGFueSwgc2VuZGVyPzogYW55LCBldmVudFR5cGU/OiBhbnksIGV2ZW50SWQ/OiBudW1iZXIpOiB2b2lkIHtcclxuICAgIGNvbnN0IGV2ZW50UGlwZUxpc3QgPSB0aGlzLmV2ZW50TWFwLmdldChldmVudE5hbWUpO1xyXG4gICAgaWYgKCFldmVudFBpcGVMaXN0KSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIWVtaXR0ZXJUeXBlKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ3Bvc3Tmlrnms5XnmoTlj4LmlbBlbWl0dGVyVHlwZeS4jeiDveS4uuepuuOAgicpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBsZXQgZW1pdHRlcjogc3RyaW5nO1xyXG4gICAgaWYgKGVtaXR0ZXJUeXBlIGluc3RhbmNlb2YgVHlwZSkge1xyXG4gICAgICBlbWl0dGVyID0gZW1pdHRlclR5cGUudHlwZU5hbWUgfHwgZW1pdHRlclR5cGUubmFtZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGVtaXR0ZXIgPSBlbWl0dGVyVHlwZTtcclxuICAgIH1cclxuICAgIGlmICh0eXBlb2YgZXZlbnRJZCA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgZXZlbnRJZCA9IG5ldyBEYXRlKCkudmFsdWVPZigpO1xyXG4gICAgfVxyXG4gICAgZm9yIChjb25zdCBldmVudFBpcGUgb2YgZXZlbnRQaXBlTGlzdCkge1xyXG4gICAgICBpZiAoZXZlbnRQaXBlLm1hdGNoRW1pdHRlclRva2VuKGVtaXR0ZXIsIHRva2VuVmFsdWUpKSB7XHJcbiAgICAgICAgZXZlbnRQaXBlLnBvc3QoZXZlbnRBcmdzLCBzZW5kZXIsIGV2ZW50VHlwZSwgZXZlbnRJZCk7XHJcbiAgICAgICAgZXZlbnRQaXBlLnVuU3Vic2NyaWJlRm9yT25jZSgpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDorqLpmIXkuovku7ZcclxuICAgKi9cclxuICBvbih0YXJnZXQ6IHN0cmluZywgdG9rZW5WYWx1ZTogc3RyaW5nLCBldmVudE5hbWU6IHN0cmluZywgY2FsbGVyOiBPYmplY3QsIGhhbmRsZXI6ICh2YWx1ZTogYW55KSA9PiB2b2lkKTogSURpc3Bvc2FibGUge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0RXZlbnRQaXBlKGV2ZW50TmFtZSwgdGFyZ2V0LCB0b2tlblZhbHVlKS5zdWJzY3JpYmUoaGFuZGxlciwgY2FsbGVyKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOazqOmUgOebkeWQrFxyXG4gICAqIEBwYXJhbSB0YXJnZXQgXHJcbiAgICogQHBhcmFtIHRva2VuVmFsdWUgXHJcbiAgICogQHBhcmFtIGV2ZW50TmFtZSBcclxuICAgKiBAcGFyYW0gY2FsbGVyIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBvZmYodGFyZ2V0OiBzdHJpbmcsIHRva2VuVmFsdWU6IHN0cmluZywgZXZlbnROYW1lOiBzdHJpbmcsIGNhbGxlcjogT2JqZWN0KSB7XHJcbiAgICBjb25zdCBldmVudFBpcGVMaXN0ID0gdGhpcy5ldmVudE1hcC5nZXQoZXZlbnROYW1lKTtcclxuICAgIGlmIChldmVudFBpcGVMaXN0KSB7XHJcbiAgICAgIGNvbnN0IGluZGV4ID0gZXZlbnRQaXBlTGlzdC5maW5kSW5kZXgoKGV2ZW50UGlwZTogRXZlbnRQaXBlKSA9PiB7XHJcbiAgICAgICAgaWYgKGV2ZW50UGlwZS5zdWJzY3JpcHRpb25zLmdldChjYWxsZXIpKSB7XHJcbiAgICAgICAgICByZXR1cm4gZXZlbnRQaXBlLm5hbWUgPT09IGV2ZW50TmFtZSAmJiBldmVudFBpcGUudG9rZW5WYWx1ZSA9PT0gdG9rZW5WYWx1ZSAmJiBldmVudFBpcGUuZW1pdHRlciA9PT0gdGFyZ2V0O1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH0pO1xyXG4gICAgICBpZiAoaW5kZXggIT09IC0xKSB7XHJcbiAgICAgICAgZXZlbnRQaXBlTGlzdC5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiuoumYheS4gOasoeOAguaOpeaUtuWIsOS4gOasoea2iOaBr+S5i+WQjuiHquWKqOWPlua2iOiuoumYhVxyXG4gICAqL1xyXG4gIG9uY2UodGFyZ2V0OiBzdHJpbmcsIHRva2VuVmFsdWU6IHN0cmluZywgZXZlbnROYW1lOiBzdHJpbmcsIGNhbGxlcjogT2JqZWN0LCBoYW5kbGVyOiAodmFsdWU6IGFueSkgPT4gdm9pZCk6IElEaXNwb3NhYmxlIHtcclxuICAgIHJldHVybiB0aGlzLmdldEV2ZW50UGlwZShldmVudE5hbWUsIHRhcmdldCwgdG9rZW5WYWx1ZSkuc3Vic2NyaWJlT25jZShoYW5kbGVyLCBjYWxsZXIpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Y+R6YCB5LiA5Liq6K+35rGC5LqL5Lu277yM6I635Y+W55uR5ZCs6ICF55qE5ZON5bqU5bm25aSE55CGXHJcbiAgICovXHJcbiAgcmVxdWVzdEZvcih0YXJnZXQ6IHN0cmluZywgdG9rZW5WYWx1ZTogc3RyaW5nLCByZXF1ZXN0TmFtZTogc3RyaW5nLCByZXF1ZXN0VmFsdWU6IGFueSwgc3VjY2VzczogKGFueSkgPT4gYW55LCBmYWlsPzogKHN0cmluZykgPT4gYW55KSB7XHJcbiAgICBjb25zdCBldmVudFBpcGUgPSB0aGlzLmZpbmRFeGlzdEV2ZW50UGlwZShyZXF1ZXN0TmFtZSwgJ1JlcXVlc3RTdWJqZWN0JywgdG9rZW5WYWx1ZSk7XHJcbiAgICBpZiAoZXZlbnRQaXBlKSB7XHJcbiAgICAgIHRoaXMub25jZSh0YXJnZXQsIHRva2VuVmFsdWUsIHJlcXVlc3ROYW1lLCB0aGlzLCAocmVzcG9uc2UpID0+IHtcclxuICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAnc3VjY2VzcycpIHtcclxuICAgICAgICAgIHN1Y2Nlc3MocmVzcG9uc2UuZGF0YSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGlmIChmYWlsKSB7XHJcbiAgICAgICAgICAgIGZhaWwoJ05vIHRhcmdldCByZXNwb25zZXIgbGlzdGVuaW5nJyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgZXZlbnRQaXBlLnBvc3QoeyB0YXJnZXQ6IHRhcmdldCwgdG9rZW46IHRva2VuVmFsdWUsIGRhdGE6IHJlcXVlc3RWYWx1ZSB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmIChmYWlsKSB7XHJcbiAgICAgICAgZmFpbCgnTm8gdGFyZ2V0IHJlc3BvbnNlciBsaXN0ZW5pbmcuJyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOebkeWQrOS4gOS4quivt+axguS6i+S7tu+8jOe7meWHuuWTjeW6lFxyXG4gICAqL1xyXG4gIHJlc3BvbnNlT24ocmVzcG9uc2VTdWJqZWN0OiBzdHJpbmcsIHJlcXVlc3ROYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiAoYW55KSA9PiBhbnkpIHtcclxuICAgIHRoaXMub24oJ1JlcXVlc3RTdWJqZWN0JywgbnVsbCwgcmVxdWVzdE5hbWUsIHRoaXMsIChyZXF1ZXN0T2JqKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0geyBzdGF0dXM6ICdmYWlsJywgZGF0YTogbnVsbCB9O1xyXG4gICAgICBpZiAocmVzcG9uc2VTdWJqZWN0ID09PSByZXF1ZXN0T2JqLnRhcmdldCkge1xyXG4gICAgICAgIHJlc3BvbnNlLmRhdGEgPSBjYWxsYmFjayhyZXF1ZXN0T2JqLmRhdGEpO1xyXG4gICAgICAgIHJlc3BvbnNlLnN0YXR1cyA9ICdzdWNjZXNzJztcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnBvc3QocmVxdWVzdE9iai50YXJnZXQsIHJlcXVlc3RPYmoudG9rZW4sIHJlcXVlc3ROYW1lLCByZXNwb25zZSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0RXZlbnRQaXBlKGV2ZW50TmFtZTogc3RyaW5nLCB0YXJnZXQ6IHN0cmluZywgdG9rZW5WYWx1ZTogc3RyaW5nKSB7XHJcbiAgICBsZXQgZXZlbnRQaXBlTGlzdCA9IHRoaXMuZXZlbnRNYXAuZ2V0KGV2ZW50TmFtZSk7XHJcbiAgICBpZiAoIWV2ZW50UGlwZUxpc3QpIHtcclxuICAgICAgZXZlbnRQaXBlTGlzdCA9IG5ldyBBcnJheTxFdmVudFBpcGU+KCk7XHJcbiAgICAgIHRoaXMuZXZlbnRNYXAuc2V0KGV2ZW50TmFtZSwgZXZlbnRQaXBlTGlzdCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gMeOAgeS4gOS4quS6i+S7tuS4jeWFgeiuuOWkmuS4quiuoumYhVxyXG4gICAgLy8gbGV0IGV2ZW50UGlwZSA9IGV2ZW50UGlwZUxpc3QuZmluZChpdGVtID0+IGl0ZW0uZXhhbUJ5VGFyZ2V0VG9rZW4odGFyZ2V0LCB0b2tlblZhbHVlKSk7XHJcbiAgICAvLyBpZiAoIWV2ZW50UGlwZSkge1xyXG4gICAgLy8gICBldmVudFBpcGUgPSBuZXcgRXZlbnRQaXBlKGV2ZW50TmFtZSwgdG9rZW5WYWx1ZSwgdGFyZ2V0LCBldmVudFBpcGVMaXN0KTtcclxuICAgIC8vIH1cclxuXHJcbiAgICAvLyAy44CB5LiA5Liq5LqL5Lu25YWB6K645aSa5Liq6K6i6ZiFXHJcbiAgICBjb25zdCBldmVudFBpcGUgPSBuZXcgRXZlbnRQaXBlKGV2ZW50TmFtZSwgdG9rZW5WYWx1ZSwgdGFyZ2V0LCBldmVudFBpcGVMaXN0KTtcclxuXHJcbiAgICByZXR1cm4gZXZlbnRQaXBlO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBmaW5kRXhpc3RFdmVudFBpcGUoZXZlbnROYW1lOiBzdHJpbmcsIHRhcmdldDogc3RyaW5nLCB0b2tlblZhbHVlOiBzdHJpbmcpOiBFdmVudFBpcGUge1xyXG4gICAgY29uc3QgZXZlbnRQaXBlTGlzdCA9IHRoaXMuZXZlbnRNYXAuZ2V0KGV2ZW50TmFtZSk7XHJcbiAgICBpZiAoIWV2ZW50UGlwZUxpc3QpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICAvLyByZXR1cm4gZXZlbnRQaXBlTGlzdC5maW5kKGl0ZW0gPT4gaXRlbS5leGFtQnlUYXJnZXRUb2tlbih0YXJnZXQsIHRva2VuVmFsdWUpKTtcclxuICAgIGZvciAoY29uc3QgZXZlbnRQaXBlIG9mIGV2ZW50UGlwZUxpc3QpIHtcclxuICAgICAgaWYgKGV2ZW50UGlwZS5tYXRjaEVtaXR0ZXJUb2tlbih0YXJnZXQsIHRva2VuVmFsdWUpKSB7XHJcbiAgICAgICAgcmV0dXJuIGV2ZW50UGlwZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgRXZlbnRDYWNoZSB7XHJcbiAgcHJpdmF0ZSBzdGF0aWMgdG9rZW5zID0gbmV3IE1hcCgpO1xyXG5cclxuICBwdWJsaWMgc3RhdGljIHNldFRva2VuKGtleTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XHJcbiAgICBFdmVudENhY2hlLnRva2Vucy5zZXQoa2V5LCB2YWx1ZSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc3RhdGljIGdldFRva2VuKGtleTogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gRXZlbnRDYWNoZS50b2tlbnMuZ2V0KGtleSk7XHJcbiAgfVxyXG59XHJcblxyXG5jbGFzcyBSZXF1ZXN0U3ViamVjdCB7IH1cclxuY2xhc3MgRGF0YUNsYXNzIHsgfVxyXG4iXX0=