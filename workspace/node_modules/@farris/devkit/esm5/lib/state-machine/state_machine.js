import { BehaviorSubject } from 'rxjs';
import { MetadataUtil } from '../metadata/index';
import { StateMachineContext } from './context';
import { State, initialUIState } from './types';
import { StateMachineEvent } from './state_machine_event';
/**
 * 预置界面效果处理
 */
export var effectHandlers = {
    /**
     * 预置状态迁移处理
     */
    transit: {
        /**
         * 执行状态迁移
         * @param stateMachine  状态机对象
         * @param stateName     下一状态的名称
         * @param preconditions 迁移条件
         */
        // tslint:disable-next-line: only-arrow-functions
        perform: function (statemachine, stateName, preconditons) {
            if (preconditons === void 0) { preconditons = []; }
            var nextState = statemachine.states[stateName];
            statemachine.context.transitTo(nextState.name);
            statemachine.render();
        }
    }
};
/**
 * 状态机
 *
 * ### 基本概念
 * 状态机中有三个重要的概念：
 * - 页面状态（State）：页面的整体状态，比如查看状态、编辑状态；
 * - 控件状态（RenderState）：控制具体控件的状态；
 * - 迁移动作（Action）：当动作发生时，将页面切换到指定的页面状态。
 *
 * ### 定义状态机
 *
 * **基本步骤**
 *
 * - 继承StateMachine基类，并添加NgStatemachine注解；
 * - 定义页面状态、控件状态、迁移动作。
 *
 * **状态机中的注解**
 *
 * - NgStatemachine：将类标记为状态机，并进行扩展；
 * - NgState：将属性标记为页面状态，通过initialState可以标记此状态是否为初始状态；
 * - NgRenderState：将属性标记为控件状态，通过render方法指定控件状态的切换规则，
 *   一般情况下是通过对页面状态进行逻辑运算来确定。
 * - NgAction：将属性标记为迁移动作，通过transitTo指定动作执行时要迁移到哪个页面状态。
 *
 * ```ts
 * @Injectable()
 * @NgStatemachine()
 * class SimpleStateMachine extends StateMachine {
 *
 *   // 查看状态，设置为初始状态
 *   @NgState({ initialState: true })
 *   viewState: State;
 *
 *   // 编辑状态
 *   @NgState()
 *   editState: State;
 *
 *   // 编辑按钮是否允许点击
 *   @NgRenderState({
 *     render: (context) => context.state === 'viewState'
 *   })
 *   canEdit: RenderState;
 *
 *   // 保存按钮是否允许点击
 *   @NgRenderState({
 *     render: (context) => context.state === 'editState'
 *   })
 *   canSave: RenderState;
 *
 *   // 输入控件是否允许输入
 *   @NgRenderState({
 *     render: (context) => context.state === 'editState'
 *   })
 *   canInput: RenderState;
 *
 *   // 迁移到编辑状态
 *   @NgAction({ transitTo: 'editState' })
 *   edit: Action;
 *
 *   // 迁移到查看状态
 *   @NgAction({ transitTo: 'viewState' })
 *   view: Action;
 * }
 * ```
 * 在上边的代码中做了如下定义：
 * - 两个页面状态：查看状态、编辑状态，
 * - 三个控件状态：分别用来控制编辑按钮、保存按钮、输入控件的状态，
 * - 两个迁移动作：view动作用来将页面切换到查看状态，edit动作用来将页面切换到编辑状态。
 *
 *
 * ### 在模板中使用状态机
 *
 * 模板中我们主要使用的是控件状态，多个控件可以共享一个控件状态。
 *
 * ```html
 * <button type="button" [disabled]="!viewModel.stateMachine.canEdit">编辑</button>
 * <button type="button" [disabled]="!viewModel.stateMachine.canSave">保存</button>
 * <input id="code" [disabled]="!viewModel.stateMachine.canInput" />
 * <input id="name" [disabled]="!viewModel.stateMachine.canInput" />
 * ```
 *
 * ### 执行状态迁移
 * 通过执行状态机上的动作来将页面切换到页面状态，进而改变控件状态。
 * 假设我们有这么一个场景，当用户点击保存按钮的时候，我们先执行保存，保存完成后将状态迁移到查看状态。
 * 我们可以定义一个CommandHandler，添加两个对应的任务，具体代码如下：
 * ```ts
 * @Injectable()
 * @NgCommandHandler({
 *   commandName: 'save'
 * })
 * class SaveHandler extends CommandHandler {
 *
 *   schedule() {
 *     this.addTask('save', () => {
 *       // 实现保存
 *     });
 *
 *     // 状态迁移
 *     this.addTask('transitState', ) => {
 *       this.stateMachine['view']();
 *     });
 *   }
 * }
 * ```
 */
var StateMachine = /** @class */ (function () {
    /**
     * 构造函数
     */
    function StateMachine() {
        var _this = this;
        this.isStateInited = false;
        this.isDisposed = false;
        var propsMetadatas = MetadataUtil.getPropsMetadatas(this.constructor);
        // 遍历所有属性装饰器，并调用相应的build方法
        if (propsMetadatas) {
            Object.keys(propsMetadatas).forEach(function (propName) {
                var propMetadatas = propsMetadatas[propName];
                propMetadatas.forEach(function (propMetadata) {
                    _this['build' + propMetadata.ngMetadataName](propName, propMetadata);
                });
            });
        }
        // if (!this.initialState) {
        //   throw new Error('请在NgState注解中指定状态机的初始状态。');
        // }
        this.stateChange = new BehaviorSubject(false);
        this.context = new StateMachineContext(this);
        this.stateMachineEvent = new StateMachineEvent(this);
    }
    StateMachine.prototype.dispose = function (options) {
        this.isDisposed = true;
        this.frameContext = null;
        this.appContext = null;
        this.context = null;
        this.stateMachineEvent = null;
        this.metadatas = null;
    };
    StateMachine.prototype.ngOnDestroy = function () {
        this.dispose();
    };
    // 状态机变更，为了在绑定数据之后执行状态机的操作，把render方法延后执行。
    StateMachine.prototype.initialize = function (frameContext, variableParseService) {
        this.appContext = frameContext.appContext;
        this.frameContext = frameContext;
        var stateMachineMetadata = this.appContext.metadata.stateMachine || this.collectionMetadata();
        this.metadatas = stateMachineMetadata;
        this.buildStateMachine(stateMachineMetadata);
        // if (!this.initialState) {
        //   throw new Error('请在NgState注解中指定状态机的初始状态。');
        // }
        this.context.initialize(variableParseService, this.initialState);
        this.stateMachineEvent.initialize(this.frameContext);
        this.render();
    };
    StateMachine.prototype.collectionMetadata = function () {
        var stateMachineMetadata = {
            states: {},
            renderStates: {},
            actions: {}
        };
        var propsMetadatas = MetadataUtil.getPropsMetadatas(this.constructor);
        if (propsMetadatas) {
            Object.keys(propsMetadatas).forEach(function (propName) {
                var propMetadatas = propsMetadatas[propName];
                propMetadatas.forEach(function (propMetadata) {
                    switch (propMetadata.ngMetadataName) {
                        case 'NgState':
                            stateMachineMetadata.states[propName] = propMetadata;
                            break;
                        case 'NgRenderState':
                            stateMachineMetadata.renderStates[propName] = propMetadata;
                            break;
                        case 'NgAction':
                            stateMachineMetadata.actions[propName] = propMetadata;
                            break;
                    }
                });
            });
        }
        return stateMachineMetadata;
    };
    StateMachine.prototype.buildStateMachine = function (metadata) {
        var _this = this;
        Object.keys(metadata.states).forEach(function (stateName) {
            _this.buildNgState(stateName, metadata.states[stateName]);
        });
        Object.keys(metadata.renderStates).forEach(function (renderStateName) {
            _this.buildNgRenderState(renderStateName, metadata.renderStates[renderStateName]);
        });
        Object.keys(metadata.actions).forEach(function (actionName) {
            _this.buildNgAction(actionName, metadata.actions[actionName]);
        });
    };
    /**
     * 构造状态
     * @param stateName 状态名称
     * @param ngState   状态对象
     */
    StateMachine.prototype.buildNgState = function (stateName, ngState) {
        this.states = this.states || {};
        this[stateName] = new State(stateName);
        this.states[stateName] = this[stateName];
        if (ngState.initialState) {
            this.initialState = this[stateName];
        }
    };
    /**
     * 构造界面状态
     * @param renderStateName 渲染状态名称
     * @param ngRenderState   渲染状态元数据
     */
    StateMachine.prototype.buildNgRenderState = function (renderStateName, ngRenderState) {
        this.renderStates = this.renderStates || {};
        this[renderStateName] = initialUIState;
        this.renderStates[renderStateName] = this[renderStateName];
        // 将renderState上指定的render加入到renders中
        this.renders = this.renders || {};
        this.renders[renderStateName] = ngRenderState.render;
    };
    /**
     * 构造动作
     * @param actionName 动作名称
     * @param ngAction   动作元数据
     */
    StateMachine.prototype.buildNgAction = function (actionName, ngAction) {
        var _this = this;
        this[actionName] = function () {
            effectHandlers.transit.perform(_this, ngAction.transitTo, ngAction.precondition);
        };
    };
    /**
     * 重新计算所有渲染状态的值
     * 当 state切换的时候，调用遍历所有的render方法，更改renderState
     */
    StateMachine.prototype.render = function () {
        if (this.isDisposed) {
            return;
        }
        for (var renderStateName in this.renderStates) {
            if (this.renderStates.hasOwnProperty(renderStateName) === false) {
                continue;
            }
            var stateRender = this.renders[renderStateName];
            if (!stateRender) {
                continue;
            }
            // 调用render方法，更新renderState
            this.renderStates[renderStateName] = stateRender(this.context);
            this[renderStateName] = this.renderStates[renderStateName];
        }
        this.stateChange.next(this.context.state);
    };
    return StateMachine;
}());
export { StateMachine };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVfbWFjaGluZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3N0YXRlLW1hY2hpbmUvc3RhdGVfbWFjaGluZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFaEQsT0FBTyxFQUNMLEtBQUssRUFBRSxjQUFjLEVBRXRCLE1BQU0sU0FBUyxDQUFDO0FBRWpCLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBMEIxRDs7R0FFRztBQUNILE1BQU0sQ0FBQyxJQUFNLGNBQWMsR0FBRztJQUU1Qjs7T0FFRztJQUNILE9BQU8sRUFBRTtRQUVQOzs7OztXQUtHO1FBQ0gsaURBQWlEO1FBQ2pELE9BQU8sRUFBRSxVQUFVLFlBQTBCLEVBQUUsU0FBaUIsRUFBRSxZQUF3QjtZQUF4Qiw2QkFBQSxFQUFBLGlCQUF3QjtZQUN4RixJQUFNLFNBQVMsR0FBVSxZQUFZLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3hELFlBQVksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMvQyxZQUFZLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDeEIsQ0FBQztLQUNGO0NBQ0YsQ0FBQztBQUVGOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXdHRztBQUNIO0lBNkNFOztPQUVHO0lBQ0g7UUFBQSxpQkFvQkM7UUFuRU8sa0JBQWEsR0FBRyxLQUFLLENBQUM7UUEyQ3RCLGVBQVUs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O0lBQ0osQ0FBQztJQUVEOzs7T0FHRztJQUNILDZCQUFNLEdBQU47UUFDRSxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDbkIsT0FBTztTQUNSO1FBQ0QsS0FBSyxJQUFNLGVBQWUsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQy9DLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxjQUFjLENBQUMsZUFBZSxDQUFDLEtBQUssS0FBSyxFQUFFO2dCQUMvRCxTQUFTO2FBQ1Y7WUFDRCxJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ2xELElBQUksQ0FBQyxXQUFXLEVBQUU7Z0JBQ2hCLFNBQVM7YUFDVjtZQUNELDJCQUEyQjtZQUMzQixJQUFJLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDL0QsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsZUFBZSxDQUFDLENBQUM7U0FDNUQ7UUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFDSCxtQkFBQztBQUFELENBQUMsQUFoTkQsSUFnTkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgTWV0YWRhdGFVdGlsIH0gZnJvbSAnLi4vbWV0YWRhdGEvaW5kZXgnO1xyXG5pbXBvcnQgeyBTdGF0ZU1hY2hpbmVDb250ZXh0IH0gZnJvbSAnLi9jb250ZXh0JztcclxuaW1wb3J0IHsgTmdTdGF0ZSwgTmdBY3Rpb24sIE5nUmVuZGVyU3RhdGUgfSBmcm9tICcuL2RlY29yYXRvcnMnO1xyXG5pbXBvcnQge1xyXG4gIFN0YXRlLCBpbml0aWFsVUlTdGF0ZSwgRWZmZWN0LCBSZW5kZXIsXHJcbiAgU3RhdGVEaWN0aW9uYXJ5LCBSZW5kZXJTdGF0ZURpY3Rpb25hcnksIFJlbmRlckRpY3Rpb25hcnlcclxufSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0IH0gZnJvbSAnLi4vZnJhbWUvaW5kZXgnO1xyXG5pbXBvcnQgeyBTdGF0ZU1hY2hpbmVFdmVudCB9IGZyb20gJy4vc3RhdGVfbWFjaGluZV9ldmVudCc7XHJcbmltcG9ydCB7IFZhcmlhYmxlUGFyc2VTZXJ2aWNlIH0gZnJvbSAnLi4vdmFyaWFibGUvdmFyaWFibGVfcGFyc2Vfc2VydmljZSc7XHJcbmltcG9ydCB7IE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBJRGlzcG9zYWJsZSB9IGZyb20gJy4uL2NvcmUnO1xyXG5cclxuLyoqXHJcbiAqIOeKtuaAgeacuuWIneWni+WMlumFjee9ruWvueixoVxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBTdGF0ZU1hY2hpbmVPcHRpb24ge1xyXG5cclxuICAvKipcclxuICAgKiDnlYzpnaLmuLLmn5Pmj4/ov7BcclxuICAgKi9cclxuICByZW5kZXJzPzogeyBbaW5kZXg6IHN0cmluZ106IFJlbmRlciB9O1xyXG5cclxuICAvKipcclxuICAgKiDnirbmgIHpm4blkIhcclxuICAgKi9cclxuICBzdGF0ZXM/OiBzdHJpbmdbXTtcclxuXHJcbiAgLyoqXHJcbiAgICog54q25oCB5py655WM6Z2i5o6n5Yi25pWI5p6cXHJcbiAgICovXHJcbiAgZWZmZWN0cz86IHsgW2luZGV4OiBzdHJpbmddOiBFZmZlY3QgfTtcclxufVxyXG5cclxuLyoqXHJcbiAqIOmihOe9rueVjOmdouaViOaenOWkhOeQhlxyXG4gKi9cclxuZXhwb3J0IGNvbnN0IGVmZmVjdEhhbmRsZXJzID0ge1xyXG5cclxuICAvKipcclxuICAgKiDpooTnva7nirbmgIHov4Hnp7vlpITnkIZcclxuICAgKi9cclxuICB0cmFuc2l0OiB7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmiafooYznirbmgIHov4Hnp7tcclxuICAgICAqIEBwYXJhbSBzdGF0ZU1hY2hpbmUgIOeKtuaAgeacuuWvueixoVxyXG4gICAgICogQHBhcmFtIHN0YXRlTmFtZSAgICAg5LiL5LiA54q25oCB55qE5ZCN56ewXHJcbiAgICAgKiBAcGFyYW0gcHJlY29uZGl0aW9ucyDov4Hnp7vmnaHku7ZcclxuICAgICAqL1xyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBvbmx5LWFycm93LWZ1bmN0aW9uc1xyXG4gICAgcGVyZm9ybTogZnVuY3Rpb24gKHN0YXRlbWFjaGluZTogU3RhdGVNYWNoaW5lLCBzdGF0ZU5hbWU6IHN0cmluZywgcHJlY29uZGl0b25zOiBhbnlbXSA9IFtdKSB7XHJcbiAgICAgIGNvbnN0IG5leHRTdGF0ZTogU3RhdGUgPSBzdGF0ZW1hY2hpbmUuc3RhdGVzW3N0YXRlTmFtZV07XHJcbiAgICAgIHN0YXRlbWFjaGluZS5jb250ZXh0LnRyYW5zaXRUbyhuZXh0U3RhdGUubmFtZSk7XHJcbiAgICAgIHN0YXRlbWFjaGluZS5yZW5kZXIoKTtcclxuICAgIH1cclxuICB9XHJcbn07XHJcblxyXG4vKipcclxuICog54q25oCB5py6XHJcbiAqXHJcbiAqICMjIyDln7rmnKzmpoLlv7VcclxuICog54q25oCB5py65Lit5pyJ5LiJ5Liq6YeN6KaB55qE5qaC5b+177yaXHJcbiAqIC0g6aG16Z2i54q25oCB77yIU3RhdGXvvInvvJrpobXpnaLnmoTmlbTkvZPnirbmgIHvvIzmr5TlpoLmn6XnnIvnirbmgIHjgIHnvJbovpHnirbmgIHvvJtcclxuICogLSDmjqfku7bnirbmgIHvvIhSZW5kZXJTdGF0Ze+8ie+8muaOp+WItuWFt+S9k+aOp+S7tueahOeKtuaAge+8m1xyXG4gKiAtIOi/geenu+WKqOS9nO+8iEFjdGlvbu+8ie+8muW9k+WKqOS9nOWPkeeUn+aXtu+8jOWwhumhtemdouWIh+aNouWIsOaMh+WumueahOmhtemdoueKtuaAgeOAglxyXG4gKlxyXG4gKiAjIyMg5a6a5LmJ54q25oCB5py6XHJcbiAqXHJcbiAqICoq5Z+65pys5q2l6aqkKipcclxuICpcclxuICogLSDnu6fmib9TdGF0ZU1hY2hpbmXln7rnsbvvvIzlubbmt7vliqBOZ1N0YXRlbWFjaGluZeazqOino++8m1xyXG4gKiAtIOWumuS5iemhtemdoueKtuaAgeOAgeaOp+S7tueKtuaAgeOAgei/geenu+WKqOS9nOOAglxyXG4gKlxyXG4gKiAqKueKtuaAgeacuuS4reeahOazqOinoyoqXHJcbiAqXHJcbiAqIC0gTmdTdGF0ZW1hY2hpbmXvvJrlsIbnsbvmoIforrDkuLrnirbmgIHmnLrvvIzlubbov5vooYzmianlsZXvvJtcclxuICogLSBOZ1N0YXRl77ya5bCG5bGe5oCn5qCH6K6w5Li66aG16Z2i54q25oCB77yM6YCa6L+HaW5pdGlhbFN0YXRl5Y+v5Lul5qCH6K6w5q2k54q25oCB5piv5ZCm5Li65Yid5aeL54q25oCB77ybXHJcbiAqIC0gTmdSZW5kZXJTdGF0Ze+8muWwhuWxnuaAp+agh+iusOS4uuaOp+S7tueKtuaAge+8jOmAmui/h3JlbmRlcuaWueazleaMh+WumuaOp+S7tueKtuaAgeeahOWIh+aNouinhOWIme+8jFxyXG4gKiAgIOS4gOiIrOaDheWGteS4i+aYr+mAmui/h+WvuemhtemdoueKtuaAgei/m+ihjOmAu+i+kei/kOeul+adpeehruWumuOAglxyXG4gKiAtIE5nQWN0aW9u77ya5bCG5bGe5oCn5qCH6K6w5Li66L+B56e75Yqo5L2c77yM6YCa6L+HdHJhbnNpdFRv5oyH5a6a5Yqo5L2c5omn6KGM5pe26KaB6L+B56e75Yiw5ZOq5Liq6aG16Z2i54q25oCB44CCXHJcbiAqXHJcbiAqIGBgYHRzXHJcbiAqIEBJbmplY3RhYmxlKClcclxuICogQE5nU3RhdGVtYWNoaW5lKClcclxuICogY2xhc3MgU2ltcGxlU3RhdGVNYWNoaW5lIGV4dGVuZHMgU3RhdGVNYWNoaW5lIHtcclxuICpcclxuICogICAvLyDmn6XnnIvnirbmgIHvvIzorr7nva7kuLrliJ3lp4vnirbmgIFcclxuICogICBATmdTdGF0ZSh7IGluaXRpYWxTdGF0ZTogdHJ1ZSB9KVxyXG4gKiAgIHZpZXdTdGF0ZTogU3RhdGU7XHJcbiAqXHJcbiAqICAgLy8g57yW6L6R54q25oCBXHJcbiAqICAgQE5nU3RhdGUoKVxyXG4gKiAgIGVkaXRTdGF0ZTogU3RhdGU7XHJcbiAqXHJcbiAqICAgLy8g57yW6L6R5oyJ6ZKu5piv5ZCm5YWB6K6454K55Ye7XHJcbiAqICAgQE5nUmVuZGVyU3RhdGUoe1xyXG4gKiAgICAgcmVuZGVyOiAoY29udGV4dCkgPT4gY29udGV4dC5zdGF0ZSA9PT0gJ3ZpZXdTdGF0ZSdcclxuICogICB9KVxyXG4gKiAgIGNhbkVkaXQ6IFJlbmRlclN0YXRlO1xyXG4gKlxyXG4gKiAgIC8vIOS/neWtmOaMiemSruaYr+WQpuWFgeiuuOeCueWHu1xyXG4gKiAgIEBOZ1JlbmRlclN0YXRlKHtcclxuICogICAgIHJlbmRlcjogKGNvbnRleHQpID0+IGNvbnRleHQuc3RhdGUgPT09ICdlZGl0U3RhdGUnXHJcbiAqICAgfSlcclxuICogICBjYW5TYXZlOiBSZW5kZXJTdGF0ZTtcclxuICpcclxuICogICAvLyDovpPlhaXmjqfku7bmmK/lkKblhYHorrjovpPlhaVcclxuICogICBATmdSZW5kZXJTdGF0ZSh7XHJcbiAqICAgICByZW5kZXI6IChjb250ZXh0KSA9PiBjb250ZXh0LnN0YXRlID09PSAnZWRpdFN0YXRlJ1xyXG4gKiAgIH0pXHJcbiAqICAgY2FuSW5wdXQ6IFJlbmRlclN0YXRlO1xyXG4gKlxyXG4gKiAgIC8vIOi/geenu+WIsOe8lui+keeKtuaAgVxyXG4gKiAgIEBOZ0FjdGlvbih7IHRyYW5zaXRUbzogJ2VkaXRTdGF0ZScgfSlcclxuICogICBlZGl0OiBBY3Rpb247XHJcbiAqXHJcbiAqICAgLy8g6L+B56e75Yiw5p+l55yL54q25oCBXHJcbiAqICAgQE5nQWN0aW9uKHsgdHJhbnNpdFRvOiAndmlld1N0YXRlJyB9KVxyXG4gKiAgIHZpZXc6IEFjdGlvbjtcclxuICogfVxyXG4gKiBgYGBcclxuICog5Zyo5LiK6L6555qE5Luj56CB5Lit5YGa5LqG5aaC5LiL5a6a5LmJ77yaXHJcbiAqIC0g5Lik5Liq6aG16Z2i54q25oCB77ya5p+l55yL54q25oCB44CB57yW6L6R54q25oCB77yMXHJcbiAqIC0g5LiJ5Liq5o6n5Lu254q25oCB77ya5YiG5Yir55So5p2l5o6n5Yi257yW6L6R5oyJ6ZKu44CB5L+d5a2Y5oyJ6ZKu44CB6L6T5YWl5o6n5Lu255qE54q25oCB77yMXHJcbiAqIC0g5Lik5Liq6L+B56e75Yqo5L2c77yadmlld+WKqOS9nOeUqOadpeWwhumhtemdouWIh+aNouWIsOafpeeci+eKtuaAge+8jGVkaXTliqjkvZznlKjmnaXlsIbpobXpnaLliIfmjaLliLDnvJbovpHnirbmgIHjgIJcclxuICpcclxuICpcclxuICogIyMjIOWcqOaooeadv+S4reS9v+eUqOeKtuaAgeaculxyXG4gKlxyXG4gKiDmqKHmnb/kuK3miJHku6zkuLvopoHkvb/nlKjnmoTmmK/mjqfku7bnirbmgIHvvIzlpJrkuKrmjqfku7blj6/ku6XlhbHkuqvkuIDkuKrmjqfku7bnirbmgIHjgIJcclxuICpcclxuICogYGBgaHRtbFxyXG4gKiA8YnV0dG9uIHR5cGU9XCJidXR0b25cIiBbZGlzYWJsZWRdPVwiIXZpZXdNb2RlbC5zdGF0ZU1hY2hpbmUuY2FuRWRpdFwiPue8lui+kTwvYnV0dG9uPlxyXG4gKiA8YnV0dG9uIHR5cGU9XCJidXR0b25cIiBbZGlzYWJsZWRdPVwiIXZpZXdNb2RlbC5zdGF0ZU1hY2hpbmUuY2FuU2F2ZVwiPuS/neWtmDwvYnV0dG9uPlxyXG4gKiA8aW5wdXQgaWQ9XCJjb2RlXCIgW2Rpc2FibGVkXT1cIiF2aWV3TW9kZWwuc3RhdGVNYWNoaW5lLmNhbklucHV0XCIgLz5cclxuICogPGlucHV0IGlkPVwibmFtZVwiIFtkaXNhYmxlZF09XCIhdmlld01vZGVsLnN0YXRlTWFjaGluZS5jYW5JbnB1dFwiIC8+XHJcbiAqIGBgYFxyXG4gKlxyXG4gKiAjIyMg5omn6KGM54q25oCB6L+B56e7XHJcbiAqIOmAmui/h+aJp+ihjOeKtuaAgeacuuS4iueahOWKqOS9nOadpeWwhumhtemdouWIh+aNouWIsOmhtemdoueKtuaAge+8jOi/m+iAjOaUueWPmOaOp+S7tueKtuaAgeOAglxyXG4gKiDlgYforr7miJHku6zmnInov5nkuYjkuIDkuKrlnLrmma/vvIzlvZPnlKjmiLfngrnlh7vkv53lrZjmjInpkq7nmoTml7blgJnvvIzmiJHku6zlhYjmiafooYzkv53lrZjvvIzkv53lrZjlrozmiJDlkI7lsIbnirbmgIHov4Hnp7vliLDmn6XnnIvnirbmgIHjgIJcclxuICog5oiR5Lus5Y+v5Lul5a6a5LmJ5LiA5LiqQ29tbWFuZEhhbmRsZXLvvIzmt7vliqDkuKTkuKrlr7nlupTnmoTku7vliqHvvIzlhbfkvZPku6PnoIHlpoLkuIvvvJpcclxuICogYGBgdHNcclxuICogQEluamVjdGFibGUoKVxyXG4gKiBATmdDb21tYW5kSGFuZGxlcih7XHJcbiAqICAgY29tbWFuZE5hbWU6ICdzYXZlJ1xyXG4gKiB9KVxyXG4gKiBjbGFzcyBTYXZlSGFuZGxlciBleHRlbmRzIENvbW1hbmRIYW5kbGVyIHtcclxuICpcclxuICogICBzY2hlZHVsZSgpIHtcclxuICogICAgIHRoaXMuYWRkVGFzaygnc2F2ZScsICgpID0+IHtcclxuICogICAgICAgLy8g5a6e546w5L+d5a2YXHJcbiAqICAgICB9KTtcclxuICpcclxuICogICAgIC8vIOeKtuaAgei/geenu1xyXG4gKiAgICAgdGhpcy5hZGRUYXNrKCd0cmFuc2l0U3RhdGUnLCApID0+IHtcclxuICogICAgICAgdGhpcy5zdGF0ZU1hY2hpbmVbJ3ZpZXcnXSgpO1xyXG4gKiAgICAgfSk7XHJcbiAqICAgfVxyXG4gKiB9XHJcbiAqIGBgYFxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIFN0YXRlTWFjaGluZSBpbXBsZW1lbnRzIE9uRGVzdHJveSwgSURpc3Bvc2FibGUge1xyXG4gIHByaXZhdGUgaXNTdGF0ZUluaXRlZCA9IGZhbHNlO1xyXG4gIC8qKlxyXG4gICAqIOWIneWni+eKtuaAgVxyXG4gICAqL1xyXG4gIHB1YmxpYyBpbml0aWFsU3RhdGU6IFN0YXRlO1xyXG5cclxuICAvKipcclxuICAgKiDnirbmgIHlrZflhbhcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGVzOiBTdGF0ZURpY3Rpb25hcnk7XHJcblxyXG4gIC8qKlxyXG4gICAqIOa4suafk+eKtuaAgeWtl+WFuFxyXG4gICAqL1xyXG4gIHB1YmxpYyByZW5kZXJTdGF0ZXM6IFJlbmRlclN0YXRlRGljdGlvbmFyeTtcclxuXHJcbiAgLyoqXHJcbiAgICog5riy5p+T5Zmo5a2X5YW4XHJcbiAgICovXHJcbiAgcHVibGljIHJlbmRlcnM6IFJlbmRlckRpY3Rpb25hcnk7XHJcblxyXG4gIC8qKlxyXG4gICAqIOeKtuaAgeacuuS4iuS4i+aWh1xyXG4gICAqL1xyXG4gIHB1YmxpYyBjb250ZXh0OiBTdGF0ZU1hY2hpbmVDb250ZXh0O1xyXG5cclxuICAvKipcclxuICAgKiDnirbmgIHlj5jmm7RcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGVDaGFuZ2U6IEJlaGF2aW9yU3ViamVjdDxzdHJpbmc+O1xyXG5cclxuICBwdWJsaWMgYXBwQ29udGV4dDogYW55O1xyXG5cclxuICBwdWJsaWMgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQ7XHJcblxyXG4gIC8qKlxyXG4gICAqIOeKtuaAgeacuuS6i+S7tuebkeWQrFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGF0ZU1hY2hpbmVFdmVudDogU3RhdGVNYWNoaW5lRXZlbnQ7XHJcbiAgLyoqXHJcbiAgICog54q25oCB5py65YWD5pWw5o2uXHJcbiAgICovXHJcbiAgcHVibGljIG1ldGFkYXRhczogeyBzdGF0ZXM6IHsgW3N0YXRlTmFtZTogc3RyaW5nXTogTmdTdGF0ZSB9LCByZW5kZXJTdGF0ZXM6IHsgW3JlbmRlclN0YXRlTmFtZTogc3RyaW5nXTogTmdSZW5kZXJTdGF0ZSB9LCBhY3Rpb25zOiB7IFthY3Rpb25OYW1lOiBzdHJpbmddOiBOZ0FjdGlvbiB9IH07XHJcbiAgcHJpdmF0ZSBpc0Rpc3Bvc2VkID0gZmFsc2U7XHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICBjb25zdCBwcm9wc01ldGFkYXRhcyA9IE1ldGFkYXRhVXRpbC5nZXRQcm9wc01ldGFkYXRhcyh0aGlzLmNvbnN0cnVjdG9yKTtcclxuXHJcbiAgICAvLyDpgY3ljobmiYDmnInlsZ7mgKfoo4XppbDlmajvvIzlubbosIPnlKjnm7jlupTnmoRidWlsZOaWueazlVxyXG4gICAgaWYgKHByb3BzTWV0YWRhdGFzKSB7XHJcbiAgICAgIE9iamVjdC5rZXlzKHByb3BzTWV0YWRhdGFzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgY29uc3QgcHJvcE1ldGFkYXRhcyA9IHByb3BzTWV0YWRhdGFzW3Byb3BOYW1lXTtcclxuICAgICAgICBwcm9wTWV0YWRhdGFzLmZvckVhY2gocHJvcE1ldGFkYXRhID0+IHtcclxuICAgICAgICAgIHRoaXNbJ2J1aWxkJyArIHByb3BNZXRhZGF0YS5uZ01ldGFkYXRhTmFtZV0ocHJvcE5hbWUsIHByb3BNZXRhZGF0YSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGlmICghdGhpcy5pbml0aWFsU3RhdGUpIHtcclxuICAgIC8vICAgdGhyb3cgbmV3IEVycm9yKCfor7flnKhOZ1N0YXRl5rOo6Kej5Lit5oyH5a6a54q25oCB5py655qE5Yid5aeL54q25oCB44CCJyk7XHJcbiAgICAvLyB9XHJcblxyXG4gICAgdGhpcy5zdGF0ZUNoYW5nZSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8YW55PihmYWxzZSk7XHJcbiAgICB0aGlzLmNvbnRleHQgPSBuZXcgU3RhdGVNYWNoaW5lQ29udGV4dCh0aGlzKTtcclxuICAgIHRoaXMuc3RhdGVNYWNoaW5lRXZlbnQgPSBuZXcgU3RhdGVNYWNoaW5lRXZlbnQodGhpcyk7XHJcbiAgfVxyXG4gIHB1YmxpYyBkaXNwb3NlKG9wdGlvbnM/OiBhbnkpIHtcclxuICAgIHRoaXMuaXNEaXNwb3NlZCA9IHRydWU7XHJcbiAgICB0aGlzLmZyYW1lQ29udGV4dCA9IG51bGw7XHJcbiAgICB0aGlzLmFwcENvbnRleHQgPSBudWxsO1xyXG4gICAgdGhpcy5jb250ZXh0ID0gbnVsbDtcclxuICAgIHRoaXMuc3RhdGVNYWNoaW5lRXZlbnQgPSBudWxsO1xyXG4gICAgdGhpcy5tZXRhZGF0YXMgPSBudWxsO1xyXG4gIH1cclxuICBwdWJsaWMgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICB0aGlzLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIC8vIOeKtuaAgeacuuWPmOabtO+8jOS4uuS6huWcqOe7keWumuaVsOaNruS5i+WQjuaJp+ihjOeKtuaAgeacuueahOaTjeS9nO+8jOaKinJlbmRlcuaWueazleW7tuWQjuaJp+ihjOOAglxyXG4gIGluaXRpYWxpemUoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIHZhcmlhYmxlUGFyc2VTZXJ2aWNlOiBWYXJpYWJsZVBhcnNlU2VydmljZSkge1xyXG4gICAgdGhpcy5hcHBDb250ZXh0ID0gZnJhbWVDb250ZXh0LmFwcENvbnRleHQ7XHJcbiAgICB0aGlzLmZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dDtcclxuICAgIGNvbnN0IHN0YXRlTWFjaGluZU1ldGFkYXRhID0gdGhpcy5hcHBDb250ZXh0Lm1ldGFkYXRhLnN0YXRlTWFjaGluZSB8fCB0aGlzLmNvbGxlY3Rpb25NZXRhZGF0YSgpO1xyXG4gICAgdGhpcy5tZXRhZGF0YXMgPSBzdGF0ZU1hY2hpbmVNZXRhZGF0YTtcclxuICAgIHRoaXMuYnVpbGRTdGF0ZU1hY2hpbmUoc3RhdGVNYWNoaW5lTWV0YWRhdGEpO1xyXG4gICAgLy8gaWYgKCF0aGlzLmluaXRpYWxTdGF0ZSkge1xyXG4gICAgLy8gICB0aHJvdyBuZXcgRXJyb3IoJ+ivt+WcqE5nU3RhdGXms6jop6PkuK3mjIflrprnirbmgIHmnLrnmoTliJ3lp4vnirbmgIHjgIInKTtcclxuICAgIC8vIH1cclxuICAgIHRoaXMuY29udGV4dC5pbml0aWFsaXplKHZhcmlhYmxlUGFyc2VTZXJ2aWNlLCB0aGlzLmluaXRpYWxTdGF0ZSk7XHJcbiAgICB0aGlzLnN0YXRlTWFjaGluZUV2ZW50LmluaXRpYWxpemUodGhpcy5mcmFtZUNvbnRleHQpO1xyXG4gICAgdGhpcy5yZW5kZXIoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY29sbGVjdGlvbk1ldGFkYXRhKCk6IHtcclxuICAgIHN0YXRlczogeyBbc3RhdGVOYW1lOiBzdHJpbmddOiBOZ1N0YXRlIH0sXHJcbiAgICByZW5kZXJTdGF0ZXM6IHsgW3JlbmRlclN0YXRlTmFtZTogc3RyaW5nXTogTmdSZW5kZXJTdGF0ZSB9LFxyXG4gICAgYWN0aW9uczogeyBbYWN0aW9uTmFtZTogc3RyaW5nXTogTmdBY3Rpb24gfVxyXG4gIH0ge1xyXG4gICAgY29uc3Qgc3RhdGVNYWNoaW5lTWV0YWRhdGEgPSB7XHJcbiAgICAgIHN0YXRlczoge30sXHJcbiAgICAgIHJlbmRlclN0YXRlczoge30sXHJcbiAgICAgIGFjdGlvbnM6IHt9XHJcbiAgICB9O1xyXG4gICAgY29uc3QgcHJvcHNNZXRhZGF0YXMgPSBNZXRhZGF0YVV0aWwuZ2V0UHJvcHNNZXRhZGF0YXModGhpcy5jb25zdHJ1Y3Rvcik7XHJcbiAgICBpZiAocHJvcHNNZXRhZGF0YXMpIHtcclxuICAgICAgT2JqZWN0LmtleXMocHJvcHNNZXRhZGF0YXMpLmZvckVhY2goKHByb3BOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgICBjb25zdCBwcm9wTWV0YWRhdGFzID0gcHJvcHNNZXRhZGF0YXNbcHJvcE5hbWVdO1xyXG4gICAgICAgIHByb3BNZXRhZGF0YXMuZm9yRWFjaChwcm9wTWV0YWRhdGEgPT4ge1xyXG4gICAgICAgICAgc3dpdGNoIChwcm9wTWV0YWRhdGEubmdNZXRhZGF0YU5hbWUpIHtcclxuICAgICAgICAgICAgY2FzZSAnTmdTdGF0ZSc6XHJcbiAgICAgICAgICAgICAgc3RhdGVNYWNoaW5lTWV0YWRhdGEuc3RhdGVzW3Byb3BOYW1lXSA9IHByb3BNZXRhZGF0YTtcclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnTmdSZW5kZXJTdGF0ZSc6XHJcbiAgICAgICAgICAgICAgc3RhdGVNYWNoaW5lTWV0YWRhdGEucmVuZGVyU3RhdGVzW3Byb3BOYW1lXSA9IHByb3BNZXRhZGF0YTtcclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnTmdBY3Rpb24nOlxyXG4gICAgICAgICAgICAgIHN0YXRlTWFjaGluZU1ldGFkYXRhLmFjdGlvbnNbcHJvcE5hbWVdID0gcHJvcE1ldGFkYXRhO1xyXG4gICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiBzdGF0ZU1hY2hpbmVNZXRhZGF0YTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYnVpbGRTdGF0ZU1hY2hpbmUobWV0YWRhdGE6IHtcclxuICAgIHN0YXRlczogeyBbc3RhdGVOYW1lOiBzdHJpbmddOiBOZ1N0YXRlIH0sXHJcbiAgICByZW5kZXJTdGF0ZXM6IHsgW3JlbmRlclN0YXRlTmFtZTogc3RyaW5nXTogTmdSZW5kZXJTdGF0ZSB9LFxyXG4gICAgYWN0aW9uczogeyBbYWN0aW9uTmFtZTogc3RyaW5nXTogTmdBY3Rpb24gfVxyXG4gIH0pIHtcclxuICAgIE9iamVjdC5rZXlzKG1ldGFkYXRhLnN0YXRlcykuZm9yRWFjaCgoc3RhdGVOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgdGhpcy5idWlsZE5nU3RhdGUoc3RhdGVOYW1lLCBtZXRhZGF0YS5zdGF0ZXNbc3RhdGVOYW1lXSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBPYmplY3Qua2V5cyhtZXRhZGF0YS5yZW5kZXJTdGF0ZXMpLmZvckVhY2goKHJlbmRlclN0YXRlTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHRoaXMuYnVpbGROZ1JlbmRlclN0YXRlKHJlbmRlclN0YXRlTmFtZSwgbWV0YWRhdGEucmVuZGVyU3RhdGVzW3JlbmRlclN0YXRlTmFtZV0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgT2JqZWN0LmtleXMobWV0YWRhdGEuYWN0aW9ucykuZm9yRWFjaCgoYWN0aW9uTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHRoaXMuYnVpbGROZ0FjdGlvbihhY3Rpb25OYW1lLCBtZXRhZGF0YS5hY3Rpb25zW2FjdGlvbk5hbWVdKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg54q25oCBXHJcbiAgICogQHBhcmFtIHN0YXRlTmFtZSDnirbmgIHlkI3np7BcclxuICAgKiBAcGFyYW0gbmdTdGF0ZSAgIOeKtuaAgeWvueixoVxyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGROZ1N0YXRlKHN0YXRlTmFtZTogc3RyaW5nLCBuZ1N0YXRlOiBOZ1N0YXRlKSB7XHJcbiAgICB0aGlzLnN0YXRlcyA9IHRoaXMuc3RhdGVzIHx8IHt9O1xyXG4gICAgdGhpc1tzdGF0ZU5hbWVdID0gbmV3IFN0YXRlKHN0YXRlTmFtZSk7XHJcbiAgICB0aGlzLnN0YXRlc1tzdGF0ZU5hbWVdID0gdGhpc1tzdGF0ZU5hbWVdO1xyXG4gICAgaWYgKG5nU3RhdGUuaW5pdGlhbFN0YXRlKSB7XHJcbiAgICAgIHRoaXMuaW5pdGlhbFN0YXRlID0gdGhpc1tzdGF0ZU5hbWVdO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg55WM6Z2i54q25oCBXHJcbiAgICogQHBhcmFtIHJlbmRlclN0YXRlTmFtZSDmuLLmn5PnirbmgIHlkI3np7BcclxuICAgKiBAcGFyYW0gbmdSZW5kZXJTdGF0ZSAgIOa4suafk+eKtuaAgeWFg+aVsOaNrlxyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGROZ1JlbmRlclN0YXRlKHJlbmRlclN0YXRlTmFtZTogc3RyaW5nLCBuZ1JlbmRlclN0YXRlOiBOZ1JlbmRlclN0YXRlKSB7XHJcbiAgICB0aGlzLnJlbmRlclN0YXRlcyA9IHRoaXMucmVuZGVyU3RhdGVzIHx8IHt9O1xyXG4gICAgdGhpc1tyZW5kZXJTdGF0ZU5hbWVdID0gaW5pdGlhbFVJU3RhdGU7XHJcbiAgICB0aGlzLnJlbmRlclN0YXRlc1tyZW5kZXJTdGF0ZU5hbWVdID0gdGhpc1tyZW5kZXJTdGF0ZU5hbWVdO1xyXG5cclxuICAgIC8vIOWwhnJlbmRlclN0YXRl5LiK5oyH5a6a55qEcmVuZGVy5Yqg5YWl5YiwcmVuZGVyc+S4rVxyXG4gICAgdGhpcy5yZW5kZXJzID0gdGhpcy5yZW5kZXJzIHx8IHt9O1xyXG4gICAgdGhpcy5yZW5kZXJzW3JlbmRlclN0YXRlTmFtZV0gPSBuZ1JlbmRlclN0YXRlLnJlbmRlcjtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWKqOS9nFxyXG4gICAqIEBwYXJhbSBhY3Rpb25OYW1lIOWKqOS9nOWQjeensFxyXG4gICAqIEBwYXJhbSBuZ0FjdGlvbiAgIOWKqOS9nOWFg+aVsOaNrlxyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGROZ0FjdGlvbihhY3Rpb25OYW1lOiBzdHJpbmcsIG5nQWN0aW9uOiBOZ0FjdGlvbikge1xyXG4gICAgdGhpc1thY3Rpb25OYW1lXSA9ICgpID0+IHtcclxuICAgICAgZWZmZWN0SGFuZGxlcnMudHJhbnNpdC5wZXJmb3JtKHRoaXMsIG5nQWN0aW9uLnRyYW5zaXRUbywgbmdBY3Rpb24ucHJlY29uZGl0aW9uKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDph43mlrDorqHnrpfmiYDmnInmuLLmn5PnirbmgIHnmoTlgLxcclxuICAgKiDlvZMgc3RhdGXliIfmjaLnmoTml7blgJnvvIzosIPnlKjpgY3ljobmiYDmnInnmoRyZW5kZXLmlrnms5XvvIzmm7TmlLlyZW5kZXJTdGF0ZVxyXG4gICAqL1xyXG4gIHJlbmRlcigpIHtcclxuICAgIGlmICh0aGlzLmlzRGlzcG9zZWQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgZm9yIChjb25zdCByZW5kZXJTdGF0ZU5hbWUgaW4gdGhpcy5yZW5kZXJTdGF0ZXMpIHtcclxuICAgICAgaWYgKHRoaXMucmVuZGVyU3RhdGVzLmhhc093blByb3BlcnR5KHJlbmRlclN0YXRlTmFtZSkgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3Qgc3RhdGVSZW5kZXIgPSB0aGlzLnJlbmRlcnNbcmVuZGVyU3RhdGVOYW1lXTtcclxuICAgICAgaWYgKCFzdGF0ZVJlbmRlcikge1xyXG4gICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIOiwg+eUqHJlbmRlcuaWueazle+8jOabtOaWsHJlbmRlclN0YXRlXHJcbiAgICAgIHRoaXMucmVuZGVyU3RhdGVzW3JlbmRlclN0YXRlTmFtZV0gPSBzdGF0ZVJlbmRlcih0aGlzLmNvbnRleHQpO1xyXG4gICAgICB0aGlzW3JlbmRlclN0YXRlTmFtZV0gPSB0aGlzLnJlbmRlclN0YXRlc1tyZW5kZXJTdGF0ZU5hbWVdO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zdGF0ZUNoYW5nZS5uZXh0KHRoaXMuY29udGV4dC5zdGF0ZSk7XHJcbiAgfVxyXG59XHJcbiJdfQ==