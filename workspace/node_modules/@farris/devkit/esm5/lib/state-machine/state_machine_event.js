import { Injectable } from '@angular/core';
import { StateMachine } from './state_machine';
/**
 * 状态机事件，监听uistate的变化和entity的变化
 */
var StateMachineEvent = /** @class */ (function () {
    function StateMachineEvent(stateMachine) {
        this.stateMachine = stateMachine;
        this.uiFieldList = [];
        this.dataFieldList = [];
        this.frameContextMap = new Map();
        this.dataFrameContextMap = new Map();
    }
    Object.defineProperty(StateMachineEvent.prototype, "appContext", {
        get: function () {
            return this.stateMachine.appContext;
        },
        enumerable: true,
        configurable: true
    });
    StateMachineEvent.prototype.initialize = function (frameContext) {
        this.frameContext = frameContext;
    };
    /**
     * 暂时把这个方法放了这个地方，等季老师共用方法调整后，直接引用他的方法，该方法可删除
     */
    StateMachineEvent.prototype.extractPaths = function (expression) {
        var path = '';
        var UI_STATE_PATTERN_G = /\{UISTATE~(\S+?)\}$/g;
        var DATA_PATTERN_G = /\{DATA~(\S+?)\}$/g;
        if (typeof expression === 'string') {
            var uiStateVariables = expression.match(UI_STATE_PATTERN_G);
            var dataVariables = expression.match(DATA_PATTERN_G);
            if (uiStateVariables !== null) {
                var UI_STATE_PATTERN_1 = /\{UISTATE~(\S+?)\}$/;
                uiStateVariables.forEach(function (uiStateVariable) {
                    var pathMatches = uiStateVariable.match(UI_STATE_PATTERN_1);
                    if (pathMatches != null && pathMatches.length === 2) {
                        path = pathMatches[1];
                    }
                });
            }
            if (dataVariables !== null) {
                var DATA_PATTERN_1 = /\{DATA~(\S+?)\}$/;
                dataVariables.forEach(function (dataVariable) {
                    var pathMatches = dataVariable.match(DATA_PATTERN_1);
                    if (pathMatches != null && pathMatches.length === 2) {
                        path = pathMatches[1];
                    }
                });
            }
        }
        return path;
    };
    // 根据表达式返回当前组件的frameContext
    StateMachineEvent.prototype.getFrameContext = function (expression) {
        var frameId = this.extractPaths(expression).split('/')[1] || '';
        if (frameId.startsWith('#{') && frameId.endsWith('}') && this.frameContext) {
            var relativeFrameId = frameId.substring(2, frameId.length - 1);
            frameId = this.frameContext.namespace ? this.frameContext.namespace + "_" + relativeFrameId : relativeFrameId;
        }
        return this.appContext.getFrameContext(frameId);
    };
    // 根据表达式返回当前组件的字段(可能是实体字段也可能是uistate的字段)
    StateMachineEvent.prototype.getFrameField = function (expression) {
        return this.extractPaths(expression).split('/')[2];
    };
    // 监听表单变量的变化
    StateMachineEvent.prototype.ListenUIStateChange = function (frameContext, expression) {
        var _this = this;
        var frameField = this.getFrameField(expression);
        if (!this.frameContextMap.has(frameContext)) {
            this.frameContextMap.set(frameContext, this.uiFieldList);
            frameContext.uiState.changes.subscribe(function (data) {
                if (data.field && _this.frameContextMap.get(frameContext).indexOf(data.field) > -1) {
                    _this.stateMachine.render();
                }
            });
        }
        if (this.frameContextMap.get(frameContext).indexOf(frameField) === -1) {
            this.uiFieldList.push(frameField);
        }
    };
    // 监听实体数据的变化
    StateMachineEvent.prototype.ListenEntityChange = function (frameContext, expression) {
        var _this = this;
        if (!this.dataFrameContextMap.has(frameContext)) {
            this.dataFrameContextMap.set(frameContext, this.dataFieldList);
            frameContext.bindingData.changes.subscribe(function (change) {
                // 切换当前行用到的是
                if (change.type === 'Load' || change.type === 'SelectionChanged') {
                    _this.stateMachine.render();
                }
                if (change.path.join() && _this.isAccordingValue(_this.dataFrameContextMap.get(frameContext), change.path.join('/'))) {
                    _this.stateMachine.render();
                }
            });
        }
        if (this.dataFrameContextMap.get(frameContext).indexOf(expression) === -1) {
            this.dataFieldList.push(expression);
        }
    };
    // 监听是否是解析的数据发生变化
    StateMachineEvent.prototype.isAccordingValue = function (arr, path) {
        return arr.find(function (item) {
            return item.indexOf(path) > -1;
        }) === undefined ? false : true;
    };
    StateMachineEvent.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    StateMachineEvent.ctorParameters = function () { return [
        { type: StateMachine }
    ]; };
    return StateMachineEvent;
}());
export { StateMachineEvent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVfbWFjaGluZV9ldmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3N0YXRlLW1hY2hpbmUvc3RhdGVfbWFjaGluZV9ldmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUsvQzs7R0FFRztBQUNIO0lBaUJFLDJCQUFtQixZQUEwQjtRQUExQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQVI3QyxnQkFBVyxHQUFrQixFQUFFLENBQUM7UUFJaEMsa0JBQWEsR0FBa0IsRUFBRSxDQUFDO1FBS2hDLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxHQUFHLEVBQXFCLENBQUM7UUFDcEQsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksR0FBRyxFQUFxQixDQUFDO0lBQzFELENBQUM7SUFmRCxzQkFBSSx5Q0FBVTthQUFkO1lBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQXdCLENBQUM7UUFDcEQsQ0FBQzs7O09BQUE7SUFlRCxzQ0FBVSxHQUFWLFVBQVcsWUFBMEI7UUFDbkMsSUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUM7SUFDbkMsQ0FBQztJQUVEOztPQUVHO0lBQ0ssd0NBQVksR0FBcEIsVUFBcUIsVUFBa0I7UUFDckMsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2QsSUFBTSxrQkFBa0IsR0FBRyxzQkFBc0IsQ0FBQztRQUNsRCxJQUFNLGNBQWMsR0FBRyxtQkFBbUIsQ0FBQztRQUMzQyxJQUFJLE9BQU8sVUFBVSxLQUFLLFFBQVEsRUFBRTtZQUNsQyxJQUFNLGdCQUFnQixHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsQ0FBQztZQUM5RCxJQUFNLGFBQWEsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLGNB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QUN6RSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUNyQztJQUNILENBQUM7SUFDRCxpQkFBaUI7SUFDakIsNENBQWdCLEdBQWhCLFVBQWlCLEdBQVEsRUFBRSxJQUFZO1FBQ3JDLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxVQUFBLElBQUk7WUFDbEIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2pDLENBQUMsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDbEMsQ0FBQzs7Z0JBakhGLFVBQVU7Ozs7Z0JBUkYsWUFBWTs7SUEwSHJCLHdCQUFDO0NBQUEsQUFsSEQsSUFrSEM7U0FqSFksaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBTdGF0ZU1hY2hpbmUgfSBmcm9tICcuL3N0YXRlX21hY2hpbmUnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQgfSBmcm9tICcuLi9mcmFtZS9pbmRleCc7XHJcbmltcG9ydCB7IENoYW5nZSB9IGZyb20gJy4uL2JpbmRpbmctZGF0YS9jaGFuZ2VzJztcclxuaW1wb3J0IHsgQXBwQ29udGV4dCB9IGZyb20gJy4uL2FwcCc7XHJcblxyXG4vKipcclxuICog54q25oCB5py65LqL5Lu277yM55uR5ZCsdWlzdGF0ZeeahOWPmOWMluWSjGVudGl0eeeahOWPmOWMllxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgU3RhdGVNYWNoaW5lRXZlbnQge1xyXG5cclxuICBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dDtcclxuXHJcbiAgZ2V0IGFwcENvbnRleHQoKTogQXBwQ29udGV4dCB7XHJcbiAgICByZXR1cm4gdGhpcy5zdGF0ZU1hY2hpbmUuYXBwQ29udGV4dCBhcyBBcHBDb250ZXh0O1xyXG4gIH1cclxuXHJcbiAgdWlGaWVsZExpc3Q6IEFycmF5PHN0cmluZz4gPSBbXTtcclxuXHJcbiAgZnJhbWVDb250ZXh0TWFwOiBNYXA8RnJhbWVDb250ZXh0LCBBcnJheTxzdHJpbmc+PjtcclxuXHJcbiAgZGF0YUZpZWxkTGlzdDogQXJyYXk8c3RyaW5nPiA9IFtdO1xyXG5cclxuICBkYXRhRnJhbWVDb250ZXh0TWFwOiBNYXA8RnJhbWVDb250ZXh0LCBBcnJheTxzdHJpbmc+PjtcclxuXHJcbiAgY29uc3RydWN0b3IocHVibGljIHN0YXRlTWFjaGluZTogU3RhdGVNYWNoaW5lKSB7XHJcbiAgICB0aGlzLmZyYW1lQ29udGV4dE1hcCA9IG5ldyBNYXA8RnJhbWVDb250ZXh0LCBhbnk+KCk7XHJcbiAgICB0aGlzLmRhdGFGcmFtZUNvbnRleHRNYXAgPSBuZXcgTWFwPEZyYW1lQ29udGV4dCwgYW55PigpO1xyXG4gIH1cclxuXHJcbiAgaW5pdGlhbGl6ZShmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkge1xyXG4gICAgdGhpcy5mcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmmoLml7bmiorov5nkuKrmlrnms5XmlL7kuobov5nkuKrlnLDmlrnvvIznrYnlraPogIHluIjlhbHnlKjmlrnms5XosIPmlbTlkI7vvIznm7TmjqXlvJXnlKjku5bnmoTmlrnms5XvvIzor6Xmlrnms5Xlj6/liKDpmaRcclxuICAgKi9cclxuICBwcml2YXRlIGV4dHJhY3RQYXRocyhleHByZXNzaW9uOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgbGV0IHBhdGggPSAnJztcclxuICAgIGNvbnN0IFVJX1NUQVRFX1BBVFRFUk5fRyA9IC9cXHtVSVNUQVRFfihcXFMrPylcXH0kL2c7XHJcbiAgICBjb25zdCBEQVRBX1BBVFRFUk5fRyA9IC9cXHtEQVRBfihcXFMrPylcXH0kL2c7XHJcbiAgICBpZiAodHlwZW9mIGV4cHJlc3Npb24gPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgIGNvbnN0IHVpU3RhdGVWYXJpYWJsZXMgPSBleHByZXNzaW9uLm1hdGNoKFVJX1NUQVRFX1BBVFRFUk5fRyk7XHJcbiAgICAgIGNvbnN0IGRhdGFWYXJpYWJsZXMgPSBleHByZXNzaW9uLm1hdGNoKERBVEFfUEFUVEVSTl9HKTtcclxuICAgICAgaWYgKHVpU3RhdGVWYXJpYWJsZXMgIT09IG51bGwpIHtcclxuICAgICAgICBjb25zdCBVSV9TVEFURV9QQVRURVJOID0gL1xce1VJU1RBVEV+KFxcUys/KVxcfSQvO1xyXG4gICAgICAgIHVpU3RhdGVWYXJpYWJsZXMuZm9yRWFjaCgodWlTdGF0ZVZhcmlhYmxlOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgIGNvbnN0IHBhdGhNYXRjaGVzID0gdWlTdGF0ZVZhcmlhYmxlLm1hdGNoKFVJX1NUQVRFX1BBVFRFUk4pO1xyXG4gICAgICAgICAgaWYgKHBhdGhNYXRjaGVzICE9IG51bGwgJiYgcGF0aE1hdGNoZXMubGVuZ3RoID09PSAyKSB7XHJcbiAgICAgICAgICAgIHBhdGggPSBwYXRoTWF0Y2hlc1sxXTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoZGF0YVZhcmlhYmxlcyAhPT0gbnVsbCkge1xyXG4gICAgICAgIGNvbnN0IERBVEFfUEFUVEVSTiA9IC9cXHtEQVRBfihcXFMrPylcXH0kLztcclxuICAgICAgICBkYXRhVmFyaWFibGVzLmZvckVhY2goKGRhdGFWYXJpYWJsZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBwYXRoTWF0Y2hlcyA9IGRhdGFWYXJpYWJsZS5tYXRjaChEQVRBX1BBVFRFUk4pO1xyXG4gICAgICAgICAgaWYgKHBhdGhNYXRjaGVzICE9IG51bGwgJiYgcGF0aE1hdGNoZXMubGVuZ3RoID09PSAyKSB7XHJcbiAgICAgICAgICAgIHBhdGggPSBwYXRoTWF0Y2hlc1sxXTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHBhdGg7XHJcbiAgfVxyXG5cclxuICAvLyDmoLnmja7ooajovr7lvI/ov5Tlm57lvZPliY3nu4Tku7bnmoRmcmFtZUNvbnRleHRcclxuICBnZXRGcmFtZUNvbnRleHQoZXhwcmVzc2lvbjogYW55KTogRnJhbWVDb250ZXh0IHtcclxuICAgIGxldCBmcmFtZUlkID0gdGhpcy5leHRyYWN0UGF0aHMoZXhwcmVzc2lvbikuc3BsaXQoJy8nKVsxXSB8fCAnJztcclxuICAgIGlmIChmcmFtZUlkLnN0YXJ0c1dpdGgoJyN7JykgJiYgZnJhbWVJZC5lbmRzV2l0aCgnfScpICYmIHRoaXMuZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIGNvbnN0IHJlbGF0aXZlRnJhbWVJZCA9IGZyYW1lSWQuc3Vic3RyaW5nKDIsIGZyYW1lSWQubGVuZ3RoIC0gMSk7XHJcbiAgICAgIGZyYW1lSWQgPSB0aGlzLmZyYW1lQ29udGV4dC5uYW1lc3BhY2UgPyBgJHt0aGlzLmZyYW1lQ29udGV4dC5uYW1lc3BhY2V9XyR7cmVsYXRpdmVGcmFtZUlkfWAgOiByZWxhdGl2ZUZyYW1lSWQ7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5hcHBDb250ZXh0LmdldEZyYW1lQ29udGV4dChmcmFtZUlkKTtcclxuICB9XHJcblxyXG4gIC8vIOagueaNruihqOi+vuW8j+i/lOWbnuW9k+WJjee7hOS7tueahOWtl+autSjlj6/og73mmK/lrp7kvZPlrZfmrrXkuZ/lj6/og73mmK91aXN0YXRl55qE5a2X5q61KVxyXG4gIGdldEZyYW1lRmllbGQoZXhwcmVzc2lvbjogYW55KSB7XHJcbiAgICByZXR1cm4gdGhpcy5leHRyYWN0UGF0aHMoZXhwcmVzc2lvbikuc3BsaXQoJy8nKVsyXTtcclxuICB9XHJcblxyXG4gIC8vIOebkeWQrOihqOWNleWPmOmHj+eahOWPmOWMllxyXG4gIExpc3RlblVJU3RhdGVDaGFuZ2UoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIGV4cHJlc3Npb246IGFueSkge1xyXG4gICAgY29uc3QgZnJhbWVGaWVsZCA9IHRoaXMuZ2V0RnJhbWVGaWVsZChleHByZXNzaW9uKTtcclxuICAgIGlmICghdGhpcy5mcmFtZUNvbnRleHRNYXAuaGFzKGZyYW1lQ29udGV4dCkpIHtcclxuICAgICAgdGhpcy5mcmFtZUNvbnRleHRNYXAuc2V0KGZyYW1lQ29udGV4dCwgdGhpcy51aUZpZWxkTGlzdCk7XHJcbiAgICAgIGZyYW1lQ29udGV4dC51aVN0YXRlLmNoYW5nZXMuc3Vic2NyaWJlKChkYXRhKSA9PiB7XHJcbiAgICAgICAgaWYgKGRhdGEuZmllbGQgJiYgdGhpcy5mcmFtZUNvbnRleHRNYXAuZ2V0KGZyYW1lQ29udGV4dCkuaW5kZXhPZihkYXRhLmZpZWxkKSA+IC0xKSB7XHJcbiAgICAgICAgICB0aGlzLnN0YXRlTWFjaGluZS5yZW5kZXIoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0TWFwLmdldChmcmFtZUNvbnRleHQpLmluZGV4T2YoZnJhbWVGaWVsZCkgPT09IC0xKSB7XHJcbiAgICAgIHRoaXMudWlGaWVsZExpc3QucHVzaChmcmFtZUZpZWxkKTtcclxuICAgIH1cclxuICB9XHJcblxyXG5cclxuICAvLyDnm5HlkKzlrp7kvZPmlbDmja7nmoTlj5jljJZcclxuICBMaXN0ZW5FbnRpdHlDaGFuZ2UoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIGV4cHJlc3Npb246IGFueSkge1xyXG4gICAgaWYgKCF0aGlzLmRhdGFGcmFtZUNvbnRleHRNYXAuaGFzKGZyYW1lQ29udGV4dCkpIHtcclxuICAgICAgdGhpcy5kYXRhRnJhbWVDb250ZXh0TWFwLnNldChmcmFtZUNvbnRleHQsIHRoaXMuZGF0YUZpZWxkTGlzdCk7XHJcbiAgICAgIGZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5jaGFuZ2VzLnN1YnNjcmliZSgoY2hhbmdlOiBDaGFuZ2UpID0+IHtcclxuICAgICAgICAvLyDliIfmjaLlvZPliY3ooYznlKjliLDnmoTmmK9cclxuICAgICAgICBpZiAoY2hhbmdlLnR5cGUgPT09ICdMb2FkJyB8fCBjaGFuZ2UudHlwZSA9PT0gJ1NlbGVjdGlvbkNoYW5nZWQnKSB7XHJcbiAgICAgICAgICB0aGlzLnN0YXRlTWFjaGluZS5yZW5kZXIoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNoYW5nZS5wYXRoLmpvaW4oKSAmJiB0aGlzLmlzQWNjb3JkaW5nVmFsdWUodGhpcy5kYXRhRnJhbWVDb250ZXh0TWFwLmdldChmcmFtZUNvbnRleHQpLCBjaGFuZ2UucGF0aC5qb2luKCcvJykpKSB7XHJcbiAgICAgICAgICB0aGlzLnN0YXRlTWFjaGluZS5yZW5kZXIoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuZGF0YUZyYW1lQ29udGV4dE1hcC5nZXQoZnJhbWVDb250ZXh0KS5pbmRleE9mKGV4cHJlc3Npb24pID09PSAtMSkge1xyXG4gICAgICB0aGlzLmRhdGFGaWVsZExpc3QucHVzaChleHByZXNzaW9uKTtcclxuICAgIH1cclxuICB9XHJcbiAgLy8g55uR5ZCs5piv5ZCm5piv6Kej5p6Q55qE5pWw5o2u5Y+R55Sf5Y+Y5YyWXHJcbiAgaXNBY2NvcmRpbmdWYWx1ZShhcnI6IGFueSwgcGF0aDogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gYXJyLmZpbmQoaXRlbSA9PiB7XHJcbiAgICAgIHJldHVybiBpdGVtLmluZGV4T2YocGF0aCkgPiAtMTtcclxuICAgIH0pID09PSB1bmRlZmluZWQgPyBmYWxzZSA6IHRydWU7XHJcbiAgfVxyXG59Il19