/**
 * 状态机上下文
 */
var StateMachineContext = /** @class */ (function () {
    /**
     * 构造函数
     * @param stateMachine 状态机
     * @param initialState 初始状态
     */
    function StateMachineContext(stateMachine) {
        this.stateMachine = stateMachine;
        // this.state = initialState.name;
    }
    StateMachineContext.prototype.initialize = function (variableParseService, initialState) {
        this.frameContext = this.stateMachine && this.stateMachine.frameContext || null;
        this.state = this.state || (initialState ? initialState.name : '');
        this.parser = variableParseService;
        this.stateMachineEvent = this.stateMachine.stateMachineEvent;
    };
    /**
     * 状态迁移
     * @param stateName 下一状态的名称
     */
    StateMachineContext.prototype.transitTo = function (stateName) {
        var nextState = this.stateMachine.states[stateName];
        if (nextState) {
            this.state = nextState.name;
            this.stateMachine.render();
        }
    };
    StateMachineContext.prototype.parse = function (expression, targetType) {
        if (expression === null || expression === undefined) {
            return expression;
        }
        var context = this.stateMachineEvent.getFrameContext(expression) || this.stateMachine.frameContext;
        switch (targetType) {
            case 'source':
                return this.parseSourceValue(expression, context);
            case 'target':
                return this.parser.parse(expression, context);
        }
    };
    StateMachineContext.prototype.parseSourceValue = function (expression, context) {
        if (expression === null || expression === undefined) {
            return expression;
        }
        var result = expression.trim();
        result = this.parser.parse(result, context);
        if (result === 'state') {
            result = this.state;
        }
        return result;
    };
    // 兼容旧版本
    StateMachineContext.prototype.get = function (expression) {
        return this.getUIState(expression);
    };
    // 解析uistate变量表达式并返回表达式的值
    StateMachineContext.prototype.getUIState = function (expression) {
        if (!expression) {
            return;
        }
        var frameContext = this.stateMachineEvent.getFrameContext(expression);
        if (!frameContext) {
            return;
        }
        this.stateMachineEvent.ListenUIStateChange(frameContext, expression);
        if (this.parser) {
            var value = this.parser.parse(expression, frameContext);
            if (value === null) {
                return null;
            }
            if (typeof value === 'object' && Object.keys(value).length === 0) {
                return null;
            }
            return value;
        }
        else {
            throw new Error('未初始化变量解析器。');
        }
    };
    // 解析data变量表达式并返回表达式的值
    StateMachineContext.prototype.getData = function (expression) {
        if (!expression) {
            return;
        }
        var frameContext = this.stateMachineEvent.getFrameContext(expression);
        if (!frameContext) {
            return;
        }
        this.stateMachineEvent.ListenEntityChange(frameContext, expression);
        if (this.parser) {
            var value = this.parser.parse(expression, frameContext);
            if (value === null) {
                return null;
            }
            if (typeof value === 'object' && Object.keys(value).length === 0) {
                return null;
            }
            return value;
        }
        else {
            throw new Error('未初始化变量解析器。');
        }
    };
    return StateMachineContext;
}());
export { StateMachineContext };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3N0YXRlLW1hY2hpbmUvY29udGV4dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFPQTs7R0FFRztBQUNIO0lBY0U7Ozs7T0FJRztJQUNILDZCQUFtQixZQUEwQjtRQUExQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMzQyxrQ0FBa0M7SUFDcEMsQ0FBQztJQUVELHdDQUFVLEdBQVYsVUFBVyxvQkFBMEMsRUFBRSxZQUFtQjtRQUN4RSxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDO1FBQ2hGLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbkUsSUFBSSxDQUFDLE1BQU0sR0FBRyxvQkFBb0IsQ0FBQztRQUNuQyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQztJQUMvRCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsdUNBQVMsR0FBVCxVQUFVLFNBQWlCO1FBQ3pCLElBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3RELElBQUksU0FBUyxFQUFFO1lBQ2IsSUFBSSxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDO1lBQzVCLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDNUI7SUFDSCxDQUFDO0lBRUQsbUNBQUssR0FBTCxVQUFNLFVBQWtCLEVBQUUsVUFBK0I7UUFDdkQsSUFBSSxVQUFVLEtBQUssSUFBSSxJQUFJLFVBQVUsS0FBSyxTQUFTLEVBQUU7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QU8sS0FBSyxLQUFLLFFBQVEsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7Z0JBQ2hFLE9BQU8sSUFBSSxDQUFDO2FBQ2I7WUFDRCxPQUFPLEtBQUssQ0FBQztTQUNkO2FBQU07WUFDTCxNQUFNLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQy9CO0lBQ0gsQ0FBQztJQUNILDBCQUFDO0FBQUQsQ0FBQyxBQXRIRCxJQXNIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN0YXRlTWFjaGluZSB9IGZyb20gJy4vc3RhdGVfbWFjaGluZSc7XHJcbmltcG9ydCB7IFN0YXRlIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IENvbnRleHQgfSBmcm9tICcuLi9jb250ZXh0L2NvbnRleHQnO1xyXG5pbXBvcnQgeyBWYXJpYWJsZVBhcnNlU2VydmljZSB9IGZyb20gJy4uL3ZhcmlhYmxlL2luZGV4JztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0IH0gZnJvbSAnLi4vZnJhbWUvaW5kZXgnO1xyXG5pbXBvcnQgeyBTdGF0ZU1hY2hpbmVFdmVudCB9IGZyb20gJy4vc3RhdGVfbWFjaGluZV9ldmVudCc7XHJcblxyXG4vKipcclxuICog54q25oCB5py65LiK5LiL5paHXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgU3RhdGVNYWNoaW5lQ29udGV4dCB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOW9k+WJjeeKtuaAgeWQjeensFxyXG4gICAqL1xyXG4gIHN0YXRlOiBzdHJpbmc7XHJcblxyXG4gIHBhcmVudDogQ29udGV4dDtcclxuXHJcbiAgcGFyc2VyOiBWYXJpYWJsZVBhcnNlU2VydmljZTtcclxuXHJcbiAgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQ7XHJcblxyXG4gIHN0YXRlTWFjaGluZUV2ZW50OiBTdGF0ZU1hY2hpbmVFdmVudDtcclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKiBAcGFyYW0gc3RhdGVNYWNoaW5lIOeKtuaAgeaculxyXG4gICAqIEBwYXJhbSBpbml0aWFsU3RhdGUg5Yid5aeL54q25oCBXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IocHVibGljIHN0YXRlTWFjaGluZTogU3RhdGVNYWNoaW5lKSB7XHJcbiAgICAvLyB0aGlzLnN0YXRlID0gaW5pdGlhbFN0YXRlLm5hbWU7XHJcbiAgfVxyXG5cclxuICBpbml0aWFsaXplKHZhcmlhYmxlUGFyc2VTZXJ2aWNlOiBWYXJpYWJsZVBhcnNlU2VydmljZSwgaW5pdGlhbFN0YXRlOiBTdGF0ZSkge1xyXG4gICAgdGhpcy5mcmFtZUNvbnRleHQgPSB0aGlzLnN0YXRlTWFjaGluZSAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQgfHwgbnVsbDtcclxuICAgIHRoaXMuc3RhdGUgPSB0aGlzLnN0YXRlIHx8IChpbml0aWFsU3RhdGUgPyBpbml0aWFsU3RhdGUubmFtZSA6ICcnKTtcclxuICAgIHRoaXMucGFyc2VyID0gdmFyaWFibGVQYXJzZVNlcnZpY2U7XHJcbiAgICB0aGlzLnN0YXRlTWFjaGluZUV2ZW50ID0gdGhpcy5zdGF0ZU1hY2hpbmUuc3RhdGVNYWNoaW5lRXZlbnQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDnirbmgIHov4Hnp7tcclxuICAgKiBAcGFyYW0gc3RhdGVOYW1lIOS4i+S4gOeKtuaAgeeahOWQjeensFxyXG4gICAqL1xyXG4gIHRyYW5zaXRUbyhzdGF0ZU5hbWU6IHN0cmluZykge1xyXG4gICAgY29uc3QgbmV4dFN0YXRlID0gdGhpcy5zdGF0ZU1hY2hpbmUuc3RhdGVzW3N0YXRlTmFtZV07XHJcbiAgICBpZiAobmV4dFN0YXRlKSB7XHJcbiAgICAgIHRoaXMuc3RhdGUgPSBuZXh0U3RhdGUubmFtZTtcclxuICAgICAgdGhpcy5zdGF0ZU1hY2hpbmUucmVuZGVyKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwYXJzZShleHByZXNzaW9uOiBzdHJpbmcsIHRhcmdldFR5cGU6ICdzb3VyY2UnIHwgJ3RhcmdldCcpOiBhbnkge1xyXG4gICAgaWYgKGV4cHJlc3Npb24gPT09IG51bGwgfHwgZXhwcmVzc2lvbiA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHJldHVybiBleHByZXNzaW9uO1xyXG4gICAgfVxyXG4gICAgY29uc3QgY29udGV4dCA9IHRoaXMuc3RhdGVNYWNoaW5lRXZlbnQuZ2V0RnJhbWVDb250ZXh0KGV4cHJlc3Npb24pIHx8IHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dDtcclxuICAgIHN3aXRjaCAodGFyZ2V0VHlwZSkge1xyXG4gICAgICBjYXNlICdzb3VyY2UnOlxyXG4gICAgICAgIHJldHVybiB0aGlzLnBhcnNlU291cmNlVmFsdWUoZXhwcmVzc2lvbiwgY29udGV4dCk7XHJcbiAgICAgIGNhc2UgJ3RhcmdldCc6XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VyLnBhcnNlKGV4cHJlc3Npb24sIGNvbnRleHQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwYXJzZVNvdXJjZVZhbHVlKGV4cHJlc3Npb246IHN0cmluZywgY29udGV4dDogYW55KTogYW55IHtcclxuICAgIGlmIChleHByZXNzaW9uID09PSBudWxsIHx8IGV4cHJlc3Npb24gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICByZXR1cm4gZXhwcmVzc2lvbjtcclxuICAgIH1cclxuICAgIGxldCByZXN1bHQgPSBleHByZXNzaW9uLnRyaW0oKTtcclxuICAgIHJlc3VsdCA9IHRoaXMucGFyc2VyLnBhcnNlKHJlc3VsdCwgY29udGV4dCk7XHJcbiAgICBpZiAocmVzdWx0ID09PSAnc3RhdGUnKSB7XHJcbiAgICAgIHJlc3VsdCA9IHRoaXMuc3RhdGU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgLy8g5YW85a655pen54mI5pysXHJcbiAgZ2V0KGV4cHJlc3Npb246IHN0cmluZyk6IGFueSB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRVSVN0YXRlKGV4cHJlc3Npb24pO1xyXG4gIH1cclxuICAvLyDop6PmnpB1aXN0YXRl5Y+Y6YeP6KGo6L6+5byP5bm26L+U5Zue6KGo6L6+5byP55qE5YC8XHJcbiAgZ2V0VUlTdGF0ZShleHByZXNzaW9uOiBzdHJpbmcpOiBhbnkge1xyXG4gICAgaWYgKCFleHByZXNzaW9uKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuc3RhdGVNYWNoaW5lRXZlbnQuZ2V0RnJhbWVDb250ZXh0KGV4cHJlc3Npb24pO1xyXG4gICAgaWYgKCFmcmFtZUNvbnRleHQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zdGF0ZU1hY2hpbmVFdmVudC5MaXN0ZW5VSVN0YXRlQ2hhbmdlKGZyYW1lQ29udGV4dCwgZXhwcmVzc2lvbik7XHJcbiAgICBpZiAodGhpcy5wYXJzZXIpIHtcclxuICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLnBhcnNlci5wYXJzZShleHByZXNzaW9uLCBmcmFtZUNvbnRleHQpO1xyXG4gICAgICBpZiAodmFsdWUgPT09IG51bGwpIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgfVxyXG4gICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiBPYmplY3Qua2V5cyh2YWx1ZSkubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCfmnKrliJ3lp4vljJblj5jph4/op6PmnpDlmajjgIInKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOino+aekGRhdGHlj5jph4/ooajovr7lvI/lubbov5Tlm57ooajovr7lvI/nmoTlgLxcclxuICBnZXREYXRhKGV4cHJlc3Npb246IHN0cmluZyk6IGFueSB7XHJcbiAgICBpZiAoIWV4cHJlc3Npb24pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gdGhpcy5zdGF0ZU1hY2hpbmVFdmVudC5nZXRGcmFtZUNvbnRleHQoZXhwcmVzc2lvbik7XHJcbiAgICBpZiAoIWZyYW1lQ29udGV4dCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLnN0YXRlTWFjaGluZUV2ZW50Lkxpc3RlbkVudGl0eUNoYW5nZShmcmFtZUNvbnRleHQsIGV4cHJlc3Npb24pO1xyXG4gICAgaWYgKHRoaXMucGFyc2VyKSB7XHJcbiAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5wYXJzZXIucGFyc2UoZXhwcmVzc2lvbiwgZnJhbWVDb250ZXh0KTtcclxuICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgT2JqZWN0LmtleXModmFsdWUpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcign5pyq5Yid5aeL5YyW5Y+Y6YeP6Kej5p6Q5Zmo44CCJyk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==