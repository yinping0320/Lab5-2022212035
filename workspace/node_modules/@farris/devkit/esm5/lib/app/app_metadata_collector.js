import { DynamicCommandHandler } from '../command';
import { DomService } from '../schema';
import { SchemaService } from '../schema/schema.service';
var ContextMetadataBuilder = /** @class */ (function () {
    function ContextMetadataBuilder() {
    }
    /**
     * 构造应用程序上下文元数据
     * @param formMetadataContent 表单元数据
     * @param stateMachineMetadata 状态机元数
     * @returns 应用程序上下文元数据
     */
    ContextMetadataBuilder.prototype.buildAppContextMetadata = function (formMetadataContent, stateMachineMetadata) {
        var module = formMetadataContent.module;
        var uiStates = module.states;
        var appContextMetadata = {
            identify: module.code,
            namespace: '',
            stateMachine: this.buildStataMachineMetadata(stateMachineMetadata),
            uiStates: this.buildUiStateMetadata(uiStates)
        };
        return appContextMetadata;
    };
    /**
     * 构造视图上下文元数据
     * @param componentId 组件标识
     * @param viewModel 视图模型元数据
     * @param declarations 外部接口定义
     * @param subscriptions 事件订阅定义
     * @returns 视图上下文元数据
     */
    ContextMetadataBuilder.prototype.buildViewContextMetadata = function (component, viewModel, schema, controllers, dynamicOptions) {
        var contextMetadata = {
            identify: component.id,
            namespace: '',
            commands: this.buildCommand(viewModel.commands),
            commandHandlers: this.buildCommandHandlers(viewModel.commands, controllers),
            commandHandlerExtends: [],
            form: this.buildFormMetadata(viewModel),
            formControls: this.buildFormControlMetadata(viewModel.fields, viewModel, schema, component, dynamicOptions),
            subForms: null,
            uiStates: this.buildUiStateMetadata(viewModel.states),
            bindingTo: viewModel.bindTo,
            viewModelCode: viewModel.code
        };
        return contextMetadata;
    };
    ContextMetadataBuilder.prototype.buildCommand = function (commandMetadataArray) {
        var commands = {};
        commandMetadataArray.reduce(function (previousValue, commandMetadata) {
            var ngCommand = {
                name: commandMetadata.code,
                params: {},
                paramDescriptions: {}
            };
            commandMetadata.params.reduce(function (previousCommand, param) {
                previousCommand.params[param.name] = param.value;
                previousCommand.paramDescriptions[param.name] = { type: 'string' };
                return previousCommand;
            }, ngCommand);
            previousValue[commandMetadata.code] = ngCommand;
            return previousValue;
        }, commands);
        return commands;
    };
    ContextMetadataBuilder.prototype.buildFormMetadata = function (viewModel) {
        return {
            formGroupName: viewModel.name,
            enableValidate: viewModel.enableValidation
        };
    };
    ContextMetadataBuilder.prototype.buildFormControlMetadata = function (formFields, viewModel, schema, component, dynamicOptions) {
        var _this = this;
        var formControls = {};
        var formFieldIds = formFields.map(function (formField) { return formField.id; });
        var schemaService = new SchemaService();
        var formFieldsMap = schemaService.getFieldsByIds(formFieldIds, schema, viewModel);
        var domService = new DomService();
        formFields.reduce(function (previousValue, field) {
            var schemaEntityField = formFieldsMap.has(field.id) ? formFieldsMap.get(field.id) : null;
            var binding = schemaEntityField ? schemaEntityField.bindingPath : '';
            var parentElement = {};
            // parentElement 作为引用方式 往外传递
            var domElements = domService.getElementByBinding(component.contents, field.id, parentElement);
            var validRules = [];
            var matchedElement;
            var parentMatchedElement;
            if (domElements && domElements.length >= 1) {
                matchedElement = domElements[0].element;
                parentMatchedElement = domElements[0].parentElement;
                var keys_1 = 'maxValue,minValue,required,require';
                Object.keys(matchedElement).forEach(function (key) {
                    if (keys_1.includes(key)) {
                        if (key === 'maxValue' && (matchedElement[key] !== null && matchedElement[key] !== undefined)) {
                            // 把最大值属性转换成validRule
                            validRules.push({ type: 'maxValue', constraints: [matchedElement[key]] });
                        }
                        else if (key === 'minValue' && (matchedElement[key] !== null && matchedElement[key] !== undefined)) {
                            // 把最小值属性转换成validRule
                            validRules.push({ type: 'minValue', constraints: [matchedElement[key]] });
                        }
                        else if (key === 'required' || key === 'require') {
                            // 把必填属性转换成validRule
                            // 必填表达式可以为状态机
                            if (matchedElement[key] === 'true' || matchedElement[key] === true) {
                                validRules.push({ type: 'required', constraints: [true] });
                            }
                        }
                    }
                });
            }
            previousValue[field.fieldName] = {
                /** 控件标识 */
                id: field.fieldName,
                /** 控件名称 todo: 需要支持多语言 */
                name: _this.getTitle(matchedElement, parentMatchedElement, field.fieldName),
                /** 绑定字段路径 */
                binding: binding,
                /** 控件值更新时机 */
                updateOn: field.updateOn,
                /** 控件默认名称 */
                defaultI18nValue: _this.getTitle(matchedElement, parentMatchedElement, field.fieldName),
                valueChanging: field.valueChanging,
                valueChanged: field.valueChanged,
                valueConverter: _this.generateConverter(schemaEntityField, dynamicOptions),
                /** 验证规则 */
                validRules: validRules
            };
            return previousValue;
        }, formControls);
        return formControls;
    };
    /**
     * 获取对应的title值
     * @param matchedElement
     * @param defaultValue
     * @returns
     */
    ContextMetadataBuilder.prototype.getTitle = function (matchedElement, parentMatchedElement, defaultValue) {
        if (!matchedElement) {
            return defaultValue;
        }
        if (parentMatchedElement.type == 'GridField') {
            return parentMatchedElement.caption || defaultValue;
        }
        return matchedElement.title || defaultValue;
    };
    /**
     * 构造对应的converter
     * @param field
     * @returns
     */
    ContextMetadataBuilder.prototype.generateConverter = function (field, dynamicOptions) {
        var valueConverterMap = dynamicOptions["valueConverterMap"];
        if (!valueConverterMap || !field) {
            return;
        }
        if (field.type && (field.type.name == 'Date' || field.type.name == 'DateTime') && !field.converter) {
            field.converter = valueConverterMap["Date"];
        }
        if (field.multiLanguage && !field.converter) {
            field.converter = valueConverterMap["MultiLang"];
        }
        return field.converter;
    };
    /**
     * 由状态机元数据创建状态机上下文描述
     * @param stateMachineMetadata 状态机元数据
     * @returns 状态机上下文描述
     */
    ContextMetadataBuilder.prototype.buildStataMachineMetadata = function (stateMachineMetadata) {
        var _this = this;
        // 声明状态机上下文元数据
        var stateMachine = {
            states: {},
            renderStates: {},
            actions: {}
        };
        if (!stateMachineMetadata) {
            return stateMachine;
        }
        // 由状态机元数据构造NgState
        stateMachineMetadata.state.reduce(function (previousValue, state) {
            previousValue.states[state.state] = {
                initialState: state.state === stateMachineMetadata.initialState
            };
            return previousValue;
        }, stateMachine);
        // 由状态机元数据构造NgRenderState
        Object.keys(stateMachineMetadata.renderState)
            .reduce(function (previousValue, renderStateName) {
            var renderStateMetadata = stateMachineMetadata.renderState[renderStateName];
            var renderFunction = _this.buildRenderFunction(renderStateMetadata);
            previousValue.renderStates[renderStateName] = {
                render: renderFunction
            };
            // previousValue.renderStates[renderStateName] = {
            //   render: (context: StateMachineContext) => {
            //     return context.parser.parse(renderStateMetadata.condition, this);
            //   }
            // };
            return previousValue;
        }, stateMachine);
        // 由状态机元数据构造NgAction
        Object.keys(stateMachineMetadata.action)
            .reduce(function (previousValue, actionName) {
            var actionMetadata = stateMachineMetadata.action[actionName];
            previousValue.actions[actionName] = {
                precondition: actionMetadata.precondition,
                transitTo: actionMetadata.transitTo
            };
            return previousValue;
        }, stateMachine);
        // 返回状态机元数据
        return stateMachine;
    };
    ContextMetadataBuilder.prototype.buildUiStateMetadata = function (states) {
        var uiStates = {};
        states.reduce(function (previousValue, uiState) {
            previousValue[uiState.code] = {
                stateName: uiState.code
            };
            return previousValue;
        }, uiStates);
        return uiStates;
    };
    ContextMetadataBuilder.prototype.buildRenderFunction = function (renderStateMetadata) {
        if (renderStateMetadata && renderStateMetadata.condition.length) {
            var renderFunctionString = renderStateMetadata.condition.reduce(function (previousFunctionString, condition) {
                var conditionTarget = condition.target;
                if (!conditionTarget.startsWith('\'')) {
                    conditionTarget = "'" + conditionTarget;
                }
                if (!conditionTarget.endsWith('\'')) {
                    conditionTarget = conditionTarget + "'";
                }
                var conditionSource = condition.source;
                if (conditionSource.indexOf('\'') < 0) {
                    conditionSource = "'" + conditionSource + "'";
                }
                if (conditionSource.indexOf('getUIState') > -1) {
                    conditionSource = conditionSource.replace('getUIState', 'context.getUIState');
                }
                if (conditionSource.indexOf('getData') > -1) {
                    conditionSource = conditionSource.replace('getData', 'context.getData');
                }
                // tslint:disable-next-line: max-line-length
                var functionString = (condition.lBracket || '') + "context.parse(" + conditionSource + ",'source')" + condition.compare + condition.target + (condition.rBracket || '');
                if (condition.relation) {
                    switch (condition.relation.trim().toLocaleLowerCase()) {
                        case 'or':
                            functionString += '||';
                            break;
                        case 'and':
                            functionString += '&&';
                            break;
                    }
                }
                return previousFunctionString + functionString;
            }, '');
            if (renderFunctionString) {
                return new Function('context', "return " + renderFunctionString + ";");
            }
        }
        return new Function('context', 'return true;');
    };
    ContextMetadataBuilder.prototype.buildCommandHandlers = function (commandMetadataArray, controllers) {
        var commandHandlers = [];
        commandMetadataArray.reduce(function (previousValue, commandReference) {
            var commandName = commandReference.code;
            var controllerId = commandReference.cmpId;
            var controller = controllers[controllerId];
            var method = Object.assign({}, controller.methods[commandReference.handlerName]);
            method.params = method.params && method.params.map(function (param) { return Object.assign({}, param); });
            if (method.params && method.params.length) {
                commandReference.params.reduce(function (previousMethodValue, param) {
                    var methodParam = previousMethodValue.params.find(function (value) { return value.name === param.name; });
                    if (methodParam) {
                        methodParam.expression = param.value;
                    }
                    return previousMethodValue;
                }, method);
            }
            var commandHandler = new DynamicCommandHandler(commandName, method);
            previousValue.push(commandHandler);
            return previousValue;
        }, commandHandlers);
        return commandHandlers;
    };
    return ContextMetadataBuilder;
}());
export { ContextMetadataBuilder };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwX21ldGFkYXRhX2NvbGxlY3Rvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2FwcC9hcHBfbWV0YWRhdGFfY29sbGVjdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBK0UscUJBQXFCLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFHaEksT0FBTyxFQUFFLFVBQVUsRUFBNkIsTUFBTSxXQUFXLENBQUM7QUFLbEUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBS3pEO0lBRUU7SUFFQSxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSSx3REFBdUIsR0FBOUIsVUFBK0IsbUJBQXdCLEVBQUUsb0JBQW1DO1FBQzFGLElBQU0sTUFBTSxHQUFHLG1CQUFtQixDQUFDLE1BQU0sQ0FBQztRQUMxQyxJQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDO1FBQy9CLElBQU0sa0JBQWtCLEdBQUc7WUFDekIsUUFBUSxFQUFFLE1BQU0sQ0FBQyxJQUFJO1lBQ3JCLFNBQVMsRUFBRSxFQUFFO1lBQ2IsWUFBWSxFQUFFLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxvQkFBb0IsQ0FBQztZQUNsRSxRQUFRLEVBQUUsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsQ0FBQztTQUM5QyxDQUFDO1FBQ0YsT0FBTyxrQkFBa0IsQ0FBQztJQUM1QixDQUFDO0lBR0Q7Ozs7Ozs7T0FPRztJQUNJLHlEQUF3QixHQUEvQixVQUNFLFNBQWMsRUFDZCxTQUF5QixFQUN6QixNQUFjLEVBQ2QsV0FBZ0QsRUFDaEQsY0FBbUI7UUFFbkIsSUFBTSxlQUFlLEdBQUc7WUFDdEIsUUFBUSxFQUFFLFNBQVMsQ0FBQyxFQUFFO1lBQ3RCLFNBQVMsRUFBRSxFQUFFO1lBQ2IsUUFBUSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQztZQUMvQyxlQUFlLEVBQUUsSUFBSSxD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b0JBQ3hGLElBQUksV0FBVyxFQUFFO3dCQUNmLFdBQVcsQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztxQkFDdEM7b0JBQ0QsT0FBTyxtQkFBbUIsQ0FBQztnQkFDN0IsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO2FBQ1o7WUFDRCxJQUFNLGNBQWMsR0FBRyxJQUFJLHFCQUFxQixDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUN0RSxhQUFhLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ25DLE9BQU8sYUFBYSxDQUFDO1FBQ3ZCLENBQUMsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUNwQixPQUFPLGVBQWUsQ0FBQztJQUN6QixDQUFDO0lBQ0gsNkJBQUM7QUFBRCxDQUFDLEFBclRELElBcVRDIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7IENvbW1hbmRDb250cm9sbGVyLCBDb21tYW5kSGFuZGxlciwgQ29tbWFuZEhhbmRsZXJFeHRlbmRlciwgQ29udHJvbGxlck1ldGhvZCwgRHluYW1pY0NvbW1hbmRIYW5kbGVyIH0gZnJvbSAnLi4vY29tbWFuZCc7XHJcbmltcG9ydCB7IFZhbGlkYXRlUnVsZSB9IGZyb20gJy4uL2VudGl0eSc7XHJcbmltcG9ydCB7IE5nRm9ybUNvbnRyb2wsIE5nVmFsaWRhdGVGb3JtIH0gZnJvbSAnLi4vZm9ybSc7XHJcbmltcG9ydCB7IERvbVNlcnZpY2UsIFNjaGVtYSwgU2NoZW1hRW50aXR5RmllbGQgfSBmcm9tICcuLi9zY2hlbWEnO1xyXG5pbXBvcnQge1xyXG4gIElGb3JtVmlld01vZGVsLCBJRm9ybVZpZXdNb2RlbENvbW1hbmQsIElGb3JtVmlld01vZGVsQ29tbWFuZFBhcmFtLCBJRm9ybVZpZXdNb2RlbEZpZWxkLFxyXG4gIElGb3JtVmlld01vZGVsVWlTdGF0ZSwgSVJlbmRlclN0YXRlLCBJU3RhdGVNYWNoaW5lXHJcbn0gZnJvbSAnLi4vc2NoZW1hL2Zvcm0tbWV0YWRhdGEnO1xyXG5pbXBvcnQgeyBTY2hlbWFTZXJ2aWNlIH0gZnJvbSAnLi4vc2NoZW1hL3NjaGVtYS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTmdQYXJhbSB9IGZyb20gJy4uL3VpLXN0YXRlJztcclxuaW1wb3J0IHsgTmdDb21tYW5kIH0gZnJvbSAnLi4vdmlldy1tb2RlbCc7XHJcbmltcG9ydCB7IElDb250ZXh0TWV0YWRhdGEsIElDb250ZXh0U3RhdGVNYWNoaW5lTWV0YWRhdGEgfSBmcm9tICcuL2FwcF9tZXRhZGF0YSc7XHJcblxyXG5leHBvcnQgY2xhc3MgQ29udGV4dE1ldGFkYXRhQnVpbGRlciB7XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOW6lOeUqOeoi+W6j+S4iuS4i+aWh+WFg+aVsOaNrlxyXG4gICAqIEBwYXJhbSBmb3JtTWV0YWRhdGFDb250ZW50IOihqOWNleWFg+aVsOaNrlxyXG4gICAqIEBwYXJhbSBzdGF0ZU1hY2hpbmVNZXRhZGF0YSDnirbmgIHmnLrlhYPmlbBcclxuICAgKiBAcmV0dXJucyDlupTnlKjnqIvluo/kuIrkuIvmloflhYPmlbDmja5cclxuICAgKi9cclxuICBwdWJsaWMgYnVpbGRBcHBDb250ZXh0TWV0YWRhdGEoZm9ybU1ldGFkYXRhQ29udGVudDogYW55LCBzdGF0ZU1hY2hpbmVNZXRhZGF0YTogSVN0YXRlTWFjaGluZSk6IElDb250ZXh0TWV0YWRhdGEge1xyXG4gICAgY29uc3QgbW9kdWxlID0gZm9ybU1ldGFkYXRhQ29udGVudC5tb2R1bGU7XHJcbiAgICBjb25zdCB1aVN0YXRlcyA9IG1vZHVsZS5zdGF0ZXM7XHJcbiAgICBjb25zdCBhcHBDb250ZXh0TWV0YWRhdGEgPSB7XHJcbiAgICAgIGlkZW50aWZ5OiBtb2R1bGUuY29kZSxcclxuICAgICAgbmFtZXNwYWNlOiAnJyxcclxuICAgICAgc3RhdGVNYWNoaW5lOiB0aGlzLmJ1aWxkU3RhdGFNYWNoaW5lTWV0YWRhdGEoc3RhdGVNYWNoaW5lTWV0YWRhdGEpLFxyXG4gICAgICB1aVN0YXRlczogdGhpcy5idWlsZFVpU3RhdGVNZXRhZGF0YSh1aVN0YXRlcylcclxuICAgIH07XHJcbiAgICByZXR1cm4gYXBwQ29udGV4dE1ldGFkYXRhO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOinhuWbvuS4iuS4i+aWh+WFg+aVsOaNrlxyXG4gICAqIEBwYXJhbSBjb21wb25lbnRJZCDnu4Tku7bmoIfor4ZcclxuICAgKiBAcGFyYW0gdmlld01vZGVsIOinhuWbvuaooeWei+WFg+aVsOaNrlxyXG4gICAqIEBwYXJhbSBkZWNsYXJhdGlvbnMg5aSW6YOo5o6l5Y+j5a6a5LmJXHJcbiAgICogQHBhcmFtIHN1YnNjcmlwdGlvbnMg5LqL5Lu26K6i6ZiF5a6a5LmJXHJcbiAgICogQHJldHVybnMg6KeG5Zu+5LiK5LiL5paH5YWD5pWw5o2uXHJcbiAgICovXHJcbiAgcHVibGljIGJ1aWxkVmlld0NvbnRleHRNZXRhZGF0YShcclxuICAgIGNvbXBvbmVudDogYW55LFxyXG4gICAgdmlld01vZGVsOiBJRm9ybVZpZXdNb2RlbCxcclxuICAgIHNjaGVtYTogU2NoZW1hLFxyXG4gICAgY29udHJvbGxlcnM6IHsgW2lkOiBzdHJpbmddOiBDb21tYW5kQ29udHJvbGxlciB9LFxyXG4gICAgZHluYW1pY09wdGlvbnM6IGFueVxyXG4gICk6IElDb250ZXh0TWV0YWRhdGEge1xyXG4gICAgY29uc3QgY29udGV4dE1ldGFkYXRhID0ge1xyXG4gICAgICBpZGVudGlmeTogY29tcG9uZW50LmlkLFxyXG4gICAgICBuYW1lc3BhY2U6ICcnLFxyXG4gICAgICBjb21tYW5kczogdGhpcy5idWlsZENvbW1hbmQodmlld01vZGVsLmNvbW1hbmRzKSxcclxuICAgICAgY29tbWFuZEhhbmRsZXJzOiB0aGlzLmJ1aWxkQ29tbWFuZEhhbmRsZXJzKHZpZXdNb2RlbC5jb21tYW5kcywgY29udHJvbGxlcnMpLFxyXG4gICAgICBjb21tYW5kSGFuZGxlckV4dGVuZHM6IFtdLFxyXG4gICAgICBmb3JtOiB0aGlzLmJ1aWxkRm9ybU1ldGFkYXRhKHZpZXdNb2RlbCksXHJcbiAgICAgIGZvcm1Db250cm9sczogdGhpcy5idWlsZEZvcm1Db250cm9sTWV0YWRhdGEodmlld01vZGVsLmZpZWxkcywgdmlld01vZGVsLCBzY2hlbWEsIGNvbXBvbmVudCwgZHluYW1pY09wdGlvbnMpLFxyXG4gICAgICBzdWJGb3JtczogbnVsbCxcclxuICAgICAgdWlTdGF0ZXM6IHRoaXMuYnVpbGRVaVN0YXRlTWV0YWRhdGEodmlld01vZGVsLnN0YXRlcyksXHJcbiAgICAgIGJpbmRpbmdUbzogdmlld01vZGVsLmJpbmRUbyxcclxuICAgICAgdmlld01vZGVsQ29kZTogdmlld01vZGVsLmNvZGVcclxuICAgIH07XHJcbiAgICByZXR1cm4gY29udGV4dE1ldGFkYXRhO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBidWlsZENvbW1hbmQoY29tbWFuZE1ldGFkYXRhQXJyYXk6IElGb3JtVmlld01vZGVsQ29tbWFuZFtdKTogeyBbY29tbWFuZE5hbWU6IHN0cmluZ106IE5nQ29tbWFuZCB9IHtcclxuICAgIGNvbnN0IGNvbW1hbmRzID0ge307XHJcbiAgICBjb21tYW5kTWV0YWRhdGFBcnJheS5yZWR1Y2U8eyBbY29tbWFuZE5hbWU6IHN0cmluZ106IE5nQ29tbWFuZCB9PigocHJldmlvdXNWYWx1ZSwgY29tbWFuZE1ldGFkYXRhOiBJRm9ybVZpZXdNb2RlbENvbW1hbmQpID0+IHtcclxuICAgICAgY29uc3QgbmdDb21tYW5kOiBOZ0NvbW1hbmQgPSB7XHJcbiAgICAgICAgbmFtZTogY29tbWFuZE1ldGFkYXRhLmNvZGUsXHJcbiAgICAgICAgcGFyYW1zOiB7fSxcclxuICAgICAgICBwYXJhbURlc2NyaXB0aW9uczoge31cclxuICAgICAgfTtcclxuICAgICAgY29tbWFuZE1ldGFkYXRhLnBhcmFtcy5yZWR1Y2U8TmdDb21tYW5kPigocHJldmlvdXNDb21tYW5kLCBwYXJhbSkgPT4ge1xyXG4gICAgICAgIHByZXZpb3VzQ29tbWFuZC5wYXJhbXNbcGFyYW0ubmFtZV0gPSBwYXJhbS52YWx1ZTtcclxuICAgICAgICBwcmV2aW91c0NvbW1hbmQucGFyYW1EZXNjcmlwdGlvbnNbcGFyYW0ubmFtZV0gPSB7IHR5cGU6ICdzdHJpbmcnIH07XHJcbiAgICAgICAgcmV0dXJuIHByZXZpb3VzQ29tbWFuZDtcclxuICAgICAgfSwgbmdDb21tYW5kKTtcclxuICAgICAgcHJldmlvdXNWYWx1ZVtjb21tYW5kTWV0YWRhdGEuY29kZV0gPSBuZ0NvbW1hbmQ7XHJcbiAgICAgIHJldHVybiBwcmV2aW91c1ZhbHVlO1xyXG4gICAgfSwgY29tbWFuZHMpO1xyXG4gICAgcmV0dXJuIGNvbW1hbmRzO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBidWlsZEZvcm1NZXRhZGF0YSh2aWV3TW9kZWw6IElGb3JtVmlld01vZGVsKTogTmdWYWxpZGF0ZUZvcm0ge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgZm9ybUdyb3VwTmFtZTogdmlld01vZGVsLm5hbWUsXHJcbiAgICAgIGVuYWJsZVZhbGlkYXRlOiB2aWV3TW9kZWwuZW5hYmxlVmFsaWRhdGlvblxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYnVpbGRGb3JtQ29udHJvbE1ldGFkYXRhKGZvcm1GaWVsZHM6IElGb3JtVmlld01vZGVsRmllbGRbXSwgdmlld01vZGVsOiBJRm9ybVZpZXdNb2RlbCwgc2NoZW1hOiBTY2hlbWEsIGNvbXBvbmVudDogYW55LCBkeW5hbWljT3B0aW9uczogYW55KVxyXG4gICAgOiB7IFtjb250cm9sTmFtZTogc3RyaW5nXTogTmdGb3JtQ29udHJvbCB9IHtcclxuICAgIGNvbnN0IGZvcm1Db250cm9sczogeyBbY29udHJvbE5hbWU6IHN0cmluZ106IE5nRm9ybUNvbnRyb2wgfSA9IHt9O1xyXG4gICAgY29uc3QgZm9ybUZpZWxkSWRzID0gZm9ybUZpZWxkcy5tYXAoZm9ybUZpZWxkID0+IGZvcm1GaWVsZC5pZCk7XHJcbiAgICBjb25zdCBzY2hlbWFTZXJ2aWNlID0gbmV3IFNjaGVtYVNlcnZpY2UoKTtcclxuICAgIGNvbnN0IGZvcm1GaWVsZHNNYXAgPSBzY2hlbWFTZXJ2aWNlLmdldEZpZWxkc0J5SWRzKGZvcm1GaWVsZElkcywgc2NoZW1hLCB2aWV3TW9kZWwpO1xyXG4gICAgY29uc3QgZG9tU2VydmljZSA9IG5ldyBEb21TZXJ2aWNlKCk7XHJcblxyXG4gICAgZm9ybUZpZWxkcy5yZWR1Y2U8eyBbY29udHJvbE5hbWU6IHN0cmluZ106IE5nRm9ybUNvbnRyb2wgfT4oKHByZXZpb3VzVmFsdWUsIGZpZWxkKSA9PiB7XHJcbiAgICAgIGNvbnN0IHNjaGVtYUVudGl0eUZpZWxkOiBTY2hlbWFFbnRpdHlGaWVsZCA9IGZvcm1GaWVsZHNNYXAuaGFzKGZpZWxkLmlkKSA/IGZvcm1GaWVsZHNNYXAuZ2V0KGZpZWxkLmlkKSA6IG51bGw7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmcgPSBzY2hlbWFFbnRpdHlGaWVsZCA/IHNjaGVtYUVudGl0eUZpZWxkLmJpbmRpbmdQYXRoIDogJyc7XHJcbiAgICAgIGNvbnN0IHBhcmVudEVsZW1lbnQgPSB7fTtcclxuICAgICAgLy8gcGFyZW50RWxlbWVudCDkvZzkuLrlvJXnlKjmlrnlvI8g5b6A5aSW5Lyg6YCSXHJcbiAgICAgIGNvbnN0IGRvbUVsZW1lbnRzID0gZG9tU2VydmljZS5nZXRFbGVtZW50QnlCaW5kaW5nKGNvbXBvbmVudC5jb250ZW50cywgZmllbGQuaWQsIHBhcmVudEVsZW1lbnQpO1xyXG4gICAgICBjb25zdCB2YWxpZFJ1bGVzOiBWYWxpZGF0ZVJ1bGVbXSA9IFtdO1xyXG4gICAgICBsZXQgbWF0Y2hlZEVsZW1lbnQ7XHJcbiAgICAgIGxldCBwYXJlbnRNYXRjaGVkRWxlbWVudDtcclxuICAgICAgaWYgKGRvbUVsZW1lbnRzICYmIGRvbUVsZW1lbnRzLmxlbmd0aCA+PSAxKSB7XHJcbiAgICAgICAgbWF0Y2hlZEVsZW1lbnQgPSBkb21FbGVtZW50c1swXS5lbGVtZW50O1xyXG4gICAgICAgIHBhcmVudE1hdGNoZWRFbGVtZW50ID0gZG9tRWxlbWVudHNbMF0ucGFyZW50RWxlbWVudDtcclxuICAgICAgICBjb25zdCBrZXlzID0gJ21heFZhbHVlLG1pblZhbHVlLHJlcXVpcmVkLHJlcXVpcmUnO1xyXG4gICAgICAgIE9iamVjdC5rZXlzKG1hdGNoZWRFbGVtZW50KS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgICAgICBpZiAoa2V5cy5pbmNsdWRlcyhrZXkpKSB7XHJcbiAgICAgICAgICAgIGlmIChrZXkgPT09ICdtYXhWYWx1ZScgJiYgKG1hdGNoZWRFbGVtZW50W2tleV0gIT09IG51bGwgJiYgbWF0Y2hlZEVsZW1lbnRba2V5XSAhPT0gdW5kZWZpbmVkKSkge1xyXG4gICAgICAgICAgICAgIC8vIOaKiuacgOWkp+WAvOWxnuaAp+i9rOaNouaIkHZhbGlkUnVsZVxyXG4gICAgICAgICAgICAgIHZhbGlkUnVsZXMucHVzaCh7IHR5cGU6ICdtYXhWYWx1ZScsIGNvbnN0cmFpbnRzOiBbbWF0Y2hlZEVsZW1lbnRba2V5XV0gfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnbWluVmFsdWUnICYmIChtYXRjaGVkRWxlbWVudFtrZXldICE9PSBudWxsICYmIG1hdGNoZWRFbGVtZW50W2tleV0gIT09IHVuZGVmaW5lZCkpIHtcclxuICAgICAgICAgICAgICAvLyDmiormnIDlsI/lgLzlsZ7mgKfovazmjaLmiJB2YWxpZFJ1bGVcclxuICAgICAgICAgICAgICB2YWxpZFJ1bGVzLnB1c2goeyB0eXBlOiAnbWluVmFsdWUnLCBjb25zdHJhaW50czogW21hdGNoZWRFbGVtZW50W2tleV1dIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ3JlcXVpcmVkJyB8fCBrZXkgPT09ICdyZXF1aXJlJykge1xyXG4gICAgICAgICAgICAgIC8vIOaKiuW/heWhq+WxnuaAp+i9rOaNouaIkHZhbGlkUnVsZVxyXG4gICAgICAgICAgICAgIC8vIOW/heWhq+ihqOi+vuW8j+WPr+S7peS4uueKtuaAgeaculxyXG4gICAgICAgICAgICAgIGlmIChtYXRjaGVkRWxlbWVudFtrZXldID09PSAndHJ1ZScgfHwgbWF0Y2hlZEVsZW1lbnRba2V5XSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgICAgdmFsaWRSdWxlcy5wdXNoKHsgdHlwZTogJ3JlcXVpcmVkJywgY29uc3RyYWludHM6IFt0cnVlXSB9KTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgICBwcmV2aW91c1ZhbHVlW2ZpZWxkLmZpZWxkTmFtZV0gPSB7XHJcbiAgICAgICAgLyoqIOaOp+S7tuagh+ivhiAqL1xyXG4gICAgICAgIGlkOiBmaWVsZC5maWVsZE5hbWUsIC8vYCR7ZmllbGQuZmllbGROYW1lfV8ke2ZpZWxkLmlkLnN1YnN0cigwLCAxMykucmVwbGFjZSgnLScsICdfJyl9YCxcclxuICAgICAgICAvKiog5o6n5Lu25ZCN56ewIHRvZG86IOmcgOimgeaUr+aMgeWkmuivreiogCAqL1xyXG4gICAgICAgIG5hbWU6IHRoaXMuZ2V0VGl0bGUobWF0Y2hlZEVsZW1lbnQsIHBhcmVudE1hdGNoZWRFbGVtZW50LCBmaWVsZC5maWVsZE5hbWUpLFxyXG4gICAgICAgIC8qKiDnu5HlrprlrZfmrrXot6/lvoQgKi9cclxuICAgICAgICBiaW5kaW5nLFxyXG4gICAgICAgIC8qKiDmjqfku7blgLzmm7TmlrDml7bmnLogKi9cclxuICAgICAgICB1cGRhdGVPbjogZmllbGQudXBkYXRlT24sXHJcbiAgICAgICAgLyoqIOaOp+S7tum7mOiupOWQjeensCAqL1xyXG4gICAgICAgIGRlZmF1bHRJMThuVmFsdWU6IHRoaXMuZ2V0VGl0bGUobWF0Y2hlZEVsZW1lbnQsIHBhcmVudE1hdGNoZWRFbGVtZW50LCBmaWVsZC5maWVsZE5hbWUpLFxyXG4gICAgICAgIHZhbHVlQ2hhbmdpbmc6IGZpZWxkLnZhbHVlQ2hhbmdpbmcsXHJcbiAgICAgICAgdmFsdWVDaGFuZ2VkOiBmaWVsZC52YWx1ZUNoYW5nZWQsXHJcbiAgICAgICAgdmFsdWVDb252ZXJ0ZXI6IHRoaXMuZ2VuZXJhdGVDb252ZXJ0ZXIoc2NoZW1hRW50aXR5RmllbGQsIGR5bmFtaWNPcHRpb25zKSxcclxuICAgICAgICAvKiog6aqM6K+B6KeE5YiZICovXHJcbiAgICAgICAgdmFsaWRSdWxlc1xyXG4gICAgICB9O1xyXG5cclxuICAgICAgcmV0dXJuIHByZXZpb3VzVmFsdWU7XHJcbiAgICB9LCBmb3JtQ29udHJvbHMpO1xyXG5cclxuICAgIHJldHVybiBmb3JtQ29udHJvbHM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blr7nlupTnmoR0aXRsZeWAvFxyXG4gICAqIEBwYXJhbSBtYXRjaGVkRWxlbWVudFxyXG4gICAqIEBwYXJhbSBkZWZhdWx0VmFsdWVcclxuICAgKiBAcmV0dXJuc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0VGl0bGUobWF0Y2hlZEVsZW1lbnQsIHBhcmVudE1hdGNoZWRFbGVtZW50LCBkZWZhdWx0VmFsdWUpIHtcclxuICAgIGlmICghbWF0Y2hlZEVsZW1lbnQpIHtcclxuICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTtcclxuICAgIH1cclxuICAgIGlmIChwYXJlbnRNYXRjaGVkRWxlbWVudC50eXBlID09ICdHcmlkRmllbGQnKSB7XHJcbiAgICAgIHJldHVybiBwYXJlbnRNYXRjaGVkRWxlbWVudC5jYXB0aW9uIHx8IGRlZmF1bHRWYWx1ZTtcclxuICAgIH1cclxuICAgIHJldHVybiBtYXRjaGVkRWxlbWVudC50aXRsZSB8fCBkZWZhdWx0VmFsdWU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlr7nlupTnmoRjb252ZXJ0ZXJcclxuICAgKiBAcGFyYW0gZmllbGRcclxuICAgKiBAcmV0dXJuc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2VuZXJhdGVDb252ZXJ0ZXIoZmllbGQsIGR5bmFtaWNPcHRpb25zKSB7XHJcbiAgICBjb25zdCB2YWx1ZUNvbnZlcnRlck1hcCA9IGR5bmFtaWNPcHRpb25zW1widmFsdWVDb252ZXJ0ZXJNYXBcIl07XHJcbiAgICBpZiAoIXZhbHVlQ29udmVydGVyTWFwIHx8ICFmaWVsZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoZmllbGQudHlwZSAmJiAoZmllbGQudHlwZS5uYW1lID09ICdEYXRlJyB8fCBmaWVsZC50eXBlLm5hbWUgPT0gJ0RhdGVUaW1lJykgJiYgIWZpZWxkLmNvbnZlcnRlcikge1xyXG4gICAgICBmaWVsZC5jb252ZXJ0ZXIgPSB2YWx1ZUNvbnZlcnRlck1hcFtcIkRhdGVcIl07XHJcbiAgICB9XHJcbiAgICBpZiAoZmllbGQubXVsdGlMYW5ndWFnZSAmJiAhZmllbGQuY29udmVydGVyKSB7XHJcbiAgICAgIGZpZWxkLmNvbnZlcnRlciA9IHZhbHVlQ29udmVydGVyTWFwW1wiTXVsdGlMYW5nXCJdO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBmaWVsZC5jb252ZXJ0ZXI7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOeUseeKtuaAgeacuuWFg+aVsOaNruWIm+W7uueKtuaAgeacuuS4iuS4i+aWh+aPj+i/sFxyXG4gICAqIEBwYXJhbSBzdGF0ZU1hY2hpbmVNZXRhZGF0YSDnirbmgIHmnLrlhYPmlbDmja5cclxuICAgKiBAcmV0dXJucyDnirbmgIHmnLrkuIrkuIvmlofmj4/ov7BcclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkU3RhdGFNYWNoaW5lTWV0YWRhdGEoc3RhdGVNYWNoaW5lTWV0YWRhdGE6IElTdGF0ZU1hY2hpbmUpOiBJQ29udGV4dFN0YXRlTWFjaGluZU1ldGFkYXRhIHtcclxuICAgIC8vIOWjsOaYjueKtuaAgeacuuS4iuS4i+aWh+WFg+aVsOaNrlxyXG4gICAgY29uc3Qgc3RhdGVNYWNoaW5lOiBJQ29udGV4dFN0YXRlTWFjaGluZU1ldGFkYXRhID0ge1xyXG4gICAgICBzdGF0ZXM6IHt9LFxyXG4gICAgICByZW5kZXJTdGF0ZXM6IHt9LFxyXG4gICAgICBhY3Rpb25zOiB7fVxyXG4gICAgfTtcclxuXHJcbiAgICBpZiAoIXN0YXRlTWFjaGluZU1ldGFkYXRhKSB7XHJcbiAgICAgIHJldHVybiBzdGF0ZU1hY2hpbmU7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g55Sx54q25oCB5py65YWD5pWw5o2u5p6E6YCgTmdTdGF0ZVxyXG4gICAgc3RhdGVNYWNoaW5lTWV0YWRhdGEuc3RhdGUucmVkdWNlPElDb250ZXh0U3RhdGVNYWNoaW5lTWV0YWRhdGE+KChwcmV2aW91c1ZhbHVlLCBzdGF0ZSkgPT4ge1xyXG4gICAgICBwcmV2aW91c1ZhbHVlLnN0YXRlc1tzdGF0ZS5zdGF0ZV0gPSB7XHJcbiAgICAgICAgaW5pdGlhbFN0YXRlOiBzdGF0ZS5zdGF0ZSA9PT0gc3RhdGVNYWNoaW5lTWV0YWRhdGEuaW5pdGlhbFN0YXRlXHJcbiAgICAgIH07XHJcbiAgICAgIHJldHVybiBwcmV2aW91c1ZhbHVlO1xyXG4gICAgfSwgc3RhdGVNYWNoaW5lKTtcclxuICAgIC8vIOeUseeKtuaAgeacuuWFg+aVsOaNruaehOmAoE5nUmVuZGVyU3RhdGVcclxuICAgIE9iamVjdC5rZXlzKHN0YXRlTWFjaGluZU1ldGFkYXRhLnJlbmRlclN0YXRlKVxyXG4gICAgICAucmVkdWNlPElDb250ZXh0U3RhdGVNYWNoaW5lTWV0YWRhdGE+KChwcmV2aW91c1ZhbHVlLCByZW5kZXJTdGF0ZU5hbWUpID0+IHtcclxuICAgICAgICBjb25zdCByZW5kZXJTdGF0ZU1ldGFkYXRhID0gc3RhdGVNYWNoaW5lTWV0YWRhdGEucmVuZGVyU3RhdGVbcmVuZGVyU3RhdGVOYW1lXTtcclxuICAgICAgICBjb25zdCByZW5kZXJGdW5jdGlvbiA9IHRoaXMuYnVpbGRSZW5kZXJGdW5jdGlvbihyZW5kZXJTdGF0ZU1ldGFkYXRhKTtcclxuICAgICAgICBwcmV2aW91c1ZhbHVlLnJlbmRlclN0YXRlc1tyZW5kZXJTdGF0ZU5hbWVdID0ge1xyXG4gICAgICAgICAgcmVuZGVyOiByZW5kZXJGdW5jdGlvblxyXG4gICAgICAgIH07XHJcbiAgICAgICAgLy8gcHJldmlvdXNWYWx1ZS5yZW5kZXJTdGF0ZXNbcmVuZGVyU3RhdGVOYW1lXSA9IHtcclxuICAgICAgICAvLyAgIHJlbmRlcjogKGNvbnRleHQ6IFN0YXRlTWFjaGluZUNvbnRleHQpID0+IHtcclxuICAgICAgICAvLyAgICAgcmV0dXJuIGNvbnRleHQucGFyc2VyLnBhcnNlKHJlbmRlclN0YXRlTWV0YWRhdGEuY29uZGl0aW9uLCB0aGlzKTtcclxuICAgICAgICAvLyAgIH1cclxuICAgICAgICAvLyB9O1xyXG4gICAgICAgIHJldHVybiBwcmV2aW91c1ZhbHVlO1xyXG4gICAgICB9LCBzdGF0ZU1hY2hpbmUpO1xyXG4gICAgLy8g55Sx54q25oCB5py65YWD5pWw5o2u5p6E6YCgTmdBY3Rpb25cclxuICAgIE9iamVjdC5rZXlzKHN0YXRlTWFjaGluZU1ldGFkYXRhLmFjdGlvbilcclxuICAgICAgLnJlZHVjZTxJQ29udGV4dFN0YXRlTWFjaGluZU1ldGFkYXRhPigocHJldmlvdXNWYWx1ZSwgYWN0aW9uTmFtZSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGFjdGlvbk1ldGFkYXRhID0gc3RhdGVNYWNoaW5lTWV0YWRhdGEuYWN0aW9uW2FjdGlvbk5hbWVdO1xyXG4gICAgICAgIHByZXZpb3VzVmFsdWUuYWN0aW9uc1thY3Rpb25OYW1lXSA9IHtcclxuICAgICAgICAgIHByZWNvbmRpdGlvbjogYWN0aW9uTWV0YWRhdGEucHJlY29uZGl0aW9uLFxyXG4gICAgICAgICAgdHJhbnNpdFRvOiBhY3Rpb25NZXRhZGF0YS50cmFuc2l0VG9cclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiBwcmV2aW91c1ZhbHVlO1xyXG4gICAgICB9LCBzdGF0ZU1hY2hpbmUpO1xyXG4gICAgLy8g6L+U5Zue54q25oCB5py65YWD5pWw5o2uXHJcbiAgICByZXR1cm4gc3RhdGVNYWNoaW5lO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBidWlsZFVpU3RhdGVNZXRhZGF0YShzdGF0ZXM6IElGb3JtVmlld01vZGVsVWlTdGF0ZVtdKTogeyBbc3RhdGVOYW1lOiBzdHJpbmddOiBOZ1BhcmFtIH0ge1xyXG4gICAgY29uc3QgdWlTdGF0ZXM6IHsgW3N0YXRlTmFtZTogc3RyaW5nXTogTmdQYXJhbSB9ID0ge307XHJcbiAgICBzdGF0ZXMucmVkdWNlPHsgW3N0YXRlTmFtZTogc3RyaW5nXTogTmdQYXJhbSB9PigocHJldmlvdXNWYWx1ZSwgdWlTdGF0ZSkgPT4ge1xyXG4gICAgICBwcmV2aW91c1ZhbHVlW3VpU3RhdGUuY29kZV0gPSB7XHJcbiAgICAgICAgc3RhdGVOYW1lOiB1aVN0YXRlLmNvZGVcclxuICAgICAgfTtcclxuICAgICAgcmV0dXJuIHByZXZpb3VzVmFsdWU7XHJcbiAgICB9LCB1aVN0YXRlcyk7XHJcbiAgICByZXR1cm4gdWlTdGF0ZXM7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGJ1aWxkUmVuZGVyRnVuY3Rpb24ocmVuZGVyU3RhdGVNZXRhZGF0YTogSVJlbmRlclN0YXRlKTogYW55IHtcclxuICAgIGlmIChyZW5kZXJTdGF0ZU1ldGFkYXRhICYmIHJlbmRlclN0YXRlTWV0YWRhdGEuY29uZGl0aW9uLmxlbmd0aCkge1xyXG4gICAgICBjb25zdCByZW5kZXJGdW5jdGlvblN0cmluZyA9IHJlbmRlclN0YXRlTWV0YWRhdGEuY29uZGl0aW9uLnJlZHVjZTxzdHJpbmc+KChwcmV2aW91c0Z1bmN0aW9uU3RyaW5nLCBjb25kaXRpb24pID0+IHtcclxuICAgICAgICBsZXQgY29uZGl0aW9uVGFyZ2V0ID0gY29uZGl0aW9uLnRhcmdldDtcclxuICAgICAgICBpZiAoIWNvbmRpdGlvblRhcmdldC5zdGFydHNXaXRoKCdcXCcnKSkge1xyXG4gICAgICAgICAgY29uZGl0aW9uVGFyZ2V0ID0gYCcke2NvbmRpdGlvblRhcmdldH1gO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIWNvbmRpdGlvblRhcmdldC5lbmRzV2l0aCgnXFwnJykpIHtcclxuICAgICAgICAgIGNvbmRpdGlvblRhcmdldCA9IGAke2NvbmRpdGlvblRhcmdldH0nYDtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IGNvbmRpdGlvblNvdXJjZSA9IGNvbmRpdGlvbi5zb3VyY2U7XHJcbiAgICAgICAgaWYgKGNvbmRpdGlvblNvdXJjZS5pbmRleE9mKCdcXCcnKSA8IDApIHtcclxuICAgICAgICAgIGNvbmRpdGlvblNvdXJjZSA9IGAnJHtjb25kaXRpb25Tb3VyY2V9J2A7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjb25kaXRpb25Tb3VyY2UuaW5kZXhPZignZ2V0VUlTdGF0ZScpID4gLTEpIHtcclxuICAgICAgICAgIGNvbmRpdGlvblNvdXJjZSA9IGNvbmRpdGlvblNvdXJjZS5yZXBsYWNlKCdnZXRVSVN0YXRlJywgJ2NvbnRleHQuZ2V0VUlTdGF0ZScpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY29uZGl0aW9uU291cmNlLmluZGV4T2YoJ2dldERhdGEnKSA+IC0xKSB7XHJcbiAgICAgICAgICBjb25kaXRpb25Tb3VyY2UgPSBjb25kaXRpb25Tb3VyY2UucmVwbGFjZSgnZ2V0RGF0YScsICdjb250ZXh0LmdldERhdGEnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtYXgtbGluZS1sZW5ndGhcclxuICAgICAgICBsZXQgZnVuY3Rpb25TdHJpbmcgPSBgJHtjb25kaXRpb24ubEJyYWNrZXQgfHwgJyd9Y29udGV4dC5wYXJzZSgke2NvbmRpdGlvblNvdXJjZX0sJ3NvdXJjZScpJHtjb25kaXRpb24uY29tcGFyZX0ke2NvbmRpdGlvbi50YXJnZXR9JHtjb25kaXRpb24uckJyYWNrZXQgfHwgJyd9YDtcclxuICAgICAgICBpZiAoY29uZGl0aW9uLnJlbGF0aW9uKSB7XHJcbiAgICAgICAgICBzd2l0Y2ggKGNvbmRpdGlvbi5yZWxhdGlvbi50cmltKCkudG9Mb2NhbGVMb3dlckNhc2UoKSkge1xyXG4gICAgICAgICAgICBjYXNlICdvcic6XHJcbiAgICAgICAgICAgICAgZnVuY3Rpb25TdHJpbmcgKz0gJ3x8JztcclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnYW5kJzpcclxuICAgICAgICAgICAgICBmdW5jdGlvblN0cmluZyArPSAnJiYnO1xyXG4gICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcHJldmlvdXNGdW5jdGlvblN0cmluZyArIGZ1bmN0aW9uU3RyaW5nO1xyXG4gICAgICB9LCAnJyk7XHJcbiAgICAgIGlmIChyZW5kZXJGdW5jdGlvblN0cmluZykge1xyXG4gICAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oJ2NvbnRleHQnLCBgcmV0dXJuICR7cmVuZGVyRnVuY3Rpb25TdHJpbmd9O2ApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCdjb250ZXh0JywgJ3JldHVybiB0cnVlOycpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBidWlsZENvbW1hbmRIYW5kbGVycyhjb21tYW5kTWV0YWRhdGFBcnJheTogSUZvcm1WaWV3TW9kZWxDb21tYW5kW10sIGNvbnRyb2xsZXJzOiB7IFtpZDogc3RyaW5nXTogQ29tbWFuZENvbnRyb2xsZXIgfSlcclxuICAgIDogQ29tbWFuZEhhbmRsZXJbXSB7XHJcbiAgICBjb25zdCBjb21tYW5kSGFuZGxlcnM6IENvbW1hbmRIYW5kbGVyW10gPSBbXTtcclxuICAgIGNvbW1hbmRNZXRhZGF0YUFycmF5LnJlZHVjZTxDb21tYW5kSGFuZGxlcltdPigocHJldmlvdXNWYWx1ZTogQ29tbWFuZEhhbmRsZXJbXSwgY29tbWFuZFJlZmVyZW5jZTogSUZvcm1WaWV3TW9kZWxDb21tYW5kKSA9PiB7XHJcbiAgICAgIGNvbnN0IGNvbW1hbmROYW1lID0gY29tbWFuZFJlZmVyZW5jZS5jb2RlO1xyXG4gICAgICBjb25zdCBjb250cm9sbGVySWQgPSBjb21tYW5kUmVmZXJlbmNlLmNtcElkO1xyXG4gICAgICBjb25zdCBjb250cm9sbGVyID0gY29udHJvbGxlcnNbY29udHJvbGxlcklkXTtcclxuICAgICAgY29uc3QgbWV0aG9kID0gT2JqZWN0LmFzc2lnbih7fSwgY29udHJvbGxlci5tZXRob2RzW2NvbW1hbmRSZWZlcmVuY2UuaGFuZGxlck5hbWVdKTtcclxuICAgICAgbWV0aG9kLnBhcmFtcyA9IG1ldGhvZC5wYXJhbXMgJiYgbWV0aG9kLnBhcmFtcy5tYXAocGFyYW0gPT4gT2JqZWN0LmFzc2lnbih7fSwgcGFyYW0pKTtcclxuICAgICAgaWYgKG1ldGhvZC5wYXJhbXMgJiYgbWV0aG9kLnBhcmFtcy5sZW5ndGgpIHtcclxuICAgICAgICBjb21tYW5kUmVmZXJlbmNlLnBhcmFtcy5yZWR1Y2U8Q29udHJvbGxlck1ldGhvZD4oKHByZXZpb3VzTWV0aG9kVmFsdWU6IENvbnRyb2xsZXJNZXRob2QsIHBhcmFtOiBJRm9ybVZpZXdNb2RlbENvbW1hbmRQYXJhbSkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgbWV0aG9kUGFyYW0gPSBwcmV2aW91c01ldGhvZFZhbHVlLnBhcmFtcy5maW5kKHZhbHVlID0+IHZhbHVlLm5hbWUgPT09IHBhcmFtLm5hbWUpO1xyXG4gICAgICAgICAgaWYgKG1ldGhvZFBhcmFtKSB7XHJcbiAgICAgICAgICAgIG1ldGhvZFBhcmFtLmV4cHJlc3Npb24gPSBwYXJhbS52YWx1ZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiBwcmV2aW91c01ldGhvZFZhbHVlO1xyXG4gICAgICAgIH0sIG1ldGhvZCk7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgY29tbWFuZEhhbmRsZXIgPSBuZXcgRHluYW1pY0NvbW1hbmRIYW5kbGVyKGNvbW1hbmROYW1lLCBtZXRob2QpO1xyXG4gICAgICBwcmV2aW91c1ZhbHVlLnB1c2goY29tbWFuZEhhbmRsZXIpO1xyXG4gICAgICByZXR1cm4gcHJldmlvdXNWYWx1ZTtcclxuICAgIH0sIGNvbW1hbmRIYW5kbGVycyk7XHJcbiAgICByZXR1cm4gY29tbWFuZEhhbmRsZXJzO1xyXG4gIH1cclxufVxyXG4iXX0=