import * as tslib_1 from "tslib";
import { DataPropGroup } from '../core/index';
import { ENTITY_TEMPLATE, GROUP_FUNCTIONS } from '../resolver/index';
var ExpressionUtil = /** @class */ (function () {
    function ExpressionUtil() {
    }
    ExpressionUtil.getGroupFunctionDependency = function (expr, entityTypeInfo) {
        var _this = this;
        var deps = [];
        // 获取聚合函数依赖项
        var groupFunctionRegex = new RegExp("DefaultFunction\\.(" + GROUP_FUNCTIONS.join('|') + ")\\s*\\([^\\r\\n\\)]*\\)", 'g');
        var groupFunctions = expr.match(groupFunctionRegex);
        if (groupFunctions && groupFunctions.length > 0) {
            // todo: 使用正则匹配时可能会因为参数中有逗号导致问题，后续使用ast解析
            var argumentsRegex_1 = /\(([^\r\n\)]*)\)/;
            var methodNameRegex_1 = /DefaultFunction\.(\S*)\(/;
            groupFunctions.forEach(function (groupFunction) {
                var argumentMatchResult = groupFunction.match(argumentsRegex_1);
                var methodNameMatchResult = groupFunction.match(methodNameRegex_1);
                var methodName = null;
                if (methodNameMatchResult && methodNameMatchResult.length == 2) {
                    methodName = methodNameMatchResult[1];
                }
                if (argumentMatchResult.length === 2) {
                    var argument = argumentMatchResult[1];
                    var args = argument.split(',').map(function (p) { return p.replace(/\"/g, ''); });
                    if (args && args.length === 2) {
                        var item = args.join('.');
                        item = _this.convertToNodeCode(item, entityTypeInfo).join('.');
                        // 移除主表code
                        item = item.substr(item.indexOf('.') + 1);
                        var dep = item.split('.');
                        dep.splice(0, 0, ENTITY_TEMPLATE);
                        deps.push(dep.join('/'));
                    }
                    else if (args && args.length === 3) {
                        if (methodName === 'MultiplyChildNumber') {
                            // support MultiplyChildNumber
                            // [Entity.childrens,prop1,prop2]
                            var prefix = args[0]; // like Entity.childrens
                            // const tableName = args[0];// prefix.substring(prefix.indexOf('.')+1);
                            var prop1FullPath = prefix + "." + args[1];
                            var prop2FullPath = prefix + "." + args[2];
                            [prop1FullPath, prop2FullPath].forEach(function (item) {
                                item = _this.convertToNodeCode(item, entityTypeInfo).join('.');
                                item = item.substr(item.indexOf('.') + 1);
                                var dep = item.split('.');
                                dep.splice(0, 0, ENTITY_TEMPLATE);
                                deps.push(dep.join('/'));
                            });
                        }
                        else if (methodName === 'IsContainMatch' || methodName === 'SortChildData') {
                            // [Entity.childrens,prop1,prop2]
                            var prefix = args[0]; // like Entity.childrens
                            // const tableName = args[0];// prefix.substring(prefix.indexOf('.')+1);
                            var item = prefix + "." + args[1];
                            item = _this.convertToNodeCode(item, entityTypeInfo).join('.');
                            item = item.substr(item.indexOf('.') + 1);
                            var dep = item.split('.');
                            dep.splice(0, 0, ENTITY_TEMPLATE);
                            deps.push(dep.join('/'));
                        }
                    }
                    else if (args && args.length === 4) {
                    }
                    else if (args && args.length === 5) {
                        if (['MinValueOfPeriod', 'MaxValueOfPeriod', 'AvgValueOfPeriod'].includes(methodName)) {
                            // [Entity.childrens,prop1,prop2]
                            var prefix = args[0]; // like Entity.childrens
                            // const tableName = args[0];// prefix.substring(prefix.indexOf('.')+1);
                            var prop1FullPath = prefix + "." + args[1];
                            var prop2FullPath = prefix + "." + args[2];
                            [prop1FullPath, prop2FullPath].forEach(function (item) {
                                item = _this.convertToNodeCode(item, entityTypeInfo).join('.');
                                item = item.substr(item.indexOf('.') + 1);
                                var dep = item.split('.');
                                dep.splice(0, 0, ENTITY_TEMPLATE);
                                deps.push(dep.join('/'));
                            });
                        }
                    }
                    else {
                        throw new Error("\u65E0\u6CD5\u89E3\u6790\u53C2\u6570\uFF1A " + JSON.stringify(argument));
                    }
                }
            });
        }
        return deps;
    };
    /**
     * 将voCode转换为前端nodeCode
     * @param entityExpression like Entity.Child.p1
     * @returns
     */
    ExpressionUtil.convertToNodeCode = function (entityExpression, entityTypeInfo) {
        // UserEntity.storys.p1
        var nodeCodes = [];
        if (entityTypeInfo && entityExpression.includes('.')) {
            var entityExpressions = entityExpression.split('.') || [];
            var dataTypeInfo = entityTypeInfo;
            for (var index = 0; index < entityExpressions.length; index++) {
                var prop = entityExpressions[index];
                if (dataTypeInfo && dataTypeInfo.entityInfo && dataTypeInfo.entityInfo.nodeCode === prop || dataTypeInfo.entityInfo.originalCode === prop) {
                    // 第一个是主表code，不能转nodeCode
                    if (index === 0) {
                        nodeCodes.push(dataTypeInfo.entityInfo.originalCode);
                    }
                    else {
                        nodeCodes.push(dataTypeInfo.entityInfo.nodeCode);
                    }
                    // 下一级可能为子表、对象或属性
                    var nextNodeCode = entityExpressions[index + 1];
                    if (!nextNodeCode) {
                        break;
                    }
                    var nextNodeCodePropInfo = dataTypeInfo.getPropInfoByName(nextNodeCode);
                    if (!nextNodeCodePropInfo) {
                        break;
                    }
                    // 下一级为子表或对象
                    if (nextNodeCodePropInfo.typeInfo) {
                        dataTypeInfo = nextNodeCodePropInfo.typeInfo;
                    }
                }
                else if (dataTypeInfo && dataTypeInfo.getPropInfoByName(prop)) {
                    var dataPropInfo = dataTypeInfo.getPropInfoByName(prop);
                    nodeCodes.push(dataPropInfo.name);
                }
                else {
                    // throw new Error(`错误的属性参数 ${entityExpression}`);
                    break;
                }
            }
        }
        return nodeCodes;
    };
    /**
     * 找到元数据中所有实体路径
     * @param dataTypeInfo
     * @param results
     * @param paths
     */
    ExpressionUtil.getChildrenEntityPaths = function (dataTypeInfo, results, paths) {
        var _this = this;
        if (paths === void 0) { paths = []; }
        var list = dataTypeInfo.getPropInfosByGroup(DataPropGroup.List);
        if (list && list.length > 0) {
            list.forEach(function (dataPropInfo) {
                if (paths.length === 0) {
                    results.push([dataPropInfo.name]);
                }
                var childrens = dataPropInfo.typeInfo.getPropInfosByGroup(DataPropGroup.List);
                if (childrens && childrens.length > 0) {
                    paths.push(dataPropInfo.name);
                    childrens.forEach(function (dataPropInfo) {
                        _this.getChildrenEntityPaths(dataPropInfo.typeInfo, results, paths);
                    });
                }
                else {
                    if (paths.length !== 0) {
                        paths.push(dataPropInfo.name);
                        results.push(tslib_1.__spread(paths));
                    }
                    paths.length = 0;
                }
            });
        }
        else {
            if (paths.length > 0) {
                paths.push(dataTypeInfo.entityInfo.nodeCode);
                results.push(tslib_1.__spread(paths));
            }
            paths.length = 0;
        }
    };
    /**
     * 获取指定绑定路径的当前行数据
     * @param paths 绑定路径
     * @param bindingData
     * @returns
     */
    ExpressionUtil.getCurrentRowByPaths = function (paths, bindingData) {
        var result = null;
        var bindingList = bindingData.getValue(paths);
        if (bindingList && bindingList.length > 0) {
            var primaryValue = bindingList.currentItem.primaryKeyValue || null;
            // 使用事件中的主键
            // 主表或下级表新增，此时事件行就是当前行，无需处理
            if (primaryValue) {
                var bindingObject = bindingList.findById(primaryValue);
                if (bindingObject) {
                    result = bindingObject.toJSON();
                }
            }
        }
        return result;
    };
    /**
     * 从实体路径中获取级数最大的从表或从从表
     * @param paths
     * @returns
     */
    ExpressionUtil.getAvailableChildrenPathsFromEntityPaths = function (paths, entityTypeInfo) {
        var nodeCodes = [];
        paths = tslib_1.__spread(paths);
        while (paths.length > 0) {
            var dataPropInfo = entityTypeInfo.getPropInfoByPath(paths);
            if (dataPropInfo && dataPropInfo.group === 'List') {
                nodeCodes = paths;
                break;
            }
            paths.pop();
        }
        return nodeCodes;
    };
    /**
     * 从路径中获取绑定路径
     * @param paths 路径
     * @param entityTypeInfo entityTypeInfo
     * @returns
     */
    ExpressionUtil.getBindingPath = function (paths, entityTypeInfo) {
        paths = this.getEntityPath(paths);
        var entityPaths = this.getAvailableChildrenPathsFromEntityPaths(paths, entityTypeInfo);
        return entityPaths;
    };
    ExpressionUtil.getEntityPath = function (path) {
        var paths = path.filter(function (value, index) {
            if (index % 2 === 0 && value.includes(':')) {
                return false;
            }
            else {
                return true;
            }
        });
        return paths;
    };
    return ExpressionUtil;
}());
export { ExpressionUtil };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl91dGlsLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvdXRpbHMvZXhwcmVzc2lvbl91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFHQSxPQUFPLEVBQUUsYUFBYSxFQUE4QixNQUFNLGVBQWUsQ0FBQztBQUMxRSxPQUFPLEVBQUUsZUFBZSxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRXJFO0lBQUE7SUE0TkEsQ0FBQztJQTNOZSx5Q0FBMEIsR0FBeEMsVUFBeUMsSUFBWSxFQUFFLGNBQTRCO1FBQW5GLGlCQTZFQztRQTVFQyxJQUFNLElBQUksR0FBRyxFQUFFLENBQUM7UUFDaEIsWUFBWTtRQUNaLElBQU0sa0JBQWtCLEdBQUcsSUFBSSxNQUFNLENBQUMsd0JBQXNCLGVBQWUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLDZCQUEwQixFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3RILElBQU0sY0FBYyxHQUFxQixJQUFJLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDeEUsSUFBSSxjQUFjLElBQUksY0FBYyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDL0MseUNBQXlDO1lBQ3pDLElBQU0sZ0JBQWMsR0FBRyxrQkFBa0IsQ0FBQztZQUMxQyxJQUFNLGlCQUFlLEdBQUcsMEJBQTBCLENBQUM7WUFDbkQsY0FBYyxDQUFDLE9BQU8sQ0FBQyxVQUFDLGFBQXFCO2dCQUMzQyxJQUFNLG1CQUFtQixHQUFHLGFBQWEsQ0FBQyxLQUFLLENBQUMsZ0JBQWMsQ0FBQyxDQUFDO2dCQUNoRSxJQUFNLHFCQUFxQixHQUFHLGFBQWEsQ0FBQyxLQUFLLENBQUMsaUJBQWUsQ0FBQyxDQUFDO2dCQUNuRSxJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUM7Z0JBQ3RCLElBQUkscUJBQXFCLElBQUkscUJBQXFCLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRTtvQkFDOUQs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QUFTLENBQUM7SUFDbkIsQ0FBQztJQUNEOzs7OztPQUtHO0lBQ1csNkJBQWMsR0FBNUIsVUFBNkIsS0FBZSxFQUFFLGNBQTRCO1FBQ3hFLEtBQUssR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2xDLElBQU0sV0FBVyxHQUFHLElBQUksQ0FBQyx3Q0FBd0MsQ0FBQyxLQUFLLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFDekYsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztJQUNhLDRCQUFhLEdBQTNCLFVBQTRCLElBQWM7UUFDeEMsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFDLEtBQWEsRUFBRSxLQUFhO1lBQ3JELElBQUksS0FBSyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDMUMsT0FBTyxLQUFLLENBQUM7YUFDZDtpQkFBTTtnQkFDTCxPQUFPLElBQUksQ0FBQzthQUNiO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFDSCxxQkFBQztBQUFELENBQUMsQUE1TkQsSUE0TkMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSB2YWxpZC1qc2RvYyAqL1xyXG4vKiBlc2xpbnQtZGlzYWJsZSByZXF1aXJlLWpzZG9jICovXHJcbmltcG9ydCB7IEJpbmRpbmdEYXRhLCBCaW5kaW5nTGlzdCB9IGZyb20gJy4uL2JpbmRpbmctZGF0YS9pbmRleCc7XHJcbmltcG9ydCB7IERhdGFQcm9wR3JvdXAsIERhdGFQcm9wSW5mbywgRGF0YVR5cGVJbmZvIH0gZnJvbSAnLi4vY29yZS9pbmRleCc7XHJcbmltcG9ydCB7IEVOVElUWV9URU1QTEFURSwgR1JPVVBfRlVOQ1RJT05TIH0gZnJvbSAnLi4vcmVzb2x2ZXIvaW5kZXgnO1xyXG5cclxuZXhwb3J0IGNsYXNzIEV4cHJlc3Npb25VdGlsIHtcclxuICBwdWJsaWMgc3RhdGljIGdldEdyb3VwRnVuY3Rpb25EZXBlbmRlbmN5KGV4cHI6IHN0cmluZywgZW50aXR5VHlwZUluZm86IERhdGFUeXBlSW5mbyk6IHN0cmluZ1tdIHtcclxuICAgIGNvbnN0IGRlcHMgPSBbXTtcclxuICAgIC8vIOiOt+WPluiBmuWQiOWHveaVsOS+nei1lumhuVxyXG4gICAgY29uc3QgZ3JvdXBGdW5jdGlvblJlZ2V4ID0gbmV3IFJlZ0V4cChgRGVmYXVsdEZ1bmN0aW9uXFxcXC4oJHtHUk9VUF9GVU5DVElPTlMuam9pbignfCcpfSlcXFxccypcXFxcKFteXFxcXHJcXFxcblxcXFwpXSpcXFxcKWAsICdnJyk7XHJcbiAgICBjb25zdCBncm91cEZ1bmN0aW9uczogUmVnRXhwTWF0Y2hBcnJheSA9IGV4cHIubWF0Y2goZ3JvdXBGdW5jdGlvblJlZ2V4KTtcclxuICAgIGlmIChncm91cEZ1bmN0aW9ucyAmJiBncm91cEZ1bmN0aW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIC8vIHRvZG86IOS9v+eUqOato+WImeWMuemFjeaXtuWPr+iDveS8muWboOS4uuWPguaVsOS4reaciemAl+WPt+WvvOiHtOmXrumimO+8jOWQjue7reS9v+eUqGFzdOino+aekFxyXG4gICAgICBjb25zdCBhcmd1bWVudHNSZWdleCA9IC9cXCgoW15cXHJcXG5cXCldKilcXCkvO1xyXG4gICAgICBjb25zdCBtZXRob2ROYW1lUmVnZXggPSAvRGVmYXVsdEZ1bmN0aW9uXFwuKFxcUyopXFwoLztcclxuICAgICAgZ3JvdXBGdW5jdGlvbnMuZm9yRWFjaCgoZ3JvdXBGdW5jdGlvbjogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgY29uc3QgYXJndW1lbnRNYXRjaFJlc3VsdCA9IGdyb3VwRnVuY3Rpb24ubWF0Y2goYXJndW1lbnRzUmVnZXgpO1xyXG4gICAgICAgIGNvbnN0IG1ldGhvZE5hbWVNYXRjaFJlc3VsdCA9IGdyb3VwRnVuY3Rpb24ubWF0Y2gobWV0aG9kTmFtZVJlZ2V4KTtcclxuICAgICAgICBsZXQgbWV0aG9kTmFtZSA9IG51bGw7XHJcbiAgICAgICAgaWYgKG1ldGhvZE5hbWVNYXRjaFJlc3VsdCAmJiBtZXRob2ROYW1lTWF0Y2hSZXN1bHQubGVuZ3RoID09IDIpIHtcclxuICAgICAgICAgIG1ldGhvZE5hbWUgPSBtZXRob2ROYW1lTWF0Y2hSZXN1bHRbMV07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChhcmd1bWVudE1hdGNoUmVzdWx0Lmxlbmd0aCA9PT0gMikge1xyXG4gICAgICAgICAgY29uc3QgYXJndW1lbnQgPSBhcmd1bWVudE1hdGNoUmVzdWx0WzFdO1xyXG4gICAgICAgICAgY29uc3QgYXJncyA9IGFyZ3VtZW50LnNwbGl0KCcsJykubWFwKChwKSA9PiBwLnJlcGxhY2UoL1xcXCIvZywgJycpKTtcclxuICAgICAgICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID09PSAyKSB7XHJcbiAgICAgICAgICAgIGxldCBpdGVtOiBhbnkgPSBhcmdzLmpvaW4oJy4nKTtcclxuICAgICAgICAgICAgaXRlbSA9IHRoaXMuY29udmVydFRvTm9kZUNvZGUoaXRlbSwgZW50aXR5VHlwZUluZm8pLmpvaW4oJy4nKTtcclxuICAgICAgICAgICAgLy8g56e76Zmk5Li76KGoY29kZVxyXG4gICAgICAgICAgICBpdGVtID0gaXRlbS5zdWJzdHIoaXRlbS5pbmRleE9mKCcuJykgKyAxKTtcclxuICAgICAgICAgICAgY29uc3QgZGVwID0gaXRlbS5zcGxpdCgnLicpO1xyXG4gICAgICAgICAgICBkZXAuc3BsaWNlKDAsIDAsIEVOVElUWV9URU1QTEFURSk7XHJcbiAgICAgICAgICAgIGRlcHMucHVzaChkZXAuam9pbignLycpKTtcclxuICAgICAgICAgIH0gZWxzZSBpZiAoYXJncyAmJiBhcmdzLmxlbmd0aCA9PT0gMykge1xyXG4gICAgICAgICAgICBpZiAobWV0aG9kTmFtZSA9PT0gJ011bHRpcGx5Q2hpbGROdW1iZXInKSB7XHJcbiAgICAgICAgICAgICAgLy8gc3VwcG9ydCBNdWx0aXBseUNoaWxkTnVtYmVyXHJcbiAgICAgICAgICAgICAgLy8gW0VudGl0eS5jaGlsZHJlbnMscHJvcDEscHJvcDJdXHJcbiAgICAgICAgICAgICAgY29uc3QgcHJlZml4ID0gYXJnc1swXTsgLy8gbGlrZSBFbnRpdHkuY2hpbGRyZW5zXHJcbiAgICAgICAgICAgICAgLy8gY29uc3QgdGFibGVOYW1lID0gYXJnc1swXTsvLyBwcmVmaXguc3Vic3RyaW5nKHByZWZpeC5pbmRleE9mKCcuJykrMSk7XHJcbiAgICAgICAgICAgICAgY29uc3QgcHJvcDFGdWxsUGF0aCA9IGAke3ByZWZpeH0uJHthcmdzWzFdfWA7XHJcbiAgICAgICAgICAgICAgY29uc3QgcHJvcDJGdWxsUGF0aCA9IGAke3ByZWZpeH0uJHthcmdzWzJdfWA7XHJcbiAgICAgICAgICAgICAgW3Byb3AxRnVsbFBhdGgsIHByb3AyRnVsbFBhdGhdLmZvckVhY2goKGl0ZW0pID0+IHtcclxuICAgICAgICAgICAgICAgIGl0ZW0gPSB0aGlzLmNvbnZlcnRUb05vZGVDb2RlKGl0ZW0sIGVudGl0eVR5cGVJbmZvKS5qb2luKCcuJyk7XHJcbiAgICAgICAgICAgICAgICBpdGVtID0gaXRlbS5zdWJzdHIoaXRlbS5pbmRleE9mKCcuJykgKyAxKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRlcCA9IGl0ZW0uc3BsaXQoJy4nKTtcclxuICAgICAgICAgICAgICAgIGRlcC5zcGxpY2UoMCwgMCwgRU5USVRZX1RFTVBMQVRFKTtcclxuICAgICAgICAgICAgICAgIGRlcHMucHVzaChkZXAuam9pbignLycpKTtcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChtZXRob2ROYW1lID09PSAnSXNDb250YWluTWF0Y2gnIHx8IG1ldGhvZE5hbWUgPT09ICdTb3J0Q2hpbGREYXRhJykge1xyXG4gICAgICAgICAgICAgIC8vIFtFbnRpdHkuY2hpbGRyZW5zLHByb3AxLHByb3AyXVxyXG4gICAgICAgICAgICAgIGNvbnN0IHByZWZpeCA9IGFyZ3NbMF07IC8vIGxpa2UgRW50aXR5LmNoaWxkcmVuc1xyXG4gICAgICAgICAgICAgIC8vIGNvbnN0IHRhYmxlTmFtZSA9IGFyZ3NbMF07Ly8gcHJlZml4LnN1YnN0cmluZyhwcmVmaXguaW5kZXhPZignLicpKzEpO1xyXG4gICAgICAgICAgICAgIGxldCBpdGVtID0gYCR7cHJlZml4fS4ke2FyZ3NbMV19YDtcclxuICAgICAgICAgICAgICBpdGVtID0gdGhpcy5jb252ZXJ0VG9Ob2RlQ29kZShpdGVtLCBlbnRpdHlUeXBlSW5mbykuam9pbignLicpO1xyXG4gICAgICAgICAgICAgIGl0ZW0gPSBpdGVtLnN1YnN0cihpdGVtLmluZGV4T2YoJy4nKSArIDEpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGRlcCA9IGl0ZW0uc3BsaXQoJy4nKTtcclxuICAgICAgICAgICAgICBkZXAuc3BsaWNlKDAsIDAsIEVOVElUWV9URU1QTEFURSk7XHJcbiAgICAgICAgICAgICAgZGVwcy5wdXNoKGRlcC5qb2luKCcvJykpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPT09IDQpIHtcclxuXHJcbiAgICAgICAgICB9IGVsc2UgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPT09IDUpIHtcclxuICAgICAgICAgICAgaWYgKFsnTWluVmFsdWVPZlBlcmlvZCcsICdNYXhWYWx1ZU9mUGVyaW9kJywgJ0F2Z1ZhbHVlT2ZQZXJpb2QnXS5pbmNsdWRlcyhtZXRob2ROYW1lKSkge1xyXG4gICAgICAgICAgICAgIC8vIFtFbnRpdHkuY2hpbGRyZW5zLHByb3AxLHByb3AyXVxyXG4gICAgICAgICAgICAgIGNvbnN0IHByZWZpeCA9IGFyZ3NbMF07IC8vIGxpa2UgRW50aXR5LmNoaWxkcmVuc1xyXG4gICAgICAgICAgICAgIC8vIGNvbnN0IHRhYmxlTmFtZSA9IGFyZ3NbMF07Ly8gcHJlZml4LnN1YnN0cmluZyhwcmVmaXguaW5kZXhPZignLicpKzEpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IHByb3AxRnVsbFBhdGggPSBgJHtwcmVmaXh9LiR7YXJnc1sxXX1gO1xyXG4gICAgICAgICAgICAgIGNvbnN0IHByb3AyRnVsbFBhdGggPSBgJHtwcmVmaXh9LiR7YXJnc1syXX1gO1xyXG4gICAgICAgICAgICAgIFtwcm9wMUZ1bGxQYXRoLCBwcm9wMkZ1bGxQYXRoXS5mb3JFYWNoKChpdGVtKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpdGVtID0gdGhpcy5jb252ZXJ0VG9Ob2RlQ29kZShpdGVtLCBlbnRpdHlUeXBlSW5mbykuam9pbignLicpO1xyXG4gICAgICAgICAgICAgICAgaXRlbSA9IGl0ZW0uc3Vic3RyKGl0ZW0uaW5kZXhPZignLicpICsgMSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkZXAgPSBpdGVtLnNwbGl0KCcuJyk7XHJcbiAgICAgICAgICAgICAgICBkZXAuc3BsaWNlKDAsIDAsIEVOVElUWV9URU1QTEFURSk7XHJcbiAgICAgICAgICAgICAgICBkZXBzLnB1c2goZGVwLmpvaW4oJy8nKSk7XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihg5peg5rOV6Kej5p6Q5Y+C5pWw77yaICR7SlNPTi5zdHJpbmdpZnkoYXJndW1lbnQpfWApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZGVwcztcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5bCGdm9Db2Rl6L2s5o2i5Li65YmN56uvbm9kZUNvZGVcclxuICAgKiBAcGFyYW0gZW50aXR5RXhwcmVzc2lvbiBsaWtlIEVudGl0eS5DaGlsZC5wMVxyXG4gICAqIEByZXR1cm5zXHJcbiAgICovXHJcbiAgcHVibGljIHN0YXRpYyBjb252ZXJ0VG9Ob2RlQ29kZShlbnRpdHlFeHByZXNzaW9uOiBzdHJpbmcsIGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8pOiBzdHJpbmdbXSB7XHJcbiAgICAvLyBVc2VyRW50aXR5LnN0b3J5cy5wMVxyXG4gICAgY29uc3Qgbm9kZUNvZGVzID0gW107XHJcbiAgICBpZiAoZW50aXR5VHlwZUluZm8gJiYgZW50aXR5RXhwcmVzc2lvbi5pbmNsdWRlcygnLicpKSB7XHJcbiAgICAgIGNvbnN0IGVudGl0eUV4cHJlc3Npb25zID0gZW50aXR5RXhwcmVzc2lvbi5zcGxpdCgnLicpIHx8IFtdO1xyXG4gICAgICBsZXQgZGF0YVR5cGVJbmZvID0gZW50aXR5VHlwZUluZm87XHJcbiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBlbnRpdHlFeHByZXNzaW9ucy5sZW5ndGg7IGluZGV4KyspIHtcclxuICAgICAgICBjb25zdCBwcm9wID0gZW50aXR5RXhwcmVzc2lvbnNbaW5kZXhdO1xyXG4gICAgICAgIGlmIChkYXRhVHlwZUluZm8gJiYgZGF0YVR5cGVJbmZvLmVudGl0eUluZm8gJiYgZGF0YVR5cGVJbmZvLmVudGl0eUluZm8ubm9kZUNvZGUgPT09IHByb3AgfHwgZGF0YVR5cGVJbmZvLmVudGl0eUluZm8ub3JpZ2luYWxDb2RlID09PSBwcm9wKSB7XHJcbiAgICAgICAgICAvLyDnrKzkuIDkuKrmmK/kuLvooahjb2Rl77yM5LiN6IO96L2sbm9kZUNvZGVcclxuICAgICAgICAgIGlmIChpbmRleCA9PT0gMCkge1xyXG4gICAgICAgICAgICBub2RlQ29kZXMucHVzaChkYXRhVHlwZUluZm8uZW50aXR5SW5mby5vcmlnaW5hbENvZGUpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbm9kZUNvZGVzLnB1c2goZGF0YVR5cGVJbmZvLmVudGl0eUluZm8ubm9kZUNvZGUpO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIC8vIOS4i+S4gOe6p+WPr+iDveS4uuWtkOihqOOAgeWvueixoeaIluWxnuaAp1xyXG4gICAgICAgICAgY29uc3QgbmV4dE5vZGVDb2RlID0gZW50aXR5RXhwcmVzc2lvbnNbaW5kZXggKyAxXTtcclxuICAgICAgICAgIGlmICghbmV4dE5vZGVDb2RlKSB7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgbmV4dE5vZGVDb2RlUHJvcEluZm8gPSBkYXRhVHlwZUluZm8uZ2V0UHJvcEluZm9CeU5hbWUobmV4dE5vZGVDb2RlKTtcclxuICAgICAgICAgIGlmICghbmV4dE5vZGVDb2RlUHJvcEluZm8pIHtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyDkuIvkuIDnuqfkuLrlrZDooajmiJblr7nosaFcclxuICAgICAgICAgIGlmIChuZXh0Tm9kZUNvZGVQcm9wSW5mby50eXBlSW5mbykge1xyXG4gICAgICAgICAgICBkYXRhVHlwZUluZm8gPSBuZXh0Tm9kZUNvZGVQcm9wSW5mby50eXBlSW5mbztcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2UgaWYgKGRhdGFUeXBlSW5mbyAmJiBkYXRhVHlwZUluZm8uZ2V0UHJvcEluZm9CeU5hbWUocHJvcCkpIHtcclxuICAgICAgICAgIGNvbnN0IGRhdGFQcm9wSW5mbyA9IGRhdGFUeXBlSW5mby5nZXRQcm9wSW5mb0J5TmFtZShwcm9wKTtcclxuICAgICAgICAgIG5vZGVDb2Rlcy5wdXNoKGRhdGFQcm9wSW5mby5uYW1lKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8gdGhyb3cgbmV3IEVycm9yKGDplJnor6/nmoTlsZ7mgKflj4LmlbAgJHtlbnRpdHlFeHByZXNzaW9ufWApO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbm9kZUNvZGVzO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmib7liLDlhYPmlbDmja7kuK3miYDmnInlrp7kvZPot6/lvoRcclxuICAgKiBAcGFyYW0gZGF0YVR5cGVJbmZvXHJcbiAgICogQHBhcmFtIHJlc3VsdHNcclxuICAgKiBAcGFyYW0gcGF0aHNcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGljIGdldENoaWxkcmVuRW50aXR5UGF0aHMoZGF0YVR5cGVJbmZvOiBEYXRhVHlwZUluZm8sIHJlc3VsdHM6IGFueVtdLCBwYXRoczogc3RyaW5nW10gPSBbXSkge1xyXG4gICAgY29uc3QgbGlzdDogRGF0YVByb3BJbmZvW10gPSBkYXRhVHlwZUluZm8uZ2V0UHJvcEluZm9zQnlHcm91cChEYXRhUHJvcEdyb3VwLkxpc3QpO1xyXG4gICAgaWYgKGxpc3QgJiYgbGlzdC5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGxpc3QuZm9yRWFjaCgoZGF0YVByb3BJbmZvOiBEYXRhUHJvcEluZm8pID0+IHtcclxuICAgICAgICBpZiAocGF0aHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICByZXN1bHRzLnB1c2goW2RhdGFQcm9wSW5mby5uYW1lXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGNoaWxkcmVuczogRGF0YVByb3BJbmZvW10gPSBkYXRhUHJvcEluZm8udHlwZUluZm8uZ2V0UHJvcEluZm9zQnlHcm91cChEYXRhUHJvcEdyb3VwLkxpc3QpO1xyXG4gICAgICAgIGlmIChjaGlsZHJlbnMgJiYgY2hpbGRyZW5zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIHBhdGhzLnB1c2goZGF0YVByb3BJbmZvLm5hbWUpO1xyXG4gICAgICAgICAgY2hpbGRyZW5zLmZvckVhY2goKGRhdGFQcm9wSW5mbzogRGF0YVByb3BJbmZvKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0Q2hpbGRyZW5FbnRpdHlQYXRocyhkYXRhUHJvcEluZm8udHlwZUluZm8sIHJlc3VsdHMsIHBhdGhzKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBpZiAocGF0aHMubGVuZ3RoICE9PSAwKSB7XHJcbiAgICAgICAgICAgIHBhdGhzLnB1c2goZGF0YVByb3BJbmZvLm5hbWUpO1xyXG4gICAgICAgICAgICByZXN1bHRzLnB1c2goWy4uLnBhdGhzXSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBwYXRocy5sZW5ndGggPSAwO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAocGF0aHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHBhdGhzLnB1c2goZGF0YVR5cGVJbmZvLmVudGl0eUluZm8ubm9kZUNvZGUpO1xyXG4gICAgICAgIHJlc3VsdHMucHVzaChbLi4ucGF0aHNdKTtcclxuICAgICAgfVxyXG4gICAgICBwYXRocy5sZW5ndGggPSAwO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bmjIflrprnu5Hlrprot6/lvoTnmoTlvZPliY3ooYzmlbDmja5cclxuICAgKiBAcGFyYW0gcGF0aHMg57uR5a6a6Lev5b6EXHJcbiAgICogQHBhcmFtIGJpbmRpbmdEYXRhXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGljIGdldEN1cnJlbnRSb3dCeVBhdGhzKHBhdGhzOiBzdHJpbmdbXSwgYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhKTogbnVsbCB8IHsgW3Byb3A6IHN0cmluZ106IGFueSB9IHtcclxuICAgIGxldCByZXN1bHQgPSBudWxsO1xyXG4gICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xyXG4gICAgaWYgKGJpbmRpbmdMaXN0ICYmIGJpbmRpbmdMaXN0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgY29uc3QgcHJpbWFyeVZhbHVlID0gYmluZGluZ0xpc3QuY3VycmVudEl0ZW0ucHJpbWFyeUtleVZhbHVlIHx8IG51bGw7XHJcbiAgICAgIC8vIOS9v+eUqOS6i+S7tuS4reeahOS4u+mUrlxyXG4gICAgICAvLyDkuLvooajmiJbkuIvnuqfooajmlrDlop7vvIzmraTml7bkuovku7booYzlsLHmmK/lvZPliY3ooYzvvIzml6DpnIDlpITnkIZcclxuICAgICAgaWYgKHByaW1hcnlWYWx1ZSkge1xyXG4gICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBiaW5kaW5nTGlzdC5maW5kQnlJZChwcmltYXJ5VmFsdWUpO1xyXG4gICAgICAgIGlmIChiaW5kaW5nT2JqZWN0KSB7XHJcbiAgICAgICAgICByZXN1bHQgPSBiaW5kaW5nT2JqZWN0LnRvSlNPTigpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5LuO5a6e5L2T6Lev5b6E5Lit6I635Y+W57qn5pWw5pyA5aSn55qE5LuO6KGo5oiW5LuO5LuO6KGoXHJcbiAgICogQHBhcmFtIHBhdGhzXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGljIGdldEF2YWlsYWJsZUNoaWxkcmVuUGF0aHNGcm9tRW50aXR5UGF0aHMocGF0aHM6IHN0cmluZ1tdLCBlbnRpdHlUeXBlSW5mbzogRGF0YVR5cGVJbmZvKTogc3RyaW5nW10ge1xyXG4gICAgbGV0IG5vZGVDb2RlcyA9IFtdO1xyXG4gICAgcGF0aHMgPSBbLi4ucGF0aHNdO1xyXG4gICAgd2hpbGUgKHBhdGhzLmxlbmd0aCA+IDApIHtcclxuICAgICAgY29uc3QgZGF0YVByb3BJbmZvID0gZW50aXR5VHlwZUluZm8uZ2V0UHJvcEluZm9CeVBhdGgocGF0aHMpO1xyXG4gICAgICBpZiAoZGF0YVByb3BJbmZvICYmIGRhdGFQcm9wSW5mby5ncm91cCA9PT0gJ0xpc3QnKSB7XHJcbiAgICAgICAgbm9kZUNvZGVzID0gcGF0aHM7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgICAgcGF0aHMucG9wKCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbm9kZUNvZGVzO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDku47ot6/lvoTkuK3ojrflj5bnu5Hlrprot6/lvoRcclxuICAgKiBAcGFyYW0gcGF0aHMg6Lev5b6EXHJcbiAgICogQHBhcmFtIGVudGl0eVR5cGVJbmZvIGVudGl0eVR5cGVJbmZvXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGljIGdldEJpbmRpbmdQYXRoKHBhdGhzOiBzdHJpbmdbXSwgZW50aXR5VHlwZUluZm86IERhdGFUeXBlSW5mbykge1xyXG4gICAgcGF0aHMgPSB0aGlzLmdldEVudGl0eVBhdGgocGF0aHMpO1xyXG4gICAgY29uc3QgZW50aXR5UGF0aHMgPSB0aGlzLmdldEF2YWlsYWJsZUNoaWxkcmVuUGF0aHNGcm9tRW50aXR5UGF0aHMocGF0aHMsIGVudGl0eVR5cGVJbmZvKTtcclxuICAgIHJldHVybiBlbnRpdHlQYXRocztcclxuICB9XHJcbiAgcHVibGljIHN0YXRpYyBnZXRFbnRpdHlQYXRoKHBhdGg6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3QgcGF0aHMgPSBwYXRoLmZpbHRlcigodmFsdWU6IHN0cmluZywgaW5kZXg6IG51bWJlcikgPT4ge1xyXG4gICAgICBpZiAoaW5kZXggJSAyID09PSAwICYmIHZhbHVlLmluY2x1ZGVzKCc6JykpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHBhdGhzO1xyXG4gIH1cclxufVxyXG4iXX0=