import * as tslib_1 from "tslib";
import { ReflectiveInjector } from '@angular/core';
import { isObservable, of, Subject } from 'rxjs';
import { CommandHandler } from './command_handler';
/**
 * @Injectable()
 * @NgCommandHandler({
 *     commandName: 'add1'
 * })
 * export class add1Handler extends CommandHandler {
 *     constructor(
 *         public _ListDataService1: ListDataService1,
 *         public _StateMachineService1: StateMachineService1
 *     ) {
 *         super();
 *     }
 *
 *     schedule() {
 *         this.addTask('append', (context: CommandContext) => {
 *             const args = [];
 *             return this.invoke(this._ListDataService1, 'append', args, context);
 *         });
 *
 *         this.addTask('transit', (context: CommandContext) => {
 *             const args = [
 *                 'Create'
 *                     ];
 *             return this.invoke(this._StateMachineService1, 'transit', args, context);
 *         });
 *
 *         this.addLink('append', 'transit', `1==1`);
 *     }
 * }
 */
var controllerMap = {
    imports: {}
};
var DynamicCommandHandler = /** @class */ (function (_super) {
    tslib_1.__extends(DynamicCommandHandler, _super);
    function DynamicCommandHandler(commandName, method) {
        var _this = _super.call(this) || this;
        _this.commandName = commandName;
        _this.method = method;
        return _this;
    }
    DynamicCommandHandler.prototype.dynamicInvoke = function (serviceTocken, method, args, context) {
        var serviceInstance = context.frameContext.injector.get(serviceTocken, null);
        if (serviceInstance) {
            this.setContextToServiceInstance(serviceInstance, context);
            var parsedStageParams = this.parseService.parse(args, context);
            var parsedArgs = parsedStageParams.map(function (param) { return param.expression; });
            // tslint:disable-next-line: ban-types
            var serviceMethod = serviceInstance[method];
            return serviceMethod.apply(serviceInstance, parsedArgs);
        }
    };
    DynamicCommandHandler.prototype.dynamicInvoke2 = function (methodObject, context) {
        var _this = this;
        var serviceUri = methodObject.source, serviceName = methodObject.service, method = methodObject.method;
        var args = methodObject.params.map(function (stageParam) {
            return Object.assign({}, stageParam);
        });
        var result$ = new Subject();
        var serviceSpecifer = serviceUri && serviceUri.toLowerCase();
        if (serviceSpecifer) {
            var serviceModule_1 = controllerMap.imports[serviceSpecifer];
            if (serviceModule_1) {
                // 表示缓存中存在
                setTimeout(function () {
                    _this.executeWithServiceModule(serviceModule_1, serviceName, context, args, method, result$);
                }, 0);
            }
            else {
                //  表示不存在
                System.import(serviceSpecifer)
                    .then(function (serviceModule) {
                    if (serviceModule) {
                        controllerMap.imports[serviceSpecifer] = serviceModule;
                    }
                    _this.executeWithServiceModule(serviceModule, serviceName, context, args, method, result$);
                });
            }
        }
        return result$;
    };
    DynamicCommandHandler.prototype.executeWithServiceModule = function (serviceModule, serviceName, context, args, method, result$) {
        var serviceConstructor = serviceModule[serviceName];
        if (serviceConstructor) {
            var originalContextInjector_1 = context.frameContext.injector;
            var serviceInstance = void 0;
            // const resolvedReflectiveProviders = ReflectiveInjector.resolve([{ provide: serviceName, useClass: serviceConstructor }]);
            if (context.frameContext.injector.get(serviceName, null)) {
                serviceInstance = context.frameContext.injector.get(serviceName);
            }
            else {
                var resolvedReflectiveProviders = this.loadProvidersFromModule(serviceModule);
                var reflectiveInjector = ReflectiveInjector.fromResolvedProviders(resolvedReflectiveProviders, context.frameContext.injector);
                context.frameContext.injector = reflectiveInjector;
                serviceInstance = reflectiveInjector.get(serviceName, null);
            }
            if (serviceInstance) {
                this.setContextToServiceInstance(serviceInstance, context);
                var parsedStageParams = this.parseService.parse(args, context);
                var parsedArgs = parsedStageParams.map(function (param) { return param.expression; });
                // tslint:disable-next-line: ban-types
                var serviceMethod = serviceInstance[method];
                if (!serviceMethod) {
                    console.error("未找到对应的命令:" + method);
                    return;
                }
                var serviceMethodResult = serviceMethod.apply(serviceInstance, parsedArgs);
                var result$$ = isObservable(serviceMethodResult) ? serviceMethodResult : of(serviceMethodResult);
                result$$.subscribe({
                    next: function (result) {
                        result$.next(result);
                    },
                    error: function (error) {
                        result$.error(error);
                    },
                    complete: function () {
                        result$.complete();
                        context.frameContext.injector = originalContextInjector_1;
                    },
                });
                // return serviceMethod.apply(serviceInstance, parsedArgs);
            }
        }
    };
    DynamicCommandHandler.prototype.schedule = function () {
        this.scheduleStages(this.method.stages, null);
        // this.method.stages.reduce((preStage: MethodStage, currentStage: MethodStage) => {
        //   if (currentStage.type === '0') {
        //     this.addTask(currentStage.name, (context: CommandContext) => {
        //       return this.dynamicInvoke2(currentStage as ExecutingStage, context);
        //     });
        //     if (preStage) {
        //       this.addLink(preStage.name, currentStage.name, `1===1`);
        //     }
        //   } else if (currentStage.type === '2') {
        //   } else {
        //     throw new Error(`unknow method stage type, the ${currentStage.name}'s type is ${currentStage.type}`);
        //   }
        //   return currentStage;
        // }, null);
    };
    DynamicCommandHandler.prototype.scheduleStages = function (stages, initialStage) {
        var _this = this;
        stages.reduce(function (preStage, currentStage) {
            if (currentStage.type === 'executing') {
                _this.addTask(currentStage.name, function (context) {
                    return _this.dynamicInvoke2(currentStage, context);
                });
            }
            else if (currentStage.type === 'fork') {
                var forkStages = currentStage.stages;
                forkStages.forEach(function (forkStage) {
                    _this.scheduleStages(forkStage.stages, forkStage);
                });
                _this.scheduleStages(currentStage.stages, currentStage);
            }
            else if (currentStage.type === 'determing') {
                _this.addTask(currentStage.name, function (context) {
                    return of(true);
                });
            }
            else {
                throw new Error("unknow method stage type, the " + currentStage.name + "'s type is " + currentStage.type);
            }
            if (preStage) {
                var condition = preStage.type === 'determing' ? preStage.condition : "1===1";
                _this.addLink(preStage.name, currentStage.name, condition);
            }
            return currentStage;
        }, initialStage);
    };
    DynamicCommandHandler.prototype.loadProvidersFromModule = function (serviceModule) {
        var providerArray = [];
        for (var propertyName in serviceModule) {
            if (Object.prototype.hasOwnProperty.call(serviceModule, propertyName)) {
                var propertyValue = serviceModule[propertyName];
                if (this.isInjectableService(propertyValue)) {
                    // const providerName = propertyValue.name === 'e' ? propertyName : propertyValue.name;
                    var providerName = propertyName;
                    providerArray.push({ provide: providerName, useClass: propertyValue });
                    providerArray.push(propertyValue);
                }
            }
        }
        var resolvedReflectiveProviders = ReflectiveInjector.resolve(providerArray);
        return resolvedReflectiveProviders;
    };
    DynamicCommandHandler.prototype.isInjectableService = function (propertyValue) {
        var hasInjectableDecorator = false;
        var isFunction = propertyValue instanceof Function;
        if (isFunction && propertyValue.hasOwnProperty('decorators')) {
            var decorators = propertyValue.decorators;
            var injectableDecorators = decorators.filter(function (decorator) {
                if (decorator.type && decorator.type.prototype && decorator.type.prototype.ngMetadataName === 'Injectable') {
                    return decorator;
                }
            });
            hasInjectableDecorator = injectableDecorators && injectableDecorators.length > 0;
        }
        else if (isFunction && propertyValue.hasOwnProperty('__annotations__')) {
            var decorators = propertyValue.__annotations__;
            var injectableDecorators = decorators.filter(function (decoratorFactory) {
                if (decoratorFactory && decoratorFactory.ngMetadataName && decoratorFactory.ngMetadataName === 'Injectable') {
                    return decoratorFactory;
                }
            });
            hasInjectableDecorator = injectableDecorators && injectableDecorators.length > 0;
        }
        return hasInjectableDecorator;
    };
    return DynamicCommandHandler;
}(CommandHandler));
export { DynamicCommandHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pY19jb21tYW5kX2hhbmRsZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kL2R5bmFtaWNfY29tbWFuZF9oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLFlBQVksRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRWpELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQU1uRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0E2Qkc7QUFFSCxJQUFNLGFBQWEsR0FBRztJQUNwQixPQUFPLEVBQUUsRUFFUjtDQUNGLENBQUM7QUFJRjtJQUEyQyxpREFBYztJQUV2RCwrQkFBbUIsV0FBbUIsRUFBVSxNQUF3QjtRQUF4RSxZQUNFLGlCQUFPLFNBQ1I7UUFGa0IsaUJBQVcsR0FBWCxXQUFXLENBQVE7UUFBVSxZQUFNLEdBQU4sTUFBTSxDQUFrQjs7SUFFeEUsQ0FBQztJQUVNLDZDQUFhLEdBQXBCLFVBQXFCLGFBQXFCLEVBQUUsTUFBYyxFQUFFLElBQWtCLEVBQUUsT0FBdUI7UUFDckcsSUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUMvRSxJQUFJLGVBQWUsRUFBRTtZQUNuQixJQUFJLENBQUMsMkJBQTJCLENBQUMsZUFBZSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQzNELElBQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBaUIsQ0FBQztZQUNqRixJQUFNLFVBQVUsR0FBRyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsVUFBQSxLQUFLLElBQUksT0FBQSxLQUFL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Q0FBQyxDQUFDO1NBQ2xGO1FBQ0QsT0FBTyxzQkFBc0IsQ0FBQztJQUNoQyxDQUFDO0lBQ0gsNEJBQUM7QUFBRCxDQUFDLEFBL0tELENBQTJDLGNBQWMsR0ErS3hEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVmbGVjdGl2ZUluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IGlzT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgQ29tbWFuZENvbnRleHQgfSBmcm9tICcuL2NvbW1hbmRfY29udGV4dCc7XHJcbmltcG9ydCB7IENvbW1hbmRIYW5kbGVyIH0gZnJvbSAnLi9jb21tYW5kX2hhbmRsZXInO1xyXG5pbXBvcnQge1xyXG4gIENvbnRyb2xsZXJNZXRob2QsIERldGVybWluaW5nU3RhZ2UsIEV4ZWN1dGluZ1N0YWdlLFxyXG4gIEZvcmtTdGFnZSwgTWV0aG9kU3RhZ2UsIFN0YWdlUGFyYW1cclxufSBmcm9tICcuL2R5bmFtaWNfY29tbWFuZF9oYW5kbGVyX21ldGFkYXRhJztcclxuXHJcbi8qKlxyXG4gKiBASW5qZWN0YWJsZSgpXHJcbiAqIEBOZ0NvbW1hbmRIYW5kbGVyKHtcclxuICogICAgIGNvbW1hbmROYW1lOiAnYWRkMSdcclxuICogfSlcclxuICogZXhwb3J0IGNsYXNzIGFkZDFIYW5kbGVyIGV4dGVuZHMgQ29tbWFuZEhhbmRsZXIge1xyXG4gKiAgICAgY29uc3RydWN0b3IoXHJcbiAqICAgICAgICAgcHVibGljIF9MaXN0RGF0YVNlcnZpY2UxOiBMaXN0RGF0YVNlcnZpY2UxLFxyXG4gKiAgICAgICAgIHB1YmxpYyBfU3RhdGVNYWNoaW5lU2VydmljZTE6IFN0YXRlTWFjaGluZVNlcnZpY2UxXHJcbiAqICAgICApIHtcclxuICogICAgICAgICBzdXBlcigpO1xyXG4gKiAgICAgfVxyXG4gKlxyXG4gKiAgICAgc2NoZWR1bGUoKSB7XHJcbiAqICAgICAgICAgdGhpcy5hZGRUYXNrKCdhcHBlbmQnLCAoY29udGV4dDogQ29tbWFuZENvbnRleHQpID0+IHtcclxuICogICAgICAgICAgICAgY29uc3QgYXJncyA9IFtdO1xyXG4gKiAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbnZva2UodGhpcy5fTGlzdERhdGFTZXJ2aWNlMSwgJ2FwcGVuZCcsIGFyZ3MsIGNvbnRleHQpO1xyXG4gKiAgICAgICAgIH0pO1xyXG4gKlxyXG4gKiAgICAgICAgIHRoaXMuYWRkVGFzaygndHJhbnNpdCcsIChjb250ZXh0OiBDb21tYW5kQ29udGV4dCkgPT4ge1xyXG4gKiAgICAgICAgICAgICBjb25zdCBhcmdzID0gW1xyXG4gKiAgICAgICAgICAgICAgICAgJ0NyZWF0ZSdcclxuICogICAgICAgICAgICAgICAgICAgICBdO1xyXG4gKiAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbnZva2UodGhpcy5fU3RhdGVNYWNoaW5lU2VydmljZTEsICd0cmFuc2l0JywgYXJncywgY29udGV4dCk7XHJcbiAqICAgICAgICAgfSk7XHJcbiAqXHJcbiAqICAgICAgICAgdGhpcy5hZGRMaW5rKCdhcHBlbmQnLCAndHJhbnNpdCcsIGAxPT0xYCk7XHJcbiAqICAgICB9XHJcbiAqIH1cclxuICovXHJcblxyXG5jb25zdCBjb250cm9sbGVyTWFwID0ge1xyXG4gIGltcG9ydHM6IHtcclxuXHJcbiAgfVxyXG59O1xyXG5cclxuZGVjbGFyZSBjb25zdCBTeXN0ZW06IGFueTtcclxuXHJcbmV4cG9ydCBjbGFzcyBEeW5hbWljQ29tbWFuZEhhbmRsZXIgZXh0ZW5kcyBDb21tYW5kSGFuZGxlciB7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBjb21tYW5kTmFtZTogc3RyaW5nLCBwcml2YXRlIG1ldGhvZDogQ29udHJvbGxlck1ldGhvZCkge1xyXG4gICAgc3VwZXIoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBkeW5hbWljSW52b2tlKHNlcnZpY2VUb2NrZW46IHN0cmluZywgbWV0aG9kOiBzdHJpbmcsIGFyZ3M6IFN0YWdlUGFyYW1bXSwgY29udGV4dDogQ29tbWFuZENvbnRleHQpIHtcclxuICAgIGNvbnN0IHNlcnZpY2VJbnN0YW5jZSA9IGNvbnRleHQuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldChzZXJ2aWNlVG9ja2VuLCBudWxsKTtcclxuICAgIGlmIChzZXJ2aWNlSW5zdGFuY2UpIHtcclxuICAgICAgdGhpcy5zZXRDb250ZXh0VG9TZXJ2aWNlSW5zdGFuY2Uoc2VydmljZUluc3RhbmNlLCBjb250ZXh0KTtcclxuICAgICAgY29uc3QgcGFyc2VkU3RhZ2VQYXJhbXMgPSB0aGlzLnBhcnNlU2VydmljZS5wYXJzZShhcmdzLCBjb250ZXh0KSBhcyBTdGFnZVBhcmFtW107XHJcbiAgICAgIGNvbnN0IHBhcnNlZEFyZ3MgPSBwYXJzZWRTdGFnZVBhcmFtcy5tYXAocGFyYW0gPT4gcGFyYW0uZXhwcmVzc2lvbik7XHJcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogYmFuLXR5cGVzXHJcbiAgICAgIGNvbnN0IHNlcnZpY2VNZXRob2QgPSBzZXJ2aWNlSW5zdGFuY2VbbWV0aG9kXSBhcyBGdW5jdGlvbjtcclxuICAgICAgcmV0dXJuIHNlcnZpY2VNZXRob2QuYXBwbHkoc2VydmljZUluc3RhbmNlLCBwYXJzZWRBcmdzKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBkeW5hbWljSW52b2tlMihtZXRob2RPYmplY3Q6IEV4ZWN1dGluZ1N0YWdlLCBjb250ZXh0OiBDb21tYW5kQ29udGV4dCkge1xyXG4gICAgY29uc3QgeyBzb3VyY2U6IHNlcnZpY2VVcmksIHNlcnZpY2U6IHNlcnZpY2VOYW1lLCBtZXRob2QgfSA9IG1ldGhvZE9iamVjdDtcclxuICAgIGNvbnN0IGFyZ3MgPSBtZXRob2RPYmplY3QucGFyYW1zLm1hcChzdGFnZVBhcmFtID0+IHtcclxuICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHN0YWdlUGFyYW0pO1xyXG4gICAgfSk7XHJcbiAgICBjb25zdCByZXN1bHQkID0gbmV3IFN1YmplY3QoKTtcclxuICAgIGNvbnN0IHNlcnZpY2VTcGVjaWZlciA9IHNlcnZpY2VVcmkgJiYgc2VydmljZVVyaS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgaWYgKHNlcnZpY2VTcGVjaWZlcikge1xyXG4gICAgICBsZXQgc2VydmljZU1vZHVsZSA9IGNvbnRyb2xsZXJNYXAuaW1wb3J0c1tzZXJ2aWNlU3BlY2lmZXJdO1xyXG4gICAgICBpZiAoc2VydmljZU1vZHVsZSkge1xyXG4gICAgICAgIC8vIOihqOekuue8k+WtmOS4reWtmOWcqFxyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5leGVjdXRlV2l0aFNlcnZpY2VNb2R1bGUoc2VydmljZU1vZHVsZSwgc2VydmljZU5hbWUsIGNvbnRleHQsIGFyZ3MsIG1ldGhvZCwgcmVzdWx0JCk7XHJcbiAgICAgICAgfSwgMCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gIOihqOekuuS4jeWtmOWcqFxyXG4gICAgICAgIFN5c3RlbS5pbXBvcnQoc2VydmljZVNwZWNpZmVyKVxyXG4gICAgICAgICAgLnRoZW4oKHNlcnZpY2VNb2R1bGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoc2VydmljZU1vZHVsZSkge1xyXG4gICAgICAgICAgICAgIGNvbnRyb2xsZXJNYXAuaW1wb3J0c1tzZXJ2aWNlU3BlY2lmZXJdID0gc2VydmljZU1vZHVsZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmV4ZWN1dGVXaXRoU2VydmljZU1vZHVsZShzZXJ2aWNlTW9kdWxlLCBzZXJ2aWNlTmFtZSwgY29udGV4dCwgYXJncywgbWV0aG9kLCByZXN1bHQkKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0JDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZXhlY3V0ZVdpdGhTZXJ2aWNlTW9kdWxlKHNlcnZpY2VNb2R1bGU6IGFueSwgc2VydmljZU5hbWU6IHN0cmluZywgY29udGV4dDogQ29tbWFuZENvbnRleHQsIGFyZ3M6IFN0YWdlUGFyYW1bXSwgbWV0aG9kOiBzdHJpbmcsIHJlc3VsdCQ6IFN1YmplY3Q8dW5rbm93bj4pIHtcclxuICAgIGNvbnN0IHNlcnZpY2VDb25zdHJ1Y3RvciA9IHNlcnZpY2VNb2R1bGVbc2VydmljZU5hbWVdO1xyXG4gICAgaWYgKHNlcnZpY2VDb25zdHJ1Y3Rvcikge1xyXG4gICAgICBjb25zdCBvcmlnaW5hbENvbnRleHRJbmplY3RvciA9IGNvbnRleHQuZnJhbWVDb250ZXh0LmluamVjdG9yO1xyXG4gICAgICBsZXQgc2VydmljZUluc3RhbmNlO1xyXG4gICAgICAvLyBjb25zdCByZXNvbHZlZFJlZmxlY3RpdmVQcm92aWRlcnMgPSBSZWZsZWN0aXZlSW5qZWN0b3IucmVzb2x2ZShbeyBwcm92aWRlOiBzZXJ2aWNlTmFtZSwgdXNlQ2xhc3M6IHNlcnZpY2VDb25zdHJ1Y3RvciB9XSk7XHJcbiAgICAgIGlmIChjb250ZXh0LmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQoc2VydmljZU5hbWUsIG51bGwpKSB7XHJcbiAgICAgICAgc2VydmljZUluc3RhbmNlID0gY29udGV4dC5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0KHNlcnZpY2VOYW1lKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCByZXNvbHZlZFJlZmxlY3RpdmVQcm92aWRlcnMgPSB0aGlzLmxvYWRQcm92aWRlcnNGcm9tTW9kdWxlKHNlcnZpY2VNb2R1bGUpO1xyXG4gICAgICAgIGNvbnN0IHJlZmxlY3RpdmVJbmplY3RvciA9IFJlZmxlY3RpdmVJbmplY3Rvci5mcm9tUmVzb2x2ZWRQcm92aWRlcnMocmVzb2x2ZWRSZWZsZWN0aXZlUHJvdmlkZXJzLCBjb250ZXh0LmZyYW1lQ29udGV4dC5pbmplY3Rvcik7XHJcbiAgICAgICAgY29udGV4dC5mcmFtZUNvbnRleHQuaW5qZWN0b3IgPSByZWZsZWN0aXZlSW5qZWN0b3I7XHJcbiAgICAgICAgc2VydmljZUluc3RhbmNlID0gcmVmbGVjdGl2ZUluamVjdG9yLmdldChzZXJ2aWNlTmFtZSwgbnVsbCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChzZXJ2aWNlSW5zdGFuY2UpIHtcclxuICAgICAgICB0aGlzLnNldENvbnRleHRUb1NlcnZpY2VJbnN0YW5jZShzZXJ2aWNlSW5zdGFuY2UsIGNvbnRleHQpO1xyXG4gICAgICAgIGNvbnN0IHBhcnNlZFN0YWdlUGFyYW1zID0gdGhpcy5wYXJzZVNlcnZpY2UucGFyc2UoYXJncywgY29udGV4dCkgYXMgU3RhZ2VQYXJhbVtdO1xyXG4gICAgICAgIGNvbnN0IHBhcnNlZEFyZ3MgPSBwYXJzZWRTdGFnZVBhcmFtcy5tYXAocGFyYW0gPT4gcGFyYW0uZXhwcmVzc2lvbik7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBiYW4tdHlwZXNcclxuICAgICAgICBjb25zdCBzZXJ2aWNlTWV0aG9kID0gc2VydmljZUluc3RhbmNlW21ldGhvZF0gYXMgRnVuY3Rpb247XHJcbiAgICAgICAgaWYgKCFzZXJ2aWNlTWV0aG9kKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmVycm9yKFwi5pyq5om+5Yiw5a+55bqU55qE5ZG95LukOlwiICsgbWV0aG9kKTtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3Qgc2VydmljZU1ldGhvZFJlc3VsdCA9IHNlcnZpY2VNZXRob2QuYXBwbHkoc2VydmljZUluc3RhbmNlLCBwYXJzZWRBcmdzKTtcclxuICAgICAgICBjb25zdCByZXN1bHQkJCA9IGlzT2JzZXJ2YWJsZShzZXJ2aWNlTWV0aG9kUmVzdWx0KSA/IHNlcnZpY2VNZXRob2RSZXN1bHQgOiBvZihzZXJ2aWNlTWV0aG9kUmVzdWx0KTtcclxuICAgICAgICByZXN1bHQkJC5zdWJzY3JpYmUoe1xyXG4gICAgICAgICAgbmV4dDogKHJlc3VsdDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIHJlc3VsdCQubmV4dChyZXN1bHQpO1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIGVycm9yOiAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICByZXN1bHQkLmVycm9yKGVycm9yKTtcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBjb21wbGV0ZTogKCkgPT4ge1xyXG4gICAgICAgICAgICByZXN1bHQkLmNvbXBsZXRlKCk7XHJcbiAgICAgICAgICAgIGNvbnRleHQuZnJhbWVDb250ZXh0LmluamVjdG9yID0gb3JpZ2luYWxDb250ZXh0SW5qZWN0b3I7XHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIHJldHVybiBzZXJ2aWNlTWV0aG9kLmFwcGx5KHNlcnZpY2VJbnN0YW5jZSwgcGFyc2VkQXJncyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNjaGVkdWxlKCkge1xyXG4gICAgdGhpcy5zY2hlZHVsZVN0YWdlcyh0aGlzLm1ldGhvZC5zdGFnZXMsIG51bGwpO1xyXG4gICAgLy8gdGhpcy5tZXRob2Quc3RhZ2VzLnJlZHVjZSgocHJlU3RhZ2U6IE1ldGhvZFN0YWdlLCBjdXJyZW50U3RhZ2U6IE1ldGhvZFN0YWdlKSA9PiB7XHJcbiAgICAvLyAgIGlmIChjdXJyZW50U3RhZ2UudHlwZSA9PT0gJzAnKSB7XHJcbiAgICAvLyAgICAgdGhpcy5hZGRUYXNrKGN1cnJlbnRTdGFnZS5uYW1lLCAoY29udGV4dDogQ29tbWFuZENvbnRleHQpID0+IHtcclxuICAgIC8vICAgICAgIHJldHVybiB0aGlzLmR5bmFtaWNJbnZva2UyKGN1cnJlbnRTdGFnZSBhcyBFeGVjdXRpbmdTdGFnZSwgY29udGV4dCk7XHJcbiAgICAvLyAgICAgfSk7XHJcbiAgICAvLyAgICAgaWYgKHByZVN0YWdlKSB7XHJcbiAgICAvLyAgICAgICB0aGlzLmFkZExpbmsocHJlU3RhZ2UubmFtZSwgY3VycmVudFN0YWdlLm5hbWUsIGAxPT09MWApO1xyXG4gICAgLy8gICAgIH1cclxuICAgIC8vICAgfSBlbHNlIGlmIChjdXJyZW50U3RhZ2UudHlwZSA9PT0gJzInKSB7XHJcblxyXG4gICAgLy8gICB9IGVsc2Uge1xyXG4gICAgLy8gICAgIHRocm93IG5ldyBFcnJvcihgdW5rbm93IG1ldGhvZCBzdGFnZSB0eXBlLCB0aGUgJHtjdXJyZW50U3RhZ2UubmFtZX0ncyB0eXBlIGlzICR7Y3VycmVudFN0YWdlLnR5cGV9YCk7XHJcbiAgICAvLyAgIH1cclxuICAgIC8vICAgcmV0dXJuIGN1cnJlbnRTdGFnZTtcclxuICAgIC8vIH0sIG51bGwpO1xyXG4gIH1cclxuXHJcbiAgc2NoZWR1bGVTdGFnZXMoc3RhZ2VzOiBNZXRob2RTdGFnZVtdLCBpbml0aWFsU3RhZ2U6IE1ldGhvZFN0YWdlKSB7XHJcbiAgICBzdGFnZXMucmVkdWNlKChwcmVTdGFnZTogTWV0aG9kU3RhZ2UsIGN1cnJlbnRTdGFnZTogTWV0aG9kU3RhZ2UpID0+IHtcclxuICAgICAgaWYgKGN1cnJlbnRTdGFnZS50eXBlID09PSAnZXhlY3V0aW5nJykge1xyXG4gICAgICAgIHRoaXMuYWRkVGFzayhjdXJyZW50U3RhZ2UubmFtZSwgKGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gdGhpcy5keW5hbWljSW52b2tlMihjdXJyZW50U3RhZ2UgYXMgRXhlY3V0aW5nU3RhZ2UsIGNvbnRleHQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2UgaWYgKGN1cnJlbnRTdGFnZS50eXBlID09PSAnZm9yaycpIHtcclxuICAgICAgICBjb25zdCBmb3JrU3RhZ2VzID0gKGN1cnJlbnRTdGFnZSBhcyBGb3JrU3RhZ2UpLnN0YWdlcztcclxuICAgICAgICBmb3JrU3RhZ2VzLmZvckVhY2goZm9ya1N0YWdlID0+IHtcclxuICAgICAgICAgIHRoaXMuc2NoZWR1bGVTdGFnZXMoZm9ya1N0YWdlLnN0YWdlcywgZm9ya1N0YWdlKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnNjaGVkdWxlU3RhZ2VzKChjdXJyZW50U3RhZ2UgYXMgRGV0ZXJtaW5pbmdTdGFnZSkuc3RhZ2VzLCBjdXJyZW50U3RhZ2UpO1xyXG4gICAgICB9IGVsc2UgaWYgKGN1cnJlbnRTdGFnZS50eXBlID09PSAnZGV0ZXJtaW5nJykge1xyXG4gICAgICAgIHRoaXMuYWRkVGFzayhjdXJyZW50U3RhZ2UubmFtZSwgKGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmtub3cgbWV0aG9kIHN0YWdlIHR5cGUsIHRoZSAke2N1cnJlbnRTdGFnZS5uYW1lfSdzIHR5cGUgaXMgJHtjdXJyZW50U3RhZ2UudHlwZX1gKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAocHJlU3RhZ2UpIHtcclxuICAgICAgICBjb25zdCBjb25kaXRpb24gPSBwcmVTdGFnZS50eXBlID09PSAnZGV0ZXJtaW5nJyA/IChwcmVTdGFnZSBhcyBEZXRlcm1pbmluZ1N0YWdlKS5jb25kaXRpb24gOiBgMT09PTFgO1xyXG4gICAgICAgIHRoaXMuYWRkTGluayhwcmVTdGFnZS5uYW1lLCBjdXJyZW50U3RhZ2UubmFtZSwgY29uZGl0aW9uKTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gY3VycmVudFN0YWdlO1xyXG4gICAgfSwgaW5pdGlhbFN0YWdlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgbG9hZFByb3ZpZGVyc0Zyb21Nb2R1bGUoc2VydmljZU1vZHVsZTogeyBbcHJvcGVydHlOYW1lOiBzdHJpbmddOiBhbnkgfSkge1xyXG4gICAgY29uc3QgcHJvdmlkZXJBcnJheSA9IFtdO1xyXG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eU5hbWUgaW4gc2VydmljZU1vZHVsZSkge1xyXG4gICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNlcnZpY2VNb2R1bGUsIHByb3BlcnR5TmFtZSkpIHtcclxuICAgICAgICBjb25zdCBwcm9wZXJ0eVZhbHVlID0gc2VydmljZU1vZHVsZVtwcm9wZXJ0eU5hbWVdO1xyXG4gICAgICAgIGlmICh0aGlzLmlzSW5qZWN0YWJsZVNlcnZpY2UocHJvcGVydHlWYWx1ZSkpIHtcclxuICAgICAgICAgIC8vIGNvbnN0IHByb3ZpZGVyTmFtZSA9IHByb3BlcnR5VmFsdWUubmFtZSA9PT0gJ2UnID8gcHJvcGVydHlOYW1lIDogcHJvcGVydHlWYWx1ZS5uYW1lO1xyXG4gICAgICAgICAgY29uc3QgcHJvdmlkZXJOYW1lID0gcHJvcGVydHlOYW1lO1xyXG4gICAgICAgICAgcHJvdmlkZXJBcnJheS5wdXNoKHsgcHJvdmlkZTogcHJvdmlkZXJOYW1lLCB1c2VDbGFzczogcHJvcGVydHlWYWx1ZSB9KTtcclxuICAgICAgICAgIHByb3ZpZGVyQXJyYXkucHVzaChwcm9wZXJ0eVZhbHVlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGNvbnN0IHJlc29sdmVkUmVmbGVjdGl2ZVByb3ZpZGVycyA9IFJlZmxlY3RpdmVJbmplY3Rvci5yZXNvbHZlKHByb3ZpZGVyQXJyYXkpO1xyXG4gICAgcmV0dXJuIHJlc29sdmVkUmVmbGVjdGl2ZVByb3ZpZGVycztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaXNJbmplY3RhYmxlU2VydmljZShwcm9wZXJ0eVZhbHVlOiBhbnkpIHtcclxuICAgIGxldCBoYXNJbmplY3RhYmxlRGVjb3JhdG9yID0gZmFsc2U7XHJcbiAgICBjb25zdCBpc0Z1bmN0aW9uID0gcHJvcGVydHlWYWx1ZSBpbnN0YW5jZW9mIEZ1bmN0aW9uO1xyXG4gICAgaWYgKGlzRnVuY3Rpb24gJiYgcHJvcGVydHlWYWx1ZS5oYXNPd25Qcm9wZXJ0eSgnZGVjb3JhdG9ycycpKSB7XHJcbiAgICAgIGNvbnN0IGRlY29yYXRvcnMgPSBwcm9wZXJ0eVZhbHVlLmRlY29yYXRvcnMgYXMgYW55W107XHJcbiAgICAgIGNvbnN0IGluamVjdGFibGVEZWNvcmF0b3JzID0gZGVjb3JhdG9ycy5maWx0ZXIoZGVjb3JhdG9yID0+IHtcclxuICAgICAgICBpZiAoZGVjb3JhdG9yLnR5cGUgJiYgZGVjb3JhdG9yLnR5cGUucHJvdG90eXBlICYmIGRlY29yYXRvci50eXBlLnByb3RvdHlwZS5uZ01ldGFkYXRhTmFtZSA9PT0gJ0luamVjdGFibGUnKSB7XHJcbiAgICAgICAgICByZXR1cm4gZGVjb3JhdG9yO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIGhhc0luamVjdGFibGVEZWNvcmF0b3IgPSBpbmplY3RhYmxlRGVjb3JhdG9ycyAmJiBpbmplY3RhYmxlRGVjb3JhdG9ycy5sZW5ndGggPiAwO1xyXG4gICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uICYmIHByb3BlcnR5VmFsdWUuaGFzT3duUHJvcGVydHkoJ19fYW5ub3RhdGlvbnNfXycpKSB7XHJcbiAgICAgIGNvbnN0IGRlY29yYXRvcnMgPSBwcm9wZXJ0eVZhbHVlLl9fYW5ub3RhdGlvbnNfXyBhcyBhbnlbXTtcclxuICAgICAgY29uc3QgaW5qZWN0YWJsZURlY29yYXRvcnMgPSBkZWNvcmF0b3JzLmZpbHRlcihkZWNvcmF0b3JGYWN0b3J5ID0+IHtcclxuICAgICAgICBpZiAoZGVjb3JhdG9yRmFjdG9yeSAmJiBkZWNvcmF0b3JGYWN0b3J5Lm5nTWV0YWRhdGFOYW1lICYmIGRlY29yYXRvckZhY3RvcnkubmdNZXRhZGF0YU5hbWUgPT09ICdJbmplY3RhYmxlJykge1xyXG4gICAgICAgICAgcmV0dXJuIGRlY29yYXRvckZhY3Rvcnk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgaGFzSW5qZWN0YWJsZURlY29yYXRvciA9IGluamVjdGFibGVEZWNvcmF0b3JzICYmIGluamVjdGFibGVEZWNvcmF0b3JzLmxlbmd0aCA+IDA7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaGFzSW5qZWN0YWJsZURlY29yYXRvcjtcclxuICB9XHJcbn1cclxuIl19