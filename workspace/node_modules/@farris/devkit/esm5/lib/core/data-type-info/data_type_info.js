/*
 * @Author: Witt
 * @Date: 2018-12-07 09:05:09
 * @Last Modified by: Witt
 * @Last Modified time: 2018-12-27 20:35:02
 */
import * as tslib_1 from "tslib";
import { EntityMetadataUtil } from '../../entity/metadata/index';
import { DataPropGroup } from './data_prop_info';
/**
 * 实体类型信息
 * @todo：
 * 1、构造时不应该识别Entity模块的东西，应该是更抽象的；
 * 2、构造函数应该接收一个Builder接口，由Entity或者其他实现层来实现这个接口。
 */
var DataTypeInfo = /** @class */ (function () {
    /**
     * 构造函数
     * @todo：不应该识别
     */
    function DataTypeInfo(type) {
        this.type = type;
        this.primaryKey = '';
        this.foreignKey = '';
        this.propInfoMap = new Map();
        this.collectEntityInfos();
        this.collectPropInfos();
    }
    Object.defineProperty(DataTypeInfo.prototype, "isValueObject", {
        /**
         * 是否为值对象
         */
        get: function () {
            return !this.primaryKey;
        },
        enumerable: true,
        configurable: true
    });
    DataTypeInfo.prototype.getBindingPathByTableName = function (tableName) {
        var fullEntityPath = this.getFullEntityPath(this, tableName);
        if (!fullEntityPath) {
            return null;
        }
        fullEntityPath.splice(0, 1);
        return '/' + fullEntityPath.join('/');
    };
    DataTypeInfo.prototype.getFullEntityPath = function (dataTypeInfo, tableName, paths) {
        if (paths === void 0) { paths = []; }
        if (dataTypeInfo.entityInfo && (dataTypeInfo.entityInfo.nodeCode === tableName || dataTypeInfo.entityInfo.originalCode === tableName)) {
            paths.push(dataTypeInfo.entityInfo.nodeCode);
            return paths;
        }
        var props = Array.from(dataTypeInfo.propInfoMap.values()).filter(function (p) { return p.typeInfo; });
        if (props.length < 1) {
            paths = [];
            return paths;
        }
        if (dataTypeInfo.entityInfo) {
            paths.push(dataTypeInfo.entityInfo.nodeCode);
        }
        for (var idx = 0; idx < props.length; idx++) {
            var dataTypeInfo_1 = props[idx].typeInfo;
            var path = this.getFullEntityPath(dataTypeInfo_1, tableName);
            if (!path || path.length < 1) {
                continue;
            }
            else {
                paths = paths.concat(path);
                return paths;
            }
        }
        return null;
    };
    /**
     * 获取全部属性信息
     */
    DataTypeInfo.prototype.getPropInfos = function () {
        return Array.from(this.propInfoMap.values()).filter(function (propInfo) { return !propInfo.isVOField; });
    };
    /**
     * 获取全部属性的名称
     */
    DataTypeInfo.prototype.getPropNames = function () {
        var propNames = [];
        var propInfos = this.getPropInfos();
        propInfos.forEach(function (propInfo) {
            propNames.push(propInfo.name);
        });
        return propNames;
    };
    /**
     * 根据group获取属性信息数组
     */
    DataTypeInfo.prototype.getPropInfosByGroup = function (group) {
        var allPropInfos = Array.from(this.propInfoMap.values());
        var propInfos = allPropInfos.filter(function (propInfo) {
            return propInfo.group === group && !propInfo.isVOField;
        });
        return propInfos;
    };
    /**
     * 根据group获取属性名称数组
     * @param group 属性分组
     */
    DataTypeInfo.prototype.getPropNamesByGroup = function (group) {
        var propNames = [];
        var propInfos = this.getPropInfosByGroup(group);
        propInfos.forEach(function (propInfo) {
            propNames.push(propInfo.name);
        });
        return propNames;
    };
    /**
     * 根据propName获取属性信息
     */
    DataTypeInfo.prototype.getPropInfoByName = function (propName) {
        if (this.propInfoMap.has(propName)) {
            return this.propInfoMap.get(propName);
        }
        return null;
    };
    /**
     * 根据path获取属性信息
     */
    DataTypeInfo.prototype.getPropInfoByPath = function (path) {
        // 先复制，防止shift方法产生污染
        var arrPath = path.concat([]);
        if (arrPath.length === 0) {
            throw Error("\u5C5E\u6027\u8DEF\u5F84\u4E0D\u80FD\u4E3A\u7A7A");
        }
        // 循环查找
        var typeInfo = this;
        var propInfo = null;
        while (typeInfo && arrPath.length > 0) {
            var propName = arrPath.shift();
            propInfo = typeInfo.getPropInfoByName(propName);
            if (!propInfo) {
                throw Error("\u8DEF\u5F84" + path + "\u4E2D\u5B58\u5728\u4E0D\u6B63\u786E\u7684\u8282\u70B9" + propName + "\uFF0C\u8BF7\u68C0\u67E5");
            }
            typeInfo = propInfo.typeInfo;
            // 如果是动态列，并且路径数组里还有属性，统一设置为null(动态列不再描述属性信息)
            if (propInfo.group === DataPropGroup.Dynamic && arrPath.length > 0) {
                propInfo = null;
                typeInfo = null;
            }
        }
        return propInfo;
    };
    /**
     * 根据path获取对应属性的TypeInfo
     */
    DataTypeInfo.prototype.getTypeInfoByPath = function (path) {
        // 空数组时返回
        if (path.length === 0) {
            return this;
        }
        // 获取对应属性信息
        var propInfo = this.getPropInfoByPath(path);
        if (!propInfo.typeInfo) {
            throw Error("\u8DEF\u5F84" + path + "\u65E0\u6CD5\u5B9A\u4F4D\u5230\u4E00\u4E2AEntityTypeInfo\uFF0C\u8BF7\u68C0\u67E5");
        }
        return propInfo.typeInfo;
    };
    /**
     * 获取主键的属性信息
     */
    DataTypeInfo.prototype.getPrimaryKeyPropInfo = function () {
        return this.getPropInfoByName(this.primaryKey);
    };
    /**
     * 根据name获取影射名
     */
    DataTypeInfo.prototype.getPropMappingByName = function (name) {
        var propInfo = this.getPropInfoByName(name);
        if (!propInfo) {
            return '';
        }
        return propInfo.mapping;
    };
    /**
     * 根据path获取映射名
     */
    DataTypeInfo.prototype.getPropMappingByPath = function (path) {
        var propInfo = this.getPropInfoByPath(path);
        if (!propInfo) {
            return '';
        }
        return propInfo.mapping;
    };
    /**
     * 检查属性是否属于特定的分组
     */
    DataTypeInfo.prototype.checkPropGroup = function (propName, propGroup) {
        var propInfo = this.getPropInfoByName(propName);
        if (propInfo && propInfo.group === propGroup) {
            return true;
        }
        return false;
    };
    /**
     * --------------------------------------------------------------------------------
     * 属性元数据 => 属性描述信息
     * --------------------------------------------------------------------------------
     */
    /**
     * 搜集所有属性信息
     * @todo：消除重复代码，ts不支持interface类型检测，暂时通过遍历实现。
     */
    DataTypeInfo.prototype.collectPropInfos = function () {
        var _this = this;
        // 简单属性
        var ngPlainProperties = EntityMetadataUtil.getNgFieldProperties(this.type);
        Object.keys(ngPlainProperties).forEach(function (propName) {
            var ngProperty = ngPlainProperties[propName];
            if (ngProperty.primary === true) {
                _this.primaryKey = propName;
            }
            if (ngProperty.foreign === true) {
                _this.foreignKey = propName;
            }
            _this.addPropInfo(DataPropGroup.Plain, propName, ngProperty.dataField, null, ngProperty);
        });
        // 实体属性
        var ngEntityProperties = EntityMetadataUtil.getNgObjectProperties(this.type);
        Object.keys(ngEntityProperties).forEach(function (propName) {
            var ngProperty = ngEntityProperties[propName];
            _this.addPropInfo(DataPropGroup.Object, propName, ngProperty.dataField, ngProperty.type, ngProperty);
        });
        // 动态实体属性
        var ngDynamicProperties = EntityMetadataUtil.getNgDynamicProperties(this.type);
        Object.keys(ngDynamicProperties).forEach(function (propName) {
            var ngProperty = ngDynamicProperties[propName];
            _this.addPropInfo(DataPropGroup.Dynamic, propName, ngProperty.dataField, null, ngProperty);
        });
        // 实体列表属性
        var ngEntityListProperties = EntityMetadataUtil.getNgListProperties(this.type);
        Object.keys(ngEntityListProperties).forEach(function (propName) {
            var ngProperty = ngEntityListProperties[propName];
            _this.addPropInfo(DataPropGroup.List, propName, ngProperty.dataField, ngProperty.type, ngProperty);
        });
    };
    DataTypeInfo.prototype.collectEntityInfos = function () {
        var entityInfo = EntityMetadataUtil.getNgEntityMatadata(this.type);
        if (!entityInfo) {
            // 应用于解析表单
            entityInfo = {
                originalCode: this.type["code"],
                nodeCode: this.type["label"]
            };
        }
        this.entityInfo = entityInfo;
    };
    /**
     * 添加属性信息
     */
    DataTypeInfo.prototype.addPropInfo = function (group, name, mapping, type, metadataInfo) {
        // 没有设置影射时，用属性名充当影射
        mapping = mapping ? mapping : name;
        var typeInfo = null;
        if (type) {
            typeInfo = new DataTypeInfo(type);
        }
        var propInfo = { group: group, name: name, mapping: mapping, typeInfo: typeInfo, metadataInfo: metadataInfo };
        this.propInfoMap.set(name, propInfo);
        // 将vo字段也加入便于表达式查找
        var originalDataField = metadataInfo && metadataInfo.originalDataField;
        if (originalDataField && !this.propInfoMap.has(originalDataField)) {
            this.propInfoMap.set(originalDataField, tslib_1.__assign({}, propInfo, { isVOField: true }));
        }
        else if (metadataInfo && metadataInfo.type) {
            var entityInfo = EntityMetadataUtil.getNgEntityMatadata(metadataInfo.type);
            if (entityInfo && entityInfo.originalCode) {
                this.propInfoMap.set(entityInfo.originalCode, tslib_1.__assign({}, propInfo, { isVOField: true }));
            }
        }
    };
    return DataTypeInfo;
}());
export { DataTypeInfo };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YV90eXBlX2luZm8uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9jb3JlL2RhdGEtdHlwZS1pbmZvL2RhdGFfdHlwZV9pbmZvLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7OztHQUtHOztBQUdILE9BQU8sRUFFTCxrQkFBa0IsRUFFbkIsTUFBTSw2QkFBNkIsQ0FBQztBQUNyQyxPQUFPLEVBQUUsYUFBYSxFQUFnQixNQUFNLGtCQUFrQixDQUFDO0FBRS9EOzs7OztHQUtHO0FBQ0g7SUE4QkU7OztPQUdHO0lBQ0gsc0JBQVksSUFBUztRQUNuQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksR0FBRyxFQUF3QixDQUFDO1FBQ25ELElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQzFCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFmRCxzQkFBVyx1Q0FBYTtRQUh4Qjs7V0FFRzthQUNIO1lBQ0UsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7UUFDMUIsQ0FBQzs7O09BQUE7SUFjTSxnREFBeUIsR0FBaEMsVUFBaUMsU0FBaUI7UUFDaEQsSUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ25CLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUM1QixPQUFPLEdBQUcsR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFDTyx3Q0FBaUIsR0FBekIsVUFBMEIsWUFBMEIsRUFBRSxTQUFpQixFQUFFLEtBQW9CO1FBQXBCLHNCQUFBLEVBQUEsVUFBb0I7UUFDM0YsSUFBSSxZQUFZLENBQUMsVUFBVSxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxRQUFRLEtBQUssU0FBUyxJQUFJLFlBQVksQ0FBQyxVQUFVLENBQUMsWUFBWSxLQUFLLFNBQVMsQ0FBQyxFQUFFO1lBQ3JJLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM3QyxPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxDQUFDLFFBQVEsRUFBVixDQUFVLENBQUMsQ0FBQztRQUNwRixJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3BCLEtBQUssR0FBRyxFQUFFLENBQUM7WUFDWCxPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBSSxZQUFZLENBQUMsVUFBVSxFQUFFO1lBQzNCLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUM5QztRQUVELEtBQUssSUFBSSxHQUFHLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxFQUFFO1lBQzNDLElBQU0sY0FBWSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUM7WUFDekMsSUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGNBQVksRUFBRSxTQUFTLENBQUMsQ0FBQztZQUM3RCxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUM1QixTQUFTO2FBQ1Y7aUJBQU07Z0JBQ0wsS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzNCLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7U0FDRjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUNEOztPQUVHO0lBQ0ksbUNBQVksR0FBbkI7UUFDRSxPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFDLFFBQVEsSUFBSyxPQUFBLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBbkIsQ0FBbUIsQ0FBQyxDQUFDO0lBQ3pGLENBQUM7SUFFRDs7T0FFRztJQUNJLG1DQUFZLEdBQW5CO1FBQ0UsSUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLElBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUN0QyxTQUFTLENBQUMsT0FBTyxDQUFDLFVBQUMsUUFBUTtZQUN6QixTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoQyxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFRDs7T0FFRztJQUNJLDBDQUFtQixHQUExQixVQUEyQixLQUFvQjtRQUM3QyxJQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUMzRCxJQUFNLFNBQVMsR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDLFVBQUMsUUFBc0I7WUFDM0QsT0FBTyxRQUFRLENBQUMsS0FBSyxLQUFLLEtBQUssSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUM7UUFDekQsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBRUQ7OztPQUdHO0lBQ0ksMENBQW1CLEdBQTFCLFVBQTJCLEtBQW9CO1FBQzdDLElBQU0sU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbEQsU0FBUyxDQUFDLE9BQU8sQ0FBQyxVQUFDLFFBQVE7WUFDekIsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEMsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBRUQ7O09BRUc7SUFDSSx3Q0FBaUIsR0FBeEIsVUFBeUIsUUFBZ0I7UUFDdkMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUNsQyxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3ZDO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQ7O09BRUc7SUFDSSx3Q0FBaUIsR0FBeEIsVUFBeUIsSUFBYztRQUVyQyxvQkFBb0I7UUFDcEIsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNoQyxJQUFJLE9BQU8sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQ3hCLE1BQU0sS0FBSyxDQUFDLGtEQUFVLENBQUMsQ0FBQztTQUN6QjtRQUVELE9BQU87UUFDUCxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDcEIsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLE9BQU8sUUFBUSxJQUFJLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBRXJDLElBQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNqQyxRQUFRLEdBQUcsUUFBUSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2hELElBQUksQ0FBQyxRQUFRLEVBQUU7Z0JBQ2IsTUFBTSxLQUFLLENBQUMsaUJBQUssSUFBSSw4REFBWSxRQUFRLDZCQUFNLENBQUMsQ0FBQzthQUNsRDtZQUNELFFBQVEsR0FBRyxRQUFRLENBQUMsUUFBUSxDQUFDO1lBRTdCLDRDQUE0QztZQUM1QyxJQUFJLFFBQVEsQ0FBQyxLQUFLLEtBQUssYUFBYSxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDbEUsUUFBUSxHQUFHLElBQUksQ0FBQztnQkFDaEIsUUFBUSxHQUFHLElBQUksQ0FBQzthQUNqQjtTQUNGO1FBRUQsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksd0NBQWlCLEdBQXhCLFVBQXlCLElBQWM7UUFFckMsU0FBUztRQUNULElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDckIsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUVELFdBQVc7UUFDWCxJQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUU7WUFDdEIsTUFBTSxLQUFLLENBQUMsaUJBQUssSUFBSSxxRkFBMkIsQ0FBQyxDQUFDO1NBQ25EO1FBRUQsT0FBTyxRQUFRLENBQUMsUUFBUSxDQUFDO0lBQzNCLENBQUM7SUFFRDs7T0FFRztJQUNJLDRDQUFxQixHQUE1QjtRQUNFLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBRUQ7O09BRUc7SUFDSSwyQ0FBb0IsR0FBM0IsVUFBNEIsSUFBWTtRQUN0QyxJQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNiLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFDRCxPQUFPLFFBQVEsQ0FBQyxPQUFPLENBQUM7SUFDMUIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksMkNBQW9CLEdBQTNCLFVBQTRCLElBQWM7UUFDeEMsSUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDYixPQUFPLEVBQUUsQ0FBQztTQUNYO1FBQ0QsT0FBTyxRQUFRLENBQUMsT0FBTyxDQUFDO0lBQzFCLENBQUM7SUFFRDs7T0FFRztJQUNJLHFDQUFjLEdBQXJCLFVBQXNCLFFBQWdCLEVBQUUsU0FBd0I7UUFDOUQsSUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2xELElBQUksUUFBUSxJQUFJLFFBQVEsQ0FBQyxLQUFLLEtBQUssU0FBUyxFQUFFO1lBQzVDLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFHRDs7OztPQUlHO0lBRUg7OztPQUdHO0lBQ0ssdUNBQWdCLEdBQXhCO1FBQUEsaUJBbUNDO1FBakNDLE9BQU87UUFDUCxJQUFNLGlCQUFpQixHQUFHLGtCQUFrQixDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3RSxNQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUMsUUFBZ0I7WUFDdEQsSUFBTSxVQUFVLEdBQUcsaUJBQWlCLENBQUMsUUFBUSxDQUFvQixDQUFDO1lBQ2xFLElBQUksVUFBVSxDQUFDLE9BQU8sS0FBSyxJQUFJLEVBQUU7Z0JBQy9CLEtBQUksQ0FBQyxVQUFVLEdBQUcsUUFBUSxDQUFDO2FBQzVCO1lBQ0QsSUFBSSxVQUFVLENBQUMsT0FBTyxLQUFLLElBQUksRUFBRTtnQkFDL0IsS0FBSSxDQUFDLFVBQVUsR0FBRyxRQUFRLENBQUM7YUFDNUI7WUFDRCxLQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLFVBQVUsQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQzFGLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTztRQUNQLElBQU0sa0JBQWtCLEdBQUcsa0JBQWtCLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQy9FLE1BQU0sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQyxRQUFnQjtZQUN2RCxJQUFNLFVBQVUsR0FBRyxrQkFBa0IsQ0FBQyxRQUFRLENBQXFCLENBQUM7WUFDcEUsS0FBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSxVQUFVLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDdEcsQ0FBQyxDQUFDLENBQUM7UUFFSCxTQUFTO1FBQ1QsSUFBTSxtQkFBbUIsR0FBRyxrQkFBa0IsQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDakYsTUFBTSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFDLFFBQWdCO1lBQ3hELElBQU0sVUFBVSxHQUFHLG1CQUFtQixDQUFDLFFBQVEsQ0FBc0IsQ0FBQztZQUN0RSxLQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLFVBQVUsQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQzVGLENBQUMsQ0FBQyxDQUFDO1FBRUgsU0FBUztRQUNULElBQU0sc0JBQXNCLEdBQUcsa0JBQWtCLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pGLE1BQU0sQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQyxRQUFnQjtZQUMzRCxJQUFNLFVBQVUsR0FBRyxzQkFBc0IsQ0FBQyxRQUFRLENBQW1CLENBQUM7WUFDdEUsS0FBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxVQUFVLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDcEcsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ08seUNBQWtCLEdBQTFCO1FBQ0UsSUFBSSxVQUFVLEdBQUcsa0JBQWtCLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ25FLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDZixVQUFVO1lBQ1YsVUFBVSxHQUFHO2dCQUNYLFlBQVksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztnQkFDL0IsUUFBUSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO2FBQzdCLENBQUM7U0FDSDtRQUNELElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO0lBRS9CLENBQUM7SUFDRDs7T0FFRztJQUNLLGtDQUFXLEdBQW5CLFVBQW9CLEtBQW9CLEVBQUUsSUFBWSxFQUFFLE9BQWUsRUFBRSxJQUFlLEVBQUUsWUFBd0I7UUFFaEgsbUJBQW1CO1FBQ25CLE9BQU8sR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQ25DLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQztRQUNwQixJQUFJLElBQUksRUFBRTtZQUNSLFFBQVEsR0FBRyxJQUFJLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNuQztRQUNELElBQU0sUUFBUSxHQUFHLEVBQUUsS0FBSyxPQUFBLEVBQUUsSUFBSSxNQUFBLEVBQUUsT0FBTyxTQUFBLEVBQUUsUUFBUSxVQUFBLEVBQUUsWUFBWSxjQUFBLEVBQUUsQ0FBQztRQUNsRSxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDckMsa0JBQWtCO1FBQ2xCLElBQU0saUJBQWlCLEdBQUcsWUFBWSxJQUFJLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQztRQUN6RSxJQUFJLGlCQUFpQixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsRUFBRTtZQUNqRSxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsdUJBQU8sUUFBUSxJQUFFLFNBQVMsRUFBRSxJQUFJLElBQUcsQ0FBQztTQUMzRTthQUFNLElBQUksWUFBWSxJQUFJLFlBQVksQ0FBQyxJQUFJLEVBQUU7WUFDNUMsSUFBTSxVQUFVLEdBQUcsa0JBQWtCLENBQUMsbUJBQW1CLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzdFLElBQUksVUFBVSxJQUFJLFVBQVUsQ0FBQyxZQUFZLEVBQUU7Z0JBQ3pDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxZQUFZLHVCQUFPLFFBQVEsSUFBRSxTQUFTLEVBQUUsSUFBSSxJQUFHLENBQUM7YUFDakY7U0FDRjtJQUNILENBQUM7SUFDSCxtQkFBQztBQUFELENBQUMsQUFoVEQsSUFnVEM7QUFFRCxPQUFPLEVBQUUsWUFBWSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiBXaXR0XHJcbiAqIEBEYXRlOiAyMDE4LTEyLTA3IDA5OjA1OjA5XHJcbiAqIEBMYXN0IE1vZGlmaWVkIGJ5OiBXaXR0XHJcbiAqIEBMYXN0IE1vZGlmaWVkIHRpbWU6IDIwMTgtMTItMjcgMjA6MzU6MDJcclxuICovXHJcblxyXG5pbXBvcnQgeyBUeXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7XHJcbiAgTmdQcm9wZXJ0eSwgTmdGaWVsZFByb3BlcnR5LCBOZ09iamVjdFByb3BlcnR5LCBOZ0R5bmFtaWNQcm9wZXJ0eSwgTmdMaXN0UHJvcGVydHksXHJcbiAgRW50aXR5TWV0YWRhdGFVdGlsLFxyXG4gIE5nRW50aXR5XHJcbn0gZnJvbSAnLi4vLi4vZW50aXR5L21ldGFkYXRhL2luZGV4JztcclxuaW1wb3J0IHsgRGF0YVByb3BHcm91cCwgRGF0YVByb3BJbmZvIH0gZnJvbSAnLi9kYXRhX3Byb3BfaW5mbyc7XHJcblxyXG4vKipcclxuICog5a6e5L2T57G75Z6L5L+h5oGvXHJcbiAqIEB0b2Rv77yaXHJcbiAqIDHjgIHmnoTpgKDml7bkuI3lupTor6Xor4bliKtFbnRpdHnmqKHlnZfnmoTkuJzopb/vvIzlupTor6XmmK/mm7Tmir3osaHnmoTvvJtcclxuICogMuOAgeaehOmAoOWHveaVsOW6lOivpeaOpeaUtuS4gOS4qkJ1aWxkZXLmjqXlj6PvvIznlLFFbnRpdHnmiJbogIXlhbbku5blrp7njrDlsYLmnaXlrp7njrDov5nkuKrmjqXlj6PjgIJcclxuICovXHJcbmNsYXNzIERhdGFUeXBlSW5mbyB7XHJcbiAgcHVibGljIGVudGl0eUluZm86IE5nRW50aXR5O1xyXG5cclxuICAvKipcclxuICAgKiDmlbDmja7nsbvlnotcclxuICAgKi9cclxuICBwdWJsaWMgdHlwZTogVHlwZTxhbnk+O1xyXG5cclxuICAvKipcclxuICAgKiDlsZ7mgKfpm4blkIhcclxuICAgKi9cclxuICBwdWJsaWMgcHJvcEluZm9NYXA6IE1hcDxzdHJpbmcsIERhdGFQcm9wSW5mbz47XHJcblxyXG4gIC8qKlxyXG4gICAqIOS4u+mUrlxyXG4gICAqL1xyXG4gIHB1YmxpYyBwcmltYXJ5S2V5OiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIOWklumUrlxyXG4gICAqL1xyXG4gIHB1YmxpYyBmb3JlaWduS2V5OiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIOaYr+WQpuS4uuWAvOWvueixoVxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQgaXNWYWx1ZU9iamVjdCgpIHtcclxuICAgIHJldHVybiAhdGhpcy5wcmltYXJ5S2V5O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICogQHRvZG/vvJrkuI3lupTor6Xor4bliKtcclxuICAgKi9cclxuICBjb25zdHJ1Y3Rvcih0eXBlOiBhbnkpIHtcclxuICAgIHRoaXMudHlwZSA9IHR5cGU7XHJcbiAgICB0aGlzLnByaW1hcnlLZXkgPSAnJztcclxuICAgIHRoaXMuZm9yZWlnbktleSA9ICcnO1xyXG4gICAgdGhpcy5wcm9wSW5mb01hcCA9IG5ldyBNYXA8c3RyaW5nLCBEYXRhUHJvcEluZm8+KCk7XHJcbiAgICB0aGlzLmNvbGxlY3RFbnRpdHlJbmZvcygpO1xyXG4gICAgdGhpcy5jb2xsZWN0UHJvcEluZm9zKCk7XHJcbiAgfVxyXG4gIHB1YmxpYyBnZXRCaW5kaW5nUGF0aEJ5VGFibGVOYW1lKHRhYmxlTmFtZTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IGZ1bGxFbnRpdHlQYXRoID0gdGhpcy5nZXRGdWxsRW50aXR5UGF0aCh0aGlzLCB0YWJsZU5hbWUpO1xyXG4gICAgaWYgKCFmdWxsRW50aXR5UGF0aCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGZ1bGxFbnRpdHlQYXRoLnNwbGljZSgwLCAxKTtcclxuICAgIHJldHVybiAnLycgKyBmdWxsRW50aXR5UGF0aC5qb2luKCcvJyk7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0RnVsbEVudGl0eVBhdGgoZGF0YVR5cGVJbmZvOiBEYXRhVHlwZUluZm8sIHRhYmxlTmFtZTogc3RyaW5nLCBwYXRoczogc3RyaW5nW10gPSBbXSkge1xyXG4gICAgaWYgKGRhdGFUeXBlSW5mby5lbnRpdHlJbmZvICYmIChkYXRhVHlwZUluZm8uZW50aXR5SW5mby5ub2RlQ29kZSA9PT0gdGFibGVOYW1lIHx8IGRhdGFUeXBlSW5mby5lbnRpdHlJbmZvLm9yaWdpbmFsQ29kZSA9PT0gdGFibGVOYW1lKSkge1xyXG4gICAgICBwYXRocy5wdXNoKGRhdGFUeXBlSW5mby5lbnRpdHlJbmZvLm5vZGVDb2RlKTtcclxuICAgICAgcmV0dXJuIHBhdGhzO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcHJvcHMgPSBBcnJheS5mcm9tKGRhdGFUeXBlSW5mby5wcm9wSW5mb01hcC52YWx1ZXMoKSkuZmlsdGVyKHAgPT4gcC50eXBlSW5mbyk7XHJcbiAgICBpZiAocHJvcHMubGVuZ3RoIDwgMSkge1xyXG4gICAgICBwYXRocyA9IFtdO1xyXG4gICAgICByZXR1cm4gcGF0aHM7XHJcbiAgICB9XHJcbiAgICBpZiAoZGF0YVR5cGVJbmZvLmVudGl0eUluZm8pIHtcclxuICAgICAgcGF0aHMucHVzaChkYXRhVHlwZUluZm8uZW50aXR5SW5mby5ub2RlQ29kZSk7XHJcbiAgICB9XHJcblxyXG4gICAgZm9yIChsZXQgaWR4ID0gMDsgaWR4IDwgcHJvcHMubGVuZ3RoOyBpZHgrKykge1xyXG4gICAgICBjb25zdCBkYXRhVHlwZUluZm8gPSBwcm9wc1tpZHhdLnR5cGVJbmZvO1xyXG4gICAgICBjb25zdCBwYXRoID0gdGhpcy5nZXRGdWxsRW50aXR5UGF0aChkYXRhVHlwZUluZm8sIHRhYmxlTmFtZSk7XHJcbiAgICAgIGlmICghcGF0aCB8fCBwYXRoLmxlbmd0aCA8IDEpIHtcclxuICAgICAgICBjb250aW51ZTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBwYXRocyA9IHBhdGhzLmNvbmNhdChwYXRoKTtcclxuICAgICAgICByZXR1cm4gcGF0aHM7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5blhajpg6jlsZ7mgKfkv6Hmga9cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0UHJvcEluZm9zKCk6IERhdGFQcm9wSW5mb1tdIHtcclxuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMucHJvcEluZm9NYXAudmFsdWVzKCkpLmZpbHRlcigocHJvcEluZm8pID0+ICFwcm9wSW5mby5pc1ZPRmllbGQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5YWo6YOo5bGe5oCn55qE5ZCN56ewXHJcbiAgICovXHJcbiAgcHVibGljIGdldFByb3BOYW1lcygpOiBzdHJpbmdbXSB7XHJcbiAgICBjb25zdCBwcm9wTmFtZXMgPSBbXTtcclxuICAgIGNvbnN0IHByb3BJbmZvcyA9IHRoaXMuZ2V0UHJvcEluZm9zKCk7XHJcbiAgICBwcm9wSW5mb3MuZm9yRWFjaCgocHJvcEluZm8pID0+IHtcclxuICAgICAgcHJvcE5hbWVzLnB1c2gocHJvcEluZm8ubmFtZSk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBwcm9wTmFtZXM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmoLnmja5ncm91cOiOt+WPluWxnuaAp+S/oeaBr+aVsOe7hFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRQcm9wSW5mb3NCeUdyb3VwKGdyb3VwOiBEYXRhUHJvcEdyb3VwKTogRGF0YVByb3BJbmZvW10ge1xyXG4gICAgY29uc3QgYWxsUHJvcEluZm9zID0gQXJyYXkuZnJvbSh0aGlzLnByb3BJbmZvTWFwLnZhbHVlcygpKTtcclxuICAgIGNvbnN0IHByb3BJbmZvcyA9IGFsbFByb3BJbmZvcy5maWx0ZXIoKHByb3BJbmZvOiBEYXRhUHJvcEluZm8pID0+IHtcclxuICAgICAgcmV0dXJuIHByb3BJbmZvLmdyb3VwID09PSBncm91cCAmJiAhcHJvcEluZm8uaXNWT0ZpZWxkO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcHJvcEluZm9zO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2uZ3JvdXDojrflj5blsZ7mgKflkI3np7DmlbDnu4RcclxuICAgKiBAcGFyYW0gZ3JvdXAg5bGe5oCn5YiG57uEXHJcbiAgICovXHJcbiAgcHVibGljIGdldFByb3BOYW1lc0J5R3JvdXAoZ3JvdXA6IERhdGFQcm9wR3JvdXApOiBzdHJpbmdbXSB7XHJcbiAgICBjb25zdCBwcm9wTmFtZXMgPSBbXTtcclxuICAgIGNvbnN0IHByb3BJbmZvcyA9IHRoaXMuZ2V0UHJvcEluZm9zQnlHcm91cChncm91cCk7XHJcbiAgICBwcm9wSW5mb3MuZm9yRWFjaCgocHJvcEluZm8pID0+IHtcclxuICAgICAgcHJvcE5hbWVzLnB1c2gocHJvcEluZm8ubmFtZSk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBwcm9wTmFtZXM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmoLnmja5wcm9wTmFtZeiOt+WPluWxnuaAp+S/oeaBr1xyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRQcm9wSW5mb0J5TmFtZShwcm9wTmFtZTogc3RyaW5nKTogRGF0YVByb3BJbmZvIHtcclxuICAgIGlmICh0aGlzLnByb3BJbmZvTWFwLmhhcyhwcm9wTmFtZSkpIHtcclxuICAgICAgcmV0dXJuIHRoaXMucHJvcEluZm9NYXAuZ2V0KHByb3BOYW1lKTtcclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2ucGF0aOiOt+WPluWxnuaAp+S/oeaBr1xyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRQcm9wSW5mb0J5UGF0aChwYXRoOiBzdHJpbmdbXSk6IERhdGFQcm9wSW5mbyB7XHJcblxyXG4gICAgLy8g5YWI5aSN5Yi277yM6Ziy5q2ic2hpZnTmlrnms5XkuqfnlJ/msaHmn5NcclxuICAgIGNvbnN0IGFyclBhdGggPSBwYXRoLmNvbmNhdChbXSk7XHJcbiAgICBpZiAoYXJyUGF0aC5sZW5ndGggPT09IDApIHtcclxuICAgICAgdGhyb3cgRXJyb3IoYOWxnuaAp+i3r+W+hOS4jeiDveS4uuepumApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOW+queOr+afpeaJvlxyXG4gICAgbGV0IHR5cGVJbmZvID0gdGhpcztcclxuICAgIGxldCBwcm9wSW5mbyA9IG51bGw7XHJcbiAgICB3aGlsZSAodHlwZUluZm8gJiYgYXJyUGF0aC5sZW5ndGggPiAwKSB7XHJcblxyXG4gICAgICBjb25zdCBwcm9wTmFtZSA9IGFyclBhdGguc2hpZnQoKTtcclxuICAgICAgcHJvcEluZm8gPSB0eXBlSW5mby5nZXRQcm9wSW5mb0J5TmFtZShwcm9wTmFtZSk7XHJcbiAgICAgIGlmICghcHJvcEluZm8pIHtcclxuICAgICAgICB0aHJvdyBFcnJvcihg6Lev5b6EJHtwYXRofeS4reWtmOWcqOS4jeato+ehrueahOiKgueCuSR7cHJvcE5hbWV977yM6K+35qOA5p+lYCk7XHJcbiAgICAgIH1cclxuICAgICAgdHlwZUluZm8gPSBwcm9wSW5mby50eXBlSW5mbztcclxuXHJcbiAgICAgIC8vIOWmguaenOaYr+WKqOaAgeWIl++8jOW5tuS4lOi3r+W+hOaVsOe7hOmHjOi/mOacieWxnuaAp++8jOe7n+S4gOiuvue9ruS4um51bGwo5Yqo5oCB5YiX5LiN5YaN5o+P6L+w5bGe5oCn5L+h5oGvKVxyXG4gICAgICBpZiAocHJvcEluZm8uZ3JvdXAgPT09IERhdGFQcm9wR3JvdXAuRHluYW1pYyAmJiBhcnJQYXRoLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBwcm9wSW5mbyA9IG51bGw7XHJcbiAgICAgICAgdHlwZUluZm8gPSBudWxsO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHByb3BJbmZvO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2ucGF0aOiOt+WPluWvueW6lOWxnuaAp+eahFR5cGVJbmZvXHJcbiAgICovXHJcbiAgcHVibGljIGdldFR5cGVJbmZvQnlQYXRoKHBhdGg6IHN0cmluZ1tdKTogRGF0YVR5cGVJbmZvIHtcclxuXHJcbiAgICAvLyDnqbrmlbDnu4Tml7bov5Tlm55cclxuICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICAvLyDojrflj5blr7nlupTlsZ7mgKfkv6Hmga9cclxuICAgIGNvbnN0IHByb3BJbmZvID0gdGhpcy5nZXRQcm9wSW5mb0J5UGF0aChwYXRoKTtcclxuICAgIGlmICghcHJvcEluZm8udHlwZUluZm8pIHtcclxuICAgICAgdGhyb3cgRXJyb3IoYOi3r+W+hCR7cGF0aH3ml6Dms5XlrprkvY3liLDkuIDkuKpFbnRpdHlUeXBlSW5mb++8jOivt+ajgOafpWApO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBwcm9wSW5mby50eXBlSW5mbztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluS4u+mUrueahOWxnuaAp+S/oeaBr1xyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRQcmltYXJ5S2V5UHJvcEluZm8oKTogRGF0YVByb3BJbmZvIHtcclxuICAgIHJldHVybiB0aGlzLmdldFByb3BJbmZvQnlOYW1lKHRoaXMucHJpbWFyeUtleSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmoLnmja5uYW1l6I635Y+W5b2x5bCE5ZCNXHJcbiAgICovXHJcbiAgcHVibGljIGdldFByb3BNYXBwaW5nQnlOYW1lKG5hbWU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBjb25zdCBwcm9wSW5mbyA9IHRoaXMuZ2V0UHJvcEluZm9CeU5hbWUobmFtZSk7XHJcbiAgICBpZiAoIXByb3BJbmZvKSB7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIHJldHVybiBwcm9wSW5mby5tYXBwaW5nO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2ucGF0aOiOt+WPluaYoOWwhOWQjVxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRQcm9wTWFwcGluZ0J5UGF0aChwYXRoOiBzdHJpbmdbXSk6IHN0cmluZyB7XHJcbiAgICBjb25zdCBwcm9wSW5mbyA9IHRoaXMuZ2V0UHJvcEluZm9CeVBhdGgocGF0aCk7XHJcbiAgICBpZiAoIXByb3BJbmZvKSB7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIHJldHVybiBwcm9wSW5mby5tYXBwaW5nO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qOA5p+l5bGe5oCn5piv5ZCm5bGe5LqO54m55a6a55qE5YiG57uEXHJcbiAgICovXHJcbiAgcHVibGljIGNoZWNrUHJvcEdyb3VwKHByb3BOYW1lOiBzdHJpbmcsIHByb3BHcm91cDogRGF0YVByb3BHcm91cCk6IGJvb2xlYW4ge1xyXG4gICAgY29uc3QgcHJvcEluZm8gPSB0aGlzLmdldFByb3BJbmZvQnlOYW1lKHByb3BOYW1lKTtcclxuICAgIGlmIChwcm9wSW5mbyAmJiBwcm9wSW5mby5ncm91cCA9PT0gcHJvcEdyb3VwKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiAgICog5bGe5oCn5YWD5pWw5o2uID0+IOWxnuaAp+aPj+i/sOS/oeaBr1xyXG4gICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiAgICovXHJcblxyXG4gIC8qKlxyXG4gICAqIOaQnOmbhuaJgOacieWxnuaAp+S/oeaBr1xyXG4gICAqIEB0b2Rv77ya5raI6Zmk6YeN5aSN5Luj56CB77yMdHPkuI3mlK/mjIFpbnRlcmZhY2Xnsbvlnovmo4DmtYvvvIzmmoLml7bpgJrov4fpgY3ljoblrp7njrDjgIJcclxuICAgKi9cclxuICBwcml2YXRlIGNvbGxlY3RQcm9wSW5mb3MoKSB7XHJcblxyXG4gICAgLy8g566A5Y2V5bGe5oCnXHJcbiAgICBjb25zdCBuZ1BsYWluUHJvcGVydGllcyA9IEVudGl0eU1ldGFkYXRhVXRpbC5nZXROZ0ZpZWxkUHJvcGVydGllcyh0aGlzLnR5cGUpO1xyXG4gICAgT2JqZWN0LmtleXMobmdQbGFpblByb3BlcnRpZXMpLmZvckVhY2goKHByb3BOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgY29uc3QgbmdQcm9wZXJ0eSA9IG5nUGxhaW5Qcm9wZXJ0aWVzW3Byb3BOYW1lXSBhcyBOZ0ZpZWxkUHJvcGVydHk7XHJcbiAgICAgIGlmIChuZ1Byb3BlcnR5LnByaW1hcnkgPT09IHRydWUpIHtcclxuICAgICAgICB0aGlzLnByaW1hcnlLZXkgPSBwcm9wTmFtZTtcclxuICAgICAgfVxyXG4gICAgICBpZiAobmdQcm9wZXJ0eS5mb3JlaWduID09PSB0cnVlKSB7XHJcbiAgICAgICAgdGhpcy5mb3JlaWduS2V5ID0gcHJvcE5hbWU7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5hZGRQcm9wSW5mbyhEYXRhUHJvcEdyb3VwLlBsYWluLCBwcm9wTmFtZSwgbmdQcm9wZXJ0eS5kYXRhRmllbGQsIG51bGwsIG5nUHJvcGVydHkpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g5a6e5L2T5bGe5oCnXHJcbiAgICBjb25zdCBuZ0VudGl0eVByb3BlcnRpZXMgPSBFbnRpdHlNZXRhZGF0YVV0aWwuZ2V0TmdPYmplY3RQcm9wZXJ0aWVzKHRoaXMudHlwZSk7XHJcbiAgICBPYmplY3Qua2V5cyhuZ0VudGl0eVByb3BlcnRpZXMpLmZvckVhY2goKHByb3BOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgY29uc3QgbmdQcm9wZXJ0eSA9IG5nRW50aXR5UHJvcGVydGllc1twcm9wTmFtZV0gYXMgTmdPYmplY3RQcm9wZXJ0eTtcclxuICAgICAgdGhpcy5hZGRQcm9wSW5mbyhEYXRhUHJvcEdyb3VwLk9iamVjdCwgcHJvcE5hbWUsIG5nUHJvcGVydHkuZGF0YUZpZWxkLCBuZ1Byb3BlcnR5LnR5cGUsIG5nUHJvcGVydHkpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g5Yqo5oCB5a6e5L2T5bGe5oCnXHJcbiAgICBjb25zdCBuZ0R5bmFtaWNQcm9wZXJ0aWVzID0gRW50aXR5TWV0YWRhdGFVdGlsLmdldE5nRHluYW1pY1Byb3BlcnRpZXModGhpcy50eXBlKTtcclxuICAgIE9iamVjdC5rZXlzKG5nRHluYW1pY1Byb3BlcnRpZXMpLmZvckVhY2goKHByb3BOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgY29uc3QgbmdQcm9wZXJ0eSA9IG5nRHluYW1pY1Byb3BlcnRpZXNbcHJvcE5hbWVdIGFzIE5nRHluYW1pY1Byb3BlcnR5O1xyXG4gICAgICB0aGlzLmFkZFByb3BJbmZvKERhdGFQcm9wR3JvdXAuRHluYW1pYywgcHJvcE5hbWUsIG5nUHJvcGVydHkuZGF0YUZpZWxkLCBudWxsLCBuZ1Byb3BlcnR5KTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOWunuS9k+WIl+ihqOWxnuaAp1xyXG4gICAgY29uc3QgbmdFbnRpdHlMaXN0UHJvcGVydGllcyA9IEVudGl0eU1ldGFkYXRhVXRpbC5nZXROZ0xpc3RQcm9wZXJ0aWVzKHRoaXMudHlwZSk7XHJcbiAgICBPYmplY3Qua2V5cyhuZ0VudGl0eUxpc3RQcm9wZXJ0aWVzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5nUHJvcGVydHkgPSBuZ0VudGl0eUxpc3RQcm9wZXJ0aWVzW3Byb3BOYW1lXSBhcyBOZ0xpc3RQcm9wZXJ0eTtcclxuICAgICAgdGhpcy5hZGRQcm9wSW5mbyhEYXRhUHJvcEdyb3VwLkxpc3QsIHByb3BOYW1lLCBuZ1Byb3BlcnR5LmRhdGFGaWVsZCwgbmdQcm9wZXJ0eS50eXBlLCBuZ1Byb3BlcnR5KTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIGNvbGxlY3RFbnRpdHlJbmZvcygpIHtcclxuICAgIGxldCBlbnRpdHlJbmZvID0gRW50aXR5TWV0YWRhdGFVdGlsLmdldE5nRW50aXR5TWF0YWRhdGEodGhpcy50eXBlKTtcclxuICAgIGlmICghZW50aXR5SW5mbykge1xyXG4gICAgICAvLyDlupTnlKjkuo7op6PmnpDooajljZVcclxuICAgICAgZW50aXR5SW5mbyA9IHtcclxuICAgICAgICBvcmlnaW5hbENvZGU6IHRoaXMudHlwZVtcImNvZGVcIl0sXHJcbiAgICAgICAgbm9kZUNvZGU6IHRoaXMudHlwZVtcImxhYmVsXCJdXHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgICB0aGlzLmVudGl0eUluZm8gPSBlbnRpdHlJbmZvO1xyXG5cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5re75Yqg5bGe5oCn5L+h5oGvXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhZGRQcm9wSW5mbyhncm91cDogRGF0YVByb3BHcm91cCwgbmFtZTogc3RyaW5nLCBtYXBwaW5nOiBzdHJpbmcsIHR5cGU6IFR5cGU8YW55PiwgbWV0YWRhdGFJbmZvOiBOZ1Byb3BlcnR5KSB7XHJcblxyXG4gICAgLy8g5rKh5pyJ6K6+572u5b2x5bCE5pe277yM55So5bGe5oCn5ZCN5YWF5b2T5b2x5bCEXHJcbiAgICBtYXBwaW5nID0gbWFwcGluZyA/IG1hcHBpbmcgOiBuYW1lO1xyXG4gICAgbGV0IHR5cGVJbmZvID0gbnVsbDtcclxuICAgIGlmICh0eXBlKSB7XHJcbiAgICAgIHR5cGVJbmZvID0gbmV3IERhdGFUeXBlSW5mbyh0eXBlKTtcclxuICAgIH1cclxuICAgIGNvbnN0IHByb3BJbmZvID0geyBncm91cCwgbmFtZSwgbWFwcGluZywgdHlwZUluZm8sIG1ldGFkYXRhSW5mbyB9O1xyXG4gICAgdGhpcy5wcm9wSW5mb01hcC5zZXQobmFtZSwgcHJvcEluZm8pO1xyXG4gICAgLy8g5bCGdm/lrZfmrrXkuZ/liqDlhaXkvr/kuo7ooajovr7lvI/mn6Xmib5cclxuICAgIGNvbnN0IG9yaWdpbmFsRGF0YUZpZWxkID0gbWV0YWRhdGFJbmZvICYmIG1ldGFkYXRhSW5mby5vcmlnaW5hbERhdGFGaWVsZDtcclxuICAgIGlmIChvcmlnaW5hbERhdGFGaWVsZCAmJiAhdGhpcy5wcm9wSW5mb01hcC5oYXMob3JpZ2luYWxEYXRhRmllbGQpKSB7XHJcbiAgICAgIHRoaXMucHJvcEluZm9NYXAuc2V0KG9yaWdpbmFsRGF0YUZpZWxkLCB7IC4uLnByb3BJbmZvLCBpc1ZPRmllbGQ6IHRydWUgfSk7XHJcbiAgICB9IGVsc2UgaWYgKG1ldGFkYXRhSW5mbyAmJiBtZXRhZGF0YUluZm8udHlwZSkge1xyXG4gICAgICBjb25zdCBlbnRpdHlJbmZvID0gRW50aXR5TWV0YWRhdGFVdGlsLmdldE5nRW50aXR5TWF0YWRhdGEobWV0YWRhdGFJbmZvLnR5cGUpO1xyXG4gICAgICBpZiAoZW50aXR5SW5mbyAmJiBlbnRpdHlJbmZvLm9yaWdpbmFsQ29kZSkge1xyXG4gICAgICAgIHRoaXMucHJvcEluZm9NYXAuc2V0KGVudGl0eUluZm8ub3JpZ2luYWxDb2RlLCB7IC4uLnByb3BJbmZvLCBpc1ZPRmllbGQ6IHRydWUgfSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IERhdGFUeXBlSW5mbyB9O1xyXG4iXX0=