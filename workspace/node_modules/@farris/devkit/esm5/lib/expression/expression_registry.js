import { Inject, Injectable, Injector, Optional } from "@angular/core";
import { of } from "rxjs";
import { catchError, switchMap } from "rxjs/operators";
import { Expression } from './types';
import { FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN } from "../manifest/index";
import { TranslateToken } from "../i18n/index";
import { Repository } from "../repository/index";
var ExpressionRegistry = /** @class */ (function () {
    function ExpressionRegistry(injector, formExpressionManifestService, translate) {
        this.injector = injector;
        this.formExpressionManifestService = formExpressionManifestService;
        this.translate = translate;
        this._expressions = null;
    }
    /**
     * 加载表达式文件
     */
    ExpressionRegistry.prototype.load = function () {
        var _this = this;
        return this.formExpressionManifestService.load().pipe(switchMap(function (describe) {
            var expressions = [];
            var exprs = Array.from(describe);
            exprs.forEach(function (expr) {
                expr.expressions.forEach(function (expression) {
                    var expressionObject = {
                        id: expression.id,
                        ns: expr.ns,
                        path: expr.path,
                        bindingType: expr.type,
                        type: expression.type,
                        expression: expression.value || expression.expr || '',
                        message: expression.message || null,
                        messageType: expression.messageType || null,
                        deps: []
                    };
                    if ((expression.type === Expression.ExpressionType.Required || expression.type === Expression.ExpressionType.Validate || expression.type === Expression.ExpressionType.DataPicking)) {
                        if (!expression.message) {
                            expressionObject.message = _this.getExpressionMessage(expression.type);
                        }
                        if (!expression.messageType) {
                            expressionObject.messageType = 'error';
                        }
                    }
                    if (expressionObject.message) {
                        _this.transform(expressionObject);
                    }
                    expressions.push(expressionObject);
                });
            });
            _this._expressions = expressions;
            _this.cleanSpecialCharacters();
            return of(expressions);
        }), catchError(function (e) {
            return of([]);
        }));
    };
    Object.defineProperty(ExpressionRegistry.prototype, "expressions", {
        /**
         * 获取所有表达式
         */
        get: function () {
            if (this._expressions) {
                return of(this._expressions);
            }
            return this.load();
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 根据表达式id获取对应的表达式对象
     * @param id 表达式id
     * @returns
     */
    ExpressionRegistry.prototype.getExpressionById = function (id) {
        if (!this._expressions || this._expressions.length < 1) {
            return null;
        }
        return this._expressions.find(function (expressionObject) { return expressionObject.id === id; });
    };
    ExpressionRegistry.prototype.getExpressionMessage = function (expressionType, defaultValue) {
        if (!(expressionType === Expression.ExpressionType.Validate || expressionType === Expression.ExpressionType.Required || expressionType === Expression.ExpressionType.DataPicking)) {
            return null;
        }
        if (!this.translate) {
            return defaultValue;
        }
        var currentLanguage = this.translate.getCurrentLanguage() || 'zh-CHS';
        return Expression.MESSAGE[currentLanguage][expressionType];
    };
    ExpressionRegistry.prototype.transform = function (expressionObject) {
        if (!this.translate) {
            return;
        }
        if (expressionObject.message && expressionObject.message.startsWith('{{') && expressionObject.message.endsWith('}}')) {
            expressionObject.message = this.translate.transform(expressionObject.message.substr(2, expressionObject.message.length - 4), null) || this.getExpressionMessage(expressionObject.type);
        }
    };
    ExpressionRegistry.prototype.cleanSpecialCharacters = function () {
        var _this = this;
        if (!this._expressions || this._expressions.length < 1 || !Array.isArray(this._expressions)) {
            return;
        }
        var repository = this.injector.get(Repository, null);
        if (!repository) {
            return;
        }
        var entityTypeInfo = repository.entityTypeInfo;
        var regex = new RegExp("[\\'\\\"]?\\s*(" + entityTypeInfo.entityInfo.nodeCode + "|" + entityTypeInfo.entityInfo.originalCode + ")[\\.\\[\\]a-zA-Z0-9_]+\\s*[\\'\\\"]?", 'g');
        this._expressions.forEach(function (expressionObject) {
            var expr = expressionObject.expression;
            var entityPropertyExpressions = expr.match(regex);
            if (Array.isArray(entityPropertyExpressions) && entityPropertyExpressions.length > 0) {
                // 解析出所有实体相关的字符串，以主实体名字开头，包含主实体属性或子表
                entityPropertyExpressions.forEach(function (item) {
                    if (item.indexOf('.') === -1) {
                        return;
                    }
                    // 去数组
                    if (/\[\d\]/g.test(item)) {
                        var replacer = item.replace(/\[\d\]/g, '');
                        expressionObject.expression = _this.replaceAll(expressionObject.expression, item, replacer);
                    }
                    // 去星号
                    if (/\*/g.test(item)) {
                        var replacer = item.replace(/\*/g, '');
                        expressionObject.expression = _this.replaceAll(expressionObject.expression, item, replacer);
                    }
                });
            }
        });
    };
    ExpressionRegistry.prototype.replaceAll = function (originalValue, search, replacer) {
        return originalValue.split(search).join(replacer);
    };
    ExpressionRegistry.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ExpressionRegistry.ctorParameters = function () { return [
        { type: Injector },
        { type: undefined, decorators: [{ type: Inject, args: [FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN,] }] },
        { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [TranslateToken,] }] }
    ]; };
    return ExpressionRegistry;
}());
export { ExpressionRegistry };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl9yZWdpc3RyeS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2V4cHJlc3Npb24vZXhwcmVzc2lvbl9yZWdpc3RyeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZFLE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN2RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxzQ0FBc0MsRUFBa0MsTUFBTSxtQkFBbUIsQ0FBQztBQUMzRyxPQUFPLEVBQWEsY0FBYyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUVqRDtJQUdFLDRCQUNVLFFBQWtCLEVBQzhCLDZCQUE2RCxFQUN6RSxTQUFvQjtRQUZ4RCxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQzhCLGtDQUE2QixHQUE3Qiw2QkFBNkIsQ0FBZ0M7UUFDekUsY0FBUyxHQUFULFNBQVMsQ0FBVztRQUoxRCxpQkFBWSxHQUFrQyxJQUFJLENBQUM7SUFNM0QsQ0FBQztJQUNEOztPQUVHO0lBQ0ksaUNBQUksR0FBWDtRQUFBLGlCQXdDQztRQXZDQyxPQUFPLElBQUksQ0FBQyw2QkFBNkIsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQ25ELFNBQVMsQ0FBQyxVQUFDLFFBQW9CO1lBQzdCLElBQU0sV0FBVyxHQUF1QyxFQUFFLENBQUM7WUFDM0QsSUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNuQyxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQUMs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LENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO3dCQUN6QyxnQkFBZ0IsQ0FBQyxVQUFVLEdBQUcsS0FBSSxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO3FCQUM1RjtnQkFDSCxDQUFDLENBQUMsQ0FBQzthQUNKO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ08sdUNBQVUsR0FBbEIsVUFBbUIsYUFBcUIsRUFBRSxNQUFjLEVBQUUsUUFBZ0I7UUFDeEUsT0FBTyxhQUFhLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNwRCxDQUFDOztnQkE5SEYsVUFBVTs7OztnQkFSa0IsUUFBUTtnREFhaEMsTUFBTSxTQUFDLHNDQUFzQztnREFDN0MsUUFBUSxZQUFJLE1BQU0sU0FBQyxjQUFjOztJQXlIdEMseUJBQUM7Q0FBQSxBQS9IRCxJQStIQztTQTlIWSxrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yLCBPcHRpb25hbCB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSBcInJ4anNcIjtcclxuaW1wb3J0IHsgY2F0Y2hFcnJvciwgc3dpdGNoTWFwIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XHJcbmltcG9ydCB7IEV4cHJlc3Npb24gfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgRk9STV9FWFBSRVNTSU9OX01BTklGRVNUX1NFUlZJQ0VfVE9LRU4sIElGb3JtRXhwcmVzc2lvbk1hbmlmZXN0U2VydmljZSB9IGZyb20gXCIuLi9tYW5pZmVzdC9pbmRleFwiO1xyXG5pbXBvcnQgeyBUcmFuc2xhdGUsIFRyYW5zbGF0ZVRva2VuIH0gZnJvbSBcIi4uL2kxOG4vaW5kZXhcIjtcclxuaW1wb3J0IHsgUmVwb3NpdG9yeSB9IGZyb20gXCIuLi9yZXBvc2l0b3J5L2luZGV4XCI7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBFeHByZXNzaW9uUmVnaXN0cnkge1xyXG4gIHByaXZhdGUgX2V4cHJlc3Npb25zOiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3RbXSA9IG51bGw7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcixcclxuICAgIEBJbmplY3QoRk9STV9FWFBSRVNTSU9OX01BTklGRVNUX1NFUlZJQ0VfVE9LRU4pIHByaXZhdGUgZm9ybUV4cHJlc3Npb25NYW5pZmVzdFNlcnZpY2U6IElGb3JtRXhwcmVzc2lvbk1hbmlmZXN0U2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoVHJhbnNsYXRlVG9rZW4pIHByaXZhdGUgdHJhbnNsYXRlOiBUcmFuc2xhdGVcclxuICApIHtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yqg6L296KGo6L6+5byP5paH5Lu2XHJcbiAgICovXHJcbiAgcHVibGljIGxvYWQoKTogT2JzZXJ2YWJsZTxFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3RbXT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZm9ybUV4cHJlc3Npb25NYW5pZmVzdFNlcnZpY2UubG9hZCgpLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcCgoZGVzY3JpYmU6IEFycmF5PGFueT4pID0+IHtcclxuICAgICAgICBjb25zdCBleHByZXNzaW9uczogQXJyYXk8RXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0PiA9IFtdO1xyXG4gICAgICAgIGNvbnN0IGV4cHJzID0gQXJyYXkuZnJvbShkZXNjcmliZSk7XHJcbiAgICAgICAgZXhwcnMuZm9yRWFjaCgoZXhwcjogYW55KSA9PiB7XHJcbiAgICAgICAgICBleHByLmV4cHJlc3Npb25zLmZvckVhY2goKGV4cHJlc3Npb246IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QgPSB7XHJcbiAgICAgICAgICAgICAgaWQ6IGV4cHJlc3Npb24uaWQsXHJcbiAgICAgICAgICAgICAgbnM6IGV4cHIubnMsXHJcbiAgICAgICAgICAgICAgcGF0aDogZXhwci5wYXRoLFxyXG4gICAgICAgICAgICAgIGJpbmRpbmdUeXBlOiBleHByLnR5cGUsXHJcbiAgICAgICAgICAgICAgdHlwZTogZXhwcmVzc2lvbi50eXBlLFxyXG4gICAgICAgICAgICAgIGV4cHJlc3Npb246IGV4cHJlc3Npb24udmFsdWUgfHwgZXhwcmVzc2lvbi5leHByIHx8ICcnLFxyXG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGV4cHJlc3Npb24ubWVzc2FnZSB8fCBudWxsLFxyXG4gICAgICAgICAgICAgIG1lc3NhZ2VUeXBlOiBleHByZXNzaW9uLm1lc3NhZ2VUeXBlIHx8IG51bGwsXHJcbiAgICAgICAgICAgICAgZGVwczogW11cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgaWYgKChleHByZXNzaW9uLnR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuUmVxdWlyZWQgfHwgZXhwcmVzc2lvbi50eXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLlZhbGlkYXRlIHx8IGV4cHJlc3Npb24udHlwZSA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5EYXRhUGlja2luZykpIHtcclxuICAgICAgICAgICAgICBpZiAoIWV4cHJlc3Npb24ubWVzc2FnZSkge1xyXG4gICAgICAgICAgICAgICAgZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlID0gdGhpcy5nZXRFeHByZXNzaW9uTWVzc2FnZShleHByZXNzaW9uLnR5cGUpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBpZiAoIWV4cHJlc3Npb24ubWVzc2FnZVR5cGUpIHtcclxuICAgICAgICAgICAgICAgIGV4cHJlc3Npb25PYmplY3QubWVzc2FnZVR5cGUgPSAnZXJyb3InO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy50cmFuc2Zvcm0oZXhwcmVzc2lvbk9iamVjdCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZXhwcmVzc2lvbnMucHVzaChleHByZXNzaW9uT2JqZWN0KTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuX2V4cHJlc3Npb25zID0gZXhwcmVzc2lvbnM7XHJcbiAgICAgICAgdGhpcy5jbGVhblNwZWNpYWxDaGFyYWN0ZXJzKCk7XHJcbiAgICAgICAgcmV0dXJuIG9mKGV4cHJlc3Npb25zKTtcclxuICAgICAgfSksXHJcbiAgICAgIGNhdGNoRXJyb3IoKGUpID0+IHtcclxuICAgICAgICByZXR1cm4gb2YoW10pO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5omA5pyJ6KGo6L6+5byPXHJcbiAgICovXHJcbiAgcHVibGljIGdldCBleHByZXNzaW9ucygpOiBPYnNlcnZhYmxlPEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdFtdPiB7XHJcbiAgICBpZiAodGhpcy5fZXhwcmVzc2lvbnMpIHtcclxuICAgICAgcmV0dXJuIG9mKHRoaXMuX2V4cHJlc3Npb25zKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLmxvYWQoKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5qC55o2u6KGo6L6+5byPaWTojrflj5blr7nlupTnmoTooajovr7lvI/lr7nosaFcclxuICAgKiBAcGFyYW0gaWQg6KGo6L6+5byPaWRcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RXhwcmVzc2lvbkJ5SWQoaWQ6IHN0cmluZyk6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCB7XHJcbiAgICBpZiAoIXRoaXMuX2V4cHJlc3Npb25zIHx8IHRoaXMuX2V4cHJlc3Npb25zLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5fZXhwcmVzc2lvbnMuZmluZCgoZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KSA9PiBleHByZXNzaW9uT2JqZWN0LmlkID09PSBpZCk7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0RXhwcmVzc2lvbk1lc3NhZ2UoZXhwcmVzc2lvblR5cGU6IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUsIGRlZmF1bHRWYWx1ZT86IHN0cmluZykge1xyXG4gICAgaWYgKCEoZXhwcmVzc2lvblR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuVmFsaWRhdGUgfHwgZXhwcmVzc2lvblR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuUmVxdWlyZWQgfHwgZXhwcmVzc2lvblR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuRGF0YVBpY2tpbmcpKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgaWYgKCF0aGlzLnRyYW5zbGF0ZSkge1xyXG4gICAgICByZXR1cm4gZGVmYXVsdFZhbHVlO1xyXG4gICAgfVxyXG4gICAgY29uc3QgY3VycmVudExhbmd1YWdlID0gdGhpcy50cmFuc2xhdGUuZ2V0Q3VycmVudExhbmd1YWdlKCkgfHwgJ3poLUNIUyc7XHJcbiAgICByZXR1cm4gRXhwcmVzc2lvbi5NRVNTQUdFW2N1cnJlbnRMYW5ndWFnZV1bZXhwcmVzc2lvblR5cGVdO1xyXG4gIH1cclxuICBwcml2YXRlIHRyYW5zZm9ybShleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpIHtcclxuICAgIGlmICghdGhpcy50cmFuc2xhdGUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKGV4cHJlc3Npb25PYmplY3QubWVzc2FnZSAmJiBleHByZXNzaW9uT2JqZWN0Lm1lc3NhZ2Uuc3RhcnRzV2l0aCgne3snKSAmJiBleHByZXNzaW9uT2JqZWN0Lm1lc3NhZ2UuZW5kc1dpdGgoJ319JykpIHtcclxuICAgICAgZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlID0gdGhpcy50cmFuc2xhdGUudHJhbnNmb3JtKGV4cHJlc3Npb25PYmplY3QubWVzc2FnZS5zdWJzdHIoMiwgZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlLmxlbmd0aCAtIDQpLCBudWxsKSB8fCB0aGlzLmdldEV4cHJlc3Npb25NZXNzYWdlKGV4cHJlc3Npb25PYmplY3QudHlwZSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgY2xlYW5TcGVjaWFsQ2hhcmFjdGVycygpIHtcclxuICAgIGlmICghdGhpcy5fZXhwcmVzc2lvbnMgfHwgdGhpcy5fZXhwcmVzc2lvbnMubGVuZ3RoIDwgMSB8fCAhQXJyYXkuaXNBcnJheSh0aGlzLl9leHByZXNzaW9ucykpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+ID0gdGhpcy5pbmplY3Rvci5nZXQoUmVwb3NpdG9yeSwgbnVsbCk7XHJcbiAgICBpZiAoIXJlcG9zaXRvcnkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZW50aXR5VHlwZUluZm8gPSByZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvO1xyXG4gICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKGBbXFxcXCdcXFxcXCJdP1xcXFxzKigke2VudGl0eVR5cGVJbmZvLmVudGl0eUluZm8ubm9kZUNvZGV9fCR7ZW50aXR5VHlwZUluZm8uZW50aXR5SW5mby5vcmlnaW5hbENvZGV9KVtcXFxcLlxcXFxbXFxcXF1hLXpBLVowLTlfXStcXFxccypbXFxcXCdcXFxcXCJdP2AsICdnJyk7XHJcbiAgICB0aGlzLl9leHByZXNzaW9ucy5mb3JFYWNoKChleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpID0+IHtcclxuICAgICAgY29uc3QgZXhwciA9IGV4cHJlc3Npb25PYmplY3QuZXhwcmVzc2lvbjtcclxuICAgICAgY29uc3QgZW50aXR5UHJvcGVydHlFeHByZXNzaW9uczogUmVnRXhwTWF0Y2hBcnJheSA9IGV4cHIubWF0Y2gocmVnZXgpO1xyXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShlbnRpdHlQcm9wZXJ0eUV4cHJlc3Npb25zKSAmJiBlbnRpdHlQcm9wZXJ0eUV4cHJlc3Npb25zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAvLyDop6PmnpDlh7rmiYDmnInlrp7kvZPnm7jlhbPnmoTlrZfnrKbkuLLvvIzku6XkuLvlrp7kvZPlkI3lrZflvIDlpLTvvIzljIXlkKvkuLvlrp7kvZPlsZ7mgKfmiJblrZDooahcclxuICAgICAgICBlbnRpdHlQcm9wZXJ0eUV4cHJlc3Npb25zLmZvckVhY2goKGl0ZW06IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgaWYgKGl0ZW0uaW5kZXhPZignLicpID09PSAtMSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyDljrvmlbDnu4RcclxuICAgICAgICAgIGlmICgvXFxbXFxkXFxdL2cudGVzdChpdGVtKSkge1xyXG4gICAgICAgICAgICBjb25zdCByZXBsYWNlciA9IGl0ZW0ucmVwbGFjZSgvXFxbXFxkXFxdL2csICcnKTtcclxuICAgICAgICAgICAgZXhwcmVzc2lvbk9iamVjdC5leHByZXNzaW9uID0gdGhpcy5yZXBsYWNlQWxsKGV4cHJlc3Npb25PYmplY3QuZXhwcmVzc2lvbiwgaXRlbSwgcmVwbGFjZXIpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgLy8g5Y675pif5Y+3XHJcbiAgICAgICAgICBpZiAoL1xcKi9nLnRlc3QoaXRlbSkpIHtcclxuICAgICAgICAgICAgY29uc3QgcmVwbGFjZXIgPSBpdGVtLnJlcGxhY2UoL1xcKi9nLCAnJyk7XHJcbiAgICAgICAgICAgIGV4cHJlc3Npb25PYmplY3QuZXhwcmVzc2lvbiA9IHRoaXMucmVwbGFjZUFsbChleHByZXNzaW9uT2JqZWN0LmV4cHJlc3Npb24sIGl0ZW0sIHJlcGxhY2VyKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgcmVwbGFjZUFsbChvcmlnaW5hbFZhbHVlOiBzdHJpbmcsIHNlYXJjaDogc3RyaW5nLCByZXBsYWNlcjogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gb3JpZ2luYWxWYWx1ZS5zcGxpdChzZWFyY2gpLmpvaW4ocmVwbGFjZXIpO1xyXG4gIH1cclxufSJdfQ==