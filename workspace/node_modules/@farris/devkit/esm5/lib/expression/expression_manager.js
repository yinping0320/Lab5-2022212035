import * as tslib_1 from "tslib";
import { Inject, Injectable, Injector } from "@angular/core";
import { BigNumber } from 'bignumber.js';
import { EMPTY, of } from "rxjs";
import { FrameContext } from "../frame/index";
import { Repository } from "../repository/index";
import { ENTITY_TEMPLATE, ResolveService } from "../resolver/index";
import { ExpressionUtil } from "../utils/expression_util";
import { ExpressionExecutor } from "./expression_executor";
import { ExpressionRegistry } from "./expression_registry";
import { Expression } from './types';
import { ExpressionResult } from "./expression_result";
import { MESSAGE_SERVICE_TOKEN, NOTIFY_SERVICE_TOKEN } from "../core/index";
import { TranslateToken } from "../i18n";
var ExpressionManager = /** @class */ (function () {
    function ExpressionManager(injector, resolveService, expressionExecutor, expressionRegistry, expressionResult, messageService, notifyService) {
        this.injector = injector;
        this.resolveService = resolveService;
        this.expressionExecutor = expressionExecutor;
        this.expressionRegistry = expressionRegistry;
        this.expressionResult = expressionResult;
        this.messageService = messageService;
        this.notifyService = notifyService;
        this.frameContext = null;
        this.frameContext = this.injector.get(FrameContext, null);
    }
    /**
     * 根据表达式id进行计算
     * @param expressionId 表达式id
     * @param viewModel viewModel
     * @param rowData rowData
     * @returns
     */
    ExpressionManager.prototype.eval = function (expressionId, viewModel, rowData) {
        var expressionObject = this.expressionRegistry.getExpressionById(expressionId);
        if (expressionObject) {
            var customContext = {};
            var bindingPath = viewModel && viewModel.bindingPath || null;
            if (bindingPath && rowData) {
                var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
                var bindingList = this.frameContext.bindingData.getValue(bindingPaths);
                var primaryKey = 'id';
                if (bindingList) {
                    primaryKey = bindingList.primaryKey;
                }
                var primaryValue = rowData[primaryKey] || bindingList.currentId;
                if (primaryValue) {
                    customContext.currentRows = [{ bindingPath: bindingPaths.join('/'), primaryValue: primaryValue }];
                }
            }
            var result = this.execute(expressionObject.expression, customContext);
            if (expressionObject.type === Expression.ExpressionType.Readonly || expressionObject.type === Expression.ExpressionType.Required || expressionObject.type === Expression.ExpressionType.Visible) {
                result = result === true ? true : false;
            }
            this.expressionResult.set(expressionId, result);
            return result;
        }
        else {
            // console.warn('ExpressionManager 执行失败，未获取到表达式!');
        }
        return undefined;
    };
    ExpressionManager.prototype.validate = function (expressionId, options) {
        var expressionObject = this.expressionRegistry.getExpressionById(expressionId);
        if (expressionObject) {
            var patch = options && options.patch || null;
            var customContext = {};
            if (patch) {
                customContext.patch = patch;
            }
            var currentRow = options.currentRow || null;
            var currentRows = options.currentRows || [];
            if (currentRow) {
                customContext.currentRows = customContext.currentRows || [];
                customContext.currentRows.push(currentRow);
            }
            if (currentRows && currentRows.length > 0) {
                customContext.currentRows = customContext.currentRows || [];
                Array.prototype.push.apply(customContext.currentRows, currentRows);
            }
            var result = this.execute(expressionObject.expression, customContext);
            this.expressionResult.set(expressionId, result);
            return result;
        }
        else {
        }
        return undefined;
    };
    /**
     * 帮助前封装
     * @param event
     */
    ExpressionManager.prototype.onDataPicking = function (configs) {
        var expressionId = configs && configs.expressionId || null;
        if (!expressionId) {
            return of(true);
        }
        var result = this.eval(expressionId);
        if (!result) {
            var expressionObject = this.expressionRegistry.getExpressionById(expressionId);
            if (!expressionObject) {
                return of(true);
            }
            var messageType = expressionObject.messageType || Expression.MessageType.warning;
            var message = expressionObject.message;
            if (message) {
                this.notifyService[messageType](message, { hideTitle: true });
            }
            return EMPTY;
        }
        return of(result);
    };
    /**
     * 执行表达式计算
     * @param expression 表达式
     * @param customContext 自定义上下文
     * @returns
     */
    ExpressionManager.prototype.execute = function (expression, customContext) {
        var _a;
        var deps = this.resolveService.resolve(expression);
        var groupDependencies = ExpressionUtil.getGroupFunctionDependency(expression, this.frameContext.repository.entityTypeInfo);
        var entityContext = this.buildEntityContext(deps, groupDependencies, customContext);
        var stateContext = this.buildStateContext();
        var data = customContext && customContext.contexts || null;
        var translate = this.injector.get(TranslateToken, null);
        var context = tslib_1.__assign((_a = {}, _a[this.entityOriginalNodeCode] = entityContext, _a), stateContext, { BigNumber: BigNumber, frameContext: this.frameContext, bindingData: this.frameContext.bindingData, repository: this.frameContext.repository, CurrentLanguage: translate.getCurrentLanguage() || 'zh-CHS' }, data);
        if (!entityContext) {
            return undefined;
        }
        return this.expressionExecutor.eval(expression, context);
    };
    /**
     * 执行表达式（返回可观察对象）
     * @param expression 表达式
     * @param customContext 自定义上下文
     * @returns
     */
    ExpressionManager.prototype.executeAsync = function (expression, customContext) {
        var result = this.execute(expression, customContext);
        return of(result);
    };
    /**
     * 构造实体上下文
     * @param deps
     * @param groupDependencies
     * @param context
     * @returns
     */
    ExpressionManager.prototype.buildEntityContext = function (deps, groupDependencies, context) {
        var _this = this;
        var currentRows = context && context.currentRows || null;
        var index = deps.findIndex(function (dep) {
            var isEntityDependency = _this.isEntityDependency(dep);
            // 如果依赖的是state，无需处理，现在需要确定的是返回多少实体的问题，和state没有关系
            // 表达式依赖了实体
            if (isEntityDependency) {
                var isGroupDependency = groupDependencies.findIndex(function (item) { return item === dep; }) !== -1;
                // 是聚合依赖
                if (isGroupDependency) {
                    var dependencyLength = dep.split('/').filter(function (p) { return p; }).length - 1;
                    if (dependencyLength === 1) {
                        // 聚合了主表字段，所有主表数据都需要参与运算，此时已经确定计算的实体上下文了。
                        return true;
                    }
                    else {
                        // 聚合了子表字段，只需要传递当前实体
                        return false;
                    }
                }
                else {
                    // 当前依赖不是聚合，只需要传递当前实体
                    return false;
                }
            }
            return false;
        });
        var isGroupdMainEntity = index !== -1;
        var options = {};
        if (currentRows && currentRows.length > 0) {
            currentRows.forEach(function (currentRow) {
                options[currentRow.bindingPath || '/'] = currentRow.primaryValue;
            });
        }
        var entity = this.getEntity(options);
        var patch = context && context.patch || null;
        if (!entity) {
            return {};
        }
        if (patch && Object.keys(patch).length > 0) {
            Object.keys(patch).forEach(function (key) {
                var paths = key.split('/').filter(function (p) { return p; });
                var value = patch[key];
                _this.setValue(entity, paths, value);
            });
        }
        if (isGroupdMainEntity) {
            var collection = this.frameContext.repository.entityCollection.toJSON();
            entity['__type__'] = 'List';
            entity['__items__'] = collection;
        }
        return entity;
    };
    ExpressionManager.prototype.setValue = function (target, paths, value) {
        if (paths.length === 1) {
            target[paths[0]] = value;
        }
        else {
            var propertyName = paths.pop();
            var result = paths.reduce(function (object, path) {
                return object && object[path];
            }, target);
            result[propertyName] = value;
        }
    };
    /**
     * 是否为实体依赖
     * @param dep
     * @returns
     */
    ExpressionManager.prototype.isEntityDependency = function (dep) {
        return dep.startsWith(ENTITY_TEMPLATE);
    };
    /**
     * 获取实体
     * @param options
     * @returns
     */
    ExpressionManager.prototype.getEntity = function (options) {
        var _this = this;
        var entityTypeInfo = this.frameContext.repository.entityTypeInfo;
        var bindingData = this.frameContext.bindingData;
        var childrenEntityPaths = [];
        var entity = null;
        if (options['/']) {
            // 修正主表
            entity = this.frameContext.bindingData.list.findById(options['/']);
            if (entity) {
                entity = entity.toJSON();
            }
        }
        else {
            entity = this.frameContext.bindingData.list.currentItem.toJSON();
        }
        if (!entity) {
            return null;
        }
        ExpressionUtil.getChildrenEntityPaths(entityTypeInfo, childrenEntityPaths);
        entity['__type__'] = 'Entity';
        if (!childrenEntityPaths || childrenEntityPaths.length < 1) {
            return entity;
        }
        // 找到所有子表
        childrenEntityPaths.forEach(function (paths) {
            var row = null;
            if (options && options[paths.join('/')]) {
                var parentPaths = paths.slice(0, 1);
                if (paths.length == 2 && options[parentPaths.join('/')]) {
                    var parentRow = options[parentPaths.join('/')];
                    // 从从表
                    // 需要切换上级表
                    row = _this.getPropertyValue(entity, parentPaths.concat([parentRow, paths[1], options[paths.join('/')]]));
                }
                else {
                    // 不应该使用bindingData，这样就默认使用了当前行
                    var bindingList = bindingData.getValue(paths);
                    var currentRowId = options[paths.join('/')];
                    var currentRow = null;
                    if (currentRowId !== bindingList.currentId) {
                        currentRow = bindingList.findById(currentRowId);
                    }
                    else {
                        currentRow = bindingList.currentItem;
                    }
                    if (currentRow && currentRow.primaryKeyValue) {
                        row = currentRow.toJSON();
                    }
                }
            }
            else {
                // 如果上级表已经切换了当前行，那么下级表也应该切换
                var parentTableCurrentRowChanged = options && !!Object.keys(options).find(function (path) {
                    var fullPath = path.split('/').join('/');
                    return paths.join('/').startsWith(fullPath);
                }) || false;
                if (parentTableCurrentRowChanged) {
                    var primaryValue = options && options['/'] || bindingData.list.currentId;
                    var entity_1 = _this.frameContext.repository.entityCollection.getEntityById(primaryValue);
                    var fullPaths_1 = [];
                    var data = paths.reduce(function (object, path) {
                        fullPaths_1.push(path);
                        var item = object && object[path];
                        if (item) {
                            var currentRowId = options && options[fullPaths_1.join('/')] || item.items[0] && item.items[0].primaryValue || null;
                            if (currentRowId) {
                                var currentRow = item.get(currentRowId);
                                return currentRow || null;
                            }
                        }
                        return null;
                    }, entity_1);
                    if (data) {
                        row = data.toJSON();
                    }
                    else {
                        row = {};
                    }
                }
                else {
                    row = ExpressionUtil.getCurrentRowByPaths(paths, bindingData);
                }
            }
            var propertyName = paths.pop();
            var parent = paths.reduce(function (object, path) {
                return object && object[path] || null;
            }, entity);
            var list = parent[propertyName];
            var node = tslib_1.__assign({ __items__: [] }, row && row || {}, { __type__: 'List' });
            node.length = function () { return node.__items__.length; };
            if (list && Array.isArray(list)) {
                node.__items__ = [].concat(list);
            }
            parent[propertyName] = node;
        });
        return entity;
    };
    ExpressionManager.prototype.getPropertyValue = function (entity, paths) {
        return paths.reduce(function (object, path) {
            if (object['__type__'] === 'List') {
                return object['__items__'].find(function (item) { return item.id === path; });
            }
            else if (Array.isArray(object)) {
                return object.find(function (item) { return item.id === path; });
            }
            else {
                return object && object[path];
            }
        }, entity);
    };
    Object.defineProperty(ExpressionManager.prototype, "entityOriginalNodeCode", {
        /**
         * 获取主实体原始字段名
         */
        get: function () {
            var repository = this.injector.get(Repository);
            return repository && repository.entityTypeInfo && repository.entityTypeInfo.entityInfo && repository.entityTypeInfo.entityInfo.originalCode || null;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 构造变量上下文
     * @param event
     * @returns
     */
    ExpressionManager.prototype.buildStateContext = function () {
        var result = {};
        if (this.frameContext) {
            var rootFrameContext = this.frameContext.getVirtualRootFrameContext();
            if (rootFrameContext) {
                var uiState_1 = rootFrameContext.viewModel.uiState;
                var propertyNames = Object.getOwnPropertyNames(uiState_1) || [];
                propertyNames.forEach(function (prop) {
                    if (prop.match(/^[a-zA-Z0-9_\$]+$/g) !== null) {
                        result[prop] = uiState_1[prop];
                    }
                });
            }
        }
        return result;
    };
    ExpressionManager.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ExpressionManager.ctorParameters = function () { return [
        { type: Injector },
        { type: ResolveService },
        { type: ExpressionExecutor },
        { type: ExpressionRegistry },
        { type: ExpressionResult },
        { type: undefined, decorators: [{ type: Inject, args: [MESSAGE_SERVICE_TOKEN,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [NOTIFY_SERVICE_TOKEN,] }] }
    ]; };
    return ExpressionManager;
}());
export { ExpressionManager };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl9tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZXhwcmVzc2lvbi9leHByZXNzaW9uX21hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBRXpDLE9BQU8sRUFBRSxLQUFLLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRTdDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDakQsT0FBTyxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDM0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUVyQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQW1DLHFCQUFxQixFQUFFLG9CQUFvQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTdHLE9BQU8sRUFBYSxjQUFjLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFcEQ7SUFHRSwyQkFBb0IsUUFBa0IsRUFBVSxjQUE4QixFQUFVLGtCQUFzQyxFQUFVLGtCQUFzQyxFQUFVLGdCQUFrQyxFQUF5QyxjQUErQixFQUF3QyxhQUE2QjtRQUFuVixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQVUsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUFVLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFBVSxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQXlDLG1CQUFjLEdBQWQsY0FBYyxDQUFpQjtRQUF3QyxrQkFBYSxHQUFiLGFBQWEsQ0FBZ0I7UUFEL1YsaUJBQVksR0FBaUIsSUFBSSxDQUFDO1FBRXhDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQWUsWUFBWSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzFFLENBQUM7SUFDRDs7Ozs7O09BTUc7SUFDSSxnQ0FBSSxHQUFYLFVBQVksWUFBb0IsRUFBRSxTQUFxQixFQUFFLE9BQWE7UUFDcEUsSUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsaUJBQWlCLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDakYsSUFBSSxnQkFBZ0IsRUFBRTtZQUNwQixJQUFNLGFBQWEsR0FBOEIsRUFBRSxDQUFDO1lBQ3BELElBQU0sV0FBVyxHQUFHLFNBQVMsSUFBSSxTQUFTLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQztZQUMvRCxJQUFJLFdBQVcsSUFBSSxPQUFPLEVBQUU7Z0JBQzFCLElBQU0sWUFBWSxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFELENBQUMsQ0FBQyxDQUFDO2dCQUMzRCxJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFnQixDQUFDO2dCQUN4RixJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUM7Z0JBQ3RCLElBQUksV0FBVyxFQUFFO29CQUNmLFVBQVUsR0FBRyxXQUFXLENBQUMsVUFBVSxDQUFDO2lCQUNyQztnQkFDRCxJQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksV0FBVyxDQUFDLFNBQVMsQ0FBQztnQkFDbEUsSUFBSSxZQUFZLEVBQUU7b0JBQ2hCLGFBQWEsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxFQUFFLFdBQVcsRUFBRSxZQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLFlBQVksY0FBQSxFQUFFLENBQUMsQ0FBQztpQkFDckY7YUFDRjtZQUNELElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1lBQ3RFLElBQUksZ0JBQWdCLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxjQUFjLENBQUMsUUFBUSxJQUFJLGdCQUFnQixDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsY0FBYyxDQUFDLFFBQVEsSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUU7Z0JBQy9MLE1BQU0sR0FBRyxNQUFNLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQzthQUN6QztZQUNELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ2hELE9BQU8sTUFBTSxDQUFDO1NBQ2Y7YUFBTTtZQUNMLG1EQUFtRDtTQUNwRDtRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFDTSxvQ0FBUSxHQUFmLFVBQWdCLFlBQW9CLEVBQUUsT0FBWTtRQUNoRCxJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNqRixJQUFJLGdCQUFnQixFQUFFO1lBQ3BCLElBQU0sS0FBSyxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQztZQUMvQyxJQUFNLGFBQWEsR0FBOEIsRUFBRSxDQUFDO1lBQ3BELElBQUksS0FBSyxFQUFFO2dCQUNULGFBQWEsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO2FBQzdCO1lBQ0QsSUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUM7WUFDOUMsSUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUM7WUFDOUMsSUFBSSxVQUFVLEVBQUU7Z0JBQ2QsYUFBYSxDQUFDLFdBQVcsR0FBRyxhQUFhLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQztnQkFDNUQsYUFBYSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7YUFDNUM7WUFDRCxJQUFJLFdBQVcsSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDekMsYUFBYSxDQUFDLFdBQVcsR0FBRyxhQUFhLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQztnQkFDNUQsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLENBQUE7YUFDbkU7WUFDRCxJQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLFVBQVUsRUFBRSxhQUFhLENBQUMsQ0FBQztZQUN4RSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxNQUFNLENBQUMsQ0FBQztZQUNoRCxPQUFPLE1BQU0sQ0FBQztTQUNmO2FBQU07U0FDTjtRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFDRDs7O09BR0c7SUFDSSx5Q0FBYSxHQUFwQixVQUFxQixPQUFpQztRQUNwRCxJQUFNLFlBQVksR0FBRyxPQUFPLElBQUksT0FBTyxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUM7UUFDN0QsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNqQixPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNqQjtRQUNELElBQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNYLElBQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGlCQUFpQixDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ2pGLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtnQkFDckIsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDakI7WUFDRCxJQUFNLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQyxXQUFXLElBQUksVUFBVSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUM7WUFDbkYsSUFBTSxPQUFPLEdBQUcsZ0JBQWdCLENBQUMsT0FBTyxDQUFDO1lBQ3pDLElBQUksT0FBTyxFQUFFO2dCQUNYLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7YUFDL0Q7WUFDRCxPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDcEIsQ0FBQztJQUNEOzs7OztPQUtHO0lBQ0ssbUNBQU8sR0FBZixVQUFnQixVQUFrQixFQUFFLGFBQXlDOztRQUMzRSxJQUFNLElBQUksR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNyRCxJQUFNLGlCQUFpQixHQUFHLGNBQWMsQ0FBQywwQkFBMEIsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDN0gsSUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxpQkFBaUIsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUN0RixJQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUM5QyxJQUFNLElBQUksR0FBRyxhQUFhLElBQUksYUFBYSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUM7UUFDN0QsSUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQVksY0FBYyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3JFLElBQU0sT0FBTyxpQ0FDVixJQUFJLENBQUMsc0JBQXNCLElBQUcsYUFBYSxPQUN6QyxZQUFZLElBQ2YsU0FBUyxXQUFBLEVBQ1QsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQy9CLFdBQVcsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFDMUMsVUFBVSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUN4QyxlQUFlLEVBQUUsU0FBUyxDQUFDLGtCQUFrQixFQUFFLElBQUksUUFBUSxJQUN4RCxJQUFJLENBQ1IsQ0FBQTtRQUNELElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDbEIsT0FBTyxTQUFTLENBQUM7U0FDbEI7UUFDRCxPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFDRDs7Ozs7T0FLRztJQUNLLHdDQUFZLEdBQXBCLFVBQXFCLFVBQWtCLEVBQUUsYUFBeUM7UUFDaEYsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDdkQsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDcEIsQ0FBQztJQUNEOzs7Ozs7T0FNRztJQUNLLDhDQUFrQixHQUExQixVQUEyQixJQUFjLEVBQUUsaUJBQTJCLEVBQUUsT0FBbUM7UUFBM0csaUJBb0RDO1FBbERDLElBQU0sV0FBVyxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQztRQUMzRCxJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQUMsR0FBVztZQUN2QyxJQUFNLGtCQUFrQixHQUFHLEtBQUksQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN4RCxnREFBZ0Q7WUFDaEQsV0FBVztZQUNYLElBQUksa0JBQWtCLEVBQUU7Z0JBQ3RCLElBQU0saUJBQWlCLEdBQUcsaUJBQWlCLENBQUMsU0FBUyxDQUFDLFVBQUEsSUFBSSxJQUFJLE9BQUEsSUFBSSxLQUFLLEdBQUcsRUFBWixDQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDbkYsUUFBUTtnQkFDUixJQUFJLGlCQUFpQixFQUFFO29CQUNyQixJQUFNLGdCQUFnQixHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFELENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7b0JBQ2xFLElBQUksZ0JBQWdCLEtBQUssQ0FBQyxFQUFFO3dCQUMxQix5Q0FBeUM7d0JBQ3pDLE9BQU8sSUFBSSxDQUFDO3FCQUNiO3lCQUFNO3dCQUNMLG9CQUFvQjt3QkFDcEIsT0FBTyxLQUFLLENBQUM7cUJBQ2Q7aUJBQ0Y7cUJBQU07b0JBQ0wscUJBQXFCO29CQUNyQixPQUFPLEtBQUssQ0FBQztpQkFDZDthQUNGO1lBQ0QsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDLENBQUMsQ0FBQTtRQUNGLElBQU0sa0JBQWtCLEdBQUcsS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBRXhDLElBQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNuQixJQUFJLFdBQVcsSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN6QyxXQUFXLENBQUMsT0FBTyxDQUFDLFVBQUMsVUFBa0M7Z0JBQ3JELE9BQU8sQ0FBQyxVQUFVLENBQUMsV0FBVyxJQUFJLEdBQUcsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxZQUFZLENBQUM7WUFDbkUsQ0FBQyxDQUFDLENBQUM7U0FDSjtRQUNELElBQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdkMsSUFBTSxLQUFLLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDO1FBQy9DLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxPQUFPLEVBQUUsQ0FBQztTQUNYO1FBQ0QsSUFBSSxLQUFLLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUMsR0FBVztnQkFDckMsSUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEVBQUQsQ0FBQyxDQUFDLENBQUM7Z0JBQzVDLElBQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDekIsS0FBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3RDLENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxJQUFJLGtCQUFrQixFQUFFO1lBQ3RCLElBQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQzFFLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxNQUFNLENBQUM7WUFDNUIsTUFBTSxDQUFDLFdBQVcsQ0FBQyxHQUFHLFVBQVUsQ0FBQztTQUNsQztRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFDTyxvQ0FBUSxHQUFoQixVQUFpQixNQUFXLEVBQUUsS0FBZSxFQUFFLEtBQVU7UUFDdkQsSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUN0QixNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDO1NBQzFCO2FBQU07WUFDTCxJQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDakMsSUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFDLE1BQVcsRUFBRSxJQUFZO2dCQUNwRCxPQUFPLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDaEMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ1gsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLEtBQUssQ0FBQztTQUM5QjtJQUNILENBQUM7SUFDRDs7OztPQUlHO0lBQ0ssOENBQWtCLEdBQTFCLFVBQTJCLEdBQVc7UUFDcEMsT0FBTyxHQUFHLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFDRDs7OztPQUlHO0lBQ0kscUNBQVMsR0FBaEIsVUFBaUIsT0FBMEM7UUFBM0QsaUJBMkZDO1FBMUZDLElBQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQztRQUNuRSxJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQztRQUNsRCxJQUFNLG1CQUFtQixHQUFHLEVBQUUsQ0FBQztRQUUvQixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUM7UUFDbEIsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDaEIsT0FBTztZQUNQLE1BQU0sR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ25FLElBQUksTUFBTSxFQUFFO2dCQUNWLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7YUFDMUI7U0FDRjthQUFNO1lBQ0wsTUFBTSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDbEU7UUFDRCxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ1gsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELGNBQWMsQ0FBQyxzQkFBc0IsQ0FBQyxjQUFjLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztRQUMzRSxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsUUFBUSxDQUFDO1FBQzlCLElBQUksQ0FBQyxtQkFBbUIsSUFBSSxtQkFBbUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzFELE9BQU8sTUFBTSxDQUFDO1NBQ2Y7UUFDRCxTQUFTO1FBQ1QsbUJBQW1CLENBQUMsT0FBTyxDQUFDLFVBQUMsS0FBZTtZQUMxQyxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUM7WUFDZixJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO2dCQUN2QyxJQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDdEMsSUFBSSxLQUFLLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxPQUFPLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO29CQUN2RCxJQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUNqRCxNQUFNO29CQUNOLFVBQVU7b0JBQ1YsR0FBRyxHQUFHLEtBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDMUc7cUJBQU07b0JBQ0wsK0JBQStCO29CQUMvQixJQUFNLFdBQVcsR0FBZ0IsV0FBVyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQWdCLENBQUM7b0JBQzVFLElBQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7b0JBQzlDLElBQUksVUFBVSxHQUFrQixJQUFJLENBQUM7b0JBQ3JDLElBQUksWUFBWSxLQUFLLFdBQVcsQ0FBQyxTQUFTLEVBQUU7d0JBQzFDLFVBQVUsR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDO3FCQUNqRDt5QkFBTTt3QkFDTCxVQUFVLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQztxQkFDdEM7b0JBQ0QsSUFBSSxVQUFVLElBQUksVUFBVSxDQUFDLGVBQWUsRUFBRTt3QkFDNUMsR0FBRyxHQUFHLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztxQkFDM0I7aUJBQ0Y7YUFDRjtpQkFBTTtnQkFDTCwyQkFBMkI7Z0JBQzNCLElBQU0sNEJBQTRCLEdBQUcsT0FBTyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLElBQUk7b0JBQzlFLElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUMzQyxPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUM5QyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUM7Z0JBQ1osSUFBSSw0QkFBNEIsRUFBRTtvQkFDaEMsSUFBTSxZQUFZLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztvQkFDM0UsSUFBTSxRQUFNLEdBQUcsS0FBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO29CQUN6RixJQUFNLFdBQVMsR0FBRyxFQUFFLENBQUM7b0JBQ3JCLElBQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBQyxNQUFNLEVBQUUsSUFBSTt3QkFDckMsV0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzt3QkFDckIsSUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQXVCLENBQUM7d0JBQzFELElBQUksSUFBSSxFQUFFOzRCQUNSLElBQU0sWUFBWSxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsV0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDOzRCQUNwSCxJQUFJLFlBQVksRUFBRTtnQ0FDaEIsSUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztnQ0FDMUMsT0FBTyxVQUFVLElBQUksSUFBSSxDQUFDOzZCQUMzQjt5QkFDRjt3QkFDRCxPQUFPLElBQUksQ0FBQztvQkFDZCxDQUFDLEVBQUUsUUFBTSxDQUFXLENBQUM7b0JBQ3JCLElBQUksSUFBSSxFQUFFO3dCQUNSLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7cUJBQ3JCO3lCQUFNO3dCQUNMLEdBQUcsR0FBRyxFQUFFLENBQUM7cUJBQ1Y7aUJBQ0Y7cUJBQU07b0JBQ0wsR0FBRyxHQUFHLGNBQWMsQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDLENBQUM7aUJBQy9EO2FBQ0Y7WUFDRCxJQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDakMsSUFBSSxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFDLE1BQVcsRUFBRSxJQUFZO2dCQUNsRCxPQUFPLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDO1lBQ3hDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUNYLElBQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNsQyxJQUFNLElBQUksc0JBQVUsU0FBUyxFQUFFLEVBQUUsSUFBSyxHQUFHLElBQUksR0FBRyxJQUFJLEVBQUUsSUFBRSxRQUFRLEVBQUUsTUFBTSxHQUFFLENBQUM7WUFDM0UsSUFBSSxDQUFDLE1BQU0sR0FBRyxjQUFNLE9BQUEsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQXJCLENBQXFCLENBQUM7WUFDMUMsSUFBSSxJQUFJLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDL0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ2xDO1lBQ0QsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLElBQUksQ0FBQztRQUM5QixDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFDTyw0Q0FBZ0IsR0FBeEIsVUFBeUIsTUFBVyxFQUFFLEtBQWU7UUFDbkQsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQUMsTUFBVyxFQUFFLElBQVk7WUFDNUMsSUFBSSxNQUFNLENBQUMsVUFBVSxDQUFDLEtBQUssTUFBTSxFQUFFO2dCQUNqQyxPQUFPLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQSxJQUFJLElBQUksT0FBQSxJQUFJLENBQUMsRUFBRSxLQUFLLElBQUksRUFBaEIsQ0FBZ0IsQ0FBQyxDQUFDO2FBQzNEO2lCQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDaEMsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQUEsSUFBSSxJQUFJLE9BQUEsSUFBSSxDQUFDLEVBQUUsS0FBSyxJQUFJLEVBQWhCLENBQWdCLENBQUMsQ0FBQzthQUM5QztpQkFBTTtnQkFDTCxPQUFPLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDL0I7UUFDSCxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDYixDQUFDO0lBSUQsc0JBQWMscURBQXNCO1FBSHBDOztXQUVHO2FBQ0g7WUFDRSxJQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUNqRCxPQUFPLFVBQVUsSUFBSSxVQUFVLENBQUMsY0FBYyxJQUFJLFVBQVUsQ0FBQyxjQUFjLENBQUMsVUFBVSxJQUFJLFVBQVUsQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUM7UUFDdEosQ0FBQzs7O09BQUE7SUFDRDs7OztPQUlHO0lBQ0ksNkNBQWlCLEdBQXhCO1FBQ0UsSUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNyQixJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztZQUN4RSxJQUFJLGdCQUFnQixFQUFFO2dCQUNwQixJQUFNLFNBQU8sR0FBRyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDO2dCQUNuRCxJQUFNLGFBQWEsR0FBRyxNQUFNLENBQUMsbUJBQW1CLENBQUMsU0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNoRSxhQUFhLENBQUMsT0FBTyxDQUFDLFVBQUMsSUFBWTtvQkFDakMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLEtBQUssSUFBSSxFQUFFO3dCQUM3QyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsU0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO3FCQUM5QjtnQkFDSCxDQUFDLENBQUMsQ0FBQzthQUNKO1NBQ0Y7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDOztnQkF0VkYsVUFBVTs7OztnQkFsQmtCLFFBQVE7Z0JBT1gsY0FBYztnQkFFL0Isa0JBQWtCO2dCQUNsQixrQkFBa0I7Z0JBR2xCLGdCQUFnQjtnREFRc00sTUFBTSxTQUFDLHFCQUFxQjtnREFBNEMsTUFBTSxTQUFDLG9CQUFvQjs7SUFvVmxVLHdCQUFDO0NBQUEsQUF2VkQsSUF1VkM7U0F0VlksaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IEJpZ051bWJlciB9IGZyb20gJ2JpZ251bWJlci5qcyc7XHJcbmltcG9ydCB7IEJpbmRpbmdEYXRhLCBCaW5kaW5nTGlzdCwgQmluZGluZ09iamVjdCB9IGZyb20gXCIuLi9iaW5kaW5nLWRhdGEvaW5kZXhcIjtcclxuaW1wb3J0IHsgRU1QVFksIE9ic2VydmFibGUsIG9mIH0gZnJvbSBcInJ4anNcIjtcclxuaW1wb3J0IHsgQXBwQ29udGV4dCB9IGZyb20gXCIuLi9hcHAvaW5kZXhcIjtcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0IH0gZnJvbSBcIi4uL2ZyYW1lL2luZGV4XCI7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tIFwiLi4vcmVwb3NpdG9yeS9pbmRleFwiO1xyXG5pbXBvcnQgeyBFTlRJVFlfVEVNUExBVEUsIFJlc29sdmVTZXJ2aWNlIH0gZnJvbSBcIi4uL3Jlc29sdmVyL2luZGV4XCI7XHJcbmltcG9ydCB7IEV4cHJlc3Npb25VdGlsIH0gZnJvbSBcIi4uL3V0aWxzL2V4cHJlc3Npb25fdXRpbFwiO1xyXG5pbXBvcnQgeyBFeHByZXNzaW9uRXhlY3V0b3IgfSBmcm9tIFwiLi9leHByZXNzaW9uX2V4ZWN1dG9yXCI7XHJcbmltcG9ydCB7IEV4cHJlc3Npb25SZWdpc3RyeSB9IGZyb20gXCIuL2V4cHJlc3Npb25fcmVnaXN0cnlcIjtcclxuaW1wb3J0IHsgRXhwcmVzc2lvbiB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBWaWV3TW9kZWwgfSBmcm9tIFwiLi4vdmlldy1tb2RlbC9pbmRleFwiO1xyXG5pbXBvcnQgeyBFeHByZXNzaW9uUmVzdWx0IH0gZnJvbSBcIi4vZXhwcmVzc2lvbl9yZXN1bHRcIjtcclxuaW1wb3J0IHsgSU1lc3NhZ2VTZXJ2aWNlLCBJTm90aWZ5U2VydmljZSwgTUVTU0FHRV9TRVJWSUNFX1RPS0VOLCBOT1RJRllfU0VSVklDRV9UT0tFTiB9IGZyb20gXCIuLi9jb3JlL2luZGV4XCI7XHJcbmltcG9ydCB7IEVudGl0eSwgRW50aXR5TGlzdCB9IGZyb20gXCIuLi9lbnRpdHlcIjtcclxuaW1wb3J0IHsgVHJhbnNsYXRlLCBUcmFuc2xhdGVUb2tlbiB9IGZyb20gXCIuLi9pMThuXCI7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBFeHByZXNzaW9uTWFuYWdlciB7XHJcbiAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCA9IG51bGw7XHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgcmVzb2x2ZVNlcnZpY2U6IFJlc29sdmVTZXJ2aWNlLCBwcml2YXRlIGV4cHJlc3Npb25FeGVjdXRvcjogRXhwcmVzc2lvbkV4ZWN1dG9yLCBwcml2YXRlIGV4cHJlc3Npb25SZWdpc3RyeTogRXhwcmVzc2lvblJlZ2lzdHJ5LCBwcml2YXRlIGV4cHJlc3Npb25SZXN1bHQ6IEV4cHJlc3Npb25SZXN1bHQsIEBJbmplY3QoTUVTU0FHRV9TRVJWSUNFX1RPS0VOKSBwcml2YXRlIG1lc3NhZ2VTZXJ2aWNlOiBJTWVzc2FnZVNlcnZpY2UsIEBJbmplY3QoTk9USUZZX1NFUlZJQ0VfVE9LRU4pIHByaXZhdGUgbm90aWZ5U2VydmljZTogSU5vdGlmeVNlcnZpY2UpIHtcclxuICAgIHRoaXMuZnJhbWVDb250ZXh0ID0gdGhpcy5pbmplY3Rvci5nZXQ8RnJhbWVDb250ZXh0PihGcmFtZUNvbnRleHQsIG51bGwpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmoLnmja7ooajovr7lvI9pZOi/m+ihjOiuoeeul1xyXG4gICAqIEBwYXJhbSBleHByZXNzaW9uSWQg6KGo6L6+5byPaWRcclxuICAgKiBAcGFyYW0gdmlld01vZGVsIHZpZXdNb2RlbFxyXG4gICAqIEBwYXJhbSByb3dEYXRhIHJvd0RhdGFcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZXZhbChleHByZXNzaW9uSWQ6IHN0cmluZywgdmlld01vZGVsPzogVmlld01vZGVsLCByb3dEYXRhPzogYW55KSB7XHJcbiAgICBjb25zdCBleHByZXNzaW9uT2JqZWN0ID0gdGhpcy5leHByZXNzaW9uUmVnaXN0cnkuZ2V0RXhwcmVzc2lvbkJ5SWQoZXhwcmVzc2lvbklkKTtcclxuICAgIGlmIChleHByZXNzaW9uT2JqZWN0KSB7XHJcbiAgICAgIGNvbnN0IGN1c3RvbUNvbnRleHQ6IEV4cHJlc3Npb24uSUN1c3RvbUNvbnRleHQgPSB7fTtcclxuICAgICAgY29uc3QgYmluZGluZ1BhdGggPSB2aWV3TW9kZWwgJiYgdmlld01vZGVsLmJpbmRpbmdQYXRoIHx8IG51bGw7XHJcbiAgICAgIGlmIChiaW5kaW5nUGF0aCAmJiByb3dEYXRhKSB7XHJcbiAgICAgICAgY29uc3QgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgICAgICBjb25zdCBiaW5kaW5nTGlzdCA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldFZhbHVlKGJpbmRpbmdQYXRocykgYXMgQmluZGluZ0xpc3Q7XHJcbiAgICAgICAgbGV0IHByaW1hcnlLZXkgPSAnaWQnO1xyXG4gICAgICAgIGlmIChiaW5kaW5nTGlzdCkge1xyXG4gICAgICAgICAgcHJpbWFyeUtleSA9IGJpbmRpbmdMaXN0LnByaW1hcnlLZXk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHByaW1hcnlWYWx1ZSA9IHJvd0RhdGFbcHJpbWFyeUtleV0gfHwgYmluZGluZ0xpc3QuY3VycmVudElkO1xyXG4gICAgICAgIGlmIChwcmltYXJ5VmFsdWUpIHtcclxuICAgICAgICAgIGN1c3RvbUNvbnRleHQuY3VycmVudFJvd3MgPSBbeyBiaW5kaW5nUGF0aDogYmluZGluZ1BhdGhzLmpvaW4oJy8nKSwgcHJpbWFyeVZhbHVlIH1dO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBsZXQgcmVzdWx0ID0gdGhpcy5leGVjdXRlKGV4cHJlc3Npb25PYmplY3QuZXhwcmVzc2lvbiwgY3VzdG9tQ29udGV4dCk7XHJcbiAgICAgIGlmIChleHByZXNzaW9uT2JqZWN0LnR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuUmVhZG9ubHkgfHwgZXhwcmVzc2lvbk9iamVjdC50eXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLlJlcXVpcmVkIHx8IGV4cHJlc3Npb25PYmplY3QudHlwZSA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5WaXNpYmxlKSB7XHJcbiAgICAgICAgcmVzdWx0ID0gcmVzdWx0ID09PSB0cnVlID8gdHJ1ZSA6IGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuZXhwcmVzc2lvblJlc3VsdC5zZXQoZXhwcmVzc2lvbklkLCByZXN1bHQpO1xyXG4gICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gY29uc29sZS53YXJuKCdFeHByZXNzaW9uTWFuYWdlciDmiafooYzlpLHotKXvvIzmnKrojrflj5bliLDooajovr7lvI8hJyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIH1cclxuICBwdWJsaWMgdmFsaWRhdGUoZXhwcmVzc2lvbklkOiBzdHJpbmcsIG9wdGlvbnM6IGFueSkge1xyXG4gICAgY29uc3QgZXhwcmVzc2lvbk9iamVjdCA9IHRoaXMuZXhwcmVzc2lvblJlZ2lzdHJ5LmdldEV4cHJlc3Npb25CeUlkKGV4cHJlc3Npb25JZCk7XHJcbiAgICBpZiAoZXhwcmVzc2lvbk9iamVjdCkge1xyXG4gICAgICBjb25zdCBwYXRjaCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5wYXRjaCB8fCBudWxsO1xyXG4gICAgICBjb25zdCBjdXN0b21Db250ZXh0OiBFeHByZXNzaW9uLklDdXN0b21Db250ZXh0ID0ge307XHJcbiAgICAgIGlmIChwYXRjaCkge1xyXG4gICAgICAgIGN1c3RvbUNvbnRleHQucGF0Y2ggPSBwYXRjaDtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBjdXJyZW50Um93ID0gb3B0aW9ucy5jdXJyZW50Um93IHx8IG51bGw7XHJcbiAgICAgIGNvbnN0IGN1cnJlbnRSb3dzID0gb3B0aW9ucy5jdXJyZW50Um93cyB8fCBbXTtcclxuICAgICAgaWYgKGN1cnJlbnRSb3cpIHtcclxuICAgICAgICBjdXN0b21Db250ZXh0LmN1cnJlbnRSb3dzID0gY3VzdG9tQ29udGV4dC5jdXJyZW50Um93cyB8fCBbXTtcclxuICAgICAgICBjdXN0b21Db250ZXh0LmN1cnJlbnRSb3dzLnB1c2goY3VycmVudFJvdyk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGN1cnJlbnRSb3dzICYmIGN1cnJlbnRSb3dzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjdXN0b21Db250ZXh0LmN1cnJlbnRSb3dzID0gY3VzdG9tQ29udGV4dC5jdXJyZW50Um93cyB8fCBbXTtcclxuICAgICAgICBBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseShjdXN0b21Db250ZXh0LmN1cnJlbnRSb3dzLCBjdXJyZW50Um93cylcclxuICAgICAgfVxyXG4gICAgICBjb25zdCByZXN1bHQgPSB0aGlzLmV4ZWN1dGUoZXhwcmVzc2lvbk9iamVjdC5leHByZXNzaW9uLCBjdXN0b21Db250ZXh0KTtcclxuICAgICAgdGhpcy5leHByZXNzaW9uUmVzdWx0LnNldChleHByZXNzaW9uSWQsIHJlc3VsdCk7XHJcbiAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5biu5Yqp5YmN5bCB6KOFXHJcbiAgICogQHBhcmFtIGV2ZW50IFxyXG4gICAqL1xyXG4gIHB1YmxpYyBvbkRhdGFQaWNraW5nKGNvbmZpZ3M6IHsgZXhwcmVzc2lvbklkOiBzdHJpbmcgfSkge1xyXG4gICAgY29uc3QgZXhwcmVzc2lvbklkID0gY29uZmlncyAmJiBjb25maWdzLmV4cHJlc3Npb25JZCB8fCBudWxsO1xyXG4gICAgaWYgKCFleHByZXNzaW9uSWQpIHtcclxuICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5ldmFsKGV4cHJlc3Npb25JZCk7XHJcbiAgICBpZiAoIXJlc3VsdCkge1xyXG4gICAgICBjb25zdCBleHByZXNzaW9uT2JqZWN0ID0gdGhpcy5leHByZXNzaW9uUmVnaXN0cnkuZ2V0RXhwcmVzc2lvbkJ5SWQoZXhwcmVzc2lvbklkKTtcclxuICAgICAgaWYgKCFleHByZXNzaW9uT2JqZWN0KSB7XHJcbiAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IG1lc3NhZ2VUeXBlID0gZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlVHlwZSB8fCBFeHByZXNzaW9uLk1lc3NhZ2VUeXBlLndhcm5pbmc7XHJcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBleHByZXNzaW9uT2JqZWN0Lm1lc3NhZ2U7XHJcbiAgICAgIGlmIChtZXNzYWdlKSB7XHJcbiAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlW21lc3NhZ2VUeXBlXShtZXNzYWdlLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gb2YocmVzdWx0KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5omn6KGM6KGo6L6+5byP6K6h566XXHJcbiAgICogQHBhcmFtIGV4cHJlc3Npb24g6KGo6L6+5byPXHJcbiAgICogQHBhcmFtIGN1c3RvbUNvbnRleHQg6Ieq5a6a5LmJ5LiK5LiL5paHXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBleGVjdXRlKGV4cHJlc3Npb246IHN0cmluZywgY3VzdG9tQ29udGV4dD86IEV4cHJlc3Npb24uSUN1c3RvbUNvbnRleHQpOiBhbnkge1xyXG4gICAgY29uc3QgZGVwcyA9IHRoaXMucmVzb2x2ZVNlcnZpY2UucmVzb2x2ZShleHByZXNzaW9uKTtcclxuICAgIGNvbnN0IGdyb3VwRGVwZW5kZW5jaWVzID0gRXhwcmVzc2lvblV0aWwuZ2V0R3JvdXBGdW5jdGlvbkRlcGVuZGVuY3koZXhwcmVzc2lvbiwgdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbyk7XHJcbiAgICBjb25zdCBlbnRpdHlDb250ZXh0ID0gdGhpcy5idWlsZEVudGl0eUNvbnRleHQoZGVwcywgZ3JvdXBEZXBlbmRlbmNpZXMsIGN1c3RvbUNvbnRleHQpO1xyXG4gICAgY29uc3Qgc3RhdGVDb250ZXh0ID0gdGhpcy5idWlsZFN0YXRlQ29udGV4dCgpO1xyXG4gICAgY29uc3QgZGF0YSA9IGN1c3RvbUNvbnRleHQgJiYgY3VzdG9tQ29udGV4dC5jb250ZXh0cyB8fCBudWxsO1xyXG4gICAgY29uc3QgdHJhbnNsYXRlID0gdGhpcy5pbmplY3Rvci5nZXQ8VHJhbnNsYXRlPihUcmFuc2xhdGVUb2tlbiwgbnVsbCk7XHJcbiAgICBjb25zdCBjb250ZXh0ID0ge1xyXG4gICAgICBbdGhpcy5lbnRpdHlPcmlnaW5hbE5vZGVDb2RlXTogZW50aXR5Q29udGV4dCxcclxuICAgICAgLi4uc3RhdGVDb250ZXh0LFxyXG4gICAgICBCaWdOdW1iZXIsXHJcbiAgICAgIGZyYW1lQ29udGV4dDogdGhpcy5mcmFtZUNvbnRleHQsXHJcbiAgICAgIGJpbmRpbmdEYXRhOiB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YSxcclxuICAgICAgcmVwb3NpdG9yeTogdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSxcclxuICAgICAgQ3VycmVudExhbmd1YWdlOiB0cmFuc2xhdGUuZ2V0Q3VycmVudExhbmd1YWdlKCkgfHwgJ3poLUNIUycsXHJcbiAgICAgIC4uLmRhdGFcclxuICAgIH1cclxuICAgIGlmICghZW50aXR5Q29udGV4dCkge1xyXG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuZXhwcmVzc2lvbkV4ZWN1dG9yLmV2YWwoZXhwcmVzc2lvbiwgY29udGV4dCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJp+ihjOihqOi+vuW8j++8iOi/lOWbnuWPr+inguWvn+Wvueixoe+8iVxyXG4gICAqIEBwYXJhbSBleHByZXNzaW9uIOihqOi+vuW8j1xyXG4gICAqIEBwYXJhbSBjdXN0b21Db250ZXh0IOiHquWumuS5ieS4iuS4i+aWh1xyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZXhlY3V0ZUFzeW5jKGV4cHJlc3Npb246IHN0cmluZywgY3VzdG9tQ29udGV4dD86IEV4cHJlc3Npb24uSUN1c3RvbUNvbnRleHQpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5leGVjdXRlKGV4cHJlc3Npb24sIGN1c3RvbUNvbnRleHQpO1xyXG4gICAgcmV0dXJuIG9mKHJlc3VsdCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWunuS9k+S4iuS4i+aWh1xyXG4gICAqIEBwYXJhbSBkZXBzIFxyXG4gICAqIEBwYXJhbSBncm91cERlcGVuZGVuY2llcyBcclxuICAgKiBAcGFyYW0gY29udGV4dCBcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkRW50aXR5Q29udGV4dChkZXBzOiBzdHJpbmdbXSwgZ3JvdXBEZXBlbmRlbmNpZXM6IHN0cmluZ1tdLCBjb250ZXh0PzogRXhwcmVzc2lvbi5JQ3VzdG9tQ29udGV4dCkge1xyXG5cclxuICAgIGNvbnN0IGN1cnJlbnRSb3dzID0gY29udGV4dCAmJiBjb250ZXh0LmN1cnJlbnRSb3dzIHx8IG51bGw7XHJcbiAgICBjb25zdCBpbmRleCA9IGRlcHMuZmluZEluZGV4KChkZXA6IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBpc0VudGl0eURlcGVuZGVuY3kgPSB0aGlzLmlzRW50aXR5RGVwZW5kZW5jeShkZXApO1xyXG4gICAgICAvLyDlpoLmnpzkvp3otZbnmoTmmK9zdGF0Ze+8jOaXoOmcgOWkhOeQhu+8jOeOsOWcqOmcgOimgeehruWumueahOaYr+i/lOWbnuWkmuWwkeWunuS9k+eahOmXrumimO+8jOWSjHN0YXRl5rKh5pyJ5YWz57O7XHJcbiAgICAgIC8vIOihqOi+vuW8j+S+nei1luS6huWunuS9k1xyXG4gICAgICBpZiAoaXNFbnRpdHlEZXBlbmRlbmN5KSB7XHJcbiAgICAgICAgY29uc3QgaXNHcm91cERlcGVuZGVuY3kgPSBncm91cERlcGVuZGVuY2llcy5maW5kSW5kZXgoaXRlbSA9PiBpdGVtID09PSBkZXApICE9PSAtMTtcclxuICAgICAgICAvLyDmmK/ogZrlkIjkvp3otZZcclxuICAgICAgICBpZiAoaXNHcm91cERlcGVuZGVuY3kpIHtcclxuICAgICAgICAgIGNvbnN0IGRlcGVuZGVuY3lMZW5ndGggPSBkZXAuc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS5sZW5ndGggLSAxO1xyXG4gICAgICAgICAgaWYgKGRlcGVuZGVuY3lMZW5ndGggPT09IDEpIHtcclxuICAgICAgICAgICAgLy8g6IGa5ZCI5LqG5Li76KGo5a2X5q6177yM5omA5pyJ5Li76KGo5pWw5o2u6YO96ZyA6KaB5Y+C5LiO6L+Q566X77yM5q2k5pe25bey57uP56Gu5a6a6K6h566X55qE5a6e5L2T5LiK5LiL5paH5LqG44CCXHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8g6IGa5ZCI5LqG5a2Q6KGo5a2X5q6177yM5Y+q6ZyA6KaB5Lyg6YCS5b2T5YmN5a6e5L2TXHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8g5b2T5YmN5L6d6LWW5LiN5piv6IGa5ZCI77yM5Y+q6ZyA6KaB5Lyg6YCS5b2T5YmN5a6e5L2TXHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH0pXHJcbiAgICBjb25zdCBpc0dyb3VwZE1haW5FbnRpdHkgPSBpbmRleCAhPT0gLTE7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHt9O1xyXG4gICAgaWYgKGN1cnJlbnRSb3dzICYmIGN1cnJlbnRSb3dzLmxlbmd0aCA+IDApIHtcclxuICAgICAgY3VycmVudFJvd3MuZm9yRWFjaCgoY3VycmVudFJvdzogRXhwcmVzc2lvbi5JQ3VycmVudFJvdykgPT4ge1xyXG4gICAgICAgIG9wdGlvbnNbY3VycmVudFJvdy5iaW5kaW5nUGF0aCB8fCAnLyddID0gY3VycmVudFJvdy5wcmltYXJ5VmFsdWU7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZW50aXR5ID0gdGhpcy5nZXRFbnRpdHkob3B0aW9ucyk7XHJcbiAgICBjb25zdCBwYXRjaCA9IGNvbnRleHQgJiYgY29udGV4dC5wYXRjaCB8fCBudWxsO1xyXG4gICAgaWYgKCFlbnRpdHkpIHtcclxuICAgICAgcmV0dXJuIHt9O1xyXG4gICAgfVxyXG4gICAgaWYgKHBhdGNoICYmIE9iamVjdC5rZXlzKHBhdGNoKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgIE9iamVjdC5rZXlzKHBhdGNoKS5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGNvbnN0IHBhdGhzID0ga2V5LnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgICAgY29uc3QgdmFsdWUgPSBwYXRjaFtrZXldO1xyXG4gICAgICAgIHRoaXMuc2V0VmFsdWUoZW50aXR5LCBwYXRocywgdmFsdWUpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIGlmIChpc0dyb3VwZE1haW5FbnRpdHkpIHtcclxuICAgICAgY29uc3QgY29sbGVjdGlvbiA9IHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi50b0pTT04oKTtcclxuICAgICAgZW50aXR5WydfX3R5cGVfXyddID0gJ0xpc3QnO1xyXG4gICAgICBlbnRpdHlbJ19faXRlbXNfXyddID0gY29sbGVjdGlvbjtcclxuICAgIH1cclxuICAgIHJldHVybiBlbnRpdHk7XHJcbiAgfVxyXG4gIHByaXZhdGUgc2V0VmFsdWUodGFyZ2V0OiBhbnksIHBhdGhzOiBzdHJpbmdbXSwgdmFsdWU6IGFueSkge1xyXG4gICAgaWYgKHBhdGhzLmxlbmd0aCA9PT0gMSkge1xyXG4gICAgICB0YXJnZXRbcGF0aHNbMF1dID0gdmFsdWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwYXRocy5wb3AoKTtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gcGF0aHMucmVkdWNlKChvYmplY3Q6IGFueSwgcGF0aDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIG9iamVjdCAmJiBvYmplY3RbcGF0aF07XHJcbiAgICAgIH0sIHRhcmdldCk7XHJcbiAgICAgIHJlc3VsdFtwcm9wZXJ0eU5hbWVdID0gdmFsdWU7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaYr+WQpuS4uuWunuS9k+S+nei1llxyXG4gICAqIEBwYXJhbSBkZXAgXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpc0VudGl0eURlcGVuZGVuY3koZGVwOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBkZXAuc3RhcnRzV2l0aChFTlRJVFlfVEVNUExBVEUpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5blrp7kvZNcclxuICAgKiBAcGFyYW0gb3B0aW9ucyBcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RW50aXR5KG9wdGlvbnM6IHsgW2JpbmRpbmdQYXRoOiBzdHJpbmddOiBzdHJpbmcgfSkge1xyXG4gICAgY29uc3QgZW50aXR5VHlwZUluZm8gPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvO1xyXG4gICAgY29uc3QgYmluZGluZ0RhdGEgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YTtcclxuICAgIGNvbnN0IGNoaWxkcmVuRW50aXR5UGF0aHMgPSBbXTtcclxuXHJcbiAgICBsZXQgZW50aXR5ID0gbnVsbDtcclxuICAgIGlmIChvcHRpb25zWycvJ10pIHtcclxuICAgICAgLy8g5L+u5q2j5Li76KGoXHJcbiAgICAgIGVudGl0eSA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuZmluZEJ5SWQob3B0aW9uc1snLyddKTtcclxuICAgICAgaWYgKGVudGl0eSkge1xyXG4gICAgICAgIGVudGl0eSA9IGVudGl0eS50b0pTT04oKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZW50aXR5ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SXRlbS50b0pTT04oKTtcclxuICAgIH1cclxuICAgIGlmICghZW50aXR5KSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgRXhwcmVzc2lvblV0aWwuZ2V0Q2hpbGRyZW5FbnRpdHlQYXRocyhlbnRpdHlUeXBlSW5mbywgY2hpbGRyZW5FbnRpdHlQYXRocyk7XHJcbiAgICBlbnRpdHlbJ19fdHlwZV9fJ10gPSAnRW50aXR5JztcclxuICAgIGlmICghY2hpbGRyZW5FbnRpdHlQYXRocyB8fCBjaGlsZHJlbkVudGl0eVBhdGhzLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIGVudGl0eTtcclxuICAgIH1cclxuICAgIC8vIOaJvuWIsOaJgOacieWtkOihqFxyXG4gICAgY2hpbGRyZW5FbnRpdHlQYXRocy5mb3JFYWNoKChwYXRoczogc3RyaW5nW10pID0+IHtcclxuICAgICAgbGV0IHJvdyA9IG51bGw7XHJcbiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnNbcGF0aHMuam9pbignLycpXSkge1xyXG4gICAgICAgIGNvbnN0IHBhcmVudFBhdGhzID0gcGF0aHMuc2xpY2UoMCwgMSk7XHJcbiAgICAgICAgaWYgKHBhdGhzLmxlbmd0aCA9PSAyICYmIG9wdGlvbnNbcGFyZW50UGF0aHMuam9pbignLycpXSkge1xyXG4gICAgICAgICAgY29uc3QgcGFyZW50Um93ID0gb3B0aW9uc1twYXJlbnRQYXRocy5qb2luKCcvJyldO1xyXG4gICAgICAgICAgLy8g5LuO5LuO6KGoXHJcbiAgICAgICAgICAvLyDpnIDopoHliIfmjaLkuIrnuqfooahcclxuICAgICAgICAgIHJvdyA9IHRoaXMuZ2V0UHJvcGVydHlWYWx1ZShlbnRpdHksIHBhcmVudFBhdGhzLmNvbmNhdChbcGFyZW50Um93LCBwYXRoc1sxXSwgb3B0aW9uc1twYXRocy5qb2luKCcvJyldXSkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyDkuI3lupTor6Xkvb/nlKhiaW5kaW5nRGF0Ye+8jOi/meagt+Wwsem7mOiupOS9v+eUqOS6huW9k+WJjeihjFxyXG4gICAgICAgICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xyXG4gICAgICAgICAgY29uc3QgY3VycmVudFJvd0lkID0gb3B0aW9uc1twYXRocy5qb2luKCcvJyldO1xyXG4gICAgICAgICAgbGV0IGN1cnJlbnRSb3c6IEJpbmRpbmdPYmplY3QgPSBudWxsO1xyXG4gICAgICAgICAgaWYgKGN1cnJlbnRSb3dJZCAhPT0gYmluZGluZ0xpc3QuY3VycmVudElkKSB7XHJcbiAgICAgICAgICAgIGN1cnJlbnRSb3cgPSBiaW5kaW5nTGlzdC5maW5kQnlJZChjdXJyZW50Um93SWQpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY3VycmVudFJvdyA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgaWYgKGN1cnJlbnRSb3cgJiYgY3VycmVudFJvdy5wcmltYXJ5S2V5VmFsdWUpIHtcclxuICAgICAgICAgICAgcm93ID0gY3VycmVudFJvdy50b0pTT04oKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8g5aaC5p6c5LiK57qn6KGo5bey57uP5YiH5o2i5LqG5b2T5YmN6KGM77yM6YKj5LmI5LiL57qn6KGo5Lmf5bqU6K+l5YiH5o2iXHJcbiAgICAgICAgY29uc3QgcGFyZW50VGFibGVDdXJyZW50Um93Q2hhbmdlZCA9IG9wdGlvbnMgJiYgISFPYmplY3Qua2V5cyhvcHRpb25zKS5maW5kKHBhdGggPT4ge1xyXG4gICAgICAgICAgY29uc3QgZnVsbFBhdGggPSBwYXRoLnNwbGl0KCcvJykuam9pbignLycpO1xyXG4gICAgICAgICAgcmV0dXJuIHBhdGhzLmpvaW4oJy8nKS5zdGFydHNXaXRoKGZ1bGxQYXRoKTtcclxuICAgICAgICB9KSB8fCBmYWxzZTtcclxuICAgICAgICBpZiAocGFyZW50VGFibGVDdXJyZW50Um93Q2hhbmdlZCkge1xyXG4gICAgICAgICAgY29uc3QgcHJpbWFyeVZhbHVlID0gb3B0aW9ucyAmJiBvcHRpb25zWycvJ10gfHwgYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XHJcbiAgICAgICAgICBjb25zdCBlbnRpdHkgPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChwcmltYXJ5VmFsdWUpO1xyXG4gICAgICAgICAgY29uc3QgZnVsbFBhdGhzID0gW107XHJcbiAgICAgICAgICBjb25zdCBkYXRhID0gcGF0aHMucmVkdWNlKChvYmplY3QsIHBhdGgpID0+IHtcclxuICAgICAgICAgICAgZnVsbFBhdGhzLnB1c2gocGF0aCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSBvYmplY3QgJiYgb2JqZWN0W3BhdGhdIGFzIEVudGl0eUxpc3Q8RW50aXR5PjtcclxuICAgICAgICAgICAgaWYgKGl0ZW0pIHtcclxuICAgICAgICAgICAgICBjb25zdCBjdXJyZW50Um93SWQgPSBvcHRpb25zICYmIG9wdGlvbnNbZnVsbFBhdGhzLmpvaW4oJy8nKV0gfHwgaXRlbS5pdGVtc1swXSAmJiBpdGVtLml0ZW1zWzBdLnByaW1hcnlWYWx1ZSB8fCBudWxsO1xyXG4gICAgICAgICAgICAgIGlmIChjdXJyZW50Um93SWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRSb3cgPSBpdGVtLmdldChjdXJyZW50Um93SWQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRSb3cgfHwgbnVsbDtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICB9LCBlbnRpdHkpIGFzIEVudGl0eTtcclxuICAgICAgICAgIGlmIChkYXRhKSB7XHJcbiAgICAgICAgICAgIHJvdyA9IGRhdGEudG9KU09OKCk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByb3cgPSB7fTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcm93ID0gRXhwcmVzc2lvblV0aWwuZ2V0Q3VycmVudFJvd0J5UGF0aHMocGF0aHMsIGJpbmRpbmdEYXRhKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gcGF0aHMucG9wKCk7XHJcbiAgICAgIGxldCBwYXJlbnQgPSBwYXRocy5yZWR1Y2UoKG9iamVjdDogYW55LCBwYXRoOiBzdHJpbmcpID0+IHtcclxuICAgICAgICByZXR1cm4gb2JqZWN0ICYmIG9iamVjdFtwYXRoXSB8fCBudWxsO1xyXG4gICAgICB9LCBlbnRpdHkpO1xyXG4gICAgICBjb25zdCBsaXN0ID0gcGFyZW50W3Byb3BlcnR5TmFtZV07XHJcbiAgICAgIGNvbnN0IG5vZGU6IGFueSA9IHsgX19pdGVtc19fOiBbXSwgLi4ucm93ICYmIHJvdyB8fCB7fSwgX190eXBlX186ICdMaXN0JyB9O1xyXG4gICAgICBub2RlLmxlbmd0aCA9ICgpID0+IG5vZGUuX19pdGVtc19fLmxlbmd0aDtcclxuICAgICAgaWYgKGxpc3QgJiYgQXJyYXkuaXNBcnJheShsaXN0KSkge1xyXG4gICAgICAgIG5vZGUuX19pdGVtc19fID0gW10uY29uY2F0KGxpc3QpO1xyXG4gICAgICB9XHJcbiAgICAgIHBhcmVudFtwcm9wZXJ0eU5hbWVdID0gbm9kZTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGVudGl0eTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRQcm9wZXJ0eVZhbHVlKGVudGl0eTogYW55LCBwYXRoczogc3RyaW5nW10pIHtcclxuICAgIHJldHVybiBwYXRocy5yZWR1Y2UoKG9iamVjdDogYW55LCBwYXRoOiBzdHJpbmcpID0+IHtcclxuICAgICAgaWYgKG9iamVjdFsnX190eXBlX18nXSA9PT0gJ0xpc3QnKSB7XHJcbiAgICAgICAgcmV0dXJuIG9iamVjdFsnX19pdGVtc19fJ10uZmluZChpdGVtID0+IGl0ZW0uaWQgPT09IHBhdGgpO1xyXG4gICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkob2JqZWN0KSkge1xyXG4gICAgICAgIHJldHVybiBvYmplY3QuZmluZChpdGVtID0+IGl0ZW0uaWQgPT09IHBhdGgpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBvYmplY3QgJiYgb2JqZWN0W3BhdGhdO1xyXG4gICAgICB9XHJcbiAgICB9LCBlbnRpdHkpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bkuLvlrp7kvZPljp/lp4vlrZfmrrXlkI1cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0IGVudGl0eU9yaWdpbmFsTm9kZUNvZGUoKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IHJlcG9zaXRvcnkgPSB0aGlzLmluamVjdG9yLmdldChSZXBvc2l0b3J5KTtcclxuICAgIHJldHVybiByZXBvc2l0b3J5ICYmIHJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8gJiYgcmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mby5lbnRpdHlJbmZvICYmIHJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8uZW50aXR5SW5mby5vcmlnaW5hbENvZGUgfHwgbnVsbDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Y+Y6YeP5LiK5LiL5paHXHJcbiAgICogQHBhcmFtIGV2ZW50IFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBidWlsZFN0YXRlQ29udGV4dCgpIHtcclxuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xyXG4gICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIGNvbnN0IHJvb3RGcmFtZUNvbnRleHQgPSB0aGlzLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpO1xyXG4gICAgICBpZiAocm9vdEZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgIGNvbnN0IHVpU3RhdGUgPSByb290RnJhbWVDb250ZXh0LnZpZXdNb2RlbC51aVN0YXRlO1xyXG4gICAgICAgIGNvbnN0IHByb3BlcnR5TmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh1aVN0YXRlKSB8fCBbXTtcclxuICAgICAgICBwcm9wZXJ0eU5hbWVzLmZvckVhY2goKHByb3A6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgaWYgKHByb3AubWF0Y2goL15bYS16QS1aMC05X1xcJF0rJC9nKSAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICByZXN1bHRbcHJvcF0gPSB1aVN0YXRlW3Byb3BdO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxufSJdfQ==