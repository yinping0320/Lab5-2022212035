import * as tslib_1 from "tslib";
import { ModifyType } from "../changeset";
import { Entity } from "./entity";
import { DynamicFactory, EntityFactory } from "./entity_factory";
import { EntityList } from "./entity_list";
import { FieldMetadataUtil } from "./metadata";
import { PARENT_CLASS, PARENT_PATH } from "./types";
var EntityTypeCreator = /** @class */ (function () {
    function EntityTypeCreator() {
    }
    EntityTypeCreator.create = function (constructor, data) {
        var entityType = this.getType(constructor);
        var entity = new entityType(data);
        entity.constructor = constructor;
        return entity;
    };
    // @Cache({ key: ((context: any, args: any[]) => { return args[0] }), provider: new MemoryCacheProvider() })
    EntityTypeCreator.createType = function (constructor) {
        var entityType = /** @class */ (function (_super) {
            tslib_1.__extends(EntityType, _super);
            function EntityType(data) {
                return _super.call(this, data) || this;
            }
            return EntityType;
        }(Entity));
        var entityPrototype = entityType.prototype;
        this.extendProperties(constructor, entityPrototype);
        return entityType;
    };
    EntityTypeCreator.extendProperties = function (constructor, entityPrototype) {
        var ngFields = FieldMetadataUtil.getNgFields(constructor);
        var ngObjects = FieldMetadataUtil.getNgObjects(constructor);
        var ngLists = FieldMetadataUtil.getNgList(constructor);
        var ngDynamic = FieldMetadataUtil.getNgDynamic(constructor);
        this.extendPlainProperty(entityPrototype, ngFields);
        this.extendListProperty(entityPrototype, ngLists);
        this.extendObjectProperty(entityPrototype, ngObjects);
        this.extendDynamicProperty(entityPrototype, ngDynamic);
    };
    EntityTypeCreator.extendPlainProperty = function (entityPrototype, ngFields) {
        Object.keys(ngFields).forEach(function (propName) {
            var ngField = ngFields[propName];
            // const dataField = ngField.dataField || propName;
            Object.defineProperty(entityPrototype, propName, {
                get: function () {
                    var value = this.getPropValue(propName, ngField);
                    return value;
                },
                set: function (newPropValue) {
                    // 值相同时不触发变更。
                    var oldPropValue = this.getPropValue(propName, ngField);
                    if (this.isPropValueChanged(propName, ngField, newPropValue, oldPropValue) === false) {
                        return;
                    }
                    this.setPropValue(propName, ngField, newPropValue);
                    var changeSetValue = this.preparePropValue(propName, ngField, newPropValue);
                    this.emitValueChange(propName, ngField, newPropValue, oldPropValue, changeSetValue);
                }
            });
        });
    };
    EntityTypeCreator.extendListProperty = function (entityPrototype, ngListMetadata) {
        Object.keys(ngListMetadata).forEach(function (propertyName) {
            var key = "__" + propertyName + "__";
            Object.defineProperty(entityPrototype, propertyName, {
                get: function () {
                    var _this = this;
                    var entityList = this[key];
                    if (!entityList) {
                        var fieldMetadata_1 = ngListMetadata[propertyName];
                        var path = this.createPath(propertyName);
                        var dataField = fieldMetadata_1.dataField || propertyName;
                        var val = this.data[dataField];
                        entityList = new EntityList();
                        entityList[PARENT_CLASS] = this;
                        entityList[PARENT_PATH] = path;
                        if (val) {
                            var entities = val.map(function (v) { return EntityFactory(fieldMetadata_1.type, v); });
                            entityList.loadEntities(entities);
                        }
                        entityList.onListChanged.subscribe(function (value) {
                            if (value) {
                                if (entityList[PARENT_PATH][0] !== value.path[0]) {
                                    value.path = entityList[PARENT_PATH].concat(value.path);
                                }
                                _this.setChanges(value);
                            }
                        });
                        this[key] = entityList;
                    }
                    return entityList;
                },
                set: function (value) {
                    this[key] = value;
                }
            });
        });
    };
    EntityTypeCreator.extendObjectProperty = function (entityPrototype, ngObjectMetadata) {
        Object.keys(ngObjectMetadata).forEach(function (propertyName) {
            var fieldMetadata = ngObjectMetadata[propertyName];
            var key = "__" + propertyName + "__";
            // 如果没有值用一个空对象代替
            Object.defineProperty(entityPrototype, propertyName, {
                get: function () {
                    var childEntity = this[key];
                    var path = this.createPath(propertyName);
                    if (!childEntity) {
                        var dataField = fieldMetadata.dataField || propertyName;
                        // val不存在时，用空对象代替
                        var val = this.data[dataField] || {};
                        childEntity = EntityTypeCreator.buildEntity(path, val, this, fieldMetadata);
                        this[key] = childEntity;
                    }
                    return childEntity;
                },
                set: function (value) {
                    var path = this.createPath(propertyName);
                    var modifyInfo = {
                        path: path,
                        value: value.data,
                        preValue: this[propertyName].data,
                        type: ModifyType.ValueChange
                    };
                    var childEntity = EntityTypeCreator.buildEntity(path, value, this, fieldMetadata);
                    this[key] = childEntity;
                    this.setChanges(modifyInfo);
                }
            });
        });
    };
    EntityTypeCreator.extendDynamicProperty = function (entityPrototype, ngDynamicMetadata) {
        Object.keys(ngDynamicMetadata).forEach(function (propertyName) {
            var fieldMetadata = ngDynamicMetadata[propertyName];
            var key = "__" + propertyName + "__";
            Object.defineProperty(entityPrototype, propertyName, {
                get: function () {
                    var dynamicEntity = this[key];
                    var path = this.createPath(propertyName);
                    if (!dynamicEntity) {
                        var dataField = fieldMetadata.dataField || propertyName;
                        var originalData = this.data[dataField] || {};
                        dynamicEntity = EntityTypeCreator.buildDynamic(path, originalData, this, fieldMetadata);
                        this[key] = dynamicEntity;
                    }
                    return dynamicEntity;
                },
                set: function (value) {
                    var path = this.createPath(propertyName);
                    var modifyInfo = {
                        path: path,
                        value: value.data,
                        preValue: this[propertyName].data,
                        type: ModifyType.ValueChange
                    };
                    var dynamicEntity = EntityTypeCreator.buildDynamic(path, value, this, fieldMetadata);
                    this[key] = dynamicEntity;
                    this.setChanges(modifyInfo);
                }
            });
        });
    };
    EntityTypeCreator.getType = function (constructor) {
        if (this.buffer.has(constructor)) {
            return this.buffer.get(constructor);
        }
        var entityType = this.createType(constructor);
        this.buffer.set(constructor, entityType);
        return entityType;
    };
    EntityTypeCreator.buildEntity = function (parentPath, value, parent, fieldMetadata) {
        var instance;
        if (value instanceof fieldMetadata.type) {
            instance = value;
        }
        else {
            instance = EntityFactory(fieldMetadata.type, value);
        }
        instance[PARENT_CLASS] = parent;
        instance[PARENT_PATH] = parentPath;
        instance.onValueChanged.subscribe(function (changes) {
            if (changes) {
                changes.path = (parent[PARENT_PATH] || []).concat(changes.path);
                var change = Object.assign({}, changes, { fromParent: true });
                parent.setChanges(change);
            }
        });
        return instance;
    };
    EntityTypeCreator.buildDynamic = function (parentPath, value, parent, fieldMetadata) {
        var instance;
        if (value instanceof fieldMetadata.type) {
            instance = value;
        }
        else {
            instance = DynamicFactory(fieldMetadata.type, value);
        }
        instance[PARENT_CLASS] = parent;
        instance[PARENT_PATH] = parentPath;
        instance.onValueChanged.subscribe(function (changes) {
            if (changes) {
                changes.path = (parent[PARENT_PATH] || []).concat(changes.path);
                parent.setChanges(changes);
            }
        });
        return instance;
    };
    EntityTypeCreator.buffer = new Map();
    return EntityTypeCreator;
}());
export { EntityTypeCreator };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X3R5cGVfY3JlYXRvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2VudGl0eS9lbnRpdHlfdHlwZV9jcmVhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEMsT0FBTyxFQUFFLGNBQWMsRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxpQkFBaUIsRUFBd0UsTUFBTSxZQUFZLENBQUM7QUFDckgsT0FBTyxFQUFhLFlBQVksRUFBRSxXQUFXLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFL0Q7SUFBQTtJQW9NQSxDQUFDO0lBbE1lLHdCQUFNLEdBQXBCLFVBQXFCLFdBQXFCLEVBQUUsSUFBUztRQUNuRCxJQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzdDLElBQU0sTUFBTSxHQUFHLElBQUksVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BDLE1BQU0sQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQ2pDLE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFDRCw0R0FBNEc7SUFDOUYsNEJBQVUsR0FBeEIsVUFBeUIsV0FBcUI7UUFDNUMsSUFBTSxVQUFVO1lBQTRCLHNDQUFNO1lBQ2hELG9CQUFZLElBQVM7dUJBQ25CLGtCQUFNLElBQUksQ0FBQztZQUNiLENBQUM7WUFDSCxpQkFBQztRQUFELENBQUMsQUFKa0IsQ0FBeUIsTUFBTSxFQUlqRCxDQUFDO1FBQ0YsSUFBTSxlQUFlLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQztRQUM3QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBQ3BELE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7SUFDYyxrQ0FBZ0IsR0FBL0IsVUFBZ0MsV0FBcUIsRUFBRSxlQUF1QjtRQUM1RSxJQUFNLFFBQVEsR0FBRyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDNUQsSUFBTSxTQUFTLEdBQUcsaUJBQWlCLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzlELElBQU0sT0FBTyxHQUFHLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN6RCxJQUFNLFNBQVMsR0FBRyxpQkFBaUIsQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDOUQsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGVBQWUsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsa0JBQWtCLENBQUMsZUFBZSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxlQUFlLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDdEQsSUFBSSxDQUFDLHFCQUFxQixDQUFDLGVBQWUsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRWMscUNBQW1CLEdBQWxDLFVBQW1DLGVBQXVCLEVBQUUsUUFBNEM7UUFDdEcsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxRQUFRO1lBQzlDLElBQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQW9CLENBQUM7WUFDdEQsbURBQW1EO1lBQ25ELE1BQU0sQ0FBQyxjQUFjLENBQUMsZUFBZSxFQUFFLFFBQVEsRUFBRTtnQkFDL0MsR0FBRyxFQUFFO29CQUNILElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO29CQUNuRCxPQUFPLEtBQUssQ0FBQztnQkFDZixDQUFDO2dCQUNELEdBQUcsRUFBRSxVQUFVLFlBQVk7b0JBQ3pCLGFBQWE7b0JBQ2IsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7b0JBQzFELElBQUksSUFBSSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLFlBQVksQ0FBQyxLQUFLLEtBQUssRUFBRTt3QkFDcEYsT0FBTztxQkFDUjtvQkFDRCxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsWUFBWSxDQUFDLENBQUM7b0JBQ25ELElBQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLFlBQVksQ0FBQyxDQUFDO29CQUM5RSxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxjQUFjLENBQUMsQ0FBQztnQkFDdEYsQ0FBQzthQUNGLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNjLG9DQUFrQixHQUFqQyxVQUFrQyxlQUF1QixFQUFFLGNBQWlEO1FBQzFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsWUFBWTtZQUN4RCxJQUFNLEdBQUcsR0FBRyxPQUFLLFlBQVksT0FBSSxDQUFDO1lBQ2xDLE1BQU0sQ0FBQyxjQUFjLENBQUMsZUFBZSxFQUFFLFlBQVksRUFBRTtnQkFDbkQsR0FBRyxFQUFFO29CQUFBLGlCQXlCSjtvQkF4QkMsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUMzQixJQUFJLENBQUMsVUFBVSxFQUFFO3dCQUNmLElBQU0sZUFBYSxHQUFHLGNBQWMsQ0FBQyxZQUFZLENBQW1CLENBQUM7d0JBQ3JFLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUM7d0JBQzNDLElBQU0sU0FBUyxHQUFHLGVBQWEsQ0FBQyxTQUFTLElBQUksWUFBWSxDQUFDO3dCQUMxRCxJQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO3dCQUNqQyxVQUFVLEdBQUcsSUFBSSxVQUFVLEVBQTZCLENBQUM7d0JBQ3pELFVBQVUsQ0FBQyxZQUFZLENBQUMsR0FBRyxJQUFJLENBQUM7d0JBQ2hDLFVBQVUsQ0FBQyxXQUFXLENBQUMsR0FBRyxJQUFJLENBQUM7d0JBQy9CLElBQUksR0FBRyxFQUFFOzRCQUNQLElBQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxhQUFhLENBQTRCLGVBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQS9ELENBQStELENBQUMsQ0FBQzs0QkFDL0YsVUFBVSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQzt5QkFDbkM7d0JBQ0QsVUFBVSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsVUFBQSxLQUFLOzRCQUN0QyxJQUFJLEtBQUssRUFBRTtnQ0FDVCxJQUFJLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFO29DQUNoRCxLQUFLLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO2lDQUN6RDtnQ0FDRCxLQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDOzZCQUN4Qjt3QkFDSCxDQUFDLENBQUMsQ0FBQzt3QkFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsVUFBVSxDQUFDO3FCQUN4QjtvQkFDRCxPQUFPLFVBQVUsQ0FBQztnQkFDcEIsQ0FBQztnQkFDRCxHQUFHLEVBQUUsVUFBVSxLQUFLO29CQUNsQixJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO2dCQUNwQixDQUFDO2FBQ0YsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ2Msc0NBQW9CLEdBQW5DLFVBQW9DLGVBQXVCLEVBQUUsZ0JBQXFEO1FBQ2hILE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxZQUFZO1lBQzFELElBQU0sYUFBYSxHQUFHLGdCQUFnQixDQUFDLFlBQVksQ0FBcUIsQ0FBQztZQUN6RSxJQUFNLEdBQUcsR0FBRyxPQUFLLFlBQVksT0FBSSxDQUFDO1lBQ2xDLGdCQUFnQjtZQUNoQixNQUFNLENBQUMsY0FBYyxDQUFDLGVBQWUsRUFBRSxZQUFZLEVBQUU7Z0JBQ25ELEdBQUcsRUFBRTtvQkFDSCxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQzVCLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUM7b0JBQzNDLElBQUksQ0FBQyxXQUFXLEVBQUU7d0JBQ2hCLElBQU0sU0FBUyxHQUFHLGFBQWEsQ0FBQyxTQUFTLElBQUksWUFBWSxDQUFDO3dCQUMxRCxpQkFBaUI7d0JBQ2pCLElBQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO3dCQUN2QyxXQUFXLEdBQUcsaUJBQWlCLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLGFBQWEsQ0FBQyxDQUFDO3dCQUM1RSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsV0FBVyxDQUFDO3FCQUN6QjtvQkFDRCxPQUFPLFdBQVcsQ0FBQztnQkFDckIsQ0FBQztnQkFDRCxHQUFHLEVBQUUsVUFBVSxLQUFVO29CQUN2QixJQUFNLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDO29CQUMzQyxJQUFNLFVBQVUsR0FBRzt3QkFDakIsSUFBSSxFQUFFLElBQUk7d0JBQ1YsS0FBSyxFQUFFLEtBQUssQ0FBQyxJQUFJO3dCQUNqQixRQUFRLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUk7d0JBQ2pDLElBQUksRUFBRSxVQUFVLENBQUMsV0FBVztxQkFDN0IsQ0FBQztvQkFDRixJQUFNLFdBQVcsR0FBRyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsYUFBYSxDQUFDLENBQUM7b0JBQ3BGLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxXQUFXLENBQUM7b0JBQ3hCLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQzlCLENBQUM7YUFDRixDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDYyx1Q0FBcUIsR0FBcEMsVUFBcUMsZUFBdUIsRUFBRSxpQkFBdUQ7UUFDbkgsTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLFlBQVk7WUFDM0QsSUFBTSxhQUFhLEdBQUcsaUJBQWlCLENBQUMsWUFBWSxDQUFzQixDQUFDO1lBQzNFLElBQU0sR0FBRyxHQUFHLE9BQUssWUFBWSxPQUFJLENBQUM7WUFFbEMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxlQUFlLEVBQUUsWUFBWSxFQUFFO2dCQUNuRCxHQUFHLEVBQUU7b0JBQ0gsSUFBSSxhQUFhLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUM5QixJQUFNLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDO29CQUMzQyxJQUFJLENBQUMsYUFBYSxFQUFFO3dCQUNsQixJQUFNLFNBQVMsR0FBRyxhQUFhLENBQUMsU0FBUyxJQUFJLFlBQVksQ0FBQzt3QkFDMUQsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUM7d0JBQ2hELGFBQWEsR0FBRyxpQkFBaUIsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUUsYUFBYSxDQUFDLENBQUM7d0JBQ3hGLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxhQUFhLENBQUM7cUJBQzNCO29CQUNELE9BQU8sYUFBYSxDQUFDO2dCQUN2QixDQUFDO2dCQUNELEdBQUcsRUFBRSxVQUFVLEtBQUs7b0JBQ2xCLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUM7b0JBQzNDLElBQU0sVUFBVSxHQUFHO3dCQUNqQixJQUFJLEVBQUUsSUFBSTt3QkFDVixLQUFLLEVBQUUsS0FBSyxDQUFDLElBQUk7d0JBQ2pCLFFBQVEsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsSUFBSTt3QkFDakMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxXQUFXO3FCQUM3QixDQUFDO29CQUNGLElBQUksYUFBYSxHQUFHLGlCQUFpQixDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQztvQkFDckYsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLGFBQWEsQ0FBQztvQkFDMUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDOUIsQ0FBQzthQUNGLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNjLHlCQUFPLEdBQXRCLFVBQXVCLFdBQXFCO1FBQzFDLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEVBQUU7WUFDaEMsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUNyQztRQUNELElBQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ3pDLE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7SUFDYyw2QkFBVyxHQUExQixVQUEyQixVQUFvQixFQUFFLEtBQVUsRUFBRSxNQUFXLEVBQUUsYUFBbUQ7UUFDM0gsSUFBSSxRQUFRLENBQUM7UUFDYixJQUFJLEtBQUssWUFBWSxhQUFhLENBQUMsSUFBSSxFQUFFO1lBQ3ZDLFFBQVEsR0FBRyxLQUFLLENBQUM7U0FDbEI7YUFBTTtZQUNMLFFBQVEsR0FBRyxhQUFhLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztTQUNyRDtRQUNELFFBQVEsQ0FBQyxZQUFZLENBQUMsR0FBRyxNQUFNLENBQUM7UUFDaEMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxHQUFHLFVBQVUsQ0FBQztRQUNuQyxRQUFRLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxVQUFBLE9BQU87WUFDdkMsSUFBSSxPQUFPLEVBQUU7Z0JBQ1gsT0FBTyxDQUFDLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNoRSxJQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxPQUFPLEVBQUUsRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztnQkFDaEUsTUFBTSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQzthQUMzQjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztJQUNjLDhCQUFZLEdBQTNCLFVBQTRCLFVBQW9CLEVBQUUsS0FBVSxFQUFFLE1BQVcsRUFBRSxhQUFtRDtRQUM1SCxJQUFJLFFBQVEsQ0FBQztRQUNiLElBQUksS0FBSyxZQUFZLGFBQWEsQ0FBQyxJQUFJLEVBQUU7WUFDdkMsUUFBUSxHQUFHLEtBQUssQ0FBQztTQUNsQjthQUFNO1lBQ0wsUUFBUSxHQUFHLGNBQWMsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ3REO1FBQ0QsUUFBUSxDQUFDLFlBQVksQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUNoQyxRQUFRLENBQUMsV0FBVyxDQUFDLEdBQUcsVUFBVSxDQUFDO1FBQ25DLFFBQVEsQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLFVBQUEsT0FBTztZQUN2QyxJQUFJLE9BQU8sRUFBRTtnQkFDWCxPQUFPLENBQUMsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2hFLE1BQU0sQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7YUFDNUI7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFsTWMsd0JBQU0sR0FBRyxJQUFJLEdBQUcsRUFBWSxDQUFDO0lBbU05Qyx3QkFBQztDQUFBLEFBcE1ELElBb01DO1NBcE1ZLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1vZGlmeVR5cGUgfSBmcm9tIFwiLi4vY2hhbmdlc2V0XCI7XHJcbmltcG9ydCB7IEVudGl0eSB9IGZyb20gXCIuL2VudGl0eVwiO1xyXG5pbXBvcnQgeyBEeW5hbWljRmFjdG9yeSwgRW50aXR5RmFjdG9yeSB9IGZyb20gXCIuL2VudGl0eV9mYWN0b3J5XCI7XHJcbmltcG9ydCB7IEVudGl0eUxpc3QgfSBmcm9tIFwiLi9lbnRpdHlfbGlzdFwiO1xyXG5pbXBvcnQgeyBGaWVsZE1ldGFkYXRhVXRpbCwgTmdEeW5hbWljUHJvcGVydHksIE5nRmllbGRQcm9wZXJ0eSwgTmdMaXN0UHJvcGVydHksIE5nT2JqZWN0UHJvcGVydHkgfSBmcm9tIFwiLi9tZXRhZGF0YVwiO1xyXG5pbXBvcnQgeyBDbGFzc1R5cGUsIFBBUkVOVF9DTEFTUywgUEFSRU5UX1BBVEggfSBmcm9tIFwiLi90eXBlc1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIEVudGl0eVR5cGVDcmVhdG9yIHtcclxuICBwcml2YXRlIHN0YXRpYyBidWZmZXIgPSBuZXcgTWFwPGFueSwgYW55PigpO1xyXG4gIHB1YmxpYyBzdGF0aWMgY3JlYXRlKGNvbnN0cnVjdG9yOiBGdW5jdGlvbiwgZGF0YTogYW55KTogRW50aXR5IHtcclxuICAgIGNvbnN0IGVudGl0eVR5cGUgPSB0aGlzLmdldFR5cGUoY29uc3RydWN0b3IpO1xyXG4gICAgY29uc3QgZW50aXR5ID0gbmV3IGVudGl0eVR5cGUoZGF0YSk7XHJcbiAgICBlbnRpdHkuY29uc3RydWN0b3IgPSBjb25zdHJ1Y3RvcjtcclxuICAgIHJldHVybiBlbnRpdHk7XHJcbiAgfVxyXG4gIC8vIEBDYWNoZSh7IGtleTogKChjb250ZXh0OiBhbnksIGFyZ3M6IGFueVtdKSA9PiB7IHJldHVybiBhcmdzWzBdIH0pLCBwcm92aWRlcjogbmV3IE1lbW9yeUNhY2hlUHJvdmlkZXIoKSB9KVxyXG4gIHB1YmxpYyBzdGF0aWMgY3JlYXRlVHlwZShjb25zdHJ1Y3RvcjogRnVuY3Rpb24pOiBDbGFzc1R5cGU8RW50aXR5PiB7XHJcbiAgICBjb25zdCBlbnRpdHlUeXBlID0gY2xhc3MgRW50aXR5VHlwZSBleHRlbmRzIEVudGl0eSB7XHJcbiAgICAgIGNvbnN0cnVjdG9yKGRhdGE6IGFueSkge1xyXG4gICAgICAgIHN1cGVyKGRhdGEpO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gICAgY29uc3QgZW50aXR5UHJvdG90eXBlID0gZW50aXR5VHlwZS5wcm90b3R5cGU7XHJcbiAgICB0aGlzLmV4dGVuZFByb3BlcnRpZXMoY29uc3RydWN0b3IsIGVudGl0eVByb3RvdHlwZSk7XHJcbiAgICByZXR1cm4gZW50aXR5VHlwZTtcclxuICB9XHJcbiAgcHJpdmF0ZSBzdGF0aWMgZXh0ZW5kUHJvcGVydGllcyhjb25zdHJ1Y3RvcjogRnVuY3Rpb24sIGVudGl0eVByb3RvdHlwZTogRW50aXR5KSB7XHJcbiAgICBjb25zdCBuZ0ZpZWxkcyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nRmllbGRzKGNvbnN0cnVjdG9yKTtcclxuICAgIGNvbnN0IG5nT2JqZWN0cyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nT2JqZWN0cyhjb25zdHJ1Y3Rvcik7XHJcbiAgICBjb25zdCBuZ0xpc3RzID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdMaXN0KGNvbnN0cnVjdG9yKTtcclxuICAgIGNvbnN0IG5nRHluYW1pYyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nRHluYW1pYyhjb25zdHJ1Y3Rvcik7XHJcbiAgICB0aGlzLmV4dGVuZFBsYWluUHJvcGVydHkoZW50aXR5UHJvdG90eXBlLCBuZ0ZpZWxkcyk7XHJcbiAgICB0aGlzLmV4dGVuZExpc3RQcm9wZXJ0eShlbnRpdHlQcm90b3R5cGUsIG5nTGlzdHMpO1xyXG4gICAgdGhpcy5leHRlbmRPYmplY3RQcm9wZXJ0eShlbnRpdHlQcm90b3R5cGUsIG5nT2JqZWN0cyk7XHJcbiAgICB0aGlzLmV4dGVuZER5bmFtaWNQcm9wZXJ0eShlbnRpdHlQcm90b3R5cGUsIG5nRHluYW1pYyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHN0YXRpYyBleHRlbmRQbGFpblByb3BlcnR5KGVudGl0eVByb3RvdHlwZTogRW50aXR5LCBuZ0ZpZWxkczogeyBba2V5OiBzdHJpbmddOiBOZ0ZpZWxkUHJvcGVydHkgfSk6IHZvaWQge1xyXG4gICAgT2JqZWN0LmtleXMobmdGaWVsZHMpLmZvckVhY2goZnVuY3Rpb24gKHByb3BOYW1lKSB7XHJcbiAgICAgIGNvbnN0IG5nRmllbGQgPSBuZ0ZpZWxkc1twcm9wTmFtZV0gYXMgTmdGaWVsZFByb3BlcnR5O1xyXG4gICAgICAvLyBjb25zdCBkYXRhRmllbGQgPSBuZ0ZpZWxkLmRhdGFGaWVsZCB8fCBwcm9wTmFtZTtcclxuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVudGl0eVByb3RvdHlwZSwgcHJvcE5hbWUsIHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5nZXRQcm9wVmFsdWUocHJvcE5hbWUsIG5nRmllbGQpO1xyXG4gICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0OiBmdW5jdGlvbiAobmV3UHJvcFZhbHVlKSB7XHJcbiAgICAgICAgICAvLyDlgLznm7jlkIzml7bkuI3op6blj5Hlj5jmm7TjgIJcclxuICAgICAgICAgIGNvbnN0IG9sZFByb3BWYWx1ZSA9IHRoaXMuZ2V0UHJvcFZhbHVlKHByb3BOYW1lLCBuZ0ZpZWxkKTtcclxuICAgICAgICAgIGlmICh0aGlzLmlzUHJvcFZhbHVlQ2hhbmdlZChwcm9wTmFtZSwgbmdGaWVsZCwgbmV3UHJvcFZhbHVlLCBvbGRQcm9wVmFsdWUpID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICB0aGlzLnNldFByb3BWYWx1ZShwcm9wTmFtZSwgbmdGaWVsZCwgbmV3UHJvcFZhbHVlKTtcclxuICAgICAgICAgIGNvbnN0IGNoYW5nZVNldFZhbHVlID0gdGhpcy5wcmVwYXJlUHJvcFZhbHVlKHByb3BOYW1lLCBuZ0ZpZWxkLCBuZXdQcm9wVmFsdWUpO1xyXG4gICAgICAgICAgdGhpcy5lbWl0VmFsdWVDaGFuZ2UocHJvcE5hbWUsIG5nRmllbGQsIG5ld1Byb3BWYWx1ZSwgb2xkUHJvcFZhbHVlLCBjaGFuZ2VTZXRWYWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIHN0YXRpYyBleHRlbmRMaXN0UHJvcGVydHkoZW50aXR5UHJvdG90eXBlOiBFbnRpdHksIG5nTGlzdE1ldGFkYXRhOiB7IFtrZXk6IHN0cmluZ106IE5nTGlzdFByb3BlcnR5IH0pOiB2b2lkIHtcclxuICAgIE9iamVjdC5rZXlzKG5nTGlzdE1ldGFkYXRhKS5mb3JFYWNoKGZ1bmN0aW9uIChwcm9wZXJ0eU5hbWUpIHtcclxuICAgICAgY29uc3Qga2V5ID0gYF9fJHtwcm9wZXJ0eU5hbWV9X19gO1xyXG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZW50aXR5UHJvdG90eXBlLCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgIGxldCBlbnRpdHlMaXN0ID0gdGhpc1trZXldO1xyXG4gICAgICAgICAgaWYgKCFlbnRpdHlMaXN0KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpZWxkTWV0YWRhdGEgPSBuZ0xpc3RNZXRhZGF0YVtwcm9wZXJ0eU5hbWVdIGFzIE5nTGlzdFByb3BlcnR5O1xyXG4gICAgICAgICAgICBjb25zdCBwYXRoID0gdGhpcy5jcmVhdGVQYXRoKHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IGZpZWxkTWV0YWRhdGEuZGF0YUZpZWxkIHx8IHByb3BlcnR5TmFtZTtcclxuICAgICAgICAgICAgY29uc3QgdmFsID0gdGhpcy5kYXRhW2RhdGFGaWVsZF07XHJcbiAgICAgICAgICAgIGVudGl0eUxpc3QgPSBuZXcgRW50aXR5TGlzdDx0eXBlb2YgZmllbGRNZXRhZGF0YS50eXBlPigpO1xyXG4gICAgICAgICAgICBlbnRpdHlMaXN0W1BBUkVOVF9DTEFTU10gPSB0aGlzO1xyXG4gICAgICAgICAgICBlbnRpdHlMaXN0W1BBUkVOVF9QQVRIXSA9IHBhdGg7XHJcbiAgICAgICAgICAgIGlmICh2YWwpIHtcclxuICAgICAgICAgICAgICBjb25zdCBlbnRpdGllcyA9IHZhbC5tYXAodiA9PiBFbnRpdHlGYWN0b3J5PHR5cGVvZiBmaWVsZE1ldGFkYXRhLnR5cGU+KGZpZWxkTWV0YWRhdGEudHlwZSwgdikpO1xyXG4gICAgICAgICAgICAgIGVudGl0eUxpc3QubG9hZEVudGl0aWVzKGVudGl0aWVzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbnRpdHlMaXN0Lm9uTGlzdENoYW5nZWQuc3Vic2NyaWJlKHZhbHVlID0+IHtcclxuICAgICAgICAgICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIGlmIChlbnRpdHlMaXN0W1BBUkVOVF9QQVRIXVswXSAhPT0gdmFsdWUucGF0aFswXSkge1xyXG4gICAgICAgICAgICAgICAgICB2YWx1ZS5wYXRoID0gZW50aXR5TGlzdFtQQVJFTlRfUEFUSF0uY29uY2F0KHZhbHVlLnBhdGgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRDaGFuZ2VzKHZhbHVlKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzW2tleV0gPSBlbnRpdHlMaXN0O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIGVudGl0eUxpc3Q7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgICAgdGhpc1trZXldID0gdmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIHN0YXRpYyBleHRlbmRPYmplY3RQcm9wZXJ0eShlbnRpdHlQcm90b3R5cGU6IEVudGl0eSwgbmdPYmplY3RNZXRhZGF0YTogeyBba2V5OiBzdHJpbmddOiBOZ09iamVjdFByb3BlcnR5IH0pIHtcclxuICAgIE9iamVjdC5rZXlzKG5nT2JqZWN0TWV0YWRhdGEpLmZvckVhY2goZnVuY3Rpb24gKHByb3BlcnR5TmFtZSkge1xyXG4gICAgICBjb25zdCBmaWVsZE1ldGFkYXRhID0gbmdPYmplY3RNZXRhZGF0YVtwcm9wZXJ0eU5hbWVdIGFzIE5nT2JqZWN0UHJvcGVydHk7XHJcbiAgICAgIGNvbnN0IGtleSA9IGBfXyR7cHJvcGVydHlOYW1lfV9fYDtcclxuICAgICAgLy8g5aaC5p6c5rKh5pyJ5YC855So5LiA5Liq56m65a+56LGh5Luj5pu/XHJcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbnRpdHlQcm90b3R5cGUsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgbGV0IGNoaWxkRW50aXR5ID0gdGhpc1trZXldO1xyXG4gICAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuY3JlYXRlUGF0aChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgaWYgKCFjaGlsZEVudGl0eSkge1xyXG4gICAgICAgICAgICBjb25zdCBkYXRhRmllbGQgPSBmaWVsZE1ldGFkYXRhLmRhdGFGaWVsZCB8fCBwcm9wZXJ0eU5hbWU7XHJcbiAgICAgICAgICAgIC8vIHZhbOS4jeWtmOWcqOaXtu+8jOeUqOepuuWvueixoeS7o+abv1xyXG4gICAgICAgICAgICBjb25zdCB2YWwgPSB0aGlzLmRhdGFbZGF0YUZpZWxkXSB8fCB7fTtcclxuICAgICAgICAgICAgY2hpbGRFbnRpdHkgPSBFbnRpdHlUeXBlQ3JlYXRvci5idWlsZEVudGl0eShwYXRoLCB2YWwsIHRoaXMsIGZpZWxkTWV0YWRhdGEpO1xyXG4gICAgICAgICAgICB0aGlzW2tleV0gPSBjaGlsZEVudGl0eTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiBjaGlsZEVudGl0eTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlOiBhbnkpIHtcclxuICAgICAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmNyZWF0ZVBhdGgocHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgIGNvbnN0IG1vZGlmeUluZm8gPSB7XHJcbiAgICAgICAgICAgIHBhdGg6IHBhdGgsXHJcbiAgICAgICAgICAgIHZhbHVlOiB2YWx1ZS5kYXRhLFxyXG4gICAgICAgICAgICBwcmVWYWx1ZTogdGhpc1twcm9wZXJ0eU5hbWVdLmRhdGEsXHJcbiAgICAgICAgICAgIHR5cGU6IE1vZGlmeVR5cGUuVmFsdWVDaGFuZ2VcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICBjb25zdCBjaGlsZEVudGl0eSA9IEVudGl0eVR5cGVDcmVhdG9yLmJ1aWxkRW50aXR5KHBhdGgsIHZhbHVlLCB0aGlzLCBmaWVsZE1ldGFkYXRhKTtcclxuICAgICAgICAgIHRoaXNba2V5XSA9IGNoaWxkRW50aXR5O1xyXG4gICAgICAgICAgdGhpcy5zZXRDaGFuZ2VzKG1vZGlmeUluZm8pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHJpdmF0ZSBzdGF0aWMgZXh0ZW5kRHluYW1pY1Byb3BlcnR5KGVudGl0eVByb3RvdHlwZTogRW50aXR5LCBuZ0R5bmFtaWNNZXRhZGF0YTogeyBba2V5OiBzdHJpbmddOiBOZ0R5bmFtaWNQcm9wZXJ0eSB9KSB7XHJcbiAgICBPYmplY3Qua2V5cyhuZ0R5bmFtaWNNZXRhZGF0YSkuZm9yRWFjaChmdW5jdGlvbiAocHJvcGVydHlOYW1lKSB7XHJcbiAgICAgIGNvbnN0IGZpZWxkTWV0YWRhdGEgPSBuZ0R5bmFtaWNNZXRhZGF0YVtwcm9wZXJ0eU5hbWVdIGFzIE5nRHluYW1pY1Byb3BlcnR5O1xyXG4gICAgICBjb25zdCBrZXkgPSBgX18ke3Byb3BlcnR5TmFtZX1fX2A7XHJcblxyXG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZW50aXR5UHJvdG90eXBlLCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgIGxldCBkeW5hbWljRW50aXR5ID0gdGhpc1trZXldO1xyXG4gICAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuY3JlYXRlUGF0aChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgaWYgKCFkeW5hbWljRW50aXR5KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IGZpZWxkTWV0YWRhdGEuZGF0YUZpZWxkIHx8IHByb3BlcnR5TmFtZTtcclxuICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxEYXRhID0gdGhpcy5kYXRhW2RhdGFGaWVsZF0gfHwge307XHJcbiAgICAgICAgICAgIGR5bmFtaWNFbnRpdHkgPSBFbnRpdHlUeXBlQ3JlYXRvci5idWlsZER5bmFtaWMocGF0aCwgb3JpZ2luYWxEYXRhLCB0aGlzLCBmaWVsZE1ldGFkYXRhKTtcclxuICAgICAgICAgICAgdGhpc1trZXldID0gZHluYW1pY0VudGl0eTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiBkeW5hbWljRW50aXR5O1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHtcclxuICAgICAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmNyZWF0ZVBhdGgocHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgIGNvbnN0IG1vZGlmeUluZm8gPSB7XHJcbiAgICAgICAgICAgIHBhdGg6IHBhdGgsXHJcbiAgICAgICAgICAgIHZhbHVlOiB2YWx1ZS5kYXRhLFxyXG4gICAgICAgICAgICBwcmVWYWx1ZTogdGhpc1twcm9wZXJ0eU5hbWVdLmRhdGEsXHJcbiAgICAgICAgICAgIHR5cGU6IE1vZGlmeVR5cGUuVmFsdWVDaGFuZ2VcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICBsZXQgZHluYW1pY0VudGl0eSA9IEVudGl0eVR5cGVDcmVhdG9yLmJ1aWxkRHluYW1pYyhwYXRoLCB2YWx1ZSwgdGhpcywgZmllbGRNZXRhZGF0YSk7XHJcbiAgICAgICAgICB0aGlzW2tleV0gPSBkeW5hbWljRW50aXR5O1xyXG4gICAgICAgICAgdGhpcy5zZXRDaGFuZ2VzKG1vZGlmeUluZm8pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0VHlwZShjb25zdHJ1Y3RvcjogRnVuY3Rpb24pIHtcclxuICAgIGlmICh0aGlzLmJ1ZmZlci5oYXMoY29uc3RydWN0b3IpKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmJ1ZmZlci5nZXQoY29uc3RydWN0b3IpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZW50aXR5VHlwZSA9IHRoaXMuY3JlYXRlVHlwZShjb25zdHJ1Y3Rvcik7XHJcbiAgICB0aGlzLmJ1ZmZlci5zZXQoY29uc3RydWN0b3IsIGVudGl0eVR5cGUpO1xyXG4gICAgcmV0dXJuIGVudGl0eVR5cGU7XHJcbiAgfVxyXG4gIHByaXZhdGUgc3RhdGljIGJ1aWxkRW50aXR5KHBhcmVudFBhdGg6IHN0cmluZ1tdLCB2YWx1ZTogYW55LCBwYXJlbnQ6IGFueSwgZmllbGRNZXRhZGF0YTogTmdPYmplY3RQcm9wZXJ0eSB8IE5nRHluYW1pY1Byb3BlcnR5KSB7XHJcbiAgICBsZXQgaW5zdGFuY2U7XHJcbiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBmaWVsZE1ldGFkYXRhLnR5cGUpIHtcclxuICAgICAgaW5zdGFuY2UgPSB2YWx1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGluc3RhbmNlID0gRW50aXR5RmFjdG9yeShmaWVsZE1ldGFkYXRhLnR5cGUsIHZhbHVlKTtcclxuICAgIH1cclxuICAgIGluc3RhbmNlW1BBUkVOVF9DTEFTU10gPSBwYXJlbnQ7XHJcbiAgICBpbnN0YW5jZVtQQVJFTlRfUEFUSF0gPSBwYXJlbnRQYXRoO1xyXG4gICAgaW5zdGFuY2Uub25WYWx1ZUNoYW5nZWQuc3Vic2NyaWJlKGNoYW5nZXMgPT4ge1xyXG4gICAgICBpZiAoY2hhbmdlcykge1xyXG4gICAgICAgIGNoYW5nZXMucGF0aCA9IChwYXJlbnRbUEFSRU5UX1BBVEhdIHx8IFtdKS5jb25jYXQoY2hhbmdlcy5wYXRoKTtcclxuICAgICAgICBjb25zdCBjaGFuZ2UgPSBPYmplY3QuYXNzaWduKHt9LCBjaGFuZ2VzLCB7IGZyb21QYXJlbnQ6IHRydWUgfSk7XHJcbiAgICAgICAgcGFyZW50LnNldENoYW5nZXMoY2hhbmdlKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gaW5zdGFuY2U7XHJcbiAgfVxyXG4gIHByaXZhdGUgc3RhdGljIGJ1aWxkRHluYW1pYyhwYXJlbnRQYXRoOiBzdHJpbmdbXSwgdmFsdWU6IGFueSwgcGFyZW50OiBhbnksIGZpZWxkTWV0YWRhdGE6IE5nT2JqZWN0UHJvcGVydHkgfCBOZ0R5bmFtaWNQcm9wZXJ0eSkge1xyXG4gICAgbGV0IGluc3RhbmNlO1xyXG4gICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgZmllbGRNZXRhZGF0YS50eXBlKSB7XHJcbiAgICAgIGluc3RhbmNlID0gdmFsdWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpbnN0YW5jZSA9IER5bmFtaWNGYWN0b3J5KGZpZWxkTWV0YWRhdGEudHlwZSwgdmFsdWUpO1xyXG4gICAgfVxyXG4gICAgaW5zdGFuY2VbUEFSRU5UX0NMQVNTXSA9IHBhcmVudDtcclxuICAgIGluc3RhbmNlW1BBUkVOVF9QQVRIXSA9IHBhcmVudFBhdGg7XHJcbiAgICBpbnN0YW5jZS5vblZhbHVlQ2hhbmdlZC5zdWJzY3JpYmUoY2hhbmdlcyA9PiB7XHJcbiAgICAgIGlmIChjaGFuZ2VzKSB7XHJcbiAgICAgICAgY2hhbmdlcy5wYXRoID0gKHBhcmVudFtQQVJFTlRfUEFUSF0gfHwgW10pLmNvbmNhdChjaGFuZ2VzLnBhdGgpO1xyXG4gICAgICAgIHBhcmVudC5zZXRDaGFuZ2VzKGNoYW5nZXMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBpbnN0YW5jZTtcclxuICB9XHJcbn0iXX0=