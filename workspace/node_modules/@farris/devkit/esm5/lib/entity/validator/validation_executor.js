import * as tslib_1 from "tslib";
import { ValidationError } from './validation_error';
import { ValidationTypes } from './validation_types';
import { EntityList } from '../entity_list';
import { FieldMetadataUtil } from '../metadata/index';
/**
 * 执行数据验证
 */
var ValidationExecutor = /** @class */ (function () {
    function ValidationExecutor(validator) {
        this.validator = validator;
        /** 异步验证请求集合 */
        this.awaitingPromises = [];
    }
    /**
     * 将信息中的关键字替换为具体实体对象中的信息
     * @param message 验证信息
     * @param metadata 验证规则
     * @param value 待验证的值
     */
    ValidationExecutor.replaceMessageSpecialTokens = function (message, metadata, value) {
        var messageString;
        if (message instanceof Function) {
            messageString = message(metadata);
        }
        else if (typeof message === 'string') {
            messageString = message;
        }
        if (messageString && metadata.constraints instanceof Array) {
            metadata.constraints.forEach(function (constraint, index) {
                messageString = messageString.replace(new RegExp("\\$constraint" + (index + 1), 'g'), constraint);
            });
        }
        if (messageString && value !== undefined && value !== null) {
            messageString = messageString.replace(/\$value/g, value);
        }
        if (messageString) {
            messageString = messageString.replace(/\$property/g, metadata.property);
        }
        if (messageString) {
            messageString = messageString.replace(/\$target/g, metadata.targetName);
        }
        return messageString;
    };
    /**
     * 验证实例对象
     * @param object 验证实例对象
     * @param newValue 实体将要更新的值
     * @param validationErrors 验证信息集合
     * @param propertyName 实例对象属性
     * @param index 所属集合实例中索引
     */
    ValidationExecutor.prototype.execute = function (object, newValue, validationErrors, propertyName, index, externalRules, currentRowId, frameContext) {
        var _this = this;
        // if (!currentRowId) {
        //   currentRowId = object.primaryValue;
        // }
        if (!externalRules && frameContext) {
            externalRules = frameContext.form.getValidationRules();
        }
        // 提取实体上定义的验证描述
        // 格式{key:[rule1,rule2]}
        var validateMetadatas = FieldMetadataUtil.getValidationMetadataWithPath(object);
        var remainedExternalRules = new Map();
        // 合并额外验证规则
        if (externalRules) {
            // const parentPathArray: string[] = object['__PARENT_PATH__'] ? [...object['__PARENT_PATH__']] : [''];
            // if (parentPathArray.length > 1) {
            //   parentPathArray[0] = '';
            // }
            var parentPathArray = [];
            var objectCursor = object;
            while (objectCursor && objectCursor !== objectCursor['__PARENT__']) {
                var cursorParentPath = objectCursor['__PARENT_PATH__'] ? objectCursor['__PARENT_PATH__'][1] : '';
                // if (parentPathArray[parentPathArray.length - 1] !== cursorParentPath) {
                parentPathArray.push(cursorParentPath);
                // }
                objectCursor = objectCursor['__PARENT__'];
                if (objectCursor instanceof EntityList) {
                    objectCursor = objectCursor['__PARENT__'];
                }
            }
            var parentPath_1 = parentPathArray.reverse().join('/');
            externalRules.forEach(function (rules, path) {
                if (path) {
                    // 提取额外验证规则字段路径
                    var pathArray = path.split('/');
                    // 提取字段名称
                    var fieldName_1 = pathArray.pop();
                    // 提取字段父路径
                    var fieldParentPath = pathArray.join('/');
                    // 匹配外部验证规则和实体验证规则父路径
                    if (parentPath_1 === fieldParentPath) {
                        validateMetadatas[fieldName_1] = tslib_1.__spread((validateMetadatas[fieldName_1] || []));
                        // 合并外部校验规则到实体校验规则，并同步外部验证规则显示信息至实体验证规则，如：中英文字段描述、字段所在位置。
                        if (rules.length) {
                            var targetId_1 = '';
                            rules.forEach(function (rule) {
                                if (rule.targetId && rule.targetId.length > targetId_1.length) {
                                    targetId_1 = rule.targetId;
                                }
                                validateMetadatas[fieldName_1].push(rule);
                            });
                            validateMetadatas[fieldName_1].forEach(function (validateRule) {
                                validateRule.targetId = targetId_1;
                                validateRule.targetName = rules[0].targetName;
                                validateRule.property = rules[0].property;
                                if (rules[0].frameContext) {
                                    validateRule.frameContext = rules[0].frameContext;
                                }
                                validateRule.fullPath = rules[0].fullPath;
                                validateRule['initialized'] = true;
                            });
                        }
                    }
                    else {
                        remainedExternalRules.set(path, rules);
                    }
                }
            });
        }
        // 处理校验规则中的属性名称
        // 场景为前端未开启校验或form校验规则中对应绑定路径中对应控件未开启校验，导致上一步骤中组件名、字段名未能同步为对应中文
        if (validateMetadatas && Object.keys(validateMetadatas).length > 0) {
            Object.keys(validateMetadatas).forEach(function (fieldName) {
                var validateRules = validateMetadatas[fieldName];
                if (validateRules && validateRules.length > 0) {
                    var firstValidateRule = validateRules[0];
                    var path_1 = firstValidateRule['path'];
                    if (path_1) {
                        validateRules.forEach(function (validateRule) {
                            // 将initialized判断外移减少代码执行次数
                            if (validateRule['initialized'] !== true) {
                                var bindingPaths = path_1.split('.');
                                var form = _this.getForm(bindingPaths, frameContext);
                                var formControl = _this.getFormControl(bindingPaths, frameContext);
                                if (formControl) {
                                    validateRule.targetId = formControl.id;
                                    validateRule.targetName = form && form.formGroupName;
                                    validateRule.property = formControl.name || formControl.defaultI18nValue || '';
                                }
                            }
                        });
                    }
                }
            });
        }
        // 过滤出当前验证属性的验证规则
        if (propertyName) {
            validateMetadatas = Object.keys(validateMetadatas)
                .filter(function (key) { return key === propertyName; })
                .reduce(function (val, curr) {
                var _a;
                return Object.assign({}, val, (_a = {}, _a[curr] = validateMetadatas[curr], _a));
            }, {});
        }
        // validateMetadatas = {rule:当前属性的所有校验规则}
        Object.keys(validateMetadatas).filter(function (key) {
            return object && (object.hasOwnProperty(key) ||
                (object.constructor.prototype &&
                    object.constructor.prototype.typeName &&
                    object.constructor.prototype.hasOwnProperty(key)) ||
                object['__proto__'].hasOwnProperty(key));
        }).forEach(function (key) {
            // todo: 没用兼容value是undefined的情况
            var value = newValue;
            if (newValue === undefined) {
                value = object[key];
            }
            var isMultLanguageField = false;
            var multiLangFields = _this.getMultiLanguageFields(object);
            if (multiLangFields && multiLangFields.length > 0) {
                if (multiLangFields.includes(key)) {
                    isMultLanguageField = true;
                }
            }
            // const value = newValue ||
            var validateRules = validateMetadatas[key];
            if (validateRules.length) {
                var _a = validateRules[0], fieldName = _a.property, field = _a.targetId, frameContext_1 = _a.frameContext, fullPath = _a.fullPath;
                // const fieldContainerName = Number.isInteger(index) ?
                // `${validateRules[0].targetName} 第${index + 1}行` : validateRules[0].targetName;
                var fieldContainerName = Number.isInteger(index) ?
                    ValidationExecutor.replaceMessageSpecialTokens(ValidationTypes.getMessage(ValidationTypes.FIELD_CONTAINER), validateRules[0], index + 1) : validateRules[0].targetName;
                var validationDisplayName = fieldContainerName ? fieldContainerName + " - " + fieldName : "" + fieldName;
                // const property = validateRules['path'] || key;
                var validationError = _this.generateValidationError(object, value, key, validationDisplayName, index, field, frameContext_1, fullPath);
                if (index !== undefined) {
                    validationError['index'] = index;
                }
                validationErrors.push(validationError);
                _this.defaultValidations(object, value, validateRules, validationError, isMultLanguageField, currentRowId);
            }
        });
        this.objectValidations(object, validationErrors, propertyName, index, remainedExternalRules, currentRowId, frameContext);
        this.listValidations(object, validationErrors, propertyName, index, remainedExternalRules, frameContext);
        // this.sortValidationErrors(validationErrors);
        // todo 存在某些ngObject类型的数据，界面上没有，实体中有，实体设置了必填，导致验证不通过无法保存的问题
        // if (!propertyName) {
        //     this.objectValidations(object, validationErrors);
        // }
    };
    ValidationExecutor.prototype.getMultiLanguageFields = function (entity) {
        if (entity && entity.constructor) {
            var ngFields_1 = FieldMetadataUtil.getNgFields(entity.constructor);
            return Object.keys(ngFields_1).filter(function (fieldName) { return ngFields_1[fieldName].enableMultiLangInput; });
        }
        return null;
    };
    /**
     * 清除通过验证信息
     * @param errors 验证失败信息
     */
    ValidationExecutor.prototype.stripEmptyErrors = function (errors) {
        var _this = this;
        return errors.filter(function (error) {
            if (error.children) {
                error.children = _this.stripEmptyErrors(error.children);
            }
            if (Object.keys(error.constraints).length === 0) {
                if (error.children.length === 0) {
                    return false;
                }
                else {
                    delete error.constraints;
                }
            }
            return true;
        });
    };
    /**
     * 生成未通过验证的对象
     * @param object 要验证的实体实例对象
     * @param value 要验证的值
     * @param propertyName 待验证的实体属性名称
     * @param index 验证数据索引
     * @param field 待验证字段
     */
    ValidationExecutor.prototype.generateValidationError = function (object, value, property, propertyName, index, field, frameContext, fullPath) {
        var validationError = new ValidationError();
        validationError.target = object;
        validationError.value = value;
        validationError.property = property;
        validationError.propertyName = propertyName;
        validationError.field = field;
        validationError.index = index;
        validationError.children = [];
        validationError.constraints = {};
        if (frameContext) {
            validationError.frameContext = frameContext;
        }
        validationError.fullPath = fullPath;
        return validationError;
    };
    /**
     * 验证实体中的属性
     * @param object 要验证的实体实例对象
     * @param value 要验证的值
     * @param validateRules 验证规则
     * @param errorMap 难证信息。{[key]: message}
     *
     * key: 验证规则名称
     * message: 验证信息
     */
    ValidationExecutor.prototype.defaultValidations = function (object, value, validateRules, validationError, isMultLanguageField, currentRowId) {
        var _this = this;
        var errorMap = validationError.constraints;
        return validateRules
            .filter(function (validateRule) {
            // 验证实体属性是否符合规则
            var validValue = _this.validator.validateValueByMetadata(object, value, validateRule, isMultLanguageField, currentRowId);
            if (validValue instanceof Promise) {
                var promise = validValue.then(function (isValid) {
                    if (!isValid) {
                        var _a = _this.createValidationError(object, value, validateRule), type = _a.type, message = _a.messageString;
                        errorMap[type] = message;
                        validationError.rule = validateRule;
                    }
                });
                _this.awaitingPromises.push(promise);
            }
            return !validValue;
        })
            .forEach(function (validateRule) {
            // 不符合规则，生成错误信息
            var _a = _this.createValidationError(object, value, validateRule), key = _a.type, message = _a.messageString;
            errorMap[key] = message;
            validationError.rule = validateRule;
        });
    };
    /**
     * 验证列表中的每条记录
     * @param object 要验证的实体实例对象
     * @param errors 验证失败的信息集合
     * @param property 属性名称
     * @param parentIndex 当前集合的父对象所属集合列表中的索引。
     */
    ValidationExecutor.prototype.listValidations = function (object, errors, property, parentIndex, externalRules, frameContext) {
        var _this = this;
        var INDEX_LABEL = "__ACTUAL_INDEX__";
        var listFields = FieldMetadataUtil.getNgList(object.constructor);
        if (!listFields) {
            return;
        }
        var keys = Object.keys(listFields);
        if (property) {
            keys = keys.filter(function (key) { return key === property; });
        }
        keys.forEach(function (propertyName) {
            var metadata = listFields[propertyName];
            var clzType = metadata.type;
            var value = object[propertyName];
            if (value) {
                var parentPaths = object.getPaths().path || [];
                parentPaths.push(propertyName);
                var validationError_1 = _this.generateValidationError(object, value.items, parentPaths.join('.'), propertyName, parentIndex);
                validationError_1.isArray = true;
                errors.push(validationError_1);
                value.items.forEach(function (entity, index) {
                    var actualIndex = entity[INDEX_LABEL] ? entity[INDEX_LABEL] : index;
                    _this.execute(entity, undefined, validationError_1.children, undefined, actualIndex, externalRules, entity.primaryValue, frameContext);
                });
            }
        });
    };
    /**
     * 验证实体中的引用对象
     * @param object 要验证的实体对象
     * @param errors 错误信息集合
     */
    ValidationExecutor.prototype.objectValidations = function (object, errors, property, parentIndex, externalRules, currentRowId, frameContext) {
        var _this = this;
        var objectFields = FieldMetadataUtil.getNgObjects(object.constructor);
        if (!objectFields || Object.keys(objectFields).length < 1) {
            return;
        }
        var keys = Object.keys(objectFields);
        if (property) {
            keys = keys.filter(function (key) { return key === property; });
        }
        keys.forEach(function (propertyName) {
            var metadata = objectFields[propertyName];
            var objectType = metadata.type;
            var value = object[propertyName];
            if (value) {
                _this.execute(value, undefined, errors, undefined, parentIndex, externalRules, currentRowId, frameContext);
            }
        });
    };
    /**
     * 创建验证规则信息
     * @param object 要验证的实体对象
     * @param value 验证的值
     * @param metadata 验证规则
     */
    ValidationExecutor.prototype.createValidationError = function (object, value, metadata) {
        // const targetName = object.constructor ? (object.constructor as any).name : undefined;
        var type = metadata.type;
        // 获取校验提示信息：先使用内置规则获取，获取不到时使用元数据上的提示，以兼容表达式场景
        var message = ValidationTypes.getMessage(type);
        if (!message) {
            message = metadata.message;
        }
        if (ValidationTypes.isValidType(type) && (type === ValidationTypes.MAXVALUE || type === ValidationTypes.MINVALUE)) {
            if (this.isDateString(value) && metadata.constraints && metadata.constraints.length) {
                // 获取日期类型的提示信息
                var extType = type === ValidationTypes.MINVALUE ? ValidationTypes.MIN_DATE : ValidationTypes.MAX_DATE;
                message = ValidationTypes.getMessage(extType);
                /*if (metadata.constraints[0]) {
                  metadata.constraints[0] = DateUtil.format(metadata.constraints[0], 'yyyy-MM-dd HH:mm:ss');
                }*/
            }
        }
        var messageString = ValidationExecutor.replaceMessageSpecialTokens(message, metadata, value);
        return { type: type, messageString: messageString, metadata: metadata };
    };
    ValidationExecutor.prototype.getFrameContext = function (bindingPaths, eventFrameContext) {
        if (!bindingPaths || bindingPaths.length < 1 || !eventFrameContext) {
            return null;
        }
        var paths = bindingPaths.concat([]);
        paths.pop();
        var bindingPath = paths.join('/');
        var frameContext = eventFrameContext.appContext.frameContextManager.getFrameContexts().find(function (context) { return context && context.viewModel && context.viewModel.bindingPath && context.viewModel.bindingPath.split('/').filter(function (p) { return p; }).join('/') === bindingPath; });
        return frameContext || null;
    };
    ValidationExecutor.prototype.getForm = function (bindingPaths, eventFrameContext) {
        if (!bindingPaths || bindingPaths.length < 1 || !eventFrameContext) {
            return null;
        }
        var frameContext = this.getFrameContext(bindingPaths, eventFrameContext);
        return frameContext && frameContext.form || null;
    };
    ValidationExecutor.prototype.getFormControl = function (bindingPaths, eventFrameContext) {
        if (!bindingPaths || bindingPaths.length < 1 || !eventFrameContext) {
            return null;
        }
        var paths = bindingPaths.concat([]);
        var propertyName = paths.pop();
        var frameContext = this.getFrameContext(bindingPaths, eventFrameContext);
        var formControl = frameContext && frameContext.form && frameContext.form.ngFormControls && frameContext.form.ngFormControls[propertyName] || null;
        return formControl;
    };
    ValidationExecutor.prototype.isDateString = function (value) {
        var regex = /\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])(T|\s?)?(([0-2]\d:[0-5]\d)?(:[0-5]\d(?:\.\d+)))?(?:Z|\+[0-2]\d(?:\:[0-5]\d)?)?/g;
        return regex.test(value);
    };
    return ValidationExecutor;
}());
export { ValidationExecutor };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGlvbl9leGVjdXRvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2VudGl0eS92YWxpZGF0b3IvdmFsaWRhdGlvbl9leGVjdXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBR0EsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXJELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUMsT0FBTyxFQUFFLGlCQUFpQixFQUFtQixNQUFNLG1CQUFtQixDQUFDO0FBSXZFOztHQUVHO0FBQ0g7SUFFRSw0QkFBb0IsU0FBdUI7UUFBdkIsY0FBUyxHQUFULFNBQVMsQ0FBYztRQUUzQyxlQUFlO1FBQ2YscUJBQWdCLEdBQW1CLEVBQUUsQ0FBQztJQUhTLENBQUM7SUFJaEQ7Ozs7O09BS0c7SUFDVyw4Q0FBMkIsR0FBekMsVUFBMEMsT0FBWSxFQUFFLFFBQXNCLEVBQUUsS0FBVTtRQUN4RixJQUFJLGFBQXFCLENBQUM7UUFDMUIsSUFBSSxPQUFPLFlBQVksUUFBUSxFQUFFO1lBQy9CLGFBQWEsR0FBSSxPQUEwQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3ZFO2FBQU0sSUFBSSxPQUFPLE9BQU8sS0FBSyxRQUFRLEVBQUU7WUFDdEMsYUFBYSxHQUFHLE9BQWlCLENBQUM7U0FDbkM7UUFFRCxJQUFJLGFBQWEsSUFBSSxRQUFRLENBQUMsV0FBVyxZQUFZLEtBQUssRUFBRTtZQUMxRCxRQUFRLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxVQUFDLFVBQVUsRUFBRSxLQUFLO2dCQUM3QyxhQUFhLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxtQkFBZ0IsS0FBSyxHQUFHLENBQUMsQ0FBRSxFQUFFLEdBQUcsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFD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WUFDbEUsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFDM0UsT0FBTyxZQUFZLElBQUksWUFBWSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUM7SUFDbkQsQ0FBQztJQUNPLDJDQUFjLEdBQXRCLFVBQXVCLFlBQXNCLEVBQUUsaUJBQWdDO1FBQzdFLElBQUksQ0FBQyxZQUFZLElBQUksWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUNsRSxPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsSUFBTSxLQUFLLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN0QyxJQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDakMsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztRQUMzRSxJQUFNLFdBQVcsR0FBRyxZQUFZLElBQUksWUFBWSxDQUFDLElBQUksSUFBSSxZQUFZLENBQUMsSUFBSSxDQUFDLGNBQWMsSUFBSSxZQUFZLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsSUFBSSxJQUFJLENBQUM7UUFDcEosT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztJQUNELHlDQUFZLEdBQVosVUFBYSxLQUFVO1FBQ3JCLElBQU0sS0FBSyxHQUFHLGlJQUFpSSxDQUFDO1FBQ2hKLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMzQixDQUFDO0lBQ0gseUJBQUM7QUFBRCxDQUFDLEFBN2FELElBNmFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHNsaW50OmRpc2FibGU6IG1heC1saW5lLWxlbmd0aFxyXG5pbXBvcnQgeyBWYWxpZGF0b3IgfSBmcm9tICcuL3ZhbGlkYXRvcic7XHJcbmltcG9ydCB7IFZhbGlkYXRlUnVsZSB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBWYWxpZGF0aW9uRXJyb3IgfSBmcm9tICcuL3ZhbGlkYXRpb25fZXJyb3InO1xyXG5pbXBvcnQgeyBFbnRpdHkgfSBmcm9tICcuLi9lbnRpdHknO1xyXG5pbXBvcnQgeyBWYWxpZGF0aW9uVHlwZXMgfSBmcm9tICcuL3ZhbGlkYXRpb25fdHlwZXMnO1xyXG5pbXBvcnQgeyBFbnRpdHlMaXN0IH0gZnJvbSAnLi4vZW50aXR5X2xpc3QnO1xyXG5pbXBvcnQgeyBGaWVsZE1ldGFkYXRhVXRpbCwgTmdGaWVsZFByb3BlcnR5IH0gZnJvbSAnLi4vbWV0YWRhdGEvaW5kZXgnO1xyXG5pbXBvcnQgeyBEYXRlVXRpbCB9IGZyb20gJy4uLy4uL3V0aWxzL2RhdGVfdXRpbCc7XHJcbmltcG9ydCB7IEZyYW1lQ29udGV4dCB9IGZyb20gJy4uLy4uL2ZyYW1lL2luZGV4JztcclxuXHJcbi8qKlxyXG4gKiDmiafooYzmlbDmja7pqozor4FcclxuICovXHJcbmV4cG9ydCBjbGFzcyBWYWxpZGF0aW9uRXhlY3V0b3I8VCBleHRlbmRzIEVudGl0eT4ge1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHZhbGlkYXRvcjogVmFsaWRhdG9yPFQ+KSB7IH1cclxuXHJcbiAgLyoqIOW8guatpemqjOivgeivt+axgumbhuWQiCAqL1xyXG4gIGF3YWl0aW5nUHJvbWlzZXM6IFByb21pc2U8YW55PltdID0gW107XHJcbiAgLyoqXHJcbiAgICog5bCG5L+h5oGv5Lit55qE5YWz6ZSu5a2X5pu/5o2i5Li65YW35L2T5a6e5L2T5a+56LGh5Lit55qE5L+h5oGvXHJcbiAgICogQHBhcmFtIG1lc3NhZ2Ug6aqM6K+B5L+h5oGvXHJcbiAgICogQHBhcmFtIG1ldGFkYXRhIOmqjOivgeinhOWImVxyXG4gICAqIEBwYXJhbSB2YWx1ZSDlvoXpqozor4HnmoTlgLxcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGljIHJlcGxhY2VNZXNzYWdlU3BlY2lhbFRva2VucyhtZXNzYWdlOiBhbnksIG1ldGFkYXRhOiBWYWxpZGF0ZVJ1bGUsIHZhbHVlOiBhbnkpIHtcclxuICAgIGxldCBtZXNzYWdlU3RyaW5nOiBzdHJpbmc7XHJcbiAgICBpZiAobWVzc2FnZSBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7XHJcbiAgICAgIG1lc3NhZ2VTdHJpbmcgPSAobWVzc2FnZSBhcyAoYXJnczogVmFsaWRhdGVSdWxlKSA9PiBzdHJpbmcpKG1ldGFkYXRhKTtcclxuICAgIH0gZWxzZSBpZiAodHlwZW9mIG1lc3NhZ2UgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgIG1lc3NhZ2VTdHJpbmcgPSBtZXNzYWdlIGFzIHN0cmluZztcclxuICAgIH1cclxuXHJcbiAgICBpZiAobWVzc2FnZVN0cmluZyAmJiBtZXRhZGF0YS5jb25zdHJhaW50cyBpbnN0YW5jZW9mIEFycmF5KSB7XHJcbiAgICAgIG1ldGFkYXRhLmNvbnN0cmFpbnRzLmZvckVhY2goKGNvbnN0cmFpbnQsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgbWVzc2FnZVN0cmluZyA9IG1lc3NhZ2VTdHJpbmcucmVwbGFjZShuZXcgUmVnRXhwKGBcXFxcJGNvbnN0cmFpbnQke2luZGV4ICsgMX1gLCAnZycpLCBjb25zdHJhaW50KTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG1lc3NhZ2VTdHJpbmcgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCkge1xyXG4gICAgICBtZXNzYWdlU3RyaW5nID0gbWVzc2FnZVN0cmluZy5yZXBsYWNlKC9cXCR2YWx1ZS9nLCB2YWx1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG1lc3NhZ2VTdHJpbmcpIHtcclxuICAgICAgbWVzc2FnZVN0cmluZyA9IG1lc3NhZ2VTdHJpbmcucmVwbGFjZSgvXFwkcHJvcGVydHkvZywgbWV0YWRhdGEucHJvcGVydHkpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChtZXNzYWdlU3RyaW5nKSB7XHJcbiAgICAgIG1lc3NhZ2VTdHJpbmcgPSBtZXNzYWdlU3RyaW5nLnJlcGxhY2UoL1xcJHRhcmdldC9nLCBtZXRhZGF0YS50YXJnZXROYW1lKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbWVzc2FnZVN0cmluZztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOmqjOivgeWunuS+i+WvueixoVxyXG4gICAqIEBwYXJhbSBvYmplY3Qg6aqM6K+B5a6e5L6L5a+56LGhXHJcbiAgICogQHBhcmFtIG5ld1ZhbHVlIOWunuS9k+WwhuimgeabtOaWsOeahOWAvFxyXG4gICAqIEBwYXJhbSB2YWxpZGF0aW9uRXJyb3JzIOmqjOivgeS/oeaBr+mbhuWQiFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eU5hbWUg5a6e5L6L5a+56LGh5bGe5oCnXHJcbiAgICogQHBhcmFtIGluZGV4IOaJgOWxnumbhuWQiOWunuS+i+S4ree0ouW8lVxyXG4gICAqL1xyXG4gIGV4ZWN1dGUob2JqZWN0OiBULCBuZXdWYWx1ZSwgdmFsaWRhdGlvbkVycm9yczogVmFsaWRhdGlvbkVycm9yW10sIHByb3BlcnR5TmFtZT86IHN0cmluZywgaW5kZXg/OiBhbnksIGV4dGVybmFsUnVsZXM/OiBNYXA8c3RyaW5nLCBWYWxpZGF0ZVJ1bGVbXT4sIGN1cnJlbnRSb3dJZD86IHN0cmluZywgZnJhbWVDb250ZXh0PzogRnJhbWVDb250ZXh0KSB7XHJcbiAgICAvLyBpZiAoIWN1cnJlbnRSb3dJZCkge1xyXG4gICAgLy8gICBjdXJyZW50Um93SWQgPSBvYmplY3QucHJpbWFyeVZhbHVlO1xyXG4gICAgLy8gfVxyXG4gICAgaWYgKCFleHRlcm5hbFJ1bGVzICYmIGZyYW1lQ29udGV4dCkge1xyXG4gICAgICBleHRlcm5hbFJ1bGVzID0gZnJhbWVDb250ZXh0LmZvcm0uZ2V0VmFsaWRhdGlvblJ1bGVzKCk7XHJcbiAgICB9XHJcbiAgICAvLyDmj5Dlj5blrp7kvZPkuIrlrprkuYnnmoTpqozor4Hmj4/ov7BcclxuICAgIC8vIOagvOW8j3trZXk6W3J1bGUxLHJ1bGUyXX1cclxuICAgIGxldCB2YWxpZGF0ZU1ldGFkYXRhcyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldFZhbGlkYXRpb25NZXRhZGF0YVdpdGhQYXRoKG9iamVjdCk7XHJcbiAgICBjb25zdCByZW1haW5lZEV4dGVybmFsUnVsZXMgPSBuZXcgTWFwPHN0cmluZywgVmFsaWRhdGVSdWxlW10+KCk7XHJcblxyXG4gICAgLy8g5ZCI5bm26aKd5aSW6aqM6K+B6KeE5YiZXHJcbiAgICBpZiAoZXh0ZXJuYWxSdWxlcykge1xyXG4gICAgICAvLyBjb25zdCBwYXJlbnRQYXRoQXJyYXk6IHN0cmluZ1tdID0gb2JqZWN0WydfX1BBUkVOVF9QQVRIX18nXSA/IFsuLi5vYmplY3RbJ19fUEFSRU5UX1BBVEhfXyddXSA6IFsnJ107XHJcbiAgICAgIC8vIGlmIChwYXJlbnRQYXRoQXJyYXkubGVuZ3RoID4gMSkge1xyXG4gICAgICAvLyAgIHBhcmVudFBhdGhBcnJheVswXSA9ICcnO1xyXG4gICAgICAvLyB9XHJcbiAgICAgIGNvbnN0IHBhcmVudFBhdGhBcnJheSA9IFtdO1xyXG4gICAgICBsZXQgb2JqZWN0Q3Vyc29yID0gb2JqZWN0O1xyXG4gICAgICB3aGlsZSAob2JqZWN0Q3Vyc29yICYmIG9iamVjdEN1cnNvciAhPT0gb2JqZWN0Q3Vyc29yWydfX1BBUkVOVF9fJ10pIHtcclxuICAgICAgICBjb25zdCBjdXJzb3JQYXJlbnRQYXRoID0gb2JqZWN0Q3Vyc29yWydfX1BBUkVOVF9QQVRIX18nXSA/IG9iamVjdEN1cnNvclsnX19QQVJFTlRfUEFUSF9fJ11bMV0gOiAnJztcclxuICAgICAgICAvLyBpZiAocGFyZW50UGF0aEFycmF5W3BhcmVudFBhdGhBcnJheS5sZW5ndGggLSAxXSAhPT0gY3Vyc29yUGFyZW50UGF0aCkge1xyXG4gICAgICAgIHBhcmVudFBhdGhBcnJheS5wdXNoKGN1cnNvclBhcmVudFBhdGgpO1xyXG4gICAgICAgIC8vIH1cclxuICAgICAgICBvYmplY3RDdXJzb3IgPSBvYmplY3RDdXJzb3JbJ19fUEFSRU5UX18nXTtcclxuICAgICAgICBpZiAob2JqZWN0Q3Vyc29yIGluc3RhbmNlb2YgRW50aXR5TGlzdCkge1xyXG4gICAgICAgICAgb2JqZWN0Q3Vyc29yID0gb2JqZWN0Q3Vyc29yWydfX1BBUkVOVF9fJ107XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IHBhcmVudFBhdGggPSBwYXJlbnRQYXRoQXJyYXkucmV2ZXJzZSgpLmpvaW4oJy8nKTtcclxuXHJcbiAgICAgIGV4dGVybmFsUnVsZXMuZm9yRWFjaCgocnVsZXMsIHBhdGgpID0+IHtcclxuICAgICAgICBpZiAocGF0aCkge1xyXG4gICAgICAgICAgLy8g5o+Q5Y+W6aKd5aSW6aqM6K+B6KeE5YiZ5a2X5q616Lev5b6EXHJcbiAgICAgICAgICBjb25zdCBwYXRoQXJyYXkgPSBwYXRoLnNwbGl0KCcvJyk7XHJcbiAgICAgICAgICAvLyDmj5Dlj5blrZfmrrXlkI3np7BcclxuICAgICAgICAgIGNvbnN0IGZpZWxkTmFtZSA9IHBhdGhBcnJheS5wb3AoKTtcclxuICAgICAgICAgIC8vIOaPkOWPluWtl+auteeItui3r+W+hFxyXG4gICAgICAgICAgY29uc3QgZmllbGRQYXJlbnRQYXRoID0gcGF0aEFycmF5LmpvaW4oJy8nKTtcclxuICAgICAgICAgIC8vIOWMuemFjeWklumDqOmqjOivgeinhOWImeWSjOWunuS9k+mqjOivgeinhOWImeeItui3r+W+hFxyXG4gICAgICAgICAgaWYgKHBhcmVudFBhdGggPT09IGZpZWxkUGFyZW50UGF0aCkge1xyXG4gICAgICAgICAgICB2YWxpZGF0ZU1ldGFkYXRhc1tmaWVsZE5hbWVdID0gWy4uLih2YWxpZGF0ZU1ldGFkYXRhc1tmaWVsZE5hbWVdIHx8IFtdKV07XHJcbiAgICAgICAgICAgIC8vIOWQiOW5tuWklumDqOagoemqjOinhOWImeWIsOWunuS9k+agoemqjOinhOWIme+8jOW5tuWQjOatpeWklumDqOmqjOivgeinhOWImeaYvuekuuS/oeaBr+iHs+WunuS9k+mqjOivgeinhOWIme+8jOWmgu+8muS4reiLseaWh+Wtl+auteaPj+i/sOOAgeWtl+auteaJgOWcqOS9jee9ruOAglxyXG4gICAgICAgICAgICBpZiAocnVsZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgbGV0IHRhcmdldElkID0gJyc7XHJcbiAgICAgICAgICAgICAgcnVsZXMuZm9yRWFjaChydWxlID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChydWxlLnRhcmdldElkICYmIHJ1bGUudGFyZ2V0SWQubGVuZ3RoID4gdGFyZ2V0SWQubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgIHRhcmdldElkID0gcnVsZS50YXJnZXRJZDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHZhbGlkYXRlTWV0YWRhdGFzW2ZpZWxkTmFtZV0ucHVzaChydWxlKTtcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICB2YWxpZGF0ZU1ldGFkYXRhc1tmaWVsZE5hbWVdLmZvckVhY2goKHZhbGlkYXRlUnVsZTogVmFsaWRhdGVSdWxlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB2YWxpZGF0ZVJ1bGUudGFyZ2V0SWQgPSB0YXJnZXRJZDtcclxuICAgICAgICAgICAgICAgIHZhbGlkYXRlUnVsZS50YXJnZXROYW1lID0gcnVsZXNbMF0udGFyZ2V0TmFtZTtcclxuICAgICAgICAgICAgICAgIHZhbGlkYXRlUnVsZS5wcm9wZXJ0eSA9IHJ1bGVzWzBdLnByb3BlcnR5O1xyXG4gICAgICAgICAgICAgICAgaWYgKHJ1bGVzWzBdLmZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgICAgICAgICAgICB2YWxpZGF0ZVJ1bGUuZnJhbWVDb250ZXh0ID0gcnVsZXNbMF0uZnJhbWVDb250ZXh0O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdmFsaWRhdGVSdWxlLmZ1bGxQYXRoID0gcnVsZXNbMF0uZnVsbFBhdGg7XHJcbiAgICAgICAgICAgICAgICB2YWxpZGF0ZVJ1bGVbJ2luaXRpYWxpemVkJ10gPSB0cnVlO1xyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZW1haW5lZEV4dGVybmFsUnVsZXMuc2V0KHBhdGgsIHJ1bGVzKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgLy8g5aSE55CG5qCh6aqM6KeE5YiZ5Lit55qE5bGe5oCn5ZCN56ewXHJcbiAgICAvLyDlnLrmma/kuLrliY3nq6/mnKrlvIDlkK/moKHpqozmiJZmb3Jt5qCh6aqM6KeE5YiZ5Lit5a+55bqU57uR5a6a6Lev5b6E5Lit5a+55bqU5o6n5Lu25pyq5byA5ZCv5qCh6aqM77yM5a+86Ie05LiK5LiA5q2l6aqk5Lit57uE5Lu25ZCN44CB5a2X5q615ZCN5pyq6IO95ZCM5q2l5Li65a+55bqU5Lit5paHXHJcbiAgICBpZiAodmFsaWRhdGVNZXRhZGF0YXMgJiYgT2JqZWN0LmtleXModmFsaWRhdGVNZXRhZGF0YXMpLmxlbmd0aCA+IDApIHtcclxuICAgICAgT2JqZWN0LmtleXModmFsaWRhdGVNZXRhZGF0YXMpLmZvckVhY2goKGZpZWxkTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgY29uc3QgdmFsaWRhdGVSdWxlcyA9IHZhbGlkYXRlTWV0YWRhdGFzW2ZpZWxkTmFtZV07XHJcbiAgICAgICAgaWYgKHZhbGlkYXRlUnVsZXMgJiYgdmFsaWRhdGVSdWxlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICBjb25zdCBmaXJzdFZhbGlkYXRlUnVsZSA9IHZhbGlkYXRlUnVsZXNbMF07XHJcbiAgICAgICAgICBjb25zdCBwYXRoID0gZmlyc3RWYWxpZGF0ZVJ1bGVbJ3BhdGgnXTtcclxuICAgICAgICAgIGlmIChwYXRoKSB7XHJcbiAgICAgICAgICAgIHZhbGlkYXRlUnVsZXMuZm9yRWFjaCgodmFsaWRhdGVSdWxlOiBWYWxpZGF0ZVJ1bGUpID0+IHtcclxuICAgICAgICAgICAgICAvLyDlsIZpbml0aWFsaXplZOWIpOaWreWkluenu+WHj+WwkeS7o+eggeaJp+ihjOasoeaVsFxyXG4gICAgICAgICAgICAgIGlmICh2YWxpZGF0ZVJ1bGVbJ2luaXRpYWxpemVkJ10gIT09IHRydWUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IHBhdGguc3BsaXQoJy4nKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZvcm0gPSB0aGlzLmdldEZvcm0oYmluZGluZ1BhdGhzLCBmcmFtZUNvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZm9ybUNvbnRyb2wgPSB0aGlzLmdldEZvcm1Db250cm9sKGJpbmRpbmdQYXRocywgZnJhbWVDb250ZXh0KTtcclxuICAgICAgICAgICAgICAgIGlmIChmb3JtQ29udHJvbCkge1xyXG4gICAgICAgICAgICAgICAgICB2YWxpZGF0ZVJ1bGUudGFyZ2V0SWQgPSBmb3JtQ29udHJvbC5pZDtcclxuICAgICAgICAgICAgICAgICAgdmFsaWRhdGVSdWxlLnRhcmdldE5hbWUgPSBmb3JtICYmIGZvcm0uZm9ybUdyb3VwTmFtZTtcclxuICAgICAgICAgICAgICAgICAgdmFsaWRhdGVSdWxlLnByb3BlcnR5ID0gZm9ybUNvbnRyb2wubmFtZSB8fCBmb3JtQ29udHJvbC5kZWZhdWx0STE4blZhbHVlIHx8ICcnO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIC8vIOi/h+a7pOWHuuW9k+WJjemqjOivgeWxnuaAp+eahOmqjOivgeinhOWImVxyXG4gICAgaWYgKHByb3BlcnR5TmFtZSkge1xyXG4gICAgICB2YWxpZGF0ZU1ldGFkYXRhcyA9IE9iamVjdC5rZXlzKHZhbGlkYXRlTWV0YWRhdGFzKVxyXG4gICAgICAgIC5maWx0ZXIoa2V5ID0+IGtleSA9PT0gcHJvcGVydHlOYW1lKVxyXG4gICAgICAgIC5yZWR1Y2UoKHZhbCwgY3VycikgPT4gT2JqZWN0LmFzc2lnbih7fSwgdmFsLCB7IFtjdXJyXTogdmFsaWRhdGVNZXRhZGF0YXNbY3Vycl0gfSksIHt9KTtcclxuICAgIH1cclxuICAgIC8vIHZhbGlkYXRlTWV0YWRhdGFzID0ge3J1bGU65b2T5YmN5bGe5oCn55qE5omA5pyJ5qCh6aqM6KeE5YiZfVxyXG4gICAgT2JqZWN0LmtleXModmFsaWRhdGVNZXRhZGF0YXMpLmZpbHRlcigoa2V5OiBzdHJpbmcpID0+XHJcbiAgICAgIG9iamVjdCAmJiAoXHJcbiAgICAgICAgb2JqZWN0Lmhhc093blByb3BlcnR5KGtleSkgfHxcclxuICAgICAgICAoXHJcbiAgICAgICAgICBvYmplY3QuY29uc3RydWN0b3IucHJvdG90eXBlICYmXHJcbiAgICAgICAgICBvYmplY3QuY29uc3RydWN0b3IucHJvdG90eXBlLnR5cGVOYW1lICYmXHJcbiAgICAgICAgICBvYmplY3QuY29uc3RydWN0b3IucHJvdG90eXBlLmhhc093blByb3BlcnR5KGtleSlcclxuICAgICAgICApIHx8XHJcbiAgICAgICAgb2JqZWN0WydfX3Byb3RvX18nXS5oYXNPd25Qcm9wZXJ0eShrZXkpXHJcbiAgICAgIClcclxuICAgICkuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICAvLyB0b2RvOiDmsqHnlKjlhbzlrrl2YWx1ZeaYr3VuZGVmaW5lZOeahOaDheWGtVxyXG4gICAgICBsZXQgdmFsdWUgPSBuZXdWYWx1ZTtcclxuICAgICAgaWYgKG5ld1ZhbHVlID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICB2YWx1ZSA9IChvYmplY3QgYXMgYW55KVtrZXldO1xyXG4gICAgICB9XHJcbiAgICAgIGxldCBpc011bHRMYW5ndWFnZUZpZWxkID0gZmFsc2U7XHJcbiAgICAgIGNvbnN0IG11bHRpTGFuZ0ZpZWxkcyA9IHRoaXMuZ2V0TXVsdGlMYW5ndWFnZUZpZWxkcyhvYmplY3QpO1xyXG4gICAgICBpZiAobXVsdGlMYW5nRmllbGRzICYmIG11bHRpTGFuZ0ZpZWxkcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgaWYgKG11bHRpTGFuZ0ZpZWxkcy5pbmNsdWRlcyhrZXkpKSB7XHJcbiAgICAgICAgICBpc011bHRMYW5ndWFnZUZpZWxkID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgLy8gY29uc3QgdmFsdWUgPSBuZXdWYWx1ZSB8fFxyXG4gICAgICBjb25zdCB2YWxpZGF0ZVJ1bGVzOiBWYWxpZGF0ZVJ1bGVbXSA9IHZhbGlkYXRlTWV0YWRhdGFzW2tleV07XHJcbiAgICAgIGlmICh2YWxpZGF0ZVJ1bGVzLmxlbmd0aCkge1xyXG4gICAgICAgIGNvbnN0IHsgcHJvcGVydHk6IGZpZWxkTmFtZSwgdGFyZ2V0SWQ6IGZpZWxkLCBmcmFtZUNvbnRleHQsIGZ1bGxQYXRoIH0gPSB2YWxpZGF0ZVJ1bGVzWzBdO1xyXG4gICAgICAgIC8vIGNvbnN0IGZpZWxkQ29udGFpbmVyTmFtZSA9IE51bWJlci5pc0ludGVnZXIoaW5kZXgpID9cclxuICAgICAgICAvLyBgJHt2YWxpZGF0ZVJ1bGVzWzBdLnRhcmdldE5hbWV9IOesrCR7aW5kZXggKyAxfeihjGAgOiB2YWxpZGF0ZVJ1bGVzWzBdLnRhcmdldE5hbWU7XHJcbiAgICAgICAgY29uc3QgZmllbGRDb250YWluZXJOYW1lID0gTnVtYmVyLmlzSW50ZWdlcihpbmRleCkgP1xyXG4gICAgICAgICAgVmFsaWRhdGlvbkV4ZWN1dG9yLnJlcGxhY2VNZXNzYWdlU3BlY2lhbFRva2VucyhcclxuICAgICAgICAgICAgVmFsaWRhdGlvblR5cGVzLmdldE1lc3NhZ2UoVmFsaWRhdGlvblR5cGVzLkZJRUxEX0NPTlRBSU5FUiksXHJcbiAgICAgICAgICAgIHZhbGlkYXRlUnVsZXNbMF0sIGluZGV4ICsgMVxyXG4gICAgICAgICAgKSA6IHZhbGlkYXRlUnVsZXNbMF0udGFyZ2V0TmFtZTtcclxuICAgICAgICBjb25zdCB2YWxpZGF0aW9uRGlzcGxheU5hbWUgPSBmaWVsZENvbnRhaW5lck5hbWUgPyBgJHtmaWVsZENvbnRhaW5lck5hbWV9IC0gJHtmaWVsZE5hbWV9YCA6IGAke2ZpZWxkTmFtZX1gO1xyXG4gICAgICAgIC8vIGNvbnN0IHByb3BlcnR5ID0gdmFsaWRhdGVSdWxlc1sncGF0aCddIHx8IGtleTtcclxuICAgICAgICBjb25zdCB2YWxpZGF0aW9uRXJyb3IgPSB0aGlzLmdlbmVyYXRlVmFsaWRhdGlvbkVycm9yKG9iamVjdCwgdmFsdWUsIGtleSwgdmFsaWRhdGlvbkRpc3BsYXlOYW1lLCBpbmRleCwgZmllbGQsIGZyYW1lQ29udGV4dCwgZnVsbFBhdGgpO1xyXG4gICAgICAgIGlmIChpbmRleCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICB2YWxpZGF0aW9uRXJyb3JbJ2luZGV4J10gPSBpbmRleDtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFsaWRhdGlvbkVycm9ycy5wdXNoKHZhbGlkYXRpb25FcnJvcik7XHJcbiAgICAgICAgdGhpcy5kZWZhdWx0VmFsaWRhdGlvbnMob2JqZWN0LCB2YWx1ZSwgdmFsaWRhdGVSdWxlcywgdmFsaWRhdGlvbkVycm9yLCBpc011bHRMYW5ndWFnZUZpZWxkLCBjdXJyZW50Um93SWQpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICB0aGlzLm9iamVjdFZhbGlkYXRpb25zKG9iamVjdCwgdmFsaWRhdGlvbkVycm9ycywgcHJvcGVydHlOYW1lLCBpbmRleCwgcmVtYWluZWRFeHRlcm5hbFJ1bGVzLCBjdXJyZW50Um93SWQsIGZyYW1lQ29udGV4dCk7XHJcblxyXG4gICAgdGhpcy5saXN0VmFsaWRhdGlvbnMob2JqZWN0LCB2YWxpZGF0aW9uRXJyb3JzLCBwcm9wZXJ0eU5hbWUsIGluZGV4LCByZW1haW5lZEV4dGVybmFsUnVsZXMsIGZyYW1lQ29udGV4dCk7XHJcbiAgICAvLyB0aGlzLnNvcnRWYWxpZGF0aW9uRXJyb3JzKHZhbGlkYXRpb25FcnJvcnMpO1xyXG5cclxuICAgIC8vIHRvZG8g5a2Y5Zyo5p+Q5LqbbmdPYmplY3TnsbvlnovnmoTmlbDmja7vvIznlYzpnaLkuIrmsqHmnInvvIzlrp7kvZPkuK3mnInvvIzlrp7kvZPorr7nva7kuoblv4XloavvvIzlr7zoh7Tpqozor4HkuI3pgJrov4fml6Dms5Xkv53lrZjnmoTpl67pophcclxuICAgIC8vIGlmICghcHJvcGVydHlOYW1lKSB7XHJcbiAgICAvLyAgICAgdGhpcy5vYmplY3RWYWxpZGF0aW9ucyhvYmplY3QsIHZhbGlkYXRpb25FcnJvcnMpO1xyXG4gICAgLy8gfVxyXG4gIH1cclxuXHJcblxyXG5cclxuICBwcml2YXRlIGdldE11bHRpTGFuZ3VhZ2VGaWVsZHMoZW50aXR5OiBhbnkpIHtcclxuICAgIGlmIChlbnRpdHkgJiYgZW50aXR5LmNvbnN0cnVjdG9yKSB7XHJcbiAgICAgIGNvbnN0IG5nRmllbGRzID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdGaWVsZHMoZW50aXR5LmNvbnN0cnVjdG9yKTtcclxuICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKG5nRmllbGRzKS5maWx0ZXIoKGZpZWxkTmFtZTogc3RyaW5nKSA9PiBuZ0ZpZWxkc1tmaWVsZE5hbWVdLmVuYWJsZU11bHRpTGFuZ0lucHV0KTtcclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmuIXpmaTpgJrov4fpqozor4Hkv6Hmga9cclxuICAgKiBAcGFyYW0gZXJyb3JzIOmqjOivgeWksei0peS/oeaBr1xyXG4gICAqL1xyXG4gIHN0cmlwRW1wdHlFcnJvcnMoZXJyb3JzOiBWYWxpZGF0aW9uRXJyb3JbXSkge1xyXG4gICAgcmV0dXJuIGVycm9ycy5maWx0ZXIoZXJyb3IgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IuY2hpbGRyZW4pIHtcclxuICAgICAgICBlcnJvci5jaGlsZHJlbiA9IHRoaXMuc3RyaXBFbXB0eUVycm9ycyhlcnJvci5jaGlsZHJlbik7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChPYmplY3Qua2V5cyhlcnJvci5jb25zdHJhaW50cykubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgaWYgKGVycm9yLmNoaWxkcmVuLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBkZWxldGUgZXJyb3IuY29uc3RyYWludHM7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog55Sf5oiQ5pyq6YCa6L+H6aqM6K+B55qE5a+56LGhXHJcbiAgICogQHBhcmFtIG9iamVjdCDopoHpqozor4HnmoTlrp7kvZPlrp7kvovlr7nosaFcclxuICAgKiBAcGFyYW0gdmFsdWUg6KaB6aqM6K+B55qE5YC8XHJcbiAgICogQHBhcmFtIHByb3BlcnR5TmFtZSDlvoXpqozor4HnmoTlrp7kvZPlsZ7mgKflkI3np7BcclxuICAgKiBAcGFyYW0gaW5kZXgg6aqM6K+B5pWw5o2u57Si5byVXHJcbiAgICogQHBhcmFtIGZpZWxkIOW+hemqjOivgeWtl+autVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2VuZXJhdGVWYWxpZGF0aW9uRXJyb3Iob2JqZWN0OiBhbnksIHZhbHVlOiBhbnksIHByb3BlcnR5OiBzdHJpbmcsIHByb3BlcnR5TmFtZT86IHN0cmluZywgaW5kZXg/OiBudW1iZXIsIGZpZWxkPzogc3RyaW5nLCBmcmFtZUNvbnRleHQ/OiBGcmFtZUNvbnRleHQsIGZ1bGxQYXRoPzogc3RyaW5nKSB7XHJcbiAgICBjb25zdCB2YWxpZGF0aW9uRXJyb3IgPSBuZXcgVmFsaWRhdGlvbkVycm9yKCk7XHJcblxyXG4gICAgdmFsaWRhdGlvbkVycm9yLnRhcmdldCA9IG9iamVjdDtcclxuICAgIHZhbGlkYXRpb25FcnJvci52YWx1ZSA9IHZhbHVlO1xyXG5cclxuICAgIHZhbGlkYXRpb25FcnJvci5wcm9wZXJ0eSA9IHByb3BlcnR5O1xyXG4gICAgdmFsaWRhdGlvbkVycm9yLnByb3BlcnR5TmFtZSA9IHByb3BlcnR5TmFtZTtcclxuICAgIHZhbGlkYXRpb25FcnJvci5maWVsZCA9IGZpZWxkO1xyXG4gICAgdmFsaWRhdGlvbkVycm9yLmluZGV4ID0gaW5kZXg7XHJcbiAgICB2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4gPSBbXTtcclxuICAgIHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50cyA9IHt9O1xyXG4gICAgaWYgKGZyYW1lQ29udGV4dCkge1xyXG4gICAgICB2YWxpZGF0aW9uRXJyb3IuZnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0O1xyXG4gICAgfVxyXG4gICAgdmFsaWRhdGlvbkVycm9yLmZ1bGxQYXRoID0gZnVsbFBhdGg7XHJcbiAgICByZXR1cm4gdmFsaWRhdGlvbkVycm9yO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6aqM6K+B5a6e5L2T5Lit55qE5bGe5oCnXHJcbiAgICogQHBhcmFtIG9iamVjdCDopoHpqozor4HnmoTlrp7kvZPlrp7kvovlr7nosaFcclxuICAgKiBAcGFyYW0gdmFsdWUg6KaB6aqM6K+B55qE5YC8XHJcbiAgICogQHBhcmFtIHZhbGlkYXRlUnVsZXMg6aqM6K+B6KeE5YiZXHJcbiAgICogQHBhcmFtIGVycm9yTWFwIOmavuivgeS/oeaBr+OAgntba2V5XTogbWVzc2FnZX1cclxuICAgKlxyXG4gICAqIGtleTog6aqM6K+B6KeE5YiZ5ZCN56ewXHJcbiAgICogbWVzc2FnZTog6aqM6K+B5L+h5oGvXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBkZWZhdWx0VmFsaWRhdGlvbnMob2JqZWN0OiBULCB2YWx1ZTogYW55LCB2YWxpZGF0ZVJ1bGVzOiBWYWxpZGF0ZVJ1bGVbXSwgdmFsaWRhdGlvbkVycm9yOiBWYWxpZGF0aW9uRXJyb3IsIGlzTXVsdExhbmd1YWdlRmllbGQ/OiBib29sZWFuLCBjdXJyZW50Um93SWQ/OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGVycm9yTWFwID0gdmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzO1xyXG4gICAgcmV0dXJuIHZhbGlkYXRlUnVsZXNcclxuICAgICAgLmZpbHRlcigodmFsaWRhdGVSdWxlKSA9PiB7XHJcbiAgICAgICAgLy8g6aqM6K+B5a6e5L2T5bGe5oCn5piv5ZCm56ym5ZCI6KeE5YiZXHJcbiAgICAgICAgY29uc3QgdmFsaWRWYWx1ZSA9IHRoaXMudmFsaWRhdG9yLnZhbGlkYXRlVmFsdWVCeU1ldGFkYXRhKG9iamVjdCwgdmFsdWUsIHZhbGlkYXRlUnVsZSwgaXNNdWx0TGFuZ3VhZ2VGaWVsZCwgY3VycmVudFJvd0lkKTtcclxuICAgICAgICBpZiAodmFsaWRWYWx1ZSBpbnN0YW5jZW9mIFByb21pc2UpIHtcclxuICAgICAgICAgIGNvbnN0IHByb21pc2UgPSB2YWxpZFZhbHVlLnRoZW4oKGlzVmFsaWQpID0+IHtcclxuICAgICAgICAgICAgaWYgKCFpc1ZhbGlkKSB7XHJcbiAgICAgICAgICAgICAgY29uc3QgeyB0eXBlLCBtZXNzYWdlU3RyaW5nOiBtZXNzYWdlIH0gPSB0aGlzLmNyZWF0ZVZhbGlkYXRpb25FcnJvcihvYmplY3QsIHZhbHVlLCB2YWxpZGF0ZVJ1bGUpO1xyXG4gICAgICAgICAgICAgIGVycm9yTWFwW3R5cGVdID0gbWVzc2FnZTtcclxuICAgICAgICAgICAgICB2YWxpZGF0aW9uRXJyb3IucnVsZSA9IHZhbGlkYXRlUnVsZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICB0aGlzLmF3YWl0aW5nUHJvbWlzZXMucHVzaChwcm9taXNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuICF2YWxpZFZhbHVlO1xyXG4gICAgICB9KVxyXG4gICAgICAuZm9yRWFjaCgodmFsaWRhdGVSdWxlKSA9PiB7XHJcbiAgICAgICAgLy8g5LiN56ym5ZCI6KeE5YiZ77yM55Sf5oiQ6ZSZ6K+v5L+h5oGvXHJcbiAgICAgICAgY29uc3QgeyB0eXBlOiBrZXksIG1lc3NhZ2VTdHJpbmc6IG1lc3NhZ2UgfSA9IHRoaXMuY3JlYXRlVmFsaWRhdGlvbkVycm9yKG9iamVjdCwgdmFsdWUsIHZhbGlkYXRlUnVsZSk7XHJcbiAgICAgICAgZXJyb3JNYXBba2V5XSA9IG1lc3NhZ2U7XHJcbiAgICAgICAgdmFsaWRhdGlvbkVycm9yLnJ1bGUgPSB2YWxpZGF0ZVJ1bGU7XHJcbiAgICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6aqM6K+B5YiX6KGo5Lit55qE5q+P5p2h6K6w5b2VXHJcbiAgICogQHBhcmFtIG9iamVjdCDopoHpqozor4HnmoTlrp7kvZPlrp7kvovlr7nosaFcclxuICAgKiBAcGFyYW0gZXJyb3JzIOmqjOivgeWksei0peeahOS/oeaBr+mbhuWQiFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eSDlsZ7mgKflkI3np7BcclxuICAgKiBAcGFyYW0gcGFyZW50SW5kZXgg5b2T5YmN6ZuG5ZCI55qE54i25a+56LGh5omA5bGe6ZuG5ZCI5YiX6KGo5Lit55qE57Si5byV44CCXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBsaXN0VmFsaWRhdGlvbnMoXHJcbiAgICBvYmplY3Q6IGFueSxcclxuICAgIGVycm9yczogVmFsaWRhdGlvbkVycm9yW10sXHJcbiAgICBwcm9wZXJ0eT86IHN0cmluZyxcclxuICAgIHBhcmVudEluZGV4PzogYW55LFxyXG4gICAgZXh0ZXJuYWxSdWxlcz86IE1hcDxzdHJpbmcsIFZhbGlkYXRlUnVsZVtdPixcclxuICAgIGZyYW1lQ29udGV4dD86IEZyYW1lQ29udGV4dFxyXG4gICkge1xyXG4gICAgY29uc3QgSU5ERVhfTEFCRUwgPSBcIl9fQUNUVUFMX0lOREVYX19cIjtcclxuICAgIGNvbnN0IGxpc3RGaWVsZHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0xpc3Qob2JqZWN0LmNvbnN0cnVjdG9yKTtcclxuICAgIGlmICghbGlzdEZpZWxkcykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBsZXQga2V5cyA9IE9iamVjdC5rZXlzKGxpc3RGaWVsZHMpO1xyXG4gICAgaWYgKHByb3BlcnR5KSB7XHJcbiAgICAgIGtleXMgPSBrZXlzLmZpbHRlcihrZXkgPT4ga2V5ID09PSBwcm9wZXJ0eSk7XHJcbiAgICB9XHJcbiAgICBrZXlzLmZvckVhY2gocHJvcGVydHlOYW1lID0+IHtcclxuICAgICAgY29uc3QgbWV0YWRhdGEgPSBsaXN0RmllbGRzW3Byb3BlcnR5TmFtZV07XHJcbiAgICAgIGNvbnN0IGNselR5cGUgPSBtZXRhZGF0YS50eXBlO1xyXG4gICAgICBjb25zdCB2YWx1ZSA9IG9iamVjdFtwcm9wZXJ0eU5hbWVdIGFzIEVudGl0eUxpc3Q8VD47XHJcbiAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgIGNvbnN0IHBhcmVudFBhdGhzID0gb2JqZWN0LmdldFBhdGhzKCkucGF0aCB8fCBbXTtcclxuICAgICAgICBwYXJlbnRQYXRocy5wdXNoKHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgY29uc3QgdmFsaWRhdGlvbkVycm9yID0gdGhpcy5nZW5lcmF0ZVZhbGlkYXRpb25FcnJvcihvYmplY3QsIHZhbHVlLml0ZW1zLCBwYXJlbnRQYXRocy5qb2luKCcuJyksIHByb3BlcnR5TmFtZSwgcGFyZW50SW5kZXgpO1xyXG4gICAgICAgIHZhbGlkYXRpb25FcnJvci5pc0FycmF5ID0gdHJ1ZTtcclxuICAgICAgICBlcnJvcnMucHVzaCh2YWxpZGF0aW9uRXJyb3IpO1xyXG4gICAgICAgIHZhbHVlLml0ZW1zLmZvckVhY2goKGVudGl0eSwgaW5kZXgpID0+IHtcclxuICAgICAgICAgIGxldCBhY3R1YWxJbmRleCA9IGVudGl0eVtJTkRFWF9MQUJFTF0gPyBlbnRpdHlbSU5ERVhfTEFCRUxdIDogaW5kZXg7XHJcbiAgICAgICAgICB0aGlzLmV4ZWN1dGUoZW50aXR5LCB1bmRlZmluZWQsIHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbiwgdW5kZWZpbmVkLCBhY3R1YWxJbmRleCwgZXh0ZXJuYWxSdWxlcywgZW50aXR5LnByaW1hcnlWYWx1ZSwgZnJhbWVDb250ZXh0KTtcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDpqozor4Hlrp7kvZPkuK3nmoTlvJXnlKjlr7nosaFcclxuICAgKiBAcGFyYW0gb2JqZWN0IOimgemqjOivgeeahOWunuS9k+WvueixoVxyXG4gICAqIEBwYXJhbSBlcnJvcnMg6ZSZ6K+v5L+h5oGv6ZuG5ZCIXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBvYmplY3RWYWxpZGF0aW9ucyhvYmplY3Q6IFQsIGVycm9yczogVmFsaWRhdGlvbkVycm9yW10sIHByb3BlcnR5Pzogc3RyaW5nLCBwYXJlbnRJbmRleD86IGFueSwgZXh0ZXJuYWxSdWxlcz86IE1hcDxzdHJpbmcsIFZhbGlkYXRlUnVsZVtdPiwgY3VycmVudFJvd0lkPzogc3RyaW5nLCBmcmFtZUNvbnRleHQ/OiBGcmFtZUNvbnRleHQpIHtcclxuICAgIGNvbnN0IG9iamVjdEZpZWxkcyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nT2JqZWN0cyhvYmplY3QuY29uc3RydWN0b3IpO1xyXG4gICAgaWYgKCFvYmplY3RGaWVsZHMgfHwgT2JqZWN0LmtleXMob2JqZWN0RmllbGRzKS5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQga2V5cyA9IE9iamVjdC5rZXlzKG9iamVjdEZpZWxkcyk7XHJcbiAgICBpZiAocHJvcGVydHkpIHtcclxuICAgICAga2V5cyA9IGtleXMuZmlsdGVyKGtleSA9PiBrZXkgPT09IHByb3BlcnR5KTtcclxuICAgIH1cclxuICAgIGtleXMuZm9yRWFjaChwcm9wZXJ0eU5hbWUgPT4ge1xyXG4gICAgICBjb25zdCBtZXRhZGF0YSA9IG9iamVjdEZpZWxkc1twcm9wZXJ0eU5hbWVdO1xyXG4gICAgICBjb25zdCBvYmplY3RUeXBlID0gbWV0YWRhdGEudHlwZTtcclxuICAgICAgY29uc3QgdmFsdWUgPSBvYmplY3RbcHJvcGVydHlOYW1lXTtcclxuICAgICAgaWYgKHZhbHVlKSB7XHJcbiAgICAgICAgdGhpcy5leGVjdXRlKHZhbHVlLCB1bmRlZmluZWQsIGVycm9ycywgdW5kZWZpbmVkLCBwYXJlbnRJbmRleCwgZXh0ZXJuYWxSdWxlcywgY3VycmVudFJvd0lkLCBmcmFtZUNvbnRleHQpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIm+W7uumqjOivgeinhOWImeS/oeaBr1xyXG4gICAqIEBwYXJhbSBvYmplY3Qg6KaB6aqM6K+B55qE5a6e5L2T5a+56LGhXHJcbiAgICogQHBhcmFtIHZhbHVlIOmqjOivgeeahOWAvFxyXG4gICAqIEBwYXJhbSBtZXRhZGF0YSDpqozor4Hop4TliJlcclxuICAgKi9cclxuICBwcml2YXRlIGNyZWF0ZVZhbGlkYXRpb25FcnJvcihvYmplY3Q6IFQsIHZhbHVlOiBhbnksIG1ldGFkYXRhOiBWYWxpZGF0ZVJ1bGUpIHtcclxuICAgIC8vIGNvbnN0IHRhcmdldE5hbWUgPSBvYmplY3QuY29uc3RydWN0b3IgPyAob2JqZWN0LmNvbnN0cnVjdG9yIGFzIGFueSkubmFtZSA6IHVuZGVmaW5lZDtcclxuICAgIGNvbnN0IHR5cGUgPSBtZXRhZGF0YS50eXBlO1xyXG4gICAgLy8g6I635Y+W5qCh6aqM5o+Q56S65L+h5oGv77ya5YWI5L2/55So5YaF572u6KeE5YiZ6I635Y+W77yM6I635Y+W5LiN5Yiw5pe25L2/55So5YWD5pWw5o2u5LiK55qE5o+Q56S677yM5Lul5YW85a656KGo6L6+5byP5Zy65pmvXHJcbiAgICBsZXQgbWVzc2FnZSA9IFZhbGlkYXRpb25UeXBlcy5nZXRNZXNzYWdlKHR5cGUpO1xyXG5cclxuICAgIGlmICghbWVzc2FnZSkge1xyXG4gICAgICBtZXNzYWdlID0gbWV0YWRhdGEubWVzc2FnZTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoVmFsaWRhdGlvblR5cGVzLmlzVmFsaWRUeXBlKHR5cGUpICYmICh0eXBlID09PSBWYWxpZGF0aW9uVHlwZXMuTUFYVkFMVUUgfHwgdHlwZSA9PT0gVmFsaWRhdGlvblR5cGVzLk1JTlZBTFVFKSkge1xyXG4gICAgICBpZiAodGhpcy5pc0RhdGVTdHJpbmcodmFsdWUpICYmIG1ldGFkYXRhLmNvbnN0cmFpbnRzICYmIG1ldGFkYXRhLmNvbnN0cmFpbnRzLmxlbmd0aCkge1xyXG4gICAgICAgIC8vIOiOt+WPluaXpeacn+exu+Wei+eahOaPkOekuuS/oeaBr1xyXG4gICAgICAgIGNvbnN0IGV4dFR5cGUgPSB0eXBlID09PSBWYWxpZGF0aW9uVHlwZXMuTUlOVkFMVUUgPyBWYWxpZGF0aW9uVHlwZXMuTUlOX0RBVEUgOiBWYWxpZGF0aW9uVHlwZXMuTUFYX0RBVEU7XHJcbiAgICAgICAgbWVzc2FnZSA9IFZhbGlkYXRpb25UeXBlcy5nZXRNZXNzYWdlKGV4dFR5cGUpO1xyXG4gICAgICAgIC8qaWYgKG1ldGFkYXRhLmNvbnN0cmFpbnRzWzBdKSB7XHJcbiAgICAgICAgICBtZXRhZGF0YS5jb25zdHJhaW50c1swXSA9IERhdGVVdGlsLmZvcm1hdChtZXRhZGF0YS5jb25zdHJhaW50c1swXSwgJ3l5eXktTU0tZGQgSEg6bW06c3MnKTtcclxuICAgICAgICB9Ki9cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG1lc3NhZ2VTdHJpbmcgPSBWYWxpZGF0aW9uRXhlY3V0b3IucmVwbGFjZU1lc3NhZ2VTcGVjaWFsVG9rZW5zKG1lc3NhZ2UsIG1ldGFkYXRhLCB2YWx1ZSk7XHJcbiAgICByZXR1cm4geyB0eXBlLCBtZXNzYWdlU3RyaW5nLCBtZXRhZGF0YSB9O1xyXG4gIH1cclxuICBwcml2YXRlIGdldEZyYW1lQ29udGV4dChiaW5kaW5nUGF0aHM6IHN0cmluZ1tdLCBldmVudEZyYW1lQ29udGV4dD86IEZyYW1lQ29udGV4dCkge1xyXG4gICAgaWYgKCFiaW5kaW5nUGF0aHMgfHwgYmluZGluZ1BhdGhzLmxlbmd0aCA8IDEgfHwgIWV2ZW50RnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcGF0aHMgPSBiaW5kaW5nUGF0aHMuY29uY2F0KFtdKTtcclxuICAgIHBhdGhzLnBvcCgpO1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGggPSBwYXRocy5qb2luKCcvJyk7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSBldmVudEZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpLmZpbmQoKGNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4gY29udGV4dCAmJiBjb250ZXh0LnZpZXdNb2RlbCAmJiBjb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCAmJiBjb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLmpvaW4oJy8nKSA9PT0gYmluZGluZ1BhdGgpO1xyXG4gICAgcmV0dXJuIGZyYW1lQ29udGV4dCB8fCBudWxsO1xyXG4gIH1cclxuICBwcml2YXRlIGdldEZvcm0oYmluZGluZ1BhdGhzOiBzdHJpbmdbXSwgZXZlbnRGcmFtZUNvbnRleHQ/OiBGcmFtZUNvbnRleHQpIHtcclxuICAgIGlmICghYmluZGluZ1BhdGhzIHx8IGJpbmRpbmdQYXRocy5sZW5ndGggPCAxIHx8ICFldmVudEZyYW1lQ29udGV4dCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0RnJhbWVDb250ZXh0KGJpbmRpbmdQYXRocywgZXZlbnRGcmFtZUNvbnRleHQpO1xyXG4gICAgcmV0dXJuIGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQuZm9ybSB8fCBudWxsO1xyXG4gIH1cclxuICBwcml2YXRlIGdldEZvcm1Db250cm9sKGJpbmRpbmdQYXRoczogc3RyaW5nW10sIGV2ZW50RnJhbWVDb250ZXh0PzogRnJhbWVDb250ZXh0KSB7XHJcbiAgICBpZiAoIWJpbmRpbmdQYXRocyB8fCBiaW5kaW5nUGF0aHMubGVuZ3RoIDwgMSB8fCAhZXZlbnRGcmFtZUNvbnRleHQpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXRocyA9IGJpbmRpbmdQYXRocy5jb25jYXQoW10pO1xyXG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gcGF0aHMucG9wKCk7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSB0aGlzLmdldEZyYW1lQ29udGV4dChiaW5kaW5nUGF0aHMsIGV2ZW50RnJhbWVDb250ZXh0KTtcclxuICAgIGNvbnN0IGZvcm1Db250cm9sID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5mb3JtICYmIGZyYW1lQ29udGV4dC5mb3JtLm5nRm9ybUNvbnRyb2xzICYmIGZyYW1lQ29udGV4dC5mb3JtLm5nRm9ybUNvbnRyb2xzW3Byb3BlcnR5TmFtZV0gfHwgbnVsbDtcclxuICAgIHJldHVybiBmb3JtQ29udHJvbDtcclxuICB9XHJcbiAgaXNEYXRlU3RyaW5nKHZhbHVlOiBhbnkpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IHJlZ2V4ID0gL1xcZHs0fS0oMFsxLTldfDFbMC0yXSktKDBbMS05XXxbMS0yXVswLTldfDNbMC0xXSkoVHxcXHM/KT8oKFswLTJdXFxkOlswLTVdXFxkKT8oOlswLTVdXFxkKD86XFwuXFxkKykpKT8oPzpafFxcK1swLTJdXFxkKD86XFw6WzAtNV1cXGQpPyk/L2c7XHJcbiAgICByZXR1cm4gcmVnZXgudGVzdCh2YWx1ZSk7XHJcbiAgfVxyXG59XHJcbiJdfQ==