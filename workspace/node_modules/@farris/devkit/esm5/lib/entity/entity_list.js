import * as tslib_1 from "tslib";
import { Subject, from } from 'rxjs';
import { ChangeSet } from '../changeset/change_set';
import { ModifyType } from '../changeset/types';
import { Entity } from './entity';
import { EntityFactory } from './entity_creator';
import { PARENT_CLASS, PARENT_PATH } from './types';
import { Validator } from './validator/validator';
/**
 * 实体集合列表
 */
var EntityList = /** @class */ (function () {
    // #endregion
    /**
     * @param data JSON数据集合
     * @param type 集合中的实体类型
     */
    function EntityList(data, type) {
        var _this = this;
        this.__type__ = 'EntityList';
        // #region 私有属性
        this.originalData = [];
        /**
         * 已废弃：请勿使用
         */
        this.listChanged = new Subject();
        /**
         * 已废弃：请勿使用
         */
        this.changeSet = new ChangeSet();
        /**
         * 已废弃：请勿使用
         */
        this.validator = new Validator();
        // #endregion
        // #region 公有属性
        /**
         * 集合改变时触发(新增、行记录修改、删除)
         * @event
         */
        this.onListChanged = this.listChanged.asObservable();
        this.clear();
        if (data) {
            // this.loadEntities(data);
            data.forEach(function (item) {
                _this.initEntity(EntityFactory(type, item));
            });
        }
    }
    Object.defineProperty(EntityList.prototype, "items", {
        /**
         * 获取项集合
         */
        get: function () {
            return this.rawData;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityList.prototype, "changes", {
        /**
         * 列表变更集
         */
        get: function () {
            return this.changeSet.changes;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 迭代器
     */
    EntityList.prototype[Symbol.iterator] = function () {
        return tslib_1.__generator(this, function (_a) {
            switch (_a.label) {
                case 0: return [5 /*yield**/, tslib_1.__values(this.items)];
                case 1:
                    _a.sent();
                    return [2 /*return*/];
            }
        });
    };
    // #region 公有方法
    /** 加载实体列表 */
    EntityList.prototype.loadEntities = function (entities) {
        var _this = this;
        this.clear();
        entities.forEach(function (entity) {
            _this.initEntity(entity);
        });
        // 发送Load变更
        var changeItem = {
            path: [],
            value: entities,
            preValue: undefined,
            type: ModifyType.Load,
            target: this
        };
        this.setChanges(changeItem);
    };
    /**
     * 清空
     */
    EntityList.prototype.clear = function () {
        this.rawData = [];
        this.originalData = [];
    };
    /**
     * 添加实体对象到集合中，并返回新加的对象
     * @param entity 实体对象
     * @param isCloned 克隆
     */
    EntityList.prototype.appendNew = function (entity, isCloned) {
        if (isCloned === void 0) { isCloned = false; }
        var newEntity = this.initEntity(entity, true);
        // 新增变更
        var changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Add
        };
        if (isCloned === true) {
            changeItem.type = ModifyType.Clone;
        }
        this.setChanges(changeItem);
        return newEntity;
    };
    /**
     * 在指定位置插入实体
     * @param entity 实体
     * @param position 插入位置
     */
    EntityList.prototype.insert = function (entity, position) {
        var newEntity = this.initEntity(entity, true);
        // 新增变更
        var changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Insert,
            position: position,
        };
        this.setChanges(changeItem);
        return newEntity;
    };
    /**
     * 追加实体
     */
    EntityList.prototype.appendEntity = function (entity) {
        var newEntity = this.initEntity(entity, true);
        // 新增变更
        var changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Add
        };
        this.setChanges(changeItem);
    };
    /**
     * 批量追加实体
     */
    EntityList.prototype.appendEntities = function (entities) {
        var _this = this;
        var newEntites = entities.map(function (entity) {
            return _this.initEntity(entity, true);
        });
        var changeItem = {
            path: [],
            value: newEntites,
            preValue: undefined,
            type: ModifyType.Add
        };
        this.setChanges(changeItem);
    };
    /**
     * 删除指定主键ID 的实体对象，返回布尔，true 删除成功，false 删除失败
     * @param primaryId 主键ID
     */
    EntityList.prototype.remove = function (primaryId) {
        var _a;
        var total = this.count();
        var indexToRemove = this.rawData.findIndex(function (entity) {
            return entity.primaryValue === primaryId;
        });
        if (indexToRemove === -1) {
            return false;
        }
        var entityToRemove = this.rawData[indexToRemove];
        this.rawData.splice(indexToRemove, 1);
        // 删除变更
        var changeItem = {
            path: [],
            value: (_a = {}, _a[entityToRemove.primaryProperty.dataField] = primaryId, _a),
            preValue: undefined,
            type: ModifyType.Remove
        };
        this.updateIndex(total);
        this.setChanges(changeItem);
        return true;
    };
    /**
     * 从集合中获取指定ID值的实体对象
     * @param id 主键值
     */
    EntityList.prototype.get = function (id) {
        return this.items.find(function (item) {
            return item.primaryValue === id;
        });
    };
    /**
     * 将变更记录添加到集合变更集中
     * @param value 变更记录
     */
    EntityList.prototype.setChanges = function (modinfo) {
        // 向app层发送的变更
        this.listChanged.next(modinfo);
        // 构造向changeSet中添加的chagne
        var change = Object.assign({}, modinfo);
        if ((modinfo.type === ModifyType.Add || modinfo.type === ModifyType.Insert || modinfo.type === ModifyType.Clone) && modinfo.value[0] instanceof Entity) {
            change.value = [modinfo.value[0].data];
        }
        this.changeSet.append(change);
    };
    /** 集合总记录数 */
    EntityList.prototype.count = function () {
        return this.items.length;
    };
    /**
     * 获取实体对象的索引值
     */
    EntityList.prototype.indexOf = function (entity) {
        return this.items.indexOf(entity);
    };
    /**
     * 计算集合中某个属性的总和
     * @param propertyName 属性名称
     */
    EntityList.prototype.sum = function (propertyName) {
        if (this.count() === 0) {
            return 0;
        }
        return this.items.reduce(function (val, curr) {
            return val + curr[propertyName];
        }, 0);
    };
    /**
     * 集合数据验证
     */
    EntityList.prototype.validate = function () {
        var propertyName = this.getPropertyName();
        return from(this.validator.validate(this[PARENT_CLASS], propertyName));
    };
    /**
     * 已废弃：请使用toJSON方法代替
     * @deprecated
     */
    EntityList.prototype.toJson = function () {
        return this.rawData;
    };
    /**
     * 转换为JSON格式
     */
    EntityList.prototype.toJSON = function () {
        var result = [];
        this.items.forEach(function (entity) {
            result.push(entity.toJSON());
        });
        return result;
    };
    EntityList.prototype.toArray = function () {
        return this.items;
    };
    // #endregion
    // #region 私有方法
    /**
     * 实体初始化
     * @param entity 实体
     */
    EntityList.prototype.initEntity = function (entity, isNewEntity) {
        var _this = this;
        if (isNewEntity === void 0) { isNewEntity = false; }
        entity[PARENT_CLASS] = this;
        entity[PARENT_PATH] = this[PARENT_PATH];
        entity.onValueChanged.subscribe(function (v) {
            var path = v.path;
            var value = v.value;
            var preValue = v.preValue;
            var operator = v.type;
            var subChanges = { path: path, value: value, preValue: preValue, type: operator };
            if (v.changeSetValue !== undefined) {
                subChanges['changeSetValue'] = v.changeSetValue;
            }
            _this.setChanges(subChanges);
        });
        // TODO: 添加数据验证逻辑代码
        var newLength = this.rawData.push(entity);
        this[newLength - 1] = entity;
        if (!isNewEntity) {
            this.originalData.push(entity.toJSON());
        }
        return entity;
    };
    /**
     * 更新索引
     * @param total 总记录数
     */
    EntityList.prototype.updateIndex = function (total) {
        var _this = this;
        for (var i = 0; i < total; i++) {
            delete this[i];
        }
        this.rawData.forEach(function (entity, index) {
            _this[index] = entity;
        });
    };
    /**
     * 获取属性名称
     */
    EntityList.prototype.getPropertyName = function () {
        var path = this[PARENT_PATH];
        if (path && path.length) {
            var name_1 = path[path.length - 1];
            return name_1;
        }
        return undefined;
    };
    return EntityList;
}());
export { EntityList };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X2xpc3QuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9lbnRpdHkvZW50aXR5X2xpc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQWMsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNwRCxPQUFPLEVBQWdCLFVBQVUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzlELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFhLE1BQU0sU0FBUyxDQUFDO0FBQy9ELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQU1sRDs7R0FFRztBQUNIO0lBOERFLGFBQWE7SUFHYjs7O09BR0c7SUFDSCxvQkFBWSxJQUFZLEVBQUUsSUFBZ0I7UUFBMUMsaUJBUUM7UUE1RU0sYUFBUSxHQUFHLFlBQVksQ0FBQztRQUUvQixlQUFlO1FBQ1AsaUJBQVksR0FBVSxFQUFFLENBQUM7UUFNakM7O1dBRUc7UUFDSyxnQkFBVyxHQUFHLElBQUksT0FBTyxFQUFnQixDQUFDO1FBRWxEOztXQUVHO1FBQ0ssY0FBUyxHQUFHLElBQUksU0FBUyxFQUFFLENBQUM7UUFFcEM7O1dBRUc7UUFDSyxjQUFTLEdBQUcsSUFBSSxTQUFTLEVBQUssQ0FBQztRQUV2QyxhQUFhO1FBR2IsZUFBZTtRQUVmOzs7V0FHRztRQUNJLGtCQUFhLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQW9DckQsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2IsSUFBSSxJQUFJLEVBQUU7WUFDUiwyQkFBMkI7WUFDM0IsSUFBSSxDQUFD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LElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM1QyxJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUM3QixJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ2hCLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1NBQ3pDO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVEOzs7T0FHRztJQUNLLGdDQUFXLEdBQW5CLFVBQW9CLEtBQWE7UUFBakMsaUJBT0M7UUFOQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzlCLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ2hCO1FBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFBQyxNQUFNLEVBQUUsS0FBSztZQUNqQyxLQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsTUFBTSxDQUFDO1FBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0ssb0NBQWUsR0FBdkI7UUFDRSxJQUFNLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDL0IsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUN2QixJQUFNLE1BQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNuQyxPQUFPLE1BQUksQ0FBQztTQUNiO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUlILGlCQUFDO0FBQUQsQ0FBQyxBQS9WRCxJQStWQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YmplY3QsIE9ic2VydmFibGUsIGZyb20gfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgQ2hhbmdlU2V0IH0gZnJvbSAnLi4vY2hhbmdlc2V0L2NoYW5nZV9zZXQnO1xyXG5pbXBvcnQgeyBNb2RpZmljYXRpb24sIE1vZGlmeVR5cGUgfSBmcm9tICcuLi9jaGFuZ2VzZXQvdHlwZXMnO1xyXG5pbXBvcnQgeyBFbnRpdHkgfSBmcm9tICcuL2VudGl0eSc7XHJcbmltcG9ydCB7IEVudGl0eUZhY3RvcnkgfSBmcm9tICcuL2VudGl0eV9jcmVhdG9yJztcclxuaW1wb3J0IHsgUEFSRU5UX0NMQVNTLCBQQVJFTlRfUEFUSCwgQ2xhc3NUeXBlIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IFZhbGlkYXRvciB9IGZyb20gJy4vdmFsaWRhdG9yL3ZhbGlkYXRvcic7XHJcbmltcG9ydCB7IFZhbGlkYXRpb25SZXN1bHQgfSBmcm9tICcuL3ZhbGlkYXRvci90eXBlcyc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElMaXN0PFQ+IHtcclxuICBbaW5kZXg6IG51bWJlcl06IFQ7XHJcbn1cclxuLyoqXHJcbiAqIOWunuS9k+mbhuWQiOWIl+ihqFxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIEVudGl0eUxpc3Q8VCBleHRlbmRzIEVudGl0eT4gaW1wbGVtZW50cyBJTGlzdDxUPiwgSXRlcmFibGU8VD4ge1xyXG4gIHB1YmxpYyBfX3R5cGVfXyA9ICdFbnRpdHlMaXN0JztcclxuXHJcbiAgLy8gI3JlZ2lvbiDnp4HmnInlsZ7mgKdcclxuICBwcml2YXRlIG9yaWdpbmFsRGF0YTogYW55W10gPSBbXTtcclxuICAvKipcclxuICAgKiDlt7Llup/lvIPvvJror7fli7/kvb/nlKhcclxuICAgKi9cclxuICBwcml2YXRlIHJhd0RhdGE6IFRbXTtcclxuXHJcbiAgLyoqXHJcbiAgICog5bey5bqf5byD77ya6K+35Yu/5L2/55SoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBsaXN0Q2hhbmdlZCA9IG5ldyBTdWJqZWN0PE1vZGlmaWNhdGlvbj4oKTtcclxuXHJcbiAgLyoqXHJcbiAgICog5bey5bqf5byD77ya6K+35Yu/5L2/55SoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjaGFuZ2VTZXQgPSBuZXcgQ2hhbmdlU2V0KCk7XHJcblxyXG4gIC8qKlxyXG4gICAqIOW3suW6n+W8g++8muivt+WLv+S9v+eUqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgdmFsaWRhdG9yID0gbmV3IFZhbGlkYXRvcjxUPigpO1xyXG5cclxuICAvLyAjZW5kcmVnaW9uXHJcblxyXG5cclxuICAvLyAjcmVnaW9uIOWFrOacieWxnuaAp1xyXG5cclxuICAvKipcclxuICAgKiDpm4blkIjmlLnlj5jml7bop6blj5Eo5paw5aKe44CB6KGM6K6w5b2V5L+u5pS544CB5Yig6ZmkKVxyXG4gICAqIEBldmVudFxyXG4gICAqL1xyXG4gIHB1YmxpYyBvbkxpc3RDaGFuZ2VkID0gdGhpcy5saXN0Q2hhbmdlZC5hc09ic2VydmFibGUoKTtcclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W6aG56ZuG5ZCIXHJcbiAgICovXHJcbiAgcHVibGljIGdldCBpdGVtcygpOiBUW10ge1xyXG4gICAgcmV0dXJuIHRoaXMucmF3RGF0YTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIl+ihqOWPmOabtOmbhlxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQgY2hhbmdlcygpIHtcclxuICAgIHJldHVybiB0aGlzLmNoYW5nZVNldC5jaGFuZ2VzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5oyH5a6a57Si5byV5aSE55qE5YC8XHJcbiAgICovXHJcbiAgW2luZGV4OiBudW1iZXJdOiBUO1xyXG5cclxuICAvKipcclxuICAgKiDov63ku6PlmahcclxuICAgKi9cclxuICAqW1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmF0b3I8VD4ge1xyXG4gICAgeWllbGQqIHRoaXMuaXRlbXM7XHJcbiAgfVxyXG5cclxuICAvLyAjZW5kcmVnaW9uXHJcblxyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gZGF0YSBKU09O5pWw5o2u6ZuG5ZCIXHJcbiAgICogQHBhcmFtIHR5cGUg6ZuG5ZCI5Lit55qE5a6e5L2T57G75Z6LXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoZGF0YT86IGFueVtdLCB0eXBlPzogQ2xhc3NUeXBlKSB7XHJcbiAgICB0aGlzLmNsZWFyKCk7XHJcbiAgICBpZiAoZGF0YSkge1xyXG4gICAgICAvLyB0aGlzLmxvYWRFbnRpdGllcyhkYXRhKTtcclxuICAgICAgZGF0YS5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgIHRoaXMuaW5pdEVudGl0eShFbnRpdHlGYWN0b3J5KHR5cGUsIGl0ZW0pKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcbiAgLy8gI3JlZ2lvbiDlhazmnInmlrnms5VcclxuXHJcbiAgLyoqIOWKoOi9veWunuS9k+WIl+ihqCAqL1xyXG4gIHB1YmxpYyBsb2FkRW50aXRpZXMoZW50aXRpZXM6IFRbXSkge1xyXG4gICAgdGhpcy5jbGVhcigpO1xyXG5cclxuICAgIGVudGl0aWVzLmZvckVhY2goZW50aXR5ID0+IHtcclxuICAgICAgdGhpcy5pbml0RW50aXR5KGVudGl0eSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyDlj5HpgIFMb2Fk5Y+Y5pu0XHJcbiAgICBjb25zdCBjaGFuZ2VJdGVtID0ge1xyXG4gICAgICBwYXRoOiBbXSxcclxuICAgICAgdmFsdWU6IGVudGl0aWVzLFxyXG4gICAgICBwcmVWYWx1ZTogdW5kZWZpbmVkLFxyXG4gICAgICB0eXBlOiBNb2RpZnlUeXBlLkxvYWQsXHJcbiAgICAgIHRhcmdldDogdGhpc1xyXG4gICAgfTtcclxuICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VJdGVtKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5riF56m6XHJcbiAgICovXHJcbiAgcHVibGljIGNsZWFyKCkge1xyXG4gICAgdGhpcy5yYXdEYXRhID0gW107XHJcbiAgICB0aGlzLm9yaWdpbmFsRGF0YSA9IFtdO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5re75Yqg5a6e5L2T5a+56LGh5Yiw6ZuG5ZCI5Lit77yM5bm26L+U5Zue5paw5Yqg55qE5a+56LGhXHJcbiAgICogQHBhcmFtIGVudGl0eSDlrp7kvZPlr7nosaFcclxuICAgKiBAcGFyYW0gaXNDbG9uZWQg5YWL6ZqGXHJcbiAgICovXHJcbiAgcHVibGljIGFwcGVuZE5ldyhlbnRpdHk6IFQsIGlzQ2xvbmVkOiBib29sZWFuID0gZmFsc2UpOiBUIHtcclxuICAgIGNvbnN0IG5ld0VudGl0eSA9IHRoaXMuaW5pdEVudGl0eShlbnRpdHksIHRydWUpO1xyXG4gICAgLy8g5paw5aKe5Y+Y5pu0XHJcbiAgICBjb25zdCBjaGFuZ2VJdGVtID0ge1xyXG4gICAgICBwYXRoOiBbXSxcclxuICAgICAgdmFsdWU6IFtuZXdFbnRpdHldLFxyXG4gICAgICBwcmVWYWx1ZTogdW5kZWZpbmVkLFxyXG4gICAgICB0eXBlOiBNb2RpZnlUeXBlLkFkZFxyXG4gICAgfTtcclxuICAgIGlmIChpc0Nsb25lZCA9PT0gdHJ1ZSkge1xyXG4gICAgICBjaGFuZ2VJdGVtLnR5cGUgPSBNb2RpZnlUeXBlLkNsb25lO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zZXRDaGFuZ2VzKGNoYW5nZUl0ZW0pO1xyXG4gICAgcmV0dXJuIG5ld0VudGl0eTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Zyo5oyH5a6a5L2N572u5o+S5YWl5a6e5L2TXHJcbiAgICogQHBhcmFtIGVudGl0eSDlrp7kvZNcclxuICAgKiBAcGFyYW0gcG9zaXRpb24g5o+S5YWl5L2N572uXHJcbiAgICovXHJcbiAgcHVibGljIGluc2VydChlbnRpdHk6IFQsIHBvc2l0aW9uPzogMSB8IC0xKTogVCB7XHJcbiAgICBjb25zdCBuZXdFbnRpdHkgPSB0aGlzLmluaXRFbnRpdHkoZW50aXR5LCB0cnVlKTtcclxuXHJcbiAgICAvLyDmlrDlop7lj5jmm7RcclxuICAgIGNvbnN0IGNoYW5nZUl0ZW0gPSB7XHJcbiAgICAgIHBhdGg6IFtdLFxyXG4gICAgICB2YWx1ZTogW25ld0VudGl0eV0sXHJcbiAgICAgIHByZVZhbHVlOiB1bmRlZmluZWQsXHJcbiAgICAgIHR5cGU6IE1vZGlmeVR5cGUuSW5zZXJ0LFxyXG4gICAgICBwb3NpdGlvbjogcG9zaXRpb24sXHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VJdGVtKTtcclxuICAgIHJldHVybiBuZXdFbnRpdHk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOi/veWKoOWunuS9k1xyXG4gICAqL1xyXG4gIHB1YmxpYyBhcHBlbmRFbnRpdHkoZW50aXR5OiBUKTogdm9pZCB7XHJcbiAgICBjb25zdCBuZXdFbnRpdHkgPSB0aGlzLmluaXRFbnRpdHkoZW50aXR5LCB0cnVlKTtcclxuICAgIC8vIOaWsOWinuWPmOabtFxyXG4gICAgY29uc3QgY2hhbmdlSXRlbSA9IHtcclxuICAgICAgcGF0aDogW10sXHJcbiAgICAgIHZhbHVlOiBbbmV3RW50aXR5XSxcclxuICAgICAgcHJlVmFsdWU6IHVuZGVmaW5lZCxcclxuICAgICAgdHlwZTogTW9kaWZ5VHlwZS5BZGRcclxuICAgIH07XHJcblxyXG4gICAgdGhpcy5zZXRDaGFuZ2VzKGNoYW5nZUl0ZW0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5om56YeP6L+95Yqg5a6e5L2TXHJcbiAgICovXHJcbiAgcHVibGljIGFwcGVuZEVudGl0aWVzKGVudGl0aWVzOiBUW10pOiB2b2lkIHtcclxuICAgIGNvbnN0IG5ld0VudGl0ZXMgPSBlbnRpdGllcy5tYXAoKGVudGl0eTogVCkgPT4ge1xyXG4gICAgICByZXR1cm4gdGhpcy5pbml0RW50aXR5KGVudGl0eSwgdHJ1ZSk7XHJcbiAgICB9KTtcclxuICAgIGNvbnN0IGNoYW5nZUl0ZW0gPSB7XHJcbiAgICAgIHBhdGg6IFtdLFxyXG4gICAgICB2YWx1ZTogbmV3RW50aXRlcyxcclxuICAgICAgcHJlVmFsdWU6IHVuZGVmaW5lZCxcclxuICAgICAgdHlwZTogTW9kaWZ5VHlwZS5BZGRcclxuICAgIH07XHJcbiAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlSXRlbSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliKDpmaTmjIflrprkuLvplK5JRCDnmoTlrp7kvZPlr7nosaHvvIzov5Tlm57luIPlsJTvvIx0cnVlIOWIoOmZpOaIkOWKn++8jGZhbHNlIOWIoOmZpOWksei0pVxyXG4gICAqIEBwYXJhbSBwcmltYXJ5SWQg5Li76ZSuSURcclxuICAgKi9cclxuICBwdWJsaWMgcmVtb3ZlKHByaW1hcnlJZDogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCB0b3RhbCA9IHRoaXMuY291bnQoKTtcclxuICAgIGNvbnN0IGluZGV4VG9SZW1vdmUgPSB0aGlzLnJhd0RhdGEuZmluZEluZGV4KChlbnRpdHk6IEVudGl0eSkgPT4ge1xyXG4gICAgICByZXR1cm4gZW50aXR5LnByaW1hcnlWYWx1ZSA9PT0gcHJpbWFyeUlkO1xyXG4gICAgfSk7XHJcbiAgICBpZiAoaW5kZXhUb1JlbW92ZSA9PT0gLTEpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZW50aXR5VG9SZW1vdmUgPSB0aGlzLnJhd0RhdGFbaW5kZXhUb1JlbW92ZV07XHJcbiAgICB0aGlzLnJhd0RhdGEuc3BsaWNlKGluZGV4VG9SZW1vdmUsIDEpO1xyXG5cclxuICAgIC8vIOWIoOmZpOWPmOabtFxyXG4gICAgY29uc3QgY2hhbmdlSXRlbSA9IHtcclxuICAgICAgcGF0aDogW10sXHJcbiAgICAgIHZhbHVlOiB7IFtlbnRpdHlUb1JlbW92ZS5wcmltYXJ5UHJvcGVydHkuZGF0YUZpZWxkXTogcHJpbWFyeUlkIH0sXHJcbiAgICAgIHByZVZhbHVlOiB1bmRlZmluZWQsXHJcbiAgICAgIHR5cGU6IE1vZGlmeVR5cGUuUmVtb3ZlXHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMudXBkYXRlSW5kZXgodG90YWwpO1xyXG4gICAgdGhpcy5zZXRDaGFuZ2VzKGNoYW5nZUl0ZW0pO1xyXG5cclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5LuO6ZuG5ZCI5Lit6I635Y+W5oyH5a6aSUTlgLznmoTlrp7kvZPlr7nosaFcclxuICAgKiBAcGFyYW0gaWQg5Li76ZSu5YC8XHJcbiAgICovXHJcbiAgcHVibGljIGdldChpZDogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gdGhpcy5pdGVtcy5maW5kKGl0ZW0gPT4ge1xyXG4gICAgICByZXR1cm4gaXRlbS5wcmltYXJ5VmFsdWUgPT09IGlkO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlsIblj5jmm7TorrDlvZXmt7vliqDliLDpm4blkIjlj5jmm7Tpm4bkuK1cclxuICAgKiBAcGFyYW0gdmFsdWUg5Y+Y5pu06K6w5b2VXHJcbiAgICovXHJcbiAgcHVibGljIHNldENoYW5nZXMobW9kaW5mbzogTW9kaWZpY2F0aW9uKSB7XHJcblxyXG4gICAgLy8g5ZCRYXBw5bGC5Y+R6YCB55qE5Y+Y5pu0XHJcbiAgICB0aGlzLmxpc3RDaGFuZ2VkLm5leHQobW9kaW5mbyk7XHJcblxyXG4gICAgLy8g5p6E6YCg5ZCRY2hhbmdlU2V05Lit5re75Yqg55qEY2hhZ25lXHJcbiAgICBjb25zdCBjaGFuZ2UgPSBPYmplY3QuYXNzaWduKHt9LCBtb2RpbmZvKTtcclxuICAgIGlmICgobW9kaW5mby50eXBlID09PSBNb2RpZnlUeXBlLkFkZCB8fCBtb2RpbmZvLnR5cGUgPT09IE1vZGlmeVR5cGUuSW5zZXJ0IHx8IG1vZGluZm8udHlwZSA9PT0gTW9kaWZ5VHlwZS5DbG9uZSkgJiYgbW9kaW5mby52YWx1ZVswXSBpbnN0YW5jZW9mIEVudGl0eSkge1xyXG4gICAgICBjaGFuZ2UudmFsdWUgPSBbbW9kaW5mby52YWx1ZVswXS5kYXRhXTtcclxuICAgIH1cclxuICAgIHRoaXMuY2hhbmdlU2V0LmFwcGVuZChjaGFuZ2UpO1xyXG4gIH1cclxuXHJcbiAgLyoqIOmbhuWQiOaAu+iusOW9leaVsCAqL1xyXG4gIHB1YmxpYyBjb3VudCgpIHtcclxuICAgIHJldHVybiB0aGlzLml0ZW1zLmxlbmd0aDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWunuS9k+WvueixoeeahOe0ouW8leWAvFxyXG4gICAqL1xyXG4gIHB1YmxpYyBpbmRleE9mKGVudGl0eTogVCk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gdGhpcy5pdGVtcy5pbmRleE9mKGVudGl0eSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDorqHnrpfpm4blkIjkuK3mn5DkuKrlsZ7mgKfnmoTmgLvlkoxcclxuICAgKiBAcGFyYW0gcHJvcGVydHlOYW1lIOWxnuaAp+WQjeensFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdW0ocHJvcGVydHlOYW1lOiBzdHJpbmcpOiBudW1iZXIge1xyXG4gICAgaWYgKHRoaXMuY291bnQoKSA9PT0gMCkge1xyXG4gICAgICByZXR1cm4gMDtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLml0ZW1zLnJlZHVjZSgodmFsLCBjdXJyOiBUKSA9PiB7XHJcbiAgICAgIHJldHVybiB2YWwgKyBjdXJyW3Byb3BlcnR5TmFtZV07XHJcbiAgICB9LCAwKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOmbhuWQiOaVsOaNrumqjOivgVxyXG4gICAqL1xyXG4gIHB1YmxpYyB2YWxpZGF0ZSgpOiBPYnNlcnZhYmxlPFZhbGlkYXRpb25SZXN1bHQ+IHtcclxuICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHRoaXMuZ2V0UHJvcGVydHlOYW1lKCk7XHJcbiAgICByZXR1cm4gZnJvbSh0aGlzLnZhbGlkYXRvci52YWxpZGF0ZSh0aGlzW1BBUkVOVF9DTEFTU10sIHByb3BlcnR5TmFtZSkpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bey5bqf5byD77ya6K+35L2/55SodG9KU09O5pa55rOV5Luj5pu/XHJcbiAgICogQGRlcHJlY2F0ZWRcclxuICAgKi9cclxuICBwdWJsaWMgdG9Kc29uKCkge1xyXG4gICAgcmV0dXJuIHRoaXMucmF3RGF0YTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOi9rOaNouS4ukpTT07moLzlvI9cclxuICAgKi9cclxuICBwdWJsaWMgdG9KU09OKCk6IGFueVtdIHtcclxuICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xyXG4gICAgdGhpcy5pdGVtcy5mb3JFYWNoKChlbnRpdHk6IEVudGl0eSkgPT4ge1xyXG4gICAgICByZXN1bHQucHVzaChlbnRpdHkudG9KU09OKCkpO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHRvQXJyYXkoKTogVFtdIHtcclxuICAgIHJldHVybiB0aGlzLml0ZW1zO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLy8gI3JlZ2lvbiDnp4HmnInmlrnms5VcclxuXHJcbiAgLyoqXHJcbiAgICog5a6e5L2T5Yid5aeL5YyWXHJcbiAgICogQHBhcmFtIGVudGl0eSDlrp7kvZNcclxuICAgKi9cclxuICBwcml2YXRlIGluaXRFbnRpdHkoZW50aXR5OiBULCBpc05ld0VudGl0eTogYm9vbGVhbiA9IGZhbHNlKTogVCB7XHJcbiAgICBlbnRpdHlbUEFSRU5UX0NMQVNTXSA9IHRoaXM7XHJcbiAgICBlbnRpdHlbUEFSRU5UX1BBVEhdID0gdGhpc1tQQVJFTlRfUEFUSF07XHJcbiAgICBlbnRpdHkub25WYWx1ZUNoYW5nZWQuc3Vic2NyaWJlKCh2OiBNb2RpZmljYXRpb24pID0+IHtcclxuICAgICAgY29uc3QgcGF0aCA9IHYucGF0aDtcclxuICAgICAgY29uc3QgdmFsdWUgPSB2LnZhbHVlO1xyXG4gICAgICBjb25zdCBwcmVWYWx1ZSA9IHYucHJlVmFsdWU7XHJcbiAgICAgIGNvbnN0IG9wZXJhdG9yID0gdi50eXBlO1xyXG4gICAgICBjb25zdCBzdWJDaGFuZ2VzID0geyBwYXRoLCB2YWx1ZSwgcHJlVmFsdWUsIHR5cGU6IG9wZXJhdG9yIH07XHJcbiAgICAgIGlmICh2LmNoYW5nZVNldFZhbHVlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICBzdWJDaGFuZ2VzWydjaGFuZ2VTZXRWYWx1ZSddID0gdi5jaGFuZ2VTZXRWYWx1ZTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnNldENoYW5nZXMoc3ViQ2hhbmdlcyk7XHJcbiAgICB9KTtcclxuICAgIC8vIFRPRE86IOa3u+WKoOaVsOaNrumqjOivgemAu+i+keS7o+eggVxyXG4gICAgY29uc3QgbmV3TGVuZ3RoID0gdGhpcy5yYXdEYXRhLnB1c2goZW50aXR5KTtcclxuICAgIHRoaXNbbmV3TGVuZ3RoIC0gMV0gPSBlbnRpdHk7XHJcbiAgICBpZiAoIWlzTmV3RW50aXR5KSB7XHJcbiAgICAgIHRoaXMub3JpZ2luYWxEYXRhLnB1c2goZW50aXR5LnRvSlNPTigpKTtcclxuICAgIH1cclxuICAgIHJldHVybiBlbnRpdHk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmm7TmlrDntKLlvJVcclxuICAgKiBAcGFyYW0gdG90YWwg5oC76K6w5b2V5pWwXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB1cGRhdGVJbmRleCh0b3RhbDogbnVtYmVyKSB7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRvdGFsOyBpKyspIHtcclxuICAgICAgZGVsZXRlIHRoaXNbaV07XHJcbiAgICB9XHJcbiAgICB0aGlzLnJhd0RhdGEuZm9yRWFjaCgoZW50aXR5LCBpbmRleCkgPT4ge1xyXG4gICAgICB0aGlzW2luZGV4XSA9IGVudGl0eTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5bGe5oCn5ZCN56ewXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRQcm9wZXJ0eU5hbWUoKSB7XHJcbiAgICBjb25zdCBwYXRoID0gdGhpc1tQQVJFTlRfUEFUSF07XHJcbiAgICBpZiAocGF0aCAmJiBwYXRoLmxlbmd0aCkge1xyXG4gICAgICBjb25zdCBuYW1lID0gcGF0aFtwYXRoLmxlbmd0aCAtIDFdO1xyXG4gICAgICByZXR1cm4gbmFtZTtcclxuICAgIH1cclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgfVxyXG5cclxuICAvLyAjZW5kcmVnaW9uXHJcblxyXG59XHJcbiJdfQ==