import * as tslib_1 from "tslib";
import { ModifyType } from '../changeset/types';
import { PARENT_PATH, PARENT_CLASS } from './types';
import { Entity } from './entity';
import { takeUntil } from 'rxjs/operators';
/**
 * 支持动态字段集合的动态实体
 */
var DynamicEntity = /** @class */ (function (_super) {
    tslib_1.__extends(DynamicEntity, _super);
    /**
     * @param data JSON数据
     */
    function DynamicEntity(data) {
        var _this = _super.call(this, data) || this;
        _this.loadDynamicData(data);
        return _this;
    }
    Object.defineProperty(DynamicEntity.prototype, "IsNested", {
        /**
         * 是否是嵌套的动态实体
         */
        get: function () {
            return this[PARENT_CLASS] instanceof DynamicEntity;
        },
        enumerable: true,
        configurable: true
    });
    DynamicEntity.prototype.loadDynamicData = function (dynamicData) {
        this.initializeDynamicField(dynamicData);
        // super.loadFields(dynamicData);
    };
    /**
     * 初始化动态数据
     * @param dynamicData 动态数据
     */
    DynamicEntity.prototype.initializeDynamicField = function (dynamicData) {
        var _this = this;
        // 遍历动态数据的key，创建动态实体属性。
        Object.keys(dynamicData).forEach(function (propertyName) {
            var dataField = propertyName;
            if (delete _this[propertyName]) {
                if (dynamicData[propertyName] instanceof Object) {
                    var path_1 = _this.createPath(propertyName);
                    var dynamicEntity_1 = _this.createDynamicEntityFromJsonData(dynamicData[propertyName], path_1);
                    // this.constructor['__prop__metadata__'] = this.constructor['__prop__metadata__'] || {};
                    // NgObject({
                    //     /** 字段名称 */
                    //     dataField: propertyName,
                    //     /** 原始字段名称 */
                    //     originalDataField: propertyName,
                    //     /** 是否为外键 */
                    //     type: DynamicEntity
                    // })(this, propertyName);
                    Object.defineProperty(_this, propertyName, {
                        get: function () {
                            return dynamicEntity_1;
                        },
                        set: function (value) {
                            var modifyInfo = {
                                path: dynamicEntity_1[PARENT_PATH],
                                value: value.data,
                                preValue: this[propertyName].data,
                                type: ModifyType.ValueChange
                            };
                            dynamicEntity_1 = this.createDynamicEntityFromJsonData(value, path_1);
                            this.setChanges(modifyInfo);
                        }
                    });
                }
                else {
                    // this.constructor['__prop__metadata__'] = this.constructor['__prop__metadata__'] || {};
                    // NgField({
                    //     /** 字段名称 */
                    //     dataField: propertyName,
                    //     /** 原始字段名称 */
                    //     originalDataField: propertyName,
                    //     /** 是否为主键 */
                    //     primary: false,
                    //     /** 是否为外键 */
                    //     foreign: false
                    // })(this, propertyName);
                    Object.defineProperty(_this, propertyName, {
                        // 定义返回数据方法。
                        get: function () {
                            // 从初始数据返回字段值。
                            return this.data[dataField];
                        },
                        set: function (value) {
                            // 值相同时不触发变更。
                            var oldValue = this.data[dataField];
                            if (oldValue === value) {
                                return;
                            }
                            // 更新元数据数据。
                            this.data[dataField] = value;
                            // 变更集
                            var changes = {
                                type: ModifyType.ValueChange,
                                path: this.createPath(propertyName),
                                value: value,
                                preValue: oldValue
                            };
                            if (this[PARENT_PATH]) {
                                changes.path = this[PARENT_PATH].concat(changes.path);
                            }
                            this.setChanges(changes);
                        }
                    });
                }
            }
        });
    };
    DynamicEntity.prototype.createDynamicEntityFromJsonData = function (value, parentPath) {
        var _this = this;
        var instance;
        if (value instanceof DynamicEntity) {
            instance = value;
        }
        else {
            instance = new DynamicEntity(value);
            instance.constructor = DynamicEntity;
        }
        instance[PARENT_CLASS] = this;
        instance[PARENT_PATH] = parentPath;
        instance.onValueChanged.pipe(takeUntil(this.unsubscribe)).subscribe(function (changes) {
            if (changes) {
                changes.path = (_this[PARENT_PATH] || []).concat(changes.path);
                _this.setChanges(changes);
            }
        });
        return instance;
    };
    /**
     * 将变更记录保存至变更集中
     * @param value 变更记录
     * @todo
     * 1、preValue的处理有问题，下级传递上来的变更这样可以，根DyanmicaEntity上的，data已经发生变化，prevalue和value是一样了；
     * 2、当value是下级冒泡上来的，需要根据value去更新当前层级的data，该逻辑不应该放在setChagnes，待修改。
     */
    DynamicEntity.prototype.setChanges = function (value) {
        var _a;
        var propertyName = value.path[value.path.length - 1];
        var preValue = Object.assign({}, this.data);
        this.newData = Object.assign(this.newData, (_a = {}, _a[propertyName] = value.value, _a));
        var parentPath = value.path;
        if (value.path.length > 2) {
            parentPath = value.path.slice(0, value.path.length - 2);
        }
        // 统一不使用构造函数（保持和其他位置对Modification的构造一致）
        // const parentModification = new Modification(this.data, value.type, parentPath, preValue);
        var parentModification = {
            path: parentPath,
            value: this.data,
            preValue: preValue,
            type: value.type,
            dynamic: true
        };
        this.valueChanged.next(parentModification);
        this.changeSet.append(value);
    };
    /**
     * toJSON
     */
    DynamicEntity.prototype.toJSON = function () {
        return this.data;
    };
    return DynamicEntity;
}(Entity));
export { DynamicEntity };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pY19lbnRpdHkuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9lbnRpdHkvZHluYW1pY19lbnRpdHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQWdCLE1BQU0sb0JBQW9CLENBQUM7QUFDOUQsT0FBTyxFQUFFLFdBQVcsRUFBVyxZQUFZLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDN0QsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNsQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0M7O0dBRUc7QUFDSDtJQUFtQyx5Q0FBTTtJQVN2Qzs7T0FFRztJQUNILHVCQUFZLElBQVM7UUFBckIsWUFDRSxrQkFBTSxJQUFJLENBQUMsU0FFWjtRQURDLEtBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7O0lBQzdCLENBQUM7SUFWRCxzQkFBVyxtQ0FBUTtRQUhuQjs7V0FFRzthQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksYUFBYSxDQUFDO1FBQ3JELENBQUM7OztPQUFBO0lBVU0sdUNBQWUsR0FBdEIsVUFBdUIsV0FBZ0I7UUFDckMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3pDLGlDQUFpQztJQUNuQyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssOENBQXNCLEdBQTlCLFVBQStCLFdBQWdCO1FBQS9DLGlCQTJFQztRQTFFQyx1QkFBdUI7UUFDdkIsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQSxZQUFZO1lBQzNDLElBQU0sU0FBUyxHQUFHLFlBQVksQ0FBQztZQUMvQixJQUFJLE9BQU8sS0FBSSxDQUFDLFlBQVksQ0FBQyxFQUFFO2dCQUM3QixJQUFJLFdBQVcsQ0FBQyxZQUFZLENBQUMsWUFBWSxNQUFNLEVB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Q0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDekQ7UUFFRCx1Q0FBdUM7UUFDdkMsNEZBQTRGO1FBQzVGLElBQU0sa0JBQWtCLEdBQWlCO1lBQ3ZDLElBQUksRUFBRSxVQUFVO1lBQ2hCLEtBQUssRUFBRSxJQUFJLENBQUMsSUFBSTtZQUNoQixRQUFRLEVBQUUsUUFBUTtZQUNsQixJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUk7WUFDaEIsT0FBTyxFQUFFLElBQUk7U0FDZCxDQUFDO1FBRUYsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUMzQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQ7O09BRUc7SUFDSSw4QkFBTSxHQUFiO1FBQ0UsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ25CLENBQUM7SUFDSCxvQkFBQztBQUFELENBQUMsQUEvSkQsQ0FBbUMsTUFBTSxHQStKeEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNb2RpZnlUeXBlLCBNb2RpZmljYXRpb24gfSBmcm9tICcuLi9jaGFuZ2VzZXQvdHlwZXMnO1xyXG5pbXBvcnQgeyBQQVJFTlRfUEFUSCwgRHluYW1pYywgUEFSRU5UX0NMQVNTIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IEVudGl0eSB9IGZyb20gJy4vZW50aXR5JztcclxuaW1wb3J0IHsgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuLyoqXHJcbiAqIOaUr+aMgeWKqOaAgeWtl+autembhuWQiOeahOWKqOaAgeWunuS9k1xyXG4gKi9cclxuZXhwb3J0IGNsYXNzIER5bmFtaWNFbnRpdHkgZXh0ZW5kcyBFbnRpdHkgaW1wbGVtZW50cyBEeW5hbWljIHtcclxuXHJcbiAgLyoqXHJcbiAgICog5piv5ZCm5piv5bWM5aWX55qE5Yqo5oCB5a6e5L2TXHJcbiAgICovXHJcbiAgcHVibGljIGdldCBJc05lc3RlZCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzW1BBUkVOVF9DTEFTU10gaW5zdGFuY2VvZiBEeW5hbWljRW50aXR5O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIGRhdGEgSlNPTuaVsOaNrlxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKGRhdGE6IGFueSkge1xyXG4gICAgc3VwZXIoZGF0YSk7XHJcbiAgICB0aGlzLmxvYWREeW5hbWljRGF0YShkYXRhKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBsb2FkRHluYW1pY0RhdGEoZHluYW1pY0RhdGE6IGFueSkge1xyXG4gICAgdGhpcy5pbml0aWFsaXplRHluYW1pY0ZpZWxkKGR5bmFtaWNEYXRhKTtcclxuICAgIC8vIHN1cGVyLmxvYWRGaWVsZHMoZHluYW1pY0RhdGEpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yid5aeL5YyW5Yqo5oCB5pWw5o2uXHJcbiAgICogQHBhcmFtIGR5bmFtaWNEYXRhIOWKqOaAgeaVsOaNrlxyXG4gICAqL1xyXG4gIHByaXZhdGUgaW5pdGlhbGl6ZUR5bmFtaWNGaWVsZChkeW5hbWljRGF0YTogYW55KTogdm9pZCB7XHJcbiAgICAvLyDpgY3ljobliqjmgIHmlbDmja7nmoRrZXnvvIzliJvlu7rliqjmgIHlrp7kvZPlsZ7mgKfjgIJcclxuICAgIE9iamVjdC5rZXlzKGR5bmFtaWNEYXRhKS5mb3JFYWNoKHByb3BlcnR5TmFtZSA9PiB7XHJcbiAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IHByb3BlcnR5TmFtZTtcclxuICAgICAgaWYgKGRlbGV0ZSB0aGlzW3Byb3BlcnR5TmFtZV0pIHtcclxuICAgICAgICBpZiAoZHluYW1pY0RhdGFbcHJvcGVydHlOYW1lXSBpbnN0YW5jZW9mIE9iamVjdCkge1xyXG4gICAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuY3JlYXRlUGF0aChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgbGV0IGR5bmFtaWNFbnRpdHkgPSB0aGlzLmNyZWF0ZUR5bmFtaWNFbnRpdHlGcm9tSnNvbkRhdGEoZHluYW1pY0RhdGFbcHJvcGVydHlOYW1lXSwgcGF0aCk7XHJcbiAgICAgICAgICAvLyB0aGlzLmNvbnN0cnVjdG9yWydfX3Byb3BfX21ldGFkYXRhX18nXSA9IHRoaXMuY29uc3RydWN0b3JbJ19fcHJvcF9fbWV0YWRhdGFfXyddIHx8IHt9O1xyXG4gICAgICAgICAgLy8gTmdPYmplY3Qoe1xyXG4gICAgICAgICAgLy8gICAgIC8qKiDlrZfmrrXlkI3np7AgKi9cclxuICAgICAgICAgIC8vICAgICBkYXRhRmllbGQ6IHByb3BlcnR5TmFtZSxcclxuICAgICAgICAgIC8vICAgICAvKiog5Y6f5aeL5a2X5q615ZCN56ewICovXHJcbiAgICAgICAgICAvLyAgICAgb3JpZ2luYWxEYXRhRmllbGQ6IHByb3BlcnR5TmFtZSxcclxuICAgICAgICAgIC8vICAgICAvKiog5piv5ZCm5Li65aSW6ZSuICovXHJcbiAgICAgICAgICAvLyAgICAgdHlwZTogRHluYW1pY0VudGl0eVxyXG4gICAgICAgICAgLy8gfSkodGhpcywgcHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGR5bmFtaWNFbnRpdHk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgY29uc3QgbW9kaWZ5SW5mbyA9IHtcclxuICAgICAgICAgICAgICAgIHBhdGg6IGR5bmFtaWNFbnRpdHlbUEFSRU5UX1BBVEhdLFxyXG4gICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLmRhdGEsXHJcbiAgICAgICAgICAgICAgICBwcmVWYWx1ZTogdGhpc1twcm9wZXJ0eU5hbWVdLmRhdGEsXHJcbiAgICAgICAgICAgICAgICB0eXBlOiBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlXHJcbiAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICBkeW5hbWljRW50aXR5ID0gdGhpcy5jcmVhdGVEeW5hbWljRW50aXR5RnJvbUpzb25EYXRhKHZhbHVlLCBwYXRoKTtcclxuICAgICAgICAgICAgICB0aGlzLnNldENoYW5nZXMobW9kaWZ5SW5mbyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyB0aGlzLmNvbnN0cnVjdG9yWydfX3Byb3BfX21ldGFkYXRhX18nXSA9IHRoaXMuY29uc3RydWN0b3JbJ19fcHJvcF9fbWV0YWRhdGFfXyddIHx8IHt9O1xyXG4gICAgICAgICAgLy8gTmdGaWVsZCh7XHJcbiAgICAgICAgICAvLyAgICAgLyoqIOWtl+auteWQjeensCAqL1xyXG4gICAgICAgICAgLy8gICAgIGRhdGFGaWVsZDogcHJvcGVydHlOYW1lLFxyXG4gICAgICAgICAgLy8gICAgIC8qKiDljp/lp4vlrZfmrrXlkI3np7AgKi9cclxuICAgICAgICAgIC8vICAgICBvcmlnaW5hbERhdGFGaWVsZDogcHJvcGVydHlOYW1lLFxyXG4gICAgICAgICAgLy8gICAgIC8qKiDmmK/lkKbkuLrkuLvplK4gKi9cclxuICAgICAgICAgIC8vICAgICBwcmltYXJ5OiBmYWxzZSxcclxuICAgICAgICAgIC8vICAgICAvKiog5piv5ZCm5Li65aSW6ZSuICovXHJcbiAgICAgICAgICAvLyAgICAgZm9yZWlnbjogZmFsc2VcclxuICAgICAgICAgIC8vIH0pKHRoaXMsIHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgcHJvcGVydHlOYW1lLCB7XHJcbiAgICAgICAgICAgIC8vIOWumuS5iei/lOWbnuaVsOaNruaWueazleOAglxyXG4gICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAvLyDku47liJ3lp4vmlbDmja7ov5Tlm57lrZfmrrXlgLzjgIJcclxuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRhW2RhdGFGaWVsZF07XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgLy8g5YC855u45ZCM5pe25LiN6Kem5Y+R5Y+Y5pu044CCXHJcbiAgICAgICAgICAgICAgY29uc3Qgb2xkVmFsdWUgPSB0aGlzLmRhdGFbZGF0YUZpZWxkXTtcclxuICAgICAgICAgICAgICBpZiAob2xkVmFsdWUgPT09IHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIC8vIOabtOaWsOWFg+aVsOaNruaVsOaNruOAglxyXG4gICAgICAgICAgICAgIHRoaXMuZGF0YVtkYXRhRmllbGRdID0gdmFsdWU7XHJcbiAgICAgICAgICAgICAgLy8g5Y+Y5pu06ZuGXHJcbiAgICAgICAgICAgICAgY29uc3QgY2hhbmdlcyA9IHtcclxuICAgICAgICAgICAgICAgIHR5cGU6IE1vZGlmeVR5cGUuVmFsdWVDaGFuZ2UsXHJcbiAgICAgICAgICAgICAgICBwYXRoOiB0aGlzLmNyZWF0ZVBhdGgocHJvcGVydHlOYW1lKSxcclxuICAgICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSxcclxuICAgICAgICAgICAgICAgIHByZVZhbHVlOiBvbGRWYWx1ZVxyXG4gICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgIGlmICh0aGlzW1BBUkVOVF9QQVRIXSkge1xyXG4gICAgICAgICAgICAgICAgY2hhbmdlcy5wYXRoID0gdGhpc1tQQVJFTlRfUEFUSF0uY29uY2F0KGNoYW5nZXMucGF0aCk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlRHluYW1pY0VudGl0eUZyb21Kc29uRGF0YSh2YWx1ZTogYW55LCBwYXJlbnRQYXRoOiBzdHJpbmdbXSkge1xyXG4gICAgbGV0IGluc3RhbmNlOiBEeW5hbWljRW50aXR5O1xyXG4gICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRHluYW1pY0VudGl0eSkge1xyXG4gICAgICBpbnN0YW5jZSA9IHZhbHVlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaW5zdGFuY2UgPSBuZXcgRHluYW1pY0VudGl0eSh2YWx1ZSk7XHJcbiAgICAgIGluc3RhbmNlLmNvbnN0cnVjdG9yID0gRHluYW1pY0VudGl0eTtcclxuICAgIH1cclxuICAgIGluc3RhbmNlW1BBUkVOVF9DTEFTU10gPSB0aGlzO1xyXG4gICAgaW5zdGFuY2VbUEFSRU5UX1BBVEhdID0gcGFyZW50UGF0aDtcclxuICAgIGluc3RhbmNlLm9uVmFsdWVDaGFuZ2VkLnBpcGUodGFrZVVudGlsKHRoaXMudW5zdWJzY3JpYmUpKS5zdWJzY3JpYmUoY2hhbmdlcyA9PiB7XHJcbiAgICAgIGlmIChjaGFuZ2VzKSB7XHJcbiAgICAgICAgY2hhbmdlcy5wYXRoID0gKHRoaXNbUEFSRU5UX1BBVEhdIHx8IFtdKS5jb25jYXQoY2hhbmdlcy5wYXRoKTtcclxuICAgICAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlcyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBpbnN0YW5jZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWwhuWPmOabtOiusOW9leS/neWtmOiHs+WPmOabtOmbhuS4rVxyXG4gICAqIEBwYXJhbSB2YWx1ZSDlj5jmm7TorrDlvZVcclxuICAgKiBAdG9kb1xyXG4gICAqIDHjgIFwcmVWYWx1ZeeahOWkhOeQhuaciemXrumimO+8jOS4i+e6p+S8oOmAkuS4iuadpeeahOWPmOabtOi/meagt+WPr+S7pe+8jOaguUR5YW5taWNhRW50aXR55LiK55qE77yMZGF0YeW3sue7j+WPkeeUn+WPmOWMlu+8jHByZXZhbHVl5ZKMdmFsdWXmmK/kuIDmoLfkuobvvJtcclxuICAgKiAy44CB5b2TdmFsdWXmmK/kuIvnuqflhpLms6HkuIrmnaXnmoTvvIzpnIDopoHmoLnmja52YWx1ZeWOu+abtOaWsOW9k+WJjeWxgue6p+eahGRhdGHvvIzor6XpgLvovpHkuI3lupTor6XmlL7lnKhzZXRDaGFnbmVz77yM5b6F5L+u5pS544CCXHJcbiAgICovXHJcbiAgc2V0Q2hhbmdlcyh2YWx1ZTogTW9kaWZpY2F0aW9uKTogdm9pZCB7XHJcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSB2YWx1ZS5wYXRoW3ZhbHVlLnBhdGgubGVuZ3RoIC0gMV07XHJcbiAgICBjb25zdCBwcmVWYWx1ZSA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuZGF0YSk7XHJcbiAgICB0aGlzLm5ld0RhdGEgPSBPYmplY3QuYXNzaWduKHRoaXMubmV3RGF0YSwgeyBbcHJvcGVydHlOYW1lXTogdmFsdWUudmFsdWUgfSk7XHJcbiAgICBsZXQgcGFyZW50UGF0aCA9IHZhbHVlLnBhdGg7XHJcbiAgICBpZiAodmFsdWUucGF0aC5sZW5ndGggPiAyKSB7XHJcbiAgICAgIHBhcmVudFBhdGggPSB2YWx1ZS5wYXRoLnNsaWNlKDAsIHZhbHVlLnBhdGgubGVuZ3RoIC0gMik7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g57uf5LiA5LiN5L2/55So5p6E6YCg5Ye95pWw77yI5L+d5oyB5ZKM5YW25LuW5L2N572u5a+5TW9kaWZpY2F0aW9u55qE5p6E6YCg5LiA6Ie077yJXHJcbiAgICAvLyBjb25zdCBwYXJlbnRNb2RpZmljYXRpb24gPSBuZXcgTW9kaWZpY2F0aW9uKHRoaXMuZGF0YSwgdmFsdWUudHlwZSwgcGFyZW50UGF0aCwgcHJlVmFsdWUpO1xyXG4gICAgY29uc3QgcGFyZW50TW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24gPSB7XHJcbiAgICAgIHBhdGg6IHBhcmVudFBhdGgsXHJcbiAgICAgIHZhbHVlOiB0aGlzLmRhdGEsXHJcbiAgICAgIHByZVZhbHVlOiBwcmVWYWx1ZSxcclxuICAgICAgdHlwZTogdmFsdWUudHlwZSxcclxuICAgICAgZHluYW1pYzogdHJ1ZVxyXG4gICAgfTtcclxuXHJcbiAgICB0aGlzLnZhbHVlQ2hhbmdlZC5uZXh0KHBhcmVudE1vZGlmaWNhdGlvbik7XHJcbiAgICB0aGlzLmNoYW5nZVNldC5hcHBlbmQodmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogdG9KU09OXHJcbiAgICovXHJcbiAgcHVibGljIHRvSlNPTigpIHtcclxuICAgIHJldHVybiB0aGlzLmRhdGE7XHJcbiAgfVxyXG59XHJcbiJdfQ==