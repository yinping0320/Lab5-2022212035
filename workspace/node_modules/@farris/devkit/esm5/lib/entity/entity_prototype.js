import { from } from 'rxjs';
import { tap } from 'rxjs/operators';
import { ModifyType } from '../changeset';
import { EntityList } from './entity_list';
import { FieldMetadataUtil } from './metadata/field_metadata_util';
import { PARENT_CLASS, PARENT_PATH } from './types';
import { ValidationUtils } from './validator/validation_utils';
export var entityPrototype = {
    /**
     * 获取属性值
     */
    getFieldValue: function (schemaField) {
        var _a;
        var fieldName = schemaField.label;
        var value = this.data[fieldName];
        // 对多语录入字段，query不返回问题进行兼容
        if (schemaField.multiLanguage === true && !value) {
            var langCode = window.localStorage.getItem('languageCode') || 'zh-CHS';
            var originDataField = fieldName.replace('_MULTILANGUAGE', '');
            return _a = {},
                _a[langCode] = this.data[originDataField],
                _a;
        }
        return value;
    },
    /**
     * 设置属性值
     */
    setFieldValue: function (schemaField, propertyValue) {
        var fieldName = schemaField.label;
        this.data[fieldName] = propertyValue;
    },
    /**
     * 获取复杂类型对象的值
     * @param schemaField Schema字段描述
     * @returns 复杂类型对象的值
     */
    getComplexFieldValue: function (schemaField) {
        var fieldName = schemaField.label;
        var objectPropertyValue = this.innerEntities[fieldName];
        return objectPropertyValue;
    },
    /**
     * 向实体复杂类型字段赋值
     * @param schemaField Schema字段描述
     * @param ComplexField 复杂类型字段的类型定义
     * @param propertyValue 属性值
     */
    setComplexFieldValue: function (schemaField, ComplexField, propertyValue) {
        // 提取字段名
        var fieldName = schemaField.label;
        var complexFieldInstance = null;
        if (propertyValue instanceof ComplexField) {
            complexFieldInstance = propertyValue;
        }
        else {
            complexFieldInstance = new ComplexField(propertyValue);
            complexFieldInstance.constructor = ComplexField;
        }
        // 提取复杂类型对象的值
        var objectPropertyValue = this.innerEntities[fieldName];
        var propertyPath = (objectPropertyValue && objectPropertyValue[PARENT_PATH]) || complexFieldInstance[PARENT_PATH];
        // 构造变更信息
        var changeInfo = {
            // 提取变更对象相对于根实体的路径
            path: propertyPath,
            // 记录对象最新值
            value: propertyValue,
            // 记录对象历史值
            preValue: (this[fieldName] && this[fieldName].data) || null,
            // 标记这是一个值变化变更
            type: ModifyType.ValueChange
        };
        // 创建新的对象
        this.innerEntities[fieldName] = complexFieldInstance;
        // this.innerEntities[fieldName] = new ComplexField(propertyValue);
        // 记录本次数据变更
        if (!this.isInitializing) {
            this.setChanges(changeInfo);
        }
    },
    /**
     * 获取指定的子实体列表
     * @param schemaEntity 实体描述
     * @returns 子实体列表
     */
    getEntities: function (schemaEntity) {
        var dataField = schemaEntity.label;
        var listPropertyValue = this.innerEntities[dataField];
        return listPropertyValue;
    },
    /**
     * 更新指定子实体的值
     * @param schemaEntity 实体描述
     * @param propertyValue 实体列表
     */
    setEntities: function (schemaEntity, propertyValue) {
        var dataField = schemaEntity.label;
        this.innerEntities[dataField] = propertyValue;
    },
    /**
     * 检查属性值是否发生变化
     */
    isFieldValueChanged: function (schemaField, newPropValue, oldPropValue) {
        if (schemaField.multiLanguage === true) {
            if (this.isEmptyMultiLangPropValue(newPropValue) === true && this.isEmptyMultiLangPropValue(oldPropValue) === true) {
                return false;
            }
            return JSON.stringify(newPropValue) !== JSON.stringify(oldPropValue);
        }
        else {
            return newPropValue !== oldPropValue;
        }
    },
    /**
     * 多语录入字段的值是否为空
     */
    isEmptyMultiLangPropValue: function (value) {
        if (!value) {
            return true;
        }
        var keys = Object.keys(value);
        if (keys.length === 0) {
            return true;
        }
        // 值全部为空，视为空
        var vals = Object.values(value);
        var allEmptyVal = vals.every(function (val) {
            return !val;
        });
        if (allEmptyVal === true) {
            return true;
        }
        return false;
    },
    /**
     * 发送值变更
     */
    emitFieldValueChange: function (schemaField, newPropValue, oldPropValue) {
        if (!this.isInitializing) {
            var fieldName = schemaField.label;
            var changeInfo = {
                path: this.createPath(fieldName),
                value: newPropValue,
                preValue: oldPropValue,
                type: ModifyType.ValueChange
            };
            if (this[PARENT_PATH]) {
                changeInfo.path = this[PARENT_PATH].concat(changeInfo.path);
            }
            this.setChanges(changeInfo);
        }
    },
    /**
     * 将变更记录保存至变更集中
     * @param value 变更记录
     */
    setChanges: function (value) {
        var propertyName = value.path[value.path.length - 1];
        // @todo：事件会从下级向上冒泡，change可能是下级的，不能和当前Entity的newData合并。
        // this.newData = Object.assign(this.newData, { [propertyName]: value.value });
        this.valueChanged.next(value);
        if (!(this.validErrors && Object.keys(this.validErrors).includes(propertyName))) {
            this.changeSet.append(value);
        }
    },
    /**
     * 创建path
     * @param propertyName 属性名称
     */
    createPath: function (propertyName) {
        if (this.primaryKey) {
            return [this.primaryKey + ':' + this.primaryValue, propertyName];
        }
        else {
            return [':', propertyName];
        }
    },
    getPaths: function () {
        var pathObj = {
            path: [],
            isUdt: false,
            isGrid: false
        };
        var handleParent = function (item) {
            var parentPaths = item[PARENT_PATH];
            if (parentPaths) {
                var prop = parentPaths[parentPaths.length - 1];
                // 父级所在实体包含的ngObject，存在当前实体字段，则判断为UDt字段
                if (Object.keys(FieldMetadataUtil.getNgObjects(item[PARENT_CLASS].constructor)).indexOf(prop) > -1) {
                    pathObj.isUdt = true;
                }
                // 存在类型为ngList，则判断为grid
                if (item instanceof EntityList === true) {
                    pathObj.isGrid = true;
                }
                else {
                    pathObj.path.push(prop);
                }
            }
            if (item[PARENT_CLASS]) {
                handleParent(item[PARENT_CLASS]);
            }
        };
        handleParent(this);
        pathObj.path = pathObj.path.reverse();
        return pathObj;
    },
    validate: function (propertyName, value, externalRules, index) {
        var _this = this;
        return from(this.validator.validate(this, propertyName, value, externalRules, index)).pipe(tap(function (result) {
            if (!result.isValid) {
                _this.validErrors = ValidationUtils.convertErrorsToNormalObject(result.errors, {});
            }
            else {
                _this.validErrors = {};
            }
        }));
    },
    validateAll: function (validateContext) {
    },
    /**
     * 用于在entity_util中调用，如果有错误，会将验证结果传入回调cb
     */
    validateFromUtil: function (propertyName, value, cb) {
        var _this = this;
        this.validErrors = {};
        from(this.validator.validate(this, propertyName, value)).subscribe(function (result) {
            if (!result.isValid) {
                _this.validErrors = ValidationUtils.convertErrorsToNormalObject(result.errors, {});
            }
            // 不应重新赋值，这里仅是实体校验通过
            /*else {
              // 如果BindingObject上的属性值和Entity上对应属性值一样，则不再设置
              if (this[propertyName] === value) {
                return;
              }
              this[propertyName] = value;
            }*/
            cb(result);
        });
    },
    /**
     * 将实体数据转换为JSON格式
     */
    toJSON: function (buildChanges) {
        var _this = this;
        // 声明转换初始值
        var result = {};
        // 提取简单类型字段的值
        var ngFields = FieldMetadataUtil.getNgFields(this.constructor);
        Object.keys(ngFields).forEach(function (propName) {
            var ngField = ngFields[propName];
            var dataField = ngField.dataField || propName;
            if (buildChanges === true && ngField.enableTimeZone === true) {
                result[dataField] = _this.data[propName];
            }
            else {
                result[dataField] = _this[propName];
            }
        });
        // 提取对象类型字段的值
        var ngObjects = FieldMetadataUtil.getNgObjects(this.constructor);
        Object.keys(ngObjects).forEach(function (propName) {
            var ngObject = ngObjects[propName];
            var dataField = ngObject.dataField || propName;
            result[dataField] = _this[propName] ? _this[propName].toJSON(buildChanges) : {};
        });
        // 提取动态属性字段的值
        var ngDynamics = FieldMetadataUtil.getNgDynamic(this.constructor);
        Object.keys(ngDynamics).forEach(function (propName) {
            var ngDynamic = ngDynamics[propName];
            var dataField = ngDynamic.dataField || propName;
            result[dataField] = _this[propName] ? _this[propName].toJSON(buildChanges) : {};
        });
        // 提取列表字段的属性
        var ngLists = FieldMetadataUtil.getNgList(this.constructor);
        Object.keys(ngLists).forEach(function (propName) {
            var ngList = ngLists[propName];
            var dataField = ngList.dataField || propName;
            result[dataField] = _this[propName] ? _this[propName].toJSON(buildChanges) : {};
        });
        return result;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X3Byb3RvdHlwZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2VudGl0eS9lbnRpdHlfcHJvdG90eXBlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxJQUFJLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDeEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JDLE9BQU8sRUFBZ0IsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBS3hELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDbkUsT0FBTyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFcEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBRS9ELE1BQU0sQ0FBQyxJQUFNLGVBQWUsR0FBRztJQUM3Qjs7T0FFRztJQUNILGFBQWEsRUFBRSxVQUFTLFdBQThCOztRQUNwRCxJQUFNLFNBQVMsR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDO1FBQ3BDLElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbkMseUJBQXlCO1FBQ3pCLElBQUksV0FBVyxDQUFDLGFBQWEsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDaEQsSUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLElBQUksUUFBUSxDQUFDO1lBQ3pFLElBQU0sZUFBZSxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDaEU7Z0JBQ0UsR0FBQyxRQUFRLElBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUM7bUJBQ3RDO1NBQ0g7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UyxHQUFHLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN2QyxJQUFNLFNBQVMsR0FBRyxTQUFTLENBQUMsU0FBUyxJQUFJLFFBQVEsQ0FBQztZQUNsRCxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsS0FBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDaEYsQ0FBQyxDQUFDLENBQUM7UUFDSCxZQUFZO1FBQ1osSUFBTSxPQUFPLEdBQUcsaUJBQWlCLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUM5RCxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFDLFFBQWdCO1lBQzVDLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNqQyxJQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxJQUFJLFFBQVEsQ0FBQztZQUMvQyxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsS0FBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDaEYsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0NBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZyb20sIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBNb2RpZmljYXRpb24sIE1vZGlmeVR5cGUgfSBmcm9tICcuLi9jaGFuZ2VzZXQnO1xyXG5pbXBvcnQgeyBVc2VyU2V0dGluZ3NTZXJ2aWNlIH0gZnJvbSAnLi4vaTE4bi91c2VyX3NldHRpbmdzX3NlcnZpY2UnO1xyXG5pbXBvcnQgeyBab25lZFRpbWUgfSBmcm9tICcuLi9pMThuL3pvbmVkX3RpbWUnO1xyXG5pbXBvcnQgeyBTY2hlbWFFbnRpdHksIFNjaGVtYUVudGl0eUZpZWxkIH0gZnJvbSAnLi4vc2NoZW1hL3NjaGVtYSc7XHJcbmltcG9ydCB7IEVudGl0eSB9IGZyb20gJy4vZW50aXR5JztcclxuaW1wb3J0IHsgRW50aXR5TGlzdCB9IGZyb20gJy4vZW50aXR5X2xpc3QnO1xyXG5pbXBvcnQgeyBGaWVsZE1ldGFkYXRhVXRpbCB9IGZyb20gJy4vbWV0YWRhdGEvZmllbGRfbWV0YWRhdGFfdXRpbCc7XHJcbmltcG9ydCB7IFBBUkVOVF9DTEFTUywgUEFSRU5UX1BBVEggfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgVmFsaWRhdGVSdWxlLCBWYWxpZGF0aW9uUmVzdWx0IH0gZnJvbSAnLi92YWxpZGF0b3IvdHlwZXMnO1xyXG5pbXBvcnQgeyBWYWxpZGF0aW9uVXRpbHMgfSBmcm9tICcuL3ZhbGlkYXRvci92YWxpZGF0aW9uX3V0aWxzJztcclxuXHJcbmV4cG9ydCBjb25zdCBlbnRpdHlQcm90b3R5cGUgPSB7XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5bGe5oCn5YC8XHJcbiAgICovXHJcbiAgZ2V0RmllbGRWYWx1ZTogZnVuY3Rpb24oc2NoZW1hRmllbGQ6IFNjaGVtYUVudGl0eUZpZWxkKSB7XHJcbiAgICBjb25zdCBmaWVsZE5hbWUgPSBzY2hlbWFGaWVsZC5sYWJlbDtcclxuICAgIGNvbnN0IHZhbHVlID0gdGhpcy5kYXRhW2ZpZWxkTmFtZV07XHJcbiAgICAvLyDlr7nlpJror63lvZXlhaXlrZfmrrXvvIxxdWVyeeS4jei/lOWbnumXrumimOi/m+ihjOWFvOWuuVxyXG4gICAgaWYgKHNjaGVtYUZpZWxkLm11bHRpTGFuZ3VhZ2UgPT09IHRydWUgJiYgIXZhbHVlKSB7XHJcbiAgICAgIGNvbnN0IGxhbmdDb2RlID0gd2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKCdsYW5ndWFnZUNvZGUnKSB8fCAnemgtQ0hTJztcclxuICAgICAgY29uc3Qgb3JpZ2luRGF0YUZpZWxkID0gZmllbGROYW1lLnJlcGxhY2UoJ19NVUxUSUxBTkdVQUdFJywgJycpO1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIFtsYW5nQ29kZV06IHRoaXMuZGF0YVtvcmlnaW5EYXRhRmllbGRdXHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdmFsdWU7XHJcbiAgfSxcclxuICAvKipcclxuICAgKiDorr7nva7lsZ7mgKflgLxcclxuICAgKi9cclxuICBzZXRGaWVsZFZhbHVlOiBmdW5jdGlvbihzY2hlbWFGaWVsZDogU2NoZW1hRW50aXR5RmllbGQsIHByb3BlcnR5VmFsdWU6IGFueSkge1xyXG4gICAgY29uc3QgZmllbGROYW1lID0gc2NoZW1hRmllbGQubGFiZWw7XHJcbiAgICB0aGlzLmRhdGFbZmllbGROYW1lXSA9IHByb3BlcnR5VmFsdWU7XHJcbiAgfSxcclxuICAvKipcclxuICAgKiDojrflj5blpI3mnYLnsbvlnovlr7nosaHnmoTlgLxcclxuICAgKiBAcGFyYW0gc2NoZW1hRmllbGQgU2NoZW1h5a2X5q615o+P6L+wXHJcbiAgICogQHJldHVybnMg5aSN5p2C57G75Z6L5a+56LGh55qE5YC8XHJcbiAgICovXHJcbiAgZ2V0Q29tcGxleEZpZWxkVmFsdWU6IGZ1bmN0aW9uKHNjaGVtYUZpZWxkOiBTY2hlbWFFbnRpdHlGaWVsZCkge1xyXG4gICAgY29uc3QgZmllbGROYW1lID0gc2NoZW1hRmllbGQubGFiZWw7XHJcbiAgICBjb25zdCBvYmplY3RQcm9wZXJ0eVZhbHVlID0gdGhpcy5pbm5lckVudGl0aWVzW2ZpZWxkTmFtZV07XHJcbiAgICByZXR1cm4gb2JqZWN0UHJvcGVydHlWYWx1ZTtcclxuICB9LFxyXG4gIC8qKlxyXG4gICAqIOWQkeWunuS9k+Wkjeadguexu+Wei+Wtl+autei1i+WAvFxyXG4gICAqIEBwYXJhbSBzY2hlbWFGaWVsZCBTY2hlbWHlrZfmrrXmj4/ov7BcclxuICAgKiBAcGFyYW0gQ29tcGxleEZpZWxkIOWkjeadguexu+Wei+Wtl+auteeahOexu+Wei+WumuS5iVxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eVZhbHVlIOWxnuaAp+WAvFxyXG4gICAqL1xyXG4gIHNldENvbXBsZXhGaWVsZFZhbHVlOiBmdW5jdGlvbihzY2hlbWFGaWVsZDogU2NoZW1hRW50aXR5RmllbGQsIENvbXBsZXhGaWVsZDogYW55LCBwcm9wZXJ0eVZhbHVlOiBhbnkpIHtcclxuICAgIC8vIOaPkOWPluWtl+auteWQjVxyXG4gICAgY29uc3QgZmllbGROYW1lID0gc2NoZW1hRmllbGQubGFiZWw7XHJcbiAgICBsZXQgY29tcGxleEZpZWxkSW5zdGFuY2UgPSBudWxsO1xyXG4gICAgaWYgKHByb3BlcnR5VmFsdWUgaW5zdGFuY2VvZiBDb21wbGV4RmllbGQpIHtcclxuICAgICAgY29tcGxleEZpZWxkSW5zdGFuY2UgPSBwcm9wZXJ0eVZhbHVlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29tcGxleEZpZWxkSW5zdGFuY2UgPSBuZXcgQ29tcGxleEZpZWxkKHByb3BlcnR5VmFsdWUpO1xyXG4gICAgICBjb21wbGV4RmllbGRJbnN0YW5jZS5jb25zdHJ1Y3RvciA9IENvbXBsZXhGaWVsZDtcclxuICAgIH1cclxuICAgIC8vIOaPkOWPluWkjeadguexu+Wei+WvueixoeeahOWAvFxyXG4gICAgY29uc3Qgb2JqZWN0UHJvcGVydHlWYWx1ZSA9IHRoaXMuaW5uZXJFbnRpdGllc1tmaWVsZE5hbWVdO1xyXG4gICAgY29uc3QgcHJvcGVydHlQYXRoID0gKG9iamVjdFByb3BlcnR5VmFsdWUgJiYgb2JqZWN0UHJvcGVydHlWYWx1ZVtQQVJFTlRfUEFUSF0pIHx8IGNvbXBsZXhGaWVsZEluc3RhbmNlW1BBUkVOVF9QQVRIXTtcclxuICAgIC8vIOaehOmAoOWPmOabtOS/oeaBr1xyXG4gICAgY29uc3QgY2hhbmdlSW5mbyA9IHtcclxuICAgICAgLy8g5o+Q5Y+W5Y+Y5pu05a+56LGh55u45a+55LqO5qC55a6e5L2T55qE6Lev5b6EXHJcbiAgICAgIHBhdGg6IHByb3BlcnR5UGF0aCxcclxuICAgICAgLy8g6K6w5b2V5a+56LGh5pyA5paw5YC8XHJcbiAgICAgIHZhbHVlOiBwcm9wZXJ0eVZhbHVlLFxyXG4gICAgICAvLyDorrDlvZXlr7nosaHljoblj7LlgLxcclxuICAgICAgcHJlVmFsdWU6ICh0aGlzW2ZpZWxkTmFtZV0gJiYgdGhpc1tmaWVsZE5hbWVdLmRhdGEpIHx8IG51bGwsXHJcbiAgICAgIC8vIOagh+iusOi/meaYr+S4gOS4quWAvOWPmOWMluWPmOabtFxyXG4gICAgICB0eXBlOiBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlXHJcbiAgICB9O1xyXG4gICAgLy8g5Yib5bu65paw55qE5a+56LGhXHJcbiAgICB0aGlzLmlubmVyRW50aXRpZXNbZmllbGROYW1lXSA9IGNvbXBsZXhGaWVsZEluc3RhbmNlO1xyXG4gICAgLy8gdGhpcy5pbm5lckVudGl0aWVzW2ZpZWxkTmFtZV0gPSBuZXcgQ29tcGxleEZpZWxkKHByb3BlcnR5VmFsdWUpO1xyXG4gICAgLy8g6K6w5b2V5pys5qyh5pWw5o2u5Y+Y5pu0XHJcbiAgICBpZiAoIXRoaXMuaXNJbml0aWFsaXppbmcpIHtcclxuICAgICAgdGhpcy5zZXRDaGFuZ2VzKGNoYW5nZUluZm8pO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5oyH5a6a55qE5a2Q5a6e5L2T5YiX6KGoXHJcbiAgICogQHBhcmFtIHNjaGVtYUVudGl0eSDlrp7kvZPmj4/ov7BcclxuICAgKiBAcmV0dXJucyDlrZDlrp7kvZPliJfooahcclxuICAgKi9cclxuICBnZXRFbnRpdGllczogZnVuY3Rpb24oc2NoZW1hRW50aXR5OiBTY2hlbWFFbnRpdHkpIHtcclxuICAgIGNvbnN0IGRhdGFGaWVsZCA9IHNjaGVtYUVudGl0eS5sYWJlbDtcclxuICAgIGNvbnN0IGxpc3RQcm9wZXJ0eVZhbHVlID0gdGhpcy5pbm5lckVudGl0aWVzW2RhdGFGaWVsZF07XHJcbiAgICByZXR1cm4gbGlzdFByb3BlcnR5VmFsdWU7XHJcbiAgfSxcclxuICAvKipcclxuICAgKiDmm7TmlrDmjIflrprlrZDlrp7kvZPnmoTlgLxcclxuICAgKiBAcGFyYW0gc2NoZW1hRW50aXR5IOWunuS9k+aPj+i/sFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eVZhbHVlIOWunuS9k+WIl+ihqFxyXG4gICAqL1xyXG4gIHNldEVudGl0aWVzOiBmdW5jdGlvbihzY2hlbWFFbnRpdHk6IFNjaGVtYUVudGl0eSwgcHJvcGVydHlWYWx1ZTogYW55KSB7XHJcbiAgICBjb25zdCBkYXRhRmllbGQgPSBzY2hlbWFFbnRpdHkubGFiZWw7XHJcbiAgICB0aGlzLmlubmVyRW50aXRpZXNbZGF0YUZpZWxkXSA9IHByb3BlcnR5VmFsdWU7XHJcbiAgfSxcclxuICAvKipcclxuICAgKiDmo4Dmn6XlsZ7mgKflgLzmmK/lkKblj5HnlJ/lj5jljJZcclxuICAgKi9cclxuICBpc0ZpZWxkVmFsdWVDaGFuZ2VkOiBmdW5jdGlvbihzY2hlbWFGaWVsZDogU2NoZW1hRW50aXR5RmllbGQsIG5ld1Byb3BWYWx1ZTogYW55LCBvbGRQcm9wVmFsdWU6IGFueSkge1xyXG4gICAgaWYgKHNjaGVtYUZpZWxkLm11bHRpTGFuZ3VhZ2UgPT09IHRydWUpIHtcclxuICAgICAgaWYgKHRoaXMuaXNFbXB0eU11bHRpTGFuZ1Byb3BWYWx1ZShuZXdQcm9wVmFsdWUpID09PSB0cnVlICYmIHRoaXMuaXNFbXB0eU11bHRpTGFuZ1Byb3BWYWx1ZShvbGRQcm9wVmFsdWUpID09PSB0cnVlKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShuZXdQcm9wVmFsdWUpICE9PSBKU09OLnN0cmluZ2lmeShvbGRQcm9wVmFsdWUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIG5ld1Byb3BWYWx1ZSAhPT0gb2xkUHJvcFZhbHVlO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgLyoqXHJcbiAgICog5aSa6K+t5b2V5YWl5a2X5q6155qE5YC85piv5ZCm5Li656m6XHJcbiAgICovXHJcbiAgaXNFbXB0eU11bHRpTGFuZ1Byb3BWYWx1ZSh2YWx1ZTogYW55KSB7XHJcbiAgICBpZiAoIXZhbHVlKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7XHJcbiAgICBpZiAoa2V5cy5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5YC85YWo6YOo5Li656m677yM6KeG5Li656m6XHJcbiAgICBjb25zdCB2YWxzID0gT2JqZWN0LnZhbHVlcyh2YWx1ZSk7XHJcbiAgICBjb25zdCBhbGxFbXB0eVZhbCA9IHZhbHMuZXZlcnkoKHZhbCkgPT4ge1xyXG4gICAgICByZXR1cm4gIXZhbDtcclxuICAgIH0pO1xyXG4gICAgaWYgKGFsbEVtcHR5VmFsID09PSB0cnVlKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9LFxyXG4gIC8qKlxyXG4gICAqIOWPkemAgeWAvOWPmOabtFxyXG4gICAqL1xyXG4gIGVtaXRGaWVsZFZhbHVlQ2hhbmdlOiBmdW5jdGlvbihzY2hlbWFGaWVsZDogU2NoZW1hRW50aXR5RmllbGQsIG5ld1Byb3BWYWx1ZTogYW55LCBvbGRQcm9wVmFsdWU6IGFueSk6IHZvaWQge1xyXG4gICAgaWYgKCF0aGlzLmlzSW5pdGlhbGl6aW5nKSB7XHJcbiAgICAgIGNvbnN0IGZpZWxkTmFtZSA9IHNjaGVtYUZpZWxkLmxhYmVsO1xyXG4gICAgICBjb25zdCBjaGFuZ2VJbmZvID0ge1xyXG4gICAgICAgIHBhdGg6IHRoaXMuY3JlYXRlUGF0aChmaWVsZE5hbWUpLFxyXG4gICAgICAgIHZhbHVlOiBuZXdQcm9wVmFsdWUsXHJcbiAgICAgICAgcHJlVmFsdWU6IG9sZFByb3BWYWx1ZSxcclxuICAgICAgICB0eXBlOiBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBpZiAodGhpc1tQQVJFTlRfUEFUSF0pIHtcclxuICAgICAgICBjaGFuZ2VJbmZvLnBhdGggPSB0aGlzW1BBUkVOVF9QQVRIXS5jb25jYXQoY2hhbmdlSW5mby5wYXRoKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlSW5mbyk7XHJcbiAgICB9XHJcbiAgfSxcclxuICAvKipcclxuICAgKiDlsIblj5jmm7TorrDlvZXkv53lrZjoh7Plj5jmm7Tpm4bkuK1cclxuICAgKiBAcGFyYW0gdmFsdWUg5Y+Y5pu06K6w5b2VXHJcbiAgICovXHJcbiAgc2V0Q2hhbmdlczogZnVuY3Rpb24odmFsdWU6IE1vZGlmaWNhdGlvbik6IHZvaWQge1xyXG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gdmFsdWUucGF0aFt2YWx1ZS5wYXRoLmxlbmd0aCAtIDFdO1xyXG5cclxuICAgIC8vIEB0b2Rv77ya5LqL5Lu25Lya5LuO5LiL57qn5ZCR5LiK5YaS5rOh77yMY2hhbmdl5Y+v6IO95piv5LiL57qn55qE77yM5LiN6IO95ZKM5b2T5YmNRW50aXR555qEbmV3RGF0YeWQiOW5tuOAglxyXG4gICAgLy8gdGhpcy5uZXdEYXRhID0gT2JqZWN0LmFzc2lnbih0aGlzLm5ld0RhdGEsIHsgW3Byb3BlcnR5TmFtZV06IHZhbHVlLnZhbHVlIH0pO1xyXG5cclxuICAgIHRoaXMudmFsdWVDaGFuZ2VkLm5leHQodmFsdWUpO1xyXG4gICAgaWYgKCEodGhpcy52YWxpZEVycm9ycyAmJiBPYmplY3Qua2V5cyh0aGlzLnZhbGlkRXJyb3JzKS5pbmNsdWRlcyhwcm9wZXJ0eU5hbWUpKSkge1xyXG4gICAgICB0aGlzLmNoYW5nZVNldC5hcHBlbmQodmFsdWUpO1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgLyoqXHJcbiAgICog5Yib5bu6cGF0aFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eU5hbWUg5bGe5oCn5ZCN56ewXHJcbiAgICovXHJcbiAgY3JlYXRlUGF0aDogZnVuY3Rpb24ocHJvcGVydHlOYW1lOiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgICBpZiAodGhpcy5wcmltYXJ5S2V5KSB7XHJcbiAgICAgIHJldHVybiBbdGhpcy5wcmltYXJ5S2V5ICsgJzonICsgdGhpcy5wcmltYXJ5VmFsdWUsIHByb3BlcnR5TmFtZV07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gWyc6JywgcHJvcGVydHlOYW1lXTtcclxuICAgIH1cclxuICB9LFxyXG4gIGdldFBhdGhzKCkge1xyXG4gICAgY29uc3QgcGF0aE9iaiA9IHtcclxuICAgICAgcGF0aDogW10sXHJcbiAgICAgIGlzVWR0OiBmYWxzZSxcclxuICAgICAgaXNHcmlkOiBmYWxzZVxyXG4gICAgfTtcclxuICAgIGNvbnN0IGhhbmRsZVBhcmVudCA9IGl0ZW0gPT4ge1xyXG4gICAgICBjb25zdCBwYXJlbnRQYXRocyA9IGl0ZW1bUEFSRU5UX1BBVEhdO1xyXG4gICAgICBpZiAocGFyZW50UGF0aHMpIHtcclxuICAgICAgICBjb25zdCBwcm9wID0gcGFyZW50UGF0aHNbcGFyZW50UGF0aHMubGVuZ3RoIC0gMV07XHJcbiAgICAgICAgLy8g54i257qn5omA5Zyo5a6e5L2T5YyF5ZCr55qEbmdPYmplY3TvvIzlrZjlnKjlvZPliY3lrp7kvZPlrZfmrrXvvIzliJnliKTmlq3kuLpVRHTlrZfmrrVcclxuICAgICAgICBpZiAoT2JqZWN0LmtleXMoRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdPYmplY3RzKGl0ZW1bUEFSRU5UX0NMQVNTXS5jb25zdHJ1Y3RvcikpLmluZGV4T2YocHJvcCkgPiAtMSkge1xyXG4gICAgICAgICAgcGF0aE9iai5pc1VkdCA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOWtmOWcqOexu+Wei+S4um5nTGlzdO+8jOWImeWIpOaWreS4umdyaWRcclxuICAgICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIEVudGl0eUxpc3QgPT09IHRydWUpIHtcclxuICAgICAgICAgIHBhdGhPYmouaXNHcmlkID0gdHJ1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcGF0aE9iai5wYXRoLnB1c2gocHJvcCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgfVxyXG4gICAgICBpZiAoaXRlbVtQQVJFTlRfQ0xBU1NdKSB7XHJcbiAgICAgICAgaGFuZGxlUGFyZW50KGl0ZW1bUEFSRU5UX0NMQVNTXSk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICBoYW5kbGVQYXJlbnQodGhpcyk7XHJcbiAgICBwYXRoT2JqLnBhdGggPSBwYXRoT2JqLnBhdGgucmV2ZXJzZSgpO1xyXG4gICAgcmV0dXJuIHBhdGhPYmo7XHJcbiAgfSxcclxuICB2YWxpZGF0ZShwcm9wZXJ0eU5hbWU/OiBzdHJpbmcsIHZhbHVlPywgZXh0ZXJuYWxSdWxlcz86IE1hcDxzdHJpbmcsIFZhbGlkYXRlUnVsZVtdPiwgaW5kZXg/OiBudW1iZXIpOiBPYnNlcnZhYmxlPFZhbGlkYXRpb25SZXN1bHQ+IHtcclxuICAgIHJldHVybiBmcm9tKHRoaXMudmFsaWRhdG9yLnZhbGlkYXRlKHRoaXMsIHByb3BlcnR5TmFtZSwgdmFsdWUsIGV4dGVybmFsUnVsZXMsIGluZGV4KSkucGlwZShcclxuICAgICAgdGFwKChyZXN1bHQ6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmICghcmVzdWx0LmlzVmFsaWQpIHtcclxuICAgICAgICAgIHRoaXMudmFsaWRFcnJvcnMgPSBWYWxpZGF0aW9uVXRpbHMuY29udmVydEVycm9yc1RvTm9ybWFsT2JqZWN0KHJlc3VsdC5lcnJvcnMsIHt9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy52YWxpZEVycm9ycyA9IHt9O1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfSxcclxuICB2YWxpZGF0ZUFsbCh2YWxpZGF0ZUNvbnRleHQ/OiBNYXA8c3RyaW5nLCBWYWxpZGF0ZVJ1bGVbXT4pIHtcclxuXHJcbiAgfSxcclxuICAvKipcclxuICAgKiDnlKjkuo7lnKhlbnRpdHlfdXRpbOS4reiwg+eUqO+8jOWmguaenOaciemUmeivr++8jOS8muWwhumqjOivgee7k+aenOS8oOWFpeWbnuiwg2NiXHJcbiAgICovXHJcbiAgdmFsaWRhdGVGcm9tVXRpbChwcm9wZXJ0eU5hbWU6IHN0cmluZywgdmFsdWU6IGFueSwgY2I6IGFueSkge1xyXG4gICAgdGhpcy52YWxpZEVycm9ycyA9IHt9O1xyXG4gICAgZnJvbSh0aGlzLnZhbGlkYXRvci52YWxpZGF0ZSh0aGlzLCBwcm9wZXJ0eU5hbWUsIHZhbHVlKSkuc3Vic2NyaWJlKChyZXN1bHQ6IGFueSkgPT4ge1xyXG4gICAgICBpZiAoIXJlc3VsdC5pc1ZhbGlkKSB7XHJcbiAgICAgICAgdGhpcy52YWxpZEVycm9ycyA9IFZhbGlkYXRpb25VdGlscy5jb252ZXJ0RXJyb3JzVG9Ob3JtYWxPYmplY3QocmVzdWx0LmVycm9ycywge30pO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIOS4jeW6lOmHjeaWsOi1i+WAvO+8jOi/memHjOS7heaYr+WunuS9k+agoemqjOmAmui/h1xyXG4gICAgICAvKmVsc2Uge1xyXG4gICAgICAgIC8vIOWmguaenEJpbmRpbmdPYmplY3TkuIrnmoTlsZ7mgKflgLzlkoxFbnRpdHnkuIrlr7nlupTlsZ7mgKflgLzkuIDmoLfvvIzliJnkuI3lho3orr7nva5cclxuICAgICAgICBpZiAodGhpc1twcm9wZXJ0eU5hbWVdID09PSB2YWx1ZSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzW3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTtcclxuICAgICAgfSovXHJcbiAgICAgIGNiKHJlc3VsdCk7XHJcbiAgICB9KTtcclxuICB9LFxyXG4gIC8qKlxyXG4gICAqIOWwhuWunuS9k+aVsOaNrui9rOaNouS4ukpTT07moLzlvI9cclxuICAgKi9cclxuICB0b0pTT04oYnVpbGRDaGFuZ2VzPzogYm9vbGVhbikge1xyXG4gICAgLy8g5aOw5piO6L2s5o2i5Yid5aeL5YC8XHJcbiAgICBjb25zdCByZXN1bHQgPSB7fTtcclxuICAgIC8vIOaPkOWPlueugOWNleexu+Wei+Wtl+auteeahOWAvFxyXG4gICAgY29uc3QgbmdGaWVsZHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0ZpZWxkcyh0aGlzLmNvbnN0cnVjdG9yKTtcclxuICAgIE9iamVjdC5rZXlzKG5nRmllbGRzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5nRmllbGQgPSBuZ0ZpZWxkc1twcm9wTmFtZV07XHJcbiAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IG5nRmllbGQuZGF0YUZpZWxkIHx8IHByb3BOYW1lO1xyXG4gICAgICBpZiAoYnVpbGRDaGFuZ2VzID09PSB0cnVlICYmIG5nRmllbGQuZW5hYmxlVGltZVpvbmUgPT09IHRydWUpIHtcclxuICAgICAgICByZXN1bHRbZGF0YUZpZWxkXSA9IHRoaXMuZGF0YVtwcm9wTmFtZV07XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVzdWx0W2RhdGFGaWVsZF0gPSB0aGlzW3Byb3BOYW1lXTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICAvLyDmj5Dlj5blr7nosaHnsbvlnovlrZfmrrXnmoTlgLxcclxuICAgIGNvbnN0IG5nT2JqZWN0cyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nT2JqZWN0cyh0aGlzLmNvbnN0cnVjdG9yKTtcclxuICAgIE9iamVjdC5rZXlzKG5nT2JqZWN0cykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBuZ09iamVjdCA9IG5nT2JqZWN0c1twcm9wTmFtZV07XHJcbiAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IG5nT2JqZWN0LmRhdGFGaWVsZCB8fCBwcm9wTmFtZTtcclxuICAgICAgcmVzdWx0W2RhdGFGaWVsZF0gPSB0aGlzW3Byb3BOYW1lXSA/IHRoaXNbcHJvcE5hbWVdLnRvSlNPTihidWlsZENoYW5nZXMpIDoge307XHJcbiAgICB9KTtcclxuICAgIC8vIOaPkOWPluWKqOaAgeWxnuaAp+Wtl+auteeahOWAvFxyXG4gICAgY29uc3QgbmdEeW5hbWljcyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nRHluYW1pYyh0aGlzLmNvbnN0cnVjdG9yKTtcclxuICAgIE9iamVjdC5rZXlzKG5nRHluYW1pY3MpLmZvckVhY2goKHByb3BOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgY29uc3QgbmdEeW5hbWljID0gbmdEeW5hbWljc1twcm9wTmFtZV07XHJcbiAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IG5nRHluYW1pYy5kYXRhRmllbGQgfHwgcHJvcE5hbWU7XHJcbiAgICAgIHJlc3VsdFtkYXRhRmllbGRdID0gdGhpc1twcm9wTmFtZV0gPyB0aGlzW3Byb3BOYW1lXS50b0pTT04oYnVpbGRDaGFuZ2VzKSA6IHt9O1xyXG4gICAgfSk7XHJcbiAgICAvLyDmj5Dlj5bliJfooajlrZfmrrXnmoTlsZ7mgKdcclxuICAgIGNvbnN0IG5nTGlzdHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0xpc3QodGhpcy5jb25zdHJ1Y3Rvcik7XHJcbiAgICBPYmplY3Qua2V5cyhuZ0xpc3RzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5nTGlzdCA9IG5nTGlzdHNbcHJvcE5hbWVdO1xyXG4gICAgICBjb25zdCBkYXRhRmllbGQgPSBuZ0xpc3QuZGF0YUZpZWxkIHx8IHByb3BOYW1lO1xyXG4gICAgICByZXN1bHRbZGF0YUZpZWxkXSA9IHRoaXNbcHJvcE5hbWVdID8gdGhpc1twcm9wTmFtZV0udG9KU09OKGJ1aWxkQ2hhbmdlcykgOiB7fTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG59O1xyXG4iXX0=