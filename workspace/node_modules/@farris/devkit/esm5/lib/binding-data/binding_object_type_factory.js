import * as tslib_1 from "tslib";
import { BindingPropertyType } from './binding_property';
import { PropertyUtil } from './property_util';
import { BaseBindingObject } from './base_binding_object';
import { BindingListFactory } from './binding_list_factory';
import { TranslateService } from '../i18n/translate_service';
// import { BindingObjectFactory } from './binding_object_factory';
/**
 * BindingObjectTypeFactory
 */
var BindingObjectTypeFactory = /** @class */ (function () {
    function BindingObjectTypeFactory() {
    }
    /**
     * 创建BindingObject
     * @param properties
     * @returns
     */
    BindingObjectTypeFactory.create = function (properties) {
        var bindingObjectType = this.getType(properties);
        return new bindingObjectType();
    };
    /**
     * 创建原型类型
     * @param properties
     * @returns
     */
    BindingObjectTypeFactory.createType = function (properties) {
        // 继承原绑定对象所有属性
        var bindingObjectType = /** @class */ (function (_super) {
            tslib_1.__extends(BindingObjectType, _super);
            function BindingObjectType() {
                return _super.call(this) || this;
                // this.innerValues = ImmutableMap(Object.assign({}, data));
            }
            return BindingObjectType;
        }(BaseBindingObject));
        // 获取主键
        var primaryKey = PropertyUtil.getPrimaryKey(properties);
        // 设置主键
        bindingObjectType.prototype.primaryKey = primaryKey;
        bindingObjectType.prototype.properties = properties;
        // 将属性扩展到原型对象上
        this.extendProperties(bindingObjectType.prototype, properties);
        return bindingObjectType;
    };
    /**
     * 扩展原型属性
     * @param typePrototype
     * @param properties
     */
    BindingObjectTypeFactory.extendProperties = function (typePrototype, properties) {
        var _this = this;
        // 扩展BindingObject属性
        properties.forEach(function (property) {
            if (property.type === BindingPropertyType.List) {
                _this.extendListProperty(typePrototype, property);
            }
            else if (property.type === BindingPropertyType.Object) {
                _this.extendObjectProperty(typePrototype, property);
            }
            else if (property.type === BindingPropertyType.Dynamic) {
                _this.extendDynamicObjectProperty(typePrototype, property);
            }
            else {
                _this.extendPlainProperty(typePrototype, property);
            }
        });
    };
    /**
     * 扩展原型列表属性
     * @param typePrototype
     * @param property
     */
    BindingObjectTypeFactory.extendListProperty = function (typePrototype, property) {
        var propertyName = property.name;
        var childListProperties = PropertyUtil.getProperties(property.entityType);
        var key = "_" + propertyName + "_";
        // 将子的BindingList实例赋值给当前属性
        Object.defineProperty(typePrototype, propertyName, {
            get: function () {
                var _this = this;
                var bindingList = this[key];
                if (!bindingList) {
                    bindingList = BindingListFactory.create(childListProperties);
                    this[key] = bindingList;
                    // 加载数据
                    var data = this.getValue(propertyName);
                    if (data) {
                        var bindingObjects = data.map(function (item) {
                            var bindingObject = BindingObjectTypeFactory.create(childListProperties);
                            return bindingObject;
                        });
                        bindingList.load(bindingObjects);
                    }
                    // 指定子List的parent、监听子List的changes事件
                    bindingList.parent = this;
                    bindingList.changes.subscribe(function (change) {
                        change.path.unshift(propertyName);
                        change.isBindingListTransmited = true;
                        _this.changes.next(change);
                    });
                }
                return bindingList;
            },
            set: function (bindingList) {
                this[key] = bindingList;
            }
        });
    };
    /**
     * 扩展原型对象属性
     * @param typePrototype
     * @param property
     */
    BindingObjectTypeFactory.extendObjectProperty = function (typePrototype, property) {
        var propertyName = property.name;
        var childObjectProperties = PropertyUtil.getProperties(property.entityType);
        var key = "_" + propertyName + "_";
        Object.defineProperty(typePrototype, propertyName, {
            get: function () {
                var _this = this;
                var bindingObject = this[key];
                if (!bindingObject) {
                    var value = this.getValue(propertyName) || {};
                    bindingObject = BindingObjectTypeFactory.create(childObjectProperties);
                    this[key] = bindingObject;
                    // 指定子Object的parent、监听子Object的changes事件
                    bindingObject.parent = this;
                    bindingObject.changes.subscribe(function (change) {
                        change.path.unshift(propertyName);
                        _this.changes.next(change);
                    });
                }
                return bindingObject;
            },
            set: function (value) {
                this[key] = value;
            }
        });
    };
    /**
     * 扩展原型动态属性
     * @param typePrototype
     * @param property
     */
    BindingObjectTypeFactory.extendDynamicObjectProperty = function (typePrototype, property) {
        var propertyName = property.name;
        // Object.defineProperty(typePrototype, propertyName, {
        //   value: null
        // });
        typePrototype[propertyName] = null;
    };
    /**
     * 扩展原型简单属性
     * @param typePrototype
     * @param property
     */
    BindingObjectTypeFactory.extendPlainProperty = function (typePrototype, property) {
        var propertyName = property.name;
        Object.defineProperty(typePrototype, propertyName, {
            get: function () {
                var _a;
                if (property.enableMultiLangInput === true) {
                    var value = this.getValue(propertyName, false);
                    if (!value) {
                        value = this.getValue(propertyName, false);
                        var langCode = TranslateService.getCurrentLanguage();
                        return _a = {}, _a[langCode] = value, _a;
                    }
                    return value;
                }
                else {
                    var value = this.getValue(propertyName);
                    return value;
                }
            },
            set: function (value) {
                var oldValue = this.getValue(propertyName);
                if (value === oldValue) {
                    return;
                }
                this.setValue(propertyName, value, true, true);
            }
        });
    };
    /**
     * 获取缓存的bindingList模板类
     * @param properties bindingList属性
     * @returns
     */
    BindingObjectTypeFactory.getType = function (properties) {
        if (this.provider.has(properties)) {
            return this.provider.get(properties);
        }
        var bindingObjectType = this.createType(properties);
        this.provider.set(properties, bindingObjectType);
        return bindingObjectType;
    };
    BindingObjectTypeFactory.provider = new Map();
    return BindingObjectTypeFactory;
}());
export { BindingObjectTypeFactory };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19vYmplY3RfdHlwZV9mYWN0b3J5LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvYmluZGluZy1kYXRhL2JpbmRpbmdfb2JqZWN0X3R5cGVfZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBR0EsT0FBTyxFQUFtQixtQkFBbUIsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRTFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUc1RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUM3RCxtRUFBbUU7QUFFbkU7O0dBRUc7QUFDSDtJQUFBO0lBa1BBLENBQUM7SUFoUEM7Ozs7T0FJRztJQUNXLCtCQUFNLEdBQXBCLFVBQXFCLFVBQTZCO1FBQ2hELElBQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNuRCxPQUFPLElBQUksaUJBQWlCLEVBQUUsQ0FBQztJQUNqQyxDQUFDO0lBQ0Q7Ozs7T0FJRztJQUNZLG1DQUFVLEdBQXpCLFVBQTBCLFVBQTZCO1FBQ3JELGNBQWM7UUFDZCxJQUFNLGlCQUFpQjtZQUFtQyw2Q0FBaUI7WUFDekU7dUJBQ0UsaUJBQU87Z0JBQ1AsNERBQTREO1lBRTlELENBQUM7WUFnRUgsd0JBQUM7UUFBRCxDQUFDLEFBckV5QixDQUFnQyxpQkFBaUIsRUFxRTFFLENBQUM7UUFDRixPQUFPO1FBQ1AsSUFBTSxVQUFVLEdBQUcsWUFBWSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUMxRCxPQUFPO1FBQ1AsaUJBQWlCLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDcEQsaUJB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SyxLQUFLLFFBQVEsRUFBRTtvQkFDdEIsT0FBTztpQkFDUjtnQkFDRCxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ2pELENBQUM7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0Q7Ozs7T0FJRztJQUNZLGdDQUFPLEdBQXRCLFVBQXVCLFVBQTZCO1FBQ2xELElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDakMsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUN0QztRQUNELElBQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN0RCxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztRQUNqRCxPQUFPLGlCQUFpQixDQUFDO0lBQzNCLENBQUM7SUFoUGMsaUNBQVEsR0FBZ0QsSUFBSSxHQUFHLEVBQTBDLENBQUM7SUFpUDNILCtCQUFDO0NBQUEsQUFsUEQsSUFrUEM7U0FsUFksd0JBQXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG4vL2ltcG9ydCB7IE1hcCBhcyBJbW11dGFibGVNYXAgfSBmcm9tICdpbW11dGFibGUnO1xyXG5pbXBvcnQgeyBDaGFuZ2UgfSBmcm9tICcuL2NoYW5nZXMnO1xyXG5pbXBvcnQgeyBCaW5kaW5nUHJvcGVydHksIEJpbmRpbmdQcm9wZXJ0eVR5cGUgfSBmcm9tICcuL2JpbmRpbmdfcHJvcGVydHknO1xyXG5pbXBvcnQgeyBCaW5kaW5nTGlzdCB9IGZyb20gJy4vYmluZGluZ19saXN0JztcclxuaW1wb3J0IHsgUHJvcGVydHlVdGlsIH0gZnJvbSAnLi9wcm9wZXJ0eV91dGlsJztcclxuaW1wb3J0IHsgQmFzZUJpbmRpbmdPYmplY3QgfSBmcm9tICcuL2Jhc2VfYmluZGluZ19vYmplY3QnO1xyXG5pbXBvcnQgeyBCaW5kaW5nTGlzdEZhY3RvcnkgfSBmcm9tICcuL2JpbmRpbmdfbGlzdF9mYWN0b3J5JztcclxuaW1wb3J0IHsgQ2xhc3NUeXBlIH0gZnJvbSAnLi4vZW50aXR5JztcclxuaW1wb3J0IHsgQmluZGluZ09iamVjdCB9IGZyb20gJy4vYmluZGluZ19vYmplY3QnO1xyXG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnLi4vaTE4bi90cmFuc2xhdGVfc2VydmljZSc7XHJcbi8vIGltcG9ydCB7IEJpbmRpbmdPYmplY3RGYWN0b3J5IH0gZnJvbSAnLi9iaW5kaW5nX29iamVjdF9mYWN0b3J5JztcclxuXHJcbi8qKlxyXG4gKiBCaW5kaW5nT2JqZWN0VHlwZUZhY3RvcnlcclxuICovXHJcbmV4cG9ydCBjbGFzcyBCaW5kaW5nT2JqZWN0VHlwZUZhY3Rvcnkge1xyXG4gIHByaXZhdGUgc3RhdGljIHByb3ZpZGVyOiBNYXA8QmluZGluZ1Byb3BlcnR5W10sIFR5cGU8QmluZGluZ09iamVjdD4+ID0gbmV3IE1hcDxCaW5kaW5nUHJvcGVydHlbXSwgVHlwZTxCaW5kaW5nT2JqZWN0Pj4oKTtcclxuICAvKipcclxuICAgKiDliJvlu7pCaW5kaW5nT2JqZWN0XHJcbiAgICogQHBhcmFtIHByb3BlcnRpZXNcclxuICAgKiBAcmV0dXJuc1xyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGF0aWMgY3JlYXRlKHByb3BlcnRpZXM6IEJpbmRpbmdQcm9wZXJ0eVtdKSB7XHJcbiAgICBjb25zdCBiaW5kaW5nT2JqZWN0VHlwZSA9IHRoaXMuZ2V0VHlwZShwcm9wZXJ0aWVzKTtcclxuICAgIHJldHVybiBuZXcgYmluZGluZ09iamVjdFR5cGUoKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yib5bu65Y6f5Z6L57G75Z6LXHJcbiAgICogQHBhcmFtIHByb3BlcnRpZXNcclxuICAgKiBAcmV0dXJuc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIGNyZWF0ZVR5cGUocHJvcGVydGllczogQmluZGluZ1Byb3BlcnR5W10pOiBDbGFzc1R5cGU8QmluZGluZ09iamVjdD4ge1xyXG4gICAgLy8g57un5om/5Y6f57uR5a6a5a+56LGh5omA5pyJ5bGe5oCnXHJcbiAgICBjb25zdCBiaW5kaW5nT2JqZWN0VHlwZSA9IGNsYXNzIEJpbmRpbmdPYmplY3RUeXBlIGV4dGVuZHMgQmFzZUJpbmRpbmdPYmplY3Qge1xyXG4gICAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIC8vIHRoaXMuaW5uZXJWYWx1ZXMgPSBJbW11dGFibGVNYXAoT2JqZWN0LmFzc2lnbih7fSwgZGF0YSkpO1xyXG5cclxuICAgICAgfVxyXG4gICAgICAvLyNlbmRyZWdpb24gbG9hZFxyXG5cclxuICAgICAgLypcclxuICAgICAgcHVibGljIGxvYWQoZGF0YTogYW55KSB7XHJcbiAgICAgICAgLy8gZGF0YeWMheWQq+WkmuivreWtl+autVxyXG4gICAgICAgIHRoaXMuaW5uZXJWYWx1ZXMgPSBJbW11dGFibGVNYXAoT2JqZWN0LmFzc2lnbih7fSwgZGF0YSkpO1xyXG4gICAgICAgIHRoaXMucHJvcGVydGllcy5mb3JFYWNoKChwcm9wZXJ0eTogQmluZGluZ1Byb3BlcnR5KSA9PiB7XHJcbiAgICAgICAgICBpZiAocHJvcGVydHkudHlwZSA9PT0gQmluZGluZ1Byb3BlcnR5VHlwZS5MaXN0KSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9hZExpc3RzKHByb3BlcnR5KTtcclxuICAgICAgICAgIH0gZWxzZSBpZiAocHJvcGVydHkudHlwZSA9PT0gQmluZGluZ1Byb3BlcnR5VHlwZS5PYmplY3QpIHtcclxuICAgICAgICAgICAgdGhpcy5sb2FkT2JqZWN0cyhwcm9wZXJ0eSk7XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuRHluYW1pYykge1xyXG4gICAgICAgICAgICB0aGlzLmxvYWREeW5hbWljT2JqZWN0cyhwcm9wZXJ0eSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmxvYWRGaWVsZHMocHJvcGVydHkpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIHByaXZhdGUgbG9hZEZpZWxkcyhwcm9wZXJ0eTogQmluZGluZ1Byb3BlcnR5KSB7XHJcbiAgICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gcHJvcGVydHkubmFtZTtcclxuICAgICAgICBjb25zdCBkYXRhRmllbGQgPSBwcm9wZXJ0eS5kYXRhRmllbGQgfHwgcHJvcGVydHlOYW1lO1xyXG4gICAgICAgIGxldCB2YWx1ZTtcclxuICAgICAgICBpZiAocHJvcGVydHkuZW5hYmxlTXVsdGlMYW5nSW5wdXQpIHtcclxuICAgICAgICAgIHZhbHVlID0gdGhpcy5nZXRWYWx1ZShkYXRhRmllbGQsIGZhbHNlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdmFsdWUgPSB0aGlzLmdldFZhbHVlKHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXNbcHJvcGVydHlOYW1lXSA9IHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICAgIHByaXZhdGUgbG9hZExpc3RzKHByb3BlcnR5OiBCaW5kaW5nUHJvcGVydHkpIHtcclxuICAgICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eS5uYW1lO1xyXG4gICAgICAgIGNvbnN0IGtleSA9IGBfJHtwcm9wZXJ0eU5hbWV9X2A7XHJcbiAgICAgICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gdGhpc1trZXldO1xyXG4gICAgICAgIGlmIChiaW5kaW5nTGlzdCkge1xyXG4gICAgICAgICAgY29uc3QgY2hpbGRMaXN0UHJvcGVydGllcyA9IFByb3BlcnR5VXRpbC5nZXRQcm9wZXJ0aWVzKHByb3BlcnR5LmVudGl0eVR5cGUpO1xyXG4gICAgICAgICAgY29uc3QgZGF0YTogYW55W10gPSB0aGlzLmdldFZhbHVlKHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICBpZiAoZGF0YSkge1xyXG4gICAgICAgICAgICBjb25zdCBiaW5kaW5nT2JqZWN0cyA9IGRhdGEubWFwKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBCaW5kaW5nT2JqZWN0VHlwZUZhY3RvcnkuY3JlYXRlKGNoaWxkTGlzdFByb3BlcnRpZXMpO1xyXG4gICAgICAgICAgICAgIHJldHVybiBiaW5kaW5nT2JqZWN0O1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgYmluZGluZ0xpc3QubG9hZChiaW5kaW5nT2JqZWN0cyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHByaXZhdGUgbG9hZE9iamVjdHMocHJvcGVydHk6IEJpbmRpbmdQcm9wZXJ0eSkge1xyXG4gICAgICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHByb3BlcnR5Lm5hbWU7XHJcbiAgICAgICAgY29uc3Qga2V5ID0gYF8ke3Byb3BlcnR5TmFtZX1fYDtcclxuICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWUocHJvcGVydHlOYW1lKSB8fCB7fTtcclxuICAgICAgICBjb25zdCBjaGlsZE9iamVjdFByb3BlcnRpZXMgPSBQcm9wZXJ0eVV0aWwuZ2V0UHJvcGVydGllcyhwcm9wZXJ0eS5lbnRpdHlUeXBlKTtcclxuICAgICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gQmluZGluZ09iamVjdFR5cGVGYWN0b3J5LmNyZWF0ZShjaGlsZE9iamVjdFByb3BlcnRpZXMpO1xyXG4gICAgICAgIHRoaXNba2V5XSA9IGJpbmRpbmdPYmplY3Q7XHJcblxyXG4gICAgICB9XHJcbiAgICAgIHByaXZhdGUgbG9hZER5bmFtaWNPYmplY3RzKHByb3BlcnR5OiBCaW5kaW5nUHJvcGVydHkpIHtcclxuICAgICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eS5uYW1lO1xyXG4gICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUpIHx8IHt9O1xyXG4gICAgICAgIGNvbnN0IGR5bmFtaWNPYmplY3QgPSBCaW5kaW5nT2JqZWN0RmFjdG9yeS5jcmVhdGVEeW5hbWljQmluZGluZ09iamVjdCh2YWx1ZSk7XHJcbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgICAgICAgdmFsdWU6IGR5bmFtaWNPYmplY3RcclxuICAgICAgICB9KTtcclxuICAgICAgfSovXHJcbiAgICAgIC8vI2VuZHJlZ2lvblxyXG4gICAgfTtcclxuICAgIC8vIOiOt+WPluS4u+mUrlxyXG4gICAgY29uc3QgcHJpbWFyeUtleSA9IFByb3BlcnR5VXRpbC5nZXRQcmltYXJ5S2V5KHByb3BlcnRpZXMpO1xyXG4gICAgLy8g6K6+572u5Li76ZSuXHJcbiAgICBiaW5kaW5nT2JqZWN0VHlwZS5wcm90b3R5cGUucHJpbWFyeUtleSA9IHByaW1hcnlLZXk7XHJcbiAgICBiaW5kaW5nT2JqZWN0VHlwZS5wcm90b3R5cGUucHJvcGVydGllcyA9IHByb3BlcnRpZXM7XHJcbiAgICAvLyDlsIblsZ7mgKfmianlsZXliLDljp/lnovlr7nosaHkuIpcclxuICAgIHRoaXMuZXh0ZW5kUHJvcGVydGllcyhiaW5kaW5nT2JqZWN0VHlwZS5wcm90b3R5cGUsIHByb3BlcnRpZXMpO1xyXG4gICAgcmV0dXJuIGJpbmRpbmdPYmplY3RUeXBlO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmianlsZXljp/lnovlsZ7mgKdcclxuICAgKiBAcGFyYW0gdHlwZVByb3RvdHlwZVxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0aWVzXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGF0aWMgZXh0ZW5kUHJvcGVydGllcyh0eXBlUHJvdG90eXBlOiBCYXNlQmluZGluZ09iamVjdCwgcHJvcGVydGllczogQmluZGluZ1Byb3BlcnR5W10pIHtcclxuICAgIC8vIOaJqeWxlUJpbmRpbmdPYmplY3TlsZ7mgKdcclxuICAgIHByb3BlcnRpZXMuZm9yRWFjaCgocHJvcGVydHk6IEJpbmRpbmdQcm9wZXJ0eSkgPT4ge1xyXG4gICAgICBpZiAocHJvcGVydHkudHlwZSA9PT0gQmluZGluZ1Byb3BlcnR5VHlwZS5MaXN0KSB7XHJcbiAgICAgICAgdGhpcy5leHRlbmRMaXN0UHJvcGVydHkodHlwZVByb3RvdHlwZSwgcHJvcGVydHkpO1xyXG4gICAgICB9IGVsc2UgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuT2JqZWN0KSB7XHJcbiAgICAgICAgdGhpcy5leHRlbmRPYmplY3RQcm9wZXJ0eSh0eXBlUHJvdG90eXBlLCBwcm9wZXJ0eSk7XHJcbiAgICAgIH0gZWxzZSBpZiAocHJvcGVydHkudHlwZSA9PT0gQmluZGluZ1Byb3BlcnR5VHlwZS5EeW5hbWljKSB7XHJcbiAgICAgICAgdGhpcy5leHRlbmREeW5hbWljT2JqZWN0UHJvcGVydHkodHlwZVByb3RvdHlwZSwgcHJvcGVydHkpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuZXh0ZW5kUGxhaW5Qcm9wZXJ0eSh0eXBlUHJvdG90eXBlLCBwcm9wZXJ0eSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmianlsZXljp/lnovliJfooajlsZ7mgKdcclxuICAgKiBAcGFyYW0gdHlwZVByb3RvdHlwZVxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eVxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZExpc3RQcm9wZXJ0eSh0eXBlUHJvdG90eXBlOiBCYXNlQmluZGluZ09iamVjdCwgcHJvcGVydHk6IEJpbmRpbmdQcm9wZXJ0eSkge1xyXG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gcHJvcGVydHkubmFtZTtcclxuICAgIGNvbnN0IGNoaWxkTGlzdFByb3BlcnRpZXMgPSBQcm9wZXJ0eVV0aWwuZ2V0UHJvcGVydGllcyhwcm9wZXJ0eS5lbnRpdHlUeXBlKTtcclxuICAgIGNvbnN0IGtleSA9IGBfJHtwcm9wZXJ0eU5hbWV9X2A7XHJcbiAgICAvLyDlsIblrZDnmoRCaW5kaW5nTGlzdOWunuS+i+i1i+WAvOe7meW9k+WJjeWxnuaAp1xyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHR5cGVQcm90b3R5cGUsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBsZXQgYmluZGluZ0xpc3QgPSB0aGlzW2tleV07XHJcbiAgICAgICAgaWYgKCFiaW5kaW5nTGlzdCkge1xyXG4gICAgICAgICAgYmluZGluZ0xpc3QgPSBCaW5kaW5nTGlzdEZhY3RvcnkuY3JlYXRlKGNoaWxkTGlzdFByb3BlcnRpZXMpO1xyXG4gICAgICAgICAgdGhpc1trZXldID0gYmluZGluZ0xpc3Q7XHJcbiAgICAgICAgICAvLyDliqDovb3mlbDmja5cclxuICAgICAgICAgIGNvbnN0IGRhdGE6IGFueVtdID0gdGhpcy5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgaWYgKGRhdGEpIHtcclxuICAgICAgICAgICAgY29uc3QgYmluZGluZ09iamVjdHMgPSBkYXRhLm1hcCgoaXRlbSkgPT4ge1xyXG4gICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBCaW5kaW5nT2JqZWN0VHlwZUZhY3RvcnkuY3JlYXRlKGNoaWxkTGlzdFByb3BlcnRpZXMpO1xyXG4gICAgICAgICAgICAgIHJldHVybiBiaW5kaW5nT2JqZWN0O1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgYmluZGluZ0xpc3QubG9hZChiaW5kaW5nT2JqZWN0cyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyDmjIflrprlrZBMaXN055qEcGFyZW5044CB55uR5ZCs5a2QTGlzdOeahGNoYW5nZXPkuovku7ZcclxuICAgICAgICAgIGJpbmRpbmdMaXN0LnBhcmVudCA9IHRoaXM7XHJcbiAgICAgICAgICBiaW5kaW5nTGlzdC5jaGFuZ2VzLnN1YnNjcmliZSgoY2hhbmdlOiBDaGFuZ2UpID0+IHtcclxuICAgICAgICAgICAgY2hhbmdlLnBhdGgudW5zaGlmdChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgICBjaGFuZ2UuaXNCaW5kaW5nTGlzdFRyYW5zbWl0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLmNoYW5nZXMubmV4dChjaGFuZ2UpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBiaW5kaW5nTGlzdDtcclxuICAgICAgfSxcclxuICAgICAgc2V0OiBmdW5jdGlvbiAoYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0KSB7XHJcbiAgICAgICAgdGhpc1trZXldID0gYmluZGluZ0xpc3Q7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmianlsZXljp/lnovlr7nosaHlsZ7mgKdcclxuICAgKiBAcGFyYW0gdHlwZVByb3RvdHlwZVxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eVxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZE9iamVjdFByb3BlcnR5KHR5cGVQcm90b3R5cGU6IEJhc2VCaW5kaW5nT2JqZWN0LCBwcm9wZXJ0eTogQmluZGluZ1Byb3BlcnR5KTogdm9pZCB7XHJcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eS5uYW1lO1xyXG4gICAgY29uc3QgY2hpbGRPYmplY3RQcm9wZXJ0aWVzID0gUHJvcGVydHlVdGlsLmdldFByb3BlcnRpZXMocHJvcGVydHkuZW50aXR5VHlwZSk7XHJcbiAgICBjb25zdCBrZXkgPSBgXyR7cHJvcGVydHlOYW1lfV9gO1xyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHR5cGVQcm90b3R5cGUsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBsZXQgYmluZGluZ09iamVjdCA9IHRoaXNba2V5XTtcclxuICAgICAgICBpZiAoIWJpbmRpbmdPYmplY3QpIHtcclxuICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUpIHx8IHt9O1xyXG4gICAgICAgICAgYmluZGluZ09iamVjdCA9IEJpbmRpbmdPYmplY3RUeXBlRmFjdG9yeS5jcmVhdGUoY2hpbGRPYmplY3RQcm9wZXJ0aWVzKTtcclxuICAgICAgICAgIHRoaXNba2V5XSA9IGJpbmRpbmdPYmplY3Q7XHJcbiAgICAgICAgICAvLyDmjIflrprlrZBPYmplY3TnmoRwYXJlbnTjgIHnm5HlkKzlrZBPYmplY3TnmoRjaGFuZ2Vz5LqL5Lu2XHJcbiAgICAgICAgICBiaW5kaW5nT2JqZWN0LnBhcmVudCA9IHRoaXM7XHJcbiAgICAgICAgICBiaW5kaW5nT2JqZWN0LmNoYW5nZXMuc3Vic2NyaWJlKChjaGFuZ2U6IENoYW5nZSkgPT4ge1xyXG4gICAgICAgICAgICBjaGFuZ2UucGF0aC51bnNoaWZ0KHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlcy5uZXh0KGNoYW5nZSk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGJpbmRpbmdPYmplY3Q7XHJcbiAgICAgIH0sXHJcbiAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlOiBCYXNlQmluZGluZ09iamVjdCkge1xyXG4gICAgICAgIHRoaXNba2V5XSA9IHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5omp5bGV5Y6f5Z6L5Yqo5oCB5bGe5oCnXHJcbiAgICogQHBhcmFtIHR5cGVQcm90b3R5cGVcclxuICAgKiBAcGFyYW0gcHJvcGVydHlcclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBleHRlbmREeW5hbWljT2JqZWN0UHJvcGVydHkodHlwZVByb3RvdHlwZTogQmFzZUJpbmRpbmdPYmplY3QsIHByb3BlcnR5OiBCaW5kaW5nUHJvcGVydHkpOiB2b2lkIHtcclxuICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHByb3BlcnR5Lm5hbWU7XHJcbiAgICAvLyBPYmplY3QuZGVmaW5lUHJvcGVydHkodHlwZVByb3RvdHlwZSwgcHJvcGVydHlOYW1lLCB7XHJcbiAgICAvLyAgIHZhbHVlOiBudWxsXHJcbiAgICAvLyB9KTtcclxuICAgIHR5cGVQcm90b3R5cGVbcHJvcGVydHlOYW1lXSA9IG51bGw7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJqeWxleWOn+Wei+eugOWNleWxnuaAp1xyXG4gICAqIEBwYXJhbSB0eXBlUHJvdG90eXBlXHJcbiAgICogQHBhcmFtIHByb3BlcnR5XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGF0aWMgZXh0ZW5kUGxhaW5Qcm9wZXJ0eSh0eXBlUHJvdG90eXBlOiBCYXNlQmluZGluZ09iamVjdCwgcHJvcGVydHk6IEJpbmRpbmdQcm9wZXJ0eSk6IHZvaWQge1xyXG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gcHJvcGVydHkubmFtZTtcclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0eXBlUHJvdG90eXBlLCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKHByb3BlcnR5LmVuYWJsZU11bHRpTGFuZ0lucHV0ID09PSB0cnVlKSB7XHJcbiAgICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmdldFZhbHVlKHByb3BlcnR5TmFtZSwgZmFsc2UpO1xyXG4gICAgICAgICAgaWYgKCF2YWx1ZSkge1xyXG4gICAgICAgICAgICB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWUocHJvcGVydHlOYW1lLCBmYWxzZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGxhbmdDb2RlID0gVHJhbnNsYXRlU2VydmljZS5nZXRDdXJyZW50TGFuZ3VhZ2UoKTtcclxuICAgICAgICAgICAgcmV0dXJuIHsgW2xhbmdDb2RlXTogdmFsdWUgfTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldFZhbHVlKHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9LFxyXG4gICAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZTogYW55KSB7XHJcbiAgICAgICAgY29uc3Qgb2xkVmFsdWUgPSB0aGlzLmdldFZhbHVlKHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgaWYgKHZhbHVlID09PSBvbGRWYWx1ZSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNldFZhbHVlKHByb3BlcnR5TmFtZSwgdmFsdWUsIHRydWUsIHRydWUpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W57yT5a2Y55qEYmluZGluZ0xpc3TmqKHmnb/nsbtcclxuICAgKiBAcGFyYW0gcHJvcGVydGllcyBiaW5kaW5nTGlzdOWxnuaAp1xyXG4gICAqIEByZXR1cm5zXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0VHlwZShwcm9wZXJ0aWVzOiBCaW5kaW5nUHJvcGVydHlbXSk6IFR5cGU8QmluZGluZ09iamVjdD4ge1xyXG4gICAgaWYgKHRoaXMucHJvdmlkZXIuaGFzKHByb3BlcnRpZXMpKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnByb3ZpZGVyLmdldChwcm9wZXJ0aWVzKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGJpbmRpbmdPYmplY3RUeXBlID0gdGhpcy5jcmVhdGVUeXBlKHByb3BlcnRpZXMpO1xyXG4gICAgdGhpcy5wcm92aWRlci5zZXQocHJvcGVydGllcywgYmluZGluZ09iamVjdFR5cGUpO1xyXG4gICAgcmV0dXJuIGJpbmRpbmdPYmplY3RUeXBlO1xyXG4gIH1cclxufVxyXG4iXX0=