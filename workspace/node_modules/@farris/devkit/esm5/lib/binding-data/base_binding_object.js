import { Subject, of } from 'rxjs';
import { Map } from 'immutable';
import { ChangeType, ViewChangeType } from './changes';
import { BindingPropertyType } from './binding_property';
import { BindingList } from './binding_list';
/**
 * 绑定对象基类
 */
var BaseBindingObject = /** @class */ (function () {
    // private __differ__ = this.differ();
    function BaseBindingObject() {
        this.__type__ = 'BindingObject';
        /**
         * 绑定到实体
         */
        this.fromEntity = undefined;
        /**
         * 标识是否提交过
         */
        this.isShowValidationMsg = false;
        /**
         * 销毁流
         */
        this.unsubscribe = new Subject();
        /**
         * 以{ [propertyName]: FormControl }的形式存放每条数据的control
         */
        this.controlMap = {};
        this.innerValues = Map();
        this.changes = new Subject();
        this.viewChanges = new Subject();
    }
    Object.defineProperty(BaseBindingObject.prototype, "primaryKeyValue", {
        /**
         * 主键值
         */
        get: function () {
            return this.primaryKey ? this.getValue(this.primaryKey) : '';
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseBindingObject.prototype, "rowPrimaryKeyValue", {
        /**
         * 数据行的主键值
         */
        get: function () {
            var row = this.getRow(this);
            return row && row.primaryKeyValue || null;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 设置是否提交过
     */
    BaseBindingObject.prototype.setShowValidationMsg = function (flag) {
        this.isShowValidationMsg = flag;
    };
    // public abstract load(data: any);
    /**
     * 根据属性名获取属性值
     * @param   propertyName 属性名
     * @returns 属性值
     */
    BaseBindingObject.prototype.getValue = function (propertyName) {
        return this.innerValues.get(propertyName);
    };
    /**
     * 设置属性值
     * @param propertyName        属性名
     * @param propertyValue       属性值
     * @param emitEventToView     是否通知View层去更新界面，默认为false
     * @param emitEventToEntity   是否通知Entity层去更新值，默认为false
     * @param errors              错误消息
     * @param invokeOnValueChange 值变化事件执行句柄
     */
    BaseBindingObject.prototype.setValue = function (propertyName, propertyValue, emitEventToView, emitEventToEntity, errors, invokeOnValueChange, context) {
        var _this = this;
        if (emitEventToView === void 0) { emitEventToView = false; }
        if (emitEventToEntity === void 0) { emitEventToEntity = false; }
        // 屏蔽掉无效的赋值，防止后续赋值对比时跳过，导致实体无法赋值
        // if (this.primaryKey && !this.primaryKeyValue && this.primaryKey !== propertyName) {
        //   return;
        // }
        var oldPropertyValue = this.getValue(propertyName);
        // 由于特定原因（@邵珠强），无法屏蔽oldPropertyValue === propertyValue
        // if (oldPropertyValue === propertyValue) {
        //   return;
        // }
        if (!invokeOnValueChange || oldPropertyValue === propertyValue) {
            // 设定缺省
            invokeOnValueChange = function (preValue, value, entityChanged, primaryValue) {
                return of(true);
            };
        }
        if (emitEventToEntity === true) {
            // BUG 322301，删除@2019.08.10; 如果无对应实体，则中止值传递; 这种情况发生在带从表的单据新增，从表响应Load变化的情况；
            // if(!this.innerValues.has(propertyName)) {
            //   return;
            // }
            // 执行实体值变化前事件
            invokeOnValueChange(oldPropertyValue, propertyValue, false, this.rowPrimaryKeyValue).subscribe(function (result) {
                if (result) {
                    //this.__differ__.onValueChange();
                    // 如果成功，执行变化，并通知实体变化
                    _this.innerValues = _this.innerValues.set(propertyName, propertyValue);
                    // this.data[propertyName] = propertyValue;
                    var viewChange = _this.buildViewChangesContext(propertyName, propertyValue, oldPropertyValue, errors, context);
                    _this.viewChanges.next(viewChange);
                    // 如果需要通知视图，通知视图相应修改
                    if (emitEventToView === true) {
                        var change = _this.buildChangesContext(propertyName, propertyValue, context, errors);
                        _this.changes.next(change);
                    }
                    // 执行实体值变化后事件
                    invokeOnValueChange(oldPropertyValue, propertyValue, true, _this.rowPrimaryKeyValue).subscribe();
                }
                else {
                    // 如果失败，不再通知实体变化
                    // 并执行界面回滚操作
                    var change = _this.buildChangesContext(propertyName, oldPropertyValue, context, errors);
                    _this.changes.next(change);
                }
            });
        }
        else {
            //this.__differ__.onValueChange();
            // `emitEventToEntity === false`, 则认定实体值已经发生变化，通知视图变化，并触发实体值变化后事件
            this.innerValues = this.innerValues.set(propertyName, propertyValue);
            // this.data[propertyName] = propertyValue;
            if (emitEventToView === true) {
                var change = this.buildChangesContext(propertyName, propertyValue, context, errors);
                this.changes.next(change);
            }
            // 执行实体值变化后事件
            invokeOnValueChange(oldPropertyValue, propertyValue, true, this.rowPrimaryKeyValue).subscribe();
        }
    };
    /**
     * 将BindingObject实例转换成JSON对象
     */
    BaseBindingObject.prototype.toJSON = function (options) {
        var _this = this;
        //if (!this.__differ__.isChange()) {
        //  return this.__differ__.value();
        //}
        var langCode = this.getCurrentLanguage(); //window.localStorage.getItem('languageCode') || 'zh-CHS';
        var result = {};
        this.properties.forEach(function (property) {
            var _a;
            var propName = property.name;
            if (property.type === BindingPropertyType.List) {
                var list = _this[propName];
                result[propName] = list.toJSON(options);
            }
            else if (property.type === BindingPropertyType.Object) {
                var object = _this[propName];
                result[propName] = object.toJSON(options);
            }
            else if (property.type === BindingPropertyType.Dynamic) {
                var object = _this[propName];
                result[propName] = object.toJSON(options);
            }
            else {
                // 1、对于多语录入字段；
                // 2、传入ignoreMultiLangInput标志，则取当前语言的值给控件。
                if (property.enableMultiLangInput === true) {
                    // 忽略多语字段，只返回当前语言
                    if (options && options.ignoreMultiLangInput === true) {
                        var multiLangValueObj = _this.getValue(propName);
                        if (multiLangValueObj) {
                            result[propName] = multiLangValueObj[langCode];
                        }
                        else {
                            result[propName] = multiLangValueObj;
                        }
                    }
                    else if (options && options.useFullMultiLangProperty) {
                        // 给审批提供的扩展 @2021-10-13
                        var multiLangValueObj = _this.getValue(propName);
                        if (multiLangValueObj) {
                            result[propName + "_MULTILANGUAGE"] = multiLangValueObj;
                            // 除返回多语字段外，将当前语言也返回
                            result[propName] = multiLangValueObj[langCode];
                        }
                    }
                    else {
                        var multiLangValueObj = _this.getValue(propName);
                        if (!multiLangValueObj) {
                            result[propName] = (_a = {}, _a[langCode] = multiLangValueObj, _a);
                        }
                        else {
                            result[propName] = multiLangValueObj;
                        }
                    }
                }
                else {
                    result[propName] = _this.getValue(propName);
                }
            }
        });
        // this.__differ__.update(result);
        return result;
    };
    /**
     * 获取当前语言
     * @returns
     */
    BaseBindingObject.prototype.getCurrentLanguage = function () {
        this.currentLanguage = this.currentLanguage || window.localStorage.getItem('languageCode') || 'zh-CHS';
        return this.currentLanguage;
    };
    /**
     * 构造bindignData变更上下文
     * @param propertyName
     * @param propertyValue
     * @param context
     * @param errors
     * @param type
     * @returns
     */
    BaseBindingObject.prototype.buildChangesContext = function (propertyName, propertyValue, context, errors, type) {
        if (type === void 0) { type = ChangeType.ValueChanged; }
        var object = this.getRow(this);
        var id = object ? object.primaryKeyValue : null;
        return {
            type: type,
            path: [propertyName],
            value: propertyValue,
            id: id,
            errors: errors,
            context: context
        };
    };
    /**
     * 构造viewChanges上下文
     * @param propertyName
     * @param value
     * @param preValue
     * @param errors
     * @param context
     * @param type
     * @returns
     */
    BaseBindingObject.prototype.buildViewChangesContext = function (propertyName, value, preValue, errors, context, type) {
        if (type === void 0) { type = ViewChangeType.ValueChanged; }
        return {
            type: type,
            path: [propertyName],
            value: value,
            preValue: preValue,
            errors: errors,
            context: context
        };
    };
    BaseBindingObject.prototype.getRow = function (bindingObject) {
        if (bindingObject && bindingObject.fromEntity) {
            return bindingObject;
        }
        if (bindingObject.parent && !(bindingObject.parent instanceof BindingList)) {
            return this.getRow(bindingObject.parent);
        }
        else {
            return bindingObject;
        }
    };
    BaseBindingObject.prototype.makeHash = function () {
        var text = "";
        var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        for (var i = 0; i < 10; i++)
            text += possible.charAt(Math.floor(Math.random() * possible.length));
        return text;
    };
    BaseBindingObject.prototype.differ = function () {
        var _this = this;
        var previous, next, value;
        return {
            onValueChange: function () {
                next = _this.makeHash();
            },
            isChange: function () {
                return next !== previous;
            },
            update: function (result) {
                value = result;
                previous = next;
            },
            value: function () {
                return value;
            }
        };
    };
    return BaseBindingObject;
}());
export { BaseBindingObject };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZV9iaW5kaW5nX29iamVjdC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2JpbmRpbmctZGF0YS9iYXNlX2JpbmRpbmdfb2JqZWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ25DLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDaEMsT0FBTyxFQUFVLFVBQVUsRUFBYyxjQUFjLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDM0UsT0FBTyxFQUFtQixtQkFBbUIsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUc3Qzs7R0FFRztBQUNIO0lBaUVFLHNDQUFzQztJQUN0QztRQWpFTyxhQUFRLEdBQUcsZUFBZSxDQUFDO1FBZ0RsQzs7V0FFRztRQUNJLGVBQVUsR0FBWSxTQUFTLENBQUM7UUFDdkM7O1dBRUc7UUFDSSx3QkFBbUIsR0FBRyxLQUFLLENBQUM7UUFDbkM7O1dBRUc7UUFDSSxnQkFBVyxHQUFpQixJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ2pEOztXQUVHO1FBQ0ksZUFBVSxHQUFRLEVBQUUsQ0FBQztRQUcxQixJQUFJLENBQUMsV0FBVyxHQUFHLEdBQUcsRUFBZSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxPQUFPLEVBQVUsQ0FBQztRQUNyQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksT0FBTyxFQUFjLENBQUM7SUFDL0MsQ0FBQztJQS9CRCxzQkFBVyw4Q0FBZTtRQUgxQjs7V0FFRzthQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FB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RTtZQUN6QixJQUFJLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUN2RSxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFDTyxrQ0FBTSxHQUFkO1FBQUEsaUJBaUJDO1FBaEJDLElBQUksUUFBUSxFQUFFLElBQUksRUFBRSxLQUFLLENBQUM7UUFDMUIsT0FBTztZQUNMLGFBQWEsRUFBRTtnQkFDYixJQUFJLEdBQUcsS0FBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ3pCLENBQUM7WUFDRCxRQUFRLEVBQUU7Z0JBQ1IsT0FBTyxJQUFJLEtBQUssUUFBUSxDQUFDO1lBQzNCLENBQUM7WUFDRCxNQUFNLEVBQUUsVUFBQyxNQUFNO2dCQUNiLEtBQUssR0FBRyxNQUFNLENBQUM7Z0JBQ2YsUUFBUSxHQUFHLElBQUksQ0FBQztZQUNsQixDQUFDO1lBQ0QsS0FBSyxFQUFFO2dCQUNMLE9BQU8sS0FBSyxDQUFDO1lBQ2YsQ0FBQztTQUNGLENBQUM7SUFDSixDQUFDO0lBQ0gsd0JBQUM7QUFBRCxDQUFDLEFBclNELElBcVNDO0FBQ0QsT0FBTyxFQUFFLGlCQUFpQixFQUFFLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJqZWN0LCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBNYXAgfSBmcm9tICdpbW11dGFibGUnO1xyXG5pbXBvcnQgeyBDaGFuZ2UsIENoYW5nZVR5cGUsIFZpZXdDaGFuZ2UsIFZpZXdDaGFuZ2VUeXBlIH0gZnJvbSAnLi9jaGFuZ2VzJztcclxuaW1wb3J0IHsgQmluZGluZ1Byb3BlcnR5LCBCaW5kaW5nUHJvcGVydHlUeXBlIH0gZnJvbSAnLi9iaW5kaW5nX3Byb3BlcnR5JztcclxuaW1wb3J0IHsgQmluZGluZ0xpc3QgfSBmcm9tICcuL2JpbmRpbmdfbGlzdCc7XHJcbmltcG9ydCB7IEludm9rZU9uVmFsdWVDaGFuZ2UgfSBmcm9tICcuL3R5cGVzJztcclxuXHJcbi8qKlxyXG4gKiDnu5Hlrprlr7nosaHln7rnsbtcclxuICovXHJcbmFic3RyYWN0IGNsYXNzIEJhc2VCaW5kaW5nT2JqZWN0IHtcclxuICBwdWJsaWMgX190eXBlX18gPSAnQmluZGluZ09iamVjdCc7XHJcbiAgLy8gcHJvdGVjdGVkIGRhdGE6IGFueSA9IHVuZGVmaW5lZDtcclxuICAvKipcclxuICAgKiBpbW11dGFibGXlgLzlr7nosaFcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgaW5uZXJWYWx1ZXM6IE1hcDxzdHJpbmcsIGFueT47XHJcbiAgLyoqXHJcbiAgICog5b2T5YmN6K+t6KiAXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGN1cnJlbnRMYW5ndWFnZTogc3RyaW5nO1xyXG4gIC8qKlxyXG4gICAqIOeItuWvueixoeaIlueItuWIl+ihqFxyXG4gICAqL1xyXG4gIHB1YmxpYyBwYXJlbnQ6IEJpbmRpbmdMaXN0IHwgQmFzZUJpbmRpbmdPYmplY3Q7XHJcblxyXG4gIC8qKlxyXG4gICAqIOWunuS9k+W8lei1t+eahOWPmOabtFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjaGFuZ2VzOiBTdWJqZWN0PENoYW5nZT47XHJcblxyXG4gIC8qKlxyXG4gICAqIOeVjOmdouWxguW8lei1t+eahOWPmOabtOa1gVxyXG4gICAqL1xyXG4gIHB1YmxpYyB2aWV3Q2hhbmdlczogU3ViamVjdDxWaWV3Q2hhbmdlPjtcclxuXHJcbiAgLyoqXHJcbiAgICogIOWxnuaAp+mbhuWQiFxyXG4gICAqL1xyXG4gIHB1YmxpYyBwcm9wZXJ0aWVzOiBCaW5kaW5nUHJvcGVydHlbXTtcclxuXHJcbiAgLyoqXHJcbiAgICog5Li76ZSu5ZCNXHJcbiAgICovXHJcbiAgcHVibGljIHByaW1hcnlLZXk6IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICog5Li76ZSu5YC8XHJcbiAgICovXHJcbiAgcHVibGljIGdldCBwcmltYXJ5S2V5VmFsdWUoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5wcmltYXJ5S2V5ID8gdGhpcy5nZXRWYWx1ZSh0aGlzLnByaW1hcnlLZXkpIDogJyc7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaVsOaNruihjOeahOS4u+mUruWAvFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQgcm93UHJpbWFyeUtleVZhbHVlKCkge1xyXG4gICAgY29uc3Qgcm93ID0gdGhpcy5nZXRSb3codGhpcyk7XHJcbiAgICByZXR1cm4gcm93ICYmIHJvdy5wcmltYXJ5S2V5VmFsdWUgfHwgbnVsbDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog57uR5a6a5Yiw5a6e5L2TXHJcbiAgICovXHJcbiAgcHVibGljIGZyb21FbnRpdHk6IGJvb2xlYW4gPSB1bmRlZmluZWQ7XHJcbiAgLyoqXHJcbiAgICog5qCH6K+G5piv5ZCm5o+Q5Lqk6L+HXHJcbiAgICovXHJcbiAgcHVibGljIGlzU2hvd1ZhbGlkYXRpb25Nc2cgPSBmYWxzZTtcclxuICAvKipcclxuICAgKiDplIDmr4HmtYFcclxuICAgKi9cclxuICBwdWJsaWMgdW5zdWJzY3JpYmU6IFN1YmplY3Q8YW55PiA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgLyoqXHJcbiAgICog5LuleyBbcHJvcGVydHlOYW1lXTogRm9ybUNvbnRyb2wgfeeahOW9ouW8j+WtmOaUvuavj+adoeaVsOaNrueahGNvbnRyb2xcclxuICAgKi9cclxuICBwdWJsaWMgY29udHJvbE1hcDogYW55ID0ge307XHJcbiAgLy8gcHJpdmF0ZSBfX2RpZmZlcl9fID0gdGhpcy5kaWZmZXIoKTtcclxuICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIHRoaXMuaW5uZXJWYWx1ZXMgPSBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcbiAgICB0aGlzLmNoYW5nZXMgPSBuZXcgU3ViamVjdDxDaGFuZ2U+KCk7XHJcbiAgICB0aGlzLnZpZXdDaGFuZ2VzID0gbmV3IFN1YmplY3Q8Vmlld0NoYW5nZT4oKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6K6+572u5piv5ZCm5o+Q5Lqk6L+HXHJcbiAgICovXHJcbiAgcHVibGljIHNldFNob3dWYWxpZGF0aW9uTXNnKGZsYWc6IGJvb2xlYW4pIHtcclxuICAgIHRoaXMuaXNTaG93VmFsaWRhdGlvbk1zZyA9IGZsYWc7XHJcbiAgfVxyXG4gIC8vIHB1YmxpYyBhYnN0cmFjdCBsb2FkKGRhdGE6IGFueSk7XHJcbiAgLyoqXHJcbiAgICog5qC55o2u5bGe5oCn5ZCN6I635Y+W5bGe5oCn5YC8XHJcbiAgICogQHBhcmFtICAgcHJvcGVydHlOYW1lIOWxnuaAp+WQjVxyXG4gICAqIEByZXR1cm5zIOWxnuaAp+WAvFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRWYWx1ZShwcm9wZXJ0eU5hbWU6IHN0cmluZyk6IGFueSB7XHJcbiAgICByZXR1cm4gdGhpcy5pbm5lclZhbHVlcy5nZXQocHJvcGVydHlOYW1lKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuvue9ruWxnuaAp+WAvFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eU5hbWUgICAgICAgIOWxnuaAp+WQjVxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eVZhbHVlICAgICAgIOWxnuaAp+WAvFxyXG4gICAqIEBwYXJhbSBlbWl0RXZlbnRUb1ZpZXcgICAgIOaYr+WQpumAmuefpVZpZXflsYLljrvmm7TmlrDnlYzpnaLvvIzpu5jorqTkuLpmYWxzZVxyXG4gICAqIEBwYXJhbSBlbWl0RXZlbnRUb0VudGl0eSAgIOaYr+WQpumAmuefpUVudGl0eeWxguWOu+abtOaWsOWAvO+8jOm7mOiupOS4umZhbHNlXHJcbiAgICogQHBhcmFtIGVycm9ycyAgICAgICAgICAgICAg6ZSZ6K+v5raI5oGvXHJcbiAgICogQHBhcmFtIGludm9rZU9uVmFsdWVDaGFuZ2Ug5YC85Y+Y5YyW5LqL5Lu25omn6KGM5Y+l5p+EXHJcbiAgICovXHJcbiAgcHVibGljIHNldFZhbHVlKHByb3BlcnR5TmFtZTogc3RyaW5nLCBwcm9wZXJ0eVZhbHVlOiBhbnksIGVtaXRFdmVudFRvVmlldzogYm9vbGVhbiA9IGZhbHNlLCBlbWl0RXZlbnRUb0VudGl0eTogYm9vbGVhbiA9IGZhbHNlLCBlcnJvcnM/OiBhbnksIGludm9rZU9uVmFsdWVDaGFuZ2U/OiBJbnZva2VPblZhbHVlQ2hhbmdlLCBjb250ZXh0PzogYW55KTogdm9pZCB7XHJcbiAgICAvLyDlsY/olL3mjonml6DmlYjnmoTotYvlgLzvvIzpmLLmraLlkI7nu63otYvlgLzlr7nmr5Tml7bot7Pov4fvvIzlr7zoh7Tlrp7kvZPml6Dms5XotYvlgLxcclxuICAgIC8vIGlmICh0aGlzLnByaW1hcnlLZXkgJiYgIXRoaXMucHJpbWFyeUtleVZhbHVlICYmIHRoaXMucHJpbWFyeUtleSAhPT0gcHJvcGVydHlOYW1lKSB7XHJcbiAgICAvLyAgIHJldHVybjtcclxuICAgIC8vIH1cclxuICAgIGNvbnN0IG9sZFByb3BlcnR5VmFsdWUgPSB0aGlzLmdldFZhbHVlKHByb3BlcnR5TmFtZSk7XHJcbiAgICAvLyDnlLHkuo7nibnlrprljp/lm6DvvIhA6YK154+g5by677yJ77yM5peg5rOV5bGP6JS9b2xkUHJvcGVydHlWYWx1ZSA9PT0gcHJvcGVydHlWYWx1ZVxyXG4gICAgLy8gaWYgKG9sZFByb3BlcnR5VmFsdWUgPT09IHByb3BlcnR5VmFsdWUpIHtcclxuICAgIC8vICAgcmV0dXJuO1xyXG4gICAgLy8gfVxyXG4gICAgaWYgKCFpbnZva2VPblZhbHVlQ2hhbmdlIHx8IG9sZFByb3BlcnR5VmFsdWUgPT09IHByb3BlcnR5VmFsdWUpIHtcclxuICAgICAgLy8g6K6+5a6a57y655yBXHJcbiAgICAgIGludm9rZU9uVmFsdWVDaGFuZ2UgPSBmdW5jdGlvbiAocHJlVmFsdWUsIHZhbHVlLCBlbnRpdHlDaGFuZ2VkOiBib29sZWFuLCBwcmltYXJ5VmFsdWU/OiBhbnkpIHtcclxuICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgICBpZiAoZW1pdEV2ZW50VG9FbnRpdHkgPT09IHRydWUpIHtcclxuICAgICAgLy8gQlVHIDMyMjMwMe+8jOWIoOmZpEAyMDE5LjA4LjEwOyDlpoLmnpzml6Dlr7nlupTlrp7kvZPvvIzliJnkuK3mraLlgLzkvKDpgJI7IOi/meenjeaDheWGteWPkeeUn+WcqOW4puS7juihqOeahOWNleaNruaWsOWinu+8jOS7juihqOWTjeW6lExvYWTlj5jljJbnmoTmg4XlhrXvvJtcclxuICAgICAgLy8gaWYoIXRoaXMuaW5uZXJWYWx1ZXMuaGFzKHByb3BlcnR5TmFtZSkpIHtcclxuICAgICAgLy8gICByZXR1cm47XHJcbiAgICAgIC8vIH1cclxuICAgICAgLy8g5omn6KGM5a6e5L2T5YC85Y+Y5YyW5YmN5LqL5Lu2XHJcbiAgICAgIGludm9rZU9uVmFsdWVDaGFuZ2Uob2xkUHJvcGVydHlWYWx1ZSwgcHJvcGVydHlWYWx1ZSwgZmFsc2UsIHRoaXMucm93UHJpbWFyeUtleVZhbHVlKS5zdWJzY3JpYmUoKHJlc3VsdCkgPT4ge1xyXG4gICAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICAgIC8vdGhpcy5fX2RpZmZlcl9fLm9uVmFsdWVDaGFuZ2UoKTtcclxuICAgICAgICAgIC8vIOWmguaenOaIkOWKn++8jOaJp+ihjOWPmOWMlu+8jOW5tumAmuefpeWunuS9k+WPmOWMllxyXG4gICAgICAgICAgdGhpcy5pbm5lclZhbHVlcyA9IHRoaXMuaW5uZXJWYWx1ZXMuc2V0KHByb3BlcnR5TmFtZSwgcHJvcGVydHlWYWx1ZSk7XHJcbiAgICAgICAgICAvLyB0aGlzLmRhdGFbcHJvcGVydHlOYW1lXSA9IHByb3BlcnR5VmFsdWU7XHJcbiAgICAgICAgICBjb25zdCB2aWV3Q2hhbmdlID0gdGhpcy5idWlsZFZpZXdDaGFuZ2VzQ29udGV4dChwcm9wZXJ0eU5hbWUsIHByb3BlcnR5VmFsdWUsIG9sZFByb3BlcnR5VmFsdWUsIGVycm9ycywgY29udGV4dCk7XHJcbiAgICAgICAgICB0aGlzLnZpZXdDaGFuZ2VzLm5leHQodmlld0NoYW5nZSk7XHJcbiAgICAgICAgICAvLyDlpoLmnpzpnIDopoHpgJrnn6Xop4blm77vvIzpgJrnn6Xop4blm77nm7jlupTkv67mlLlcclxuICAgICAgICAgIGlmIChlbWl0RXZlbnRUb1ZpZXcgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgY29uc3QgY2hhbmdlID0gdGhpcy5idWlsZENoYW5nZXNDb250ZXh0KHByb3BlcnR5TmFtZSwgcHJvcGVydHlWYWx1ZSwgY29udGV4dCwgZXJyb3JzKTtcclxuICAgICAgICAgICAgdGhpcy5jaGFuZ2VzLm5leHQoY2hhbmdlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIC8vIOaJp+ihjOWunuS9k+WAvOWPmOWMluWQjuS6i+S7tlxyXG4gICAgICAgICAgaW52b2tlT25WYWx1ZUNoYW5nZShvbGRQcm9wZXJ0eVZhbHVlLCBwcm9wZXJ0eVZhbHVlLCB0cnVlLCB0aGlzLnJvd1ByaW1hcnlLZXlWYWx1ZSkuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIC8vIOWmguaenOWksei0pe+8jOS4jeWGjemAmuefpeWunuS9k+WPmOWMllxyXG4gICAgICAgICAgLy8g5bm25omn6KGM55WM6Z2i5Zue5rua5pON5L2cXHJcbiAgICAgICAgICBjb25zdCBjaGFuZ2UgPSB0aGlzLmJ1aWxkQ2hhbmdlc0NvbnRleHQocHJvcGVydHlOYW1lLCBvbGRQcm9wZXJ0eVZhbHVlLCBjb250ZXh0LCBlcnJvcnMpO1xyXG4gICAgICAgICAgdGhpcy5jaGFuZ2VzLm5leHQoY2hhbmdlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy90aGlzLl9fZGlmZmVyX18ub25WYWx1ZUNoYW5nZSgpO1xyXG4gICAgICAvLyBgZW1pdEV2ZW50VG9FbnRpdHkgPT09IGZhbHNlYCwg5YiZ6K6k5a6a5a6e5L2T5YC85bey57uP5Y+R55Sf5Y+Y5YyW77yM6YCa55+l6KeG5Zu+5Y+Y5YyW77yM5bm26Kem5Y+R5a6e5L2T5YC85Y+Y5YyW5ZCO5LqL5Lu2XHJcbiAgICAgIHRoaXMuaW5uZXJWYWx1ZXMgPSB0aGlzLmlubmVyVmFsdWVzLnNldChwcm9wZXJ0eU5hbWUsIHByb3BlcnR5VmFsdWUpO1xyXG4gICAgICAvLyB0aGlzLmRhdGFbcHJvcGVydHlOYW1lXSA9IHByb3BlcnR5VmFsdWU7XHJcbiAgICAgIGlmIChlbWl0RXZlbnRUb1ZpZXcgPT09IHRydWUpIHtcclxuICAgICAgICBjb25zdCBjaGFuZ2UgPSB0aGlzLmJ1aWxkQ2hhbmdlc0NvbnRleHQocHJvcGVydHlOYW1lLCBwcm9wZXJ0eVZhbHVlLCBjb250ZXh0LCBlcnJvcnMpO1xyXG4gICAgICAgIHRoaXMuY2hhbmdlcy5uZXh0KGNoYW5nZSk7XHJcbiAgICAgIH1cclxuICAgICAgLy8g5omn6KGM5a6e5L2T5YC85Y+Y5YyW5ZCO5LqL5Lu2XHJcbiAgICAgIGludm9rZU9uVmFsdWVDaGFuZ2Uob2xkUHJvcGVydHlWYWx1ZSwgcHJvcGVydHlWYWx1ZSwgdHJ1ZSwgdGhpcy5yb3dQcmltYXJ5S2V5VmFsdWUpLnN1YnNjcmliZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDlsIZCaW5kaW5nT2JqZWN05a6e5L6L6L2s5o2i5oiQSlNPTuWvueixoVxyXG4gICAqL1xyXG4gIHB1YmxpYyB0b0pTT04ob3B0aW9ucz86IGFueSk6IGFueSB7XHJcbiAgICAvL2lmICghdGhpcy5fX2RpZmZlcl9fLmlzQ2hhbmdlKCkpIHtcclxuICAgIC8vICByZXR1cm4gdGhpcy5fX2RpZmZlcl9fLnZhbHVlKCk7XHJcbiAgICAvL31cclxuICAgIGNvbnN0IGxhbmdDb2RlID0gdGhpcy5nZXRDdXJyZW50TGFuZ3VhZ2UoKTsvL3dpbmRvdy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnbGFuZ3VhZ2VDb2RlJykgfHwgJ3poLUNIUyc7XHJcbiAgICBjb25zdCByZXN1bHQgPSB7fTtcclxuICAgIHRoaXMucHJvcGVydGllcy5mb3JFYWNoKChwcm9wZXJ0eTogQmluZGluZ1Byb3BlcnR5KSA9PiB7XHJcbiAgICAgIGNvbnN0IHByb3BOYW1lID0gcHJvcGVydHkubmFtZTtcclxuICAgICAgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuTGlzdCkge1xyXG4gICAgICAgIGNvbnN0IGxpc3Q6IEJpbmRpbmdMaXN0ID0gdGhpc1twcm9wTmFtZV07XHJcbiAgICAgICAgcmVzdWx0W3Byb3BOYW1lXSA9IGxpc3QudG9KU09OKG9wdGlvbnMpO1xyXG4gICAgICB9IGVsc2UgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuT2JqZWN0KSB7XHJcbiAgICAgICAgY29uc3Qgb2JqZWN0OiBCYXNlQmluZGluZ09iamVjdCA9IHRoaXNbcHJvcE5hbWVdO1xyXG4gICAgICAgIHJlc3VsdFtwcm9wTmFtZV0gPSBvYmplY3QudG9KU09OKG9wdGlvbnMpO1xyXG4gICAgICB9IGVsc2UgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuRHluYW1pYykge1xyXG4gICAgICAgIGNvbnN0IG9iamVjdDogQmFzZUJpbmRpbmdPYmplY3QgPSB0aGlzW3Byb3BOYW1lXTtcclxuICAgICAgICByZXN1bHRbcHJvcE5hbWVdID0gb2JqZWN0LnRvSlNPTihvcHRpb25zKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyAx44CB5a+55LqO5aSa6K+t5b2V5YWl5a2X5q6177ybXHJcbiAgICAgICAgLy8gMuOAgeS8oOWFpWlnbm9yZU11bHRpTGFuZ0lucHV05qCH5b+X77yM5YiZ5Y+W5b2T5YmN6K+t6KiA55qE5YC857uZ5o6n5Lu244CCXHJcbiAgICAgICAgaWYgKHByb3BlcnR5LmVuYWJsZU11bHRpTGFuZ0lucHV0ID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAvLyDlv73nlaXlpJror63lrZfmrrXvvIzlj6rov5Tlm57lvZPliY3or63oqIBcclxuICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuaWdub3JlTXVsdGlMYW5nSW5wdXQgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgY29uc3QgbXVsdGlMYW5nVmFsdWVPYmogPSB0aGlzLmdldFZhbHVlKHByb3BOYW1lKTtcclxuICAgICAgICAgICAgaWYgKG11bHRpTGFuZ1ZhbHVlT2JqKSB7XHJcbiAgICAgICAgICAgICAgcmVzdWx0W3Byb3BOYW1lXSA9IG11bHRpTGFuZ1ZhbHVlT2JqW2xhbmdDb2RlXTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICByZXN1bHRbcHJvcE5hbWVdID0gbXVsdGlMYW5nVmFsdWVPYmo7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnVzZUZ1bGxNdWx0aUxhbmdQcm9wZXJ0eSkge1xyXG4gICAgICAgICAgICAvLyDnu5nlrqHmibnmj5DkvpvnmoTmianlsZUgQDIwMjEtMTAtMTNcclxuICAgICAgICAgICAgY29uc3QgbXVsdGlMYW5nVmFsdWVPYmogPSB0aGlzLmdldFZhbHVlKHByb3BOYW1lKTtcclxuICAgICAgICAgICAgaWYgKG11bHRpTGFuZ1ZhbHVlT2JqKSB7XHJcbiAgICAgICAgICAgICAgcmVzdWx0W2Ake3Byb3BOYW1lfV9NVUxUSUxBTkdVQUdFYF0gPSBtdWx0aUxhbmdWYWx1ZU9iajtcclxuICAgICAgICAgICAgICAvLyDpmaTov5Tlm57lpJror63lrZfmrrXlpJbvvIzlsIblvZPliY3or63oqIDkuZ/ov5Tlm55cclxuICAgICAgICAgICAgICByZXN1bHRbcHJvcE5hbWVdID0gbXVsdGlMYW5nVmFsdWVPYmpbbGFuZ0NvZGVdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBtdWx0aUxhbmdWYWx1ZU9iaiA9IHRoaXMuZ2V0VmFsdWUocHJvcE5hbWUpO1xyXG4gICAgICAgICAgICBpZiAoIW11bHRpTGFuZ1ZhbHVlT2JqKSB7XHJcbiAgICAgICAgICAgICAgcmVzdWx0W3Byb3BOYW1lXSA9IHsgW2xhbmdDb2RlXTogbXVsdGlMYW5nVmFsdWVPYmogfTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICByZXN1bHRbcHJvcE5hbWVdID0gbXVsdGlMYW5nVmFsdWVPYmo7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmVzdWx0W3Byb3BOYW1lXSA9IHRoaXMuZ2V0VmFsdWUocHJvcE5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICAvLyB0aGlzLl9fZGlmZmVyX18udXBkYXRlKHJlc3VsdCk7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5blvZPliY3or63oqIBcclxuICAgKiBAcmV0dXJuc1xyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBnZXRDdXJyZW50TGFuZ3VhZ2UoKSB7XHJcbiAgICB0aGlzLmN1cnJlbnRMYW5ndWFnZSA9IHRoaXMuY3VycmVudExhbmd1YWdlIHx8IHdpbmRvdy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnbGFuZ3VhZ2VDb2RlJykgfHwgJ3poLUNIUyc7XHJcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50TGFuZ3VhZ2U7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaehOmAoGJpbmRpZ25EYXRh5Y+Y5pu05LiK5LiL5paHXHJcbiAgICogQHBhcmFtIHByb3BlcnR5TmFtZVxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eVZhbHVlXHJcbiAgICogQHBhcmFtIGNvbnRleHRcclxuICAgKiBAcGFyYW0gZXJyb3JzXHJcbiAgICogQHBhcmFtIHR5cGVcclxuICAgKiBAcmV0dXJuc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGRDaGFuZ2VzQ29udGV4dChwcm9wZXJ0eU5hbWU6IHN0cmluZywgcHJvcGVydHlWYWx1ZTogYW55LCBjb250ZXh0PzogYW55LCBlcnJvcnM/OiBhbnksIHR5cGU6IENoYW5nZVR5cGUgPSBDaGFuZ2VUeXBlLlZhbHVlQ2hhbmdlZCk6IENoYW5nZSB7XHJcbiAgICBjb25zdCBvYmplY3QgPSB0aGlzLmdldFJvdyh0aGlzKTtcclxuICAgIGNvbnN0IGlkID0gb2JqZWN0ID8gb2JqZWN0LnByaW1hcnlLZXlWYWx1ZSA6IG51bGw7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICB0eXBlOiB0eXBlLFxyXG4gICAgICBwYXRoOiBbcHJvcGVydHlOYW1lXSxcclxuICAgICAgdmFsdWU6IHByb3BlcnR5VmFsdWUsXHJcbiAgICAgIGlkOiBpZCxcclxuICAgICAgZXJyb3JzOiBlcnJvcnMsXHJcbiAgICAgIGNvbnRleHRcclxuICAgIH07XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaehOmAoHZpZXdDaGFuZ2Vz5LiK5LiL5paHXHJcbiAgICogQHBhcmFtIHByb3BlcnR5TmFtZVxyXG4gICAqIEBwYXJhbSB2YWx1ZVxyXG4gICAqIEBwYXJhbSBwcmVWYWx1ZVxyXG4gICAqIEBwYXJhbSBlcnJvcnNcclxuICAgKiBAcGFyYW0gY29udGV4dFxyXG4gICAqIEBwYXJhbSB0eXBlXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkVmlld0NoYW5nZXNDb250ZXh0KHByb3BlcnR5TmFtZTogc3RyaW5nLCB2YWx1ZTogYW55LCBwcmVWYWx1ZTogYW55LCBlcnJvcnM/OiBhbnksIGNvbnRleHQ/OiBhbnksIHR5cGU6IFZpZXdDaGFuZ2VUeXBlID0gVmlld0NoYW5nZVR5cGUuVmFsdWVDaGFuZ2VkKTogVmlld0NoYW5nZSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICB0eXBlOiB0eXBlLFxyXG4gICAgICBwYXRoOiBbcHJvcGVydHlOYW1lXSxcclxuICAgICAgdmFsdWU6IHZhbHVlLFxyXG4gICAgICBwcmVWYWx1ZTogcHJlVmFsdWUsXHJcbiAgICAgIGVycm9yczogZXJyb3JzLFxyXG4gICAgICBjb250ZXh0XHJcbiAgICB9O1xyXG4gIH1cclxuICBwcml2YXRlIGdldFJvdyhiaW5kaW5nT2JqZWN0OiBCYXNlQmluZGluZ09iamVjdCk6IEJhc2VCaW5kaW5nT2JqZWN0IHtcclxuICAgIGlmIChiaW5kaW5nT2JqZWN0ICYmIGJpbmRpbmdPYmplY3QuZnJvbUVudGl0eSkge1xyXG4gICAgICByZXR1cm4gYmluZGluZ09iamVjdDtcclxuICAgIH1cclxuICAgIGlmIChiaW5kaW5nT2JqZWN0LnBhcmVudCAmJiAhKGJpbmRpbmdPYmplY3QucGFyZW50IGluc3RhbmNlb2YgQmluZGluZ0xpc3QpKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmdldFJvdyhiaW5kaW5nT2JqZWN0LnBhcmVudCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gYmluZGluZ09iamVjdDtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBtYWtlSGFzaCgpIHtcclxuICAgIHZhciB0ZXh0ID0gXCJcIjtcclxuICAgIHZhciBwb3NzaWJsZSA9IFwiQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODlcIjtcclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMTA7IGkrKylcclxuICAgICAgdGV4dCArPSBwb3NzaWJsZS5jaGFyQXQoTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogcG9zc2libGUubGVuZ3RoKSk7XHJcbiAgICByZXR1cm4gdGV4dDtcclxuICB9XHJcbiAgcHJpdmF0ZSBkaWZmZXIoKSB7XHJcbiAgICBsZXQgcHJldmlvdXMsIG5leHQsIHZhbHVlO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgb25WYWx1ZUNoYW5nZTogKCkgPT4ge1xyXG4gICAgICAgIG5leHQgPSB0aGlzLm1ha2VIYXNoKCk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGlzQ2hhbmdlOiAoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIG5leHQgIT09IHByZXZpb3VzO1xyXG4gICAgICB9LFxyXG4gICAgICB1cGRhdGU6IChyZXN1bHQpID0+IHtcclxuICAgICAgICB2YWx1ZSA9IHJlc3VsdDtcclxuICAgICAgICBwcmV2aW91cyA9IG5leHQ7XHJcbiAgICAgIH0sXHJcbiAgICAgIHZhbHVlOiAoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gIH1cclxufVxyXG5leHBvcnQgeyBCYXNlQmluZGluZ09iamVjdCB9XHJcbiJdfQ==