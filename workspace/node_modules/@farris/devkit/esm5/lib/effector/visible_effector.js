import { Inject, Injectable, Injector } from '@angular/core';
import { FrameContext, NAMESPACE } from '../frame/index';
import { Repository } from '../repository/index';
import { ExpressionUtil } from '../utils/expression_util';
var VisibleEffector = /** @class */ (function () {
    function VisibleEffector(injector, namespace, frameContext, repository) {
        this.injector = injector;
        this.namespace = namespace;
        this.frameContext = frameContext;
        this.repository = repository;
        this.ns = namespace;
    }
    VisibleEffector.prototype.effect = function (path, value, options) {
        // 由匿名函数接管，ignore
        var paths = path.split('/').filter(function (p) { return p; });
        var bindingPaths = this.getTablePaths(paths);
        var bindingPath = bindingPaths.join('/');
        // 主表显隐无需处理
        if (bindingPaths && bindingPaths.length > 0) {
            var isGridComponent = this.isGridComponent(bindingPath);
            if (isGridComponent) {
                var datagridComponent = this.getDatagridComponent(bindingPath);
                if (datagridComponent) {
                    // 更新列信息
                    // datagridComponent.columnsChanged();
                    var fieldPaths = this.getPropertyPaths(paths);
                    if (fieldPaths) {
                        var field = fieldPaths.join('.');
                        if (value) {
                            datagridComponent.showColumn(field, false);
                        }
                        else {
                            datagridComponent.hideColumn(field, false);
                        }
                    }
                }
            }
        }
        else {
            var datagridComponent = this.getDatagridComponent(bindingPath);
            if (datagridComponent) {
                datagridComponent.columnsChanged(false);
            }
        }
    };
    VisibleEffector.prototype.getTablePaths = function (paths) {
        var entityPaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(paths, this.repository.entityTypeInfo);
        return entityPaths;
    };
    VisibleEffector.prototype.getDatagridComponent = function (bindingPath) {
        var _this = this;
        var frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace) || [];
        var matchedFrameContexts = frameContexts.filter(function (frameContext) { return frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; }).toString() === bindingPath.split('/').filter(function (p) { return p; }).toString(); });
        var result = null;
        if (matchedFrameContexts) {
            matchedFrameContexts.every(function (frameContext) {
                var frameId = frameContext.frameId;
                var componentsMap = _this.frameContext.appContext.componentManager.getComponentsByFrameId(frameId);
                if (!componentsMap) {
                    return true;
                }
                var datagridComponent = Array.from(componentsMap.values()).find(function (component) { return component && component['__component_type__'] === 'DatagridComponent'; });
                if (datagridComponent) {
                    result = datagridComponent;
                    return false;
                }
                else {
                    return true;
                }
            });
        }
        return result;
    };
    VisibleEffector.prototype.getPropertyPaths = function (paths) {
        var tablePaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(paths, this.repository.entityTypeInfo);
        return paths.slice(tablePaths.length);
    };
    VisibleEffector.prototype.isGridComponent = function (bindingPath) {
        var frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace) || [];
        var frameContext = frameContexts.find(function (frameContext) { return frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; }).toString() === bindingPath.split('/').filter(function (p) { return p; }).toString(); });
        if (frameContext) {
            return !!frameContext.viewModel['dataGridColumnsName'];
        }
        else {
            return false;
        }
    };
    VisibleEffector.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    VisibleEffector.ctorParameters = function () { return [
        { type: Injector },
        { type: undefined, decorators: [{ type: Inject, args: [NAMESPACE,] }] },
        { type: FrameContext },
        { type: Repository }
    ]; };
    return VisibleEffector;
}());
export { VisibleEffector };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlzaWJsZV9lZmZlY3Rvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2VmZmVjdG9yL3Zpc2libGVfZWZmZWN0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTdELE9BQU8sRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUUxRDtJQUdFLHlCQUNVLFFBQWtCLEVBQ0MsU0FBUyxFQUM1QixZQUEwQixFQUMxQixVQUEyQjtRQUgzQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ0MsY0FBUyxHQUFULFNBQVMsQ0FBQTtRQUM1QixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUNuQyxJQUFJLENBQUMsRUFBRSxHQUFHLFNBQVMsQ0FBQztJQUN0QixDQUFDO0lBQ00sZ0NBQU0sR0FBYixVQUFjLElBQVksRUFBRSxLQUFVLEVBQUUsT0FBaUM7UUFDdkUsaUJBQWlCO1FBQ2pCLElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFELENBQUMsQ0FBQyxDQUFDO1FBQzdDLElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDL0MsSUFBTSxXQUFXLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMzQyxXQUFXO1FBQ1gsSUFBSSxZQUFZLElBQUksWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7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UUFBUTtnREFXaEMsTUFBTSxTQUFDLFNBQVM7Z0JBVFosWUFBWTtnQkFDWixVQUFVOztJQW1GbkIsc0JBQUM7Q0FBQSxBQWhGRCxJQWdGQztTQS9FWSxlQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBFeHByZXNzaW9uIH0gZnJvbSAnLi4vZXhwcmVzc2lvbi9pbmRleCc7XHJcbmltcG9ydCB7IEZyYW1lQ29udGV4dCwgTkFNRVNQQUNFIH0gZnJvbSAnLi4vZnJhbWUvaW5kZXgnO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAnLi4vcmVwb3NpdG9yeS9pbmRleCc7XHJcbmltcG9ydCB7IEV4cHJlc3Npb25VdGlsIH0gZnJvbSAnLi4vdXRpbHMvZXhwcmVzc2lvbl91dGlsJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFZpc2libGVFZmZlY3RvciBpbXBsZW1lbnRzIEV4cHJlc3Npb24uRWZmZWN0b3Ige1xyXG4gIHB1YmxpYyBuczogc3RyaW5nO1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXHJcbiAgICBASW5qZWN0KE5BTUVTUEFDRSkgcHJpdmF0ZSBuYW1lc3BhY2UsXHJcbiAgICBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LFxyXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4pIHtcclxuICAgIHRoaXMubnMgPSBuYW1lc3BhY2U7XHJcbiAgfVxyXG4gIHB1YmxpYyBlZmZlY3QocGF0aDogc3RyaW5nLCB2YWx1ZTogYW55LCBvcHRpb25zOiBFeHByZXNzaW9uLkVmZmVjdE9wdGlvbnMpIHtcclxuICAgIC8vIOeUseWMv+WQjeWHveaVsOaOpeeuoe+8jGlnbm9yZVxyXG4gICAgY29uc3QgcGF0aHMgPSBwYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSB0aGlzLmdldFRhYmxlUGF0aHMocGF0aHMpO1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGggPSBiaW5kaW5nUGF0aHMuam9pbignLycpO1xyXG4gICAgLy8g5Li76KGo5pi+6ZqQ5peg6ZyA5aSE55CGXHJcbiAgICBpZiAoYmluZGluZ1BhdGhzICYmIGJpbmRpbmdQYXRocy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGNvbnN0IGlzR3JpZENvbXBvbmVudCA9IHRoaXMuaXNHcmlkQ29tcG9uZW50KGJpbmRpbmdQYXRoKTtcclxuICAgICAgaWYgKGlzR3JpZENvbXBvbmVudCkge1xyXG4gICAgICAgIGNvbnN0IGRhdGFncmlkQ29tcG9uZW50ID0gdGhpcy5nZXREYXRhZ3JpZENvbXBvbmVudChiaW5kaW5nUGF0aCk7XHJcbiAgICAgICAgaWYgKGRhdGFncmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgICAvLyDmm7TmlrDliJfkv6Hmga9cclxuICAgICAgICAgIC8vIGRhdGFncmlkQ29tcG9uZW50LmNvbHVtbnNDaGFuZ2VkKCk7XHJcbiAgICAgICAgICBjb25zdCBmaWVsZFBhdGhzID0gdGhpcy5nZXRQcm9wZXJ0eVBhdGhzKHBhdGhzKTtcclxuICAgICAgICAgIGlmIChmaWVsZFBhdGhzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpZWxkID0gZmllbGRQYXRocy5qb2luKCcuJyk7XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgICAgICAgIGRhdGFncmlkQ29tcG9uZW50LnNob3dDb2x1bW4oZmllbGQsIGZhbHNlKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICBkYXRhZ3JpZENvbXBvbmVudC5oaWRlQ29sdW1uKGZpZWxkLCBmYWxzZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IGRhdGFncmlkQ29tcG9uZW50ID0gdGhpcy5nZXREYXRhZ3JpZENvbXBvbmVudChiaW5kaW5nUGF0aCk7XHJcbiAgICAgIGlmIChkYXRhZ3JpZENvbXBvbmVudCkge1xyXG4gICAgICAgIGRhdGFncmlkQ29tcG9uZW50LmNvbHVtbnNDaGFuZ2VkKGZhbHNlKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIGdldFRhYmxlUGF0aHMocGF0aHM6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3QgZW50aXR5UGF0aHMgPSBFeHByZXNzaW9uVXRpbC5nZXRBdmFpbGFibGVDaGlsZHJlblBhdGhzRnJvbUVudGl0eVBhdGhzKHBhdGhzLCB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8pO1xyXG4gICAgcmV0dXJuIGVudGl0eVBhdGhzO1xyXG4gIH1cclxuICBwcml2YXRlIGdldERhdGFncmlkQ29tcG9uZW50KGJpbmRpbmdQYXRoOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dHM6IEZyYW1lQ29udGV4dFtdID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHNCeU5hbWVzcGFjZSh0aGlzLm5hbWVzcGFjZSkgfHwgW107XHJcbiAgICBjb25zdCBtYXRjaGVkRnJhbWVDb250ZXh0cyA9IGZyYW1lQ29udGV4dHMuZmlsdGVyKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4gZnJhbWVDb250ZXh0LnZpZXdNb2RlbCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkudG9TdHJpbmcoKSA9PT0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS50b1N0cmluZygpKTtcclxuICAgIGxldCByZXN1bHQgPSBudWxsO1xyXG4gICAgaWYgKG1hdGNoZWRGcmFtZUNvbnRleHRzKSB7XHJcbiAgICAgIG1hdGNoZWRGcmFtZUNvbnRleHRzLmV2ZXJ5KChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZyYW1lSWQgPSBmcmFtZUNvbnRleHQuZnJhbWVJZDtcclxuICAgICAgICBjb25zdCBjb21wb25lbnRzTWFwID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5jb21wb25lbnRNYW5hZ2VyLmdldENvbXBvbmVudHNCeUZyYW1lSWQoZnJhbWVJZCk7XHJcbiAgICAgICAgaWYgKCFjb21wb25lbnRzTWFwKSB7XHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZGF0YWdyaWRDb21wb25lbnQgPSBBcnJheS5mcm9tKGNvbXBvbmVudHNNYXAudmFsdWVzKCkpLmZpbmQoKGNvbXBvbmVudDogYW55KSA9PiBjb21wb25lbnQgJiYgY29tcG9uZW50WydfX2NvbXBvbmVudF90eXBlX18nXSA9PT0gJ0RhdGFncmlkQ29tcG9uZW50Jyk7XHJcbiAgICAgICAgaWYgKGRhdGFncmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgICByZXN1bHQgPSBkYXRhZ3JpZENvbXBvbmVudDtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0UHJvcGVydHlQYXRocyhwYXRoczogc3RyaW5nW10pIHtcclxuICAgIGNvbnN0IHRhYmxlUGF0aHMgPSBFeHByZXNzaW9uVXRpbC5nZXRBdmFpbGFibGVDaGlsZHJlblBhdGhzRnJvbUVudGl0eVBhdGhzKHBhdGhzLCB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8pO1xyXG4gICAgcmV0dXJuIHBhdGhzLnNsaWNlKHRhYmxlUGF0aHMubGVuZ3RoKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBpc0dyaWRDb21wb25lbnQoYmluZGluZ1BhdGg6IHN0cmluZykge1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0czogRnJhbWVDb250ZXh0W10gPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0c0J5TmFtZXNwYWNlKHRoaXMubmFtZXNwYWNlKSB8fCBbXTtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dHMuZmluZCgoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IGZyYW1lQ29udGV4dC52aWV3TW9kZWwgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLnRvU3RyaW5nKCkgPT09IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkudG9TdHJpbmcoKSk7XHJcbiAgICBpZiAoZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIHJldHVybiAhIWZyYW1lQ29udGV4dC52aWV3TW9kZWxbJ2RhdGFHcmlkQ29sdW1uc05hbWUnXTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcbn0iXX0=