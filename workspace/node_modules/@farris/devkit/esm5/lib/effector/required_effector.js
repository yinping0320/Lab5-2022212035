import * as tslib_1 from "tslib";
import { Inject, Injectable, Injector } from '@angular/core';
import { ComponentType } from '../core/index';
import { FrameContext, NAMESPACE } from "../frame/index";
import { TranslateToken } from '../i18n';
import { Repository } from '../repository/index';
/**
 * 必填副作用器
 * @description 当结算结果为true时设置必填校验，否则删除必填校验
 */
var RequiredEffector = /** @class */ (function () {
    function RequiredEffector(injector, repository, namespace, frameContext) {
        this.injector = injector;
        this.repository = repository;
        this.namespace = namespace;
        this.frameContext = frameContext;
        this.ns = namespace;
    }
    RequiredEffector.prototype.effect = function (path, value, options) {
        var _a;
        // 校验不通过时返回false
        var domInfo = this.getDomInfoByEntityPath(path);
        if (!domInfo) {
            return;
        }
        var frameContext = domInfo.frameContext;
        var rootFrameContext = frameContext && frameContext.getVirtualRootFrameContext();
        var rootViewModel = rootFrameContext.viewModel;
        var domPropertyName = domInfo.domPropertyName;
        var pathValue = this.frameContext.bindingData.getValue(path.split('/').filter(function (p) { return p; }));
        var expressionId = options.expressionId;
        if (expressionId) {
            // 增加校验规则
            frameContext.form.addFieldValidateRule(domPropertyName, options.message, expressionId, "require" /* Require */);
        }
        if (value === true) {
            if (options.message) {
                // 更新form错误信息
                // 不是grid，则认为是卡片
                if (!domInfo.isGridComponent) {
                    var message = options.message.replace(/\$property/g, domInfo.propertyName);
                    var formErrors = this.buildFormErrors(domPropertyName, message);
                    var isValidValue = this.isValidValue(path, pathValue);
                    if (!isValidValue) {
                        frameContext.form.updateFormErrors(formErrors);
                    }
                }
                else {
                    this.updateColumnValidators(frameContext, domInfo.binding, domInfo.datagridColumns, true);
                }
            }
        }
        else {
            // 返回非true值时认为非必填
            if (domInfo.isGridComponent) {
                this.updateColumnValidators(frameContext, domInfo.binding, domInfo.datagridColumns, false);
            }
            else {
                var currentErrors = frameContext.form.getFormControlErrors(domPropertyName) || null;
                if (currentErrors) {
                    if (currentErrors.hasOwnProperty('require')) {
                        // require合法，移除require校验提示
                        delete currentErrors.require;
                    }
                    frameContext.form.updateFormErrors((_a = {}, _a[domPropertyName] = { errors: currentErrors }, _a));
                }
                else {
                    var formErrors = this.buildFormErrors(domPropertyName, null);
                    frameContext.form.updateFormErrors(formErrors);
                }
            }
        }
    };
    RequiredEffector.prototype.updateColumnValidators = function (frameContext, field, datagridColumns, isRequired) {
        var frameId = frameContext.frameId;
        var componentRefs = frameContext.appContext.componentManager.get([frameId]);
        if (componentRefs && componentRefs.size > 0) {
            var datagrid = Array.from(componentRefs.values())[0];
            if (datagrid && typeof datagrid.updateColumn === 'function') {
                var columns = datagridColumns.find(function (array) {
                    return array.find(function (item) { return item.field === field; });
                });
                var column = columns && columns.find(function (item) { return item.field === field; }) || null;
                if (column) {
                    var validators = column.validators || [];
                    var index = validators.findIndex(function (item) { return item.type === 'required'; });
                    if (isRequired) {
                        if (index === -1) {
                            validators.push({ "type": "required", "message": "该字段不能为空！" });
                        }
                    }
                    else {
                        if (index !== -1) {
                            validators.splice(index, 1);
                        }
                    }
                    datagrid.updateColumn(field, { validators: tslib_1.__spread(validators) });
                    datagrid.columnsChanged(false);
                }
            }
        }
    };
    RequiredEffector.prototype.getDomInfoByEntityPath = function (entityPath) {
        var e_1, _a, e_2, _b;
        var result = null;
        if (!entityPath) {
            return result;
        }
        entityPath = entityPath.split('/').filter(function (p) { return p; }).join('.');
        var frameContexts = this.frameContext && this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace) || null;
        if (frameContexts && frameContexts.length > 0) {
            try {
                for (var frameContexts_1 = tslib_1.__values(frameContexts), frameContexts_1_1 = frameContexts_1.next(); !frameContexts_1_1.done; frameContexts_1_1 = frameContexts_1.next()) {
                    var frameContext = frameContexts_1_1.value;
                    if (result) {
                        break;
                    }
                    if (frameContext && frameContext.form && frameContext.form.ngFormControls && Object.keys(frameContext.form.ngFormControls).length > 0) {
                        var keys = Object.keys(frameContext.form.ngFormControls);
                        try {
                            for (var keys_1 = tslib_1.__values(keys), keys_1_1 = keys_1.next(); !keys_1_1.done; keys_1_1 = keys_1.next()) {
                                var propertyName = keys_1_1.value;
                                var ngFormControl = frameContext.form.ngFormControls[propertyName];
                                var bindingPath = frameContext.viewModel.bindingPath || '/';
                                var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
                                var bindings = ngFormControl.binding.split('.');
                                bindings = bindingPaths.concat(bindings);
                                if (entityPath === bindings.join('.')) {
                                    // 判断对应的组件是什么类型
                                    var dgColumnNames = frameContext.viewModel['dataGridColumnsName'] || null;
                                    var dgColumnInfo = frameContext.viewModel[dgColumnNames] || null;
                                    if (dgColumnInfo && Array.isArray(dgColumnInfo) && dgColumnInfo.length > 0) {
                                        var isEditableGrid = dgColumnInfo.find(function (array) {
                                            var readonlyGroup = array.every(function (column) { return !(column.hasOwnProperty('editor') && column.editor); });
                                            if (!readonlyGroup) {
                                                return true;
                                            }
                                            else {
                                                return false;
                                            }
                                        });
                                        if (!isEditableGrid) {
                                            continue;
                                        }
                                    }
                                    // 如果是farris树，则跳过
                                    var isFarrisTreeTableComponent = frameContext && frameContext.frameComponent && frameContext.frameComponent.componentType === ComponentType.farrisTreeTalbeComponent;
                                    if (isFarrisTreeTableComponent) {
                                        continue;
                                    }
                                    var isGridComponent = false;
                                    if (dgColumnNames) {
                                        isGridComponent = true;
                                    }
                                    result = {
                                        domPropertyName: propertyName,
                                        propertyName: ngFormControl.name || ngFormControl.defaultI18nValue,
                                        frameContext: frameContext,
                                        id: ngFormControl.id,
                                        isGridComponent: isGridComponent,
                                        binding: ngFormControl.binding,
                                        datagridColumns: dgColumnInfo
                                    };
                                    break;
                                }
                            }
                        }
                        catch (e_2_1) { e_2 = { error: e_2_1 }; }
                        finally {
                            try {
                                if (keys_1_1 && !keys_1_1.done && (_b = keys_1.return)) _b.call(keys_1);
                            }
                            finally { if (e_2) throw e_2.error; }
                        }
                    }
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (frameContexts_1_1 && !frameContexts_1_1.done && (_a = frameContexts_1.return)) _a.call(frameContexts_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
        }
        return result;
    };
    RequiredEffector.prototype.getDataPropInfo = function (path) {
        if (!path) {
            return null;
        }
        var paths = path.split('/').filter(function (p) { return p; });
        return this.frameContext.repository.entityTypeInfo.getPropInfoByPath(paths);
    };
    RequiredEffector.prototype.isValidValue = function (path, value) {
        var dataTypeInfo = this.getDataPropInfo(path);
        if (dataTypeInfo && dataTypeInfo.metadataInfo && dataTypeInfo.metadataInfo.enableMultiLangInput === true) {
            // 多语字段
            var translate = this.injector.get(TranslateToken, null);
            var currentLanguage = translate && translate.getCurrentLanguage() || 'zh-CHS';
            if (Object.keys(value).length < 1) {
                return false;
            }
            return !!value[currentLanguage];
        }
        else if (value === null || value === '' || value === undefined) {
            return false;
        }
        return true;
    };
    RequiredEffector.prototype.buildFormErrors = function (domPropertyName, message) {
        var _a, _b;
        if (message) {
            return _a = {},
                _a[domPropertyName] = {
                    errors: {
                        'require': {
                            name: message
                        }
                    }
                },
                _a;
        }
        else {
            return _b = {},
                _b[domPropertyName] = {
                    errors: {}
                },
                _b;
        }
    };
    RequiredEffector.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    RequiredEffector.ctorParameters = function () { return [
        { type: Injector },
        { type: Repository },
        { type: undefined, decorators: [{ type: Inject, args: [NAMESPACE,] }] },
        { type: FrameContext }
    ]; };
    return RequiredEffector;
}());
export { RequiredEffector };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWlyZWRfZWZmZWN0b3IuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9lZmZlY3Rvci9yZXF1aXJlZF9lZmZlY3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFJOUMsT0FBTyxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RCxPQUFPLEVBQWEsY0FBYyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3BELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUVqRDs7O0dBR0c7QUFDSDtJQUdFLDBCQUFvQixRQUFrQixFQUFVLFVBQThCLEVBQTZCLFNBQVMsRUFBVSxZQUEwQjtRQUFwSSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7UUFBNkIsY0FBUyxHQUFULFNBQVMsQ0FBQTtRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQ3RKLElBQUksQ0FBQyxFQUFFLEdBQUcsU0FBUyxDQUFDO0lBQ3RCLENBQUM7SUFDTSxpQ0FBTSxHQUFiLFVBQWMsSUFBWSxFQUFFLEtBQVUsRUFBRSxPQUFpQzs7UUFDdkUsZ0JBQWdCO1FBQ2hCLElBQU0sT0FBTyxHQUFRLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ1osT0FBTztTQUNSO1FBQ0QsSUFBTSxZQUFZLEdBQWlCLE9BQU8sQ0FBQyxZQUFZLENBQUM7UUFDeEQsSUFBTSxnQkFBZ0IsR0FBRyxZQUFZLElBQUksWUFBWSxDQUFDLDBCQUEwQixFQUFFLENBQUM7UUFDbkYsSUFBTSxhQUFhLEdBQUcsZ0JBQWdCLENB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QU0sRUFBRSxFQUFFO2lCQUNYO21CQUNEO1NBQ0g7SUFDSCxDQUFDOztnQkE1TEYsVUFBVTs7OztnQkFia0IsUUFBUTtnQkFPNUIsVUFBVTtnREFTZ0UsTUFBTSxTQUFDLFNBQVM7Z0JBWDFGLFlBQVk7O0lBcU1yQix1QkFBQztDQUFBLEFBN0xELElBNkxDO1NBNUxZLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQ29tcG9uZW50VHlwZSB9IGZyb20gJy4uL2NvcmUvaW5kZXgnO1xyXG5pbXBvcnQgeyBFbnRpdHkgfSBmcm9tICcuLi9lbnRpdHkvaW5kZXgnO1xyXG5pbXBvcnQgeyBFeHByZXNzaW9uIH0gZnJvbSAnLi4vZXhwcmVzc2lvbi9pbmRleCc7XHJcbmltcG9ydCB7IE5nRm9ybUNvbnRyb2wsIFJ1bGVUeXBlIH0gZnJvbSAnLi4vZm9ybS9pbmRleCc7XHJcbmltcG9ydCB7IEZyYW1lQ29udGV4dCwgTkFNRVNQQUNFIH0gZnJvbSBcIi4uL2ZyYW1lL2luZGV4XCI7XHJcbmltcG9ydCB7IFRyYW5zbGF0ZSwgVHJhbnNsYXRlVG9rZW4gfSBmcm9tICcuLi9pMThuJztcclxuaW1wb3J0IHsgUmVwb3NpdG9yeSB9IGZyb20gJy4uL3JlcG9zaXRvcnkvaW5kZXgnO1xyXG5cclxuLyoqXHJcbiAqIOW/heWhq+WJr+S9nOeUqOWZqFxyXG4gKiBAZGVzY3JpcHRpb24g5b2T57uT566X57uT5p6c5Li6dHJ1ZeaXtuiuvue9ruW/heWhq+agoemqjO+8jOWQpuWImeWIoOmZpOW/heWhq+agoemqjFxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgUmVxdWlyZWRFZmZlY3RvciBpbXBsZW1lbnRzIEV4cHJlc3Npb24uRWZmZWN0b3Ige1xyXG4gIHB1YmxpYyBuczogc3RyaW5nO1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8RW50aXR5PiwgQEluamVjdChOQU1FU1BBQ0UpIHByaXZhdGUgbmFtZXNwYWNlLCBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSB7XHJcbiAgICB0aGlzLm5zID0gbmFtZXNwYWNlO1xyXG4gIH1cclxuICBwdWJsaWMgZWZmZWN0KHBhdGg6IHN0cmluZywgdmFsdWU6IGFueSwgb3B0aW9uczogRXhwcmVzc2lvbi5FZmZlY3RPcHRpb25zKSB7XHJcbiAgICAvLyDmoKHpqozkuI3pgJrov4fml7bov5Tlm55mYWxzZVxyXG4gICAgY29uc3QgZG9tSW5mbzogYW55ID0gdGhpcy5nZXREb21JbmZvQnlFbnRpdHlQYXRoKHBhdGgpO1xyXG4gICAgaWYgKCFkb21JbmZvKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0ID0gZG9tSW5mby5mcmFtZUNvbnRleHQ7XHJcbiAgICBjb25zdCByb290RnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpO1xyXG4gICAgY29uc3Qgcm9vdFZpZXdNb2RlbCA9IHJvb3RGcmFtZUNvbnRleHQudmlld01vZGVsO1xyXG4gICAgY29uc3QgZG9tUHJvcGVydHlOYW1lID0gZG9tSW5mby5kb21Qcm9wZXJ0eU5hbWU7XHJcbiAgICBjb25zdCBwYXRoVmFsdWUgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRWYWx1ZShwYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkpO1xyXG4gICAgY29uc3QgZXhwcmVzc2lvbklkID0gb3B0aW9ucy5leHByZXNzaW9uSWQ7XHJcbiAgICBpZiAoZXhwcmVzc2lvbklkKSB7XHJcbiAgICAgIC8vIOWinuWKoOagoemqjOinhOWImVxyXG4gICAgICBmcmFtZUNvbnRleHQuZm9ybS5hZGRGaWVsZFZhbGlkYXRlUnVsZShkb21Qcm9wZXJ0eU5hbWUsIG9wdGlvbnMubWVzc2FnZSwgZXhwcmVzc2lvbklkLCBSdWxlVHlwZS5SZXF1aXJlKTtcclxuICAgIH1cclxuICAgIGlmICh2YWx1ZSA9PT0gdHJ1ZSkge1xyXG4gICAgICBpZiAob3B0aW9ucy5tZXNzYWdlKSB7XHJcbiAgICAgICAgLy8g5pu05pawZm9ybemUmeivr+S/oeaBr1xyXG4gICAgICAgIC8vIOS4jeaYr2dyaWTvvIzliJnorqTkuLrmmK/ljaHniYdcclxuICAgICAgICBpZiAoIWRvbUluZm8uaXNHcmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgICBjb25zdCBtZXNzYWdlID0gb3B0aW9ucy5tZXNzYWdlLnJlcGxhY2UoL1xcJHByb3BlcnR5L2csIGRvbUluZm8ucHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgIGNvbnN0IGZvcm1FcnJvcnMgPSB0aGlzLmJ1aWxkRm9ybUVycm9ycyhkb21Qcm9wZXJ0eU5hbWUsIG1lc3NhZ2UpO1xyXG4gICAgICAgICAgY29uc3QgaXNWYWxpZFZhbHVlID0gdGhpcy5pc1ZhbGlkVmFsdWUocGF0aCwgcGF0aFZhbHVlKTtcclxuICAgICAgICAgIGlmICghaXNWYWxpZFZhbHVlKSB7XHJcbiAgICAgICAgICAgIGZyYW1lQ29udGV4dC5mb3JtLnVwZGF0ZUZvcm1FcnJvcnMoZm9ybUVycm9ycyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMudXBkYXRlQ29sdW1uVmFsaWRhdG9ycyhmcmFtZUNvbnRleHQsIGRvbUluZm8uYmluZGluZywgZG9tSW5mby5kYXRhZ3JpZENvbHVtbnMsIHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8g6L+U5Zue6Z2edHJ1ZeWAvOaXtuiupOS4uumdnuW/heWhq1xyXG4gICAgICBpZiAoZG9tSW5mby5pc0dyaWRDb21wb25lbnQpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZUNvbHVtblZhbGlkYXRvcnMoZnJhbWVDb250ZXh0LCBkb21JbmZvLmJpbmRpbmcsIGRvbUluZm8uZGF0YWdyaWRDb2x1bW5zLCBmYWxzZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgY3VycmVudEVycm9ycyA9IGZyYW1lQ29udGV4dC5mb3JtLmdldEZvcm1Db250cm9sRXJyb3JzKGRvbVByb3BlcnR5TmFtZSkgfHwgbnVsbDtcclxuICAgICAgICBpZiAoY3VycmVudEVycm9ycykge1xyXG4gICAgICAgICAgaWYgKGN1cnJlbnRFcnJvcnMuaGFzT3duUHJvcGVydHkoJ3JlcXVpcmUnKSkge1xyXG4gICAgICAgICAgICAvLyByZXF1aXJl5ZCI5rOV77yM56e76ZmkcmVxdWlyZeagoemqjOaPkOekulxyXG4gICAgICAgICAgICBkZWxldGUgY3VycmVudEVycm9ycy5yZXF1aXJlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgZnJhbWVDb250ZXh0LmZvcm0udXBkYXRlRm9ybUVycm9ycyh7IFtkb21Qcm9wZXJ0eU5hbWVdOiB7IGVycm9yczogY3VycmVudEVycm9ycyB9IH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBjb25zdCBmb3JtRXJyb3JzID0gdGhpcy5idWlsZEZvcm1FcnJvcnMoZG9tUHJvcGVydHlOYW1lLCBudWxsKTtcclxuICAgICAgICAgIGZyYW1lQ29udGV4dC5mb3JtLnVwZGF0ZUZvcm1FcnJvcnMoZm9ybUVycm9ycyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIHVwZGF0ZUNvbHVtblZhbGlkYXRvcnMoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIGZpZWxkOiBzdHJpbmcsIGRhdGFncmlkQ29sdW1uczogYW55W11bXSwgaXNSZXF1aXJlZDogYm9vbGVhbikge1xyXG4gICAgY29uc3QgZnJhbWVJZCA9IGZyYW1lQ29udGV4dC5mcmFtZUlkO1xyXG4gICAgY29uc3QgY29tcG9uZW50UmVmcyA9IGZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmNvbXBvbmVudE1hbmFnZXIuZ2V0KFtmcmFtZUlkXSkgYXMgTWFwPHN0cmluZywgYW55PjtcclxuICAgIGlmIChjb21wb25lbnRSZWZzICYmIGNvbXBvbmVudFJlZnMuc2l6ZSA+IDApIHtcclxuICAgICAgY29uc3QgZGF0YWdyaWQgPSBBcnJheS5mcm9tKGNvbXBvbmVudFJlZnMudmFsdWVzKCkpWzBdO1xyXG4gICAgICBpZiAoZGF0YWdyaWQgJiYgdHlwZW9mIGRhdGFncmlkLnVwZGF0ZUNvbHVtbiA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgIGNvbnN0IGNvbHVtbnMgPSBkYXRhZ3JpZENvbHVtbnMuZmluZCgoYXJyYXk6IGFueVtdKSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gYXJyYXkuZmluZChpdGVtID0+IGl0ZW0uZmllbGQgPT09IGZpZWxkKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBjb25zdCBjb2x1bW4gPSBjb2x1bW5zICYmIGNvbHVtbnMuZmluZChpdGVtID0+IGl0ZW0uZmllbGQgPT09IGZpZWxkKSB8fCBudWxsO1xyXG4gICAgICAgIGlmIChjb2x1bW4pIHtcclxuICAgICAgICAgIGNvbnN0IHZhbGlkYXRvcnM6IGFueVtdID0gY29sdW1uLnZhbGlkYXRvcnMgfHwgW107XHJcbiAgICAgICAgICBjb25zdCBpbmRleCA9IHZhbGlkYXRvcnMuZmluZEluZGV4KGl0ZW0gPT4gaXRlbS50eXBlID09PSAncmVxdWlyZWQnKTtcclxuICAgICAgICAgIGlmIChpc1JlcXVpcmVkKSB7XHJcbiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gLTEpIHtcclxuICAgICAgICAgICAgICB2YWxpZGF0b3JzLnB1c2goeyBcInR5cGVcIjogXCJyZXF1aXJlZFwiLCBcIm1lc3NhZ2VcIjogXCLor6XlrZfmrrXkuI3og73kuLrnqbrvvIFcIiB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xyXG4gICAgICAgICAgICAgIHZhbGlkYXRvcnMuc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgZGF0YWdyaWQudXBkYXRlQ29sdW1uKGZpZWxkLCB7IHZhbGlkYXRvcnM6IFsuLi52YWxpZGF0b3JzXSB9KTtcclxuICAgICAgICAgIGRhdGFncmlkLmNvbHVtbnNDaGFuZ2VkKGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBnZXREb21JbmZvQnlFbnRpdHlQYXRoKGVudGl0eVBhdGg6IHN0cmluZyk6IHsgZG9tUHJvcGVydHlOYW1lOiBzdHJpbmcsIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBpZDogc3RyaW5nLCBpc0dyaWRDb21wb25lbnQ6IGJvb2xlYW4sIGJpbmRpbmc6IHN0cmluZywgZGF0YWdyaWRDb2x1bW5zOiBhbnlbXVtdIH0ge1xyXG4gICAgbGV0IHJlc3VsdCA9IG51bGw7XHJcbiAgICBpZiAoIWVudGl0eVBhdGgpIHtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuICAgIGVudGl0eVBhdGggPSBlbnRpdHlQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkuam9pbignLicpO1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0cyA9IHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzQnlOYW1lc3BhY2UodGhpcy5uYW1lc3BhY2UpIHx8IG51bGw7XHJcbiAgICBpZiAoZnJhbWVDb250ZXh0cyAmJiBmcmFtZUNvbnRleHRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgZm9yIChjb25zdCBmcmFtZUNvbnRleHQgb2YgZnJhbWVDb250ZXh0cykge1xyXG4gICAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5mb3JtICYmIGZyYW1lQ29udGV4dC5mb3JtLm5nRm9ybUNvbnRyb2xzICYmIE9iamVjdC5rZXlzKGZyYW1lQ29udGV4dC5mb3JtLm5nRm9ybUNvbnRyb2xzKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZnJhbWVDb250ZXh0LmZvcm0ubmdGb3JtQ29udHJvbHMpO1xyXG4gICAgICAgICAgZm9yIChjb25zdCBwcm9wZXJ0eU5hbWUgb2Yga2V5cykge1xyXG4gICAgICAgICAgICBjb25zdCBuZ0Zvcm1Db250cm9sOiBOZ0Zvcm1Db250cm9sID0gZnJhbWVDb250ZXh0LmZvcm0ubmdGb3JtQ29udHJvbHNbcHJvcGVydHlOYW1lXTtcclxuICAgICAgICAgICAgbGV0IGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCB8fCAnLyc7XHJcbiAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgICAgICAgIGxldCBiaW5kaW5ncyA9IG5nRm9ybUNvbnRyb2wuYmluZGluZy5zcGxpdCgnLicpO1xyXG4gICAgICAgICAgICBiaW5kaW5ncyA9IGJpbmRpbmdQYXRocy5jb25jYXQoYmluZGluZ3MpO1xyXG4gICAgICAgICAgICBpZiAoZW50aXR5UGF0aCA9PT0gYmluZGluZ3Muam9pbignLicpKSB7XHJcbiAgICAgICAgICAgICAgLy8g5Yik5pat5a+55bqU55qE57uE5Lu25piv5LuA5LmI57G75Z6LXHJcbiAgICAgICAgICAgICAgY29uc3QgZGdDb2x1bW5OYW1lcyA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWxbJ2RhdGFHcmlkQ29sdW1uc05hbWUnXSB8fCBudWxsO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGRnQ29sdW1uSW5mbzogQXJyYXk8QXJyYXk8YW55Pj4gPSBmcmFtZUNvbnRleHQudmlld01vZGVsW2RnQ29sdW1uTmFtZXNdIHx8IG51bGw7XHJcbiAgICAgICAgICAgICAgaWYgKGRnQ29sdW1uSW5mbyAmJiBBcnJheS5pc0FycmF5KGRnQ29sdW1uSW5mbykgJiYgZGdDb2x1bW5JbmZvLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGlzRWRpdGFibGVHcmlkID0gZGdDb2x1bW5JbmZvLmZpbmQoKGFycmF5OiBBcnJheTxhbnk+KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIGNvbnN0IHJlYWRvbmx5R3JvdXAgPSBhcnJheS5ldmVyeSgoY29sdW1uOiBhbnkpID0+ICEoY29sdW1uLmhhc093blByb3BlcnR5KCdlZGl0b3InKSAmJiBjb2x1bW4uZWRpdG9yKSk7XHJcbiAgICAgICAgICAgICAgICAgIGlmICghcmVhZG9ubHlHcm91cCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWlzRWRpdGFibGVHcmlkKSB7XHJcbiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAvLyDlpoLmnpzmmK9mYXJyaXPmoJHvvIzliJnot7Pov4dcclxuICAgICAgICAgICAgICBjb25zdCBpc0ZhcnJpc1RyZWVUYWJsZUNvbXBvbmVudCA9IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnQgJiYgZnJhbWVDb250ZXh0LmZyYW1lQ29tcG9uZW50LmNvbXBvbmVudFR5cGUgPT09IENvbXBvbmVudFR5cGUuZmFycmlzVHJlZVRhbGJlQ29tcG9uZW50O1xyXG4gICAgICAgICAgICAgIGlmIChpc0ZhcnJpc1RyZWVUYWJsZUNvbXBvbmVudCkge1xyXG4gICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIGxldCBpc0dyaWRDb21wb25lbnQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICBpZiAoZGdDb2x1bW5OYW1lcykge1xyXG4gICAgICAgICAgICAgICAgaXNHcmlkQ29tcG9uZW50ID0gdHJ1ZTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgcmVzdWx0ID0ge1xyXG4gICAgICAgICAgICAgICAgZG9tUHJvcGVydHlOYW1lOiBwcm9wZXJ0eU5hbWUsXHJcbiAgICAgICAgICAgICAgICBwcm9wZXJ0eU5hbWU6IG5nRm9ybUNvbnRyb2wubmFtZSB8fCBuZ0Zvcm1Db250cm9sLmRlZmF1bHRJMThuVmFsdWUsXHJcbiAgICAgICAgICAgICAgICBmcmFtZUNvbnRleHQsXHJcbiAgICAgICAgICAgICAgICBpZDogbmdGb3JtQ29udHJvbC5pZCxcclxuICAgICAgICAgICAgICAgIGlzR3JpZENvbXBvbmVudCxcclxuICAgICAgICAgICAgICAgIGJpbmRpbmc6IG5nRm9ybUNvbnRyb2wuYmluZGluZyxcclxuICAgICAgICAgICAgICAgIGRhdGFncmlkQ29sdW1uczogZGdDb2x1bW5JbmZvXHJcbiAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXREYXRhUHJvcEluZm8ocGF0aDogc3RyaW5nKSB7XHJcbiAgICBpZiAoIXBhdGgpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXRocyA9IHBhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvLmdldFByb3BJbmZvQnlQYXRoKHBhdGhzKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBpc1ZhbGlkVmFsdWUocGF0aDogc3RyaW5nLCB2YWx1ZTogYW55KSB7XHJcbiAgICBjb25zdCBkYXRhVHlwZUluZm8gPSB0aGlzLmdldERhdGFQcm9wSW5mbyhwYXRoKTtcclxuICAgIGlmIChkYXRhVHlwZUluZm8gJiYgZGF0YVR5cGVJbmZvLm1ldGFkYXRhSW5mbyAmJiBkYXRhVHlwZUluZm8ubWV0YWRhdGFJbmZvLmVuYWJsZU11bHRpTGFuZ0lucHV0ID09PSB0cnVlKSB7XHJcbiAgICAgIC8vIOWkmuivreWtl+autVxyXG4gICAgICBjb25zdCB0cmFuc2xhdGUgPSB0aGlzLmluamVjdG9yLmdldDxUcmFuc2xhdGU+KFRyYW5zbGF0ZVRva2VuLCBudWxsKTtcclxuICAgICAgY29uc3QgY3VycmVudExhbmd1YWdlID0gdHJhbnNsYXRlICYmIHRyYW5zbGF0ZS5nZXRDdXJyZW50TGFuZ3VhZ2UoKSB8fCAnemgtQ0hTJztcclxuICAgICAgaWYgKE9iamVjdC5rZXlzKHZhbHVlKS5sZW5ndGggPCAxKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiAhIXZhbHVlW2N1cnJlbnRMYW5ndWFnZV07XHJcbiAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSAnJyB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuICBwcml2YXRlIGJ1aWxkRm9ybUVycm9ycyhkb21Qcm9wZXJ0eU5hbWU6IHN0cmluZywgbWVzc2FnZTogc3RyaW5nKSB7XHJcbiAgICBpZiAobWVzc2FnZSkge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIFtkb21Qcm9wZXJ0eU5hbWVdOiB7XHJcbiAgICAgICAgICBlcnJvcnM6IHtcclxuICAgICAgICAgICAgJ3JlcXVpcmUnOiB7XHJcbiAgICAgICAgICAgICAgbmFtZTogbWVzc2FnZVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBbZG9tUHJvcGVydHlOYW1lXToge1xyXG4gICAgICAgICAgZXJyb3JzOiB7fVxyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgIH1cclxuICB9XHJcbn0iXX0=