import * as tslib_1 from "tslib";
import { Inject, Injectable, Injector } from '@angular/core';
import { FrameContext } from '../frame/frame_context';
import { MESSAGE_SERVICE_TOKEN, NOTIFY_SERVICE_TOKEN, ComponentType } from '../core/index';
import { NAMESPACE } from '../frame/tokens';
var ValidateEffector = /** @class */ (function () {
    function ValidateEffector(injector, messageService, notifyService, namespace, frameContext) {
        this.injector = injector;
        this.messageService = messageService;
        this.notifyService = notifyService;
        this.namespace = namespace;
        this.frameContext = frameContext;
        this.ns = namespace;
    }
    ValidateEffector.prototype.effect = function (path, value, options) {
        var _a;
        // 校验不通过时返回false
        var domInfo = this.getDomInfoByEntityPath(path);
        if (!domInfo) {
            return;
        }
        var frameContext = domInfo.frameContext;
        var rootFrameContext = frameContext && frameContext.getVirtualRootFrameContext();
        // const rootViewModel = rootFrameContext.viewModel;
        var expressionId = options.expressionId;
        var domPropertyName = domInfo.domPropertyName;
        if (expressionId) {
            // 增加校验规则
            frameContext.form.addFieldValidateRule(domPropertyName, options.message, expressionId, "validate" /* Validate */);
        }
        if (value === false && options.message) {
            // 更新form错误信息
            // 不是grid，则认为是卡片
            if (!domInfo.isGridComponent) {
                var message = options.message.replace(/\$property/g, domInfo.propertyName);
                var formErrors = this.buildFormErrors(domPropertyName, message);
                // // 只增加校验规则，不立即显示校验信息，否则页面加载后在非编辑态就会显示校验信息
                frameContext.form.updateFormErrors(formErrors);
            }
            else {
                // if (expressionId) {
                //   // 增加校验规则
                //   frameContext.form.addFieldValidateRule(domPropertyName, options.message, expressionId, RuleType.Validate);
                // }
            }
            // 不进行汇总展示
            // const verifyInformations = this.buildVerifyInformations(domInfo.id, frameContext, domInfo.domPropertyName, options.message);
            // 增加到汇总消息
            // rootViewModel.verifycationChanged.next(verifyInformations);
            // 更新汇总错误信息
        }
        else if (value === true) {
            // 移除错误消息
            // const verifyInformations = this.removeValidateVerifyInformations(domInfo.id, this.frameContext);
            // rootViewModel.verifycationChanged.next(verifyInformations);
            var currentErrors = frameContext.form.getFormControlErrors(domPropertyName) || null;
            if (currentErrors) {
                if (currentErrors.hasOwnProperty('validate')) {
                    // require合法，移除require校验提示
                    delete currentErrors.validate;
                }
                frameContext.form.updateFormErrors((_a = {}, _a[domPropertyName] = { errors: currentErrors }, _a));
            }
            else {
                var formErrors = this.buildFormErrors(domPropertyName, null);
                frameContext.form.updateFormErrors(formErrors);
            }
        }
    };
    /**
     * 通过实体路径获取对应的dom信息
     * @param entityPath
     * @returns
     */
    ValidateEffector.prototype.getDomInfoByEntityPath = function (entityPath) {
        var e_1, _a, e_2, _b;
        var result = null;
        if (!entityPath) {
            return result;
        }
        entityPath = entityPath.split('/').filter(function (p) { return p; }).join('.');
        var frameContexts = this.frameContext && this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace) || null;
        if (frameContexts && frameContexts.length > 0) {
            try {
                for (var frameContexts_1 = tslib_1.__values(frameContexts), frameContexts_1_1 = frameContexts_1.next(); !frameContexts_1_1.done; frameContexts_1_1 = frameContexts_1.next()) {
                    var frameContext = frameContexts_1_1.value;
                    if (result) {
                        break;
                    }
                    var isValidFrameContext = frameContext && frameContext.form && frameContext.form.ngFormControls && Object.keys(frameContext.form.ngFormControls).length > 0;
                    if (frameContext && frameContext.form && frameContext.form.ngFormControls && Object.keys(frameContext.form.ngFormControls).length > 0) {
                        var keys = Object.keys(frameContext.form.ngFormControls);
                        try {
                            for (var keys_1 = tslib_1.__values(keys), keys_1_1 = keys_1.next(); !keys_1_1.done; keys_1_1 = keys_1.next()) {
                                var propertyName = keys_1_1.value;
                                var ngFormControl = frameContext.form.ngFormControls[propertyName];
                                var bindingPath = frameContext.viewModel.bindingPath || '/';
                                var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
                                var bindings = ngFormControl.binding.split('.');
                                bindings = bindingPaths.concat(bindings);
                                if (entityPath === bindings.join('.')) {
                                    // 判断对应的组件是什么类型
                                    var dgColumnNames = frameContext.viewModel['dataGridColumnsName'] || null;
                                    var dgColumnInfo = frameContext.viewModel[dgColumnNames] || null;
                                    if (dgColumnInfo && Array.isArray(dgColumnInfo) && dgColumnInfo.length > 0) {
                                        var isEditableGrid = dgColumnInfo.find(function (array) {
                                            var readonlyGroup = array.every(function (column) { return !(column.hasOwnProperty('editor') && column.editor); });
                                            if (!readonlyGroup) {
                                                return true;
                                            }
                                            else {
                                                return false;
                                            }
                                        });
                                        if (!isEditableGrid) {
                                            continue;
                                        }
                                    }
                                    // 如果是farris树，则跳过
                                    var isFarrisTreeTableComponent = frameContext && frameContext.frameComponent && frameContext.frameComponent.componentType === ComponentType.farrisTreeTalbeComponent;
                                    if (isFarrisTreeTableComponent) {
                                        continue;
                                    }
                                    var isGridComponent = false;
                                    if (dgColumnNames) {
                                        isGridComponent = true;
                                    }
                                    result = {
                                        domPropertyName: propertyName,
                                        propertyName: ngFormControl.name || ngFormControl.defaultI18nValue,
                                        frameContext: frameContext,
                                        id: ngFormControl.id,
                                        isGridComponent: isGridComponent
                                    };
                                    break;
                                }
                            }
                        }
                        catch (e_2_1) { e_2 = { error: e_2_1 }; }
                        finally {
                            try {
                                if (keys_1_1 && !keys_1_1.done && (_b = keys_1.return)) _b.call(keys_1);
                            }
                            finally { if (e_2) throw e_2.error; }
                        }
                    }
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (frameContexts_1_1 && !frameContexts_1_1.done && (_a = frameContexts_1.return)) _a.call(frameContexts_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
        }
        return result;
    };
    ValidateEffector.prototype.getVerifyInformations = function (frameContext) {
        var rootFrameContext = frameContext && frameContext.getVirtualRootFrameContext();
        var rootViewModel = rootFrameContext.viewModel;
        var verifyInformations = rootViewModel.verifyInformations;
        return verifyInformations;
    };
    ValidateEffector.prototype.buildFormErrors = function (domPropertyName, message) {
        var _a, _b;
        if (message) {
            message = message.replace(/\$property/g, 'domPropertyName');
            return _a = {},
                _a[domPropertyName] = {
                    errors: {
                        'validate': {
                            name: message
                        }
                    }
                },
                _a;
        }
        else {
            return _b = {},
                _b[domPropertyName] = {
                    errors: {}
                },
                _b;
        }
    };
    ValidateEffector.prototype.buildVerifyInformations = function (id, frameContext, domPropertyName, message) {
        var verifyInformations = this.getVerifyInformations(frameContext);
        var index = verifyInformations.findIndex(function (item) {
            return item.id === id;
        });
        if (index !== -1) {
            verifyInformations.splice(index, 1);
        }
        verifyInformations.push({
            id: id,
            namespace: frameContext.namespace,
            targetField: domPropertyName,
            index: verifyInformations.length + 1,
            title: frameContext.form.formGroupName,
            msg: message,
            type: 'error'
        });
        return verifyInformations;
    };
    ValidateEffector.prototype.removeValidateVerifyInformations = function (id, frameContext) {
        var verifyInformations = this.getVerifyInformations(frameContext);
        var index = verifyInformations.findIndex(function (item) {
            return item.id === id;
        });
        if (index !== -1) {
            verifyInformations.splice(index, 1);
        }
        return verifyInformations;
    };
    ValidateEffector.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ValidateEffector.ctorParameters = function () { return [
        { type: Injector },
        { type: undefined, decorators: [{ type: Inject, args: [MESSAGE_SERVICE_TOKEN,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [NOTIFY_SERVICE_TOKEN,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [NAMESPACE,] }] },
        { type: FrameContext }
    ]; };
    return ValidateEffector;
}());
export { ValidateEffector };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGVfZWZmZWN0b3IuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9lZmZlY3Rvci92YWxpZGF0ZV9lZmZlY3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTdELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsb0JBQW9CLEVBQW1DLGFBQWEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUc1SCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFNUM7SUFHRSwwQkFDVSxRQUFrQixFQUNhLGNBQStCLEVBQ2hDLGFBQTZCLEVBQ3hDLFNBQVMsRUFDNUIsWUFBMEI7UUFKMUIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNhLG1CQUFjLEdBQWQsY0FBYyxDQUFpQjtRQUNoQyxrQkFBYSxHQUFiLGFBQWEsQ0FBZ0I7UUFDeEMsY0FBUyxHQUFULFNBQVMsQ0FBQTtRQUM1QixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUVsQyxJQUFJLENBQUMsRUFBRSxHQUFHLFNBQVMsQ0FBQztJQUN0QixDQUFDO0lBQ00saUNBQU0sR0FBYixVQUFjLElBQVksRUFBRSxLQUFVLEVBQUUsT0FBaUM7O1FBQ3ZFLGdCQUFnQjtRQUNoQixJQUFNLE9BQU8sR0FBUSxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNaLE9BQU87U0FDUjtRQUNELElBQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUM7UUFDMUMsSUFBTSxnQkFBZ0IsR0FBRyxZQUFZLElBQUksWUFBWSxDQUFDLDBCQUEwQixFQUFFLENBQUM7UUFDbkYsb0RBQW9EO1FBQ3BELElBQU0sWUFB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LENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ3JDO1FBQ0Qsa0JBQWtCLENBQUMsSUFBSSxDQUFDO1lBQ3RCLEVBQUUsRUFBRSxFQUFFO1lBQ04sU0FBUyxFQUFFLFlBQVksQ0FBQyxTQUFTO1lBQ2pDLFdBQVcsRUFBRSxlQUFlO1lBQzVCLEtBQUssRUFBRSxrQkFBa0IsQ0FBQyxNQUFNLEdBQUcsQ0FBQztZQUNwQyxLQUFLLEVBQUUsWUFBWSxDQUFDLElBQUksQ0FBQyxhQUFhO1lBQ3RDLEdBQUcsRUFBRSxPQUFPO1lBQ1osSUFBSSxFQUFFLE9BQU87U0FDZCxDQUFDLENBQUM7UUFDSCxPQUFPLGtCQUFrQixDQUFDO0lBQzVCLENBQUM7SUFDTywyREFBZ0MsR0FBeEMsVUFBeUMsRUFBVSxFQUFFLFlBQTBCO1FBQzdFLElBQU0sa0JBQWtCLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3BFLElBQU0sS0FBSyxHQUFHLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxVQUFDLElBQVM7WUFDbkQsT0FBTyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQTtRQUN2QixDQUFDLENBQUMsQ0FBQztRQUNILElBQUksS0FBSyxLQUFLLENBQUMsQ0FBQyxFQUFFO1lBQ2hCLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDckM7UUFDRCxPQUFPLGtCQUFrQixDQUFDO0lBQzVCLENBQUM7O2dCQXpMRixVQUFVOzs7O2dCQVJrQixRQUFRO2dEQWFoQyxNQUFNLFNBQUMscUJBQXFCO2dEQUM1QixNQUFNLFNBQUMsb0JBQW9CO2dEQUMzQixNQUFNLFNBQUMsU0FBUztnQkFiWixZQUFZOztJQWdNckIsdUJBQUM7Q0FBQSxBQTFMRCxJQTBMQztTQXpMWSxnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEV4cHJlc3Npb24gfSBmcm9tICcuLi9leHByZXNzaW9uL2luZGV4JztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0IH0gZnJvbSAnLi4vZnJhbWUvZnJhbWVfY29udGV4dCc7XHJcbmltcG9ydCB7IE1FU1NBR0VfU0VSVklDRV9UT0tFTiwgTk9USUZZX1NFUlZJQ0VfVE9LRU4sIElNZXNzYWdlU2VydmljZSwgSU5vdGlmeVNlcnZpY2UsIENvbXBvbmVudFR5cGUgfSBmcm9tICcuLi9jb3JlL2luZGV4JztcclxuaW1wb3J0IHsgTmdGb3JtQ29udHJvbCB9IGZyb20gJy4uL2Zvcm0vZGVjb3JhdG9ycyc7XHJcbmltcG9ydCB7IFJ1bGVUeXBlIH0gZnJvbSAnLi4vZm9ybS9pbmRleCc7XHJcbmltcG9ydCB7IE5BTUVTUEFDRSB9IGZyb20gJy4uL2ZyYW1lL3Rva2Vucyc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBWYWxpZGF0ZUVmZmVjdG9yIGltcGxlbWVudHMgRXhwcmVzc2lvbi5FZmZlY3RvciB7XHJcbiAgcHVibGljIG5zOiBzdHJpbmc7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcixcclxuICAgIEBJbmplY3QoTUVTU0FHRV9TRVJWSUNFX1RPS0VOKSBwcml2YXRlIG1lc3NhZ2VTZXJ2aWNlOiBJTWVzc2FnZVNlcnZpY2UsXHJcbiAgICBASW5qZWN0KE5PVElGWV9TRVJWSUNFX1RPS0VOKSBwcml2YXRlIG5vdGlmeVNlcnZpY2U6IElOb3RpZnlTZXJ2aWNlLFxyXG4gICAgQEluamVjdChOQU1FU1BBQ0UpIHByaXZhdGUgbmFtZXNwYWNlLFxyXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dFxyXG4gICkge1xyXG4gICAgdGhpcy5ucyA9IG5hbWVzcGFjZTtcclxuICB9XHJcbiAgcHVibGljIGVmZmVjdChwYXRoOiBzdHJpbmcsIHZhbHVlOiBhbnksIG9wdGlvbnM6IEV4cHJlc3Npb24uRWZmZWN0T3B0aW9ucykge1xyXG4gICAgLy8g5qCh6aqM5LiN6YCa6L+H5pe26L+U5ZueZmFsc2VcclxuICAgIGNvbnN0IGRvbUluZm86IGFueSA9IHRoaXMuZ2V0RG9tSW5mb0J5RW50aXR5UGF0aChwYXRoKTtcclxuICAgIGlmICghZG9tSW5mbykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSBkb21JbmZvLmZyYW1lQ29udGV4dDtcclxuICAgIGNvbnN0IHJvb3RGcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XHJcbiAgICAvLyBjb25zdCByb290Vmlld01vZGVsID0gcm9vdEZyYW1lQ29udGV4dC52aWV3TW9kZWw7XHJcbiAgICBjb25zdCBleHByZXNzaW9uSWQgPSBvcHRpb25zLmV4cHJlc3Npb25JZDtcclxuICAgIGNvbnN0IGRvbVByb3BlcnR5TmFtZSA9IGRvbUluZm8uZG9tUHJvcGVydHlOYW1lO1xyXG4gICAgaWYgKGV4cHJlc3Npb25JZCkge1xyXG4gICAgICAvLyDlop7liqDmoKHpqozop4TliJlcclxuICAgICAgZnJhbWVDb250ZXh0LmZvcm0uYWRkRmllbGRWYWxpZGF0ZVJ1bGUoZG9tUHJvcGVydHlOYW1lLCBvcHRpb25zLm1lc3NhZ2UsIGV4cHJlc3Npb25JZCwgUnVsZVR5cGUuVmFsaWRhdGUpO1xyXG4gICAgfVxyXG4gICAgaWYgKHZhbHVlID09PSBmYWxzZSAmJiBvcHRpb25zLm1lc3NhZ2UpIHtcclxuICAgICAgLy8g5pu05pawZm9ybemUmeivr+S/oeaBr1xyXG4gICAgICAvLyDkuI3mmK9ncmlk77yM5YiZ6K6k5Li65piv5Y2h54mHXHJcbiAgICAgIGlmICghZG9tSW5mby5pc0dyaWRDb21wb25lbnQpIHtcclxuICAgICAgICBjb25zdCBtZXNzYWdlID0gb3B0aW9ucy5tZXNzYWdlLnJlcGxhY2UoL1xcJHByb3BlcnR5L2csIGRvbUluZm8ucHJvcGVydHlOYW1lKTtcclxuICAgICAgICBjb25zdCBmb3JtRXJyb3JzID0gdGhpcy5idWlsZEZvcm1FcnJvcnMoZG9tUHJvcGVydHlOYW1lLCBtZXNzYWdlKTtcclxuICAgICAgICAvLyAvLyDlj6rlop7liqDmoKHpqozop4TliJnvvIzkuI3nq4vljbPmmL7npLrmoKHpqozkv6Hmga/vvIzlkKbliJnpobXpnaLliqDovb3lkI7lnKjpnZ7nvJbovpHmgIHlsLHkvJrmmL7npLrmoKHpqozkv6Hmga9cclxuICAgICAgICBmcmFtZUNvbnRleHQuZm9ybS51cGRhdGVGb3JtRXJyb3JzKGZvcm1FcnJvcnMpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIGlmIChleHByZXNzaW9uSWQpIHtcclxuICAgICAgICAvLyAgIC8vIOWinuWKoOagoemqjOinhOWImVxyXG4gICAgICAgIC8vICAgZnJhbWVDb250ZXh0LmZvcm0uYWRkRmllbGRWYWxpZGF0ZVJ1bGUoZG9tUHJvcGVydHlOYW1lLCBvcHRpb25zLm1lc3NhZ2UsIGV4cHJlc3Npb25JZCwgUnVsZVR5cGUuVmFsaWRhdGUpO1xyXG4gICAgICAgIC8vIH1cclxuICAgICAgfVxyXG4gICAgICAvLyDkuI3ov5vooYzmsYfmgLvlsZXnpLpcclxuICAgICAgLy8gY29uc3QgdmVyaWZ5SW5mb3JtYXRpb25zID0gdGhpcy5idWlsZFZlcmlmeUluZm9ybWF0aW9ucyhkb21JbmZvLmlkLCBmcmFtZUNvbnRleHQsIGRvbUluZm8uZG9tUHJvcGVydHlOYW1lLCBvcHRpb25zLm1lc3NhZ2UpO1xyXG4gICAgICAvLyDlop7liqDliLDmsYfmgLvmtojmga9cclxuICAgICAgLy8gcm9vdFZpZXdNb2RlbC52ZXJpZnljYXRpb25DaGFuZ2VkLm5leHQodmVyaWZ5SW5mb3JtYXRpb25zKTtcclxuICAgICAgLy8g5pu05paw5rGH5oC76ZSZ6K+v5L+h5oGvXHJcbiAgICB9IGVsc2UgaWYgKHZhbHVlID09PSB0cnVlKSB7XHJcbiAgICAgIC8vIOenu+mZpOmUmeivr+a2iOaBr1xyXG4gICAgICAvLyBjb25zdCB2ZXJpZnlJbmZvcm1hdGlvbnMgPSB0aGlzLnJlbW92ZVZhbGlkYXRlVmVyaWZ5SW5mb3JtYXRpb25zKGRvbUluZm8uaWQsIHRoaXMuZnJhbWVDb250ZXh0KTtcclxuICAgICAgLy8gcm9vdFZpZXdNb2RlbC52ZXJpZnljYXRpb25DaGFuZ2VkLm5leHQodmVyaWZ5SW5mb3JtYXRpb25zKTtcclxuICAgICAgY29uc3QgY3VycmVudEVycm9ycyA9IGZyYW1lQ29udGV4dC5mb3JtLmdldEZvcm1Db250cm9sRXJyb3JzKGRvbVByb3BlcnR5TmFtZSkgfHwgbnVsbDtcclxuICAgICAgaWYgKGN1cnJlbnRFcnJvcnMpIHtcclxuICAgICAgICBpZiAoY3VycmVudEVycm9ycy5oYXNPd25Qcm9wZXJ0eSgndmFsaWRhdGUnKSkge1xyXG4gICAgICAgICAgLy8gcmVxdWlyZeWQiOazle+8jOenu+mZpHJlcXVpcmXmoKHpqozmj5DnpLpcclxuICAgICAgICAgIGRlbGV0ZSBjdXJyZW50RXJyb3JzLnZhbGlkYXRlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmcmFtZUNvbnRleHQuZm9ybS51cGRhdGVGb3JtRXJyb3JzKHsgW2RvbVByb3BlcnR5TmFtZV06IHsgZXJyb3JzOiBjdXJyZW50RXJyb3JzIH0gfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgZm9ybUVycm9ycyA9IHRoaXMuYnVpbGRGb3JtRXJyb3JzKGRvbVByb3BlcnR5TmFtZSwgbnVsbCk7XHJcbiAgICAgICAgZnJhbWVDb250ZXh0LmZvcm0udXBkYXRlRm9ybUVycm9ycyhmb3JtRXJyb3JzKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDpgJrov4flrp7kvZPot6/lvoTojrflj5blr7nlupTnmoRkb23kv6Hmga9cclxuICAgKiBAcGFyYW0gZW50aXR5UGF0aFxyXG4gICAqIEByZXR1cm5zXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXREb21JbmZvQnlFbnRpdHlQYXRoKGVudGl0eVBhdGg6IHN0cmluZyk6IHsgZG9tUHJvcGVydHlOYW1lOiBzdHJpbmcsIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBpZDogc3RyaW5nLCBpc0dyaWRDb21wb25lbnQ6IGJvb2xlYW4gfSB7XHJcbiAgICBsZXQgcmVzdWx0ID0gbnVsbDtcclxuICAgIGlmICghZW50aXR5UGF0aCkge1xyXG4gICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG4gICAgZW50aXR5UGF0aCA9IGVudGl0eVBhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS5qb2luKCcuJyk7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gdGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHNCeU5hbWVzcGFjZSh0aGlzLm5hbWVzcGFjZSkgfHwgbnVsbDtcclxuICAgIGlmIChmcmFtZUNvbnRleHRzICYmIGZyYW1lQ29udGV4dHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBmb3IgKGNvbnN0IGZyYW1lQ29udGV4dCBvZiBmcmFtZUNvbnRleHRzKSB7XHJcbiAgICAgICAgaWYgKHJlc3VsdCkge1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBpc1ZhbGlkRnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5mb3JtICYmIGZyYW1lQ29udGV4dC5mb3JtLm5nRm9ybUNvbnRyb2xzICYmIE9iamVjdC5rZXlzKGZyYW1lQ29udGV4dC5mb3JtLm5nRm9ybUNvbnRyb2xzKS5sZW5ndGggPiAwXHJcbiAgICAgICAgaWYgKGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQuZm9ybSAmJiBmcmFtZUNvbnRleHQuZm9ybS5uZ0Zvcm1Db250cm9scyAmJiBPYmplY3Qua2V5cyhmcmFtZUNvbnRleHQuZm9ybS5uZ0Zvcm1Db250cm9scykubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGZyYW1lQ29udGV4dC5mb3JtLm5nRm9ybUNvbnRyb2xzKTtcclxuICAgICAgICAgIGZvciAoY29uc3QgcHJvcGVydHlOYW1lIG9mIGtleXMpIHtcclxuICAgICAgICAgICAgY29uc3QgbmdGb3JtQ29udHJvbDogTmdGb3JtQ29udHJvbCA9IGZyYW1lQ29udGV4dC5mb3JtLm5nRm9ybUNvbnRyb2xzW3Byb3BlcnR5TmFtZV07XHJcbiAgICAgICAgICAgIGxldCBiaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggfHwgJy8nO1xyXG4gICAgICAgICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgICAgICAgICBsZXQgYmluZGluZ3MgPSBuZ0Zvcm1Db250cm9sLmJpbmRpbmcuc3BsaXQoJy4nKTtcclxuICAgICAgICAgICAgYmluZGluZ3MgPSBiaW5kaW5nUGF0aHMuY29uY2F0KGJpbmRpbmdzKTtcclxuICAgICAgICAgICAgaWYgKGVudGl0eVBhdGggPT09IGJpbmRpbmdzLmpvaW4oJy4nKSkge1xyXG4gICAgICAgICAgICAgIC8vIOWIpOaWreWvueW6lOeahOe7hOS7tuaYr+S7gOS5iOexu+Wei1xyXG4gICAgICAgICAgICAgIGNvbnN0IGRnQ29sdW1uTmFtZXMgPSBmcmFtZUNvbnRleHQudmlld01vZGVsWydkYXRhR3JpZENvbHVtbnNOYW1lJ10gfHwgbnVsbDtcclxuICAgICAgICAgICAgICBjb25zdCBkZ0NvbHVtbkluZm86IEFycmF5PEFycmF5PGFueT4+ID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbFtkZ0NvbHVtbk5hbWVzXSB8fCBudWxsO1xyXG4gICAgICAgICAgICAgIGlmIChkZ0NvbHVtbkluZm8gJiYgQXJyYXkuaXNBcnJheShkZ0NvbHVtbkluZm8pICYmIGRnQ29sdW1uSW5mby5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpc0VkaXRhYmxlR3JpZCA9IGRnQ29sdW1uSW5mby5maW5kKChhcnJheTogQXJyYXk8YW55PikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICBjb25zdCByZWFkb25seUdyb3VwID0gYXJyYXkuZXZlcnkoKGNvbHVtbjogYW55KSA9PiAhKGNvbHVtbi5oYXNPd25Qcm9wZXJ0eSgnZWRpdG9yJykgJiYgY29sdW1uLmVkaXRvcikpO1xyXG4gICAgICAgICAgICAgICAgICBpZiAoIXJlYWRvbmx5R3JvdXApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFpc0VkaXRhYmxlR3JpZCkge1xyXG4gICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgLy8g5aaC5p6c5pivZmFycmlz5qCR77yM5YiZ6Lez6L+HXHJcbiAgICAgICAgICAgICAgY29uc3QgaXNGYXJyaXNUcmVlVGFibGVDb21wb25lbnQgPSBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LmZyYW1lQ29tcG9uZW50ICYmIGZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudC5jb21wb25lbnRUeXBlID09PSBDb21wb25lbnRUeXBlLmZhcnJpc1RyZWVUYWxiZUNvbXBvbmVudDtcclxuICAgICAgICAgICAgICBpZiAoaXNGYXJyaXNUcmVlVGFibGVDb21wb25lbnQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBsZXQgaXNHcmlkQ29tcG9uZW50ID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgaWYgKGRnQ29sdW1uTmFtZXMpIHtcclxuICAgICAgICAgICAgICAgIGlzR3JpZENvbXBvbmVudCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIHJlc3VsdCA9IHtcclxuICAgICAgICAgICAgICAgIGRvbVByb3BlcnR5TmFtZTogcHJvcGVydHlOYW1lLFxyXG4gICAgICAgICAgICAgICAgcHJvcGVydHlOYW1lOiBuZ0Zvcm1Db250cm9sLm5hbWUgfHwgbmdGb3JtQ29udHJvbC5kZWZhdWx0STE4blZhbHVlLFxyXG4gICAgICAgICAgICAgICAgZnJhbWVDb250ZXh0LFxyXG4gICAgICAgICAgICAgICAgaWQ6IG5nRm9ybUNvbnRyb2wuaWQsXHJcbiAgICAgICAgICAgICAgICBpc0dyaWRDb21wb25lbnRcclxuICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuICBwcml2YXRlIGdldFZlcmlmeUluZm9ybWF0aW9ucyhmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkge1xyXG4gICAgY29uc3Qgcm9vdEZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKTtcclxuICAgIGNvbnN0IHJvb3RWaWV3TW9kZWwgPSByb290RnJhbWVDb250ZXh0LnZpZXdNb2RlbDtcclxuICAgIGNvbnN0IHZlcmlmeUluZm9ybWF0aW9ucyA9IHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zO1xyXG4gICAgcmV0dXJuIHZlcmlmeUluZm9ybWF0aW9ucztcclxuICB9XHJcbiAgcHJpdmF0ZSBidWlsZEZvcm1FcnJvcnMoZG9tUHJvcGVydHlOYW1lOiBzdHJpbmcsIG1lc3NhZ2U6IHN0cmluZykge1xyXG4gICAgaWYgKG1lc3NhZ2UpIHtcclxuICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UucmVwbGFjZSgvXFwkcHJvcGVydHkvZywgJ2RvbVByb3BlcnR5TmFtZScpO1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIFtkb21Qcm9wZXJ0eU5hbWVdOiB7XHJcbiAgICAgICAgICBlcnJvcnM6IHtcclxuICAgICAgICAgICAgJ3ZhbGlkYXRlJzoge1xyXG4gICAgICAgICAgICAgIG5hbWU6IG1lc3NhZ2VcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgW2RvbVByb3BlcnR5TmFtZV06IHtcclxuICAgICAgICAgIGVycm9yczoge31cclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgYnVpbGRWZXJpZnlJbmZvcm1hdGlvbnMoaWQ6IHN0cmluZywgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIGRvbVByb3BlcnR5TmFtZTogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHZlcmlmeUluZm9ybWF0aW9ucyA9IHRoaXMuZ2V0VmVyaWZ5SW5mb3JtYXRpb25zKGZyYW1lQ29udGV4dCk7XHJcbiAgICBjb25zdCBpbmRleCA9IHZlcmlmeUluZm9ybWF0aW9ucy5maW5kSW5kZXgoKGl0ZW06IGFueSkgPT4ge1xyXG4gICAgICByZXR1cm4gaXRlbS5pZCA9PT0gaWRcclxuICAgIH0pO1xyXG4gICAgaWYgKGluZGV4ICE9PSAtMSkge1xyXG4gICAgICB2ZXJpZnlJbmZvcm1hdGlvbnMuc3BsaWNlKGluZGV4LCAxKTtcclxuICAgIH1cclxuICAgIHZlcmlmeUluZm9ybWF0aW9ucy5wdXNoKHtcclxuICAgICAgaWQ6IGlkLFxyXG4gICAgICBuYW1lc3BhY2U6IGZyYW1lQ29udGV4dC5uYW1lc3BhY2UsXHJcbiAgICAgIHRhcmdldEZpZWxkOiBkb21Qcm9wZXJ0eU5hbWUsXHJcbiAgICAgIGluZGV4OiB2ZXJpZnlJbmZvcm1hdGlvbnMubGVuZ3RoICsgMSxcclxuICAgICAgdGl0bGU6IGZyYW1lQ29udGV4dC5mb3JtLmZvcm1Hcm91cE5hbWUsXHJcbiAgICAgIG1zZzogbWVzc2FnZSxcclxuICAgICAgdHlwZTogJ2Vycm9yJ1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdmVyaWZ5SW5mb3JtYXRpb25zO1xyXG4gIH1cclxuICBwcml2YXRlIHJlbW92ZVZhbGlkYXRlVmVyaWZ5SW5mb3JtYXRpb25zKGlkOiBzdHJpbmcsIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSB7XHJcbiAgICBjb25zdCB2ZXJpZnlJbmZvcm1hdGlvbnMgPSB0aGlzLmdldFZlcmlmeUluZm9ybWF0aW9ucyhmcmFtZUNvbnRleHQpO1xyXG4gICAgY29uc3QgaW5kZXggPSB2ZXJpZnlJbmZvcm1hdGlvbnMuZmluZEluZGV4KChpdGVtOiBhbnkpID0+IHtcclxuICAgICAgcmV0dXJuIGl0ZW0uaWQgPT09IGlkXHJcbiAgICB9KTtcclxuICAgIGlmIChpbmRleCAhPT0gLTEpIHtcclxuICAgICAgdmVyaWZ5SW5mb3JtYXRpb25zLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdmVyaWZ5SW5mb3JtYXRpb25zO1xyXG4gIH1cclxufVxyXG4iXX0=