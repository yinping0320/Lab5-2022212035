import { Injectable } from '@angular/core';
import { MetadataUtil } from '../../metadata/index';
import { NG_SUBSCRIPTION } from './subscription_decorator';
var Subscription = /** @class */ (function () {
    function Subscription() {
    }
    /**
     * 初始化
     */
    Subscription.prototype.init = function (frameComponent) {
        if (!frameComponent) {
            return;
        }
        return this.bindSubscription(frameComponent, null);
    };
    /**
     *  根据订阅列表进行初始化
     * @param frameComponent
     * @param ngEvents 订阅列表
     * @returns eventPipes
     */
    Subscription.prototype.initWithSubscriptions = function (frameComponent, ngEvents) {
        if (!frameComponent) {
            return;
        }
        return this.bindSubscription(frameComponent, ngEvents);
    };
    /**
     * 更改成为public形式 目的为了解析表单可以进行重新绑定
     * @param frameComponent
     * @param ngEvents
     * @returns
     */
    Subscription.prototype.bindSubscription = function (frameComponent, ngEvents) {
        var _this = this;
        var context = frameComponent.context;
        if (!context) {
            return;
        }
        var ngEventHandlerProps = ngEvents ? ngEvents : this.getNgEvents(frameComponent);
        if (!ngEventHandlerProps) {
            return;
        }
        var eventPipes = [];
        Object.keys(ngEventHandlerProps).forEach(function (propertyName) {
            var ngImportEvent = ngEventHandlerProps[propertyName];
            // 获取待订阅方法详情，尝试执行订阅
            var targetContext = context;
            var receiver = frameComponent;
            var emitter = ngImportEvent.token;
            var tokenValue = ngImportEvent.token;
            var eventName = ngImportEvent.name;
            var paramMapCollection = ngImportEvent.paramMapCollection;
            var eventPipe = targetContext.eventBus.on(emitter, tokenValue, eventName, receiver, function (eventArgs) {
                _this.subscriptionHandler(eventArgs, paramMapCollection, targetContext);
                var eventHandler = frameComponent[eventName];
                if (!eventHandler) {
                    return;
                }
                try {
                    eventHandler(receiver, eventArgs);
                }
                catch (_a) {
                    throw new Error('Error invoking method ' + eventName);
                }
            });
            eventPipes.push(eventPipe);
        });
        return eventPipes;
    };
    /**
     * 获取组件订阅列表
     * @param frameComponent 表单component
     * @returns 组件订阅列表信息
     */
    Subscription.prototype.getNgEvents = function (frameComponent) {
        return MetadataUtil.getPropsMetadatasByName(frameComponent.constructor, NG_SUBSCRIPTION);
    };
    Subscription.prototype.subscriptionHandler = function (param, paramMapCollection, currentFrameContext) {
        if (!param || !paramMapCollection || paramMapCollection.length <= 0 || !currentFrameContext) {
            return;
        }
        this.paramMap2UiState(param, paramMapCollection, currentFrameContext);
    };
    /**
     * 设置paramMap后，将param映射到UISTATE上
     */
    Subscription.prototype.paramMap2UiState = function (param, paramMapCollection, currentFrameContext) {
        for (var i = 0; i < paramMapCollection.length; i++) {
            var from = paramMapCollection[i].from;
            var frameId = paramMapCollection[i].frameId;
            var to = paramMapCollection[i].to;
            if (!from || !frameId || !to) {
                continue;
            }
            var destContext = this.getFrameContext(frameId, currentFrameContext);
            if (destContext == null) {
                continue;
            }
            this.setUiStateProperty(to, param[from], destContext.uiState);
            // this.setUiStateProperty(to, param[from], currentFrameContext.uiState);
        }
    };
    Subscription.prototype.getFrameContext = function (targetFrameContextId, currentContext) {
        var destContext = null;
        try {
            destContext = currentContext.appContext.getFrameContext(targetFrameContextId);
        }
        catch (_a) {
            throw new Error('Error in Getting FrameContext');
        }
        return destContext;
    };
    Subscription.prototype.setUiStateProperty = function (propertyName, propertyValue, uiState) {
        try {
            uiState.setPropertyValue(propertyName, propertyValue);
        }
        catch (_a) {
            throw new Error("Error in Setting Property Value of the current UISTATE" + uiState);
        }
    };
    Subscription.decorators = [
        { type: Injectable }
    ];
    return Subscription;
}());
export { Subscription };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3Vic2NyaXB0aW9uLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZXZlbnQtbWVjaGFuaXNtL3N1YnNjcmlwdGlvbi9zdWJzY3JpcHRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBWSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFHcEQsT0FBTyxFQUFFLGVBQWUsRUFBNEIsTUFBTSwwQkFBMEIsQ0FBQztBQUdyRjtJQUFBO0lBK0lBLENBQUM7SUE1SUM7O09BRUc7SUFDSSwyQkFBSSxHQUFYLFVBQVksY0FBOEI7UUFDeEMsSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUNuQixPQUFPO1NBQ1I7UUFFRCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUdEOzs7OztPQUtHO0lBQ0ksNENBQXFCLEdBQTVCLFVBQTZCLGNBQThCLEVBQUUsUUFFNUQ7UUFDQyxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ25CLE9BQU87U0FDUjtRQUVELE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGNBQWMsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSSx1Q0FBZ0IsR0FBdkIsVUFBd0IsY0FBOEIsRUFBRSxRQUV2RDtRQUZELGlCQStDQztRQTVDQyxJQUFNLE9BQU8sR0FBRyxjQUFjLENBQUMsT0FBTyxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDWixPQUFPO1NBQ1I7UUFFRCxJQUFNLG1CQUFtQixHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ25GLElBQUksQ0FBQyxtQkFBbUIsRUFBRTtZQUN4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LEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUM5RCx5RUFBeUU7U0FDMUU7SUFDSCxDQUFDO0lBRU8sc0NBQWUsR0FBdkIsVUFBd0Isb0JBQTRCLEVBQUUsY0FBNEI7UUFDaEYsSUFBSSxXQUFXLEdBQWlCLElBQUksQ0FBQztRQUNyQyxJQUFJO1lBQ0YsV0FBVyxHQUFHLGNBQWMsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLG9CQUFvQixDQUFDLENBQUM7U0FDL0U7UUFBQyxXQUFNO1lBQ04sTUFBTSxJQUFJLEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO1NBQ2xEO1FBQ0QsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztJQUVPLHlDQUFrQixHQUExQixVQUEyQixZQUFvQixFQUFFLGFBQXFCLEVBQUUsT0FBZ0I7UUFDdEYsSUFBSTtZQUNGLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLEVBQUUsYUFBYSxDQUFDLENBQUM7U0FDdkQ7UUFBQyxXQUFNO1lBQ04sTUFBTSxJQUFJLEtBQUssQ0FBQyx3REFBd0QsR0FBRyxPQUFPLENBQUMsQ0FBQztTQUNyRjtJQUNILENBQUM7O2dCQTdJRixVQUFVOztJQStJWCxtQkFBQztDQUFBLEFBL0lELElBK0lDO0FBRUQsT0FBTyxFQUFFLFlBQVksRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTWV0YWRhdGFVdGlsIH0gZnJvbSAnLi4vLi4vbWV0YWRhdGEvaW5kZXgnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQsIEZyYW1lQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vZnJhbWUvaW5kZXgnO1xyXG5pbXBvcnQgeyBVSVN0YXRlIH0gZnJvbSAnLi4vLi4vdWktc3RhdGUvaW5kZXgnO1xyXG5pbXBvcnQgeyBOR19TVUJTQ1JJUFRJT04sIE5nU3Vic2NyaXB0aW9uLCBQYXJhbU1hcCB9IGZyb20gJy4vc3Vic2NyaXB0aW9uX2RlY29yYXRvcic7XHJcbmltcG9ydCB7IElEaXNwb3NhYmxlIH0gZnJvbSAnLi4vLi4vY29yZS9pbmRleCc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmNsYXNzIFN1YnNjcmlwdGlvbiB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIneWni+WMllxyXG4gICAqL1xyXG4gIHB1YmxpYyBpbml0KGZyYW1lQ29tcG9uZW50OiBGcmFtZUNvbXBvbmVudCk6IElEaXNwb3NhYmxlW10ge1xyXG4gICAgaWYgKCFmcmFtZUNvbXBvbmVudCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuYmluZFN1YnNjcmlwdGlvbihmcmFtZUNvbXBvbmVudCwgbnVsbCk7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogIOagueaNruiuoumYheWIl+ihqOi/m+ihjOWIneWni+WMllxyXG4gICAqIEBwYXJhbSBmcmFtZUNvbXBvbmVudCBcclxuICAgKiBAcGFyYW0gbmdFdmVudHMg6K6i6ZiF5YiX6KGoXHJcbiAgICogQHJldHVybnMgZXZlbnRQaXBlc1xyXG4gICAqL1xyXG4gIHB1YmxpYyBpbml0V2l0aFN1YnNjcmlwdGlvbnMoZnJhbWVDb21wb25lbnQ6IEZyYW1lQ29tcG9uZW50LCBuZ0V2ZW50czoge1xyXG4gICAgW3Byb3BOYW1lOiBzdHJpbmddOiBhbnk7XHJcbiAgfSk6IElEaXNwb3NhYmxlW10ge1xyXG4gICAgaWYgKCFmcmFtZUNvbXBvbmVudCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuYmluZFN1YnNjcmlwdGlvbihmcmFtZUNvbXBvbmVudCwgbmdFdmVudHMpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5pu05pS55oiQ5Li6cHVibGlj5b2i5byPIOebrueahOS4uuS6huino+aekOihqOWNleWPr+S7pei/m+ihjOmHjeaWsOe7keWumlxyXG4gICAqIEBwYXJhbSBmcmFtZUNvbXBvbmVudCBcclxuICAgKiBAcGFyYW0gbmdFdmVudHMgXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIGJpbmRTdWJzY3JpcHRpb24oZnJhbWVDb21wb25lbnQ6IEZyYW1lQ29tcG9uZW50LCBuZ0V2ZW50czoge1xyXG4gICAgW3Byb3BOYW1lOiBzdHJpbmddOiBhbnk7XHJcbiAgfSkge1xyXG4gICAgY29uc3QgY29udGV4dCA9IGZyYW1lQ29tcG9uZW50LmNvbnRleHQ7XHJcbiAgICBpZiAoIWNvbnRleHQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG5nRXZlbnRIYW5kbGVyUHJvcHMgPSBuZ0V2ZW50cyA/IG5nRXZlbnRzIDogdGhpcy5nZXROZ0V2ZW50cyhmcmFtZUNvbXBvbmVudCk7XHJcbiAgICBpZiAoIW5nRXZlbnRIYW5kbGVyUHJvcHMpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGV2ZW50UGlwZXM6IElEaXNwb3NhYmxlW10gPSBbXTtcclxuICAgIE9iamVjdC5rZXlzKG5nRXZlbnRIYW5kbGVyUHJvcHMpLmZvckVhY2goKHByb3BlcnR5TmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5nSW1wb3J0RXZlbnQ6IE5nU3Vic2NyaXB0aW9uID0gbmdFdmVudEhhbmRsZXJQcm9wc1twcm9wZXJ0eU5hbWVdO1xyXG5cclxuICAgICAgLy8g6I635Y+W5b6F6K6i6ZiF5pa55rOV6K+m5oOF77yM5bCd6K+V5omn6KGM6K6i6ZiFXHJcbiAgICAgIGNvbnN0IHRhcmdldENvbnRleHQgPSBjb250ZXh0O1xyXG5cclxuICAgICAgY29uc3QgcmVjZWl2ZXIgPSBmcmFtZUNvbXBvbmVudDtcclxuICAgICAgY29uc3QgZW1pdHRlciA9IG5nSW1wb3J0RXZlbnQudG9rZW47XHJcbiAgICAgIGNvbnN0IHRva2VuVmFsdWUgPSBuZ0ltcG9ydEV2ZW50LnRva2VuO1xyXG4gICAgICBjb25zdCBldmVudE5hbWUgPSBuZ0ltcG9ydEV2ZW50Lm5hbWU7XHJcblxyXG4gICAgICBjb25zdCBwYXJhbU1hcENvbGxlY3Rpb24gPSBuZ0ltcG9ydEV2ZW50LnBhcmFtTWFwQ29sbGVjdGlvbjtcclxuICAgICAgY29uc3QgZXZlbnRQaXBlID0gdGFyZ2V0Q29udGV4dC5ldmVudEJ1cy5vbihlbWl0dGVyLCB0b2tlblZhbHVlLCBldmVudE5hbWUsIHJlY2VpdmVyLFxyXG4gICAgICAgIChldmVudEFyZ3MpID0+IHtcclxuICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uSGFuZGxlcihldmVudEFyZ3MsIHBhcmFtTWFwQ29sbGVjdGlvbiwgdGFyZ2V0Q29udGV4dCk7XHJcblxyXG4gICAgICAgICAgY29uc3QgZXZlbnRIYW5kbGVyOiBGdW5jdGlvbiA9IGZyYW1lQ29tcG9uZW50W2V2ZW50TmFtZV07XHJcbiAgICAgICAgICBpZiAoIWV2ZW50SGFuZGxlcikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgZXZlbnRIYW5kbGVyKHJlY2VpdmVyLCBldmVudEFyZ3MpO1xyXG4gICAgICAgICAgfSBjYXRjaCB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRXJyb3IgaW52b2tpbmcgbWV0aG9kICcgKyBldmVudE5hbWUpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgKTtcclxuXHJcbiAgICAgIGV2ZW50UGlwZXMucHVzaChldmVudFBpcGUpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGV2ZW50UGlwZXM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bnu4Tku7borqLpmIXliJfooahcclxuICAgKiBAcGFyYW0gZnJhbWVDb21wb25lbnQg6KGo5Y2VY29tcG9uZW50XHJcbiAgICogQHJldHVybnMg57uE5Lu26K6i6ZiF5YiX6KGo5L+h5oGvXHJcbiAgICovXHJcbiAgcHVibGljIGdldE5nRXZlbnRzKGZyYW1lQ29tcG9uZW50OiBGcmFtZUNvbXBvbmVudCkge1xyXG4gICAgcmV0dXJuIE1ldGFkYXRhVXRpbC5nZXRQcm9wc01ldGFkYXRhc0J5TmFtZShmcmFtZUNvbXBvbmVudC5jb25zdHJ1Y3RvciwgTkdfU1VCU0NSSVBUSU9OKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc3Vic2NyaXB0aW9uSGFuZGxlcihwYXJhbTogYW55LCBwYXJhbU1hcENvbGxlY3Rpb246IFBhcmFtTWFwW10sIGN1cnJlbnRGcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkge1xyXG5cclxuICAgIGlmICghcGFyYW0gfHwgIXBhcmFtTWFwQ29sbGVjdGlvbiB8fCBwYXJhbU1hcENvbGxlY3Rpb24ubGVuZ3RoIDw9IDAgfHwgIWN1cnJlbnRGcmFtZUNvbnRleHQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucGFyYW1NYXAyVWlTdGF0ZShwYXJhbSwgcGFyYW1NYXBDb2xsZWN0aW9uLCBjdXJyZW50RnJhbWVDb250ZXh0KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuvue9rnBhcmFtTWFw5ZCO77yM5bCGcGFyYW3mmKDlsITliLBVSVNUQVRF5LiKXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBwYXJhbU1hcDJVaVN0YXRlKHBhcmFtOiBhbnksIHBhcmFtTWFwQ29sbGVjdGlvbjogUGFyYW1NYXBbXSwgY3VycmVudEZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSB7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcmFtTWFwQ29sbGVjdGlvbi5sZW5ndGg7IGkrKykge1xyXG4gICAgICBjb25zdCBmcm9tID0gcGFyYW1NYXBDb2xsZWN0aW9uW2ldLmZyb207XHJcbiAgICAgIGNvbnN0IGZyYW1lSWQgPSBwYXJhbU1hcENvbGxlY3Rpb25baV0uZnJhbWVJZDtcclxuICAgICAgY29uc3QgdG8gPSBwYXJhbU1hcENvbGxlY3Rpb25baV0udG87XHJcblxyXG4gICAgICBpZiAoIWZyb20gfHwgIWZyYW1lSWQgfHwgIXRvKSB7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgZGVzdENvbnRleHQ6IEZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0RnJhbWVDb250ZXh0KGZyYW1lSWQsIGN1cnJlbnRGcmFtZUNvbnRleHQpO1xyXG4gICAgICBpZiAoZGVzdENvbnRleHQgPT0gbnVsbCkge1xyXG4gICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuc2V0VWlTdGF0ZVByb3BlcnR5KHRvLCBwYXJhbVtmcm9tXSwgZGVzdENvbnRleHQudWlTdGF0ZSk7XHJcbiAgICAgIC8vIHRoaXMuc2V0VWlTdGF0ZVByb3BlcnR5KHRvLCBwYXJhbVtmcm9tXSwgY3VycmVudEZyYW1lQ29udGV4dC51aVN0YXRlKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0RnJhbWVDb250ZXh0KHRhcmdldEZyYW1lQ29udGV4dElkOiBzdHJpbmcsIGN1cnJlbnRDb250ZXh0OiBGcmFtZUNvbnRleHQpOiBGcmFtZUNvbnRleHQge1xyXG4gICAgbGV0IGRlc3RDb250ZXh0OiBGcmFtZUNvbnRleHQgPSBudWxsO1xyXG4gICAgdHJ5IHtcclxuICAgICAgZGVzdENvbnRleHQgPSBjdXJyZW50Q29udGV4dC5hcHBDb250ZXh0LmdldEZyYW1lQ29udGV4dCh0YXJnZXRGcmFtZUNvbnRleHRJZCk7XHJcbiAgICB9IGNhdGNoIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdFcnJvciBpbiBHZXR0aW5nIEZyYW1lQ29udGV4dCcpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGRlc3RDb250ZXh0O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXRVaVN0YXRlUHJvcGVydHkocHJvcGVydHlOYW1lOiBzdHJpbmcsIHByb3BlcnR5VmFsdWU6IHN0cmluZywgdWlTdGF0ZTogVUlTdGF0ZSkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgdWlTdGF0ZS5zZXRQcm9wZXJ0eVZhbHVlKHByb3BlcnR5TmFtZSwgcHJvcGVydHlWYWx1ZSk7XHJcbiAgICB9IGNhdGNoIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRXJyb3IgaW4gU2V0dGluZyBQcm9wZXJ0eSBWYWx1ZSBvZiB0aGUgY3VycmVudCBVSVNUQVRFXCIgKyB1aVN0YXRlKTtcclxuICAgIH1cclxuICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQgeyBTdWJzY3JpcHRpb24gfTtcclxuIl19