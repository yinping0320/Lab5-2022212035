!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("lodash-es"),require("moment"),require("immutable"),require("@angular/forms"),require("validator"),require("date-fns"),require("@angular/common/http"),require("@farris/rtf"),require("@angular/router"),require("@farris/expression-engine"),require("bignumber.js"),require("rxjs/operators"),require("rxjs"),require("@angular/core")):"function"==typeof define&&define.amd?define("@farris/devkit",["exports","lodash-es","moment","immutable","@angular/forms","validator","date-fns","@angular/common/http","@farris/rtf","@angular/router","@farris/expression-engine","bignumber.js","rxjs/operators","rxjs","@angular/core"],e):e((t.farris=t.farris||{},t.farris.devkit={}),t.lodashEs,t.moment,t.immutable,t.ng.forms,t.ValidatorJS,t.dateFns,t.ng.common.http,t.rtf,t.ng.router,t.expressionEngine,t.bignumber_js,t.rxjs.operators,t.rxjs,t.ng.core)}(this,function(x,o,i,e,a,t,s,p,u,c,l,y,d,g,m){"use strict";i=i&&i.hasOwnProperty("default")?i["default"]:i;var n="default"in t?t["default"]:t,r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function f(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var E=function(){return(E=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function h(r,i){var o,a,s,t,p={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:e(0),"throw":e(1),"return":e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function n(t){if(o)throw new TypeError("Generator is already executing.");for(;p;)try{if(o=1,a&&(s=2&t[0]?a["return"]:t[0]?a["throw"]||((s=a["return"])&&s.call(a),0):a.next)&&!(s=s.call(a,t[1])).done)return s;switch(a=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return p.label++,{value:t[1],done:!1};case 5:p.label++,a=t[1],t=[0];continue;case 7:t=p.ops.pop(),p.trys.pop();continue;default:if(!(s=0<(s=p.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){p=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){p.label=t[1];break}if(6===t[0]&&p.label<s[1]){p.label=s[1],s=t;break}if(s&&p.label<s[2]){p.label=s[2],p.ops.push(t);break}s[2]&&p.ops.pop(),p.trys.pop();continue}t=i.call(r,p)}catch(e){t=[6,e],a=0}finally{o=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([e,t])}}}function P(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function v(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),a=[];try{for(;(void 0===e||0<e--)&&!(r=o.next()).done;)a.push(r.value)}catch(s){i={error:s}}finally{try{r&&!r.done&&(n=o["return"])&&n.call(o)}finally{if(i)throw i.error}}return a}function b(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(v(arguments[e]));return t}var C="__annotations__",I="__parameters__",T="__prop__metadata__";function M(t,e,n,i,o){var a=S(e);function s(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(this instanceof s)return a.call.apply(a,b([this],e)),this;var n=new(s.bind.apply(s,b([void 0],e))),r=function(t){return o&&o.apply(void 0,b([t],e)),(t.hasOwnProperty(C)?t[C]:Object.defineProperty(t,C,{value:[]})[C]).push(n),t};return i&&i(r),r}return n&&(s.prototype=Object.create(n.prototype)),s.prototype.ngMetadataName=t,s.annotationCls=s}function S(i){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(i){var n=i.apply(void 0,b(t));for(var r in n)this[r]=n[r]}}}function j(t,e,n){var r=S(e);function o(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(this instanceof o)return r.apply(this,t),this;var i=new(o.bind.apply(o,b([void 0],t)));return function(t,e){var n=t.constructor,r=n.hasOwnProperty(T)?n[T]:Object.defineProperty(n,T,{value:{}})[T];r[e]=r.hasOwnProperty(e)&&r[e]||[],r[e].unshift(i)}}return n&&(o.prototype=Object.create(n.prototype)),o.prototype.ngMetadataName=t,o.annotationCls=o}var w=(O.getClassMetadatas=function(t){return t[C]},O.getClassMetadataByName=function(t,e){return this.getClassMetadataByNameWithTranslate(t,e,null,null)},O.getClassMetadataByNameWithTranslate=function(t,e,n,r){var i=this.getClassMetadatas(t);if(!i)return null;var o=i.find(function(t){return t.ngMetadataName===e});return this.translateMetadataByName(o,n,r),o},O.getPropsMetadatas=function(t){return t[T]},O.getPropsMetadatasByName=function(t,e){return this.getPropsMetadatasByNameWithTranslate(t,e)},O.getPropsMetadatasByNameWithTranslate=function(t,n,e,r){var i={},o=this.getPropsMetadatas(t);return o&&(Object.keys(o).forEach(function(t){var e=o[t].find(function(t){return t.ngMetadataName===n});e&&(i[t]=e)}),this.translateMetadatasByName(i,e,r)),i},O.translateMetadatasByName=function(e,n,r){var i=this;return Object.keys(e).forEach(function(t){i.translateMetadataByName(e[t],n,r)}),e},O.translateMetadataByName=function(i,o,t){return i&&o&&t&&t.forEach(function(t){var e=i[t];try{if(e&&e.startsWith("{{")&&e.endsWith("}}")){var n=e.replace("{{","").replace("}}","").trim();i[t]=o.transform(n,null)}}catch(r){console.info(r)}}),i},O.getPropMetadatasByName=function(t,e){return null},O.getPropMetadataByName=function(t,e,n){return null},O);function O(){}var N,D=function mp(t,e,n,r,i){this.type=e,this.value=t,this.preValue=r,this.path=n,this.position=i};(N=x.ModifyType||(x.ModifyType={})).Add="ADD",N.AddData="AddData",N.Clone="CLONE",N.Remove="REMOVE",N.RemoveData="RemoveData",N.ValueChange="VALUE_CHANGE",N.Load="LOAD",N.UnChanged="UNCHANGED",N.PaginationInfoChange="PAGINATION_INFO_CHANGE",N.Insert="Insert",N.Update="UPDATE";var V=(Object.defineProperty(F.prototype,"changes",{get:function(){return this.modifications},enumerable:!0,configurable:!0}),F.prototype.append=function(t){switch(t.type){case x.ModifyType.ValueChange:this.appendValueChangeModification(t);break;case x.ModifyType.Add:case x.ModifyType.Insert:case x.ModifyType.Clone:this.appendAddModification(t);break;case x.ModifyType.Remove:this.appendRemoveModification(t);break;case x.ModifyType.Load:}},F.prototype.appendValueChangeModification=function(t){var e=t.value,n=(t.path.join("/"),this.findModifyItemsPath(t.path));if(n)n.value=e;else{var r=this.findNewAddItemsPath(t.path);r?r.value=Object.assign({},r.value,e):this.modifications.push(t)}},F.prototype.appendAddModification=function(t){var e=t.value,n=(t.path.join("/"),this.findNewAddItemsPath(t.path));n?n.value=n.value.concat(e):this.modifications.push(t)},F.prototype.appendRemoveModification=function(t){var e=t.path,n=Object.keys(t.value)[0],r=t.value[n];this.modifications.forEach(function(t){t.type!==x.ModifyType.Add&&t.type!==x.ModifyType.Insert&&t.type!==x.ModifyType.Clone||!1!==o.isEqual(t.path,e)&&(t.value=t.value.filter(function(t){return t[n]!==r}))});var i=e.concat(n+":"+r);this.modifications=this.modifications.filter(function(t){if(t.type!==x.ModifyType.ValueChange)return!0;var e=Array.from(t.path);return e.pop(),!o.isEqual(e,i)}),this.removeDescendantRemoveModifications(t),this.modifications.push(t)},F.prototype.clear=function(){this.modifications=[]},F.prototype.findNewAddItemsPath=function(n){return this.modifications.find(function(t,e){return o.isEqual(n,t.path)&&(t.type===x.ModifyType.Add||t.type===x.ModifyType.Insert||t.type===x.ModifyType.Clone)})},F.prototype.findModifyItemsPath=function(n){return this.modifications.find(function(t,e){return o.isEqual(n,t.path)&&t.type===x.ModifyType.ValueChange})},F.prototype.removeDescendantRemoveModifications=function(t){var n=this,r=this.createRemovePathWithId(t);this.modifications=this.modifications.filter(function(t){if(t.type!==x.ModifyType.Remove)return!0;var e=n.createRemovePathWithId(t);return!n.isDescendantPath(r,e)})},F.prototype.createRemovePathWithId=function(t){var e=t.path,n=Object.keys(t.value)[0],r=t.value[n];return e.concat([n+":"+r])},F.prototype.isDescendantPath=function(t,n){if(t.length>n.length)return!1;var r=!0;return t.forEach(function(t,e){t===n[e]||(r=!1)}),r},F);function F(){this.modifications=[]}function R(t){if("object"==typeof t&&null!==t&&"[object Object]"===Object.prototype.toString.call({})){if(null===Object.getPrototypeOf(t))return 1;for(var e=t;null!==Object.getPrototypeOf(e);)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e}}var _="NgField";var B=j(_,function vp(t){var e={primary:!1,foreign:!1};if(t)switch(typeof t){case"boolean":e.primary=Boolean(t);break;case"string":e.dataField=String(t);break;case"object":e=Object.assign(e,t)}return e}),A="NgList";var L=j(A,function Ep(t){if(R(t))return t;var e=typeof t;return"string"==e?{dataField:t}:"function"==e?{type:t}:void 0}),k="NgObject";var $=j(k,function bp(t){if(R(t))return t;var e=typeof t;return"string"==e?{dataField:t}:"function"==e?{type:t}:void 0}),U="NgDynamic";var K=j(U,function Cp(t){if(R(t))return t;var e=typeof t;return"string"==e?{dataField:t}:"function"==e?{type:t}:void 0}),H="NgEntity";var G=(q.getNgFields=function(t){return w.getPropsMetadatasByName(t,_)},q.getNgField=function(t,e){return this.getNgFields(t)[e]},q.getDataField=function(t,e){return this.getNgField(t,e).dataField||e},q.getNgObjects=function(t){return w.getPropsMetadatasByName(t,k)},q.getNgDynamic=function(t){return w.getPropsMetadatasByName(t,U)},q.getNgList=function(t){return w.getPropsMetadatasByName(t,A)},q.getPrimaryFieldMetadata=function(t){var e=q.getNgFields(t),n=Object.keys(e).find(function(t){return e[t].primary});if(n){var r=e[n];return r.property=n,r.dataField||(r.dataField=n),r}return undefined},q.getPrimaryKey=function(t){var e=this.getPrimaryFieldMetadata(t);return e?e.property:""},q.getValidationMetadata=function(n){var r=q.getNgFields(n),i={};return Object.keys(r).forEach(function(e){if(!r[e].primary&&!r[e].foreign){var t=r[e].validRules;t&&t.length&&(t.map(function(t){t.property=e,t.targetName=n.name}),i[e]=t)}}),i},q.getValidationMetadataWithPath=function(t){var i=t.constructor,o=q.getNgFields(i),a=t.getPaths().path||[],s={};return Object.keys(o).forEach(function(e){if(!o[e].primary&&!o[e].foreign){var t=o[e].validRules;if(t&&t.length){var n=a.concat([]);n.push(e);var r=n.join(".");t.map(function(t){t.property=e,t.targetName=i.name,t.path=r}),s[e]=t}}}),s},q);function q(){}var z=(J.getAllNgProperties=function(t){var e=this.getNgFieldProperties(t),n=this.getNgObjectProperties(t),r=this.getNgDynamicProperties(t),i=this.getNgObjectProperties(t);return Object.assign({},e,n,r,i)},J.getNgEntityMatadata=function(t){return w.getClassMetadataByNameWithTranslate(t,H)},J.getNgFieldProperties=function(t){return w.getPropsMetadatasByName(t,_)},J.getNgObjectProperties=function(t){return w.getPropsMetadatasByName(t,k)},J.getNgDynamicProperties=function(t){return w.getPropsMetadatasByName(t,U)},J.getNgListProperties=function(t){return w.getPropsMetadatasByName(t,A)},J.getPrimaryKeyProperty=function(t){var n,r=J.getNgFieldProperties(t);return Object.keys(r).forEach(function(t){var e=r[t];!0===e.primary&&(n=e)}),n},J);function J(){}var W="__PARENT_PATH__",Y="__PARENT__";function Z(t,e){return X.create(t,e)}var X=(Q.create=function(t,e){var n=new(this.getType(t))(e);return n.constructor=t,n},Q.createType=function(t){var e,n=(f(r,e=Wn),r);function r(t){return e.call(this,t)||this}var i=n.prototype;return this.extendProperties(t,i),n},Q.extendProperties=function(t,e){var n=G.getNgFields(t),r=G.getNgObjects(t),i=G.getNgList(t),o=G.getNgDynamic(t);this.extendPlainProperty(e,n),this.extendListProperty(e,i),this.extendObjectProperty(e,r),this.extendDynamicProperty(e,o)},Q.extendPlainProperty=function(t,e){Object.keys(e).forEach(function(r){var i=e[r];Object.defineProperty(t,r,{get:function(){return this.getPropValue(r,i)},set:function(t){var e=this.getPropValue(r,i);if(!1!==this.isPropValueChanged(r,i,t,e)){this.setPropValue(r,i,t);var n=this.preparePropValue(r,i,t);this.emitValueChange(r,i,t,e,n)}}})})},Q.extendListProperty=function(t,u){Object.keys(u).forEach(function(s){var p="__"+s+"__";Object.defineProperty(t,s,{get:function(){var e=this,n=this[p];if(!n){var r=u[s],t=this.createPath(s),i=r.dataField||s,o=this.data[i];if((n=new mt)[Y]=this,n[W]=t,o){var a=o.map(function(t){return Z(r.type,t)});n.loadEntities(a)}n.onListChanged.subscribe(function(t){t&&(n[W][0]!==t.path[0]&&(t.path=n[W].concat(t.path)),e.setChanges(t))}),this[p]=n}return n},set:function(t){this[p]=t}})})},Q.extendObjectProperty=function(t,e){Object.keys(e).forEach(function(i){var o=e[i],a="__"+i+"__";Object.defineProperty(t,i,{get:function(){var t=this[a],e=this.createPath(i);if(!t){var n=o.dataField||i,r=this.data[n]||{};t=Q.buildEntity(e,r,this,o),this[a]=t}return t},set:function(t){var e=this.createPath(i),n={path:e,value:t.data,preValue:this[i].data,type:x.ModifyType.ValueChange},r=Q.buildEntity(e,t,this,o);this[a]=r,this.setChanges(n)}})})},Q.extendDynamicProperty=function(t,e){Object.keys(e).forEach(function(i){var o=e[i],a="__"+i+"__";Object.defineProperty(t,i,{get:function(){var t=this[a],e=this.createPath(i);if(!t){var n=o.dataField||i,r=this.data[n]||{};t=Q.buildDynamic(e,r,this,o),this[a]=t}return t},set:function(t){var e=this.createPath(i),n={path:e,value:t.data,preValue:this[i].data,type:x.ModifyType.ValueChange},r=Q.buildDynamic(e,t,this,o);this[a]=r,this.setChanges(n)}})})},Q.getType=function(t){if(this.buffer.has(t))return this.buffer.get(t);var e=this.createType(t);return this.buffer.set(t,e),e},Q.buildEntity=function(t,e,n,r){var i;return(i=e instanceof r.type?e:Z(r.type,e))[Y]=n,i[W]=t,i.onValueChanged.subscribe(function(t){if(t){t.path=(n[W]||[]).concat(t.path);var e=Object.assign({},t,{fromParent:!0});n.setChanges(e)}}),i},Q.buildDynamic=function(t,e,n,r){var i;return(i=e instanceof r.type?e:function o(t,e){return new t(e)}(r.type,e))[Y]=n,i[W]=t,i.onValueChanged.subscribe(function(t){t&&(t.path=(n[W]||[]).concat(t.path),n.setChanges(t))}),i},Q.buffer=new Map,Q);function Q(){}function tt(t,e){var n;return(n=t&&t.prototype&&"ConcreteEntityPrototype"===t.prototype.typeName?new t(e):X.create(t,e)).constructor=t,n}function et(n,t){var r=[];return t.forEach(function(t){var e=tt(n,t);r.push(e)}),r}function nt(t,e){return new t(e)}var rt={},it=(ot.isValidType=function(t){var e=this;return"isValidType"!==t&&"getMessage"!==t&&-1!==Object.keys(this).map(function(t){return e[t]}).indexOf(t)},ot.getMessage=function(t){return(rt[this.CURRENT_LANGUAGE]||rt["zh-CHS"])[t]||""},ot.setCurrentLanguage=function(t){this.CURRENT_LANGUAGE=t},ot.CURRENT_LANGUAGE="zh-CNS",ot.CUSTOM_VALIDATION="customValidation",ot.REQUIRED="required",ot.EQUALS="equals",ot.NOT_EQUALS="notEquals",ot.IS_NUMBER="isNumber",ot.IS_INT="isInt",ot.IS_FLOAT="isFloat",ot.IS_STRING="isString",ot.IS_BOOLEAN="isBoolean",ot.IS_DATE="isDate",ot.IS_DATE_STRING="isDateString",ot.IS_BOOLEAN_STRING="isBooleanString",ot.IS_NUMBER_STRING="isNumberString",ot.IS_EMAIL="isEmail",ot.IS_JSON="isJSON",ot.IS_LOWERCASE="isLowercase",ot.IS_UPPERCASE="isUppercase",ot.RANGE="range",ot.MIN="min",ot.MINVALUE="minValue",ot.MAX="max",ot.MAXVALUE="maxValue",ot.LENGTH="length",ot.MAX_LENGTH="maxLength",ot.MIN_LENGTH="minLength",ot.MIN_DATE="minDate",ot.MAX_DATE="maxDate",ot.EXCLUDE="exclude",ot.MATCHES="matches",ot.FIELD_CONTAINER="fieldContainer",ot);function ot(){}rt["zh-CHS"]={fieldContainer:"$target 第 $value 行",required:"请输入'$property'",equals:"'$property'的值与$constraint1不相等",notEquals:"'$property'的值不能与'$constraint1'相同",isNumber:"'$property'的值不是数字",isInt:"'$property'的值不是整数",isFloat:"'$property'的值不是浮点型数字",isBoolean:"'$property'的值不是布尔值",isDate:"'$property'的值不是有效日期",isEmail:"邮箱地址不正确",min:"'$property'的值不应小于$constraint1",minValue:"'$property'的值不应小于$constraint1",minDate:"'$property'的日期不应早于$constraint1",max:"'$property'的值不应大于$constraint1",maxValue:"'$property'的值不应大于$constraint1",maxDate:"'$property'不应晚于$constraint1",isBooleanString:"'$property'的值不是有效布尔值",isDateString:"'$property'的值不是有效的日期",isLowercase:"'$property'的值应全部为小写字符串",isUppercase:"'$property'的值应全部为大写字符串",length:"'$property'的长度应介于$constraint1~$constraint2之间",range:"'$property'的值应介于$constraint1~$constraint2之间",maxLength:"'$property'的长度不得大于$constraint1",minLength:"'$property'的长度不得小于$constraint1",isNumberString:"'$property'的值不是数字",exclude:"'$property'的值不能包含：$constraint1",matches:"'$property'校验不通过"},rt.en={fieldContainer:"$target row $value",required:"Please input '$property'",equals:"'$property' should equals '$constraint1'",notEquals:"'$property' should not equals '$constraint1'",isNumber:"'$property' should be number",isInt:"'$property' should be integer",isFloat:"'$property' should be float",isBoolean:"'$property' should be boolean",isDate:"'$property' should be date",isEmail:"'$property' should be e-mail address",min:"'$property' should not less than $constraint1",minValue:"'$property' should not less than $constraint1",minDate:"'$property' should not early than $constraint1",max:"'$property' should not bigger than $constraint1",maxValue:"'$property' should not bigger than $constraint1",maxDate:"'$property' should not late than $constraint1",isBooleanString:"'$property' should be boolean string",isDateString:"'$property' should be date string",isLowercase:"'$property' should be lowercase charactor",isUppercase:"'$property' should be uppercase charactor",length:"'$property' length should between $constraint1~$constraint2之间",range:"'$property' value should between $constraint1~$constraint2之间",maxLength:"'$property' should not longer than $constraint1",minLength:"'$property' should not shorter than $constraint1",isNumberString:"'$property' should be number string",exclude:"'$property' should not include $constraint1",matches:"'$property' calibration failed"},rt["zh-CHT"]={fieldContainer:"$target 第 $value 行",required:"請輸入'$property'",equals:"'$property'的值與$constraint1不相等",notEquals:"'$property'的值不能與'$constraint1'相同",isNumber:"'$property'的值不是數字",isInt:"'$property'的值不是整數",isFloat:"'$property'的值不是浮點型數字",isBoolean:"'$property'的值不是佈爾值",isDate:"'$property'的值不是有效日期",isEmail:"郵箱地址不正確",min:"'$property'的值不應小於$constraint1",minValue:"'$property'的值不應小於$constraint1",minDate:"'$property'的日期不應早於$constraint1",max:"'$property'的值不應大於$constraint1",maxValue:"'$property'的值不應大於$constraint1",maxDate:"'$property'不應晚於$constraint1",isBooleanString:"'$property'的值不是有效佈爾值",isDateString:"'$property'的值不是有效的日期",isLowercase:"'$property'的值應全部爲小冩字符串",isUppercase:"'$property'的值應全部爲大冩字符串",length:"'$property'的長度應介於$constraint1~$constraint2之間",range:"'$property'的值應介於$constraint1~$constraint2之間",maxLength:"'$property'的長度不得大於$constraint1",minLength:"'$property'的長度不得小於$constraint1",isNumberString:"'$property'的值不是數字",exclude:"'$property'的值不能包含：$constraint1",matches:"'$property'校驗不通過"};var at=function xp(){this.isArray=!1,this.index=undefined},st=(pt.replaceMessageSpecialTokens=function(t,e,n){var r;return t instanceof Function?r=t(e):"string"==typeof t&&(r=t),r&&e.constraints instanceof Array&&e.constraints.forEach(function(t,e){r=r.replace(new RegExp("\\$constraint"+(e+1),"g"),t)}),r&&n!==undefined&&null!==n&&(r=r.replace(/\$value/g,n)),r=(r=r&&r.replace(/\$property/g,e.property))&&r.replace(/\$target/g,e.targetName)},pt.prototype.execute=function(h,y,d,e,g,t,m,o){var v=this;!t&&o&&(t=o.form.getValidationRules());var E=G.getValidationMetadataWithPath(h),a=new Map;if(t){for(var n=[],r=h;r&&r!==r.__PARENT__;){var i=r.__PARENT_PATH__?r.__PARENT_PATH__[1]:"";n.push(i),(r=r.__PARENT__)instanceof mt&&(r=r.__PARENT__)}var s=n.reverse().join("/");t.forEach(function(e,t){if(t){var n=t.split("/"),r=n.pop(),i=n.join("/");if(s===i){if(E[r]=b(E[r]||[]),e.length){var o="";e.forEach(function(t){t.targetId&&t.targetId.length>o.length&&(o=t.targetId),E[r].push(t)}),E[r].forEach(function(t){t.targetId=o,t.targetName=e[0].targetName,t.property=e[0].property,e[0].frameContext&&(t.frameContext=e[0].frameContext),t.fullPath=e[0].fullPath,t.initialized=!0})}}else a.set(t,e)}})}E&&0<Object.keys(E).length&&Object.keys(E).forEach(function(t){var e=E[t];if(e&&0<e.length){var i=e[0].path;i&&e.forEach(function(t){if(!0!==t.initialized){var e=i.split("."),n=v.getForm(e,o),r=v.getFormControl(e,o);r&&(t.targetId=r.id,t.targetName=n&&n.formGroupName,t.property=r.name||r.defaultI18nValue||"")}})}}),e&&(E=Object.keys(E).filter(function(t){return t===e}).reduce(function(t,e){var n;return Object.assign({},t,((n={})[e]=E[e],n))},{})),Object.keys(E).filter(function(t){return h&&(h.hasOwnProperty(t)||h.constructor.prototype&&h.constructor.prototype.typeName&&h.constructor.prototype.hasOwnProperty(t)||h.__proto__.hasOwnProperty(t))}).forEach(function(t){var e=y;y===undefined&&(e=h[t]);var n=!1,r=v.getMultiLanguageFields(h);r&&0<r.length&&r.includes(t)&&(n=!0);var i=E[t];if(i.length){var o=i[0],a=o.property,s=o.targetId,p=o.frameContext,u=o.fullPath,c=Number.isInteger(g)?pt.replaceMessageSpecialTokens(it.getMessage(it.FIELD_CONTAINER),i[0],g+1):i[0].targetName,l=c?c+" - "+a:""+a,f=v.generateValidationError(h,e,t,l,g,s,p,u);g!==undefined&&(f.index=g),d.push(f),v.defaultValidations(h,e,i,f,n,m)}}),this.objectValidations(h,d,e,g,a,m,o),this.listValidations(h,d,e,g,a,o)},pt.prototype.getMultiLanguageFields=function(t){if(t&&t.constructor){var e=G.getNgFields(t.constructor);return Object.keys(e).filter(function(t){return e[t].enableMultiLangInput})}return null},pt.prototype.stripEmptyErrors=function(t){var e=this;return t.filter(function(t){if(t.children&&(t.children=e.stripEmptyErrors(t.children)),0===Object.keys(t.constraints).length){if(0===t.children.length)return!1;delete t.constraints}return!0})},pt.prototype.generateValidationError=function(t,e,n,r,i,o,a,s){var p=new at;return p.target=t,p.value=e,p.property=n,p.propertyName=r,p.field=o,p.index=i,p.children=[],p.constraints={},a&&(p.frameContext=a),p.fullPath=s,p},pt.prototype.defaultValidations=function(o,a,t,s,n,r){var p=this,u=s.constraints;return t.filter(function(i){var t=p.validator.validateValueByMetadata(o,a,i,n,r);if(t instanceof Promise){var e=t.then(function(t){if(!t){var e=p.createValidationError(o,a,i),n=e.type,r=e.messageString;u[n]=r,s.rule=i}});p.awaitingPromises.push(e)}return!t}).forEach(function(t){var e=p.createValidationError(o,a,t),n=e.type,r=e.messageString;u[n]=r,s.rule=t})},pt.prototype.listValidations=function(i,o,e,a,s,p){var u=this,c="__ACTUAL_INDEX__",l=G.getNgList(i.constructor);if(l){var t=Object.keys(l);e&&(t=t.filter(function(t){return t===e})),t.forEach(function(t){l[t].type;var e=i[t];if(e){var n=i.getPaths().path||[];n.push(t);var r=u.generateValidationError(i,e.items,n.join("."),t,a);r.isArray=!0,o.push(r),e.items.forEach(function(t,e){var n=t[c]?t[c]:e;u.execute(t,undefined,r.children,undefined,n,s,t.primaryValue,p)})}})}},pt.prototype.objectValidations=function(n,r,e,i,o,a,s){var p=this,u=G.getNgObjects(n.constructor);if(u&&!(Object.keys(u).length<1)){var t=Object.keys(u);e&&(t=t.filter(function(t){return t===e})),t.forEach(function(t){u[t].type;var e=n[t];e&&p.execute(e,undefined,r,undefined,i,o,a,s)})}},pt.prototype.createValidationError=function(t,e,n){var r=n.type,i=it.getMessage(r);if(i=i||n.message,it.isValidType(r)&&(r===it.MAXVALUE||r===it.MINVALUE)&&this.isDateString(e)&&n.constraints&&n.constraints.length){var o=r===it.MINVALUE?it.MIN_DATE:it.MAX_DATE;i=it.getMessage(o)}return{type:r,messageString:pt.replaceMessageSpecialTokens(i,n,e),metadata:n}},pt.prototype.getFrameContext=function(t,e){if(!t||t.length<1||!e)return null;var n=t.concat([]);n.pop();var r=n.join("/");return e.appContext.frameContextManager.getFrameContexts().find(function(t){return t&&t.viewModel&&t.viewModel.bindingPath&&t.viewModel.bindingPath.split("/").filter(function(t){return t}).join("/")===r})||null},pt.prototype.getForm=function(t,e){if(!t||t.length<1||!e)return null;var n=this.getFrameContext(t,e);return n&&n.form||null},pt.prototype.getFormControl=function(t,e){if(!t||t.length<1||!e)return null;var n=t.concat([]).pop(),r=this.getFrameContext(t,e);return r&&r.form&&r.form.ngFormControls&&r.form.ngFormControls[n]||null},pt.prototype.isDateString=function(t){return/\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])(T|\s?)?(([0-2]\d:[0-5]\d)?(:[0-5]\d(?:\.\d+)))?(?:Z|\+[0-2]\d(?:\:[0-5]\d)?)?/g.test(t)},pt);function pt(t){this.validator=t,this.awaitingPromises=[]}var ut=(ct.createDetailedErrorMessage=function(t,o,a){return void 0===o&&(o=[]),void 0===a&&(a=""),t.forEach(function(e){var t=e.target?e.target.constructor.name:"",n=e.propertyName,r=function(t){return"   - 属性 "+a+t+" 验证失败的规则:  \n"+Object.keys(e.constraints).map(function(t){return"        #"+t+": "+e.constraints[t]+"\n"}).join("")};if(a){var i=Number.isInteger(+e.index)?"["+e.index+"]."+n:(a?".":"")+n;e.constraints&&o.push(r(i)),e.children.length&&ct.createDetailedErrorMessage(e.children,o,a+i)}else o.push("类型为 "+t+" 的实例对象数据验证失败，详细信息：\n"),e.constraints&&o.push(r(n)),e.children.length&&ct.createDetailedErrorMessage(e.children,o,n)}),o},ct.convertErrorsToNormalObject=function(t,i){return t.forEach(function(t){var e,r,n=t.propertyName;t.isArray?i[n]=(e=t.children,r={},e.forEach(function(t){var e,n;t.children.length?r[t.index]=ct.convertErrorsToNormalObject(t.children,t):r[t.index]?r[t.index]=Object.assign({},r[t.index],((e={})[t.propertyName]=t.constraints,e)):r[t.index]=((n={})[t.propertyName]=t.constraints,n)}),r):t.children.length?i[n]=ct.convertErrorsToNormalObject(t.children,i):i[n]=t.constraints}),i},ct);function ct(){}var lt=(ft.formatISO=function(t){if(!0===this.isEmptyDateOrDateString(t))return this.emptyISODateTimeString;var e=this.parse(t);return s.format(e,this.defaultISOFormat)},ft.format=function(t,e){if(!0===this.isEmptyDateOrDateString(t))return this.emptyISODateTimeString;var n=this.parse(t);return e=e||this.defaultDisplayFormat,s.format(n,e)},ft.parse=function(t){return!0===this.isEmptyDateOrDateString(t)?null:!0===this.isDate(t)?t:s.parseISO(t)},ft.isDate=function(t){return s.isDate(t)},ft.isEmptyDateOrDateString=function(t){return!0===this.isDate(t)?this.isEmptyDate(t):this.isEmptyDateString(t)},ft.isEmptyDate=function(t){return!t},ft.isEmptyDateString=function(t){return!t||!0===t.startsWith("0001-01-01")},ft.isEqual=function(t,e){var n=this.parse(t),r=this.parse(e);return n===r||s.isEqual(n,r)},ft.compare=function(t,e){var n=this.parse(t),r=this.parse(e);return!0===this.isEqual(n,r)?0:n||!0!==this.isDate(r)?r||!0!==this.isDate(n)?s.compareAsc(n,r):1:-1},ft.emptyDateTimeString=null,ft.emptyISODateTimeString=null,ft.defaultISOFormat="yyyy-MM-dd'T'HH:mm:ssxxx",ft.defaultDisplayFormat="yyyy-MM-dd HH:mm:ss",ft.defaultDateFormat="yyyy-MM-dd",ft.defaultTimeFormat="HH:mm:ss",ft);function ft(){}var ht=(yt.setTranslate=function(t){t&&(this.translate=t)},yt.getCurrentLanguage=function(){return this.translate&&this.translate.getCurrentLanguage()||this.defaultLanguage},yt.dispose=function(){this.translate=null},yt.defaultLanguage="zh-CHS",yt.translate=null,yt);function yt(){}var dt=(gt.prototype.validate=function(t,e,n,r,i,o){var a=this,s=[],p=new st(this);return p.execute(t,n,s,e,i,r,null,o),Promise.all(p.awaitingPromises).then(function(){var t=p.stripEmptyErrors(s);return a.sortValidationErrors(t),a.buildErrors(t)})},gt.prototype.sortValidationErrors=function(t){var e=this,n=!0;t.forEach(function(t){t.children&&1<t.children.length&&e.sortValidationErrors(t.children),"number"!=typeof t.index&&(n=!1)}),n&&t.sort(function(t,e){return t.index-e.index})},gt.prototype.verify=function(t,e,n,r,i,o,a){var s=this;void 0===a&&(a=!1);var p=[],u=new st(this);if(u.execute(t,n,p,e,i,r,null,o),u.awaitingPromises&&0<u.awaitingPromises.length&&!1===a)return Promise.all(u.awaitingPromises).then(function(){var t=u.stripEmptyErrors(p);return s.buildErrors(t)});var c=u.stripEmptyErrors(p);return this.buildErrors(c)},gt.prototype.validateValueByMetadata=function(e,n,t,r,i){var o,a=t.type,s=[];if(t.constraints?s=t.constraints.map(function(t){return"function"==typeof t?t(e,n):t}):t.constraints=[],it.isValidType(a)){if(a===it.MAXVALUE){var p=s[0];return this.isDateString(n)||this.isDate(n)||this.isDateString(p)||this.isDate(p)?!n||-1!==n.indexOf("~")||this[it.MAX_DATE](lt.parse(n),r,new Date(s[0])):this[it.MAXVALUE](n,r,s[0])}if(a!==it.MINVALUE)return this[a].apply(this,b([n,r],s));if(null===s[0]||s[0]===undefined)return!0;if(this.isDateString(n)||this.isDate(n))return 0===s[0]||this[it.MIN_DATE](lt.parse(n),r,lt.parse(s[0]));if(this.isNumber(n))return this[it.MIN](n,r,s[0])}else if("function"==typeof t.eval){var u=t.bindingPath.split("/").filter(function(t){return t}),c=t.field;0!==u.length&&(c=u.join("/")+"/"+c.split(".").filter(function(t){return t}).join("/"));var l={patch:((o={})[c]=n,o),currentRows:[]},f=e&&"function"==typeof e.getEntityListPath&&e.getEntityListPath();if(4===f.length){var h=f.slice(1,3).reverse();l.currentRows.push({bindingPath:h[1],primaryValue:h[0].split(":")[1]})}if(i){if(0!==t.bindingPath.split("/").filter(function(t){return t}).length){var y=e&&"function"==typeof e.getMainEntityPrimaryValue&&e.getMainEntityPrimaryValue();l.currentRows.push({bindingPath:"/",primaryValue:y})}l.currentRow={bindingPath:t.bindingPath,primaryValue:i}}else y=e&&"function"==typeof e.getMainEntityPrimaryValue&&e.getMainEntityPrimaryValue(),l.currentRows.push({bindingPath:"/",primaryValue:y});var d=t.eval(l);if("require"!==t.type)return d;var g=this.required(n,r);return!d||g}return!0},gt.prototype.buildErrors=function(t){var e=new Set(ut.createDetailedErrorMessage(t)),n=[];return e.forEach(function(t){n.push(t)}),{isValid:0===t.length,errors:t,message:n.join("")}},gt.prototype.customValidation=function(t,e){return e},gt.prototype.isEmptyValue=function(t){return""===t||null===t||t===undefined||"0001-01-01"===t||"0001-01-01 00:00:00"===t||"0001-01-01T00:00:00"===t},gt.prototype.required=function(t,e){if(e){var n=ht.getCurrentLanguage();return!(Object.keys(t).length<1)&&(!n||!!t[n])}if("object"==typeof t&&null!==t){if(!Object.keys(t).length)return!1;t=Object.values(t)[0]}return""!==t&&null!==t&&t!==undefined&&"0001-01-01"!==t&&"0001-01-01 00:00:00"!==t&&"0001-01-01T00:00:00"!==t},gt.prototype.equals=function(t,e){return t===e},gt.prototype.notEquals=function(t,e){return t!==e},gt.prototype.isNumber=function(t,e){return void 0===e&&(e={}),t===Infinity||t===-Infinity?e.allowInfinity:Number.isNaN(t)?e.allowNaN:Number.isFinite(t)},gt.prototype.isInt=function(t){return Number.isInteger(t)},gt.prototype.isFloat=function(t){return!(!this.isNumber(t)&&!this.isNumberString(t))&&this.validatorJs.isFloat(t)},gt.prototype.isBoolean=function(t){return t instanceof Boolean||"boolean"==typeof t},gt.prototype.isString=function(t){return t instanceof String||"string"==typeof t},gt.prototype.isDate=function(t){return t instanceof Date&&!isNaN(t.getTime())},gt.prototype.isDateString=function(t){return this.isString(t)&&/\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])(T|\s?)?(([0-2]\d:[0-5]\d)?(:[0-5]\d(?:\.\d+)))?(?:Z|\+[0-2]\d(?:\:[0-5]\d)?)?/g.test(t)&&this.validatorJs.toDate(t)},gt.prototype.length=function(t,e,n,r){return"string"==typeof t&&this.validatorJs.isLength(t,e,n)},gt.prototype.minLength=function(t,e,n){if(e){if("object"==typeof t){var r=Object.values(t).filter(function(t){return t&&t.length<n});if(r&&0<r.length)return!1}return!0}return t&&"string"!=typeof t&&(t=t.toString()),!t||"string"==typeof t&&this.length(t,n)},gt.prototype.maxLength=function(t,e,n){if(e)return!("object"==typeof t&&0<Object.values(t).filter(function(t){return t&&t.length>n}).length);if("object"!=typeof t)return t&&"string"!=typeof t&&(t=t.toString()),!t||"string"==typeof t&&this.length(t,0,n);for(var r in t)if(t.hasOwnProperty(r)&&"string"==typeof t[r]&&!this.length(t[r],0,n))return!1;return!0},gt.prototype.range=function(t,e,n,r){return"number"==typeof t&&this.isNumber(n)&&this.isNumber(r)&&n<=t&&t<=r},gt.prototype.dateRange=function(t,e,n,r){if(!t)return!0;if("maxValue"===r||"maxDate"===r){if(this.isYearRange(t)||this.isMonthOrDayRange(t))return this.maxValue(parseInt(this.getRangeValue(t,1)),e,parseInt(n.split(" ")[0]));if(this.isDayTimeRange(t))return!0}else if("minValue"===r||"minDate"===r){if(this.isYearRange(t)||this.isMonthOrDayRange(t))return this.maxValue(parseInt(this.getRangeValue(t,0)),e,parseInt(n.split(" ")[0]));if(this.isDayTimeRange(t))return!0}return!1},gt.prototype.getRangeValue=function(t,e,n){return void 0===n&&(n="~"),t.split(n)[e]},gt.prototype.isDateRange=function(t){return"string"!=typeof t&&(t=t.toString()),/(\d{4}|\d{2})/.test(t)},gt.prototype.isYearRange=function(t){return"string"!=typeof t&&(t=t.toString()),/^\d{4}~\d{4}$/.test(t)},gt.prototype.isYearMonthRange=function(t){return"string"!=typeof t&&(t=t.toString()),/^\d{4}-\d{2}~\d{4}-\d{2}$/.test(t)},gt.prototype.isMonthOrDayRange=function(t){return"string"!=typeof t&&(t=t.toString()),/^[0|1|2|3]\d{1}~[0|1|2|3]\d{1}$/.test(t)},gt.prototype.isDayTimeRange=function(t){return"string"!=typeof t&&(t=t.toString()),/^[0|1|2|3]\d{1} \d{2}:\d{2}:\d{2}~[0|1|2|3]\d{1} \d{2}:\d{2}:\d{2}$/.test(t)},gt.prototype.min=function(t,e,n){return"number"==typeof t&&"number"==typeof n&&n<=t},gt.prototype.minValue=function(t,e,n){if(null===t||t===undefined)return!0;if("string"==typeof t&&t.match(/^(-?\d+)(\.\d+)?$/g)||"string"==typeof n&&n.match(/^(-?\d+)(\.\d+)?$/g)){var r=new y.BigNumber(t),i=new y.BigNumber(n);return r.isGreaterThanOrEqualTo(i)}return"number"==typeof t&&"number"==typeof n&&n<=t},gt.prototype.max=function(t,e,n){return null===t||t===undefined||"number"==typeof t&&"number"==typeof n&&t<=n},gt.prototype.maxValue=function(t,e,n){if(null===t||t===undefined)return!0;if("string"==typeof t&&t.match(/^(-?\d+)(\.\d+)?$/g)||"string"==typeof n&&n.match(/^(-?\d+)(\.\d+)?$/g)){var r=new y.BigNumber(t),i=new y.BigNumber(n);return r.isLessThanOrEqualTo(i)}return"number"==typeof t&&"number"==typeof n&&t<=n},gt.prototype.minDate=function(t,e,n){return!t||t&&t.getTime()>=n.getTime()},gt.prototype.maxDate=function(t,e,n){return null===t||t===undefined||t&&t.getTime()<=n.getTime()},gt.prototype.isBooleanString=function(t){return"string"==typeof t&&this.validatorJs.isBoolean(t)},gt.prototype.isNumberString=function(t){return"string"==typeof t&&this.validatorJs.isNumeric(t)},gt.prototype.contains=function(t,e,n){return"string"==typeof t&&this.validatorJs.contains(t,n)},gt.prototype.notContains=function(t,e,n){return"string"==typeof t&&!this.validatorJs.contains(t,n)},gt.prototype.isEmail=function(t){return"string"==typeof t&&this.validatorJs.isEmail(t)},gt.prototype.isJSON=function(t){return"string"==typeof t&&this.validatorJs.isJSON(t)},gt.prototype.isLowercase=function(t){return"string"==typeof t&&this.validatorJs.isLowercase(t)},gt.prototype.isUppercase=function(t){return"string"==typeof t&&this.validatorJs.isUppercase(t)},gt.prototype.exclude=function(e,n,t){var r=this,i=t.split(""),o=0;return i.forEach(function(t){r.contains(e,n,t)&&o++}),0===o},gt.prototype.matches=function(t,e,n){return""===(t=null===t||t===undefined?"":t.toString())||this.validatorJs.matches(t,n)},gt);function gt(){this.validatorJs=n}var mt=(Object.defineProperty(vt.prototype,"items",{get:function(){return this.rawData},enumerable:!0,configurable:!0}),Object.defineProperty(vt.prototype,"changes",{get:function(){return this.changeSet.changes},enumerable:!0,configurable:!0}),vt.prototype[Symbol.iterator]=function(){return h(this,function(t){switch(t.label){case 0:return[5,P(this.items)];case 1:return t.sent(),[2]}})},vt.prototype.loadEntities=function(t){var e=this;this.clear(),t.forEach(function(t){e.initEntity(t)});var n={path:[],value:t,preValue:undefined,type:x.ModifyType.Load,target:this};this.setChanges(n)},vt.prototype.clear=function(){this.rawData=[],this.originalData=[]},vt.prototype.appendNew=function(t,e){void 0===e&&(e=!1);var n=this.initEntity(t,!0),r={path:[],value:[n],preValue:undefined,type:x.ModifyType.Add};return!0===e&&(r.type=x.ModifyType.Clone),this.setChanges(r),n},vt.prototype.insert=function(t,e){var n=this.initEntity(t,!0),r={path:[],value:[n],preValue:undefined,type:x.ModifyType.Insert,position:e};return this.setChanges(r),n},vt.prototype.appendEntity=function(t){var e={path:[],value:[this.initEntity(t,!0)],preValue:undefined,type:x.ModifyType.Add};this.setChanges(e)},vt.prototype.appendEntities=function(t){var e=this,n={path:[],value:t.map(function(t){return e.initEntity(t,!0)}),preValue:undefined,type:x.ModifyType.Add};this.setChanges(n)},vt.prototype.remove=function(e){var t,n=this.count(),r=this.rawData.findIndex(function(t){return t.primaryValue===e});if(-1===r)return!1;var i=this.rawData[r];this.rawData.splice(r,1);var o={path:[],value:((t={})[i.primaryProperty.dataField]=e,t),preValue:undefined,type:x.ModifyType.Remove};return this.updateIndex(n),this.setChanges(o),!0},vt.prototype.get=function(e){return this.items.find(function(t){return t.primaryValue===e})},vt.prototype.setChanges=function(t){this.listChanged.next(t);var e=Object.assign({},t);(t.type===x.ModifyType.Add||t.type===x.ModifyType.Insert||t.type===x.ModifyType.Clone)&&t.value[0]instanceof Wn&&(e.value=[t.value[0].data]),this.changeSet.append(e)},vt.prototype.count=function(){return this.items.length},vt.prototype.indexOf=function(t){return this.items.indexOf(t)},vt.prototype.sum=function(n){return 0===this.count()?0:this.items.reduce(function(t,e){return t+e[n]},0)},vt.prototype.validate=function(){var t=this.getPropertyName();return g.from(this.validator.validate(this[Y],t))},vt.prototype.toJson=function(){return this.rawData},vt.prototype.toJSON=function(){var e=[];return this.items.forEach(function(t){e.push(t.toJSON())}),e},vt.prototype.toArray=function(){return this.items},vt.prototype.initEntity=function(t,e){var n=this;void 0===e&&(e=!1),t[Y]=this,t[W]=this[W],t.onValueChanged.subscribe(function(t){var e={path:t.path,value:t.value,preValue:t.preValue,type:t.type};t.changeSetValue!==undefined&&(e.changeSetValue=t.changeSetValue),n.setChanges(e)});var r=this.rawData.push(t);return this[r-1]=t,e||this.originalData.push(t.toJSON()),t},vt.prototype.updateIndex=function(t){for(var n=this,e=0;e<t;e++)delete this[e];this.rawData.forEach(function(t,e){n[e]=t})},vt.prototype.getPropertyName=function(){var t=this[W];return t&&t.length?t[t.length-1]:undefined},vt);function vt(t,e){var n=this;this.__type__="EntityList",this.originalData=[],this.listChanged=new g.Subject,this.changeSet=new V,this.validator=new dt,this.onListChanged=this.listChanged.asObservable(),this.clear(),t&&t.forEach(function(t){n.initEntity(nt(e,t))})}var Et,bt,Ct,xt="BigNumber";(Et=x.DataChangeType||(x.DataChangeType={}))[Et.Add=0]="Add",Et[Et.Delete=1]="Delete",(bt=x.HttpMethod||(x.HttpMethod={})).GET="GET",bt.POST="POST",bt.PUT="PUT",bt.DELETE="DELETE",function(t){var e;(e=t.Level||(t.Level={})).Error="Error",e.Info="Info",e.Warning="Warning";var n=function r(t,e){this.bizMessages=t,this.context=e};t.Message=n}(x.BackEndMessage||(x.BackEndMessage={})),(Ct=x.RunMode||(x.RunMode={})).compatible="compatible",Ct.highSpeed="highSpeed";var Pt,It,Tt=new m.InjectionToken("@farris/devkit_run_mode");(Pt=x.ComponentType||(x.ComponentType={})).farrisDataGridComponent="farrisDatagridComponent",Pt.farrisTreeTalbeComponent="farrisTreeTalbeComponent",Pt.primengTreeComponent="primengTreeComponent",Pt.kendoGridComponent="kendoGridComponent",(It=x.DestroyOpportunity||(x.DestroyOpportunity={})).AppContextDestroy="AppContextDestroy",It.MenuOrAppClose="MenuOrAppClose";var Mt=(St.setUserSettings=function(t){this.userSettings=t,this.timeZone=undefined,this.timeZoneOffset=undefined},St.getTimeZone=function(){if(this.timeZone!==undefined)return this.timeZone;var t=this.userSettings&&this.userSettings.timeZone||null;return this.timeZone=t},St.getTimeZoneOffset=function(){if(this.timeZoneOffset!==undefined)return this.timeZoneOffset;var t=this.userSettings&&this.userSettings.timeZoneOffset||null;return this.timeZoneOffset=t},St.userSettings=null,St.timeZone=undefined,St.timeZoneOffset=undefined,St);function St(){}var jt=(wt.zonedTimeToSpecialTimeZoneOffsetTimeString=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n="YYYY-MM-DD HH:mm:ss.SSS");var r=60*e;return i(t).utc().add(r,"m").format(n)},wt.timeZoneOffsetTimeToUtcTimeString=function(t,e,n){return void 0===n&&(n="YYYY-MM-DD HH:mm:ss.SSS"),i(t).utcOffset(e,!0).toISOString()},wt);function wt(){}var Ot,Nt,Dt,Vt=(Ft.prototype.getParams=function(t){return this.getAllParams()[t]||{}},Ft.prototype.setParams=function(t,e){var n=this.getAllParams();n[t]=e,this.setAllParams(n)},Ft.prototype.clearParams=function(){throw new Error("Not Implemented")},Ft.prototype.getAllParams=function(){var t=window.sessionStorage.getItem("ROUTER_PARAMS")||"{}";return JSON.parse(t)},Ft.prototype.setAllParams=function(t){t=t||{};var e=JSON.stringify(t);window.sessionStorage.setItem("ROUTER_PARAMS",e)},Ft.prototype.clearAllParams=function(){window.sessionStorage.setItem("ROUTER_PARAMS","{}")},Ft.decorators=[{type:m.Injectable}],Ft);function Ft(){}(Ot=x.ChangeType||(x.ChangeType={})).Update="Update",Ot.Load="Load",Ot.Append="Append",Ot.Remove="Remove",Ot.Swap="Swap",Ot.SelectionChanged="SelectionChanged",Ot.ValueChanged="ValueChanged",Ot.UpdateErrors="UpdateErrors",Ot.GlobalSelectionChanged="GlobalSelectionChanged",Ot.PaginationInfoChange="PaginationInfoChange",(Nt=x.ViewChangeType||(x.ViewChangeType={}))[Nt.ValueChanged=0]="ValueChanged",(Dt=x.BindingPropertyType||(x.BindingPropertyType={})).Plain="Plain",Dt.Object="Object",Dt.List="List",Dt.Dynamic="Dynamic";var Rt=(_t.getProperties=function(t){var n=[],r=G.getNgFields(t);Object.keys(r).forEach(function(t){var e=r[t];n.push({name:t,type:x.BindingPropertyType.Plain,isPrimaryKey:e.primary,isForeignKey:e.foreign,enableMultiLangInput:e.enableMultiLangInput})});var i=G.getNgObjects(t);Object.keys(i).forEach(function(t){var e=i[t];n.push({name:t,type:x.BindingPropertyType.Object,entityType:e.type})});var o=G.getNgList(t);Object.keys(o).forEach(function(t){var e=o[t];n.push({name:t,type:x.BindingPropertyType.List,entityType:e.type})});var a=G.getNgDynamic(t);return Object.keys(a).forEach(function(t){var e=a[t];n.push({name:t,type:x.BindingPropertyType.Dynamic,entityType:e.type})}),n},_t.getDynamicProperties=function(e){var n=[];return Object.keys(e).forEach(function(t){e.hasOwnProperty(t)&&(e[t]instanceof Object?n.push({name:t,type:x.BindingPropertyType.Dynamic,entityType:null}):n.push({name:t,type:x.BindingPropertyType.Plain,isPrimaryKey:!1,isForeignKey:!1}))}),n},_t.getPropertyByName=function(t,e){return t.find(function(t){return t.name===e})},_t.getPrimaryKey=function(t){var e=t.find(function(t){return!0===t.isPrimaryKey});return e?e.name:""},_t);function _t(){}var Bt=(At.create=function(t){return new(this.getType(t))(t)},At.createType=function(t){var e,n=(f(r,e=Vn),r);function r(t){return e.call(this,t)||this}var i=n.prototype;return this.extendProperties(i,t),n},At.extendProperties=function(n,t){t.forEach(function(t){var e=t.name;Object.defineProperty(n,e,{get:function(){return this.currentItem[e]}})})},At.getType=function(t){if(this.provider.has(t))return this.provider.get(t);var e=this.createType(t);return this.provider.set(t,e),e},At.provider=new Map,At);function At(){}var Lt=(kt.create=function(t){return Bt.create(t)},kt.extendProperties=function(n,t){t.forEach(function(t){var e=t.name;Object.defineProperty(n,e,{get:function(){return n.currentItem[e]}})})},kt);function kt(){}var $t=(Ut.create=function(t){return new(this.getType(t))},Ut.createType=function(t){var e,n=(f(r,e=Rn),r);function r(){return e.call(this)||this}var i=Rt.getPrimaryKey(t);return n.prototype.primaryKey=i,n.prototype.properties=t,this.extendProperties(n.prototype,t),n},Ut.extendProperties=function(e,t){var n=this;t.forEach(function(t){t.type===x.BindingPropertyType.List?n.extendListProperty(e,t):t.type===x.BindingPropertyType.Object?n.extendObjectProperty(e,t):t.type===x.BindingPropertyType.Dynamic?n.extendDynamicObjectProperty(e,t):n.extendPlainProperty(e,t)})},Ut.extendListProperty=function(t,e){var i=e.name,o=Rt.getProperties(e.entityType),a="_"+i+"_";Object.defineProperty(t,i,{get:function(){var e=this,t=this[a];if(!t){t=Lt.create(o),this[a]=t;var n=this.getValue(i);if(n){var r=n.map(function(t){return Ut.create(o)});t.load(r)}t.parent=this,t.changes.subscribe(function(t){t.path.unshift(i),t.isBindingListTransmited=!0,e.changes.next(t)})}return t},set:function(t){this[a]=t}})},Ut.extendObjectProperty=function(t,e){var n=e.name,r=Rt.getProperties(e.entityType),i="_"+n+"_";Object.defineProperty(t,n,{get:function(){var e=this,t=this[i];return t||(this.getValue(n),t=Ut.create(r),(this[i]=t).parent=this,t.changes.subscribe(function(t){t.path.unshift(n),e.changes.next(t)})),t},set:function(t){this[i]=t}})},Ut.extendDynamicObjectProperty=function(t,e){t[e.name]=null},Ut.extendPlainProperty=function(t,n){var r=n.name;Object.defineProperty(t,r,{get:function(){var t,e;return!0!==n.enableMultiLangInput?e=this.getValue(r):(e=this.getValue(r,!1))?e:(e=this.getValue(r,!1),(t={})[ht.getCurrentLanguage()]=e,t)},set:function(t){t!==this.getValue(r)&&this.setValue(r,t,!0,!0)}})},Ut.getType=function(t){if(this.provider.has(t))return this.provider.get(t);var e=this.createType(t);return this.provider.set(t,e),e},Ut.provider=new Map,Ut);function Ut(){}var Kt=(Ht.create=function(t,e){var n=$t.create(t);return n.fromEntity=e,n},Ht.createDynamicBindingObject=function(t){var e=Rt.getDynamicProperties(t),n=$t.create(e);return this.extendProperties(n,e),n},Ht.extendProperties=function(e,t){var n=this;t.forEach(function(t){t.type===x.BindingPropertyType.List?n.extendListProperty(e,t):t.type===x.BindingPropertyType.Object?n.extendObjectProperty(e,t):t.type===x.BindingPropertyType.Dynamic?n.extendDynamicObjectProperty(e,t):n.extendPlainProperty(e,t)})},Ht.extendListProperty=function(e,t){var n=t.name,r=Rt.getProperties(t.entityType),i=Lt.create(r);i.parent=e,i.changes.subscribe(function(t){t.path.unshift(n),t.isBindingListTransmited=!0,e.changes.next(t)}),Object.defineProperty(e,n,{value:i})},Ht.extendObjectProperty=function(e,t){var n=t.name,r=Rt.getProperties(t.entityType),i=this.create(r);i.parent=e,i.changes.subscribe(function(t){t.path.unshift(n),e.changes.next(t)}),Object.defineProperty(e,n,{value:i})},Ht.extendDynamicObjectProperty=function(t,e){t[e.name]=null},Ht.attachDynamicObjectProperty=function(e,n,t){t.parent=e,t.changes.subscribe(function(t){t.path.unshift(n),e.changes.next(t)}),Object.defineProperty(e,n,{value:t})},Ht.extendPlainProperty=function(e,t){var n=t.name;Object.defineProperty(e,n,{get:function(){return e.getValue(n)},set:function(t){t!==e.getValue(n)&&e.setValue(n,t,!0,!0)}})},Ht);function Ht(){}var Gt="NgValidateForm";var qt="NgChildForm",zt=j(qt,function(t){return t}),Jt="NgChildFormArray",Wt=j(Jt,function(t){return t}),Yt="NgFormControl",Zt=j(Yt,function(t){return t}),Xt=(Qt.toBindingPathArray=function(t){return"string"==typeof t?t.split("/").filter(function(t){return""!==t}):t.concat([])},Qt.toBindingPathString=function(t){return"/"+t.join("/")},Qt);function Qt(){}var te=(ee.isEqual=function(t,e){var n=Xt.toBindingPathArray(t),r=Xt.toBindingPathArray(e);return n.every(function(t,e){return t===r[e]})},ee.isParent=function(t,e){var n=Xt.toBindingPathArray(t),r=Xt.toBindingPathArray(e);if(n.length===r.length+1)return this.isAncestor(t,e)},ee.isAncestor=function(t,e){var n=Xt.toBindingPathArray(t),r=Xt.toBindingPathArray(e);return!(t.length<=r.length)&&r.every(function(t,e){return t===n[e]})},ee);function ee(){}var ne=(re.getLeafPathString=function(t){return Xt.toBindingPathArray(t).pop()},re.getParentPathString=function(t){var e=Xt.toBindingPathArray(t);return e.pop(),"/"+e.join("/")},re);function re(){}var ie=(oe.toEntityPathArray=function(t,e){var n=this,r=Xt.toBindingPathArray(t),i=[];if(0===r.length)return i;var o=e.list.currentItem;return i.push(this.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue)),r.forEach(function(t){switch(Rt.getPropertyByName(o.properties,t).type){case x.BindingPropertyType.Plain:i.push(t);break;case x.BindingPropertyType.Object:o=o[t],i.push(t),i.push(n.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue));break;case x.BindingPropertyType.List:var e=o[t];o=e.currentItem,i.push(t),i.push(n.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue))}}),i},oe.createPrimaryKeyPath=function(t,e){return t+":"+e},oe);function oe(){}var ae,se=function Pp(){},pe=(ue.toBindingPathArray=function(t){return t.split(".").filter(function(t){return""!==t})},ue);function ue(){}(ae=x.DataPathNodeType||(x.DataPathNodeType={})).DataId="DataId",ae.PropName="PropName";var ce=function Ip(t,e){this.type=t,this.value=e,this.prev=null,this.next=null},le=(fe.prototype.unshift=function(t,e){var n=new ce(t,e);n.next=this.head.next,n.prev=this.head,(this.head.next=n).next&&(n.next.prev=n),this.length++},fe.prototype.push=function(t,e){var n=this.getTail(),r=new ce(t,e);n.next=r,this.length++},fe.prototype.getTail=function(){for(var t=this.head;t.next;)t=t.next;return t},fe.prototype.toArray=function(){for(var t=[],e=this.head.next;e;)t.push(e.type+":"+e.value),e=e.next;return t},fe.prototype.toString=function(){return"["+this.toArray().join(", ")+"]"},fe.prototype.clone=function(){for(var t=new fe,e=this.head.next;e;)t.push(e.type,e.value),e=e.next;return t},fe);function fe(){this.head=new ce(null,null),this.length=0}var he,ye=(de.createByLongPathFromRoot=function(t,e){var n=new le,r=t;if(!r||0===r.length)return n;for(var i={nodeValue:r.shift(),nodeType:x.DataPathNodeType.DataId,entityTypeInfo:new me(e.entityType)};i;){n.push(i.nodeType,i.nodeValue);var o=r.shift();if(!o||!i.entityTypeInfo)break;i=this.getNextPathNodeInfo(i,o)}return n},de.getNextPathNodeInfo=function(t,e){var n=t.nodeValue,r=t.nodeType,i=t.entityTypeInfo;if(!e||!i)return null;var o={nodeValue:e,nodeType:null,entityTypeInfo:null};if(r===x.DataPathNodeType.DataId)o.nodeType=x.DataPathNodeType.PropName,o.entityTypeInfo=i;else{var a=i.getPropInfoByName(n);a.group===x.DataPropGroup.List?(o.nodeType=x.DataPathNodeType.DataId,o.entityTypeInfo=a.typeInfo):(o.nodeType=x.DataPathNodeType.PropName,o.entityTypeInfo=a.group===x.DataPropGroup.Object?a.typeInfo:null)}return o},de.createByShortPathFromRoot=function(t,e,n){var r=new le,i=t,o=n.list.currentItem,a=new me(e.entityType);return r.push(x.DataPathNodeType.DataId,o.primaryKeyValue),i.forEach(function(t){var e=a.getPropInfoByName(t);switch(e.group){case x.DataPropGroup.Plain:r.push(x.DataPathNodeType.PropName,t);break;case x.DataPropGroup.Object:o=o[t],a=e.typeInfo,r.push(x.DataPathNodeType.PropName,t);break;case x.DataPropGroup.List:var n=o[t];o=n.currentItem,a=e.typeInfo,r.push(x.DataPathNodeType.PropName,t),r.push(x.DataPathNodeType.DataId,o.primaryKeyValue)}}),r},de);function de(){}(he=x.DataPropGroup||(x.DataPropGroup={})).Plain="Plain",he.Object="Object",he.Dynamic="Dynamic",he.List="List";var ge=function Tp(){},me=(Object.defineProperty(ve.prototype,"isValueObject",{get:function(){return!this.primaryKey},enumerable:!0,configurable:!0}),ve.prototype.getBindingPathByTableName=function(t){var e=this.getFullEntityPath(this,t);return e?(e.splice(0,1),"/"+e.join("/")):null},ve.prototype.getFullEntityPath=function(t,e,n){if(void 0===n&&(n=[]),t.entityInfo&&(t.entityInfo.nodeCode===e||t.entityInfo.originalCode===e))return n.push(t.entityInfo.nodeCode),n;var r=Array.from(t.propInfoMap.values()).filter(function(t){return t.typeInfo});if(r.length<1)return n=[];t.entityInfo&&n.push(t.entityInfo.nodeCode);for(var i=0;i<r.length;i++){var o=r[i].typeInfo,a=this.getFullEntityPath(o,e);if(a&&!(a.length<1))return n=n.concat(a)}return null},ve.prototype.getPropInfos=function(){return Array.from(this.propInfoMap.values()).filter(function(t){return!t.isVOField})},ve.prototype.getPropNames=function(){var e=[];return this.getPropInfos().forEach(function(t){e.push(t.name)}),e},ve.prototype.getPropInfosByGroup=function(e){return Array.from(this.propInfoMap.values()).filter(function(t){return t.group===e&&!t.isVOField})},ve.prototype.getPropNamesByGroup=function(t){var e=[];return this.getPropInfosByGroup(t).forEach(function(t){e.push(t.name)}),e},ve.prototype.getPropInfoByName=function(t){return this.propInfoMap.has(t)?this.propInfoMap.get(t):null},ve.prototype.getPropInfoByPath=function(t){var e=t.concat([]);if(0===e.length)throw Error("属性路径不能为空");for(var n=this,r=null;n&&0<e.length;){var i=e.shift();if(!(r=n.getPropInfoByName(i)))throw Error("路径"+t+"中存在不正确的节点"+i+"，请检查");n=r.typeInfo,r.group===x.DataPropGroup.Dynamic&&0<e.length&&(n=r=null)}return r},ve.prototype.getTypeInfoByPath=function(t){if(0===t.length)return this;var e=this.getPropInfoByPath(t);if(!e.typeInfo)throw Error("路径"+t+"无法定位到一个EntityTypeInfo，请检查");return e.typeInfo},ve.prototype.getPrimaryKeyPropInfo=function(){return this.getPropInfoByName(this.primaryKey)},ve.prototype.getPropMappingByName=function(t){var e=this.getPropInfoByName(t);return e?e.mapping:""},ve.prototype.getPropMappingByPath=function(t){var e=this.getPropInfoByPath(t);return e?e.mapping:""},ve.prototype.checkPropGroup=function(t,e){var n=this.getPropInfoByName(t);return!(!n||n.group!==e)},ve.prototype.collectPropInfos=function(){var n=this,r=z.getNgFieldProperties(this.type);Object.keys(r).forEach(function(t){var e=r[t];!0===e.primary&&(n.primaryKey=t),!0===e.foreign&&(n.foreignKey=t),n.addPropInfo(x.DataPropGroup.Plain,t,e.dataField,null,e)});var i=z.getNgObjectProperties(this.type);Object.keys(i).forEach(function(t){var e=i[t];n.addPropInfo(x.DataPropGroup.Object,t,e.dataField,e.type,e)});var o=z.getNgDynamicProperties(this.type);Object.keys(o).forEach(function(t){var e=o[t];n.addPropInfo(x.DataPropGroup.Dynamic,t,e.dataField,null,e)});var a=z.getNgListProperties(this.type);Object.keys(a).forEach(function(t){var e=a[t];n.addPropInfo(x.DataPropGroup.List,t,e.dataField,e.type,e)})},ve.prototype.collectEntityInfos=function(){var t=z.getNgEntityMatadata(this.type);t=t||{originalCode:this.type.code,nodeCode:this.type.label},this.entityInfo=t},ve.prototype.addPropInfo=function(t,e,n,r,i){n=n||e;var o=null;r&&(o=new ve(r));var a={group:t,name:e,mapping:n,typeInfo:o,metadataInfo:i};this.propInfoMap.set(e,a);var s=i&&i.originalDataField;if(s&&!this.propInfoMap.has(s))this.propInfoMap.set(s,E({},a,{isVOField:!0}));else if(i&&i.type){var p=z.getNgEntityMatadata(i.type);p&&p.originalCode&&this.propInfoMap.set(p.originalCode,E({},a,{isVOField:!0}))}},ve);function ve(t){this.type=t,this.primaryKey="",this.foreignKey="",this.propInfoMap=new Map,this.collectEntityInfos(),this.collectPropInfos()}var Ee=new m.InjectionToken("@farris/devkit form path token"),be=new m.InjectionToken("@farris/devkit_back_end_message_handler"),Ce=new m.InjectionToken("@farris/message_service_token"),xe=new m.InjectionToken("@farris/notify_service_token"),Pe=new m.InjectionToken("@farris/changeset_policy_token"),Ie=new m.InjectionToken("@farris/enable_server_side_change_detection_token"),Te=new m.InjectionToken("@farris/enable_edit_state_filter_sorting_token");var Me=(Se.warn=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.logable()&&console&&console.warn.apply(console,b([t],e))},Se.error=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.logable()&&console&&console.error.apply(console,b([t],e))},Se.log=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.logable()&&console&&console.log.apply(console,b([t],e))},Se.logable=function(){return window&&window.localStorage&&"true"===window.localStorage.getItem("__DEVKIT_LOGABLE__")||!1},Se);function Se(){}function je(t){return t&&"string"==typeof t?t.replace(/[\\]/g,"\\\\").replace(/[\"]/g,'\\"').replace(/[\/]/g,"\\/").replace(/[\b]/g,"\\b").replace(/[\f]/g,"\\f").replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r").replace(/[\t]/g,"\\t"):t}var we=new m.InjectionToken("@farris_resolver_token"),Oe="ENTITY~",Ne="STATE~",De=["SumByProp","CountByProp","AvgByProp","MaxByProp","MinByProp","IsExistRecord","ListContains","ListGreaterThan","ListLessThan","ListStartWith","ListEndWith","MultiplyChildNumber","SortChildData","IsContainMatch","MinValueOfPeriod","MaxValueOfPeriod","AvgValueOfPeriod"],Ve=(Fe.decorators=[{type:m.Injectable}],Fe.ctorParameters=function(){return[{type:m.Injector},{type:Array,decorators:[{type:m.Optional},{type:m.Inject,args:[we]}]}]},Fe);function Fe(t,e){this.injector=t,this.resolvers=e}var Re="NgRepository";var _e=(Object.defineProperty(Be.prototype,"changeSetPolicy",{get:function(){return this._changeSetPolicy},set:function(t){this._changeSetPolicy=t},enumerable:!0,configurable:!0}),Be.prototype.count=function(){return this.innerEntitySet.size},Object.defineProperty(Be.prototype,"entityTypeName",{get:function(){return this.entityType.name},enumerable:!0,configurable:!0}),Be.prototype.has=function(t){return this.innerEntityMap.has(t)},Be.prototype.clear=function(){this.innerEntityMap.clear(),this.innerEntitySet.clear(),this.notifyCollectionChanged(new D([],x.ModifyType.Load))},Be.prototype.reset=function(t){if(void 0===t&&(t=!0),this.innerEntityMap.forEach(function(t){t.unsubscribe.next(),t.unsubscribe.complete()}),this.innerEntitySet.forEach(function(t){t.unsubscribe.next(),t.unsubscribe.complete()}),this.innerEntityMap.clear(),this.innerEntitySet.clear(),!0===t){var e=new D([],x.ModifyType.Load);e.isReset=!0,this.notifyCollectionChanged(e)}},Be.prototype.toArray=function(){return Array.from(this.innerEntitySet)},Be.prototype.toJSON=function(){var e=[];return this.toArray().forEach(function(t){e.push(t.toJSON())}),e},Be.prototype.loadEntities=function(t,e){var n=this;void 0===e&&(e=!1),this.innerEntityMap.clear(),this.innerEntitySet.clear(),t.forEach(function(t){n.extendChangeSetPolicyProperty(t),n.innerEntitySet.add(t),n.innerEntityMap.set(t[n.primaryKey],t),n.listenEntityChangeEvent(t)});var r=new D(t,x.ModifyType.Load);r.entityCreate=e,this.notifyCollectionChanged(r)},Be.prototype.addEntity=function(t,e){void 0===e&&(e=!1),this.verifyEntityToAdd(t),this.extendChangeSetPolicyProperty(t),this.innerEntitySet.add(t),this.innerEntityMap.set(t[this.primaryKey],t),this.listenEntityChangeEvent(t);var n=e?x.ModifyType.Clone:x.ModifyType.Add;this.notifyCollectionChanged(new D([t],n))},Be.prototype.insertEntity=function(t,e){this.verifyEntityToAdd(t),this.extendChangeSetPolicyProperty(t),this.innerEntitySet.add(t),this.innerEntityMap.set(t[this.primaryKey],t),this.listenEntityChangeEvent(t),this.notifyCollectionChanged(new D(t,x.ModifyType.Insert,null,null,e))},Be.prototype.updateEntity=function(t,e){t.load(e),this.notifyCollectionChanged(new D(e,x.ModifyType.Update,null,null))},Be.prototype.addEntities=function(t,e){var n=this;if(void 0===e&&(e=null),t){var r=[];t.forEach(function(t){n.verifyEntityToAdd(t),r.push(t)}),r.forEach(function(t){n.extendChangeSetPolicyProperty(t),n.innerEntitySet.add(t),n.innerEntityMap.set(t[n.primaryKey],t),n.listenEntityChangeEvent(t)});var i=e&&e.isTreeNodeLoadScene||!1,o=new D(r,x.ModifyType.Add);o.isTreeNodeLoadScene=i,this.notifyCollectionChanged(o)}},Be.prototype.addData=function(t,e){var n=this;if(void 0===e&&(e=null),t){var r=[];t.forEach(function(t){n.verifyEntityToAdd(t),r.push(t)}),r.forEach(function(t){n.extendChangeSetPolicyProperty(t),n.innerEntitySet.add(t),n.innerEntityMap.set(t[n.primaryKey],t),n.listenEntityChangeEvent(t)});var i=e&&e.isTreeNodeLoadScene||!1,o=new D(r,x.ModifyType.AddData);o.isTreeNodeLoadScene=i,this.notifyCollectionChanged(o)}},Be.prototype.extendChangeSetPolicyProperty=function(t){t&&(t.changeSetPolicy=this.changeSetPolicy)},Be.prototype.getEntityById=function(t){return!1===this.innerEntityMap.has(t)?null:this.innerEntityMap.get(t)},Be.prototype.getEntityByPath=function(t){for(var e=t[0].split(":")[1],n=this.getEntityById(e),r=1;r<t.length&&n;r+=1){var i=t[r];n instanceof Wn||"ConcreteEntityPrototype"===n.typeName?-1===i.indexOf(":")&&(n=n[t[r]]):n=n.get(t[r].split(":")[1])}return n},Be.prototype.getEntitiesByPath=function(t){for(var e=t[0].split(":")[1],n=this.getEntityById(e),r=1;r<t.length&&n;r+=2){if(!((n=n[t[r]])instanceof mt))throw new Error("路径格式错误");if(r+1<t.length){var i=t[r+1].split(":")[1];n=n.get(i)}}return n},Be.prototype.getEntities=function(t){return Array.from(this.innerEntitySet).filter(t)},Be.prototype.getAllEntities=function(){return Array.from(this.innerEntitySet)},Be.prototype.removeEntityById=function(t){this.verifyEntityToRemove(t);var e=this.innerEntityMap.get(t);return this.innerEntityMap["delete"](t),this.innerEntitySet["delete"](e),this.notifyCollectionChanged(new D([e],x.ModifyType.Remove)),e},Be.prototype.removeEntitiesByIds=function(t){},Be.prototype.removeEntities=function(t){var e=this,n=Array.from(this.innerEntitySet).filter(t);return n.forEach(function(t){e.innerEntityMap["delete"](t[e.primaryKey]),e.innerEntitySet["delete"](t)}),this.notifyCollectionChanged(new D(n,x.ModifyType.Remove)),n},Be.prototype.removeData=function(t){var e=this,n=Array.from(this.innerEntitySet).filter(t);return n.forEach(function(t){e.innerEntityMap["delete"](t[e.primaryKey]),e.innerEntitySet["delete"](t)}),this.notifyCollectionChanged(new D(n,x.ModifyType.RemoveData)),n},Be.prototype.resetEntities=function(t,e){if(-1===t[0].indexOf(":"))throw new Error("路径格式错误");var n=t[0].split(":")[1],r=this.innerEntityMap.get(n),i=r[t[1]];if(!r)throw new Error("找不到主键为"+n+"的实体");for(var o=2;o<t.length;o+=2){var a=t[o].split(":")[1];if(!(r=i.get(a)))throw new Error("找不到主键为"+n+"的实体");i=r[t[o+1]]}i.clear(),i.loadEntities(e)},Be.prototype.verifyEntityToAdd=function(t){if(this.has(t[this.primaryKey]))throw new Error("The repository already had an item with the save identity of '"+t[this.primaryKey]+"'");return!0},Be.prototype.verifyEntityToRemove=function(t){if(!this.has(t))throw new Error("The entity with identity of '"+t+" dose not exsit.'");return!0},Be.prototype.notifyCollectionChanged=function(t){this.collectionChanged.next(t)},Be.prototype.listenEntityChangeEvent=function(t){var e=this;t&&t.onValueChanged.subscribe(function(t){return e.changes.next(t)})},Object.defineProperty(Be.prototype,"pageSize",{get:function(){return this.paginationInfo&&this.paginationInfo.pageSize||0},set:function(t){if("number"!=typeof t||t<0)throw new Error("Invalid parameter:pageSize");var e=this.paginationInfo;this.paginationInfo=Object.assign({},e,{pageSize:t}),this.notifyCollectionChanged(new D(this.paginationInfo,x.ModifyType.PaginationInfoChange))},enumerable:!0,configurable:!0}),Object.defineProperty(Be.prototype,"totalCount",{get:function(){return this.paginationInfo&&this.paginationInfo.total||0},set:function(t){if("number"!=typeof t||t<0)throw new Error("Invalid parameter:total");var e=this.paginationInfo;this.paginationInfo=Object.assign({},e,{total:t}),this.notifyCollectionChanged(new D(this.paginationInfo,x.ModifyType.PaginationInfoChange))},enumerable:!0,configurable:!0}),Object.defineProperty(Be.prototype,"pageIndex",{get:function(){return this.paginationInfo&&this.paginationInfo.pageIndex||1},set:function(t){if("number"!=typeof t||t<0)throw new Error("Invalid parameter:pageIndex");var e=this.paginationInfo;this.paginationInfo=Object.assign({},e,{pageIndex:t}),this.notifyCollectionChanged(new D(this.paginationInfo,x.ModifyType.PaginationInfoChange))},enumerable:!0,configurable:!0}),Be.prototype.updatePaginationInfoByPath=function(t,e){var n=this.paginationInfo,r=e.pageIndex,i=e.pageSize,o=e&&(e.totalCount||e.total)||0,a=Object.assign({},n,{pageIndex:r,pageSize:i,total:o});this.setPaginationConfigByPath(t,a)},Be.prototype.getPaginationConfigByPath=function(t,e){if(!t||"/"===t)return this.paginationInfo;if("string"!=typeof t)throw new Error("路径必须为字符串！");var n=t.split("/").filter(function(t){return!!t&&0<t.trim().length}).map(function(t){return t.trim()}),r=this.paginationInfo;return n.forEach(function(t){r=r&&r.hasOwnProperty(t)?r[t]:null}),r||(void 0!==e?e:undefined)},Be.prototype.setPaginationConfigByPath=function(r,t){var e=JSON.stringify(this.paginationInfo);return r&&"/"!==r?(Array.isArray(r)||(r=r.toString().match(/[^/[\]]+/g)||[]),r.slice(0,-1).reduce(function(t,e,n){return Object(t[e])===t[e]?t[e]:t[e]=Math.abs(r[n+1])>>0==+r[n+1]?[]:{}},this.paginationInfo)[r[r.length-1]]=t):this.paginationInfo=t,JSON.stringify(this.paginationInfo)!==e&&this.notifyCollectionChanged(new D(this.paginationInfo,x.ModifyType.PaginationInfoChange)),this.paginationInfo},Be);function Be(t){this.innerEntitySet=new Set,this.innerEntityMap=new Map,this.collectionChanged=new g.Subject,this.changes=new g.Subject,this.entityType=t,this.primaryKey=G.getPrimaryKey(this.entityType)||t.prototype.primaryKey}var Ae=(Le.prototype.createEntity=function(t){return tt(this.entityType,t)},Le.prototype.createEntities=function(t,e){return et(this.entityType,t)},Le.prototype.createEntitiesByPath=function(t,e){var n,r,i,o=t.split("/");if(o.length<3)throw Error("根据path删除实体数据出错了。传入的path["+t+"]格式不对");if(e.length<1)return[];for(var a=2;a<o.length;a+=2){var s=o[a-1];i=o[a],n=(n?n.get(s):this.entityCollection.getEntityById(s))[i];var p=r?r.propEntityType:this.entityType;if(r=vn.getPropInfo(p,i),!n)throw Error("fpath参数错误，无法找到"+i+"对应的子表。fpath为："+t)}return e.map(function(t){return tt(r.propEntityType,t)})},Le.prototype.getEntityByPath=function(t){return this.getEntityNodeByPath(t)},Le.prototype.getEntitiesByPath=function(t){var e=this.getEntityNodeByPath(t);return e.toArray()},Le.prototype.getEntityNodeByPath=function(t){for(var e=ye.createByLongPathFromRoot(t,this),n=this.entityCollection,r=e.head.next;r;){if(!(n=r.type===x.DataPathNodeType.DataId?n instanceof _e==1?n.getEntityById(r.value):n.get(r.value):n[r.value]))throw new Error("找不到"+r.value+"对应的数据节点");r=r.next}return n},Le.prototype.getPropValueByPath=function(t){var e=t.pop();return this.getEntityByPath(t)[e]},Le.prototype.setPropValueByPath=function(t,e){var n=t.pop();this.getEntityByPath(t)[n]=e},Le.prototype.insertEntityBeforeByPath=function(t){throw new Error("Not Implemented")},Le.prototype.insertEntitiesBeforeByPath=function(){throw new Error("Not Implemented")},Le.prototype.insertEntityAfterByPath=function(){throw new Error("Not Implemented")},Le.prototype.insertEntitiesAfterByPath=function(){throw new Error("Not Implemented")},Le.prototype.appendEntityByPath=function(t,e,n,r){void 0===r&&(r=!1);var i,o,a,s=t.split("/");if(s.length<3)throw Error("根据path删除实体数据出错了。传入的path["+t+"]格式不对");for(var p=2;p<s.length;p+=2){var u=s[p-1];a=s[p],i=(i?i.get(u):this.entityCollection.getEntityById(u))[a];var c=o?o.propEntityType:this.entityType;if(o=vn.getPropInfo(c,a),!i)throw Error("fpath参数错误，无法找到"+a+"对应的子表。fpath为："+t)}var l=tt(o.propEntityType,e);return i.appendNew(l,r),l},Le.prototype.insertEntityByPath=function(t,e,n,r){var i,o,a,s=t.split("/");if(s.length<3)throw Error("根据path删除实体数据出错了。传入的path["+t+"]格式不对");for(var p=2;p<s.length;p+=2){var u=s[p-1];a=s[p],i=(i?i.get(u):this.entityCollection.getEntityById(u))[a];var c=o?o.propEntityType:this.entityType;if(o=vn.getPropInfo(c,a),!i)throw Error("fpath参数错误，无法找到"+a+"对应的子表。fpath为："+t)}var l=tt(o.propEntityType,e);return i.insert(l,r),l},Le.prototype.appendEntitiesByPath=function(t,e){var n=this.getEntityNodeByPath(t);n instanceof _e==1?n.addEntities(e):n.appendEntities(e)},Le.prototype.removeEntityByPath=function(t,e){var n,r=t.split("/");if(r.length<3)throw Error("根据path删除实体数据出错了。传入的path["+t+"]格式不对");for(var i=2;i<r.length;i+=2){var o=r[i-1],a=r[i];if(!(n=(n?n.get(o):this.entityCollection.getEntityById(o))[a]))throw Error("fpath参数错误，无法找到"+a+"对应的子表。fpath为："+t)}n.remove(e)},Le.prototype.removeEntitiesByPath=function(t,e){throw new Error("Not Implemented")},Le.prototype.clearAllEntityChanges=function(){this.entityCollection.toArray().forEach(function(t){t.changes.splice(0,t.changes.length)})},Le.prototype.clearEntityChangesById=function(t){var e=this.entityCollection.getEntityById(t);e&&e.changes.splice(0,e.changes.length)},Le.prototype.clearEntityChangesByIds=function(t){var e=this;!t||t.length<0||t.forEach(function(t){e.clearEntityChangesById(t)})},Le.prototype.checkAllEntityChanges=function(){return this.entityCollection.toArray().some(function(t){return 0<t.changes.length})},Le.prototype.checkEntityChangesById=function(t){var e=this.entityCollection.getEntityById(t);return!!e&&0<e.changes.length},Le.prototype.clearEntityChangesByArray=function(t){this.clearEntityChangesByIds(t)},Le);function Le(t){this.entityCollection=t,this.entityType=t.entityType}var ke=($e.prototype.expandMainEntityConfig=function(){var t=this.entityType.typeName||this.entityType.name;if(this.paginationConfig.hasOwnProperty(t)){var e=this.paginationConfig[t];this.paginationConfig=Object.assign(this.paginationConfig,e)}else this.paginationConfig=Object.assign(this.paginationConfig,{pageSize:this.paginationConfig.pageSize||0})},$e.prototype.removeLasts=function(){var n=this,r=this.entityType.typeName||this.entityType.name;Object.keys(this.paginationConfig).forEach(function(t){if(t!==r&&t.endsWith("s")){var e=t.substring(0,t.length-1);n.paginationConfig[e]=n.paginationConfig[t],delete n.paginationConfig[t]}})},$e.prototype.deleteMainEntityConfig=function(){var t=this.entityType.typeName||this.entityType.name;delete this.paginationConfig[t]},Object.defineProperty($e.prototype,"pagination",{get:function(){return this.paginationConfig},enumerable:!0,configurable:!0}),$e.prototype.getPaginationConfigByPath=function(t,e){if(!t||"/"===t)return this.paginationConfig;if("string"!=typeof t)throw new Error("路径必须为字符串！");var n=(t=t.substring(1)).split("/").filter(function(t){return!!t&&0<t.trim().length}),r=this.paginationConfig;return n.forEach(function(t){r=r&&r.hasOwnProperty(t)?r[t]:null}),r||(void 0!==e?e:undefined)},$e.prototype.setPaginationConfigByPath=function(r,t){return Array.isArray(r)||(r=r.toString().match(/[^/[\]]+/g)||[]),r.slice(0,-1).reduce(function(t,e,n){return Object(t[e])===t[e]?t[e]:t[e]=Math.abs(r[n+1])>>0==+r[n+1]?[]:{}},this.paginationConfig)[r[r.length-1]]=t,this.paginationConfig},$e.prototype.getNgListProperties=function(o){void 0===o&&(o=0);var a=function(t){var r=G.getNgList(t),i={};return Object.keys(r).length<1||Object.keys(r).forEach(function(t){var e=r[t].dataField;e.endsWith("s")&&(e=e.substring(0,e.length-1)),i[e]={pageSize:o};var n=a(r[t].type);null!==n&&0<Object.keys(n).length&&(i=Object.assign({},i,n))}),i},t=a(this.entityType);return Object.assign({},{pageSize:o},t)},$e.decorators=[{type:m.Injectable}],$e.ctorParameters=function(){return[{type:undefined},{type:undefined}]},$e);function $e(t,e){this.entityType=t,this.paginationConfig=e,null!==this.paginationConfig&&this.paginationConfig!==undefined||(this.paginationConfig=this.getNgListProperties()),this.expandMainEntityConfig(),this.deleteMainEntityConfig(),this.removeLasts()}var Ue=(Ke.prototype.addChange=function(t){this["on"+x.DataChangeType[t.changeType]+"Data"](t)},Ke.prototype.addChanges=function(t){var e=this;t.forEach(function(t){return e.addChange(t)})},Ke.prototype.clear=function(){this.history.splice(0,this.history.length)},Ke.prototype.clearByIds=function(s){this.history=this.history.filter(function(t){var e,n;if(!t.fpath||"/"===t.fpath||!t.fpath.includes("/"))return!s.includes(t.dataId);try{for(var r=P(s),i=r.next();!i.done;i=r.next()){var o=i.value;return!t.fpath.split("/").includes(o)}}catch(a){e={error:a}}finally{try{i&&!i.done&&(n=r["return"])&&n.call(r)}finally{if(e)throw e.error}}})},Ke.prototype.isChanged=function(){return 0<this.history.length},Ke.prototype.onAddData=function(t){this.history.push(t)},Ke.prototype.onDeleteData=function(e){var t=this.history.findIndex(function(t){return t.dataId===e.dataId&&t.changeType===x.DataChangeType.Add});0<=t?this.history.splice(t,1):this.history.push(e)},Ke);function Ke(){this.history=[]}var He=(Ge.prototype.getConditionsByBindingPath=function(t,n){var e=this.sorts.get(t)||[];return e.length<1||"function"==typeof n&&(e=e.map(function(t){var e=n(t.SortType);return{SortField:t.SortField,SortType:e}})),e},Ge.prototype.addCondition=function(t,e,n){if(e&&n){var r=this.sorts.has(t),i={SortField:e,SortType:n};if(r){var o=this.sorts.get(t)||[],a=o.findIndex(function(t){return t.SortField===e});-1!==a?o[a]=i:o.push(i)}else this.sorts.set(t,[i])}else this.sorts["delete"](t)},Ge.prototype.removeCondition=function(t,e){throw new Error("not implement!")},Ge.prototype.setConditions=function(t,e,n){if(e&&n){var r=e.split(",").filter(function(t){return t}),i=n.split(",").filter(function(t){return t});if(r.length!==i.length)throw new Error("arguments error,fields and direction are not match.");var o=[];r.forEach(function(t,e){var n={SortField:t,SortType:i[e]};o.push(n)}),this.sorts.set(t,o)}else this.sorts["delete"](t)},Ge.prototype.clear=function(){this.sorts.clear()},Ge);function Ge(){this.sorts=new Map}var qe=(ze.prototype.getFilters=function(t){return this.filters.get(t)||[]},ze.prototype.mergeCondition=function(t,e){var n=e(this.filters.get(t)||[]);this.filters.set(t,n)},ze.prototype.addCondition=function(t,e){var n=this.filters.get(t),r=this.findConditionIndex(t,e);-1!==r?n[r]=e:n.push(e)},ze.prototype.addConditions=function(e,t){var n=this;!t||!Array.isArray(t)||t.length<1||t.forEach(function(t){n.addCondition(e,t)})},ze.prototype.removeCondition=function(n,t){var r=this,i=this.filters.get(n);if(i&&!(i.length<1)){var e=i.filter(t);e&&e.forEach(function(t){var e=r.findConditionIndex(n,t);0<=e&&i.splice(e,1)})}},ze.prototype.clear=function(){this.filters.clear()},ze.prototype.setConditions=function(t,e){this.filters.set(t,e)},ze.prototype.findConditionIndex=function(t,c){if(!c||"object"!=typeof c||Object.keys(c).length<1)return-1;var e=this.filters.get(t);return!e||e.length<1?-1:e.findIndex(function(t,e){var n,r,i=!0,o=Object.keys(c);try{for(var a=P(o),s=a.next();!s.done;s=a.next()){var p=s.value;if(!t||!t.hasOwnProperty(p)||t[p]!==c[p]){i=!1;break}}}catch(u){n={error:u}}finally{try{s&&!s.done&&(r=a["return"])&&r.call(a)}finally{if(n)throw n.error}}return i})},ze);function ze(){this.filters=new Map}var Je=(We.create=function(t){var e=Date.now().valueOf();return(We.previous=We.previous<e?e:We.previous+100).toString(t)},We.previous=0,We);function We(){}var Ye=(Object.defineProperty(Ze.prototype,"primaryKey",{get:function(){return this.entityCollection.primaryKey},enumerable:!0,configurable:!0}),Object.defineProperty(Ze.prototype,"changes",{get:function(){return this.entityCollection.changes},enumerable:!0,configurable:!0}),Object.defineProperty(Ze.prototype,"entityCollectionChange",{get:function(){return this.entityCollection.collectionChanged},enumerable:!0,configurable:!0}),Object.defineProperty(Ze.prototype,"name",{get:function(){if(!this.innerName){var t=Je.create();this.innerName="Repository_"+t}return this.innerName},set:function(t){this.innerName=t},enumerable:!0,configurable:!0}),Ze.prototype.dispose=function(t){this.paginationManager=null,this.destroy$&&(this.destroy$.next(),this.destroy$.complete(),this.destroy$=null),this.entityCollection&&this.entityCollection.reset(!1)},Ze.prototype.ngOnDestroy=function(){this.dispose()},Ze.prototype.updateEntityType=function(t){this.entityType=t,this.entityTypeInfo=new me(this.entityType),this.entityCollection=new _e(this.entityType)},Ze.prototype.readMetadata=function(){var t=w.getClassMetadataByName(this.constructor,"NgRepository");t&&(this.apiUri=t.apiUrl,this.entityType=t.entityType)},Ze.prototype.setPaginationConfig=function(t){this.paginationManager=new ke(this.entityType,t);var e=(this.paginationManager.getPaginationConfigByPath("/")||{}).pageSize,n=void 0===e?0:e;this.entityCollection.paginationInfo=Object.assign({pageSize:n},this.paginationManager.pagination,this.entityCollection.paginationInfo)},Ze.prototype.reset=function(){this.entityCollection.reset()},Ze.prototype.buildEntity=function(t){return tt(this.entityType,t)},Ze.prototype.buildEntities=function(t){return et(this.entityType,t)},Ze.decorators=[{type:m.Injectable}],Ze.ctorParameters=function(){return[]},Ze);function Ze(){this.paginationInfo=null,this.readMetadata(),this.entityType&&(this.entityTypeInfo=new me(this.entityType),this.entityCollection=new _e(this.entityType)),this.dataChangeHistory=new Ue,this.sortConditionManager=new He,this.filterConditionManager=new qe,this.destroy$=new g.Subject}var Xe,Qe=(f(tn,Xe=Ye),tn.prototype.getEntities=function(t,e,n,r){throw new Error("Not Implemented")},tn.prototype.filter=function(t,e,n,r){throw new Error("Not Implemented")},tn.prototype.getList=function(){throw new Error("Not Implemented")},tn.prototype.getById=function(t){throw new Error("Not Implemented")},tn.prototype.getEntityById=function(t){throw new Error("Not Implemented")},tn.prototype.queryChild=function(t,e,n,r,i){throw new Error("Not Implemented")},tn.prototype.updateById=function(t){throw new Error("Not Implemented")},tn.prototype.updateEntityById=function(t){throw new Error("Not Implemented")},tn.prototype.create=function(){throw new Error("Not Implemented")},tn.prototype.append=function(){throw new Error("Not Implemented")},tn.prototype.appendByPath=function(t){throw new Error("Not Implemented")},tn.prototype.insert=function(t,e){throw new Error("Not Implemented")},tn.prototype.insertByPath=function(t,e){throw new Error("Not Implemented")},tn.prototype.removeById=function(t,e){throw new Error("Not Implemented")},tn.prototype.batchRemove=function(t,e){throw new Error("Not Implemented")},tn.prototype.removeByIds=function(t,e){throw new Error("Not Implemented")},tn.prototype.removeByPath=function(t,e){throw new Error("Not Implemented")},tn.prototype.updateChangesById=function(t){throw new Error("Not Implemented")},tn.prototype.updateChangesByPath=function(t,e){throw new Error("Not Implemented")},tn.prototype.updateAllChanges=function(){throw new Error("Not Implemented")},tn.prototype.applyChanges=function(){throw new Error("Not Implemented")},tn.prototype.applyChangesById=function(t){throw new Error("Not Implemented")},tn.prototype.cancelChanges=function(t){throw new Error("Not Implemented")},tn.prototype.batchRemoveByPath=function(t,e){throw new Error("Not Implemented")},tn.prototype.batchAppendByPath=function(t,e){throw new Error("Not Implemented")},tn.prototype.batchAppend=function(t){throw new Error("Not Implemented")},tn.prototype.hasChanges=function(){throw new Error("Not Implemented")},tn.decorators=[{type:m.Injectable}],tn.ctorParameters=function(){return[{type:m.Injector}]},tn);function tn(t){var e=Xe.call(this)||this;return e.injector=t,e.entityManager=new Ae(e.entityCollection),e}var en=(nn.prototype.resolve=function(t){var e=ln.getGroupFunctionDependency(t,this.repository.entityTypeInfo),n=this.getEntityDependency(t);e&&0<e.length&&n&&0<n.length&&e.forEach(function(e){var t=n.findIndex(function(t){return e.startsWith(t)});-1!==t&&n.splice(t,1)});var r=b(e,n);return b(new Set(r))},nn.prototype.getValidEntityPropertyExpression=function(t){var e=t.split("."),n=null;try{n=this.entityTypeInfo.getPropInfoByPath(e)}catch(r){}return n?t.split("."):1<e.length?(e.pop(),this.getValidEntityPropertyExpression(e.join("."))):null},nn.prototype.getEntityDependency=function(t){var n=this,r=[];if(this.entityTypeInfo){var e=new RegExp("[\\'\\\"]?\\s*("+this.entityTypeInfo.entityInfo.nodeCode+"|"+this.entityTypeInfo.entityInfo.originalCode+")[\\.\\[\\]a-zA-Z0-9_]+\\s*[\\'\\\"]?","g"),i=t.match(e);Array.isArray(i)&&0<i.length&&i.forEach(function(t){if(-1!==t.indexOf(".")){t=t.trim().replace(/\"/g,""),t=(t=ln.convertToNodeCode(t,n.repository.entityTypeInfo).join(".")).substr(t.indexOf(".")+1);var e=n.getValidEntityPropertyExpression(t);e&&Array.isArray(e)&&0<e.length&&(e.splice(0,0,Oe),r.push(e.join("/")))}})}return r},nn.decorators=[{type:m.Injectable}],nn.ctorParameters=function(){return[{type:Ye}]},nn);function nn(t){this.repository=t,this.entityTypeInfo=this.repository&&this.repository.entityTypeInfo||null}var rn=["GetContextParameter","GetSessionValue"],on=(an.prototype.resolve=function(t){var i=[],e=new RegExp("DefaultFunction\\.("+rn.join("|")+")\\s*\\([^\\r\\n\\)]*\\)","g"),n=t.match(e);if(n&&0<n.length){var o=/\(([^\r\n\)]*)\)/;n.forEach(function(t){var e=t.match(o);if(2===e.length){var n=e[1].trim().replace(/\"/g,""),r=["STATE~"];r.push(n),i.push(r.join("/"))}})}return i},an);function an(){}var sn=(pn.prototype.resolve=function(t){var e=[];if(!t||t.length<1)return e;var n=t.match(/\/\*\*\s*__define__\((.*)\)\s*\*\//);if(n&&2===n.length){var r=n[1].trim(),i=null;try{i=JSON.parse(r)}catch(o){console.warn("自定义依赖解析失败："+r)}i&&i.hasOwnProperty("deps")&&Array.isArray(i.deps)&&e.push.apply(e,b(i.deps))}return e},pn.decorators=[{type:m.Injectable}],pn);function pn(){}var un=(cn.prototype.resolve=function(n){var r=[];if(this.resolverRegistry&&this.resolverRegistry.resolvers&&!(this.resolverRegistry.resolvers.length<1)){var t=this.resolverRegistry.resolvers.find(function(t){return t instanceof sn});if(t){var e=t.resolve(n);e&&Array.isArray(e)&&0<e.length&&r.push.apply(r,b(e))}return r&&0<r.length?r:(this.resolverRegistry.resolvers.forEach(function(t){if(!(t instanceof sn)){var e=t.resolve(n);e&&0<e.length&&r.push.apply(r,b(e))}}),b(new Set(r)))}},cn.decorators=[{type:m.Injectable}],cn.ctorParameters=function(){return[{type:m.Injector},{type:Ve}]},cn);function cn(t,e){this.injector=t,this.resolverRegistry=e}var ln=(fn.getGroupFunctionDependency=function(t,u){var c=this,l=[],e=new RegExp("DefaultFunction\\.("+De.join("|")+")\\s*\\([^\\r\\n\\)]*\\)","g"),n=t.match(e);if(n&&0<n.length){var f=/\(([^\r\n\)]*)\)/,h=/DefaultFunction\.(\S*)\(/;n.forEach(function(t){var e=t.match(f),n=t.match(h),r=null;if(n&&2==n.length&&(r=n[1]),2===e.length){var i=e[1],o=i.split(",").map(function(t){return t.replace(/\"/g,"")});if(o&&2===o.length){var a=o.join(".");(s=(a=(a=c.convertToNodeCode(a,u).join(".")).substr(a.indexOf(".")+1)).split(".")).splice(0,0,Oe),l.push(s.join("/"))}else if(o&&3===o.length){if("MultiplyChildNumber"===r)[(p=o[0])+"."+o[1],p+"."+o[2]].forEach(function(t){var e=(t=(t=c.convertToNodeCode(t,u).join(".")).substr(t.indexOf(".")+1)).split(".");e.splice(0,0,Oe),l.push(e.join("/"))});else if("IsContainMatch"===r||"SortChildData"===r){var s;a=(p=o[0])+"."+o[1],(s=(a=(a=c.convertToNodeCode(a,u).join(".")).substr(a.indexOf(".")+1)).split(".")).splice(0,0,Oe),l.push(s.join("/"))}}else if(!o||4!==o.length){if(!o||5!==o.length)throw new Error("无法解析参数： "+JSON.stringify(i));var p;["MinValueOfPeriod","MaxValueOfPeriod","AvgValueOfPeriod"].includes(r)&&[(p=o[0])+"."+o[1],p+"."+o[2]].forEach(function(t){var e=(t=(t=c.convertToNodeCode(t,u).join(".")).substr(t.indexOf(".")+1)).split(".");e.splice(0,0,Oe),l.push(e.join("/"))})}}})}return l},fn.convertToNodeCode=function(t,e){var n=[];if(e&&t.includes("."))for(var r=t.split(".")||[],i=e,o=0;o<r.length;o++){var a=r[o];if(i&&i.entityInfo&&i.entityInfo.nodeCode===a||i.entityInfo.originalCode===a){0===o?n.push(i.entityInfo.originalCode):n.push(i.entityInfo.nodeCode);var s=r[o+1];if(!s)break;var p=i.getPropInfoByName(s);if(!p)break;p.typeInfo&&(i=p.typeInfo)}else{if(!i||!i.getPropInfoByName(a))break;var u=i.getPropInfoByName(a);n.push(u.name)}}return n},fn.getChildrenEntityPaths=function(t,n,r){var i=this;void 0===r&&(r=[]);var e=t.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length?e.forEach(function(t){0===r.length&&n.push([t.name]);var e=t.typeInfo.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length?(r.push(t.name),e.forEach(function(t){i.getChildrenEntityPaths(t.typeInfo,n,r)})):(0!==r.length&&(r.push(t.name),n.push(b(r))),r.length=0)}):(0<r.length&&(r.push(t.entityInfo.nodeCode),n.push(b(r))),r.length=0)},fn.getCurrentRowByPaths=function(t,e){var n=null,r=e.getValue(t);if(r&&0<r.length){var i=r.currentItem.primaryKeyValue||null;if(i){var o=r.findById(i);o&&(n=o.toJSON())}}return n},fn.getAvailableChildrenPathsFromEntityPaths=function(t,e){var n=[];for(t=b(t);0<t.length;){var r=e.getPropInfoByPath(t);if(r&&"List"===r.group){n=t;break}t.pop()}return n},fn.getBindingPath=function(t,e){return t=this.getEntityPath(t),this.getAvailableChildrenPathsFromEntityPaths(t,e)},fn.getEntityPath=function(t){return t.filter(function(t,e){return e%2!=0||!t.includes(":")})},fn);function fn(){}var hn=(yn.getChildrenNodeCodes=function(t,n){var r=this;void 0===n&&(n=[]);var e=t.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length&&e.forEach(function(t){n.push(t.name);var e=t.typeInfo.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length&&e.forEach(function(t){n.push(t.name),r.getChildrenNodeCodes(t.typeInfo,n)})})},yn);function yn(){}var dn,gn=(f(mn,dn=a.FormGroup),Object.defineProperty(mn.prototype,"formGroupName",{get:function(){return this.ngValidateForm?this.ngValidateForm.formGroupName:""},enumerable:!0,configurable:!0}),Object.defineProperty(mn.prototype,"enableValidate",{get:function(){return!!this.ngValidateForm&&this.ngValidateForm.enableValidate},enumerable:!0,configurable:!0}),Object.defineProperty(mn.prototype,"translateService",{get:function(){return this.translate},enumerable:!0,configurable:!0}),mn.prototype.ngOnDestroy=function(){this.dispose()},mn.prototype.dispose=function(t){this.destroy$&&(this.destroy$.next(),this.destroy$.complete(),this.destroy$=null),mn.insMap[this.constructor.name]=null,this.frameContext=null,this.bindingData=null,this.ngChildForms=null,this.metaDatas=null,this.ngFormControls={},this.controls={},this.disposeValidation()},mn.updateErrors=function(n,r,i,o,a){Object.keys(mn.insMap).forEach(function(t){var e=mn.insMap[t];e&&(i&&e.setControlValue(n,o),e.enableValidate&&e.isFormValid(n,r,i,a))})},mn.prototype.setIsShowmap=function(t){this.isShowPropMap[t]=!0},mn.prototype.setShowValidationMsg=function(t){this.raisedByValidateEffector=!1,this.isShowValidationMsg=t},mn.prototype.setControlValue=function(t,e){var n=this.bindingData&&this.bindingData.getObject()||null;n&&n.controlMap&&(n.controlMap[t]=this.getGridItemControl(t,e))},mn.prototype.getCardControlErrors=function(t){return this.setIsShowmap(t),this.cardControls[t]&&this.cardControls[t].errors},mn.prototype.getFormControlErrors=function(t){return this.cardControls[t]&&this.cardControls[t].errors},mn.prototype.getGridControlErrors=function(t,e){return this.setIsShowmap(t),this.controlIdMap[e]&&this.controlIdMap[e][t]&&this.controlIdMap[e][t].errors},mn.prototype.isFormValid=function(t,s,e,n){var p=this,r="";if(!this.raisedByValidateEffector){var i=this.frameContext.frameComponent.isGridComponent;i!==undefined&&(n=i);var o=this.bindingPath.split("/").filter(function(t){return t});0<o.length&&(r=o.join(".").concat("."));var a=this.getDomPropertyNameByEntityProp(t,r);if(t&&!a)return!0;if(a&&!this.isShowPropMap[a])return!0;var u=!0,c=this.bindingData.getObject(),l=c.primaryKeyValue,f="/"!==this.bindingPath,h=this.bindingData.getList();if(f&&0===h.innerList.size)return!0;if(!l)return!0;if(e&&a&&(this.controlIdMap[e]=this.controlIdMap[e]||{},this.controlIdMap[e][a]={errors:s}),!e||e===l)return t||e||(c.controlMap={},this.controlIdMap={},this.cardControls={}),Object.keys(this.controls).forEach(function(t){!0===p.isShowPropMap[t]&&(t===a&&(s&&0<Object.keys(s).length?n||(Object.keys(s).map(function(t){var e=s[t]&&s[t].error||null;if(e){var n=e.rule,r=p.getngFormControlByBinding(n.field);if(r){n.property=r.name||r.defaultI18nValue,n.targetId=r.id,n.targetName=p.formGroupName;var i="require"===t?"required":t,o=it.getMessage(i);if(o){var a=st.replaceMessageSpecialTokens(o,n,r.name);s[t].name=a}}}}),p.cardControls[t]={errors:s}):p.cardControls[t]={}),p.controls[t]&&p.controls[t].errors&&0<Object.keys(p.controls[t].errors).length&&(p.cardControls[t]={errors:E({},p.cardControls[t]&&p.cardControls[t].errors,p.controls[t].errors)},u=!1))}),this.cardControls&&Object.keys(this.cardControls).forEach(function(o){p.cardControls[o]&&p.cardControls[o].errors&&Object.keys(p.cardControls[o].errors).forEach(function(e){if("object"!=typeof p.cardControls[o].errors[e]){var t=p.ngFormControls[o].validRules||[],n=[].concat(t).find(function(t){return t.type===e});if(n){n.targetName=p.formGroupName;var r=it.getMessage(e),i=st.replaceMessageSpecialTokens(r,n,"");p.cardControls[o].errors[o]={value:p.controls[o]&&p.controls[o].value||"",name:i}}}})}),Object.keys(this.cardControls).forEach(function(t){p.cardControls[t]&&p.cardControls[t].errors&&0<Object.keys(p.cardControls[t].errors).length&&(u=!1)}),u}},mn.prototype.updateFormErrors=function(e,t,n){var r=this;void 0===t&&(t=!1),void 0===n&&(n=""),n&&"backend"===n&&this.clearBackendError(),!0!==this.isShowValidationMsg&&!0!==t||(this.isShowValidationMsg=!0,Object.keys(e).forEach(function(t){e[t].errors&&0<Object.keys(e[t].errors).length?r.cardControls[t]={errors:E({},r.cardControls[t]&&r.cardControls[t].errors,e[t].errors)}:(r.cardControls[t]={errors:{}},r.controls[t].setErrors(null),r.controls[t].markAsTouched())}))},mn.prototype.clearBackendError=function(){var n=this;Object.keys(this.cardControls).forEach(function(t){var e=n.cardControls[t]&&n.cardControls[t].errors||null;e?(Object.keys(e).forEach(function(t){t&&t.startsWith("backend-message-")&&delete e[t]}),e&&0===Object.keys(e).length&&delete n.cardControls[t].errors):n.cardControls[t]={}})},mn.prototype.getngFormControlByBinding=function(e){return Object.values(this.ngFormControls).find(function(t){return t.binding&&t.binding===e})},mn.prototype.disposeValidation=function(){var n=this,t=this.constructor[T];t&&0<Object.keys(t).length&&Object.keys(t).forEach(function(t){var e=n.constructor[T][t];e&&0<e.length&&e.forEach(function(t){t.validRules&&Array.isArray(t.validRules)&&0<t.validRules.length&&(t.validRules=t.validRules.filter(function(t){return!(t.eval&&"function"==typeof t.eval)}))})})},mn.prototype.getErrorMessage=function(t,e){var n=this.ngFormControls[t];if(n){var r=n.validRules,i=[];Array.isArray(r)?i.push.apply(i,b(r)):i.push(r);var o=i.find(function(t){return t.type===e});if(o){var a=n.name,s=it.getMessage(e);return st.replaceMessageSpecialTokens(s,o,a)}return null}return null},mn.prototype.init=function(t,e,n){var r=this;this.frameContext=n,this.bindingData=t,this.bindingPath=e,this.frameContext&&this.frameContext.viewModel&&this.frameContext.viewModel.verifycationChanged&&this.frameContext.viewModel.verifycationChanged.subscribe(function(t){(!t||t.length<1)&&r.resetCardValidMsg()}),this.buildForm(),mn.insMap[this.constructor.name]=this},mn.prototype.buildForm=function(){this.collectMetadatas(),this.createChildForms(),this.createControls()},mn.prototype.resetCardValidMsg=function(){var e=this;this.cardControls={},Object.keys(this.controlIdMap).forEach(function(t){e.bindingData.getList().innerList.map(function(t){return t.id}).includes(t)||delete e.controlIdMap[t]}),this.resetFormControls(),this.setShowValidationMsg(!1)},mn.prototype.updateFieldValidateRule=function(n,t){var r=this;if(n){var e=this.controls[n];e&&(e.clearValidators(),e.markAsUntouched(),e.markAsPristine(),e.setErrors([]));var i=this.ngFormControls[n],o=i&&i.validRules||[];Array.isArray(o)||(o=[o]);var a=o.findIndex(function(t){return t.type===it.REQUIRED});if(t){if(-1==a){var s={type:it.REQUIRED,constraints:[!0]},p=i&&(i.name||i.defaultI18nValue)||"";s.targetId=i&&i.id||null,s.targetName=this.formGroupName,s.property=p,s.field=i&&i.binding,o.push(s)}}else-1!==a&&o.splice(a,1);var u=[];Array.prototype.forEach.call(o,function(t){var e=r.getValidatorByRuleObj(t,r.ngFormControls[n]);e&&u.push(e)}),this.ngFormControls[n].validRules=o,this.controls[n].setValidators(u)}},mn.prototype.addFieldValidateRule=function(t,e,n,r){var i=this.controls[t];i&&i.setErrors(null);var o=this.ngFormControls[t],a=this.ngFormControls[t].validRules;a=a||[],Array.isArray(a)||(a=[a]);var s=a.findIndex(function(t){return t&&t.expressionId===n});-1!==s&&a.splice(s,1);var p=this.frameContext.viewModel.bindingPath.split("/").filter(function(t){return t});0!==p.length&&(p.join("/"),(o.binding||"").split(".").join("/"));var u=this.frameContext,c={type:r,message:e,expressionId:n,constraints:[],bindingPath:p.join("/"),eval:function(t){return u.viewModel.expression.validate(n,t)}};a.push(c),this.ngFormControls[t].validRules=a},mn.prototype.getValidatorByRuleObj=function(l,f){var h=this,t=l.type,e=l.constraints,a=void 0===e?[]:e,n=l.message,o=void 0===n?null:n;return f.name||f.defaultI18nValue,{required:function(t){var e=t.value,n=""!==e&&null!==e&&e!==undefined&&"0001-01-01"!==e&&"0001-01-01 00:00:00"!==e&&"0001-01-01T00:00:00"!==e,r=h.bindingPath.split("/").filter(function(t){return t}),i=f.binding.split("."),o=r.concat(i),a=h.getPropInfoByPath(o);if(a&&a.metadataInfo.enableMultiLangInput){var s=ht.getCurrentLanguage(),p=e&&e[s];n=""!==p&&null!==p&&p!==undefined&&"0001-01-01"!==p&&"0001-01-01 00:00:00"!==p&&"0001-01-01T00:00:00"!==p}var u=it.getMessage(it.REQUIRED),c=st.replaceMessageSpecialTokens(u,l,t.value);return n&&t.errors&&t.errors.required&&(delete t.errors.required,h.isFormValid(o.join("."))),n?null:{required:{value:t.value,name:c}}},maxLength:function(t){var e=t.value&&t.value.toString().length>a[0],n=it.getMessage(it.MAX_LENGTH),r=st.replaceMessageSpecialTokens(n,l,t.value);return e?{maxLength:{value:t.value,name:r}}:null},minLength:function(t){var e=t.value&&t.value.toString().length<a[0],n=it.getMessage(it.MAX_LENGTH),r=st.replaceMessageSpecialTokens(n,l,t.value);return e?{minLength:{value:t.value,name:r}}:null},minValue:function(t){var e=!1,n="";if(null===t.value||t.value===undefined)return null;if("number"==typeof t.value&&"number"==typeof a[0]){e=t.value<a[0];var r=it.getMessage(it.MINVALUE);n=st.replaceMessageSpecialTokens(r,l,t.value)}else if(f&&!0===f.bigNumber){var i=new y.BigNumber(a[0]),o=new y.BigNumber(t.value);e=i.isGreaterThan(o),r=it.getMessage(it.MINVALUE),n=st.replaceMessageSpecialTokens(r,l,t.value)}else{if(r=it.getMessage(it.MIN_DATE),!a||a.length<1||!a[0])return null;e=t.value instanceof Date?t.value<s.parseISO(a[0]):s.parseISO(t.value)<s.parseISO(a[0]),n=st.replaceMessageSpecialTokens(r,l,t.value)}return e?{minValue:{value:t.value,name:n}}:null},maxValue:function(t){var e=!1,n="";if(null===t.value||t.value===undefined)return null;if("number"==typeof t.value&&"number"==typeof a[0]){e=t.value>a[0];var r=it.getMessage(it.MAXVALUE);n=st.replaceMessageSpecialTokens(r,l,t.value)}else if(f&&!0===f.bigNumber){var i=new y.BigNumber(a[0]),o=new y.BigNumber(t.value);e=i.isLessThan(o),r=it.getMessage(it.MAXVALUE),n=st.replaceMessageSpecialTokens(r,l,t.value)}else r=it.getMessage(it.MAX_DATE),e=t.value instanceof Date?t.value>new Date(a[0]):new Date(t.value)>new Date(a[0]),n=st.replaceMessageSpecialTokens(r,l,t.value);return e?{maxValue:{value:t.value,name:n}}:null},exclude:function(t){var e="string"==typeof t.value&&!h.validatorJs.contains(t.value,a[0]),n=it.getMessage(it.EXCLUDE),r=st.replaceMessageSpecialTokens(n,l,t.value);return e?null:{exclude:{value:t.value,name:r}}},matches:function(t){var e=null===t.value||t.value===undefined?"":t.value.toString(),n=""===e||h.validatorJs.matches(e,a[0]),r=o;if(!r){var i=it.getMessage(it.MATCHES);r=st.replaceMessageSpecialTokens(i,l,t.value)}return n?null:{matches:{value:t.value,name:r}}}}[t]},mn.prototype.collectMetadatas=function(){this.ngValidateForm=this.frameContext.metadata.form?w.translateMetadataByName(this.frameContext.metadata.form,this.translateService,["formGroupName"]):w.getClassMetadataByNameWithTranslate(this.constructor,Gt,this.translateService,["formGroupName"]),this.ngFormControls=this.collectionFormControlMetadats(this.frameContext.metadata.formControls),this.ngChildForms=this.frameContext.metadata.subForms||w.getPropsMetadatasByName(this.constructor,qt)},mn.prototype.collectionFormControlMetadats=function(t){var i=this;void 0===t&&(t=null);var o=t?w.translateMetadatasByName(t,this.translateService,["name"]):w.getPropsMetadatasByNameWithTranslate(this.constructor,Yt,this.translateService,["name"]);return o&&Object.keys(o).forEach(function(t){var e=o[t],n=e.name||e.defaultI18nValue||"",r=e.id;Array.isArray(e.validRules)&&e.validRules.forEach(function(t){t.targetId=r,t.targetName=i.formGroupName,t.property=n,t.field=e.binding})}),o},mn.prototype.getGridItemControl=function(t,e){var n,r,i=this;return n=t,r=[],i.ngFormControls[n]&&Array.isArray(i.ngFormControls[n].validRules)&&Array.prototype.forEach.call(i.ngFormControls[n].validRules,function(t){var e=i.getValidatorByRuleObj(t,i.ngFormControls[n]);e&&r.push(e)}),new a.FormControl(e,{validators:r,updateOn:"blur"})},mn.prototype.getDomPropertyNameByEntityProp=function(e,n){var r=this;void 0===n&&(n="");var i="";return Object.keys(this.ngFormControls).forEach(function(t){""+n+r.ngFormControls[t].binding===e&&(i=t)}),i},mn.prototype.createControls=function(){var o=this;Object.keys(this.ngFormControls).forEach(function(n){var t=o.ngFormControls[n],r=[];Array.isArray(o.ngFormControls[n].validRules)&&Array.prototype.forEach.call(o.ngFormControls[n].validRules,function(t){var e=o.getValidatorByRuleObj(t,o.ngFormControls[n]);e&&r.push(e)});var e=t.updateOn?t.updateOn:"blur",i=new a.FormControl(null,{validators:r,updateOn:e});t.binding&&o.setUpBindingDataPipeline(i,t.binding,t.valueConverter),o.controls[n]=i,o[n]=i})},mn.prototype.createChildForms=function(){var n=this;Object.keys(this.ngChildForms).forEach(function(t){var e=new n.ngChildForms[t].formType;e.init(n.bindingData,n.bindingPath,n.frameContext),n.controls[t]=e,n[t]=e})},mn.prototype.addControls=function(t,e){var n=t&&t.editor&&t.editor.updateOn?t.editor.updateOn:"blur",r=new a.FormControl("",{updateOn:n}),i=t.dataField;t.editor&&t.editor.binding&&(this.setUpBindingDataPipeline(r,i,e),this.controls[t.editor.binding.path]=r,this[t.editor.binding.path]=r)},mn.prototype.setUpBindingDataPipeline=function(a,i,s){var p=this;if(!this.bindingData)throw Error("当前组件上下文中找不到BindingData，请检查！");1<this.bindingPath.length&&(i=this.bindingPath.substr(1).replace(/\//g,".")+"."+i);var u=i.split("."),c=u[u.length-1],t=this.getValueFromBindingData(u,s);a.setValue(t),this.bindingData.changes.pipe(d.takeUntil(this.destroy$)).pipe(d.filter(function(t){var e=p.bindingData.getObject(),n=t.path.join(".");if(t.isUdt)return n===i;if(t.type===x.ChangeType.ValueChanged)return n===i;if(t.type!==x.ChangeType.Load&&t.type!==x.ChangeType.SelectionChanged&&t.type!==x.ChangeType.Remove&&t.type!==x.ChangeType.Update)return t.type===x.ChangeType.UpdateErrors&&(n===i?(p.cardControls[c]=p.cardControls[c]||{},i&&p.controls[c]&&e.primaryKeyValue===t.id&&(p.cardControls[c].errors=t.errors),t.path&&i&&t.errors||(p.cardControls[c].errors=null,p.isFormValid(i)),!1):void 0);var r=""===n?n:n+".";return t&&t.type===x.ChangeType.Load&&p.resetCardValidMsg(),0===i.indexOf(r)})).subscribe(function(t){var e=c,n="";t.isUdt&&(t.isGrid&&t.path.shift(),t.path.length&&(n=t.path.join(".")),e=n);var r=p.bindingData.getValue(u,!1),i=s?s.convertFrom(r):r,o=p.getDomPropertyNameByEntityProp(e);p.cardControls[o]=p.cardControls[o]||{},t.errors&&(p.cardControls[o].errors=t.errors),t.id&&(p.controlIdMap[t.id]&&0===Object.keys(p.controlIdMap[t.id]).length&&(p.controlIdMap[t.id]={}),p.controlIdMap[t.id]=p.controlIdMap[t.id]||{},t.errors&&(p.controlIdMap[t.id][o]={errors:t.errors})),JSON.stringify(a.value)!==JSON.stringify(i)&&a.setValue(i)}),a.valueChanges.pipe(d.takeUntil(this.destroy$)).subscribe(function(t){var e=p.bindingData.getValue(u);if(t&&t.constructor&&"Date"===t.constructor.name){if(isNaN(t))return;if(e&&s){var n=s.convertFrom(e);if(!0===p.compareDate(t,n))return}}if(!0!==p.isDate(s)||!0!==lt.isEqual(t,e)){var r=s?s.convertTo(t):t;if(JSON.stringify(e)!==JSON.stringify(r)){p.clearBackEndMessages(c);var i=p.frameContext.appContext.runMode===x.RunMode.highSpeed;p.bindingData.setValue(u,r,i,!0,null,{frameContext:p.frameContext})}}})},mn.prototype.isDate=function(t){var e=!1;return t&&!0===t.hasOwnProperty("format")&&(e=!0),e},mn.prototype.compareDate=function(t,e){return t&&e?t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()&&t.getHours()===e.getHours()&&t.getMinutes()===e.getMinutes()&&t.getSeconds()===e.getSeconds():t===e},mn.prototype.getPropInfoByPath=function(t){var e=this.frameContext&&this.frameContext.repository.entityType||null;return e?new me(e).getPropInfoByPath(t):null},mn.prototype.getValueFromBindingData=function(t,e){var n=this.bindingData.getValue(t);return e?e.convertFrom(n):n},mn.prototype.getEntityValueChangingListeners=function(){var n=this,r={};return Object.keys(this.ngFormControls).forEach(function(t){var e=n.ngFormControls[t];e.valueChanging&&(r[e.binding]=e.valueChanging)}),r},mn.prototype.getEntityValueChangedListeners=function(){var n=this,r={};return Object.keys(this.ngFormControls).forEach(function(t){var e=n.ngFormControls[t];e.valueChanged&&(r[e.binding]=e.valueChanged)}),r},mn.prototype.getValidationRules=function(){var a=this,s=new Map,p=this.bindingPath;return p.length&&"/"===p&&(p=""),Object.keys(this.ngFormControls).forEach(function(t){if(!0===a.isShowPropMap[t]||0===Object.keys(a.isShowPropMap).length){var e=a.ngFormControls[t],n=e.name||e.defaultI18nValue||"",r=e.binding?e.binding.split("."):[t],i=b([p],r).join("/");if(Array.isArray(e.validRules)&&0<e.validRules.length){var o=b(e.validRules);o.forEach(function(t){t.targetId=e.id,t.targetName=a.formGroupName,t.property=n,t.field=e.binding,t.fullPath=i,a.frameContext&&(t.frameContext=a.frameContext)}),s.set(i,o)}else s.set(i,[{type:"setDisplayInfo",targetId:e.id,targetName:a.formGroupName,property:n,fullPath:i,frameContext:a.frameContext}])}}),s},mn.prototype.setTranslateService=function(t){t&&(this.translate=t,it.setCurrentLanguage(t.getCurrentLanguage()))},mn.prototype.resetFormControls=function(){var n=this;0<Object.keys(this.controls).length&&Object.keys(this.controls).forEach(function(t){var e=n.controls[t];e.markAsUntouched(),e.markAsPristine()})},mn.prototype.clearBackEndMessages=function(t){var r=this;if(t){if(this.cardControls[t]&&this.cardControls[t].errors&&Object.keys(this.cardControls[t].errors).find(function(t){return t.startsWith("message-")})){var e=Object.keys(this.cardControls[t].errors).filter(function(t){return t.startsWith("message-")}),n=E({},this.cardControls[t].errors);e.forEach(function(t){return delete n[t]}),this.cardControls[t]={errors:n}}}else Object.keys(this.cardControls).forEach(function(t){if(r.cardControls[t]&&r.cardControls[t].errors&&Object.keys(r.cardControls[t].errors).find(function(t){return t.startsWith("message-")})){var e=Object.keys(r.cardControls[t].errors).filter(function(t){return t.startsWith("message-")}),n=E({},r.cardControls[t].errors);e.forEach(function(t){return delete n[t]}),r.cardControls[t]={errors:n}}})},mn.insMap={},mn.decorators=[{type:m.Injectable}],mn.ctorParameters=function(){return[]},mn);function mn(){var t=dn.call(this,{},null,null)||this;return t.raisedByValidateEffector=!1,t.isShowValidationMsg=!1,t.validatorJs=n,t.controlIdMap={},t.cardControls={},t.isShowPropMap={},t.destroy$=new g.Subject,t}var vn=(En.loadEntity=function(i,o){var a=this;o.properties.forEach(function(t){var e=t.name;if(t.type===x.BindingPropertyType.List)a.loadEntityList(i[e]||i[Y],o[e]);else if(t.type===x.BindingPropertyType.Object)i&&i[e]&&a.isEffectiveField(i,e)&&a.loadEntity(i[e],o[e]);else if(t.type===x.BindingPropertyType.Dynamic){if(i&&i[e]){var n=Kt.createDynamicBindingObject(i[e].data);Kt.attachDynamicObjectProperty(o,e,n),a.loadEntity(i[e],o[e])}}else if(a.isEffectiveField(i,e)){var r=i[e];o.setValue(e,r,!1,!1)}}),this.setUpEntityPipeline(i,o)},En.setUpEntityPipeline=function(h,a){h&&a&&(h.onValueChanged.pipe(d.takeUntil(h.unsubscribe)).subscribe(function(t){if(t.type===x.ModifyType.ValueChange&&0!==t.path.length&&!0!==t.fromParent){var e=t.path[t.path.length-1],n=t.path[t.path.length-2];if(a.primaryKey&&"id"===a.primaryKey){var r=a.primaryKey;if(n!==r+":"+a.getValue(r))return}if(t.dynamic){if(a.__original__)return;var i=t.value,o=a[e];if(!o)return;Object.keys(i).forEach(function(t){o.getValue(t)!==i[t]&&o.setValue(t,i[t],!0,!1)})}else{if(a.getValue(e)===t.value)return;a.setValue(e,t.value,!0,!1,t.errors)}}}),a.viewChanges.pipe(d.takeUntil(a.unsubscribe)).subscribe(function(s){var e,n,p=s.value,u=s.path[0],t="",c=h.getPaths(),r=c.path,l=a.id;a.__original__=!0,e="",(n=function(t){t&&t&&t.id?e=t.id:t.parent&&n(t.parent)})(a),l=e,r.length&&(t=r.join(".")+".");var f=t+u,i=function(a){Object.values(gn.insMap).find(function(t){return t&&t.enableValidate})?h.validateFromUtilSync(u,p,function(t){var e,n={};t.errors&&0<t.errors.length&&t.errors.forEach(function(e){e.constraints&&Object.keys(e.constraints).forEach(function(t){n[t]={value:p,name:e.constraints[t],error:e}})}),gn.updateErrors(f,n,l,p,c.isGrid);var r=s.errors||{},i=Object.assign({},r,n),o=null;0<Object.keys(i).length&&((e={})[u]=i,o=e),"function"==typeof a&&a(o)},s.context):"function"==typeof a&&a(null)};if(a.primaryKey){var o=a.primaryKey;if(u!==o){if(!h[o]||h[o]!==a[o])return void i()}else if(h[u]!==p)return h[u]=p,void i()}h[u]!==p?i(function(t){h.errors=t,h[u]=p}):i()}))},En.loadEntityList=function(t,e){this.loadEntities(t.items,e),this.setUpEntityListPipeline(t,e)},En.setUpEntityListPipeline=function(m,v){var E=this;m.onListChanged.subscribe(function(t){var e=t.target;if(!e||e===m)switch(t.type){case x.ModifyType.Add:case x.ModifyType.Clone:if(0===t.value.length)return;var n=t.path,r=n[n.length-2],i=v.parent.primaryKeyValue;if(-1===r.indexOf(i))return;E.appendEntities(t.value,v,t.type===x.ModifyType.Clone);break;case x.ModifyType.Insert:var o=t.path,a=o[o.length-2],s=v.parent.primaryKeyValue,p=t.position;if(-1===a.indexOf(s))return;E.insertEntity(t.value[0],v,p);break;case x.ModifyType.Remove:var u=t.path,c=u[u.length-2],l=v.parent.primaryKeyValue;if(-1===c.indexOf(l))return;var f=t.value[v.primaryKey];v.removeByIds([f]);break;case x.ModifyType.Load:var h=t.path,y=h[h.length-2],d=v.parent.primaryKeyValue;if(-1===y.indexOf(d))return;var g=t.value;E.loadEntities(g,v)}})},En.loadRepository=function(n,e){var r=this,t=Array.from(n.entityCollection.toArray());this.loadEntities(t,e),n.entityCollectionChange.pipe(d.takeUntil(n.destroy$)).subscribe(function(t){switch(t.type){case x.ModifyType.Load:e.clear(!0),r.loadEntities(t.value,e,t.entityCreate);break;case x.ModifyType.Add:case x.ModifyType.Clone:r.appendEntities(t.value,e,t.type===x.ModifyType.Clone,{isTreeNodeLoadScene:t.isTreeNodeLoadScene});break;case x.ModifyType.AddData:r.addData(t.value,e,{isTreeNodeLoadScene:t.isTreeNodeLoadScene});break;case x.ModifyType.Insert:r.insertEntity(t.value,e,t.position);break;case x.ModifyType.Remove:r.removeEntities(t.value,e);break;case x.ModifyType.RemoveData:r.removeData(t.value,e);break;case x.ModifyType.PaginationInfoChange:e.paginationInfo=t.value}}),e.changes.pipe(d.takeUntil(e.destroy$)).subscribe(function(t){if(t.type===x.ChangeType.PaginationInfoChange){var e=n.entityCollection;e.paginationInfo=Object.assign({},e.paginationInfo,t.value)}})},En.loadEntities=function(t,e,n){void 0===n&&(n=!1);var r=this.createBindingObjects(t,e);e.load(r,n)},En.appendEntities=function(t,e,n,r){void 0===n&&(n=!1),void 0===r&&(r=null);var i=this.createBindingObjects(t,e);e.append(i,n,r)},En.isEffectiveField=function(t,e){if(!t||!e)return!1;if(e=e.toLowerCase(),t.__farris_effective_fields__)return t.__farris_effective_fields__.includes(e);if(t.farris_effective_fields&&"string"==typeof t.farris_effective_fields){var n=t.farris_effective_fields.split(",").filter(function(t){return t}).map(function(t){return t.toLowerCase()});return(t.__farris_effective_fields__=n).includes(e)}return!0},En.addData=function(t,e,n){void 0===n&&(n=null);var r=this.createBindingObjects(t,e);e.addData(r,n)},En.insertEntity=function(t,e,n){var r=this.createBindingObject(t,e);e.insert(r,n)},En.removeEntities=function(t,e){if(null!==t&&0!==t.length){var n=e.primaryKey,r=[];t.forEach(function(t){r.push(t[n])}),e.removeByIds(r)}},En.removeData=function(t,e){if(null!==t&&0!==t.length){var n=e.primaryKey,r=[];t.forEach(function(t){r.push(t[n])}),e.removeDataByIds(r)}},En.createBindingObjects=function(t,n){var r=this;if(null===t||0===t.length)return[];var i=[];return t.forEach(function(t){var e=Kt.create(n.properties,!0);r.loadEntity(t,e),i.push(e)}),i},En.createBindingObject=function(t,e){var n=Kt.create(e.properties,!0);return this.loadEntity(t,n),n},En.watchReposiroty=function(t,e){t.entityCollectionChange.subscribe(function(t){switch(t.type){case x.ModifyType.PaginationInfoChange:e.pagingInfo=t.value}})},En.getPropInfo=function(t,e){var n,r,i=G.getNgFields(t);Object.keys(i).forEach(function(t){t===e&&(n="NgField",r=null)});var o=G.getNgObjects(t);Object.keys(o).forEach(function(t){t===e&&(n="NgObject",r=o[t].type)});var a=G.getNgList(t);Object.keys(a).forEach(function(t){t===e&&(n="NgList",r=a[t].type)});var s=G.getNgDynamic(t);return Object.keys(s).forEach(function(t){t===e&&(n="NgDynamic",r=s[t].type)}),{propType:n,propEntityType:r}},En.getPrimaryKey=function(t){var e=G.getPrimaryFieldMetadata(t);return e?e.dataField:""},En.isObjectProp=function(t,e){var n=!1,r=G.getNgObjects(t);return Object.keys(r).forEach(function(t){t===e&&(n=!0)}),n},En.isDynamicProp=function(t,e){var n=!1,r=G.getNgDynamic(t);return Object.keys(r).forEach(function(t){t===e&&(n=!0)}),n},En.appendInitialData=function(t,e){var n=Object.assign({},e);delete n.id,delete n.parentID,t.initialData=n},En);function En(){}var bn,Cn,xn,Pn=(Object.defineProperty(In.prototype,"pagingInfo",{get:function(){return this.paginationInfo},set:function(t){this.paginationInfo=t,this.firePagingChangeEvent()},enumerable:!0,configurable:!0}),In.prototype.dispose=function(t){this.list.dispose()},In.prototype.ngOnDestroy=function(){this.dispose()},In.prototype.setPagingInfo=function(t,e,n){if(n.length<1||"/"===n)this.paginationInfo=Object.assign(this.paginationInfo,{pageSize:e,pageIndex:t/e+1});else{var r=this.paginationInfo||{},i=n.substr(1).split("/").filter(function(t){return!!t&&0<t.length}),o=i[i.length-1];o=o.substr(0,o.length-1);var a=i.slice(0,i.length-1),s=this.getValue(a);s&&s[s.primaryKey]&&((r=r[""+o]||{}).pageIndex=(t/e||0)+1,r.pageSize=e||0)}this.firePagingChangeEvent()},In.prototype.updatePagingInfo=function(t,e){if(e.length<1||"/"===e)this.paginationInfo=Object.assign(this.paginationInfo,t);else{var n=this.paginationInfo||{},r=e.substr(1).split("/").filter(function(t){return!!t&&0<t.length}),i=r[r.length-1];n[i=i.substr(0,i.length-1)]=Object.assign(n[i],t)}this.firePagingChangeEvent()},In.prototype.firePagingChangeEvent=function(){this.list.changes.next({type:x.ChangeType.PaginationInfoChange,path:this.bindingPath&&this.bindingPath.split("/").filter(function(t){return t})||[],value:this.paginationInfo})},Object.defineProperty(In.prototype,"changes",{get:function(){return this.list.changes},enumerable:!0,configurable:!0}),In.prototype.setValueChangeInvokerFactory=function(t){this.valueChangeInvokerFactory=t},In.prototype.getValudChangeInvokerFactory=function(){return this.valueChangeInvokerFactory},In.prototype.init=function(t,e){this.initByRepository(t,e)},In.prototype.initByRepository=function(t,e){this.bindingPath=e,this.properties=Rt.getProperties(t.entityType),this.list=Lt.create(this.properties),this.pagingInfo=t.entityCollection.paginationInfo,vn.loadRepository(t,this.list),this.dataTypeInfo=t.entityTypeInfo,this.extendProperties(this.properties)},In.prototype.initByBindingList=function(t,e){this.list=t,this.bindingPath=e,this.extendProperties(this.list.properties)},In.prototype.setDataTypeInfo=function(t){this.dataTypeInfo=t},In.prototype.getValue=function(t,e){void 0===e&&(e=!1);var n=this.list;if(t.forEach(function(t){n=n&&n[t]}),!0===e&&t&&0<t.length){var r=this.getInitValueByPaths(t);n===undefined&&n!==r&&(n=r)}return n},In.prototype.setValue=function(t,e,n,r,i,o){if(void 0===n&&(n=!1),void 0===r&&(r=!0),void 0===i&&(i={}),!t||0===t.length)throw Error("路径不能为空");var a=t.slice(0,t.length-1),s=t[t.length-1],p=this.getValue(a);if(!p)throw Error("找不到要设置的对象");p instanceof In?p=p.list.currentItem:p instanceof Vn&&(p=p.currentItem),this.valueChangeInvokerFactory?p.setValue(s,e,n,r,i,this.valueChangeInvokerFactory(t),o):p.setValue(s,e,n,r,i,null,o)},In.prototype.clearValue=function(t,e,n,r){var i;void 0===e&&(e=!1),void 0===n&&(n=!0);var o=this.dataTypeInfo.getPropInfoByPath(t);i=o&&o.metadataInfo&&o.metadataInfo.initValue!==undefined?o.metadataInfo.initValue:"number"==typeof this.getValue(t)?0:"",this.setValue(t,i,e,n,null,r)},In.prototype.getList=function(){if(!this.bindingPath||"/"===this.bindingPath)return this.list;var t=this.bindingPath.substr(1).split("/").filter(function(t){return""!==t});return this.getValue(t)},In.prototype.getObject=function(){return this.getList().currentItem},In.prototype.getPath=function(t){var n=this,e=t.filter(function(t){return t}),r=[this.list.primaryKey+":"+this.list.currentId];return e.forEach(function(t){r.push(t);var e=n[t];e&&r.push(e.primaryKey+":"+e.currentId)}),r},In.prototype.reset=function(){this.list.clear(!0)},In.prototype.getInitValueByPaths=function(t){var e,n=this.dataTypeInfo&&this.dataTypeInfo.getPropInfoByPath(t)||null;return n&&n.metadataInfo&&n.metadataInfo.initValue!==undefined&&(e=n.metadataInfo.initValue),e},In.prototype.extendProperties=function(t){var n=this;t.forEach(function(t){var e=t.name;Object.defineProperty(n,e,{get:function(){return n.list.currentItem[e]},set:function(t){n.list.currentItem[e]=t}})})},In.decorators=[{type:m.Injectable}],In);function In(){this.paginationInfo=null}(bn=x.Compare||(x.Compare={}))[bn.Equal=0]="Equal",bn[bn.NotEqual=1]="NotEqual",bn[bn.Greater=2]="Greater",bn[bn.GreaterOrEqual=3]="GreaterOrEqual",bn[bn.Less=4]="Less",bn[bn.LessOrEqual=5]="LessOrEqual",bn[bn.Like=6]="Like",bn[bn.NotLike=9]="NotLike",bn[bn.In=14]="In",bn[bn.Empty=1001]="Empty",bn[bn.NotEmpty=1002]="NotEmpty",(Cn=x.FilterRelation||(x.FilterRelation={}))[Cn.Empty=0]="Empty",Cn[Cn.And=1]="And",Cn[Cn.Or=2]="Or",(xn=x.ExpressValueType||(x.ExpressValueType={}))[xn.Value=0]="Value",xn[xn.Expression=1]="Expression",xn.FrontExpress="frontExpress";var Tn=(Mn.prototype.getCurrentLanguage=function(){return window.localStorage.getItem("languageCode")||"zh-CHS"},Mn.prototype.getCompareResult=function(e,t,n){switch(parseInt(""+t,10)){case x.Compare.Equal:return e==n;case x.Compare.NotEqual:return(""+e).toLowerCase()!==(""+n).toLowerCase();case x.Compare.Greater:return n<e;case x.Compare.GreaterOrEqual:return n<=e;case x.Compare.Less:return e<n;case x.Compare.LessOrEqual:return e<=n;case x.Compare.Like:return-1<(""+e).toLowerCase().indexOf(n.toLowerCase());case x.Compare.NotLike:return-1===(""+e).toLowerCase().indexOf(n.toLowerCase());case x.Compare.In:return-1<(n=n||[]).findIndex(function(t){return t==e});case 1001:return""===e||null===e;case 1002:return""!==e&&null!==e;case 1003:return null===e;case 1004:return null!==e}},Mn.prototype.getValue=function(t,e){return e.split(".").filter(function(t){return t}).reduce(function(t,e){return t&&t[e]!==undefined?t[e]:null},t)},Mn.decorators=[{type:m.Injectable}],Mn.ctorParameters=function(){return[]},Mn);function Mn(){}var Sn,jn=(f(wn,Sn=Tn),wn.prototype.filter=function(t,e){var n=this;return t&&t.size?t.filter(function(t){return n.validateRowData(t,e)}):t},wn.prototype.validateRowData=function(t,e){return!e||0===e.length||this.checkRowDataWithCondition(t,e)},wn.prototype.checkRowDataWithCondition=function(s,n){var p=this,u=null;n&&(u={},n.forEach(function(t){var e=t.FilterField,n=p.getValue(s,e),r=s.properties.find(function(t){return t.name===e});r&&r.enableMultiLangInput&&n&&(n=n[p.getCurrentLanguage()]);var i=t.Value,o=t.Compare;if(t){var a=p.getCompareResult(n,o,i);u[e]===undefined?u[e]=[a]:u[e].push(a)}}));var t=Object.keys(u),r=[];return t.forEach(function(e){var t=n.filter(function(t){return t.FilterField===e});1===u[e].length?r.push(u[e][0]):1===t[0].Relation&&2===u[e].length?r.push(u[e][0]&&u[e][1]):r.push(-1<u[e].indexOf(!0))}),-1===r.indexOf(!1)},wn.decorators=[{type:m.Injectable}],wn.ctorParameters=function(){return[]},wn);function wn(){return Sn.call(this)||this}var On,Nn=(f(Dn,On=Tn),Dn.prototype.filter=function(t,e){var n=this;return t&&t.size?t.filter(function(t){return n.validateRowData(t,e)}):t},Dn.prototype.validateRowData=function(t,e){return!e||0===Object.keys(e).length||this.checkAllFieldInRowData(t,e)},Dn.prototype.checkAllFieldInRowData=function(l,f){var h=this,y=null,d=this.getCurrentLanguage();if(f){var t=Object.keys(f);y={},t.forEach(function(e){var t=h.getValue(l,e),n=l.properties.find(function(t){return t.name===e});n&&n.enableMultiLangInput&&t&&(t=t[d]);var r=f[e],i=r.value1,o=r.operator1,a=r.relation,s=r.operator2,p=r.value2;if(r){var u=h.getCompareResult(t,o,i);if(y[e]=u,a){var c=h.getCompareResult(t,s,p);y[e]=h.getRelationResult(u,a,c)}}})}return this.checkAllFieldResult(y)},Dn.prototype.getRelationResult=function(t,e,n){return"and"===e.toLowerCase()?t&&n:t||n},Dn.prototype.checkAllFieldResult=function(t){return!t||Object.values(t).reduce(function(t,e){return t&&e},!0)},Dn.decorators=[{type:m.Injectable}],Dn.ctorParameters=function(){return[]},Dn);function Dn(){return On.call(this)||this}var Vn=(Object.defineProperty(Fn.prototype,"paginationInfo",{get:function(){return this._paginationInfo},set:function(t){this._paginationInfo=t,this._paginationInfo!==t&&this.changes.next({type:x.ChangeType.PaginationInfoChange,path:[],value:this._paginationInfo})},enumerable:!0,configurable:!0}),Object.defineProperty(Fn.prototype,"pageIndex",{get:function(){return this.paginationInfo&&this.paginationInfo.hasOwnProperty("pageIndex")?this.paginationInfo.pageIndex:1},enumerable:!0,configurable:!0}),Object.defineProperty(Fn.prototype,"pageSize",{get:function(){return this.paginationInfo&&this.paginationInfo.hasOwnProperty("pageSize")?this.paginationInfo.pageSize:0},enumerable:!0,configurable:!0}),Object.defineProperty(Fn.prototype,"total",{get:function(){return this.paginationInfo?this.paginationInfo.total||this.paginationInfo.totalCount:0},enumerable:!0,configurable:!0}),Object.defineProperty(Fn.prototype,"skip",{get:function(){return(this.pageIndex-1)*this.pageSize},enumerable:!0,configurable:!0}),Fn.prototype.setPaginationInfo=function(t,e){this.paginationInfo=Object.assign({},this.paginationInfo,{pageSize:e,pageIndex:t/e+1})},Object.defineProperty(Fn.prototype,"currentItem",{get:function(){var t=this.findById(this.currentId);return t||(this.emptyCurrentItem||(this.emptyCurrentItem=Kt.create(this.properties)),this.emptyCurrentItem)},enumerable:!0,configurable:!0}),Object.defineProperty(Fn.prototype,"length",{get:function(){return this.innerList.count()},enumerable:!0,configurable:!0}),Fn.prototype.dispose=function(t){this.clear(!0),this.destroy$&&(this.destroy$.next(),this.destroy$.complete(),this.destroy$=null)},Fn.prototype[Symbol.iterator]=function(){var t=this,e=-1,n=this.innerList.size;return{next:function(){return++e<n?{done:!1,value:t.innerList.get(e)}:{done:!0,value:undefined}}}},Fn.prototype.load=function(t,e){var n=this;if(void 0===e&&(e=!1),this.innerList=this.innerList.clear(),0!==t.length){if(t.forEach(function(t){n.add(t)}),!this.findById(this.currentId)){var r=t[0][this.primaryKey];this.setCurrentId(r,!1,!1)}}else this.currentId=null;var i={type:x.ChangeType.Load,path:[],value:t};i.create=e,this.changes.next(i)},Fn.prototype.append=function(t,e,n){var r=this;if(void 0===e&&(e=!1),void 0===n&&(n=null),0!==t.length){t.forEach(function(t){r.add(t)});var i=t[t.length-1][this.primaryKey];this.setCurrentId(i,!0,!0);var o={type:x.ChangeType.Append,path:[],value:t,isTreeNodeLoadScene:n&&n.isTreeNodeLoadScene};e&&(o.isCloned=!0),this.changes.next(o)}},Fn.prototype.addData=function(t,e){var n=this;void 0===e&&(e=null),0!==t.length&&(t.forEach(function(t){n.add(t)}),this.changes.next({type:x.ChangeType.Append,path:[],value:t,isTreeNodeLoadScene:e&&e.isTreeNodeLoadScene}))},Fn.prototype.insert=function(t,e){var n=this,r=this.innerList.findIndex(function(t){return t.primaryKeyValue===n.currentId});this.innerList=1===e?this.innerList.insert(r+1,t):-1===e?this.innerList.insert(r,t):this.innerList.push(t),t.parent=this,t.changes.subscribe(function(t){n.changes.next(t)}),this.setCurrentId(t.primaryKeyValue,!0,!0),this.changes.next({type:x.ChangeType.Append,path:[],value:t,detail:{type:"insert",position:e}})},Fn.prototype.add=function(t){var e=this;this.innerList=this.innerList.push(t),t.parent=this,t.changes.subscribe(function(t){e.changes.next(t)})},Fn.prototype.removeByIds=function(t){var n=this;if(t&&0!==t.length){var r=this.currentId;t.forEach(function(t){t===r&&(r=n.getCurrentIdBeforeDeleting());var e=n.getIndexById(t);-1!==e&&(n.innerList=n.innerList["delete"](e))}),0===this.innerList.count()?this.currentId=null:this.setCurrentId(r,!1,!1),this.changes.next({type:x.ChangeType.Remove,path:[],value:t})}},Fn.prototype.removeDataByIds=function(t){var n=this;t&&0!==t.length&&(t.forEach(function(t){var e=n.getIndexById(t);-1!==e&&(n.innerList=n.innerList["delete"](e))}),this.changes.next({type:x.ChangeType.Remove,path:[],value:t}))},Fn.prototype.clear=function(t){void 0===t&&(t=!1),this.innerList.forEach(function(t){t._ENTITY_=null,t.unsubscribe.next(),t.unsubscribe.complete(),t.changes.complete(),t.viewChanges.complete()}),this.innerList=this.innerList.clear(),t||(this.currentId=null,this.changes.next({type:x.ChangeType.Remove,path:[],value:[]}))},Fn.prototype.getCurrentIdBeforeDeleting=function(){var t=-1,e=this.getIndexById(this.currentId);return t=e===this.length-1?e-1:e+1,this.getIdByIndex(t)},Fn.prototype.findById=function(e){var t,n=this;return(t=this.innerList.find(function(t){return t.getValue(n.primaryKey)===e}))===undefined?null:t},Fn.prototype.setCurrentId=function(t,e,n,r){void 0===e&&(e=!0),void 0===n&&(n=!0),void 0===r&&(r=!1),this.currentId===t&&!r||(this.findById(t)||r)&&(this.currentId=t,!0===e&&this.changes.next({type:x.ChangeType.SelectionChanged,path:[],value:this.currentItem,force:r}),!0===n&&this.changes.next({type:x.ChangeType.GlobalSelectionChanged,path:[],value:this.currentItem,force:r}))},Fn.prototype.getIndexById=function(e){var n=this;return this.innerList.findIndex(function(t){return t[n.primaryKey]===e})},Fn.prototype.getIdByIndex=function(t){return t<0||t>this.length||!1===this.innerList.has(t)?null:this.innerList.get(t)[this.primaryKey]},Fn.prototype.toArray=function(){return this.innerList.toArray()},Fn.prototype.swapById=function(n,r){var i=this.innerList.find(function(t){return t.primaryKeyValue===n}),o=this.innerList.find(function(t){return t.primaryKeyValue===r});this.innerList=this.innerList.map(function(t,e){return t.primaryKeyValue===n?o:t.primaryKeyValue===r?i:t}).toList(),this.changes.next({type:x.ChangeType.Swap,path:[],detail:{type:"swap",id:[n,r]}})},Fn.prototype.toJSON=function(e){var n=[];return this.innerList.forEach(function(t){n.push(t.toJSON(e))}),n},Fn.prototype.filter=function(e){var t;if(null===this.defaultView&&(this.defaultView=this.innerList.toList()),Array.isArray(e)){var n=new jn;t=this.defaultView.filter(function(t){return n.validateRowData(t,e)}).toList()}else{var r=new Nn;t=this.defaultView.filter(function(t){return r.validateRowData(t,e)}).toList()}this.sortFields&&0<this.sortFields.length?this.innerList=t.sort(this.comparator(this.sortFields,this.sortDirections)).toList():this.innerList=t},Fn.prototype.getPaginationConfigByPath=function(t,e){if(!t||"/"===t)return this.paginationInfo;if("string"!=typeof t)throw new Error("路径必须为字符串！");var n=(t=t.substring(1)).split("/").filter(function(t){return!!t&&0<t.trim().length}).map(function(t){return t.trim()}),r=this.paginationInfo;return n.forEach(function(t){r=r&&r.hasOwnProperty(t)?r[t]:null}),r||(void 0!==e?e:undefined)},Fn.prototype.sortBy=function(t,e,n){this.defaultView||(this.defaultView=this.innerList.toList());var r="string"==typeof t?t.split(",").filter(function(t){return t}):t||[],i="string"==typeof e?e.split(",").filter(function(t){return t}):e||[];if(r.length!==i.length)throw new Error("sortBy:fields and directions not match");this.sortFields=r,this.sortDirections=i,!this.sortFields||this.sortFields.length<1?this.defaultView&&(this.innerList=this.defaultView.toList(),this.defaultView=null):this.innerList=this.innerList.sort(this.comparator(r,i)).toList()},Fn.prototype.getValue=function(t,e,n,r){var i,o;void 0===n&&(n=!1),void 0===r&&(r="zh-CHS"),t instanceof Fn?t=t.currentItem:t instanceof Pn&&(t=t.list.currentItem);var a=null;if(-1===e.indexOf("."))a=t[e];else{var s=e.split(".");try{for(var p=P(s),u=p.next();!u.done;u=p.next()){var c=u.value;t=a=this.getValue(t,c,n,r)}}catch(l){i={error:l}}finally{try{u&&!u.done&&(o=p["return"])&&o.call(p)}finally{if(i)throw i.error}}}return n&&a&&a.hasOwnProperty(r)?a[r]:a},Fn.prototype.comparator=function(c,l){var f=this;return function(p,u){return c.reduce(function(t,e){if(0===t){var n=f.properties.find(function(t){return t.name===e}),r=!1;n&&(r=n.enableMultiLangInput);var i=ht.getCurrentLanguage(),o=["asc"].includes(l[c.indexOf(e)])?1:-1,a=f.getValue(p,e,r,i),s=f.getValue(u,e,r,i);null!==a&&a!==undefined||(a=""),null!==s&&s!==undefined||(s=""),"string"==typeof a&&"string"==typeof s?t=a.localeCompare(s)*o:(s<a&&(t=o),a<s&&(t=-1*o))}return t},0)}},Fn.prototype.updateDefaultView=function(t){var m=this;t.pipe(d.takeUntil(this.destroy$)).subscribe(function(t){var e;if(null!==m.defaultView&&(0===t.path.length&&[x.ChangeType.Load,x.ChangeType.Append,x.ChangeType.Remove,x.ChangeType.Swap].includes(t.type)||t.type===x.ChangeType.ValueChanged&&!0!==t.isBindingListTransmited))switch(t.type){case x.ChangeType.Load:m.defaultView=m.innerList.toList();break;case x.ChangeType.Append:if(t.detail&&"insert"===t.detail.type){var n=t.detail.position,r=t.value,i=m.innerList.findIndex(function(t){return t.primaryKeyValue===m.currentId});m.defaultView=1===n?m.defaultView.insert(i+1,r):-1===n?m.defaultView.insert(i,r):m.defaultView.push(r)}else{var o=t.value;m.defaultView=(e=m.defaultView).push.apply(e,b(o))}break;case x.ChangeType.Remove:var a=t.value;0===a.length?m.defaultView=m.defaultView.clear():a.forEach(function(e){var t=m.defaultView.findIndex(function(t){return t.primaryKeyValue===e});m.defaultView=m.defaultView["delete"](t)});break;case x.ChangeType.ValueChanged:var s=t.id,p=m.defaultView.find(function(t){return t.primaryKeyValue===s}),u=t.path.concat([]),c=u.pop(),l=u.reduce(function(t,e){return t[e]},p);l&&l.setValue(c,t.value);break;case x.ChangeType.Swap:var f=v(t.detail&&t.detail.id,2),h=f[0],y=f[1],d=m.defaultView.find(function(t){return t.primaryKeyValue===h}),g=m.defaultView.find(function(t){return t.primaryKeyValue===y});m.defaultView=m.defaultView.map(function(t,e){return t.primaryKeyValue===h?g:t.primaryKeyValue===y?d:t}).toList()}})},Fn);function Fn(t){this.__type__="BindingList",this.sortFields=[],this.sortDirections=[],this.defaultView=null,this._paginationInfo=null,this.properties=t,this.primaryKey=Rt.getPrimaryKey(t),this.changes=new g.Subject,this.innerList=e.List(),this.currentId=null,this.destroy$=new g.Subject,this.updateDefaultView(this.changes)}var Rn=(Object.defineProperty(_n.prototype,"primaryKeyValue",{get:function(){return this.primaryKey?this.getValue(this.primaryKey):""},enumerable:!0,configurable:!0}),Object.defineProperty(_n.prototype,"rowPrimaryKeyValue",{get:function(){var t=this.getRow(this);return t&&t.primaryKeyValue||null},enumerable:!0,configurable:!0}),_n.prototype.setShowValidationMsg=function(t){this.isShowValidationMsg=t},_n.prototype.getValue=function(t){return this.innerValues.get(t)},_n.prototype.setValue=function(r,i,o,t,a,s,p){var u=this;void 0===o&&(o=!1),void 0===t&&(t=!1);var c=this.getValue(r);if(s&&c!==i||(s=function(t,e,n,r){return g.of(!0)}),!0===t)s(c,i,!1,this.rowPrimaryKeyValue).subscribe(function(t){if(t){u.innerValues=u.innerValues.set(r,i);var e=u.buildViewChangesContext(r,i,c,a,p);if(u.viewChanges.next(e),!0===o){var n=u.buildChangesContext(r,i,p,a);u.changes.next(n)}s(c,i,!0,u.rowPrimaryKeyValue).subscribe()}else n=u.buildChangesContext(r,c,p,a),u.changes.next(n)});else{if(this.innerValues=this.innerValues.set(r,i),!0===o){var e=this.buildChangesContext(r,i,p,a);this.changes.next(e)}s(c,i,!0,this.rowPrimaryKeyValue).subscribe()}},_n.prototype.toJSON=function(a){var s=this,p=this.getCurrentLanguage(),u={};return this.properties.forEach(function(t){var e,n=t.name;if(t.type===x.BindingPropertyType.List){var r=s[n];u[n]=r.toJSON(a)}else if(t.type===x.BindingPropertyType.Object){var i=s[n];u[n]=i.toJSON(a)}else if(t.type===x.BindingPropertyType.Dynamic)i=s[n],u[n]=i.toJSON(a);else if(!0===t.enableMultiLangInput)if(a&&!0===a.ignoreMultiLangInput){var o=s.getValue(n);u[n]=o?o[p]:o}else a&&a.useFullMultiLangProperty?(o=s.getValue(n))&&(u[n+"_MULTILANGUAGE"]=o,u[n]=o[p]):(o=s.getValue(n),u[n]=o||((e={})[p]=o,e));else u[n]=s.getValue(n)}),u},_n.prototype.getCurrentLanguage=function(){return this.currentLanguage=this.currentLanguage||window.localStorage.getItem("languageCode")||"zh-CHS",this.currentLanguage},_n.prototype.buildChangesContext=function(t,e,n,r,i){void 0===i&&(i=x.ChangeType.ValueChanged);var o=this.getRow(this);return{type:i,path:[t],value:e,id:o?o.primaryKeyValue:null,errors:r,context:n}},_n.prototype.buildViewChangesContext=function(t,e,n,r,i,o){return void 0===o&&(o=x.ViewChangeType.ValueChanged),{type:o,path:[t],value:e,preValue:n,errors:r,context:i}},_n.prototype.getRow=function(t){return t&&t.fromEntity||!t.parent||t.parent instanceof Vn?t:this.getRow(t.parent)},_n.prototype.makeHash=function(){for(var t="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;n<10;n++)t+=e.charAt(Math.floor(Math.random()*e.length));return t},_n.prototype.differ=function(){var e,n,r,t=this;return{onValueChange:function(){n=t.makeHash()},isChange:function(){return n!==e},update:function(t){r=t,e=n},value:function(){return r}}},_n);function _n(){this.__type__="BindingObject",this.fromEntity=undefined,this.isShowValidationMsg=!1,this.unsubscribe=new g.Subject,this.controlMap={},this.innerValues=e.Map(),this.changes=new g.Subject,this.viewChanges=new g.Subject}var Bn,An=(f(Ln,Bn=Rn),Ln);function Ln(t){var e=Bn.call(this)||this;return e.properties=t,e.primaryKey=Rt.getPrimaryKey(t),e}var kn=($n.createFromRepository=function(t,e){var n=new Pn,r=Rt.getProperties(t.entityType),i=Lt.create(r);return n.initByBindingList(i,e),n.setDataTypeInfo(t.entityTypeInfo),vn.loadRepository(t,i),n.pagingInfo=t.entityCollection.paginationInfo,n},$n.createFromEntityManager=function(t,e){var n=new Pn,r=Rt.getProperties(t.entityType),i=Lt.create(r);n.initByBindingList(i,e);var o=t.getEntitiesByPath([]);return vn.loadEntities(o,i),n},$n.createFromExistingBindingData=function(t,e){var n=new Pn;return n.initByBindingList(t.list,e),n},$n);function $n(){}var Un="NgBindingData";var Kn=(Hn.convertToBindingPathArray=function(t){return t.split("/").filter(function(t){return""!==t})},Hn.convertToEntityPathArray=function(t,e){var n=this,r=this.convertToBindingPathArray(t),i=[];if(0===r.length)return i;var o=e.list.currentItem;return i.push(this.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue)),r.forEach(function(t){switch(Rt.getPropertyByName(o.properties,t).type){case x.BindingPropertyType.Plain:i.push(t);break;case x.BindingPropertyType.Object:o=o[t],i.push(t),i.push(n.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue));break;case x.BindingPropertyType.List:var e=o[t];o=e.currentItem,i.push(t),i.push(n.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue))}}),i},Hn.convertToRestUrl=function(t,e){var n=this.convertToBindingPathArray(t),r=[],i=e.list.currentItem;return r.push(i.primaryKeyValue),n.forEach(function(t){var e=Rt.getPropertyByName(i.properties,t);if(e.type!==x.BindingPropertyType.List)throw new Error(e.name+"不是子表对应的属性");var n=i[t];i=n.currentItem,r.push(t),r.push(i.primaryKeyValue)}),r.pop(),"/"+r.join("/")},Hn.getLeafPath=function(t){return Hn.convertToBindingPathArray(t).pop()},Hn.getParentPath=function(t){var e=Hn.convertToBindingPathArray(t);return e.pop(),"/"+e.join("/")},Hn.createPrimaryKeyPath=function(t,e){return t+":"+e},Hn);function Hn(){}var Gn=(qn.isGuid=function(t){var e=t.toString();return t&&(t instanceof qn||qn.validator.test(e))},qn.create=function(){return new qn(Je.create())},qn.createEmpty=function(){return new qn("")},qn.parse=function(t){return new qn(t)},qn.raw=function(){return Je.create()},qn.prototype.equals=function(t){return qn.isGuid(t)&&this.value===t.toString()},qn.prototype.isEmpty=function(){return this.value===qn.EMPTY},qn.prototype.toString=function(){return this.value},qn.prototype.toJSON=function(){return{value:this.value}},qn.validator=new RegExp("^[a-z0-9]+$","i"),qn.EMPTY="",qn);function qn(t){if(!t)throw new TypeError("Invalid argument; `value` has no value.");this.value=qn.EMPTY,t&&(this.value=t)}var zn=(Jn.setRunMode=function(t){Jn.mode=t},Jn.getRunMode=function(){return Jn.mode},Jn.mode=null,Jn);function Jn(){}var Wn=(Object.defineProperty(Yn.prototype,"data",{get:function(){return this.newData},set:function(t){this.newData=t},enumerable:!0,configurable:!0}),Object.defineProperty(Yn.prototype,"errors",{get:function(){return this.validErrors},set:function(t){this.validErrors=t},enumerable:!0,configurable:!0}),Object.defineProperty(Yn.prototype,"changeSetPolicy",{get:function(){return this._changeSetPolicy},set:function(t){this._changeSetPolicy=t},enumerable:!0,configurable:!0}),Object.defineProperty(Yn.prototype,"changes",{get:function(){return this.changeSet.changes},enumerable:!0,configurable:!0}),Object.defineProperty(Yn.prototype,"primaryProperty",{get:function(){return this.primaryFieldMetadata||(this.primaryFieldMetadata=G.getPrimaryFieldMetadata(this.constructor)),this.primaryFieldMetadata},enumerable:!0,configurable:!0}),Object.defineProperty(Yn.prototype,"primaryKey",{get:function(){return this.primaryProperty?this.primaryProperty.property:""},enumerable:!0,configurable:!0}),Object.defineProperty(Yn.prototype,"primaryValue",{get:function(){if(this.primaryKey){var t=this[this.primaryProperty.property];return t||""}return""},enumerable:!0,configurable:!0}),Yn.prototype.setChanges=function(t){var e=t.path[t.path.length-1];this.valueChanged.next(t),this.validErrors&&Object.keys(this.validErrors).includes(e)&&"valid"===this.changeSetPolicy||(t&&t.changeSetValue!==undefined&&((t=JSON.parse(JSON.stringify(t))).value=t.changeSetValue),this.changeSet.append(t))},Yn.prototype.validate=function(t,e,n,r,i){var o=this;return g.from(this.validator.validate(this,t,e,n,r,i)).pipe(d.tap(function(t){t.isValid?o.validErrors={}:o.validErrors=ut.convertErrorsToNormalObject(t.errors,{})}))},Yn.prototype.validateAll=function(t){},Yn.prototype.validateFromUtil=function(t,e,n,r){var i=this;this.validErrors={},g.from(this.validator.validate(this,t,e,null,undefined,r&&r.frameContext||null)).subscribe(function(t){t.isValid||(i.validErrors=ut.convertErrorsToNormalObject(t.errors,{})),n(t)})},Yn.prototype.validateFromUtilSync=function(t,e,n,r){this.validErrors={};var i=this.validator.verify(this,t,e,null,undefined,r&&r.frameContext||null,!0);i&&!i.isValid&&(this.validErrors=ut.convertErrorsToNormalObject(i.errors,{})),n(i)},Yn.prototype.getPaths=function(){var r={path:[],isUdt:!1,isGrid:!1},i=function(t){var e=t[W];if(e){var n=e[e.length-1];-1<Object.keys(G.getNgObjects(t[Y].constructor)).indexOf(n)&&(r.isUdt=!0),t instanceof mt==1?r.isGrid=!0:r.path.push(n)}t[Y]&&i(t[Y])};return i(this),r.path=r.path.reverse(),r},Yn.prototype.getEntityListPath=function(){var r=[],i=function(t){var e=t[W];if(e&&t instanceof mt==1){var n=e.concat([]).reverse();Array.prototype.push.apply(r,n)}t[Y]&&i(t[Y])};return i(this),r.reverse()},Yn.prototype.getMainEntityPrimaryValue=function(){for(var t=this;t[Y];)t=t[Y];return t.primaryValue},Yn.prototype.load=function(t,e){void 0===e&&(e={}),t=t||{},this.loadFields(t),(!e||e&&!1!==e.loadChild)&&this.loadLists(t),this.loadObjects(t),this.loadDynamicObjects(t),this.newData=Object.assign({},t),this.originalData=Object.assign({},t)},Yn.prototype.toJSON=function(r){var i=this,o={},a=G.getNgFields(this.constructor);Object.keys(a).forEach(function(t){var e=a[t],n=e.dataField||t;!0===r&&!0===e.enableTimeZone?o[n]=i.data[t]:o[n]=i[t]});var n=G.getNgObjects(this.constructor);Object.keys(n).forEach(function(t){var e=n[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}});var s=G.getNgDynamic(this.constructor);Object.keys(s).forEach(function(t){var e=s[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}});var p=G.getNgList(this.constructor);return Object.keys(p).forEach(function(t){var e=p[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}}),o},Yn.prototype.initialize=function(){var t=this.constructor,e=G.getNgFields(t),n=G.getNgObjects(t),r=G.getNgList(t),i=G.getNgDynamic(t);this.initializeNormalField(e),this.initializeList(r),this.initializeObject(n),this.initializeDynamic(i)},Yn.prototype.createPath=function(t){var e=this.primaryProperty;return e?[e.dataField+":"+this.primaryValue,t]:[":",t]},Yn.prototype.initializeNormalField=function(t){var e=this;Object.keys(t).forEach(function(r){var i=t[r];i.dataField,delete e[r]&&Object.defineProperty(e,r,{get:function(){return this.getPropValue(r,i)},set:function(t){var e=this.getPropValue(r,i);if(!1!==this.isPropValueChanged(r,i,t,e)){this.setPropValue(r,i,t);var n=this.preparePropValue(r,i,t);this.emitValueChange(r,i,t,e,n)}}})})},Yn.prototype.initializeList=function(s){var p=this;Object.keys(s).forEach(function(t){var e=s[t],n=p.createPath(t),r=e.dataField||t,i=p.data[r],o=new mt;if(o[Y]=p,o[W]=n,i){var a=i.map(function(t){return Z(e.type,t)});o.loadEntities(a)}o.onListChanged.subscribe(function(t){t&&(o[W][0]!==t.path[0]&&(t.path=o[W].concat(t.path)),p.setChanges(t))}),p[t]=o})},Yn.prototype.initializeObject=function(s){var p=this;Object.keys(s).forEach(function(n){var r=s[n],i=p.createPath(n),t=r.dataField||n,e=p.data[t]||{},o=function(t){var e;return(e=t instanceof r.type?t:Z(r.type,t))[Y]=p,e[W]=i,e.onValueChanged.subscribe(function(t){t&&(t.path=(p[W]||[]).concat(t.path),p.setChanges(t))}),e},a=o(e);delete p[n]&&Object.defineProperty(p,n,{get:function(){return a},set:function(t){var e={path:a[W],value:t.data,preValue:this[n].data,type:x.ModifyType.ValueChange};a=o(t),this.setChanges(e)}})})},Yn.prototype.initializeDynamic=function(s){var p=this;Object.keys(s).forEach(function(n){var r=s[n],i=p.createPath(n),t=r.dataField||n,e=p.data[t]||{},o=function(t){var e;return(e=t instanceof r.type?t:Z(r.type,t))[Y]=p,e[W]=i,e.onValueChanged.subscribe(function(t){t&&(t.path=(p[W]||[]).concat(t.path),p.setChanges(t))}),e},a=o(e);delete p[n]&&Object.defineProperty(p,n,{get:function(){return a},set:function(t){var e={path:a[W],value:t.data,preValue:this[n].data,type:x.ModifyType.ValueChange};a=o(t),this.setChanges(e)}})})},Yn.prototype.loadFields=function(o){var a=this,s=G.getNgFields(this.constructor);Object.keys(s).forEach(function(t){var e=s[t],n=e.dataField||t,r=o[n];if(!0===e.enableTimeZone){var i=Mt.getTimeZoneOffset();null!==i&&r&&(r=jt.zonedTimeToSpecialTimeZoneOffsetTimeString(r,i))}a[t]=r})},Yn.prototype.loadLists=function(a){var s=this,p=G.getNgList(this.constructor);Object.keys(p).forEach(function(t){var e=p[t],n=e.dataField||t,r=e.type,i=a[n];if(i){var o=i.map(function(t){return Z(r,t)});s[t].loadEntities(o)}else s[t].loadEntities([])})},Yn.prototype.loadObjects=function(i){var o=this,a=G.getNgObjects(this.constructor);Object.keys(a).forEach(function(t){var e=a[t].dataField||t,n=i[e],r=o[t];r&&n&&r.load(n)})},Yn.prototype.loadDynamicObjects=function(i){var o=this,a=G.getNgDynamic(this.constructor);Object.keys(a).forEach(function(t){var e=a[t].dataField||t,n=i[e]||{},r=o[t];r&&r.loadDynamicData(n)})},Yn.prototype.emitValueChange=function(t,e,n,r,i){void 0===i&&(i=undefined);var o={path:this.createPath(t),value:n,changeSetValue:i,preValue:r,type:x.ModifyType.ValueChange};this[W]&&(o.path=this[W].concat(o.path)),this.setChanges(o)},Yn.prototype.preparePropValue=function(t,e,n){var r=undefined;if(!0===e.enableTimeZone){var i=Mt.getTimeZoneOffset();null!==i&&n&&(r=jt.timeZoneOffsetTimeToUtcTimeString(n,i))}return r},Yn.prototype.getPropValue=function(t,e){var n,r=e.dataField||t,i=this.data[r];if(!0===e.enableMultiLangInput&&!i){var o=window.localStorage.getItem("languageCode")||"zh-CHS",a=r.replace("_MULTILANGUAGE","");return(n={})[o]=this.data[a],n}if(!0===e.enableTimeZone){var s=Mt.getTimeZoneOffset();if(null!==s&&i)return jt.zonedTimeToSpecialTimeZoneOffsetTimeString(i,s)}return e.originalDataFieldType===xt&&(i=null!==i&&i!==undefined&&i.toString()||null),i},Yn.prototype.setPropValue=function(t,e,n){var r=e.dataField||t;if(e.originalDataFieldType===xt)this.data[r]=null===n?null:n&&n.toString()||"";else{if(!0===e.enableTimeZone){var i=Mt.getTimeZoneOffset();null!==i&&n&&(n=jt.timeZoneOffsetTimeToUtcTimeString(n,i))}this.data[r]=n}},Yn.prototype.isPropValueChanged=function(t,e,n,r){return!0===e.enableMultiLangInput?(!0!==this.isEmptyMultiLangPropValue(n)||!0!==this.isEmptyMultiLangPropValue(r))&&JSON.stringify(n)!==JSON.stringify(r):(e.originalDataFieldType===xt&&"string"!=typeof n&&null!==n&&n!==undefined&&(n=n.toString()),n!==r)},Yn.prototype.isEmptyMultiLangPropValue=function(t){return!t||0===Object.keys(t).length||!0===Object.values(t).every(function(t){return!t})},Yn);function Yn(t){this.validErrors={},this.primaryFieldMetadata=null,this.originalData=undefined,this.changeSet=new V,this.isValidating=!1,this.newData=undefined,this.unsubscribe=new g.Subject,this.valueChanged=new g.Subject,this.onValueChanged=this.valueChanged.asObservable(),this.onUpdate=new g.Subject,this.validator=new dt,this.newData=Object.assign({},t),this.originalData=Object.assign({},t),this.onValueChanged=this.valueChanged,zn.getRunMode()===x.RunMode.compatible&&this.initialize()}var Zn,Xn=(f(Qn,Zn=Wn),Object.defineProperty(Qn.prototype,"IsNested",{get:function(){return this[Y]instanceof Qn},enumerable:!0,configurable:!0}),Qn.prototype.loadDynamicData=function(t){this.initializeDynamicField(t)},Qn.prototype.initializeDynamicField=function(t){var e=this;Object.keys(t).forEach(function(r){var i=r;if(delete e[r])if(t[r]instanceof Object){var n=e.createPath(r),o=e.createDynamicEntityFromJsonData(t[r],n);Object.defineProperty(e,r,{get:function(){return o},set:function(t){var e={path:o[W],value:t.data,preValue:this[r].data,type:x.ModifyType.ValueChange};o=this.createDynamicEntityFromJsonData(t,n),this.setChanges(e)}})}else Object.defineProperty(e,r,{get:function(){return this.data[i]},set:function(t){var e=this.data[i];if(e!==t){this.data[i]=t;var n={type:x.ModifyType.ValueChange,path:this.createPath(r),value:t,preValue:e};this[W]&&(n.path=this[W].concat(n.path)),this.setChanges(n)}}})})},Qn.prototype.createDynamicEntityFromJsonData=function(t,e){var n,r=this;return t instanceof Qn?n=t:(n=new Qn(t)).constructor=Qn,n[Y]=this,n[W]=e,n.onValueChanged.pipe(d.takeUntil(this.unsubscribe)).subscribe(function(t){t&&(t.path=(r[W]||[]).concat(t.path),r.setChanges(t))}),n},Qn.prototype.setChanges=function(t){var e,n=t.path[t.path.length-1],r=Object.assign({},this.data);this.newData=Object.assign(this.newData,((e={})[n]=t.value,e));var i=t.path;2<t.path.length&&(i=t.path.slice(0,t.path.length-2));var o={path:i,value:this.data,preValue:r,type:t.type,dynamic:!0};this.valueChanged.next(o),this.changeSet.append(t)},Qn.prototype.toJSON=function(){return this.data},Qn);function Qn(t){var e=Zn.call(this,t)||this;return e.loadDynamicData(t),e}var tr,er,nr,rr=new m.InjectionToken("@farris/devkit ENTITY_DATA_SERVICE"),ir={getFieldValue:function(t){var e,n=t.label,r=this.data[n];if(!0!==t.multiLanguage||r)return r;var i=window.localStorage.getItem("languageCode")||"zh-CHS",o=n.replace("_MULTILANGUAGE","");return(e={})[i]=this.data[o],e},setFieldValue:function(t,e){var n=t.label;this.data[n]=e},getComplexFieldValue:function(t){var e=t.label;return this.innerEntities[e]},setComplexFieldValue:function(t,e,n){var r=t.label,i=null;n instanceof e?i=n:(i=new e(n)).constructor=e;var o=this.innerEntities[r],a={path:o&&o[W]||i[W],value:n,preValue:this[r]&&this[r].data||null,type:x.ModifyType.ValueChange};this.innerEntities[r]=i,this.isInitializing||this.setChanges(a)},getEntities:function(t){var e=t.label;return this.innerEntities[e]},setEntities:function(t,e){var n=t.label;this.innerEntities[n]=e},isFieldValueChanged:function(t,e,n){return!0===t.multiLanguage?(!0!==this.isEmptyMultiLangPropValue(e)||!0!==this.isEmptyMultiLangPropValue(n))&&JSON.stringify(e)!==JSON.stringify(n):e!==n},isEmptyMultiLangPropValue:function(t){return!t||(0===Object.keys(t).length||!0===Object.values(t).every(function(t){return!t}))},emitFieldValueChange:function(t,e,n){if(!this.isInitializing){var r=t.label,i={path:this.createPath(r),value:e,preValue:n,type:x.ModifyType.ValueChange};this[W]&&(i.path=this[W].concat(i.path)),this.setChanges(i)}},setChanges:function(t){var e=t.path[t.path.length-1];this.valueChanged.next(t),this.validErrors&&Object.keys(this.validErrors).includes(e)||this.changeSet.append(t)},createPath:function(t){return this.primaryKey?[this.primaryKey+":"+this.primaryValue,t]:[":",t]},getPaths:function(){var r={path:[],isUdt:!1,isGrid:!1},i=function(t){var e=t[W];if(e){var n=e[e.length-1];-1<Object.keys(G.getNgObjects(t[Y].constructor)).indexOf(n)&&(r.isUdt=!0),t instanceof mt==!0?r.isGrid=!0:r.path.push(n)}t[Y]&&i(t[Y])};return i(this),r.path=r.path.reverse(),r},validate:function(t,e,n,r){var i=this;return g.from(this.validator.validate(this,t,e,n,r)).pipe(d.tap(function(t){t.isValid?i.validErrors={}:i.validErrors=ut.convertErrorsToNormalObject(t.errors,{})}))},validateAll:function(t){},validateFromUtil:function(t,e,n){var r=this;this.validErrors={},g.from(this.validator.validate(this,t,e)).subscribe(function(t){t.isValid||(r.validErrors=ut.convertErrorsToNormalObject(t.errors,{})),n(t)})},toJSON:function(r){var i=this,o={},a=G.getNgFields(this.constructor);Object.keys(a).forEach(function(t){var e=a[t],n=e.dataField||t;!0===r&&!0===e.enableTimeZone?o[n]=i.data[t]:o[n]=i[t]});var n=G.getNgObjects(this.constructor);Object.keys(n).forEach(function(t){var e=n[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}});var s=G.getNgDynamic(this.constructor);Object.keys(s).forEach(function(t){var e=s[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}});var p=G.getNgList(this.constructor);return Object.keys(p).forEach(function(t){var e=p[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}}),o}},or=function Mp(){},ar=function Sp(){},sr=function jp(){},pr=function wp(){},ur=function Op(){},cr=function Np(){};(tr=x.SchemaEntityField$Type||(x.SchemaEntityField$Type={})).SimpleField="SimpleField",tr.ComplexField="ComplexField",(er=x.SchemaEntityFieldType$Type||(x.SchemaEntityFieldType$Type={})).StringType="StringType",er.TextType="TextType",er.NumericType="NumericType",er.BooleanType="BooleanType",er.DateType="DateType",er.DateTimeType="DateTimeType",er.EnumType="EnumType",er.EntityType="EntityType",er.HierarchyType="HierarchyType",er.ObjectType="ObjectType",er.BigNumericType="BigNumericType",(nr=x.SchemaEntityFieldTypeName||(x.SchemaEntityFieldTypeName={})).String="String",nr.DateTime="DateTime",nr.Date="Date",nr.Enum="Enum",nr.Boolean="Boolean",nr.Number="Number",nr.Text="Text",nr.BigNumber="BigNumber";var lr=(fr.prototype.create=function(t){var e=t.entities[0].type;return this.createClass(e,t.entities[0])},fr.prototype.createClass=function(t,e){var o=this.createEntityInstanceDataInitializer(t),a=function(t){var e,n,r,i=this;this.changeSet=new V,this.isValidating=!1,this.unsubscribe=new g.Subject,this.validErrors={},this.validator=new dt,this.innerData=Object.assign({},t),this.innerEntities={},this.valueChanged=new g.Subject,this.onValueChanged=this.valueChanged,this.validateFromUtilSync=function(t,e,n,r){this.validErrors={};var i=this.validator.verify(this,t,e,null,undefined,r&&r.frameContext||null,!0);i&&!i.isValid&&(this.validErrors=ut.convertErrorsToNormalObject(i.errors,{})),n(i)},n=t,r=a,(e=this).isInitializing=!0,o(e,n,r),e.isInitializing=!1,this.load=function(t){o(i,t,a),i.data=t}};a.typeName=t.name+"Entity",a.code=e.code,a.label=e.label,a.types={},a.__prop__metadata__={};var n=Object.assign({typeName:"ConcreteEntityPrototype"},ir);return this.definePresetProperty(n,t),this.defineFieldsToPrototype(n,t.fields,t.primary,a),this.defineEntitiesToPrototype(n,t.entities,a),a.prototype=n,a},fr.prototype.definePresetProperty=function(t,e){Object.defineProperty(t,"data",{get:function(){return this.innerData||(this.innerData={}),this.innerData},set:function(t){this.innerData=t}}),Object.defineProperty(t,"errors",{get:function(){return this.validErrors},set:function(t){this.validErrors=t}}),Object.defineProperty(t,"changes",{get:function(){return this.changeSet.changes}}),Object.defineProperty(t,"primaryProperty",{get:function(){return t.innerPrimaryProperty||{dataField:e.primary}}}),Object.defineProperty(t,"primaryKey",{get:function(){return e.primary||""}}),Object.defineProperty(t,"primaryValue",{get:function(){if(this.primaryKey){var t=this[this.primaryKey];return t||""}return""}})},fr.prototype.defineFieldsToPrototype=function(e,t,n,r){var i=this;t&&t.length&&t.forEach(function(t){switch(t.$type){case x.SchemaEntityField$Type.SimpleField:i.defineSimpleFieldToPrototype(e,t,n,r);break;case x.SchemaEntityField$Type.ComplexField:i.defineComplexFieldToPrototype(e,t,r)}})},fr.prototype.defineSimpleFieldToPrototype=function(t,n,e,r){var i=n.label;Object.defineProperty(t,i,{get:function(){return this.getFieldValue(n)},set:function(t){var e=this.getFieldValue(n);!1!==this.isFieldValueChanged(n,t,e)&&(this.setFieldValue(n,t),this.emitFieldValueChange(n,t,e))}});var o={dataField:this.getDataField(n),originalDataField:n.code,originalDataFieldType:n.type.name,path:n.path,primary:n.label===e,enableMultiLangInput:this.getEnableMultiLangInput(n),defaultValue:n.defaultValue,ngMetadataName:_};n.enableStdTimeFormat&&"DateTime"==o.originalDataFieldType&&(o.enableTimeZone=!0),o.primary&&(t.innerPrimaryProperty=o),r.__prop__metadata__[i]||(r.__prop__metadata__[i]=[]),r.__prop__metadata__[i].push(o)},fr.prototype.getDataField=function(t){return t.multiLanguage?t.label+"_MULTILANGUAGE":t.label},fr.prototype.getEnableMultiLangInput=function(t){if(t.multiLanguage)return!0},fr.prototype.defineComplexFieldToPrototype=function(t,e,n){var r=this.createClass(e.type,e);n.types[e.type.name]=r;var i=e.label;Object.defineProperty(t,i,{get:function(){return this.getComplexFieldValue(e)},set:function(t){this.setComplexFieldValue(e,r,t)}});var o={dataField:e.label,originalDataField:e.code,type:r,path:e.path,ngMetadataName:k};n.__prop__metadata__[i]||(n.__prop__metadata__[i]=[]),n.__prop__metadata__[i].push(o)},fr.prototype.defineEntitiesToPrototype=function(i,t,o){var a=this;t&&t.length&&t.forEach(function(e){var t=a.createClass(e.type,e);o.types[e.type.name]=t;var n=e.label;Object.defineProperty(i,n,{get:function(){return this.getEntities(e)},set:function(t){this.setEntities(e,t)}});var r={dataField:e.label,originalDataField:"",type:t,ngMetadataName:A};o.__prop__metadata__[n]||(o.__prop__metadata__[n]=[]),o.__prop__metadata__[n].push(r)})},fr.prototype.createEntityInstanceDataInitializer=function(t){return function(p,u,c){t.fields.filter(function(t){return t.$type===x.SchemaEntityField$Type.ComplexField}).forEach(function(t){var e=t.label,n=c.types[t.type.name],r=u?u[e]:null,i=p.createPath(e),o=p[e];o instanceof n?o.load(r):((o=new n(r)).constructor=n,o[Y]=p,o[W]=i,o.onValueChanged.subscribe(function(t){if(t){t.path=(p[W]||[]).concat(t.path);var e=E({},t,{fromParent:!0});p.setChanges(e)}}),p[e]=o)}),t.entities&&t.entities.forEach(function(t){var e=t.label,n=c.types,r=p.createPath(e),i=p[e];i instanceof mt||((i=new mt).onListChanged.subscribe(function(t){t&&(i[W][0]!==t.path[0]&&(t.path=i[W].concat(t.path)),p.setChanges(t))}),p[e]=i),i[Y]=c,i[W]=r;var o=n[t.type.name],a=u?u[e]:null;if(a){var s=a.map(function(t){var e=new o(t);return e.constructor=o,e});i.loadEntities(s)}}),t.fields.filter(function(t){return t.$type===x.SchemaEntityField$Type.SimpleField}).forEach(function(t){var e=t.label,n=u?u[e]:null;if(!0===t.enableTimeZone){var r=Mt.getTimeZoneOffset();null!==r&&n&&(n=jt.zonedTimeToSpecialTimeZoneOffsetTimeString(n,r))}p[e]=n})}},fr);function fr(){}var hr=(yr.prototype.get=function(t,e,n){return this.request(t,"GET",e,n)},yr.prototype.put=function(t,e,n,r){var i=this.addBody(r,e);return this.request(t,"PUT",n,i)},yr.prototype.post=function(t,e,n,r){var i=this.addBody(r,e);return this.request(t,"POST",n,i)},yr.prototype["delete"]=function(t,e,n){return this.request(t,"DELETE",e,n)},yr.prototype.request=function(t,e,n,r){if(void 0===r&&(r={}),r=r||{},n){var i=this.buildParams(n);r.params=i}var o=e;return t=u.BasePathService.convertPath(t),this.httpClient.request(o,t,r)},yr.prototype.buildParams=function(t){var e=new p.HttpParams;for(var n in t)if(t.hasOwnProperty(n)){var r=t[n].toString();e=e.append(n,r)}return e},yr.prototype.addBody=function(t,e){return t=t||{},Object.assign(t,{body:e})},yr.decorators=[{type:m.Injectable}],yr.ctorParameters=function(){return[{type:p.HttpClient}]},yr);function yr(t){this.httpClient=t}var dr="NgCommandHandler";var gr="NgCommandHandlerExtender";var mr=(vr.prototype.execute=function(t){var e,n=this.func(t);return(e=n)&&(e[Symbol.observable]&&e===e[Symbol.observable]()||e["@@observable"]&&e===e["@@observable"]()||e instanceof g.Observable)?n:g.of(n)},vr);function vr(t,e){this.name=t,this.func=e}var Er=new m.InjectionToken("variable parsers"),br=(Cr.getAppContext=function(t){if("CommandContext"===t.typeName)return t.frameContext.appContext;if(t.appContext)return t.appContext;if("AppContext"===t.typeName)return t;throw new Error("上下文中找不到AppContext，请检查！")},Cr.getFrameContext=function(t){if("CommandContext"===t.typeName)return t.frameContext;if("FrameContext"===t.typeName)return t;throw new Error("上下文中找不到FrameContext，请检查！")},Cr.getRootFrameContext=function(t){return this.getFrameContext(t).root},Cr.getFrameContextById=function(t,e){return this.getAppContext(t).frameContextManager.getFrameContextById(e)},Cr);function Cr(){}var xr=(Pr.prototype.parse=function(o,t){var a=this,s=br.getAppContext(t),e=this.extractPaths(o);if(1===e.length){var n=this.getValue(e[0],s);if(o==="{DATA~"+e[0]+"}")return n;if(o==="{:DATA~"+e[0]+"}")return je(n)}return e.forEach(function(t){var e=a.getValue(t,s),n="{DATA~"+t+"}",r="{:DATA~"+t+"}";if((o=o.replace(n,e)).includes(r)){var i=je(e);o=o.replace(r,i)}}),o},Pr.prototype.extractPaths=function(t){var n=[],e=t.match(/\{:?DATA~(\S+?)\}/g);if(null===e)return[];var r=/\{:?DATA~(\S+?)\}/;return e.forEach(function(t){var e=t.match(r);null!=e&&2===e.length&&n.push(e[1])}),n},Pr.prototype.getValue=function(t,e){var n=t.split("/").filter(function(t){return""!==t}),r=e.getFrameContext(n[0]);if(!r)throw new Error(t+"不正确，请检查！");var i=r.bindingData;if(!i)throw new Error(t+"不正确，请检查！");return i.getValue(n.slice(1))},Pr.decorators=[{type:m.Injectable}],Pr);function Pr(){}var Ir=(Tr.prototype.parse=function(o,t){var a=this,s=br.getAppContext(t),e=this.extractPaths(o);if(1===e.length){var n=this.getUIState(e[0],s);if(o==="{UISTATE~"+e[0]+"}")return n;if(o==="{:UISTATE~"+e[0]+"}")return je(n)}return e.forEach(function(t){var e="{UISTATE~"+t+"}",n=a.getUIState(t,s),r="{:UISTATE~"+t+"}";if((o=o.replace(e,n)).includes(r)){var i=je(n);o=o.replace(r,i)}}),o},Tr.prototype.extractPaths=function(t){var n=[],e=t.match(/\{:?UISTATE~(\S+?)\}/g);if(null===e)return[];var r=/\{:?UISTATE~(\S+?)\}/;return e.forEach(function(t){var e=t.match(r);null!=e&&2===e.length&&n.push(e[1])}),n},Tr.prototype.getUIState=function(t,e){var n=t.split("/").filter(function(t){return""!==t}),r=v(n,2),i=r[0],o=r[1],a=e.getFrameContext(i),s=a&&a.uiState[o];if(s&&s.constructor.toString().startsWith("function Date()"))return this.formatDate(s);for(var p=2;p<n.length;p++)if(!(s=s[n[p]]))return s;return s},Tr.prototype.formatDate=function(t){if(!t)return"";var e=t.getFullYear(),n=(t.getMonth()+1).toString();n=1===n.length?"0"+n:n;var r=t.getDate().toString();return e+"-"+n+"-"+(r=1===r.length?"0"+r:r)},Tr.decorators=[{type:m.Injectable}],Tr);function Tr(){}var Mr=(Sr.prototype.parse=function(r,i){var o=this,t=this.extractPaths(r);return 1===t.length&&r==="{STATEMACHINE~"+t[0]+"}"?this.getValue(t[0],i):(t.forEach(function(t){var e="{STATEMACHINE~"+t+"}",n=o.getValue(t,i);r=r.replace(e,n)}),r)},Sr.prototype.extractPaths=function(t){var n=[],e=t.match(/\{STATEMACHINE~(\S+?)\}/g);if(null===e)return[];var r=/\{STATEMACHINE~(\S+?)\}/;return e.forEach(function(t){var e=t.match(r);null!=e&&2===e.length&&n.push(e[1])}),n},Sr.prototype.getValue=function(t,e){var n=this.getPathObj(t),r=this.getTargetStateMachine(n.frameId,e);if("currentState"===n.type)return r.context.state;if("renderStates"===n.type)return r[n.name];throw new Error("不支类型为"+n.type+"的状态机变量")},Sr.prototype.getTargetStateMachine=function(t,e){var n;if(!(n=t?br.getFrameContextById(e,t):br.getRootFrameContext(e))||!n.stateMachine)throw new Error("找不到对应的状态机实例，请检查！");return n.stateMachine},Sr.prototype.getPathObj=function(t){var e=this.splitPath(t);return"currentState"===e[0]||"renderStates"===e[0]?{frameId:"",type:e[0],name:e[1]}:{frameId:e[0],type:e[1],name:e[2]}},Sr.prototype.splitPath=function(t){return t.split("/").filter(function(t){return""!==t})},Sr.decorators=[{type:m.Injectable}],Sr.ctorParameters=function(){return[]},Sr);function Sr(){}var jr=(wr.prototype.parse=function(r,i){var o=this,t=this.extractPaths(r);return 1===t.length&&r==="{COMMAND~"+t[0]+"}"?this.getValue(t[0],i):(t.forEach(function(t){var e="{COMMAND~"+t+"}",n=o.getValue(t,i);r=r.replace(e,n)}),r)},wr.prototype.extractPaths=function(t){var n=[],e=t.match(/\{COMMAND~(\S+?)\}/g);if(null===e)return[];var r=/\{COMMAND~(\S+?)\}/;return e.forEach(function(t){var e=t.match(r);null!=e&&2===e.length&&n.push(e[1])}),n},wr.prototype.getValue=function(t,e){if(e instanceof Jr==0)throw new Error("当前上下文不支持COMMAND变量，请检查！");var n=t.split("/").filter(function(t){return""!==t}),r=n.shift();if("params"===r){var i=n.shift();return e.command.params[i]}if("results"===r)return n.reduce(function(t,e){return t&&t[e]},e.results)},wr.decorators=[{type:m.Injectable}],wr.ctorParameters=function(){return[]},wr);function wr(){}var Or=(Nr.prototype.parse=function(n,r,i){var o=this;return"string"==typeof n&&0<n.length?this.parseExpression(n,r,i):(Array.isArray(n)?n.forEach(function(t,e){n[e]="string"==typeof t?o.parseExpression(t,r,i):o.parse(t,r,i)}):"object"==typeof n&&null!==n&&Object.keys(n).forEach(function(t){"string"==typeof n[t]?n[t]=o.parseExpression(n[t],r,i):n[t]=o.parse(n[t],r,i)}),n)},Nr.prototype.evaluate=function(t,e,n){var r=this.parse(t,e,n);return new Function("return "+r)()},Nr.prototype.parseExpression=function(e,n,r){return""===e?"":(this.parsers.forEach(function(t){"string"==typeof e&&(e=t.parse(e,n,r))}),e)},Nr.decorators=[{type:m.Injectable}],Nr.ctorParameters=function(){return[{type:Array,decorators:[{type:m.Inject,args:[Er]}]}]},Nr);function Nr(t){this.parsers=t}var Dr=/#{\S+?}/g,Vr=(Fr.prototype.parse=function(n,t){var r=this;this.context=t;var e=this.extractVariables(n);return!e||e.length<1||e.forEach(function(t){var e=r.getVariableValue(t);n=n.replace(Dr,e)}),n},Fr.prototype.getVariableValue=function(t){var e=t.substring(2,t.length-1);return this.getFullFrameId(e)},Fr.prototype.extractVariables=function(t){return t?t.match(Dr):[]},Fr.prototype.getFullFrameId=function(t){var e=br.getFrameContext(this.context).namespace||"";return(e?e+"_":"")+t},Fr.decorators=[{type:m.Injectable}],Fr);function Fr(){}var Rr=/\{FORMSTATE~\/(\S+?)\}/g,_r=/\{FORMSTATE~\/(\S+?)\}/,Br=(Ar.prototype.parse=function(i,t){var o=this;this.context=t;var e=this.extractVariables(i);return!e||e.length<1||e.forEach(function(t){var e=t.match(_r);if(e&&2===e.length){var n=e[1],r=o.getVariableValue(n);i=i.replace(_r,r)}}),i},Ar.prototype.getVariableValue=function(t){return br.getFrameContext(this.context).appContext.params.get(t)},Ar.prototype.extractVariables=function(t){if(!t)return null;var e=t.match(Rr);return!e||e.length<1?null:e},Ar);function Ar(){}var Lr=/\{EVENTPARAM~\/(\S+?)\}/g,kr=/\{EVENTPARAM~\/(\S+?)\}/,$r=(Ur.prototype.parse=function(i,t,o){var a=this;this.context=t;var e=this.extractVariables(i);return!e||e.length<1||e.forEach(function(t){var e=t.match(kr);if(e&&2===e.length){var n=e[1],r=a.getVariableValue(n,o);i=i.replace(kr,r)}}),i},Ur.prototype.extractVariables=function(t){if(!t)return null;var e=t.match(Lr);return!e||e.length<1?null:e},Ur.prototype.getVariableValue=function(t,e){return e&&t?t.split("/").filter(function(t){return t}).reduce(function(t,e){return t?t[e]:null},e):null},Ur.decorators=[{type:m.Injectable}],Ur);function Ur(){}var Kr=[{provide:Er,multi:!0,useClass:Vr},{provide:Er,multi:!0,useClass:Br},{provide:Er,multi:!0,useClass:$r},{provide:Er,multi:!0,useClass:xr},{provide:Er,multi:!0,useClass:Ir},{provide:Er,multi:!0,useClass:Mr},{provide:Er,multi:!0,useClass:jr},Or],Hr=(Gr.prototype.canLink=function(t){var e;switch(typeof this.condition){case"boolean":e=this.condition;break;case"function":e=this.condition(t);break;case"string":var n=t&&t.frameContext&&t.frameContext.injector&&t.frameContext.injector.get(Or);e=n&&n.evaluate(this.condition,t);break;default:e=!1}return e},Gr);function Gr(t,e,n){this.from=t,this.to=e,this.condition=n}var qr=(zr.prototype.addNode=function(t,e){var n=new mr(t,e);this.nodes.push(n)},zr.prototype.addNodes=function(t){this.nodes=this.nodes.concat(t)},zr.prototype.insertNode=function(t,e,n){var r=this.findNodeIndex(t),i=this.createNode(e,n);this.nodes.splice(r,0,i)},zr.prototype.appendNode=function(t,e,n){var r=this.findNodeIndex(t)+1,i=this.createNode(e,n);this.nodes.splice(r,0,i)},zr.prototype.findNodeIndex=function(e){return this.nodes.findIndex(function(t){return t.name===e})},zr.prototype.createNode=function(t,e){return new mr(t,e)},zr.prototype.addLink=function(t,e,n){var r=this.createLink(t,e,n);this.links.push(r)},zr.prototype.addLinks=function(t){this.links=this.links.concat(t)},zr.prototype.createLink=function(t,e,n){return new Hr(t,e,n)},zr.prototype.getNext=function(e,n){if(!e)return this.nodes.shift();var r=this.links.find(function(t){return t.from===e&&t.canLink(n)});return r?this.nodes.find(function(t){return t.name===r.to}):void 0},zr.prototype.clone=function(){var t=new zr;return t.addNodes(this.nodes),t.addLinks(this.links),t},zr);function zr(){this.nodes=[],this.links=[]}var Jr=(Wr.prototype.dispose=function(){this.eventParam=null,this.command=null,this.results=null,this.latestResult=null,this.frameContext=null},Wr.prototype.clearResults=function(){this.results=null},Wr);function Wr(t,e){this.typeName="CommandContext",this.results={},this.command=t,this.frameContext=e}var Yr=new m.InjectionToken("@farris/devkit TranslateToken"),Zr=(Xr.prototype.dispose=function(t){this.destroy$&&(this.destroy$.next(),this.destroy$.complete()),this.frameContext=null},Xr.prototype.ngOnDestroy=function(){this.dispose()},Xr.prototype.init=function(t,e){this.frameContext=t,this.parseService=e,this.taskFlow=new qr,this.schedule()},Xr.prototype.execute=function(a){var s=this,p=new g.Subject,u=this.taskFlow.clone();return setTimeout(function(){if(!s.frameContext||s.frameContext.isDisposed)return g.EMPTY;var t=E({},a).eventParam,e=void 0===t?null:t;delete a.eventParam;var n=JSON.parse(JSON.stringify(a));n.params=s.paramsTransform(n.params),n.params=s.parseService.parse(n.params,s.frameContext,e),a.eventParam=e,n.eventParam=e,s.transParamTypes(n.params,n.paramDescriptions);var r=new Jr(n,s.frameContext);r.eventParam=a.eventParam||null;var i=new g.BehaviorSubject(r),o=u.getNext("",r);i.pipe(d.concatMap(function(e){return o.execute(e).pipe(d.take(1),d.map(function(t){return e.results[o.name]=t,e.latestResult=t,(o=u.getNext(o.name,e))?i.next(e):i.complete(),e}),d.throwIfEmpty(function(){i.complete()}))})).pipe(d.takeLast(1)).subscribe({next:function(t){s.waitForDestroy(t),p.next(t.latestResult)},error:function(t){s.waitForDestroy(r),s.displayError(t),p.error(t||"")},complete:function(){s.waitForDestroy(r),p.complete()}})},0),p},Xr.prototype.waitForDestroy=function(t){t&&(t.clearResults(),this.frameContext&&this.frameContext.appContext&&this.frameContext.appContext.destorySignal&&this.frameContext.appContext.destorySignal.pipe(d.takeUntil(this.destroy$)).subscribe(function(){t&&(t.dispose(),t=null)}))},Xr.prototype.displayError=function(t){t&&console&&console.error&&console.error(t)},Xr.prototype.paramsTransform=function(n){var r=/\{\{(\w+)\}\}/g;if(!n)return null;var i=this.frameContext&&this.frameContext.injector&&this.frameContext.injector.get(Yr,null)||null,t=Object.keys(n),o={};return 0===t.length?n:(t.forEach(function(t){var e=n[t];e&&r.test(e)&&i&&(e=e.replace(r,function(t,e){return i.transform(e,null)})),o[t]=e}),o)},Xr.prototype.addTask=function(t,e){this.taskFlow.addNode(t,e)},Xr.prototype.addLink=function(t,e,n){this.taskFlow.addLink(t,e,n)},Xr.prototype.insertTask=function(t,e,n){throw new Error("Not Implemented")},Xr.prototype.afterTask=function(t,e,n){throw new Error("Not Implemented")},Xr.prototype.replaceTask=function(t,e){throw new Error("Not Implement")},Xr.prototype.invoke=function(t,e,n,r){this.setContextToServiceInstance(t,r);var i=this.parseService.parse(n,r,r.eventParam);return t[e].apply(t,b(i))},Xr.prototype.setContextToServiceInstance=function(t,e){var n=t.context;n&&n instanceof Jr==0||(t.context=e)},Xr.prototype.transParamTypes=function(o,a){a&&Object.keys(o).forEach(function(t){if(a[t]&&a[t].type){var e=a[t].type,n=o[t];if(n!==undefined&&null!==n&&typeof n!==e)switch(e){case"string":o[t]=n+"";break;case"int":case"double":case"number":var r=Number(n);if(isNaN(r))throw Error("类型转换失败，参数"+t+"值为"+n+"，无法转换为"+e+"类型。");o[t]=r;break;case"boolean":var i=void 0;i="true"===(n+"").toLowerCase(),o[t]=i}}})},Xr);function Xr(){this.destroy$=new g.Subject}var Qr=new m.InjectionToken("@Farris Command Handlers"),ti=(ei.prototype.set=function(t,e){if(this.handlerMap.has(t))throw new Error(t+"对应的CommandHandler已经存在");this.handlerMap.set(t,e)},ei.prototype.get=function(t){if(!1===this.handlerMap.has(t))throw new Error("找不到"+t+"对应的CommandHandler");return this.handlerMap.get(t)},ei.prototype.regist=function(t){var e=t.commandName;if(!e){var n=w.getClassMetadataByName(t.constructor,dr);if(!n)throw new Error("CommandHandler必须指定要处理的命令名称");e=n.commandName}this.set(e,t)},ei.prototype.dispose=function(){this.handlerMap&&this.handlerMap.forEach(function(t){t.dispose()}),this.handlerMap.clear()},ei.decorators=[{type:m.Injectable}],ei.ctorParameters=function(){return[{type:Array,decorators:[{type:m.Optional},{type:m.Inject,args:[Qr]}]}]},ei);function ei(t){var e=this;this.handlerMap=new Map,t&&t.forEach(function(t){e.regist(t)})}var ni=(ri.decorators=[{type:m.Injectable}],ri);function ri(){}var ii=new m.InjectionToken("@farris/devkit CommandHandler Extenders"),oi=(ai.prototype.get=function(t){return!1===this.extendersMap.has(t)?[]:this.extendersMap.get(t)},ai.prototype.set=function(t,e){this.extendersMap.has(t)?this.extendersMap.get(t).push(e):this.extendersMap.set(t,[e])},ai.prototype.regist=function(t){var e=w.getClassMetadataByName(t.constructor,gr);if(!e)throw new Error("CommandHandlerExtender必须指定要扩展的命令名称");var n=e.commandName;this.set(n,t)},ai.prototype.dispose=function(){this.extendersMap.clear()},ai.decorators=[{type:m.Injectable}],ai.ctorParameters=function(){return[{type:Array,decorators:[{type:m.Optional},{type:m.Inject,args:[ii]}]}]},ai);function ai(t){var e=this;this.extendersMap=new Map,t&&t.forEach(function(t){e.regist(t)})}var si="NgParam",pi=j(si,function(t){return t}),ui=(ci.getUIFields=function(t){return w.getPropsMetadatasByName(t,si)},ci);function ci(){}var li=(fi.prototype._init=function(){var t=ui.getUIFields(this.constructor);this.initializeUIField(t)},fi.prototype.initialize=function(t){var e=t.metadata.uiStates||ui.getUIFields(this.constructor);this.initializeUIField(e)},fi.prototype.initializeUIField=function(n){var r=this;Object.keys(n).forEach(function(t){var e=n[t].stateName||t;delete r[t]&&r.defineProperty(t,e)})},fi.prototype.isExistProperty=function(t){return!(!this.innerData.hasOwnProperty(t)&&!this.hasOwnProperty(t))},fi.prototype.defineProperty=function(o,a){void 0===a&&(a=null),Object.defineProperty(this,o,{get:function(){return null!==a?this.innerData[a]:this.innerData[o]},set:function(t){var e=null!==a?this.innerData[a]:this.innerData[o];if(!0===this.paramTypeTransform){var n=ui.getUIFields(this.constructor),r=n&&n[o]||null,i=r&&r.originalDataType||null;i&&(t=this.transform(t,i))}e!==t&&(null!==a?this.innerData[a]=t:this.innerData[o]=t,this.changes.next({field:o,value:t}))}})},fi.prototype.setPropertyValue=function(t,e){""!==t&&t!==undefined&&(this.isExistProperty(t)||this.defineProperty(t),this[t]=e)},fi.prototype.transform=function(t,e){if(!e)return t;if("string"===(e=e.toLowerCase()))return null===t||t===undefined?t:t.toString();if("number"===e){if(t===undefined)return undefined;var n=Number(t);if(isNaN(n))throw new Error(t+"无法转换为数字！");return n}if("boolean"===e){if("boolean"==typeof t)return t;if(null===t||t===undefined)return!1;if("false"===(t=t.toString().toLowerCase()))return!1;if("true"===t)return!0;throw new Error(t+"无法转换为布尔类型！")}if("date"===e||"datetime"===e)return t;if("object"!==e)return t;if("object"==typeof t)return t;try{return JSON.parse(t)}catch(r){throw new Error(t+"无法转换为对象！")}},fi.decorators=[{type:m.Injectable}],fi.ctorParameters=function(){return[]},fi);function fi(){this.paramTypeTransform=!1,this.changes=new g.Subject,this.innerData=Object.assign({}),this._init()}var hi=new m.InjectionToken("@farris/devkit_param_type_transform"),yi=function Dp(t){this.name=t},di=(gi.prototype.initialize=function(t,e){this.frameContext=this.stateMachine&&this.stateMachine.frameContext||null,this.state=this.state||(e?e.name:""),this.parser=t,this.stateMachineEvent=this.stateMachine.stateMachineEvent},gi.prototype.transitTo=function(t){var e=this.stateMachine.states[t];e&&(this.state=e.name,this.stateMachine.render())},gi.prototype.parse=function(t,e){if(null===t||t===undefined)return t;var n=this.stateMachineEvent.getFrameContext(t)||this.stateMachine.frameContext;switch(e){case"source":return this.parseSourceValue(t,n);case"target":return this.parser.parse(t,n)}},gi.prototype.parseSourceValue=function(t,e){if(null===t||t===undefined)return t;var n=t.trim();return"state"===(n=this.parser.parse(n,e))&&(n=this.state),n},gi.prototype.get=function(t){return this.getUIState(t)},gi.prototype.getUIState=function(t){if(t){var e=this.stateMachineEvent.getFrameContext(t);if(e){if(this.stateMachineEvent.ListenUIStateChange(e,t),this.parser){var n=this.parser.parse(t,e);return null===n||"object"==typeof n&&0===Object.keys(n).length?null:n}throw new Error("未初始化变量解析器。")}}},gi.prototype.getData=function(t){if(t){var e=this.stateMachineEvent.getFrameContext(t);if(e){if(this.stateMachineEvent.ListenEntityChange(e,t),this.parser){var n=this.parser.parse(t,e);return null===n||"object"==typeof n&&0===Object.keys(n).length?null:n}throw new Error("未初始化变量解析器。")}}},gi);function gi(t){this.stateMachine=t}var mi=(Object.defineProperty(vi.prototype,"appContext",{get:function(){return this.stateMachine.appContext},enumerable:!0,configurable:!0}),vi.prototype.initialize=function(t){this.frameContext=t},vi.prototype.extractPaths=function(t){var n="";if("string"==typeof t){var e=t.match(/\{UISTATE~(\S+?)\}$/g),r=t.match(/\{DATA~(\S+?)\}$/g);if(null!==e){var i=/\{UISTATE~(\S+?)\}$/;e.forEach(function(t){var e=t.match(i);null!=e&&2===e.length&&(n=e[1])})}if(null!==r){var o=/\{DATA~(\S+?)\}$/;r.forEach(function(t){var e=t.match(o);null!=e&&2===e.length&&(n=e[1])})}}return n},vi.prototype.getFrameContext=function(t){var e=this.extractPaths(t).split("/")[1]||"";if(e.startsWith("#{")&&e.endsWith("}")&&this.frameContext){var n=e.substring(2,e.length-1);e=this.frameContext.namespace?this.frameContext.namespace+"_"+n:n}return this.appContext.getFrameContext(e)},vi.prototype.getFrameField=function(t){return this.extractPaths(t).split("/")[2]},vi.prototype.ListenUIStateChange=function(e,t){var n=this,r=this.getFrameField(t);this.frameContextMap.has(e)||(this.frameContextMap.set(e,this.uiFieldList),e.uiState.changes.subscribe(function(t){t.field&&-1<n.frameContextMap.get(e).indexOf(t.field)&&n.stateMachine.render()})),-1===this.frameContextMap.get(e).indexOf(r)&&this.uiFieldList.push(r)},vi.prototype.ListenEntityChange=function(e,t){var n=this;this.dataFrameContextMap.has(e)||(this.dataFrameContextMap.set(e,this.dataFieldList),e.bindingData.changes.subscribe(function(t){"Load"!==t.type&&"SelectionChanged"!==t.type||n.stateMachine.render(),t.path.join()&&n.isAccordingValue(n.dataFrameContextMap.get(e),t.path.join("/"))&&n.stateMachine.render()})),-1===this.dataFrameContextMap.get(e).indexOf(t)&&this.dataFieldList.push(t)},vi.prototype.isAccordingValue=function(t,e){return t.find(function(t){return-1<t.indexOf(e)})!==undefined},vi.decorators=[{type:m.Injectable}],vi.ctorParameters=function(){return[{type:bi}]},vi);function vi(t){this.stateMachine=t,this.uiFieldList=[],this.dataFieldList=[],this.frameContextMap=new Map,this.dataFrameContextMap=new Map}var Ei={transit:{perform:function(t,e,n){void 0===n&&(n=[]);var r=t.states[e];t.context.transitTo(r.name),t.render()}}},bi=(Ci.prototype.dispose=function(t){this.isDisposed=!0,this.frameContext=null,this.appContext=null,this.context=null,this.stateMachineEvent=null,this.metadatas=null},Ci.prototype.ngOnDestroy=function(){this.dispose()},Ci.prototype.initialize=function(t,e){this.appContext=t.appContext,this.frameContext=t;var n=this.appContext.metadata.stateMachine||this.collectionMetadata();this.metadatas=n,this.buildStateMachine(n),this.context.initialize(e,this.initialState),this.stateMachineEvent.initialize(this.frameContext),this.render()},Ci.prototype.collectionMetadata=function(){var n={states:{},renderStates:{},actions:{}},t=w.getPropsMetadatas(this.constructor);return t&&Object.keys(t).forEach(function(e){t[e].forEach(function(t){switch(t.ngMetadataName){case"NgState":n.states[e]=t;break;case"NgRenderState":n.renderStates[e]=t;break;case"NgAction":n.actions[e]=t}})}),n},Ci.prototype.buildStateMachine=function(e){var n=this;Object.keys(e.states).forEach(function(t){n.buildNgState(t,e.states[t])}),Object.keys(e.renderStates).forEach(function(t){n.buildNgRenderState(t,e.renderStates[t])}),Object.keys(e.actions).forEach(function(t){n.buildNgAction(t,e.actions[t])})},Ci.prototype.buildNgState=function(t,e){this.states=this.states||{},this[t]=new yi(t),this.states[t]=this[t],e.initialState&&(this.initialState=this[t])},Ci.prototype.buildNgRenderState=function(t,e){this.renderStates=this.renderStates||{},this[t]=!1,this.renderStates[t]=this[t],this.renders=this.renders||{},this.renders[t]=e.render},Ci.prototype.buildNgAction=function(t,e){var n=this;this[t]=function(){Ei.transit.perform(n,e.transitTo,e.precondition)}},Ci.prototype.render=function(){if(!this.isDisposed){for(var t in this.renderStates)if(!1!==this.renderStates.hasOwnProperty(t)){var e=this.renders[t];e&&(this.renderStates[t]=e(this.context),this[t]=this.renderStates[t])}this.stateChange.next(this.context.state)}},Ci);function Ci(){var n=this;this.isStateInited=!1,this.isDisposed=!1;var t=w.getPropsMetadatas(this.constructor);t&&Object.keys(t).forEach(function(e){t[e].forEach(function(t){n["build"+t.ngMetadataName](e,t)})}),this.stateChange=new g.BehaviorSubject(!1),this.context=new di(this),this.stateMachineEvent=new mi(this)}var xi=j("NgState",function(t){return t}),Pi=j("NgRenderState",function(t){return t}),Ii=j("NgAction",function(t){return t}),Ti="NgCommand",Mi=j(Ti,function(t){return t}),Si=(Object.defineProperty(ji.prototype,"expression",{get:function(){return this.frameContext.expressionManager},enumerable:!0,configurable:!0}),Object.defineProperty(ji.prototype,"expressionResult",{get:function(){return this.frameContext.expressionResult},enumerable:!0,configurable:!0}),ji.prototype.ngOnDestroy=function(){this.dispose()},ji.prototype.dispose=function(t){this.form=null,this.entityValueChangingListeners&&this.entityValueChangingListeners.clear(),this.entityValueChangedListeners&&this.entityValueChangedListeners.clear(),this.verifycationChanged&&(this.verifycationChanged.complete(),this.verifycationChanged=null)},ji.prototype.setMetadata=function(t){!this.bindingPath&&t&&t.bindingTo&&(this.bindingPath=t.bindingTo)},ji.prototype.init=function(t){var y=this;this.name||(this.name=t.metadata.viewModelCode||this.constructor.name),this.frameContext=t,this.bindingData=t.bindingData,this.uiState=t.uiState,this.form=t.form,this.stateMachine=t.stateMachine,this.buildCommands(t),this.entityValueChangingListeners=new Map,this.entityValueChangedListeners=new Map,this.bindingData&&this.bindingData.setValueChangeInvokerFactory(function(h){return function(t,e,n,r){var i,o="/"+h.join("/");if(i=!1===n?y.entityValueChangingListeners[o]:y.entityValueChangedListeners[o]){var a={paths:h,preValue:t,value:e,id:r,changed:n},s="trigger:",p=i.split(";").filter(function(t){return t}),u=p.filter(function(t){return!t.startsWith(s)}),c=p.filter(function(t){return t.startsWith(s)}),l=u.concat(c),f=!0;return g.from(l).pipe(d.concatMap(function(t){if(!f&&!1===n)return g.EMPTY;if(t.startsWith(s)){var e=t.substring(8);return y.frameContext.frameComponent.trigger(e),f=!0,g.of(!0)}return y[t](a).pipe(d.tap(function(t){f=t}))}),d.every(function(t){return t}))}return g.of(!0)}}),this.initListeners()},ji.prototype.buildCommands=function(i){var e=this,n=i.metadata.commands||w.getPropsMetadatasByName(this.constructor,Ti);this.metadatas=n,this.keybindingMap=new Map,Object.keys(n).forEach(function(t){var r=n[t];r.keyBinding&&e.keybindingMap.set(t,r.keyBinding),Object.defineProperty(e,t,{value:function(t){if(i.isDisposed)return g.EMPTY;var e=i;r.frameId&&(e=i.appContext.getFrameContext(r.frameId));var n={name:r.name,params:r.params,paramDescriptions:r.paramDescriptions,eventParam:t||null};return e.commandBus.dispatch(n)}})})},ji.prototype.initListeners=function(){var n=this,r=function(t,e){return"/"+t.split("/").concat(e.split(".")).filter(function(t){return 0<t.length}).join("/")};if(this.form){var i=this.form.getEntityValueChangingListeners();Object.keys(i).forEach(function(t){var e=r(n.bindingPath,t);n.entityValueChangingListeners[e]=i[t]});var o=this.form.getEntityValueChangedListeners();Object.keys(o).forEach(function(t){var e=r(n.bindingPath,t);n.entityValueChangedListeners[e]=o[t]})}},ji.prototype.bindToParent=function(t){var e=this;t&&t.verifycationChanged&&t.verifycationChanged.subscribe(function(t){e.verifycationChanged&&e.verifycationChanged.next(t)})},ji.prototype.transform=function(t){if(Array.isArray(t)){var e=t.find(function(t){return t&&"wf"===t.source});return e&&e.value?this.transform(e.value):this.transform(t[0])}return"boolean"!=typeof t&&"string"==typeof t?new Function("ctx","return "+t).apply(this.frameContext,[this]):t},ji.decorators=[{type:m.Injectable}],ji.ctorParameters=function(){return[]},ji);function ji(){this.verifyInformations=[],this.verifycationChanged=new g.Subject}var wi=(Oi.prototype.getParam=function(t){return this.params.get(t)},Oi.prototype.setParam=function(t,e){this.params.set(t,e)},Oi.decorators=[{type:m.Injectable}],Oi);function Oi(){this.params=new Map}var Ni=(Di.prototype.getBindingDataMap=function(){return this.bindingDataMap},Di.prototype.getBindingDataByName=function(t){return this.bindingDataMap.get(t)},Di.prototype.regBindingData=function(t,e){this.bindingDataMap.set(t,e)},Di.prototype.unRegisteBindingData=function(t){this.bindingDataMap["delete"](t)},Di.prototype.ifBindingDataExits=function(t){return!!this.getBindingDataByName(t)},Di.prototype.dispose=function(){this.bindingDataMap.clear()},Di);function Di(){this.bindingDataMap=new Map}var Vi=(Fi.prototype.regRepository=function(t,e){this.repositoryMap.set(t,e)},Fi.prototype.unRegisteRepository=function(t){this.repositoryMap["delete"](t)},Fi.prototype.getRepositoryMap=function(){return this.repositoryMap},Fi.prototype.getRepositories=function(){return Array.from(this.repositoryMap.values())},Fi.prototype.getRepositoryByName=function(t){return this.repositoryMap.get(t)},Fi.prototype.ifRepositoryExits=function(t){return!!this.getRepositoryByName(t)},Fi.prototype.dispose=function(){this.repositoryMap.clear()},Fi.decorators=[{type:m.Injectable}],Fi.ctorParameters=function(){return[]},Fi);function Fi(){this.repositoryMap=new Map}var Ri=(_i.prototype.refreshComponents=function(){this.frameComponentMap.forEach(function(t,e){"function"==typeof t.onFormLoad&&t.onFormLoad()})},_i.prototype.regFrameComponent=function(t,e){this.frameComponentMap.set(t,e)},_i.prototype.unregFrameContext=function(t){var e=t.frameId;this.frameComponentMap["delete"](e)},_i.prototype.dispose=function(){this.frameComponentMap.clear()},_i);function _i(){this.frameComponentMap=new Map}var Bi=(Object.defineProperty(Ai.prototype,"frameContexts",{get:function(){return this.frameContextManager.getFrameContexts()},enumerable:!0,configurable:!0}),Ai.prototype.reattach=function(){var t=this;setTimeout(function(){t.frameContexts.forEach(function(t){t.frameComponent.reattach(),t.frameComponent.detectChanges()})})},Ai.prototype.detach=function(){this.frameContexts.forEach(function(t){t.frameComponent.detach()})},Ai);function Ai(t){this.frameContextManager=t}var Li=(ki.prototype.registerAppContext=function(t){this.appContextSet.add(t)},ki.prototype.unregisterAppContext=function(t){this.appContextSet["delete"](t)},ki.prototype.getAppContexts=function(){return Array.from(this.appContextSet)},ki);function ki(){this.appContextSet=new Set}var $i=(Ui.prototype.get=function(t){if(!Array.isArray(t)||t.length<1)throw new Error("Argument error !");if(!this.appContext||!this.appContext.componentRefs||this.appContext.componentRefs.size<1)return null;var e=this.appContext.componentRefs;return t.forEach(function(t){e=e&&e.get(t)||null}),e},Ui.prototype.getComponentsByFrameId=function(t){return!this.appContext||!this.appContext.componentRefs||this.appContext.componentRefs.size<1?null:this.appContext.componentRefs.get(t)},Ui);function Ui(t){this.appContext=t}var Ki=new m.InjectionToken("@farris/devkit FORM_ID"),Hi=(Gi.prototype.getElementByBinding=function(t,e,n){var r,i,o=[];try{for(var a=P(t),s=a.next();!s.done;s=a.next()){var p=s.value;if(p.fields){var u=this.getElementByBinding(p.fields,e,p);o.push.apply(o,b(u))}else p.contents?(u=this.getElementByBinding(p.contents,e,p),o.push.apply(o,b(u))):p.editor?(u=this.getElementByBinding([p.editor],e,p),o.push.apply(o,b(u))):p.binding&&p.binding.field===e&&o.push({element:p,parentElement:n})}}catch(c){r={error:c}}finally{try{s&&!s.done&&(i=a["return"])&&i.call(a)}finally{if(r)throw r.error}}return o},Gi);function Gi(){}var qi=function Vp(){},zi=function Fp(t){this.Id=t.Id,this.Code=t.Code,this.Name=t.Name,this.Contents=JSON.stringify(t.Contents)},Ji=function Rp(){},Wi=function _p(){},Yi=function Bp(){},Zi=(Xi.prototype.getFieldsByIds=function(t,e,n){var r=new Map,i=e.entities;if(i&&i.length&&n){var o=n.bindTo,a=this.getEntityFields(i,o),s=this.flattenFields(a);t.forEach(function(t){s.has(t)&&r.set(t,s.get(t))})}return r},Xi.prototype.flattenFields=function(t,e){var n,r;void 0===e&&(e=new Map);try{for(var i=P(t),o=i.next();!o.done;o=i.next()){var a=o.value;e.set(a.id,a),a.type&&a.type.fields&&0<a.type.fields.length&&this.flattenFields(a.type.fields,e)}}catch(s){n={error:s}}finally{try{o&&!o.done&&(r=i["return"])&&r.call(i)}finally{if(n)throw n.error}}return e},Xi.prototype.getEntityFields=function(t,e){var n,r;if(t&&t.length){var i=e.indexOf("/");-1<i&&(e=e.slice(i+1,e.length));try{for(var o=P(t),a=o.next();!a.done;a=o.next()){var s=a.value;if(""===e||e===s.code||e===s.label)return s.type.fields;var p=this.getEntityFields(s.type.entities,e);if(p&&p.length)return p}}catch(u){n={error:u}}finally{try{a&&!a.done&&(r=o["return"])&&r.call(o)}finally{if(n)throw n.error}}}return[]},Xi);function Xi(){}var Qi=(to.prototype.buildAppContextMetadata=function(t,e){var n=t.module,r=n.states;return{identify:n.code,namespace:"",stateMachine:this.buildStataMachineMetadata(e),uiStates:this.buildUiStateMetadata(r)}},to.prototype.buildViewContextMetadata=function(t,e,n,r,i){return{identify:t.id,namespace:"",commands:this.buildCommand(e.commands),commandHandlers:this.buildCommandHandlers(e.commands,r),commandHandlerExtends:[],form:this.buildFormMetadata(e),formControls:this.buildFormControlMetadata(e.fields,e,n,t,i),subForms:null,uiStates:this.buildUiStateMetadata(e.states),bindingTo:e.bindTo,viewModelCode:e.code}},to.prototype.buildCommand=function(t){var e={};return t.reduce(function(t,e){var n={name:e.code,params:{},paramDescriptions:{}};return e.params.reduce(function(t,e){return t.params[e.name]=e.value,t.paramDescriptions[e.name]={type:"string"},t},n),t[e.code]=n,t},e),e},to.prototype.buildFormMetadata=function(t){return{formGroupName:t.name,enableValidate:t.enableValidation}},to.prototype.buildFormControlMetadata=function(t,e,n,p,u){var c=this,r={},i=t.map(function(t){return t.id}),l=(new Zi).getFieldsByIds(i,n,e),f=new Hi;return t.reduce(function(t,e){var n,r,i=l.has(e.id)?l.get(e.id):null,o=i?i.bindingPath:"",a=f.getElementByBinding(p.contents,e.id,{}),s=[];return a&&1<=a.length&&(n=a[0].element,r=a[0].parentElement,Object.keys(n).forEach(function(t){"maxValue,minValue,required,require".includes(t)&&("maxValue"===t&&null!==n[t]&&n[t]!==undefined?s.push({type:"maxValue",constraints:[n[t]]}):"minValue"===t&&null!==n[t]&&n[t]!==undefined?s.push({type:"minValue",constraints:[n[t]]}):"required"!==t&&"require"!==t||"true"!==n[t]&&!0!==n[t]||s.push({type:"required",constraints:[!0]}))})),t[e.fieldName]={id:e.fieldName,name:c.getTitle(n,r,e.fieldName),binding:o,updateOn:e.updateOn,defaultI18nValue:c.getTitle(n,r,e.fieldName),valueChanging:e.valueChanging,valueChanged:e.valueChanged,valueConverter:c.generateConverter(i,u),validRules:s},t},r),r},to.prototype.getTitle=function(t,e,n){return t?"GridField"==e.type?e.caption||n:t.title||n:n},to.prototype.generateConverter=function(t,e){var n=e.valueConverterMap;if(n&&t)return!t.type||"Date"!=t.type.name&&"DateTime"!=t.type.name||t.converter||(t.converter=n.Date),t.multiLanguage&&!t.converter&&(t.converter=n.MultiLang),t.converter},to.prototype.buildStataMachineMetadata=function(i){var o=this,t={states:{},renderStates:{},actions:{}};return i&&(i.state.reduce(function(t,e){return t.states[e.state]={initialState:e.state===i.initialState},t},t),Object.keys(i.renderState).reduce(function(t,e){var n=i.renderState[e],r=o.buildRenderFunction(n);return t.renderStates[e]={render:r},t},t),Object.keys(i.action).reduce(function(t,e){var n=i.action[e];return t.actions[e]={precondition:n.precondition,transitTo:n.transitTo},t},t)),t},to.prototype.buildUiStateMetadata=function(t){var e={};return t.reduce(function(t,e){return t[e.code]={stateName:e.code},t},e),e},to.prototype.buildRenderFunction=function(t){if(t&&t.condition.length){var e=t.condition.reduce(function(t,e){var n=e.target;n.startsWith("'")||(n="'"+n),n.endsWith("'")||(n+="'");var r=e.source;r.indexOf("'")<0&&(r="'"+r+"'"),-1<r.indexOf("getUIState")&&(r=r.replace("getUIState","context.getUIState")),-1<r.indexOf("getData")&&(r=r.replace("getData","context.getData"));var i=(e.lBracket||"")+"context.parse("+r+",'source')"+e.compare+e.target+(e.rBracket||"");if(e.relation)switch(e.relation.trim().toLocaleLowerCase()){case"or":i+="||";break;case"and":i+="&&"}return t+i},"");if(e)return new Function("context","return "+e+";")}return new Function("context","return true;")},to.prototype.buildCommandHandlers=function(t,s){var e=[];return t.reduce(function(t,e){var n=e.code,r=e.cmpId,i=s[r],o=Object.assign({},i.methods[e.handlerName]);o.params=o.params&&o.params.map(function(t){return Object.assign({},t)}),o.params&&o.params.length&&e.params.reduce(function(t,e){var n=t.params.find(function(t){return t.name===e.name});return n&&(n.expression=e.value),t},o);var a=new Gs(n,o);return t.push(a),t},e),e},to);function to(){}var eo=(no.prototype.getViewModelMap=function(){return this.viewModelMap},no.prototype.getViewModelByName=function(t){return this.viewModelMap.get(t)},no.prototype.register=function(t,e){this.viewModelMap.set(t,e)},no.prototype.exsit=function(t){return!!this.getViewModelByName(t)},no.prototype.dispose=function(){this.viewModelMap.clear()},no);function no(){this.viewModelMap=new Map}var ro=(io.prototype.getContextMetadataMap=function(){return this.contextMetadataMap},io.prototype.getContextMetadataByName=function(t){return this.contextMetadataMap.get(t)},io.prototype.register=function(t,e){this.contextMetadataMap.set(t,e)},io.prototype.exsit=function(t){return!!this.getContextMetadataByName(t)},io);function io(){this.contextMetadataMap=new Map}var oo,ao=new m.InjectionToken("@farris/devkit FRAME_ID"),so=new m.InjectionToken("@farris/devkit NAMESPACE"),po=new m.InjectionToken("@farris/frame_component_init_handler_token"),uo=(f(co,oo=wi),Object.defineProperty(co.prototype,"frameContexts",{get:function(){return this.frameContextManager.getFrameContextMap()},enumerable:!0,configurable:!0}),Object.defineProperty(co.prototype,"formModule",{get:function(){return this.formMetadataContent?this.formMetadataContent.module:null},enumerable:!0,configurable:!0}),co.prototype.dispose=function(t){this.disposed||(this.isFormDestoryed=!0,this.disposed=!0,this.router=null,this.unregisterFromManager(),this.componentRefs.clear(),this.stateMachine&&(this.stateMachine.dispose(),this.stateMachine=null),this.frameComponentRefresher.dispose(),this.frameContextManager.dispose(),this.repositoryManager.dispose(),this.viewModelManager.dispose(),this.bindingDataManager.dispose(),this.messagePipe&&(this.messagePipe.complete(),this.messagePipe=null),this.injector=null,this.destorySignal&&(this.destorySignal.next(t),this.destorySignal.complete()))},co.prototype.ngOnDestroy=function(){this.dispose({opportunity:x.DestroyOpportunity.AppContextDestroy})},co.prototype.initializeByMetadata=function(t,e,n,r){this.metadata=this.contextMetadataBuilder.buildAppContextMetadata(t,e),this.stateMachine||(this.stateMachine=new bi),this.formMetadataContent=t,this.controllers=n,this.dynamicOptions=r},co.prototype.registerToManager=function(){this.appContextManager&&this.appContextManager.registerAppContext(this)},co.prototype.unregisterFromManager=function(){this.appContextManager&&this.appContextManager.unregisterAppContext(this)},co.prototype.regFrameContext=function(t){var e=t.repository,n=e.name;if(!1===this.repositoryManager.ifRepositoryExits(n)&&this.repositoryManager.regRepository(n,e),!1===this.bindingDataManager.ifBindingDataExits(n)){var r=null;this.runMode===x.RunMode.highSpeed&&(r=kn.createFromRepository(e,"/"),this.bindingDataManager.regBindingData(n,r))}this.frameContextManager.regFrameContext(t)},co.prototype.regContextMetadata=function(t,e){this.contextMetadataManager.exsit(t)||this.contextMetadataManager.register(t,e)},co.prototype.getFormAppContext=function(){return this},co.prototype.destory=function(){this.dispose()},Object.defineProperty(co.prototype,"isDestoryed",{get:function(){return this.isFormDestoryed},enumerable:!0,configurable:!0}),Object.defineProperty(co.prototype,"ApplicationId",{get:function(){return this.applicationId||(this.applicationId=Je.create()),this.applicationId},set:function(t){this.applicationId=t},enumerable:!0,configurable:!0}),Object.defineProperty(co.prototype,"Token",{get:function(){return this.token||(this.token=Je.create()),this.token},set:function(t){this.token=t},enumerable:!0,configurable:!0}),co.prototype.registerCommandHandler=function(t,e){this.frameComponentRefresher.regFrameComponent(t,e)},co.prototype.refresh=function(){this.frameComponentRefresher.refreshComponents()},co.prototype.getFrameContext=function(t){return this.frameContextManager.getFrameContextById(t)},co.prototype.getContextById=function(t){return this.frameContextManager.getFrameContextById(t)},co.prototype.getAllFrameContexts=function(){return this.frameContextManager.getFrameContextMap()},co.prototype.handleSelectChange=function(r,i){var o=r.force||!1;this.frameContexts.forEach(function(t){if(t!==i&&t.repository===i.repository){var e=t.bindingData.getValue(r.path),n=r.value.id;(e&&e.currentId!==n||o)&&e.setCurrentId(n,!0,!1,o)}})},co.prototype.buildRenderViewContext=function(e){var t=this.formModule.viewmodels,n=this.formModule.components,r=this.formModule.schemas[0],i=n.find(function(t){return t.id===e}),o=t.find(function(t){return i.viewModel===t.id}),a=t.find(function(t){return t.id===o.parent});if(a){var s=n.find(function(t){return t.viewModel===a.id});s&&s.id}this.buildRenderViewContextRecursively(o,r)},co.prototype.buildRenderViewContextRecursively=function(e,n){var r=this,t=this.controllers,i=this.formModule.components.find(function(t){return t.viewModel===e.id}),o=this.contextMetadataBuilder.buildViewContextMetadata(i,e,n,t,this.dynamicOptions),a=(this.namespace?this.namespace+"_":"")+i.id;o.namespace=this.namespace||"",this.regContextMetadata(a,o);var s=this.formModule.viewmodels.filter(function(t){return t.parent===e.id});s&&s.length&&s.forEach(function(t){r.buildRenderViewContextRecursively(t,n)})},co.prototype.getComponentProviders=function(t){var e=this.contextMetadataManager.getContextMetadataByName(t),n=new Pn,r=new gn,i=e.namespace,o=this.repository||this.injector.get(Ye,null),a=this.stateMachine,s=new li,p=new Si;return p.setMetadata(e),[{provide:ao,useValue:t},{provide:so,useValue:i},{provide:Ns,useClass:Ns},{provide:co,useValue:this},{provide:Pn,useValue:n},{provide:gn,useValue:r},{provide:Ye,useValue:o},{provide:bi,useValue:a},{provide:li,useValue:s},{provide:Si,useValue:p},{provide:Or,useValue:new Or([new Vr,new xr,new Ir,new Mr,new jr])}]},co.decorators=[{type:m.Injectable}],co.ctorParameters=function(){return[{type:m.Injector,decorators:[{type:m.Optional}]},{type:Li,decorators:[{type:m.Optional}]},{type:co,decorators:[{type:m.Optional},{type:m.SkipSelf}]}]},co);function co(t,e,n){var r=oo.call(this)||this;return r.typeName="AppContext",r.isFormDestoryed=!1,r.applicationId=null,r.token=null,r.useIsoluteEventBus=!1,r.metadata={},r.enableGridHeaderWhenEditing=!1,r.disposed=!1,r.destorySignal=new g.Subject,r.injector=t,r.appContextManager=e,r.formId=r.injector&&r.injector.get(Ki,null)||null,r.runMode=r.injector&&r.injector.get(Tt,x.RunMode.compatible)||x.RunMode.compatible,zn.setRunMode(r.runMode),r.params.set("formId",r.formId),r.params.set("appId",r.ApplicationId),r.params.set("token",r.Token),n?(r.parent=n,r.root=n.root):(r.parent=null,r.root=r),r.registerToManager(),r.frameContextManager=new lo(r),r.frameComponentRefresher=new Ri,r.repositoryManager=new Vi,r.bindingDataManager=new Ni,r.changeDetectionController=new Bi(r.frameContextManager),r.messagePipe=new g.Subject,r.componentRefs=new Map,r.componentManager=new $i(r),r.contextMetadataManager=new ro,r.opened=!1,r.router=r.injector&&r.injector.get(c.Router),r.viewModelManager=new eo,r.contextMetadataBuilder=new Qi,r.variableParseService=new Or([new Vr,new xr,new Ir,new Mr,new jr]),r}var lo=(fo.prototype.regFrameContext=function(t){var e=t.frameId;if(!0===this.frameContextMap.has(e)){var n=this.frameContextMap.get(e);this.frameContextMap["delete"](e),this.frameContextSet["delete"](n)}t.index=this.frameContextSet.size,this.frameContextMap.set(e,t),this.frameContextSet.add(t)},fo.prototype.unregFrameContext=function(t){var e=t.frameId;if(this.frameContextMap["delete"](e),this.frameContextSet["delete"](t),this.appContext.runMode===x.RunMode.highSpeed){var n=t.namespace,r=t.repository&&t.repository.name,i=this.getFrameContextsByNamespace(n);(!i||i.length<1)&&this.appContext.bindingDataManager.unRegisteBindingData(r)}},fo.prototype.getFrameContextMap=function(){return this.frameContextMap},fo.prototype.getFrameContexts=function(){return Array.from(this.frameContextSet)},fo.prototype.getFrameContextsByNamespace=function(e){return Array.from(this.frameContextSet).filter(function(t){return t&&t.namespace===e})},fo.prototype.getFrameContextById=function(t){var e=this.frameContextMap.get(t);return e||this.getFrameContextFromAllAppContexts(t)},fo.prototype.getRootFrameContext=function(){return this.getFrameContexts().find(function(t){return null===t.parent})},fo.prototype.dispose=function(){this.frameContextMap.clear(),this.frameContextSet.clear()},fo.prototype.getFrameContextFromAllAppContexts=function(n){var r;if(this.appContext.appContextManager)return this.appContext.appContextManager.getAppContexts().some(function(t){var e=t.frameContextManager.getFrameContextMap();return!0===e.has(n)&&(r=e.get(n),!0)}),r},fo.decorators=[{type:m.Injectable}],fo.ctorParameters=function(){return[{type:uo}]},fo);function fo(t){this.frameContextMap=new Map,this.frameContextSet=new Set,this.appContext=t}var ho=(yo.prototype.post=function(t,e){this.eventBus.post(this.hostType,this.eventTokenValueProvider(),t,e)},yo);function yo(t,e,n){this.eventBus=t,this.hostType=e,this.eventTokenValueProvider=n}var go,mo="NgDeclaration";(go=x.EventTypeEnum||(x.EventTypeEnum={}))[go.COMPONENT=0]="COMPONENT",go[go.ROUTE=1]="ROUTE";var vo=(Eo.prototype.init=function(t){t&&this.bindDeclaration(t,null)},Eo.prototype.initWithDeclarations=function(t,e){t&&this.bindDeclaration(t,null)},Eo.prototype.bindDeclaration=function(t,e){var f=this,n=t.context;if(n){var r=e||this.getNgPublicEvent();r&&Object.keys(r).forEach(function(t){var e=r[t];Object.defineProperty(f,t,{value:function(r){var i=n,t=i.root,o=e.token,a=e.token,s=e.name,p=JSON.parse(JSON.stringify(e.params)),u=e.type,c=i.eventBus||t.eventBus;if(c){var l=(i.injector||t.injector).get(Or);setTimeout(function(){p=l.parse(p,i,r);var t=i.frameComponent,e=i,n=(new Date).valueOf();if(u&&u===x.EventTypeEnum.ROUTE)for(;e;)e.eventBus.post(o,a,s,p,t,u,n),e=f.getParentContext(e);else c.post(o,a,s,p,t)},0)}}})})}},Eo.prototype.getNgPublicEvent=function(){return w.getPropsMetadatasByName(this.constructor,mo)},Eo.prototype.getParentContext=function(t){if(t.parent)return t.parent;var e=t.appContext.parent;return e?e.frameContextManager.getRootFrameContext():null},Eo.decorators=[{type:m.Injectable}],Eo.ctorParameters=function(){return[]},Eo);function Eo(){}var bo="NgSubscription",Co=function Ap(){};var xo,Po,Io=(To.prototype.init=function(t){if(t)return this.bindSubscription(t,null)},To.prototype.initWithSubscriptions=function(t,e){if(t)return this.bindSubscription(t,e)},To.prototype.bindSubscription=function(u,t){var c=this,l=u.context;if(l){var f=t||this.getNgEvents(u);if(f){var h=[];return Object.keys(f).forEach(function(t){var e=f[t],r=l,i=u,n=e.token,o=e.token,a=e.name,s=e.paramMapCollection,p=r.eventBus.on(n,o,a,i,function(t){c.subscriptionHandler(t,s,r);var e=u[a];if(e)try{e(i,t)}catch(n){throw new Error("Error invoking method "+a)}});h.push(p)}),h}}},To.prototype.getNgEvents=function(t){return w.getPropsMetadatasByName(t.constructor,bo)},To.prototype.subscriptionHandler=function(t,e,n){t&&e&&!(e.length<=0)&&n&&this.paramMap2UiState(t,e,n)},To.prototype.paramMap2UiState=function(t,e,n){for(var r=0;r<e.length;r++){var i=e[r].from,o=e[r].frameId,a=e[r].to;if(i&&o&&a){var s=this.getFrameContext(o,n);null!=s&&this.setUiStateProperty(a,t[i],s.uiState)}}},To.prototype.getFrameContext=function(t,e){var n=null;try{n=e.appContext.getFrameContext(t)}catch(r){throw new Error("Error in Getting FrameContext")}return n},To.prototype.setUiStateProperty=function(t,e,n){try{n.setPropertyValue(t,e)}catch(r){throw new Error("Error in Setting Property Value of the current UISTATE"+n)}},To.decorators=[{type:m.Injectable}],To);function To(){}(Po=xo=xo||{})[Po.Compile=0]="Compile",Po[Po.Parsing=1]="Parsing";var Mo=(Object.defineProperty(So.prototype,"subscriptions",{get:function(){return this.subscriptionMap},enumerable:!0,configurable:!0}),So.prototype.post=function(t,e,n,r){var i={args:t,sender:e,eventType:n,eventId:r};this.eventSubject.next(i)},So.prototype.subscribe=function(o,a){var s=this,t=this.subscriptionMap.get(a);null!=t&&(t.unsubscribe(),this.subscriptionMap["delete"](a));var e=this.eventSubject.subscribe(function(t){var e=t.args,n=t.sender,r=t.eventType||null,i=t.eventId||0;s.lastEventId>=i||(s.lastEventId=i,r!==x.EventTypeEnum.ROUTE&&!1===s.isInSampeScope(n,a)||o.call(a,e))});return this.subscriptionMap.set(a,e),this},So.prototype.subscribeOnce=function(e,n){var t=this.eventSubject.subscribe(function(t){return e.call(n,t)});return this.onceSubscriptionMap.set(n,t),this},So.prototype.unSubscribe=function(t){var e=this.subscriptionMap.get(t);e?(e.unsubscribe(),e=null,this.subscriptionMap["delete"](t)):(e=this.onceSubscriptionMap.get(t))&&(e.unsubscribe(),e=null,this.onceSubscriptionMap["delete"](t))},So.prototype.unSubscribeForOnce=function(){var t,e;try{for(var n=P(Array.from(this.onceSubscriptionMap.keys())),r=n.next();!r.done;r=n.next()){var i=r.value;this.unSubscribe(i)}}catch(o){t={error:o}}finally{try{r&&!r.done&&(e=n["return"])&&e.call(n)}finally{if(t)throw t.error}}},So.prototype.matchEmitterToken=function(t,e){return!(this.emitter&&t&&this.emitter!==t||this.tokenValue&&e&&this.tokenValue!==e)},So.prototype.examByTargetToken=function(t,e){return this.emitter===t&&this.tokenValue===e},So.prototype.dispose=function(t){var e=this;if(this.unSubscribe(t),0===this.subscriptionMap.size&&this.parentEventPipeList){var n=this.parentEventPipeList.findIndex(function(t){return t===e});-1!==n&&this.parentEventPipeList.splice(n,1)}},So.prototype.disposeByCaller=function(t){var e=this.subscriptionMap.get(t);null!=e&&(e.unsubscribe(),this.subscriptionMap["delete"](t))},So.prototype.isInSampeScope=function(t,e){if(this.eventPipeType===xo.Parsing)return!0;if(!t)return!0;if(t===e)return!0;if(!(t.context&&t.context.appContext&&e.context&&e.context.appContext))return!1;var n=t.context.appContext,r=e.context.appContext;return n===r||!!(n.useIsoluteEventBus&&n.isoluteEventBus||r.useIsoluteEventBus&&r.isoluteEventBus)},So);function So(t,e,n,r){this.name=t,this.tokenValue=e,this.emitter=n,this.parentEventPipeList=r,this.lastEventId=-1,this.eventPipeType=xo.Compile,this.eventSubject=new g.Subject,this.subscriptionMap=new Map,this.onceSubscriptionMap=new Map,this.parentEventPipeList&&this.parentEventPipeList.push(this)}var jo=(wo.prototype.getProxy=function(t,e){var n=t.constructor.typeName||t.constructor.name;return this.proxyMap.has(n)||this.proxyMap.set(n,new ho(this,t,e)),this.proxyMap.get(n)},wo.prototype.post=function(t,e,n,r,i,o,a){var s,p,u=this.eventMap.get(n);if(u)if(t){var c;c=t instanceof m.Type?t.typeName||t.name:t,void 0===a&&(a=(new Date).valueOf());try{for(var l=P(u),f=l.next();!f.done;f=l.next()){var h=f.value;h.matchEmitterToken(c,e)&&(h.post(r,i,o,a),h.unSubscribeForOnce())}}catch(y){s={error:y}}finally{try{f&&!f.done&&(p=l["return"])&&p.call(l)}finally{if(s)throw s.error}}}else console.error("post方法的参数emitterType不能为空。")},wo.prototype.on=function(t,e,n,r,i){return this.getEventPipe(n,t,e).subscribe(i,r)},wo.prototype.off=function(e,n,r,i){var t=this.eventMap.get(r);if(t){var o=t.findIndex(function(t){return!!t.subscriptions.get(i)&&t.name===r&&t.tokenValue===n&&t.emitter===e});-1!==o&&t.splice(o,1)}},wo.prototype.once=function(t,e,n,r,i){return this.getEventPipe(n,t,e).subscribeOnce(i,r)},wo.prototype.requestFor=function(t,e,n,r,i,o){var a=this.findExistEventPipe(n,"RequestSubject",e);a?(this.once(t,e,n,this,function(t){"success"===t.status?i(t.data):o&&o("No target responser listening")}),a.post({target:t,token:e,data:r})):o&&o("No target responser listening.")},wo.prototype.responseOn=function(n,r,i){var o=this;this.on("RequestSubject",null,r,this,function(t){var e={status:"fail",data:null};n===t.target&&(e.data=i(t.data),e.status="success"),o.post(t.target,t.token,r,e)})},wo.prototype.getEventPipe=function(t,e,n){var r=this.eventMap.get(t);return r||(r=new Array,this.eventMap.set(t,r)),new Mo(t,n,e,r)},wo.prototype.findExistEventPipe=function(t,e,n){var r,i,o=this.eventMap.get(t);if(!o)return null;try{for(var a=P(o),s=a.next();!s.done;s=a.next()){var p=s.value;if(p.matchEmitterToken(e,n))return p}}catch(u){r={error:u}}finally{try{s&&!s.done&&(i=a["return"])&&i.call(a)}finally{if(r)throw r.error}}return null},wo.decorators=[{type:m.Injectable}],wo.ctorParameters=function(){return[]},wo);function wo(){this.proxyMap=new Map,this.eventMap=new Map}var Oo=(No.setToken=function(t,e){No.tokens.set(t,e)},No.getToken=function(t){return No.tokens.get(t)},No.tokens=new Map,No);function No(){}var Do,Vo,Fo,Ro,_o,Bo,Ao,Lo=new m.InjectionToken("@farris/devkit ExceptionHandler"),ko=new m.InjectionToken("@farris/devkit UserSettingsToken");Do=x.Expression||(x.Expression={}),(Vo=Do.ExpressionBindingType||(Do.ExpressionBindingType={})).State="State",Vo.Field="Field",(Fo=Do.ExpressionType||(Do.ExpressionType={})).Required="require",Fo.Readonly="readonly",Fo.Compute="compute",Fo.Dependency="dependency",Fo.Visible="visible",Fo.Relative="relative",Fo.Validate="validate",Fo.DataPicking="dataPicking",(Ro=Do.EventType||(Do.EventType={})).ValueChanged="VALUE_CHANGED",Ro.SelectionChanged="SELECTION_CHANGED",Ro.Load="Load",Ro.Append="Append",Ro.Remove="Remove",Ro.Update="Update",(_o=Do.EventSource||(Do.EventSource={})).Field="Field",_o.State="State",_o.BindingData="BindingData",_o.Repository="Repository",(Bo=Do.MessageType||(Do.MessageType={})).error="error",Bo.info="info",Bo.warning="warning",(Ao=Do.EffectPath||(Do.EffectPath={}))[Ao.currentRow=0]="currentRow",Do.MESSAGE={"zh-CHS":{require:"请输入'$property'",validate:"'$property'校验不通过",dataPicking:"帮助前表达式校验不通过"},en:{require:"Please input '$property'",validate:"'$property' calibration failed",dataPicking:"Failed to verify the expression before help"},"zh-CHT":{require:"請輸入'$property'",validate:"'$property'校驗不通過",dataPicking:"幫助前表達式校驗不通過"}},Do.DEPENDENCY_SPLITER="/";var $o=new m.InjectionToken("@farris/form_manifest_service"),Uo=new m.InjectionToken("@farris/form_expression_manifest_service"),Ko=(Ho.prototype.load=function(){var i=this;return this.formExpressionManifestService.load().pipe(d.switchMap(function(t){var r=[];return Array.from(t).forEach(function(n){n.expressions.forEach(function(t){var e={id:t.id,ns:n.ns,path:n.path,bindingType:n.type,type:t.type,expression:t.value||t.expr||"",message:t.message||null,messageType:t.messageType||null,deps:[]};t.type!==x.Expression.ExpressionType.Required&&t.type!==x.Expression.ExpressionType.Validate&&t.type!==x.Expression.ExpressionType.DataPicking||(t.message||(e.message=i.getExpressionMessage(t.type)),t.messageType||(e.messageType="error")),e.message&&i.transform(e),r.push(e)})}),i._expressions=r,i.cleanSpecialCharacters(),g.of(r)}),d.catchError(function(t){return g.of([])}))},Object.defineProperty(Ho.prototype,"expressions",{get:function(){return this._expressions?g.of(this._expressions):this.load()},enumerable:!0,configurable:!0}),Ho.prototype.getExpressionById=function(e){return!this._expressions||this._expressions.length<1?null:this._expressions.find(function(t){return t.id===e})},Ho.prototype.getExpressionMessage=function(t,e){if(t!==x.Expression.ExpressionType.Validate&&t!==x.Expression.ExpressionType.Required&&t!==x.Expression.ExpressionType.DataPicking)return null;if(!this.translate)return e;var n=this.translate.getCurrentLanguage()||"zh-CHS";return x.Expression.MESSAGE[n][t]},Ho.prototype.transform=function(t){this.translate&&t.message&&t.message.startsWith("{{")&&t.message.endsWith("}}")&&(t.message=this.translate.transform(t.message.substr(2,t.message.length-4),null)||this.getExpressionMessage(t.type))},Ho.prototype.cleanSpecialCharacters=function(){var r=this;if(this._expressions&&!(this._expressions.length<1)&&Array.isArray(this._expressions)){var t=this.injector.get(Ye,null);if(t){var e=t.entityTypeInfo,i=new RegExp("[\\'\\\"]?\\s*("+e.entityInfo.nodeCode+"|"+e.entityInfo.originalCode+")[\\.\\[\\]a-zA-Z0-9_]+\\s*[\\'\\\"]?","g");this._expressions.forEach(function(n){var t=n.expression.match(i);Array.isArray(t)&&0<t.length&&t.forEach(function(t){if(-1!==t.indexOf(".")){if(/\[\d\]/g.test(t)){var e=t.replace(/\[\d\]/g,"");n.expression=r.replaceAll(n.expression,t,e)}/\*/g.test(t)&&(e=t.replace(/\*/g,""),n.expression=r.replaceAll(n.expression,t,e))}})})}}},Ho.prototype.replaceAll=function(t,e,n){return t.split(e).join(n)},Ho.decorators=[{type:m.Injectable}],Ho.ctorParameters=function(){return[{type:m.Injector},{type:undefined,decorators:[{type:m.Inject,args:[Uo]}]},{type:undefined,decorators:[{type:m.Optional},{type:m.Inject,args:[Yr]}]}]},Ho);function Ho(t,e,n){this.injector=t,this.formExpressionManifestService=e,this.translate=n,this._expressions=null}var Go=new m.InjectionToken("@Farris listener"),qo=(Object.defineProperty(zo.prototype,"onEvent",{get:function(){return this.subject},enumerable:!0,configurable:!0}),zo.prototype.findEntityPaths=function(t,n,r){var i=this;void 0===r&&(r=[]);var e=t.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length?e.forEach(function(t){r.push(t.name);var e=t.typeInfo.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length?e.forEach(function(t){i.findEntityPaths(t.typeInfo,n,r)}):n.push(r)}):r&&0<r.length&&n.push(r)},zo);function zo(){this.subject=new g.Subject}var Jo=(Wo.prototype.compile=function(t,e){if("[object Object]"!==Object.prototype.toString.call(e))throw new Error("上下文必须为对象！");var n=this.buildContext(e);if(!t.factory){var r=new l.Expression(t.expression,n);t.factory=r.compile()}return t.factory.eval(n)},Wo.prototype.eval=function(t,e){if("[object Object]"!==Object.prototype.toString.call(e))throw new Error("上下文必须为对象！");var n=this.buildContext(e);return new l.ExpressionEngine(n).eval(t)},Wo.prototype.buildContext=function(e){var n=new l.ExpressionContext;return e&&0<Object.keys(e).length&&Object.keys(e).forEach(function(t){n.set(t,e[t])}),n},Wo.decorators=[{type:m.Injectable}],Wo);function Wo(){}var Yo=(Zo.prototype.set=function(t,e){this[t]=e},Zo.decorators=[{type:m.Injectable}],Zo.ctorParameters=function(){return[{type:m.Injector}]},Zo);function Zo(t){this.injector=t}var Xo=(Qo.prototype.eval=function(t,e,n){var r=this.expressionRegistry.getExpressionById(t);if(r){var i={},o=e&&e.bindingPath||null;if(o&&n){var a=o.split("/").filter(function(t){return t}),s=this.frameContext.bindingData.getValue(a),p="id";s&&(p=s.primaryKey);var u=n[p]||s.currentId;u&&(i.currentRows=[{bindingPath:a.join("/"),primaryValue:u}])}var c=this.execute(r.expression,i);return r.type!==x.Expression.ExpressionType.Readonly&&r.type!==x.Expression.ExpressionType.Required&&r.type!==x.Expression.ExpressionType.Visible||(c=!0===c),this.expressionResult.set(t,c),c}return undefined},Qo.prototype.validate=function(t,e){var n=this.expressionRegistry.getExpressionById(t);if(n){var r=e&&e.patch||null,i={};r&&(i.patch=r);var o=e.currentRow||null,a=e.currentRows||[];o&&(i.currentRows=i.currentRows||[],i.currentRows.push(o)),a&&0<a.length&&(i.currentRows=i.currentRows||[],Array.prototype.push.apply(i.currentRows,a));var s=this.execute(n.expression,i);return this.expressionResult.set(t,s),s}return undefined},Qo.prototype.onDataPicking=function(t){var e=t&&t.expressionId||null;if(!e)return g.of(!0);var n=this.eval(e);if(n)return g.of(n);var r=this.expressionRegistry.getExpressionById(e);if(!r)return g.of(!0);var i=r.messageType||x.Expression.MessageType.warning,o=r.message;return o&&this.notifyService[i](o,{hideTitle:!0}),g.EMPTY},Qo.prototype.execute=function(t,e){var n,r=this.resolveService.resolve(t),i=ln.getGroupFunctionDependency(t,this.frameContext.repository.entityTypeInfo),o=this.buildEntityContext(r,i,e),a=this.buildStateContext(),s=e&&e.contexts||null,p=this.injector.get(Yr,null),u=E(((n={})[this.entityOriginalNodeCode]=o,n),a,{BigNumber:y.BigNumber,frameContext:this.frameContext,bindingData:this.frameContext.bindingData,repository:this.frameContext.repository,CurrentLanguage:p.getCurrentLanguage()||"zh-CHS"},s);return o?this.expressionExecutor.eval(t,u):undefined},Qo.prototype.executeAsync=function(t,e){var n=this.execute(t,e);return g.of(n)},Qo.prototype.buildEntityContext=function(t,n,e){var r=this,i=e&&e.currentRows||null,o=-1!==t.findIndex(function(e){return!!r.isEntityDependency(e)&&-1!==n.findIndex(function(t){return t===e})&&1==e.split("/").filter(function(t){return t}).length-1}),a={};i&&0<i.length&&i.forEach(function(t){a[t.bindingPath||"/"]=t.primaryValue});var s=this.getEntity(a),p=e&&e.patch||null;if(!s)return{};if(p&&0<Object.keys(p).length&&Object.keys(p).forEach(function(t){var e=t.split("/").filter(function(t){return t}),n=p[t];r.setValue(s,e,n)}),o){var u=this.frameContext.repository.entityCollection.toJSON();s.__type__="List",s.__items__=u}return s},Qo.prototype.setValue=function(t,e,n){if(1===e.length)t[e[0]]=n;else{var r=e.pop();e.reduce(function(t,e){return t&&t[e]},t)[r]=n}},Qo.prototype.isEntityDependency=function(t){return t.startsWith(Oe)},Qo.prototype.getEntity=function(d){var g=this,t=this.frameContext.repository.entityTypeInfo,m=this.frameContext.bindingData,e=[],v=null;return(v=d["/"]?(v=this.frameContext.bindingData.list.findById(d["/"]))&&v.toJSON():this.frameContext.bindingData.list.currentItem.toJSON())?(ln.getChildrenEntityPaths(t,e),v.__type__="Entity",!e||e.length<1||e.forEach(function(n){var t=null;if(d&&d[n.join("/")]){var e=n.slice(0,1);if(2==n.length&&d[e.join("/")]){var r=d[e.join("/")];t=g.getPropertyValue(v,e.concat([r,n[1],d[n.join("/")]]))}else{var i=m.getValue(n),o=d[n.join("/")],a=null;(a=o!==i.currentId?i.findById(o):i.currentItem)&&a.primaryKeyValue&&(t=a.toJSON())}}else if(d&&Object.keys(d).find(function(t){var e=t.split("/").join("/");return n.join("/").startsWith(e)})){var s=d&&d["/"]||m.list.currentId,p=g.frameContext.repository.entityCollection.getEntityById(s),u=[],c=n.reduce(function(t,e){u.push(e);var n=t&&t[e];if(n){var r=d&&d[u.join("/")]||n.items[0]&&n.items[0].primaryValue||null;if(r)return n.get(r)||null}return null},p);t=c?c.toJSON():{}}else t=ln.getCurrentRowByPaths(n,m);var l=n.pop(),f=n.reduce(function(t,e){return t&&t[e]||null},v),h=f[l],y=E({__items__:[]},t&&t||{},{__type__:"List"});y.length=function(){return y.__items__.length},h&&Array.isArray(h)&&(y.__items__=[].concat(h)),f[l]=y}),v):null},Qo.prototype.getPropertyValue=function(t,e){return e.reduce(function(t,e){return"List"===t.__type__?t.__items__.find(function(t){return t.id===e}):Array.isArray(t)?t.find(function(t){return t.id===e}):t&&t[e]},t)},Object.defineProperty(Qo.prototype,"entityOriginalNodeCode",{get:function(){var t=this.injector.get(Ye);return t&&t.entityTypeInfo&&t.entityTypeInfo.entityInfo&&t.entityTypeInfo.entityInfo.originalCode||null},enumerable:!0,configurable:!0}),Qo.prototype.buildStateContext=function(){var e={};if(this.frameContext){var t=this.frameContext.getVirtualRootFrameContext();if(t){var n=t.viewModel.uiState;(Object.getOwnPropertyNames(n)||[]).forEach(function(t){null!==t.match(/^[a-zA-Z0-9_\$]+$/g)&&(e[t]=n[t])})}}return e},Qo.decorators=[{type:m.Injectable}],Qo.ctorParameters=function(){return[{type:m.Injector},{type:un},{type:Jo},{type:Ko},{type:Yo},{type:undefined,decorators:[{type:m.Inject,args:[Ce]}]},{type:undefined,decorators:[{type:m.Inject,args:[xe]}]}]},Qo);function Qo(t,e,n,r,i,o,a){this.injector=t,this.resolveService=e,this.expressionExecutor=n,this.expressionRegistry=r,this.expressionResult=i,this.messageService=o,this.notifyService=a,this.frameContext=null,this.frameContext=this.injector.get(Ns,null)}var ta=(ea.prototype.registeEvent=function(){var n=this;this.expressionRegistry.expressions.subscribe(function(t){t.forEach(function(t){if(!(t.deps&&0<t.deps.length)){var e=n.expressionManager.eval(t.id);n.expressionResult[t.id]=e}})})},ea.decorators=[{type:m.Injectable}],ea.ctorParameters=function(){return[{type:m.Injector},{type:Ko},{type:Xo},{type:Yo}]},ea);function ea(t,e,n,r){this.injector=t,this.expressionRegistry=e,this.expressionManager=n,this.expressionResult=r,this.registeEvent()}var na,ra=new m.InjectionToken("@Farris expression assigner"),ia=new m.InjectionToken("@Farris_event_handler"),oa=(f(aa,na=qo),aa.prototype.buildEventPath=function(t){return null},aa.prototype.registerEvent=function(){var n=this;this.uiState&&this.uiState.changes&&this.uiState.changes.subscribe(function(t){var e={ns:n.namespace,path:[t.field],type:x.Expression.EventType.ValueChanged,value:t.value,source:x.Expression.EventSource.State,frameId:n.frameId};n.subject.next(e)})},aa.decorators=[{type:m.Injectable}],aa.ctorParameters=function(){return[{type:m.Injector},{type:li},{type:undefined,decorators:[{type:m.Inject,args:[so]}]},{type:String,decorators:[{type:m.Inject,args:[ao]}]},{type:Pn}]},aa);function aa(t,e,n,r,i){var o=na.call(this)||this;return o.injector=t,o.uiState=e,o.namespace=n,o.frameId=r,o.bindingData=i,o.registerEvent(),o}x.Expression.EventType;var sa,pa=(f(ua,sa=qo),ua.prototype.registerEvent=function(){var i=this;this.repository&&this.repository.changes&&this.repository.changes.subscribe(function(t){var e=i.convertEventType(t);if(e){var n=i.buildEventPath(t),r={ns:i.namespace,type:e,path:n,value:t.value,source:x.Expression.EventSource.Field};i.subject.next(r)}}),this.repository&&this.repository.entityCollectionChange&&this.repository.entityCollectionChange.subscribe(function(t){var e=i.convertEventType(t);if(e){var n=i.buildEventPath(t),r={ns:i.namespace,type:e,path:n,value:t.value,source:x.Expression.EventSource.Repository};i.subject.next(r)}})},ua.prototype.buildEventPath=function(t){var n=this,e=t.path,r=[];return!e||e.length<1?r:r=e.filter(function(t,e){if(e%2==0&&t.includes(":")){if(":"===t)return!1;if(t.split(":")[0]!==n.repository.primaryKey)return!1}return!0})},ua.prototype.convertEventType=function(t){var e=null;return t.type===x.ModifyType.Add||t.type===x.ModifyType.AddData||t.type===x.ModifyType.Insert||t.type===x.ModifyType.Remove||t.type===x.ModifyType.RemoveData||t.type===x.ModifyType.Load||t.type===x.ModifyType.ValueChange||t.type===x.ModifyType.Update&&(e=x.Expression.EventType.Update),e},ua.decorators=[{type:m.Injectable}],ua.ctorParameters=function(){return[{type:m.Injector},{type:Ye},{type:undefined,decorators:[{type:m.Inject,args:[so]}]}]},ua);function ua(t,e,n){var r=sa.call(this)||this;return r.injector=t,r.repository=e,r.namespace=n,r.bindingData=r.injector.get(Pn,null),r.registerEvent(),r}var ca=(la.decorators=[{type:m.Injectable}],la.ctorParameters=function(){return[{type:Array,decorators:[{type:m.Optional},{type:m.Inject,args:[Go]}]},{type:m.Injector,decorators:[{type:m.Optional}]}]},la);function la(t,e){this.listeners=t,this.injector=e}var fa,ha=x.Expression.EventType,ya=(f(da,fa=qo),da.prototype.registerEvent=function(){var i=this;this.bindingData&&this.bindingData.changes&&"function"==typeof this.bindingData.changes.subscribe&&this.bindingData.changes.subscribe(function(t){if(t.type===x.ChangeType.Append&&!0!==t.isCloned||t.type===x.ChangeType.ValueChanged||t.type===x.ChangeType.Remove||t.type===x.ChangeType.Load||t.type===x.ChangeType.SelectionChanged){var e=null;t.type===x.ChangeType.Append?e=ha.Append:t.type===x.ChangeType.ValueChanged?e=ha.ValueChanged:t.type===x.ChangeType.Remove?e=ha.Remove:t.type===x.ChangeType.Load?e=!0===t.create?ha.Append:ha.Load:t.type===x.ChangeType.SelectionChanged&&(e=ha.SelectionChanged);var n=i.buildEventPath(t),r={ns:i.namespace,path:n,type:e,source:x.Expression.EventSource.BindingData,value:t.value,id:t.id,isTreeNodeLoadScene:t.isTreeNodeLoadScene};i.subject.next(r)}})},da.prototype.buildEventPath=function(t){var e=t.path,n=[],r=this.bindingData.list.currentItem.primaryKeyValue||t.id;r&&(t.type===x.ChangeType.Load&&0===t.path.length||n.push(this.bindingData.list.primaryKey+":"+r));for(var i=[],o=0;o<e.length;o++){var a=e[o];i.push(a);var s=this.bindingData.getValue(i);if(n.push(a),s instanceof Vn&&i.length<e.length){var p=s.currentItem.primaryKeyValue;o===e.length-2&&t.id&&(p=t.id),n.push(this.bindingData.list.primaryKey+":"+p)}}return n},da.decorators=[{type:m.Injectable}],da.ctorParameters=function(){return[{type:m.Injector},{type:Pn},{type:undefined,decorators:[{type:m.Inject,args:[so]}]}]},da);function da(t,e,n){var r=fa.call(this)||this;return r.injector=t,r.bindingData=e,r.namespace=n,r.repository=null,r.repository=r.injector.get(Ye,null),r.registerEvent(),r}var ga=(Object.defineProperty(ma.prototype,"onEvent",{get:function(){return this.subject},enumerable:!0,configurable:!0}),ma.prototype.regist=function(){var e=this,t=this.registry&&this.registry.listeners||[];t&&0<t.length&&t.forEach(function(t){t.onEvent.subscribe(function(t){e.subject.next(t)})})},ma.decorators=[{type:m.Injectable}],ma.ctorParameters=function(){return[{type:ca,decorators:[{type:m.Optional}]}]},ma);function ma(t){this.registry=t,this.subject=new g.Subject,this.regist()}var va=(Ea.prototype.attach=function(){return this.onEvent||(this.onEvent=new g.BehaviorSubject(this.events)),this.onEvent.asObservable()},Ea.decorators=[{type:m.Injectable}],Ea.ctorParameters=function(){return[{type:ga}]},Ea);function Ea(t){var n=this;this.listeners=t,this.events=new Array,this.listeners.onEvent.subscribe(function(t){if(n.onEvent&&0<n.onEvent.observers.length){var e=[];0<n.events.length&&(e=b(n.events)),e.push(t),n.onEvent.next(e),n.events=[]}else n.events.push(t)})}var ba=new m.InjectionToken("@farris/effector_token"),Ca=(xa.prototype.effect=function(t,e,n){if(!n||!n.path)throw new Error("repository effector 需要指定行信息。");var r=n.path,i=r[0]||this.bindingData.list.currentItem.primaryKeyValue,o=this.repository.entityCollection.getEntityById(i);if(!i||o){for(var a=r.pop(),s=o,p=1;p<r.length;p++){var u=r[p];s=s instanceof mt?s.get(u):s[u]}s&&s[a]!==e&&(s[a]=e)}},xa.decorators=[{type:m.Injectable}],xa.ctorParameters=function(){return[{type:m.Injector},{type:Ye},{type:undefined,decorators:[{type:m.Inject,args:[so]}]},{type:Pn}]},xa);function xa(t,e,n,r){this.injector=t,this.repository=e,this.namespace=n,this.bindingData=r,this.ns=n}var Pa=(Ia.prototype.effect=function(t,e,n){this.uiState.setPropertyValue(t,e)},Ia.decorators=[{type:m.Injectable}],Ia.ctorParameters=function(){return[{type:m.Injector},{type:li},{type:undefined,decorators:[{type:m.Inject,args:[so]}]}]},Ia);function Ia(t,e,n){this.injector=t,this.uiState=e,this.namespace=n,this.ns=n}var Ta=(Ma.prototype.effect=function(t,e,n){},Ma.decorators=[{type:m.Injectable}],Ma.ctorParameters=function(){return[{type:m.Injector},{type:undefined,decorators:[{type:m.Inject,args:[so]}]},{type:Ns}]},Ma);function Ma(t,e,n){this.injector=t,this.namespace=e,this.frameContext=n,this.ns=e}var Sa=(ja.prototype.effect=function(t,e,n){if(!n||!n.path)throw new Error("DependencyEffector 需要指定行信息。");"boolean"!=typeof e&&console.warn("DependencyEffector 依赖表达式计算结果应该为true/false，当前值为："+e);var r=n.path,i=r[0]||this.bindingData.list.currentItem.primaryKeyValue,o=this.repository.entityCollection.getEntityById(i);if(i&&!o)throw new Error("找不到id："+i+"对应的实体！");for(var a=r.pop(),s=o,p=1;p<r.length;p++){var u=r[p];s=s instanceof mt?s.get(u):s[u]}if(!s)throw new Error("[DependencyEffector] 找不到实体对应的路径："+r.push(a));null!==s[a]&&!0===e&&(s[a]=null)},ja.decorators=[{type:m.Injectable}],ja.ctorParameters=function(){return[{type:m.Injector},{type:Ye},{type:undefined,decorators:[{type:m.Inject,args:[so]}]},{type:Pn}]},ja);function ja(t,e,n,r){this.injector=t,this.repository=e,this.namespace=n,this.bindingData=r,this.ns=n}var wa=(Oa.decorators=[{type:m.Injectable}],Oa.ctorParameters=function(){return[{type:m.Injector},{type:Array,decorators:[{type:m.Optional},{type:m.Inject,args:[ba]}]}]},Oa);function Oa(t,e){this.injector=t,this.effectors=e}var Na=(Da.prototype.effect=function(t,e,n){if(!0===e&&n.message&&this.notifyService){var r=n.messageType||"info";this.notifyService[r](n.message,{hideTitle:!0})}},Da.decorators=[{type:m.Injectable}],Da.ctorParameters=function(){return[{type:m.Injector},{type:undefined,decorators:[{type:m.Inject,args:[Ce]}]},{type:undefined,decorators:[{type:m.Inject,args:[xe]}]},{type:undefined,decorators:[{type:m.Inject,args:[so]}]}]},Da);function Da(t,e,n,r){this.injector=t,this.messageService=e,this.notifyService=n,this.namespace=r,this.ns=r}var Va=(Fa.prototype.effect=function(t,e,n){var r,i=this.getDomInfoByEntityPath(t);if(i){var o=i.frameContext,a=(o&&o.getVirtualRootFrameContext(),n.expressionId),s=i.domPropertyName;if(a&&o.form.addFieldValidateRule(s,n.message,a,"validate"),!1===e&&n.message){if(!i.isGridComponent){var p=n.message.replace(/\$property/g,i.propertyName),u=this.buildFormErrors(s,p);o.form.updateFormErrors(u)}}else if(!0===e){var c=o.form.getFormControlErrors(s)||null;c?(c.hasOwnProperty("validate")&&delete c.validate,o.form.updateFormErrors(((r={})[s]={errors:c},r))):(u=this.buildFormErrors(s,null),o.form.updateFormErrors(u))}}},Fa.prototype.getDomInfoByEntityPath=function(t){var e,n,r,i,o=null;if(!t)return o;t=t.split("/").filter(function(t){return t}).join(".");var a=this.frameContext&&this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace)||null;if(a&&0<a.length)try{for(var s=P(a),p=s.next();!p.done;p=s.next()){var u=p.value;if(o)break;if(u&&u.form&&u.form.ngFormControls&&Object.keys(u.form.ngFormControls).length,u&&u.form&&u.form.ngFormControls&&0<Object.keys(u.form.ngFormControls).length){var c=Object.keys(u.form.ngFormControls);try{for(var l=P(c),f=l.next();!f.done;f=l.next()){var h=f.value,y=u.form.ngFormControls[h],d=(u.viewModel.bindingPath||"/").split("/").filter(function(t){return t}),g=y.binding.split(".");if(t===(g=d.concat(g)).join(".")){var m=u.viewModel.dataGridColumnsName||null,v=u.viewModel[m]||null;if(v&&Array.isArray(v)&&0<v.length&&!v.find(function(t){return!t.every(function(t){return!(t.hasOwnProperty("editor")&&t.editor)})}))continue;if(u&&u.frameComponent&&u.frameComponent.componentType===x.ComponentType.farrisTreeTalbeComponent)continue;var E=!1;m&&(E=!0),o={domPropertyName:h,propertyName:y.name||y.defaultI18nValue,frameContext:u,id:y.id,isGridComponent:E};break}}}catch(b){r={error:b}}finally{try{f&&!f.done&&(i=l["return"])&&i.call(l)}finally{if(r)throw r.error}}}}}catch(C){e={error:C}}finally{try{p&&!p.done&&(n=s["return"])&&n.call(s)}finally{if(e)throw e.error}}return o},Fa.prototype.getVerifyInformations=function(t){return(t&&t.getVirtualRootFrameContext()).viewModel.verifyInformations},Fa.prototype.buildFormErrors=function(t,e){var n,r;return e?(e=e.replace(/\$property/g,"domPropertyName"),(n={})[t]={errors:{validate:{name:e}}},n):((r={})[t]={errors:{}},r)},Fa.prototype.buildVerifyInformations=function(e,t,n,r){var i=this.getVerifyInformations(t),o=i.findIndex(function(t){return t.id===e});return-1!==o&&i.splice(o,1),i.push({id:e,namespace:t.namespace,targetField:n,index:i.length+1,title:t.form.formGroupName,msg:r,type:"error"}),i},Fa.prototype.removeValidateVerifyInformations=function(e,t){var n=this.getVerifyInformations(t),r=n.findIndex(function(t){return t.id===e});return-1!==r&&n.splice(r,1),n},Fa.decorators=[{type:m.Injectable}],Fa.ctorParameters=function(){return[{type:m.Injector},{type:undefined,decorators:[{type:m.Inject,args:[Ce]}]},{type:undefined,decorators:[{type:m.Inject,args:[xe]}]},{type:undefined,decorators:[{type:m.Inject,args:[so]}]},{type:Ns}]},Fa);function Fa(t,e,n,r,i){this.injector=t,this.messageService=e,this.notifyService=n,this.namespace=r,this.frameContext=i,this.ns=r}var Ra=(_a.prototype.effect=function(t,e,n){var r,i=this.getDomInfoByEntityPath(t);if(i){var o=i.frameContext,a=((o&&o.getVirtualRootFrameContext()).viewModel,i.domPropertyName),s=this.frameContext.bindingData.getValue(t.split("/").filter(function(t){return t})),p=n.expressionId;if(p&&o.form.addFieldValidateRule(a,n.message,p,"require"),!0===e){if(n.message)if(i.isGridComponent)this.updateColumnValidators(o,i.binding,i.datagridColumns,!0);else{var u=n.message.replace(/\$property/g,i.propertyName),c=this.buildFormErrors(a,u);this.isValidValue(t,s)||o.form.updateFormErrors(c)}}else if(i.isGridComponent)this.updateColumnValidators(o,i.binding,i.datagridColumns,!1);else{var l=o.form.getFormControlErrors(a)||null;l?(l.hasOwnProperty("require")&&delete l.require,o.form.updateFormErrors(((r={})[a]={errors:l},r))):(c=this.buildFormErrors(a,null),o.form.updateFormErrors(c))}}},_a.prototype.updateColumnValidators=function(t,e,n,r){var i=t.frameId,o=t.appContext.componentManager.get([i]);if(o&&0<o.size){var a=Array.from(o.values())[0];if(a&&"function"==typeof a.updateColumn){var s=n.find(function(t){return t.find(function(t){return t.field===e})}),p=s&&s.find(function(t){return t.field===e})||null;if(p){var u=p.validators||[],c=u.findIndex(function(t){return"required"===t.type});r?-1===c&&u.push({type:"required",message:"该字段不能为空！"}):-1!==c&&u.splice(c,1),a.updateColumn(e,{validators:b(u)}),a.columnsChanged(!1)}}}},_a.prototype.getDomInfoByEntityPath=function(t){var e,n,r,i,o=null;if(!t)return o;t=t.split("/").filter(function(t){return t}).join(".");var a=this.frameContext&&this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace)||null;if(a&&0<a.length)try{for(var s=P(a),p=s.next();!p.done;p=s.next()){var u=p.value;if(o)break;if(u&&u.form&&u.form.ngFormControls&&0<Object.keys(u.form.ngFormControls).length){var c=Object.keys(u.form.ngFormControls);try{for(var l=P(c),f=l.next();!f.done;f=l.next()){var h=f.value,y=u.form.ngFormControls[h],d=(u.viewModel.bindingPath||"/").split("/").filter(function(t){return t}),g=y.binding.split(".");if(t===(g=d.concat(g)).join(".")){var m=u.viewModel.dataGridColumnsName||null,v=u.viewModel[m]||null;if(v&&Array.isArray(v)&&0<v.length&&!v.find(function(t){return!t.every(function(t){return!(t.hasOwnProperty("editor")&&t.editor)})}))continue;if(u&&u.frameComponent&&u.frameComponent.componentType===x.ComponentType.farrisTreeTalbeComponent)continue;var E=!1;m&&(E=!0),o={domPropertyName:h,propertyName:y.name||y.defaultI18nValue,frameContext:u,id:y.id,isGridComponent:E,binding:y.binding,datagridColumns:v};break}}}catch(b){r={error:b}}finally{try{f&&!f.done&&(i=l["return"])&&i.call(l)}finally{if(r)throw r.error}}}}}catch(C){e={error:C}}finally{try{p&&!p.done&&(n=s["return"])&&n.call(s)}finally{if(e)throw e.error}}return o},_a.prototype.getDataPropInfo=function(t){if(!t)return null;var e=t.split("/").filter(function(t){return t});return this.frameContext.repository.entityTypeInfo.getPropInfoByPath(e)},_a.prototype.isValidValue=function(t,e){var n=this.getDataPropInfo(t);if(n&&n.metadataInfo&&!0===n.metadataInfo.enableMultiLangInput){var r=this.injector.get(Yr,null),i=r&&r.getCurrentLanguage()||"zh-CHS";return!(Object.keys(e).length<1)&&!!e[i]}return null!==e&&""!==e&&e!==undefined},_a.prototype.buildFormErrors=function(t,e){var n,r;return e?((n={})[t]={errors:{require:{name:e}}},n):((r={})[t]={errors:{}},r)},_a.decorators=[{type:m.Injectable}],_a.ctorParameters=function(){return[{type:m.Injector},{type:Ye},{type:undefined,decorators:[{type:m.Inject,args:[so]}]},{type:Ns}]},_a);function _a(t,e,n,r){this.injector=t,this.repository=e,this.namespace=n,this.frameContext=r,this.ns=n}var Ba=(Aa.prototype.effect=function(t,e,n){var r,i=t.split("/").filter(function(t){return t}),o=this.getTablePaths(i),a=o.join("/");if(o&&0<o.length){if(this.isGridComponent(a)&&(r=this.getDatagridComponent(a))){var s=this.getPropertyPaths(i);if(s){var p=s.join(".");e?r.showColumn(p,!1):r.hideColumn(p,!1)}}}else(r=this.getDatagridComponent(a))&&r.columnsChanged(!1)},Aa.prototype.getTablePaths=function(t){return ln.getAvailableChildrenPathsFromEntityPaths(t,this.repository.entityTypeInfo)},Aa.prototype.getDatagridComponent=function(e){var i=this,t=(this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace)||[]).filter(function(t){return t.viewModel&&t.viewModel.bindingPath.split("/").filter(function(t){return t}).toString()===e.split("/").filter(function(t){return t}).toString()}),o=null;return t&&t.every(function(t){var e=t.frameId,n=i.frameContext.appContext.componentManager.getComponentsByFrameId(e);if(!n)return!0;var r=Array.from(n.values()).find(function(t){return t&&"DatagridComponent"===t.__component_type__});return!r||(o=r,!1)}),o},Aa.prototype.getPropertyPaths=function(t){var e=ln.getAvailableChildrenPathsFromEntityPaths(t,this.repository.entityTypeInfo);return t.slice(e.length)},Aa.prototype.isGridComponent=function(e){var t=(this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace)||[]).find(function(t){return t.viewModel&&t.viewModel.bindingPath.split("/").filter(function(t){return t}).toString()===e.split("/").filter(function(t){return t}).toString()});return!!t&&!!t.viewModel.dataGridColumnsName},Aa.decorators=[{type:m.Injectable}],Aa.ctorParameters=function(){return[{type:m.Injector},{type:undefined,decorators:[{type:m.Inject,args:[so]}]},{type:Ns},{type:Ye}]},Aa);function Aa(t,e,n,r){this.injector=t,this.namespace=e,this.frameContext=n,this.repository=r,this.ns=e}var La=(ka.prototype.getEffector=function(t){t.path;var e=t.ns,n=t.bindingType,r=t.type,i=this.effectorRegistry.effectors.filter(function(t){return t.ns==e});if(r!==x.Expression.ExpressionType.Compute)return r===x.Expression.ExpressionType.Readonly?i.find(function(t){return t instanceof Ta}):r===x.Expression.ExpressionType.Dependency?i.find(function(t){return t instanceof Sa}):r===x.Expression.ExpressionType.Relative?i.find(function(t){return t instanceof Na}):r===x.Expression.ExpressionType.Validate?i.find(function(t){return t instanceof Va}):r===x.Expression.ExpressionType.Required?i.find(function(t){return t instanceof Ra}):r===x.Expression.ExpressionType.Visible?i.find(function(t){return t instanceof Ba}):null;if(n===x.Expression.ExpressionBindingType.Field)return i.find(function(t){return t instanceof Ca});if(n===x.Expression.ExpressionBindingType.State)return i.find(function(t){return t instanceof Pa});throw new Error("不支持的绑定字段类型："+n)},ka.decorators=[{type:m.Injectable}],ka.ctorParameters=function(){return[{type:m.Injector},{type:wa}]},ka);function ka(t,e){this.injector=t,this.effectorRegistry=e}var $a=(Ua.prototype.handleEvent=function(t,e){t=Object.assign({},t),this.expressionObjects=e,this.dispatch(t)},Object.defineProperty(Ua.prototype,"primaryValue",{get:function(){return this.bindingData.list.currentItem.primaryKeyValue},enumerable:!0,configurable:!0}),Object.defineProperty(Ua.prototype,"entityOriginalNodeCode",{get:function(){return this.repository&&this.repository.entityTypeInfo&&this.repository.entityTypeInfo.entityInfo&&this.repository.entityTypeInfo.entityInfo.originalCode||null},enumerable:!0,configurable:!0}),Ua.prototype.perform=function(t,e){return this.expressionExecutor.compile(t,e)},Ua.prototype.effect=function(t,n){var e=n.bindingType,r=this.effectorFactory.getEffector(n);if(r){if(e!==x.Expression.ExpressionBindingType.Field)throw new Error("not supported！");var i=n.effectPaths||[];if(0<i.length)i.forEach(function(t){var e={path:t.split("/"),message:n.message,expressionId:n.id};r.effect(n.path,n.result,e)});else if(n.type===x.Expression.ExpressionType.Required||n.type===x.Expression.ExpressionType.Validate||n.type===x.Expression.ExpressionType.Readonly||n.type===x.Expression.ExpressionType.Visible){var o={message:n.message,expressionId:n.id};r.effect(n.path,n.result,o)}}},Ua.prototype.isValidateOrRequiredExpression=function(t){return t&&(t.type===x.Expression.ExpressionType.Validate||t.type===x.Expression.ExpressionType.Required)},Ua.prototype.getEntityPathFromEvent=function(t){if(!(t=JSON.parse(JSON.stringify(t)))||!t.path||t.path.length<1)return[];var e=t.path;return this.getEntityPath(e)},Ua.prototype.getEntityPath=function(t){return t.filter(function(t,e){return e%2!=0||!t.includes(":")})},Ua.prototype.buildEntityPath=function(t){return t.filter(function(t,e){return e%2!=0||!t.includes(":")})},Ua.prototype.cleanEventPath=function(t){return(t=t.filter(function(t){return!(!t||":"===t)})).map(function(t){return t.includes(":")?t.split(":")[1]:t})},Ua.prototype.getCurrentRowByPaths=function(t){var e=null,n=this.bindingData.getValue(t);if(n&&0<n.length){var r=n.currentItem.primaryKeyValue||null;if(r){var i=n.findById(r);i&&(e=i.toJSON())}}return e},Ua.prototype.getEventId=function(t,e){if(!t||t.length<1)throw new Error("invalid path!");var n=t.findIndex(function(t){return t===e});if(-1===n)return null;var r=n+1;if(r>t.length-1)throw new Error("invalid propertyName or path");var i=t[r];if(-1===i.indexOf(":"))throw new Error("compute error.");return i.split(":")[1]},Ua.prototype.buildStateContext=function(t){var e=t.ns,n=this.injector.get(uo,null).frameContextManager.getFrameContextsByNamespace(e),r={};if(n&&0<n.length){var i=n[0].getVirtualRootFrameContext();if(i){var o=i.viewModel.uiState;(Object.getOwnPropertyNames(o)||[]).forEach(function(t){null!==t.match(/^[a-zA-Z0-9_\$]+$/g)&&(r[t]=o[t])})}}return r},Ua.prototype.buildEntityContext=function(t,e,c){var l=this,n=e.bindingType;if(n===x.Expression.ExpressionBindingType.Field){var r=this.repository.entityTypeInfo,i=[];ln.getChildrenEntityPaths(r,i);var o=c&&c.find(function(t){return""===t.bindingPath||"/"===t.bindingPath})||null,a=o&&o.primaryValue||this.bindingData.list.currentId,s=this.bindingData.list.findById(a);if(!s)return{};var f=s.toJSON();return f.__type__="Entity",!i||i.length<1||(i.sort(function(t,e){return t.length-e.length}),i.forEach(function(e){var t=l.bindingData.getValue(e),n=t.currentId,r=e[e.length-1],i=e.slice(0,e.length-1).reduce(function(t,e){return t&&t[e]||null},f);if(i){var o=i,a=null;if(n){if(c&&0<c.length){var s=c.find(function(t){return t.bindingPath.split("/").filter(function(t){return t}).join("/")===e.join("/")});s&&(n=s.primaryValue)}var p=t.findById(n),u=i[r];(a=E({__items__:[]},p&&p.toJSON()||{},{__type__:"List"})).length=function(){return a.__items__.length},u&&Array.isArray(u)&&(a.__items__=[].concat(u))}else a={__items__:[],__type__:"List",length:function(){return a.__items__.length}};o[r]=a}})),f}if(n!==x.Expression.ExpressionBindingType.State)return null},Ua.prototype.buildContext=function(t,e,n,r){var i,o=[];if(n)o.push(n);else{var a=this.buildEntityContext(e,t,r);o.push(a)}var s=this.buildStateContext(e),p=this.entityOriginalNodeCode,u=null;1===o.length?u=o.pop():((u=o[0]).__type__||(u.__type__="Entity"),u.__items__=o);var c=this.injector.get(Yr,null);return E(((i={})[p]=u,i),s,{BigNumber:y.BigNumber,frameContext:this.frameContext,bindingData:this.bindingData,repository:this.repository,CurrentLanguage:c.getCurrentLanguage()||"zh-CHS"})},Ua.prototype.buildEffectPath=function(t,e){var n=e.path.split("/").filter(function(t){return t}),r=t.path[0]&&t.path[0].split(":")[1];if(!r)throw new Error("Invalid event path!");if(1===n.length)return[r,n.pop()];for(var i=[r],o=0;o<n.length;o++){var a=n[o];i.push(a);var s=n.slice(0,o+1),p=this.repository.entityTypeInfo.getPropInfoByPath(s);if("List"===p.group){var u=this.getEventId(t.path,p.name)||null;if(!u){var c=this.bindingData.getValue(s);c&&(u=c.currentId)}i.push(u)}}return i},Ua.prototype.getPathInfo=function(t){var e=t.split("/").filter(function(t){return t}),n=ln.getAvailableChildrenPathsFromEntityPaths(e,this.repository.entityTypeInfo),r=e.slice(n.length).join("/");return{path:n.join("/"),propertyName:r,paths:n,propertyNames:r.split("/").filter(function(t){return t})}},Ua.prototype.getTablePathsFromEventPaths=function(t){return t=this.getEntityPath(t),ln.getAvailableChildrenPathsFromEntityPaths(t,this.repository.entityTypeInfo)},Ua.prototype.getPropertyPathsFromEventPaths=function(t){t=this.getEntityPath(t);var e=ln.getAvailableChildrenPathsFromEntityPaths(t,this.repository.entityTypeInfo);return t.slice(e.length)},Ua.prototype.analysis=function(t,e){var n=this.getPathInfo(e.path),r=this.getEntityPath(t.path.slice(0)),i=this.getPathInfo(r.join("/"));if(!n||!i)return console.warn("表达式路径或事件路径错误，获取路径信息失败。"),null;var o=n.path.split("/").filter(function(t){return t}),a=n.propertyName.split("/").filter(function(t){return t}),s=i.path.split("/").filter(function(t){return t}),p=i.propertyName.split("/").filter(function(t){return t}),u={distance:undefined,eventFromChildren:undefined,eventFromParent:undefined,expressionTablePaths:o,expressionPropertyNames:a,eventTablePaths:s,eventPropertyNames:p,isSameTable:!1};return u.distance=Math.abs(o.length-s.length),1===u.distance&&(u.eventFromChildren=s.length>o.length&&s.join("/").startsWith(o.join("/")),u.eventFromParent=s.length<o.length&&o.join("/").startsWith(s.join("/"))),u.isSameTable=o.join("/")===s.join("/"),u},Ua.prototype.buildCurrentRows=function(t,r){var i=new Array;if(!t||t.length<1)i.push({bindingPath:"/",primaryValue:r[0]});else{var o=[];t.forEach(function(t,e){0===e&&i.push({bindingPath:"/",primaryValue:r[0]}),o.push(t);var n=r[2*e+2];i.push({bindingPath:o.join("/"),primaryValue:n})})}return i},Ua.prototype.convertBooleanTypeExpressionResult=function(t,e){return this.isBooleanTypeExpression(t)?!0===e:e},Ua.prototype.isBooleanTypeExpression=function(t){return this.isReadonlyExpression(t)||this.isVisibleExpression(t)||this.isValidateExpression(t)||this.isRequiredExpression(t)||this.isDependencyExpression(t)},Ua.prototype.isReadonlyExpression=function(t){return t&&t.type===x.Expression.ExpressionType.Readonly||!1},Ua.prototype.isVisibleExpression=function(t){return t&&t.type===x.Expression.ExpressionType.Visible},Ua.prototype.isValidateExpression=function(t){return t&&t.type===x.Expression.ExpressionType.Validate},Ua.prototype.isRequiredExpression=function(t){return t&&t.type===x.Expression.ExpressionType.Required},Ua.prototype.isDependencyExpression=function(t){return t&&t.type===x.Expression.ExpressionType.Dependency},Ua.decorators=[{type:m.Injectable}],Ua.ctorParameters=function(){return[{type:m.Injector},{type:Ye},{type:Pn},{type:Ko},{type:La},{type:Jo},{type:Yo}]},Ua);function Ua(t,e,n,r,i,o,a){this.injector=t,this.repository=e,this.bindingData=n,this.expressionRegistry=r,this.effectorFactory=i,this.expressionExecutor=o,this.expressionResult=a,this.frameContext=this.injector.get(Ns)}var Ka,Ha=(f(Ga,Ka=$a),Ga.prototype.filter=function(t){return null},Ga.prototype.dispatch=function(t){},Ga.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},Ga.decorators=[{type:m.Injectable}],Ga);function Ga(){return null!==Ka&&Ka.apply(this,arguments)||this}var qa=(za.effect=function(n,r,t){!t||t.length<1||t.forEach(function(t){var e={path:t,message:r.message,expressionId:r.id};n.effect(r.path,r.result,e)})},za);function za(){}var Ja,Wa=(f(Ya,Ja=$a),Ya.prototype.filter=function(i){var o=this;return this.expressionObjects&&0<this.expressionObjects.length?this.expressionObjects.filter(function(t){var e=t.deps;if(!e||e.length<1||i.ns!==t.ns)return!1;var n=o.cleanEventPath(i.path);n.splice(0,0,Ne);var r=n.join("/");return!!e.includes(r)}):null},Ya.prototype.dispatch=function(r){var i=this,t=this.filter(r);t&&0<t.length&&t.forEach(function(t){var e=i.buildContext(t,r),n=i.perform(t,e);n===undefined&&!i.isValidateOrRequiredExpression(t)||(t.result=i.convertBooleanTypeExpressionResult(t,n),t.id&&i.expressionResult.set(t.id,t.result),i.effect(r,t))})},Ya.prototype.effect=function(n,r){var i=this,o=this.effectorFactory.getEffector(r),t=r.bindingType;if(o)if(t===x.Expression.ExpressionBindingType.State)o.effect(r.path,r.result,{message:r.message});else if(t===x.Expression.ExpressionBindingType.Field){var e=this.getPathInfo(r.path),a=e.paths,s=this.repository.entityCollection.getAllEntities();!s||s.length<1||r.type===x.Expression.ExpressionType.Visible?o.effect(r.path,r.result,{message:r.message}):this.effectRows(s,a,e.propertyNames,function(t,e){i.output(n,r,t,o,[e])})}},Ya.prototype.output=function(t,e,n,r,i){var o=this.buildContext(e,t,null,n),a=this.perform(e,o);a!==undefined&&(e.result=a,e.id&&this.expressionResult.set(e.id,e.result),qa.effect(r,e,i))},Ya.prototype.effectRows=function(t,i,o,a,s,p,u){var c=this;if(void 0===s&&(s=[]),void 0===p&&(p=[]),void 0===u&&(u=[]),!i||i.length<1)t.forEach(function(t){if(t&&t.primaryValue){var e=u.concat([t.primaryValue]).concat(o),n=s.concat([{bindingPath:p.join("/")||"/",primaryValue:t.primaryValue}]);a(n,e)}}),s.length=0,u.length=0;else{var l=!1,f=p;t.forEach(function(t){var e=i[0],n=t[e];if(n&&!(n.count()<1)){s.push({bindingPath:p.join("/")||"/",primaryValue:t.primaryValue}),u.push(t.primaryValue),u.push(e),!1===l&&(l=!0,f.push(e));var r=i.slice(1);c.effectRows(n.items,r,o,a,s,f,u)}})}},Ya.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},Ya.decorators=[{type:m.Injectable}],Ya);function Ya(){return null!==Ja&&Ja.apply(this,arguments)||this}var Za,Xa=(f(Qa,Za=$a),Qa.prototype.filter=function(t){return null},Qa.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=r,t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},Qa.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},Qa.decorators=[{type:m.Injectable}],Qa);function Qa(){return null!==Za&&Za.apply(this,arguments)||this}var ts,es=(f(ns,ts=$a),ns.prototype.filter=function(t){return null},ns.prototype.dispatch=function(t){},ns.decorators=[{type:m.Injectable}],ns);function ns(){return null!==ts&&ts.apply(this,arguments)||this}var rs,is=(f(os,rs=$a),os.prototype.filter=function(t){return null},os.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=r,t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},os.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},os.decorators=[{type:m.Injectable}],os);function os(){return null!==rs&&rs.apply(this,arguments)||this}var as,ss=(f(ps,as=$a),ps.prototype.filter=function(n){var r=this;return this.expressionObjects.filter(function(t){if(t.ns!==n.ns||!t.deps||0===t.deps.length||t.type===x.Expression.ExpressionType.Compute||t.type===x.Expression.ExpressionType.Dependency||t.type===x.Expression.ExpressionType.DataPicking)return!1;var e=r.analysis(n,t);return!!e&&0===e.expressionTablePaths.length&&-1!==t.deps.findIndex(function(t){if(!t.startsWith(Oe))return!1;var e=t.split(x.Expression.DEPENDENCY_SPLITER).filter(function(t){return t}).slice(1),n=r.getPathInfo(e.join("/"));return!!n&&0===n.paths.length})})},ps.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=o.convertBooleanTypeExpressionResult(t,r),t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},ps.prototype.getCurrentRowByEvent=function(t,e){var n=null,r=this.bindingData.getValue(t),i=this.getEntityPath(e.path);if(r&&0<r.length){var o=r.currentItem.primaryKeyValue||null,a=ln.getAvailableChildrenPathsFromEntityPaths(i,this.repository.entityTypeInfo);if(a&&a.toString()===t.toString()&&(o=(o=e.id||null)||this.getEventId(e.path,t[t.length-1])),o){var s=r.findById(o);s&&(n=s.toJSON())}}return n},ps.decorators=[{type:m.Injectable}],ps);function ps(){return null!==as&&as.apply(this,arguments)||this}var us,cs=(f(ls,us=$a),ls.prototype.filter=function(o){var a=this;if(this.expressionObjects&&0<this.expressionObjects.length){var t=this.expressionObjects.filter(function(t){if(t.ns!==o.ns||!t.deps||t.deps.length<1)return!1;var r=a.buildEntityPath(o.path),i=a.analysis(o,t);return!(!i||0===r.length&&t.bindingType===x.Expression.ExpressionBindingType.Field||(r.splice(0,0,Oe),i.eventTablePaths.length-1!==i.expressionTablePaths.length||!i.eventTablePaths.join(x.Expression.DEPENDENCY_SPLITER).startsWith(i.expressionTablePaths.join(x.Expression.DEPENDENCY_SPLITER))||-1===t.deps.findIndex(function(t){if(!t.startsWith(r.join(x.Expression.DEPENDENCY_SPLITER)))return!1;var e=t.split(x.Expression.DEPENDENCY_SPLITER).filter(function(t){return t}).slice(1),n=a.getPathInfo(e.join(x.Expression.DEPENDENCY_SPLITER));return!(!n||n.paths.join(x.Expression.DEPENDENCY_SPLITER)!==i.eventTablePaths.join(x.Expression.DEPENDENCY_SPLITER))})))}),n=this.buildEntityPath(o.path),e=this.expressionObjects.filter(function(t){if(t.ns!==o.ns)return!1;if(a.getPathInfo(t.path).paths.join(x.Expression.DEPENDENCY_SPLITER)!==n.join(x.Expression.DEPENDENCY_SPLITER))return!1;if((t.type===x.Expression.ExpressionType.Compute||t.type===x.Expression.ExpressionType.Dependency)&&o.isTreeNodeLoadScene)return!1;if(!t.deps||t.deps.length<1)return!0;if(t.deps.every(function(t){return t.startsWith(Ne)}))return!0;var e=a.analysis(o,t);return!(!e||0!==e.distance||!e.isSameTable)}),r=this.expressionObjects.filter(function(t){if(t.ns!==o.ns||!t.deps||t.deps.length<1||t.type!==x.Expression.ExpressionType.Visible&&t.type!==x.Expression.ExpressionType.Required&&t.type!==x.Expression.ExpressionType.Validate)return!1;var e=t.deps.filter(function(t){return t.startsWith(Oe)});if(!e||e.length<1)return!1;if(!a.analysis(o,t))return!1;var n=o.path.filter(function(t){return t}).join("/");return-1!==e.findIndex(function(t){var e=t.split("/").slice(1).join("/");return a.getPathInfo(e).path===n})});return t.concat(e,r)}return null},ls.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=o.convertBooleanTypeExpressionResult(t,r),t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},ls.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},ls.prototype.effect=function(n,r){var i=this,t=r.bindingType,e=this.cleanEventPath(n.path),o=this.effectorFactory.getEffector(r);if(o){var a=this.analysis(n,r);if(a){var s=r.path.split("/").filter(function(t){return t});if(t===x.Expression.ExpressionBindingType.Field){var p=[],u=s.slice(a.expressionTablePaths.length);if(0===a.distance){if(!a.isSameTable)return;var c=e.slice(0);if(1===e.length)if(n.value&&Array.isArray(n.value))n.value.forEach(function(t){p.push([t.primaryKeyValue].concat(u))});else{var l=c.concat(u);p.push(l)}else if(n.value&&Array.isArray(n.value))n.value.forEach(function(t){p.push(c.concat([t.primaryKeyValue]).concat(u))});else{var f=this.bindingData.getValue(a.eventTablePaths);f&&f.currentId&&p.push(c.concat(f.currentId).concat(u))}}else if(!0===a.eventFromParent){if(1<a.expressionTablePaths.length)return;e.slice(0,e.length),l=(e&&0<e.length?e.slice(0,e.length):[this.bindingData.list.currentId,a.expressionTablePaths[0],null]).concat(u),p.push(l)}else{if(!0!==a.eventFromChildren)return;l=e.slice(0,e.length-1).concat(u),p.push(l)}p.forEach(function(t){var e=i.buildCurrentRows(a.expressionTablePaths,t);i.output(n,r,e,o,[t])})}else t===x.Expression.ExpressionBindingType.State&&console.error("not supported！")}}},ls.prototype.output=function(t,e,n,r,i){var o=this.buildContext(e,t,null,n),a=this.perform(e,o);a!==undefined&&(e.result=a,e.id&&this.expressionResult.set(e.id,e.result),qa.effect(r,e,i))},ls.decorators=[{type:m.Injectable}],ls);function ls(){return null!==us&&us.apply(this,arguments)||this}var fs,hs=(f(ys,fs=$a),ys.prototype.filter=function(r){var i=this;return this.expressionObjects&&0<this.expressionObjects.length?this.expressionObjects.filter(function(t){var e=t.deps;if(!e||e.length<1||r.ns!==t.ns)return!1;var n=i.getEntityPath(r.path);return n.splice(0,0,Oe),e.includes(n.join("/"))}):null},ys.prototype.dispatch=function(e){var n=this,t=this.filter(e);t&&0<t.length&&t.forEach(function(t){n.effect(e,t)})},ys.prototype.effect=function(t,e){var n,r,i=this.effectorFactory.getEffector(e);if(i){var o=this.analysis(t,e);if(o){var a=this.cleanEventPath(t.path),s=[];if(0===o.distance){if(!1===o.isSameTable)return;var p=(c=a.slice(0,a.length-o.eventPropertyNames.length)).concat(o.expressionPropertyNames),u=this.buildCurrentRows(o.eventTablePaths,p);s.push(p),this.output(t,e,u,i,s)}else if(!0===o.eventFromChildren){if(1<o.distance)return;p=(c=a.slice(0,a.length-o.eventPropertyNames.length-2)).concat(o.expressionPropertyNames),s.push(p),u=this.buildCurrentRows(o.eventTablePaths,a),this.output(t,e,u,i,s)}else if(!0===o.eventFromParent){if(1<o.distance)return;var c;(c=a.slice(0,a.length-o.eventPropertyNames.length)).push(o.expressionTablePaths.slice(0).pop()),o.expressionTablePaths;var l=a[0];if(!l)return;for(var f=this.frameContext.repository.entityCollection.getEntityById(l),h=1;h<c.length;h++){var y=c[h];f=f instanceof mt?f.get(y):f[y]}var d=f;if(d&&d instanceof mt)if(0===d.count()){if(e.type===x.Expression.ExpressionType.Visible||e.type===x.Expression.ExpressionType.Required){var g=this.buildContext(e,t),m=this.perform(e,g);if(m===undefined&&!this.isValidateOrRequiredExpression(e))return;e.result=this.convertBooleanTypeExpressionResult(e,m),e.id&&this.expressionResult.set(e.id,e.result),fs.prototype.effect.call(this,t,e)}}else try{for(var v=P(d),E=v.next();!E.done;E=v.next()){var b=E.value;b&&b.primaryValue&&(p=c.concat([b.primaryValue]).concat(o.expressionPropertyNames),u=this.buildCurrentRows(o.expressionTablePaths,p),this.output(t,e,u,i,[p]))}}catch(C){n={error:C}}finally{try{E&&!E.done&&(r=v["return"])&&r.call(v)}finally{if(n)throw n.error}}}}}},ys.prototype.output=function(t,e,n,r,i){var o=this.buildContext(e,t,null,n),a=this.perform(e,o);a===undefined&&!this.isValidateOrRequiredExpression(e)||(e.result=this.convertBooleanTypeExpressionResult(e,a),e.id&&this.expressionResult.set(e.id,e.result),qa.effect(r,e,i))},ys.prototype.getCurrentRowByEvent=function(t,e){e=JSON.parse(JSON.stringify(e));var n=null,r=this.bindingData.getValue(t),i=this.getEntityPath(e.path);if(r&&0<r.length){var o=r.currentItem.primaryKeyValue||null,a=ln.getAvailableChildrenPathsFromEntityPaths(i,this.repository.entityTypeInfo);if(a&&a.toString()===t.toString()&&(o=(o=e.id||null)||this.getEventId(e.path,t[t.length-1])),o){var s=r.findById(o);s&&(n=s.toJSON())}}return n},ys.decorators=[{type:m.Injectable}],ys);function ys(){return null!==fs&&fs.apply(this,arguments)||this}var ds,gs=(f(ms,ds=$a),ms.prototype.filter=function(e){var o=this;if(this.expressionObjects&&0<this.expressionObjects.length)return this.expressionObjects.filter(function(t){if(t.ns!==e.ns||!t.deps||t.deps.length<1)return!1;var r=o.analysis(e,t);if(!r)return!1;var i=o.buildEntityPath(e.path);return(0!==i.length||t.bindingType!==x.Expression.ExpressionBindingType.Field)&&(i.splice(0,0,Oe),r.eventTablePaths.length-1===r.expressionTablePaths.length&&!!r.eventTablePaths.join(x.Expression.DEPENDENCY_SPLITER).startsWith(r.expressionTablePaths.join(x.Expression.DEPENDENCY_SPLITER))&&-1!==t.deps.findIndex(function(t){if(!t.startsWith(i.join(x.Expression.DEPENDENCY_SPLITER)))return!1;var e=t.split(x.Expression.DEPENDENCY_SPLITER).filter(function(t){return t}).slice(1),n=o.getPathInfo(e.join(x.Expression.DEPENDENCY_SPLITER));return!(!n||n.paths.join(x.Expression.DEPENDENCY_SPLITER)!==r.eventTablePaths.join(x.Expression.DEPENDENCY_SPLITER))}))})},ms.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=o.convertBooleanTypeExpressionResult(t,r),t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},ms.prototype.effect=function(t,e){var n=e.bindingType,r=this.cleanEventPath(t.path),i=this.effectorFactory.getEffector(e);if(i){var o=this.analysis(t,e);if(o){var a=e.path.split("/").filter(function(t){return t});if(n===x.Expression.ExpressionBindingType.Field){var s=[],p=a.slice(o.expressionTablePaths.length);if(0!==o.distance){if(!0===o.eventFromParent)return;if(!0!==o.eventFromChildren)return;var u=r.slice(0,r.length-1).concat(p);s.push(u)}qa.effect(i,e,s)}else n===x.Expression.ExpressionBindingType.State&&console.error("not supported！")}}},ms.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},ms.decorators=[{type:m.Injectable}],ms);function ms(){return null!==ds&&ds.apply(this,arguments)||this}var vs,Es=(f(bs,vs=$a),bs.prototype.filter=function(i){var o=this;return(i.path&&0!==i.path.length||!i.value||!Array.isArray(i.value)||0!==i.value.length)&&this.expressionObjects&&0<this.expressionObjects.length?this.expressionObjects.filter(function(t){if(t.ns!==i.ns||t.type!==x.Expression.ExpressionType.Readonly&&t.type!==x.Expression.ExpressionType.Visible&&t.type!==x.Expression.ExpressionType.Required&&t.type!==x.Expression.ExpressionType.Validate)return!1;var e=o.analysis(i,t);if(!e)return!1;if(e.isSameTable)return!0;if(!t.deps||0===t.deps.length)return!0;var n=t.deps.filter(function(t){return t.startsWith(Oe)});if(!n||n.length<1)return!1;var r=o.buildEntityPath(i.path).join("/");return-1!==n.findIndex(function(t){var e=t.split("/").slice(1).join("/");return o.getPathInfo(e).path===r})}):null},bs.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=o.convertBooleanTypeExpressionResult(t,r),t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},bs.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},bs.decorators=[{type:m.Injectable}],bs);function bs(){return null!==vs&&vs.apply(this,arguments)||this}var Cs,xs=(f(Ps,Cs=$a),Ps.prototype.filter=function(i){var o=this;return this.expressionObjects&&0<this.expressionObjects.length?this.expressionObjects.filter(function(t){var e=t.deps;if(!e||e.length<1)return!1;var n=e.findIndex(function(t){return t.startsWith(Oe)});if(-1===n)return!1;var r=o.analysis(i,t);return!!r&&1===r.eventTablePaths.length&&2===r.expressionTablePaths.length&&!!r.expressionTablePaths.join("/").startsWith(r.eventTablePaths.join("/"))&&-1!==(n=e.findIndex(function(t){return t.startsWith(Oe+"/"+r.eventTablePaths[0])}))}):null},Ps.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=o.convertBooleanTypeExpressionResult(t,r),t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},Ps.decorators=[{type:m.Injectable}],Ps);function Ps(){return null!==Cs&&Cs.apply(this,arguments)||this}var Is=(Object.defineProperty(Ts.prototype,"entityValueChangedEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof Ha})},enumerable:!0,configurable:!0}),Object.defineProperty(Ts.prototype,"stateValueChangedEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof Wa})},enumerable:!0,configurable:!0}),Object.defineProperty(Ts.prototype,"repositoryAddEntityEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof Xa})},enumerable:!0,configurable:!0}),Object.defineProperty(Ts.prototype,"repositoryRemoveEntityEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof es})},enumerable:!0,configurable:!0}),Object.defineProperty(Ts.prototype,"entityUpdateEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof ss})},enumerable:!0,configurable:!0}),Object.defineProperty(Ts.prototype,"repositoryLoadEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof is})},enumerable:!0,configurable:!0}),Object.defineProperty(Ts.prototype,"bindingDataAppendEntityEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof cs})},enumerable:!0,configurable:!0}),Object.defineProperty(Ts.prototype,"bindingDataValueChangeEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof hs})},enumerable:!0,configurable:!0}),Object.defineProperty(Ts.prototype,"bindingDataRemoveObjectEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof gs})},enumerable:!0,configurable:!0}),Object.defineProperty(Ts.prototype,"bindingDataLoadEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof Es})},enumerable:!0,configurable:!0}),Object.defineProperty(Ts.prototype,"bindingDataSelectionChangedHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof xs})},enumerable:!0,configurable:!0}),Ts.decorators=[{type:m.Injectable}],Ts.ctorParameters=function(){return[{type:Array,decorators:[{type:m.Optional},{type:m.Inject,args:[ia]}]}]},Ts);function Ts(t){this.handlers=t}var Ms=(Ss.prototype.attachEvent=function(){var n=this;this.expressionEventEmitter.attach().subscribe(function(t){!t||t.length<1||!n.expressionObjects||n.expressionObjects.length<1||t.forEach(function(t){var e=n.getEventHandler(t);e?e.handleEvent(t,n.expressionObjects):Me.warn("没有对应的事件处理器,event="+t.type)})})},Ss.prototype.resolveDependency=function(){var r=this;!this.resolverRegistry||!this.resolverRegistry.resolvers||this.resolverRegistry.resolvers.length<1||!this.expressionObjects||this.expressionObjects.length<1||!Array.isArray(this.expressionObjects)||this.expressionObjects.forEach(function(t){var e=t.expression,n=r.resolveService.resolve(e);t.deps=n})},Ss.prototype.getEventHandler=function(t){if(t.type===x.Expression.EventType.ValueChanged){if(t.source===x.Expression.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataValueChangeEventHandler;if(t.source===x.Expression.EventSource.Field)return this.eventHandlerRegistry.entityValueChangedEventHandler;if(t.source===x.Expression.EventSource.State)return this.eventHandlerRegistry.stateValueChangedEventHandler}else if(t.type===x.Expression.EventType.Append){if(t.source===x.Expression.EventSource.Repository||t.source===x.Expression.EventSource.Field)return this.eventHandlerRegistry.repositoryAddEntityEventHandler;if(t.source===x.Expression.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataAppendEntityEventHandler}else if(t.type===x.Expression.EventType.Remove){if(t.source===x.Expression.EventSource.Repository||t.source===x.Expression.EventSource.Field)return this.eventHandlerRegistry.repositoryRemoveEntityEventHandler;if(t.source===x.Expression.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataRemoveObjectEventHandler}else if(t.type===x.Expression.EventType.Update){if(t.source===x.Expression.EventSource.Repository)return this.eventHandlerRegistry.entityUpdateEventHandler}else if(t.type===x.Expression.EventType.Load){if(t.source===x.Expression.EventSource.Repository||t.source===x.Expression.EventSource.Field)return this.eventHandlerRegistry.repositoryLoadEventHandler;if(t.source===x.Expression.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataLoadEventHandler}else if(t.type===x.Expression.EventType.SelectionChanged&&t.source===x.Expression.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataSelectionChangedHandler;return null},Ss.decorators=[{type:m.Injectable}],Ss.ctorParameters=function(){return[{type:m.Injector},{type:Ko},{type:va},{type:Ve},{type:Is},{type:un}]},Ss);function Ss(t,e,n,r,i,o){var a=this;this.injector=t,this.expressionRegistry=e,this.expressionEventEmitter=n,this.resolverRegistry=r,this.eventHandlerRegistry=i,this.resolveService=o,this.expressionObjects=new Array,this.expressionRegistry.expressions.subscribe(function(t){t&&0<t.length&&(a.expressionObjects=t,a.resolveDependency()),a.attachEvent()})}var js=(ws.prototype.add=function(t,e){var n=this.components.get(t);n?n.push(e):this.components.set(t,[e])},ws.prototype.remove=function(t){var e=this.components.get(t);e&&0<e.length&&(e.length=0,this.components["delete"](t))},ws.prototype.get=function(t){if(t){var e=this.components.get(t);if(e&&0<e.length)return e}return null},ws.prototype.has=function(t){return this.components.has(t)},ws.prototype.clear=function(){this.components.clear()},ws.prototype.getComponentByType=function(t){for(var e=Array.from(this.components.values()),n=null,r=0;e&&r<e.length;r++)for(var i=e[r],o=0;i&&o<i.length;o++)if(i[o]instanceof t){n=i[o];break}return n},ws);function ws(){this.components=new Map}var Os,Ns=(f(Ds,Os=wi),Ds.prototype.dispose=function(t){var e=this;if(!this.isDisposed){if(this.isDestoried=!0,this.isDisposed=!0,this.destorySignal&&(this.destorySignal.next(),this.destorySignal.complete()),this.appContext&&(this.appContext.frameContextManager.unregFrameContext(this),this.appContext.frameComponentRefresher.unregFrameContext(this)),this.appContext&&!0===this.isRootFrameContext()){var n=this.viewModelNames;n&&Array.isArray(n)&&n.forEach(function(t){e[t]=null}),this.appContext.unregisterFromManager()}this.bindingData&&this.bindingData.dispose(),this.viewModel&&this.viewModel.dispose(),this.form&&(this.form.dispose(),this.form=null),this.commandBus&&(this.commandBus.dispose(),this.commandBus=null),ht.dispose(),this.frameComponent=null,this.repository=null,this.exceptionHandler=null,this.expressionManager=null,this.expressionEngineImpl=null,this.variableParseService=null,this.eventBus=null,this.translate=null,this.injector=null,this.expressionResult=null,Mt.setUserSettings(null)}},Ds.prototype.ngOnDestroy=function(){this.dispose()},Ds.prototype.getComponentById=function(t){var e=this.componentRefManager.get(t);return e&&0<e.length?e[0]:null},Ds.prototype.getComponentsById=function(t){return this.componentRefManager.get(t)},Ds.prototype.bindInjector=function(t){this.injector=t},Ds.prototype.init=function(t){this.frameComponent=t,this.initializeBindingData(),this.initializeStateMachine(),this.initializeUiState(),this.initializeForm(),this.initializeCommandBus(),this.initializeViewModel(),this.registerExceptionHandler(),this.initExpression(),this.appContext.frameComponentRefresher.regFrameComponent(this.frameId,this.frameComponent)},Ds.prototype.initExpression=function(){this.expressionEngineImpl=this.injector.get(Ms,null),this.expressionManager=this.injector.get(Xo,null),this.injector.get(ta,null),this.expressionResult=this.injector.get(Yo,null)},Ds.prototype.registerExceptionHandler=function(){var n=this,t=this.getFormAppContext(),e=t.ApplicationId;if(window[window.location.href]=e,null!==this.exceptionHandler){var r=window[e]=window[e]||{};null!==this.eventBus&&this.isRootFrameContext()&&(r.isExceptionHandlerExist=!0,this.exceptionHandler.setContext(this.appContext),this.eventBus.on("Exception","","onException",t,function(t){if(!0!==n.isDestoried){if(t&&t.error)try{t.error.__frame_context__=n}catch(e){}n.exceptionHandler.handle(t)}})),this.destorySignal.subscribe(function(){n.eventBus.off("Exception","","onException",t)})}},Ds.prototype.registerAppContextDestroyEvent=function(){var e=this;this.appContext&&this.appContext.destorySignal&&this.appContext.destorySignal.subscribe(function(t){e.stateMachine&&(t&&t.opportunity===x.DestroyOpportunity.AppContextDestroy||(e.stateMachine.dispose(),e.stateMachine=null)),e.repository&&e.repository.dispose()})},Ds.prototype.getFormAppContext=function(){return this.appContext},Ds.prototype.getFrameId=function(t){return t?this.namespace&&0<this.namespace.length?this.namespace+"_"+t:t:this.frameId},Ds.prototype.initializeRepository=function(){this.repository.setPaginationConfig(this.repository.paginationInfo)},Ds.prototype.initializeForm=function(){if(this.form=this.injector.get(gn,null),this.form){this.form.setTranslateService(this.injector.get(Yr,null));var t=this.viewModel.bindingPath||this.metadata.bindingTo;this.form.init(this.bindingData,t,this)}},Ds.prototype.initializeStateMachine=function(){this.stateMachine=this.injector.get(bi,null),this.stateMachine&&this.stateMachine.initialize(this,this.variableParseService)},Ds.prototype.initializeCommandBus=function(){var t=this.injector.get(ti,new ti(this.metadata.commandHandlers)),e=this.injector.get(oi,new oi(this.metadata.commandHandlerExtends)),n=new As(t,e,this,this.variableParseService);this.commandBus=new ks(n)},Ds.prototype.initializeViewModel=function(){this.metadata.bindingTo||(this.metadata.bindingTo=this.viewModel.bindingPath),this.viewModel.init(this),this.regViewModel(this.viewModel)},Ds.prototype.initializeBindingData=function(){var e=this,t=this.repository.name,n=this.appContext.runMode===x.RunMode.highSpeed;if(t&&n){var r=this.appContext.bindingDataManager.getBindingDataByName(t);this.bindingData.initByBindingList(r.list,this.viewModel.bindingPath),this.bindingData.pagingInfo=r.pagingInfo,this.bindingData.setDataTypeInfo(this.repository.entityTypeInfo),vn.watchReposiroty(this.repository,this.bindingData)}else this.bindingData.initByRepository(this.repository,this.viewModel.bindingPath),vn.watchReposiroty(this.repository,this.bindingData),this.bindingData.changes.subscribe(function(t){t.type===x.ChangeType.GlobalSelectionChanged&&e.appContext.handleSelectChange(t,e)})},Ds.prototype.initializeUiState=function(){var e=this,t=(window.location.href.indexOf("platform"),this.injector.get(hi,!1));if(this.uiState=this.injector.get(li,null),this.uiState){this.uiState.paramTypeTransform=t,this.uiState.initialize(this);var n=this.appContext&&this.appContext.router&&this.appContext.router.url||"",r=(new Vt).getParams(n);Object.keys(r).forEach(function(t){Object.defineProperty(e.uiState,t,{get:function(){return r[t]}})})}},Ds.prototype.regViewModel=function(t){this.appContext&&!1===this.appContext.viewModelManager.exsit(t.name)&&this.appContext.viewModelManager.register(t.name,t);var e=t.constructor.name,n=this.parent,r=null;if(n&&n.viewModel&&(r=n.viewModel),r){var i=r.childViewModels,o=null;if(i){var a=t.constructor.name;o=i[t.name]||i[a]}else 1===e.length?o=t.name.split("-").map(function(t,e){return 0<e&&t.length?t.charAt(0).toLocaleUpperCase()+t.substr(1,t.length-1):0===e&&t.length?t.charAt(0).toLocaleLowerCase()+t.substr(1,t.length-1):t}).join(""):t.relateChildName&&(o=t.relateChildName);o=o||e[0].toLowerCase()+e.substring(1,e.length),r.viewModelNames=r.viewModelNames||[],r[o]=t,r.viewModelNames.push(o),t.bindToParent(r)}},Ds.prototype.isRootFrameContext=function(){return null===this.parent||this.appContext.runMode===x.RunMode.highSpeed&&!0===this.getVirtualRootFrameContext().frameComponent.isDialogRootComponent},Ds.prototype.getVirtualRootFrameContext=function(){for(var t=this,e=this.parent;e&&e.namespace===this.namespace;)e=(t=e).parent;return t},Ds.prototype.getContextById=function(t){return this.appContext.getContextById(t)},Ds.prototype.getViewModel=function(t){var e=this.appContext;return e?e.viewModelManager.getViewModelByName(t):null},Ds.prototype.attachViewComponent=function(t){this.frameComponent=t,this.appContext.frameComponentRefresher.regFrameComponent(this.frameId,this.frameComponent)},Ds.prototype.invoke=function(t,e){var n=t.split("."),r=n[n.length-1],i=1===n.length?this.viewModel:this.getViewModel(n[n.length-2]);return i||alert("未匹配到'"+t+"'命令的视图模型，请检查事件是否配置正确。"),i[r](e)},Ds.decorators=[{type:m.Injectable}],Ds.ctorParameters=function(){return[{type:m.Injector},{type:Ds,decorators:[{type:m.Optional},{type:m.SkipSelf}]}]},Ds);function Ds(t,e){var n=Os.call(this)||this;n.injector=t,n.typeName="FrameContext",n.isDestoried=!1,n.isDisposed=!1,n.metadata={identify:"",namespace:"",commands:null,form:null,formControls:null,subForms:null,stateMachine:null,uiStates:null,bindingTo:""},n.componentRefManager=new js,n.enableServerSideChangeDetection=!1,n.appContext=t.get(uo),n.destorySignal=new g.Subject,e&&e.appContext===n.appContext?(n.parent=e,n.root=e.root):(n.parent=null,n.root=n),n.frameId=t.get(ao),n.appContext.contextMetadataManager.exsit(n.frameId)&&(n.metadata=n.appContext.contextMetadataManager.getContextMetadataByName(n.frameId)),n.namespace=t.get(so,null),n.bindingData=n.injector.get(Pn,new Pn),!n.appContext.useIsoluteEventBus||n.appContext.useIsoluteEventBus&&!n.appContext.isoluteEventBus?n.eventBus=n.injector.get(jo,null,m.InjectFlags.Optional):n.eventBus=n.appContext.isoluteEventBus,n.form=n.injector.get(gn,new gn),n.repository=n.injector.get(Ye,n.appContext.repository);var r=n.injector.get(Pe,"valid");n.repository&&(n.repository.entityCollection.changeSetPolicy=r),n.enableServerSideChangeDetection=n.injector.get(Ie,!1),n.uiState=n.injector.get(li,new li);var i=new Si;i.setMetadata(n.metadata),n.viewModel=n.injector.get(Si,i),n.variableParseService=t.get(Or,new Or([new Vr,new xr,new Ir,new Mr,new jr])),n.exceptionHandler=t.get(Lo,null,m.InjectFlags.Optional);var o=t.get(Yr,null);n.translate=o,ht.setTranslate(o);var a=t.get(ko,null);return Mt.setUserSettings(a),n.initializeRepository(),n.appContext.regFrameContext(n),n.registerAppContextDestroyEvent(),n}var Vs=(Object.defineProperty(Fs.prototype,"isGridComponent",{get:function(){return this.context&&this.context.viewModel?!!this.context.viewModel.dataGridColumnsName:undefined},enumerable:!0,configurable:!0}),Fs.prototype.dispose=function(t){var e=this;this.eventPipes&&this.eventPipes.forEach(function(t){t.disposeByCaller(e)}),this.cd=null,this.context.dispose(),this.destorySignal&&(this.destorySignal.next(),this.destorySignal.complete())},Fs.prototype.ngOnInit=function(){this.initialize()},Fs.prototype.initialize=function(){this.initialized||(this.context.init(this),this.viewModel=this.context.viewModel,this.cd=this.getChangeDetectorRef(),this.initPublicEvent(),this.initSubscription(),this.restComponent(),this.onFrameComponentInit(),this.initialized=!0)},Fs.prototype.onFrameComponentInit=function(){var e=this,t=this.injector.get(po,null);t&&Array.isArray(t)&&0<t.length&&t.forEach(function(t){t.onComponentInit(e.context)})},Fs.prototype.getChangeDetectorRef=function(){return this.injector.get(m.ChangeDetectorRef,null)},Fs.prototype.detach=function(){!1!==this.isCdValid()&&this.cd.detach()},Fs.prototype.reattach=function(){!1!==this.isCdValid()&&this.cd.reattach()},Fs.prototype.detectChanges=function(){!1!==this.isCdValid()&&this.cd.detectChanges()},Fs.prototype.isCdValid=function(){return this.cd&&!1===this.cd.destroyed||!1},Fs.prototype.restComponent=function(){this.context===this.context.root&&(null!==this.context.appContext.parent&&null!==this.context.appContext.parent.parent||(this.context.repository.reset(),this.context.bindingData.reset()))},Fs.prototype.ngOnDestroy=function(){this.dispose()},Fs.prototype.initSubscription=function(){this.subscription=this.getSubscription(),this.subscription&&(this.eventPipes=this.subscription.init(this))},Fs.prototype.getSubscription=function(){return this.injector.get(Io,null)},Fs.prototype.initPublicEvent=function(){this.declaration=this.getDeclaration(),this.declaration&&this.declaration.init(this)},Fs.prototype.getDeclaration=function(){return this.injector.get(vo,null)},Fs.prototype.trigger=function(e,n){var r=this,i=this.context.commandBus.executingCommandCount$.subscribe(function(t){0===t&&(r.innerTrigger(e,n),i?i.unsubscribe():setTimeout(function(){i&&i.unsubscribe()},0))})},Fs.prototype.innerTrigger=function(t,e){var n=this.declaration&&this.declaration[t];n&&n(e)},Fs.decorators=[{type:m.Injectable}],Fs.ctorParameters=function(){return[{type:m.Injector}]},Fs);function Fs(t){this.injector=t,this.initialized=!1,this.context=this.injector.get(Ns,null),this.context&&this.initialize(),this.destorySignal=new g.Subject}var Rs=function Lp(){},_s=(Bs.prototype.on=function(e,t,n){this.events.pipe(d.filter(function(t){return t.type===e&&(!t.frameIds||-1<t.frameIds.indexOf(n))})).subscribe(t)},Bs.prototype.off=function(t,e){throw new Error("暂不实现")},Bs.prototype.trigger=function(t,e,n){var r={type:t,data:e,frameIds:n};this.events.next(r)},Bs.decorators=[{type:m.Injectable}],Bs);function Bs(){this.events=new g.Subject}var As=(Ls.prototype.create=function(t){var e=this.handlerRegistry.get(t);return e.init(this.frameContext,this.variableParseService),this.extenderRegistry.get(t).reduce(function(t,e){return e.extend(t)},e)},Ls.prototype.dispose=function(){this.handlerRegistry.dispose(),this.extenderRegistry.dispose(),this.frameContext=null,this.variableParseService=null},Ls.decorators=[{type:m.Injectable}],Ls.ctorParameters=function(){return[{type:ti},{type:oi},{type:Ns},{type:Or}]},Ls);function Ls(t,e,n,r){this.handlerRegistry=t,this.extenderRegistry=e,this.frameContext=n,this.variableParseService=r}var ks=($s.prototype.dispatch=function(e){var n=this,r=new g.Subject;return this.executeCommand(e).subscribe({next:function(t){r.next(t),r.complete()},complete:function(){r.complete(),n.removeCommandFromExecutingQueue(e)},error:function(t){r.error(t),n.removeCommandFromExecutingQueue(e,!n.is401Error(t))}}),r},$s.prototype.dispose=function(){this.handlerFactory.dispose()},$s.prototype.executeCommand=function(t){this.addCommandToExecutingQueue(t);var e=t.name;return this.handlerFactory.create(e).execute(t)},$s.prototype.addCommandToExecutingQueue=function(t){this.executingCommands.push(t),this.executingCommandCount$.next(this.executingCommands.length)},$s.prototype.removeCommandFromExecutingQueue=function(e,t){void 0===t&&(t=!0),this.executingCommands=this.executingCommands.filter(function(t){return t!==e}),!0===t&&this.executingCommandCount$.next(this.executingCommands.length)},$s.prototype.is401Error=function(t){return t&&401===t.status},$s.decorators=[{type:m.Injectable}],$s.ctorParameters=function(){return[{type:As}]},$s);function $s(t){this.handlerFactory=t,this.executingCommands=[],this.executingCommandCount$=new g.BehaviorSubject(this.executingCommands.length)}var Us,Ks=[ti,oi,As,ks],Hs={imports:{}},Gs=(f(qs,Us=Zr),qs.prototype.dynamicInvoke=function(t,e,n,r){var i=r.frameContext.injector.get(t,null);if(i){this.setContextToServiceInstance(i,r);var o=this.parseService.parse(n,r).map(function(t){return t.expression});return i[e].apply(i,o)}},qs.prototype.dynamicInvoke2=function(t,e){var n=this,r=t.source,i=t.service,o=t.method,a=t.params.map(function(t){return Object.assign({},t)}),s=new g.Subject,p=r&&r.toLowerCase();if(p){var u=Hs.imports[p];u?setTimeout(function(){n.executeWithServiceModule(u,i,e,a,o,s)},0):System["import"](p).then(function(t){t&&(Hs.imports[p]=t),n.executeWithServiceModule(t,i,e,a,o,s)})}return s},qs.prototype.executeWithServiceModule=function(t,e,n,r,i,o){if(t[e]){var a=n.frameContext.injector,s=void 0;if(n.frameContext.injector.get(e,null))s=n.frameContext.injector.get(e);else{var p=this.loadProvidersFromModule(t),u=m.ReflectiveInjector.fromResolvedProviders(p,n.frameContext.injector);s=(n.frameContext.injector=u).get(e,null)}if(s){this.setContextToServiceInstance(s,n);var c=this.parseService.parse(r,n).map(function(t){return t.expression}),l=s[i];if(!l)return void console.error("未找到对应的命令:"+i);var f=l.apply(s,c);(g.isObservable(f)?f:g.of(f)).subscribe({next:function(t){o.next(t)},error:function(t){o.error(t)},complete:function(){o.complete(),n.frameContext.injector=a}})}}},qs.prototype.schedule=function(){this.scheduleStages(this.method.stages,null)},qs.prototype.scheduleStages=function(t,e){var r=this;t.reduce(function(t,e){if("executing"===e.type)r.addTask(e.name,function(t){return r.dynamicInvoke2(e,t)});else if("fork"===e.type)e.stages.forEach(function(t){r.scheduleStages(t.stages,t)}),r.scheduleStages(e.stages,e);else{if("determing"!==e.type)throw new Error("unknow method stage type, the "+e.name+"'s type is "+e.type);r.addTask(e.name,function(t){return g.of(!0)})}if(t){var n="determing"===t.type?t.condition:"1===1";r.addLink(t.name,e.name,n)}return e},e)},qs.prototype.loadProvidersFromModule=function(t){var e=[];for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)){var r=t[n];if(this.isInjectableService(r)){var i=n;e.push({provide:i,useClass:r}),e.push(r)}}return m.ReflectiveInjector.resolve(e)},qs.prototype.isInjectableService=function(t){var e=!1,n=t instanceof Function;if(n&&t.hasOwnProperty("decorators"))e=(r=t.decorators.filter(function(t){if(t.type&&t.type.prototype&&"Injectable"===t.type.prototype.ngMetadataName)return t}))&&0<r.length;else if(n&&t.hasOwnProperty("__annotations__")){var r;e=(r=t.__annotations__.filter(function(t){if(t&&t.ngMetadataName&&"Injectable"===t.ngMetadataName)return t}))&&0<r.length}return e},qs);function qs(t,e){var n=Us.call(this)||this;return n.commandName=t,n.method=e,n}var zs=new m.InjectionToken("@farris/common-service ValidationHandler"),Js=[jo,Io,hr,Kr,uo,Vt,_s,Li],Ws=[jo,Io,hr,Vt,Kr,Li],Ys=[uo],Zs=[ca,ga,wa,La,Ko,va,Jo,Xo,Yo,ta,{provide:we,useClass:en,multi:!0},{provide:we,useClass:on,multi:!0},{provide:we,useClass:sn,multi:!0},Ve,{provide:ia,useClass:Xa,multi:!0},{provide:ia,useClass:es,multi:!0},{provide:ia,useClass:Ha,multi:!0},{provide:ia,useClass:Wa,multi:!0},{provide:ia,useClass:is,multi:!0},{provide:ia,useClass:ss,multi:!0},{provide:ia,useClass:cs,multi:!0},{provide:ia,useClass:hs,multi:!0},{provide:ia,useClass:gs,multi:!0},{provide:ia,useClass:Es,multi:!0},{provide:ia,useClass:xs,multi:!0},Is,Ms,un],Xs=[{provide:Go,useClass:oa,multi:!0},{provide:Go,useClass:pa,multi:!0},{provide:Go,useClass:ya,multi:!0}],Qs=[{provide:ba,useClass:Ca,multi:!0},{provide:ba,useClass:Pa,multi:!0},{provide:ba,useClass:Ta,multi:!0},{provide:ba,useClass:Sa,multi:!0},{provide:ba,useClass:Na,multi:!0},{provide:ba,useClass:Va,multi:!0},{provide:ba,useClass:Ra,multi:!0},{provide:ba,useClass:Ba,multi:!0}],tp=[Ks,Ns],ep=(np.decorators=[{type:m.NgModule,args:[{providers:Ws}]}],np);function np(){}var rp,ip,op=(f(ap,rp=qo),ap.prototype.buildEventPath=function(t){return null},ap.decorators=[{type:m.Injectable}],ap.ctorParameters=function(){return[{type:m.Injector},{type:Pn},{type:undefined,decorators:[{type:m.Inject,args:[so]}]}]},ap);function ap(t,e,n){var r=rp.call(this)||this;return r.injector=t,r.bindingData=e,r.namespace=n,r}(ip=x.CacheReturnType||(x.CacheReturnType={}))[ip.Static=1]="Static",ip[ip.Promise=2]="Promise";var sp=(pp.prototype.compare=function(t,e){return t===e},pp);function pp(){}var up=(cp.prototype.isExpired=function(){return"number"==typeof this.ttl?Date.now().valueOf()>this.createAt.valueOf()+this.ttl:Date.now()>this.ttl.valueOf()},cp);function cp(t,e,n){this.key=t,this.content=e,this.ttl=n,this.createAt=new Date}var lp=(fp.prototype.get=function(t){var e=this.provider.get(t);return!e||this.isCacheObjectExpired(e)?undefined:e.content},fp.prototype.set=function(t,e,n){var r=new up(t,e,n||0);this.provider.set(r)},fp.prototype.isCacheObjectExpired=function(t){return"number"==typeof t.ttl?Date.now().valueOf()>t.createAt.valueOf()+t.ttl:Date.now()>t.ttl.valueOf()},fp);function fp(t){this.provider=t,this.provider=t}var hp=(yp.prototype.has=function(e){var n=this;return!(this.store.length<1)&&-1!==this.store.findIndex(function(t){return t&&n.cacheKeyCompare.compare(e,t.key)})},yp.prototype.length=function(){return this.store.length},yp.prototype.set=function(t){this.store.push(t)},yp.prototype.get=function(e){var n=this;return this.store.length<1?undefined:this.store.find(function(t){return n.cacheKeyCompare.compare(e,t.key)})},yp.prototype["delete"]=function(e){var n=this;if(!(this.store.length<1)){var t=this.store.findIndex(function(t){return t&&n.cacheKeyCompare.compare(e,t.key)});this.store.splice(t,1)}},yp.prototype.clear=function(){this.store.length=0},yp.prototype.keys=function(){return this.store.keys()},yp.prototype.values=function(){return this.store.values()},yp);function yp(t){this.store=new Array,this.cacheKeyCompare=t||new sp}var dp=(gp.prototype.has=function(t){return this.buffer.has(t)},gp.prototype.length=function(){return this.buffer.size},gp.prototype.set=function(t){this.buffer.set(t.key,t)},gp.prototype.get=function(t){return this.buffer.get(t)},gp.prototype["delete"]=function(t){this.buffer["delete"](t)},gp.prototype.clear=function(){this.buffer.clear()},gp.prototype.keys=function(){return this.buffer.keys()},gp.prototype.values=function(){return this.buffer.values()},gp);function gp(){this.buffer=new Map}x.ɵb=x.Expression,x.ɵc=qo,x.ɵe=op,x.ɵa=Br,x.ANNOTATIONS=C,x.PARAMETERS=I,x.PROP_METADATA=T,x.makeDecorator=M,x.makeParamDecorator=function kp(t,e,n){var r=S(e);function o(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(this instanceof o)return r.apply(this,t),this;var i=new(o.bind.apply(o,b([void 0],t)));return n.annotation=i,n;function n(t,e,n){for(var r=t.hasOwnProperty(I)?t[I]:Object.defineProperty(t,I,{value:[]})[I];r.length<=n;)r.push(null);return(r[n]=r[n]||[]).push(i),t}}return n&&(o.prototype=Object.create(n.prototype)),o.prototype.ngMetadataName=t,o.annotationCls=o},x.makePropDecorator=j,x.MetadataUtil=w,x.ChangeSet=V,x.Modification=D,x.Entity=Wn,x.DynamicEntity=Xn,x.createEntity=tt,x.createEntities=et,x.EntityFactory=nt,x.EntityList=mt,x.NG_FIELD=_,x.NgField=B,x.NG_LIST=A,x.NgList=L,x.NG_OBJECT=k,x.NgObject=$,x.NG_Dynamic=U,x.NgDynamic=K,x.NG_ENTITY=H,x.NgEntity=function $p(t){return M(H,function(t){return t})(t)},x.FieldMetadataUtil=G,x.EntityMetadataUtil=z,x.PARENT_PATH=W,x.PARENT_CLASS=Y,x.ENTITY_DATA_SERVICE_TOKEN=rr,x.ValidationTypes=it,x.Validator=dt,x.ValidationError=at,x.entityPrototype=ir,x.EntityTypeFactory=lr,x.EntityTypeCreator=X,x.RestfulService=hr,x.NG_REPOSITORY=Re,x.NgRepository=function Up(t){return M(Re,function(t){return t})(t)},x.EntityCollection=_e,x.EntityManager=Ae,x.Repository=Ye,x.DefaultRepository=Qe,x.SortConditionManager=He,x.FilterConditionManager=qe,x.BigNumberType=xt,x.DEVKIT_RUN_MODE=Tt,x.DataPathNode=ce,x.DataPath=le,x.DataPathCreator=ye,x.DataPropInfo=ge,x.DataTypeInfo=me,x.FORM_PATH_TOKEN=Ee,x.BACK_END_MESSAGE_HANDLER_TOKEN=be,x.MESSAGE_SERVICE_TOKEN=Ce,x.NOTIFY_SERVICE_TOKEN=xe,x.CHANGE_SET_POLICY_TOKEN=Pe,x.ENABLE_SERVER_SIDE_CHANGE_DETECTION_TOKEN=Ie,x.ENABLE_EDIT_STATE_FILTER_SORTING=Te,x.encodeUrl=function Kp(t){return String(t).replace(/(^|[^\uD800-\uDBFF])[\uDC00-\uDFFF]|[\uD800-\uDBFF]([^\uDC00-\uDFFF]|$)/g,"$1�$2").replace(/(?:[^\x21\x25\x26-\x3B\x3D\x3F-\x5B\x5D\x5F\x61-\x7A\x7E]|%(?:[^0-9A-Fa-f]|[0-9A-Fa-f][^0-9A-Fa-f]|$))+/g,encodeURI).replace(/#/g,"%23").replace(/&/g,"%26")},x.Core=Me,x.escape=je,x.NG_COMMAND_HANDLER=dr,x.NgCommandHandler=function Hp(t){return M(dr,function(t){return t})(t)},x.NG_COMMAND_HANDLER_EXTENDER=gr,x.NgCommandHandlerExtender=function Gp(t){return M(gr,function(t){return t})(t)},x.TaskNode=mr,x.TaskLink=Hr,x.TaskFlow=qr,x.CommandContext=Jr,x.CommandHandler=Zr,x.COMMAND_HANDLERS_TOKEN=Qr,x.CommandHandlerRegistry=ti,x.CommandHandlerExtender=ni,x.COMMAND_HANDLER_EXTENDERS_TOKEN=ii,x.CommandHandlerExtenderRegistry=oi,x.CommandHandlerFactory=As,x.CommandBus=ks,x.COMMAND_PROVIDERS=Ks,x.DynamicCommandHandler=Gs,x.BaseBindingObject=Rn,x.BindingObject=An,x.BindingList=Vn,x.BindingData=Pn,x.PropertyUtil=Rt,x.EntityUtil=vn,x.BindingListFactory=Lt,x.BindingObjectFactory=Kt,x.BindingDataFactory=kn,x.NG_BINDING_DATA=Un,x.NgBindingData=function qp(t){return M(Un,function(t){return t})(t)},x.BindingObjectTypeFactory=$t,x.BindingListTypeFactory=Bt,x.Form=gn,x.NG_VALIDATE_FORM=Gt,x.NgValidateForm=function zp(t){return M(Gt,function(t){return t})(t)},x.NG_CHILD_FORM=qt,x.NgChildForm=zt,x.NG_CHILD_FORM_ARRAY=Jt,x.NgChildFormArray=Wt,x.NG_FORM_CONTROL=Yt,x.NgFormControl=Zt,x.State=yi,x.initialUIState=!1,x.StateMachineContext=di,x.effectHandlers=Ei,x.StateMachine=bi,x.NgState=xi,x.NgRenderState=Pi,x.NgAction=Ii,x.UIState=li,x.NG_COMPONENT_STATE=si,x.NgParam=pi,x.UIStateMetadataUtil=ui,x.PARAM_TYPE_TRANSFORM_TOKEN=hi,x.EventBus=jo,x.EventCache=Oo,x.EventBusProxy=ho,x.EventPipe=Mo,x.NG_DECLARATION=mo,x.NgDeclaration=function Jp(t){return j(mo,function(t){return t})(t)},x.Declaration=vo,x.NG_SUBSCRIPTION=bo,x.ParamMap=Co,x.NgSubscription=function Wp(t){return j(bo,function(t){return t})(t)},x.getNgSubscriptionDecoratorFactory=function Yp(){return j(bo,function(t){return t})},x.Subscription=Io,x.ViewModel=Si,x.NG_COMMAND=Ti,x.NgCommand=Mi,x.Context=wi,x.BindingDataManager=Ni,x.RepositoryManager=Vi,x.FrameContextManager=lo,x.FrameComponentRefresher=Ri,x.AppContext=uo,x.AppContextManager=Li,x.ViewModelManager=eo,x.FORM_ID=Ki,x.EXCEPTION_HANDLER=Lo,x.VALIDATION_HANDLER=zs,x.VARIABLE_PARSERS=Er,x.FrameIdVariableParser=Vr,x.DataVariableParser=xr,x.UIStateVariableParser=Ir,x.CommandVariableParser=jr,x.StateMachineVariableParser=Mr,x.VariableParseService=Or,x.EventParamVariableParser=$r,x.VARIABLE_PROVIDERS=Kr,x.FrameContext=Ns,x.FrameComponent=Vs,x.FrameEvent=Rs,x.FrameEventBus=_s,x.FRAME_ID=ao,x.NAMESPACE=so,x.FRAME_COMPONENT_INIT_HANDLER_TOKEN=po,x.RouterParamService=Vt,x.DataPathUtil=Kn,x.UID=Je,x.Guid=Gn,x.RunModeService=zn,x.DateUtil=lt,x.BindingPathConverter=Xt,x.BindingPathComparer=te,x.BindingPathTraverser=ne,x.EntityPathConverter=ie,x.EntityPathComparer=se,x.FormPathConverter=pe,x.ExpressionUtil=ln,x.DataTypeInfoUtil=hn,x.FARRIS_DEVKIT_APP_PROVIDERS=Js,x.FARRIS_DEVKIT_MODULE_PROVIDERS=Ws,x.FARRIS_DEVKIT_ROOT_FRAME_PROVIDERS=Ys,x.FARRIS_DEVKIT_EXPRESSION_ROOT_FRAME_PROVIDERS=Zs,x.FARRIS_DEVKIT_EXPRESSION_LISTENER_PROVIDERS=Xs,x.FARRIS_DEVKIT_EXPRESSION_EFFECTOR_PROVIDERS=Qs,x.FARRIS_DEVKIT_FRAME_PROVIDERS=tp,x.DevkitModule=ep,x.TranslateToken=Yr,x.UserSettingsToken=ko,x.ZonedTime=jt,x.Schema=or,x.SchemaEntity=ar,x.SchemaEntityType=sr,x.SchemaEntityField=pr,x.SchemaEntityFieldType=ur,x.SchemaEntityFieldEditor=cr,x.DomService=Hi,x.FormContent=qi,x.FormContentForDB=zi,x.FormMetadaDataDom=Ji,x.FormModule=Wi,x.FormOptions=Yi,x.LISTENER_TOKEN=Go,x.UIStateChangeListener=oa,x.RepositoryChangeListener=pa,x.ListenerRegistry=ca,x.BindingDataChangeListener=ya,x.Listeners=ga,x.FORM_MANIFEST_SERVICE_TOKEN=$o,x.FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN=Uo,x.ExpressionEventEmitter=va,x.ExpressionRegistry=Ko,x.ExpressionExecutor=Jo,x.ExpressionEngineImpl=Ms,x.ExpressionManager=Xo,x.ExpressionResult=Yo,x.ExpressionResultFactory=ta,x.ASSIGNER_TOKEN=ra,x.EVENT_HANDLER_TOKEN=ia,x.EFFECTOR_TOKEN=ba,x.RepositoryEffector=Ca,x.UIStateEffector=Pa,x.ReadonlyEffector=Ta,x.DependencyEffector=Sa,x.EffectorRegistry=wa,x.EffectorFactory=La,x.RelativeEffector=Na,x.ValidateEffector=Va,x.RequiredEffector=Ra,x.VisibleEffector=Ba,x.RESOLVER_TOKEN=we,x.ENTITY_TEMPLATE=Oe,x.STATE_TEMPLATE=Ne,x.GROUP_FUNCTIONS=De,x.ResolverRegistry=Ve,x.EntityDependencyResolver=en,x.StateDependencyResolver=on,x.CommentDependencyResolver=sn,x.ResolveService=un,x.EntityValueChangedEventHandler=Ha,x.StateValueChangedEventHandler=Wa,x.RepositoryAddEntityEventHandler=Xa,x.RepositoryRemoveEntityEventHandler=es,x.RepositoryLoadEventHandler=is,x.EntityUpdateEventHandler=ss,x.BindingDataAppendObjectEventHandler=cs,x.BindingDataValueChangeEventHandler=hs,x.BindingDataRemoveObjectEventHandler=gs,x.BindingDataLoadEventHandler=Es,x.BindingDataSelectionChangedEventHandler=xs,x.EventHandlerRegistry=Is,x.EventHandler=$a,x.CacheKeyCompare=sp,x.Cacheable=function Zp(h){return function(t,c,e){e===undefined&&(e=Object.getOwnPropertyDescriptor(t,c));var l=t.name||t&&t.constructor&&t.constructor.name,f=e.value;return e.value=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=h&&h.ttl||0,r=h&&h.provider;if(!r)throw new Error("cache provider is not defined.");var i=h&&h.key||undefined;i&&i instanceof Function&&(i=i(this,t));var o=i;if(!o){var a=JSON.stringify(t);o=l+"#"+String(c)+"#"+a}var s=r.get(o);if(!s||n&&!0===s.isExpired()){var p=f.apply(this,t),u=new up(o,p,n);return r.set(u),p}return s&&s.content},e}},x.CacheContainer=lp,x.CacheObject=up,x.MemoryCacheProvider=hp,x.DefaultCacheProvider=dp,x.DataFilter=Tn,x.LeftBracket=["","(","((","((("],x.RighttBracket=["",")","))",")))"],x.ArrayFilterConditionDataFilter=jn,x.ObjectFilterConditionDataFilter=Nn,Object.defineProperty(x,"__esModule",{value:!0})});
//# sourceMappingURL=farris-devkit.umd.min.js.map