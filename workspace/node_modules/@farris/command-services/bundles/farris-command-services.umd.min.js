!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@farris/ui-loading"),require("@farris/ui-messager"),require("@farris/ui-notify"),require("@farris/ui-wizard"),require("@angular/router"),require("@farris/extend-page-modal"),require("lodash-es"),require("rxjs/observable/zip"),require("rxjs/observable/empty"),require("@farris/ui-verify-detail"),require("mousetrap"),require("rxjs/observable/of"),require("@farris/ui-datagrid"),require("@gsp-wf/rtdevkit"),require("@gsp-wf/ui-flowchart"),require("@gsp-svc/cloudprint"),require("@gsp-svc/file-viewer"),require("@farris/ui-modal"),require("@farris/ui-sidebar"),require("@gsp-sys/rtf-common"),require("@farris/component-querycondition"),require("date-fns"),require("@farris/bef"),require("@farris/ui-common/date"),require("@gsp-svc/formdoc-upload"),require("@angular/common/http"),require("moment"),require("@farris/ui-tooltip"),require("@farris/rtf"),require("@farris/ui-feature-editor"),require("bignumber.js"),require("rxjs"),require("rxjs/operators"),require("@farris/ui-batch-edit-dialog"),require("@gsp-cmp/querysolution"),require("@farris/ui-list-filter"),require("@gsp-wf/wf-task-handler"),require("@angular/core"),require("@farris/devkit")):"function"==typeof define&&define.amd?define("@farris/command-services",["exports","@farris/ui-loading","@farris/ui-messager","@farris/ui-notify","@farris/ui-wizard","@angular/router","@farris/extend-page-modal","lodash-es","rxjs/observable/zip","rxjs/observable/empty","@farris/ui-verify-detail","mousetrap","rxjs/observable/of","@farris/ui-datagrid","@gsp-wf/rtdevkit","@gsp-wf/ui-flowchart","@gsp-svc/cloudprint","@gsp-svc/file-viewer","@farris/ui-modal","@farris/ui-sidebar","@gsp-sys/rtf-common","@farris/component-querycondition","date-fns","@farris/bef","@farris/ui-common/date","@gsp-svc/formdoc-upload","@angular/common/http","moment","@farris/ui-tooltip","@farris/rtf","@farris/ui-feature-editor","bignumber.js","rxjs","rxjs/operators","@farris/ui-batch-edit-dialog","@gsp-cmp/querysolution","@farris/ui-list-filter","@gsp-wf/wf-task-handler","@angular/core","@farris/devkit"],t):t((e.farris=e.farris||{},e.farris["command-services"]={}),e.uiLoading,e.uiMessager,e.uiNotify,e.uiWizard,e.ng.router,e.extendPageModal,e.lodash,e.rxjs["observable/zip"],e.rxjs["observable/empty"],e.uiVerifyDetail,e.Mousetrap,e.rxjs["observable/of"],e.uiDatagrid,e.rtdevkit,e.uiFlowchart,e.cloudprint,e.fileViewer,e.uiModal,e.uiSidebar,e.rtfCommon,e.componentQuerycondition,e.dateFns,e.bef,e.date,e.formdocUpload,e.ng.common.http,e.moment,e.uiTooltip,e.rtf,e.uiFeatureEditor,e.bignumber_js,e.rxjs,e.rxjs.operators,e.uiBatchEditDialog,e.querysolution,e.uiListFilter,e.wfTaskHandler,e.ng.core,e.devkit)}(this,function(e,t,r,i,n,a,C,s,v,y,o,c,g,u,l,p,d,f,h,m,S,b,I,w,x,E,P,D,F,M,T,R,O,N,A,j,B,L,k,V){"use strict";s=s&&s.hasOwnProperty("default")?s["default"]:s;var _="default"in c?c["default"]:c;D=D&&D.hasOwnProperty("default")?D["default"]:D;var q=(U.decorators=[{type:k.Injectable}],U);function U(){this.hideEvent=new O.Subject}var W=(H.prototype.setSuspend=function(e){H.isSuspend=e},H.prototype.show=function(e){if(!0!==H.isSuspend){this.loadingCmp&&(this.loadingCmp.close(),this.loadingCmp=null),this.registerService();var t=this.buildLoadingConfig(e);return this.loadingCmp=this.loadingService.show(t),this.loadingCmp}},H.prototype.showLoadingWithDelay=function(e,t){var r=this,i=setTimeout(function(){r.show(t)},e);return this.loadingTimerIds.push(i),this.registerService(),i},H.prototype.hideDelayLoading=function(e){this.clearLoadingTimer(e),this.hide()},H.prototype.buildLoadingConfig=function(e){var t;return(t=e?"object"==typeof e?e:{message:e}:{}).hasOwnProperty("delay")||(t.delay=0),t},H.prototype.clearAll=function(){var e=this;H.isSuspend=!1,window.setTimeout(function(){e.loadingService.clearAll()},350),this.loadingCmp=null,this.clearAllLoadingTimers(),this.destroy()},H.prototype.clearLoadingTimer=function(t){clearTimeout(t),this.loadingTimerIds=this.loadingTimerIds.filter(function(e){return e!==t})},H.prototype.clearAllLoadingTimers=function(){var t=this;this.loadingTimerIds.forEach(function(e){t.clearLoadingTimer(e)})},H.prototype.hide=function(){this.loadingCmp?!0!==H.isSuspend&&(this.loadingCmp.close(),this.loadingCmp=null,this.destroy()):this.destroy()},H.prototype.destroy=function(){if(!0!==H.isSuspend){var e=window.DEVKIT_LOADING_SERVICE||[];e&&Array.isArray(e)&&0<e.length&&e.forEach(function(e){e&&(e.clearAllLoadingTimers(),e.loadingCmp&&(e.loadingCmp.close(),e.loadingCmp=null))}),window.DEVKIT_LOADING_SERVICE=[]}},H.prototype.registerService=function(){var e=window.DEVKIT_LOADING_SERVICE||[];e.push(this),window.DEVKIT_LOADING_SERVICE=e},H.isSuspend=!1,H.decorators=[{type:k.Injectable}],H.ctorParameters=function(){return[{type:t.LoadingService},{type:q,decorators:[{type:k.Optional}]},{type:V.AppContext,decorators:[{type:k.Optional}]}]},H);function H(e,t,r){var i=this;this.loadingService=e,this.hideEventService=t,this.applicationContext=r,this.loadingTimerIds=[],t&&this.hideEventService.hideEvent.subscribe(function(e){i.hide()})}var K=function ho(){this.yes="Yes",this.no="No",this.unsaveNotifyTitle="Exist unsave record. Do save operation or not?",this.clientNotifyTitle="System Prompt In The Frontend",this.serverNotifyTitle="System Prompt In The Backend",this.cancelApproveSuccess="Cancel Approve Success",this.cancelApproveFailed="Cancel Approve Failed",this.unallowEmptyProcessInstanceName="Process Instance Name Can Not Be Empty",this.unallowEmptyBizBillId="Biz Bill Id Can Not Be Empty",this.unallowEmptyChildBizBillId="Child Biz Bill Id Can Not Be Empty",this.bizDefKeyRequired="Biz Def Key can't be empty.",this.procInsIdRequired="Process instance Id can't be empty.",this.addChildFailed="Add Child Failed",this.addSiblingFailed="Add Sibling Failed",this.addSubChildFailed="Add Sub Child Failed",this.addSubSiblingFailed="Add Sub Sibling Failed",this.deleteFailed="Delete Failed",this.multiSaveFailed="MultiSave Failed",this.appendFailed="Append Failed",this.queryFailed="Query Failed",this.cancelFailed="Cancel Failed",this.updateFailed="Update Failed",this.addFailed="Add Failed",this.loadFailed="Load Failed",this.saveSuccess="Successfully saved!",this.saveFailed="Save failed!",this.deleteSuccess="Successfully deleted!",this.deleteFaild="Failed to delete!",this.confirmDeletion="Confirm deletion?",this.submitSuccess="Submit successfully!",this.submitFaild="Submit failed!",this.notifyTitle="System prompt",this.httpError="HTTP request error! Please check the server error!",this.gridDataNotSave="The current page data is not saved. Turning the page will result in data loss. Do you want to continue turning the page?",this.exitWithoutSave="There is unsaved data. Do you want to continue closing?",this.notSupportMenuType="Not supported menu type!",this.cancelWithoutSave="Exist unsaved change,Confirm to cancel?",this.plsSelectDeleteData="Please select the data to delete!",this.errorHierarchyKey="Incorrect ierarchy key",this.plsSelectParentNode="Please select parent node!",this.deleteChildFirst="Please delete the child nodes first!",this.incorrectHierarchyConfig="Hierarchy config is incorrect!",this.operationFailed="The operation failed.",this.plsSelectEditData="Please select the data you want to edit!",this.plsSelectViewData="Please select the data you want to view!",this.plsUploadFirst="Please upload attachment first!",this.defaultDialogTitle="Dialog",this.changeToFirst="The first data.",this.changeToLast="The last data.",this.noProcessInstanceId="Please provide the process instance id.",this.noDataExist="Data does not exist to access the edit state!",this.noAttachment="There are no attachments to preview.",this.confirm="Confirm",this.cancel="Cancel",this.plsSelectCopyData="Please select the data you want to copy!",this.copyFieldsRequired="The copy fields can`t be empty!",this.pathIsRequired="The request url can`t be empty!",this.propsIsEmpty="The material has no props!",this.historyAttachment="The history attachment can`t be delete!",this.plsSelectDownloadAtt="Please select the attachment you want to download!",this.noDownloadAtt="There are no attachments to download!",this.plsCheckBatchEditRows="Please check the rows you want to edit!",this.plsSelectDetailFormData="Please select a detail form data first!",this.dataAndStateChanged="Are you sure you want to load the new data and switch to $1 state?",this.dataChanged="Are you sure you want to load the data and discards the current modification?",this.stateChanged="Are you sure you want to switch $1 state?",this.defaultStateName="init",this.copy="Copy detail message",this.copySuccess="Copy success",this.copyFailed="Copy failed",this.roger="Roger",this.appOrFuncIdRequired="No menu or application parameters are configured, please configure them in the designer.",this.tableCanNotEmpty="can not empty.",this.plsSelectRemoveAtt="Please select the attachment to delete!",this.plsSelectUpdateRow="Please select the row where you want to update the attachment!"},z=function vo(){this.yes="是",this.no="否",this.unsaveNotifyTitle="存在未保存记录。是否要保存？",this.clientNotifyTitle="前端异常提示",this.serverNotifyTitle="服务器端异常提示",this.cancelApproveSuccess="取消提交成功！",this.cancelApproveFailed="取消提交失败！",this.unallowEmptyProcessInstanceName="流程实例名称不能为空",this.unallowEmptyBizBillId="请选择一条数据",this.bizDefKeyRequired="入口单据不能为空",this.unallowEmptyChildBizBillId="从表业务单据编号不能为空！",this.procInsIdRequired="流程实例Id不能为空！",this.addChildFailed="新增子级失败",this.addSiblingFailed="新增同级失败",this.addSubChildFailed="新增从表子级失败",this.addSubSiblingFailed="新增从表同级失败",this.deleteFailed="删除失败",this.multiSaveFailed="批量保存失败",this.appendFailed="追加失败",this.queryFailed="查询失败",this.cancelFailed="取消失败",this.updateFailed="更新失败",this.addFailed="新增失败",this.loadFailed="加载失败",this.saveSuccess="保存成功！",this.saveFailed="保存失败！",this.deleteSuccess="删除成功！",this.deleteFaild="删除失败！",this.confirmDeletion="确认删除？",this.submitSuccess="提交审批成功！",this.submitFaild="提交审批失败！",this.notifyTitle="系统提示",this.httpError="HTTP请求错误！请检查Server端错误！",this.gridDataNotSave="当前页数据未保存，翻页将导致数据丢失，是否继续翻页？",this.exitWithoutSave="存在未保存的数据，是否继续关闭？",this.notSupportMenuType="关闭的既不是菜单也不是应用。",this.cancelWithoutSave="存在未保存的变更，确认取消？",this.plsSelectDeleteData="请选择要删除的数据！",this.errorHierarchyKey="错误的分级码",this.plsSelectParentNode="请选择父节点",this.deleteChildFirst="请先删除子节点",this.incorrectHierarchyConfig="分级码配置信息错误",this.operationFailed="操作执行失败。",this.plsSelectEditData="请选择要编辑的数据！",this.plsSelectViewData="请选择要查看的数据！",this.plsUploadFirst="请先上传附件！",this.defaultDialogTitle="弹窗",this.changeToFirst="已到达第一条数据",this.changeToLast="已到达最后一条数据",this.noProcessInstanceId="请指定流程实例标识。",this.noDataExist="要编辑的数据不存在，无法进入编辑状态！",this.noAttachment="没有可以预览的附件。",this.confirm="确定",this.cancel="取消",this.plsSelectCopyData="请选择要复制的数据！",this.copyFieldsRequired="要复制的字段不能为空！",this.pathIsRequired="请求路径不能为空！",this.propsIsEmpty="没有可以编辑的物料特征！",this.historyAttachment="历史版本附件禁止删除！",this.plsSelectDownloadAtt="请选择要下载的附件!",this.noDownloadAtt="找不到要下载的附件!",this.plsCheckBatchEditRows="请勾选要批量编辑的行！",this.plsSelectDetailFormData="请先选择一条从表数据！",this.dataAndStateChanged="确定要加载数据并切换到$1状态？",this.dataChanged="确定要加载数据并放弃当前修改？",this.stateChanged="确定要切换到$1状态？",this.defaultStateName="初始",this.copy="复制详细信息",this.copySuccess="复制成功",this.copyFailed="复制失败",this.roger="知道了",this.appOrFuncIdRequired="未配置菜单或应用参数，请在设计器中配置。",this.tableCanNotEmpty="不能为空。",this.plsSelectRemoveAtt="请选择要删除的附件!",this.plsSelectUpdateRow="请选择要更新附件的行！"},J=function yo(){this.yes="是",this.no="否",this.unsaveNotifyTitle="存在未保存記錄。是否要保存？",this.clientNotifyTitle="前端異常提示",this.serverNotifyTitle="服務器端異常提示",this.cancelApproveSuccess="取消提交成功！",this.cancelApproveFailed="取消提交失敗！",this.unallowEmptyProcessInstanceName="流程實例名稱不能為空",this.unallowEmptyBizBillId="請選擇壹條數據",this.bizDefKeyRequired="入口單據不能為空",this.unallowEmptyChildBizBillId="從表業務單據編號不能為空！",this.procInsIdRequired="流程實例id不能為空！",this.addChildFailed="新增子級失敗",this.addSiblingFailed="新增同級失敗",this.addSubChildFailed="新增從表子級失敗",this.addSubSiblingFailed="新增從表同級失敗",this.deleteFailed="刪除失敗",this.multiSaveFailed="批量保存失敗",this.appendFailed="追加失敗",this.queryFailed="查詢失敗",this.cancelFailed="取消失敗",this.updateFailed="更新失敗",this.addFailed="新增失敗",this.loadFailed="加載失敗",this.saveSuccess="保存成功！",this.saveFailed="保存失敗！",this.deleteSuccess="刪除成功！",this.deleteFaild="刪除失敗！",this.confirmDeletion="確認刪除？",this.submitSuccess="提交審批成功！",this.submitFaild="提交審批失敗！",this.notifyTitle="系統提示",this.httpError="HTTP請求錯誤！請檢查Server端錯誤！",this.gridDataNotSave="當前頁數據未保存，翻頁將導致數據丟失，是否繼續翻頁？",this.exitWithoutSave="存在未保存的數據，是否繼續關閉？",this.notSupportMenuType="關閉的既不是菜單也不是應用。",this.cancelWithoutSave="存在未保存的變更，確認取消？",this.plsSelectDeleteData="請選擇要刪除的數據！",this.errorHierarchyKey="錯誤的分級碼",this.plsSelectParentNode="請選擇父節點",this.deleteChildFirst="請先刪除子節點",this.incorrectHierarchyConfig="分級碼配置信息錯誤",this.operationFailed="操作執行失敗。",this.plsSelectEditData="請選擇要編輯的數據！",this.plsSelectViewData="請選擇要查看的數據！",this.plsUploadFirst="請先上傳附件！",this.defaultDialogTitle="彈窗",this.changeToFirst="已到達第壹條數據",this.changeToLast="已到達最後壹條數據",this.noProcessInstanceId="請指定流程實例標識。",this.noDataExist="要編輯的數據不存在，無法進入編輯狀態！",this.noAttachment="沒有可以預覽的附件。",this.confirm="確定",this.cancel="取消",this.plsSelectCopyData="請選擇要復制的數據！",this.copyFieldsRequired="要復制的字段不能為空！",this.pathIsRequired="請求路径不能為空！",this.propsIsEmpty="沒有可以編輯的物料特征！",this.historyAttachment="曆史版本附件禁止刪除！",this.plsSelectDownloadAtt="請選擇要下載的附件!",this.noDownloadAtt="找不到要下載的附件！",this.plsCheckBatchEditRows="請勾選要批量編輯的行！",this.plsSelectDetailFormData="請先選擇一條從表數據！",this.dataAndStateChanged="確定要加載數據並切換到$1狀態？",this.dataChanged="確定要加載數據並放棄當前修改？",this.stateChanged="確定要切換到$1狀態？",this.defaultStateName="初始",this.copy="復制詳細信息",this.copySuccess="復制成功",this.copyFailed="復制失敗",this.roger="知道了",this.appOrFuncIdRequired="未配置菜單或應用參數，請在設計器中配置。",this.tableCanNotEmpty="不能為空。",this.plsSelectRemoveAtt="請選擇要刪除的附件!",this.plsSelectUpdateRow="請選擇更新附件的行！"},Y=(G.create=function(e){if(!0===this.languageMessageMap.has(e))return this.languageMessageMap.get(e);var t;switch(e){case"zh-CHS":t=new z;break;case"en":t=new K;break;case"zh-CHT":t=new J;break;default:t=new z}return this.languageMessageMap.set(e,t),t},G.languageMessageMap=new Map,G);function G(){}var $=(Object.defineProperty(Q.prototype,"languageMessage",{get:function(){return Y.create(this.language)},enumerable:!0,configurable:!0}),Q.getInstance=function(){if(this.innerInstance)return this.innerInstance;var e=new Q("zh-CHS");return Q.innerInstance=e},Q.prototype.extendProperties=function(){var t=this;Object.keys(this.languageMessage).forEach(function(e){Object.defineProperty(t,e,{get:function(){return t.languageMessage[e]}})})},Q.innerInstance=null,Q.decorators=[{type:k.Injectable}],Q.ctorParameters=function(){return[{type:String,decorators:[{type:k.Optional},{type:k.Inject,args:[k.LOCALE_ID]}]}]},Q);function Q(e){this.language="zh-CHS",this.language=e||"zh-CHS",this.extendProperties(),Q.innerInstance=this}var X=function(e,t){return(X=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function Z(e,t){function r(){this.constructor=e}X(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var ee=function(){return(ee=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function te(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}function re(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var i,n,o=r.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(i=o.next()).done;)a.push(i.value)}catch(s){n={error:s}}finally{try{i&&!i.done&&(r=o["return"])&&r.call(o)}finally{if(n)throw n.error}}return a}function ie(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(re(arguments[t]));return e}var ne=(oe.copyToClipboard=function(e){var t=window;if(t.clipboardData&&t.clipboardData.setData)return t.clipboardData.setData("Text",e);if(document.queryCommandSupported&&document.queryCommandSupported("copy")){var r=document.createElement("textarea");r.textContent=e,r.style.position="fixed",document.body.appendChild(r),r.select();try{return document.execCommand("copy")}catch(i){}finally{document.body.removeChild(r)}}return!1},oe);function oe(){}var ae=(se.ctorParameters=function(){return[{type:r.MessagerService},{type:$,decorators:[{type:k.Optional}]}]},se);function se(e,t){this.messagerService=e,this.languageService=t}var ce,ue=(Z(le,ce=ae),le.prototype.handleException=function(e){e&&this.messagerService.info(e.Message)},le.ctorParameters=function(){return[{type:r.MessagerService},{type:$,decorators:[{type:k.Optional}]}]},le);function le(e,t){return ce.call(this,e,t)||this}var pe,de=(Z(fe,pe=ae),fe.prototype.handleException=function(e){e&&this.messagerService.warning(e.Message)},fe.ctorParameters=function(){return[{type:r.MessagerService},{type:$,decorators:[{type:k.Optional}]}]},fe);function fe(e,t){return pe.call(this,e,t)||this}var he,ve=(Z(ye,he=ae),ye.prototype.handleException=function(e){e&&this.handleErrorLevel(e)},ye.prototype.handleErrorLevel=function(e){var r,i=this,t=e.Message||"",n=e.date||new Date,o=D(n).format("YYYY-MM-DD HH:mm:ss"),a=e.Detail||e.Message+"\r\n发生时间："+o+"\r\n详细信息："+e.innerMessage||"",s=e.innerMessage||null,c={showMaxButton:!1,buttons:[{text:this.langService.roger,cls:"btn btn-primary btn-lg",handle:function(){r.close()}}],width:440,height:200,safeHtml:!1,exception:{date:o,message:s,copyButton:{text:this.langService.copy,onClick:function(e){var t=ne.copyToClipboard(a)?i.langService.copySuccess:i.langService.copyFailed;r.content.showMiniNotify(t,1500)}}}};this.displayError(e),r=this.messagerService.show("exception",t,c)},ye.prototype.displayError=function(e){e&&console&&console.error&&console.error(e)},ye.ctorParameters=function(){return[{type:r.MessagerService},{type:$,decorators:[{type:k.Optional}]}]},ye);function ye(e,t){var r=he.call(this,e,t)||this;return r.langService=null,r.langService=t,r.langService||(r.langService=new $),r}var ge,me=(Z(Se,ge=ae),Se.prototype.handleException=function(e){e&&this.messagerService.error(e.Message)},Se.ctorParameters=function(){return[{type:r.MessagerService},{type:$,decorators:[{type:k.Optional}]}]},Se);function Se(e,t){return ge.call(this,e,t)||this}var Ce,be,Ie=(we.getInstance=function(e,t){return this.exceptionFactory||(this.exceptionFactory=new we(e,t)),this.exceptionFactory},we.prototype.getExceptionHandleStrategy=function(e){var t;switch(e){case 0:t=new ue(this.messagerService,this.languageService);break;case 1:t=new de(this.messagerService,this.languageService);break;case 2:t=new ve(this.messagerService,this.languageService);break;case 3:t=new me(this.messagerService,this.languageService);break;default:t=new ve(this.messagerService,this.languageService)}return t},we.exceptionFactory=null,we.decorators=[{type:k.Injectable}],we.ctorParameters=function(){return[{type:r.MessagerService},{type:$,decorators:[{type:k.Optional}]}]},we);function we(e,t){this.messagerService=e,this.languageService=t}(be=Ce=Ce||{})[be.Info=1]="Info",be[be.Success=2]="Success",be[be.Redirect=3]="Redirect",be[be.ClientError=4]="ClientError",be[be.ServerError=5]="ServerError";var xe=(Ee.getHttpStatusType=function(e){if(!e)return null;var t=null;return e<100||600<e?t=null:100<=e&&e<200?t=Ce.Info:200<=e&&e<300?t=Ce.Success:300<=e&&e<400?t=Ce.Redirect:400<=e&&e<500?t=Ce.ClientError:500<=e&&e<600&&(t=Ce.ServerError),t},Ee);function Ee(){}var Pe=(De.prototype.exception=function(e,t){t&&t.hasOwnProperty("expired")&&!0===t.expired||(t&&this.isHttpErrorResponse(t)?this.httpErrorHandler(t):this.commonErrorHandler(e))},De.prototype.httpErrorHandler=function(e){if(e)switch(xe.getHttpStatusType(e.status)){case Ce.ClientError:if(401===e.status){this.msgService.http401Error(e);break}this.msgService.httpErrorInClient(e);break;case Ce.ServerError:this.msgService.httpErrorInServer(e);break;default:throw new Error("Get invalid status code when using httpErrorHandler method.")}},De.prototype.commonErrorHandler=function(e){e&&this.msgService.error(e)},De.prototype.isHttpErrorResponse=function(e){return!!e&&"object"==typeof e&&(!("HttpErrorResponse"!==e.name||!e.hasOwnProperty("status")||!e.hasOwnProperty("error"))||e instanceof P.HttpErrorResponse)},De.decorators=[{type:k.Injectable}],De.ctorParameters=function(){return[{type:Fe},{type:$,decorators:[{type:k.Optional}]}]},De);function De(e,t){this.msgService=e,this.languageService=t}var Fe=(Me.prototype.question=function(e){var t=this.confirmPromise(e);return O.from(t)},Me.prototype.question2=function(i){var n=this,e=new Promise(function(e,t){var r=n.messagerService.question2(i,[{text:n.languageService.no,cls:"btn btn-secondary",handle:function(){e(!1),r.close()}},{text:n.languageService.yes,cls:"btn btn-primary",defaultFocus:!0,handle:function(){e(!0),r.close()}}])});return O.from(e)},Me.prototype.prompt=function(e){return this.messagerService.prompt(e)},Me.prototype.confirmPromise=function(r){var i=this;return new Promise(function(e,t){i.messagerService.question(r,function(){e(!0)},function(){e(!1)})})},Me.prototype.confirm=function(e){return this.messagerService.confirm(e)},Me.prototype.info=function(e){this.messagerService.info(e)},Me.prototype.error=function(e){this.messagerService.error(e)},Me.prototype.warning=function(e){this.messagerService.warning(e)},Me.prototype.httpErrorInServer=function(e){var t=e.error;if("string"==typeof t)try{t=JSON.parse(t)}catch(r){}t&&null!=t.Level&&t.Level!=undefined?Ie.getInstance(this.messagerService,this.languageService).getExceptionHandleStrategy(t.Level).handleException(t):this.messagerService.error(e.message)},Me.prototype.httpErrorInClient=function(e){if(e){var t=e.error&&e.error.error&&e.error.error.message||e.message&&e.message.replace(/http:\/\/[a-zA-Z0-9.:]{1,}/,"");this.messagerService.show("error",t,{showHeader:!1,width:400,height:200,safeHtml:!1})}},Me.prototype.http401Error=function(t){var r="401ErrorShownFlag";if(t&&!window[r]){var e={en:{title:"Warning",sessionInvalid:"Your login has expired, please login again.",ok:"ok",cancel:"cancel"},"zh-CHS":{title:"提示",sessionInvalid:"用户登录信息已失效，是否重新登录?",ok:"确认",cancel:"取消"}};this.curLanguage=this.curLanguage||"zh-CHS";var i={title:e[this.curLanguage].title,initialState:{okText:e[this.curLanguage].ok,okHandle:function(){n.close(),window[r]=!1;var e=(t&&t.error||{}).redirect_uri||"/login.html";window.location.href="/logout.html#?logout-before-redirect=true&loginUri="+e},cancelText:e[this.curLanguage].cancel,cancelHandle:function(){n.close(),window[r]=!1}},showHeader:!0,width:420,height:180,fitContent:!1},n=this.messagerService.show("question",e[this.curLanguage].sessionInvalid,i);window[r]=!0,n&&n.dialog&&n.dialog.instance.closed&&n.dialog.instance.closed.subscribe(function(){window[r]=!1})}},Me.decorators=[{type:k.Injectable}],Me.ctorParameters=function(){return[{type:r.MessagerService},{type:$,decorators:[{type:k.Optional}]},{type:String,decorators:[{type:k.Inject,args:[k.LOCALE_ID]}]}]},Me);function Me(e,t,r){this.messagerService=e,this.languageService=t,this.curLanguage=r,this.languageService=this.languageService||$.getInstance()}var Te=(Re.prototype["default"]=function(e){return this.notifyService["default"]({title:this.languageService.notifyTitle,msg:e,timeout:3e3})},Re.prototype.info=function(e,t){var r={title:this.languageService.notifyTitle,msg:e,timeout:3e3};return t&&t.hideTitle&&delete r.title,this.notifyService.info(r)},Re.prototype.success=function(e,t){var r={title:this.languageService.notifyTitle,msg:e,timeout:3e3};t&&t.hideTitle&&delete r.title,this.notifyService.success(r)},Re.prototype.warning=function(e,t){var r={title:this.languageService.notifyTitle,msg:e,timeout:3e3};t&&t.hideTitle&&delete r.title,this.notifyService.warning(r)},Re.prototype.error=function(e,t){var r={title:this.languageService.notifyTitle,msg:e,timeout:3e3};t&&t.hideTitle&&delete r.title,this.notifyService.error(r)},Re.decorators=[{type:k.Injectable}],Re.ctorParameters=function(){return[{type:i.NotifyService},{type:$,decorators:[{type:k.Optional}]}]},Re);function Re(e,t){this.notifyService=e,(this.languageService=t)||(this.languageService=$.getInstance())}var Oe=(Ne.prototype.preStep=function(){var e=this.wizardSer.getCurrentPageId();this.wizardSer.updateWizardState(n.WizardEventType.Prev,e)},Ne.prototype.nextStep=function(){var e=this.wizardSer.getCurrentPageId();this.wizardSer.updateWizardState(n.WizardEventType.Next,e)},Ne.prototype.cancelWizard=function(){this.wizardSer.cancelWizard()},Ne.prototype.finishWizard=function(){this.wizardSer.finishWizard()},Ne.decorators=[{type:k.Injectable}],Ne.ctorParameters=function(){return[{type:n.WizardService}]},Ne);function Ne(e){this.wizardSer=e}var Ae=(je.prototype.checkEmpty=function(e){return!!e},je.decorators=[{type:k.Injectable}],je.ctorParameters=function(){return[]},je);function je(){}var Be=(Le.prototype.checkBeforeEdit=function(e){return!0===this.ifSkipCheck(e)||!!e||(this.formNotifyService.warning(this.languageService.plsSelectEditData,{hideTitle:!0}),O.empty())},Le.prototype.checkBeforeView=function(e){return!0===this.ifSkipCheck(e)||!!e||(this.formNotifyService.warning(this.languageService.plsSelectViewData,{hideTitle:!0}),O.empty())},Le.prototype.ifSkipCheck=function(e){var t=this.context.command.params;return!1===t.hasOwnProperty("idToEdit")&&!1===t.hasOwnProperty("idToView")||""===e},Le.decorators=[{type:k.Injectable}],Le.ctorParameters=function(){return[{type:Fe},{type:Te},{type:$,decorators:[{type:k.Optional}]}]},Le);function Le(e,t,r){this.messageService=e,this.formNotifyService=t,this.languageService=r,this.languageService||(this.languageService=$.getInstance())}var ke=(Ve.prototype.trigger=function(e,t,r){this.eventBus.trigger(e,t,r)},Ve.decorators=[{type:k.Injectable}],Ve.ctorParameters=function(){return[{type:V.FrameEventBus}]},Ve);function Ve(e){this.eventBus=e}var _e=(qe.prototype.getState=function(){var e=!!sessionStorage&&sessionStorage.getItem(this.COMMAND_SERVICE_LINK_STORAGE_KEY)||null;return e?JSON.parse(e):{}},qe.prototype.setState=function(e){sessionStorage&&sessionStorage.setItem(this.COMMAND_SERVICE_LINK_STORAGE_KEY,JSON.stringify(e))},qe.prototype.addMenuState=function(e,t,r){if(void 0===r&&(r=!0),t){var i=this.getState(),n=!!i&&i.hasOwnProperty(e),o={id:t,status:r};n?i[e].find(function(e){return e.id===t})||i[e].push(o):i[e]=[o],this.setState(i)}},qe.prototype.getMenuState=function(e,t){var r=this.getState();if(null===r)return null;if(!r.hasOwnProperty(e))return null;var i=r[e],n=i.filter(function(e){return!0===e.status});return void 0===t||t.length<1?n:i.filter(function(e){return e.status&&e.id===t})},qe.prototype.updateMenuState=function(r,i){var n=this.getState();null!==n&&(Object.keys(n).forEach(function(e){var t=n[e].find(function(e){return e.id===r});t&&(t.status=i)}),this.setState(n))},qe.prototype.removeMenu=function(e){this.removeParentMenu(e),this.removeChildMenu(e)},qe.prototype.removeParentMenu=function(t){var r=this.getState();if(null===r)return null;Object.keys(r).forEach(function(e){e===t&&r[t].length<1&&delete r[e]}),this.setState(r)},qe.prototype.removeChildMenu=function(i){var t=this.getState();null!==t&&(Object.keys(t).forEach(function(e){var r=t[e];r&&0<r.length&&r.forEach(function(e,t){e.id===i&&r.splice(t,1)})}),this.setState(t))},qe.decorators=[{type:k.Injectable}],qe);function qe(){this.COMMAND_SERVICE_LINK_STORAGE_KEY="COMMAND_SERVICE_LINK_STORAGE_KEY"}var Ue=(We.prototype.route=function(e,t){e=this.router.createUrlTree([e]).toString(),this.setParams(e,t),this.router.navigateByUrl(e)},We.prototype.registerEvent=function(){var i=this,e=this.getParams(window.location.hash),n=this.getAppId()||this.getFuncId();this.frameworkService.eventListner(this.frameworkService.FuncSwitch,function(e){if(e){var t=i.getOriginalId(e.id)||e.tabId,r=i.menuStateService.getMenuState(t);t&&n===t&&r&&0<r.length&&(i.formReload(),i.lastSwitchId=t)}},e),this.frameworkService.eventListner(this.frameworkService.FuncClosed,function(e){if(e){i.onClosed.next(e);var t=i.getOriginalId(e.id)||e.tabId;if(n!==t){var r=i.menuStateService.getMenuState(n,t);t&&r&&0<r.length&&(i.removeMenuState(t),i.formReload(),i.lastCloseId=t)}}},e)},We.prototype.removeMenuState=function(e){this.context&&this.menuStateService.removeMenu(e)},We.prototype.getOriginalId=function(e){return e&&-1!==e.indexOf("_")&&(e=e.split("_")[0]),e},We.prototype.formReload=function(){try{this.context.frameContext.appContext.refresh()}catch(e){}},We.prototype.openMenu=function(e,t,r){void 0!==r&&"boolean"==typeof r||(r=!1);var i=this.buildParamMap(t),n=this.getFuncId()||this.getAppId();this.menuStateService.addMenuState(n,e),i.set("WEB_FORM_ROUTER_PARENT_ID",n),this.frameworkService.openFuncWithParam(e,i,r)},We.prototype.openApp=function(e,t,r,i){void 0!==i&&"boolean"==typeof i||(i=!1);var n=this.buildParamMap(r),o=this.getAppId()||this.getFuncId();this.menuStateService.addMenuState(o,e),n.set("WEB_FORM_ROUTER_PARENT_ID",o),this.appService&&this.appService.openApp(e,t,n,i)},We.prototype.buildParamMap=function(e){(null==e||"string"==typeof e&&e.length<1)&&(e={});var t=new Map;return"object"==typeof e&&(e=JSON.stringify(e)),e=window.encodeURIComponent(e),t.set("WEB_FORM_ROUTE_PARAMS",e),t},We.prototype.closeMenu=function(){var e=this.getFuncId(),t=this.getAppId(),r=this.findDialog(),i=r.isDialogComponent,n=r.rootComponent;if(i)this.get(n,"dialogRef").close();else if(null!==e&&"string"==typeof e&&0<e.length)this.closeFunc(e);else if(null!==t&&"string"==typeof t&&0<t.length){var o=this.getAppEntrance();this.closeApp(t,o)}else console.error(this.languageService.notSupportMenuType)},We.prototype.findDialog=function(){for(var e=this.get(this,"context.frameContext"),t=this.get(e,"frameComponent.isDialogRootComponent",!1),r=this.get(e,"parent");null!=r&&!t;)e=this.get(e,"parent"),r=this.get(r,"parent"),t=this.get(e,"frameComponent.isDialogRootComponent",!1);return{isDialogComponent:t,rootComponent:this.get(e,"frameComponent")}},We.prototype.get=function(e,t,r){void 0===r&&(r=null);var i=Array.isArray(t)?t:t.split(".").filter(function(e){return e.length});return i.length?null===e||e===undefined||"undefined"==typeof e[i[0]]?r:this.get(e[i.shift()],i,r):e===undefined?r:e},We.prototype.closeFunc=function(e){e=e||this.getFuncId(),this.frameworkService&&this.frameworkService.closeFunc(e).subscribe()},We.prototype.closeApp=function(e,t){e=e||this.getAppId(),void 0===t&&(t=this.getAppEntrance()),this.appService&&this.appService.closeApp(e,t).subscribe()},We.prototype.setParams=function(e,t){var r;r="string"==typeof t&&""!==t?JSON.parse(t):t||{},this.routerParamService.setParams(e,r)},We.prototype.getFuncId=function(){var e=window.location.hash;if(!e)return null;var t=this.decodeURLParams(e);return t&&t.hasOwnProperty("funcId")?t.funcId:null},We.prototype.getAppId=function(){var e=window.location.hash;if(!e)return null;var t=this.decodeURLParams(e);return t&&t.hasOwnProperty("appId")?t.appId:null},We.prototype.getParentMenuId=function(){var e=window.location.hash;if(!e)return null;var t=this.decodeURLParams(e);return t&&t.hasOwnProperty("WEB_FORM_ROUTER_PARENT_ID")?t.WEB_FORM_ROUTER_PARENT_ID:null},We.prototype.getAppEntrance=function(){var e=window.location.hash;if(!e)return null;var t=this.decodeURLParams(e);return t&&t.hasOwnProperty("appEntrance")?t.appEntrance:null},We.prototype.decodeURLParams=function(e){return void 0===e&&(e=window.location.hash||window.location.search),e.slice(e.indexOf("?")+1).split("&").reduce(function(e,t){var r,i=t.indexOf("="),n=t.slice(0,i),o=t.slice(i+1);return Object.assign(e,((r={})[n]=decodeURIComponent(o),r))},{})},We.prototype.getParams=function(e){return e?e.slice(e.indexOf("?")+1).split("&").reduce(function(e,t){var r,i=t.indexOf("="),n=t.slice(0,i),o=t.slice(i+1);return Object.assign(e,((r={})[n]=decodeURIComponent(o),r))},{}):{}},We.decorators=[{type:k.Injectable}],We.ctorParameters=function(){return[{type:a.Router},{type:V.RouterParamService},{type:S.FrameworkService},{type:S.AppService,decorators:[{type:k.Optional}]},{type:_e,decorators:[{type:k.Optional}]},{type:$,decorators:[{type:k.Optional}]}]},We);function We(e,t,r,i,n,o){this.router=e,this.routerParamService=t,this.frameworkService=r,this.appService=i,this.menuStateService=n,this.languageService=o,this.lastSwitchId=null,this.lastCloseId=null,this.onClosed=null,this.menuStateService||(this.menuStateService=new _e),this.languageService||(this.languageService=$.getInstance()),this.onClosed=new O.Subject,this.registerEvent()}var He={onTabClosed:"FuncClosed",onTabClosing:"beforeFuncCloseEvent",onTabSwitched:"funcSwitchEvent"},Ke=new k.InjectionToken("@farris/command-service-inside-dialog"),ze=new k.InjectionToken("@farris/command-service-modal-ref"),Je=(Ye.prototype.parse=function(e){return e?e.slice(e.indexOf("?")+1).split("&").reduce(function(e,t){var r,i=t.indexOf("="),n=t.slice(0,i),o=t.slice(i+1);return Object.assign(e,((r={})[n]=decodeURIComponent(o),r))},{}):{}},Ye.decorators=[{type:k.Injectable}],Ye);function Ye(){}var Ge=($e.prototype.getService=function(){for(var e=window;!e.gspframeworkService&&e!==window.top&&this.isSameOrigin(e);)e=e.parent;return e.gspframeworkService&&e.gspframeworkService.rtf||{}},$e.prototype.openMenu=function(e){this.rtfService&&this.rtfService.hasOwnProperty("func")&&"function"==typeof this.rtfService.func.openMenu&&this.rtfService.func.openMenu(e)},$e.prototype.openMenu$=function(e){return this.rtfService&&this.rtfService.hasOwnProperty("func")&&"function"==typeof this.rtfService.func.openMenuByStream?this.rtfService.func.openMenuByStream(e):O.EMPTY},$e.prototype.getEntityParam=function(e,t,r){void 0===r&&(r=!0),this.rtfService&&this.rtfService.hasOwnProperty("func")&&"function"==typeof this.rtfService.func.getEntityParam&&this.rtfService.func.getEntityParam(e,t,r)},$e.prototype.beforeCloseMenu=function(e){this.rtfService&&this.rtfService.hasOwnProperty("func")&&"function"==typeof this.rtfService.func.beforeClose&&this.rtfService.func.beforeClose(e)},$e.prototype.closeMenu=function(e){this.rtfService&&this.rtfService.hasOwnProperty("func")&&"function"==typeof this.rtfService.func.close&&this.rtfService.func.close(e)},$e.prototype.getMenuParams=function(e,t){this.rtfService&&this.rtfService.hasOwnProperty("func")&&"function"==typeof this.rtfService.func.getMenuParams&&this.rtfService.func.getMenuParams(e,t)},$e.prototype.addEventListener=function(e,t,r){this.rtfService&&this.rtfService.hasOwnProperty("frmEvent")&&"function"==typeof this.rtfService.frmEvent.eventListener&&this.rtfService.frmEvent.eventListener(e,t,r)},$e.prototype.getMenuSwitchControlEvent=function(){var r=new O.Subject,e=this.rtfService&&this.rtfService.frmEvent||null;if(e){var i=this.tabId,t=this.params;window.setTimeout(function(){e.eventListener(i,function(e){var t=e&&e.menuSwitchControl||null;t&&t.key===i?r.next(t.value):r.next(null)},t)},0)}return r},Object.defineProperty($e.prototype,"params",{get:function(){return this.rtfService&&this.rtfService.hasOwnProperty("session")&&"function"==typeof this.rtfService.session.getCommonVariable?this.rtfService.session.getCommonVariable():null},enumerable:!0,configurable:!0}),Object.defineProperty($e.prototype,"tabId",{get:function(){return this.params&&this.params.tabId||null},enumerable:!0,configurable:!0}),Object.defineProperty($e.prototype,"formToken",{get:function(){return this.params&&this.params.formToken||null},enumerable:!0,configurable:!0}),Object.defineProperty($e.prototype,"funcId",{get:function(){return this.params&&this.params.funcId||null},enumerable:!0,configurable:!0}),$e.prototype.subjectRegister=function(e,t,r){return this.rtfService&&this.rtfService.hasOwnProperty("broadcast")&&"function"==typeof this.rtfService.broadcast.subjectRegister?this.rtfService.broadcast.subjectRegister(e,t,r):null},$e.prototype.subjectRemove=function(e){this.rtfService&&this.rtfService.hasOwnProperty("broadcast")&&"function"==typeof this.rtfService.broadcast.subjectRemove&&this.rtfService.broadcast.subjectRemove(e)},$e.prototype.subjectNotify=function(e,t){this.rtfService&&this.rtfService.hasOwnProperty("broadcast")&&"function"==typeof this.rtfService.broadcast.notify&&this.rtfService.broadcast.notify(e,t)},$e.prototype.subjectResponse=function(e,t,r){if(this.rtfService&&this.rtfService.hasOwnProperty("broadcast")&&"function"==typeof this.rtfService.broadcast.response){var i=r;return(void 0===r||!r||r.length<1)&&(i=V.UID.create()),this.rtfService.broadcast.response(e,i,t),i}return null},$e.prototype.responseUnSubscribe=function(e,t){this.rtfService&&this.rtfService.hasOwnProperty("broadcast")&&"function"==typeof this.rtfService.broadcast.responseUnSubscribe&&this.rtfService.broadcast.responseUnSubscribe(e,t)},$e.prototype.isSameOrigin=function(e){var t=window.location.host;try{if(e&&e.location&&"undefined"!=typeof e.location.host)return e.location.host===t}catch(r){return!1}return!1},$e.decorators=[{type:k.Injectable}],$e.ctorParameters=function(){return[]},$e);function $e(){this.rtfService=this.getService()}var Qe=(Object.defineProperty(Xe.prototype,"querystrings",{get:function(){var e=this.querystringService.parse(window.location.hash);return e&&(e.formToken=this.runtimeFrameworkService.formToken),e},enumerable:!0,configurable:!0}),Xe.prototype.registerEvent=function(){var t=this,e=this.querystrings;this.params=e,this.runtimeFrameworkService.addEventListener(He.onTabSwitched,function(e){return t.handleTabSwitchEvent(e)},e),this.runtimeFrameworkService.addEventListener(He.onTabClosed,function(e){return t.handleTabClosedEvent(e)},e),this.runtimeFrameworkService.addEventListener(He.onTabClosing,function(e){return t.handleTabClosingEvent(e)},e)},Xe.prototype.handleTabSwitchEvent=function(e){if(e){var t=e.tabId||e.id||null;if(t){var r=this.params,i=r.tabId||r.funcId||r.appId,n=this.menuStateService.getMenuState(t);i&&i===t&&n&&0<n.length&&this.formReload(),this.fireTabSwitchEvent(e)}}},Xe.prototype.fireTabSwitchEvent=function(i){!this.onTabSwitchListeners||this.onTabSwitchListeners.size<1||this.onTabSwitchListeners.forEach(function(e,t,r){"function"==typeof e&&e(i)})},Xe.prototype.handleTabClosingEvent=function(r){var i=this;if(r){var n=r.tabId||r.id||null,o=this.params,e=o.tabId||o.funcId||o.appId;n&&e&&e===n&&this.fireTabClosingEvent(r).subscribe(function(e){if(e){setTimeout(function(){return i.removeMenuState(n)},500);var t=window.formEventServices;t.has(n)&&(t["delete"](n),window.formEventServices=t),r&&r.hasOwnProperty("token")||(r=Object.assign({},r,{token:o.formToken})),i.runtimeFrameworkService.closeMenu(r)}})}},Xe.prototype.fireTabClosingEvent=function(t){if(!this.onClosingListeners||this.onClosingListeners.size<1)return O.of(!0);var e=this.onClosingListeners.values(),r=O.from(e),i=!1;return r.pipe(N.concatMap(function(e){return i?O.EMPTY:e(t).pipe(N.take(1),N.tap(function(e){return i=!e}),N.switchMap(function(e){return O.of(e)}))}),N.every(function(e){return e}))},Xe.prototype.handleTabClosedEvent=function(e){if(e){var t=this.params,r=t.tabId||t.funcId||t.appId,i=e.tabId||e.id||null;if(r!==i){var n=this.menuStateService.getMenuState(r,i);i&&n&&0<n.length&&(this.removeMenuState(i),this.formReload()),this.fireTabClosedEvent(e)}}},Xe.prototype.removeMenuState=function(e){this.context&&this.menuStateService.removeMenu(e)},Xe.prototype.fireTabClosedEvent=function(i){!this.onClosedListeners||this.onClosedListeners.size<1||this.onClosedListeners.forEach(function(e,t,r){"function"==typeof e&&e(i)})},Xe.prototype.addEventListener=function(e,t){var r=V.UID.create();return e===He.onTabClosed?(this.onClosedListeners.set(r,t),r):e===He.onTabClosing?(this.onClosingListeners.set(r,t),r):e===He.onTabSwitched?(this.onTabSwitchListeners.set(r,t),r):null},Xe.prototype.removeEventListener=function(e,t){return e===He.onTabClosed?this.onClosedListeners["delete"](t):e===He.onTabClosing&&this.onClosingListeners["delete"](t)},Xe.prototype.clearEventListener=function(e){e===He.onTabClosed?this.onClosedListeners.clear():e===He.onTabClosing&&this.onClosingListeners.clear()},Xe.prototype.formReload=function(){try{this.context.frameContext.appContext.refresh()}catch(e){}},Xe.decorators=[{type:k.Injectable}],Xe.ctorParameters=function(){return[{type:Ge},{type:_e},{type:Je}]},Xe);function Xe(e,t,r){this.runtimeFrameworkService=e,this.menuStateService=t,this.querystringService=r,this.onClosedListeners=new Map,this.onClosingListeners=new Map,this.onTabSwitchListeners=new Map}var Ze=new k.InjectionToken("表单弹出窗口或隐藏组件列表"),et=(tt.prototype.append=function(e,t){this.controls[e]=t},tt.prototype.getControls=function(e){return this.controls[e]?this.controls[e]:(console.warn("未找到Key为"+e+"的组件！"),null)},tt.decorators=[{type:k.Injectable}],tt.ctorParameters=function(){return[{type:undefined,decorators:[{type:k.Optional},{type:k.Inject,args:[Ze]}]}]},tt);function tt(e){void 0===e&&(e={}),this.controls={},e=e||{},this.controls=ee({},e)}var rt="DEVKIT_APP_CONTEXT_MANAGER",it=(Object.defineProperty(nt.prototype,"context",{set:function(e){this.navigationEventService.context=e,this.commandContext=e},enumerable:!0,configurable:!0}),Object.defineProperty(nt.prototype,"formAppContext",{get:function(){if(this.frameContext){for(var e=this.frameContext.appContext;e&&e.parent&&e.parent.injector&&null!==e.parent.injector.get(V.FrameContext,null);)e=e.parent;return e}return null},enumerable:!0,configurable:!0}),Object.defineProperty(nt.prototype,"querystrings",{get:function(){var e=window.location.hash,t=this.formAppContext&&this.formAppContext.ApplicationId;if(t){var r=window[rt],i=r&&r.get(t);e=i&&i.hash||e}var n=this.querystringService.parse(e);return n&&(n.formToken=this.runtimeFrameworkService.formToken),n},enumerable:!0,configurable:!0}),Object.defineProperty(nt.prototype,"formNotifyService",{get:function(){return this.injector&&this.injector.get(Te,null)},enumerable:!0,configurable:!0}),nt.prototype.registerDestroyEvent=function(r){var e=this;this.frameContext&&this.frameContext.destorySignal&&this.frameContext.destorySignal.subscribe(function(){e.navigationEventService=null}),this.frameContext&&this.frameContext.appContext&&this.frameContext.appContext.destorySignal&&this.frameContext.appContext.destorySignal.subscribe(function(){var e=window.formEventServices;e&&e["delete"](r);var t=window[rt];t&&t["delete"](r)})},nt.prototype.openMenu=function(e,t,r,i,n,o,a){if(!t&&this.formNotifyService)return this.formNotifyService.warning(this.languageService.appOrFuncIdRequired,{hideTitle:!0}),O.EMPTY;o=o&&this.translate(o);var s=this.buildParamMap(r);!0===(a=this.convertToBoolean(a,!1))&&(s=this.buildParam(r));var c=this.querystrings.tabId||this.querystrings.funcId||this.querystrings.appId,u={tabId:e,funcId:t,appType:S.AppType.Menu,queryStringParams:s,entityParams:s,appId:undefined,appEntrance:undefined,isReload:i,tabName:o||null};if(!0===(n=this.convertToBoolean(n,!0))){var l=e?t+"_"+e:t;this.menuStateService.addMenuState(c,l)}this.runtimeFrameworkService.openMenu(u)},nt.prototype.openMenu$=function(e,t,r,i,n,o,a){if(!t&&this.formNotifyService)return this.formNotifyService.warning(this.languageService.appOrFuncIdRequired,{hideTitle:!0}),O.EMPTY;o=o&&this.translate(o);var s=this.buildParamMap(r);!0===(a=this.convertToBoolean(a,!1))&&(s=this.buildParam(r));var c=this.querystrings.tabId||this.querystrings.funcId||this.querystrings.appId,u={tabId:e,funcId:t,appType:S.AppType.Menu,queryStringParams:s,entityParams:s,appId:undefined,appEntrance:undefined,isReload:i,tabName:o||null};if(!0===(n=this.convertToBoolean(n,!0))){var l=e?t+"_"+e:t;this.menuStateService.addMenuState(c,l)}return this.runtimeFrameworkService.openMenu$(u)},nt.prototype.openMenuWithDimension=function(e,t,r,i,n,o,a,s,c){if(!t&&this.formNotifyService)return this.formNotifyService.warning(this.languageService.appOrFuncIdRequired,{hideTitle:!0}),O.EMPTY;a=a&&this.translate(a),s!==undefined&&null!==s||(s="");var u=this.buildParamMap(r);!0===(c=this.convertToBoolean(c,!1))&&(u=this.buildParam(r)),u.set("dim1",n||"public"),u.set("dim2",o||"public"),u.set("metadataId",s),u.set("isRtc","1"),u.set("isRootMetadata","true");var l=this.querystrings.tabId||this.querystrings.funcId||this.querystrings.appId,p={tabId:e,funcId:t,appType:S.AppType.Menu,queryStringParams:u,entityParams:u,appId:undefined,appEntrance:undefined,isReload:!1,tabName:a||null};if(!0===(i=this.convertToBoolean(i,!0))){var d=e?t+"_"+e:t;this.menuStateService.addMenuState(l,d)}this.runtimeFrameworkService.openMenu(p)},nt.prototype.openApp=function(e,t,r,i,n,o,a,s){if(!t&&this.formNotifyService)return this.formNotifyService.warning(this.languageService.appOrFuncIdRequired,{hideTitle:!0}),O.EMPTY;o=o&&this.translate(o);var c=this.buildParamMap(i);!0===(s=this.convertToBoolean(s,!1))&&(c=this.buildParam(i));var u=this.querystrings.tabId||this.querystrings.funcId||this.querystrings.appId,l={tabId:e,appId:t,appEntrance:r,funcId:undefined,appType:S.AppType.App,queryStringParams:c,entityParams:c,isReload:n,tabName:o||null};if(!0===(a=this.convertToBoolean(a,!0))){var p=e?t+"_"+r+"_"+e:t+"_"+r;this.menuStateService.addMenuState(u,p)}this.runtimeFrameworkService.openMenu(l)},nt.prototype.openApp$=function(e,t,r,i,n,o,a,s){if(!t&&this.formNotifyService)return this.formNotifyService.warning(this.languageService.appOrFuncIdRequired,{hideTitle:!0}),O.EMPTY;o=o&&this.translate(o);var c=this.buildParamMap(i);!0===(s=this.convertToBoolean(s,!1))&&(c=this.buildParam(i));var u=this.querystrings.tabId||this.querystrings.funcId||this.querystrings.appId,l={tabId:e,appId:t,appEntrance:r,funcId:undefined,appType:S.AppType.App,queryStringParams:c,entityParams:c,isReload:n,tabName:o||null};if(!0===(a=this.convertToBoolean(a,!0))){var p=e?t+"_"+r+"_"+e:t+"_"+r;this.menuStateService.addMenuState(u,p)}return this.runtimeFrameworkService.openMenu$(l)},nt.prototype.close=function(){var e=this.querystrings,t=this.findDialog(),r=t.isDialogComponent,i=t.rootComponent;if(r){var n=this.get(i,"dialogRef"),o=null;if("function"==typeof n){var a=n();o=a&&a.modalRef}else o=n;o&&o.close()}else e.token=e.formToken,this.runtimeFrameworkService.beforeCloseMenu(e)},nt.prototype.destory=function(){var e=this.querystrings;e.token=e.formToken,this.runtimeFrameworkService.closeMenu(e)},nt.prototype.parseParams=function(e){(null==e||"string"==typeof e&&e.length<1)&&(e={});var t=new Map;return"object"==typeof e&&(e=JSON.stringify(e)),e=window.encodeURIComponent(e),t.set("WEB_FORM_ROUTE_PARAMS",e),t},nt.prototype.addEventListener=function(e,t){return this.navigationEventService.addEventListener(e,t)},nt.prototype.removeEventListener=function(e,t){return this.navigationEventService.removeEventListener(e,t)},nt.prototype.clearEventListener=function(e){this.navigationEventService.clearEventListener(e)},nt.prototype.open=function(e,t,r,i,n,o,a,s,c,u,l,p){var d=this.injector.get(C.FEPageModalService,null);if(!d)throw new Error("get FEPageModalService failed.");if(!e)throw new Error("[NavigationService]->open,mode参数不能为空！");if("modal"===e||"sidebar"===e){if(!t&&!r)throw new Error("弹窗及侧边栏模式时弹窗容器id和表单路径不能同时为空！");if(t&&r)throw new Error("弹窗及侧边栏模式时弹窗容器id和表单路径不能同时存在！");var f=this.getObjectTypeConfig(c),h=this.buildConfigs(i);"sidebar"===e&&(h.dialogType=e);var v=null;if(t){var y=this.injector.get(et,null);if(!y)return;var g=y.getControls(t),m=this.createComponentRef(g,f);v=d.show(m,h)}else r&&(v=d.showByUrl(r,h));if(v&&v.content){v.content.isDialogRootComponent=!0;var S=(v.content.dialogRef=v).dialog&&v.dialog.instance&&v.dialog.instance.el&&v.dialog.instance.el.nativeElement&&v.dialog.instance.el.nativeElement.querySelector(".f-page-header");S&&v.dialog.instance.draggbar&&((v.dialog.instance.draggbar.handle=S).style.cursor="move")}}else{if("tab"!==e)throw new Error("不支持的模式！");if(!n||!o||!a)throw this.formNotifyService&&this.formNotifyService.warning(this.languageService.appOrFuncIdRequired,{hideTitle:!0}),new Error("新标签模式时标签页id、标签类型、菜单或应用id均不能为空！");if("app"===o&&!s)throw new Error("以应用方式打开时入口应用不能为空！");"app"==o?this.openApp(n,a,s,c,!1,u,l,p):"menu"===o&&this.openMenu(n,a,c,!1,l,u,p)}},nt.prototype.navigate=function(e,t){var r=this.injector&&this.injector.get(a.Router,null),i=this.injector&&this.injector.get(a.ActivatedRoute,null),n=s.merge({},this.querystrings,t&&t.queryParams||{});t&&t.hasOwnProperty("queryParams")&&delete t.queryParams;var o=s.merge({skipLocationChange:!1,relativeTo:i,queryParams:n},t||{});return r?r.navigate(e,o):null},nt.prototype.buildParamMap=function(e,t){(null==e||"string"==typeof e&&e.length<1)&&(e={});var r=new Map;t&&0<Object.keys(t).length&&("object"!=typeof e&&(e=JSON.parse(e)),e=s.merge(e,t)),"object"==typeof e&&(e=JSON.stringify(e));var i=this.querystrings.tabId||this.querystrings.funcId||this.querystrings.appId;return e=window.encodeURIComponent(e),r.set("WEB_FORM_ROUTE_PARAMS",e),r.set("WEB_FORM_ROUTER_PARENT_ID",i),r},nt.prototype.buildParam=function(t,e){(null==t||"string"==typeof t&&t.length<1)&&(t={});var r=new Map;e&&0<Object.keys(e).length&&("object"!=typeof t&&(t=JSON.parse(t)),t=s.merge(t,e)),"object"!=typeof t&&(t=JSON.parse(t)),Object.keys(t).forEach(function(e){r.set(e,t[e])});var i=this.querystrings.tabId||this.querystrings.funcId||this.querystrings.appId;return t=window.encodeURIComponent(JSON.stringify(t)),r.set("WEB_FORM_ROUTE_PARAMS",t),r.set("WEB_FORM_ROUTER_PARENT_ID",i),r},nt.prototype.findDialog=function(){for(var e=this.get(this,"commandContext.frameContext"),t=this.get(e,"frameComponent.isDialogRootComponent",!1),r=null,i=this.get(e,"parent");null!=i&&!t;)e=this.get(e,"parent"),i=this.get(i,"parent"),t=this.get(e,"frameComponent.isDialogRootComponent",!1);return r=this.get(e,"frameComponent"),t||(t=this.frameContext.injector.get(Ke,!1))&&(r={dialogRef:this.frameContext.injector.get(ze,null)}),{isDialogComponent:t,rootComponent:r}},nt.prototype.get=function(e,t,r){void 0===r&&(r=null);var i=Array.isArray(t)?t:t.split(".").filter(function(e){return e.length});return i.length?null===e||e===undefined||"undefined"==typeof e[i[0]]?r:this.get(e[i.shift()],i,r):e===undefined?r:e},nt.prototype.convertToBoolean=function(e,t){return void 0===t&&(t=!1),null==e&&(e=t),"string"==typeof e&&(e="true"===(e||String(t))),e},nt.prototype.translate=function(e){var t=this.injector&&this.injector.get(V.TranslateToken,null)||null;return t&&e&&e.startsWith("{{")&&e.endsWith("}}")?(e=e.replace("{{","").replace("}}","").trim(),t.transform(e,null)):e},nt.prototype.buildConfigs=function(e){var r=this,t=this.injector.get($,null),i={title:(t=t||$.getInstance())&&t.defaultDialogTitle||"",width:800,height:500,showButtons:!1},n=this.getObjectTypeConfig(e),o=Object.assign(i,n),a=o.beforeClose,s=o.refresh||{},c=s&&s.commandName||null,u=s&&s.frameId||null,l=o.cancelChanges||!1;return o.beforeClose=function(t){return a&&"function"==typeof a?a(t).pipe(N.switchMap(function(e){return e&&l?r.cancelChanges(t).pipe(N.switchMap(function(){return r.refreshForm(c,u)})):O.of(e)})):l?r.cancelChanges(t).pipe(N.switchMap(function(){return r.refreshForm(c,u)})):O.of(!0)},o},nt.prototype.getObjectTypeConfig=function(e){var t;if(void 0===e&&(e={}),"string"==typeof e)if(e.length)try{t=JSON.parse(e)}catch(r){throw new Error(e+"不是合法的json字符串")}else t={};else{if("object"!=typeof e)throw new Error("填写对象格式或json字符串");t=Object.assign({},e)}return t},nt.prototype.cancelChanges=function(e){if(e&&e.modalRef&&e.modalRef.content){var t=e.modalRef.content;if(t&&t.context){var r=t.context.repository||null;if(r)return r.cancelChanges().pipe(N.switchMap(function(){return O.of(!0)}))}}return O.of(!0)},nt.prototype.refreshForm=function(e,t){if(e&&t){var r=this.frameContext.appContext.frameContextManager.getFrameContextById(t);if(r)return r.viewModel[e]().pipe(N.map(function(){return!0}))}return O.of(!0)},nt.prototype.createComponentRef=function(e,t){var r,i=this.getFrameContext(),n=this.getComponentFactoryResolver();if(i&&n){var o=n.resolveComponentFactory(e),a=k.ReflectiveInjector.resolveAndCreate([],i.injector);(r=o.create(a))&&r.instance&&r.instance.viewModel&&r.instance.viewModel.uiState&&("object"==typeof t&&Object.keys(t).length&&Object.keys(t).forEach(function(e){r.instance.viewModel.uiState.setPropertyValue(e,t[e])}),r.instance.viewModel.uiState.setPropertyValue("DEVKIT_DIALOG",!0))}return r},nt.prototype.getFrameContext=function(){return this.frameContext?this.frameContext:this.context&&this.context.frameContext?this.context.frameContext:null},nt.prototype.getComponentFactoryResolver=function(){var e,t=this.getFrameContext();return t&&(e=t.injector.get(k.ComponentFactoryResolver)),e},nt.decorators=[{type:k.Injectable}],nt.ctorParameters=function(){return[{type:Ge},{type:_e},{type:Qe},{type:Je},{type:V.FrameContext,decorators:[{type:k.Optional}]},{type:k.Injector,decorators:[{type:k.Optional}]},{type:$,decorators:[{type:k.Optional}]}]},nt);function nt(e,t,r,i,n,o,a){this.runtimeFrameworkService=e,this.menuStateService=t,this.navigationEventService=r,this.querystringService=i,this.frameContext=n,this.injector=o,this.languageService=a;var s=this.formAppContext&&this.formAppContext.ApplicationId,c=this.querystrings.tabId||this.querystrings.funcId||this.querystrings.appId;if(s){var u=window[rt]||new Map;u&&!u.has(s)&&(u.set(s,{hash:window.location.hash}),window[rt]=u)}if(c){var l=window.formEventServices||new Map;s&&(c=s),l&&l.has(c)?this.navigationEventService=l.get(c):(this.navigationEventService.registerEvent(),l.set(c,this.navigationEventService),this.navigationEventService.frameContext=this.frameContext,window.formEventServices=l,this.registerDestroyEvent(c))}a||(this.languageService=new $)}var ot="IS_ADD",at="LAST_MODIFIED_ID",st=(ct.getLastModifiedId=function(e){var t=e.getVirtualRootFrameContext(),r=null;return t?(r=t.getParam(at))||null:r},ct.setLastModifiedId=function(e,t){var r=e.getVirtualRootFrameContext();r&&r.setParam(at,t)},ct.getAddState=function(e){var t=e.getVirtualRootFrameContext();if(t)return t.getParam(ot)},ct.setAddState=function(e,t){var r=e.getVirtualRootFrameContext();r&&r.setParam(ot,!0),this.setLastModifiedId(e,t)},ct.cancelAddState=function(e){var t=e.getVirtualRootFrameContext();t&&t.setParam(ot,!1)},ct.setEditState=function(e,t){var r=e.getVirtualRootFrameContext();r&&r.setParam(ot,!1),this.setLastModifiedId(e,t)},ct);function ct(){}var ut=(lt.info=function(e,t){var r=window.location.hash,i=lt.querystring(r).odocDisableNotification,n=void 0===i?"":i;n&&"true"===n.toLowerCase()||e.info(t,{hideTitle:!0})},lt.success=function(e,t){var r=window.location.hash,i=lt.querystring(r).odocDisableNotification,n=void 0===i?"":i;n&&"true"===n.toLowerCase()||e.success(t,{hideTitle:!0})},lt.querystring=function(e){var t=new URLSearchParams(e),r={};return t.forEach(function(e,t){r[t]=e}),r},lt);function lt(){}var pt=(Object.defineProperty(dt.prototype,"context",{get:function(){return this.innerContext},set:function(e){this.innerContext=e},enumerable:!0,configurable:!0}),dt.prototype.execute=function(e,t){if(e&&""!==e&&"undefined"!==e){var r=this.viewModel;return t&&(r=this.appContext.frameContextManager.getFrameContextById(t).viewModel),r[e]()}},dt.prototype.waitForBeSession=function(){return this.context.frameContext.repository.restService.sessionService.getBeSessionId().pipe(N.filter(function(e){return null!==e}),N.take(1))},dt.prototype.extractResult=function(e){return this.context.results[e]},dt.prototype.suspendFrameContextRowSelectedEvent=function(e){var t=this.viewModel.frameContext;e&&(t=this.viewModel.frameContext.appContext.frameContextManager.getFrameContextById(e)),t&&(t.bindingData.rowSelectedEventSuspend=!0)},dt.prototype.resumeFrameContextRowSelectedEvent=function(e){var t=this.viewModel.frameContext;e&&(t=this.viewModel.frameContext.appContext.frameContextManager.getFrameContextById(e)),t&&(t.bindingData.rowSelectedEventSuspend=!1)},dt.decorators=[{type:k.Injectable}],dt.ctorParameters=function(){return[{type:V.ViewModel},{type:V.AppContext}]},dt);function dt(e,t){this.viewModel=e,this.appContext=t}var ft=(ht.focusElement=function(e,t){var r=(t&&t.nativeElement||document).ownerDocument.getElementById(e);if(r){if("INPUT"!==r.tagName){var i=r.getElementsByTagName("input");i.length&&(r=i[0])}r.focus()}},ht);function ht(){}var vt=(yt.prototype.validate=function(){var a=this;return this.repository.getList().subscribe(function(e){var t,r;try{for(var i=te(e),n=i.next();!n.done;n=i.next())n.value.validate().subscribe(function(e){e.isValid||(alert(e.message),a.validationResults.next(e))})}catch(o){t={error:o}}finally{try{n&&!n.done&&(r=i["return"])&&r.call(i)}finally{if(t)throw t.error}}}),this.validationResults},yt.prototype.validateCurrentRow=function(){var n=this,o=this.repository.entityTypeInfo,e=this.frameContext.bindingData.list.currentId;if(!e)return g.of(!0);var t=this.repository.entityCollection.getEntityById(e);if(!t)return g.of(!0);var r=[t],a=this.frameContext.namespace,i=[];i=null!==a?this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(a):this.frameContext.appContext.frameContextManager.getFrameContexts();var s=this.isInDialog(),c=this.hasOwnVerifyDetailService(),u=this.frameContext.root.viewModel;s&&c&&(u=this.frameContext.getVirtualRootFrameContext().viewModel);var l=!1,p=[];if(i.forEach(function(e){e.form&&e.form.enableValidate&&(l=!0)}),!l||r.length<1)return g.of(!0);u.verifyInformations=[];var d=!0,f=new Map;i.forEach(function(e){var t=e.bindingData.getObject();t&&t.setShowValidationMsg(!0),e.form&&e.form.enableValidate&&(e.form.getValidationRules().forEach(function(e,t){f.has(t)?e.forEach(function(e){return f.get(t).push(e)}):f.set(t,ie(e))}),e.form.setShowValidationMsg(!0),e.form.isFormValid()||(p.push(e.form),d=!1))});var h=r.map(function(e){return n.frameContext.bindingData.list.getIndexById(e.primaryValue),e.validate(undefined,undefined,f,null,n.frameContext)});return v.zip.apply(void 0,ie(h)).pipe(N.tap(function(r){i.forEach(function(a){if(a.form.enableValidate){var s=function(e){e.forEach(function(t){t.children&&t.children.length&&s(t.children);var r={},i="",n=function(e){e&&e.data&&e.data.id?i=e.data.id:e[V.PARENT_CLASS]&&n(e[V.PARENT_CLASS])};n(t.target);var e={path:[],isUdt:!1,isGrid:!1};t.target&&(e=t.target.getPaths()),e.path.join("/"),t.constraints&&Object.keys(t.constraints).forEach(function(e){r[e]={name:t.constraints[e]}});var o=e.path.concat(t.property);a.bindingData.changes.next({type:V.ChangeType.UpdateErrors,id:i,path:o,isUdt:e.isUdt,isGrid:e.isGrid,value:t.value,errors:r})})};if(r.map(function(e){return e.isValid}).filter(function(e){return e}).length===h.length){if(a.bindingData.changes.next({type:V.ChangeType.UpdateErrors,path:[]}),d){var e=a.bindingData.getObject();e&&e.setShowValidationMsg(!1);var t=a.form;t&&t.setShowValidationMsg(!1)}}else r.forEach(function(e){e.isValid?a.bindingData.changes.next({type:V.ChangeType.UpdateErrors,path:[]}):s(e.errors)})}})}),N.switchMap(function(e){var t=!0,r=[];e.forEach(function(e){e.isValid||(t=!1),r.push.apply(r,ie(e.errors))}),0<r.length&&n.collectValidationErrors(u,r,n.frameContext.namespace);var i=u.verifyInformations;return s&&c&&(i=u.verifyInformations.filter(function(e){return e.namespace===a})),u.verifycationChanged.next(i),n.handleErrorClickEvent(),t&&!d&&console.warn("实体和控件校验规则不一致，请确认实体校验规则配置与控件一致。如果配置不一致可能会导致校验失效！"),t?n.validateEntityAllowEmptyRule(o)?g.of(!0):O.EMPTY:y.empty()}))},yt.prototype.validateAll=function(){var n=this,o=this.repository.entityTypeInfo,e=this.repository.entityCollection.getAllEntities(),a=this.frameContext.namespace,t=[];t=null!==a?this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(a):this.frameContext.appContext.frameContextManager.getFrameContexts();var r=!1,i=[];if(t.forEach(function(e){e.form&&e.form.enableValidate&&(r=!0)}),!r||e.length<1)return g.of(!0);var s=this.isInDialog(),c=this.hasOwnVerifyDetailService(),u=this.frameContext.root.viewModel;s&&c&&(u=this.frameContext.getVirtualRootFrameContext().viewModel);var l=!0,p=new Map;t.forEach(function(e){var t=e.bindingData.getObject();t&&t.setShowValidationMsg(!0),e.form&&e.form.enableValidate&&(e.form.getValidationRules().forEach(function(e,t){p.has(t)?e.forEach(function(e){return p.get(t).push(e)}):p.set(t,ie(e))}),e.form.setShowValidationMsg(!0),e.form.isFormValid()||(i.push(e.form),l=!1))});var d=0<e.length,f=e.map(function(e,t){return e.validate(undefined,undefined,p,d?t:null,n.frameContext)});return v.zip.apply(void 0,ie(f)).pipe(N.tap(function(r){t.forEach(function(a){if(a.form.enableValidate){var s=function(e){e.forEach(function(t){t.children&&t.children.length&&s(t.children);var r={},i="",n=function(e){e&&e.data&&e.data.id?i=e.data.id:e[V.PARENT_CLASS]&&n(e[V.PARENT_CLASS])};n(t.target);var e={path:[],isUdt:!1,isGrid:!1};t.target&&(e=t.target.getPaths()),e.path.join("/"),t.constraints&&Object.keys(t.constraints).forEach(function(e){r[e]={name:t.constraints[e]}});var o=e.path.concat(t.property);a.bindingData.changes.next({type:V.ChangeType.UpdateErrors,id:i,path:o,isUdt:e.isUdt,isGrid:e.isGrid,value:t.value,errors:r})})};if(r.map(function(e){return e.isValid}).filter(function(e){return e}).length===f.length){if(a.bindingData.changes.next({type:V.ChangeType.UpdateErrors,path:[]}),l){var e=a.bindingData.getObject();e&&e.setShowValidationMsg(!1);var t=a.form;t&&t.setShowValidationMsg(!1)}}else r.forEach(function(e){e.isValid?a.bindingData.changes.next({type:V.ChangeType.UpdateErrors,path:[]}):s(e.errors)})}})}),N.switchMap(function(e){var t=!0,r=[];e.forEach(function(e){e.isValid||(t=!1),r.push.apply(r,ie(e.errors))}),0<r.length&&n.collectValidationErrors(u,r,n.frameContext.namespace);var i=u.verifyInformations;return s&&c&&(i=u.verifyInformations.filter(function(e){return e.namespace===a})),t&&l&&(i=u.verifyInformations=[]),u.verifycationChanged.next(i),n.handleErrorClickEvent(),t?n.validateEntityAllowEmptyRule(o)?g.of(!0):O.EMPTY:y.empty()}))},yt.prototype.validateEntityAllowEmptyRule=function(e){var i=this,t=this.getNotAllowEmptyBindingPaths(e);if(!t||t.length<1)return!0;var r=t.filter(function(e){var t=e.split("/").filter(function(e){return e}),r=i.frameContext.bindingData.getValue(t);return!r||r.length<1});if(0<r.length){var n=[];return r.forEach(function(e){var t=i.getViewModelNameByBindingPaths(e.split("/"))||"绑定路径"+e;n.push(t)}),this.notifyService&&this.notifyService.error(n.join("，")+" "+this.languageService.tableCanNotEmpty,{hideTitle:!0}),!1}return!0},yt.prototype.getViewModelNameByBindingPaths=function(e){var t=this.frameContext.namespace,r=null;r=null!==t?this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(t):this.frameContext.appContext.frameContextManager.getFrameContexts();var i=e.filter(function(e){return e}).join("/"),n=r.find(function(e){return e.viewModel&&e.viewModel.bindingPath.split("/").filter(function(e){return e}).join("/")===i});return n&&n.form&&n.form.formGroupName||""},yt.prototype.getNotAllowEmptyBindingPaths=function(e,t){if(void 0===t&&(t=[]),e)return this.deepFirstTraversalEntityTypeInfo(e,t),t},yt.prototype.deepFirstTraversalEntityTypeInfo=function(e,r,i){var n=this;void 0===r&&(r=[]),void 0===i&&(i=[]),!1===this.isAllowEmpty(e.entityInfo.allowEmpty,i)&&(i.length<1?r.push(""):r.push(i.join("/")));var t=e.getPropInfosByGroup(V.DataPropGroup.List);t&&0<t.length&&t.forEach(function(e){var t=e.typeInfo;t&&t.entityInfo&&(i.push(t.entityInfo.nodeCode),n.deepFirstTraversalEntityTypeInfo(t,r,i))}),i&&0<i.length&&i.pop()},yt.prototype.isAllowEmpty=function(e,t){if(e===undefined||!0===e||""===e)return!0;var r=this.getFrameContextByBindingPath(t),i=this.frameContext.frameComponent;return!r||r.length<1?console.warn("绑定路径 "+t.join("/")+" 定义了不能为空的规则，但找不到该绑定路径对应的组件。请确保组件显隐与必填一致。"):i=r.pop().frameComponent,"boolean"==typeof e?e:"string"==typeof e?(e=e.trim().startsWith("return")?e:"return "+e,new Function("\n        var viewModel = this.viewModel;\n        var bindingData = this.bindingData;\n        var context = this.context;\n        "+e+"\n      ").apply(i)):void console.warn("无效的必填规则。")},yt.prototype.collectValidationErrors=function(a,e,s,t){var c=this;void 0===t&&(t=!0),t&&(a.verifyInformations=a.verifyInformations.filter(function(e){return e.namespace!==s})),e.forEach(function(e){e.children&&e.children.length&&c.collectValidationErrors(a,e.children,s,!1);var t="",r=function(e){e&&e.data&&e.data.id?t=e.data.id:e[V.PARENT_CLASS]&&r(e[V.PARENT_CLASS])};if(r(e.target),e.constraints){var i=Object.keys(e.constraints);if(i.length){var n=a.verifyInformations.filter(function(e){return e.namespace===s}).length,o=a.verifyInformations.findIndex(function(e){return e.namespace===s});o=-1===o?0:o+n,a.verifyInformations.splice(o,0,{id:t,namespace:s,targetField:e.field,index:e.index,title:e.propertyName,msg:e.constraints[i[0]],frameContext:e.frameContext,fullPath:e.fullPath,type:"required"===i[0]?"empty":"error"})}}})},yt.prototype.resetValidation=function(){var e=this.isInDialog(),t=this.frameContext.root.viewModel;e&&(t=this.frameContext.getVirtualRootFrameContext().viewModel);var r=t.verifyInformations;if(r.length){var i=this.frameContext.namespace;null!==i&&(r=t.verifyInformations.filter(function(e){return e.namespace!==i})),t.verifyInformations=r}return t&&t.verifycationChanged&&t.verifycationChanged.next(r),g.of(null)},yt.prototype.isInDialog=function(){return this.frameContext&&this.frameContext.getVirtualRootFrameContext()&&this.frameContext.getVirtualRootFrameContext().frameComponent&&this.frameContext.getVirtualRootFrameContext().frameComponent.isDialogRootComponent||!1},yt.prototype.hasOwnVerifyDetailService=function(){return this.frameContext.injector.get(o.VerifyDetailService,null)!==this.frameContext.root.appContext.injector.get(o.VerifyDetailService,null)},yt.prototype.getFrameContextByBindingPath=function(e){var t=e.filter(function(e){return e}).join("/");return this.frameContext.appContext.frameContextManager.getFrameContexts().filter(function(e){return e.viewModel.bindingPath.split("/").filter(function(e){return e}).join("/")===t})},Object.defineProperty(yt.prototype,"verifyDetailService",{get:function(){return this.frameContext.injector.get(o.VerifyDetailService,null,k.InjectFlags.Self)},enumerable:!0,configurable:!0}),yt.prototype.handleErrorClickEvent=function(){var t=this;this.verifyDetailService&&this.verifyDetailService.verifyContainer&&this.verifyDetailService.verifyContainer.instance&&this.verifyDetailService.verifyContainer.instance.validatorClick.subscribe(function(e){t.onErrorItemClick(e)})},yt.prototype.onErrorItemClick=function(e){void 0===e&&(e={frameContext:null,id:null,targetField:null,fullPath:null});var t=e.frameContext,r=e.id,i=e.targetField;if(e.fullPath,t&&t.frameComponent.isGridComponent){var n=t.componentRefManager.getComponentByType(u.DatagridComponent);n&&i&&r&&(n.editCell(r,i),this.verifyDetailService.verifyContainer.instance.showList=!1)}else{var o=t.injector.get(k.ElementRef,null,k.InjectFlags.Self)||t.injector.get(k.ElementRef,null);ft.focusElement(i,o),this.verifyDetailService.verifyContainer.instance.showList=!1}},yt.decorators=[{type:k.Injectable}],yt.ctorParameters=function(){return[{type:V.Repository},{type:V.FrameContext},{type:Te,decorators:[{type:k.Optional}]},{type:$,decorators:[{type:k.Optional}]}]},yt);function yt(e,t,r,i){this.repository=e,this.frameContext=t,this.notifyService=r,this.languageService=i,this.validationResults=new O.Subject,this.validationAllResult=new O.Subject,this.languageService||(this.languageService=new $)}var gt=(mt.hasChange=function(e){var t=e&&e.repository;if(w.BefRepositoryUtil.isExistUnsaveData(t))return O.of(!0);var r=e&&e.getVirtualRootFrameContext();return r&&r.enableServerSideChangeDetection?e.repository.hasChanges().pipe(N.map(function(e){return e.returnValue})):O.of(!1)},mt);function mt(){}var St=(Ct.prototype.load=function(e){var t=this,r=this.loadingService.showLoadingWithDelay(500);return this.frameContext.appContext.params.set("retrieveing",!0),this.frameContext.appContext.params["delete"]("queryChild"),this.repository.getById(e).pipe(N.tap(function(){t.loadingService.hideDelayLoading(r)},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.loadFailed,e)}))},Ct.prototype.onLoading=function(v){var y=this,e=this.runtimeFrameworkService&&this.runtimeFrameworkService.tabId||null;if(e){var g=!0,t=this.frameContext.appContext.params.get(e)||!1;v=v||"transitionAction",t||(this.frameContext.appContext.params.set(e,!0),this.runtimeFrameworkService.getEntityParam(e,function(e){if(g)g=!1;else{var t=y.parseParams(e);if(t&&t.sync){var r=t.action,i=t.id,n=y.frameContext&&y.frameContext.viewModel&&y.frameContext.viewModel.metadatas&&y.frameContext.viewModel.metadatas[r],o=n.params&&n.params[v]||null,a=y.frameContext.bindingData.list.currentId,s=y.frameContext.stateMachine.context.state,c=null,u=void 0;if(o){var l=y.frameContext&&y.frameContext.stateMachine&&y.frameContext.stateMachine.metadatas&&y.frameContext.stateMachine.metadatas.actions&&y.frameContext.stateMachine.metadatas.actions[o];if(c=l&&l.transitTo||s,(u=y.frameContext&&y.frameContext.stateMachine&&y.frameContext.stateMachine.metadatas&&y.frameContext.stateMachine.metadatas&&y.frameContext.stateMachine.metadatas.states[c]&&y.frameContext.stateMachine.metadatas.states[c].name||y.languageService.defaultStateName)&&u.startsWith("{{")&&u.endsWith("}}")){var p=u.replace("{{","").replace("}}","");u=y.frameContext.translate.transform(p,null)}}else c=s;var d=a!==i,f=s!==c;if(d&&f){var h=y.languageService.dataAndStateChanged.replace(/\$1/g,u);y.showLoadingConfirm(h).pipe(N.switchMap(function(){return y.resetForm(r)})).subscribe()}else if(d)y.showLoadingConfirm(y.languageService.dataChanged).pipe(N.switchMap(function(){return y.resetForm(r)})).subscribe();else{if(!f)return O.of(!0);h=y.languageService.stateChanged.replace(/\$1/g,u),y.showLoadingConfirm(h).pipe(N.switchMap(function(){return y.resetForm(r)})).subscribe()}}}},!1))}},Ct.prototype.add=function(){var t=this,e=this.bindingData.list.currentId,r=this.loadingService.showLoadingWithDelay(500);return this.repository.create().pipe(N.tap(function(){st.setEditState(t.frameContext,e),t.loadingService.hideDelayLoading(r)},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.addFailed,e)}))},Ct.prototype.cascadeAdd=function(){var i=this,e=new O.Subject,t=this.frameContext.appContext.frameContextManager.getFrameContexts(),r=this.frameContext.getVirtualRootFrameContext().namespace,n=t.filter(function(e){return e.namespace===r})||[],o=[];if(n&&0<n.length){var a=n.filter(function(e){return e.viewModel.bindingPath&&"/"!==e.viewModel.bindingPath});if(a&&0<a.length){var s=a.map(function(e){return e.viewModel.bindingPath});(s=s.filter(function(e,t){return s.indexOf(e)===t}))&&0<s.length&&(o=s.map(function(e){return e.split("/").filter(function(e){return e})}).sort(function(e,t){return e.length-t.length}))}}return this.loadingService.show(),this.repository.create().pipe(N.switchMap(function(e){var r=e.primaryValue;return o&&0<o.length?O.from(o).pipe(N.concatMap(function(e){var t=i.getPath(i.frameContext.viewModel,"/"+e.join("/"),r);return i.repository.appendByPath(t)})):O.of(e)})).pipe(N.last()).subscribe(function(){i.loadingService.hide(),e.next()},function(e){i.loadingService.hide(),i.formErrorService.exception(i.languageService.addFailed,e)}),e},Ct.prototype.edit=function(e){var t=this;return this.update().pipe(N.tap(function(){var e=t.bindingData.list.currentId;st.setEditState(t.frameContext,e)}))},Ct.prototype.update=function(e){var t=this;if(!(e=this.bindingData.list.currentId))return O.empty();var r=this.loadingService.showLoadingWithDelay(500),i=this.repository.updateById(e);return this.frameContext.appContext.params.set("retrieveing",!0),i.pipe(N.tap(function(){t.loadingService.hideDelayLoading(r)},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.updateFailed,e)}))},Ct.prototype.updateWithoutEmpty=function(){return this.bindingData.list.currentId?this.update():O.of(null)},Ct.prototype.checkBeforeUpdate=function(){var e=this.frameContext.bindingData.list;return e&&e.currentId?O.of(!0):(this.formNotifyService.warning(this.languageService.noDataExist,{hideTitle:!0}),O.EMPTY)},Ct.prototype.updateWithNotify=function(){return this.bindingData.list.currentId?this.update():(this.formNotifyService.warning(this.languageService.noDataExist,{hideTitle:!0}),O.EMPTY)},Ct.prototype.loadPaged=function(e,t){var r=this;if(!this.bindingData.list.currentId)return O.EMPTY;var i=this.loadingService.showLoadingWithDelay(500);return O.of(null).pipe(N.tap(function(){r.loadingService.hideDelayLoading(i)},function(e){r.loadingService.hideDelayLoading(i),r.formErrorService.exception(r.languageService.updateFailed,e)}))},Ct.prototype.save=function(r){var i=this,n=this.bindingData.list.currentId;if(!n)return O.of(!1);var o=this.loadingService.showLoadingWithDelay(500),e=this.repository.updateChangesById(n),t=this.repository.applyChangesById(n);return e.pipe(N.switchMap(function(e){return!1===e?O.of(!1):t}),N.tap(function(){if(st.setEditState(i.frameContext,n),i.loadingService.hideDelayLoading(o),r&&r.trim()){var e=!0;if(r.startsWith("{")&&r.endsWith("}"))try{!1===JSON.parse(r).showMessage&&(e=!1)}catch(t){}!1!==e&&i.formNotifyService.success(r,{hideTitle:!0})}else ut.success(i.formNotifyService,i.languageService.saveSuccess)},function(e){i.loadingService.hideDelayLoading(o),i.formErrorService.exception(i.languageService.saveFailed,e)}))},Ct.prototype.cancel=function(){return this.cancelWithCheck()},Ct.prototype.revert=function(e){return this.cancelWithoutCheck(e)},Ct.prototype.cancelWithCheck=function(){var t=this;return gt.hasChange(this.frameContext).pipe(N.switchMap(function(e){return e?t.formMessageService.question(t.languageService.cancelWithoutSave).pipe(N.switchMap(function(e){return!1===e?O.EMPTY:t.cancelChanges()})):t.cancelChanges()}))},Ct.prototype.cancelWithoutCheck=function(e){return this.cancelChanges(e)},Ct.prototype.cancelChanges=function(e){var t=this,r=this.loadingService.showLoadingWithDelay(500);return this.repository.cancelChanges(e).pipe(N.tap(function(){st.setEditState(t.frameContext,""),t.loadingService.hideDelayLoading(r)},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.cancelFailed,e)}))},Ct.prototype.reload=function(){var e;if(e=!0===st.getAddState(this.frameContext)?st.getLastModifiedId(this.frameContext):this.bindingData.list.currentId)return this.load(e);this.repository.entityCollection.loadEntities([])},Ct.prototype.getPath=function(e,t,r){var i="/"+r,n=t.split("/");if(0<n.length)for(var o=1;o<n.length-1;o++){var a=n[o],s=e.bindingData[a];if(!s||!s.currentId)throw Error("获取子表完整路径出错，找不到"+s+"对应的子表，或对应子表没有当前行。");i+="/"+a+"/"+s.currentId}return i+="/"+n[n.length-1]},Ct.prototype.resetForm=function(e){var t=this,r=this.frameContext.injector.get(vt,null);return this.frameContext.repository.cancelChanges().pipe(N.switchMap(function(){return t.commandService.execute(e).pipe(N.switchMap(function(){return r&&r.resetValidation()||O.of(null)}))}))},Ct.prototype.parseParams=function(e){if(e&&"[object Map]"===Object.prototype.toString.call(e)){var t=e.get("WEB_FORM_ROUTE_PARAMS");if(t&&"string"==typeof t)return(t=decodeURIComponent(t)).startsWith("{")&&t.endsWith("}")&&(t=JSON.parse(t)),{action:t.action,id:t.idToView||t.idToEdit||t.id,sync:t.sync||!1}}return null},Ct.prototype.showLoadingConfirm=function(e){return this.formMessageService.confirm(e).pipe(N.switchMap(function(e){return!0===e?O.of(!0):O.EMPTY}))},Ct.decorators=[{type:k.Injectable}],Ct.ctorParameters=function(){return[{type:Fe},{type:V.FrameContext},{type:W},{type:Te},{type:$,decorators:[{type:k.Optional}]},{type:Pe},{type:Ge},{type:pt}]},Ct);function Ct(e,t,r,i,n,o,a,s){this.formMessageService=e,this.frameContext=t,this.loadingService=r,this.formNotifyService=i,this.languageService=n,this.formErrorService=o,this.runtimeFrameworkService=a,this.commandService=s,n||(this.languageService=$.getInstance()),this.repository=this.frameContext.repository,this.bindingData=this.frameContext.bindingData}var bt=(It.prototype.onClosing=function(){var i=this;this.isInDialog()||this.navigationService.addEventListener(He.onTabClosing,function(r){return!i.frameContext||i.frameContext.isDisposed?O.of(!0):i.isChanged.pipe(N.switchMap(function(e){if(!e||i.appContext.opened)return e&&i.appContext.opened?O.of(!1):O.of(!0);r&&r.beforeCloseHandle&&"function"==typeof r.beforeCloseHandle&&r.beforeCloseHandle({selectedChange:!0});var t=i.msgService.question(i.languageService.exitWithoutSave);return i.appContext.opened=!0,t.pipe(N.switchMap(function(e){return i.appContext.opened=!1,e&&i.cardDataService?i.cardDataService.revert(r).pipe(N.switchMap(function(){return O.of(e)})):O.of(e)}))}))})},It.prototype.isInDialog=function(){for(var e=this.frameContext,t=e.frameComponent.isDialogRootComponent||!1;null!==e.parent&&!t;)t=(e=e.parent).frameComponent.isDialogRootComponent;return t=t||this.frameContext.injector.get(Ke,!1)},It.prototype.getTabId=function(e,t){if(t)return t;var r=null;return e&&e.startsWith("{")&&e.endsWith("}")&&(r=JSON.parse(e)),r&&r.hasOwnProperty("id")&&r.id?r.id:V.UID.create()},Object.defineProperty(It.prototype,"isChanged",{get:function(){return gt.hasChange(this.frameContext).pipe(N.throwIfEmpty(function(){return O.EMPTY}))},enumerable:!0,configurable:!0}),It.decorators=[{type:k.Injectable}],It.ctorParameters=function(){return[{type:it},{type:V.FrameContext},{type:Fe},{type:$,decorators:[{type:k.Optional}]},{type:St}]},It);function It(e,t,r,i,n){this.navigationService=e,this.frameContext=t,this.msgService=r,this.languageService=i,this.cardDataService=n,this.repository=t.repository,this.languageService||(this.languageService=$.getInstance()),this.frameContext&&(this.appContext=this.frameContext.getFormAppContext()||null)}var wt=(xt.prototype.onPageChanging=function(){return this.isChanged?this.msgService.question(this.languageService.gridDataNotSave).pipe(N.switchMap(function(e){return e?O.of(!0):O.EMPTY})):O.of(!0)},xt.prototype.filter=function(e,t){var r=this.context&&this.context.eventParam||[];return"string"==typeof r&&(r=JSON.parse(r)),this.viewModel.frameContext.repository.entityCollection.pageIndex=1,this.viewModel.frameContext.repository.filterConditionManager.setConditions(this.viewModel.bindingPath,r),this.commandService.execute(e,t)},Object.defineProperty(xt.prototype,"isChanged",{get:function(){var e=this.repository;return w.BefRepositoryUtil.isExistUnsaveData(e)},enumerable:!0,configurable:!0}),xt.decorators=[{type:k.Injectable}],xt.ctorParameters=function(){return[{type:V.FrameContext},{type:Fe},{type:$,decorators:[{type:k.Optional}]},{type:V.ViewModel},{type:pt}]},xt);function xt(e,t,r,i,n){this.frameContext=e,this.msgService=t,this.languageService=r,this.viewModel=i,this.commandService=n,this.repository=this.frameContext.repository,this.languageService||(this.languageService=$.getInstance())}var Et=(Object.defineProperty(Pt.prototype,"params",{get:function(){var i=this,e=window.location.hash,n=this.querystringService.parse(e),t=n.tabId;if(!t)return O.of(n);var o=new O.Subject;return this.runtimeFrameworkService.addEventListener(t,function(e){var t={};(e instanceof Map||e&&"function"==typeof e.get&&"function"==typeof e.entries)&&(t=i.parseMapParams(e));var r={};r=e instanceof Map||e&&"function"==typeof e.get&&"function"==typeof e.entries?new Map(e):Object.assign({},e),setTimeout(function(){o.next(Object.assign({},r,t,n))},0)},n),o.asObservable()},enumerable:!0,configurable:!0}),Pt.prototype.parseMapParams=function(e){var r={};return r.WEB_FORM_ROUTE_PARAMS=decodeURIComponent(e.get("WEB_FORM_ROUTE_PARAMS")),e.forEach(function(e,t){"WEB_FORM_ROUTE_PARAMS"!==t&&(r[t]=e)}),r},Pt.prototype.get=function(t){return this.params.pipe(N.switchMap(function(e){return e&&e.hasOwnProperty(t)?O.of(e.param):O.of(undefined)}))},Pt.prototype.parse=function(){return this.params.pipe(N.switchMap(function(e){return O.of(e)}))},Pt.decorators=[{type:k.Injectable}],Pt.ctorParameters=function(){return[{type:Je},{type:Ge}]},Pt);function Pt(e,t){this.querystringService=e,this.runtimeFrameworkService=t}var Dt=(Ft.prototype.bind=function(r){var i=this;r.keybindingMap.forEach(function(e,t){i.register(e,function(){return r[t]()})})},Ft.prototype.register=function(e,t){var r=this._getCombo(e);r&&(this.keyMap.set(r,t),e.ctrlKey&&e.altKey&&!e.shiftKey?this.bindingProvider.bind(r,this._dispatch.bind(this),"keyup"):this.bindingProvider.bind(r,this._dispatch.bind(this)))},Ft.prototype.unregister=function(e){var t=this._getCombo(e);t&&(this.keyMap["delete"](t),this.bindingProvider.unbind(t))},Ft.prototype._dispatch=function(e){var t=this;if(e.repeat)return!1;if(this.ready){var r=this._getCombo(e);r&&this.keyMap.has(r)&&(this.ready=!1,this.keyMap.get(r)().subscribe(function(){t.ready=!0},function(e){t.ready=!0},function(){t.ready=!0}))}return!1},Ft.prototype._getCombo=function(e){var t=e.key.toLowerCase();if(1!=t.length||t.charCodeAt(0)<97||122<t.charCodeAt(0))return console.warn("快捷键字母形式为a-z"),null;var r=(e.ctrlKey?"ctrl+":"")+(e.shiftKey?"shift+":"")+(e.altKey?"alt+":"")+(e.metaKey?"meta+":"")+t;return 1==r.length?(console.warn("快捷键至少包含一个Modifier键"),null):r},Ft.decorators=[{type:k.Injectable}],Ft.ctorParameters=function(){return[]},Ft);function Ft(){this.keyMap=new Map,this.bindingProvider=_,this.ready=!0}var Mt=(Tt.decorators=[{type:k.Injectable}],Tt);function Tt(){}var Rt=(Ot.prototype.getState=function(e,t){throw new Error("Not Implemented")},Ot.prototype.setState=function(e,t,r){throw new Error("Not Implemented")},Ot.decorators=[{type:k.Injectable}],Ot.ctorParameters=function(){return[]},Ot);function Ot(){}var Nt=(At.prototype.transit=function(e){if(e&&"function"==typeof this.stateMachine[e]){if(this.stateMachine[e](),this._currentFrameContext=this.context&&this.context.frameContext,this._initLoad&&(this.initFormState(),this._initLoad=!1),!this._currentFrameContext)return;var t=this.getCurrentRootFrameContext(this._currentFrameContext);t&&this.toggleFormState(e,t)}},At.prototype.getCurrentRootFrameContext=function(t){var r;return this.getAllRootFrameContext().forEach(function(e){t.namespace===e.namespace&&(r=e)}),r},At.prototype.getFrameContextManagerMap=function(){if(this.stateMachine&&this.stateMachine.frameContext){var e=this.stateMachine.frameContext.appContext;if(e)return e.frameContextManager.getFrameContextMap()}return null},At.prototype.getAllRootFrameContext=function(){var t=[],e=this.getFrameContextManagerMap();return e&&e.forEach(function(e){(""===e.namespace&&null===e.parent||null!==e.parent&&e.namespace!==e.parent.namespace)&&t.push(e)}),t},At.prototype.initFormState=function(){var r=this;this.getFrameContextManagerMap()&&this.getAllRootFrameContext().forEach(function(e){var t=e.injector.get(k.ElementRef,null)||null;t&&t.nativeElement&&(t.nativeElement.className.includes(r._clsDefaultName)||t.nativeElement.className.includes("f-form-state-create")||t.nativeElement.className.includes("f-form-state-edit")||r.addCssClass(t,r._clsDefaultName))})},At.prototype.toggleFormState=function(e,t){var r=this,i=t.injector.get(k.ElementRef,null)||null;i&&i.nativeElement&&e&&((e=e.toLowerCase())&&["create","edit"].includes(e)?("create"===e?this.addCssClass(i,"f-form-state-create"):"edit"===e&&this.addCssClass(i,"f-form-state-edit"),this.removeCssClass(i,this._clsDefaultName)):(["f-form-state-create","f-form-state-edit"].forEach(function(e){return r.removeCssClass(i,e)}),this.addCssClass(i,this._clsDefaultName)))},At.prototype.addCssClass=function(e,t){if(e&&t&&e.nativeElement){var r=e.nativeElement.className||"";r.includes(t)||(e.nativeElement.className=r+" "+t)}},At.prototype.removeCssClass=function(e,t){if(e&&t&&e.nativeElement){var r=e.nativeElement.className||"";r.includes(t)&&(e.nativeElement.className=r.split(" ").filter(function(e){return e&&e!==t}).join(" "))}},At.prototype.getFormRootComponent=function(){if(this.stateMachine&&this.stateMachine.frameContext){var e=this.stateMachine.frameContext;if(e){var t=e.getVirtualRootFrameContext();if(t){var r=t.injector;if("function"==typeof r.get)return r.get(k.ElementRef,null)}}}return null},At.decorators=[{type:k.Injectable}],At.ctorParameters=function(){return[{type:V.StateMachine}]},At);function At(e){var t=this;this.stateMachine=e,this._clsDefaultName="f-form-state-default",this._initLoad=!0,"init"===this.stateMachine.initialState.name&&window.setTimeout(function(){t.initFormState()},0)}var jt=(Bt.prototype.setCurrentId=function(t,e){Array.from(this.appContext.getAllFrameContexts().values()).forEach(function(e){e.bindingData.list.setCurrentId(t,!0,!1)})},Bt.prototype.setCurrentRow=function(e,t){var r=this.bindingData;t&&(r=this.appContext.getFrameContext(t).bindingData),r.getList().setCurrentId(e)},Bt.decorators=[{type:k.Injectable}],Bt.ctorParameters=function(){return[{type:V.BindingData},{type:V.AppContext}]},Bt);function Bt(e,t){this.bindingData=e,this.appContext=t}var Lt=(kt.prototype.parseParams=function(e,t,r,i){var n=this,o=this.highOrderInvoke(i);this.paramService?this.paramService.parse().pipe(N.take(1)).subscribe(function(e){n.params=e,n.setupParams(e,t,r,o)}):e.queryParams.pipe(N.take(1)).subscribe(function(e){n.params=e,n.setupParams(e,t,r,o)})},kt.prototype.setupParams=function(e,t,r,i){r&&r.frameContext&&r.frameContext.appContext&&e.tabId&&(r.frameContext.appContext.tabId=e.tabId);var n=this.getParams(e);if(n){this.setQueryParams(n,r);var o=this.getFuncId(n),a=this.getAppId(n);(o||a)&&o?this.setStaticParams(o,n,t,r,i):i()}else i()},kt.prototype.setQueryParams=function(t,e){var r={},i=this.isInDialog(e),n=e&&e.uiState&&e.uiState.innerData||{};Object.keys(t).forEach(function(e){i&&n.hasOwnProperty(e)||(r[e]=t[e])}),this.updateUIState(e,r)},kt.prototype.setStaticParams=function(e,r,t,i,n){var o=this;this.runtimeFrameworkService.getMenuParams(e,function(e){var t=o.mapStaticParamsToObject(e,r,i);t&&o.updateUIState(i,t),n()})},kt.prototype.mapStaticParamsToObject=function(e,i,t){if(e){var n=this.isInDialog(t),o=t&&t.uiState&&t.uiState.innerData||{},a={};return e.forEach(function(e,t,r){n?i.hasOwnProperty(t)||o.hasOwnProperty(t)||(a[t]=e):i.hasOwnProperty(t)||(a[t]=e)}),a}},kt.prototype.isInDialog=function(e){var t=!1;return e&&e.uiState&&(e.uiState.innerData&&e.uiState.innerData.hasOwnProperty("DEVKIT_DIALOG")||e.uiState.DEVKIT_DIALOG)&&(t=!0),t},kt.prototype.updateUIState=function(r,i){var n=this;if(r&&i){var o=r.uiState;"string"==typeof i&&""!==i&&(i=JSON.parse(i)),Object.keys(i).forEach(function(e){if(o.setPropertyValue(e,i[e]),e&&"union_session"===e){var t=i[e];n.setSessionInfo(r,t)}})}},kt.prototype.setSessionInfo=function(e,t){if(e&&t){t&&"string"==typeof t&&t.startsWith("{")&&t.endsWith("}")&&(t=JSON.parse(t));var r=t&&t.token||null,i=t&&t.sessionId||null;if(r&&(e.frameContext.appContext.Token=r),i){var n=e.frameContext.repository;n&&n.restService.sessionService.setBeSessionId(i)}}},kt.prototype.getFuncId=function(e){if(e)return e.funcId},kt.prototype.getAppId=function(e){if(e)return e.appId},kt.prototype.getTabId=function(e){if(e)return e.tabId},kt.prototype.getParams=function(t){if(!t)return{};var r={};if(t.hasOwnProperty("WEB_FORM_ROUTE_PARAMS")){var e=t.WEB_FORM_ROUTE_PARAMS;return e&&e.startsWith("{")&&e.endsWith("}")&&(e=decodeURI(encodeURI(e).replace(/%0A/g,"\\n").replace(/%09/g,"\\t").replace(/%0D/g,"\\r")),r=JSON.parse(e)),Object.keys(t).forEach(function(e){"WEB_FORM_ROUTE_PARAMS"!==e&&(r[e]=t[e])}),r}return t},kt.prototype.highOrderInvoke=function(i){var n=this;return function(){try{var e=n.getParams(n.params);if(n.getTabId(e)){var t=n.runtimeFrameworkService.getMenuSwitchControlEvent();t&&O.isObservable(t)&&t.subscribe(function(e){e&&e.next("ok")})}}catch(r){console.warn(r)}i&&"function"==typeof i&&i()}},kt.decorators=[{type:k.Injectable}],kt.ctorParameters=function(){return[{type:Et,decorators:[{type:k.Optional}]},{type:Ge,decorators:[{type:k.Optional}]}]},kt);function kt(e,t){this.paramService=e,this.runtimeFrameworkService=t,this.runtimeFrameworkService||(this.runtimeFrameworkService=new Ge)}var Vt=(Object.defineProperty(_t.prototype,"bindingData",{get:function(){return this.frameContext.bindingData},enumerable:!0,configurable:!0}),_t.prototype.getPropValue=function(e){return this.bindingData.getValue(e)},_t.prototype.getEntityData=function(e){var t=this.bindingData.getValue(e);return(t instanceof V.BindingList==1?t.currentItem:t).toJSON()},_t.prototype.getEntityListData=function(e){return this.bindingData.getValue(e).toJSON()},_t.decorators=[{type:k.Injectable}],_t.ctorParameters=function(){return[{type:V.FrameContext}]},_t);function _t(e){this.frameContext=e}var qt=(Object.defineProperty(Ut.prototype,"bindingData",{get:function(){return this.frameContext.bindingData},enumerable:!0,configurable:!0}),Ut.prototype.setPropValue=function(e,t){this.bindingData.setValue(e,t,!0,!0)},Ut.decorators=[{type:k.Injectable}],Ut.ctorParameters=function(){return[{type:V.FrameContext}]},Ut);function Ut(e){this.frameContext=e}var Wt=(Object.defineProperty(Ht.prototype,"bindingData",{get:function(){return this.frameContext.bindingData},enumerable:!0,configurable:!0}),Ht.prototype.count=function(e){var t=this.splitPath(e);return this.traversingService.getEntityListData(t.listPath).length},Ht.prototype.sum=function(e){var i=this,n=this.splitPath(e);return this.traversingService.getEntityListData(n.listPath).reduce(function(e,t){var r=parseFloat(i.getPropValue(t,n.propPath));return e+=r=isNaN(r)?0:r},0)},Ht.prototype.avg=function(e){var t=this.count(e),r=this.sum(e);return 0!==t?r/t:0},Ht.prototype.max=function(e){var i=this,n=this.splitPath(e),t=this.traversingService.getEntityListData(n.listPath).reduce(function(e,t){var r=parseFloat(i.getPropValue(t,n.propPath));return!1===isNaN(r)&&(!e||e<r)&&(e=r),e},null);return t||0},Ht.prototype.min=function(e){var i=this,n=this.splitPath(e),t=this.traversingService.getEntityListData(n.listPath).reduce(function(e,t){var r=parseFloat(i.getPropValue(t,n.propPath));return!1===isNaN(r)&&(!e||r<e)&&(e=r),e},null);return t||0},Ht.prototype.getPropValue=function(e,t){var r=e;return t.forEach(function(e){r=r?r[e]:null}),r},Ht.prototype.splitPath=function(e){for(var t=e.concat([]),r=[],i=this.bindingData.getValue(t);i instanceof V.BindingList!=1;){var n=t.pop();if(!n)return;r.unshift(n),i=this.bindingData.getValue(t)}return{listPath:t,propPath:r}},Ht.decorators=[{type:k.Injectable}],Ht.ctorParameters=function(){return[{type:V.FrameContext}]},Ht);function Ht(e){this.frameContext=e,this.traversingService=this.frameContext.injector.get(Vt)}var Kt=(Object.defineProperty(zt.prototype,"pageIndex",{get:function(){return this.bindingData.list.pageIndex},enumerable:!0,configurable:!0}),Object.defineProperty(zt.prototype,"pageSize",{get:function(){return this.bindingData.list.pageSize},enumerable:!0,configurable:!0}),zt.decorators=[{type:k.Injectable}],zt.ctorParameters=function(){return[{type:V.BindingData}]},zt);function zt(e){this.bindingData=e}var Jt=(Yt.prototype.getPropValue=function(e){return this.traversingService.getPropValue(e)},Yt.prototype.setPropValue=function(e,t){return this.manipulationService.setPropValue(e,t)},Yt.prototype.getEntityData=function(e){return this.traversingService.getEntityData(e)},Yt.prototype.getEntityListData=function(e){return this.traversingService.getEntityListData(e)},Yt.prototype.count=function(e){return this.aggregationService.count(e)},Yt.prototype.sum=function(e){return this.aggregationService.sum(e)},Yt.prototype.avg=function(e){return this.aggregationService.avg(e)},Yt.prototype.max=function(e){return this.aggregationService.max(e)},Yt.prototype.min=function(e){return this.aggregationService.min(e)},Yt.decorators=[{type:k.Injectable}],Yt.ctorParameters=function(){return[{type:V.FrameContext}]},Yt);function Yt(e){this.frameContext=e;var t=this.frameContext.injector;this.traversingService=t.get(Vt),this.manipulationService=t.get(qt),this.aggregationService=t.get(Wt)}var Gt=($t.prototype.getBindingPathsByFrameContext=function(e){return e&&e.viewModel&&e.viewModel.bindingPath&&e.viewModel.bindingPath.split("/").filter(function(e){return e})||null},$t.prototype.getBindingPathsByTableName=function(e,t,r,i){if(void 0===r&&(r=[]),void 0===i&&(i=0),i++,e.entityInfo&&(e.entityInfo.nodeCode===t||e.entityInfo.originalCode===t))return 1!==i&&r.push(e.entityInfo.nodeCode),r;var n=Array.from(e.propInfoMap.values()).filter(function(e){return e.typeInfo});if(n.length<1)return r=[];e.entityInfo&&1!==i&&r.push(e.entityInfo.nodeCode);for(var o=0;o<n.length;o++){var a=n[o].typeInfo,s=this.getBindingPathsByTableName(a,t,r,i);if(s&&!(s.length<1))return r=r.concat(s)}return null},$t.prototype.getBindingPathsByPath=function(e,t){var r=[];for("string"==typeof e&&(e=e.split("/").filter(function(e){return e})),e=e.concat([]);0<e.length;){if("List"===t.getPropInfoByPath(e).group){r=e;break}e.pop()}return r},$t.prototype.getPathInfo=function(e){var t=e.split("/").filter(function(e){return e}),r=this.getBindingPathsByPath(t,this.repository.entityTypeInfo),i=t.slice(r.length).join("/");return{bindingPath:r.join("/"),propertyName:i,bindingPaths:r,propertyNames:i.split("/").filter(function(e){return e})}},$t.decorators=[{type:k.Injectable}],$t.ctorParameters=function(){return[{type:k.Injector},{type:V.AppContext},{type:V.Repository}]},$t);function $t(e,t,r){this.injector=e,this.appContext=t,this.repository=r}var Qt=(Xt.prototype.getFormControlsByFrameContext=function(e){return e&&e.form&&e.form.ngFormControls||null},Xt.prototype.getFormControlByBinding=function(e,t){var r=this.getFormControlsByFrameContext(e);return r?Object.values(r).find(function(e){return e&&e.binding===t}):null},Xt.prototype.getFormControlIndexByFullPath=function(i,e){var t=this.getFormControlsByFrameContext(i);if(!t)return null;var n=e.split("/").filter(function(e){return e});return Object.values(t).findIndex(function(e){if(!e)return!1;var t=i.viewModel.bindingPath.split("/").filter(function(e){return e}),r=e.binding.split(".").filter(function(e){return e});return t.concat(r).join("/")===n.join("/")})},Xt.prototype.getFormControlIndexByBinding=function(e,t){var r=this.getFormControlsByFrameContext(e);return r?Object.values(r).findIndex(function(e){return e&&e.binding===t}):null},Xt.decorators=[{type:k.Injectable}],Xt.ctorParameters=function(){return[]},Xt);function Xt(){}var Zt=(er.prototype.getFrameContextsByTableName=function(e){if(!e)throw new Error("tableName 不能为空。");var t=this.repository&&this.repository.entityTypeInfo||null;if(!t)return null;var r=[];this.bindingPathService.getBindingPathsByTableName(t,e,r);var i=this.appContext&&this.appContext.frameContextManager.getFrameContexts()||[];return i&&0!==i.length?i.filter(function(e){return e&&e.viewModel&&e.viewModel.bindingPath.split("/").filter(function(e){return e}).join("/")===r.join("/")}):null},er.prototype.getFrameContextsByPropertyPath=function(a,s){if(void 0===s&&(s="/"),!a)throw new Error("propertyPath 不能为空。");return(this.appContext&&this.appContext.frameContextManager.getFrameContexts()||[]).filter(function(e){var n=e&&e.form&&e.form.ngFormControls||{},o=e&&e.viewModel&&e.viewModel.bindingPath||"";return!!(n&&0<Object.keys(n).length)&&!!Object.keys(n).find(function(e){var t=n[e];if(!t||!t.binding)return!1;var r=t.binding.split(".").filter(function(e){return e}),i=o.split("/").filter(function(e){return e}).concat(r);return a.split(s).filter(function(e){return e}).join("/")===i.join("/")})})},er.prototype.getFrameContextsByColumnName=function(r,t){var i=this;if(!r)throw new Error("bindingPath 不能为空。");if(!t)throw new Error("columnName 不能为空。");r=r.filter(function(e){return e});var e=this.repository&&this.repository.entityTypeInfo||null;if(!e)return null;var n=e.getTypeInfoByPath(r),o=(n&&n.getPropInfos()||[]).find(function(e){return e.metadataInfo&&(e.metadataInfo.originalDataField===t||e.metadataInfo.dataField===t)});return o&&o.metadataInfo?this.appContext.frameContextManager.getFrameContexts().filter(function(e){var t=i.formControlService.getFormControlsByFrameContext(e);return!(!t||Object.keys(t).length<1||(i.bindingPathService.getBindingPathsByFrameContext(e)||[]).join("/")!==r.join("/")||!Object.values(e.viewModel.form.ngFormControls).find(function(e){return e.binding===o.metadataInfo.path}))}):null},er.prototype.getFrameContextsByBindingPath=function(t,r){return void 0===r&&(r=""),Array.isArray(t)&&(t=t.join("/")),(this.appContext&&this.appContext.frameContextManager.getFrameContexts()||[]).filter(function(e){return e&&e.namespace===r&&e.viewModel.bindingPath===t})},er.decorators=[{type:k.Injectable}],er.ctorParameters=function(){return[{type:k.Injector},{type:V.AppContext},{type:V.FrameContext},{type:V.Repository},{type:Gt},{type:Qt}]},er);function er(e,t,r,i,n,o){this.injector=e,this.appContext=t,this.frameContext=r,this.repository=i,this.bindingPathService=n,this.formControlService=o}var tr=(rr.prototype.focusInvalidInput=function(e,t){if(e&&e.length){var r=null,i=this.selectFirstVerifyInformation(e,t);i&&(r=i.targetField)&&this.focusElement(r,t)&&(e.focused=!0)}},rr.prototype.focusGridCell=function(e,t){if(e&&e.length&&1!=e.focused&&!0!==t.disabled){var r=null,i=null,n=this.selectFirstVerifyInformation(e);n&&(r=n.targetField,i=n.id,e.focused=!0,t.editCell(i,r))}},rr.prototype.updateVerifyInformationsIndex=function(e,s){var c=this;return(e=e.filter(function(e){var t=c.getFrameContextsByPropertyPath(e.fullPath,"/");return!(!t||!t.filter(function(e){return e&&e.frameId===c.frameContext.frameId}))})).map(function(e){var t=-1;if(e){if(s&&e.targetField){var r=c.getInputElementById(e.targetField,s);t=r&&r.getAttribute("tabindex")||-1,t=Number(t)}var i=c.frameContext,n=i.index+1;if(e.tabIndex=t,e.domIndex=-1,e.frameIndex=-1,e.position=t,i){var o=e.fullPath&&c.getFieldIndex(i,e.fullPath)||0;if(0<o){var a=e.index||0;e.domIndex=o,e.frameIndex=i.index,e.position=0<t?t:1e3*n+1e3*a+o}}}return e})},rr.prototype.isGridComponent=function(e){return e?!!e.viewModel.dataGridColumnsName:undefined},rr.prototype.getColumnIndex=function(e,a){a=a.split("/").filter(function(e){return e}).join("/");var s=e.viewModel.bindingPath.split("/").filter(function(e){return e}),t=e.viewModel.dataGridColumnsName||null,c=e.index+1;if(!t)return undefined;var u=e.viewModel[t];if(!u||u.length<1)return undefined;u=u.reduce(function(e,t){return Array.isArray(t)?e.concat(t):e.concat([t])},[]);for(var l=-1,r=function(e){var t=u[e],r=t&&t.field&&t.field.split(".").filter(function(e){return e})||null;if(!r)return"continue";if(s.concat(r).join("/")===a){var i=t.fixed;if(i){var n=u.filter(function(e){return e.fixed===i}),o=p.getIndexFromColumns(n,a);l="left"===i?5e3*c+o:1e4*c+1e3+o}else l=1e4*c+e;return"break"}},p=this,i=0;i<u.length&&"break"!==r(i);i++);return l},rr.prototype.getIndexFromColumns=function(e,r){var i=this.frameContext.viewModel.bindingPath.split("/").filter(function(e){return e});return e.findIndex(function(e){var t=e&&e.field&&e.field.split(".").filter(function(e){return e})||null;return!!t&&i.concat(t).join("/")===r})},rr.prototype.selectFirstVerifyInformation=function(e,t){return(e=this.updateVerifyInformationsIndex(e,t)).sort(function(e,t){return Number(e.position)-Number(t.position)}),e&&0<e.length&&e[0]||null},rr.prototype.getInputElementById=function(e,t){var r=t.nativeElement.ownerDocument.getElementById(e)||null;if(r&&"INPUT"!==r.tagName){var i=r.getElementsByTagName("input");i.length&&(r=i[0])}return r},rr.prototype.getFrameContextsByPropertyPath=function(a,s){return void 0===s&&(s="/"),a?(this.frameContext&&this.frameContext.appContext.frameContextManager.getFrameContexts()||[]).filter(function(e){var n=e&&e.form&&e.form.ngFormControls||{},o=e&&e.viewModel&&e.viewModel.bindingPath||"";return!!(n&&0<Object.keys(n).length)&&!!Object.keys(n).find(function(e){var t=n[e];if(!t||!t.binding)return!1;var r=t.binding.split(".").filter(function(e){return e}),i=o.split("/").filter(function(e){return e}).concat(r);return a.split(s).filter(function(e){return e}).join("/")===i.join("/")})}):[]},rr.prototype.getFormControlIndexByBindingPath=function(i,e){var t=this.getFormControlsByFrameContext(i);if(!t)return null;var n=e.split("/").filter(function(e){return e});return Object.values(t).findIndex(function(e){if(!e)return!1;var t=i.viewModel.bindingPath.split("/").filter(function(e){return e}),r=e.binding.split(".").filter(function(e){return e});return t.concat(r).join("/")===n.join("/")})},rr.prototype.getFieldIndex=function(e,t){return this.isGridComponent(e)?this.getColumnIndex(e,t):this.getFormControlIndexByBindingPath(e,t)},rr.prototype.getFormControlsByFrameContext=function(e){return e&&e.form&&e.form.ngFormControls||null},rr.prototype.focusElement=function(e,t){var r=!1,i=t.nativeElement.ownerDocument.getElementById(e);if(i){var n=t.nativeElement.ownerDocument.querySelectorAll("#"+e);if(n&&1<n.length)return r;if("INPUT"!==i.tagName){var o=i.getElementsByTagName("input");o.length&&(i=o[0])}i.focus(),r=!0}return r},rr.prototype.focus=function(e,t){if(e)if(null!==e.index){var r=this.getGridRef(t);r&&setTimeout(function(){r.editCell(e.id,e.targetField)},0)}else{var i=this.getComponentRef(t),n=e.targetField;this.focusById(n,i)}},rr.prototype.focusById=function(e,t){var r=t&&t.nativeElement.ownerDocument||window.document;if(r){var i=r.getElementById(e);if("INPUT"!==i.tagName){var n=i.getElementsByTagName("input");if(n.length){var o=n[0];o&&"function"==typeof o.focus&&o.focus()}}else i.focus()}},rr.prototype.getComponentRef=function(e){return this.frameContext&&this.frameContext.injector.get(k.ElementRef,null)||null},rr.prototype.getGridRef=function(e){var n=this,t=e.namespace,r=e.viewModel.bindingPath,i=(this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(t)||[]).filter(function(e){return e.viewModel&&e.viewModel.bindingPath.split("/").filter(function(e){return e}).toString()===r.split("/").filter(function(e){return e}).toString()}),o=null;return i&&i.every(function(e){var t=e.frameId,r=n.frameContext.appContext.componentManager.getComponentsByFrameId(t);if(!r)return!0;var i=Array.from(r.values()).find(function(e){return e&&"DatagridComponent"===e.__component_type__});return!i||(o=i,!1)}),o},rr.decorators=[{type:k.Injectable}],rr.ctorParameters=function(){return[{type:V.Repository},{type:V.FrameContext},{type:Zt},{type:Qt}]},rr);function rr(e,t,r,i){this.repository=e,this.frameContext=t,this.frameContextService=r,this.formControlService=i}var ir="iframePoster",nr="iframeReceiver",or="repository",ar="tabId=",sr=(cr.prototype.init=function(){this.top.topMap=this.top.topMap||{},this.changeItem=this.changeItem.bind(this)},cr.prototype.setBykey=function(e,t){this.top.topMap=this.top.topMap||{},this.top.topMap[this.tabId]=this.top.topMap[this.tabId]||{},this.top.topMap[this.tabId][e]=t},cr.prototype.getByKey=function(e){return(this.top.topMap[this.tabId]||{})[e]},cr.prototype.setIframePoster=function(){this.getByKey[ir]||this.setBykey(ir,this.itemChangePoster)},cr.prototype.getIframePoster=function(){this.itemChangePoster=this.getByKey(nr),this.setBykey(nr,this.itemChangeReceiver)},cr.prototype.changeItem=function(e,r,t){var i=this,n=this.frameContext.getVirtualRootFrameContext().frameComponent.isDialogRootComponent||!1;return this.tabId=n?window.location.hash.split(ar)[1].slice(0,window.location.hash.split(ar)[1].indexOf("&")):t,this.itemChangeReceiver=this.getByKey(nr),O.Observable.create(function(t){i.getNextItemByCurrentId(r,e).subscribe(function(e){t.next(e)})})},cr.prototype.setRepository=function(){window.location.hash.includes(ar)&&(this.tabId=window.location.hash.split(ar)[1].slice(0,window.location.hash.split(ar)[1].indexOf("&")),this.setBykey(or,this.frameContext.repository),this.setIframePoster(),this.getIframePoster())},cr.prototype.getNextItemByCurrentId=function(r,e){var t=this.getByKey(or),i=t.entityCollection.paginationInfo,n=i.pageSize,o=i.pageIndex,a=i.total,s=null,c=t.entityCollection.getAllEntities();if(c.find(function(e,t){e.id===r&&(s=t)}),null===s){if(c.length)switch(e){case"prev":return g.of(c[c.length-1].id);case"next":return this.notifyService.info(this.languageService.changeToLast,{hideTitle:!0}),O.EMPTY}return g.of(null)}var u=s;switch(e){case"prev":return 0===s&&1!==o?t.getEntities([],[],n,o-1).pipe(N.switchMap(function(e){return u=n-1,g.of(e[u].id)})):(0===s&&1===o?this.notifyService.info(this.languageService.changeToFirst,{hideTitle:!0}):u=s-1,g.of(c[u].id));case"next":return s+1+1>c.length?(o-1)*n+s+1<a?t.getEntities([],[],n,o+1).pipe(N.switchMap(function(e){return g.of(e[0].id)})):(this.notifyService.info(this.languageService.changeToLast,{hideTitle:!0}),g.of(c[u].id)):(u=s+1,g.of(c[u].id))}},cr.decorators=[{type:k.Injectable}],cr.ctorParameters=function(){return[{type:V.Repository},{type:V.FrameContext},{type:Te},{type:$}]},cr);function cr(e,t,r,i){this.repository=e,this.frameContext=t,this.notifyService=r,this.languageService=i,this.top=top,this.itemChangePoster=new O.Subject,this.itemChangeReceiver=new O.Subject}var ur=(Object.defineProperty(lr.prototype,"eventParam",{get:function(){return this.context&&this.context.eventParam||null},enumerable:!0,configurable:!0}),lr);function lr(){}var pr,dr=(Z(fr,pr=ur),fr.prototype.clearChecks=function(){var e=this.getFormGridComponents(this.context);e&&0<e.length&&e.forEach(function(e){var t=!0;e.hasOwnProperty("clearSelectionsWhenDataIsEmpty")&&(t=e.clearSelectionsWhenDataIsEmpty),t&&e.clearCheckeds(!0)})},fr.prototype.uncheckDeletedRows=function(e){if("string"==typeof e&&(e=-1!==e.indexOf(",")?e.split(",").filter(function(e){return e}):[e]),e&&!(e.length<1)){var t=this.context.frameContext;if(t){var r=t.appContext,i=t.namespace,n=t.viewModel&&t.viewModel.bindingPath;if(r){var o=r.frameContextManager.getFrameContextsByNamespace(i),a=o.filter(function(e){return e&&e.viewModel&&e.viewModel.bindingPath===n}),s=this.getGridComponentByFrameContexts(a);if(s){var c=s.pop();c&&c.unCheckRows(e,!0);var u=o.filter(function(e){return e.viewModel.bindingPath!==n&&e.viewModel.bindingPath.startsWith(n)}),l=this.getGridComponentByFrameContexts(u);l&&0<l.length&&l.forEach(function(e){e.checkedRows=[]})}}}}},fr.prototype.uncheckRows=function(t){if("string"==typeof t&&(t=[t]),t&&!(t.length<1)){var e=this.getFormGridComponents(this.context);e&&0<e.length&&e.forEach(function(e){e.unCheckRows(t,!0)})}},fr.prototype.getFormGridComponents=function(e){var r=[],t=e&&e.frameContext,i=t&&t.appContext||null;if(i){var n=i.componentRefs;Array.from(n.values()).forEach(function(e){var t=Array.from(e.values()).filter(function(e){return e instanceof u.DatagridComponent});r=r.concat(t)})}return r},fr.prototype.getGridComponentByFrameContexts=function(e){return e.reduce(function(e,t){var r=t.appContext,i=t.frameId,n=r.componentRefs.get(i),o=n&&Array.from(n.values()).filter(function(e){return e instanceof u.DatagridComponent});return o&&0<o.length&&(e=e.concat(o)),e},[])},fr.decorators=[{type:k.Injectable}],fr);function fr(){return null!==pr&&pr.apply(this,arguments)||this}var hr=(vr.prototype.load=function(e,t){var r=this;e=e||"[]",t=t||"[]",e=this.mergeFilterConditions(e),t=this.mergeSortConditions(t);var i=this.loadingService.showLoadingWithDelay(200);return this.repository.getEntities(JSON.parse(e),JSON.parse(t),null,null).pipe(N.tap(function(){r.fireQueryEvent(e),r.loadingService.hideDelayLoading(i)},function(e){r.loadingService.hideDelayLoading(i),r.formErrorService.exception(r.languageService.loadFailed,e)}))},vr.prototype.filter=function(e,t){var r=this;e=e||"[]",t=t||"[]",e=this.mergeFilterConditions(e),t=this.mergeSortConditions(t);var i=this.loadingService.showLoadingWithDelay(200);return this.repository.filter(JSON.parse(e),JSON.parse(t)).pipe(N.tap(function(){r.fireQueryEvent(e),r.loadingService.hideDelayLoading(i)},function(e){r.loadingService.hideDelayLoading(i),r.formErrorService.exception(r.languageService.loadFailed,e)}))},vr.prototype.query=function(e,t,r,i){var n=this;e=""===e?"[]":e,t=""===t?"[]":t,e=this.mergeFilterConditions(e),t=this.mergeSortConditions(t);var o=this.loadingService.showLoadingWithDelay(5);return this.repository.getEntities(JSON.parse(e),JSON.parse(t),r,i).pipe(N.tap(function(){n.fireQueryEvent(e),n.loadingService.hideDelayLoading(o)},function(e){n.loadingService.hideDelayLoading(o),n.formErrorService.exception(n.languageService.queryFailed,e)}))},vr.prototype.queryChild=function(e,t){var r=this,i=V.EntityPathConverter.toEntityPathArray(this.viewModel.bindingPath,this.bindingData),n=i.slice(0,i.length-1),o=this.viewModel.bindingPath.split("/").filter(function(e){return e}),a=this.viewModel.bindingData,s=o[o.length-1];s=s.substr(0,s.length-1);var c=o.slice(0,o.length-1);if(a.getValue(c)){this.viewModel.frameContext.appContext.params["delete"]("retrieveing");var u="/"+s,l=this.repository.entityCollection.getPaginationConfigByPath(u);if(l){var p=l.pageIndex,d=void 0===p?1:p,f=l.pageSize,h=void 0===f?0:f;if(0!==h)return this.viewModel.frameContext.appContext.params.set("queryChild",!0),this.repository.queryChild(n,d,h).pipe(N.tap(function(){},function(e){r.formErrorService.exception(r.languageService.queryFailed,e)}))}}},vr.prototype.append=function(){var t=this,r=this.loadingService.showLoadingWithDelay(500);return this.messagePipe&&this.messagePipe.next({messageType:"append"}),this.repository.append().pipe(N.tap(function(){t.loadingService.hideDelayLoading(r)},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.appendFailed,e)}))},vr.prototype.insert=function(e){var t=this;void 0===e&&(e=-1);var r=this.loadingService.showLoadingWithDelay(500);return this.messagePipe&&this.messagePipe.next({messageType:"insert"}),this.repository.insert(e).pipe(N.tap(function(){t.loadingService.hideDelayLoading(r)},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.appendFailed,e)}))},vr.prototype.updateChanges=function(){return this.repository.updateAllChanges()},vr.prototype.save=function(r){var i=this;this.messagePipe&&this.messagePipe.next({messageType:"save"});var n=this.loadingService.showLoadingWithDelay(500);return this.repository.applyChanges().pipe(N.tap(function(){if(i.loadingService.hideDelayLoading(n),r&&r.trim()){var e=!0;if(r.startsWith("{")&&r.endsWith("}"))try{!1===JSON.parse(r).showMessage&&(e=!1)}catch(t){}!1!==e&&i.formNotifyService.success(r,{hideTitle:!0})}else i.formNotifyService.success(i.languageService.saveSuccess,{hideTitle:!0})},function(e){i.loadingService.hideDelayLoading(n),i.formErrorService.exception(i.languageService.multiSaveFailed,e)}))},vr.prototype.remove=function(i,n,o,e,a){var s=this;return void 0===e&&(e=!0),void 0===a&&(a=!0),this.messagePipe&&this.messagePipe.next({messageType:"delete"}),i?(a=!1!==a&&"false"!==a,((e=!1!==e&&"false"!==e)?this.msgService.question(this.languageService.confirmDeletion):O.of(!0)).pipe(N.concatMap(function(e){if(!e)return O.empty();n=!1!==n&&"false"!==n;var r=s.loadingService.showLoadingWithDelay(500),t=s.repository.removeById(i,n);return t?t.pipe(N.tap(function(){if(s.loadingService.hideDelayLoading(r),o&&o.trim()){var e=!0;if(o.startsWith("{")&&o.endsWith("}"))try{!1===JSON.parse(o).showMessage&&(e=!1)}catch(t){}!1!==e&&s.formNotifyService.success(o,{hideTitle:!0})}else s.formNotifyService.success(s.languageService.deleteSuccess,{hideTitle:!0})},function(e){s.loadingService.hideDelayLoading(r),s.formErrorService.exception(s.languageService.deleteFailed,e)}),N.switchMap(function(){if(!0!==n&&a){var e=new dr;return e.context=s.context,e.uncheckDeletedRows([i]),O.empty()}return O.of([])})):O.empty()}))):(this.formNotifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),O.empty())},vr.prototype.removeRows=function(i,n,o,e){var a=this;if(void 0===e&&(e=!1),this.messagePipe&&this.messagePipe.next({messageType:"removeRows"}),e="true"===e||!0===e,!i||0===i.length){var t=this.bindingData.list.currentId;if(!0!==e||!t)return this.formNotifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),O.empty();i=[this.bindingData.list.currentId]}return this.msgService.confirm(this.languageService.confirmDeletion).pipe(N.concatMap(function(e){if(!e)return O.empty();void 0===n&&(n=!0),"string"==typeof n&&(n="false"!==n.toLowerCase()),n=!1!==n;var r=a.loadingService.showLoadingWithDelay(500),t=a.repository.removeByIds(i,n);return t?t.pipe(N.tap(function(){if(a.loadingService.hideDelayLoading(r),o&&o.trim()){var e=!0;if(o.startsWith("{")&&o.endsWith("}"))try{!1===JSON.parse(o).showMessage&&(e=!1)}catch(t){}!1!==e&&a.formNotifyService.success(o,{hideTitle:!0})}else a.formNotifyService.success(a.languageService.deleteSuccess,{hideTitle:!0})},function(e){a.loadingService.hideDelayLoading(r),a.formErrorService.exception(a.languageService.deleteFailed,e)}),N.switchMap(function(){return O.of([])})):O.empty()}))},vr.prototype.refreshAfterRemoving=function(e,t){return this.viewModel&&e&&t?this.viewModel.frameContext.injector.get(pt,null).execute(e,t):this.load()},vr.prototype.refresh=function(e,t){return this.viewModel&&e&&t?this.viewModel.frameContext.injector.get(pt,null).execute(e,t):this.load()},vr.prototype.cancel=function(){var t=this;return this.messagePipe&&this.messagePipe.next({messageType:"cancel"}),gt.hasChange(this.viewModel.frameContext).pipe(N.switchMap(function(e){return e?t.msgService.question(t.languageService.cancelWithoutSave).pipe(N.switchMap(function(e){return!1===e?O.EMPTY:t._cancel()})):t._cancel()}))},vr.prototype.revert=function(){return this._cancel()},vr.prototype._cancel=function(){var t=this,r=this.loadingService.showLoadingWithDelay(500);return this.repository.cancelChanges().pipe(N.tap(function(){t.loadingService.hideDelayLoading(r)},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.cancelFailed,e)}))},Object.defineProperty(vr.prototype,"messagePipe",{get:function(){if(this.viewModel&&this.viewModel.frameContext){var e=this.viewModel.frameContext.getFormAppContext()||null;if(e)return e.messagePipe||null}return null},enumerable:!0,configurable:!0}),vr.prototype.fireQueryEvent=function(e){var t=this.messagePipe;t&&t.next({type:"query"})},vr.prototype.mergeFilterConditions=function(e){"string"==typeof e&&(e=JSON.parse(e)||[]);var t=e,r=this.viewModel&&this.viewModel.bindingPath||null;if(r){var i=this.viewModel&&this.viewModel.frameContext.repository.filterConditionManager.getFilters(r)||[],n=Array.from(i);if(n&&0<n.length){if(0<t.length){var o=t[t.length-1];o&&(o.hasOwnProperty("Relation")&&delete o.Relation,o.relation=1)}t.push.apply(t,ie(n))}}return JSON.stringify(t)},vr.prototype.mergeSortConditions=function(e){"string"==typeof e&&(e=JSON.parse(e)||[]);var t=e,r=this.viewModel&&this.viewModel.bindingPath||null;if(r){var i=this.viewModel&&this.viewModel.frameContext.repository.sortConditionManager.getConditionsByBindingPath(r,function(e){return"asc"===e?0:1})||[],n=Array.from(i);if(n&&0<n.length)return JSON.stringify(n)}return JSON.stringify(t)},vr.decorators=[{type:k.Injectable}],vr.ctorParameters=function(){return[{type:Fe},{type:V.Repository},{type:V.BindingData},{type:W},{type:$,decorators:[{type:k.Optional}]},{type:Te},{type:Pe},{type:V.ViewModel},{type:Mt}]},vr);function vr(e,t,r,i,n,o,a,s,c){this.msgService=e,this.repository=t,this.bindingData=r,this.loadingService=i,this.languageService=n,this.formNotifyService=o,this.formErrorService=a,this.viewModel=s,this.filterConditionService=c,n||(this.languageService=$.getInstance())}var yr=(gr.prototype.add=function(){var t=this;this.messagePipe&&this.messagePipe.next({messageType:"add"});var e=this.getPath(),r=this.loadingService.showLoadingWithDelay(500);return this.repository.appendByPath(e).pipe(N.tap(function(){t.loadingService.hideDelayLoading(r)},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.addFailed,e)}))},gr.prototype.insert=function(e){var t=this;void 0===e&&(e=-1),this.messagePipe&&this.messagePipe.next({messageType:"insert"});var r=this.getPath(),i=this.loadingService.showLoadingWithDelay(500);return this.repository.insertByPath(r,e).pipe(N.tap(function(){t.loadingService.hideDelayLoading(i)},function(e){t.loadingService.hideDelayLoading(i),t.formErrorService.exception(t.languageService.addFailed,e)}))},gr.prototype.remove=function(e,t){var r=t||"";return this.innerRemove(e,!1,r)},gr.prototype.removeWithoutConfirm=function(e){return this.innerRemove(e,!0,"")},gr.prototype.removeChildrenByIds=function(i,n){var o=this;return i?this.msgService.confirm(this.languageService.confirmDeletion).pipe(N.concatMap(function(e){if(!e)return O.EMPTY;var t=o.getPath(),r=o.loadingService.showLoadingWithDelay(500);return o.repository.batchRemoveByPath(t,i).pipe(N.tap(function(){if(o.loadingService.hideDelayLoading(r),n&&n.trim()){var e=!0;if(n.startsWith("{")&&n.endsWith("}"))try{!1===JSON.parse(n).showMessage&&(e=!1)}catch(t){}!1!==e&&o.formNotifyService.success(n,{hideTitle:!0})}else o.formNotifyService.success(o.languageService.deleteSuccess,{hideTitle:!0})},function(e){o.loadingService.hideDelayLoading(r),o.formErrorService.exception(o.languageService.deleteFailed,e)}))})):(this.formNotifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),O.EMPTY)},gr.prototype.innerRemove=function(i,e,n){var o=this;return this.messagePipe&&this.messagePipe.next({messageType:"remove"}),i?(!1===e?this.msgService.question(this.languageService.confirmDeletion):O.of(!0)).pipe(N.concatMap(function(e){if(!e)return O.empty();var t=o.getPath(),r=o.loadingService.showLoadingWithDelay(500);return o.repository.removeByPath(t,i).pipe(N.tap(function(){if(o.loadingService.hideDelayLoading(r),n&&n.trim()){var e=!0;if(n.startsWith("{")&&n.endsWith("}"))try{!1===JSON.parse(n).showMessage&&(e=!1)}catch(t){}!1!==e&&o.formNotifyService.success(n,{hideTitle:!0})}else o.formNotifyService.success(o.languageService.deleteSuccess,{hideTitle:!0})},function(e){o.loadingService.hideDelayLoading(r),o.formErrorService.exception(o.languageService.deleteFailed,e)}))})):(this.formNotifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),O.empty())},gr.prototype.removeAndSave=function(i,n){var o=this;return this.messagePipe&&this.messagePipe.next({messageType:"removeAndSave"}),i?this.msgService.confirm(this.languageService.confirmDeletion).pipe(N.concatMap(function(e){if(!e)return O.empty();var t=o.getPath(),r=o.loadingService.showLoadingWithDelay(500);return o.repository.removeByPath(t,i).pipe(N.switchMap(function(){var e=o.viewModel.bindingData.list.currentId;return o.repository.applyChangesById(e)}),N.tap(function(){if(o.loadingService.hideDelayLoading(r),n&&n.trim()){var e=!0;if(n.startsWith("{")&&n.endsWith("}"))try{!1===JSON.parse(n).showMessage&&(e=!1)}catch(t){}!1!==e&&o.formNotifyService.success(n,{hideTitle:!0})}else o.formNotifyService.success(o.languageService.deleteSuccess,{hideTitle:!0})},function(e){o.loadingService.hideDelayLoading(r),o.formErrorService.exception(o.languageService.deleteFailed,e)}))})):(this.formNotifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),O.empty())},gr.prototype.move=function(c,u,e){var l=this;if(e&&("string"==typeof e&&(e=e.split(",").filter(function(e){return e})),this.viewModel&&this.viewModel.bindingPath)){var p=this.viewModel.bindingData.getList();!p||p.length<1||e.forEach(function(e){var t=p.getIndexById(e);if(-1!==t){var r=p.findById(e),i=r.getValue(u),n=t+("up"===c?-1:1);if(!(n<0||n>p.length)){var o=p.getIdByIndex(n),a=p.findById(o),s=a[u];l.isNullOrEmpty(i)&&l.isNullOrEmpty(s)||(p.swapById(e,o),a.setValue(u,i,!0,!0),r.setValue(u,s,!0,!0))}}})}},gr.prototype.isNullOrEmpty=function(e){return""===e||null===e||e===undefined},gr.prototype.getPath=function(){var e=this.viewModel.bindingPath,t="/"+this.viewModel.bindingData.list.currentId,r=e.split("/");if(0<r.length)for(var i=1;i<r.length-1;i++){var n=r[i],o=this.viewModel.bindingData[n];if(!o||!o.currentId)throw this.formNotifyService.warning(this.languageService.plsSelectDetailFormData,{hideTitle:!0}),Error("获取子表完整路径出错，找不到"+o+"对应的子表，或对应子表没有当前行。");t+="/"+n+"/"+o.currentId}return t+="/"+r[r.length-1]},Object.defineProperty(gr.prototype,"messagePipe",{get:function(){if(this.viewModel&&this.viewModel.frameContext){var e=this.viewModel.frameContext.getFormAppContext()||null;if(e)return e.messagePipe||null}return null},enumerable:!0,configurable:!0}),gr.decorators=[{type:k.Injectable}],gr.ctorParameters=function(){return[{type:Fe},{type:V.Repository},{type:W},{type:V.ViewModel},{type:$,decorators:[{type:k.Optional}]},{type:Te},{type:Pe}]},gr);function gr(e,t,r,i,n,o,a){this.msgService=e,this.repository=t,this.loadingService=r,this.viewModel=i,this.languageService=n,this.formNotifyService=o,this.formErrorService=a,n||(this.languageService=$.getInstance()),this.viewModel=i}var mr=(Object.defineProperty(Sr.prototype,"repository",{get:function(){return this.frameContext.repository},enumerable:!0,configurable:!0}),Object.defineProperty(Sr.prototype,"restService",{get:function(){return this.repository.restService},enumerable:!0,configurable:!0}),Object.defineProperty(Sr.prototype,"bindingData",{get:function(){return this.frameContext.bindingData},enumerable:!0,configurable:!0}),Sr);function Sr(e){this.frameContext=e}var Cr=(br.prototype.selectFirstRootNode=function(e,t){var r=e.list.toJSON(),i=this.getFirstNodeId(r,t);return this.selectedNode(e,t,i),i},br.prototype.selectNodeByBindingList=function(e,t,r){var i=e.toJSON(),n=this.getNodeDataById(i,r),o=r;n||(o=this.getFirstNodeId(i,t)),setTimeout(function(){e.setCurrentId(o,!0,!0)},0)},br.prototype.selectedNode=function(e,t,r){var i=e.list.toJSON(),n=this.getNodeDataById(i,r),o=r;n||(o=this.getFirstNodeId(i,t)),!0!==e.rowSelectedEventSuspend&&setTimeout(function(){e.list.currentId=null,e.list.setCurrentId(o,!0,!0)},0)},br.prototype.hasChildNodes=function(e,t,r){return!1===this.getNodeDataById(e,r)[t].isDetail},br.prototype.getFirstNodeId=function(e,t){var r=e.find(function(e){return 1===e[t].layer});if(!r){var i=this.getRootLayer(e,t);r=e.find(function(e){return e[t].layer===i})}return r?r.id:""},br.prototype.getRootLayer=function(e,t){var r=null;if(e&&Array.isArray(e)){var i=e.map(function(e){return e[t].layer}),n=Math.min.apply(Math,i);isNaN(n)||(r=n)}return r},br.prototype.getNextNodeId=function(e,t,r){var i=e.find(function(e){return e.id===r}),n=i[t].layer-1,o=i[t].parentElement,a=this.getChildNodesData(e,t,n,o);if(1!==a.length)return this.getNextSiblingNodeId(a,r);var s=e.find(function(e){return e.id===o});return s?s.id:this.getFirstNodeId(e,t)},br.prototype.getNextSiblingNodeId=function(e,t){if(e.length<=1)return"";var r=e.findIndex(function(e){return e.id===t});return e[r===e.length-1?r-1:r+1].id},br.prototype.getChildNodesData=function(e,i,n,o){return e.filter(function(e){var t=e[i].layer,r=e[i].parentElement;return t===n+1&&o==r})},br.prototype.getNodeDataById=function(e,t){var r=e.find(function(e){return e.id===t});return r||null},br);function br(){}var Ir=(wr.prototype.selectFirstRootNode=function(e,t){var r=e.list.toJSON(),i=this.getFirstNodeId(r,t);return this.selectedNode(e,t,i),i},wr.prototype.selectNodeByBindingList=function(e,t,r){var i=e.toJSON(),n=this.getNodeDataById(i,r),o=r;n||(o=this.getFirstNodeId(i,t)),setTimeout(function(){e.setCurrentId(o,!0,!0)},0)},wr.prototype.selectedNode=function(e,t,r){var i=e.list.toJSON(),n=this.getNodeDataById(i,r),o=r;n||(o=this.getFirstNodeId(i,t)),!0!==e.rowSelectedEventSuspend&&setTimeout(function(){e.list.currentId=null,e.list.setCurrentId(o,!0,!0)},0)},wr.prototype.hasChildNodes=function(e,t,r){return!1===this.getNodeDataById(e,r)[t].isDetail},wr.prototype.getFirstNodeId=function(e,t){var r=e.find(function(e){return 1===e[t].layer});if(!r){var i=this.getRootLayer(e,t);r=e.find(function(e){return e[t].layer===i})}return r?r.id:""},wr.prototype.getRootLayer=function(e,t){var r=null;if(e&&Array.isArray(e)){var i=e.map(function(e){return e[t].layer}),n=Math.min.apply(Math,i);isNaN(n)||(r=n)}return r},wr.prototype.getNextNodeId=function(e,t,r){var i=e.find(function(e){return e.id===r}),n=i[t].path,o=i[t].layer-1,a=n.substring(0,n.length-4),s=this.getChildNodesData(e,t,o,a);if(1!==s.length)return this.getNextSiblingNodeId(s,r);var c=e.find(function(e){return e[t].path===a});return c?c.id:this.getFirstNodeId(e,t)},wr.prototype.getNextSiblingNodeId=function(e,t){if(e.length<=1)return"";var r=e.findIndex(function(e){return e.id===t});return e[r===e.length-1?r-1:r+1].id},wr.prototype.getChildNodesData=function(e,i,n,o){return e.filter(function(e){var t=e[i].layer,r=e[i].path;return t===n+1&&r.startsWith(o)})},wr.prototype.getNodeDataById=function(e,t){var r=e.find(function(e){return e.id===t});return r||null},wr);function wr(){}var xr=(Er.getInstance=function(e){var t=null;switch(e){case"path":t=new Ir;break;case"parent":t=new Cr}return t},Er);function Er(){}var Pr=(Dr.prototype.addSibling=function(r,e){var t=r.restService,i=t.baseUri+"/service/parenthierarchycreatesibling",n={dataID:e,requestInfo:t.buildRequestInfo()},o={headers:new P.HttpHeaders({"Content-Type":"application/json"}),body:n};return t.invoke(i,"PUT",null,o).pipe(N.map(function(e){var t=r.buildEntity(e.returnValue);return r.entityCollection.addEntity(t),t}))},Dr.prototype.addChild=function(r,e){var t=r.restService,i=t.baseUri+"/service/parenthierarchycreatechildlayer",n={dataID:e,requestInfo:t.buildRequestInfo()},o={headers:new P.HttpHeaders({"Content-Type":"application/json"}),body:n};return t.invoke(i,"PUT",null,o).pipe(N.map(function(e){var t=r.buildEntity(e.returnValue);return r.entityCollection.addEntity(t),t}))},Dr.prototype.addSubSibling=function(r,i,n){var o=this,e=r.restService,t=e.baseUri+"/service/childnodeparenthierarchycreatesibling",a={nodes:i,ids:n,requestInfo:e.buildRequestInfo()},s={headers:new P.HttpHeaders({"Content-Type":"application/json"}),body:a};return e.invoke(t,"PUT",null,s).pipe(N.map(function(e){var t=o.getPaths(i,n);return r.entityManager.appendEntityByPath(t,e.returnValue)}))},Dr.prototype.addSubChild=function(r,i,n){var o=this,e=r.restService,t=e.baseUri+"/service/childnodeparenthierarchycreatechildlayer",a={nodes:i,ids:n,requestInfo:e.buildRequestInfo()},s={headers:new P.HttpHeaders({"Content-Type":"application/json"}),body:a};return e.invoke(t,"PUT",null,s).pipe(N.map(function(e){var t=o.getPaths(i,n);return r.entityManager.appendEntityByPath(t,e.returnValue)}))},Dr.prototype.getPaths=function(e,t){var r="";if(e&&0<e.length&&t&&0<t.length)for(var i=0;i<t.length;i++)e[i]&&(r=(r=r+"/"+t[i])+"/"+e[i]+"s");return r},Dr.prototype.loadByParentId=function(n,o,a,e,t,s,r,c,i){var u=this;void 0===s&&(s=!1),void 0===i&&(i=!1);var l=this.getChildren(n,o,a);if(l&&0<l.length&&!i)return O.of(l);var p=n.restService,d=this.getHierarchyInfoById(n,o,a),f=this.getOriginalHierarchyInfoKey(n,o),h={FilterConditions:this.buildFiltersWithParent(f,d,e),SortConditions:t,IsUsePagination:r&&0<r.pageSize||!1,Pagination:{PageIndex:r&&r.pageIndex||0,PageSize:r&&r.pageSize||0,PageCount:0,TotalCount:0}},v=p.buildRequestInfo();return p.extendQuery(h,v).pipe(N.map(function(e){var t=u.getPaginationInfo(e);a?t&&0!==t.pageSize&&c&&c.params.set("_NODE_"+a+"_PAGINATION_INFO_",t):t&&0!==t.pageSize&&c&&c.repository.entityCollection.updatePaginationInfoByPath("/",t),u.clearDescendantEntities(n,o,d,s);var r=e.returnValue.result,i=n.buildEntities(r);return s?n.entityCollection.addData(i,{isTreeNodeLoadScene:!0}):n.entityCollection.addEntities(i,{isTreeNodeLoadScene:!0}),i}))},Dr.prototype.loadFullTree=function(s,c,e,t,r,i,n,u){var l=this,o=s.restService,a=o.baseUri+"/service/parentidfulltreequery",p=this.getHierarchyInfoById(s,c,e),d={body:{dataId:e||"",isUsePagination:!1,virtualPropertyName:t,pagination:{},fullTreeType:r,loadType:i,filter:this.buildEntityFilter(n,null,0,0),requestInfo:o.buildRequestInfo()}};return o.invoke(a,"PUT",null,d).pipe(N.tap(function(e){if(e.returnValue&&e.returnValue.selectedRowId&&u&&u.frameContext){var t=u.frameContext,r=t&&t.getVirtualRootFrameContext()||null;if(r){var i=e.returnValue.result,n=e.returnValue.selectedRowId,o=i.find(function(e){return e[s.primaryKey]===n})[c],a=l.getAllParentIds(o,i,c,s);r.params.set("_DEVKIT_expandRowIds",a.join(",")),r.params.set("_DEVKIT_selectedRowId",n),r.uiState.setPropertyValue("__DEVKIT__selectedRow",n)}}}),N.map(function(e){var t=u&&u.frozenCurrentRow||!1;l.clearDescendantEntities(s,c,p,t);var r=e.returnValue.result,i=s.buildEntities(r);return t?s.entityCollection.addData(i,{isTreeNodeLoadScene:!0}):s.entityCollection.addEntities(i,{isTreeNodeLoadScene:!0}),i}))},Dr.prototype.buildFiltersWithParent=function(e,t,r){var i=r&&1<=r.length?1:0,n=t?t.layer:0,o=t?t.id:"",a=[{FilterField:e+".Layer",Value:n+1,Lbracket:null,Rbracket:null,Relation:1,Expresstype:0,Compare:0}];return o?a.push({FilterField:e+".ParentElement",Value:o,Lbracket:null,Rbracket:null,Relation:i,Expresstype:0,Compare:0}):a[0].Relation=i,a.concat(r)},Dr.prototype.buildEntityFilter=function(e,t,r,i){return e||t||r||i?(t=t||[],(e=e||[])&&0<e.length&&(e[e.length-1].Relation=0),{FilterConditions:e,SortConditions:t,IsUsePagination:0!==r,Pagination:{PageIndex:i,PageSize:r,PageCount:0,TotalCount:0}}):null},Dr.prototype.clearDescendantEntities=function(e,t,r,i){if(void 0===i&&(i=!1),r){var n=this.getChildNodes(e,t,r);i?e.entityCollection.removeEntities(function(e){var t=e[e.primaryKey];return n.includes(t)}):e.entityCollection.removeData(function(e){var t=e[e.primaryKey];return n.includes(t)})}else e.entityCollection.clear()},Dr.prototype.getChildNodes=function(s,c,e){var u=this,l=e.id,p=e.layer,d=[];return s.entityCollection.getAllEntities().forEach(function(e){var t=e[c],r=t.parentElement,i=t.layer;if(p+1<=i&&r===l){var n=e[e.primaryKey];d.push(n);var o=u.getHierarchyInfoById(s,c,n),a=u.getChildNodes(s,c,o);a&&0<a.length&&(d=d.concat(a))}}),d},Dr.prototype.getHierarchyInfoById=function(e,t,r){if(!r)return null;var i=e.entityCollection.getEntityById(r)[t].toJSON();return i.id=r,i},Dr.prototype.getHierarchyInfo=function(e,t){return e[t]},Dr.prototype.getOriginalHierarchyInfoKey=function(e,t){return V.FieldMetadataUtil.getNgObjects(e.entityType)[t].originalDataField},Dr.prototype.getPaginationInfo=function(e){return e&&e.returnValue&&e.returnValue.pagination||null},Dr.prototype.findParent=function(r,e,i){return e.find(function(e){var t=e[i];return t.layer===r.layer-1&&r.parentElement===t.parentElement})},Dr.prototype.getAllParentIds=function(e,t,r,i){for(var n=this.findParent(e,t,r),o=[];n;)o.push(n[i.primaryKey]),n=this.findParent(n[r],t,r);return o},Dr.prototype.getChildren=function(e,r,t){var i=this,n=this.getHierarchyInfoById(e,r,t);if(!n)return null;var o=n.layer,a=n.parentElement;return e.entityCollection.getEntities(function(e){var t=i.getHierarchyInfo(e,r);return t.layer!==o+1||t.parentElement!==a&&(a||t.parentElement)?null:e})},Dr);function Dr(){}var Fr=(Mr.prototype.addSibling=function(r,e){var t=r.restService,i=t.baseUri+"/service/pathhierarchycreatesibling",n={dataID:e,requestInfo:t.buildRequestInfo()},o={headers:new P.HttpHeaders({"Content-Type":"application/json"}),body:n};return t.invoke(i,"PUT",null,o).pipe(N.map(function(e){var t=r.buildEntity(e.returnValue);return r.entityCollection.addEntity(t),t}))},Mr.prototype.addChild=function(r,e){var t=r.restService,i=t.baseUri+"/service/pathhierarchycreatechildlayer",n={dataID:e,requestInfo:t.buildRequestInfo()},o={headers:new P.HttpHeaders({"Content-Type":"application/json"}),body:n};return t.invoke(i,"PUT",null,o).pipe(N.map(function(e){var t=r.buildEntity(e.returnValue);return r.entityCollection.addEntity(t),t}))},Mr.prototype.addSubSibling=function(r,i,n){var o=this,e=r.restService,t=e.baseUri+"/service/childnodepathhierarchycreatesibling",a={nodes:i,ids:n,requestInfo:e.buildRequestInfo()},s={headers:new P.HttpHeaders({"Content-Type":"application/json"}),body:a};return e.invoke(t,"PUT",null,s).pipe(N.map(function(e){var t=o.getPaths(i,n);return r.entityManager.appendEntityByPath(t,e.returnValue)}))},Mr.prototype.addSubChild=function(r,i,n){var o=this,e=r.restService,t=e.baseUri+"/service/childnodepathhierarchycreatechildlayer",a={nodes:i,ids:n,requestInfo:e.buildRequestInfo()},s={headers:new P.HttpHeaders({"Content-Type":"application/json"}),body:a};return e.invoke(t,"PUT",null,s).pipe(N.map(function(e){var t=o.getPaths(i,n);return r.entityManager.appendEntityByPath(t,e.returnValue)}))},Mr.prototype.getPaths=function(e,t){var r="";if(e&&0<e.length&&t&&0<t.length)for(var i=0;i<t.length;i++)e[i]&&(r=(r=r+"/"+t[i])+"/"+e[i]+"s");return r},Mr.prototype.loadByParentId=function(n,o,a,e,t,s,r,c,i){var u=this;void 0===s&&(s=!1),void 0===i&&(i=!1);var l=this.getChildren(n,o,a);if(l&&0<l.length&&!i)return O.of(l);var p=n.restService,d=this.getHierarchyInfoById(n,o,a),f=this.getOriginalHierarchyInfoKey(n,o),h={FilterConditions:this.buildFiltersWithParent(f,d,e),SortConditions:t,IsUsePagination:r&&0<r.pageSize||!1,Pagination:{PageIndex:r&&r.pageIndex||0,PageSize:r&&r.pageSize||0,PageCount:0,TotalCount:0}},v=p.buildRequestInfo();return p.extendQuery(h,v).pipe(N.map(function(e){var t=u.getPaginationInfo(e);a?t&&0!==t.pageSize&&c&&c.params.set("_NODE_"+a+"_PAGINATION_INFO_",t):t&&0!==t.pageSize&&c&&c.repository.entityCollection.updatePaginationInfoByPath("/",t),u.clearDescendantEntities(n,o,d,s);var r=e.returnValue.result,i=n.buildEntities(r);return s?n.entityCollection.addData(i,{isTreeNodeLoadScene:!0}):n.entityCollection.addEntities(i,{isTreeNodeLoadScene:!0}),i}))},Mr.prototype.loadFullTree=function(s,c,e,t,r,i,n,u){var l=this,o=s.restService,a=o.baseUri+"/service/parentidfulltreequery",p=this.getHierarchyInfoById(s,c,e),d={body:{dataId:e||"",isUsePagination:!1,virtualPropertyName:t,pagination:{},fullTreeType:r,loadType:i,filter:this.buildEntityFilter(n,null,0,0),requestInfo:o.buildRequestInfo()}};return o.invoke(a,"PUT",null,d).pipe(N.tap(function(e){if(e.returnValue&&e.returnValue.selectedRowId&&u&&u.frameContext){var t=u.frameContext,r=t&&t.getVirtualRootFrameContext()||null;if(r){var i=e.returnValue.result,n=e.returnValue.selectedRowId,o=i.find(function(e){return e[s.primaryKey]===n})[c],a=l.getAllParentIds(o,i,c,s);r.params.set("_DEVKIT_expandRowIds",a.join(",")),r.params.set("_DEVKIT_selectedRowId",n),r.uiState.setPropertyValue("__DEVKIT__selectedRow",n)}}}),N.map(function(e){var t=u&&u.frozenCurrentRow||!1;l.clearDescendantEntities(s,c,p,t);var r=e.returnValue.result,i=s.buildEntities(r);return t?s.entityCollection.addData(i,{isTreeNodeLoadScene:!0}):s.entityCollection.addEntities(i,{isTreeNodeLoadScene:!0}),i}))},Mr.prototype.buildFiltersWithParent=function(e,t,r){var i=r&&1<=r.length?1:0,n=[{FilterField:e+".Layer",Value:(t?t.layer:0)+1,Lbracket:null,Rbracket:null,Relation:1,Expresstype:0,Compare:0}],o=t?t.path:"";return o?n.push({FilterField:e+".Path",Value:o,Lbracket:null,Rbracket:null,Relation:i,Expresstype:0,Compare:7}):n[0].Relation=i,n.concat(r)},Mr.prototype.buildEntityFilter=function(e,t,r,i){return e||t||r||i?(t=t||[],(e=e||[])&&0<e.length&&(e[e.length-1].Relation=0),{FilterConditions:e,SortConditions:t,IsUsePagination:0!==r,Pagination:{PageIndex:i,PageSize:r,PageCount:0,TotalCount:0}}):null},Mr.prototype.clearDescendantEntities=function(e,n,t,r){if(void 0===r&&(r=!1),t){var o=t.path,a=t.layer;r?e.entityCollection.removeData(function(e){var t=e[n],r=t.path,i=t.layer;return a<i&&r.startsWith(o)}):e.entityCollection.removeEntities(function(e){var t=e[n],r=t.path,i=t.layer;return a<i&&r.startsWith(o)})}else e.entityCollection.clear()},Mr.prototype.getHierarchyInfoById=function(e,t,r){return r?e.entityCollection.getEntityById(r)[t].toJSON():null},Mr.prototype.getOriginalHierarchyInfoKey=function(e,t){return V.FieldMetadataUtil.getNgObjects(e.entityType)[t].originalDataField},Mr.prototype.getPaginationInfo=function(e){return e&&e.returnValue&&e.returnValue.pagination||null},Mr.prototype.findParent=function(r,e,i){return e.find(function(e){var t=e[i];return t.layer===r.layer-1&&r.path.startsWith(t.path)})},Mr.prototype.getAllParentIds=function(e,t,r,i){for(var n=this.findParent(e,t,r),o=[];n;)o.push(n[i.primaryKey]),n=this.findParent(n[r],t,r);return o},Mr.prototype.getHierarchyInfo=function(e,t){return e[t]},Mr.prototype.getChildren=function(e,r,t){var i=this,n=this.getHierarchyInfoById(e,r,t);if(!n)return null;var o=n.layer,a=n.path;return e.entityCollection.getEntities(function(e){var t=i.getHierarchyInfo(e,r);return t.layer===o+1&&t.path.startsWith(a)?e:null})},Mr);function Mr(){}var Tr=(Rr.getInstance=function(e){var t=null;switch(e){case"path":t=new Fr;break;case"parent":t=new Pr}return t},Rr);function Rr(){}var Or,Nr=(Z(Ar,Or=mr),Object.defineProperty(Ar.prototype,"hierarchyInfoKey",{get:function(){return this.virtualRootFrameContext.getParam("hierarchyInfoKey")},enumerable:!0,configurable:!0}),Object.defineProperty(Ar.prototype,"virtualRootFrameContext",{get:function(){return this.frameContext.getVirtualRootFrameContext()},enumerable:!0,configurable:!0}),Ar.prototype.load=function(e,t){var r=this,i=this.parseConditions(e),n=this.parseConditions(t),o=0===this.repository.entityCollection.count(),a=this.loadingService.showLoadingWithDelay(500);return this.repository.getEntities(i,n,null,null).pipe(N.tap(function(){if(1==o){var e=r.getHierarchyType(),t=xr.getInstance(e);null!==t&&t.selectFirstRootNode(r.bindingData,r.hierarchyInfoKey)}r.loadingService.hideDelayLoading(a)},function(e){r.loadingService.hideDelayLoading(a),r.errorService.exception(r.languageService.loadFailed,e)}))},Ar.prototype.loadByLevel=function(e,t,n){var o=this;this.setLoadByLevelState(e,t);var r=this.parseConditions(e),i=this.parseConditions(t),a=this.getIdToExpand(),s=0===this.repository.entityCollection.count();n===undefined&&(n=!1),"boolean"!=typeof n&&(n="true"===n);var c=this.getHierarchyType(),u=Tr.getInstance(c);if(null===u)return O.empty();var l=this.loadingService.showLoadingWithDelay(500),p=this.buildPaginationInfo(a),d=this.frameContext.params.get("_RELOAD_CHILDREN_")||!1;return u.loadByParentId(this.repository,this.hierarchyInfoKey,a,r,i,n,p,this.frameContext,d).pipe(N.tap(function(e){if(o.frameContext.params["delete"]("_RELOAD_CHILDREN_"),1==s){var t=xr.getInstance(c);null!==t&&t.selectFirstRootNode(o.bindingData,o.hierarchyInfoKey)}var r=o.bindingData.list.currentItem.primaryKeyValue;if(n&&(e.find(function(e){return e.primaryValue===r})&&o.setCurrentId(r),!o.repository.entityCollection.getEntityById(r))){var i=e&&Array.isArray(e)&&0<e.length&&e[0].primaryValue||null;i&&o.setCurrentId(i)}o.loadingService.hideDelayLoading(l)},function(e){o.loadingService.hideDelayLoading(l),o.errorService.exception(o.languageService.loadFailed,e)}))},Ar.prototype.loadFullTree=function(e,t,r,i,a){var s=this;if("string"!=typeof t)throw new Error("ArgumentError: fullTreeType 不能为空且必须为字符串。");if("string"!=typeof r)throw new Error("ArgumentError: loadType 不能为空且必须为字符串。");a===undefined&&(a=!1),"boolean"!=typeof a&&(a="true"===a);var c=this.virtualRootFrameContext;c.params["delete"]("_DEVKIT_expandRowIds"),c.params["delete"]("_DEVKIT_selectedRowId"),c.uiState.setPropertyValue("__DEVKIT__selectedRow",null);var n=this.parseConditions(i),o=this.getIdToExpand(),u=0===this.repository.entityCollection.count(),l=this.getHierarchyType(),p=Tr.getInstance(l);if(null===p)return O.EMPTY;var d=this.loadingService.showLoadingWithDelay(500),f={frameContext:this.frameContext,frozenCurrentRow:a};return p.loadFullTree(this.repository,this.hierarchyInfoKey,o,e,t,r,n,f).pipe(N.tap(function(e){var t=c.params.get("_DEVKIT_selectedRowId");if(1==u||!t){var r=xr.getInstance(l);if(null!==r){var i=r.selectFirstRootNode(s.bindingData,s.hierarchyInfoKey);i&&c.uiState.setPropertyValue("__DEVKIT__selectedRow",i)}}var n=s.bindingData.list.currentItem.primaryKeyValue;if(a&&(e.find(function(e){return e.primaryValue===n})&&s.setCurrentId(n),!s.repository.entityCollection.getEntityById(n)&&e&&0<e.length)){var o=e&&Array.isArray(e)&&0<e.length&&e[0].primaryValue||null;o&&s.setCurrentId(o)}s.loadingService.hideDelayLoading(d)},function(e){s.loadingService.hideDelayLoading(d),s.errorService.exception(s.languageService.loadFailed,e)}))},Ar.prototype.getIdToExpand=function(){var e=this.virtualRootFrameContext.getParam("TREE_LATEST_EXPANDED_ID")||[],t=e.pop();return this.virtualRootFrameContext.setParam("TREE_LATEST_EXPANDED_ID",e),t},Ar.prototype.setIdToExpand=function(e){var t=this.virtualRootFrameContext.getParam("TREE_LATEST_EXPANDED_ID")||[];t.push(e),this.virtualRootFrameContext.setParam("TREE_LATEST_EXPANDED_ID",t)},Ar.prototype.parseConditions=function(e){var t=e&&""!==e?e:"[]";return JSON.parse(t)},Ar.prototype.addSibling=function(e){var t=this;(e=e||this.bindingData.list.currentId)&&"undefined"!==e||(e="");var r=this.bindingData.list.currentId,i=this.getHierarchyType(),n=this.loadingService.showLoadingWithDelay(500),o=Tr.getInstance(i);if(!o)throw new Error(this.languageService.errorHierarchyKey);return o.addSibling(this.repository,e).pipe(N.tap(function(){t.virtualRootFrameContext.setParam("IS_ADD",!0),t.virtualRootFrameContext.setParam("LAST_MODIFIED_ID",r),t.loadingService.hideDelayLoading(n)},function(e){t.loadingService.hideDelayLoading(n),t.errorService.exception(t.languageService.addSiblingFailed,e)}))},Ar.prototype.addChild=function(e){var t=this;if(!(e=e||this.bindingData.list.currentId))return this.notifyService.warning(this.languageService.plsSelectParentNode,{hideTitle:!0}),O.empty();var r=this.bindingData.list.currentId,i=this.getHierarchyType(),n=this.loadingService.showLoadingWithDelay(500);this.setIdToExpand(e);var o=this.reloadByLevel(),a=Tr.getInstance(i);if(!a)throw new Error(this.languageService.errorHierarchyKey);var s=a.addChild(this.repository,e);return o.pipe(N.switchMap(function(){return s}),N.tap(function(){t.virtualRootFrameContext.setParam("IS_ADD",!0),t.virtualRootFrameContext.setParam("LAST_MODIFIED_ID",r),t.loadingService.hideDelayLoading(n)},function(e){t.loadingService.hideDelayLoading(n),t.errorService.exception(t.languageService.addChildFailed,e)}))},Ar.prototype.save=function(){var t=this;this.messagePipe&&this.messagePipe.next({messageType:"save"});var r=this.loadingService.showLoadingWithDelay(500);return this.repository.applyChanges().pipe(N.tap(function(){t.loadingService.hideDelayLoading(r),t.notifyService.success(t.languageService.saveSuccess,{hideTitle:!0})},function(e){t.loadingService.hideDelayLoading(r),t.errorService.exception(t.languageService.multiSaveFailed,e)}))},Ar.prototype.remove=function(t,n){var o=this;if(!(t=t||this.bindingData.list.currentId))return this.notifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),O.empty();var a=this.repository.entityCollection.toJSON(),e=this.getHierarchyType(),s=xr.getInstance(e);return null===s?O.empty():!0===s.hasChildNodes(a,this.hierarchyInfoKey,t)?(this.notifyService.warning(this.languageService.deleteChildFirst,{hideTitle:!0}),O.empty()):this.messageService.question(this.languageService.confirmDeletion).pipe(N.concatMap(function(e){if(!e)return O.empty();var r=s.getNextNodeId(a,o.hierarchyInfoKey,t),i=o.loadingService.showLoadingWithDelay(500);return o.frameContext.repository.removeById(t).pipe(N.tap(function(){if(s.selectedNode(o.bindingData,o.hierarchyInfoKey,r),o.loadingService.hideDelayLoading(i),n&&n.trim()){var e=!0;if(n.startsWith("{")&&n.endsWith("}"))try{!1===JSON.parse(n).showMessage&&(e=!1)}catch(t){}!1!==e&&o.notifyService.success(n,{hideTitle:!0})}else o.notifyService.success(o.languageService.deleteSuccess,{hideTitle:!0})},function(e){o.loadingService.hideDelayLoading(i),o.errorService.exception(o.languageService.deleteFailed,e)}))}))},Ar.prototype.cancel=function(){var t=this;return gt.hasChange(this.frameContext).pipe(N.switchMap(function(e){return e?t.messageService.question(t.languageService.cancelWithoutSave).pipe(N.switchMap(function(e){return!1===e?O.EMPTY:t._cancel()})):t._cancel()}))},Ar.prototype.buildPaginationInfo=function(e){var t={pageIndex:0,pageSize:0},r=this.frameContext.params.get("enableNodePagination");if(e){if(r){var i=this.frameContext.params.get("nodePageSize")||0,n=this.frameContext.params.get("_NODE_"+e+"_PAGE_INDEX_");n||(this.frameContext.params.set("_NODE_"+e+"_PAGE_INDEX_",1),n=1),t.pageIndex=n,t.pageSize=i}}else{var o=this.repository.entityCollection.pageSize||0,a=this.repository.entityCollection.pageIndex||0;0!==o&&(t.pageSize=o,t.pageIndex=a)}return t},Ar.prototype._cancel=function(){var i=this,t=this.loadingService.showLoadingWithDelay(500);return this.repository.cancelChanges().pipe(N.switchMap(function(){var e=i.virtualRootFrameContext.getParam("IS_ADD"),t=i.virtualRootFrameContext.getParam("LAST_MODIFIED_ID"),r=i.bindingData.list.currentId;return!0===e?(i.repository.entityCollection.removeEntityById(r),i.virtualRootFrameContext.setParam("IS_ADD",!1),t&&setTimeout(function(){i.bindingData.list.setCurrentId(t,!0,!0)},0),O.of(null)):i.repository.updateById(r)}),N.tap(function(){i.loadingService.hideDelayLoading(t)},function(e){i.loadingService.hideDelayLoading(t),i.errorService.exception(i.languageService.cancelFailed,e)}))},Ar.prototype.hasChildNodes=function(e,t){return!0===this.getTreeNodeUtil().hasChildNodes(t,this.hierarchyInfoKey,e)},Ar.prototype.getNextNodeIdAfterRemoving=function(e,t){return this.getTreeNodeUtil().getNextNodeId(t,this.hierarchyInfoKey,e)},Ar.prototype.setNextNodeAfterRemoving=function(e){this.getTreeNodeUtil().selectedNode(this.bindingData,this.hierarchyInfoKey,e)},Ar.prototype.setCurrentId=function(e){e=e||this.frameContext.getVirtualRootFrameContext().uiState.__DEVKIT__selectedRow||this.bindingData.list.currentItem.primaryKeyValue,this.frameContext.bindingData.list.setCurrentId(e,!0,!0,!0)},Ar.prototype.selectFirstRow=function(){var e=this.getHierarchyType(),t=xr.getInstance(e);null!==t&&t.selectFirstRootNode(this.bindingData,this.hierarchyInfoKey)},Ar.prototype.getTreeNodeUtil=function(){var e=this.getHierarchyType(),t=xr.getInstance(e);if(null===t)throw new Error("不支持"+e+"类型的分级");return t},Ar.prototype.setLoadByLevelState=function(e,t){this.virtualRootFrameContext.setParam("isLoadTreeByLevel",!0),this.virtualRootFrameContext.setParam("loadTreeByLevelFilter",e),this.virtualRootFrameContext.setParam("loadTreeByLevelSort",t)},Ar.prototype.reloadByLevel=function(){if(!0!==this.virtualRootFrameContext.getParam("isLoadTreeByLevel"))return O.of([]);var e=this.virtualRootFrameContext.getParam("loadTreeByLevelFilter"),t=this.virtualRootFrameContext.getParam("loadTreeByLevelSort");return this.loadByLevel(e,t)},Ar.prototype.getHierarchyType=function(){var e=V.FieldMetadataUtil.getNgObjects(this.repository.entityType)[this.hierarchyInfoKey],t="path";if(e.hasOwnProperty("hierarchyType")&&null!=e.hierarchyType&&(t=e.hierarchyType),null==t||t.length<1)throw new Error(this.languageService.incorrectHierarchyConfig);return t},Object.defineProperty(Ar.prototype,"messagePipe",{get:function(){if(this.frameContext){var e=this.frameContext.getFormAppContext()||null;if(e)return e.messagePipe||null}return null},enumerable:!0,configurable:!0}),Ar.decorators=[{type:k.Injectable}],Ar.ctorParameters=function(){return[{type:V.FrameContext},{type:Fe},{type:W},{type:Te},{type:Pe},{type:$,decorators:[{type:k.Optional}]}]},Ar);function Ar(e,t,r,i,n,o){var a=Or.call(this,e)||this;return a.messageService=t,a.loadingService=r,a.notifyService=i,a.errorService=n,(a.languageService=o)||(a.languageService=$.getInstance()),a}var jr=(Br.prototype.filter=function(e,t){var r=this.context&&this.context.eventParam&&this.context.eventParam.data||[];return"string"==typeof r&&(r=JSON.parse(r)),this.viewModel.frameContext.repository.entityCollection.pageIndex=1,this.viewModel.frameContext.repository.filterConditionManager.setConditions(this.viewModel.bindingPath,r),this.commandService.execute(e,t)},Br.decorators=[{type:k.Injectable}],Br.ctorParameters=function(){return[{type:V.ViewModel},{type:Mt},{type:pt}]},Br);function Br(e,t,r){this.viewModel=e,this.filterConditionService=t,this.commandService=r}var Lr=(kr.prototype.edit=function(e){var t=this;if(!(e=e||this.bindingData.list.currentId))return O.EMPTY;var r=this.loadingService.showLoadingWithDelay(500);return this.repository.editEntityById(e).pipe(N.tap(function(){t.loadingService.hideDelayLoading(r),st.setEditState(t.frameContext,e)},function(e){t.loadingService.hideDelayLoading(r),t.errorService.exception(t.languageService.updateFailed,e)}))},kr.decorators=[{type:k.Injectable}],kr.ctorParameters=function(){return[{type:V.FrameContext}]},kr);function kr(e){this.frameContext=e,this.repository=this.frameContext.repository,this.bindingData=this.frameContext.bindingData,this.loadingService=this.frameContext.injector.get(W,null),this.languageService=this.frameContext.injector.get($,null),this.errorService=this.frameContext.injector.get(Pe,null)}var Vr=(_r.prototype.removeById=function(e,t,r,i){void 0===r&&(r=!0);var n=i||"";return this.innerRemoveById(e,t,r,n)},_r.prototype.removeByIds=function(e){throw new Error("Not Implemented")},_r.prototype.removeAndSaveById=function(e,t){var r=t||"";return this.innerRemoveById(e,!0,!0,r)},_r.prototype.removeAndSaveByIdForTree=function(e,t){var r=this,i=t||"";if(!1===this.checkIdsToRemove([e]))return this.notifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),O.EMPTY;var n=this.befRepository.entityCollection.toJSON();if(!0===this.treeDataService.hasChildNodes(e,n))return this.messageService.warning(this.languageService.deleteChildFirst),O.EMPTY;var o=this.innerRemoveById(e,!0,!0,i),a=this.treeDataService.getNextNodeIdAfterRemoving(e,n);return o.pipe(N.tap(function(){r.treeDataService.setNextNodeAfterRemoving(a)}))},_r.prototype.removeAndSaveByIds=function(){throw new Error("Not Implemented")},_r.prototype.refreshAfterRemoving=function(e,t){if(this.frameContext&&e&&t)return this.frameContext.injector.get(pt,null).execute(e,t)},_r.prototype.innerRemoveById=function(e,t,i,n){var o=this;if(!1===this.checkIdsToRemove([e]))return this.notifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),O.EMPTY;var r=this.confirmToRemove(),a=i&&t?this.befRepository.removeEntityAndSaveById(e):this.befRepository.removeById(e,t);return r.pipe(N.concatMap(function(e){if(!1===e)return O.EMPTY;var r=o.loadingService.showLoadingWithDelay(500);return a.pipe(N.tap(function(){if(o.loadingService.hideDelayLoading(r),n&&n.trim()){var e=!0;if(n.startsWith("{")&&n.endsWith("}"))try{!1===JSON.parse(n).showMessage&&(e=!1)}catch(t){}!1!==e&&o.notifyService.success(n,{hideTitle:!0})}else o.notifyService.success(o.languageService.deleteSuccess,{hideTitle:!0})},function(e){o.loadingService.hideDelayLoading(r),o.errorService.exception(o.languageService.deleteFailed,e)}),N.switchMap(function(){return i&&t?O.of(null):O.EMPTY}))}))},_r.prototype.checkIdsToRemove=function(e){return!!e&&0!==e.filter(function(e){return!!e}).length},_r.prototype.confirmToRemove=function(){return this.messageService.question(this.languageService.confirmDeletion).pipe(N.concatMap(function(e){return!1===e?O.EMPTY:O.of(!0)}))},_r.decorators=[{type:k.Injectable}],_r.ctorParameters=function(){return[{type:V.FrameContext}]},_r);function _r(e){this.frameContext=e,this.notifyService=this.frameContext.injector.get(Te,null),this.messageService=this.frameContext.injector.get(Fe,null),this.errorService=this.frameContext.injector.get(Pe,null),this.loadingService=this.frameContext.injector.get(W,null),this.languageService=this.frameContext.injector.get($,null),this.commandService=this.frameContext.injector.get(pt,null),this.listDataService=this.frameContext.injector.get(hr,null),this.treeDataService=this.frameContext.injector.get(Nr,null),this.befRepository=this.frameContext.repository}var qr=(Ur.decorators=[{type:k.Injectable}],Ur.ctorParameters=function(){return[{type:V.FrameContext}]},Ur);function Ur(e){this.frameContext=e,this.notifyService=this.frameContext.injector.get(Te,null),this.messageService=this.frameContext.injector.get(Fe,null),this.loadingService=this.frameContext.injector.get(W,null),this.languageService=this.frameContext.injector.get($,null),this.befRepository=this.frameContext.repository}var Wr,Hr=(Z(Kr,Wr=mr),Object.defineProperty(Kr.prototype,"hierarchyInfoKey",{get:function(){return this.virtualRootFrameContext.getParam("hierarchyInfoKey")},enumerable:!0,configurable:!0}),Object.defineProperty(Kr.prototype,"hierarchyInfoField",{get:function(){return this.hierarchyInfoKey.split("/").filter(function(e){return e}).pop()},enumerable:!0,configurable:!0}),Object.defineProperty(Kr.prototype,"virtualRootFrameContext",{get:function(){return this.frameContext.getVirtualRootFrameContext()},enumerable:!0,configurable:!0}),Object.defineProperty(Kr.prototype,"messagePipe",{get:function(){if(this.viewModel&&this.viewModel.frameContext){var e=this.viewModel.frameContext.getFormAppContext()||null;if(e)return e.messagePipe||null}return null},enumerable:!0,configurable:!0}),Kr.prototype.addSubSibling=function(){var t=this;this.messagePipe&&this.messagePipe.next({messageType:"addSubSibling"});var e=this.getParams(),r=this.getHierarchyType(),i=this.loadingService.showLoadingWithDelay(500),n=Tr.getInstance(r);if(!n)throw new Error(this.languageService.errorHierarchyKey);return n.addSubSibling(this.repository,e.nodeCodes,e.ids).pipe(N.tap(function(){t.loadingService.hideDelayLoading(i)},function(e){t.errorService.exception(t.languageService.addSubSiblingFailed,e)}))},Kr.prototype.addSubChild=function(){var t=this;this.messagePipe&&this.messagePipe.next({messageType:"addSubChild"});var e=this.getParams(),r=this.getHierarchyType();if(!(this.frameContext&&this.frameContext.bindingData&&this.frameContext.bindingData.getList()).currentId)return this.formNotifyService.warning(this.languageService.plsSelectParentNode,{hideTitle:!0}),O.EMPTY;var i=this.loadingService.showLoadingWithDelay(500),n=Tr.getInstance(r);if(!n)throw new Error(this.languageService.errorHierarchyKey);return n.addSubChild(this.repository,e.nodeCodes,e.ids).pipe(N.tap(function(){t.loadingService.hideDelayLoading(i)},function(e){t.loadingService.hideDelayLoading(i),t.errorService.exception(t.languageService.addSubChildFailed,e)}))},Kr.prototype.remove=function(n,o){var a=this;if(!n)return this.formNotifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),O.EMPTY;var e=this.getHierarchyType(),s=this.frameContext.bindingData.getList().toJSON(),c=this.frameContext.bindingData.getList(),u=xr.getInstance(e);return null===u?O.EMPTY:!0===u.hasChildNodes(s,this.hierarchyInfoField,n)?(this.messageService.warning(this.languageService.deleteChildFirst),O.EMPTY):this.messageService.question(this.languageService.confirmDeletion).pipe(N.concatMap(function(e){if(!e)return O.EMPTY;var r=u.getNextNodeId(s,a.hierarchyInfoField,n),i=a.loadingService.show(),t=a.getPath();return a.frameContext.repository.removeByPath(t,n).pipe(N.tap(function(){if(u.selectNodeByBindingList(c,a.hierarchyInfoField,r),a.loadingService.hideDelayLoading(i),o&&o.trim()){var e=!0;if(o.startsWith("{")&&o.endsWith("}"))try{!1===JSON.parse(o).showMessage&&(e=!1)}catch(t){}!1!==e&&a.formNotifyService.success(o,{hideTitle:!0})}else a.formNotifyService.success(a.languageService.deleteSuccess,{hideTitle:!0})},function(e){a.loadingService.hideDelayLoading(i),a.errorService.exception(a.languageService.deleteFailed,e)}))}))},Kr.prototype.getHierarchyType=function(){var e=this.repository.entityTypeInfo.getPropInfoByPath(this.hierarchyInfoKey.split("/")).metadataInfo.hierarchyType||null;if(null==e||e.length<1)throw new Error(this.languageService.incorrectHierarchyConfig);return e},Kr.prototype.getParams=function(){var e=this.viewModel.bindingPath.substr(1).split("/"),t=[],r=[],i=this.viewModel.bindingData.list.currentId;t.push(i);var n=this.viewModel.bindingData;return 0<e.length&&e.map(function(e){(n=n[e])&&n.currentId&&t.push(n.currentId),e?r.push(e.substring(0,e.length-1)):r.push(e)}),{nodeCodes:r,ids:t}},Kr.prototype.getPath=function(){var e=this.viewModel.bindingPath,t="/"+this.viewModel.bindingData.list.currentId,r=e.split("/").filter(function(e){return e});if(0<r.length)for(var i=this.viewModel.bindingData,n=1;n<r.length-1;n++){var o=r[n];if(!(i=i[o])||!i.currentId)throw Error("获取子表完整路径出错，找不到"+i+"对应的子表，或对应子表没有当前行。");t+="/"+o+"/"+i.currentId}return t+="/"+r[r.length-1]},Kr.decorators=[{type:k.Injectable}],Kr.ctorParameters=function(){return[{type:V.FrameContext},{type:V.ViewModel},{type:Fe},{type:W},{type:Pe},{type:Te},{type:$,decorators:[{type:k.Optional}]}]},Kr);function Kr(e,t,r,i,n,o,a){var s=Wr.call(this,e)||this;return s.viewModel=t,s.messageService=r,s.loadingService=i,s.errorService=n,s.formNotifyService=o,(s.languageService=a)||(s.languageService=$.getInstance()),s}var zr=(Jr.prototype.invokeAction=function(e,t,r,i,n){return this.innerInvokeAction(e,t,r,i,n,!0)},Jr.prototype.executeAction=function(e,t,r,i,n){return this.innerInvokeAction(e,t,r,i,n,!1)},Jr.prototype.buildQueryParams=function(t){"string"==typeof t&&(t=JSON.parse(t));var r="";return Object.keys(t).forEach(function(e){r+=e+"="+t[e]}),r},Jr.prototype.getRestService=function(){return this.repository.restService},Jr.prototype.innerInvokeAction=function(e,t,r,i,n,o){var a=this,s={},c=this.getRestService(),u=c.baseUri+"/service/"+e;if(i&&""!==i){var l=this.buildQueryParams(i);u+=l}return n&&""!==n&&("string"==typeof n&&n.startsWith("{")&&n.endsWith("}")&&(n=JSON.parse(n)),s.body=n),r&&""!==r?((r=JSON.parse(r))["Content-Type"]||(r["Content-Type"]="application/json"),s.headers=new P.HttpHeaders(r)):s.headers=new P.HttpHeaders({"Content-Type":"application/json"}),this.loadingService.show(),c[o?"invoke":"request"](u,t,null,s).pipe(N.tap(function(){a.loadingService.hide()},function(e){a.loadingService.hide();var t=u+a.languageService.operationFailed;a.formErrorService.exception(t,e)}))},Jr.decorators=[{type:k.Injectable}],Jr.ctorParameters=function(){return[{type:V.Repository},{type:W},{type:Fe},{type:Te},{type:Pe},{type:$,decorators:[{type:k.Optional}]}]},Jr);function Jr(e,t,r,i,n,o){this.repository=e,this.loadingService=t,this.msgService=r,this.notifyService=i,this.formErrorService=n,this.languageService=o,this.languageService||(this.languageService=$.getInstance())}var Yr=(Gr.prototype.submitApproveWithInteraction=function(e){return this.submitApprove(e)},Gr.prototype.submitApprove=function(i,e){var n=this;if(!i)return this.notifyService.info(this.languageService.unallowEmptyBizBillId,{hideTitle:!0}),O.empty();var t={requestInfo:this.beActionService.getRestService().buildRequestInfo(),bizInstID:i,interactionResult:e?{procDefId:e.processDefinitionId}:{}};return this.formLoadingService.show(),this.beActionService.invokeAction("submittoapprovevoaction","PUT",null,null,t).pipe(N.map(function(e){if(e&&e.returnValue&&e.returnValue.excutionResponse)return e.returnValue.excutionResponse}),N.switchMap(function(e){return e&&e.procInstId?n.repository?n.repository.updateById(i).pipe(N.tap(function(){n.formLoadingService.hide(),ut.success(n.notifyService,n.languageService.submitSuccess)}),N.map(function(){return e})):(n.formLoadingService.hide(),ut.success(n.notifyService,n.languageService.submitSuccess),O.of(e)):O.of(e)}),N.switchMap(function(r){return r.needInteraction?O.from(new Promise(function(t){n.submitter.excute(r,function(e){!r.procInstId&&e.processDefinitionId?n.submitApprove(i,e).subscribe(function(){t()}):t()})})):O.of(null)}),N.catchError(function(e){return n.formLoadingService.hide(),O.of(e)}))},Gr.prototype.submitApproveWithBizDefKey=function(i,n,o,e){var a=this;if(!i)return this.notifyService.warning(this.languageService.unallowEmptyBizBillId,{hideTitle:!0}),O.EMPTY;if(!n)return this.notifyService.warning(this.languageService.bizDefKeyRequired,{hideTitle:!0}),O.EMPTY;try{o&&"string"==typeof o&&(o=JSON.parse(o))}catch(r){throw new Error("ArgumentError:options not a valid json string.")}var t={requestInfo:this.beActionService.getRestService().buildRequestInfo(),approvePayload:{startProcessPayload:{bizDefKey:n,dataId:i,name:o&&o.name||"",variables:o&&o.variables||{}}}};return e&&(t.approvePayload.startProcessPayload.processDefinitionId=e.processDefinitionId,t.approvePayload.startProcessPayload.processDefinitionKey=e.processDefinitionKey),this.formLoadingService.show(),this.beActionService.invokeAction("submittoapprovewithpayload","PUT",null,null,t).pipe(N.map(function(e){if(e&&e.returnValue&&e.returnValue.excutionResponse)return e.returnValue.excutionResponse}),N.switchMap(function(e){return e&&e.procInstId?a.repository?a.repository.updateById(i).pipe(N.tap(function(){a.formLoadingService.hide(),ut.success(a.notifyService,a.languageService.submitSuccess)}),N.map(function(){return e})):(a.formLoadingService.hide(),ut.success(a.notifyService,a.languageService.submitSuccess),O.of(e)):O.of(e)}),N.switchMap(function(r){return r.needInteraction?O.from(new Promise(function(t){a.submitter.excute(r,function(e){!r.procInstId&&e.processDefinitionId?a.submitApproveWithBizDefKey(i,n,o,e).subscribe(function(){t()}):t()})})):O.of(null)}),N.catchError(function(e){return a.formLoadingService.hide(),O.of(e)}))},Gr.prototype.submitApproveWithBizDefKeyUseControl=function(e,t,r,i){if(void 0===r&&(r={}),!e)return this.notifyService.warning(this.languageService.unallowEmptyBizBillId,{hideTitle:!0}),O.EMPTY;if(!t)return this.notifyService.warning(this.languageService.bizDefKeyRequired,{hideTitle:!0}),O.EMPTY;r&&"object"==typeof r||(r={});var n=ee({dataId:e,bizDefKey:t},r);if(i){if(i.startsWith("{")&&i.endsWith("}"))try{i=JSON.parse(i)}catch(o){i={}}n.variables=i}return this.wfTaskHandlerService&&this.wfTaskHandlerService.startProcess(n)},Gr.prototype.childSubmitApproveWithBizDefKey=function(e,t,r,i,n){if(void 0===i&&(i={}),!e)return this.notifyService.warning(this.languageService.bizDefKeyRequired,{hideTitle:!0}),O.EMPTY;if(!t)return this.notifyService.warning(this.languageService.unallowEmptyBizBillId,{hideTitle:!0}),O.EMPTY;if(!r)return this.notifyService.warning(this.languageService.unallowEmptyChildBizBillId,{hideTitle:!0}),O.EMPTY;i&&"object"==typeof i||(i={});var o=ee({dataId:t+","+r,bizDefKey:e},i);if(n){if(n.startsWith("{")&&n.endsWith("}"))try{n=JSON.parse(n)}catch(a){n={}}o.variables=n}return this.wfTaskHandlerService&&this.wfTaskHandlerService.startProcess(o)},Gr.prototype.cancelApprove=function(e){var t=this;if(!e)return this.notifyService.warning(this.languageService.unallowEmptyBizBillId,{hideTitle:!0}),O.empty();var r={requestInfo:this.beActionService.getRestService().buildRequestInfo(),bizInstID:e};return this.formLoadingService.show(),this.beActionService.executeAction("canceltosubmitvoaction","PUT",null,null,r).pipe(N.switchMap(function(){return t.repository?t.repository.updateById(e).pipe(N.tap(function(){t.formLoadingService.hide(),ut.success(t.notifyService,t.languageService.cancelApproveSuccess)})):(t.formLoadingService.hide(),ut.success(t.notifyService,t.languageService.cancelApproveSuccess),O.of())}),N.catchError(function(e){return t.formLoadingService.hide(),O.of(e)}))},Gr.prototype.cancelSubmit=function(e){return e?this.wfTaskHandlerService&&this.wfTaskHandlerService.cancelSubmit({procInstId:e}):(this.notifyService.warning(this.languageService.procInsIdRequired,{hideTitle:!0}),O.EMPTY)},Gr.prototype.viewProcess=function(e){if(this.flowchartService)return e?this.flowchartService.viewFlowChart(e):void this.notifyService.warning(this.languageService.noProcessInstanceId,{hideTitle:!0})},Gr.prototype.switchPrefixLetter=function(e,t){var r,i;if("object"==typeof e&&e)if(Array.isArray(e))for(var n=0;n<e.length;n++)this.switchPrefixLetter(e[n],t);else try{for(var o=te(Object.keys(e)),a=o.next();!a.done;a=o.next()){var s=a.value;e[(t?s.substring(0,1).toUpperCase():s.substring(0,1).toLowerCase())+s.substring(1)]=e[s],"object"==typeof e[s]&&this.switchPrefixLetter(e[s],t),delete e[s]}}catch(c){r={error:c}}finally{try{a&&!a.done&&(i=o["return"])&&i.call(o)}finally{if(r)throw r.error}}return e},Gr.decorators=[{type:k.Injectable}],Gr.ctorParameters=function(){return[{type:W},{type:zr},{type:Fe},{type:Te},{type:$,decorators:[{type:k.Optional}]},{type:Pe},{type:V.FrameContext},{type:l.WFSubmiteService,decorators:[{type:k.Optional}]},{type:p.WFFlowchartService,decorators:[{type:k.Optional}]},{type:L.WfTaskHandlerService,decorators:[{type:k.Optional}]}]},Gr);function Gr(e,t,r,i,n,o,a,s,c,u){this.formLoadingService=e,this.beActionService=t,this.msgService=r,this.notifyService=i,this.languageService=n,this.formErrorService=o,this.frameContext=a,this.submitter=s,this.flowchartService=c,this.wfTaskHandlerService=u,this.frameContext&&(this.repository=this.frameContext.repository,this.wfTaskHandlerService||(this.wfTaskHandlerService=this.frameContext.injector.get(L.WfTaskHandlerService,null)))}var $r=(Qr.prototype.printSingle=function(e,t){return t?this.printArray(e,[t]):(this.showWarning(this.languageService.unallowEmptyBizBillId),O.EMPTY)},Qr.prototype.printByIds=function(e,t){if(!t)return this.showWarning(this.languageService.unallowEmptyBizBillId),O.EMPTY;var r=t.split(",").filter(function(e){return e});return this.printArray(e,r)},Qr.prototype.printByIdsWithDimension=function(e,t,r,i,n){if(!t)return this.showWarning(this.languageService.unallowEmptyBizBillId),O.EMPTY;var o=t.split(",").filter(function(e){return e});return this.printArray(e,o,r,i,n)},Qr.prototype.printArray=function(e,t,r,i,n){if(!t||0===t.length)return this.showWarning(this.languageService.unallowEmptyBizBillId),O.EMPTY;var o=this.buildSourceOptions({dataIds:t,sourceId:e}),a=this.buildOutputOptions();return void 0!==r&&(o.FirstDimensionVal=r),void 0!==i&&(o.SecondDimensionVal=i),void 0!==n&&(o.billCategoryId=n),this.printService.outputBEData(o,a,"tab")},Qr.prototype.printMulti=function(e,t,r,i){void 0===i&&(i=!0);var n={isUsePagination:!1,filterConditions:[],sortConditions:[],pagination:null};if(t){var o=JSON.parse(t);o&&0<o.length&&(o[o.length-1].Relation=0),n.filterConditions=o}r&&(n.sortConditions=JSON.parse(r));var a=this.buildSourceFilterOptions({sourceId:e,entryFilter:n,includeChildData:i}),s=this.buildOutputOptions();return this.printService.outputBEDataWithFilter(a,s,"tab")},Qr.prototype.printMultiWithDimension=function(e,t,r,i,n,o,a){void 0===a&&(a=!0);var s={isUsePagination:!1,filterConditions:[],sortConditions:[],pagination:null};if(t){var c=JSON.parse(t);c&&0<c.length&&(c[c.length-1].Relation=0),s.filterConditions=c}r&&(s.sortConditions=JSON.parse(r));var u=this.buildSourceFilterOptions({sourceId:e,entryFilter:s,includeChildData:a});void 0!==i&&(u.FirstDimensionVal=i),void 0!==n&&(u.SecondDimensionVal=n),void 0!==o&&(u.billCategoryId=o);var l=this.buildOutputOptions();return this.printService.outputBEDataWithFilter(u,l,"tab")},Qr.prototype.buildSourceOptions=function(e){return{DataIds:e&&e.dataIds||undefined,SourceId:e&&e.sourceId||undefined,FirstDimensionVal:e&&e.dim1||undefined,SecondDimensionVal:e&&e.dim2||undefined,RetrieveParam:e&&e.retrieveParam||undefined,FormatId:e&&e.formatId||undefined,billCategoryId:e&&e.billCategoryId||undefined,ServiceUnit:e&&e.serviceUnit||undefined,currentPage:e&&e.currentPage||undefined,pageRowCount:e&&e.pageRowCount||undefined,queryType:e&&e.queryType||undefined,queryServiceId:e&&e.queryServiceId||undefined,queryParam:e&&e.queryParam||undefined}},Qr.prototype.buildOutputOptions=function(e){return{OutputType:e&&e.outputType||d.OutputType.PRINT,FileType:e&&e.fileType||d.FileType.Html5,Path:e&&e.path||undefined,DeviceId:e&&e.deviceId||undefined,printJob:e&&e.printJob||undefined,printerName:e&&e.printerName||undefined,printSetting:e&&e.printSetting||undefined,printType:e&&e.printType||d.PrintType.Form}},Qr.prototype.buildSourceFilterOptions=function(e){return{SourceId:e.sourceId,EntityFilter:e&&e.entryFilter||{isUsePagination:!1,filterConditions:[],sortConditions:[],pagination:null},FirstDimensionVal:e&&e.dim1||undefined,SecondDimensionVal:e&&e.dim2||undefined,FormatId:e&&e.formatId||undefined,ServiceUnit:e&&e.serviceUnit||undefined,billCategoryId:e&&e.billCategoryId||undefined,currentPage:e&&e.currentPage||undefined,pageRowCount:e&&e.pageRowCount||undefined,queryParam:e&&e.queryParam||undefined,queryServiceId:e&&e.queryServiceId||undefined,queryType:e&&e.queryType||undefined,includeChildData:!e||!e.hasOwnProperty("includeChildData")||e.includeChildData}},Qr.prototype.showWarning=function(e){this.notifyService?this.notifyService.warning(e,{hideTitle:!0}):this.msgService&&this.msgService.error(e)},Object.defineProperty(Qr.prototype,"notifyService",{get:function(){return this.formNotifyService?this.formNotifyService:this.injector?this.injector.get(Te,null):null},enumerable:!0,configurable:!0}),Object.defineProperty(Qr.prototype,"commandContext",{get:function(){return this.context||null},enumerable:!0,configurable:!0}),Object.defineProperty(Qr.prototype,"frameContext",{get:function(){return this.commandContext&&this.commandContext.frameContext||null},enumerable:!0,configurable:!0}),Object.defineProperty(Qr.prototype,"injector",{get:function(){return this.frameContext&&this.frameContext.injector||null},enumerable:!0,configurable:!0}),Qr.decorators=[{type:k.Injectable}],Qr.ctorParameters=function(){return[{type:Fe},{type:$},{type:d.CloudprintService},{type:Te,decorators:[{type:k.Optional}]}]},Qr);function Qr(e,t,r,i){this.msgService=e,this.languageService=t,this.printService=r,this.formNotifyService=i}var Xr="fileSortOrder",Zr=(ei.convertToAttachmentInfos=function(e){var t=this;return e?e.map(function(e){return t.convertToAttachmentInfo(e)}):[]},ei.convertToAttachmentInfo=function(e){return{attachmentId:e.metadataId,fileName:e.fileName}},ei.getFirstAttachmentInfo=function(e){if(e&&0!==e.length)return e[0]},ei.peekAttachmentIds=function(e){return(e=e||[]).map(function(e){return e.attachmentId})},ei);function ei(){}var ti=(Object.defineProperty(ri.prototype,"repository",{get:function(){return this.frameContext.repository},enumerable:!0,configurable:!0}),Object.defineProperty(ri.prototype,"bindingData",{get:function(){return this.frameContext.bindingData},enumerable:!0,configurable:!0}),ri.prototype.updateRow=function(e,t){var r=this,i=this.repository.restService,n=i.baseUri+"/service/updateattachment",o={body:{updateAttachInfo:this.createUpdateAttachInfo(e,t),requestInfo:i.buildRequestInfo()}};return this.loadingService.show(),i.invoke(n,"PUT",null,o).pipe(N.switchMap(function(e){return r.syncAttachmentInfosToClient()}),N.tap(function(){r.loadingService.hide()}))},ri.prototype.updateRowWithPropertyName=function(e,t){var r=this,i=this.repository.restService,n=i.baseUri+"/service/updateattachmentwithproptyname",o={body:{updateAttachInfo:this.createUpdateAttachInfo(e,t),propertyName:e.split("/").filter(function(e){return e}).pop(),requestInfo:i.buildRequestInfo()}};return this.loadingService.show(),i.invoke(n,"PUT",null,o).pipe(N.switchMap(function(e){return r.syncAttachmentInfosToClient()}),N.tap(function(){r.loadingService.hide()}))},ri.prototype.removeAttachment=function(e,t){var r=this,i=this.repository.restService,n=i.baseUri+"/service/deleteattachment",o=this.createUpdateAttachInfo(e,t),a=e.split("/").filter(function(e){return e}).pop(),s={body:{deleteAttachInfo:o,requestInfo:i.buildRequestInfo(),propertyName:a}};return this.loadingService.show(),i.invoke(n,"PUT",null,s).pipe(N.switchMap(function(e){return r.syncAttachmentInfosToClient()}),N.tap(function(){r.loadingService.hide()}))},ri.prototype.updateRows=function(e,t){var r=this,i=this.repository.restService,n=i.baseUri+"/service/batchuploadattachment",o=this.createBatchCreateAttachInfo(e,t),a=0===o.NodeCodes.length,s={body:{batchUploadInfo:o,requestInfo:i.buildRequestInfo()}};return i.invoke(n,"PUT",null,s).pipe(N.switchMap(function(e){return r.appendAttachmentInfosToClient(e.returnValue,a)}),N.tap(function(){r.loadingService.hide()}))},ri.prototype.updateRowsWithConfigs=function(e,t,r){var i=this,n=this.repository.restService,o=n.baseUri+"/service/batchuploadattachment",a={body:{batchUploadInfo:this.createBatchCreateAttachInfo(e,t),requestInfo:n.buildRequestInfo()}};return n.invoke(o,"PUT",null,a).pipe(N.switchMap(function(e){return i.appendAttachmentInfos(e.returnValue,r)}),N.tap(function(){i.loadingService.hide()}))},ri.prototype.updateRowsWithPropertyName=function(e,t){var r=this,i=this.repository.restService,n=i.baseUri+"/service/batchuploadattachmentwithproptyname",o=this.createBatchCreateAttachInfo(e,t),a=0===o.NodeCodes.length,s={body:{batchUploadInfo:o,propertyName:e.split("/").filter(function(e){return e}).pop(),requestInfo:i.buildRequestInfo()}};return i.invoke(n,"PUT",null,s).pipe(N.switchMap(function(e){return r.appendAttachmentInfosToClient(e.returnValue,a)}),N.tap(function(){r.loadingService.hide()}))},ri.prototype.createUpdateAttachInfo=function(e,t){var r=t.attachmentId,i=V.BindingPathConverter.toBindingPathArray(e);return i.pop(),{NodeCodes:w.BefDataPathUtil.convertToObjectCodes(i,this.bindingData),HiretryIds:w.BefDataPathUtil.convertToDataIdsForUpdate(i,this.bindingData),AttachmentIds:[r],AttachmentId:r}},ri.prototype.createBatchCreateAttachInfo=function(e,t){var r=Zr.peekAttachmentIds(t),i=V.BindingPathConverter.toBindingPathArray(e);return i.pop(),{NodeCodes:w.BefDataPathUtil.convertToObjectCodes(i,this.bindingData),HiretryIds:w.BefDataPathUtil.convertToDataIdsForAdd(i,this.bindingData),AttachmentIds:r,AttachmentId:null}},ri.prototype.syncAttachmentInfosToClient=function(){var e=this.bindingData.list.currentId;return this.repository.updateEntityById(e)},ri.prototype.appendAttachmentInfosToClient=function(e,t){if(!0===t){var r=this.repository.buildEntities(e);return this.repository.entityCollection.addEntities(r),O.of(e)}var i=this.bindingData.list.currentId;return this.repository.updateEntityById(i).pipe(N.map(function(){return e}))},ri.prototype.appendAttachmentInfos=function(e,t){var r=this.repository.buildEntities(e);return this.repository.entityCollection.addEntities(r),this.updateEntities(r,t),O.of(e)},ri.prototype.updateEntities=function(e,t){var r=this;e.forEach(function(e){r.updateEntity(e,t)})},ri.prototype.updateEntity=function(t,r){var i=this;Object.keys(r).forEach(function(e){i.setValueByPath(t,e,r[e])})},ri.prototype.setValueByPath=function(e,t,r){if(e){var i=t.split(".");i.length<=1?e[t]=r:i.slice(0,-1).reduce(function(e,t){return e.hasOwnProperty(t)||e.__proto__.hasOwnProperty(t)||(e[t]={}),e[t]},e)[i[i.length-1]]=r}},ri.decorators=[{type:k.Injectable}],ri.ctorParameters=function(){return[{type:V.FrameContext},{type:W}]},ri);function ri(e,t){this.frameContext=e,this.loadingService=t}var ii=(Object.defineProperty(ni.prototype,"defaultParentDirName",{get:function(){return this.frameContext.bindingData.list.currentId},enumerable:!0,configurable:!0}),Object.defineProperty(ni.prototype,"bindingData",{get:function(){return this.frameContext.bindingData},enumerable:!0,configurable:!0}),ni.prototype.setLanguageService=function(){var e=this.frameContext.injector;this.languageService=e.get($,null,k.InjectFlags.Optional),this.languageService||(this.languageService=$.getInstance())},ni.prototype.uploadAndUpdateRow=function(i,e,t,r,n){var o=this,a=e||this.defaultRootDirId,s=t||this.defaultParentDirName;if(!a||!s)throw new Error("rootDirId和parentDirName不能为空，请填写");var c=new E.UploadLimit;c.fileCount=1,r&&(c.fileType=r);var u=[],l=null;if(n){var p=this.frameContext.bindingData.getList();p.currentId!==n&&p.setCurrentId(n,!0,!0),l=this.getSpecialRow(i,n)}else l=this.getCurrentRow(i);if(!l||!l.primaryKeyValue)return this.notifyService.warning(this.languageService.plsSelectUpdateRow,{hideTitle:!0}),O.EMPTY;var d=this.getAttachmentIdsByPathAndDataIds(i,[l.primaryKeyValue]);return d&&0<d.length&&u.push.apply(u,d),O.from(this.uploadDialogService.uploadFileWithLimit(s,a,c,u)).pipe(N.switchMap(function(e){if(!e||0===e.length)return o.notifyService.warning(o.languageService.plsUploadFirst,{hideTitle:!0}),O.empty();if(0===(e=e.filter(function(e){return!e.hasOwnProperty("state")||e.state===E.FileState.New})).length)return O.of(!0);var t=Zr.convertToAttachmentInfos(e),r=Zr.getFirstAttachmentInfo(t);return o.attachDataService.updateRow(i,r)}))},ni.prototype.uploadAndUpdateRowWithPropertyName=function(i,e,t,r,n){var o=this,a=e||this.defaultRootDirId,s=t||this.defaultParentDirName;if(!a||!s)throw new Error("rootDirId和parentDirName不能为空，请填写");var c=new E.UploadLimit;c.fileCount=1,r&&(c.fileType=r);var u=[],l=null;if(n){var p=this.frameContext.bindingData.getList();p.currentId!==n&&p.setCurrentId(n,!0,!0),l=this.getSpecialRow(i,n)}else l=this.getCurrentRow(i);if(!l||!l.primaryKeyValue)return this.notifyService.warning(this.languageService.plsSelectUpdateRow,{hideTitle:!0}),O.EMPTY;var d=this.getAttachmentIdsByPathAndDataIds(i,[l.primaryKeyValue]);return d&&0<d.length&&u.push.apply(u,d),O.from(this.uploadDialogService.uploadFileWithLimit(s,a,c,u)).pipe(N.switchMap(function(e){if(!e||0===e.length)return o.notifyService.warning(o.languageService.plsUploadFirst,{hideTitle:!0}),O.EMPTY;if(0===(e=e.filter(function(e){return!e.hasOwnProperty("state")||e.state===E.FileState.New})).length)return O.of(!0);var t=Zr.convertToAttachmentInfos(e),r=Zr.getFirstAttachmentInfo(t);return o.attachDataService.updateRowWithPropertyName(i,r)}))},ni.prototype.uploadAndBatchAddRows=function(r,e,t,i){var n=this,o=e||this.defaultRootDirId,a=t||this.defaultParentDirName;if(!o||!a)throw new Error("rootDirId和parentDirName不能为空，请填写");var s=new E.UploadLimit;return i&&(s.fileType=i),O.from(this.uploadDialogService.uploadFileWithLimit(a,o,s)).pipe(N.switchMap(function(e){if(!e||0===e.length)return n.notifyService.warning(n.languageService.plsUploadFirst,{hideTitle:!0}),O.EMPTY;if(0===(e=e.filter(function(e){return!e.hasOwnProperty("state")||e.state===E.FileState.New})).length)return O.of(!0);var t=Zr.convertToAttachmentInfos(e);return n.attachDataService.updateRows(r,t)}))},ni.prototype.uploadAndBatchAddRowsWithPropertyName=function(r,e,t,i,n){var o=this,a=e||this.defaultRootDirId,s=t||this.defaultParentDirName;if(!a||!s)throw new Error("rootDirId和parentDirName不能为空，请填写");var c=new E.UploadLimit;if(i&&(c.fileType=i),n){var u=this.frameContext.bindingData.getList();u.currentId!==n&&u.setCurrentId(n,!0,!0)}return O.from(this.uploadDialogService.uploadFileWithLimit(s,a,c)).pipe(N.switchMap(function(e){if(!e||0===e.length)return o.notifyService.warning(o.languageService.plsUploadFirst,{hideTitle:!0}),O.EMPTY;if(0===(e=e.filter(function(e){return!e.hasOwnProperty("state")||e.state===E.FileState.New})).length)return O.of(!0);var t=Zr.convertToAttachmentInfos(e);return o.attachDataService.updateRowsWithPropertyName(r,t)}))},ni.prototype.download=function(e,t){if(!e)return this.notifyService.warning(this.languageService.plsSelectDownloadAtt,{hideTitle:!0}),O.EMPTY;t=t||"default-root";var r=this.getDownloadUrl([e],t);return window.open(r),O.of(!0)},ni.prototype.batchDownload=function(e,t){if(!e||0===e.length)return this.notifyService.warning(this.languageService.plsSelectDownloadAtt,{hideTitle:!0}),O.EMPTY;if(1===e.length)return this.download(e[0],t);var r=this.getDownloadUrl(e,t);return window.open(r),O.of(!0)},ni.prototype.getDownloadUrl=function(e,t){if(t=t||"default-root",this.downloadService){if(1===e.length)return this.downloadService.getDownloadUrl(e[0],t);var r=JSON.stringify(e);return this.downloadService.getMultipleDownloadUrl(r,t)}return console.warn("因安全问题，附件下载提供安全校验机制，附件下载功能需重新编译。"),1===e.length?M.BasePathService.convertPath("/api/runtime/dfs/v1.0/formdoc/filecontent?metadataid="+e[0]+"&rootid="+t):(r=JSON.stringify(e),M.BasePathService.convertPath("/api/runtime/dfs/v1.0/formdoc/multiple/download?metadataidlist="+r+"&rootid="+t))},ni.prototype.downloadByDataId=function(e,t,r){if(!e)return this.notifyService.warning(this.languageService.plsSelectDownloadAtt,{hideTitle:!0}),O.EMPTY;var i=[e],n=this.getAttachmentIdsByPathAndDataIds(t,i);if(0===n.length)return this.notifyService.warning(this.languageService.noDownloadAtt,{hideTitle:!0}),O.EMPTY;var o=n[0];return this.download(o)},ni.prototype.batchDownloadByDataIds=function(e,t,r){if("string"==typeof e&&e&&0<e.length&&(e=e.split(",").filter(function(e){return e})),!e||!1===Array.isArray(e)||0===e.length)return this.notifyService.warning(this.languageService.plsSelectDownloadAtt,{hideTitle:!0}),O.EMPTY;var i=[].concat(e),n=this.getAttachmentIdsByPathAndDataIds(t,i);return 0===n.length?(this.notifyService.warning(this.languageService.noDownloadAtt,{hideTitle:!0}),O.EMPTY):this.batchDownload(n,r)},ni.prototype.previewByAttachmentInfoFieldPath=function(e,t,r){if(!e||!t)throw new Error("attachmentInfoFieldPath和rootDirId不能为空，请填写");var i=[],n=[];return(i=r&&0<r.length?("string"==typeof r?n.push(r):n=r,this.getAttachmentIdsByPathAndDataIds(e,n)):this.getAttachmentIdsByPathAndDataIds(e,null))&&0===i.length?(this.notifyService.warning(this.languageService.noAttachment,{hideTitle:!0}),O.EMPTY):this.previewByAttachmentIds(i,t)},ni.prototype.previewByAttachmentInfoFieldPathWithIndex=function(e,t){if(!e||!t)throw new Error("attachmentInfoFieldPath和rootDirId不能为空，请填写");var r=this.getCurrentRow(e),i=V.BindingPathConverter.toBindingPathArray(e).pop();if(!r[i]||!r[i].attachmentId)return this.notifyService.warning(this.languageService.noAttachment,{hideTitle:!0}),O.EMPTY;var n=this.getAttachmentIdsByPathAndDataIds(e,null);if(n&&0===n.length)return this.notifyService.warning(this.languageService.noAttachment,{hideTitle:!0}),O.EMPTY;var o=this.getCurrentAttachmentId(e);if(o)return this.previewFileListWithIndex(n,t,o);throw new Error("要预览的附件id不存在，请确认")},ni.prototype.previewBySubDirName=function(e,t){if(!e||!t)throw new Error("subDirName和rootDirId不能为空，请填写");return O.from(this.fileViewerService.viewerFormFile(e,t))},ni.prototype.previewBySubDirNameWithIndex=function(e,t,r){if(!t||!r)throw new Error("subDirName和rootDirId不能为空，请填写");var i=this.getCurrentAttachmentId(e);return i?O.from(this.fileViewerService.viewerFormFileWithIndex(t,r,i)):(this.notifyService.warning(this.languageService.noAttachment,{hideTitle:!0}),O.EMPTY)},ni.prototype.previewByAttachmentIds=function(e,t){return O.from(this.fileViewerService.viewerFileList(e,t))},ni.prototype.previewFileListWithIndex=function(e,t,r){return O.from(this.fileViewerService.viewerFileListWithIndex(e,t,r))},ni.prototype.genVersion=function(e){return"V"+((e=e||[]).length+1)+".0"},ni.prototype.updateAttachmentVersion=function(o,a,e){var s=this,t=e.split("/").filter(function(e){return e}),c=t.pop(),u=this.frameContext.bindingData.getValue(t),r=this.frameContext.repository.entityManager,l=V.DataPathCreator.createByShortPathFromRoot(t,r,this.frameContext.bindingData).toArray().map(function(e){return e.startsWith("PropName:")?e.split(":")[1]:e});if(u){var p=u.toJSON();p&&p.filter(function(e){return!e[o]}).forEach(function(e){var t=e[c].fileName,r=p.filter(function(e){return e[c].fileName===t&&e[o]});l.pop(),l.push("DataId:"+e[u.primaryKey]);var i=s.frameContext.repository.entityCollection.getEntityByPath(l),n=s.genVersion(r);i[o]=n,i[a]=!1,r.forEach(function(e){l.pop(),l.push("DataId:"+e[u.primaryKey]),(i=s.frameContext.repository.entityCollection.getEntityByPath(l))[a]=!0})})}},ni.prototype.isAttachmentCanDelete=function(e,t){var r=t.split("/").filter(function(e){return e});if(r.pop(),!0===this.frameContext.bindingData.getValue(r).currentItem[e])return this.notifyService.warning(this.languageService.historyAttachment,{hideTitle:!0}),O.EMPTY},ni.prototype.updateAttachmentHistory=function(i,r,e){var n=this,t=e.split("/").filter(function(e){return e}),o=t.pop(),a=this.frameContext.bindingData.getValue(t);if(a){var s=a.toJSON().filter(function(e){return e[i]}),c=new Map,u=this.frameContext.repository.entityManager,l=V.DataPathCreator.createByShortPathFromRoot(t,u,this.frameContext.bindingData).toArray().map(function(e){return e.startsWith("PropName:")?e.split(":")[1]:e});s.forEach(function(e){var t=e[o].fileName;c.has(t)?c.get(t).push(e):c.set(t,[e])}),Array.from(c.values()).forEach(function(e){e.sort(function(e,t){var r=parseInt(e[i].replace(/[a-zA-Z\.]/g,""));return parseInt(t[i].replace(/[a-zA-Z\.]/g,""))-r});var t=e[0];l.pop(),l.push("DataId:"+t[a.primaryKey]),n.frameContext.repository.entityCollection.getEntityByPath(l)[r]=!1})}},ni.prototype.removeAttachment=function(e,t,r){if(!r)throw new Error("rootDirId和parentDirName不能为空，请填写");var i=[t],n=this.getAttachmentIdsByPathAndDataIds(e,i);if(0===n.length)return this.notifyService.warning(this.languageService.plsSelectRemoveAtt,{hideTitle:!0}),O.EMPTY;var o=n[0];return this.attachDataService.removeAttachment(e,{attachmentId:o,fileName:null})},ni.prototype.getCurrentAttachmentId=function(e){var t=V.BindingPathConverter.toBindingPathArray(e),r=t.pop(),i=this.frameContext.bindingData.getValue(t).currentItem;return i&&i.primaryKeyValue&&i[r]&&i[r].attachmentId||null},ni.prototype.getCurrentRow=function(e){var t=V.BindingPathConverter.toBindingPathArray(e);t.pop();var r=this.frameContext.bindingData.getValue(t);return r&&r.currentItem},ni.prototype.getSpecialRow=function(e,t){var r=V.BindingPathConverter.toBindingPathArray(e);r.pop();var i=this.frameContext.bindingData.getValue(r);return i&&i.findById(t)},ni.prototype.getAttachmentIdsByPathAndDataIds=function(e,t){var r=V.BindingPathConverter.toBindingPathArray(e),i=r.pop(),n=this.entityService.getEntityListData(r),o=[];o=t&&!0===Array.isArray(t)?n.filter(function(e){return-1<t.indexOf(e.id)}):n;var a=[];return o.forEach(function(e){if(e[i]){var t=e[i].attachmentId;t&&a.push(t)}}),a},ni.decorators=[{type:k.Injectable}],ni.ctorParameters=function(){return[{type:V.FrameContext},{type:ti},{type:Te},{type:E.UploadDialogService},{type:E.DownloadService,decorators:[{type:k.Optional}]}]},ni);function ni(e,t,r,i,n){this.frameContext=e,this.attachDataService=t,this.notifyService=r,this.uploadDialogService=i,this.downloadService=n,this.defaultRootDirId="",this.setLanguageService(),this.fileViewerService=this.frameContext.injector.get(f.FileViewerService,null,k.InjectFlags.Optional),this.entityService=this.frameContext.injector.get(Jt,null,k.InjectFlags.Optional),this.downloadService||"undefined"==typeof E.DownloadService||(this.downloadService=this.frameContext.injector.get(E.DownloadService,null))}var oi=(ai.prototype.addFileRows=function(e){var t=this.getAttachmentInfosToAddFromContext();return 0===t.length&&this.notifyService.info("请先上传附件"),this.attachDataService.updateRows(e,t)},ai.prototype.addFileRowsWithConfigs=function(e,t){var r=this.getAttachmentInfosToAddFromContext();0===r.length&&this.notifyService.info("请先上传附件"),this.attachmentInfos=this.attachmentInfos.concat(r),this.subject.next({fileInfoFieldPath:e,configs:t})},ai.prototype.process=function(e,t){var r=this;if(this.attachmentInfos&&0<this.attachmentInfos.length){var i=this.attachmentInfos.concat([]),n=null;if("string"==typeof t&&(t=t.trim()),!t.startsWith("{")||!t.endsWith("}"))throw new Error("附件扩展信息配置不是合法的json字符串。");try{n=JSON.parse(t)}catch(o){throw new Error("附件扩展信息配置不是合法的json字符串。")}this.attachDataService.updateRowsWithConfigs(e,i,n).pipe(N.tap(function(){r.attachmentInfos=r.attachmentInfos.filter(function(t){return!i.find(function(e){return e.attachmentId===t.attachmentId})}),0<r.attachmentInfos.length&&r.process(e,t)})).subscribe()}},ai.prototype.getAttachmentInfosToAddFromContext=function(){var e=this.getFileExtendsFromContext();return this.convertToAttachmentInfos(e)},ai.prototype.convertToAttachmentInfos=function(e){if(!e)return[];var r=[];return e.forEach(function(e){var t={attachmentId:e.extend.metadataId,fileName:e.extend.fileName};r.push(t)}),r},ai.prototype.removeFileRows=function(e){var r=this,t=this.getDataIdsToRemoveFromContext(e);0===t.length&&this.notifyService.info("请选择要删除的附件");var i=2<=e.split("/").filter(function(e){return e}).length,n=[];return i?(t.forEach(function(e){var t;t=r.subListDataService.removeWithoutConfirm(e),n.push(t)}),O.forkJoin(n)):this.listDataService.removeRows(t,!1,null,!1)},ai.prototype.getDataIdsToRemoveFromContext=function(i){var n=this,e=this.getFileExtendsFromContext(),o=[];return e.forEach(function(e){var t=e.extend.metadataId,r=n.convertFileIdToDataId(t,i);o.push(r)}),o},ai.prototype.convertFileIdToDataId=function(t,e){var r=V.BindingPathConverter.toBindingPathArray(e),i=r.pop(),n=r;return this.entityService.getEntityListData(n).find(function(e){if(e[i]&&e[i].attachmentId===t)return!0}).id},ai.prototype.updateOrder=function(e,t){if(!e)throw new Error("附件udt字段路径参数不能为空");if(!t){var r=this.context;t=r&&r.eventParam&&r.eventParam.data}if(t&&Array.isArray(t)){var a=this.frameContext.bindingData.getList();if(a&&!(a.length<1)){var s=V.BindingPathConverter.toBindingPathArray(e).pop();if(!s)throw new Error("无法获取附件udt字段，请确认命令中附件udt字段路径配置正确，且视图模型中存在附件udt字段");var c=a.toJSON();t.forEach(function(t,e){var r=c.find(function(e){return e&&e[s]&&e[s].attachmentId===t}),i=r&&r.id;if(i){var n=a.findById(i);if(n){var o=n[s];o&&o.getValue(Xr)!==e&&o.setValue(Xr,e,!0,!0)}}})}}},ai.prototype.getFileExtendsFromContext=function(){var e=this.context.eventParam;return e?!1===Array.isArray(e)?[e]:e.concat([]):[]},ai.decorators=[{type:k.Injectable}],ai.ctorParameters=function(){return[{type:V.FrameContext},{type:ti},{type:Jt},{type:yr},{type:Te},{type:$},{type:hr},{type:W,decorators:[{type:k.Optional}]}]},ai);function ai(e,t,r,i,n,o,a,s){var c=this;this.frameContext=e,this.attachDataService=t,this.entityService=r,this.subListDataService=i,this.notifyService=n,this.languageService=o,this.listDataService=a,this.formLoadingService=s,this.subject=new O.Subject,this.subject.pipe(N.debounceTime(500)).subscribe(function(e){c.process(e.fileInfoFieldPath,e.configs)}),this.attachmentInfos=[]}var si=(ci.prototype.setLanguageService=function(){if(this.getFrameContext()){var e=this.frameContext.injector;this.languageService=e.get($,null,k.InjectFlags.Optional)}this.languageService||(this.languageService=$.getInstance())},ci.prototype.getFrameContext=function(){return this.frameContext?this.frameContext:this.context&&this.context.frameContext?this.context.frameContext:null},ci.prototype.getComponentFactoryResolver=function(){var e,t=this.getFrameContext();return t&&(e=t.injector.get(k.ComponentFactoryResolver)),e},ci.prototype.getObjectTypeConfig=function(e){var t;if("string"==typeof e)if(e.length)try{t=JSON.parse(e)}catch(r){throw new Error(e+"不是合法的json字符串")}else t={};else{if("object"!=typeof e)throw new Error("填写对象格式或json字符串");t=Object.assign({},e)}return t},ci.prototype.createModalComponentRef=function(e,t,r){var i,n,o=this.getFrameContext(),a=this.getComponentFactoryResolver();if(o&&a){var s=a.resolveComponentFactory(t),c=this.createInjector(this.refs,this.frameContext.injector),u=k.ReflectiveInjector.resolveAndCreate(ie(this._providers),c);(i=s.create(u))&&i.instance&&i.instance.viewModel&&i.instance.viewModel.uiState&&("object"==typeof r&&Object.keys(r).length&&Object.keys(r).forEach(function(e){i.instance.viewModel.uiState.setPropertyValue(e,r[e])}),i.instance.viewModel.uiState.setPropertyValue("DEVKIT_DIALOG",!0)),n=this.modalService.show(i,e)}else n=this.modalService.show(t,e);return n},ci.prototype.openModal=function(e,t,r,i){var n=this;void 0===e&&(e={}),void 0===r&&(r={});var o,a=this.getObjectTypeConfig(e),s=this.getObjectTypeConfig(r),c=this.farrisFormService.getControls(t),u={title:this.languageService.defaultDialogTitle,width:760,height:450,showButtons:!1},l=(u=Object.assign(u,a)).beforeClose,p=u.cancelChanges||!1;if(u.beforeClose=function(t){return l&&"function"==typeof l?l(t).pipe(N.switchMap(function(e){return e&&p?n.cancelChanges(t):O.of(e)})):p?n.cancelChanges(t):O.of(!0)},!u.remote){if(!c)return void console.error("获取控件失败，modalId="+t);if("string"==typeof c)u.dialogType="iframe",o=this.modalService.show(c,u);else if("function"==typeof c)o=this.createModalComponentRef(u,c,s);else if("object"==typeof c){if(c.useIsolateJs){var d={injector:this.createInjector(this.refs),uiState:s,modalService:this.modalService,dialogServiceInstance:this,eventBus:this.frameContext.getVirtualRootFrameContext().eventBus,componentCallback:this.componentModify,modalInstanceCallback:this.modalInstanceCallback.bind(this)};return c.modalInstance(u,d)}o=this.modalService.show(c,u)}return this.modalRef=o,(this.refs.modalRef=o)&&o.content&&(o.content.isDialogRootComponent=!0,o.content.dialogRef=o),o}this.createRemoteForm(u,s).subscribe(function(e){n.modalRef=e,(n.refs.modalRef=e)&&e.content&&(e.content.isDialogRootComponent=!0,e.content.dialogRef=e),i(e)})},ci.prototype.componentModify=function(t,r){t&&t.instance&&t.instance.viewModel&&t.instance.viewModel.uiState&&(r.uistate&&"string"==typeof r.uistate&&(r.uistate=JSON.parse(r.uistate)),"object"==typeof r.uistate&&Object.keys(r.uistate).length&&Object.keys(r.uistate).forEach(function(e){t.instance.viewModel.uiState.setPropertyValue(e,r.uistate[e])}),t.instance.viewModel.uiState.setPropertyValue("DEVKIT_DIALOG",!0))},ci.prototype.modalInstanceCallback=function(e,t,r){if(r&&r.modalService){var i=r.modalService.show(e,t);return this.modalRef=i,(this.refs.modalRef=i)&&i.content&&(i.content.isDialogRootComponent=!0,i.content.dialogRef=i),i}},ci.prototype.openHelpModal=function(t,e,r){var i=this,n=this.context.eventParam||{},o=n.event||n,a=n.options||n.editor&&n.editor.options||{},s=n&&n.context,c=new O.Subject,u=a.modalId,l=void 0===u?null:u;"string"==typeof(r=r||"{}")&&0<r.length&&(r=JSON.parse(r));var p=r||{},d=p.remote,f=void 0!==d&&d,h=p.currentRow,v=void 0!==h&&h,y=p.areaResponse,g=void 0===y?undefined:y;if(g!==undefined&&a.areaResponse===undefined&&(a.areaResponse=g),f){var m=r.mapFields||{};a.remote=f+"?v="+(new Date).valueOf(),this.openModal(a,l,e,function(e){i.modals[l]={subject:c,frameId:t,mapFields:m,dialogRef:e,currentRow:v,event:o,context:s}})}else{var S=this.openModal(a,l,e),C=a.mapFields||{};this.modals[l]={subject:c,frameId:t,mapFields:C,dialogRef:S,currentRow:v,event:o,context:s}}return c},ci.prototype.openCallbackableModal=function(t,e,r){var S=this;"string"==typeof(r=r||"{}")&&(r=JSON.parse(r));var i=this.context&&this.context.eventParam||{},C=i.options;C.showButtons=!0,C.buttons=[{text:this.languageService.cancel,cls:"btn",handle:function(e){return S.cancel(C)}},{text:this.languageService.confirm,cls:"btn btn-primary",handle:function(e){var t=(C||{}).modalId,r=void 0===t?null:t;if(r){var i=S.modals[r]||{},n=i.subject,o=void 0===n?null:n,a=i.dialogRef,s=void 0===a?null:a,c=i.frameId,u=void 0===c?null:c,l=i.handle,p=void 0===l?null:l,d=i.currentRow,f=void 0!==d&&d,h=s.content;if(!h)throw new Error("不支持的表单类型");var v=[];if(!0===f){var y=void 0;if(!(y=h.context?h.context.appContext.frameContextManager.getFrameContextById(u):h.appContext.frameContextManager.getFrameContextById(u)))throw new Error("无效的frameId："+u+"，请确认命令中frameId正确。");var g=y.bindingData.getList();v=[g&&g.currentItem&&g.currentItem.toJSON()]}else{var m=void 0;m=h.context?h.context.appContext.frameContextManager.getFrameContextById(u).uiState.rows||new Map:h.appContext.frameContextManager.getFrameContextById(u).uiState.rows||new Map,v=Array.from(m.values())}"function"==typeof p&&p(v),o&&o.next(),s.close(C)}}}];var n=new O.Subject,o=C.modalId,a=void 0===o?null:o,s=r.remote,c=void 0===s?null:s,u=r.currentRow,l=void 0!==u&&u,p=r.areaResponse,d=void 0===p?undefined:p,f=C.handle;if(d!==undefined&&C.areaResponse===undefined&&(C.areaResponse=d),c)C.remote=c+"?v="+(new Date).valueOf(),this.openModal(C,a,e,function(e){S.modals[a]={subject:n,frameId:t,dialogRef:e,handle:f,currentRow:l,event:i.event}});else{var h=this.openModal(C,a,e);this.modals[a]={subject:n,frameId:t,dialogRef:h,handle:f,currentRow:l,event:i.event}}return n},ci.prototype.confirm=function(){var o=this,e=(this.context&&this.context.eventParam||{}||{}).modalId,t=void 0===e?null:e;if(t){var r=this.modals[t]||{},i=r.subject,n=void 0===i?null:i,a=r.dialogRef,s=void 0===a?null:a,c=r.mapFields,u=void 0===c?{}:c,l=r.frameId,p=void 0===l?null:l,d=r.currentRow,f=void 0!==d&&d,h=r.event,v=void 0===h?null:h,y=r.context,g=void 0===y?null:y,m=s.content;if(!m)throw new Error("不支持的表单类型");var S=[];if(!0===f){var C=m.context.appContext.frameContextManager.getFrameContextById(p);if(!C)throw new Error("无效的frameId："+p+"，请确认命令中frameId正确。");var b=C.bindingData.getList(),I=b&&b.currentItem&&b.currentItem.toJSON();I&&0<Object.keys(I).length&&(S=[I])}else{var w=m.context.appContext.frameContextManager.getFrameContextById(p).uiState.rows||new Map;S=Array.from(w.values())}undefined,v&&v.editor&&v.editor.column&&v.editor.column.field,S&&u&&Object.keys(u).forEach(function(e){var t=u[e],r=e.split(".").filter(function(e){return e})||[],i=S.map(function(e){return r.reduce(function(e,t){return e&&(e.hasOwnProperty(t)||e.__proto__.hasOwnProperty(t))?e[t]:""},e)}).join(",");if(t){var n=o.frameContext.viewModel.bindingPath.split("/").filter(function(e){return e});t.split(",").filter(function(e){return e}).forEach(function(e){if(g)o.setValueByPath(g,e,i);else{v.formControl&&v.formControl.setValue&&v.editor&&v.editor.column&&v.editor.column.field===e&&v.formControl.setValue(i);var t=e.split(".");o.frameContext.bindingData.setValue(n.concat(t),i,!0,!0)}})}}),n&&n.next(),s.close()}},ci.prototype.cancel=function(e){var t=(e||this.context&&this.context.eventParam||{}||{}).modalId,r=void 0===t?null:t;if(r){var i=this.modals[r]||{},n=i.subject,o=void 0===n?null:n,a=i.dialogRef,s=void 0===a?null:a;o&&o.next(),s&&s.close()}},ci.prototype.cancelChanges=function(e){if(e&&e.modalRef&&e.modalRef.content){var t=e.modalRef.content;if(t&&t.context){var r=t.context.repository||null;if(r)return r.cancelChanges().pipe(N.switchMap(function(){return O.of(!0)}))}}return O.of(!0)},ci.prototype.closeModal=function(){this.modalRef&&this.modalRef.close()},ci.prototype.createRemoteForm=function(a,s){var c=this,e=a.remote||!1,u=new O.Subject;if(e){var t=a.moduleName||null;System["import"](e).then(function(e){var o=e[t=t||Object.keys(e).pop()].create(c.injector);(o&&o.instance&&o.instance.trans&&"function"==typeof o.instance.trans.resolve&&o.instance.trans.resolve||function(){return O.of(!0)}).apply(o.instance.trans).subscribe(function(){var e=o._bootstrapComponents[0];if(!e)throw new Error("无法找到入口表单！");var t=o.componentFactoryResolver.resolveComponentFactory(e),r=c.createInjector(c.refs),i=t.create(r);i&&i.instance&&i.instance.viewModel&&i.instance.viewModel.uiState&&("object"==typeof s&&Object.keys(s).length&&Object.keys(s).forEach(function(e){i.instance.viewModel.uiState.setPropertyValue(e,s[e])}),i.instance.viewModel.uiState.setPropertyValue("DEVKIT_DIALOG",!0));var n=c.modalService.show(i,a);u.next(n)})})}return u},ci.prototype.setValueByPath=function(e,t,r){if(e){var i=t.split(".");i.length<=1?e[t]=r:i.slice(0,-1).reduce(function(e,t){return e.hasOwnProperty(t)||e.__proto__.hasOwnProperty(t)||(e[t]={}),e[t]},e)[i[i.length-1]]=r}},ci.prototype.createInjector=function(e,t){var r=[{provide:Ke,useValue:!0},{provide:ze,useValue:k.forwardRef(function(){return e})}];return k.Injector.create({providers:r,parent:t||this.injector})},ci.decorators=[{type:k.Injectable}],ci.ctorParameters=function(){return[{type:h.BsModalService},{type:et},{type:k.ComponentFactoryResolver},{type:V.FrameContext},{type:k.Injector,decorators:[{type:k.Optional}]}]},ci);function ci(e,t,r,i,n){this.modalService=e,this.farrisFormService=t,this._componentFactoryResolver=r,this.frameContext=i,this.injector=n,this._providers=[],this.refs={},this.modals={},this.setLanguageService()}var ui=(Object.defineProperty(li.prototype,"repository",{get:function(){return this.frameContext.repository},enumerable:!0,configurable:!0}),li.prototype.openSidebar=function(){this.sidebarUIService.sendIsOpen(!0)},li.prototype.closeSidebar=function(){this.sidebarUIService.sendIsOpen(!1)},li.prototype.confirmBeforeClosingSidebar=function(){return this.repository.entityManager.checkAllEntityChanges()?this.messageService.question(this.languageService.exitWithoutSave).pipe(N.switchMap(function(e){return!1===e?O.of(!1):O.of(!0)})):O.of(!0)},li.prototype.continueClosingSidebar=function(){return O.of(!0)},li.prototype.stopClosingSidebar=function(){return O.of(!1)},li.decorators=[{type:k.Injectable}],li.ctorParameters=function(){return[{type:V.FrameContext},{type:m.FarrisSidebarService},{type:Fe},{type:$,decorators:[{type:k.Optional}]}]},li);function li(e,t,r,i){this.frameContext=e,this.sidebarUIService=t,this.messageService=r,this.languageService=i,this.languageService||(this.languageService=$.getInstance())}var pi=(di.prototype.stripFiltersWithSpecialValue=function(e,r){var i=this;if(!e||!r)return e;var t=JSON.parse(e).filter(function(e){var t=i.getFilterValue(e);return-1===r.indexOf(t)});return JSON.stringify(t)},di.prototype.getFilterValue=function(e){return e.Value||e.value},di.decorators=[{type:k.Injectable}],di);function di(){}new k.InjectionToken("表单弹出窗口或隐藏组件列表");var fi=(hi.prototype.appendControl=function(e,t){this.controls[e]=t},hi.prototype.getControl=function(e){return this.controls[e]?this.controls[e]:(console.warn("未找到Key为"+e+"的组件！"),null)},hi.prototype.clear=function(e){e?(this.controls[e]=null,delete this.controls[e]):this.controls={}},hi.decorators=[{type:k.Injectable}],hi);function hi(){this.controls={}}var vi=(yi.prototype.queryOperationAuthority=function(e){for(var t=new Map,r=0,i=0;i<e.length;i++)t.set(e[i],r%2==0),r++;var n=new O.Subject;return setTimeout(function(){n.next(t)},0),n},yi);function yi(){}var gi=(mi.prototype.setLabelMap=function(e){var r=this;for(var t in e)this.operationLabelMap.set(t,e[t]);this.operationLabelMap.forEach(function(e,t){r[t]=!1})},mi.prototype.initialize=function(e){var i=this;return this.operationLabelMap&&0<this.operationLabelMap.size?e.queryOperationAuthority(Array.from(this.operationLabelMap.values())).pipe(N.map(function(r){i.operationLabelMap.forEach(function(e,t){i.authOfLabel.set(t,!!r.has(e)&&r.get(e))})})):O.empty()},mi.prototype.hasOperation=function(e){return this.authOfLabel.has(e)&&this.authOfLabel.get(e)},mi);function mi(){this.operationLabelMap=new Map,this.authOfLabel=new Map}var Si=(Ci.prototype.setContext=function(e){this.appContext=e},Ci.prototype.handle=function(e){this.formErrorService&&this.formErrorService.exception(this.languageService.loadFailed,e)},Ci.decorators=[{type:k.Injectable}],Ci.ctorParameters=function(){return[{type:Pe},{type:$,decorators:[{type:k.Optional}]},{type:V.AppContext}]},Ci);function Ci(e,t,r){this.formErrorService=e,this.languageService=t,this.applicationContext=r,(this.appContext=null)==this.languageService&&(this.languageService=$.getInstance())}var bi=[W,Fe,Te,Pe,Ae,Be,ke,pi,Dt,$,Et,_e,Je,Ge,Qe,it,Ue,Lt,vt,tr,sr,Rt,Nt,jt,pt,Vt,qt,Wt,Kt,Jt,hr,Nr,Hr,St,yr,zr,Yr,$r,ti,ii,bt,wt,ui,et,si],Ii=(Object.defineProperty(wi.prototype,"timeZone",{get:function(){return this.timezone&&this.timezone.id||null},enumerable:!0,configurable:!0}),Object.defineProperty(wi.prototype,"timeZoneOffset",{get:function(){var e=this.timezone&&this.timezone.baseOffset;return null!==e&&e!==undefined?e:null},enumerable:!0,configurable:!0}),Object.defineProperty(wi.prototype,"defaultLanguage",{get:function(){return this.i18nSetting&&this.i18nSetting.defaultLanguage||null},enumerable:!0,configurable:!0}),Object.defineProperty(wi.prototype,"dateFormat",{get:function(){return this.i18nSetting&&this.i18nSetting.userDateFormat||null},enumerable:!0,configurable:!0}),Object.defineProperty(wi.prototype,"timeFormat",{get:function(){return this.i18nSetting&&this.i18nSetting.userTimeFormat||null},enumerable:!0,configurable:!0}),Object.defineProperty(wi.prototype,"dateTimeFormat",{get:function(){return(this.i18nSetting&&this.i18nSetting.userDateFormat||"yyyy-MM-dd")+" "+(this.i18nSetting&&this.i18nSetting.userTimeFormat||"HH:mm:ss")},enumerable:!0,configurable:!0}),Object.defineProperty(wi.prototype,"addressFormat",{get:function(){return null},enumerable:!0,configurable:!0}),Object.defineProperty(wi.prototype,"numberFormat",{get:function(){if(this.i18nSetting&&this.i18nSetting.userNumberFormat){var e=this.i18nSetting.userNumberFormat;return{negativeSign:e.negativeSign||"-",numberDecimalDigits:e.numberDecimalDigits||2,numberDecimalSeparator:e.numberDecimalSeparator||".",numberGroupSeparator:e.numberGroupSeparator||","}}return null},enumerable:!0,configurable:!0}),Object.defineProperty(wi.prototype,"regionCode",{get:function(){return this.i18nSetting&&this.i18nSetting.userRegionCode||null},enumerable:!0,configurable:!0}),Object.defineProperty(wi.prototype,"userSettings",{get:function(){return this.frmI18nSettingService&&this.frmI18nSettingService.getSetting()},enumerable:!0,configurable:!0}),Object.defineProperty(wi.prototype,"timezone",{get:function(){return this.i18nSetting&&this.i18nSetting.timezone},enumerable:!0,configurable:!0}),Object.defineProperty(wi.prototype,"i18nSetting",{get:function(){return this.userSettings&&this.userSettings.i18nSetting},enumerable:!0,configurable:!0}),wi.decorators=[{type:k.Injectable}],wi.ctorParameters=function(){return[{type:k.Injector},{type:S.FrmI18nSettingService,decorators:[{type:k.Optional}]}]},wi);function wi(e,t){this.injector=e,this.frmI18nSettingService=t}var xi=(Ei.prototype.listen=function(e){this.handler=this.messageHandler(e),window.addEventListener("message",this.handler)},Ei.prototype.destroy=function(){this.handler&&window.removeEventListener("message",this.handler)},Ei.prototype.send=function(e){if(e){var t=window;e.target&&(t=e.target||window,delete e.target),t&&t.postMessage(e,"*")}},Ei.decorators=[{type:k.Injectable}],Ei.ctorParameters=function(){return[]},Ei);function Ei(){this.messageHandler=function(r){return function(e){var t=e.data;t&&(t.sender=e.source),"function"==typeof r&&r(t)}}}var Pi=(Di.prototype.setup=function(){var e=this;this.workFlowMessageService&&this.workFlowMessageService.listen(function(r){!e.listeners||e.listeners.size<1||e.listeners.forEach(function(e,t){"function"==typeof e&&e(r)})})},Di.prototype.addEventListener=function(e){var t=(new Date).valueOf().toString(16)+"-"+Math.ceil(100*Math.random());return this.listeners.set(t,e),t},Di.prototype.removeEventListener=function(e){!this.listeners||this.listeners.size<1||(this.listeners["delete"](e),e=null)},Di.decorators=[{type:k.Injectable}],Di.ctorParameters=function(){return[{type:k.Injector},{type:xi}]},Di);function Di(e,t){this.injector=e,this.workFlowMessageService=t,this.listeners=new Map}var Fi=(Mi.prototype.onComponentInit=function(e){var t=this,r=this.workFlowMessage.addEventListener(this.handle.bind(this)),i=this.frameContext.destorySignal;i&&i.subscribe(function(){t.workFlowMessage.removeEventListener(r)});var n=this.frameContext.appContext.destorySignal;n&&n.subscribe(function(){t.workFlowMessage.workFlowMessageService.destroy()})},Mi.prototype.handle=function(e){var t=this,r=e.sender,i=e.data,n=i&&i.command||null,o=null;if(n){if("wf-required-verification"==n){var a=this.getFormFrameContexts();o=O.from(a).pipe(N.concatMap(function(e){var t=e.injector.get(vt,null);return t?t.validateAll():O.of(!0)}))}else{var s=this.frameContext.viewModel[n];s&&(o=s(i.arguments))}if(o){var c=this.buildMessage(!0,r,this.isChanged);o.pipe(N.throwIfEmpty()).subscribe(function(e){t.workFlowMessageService.send(c)},function(){c.data.result=!1,t.workFlowMessageService.send(c)})}}},Mi.prototype.buildMessage=function(e,t,r,i){return void 0===i&&(i="message"),{data:{result:e,dataChanged:r},type:i,target:t}},Mi.prototype.getFormFrameContexts=function(){var e=this.injector.get(V.AppContextManager,null),t=[];if(e){var r=e.getAppContexts();r&&0<r.length&&r.forEach(function(e){e.frameContextManager.getFrameContexts().reduce(function(e,t){var r=t.namespace;if(-1===e.findIndex(function(e){return e.namespace===r})){var i=t.getVirtualRootFrameContext();e.push(i)}return e},t)})}return t},Object.defineProperty(Mi.prototype,"isChanged",{get:function(){var e=this.frameContext.repository;return w.BefRepositoryUtil.isExistUnsaveData(e)},enumerable:!0,configurable:!0}),Mi.decorators=[{type:k.Injectable}],Mi.ctorParameters=function(){return[{type:k.Injector},{type:V.FrameContext},{type:xi},{type:Pi}]},Mi);function Mi(e,t,r,i){this.injector=e,this.frameContext=t,this.workFlowMessageService=r,this.workFlowMessage=i}var Ti,Ri,Oi,Ni,Ai,ji,Bi=[W,Fe,Te,Pe,Oe,Ae,Be,ke,fi,pi,Dt,$,Et,_e,Je,Ge,Qe,it,Ue,Lt,Mt,{provide:V.UserSettingsToken,useClass:Ii},xi,Pi];(Ri=Ti=Ti||{})[Ri.Equal=0]="Equal",Ri[Ri.NotEqual=1]="NotEqual",Ri[Ri.Greater=2]="Greater",Ri[Ri.GreaterOrEqual=3]="GreaterOrEqual",Ri[Ri.Less=4]="Less",Ri[Ri.LessOrEqual=5]="LessOrEqual",Ri[Ri.Like=6]="Like",Ri[Ri.LikeStartWith=7]="LikeStartWith",Ri[Ri.LikeEndWith=8]="LikeEndWith",Ri[Ri.NotLike=9]="NotLike",Ri[Ri.NotLikeStartWith=10]="NotLikeStartWith",Ri[Ri.NotLikeEndWith=11]="NotLikeEndWith",Ri[Ri.Is=12]="Is",Ri[Ri.IsNot=13]="IsNot",Ri[Ri.In=14]="In",Ri[Ri.NotIn=15]="NotIn",(Ni=Oi=Oi||{})[Ni.Value=0]="Value",Ni[Ni.Express=1]="Express",(ji=Ai=Ai||{})[ji.Empty=0]="Empty",ji[ji.And=1]="And",ji[ji.Or=2]="Or";var Li=(ki.prototype.convert=function(e){var t=e.value;return[{FilterField:e.fieldCode,Compare:e.compareType||0===e.compareType?e.compareType:Ti.Like,Value:t.value,Relation:e.relation||0===e.relation?e.relation:Ai.And,Expresstype:Oi.Value,Lbracket:e.Lbracket||null,Rbracket:e.Rbracket||null}]},ki);function ki(){}var Vi=(_i.prototype.convert=function(e){var t=e.control,r=[],i=e.value;return i.startTime&&r.push({FilterField:t.startFieldCode?t.startFieldCode:e.fieldCode,Compare:Ti.GreaterOrEqual,Value:i.startTime,Relation:Ai.And,Expresstype:Oi.Value}),i.endTime&&r.push({FilterField:t.endFieldCode?t.endFieldCode:e.fieldCode,Compare:Ti.LessOrEqual,Value:i.endTime,Relation:Ai.And,Expresstype:Oi.Value}),r},_i);function _i(){}var qi=(Ui.prototype.convert=function(t){var e=t.value,r=[];return e.value.forEach(function(e){r.push({FilterField:t.fieldCode,Compare:t.compareType||0===t.compareType?t.compareType:Ti.Equal,Value:e.value,Relation:t.compareType===Ti.NotEqual?Ai.And:Ai.Or,Expresstype:Oi.Value})}),r[0].Lbracket=t.Lbracket?t.Lbracket+"(":"(",r[r.length-1].Rbracket=t.Rbracket?t.Rbracket+")":")",r[r.length-1].Relation=t.relation||0===t.relation?t.relation:Ai.And,r},Ui);function Ui(){}var Wi=(Hi.prototype.convert=function(e){var t=[],r=e.value;return null!=r.startValue&&t.push({FilterField:e.fieldCode,Compare:Ti.GreaterOrEqual,Value:r.startValue,Relation:Ai.And,Expresstype:Oi.Value}),null!=r.endValue&&t.push({FilterField:e.fieldCode,Compare:Ti.LessOrEqual,Value:r.endValue,Relation:Ai.And,Expresstype:Oi.Value}),t},Hi);function Hi(){}var Ki=(zi.prototype.convert=function(t){var e=t.value;if(0==e.value.length)return[];var r=[];return e.isInputText||null==e.valueField?(r.push({FilterField:t.fieldCode,Compare:t.compareType||0===t.compareType?t.compareType:Ti.Like,Value:e.textValue,Relation:t.relation||0===t.relation?t.relation:Ai.And,Expresstype:Oi.Value}),r):(e.getOriginalValue().split(",").forEach(function(e){e&&r.push({FilterField:t.fieldCode,Compare:t.compareType||0===t.compareType?t.compareType:Ti.Equal,Value:e,Relation:t.compareType===Ti.NotEqual?Ai.And:Ai.Or,Expresstype:Oi.Value})}),0<r.length?(r[0].Lbracket=t.Lbracket?t.Lbracket+"(":"(",r[r.length-1].Rbracket=t.Rbracket?t.Rbracket+")":")",r[r.length-1].Relation=t.relation||0===t.relation?t.relation:Ai.And,r):[])},zi);function zi(){}var Ji=(Yi.prototype.convert=function(e){var t=e.value;return[{FilterField:e.fieldCode,Compare:e.compareType||0===e.compareType?e.compareType:Ti.Equal,Value:t.yearValue,Relation:e.relation||0===e.relation?e.relation:Ai.And,Expresstype:Oi.Value,Lbracket:e.Lbracket||null,Rbracket:e.Rbracket||null}]},Yi);function Yi(){}var Gi=($i.prototype.convert=function(t){var r=[],e=t.value;return 1==e.value.length?[{FilterField:t.fieldCode,Compare:Ti.Equal,Value:e.value[0],Relation:t.relation||0===t.relation?t.relation:Ai.And,Expresstype:Oi.Value,Lbracket:t.Lbracket||null,Rbracket:t.Rbracket||null}]:(e.value.forEach(function(e){r.push({FilterField:t.fieldCode,Compare:Ti.Equal,Value:e,Relation:Ai.Or,Expresstype:Oi.Value})}),r[0].Lbracket=t.Lbracket?t.Lbracket+"(":"(",r[r.length-1].Rbracket=t.Rbracket?t.Rbracket+")":")",r[r.length-1].Relation=t.relation||0===t.relation?t.relation:Ai.And,r)},$i);function $i(){}var Qi=(Xi.prototype.convert=function(e){var t=e.value;return[{FilterField:e.fieldCode,Compare:e.compareType||0===e.compareType?e.compareType:Ti.Equal,Value:t.monthValue,Relation:e.relation||0===e.relation?e.relation:Ai.And,Expresstype:Oi.Value,Lbracket:e.Lbracket||null,Rbracket:e.Rbracket||null}]},Xi);function Xi(){}var Zi=(en.prototype.convert=function(e){var t=[],r=e.value;return r.startTime&&t.push({FilterField:e.fieldCode,Compare:Ti.GreaterOrEqual,Value:r.startTime,Relation:Ai.And,Expresstype:Oi.Value}),r.endTime&&t.push({FilterField:e.fieldCode,Compare:Ti.LessOrEqual,Value:r.endTime,Relation:Ai.And,Expresstype:Oi.Value}),t},en);function en(){}var tn=(rn.prototype.convert=function(e){var t=e.value;return[{FilterField:e.fieldCode,Compare:e.compareType||0===e.compareType?e.compareType:Ti.Equal,Value:t.datetimeValue,Relation:e.relation||0===e.relation?e.relation:Ai.And,Expresstype:Oi.Value,Lbracket:e.Lbracket||null,Rbracket:e.Rbracket||null}]},rn);function rn(){}var nn=(on.prototype.convert=function(e){var t=e.value;return[{FilterField:e.fieldCode,Compare:e.compareType||0===e.compareType?e.compareType:Ti.Equal,Value:t.numValue,Relation:e.relation||0===e.relation?e.relation:Ai.And,Expresstype:Oi.Value,Lbracket:e.Lbracket||null,Rbracket:e.Rbracket||null}]},on);function on(){}var an=(sn.prototype.convert=function(e){var t=[],r=e.value;if("string"!=typeof r.dateValue){var i=function o(e,t){var r=new Date,i=[];if(e.isFirstDay||e.isLastDay)switch(e.dateType+"-"+(e.isFirstDay?"first":"last")){case"week-first":0===I.getDay(r)&&(r=I.addDays(r,-1)),i.push(I.addDays(I.startOfWeek(r),1));break;case"week-last":0===I.getDay(r)&&(r=I.addDays(r,-1)),i.push(I.addDays(I.endOfWeek(r),1));break;case"month-first":i.push(I.startOfMonth(r));break;case"month-last":i.push(I.endOfMonth(r));break;case"year-first":i.push(I.startOfYear(r));break;case"year-last":i.push(I.endOfYear(r));break;default:i.push(r)}else if("day"===e.dateType&&"present"===e.period)i.push(r);else if("day"===e.dateType&&1===e.count){var n=I.addDays(r,"future"===e.period?1:-1);i.push(n)}else if("present"===e.period)switch(e.dateType){case"week":i.push(I.startOfWeek(r),I.endOfWeek(r));break;case"month":i.push(I.startOfMonth(r),I.endOfMonth(r));break;case"year":i.push(I.startOfYear(r),I.endOfYear(r));break;default:i.push(r)}else switch(e.dateType+"-"+e.period){case"day-previous":i.push(I.addDays(r,-1*e.count),I.addDays(r,-1));break;case"day-future":i.push(I.addDays(r,1),I.addDays(r,e.count));break;case"week-previous":i.push(I.addWeeks(r,-1*e.count),I.addDays(r,-1));break;case"week-future":i.push(I.addDays(r,1),I.addWeeks(r,e.count));break;case"month-previous":i.push(I.addMonths(r,-1*e.count),I.addDays(r,-1));break;case"month-future":i.push(I.addDays(r,1),I.addMonths(r,e.count));break;case"year-previous":i.push(I.addYears(r,-1*e.count),I.addDays(r,-1));break;case"year-future":i.push(I.addDays(r,1),I.addYears(r,e.count));break;default:i.push(r)}return i=i.map(function(e){return I.format(e,t.returnFormat||"yyyy-MM-dd")})}(r.dateValue,e.control);1===i.length&&t.push({FilterField:e.fieldCode,Compare:e.compareType?Ti[e.compareType]:Ti.Equal,Value:i[0],Relation:e.relation?Ai[e.relation]:Ai.And,Expresstype:Oi.Value,Lbracket:e.Lbracket||null,Rbracket:e.Rbracket||null}),2===i.length&&t.push({FilterField:e.fieldCode,Compare:Ti.GreaterOrEqual,Value:i[0],Relation:Ai.And,Expresstype:Oi.Value,Lbracket:e.Lbracket?e.Lbracket+"(":"("},{FilterField:e.fieldCode,Compare:Ti.LessOrEqual,Value:i[1],Relation:Ai.And,Expresstype:Oi.Value,Rbracket:e.Rbracket?e.Rbracket+")":")"})}else t.push({FilterField:e.fieldCode,Compare:e.compareType||0===e.compareType?e.compareType:Ti.Equal,Value:r.dateValue,Relation:e.relation||0===e.relation?e.relation:Ai.And,Expresstype:Oi.Value,Lbracket:e.Lbracket||null,Rbracket:e.Rbracket||null});return t},sn);function sn(){}var cn=(un.prototype.convert=function(t){var e=t.value;if(0!=e.value.length&&e.valueField){var r=[];return e.getOriginalValue().split(",").forEach(function(e){e&&r.push({FilterField:t.fieldCode,Compare:t.compareType||0===t.compareType?t.compareType:Ti.Equal,Value:e,Relation:t.compareType===Ti.NotEqual?Ai.And:Ai.Or,Expresstype:Oi.Value})}),0<r.length?(r[0].Lbracket=t.Lbracket?t.Lbracket+"(":"(",r[r.length-1].Rbracket=t.Rbracket?t.Rbracket+")":")",r[r.length-1].Relation=t.relation||0===t.relation?t.relation:Ai.And,r):[]}return[]},un);function un(){}var ln=(pn.prototype.convert=function(e){var t=e.value;return[{FilterField:e.fieldCode,Compare:e.compareType||0===e.compareType?e.compareType:Ti.Equal,Value:t.value,Relation:e.relation||0===e.relation?e.relation:Ai.And,Expresstype:Oi.Value,Lbracket:e.Lbracket||null,Rbracket:e.Rbracket||null}]},pn);function pn(){}var dn=(fn.prototype.convert=function(t){var e=t.value,r=[];return e.isInputText||null==e.textField?(r.push({FilterField:t.fieldCode,Compare:t.compareType||0===t.compareType?t.compareType:Ti.Like,Value:e.textValue,Relation:t.relation||0===t.relation?t.relation:Ai.And,Expresstype:Oi.Value,Lbracket:t.Lbracket||null,Rbracket:t.Rbracket||null}),r):(e.getOriginalValue().split(",").forEach(function(e){e&&r.push({FilterField:t.fieldCode,Compare:t.compareType||0===t.compareType?t.compareType:Ti.Equal,Value:e,Relation:t.compareType===Ti.NotEqual?Ai.And:Ai.Or,Expresstype:Oi.Value})}),0<r.length?(r[0].Lbracket=t.Lbracket?t.Lbracket+"(":"(",r[r.length-1].Rbracket=t.Rbracket?t.Rbracket+")":")",r[r.length-1].Relation=t.relation||0===t.relation?t.relation:Ai.And,r):[])},fn);function fn(){}var hn=(vn.getInstance=function(){return vn._instance||(vn._instance=new vn),vn._instance},vn.prototype.getHandler=function(e){return this.queryConditionHandlerMapping.get(e)},vn._instance=null,vn);function vn(){this.queryConditionHandlerMapping=new Map,this.queryConditionHandlerMapping.set(b.ControlType.Text,new Li),this.queryConditionHandlerMapping.set(b.ControlType.InputGroup,new dn),this.queryConditionHandlerMapping.set(b.ControlType.DateRange,new Vi),this.queryConditionHandlerMapping.set(b.ControlType.DateTimeRange,new Vi),this.queryConditionHandlerMapping.set(b.ControlType.DropDownList,new qi),this.queryConditionHandlerMapping.set(b.ControlType.NumberRange,new Wi),this.queryConditionHandlerMapping.set(b.ControlType.SmartHelp,new Ki),this.queryConditionHandlerMapping.set(b.ControlType.SingleYear,new Ji),this.queryConditionHandlerMapping.set(b.ControlType.BoolCheck,new Gi),this.queryConditionHandlerMapping.set(b.ControlType.SingleMonth,new Qi),this.queryConditionHandlerMapping.set(b.ControlType.MonthRange,new Zi),this.queryConditionHandlerMapping.set(b.ControlType.SingleDateTime,new tn),this.queryConditionHandlerMapping.set(b.ControlType.SingleNumber,new nn),this.queryConditionHandlerMapping.set(b.ControlType.SingleDate,new an),this.queryConditionHandlerMapping.set(b.ControlType.ComboLookUp,new cn),this.queryConditionHandlerMapping.set(b.ControlType.Radio,new ln)}var yn=(gn.prototype.getUserSessionId=function(){return this.frameworkSessionService.getUserSessionId()},gn.prototype.setFilterConditions=function(e){var t,r=[];e.forEach(function(e){e.value.isEmpty()||(t=hn.getInstance().getHandler(e.control.getControlType()))&&r.push.apply(r,ie(t.convert(e)))}),this.frameContext.uiState.filterConditionList=JSON.stringify(r),this.frameContext.uiState.originalFilterConditionList=JSON.stringify(r)},gn.prototype.setCurrentQueryConditions=function(e){this.frameContext.uiState.currentQueryConditions=e},gn.decorators=[{type:k.Injectable}],gn.ctorParameters=function(){return[{type:V.FrameContext},{type:w.FrameworkSessionService}]},gn);function gn(e,t){this.frameContext=e,this.frameworkSessionService=t}var mn=(Sn.prototype.endEdit=function(){var e=this.frameContext&&this.frameContext.getFormAppContext();return O.of(null).pipe(N.tap(function(){e&&e.messagePipe.next({type:"endEdit"})}),N.delay(120))},Sn.decorators=[{type:k.Injectable}],Sn.ctorParameters=function(){return[{type:V.FrameContext}]},Sn);function Sn(e){this.frameContext=e}var Cn=(bn.prototype.summary=function(e,t){var r=this.viewModel.frameContext.repository||null;if(r){var i=r.proxy;if(i&&"function"==typeof i[e])return i[e](t)}return O.of(null)},bn.decorators=[{type:k.Injectable}],bn.ctorParameters=function(){return[{type:V.ViewModel}]},bn);function bn(e){this.viewModel=e}var In=(Object.defineProperty(wn.prototype,"formErrorService",{get:function(){return this.injector&&this.injector.get(Pe,null)},enumerable:!0,configurable:!0}),wn.prototype.openBatchEditDialog=function(e,t){var r=this;if(void 0===t&&(t=!1),!e)throw new Error("frameId is required.");if("string"==typeof t&&(t="true"===t),this.batchEditDialogService){var i=[];if(this.viewModel){var n=this.viewModel.frameContext.root.appContext.frameContextManager.getFrameContextById(e).viewModel;n&&n.hasOwnProperty("dataGridColumnsName")?i=n[n.dataGridColumnsName]:n&&n.hasOwnProperty("dataGridColumns")&&(i=n.dataGridColumns);var o=n.uiState.ids||[];if(!o||o.length<1)return this.formNotifyService.warning(this.languageService.plsCheckBatchEditRows,{hideTitle:!0}),O.EMPTY;var a=this.batchEditDialogService.batchEdit(i,{rows:o.length,enableDictPicking:t,onConfirm:function(e){if(Array.isArray(o)&&0<o.length){var t=r.viewModel.frameContext.appContext;t.changeDetectionController.detach(),e.forEach(function(e){r.updateBindingData(e,o)}),t.changeDetectionController.reattach()}a.close()}})}}},wn.prototype.openHiddenHelp=function(e){if(!e)throw new Error("Argument error,helpId can`t be empty");var t=this.componentManagerService.getControl(e);if(!t)throw new Error("the component which id is "+e+" can't be found!");t.showDialog()},wn.prototype.clearHelpSelections=function(){var e=this.context&&this.context.eventParam&&this.context.eventParam.instance||null;e&&(e.displayValue="")},wn.prototype.checkCurrentRow=function(e,t,r){var i=this.context&&this.context.eventParam&&this.context.eventParam.instance||null;r=r||"id";var n=JSON.parse(t);if(i&&(e=e||this.viewModel.frameContext.frameId)){var o=this.getFrameContextById(e);if(o){var a=o.viewModel.bindingPath;if(a){var s=a.split("/").filter(function(e){return e}),c=o.bindingData.getValue(s).currentItem,u=n[r];if(u){var l=this.getValueByPath(c,u);i.displayValue=l}}}}},wn.prototype.batchAppend=function(e,t){var n=this,r=this.context&&this.context.eventParam||[];if(!t)throw new Error("mapFields can`t be empty.");if(r&&Array.isArray(r)&&0<r.length){var o=JSON.parse(t),i=this.injector.get(V.AppContext,null);if(i){var a=i.frameContextManager.getFrameContextById(e);if(!a)throw new Error("frameId is invalid!");a.viewModel.bindingPath}var s=[];return r.forEach(function(t){var i={};Object.keys(o).forEach(function(e){var r=n.getValueByPath(t,e);o[e].split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".").filter(function(e){return e});n.setValueByPath(i,t.join("."),r)})}),s.push(i)}),this.formLoadingService.show(),this.repository.batchAppend(s).pipe(N.tap(function(){return n.formLoadingService.hide()}),N.map(function(){return!0}))}return O.of(!0)},wn.prototype.batchAppendByPathBasedOnHelpSelections=function(e,t){var n=this,r=this.context&&this.context.eventParam||[];if(!t)throw new Error("mapFields can`t be empty.");if(r&&Array.isArray(r)&&0<r.length){var o=JSON.parse(t),i="/",a=this.injector.get(V.AppContext,null);if(a){var s=a.frameContextManager.getFrameContextById(e);if(!s)throw new Error("frameId is invalid!");i=s.viewModel.bindingPath||"/"}var c=[];r.forEach(function(t){var i={};Object.keys(o).forEach(function(e){var r=n.getValueByPath(t,e);o[e].split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".").filter(function(e){return e});n.setValueByPath(i,t.join("."),r)})}),c.push(i)}),this.formLoadingService.show();var u=this.buildPath(i,this.viewModel.bindingData.list.currentId);return this.repository.batchAppendByPath(u,c).pipe(N.tap(function(){return n.formLoadingService.hide()}),N.map(function(){return!0}))}return O.of(!0)},wn.prototype.batchAppendByPathWithAttachment=function(e,t,r,i,n){var o=this,a=this.context&&this.context.eventParam||[];if(!t)throw new Error("mapFields can`t be empty.");if(!r)throw new Error("附件udt字段路径不能为空");if(a&&Array.isArray(a)&&0<a.length){var s=JSON.parse(t),c="/",u=this.injector.get(V.AppContext,null);if(u){var l=u.frameContextManager.getFrameContextById(e);if(!l)throw new Error("frameId is invalid!");c=l.viewModel.bindingPath||"/"}var p=r.split(",").filter(function(e){return e}).map(function(e){return e.split("/").pop()});return this.formLoadingService.show(),O.from(a).pipe(N.concatMap(function(e){return o.copyRowFiles(e,p,i,n).pipe(N.catchError(function(e){o.formLoadingService.hide();var t=e.error;return"string"==typeof t&&(t=JSON.parse(t)),o.formErrorService&&o.formErrorService.exception(t.message||o.languageService.copyFailed,e),O.throwError(e)}))})).pipe(N.takeLast(1)).pipe(N.switchMap(function(){var e=o.buildDefaultValues(a,s),t=o.buildPath(c,o.viewModel.bindingData.list.currentId);return o.repository.batchAppendByPath(t,e).pipe(N.tap(function(){return o.formLoadingService.hide()}),N.map(function(){return!0}))}))}return O.of(!0)},wn.prototype.buildDefaultValues=function(e,n){var o=this,r=[];return e.forEach(function(t){var i={};Object.keys(n).forEach(function(e){var r=o.getValueByPath(t,e);n[e].split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".").filter(function(e){return e});o.setValueByPath(i,t.join("."),r)})}),r.push(i)}),r},wn.prototype.copyRowFiles=function(r,e,i,n){var o=this;return O.from(e).pipe(N.concatMap(function(t){var e=o.getValueByPath(r,t+".attachmentId");return e?o.fileUploadService.copyFile(e,i,n).pipe(N.tap(function(e){o.setValueByPath(r,[t,"attachmentId"].join("."),e)})):O.of(null)}))},wn.prototype.batchAppendBasedOnRowHelpSelections=function(e,t){var h=this,v=this.context&&this.context.eventParam||[];if(!t)return O.of(!0);var y=JSON.parse(t);if(!y||!y.hasOwnProperty("id"))return O.of(!0);if(!(e=e||this.viewModel.frameContext.frameId))return O.of(!0);var g=this.getFrameContextById(e);return g&&setTimeout(function(){h.endEdit(g).subscribe(function(){setTimeout(function(){if(v&&Array.isArray(v)&&0<v.length){var n=g.viewModel.bindingPath||"/",o=n.split("/").filter(function(e){return e}),e=[],t=g.bindingData.getValue(o),r=(t.currentItem,t.currentId),i=h.getEntityByPath(g,o,r),a=v[0];if(1===v.length){var s=a;return Object.keys(y).forEach(function(e){var r=h.getValueByPath(s,e);y[e].split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".").filter(function(e){return e});g.bindingData.setValue(o.concat(t),r,!0,!0)})}),O.of(!0)}var c=y.id,u=h.getValueByPath(i,c);if(u&&-1!==v.findIndex(function(e){return e[t.primaryKey]===u})){if(u){var l=v.findIndex(function(e){return e[t.primaryKey]===u});h.mappingRow(v[l],y,i,n),v.splice(l,1)}}else h.mappingRow(a,y,i,n),v=v.slice(1);var p=t.toArray().filter(function(e){return!h.getValueByPath(e,y[t.primaryKey])});if(p&&0<p.length){var d=v;v=v.length>p.length?(d=v.slice(0,p.length),v.slice(p.length)):[],d.forEach(function(e,t){var r=p[t],i=h.getEntityByPath(g,o,r.primaryKeyValue);h.mappingRow(e,y,i,n)})}if(v.forEach(function(t){var i={};Object.keys(y).forEach(function(e){var r=h.getValueByPath(t,e);y[e].split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".").filter(function(e){return e});h.setValueByPath(i,t.join("."),r)})}),e.push(i)}),0<e.length){h.formLoadingService.show();var f=h.buildPath(n,h.viewModel.bindingData.list.currentId);h.repository.batchAppendByPath(f,e).pipe(N.tap(function(){return h.formLoadingService.hide()})).subscribe()}}},350)})},50),O.of(!0)},wn.prototype.copy=function(e){var i=this;if(!e)return this.formNotifyService.warning(this.languageService.plsSelectCopyData,{hideTitle:!0}),O.EMPTY;var t=this.repository,r=t.restService.baseUri+"/service/copymainobjvoaction",n={body:{requestInfo:t.restService.buildRequestInfo(),dataID:e}};return this.formLoadingService.show(),t.proxy.request(r,"PUT",null,n).pipe(N.tap(function(){i.formLoadingService.hide()}),N.map(function(e){var t=e.returnValue,r=i.repository.buildEntity(t);return i.repository.entityCollection.addEntity(r),r}))},wn.prototype.clone=function(e,t){var n=this;if(!e)return this.formNotifyService.warning(this.languageService.plsSelectCopyData,{hideTitle:!0}),O.EMPTY;if(!t)return this.formNotifyService.warning(this.languageService.pathIsRequired,{hideTitle:!0}),O.EMPTY;t.startsWith("/")||(t="/"+t),t=t.toLowerCase();var o=this.viewModel.bindingPath,a=this.repository,r=""+a.restService.baseUri+t,i=a.restService.buildRequestInfo(),s=this.buildIds(o);s.push(e);var c={body:{requestInfo:i,dataID:s.join(",")}};return this.formLoadingService.show(),a.proxy.request(r,"PUT",null,c).pipe(N.tap(function(){n.formLoadingService.hide()}),N.map(function(e){var t=e.returnValue,r=null;if(0===o.split("/").filter(function(e){return e}).length)r=n.repository.buildEntity(t),n.repository.entityCollection.addEntity(r,!0);else{var i=n.buildPath(o,n.viewModel.bindingData.list.currentId);r=a.entityManager.appendEntityByPath(i,t,t,!0)}return r}))},wn.prototype.cloneWithAttachment=function(e,t,r,n,o){var a=this;if(!e)return this.formNotifyService.warning(this.languageService.plsSelectCopyData,{hideTitle:!0}),O.EMPTY;if(!t)return this.formNotifyService.warning(this.languageService.pathIsRequired,{hideTitle:!0}),O.EMPTY;if(!r)throw new Error("附件udt字段路径不能为空");t.startsWith("/")||(t="/"+t),t=t.toLowerCase();var s=this.viewModel.bindingPath,c=this.repository,i=""+c.restService.baseUri+t,u=c.restService.buildRequestInfo(),l=this.buildIds(s);l.push(e);var p={body:{requestInfo:u,dataID:l.join(",")}};this.formLoadingService.show();var d=r.split(",").filter(function(e){return e}).map(function(e){return e.split("/").pop()});return c.proxy.request(i,"PUT",null,p).pipe(N.switchMap(function(e){var t=e.returnValue,r=null;if(0===s.split("/").filter(function(e){return e}).length)r=a.repository.buildEntity(t),a.repository.entityCollection.addEntity(r,!0);else{var i=a.buildPath(s,a.viewModel.bindingData.list.currentId);r=c.entityManager.appendEntityByPath(i,t,t,!0)}return a.copyRowFiles(r,d,n,o).pipe(N.switchMap(function(){return a.formLoadingService.hide(),a.repository.updateAllChanges().pipe(N.map(function(){return r}))}),N.catchError(function(e){a.formLoadingService.hide(),a.clearAttachmentInfo(r,d);var t=e.error;return"string"==typeof t&&(t=JSON.parse(t)),a.formErrorService&&a.formErrorService.exception(t.message||a.languageService.copyFailed,e),O.EMPTY}))}))},wn.prototype.clearAttachmentInfo=function(t,e){var r=this;try{e.forEach(function(e){r.setValueByPath(t,[e,"attachmentId"].join("."),null),r.setValueByPath(t,[e,"fileName"].join("."),null),r.setValueByPath(t,[e,"fileCreateTime"].join("."),null),r.setValueByPath(t,[e,"fileSize"].join("."),null)})}catch(i){console.log(i)}},wn.prototype.copyRow=function(e,t,r){var i=this;if(void 0===r&&(r=1),"number"!=typeof r&&(r=parseInt(r,10)),r<1)throw new Error("ArgumentError: repeat must >= 1");var n=this.viewModel.frameContext.appContext.frameContextManager.getFrameContextById(e),o=n.bindingData.list.currentId,a=n.viewModel.bindingPath||"/",s=null,c=null;if("/"===a)c=n.bindingData.list.currentItem;else{var u=a.split("/").filter(function(e){return e});c=n.bindingData.getValue(u).currentItem}if(s=c.toJSON(),!c.primaryKeyValue)return this.formNotifyService&&this.formNotifyService.warning(this.languageService.plsSelectCopyData,{hideTitle:!0}),O.EMPTY;var l=t.split(",").filter(function(e){return e}),p=new Array(r);return O.from(p).pipe(N.concatMap(function(){var e=null;if("/"!==a){var t=i.buildPath(a,o);e=i.repository.appendByPath(t)}else e=i.repository.append();return e.pipe(N.tap(function(e){s[e.primaryKey]=e.primaryValue,l.forEach(function(e){var t=e.split(".").filter(function(e){return e});1===t.length&&delete s[e],delete t.slice(0,-1).reduce(function(e,t,r){return e[t]},s)[t[t.length-1]]}),s=Object.assign({},e.toJSON(),s),e.load(s,{loadChild:!1})}),N.catchError(function(){return O.EMPTY}))}))},wn.prototype.afterIncrementalSelectHelpClose=function(e,t,r){var n=this,i=this.context&&this.context.eventParam||[];if(!r)throw new Error("associated field can`t be empty.");if(!t)throw new Error("mapFields can`t be empty.");var o=JSON.parse(t),a=r,s=this.viewModel.frameContext.root,c="/",u=this.injector.get(V.AppContext,null);if(u){var l=u.frameContextManager.getFrameContextById(e);if(!l)throw new Error("frameId is invalid!");c=l.viewModel.bindingPath||"/"}if((s.uiState.selections=i)&&Array.isArray(i)){var p=c.split("/").filter(function(e){return e}),d=this.viewModel.bindingData.getValue(p),f=d.toArray(),h=[];i.reduce(function(e,t){var r=t&&t[d.primaryKey]||null;return f.find(function(e){return e[a][a]===r})||e.push(t),e},h);var v=[];f.reduce(function(e,t){return-1===i.findIndex(function(e){return e[d.primaryKey]===t[a][a]})&&e.push(t.primaryKeyValue),e},v);var y=O.from(h).pipe(N.concatMap(function(t){var e=n.buildPath(c,n.viewModel.bindingData.list.currentId);return n.repository.appendByPath(e).pipe(N.tap(function(i){Object.keys(o).forEach(function(e){var r=n.getValueByPath(t,e);o[e].split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".").filter(function(e){return e});n.setValueByPath(i,t.join("."),r)})})}),N.catchError(function(){return O.EMPTY}))})),g=O.from(v).pipe(N.concatMap(function(e){var t=n.buildPath(c,n.viewModel.bindingData.list.currentId);return n.repository.removeByPath(t,e).pipe(N.tap(function(){n.repository.entityManager.removeEntityByPath(t,e)}),N.catchError(function(){return O.EMPTY}))}));return h.length<1&&v&&v.length<1?O.of(!0):O.concat(y,g).pipe(N.catchError(function(){return O.EMPTY}))}return O.of(!0)},wn.prototype.beforeMultiSelectHelpOpen=function(){return this.clearHelpSelections()},wn.prototype.afterMultiSelectHelpClose=function(e,t,r,i){var n=this.context&&this.context.eventParam||[];return n&&Array.isArray(n)&&(!n||n.length<1||this.onHelpClose.next({frameId:e,mapFields:t,data:n,commandFrameId:r,commandName:i})),O.of(!0)},wn.prototype.onHelpCloseHandler=function(e,t,r){var o=this;if(!t)throw new Error("mapFields can`t be empty.");var a=JSON.parse(t),i="/",n=this.injector.get(V.AppContext,null);if(n){var s=n.frameContextManager.getFrameContextById(e);if(!s)throw new Error("frameId is invalid!");i=s.viewModel.bindingPath||"/"}var c=this.viewModel.frameContext.root,u=this.repository,l=i.split("/").filter(function(e){return e});if((c.uiState.selections=r)&&Array.isArray(r)){var p=O.from(r).pipe(N.concatMap(function(n){var e=u.restService.buildRequestInfo();if(0<l.length){var r=o.buildPath(i,o.viewModel.bindingData.list.currentId);return u.restService.createByPath(r,e).pipe(N.tap(function(e){var t=e.returnValue,i=u.entityManager.appendEntityByPath(r,t,t);return Object.keys(a).forEach(function(e){var r=o.getValueByPath(n,e);a[e].split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".").filter(function(e){return e});o.setValueByPath(i,t.join("."),r)})}),i}))}return u.restService.create(null,e).pipe(N.tap(function(e){var t=e.returnValue,i=o.repository.buildEntity(t);return Object.keys(a).forEach(function(e){var r=o.getValueByPath(n,e);a[e].split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".").filter(function(e){return e});o.setValueByPath(i,t.join("."),r)})}),o.repository.entityCollection.addEntity(i),i}))}));return this.formLoadingService&&(this.suspendFrameContextEvent(e),this.formLoadingService.show(),this.formLoadingService.setSuspend(!0)),p.pipe(N.last()).pipe(N.switchMap(function(){var e=o.viewModel.bindingData.list.currentId;return e?u.updateChangesById(e):O.of(null)})).subscribe(function(){o.formLoadingService&&(o.resumeFrameContextEvent(e),o.formLoadingService.setSuspend(!1),o.formLoadingService.hide())},function(){o.formLoadingService&&(o.resumeFrameContextEvent(e),o.formLoadingService.setSuspend(!1),o.formLoadingService.hide())})}return O.of(null)},wn.prototype.suspendFrameContextEvent=function(e){var t=this.injector.get(V.AppContext,null);t&&(t.frameContextManager.getFrameContextById(e).suspend=!0)},wn.prototype.resumeFrameContextEvent=function(e){var t=this.injector.get(V.AppContext,null);if(t){var r=t.frameContextManager.getFrameContextById(e);r.suspend=!1,r.appContext.messagePipe.next("bindData")}},wn.prototype.setValueByPath=function(e,t,r){if(e){var i=t.split(".");i.length<=1?e[t]=r:i.slice(0,-1).reduce(function(e,t){return e.hasOwnProperty(t)||e.__proto__.hasOwnProperty(t)||(e[t]={}),e[t]},e)[i[i.length-1]]=r}},wn.prototype.getValueByPath=function(r,e){var t=e.split(".");if(!(t.length<1)){if(1===t.length)return r[e];var i=null;return t.forEach(function(e,t){i=0===t?r&&r[e]||null:i&&i[e]||null}),i}},wn.prototype.buildPath=function(e,t){var r="/"+t,i=e.split("/");if(0<i.length)for(var n=1;n<i.length-1;n++){var o=i[n],a=this.viewModel.bindingData[o];if(!a||!a.currentId)throw Error("获取子表完整路径出错，找不到"+a+"对应的子表，或对应子表没有当前行。");r+="/"+o+"/"+a.currentId}return r+="/"+i[i.length-1]},wn.prototype.buildIds=function(e){var r=this,t=e.split("/").filter(function(e){return e}),i=this.viewModel.bindingData.list.currentId,n=[],o=[];return 0<t.length&&(n.push(i),t.pop(),t.forEach(function(e){o.push(e);var t=r.viewModel.bindingData.getValue(o);t&&n.push(t.currentId)})),n},wn.prototype.updateBindingData=function(e,t){var r=e||{},i=r.controlType,n=void 0===i?null:i,o=r.value,a=void 0===o?null:o,s=r.options;if(n)if("lookup"===n||"combo-lookup"===n){var c=(void 0===s?{}:s).mapFields;this.updateLookupField(t,a,c)}else this.updateSimpleField(t,a,e)},wn.prototype.updateSimpleField=function(e,t,r){var i=this;if(r){var n=r.dataType,o=t;if("date"===n){var a=this.dateService.formatTo(t,"yyyy-MM-dd");o=a=a||"0001-01-01T00:00:00"}else"number"===n&&(o=Number(t)||0);var s=r.field;e.forEach(function(e){i.updateBindingList(e,s,o)})}},wn.prototype.updateLookupField=function(e,i,n){var o=this;if(n){var t=Object.keys(n),r=t.findIndex(function(e){return"id"===e});t.includes("id")&&0!==r&&(t.splice(r,1),t=ie(["id"],t)),i||t.reverse(),t.forEach(function(t){var r="";i&&(r=i instanceof Array?i.map(function(e){return o.getValue(t,e)}).join(","):o.getValue(t,i)),e.forEach(function(e){o.updateBindingList(e,n[t],r)})})}},wn.prototype.updateBindingList=function(e,t,r){if(this.viewModel&&t){var i=t.split(".").filter(function(e){return e}),n=this.bindingList.findById(e);if(i.length<2)n.setValue(t,r,!0,!0);else{var o=null,a=i.slice(0,i.length-1),s=i[i.length-1];a.forEach(function(e){o=o&&o[e]||n[e]}),o.setValue(s,r,!0,!0)}}},wn.prototype.getBindingPathArray=function(){var e=this.viewModel.bindingPath;return e?e.split("/").filter(function(e){return""!==e}):[]},wn.prototype.getValue=function(e,t){return-1===e.indexOf(".")?t[e]:e.split(".").reduce(function(e,t){return e[t]},t)},Object.defineProperty(wn.prototype,"bindingList",{get:function(){if("/"===this.viewModel.bindingPath||!this.viewModel.bindingPath)return this.viewModel.bindingData.list;var e=this.viewModel.bindingPath.substr(1),t=(e=e[0].toLowerCase()+e.substring(1,e.length)).split("/").filter(function(e){return""!==e});return this.viewModel.bindingData.getValue(t)},enumerable:!0,configurable:!0}),wn.prototype.mappingRow=function(t,i,n,e){var o=this;Object.keys(i).forEach(function(e){var r=o.getValueByPath(t,e);i[e].split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".").filter(function(e){return e});o.setValueByPath(n,t.join("."),r)})})},wn.prototype.getFrameContextById=function(e){if(!e)return null;var t=this.injector.get(V.AppContext,null),r=null;return t&&(r=t.frameContextManager.getFrameContextById(e)),r},wn.prototype.getEntityByPath=function(n,e,t){e=ie(e);var r=n.bindingData.list.currentId,i=n.repository.entityCollection.getEntityById(r),o=[],a=e.pop(),s=e.reduce(function(e,t){if(o.push(t),e&&(e.hasOwnProperty(t)||e.__proto__.hasOwnProperty(t))){var r=e[t];if(r&&r instanceof V.EntityList){var i=n.bindingData.getValue(o).currentId;return r.get(i)}return r}return null},i);if(s instanceof V.Entity){var c=s[a];if(c)return c.get(t);throw new Error("无效的bindingPath.")}throw new Error("无效的bindingPath.")},wn.prototype.endEdit=function(e){var t=e&&e.getFormAppContext();return O.of(null).pipe(N.tap(function(){t&&t.messagePipe.next({type:"endEdit"})}),N.delay(5))},wn.decorators=[{type:k.Injectable}],wn.ctorParameters=function(){return[{type:k.Injector},{type:fi},{type:V.ViewModel},{type:V.Repository},{type:A.BatchEditDialogService},{type:x.DateTimeHelperService},{type:$},{type:Te},{type:E.UploadService}]},wn);function wn(e,t,r,i,n,o,a,s,c){var u=this;this.injector=e,this.componentManagerService=t,this.viewModel=r,this.repository=i,this.batchEditDialogService=n,this.dateService=o,this.languageService=a,this.formNotifyService=s,this.fileUploadService=c,this.formLoadingService=this.injector.get(W,null),this.languageService||(this.languageService=$.getInstance()),this.formNotifyService||(this.formNotifyService=this.injector.get(Te,null)),this.onHelpClose=new O.Subject,this.onHelpClose.subscribe(function(e){var t=e||{},r=t.frameId,i=void 0===r?"":r,n=t.mapFields,o=void 0===n?"":n,a=t.data,s=void 0===a?[]:a;u.onHelpCloseHandler(i,o,s)})}var xn=(Object.defineProperty(En.prototype,"repository",{get:function(){return this.frameContext.repository},enumerable:!0,configurable:!0}),Object.defineProperty(En.prototype,"params",{get:function(){return this.context&&this.context.eventParam||{}},enumerable:!0,configurable:!0}),En.prototype.addComment=function(e,t,r,i,n,o){var a=this;if(!(e=e||this.frameContext&&this.frameContext.bindingData.list.currentId||null))return O.EMPTY;var s=this.buildAddCommentParam(e,i,o,t,n,r),c=this.repository.restService,u=M.BasePathService.convertPath("/api/runtime/comment/v1.0/bill-comment/comment"),l=c.buildRequestInfo(),p={body:ee({requestInfo:l},s)};return this.loadingService.show(),c.invoke(u,"POST",null,p).pipe(N.tap(function(){a.loadingService.hide()}))},En.prototype.queryComments=function(e,t,r,i){var n=this;if(!(e=e||this.frameContext&&this.frameContext.bindingData.list.currentId||null))return O.EMPTY;var o=this.repository.restService,a=this.buildQueryCommentsUrl(e,r,i,t);return this.loadingService.show(),o.invoke(a,"GET").pipe(N.tap(function(){n.loadingService.hide()}))},En.prototype.queryAllOrgs=function(){var e=this,t=this.repository.restService,r=M.BasePathService.convertPath('/api/runtime/sys/v1.0/sysOrgs?param={"layer":"1"}');return this.loadingService.show(),t.invoke(r,"GET").pipe(N.tap(function(){e.loadingService.hide()}))},En.prototype.queryFrequentAtUsers=function(e,t){var r=this,i=this.repository.restService,n=this.buildQueryFrequentAtUsersUrl(e,t);return this.loadingService.show(),i.invoke(n,"GET").pipe(N.tap(function(){r.loadingService.hide()}))},En.prototype.queryAtUsers=function(e,t,r){var i=this,n=this.repository.restService,o=this.buildQueryAtUsersUrl(e,t,r);return this.loadingService.show(),n.invoke(o,"GET").pipe(N.tap(function(){i.loadingService.hide()}))},En.prototype.buildQueryCommentsUrl=function(e,t,r,i){return null==t&&(t=this.params.pageIndex||0),null==r&&(r=this.params.pageSize||10),this.repository.serverUri,M.BasePathService.convertPath("/api/runtime/comment/v1.0/bill-comment/comment/byBill?configId="+i+"&billId="+e+"&pageSize="+r+"&pageIndex="+t)},En.prototype.buildQueryAtUsersUrl=function(e,t,r){var i=[];return null==t&&(t=this.params.pageIndex||0),null==r&&(r=this.params.pageSize||1e3),e&&i.push("param="+e),i.push("pageSize="+r),i.push("pageIndex="+t),M.BasePathService.convertPath("/api/runtime/comment/v1.0/bill-comment/atUser?"+i.join("&"))},En.prototype.buildQueryFrequentAtUsersUrl=function(e,t){var r=[];return null==e&&(e=this.params.pageIndex||0),null==t&&(t=this.params.pageSize||6),r.push("pageSize="+t),r.push("pageIndex="+e),M.BasePathService.convertPath("/api/runtime/comment/v1.0/bill-comment/frequentAtUsers?"+r.join("&"))},En.prototype.buildAddCommentParam=function(e,t,r,i,n,o){return void 0===t&&(t=this.params.text),void 0===r&&(r=this.params.parentId),void 0===n&&(n=this.params.visibility),{bill:{billId:e,configId:o,summary:i},comment:{billId:e,configId:o,parentId:r||null,text:t,visibility:n}}},En.decorators=[{type:k.Injectable}],En.ctorParameters=function(){return[{type:k.Injector},{type:V.FrameContext},{type:W},{type:Ge}]},En);function En(e,t,r,i){this.injector=e,this.frameContext=t,this.loadingService=r,this.runtimeFrameworkService=i}var Pn=(Dn.prototype.setCurrentFilterConditions=function(e){this.frameContext.uiState.currentFilterConditions=e},Dn.decorators=[{type:k.Injectable}],Dn.ctorParameters=function(){return[{type:V.FrameContext}]},Dn);function Dn(e){this.frameContext=e}var Fn=(Mn.prototype.load=function(){this.modulePath.endsWith("/")&&(this.modulePath=this.modulePath.substring(0,this.modulePath.length-1));var e=M.BasePathService.convertPath(this.modulePath+"/expressions/form.manifest.json?version="+(new Date).valueOf().toString()),t=Mn.mainfests.get(this.modulePath);if(t)return t;var r=this.httpClient.get(e,{responseType:"json"}).pipe(N.share());return Mn.mainfests.set(this.modulePath,r),r},Mn.mainfests=new Map,Mn.decorators=[{type:k.Injectable}],Mn.ctorParameters=function(){return[{type:k.Injector},{type:undefined,decorators:[{type:k.Inject,args:[V.FORM_PATH_TOKEN]}]},{type:P.HttpClient}]},Mn);function Mn(e,t,r){this.injector=e,this.modulePath=t,this.httpClient=r}var Tn=(Rn.prototype.load=function(){var a=this;return this.modulePath.endsWith("/")&&(this.modulePath=this.modulePath.substring(0,this.modulePath.length-1)),this.formManifestService.load().pipe(N.switchMap(function(e){var t=e.expressions.find(function(e){return e.ns===a.frameContext.namespace});if(t){var r=M.BasePathService.convertPath(a.modulePath+"/expressions/"+t.path+"?version="+(new Date).valueOf().toString()),i=M.BasePathService.convertPath(a.modulePath+"/expressions/"+t.path),n=Rn.mainfests.get(i);if(n)return n;var o=a.httpClient.get(r,{responseType:"json"}).pipe(N.share());return Rn.mainfests.set(i,o),o}return O.of({})}))},Rn.mainfests=new Map,Rn.decorators=[{type:k.Injectable}],Rn.ctorParameters=function(){return[{type:k.Injector},{type:V.FrameContext},{type:P.HttpClient},{type:undefined,decorators:[{type:k.Inject,args:[V.FORM_PATH_TOKEN]}]},{type:undefined,decorators:[{type:k.Inject,args:[V.FORM_MANIFEST_SERVICE_TOKEN]}]}]},Rn);function Rn(e,t,r,i,n){this.injector=e,this.frameContext=t,this.httpClient=r,this.modulePath=i,this.formManifestService=n}var On=(Object.defineProperty(Nn.prototype,"formats",{get:function(){var e=this.userSettings||{},t=e.dateFormat,r=void 0===t?null:t,i=e.timeFormat,n=void 0===i?null:i,o=null;r&&n&&(o=r+" "+n);var a={dateFormat:r,timeFormat:n,dateTimeFormat:o},s=this.numberFormat||{},c=s.negativeSign,u=s.numberDecimalDigits,l=s.numberDecimalSeparator,p=s.numberGroupSeparator;return{date:a,number:{negativeSign:void 0===c?null:c,numberDecimalDigits:void 0===u?null:u,numberDecimalSeparator:void 0===l?null:l,numberGroupSeparator:void 0===p?null:p}}},enumerable:!0,configurable:!0}),Nn.prototype.localize=function(e,t){return t&&e?"date"===(t=t.toLowerCase())?this.transformDate(e):"datetime"===t?this.transformDateTime(e):"number"===t?this.transformNumber(e):e:e},Nn.prototype.getFormat=function(e){return"date"===(e=e&&e.toLowerCase())?this.formats.date.dateFormat:"datetime"===e?this.formats.date.dateTimeFormat:""},Nn.prototype.transformDate=function(e){var t=this.userSettings&&this.userSettings.dateFormat||"YYYY-MM-DD";if(!t||!e)return e;var r=D(e);return r.isValid()?(t=this.parseDateFormat(t),r.format(t)):e},Nn.prototype.transformDateTime=function(e){var t=this.userSettings&&this.userSettings.dateFormat||"YYYY-MM-DD",r=this.userSettings&&this.userSettings.timeFormat||"HH:mm:ss";if(!t||!r)return e;var i=D(e);if(!i.isValid())return e;var n=(t=t&&this.parseDateFormat(t))+" "+(r=r&&this.parseTimeFormat(r));return i.format(n)},Nn.prototype.transformNumber=function(e){if(null===e||e===undefined||""===e)return"";var t=new R.BigNumber(e);if(!R.BigNumber.isBigNumber(t))return e;var r=t.isNegative(),i=this.buildNumberFormat(),n=this.numberFormat||{},o=n.negativeSign,a=void 0===o?null:o,s=n.numberDecimalDigits,c=void 0===s?null:s;return r&&null!==a?(i.prefix=a,t.absoluteValue().toFormat(c,null,i)):t.toFormat(c,null,i)},Nn.prototype.parseDateFormat=function(e){return e.replace(/y/g,"Y").replace(/d/g,"D")},Nn.prototype.parseTimeFormat=function(e){return e.replace(/M/g,"m")},Nn.prototype.buildNumberFormat=function(){if(this.numberFormat){var e=this.numberFormat,t=e.numberDecimalSeparator,r=void 0===t?null:t,i=e.numberGroupSeparator,n=void 0===i?null:i,o={groupSize:3};return null!==r&&(o.decimalSeparator=r),null!==n&&(o.groupSeparator=n),o}},Object.defineProperty(Nn.prototype,"numberFormat",{get:function(){return this.userSettings&&this.userSettings.numberFormat||null},enumerable:!0,configurable:!0}),Nn.decorators=[{type:k.Injectable}],Nn.ctorParameters=function(){return[{type:k.Injector},{type:undefined,decorators:[{type:k.Inject,args:[V.UserSettingsToken]}]}]},Nn);function Nn(e,t){this.injector=e,this.userSettings=t}var An=(jn.prototype.blink=function(e,t){if("string"==typeof e&&(e=e.split(",").filter(function(e){return e})),!Array.isArray(e)||e.length<1)return O.EMPTY;"string"==typeof t&&(t=t.trim()),t=t||600,t=parseInt(t),(isNaN(t)||t<=0)&&(t=600);var r=e.map(function(e){return{idOrEl:e}});this.attentionService.catchAttention(r,t)},jn.decorators=[{type:k.Injectable}],jn.ctorParameters=function(){return[{type:k.Injector},{type:V.FrameContext},{type:F.AttentionService}]},jn);function jn(e,t,r){this.injector=e,this.frameContext=t,this.attentionService=r}var Bn,Ln,kn,Vn=(_n.prototype.getFeaturesByMaterialId=function(e){var t=M.BasePathService.convertPath("/api/scm/scmfnd/v1.0/scmcommoncmpservice/service/getmaterialprops"),r={body:{materialID:e}};return this.repository.proxy.request(t,"put",null,r)},_n.prototype.getConfigedValueByFeatureId=function(e,t,r){void 0===r&&(r="Materials");var i=M.BasePathService.convertPath("/api/bf/df/v1.0/charactconfigservice/service/getcharactconfiginfo"),n={body:{objType:r,objID:e,configID:t}};return this.repository.proxy.request(i,"put",null,n)},_n.prototype.applyFeatures=function(e,t,r){void 0===r&&(r="Materials");var i={body:{objType:r,objID:e,charactValue:t}};return this.repository.proxy.request(M.BasePathService.convertPath("/api/bf/df/v1.0/charactconfigservice/service/matchcharactconfigid"),"put",null,i)},_n.prototype.getHelpInfo=function(e,t,r){var i=M.BasePathService.convertPath("/api/scm/scmfnd/v1.0/scmcommoncmpservice/service/gethelpdata"),n={};r&&(r.pageIndex&&(n.pageIndex=JSON.stringify(r.pageIndex-0)),r.pageSize&&(n.pageSize=JSON.stringify(r.pageSize-0)),r.condition&&(n.condition=JSON.stringify(r.condition)),r.searchValue&&(n.search=r.searchValue));var o={body:{helpID:e,queryParam:JSON.stringify(n),filterStr:t}};return this.repository.proxy.request(i,"put",null,o)},_n.decorators=[{type:k.Injectable}],_n.ctorParameters=function(){return[{type:k.Injector},{type:V.Repository}]},_n);function _n(e,t){this.injector=e,this.repository=t}Ln=Bn=Bn||{},(kn=Ln.InputType||(Ln.InputType={}))["enum"]="Enum",kn.string="String",kn.help="Help",kn.number="Number",kn.date="Date";var qn=(Un.prototype.getFeaturesByMaterialId=function(e){var o=this;return this.repository.getFeaturesByMaterialId(e).pipe(N.map(function(e){if(!e||!e.returnValue)return null;var t=JSON.parse(e.returnValue),r={propset:[],props:[]},i=t.propset||null,n=t.props||null;return i&&Array.isArray(i)&&(i.map(function(e){return e.name=o.translateName(e),e}),r.propset=i),n&&Array.isArray(n)&&0<n.length&&(n.map(function(e){return e.name=o.translateName(e),e.inputtype===Bn.InputType["enum"]&&e.enuminfo&&(e.data=JSON.parse(e.enuminfo)),e.isreadonly="1"===e.isreadonly,e.isrequired="1"===e.isrequired,e}),r.props=n),r}))},Un.prototype.getConfigedValueByFeatureId=function(e,t,r){return void 0===r&&(r="Materials"),this.repository.getConfigedValueByFeatureId(e,t,r).pipe(N.map(function(e){return JSON.parse(e)}))},Un.prototype.applyFeatures=function(e,t,r){return void 0===r&&(r="Materials"),this.repository.applyFeatures(e,t,r).pipe(N.map(function(e){return JSON.parse(e)}))},Un.prototype.getHelpInfo=function(e,t,r){var i=M.BasePathService.convertPath("/api/scm/scmfnd/v1.0/scmcommoncmpservice/service/gethelpdata"),n={};r&&(r.pageIndex&&(n.pageIndex=JSON.stringify(r.pageIndex-0)),r.pageSize&&(n.pageSize=JSON.stringify(r.pageSize-0)),r.condition&&(n.condition=JSON.stringify(r.condition)),r.searchValue&&(n.search=r.searchValue));var o={body:{helpID:e,queryParam:JSON.stringify(n),filterStr:t}};return null.proxy.request(i,"put",null,o).pipe(N.map(function(e){return JSON.parse(e)}))},Un.prototype.translateName=function(e){if(!e)return null;var t=null;switch(this.localeId){case"en":t=e.name_en;break;case"zh-CHS":t=e.name_chs;break;case"zh-CHT":t=e.name_cht;break;default:t=e.name_chs}return t},Un.decorators=[{type:k.Injectable}],Un.ctorParameters=function(){return[{type:k.Injector},{type:Vn},{type:String,decorators:[{type:k.Optional},{type:k.Inject,args:[k.LOCALE_ID]}]}]},Un);function Un(e,t,r){this.injector=e,this.repository=t,this.localeId=r,this.localeId=this.localeId||"zh-CHS"}var Wn=(Hn.prototype.edit=function(e,t,i){var n=this;if(!e)throw new Error("[FeatureEditService]物料id不能为空！");return"string"==typeof(i=i||{})&&i.startsWith("{")&&i.endsWith("}")&&(i=JSON.parse(i)),i.getHelpInfo=this.featureDataService.getHelpInfo,this.loadingService.show(),this.featureDataService.getFeaturesByMaterialId(e).pipe(N.tap(function(e){n.loadingService.hide();var t=e||null;if(t){var r=JSON.parse(t).props||null;if(!r||r.length<1)return void n.notifyService.warning(n.languageService.propsIsEmpty);n.featureEditorService.show(r,i)}else n.notifyService.error(n.languageService.propsIsEmpty)}))},Hn.prototype.buildFeatures=function(e,t){var i=this;return this.featureDataService.getFeaturesByMaterialId(e).pipe(N.switchMap(function(r){return t?i.featureDataService.getConfigedValueByFeatureId(t,t).pipe(N.map(function(e){var t=r.props;return i.mergeFeatures(t,e)})):O.of(r.props)}))},Hn.prototype.mergeFeatures=function(e,t){return null},Hn.decorators=[{type:k.Injectable}],Hn.ctorParameters=function(){return[{type:k.Injector},{type:T.FeatureEditorService},{type:qn},{type:W},{type:Te},{type:$}]},Hn);function Hn(e,t,r,i,n,o){this.injector=e,this.featureEditorService=t,this.featureDataService=r,this.loadingService=i,this.notifyService=n,this.languageService=o}var Kn=(zn.prototype.execute=function(e,t){var r,i=this.resolveService.resolve(e),n=V.ExpressionUtil.getGroupFunctionDependency(e,this.frameContext.repository.entityTypeInfo),o=this.buildEntityContext(i,n),a=this.buildStateContext(),s=ee(((r={})[this.entityOriginalNodeCode]=o,r),a,{BigNumber:R.BigNumber,frameContext:this.frameContext,bindingData:this.frameContext.bindingData,repository:this.frameContext.repository},t);return this.expressionExecutor.eval(e,s)},zn.prototype.executeAsync=function(e,t){var r=this.execute(e,t);return O.of(r)},zn.prototype.buildEntityContext=function(e,i,t){var n=this,o=!1;e.forEach(function(t){var e=n.isEntityDependency(t),r=-1!==i.findIndex(function(e){return e===t});e&&r&&1==t.split("/").filter(function(e){return e}).length-1&&(o=!0)});var r=this.getEntity();if(o){var a=this.frameContext.repository.entityCollection.toJSON();r.__type__="List",r.__items__=a}return r},zn.prototype.isEntityDependency=function(e){return e.startsWith(V.ENTITY_TEMPLATE)},zn.prototype.getEntity=function(){var e=this.frameContext.repository.entityTypeInfo,o=this.frameContext.bindingData,t=[];V.ExpressionUtil.getChildrenEntityPaths(e,t);var a=this.frameContext.bindingData.list.currentItem.toJSON();return a.__type__="Entity",!t||t.length<1||t.forEach(function(e){var t=V.ExpressionUtil.getCurrentRowByPaths(e,o);if(t){var r=e.pop(),i=e.reduce(function(e,t){return e&&e[t]||null},a),n=ee({__items__:ie(i[r])},t,{__type__:"List"});i[r]=n}}),a},Object.defineProperty(zn.prototype,"entityOriginalNodeCode",{get:function(){var e=this.injector.get(V.Repository);return e&&e.entityTypeInfo&&e.entityTypeInfo.entityInfo&&e.entityTypeInfo.entityInfo.originalCode||null},enumerable:!0,configurable:!0}),zn.prototype.buildStateContext=function(){var e=this.frameContext.namespace,t=this.injector.get(V.AppContext,null).frameContextManager.getFrameContextsByNamespace(e),r={};if(t&&0<t.length){var i=t[0].getVirtualRootFrameContext();if(i){var n=i.viewModel.uiState;(Object.getOwnPropertyNames(n)||[]).forEach(function(e){null!==e.match(/^[a-zA-Z0-9_\$]+$/g)&&(r[e]=n[e])})}}return r},zn.decorators=[{type:k.Injectable}],zn.ctorParameters=function(){return[{type:k.Injector},{type:V.ResolveService},{type:V.FrameContext},{type:V.ExpressionExecutor}]},zn);function zn(e,t,r,i){this.injector=e,this.resolveService=t,this.frameContext=r,this.expressionExecutor=i}var Jn=(Yn.prototype.detectChanges=function(e){(e=!0===e||"true"===e)&&this.appRef?this.appRef.tick():this.cd&&this.cd.detectChanges()},Yn.prototype.detectChangesAfter=function(e,t){var r=this;t=!0===t||"true"===t,isNaN(e)||(t&&this.appRef?window.setTimeout(function(){r.appRef.tick()},e):this.cd&&window.setTimeout(function(){r.cd.detectChanges()},e))},Yn.decorators=[{type:k.Injectable}],Yn.ctorParameters=function(){return[{type:k.Injector},{type:k.ChangeDetectorRef},{type:k.ApplicationRef}]},Yn);function Yn(e,t,r){this.injector=e,this.cd=t,this.appRef=r}var Gn=($n.prototype.confirm=function(){},$n.prototype.cancel=function(e,t){var r=this.frameContext.appContext.frameContextManager.getFrameContextById(e);if(!r)throw new Error("[PopUpService]Invalid frameId "+e);var i=this.frameContext.bindingData.list.currentId,n=r.viewModel.bindingPath,o=n.split("/").filter(function(e){return e});if(!t){var a=this.frameContext.bindingData.getList();t=a.currentId}var s=this.repository,c=V.DataPathCreator.createByShortPathFromRoot(o,s.entityManager,this.frameContext.bindingData).toArray().map(function(e){return e.split(":")[1]}),u=Array.from(c);u.pop();var l=this.frameContext.frameComponent.dialogRef;if(u.length<1){var p=this.repository.entityCollection.getEntityById(t),d=p.originalData;p.load(d,{loadChild:!1})}else{var f=s.entityManager.getEntityNodeByPath(u);if(f){var h=(d=f.originalData).find(function(e){return e.id===t});if(!h){var v=this.buildPath(n,i);return this.messageService.confirm(this.languageService.cancelWithoutSave).pipe(N.switchMap(function(e){return e?s.removeEntityByPath(v,t).pipe(N.tap(function(){s.entityManager.removeEntityByPath(v,t),0===f.count()&&l&&l.close()})):O.EMPTY}))}var y=s.entityManager.getEntityByPath(c);if(y.changes&&0<y.changes.length)return this.messageService.confirm(this.languageService.cancelWithoutSave).pipe(N.tap(function(e){e&&(y.load(h,{loadChild:!1}),y.changes.splice(0,y.changes.length))}));l&&l.close()}}return O.of([])},$n.prototype.updateCurrentRow=function(a){var s=this,c=this.frameContext.viewModel.bindingPath,e=c.split("/").filter(function(e){return e}),u=this.frameContext.getVirtualRootFrameContext(),t=u.bindingData.list.currentId;if(this.frameContext.bindingData.list.setCurrentId(t),0<e.length){var l=[];e.forEach(function(e,t,r){l.push(e);var i=u.bindingData.getValue(l);if(i){var n=i.currentId,o=s.frameContext.bindingData.getValue(l);t===c.length-1&&a?o.setCurrentId(a):o&&o.setCurrentId(n)}})}},$n.prototype.closeCheck=function(){var e=this.frameContext.viewModel.bindingPath.split("/").filter(function(e){return e}),t=this.repository,r=V.DataPathCreator.createByShortPathFromRoot(e,t.entityManager,this.frameContext.bindingData).toArray().map(function(e){return e.split(":")[1]}),i=Array.from(r);i.pop();var n=t.entityManager.getEntityNodeByPath(i),o=this.frameContext.frameComponent.dialogRef;0===n.count()&&o&&o.close()},$n.prototype.removeRow=function(e,t,r){void 0===r&&(r=!0);var i=e?this.frameContext.appContext.frameContextManager.getFrameContextById(e):this.frameContext;if(!i)throw new Error("无效的组件id："+e);if(!t){var n=i.bindingData.getList();t=n.currentId}var o=i.viewModel.bindingPath,a=o.split("/").filter(function(e){return e}),s=this.buildPath(o,this.frameContext.bindingData.list.currentId),c=this.repository;"string"==typeof r&&(r="false"!==r.trim());var u=O.of(!0);return r&&(u=this.messageService.confirm(this.languageService.confirmDeletion)),u.pipe(N.switchMap(function(e){return e?0===a.length?c.removeEntityById(t,!1):c.removeEntityByPath(s,t).pipe(N.tap(function(){c.entityManager.removeEntityByPath(s,t)})):O.EMPTY}))},$n.prototype.closeDialog=function(e){var t=this.frameContext,r=null;if(e){if(!(t=this.frameContext.appContext.frameContextManager.getFrameContextById(e)))throw new Error("指定了无效的组件id");r=t.frameComponent.dialogRef}else r=(r=t.frameComponent.dialogRef)||this.frameContext.parent.frameComponent.dialogRef;if(!r)throw new Error("无法获取弹窗组件实例");r.close()},$n.prototype.cancelChanges=function(e,t,r){var a=this;void 0===r&&(r=!0);var s=this.getFrameContext(e);t=this.getPrimaryValue(e,t);var c=this.getPersisteData(e,t);"string"==typeof r&&(r="false"!==r.trim().toLowerCase());var i=this.isDataChanged(c,e,t),n=O.of(!0);return r&&i&&(n=this.messageService.confirm(this.languageService.cancelWithoutSave)),n.pipe(N.switchMap(function(e){if(e){var t=s.repository,r=s.viewModel.bindingPath.split("/").filter(function(e){return e}),i=V.DataPathCreator.createByShortPathFromRoot(r,t.entityManager,a.frameContext.bindingData).toArray().map(function(e){return e.split(":")[1]}),n=Array.from(i),o=t.entityManager.getEntityNodeByPath(n);return o&&o.load(c),O.of(!0)}return O.EMPTY}))},$n.prototype.persiste=function(e,t){var r=this.getBindingObject(e,t);r.__PSESISTE__DATA=r.toJSON()},$n.prototype.getPersisteData=function(e,t){return this.getBindingObject(e,t).__PSESISTE__DATA},$n.prototype.isDataChanged=function(e,t,r){var i=this.getBindingObject(t,r).toJSON();return JSON.stringify(i)!==JSON.stringify(e)},$n.prototype.getBindingObject=function(e,t){var r=this.getFrameContext(e);t=this.getPrimaryValue(e,t);var i=r.viewModel.bindingPath.split("/").filter(function(e){return e}),n=r.bindingData.getValue(i);if(!n||n.length<1)throw new Error("无法找到id为:"+t+"的数据");return n.currentItem},$n.prototype.buildPath=function(e,t){var r="/"+t,i=e.split("/");if(0<i.length)for(var n=1;n<i.length-1;n++){var o=i[n],a=this.frameContext.viewModel.bindingData[o];if(!a||!a.currentId)throw Error("获取子表完整路径出错，找不到"+a+"对应的子表，或对应子表没有当前行。");r+="/"+o+"/"+a.currentId}return r+="/"+i[i.length-1]},$n.prototype.getFrameContext=function(e){var t=e?this.frameContext.appContext.frameContextManager.getFrameContextById(e):this.frameContext;if(!t)throw new Error("无效的组件id："+e);return t},$n.prototype.getPrimaryValue=function(e,t){if(!t){var r=this.getFrameContext(e);if(!r)throw new Error("无效的组件id："+e);var i=r.bindingData.getList();if(!i||i.length<1)throw new Error("无效的主键:"+t);t=i.currentId}return t},$n.decorators=[{type:k.Injectable}],$n.ctorParameters=function(){return[{type:k.Injector},{type:V.FrameContext},{type:V.Repository},{type:$},{type:Fe}]},$n);function $n(e,t,r,i,n){this.injector=e,this.frameContext=t,this.repository=r,this.languageService=i,this.messageService=n}var Qn=(Xn.prototype.getIndex=function(t,r){return Array.isArray(t)?t.reduce(function(e,t){return e.concat(t)},[]).findIndex(function(e){return e.field===r}):"[object Object]"===Object.prototype.toString.call(t)?Object.keys(t).findIndex(function(e){return t[e].binding===r}):void 0},Xn.decorators=[{type:k.Injectable}],Xn.ctorParameters=function(){return[{type:k.Injector},{type:V.AppContext},{type:V.Repository}]},Xn);function Xn(e,t,r){this.injector=e,this.appContext=t,this.repository=r}var Zn=(eo.prototype.getGridColumns=function(e){var t=e&&e.viewModel&&e.viewModel.dataGridColumnsName||null;return t&&e.viewModel[t]||[]},eo.decorators=[{type:k.Injectable}],eo.ctorParameters=function(){return[]},eo);function eo(){}var to=(ro.prototype.resetChildrenPagination=function(){var r=this.frameContext.repository.entityCollection.paginationInfo||{},i=this.frameContext.repository.entityTypeInfo.getPropNamesByGroup(V.DataPropGroup.List)||[];r&&0<Object.keys(r).length&&(Object.keys(r).forEach(function(t){var e=r[t];"[object Object]"===Object.prototype.toString.apply(e)&&(i.find(function(e){return e=e.slice(0,-1),t.startsWith(e+"_")})?delete r[t]:(r[t].pageIndex=1,delete r[t].total,delete r[t].pageCount))}),this.frameContext.repository.entityCollection.updatePaginationInfoByPath("/",r))},ro.decorators=[{type:k.Injectable}],ro.ctorParameters=function(){return[{type:k.Injector},{type:V.FrameContext}]},ro);function ro(e,t){this.injector=e,this.frameContext=t}var io=[vt,tr,sr,Rt,Nt,jt,pt,Vt,qt,Wt,Kt,Jt,hr,Nr,Hr,St,yr,Vr,qr,Lr,jr,Cn,zr,Yr,$r,ti,ii,oi,bt,wt,ui,et,si,Qe,it,Ue,vi,{provide:j.QUERYSOLUTION_HANDLER_TOKEN,useClass:yn},{provide:B.LISTFILTER_HANDLER_TOKEN,useClass:Pn},mn,A.BatchEditDialogService,In,xn,On,dr,An,T.FeatureEditorService,qn,Wn,Kn,Gn,Jn,Qn,Qt,Gt,Zt,Zn,to,{provide:V.FORM_MANIFEST_SERVICE_TOKEN,useClass:Fn},{provide:V.FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN,useClass:Tn},{provide:V.MESSAGE_SERVICE_TOKEN,useClass:Fe},{provide:V.NOTIFY_SERVICE_TOKEN,useClass:Te},{provide:V.FRAME_COMPONENT_INIT_HANDLER_TOKEN,useClass:Fi,multi:!0}],no=[{provide:"ValidationService",useClass:vt},{provide:"FocusInvalidService",useClass:tr},{provide:"ChangeItemService",useClass:sr},{provide:"UIStateService",useClass:Rt},{provide:"StateMachineService",useClass:Nt},{provide:"BindingDataService",useClass:jt},{provide:"CommandService",useClass:pt},{provide:"EntityTraversingService",useClass:Vt},{provide:"EntityManipulationService",useClass:qt},{provide:"EntityAggregationService",useClass:Wt},{provide:"EntityListService",useClass:Kt},{provide:"EntityService",useClass:Jt},{provide:"ListDataService",useClass:hr},{provide:"TreeDataService",useClass:Nr},{provide:"SubTreeDataService",useClass:Hr},{provide:"CardDataService",useClass:St},{provide:"SubListDataService",useClass:yr},{provide:"RemoveDataService",useClass:Vr},{provide:"SaveDataService",useClass:qr},{provide:"EditDataService",useClass:Lr},{provide:"FilterConditionDataService",useClass:jr},{provide:"RemoteSummaryService",useClass:Cn},{provide:"BeActionService",useClass:zr},{provide:"ApproveService",useClass:Yr},{provide:"PrintService",useClass:$r},{provide:"AttachmentDataService",useClass:ti},{provide:"AttachmentService",useClass:ii},{provide:"FileService",useClass:oi},{provide:"NavigationMiddlewareService",useClass:bt},{provide:"GridMiddlewareService",useClass:wt},{provide:"SidebarService",useClass:ui},{provide:"FarrisFormService",useClass:et},{provide:"DialogService",useClass:si},{provide:"NavigationEventService",useClass:Qe},{provide:"NavigationService",useClass:it},{provide:"RouterService",useClass:Ue},{provide:"AuthorityService",useClass:vi},{provide:j.QUERYSOLUTION_HANDLER_TOKEN,useClass:yn},{provide:B.LISTFILTER_HANDLER_TOKEN,useClass:Pn},{provide:"EndEditService",useClass:mn},{provide:"BatchEditDialogService",useClass:A.BatchEditDialogService},{provide:"BatchEditService",useClass:In},{provide:"DiscussionGroupService",useClass:xn},{provide:"LocalizationService",useClass:On},{provide:"DataGridService",useClass:dr},{provide:"FormAttentionService",useClass:An},{provide:V.FORM_MANIFEST_SERVICE_TOKEN,useClass:Fn},{provide:V.FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN,useClass:Tn}],oo=(ao.decorators=[{type:k.NgModule,args:[{providers:Bi,imports:[L.WfTaskHandlerModule],exports:[L.WfTaskHandlerModule]}]}],ao.ctorParameters=function(){return[{type:Pi}]},ao);function ao(e){this.workFlowMessage=e,this.workFlowMessage&&this.workFlowMessage.setup()}var so=(co.prototype.sendMessage=function(e){return this.rtfService.subjectNotify(this.token,e),this},co.prototype.listen=function(e){var t=this,r=V.UID.create();return this.rtfService.subjectResponse(this.token,e,r),function(){t.rtfService.responseUnSubscribe(t.token,r)}},co.prototype.destory=function(){this.rtfService.subjectRemove(this.token)},co);function co(e,t){this.token=e,this.rtfService=t}var uo=(lo.get=function(e){return new so(e,this.rtfService)},lo.create=function(e,t,r){var i=null;if(t){var n=this.querystringService.parse(window.location.hash);i={funcId:n.funcId,appId:n.appId,appEntrance:n.appEntrance}}var o=this.rtfService.subjectRegister(e,i,r);return o?new so(o,this.rtfService):null},lo.rtfService=new Ge,lo.querystringService=new Je,lo);function lo(){}var po=(fo.prototype.handle=function(e,t){var r=t&&t.isException||!1,i=t&&t.hasThrowError||!1,n=t&&t.eventBus||null,o=t&&t.error||null,a=t&&t.formAppContext||null,s=this.collect(e,r,i,n,o,a);s&&s.form&&0<s.form.length?s.form.forEach(function(e){e.frameContext.viewModel.form.updateFormErrors(e.message,!0,"backend")}):this.resetFormMessage(e.context.appContext,e.context.ns);var c=this.findTargetFrameContext(this.frameContext);s&&s.all&&0<s.all.length?c.viewModel.verifycationChanged.next(s.all):null!==s&&c.viewModel.verifycationChanged.next([])},fo.prototype.collect=function(e,t,r,i,n,o){var a,s,g=this;void 0===t&&(t=!1),void 0===r&&(r=!1),void 0===i&&(i=null),void 0===n&&(n=null),void 0===o&&(o=null);var c=e&&e.bizMessages||null,p=e&&e.context.appContext,m=e.context.ns;if(!c||c.length<1)return null;var S={form:[],all:[]},C=!1,u=function(e){var t,r,h=e.message,i=e.location||null,a=i&&i.columns||null,n=i&&i.nodeCode||null,o=i&&i.rows,v=b.getBindingPath(p,m,n),y=v&&v.split("/").filter(function(e){return e});if(!i||!a||a.length<1||!n||!o||o.length<1)return"continue";var s=function(f){var e,t,r=function(d){var e=b.getFrameContextsByBindingPathAndColumnName(p,m,v,d);if(!e||e.length<1)return C=!0,"continue";e=e.filter(function(e){return!g.isDataGridComponent(e.frameComponent)||!g.isReadonlyDataGrid(e.frameComponent)}),b.isCurrentRow(p,m,v,f)&&e&&0<e.length&&e.forEach(function(i){var e=g.getFormControlByColumnName(i,d);e&&0<e.length&&e.forEach(function(e){var t=re(e,2),r=t[0];t[1],g.mergeMessage(S.form,i,r,h)})}),e.forEach(function(e){var t=e.viewModel.form.formGroupName,r=g.getFormControlByColumnName(e,d);if(r&&0<r.length){var i=re(r.find(function(e){var t=re(e,2),r=t[0];return t[1],r&&0<r.length}),2),n=i[0],o=i[1],a=e.viewModel.bindingData.getValue(y),s=a.getIndexById(f),c=f+"_"+d+"_"+h;if(0<=s&&-1===S.all.findIndex(function(e){return e.id===c})){var u=a&&1<a.length?s+1:-1,l=g.buildItemTitle(t,o.name||o.defaultI18nValue||n,u),p={id:c,index:s,targetField:o.id,title:l,msg:h,namespace:m,bindingPath:v,type:"error"};S.all.push(p)}}})};try{for(var i=te(a),n=i.next();!n.done;n=i.next())r(n.value)}catch(o){e={error:o}}finally{try{n&&!n.done&&(t=i["return"])&&t.call(i)}finally{if(e)throw e.error}}};try{for(var c=te(o),u=c.next();!u.done;u=c.next())s(u.value)}catch(l){t={error:l}}finally{try{u&&!u.done&&(r=c["return"])&&r.call(c)}finally{if(t)throw t.error}}},b=this;try{for(var l=te(c),d=l.next();!d.done;d=l.next())u(d.value)}catch(f){a={error:f}}finally{try{d&&!d.done&&(s=l["return"])&&s.call(l)}finally{if(a)throw a.error}}return C&&t&&!r&&i&&i.post("Exception","","onException",n,o),S},fo.prototype.mergeMessage=function(e,t,r,i){var n,o,a=e.find(function(e){return e.frameContext.frameId===t.frameId});if(a){var s=a.message&&Object.keys(a.message).includes(r),c="backend-message-"+(Object.keys(a.message).length+1);s?a.message[r].errors[c]={name:i}:a.message[r]={errors:(n={},n[c]={name:i},n)}}else e.push({frameContext:t,message:(o={},o[r]={errors:{"backend-message-1":{name:i}}},o)})},fo.prototype.buildItemTitle=function(e,t,r){var i={"zh-CHS":{viewModelName:"$viewModel",index:"第 $index 行",propertyName:"- $propertyName"},en:{viewModelName:"$viewModel",index:"row $index",propertyName:"- $propertyName"},"zh-CHT":{viewModelName:"$viewModel",index:"第 $index 行",propertyName:"- $propertyName"}},n=this.translate.getCurrentLanguage()||"zh-CHS",o=[];return e&&o.push(i[n].viewModelName.replace("$viewModel",e)),0<r&&o.push(i[n].index.replace("$index",r)),t&&o.push(i[n].propertyName.replace("$propertyName",t)),o.join(" ")},fo.prototype.getBindingPath=function(e,t,r){return this.getFrameContext(e,t).repository.entityTypeInfo.getBindingPathByTableName(r)},fo.prototype.getFrameContextsByBindingPathAndColumnName=function(e,o,a,s){var t=e.frameContextManager.getFrameContexts();return t&&0<t.length?t=t.filter(function(e){if(!(e.namespace===o&&e.viewModel.bindingPath===a&&e.viewModel.form&&e.viewModel.form.controls&&0<Object.keys(e.viewModel.form.controls).length))return!1;var t=a.split("/").filter(function(e){return e}),r=e.repository.entityTypeInfo.getTypeInfoByPath(t);if(r){var i=Array.from(r.propInfoMap.values()).find(function(e){return e.metadataInfo&&(e.metadataInfo.originalDataField===s||e.metadataInfo.dataField===s)});if(i){var n=i.name;return!!Object.values(e.viewModel.form.ngFormControls).find(function(e){return e.binding===n})||!!Object.keys(e.viewModel.form.ngFormControls).find(function(e){return e===n})}return!1}return!1}):null},fo.prototype.isDataGridComponent=function(e){return!!e.context.viewModel.dataGridColumnsName},fo.prototype.isReadonlyDataGrid=function(e){var t=e.context,r=t.viewModel.dataGridColumnsName||null;if(r)return t.viewModel[r].every(function(e){return e.every(function(e){return!e.editor})});throw new Error("传入的组件不是一个表格！")},fo.prototype.isCurrentRow=function(e,t,r,i){var n=r.split("/").filter(function(e){return e});return this.getFrameContext(e,t).bindingData.getValue(n).currentItem.primaryKeyValue===i},fo.prototype.getFrameContext=function(e,t){var r=e.frameContextManager.getFrameContexts();if(r&&0<r.length){var i=r.find(function(e){return e.namespace===t});if(i)return i.getVirtualRootFrameContext()}return null},fo.prototype.getFormControlByColumnName=function(e,t){var r=e.viewModel.bindingPath.split("/").filter(function(e){return e}),i=e.repository.entityTypeInfo.getTypeInfoByPath(r),n=Array.from(i.propInfoMap.values()).find(function(e){return e.metadataInfo&&(e.metadataInfo.originalDataField===t||e.metadataInfo.dataField===t)});if(n){var o=n.name,a=Object.entries(e.viewModel.form.ngFormControls).filter(function(e){return e[1].binding===o||e[0]===o});if(a)return a}return null},fo.prototype.resetFormMessage=function(e,t){e.frameContextManager.getFrameContexts().filter(function(e){return e.namespace===t}).forEach(function(e){return e&&e.viewModel&&e.viewModel.form&&e.viewModel.form.clearBackendError()})},fo.prototype.findTargetFrameContext=function(e){var t=e.getVirtualRootFrameContext(),r=t.frameComponent;if(r&&r.isDialogRootComponent)return t;var i=t.parent;return i?this.findTargetFrameContext(i):t},fo.decorators=[{type:k.Injectable}],fo.ctorParameters=function(){return[{type:k.Injector},{type:V.FrameContext},{type:undefined,decorators:[{type:k.Inject,args:[V.TranslateToken]}]}]},fo);function fo(e,t,r){this.injector=e,this.frameContext=t,this.translate=r}e.ɵa=mr,e.ɵc=Pn,e.ɵb=yn,e.ɵd=ur,e.FormLoadingService=W,e.FormMessageService=Fe,e.HideEventService=q,e.FormNotifyService=Te,e.FormErrorService=Pe,e.FormWizardService=Oe,e.CheckService=Ae,e.DataCheckService=Be,e.EventService=ke,e.MenuStateService=_e,e.RouterService=Ue,e.LanguageService=$,e.TAB_EVENT=He,e.TAB_QUERY_STRING={TabId:"tabId",AppType:"appType",AppId:"appId",AppEntrance:"appEntrance",FuncId:"funcId"},e.QuerystringService=Je,e.RuntimeFrameworkService=Ge,e.NavigationEventService=Qe,e.NavigationService=it,e.NavigationMiddlewareService=bt,e.GridMiddlewareService=wt,e.ParamService=Et,e.FilterConditionService=Mt,e.FilterConditionDataService=jr,e.UIStateService=Rt,e.StateMachineService=Nt,e.BindingDataService=jt,e.CommandService=pt,e.ValidationService=vt,e.FocusInvalidService=tr,e.ApplicationParamService=Lt,e.ChangeItemService=sr,e.EntityTraversingService=Vt,e.EntityManipulationService=qt,e.EntityAggregationService=Wt,e.EntityListService=Kt,e.EntityService=Jt,e.ListDataService=hr,e.CardDataService=St,e.SubListDataService=yr,e.TreeDataService=Nr,e.RemoveDataService=Vr,e.SaveDataService=qr,e.EditDataService=Lr,e.RemoteSummaryService=Cn,e.SubTreeDataService=Hr,e.BeActionService=zr,e.ApproveService=Yr,e.PrintService=$r,e.AttachmentDataService=ti,e.AttachmentService=ii,e.FileService=oi,e.DialogService=si,e.SidebarService=ui,e.FilterService=pi,e.AuthorityService=vi,e.Authority=gi,e.FarrisFormService=et,e.FARRIS_FORM_COMPONENTS=Ze,e.ExceptionHandler=Si,e.KeybindingService=Dt,e.FARRIS_COMMAND_SERVICE_PROVIDERS=bi,e.FARRIS_COMMAND_SERVICE_MODULE_PROVIDERS=Bi,e.FARRIS_COMMAND_SERVICE_FRAME_PROVIDERS=io,e.DYNAMIC_FARRIS_COMMAND_SERVICE_PROVIDERS=no,e.CommandServicesModule=oo,e.ComponentManagerService=fi,e.MessagePipeService=uo,e.MessagePipe=so,e.EndEditService=mn,e.BatchEditService=In,e.DiscussionGroupService=xn,e.FormManifestService=Fn,e.FormExpressionManifestService=Tn,e.UserSettingsService=Ii,e.LocalizationService=On,e.DataGridService=dr,e.BackEndMessageHandler=po,e.FormAttentionService=An,e.FormNotifyStrategyService=ut,e.FeatureDataService=qn,e.FeatureEditService=Wn,e.FeatureRepository=Vn,e.ExpressionService=Kn,e.PopUpService=Gn,e.DirtyCheckingService=Jn,e.WorkFlowMessage=Pi,e.WorkFlowMessageService=xi,e.WorkFlowMessageHandler=Fi,e.FormControlService=Qt,e.BindingPathService=Gt,e.FrameContextService=Zt,e.ViewModelService=Zn,e.FormService=Qn,e.PaginationService=to,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=farris-command-services.umd.min.js.map