import { Inject, Injectable, Injector } from '@angular/core';
import { FrameContext, TranslateToken } from '@farris/devkit';
/**
 * 后端消息处理服务
 * @description
 * ### 服务注入位置
 *  1、整个表单的root-component
 *  2、弹出窗口的root-component
 */
export class BackEndMessageHandler {
    constructor(injector, frameContext, translate) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.translate = translate;
    }
    /**
     * 处理后端返回的消息或错误
     * @param message 消息或错误
     */
    handle(message, context) {
        const isException = context && context.isException || false;
        const hasThrowError = context && context.hasThrowError || false;
        const eventBus = context && context.eventBus || null;
        const error = context && context.error || null;
        const formAppContext = context && context.formAppContext || null;
        const result = this.collect(message, isException, hasThrowError, eventBus, error, formAppContext);
        if (result && result.form && result.form.length > 0) {
            result.form.forEach((item) => {
                item.frameContext.viewModel.form.updateFormErrors(item.message, true, 'backend');
            });
        }
        else {
            this.resetFormMessage(message.context.appContext, message.context.ns);
        }
        const targetFrameContext = this.findTargetFrameContext(this.frameContext);
        if (result && result.all && result.all.length > 0) {
            targetFrameContext.viewModel.verifycationChanged.next(result.all);
        }
        else {
            if (result !== null) {
                targetFrameContext.viewModel.verifycationChanged.next([]);
            }
        }
    }
    /**
     * 收集汇总信息和form信息
     * @param backEndMessage
     */
    collect(backEndMessage, isException = false, hasThrowError = false, eventBus = null, error = null, formAppContext = null) {
        const bizMessages = backEndMessage && backEndMessage.bizMessages || null;
        const appContext = backEndMessage && backEndMessage.context.appContext;
        const ns = backEndMessage.context.ns;
        if (!bizMessages || bizMessages.length < 1) {
            return null;
        }
        const result = {
            form: [],
            all: []
        };
        let hasFormlessError = false;
        for (let bizMessage of bizMessages) {
            const message = bizMessage.message;
            const location = bizMessage.location || null;
            const columns = location && location.columns || null;
            const nodeCode = location && location.nodeCode || null;
            const rows = location && location.rows;
            const bindingPath = this.getBindingPath(appContext, ns, nodeCode);
            const bindingPaths = bindingPath && bindingPath.split('/').filter(p => p);
            // 目前仅处理有location，且有id、列名、表名的。
            if (!location || !columns || columns.length < 1 || !nodeCode || !rows || rows.length < 1) {
                continue;
            }
            // 遍历数据行
            for (let row of rows) {
                for (let column of columns) {
                    // 获取到所有绑定该列数据的frameContext
                    let frameContexts = this.getFrameContextsByBindingPathAndColumnName(appContext, ns, bindingPath, column);
                    if (!frameContexts || frameContexts.length < 1) {
                        // 没有任何一个组件绑定该列的数据
                        hasFormlessError = true;
                        continue;
                    }
                    // 排除掉只读datagrid
                    frameContexts = frameContexts.filter((frameContext) => {
                        const isDataGridComponent = this.isDataGridComponent(frameContext.frameComponent);
                        if (isDataGridComponent) {
                            const isReadonlyDataGrid = this.isReadonlyDataGrid(frameContext.frameComponent);
                            if (isReadonlyDataGrid) {
                                return false;
                            }
                            else {
                                return true;
                            }
                        }
                        return true;
                    });
                    // 遍历的行是否为当前行
                    const isCurrentRow = this.isCurrentRow(appContext, ns, bindingPath, row);
                    // 如果是当前行的话需要将错误信息放到form中
                    if (isCurrentRow) {
                        // 忽略grid
                        // const formFrameContexts = frameContexts.filter(frameContext => !this.isGridComponent(frameContext.frameComponent));
                        if (frameContexts && frameContexts.length > 0) {
                            frameContexts.forEach((frameContext) => {
                                // 只处理了一个组件中列只绑定到一个前端控件的场景
                                const formControls = this.getFormControlByColumnName(frameContext, column);
                                if (formControls && formControls.length > 0) {
                                    formControls.forEach(([domPropertyName, formControl]) => {
                                        //const domPropertyName = formControl && formControl. || null;
                                        this.mergeMessage(result.form, frameContext, domPropertyName, message);
                                    });
                                }
                                //if (formControl && domPropertyName) {
                                //}
                            });
                        }
                        else {
                        }
                    }
                    // 将错误信息放到汇总中
                    frameContexts.forEach((frameContext) => {
                        const viewModelName = frameContext.viewModel.form.formGroupName;
                        const formControls = this.getFormControlByColumnName(frameContext, column);
                        if (formControls && formControls.length > 0) {
                            const [domPropertyName, formControl] = formControls.find(([propertyName, formControl]) => propertyName && propertyName.length > 0);
                            // const domPropertyName = domProperty && domProperty.propertyName;
                            const bindingList = frameContext.viewModel.bindingData.getValue(bindingPaths);
                            let index = bindingList.getIndexById(row);
                            const primary = `${row}_${column}_${message}`;
                            // TODO:虽然能纠正汇总消息显示重复的问题，但可能导致点击错误无法定位到对应控件的问题，待后续优化
                            if (index >= 0 && result.all.findIndex(p => p.id === primary) === -1) {
                                // 数据源中有多于1行时显示索引
                                const position = (bindingList && bindingList.length > 1) ? (index + 1) : -1;
                                const title = this.buildItemTitle(viewModelName, formControl.name || formControl.defaultI18nValue || domPropertyName, position);
                                const item = {
                                    id: primary,
                                    index,
                                    targetField: formControl.id,
                                    title,
                                    msg: message,
                                    namespace: ns,
                                    bindingPath,
                                    type: 'error'
                                };
                                result.all.push(item);
                            }
                        }
                    });
                }
            }
        }
        if (hasFormlessError && isException && !hasThrowError && eventBus) {
            eventBus.post('Exception', '', 'onException', error, formAppContext);
        }
        return result;
    }
    mergeMessage(formItems, frameContext, domPropertyName, message) {
        const targetItem = formItems.find(item => item.frameContext.frameId === frameContext.frameId);
        if (targetItem) {
            const isPropertyExist = targetItem.message && Object.keys(targetItem.message).includes(domPropertyName);
            const messageType = `backend-message-${Object.keys(targetItem.message).length + 1}`;
            if (isPropertyExist) {
                targetItem.message[domPropertyName]['errors'][messageType] = { name: message };
            }
            else {
                targetItem.message[domPropertyName] = { errors: { [messageType]: { name: message } } };
            }
        }
        else {
            formItems.push({
                frameContext: frameContext,
                message: {
                    [domPropertyName]: {
                        errors: {
                            'backend-message-1': { name: message }
                        }
                    }
                }
            });
        }
    }
    buildItemTitle(viewModelName, propertyName, index) {
        const template = {
            'zh-CHS': {
                viewModelName: `$viewModel`,
                index: `第 $index 行`,
                propertyName: `- $propertyName`
            },
            'en': {
                viewModelName: `$viewModel`,
                index: `row $index`,
                propertyName: `- $propertyName`
            },
            'zh-CHT': {
                viewModelName: `$viewModel`,
                index: `第 $index 行`,
                propertyName: `- $propertyName`
            }
        };
        const currentLanguage = this.translate.getCurrentLanguage() || 'zh-CHS';
        const message = [];
        if (viewModelName) {
            message.push(template[currentLanguage]['viewModelName'].replace('$viewModel', viewModelName));
        }
        if (index > 0) {
            message.push(template[currentLanguage]['index'].replace('$index', index));
        }
        if (propertyName) {
            message.push(template[currentLanguage]['propertyName'].replace('$propertyName', propertyName));
        }
        return message.join(' ');
    }
    /**
     * 根据表名或nodeCode获取绑定路径
     * @param appContext appContext
     * @param ns ns
     * @param nodeCode 表名
     */
    getBindingPath(appContext, ns, nodeCode) {
        const frameContext = this.getFrameContext(appContext, ns);
        return frameContext.repository.entityTypeInfo.getBindingPathByTableName(nodeCode);
    }
    /**
     * 通过绑定路径和列名找到所有符合条件的视图模型(包括grid和form)
     * @param appContext appContext
     * @param ns namespace
     * @param bindingPath 绑定路径
     * @param columnName 列名
     */
    getFrameContextsByBindingPathAndColumnName(appContext, ns, bindingPath, columnName) {
        let frameContexts = appContext.frameContextManager.getFrameContexts();
        if (frameContexts && frameContexts.length > 0) {
            // 找到form中有控件的frameContext
            frameContexts = frameContexts.filter((frameContext) => {
                // 基本条件是否满足
                let isValidFrameContext = frameContext.namespace === ns && frameContext.viewModel.bindingPath === bindingPath && frameContext.viewModel.form && frameContext.viewModel.form.controls && Object.keys(frameContext.viewModel.form.controls).length > 0;
                if (!isValidFrameContext) {
                    return false;
                }
                // 再通过列名过滤
                const bindingPaths = bindingPath.split('/').filter(p => p);
                const dataTypeInfo = frameContext.repository.entityTypeInfo.getTypeInfoByPath(bindingPaths);
                if (dataTypeInfo) {
                    const dataPropInfos = Array.from(dataTypeInfo.propInfoMap.values());
                    // 从当前实体属性中找到数据字段为列名的属性
                    const entityPropertyInfo = dataPropInfos.find((propInfo) => propInfo.metadataInfo && (propInfo.metadataInfo.originalDataField === columnName || propInfo.metadataInfo.dataField === columnName));
                    if (entityPropertyInfo) {
                        const entityPropertyName = entityPropertyInfo.name;
                        const ngFormControl = Object.values(frameContext.viewModel.form.ngFormControls).find(item => item.binding === entityPropertyName);
                        if (ngFormControl) {
                            return true;
                        }
                        else {
                            const item = Object.keys(frameContext.viewModel.form.ngFormControls).find(key => key === entityPropertyName);
                            return item ? true : false;
                        }
                    }
                    else {
                        return false;
                    }
                }
                else {
                    return false;
                }
            });
            return frameContexts;
        }
        return null;
    }
    /**
     * 是否为datagrid组件
     * @param frameComponent component
     */
    isDataGridComponent(frameComponent) {
        const columnNames = frameComponent.context.viewModel['dataGridColumnsName'] || null;
        return columnNames ? true : false;
    }
    /**
     * grid组件是否是只读的
     * @param frameComponent frameComponent
     * @returns
     */
    isReadonlyDataGrid(frameComponent) {
        const frameContext = frameComponent.context;
        const dataGridColumnsName = frameContext.viewModel['dataGridColumnsName'] || null;
        if (dataGridColumnsName) {
            const datagridColumns = frameContext.viewModel[dataGridColumnsName];
            return datagridColumns.every((group) => {
                return group.every(item => !item.editor);
            });
        }
        else {
            throw new Error(`传入的组件不是一个表格！`);
        }
    }
    /**
     * id是否为当前行
     * @param appContext appContext
     * @param ns namespace
     * @param bindingPath bindingPath
     * @param id id
     */
    isCurrentRow(appContext, ns, bindingPath, id) {
        const bindingPaths = bindingPath.split('/').filter(p => p);
        const frameContext = this.getFrameContext(appContext, ns);
        const bindingData = frameContext.bindingData;
        const bindingList = bindingData.getValue(bindingPaths);
        return bindingList.currentItem.primaryKeyValue === id;
    }
    /**
     * 获取当前ns下的rootFrameContext
     * @param appContext appcontext
     * @param ns namespace
     */
    getFrameContext(appContext, ns) {
        const frameContexts = appContext.frameContextManager.getFrameContexts();
        if (frameContexts && frameContexts.length > 0) {
            const randomFrameContext = frameContexts.find(frameContext => frameContext.namespace === ns);
            if (randomFrameContext) {
                const virtualRootFrameContext = randomFrameContext.getVirtualRootFrameContext();
                return virtualRootFrameContext;
            }
        }
        return null;
    }
    /**
     * 通过绑定路径和列名获取绑定到该列的formControl
     */
    getFormControlByColumnName(frameContext, columnName) {
        const bindingPaths = frameContext.viewModel.bindingPath.split('/').filter(p => p);
        // 通过bindingPath找到对应的实体信息
        const typeInfo = frameContext.repository.entityTypeInfo.getTypeInfoByPath(bindingPaths);
        const propsInfo = Array.from(typeInfo.propInfoMap.values());
        const propInfo = propsInfo.find((propInfo) => propInfo.metadataInfo && (propInfo.metadataInfo.originalDataField === columnName || propInfo.metadataInfo.dataField === columnName));
        if (propInfo) {
            const mappingName = propInfo.name;
            const formControls = Object.entries(frameContext.viewModel.form.ngFormControls).filter((item) => item[1].binding === mappingName || item[0] === mappingName);
            // const ngFormControl = Object.values(frameContext.viewModel.form.ngFormControls).find(item => item.binding === mappingName);
            if (formControls) {
                return formControls;
            }
        }
        return null;
    }
    resetFormMessage(appContext, ns) {
        const frameContexts = appContext.frameContextManager.getFrameContexts().filter(frameContext => frameContext.namespace === ns);
        frameContexts.forEach(frameContext => frameContext && frameContext.viewModel && frameContext.viewModel.form && frameContext.viewModel.form.clearBackendError());
    }
    /**
     * 递归找到展示消息的组件上下文
     * @param frameContext frameContext
     */
    findTargetFrameContext(frameContext) {
        const virtualRootFrameContext = frameContext.getVirtualRootFrameContext();
        const virtualRootComponent = virtualRootFrameContext.frameComponent;
        const isDialogComponent = virtualRootComponent && virtualRootComponent['isDialogRootComponent'] || false;
        if (isDialogComponent) {
            // 如果消息处理服务是弹窗内的，则消息提示展示在弹窗内
            return virtualRootFrameContext;
        }
        else {
            // 当前消息服务不在弹窗内，递归向上查找，找到第一个弹窗，如果找不到则找到最上的root-component
            const parentFrameContext = virtualRootFrameContext.parent;
            if (parentFrameContext) {
                return this.findTargetFrameContext(parentFrameContext);
            }
            else {
                return virtualRootFrameContext;
            }
        }
    }
}
BackEndMessageHandler.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BackEndMessageHandler.ctorParameters = () => [
    { type: Injector },
    { type: FrameContext },
    { type: undefined, decorators: [{ type: Inject, args: [TranslateToken,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja19lbmRfbWVzc2FnZV9oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2JhY2tfZW5kX21lc3NhZ2VfaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0QsT0FBTyxFQUFtRixZQUFZLEVBQTRCLGNBQWMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pLOzs7Ozs7R0FNRztBQUVILE1BQU0sT0FBTyxxQkFBcUI7SUFDaEMsWUFBb0IsUUFBa0IsRUFBVSxZQUEwQixFQUFrQyxTQUFvQjtRQUE1RyxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsaUJBQVksR0FBWixZQUFZLENBQWM7UUFBa0MsY0FBUyxHQUFULFNBQVMsQ0FBVztJQUFJLENBQUM7SUFDckk7OztPQUdHO0lBQ0ksTUFBTSxDQUFDLE9BQWdDLEVBQUUsT0FBWTtRQUMxRCxNQUFNLFdBQVcsR0FBRyxPQUFPLElBQUksT0FBTyxDQUFDLFdBQVcsSUFBSSxLQUFLLENBQUM7UUFDNUQsTUFBTSxhQUFhLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxhQUFhLElBQUksS0FBSyxDQUFDO1FBQ2hFLE1BQU0sUUFBUSxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQztRQUNyRCxNQUFNLEtBQUssR0FBRyxPQUFPLElBQUksT0FBTyxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUM7UUFDL0MsTUFBTSxjQUFjLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxjQUFjLElBQUksSUFBSSxDQUFDO1FBQ2pFLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxjQUFjLENBQUMsQ0FB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LGFBQWEsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxZQUFZLElBQUksWUFBWSxDQUFDLFNBQVMsSUFBSSxZQUFZLENBQUMsU0FBUyxDQUFDLElBQUksSUFBSSxZQUFZLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLENBQUM7SUFDbEssQ0FBQztJQUNEOzs7T0FHRztJQUNLLHNCQUFzQixDQUFDLFlBQTBCO1FBQ3ZELE1BQU0sdUJBQXVCLEdBQUcsWUFBWSxDQUFDLDBCQUEwQixFQUFFLENBQUM7UUFDMUUsTUFBTSxvQkFBb0IsR0FBRyx1QkFBdUIsQ0FBQyxjQUFjLENBQUM7UUFDcEUsTUFBTSxpQkFBaUIsR0FBRyxvQkFBb0IsSUFBSSxvQkFBb0IsQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLEtBQUssQ0FBQztRQUN6RyxJQUFJLGlCQUFpQixFQUFFO1lBQ3JCLDRCQUE0QjtZQUM1QixPQUFPLHVCQUF1QixDQUFDO1NBQ2hDO2FBQU07WUFDTCx1REFBdUQ7WUFDdkQsTUFBTSxrQkFBa0IsR0FBRyx1QkFBdUIsQ0FBQyxNQUFNLENBQUM7WUFDMUQsSUFBSSxrQkFBa0IsRUFBRTtnQkFDdEIsT0FBTyxJQUFJLENBQUMsc0JBQXNCLENBQUMsa0JBQWtCLENBQUMsQ0FBQzthQUN4RDtpQkFBTTtnQkFDTCxPQUFPLHVCQUF1QixDQUFDO2FBQ2hDO1NBQ0Y7SUFDSCxDQUFDOzs7WUEvVkYsVUFBVTs7OztZQVRrQixRQUFRO1lBQ3FELFlBQVk7NENBVXZCLE1BQU0sU0FBQyxjQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBBcHBDb250ZXh0LCBCYWNrRW5kTWVzc2FnZSwgQmluZGluZ0xpc3QsIERhdGFQcm9wSW5mbywgRXZlbnRCdXMsIEZyYW1lQ29tcG9uZW50LCBGcmFtZUNvbnRleHQsIE5nRm9ybUNvbnRyb2wsIFRyYW5zbGF0ZSwgVHJhbnNsYXRlVG9rZW4gfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbi8qKlxyXG4gKiDlkI7nq6/mtojmga/lpITnkIbmnI3liqFcclxuICogQGRlc2NyaXB0aW9uXHJcbiAqICMjIyDmnI3liqHms6jlhaXkvY3nva5cclxuICogIDHjgIHmlbTkuKrooajljZXnmoRyb290LWNvbXBvbmVudCBcclxuICogIDLjgIHlvLnlh7rnqpflj6PnmoRyb290LWNvbXBvbmVudCBcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEJhY2tFbmRNZXNzYWdlSGFuZGxlciBpbXBsZW1lbnRzIEJhY2tFbmRNZXNzYWdlLklCYWNrRW5kTWVzc2FnZUhhbmRsZXIge1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBASW5qZWN0KFRyYW5zbGF0ZVRva2VuKSBwcml2YXRlIHRyYW5zbGF0ZTogVHJhbnNsYXRlKSB7IH1cclxuICAvKipcclxuICAgKiDlpITnkIblkI7nq6/ov5Tlm57nmoTmtojmga/miJbplJnor69cclxuICAgKiBAcGFyYW0gbWVzc2FnZSDmtojmga/miJbplJnor69cclxuICAgKi9cclxuICBwdWJsaWMgaGFuZGxlKG1lc3NhZ2U6IEJhY2tFbmRNZXNzYWdlLklNZXNzYWdlLCBjb250ZXh0OiBhbnkpIHtcclxuICAgIGNvbnN0IGlzRXhjZXB0aW9uID0gY29udGV4dCAmJiBjb250ZXh0LmlzRXhjZXB0aW9uIHx8IGZhbHNlO1xyXG4gICAgY29uc3QgaGFzVGhyb3dFcnJvciA9IGNvbnRleHQgJiYgY29udGV4dC5oYXNUaHJvd0Vycm9yIHx8IGZhbHNlO1xyXG4gICAgY29uc3QgZXZlbnRCdXMgPSBjb250ZXh0ICYmIGNvbnRleHQuZXZlbnRCdXMgfHwgbnVsbDtcclxuICAgIGNvbnN0IGVycm9yID0gY29udGV4dCAmJiBjb250ZXh0LmVycm9yIHx8IG51bGw7XHJcbiAgICBjb25zdCBmb3JtQXBwQ29udGV4dCA9IGNvbnRleHQgJiYgY29udGV4dC5mb3JtQXBwQ29udGV4dCB8fCBudWxsO1xyXG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5jb2xsZWN0KG1lc3NhZ2UsIGlzRXhjZXB0aW9uLCBoYXNUaHJvd0Vycm9yLCBldmVudEJ1cywgZXJyb3IsIGZvcm1BcHBDb250ZXh0KTtcclxuICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LmZvcm0gJiYgcmVzdWx0LmZvcm0ubGVuZ3RoID4gMCkge1xyXG4gICAgICByZXN1bHQuZm9ybS5mb3JFYWNoKChpdGVtOiB7IGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBtZXNzYWdlOiBhbnkgfSkgPT4ge1xyXG4gICAgICAgIGl0ZW0uZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5mb3JtLnVwZGF0ZUZvcm1FcnJvcnMoaXRlbS5tZXNzYWdlLCB0cnVlLCAnYmFja2VuZCcpO1xyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMucmVzZXRGb3JtTWVzc2FnZShtZXNzYWdlLmNvbnRleHQuYXBwQ29udGV4dCwgbWVzc2FnZS5jb250ZXh0Lm5zKTtcclxuICAgIH1cclxuICAgIGNvbnN0IHRhcmdldEZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0ID0gdGhpcy5maW5kVGFyZ2V0RnJhbWVDb250ZXh0KHRoaXMuZnJhbWVDb250ZXh0KTtcclxuICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LmFsbCAmJiByZXN1bHQuYWxsLmxlbmd0aCA+IDApIHtcclxuICAgICAgdGFyZ2V0RnJhbWVDb250ZXh0LnZpZXdNb2RlbC52ZXJpZnljYXRpb25DaGFuZ2VkLm5leHQocmVzdWx0LmFsbCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAocmVzdWx0ICE9PSBudWxsKSB7XHJcbiAgICAgICAgdGFyZ2V0RnJhbWVDb250ZXh0LnZpZXdNb2RlbC52ZXJpZnljYXRpb25DaGFuZ2VkLm5leHQoW10pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaUtumbhuaxh+aAu+S/oeaBr+WSjGZvcm3kv6Hmga9cclxuICAgKiBAcGFyYW0gYmFja0VuZE1lc3NhZ2UgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjb2xsZWN0KGJhY2tFbmRNZXNzYWdlOiBCYWNrRW5kTWVzc2FnZS5JTWVzc2FnZSwgaXNFeGNlcHRpb246IGJvb2xlYW4gPSBmYWxzZSwgaGFzVGhyb3dFcnJvcjogYm9vbGVhbiA9IGZhbHNlLCBldmVudEJ1czogRXZlbnRCdXMgPSBudWxsLCBlcnJvcjogYW55ID0gbnVsbCwgZm9ybUFwcENvbnRleHQ6IEFwcENvbnRleHQgPSBudWxsKTogeyBmb3JtOiB7IGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBtZXNzYWdlOiBhbnkgfVtdLCBhbGw6IGFueVtdIH0ge1xyXG4gICAgY29uc3QgYml6TWVzc2FnZXMgPSBiYWNrRW5kTWVzc2FnZSAmJiBiYWNrRW5kTWVzc2FnZS5iaXpNZXNzYWdlcyB8fCBudWxsO1xyXG4gICAgY29uc3QgYXBwQ29udGV4dCA9IGJhY2tFbmRNZXNzYWdlICYmIGJhY2tFbmRNZXNzYWdlLmNvbnRleHQuYXBwQ29udGV4dDtcclxuICAgIGNvbnN0IG5zID0gYmFja0VuZE1lc3NhZ2UuY29udGV4dC5ucztcclxuICAgIGlmICghYml6TWVzc2FnZXMgfHwgYml6TWVzc2FnZXMubGVuZ3RoIDwgMSkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IHJlc3VsdCA9IHtcclxuICAgICAgZm9ybTogW10sXHJcbiAgICAgIGFsbDogW11cclxuICAgIH07XHJcbiAgICBsZXQgaGFzRm9ybWxlc3NFcnJvciA9IGZhbHNlO1xyXG4gICAgZm9yIChsZXQgYml6TWVzc2FnZSBvZiBiaXpNZXNzYWdlcykge1xyXG4gICAgICBjb25zdCBtZXNzYWdlID0gYml6TWVzc2FnZS5tZXNzYWdlO1xyXG4gICAgICBjb25zdCBsb2NhdGlvbiA9IGJpek1lc3NhZ2UubG9jYXRpb24gfHwgbnVsbDtcclxuICAgICAgY29uc3QgY29sdW1ucyA9IGxvY2F0aW9uICYmIGxvY2F0aW9uLmNvbHVtbnMgfHwgbnVsbDtcclxuICAgICAgY29uc3Qgbm9kZUNvZGUgPSBsb2NhdGlvbiAmJiBsb2NhdGlvbi5ub2RlQ29kZSB8fCBudWxsO1xyXG4gICAgICBjb25zdCByb3dzID0gbG9jYXRpb24gJiYgbG9jYXRpb24ucm93cztcclxuICAgICAgY29uc3QgYmluZGluZ1BhdGggPSB0aGlzLmdldEJpbmRpbmdQYXRoKGFwcENvbnRleHQsIG5zLCBub2RlQ29kZSk7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoICYmIGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcblxyXG4gICAgICAvLyDnm67liY3ku4XlpITnkIbmnIlsb2NhdGlvbu+8jOS4lOaciWlk44CB5YiX5ZCN44CB6KGo5ZCN55qE44CCXHJcbiAgICAgIGlmICghbG9jYXRpb24gfHwgIWNvbHVtbnMgfHwgY29sdW1ucy5sZW5ndGggPCAxIHx8ICFub2RlQ29kZSB8fCAhcm93cyB8fCByb3dzLmxlbmd0aCA8IDEpIHtcclxuICAgICAgICBjb250aW51ZTtcclxuICAgICAgfVxyXG4gICAgICAvLyDpgY3ljobmlbDmja7ooYxcclxuICAgICAgZm9yIChsZXQgcm93IG9mIHJvd3MpIHtcclxuICAgICAgICBmb3IgKGxldCBjb2x1bW4gb2YgY29sdW1ucykge1xyXG4gICAgICAgICAgLy8g6I635Y+W5Yiw5omA5pyJ57uR5a6a6K+l5YiX5pWw5o2u55qEZnJhbWVDb250ZXh0XHJcbiAgICAgICAgICBsZXQgZnJhbWVDb250ZXh0cyA9IHRoaXMuZ2V0RnJhbWVDb250ZXh0c0J5QmluZGluZ1BhdGhBbmRDb2x1bW5OYW1lKGFwcENvbnRleHQsIG5zLCBiaW5kaW5nUGF0aCwgY29sdW1uKTtcclxuICAgICAgICAgIGlmICghZnJhbWVDb250ZXh0cyB8fCBmcmFtZUNvbnRleHRzLmxlbmd0aCA8IDEpIHtcclxuICAgICAgICAgICAgLy8g5rKh5pyJ5Lu75L2V5LiA5Liq57uE5Lu257uR5a6a6K+l5YiX55qE5pWw5o2uXHJcbiAgICAgICAgICAgIGhhc0Zvcm1sZXNzRXJyb3IgPSB0cnVlO1xyXG4gICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIC8vIOaOkumZpOaOieWPquivu2RhdGFncmlkXHJcbiAgICAgICAgICBmcmFtZUNvbnRleHRzID0gZnJhbWVDb250ZXh0cy5maWx0ZXIoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzRGF0YUdyaWRDb21wb25lbnQgPSB0aGlzLmlzRGF0YUdyaWRDb21wb25lbnQoZnJhbWVDb250ZXh0LmZyYW1lQ29tcG9uZW50KTtcclxuICAgICAgICAgICAgaWYgKGlzRGF0YUdyaWRDb21wb25lbnQpIHtcclxuICAgICAgICAgICAgICBjb25zdCBpc1JlYWRvbmx5RGF0YUdyaWQgPSB0aGlzLmlzUmVhZG9ubHlEYXRhR3JpZChmcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnQpO1xyXG4gICAgICAgICAgICAgIGlmIChpc1JlYWRvbmx5RGF0YUdyaWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICAvLyDpgY3ljobnmoTooYzmmK/lkKbkuLrlvZPliY3ooYxcclxuICAgICAgICAgIGNvbnN0IGlzQ3VycmVudFJvdyA9IHRoaXMuaXNDdXJyZW50Um93KGFwcENvbnRleHQsIG5zLCBiaW5kaW5nUGF0aCwgcm93KTtcclxuICAgICAgICAgIC8vIOWmguaenOaYr+W9k+WJjeihjOeahOivnemcgOimgeWwhumUmeivr+S/oeaBr+aUvuWIsGZvcm3kuK1cclxuICAgICAgICAgIGlmIChpc0N1cnJlbnRSb3cpIHtcclxuICAgICAgICAgICAgLy8g5b+955WlZ3JpZFxyXG4gICAgICAgICAgICAvLyBjb25zdCBmb3JtRnJhbWVDb250ZXh0cyA9IGZyYW1lQ29udGV4dHMuZmlsdGVyKGZyYW1lQ29udGV4dCA9PiAhdGhpcy5pc0dyaWRDb21wb25lbnQoZnJhbWVDb250ZXh0LmZyYW1lQ29tcG9uZW50KSk7XHJcbiAgICAgICAgICAgIGlmIChmcmFtZUNvbnRleHRzICYmIGZyYW1lQ29udGV4dHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgIGZyYW1lQ29udGV4dHMuZm9yRWFjaCgoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIOWPquWkhOeQhuS6huS4gOS4que7hOS7tuS4reWIl+WPque7keWumuWIsOS4gOS4quWJjeerr+aOp+S7tueahOWcuuaZr1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZm9ybUNvbnRyb2xzID0gdGhpcy5nZXRGb3JtQ29udHJvbEJ5Q29sdW1uTmFtZShmcmFtZUNvbnRleHQsIGNvbHVtbik7XHJcbiAgICAgICAgICAgICAgICBpZiAoZm9ybUNvbnRyb2xzICYmIGZvcm1Db250cm9scy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgIGZvcm1Db250cm9scy5mb3JFYWNoKChbZG9tUHJvcGVydHlOYW1lLCBmb3JtQ29udHJvbF0pID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAvL2NvbnN0IGRvbVByb3BlcnR5TmFtZSA9IGZvcm1Db250cm9sICYmIGZvcm1Db250cm9sLiB8fCBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWVyZ2VNZXNzYWdlKHJlc3VsdC5mb3JtLCBmcmFtZUNvbnRleHQsIGRvbVByb3BlcnR5TmFtZSwgbWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vaWYgKGZvcm1Db250cm9sICYmIGRvbVByb3BlcnR5TmFtZSkge1xyXG5cclxuICAgICAgICAgICAgICAgIC8vfVxyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyDlsIbplJnor6/kv6Hmga/mlL7liLDmsYfmgLvkuK1cclxuICAgICAgICAgIGZyYW1lQ29udGV4dHMuZm9yRWFjaCgoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgdmlld01vZGVsTmFtZSA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuZm9ybS5mb3JtR3JvdXBOYW1lO1xyXG4gICAgICAgICAgICBjb25zdCBmb3JtQ29udHJvbHMgPSB0aGlzLmdldEZvcm1Db250cm9sQnlDb2x1bW5OYW1lKGZyYW1lQ29udGV4dCwgY29sdW1uKTtcclxuICAgICAgICAgICAgaWYgKGZvcm1Db250cm9scyAmJiBmb3JtQ29udHJvbHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgIGNvbnN0IFtkb21Qcm9wZXJ0eU5hbWUsIGZvcm1Db250cm9sXSA9IGZvcm1Db250cm9scy5maW5kKChbcHJvcGVydHlOYW1lLCBmb3JtQ29udHJvbF0pID0+IHByb3BlcnR5TmFtZSAmJiBwcm9wZXJ0eU5hbWUubGVuZ3RoID4gMCk7XHJcbiAgICAgICAgICAgICAgLy8gY29uc3QgZG9tUHJvcGVydHlOYW1lID0gZG9tUHJvcGVydHkgJiYgZG9tUHJvcGVydHkucHJvcGVydHlOYW1lO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdMaXN0ID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nRGF0YS5nZXRWYWx1ZShiaW5kaW5nUGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xyXG4gICAgICAgICAgICAgIGxldCBpbmRleCA9IGJpbmRpbmdMaXN0LmdldEluZGV4QnlJZChyb3cpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IHByaW1hcnkgPSBgJHtyb3d9XyR7Y29sdW1ufV8ke21lc3NhZ2V9YDtcclxuICAgICAgICAgICAgICAvLyBUT0RPOuiZveeEtuiDvee6oOato+axh+aAu+a2iOaBr+aYvuekuumHjeWkjeeahOmXrumimO+8jOS9huWPr+iDveWvvOiHtOeCueWHu+mUmeivr+aXoOazleWumuS9jeWIsOWvueW6lOaOp+S7tueahOmXrumimO+8jOW+heWQjue7reS8mOWMllxyXG4gICAgICAgICAgICAgIGlmIChpbmRleCA+PSAwICYmIHJlc3VsdC5hbGwuZmluZEluZGV4KHAgPT4gcC5pZCA9PT0gcHJpbWFyeSkgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAvLyDmlbDmja7mupDkuK3mnInlpJrkuo4x6KGM5pe25pi+56S657Si5byVXHJcbiAgICAgICAgICAgICAgICBjb25zdCBwb3NpdGlvbiA9IChiaW5kaW5nTGlzdCAmJiBiaW5kaW5nTGlzdC5sZW5ndGggPiAxKSA/IChpbmRleCArIDEpIDogLTE7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0aXRsZSA9IHRoaXMuYnVpbGRJdGVtVGl0bGUodmlld01vZGVsTmFtZSwgZm9ybUNvbnRyb2wubmFtZSB8fCBmb3JtQ29udHJvbC5kZWZhdWx0STE4blZhbHVlIHx8IGRvbVByb3BlcnR5TmFtZSwgcG9zaXRpb24pO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaXRlbSA9IHtcclxuICAgICAgICAgICAgICAgICAgaWQ6IHByaW1hcnksXHJcbiAgICAgICAgICAgICAgICAgIGluZGV4LFxyXG4gICAgICAgICAgICAgICAgICB0YXJnZXRGaWVsZDogZm9ybUNvbnRyb2wuaWQsXHJcbiAgICAgICAgICAgICAgICAgIHRpdGxlLFxyXG4gICAgICAgICAgICAgICAgICBtc2c6IG1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZTogbnMsXHJcbiAgICAgICAgICAgICAgICAgIGJpbmRpbmdQYXRoLFxyXG4gICAgICAgICAgICAgICAgICB0eXBlOiAnZXJyb3InXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LmFsbC5wdXNoKGl0ZW0pO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKGhhc0Zvcm1sZXNzRXJyb3IgJiYgaXNFeGNlcHRpb24gJiYgIWhhc1Rocm93RXJyb3IgJiYgZXZlbnRCdXMpIHtcclxuICAgICAgZXZlbnRCdXMucG9zdCgnRXhjZXB0aW9uJywgJycsICdvbkV4Y2VwdGlvbicsIGVycm9yLCBmb3JtQXBwQ29udGV4dCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuICBwcml2YXRlIG1lcmdlTWVzc2FnZShmb3JtSXRlbXM6IHsgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIG1lc3NhZ2U6IHsgW2RvbVByb3BlcnR5TmFtZTogc3RyaW5nXTogeyBlcnJvcnM6IHsgW21lc3NhZ2VUeXBlOiBzdHJpbmddOiB7IG5hbWU6IHN0cmluZyB9IH0gfSB9IH1bXSwgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIGRvbVByb3BlcnR5TmFtZTogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHRhcmdldEl0ZW0gPSBmb3JtSXRlbXMuZmluZChpdGVtID0+IGl0ZW0uZnJhbWVDb250ZXh0LmZyYW1lSWQgPT09IGZyYW1lQ29udGV4dC5mcmFtZUlkKTtcclxuICAgIGlmICh0YXJnZXRJdGVtKSB7XHJcbiAgICAgIGNvbnN0IGlzUHJvcGVydHlFeGlzdCA9IHRhcmdldEl0ZW0ubWVzc2FnZSAmJiBPYmplY3Qua2V5cyh0YXJnZXRJdGVtLm1lc3NhZ2UpLmluY2x1ZGVzKGRvbVByb3BlcnR5TmFtZSk7XHJcbiAgICAgIGNvbnN0IG1lc3NhZ2VUeXBlID0gYGJhY2tlbmQtbWVzc2FnZS0ke09iamVjdC5rZXlzKHRhcmdldEl0ZW0ubWVzc2FnZSkubGVuZ3RoICsgMX1gO1xyXG4gICAgICBpZiAoaXNQcm9wZXJ0eUV4aXN0KSB7XHJcbiAgICAgICAgdGFyZ2V0SXRlbS5tZXNzYWdlW2RvbVByb3BlcnR5TmFtZV1bJ2Vycm9ycyddW21lc3NhZ2VUeXBlXSA9IHsgbmFtZTogbWVzc2FnZSB9O1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRhcmdldEl0ZW0ubWVzc2FnZVtkb21Qcm9wZXJ0eU5hbWVdID0geyBlcnJvcnM6IHsgW21lc3NhZ2VUeXBlXTogeyBuYW1lOiBtZXNzYWdlIH0gfSB9O1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBmb3JtSXRlbXMucHVzaCh7XHJcbiAgICAgICAgZnJhbWVDb250ZXh0OiBmcmFtZUNvbnRleHQsXHJcbiAgICAgICAgbWVzc2FnZToge1xyXG4gICAgICAgICAgW2RvbVByb3BlcnR5TmFtZV06IHtcclxuICAgICAgICAgICAgZXJyb3JzOiB7XHJcbiAgICAgICAgICAgICAgJ2JhY2tlbmQtbWVzc2FnZS0xJzogeyBuYW1lOiBtZXNzYWdlIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgYnVpbGRJdGVtVGl0bGUodmlld01vZGVsTmFtZTogc3RyaW5nLCBwcm9wZXJ0eU5hbWU6IHN0cmluZywgaW5kZXg6IGFueSkge1xyXG4gICAgY29uc3QgdGVtcGxhdGUgPSB7XHJcbiAgICAgICd6aC1DSFMnOiB7XHJcbiAgICAgICAgdmlld01vZGVsTmFtZTogYCR2aWV3TW9kZWxgLFxyXG4gICAgICAgIGluZGV4OiBg56ysICRpbmRleCDooYxgLFxyXG4gICAgICAgIHByb3BlcnR5TmFtZTogYC0gJHByb3BlcnR5TmFtZWBcclxuICAgICAgfSxcclxuICAgICAgJ2VuJzoge1xyXG4gICAgICAgIHZpZXdNb2RlbE5hbWU6IGAkdmlld01vZGVsYCxcclxuICAgICAgICBpbmRleDogYHJvdyAkaW5kZXhgLFxyXG4gICAgICAgIHByb3BlcnR5TmFtZTogYC0gJHByb3BlcnR5TmFtZWBcclxuICAgICAgfSxcclxuICAgICAgJ3poLUNIVCc6IHtcclxuICAgICAgICB2aWV3TW9kZWxOYW1lOiBgJHZpZXdNb2RlbGAsXHJcbiAgICAgICAgaW5kZXg6IGDnrKwgJGluZGV4IOihjGAsXHJcbiAgICAgICAgcHJvcGVydHlOYW1lOiBgLSAkcHJvcGVydHlOYW1lYFxyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gICAgY29uc3QgY3VycmVudExhbmd1YWdlID0gdGhpcy50cmFuc2xhdGUuZ2V0Q3VycmVudExhbmd1YWdlKCkgfHwgJ3poLUNIUyc7XHJcbiAgICBjb25zdCBtZXNzYWdlID0gW107XHJcbiAgICBpZiAodmlld01vZGVsTmFtZSkge1xyXG4gICAgICBtZXNzYWdlLnB1c2godGVtcGxhdGVbY3VycmVudExhbmd1YWdlXVsndmlld01vZGVsTmFtZSddLnJlcGxhY2UoJyR2aWV3TW9kZWwnLCB2aWV3TW9kZWxOYW1lKSk7XHJcbiAgICB9XHJcbiAgICBpZiAoaW5kZXggPiAwKSB7XHJcbiAgICAgIG1lc3NhZ2UucHVzaCh0ZW1wbGF0ZVtjdXJyZW50TGFuZ3VhZ2VdWydpbmRleCddLnJlcGxhY2UoJyRpbmRleCcsIGluZGV4KSk7XHJcbiAgICB9XHJcbiAgICBpZiAocHJvcGVydHlOYW1lKSB7XHJcbiAgICAgIG1lc3NhZ2UucHVzaCh0ZW1wbGF0ZVtjdXJyZW50TGFuZ3VhZ2VdWydwcm9wZXJ0eU5hbWUnXS5yZXBsYWNlKCckcHJvcGVydHlOYW1lJywgcHJvcGVydHlOYW1lKSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbWVzc2FnZS5qb2luKCcgJyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOagueaNruihqOWQjeaIlm5vZGVDb2Rl6I635Y+W57uR5a6a6Lev5b6EXHJcbiAgICogQHBhcmFtIGFwcENvbnRleHQgYXBwQ29udGV4dFxyXG4gICAqIEBwYXJhbSBucyBuc1xyXG4gICAqIEBwYXJhbSBub2RlQ29kZSDooajlkI1cclxuICAgKi9cclxuICBwcml2YXRlIGdldEJpbmRpbmdQYXRoKGFwcENvbnRleHQ6IEFwcENvbnRleHQsIG5zOiBzdHJpbmcsIG5vZGVDb2RlOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0RnJhbWVDb250ZXh0KGFwcENvbnRleHQsIG5zKTtcclxuICAgIHJldHVybiBmcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mby5nZXRCaW5kaW5nUGF0aEJ5VGFibGVOYW1lKG5vZGVDb2RlKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6YCa6L+H57uR5a6a6Lev5b6E5ZKM5YiX5ZCN5om+5Yiw5omA5pyJ56ym5ZCI5p2h5Lu255qE6KeG5Zu+5qih5Z6LKOWMheaLrGdyaWTlkoxmb3JtKVxyXG4gICAqIEBwYXJhbSBhcHBDb250ZXh0IGFwcENvbnRleHRcclxuICAgKiBAcGFyYW0gbnMgbmFtZXNwYWNlXHJcbiAgICogQHBhcmFtIGJpbmRpbmdQYXRoIOe7keWumui3r+W+hFxyXG4gICAqIEBwYXJhbSBjb2x1bW5OYW1lIOWIl+WQjVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RnJhbWVDb250ZXh0c0J5QmluZGluZ1BhdGhBbmRDb2x1bW5OYW1lKGFwcENvbnRleHQ6IEFwcENvbnRleHQsIG5zOiBzdHJpbmcsIGJpbmRpbmdQYXRoOiBzdHJpbmcsIGNvbHVtbk5hbWU6IHN0cmluZyk6IEZyYW1lQ29udGV4dFtdIHtcclxuICAgIGxldCBmcmFtZUNvbnRleHRzID0gYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHMoKTtcclxuICAgIGlmIChmcmFtZUNvbnRleHRzICYmIGZyYW1lQ29udGV4dHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAvLyDmib7liLBmb3Jt5Lit5pyJ5o6n5Lu255qEZnJhbWVDb250ZXh0XHJcbiAgICAgIGZyYW1lQ29udGV4dHMgPSBmcmFtZUNvbnRleHRzLmZpbHRlcigoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgICAvLyDln7rmnKzmnaHku7bmmK/lkKbmu6HotrNcclxuICAgICAgICBsZXQgaXNWYWxpZEZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dC5uYW1lc3BhY2UgPT09IG5zICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09IGJpbmRpbmdQYXRoICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuZm9ybSAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmZvcm0uY29udHJvbHMgJiYgT2JqZWN0LmtleXMoZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5mb3JtLmNvbnRyb2xzKS5sZW5ndGggPiAwO1xyXG4gICAgICAgIGlmICghaXNWYWxpZEZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDlho3pgJrov4fliJflkI3ov4fmu6RcclxuICAgICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgICAgIGNvbnN0IGRhdGFUeXBlSW5mbyA9IGZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvLmdldFR5cGVJbmZvQnlQYXRoKGJpbmRpbmdQYXRocyk7XHJcbiAgICAgICAgaWYgKGRhdGFUeXBlSW5mbykge1xyXG4gICAgICAgICAgY29uc3QgZGF0YVByb3BJbmZvcyA9IEFycmF5LmZyb20oZGF0YVR5cGVJbmZvLnByb3BJbmZvTWFwLnZhbHVlcygpKTtcclxuICAgICAgICAgIC8vIOS7juW9k+WJjeWunuS9k+WxnuaAp+S4reaJvuWIsOaVsOaNruWtl+auteS4uuWIl+WQjeeahOWxnuaAp1xyXG4gICAgICAgICAgY29uc3QgZW50aXR5UHJvcGVydHlJbmZvID0gZGF0YVByb3BJbmZvcy5maW5kKChwcm9wSW5mbzogRGF0YVByb3BJbmZvKSA9PiBwcm9wSW5mby5tZXRhZGF0YUluZm8gJiYgKHByb3BJbmZvLm1ldGFkYXRhSW5mby5vcmlnaW5hbERhdGFGaWVsZCA9PT0gY29sdW1uTmFtZSB8fCBwcm9wSW5mby5tZXRhZGF0YUluZm8uZGF0YUZpZWxkID09PSBjb2x1bW5OYW1lKSk7XHJcbiAgICAgICAgICBpZiAoZW50aXR5UHJvcGVydHlJbmZvKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGVudGl0eVByb3BlcnR5TmFtZSA9IGVudGl0eVByb3BlcnR5SW5mby5uYW1lO1xyXG4gICAgICAgICAgICBjb25zdCBuZ0Zvcm1Db250cm9sID0gT2JqZWN0LnZhbHVlcyhmcmFtZUNvbnRleHQudmlld01vZGVsLmZvcm0ubmdGb3JtQ29udHJvbHMpLmZpbmQoaXRlbSA9PiBpdGVtLmJpbmRpbmcgPT09IGVudGl0eVByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICAgIGlmIChuZ0Zvcm1Db250cm9sKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgY29uc3QgaXRlbSA9IE9iamVjdC5rZXlzKGZyYW1lQ29udGV4dC52aWV3TW9kZWwuZm9ybS5uZ0Zvcm1Db250cm9scykuZmluZChrZXkgPT4ga2V5ID09PSBlbnRpdHlQcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgICAgIHJldHVybiBpdGVtID8gdHJ1ZSA6IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gZnJhbWVDb250ZXh0cztcclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmmK/lkKbkuLpkYXRhZ3JpZOe7hOS7tlxyXG4gICAqIEBwYXJhbSBmcmFtZUNvbXBvbmVudCBjb21wb25lbnRcclxuICAgKi9cclxuICBwcml2YXRlIGlzRGF0YUdyaWRDb21wb25lbnQoZnJhbWVDb21wb25lbnQ6IEZyYW1lQ29tcG9uZW50KSB7XHJcbiAgICBjb25zdCBjb2x1bW5OYW1lcyA9IGZyYW1lQ29tcG9uZW50LmNvbnRleHQudmlld01vZGVsWydkYXRhR3JpZENvbHVtbnNOYW1lJ10gfHwgbnVsbDtcclxuICAgIHJldHVybiBjb2x1bW5OYW1lcyA/IHRydWUgOiBmYWxzZTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICogZ3JpZOe7hOS7tuaYr+WQpuaYr+WPquivu+eahFxyXG4gICAqIEBwYXJhbSBmcmFtZUNvbXBvbmVudCBmcmFtZUNvbXBvbmVudFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNSZWFkb25seURhdGFHcmlkKGZyYW1lQ29tcG9uZW50OiBGcmFtZUNvbXBvbmVudCkge1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gZnJhbWVDb21wb25lbnQuY29udGV4dDtcclxuICAgIGNvbnN0IGRhdGFHcmlkQ29sdW1uc05hbWUgPSBmcmFtZUNvbnRleHQudmlld01vZGVsWydkYXRhR3JpZENvbHVtbnNOYW1lJ10gfHwgbnVsbDtcclxuICAgIGlmIChkYXRhR3JpZENvbHVtbnNOYW1lKSB7XHJcbiAgICAgIGNvbnN0IGRhdGFncmlkQ29sdW1uczogYW55W10gPSBmcmFtZUNvbnRleHQudmlld01vZGVsW2RhdGFHcmlkQ29sdW1uc05hbWVdO1xyXG4gICAgICByZXR1cm4gZGF0YWdyaWRDb2x1bW5zLmV2ZXJ5KChncm91cDogQXJyYXk8YW55PikgPT4ge1xyXG4gICAgICAgIHJldHVybiBncm91cC5ldmVyeShpdGVtID0+ICFpdGVtLmVkaXRvcik7XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGDkvKDlhaXnmoTnu4Tku7bkuI3mmK/kuIDkuKrooajmoLzvvIFgKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICogaWTmmK/lkKbkuLrlvZPliY3ooYxcclxuICAgKiBAcGFyYW0gYXBwQ29udGV4dCBhcHBDb250ZXh0XHJcbiAgICogQHBhcmFtIG5zIG5hbWVzcGFjZVxyXG4gICAqIEBwYXJhbSBiaW5kaW5nUGF0aCBiaW5kaW5nUGF0aFxyXG4gICAqIEBwYXJhbSBpZCBpZFxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNDdXJyZW50Um93KGFwcENvbnRleHQ6IEFwcENvbnRleHQsIG5zOiBzdHJpbmcsIGJpbmRpbmdQYXRoOiBzdHJpbmcsIGlkOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSB0aGlzLmdldEZyYW1lQ29udGV4dChhcHBDb250ZXh0LCBucyk7XHJcbiAgICBjb25zdCBiaW5kaW5nRGF0YSA9IGZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YTtcclxuICAgIGNvbnN0IGJpbmRpbmdMaXN0ID0gYmluZGluZ0RhdGEuZ2V0VmFsdWUoYmluZGluZ1BhdGhzKSBhcyBCaW5kaW5nTGlzdDtcclxuICAgIHJldHVybiBiaW5kaW5nTGlzdC5jdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWUgPT09IGlkO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5blvZPliY1uc+S4i+eahHJvb3RGcmFtZUNvbnRleHRcclxuICAgKiBAcGFyYW0gYXBwQ29udGV4dCBhcHBjb250ZXh0XHJcbiAgICogQHBhcmFtIG5zIG5hbWVzcGFjZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RnJhbWVDb250ZXh0KGFwcENvbnRleHQ6IEFwcENvbnRleHQsIG5zOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dHMgPSBhcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpO1xyXG4gICAgaWYgKGZyYW1lQ29udGV4dHMgJiYgZnJhbWVDb250ZXh0cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGNvbnN0IHJhbmRvbUZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dHMuZmluZChmcmFtZUNvbnRleHQgPT4gZnJhbWVDb250ZXh0Lm5hbWVzcGFjZSA9PT0gbnMpO1xyXG4gICAgICBpZiAocmFuZG9tRnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgY29uc3QgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQgPSByYW5kb21GcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKTtcclxuICAgICAgICByZXR1cm4gdmlydHVhbFJvb3RGcmFtZUNvbnRleHQ7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDpgJrov4fnu5Hlrprot6/lvoTlkozliJflkI3ojrflj5bnu5HlrprliLDor6XliJfnmoRmb3JtQ29udHJvbFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Rm9ybUNvbnRyb2xCeUNvbHVtbk5hbWUoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIGNvbHVtbk5hbWU6IHN0cmluZyk6IEFycmF5PFtzdHJpbmcsIE5nRm9ybUNvbnRyb2xdPiB7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAvLyDpgJrov4diaW5kaW5nUGF0aOaJvuWIsOWvueW6lOeahOWunuS9k+S/oeaBr1xyXG4gICAgY29uc3QgdHlwZUluZm8gPSBmcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mby5nZXRUeXBlSW5mb0J5UGF0aChiaW5kaW5nUGF0aHMpO1xyXG5cclxuICAgIGNvbnN0IHByb3BzSW5mbyA9IEFycmF5LmZyb20odHlwZUluZm8ucHJvcEluZm9NYXAudmFsdWVzKCkpO1xyXG4gICAgY29uc3QgcHJvcEluZm8gPSBwcm9wc0luZm8uZmluZCgocHJvcEluZm86IERhdGFQcm9wSW5mbykgPT4gcHJvcEluZm8ubWV0YWRhdGFJbmZvICYmIChwcm9wSW5mby5tZXRhZGF0YUluZm8ub3JpZ2luYWxEYXRhRmllbGQgPT09IGNvbHVtbk5hbWUgfHwgcHJvcEluZm8ubWV0YWRhdGFJbmZvLmRhdGFGaWVsZCA9PT0gY29sdW1uTmFtZSkpO1xyXG4gICAgaWYgKHByb3BJbmZvKSB7XHJcbiAgICAgIGNvbnN0IG1hcHBpbmdOYW1lID0gcHJvcEluZm8ubmFtZTtcclxuICAgICAgY29uc3QgZm9ybUNvbnRyb2xzOiBBcnJheTxbc3RyaW5nLCBOZ0Zvcm1Db250cm9sXT4gPSBPYmplY3QuZW50cmllcyhmcmFtZUNvbnRleHQudmlld01vZGVsLmZvcm0ubmdGb3JtQ29udHJvbHMpLmZpbHRlcigoaXRlbSkgPT4gaXRlbVsxXS5iaW5kaW5nID09PSBtYXBwaW5nTmFtZSB8fCBpdGVtWzBdID09PSBtYXBwaW5nTmFtZSk7XHJcbiAgICAgIC8vIGNvbnN0IG5nRm9ybUNvbnRyb2wgPSBPYmplY3QudmFsdWVzKGZyYW1lQ29udGV4dC52aWV3TW9kZWwuZm9ybS5uZ0Zvcm1Db250cm9scykuZmluZChpdGVtID0+IGl0ZW0uYmluZGluZyA9PT0gbWFwcGluZ05hbWUpO1xyXG4gICAgICBpZiAoZm9ybUNvbnRyb2xzKSB7XHJcbiAgICAgICAgcmV0dXJuIGZvcm1Db250cm9scztcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG4gIHByaXZhdGUgcmVzZXRGb3JtTWVzc2FnZShhcHBDb250ZXh0OiBBcHBDb250ZXh0LCBuczogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHMoKS5maWx0ZXIoZnJhbWVDb250ZXh0ID0+IGZyYW1lQ29udGV4dC5uYW1lc3BhY2UgPT09IG5zKTtcclxuICAgIGZyYW1lQ29udGV4dHMuZm9yRWFjaChmcmFtZUNvbnRleHQgPT4gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5mb3JtICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuZm9ybS5jbGVhckJhY2tlbmRFcnJvcigpKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6YCS5b2S5om+5Yiw5bGV56S65raI5oGv55qE57uE5Lu25LiK5LiL5paHXHJcbiAgICogQHBhcmFtIGZyYW1lQ29udGV4dCBmcmFtZUNvbnRleHRcclxuICAgKi9cclxuICBwcml2YXRlIGZpbmRUYXJnZXRGcmFtZUNvbnRleHQoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpOiBGcmFtZUNvbnRleHQge1xyXG4gICAgY29uc3QgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKTtcclxuICAgIGNvbnN0IHZpcnR1YWxSb290Q29tcG9uZW50ID0gdmlydHVhbFJvb3RGcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnQ7XHJcbiAgICBjb25zdCBpc0RpYWxvZ0NvbXBvbmVudCA9IHZpcnR1YWxSb290Q29tcG9uZW50ICYmIHZpcnR1YWxSb290Q29tcG9uZW50Wydpc0RpYWxvZ1Jvb3RDb21wb25lbnQnXSB8fCBmYWxzZTtcclxuICAgIGlmIChpc0RpYWxvZ0NvbXBvbmVudCkge1xyXG4gICAgICAvLyDlpoLmnpzmtojmga/lpITnkIbmnI3liqHmmK/lvLnnqpflhoXnmoTvvIzliJnmtojmga/mj5DnpLrlsZXnpLrlnKjlvLnnqpflhoVcclxuICAgICAgcmV0dXJuIHZpcnR1YWxSb290RnJhbWVDb250ZXh0O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8g5b2T5YmN5raI5oGv5pyN5Yqh5LiN5Zyo5by556qX5YaF77yM6YCS5b2S5ZCR5LiK5p+l5om+77yM5om+5Yiw56ys5LiA5Liq5by556qX77yM5aaC5p6c5om+5LiN5Yiw5YiZ5om+5Yiw5pyA5LiK55qEcm9vdC1jb21wb25lbnRcclxuICAgICAgY29uc3QgcGFyZW50RnJhbWVDb250ZXh0ID0gdmlydHVhbFJvb3RGcmFtZUNvbnRleHQucGFyZW50O1xyXG4gICAgICBpZiAocGFyZW50RnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZmluZFRhcmdldEZyYW1lQ29udGV4dChwYXJlbnRGcmFtZUNvbnRleHQpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dDtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxufSJdfQ==