import { Injectable, ElementRef } from '@angular/core';
import { StateMachine } from '@farris/devkit';
// tslint:disable: max-line-length
/**
 * 状态机服务
 * @scope FrameComponent
 */
class StateMachineService {
    constructor(stateMachine) {
        this.stateMachine = stateMachine;
        this._clsDefaultName = 'f-form-state-default';
        this._initLoad = true;
        if (this.stateMachine.initialState.name === 'init') {
            window.setTimeout(() => {
                this.initFormState();
            }, 0);
        }
    }
    transit(action) {
        if (action && typeof this.stateMachine[action] === 'function') {
            this.stateMachine[action]();
            this._currentFrameContext = this['context'] && this['context']['frameContext'];
            if (this._initLoad) {
                this.initFormState();
                this._initLoad = false;
            }
            if (!this._currentFrameContext) {
                return;
            }
            const currentRootFrameContext = this.getCurrentRootFrameContext(this._currentFrameContext);
            if (!!currentRootFrameContext) {
                this.toggleFormState(action, currentRootFrameContext);
            }
        }
    }
    getCurrentRootFrameContext(currentFrameContext) {
        let currentRootFrameContext;
        this.getAllRootFrameContext().forEach((rootFc) => {
            if (currentFrameContext.namespace === rootFc.namespace) {
                currentRootFrameContext = rootFc;
            }
        });
        return currentRootFrameContext;
    }
    getFrameContextManagerMap() {
        if (this.stateMachine && this.stateMachine.frameContext) {
            const appContext = this.stateMachine.frameContext.appContext;
            if (appContext) {
                const frameContextManager = appContext.frameContextManager;
                return frameContextManager.getFrameContextMap();
            }
        }
        return null;
        // return this.stateMachine && this.stateMachine.frameContext && this.stateMachine.frameContext.appContext && this.stateMachine.frameContext.appContext.frameContextManager && this.stateMachine.frameContext.appContext.frameContextManager.getFrameContextMap();
    }
    getAllRootFrameContext() {
        const rootFrameContextArr = [];
        const frameContexts = this.getFrameContextManagerMap();
        if (frameContexts) {
            frameContexts.forEach(item => {
                if ((item['namespace'] === '' && item['parent'] === null) || (item['parent'] !== null && item['namespace'] !== item['parent']['namespace'])) {
                    rootFrameContextArr.push(item);
                }
            });
        }
        return rootFrameContextArr;
    }
    initFormState() {
        if (!this.getFrameContextManagerMap()) {
            return;
        }
        this.getAllRootFrameContext().forEach((rootFc) => {
            const rootComponent = rootFc.injector.get(ElementRef, null) || null;
            if (!rootComponent || !rootComponent.nativeElement) {
                return;
            }
            if (!rootComponent.nativeElement.className.includes(this._clsDefaultName) && !rootComponent.nativeElement.className.includes('f-form-state-create') && !rootComponent.nativeElement.className.includes('f-form-state-edit')) {
                this.addCssClass(rootComponent, this._clsDefaultName);
            }
        });
    }
    toggleFormState(action, frameContext) {
        const rootComponent = frameContext.injector.get(ElementRef, null) || null;
        if (!rootComponent || !rootComponent.nativeElement || !action) {
            return;
        }
        action = action.toLowerCase();
        if (action && ['create', 'edit'].includes(action)) {
            if (action === 'create') {
                this.addCssClass(rootComponent, 'f-form-state-create');
            }
            else if (action === 'edit') {
                this.addCssClass(rootComponent, 'f-form-state-edit');
            }
            this.removeCssClass(rootComponent, this._clsDefaultName);
        }
        else {
            ['f-form-state-create', 'f-form-state-edit'].forEach(item => this.removeCssClass(rootComponent, item));
            this.addCssClass(rootComponent, this._clsDefaultName);
        }
    }
    addCssClass(elementRef, className) {
        if (!elementRef || !className || !elementRef.nativeElement) {
            return;
        }
        const originalClassName = elementRef.nativeElement.className || '';
        if (!originalClassName.includes(className)) {
            elementRef.nativeElement.className = `${originalClassName} ${className}`;
        }
    }
    removeCssClass(elementRef, className) {
        if (!elementRef || !className || !elementRef.nativeElement) {
            return;
        }
        const originalClassName = elementRef.nativeElement.className || '';
        if (originalClassName.includes(className)) {
            elementRef.nativeElement.className = originalClassName.split(' ').filter(p => p && p !== className).join(' ');
        }
    }
    getFormRootComponent() {
        if (this.stateMachine && this.stateMachine.frameContext) {
            const viewContext = this.stateMachine.frameContext;
            if (viewContext) {
                const virtualRootContext = viewContext.getVirtualRootFrameContext();
                if (virtualRootContext) {
                    const injector = virtualRootContext.injector;
                    if (typeof injector.get === 'function') {
                        return injector.get(ElementRef, null);
                    }
                }
            }
        }
        return null;
        // return this.stateMachine && this.stateMachine.frameContext && this.stateMachine.frameContext.getVirtualRootFrameContext() && this.stateMachine.frameContext.getVirtualRootFrameContext().injector && typeof this.stateMachine.frameContext.getVirtualRootFrameContext().injector.get === 'function' && this.stateMachine.frameContext.getVirtualRootFrameContext().injector.get<ElementRef>(ElementRef, null) || null;
    }
}
StateMachineService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
StateMachineService.ctorParameters = () => [
    { type: StateMachine }
];
export { StateMachineService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUtbWFjaGluZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL3N0YXRlLW1hY2hpbmUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RCxPQUFPLEVBQUUsWUFBWSxFQUE0QixNQUFNLGdCQUFnQixDQUFDO0FBQ3hFLGtDQUFrQztBQUNsQzs7O0dBR0c7QUFDSCxNQUNNLG1CQUFtQjtJQUV2QixZQUNVLFlBQTBCO1FBQTFCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBUzVCLG9CQUFlLEdBQUcsc0JBQXNCLENBQUM7UUFDekMsY0FBUyxHQUFHLElBQUksQ0FBQztRQVJ2QixJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLElBQUksS0FBSyxNQUFNLEVBQUU7WUFDbEQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ3JCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUN2QixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDUDtJQUNILENBQUM7SUFNRCxPQUFPLENBQUMsTUFBYztRQUNwQixJQUFJLE1BQU0sSUFBSSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEtBQUssVUFBVSxFQUFFO1lBQzdELElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUM1QixJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUMvRSxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7Z0JBQ2xCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztnQkFDckIsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7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LFFBQVEsQ0FBQyxHQUFHLEtBQUssVUFBVSxFQUFFO3dCQUN0QyxPQUFPLFFBQVEsQ0FBQyxHQUFHLENBQWEsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO3FCQUNuRDtpQkFDRjthQUNGO1NBQ0Y7UUFDRCxPQUFPLElBQUksQ0FBQztRQUNaLHlaQUF5WjtJQUMzWixDQUFDOzs7WUF4SUYsVUFBVTs7OztZQU5GLFlBQVk7O0FBaUpyQixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEVsZW1lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgU3RhdGVNYWNoaW5lLCBGcmFtZUNvbnRleHQsIEFwcENvbnRleHQgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbi8vIHRzbGludDpkaXNhYmxlOiBtYXgtbGluZS1sZW5ndGhcclxuLyoqXHJcbiAqIOeKtuaAgeacuuacjeWKoVxyXG4gKiBAc2NvcGUgRnJhbWVDb21wb25lbnRcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuY2xhc3MgU3RhdGVNYWNoaW5lU2VydmljZSB7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBzdGF0ZU1hY2hpbmU6IFN0YXRlTWFjaGluZVxyXG4gICkge1xyXG4gICAgaWYgKHRoaXMuc3RhdGVNYWNoaW5lLmluaXRpYWxTdGF0ZS5uYW1lID09PSAnaW5pdCcpIHtcclxuICAgICAgd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuaW5pdEZvcm1TdGF0ZSgpO1xyXG4gICAgICB9LCAwKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgX2Nsc0RlZmF1bHROYW1lID0gJ2YtZm9ybS1zdGF0ZS1kZWZhdWx0JztcclxuICBwcml2YXRlIF9pbml0TG9hZCA9IHRydWU7XHJcbiAgcHJpdmF0ZSBfY3VycmVudEZyYW1lQ29udGV4dDogYW55XHJcblxyXG4gIHRyYW5zaXQoYWN0aW9uOiBzdHJpbmcpIHtcclxuICAgIGlmIChhY3Rpb24gJiYgdHlwZW9mIHRoaXMuc3RhdGVNYWNoaW5lW2FjdGlvbl0gPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5zdGF0ZU1hY2hpbmVbYWN0aW9uXSgpO1xyXG4gICAgICB0aGlzLl9jdXJyZW50RnJhbWVDb250ZXh0ID0gdGhpc1snY29udGV4dCddICYmIHRoaXNbJ2NvbnRleHQnXVsnZnJhbWVDb250ZXh0J107XHJcbiAgICAgIGlmICh0aGlzLl9pbml0TG9hZCkge1xyXG4gICAgICAgIHRoaXMuaW5pdEZvcm1TdGF0ZSgpO1xyXG4gICAgICAgIHRoaXMuX2luaXRMb2FkID0gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKCF0aGlzLl9jdXJyZW50RnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IGN1cnJlbnRSb290RnJhbWVDb250ZXh0ID0gdGhpcy5nZXRDdXJyZW50Um9vdEZyYW1lQ29udGV4dCh0aGlzLl9jdXJyZW50RnJhbWVDb250ZXh0KTtcclxuICAgICAgaWYgKCEhY3VycmVudFJvb3RGcmFtZUNvbnRleHQpIHtcclxuICAgICAgICB0aGlzLnRvZ2dsZUZvcm1TdGF0ZShhY3Rpb24sIGN1cnJlbnRSb290RnJhbWVDb250ZXh0KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRDdXJyZW50Um9vdEZyYW1lQ29udGV4dChjdXJyZW50RnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpOiBGcmFtZUNvbnRleHQge1xyXG4gICAgbGV0IGN1cnJlbnRSb290RnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQ7XHJcbiAgICB0aGlzLmdldEFsbFJvb3RGcmFtZUNvbnRleHQoKS5mb3JFYWNoKChyb290RmM6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICBpZiAoY3VycmVudEZyYW1lQ29udGV4dC5uYW1lc3BhY2UgPT09IHJvb3RGYy5uYW1lc3BhY2UpIHtcclxuICAgICAgICBjdXJyZW50Um9vdEZyYW1lQ29udGV4dCA9IHJvb3RGYztcclxuICAgICAgfVxyXG4gICAgfSlcclxuICAgIHJldHVybiBjdXJyZW50Um9vdEZyYW1lQ29udGV4dDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0RnJhbWVDb250ZXh0TWFuYWdlck1hcCgpIHtcclxuICAgIGlmICh0aGlzLnN0YXRlTWFjaGluZSAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQpIHtcclxuICAgICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0IGFzIEFwcENvbnRleHQ7XHJcbiAgICAgIGlmIChhcHBDb250ZXh0KSB7XHJcbiAgICAgICAgY29uc3QgZnJhbWVDb250ZXh0TWFuYWdlciA9IGFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlcjtcclxuICAgICAgICByZXR1cm4gZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRNYXAoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgICAvLyByZXR1cm4gdGhpcy5zdGF0ZU1hY2hpbmUgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0ICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0ICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRNYXAoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0QWxsUm9vdEZyYW1lQ29udGV4dCgpOiBhbnlbXSB7XHJcbiAgICBjb25zdCByb290RnJhbWVDb250ZXh0QXJyID0gW107XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gdGhpcy5nZXRGcmFtZUNvbnRleHRNYW5hZ2VyTWFwKCk7XHJcbiAgICBpZiAoZnJhbWVDb250ZXh0cykge1xyXG4gICAgICBmcmFtZUNvbnRleHRzLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgaWYgKChpdGVtWyduYW1lc3BhY2UnXSA9PT0gJycgJiYgaXRlbVsncGFyZW50J10gPT09IG51bGwpIHx8IChpdGVtWydwYXJlbnQnXSAhPT0gbnVsbCAmJiBpdGVtWyduYW1lc3BhY2UnXSAhPT0gaXRlbVsncGFyZW50J11bJ25hbWVzcGFjZSddKSkge1xyXG4gICAgICAgICAgcm9vdEZyYW1lQ29udGV4dEFyci5wdXNoKGl0ZW0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgIH1cclxuICAgIHJldHVybiByb290RnJhbWVDb250ZXh0QXJyO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpbml0Rm9ybVN0YXRlKCkge1xyXG4gICAgaWYgKCF0aGlzLmdldEZyYW1lQ29udGV4dE1hbmFnZXJNYXAoKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLmdldEFsbFJvb3RGcmFtZUNvbnRleHQoKS5mb3JFYWNoKChyb290RmM6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICBjb25zdCByb290Q29tcG9uZW50ID0gcm9vdEZjLmluamVjdG9yLmdldDxFbGVtZW50UmVmPihFbGVtZW50UmVmLCBudWxsKSB8fCBudWxsO1xyXG4gICAgICBpZiAoIXJvb3RDb21wb25lbnQgfHwgIXJvb3RDb21wb25lbnQubmF0aXZlRWxlbWVudCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBpZiAoIXJvb3RDb21wb25lbnQubmF0aXZlRWxlbWVudC5jbGFzc05hbWUuaW5jbHVkZXModGhpcy5fY2xzRGVmYXVsdE5hbWUpICYmICFyb290Q29tcG9uZW50Lm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lLmluY2x1ZGVzKCdmLWZvcm0tc3RhdGUtY3JlYXRlJykgJiYgIXJvb3RDb21wb25lbnQubmF0aXZlRWxlbWVudC5jbGFzc05hbWUuaW5jbHVkZXMoJ2YtZm9ybS1zdGF0ZS1lZGl0JykpIHtcclxuICAgICAgICB0aGlzLmFkZENzc0NsYXNzKHJvb3RDb21wb25lbnQsIHRoaXMuX2Nsc0RlZmF1bHROYW1lKTtcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdG9nZ2xlRm9ybVN0YXRlKGFjdGlvbjogc3RyaW5nLCBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkge1xyXG4gICAgY29uc3Qgcm9vdENvbXBvbmVudCA9IGZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8RWxlbWVudFJlZj4oRWxlbWVudFJlZiwgbnVsbCkgfHwgbnVsbDtcclxuICAgIGlmICghcm9vdENvbXBvbmVudCB8fCAhcm9vdENvbXBvbmVudC5uYXRpdmVFbGVtZW50IHx8ICFhY3Rpb24pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgYWN0aW9uID0gYWN0aW9uLnRvTG93ZXJDYXNlKCk7XHJcbiAgICBpZiAoYWN0aW9uICYmIFsnY3JlYXRlJywgJ2VkaXQnXS5pbmNsdWRlcyhhY3Rpb24pKSB7XHJcbiAgICAgIGlmIChhY3Rpb24gPT09ICdjcmVhdGUnKSB7XHJcbiAgICAgICAgdGhpcy5hZGRDc3NDbGFzcyhyb290Q29tcG9uZW50LCAnZi1mb3JtLXN0YXRlLWNyZWF0ZScpO1xyXG4gICAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ2VkaXQnKSB7XHJcbiAgICAgICAgdGhpcy5hZGRDc3NDbGFzcyhyb290Q29tcG9uZW50LCAnZi1mb3JtLXN0YXRlLWVkaXQnKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnJlbW92ZUNzc0NsYXNzKHJvb3RDb21wb25lbnQsIHRoaXMuX2Nsc0RlZmF1bHROYW1lKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIFsnZi1mb3JtLXN0YXRlLWNyZWF0ZScsICdmLWZvcm0tc3RhdGUtZWRpdCddLmZvckVhY2goaXRlbSA9PiB0aGlzLnJlbW92ZUNzc0NsYXNzKHJvb3RDb21wb25lbnQsIGl0ZW0pKTtcclxuICAgICAgdGhpcy5hZGRDc3NDbGFzcyhyb290Q29tcG9uZW50LCB0aGlzLl9jbHNEZWZhdWx0TmFtZSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgYWRkQ3NzQ2xhc3MoZWxlbWVudFJlZjogRWxlbWVudFJlZiwgY2xhc3NOYW1lOiBzdHJpbmcpIHtcclxuICAgIGlmICghZWxlbWVudFJlZiB8fCAhY2xhc3NOYW1lIHx8ICFlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgb3JpZ2luYWxDbGFzc05hbWU6IHN0cmluZyA9IGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc05hbWUgfHwgJyc7XHJcbiAgICBpZiAoIW9yaWdpbmFsQ2xhc3NOYW1lLmluY2x1ZGVzKGNsYXNzTmFtZSkpIHtcclxuICAgICAgZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZSA9IGAke29yaWdpbmFsQ2xhc3NOYW1lfSAke2NsYXNzTmFtZX1gO1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIHJlbW92ZUNzc0NsYXNzKGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIGNsYXNzTmFtZTogc3RyaW5nKSB7XHJcbiAgICBpZiAoIWVsZW1lbnRSZWYgfHwgIWNsYXNzTmFtZSB8fCAhZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IG9yaWdpbmFsQ2xhc3NOYW1lOiBzdHJpbmcgPSBlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lIHx8ICcnO1xyXG4gICAgaWYgKG9yaWdpbmFsQ2xhc3NOYW1lLmluY2x1ZGVzKGNsYXNzTmFtZSkpIHtcclxuICAgICAgZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZSA9IG9yaWdpbmFsQ2xhc3NOYW1lLnNwbGl0KCcgJykuZmlsdGVyKHAgPT4gcCAmJiBwICE9PSBjbGFzc05hbWUpLmpvaW4oJyAnKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRGb3JtUm9vdENvbXBvbmVudCgpIHtcclxuICAgIGlmICh0aGlzLnN0YXRlTWFjaGluZSAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQpIHtcclxuICAgICAgY29uc3Qgdmlld0NvbnRleHQgPSB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQ7XHJcbiAgICAgIGlmICh2aWV3Q29udGV4dCkge1xyXG4gICAgICAgIGNvbnN0IHZpcnR1YWxSb290Q29udGV4dCA9IHZpZXdDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XHJcbiAgICAgICAgaWYgKHZpcnR1YWxSb290Q29udGV4dCkge1xyXG4gICAgICAgICAgY29uc3QgaW5qZWN0b3IgPSB2aXJ0dWFsUm9vdENvbnRleHQuaW5qZWN0b3I7XHJcbiAgICAgICAgICBpZiAodHlwZW9mIGluamVjdG9yLmdldCA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICByZXR1cm4gaW5qZWN0b3IuZ2V0PEVsZW1lbnRSZWY+KEVsZW1lbnRSZWYsIG51bGwpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgICAvLyByZXR1cm4gdGhpcy5zdGF0ZU1hY2hpbmUgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0ICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpLmluamVjdG9yICYmIHR5cGVvZiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKS5pbmplY3Rvci5nZXQgPT09ICdmdW5jdGlvbicgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkuaW5qZWN0b3IuZ2V0PEVsZW1lbnRSZWY+KEVsZW1lbnRSZWYsIG51bGwpIHx8IG51bGw7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgeyBTdGF0ZU1hY2hpbmVTZXJ2aWNlIH07XHJcbiJdfQ==