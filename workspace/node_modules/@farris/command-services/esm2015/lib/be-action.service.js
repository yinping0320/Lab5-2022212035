import { Injectable, Optional } from '@angular/core';
import { HttpHeaders } from '@angular/common/http';
import { tap } from 'rxjs/operators';
import { Repository } from '@farris/devkit';
import { FormLoadingService } from './form-loading/form-loading.service';
import { FormMessageService } from './form-message.service';
import { FormNotifyService } from './form-notify.service';
import { FormErrorService } from './error/form-error.service';
import { LanguageService } from './languag.service';
// tslint:disable: no-string-literal
/**
 * 列表仓库服务
 * @scope FrameComponent
 */
class BeActionService {
    /**
     * 构造函数
     */
    constructor(repository, loadingService, msgService, notifyService, formErrorService, languageService) {
        this.repository = repository;
        this.loadingService = loadingService;
        this.msgService = msgService;
        this.notifyService = notifyService;
        this.formErrorService = formErrorService;
        this.languageService = languageService;
        if (!this.languageService) {
            this.languageService = LanguageService.getInstance();
        }
    }
    /**
     * 执行自定义动作
     */
    invokeAction(actionUri, httpMethod, httpHeaders, queryParams, body) {
        return this.innerInvokeAction(actionUri, httpMethod, httpHeaders, queryParams, body, true);
    }
    /**
     * 已弃用：请使用invokeAction代替
     * @deprecated
     * @summary
     * 迁移时请注意：invokeAction中body请传递满足BodyWithRequestInfo接口的格式，形如：
     * { requestInfo: reqeustInfoInstance, key1: value1, key2: value2 }
     */
    executeAction(actionUri, httpMethod, httpHeaders, queryParams, body) {
        // 1、不确定body中是否有RequestInfo对象
        // 2、restService的reqeust会根据body中是否有key为ReqeustInfo（大写开头）的参数来确定；
        // 3、如果body中没有key为ReqeustInfo的参数，不直接返回ResponseInfo，而是进一步解析，返回其中的returnValue。
        return this.innerInvokeAction(actionUri, httpMethod, httpHeaders, queryParams, body, false);
    }
    /**
     * 构造查询字符串
     */
    buildQueryParams(queryParams) {
        if (typeof queryParams === 'string') {
            queryParams = JSON.parse(queryParams);
        }
        let queryParamsString = '';
        Object.keys(queryParams).forEach((key) => {
            queryParamsString += `${key}=${queryParams[key]}`;
        });
        return queryParamsString;
    }
    /**
     * 获取Rest服务
     */
    getRestService() {
        const befRepository = this.repository;
        return befRepository.restService;
    }
    /**
     * 调用自定义动作
     */
    innerInvokeAction(actionUri, httpMethod, httpHeaders, queryParams, body, hasRequestInfo) {
        const options = {};
        const restService = this.getRestService();
        const baseUri = restService.baseUri;
        // 构造url
        let fullActionUri = `${baseUri}/service/${actionUri}`;
        if (queryParams && queryParams !== '') {
            const queryParamsString = this.buildQueryParams(queryParams);
            fullActionUri += queryParamsString;
        }
        // body构造
        if (body && body !== '') {
            if (typeof body === 'string' && body.startsWith('{') && body.endsWith('}')) {
                body = JSON.parse(body);
            }
            options['body'] = body;
        }
        // http头构造
        if (httpHeaders && httpHeaders !== '') {
            httpHeaders = JSON.parse(httpHeaders);
            // 如果没有设置Content-Type，默认用json格式
            if (!httpHeaders['Content-Type']) {
                httpHeaders['Content-Type'] = 'application/json';
            }
            options['headers'] = new HttpHeaders(httpHeaders);
        }
        else {
            options['headers'] = new HttpHeaders({ 'Content-Type': 'application/json' });
        }
        // 执行服务器端请求
        this.loadingService.show();
        // invoke方法
        // 1、RequestInfo=>报错
        // 2、requestInfo=>ResponseInfo
        // request方法
        // 1、RequestInfo=>ResponseInfo
        // 2、requestInfo=>returnValue
        const methodName = hasRequestInfo ? 'invoke' : 'request';
        const result$ = restService[methodName](fullActionUri, httpMethod, null, options);
        return result$.pipe(tap(() => {
            this.loadingService.hide();
        }, (error) => {
            this.loadingService.hide();
            const errorMsg = fullActionUri + this.languageService['operationFailed'];
            this.formErrorService.exception(errorMsg, error);
        }));
    }
}
BeActionService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BeActionService.ctorParameters = () => [
    { type: Repository },
    { type: FormLoadingService },
    { type: FormMessageService },
    { type: FormNotifyService },
    { type: FormErrorService },
    { type: LanguageService, decorators: [{ type: Optional }] }
];
export { BeActionService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmUtYWN0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvYmUtYWN0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLFdBQVcsRUFBcUIsTUFBTSxzQkFBc0IsQ0FBQztBQUV0RSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzVDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzFELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzlELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNwRCxvQ0FBb0M7QUFFcEM7OztHQUdHO0FBQ0gsTUFDTSxlQUFlO0lBRW5COztPQUVHO0lBQ0gsWUFDVSxVQUEyQixFQUMzQixjQUFrQyxFQUNsQyxVQUE4QixFQUM5QixhQUFnQyxFQUNoQyxnQkFBa0MsRUFDdEIsZUFBZ0M7UUFMNUMsZUFBVSxHQUFWLFVBQVUsQ0FBaUI7UUFDM0IsbUJBQWMsR0FBZCxjQUFjLENBQW9CO1FBQ2xDLGVBQVUsR0FBVixVQUFVLENBQW9CO1FBQzlCLGtCQUFhLEdBQWIsYUFBYSxDQUFtQjtRQUNoQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ3RCLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUVwRCxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUN6QixJQUFJ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QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEh0dHBIZWFkZXJzLCBIdHRwRXJyb3JSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnksIEJlZlJlc3RTZXJ2aWNlLCBSZXF1ZXN0SW5mbywgUmVzcG9uc2VJbmZvIH0gZnJvbSAnQGZhcnJpcy9iZWYnO1xyXG5pbXBvcnQgeyBCb2R5V2l0aFJlcXVlc3RJbmZvIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IEZvcm1Mb2FkaW5nU2VydmljZSB9IGZyb20gJy4vZm9ybS1sb2FkaW5nL2Zvcm0tbG9hZGluZy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRm9ybU1lc3NhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLW1lc3NhZ2Uuc2VydmljZSc7XHJcbmltcG9ydCB7IEZvcm1Ob3RpZnlTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLW5vdGlmeS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRm9ybUVycm9yU2VydmljZSB9IGZyb20gJy4vZXJyb3IvZm9ybS1lcnJvci5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9sYW5ndWFnLnNlcnZpY2UnO1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZTogbm8tc3RyaW5nLWxpdGVyYWxcclxuXHJcbi8qKlxyXG4gKiDliJfooajku5PlupPmnI3liqFcclxuICogQHNjb3BlIEZyYW1lQ29tcG9uZW50XHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmNsYXNzIEJlQWN0aW9uU2VydmljZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4sXHJcbiAgICBwcml2YXRlIGxvYWRpbmdTZXJ2aWNlOiBGb3JtTG9hZGluZ1NlcnZpY2UsXHJcbiAgICBwcml2YXRlIG1zZ1NlcnZpY2U6IEZvcm1NZXNzYWdlU2VydmljZSxcclxuICAgIHByaXZhdGUgbm90aWZ5U2VydmljZTogRm9ybU5vdGlmeVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGZvcm1FcnJvclNlcnZpY2U6IEZvcm1FcnJvclNlcnZpY2UsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlLFxyXG4gICkge1xyXG4gICAgaWYgKCF0aGlzLmxhbmd1YWdlU2VydmljZSkge1xyXG4gICAgICB0aGlzLmxhbmd1YWdlU2VydmljZSA9IExhbmd1YWdlU2VydmljZS5nZXRJbnN0YW5jZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5omn6KGM6Ieq5a6a5LmJ5Yqo5L2cXHJcbiAgICovXHJcbiAgcHVibGljIGludm9rZUFjdGlvbihcclxuICAgIGFjdGlvblVyaTogc3RyaW5nLCBodHRwTWV0aG9kOiBzdHJpbmcsIGh0dHBIZWFkZXJzPzogYW55LCBxdWVyeVBhcmFtcz86IGFueSwgYm9keT86IEJvZHlXaXRoUmVxdWVzdEluZm9cclxuICApOiBPYnNlcnZhYmxlPFJlc3BvbnNlSW5mbz4ge1xyXG4gICAgcmV0dXJuIHRoaXMuaW5uZXJJbnZva2VBY3Rpb24oYWN0aW9uVXJpLCBodHRwTWV0aG9kLCBodHRwSGVhZGVycywgcXVlcnlQYXJhbXMsIGJvZHksIHRydWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bey5byD55So77ya6K+35L2/55SoaW52b2tlQWN0aW9u5Luj5pu/XHJcbiAgICogQGRlcHJlY2F0ZWRcclxuICAgKiBAc3VtbWFyeVxyXG4gICAqIOi/geenu+aXtuivt+azqOaEj++8mmludm9rZUFjdGlvbuS4rWJvZHnor7fkvKDpgJLmu6HotrNCb2R5V2l0aFJlcXVlc3RJbmZv5o6l5Y+j55qE5qC85byP77yM5b2i5aaC77yaXHJcbiAgICogeyByZXF1ZXN0SW5mbzogcmVxZXVzdEluZm9JbnN0YW5jZSwga2V5MTogdmFsdWUxLCBrZXkyOiB2YWx1ZTIgfVxyXG4gICAqL1xyXG4gIHB1YmxpYyBleGVjdXRlQWN0aW9uKFxyXG4gICAgYWN0aW9uVXJpOiBzdHJpbmcsIGh0dHBNZXRob2Q6IHN0cmluZywgaHR0cEhlYWRlcnM/OiBhbnksIHF1ZXJ5UGFyYW1zPzogYW55LCBib2R5PzogYW55XHJcbiAgKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuXHJcbiAgICAvLyAx44CB5LiN56Gu5a6aYm9keeS4reaYr+WQpuaciVJlcXVlc3RJbmZv5a+56LGhXHJcbiAgICAvLyAy44CBcmVzdFNlcnZpY2XnmoRyZXFldXN05Lya5qC55o2uYm9keeS4reaYr+WQpuaciWtleeS4ulJlcWV1c3RJbmZv77yI5aSn5YaZ5byA5aS077yJ55qE5Y+C5pWw5p2l56Gu5a6a77ybXHJcbiAgICAvLyAz44CB5aaC5p6cYm9keeS4reayoeaciWtleeS4ulJlcWV1c3RJbmZv55qE5Y+C5pWw77yM5LiN55u05o6l6L+U5ZueUmVzcG9uc2VJbmZv77yM6ICM5piv6L+b5LiA5q2l6Kej5p6Q77yM6L+U5Zue5YW25Lit55qEcmV0dXJuVmFsdWXjgIJcclxuICAgIHJldHVybiB0aGlzLmlubmVySW52b2tlQWN0aW9uKGFjdGlvblVyaSwgaHR0cE1ldGhvZCwgaHR0cEhlYWRlcnMsIHF1ZXJ5UGFyYW1zLCBib2R5LCBmYWxzZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDmn6Xor6LlrZfnrKbkuLJcclxuICAgKi9cclxuICBwdWJsaWMgYnVpbGRRdWVyeVBhcmFtcyhxdWVyeVBhcmFtczogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGlmICh0eXBlb2YgcXVlcnlQYXJhbXMgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgIHF1ZXJ5UGFyYW1zID0gSlNPTi5wYXJzZShxdWVyeVBhcmFtcyk7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHF1ZXJ5UGFyYW1zU3RyaW5nID0gJyc7XHJcbiAgICBPYmplY3Qua2V5cyhxdWVyeVBhcmFtcykuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+IHtcclxuICAgICAgcXVlcnlQYXJhbXNTdHJpbmcgKz0gYCR7a2V5fT0ke3F1ZXJ5UGFyYW1zW2tleV19YDtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBxdWVyeVBhcmFtc1N0cmluZztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPllJlc3TmnI3liqFcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0UmVzdFNlcnZpY2UoKTogQmVmUmVzdFNlcnZpY2Uge1xyXG4gICAgY29uc3QgYmVmUmVwb3NpdG9yeSA9IHRoaXMucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PGFueT47XHJcbiAgICByZXR1cm4gYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZTtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiDosIPnlKjoh6rlrprkuYnliqjkvZxcclxuICAgKi9cclxuICBwcml2YXRlIGlubmVySW52b2tlQWN0aW9uKFxyXG4gICAgYWN0aW9uVXJpOiBzdHJpbmcsIGh0dHBNZXRob2Q6IHN0cmluZywgaHR0cEhlYWRlcnM/OiBhbnksIHF1ZXJ5UGFyYW1zPzogYW55LCBib2R5PzogYW55LCBoYXNSZXF1ZXN0SW5mbz86IGJvb2xlYW5cclxuICApOiBPYnNlcnZhYmxlPGFueT4gIHtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB7fTtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5nZXRSZXN0U2VydmljZSgpO1xyXG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XHJcblxyXG4gICAgLy8g5p6E6YCgdXJsXHJcbiAgICBsZXQgZnVsbEFjdGlvblVyaSA9IGAke2Jhc2VVcml9L3NlcnZpY2UvJHthY3Rpb25Vcml9YDtcclxuICAgIGlmIChxdWVyeVBhcmFtcyAmJiBxdWVyeVBhcmFtcyAhPT0gJycpIHtcclxuICAgICAgY29uc3QgcXVlcnlQYXJhbXNTdHJpbmcgPSB0aGlzLmJ1aWxkUXVlcnlQYXJhbXMocXVlcnlQYXJhbXMpO1xyXG4gICAgICBmdWxsQWN0aW9uVXJpICs9IHF1ZXJ5UGFyYW1zU3RyaW5nO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICAvLyBib2R55p6E6YCgXHJcbiAgICBpZiAoYm9keSAmJiBib2R5ICE9PSAnJykge1xyXG4gICAgICBpZiAodHlwZW9mIGJvZHkgPT09ICdzdHJpbmcnICYmIGJvZHkuc3RhcnRzV2l0aCgneycpICYmIGJvZHkuZW5kc1dpdGgoJ30nKSkge1xyXG4gICAgICAgIGJvZHkgPSBKU09OLnBhcnNlKGJvZHkpO1xyXG4gICAgICB9XHJcbiAgICAgIG9wdGlvbnNbJ2JvZHknXSA9IGJvZHk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gaHR0cOWktOaehOmAoFxyXG4gICAgaWYgKGh0dHBIZWFkZXJzICYmIGh0dHBIZWFkZXJzICE9PSAnJykge1xyXG4gICAgICBodHRwSGVhZGVycyA9IEpTT04ucGFyc2UoaHR0cEhlYWRlcnMpO1xyXG5cclxuICAgICAgLy8g5aaC5p6c5rKh5pyJ6K6+572uQ29udGVudC1UeXBl77yM6buY6K6k55SoanNvbuagvOW8j1xyXG4gICAgICBpZiAoIWh0dHBIZWFkZXJzWydDb250ZW50LVR5cGUnXSkge1xyXG4gICAgICAgIGh0dHBIZWFkZXJzWydDb250ZW50LVR5cGUnXSA9ICdhcHBsaWNhdGlvbi9qc29uJztcclxuICAgICAgfVxyXG4gICAgICBvcHRpb25zWydoZWFkZXJzJ10gPSBuZXcgSHR0cEhlYWRlcnMoaHR0cEhlYWRlcnMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgb3B0aW9uc1snaGVhZGVycyddID0gbmV3IEh0dHBIZWFkZXJzKHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDmiafooYzmnI3liqHlmajnq6/or7fmsYJcclxuICAgIHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xyXG5cclxuICAgIC8vIGludm9rZeaWueazlVxyXG4gICAgLy8gMeOAgVJlcXVlc3RJbmZvPT7miqXplJlcclxuICAgIC8vIDLjgIFyZXF1ZXN0SW5mbz0+UmVzcG9uc2VJbmZvXHJcbiAgICAvLyByZXF1ZXN05pa55rOVXHJcbiAgICAvLyAx44CBUmVxdWVzdEluZm89PlJlc3BvbnNlSW5mb1xyXG4gICAgLy8gMuOAgXJlcXVlc3RJbmZvPT5yZXR1cm5WYWx1ZVxyXG4gICAgY29uc3QgbWV0aG9kTmFtZSA9IGhhc1JlcXVlc3RJbmZvID8gJ2ludm9rZScgOiAncmVxdWVzdCc7XHJcbiAgICBjb25zdCByZXN1bHQkID0gcmVzdFNlcnZpY2VbbWV0aG9kTmFtZV0oZnVsbEFjdGlvblVyaSwgaHR0cE1ldGhvZCwgbnVsbCwgb3B0aW9ucyk7XHJcbiAgICByZXR1cm4gcmVzdWx0JC5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgICAgICBjb25zdCBlcnJvck1zZyA9IGZ1bGxBY3Rpb25VcmkgKyB0aGlzLmxhbmd1YWdlU2VydmljZVsnb3BlcmF0aW9uRmFpbGVkJ107XHJcbiAgICAgICAgICB0aGlzLmZvcm1FcnJvclNlcnZpY2UuZXhjZXB0aW9uKGVycm9yTXNnLCBlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxufVxyXG5cclxuXHJcbmV4cG9ydCB7IEJlQWN0aW9uU2VydmljZSB9O1xyXG5cclxuXHJcbiJdfQ==