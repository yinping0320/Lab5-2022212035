import { Injectable, Optional } from '@angular/core';
import { LoadingService } from '@farris/ui-loading';
import { HideEventService } from './hide-event.service';
import { AppContext } from '@farris/devkit';
// tslint:disable: no-string-literal
/**
 * 加载提示Helper
 * 1、包装@farris/ui的LoadingService；
 * 2、提供针对表单的快捷方法；
 */
class FormLoadingService {
    /**
     * 强制显示，不能隐藏
     */
    /**
     * 构造函数
     * 注入@farris/ui的LoadingService
     */
    constructor(loadingService, hideEventService, applicationContext) {
        this.loadingService = loadingService;
        this.hideEventService = hideEventService;
        this.applicationContext = applicationContext;
        /**
         * 延迟loading定时器
         */
        this.loadingTimerIds = [];
        if (hideEventService) {
            this.hideEventService.hideEvent.subscribe(result => {
                this.hide();
            });
        }
    }
    setSuspend(flag) {
        FormLoadingService.isSuspend = flag;
    }
    /**
     * 显示加载中
     */
    show(configOrMessage) {
        if (FormLoadingService.isSuspend === true) {
            return;
        }
        if (this.loadingCmp) {
            this.loadingCmp.close();
            this.loadingCmp = null;
        }
        this.registerService();
        const loadingConfig = this.buildLoadingConfig(configOrMessage);
        this.loadingCmp = this.loadingService.show(loadingConfig);
        return this.loadingCmp;
    }
    /**
     * 延迟显示Loading
     */
    showLoadingWithDelay(delayTime, configOrMessage) {
        // this.show(configOrMessage);
        const timerId = setTimeout(() => {
            this.show(configOrMessage);
        }, delayTime);
        this.loadingTimerIds.push(timerId);
        this.registerService();
        return timerId;
    }
    /**
     * 隐藏延迟的Loading
     */
    hideDelayLoading(timerIdToClear) {
        this.clearLoadingTimer(timerIdToClear);
        this.hide();
    }
    /**
     * 构造LoadingConfig
     * @param configOrMessage 配置对象或消息字符串
     */
    buildLoadingConfig(configOrMessage) {
        let loadingConfig;
        if (!!configOrMessage) {
            if (typeof configOrMessage === 'object') {
                loadingConfig = configOrMessage;
            }
            else {
                loadingConfig = { 'message': configOrMessage };
            }
        }
        else {
            loadingConfig = {};
        }
        if (!loadingConfig.hasOwnProperty('delay')) {
            loadingConfig.delay = 0;
        }
        return loadingConfig;
    }
    /**
     * 关闭所有loading
     */
    clearAll() {
        FormLoadingService.isSuspend = false;
        window.setTimeout(() => {
            this.loadingService.clearAll();
        }, 350);
        this.loadingCmp = null;
        this.clearAllLoadingTimers();
        this.destroy();
    }
    /**
     * 清空Loading定时器
     */
    clearLoadingTimer(timerIdToClear) {
        clearTimeout(timerIdToClear);
        this.loadingTimerIds = this.loadingTimerIds.filter((timerId) => {
            return timerId !== timerIdToClear;
        });
    }
    /**
     * 清空所有Loading定时器
     */
    clearAllLoadingTimers() {
        this.loadingTimerIds.forEach((timerId) => {
            this.clearLoadingTimer(timerId);
        });
    }
    /**
     * 隐藏加载中
     */
    hide() {
        if (!this.loadingCmp) {
            this.destroy();
            return;
        }
        if (FormLoadingService.isSuspend === true) {
            return;
        }
        this.loadingCmp.close();
        this.loadingCmp = null;
        this.destroy();
    }
    /**
     * 销毁loadingService
     */
    destroy() {
        if (FormLoadingService.isSuspend === true) {
            return;
        }
        const services = window['DEVKIT_LOADING_SERVICE'] || [];
        if (services && Array.isArray(services) && services.length > 0) {
            services.forEach((service) => {
                if (service) {
                    service.clearAllLoadingTimers();
                    if (service.loadingCmp) {
                        service.loadingCmp.close();
                        service.loadingCmp = null;
                    }
                }
            });
        }
        window['DEVKIT_LOADING_SERVICE'] = [];
    }
    /**
     * 注册所有的LoadingService实例
     */
    registerService() {
        const services = window['DEVKIT_LOADING_SERVICE'] || [];
        services.push(this);
        window['DEVKIT_LOADING_SERVICE'] = services;
    }
}
FormLoadingService.isSuspend = false;
FormLoadingService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
FormLoadingService.ctorParameters = () => [
    { type: LoadingService },
    { type: HideEventService, decorators: [{ type: Optional }] },
    { type: AppContext, decorators: [{ type: Optional }] }
];
export { FormLoadingService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1sb2FkaW5nLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZm9ybS1sb2FkaW5nL2Zvcm0tbG9hZGluZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQVksUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxjQUFjLEVBQW1DLE1BQU0sb0JBQW9CLENBQUM7QUFDckYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFVBQVUsRUFBZ0IsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxRCxvQ0FBb0M7QUFDcEM7Ozs7R0FJRztBQUNILE1BQ00sa0JBQWtCO0lBWXRCOztPQUVHO0lBRUg7OztPQUdHO0lBQ0gsWUFDVSxjQUE4QixFQUNsQixnQkFBa0MsRUFDbEMsa0JBQThCO1FBRjFDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUNsQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBWTtRQWhCcEQ7O1dBRUc7UUFDSyxvQkFBZSxHQUFVLEVBQUUsQ0FBQztRQWVsQyxJQUFJLGdCQUFnQixFQUFFO1lBQ3BCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUN2QyxNQUFNLENBQUMsRUFBRTtnQkFDUCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDZCxDQUFDLENBQ0YsQ0FBQztTQUNIO0lBQ0gsQ0FBQztJQUNNLFVBQVUsQ0FBQyxJQUFhO1FBQzdCLGtCQUFrQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7SUFDdEMsQ0FBQztJQUNEOztPQUVHO0lBQ0ksSUFBSSxDQUFDLGVBQXFCO1FBQy9CLElBQUksa0JBQWtCLENBQUMsU0FBUyxLQUFLLElBQUksRUFBRTtZQUN6QyxPQUFP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SUFDOUMsQ0FBQzs7QUExS2MsNEJBQVMsR0FBRyxLQUFLLENBQUM7O1lBRmxDLFVBQVU7Ozs7WUFURixjQUFjO1lBQ2QsZ0JBQWdCLHVCQStCcEIsUUFBUTtZQTlCSixVQUFVLHVCQStCZCxRQUFROztBQXdKYixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIFNraXBTZWxmLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBMb2FkaW5nU2VydmljZSwgTG9hZGluZ0NvbmZpZywgTG9hZGluZ0NvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktbG9hZGluZyc7XHJcbmltcG9ydCB7IEhpZGVFdmVudFNlcnZpY2UgfSBmcm9tICcuL2hpZGUtZXZlbnQuc2VydmljZSc7XHJcbmltcG9ydCB7IEFwcENvbnRleHQsIEZyYW1lQ29udGV4dCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuLy8gdHNsaW50OmRpc2FibGU6IG5vLXN0cmluZy1saXRlcmFsXHJcbi8qKlxyXG4gKiDliqDovb3mj5DnpLpIZWxwZXJcclxuICogMeOAgeWMheijhUBmYXJyaXMvdWnnmoRMb2FkaW5nU2VydmljZe+8m1xyXG4gKiAy44CB5o+Q5L6b6ZKI5a+56KGo5Y2V55qE5b+r5o235pa55rOV77ybXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmNsYXNzIEZvcm1Mb2FkaW5nU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBzdGF0aWMgaXNTdXNwZW5kID0gZmFsc2U7XHJcbiAgLyoqXHJcbiAgICog5Yqg6L295Lit57uE5Lu25a6e5L6LXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBsb2FkaW5nQ21wOiBMb2FkaW5nQ29tcG9uZW50O1xyXG5cclxuICAvKipcclxuICAgKiDlu7bov59sb2FkaW5n5a6a5pe25ZmoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBsb2FkaW5nVGltZXJJZHM6IGFueVtdID0gW107XHJcblxyXG4gIC8qKlxyXG4gICAqIOW8uuWItuaYvuekuu+8jOS4jeiDvemakOiXj1xyXG4gICAqL1xyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKiDms6jlhaVAZmFycmlzL3Vp55qETG9hZGluZ1NlcnZpY2VcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgbG9hZGluZ1NlcnZpY2U6IExvYWRpbmdTZXJ2aWNlLFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBoaWRlRXZlbnRTZXJ2aWNlOiBIaWRlRXZlbnRTZXJ2aWNlLFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBhcHBsaWNhdGlvbkNvbnRleHQ6IEFwcENvbnRleHQsXHJcbiAgKSB7XHJcbiAgICBpZiAoaGlkZUV2ZW50U2VydmljZSkge1xyXG4gICAgICB0aGlzLmhpZGVFdmVudFNlcnZpY2UuaGlkZUV2ZW50LnN1YnNjcmliZShcclxuICAgICAgICByZXN1bHQgPT4ge1xyXG4gICAgICAgICAgdGhpcy5oaWRlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuICBwdWJsaWMgc2V0U3VzcGVuZChmbGFnOiBib29sZWFuKSB7XHJcbiAgICBGb3JtTG9hZGluZ1NlcnZpY2UuaXNTdXNwZW5kID0gZmxhZztcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5pi+56S65Yqg6L295LitXHJcbiAgICovXHJcbiAgcHVibGljIHNob3coY29uZmlnT3JNZXNzYWdlPzogYW55KTogTG9hZGluZ0NvbXBvbmVudCB7XHJcbiAgICBpZiAoRm9ybUxvYWRpbmdTZXJ2aWNlLmlzU3VzcGVuZCA9PT0gdHJ1ZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5sb2FkaW5nQ21wKSB7XHJcbiAgICAgIHRoaXMubG9hZGluZ0NtcC5jbG9zZSgpO1xyXG4gICAgICB0aGlzLmxvYWRpbmdDbXAgPSBudWxsO1xyXG4gICAgfVxyXG4gICAgdGhpcy5yZWdpc3RlclNlcnZpY2UoKTtcclxuICAgIGNvbnN0IGxvYWRpbmdDb25maWcgPSB0aGlzLmJ1aWxkTG9hZGluZ0NvbmZpZyhjb25maWdPck1lc3NhZ2UpO1xyXG4gICAgdGhpcy5sb2FkaW5nQ21wID0gdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KGxvYWRpbmdDb25maWcpO1xyXG4gICAgcmV0dXJuIHRoaXMubG9hZGluZ0NtcDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOW7tui/n+aYvuekukxvYWRpbmdcclxuICAgKi9cclxuICBwdWJsaWMgc2hvd0xvYWRpbmdXaXRoRGVsYXkoZGVsYXlUaW1lOiBudW1iZXIsIGNvbmZpZ09yTWVzc2FnZT86IGFueSk6IGFueSB7XHJcbiAgICAvLyB0aGlzLnNob3coY29uZmlnT3JNZXNzYWdlKTtcclxuICAgIGNvbnN0IHRpbWVySWQgPSBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgdGhpcy5zaG93KGNvbmZpZ09yTWVzc2FnZSk7XHJcbiAgICB9LCBkZWxheVRpbWUpO1xyXG4gICAgdGhpcy5sb2FkaW5nVGltZXJJZHMucHVzaCh0aW1lcklkKTtcclxuICAgIHRoaXMucmVnaXN0ZXJTZXJ2aWNlKCk7XHJcbiAgICByZXR1cm4gdGltZXJJZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOmakOiXj+W7tui/n+eahExvYWRpbmdcclxuICAgKi9cclxuICBwdWJsaWMgaGlkZURlbGF5TG9hZGluZyh0aW1lcklkVG9DbGVhcjogYW55KSB7XHJcbiAgICB0aGlzLmNsZWFyTG9hZGluZ1RpbWVyKHRpbWVySWRUb0NsZWFyKTtcclxuICAgIHRoaXMuaGlkZSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCgTG9hZGluZ0NvbmZpZ1xyXG4gICAqIEBwYXJhbSBjb25maWdPck1lc3NhZ2Ug6YWN572u5a+56LGh5oiW5raI5oGv5a2X56ym5LiyXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZExvYWRpbmdDb25maWcoY29uZmlnT3JNZXNzYWdlOiBhbnkpOiBMb2FkaW5nQ29uZmlnIHtcclxuICAgIGxldCBsb2FkaW5nQ29uZmlnOiBMb2FkaW5nQ29uZmlnO1xyXG4gICAgaWYgKCEhY29uZmlnT3JNZXNzYWdlKSB7XHJcbiAgICAgIGlmICh0eXBlb2YgY29uZmlnT3JNZXNzYWdlID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgIGxvYWRpbmdDb25maWcgPSBjb25maWdPck1lc3NhZ2U7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgbG9hZGluZ0NvbmZpZyA9IHsgJ21lc3NhZ2UnOiBjb25maWdPck1lc3NhZ2UgfTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbG9hZGluZ0NvbmZpZyA9IHt9O1xyXG4gICAgfVxyXG4gICAgaWYgKCFsb2FkaW5nQ29uZmlnLmhhc093blByb3BlcnR5KCdkZWxheScpKSB7XHJcbiAgICAgIGxvYWRpbmdDb25maWcuZGVsYXkgPSAwO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGxvYWRpbmdDb25maWc7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlhbPpl63miYDmnIlsb2FkaW5nXHJcbiAgICovXHJcbiAgcHVibGljIGNsZWFyQWxsKCkge1xyXG4gICAgRm9ybUxvYWRpbmdTZXJ2aWNlLmlzU3VzcGVuZCA9IGZhbHNlO1xyXG4gICAgd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmNsZWFyQWxsKCk7XHJcbiAgICB9LCAzNTApO1xyXG4gICAgdGhpcy5sb2FkaW5nQ21wID0gbnVsbDtcclxuICAgIHRoaXMuY2xlYXJBbGxMb2FkaW5nVGltZXJzKCk7XHJcbiAgICB0aGlzLmRlc3Ryb3koKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa4heepukxvYWRpbmflrprml7blmahcclxuICAgKi9cclxuICBwcml2YXRlIGNsZWFyTG9hZGluZ1RpbWVyKHRpbWVySWRUb0NsZWFyOiBhbnkpIHtcclxuICAgIGNsZWFyVGltZW91dCh0aW1lcklkVG9DbGVhcik7XHJcbiAgICB0aGlzLmxvYWRpbmdUaW1lcklkcyA9IHRoaXMubG9hZGluZ1RpbWVySWRzLmZpbHRlcigodGltZXJJZDogYW55KSA9PiB7XHJcbiAgICAgIHJldHVybiB0aW1lcklkICE9PSB0aW1lcklkVG9DbGVhcjtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5riF56m65omA5pyJTG9hZGluZ+WumuaXtuWZqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgY2xlYXJBbGxMb2FkaW5nVGltZXJzKCkge1xyXG4gICAgdGhpcy5sb2FkaW5nVGltZXJJZHMuZm9yRWFjaCgodGltZXJJZDogYW55KSA9PiB7XHJcbiAgICAgIHRoaXMuY2xlYXJMb2FkaW5nVGltZXIodGltZXJJZCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOmakOiXj+WKoOi9veS4rVxyXG4gICAqL1xyXG4gIHB1YmxpYyBoaWRlKCkge1xyXG4gICAgaWYgKCF0aGlzLmxvYWRpbmdDbXApIHtcclxuICAgICAgdGhpcy5kZXN0cm95KCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmIChGb3JtTG9hZGluZ1NlcnZpY2UuaXNTdXNwZW5kID09PSB0cnVlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMubG9hZGluZ0NtcC5jbG9zZSgpO1xyXG4gICAgdGhpcy5sb2FkaW5nQ21wID0gbnVsbDtcclxuICAgIHRoaXMuZGVzdHJveSgpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDplIDmr4Fsb2FkaW5nU2VydmljZVxyXG4gICAqL1xyXG4gIHB1YmxpYyBkZXN0cm95KCkge1xyXG4gICAgaWYgKEZvcm1Mb2FkaW5nU2VydmljZS5pc1N1c3BlbmQgPT09IHRydWUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgc2VydmljZXM6IGFueVtdID0gd2luZG93WydERVZLSVRfTE9BRElOR19TRVJWSUNFJ10gfHwgW107XHJcbiAgICBpZiAoc2VydmljZXMgJiYgQXJyYXkuaXNBcnJheShzZXJ2aWNlcykgJiYgc2VydmljZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICBzZXJ2aWNlcy5mb3JFYWNoKChzZXJ2aWNlOiBGb3JtTG9hZGluZ1NlcnZpY2UpID0+IHtcclxuICAgICAgICBpZiAoc2VydmljZSkge1xyXG4gICAgICAgICAgc2VydmljZS5jbGVhckFsbExvYWRpbmdUaW1lcnMoKTtcclxuICAgICAgICAgIGlmIChzZXJ2aWNlLmxvYWRpbmdDbXApIHtcclxuICAgICAgICAgICAgc2VydmljZS5sb2FkaW5nQ21wLmNsb3NlKCk7XHJcbiAgICAgICAgICAgIHNlcnZpY2UubG9hZGluZ0NtcCA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICB3aW5kb3dbJ0RFVktJVF9MT0FESU5HX1NFUlZJQ0UnXSA9IFtdO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5rOo5YaM5omA5pyJ55qETG9hZGluZ1NlcnZpY2Xlrp7kvotcclxuICAgKi9cclxuICBwcml2YXRlIHJlZ2lzdGVyU2VydmljZSgpIHtcclxuICAgIGNvbnN0IHNlcnZpY2VzOiBhbnlbXSA9IHdpbmRvd1snREVWS0lUX0xPQURJTkdfU0VSVklDRSddIHx8IFtdO1xyXG4gICAgc2VydmljZXMucHVzaCh0aGlzKTtcclxuICAgIHdpbmRvd1snREVWS0lUX0xPQURJTkdfU0VSVklDRSddID0gc2VydmljZXM7XHJcbiAgfVxyXG59XHJcblxyXG5cclxuZXhwb3J0IHsgRm9ybUxvYWRpbmdTZXJ2aWNlIH07XHJcbiJdfQ==