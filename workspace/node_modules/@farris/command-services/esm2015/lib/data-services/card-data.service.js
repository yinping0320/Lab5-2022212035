import { Injectable, Optional } from '@angular/core';
import { FrameContext } from '@farris/devkit';
import { of, empty, EMPTY, from, Subject } from 'rxjs';
import { tap, switchMap, concatMap, last } from 'rxjs/operators';
import { FormLoadingService } from '../form-loading/form-loading.service';
import { LanguageService } from '../languag.service';
import { FormNotifyService } from '../form-notify.service';
import { FormMessageService } from '../form-message.service';
import { FormErrorService } from '../error/form-error.service';
import { EditStateUtil } from './utils/index';
import { FormNotifyStrategyService } from '../form-notify-strategy.service';
import { RuntimeFrameworkService } from '../rtf-service';
import { WEB_FORM_ROUTE_PARAMS_KEY } from '../types';
import { CommandService } from '../command-service';
import { ValidationService } from '../validation.service';
import { DataChangeDetectionService } from '../data-change-detection.service';
// tslint:disable: no-string-literal
// tslint:disable: max-line-length
/**
 * 卡片仓库服务
 */
class CardDataService {
    /**
     * 构造函数
     */
    constructor(formMessageService, frameContext, loadingService, formNotifyService, languageService, formErrorService, runtimeFrameworkService, commandService) {
        this.formMessageService = formMessageService;
        this.frameContext = frameContext;
        this.loadingService = loadingService;
        this.formNotifyService = formNotifyService;
        this.languageService = languageService;
        this.formErrorService = formErrorService;
        this.runtimeFrameworkService = runtimeFrameworkService;
        this.commandService = commandService;
        if (!languageService) {
            this.languageService = LanguageService.getInstance();
        }
        this.repository = this.frameContext.repository;
        this.bindingData = this.frameContext.bindingData;
    }
    /**
     * 加载数据
     * @param id 主实体id
     * @param enableChildrenPagination 启用子表分页
     */
    load(id) {
        const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        this.frameContext.appContext.params.set("retrieveing", true);
        this.frameContext.appContext.params.delete('queryChild');
        const get$ = this.repository.getById(id);
        return get$.pipe(tap(() => {
            this.loadingService.hideDelayLoading(loadingTimerId);
        }, (error) => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            this.formErrorService.exception(this.languageService.loadFailed, error);
        }));
    }
    /**
     * 加载前
     * @param id id
     * @param transitionActionParamName 状态迁移动作参数编号
     * @returns
     */
    onLoading(transitionActionParamName) {
        const tabId = this.runtimeFrameworkService && this.runtimeFrameworkService.tabId || null;
        if (!tabId) {
            return;
        }
        let skip = true;
        const listening = this.frameContext.appContext.params.get(tabId) || false;
        transitionActionParamName = transitionActionParamName || 'transitionAction';
        if (!listening) {
            this.frameContext.appContext.params.set(tabId, true);
            this.runtimeFrameworkService.getEntityParam(tabId, (options) => {
                if (skip) {
                    skip = false;
                    return;
                }
                const params = this.parseParams(options);
                if (params && params.sync) {
                    const action = params.action;
                    const id = params.id;
                    const ngCommand = this.frameContext && this.frameContext.viewModel && this.frameContext.viewModel.metadatas && this.frameContext.viewModel.metadatas[action];
                    const actionName = ngCommand.params && ngCommand.params[transitionActionParamName] || null;
                    const formPrimaryValue = this.frameContext.bindingData.list.currentId;
                    const formState = this.frameContext.stateMachine.context.state;
                    let state = null;
                    let stateName;
                    if (!actionName) {
                        // 可能是用户自己配置的命令，没有状态机切换，此时不再判断状态机
                        state = formState;
                    }
                    else {
                        const ngAction = this.frameContext && this.frameContext.stateMachine && this.frameContext.stateMachine.metadatas && this.frameContext.stateMachine.metadatas.actions && this.frameContext.stateMachine.metadatas.actions[actionName];
                        state = ngAction && ngAction.transitTo || formState;
                        stateName = this.frameContext && this.frameContext.stateMachine && this.frameContext.stateMachine.metadatas && this.frameContext.stateMachine.metadatas && this.frameContext.stateMachine.metadatas.states[state] && this.frameContext.stateMachine.metadatas.states[state].name || this.languageService.defaultStateName;
                        if (stateName && stateName.startsWith('{{') && stateName.endsWith('}}')) {
                            const key = stateName.replace('{{', '').replace('}}', '');
                            stateName = this.frameContext.translate.transform(key, null);
                        }
                    }
                    const primaryValueChanged = formPrimaryValue !== id;
                    const stateChanged = formState !== state;
                    if (primaryValueChanged && stateChanged) {
                        // 均发生变化
                        const message = this.languageService.dataAndStateChanged.replace(/\$1/g, stateName);
                        this.showLoadingConfirm(message).pipe(switchMap(() => {
                            return this.resetForm(action);
                        })).subscribe();
                    }
                    else if (primaryValueChanged) {
                        // 主键发生变化
                        this.showLoadingConfirm(this.languageService.dataChanged).pipe(switchMap(() => {
                            return this.resetForm(action);
                        })).subscribe();
                    }
                    else if (stateChanged) {
                        // 状态发生变化
                        const message = this.languageService.stateChanged.replace(/\$1/g, stateName);
                        this.showLoadingConfirm(message).pipe(switchMap(() => {
                            return this.resetForm(action);
                        })).subscribe();
                    }
                    else {
                        // 数据及状态均未发生变化
                        return of(true);
                    }
                }
            }, false);
        }
    }
    /**
     * 新增
     */
    add() {
        const lastModifiedId = this.bindingData.list.currentId;
        const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        const create$ = this.repository.create();
        return create$.pipe(tap(() => {
            EditStateUtil.setEditState(this.frameContext, lastModifiedId);
            this.loadingService.hideDelayLoading(loadingTimerId);
        }, (error) => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            this.formErrorService.exception(this.languageService.addFailed, error);
        }));
    }
    /**
     * 级联新增
     */
    cascadeAdd() {
        const subject = new Subject();
        // 找到所有viewmodel,拿到了所有的frameContext，可能有组合表单的
        const frameContexts = this.frameContext.appContext.frameContextManager.getFrameContexts();
        // 找到当前frameContext的公共namespace
        const currentNamespace = this.frameContext.getVirtualRootFrameContext().namespace;
        // 拿到当前命令所在frame的表单的所有frameContext
        const currentFormFrameContexts = frameContexts.filter((context) => context.namespace === currentNamespace) || [];
        let bindingPaths = [];
        if (currentFormFrameContexts && currentFormFrameContexts.length > 0) {
            // 找到所有下级frameContext
            const childFrameContexts = currentFormFrameContexts.filter((context) => context.viewModel.bindingPath && context.viewModel.bindingPath !== '/');
            if (childFrameContexts && childFrameContexts.length > 0) {
                let childBindingPaths = childFrameContexts.map((context) => context.viewModel.bindingPath);
                childBindingPaths = childBindingPaths.filter((item, index) => childBindingPaths.indexOf(item) === index);
                if (childBindingPaths && childBindingPaths.length > 0) {
                    bindingPaths = childBindingPaths.map((path) => path.split('/').filter((p) => p)).sort((a, b) => a.length - b.length);
                }
            }
        }
        this.loadingService.show();
        this.repository.create().pipe(switchMap((entity) => {
            const rid = entity.primaryValue;
            if (bindingPaths && bindingPaths.length > 0) {
                return from(bindingPaths).pipe(concatMap((bindingPath) => {
                    const fpath = this.getPath(this.frameContext.viewModel, '/' + bindingPath.join('/'), rid);
                    return this.repository.appendByPath(fpath);
                }));
            }
            else {
                return of(entity);
            }
        })).pipe(last()).subscribe(() => {
            this.loadingService.hide();
            subject.next();
        }, (error) => {
            this.loadingService.hide();
            this.formErrorService.exception(this.languageService.addFailed, error);
        });
        return subject;
    }
    /**
     * 编辑（更新数据并标记编辑状态）
     */
    edit(id) {
        const update$ = this.update();
        return update$.pipe(tap(() => {
            const currentId = this.bindingData.list.currentId;
            EditStateUtil.setEditState(this.frameContext, currentId);
        }));
    }
    /**
     * 更新
     * @param id 主实体id
     * @param enableChildrenPagination 启用子表分页
     */
    update(id) {
        // 获取id
        id = this.bindingData.list.currentId;
        if (!id) {
            return empty();
        }
        const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        const update$ = this.repository.updateById(id);
        this.frameContext.appContext.params.set("retrieveing", true);
        return update$.pipe(tap(() => {
            this.loadingService.hideDelayLoading(loadingTimerId);
        }, (error) => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            this.formErrorService.exception(this.languageService.updateFailed, error);
        }));
    }
    updateWithoutEmpty() {
        // 获取id
        const id = this.bindingData.list.currentId;
        if (!id) {
            return of(null);
        }
        else {
            return this.update();
        }
    }
    /**
     * 校验当前行是否存在
     * @returns
     */
    checkBeforeUpdate() {
        const bindingList = this.frameContext.bindingData.list;
        const id = bindingList && bindingList.currentId;
        if (!id) {
            this.formNotifyService.warning(this.languageService.noDataExist, { hideTitle: true });
            return EMPTY;
        }
        return of(true);
    }
    /**
     * 已废弃
     * @returns
     */
    updateWithNotify() {
        // 获取id
        const id = this.bindingData.list.currentId;
        if (!id) {
            this.formNotifyService.warning(this.languageService.noDataExist, { hideTitle: true });
            return EMPTY;
        }
        else {
            return this.update();
        }
    }
    /**
     * 加载卡片数据（分页加载子表数据）
     * @deprecated 方法已废弃，请勿使用
     */
    loadPaged(filter, sort) {
        // 获取id
        const id = this.bindingData.list.currentId;
        if (!id) {
            return EMPTY;
        }
        const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        // this.frameContext.root.params.set('updateWithPaging', true);
        const update$ = of(null); //this.repository.updateEntityById(id, true);
        return update$.pipe(tap(() => {
            this.loadingService.hideDelayLoading(loadingTimerId);
        }, (error) => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            this.formErrorService.exception(this.languageService.updateFailed, error);
        }));
    }
    /**
     * 保存
     */
    save(successMsg) {
        // 获取当前行
        const id = this.bindingData.list.currentId;
        if (!id) {
            return of(false);
        }
        const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        const update$ = this.repository.updateChangesById(id);
        const save$ = this.repository.applyChangesById(id);
        const result$ = update$.pipe(
        // update$ => save$
        switchMap((updateResult) => {
            if (updateResult === false) {
                return of(false);
            }
            else {
                return save$;
            }
        }), 
        // 隐藏loading
        tap(() => {
            // 取消新增状态
            EditStateUtil.setEditState(this.frameContext, id);
            this.loadingService.hideDelayLoading(loadingTimerId);
            // this.formNotifyService.info(this.languageService.saveSuccess);
            if (successMsg && successMsg.trim()) {
                let showMessage = true;
                if (successMsg.startsWith('{') && successMsg.endsWith('}')) {
                    try {
                        const options = JSON.parse(successMsg);
                        if (options.showMessage === false) {
                            showMessage = false;
                        }
                    }
                    catch (_a) { }
                }
                if (showMessage !== false) {
                    this.formNotifyService.success(successMsg, { hideTitle: true });
                }
            }
            else {
                FormNotifyStrategyService.success(this.formNotifyService, this.languageService.saveSuccess);
            }
            // FormNotifyStrategyService.success(this.formNotifyService, this.languageService.saveSuccess);
        }, (error) => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            this.formErrorService.exception(this.languageService.saveFailed, error);
        }));
        return result$;
    }
    // #region 取消相关方法
    /**
     * 取消（默认取消）
     */
    cancel() {
        return this.cancelWithCheck();
    }
    /**
     * 还原变更集
     * @description 不带变更检测提示
     */
    revert(options) {
        return this.cancelWithoutCheck(options);
    }
    /**
     * 取消（取消前检查未保存的变更）
     * @summary
     * 1、用户误操作：只需要做个提示就可以了；
     * 2、用户有意取消：点击取消就是要放弃所有变更，这时候询问人家是否要保存或者提示存在变更有点多此一举，确认一把即可。
     * 3、用户误操作：没有变更的情况下直接给取消了，用户会产生恐慌，因为用户有时候并不确定是否有变更，应该也确认一把。
     * @todo
     * 1、由于产品部很多代码误用了该方法，依赖了没有变更的时候直接取消，现在弹窗确认框来，不太合适；
     * 2、产品部需要用cancelWithoutCheck方法代替，目前先给兼容着，待删除。
     */
    cancelWithCheck() {
        const hasChange$ = DataChangeDetectionService.hasChange(this.frameContext);
        return hasChange$.pipe(switchMap((changed) => {
            if (!changed) {
                return this.cancelChanges();
            }
            else {
                // 确认是否取消
                const confirm$ = this.formMessageService.question(this.languageService['cancelWithoutSave']);
                const result$ = confirm$.pipe(switchMap((ifCancel) => {
                    if (ifCancel === false) {
                        return EMPTY;
                    }
                    return this.cancelChanges();
                }));
                return result$;
            }
        }));
    }
    /**
     * 取消（直接取消，不执行检查）
     */
    cancelWithoutCheck(options) {
        return this.cancelChanges(options);
    }
    /**
     * 取消
     */
    cancelChanges(options) {
        const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        const cancel$ = this.repository.cancelChanges(options);
        return cancel$.pipe(tap(() => {
            EditStateUtil.setEditState(this.frameContext, '');
            this.loadingService.hideDelayLoading(loadingTimerId);
        }, (error) => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            this.formErrorService.exception(this.languageService.cancelFailed, error);
        }));
    }
    // #endregion
    /**
     * 重新加载（仅供卡片取消后重新加载数据，其他场景请勿使用）
     */
    reload() {
        const isAdd = EditStateUtil.getAddState(this.frameContext);
        let id;
        if (isAdd === true) {
            id = EditStateUtil.getLastModifiedId(this.frameContext);
        }
        else {
            id = this.bindingData.list.currentId;
        }
        if (!id) {
            this.repository.entityCollection.loadEntities([]);
            return;
        }
        return this.load(id);
    }
    getPath(viewModel, bindingPath, rid) {
        let path = '/' + rid;
        const subPaths = bindingPath.split('/');
        if (subPaths.length > 0) {
            // eg:bindingPath形如/edus/grades,split后是['', 'edus', 'grades']
            // 因此index从1开始
            for (let index = 1; index < subPaths.length - 1; index++) {
                const subPath = subPaths[index];
                const subData = viewModel.bindingData[subPath];
                if (!subData || !subData.currentId) {
                    throw Error(`获取子表完整路径出错，找不到${subData}对应的子表，或对应子表没有当前行。`);
                }
                path += `/${subPath}/${subData.currentId}`;
            }
        }
        path += '/' + subPaths[subPaths.length - 1];
        return path;
    }
    resetForm(action) {
        const validationService = this.frameContext.injector.get(ValidationService, null);
        return this.frameContext.repository.cancelChanges().pipe(switchMap(() => this.commandService.execute(action).pipe(switchMap(() => {
            return validationService && validationService.resetValidation() || of(null);
        }))));
    }
    parseParams(options) {
        if (options && Object.prototype.toString.call(options) === "[object Map]" /* map */) {
            let params = options.get(WEB_FORM_ROUTE_PARAMS_KEY);
            if (params && typeof params === 'string') {
                params = decodeURIComponent(params);
                if (params.startsWith('{') && params.endsWith('}')) {
                    params = JSON.parse(params);
                }
                return {
                    action: params.action,
                    id: params.idToView || params.idToEdit || params.id,
                    sync: params.sync || false
                };
            }
        }
        return null;
    }
    showLoadingConfirm(message) {
        return this.formMessageService.confirm(message).pipe(switchMap((result) => {
            if (result === true) {
                return of(true);
            }
            else {
                return EMPTY;
            }
        }));
    }
}
CardDataService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
CardDataService.ctorParameters = () => [
    { type: FormMessageService },
    { type: FrameContext },
    { type: FormLoadingService },
    { type: FormNotifyService },
    { type: LanguageService, decorators: [{ type: Optional }] },
    { type: FormErrorService },
    { type: RuntimeFrameworkService },
    { type: CommandService }
];
export { CardDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FyZC1kYXRhLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZGF0YS1zZXJ2aWNlcy9jYXJkLWRhdGEuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQXVCLFlBQVksRUFBYSxNQUFNLGdCQUFnQixDQUFDO0FBRTlFLE9BQU8sRUFBYyxFQUFFLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBZSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2hGLE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBdUIsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEYsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDMUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzNELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzdELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDOUMsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDNUUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekQsT0FBTyxFQUFZLHlCQUF5QixFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztB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LENBQUMsR0FBRyxDQUFDLEVBQUU7b0JBQ2xELE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUM3QjtnQkFDRCxPQUFPO29CQUNMLE1BQU0sRUFBRSxNQUFNLENBQUMsTUFBTTtvQkFDckIsRUFBRSxFQUFFLE1BQU0sQ0FBQyxRQUFRLElBQUksTUFBTSxDQUFDLFFBQVEsSUFBSSxNQUFNLENBQUMsRUFBRTtvQkFDbkQsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLElBQUksS0FBSztpQkFDM0IsQ0FBQzthQUNIO1NBQ0Y7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFDTyxrQkFBa0IsQ0FBQyxPQUFlO1FBQ3hDLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQ2xELFNBQVMsQ0FBQyxDQUFDLE1BQWUsRUFBRSxFQUFFO1lBQzVCLElBQUksTUFBTSxLQUFLLElBQUksRUFBRTtnQkFDbkIsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDakI7aUJBQU07Z0JBQ0wsT0FBTyxLQUFLLENBQUM7YUFDZDtRQUNILENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDOzs7WUEvZkYsVUFBVTs7OztZQWRGLGtCQUFrQjtZQVBHLFlBQVk7WUFJakMsa0JBQWtCO1lBRWxCLGlCQUFpQjtZQURqQixlQUFlLHVCQXFDbkIsUUFBUTtZQWxDSixnQkFBZ0I7WUFHaEIsdUJBQXVCO1lBRXZCLGNBQWM7O0FBeWdCdkIsT0FBTyxFQUFFLGVBQWUsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRW50aXR5LCBCaW5kaW5nRGF0YSwgRnJhbWVDb250ZXh0LCBWaWV3TW9kZWwgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnksIEJlZlJlcG9zaXRvcnlVdGlsIH0gZnJvbSAnQGZhcnJpcy9iZWYnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgZW1wdHksIEVNUFRZLCBjb25jYXQsIHppcCwgZnJvbSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YXAsIHN3aXRjaE1hcCwgY29uY2F0TWFwLCBjb25jYXRBbGwsIHRha2VMYXN0LCBsYXN0IH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBGb3JtTG9hZGluZ1NlcnZpY2UgfSBmcm9tICcuLi9mb3JtLWxvYWRpbmcvZm9ybS1sb2FkaW5nLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuLi9sYW5ndWFnLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGb3JtTm90aWZ5U2VydmljZSB9IGZyb20gJy4uL2Zvcm0tbm90aWZ5LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGb3JtTWVzc2FnZVNlcnZpY2UgfSBmcm9tICcuLi9mb3JtLW1lc3NhZ2Uuc2VydmljZSc7XHJcbmltcG9ydCB7IEZvcm1FcnJvclNlcnZpY2UgfSBmcm9tICcuLi9lcnJvci9mb3JtLWVycm9yLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBFZGl0U3RhdGVVdGlsIH0gZnJvbSAnLi91dGlscy9pbmRleCc7XHJcbmltcG9ydCB7IEZvcm1Ob3RpZnlTdHJhdGVneVNlcnZpY2UgfSBmcm9tICcuLi9mb3JtLW5vdGlmeS1zdHJhdGVneS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgUnVudGltZUZyYW1ld29ya1NlcnZpY2UgfSBmcm9tICcuLi9ydGYtc2VydmljZSc7XHJcbmltcG9ydCB7IERhdGFUeXBlLCBXRUJfRk9STV9ST1VURV9QQVJBTVNfS0VZIH0gZnJvbSAnLi4vdHlwZXMnO1xyXG5pbXBvcnQgeyBDb21tYW5kU2VydmljZSB9IGZyb20gJy4uL2NvbW1hbmQtc2VydmljZSc7XHJcbmltcG9ydCB7IFZhbGlkYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vdmFsaWRhdGlvbi5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRGF0YUNoYW5nZURldGVjdGlvblNlcnZpY2UgfSBmcm9tICcuLi9kYXRhLWNoYW5nZS1kZXRlY3Rpb24uc2VydmljZSc7XHJcbi8vIHRzbGludDpkaXNhYmxlOiBuby1zdHJpbmctbGl0ZXJhbFxyXG4vLyB0c2xpbnQ6ZGlzYWJsZTogbWF4LWxpbmUtbGVuZ3RoXHJcbi8qKlxyXG4gKiDljaHniYfku5PlupPmnI3liqFcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuY2xhc3MgQ2FyZERhdGFTZXJ2aWNlIHtcclxuXHJcbiAgLyoqXHJcbiAgICog5a6e5L2T5LuT5bqTXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT47XHJcblxyXG4gIC8qKlxyXG4gICAqIOe7keWumuaVsOaNrlxyXG4gICAqL1xyXG4gIHByaXZhdGUgYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhO1xyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgZm9ybU1lc3NhZ2VTZXJ2aWNlOiBGb3JtTWVzc2FnZVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LFxyXG4gICAgcHJpdmF0ZSBsb2FkaW5nU2VydmljZTogRm9ybUxvYWRpbmdTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBmb3JtTm90aWZ5U2VydmljZTogRm9ybU5vdGlmeVNlcnZpY2UsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBmb3JtRXJyb3JTZXJ2aWNlOiBGb3JtRXJyb3JTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBydW50aW1lRnJhbWV3b3JrU2VydmljZTogUnVudGltZUZyYW1ld29ya1NlcnZpY2UsXHJcbiAgICBwcml2YXRlIGNvbW1hbmRTZXJ2aWNlOiBDb21tYW5kU2VydmljZVxyXG4gICkge1xyXG4gICAgaWYgKCFsYW5ndWFnZVNlcnZpY2UpIHtcclxuICAgICAgdGhpcy5sYW5ndWFnZVNlcnZpY2UgPSBMYW5ndWFnZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcclxuICAgIH1cclxuICAgIHRoaXMucmVwb3NpdG9yeSA9IHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxFbnRpdHk+O1xyXG4gICAgdGhpcy5iaW5kaW5nRGF0YSA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yqg6L295pWw5o2uXHJcbiAgICogQHBhcmFtIGlkIOS4u+WunuS9k2lkXHJcbiAgICogQHBhcmFtIGVuYWJsZUNoaWxkcmVuUGFnaW5hdGlvbiDlkK/nlKjlrZDooajliIbpobVcclxuICAgKi9cclxuICBwdWJsaWMgbG9hZChpZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxFbnRpdHk+IHtcclxuICAgIGNvbnN0IGxvYWRpbmdUaW1lcklkID0gdGhpcy5sb2FkaW5nU2VydmljZS5zaG93TG9hZGluZ1dpdGhEZWxheSg1MDApO1xyXG4gICAgdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5wYXJhbXMuc2V0KFwicmV0cmlldmVpbmdcIiwgdHJ1ZSk7XHJcbiAgICB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LnBhcmFtcy5kZWxldGUoJ3F1ZXJ5Q2hpbGQnKTtcclxuICAgIGNvbnN0IGdldCQgPSB0aGlzLnJlcG9zaXRvcnkuZ2V0QnlJZChpZCk7XHJcbiAgICByZXR1cm4gZ2V0JC5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIChlcnJvcjogYW55KSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xyXG4gICAgICAgICAgdGhpcy5mb3JtRXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5sb2FkRmFpbGVkLCBlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDliqDovb3liY1cclxuICAgKiBAcGFyYW0gaWQgaWRcclxuICAgKiBAcGFyYW0gdHJhbnNpdGlvbkFjdGlvblBhcmFtTmFtZSDnirbmgIHov4Hnp7vliqjkvZzlj4LmlbDnvJblj7dcclxuICAgKiBAcmV0dXJuc1xyXG4gICAqL1xyXG4gIHB1YmxpYyBvbkxvYWRpbmcodHJhbnNpdGlvbkFjdGlvblBhcmFtTmFtZTogc3RyaW5nKSB7XHJcbiAgICBjb25zdCB0YWJJZCA9IHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UgJiYgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS50YWJJZCB8fCBudWxsO1xyXG4gICAgaWYgKCF0YWJJZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBsZXQgc2tpcCA9IHRydWU7XHJcbiAgICBjb25zdCBsaXN0ZW5pbmcgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LnBhcmFtcy5nZXQodGFiSWQpIHx8IGZhbHNlO1xyXG4gICAgdHJhbnNpdGlvbkFjdGlvblBhcmFtTmFtZSA9IHRyYW5zaXRpb25BY3Rpb25QYXJhbU5hbWUgfHwgJ3RyYW5zaXRpb25BY3Rpb24nO1xyXG4gICAgaWYgKCFsaXN0ZW5pbmcpIHtcclxuICAgICAgdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5wYXJhbXMuc2V0KHRhYklkLCB0cnVlKTtcclxuICAgICAgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5nZXRFbnRpdHlQYXJhbSh0YWJJZCwgKG9wdGlvbnM6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmIChza2lwKSB7XHJcbiAgICAgICAgICBza2lwID0gZmFsc2U7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMucGFyc2VQYXJhbXMob3B0aW9ucyk7XHJcbiAgICAgICAgaWYgKHBhcmFtcyAmJiBwYXJhbXMuc3luYykge1xyXG4gICAgICAgICAgY29uc3QgYWN0aW9uID0gcGFyYW1zLmFjdGlvbjtcclxuICAgICAgICAgIGNvbnN0IGlkID0gcGFyYW1zLmlkO1xyXG4gICAgICAgICAgY29uc3QgbmdDb21tYW5kID0gdGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsICYmIHRoaXMuZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5tZXRhZGF0YXMgJiYgdGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsLm1ldGFkYXRhc1thY3Rpb25dO1xyXG4gICAgICAgICAgY29uc3QgYWN0aW9uTmFtZSA9IG5nQ29tbWFuZC5wYXJhbXMgJiYgbmdDb21tYW5kLnBhcmFtc1t0cmFuc2l0aW9uQWN0aW9uUGFyYW1OYW1lXSB8fCBudWxsO1xyXG4gICAgICAgICAgY29uc3QgZm9ybVByaW1hcnlWYWx1ZSA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkO1xyXG4gICAgICAgICAgY29uc3QgZm9ybVN0YXRlID0gdGhpcy5mcmFtZUNvbnRleHQuc3RhdGVNYWNoaW5lLmNvbnRleHQuc3RhdGU7XHJcbiAgICAgICAgICBsZXQgc3RhdGUgPSBudWxsO1xyXG4gICAgICAgICAgbGV0IHN0YXRlTmFtZTogc3RyaW5nO1xyXG4gICAgICAgICAgaWYgKCFhY3Rpb25OYW1lKSB7XHJcbiAgICAgICAgICAgIC8vIOWPr+iDveaYr+eUqOaIt+iHquW3semFjee9rueahOWRveS7pO+8jOayoeacieeKtuaAgeacuuWIh+aNou+8jOatpOaXtuS4jeWGjeWIpOaWreeKtuaAgeaculxyXG4gICAgICAgICAgICBzdGF0ZSA9IGZvcm1TdGF0ZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBuZ0FjdGlvbiA9IHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LnN0YXRlTWFjaGluZSAmJiB0aGlzLmZyYW1lQ29udGV4dC5zdGF0ZU1hY2hpbmUubWV0YWRhdGFzICYmIHRoaXMuZnJhbWVDb250ZXh0LnN0YXRlTWFjaGluZS5tZXRhZGF0YXMuYWN0aW9ucyAmJiB0aGlzLmZyYW1lQ29udGV4dC5zdGF0ZU1hY2hpbmUubWV0YWRhdGFzLmFjdGlvbnNbYWN0aW9uTmFtZV07XHJcbiAgICAgICAgICAgIHN0YXRlID0gbmdBY3Rpb24gJiYgbmdBY3Rpb24udHJhbnNpdFRvIHx8IGZvcm1TdGF0ZTtcclxuICAgICAgICAgICAgc3RhdGVOYW1lID0gdGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuc3RhdGVNYWNoaW5lICYmIHRoaXMuZnJhbWVDb250ZXh0LnN0YXRlTWFjaGluZS5tZXRhZGF0YXMgJiYgdGhpcy5mcmFtZUNvbnRleHQuc3RhdGVNYWNoaW5lLm1ldGFkYXRhcyAmJiB0aGlzLmZyYW1lQ29udGV4dC5zdGF0ZU1hY2hpbmUubWV0YWRhdGFzLnN0YXRlc1tzdGF0ZV0gJiYgdGhpcy5mcmFtZUNvbnRleHQuc3RhdGVNYWNoaW5lLm1ldGFkYXRhcy5zdGF0ZXNbc3RhdGVdLm5hbWUgfHwgdGhpcy5sYW5ndWFnZVNlcnZpY2UuZGVmYXVsdFN0YXRlTmFtZTtcclxuICAgICAgICAgICAgaWYgKHN0YXRlTmFtZSAmJiBzdGF0ZU5hbWUuc3RhcnRzV2l0aCgne3snKSAmJiBzdGF0ZU5hbWUuZW5kc1dpdGgoJ319JykpIHtcclxuICAgICAgICAgICAgICBjb25zdCBrZXkgPSBzdGF0ZU5hbWUucmVwbGFjZSgne3snLCAnJykucmVwbGFjZSgnfX0nLCAnJyk7XHJcbiAgICAgICAgICAgICAgc3RhdGVOYW1lID0gdGhpcy5mcmFtZUNvbnRleHQudHJhbnNsYXRlLnRyYW5zZm9ybShrZXksIG51bGwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjb25zdCBwcmltYXJ5VmFsdWVDaGFuZ2VkID0gZm9ybVByaW1hcnlWYWx1ZSAhPT0gaWQ7XHJcbiAgICAgICAgICBjb25zdCBzdGF0ZUNoYW5nZWQgPSBmb3JtU3RhdGUgIT09IHN0YXRlO1xyXG5cclxuICAgICAgICAgIGlmIChwcmltYXJ5VmFsdWVDaGFuZ2VkICYmIHN0YXRlQ2hhbmdlZCkge1xyXG4gICAgICAgICAgICAvLyDlnYflj5HnlJ/lj5jljJZcclxuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmRhdGFBbmRTdGF0ZUNoYW5nZWQucmVwbGFjZSgvXFwkMS9nLCBzdGF0ZU5hbWUpO1xyXG4gICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nQ29uZmlybShtZXNzYWdlKS5waXBlKHN3aXRjaE1hcCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzZXRGb3JtKGFjdGlvbik7XHJcbiAgICAgICAgICAgIH0pKS5zdWJzY3JpYmUoKTtcclxuICAgICAgICAgIH0gZWxzZSBpZiAocHJpbWFyeVZhbHVlQ2hhbmdlZCkge1xyXG4gICAgICAgICAgICAvLyDkuLvplK7lj5HnlJ/lj5jljJZcclxuICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZ0NvbmZpcm0odGhpcy5sYW5ndWFnZVNlcnZpY2UuZGF0YUNoYW5nZWQpLnBpcGUoc3dpdGNoTWFwKCgpID0+IHtcclxuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5yZXNldEZvcm0oYWN0aW9uKTtcclxuICAgICAgICAgICAgfSkpLnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZUNoYW5nZWQpIHtcclxuICAgICAgICAgICAgLy8g54q25oCB5Y+R55Sf5Y+Y5YyWXHJcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSB0aGlzLmxhbmd1YWdlU2VydmljZS5zdGF0ZUNoYW5nZWQucmVwbGFjZSgvXFwkMS9nLCBzdGF0ZU5hbWUpO1xyXG4gICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nQ29uZmlybShtZXNzYWdlKS5waXBlKHN3aXRjaE1hcCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzZXRGb3JtKGFjdGlvbik7XHJcbiAgICAgICAgICAgIH0pKS5zdWJzY3JpYmUoKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIOaVsOaNruWPiueKtuaAgeWdh+acquWPkeeUn+WPmOWMllxyXG4gICAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9LCBmYWxzZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmlrDlop5cclxuICAgKi9cclxuICBwdWJsaWMgYWRkKCk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCBsYXN0TW9kaWZpZWRJZCA9IHRoaXMuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XHJcblxyXG4gICAgY29uc3QgbG9hZGluZ1RpbWVySWQgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3dMb2FkaW5nV2l0aERlbGF5KDUwMCk7XHJcbiAgICBjb25zdCBjcmVhdGUkID0gdGhpcy5yZXBvc2l0b3J5LmNyZWF0ZSgpO1xyXG4gICAgcmV0dXJuIGNyZWF0ZSQucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgICgpID0+IHtcclxuICAgICAgICAgIEVkaXRTdGF0ZVV0aWwuc2V0RWRpdFN0YXRlKHRoaXMuZnJhbWVDb250ZXh0LCBsYXN0TW9kaWZpZWRJZCk7XHJcbiAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XHJcbiAgICAgICAgICB0aGlzLmZvcm1FcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmFkZEZhaWxlZCwgZXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog57qn6IGU5paw5aKeXHJcbiAgICovXHJcbiAgcHVibGljIGNhc2NhZGVBZGQoKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHN1YmplY3QgPSBuZXcgU3ViamVjdDxhbnk+KCk7XHJcbiAgICAvLyDmib7liLDmiYDmnIl2aWV3bW9kZWws5ou/5Yiw5LqG5omA5pyJ55qEZnJhbWVDb250ZXh077yM5Y+v6IO95pyJ57uE5ZCI6KGo5Y2V55qEXHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHMoKTtcclxuICAgIC8vIOaJvuWIsOW9k+WJjWZyYW1lQ29udGV4dOeahOWFrOWFsW5hbWVzcGFjZVxyXG4gICAgY29uc3QgY3VycmVudE5hbWVzcGFjZSA9IHRoaXMuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkubmFtZXNwYWNlO1xyXG4gICAgLy8g5ou/5Yiw5b2T5YmN5ZG95Luk5omA5ZyoZnJhbWXnmoTooajljZXnmoTmiYDmnIlmcmFtZUNvbnRleHRcclxuICAgIGNvbnN0IGN1cnJlbnRGb3JtRnJhbWVDb250ZXh0cyA9IGZyYW1lQ29udGV4dHMuZmlsdGVyKChjb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IGNvbnRleHQubmFtZXNwYWNlID09PSBjdXJyZW50TmFtZXNwYWNlKSB8fCBbXTtcclxuICAgIGxldCBiaW5kaW5nUGF0aHMgPSBbXTtcclxuICAgIGlmIChjdXJyZW50Rm9ybUZyYW1lQ29udGV4dHMgJiYgY3VycmVudEZvcm1GcmFtZUNvbnRleHRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgLy8g5om+5Yiw5omA5pyJ5LiL57qnZnJhbWVDb250ZXh0XHJcbiAgICAgIGNvbnN0IGNoaWxkRnJhbWVDb250ZXh0cyA9IGN1cnJlbnRGb3JtRnJhbWVDb250ZXh0cy5maWx0ZXIoKGNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4gY29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggJiYgY29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggIT09ICcvJyk7XHJcbiAgICAgIGlmIChjaGlsZEZyYW1lQ29udGV4dHMgJiYgY2hpbGRGcmFtZUNvbnRleHRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBsZXQgY2hpbGRCaW5kaW5nUGF0aHMgPSBjaGlsZEZyYW1lQ29udGV4dHMubWFwKChjb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IGNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoKTtcclxuICAgICAgICBjaGlsZEJpbmRpbmdQYXRocyA9IGNoaWxkQmluZGluZ1BhdGhzLmZpbHRlcigoaXRlbSwgaW5kZXgpID0+IGNoaWxkQmluZGluZ1BhdGhzLmluZGV4T2YoaXRlbSkgPT09IGluZGV4KTtcclxuICAgICAgICBpZiAoY2hpbGRCaW5kaW5nUGF0aHMgJiYgY2hpbGRCaW5kaW5nUGF0aHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgYmluZGluZ1BhdGhzID0gY2hpbGRCaW5kaW5nUGF0aHMubWFwKChwYXRoKSA9PiBwYXRoLnNwbGl0KCcvJykuZmlsdGVyKChwKSA9PiBwKSkuc29ydCgoYSwgYikgPT4gYS5sZW5ndGggLSBiLmxlbmd0aCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcclxuICAgIHRoaXMucmVwb3NpdG9yeS5jcmVhdGUoKS5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKGVudGl0eTogRW50aXR5KSA9PiB7XHJcbiAgICAgICAgY29uc3QgcmlkID0gZW50aXR5LnByaW1hcnlWYWx1ZTtcclxuICAgICAgICBpZiAoYmluZGluZ1BhdGhzICYmIGJpbmRpbmdQYXRocy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICByZXR1cm4gZnJvbShiaW5kaW5nUGF0aHMpLnBpcGUoXHJcbiAgICAgICAgICAgIGNvbmNhdE1hcCgoYmluZGluZ1BhdGg6IEFycmF5PGFueT4pID0+IHtcclxuICAgICAgICAgICAgICBjb25zdCBmcGF0aCA9IHRoaXMuZ2V0UGF0aCh0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwsICcvJyArIGJpbmRpbmdQYXRoLmpvaW4oJy8nKSwgcmlkKTtcclxuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5LmFwcGVuZEJ5UGF0aChmcGF0aCk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gb2YoZW50aXR5KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApLnBpcGUobGFzdCgpKS5zdWJzY3JpYmUoXHJcbiAgICAgICgpID0+IHtcclxuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgICBzdWJqZWN0Lm5leHQoKTtcclxuICAgICAgfSxcclxuICAgICAgKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgICB0aGlzLmZvcm1FcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmFkZEZhaWxlZCwgZXJyb3IpO1xyXG4gICAgICB9KTtcclxuICAgIHJldHVybiBzdWJqZWN0O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog57yW6L6R77yI5pu05paw5pWw5o2u5bm25qCH6K6w57yW6L6R54q25oCB77yJXHJcbiAgICovXHJcbiAgcHVibGljIGVkaXQoaWQ/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPEVudGl0eT4ge1xyXG4gICAgY29uc3QgdXBkYXRlJCA9IHRoaXMudXBkYXRlKCk7XHJcbiAgICByZXR1cm4gdXBkYXRlJC5waXBlKFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRJZCA9IHRoaXMuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWRcclxuICAgICAgICBFZGl0U3RhdGVVdGlsLnNldEVkaXRTdGF0ZSh0aGlzLmZyYW1lQ29udGV4dCwgY3VycmVudElkKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmm7TmlrBcclxuICAgKiBAcGFyYW0gaWQg5Li75a6e5L2TaWRcclxuICAgKiBAcGFyYW0gZW5hYmxlQ2hpbGRyZW5QYWdpbmF0aW9uIOWQr+eUqOWtkOihqOWIhumhtVxyXG4gICAqL1xyXG4gIHB1YmxpYyB1cGRhdGUoaWQ/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPEVudGl0eT4ge1xyXG4gICAgLy8g6I635Y+WaWRcclxuICAgIGlkID0gdGhpcy5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZCBhcyBzdHJpbmc7XHJcbiAgICBpZiAoIWlkKSB7XHJcbiAgICAgIHJldHVybiBlbXB0eSgpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgbG9hZGluZ1RpbWVySWQgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3dMb2FkaW5nV2l0aERlbGF5KDUwMCk7XHJcbiAgICBjb25zdCB1cGRhdGUkID0gdGhpcy5yZXBvc2l0b3J5LnVwZGF0ZUJ5SWQoaWQpO1xyXG4gICAgdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5wYXJhbXMuc2V0KFwicmV0cmlldmVpbmdcIiwgdHJ1ZSk7XHJcbiAgICByZXR1cm4gdXBkYXRlJC5waXBlKFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XHJcbiAgICAgIH0sXHJcbiAgICAgICAgKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xyXG4gICAgICAgICAgdGhpcy5mb3JtRXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS51cGRhdGVGYWlsZWQsIGVycm9yKTtcclxuICAgICAgICB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG4gIHB1YmxpYyB1cGRhdGVXaXRob3V0RW1wdHkoKSB7XHJcbiAgICAvLyDojrflj5ZpZFxyXG4gICAgY29uc3QgaWQgPSB0aGlzLmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkIGFzIHN0cmluZztcclxuICAgIGlmICghaWQpIHtcclxuICAgICAgcmV0dXJuIG9mKG51bGwpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHRoaXMudXBkYXRlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOagoemqjOW9k+WJjeihjOaYr+WQpuWtmOWcqFxyXG4gICAqIEByZXR1cm5zXHJcbiAgICovXHJcbiAgcHVibGljIGNoZWNrQmVmb3JlVXBkYXRlKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgY29uc3QgYmluZGluZ0xpc3QgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0O1xyXG4gICAgY29uc3QgaWQgPSBiaW5kaW5nTGlzdCAmJiBiaW5kaW5nTGlzdC5jdXJyZW50SWQ7XHJcbiAgICBpZiAoIWlkKSB7XHJcbiAgICAgIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5ub0RhdGFFeGlzdCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIHJldHVybiBvZih0cnVlKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5bey5bqf5byDXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwdWJsaWMgdXBkYXRlV2l0aE5vdGlmeSgpIHtcclxuICAgIC8vIOiOt+WPlmlkXHJcbiAgICBjb25zdCBpZCA9IHRoaXMuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQgYXMgc3RyaW5nO1xyXG4gICAgaWYgKCFpZCkge1xyXG4gICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2Uubm9EYXRhRXhpc3QsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdGhpcy51cGRhdGUoKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yqg6L295Y2h54mH5pWw5o2u77yI5YiG6aG15Yqg6L295a2Q6KGo5pWw5o2u77yJXHJcbiAgICogQGRlcHJlY2F0ZWQg5pa55rOV5bey5bqf5byD77yM6K+35Yu/5L2/55SoXHJcbiAgICovXHJcbiAgcHVibGljIGxvYWRQYWdlZChmaWx0ZXI/OiBzdHJpbmcsIHNvcnQ/OiBzdHJpbmcpIHtcclxuICAgIC8vIOiOt+WPlmlkXHJcbiAgICBjb25zdCBpZCA9IHRoaXMuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQgYXMgc3RyaW5nO1xyXG4gICAgaWYgKCFpZCkge1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbG9hZGluZ1RpbWVySWQgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3dMb2FkaW5nV2l0aERlbGF5KDUwMCk7XHJcbiAgICAvLyB0aGlzLmZyYW1lQ29udGV4dC5yb290LnBhcmFtcy5zZXQoJ3VwZGF0ZVdpdGhQYWdpbmcnLCB0cnVlKTtcclxuICAgIGNvbnN0IHVwZGF0ZSQgPSBvZihudWxsKTsvL3RoaXMucmVwb3NpdG9yeS51cGRhdGVFbnRpdHlCeUlkKGlkLCB0cnVlKTtcclxuICAgIHJldHVybiB1cGRhdGUkLnBpcGUoXHJcbiAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcclxuICAgICAgfSxcclxuICAgICAgICAoZXJyb3IpID0+IHtcclxuICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XHJcbiAgICAgICAgICB0aGlzLmZvcm1FcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnVwZGF0ZUZhaWxlZCwgZXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5L+d5a2YXHJcbiAgICovXHJcbiAgcHVibGljIHNhdmUoc3VjY2Vzc01zZz86IHN0cmluZyk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgLy8g6I635Y+W5b2T5YmN6KGMXHJcbiAgICBjb25zdCBpZCA9IHRoaXMuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQgYXMgc3RyaW5nO1xyXG4gICAgaWYgKCFpZCkge1xyXG4gICAgICByZXR1cm4gb2YoZmFsc2UpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGxvYWRpbmdUaW1lcklkID0gdGhpcy5sb2FkaW5nU2VydmljZS5zaG93TG9hZGluZ1dpdGhEZWxheSg1MDApO1xyXG4gICAgY29uc3QgdXBkYXRlJCA9IHRoaXMucmVwb3NpdG9yeS51cGRhdGVDaGFuZ2VzQnlJZChpZCk7XHJcbiAgICBjb25zdCBzYXZlJCA9IHRoaXMucmVwb3NpdG9yeS5hcHBseUNoYW5nZXNCeUlkKGlkKTtcclxuICAgIGNvbnN0IHJlc3VsdCQgPSB1cGRhdGUkLnBpcGUoXHJcblxyXG4gICAgICAvLyB1cGRhdGUkID0+IHNhdmUkXHJcbiAgICAgIHN3aXRjaE1hcCgodXBkYXRlUmVzdWx0OiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgaWYgKHVwZGF0ZVJlc3VsdCA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBzYXZlJDtcclxuICAgICAgICB9XHJcbiAgICAgIH0pLFxyXG5cclxuICAgICAgLy8g6ZqQ6JePbG9hZGluZ1xyXG4gICAgICB0YXAoKCkgPT4ge1xyXG5cclxuICAgICAgICAvLyDlj5bmtojmlrDlop7nirbmgIFcclxuICAgICAgICBFZGl0U3RhdGVVdGlsLnNldEVkaXRTdGF0ZSh0aGlzLmZyYW1lQ29udGV4dCwgaWQpO1xyXG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XHJcbiAgICAgICAgLy8gdGhpcy5mb3JtTm90aWZ5U2VydmljZS5pbmZvKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnNhdmVTdWNjZXNzKTtcclxuICAgICAgICBpZiAoc3VjY2Vzc01zZyAmJiBzdWNjZXNzTXNnLnRyaW0oKSkge1xyXG4gICAgICAgICAgbGV0IHNob3dNZXNzYWdlOiBib29sZWFuID0gdHJ1ZTtcclxuICAgICAgICAgIGlmIChzdWNjZXNzTXNnLnN0YXJ0c1dpdGgoJ3snKSAmJiBzdWNjZXNzTXNnLmVuZHNXaXRoKCd9JykpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICBjb25zdCBvcHRpb25zID0gSlNPTi5wYXJzZShzdWNjZXNzTXNnKTtcclxuICAgICAgICAgICAgICBpZiAob3B0aW9ucy5zaG93TWVzc2FnZSA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgIHNob3dNZXNzYWdlID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGNhdGNoIHsgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgaWYgKHNob3dNZXNzYWdlICE9PSBmYWxzZSkge1xyXG4gICAgICAgICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLnN1Y2Nlc3Moc3VjY2Vzc01zZywgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIEZvcm1Ob3RpZnlTdHJhdGVneVNlcnZpY2Uuc3VjY2Vzcyh0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLCB0aGlzLmxhbmd1YWdlU2VydmljZS5zYXZlU3VjY2Vzcyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIEZvcm1Ob3RpZnlTdHJhdGVneVNlcnZpY2Uuc3VjY2Vzcyh0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLCB0aGlzLmxhbmd1YWdlU2VydmljZS5zYXZlU3VjY2Vzcyk7XHJcbiAgICAgIH0sXHJcbiAgICAgICAgKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xyXG4gICAgICAgICAgdGhpcy5mb3JtRXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5zYXZlRmFpbGVkLCBlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG5cclxuICAgIHJldHVybiByZXN1bHQkO1xyXG4gIH1cclxuXHJcblxyXG4gIC8vICNyZWdpb24g5Y+W5raI55u45YWz5pa55rOVXHJcblxyXG4gIC8qKlxyXG4gICAqIOWPlua2iO+8iOm7mOiupOWPlua2iO+8iVxyXG4gICAqL1xyXG4gIHB1YmxpYyBjYW5jZWwoKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHJldHVybiB0aGlzLmNhbmNlbFdpdGhDaGVjaygpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6L+Y5Y6f5Y+Y5pu06ZuGXHJcbiAgICogQGRlc2NyaXB0aW9uIOS4jeW4puWPmOabtOajgOa1i+aPkOekulxyXG4gICAqL1xyXG4gIHB1YmxpYyByZXZlcnQob3B0aW9ucz86IGFueSk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICByZXR1cm4gdGhpcy5jYW5jZWxXaXRob3V0Q2hlY2sob3B0aW9ucyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlj5bmtojvvIjlj5bmtojliY3mo4Dmn6XmnKrkv53lrZjnmoTlj5jmm7TvvIlcclxuICAgKiBAc3VtbWFyeVxyXG4gICAqIDHjgIHnlKjmiLfor6/mk43kvZzvvJrlj6rpnIDopoHlgZrkuKrmj5DnpLrlsLHlj6/ku6XkuobvvJtcclxuICAgKiAy44CB55So5oi35pyJ5oSP5Y+W5raI77ya54K55Ye75Y+W5raI5bCx5piv6KaB5pS+5byD5omA5pyJ5Y+Y5pu077yM6L+Z5pe25YCZ6K+i6Zeu5Lq65a625piv5ZCm6KaB5L+d5a2Y5oiW6ICF5o+Q56S65a2Y5Zyo5Y+Y5pu05pyJ54K55aSa5q2k5LiA5Li+77yM56Gu6K6k5LiA5oqK5Y2z5Y+v44CCXHJcbiAgICogM+OAgeeUqOaIt+ivr+aTjeS9nO+8muayoeacieWPmOabtOeahOaDheWGteS4i+ebtOaOpee7meWPlua2iOS6hu+8jOeUqOaIt+S8muS6p+eUn+aBkOaFjO+8jOWboOS4uueUqOaIt+acieaXtuWAmeW5tuS4jeehruWumuaYr+WQpuacieWPmOabtO+8jOW6lOivpeS5n+ehruiupOS4gOaKiuOAglxyXG4gICAqIEB0b2RvXHJcbiAgICogMeOAgeeUseS6juS6p+WTgemDqOW+iOWkmuS7o+eggeivr+eUqOS6huivpeaWueazle+8jOS+nei1luS6huayoeacieWPmOabtOeahOaXtuWAmeebtOaOpeWPlua2iO+8jOeOsOWcqOW8ueeql+ehruiupOahhuadpe+8jOS4jeWkquWQiOmAgu+8m1xyXG4gICAqIDLjgIHkuqflk4Hpg6jpnIDopoHnlKhjYW5jZWxXaXRob3V0Q2hlY2vmlrnms5Xku6Pmm7/vvIznm67liY3lhYjnu5nlhbzlrrnnnYDvvIzlvoXliKDpmaTjgIJcclxuICAgKi9cclxuICBwdWJsaWMgY2FuY2VsV2l0aENoZWNrKCkge1xyXG4gICAgY29uc3QgaGFzQ2hhbmdlJCA9IERhdGFDaGFuZ2VEZXRlY3Rpb25TZXJ2aWNlLmhhc0NoYW5nZSh0aGlzLmZyYW1lQ29udGV4dCk7XHJcbiAgICByZXR1cm4gaGFzQ2hhbmdlJC5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKGNoYW5nZWQ6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBpZiAoIWNoYW5nZWQpIHtcclxuICAgICAgICAgIHJldHVybiB0aGlzLmNhbmNlbENoYW5nZXMoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8g56Gu6K6k5piv5ZCm5Y+W5raIXHJcbiAgICAgICAgICBjb25zdCBjb25maXJtJCA9IHRoaXMuZm9ybU1lc3NhZ2VTZXJ2aWNlLnF1ZXN0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlWydjYW5jZWxXaXRob3V0U2F2ZSddKTtcclxuICAgICAgICAgIGNvbnN0IHJlc3VsdCQgPSBjb25maXJtJC5waXBlKFxyXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKGlmQ2FuY2VsOiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgICAgaWYgKGlmQ2FuY2VsID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jYW5jZWxDaGFuZ2VzKCk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgICAgcmV0dXJuIHJlc3VsdCQ7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWPlua2iO+8iOebtOaOpeWPlua2iO+8jOS4jeaJp+ihjOajgOafpe+8iVxyXG4gICAqL1xyXG4gIHB1YmxpYyBjYW5jZWxXaXRob3V0Q2hlY2sob3B0aW9ucz86IGFueSkge1xyXG4gICAgcmV0dXJuIHRoaXMuY2FuY2VsQ2hhbmdlcyhvcHRpb25zKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWPlua2iFxyXG4gICAqL1xyXG4gIHByaXZhdGUgY2FuY2VsQ2hhbmdlcyhvcHRpb25zPzogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IGxvYWRpbmdUaW1lcklkID0gdGhpcy5sb2FkaW5nU2VydmljZS5zaG93TG9hZGluZ1dpdGhEZWxheSg1MDApO1xyXG4gICAgY29uc3QgY2FuY2VsJCA9IHRoaXMucmVwb3NpdG9yeS5jYW5jZWxDaGFuZ2VzKG9wdGlvbnMpO1xyXG4gICAgcmV0dXJuIGNhbmNlbCQucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgICgpID0+IHtcclxuICAgICAgICAgIEVkaXRTdGF0ZVV0aWwuc2V0RWRpdFN0YXRlKHRoaXMuZnJhbWVDb250ZXh0LCAnJyk7XHJcbiAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xyXG4gICAgICAgICAgdGhpcy5mb3JtRXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5jYW5jZWxGYWlsZWQsIGVycm9yKTtcclxuICAgICAgICB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvLyAjZW5kcmVnaW9uXHJcblxyXG5cclxuICAvKipcclxuICAgKiDph43mlrDliqDovb3vvIjku4XkvpvljaHniYflj5bmtojlkI7ph43mlrDliqDovb3mlbDmja7vvIzlhbbku5blnLrmma/or7fli7/kvb/nlKjvvIlcclxuICAgKi9cclxuICBwdWJsaWMgcmVsb2FkKCkge1xyXG4gICAgY29uc3QgaXNBZGQgPSBFZGl0U3RhdGVVdGlsLmdldEFkZFN0YXRlKHRoaXMuZnJhbWVDb250ZXh0KTtcclxuICAgIGxldCBpZDtcclxuICAgIGlmIChpc0FkZCA9PT0gdHJ1ZSkge1xyXG4gICAgICBpZCA9IEVkaXRTdGF0ZVV0aWwuZ2V0TGFzdE1vZGlmaWVkSWQodGhpcy5mcmFtZUNvbnRleHQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaWQgPSB0aGlzLmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkIGFzIHN0cmluZztcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIWlkKSB7XHJcbiAgICAgIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmxvYWRFbnRpdGllcyhbXSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGhpcy5sb2FkKGlkKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRQYXRoKHZpZXdNb2RlbDogVmlld01vZGVsLCBiaW5kaW5nUGF0aDogc3RyaW5nLCByaWQ6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBsZXQgcGF0aCA9ICcvJyArIHJpZDtcclxuXHJcbiAgICBjb25zdCBzdWJQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJyk7XHJcbiAgICBpZiAoc3ViUGF0aHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAvLyBlZzpiaW5kaW5nUGF0aOW9ouWmgi9lZHVzL2dyYWRlcyxzcGxpdOWQjuaYr1snJywgJ2VkdXMnLCAnZ3JhZGVzJ11cclxuICAgICAgLy8g5Zug5q2kaW5kZXjku44x5byA5aeLXHJcbiAgICAgIGZvciAobGV0IGluZGV4ID0gMTsgaW5kZXggPCBzdWJQYXRocy5sZW5ndGggLSAxOyBpbmRleCsrKSB7XHJcbiAgICAgICAgY29uc3Qgc3ViUGF0aCA9IHN1YlBhdGhzW2luZGV4XTtcclxuICAgICAgICBjb25zdCBzdWJEYXRhID0gdmlld01vZGVsLmJpbmRpbmdEYXRhW3N1YlBhdGhdO1xyXG4gICAgICAgIGlmICghc3ViRGF0YSB8fCAhc3ViRGF0YS5jdXJyZW50SWQpIHtcclxuICAgICAgICAgIHRocm93IEVycm9yKGDojrflj5blrZDooajlrozmlbTot6/lvoTlh7rplJnvvIzmib7kuI3liLAke3N1YkRhdGF95a+55bqU55qE5a2Q6KGo77yM5oiW5a+55bqU5a2Q6KGo5rKh5pyJ5b2T5YmN6KGM44CCYCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHBhdGggKz0gYC8ke3N1YlBhdGh9LyR7c3ViRGF0YS5jdXJyZW50SWR9YDtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcGF0aCArPSAnLycgKyBzdWJQYXRoc1tzdWJQYXRocy5sZW5ndGggLSAxXTtcclxuXHJcbiAgICByZXR1cm4gcGF0aDtcclxuICB9XHJcbiAgcHJpdmF0ZSByZXNldEZvcm0oYWN0aW9uOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHZhbGlkYXRpb25TZXJ2aWNlID0gdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PFZhbGlkYXRpb25TZXJ2aWNlPihWYWxpZGF0aW9uU2VydmljZSwgbnVsbCk7XHJcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5jYW5jZWxDaGFuZ2VzKCkucGlwZShcclxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuY29tbWFuZFNlcnZpY2UuZXhlY3V0ZShhY3Rpb24pLnBpcGUoc3dpdGNoTWFwKCgpID0+IHtcclxuICAgICAgICByZXR1cm4gdmFsaWRhdGlvblNlcnZpY2UgJiYgdmFsaWRhdGlvblNlcnZpY2UucmVzZXRWYWxpZGF0aW9uKCkgfHwgb2YobnVsbCk7XHJcbiAgICAgIH0pKSkpO1xyXG4gIH1cclxuICBwcml2YXRlIHBhcnNlUGFyYW1zKG9wdGlvbnM6IGFueSk6IHsgYWN0aW9uOiBzdHJpbmcsIGlkOiBzdHJpbmcsIHN5bmM6IGJvb2xlYW4gfSB8IG51bGwge1xyXG4gICAgaWYgKG9wdGlvbnMgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9wdGlvbnMpID09PSBEYXRhVHlwZS5tYXApIHtcclxuICAgICAgbGV0IHBhcmFtcyA9IG9wdGlvbnMuZ2V0KFdFQl9GT1JNX1JPVVRFX1BBUkFNU19LRVkpO1xyXG4gICAgICBpZiAocGFyYW1zICYmIHR5cGVvZiBwYXJhbXMgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgcGFyYW1zID0gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtcyk7XHJcbiAgICAgICAgaWYgKHBhcmFtcy5zdGFydHNXaXRoKCd7JykgJiYgcGFyYW1zLmVuZHNXaXRoKCd9JykpIHtcclxuICAgICAgICAgIHBhcmFtcyA9IEpTT04ucGFyc2UocGFyYW1zKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIGFjdGlvbjogcGFyYW1zLmFjdGlvbixcclxuICAgICAgICAgIGlkOiBwYXJhbXMuaWRUb1ZpZXcgfHwgcGFyYW1zLmlkVG9FZGl0IHx8IHBhcmFtcy5pZCxcclxuICAgICAgICAgIHN5bmM6IHBhcmFtcy5zeW5jIHx8IGZhbHNlXHJcbiAgICAgICAgfTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG4gIHByaXZhdGUgc2hvd0xvYWRpbmdDb25maXJtKG1lc3NhZ2U6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIHRoaXMuZm9ybU1lc3NhZ2VTZXJ2aWNlLmNvbmZpcm0obWVzc2FnZSkucGlwZShcclxuICAgICAgc3dpdGNoTWFwKChyZXN1bHQ6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBpZiAocmVzdWx0ID09PSB0cnVlKSB7XHJcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxufVxyXG5leHBvcnQgeyBDYXJkRGF0YVNlcnZpY2UgfTtcclxuIl19