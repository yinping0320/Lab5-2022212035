import { Injectable } from '@angular/core';
import { of, EMPTY } from 'rxjs';
import { tap, switchMap, concatMap } from 'rxjs/operators';
import { FrameContext, } from '@farris/devkit';
import { FormLoadingService } from '../form-loading/form-loading.service';
import { FormNotifyService } from '../form-notify.service';
import { LanguageService } from '../languag.service';
import { FormMessageService } from '../form-message.service';
import { FormErrorService } from '../error/form-error.service';
import { CommandService } from '../command-service';
import { ListDataService } from './list-data.service';
import { TreeDataService } from './tree-data.service';
/**
 * 删除服务
 */
class RemoveDataService {
    /**
     * 构造函数
     * @param frameContext 组件上下文
     */
    constructor(frameContext) {
        this.frameContext = frameContext;
        this.notifyService = this.frameContext.injector.get(FormNotifyService, null);
        this.messageService = this.frameContext.injector.get(FormMessageService, null);
        this.errorService = this.frameContext.injector.get(FormErrorService, null);
        this.loadingService = this.frameContext.injector.get(FormLoadingService, null);
        this.languageService = this.frameContext.injector.get(LanguageService, null);
        this.commandService = this.frameContext.injector.get(CommandService, null);
        this.listDataService = this.frameContext.injector.get(ListDataService, null);
        this.treeDataService = this.frameContext.injector.get(TreeDataService, null);
        this.befRepository = this.frameContext.repository;
    }
    /**
     * 删除id对应的实体
     * @param id 要删除的数据id
     * @param ifSave 是否保存
     * @param enableRemoveAndSave 是否启用删除并保存（仅为兼容，新调用请勿设置）
     * @summary
     * enableRemoveAndSave存在的意义：
     * 1、老表单的可能没有delAndSave方法；
     * 2、为了将ListDataService中的remove方法迁移到此方法上，显示设置为false，保持和以前行为一致；
     * 3、该参数默认为true，并且在WebComponent层不暴露，新命令不需要传递，默认为true；
     */
    removeById(id, ifSave, enableRemoveAndSave = true, successMsg) {
        const msg = successMsg ? successMsg : '';
        return this.innerRemoveById(id, ifSave, enableRemoveAndSave, msg);
    }
    removeByIds(ids) {
        throw new Error('Not Implemented');
    }
    /**
     * 删除id对应的实体，并执行保存
     */
    removeAndSaveById(id, successMsg) {
        const msg = successMsg ? successMsg : '';
        return this.innerRemoveById(id, true, true, msg);
    }
    /**
     * 删除并保存树节点数据
     */
    removeAndSaveByIdForTree(id, successMsg) {
        const msg = successMsg ? successMsg : '';
        // 检查要删除的id是否存在
        if (this.checkIdsToRemove([id]) === false) {
            this.notifyService.warning(this.languageService.plsSelectDeleteData, { hideTitle: true });
            return EMPTY;
        }
        // 检查是否有子节点
        const treeNodesData = this.befRepository.entityCollection.toJSON();
        if (this.treeDataService.hasChildNodes(id, treeNodesData) === true) {
            this.messageService.warning(this.languageService.deleteChildFirst);
            return EMPTY;
        }
        // 执行删除
        const remove$ = this.innerRemoveById(id, true, true, msg);
        const nextNodeId = this.treeDataService.getNextNodeIdAfterRemoving(id, treeNodesData);
        ;
        const result$ = remove$.pipe(tap(() => {
            this.treeDataService.setNextNodeAfterRemoving(nextNodeId);
        }));
        return result$;
    }
    /**
     * 批量删除并保存
     */
    removeAndSaveByIds() {
        throw new Error('Not Implemented');
    }
    /**
     * 删除后的刷新
     */
    refreshAfterRemoving(loadCmdName, loadCmdFrameId) {
        if (!this.frameContext || !loadCmdName || !loadCmdFrameId) {
            return;
        }
        const commandService = this.frameContext.injector.get(CommandService, null);
        return commandService.execute(loadCmdName, loadCmdFrameId);
    }
    /**
     * 删除id对应的实体
     * @param id 实体id
     * @param ifSave 是否保存
     * @param enableRemoveAndSave 是否启用删除并保存（老EAPI上没有此方法，通过开关进行兼容）
     * @summary
     * enableRemoveAndSave参数说明：
     * 1、老EAPI上没有delAndSave方法，只能发两次请求（删除和保存）；
     * 2、此开关用于选择使用哪种方式，兼容老表单。
     */
    innerRemoveById(id, ifSave, enableRemoveAndSave, successMsg) {
        // 检查要删除的id是否存在
        if (this.checkIdsToRemove([id]) === false) {
            this.notifyService.warning(this.languageService.plsSelectDeleteData, { hideTitle: true });
            return EMPTY;
        }
        const confirm$ = this.confirmToRemove();
        const remove$ = enableRemoveAndSave && ifSave ?
            this.befRepository.removeEntityAndSaveById(id) :
            this.befRepository.removeById(id, ifSave);
        const result$ = confirm$.pipe(concatMap((ifRemove) => {
            if (ifRemove === false) {
                return EMPTY;
            }
            const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
            return remove$.pipe(tap(() => {
                this.loadingService.hideDelayLoading(loadingTimerId);
                if (successMsg && successMsg.trim()) {
                    let showMessage = true;
                    if (successMsg.startsWith('{') && successMsg.endsWith('}')) {
                        try {
                            const options = JSON.parse(successMsg);
                            if (options.showMessage === false) {
                                showMessage = false;
                            }
                        }
                        catch (_a) { }
                    }
                    if (showMessage !== false) {
                        this.notifyService.success(successMsg, { hideTitle: true });
                    }
                }
                else {
                    this.notifyService.success(this.languageService.deleteSuccess, { hideTitle: true });
                }
                // this.notifyService.success(this.languageService.deleteSuccess, { hideTitle: true });
            }, (error) => {
                this.loadingService.hideDelayLoading(loadingTimerId);
                this.errorService.exception(this.languageService.deleteFailed, error);
            }), switchMap(() => {
                const saved = enableRemoveAndSave && ifSave;
                if (!saved) {
                    return EMPTY;
                }
                else {
                    return of(null);
                }
            }));
        }));
        return result$;
    }
    /**
     * 检查要删除的ids是否为空
     */
    checkIdsToRemove(ids) {
        if (!ids) {
            return false;
        }
        const filteredIds = ids.filter((id) => {
            return !!id;
        });
        if (filteredIds.length === 0) {
            return false;
        }
        return true;
    }
    /**
     * 确认删除
     */
    confirmToRemove() {
        const confirm$ = this.messageService.question(this.languageService.confirmDeletion);
        const result$ = confirm$.pipe(concatMap((ifRemove) => {
            if (ifRemove === false) {
                return EMPTY;
            }
            else {
                return of(true);
            }
        }));
        return result$;
    }
}
RemoveDataService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
RemoveDataService.ctorParameters = () => [
    { type: FrameContext }
];
export { RemoveDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVtb3ZlLWRhdGEuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9kYXRhLXNlcnZpY2VzL3JlbW92ZS1kYXRhLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWMsRUFBRSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM3QyxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzRCxPQUFPLEVBQUUsWUFBWSxHQUFXLE1BQU0sZ0JBQWdCLENBQUM7QUFFdkQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDMUUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzdELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRXREOztHQUVHO0FBQ0gsTUFDTSxpQkFBaUI7SUFvQnJCOzs7T0FHRztJQUNILFlBQW9CLFlBQTBCO1FBQTFCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzVDLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFvQixpQkFBaUIsRUFBRSxJQUFJLENBQUMsQ0FBQztR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QUUsQ0FBQztRQUNkLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxXQUFXLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUM1QixPQUFPLEtBQUssQ0FBQztTQUNkO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxlQUFlO1FBQ3JCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDcEYsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FDM0IsU0FBUyxDQUFDLENBQUMsUUFBaUIsRUFBRSxFQUFFO1lBQzlCLElBQUksUUFBUSxLQUFLLEtBQUssRUFBRTtnQkFDdEIsT0FBTyxLQUFLLENBQUM7YUFDZDtpQkFBTTtnQkFDTCxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNqQjtRQUNILENBQUMsQ0FDQSxDQUFDLENBQUM7UUFDTCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDOzs7WUExTkYsVUFBVTs7OztZQWRGLFlBQVk7O0FBMk9yQixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIEVNUFRZIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHRhcCwgc3dpdGNoTWFwLCBjb25jYXRNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEZyYW1lQ29udGV4dCwgRW50aXR5LCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSwgfSBmcm9tICdAZmFycmlzL2JlZic7XHJcbmltcG9ydCB7IEZvcm1Mb2FkaW5nU2VydmljZSB9IGZyb20gJy4uL2Zvcm0tbG9hZGluZy9mb3JtLWxvYWRpbmcuc2VydmljZSc7XHJcbmltcG9ydCB7IEZvcm1Ob3RpZnlTZXJ2aWNlIH0gZnJvbSAnLi4vZm9ybS1ub3RpZnkuc2VydmljZSc7XHJcbmltcG9ydCB7IExhbmd1YWdlU2VydmljZSB9IGZyb20gJy4uL2xhbmd1YWcuc2VydmljZSc7XHJcbmltcG9ydCB7IEZvcm1NZXNzYWdlU2VydmljZSB9IGZyb20gJy4uL2Zvcm0tbWVzc2FnZS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRm9ybUVycm9yU2VydmljZSB9IGZyb20gJy4uL2Vycm9yL2Zvcm0tZXJyb3Iuc2VydmljZSc7XHJcbmltcG9ydCB7IENvbW1hbmRTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbWFuZC1zZXJ2aWNlJztcclxuaW1wb3J0IHsgTGlzdERhdGFTZXJ2aWNlIH0gZnJvbSAnLi9saXN0LWRhdGEuc2VydmljZSc7XHJcbmltcG9ydCB7IFRyZWVEYXRhU2VydmljZSB9IGZyb20gJy4vdHJlZS1kYXRhLnNlcnZpY2UnO1xyXG5cclxuLyoqXHJcbiAqIOWIoOmZpOacjeWKoVxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5jbGFzcyBSZW1vdmVEYXRhU2VydmljZSB7XHJcblxyXG4gIHByaXZhdGUgbm90aWZ5U2VydmljZTogRm9ybU5vdGlmeVNlcnZpY2U7XHJcblxyXG4gIHByaXZhdGUgbWVzc2FnZVNlcnZpY2U6IEZvcm1NZXNzYWdlU2VydmljZTtcclxuXHJcbiAgcHJpdmF0ZSBsb2FkaW5nU2VydmljZTogRm9ybUxvYWRpbmdTZXJ2aWNlO1xyXG5cclxuICBwcml2YXRlIGVycm9yU2VydmljZTogRm9ybUVycm9yU2VydmljZTtcclxuXHJcbiAgcHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IExhbmd1YWdlU2VydmljZTtcclxuXHJcbiAgcHJpdmF0ZSBiZWZSZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PGFueT47XHJcblxyXG4gIHByaXZhdGUgY29tbWFuZFNlcnZpY2U6IENvbW1hbmRTZXJ2aWNlO1xyXG5cclxuICBwcml2YXRlIGxpc3REYXRhU2VydmljZTogTGlzdERhdGFTZXJ2aWNlO1xyXG5cclxuICBwcml2YXRlIHRyZWVEYXRhU2VydmljZTogVHJlZURhdGFTZXJ2aWNlO1xyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKiBAcGFyYW0gZnJhbWVDb250ZXh0IOe7hOS7tuS4iuS4i+aWh1xyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpIHtcclxuICAgIHRoaXMubm90aWZ5U2VydmljZSA9IHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxGb3JtTm90aWZ5U2VydmljZT4oRm9ybU5vdGlmeVNlcnZpY2UsIG51bGwpO1xyXG4gICAgdGhpcy5tZXNzYWdlU2VydmljZSA9IHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxGb3JtTWVzc2FnZVNlcnZpY2U+KEZvcm1NZXNzYWdlU2VydmljZSwgbnVsbCk7XHJcbiAgICB0aGlzLmVycm9yU2VydmljZSA9IHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxGb3JtRXJyb3JTZXJ2aWNlPihGb3JtRXJyb3JTZXJ2aWNlLCBudWxsKTtcclxuICAgIHRoaXMubG9hZGluZ1NlcnZpY2UgPSB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8Rm9ybUxvYWRpbmdTZXJ2aWNlPihGb3JtTG9hZGluZ1NlcnZpY2UsIG51bGwpO1xyXG5cclxuICAgIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlID0gdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PExhbmd1YWdlU2VydmljZT4oTGFuZ3VhZ2VTZXJ2aWNlLCBudWxsKTtcclxuICAgIHRoaXMuY29tbWFuZFNlcnZpY2UgPSB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8Q29tbWFuZFNlcnZpY2U+KENvbW1hbmRTZXJ2aWNlLCBudWxsKTtcclxuICAgIHRoaXMubGlzdERhdGFTZXJ2aWNlID0gdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PExpc3REYXRhU2VydmljZT4oTGlzdERhdGFTZXJ2aWNlLCBudWxsKTtcclxuICAgIHRoaXMudHJlZURhdGFTZXJ2aWNlID0gdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PFRyZWVEYXRhU2VydmljZT4oVHJlZURhdGFTZXJ2aWNlLCBudWxsKTtcclxuICAgIHRoaXMuYmVmUmVwb3NpdG9yeSA9IHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxFbnRpdHk+O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yig6ZmkaWTlr7nlupTnmoTlrp7kvZNcclxuICAgKiBAcGFyYW0gaWQg6KaB5Yig6Zmk55qE5pWw5o2uaWRcclxuICAgKiBAcGFyYW0gaWZTYXZlIOaYr+WQpuS/neWtmFxyXG4gICAqIEBwYXJhbSBlbmFibGVSZW1vdmVBbmRTYXZlIOaYr+WQpuWQr+eUqOWIoOmZpOW5tuS/neWtmO+8iOS7heS4uuWFvOWuue+8jOaWsOiwg+eUqOivt+WLv+iuvue9ru+8iVxyXG4gICAqIEBzdW1tYXJ5XHJcbiAgICogZW5hYmxlUmVtb3ZlQW5kU2F2ZeWtmOWcqOeahOaEj+S5ie+8mlxyXG4gICAqIDHjgIHogIHooajljZXnmoTlj6/og73msqHmnIlkZWxBbmRTYXZl5pa55rOV77ybXHJcbiAgICogMuOAgeS4uuS6huWwhkxpc3REYXRhU2VydmljZeS4reeahHJlbW92ZeaWueazlei/geenu+WIsOatpOaWueazleS4iu+8jOaYvuekuuiuvue9ruS4umZhbHNl77yM5L+d5oyB5ZKM5Lul5YmN6KGM5Li65LiA6Ie077ybXHJcbiAgICogM+OAgeivpeWPguaVsOm7mOiupOS4unRydWXvvIzlubbkuJTlnKhXZWJDb21wb25lbnTlsYLkuI3mmrTpnLLvvIzmlrDlkb3ku6TkuI3pnIDopoHkvKDpgJLvvIzpu5jorqTkuLp0cnVl77ybXHJcbiAgICovXHJcbiAgcHVibGljIHJlbW92ZUJ5SWQoaWQ6IHN0cmluZywgaWZTYXZlOiBib29sZWFuLCBlbmFibGVSZW1vdmVBbmRTYXZlOiBib29sZWFuID0gdHJ1ZSwgc3VjY2Vzc01zZz86IHN0cmluZyk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgY29uc3QgbXNnID0gc3VjY2Vzc01zZyA/IHN1Y2Nlc3NNc2cgOiAnJztcclxuICAgIHJldHVybiB0aGlzLmlubmVyUmVtb3ZlQnlJZChpZCwgaWZTYXZlLCBlbmFibGVSZW1vdmVBbmRTYXZlLCBtc2cpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlbW92ZUJ5SWRzKGlkczogc3RyaW5nW10pOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTm90IEltcGxlbWVudGVkJyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliKDpmaRpZOWvueW6lOeahOWunuS9k++8jOW5tuaJp+ihjOS/neWtmFxyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmVBbmRTYXZlQnlJZChpZDogc3RyaW5nLCBzdWNjZXNzTXNnPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICBjb25zdCBtc2cgPSBzdWNjZXNzTXNnID8gc3VjY2Vzc01zZyA6ICcnO1xyXG4gICAgcmV0dXJuIHRoaXMuaW5uZXJSZW1vdmVCeUlkKGlkLCB0cnVlLCB0cnVlLCBtc2cpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yig6Zmk5bm25L+d5a2Y5qCR6IqC54K55pWw5o2uXHJcbiAgICovXHJcbiAgcHVibGljIHJlbW92ZUFuZFNhdmVCeUlkRm9yVHJlZShpZDogc3RyaW5nLCBzdWNjZXNzTXNnPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICBjb25zdCBtc2cgPSBzdWNjZXNzTXNnID8gc3VjY2Vzc01zZyA6ICcnO1xyXG4gICAgLy8g5qOA5p+l6KaB5Yig6Zmk55qEaWTmmK/lkKblrZjlnKhcclxuICAgIGlmICh0aGlzLmNoZWNrSWRzVG9SZW1vdmUoW2lkXSkgPT09IGZhbHNlKSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnBsc1NlbGVjdERlbGV0ZURhdGEsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5qOA5p+l5piv5ZCm5pyJ5a2Q6IqC54K5XHJcbiAgICBjb25zdCB0cmVlTm9kZXNEYXRhID0gdGhpcy5iZWZSZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24udG9KU09OKCk7XHJcbiAgICBpZiAodGhpcy50cmVlRGF0YVNlcnZpY2UuaGFzQ2hpbGROb2RlcyhpZCwgdHJlZU5vZGVzRGF0YSkgPT09IHRydWUpIHtcclxuICAgICAgdGhpcy5tZXNzYWdlU2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmRlbGV0ZUNoaWxkRmlyc3QpO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5omn6KGM5Yig6ZmkXHJcbiAgICBjb25zdCByZW1vdmUkID0gdGhpcy5pbm5lclJlbW92ZUJ5SWQoaWQsIHRydWUsIHRydWUsIG1zZyk7XHJcbiAgICBjb25zdCBuZXh0Tm9kZUlkID0gdGhpcy50cmVlRGF0YVNlcnZpY2UuZ2V0TmV4dE5vZGVJZEFmdGVyUmVtb3ZpbmcoaWQsIHRyZWVOb2Rlc0RhdGEpOztcclxuICAgIGNvbnN0IHJlc3VsdCQgPSByZW1vdmUkLnBpcGUoXHJcbiAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy50cmVlRGF0YVNlcnZpY2Uuc2V0TmV4dE5vZGVBZnRlclJlbW92aW5nKG5leHROb2RlSWQpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICByZXR1cm4gcmVzdWx0JDtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiDmibnph4/liKDpmaTlubbkv53lrZhcclxuICAgKi9cclxuICBwdWJsaWMgcmVtb3ZlQW5kU2F2ZUJ5SWRzKCkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgSW1wbGVtZW50ZWQnKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIoOmZpOWQjueahOWIt+aWsFxyXG4gICAqL1xyXG4gIHB1YmxpYyByZWZyZXNoQWZ0ZXJSZW1vdmluZyhsb2FkQ21kTmFtZTogc3RyaW5nLCBsb2FkQ21kRnJhbWVJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmICghdGhpcy5mcmFtZUNvbnRleHQgfHwgIWxvYWRDbWROYW1lIHx8ICFsb2FkQ21kRnJhbWVJZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBjb21tYW5kU2VydmljZSA9IHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxDb21tYW5kU2VydmljZT4oQ29tbWFuZFNlcnZpY2UsIG51bGwpO1xyXG4gICAgcmV0dXJuIGNvbW1hbmRTZXJ2aWNlLmV4ZWN1dGUobG9hZENtZE5hbWUsIGxvYWRDbWRGcmFtZUlkKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIoOmZpGlk5a+55bqU55qE5a6e5L2TXHJcbiAgICogQHBhcmFtIGlkIOWunuS9k2lkXHJcbiAgICogQHBhcmFtIGlmU2F2ZSDmmK/lkKbkv53lrZhcclxuICAgKiBAcGFyYW0gZW5hYmxlUmVtb3ZlQW5kU2F2ZSDmmK/lkKblkK/nlKjliKDpmaTlubbkv53lrZjvvIjogIFFQVBJ5LiK5rKh5pyJ5q2k5pa55rOV77yM6YCa6L+H5byA5YWz6L+b6KGM5YW85a6577yJXHJcbiAgICogQHN1bW1hcnlcclxuICAgKiBlbmFibGVSZW1vdmVBbmRTYXZl5Y+C5pWw6K+05piO77yaXHJcbiAgICogMeOAgeiAgUVBUEnkuIrmsqHmnIlkZWxBbmRTYXZl5pa55rOV77yM5Y+q6IO95Y+R5Lik5qyh6K+35rGC77yI5Yig6Zmk5ZKM5L+d5a2Y77yJ77ybXHJcbiAgICogMuOAgeatpOW8gOWFs+eUqOS6jumAieaLqeS9v+eUqOWTquenjeaWueW8j++8jOWFvOWuueiAgeihqOWNleOAglxyXG4gICAqL1xyXG4gIHByaXZhdGUgaW5uZXJSZW1vdmVCeUlkKGlkOiBzdHJpbmcsIGlmU2F2ZTogYm9vbGVhbiwgZW5hYmxlUmVtb3ZlQW5kU2F2ZTogYm9vbGVhbiwgc3VjY2Vzc01zZzogc3RyaW5nKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcblxyXG4gICAgLy8g5qOA5p+l6KaB5Yig6Zmk55qEaWTmmK/lkKblrZjlnKhcclxuICAgIGlmICh0aGlzLmNoZWNrSWRzVG9SZW1vdmUoW2lkXSkgPT09IGZhbHNlKSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnBsc1NlbGVjdERlbGV0ZURhdGEsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY29uZmlybSQgPSB0aGlzLmNvbmZpcm1Ub1JlbW92ZSgpO1xyXG4gICAgY29uc3QgcmVtb3ZlJCA9IGVuYWJsZVJlbW92ZUFuZFNhdmUgJiYgaWZTYXZlID9cclxuICAgICAgdGhpcy5iZWZSZXBvc2l0b3J5LnJlbW92ZUVudGl0eUFuZFNhdmVCeUlkKGlkKSA6XHJcbiAgICAgIHRoaXMuYmVmUmVwb3NpdG9yeS5yZW1vdmVCeUlkKGlkLCBpZlNhdmUpO1xyXG5cclxuICAgIGNvbnN0IHJlc3VsdCQgPSBjb25maXJtJC5waXBlKFxyXG4gICAgICBjb25jYXRNYXAoKGlmUmVtb3ZlOiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgaWYgKGlmUmVtb3ZlID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBsb2FkaW5nVGltZXJJZCA9IHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvd0xvYWRpbmdXaXRoRGVsYXkoNTAwKTtcclxuICAgICAgICByZXR1cm4gcmVtb3ZlJC5waXBlKFxyXG4gICAgICAgICAgdGFwKFxyXG4gICAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcclxuICAgICAgICAgICAgICBpZiAoc3VjY2Vzc01zZyAmJiBzdWNjZXNzTXNnLnRyaW0oKSkge1xyXG4gICAgICAgICAgICAgICAgbGV0IHNob3dNZXNzYWdlOiBib29sZWFuID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIGlmIChzdWNjZXNzTXNnLnN0YXJ0c1dpdGgoJ3snKSAmJiBzdWNjZXNzTXNnLmVuZHNXaXRoKCd9JykpIHtcclxuICAgICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBvcHRpb25zID0gSlNPTi5wYXJzZShzdWNjZXNzTXNnKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5zaG93TWVzc2FnZSA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgIHNob3dNZXNzYWdlID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICB9IGNhdGNoIHsgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHNob3dNZXNzYWdlICE9PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uuc3VjY2VzcyhzdWNjZXNzTXNnLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLnN1Y2Nlc3ModGhpcy5sYW5ndWFnZVNlcnZpY2UuZGVsZXRlU3VjY2VzcywgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIC8vIHRoaXMubm90aWZ5U2VydmljZS5zdWNjZXNzKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmRlbGV0ZVN1Y2Nlc3MsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XHJcbiAgICAgICAgICAgICAgdGhpcy5lcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmRlbGV0ZUZhaWxlZCwgZXJyb3IpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICApLFxyXG4gICAgICAgICAgc3dpdGNoTWFwKCgpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgc2F2ZWQgPSBlbmFibGVSZW1vdmVBbmRTYXZlICYmIGlmU2F2ZTtcclxuICAgICAgICAgICAgaWYgKCFzYXZlZCkge1xyXG4gICAgICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICByZXR1cm4gb2YobnVsbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcblxyXG4gICAgcmV0dXJuIHJlc3VsdCQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmo4Dmn6XopoHliKDpmaTnmoRpZHPmmK/lkKbkuLrnqbpcclxuICAgKi9cclxuICBwcml2YXRlIGNoZWNrSWRzVG9SZW1vdmUoaWRzOiBzdHJpbmdbXSk6IGJvb2xlYW4ge1xyXG4gICAgaWYgKCFpZHMpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZmlsdGVyZWRJZHMgPSBpZHMuZmlsdGVyKChpZDogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHJldHVybiAhIWlkO1xyXG4gICAgfSk7XHJcbiAgICBpZiAoZmlsdGVyZWRJZHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOehruiupOWIoOmZpFxyXG4gICAqL1xyXG4gIHByaXZhdGUgY29uZmlybVRvUmVtb3ZlKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgY29uc3QgY29uZmlybSQgPSB0aGlzLm1lc3NhZ2VTZXJ2aWNlLnF1ZXN0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNvbmZpcm1EZWxldGlvbik7XHJcbiAgICBjb25zdCByZXN1bHQkID0gY29uZmlybSQucGlwZShcclxuICAgICAgY29uY2F0TWFwKChpZlJlbW92ZTogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgIGlmIChpZlJlbW92ZSA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICApKTtcclxuICAgIHJldHVybiByZXN1bHQkO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgUmVtb3ZlRGF0YVNlcnZpY2UgfTtcclxuXHJcblxyXG4iXX0=