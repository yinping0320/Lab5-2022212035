/**
 * 树数据的帮助类
 */
class PathTreeNodeUtil {
    /**
     * 选中第一个根节点
     */
    selectFirstRootNode(bindingData, hierarchyInfoKey) {
        const treeNodesData = bindingData.list.toJSON();
        const firstRootNodeId = this.getFirstNodeId(treeNodesData, hierarchyInfoKey);
        this.selectedNode(bindingData, hierarchyInfoKey, firstRootNodeId);
        return firstRootNodeId;
    }
    selectNodeByBindingList(bindingList, hierarchyInfoKey, selectedNodeId) {
        const treeNodesData = bindingList.toJSON();
        // 如果要设置的节点不存在，则设置第1个根节点
        const selectedNodeData = this.getNodeDataById(treeNodesData, selectedNodeId);
        let currentId = selectedNodeId;
        if (!selectedNodeData) {
            currentId = this.getFirstNodeId(treeNodesData, hierarchyInfoKey);
        }
        setTimeout(() => {
            bindingList.setCurrentId(currentId, true, true);
        }, 0);
    }
    /**
     * 选中节点
     */
    selectedNode(bindingData, hierarchyInfoKey, selectedNodeId) {
        const treeNodesData = bindingData.list.toJSON();
        // 如果要设置的节点不存在，则设置第1个根节点
        const selectedNodeData = this.getNodeDataById(treeNodesData, selectedNodeId);
        let currentId = selectedNodeId;
        if (!selectedNodeData) {
            currentId = this.getFirstNodeId(treeNodesData, hierarchyInfoKey);
        }
        if (bindingData.rowSelectedEventSuspend === true) {
            return;
        }
        setTimeout(() => {
            bindingData.list.currentId = null;
            bindingData.list.setCurrentId(currentId, true, true);
        }, 0);
    }
    /**
     * 检查是否有子节点
     */
    hasChildNodes(treeNodesData, hierarchyInfoKey, fid) {
        const fNodeData = this.getNodeDataById(treeNodesData, fid);
        // const fLayer = fNodeData[hierarchyInfoKey]['layer'];
        // const fPath  = fNodeData[hierarchyInfoKey]['path'];
        const fIsDetail = fNodeData[hierarchyInfoKey]['isDetail'];
        // 非明细节点，返回true
        if (fIsDetail === false) {
            return true;
        }
        return false;
        // const childNodesData = this.getChildNodesData(treeNodesData, hierarchyInfoKey, fLayer, fPath);
        // return childNodesData.length > 0;
    }
    /**
     * 获取根节点（多个根节点时获取第一个）
     * @return 找不到时返回null
     */
    getFirstNodeId(treeNodesData, hierarchyInfoKey) {
        let rootData = treeNodesData.find((itemData) => {
            const layer = itemData[hierarchyInfoKey]['layer'];
            return layer === 1;
        });
        if (!rootData) {
            const rootLayer = this.getRootLayer(treeNodesData, hierarchyInfoKey);
            rootData = treeNodesData.find((itemData) => {
                const layer = itemData[hierarchyInfoKey]['layer'];
                return layer === rootLayer;
            });
        }
        return rootData ? rootData['id'] : '';
    }
    getRootLayer(treeNodesData, hierarchyInfoKey) {
        let layer = null;
        if (treeNodesData && Array.isArray(treeNodesData)) {
            const layers = treeNodesData.map(item => {
                const layer = item[hierarchyInfoKey]['layer'];
                return layer;
            });
            const minLayer = Math.min.apply(Math, layers);
            if (!isNaN(minLayer)) {
                layer = minLayer;
            }
        }
        return layer;
    }
    /**
     * 获取下一个节点（删除后）
     */
    getNextNodeId(treeNodesData, hierarchyInfoKey, currentId) {
        // 当前节点信息
        const currentNodeData = treeNodesData.find((itemData) => {
            return itemData['id'] === currentId;
        });
        const currentPath = currentNodeData[hierarchyInfoKey]['path'];
        const currentLayer = currentNodeData[hierarchyInfoKey]['layer'];
        // 父节点信息
        const fLayer = currentLayer - 1;
        const fPath = currentPath.substring(0, currentPath.length - 4);
        // 查找兄弟节点
        const siblingtreeNodesData = this.getChildNodesData(treeNodesData, hierarchyInfoKey, fLayer, fPath);
        // 如果没有兄弟节点，向上查找
        if (siblingtreeNodesData.length === 1) {
            const parentData = treeNodesData.find((itemData) => {
                return itemData[hierarchyInfoKey]['path'] === fPath;
            });
            // 存在父节点，则设置父节点；
            // 不存在父节点，则设置第一个根节点。
            if (!parentData) {
                return this.getFirstNodeId(treeNodesData, hierarchyInfoKey);
            }
            return parentData['id'];
        }
        else {
            return this.getNextSiblingNodeId(siblingtreeNodesData, currentId);
        }
    }
    /**
     * 获取下个兄弟节点的id
     */
    getNextSiblingNodeId(siblingtreeNodesData, currentId) {
        if (siblingtreeNodesData.length <= 1) {
            return '';
        }
        const currentIndex = siblingtreeNodesData.findIndex((itemData) => {
            return itemData['id'] === currentId;
        });
        // 最后一行上移一行，其他下移一行
        let nextIndex = -1;
        if (currentIndex === siblingtreeNodesData.length - 1) {
            nextIndex = currentIndex - 1;
        }
        else {
            nextIndex = currentIndex + 1;
        }
        return siblingtreeNodesData[nextIndex]['id'];
    }
    /**
     * 获取下级节点的BindingObjects集合
     */
    getChildNodesData(treeNodesData, hierarchyInfoKey, fLayer, fPath) {
        const childtreeNodesData = treeNodesData.filter((itemData) => {
            const layer = itemData[hierarchyInfoKey]['layer'];
            const path = itemData[hierarchyInfoKey]['path'];
            return (layer === fLayer + 1) && path.startsWith(fPath);
        });
        return childtreeNodesData;
    }
    /**
     * 获取id获取节点数据
     */
    getNodeDataById(treeNodesData, id) {
        const nodeData = treeNodesData.find((itemData) => {
            return itemData['id'] === id;
        });
        return nodeData ? nodeData : null;
    }
}
export { PathTreeNodeUtil };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0aC10cmVlLnV0aWwuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZGF0YS1zZXJ2aWNlcy90cmVlLXRhYmxlL3V0aWwvcGF0aC10cmVlLnV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUE7O0dBRUc7QUFDSCxNQUFNLGdCQUFnQjtJQUVwQjs7T0FFRztJQUNJLG1CQUFtQixDQUFDLFdBQXdCLEVBQUUsZ0JBQXdCO1FBRTNFLE1BQU0sYUFBYSxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDaEQsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztRQUM3RSxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUNsRSxPQUFPLGVBQWUsQ0FBQztJQUN6QixDQUFDO0lBQ00sdUJBQXVCLENBQUMsV0FBd0IsRUFBRSxnQkFBd0IsRUFBRSxjQUFzQjtRQUN2RyxNQUFNLGFBQWEsR0FBRyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDM0Msd0JBQXdCO1FBQ3hCLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxhQUFhLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFDN0UsSUFBSSxTQUFTLEdBQUcsY0FBYyxDQUFDO1FBQy9CLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtZQUNyQixTQUFTLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztTQUNsRTtRQUVELFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDZCxXQUFXLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbEQsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ1IsQ0FBQztJQUNEOztPQUVHO0lBQ0ksWUFBWSxDQUFDLFdBQXdCLEVBQUUsZ0JBQXdCLEVBQUUsY0FBc0I7UUFDNUYsTUFBTSxhQUFhLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNoRCx3QkFBd0I7UUFDeEIsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLGFBQWEsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUM3RSxJQUFJLFNBQVMsR0FBRyxjQUFjLENBQUM7UUFDL0IsSUFBSSxDQUFDLGdCQUFnQixFQUFFO1lBQ3JCLFNBQVMsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1NBQ2xFO1FBQ0QsSUFBSSxXQUFXLENBQUMsdUJBQXVCLEtBQUssSUFBSSxFQUFFO1lBQ2hELE9BQU87U0FDUjtRQUNELFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDZCxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7WUFDbEMsV0FBVyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN2RCxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDUixDQUFDO0lBRUQ7O09BRUc7SUFDSSxhQUFhLENBQUMsYUFBb0IsRUFBRSxnQkFBd0IsRUFBRSxHQUFXO1FBQzlFLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzNELHVEQUF1RDtRQUN2RCxzREFBc0Q7UUFDdEQsTUFBTSxTQUFTLEdBQUcsU0FBUyxDQUFDLGdCQUFnQixDQUFDLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFMUQsZUFBZTtRQUNmLElBQUksU0FBUyxLQUFLLEtBQUssRUFBRTtZQUN2QixPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsT0FBTyxLQUFLLENBQUM7UUFDYixpR0FBaUc7UUFDakcsb0NBQW9DO0lBQ3RDLENBQUM7SUFFRDs7O09BR0c7SUFDSyxjQUFjLENBQUMsYUFBb0IsRUFBRSxnQkFBd0I7UUFDbkUsSUFBSSxRQUFRLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQWEsRUFBRSxFQUFFO1lBQ2xELE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2xELE9BQU8sS0FBSyxLQUFLLENBQUMsQ0FBQztRQUNyQixDQUFDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDYixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3JFLFFBQVEsR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBYSxFQUFFLEVBQUU7Z0JBQzlDLE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNsRCxPQUFPLEtBQUssS0FBSyxTQUFTLENBQUM7WUFDN0IsQ0FBQyxDQUFDLENBQUM7U0FDSjtRQUNELE9BQU8sUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUN4QyxDQUFDO0lBQ08sWUFBWSxDQUFDLGFBQW9CLEVBQUUsZ0JBQXdCO1FBQ2pFLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLGFBQWEsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxFQUFFO1lBQ2pELE1BQU0sTUFBTSxHQUFHLGFBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQ3RDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUM5QyxPQUFPLEtBQUssQ0FBQztZQUNmLENBQUMsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQzlDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUU7Z0JBQ3BCLEtBQUssR0FBRyxRQUFRLENBQUM7YUFDbEI7U0FDRjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUNEOztPQUVHO0lBQ0ksYUFBYSxDQUFDLGFBQW9CLEVBQUUsZ0JBQXdCLEVBQUUsU0FBaUI7UUFFcEYsU0FBUztRQUNULE1BQU0sZUFBZSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFhLEVBQUUsRUFBRTtZQUMzRCxPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxTQUFTLENBQUM7UUFDdEMsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLFdBQVcsR0FBRyxlQUFlLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM5RCxNQUFNLFlBQVksR0FBRyxlQUFlLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUVoRSxRQUFRO1FBQ1IsTUFBTSxNQUFNLEdBQUcsWUFBWSxHQUFHLENBQUMsQ0FBQztRQUNoQyxNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRS9ELFNBQVM7UUFDVCxNQUFNLG9CQUFvQixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXBHLGdCQUFnQjtRQUNoQixJQUFJLG9CQUFvQixDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDckMsTUFBTSxVQUFVLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQWEsRUFBRSxFQUFFO2dCQUN0RCxPQUFPLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEtBQUssQ0FBQztZQUN0RCxDQUFDLENBQUMsQ0FBQztZQUVILGdCQUFnQjtZQUNoQixvQkFBb0I7WUFDcEIsSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDZixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxFQUFFLGdCQUFnQixDQUFDLENBQUM7YUFDN0Q7WUFDRCxPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN6QjthQUFNO1lBQ0wsT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUMsb0JBQW9CLEVBQUUsU0FBUyxDQUFDLENBQUM7U0FDbkU7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSSxvQkFBb0IsQ0FBQyxvQkFBMkIsRUFBRSxTQUFpQjtRQUN4RSxJQUFJLG9CQUFvQixDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUU7WUFDcEMsT0FBTyxFQUFFLENBQUM7U0FDWDtRQUVELE1BQU0sWUFBWSxHQUFHLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQWEsRUFBRSxFQUFFO1lBQ3BFLE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLFNBQVMsQ0FBQztRQUN0QyxDQUFDLENBQUMsQ0FBQztRQUVILGtCQUFrQjtRQUNsQixJQUFJLFNBQVMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNuQixJQUFJLFlBQVksS0FBSyxvQkFBb0IsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3BELFNBQVMsR0FBRyxZQUFZLEdBQUcsQ0FBQyxDQUFDO1NBQzlCO2FBQU07WUFDTCxTQUFTLEdBQUcsWUFBWSxHQUFHLENBQUMsQ0FBQztTQUM5QjtRQUVELE9BQU8sb0JBQW9CLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVEOztPQUVHO0lBQ0ksaUJBQWlCLENBQUMsYUFBb0IsRUFBRSxnQkFBd0IsRUFBRSxNQUFjLEVBQUUsS0FBYTtRQUNwRyxNQUFNLGtCQUFrQixHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtZQUMzRCxNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNsRCxNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNoRCxPQUFPLENBQUMsS0FBSyxLQUFLLE1BQU0sR0FBRyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzFELENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxrQkFBa0IsQ0FBQztJQUM1QixDQUFDO0lBRUQ7O09BRUc7SUFDSSxlQUFlLENBQUMsYUFBb0IsRUFBRSxFQUFVO1FBQ3JELE1BQU0sUUFBUSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFhLEVBQUUsRUFBRTtZQUNwRCxPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDcEMsQ0FBQztDQUNGO0FBRUQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCaW5kaW5nRGF0YSwgQmluZGluZ0xpc3QgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcblxyXG4vKipcclxuICog5qCR5pWw5o2u55qE5biu5Yqp57G7XHJcbiAqL1xyXG5jbGFzcyBQYXRoVHJlZU5vZGVVdGlsIHtcclxuXHJcbiAgLyoqXHJcbiAgICog6YCJ5Lit56ys5LiA5Liq5qC56IqC54K5XHJcbiAgICovXHJcbiAgcHVibGljIHNlbGVjdEZpcnN0Um9vdE5vZGUoYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhLCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcpOiBzdHJpbmcge1xyXG5cclxuICAgIGNvbnN0IHRyZWVOb2Rlc0RhdGEgPSBiaW5kaW5nRGF0YS5saXN0LnRvSlNPTigpO1xyXG4gICAgY29uc3QgZmlyc3RSb290Tm9kZUlkID0gdGhpcy5nZXRGaXJzdE5vZGVJZCh0cmVlTm9kZXNEYXRhLCBoaWVyYXJjaHlJbmZvS2V5KTtcclxuICAgIHRoaXMuc2VsZWN0ZWROb2RlKGJpbmRpbmdEYXRhLCBoaWVyYXJjaHlJbmZvS2V5LCBmaXJzdFJvb3ROb2RlSWQpO1xyXG4gICAgcmV0dXJuIGZpcnN0Um9vdE5vZGVJZDtcclxuICB9XHJcbiAgcHVibGljIHNlbGVjdE5vZGVCeUJpbmRpbmdMaXN0KGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCBzZWxlY3RlZE5vZGVJZDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBjb25zdCB0cmVlTm9kZXNEYXRhID0gYmluZGluZ0xpc3QudG9KU09OKCk7XHJcbiAgICAvLyDlpoLmnpzopoHorr7nva7nmoToioLngrnkuI3lrZjlnKjvvIzliJnorr7nva7nrKwx5Liq5qC56IqC54K5XHJcbiAgICBjb25zdCBzZWxlY3RlZE5vZGVEYXRhID0gdGhpcy5nZXROb2RlRGF0YUJ5SWQodHJlZU5vZGVzRGF0YSwgc2VsZWN0ZWROb2RlSWQpO1xyXG4gICAgbGV0IGN1cnJlbnRJZCA9IHNlbGVjdGVkTm9kZUlkO1xyXG4gICAgaWYgKCFzZWxlY3RlZE5vZGVEYXRhKSB7XHJcbiAgICAgIGN1cnJlbnRJZCA9IHRoaXMuZ2V0Rmlyc3ROb2RlSWQodHJlZU5vZGVzRGF0YSwgaGllcmFyY2h5SW5mb0tleSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgIGJpbmRpbmdMaXN0LnNldEN1cnJlbnRJZChjdXJyZW50SWQsIHRydWUsIHRydWUpO1xyXG4gICAgfSwgMCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOmAieS4reiKgueCuVxyXG4gICAqL1xyXG4gIHB1YmxpYyBzZWxlY3RlZE5vZGUoYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhLCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcsIHNlbGVjdGVkTm9kZUlkOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGNvbnN0IHRyZWVOb2Rlc0RhdGEgPSBiaW5kaW5nRGF0YS5saXN0LnRvSlNPTigpO1xyXG4gICAgLy8g5aaC5p6c6KaB6K6+572u55qE6IqC54K55LiN5a2Y5Zyo77yM5YiZ6K6+572u56ysMeS4quagueiKgueCuVxyXG4gICAgY29uc3Qgc2VsZWN0ZWROb2RlRGF0YSA9IHRoaXMuZ2V0Tm9kZURhdGFCeUlkKHRyZWVOb2Rlc0RhdGEsIHNlbGVjdGVkTm9kZUlkKTtcclxuICAgIGxldCBjdXJyZW50SWQgPSBzZWxlY3RlZE5vZGVJZDtcclxuICAgIGlmICghc2VsZWN0ZWROb2RlRGF0YSkge1xyXG4gICAgICBjdXJyZW50SWQgPSB0aGlzLmdldEZpcnN0Tm9kZUlkKHRyZWVOb2Rlc0RhdGEsIGhpZXJhcmNoeUluZm9LZXkpO1xyXG4gICAgfVxyXG4gICAgaWYgKGJpbmRpbmdEYXRhLnJvd1NlbGVjdGVkRXZlbnRTdXNwZW5kID09PSB0cnVlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICBiaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZCA9IG51bGw7XHJcbiAgICAgIGJpbmRpbmdEYXRhLmxpc3Quc2V0Q3VycmVudElkKGN1cnJlbnRJZCwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICB9LCAwKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOajgOafpeaYr+WQpuacieWtkOiKgueCuVxyXG4gICAqL1xyXG4gIHB1YmxpYyBoYXNDaGlsZE5vZGVzKHRyZWVOb2Rlc0RhdGE6IGFueVtdLCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcsIGZpZDogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCBmTm9kZURhdGEgPSB0aGlzLmdldE5vZGVEYXRhQnlJZCh0cmVlTm9kZXNEYXRhLCBmaWQpO1xyXG4gICAgLy8gY29uc3QgZkxheWVyID0gZk5vZGVEYXRhW2hpZXJhcmNoeUluZm9LZXldWydsYXllciddO1xyXG4gICAgLy8gY29uc3QgZlBhdGggID0gZk5vZGVEYXRhW2hpZXJhcmNoeUluZm9LZXldWydwYXRoJ107XHJcbiAgICBjb25zdCBmSXNEZXRhaWwgPSBmTm9kZURhdGFbaGllcmFyY2h5SW5mb0tleV1bJ2lzRGV0YWlsJ107XHJcblxyXG4gICAgLy8g6Z2e5piO57uG6IqC54K577yM6L+U5ZuedHJ1ZVxyXG4gICAgaWYgKGZJc0RldGFpbCA9PT0gZmFsc2UpIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAvLyBjb25zdCBjaGlsZE5vZGVzRGF0YSA9IHRoaXMuZ2V0Q2hpbGROb2Rlc0RhdGEodHJlZU5vZGVzRGF0YSwgaGllcmFyY2h5SW5mb0tleSwgZkxheWVyLCBmUGF0aCk7XHJcbiAgICAvLyByZXR1cm4gY2hpbGROb2Rlc0RhdGEubGVuZ3RoID4gMDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluagueiKgueCue+8iOWkmuS4quagueiKgueCueaXtuiOt+WPluesrOS4gOS4qu+8iVxyXG4gICAqIEByZXR1cm4g5om+5LiN5Yiw5pe26L+U5ZuebnVsbFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Rmlyc3ROb2RlSWQodHJlZU5vZGVzRGF0YTogYW55W10sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBsZXQgcm9vdERhdGEgPSB0cmVlTm9kZXNEYXRhLmZpbmQoKGl0ZW1EYXRhOiBhbnkpID0+IHtcclxuICAgICAgY29uc3QgbGF5ZXIgPSBpdGVtRGF0YVtoaWVyYXJjaHlJbmZvS2V5XVsnbGF5ZXInXTtcclxuICAgICAgcmV0dXJuIGxheWVyID09PSAxO1xyXG4gICAgfSk7XHJcbiAgICBpZiAoIXJvb3REYXRhKSB7XHJcbiAgICAgIGNvbnN0IHJvb3RMYXllciA9IHRoaXMuZ2V0Um9vdExheWVyKHRyZWVOb2Rlc0RhdGEsIGhpZXJhcmNoeUluZm9LZXkpO1xyXG4gICAgICByb290RGF0YSA9IHRyZWVOb2Rlc0RhdGEuZmluZCgoaXRlbURhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGxheWVyID0gaXRlbURhdGFbaGllcmFyY2h5SW5mb0tleV1bJ2xheWVyJ107XHJcbiAgICAgICAgcmV0dXJuIGxheWVyID09PSByb290TGF5ZXI7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJvb3REYXRhID8gcm9vdERhdGFbJ2lkJ10gOiAnJztcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRSb290TGF5ZXIodHJlZU5vZGVzRGF0YTogYW55W10sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZykge1xyXG4gICAgbGV0IGxheWVyID0gbnVsbDtcclxuICAgIGlmICh0cmVlTm9kZXNEYXRhICYmIEFycmF5LmlzQXJyYXkodHJlZU5vZGVzRGF0YSkpIHtcclxuICAgICAgY29uc3QgbGF5ZXJzID0gdHJlZU5vZGVzRGF0YS5tYXAoaXRlbSA9PiB7XHJcbiAgICAgICAgY29uc3QgbGF5ZXIgPSBpdGVtW2hpZXJhcmNoeUluZm9LZXldWydsYXllciddO1xyXG4gICAgICAgIHJldHVybiBsYXllcjtcclxuICAgICAgfSk7XHJcbiAgICAgIGNvbnN0IG1pbkxheWVyID0gTWF0aC5taW4uYXBwbHkoTWF0aCwgbGF5ZXJzKTtcclxuICAgICAgaWYgKCFpc05hTihtaW5MYXllcikpIHtcclxuICAgICAgICBsYXllciA9IG1pbkxheWVyO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbGF5ZXI7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluS4i+S4gOS4quiKgueCue+8iOWIoOmZpOWQju+8iVxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXROZXh0Tm9kZUlkKHRyZWVOb2Rlc0RhdGE6IGFueVtdLCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcsIGN1cnJlbnRJZDogc3RyaW5nKTogc3RyaW5nIHtcclxuXHJcbiAgICAvLyDlvZPliY3oioLngrnkv6Hmga9cclxuICAgIGNvbnN0IGN1cnJlbnROb2RlRGF0YSA9IHRyZWVOb2Rlc0RhdGEuZmluZCgoaXRlbURhdGE6IGFueSkgPT4ge1xyXG4gICAgICByZXR1cm4gaXRlbURhdGFbJ2lkJ10gPT09IGN1cnJlbnRJZDtcclxuICAgIH0pO1xyXG4gICAgY29uc3QgY3VycmVudFBhdGggPSBjdXJyZW50Tm9kZURhdGFbaGllcmFyY2h5SW5mb0tleV1bJ3BhdGgnXTtcclxuICAgIGNvbnN0IGN1cnJlbnRMYXllciA9IGN1cnJlbnROb2RlRGF0YVtoaWVyYXJjaHlJbmZvS2V5XVsnbGF5ZXInXTtcclxuXHJcbiAgICAvLyDniLboioLngrnkv6Hmga9cclxuICAgIGNvbnN0IGZMYXllciA9IGN1cnJlbnRMYXllciAtIDE7XHJcbiAgICBjb25zdCBmUGF0aCA9IGN1cnJlbnRQYXRoLnN1YnN0cmluZygwLCBjdXJyZW50UGF0aC5sZW5ndGggLSA0KTtcclxuXHJcbiAgICAvLyDmn6Xmib7lhYTlvJ/oioLngrlcclxuICAgIGNvbnN0IHNpYmxpbmd0cmVlTm9kZXNEYXRhID0gdGhpcy5nZXRDaGlsZE5vZGVzRGF0YSh0cmVlTm9kZXNEYXRhLCBoaWVyYXJjaHlJbmZvS2V5LCBmTGF5ZXIsIGZQYXRoKTtcclxuXHJcbiAgICAvLyDlpoLmnpzmsqHmnInlhYTlvJ/oioLngrnvvIzlkJHkuIrmn6Xmib5cclxuICAgIGlmIChzaWJsaW5ndHJlZU5vZGVzRGF0YS5sZW5ndGggPT09IDEpIHtcclxuICAgICAgY29uc3QgcGFyZW50RGF0YSA9IHRyZWVOb2Rlc0RhdGEuZmluZCgoaXRlbURhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgIHJldHVybiBpdGVtRGF0YVtoaWVyYXJjaHlJbmZvS2V5XVsncGF0aCddID09PSBmUGF0aDtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICAvLyDlrZjlnKjniLboioLngrnvvIzliJnorr7nva7niLboioLngrnvvJtcclxuICAgICAgLy8g5LiN5a2Y5Zyo54i26IqC54K577yM5YiZ6K6+572u56ys5LiA5Liq5qC56IqC54K544CCXHJcbiAgICAgIGlmICghcGFyZW50RGF0YSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldEZpcnN0Tm9kZUlkKHRyZWVOb2Rlc0RhdGEsIGhpZXJhcmNoeUluZm9LZXkpO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBwYXJlbnREYXRhWydpZCddO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZ2V0TmV4dFNpYmxpbmdOb2RlSWQoc2libGluZ3RyZWVOb2Rlc0RhdGEsIGN1cnJlbnRJZCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bkuIvkuKrlhYTlvJ/oioLngrnnmoRpZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXROZXh0U2libGluZ05vZGVJZChzaWJsaW5ndHJlZU5vZGVzRGF0YTogYW55W10sIGN1cnJlbnRJZDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGlmIChzaWJsaW5ndHJlZU5vZGVzRGF0YS5sZW5ndGggPD0gMSkge1xyXG4gICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY3VycmVudEluZGV4ID0gc2libGluZ3RyZWVOb2Rlc0RhdGEuZmluZEluZGV4KChpdGVtRGF0YTogYW55KSA9PiB7XHJcbiAgICAgIHJldHVybiBpdGVtRGF0YVsnaWQnXSA9PT0gY3VycmVudElkO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g5pyA5ZCO5LiA6KGM5LiK56e75LiA6KGM77yM5YW25LuW5LiL56e75LiA6KGMXHJcbiAgICBsZXQgbmV4dEluZGV4ID0gLTE7XHJcbiAgICBpZiAoY3VycmVudEluZGV4ID09PSBzaWJsaW5ndHJlZU5vZGVzRGF0YS5sZW5ndGggLSAxKSB7XHJcbiAgICAgIG5leHRJbmRleCA9IGN1cnJlbnRJbmRleCAtIDE7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBuZXh0SW5kZXggPSBjdXJyZW50SW5kZXggKyAxO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBzaWJsaW5ndHJlZU5vZGVzRGF0YVtuZXh0SW5kZXhdWydpZCddO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5LiL57qn6IqC54K555qEQmluZGluZ09iamVjdHPpm4blkIhcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0Q2hpbGROb2Rlc0RhdGEodHJlZU5vZGVzRGF0YTogYW55W10sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgZkxheWVyOiBudW1iZXIsIGZQYXRoOiBzdHJpbmcpOiBhbnlbXSB7XHJcbiAgICBjb25zdCBjaGlsZHRyZWVOb2Rlc0RhdGEgPSB0cmVlTm9kZXNEYXRhLmZpbHRlcigoaXRlbURhdGEpID0+IHtcclxuICAgICAgY29uc3QgbGF5ZXIgPSBpdGVtRGF0YVtoaWVyYXJjaHlJbmZvS2V5XVsnbGF5ZXInXTtcclxuICAgICAgY29uc3QgcGF0aCA9IGl0ZW1EYXRhW2hpZXJhcmNoeUluZm9LZXldWydwYXRoJ107XHJcbiAgICAgIHJldHVybiAobGF5ZXIgPT09IGZMYXllciArIDEpICYmIHBhdGguc3RhcnRzV2l0aChmUGF0aCk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBjaGlsZHRyZWVOb2Rlc0RhdGE7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5ZpZOiOt+WPluiKgueCueaVsOaNrlxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXROb2RlRGF0YUJ5SWQodHJlZU5vZGVzRGF0YTogYW55W10sIGlkOiBzdHJpbmcpOiBhbnkge1xyXG4gICAgY29uc3Qgbm9kZURhdGEgPSB0cmVlTm9kZXNEYXRhLmZpbmQoKGl0ZW1EYXRhOiBhbnkpID0+IHtcclxuICAgICAgcmV0dXJuIGl0ZW1EYXRhWydpZCddID09PSBpZDtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIG5vZGVEYXRhID8gbm9kZURhdGEgOiBudWxsO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgUGF0aFRyZWVOb2RlVXRpbCB9O1xyXG4iXX0=