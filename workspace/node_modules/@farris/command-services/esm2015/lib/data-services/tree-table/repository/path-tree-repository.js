import { HttpHeaders } from '@angular/common/http';
import { of } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { FieldMetadataUtil } from '@farris/devkit';
/**
 * 路径树仓库
 */
class PathTreeRepository {
    /**
     * 添加兄弟节点
     */
    addSibling(repository, id) {
        const restService = repository.restService;
        const baseUri = restService.baseUri;
        const addSiblingUri = `${baseUri}/service/pathhierarchycreatesibling`;
        const body = {
            dataID: id,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSiblingUri, 'PUT', null, options).pipe(map((responseInfo) => {
            const entity = repository.buildEntity(responseInfo.returnValue);
            repository.entityCollection.addEntity(entity);
            return entity;
        }));
    }
    /**
     * 添加兄弟节点
     */
    addChild(repository, parentId) {
        const restService = repository.restService;
        const baseUri = restService.baseUri;
        const addChildUri = `${baseUri}/service/pathhierarchycreatechildlayer`;
        const body = {
            dataID: parentId,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addChildUri, 'PUT', null, options).pipe(map((responseInfo) => {
            const entity = repository.buildEntity(responseInfo.returnValue);
            repository.entityCollection.addEntity(entity);
            return entity;
        }));
    }
    /**
     * 添加子表兄弟节点
     */
    addSubSibling(repository, nodes, ids) {
        const restService = repository.restService;
        const baseUri = restService.baseUri;
        const addSubSiblingUri = `${baseUri}/service/childnodepathhierarchycreatesibling`;
        const body = {
            nodes: nodes,
            ids: ids,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSubSiblingUri, 'PUT', null, options).pipe(map((responseInfo) => {
            let path = this.getPaths(nodes, ids);
            const entity = repository.entityManager.appendEntityByPath(path, responseInfo.returnValue);
            return entity;
        }));
    }
    /**
    * 添加子表子节点
    */
    addSubChild(repository, nodes, ids) {
        const restService = repository.restService;
        const baseUri = restService.baseUri;
        const addSubChildUri = `${baseUri}/service/childnodepathhierarchycreatechildlayer`;
        const body = {
            nodes: nodes,
            ids: ids,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSubChildUri, 'PUT', null, options).pipe(map((responseInfo) => {
            let path = this.getPaths(nodes, ids);
            const entity = repository.entityManager.appendEntityByPath(path, responseInfo.returnValue);
            return entity;
        }));
    }
    getPaths(nodes, ids) {
        let paths = '';
        if (nodes && nodes.length > 0 && ids && ids.length > 0) {
            for (let i = 0; i < ids.length; i++) {
                if (nodes[i]) {
                    paths = paths + `/${ids[i]}`;
                    paths = paths + `/${nodes[i]}s`;
                }
            }
        }
        return paths;
    }
    /**
     * 加载父节点
     */
    // tslint:disable-next-line: max-line-length
    loadByParentId(repository, hierarchyInfoKey, parentId, filters, sorts, frozenCurrentRow = false, pagination, frameContext, reload = false) {
        const localEntities = this.getChildren(repository, hierarchyInfoKey, parentId);
        if (localEntities && localEntities.length > 0 && !reload) {
            return of(localEntities);
        }
        const restService = repository.restService;
        const parentHierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, parentId);
        const originalHierarchyInfoKey = this.getOriginalHierarchyInfoKey(repository, hierarchyInfoKey);
        const filtersWithParent = this.buildFiltersWithParent(originalHierarchyInfoKey, parentHierarchyInfo, filters);
        const isUsePagination = pagination && pagination.pageSize > 0 || false;
        // 组织EntityFilter
        const entityFilter = {
            FilterConditions: filtersWithParent,
            SortConditions: sorts,
            IsUsePagination: isUsePagination,
            Pagination: { PageIndex: pagination && pagination.pageIndex || 0, PageSize: pagination && pagination.pageSize || 0, PageCount: 0, TotalCount: 0 }
        };
        const requestInfo = restService.buildRequestInfo();
        return restService.extendQuery(entityFilter, requestInfo).pipe(map((responseInfo) => {
            const paginationInfo = this.getPaginationInfo(responseInfo);
            if (parentId) {
                if (paginationInfo && paginationInfo.pageSize !== 0 && frameContext) {
                    frameContext.params.set(`_NODE_${parentId}_PAGINATION_INFO_`, paginationInfo);
                }
            }
            else {
                if (paginationInfo && paginationInfo.pageSize !== 0 && frameContext) {
                    frameContext.repository.entityCollection.updatePaginationInfoByPath('/', paginationInfo);
                }
            }
            // 先清空下级实体
            this.clearDescendantEntities(repository, hierarchyInfoKey, parentHierarchyInfo, frozenCurrentRow);
            // 追加下级实体
            const listData = responseInfo.returnValue.result;
            const entities = repository.buildEntities(listData);
            if (frozenCurrentRow) {
                repository.entityCollection.addData(entities, { isTreeNodeLoadScene: true });
            }
            else {
                repository.entityCollection.addEntities(entities, { isTreeNodeLoadScene: true });
            }
            return entities;
        }));
    }
    // tslint:disable-next-line: max-line-length
    loadFullTree(repository, hierarchyInfoKey, parentId, propertyName, fullTreeType, loadType, filters, context) {
        const restService = repository.restService;
        const baseUri = restService.baseUri;
        const queryUrl = `${baseUri}/service/parentidfulltreequery`;
        const pathHierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, parentId);
        const entityFilter = this.buildEntityFilter(filters, null, 0, 0);
        const body = {
            dataId: parentId || '',
            isUsePagination: false,
            virtualPropertyName: propertyName,
            pagination: {},
            fullTreeType,
            loadType,
            filter: entityFilter,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            body: body
        };
        return restService.invoke(queryUrl, 'PUT', null, options).pipe(tap((responseInfo) => {
            // 保存展开的节点
            if (responseInfo.returnValue && responseInfo.returnValue.selectedRowId && context && context.frameContext) {
                const frameContext = context.frameContext;
                const virtualRootFrameContext = frameContext && frameContext.getVirtualRootFrameContext() || null;
                if (virtualRootFrameContext) {
                    const list = responseInfo.returnValue.result;
                    const selectedRowId = responseInfo.returnValue.selectedRowId;
                    // 从顶层开始计算所有需要展开的节点
                    const leafNodeInfo = list.find(item => item[repository.primaryKey] === selectedRowId);
                    const hierarchyInfo = leafNodeInfo[hierarchyInfoKey];
                    const ids = this.getAllParentIds(hierarchyInfo, list, hierarchyInfoKey, repository);
                    virtualRootFrameContext.params.set('_DEVKIT_expandRowIds', ids.join(','));
                    virtualRootFrameContext.params.set('_DEVKIT_selectedRowId', selectedRowId);
                    virtualRootFrameContext.uiState.setPropertyValue('__DEVKIT__selectedRow', selectedRowId);
                }
            }
        }), map((responseInfo) => {
            const frozenCurrentRow = context && context.frozenCurrentRow || false;
            // 先清空下级实体
            this.clearDescendantEntities(repository, hierarchyInfoKey, pathHierarchyInfo, frozenCurrentRow);
            // 追加下级实体
            const listData = responseInfo.returnValue.result;
            const entities = repository.buildEntities(listData);
            if (frozenCurrentRow) {
                repository.entityCollection.addData(entities, { isTreeNodeLoadScene: true });
            }
            else {
                repository.entityCollection.addEntities(entities, { isTreeNodeLoadScene: true });
            }
            return entities;
        }));
    }
    /**
     * 插入对父节点的过滤
     */
    buildFiltersWithParent(originalHierarchyInfoKey, parentHierarchyInfo, filterArray) {
        const relationType = filterArray && filterArray.length >= 1 ? 1 : 0;
        const parentLayer = parentHierarchyInfo ? parentHierarchyInfo['layer'] : 0;
        const parentFilterArray = [
            {
                "FilterField": `${originalHierarchyInfoKey}.Layer`,
                "Value": parentLayer + 1,
                "Lbracket": null,
                "Rbracket": null,
                "Relation": 1,
                "Expresstype": 0,
                "Compare": 0
            }
        ];
        // 父路径过滤，如果为空，则不添加（兼容oracle取数）
        const parentPath = parentHierarchyInfo ? parentHierarchyInfo['path'] : '';
        if (parentPath) {
            parentFilterArray.push({
                "FilterField": `${originalHierarchyInfoKey}.Path`,
                "Value": parentPath,
                "Lbracket": null,
                "Rbracket": null,
                "Relation": relationType,
                "Expresstype": 0,
                "Compare": 7
            });
        }
        else {
            parentFilterArray[0].Relation = relationType;
        }
        return parentFilterArray.concat(filterArray);
    }
    buildEntityFilter(filter, sort, pageSize, pageIndex) {
        // @todo：临时兼容老代码，降低改动带来的风险
        if (!filter && !sort && !pageSize && !pageIndex) {
            return null;
        }
        if (!filter) {
            filter = [];
        }
        if (!sort) {
            sort = [];
        }
        // 纠正最后一个过滤条件的Relation
        if (filter && filter.length > 0) {
            filter[filter.length - 1].Relation = 0;
        }
        const entityFilter = {
            FilterConditions: filter,
            SortConditions: sort,
            IsUsePagination: pageSize === 0 ? false : true,
            Pagination: {
                PageIndex: pageIndex,
                PageSize: pageSize,
                PageCount: 0,
                TotalCount: 0
            }
        };
        return entityFilter;
    }
    /**
     * 清空后代实体
     */
    clearDescendantEntities(repository, hierarchyInfokey, parentHierarchyInfo, frozenCurrentRow = false) {
        // 清空根节点
        if (!parentHierarchyInfo) {
            repository.entityCollection.clear();
            return;
        }
        const fPath = parentHierarchyInfo.path;
        const fLayer = parentHierarchyInfo.layer;
        if (frozenCurrentRow) {
            repository.entityCollection.removeData((entity) => {
                const hierarchyInfo = entity[hierarchyInfokey];
                const path = hierarchyInfo.path;
                const layer = hierarchyInfo.layer;
                return layer > fLayer && path.startsWith(fPath);
            });
        }
        else {
            repository.entityCollection.removeEntities((entity) => {
                const hierarchyInfo = entity[hierarchyInfokey];
                const path = hierarchyInfo.path;
                const layer = hierarchyInfo.layer;
                return layer > fLayer && path.startsWith(fPath);
            });
        }
    }
    /**
     * 获取实体的分级信息
     */
    getHierarchyInfoById(repository, hierarchyInfokey, id) {
        if (!id) {
            return null;
        }
        const entity = repository.entityCollection.getEntityById(id);
        const hierarchyInfoEntity = entity[hierarchyInfokey];
        return hierarchyInfoEntity.toJSON();
    }
    /**
     * 获取分级码的原始的字段名
     */
    getOriginalHierarchyInfoKey(repository, hierarchyInfokey) {
        const ngObjects = FieldMetadataUtil.getNgObjects(repository.entityType);
        const hierarchyInfoNgObject = ngObjects[hierarchyInfokey];
        return hierarchyInfoNgObject.originalDataField;
    }
    getPaginationInfo(responseInfo) {
        return responseInfo && responseInfo.returnValue && responseInfo.returnValue.pagination || null;
    }
    findParent(hierarchyInfo, list, hierarchyInfoKey) {
        return list.find(item => {
            const currentHierarchyInfo = item[hierarchyInfoKey];
            return currentHierarchyInfo.layer === hierarchyInfo.layer - 1 && hierarchyInfo.path.startsWith(currentHierarchyInfo.path);
        });
    }
    getAllParentIds(hierarchyInfo, list, hierarchyInfoKey, repository) {
        let item = this.findParent(hierarchyInfo, list, hierarchyInfoKey);
        const ids = [];
        while (item) {
            ids.push(item[repository.primaryKey]);
            item = this.findParent(item[hierarchyInfoKey], list, hierarchyInfoKey);
        }
        return ids;
    }
    getHierarchyInfo(entity, hierarchyInfoKey) {
        return entity[hierarchyInfoKey];
    }
    /**
     * 查找节点下所有子级（第一级）
     * @param repository repository
     * @param hierarchyInfoKey 分级码字段
     * @param id id
     * @returns
     */
    getChildren(repository, hierarchyInfoKey, id) {
        const hierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, id);
        if (!hierarchyInfo) {
            return null;
        }
        const layer = hierarchyInfo.layer;
        const path = hierarchyInfo.path;
        const entities = repository.entityCollection.getEntities((entity) => {
            const hierarchyInfo = this.getHierarchyInfo(entity, hierarchyInfoKey);
            const matched = hierarchyInfo.layer === layer + 1 && hierarchyInfo.path.startsWith(path);
            if (matched) {
                return entity;
            }
            else {
                return null;
            }
        });
        return entities;
    }
}
export { PathTreeRepository };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0aC10cmVlLXJlcG9zaXRvcnkuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZGF0YS1zZXJ2aWNlcy90cmVlLXRhYmxlL3JlcG9zaXRvcnkvcGF0aC10cmVlLXJlcG9zaXRvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ25ELE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxQyxPQUFPLEVBQVUsaUJBQWlCLEVBQTRCLE1BQU0sZ0JBQWdCLENBQUM7QUFHckY7O0dBRUc7QUFDSCxNQUFNLGtCQUFrQjtJQUV0Qjs7T0FFRztJQUNJLFVBQVUsQ0FBQyxVQUFpQyxFQUFFLEVBQVU7UUFDN0QsTUFBTSxXQUFXLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQztRQUMzQyxNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDO1FBQ3BDLE1BQU0sYUFBYSxHQUFHLEdBQUcsT0FBTyxxQ0FBcUMsQ0FBQztRQUN0RSxNQUFNLElBQUksR0FBRztZQUNYLE1BQU0sRUFBRSxFQUFFO1lBQ1YsV0FBVyxFQUFFLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRTtTQUM1QyxDQUFDO1FBQ0YsTUFBTSxPQUFPLEdBQUc7WUFDZCxPQUFPLEVBQUUsSUFBSSxXQUFXLENBQUMsRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQztZQUNoRSxJQUFJLEVBQUUsSUFBSTtTQUNYLENBQUM7UUFDRixPQUFPLFdBQVcsQ0FBQyxNQUFNLENBQUMsYUFBYSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUNqRSxHQUFHLENBQUMsQ0FBQyxZQUEwQixFQUFFLEVBQUU7WUFDakMsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDaEUsVUFBVSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUM5QyxPQUFPLE1BQU0sQ0FBQztRQUNoQixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0ksUUFBUSxDQUFDLFVBQWlDLEVBQUUsUUFBZ0I7UUFDakUsTUFBTSxXQUFXLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQztRQUMzQyxNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDO1FBQ3BDLE1BQU0sV0FBVyxHQUFHLEdBQUcsT0FBTyx3Q0FBd0MsQ0FBQztRQUV2RSxNQUFNLElBQUksR0FBRztZQUNYLE1BQU0sRUFBRSxRQUFRO1lBQ2hCLFdBQVcsRUFBRSxXQUFXLENBQUMsZ0JBQWdCLEVBQUU7U0FDNUMsQ0FBQztRQUNGLE1BQU0sT0FBTyxHQUFHO1lBQ2QsT0FBTyxFQUFFLElBQUksV0FBVyxDQUFDLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLENBQUM7WUFDaEUsSUFBSSxFQUFFLElBQUk7U0FDWCxDQUFDO1FBQ0YsT0FBTyxXQUFXLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDL0QsR0FBRyxDQUFDLENBQUMsWUFBMEIsRUFBRSxFQUFFO1lBQ2pDLE1BQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ2hFLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDOUMsT0FBTyxNQUFNLENBQUM7UUFDaEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNJLGFBQWEsQ0FBQyxVQUFpQyxFQUFFLEtBQW9CLEVBQUUsR0FBa0I7UUFDOUYsTUFBTSxXQUFXLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQztRQUMzQyxNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDO1FBQ3BDLE1BQU0sZ0JBQWdCLEdBQUcsR0FBRyxPQUFPLDhDQUE4QyxDQUFDO1FBQ2xGLE1BQU0sSUFBSSxHQUFHO1lBQ1gsS0FBSyxFQUFFLEtBQUs7WUFDWixHQUFHLEVBQUUsR0FBRztZQUNSLFdBQVcsRUFBRSxXQUFXLENBQUMsZ0JBQWdCLEVBQUU7U0FDNUMsQ0FBQztRQUNGLE1BQU0sT0FBTyxHQUFHO1lBQ2QsT0FBTyxFQUFFLElBQUksV0FBVyxDQUFDLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLENBQUM7WUFDaEUsSUFBSSxFQUFFLElBQUk7U0FDWCxDQUFDO1FBQ0YsT0FBTyxXQUFXLENBQUMsTUFBTSxDQUFDLGdCQUFnQixFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUNwRSxHQUFHLENBQUMsQ0FBQyxZQUEwQixFQUFFLEVBQUU7WUFDakMsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDckMsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFBO1lBQzFGLE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBRUQ7O01BRUU7SUFDSyxXQUFXLENBQUMsVUFBaUMsRUFBRSxLQUFvQixFQUFFLEdBQWtCO1FBQzVGLE1BQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUM7UUFDM0MsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUNwQyxNQUFNLGNBQWMsR0FBRyxHQUFHLE9BQU8saURBQWlELENBQUM7UUFFbkYsTUFBTSxJQUFJLEdBQUc7WUFDWCxLQUFLLEVBQUUsS0FBSztZQUNaLEdBQUcsRUFBRSxHQUFHO1lBQ1IsV0FBVyxFQUFFLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRTtTQUM1QyxDQUFDO1FBQ0YsTUFBTSxPQUFPLEdBQUc7WUFDZCxPQUFPLEVBQUUsSUFBSSxXQUFXLENBQUMsRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQztZQUNoRSxJQUFJLEVBQUUsSUFBSTtTQUNYLENBQUM7UUFDRixPQUFPLFdBQVcsQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUNsRSxHQUFHLENBQUMsQ0FBQyxZQUEwQixFQUFFLEVBQUU7WUFDakMsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDckMsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFBO1lBQzFGLE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBRU8sUUFBUSxDQUFDLEtBQWUsRUFBRSxHQUFhO1FBQzdDLElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUNmLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN0RCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDbkMsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7b0JBQ1osS0FBSyxHQUFHLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO29CQUM3QixLQUFLLEdBQUcsS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7aUJBQ2pDO2FBQ0Y7U0FDRjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVEOztPQUVHO0lBQ0gsNENBQTRDO0lBQ3JDLGNBQWMsQ0FBQyxVQUFpQyxFQUFFLGdCQUF3QixFQUFFLFFBQWdCLEVBQUUsT0FBYyxFQUFFLEtBQVksRUFBRSxtQkFBNEIsS0FBSyxFQUFFLFVBQW9ELEVBQUUsWUFBMkIsRUFBRSxTQUFrQixLQUFLO1FBQzlRLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLGdCQUFnQixFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQy9FLElBQUksYUFBYSxJQUFJLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ3hELE9BQU8sRUFBRSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQzFCO1FBQ0QsTUFBTSxXQUFXLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQztRQUMzQyxNQUFNLG1CQUFtQixHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDOUYsTUFBTSx3QkFBd0IsR0FBRyxJQUFJLENBQUMsMkJBQTJCLENBQUMsVUFBVSxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDaEcsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsd0JBQXdCLEVBQUUsbUJBQW1CLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDOUcsTUFBTSxlQUFlLEdBQUcsVUFBVSxJQUFJLFVBQVUsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxJQUFJLEtBQUssQ0FBQztRQUN2RSxpQkFBaUI7UUFDakIsTUFBTSxZQUFZLEdBQUc7WUFDbkIsZ0JBQWdCLEVBQUUsaUJBQWlCO1lBQ25DLGNBQWMsRUFBRSxLQUFLO1lBQ3JCLGVBQWUsRUFBRSxlQUFlO1lBQ2hDLFVBQVUsRUFBRSxFQUFFLFNBQVMsRUFBRSxVQUFVLElBQUksVUFBVSxDQUFDLFNBQVMsSUFBSSxDQUFDLEVBQUUsUUFBUSxFQUFFLFVBQVUsSUFBSSxVQUFVLENBQUMsUUFBUSxJQUFJLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxFQUFFLFVBQVUsRUFBRSxDQUFDLEVBQUU7U0FDbEosQ0FBQztRQUNGLE1BQU0sV0FBVyxHQUFHLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ25ELE9BQU8sV0FBVyxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUM1RCxHQUFHLENBQUMsQ0FBQyxZQUEwQixFQUFFLEVBQUU7WUFDakMsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzVELElBQUksUUFBUSxFQUFFO2dCQUNaLElBQUksY0FBYyxJQUFJLGNBQWMsQ0FBQyxRQUFRLEtBQUssQ0FBQyxJQUFJLFlBQVksRUFBRTtvQkFDbkUsWUFBWSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsU0FBUyxRQUFRLG1CQUFtQixFQUFFLGNBQWMsQ0FBQyxDQUFDO2lCQUMvRTthQUNGO2lCQUFNO2dCQUNMLElBQUksY0FBYyxJQUFJLGNBQWMsQ0FBQyxRQUFRLEtBQUssQ0FBQyxJQUFJLFlBQVksRUFBRTtvQkFDbkUsWUFBWSxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQywwQkFBMEIsQ0FBQyxHQUFHLEVBQUUsY0FBYyxDQUFDLENBQUM7aUJBQzFGO2FBQ0Y7WUFDRCxVQUFVO1lBQ1YsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxtQkFBbUIsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ2xHLFNBQVM7WUFDVCxNQUFNLFFBQVEsR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQztZQUNqRCxNQUFNLFFBQVEsR0FBRyxVQUFVLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3BELElBQUksZ0JBQWdCLEVBQUU7Z0JBQ3BCLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsbUJBQW1CLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQzthQUM5RTtpQkFBTTtnQkFDTCxVQUFVLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxFQUFFLG1CQUFtQixFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7YUFDbEY7WUFFRCxPQUFPLFFBQVEsQ0FBQztRQUNsQixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUNELDRDQUE0QztJQUNyQyxZQUFZLENBQUMsVUFBaUMsRUFBRSxnQkFBd0IsRUFBRSxRQUFnQixFQUFFLFlBQW9CLEVBQUUsWUFBb0IsRUFBRSxRQUFnQixFQUFFLE9BQWUsRUFBRSxPQUFhO1FBQzdMLE1BQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUM7UUFDM0MsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUNwQyxNQUFNLFFBQVEsR0FBRyxHQUFHLE9BQU8sZ0NBQWdDLENBQUM7UUFDNUQsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxFQUFFLGdCQUFnQixFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzVGLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNqRSxNQUFNLElBQUksR0FBRztZQUNYLE1BQU0sRUFBRSxRQUFRLElBQUksRUFBRTtZQUN0QixlQUFlLEVBQUUsS0FBSztZQUN0QixtQkFBbUIsRUFBRSxZQUFZO1lBQ2pDLFVBQVUsRUFBRSxFQUFFO1lBQ2QsWUFBWTtZQUNaLFFBQVE7WUFDUixNQUFNLEVBQUUsWUFBWTtZQUNwQixXQUFXLEVBQUUsV0FBVyxDQUFDLGdCQUFnQixFQUFFO1NBQzVDLENBQUM7UUFDRixNQUFNLE9BQU8sR0FBRztZQUNkLElBQUksRUFBRSxJQUFJO1NBQ1gsQ0FBQztRQUNGLE9BQU8sV0FBVyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQzVELEdBQUcsQ0FBQyxDQUFDLFlBQTBCLEVBQUUsRUFBRTtZQUNqQyxVQUFVO1lBQ1YsSUFBSSxZQUFZLENBQUMsV0FBVyxJQUFJLFlBQVksQ0FBQyxXQUFXLENBQUMsYUFBYSxJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsWUFBWSxFQUFFO2dCQUN6RyxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsWUFBNEIsQ0FBQztnQkFDMUQsTUFBTSx1QkFBdUIsR0FBRyxZQUFZLElBQUksWUFBWSxDQUFDLDBCQUEwQixFQUFFLElBQUksSUFBSSxDQUFDO2dCQUNsRyxJQUFJLHVCQUF1QixFQUFFO29CQUMzQixNQUFNLElBQUksR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDLE1BQWUsQ0FBQztvQkFDdEQsTUFBTSxhQUFhLEdBQUcsWUFBWSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUM7b0JBQzdELG1CQUFtQjtvQkFDbkIsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEtBQUssYUFBYSxDQUFDLENBQUM7b0JBQ3RGLE1BQU0sYUFBYSxHQUFHLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBdUQsQ0FBQztvQkFDM0csTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxhQUFhLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixFQUFFLFVBQVUsQ0FBQyxDQUFDO29CQUNwRix1QkFBdUIsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHNCQUFzQixFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztvQkFDMUUsdUJBQXVCLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsRUFBRSxhQUFhLENBQUMsQ0FBQztvQkFDM0UsdUJBQXVCLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLHVCQUF1QixFQUFFLGFBQWEsQ0FBQyxDQUFDO2lCQUMxRjthQUNGO1FBQ0gsQ0FBQyxDQUFDLEVBQ0YsR0FBRyxDQUFDLENBQUMsWUFBMEIsRUFBRSxFQUFFO1lBQ2pDLE1BQU0sZ0JBQWdCLEdBQVksT0FBTyxJQUFJLE9BQU8sQ0FBQyxnQkFBZ0IsSUFBSSxLQUFLLENBQUM7WUFDL0UsVUFBVTtZQUNWLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsaUJBQWlCLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztZQUNoRyxTQUFTO1lBQ1QsTUFBTSxRQUFRLEdBQUcsWUFBWSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUM7WUFDakQsTUFBTSxRQUFRLEdBQUcsVUFBVSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNwRCxJQUFJLGdCQUFnQixFQUFFO2dCQUNwQixVQUFVLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxFQUFDLG1CQUFtQixFQUFFLElBQUksRUFBQyxDQUFDLENBQUM7YUFDNUU7aUJBQU07Z0JBQ0wsVUFBVSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsRUFBQyxtQkFBbUIsRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDO2FBQ2hGO1lBQ0QsT0FBTyxRQUFRLENBQUM7UUFDbEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFDRDs7T0FFRztJQUNJLHNCQUFzQixDQUFDLHdCQUFnQyxFQUFFLG1CQUF3QixFQUFFLFdBQWtCO1FBQzFHLE1BQU0sWUFBWSxHQUFHLFdBQVcsSUFBSSxXQUFXLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFcEUsTUFBTSxXQUFXLEdBQUcsbUJBQW1CLENBQUMsQ0FBQyxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0UsTUFBTSxpQkFBaUIsR0FBRztZQUN4QjtnQkFDRSxhQUFhLEVBQUUsR0FBRyx3QkFBd0IsUUFBUTtnQkFDbEQsT0FBTyxFQUFFLFdBQVcsR0FBRyxDQUFDO2dCQUN4QixVQUFVLEVBQUUsSUFBSTtnQkFDaEIsVUFBVSxFQUFFLElBQUk7Z0JBQ2hCLFVBQVUsRUFBRSxDQUFDO2dCQUNiLGFBQWEsRUFBRSxDQUFDO2dCQUNoQixTQUFTLEVBQUUsQ0FBQzthQUNiO1NBQ0YsQ0FBQztRQUVGLDhCQUE4QjtRQUM5QixNQUFNLFVBQVUsR0FBRyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUMxRSxJQUFJLFVBQVUsRUFBRTtZQUNkLGlCQUFpQixDQUFDLElBQUksQ0FBQztnQkFDckIsYUFBYSxFQUFFLEdBQUcsd0JBQXdCLE9BQU87Z0JBQ2pELE9BQU8sRUFBRSxVQUFVO2dCQUNuQixVQUFVLEVBQUUsSUFBSTtnQkFDaEIsVUFBVSxFQUFFLElBQUk7Z0JBQ2hCLFVBQVUsRUFBRSxZQUFZO2dCQUN4QixhQUFhLEVBQUUsQ0FBQztnQkFDaEIsU0FBUyxFQUFFLENBQUM7YUFDYixDQUFDLENBQUM7U0FDSjthQUFNO1lBQ0wsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxHQUFHLFlBQVksQ0FBQztTQUM5QztRQUVELE9BQU8saUJBQWlCLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFDTSxpQkFBaUIsQ0FBQyxNQUFhLEVBQUUsSUFBVyxFQUFFLFFBQWdCLEVBQUUsU0FBaUI7UUFFdEYsMEJBQTBCO1FBQzFCLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDL0MsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxNQUFNLEdBQUcsRUFBRSxDQUFDO1NBQ2I7UUFDRCxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1QsSUFBSSxHQUFHLEVBQUUsQ0FBQztTQUNYO1FBQ0Qsc0JBQXNCO1FBQ3RCLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQy9CLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUM7U0FDeEM7UUFDRCxNQUFNLFlBQVksR0FBRztZQUNuQixnQkFBZ0IsRUFBRSxNQUFNO1lBQ3hCLGNBQWMsRUFBRSxJQUFJO1lBQ3BCLGVBQWUsRUFBRSxRQUFRLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUk7WUFDOUMsVUFBVSxFQUFFO2dCQUNWLFNBQVMsRUFBRSxTQUFTO2dCQUNwQixRQUFRLEVBQUUsUUFBUTtnQkFDbEIsU0FBUyxFQUFFLENBQUM7Z0JBQ1osVUFBVSxFQUFFLENBQUM7YUFDZDtTQUNGLENBQUM7UUFDRixPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDO0lBQ0Q7O09BRUc7SUFDSSx1QkFBdUIsQ0FBQyxVQUFpQyxFQUFFLGdCQUF3QixFQUFFLG1CQUF3QixFQUFFLG1CQUE0QixLQUFLO1FBRXJKLFFBQVE7UUFDUixJQUFJLENBQUMsbUJBQW1CLEVBQUU7WUFDeEIsVUFBVSxDQUFDLGdCQUFnQixDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3BDLE9BQU87U0FDUjtRQUNELE1BQU0sS0FBSyxHQUFHLG1CQUFtQixDQUFDLElBQUksQ0FBQztRQUN2QyxNQUFNLE1BQU0sR0FBRyxtQkFBbUIsQ0FBQyxLQUFLLENBQUM7UUFDekMsSUFBSSxnQkFBZ0IsRUFBRTtZQUNwQixVQUFVLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBYyxFQUFFLEVBQUU7Z0JBQ3hELE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO2dCQUMvQyxNQUFNLElBQUksR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDO2dCQUNoQyxNQUFNLEtBQUssR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDO2dCQUNsQyxPQUFPLEtBQUssR0FBRyxNQUFNLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNsRCxDQUFDLENBQUMsQ0FBQztTQUNKO2FBQU07WUFDTCxVQUFVLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLENBQUMsTUFBYyxFQUFFLEVBQUU7Z0JBQzVELE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO2dCQUMvQyxNQUFNLElBQUksR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDO2dCQUNoQyxNQUFNLEtBQUssR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDO2dCQUNsQyxPQUFPLEtBQUssR0FBRyxNQUFNLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNsRCxDQUFDLENBQUMsQ0FBQztTQUNKO0lBRUgsQ0FBQztJQUVEOztPQUVHO0lBQ0ksb0JBQW9CLENBQUMsVUFBaUMsRUFBRSxnQkFBd0IsRUFBRSxFQUFVO1FBQ2pHLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDUCxPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsTUFBTSxNQUFNLEdBQVcsVUFBVSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNyRSxNQUFNLG1CQUFtQixHQUFXLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzdELE9BQU8sbUJBQW1CLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDdEMsQ0FBQztJQUVEOztPQUVHO0lBQ0ksMkJBQTJCLENBQUMsVUFBaUMsRUFBRSxnQkFBd0I7UUFDNUYsTUFBTSxTQUFTLEdBQUcsaUJBQWlCLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN4RSxNQUFNLHFCQUFxQixHQUFHLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzFELE9BQU8scUJBQXFCLENBQUMsaUJBQTJCLENBQUM7SUFDM0QsQ0FBQztJQUNPLGlCQUFpQixDQUFDLFlBQTBCO1FBQ2xELE9BQU8sWUFBWSxJQUFJLFlBQVksQ0FBQyxXQUFXLElBQUksWUFBWSxDQUFDLFdBQVcsQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDO0lBQ2pHLENBQUM7SUFDTyxVQUFVLENBQUMsYUFBaUUsRUFBRSxJQUFXLEVBQUUsZ0JBQXdCO1FBQ3pILE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUN0QixNQUFNLG9CQUFvQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBdUQsQ0FBQztZQUMxRyxPQUFPLG9CQUFvQixDQUFDLEtBQUssS0FBSyxhQUFhLENBQUMsS0FBSyxHQUFHLENBQUMsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1SCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDTyxlQUFlLENBQUMsYUFBaUUsRUFBRSxJQUFXLEVBQUUsZ0JBQXdCLEVBQUUsVUFBMkI7UUFDM0osSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDbEUsTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ2YsT0FBTyxJQUFJLEVBQUU7WUFDWCxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztZQUN0QyxJQUFJLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztTQUN4RTtRQUNELE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztJQUNPLGdCQUFnQixDQUFDLE1BQWMsRUFBRSxnQkFBd0I7UUFDL0QsT0FBTyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBQ0Q7Ozs7OztPQU1HO0lBQ0ssV0FBVyxDQUFDLFVBQWlDLEVBQUUsZ0JBQXdCLEVBQUUsRUFBVTtRQUN6RixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxFQUFFLGdCQUFnQixFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2xGLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDbEIsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELE1BQU0sS0FBSyxHQUFHLGFBQWEsQ0FBQyxLQUFLLENBQUM7UUFDbEMsTUFBTSxJQUFJLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQztRQUNoQyxNQUFNLFFBQVEsR0FBYSxVQUFVLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLENBQUMsTUFBYyxFQUFFLEVBQUU7WUFDcEYsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3RFLE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxLQUFLLEtBQUssS0FBSyxHQUFHLENBQUMsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN6RixJQUFJLE9BQU8sRUFBRTtnQkFDWCxPQUFPLE1BQU0sQ0FBQzthQUNmO2lCQUFNO2dCQUNMLE9BQU8sSUFBSSxDQUFDO2FBQ2I7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7Q0FDRjtBQUVELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IG1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBFbnRpdHksIEZpZWxkTWV0YWRhdGFVdGlsLCBGcmFtZUNvbnRleHQsIFJlcG9zaXRvcnkgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IFJlc3BvbnNlSW5mbywgQmVmUmVwb3NpdG9yeSB9IGZyb20gJ0BmYXJyaXMvYmVmJztcclxuXHJcbi8qKlxyXG4gKiDot6/lvoTmoJHku5PlupNcclxuICovXHJcbmNsYXNzIFBhdGhUcmVlUmVwb3NpdG9yeSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOWFhOW8n+iKgueCuVxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZGRTaWJsaW5nKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8RW50aXR5PiB7XHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XHJcbiAgICBjb25zdCBiYXNlVXJpID0gcmVzdFNlcnZpY2UuYmFzZVVyaTtcclxuICAgIGNvbnN0IGFkZFNpYmxpbmdVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL3BhdGhoaWVyYXJjaHljcmVhdGVzaWJsaW5nYDtcclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgIGRhdGFJRDogaWQsXHJcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcclxuICAgIH07XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBoZWFkZXJzOiBuZXcgSHR0cEhlYWRlcnMoeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0pLFxyXG4gICAgICBib2R5OiBib2R5XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZShhZGRTaWJsaW5nVXJpLCAnUFVUJywgbnVsbCwgb3B0aW9ucykucGlwZShcclxuICAgICAgbWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xyXG4gICAgICAgIGNvbnN0IGVudGl0eSA9IHJlcG9zaXRvcnkuYnVpbGRFbnRpdHkocmVzcG9uc2VJbmZvLnJldHVyblZhbHVlKTtcclxuICAgICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uYWRkRW50aXR5KGVudGl0eSk7XHJcbiAgICAgICAgcmV0dXJuIGVudGl0eTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmt7vliqDlhYTlvJ/oioLngrlcclxuICAgKi9cclxuICBwdWJsaWMgYWRkQ2hpbGQocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBwYXJlbnRJZDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XHJcbiAgICBjb25zdCBiYXNlVXJpID0gcmVzdFNlcnZpY2UuYmFzZVVyaTtcclxuICAgIGNvbnN0IGFkZENoaWxkVXJpID0gYCR7YmFzZVVyaX0vc2VydmljZS9wYXRoaGllcmFyY2h5Y3JlYXRlY2hpbGRsYXllcmA7XHJcblxyXG4gICAgY29uc3QgYm9keSA9IHtcclxuICAgICAgZGF0YUlEOiBwYXJlbnRJZCxcclxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxyXG4gICAgfTtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgIGhlYWRlcnM6IG5ldyBIdHRwSGVhZGVycyh7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSksXHJcbiAgICAgIGJvZHk6IGJvZHlcclxuICAgIH07XHJcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKGFkZENoaWxkVXJpLCAnUFVUJywgbnVsbCwgb3B0aW9ucykucGlwZShcclxuICAgICAgbWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xyXG4gICAgICAgIGNvbnN0IGVudGl0eSA9IHJlcG9zaXRvcnkuYnVpbGRFbnRpdHkocmVzcG9uc2VJbmZvLnJldHVyblZhbHVlKTtcclxuICAgICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uYWRkRW50aXR5KGVudGl0eSk7XHJcbiAgICAgICAgcmV0dXJuIGVudGl0eTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmt7vliqDlrZDooajlhYTlvJ/oioLngrlcclxuICAgKi9cclxuICBwdWJsaWMgYWRkU3ViU2libGluZyhyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIG5vZGVzOiBBcnJheTxzdHJpbmc+LCBpZHM6IEFycmF5PHN0cmluZz4pOiBPYnNlcnZhYmxlPEVudGl0eT4ge1xyXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSByZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XHJcbiAgICBjb25zdCBhZGRTdWJTaWJsaW5nVXJpID0gYCR7YmFzZVVyaX0vc2VydmljZS9jaGlsZG5vZGVwYXRoaGllcmFyY2h5Y3JlYXRlc2libGluZ2A7XHJcbiAgICBjb25zdCBib2R5ID0ge1xyXG4gICAgICBub2Rlczogbm9kZXMsXHJcbiAgICAgIGlkczogaWRzLFxyXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9KSxcclxuICAgICAgYm9keTogYm9keVxyXG4gICAgfTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UoYWRkU3ViU2libGluZ1VyaSwgJ1BVVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXHJcbiAgICAgIG1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcclxuICAgICAgICBsZXQgcGF0aCA9IHRoaXMuZ2V0UGF0aHMobm9kZXMsIGlkcyk7XHJcbiAgICAgICAgY29uc3QgZW50aXR5ID0gcmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLmFwcGVuZEVudGl0eUJ5UGF0aChwYXRoLCByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUpXHJcbiAgICAgICAgcmV0dXJuIGVudGl0eTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAqIOa3u+WKoOWtkOihqOWtkOiKgueCuVxyXG4gICovXHJcbiAgcHVibGljIGFkZFN1YkNoaWxkKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5Piwgbm9kZXM6IEFycmF5PHN0cmluZz4sIGlkczogQXJyYXk8c3RyaW5nPikge1xyXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSByZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XHJcbiAgICBjb25zdCBhZGRTdWJDaGlsZFVyaSA9IGAke2Jhc2VVcml9L3NlcnZpY2UvY2hpbGRub2RlcGF0aGhpZXJhcmNoeWNyZWF0ZWNoaWxkbGF5ZXJgO1xyXG5cclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgIG5vZGVzOiBub2RlcyxcclxuICAgICAgaWRzOiBpZHMsXHJcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcclxuICAgIH07XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBoZWFkZXJzOiBuZXcgSHR0cEhlYWRlcnMoeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0pLFxyXG4gICAgICBib2R5OiBib2R5XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZShhZGRTdWJDaGlsZFVyaSwgJ1BVVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXHJcbiAgICAgIG1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcclxuICAgICAgICBsZXQgcGF0aCA9IHRoaXMuZ2V0UGF0aHMobm9kZXMsIGlkcyk7XHJcbiAgICAgICAgY29uc3QgZW50aXR5ID0gcmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLmFwcGVuZEVudGl0eUJ5UGF0aChwYXRoLCByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUpXHJcbiAgICAgICAgcmV0dXJuIGVudGl0eTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldFBhdGhzKG5vZGVzOiBzdHJpbmdbXSwgaWRzOiBzdHJpbmdbXSkge1xyXG4gICAgbGV0IHBhdGhzID0gJyc7XHJcbiAgICBpZiAobm9kZXMgJiYgbm9kZXMubGVuZ3RoID4gMCAmJiBpZHMgJiYgaWRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpZHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBpZiAobm9kZXNbaV0pIHtcclxuICAgICAgICAgIHBhdGhzID0gcGF0aHMgKyBgLyR7aWRzW2ldfWA7XHJcbiAgICAgICAgICBwYXRocyA9IHBhdGhzICsgYC8ke25vZGVzW2ldfXNgO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHBhdGhzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yqg6L2954i26IqC54K5XHJcbiAgICovXHJcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtYXgtbGluZS1sZW5ndGhcclxuICBwdWJsaWMgbG9hZEJ5UGFyZW50SWQocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcsIHBhcmVudElkOiBzdHJpbmcsIGZpbHRlcnM6IGFueVtdLCBzb3J0czogYW55W10sIGZyb3plbkN1cnJlbnRSb3c6IGJvb2xlYW4gPSBmYWxzZSwgcGFnaW5hdGlvbj86IHsgcGFnZVNpemU6IG51bWJlciwgcGFnZUluZGV4OiBudW1iZXIgfSwgZnJhbWVDb250ZXh0PzogRnJhbWVDb250ZXh0LCByZWxvYWQ6IGJvb2xlYW4gPSBmYWxzZSk6IE9ic2VydmFibGU8RW50aXR5W10+IHtcclxuICAgIGNvbnN0IGxvY2FsRW50aXRpZXMgPSB0aGlzLmdldENoaWxkcmVuKHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9LZXksIHBhcmVudElkKTtcclxuICAgIGlmIChsb2NhbEVudGl0aWVzICYmIGxvY2FsRW50aXRpZXMubGVuZ3RoID4gMCAmJiAhcmVsb2FkKSB7XHJcbiAgICAgIHJldHVybiBvZihsb2NhbEVudGl0aWVzKTtcclxuICAgIH1cclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gcmVwb3NpdG9yeS5yZXN0U2VydmljZTtcclxuICAgIGNvbnN0IHBhcmVudEhpZXJhcmNoeUluZm8gPSB0aGlzLmdldEhpZXJhcmNoeUluZm9CeUlkKHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9LZXksIHBhcmVudElkKTtcclxuICAgIGNvbnN0IG9yaWdpbmFsSGllcmFyY2h5SW5mb0tleSA9IHRoaXMuZ2V0T3JpZ2luYWxIaWVyYXJjaHlJbmZvS2V5KHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9LZXkpO1xyXG4gICAgY29uc3QgZmlsdGVyc1dpdGhQYXJlbnQgPSB0aGlzLmJ1aWxkRmlsdGVyc1dpdGhQYXJlbnQob3JpZ2luYWxIaWVyYXJjaHlJbmZvS2V5LCBwYXJlbnRIaWVyYXJjaHlJbmZvLCBmaWx0ZXJzKTtcclxuICAgIGNvbnN0IGlzVXNlUGFnaW5hdGlvbiA9IHBhZ2luYXRpb24gJiYgcGFnaW5hdGlvbi5wYWdlU2l6ZSA+IDAgfHwgZmFsc2U7XHJcbiAgICAvLyDnu4Tnu4dFbnRpdHlGaWx0ZXJcclxuICAgIGNvbnN0IGVudGl0eUZpbHRlciA9IHtcclxuICAgICAgRmlsdGVyQ29uZGl0aW9uczogZmlsdGVyc1dpdGhQYXJlbnQsXHJcbiAgICAgIFNvcnRDb25kaXRpb25zOiBzb3J0cyxcclxuICAgICAgSXNVc2VQYWdpbmF0aW9uOiBpc1VzZVBhZ2luYXRpb24sXHJcbiAgICAgIFBhZ2luYXRpb246IHsgUGFnZUluZGV4OiBwYWdpbmF0aW9uICYmIHBhZ2luYXRpb24ucGFnZUluZGV4IHx8IDAsIFBhZ2VTaXplOiBwYWdpbmF0aW9uICYmIHBhZ2luYXRpb24ucGFnZVNpemUgfHwgMCwgUGFnZUNvdW50OiAwLCBUb3RhbENvdW50OiAwIH1cclxuICAgIH07XHJcbiAgICBjb25zdCByZXF1ZXN0SW5mbyA9IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5leHRlbmRRdWVyeShlbnRpdHlGaWx0ZXIsIHJlcXVlc3RJbmZvKS5waXBlKFxyXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgY29uc3QgcGFnaW5hdGlvbkluZm8gPSB0aGlzLmdldFBhZ2luYXRpb25JbmZvKHJlc3BvbnNlSW5mbyk7XHJcbiAgICAgICAgaWYgKHBhcmVudElkKSB7XHJcbiAgICAgICAgICBpZiAocGFnaW5hdGlvbkluZm8gJiYgcGFnaW5hdGlvbkluZm8ucGFnZVNpemUgIT09IDAgJiYgZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgICAgIGZyYW1lQ29udGV4dC5wYXJhbXMuc2V0KGBfTk9ERV8ke3BhcmVudElkfV9QQUdJTkFUSU9OX0lORk9fYCwgcGFnaW5hdGlvbkluZm8pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBpZiAocGFnaW5hdGlvbkluZm8gJiYgcGFnaW5hdGlvbkluZm8ucGFnZVNpemUgIT09IDAgJiYgZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgICAgIGZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24udXBkYXRlUGFnaW5hdGlvbkluZm9CeVBhdGgoJy8nLCBwYWdpbmF0aW9uSW5mbyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOWFiOa4heepuuS4i+e6p+WunuS9k1xyXG4gICAgICAgIHRoaXMuY2xlYXJEZXNjZW5kYW50RW50aXRpZXMocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSwgcGFyZW50SGllcmFyY2h5SW5mbywgZnJvemVuQ3VycmVudFJvdyk7XHJcbiAgICAgICAgLy8g6L+95Yqg5LiL57qn5a6e5L2TXHJcbiAgICAgICAgY29uc3QgbGlzdERhdGEgPSByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUucmVzdWx0O1xyXG4gICAgICAgIGNvbnN0IGVudGl0aWVzID0gcmVwb3NpdG9yeS5idWlsZEVudGl0aWVzKGxpc3REYXRhKTtcclxuICAgICAgICBpZiAoZnJvemVuQ3VycmVudFJvdykge1xyXG4gICAgICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmFkZERhdGEoZW50aXRpZXMsIHsgaXNUcmVlTm9kZUxvYWRTY2VuZTogdHJ1ZSB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmFkZEVudGl0aWVzKGVudGl0aWVzLCB7IGlzVHJlZU5vZGVMb2FkU2NlbmU6IHRydWUgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZW50aXRpZXM7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1heC1saW5lLWxlbmd0aFxyXG4gIHB1YmxpYyBsb2FkRnVsbFRyZWUocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcsIHBhcmVudElkOiBzdHJpbmcsIHByb3BlcnR5TmFtZTogc3RyaW5nLCBmdWxsVHJlZVR5cGU6IHN0cmluZywgbG9hZFR5cGU6IHN0cmluZywgZmlsdGVycz86IGFueVtdLCBjb250ZXh0PzogYW55KTogT2JzZXJ2YWJsZTxFbnRpdHlbXT4ge1xyXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSByZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XHJcbiAgICBjb25zdCBxdWVyeVVybCA9IGAke2Jhc2VVcml9L3NlcnZpY2UvcGFyZW50aWRmdWxsdHJlZXF1ZXJ5YDtcclxuICAgIGNvbnN0IHBhdGhIaWVyYXJjaHlJbmZvID0gdGhpcy5nZXRIaWVyYXJjaHlJbmZvQnlJZChyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZvS2V5LCBwYXJlbnRJZCk7XHJcbiAgICBjb25zdCBlbnRpdHlGaWx0ZXIgPSB0aGlzLmJ1aWxkRW50aXR5RmlsdGVyKGZpbHRlcnMsIG51bGwsIDAsIDApO1xyXG4gICAgY29uc3QgYm9keSA9IHtcclxuICAgICAgZGF0YUlkOiBwYXJlbnRJZCB8fCAnJyxcclxuICAgICAgaXNVc2VQYWdpbmF0aW9uOiBmYWxzZSxcclxuICAgICAgdmlydHVhbFByb3BlcnR5TmFtZTogcHJvcGVydHlOYW1lLFxyXG4gICAgICBwYWdpbmF0aW9uOiB7fSxcclxuICAgICAgZnVsbFRyZWVUeXBlLFxyXG4gICAgICBsb2FkVHlwZSxcclxuICAgICAgZmlsdGVyOiBlbnRpdHlGaWx0ZXIsXHJcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcclxuICAgIH07XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBib2R5OiBib2R5XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZShxdWVyeVVybCwgJ1BVVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXHJcbiAgICAgIHRhcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcclxuICAgICAgICAvLyDkv53lrZjlsZXlvIDnmoToioLngrlcclxuICAgICAgICBpZiAocmVzcG9uc2VJbmZvLnJldHVyblZhbHVlICYmIHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZS5zZWxlY3RlZFJvd0lkICYmIGNvbnRleHQgJiYgY29udGV4dC5mcmFtZUNvbnRleHQpIHtcclxuICAgICAgICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IGNvbnRleHQuZnJhbWVDb250ZXh0IGFzIEZyYW1lQ29udGV4dDtcclxuICAgICAgICAgIGNvbnN0IHZpcnR1YWxSb290RnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpIHx8IG51bGw7XHJcbiAgICAgICAgICBpZiAodmlydHVhbFJvb3RGcmFtZUNvbnRleHQpIHtcclxuICAgICAgICAgICAgY29uc3QgbGlzdCA9IHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZS5yZXN1bHQgYXMgYW55W107XHJcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkUm93SWQgPSByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUuc2VsZWN0ZWRSb3dJZDtcclxuICAgICAgICAgICAgLy8g5LuO6aG25bGC5byA5aeL6K6h566X5omA5pyJ6ZyA6KaB5bGV5byA55qE6IqC54K5XHJcbiAgICAgICAgICAgIGNvbnN0IGxlYWZOb2RlSW5mbyA9IGxpc3QuZmluZChpdGVtID0+IGl0ZW1bcmVwb3NpdG9yeS5wcmltYXJ5S2V5XSA9PT0gc2VsZWN0ZWRSb3dJZCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGhpZXJhcmNoeUluZm8gPSBsZWFmTm9kZUluZm9baGllcmFyY2h5SW5mb0tleV0gYXMgeyBpc0RldGFpbDogYm9vbGVhbiwgbGF5ZXI6IG51bWJlciwgcGF0aDogc3RyaW5nIH07XHJcbiAgICAgICAgICAgIGNvbnN0IGlkcyA9IHRoaXMuZ2V0QWxsUGFyZW50SWRzKGhpZXJhcmNoeUluZm8sIGxpc3QsIGhpZXJhcmNoeUluZm9LZXksIHJlcG9zaXRvcnkpO1xyXG4gICAgICAgICAgICB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dC5wYXJhbXMuc2V0KCdfREVWS0lUX2V4cGFuZFJvd0lkcycsIGlkcy5qb2luKCcsJykpO1xyXG4gICAgICAgICAgICB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dC5wYXJhbXMuc2V0KCdfREVWS0lUX3NlbGVjdGVkUm93SWQnLCBzZWxlY3RlZFJvd0lkKTtcclxuICAgICAgICAgICAgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQudWlTdGF0ZS5zZXRQcm9wZXJ0eVZhbHVlKCdfX0RFVktJVF9fc2VsZWN0ZWRSb3cnLCBzZWxlY3RlZFJvd0lkKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pLFxyXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZnJvemVuQ3VycmVudFJvdzogYm9vbGVhbiA9IGNvbnRleHQgJiYgY29udGV4dC5mcm96ZW5DdXJyZW50Um93IHx8IGZhbHNlO1xyXG4gICAgICAgIC8vIOWFiOa4heepuuS4i+e6p+WunuS9k1xyXG4gICAgICAgIHRoaXMuY2xlYXJEZXNjZW5kYW50RW50aXRpZXMocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSwgcGF0aEhpZXJhcmNoeUluZm8sIGZyb3plbkN1cnJlbnRSb3cpO1xyXG4gICAgICAgIC8vIOi/veWKoOS4i+e6p+WunuS9k1xyXG4gICAgICAgIGNvbnN0IGxpc3REYXRhID0gcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlLnJlc3VsdDtcclxuICAgICAgICBjb25zdCBlbnRpdGllcyA9IHJlcG9zaXRvcnkuYnVpbGRFbnRpdGllcyhsaXN0RGF0YSk7XHJcbiAgICAgICAgaWYgKGZyb3plbkN1cnJlbnRSb3cpIHtcclxuICAgICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGREYXRhKGVudGl0aWVzLCB7aXNUcmVlTm9kZUxvYWRTY2VuZTogdHJ1ZX0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uYWRkRW50aXRpZXMoZW50aXRpZXMsIHtpc1RyZWVOb2RlTG9hZFNjZW5lOiB0cnVlfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBlbnRpdGllcztcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaPkuWFpeWvueeItuiKgueCueeahOi/h+a7pFxyXG4gICAqL1xyXG4gIHB1YmxpYyBidWlsZEZpbHRlcnNXaXRoUGFyZW50KG9yaWdpbmFsSGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCBwYXJlbnRIaWVyYXJjaHlJbmZvOiBhbnksIGZpbHRlckFycmF5OiBhbnlbXSk6IGFueSB7XHJcbiAgICBjb25zdCByZWxhdGlvblR5cGUgPSBmaWx0ZXJBcnJheSAmJiBmaWx0ZXJBcnJheS5sZW5ndGggPj0gMSA/IDEgOiAwO1xyXG5cclxuICAgIGNvbnN0IHBhcmVudExheWVyID0gcGFyZW50SGllcmFyY2h5SW5mbyA/IHBhcmVudEhpZXJhcmNoeUluZm9bJ2xheWVyJ10gOiAwO1xyXG4gICAgY29uc3QgcGFyZW50RmlsdGVyQXJyYXkgPSBbXHJcbiAgICAgIHtcclxuICAgICAgICBcIkZpbHRlckZpZWxkXCI6IGAke29yaWdpbmFsSGllcmFyY2h5SW5mb0tleX0uTGF5ZXJgLFxyXG4gICAgICAgIFwiVmFsdWVcIjogcGFyZW50TGF5ZXIgKyAxLFxyXG4gICAgICAgIFwiTGJyYWNrZXRcIjogbnVsbCxcclxuICAgICAgICBcIlJicmFja2V0XCI6IG51bGwsXHJcbiAgICAgICAgXCJSZWxhdGlvblwiOiAxLFxyXG4gICAgICAgIFwiRXhwcmVzc3R5cGVcIjogMCxcclxuICAgICAgICBcIkNvbXBhcmVcIjogMFxyXG4gICAgICB9XHJcbiAgICBdO1xyXG5cclxuICAgIC8vIOeItui3r+W+hOi/h+a7pO+8jOWmguaenOS4uuepuu+8jOWImeS4jea3u+WKoO+8iOWFvOWuuW9yYWNsZeWPluaVsO+8iVxyXG4gICAgY29uc3QgcGFyZW50UGF0aCA9IHBhcmVudEhpZXJhcmNoeUluZm8gPyBwYXJlbnRIaWVyYXJjaHlJbmZvWydwYXRoJ10gOiAnJztcclxuICAgIGlmIChwYXJlbnRQYXRoKSB7XHJcbiAgICAgIHBhcmVudEZpbHRlckFycmF5LnB1c2goe1xyXG4gICAgICAgIFwiRmlsdGVyRmllbGRcIjogYCR7b3JpZ2luYWxIaWVyYXJjaHlJbmZvS2V5fS5QYXRoYCxcclxuICAgICAgICBcIlZhbHVlXCI6IHBhcmVudFBhdGgsXHJcbiAgICAgICAgXCJMYnJhY2tldFwiOiBudWxsLFxyXG4gICAgICAgIFwiUmJyYWNrZXRcIjogbnVsbCxcclxuICAgICAgICBcIlJlbGF0aW9uXCI6IHJlbGF0aW9uVHlwZSxcclxuICAgICAgICBcIkV4cHJlc3N0eXBlXCI6IDAsXHJcbiAgICAgICAgXCJDb21wYXJlXCI6IDdcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBwYXJlbnRGaWx0ZXJBcnJheVswXS5SZWxhdGlvbiA9IHJlbGF0aW9uVHlwZTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcGFyZW50RmlsdGVyQXJyYXkuY29uY2F0KGZpbHRlckFycmF5KTtcclxuICB9XHJcbiAgcHVibGljIGJ1aWxkRW50aXR5RmlsdGVyKGZpbHRlcjogYW55W10sIHNvcnQ6IGFueVtdLCBwYWdlU2l6ZTogbnVtYmVyLCBwYWdlSW5kZXg6IG51bWJlcikge1xyXG5cclxuICAgIC8vIEB0b2Rv77ya5Li05pe25YW85a656ICB5Luj56CB77yM6ZmN5L2O5pS55Yqo5bim5p2l55qE6aOO6ZmpXHJcbiAgICBpZiAoIWZpbHRlciAmJiAhc29ydCAmJiAhcGFnZVNpemUgJiYgIXBhZ2VJbmRleCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGlmICghZmlsdGVyKSB7XHJcbiAgICAgIGZpbHRlciA9IFtdO1xyXG4gICAgfVxyXG4gICAgaWYgKCFzb3J0KSB7XHJcbiAgICAgIHNvcnQgPSBbXTtcclxuICAgIH1cclxuICAgIC8vIOe6oOato+acgOWQjuS4gOS4qui/h+a7pOadoeS7tueahFJlbGF0aW9uXHJcbiAgICBpZiAoZmlsdGVyICYmIGZpbHRlci5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGZpbHRlcltmaWx0ZXIubGVuZ3RoIC0gMV0uUmVsYXRpb24gPSAwO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZW50aXR5RmlsdGVyID0ge1xyXG4gICAgICBGaWx0ZXJDb25kaXRpb25zOiBmaWx0ZXIsXHJcbiAgICAgIFNvcnRDb25kaXRpb25zOiBzb3J0LFxyXG4gICAgICBJc1VzZVBhZ2luYXRpb246IHBhZ2VTaXplID09PSAwID8gZmFsc2UgOiB0cnVlLFxyXG4gICAgICBQYWdpbmF0aW9uOiB7XHJcbiAgICAgICAgUGFnZUluZGV4OiBwYWdlSW5kZXgsXHJcbiAgICAgICAgUGFnZVNpemU6IHBhZ2VTaXplLFxyXG4gICAgICAgIFBhZ2VDb3VudDogMCxcclxuICAgICAgICBUb3RhbENvdW50OiAwXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gZW50aXR5RmlsdGVyO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmuIXnqbrlkI7ku6Plrp7kvZNcclxuICAgKi9cclxuICBwdWJsaWMgY2xlYXJEZXNjZW5kYW50RW50aXRpZXMocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBoaWVyYXJjaHlJbmZva2V5OiBzdHJpbmcsIHBhcmVudEhpZXJhcmNoeUluZm86IGFueSwgZnJvemVuQ3VycmVudFJvdzogYm9vbGVhbiA9IGZhbHNlKTogdm9pZCB7XHJcblxyXG4gICAgLy8g5riF56m65qC56IqC54K5XHJcbiAgICBpZiAoIXBhcmVudEhpZXJhcmNoeUluZm8pIHtcclxuICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmNsZWFyKCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGZQYXRoID0gcGFyZW50SGllcmFyY2h5SW5mby5wYXRoO1xyXG4gICAgY29uc3QgZkxheWVyID0gcGFyZW50SGllcmFyY2h5SW5mby5sYXllcjtcclxuICAgIGlmIChmcm96ZW5DdXJyZW50Um93KSB7XHJcbiAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5yZW1vdmVEYXRhKChlbnRpdHk6IEVudGl0eSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGhpZXJhcmNoeUluZm8gPSBlbnRpdHlbaGllcmFyY2h5SW5mb2tleV07XHJcbiAgICAgICAgY29uc3QgcGF0aCA9IGhpZXJhcmNoeUluZm8ucGF0aDtcclxuICAgICAgICBjb25zdCBsYXllciA9IGhpZXJhcmNoeUluZm8ubGF5ZXI7XHJcbiAgICAgICAgcmV0dXJuIGxheWVyID4gZkxheWVyICYmIHBhdGguc3RhcnRzV2l0aChmUGF0aCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLnJlbW92ZUVudGl0aWVzKChlbnRpdHk6IEVudGl0eSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGhpZXJhcmNoeUluZm8gPSBlbnRpdHlbaGllcmFyY2h5SW5mb2tleV07XHJcbiAgICAgICAgY29uc3QgcGF0aCA9IGhpZXJhcmNoeUluZm8ucGF0aDtcclxuICAgICAgICBjb25zdCBsYXllciA9IGhpZXJhcmNoeUluZm8ubGF5ZXI7XHJcbiAgICAgICAgcmV0dXJuIGxheWVyID4gZkxheWVyICYmIHBhdGguc3RhcnRzV2l0aChmUGF0aCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWunuS9k+eahOWIhue6p+S/oeaBr1xyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRIaWVyYXJjaHlJbmZvQnlJZChyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9rZXk6IHN0cmluZywgaWQ6IHN0cmluZyk6IGFueSB7XHJcbiAgICBpZiAoIWlkKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZW50aXR5OiBFbnRpdHkgPSByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChpZCk7XHJcbiAgICBjb25zdCBoaWVyYXJjaHlJbmZvRW50aXR5OiBFbnRpdHkgPSBlbnRpdHlbaGllcmFyY2h5SW5mb2tleV07XHJcbiAgICByZXR1cm4gaGllcmFyY2h5SW5mb0VudGl0eS50b0pTT04oKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWIhue6p+eggeeahOWOn+Wni+eahOWtl+auteWQjVxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRPcmlnaW5hbEhpZXJhcmNoeUluZm9LZXkocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBoaWVyYXJjaHlJbmZva2V5OiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgbmdPYmplY3RzID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdPYmplY3RzKHJlcG9zaXRvcnkuZW50aXR5VHlwZSk7XHJcbiAgICBjb25zdCBoaWVyYXJjaHlJbmZvTmdPYmplY3QgPSBuZ09iamVjdHNbaGllcmFyY2h5SW5mb2tleV07XHJcbiAgICByZXR1cm4gaGllcmFyY2h5SW5mb05nT2JqZWN0Lm9yaWdpbmFsRGF0YUZpZWxkIGFzIHN0cmluZztcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRQYWdpbmF0aW9uSW5mbyhyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykge1xyXG4gICAgcmV0dXJuIHJlc3BvbnNlSW5mbyAmJiByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUgJiYgcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlLnBhZ2luYXRpb24gfHwgbnVsbDtcclxuICB9XHJcbiAgcHJpdmF0ZSBmaW5kUGFyZW50KGhpZXJhcmNoeUluZm86IHsgaXNEZXRhaWw6IGJvb2xlYW4sIGxheWVyOiBudW1iZXIsIHBhdGg6IHN0cmluZyB9LCBsaXN0OiBhbnlbXSwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gbGlzdC5maW5kKGl0ZW0gPT4ge1xyXG4gICAgICBjb25zdCBjdXJyZW50SGllcmFyY2h5SW5mbyA9IGl0ZW1baGllcmFyY2h5SW5mb0tleV0gYXMgeyBpc0RldGFpbDogYm9vbGVhbiwgbGF5ZXI6IG51bWJlciwgcGF0aDogc3RyaW5nIH07XHJcbiAgICAgIHJldHVybiBjdXJyZW50SGllcmFyY2h5SW5mby5sYXllciA9PT0gaGllcmFyY2h5SW5mby5sYXllciAtIDEgJiYgaGllcmFyY2h5SW5mby5wYXRoLnN0YXJ0c1dpdGgoY3VycmVudEhpZXJhcmNoeUluZm8ucGF0aCk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRBbGxQYXJlbnRJZHMoaGllcmFyY2h5SW5mbzogeyBpc0RldGFpbDogYm9vbGVhbiwgbGF5ZXI6IG51bWJlciwgcGF0aDogc3RyaW5nIH0sIGxpc3Q6IGFueVtdLCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcsIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55Pikge1xyXG4gICAgbGV0IGl0ZW0gPSB0aGlzLmZpbmRQYXJlbnQoaGllcmFyY2h5SW5mbywgbGlzdCwgaGllcmFyY2h5SW5mb0tleSk7XHJcbiAgICBjb25zdCBpZHMgPSBbXTtcclxuICAgIHdoaWxlIChpdGVtKSB7XHJcbiAgICAgIGlkcy5wdXNoKGl0ZW1bcmVwb3NpdG9yeS5wcmltYXJ5S2V5XSk7XHJcbiAgICAgIGl0ZW0gPSB0aGlzLmZpbmRQYXJlbnQoaXRlbVtoaWVyYXJjaHlJbmZvS2V5XSwgbGlzdCwgaGllcmFyY2h5SW5mb0tleSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaWRzO1xyXG4gIH1cclxuICBwcml2YXRlIGdldEhpZXJhcmNoeUluZm8oZW50aXR5OiBFbnRpdHksIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZyk6IHsgcGF0aDogc3RyaW5nLCBsYXllcjogbnVtYmVyLCBpc0RldGFpbDogYm9vbGVhbiB9IHtcclxuICAgIHJldHVybiBlbnRpdHlbaGllcmFyY2h5SW5mb0tleV07XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOafpeaJvuiKgueCueS4i+aJgOacieWtkOe6p++8iOesrOS4gOe6p++8iVxyXG4gICAqIEBwYXJhbSByZXBvc2l0b3J5IHJlcG9zaXRvcnlcclxuICAgKiBAcGFyYW0gaGllcmFyY2h5SW5mb0tleSDliIbnuqfnoIHlrZfmrrVcclxuICAgKiBAcGFyYW0gaWQgaWRcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwcml2YXRlIGdldENoaWxkcmVuKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCBpZDogc3RyaW5nKTogRW50aXR5W10ge1xyXG4gICAgY29uc3QgaGllcmFyY2h5SW5mbyA9IHRoaXMuZ2V0SGllcmFyY2h5SW5mb0J5SWQocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSwgaWQpO1xyXG4gICAgaWYgKCFoaWVyYXJjaHlJbmZvKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgbGF5ZXIgPSBoaWVyYXJjaHlJbmZvLmxheWVyO1xyXG4gICAgY29uc3QgcGF0aCA9IGhpZXJhcmNoeUluZm8ucGF0aDtcclxuICAgIGNvbnN0IGVudGl0aWVzOiBFbnRpdHlbXSA9IHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdGllcygoZW50aXR5OiBFbnRpdHkpID0+IHtcclxuICAgICAgY29uc3QgaGllcmFyY2h5SW5mbyA9IHRoaXMuZ2V0SGllcmFyY2h5SW5mbyhlbnRpdHksIGhpZXJhcmNoeUluZm9LZXkpO1xyXG4gICAgICBjb25zdCBtYXRjaGVkID0gaGllcmFyY2h5SW5mby5sYXllciA9PT0gbGF5ZXIgKyAxICYmIGhpZXJhcmNoeUluZm8ucGF0aC5zdGFydHNXaXRoKHBhdGgpO1xyXG4gICAgICBpZiAobWF0Y2hlZCkge1xyXG4gICAgICAgIHJldHVybiBlbnRpdHk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGVudGl0aWVzO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgUGF0aFRyZWVSZXBvc2l0b3J5IH07XHJcbiJdfQ==