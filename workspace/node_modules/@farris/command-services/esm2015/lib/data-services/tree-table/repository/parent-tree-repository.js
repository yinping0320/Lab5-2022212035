import { HttpHeaders } from '@angular/common/http';
import { of } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { FieldMetadataUtil } from '@farris/devkit';
/**
 * 父子树仓库
 */
class ParentTreeRepository {
    /**
     * 添加兄弟节点
     */
    addSibling(repository, id) {
        const restService = repository.restService;
        const baseUri = restService.baseUri;
        const addSiblingUri = `${baseUri}/service/parenthierarchycreatesibling`;
        const body = {
            dataID: id,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSiblingUri, 'PUT', null, options).pipe(map((responseInfo) => {
            const entity = repository.buildEntity(responseInfo.returnValue);
            repository.entityCollection.addEntity(entity);
            return entity;
        }));
    }
    /**
     * 添加兄弟节点
     */
    addChild(repository, parentId) {
        const restService = repository.restService;
        const baseUri = restService.baseUri;
        const addChildUri = `${baseUri}/service/parenthierarchycreatechildlayer`;
        const body = {
            dataID: parentId,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addChildUri, 'PUT', null, options).pipe(map((responseInfo) => {
            const entity = repository.buildEntity(responseInfo.returnValue);
            repository.entityCollection.addEntity(entity);
            return entity;
        }));
    }
    /**
     * 添加子表兄弟节点
     */
    addSubSibling(repository, nodes, ids) {
        const restService = repository.restService;
        const baseUri = restService.baseUri;
        const addSubSiblingUri = `${baseUri}/service/childnodeparenthierarchycreatesibling`;
        const body = {
            nodes: nodes,
            ids: ids,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSubSiblingUri, 'PUT', null, options).pipe(map((responseInfo) => {
            let path = this.getPaths(nodes, ids);
            const entity = repository.entityManager.appendEntityByPath(path, responseInfo.returnValue);
            return entity;
        }));
    }
    /**
     * 添加子表子节点
     */
    addSubChild(repository, nodes, ids) {
        const restService = repository.restService;
        const baseUri = restService.baseUri;
        const addSubChildUri = `${baseUri}/service/childnodeparenthierarchycreatechildlayer`;
        const body = {
            nodes: nodes,
            ids: ids,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSubChildUri, 'PUT', null, options).pipe(map((responseInfo) => {
            let paths = this.getPaths(nodes, ids);
            const entity = repository.entityManager.appendEntityByPath(paths, responseInfo.returnValue);
            return entity;
        }));
    }
    getPaths(nodes, ids) {
        let paths = '';
        if (nodes && nodes.length > 0 && ids && ids.length > 0) {
            for (let i = 0; i < ids.length; i++) {
                if (nodes[i]) {
                    paths = paths + `/${ids[i]}`;
                    paths = paths + `/${nodes[i]}s`;
                }
            }
        }
        return paths;
    }
    /**
     * 加载父节点
     */
    // tslint:disable-next-line: max-line-length
    loadByParentId(repository, hierarchyInfoKey, parentId, filters, sorts, frozenCurrentRow = false, pagination, frameContext, reload = false) {
        const localEntities = this.getChildren(repository, hierarchyInfoKey, parentId);
        if (localEntities && localEntities.length > 0 && !reload) {
            return of(localEntities);
        }
        const restService = repository.restService;
        const parentHierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, parentId);
        const originalHierarchyInfoKey = this.getOriginalHierarchyInfoKey(repository, hierarchyInfoKey);
        const filtersWithParent = this.buildFiltersWithParent(originalHierarchyInfoKey, parentHierarchyInfo, filters);
        const isUsePagination = pagination && pagination.pageSize > 0 || false;
        // 组织EntityFilter
        const entityFilter = {
            FilterConditions: filtersWithParent,
            SortConditions: sorts,
            IsUsePagination: isUsePagination,
            Pagination: { PageIndex: pagination && pagination.pageIndex || 0, PageSize: pagination && pagination.pageSize || 0, PageCount: 0, TotalCount: 0 }
        };
        const requestInfo = restService.buildRequestInfo();
        return restService.extendQuery(entityFilter, requestInfo).pipe(map((responseInfo) => {
            const paginationInfo = this.getPaginationInfo(responseInfo);
            if (parentId) {
                if (paginationInfo && paginationInfo.pageSize !== 0 && frameContext) {
                    frameContext.params.set(`_NODE_${parentId}_PAGINATION_INFO_`, paginationInfo);
                }
            }
            else {
                if (paginationInfo && paginationInfo.pageSize !== 0 && frameContext) {
                    frameContext.repository.entityCollection.updatePaginationInfoByPath('/', paginationInfo);
                }
            }
            // 先清空下级实体
            this.clearDescendantEntities(repository, hierarchyInfoKey, parentHierarchyInfo, frozenCurrentRow);
            // 追加下级实体
            const listData = responseInfo.returnValue.result;
            const entities = repository.buildEntities(listData);
            if (frozenCurrentRow) {
                repository.entityCollection.addData(entities, { isTreeNodeLoadScene: true });
            }
            else {
                repository.entityCollection.addEntities(entities, { isTreeNodeLoadScene: true });
            }
            return entities;
        }));
    }
    // tslint:disable-next-line: max-line-length
    loadFullTree(repository, hierarchyInfoKey, parentId, propertyName, fullTreeType, loadType, filters, context) {
        const restService = repository.restService;
        const baseUri = restService.baseUri;
        const queryUrl = `${baseUri}/service/parentidfulltreequery`;
        const parentHierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, parentId);
        const entityFilter = this.buildEntityFilter(filters, null, 0, 0);
        const body = {
            dataId: parentId || '',
            isUsePagination: false,
            virtualPropertyName: propertyName,
            pagination: {},
            fullTreeType,
            loadType,
            filter: entityFilter,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            body: body
        };
        return restService.invoke(queryUrl, 'PUT', null, options).pipe(tap((responseInfo) => {
            // 保存展开的节点
            if (responseInfo.returnValue && responseInfo.returnValue.selectedRowId && context && context.frameContext) {
                const frameContext = context.frameContext;
                const virtualRootFrameContext = frameContext && frameContext.getVirtualRootFrameContext() || null;
                if (virtualRootFrameContext) {
                    const list = responseInfo.returnValue.result;
                    const selectedRowId = responseInfo.returnValue.selectedRowId;
                    // 从顶层开始计算所有需要展开的节点
                    const leafNodeInfo = list.find(item => item[repository.primaryKey] === selectedRowId);
                    const hierarchyInfo = leafNodeInfo[hierarchyInfoKey];
                    const ids = this.getAllParentIds(hierarchyInfo, list, hierarchyInfoKey, repository);
                    virtualRootFrameContext.params.set('_DEVKIT_expandRowIds', ids.join(','));
                    virtualRootFrameContext.params.set('_DEVKIT_selectedRowId', selectedRowId);
                    virtualRootFrameContext.uiState.setPropertyValue('__DEVKIT__selectedRow', selectedRowId);
                }
            }
        }), map((responseInfo) => {
            const frozenCurrentRow = context && context.frozenCurrentRow || false;
            // 先清空下级实体
            this.clearDescendantEntities(repository, hierarchyInfoKey, parentHierarchyInfo, frozenCurrentRow);
            // 追加下级实体
            const listData = responseInfo.returnValue.result;
            const entities = repository.buildEntities(listData);
            if (frozenCurrentRow) {
                repository.entityCollection.addData(entities, { isTreeNodeLoadScene: true });
            }
            else {
                repository.entityCollection.addEntities(entities, { isTreeNodeLoadScene: true });
            }
            return entities;
        }));
    }
    /**
     * 插入对父节点的过滤
     */
    buildFiltersWithParent(originalHierarchyInfoKey, parentHierarchyInfo, filterArray) {
        const relationType = filterArray && filterArray.length >= 1 ? 1 : 0;
        const parentLayer = parentHierarchyInfo ? parentHierarchyInfo['layer'] : 0;
        const parentElement = parentHierarchyInfo ? parentHierarchyInfo['id'] : '';
        const parentFilterArray = [
            {
                "FilterField": `${originalHierarchyInfoKey}.Layer`,
                "Value": parentLayer + 1,
                "Lbracket": null,
                "Rbracket": null,
                "Relation": 1,
                "Expresstype": 0,
                "Compare": 0
            }
        ];
        if (parentElement) {
            parentFilterArray.push({
                "FilterField": `${originalHierarchyInfoKey}.ParentElement`,
                "Value": parentElement,
                "Lbracket": null,
                "Rbracket": null,
                "Relation": relationType,
                "Expresstype": 0,
                "Compare": 0
            });
        }
        else {
            parentFilterArray[0].Relation = relationType;
        }
        return parentFilterArray.concat(filterArray);
    }
    buildEntityFilter(filter, sort, pageSize, pageIndex) {
        // @todo：临时兼容老代码，降低改动带来的风险
        if (!filter && !sort && !pageSize && !pageIndex) {
            return null;
        }
        if (!filter) {
            filter = [];
        }
        if (!sort) {
            sort = [];
        }
        // 纠正最后一个过滤条件的Relation
        if (filter && filter.length > 0) {
            filter[filter.length - 1].Relation = 0;
        }
        const entityFilter = {
            FilterConditions: filter,
            SortConditions: sort,
            IsUsePagination: pageSize === 0 ? false : true,
            Pagination: {
                PageIndex: pageIndex,
                PageSize: pageSize,
                PageCount: 0,
                TotalCount: 0
            }
        };
        return entityFilter;
    }
    /**
     * 清空后代实体
     * @description parentHierarchyInfo中layer为要清空后代节点的layer，但里面的parentElement不是父级的id，而是要清空后代节点的id
     */
    clearDescendantEntities(repository, hierarchyInfokey, parentHierarchyInfo, frozenCurrentRow = false) {
        // 清空根节点
        if (!parentHierarchyInfo) {
            repository.entityCollection.clear();
            return;
        }
        const nodes = this.getChildNodes(repository, hierarchyInfokey, parentHierarchyInfo);
        if (frozenCurrentRow) {
            repository.entityCollection.removeEntities((entity) => {
                const id = entity[entity.primaryKey];
                return nodes.includes(id);
            });
        }
        else {
            repository.entityCollection.removeData((entity) => {
                const id = entity[entity.primaryKey];
                return nodes.includes(id);
            });
        }
    }
    /**
     * 获取某个节点的所有子节点
     * @param repository repository
     * @param hierarchyInfokey hierarchyInfokey
     * @param parentHierarchyInfo parentHierarchyInfo
     */
    getChildNodes(repository, hierarchyInfokey, parentHierarchyInfo) {
        const fparentElement = parentHierarchyInfo.id;
        const flayer = parentHierarchyInfo.layer;
        let nodes = [];
        repository.entityCollection.getAllEntities().forEach(entity => {
            const hierarchyInfo = entity[hierarchyInfokey];
            const parentElement = hierarchyInfo.parentElement;
            const layer = hierarchyInfo.layer;
            const result = layer >= (flayer + 1) && parentElement === fparentElement;
            if (result) {
                const id = entity[entity.primaryKey];
                nodes.push(id);
                const childHierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfokey, id);
                const childs = this.getChildNodes(repository, hierarchyInfokey, childHierarchyInfo);
                if (childs && childs.length > 0) {
                    nodes = nodes.concat(childs);
                }
            }
        });
        return nodes;
    }
    /**
     * 获取实体的分级信息
     */
    getHierarchyInfoById(repository, hierarchyInfokey, id) {
        if (!id) {
            return null;
        }
        const entity = repository.entityCollection.getEntityById(id);
        const hierarchyInfoEntity = entity[hierarchyInfokey];
        const result = hierarchyInfoEntity.toJSON();
        result['id'] = id;
        return result;
    }
    getHierarchyInfo(entity, hierarchyInfokey) {
        return entity[hierarchyInfokey];
    }
    /**
     * 获取分级码的原始的字段名
     */
    getOriginalHierarchyInfoKey(repository, hierarchyInfokey) {
        const ngObjects = FieldMetadataUtil.getNgObjects(repository.entityType);
        const hierarchyInfoNgObject = ngObjects[hierarchyInfokey];
        return hierarchyInfoNgObject.originalDataField;
    }
    getPaginationInfo(responseInfo) {
        return responseInfo && responseInfo.returnValue && responseInfo.returnValue.pagination || null;
    }
    findParent(hierarchyInfo, list, hierarchyInfoKey) {
        return list.find(item => {
            const currentHierarchyInfo = item[hierarchyInfoKey];
            return currentHierarchyInfo.layer === hierarchyInfo.layer - 1 && hierarchyInfo.parentElement === currentHierarchyInfo.parentElement;
        });
    }
    getAllParentIds(hierarchyInfo, list, hierarchyInfoKey, repository) {
        let item = this.findParent(hierarchyInfo, list, hierarchyInfoKey);
        const ids = [];
        while (item) {
            ids.push(item[repository.primaryKey]);
            item = this.findParent(item[hierarchyInfoKey], list, hierarchyInfoKey);
        }
        return ids;
    }
    /**
     * 查找节点下所有子级（第一级）
     * @param repository repository
     * @param hierarchyInfoKey 分级码字段
     * @param id id
     * @returns
     */
    getChildren(repository, hierarchyInfoKey, id) {
        const hierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, id);
        if (!hierarchyInfo) {
            return null;
        }
        const layer = hierarchyInfo.layer;
        const parentElement = hierarchyInfo.parentElement;
        const entities = repository.entityCollection.getEntities((entity) => {
            const hierarchyInfo = this.getHierarchyInfo(entity, hierarchyInfoKey);
            const matched = hierarchyInfo.layer === layer + 1 && (hierarchyInfo.parentElement === parentElement || !parentElement && !hierarchyInfo.parentElement);
            if (matched) {
                return entity;
            }
            else {
                return null;
            }
        });
        return entities;
    }
}
export { ParentTreeRepository };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyZW50LXRyZWUtcmVwb3NpdG9yeS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9kYXRhLXNlcnZpY2VzL3RyZWUtdGFibGUvcmVwb3NpdG9yeS9wYXJlbnQtdHJlZS1yZXBvc2l0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNuRCxPQUFPLEVBQUUsRUFBRSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUMsT0FBTyxFQUFVLGlCQUFpQixFQUE0QixNQUFNLGdCQUFnQixDQUFDO0FBR3JGOztHQUVHO0FBQ0gsTUFBTSxvQkFBb0I7SUFFeEI7O09BRUc7SUFDSSxVQUFVLENBQUMsVUFBaUMsRUFBRSxFQUFVO1FBQzdELE1BQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUM7UUFDM0MsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUNwQyxNQUFNLGFBQWEsR0FBRyxHQUFHLE9BQU8sdUNBQXVDLENBQUM7UUFDeEUsTUFBTSxJQUFJLEdBQUc7WUFDWCxNQUFNLEVBQUUsRUFBRTtZQUNWLFdBQVcsRUFBRSxXQUFXLENBQUMsZ0JBQWdCLEVBQUU7U0FDNUMsQ0FBQztRQUNGLE1BQU0sT0FBTyxHQUFHO1lBQ2QsT0FBTyxFQUFFLElBQUksV0FBVyxDQUFDLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLENBQUM7WUFDaEUsSUFBSSxFQUFFLElBQUk7U0FDWCxDQUFDO1FBQ0YsT0FBTyxXQUFXLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDakUsR0FBRyxDQUFDLENBQUMsWUFBMEIsRUFBRSxFQUFFO1lBQ2pD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QUFLLENBQUM7UUFDbEMsTUFBTSxhQUFhLEdBQUcsYUFBYSxDQUFDLGFBQWEsQ0FBQztRQUNsRCxNQUFNLFFBQVEsR0FBYSxVQUFVLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLENBQUMsTUFBYyxFQUFFLEVBQUU7WUFDcEYsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3RFLE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxLQUFLLEtBQUssS0FBSyxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxhQUFhLEtBQUssYUFBYSxJQUFJLENBQUMsYUFBYSxJQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQ3ZKLElBQUksT0FBTyxFQUFFO2dCQUNYLE9BQU8sTUFBTSxDQUFDO2FBQ2Y7aUJBQU07Z0JBQ0wsT0FBTyxJQUFJLENBQUM7YUFDYjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztDQUNGO0FBRUQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHsgb2YsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgbWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEVudGl0eSwgRmllbGRNZXRhZGF0YVV0aWwsIEZyYW1lQ29udGV4dCwgUmVwb3NpdG9yeSB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgUmVzcG9uc2VJbmZvLCBCZWZSZXBvc2l0b3J5IH0gZnJvbSAnQGZhcnJpcy9iZWYnO1xyXG5cclxuLyoqXHJcbiAqIOeItuWtkOagkeS7k+W6k1xyXG4gKi9cclxuY2xhc3MgUGFyZW50VHJlZVJlcG9zaXRvcnkge1xyXG5cclxuICAvKipcclxuICAgKiDmt7vliqDlhYTlvJ/oioLngrlcclxuICAgKi9cclxuICBwdWJsaWMgYWRkU2libGluZyhyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEVudGl0eT4ge1xyXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSByZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XHJcbiAgICBjb25zdCBhZGRTaWJsaW5nVXJpID0gYCR7YmFzZVVyaX0vc2VydmljZS9wYXJlbnRoaWVyYXJjaHljcmVhdGVzaWJsaW5nYDtcclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgIGRhdGFJRDogaWQsXHJcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcclxuICAgIH07XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBoZWFkZXJzOiBuZXcgSHR0cEhlYWRlcnMoeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0pLFxyXG4gICAgICBib2R5OiBib2R5XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZShhZGRTaWJsaW5nVXJpLCAnUFVUJywgbnVsbCwgb3B0aW9ucykucGlwZShcclxuICAgICAgbWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xyXG4gICAgICAgIGNvbnN0IGVudGl0eSA9IHJlcG9zaXRvcnkuYnVpbGRFbnRpdHkocmVzcG9uc2VJbmZvLnJldHVyblZhbHVlKTtcclxuICAgICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uYWRkRW50aXR5KGVudGl0eSk7XHJcbiAgICAgICAgcmV0dXJuIGVudGl0eTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmt7vliqDlhYTlvJ/oioLngrlcclxuICAgKi9cclxuICBwdWJsaWMgYWRkQ2hpbGQocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBwYXJlbnRJZDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XHJcbiAgICBjb25zdCBiYXNlVXJpID0gcmVzdFNlcnZpY2UuYmFzZVVyaTtcclxuICAgIGNvbnN0IGFkZENoaWxkVXJpID0gYCR7YmFzZVVyaX0vc2VydmljZS9wYXJlbnRoaWVyYXJjaHljcmVhdGVjaGlsZGxheWVyYDtcclxuXHJcbiAgICBjb25zdCBib2R5ID0ge1xyXG4gICAgICBkYXRhSUQ6IHBhcmVudElkLFxyXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9KSxcclxuICAgICAgYm9keTogYm9keVxyXG4gICAgfTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UoYWRkQ2hpbGRVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxyXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZW50aXR5ID0gcmVwb3NpdG9yeS5idWlsZEVudGl0eShyZXNwb25zZUluZm8ucmV0dXJuVmFsdWUpO1xyXG4gICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdHkoZW50aXR5KTtcclxuICAgICAgICByZXR1cm4gZW50aXR5O1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOWtkOihqOWFhOW8n+iKgueCuVxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZGRTdWJTaWJsaW5nKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5Piwgbm9kZXM6IEFycmF5PHN0cmluZz4sIGlkczogQXJyYXk8c3RyaW5nPik6IE9ic2VydmFibGU8RW50aXR5PiB7XHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XHJcbiAgICBjb25zdCBiYXNlVXJpID0gcmVzdFNlcnZpY2UuYmFzZVVyaTtcclxuICAgIGNvbnN0IGFkZFN1YlNpYmxpbmdVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL2NoaWxkbm9kZXBhcmVudGhpZXJhcmNoeWNyZWF0ZXNpYmxpbmdgO1xyXG4gICAgY29uc3QgYm9keSA9IHtcclxuICAgICAgbm9kZXM6IG5vZGVzLFxyXG4gICAgICBpZHM6IGlkcyxcclxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxyXG4gICAgfTtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgIGhlYWRlcnM6IG5ldyBIdHRwSGVhZGVycyh7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSksXHJcbiAgICAgIGJvZHk6IGJvZHlcclxuICAgIH07XHJcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKGFkZFN1YlNpYmxpbmdVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxyXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgbGV0IHBhdGggPSB0aGlzLmdldFBhdGhzKG5vZGVzLCBpZHMpO1xyXG4gICAgICAgIGNvbnN0IGVudGl0eSA9IHJlcG9zaXRvcnkuZW50aXR5TWFuYWdlci5hcHBlbmRFbnRpdHlCeVBhdGgocGF0aCwgcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlKVxyXG4gICAgICAgIHJldHVybiBlbnRpdHk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5re75Yqg5a2Q6KGo5a2Q6IqC54K5XHJcbiAgICovXHJcbiAgcHVibGljIGFkZFN1YkNoaWxkKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5Piwgbm9kZXM6IEFycmF5PHN0cmluZz4sIGlkczogQXJyYXk8c3RyaW5nPikge1xyXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSByZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XHJcbiAgICBjb25zdCBhZGRTdWJDaGlsZFVyaSA9IGAke2Jhc2VVcml9L3NlcnZpY2UvY2hpbGRub2RlcGFyZW50aGllcmFyY2h5Y3JlYXRlY2hpbGRsYXllcmA7XHJcblxyXG4gICAgY29uc3QgYm9keSA9IHtcclxuICAgICAgbm9kZXM6IG5vZGVzLFxyXG4gICAgICBpZHM6IGlkcyxcclxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxyXG4gICAgfTtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgIGhlYWRlcnM6IG5ldyBIdHRwSGVhZGVycyh7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSksXHJcbiAgICAgIGJvZHk6IGJvZHlcclxuICAgIH07XHJcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKGFkZFN1YkNoaWxkVXJpLCAnUFVUJywgbnVsbCwgb3B0aW9ucykucGlwZShcclxuICAgICAgbWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xyXG4gICAgICAgIGxldCBwYXRocyA9IHRoaXMuZ2V0UGF0aHMobm9kZXMsIGlkcyk7XHJcbiAgICAgICAgY29uc3QgZW50aXR5ID0gcmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLmFwcGVuZEVudGl0eUJ5UGF0aChwYXRocywgcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlKTtcclxuICAgICAgICByZXR1cm4gZW50aXR5O1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0UGF0aHMobm9kZXM6IHN0cmluZ1tdLCBpZHM6IHN0cmluZ1tdKSB7XHJcbiAgICBsZXQgcGF0aHMgPSAnJztcclxuICAgIGlmIChub2RlcyAmJiBub2Rlcy5sZW5ndGggPiAwICYmIGlkcyAmJiBpZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGlkcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGlmIChub2Rlc1tpXSkge1xyXG4gICAgICAgICAgcGF0aHMgPSBwYXRocyArIGAvJHtpZHNbaV19YDtcclxuICAgICAgICAgIHBhdGhzID0gcGF0aHMgKyBgLyR7bm9kZXNbaV19c2A7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcGF0aHM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliqDovb3niLboioLngrlcclxuICAgKi9cclxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1heC1saW5lLWxlbmd0aFxyXG4gIHB1YmxpYyBsb2FkQnlQYXJlbnRJZChyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgcGFyZW50SWQ6IHN0cmluZywgZmlsdGVyczogYW55W10sIHNvcnRzOiBhbnlbXSwgZnJvemVuQ3VycmVudFJvdzogYm9vbGVhbiA9IGZhbHNlLCBwYWdpbmF0aW9uPzogeyBwYWdlU2l6ZTogbnVtYmVyLCBwYWdlSW5kZXg6IG51bWJlciB9LCBmcmFtZUNvbnRleHQ/OiBGcmFtZUNvbnRleHQsIHJlbG9hZDogYm9vbGVhbiA9IGZhbHNlKTogT2JzZXJ2YWJsZTxFbnRpdHlbXT4ge1xyXG4gICAgY29uc3QgbG9jYWxFbnRpdGllcyA9IHRoaXMuZ2V0Q2hpbGRyZW4ocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSwgcGFyZW50SWQpO1xyXG4gICAgaWYgKGxvY2FsRW50aXRpZXMgJiYgbG9jYWxFbnRpdGllcy5sZW5ndGggPiAwICYmICFyZWxvYWQpIHtcclxuICAgICAgcmV0dXJuIG9mKGxvY2FsRW50aXRpZXMpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSByZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgcGFyZW50SGllcmFyY2h5SW5mbyA9IHRoaXMuZ2V0SGllcmFyY2h5SW5mb0J5SWQocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSwgcGFyZW50SWQpO1xyXG4gICAgY29uc3Qgb3JpZ2luYWxIaWVyYXJjaHlJbmZvS2V5ID0gdGhpcy5nZXRPcmlnaW5hbEhpZXJhcmNoeUluZm9LZXkocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSk7XHJcbiAgICBjb25zdCBmaWx0ZXJzV2l0aFBhcmVudCA9IHRoaXMuYnVpbGRGaWx0ZXJzV2l0aFBhcmVudChvcmlnaW5hbEhpZXJhcmNoeUluZm9LZXksIHBhcmVudEhpZXJhcmNoeUluZm8sIGZpbHRlcnMpO1xyXG4gICAgY29uc3QgaXNVc2VQYWdpbmF0aW9uID0gcGFnaW5hdGlvbiAmJiBwYWdpbmF0aW9uLnBhZ2VTaXplID4gMCB8fCBmYWxzZTtcclxuICAgIC8vIOe7hOe7h0VudGl0eUZpbHRlclxyXG4gICAgY29uc3QgZW50aXR5RmlsdGVyID0ge1xyXG4gICAgICBGaWx0ZXJDb25kaXRpb25zOiBmaWx0ZXJzV2l0aFBhcmVudCxcclxuICAgICAgU29ydENvbmRpdGlvbnM6IHNvcnRzLFxyXG4gICAgICBJc1VzZVBhZ2luYXRpb246IGlzVXNlUGFnaW5hdGlvbixcclxuICAgICAgUGFnaW5hdGlvbjogeyBQYWdlSW5kZXg6IHBhZ2luYXRpb24gJiYgcGFnaW5hdGlvbi5wYWdlSW5kZXggfHwgMCwgUGFnZVNpemU6IHBhZ2luYXRpb24gJiYgcGFnaW5hdGlvbi5wYWdlU2l6ZSB8fCAwLCBQYWdlQ291bnQ6IDAsIFRvdGFsQ291bnQ6IDAgfVxyXG4gICAgfTtcclxuICAgIGNvbnN0IHJlcXVlc3RJbmZvID0gcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpO1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmV4dGVuZFF1ZXJ5KGVudGl0eUZpbHRlciwgcmVxdWVzdEluZm8pLnBpcGUoXHJcbiAgICAgIG1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcclxuICAgICAgICBjb25zdCBwYWdpbmF0aW9uSW5mbyA9IHRoaXMuZ2V0UGFnaW5hdGlvbkluZm8ocmVzcG9uc2VJbmZvKTtcclxuICAgICAgICBpZiAocGFyZW50SWQpIHtcclxuICAgICAgICAgIGlmIChwYWdpbmF0aW9uSW5mbyAmJiBwYWdpbmF0aW9uSW5mby5wYWdlU2l6ZSAhPT0gMCAmJiBmcmFtZUNvbnRleHQpIHtcclxuICAgICAgICAgICAgZnJhbWVDb250ZXh0LnBhcmFtcy5zZXQoYF9OT0RFXyR7cGFyZW50SWR9X1BBR0lOQVRJT05fSU5GT19gLCBwYWdpbmF0aW9uSW5mbyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGlmIChwYWdpbmF0aW9uSW5mbyAmJiBwYWdpbmF0aW9uSW5mby5wYWdlU2l6ZSAhPT0gMCAmJiBmcmFtZUNvbnRleHQpIHtcclxuICAgICAgICAgICAgZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi51cGRhdGVQYWdpbmF0aW9uSW5mb0J5UGF0aCgnLycsIHBhZ2luYXRpb25JbmZvKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5YWI5riF56m65LiL57qn5a6e5L2TXHJcbiAgICAgICAgdGhpcy5jbGVhckRlc2NlbmRhbnRFbnRpdGllcyhyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZvS2V5LCBwYXJlbnRIaWVyYXJjaHlJbmZvLCBmcm96ZW5DdXJyZW50Um93KTtcclxuICAgICAgICAvLyDov73liqDkuIvnuqflrp7kvZNcclxuICAgICAgICBjb25zdCBsaXN0RGF0YSA9IHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZS5yZXN1bHQ7XHJcbiAgICAgICAgY29uc3QgZW50aXRpZXMgPSByZXBvc2l0b3J5LmJ1aWxkRW50aXRpZXMobGlzdERhdGEpO1xyXG4gICAgICAgIGlmIChmcm96ZW5DdXJyZW50Um93KSB7XHJcbiAgICAgICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uYWRkRGF0YShlbnRpdGllcywgeyBpc1RyZWVOb2RlTG9hZFNjZW5lOiB0cnVlIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uYWRkRW50aXRpZXMoZW50aXRpZXMsIHsgaXNUcmVlTm9kZUxvYWRTY2VuZTogdHJ1ZSB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGVudGl0aWVzO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtYXgtbGluZS1sZW5ndGhcclxuICBwdWJsaWMgbG9hZEZ1bGxUcmVlKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCBwYXJlbnRJZDogc3RyaW5nLCBwcm9wZXJ0eU5hbWU6IHN0cmluZywgZnVsbFRyZWVUeXBlOiBzdHJpbmcsIGxvYWRUeXBlOiBzdHJpbmcsIGZpbHRlcnM/OiBhbnlbXSwgY29udGV4dD86IGFueSk6IE9ic2VydmFibGU8RW50aXR5W10+IHtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gcmVwb3NpdG9yeS5yZXN0U2VydmljZTtcclxuICAgIGNvbnN0IGJhc2VVcmkgPSByZXN0U2VydmljZS5iYXNlVXJpO1xyXG4gICAgY29uc3QgcXVlcnlVcmwgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL3BhcmVudGlkZnVsbHRyZWVxdWVyeWA7XHJcbiAgICBjb25zdCBwYXJlbnRIaWVyYXJjaHlJbmZvID0gdGhpcy5nZXRIaWVyYXJjaHlJbmZvQnlJZChyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZvS2V5LCBwYXJlbnRJZCk7XHJcbiAgICBjb25zdCBlbnRpdHlGaWx0ZXIgPSB0aGlzLmJ1aWxkRW50aXR5RmlsdGVyKGZpbHRlcnMsIG51bGwsIDAsIDApO1xyXG5cclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgIGRhdGFJZDogcGFyZW50SWQgfHwgJycsXHJcbiAgICAgIGlzVXNlUGFnaW5hdGlvbjogZmFsc2UsXHJcbiAgICAgIHZpcnR1YWxQcm9wZXJ0eU5hbWU6IHByb3BlcnR5TmFtZSxcclxuICAgICAgcGFnaW5hdGlvbjoge30sXHJcbiAgICAgIGZ1bGxUcmVlVHlwZSxcclxuICAgICAgbG9hZFR5cGUsXHJcbiAgICAgIGZpbHRlcjogZW50aXR5RmlsdGVyLFxyXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgYm9keTogYm9keVxyXG4gICAgfTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UocXVlcnlVcmwsICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxyXG4gICAgICB0YXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgLy8g5L+d5a2Y5bGV5byA55qE6IqC54K5XHJcbiAgICAgICAgaWYgKHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSAmJiByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUuc2VsZWN0ZWRSb3dJZCAmJiBjb250ZXh0ICYmIGNvbnRleHQuZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgICBjb25zdCBmcmFtZUNvbnRleHQgPSBjb250ZXh0LmZyYW1lQ29udGV4dCBhcyBGcmFtZUNvbnRleHQ7XHJcbiAgICAgICAgICBjb25zdCB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKSB8fCBudWxsO1xyXG4gICAgICAgICAgaWYgKHZpcnR1YWxSb290RnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGxpc3QgPSByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUucmVzdWx0IGFzIGFueVtdO1xyXG4gICAgICAgICAgICBjb25zdCBzZWxlY3RlZFJvd0lkID0gcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlLnNlbGVjdGVkUm93SWQ7XHJcbiAgICAgICAgICAgIC8vIOS7jumhtuWxguW8gOWni+iuoeeul+aJgOaciemcgOimgeWxleW8gOeahOiKgueCuVxyXG4gICAgICAgICAgICBjb25zdCBsZWFmTm9kZUluZm8gPSBsaXN0LmZpbmQoaXRlbSA9PiBpdGVtW3JlcG9zaXRvcnkucHJpbWFyeUtleV0gPT09IHNlbGVjdGVkUm93SWQpO1xyXG4gICAgICAgICAgICBjb25zdCBoaWVyYXJjaHlJbmZvID0gbGVhZk5vZGVJbmZvW2hpZXJhcmNoeUluZm9LZXldIGFzIHsgaXNEZXRhaWw6IGJvb2xlYW4sIGxheWVyOiBudW1iZXIsIHBhcmVudEVsZW1lbnQ6IHN0cmluZyB9O1xyXG4gICAgICAgICAgICBjb25zdCBpZHMgPSB0aGlzLmdldEFsbFBhcmVudElkcyhoaWVyYXJjaHlJbmZvLCBsaXN0LCBoaWVyYXJjaHlJbmZvS2V5LCByZXBvc2l0b3J5KTtcclxuICAgICAgICAgICAgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQucGFyYW1zLnNldCgnX0RFVktJVF9leHBhbmRSb3dJZHMnLCBpZHMuam9pbignLCcpKTtcclxuICAgICAgICAgICAgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQucGFyYW1zLnNldCgnX0RFVktJVF9zZWxlY3RlZFJvd0lkJywgc2VsZWN0ZWRSb3dJZCk7XHJcbiAgICAgICAgICAgIHZpcnR1YWxSb290RnJhbWVDb250ZXh0LnVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZSgnX19ERVZLSVRfX3NlbGVjdGVkUm93Jywgc2VsZWN0ZWRSb3dJZCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KSxcclxuICAgICAgbWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZyb3plbkN1cnJlbnRSb3cgPSBjb250ZXh0ICYmIGNvbnRleHQuZnJvemVuQ3VycmVudFJvdyB8fCBmYWxzZTtcclxuICAgICAgICAvLyDlhYjmuIXnqbrkuIvnuqflrp7kvZNcclxuICAgICAgICB0aGlzLmNsZWFyRGVzY2VuZGFudEVudGl0aWVzKHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9LZXksIHBhcmVudEhpZXJhcmNoeUluZm8sIGZyb3plbkN1cnJlbnRSb3cpO1xyXG4gICAgICAgIC8vIOi/veWKoOS4i+e6p+WunuS9k1xyXG4gICAgICAgIGNvbnN0IGxpc3REYXRhID0gcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlLnJlc3VsdDtcclxuICAgICAgICBjb25zdCBlbnRpdGllcyA9IHJlcG9zaXRvcnkuYnVpbGRFbnRpdGllcyhsaXN0RGF0YSk7XHJcbiAgICAgICAgaWYgKGZyb3plbkN1cnJlbnRSb3cpIHtcclxuICAgICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGREYXRhKGVudGl0aWVzLCB7IGlzVHJlZU5vZGVMb2FkU2NlbmU6IHRydWUgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdGllcyhlbnRpdGllcywgeyBpc1RyZWVOb2RlTG9hZFNjZW5lOiB0cnVlIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZW50aXRpZXM7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmj5LlhaXlr7nniLboioLngrnnmoTov4fmu6RcclxuICAgKi9cclxuICBwdWJsaWMgYnVpbGRGaWx0ZXJzV2l0aFBhcmVudChvcmlnaW5hbEhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgcGFyZW50SGllcmFyY2h5SW5mbzogYW55LCBmaWx0ZXJBcnJheTogYW55W10pOiBhbnkge1xyXG4gICAgY29uc3QgcmVsYXRpb25UeXBlID0gZmlsdGVyQXJyYXkgJiYgZmlsdGVyQXJyYXkubGVuZ3RoID49IDEgPyAxIDogMDtcclxuICAgIGNvbnN0IHBhcmVudExheWVyID0gcGFyZW50SGllcmFyY2h5SW5mbyA/IHBhcmVudEhpZXJhcmNoeUluZm9bJ2xheWVyJ10gOiAwO1xyXG4gICAgY29uc3QgcGFyZW50RWxlbWVudCA9IHBhcmVudEhpZXJhcmNoeUluZm8gPyBwYXJlbnRIaWVyYXJjaHlJbmZvWydpZCddIDogJyc7XHJcblxyXG4gICAgY29uc3QgcGFyZW50RmlsdGVyQXJyYXkgPSBbXHJcbiAgICAgIHtcclxuICAgICAgICBcIkZpbHRlckZpZWxkXCI6IGAke29yaWdpbmFsSGllcmFyY2h5SW5mb0tleX0uTGF5ZXJgLFxyXG4gICAgICAgIFwiVmFsdWVcIjogcGFyZW50TGF5ZXIgKyAxLFxyXG4gICAgICAgIFwiTGJyYWNrZXRcIjogbnVsbCxcclxuICAgICAgICBcIlJicmFja2V0XCI6IG51bGwsXHJcbiAgICAgICAgXCJSZWxhdGlvblwiOiAxLFxyXG4gICAgICAgIFwiRXhwcmVzc3R5cGVcIjogMCxcclxuICAgICAgICBcIkNvbXBhcmVcIjogMFxyXG4gICAgICB9XHJcbiAgICBdO1xyXG4gICAgaWYgKHBhcmVudEVsZW1lbnQpIHtcclxuICAgICAgcGFyZW50RmlsdGVyQXJyYXkucHVzaChcclxuICAgICAgICB7XHJcbiAgICAgICAgICBcIkZpbHRlckZpZWxkXCI6IGAke29yaWdpbmFsSGllcmFyY2h5SW5mb0tleX0uUGFyZW50RWxlbWVudGAsXHJcbiAgICAgICAgICBcIlZhbHVlXCI6IHBhcmVudEVsZW1lbnQsXHJcbiAgICAgICAgICBcIkxicmFja2V0XCI6IG51bGwsXHJcbiAgICAgICAgICBcIlJicmFja2V0XCI6IG51bGwsXHJcbiAgICAgICAgICBcIlJlbGF0aW9uXCI6IHJlbGF0aW9uVHlwZSxcclxuICAgICAgICAgIFwiRXhwcmVzc3R5cGVcIjogMCxcclxuICAgICAgICAgIFwiQ29tcGFyZVwiOiAwXHJcbiAgICAgICAgfVxyXG4gICAgICApO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcGFyZW50RmlsdGVyQXJyYXlbMF0uUmVsYXRpb24gPSByZWxhdGlvblR5cGU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcGFyZW50RmlsdGVyQXJyYXkuY29uY2F0KGZpbHRlckFycmF5KTtcclxuICB9XHJcbiAgcHVibGljIGJ1aWxkRW50aXR5RmlsdGVyKGZpbHRlcjogYW55W10sIHNvcnQ6IGFueVtdLCBwYWdlU2l6ZTogbnVtYmVyLCBwYWdlSW5kZXg6IG51bWJlcikge1xyXG5cclxuICAgIC8vIEB0b2Rv77ya5Li05pe25YW85a656ICB5Luj56CB77yM6ZmN5L2O5pS55Yqo5bim5p2l55qE6aOO6ZmpXHJcbiAgICBpZiAoIWZpbHRlciAmJiAhc29ydCAmJiAhcGFnZVNpemUgJiYgIXBhZ2VJbmRleCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGlmICghZmlsdGVyKSB7XHJcbiAgICAgIGZpbHRlciA9IFtdO1xyXG4gICAgfVxyXG4gICAgaWYgKCFzb3J0KSB7XHJcbiAgICAgIHNvcnQgPSBbXTtcclxuICAgIH1cclxuICAgIC8vIOe6oOato+acgOWQjuS4gOS4qui/h+a7pOadoeS7tueahFJlbGF0aW9uXHJcbiAgICBpZiAoZmlsdGVyICYmIGZpbHRlci5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGZpbHRlcltmaWx0ZXIubGVuZ3RoIC0gMV0uUmVsYXRpb24gPSAwO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZW50aXR5RmlsdGVyID0ge1xyXG4gICAgICBGaWx0ZXJDb25kaXRpb25zOiBmaWx0ZXIsXHJcbiAgICAgIFNvcnRDb25kaXRpb25zOiBzb3J0LFxyXG4gICAgICBJc1VzZVBhZ2luYXRpb246IHBhZ2VTaXplID09PSAwID8gZmFsc2UgOiB0cnVlLFxyXG4gICAgICBQYWdpbmF0aW9uOiB7XHJcbiAgICAgICAgUGFnZUluZGV4OiBwYWdlSW5kZXgsXHJcbiAgICAgICAgUGFnZVNpemU6IHBhZ2VTaXplLFxyXG4gICAgICAgIFBhZ2VDb3VudDogMCxcclxuICAgICAgICBUb3RhbENvdW50OiAwXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gZW50aXR5RmlsdGVyO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmuIXnqbrlkI7ku6Plrp7kvZNcclxuICAgKiBAZGVzY3JpcHRpb24gcGFyZW50SGllcmFyY2h5SW5mb+S4rWxheWVy5Li66KaB5riF56m65ZCO5Luj6IqC54K555qEbGF5ZXLvvIzkvYbph4zpnaLnmoRwYXJlbnRFbGVtZW505LiN5piv54i257qn55qEaWTvvIzogIzmmK/opoHmuIXnqbrlkI7ku6PoioLngrnnmoRpZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjbGVhckRlc2NlbmRhbnRFbnRpdGllcyhyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9rZXk6IHN0cmluZywgcGFyZW50SGllcmFyY2h5SW5mbzogYW55LCBmcm96ZW5DdXJyZW50Um93OiBib29sZWFuID0gZmFsc2UpOiB2b2lkIHtcclxuICAgIC8vIOa4heepuuagueiKgueCuVxyXG4gICAgaWYgKCFwYXJlbnRIaWVyYXJjaHlJbmZvKSB7XHJcbiAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5jbGVhcigpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBub2RlcyA9IHRoaXMuZ2V0Q2hpbGROb2RlcyhyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZva2V5LCBwYXJlbnRIaWVyYXJjaHlJbmZvKTtcclxuICAgIGlmIChmcm96ZW5DdXJyZW50Um93KSB7XHJcbiAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5yZW1vdmVFbnRpdGllcygoZW50aXR5OiBFbnRpdHkpID0+IHtcclxuICAgICAgICBjb25zdCBpZCA9IGVudGl0eVtlbnRpdHkucHJpbWFyeUtleV07XHJcbiAgICAgICAgcmV0dXJuIG5vZGVzLmluY2x1ZGVzKGlkKTtcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24ucmVtb3ZlRGF0YSgoZW50aXR5OiBFbnRpdHkpID0+IHtcclxuICAgICAgICBjb25zdCBpZCA9IGVudGl0eVtlbnRpdHkucHJpbWFyeUtleV07XHJcbiAgICAgICAgcmV0dXJuIG5vZGVzLmluY2x1ZGVzKGlkKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bmn5DkuKroioLngrnnmoTmiYDmnInlrZDoioLngrlcclxuICAgKiBAcGFyYW0gcmVwb3NpdG9yeSByZXBvc2l0b3J5XHJcbiAgICogQHBhcmFtIGhpZXJhcmNoeUluZm9rZXkgaGllcmFyY2h5SW5mb2tleVxyXG4gICAqIEBwYXJhbSBwYXJlbnRIaWVyYXJjaHlJbmZvIHBhcmVudEhpZXJhcmNoeUluZm9cclxuICAgKi9cclxuICBwcml2YXRlIGdldENoaWxkTm9kZXMocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBoaWVyYXJjaHlJbmZva2V5OiBzdHJpbmcsIHBhcmVudEhpZXJhcmNoeUluZm86IGFueSkge1xyXG4gICAgY29uc3QgZnBhcmVudEVsZW1lbnQgPSBwYXJlbnRIaWVyYXJjaHlJbmZvLmlkO1xyXG4gICAgY29uc3QgZmxheWVyID0gcGFyZW50SGllcmFyY2h5SW5mby5sYXllcjtcclxuICAgIGxldCBub2RlcyA9IFtdO1xyXG4gICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEFsbEVudGl0aWVzKCkuZm9yRWFjaChlbnRpdHkgPT4ge1xyXG4gICAgICBjb25zdCBoaWVyYXJjaHlJbmZvID0gZW50aXR5W2hpZXJhcmNoeUluZm9rZXldO1xyXG4gICAgICBjb25zdCBwYXJlbnRFbGVtZW50ID0gaGllcmFyY2h5SW5mby5wYXJlbnRFbGVtZW50O1xyXG4gICAgICBjb25zdCBsYXllciA9IGhpZXJhcmNoeUluZm8ubGF5ZXI7XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGxheWVyID49IChmbGF5ZXIgKyAxKSAmJiBwYXJlbnRFbGVtZW50ID09PSBmcGFyZW50RWxlbWVudDtcclxuICAgICAgaWYgKHJlc3VsdCkge1xyXG4gICAgICAgIGNvbnN0IGlkID0gZW50aXR5W2VudGl0eS5wcmltYXJ5S2V5XTtcclxuICAgICAgICBub2Rlcy5wdXNoKGlkKTtcclxuICAgICAgICBjb25zdCBjaGlsZEhpZXJhcmNoeUluZm8gPSB0aGlzLmdldEhpZXJhcmNoeUluZm9CeUlkKHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9rZXksIGlkKTtcclxuICAgICAgICBjb25zdCBjaGlsZHMgPSB0aGlzLmdldENoaWxkTm9kZXMocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb2tleSwgY2hpbGRIaWVyYXJjaHlJbmZvKTtcclxuICAgICAgICBpZiAoY2hpbGRzICYmIGNoaWxkcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICBub2RlcyA9IG5vZGVzLmNvbmNhdChjaGlsZHMpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gbm9kZXM7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWunuS9k+eahOWIhue6p+S/oeaBr1xyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRIaWVyYXJjaHlJbmZvQnlJZChyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9rZXk6IHN0cmluZywgaWQ6IHN0cmluZyk6IGFueSB7XHJcbiAgICBpZiAoIWlkKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZW50aXR5OiBFbnRpdHkgPSByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChpZCk7XHJcbiAgICBjb25zdCBoaWVyYXJjaHlJbmZvRW50aXR5OiBFbnRpdHkgPSBlbnRpdHlbaGllcmFyY2h5SW5mb2tleV07XHJcbiAgICBjb25zdCByZXN1bHQgPSBoaWVyYXJjaHlJbmZvRW50aXR5LnRvSlNPTigpO1xyXG4gICAgcmVzdWx0WydpZCddID0gaWQ7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuICBwdWJsaWMgZ2V0SGllcmFyY2h5SW5mbyhlbnRpdHk6IEVudGl0eSwgaGllcmFyY2h5SW5mb2tleTogc3RyaW5nKTogeyBwYXJlbnRFbGVtZW50OiBzdHJpbmcsIGxheWVyOiBudW1iZXIsIGlzRGV0YWlsOiBib29sZWFuIH0ge1xyXG4gICAgcmV0dXJuIGVudGl0eVtoaWVyYXJjaHlJbmZva2V5XTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5YiG57qn56CB55qE5Y6f5aeL55qE5a2X5q615ZCNXHJcbiAgICovXHJcbiAgcHVibGljIGdldE9yaWdpbmFsSGllcmFyY2h5SW5mb0tleShyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9rZXk6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBjb25zdCBuZ09iamVjdHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ09iamVjdHMocmVwb3NpdG9yeS5lbnRpdHlUeXBlKTtcclxuICAgIGNvbnN0IGhpZXJhcmNoeUluZm9OZ09iamVjdCA9IG5nT2JqZWN0c1toaWVyYXJjaHlJbmZva2V5XTtcclxuICAgIHJldHVybiBoaWVyYXJjaHlJbmZvTmdPYmplY3Qub3JpZ2luYWxEYXRhRmllbGQgYXMgc3RyaW5nO1xyXG4gIH1cclxuICBwcml2YXRlIGdldFBhZ2luYXRpb25JbmZvKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSB7XHJcbiAgICByZXR1cm4gcmVzcG9uc2VJbmZvICYmIHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSAmJiByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUucGFnaW5hdGlvbiB8fCBudWxsO1xyXG4gIH1cclxuICBwcml2YXRlIGZpbmRQYXJlbnQoaGllcmFyY2h5SW5mbzogeyBpc0RldGFpbDogYm9vbGVhbiwgbGF5ZXI6IG51bWJlciwgcGFyZW50RWxlbWVudDogc3RyaW5nIH0sIGxpc3Q6IGFueVtdLCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBsaXN0LmZpbmQoaXRlbSA9PiB7XHJcbiAgICAgIGNvbnN0IGN1cnJlbnRIaWVyYXJjaHlJbmZvID0gaXRlbVtoaWVyYXJjaHlJbmZvS2V5XSBhcyB7IGlzRGV0YWlsOiBib29sZWFuLCBsYXllcjogbnVtYmVyLCBwYXJlbnRFbGVtZW50OiBzdHJpbmcgfTtcclxuICAgICAgcmV0dXJuIGN1cnJlbnRIaWVyYXJjaHlJbmZvLmxheWVyID09PSBoaWVyYXJjaHlJbmZvLmxheWVyIC0gMSAmJiBoaWVyYXJjaHlJbmZvLnBhcmVudEVsZW1lbnQgPT09IGN1cnJlbnRIaWVyYXJjaHlJbmZvLnBhcmVudEVsZW1lbnQ7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRBbGxQYXJlbnRJZHMoaGllcmFyY2h5SW5mbzogeyBpc0RldGFpbDogYm9vbGVhbiwgbGF5ZXI6IG51bWJlciwgcGFyZW50RWxlbWVudDogc3RyaW5nIH0sIGxpc3Q6IGFueVtdLCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcsIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55Pikge1xyXG4gICAgbGV0IGl0ZW0gPSB0aGlzLmZpbmRQYXJlbnQoaGllcmFyY2h5SW5mbywgbGlzdCwgaGllcmFyY2h5SW5mb0tleSk7XHJcbiAgICBjb25zdCBpZHMgPSBbXTtcclxuICAgIHdoaWxlIChpdGVtKSB7XHJcbiAgICAgIGlkcy5wdXNoKGl0ZW1bcmVwb3NpdG9yeS5wcmltYXJ5S2V5XSk7XHJcbiAgICAgIGl0ZW0gPSB0aGlzLmZpbmRQYXJlbnQoaXRlbVtoaWVyYXJjaHlJbmZvS2V5XSwgbGlzdCwgaGllcmFyY2h5SW5mb0tleSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaWRzO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmn6Xmib7oioLngrnkuIvmiYDmnInlrZDnuqfvvIjnrKzkuIDnuqfvvIlcclxuICAgKiBAcGFyYW0gcmVwb3NpdG9yeSByZXBvc2l0b3J5XHJcbiAgICogQHBhcmFtIGhpZXJhcmNoeUluZm9LZXkg5YiG57qn56CB5a2X5q61XHJcbiAgICogQHBhcmFtIGlkIGlkXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRDaGlsZHJlbihyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgaWQ6IHN0cmluZyk6IEVudGl0eVtdIHtcclxuICAgIGNvbnN0IGhpZXJhcmNoeUluZm8gPSB0aGlzLmdldEhpZXJhcmNoeUluZm9CeUlkKHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9LZXksIGlkKTtcclxuICAgIGlmICghaGllcmFyY2h5SW5mbykge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IGxheWVyID0gaGllcmFyY2h5SW5mby5sYXllcjtcclxuICAgIGNvbnN0IHBhcmVudEVsZW1lbnQgPSBoaWVyYXJjaHlJbmZvLnBhcmVudEVsZW1lbnQ7XHJcbiAgICBjb25zdCBlbnRpdGllczogRW50aXR5W10gPSByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXRpZXMoKGVudGl0eTogRW50aXR5KSA9PiB7XHJcbiAgICAgIGNvbnN0IGhpZXJhcmNoeUluZm8gPSB0aGlzLmdldEhpZXJhcmNoeUluZm8oZW50aXR5LCBoaWVyYXJjaHlJbmZvS2V5KTtcclxuICAgICAgY29uc3QgbWF0Y2hlZCA9IGhpZXJhcmNoeUluZm8ubGF5ZXIgPT09IGxheWVyICsgMSAmJiAoaGllcmFyY2h5SW5mby5wYXJlbnRFbGVtZW50ID09PSBwYXJlbnRFbGVtZW50IHx8ICFwYXJlbnRFbGVtZW50ICYmICFoaWVyYXJjaHlJbmZvLnBhcmVudEVsZW1lbnQpO1xyXG4gICAgICBpZiAobWF0Y2hlZCkge1xyXG4gICAgICAgIHJldHVybiBlbnRpdHk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGVudGl0aWVzO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgUGFyZW50VHJlZVJlcG9zaXRvcnkgfTtcclxuIl19