import { Injectable, Injector } from '@angular/core';
import { EMPTY, of } from 'rxjs';
import { switchMap, tap } from 'rxjs/operators';
import { FrameContext, DataPathCreator, Repository } from '@farris/devkit';
import { LanguageService } from './languag.service';
import { FormMessageService } from './form-message.service';
export class PopUpService {
    constructor(injector, frameContext, repository, languageService, messageService) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.repository = repository;
        this.languageService = languageService;
        this.messageService = messageService;
    }
    confirm() { }
    /**
     * 取消变更
     * @param frameId
     * @param id
     * @returns
     * @throws invalid frameid
     */
    cancel(frameId, id) {
        const frameContext = this.frameContext.appContext.frameContextManager.getFrameContextById(frameId);
        if (!frameContext) {
            throw new Error(`[PopUpService]Invalid frameId ${frameId}`);
        }
        const primaryValue = this.frameContext.bindingData.list.currentId;
        const bindingPath = frameContext.viewModel.bindingPath;
        const bindingPaths = bindingPath.split('/').filter((p) => p);
        if (!id) {
            const bindingList = this.frameContext.bindingData.getList();
            id = bindingList.currentId;
        }
        const befRepository = this.repository;
        const longPaths = DataPathCreator.createByShortPathFromRoot(bindingPaths, befRepository.entityManager, this.frameContext.bindingData).toArray().map((path) => path.split(':')[1]);
        const entityListPaths = Array.from(longPaths);
        // 舍弃当前表当前行
        entityListPaths.pop();
        const dialogRef = this.frameContext.frameComponent['dialogRef'];
        if (entityListPaths.length < 1) {
            // 主表
            const entity = this.repository.entityCollection.getEntityById(id);
            const originalData = entity['originalData'];
            entity.load(originalData, { loadChild: false });
        }
        else {
            const entityList = befRepository.entityManager.getEntityNodeByPath(entityListPaths);
            if (entityList) {
                const originalData = entityList['originalData'];
                const item = originalData.find((item) => item.id === id);
                if (item) {
                    // 已有数据，还原变更
                    const entity = befRepository.entityManager.getEntityByPath(longPaths);
                    if (entity.changes && entity.changes.length > 0) {
                        return this.messageService.confirm(this.languageService.cancelWithoutSave).pipe(tap((result) => {
                            if (result) {
                                entity.load(item, { loadChild: false });
                                entity.changes.splice(0, entity.changes.length);
                            }
                        }));
                    }
                    else {
                        // 没有修改，直接关闭
                        if (dialogRef) {
                            dialogRef.close();
                        }
                    }
                }
                else {
                    // 新增的数据，删除
                    const paths = this.buildPath(bindingPath, primaryValue);
                    return this.messageService.confirm(this.languageService.cancelWithoutSave).pipe(switchMap((result) => {
                        if (result) {
                            return befRepository.removeEntityByPath(paths, id).pipe(tap(() => {
                                befRepository.entityManager.removeEntityByPath(paths, id);
                                if (entityList.count() === 0 && dialogRef) {
                                    dialogRef.close();
                                }
                            }));
                        }
                        else {
                            return EMPTY;
                        }
                    }));
                }
            }
        }
        return of([]);
    }
    /**
     * 同步当前行
     * @param id 当前行
     */
    updateCurrentRow(id) {
        const bindingPath = this.frameContext.viewModel.bindingPath;
        const bindingPaths = bindingPath.split('/').filter((p) => p);
        // const frameId = this.frameContext.frameId;
        const root = this.frameContext.getVirtualRootFrameContext();
        const primaryKeyValue = root.bindingData.list.currentId;
        this.frameContext.bindingData.list.setCurrentId(primaryKeyValue);
        if (bindingPaths.length > 0) {
            const paths = [];
            bindingPaths.forEach((path, index, array) => {
                paths.push(path);
                const bindingList = root.bindingData.getValue(paths);
                if (bindingList) {
                    const currentId = bindingList.currentId;
                    const modalBindingList = this.frameContext.bindingData.getValue(paths);
                    if (index === bindingPath.length - 1 && id) {
                        modalBindingList.setCurrentId(id);
                    }
                    else if (modalBindingList) {
                        modalBindingList.setCurrentId(currentId);
                    }
                }
            });
        }
    }
    closeCheck() {
        const frameContext = this.frameContext;
        const bindingPath = frameContext.viewModel.bindingPath;
        const bindingPaths = bindingPath.split('/').filter((p) => p);
        const befRepository = this.repository;
        const longPaths = DataPathCreator.createByShortPathFromRoot(bindingPaths, befRepository.entityManager, this.frameContext.bindingData).toArray().map((path) => path.split(':')[1]);
        const entityListPaths = Array.from(longPaths);
        entityListPaths.pop();
        const entityList = befRepository.entityManager.getEntityNodeByPath(entityListPaths);
        const dialogRef = this.frameContext.frameComponent['dialogRef'];
        if (entityList.count() === 0 && dialogRef) {
            dialogRef.close();
        }
    }
    /**
     * 删除弹窗中的当前行数据
     * @param frameId -可选，要删除数据所在组件的id，默认为命令所在的组件
     * @param id -可选，要删除数据的id，默认为命令所在组件的当前行数据id
     * @param showConfirm -可选，删除数据时是否进行删除前的确认，默认为`true`
     * @returns
     * @throws 组件id错误时抛出错误
     */
    removeRow(frameId, id, showConfirm = true) {
        const frameContext = frameId ? this.frameContext.appContext.frameContextManager.getFrameContextById(frameId) : this.frameContext;
        if (!frameContext) {
            throw new Error(`无效的组件id：${frameId}`);
        }
        // 纠正主键
        if (!id) {
            const bindingList = frameContext.bindingData.getList();
            id = bindingList.currentId;
        }
        const bindingPath = frameContext.viewModel.bindingPath;
        const bindingPaths = bindingPath.split('/').filter((p) => p);
        const paths = this.buildPath(bindingPath, this.frameContext.bindingData.list.currentId);
        const befRepository = this.repository;
        // 转换showConfirm为布尔
        if (typeof showConfirm == 'string') {
            showConfirm = showConfirm.trim() === 'false' ? false : true;
        }
        let confirm$ = of(true);
        if (showConfirm) {
            confirm$ = this.messageService.confirm(this.languageService.confirmDeletion);
        }
        return confirm$.pipe(switchMap((result) => {
            if (result) {
                if (bindingPaths.length === 0) {
                    // 主表删除，不立即保存
                    return befRepository.removeEntityById(id, false);
                }
                else {
                    return befRepository.removeEntityByPath(paths, id).pipe(tap(() => {
                        befRepository.entityManager.removeEntityByPath(paths, id);
                    }));
                }
            }
            else {
                return EMPTY;
            }
        }));
    }
    /**
     * 关闭弹窗
     * @param frameId -可选，组件id，不指定时使用命令所在的上下文组件
     * @throws 使用指定的组件id无法获取组件及弹窗组件实例获取失败时会抛出异常
     */
    closeDialog(frameId) {
        let frameContext = this.frameContext;
        let dialogRef = null;
        // 开发者指定了组件id
        if (frameId) {
            frameContext = this.frameContext.appContext.frameContextManager.getFrameContextById(frameId);
            if (!frameContext) {
                throw new Error('指定了无效的组件id');
            }
            dialogRef = frameContext.frameComponent['dialogRef'];
        }
        else {
            // 尝试从当前组件上下文中获取弹窗引用
            dialogRef = frameContext.frameComponent['dialogRef'];
            if (!dialogRef) {
                // 如果命令挂载到了内容组件上
                dialogRef = this.frameContext.parent.frameComponent['dialogRef'];
            }
        }
        if (!dialogRef) {
            throw new Error(`无法获取弹窗组件实例`);
        }
        dialogRef.close();
    }
    /**
     * 还原自上次持久化以后产生的变更
     * @param frameId - 组件id
     * @param id - 数据id
     * @param showConfirm - 是否展示提示信息
     */
    cancelChanges(frameId, id, showConfirm = true) {
        const frameContext = this.getFrameContext(frameId);
        // 纠正主键
        id = this.getPrimaryValue(frameId, id);
        const data = this.getPersisteData(frameId, id);
        if (typeof showConfirm === 'string') {
            showConfirm = showConfirm.trim().toLowerCase() === 'false' ? false : true;
        }
        const isDataChanged = this.isDataChanged(data, frameId, id);
        let result$ = of(true);
        if (showConfirm && isDataChanged) {
            result$ = this.messageService.confirm(this.languageService.cancelWithoutSave);
        }
        return result$.pipe(switchMap((result) => {
            if (result) {
                const befRepository = frameContext.repository;
                const bindingPaths = frameContext.viewModel.bindingPath.split('/').filter((p) => p);
                const longPaths = DataPathCreator.createByShortPathFromRoot(bindingPaths, befRepository.entityManager, this.frameContext.bindingData).toArray().map((path) => path.split(':')[1]);
                const entityPaths = Array.from(longPaths);
                const entity = befRepository.entityManager.getEntityNodeByPath(entityPaths);
                if (entity) {
                    entity.load(data);
                }
                return of(true);
            }
            else {
                return EMPTY;
            }
        }));
    }
    /**
     * 持久化数据
     * @param frameId - 组件id
     * @param id - 数据id
     */
    persiste(frameId, id) {
        // 持久化数据
        const bindingObject = this.getBindingObject(frameId, id);
        bindingObject['__PSESISTE__DATA'] = bindingObject.toJSON();
    }
    /**
     * 获取持久化数据
     * @param frameId - 组件id
     * @param id - 数据id
     * @returns
     */
    getPersisteData(frameId, id) {
        const bindingObject = this.getBindingObject(frameId, id);
        return bindingObject['__PSESISTE__DATA'];
    }
    isDataChanged(data, frameId, id) {
        const bindingObject = this.getBindingObject(frameId, id);
        const value = bindingObject.toJSON();
        return JSON.stringify(value) !== JSON.stringify(data);
    }
    /**
     * 获取当前行
     * @param frameId - 组件id
     * @param id - 数据id
     * @returns
     * @throws 找不到对应数据时抛出无法找到对应数据的异常
     */
    getBindingObject(frameId, id) {
        const frameContext = this.getFrameContext(frameId);
        // 纠正主键
        id = this.getPrimaryValue(frameId, id);
        const bindingPaths = frameContext.viewModel.bindingPath.split('/').filter((p) => p);
        // 拿到当前行
        const bindingList = frameContext.bindingData.getValue(bindingPaths);
        if (!bindingList || bindingList.length < 1) {
            throw new Error(`无法找到id为:${id}的数据`);
        }
        return bindingList.currentItem;
    }
    /**
     * 构造子表路径
     * @param bindingPath - 绑定路径
     * @param id - id
     * @throws 子表路径错误
     */
    buildPath(bindingPath, id) {
        let path = '/' + id;
        const subPaths = bindingPath.split('/');
        if (subPaths.length > 0) {
            // eg:bindingPath形如/edus/grades,split后是['', 'edus', 'grades']
            // 因此index从1开始
            for (let index = 1; index < subPaths.length - 1; index++) {
                const subPath = subPaths[index];
                const subData = this.frameContext.viewModel.bindingData[subPath];
                if (!subData || !subData.currentId) {
                    throw Error(`获取子表完整路径出错，找不到${subData}对应的子表，或对应子表没有当前行。`);
                }
                path += `/${subPath}/${subData.currentId}`;
            }
        }
        path += '/' + subPaths[subPaths.length - 1];
        return path;
    }
    /**
     * 根据组件id获取组件上下文
     * @param frameId - 组件id
     * @returns
     * @throws 无效的组件id
     */
    getFrameContext(frameId) {
        const frameContext = frameId ? this.frameContext.appContext.frameContextManager.getFrameContextById(frameId) : this.frameContext;
        if (!frameContext) {
            throw new Error(`无效的组件id：${frameId}`);
        }
        return frameContext;
    }
    /**
     * 获取主键
     * @param frameId - 组件id
     * @param id - 数据id
     * @returns
     * @throws 组件id无效时抛出异常
     */
    getPrimaryValue(frameId, id) {
        if (!id) {
            const frameContext = this.getFrameContext(frameId);
            if (!frameContext) {
                throw new Error(`无效的组件id：${frameId}`);
            }
            const bindingList = frameContext.bindingData.getList();
            if (!bindingList || bindingList.length < 1) {
                throw new Error(`无效的主键:${id}`);
            }
            id = bindingList.currentId;
        }
        return id;
    }
}
PopUpService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
PopUpService.ctorParameters = () => [
    { type: Injector },
    { type: FrameContext },
    { type: Repository },
    { type: LanguageService },
    { type: FormMessageService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wX3VwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvcG9wX3VwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDakMsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVoRCxPQUFPLEVBQUUsWUFBWSxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQTZDLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEgsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRzVELE1BQU0sT0FBTyxZQUFZO0lBQ3ZCLFlBQ1UsUUFBa0IsRUFDbEIsWUFBMEIsRUFDMUIsVUFBMkIsRUFDM0IsZUFBZ0MsRUFDaEMsY0FBa0M7UUFKbEMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDaEMsbUJBQWMsR0FBZCxjQUFjLENBQW9CO0lBQ3hDLENBQUM7SUFDRSxPQUFPLEtBQUssQ0FBQztJQUNwQjs7Ozs7O09BTUc7SUFDSSxNQUFNLENBQUMsT0FBZSxFQUFFLEVBQVc7UUFDeEMsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbkcsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNqQixNQUFNLElBQUksS0FBSyxDQUFDLGlDQUFpQyxP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WUFBWSxFQUFFO1lBQ2pCLE1BQU0sSUFBSSxLQUFLLENBQUMsV0FBVyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1NBQ3ZDO1FBQ0QsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQztJQUNEOzs7Ozs7T0FNRztJQUNLLGVBQWUsQ0FBQyxPQUFnQixFQUFFLEVBQVc7UUFDbkQsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNQLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDbkQsSUFBSSxDQUFDLFlBQVksRUFBRTtnQkFDakIsTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLE9BQU8sRUFBRSxDQUFDLENBQUM7YUFDdkM7WUFDRCxNQUFNLFdBQVcsR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBaUIsQ0FBQztZQUN0RSxJQUFJLENBQUMsV0FBVyxJQUFJLFdBQVcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUMxQyxNQUFNLElBQUksS0FBSyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQzthQUNoQztZQUNELEVBQUUsR0FBRyxXQUFXLENBQUMsU0FBUyxDQUFDO1NBQzVCO1FBQ0QsT0FBTyxFQUFFLENBQUM7SUFDWixDQUFDOzs7WUF6VkYsVUFBVTs7OztZQVJVLFFBQVE7WUFJcEIsWUFBWTtZQUFtQixVQUFVO1lBQ3pDLGVBQWU7WUFDZixrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBFTVBUWSwgb2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgc3dpdGNoTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnkgfSBmcm9tICdAZmFycmlzL2JlZic7XHJcbmltcG9ydCB7IEZyYW1lQ29udGV4dCwgRGF0YVBhdGhDcmVhdG9yLCBSZXBvc2l0b3J5LCBEYXRhUGF0aCwgRW50aXR5TGlzdCwgQmluZGluZ0xpc3QsIEVudGl0eSB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9sYW5ndWFnLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGb3JtTWVzc2FnZVNlcnZpY2UgfSBmcm9tICcuL2Zvcm0tbWVzc2FnZS5zZXJ2aWNlJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFBvcFVwU2VydmljZSB7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcixcclxuICAgIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXHJcbiAgICBwcml2YXRlIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55PixcclxuICAgIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIG1lc3NhZ2VTZXJ2aWNlOiBGb3JtTWVzc2FnZVNlcnZpY2VcclxuICApIHsgfVxyXG4gIHB1YmxpYyBjb25maXJtKCkgeyB9XHJcbiAgLyoqXHJcbiAgICog5Y+W5raI5Y+Y5pu0XHJcbiAgICogQHBhcmFtIGZyYW1lSWRcclxuICAgKiBAcGFyYW0gaWRcclxuICAgKiBAcmV0dXJuc1xyXG4gICAqIEB0aHJvd3MgaW52YWxpZCBmcmFtZWlkXHJcbiAgICovXHJcbiAgcHVibGljIGNhbmNlbChmcmFtZUlkOiBzdHJpbmcsIGlkPzogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0QnlJZChmcmFtZUlkKTtcclxuICAgIGlmICghZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgW1BvcFVwU2VydmljZV1JbnZhbGlkIGZyYW1lSWQgJHtmcmFtZUlkfWApO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcHJpbWFyeVZhbHVlID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGg7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcigocCkgPT4gcCk7XHJcbiAgICBpZiAoIWlkKSB7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0TGlzdCgpIGFzIEJpbmRpbmdMaXN0O1xyXG4gICAgICBpZCA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJZDtcclxuICAgIH1cclxuICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSB0aGlzLnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxhbnk+O1xyXG4gICAgY29uc3QgbG9uZ1BhdGhzID0gKERhdGFQYXRoQ3JlYXRvci5jcmVhdGVCeVNob3J0UGF0aEZyb21Sb290KGJpbmRpbmdQYXRocywgYmVmUmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLCB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YSkgYXMgRGF0YVBhdGgpLnRvQXJyYXkoKS5tYXAoKHBhdGg6IHN0cmluZykgPT4gcGF0aC5zcGxpdCgnOicpWzFdKTtcclxuICAgIGNvbnN0IGVudGl0eUxpc3RQYXRocyA9IEFycmF5LmZyb20obG9uZ1BhdGhzKTtcclxuICAgIC8vIOiIjeW8g+W9k+WJjeihqOW9k+WJjeihjFxyXG4gICAgZW50aXR5TGlzdFBhdGhzLnBvcCgpO1xyXG4gICAgY29uc3QgZGlhbG9nUmVmID0gdGhpcy5mcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnRbJ2RpYWxvZ1JlZiddO1xyXG4gICAgaWYgKGVudGl0eUxpc3RQYXRocy5sZW5ndGggPCAxKSB7XHJcbiAgICAgIC8vIOS4u+ihqFxyXG4gICAgICBjb25zdCBlbnRpdHkgPSB0aGlzLnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdHlCeUlkKGlkKSBhcyBFbnRpdHk7XHJcbiAgICAgIGNvbnN0IG9yaWdpbmFsRGF0YSA9IGVudGl0eVsnb3JpZ2luYWxEYXRhJ107XHJcbiAgICAgIGVudGl0eS5sb2FkKG9yaWdpbmFsRGF0YSwgeyBsb2FkQ2hpbGQ6IGZhbHNlIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc3QgZW50aXR5TGlzdCA9IGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlci5nZXRFbnRpdHlOb2RlQnlQYXRoKGVudGl0eUxpc3RQYXRocykgYXMgRW50aXR5TGlzdDxhbnk+O1xyXG4gICAgICBpZiAoZW50aXR5TGlzdCkge1xyXG4gICAgICAgIGNvbnN0IG9yaWdpbmFsRGF0YTogYW55W10gPSBlbnRpdHlMaXN0WydvcmlnaW5hbERhdGEnXTtcclxuICAgICAgICBjb25zdCBpdGVtID0gb3JpZ2luYWxEYXRhLmZpbmQoKGl0ZW0pID0+IGl0ZW0uaWQgPT09IGlkKTtcclxuICAgICAgICBpZiAoaXRlbSkge1xyXG4gICAgICAgICAgLy8g5bey5pyJ5pWw5o2u77yM6L+Y5Y6f5Y+Y5pu0XHJcbiAgICAgICAgICBjb25zdCBlbnRpdHk6IEVudGl0eSA9IGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlci5nZXRFbnRpdHlCeVBhdGgobG9uZ1BhdGhzKSBhcyBFbnRpdHk7XHJcbiAgICAgICAgICBpZiAoZW50aXR5LmNoYW5nZXMgJiYgZW50aXR5LmNoYW5nZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5tZXNzYWdlU2VydmljZS5jb25maXJtKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNhbmNlbFdpdGhvdXRTYXZlKS5waXBlKFxyXG4gICAgICAgICAgICAgIHRhcCgocmVzdWx0OiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICAgIGVudGl0eS5sb2FkKGl0ZW0sIHsgbG9hZENoaWxkOiBmYWxzZSB9KTtcclxuICAgICAgICAgICAgICAgICAgZW50aXR5LmNoYW5nZXMuc3BsaWNlKDAsIGVudGl0eS5jaGFuZ2VzLmxlbmd0aCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIOayoeacieS/ruaUue+8jOebtOaOpeWFs+mXrVxyXG4gICAgICAgICAgICBpZiAoZGlhbG9nUmVmKSB7XHJcbiAgICAgICAgICAgICAgZGlhbG9nUmVmLmNsb3NlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8g5paw5aKe55qE5pWw5o2u77yM5Yig6ZmkXHJcbiAgICAgICAgICBjb25zdCBwYXRocyA9IHRoaXMuYnVpbGRQYXRoKGJpbmRpbmdQYXRoLCBwcmltYXJ5VmFsdWUpO1xyXG4gICAgICAgICAgcmV0dXJuIHRoaXMubWVzc2FnZVNlcnZpY2UuY29uZmlybSh0aGlzLmxhbmd1YWdlU2VydmljZS5jYW5jZWxXaXRob3V0U2F2ZSkucGlwZShcclxuICAgICAgICAgICAgc3dpdGNoTWFwKChyZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYmVmUmVwb3NpdG9yeS5yZW1vdmVFbnRpdHlCeVBhdGgocGF0aHMsIGlkKS5waXBlKFxyXG4gICAgICAgICAgICAgICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlci5yZW1vdmVFbnRpdHlCeVBhdGgocGF0aHMsIGlkKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVudGl0eUxpc3QuY291bnQoKSA9PT0gMCAmJiBkaWFsb2dSZWYpIHtcclxuICAgICAgICAgICAgICAgICAgICAgIGRpYWxvZ1JlZi5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG9mKFtdKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5ZCM5q2l5b2T5YmN6KGMXHJcbiAgICogQHBhcmFtIGlkIOW9k+WJjeihjFxyXG4gICAqL1xyXG4gIHB1YmxpYyB1cGRhdGVDdXJyZW50Um93KGlkPzogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IHRoaXMuZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKChwKSA9PiBwKTtcclxuICAgIC8vIGNvbnN0IGZyYW1lSWQgPSB0aGlzLmZyYW1lQ29udGV4dC5mcmFtZUlkO1xyXG4gICAgY29uc3Qgcm9vdCA9IHRoaXMuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XHJcbiAgICBjb25zdCBwcmltYXJ5S2V5VmFsdWUgPSByb290LmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkO1xyXG4gICAgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5zZXRDdXJyZW50SWQocHJpbWFyeUtleVZhbHVlKTtcclxuICAgIGlmIChiaW5kaW5nUGF0aHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBjb25zdCBwYXRocyA9IFtdO1xyXG4gICAgICBiaW5kaW5nUGF0aHMuZm9yRWFjaCgocGF0aDogc3RyaW5nLCBpbmRleDogbnVtYmVyLCBhcnJheSkgPT4ge1xyXG4gICAgICAgIHBhdGhzLnB1c2gocGF0aCk7XHJcbiAgICAgICAgY29uc3QgYmluZGluZ0xpc3QgPSByb290LmJpbmRpbmdEYXRhLmdldFZhbHVlKHBhdGhzKSBhcyBCaW5kaW5nTGlzdDtcclxuICAgICAgICBpZiAoYmluZGluZ0xpc3QpIHtcclxuICAgICAgICAgIGNvbnN0IGN1cnJlbnRJZCA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJZDtcclxuICAgICAgICAgIGNvbnN0IG1vZGFsQmluZGluZ0xpc3QgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRWYWx1ZShwYXRocykgYXMgQmluZGluZ0xpc3Q7XHJcbiAgICAgICAgICBpZiAoaW5kZXggPT09IGJpbmRpbmdQYXRoLmxlbmd0aCAtIDEgJiYgaWQpIHtcclxuICAgICAgICAgICAgbW9kYWxCaW5kaW5nTGlzdC5zZXRDdXJyZW50SWQoaWQpO1xyXG4gICAgICAgICAgfSBlbHNlIGlmIChtb2RhbEJpbmRpbmdMaXN0KSB7XHJcbiAgICAgICAgICAgIG1vZGFsQmluZGluZ0xpc3Quc2V0Q3VycmVudElkKGN1cnJlbnRJZCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgcHVibGljIGNsb3NlQ2hlY2soKSB7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSB0aGlzLmZyYW1lQ29udGV4dDtcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKChwKSA9PiBwKTtcclxuICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSB0aGlzLnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxhbnk+O1xyXG4gICAgY29uc3QgbG9uZ1BhdGhzID0gKERhdGFQYXRoQ3JlYXRvci5jcmVhdGVCeVNob3J0UGF0aEZyb21Sb290KGJpbmRpbmdQYXRocywgYmVmUmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLCB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YSkgYXMgRGF0YVBhdGgpLnRvQXJyYXkoKS5tYXAoKHBhdGg6IHN0cmluZykgPT4gcGF0aC5zcGxpdCgnOicpWzFdKTtcclxuICAgIGNvbnN0IGVudGl0eUxpc3RQYXRocyA9IEFycmF5LmZyb20obG9uZ1BhdGhzKTtcclxuICAgIGVudGl0eUxpc3RQYXRocy5wb3AoKTtcclxuICAgIGNvbnN0IGVudGl0eUxpc3QgPSBiZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIuZ2V0RW50aXR5Tm9kZUJ5UGF0aChlbnRpdHlMaXN0UGF0aHMpIGFzIEVudGl0eUxpc3Q8YW55PjtcclxuICAgIGNvbnN0IGRpYWxvZ1JlZiA9IHRoaXMuZnJhbWVDb250ZXh0LmZyYW1lQ29tcG9uZW50WydkaWFsb2dSZWYnXTtcclxuICAgIGlmIChlbnRpdHlMaXN0LmNvdW50KCkgPT09IDAgJiYgZGlhbG9nUmVmKSB7XHJcbiAgICAgIGRpYWxvZ1JlZi5jbG9zZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDliKDpmaTlvLnnqpfkuK3nmoTlvZPliY3ooYzmlbDmja5cclxuICAgKiBAcGFyYW0gZnJhbWVJZCAt5Y+v6YCJ77yM6KaB5Yig6Zmk5pWw5o2u5omA5Zyo57uE5Lu255qEaWTvvIzpu5jorqTkuLrlkb3ku6TmiYDlnKjnmoTnu4Tku7ZcclxuICAgKiBAcGFyYW0gaWQgLeWPr+mAie+8jOimgeWIoOmZpOaVsOaNrueahGlk77yM6buY6K6k5Li65ZG95Luk5omA5Zyo57uE5Lu255qE5b2T5YmN6KGM5pWw5o2uaWRcclxuICAgKiBAcGFyYW0gc2hvd0NvbmZpcm0gLeWPr+mAie+8jOWIoOmZpOaVsOaNruaXtuaYr+WQpui/m+ihjOWIoOmZpOWJjeeahOehruiupO+8jOm7mOiupOS4umB0cnVlYFxyXG4gICAqIEByZXR1cm5zXHJcbiAgICogQHRocm93cyDnu4Tku7ZpZOmUmeivr+aXtuaKm+WHuumUmeivr1xyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmVSb3coZnJhbWVJZD86IHN0cmluZywgaWQ/OiBzdHJpbmcsIHNob3dDb25maXJtOiBzdHJpbmcgfCBib29sZWFuID0gdHJ1ZSkge1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gZnJhbWVJZCA/IHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRCeUlkKGZyYW1lSWQpIDogdGhpcy5mcmFtZUNvbnRleHQ7XHJcbiAgICBpZiAoIWZyYW1lQ29udGV4dCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYOaXoOaViOeahOe7hOS7tmlk77yaJHtmcmFtZUlkfWApO1xyXG4gICAgfVxyXG4gICAgLy8g57qg5q2j5Li76ZSuXHJcbiAgICBpZiAoIWlkKSB7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdMaXN0ID0gZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldExpc3QoKSBhcyBCaW5kaW5nTGlzdDtcclxuICAgICAgaWQgPSBiaW5kaW5nTGlzdC5jdXJyZW50SWQ7XHJcbiAgICB9XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGg7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcigocCkgPT4gcCk7XHJcbiAgICBjb25zdCBwYXRocyA9IHRoaXMuYnVpbGRQYXRoKGJpbmRpbmdQYXRoLCB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZCk7XHJcbiAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcclxuICAgIC8vIOi9rOaNonNob3dDb25maXJt5Li65biD5bCUXHJcbiAgICBpZiAodHlwZW9mIHNob3dDb25maXJtID09ICdzdHJpbmcnKSB7XHJcbiAgICAgIHNob3dDb25maXJtID0gc2hvd0NvbmZpcm0udHJpbSgpID09PSAnZmFsc2UnID8gZmFsc2UgOiB0cnVlO1xyXG4gICAgfVxyXG4gICAgbGV0IGNvbmZpcm0kID0gb2YodHJ1ZSk7XHJcbiAgICBpZiAoc2hvd0NvbmZpcm0pIHtcclxuICAgICAgY29uZmlybSQgPSB0aGlzLm1lc3NhZ2VTZXJ2aWNlLmNvbmZpcm0odGhpcy5sYW5ndWFnZVNlcnZpY2UuY29uZmlybURlbGV0aW9uKTtcclxuICAgIH1cclxuICAgIHJldHVybiBjb25maXJtJC5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKHJlc3VsdCkgPT4ge1xyXG4gICAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICAgIGlmIChiaW5kaW5nUGF0aHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIC8vIOS4u+ihqOWIoOmZpO+8jOS4jeeri+WNs+S/neWtmFxyXG4gICAgICAgICAgICByZXR1cm4gYmVmUmVwb3NpdG9yeS5yZW1vdmVFbnRpdHlCeUlkKGlkLCBmYWxzZSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gYmVmUmVwb3NpdG9yeS5yZW1vdmVFbnRpdHlCeVBhdGgocGF0aHMsIGlkKS5waXBlKFxyXG4gICAgICAgICAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBiZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIucmVtb3ZlRW50aXR5QnlQYXRoKHBhdGhzLCBpZCk7XHJcbiAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWFs+mXreW8ueeql1xyXG4gICAqIEBwYXJhbSBmcmFtZUlkIC3lj6/pgInvvIznu4Tku7ZpZO+8jOS4jeaMh+WumuaXtuS9v+eUqOWRveS7pOaJgOWcqOeahOS4iuS4i+aWh+e7hOS7tlxyXG4gICAqIEB0aHJvd3Mg5L2/55So5oyH5a6a55qE57uE5Lu2aWTml6Dms5Xojrflj5bnu4Tku7blj4rlvLnnqpfnu4Tku7blrp7kvovojrflj5blpLHotKXml7bkvJrmipvlh7rlvILluLhcclxuICAgKi9cclxuICBwdWJsaWMgY2xvc2VEaWFsb2coZnJhbWVJZD86IHN0cmluZykge1xyXG4gICAgbGV0IGZyYW1lQ29udGV4dCA9IHRoaXMuZnJhbWVDb250ZXh0O1xyXG4gICAgbGV0IGRpYWxvZ1JlZiA9IG51bGw7XHJcbiAgICAvLyDlvIDlj5HogIXmjIflrprkuobnu4Tku7ZpZFxyXG4gICAgaWYgKGZyYW1lSWQpIHtcclxuICAgICAgZnJhbWVDb250ZXh0ID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dEJ5SWQoZnJhbWVJZCk7XHJcbiAgICAgIGlmICghZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCfmjIflrprkuobml6DmlYjnmoTnu4Tku7ZpZCcpO1xyXG4gICAgICB9XHJcbiAgICAgIGRpYWxvZ1JlZiA9IGZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudFsnZGlhbG9nUmVmJ107XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyDlsJ3or5Xku47lvZPliY3nu4Tku7bkuIrkuIvmlofkuK3ojrflj5blvLnnqpflvJXnlKhcclxuICAgICAgZGlhbG9nUmVmID0gZnJhbWVDb250ZXh0LmZyYW1lQ29tcG9uZW50WydkaWFsb2dSZWYnXTtcclxuICAgICAgaWYgKCFkaWFsb2dSZWYpIHtcclxuICAgICAgICAvLyDlpoLmnpzlkb3ku6TmjILovb3liLDkuoblhoXlrrnnu4Tku7bkuIpcclxuICAgICAgICBkaWFsb2dSZWYgPSB0aGlzLmZyYW1lQ29udGV4dC5wYXJlbnQuZnJhbWVDb21wb25lbnRbJ2RpYWxvZ1JlZiddO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBpZiAoIWRpYWxvZ1JlZikge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYOaXoOazleiOt+WPluW8ueeql+e7hOS7tuWunuS+i2ApO1xyXG4gICAgfVxyXG4gICAgZGlhbG9nUmVmLmNsb3NlKCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOi/mOWOn+iHquS4iuasoeaMgeS5heWMluS7peWQjuS6p+eUn+eahOWPmOabtFxyXG4gICAqIEBwYXJhbSBmcmFtZUlkIC0g57uE5Lu2aWRcclxuICAgKiBAcGFyYW0gaWQgLSDmlbDmja5pZFxyXG4gICAqIEBwYXJhbSBzaG93Q29uZmlybSAtIOaYr+WQpuWxleekuuaPkOekuuS/oeaBr1xyXG4gICAqL1xyXG4gIHB1YmxpYyBjYW5jZWxDaGFuZ2VzKGZyYW1lSWQ/OiBzdHJpbmcsIGlkPzogc3RyaW5nLCBzaG93Q29uZmlybTogYm9vbGVhbiB8IHN0cmluZyA9IHRydWUpIHtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0RnJhbWVDb250ZXh0KGZyYW1lSWQpO1xyXG4gICAgLy8g57qg5q2j5Li76ZSuXHJcbiAgICBpZCA9IHRoaXMuZ2V0UHJpbWFyeVZhbHVlKGZyYW1lSWQsIGlkKTtcclxuICAgIGNvbnN0IGRhdGEgPSB0aGlzLmdldFBlcnNpc3RlRGF0YShmcmFtZUlkLCBpZCk7XHJcbiAgICBpZiAodHlwZW9mIHNob3dDb25maXJtID09PSAnc3RyaW5nJykge1xyXG4gICAgICBzaG93Q29uZmlybSA9IHNob3dDb25maXJtLnRyaW0oKS50b0xvd2VyQ2FzZSgpID09PSAnZmFsc2UnID8gZmFsc2UgOiB0cnVlO1xyXG4gICAgfVxyXG4gICAgY29uc3QgaXNEYXRhQ2hhbmdlZCA9IHRoaXMuaXNEYXRhQ2hhbmdlZChkYXRhLCBmcmFtZUlkLCBpZCk7XHJcbiAgICBsZXQgcmVzdWx0JCA9IG9mKHRydWUpO1xyXG4gICAgaWYgKHNob3dDb25maXJtICYmIGlzRGF0YUNoYW5nZWQpIHtcclxuICAgICAgcmVzdWx0JCA9IHRoaXMubWVzc2FnZVNlcnZpY2UuY29uZmlybSh0aGlzLmxhbmd1YWdlU2VydmljZS5jYW5jZWxXaXRob3V0U2F2ZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0JC5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKHJlc3VsdDogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSBmcmFtZUNvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PGFueT47XHJcbiAgICAgICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKChwKSA9PiBwKTtcclxuICAgICAgICAgIGNvbnN0IGxvbmdQYXRocyA9IChEYXRhUGF0aENyZWF0b3IuY3JlYXRlQnlTaG9ydFBhdGhGcm9tUm9vdChiaW5kaW5nUGF0aHMsIGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlciwgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEpIGFzIERhdGFQYXRoKS50b0FycmF5KCkubWFwKChwYXRoOiBzdHJpbmcpID0+IHBhdGguc3BsaXQoJzonKVsxXSk7XHJcbiAgICAgICAgICBjb25zdCBlbnRpdHlQYXRocyA9IEFycmF5LmZyb20obG9uZ1BhdGhzKTtcclxuICAgICAgICAgIGNvbnN0IGVudGl0eSA9IGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlci5nZXRFbnRpdHlOb2RlQnlQYXRoKGVudGl0eVBhdGhzKSBhcyBFbnRpdHk7XHJcbiAgICAgICAgICBpZiAoZW50aXR5KSB7XHJcbiAgICAgICAgICAgIGVudGl0eS5sb2FkKGRhdGEpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5oyB5LmF5YyW5pWw5o2uXHJcbiAgICogQHBhcmFtIGZyYW1lSWQgLSDnu4Tku7ZpZFxyXG4gICAqIEBwYXJhbSBpZCAtIOaVsOaNrmlkXHJcbiAgICovXHJcbiAgcHVibGljIHBlcnNpc3RlKGZyYW1lSWQ/OiBzdHJpbmcsIGlkPzogc3RyaW5nKSB7XHJcbiAgICAvLyDmjIHkuYXljJbmlbDmja5cclxuICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSB0aGlzLmdldEJpbmRpbmdPYmplY3QoZnJhbWVJZCwgaWQpO1xyXG4gICAgYmluZGluZ09iamVjdFsnX19QU0VTSVNURV9fREFUQSddID0gYmluZGluZ09iamVjdC50b0pTT04oKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5oyB5LmF5YyW5pWw5o2uXHJcbiAgICogQHBhcmFtIGZyYW1lSWQgLSDnu4Tku7ZpZFxyXG4gICAqIEBwYXJhbSBpZCAtIOaVsOaNrmlkXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwcml2YXRlIGdldFBlcnNpc3RlRGF0YShmcmFtZUlkPzogc3RyaW5nLCBpZD86IHN0cmluZykge1xyXG4gICAgY29uc3QgYmluZGluZ09iamVjdCA9IHRoaXMuZ2V0QmluZGluZ09iamVjdChmcmFtZUlkLCBpZCk7XHJcbiAgICByZXR1cm4gYmluZGluZ09iamVjdFsnX19QU0VTSVNURV9fREFUQSddO1xyXG4gIH1cclxuICBwcml2YXRlIGlzRGF0YUNoYW5nZWQoZGF0YTogeyBbcHJvcDogc3RyaW5nXTogYW55IH0sIGZyYW1lSWQ/OiBzdHJpbmcsIGlkPzogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gdGhpcy5nZXRCaW5kaW5nT2JqZWN0KGZyYW1lSWQsIGlkKTtcclxuICAgIGNvbnN0IHZhbHVlID0gYmluZGluZ09iamVjdC50b0pTT04oKTtcclxuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgIT09IEpTT04uc3RyaW5naWZ5KGRhdGEpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5blvZPliY3ooYxcclxuICAgKiBAcGFyYW0gZnJhbWVJZCAtIOe7hOS7tmlkXHJcbiAgICogQHBhcmFtIGlkIC0g5pWw5o2uaWRcclxuICAgKiBAcmV0dXJuc1xyXG4gICAqIEB0aHJvd3Mg5om+5LiN5Yiw5a+55bqU5pWw5o2u5pe25oqb5Ye65peg5rOV5om+5Yiw5a+55bqU5pWw5o2u55qE5byC5bi4XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRCaW5kaW5nT2JqZWN0KGZyYW1lSWQ/OiBzdHJpbmcsIGlkPzogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSB0aGlzLmdldEZyYW1lQ29udGV4dChmcmFtZUlkKTtcclxuICAgIC8vIOe6oOato+S4u+mUrlxyXG4gICAgaWQgPSB0aGlzLmdldFByaW1hcnlWYWx1ZShmcmFtZUlkLCBpZCk7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKChwKSA9PiBwKTtcclxuICAgIC8vIOaLv+WIsOW9k+WJjeihjFxyXG4gICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldFZhbHVlKGJpbmRpbmdQYXRocykgYXMgQmluZGluZ0xpc3Q7XHJcbiAgICBpZiAoIWJpbmRpbmdMaXN0IHx8IGJpbmRpbmdMaXN0Lmxlbmd0aCA8IDEpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGDml6Dms5Xmib7liLBpZOS4ujoke2lkfeeahOaVsOaNrmApO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmnoTpgKDlrZDooajot6/lvoRcclxuICAgKiBAcGFyYW0gYmluZGluZ1BhdGggLSDnu5Hlrprot6/lvoRcclxuICAgKiBAcGFyYW0gaWQgLSBpZFxyXG4gICAqIEB0aHJvd3Mg5a2Q6KGo6Lev5b6E6ZSZ6K+vXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZFBhdGgoYmluZGluZ1BhdGg6IHN0cmluZywgaWQ6IGFueSkge1xyXG4gICAgbGV0IHBhdGggPSAnLycgKyBpZDtcclxuICAgIGNvbnN0IHN1YlBhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKTtcclxuICAgIGlmIChzdWJQYXRocy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIC8vIGVnOmJpbmRpbmdQYXRo5b2i5aaCL2VkdXMvZ3JhZGVzLHNwbGl05ZCO5pivWycnLCAnZWR1cycsICdncmFkZXMnXVxyXG4gICAgICAvLyDlm6DmraRpbmRleOS7jjHlvIDlp4tcclxuICAgICAgZm9yIChsZXQgaW5kZXggPSAxOyBpbmRleCA8IHN1YlBhdGhzLmxlbmd0aCAtIDE7IGluZGV4KyspIHtcclxuICAgICAgICBjb25zdCBzdWJQYXRoID0gc3ViUGF0aHNbaW5kZXhdO1xyXG4gICAgICAgIGNvbnN0IHN1YkRhdGEgPSB0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ0RhdGFbc3ViUGF0aF07XHJcbiAgICAgICAgaWYgKCFzdWJEYXRhIHx8ICFzdWJEYXRhLmN1cnJlbnRJZCkge1xyXG4gICAgICAgICAgdGhyb3cgRXJyb3IoYOiOt+WPluWtkOihqOWujOaVtOi3r+W+hOWHuumUme+8jOaJvuS4jeWIsCR7c3ViRGF0YX3lr7nlupTnmoTlrZDooajvvIzmiJblr7nlupTlrZDooajmsqHmnInlvZPliY3ooYzjgIJgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcGF0aCArPSBgLyR7c3ViUGF0aH0vJHtzdWJEYXRhLmN1cnJlbnRJZH1gO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBwYXRoICs9ICcvJyArIHN1YlBhdGhzW3N1YlBhdGhzLmxlbmd0aCAtIDFdO1xyXG4gICAgcmV0dXJuIHBhdGg7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOagueaNrue7hOS7tmlk6I635Y+W57uE5Lu25LiK5LiL5paHXHJcbiAgICogQHBhcmFtIGZyYW1lSWQgLSDnu4Tku7ZpZFxyXG4gICAqIEByZXR1cm5zXHJcbiAgICogQHRocm93cyDml6DmlYjnmoTnu4Tku7ZpZFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RnJhbWVDb250ZXh0KGZyYW1lSWQ/OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IGZyYW1lSWQgPyB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0QnlJZChmcmFtZUlkKSA6IHRoaXMuZnJhbWVDb250ZXh0O1xyXG4gICAgaWYgKCFmcmFtZUNvbnRleHQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGDml6DmlYjnmoTnu4Tku7ZpZO+8miR7ZnJhbWVJZH1gKTtcclxuICAgIH1cclxuICAgIHJldHVybiBmcmFtZUNvbnRleHQ7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluS4u+mUrlxyXG4gICAqIEBwYXJhbSBmcmFtZUlkIC0g57uE5Lu2aWRcclxuICAgKiBAcGFyYW0gaWQgLSDmlbDmja5pZFxyXG4gICAqIEByZXR1cm5zXHJcbiAgICogQHRocm93cyDnu4Tku7ZpZOaXoOaViOaXtuaKm+WHuuW8guW4uFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0UHJpbWFyeVZhbHVlKGZyYW1lSWQ/OiBzdHJpbmcsIGlkPzogc3RyaW5nKSB7XHJcbiAgICBpZiAoIWlkKSB7XHJcbiAgICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0RnJhbWVDb250ZXh0KGZyYW1lSWQpO1xyXG4gICAgICBpZiAoIWZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihg5peg5pWI55qE57uE5Lu2aWTvvJoke2ZyYW1lSWR9YCk7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgYmluZGluZ0xpc3QgPSBmcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0TGlzdCgpIGFzIEJpbmRpbmdMaXN0O1xyXG4gICAgICBpZiAoIWJpbmRpbmdMaXN0IHx8IGJpbmRpbmdMaXN0Lmxlbmd0aCA8IDEpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYOaXoOaViOeahOS4u+mUrjoke2lkfWApO1xyXG4gICAgICB9XHJcbiAgICAgIGlkID0gYmluZGluZ0xpc3QuY3VycmVudElkO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGlkO1xyXG4gIH1cclxufVxyXG4iXX0=