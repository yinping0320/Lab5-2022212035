import { Injectable } from "@angular/core";
import { Service } from "./service";
import { DatagridComponent } from '@farris/ui-datagrid';
export class DataGridService extends Service {
    /**
     * 清空所有勾选行
     * @description 取消勾选当前表单所有勾选行
     */
    clearChecks() {
        // const params = this.eventParam;
        // if (params && Array.isArray(params)) {
        // const param = params[0];
        // if (param instanceof QueryCondition) {
        const gridComponents = this.getFormGridComponents(this.context);
        if (gridComponents && gridComponents.length > 0) {
            gridComponents.forEach((gridComponent) => {
                let clearSelections = true;
                if (gridComponent.hasOwnProperty('clearSelectionsWhenDataIsEmpty')) {
                    clearSelections = gridComponent['clearSelectionsWhenDataIsEmpty'];
                }
                if (clearSelections) {
                    gridComponent.clearCheckeds(true);
                }
            });
        }
        // }
        // }
    }
    /**
     * 取消勾选删除的行
     * @param ids ids
     * @returns
     * @description 取消勾选当前绑定路径下指定数据，清空下级表格中所有勾选行，仅供删除场景使用
     */
    uncheckDeletedRows(ids) {
        if (typeof ids === 'string') {
            if (ids.indexOf(',') !== -1) {
                ids = ids.split(',').filter(p => p);
            }
            else {
                ids = [ids];
            }
        }
        if (!ids || ids.length < 1) {
            return;
        }
        // 获取bindingPath及ns
        const frameContext = this.context.frameContext;
        if (!frameContext) {
            return;
        }
        const appContext = frameContext.appContext;
        const ns = frameContext.namespace;
        const bindingPath = frameContext.viewModel && frameContext.viewModel.bindingPath;
        if (!appContext) {
            return;
        }
        // 根据bindingPath获取所有可能的frameContext
        const frameContexts = appContext.frameContextManager.getFrameContextsByNamespace(ns);
        const frameContextsInCurrentBindingPath = frameContexts.filter(frameContext => frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath === bindingPath);
        // 获取这些frame中所有的表格组件map
        const gridInCurrentFrame = this.getGridComponentByFrameContexts(frameContextsInCurrentBindingPath);
        if (!gridInCurrentFrame) {
            return;
        }
        // 一个bindingPath下应该只有一个grid
        const grid = gridInCurrentFrame.pop();
        // 清空命令所在的frame下表格的指定勾选
        if (grid) {
            grid.unCheckRows(ids, true);
        }
        // 清空下级表格的所有勾选行数据
        const childrenFrameContexts = frameContexts.filter(frameContext => frameContext.viewModel.bindingPath !== bindingPath && frameContext.viewModel.bindingPath.startsWith(bindingPath));
        const childrenGridComponents = this.getGridComponentByFrameContexts(childrenFrameContexts);
        // 清空命令所在frame
        if (childrenGridComponents && childrenGridComponents.length > 0) {
            childrenGridComponents.forEach((gridComponent) => {
                // 清空所有勾选
                gridComponent.checkedRows = [];
            });
        }
    }
    /**
     * 取消勾选行
     * @param ids ids
     * @returns
     */
    uncheckRows(ids) {
        if (typeof ids === 'string') {
            ids = [ids];
        }
        if (!ids || ids.length < 1) {
            return;
        }
        const gridComponents = this.getFormGridComponents(this.context);
        if (gridComponents && gridComponents.length > 0) {
            gridComponents.forEach((gridComponent) => {
                gridComponent.unCheckRows(ids, true);
            });
        }
    }
    /**
     * 根据命令上下文获取当前命令所在组件的表格实例
     * @param commandContext 命令上下文
     * @returns
     */
    getFormGridComponents(commandContext) {
        let grids = [];
        const frameContext = commandContext && commandContext.frameContext;
        const appContext = frameContext && frameContext.appContext || null;
        if (appContext) {
            const componentRefs = appContext.componentRefs;
            const collect = Array.from(componentRefs.values()); // [Map<string,any>,Map<string,any>]
            collect.forEach((item) => {
                const components = Array.from(item.values());
                const bindingPath = frameContext;
                const gridComponents = components.filter((component) => component instanceof DatagridComponent);
                grids = grids.concat(gridComponents);
            });
        }
        return grids;
    }
    getGridComponentByFrameContexts(frameContexts) {
        return frameContexts.reduce((result, frameContext) => {
            const appContext = frameContext.appContext;
            const frameId = frameContext.frameId;
            // 获取当前组件下所有的组件实例
            const componentsRef = appContext.componentRefs.get(frameId);
            const grids = componentsRef && Array.from(componentsRef.values()).filter(component => component instanceof DatagridComponent);
            if (grids && grids.length > 0) {
                result = result.concat(grids);
            }
            return result;
        }, []);
    }
}
DataGridService.decorators = [
    { type: Injectable }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1ncmlkLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZGF0YS1ncmlkLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBSXhELE1BQU0sT0FBTyxlQUFnQixTQUFRLE9BQU87SUFDMUM7OztPQUdHO0lBQ0ksV0FBVztRQUNoQixrQ0FBa0M7UUFDbEMseUNBQXlDO1FBQ3pDLDJCQUEyQjtRQUMzQix5Q0FBeUM7UUFDekMsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNoRSxJQUFJLGNBQWMsSUFBSSxjQUFjLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMvQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsYUFBZ0MsRUFBRSxFQUFFO2dCQUMxRCxJQUFJLGVBQWUsR0FBRyxJQUFJLENBQUM7Z0JBQzNCLElBQUksYUFBYSxDQUFDLGNBQWMsQ0FBQyxnQ0FBZ0MsQ0FBQyxFQUFFO29CQUNsRSxlQUFlLEdBQUcsYUFBYSxDQUFDLGdDQUFnQyxDQUFDLENBQUM7aUJBQ25FO2dCQUNELElBQUksZUFBZSxFQUFFO29CQUNuQixhQUFhLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUNuQztZQUNILENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxJQUFJO1FBQ0osSUFBSTtJQUNOLENBQUM7SUFDRDs7Ozs7T0FLRztJQUNJLGtCQUFrQixDQUFDLEdBQVE7UUFDaEMsSUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLEVBQUU7WUFDM0IsSUFBSSxHQUFHLENBQUMs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QUFHLFlBQVksQ0FBQyxVQUFVLENBQUM7WUFDM0MsTUFBTSxPQUFPLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQztZQUNyQyxpQkFBaUI7WUFDakIsTUFBTSxhQUFhLEdBQUcsVUFBVSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDNUQsTUFBTSxLQUFLLEdBQUcsYUFBYSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsU0FBUyxZQUFZLGlCQUFpQixDQUFDLENBQUM7WUFDOUgsSUFBSSxLQUFLLElBQUksS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQzdCLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQy9CO1lBQ0QsT0FBTyxNQUFNLENBQUM7UUFDaEIsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ1QsQ0FBQzs7O1lBbklGLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VcIjtcclxuaW1wb3J0IHsgRGF0YWdyaWRDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWRhdGFncmlkJztcclxuaW1wb3J0IHsgUXVlcnlDb25kaXRpb24gfSBmcm9tICdAZmFycmlzL2NvbXBvbmVudC1xdWVyeWNvbmRpdGlvbic7XHJcbmltcG9ydCB7IENvbW1hbmRDb250ZXh0LCBGcmFtZUNvbnRleHQgfSBmcm9tIFwiQGZhcnJpcy9kZXZraXRcIjtcclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRGF0YUdyaWRTZXJ2aWNlIGV4dGVuZHMgU2VydmljZSB7XHJcbiAgLyoqXHJcbiAgICog5riF56m65omA5pyJ5Yu+6YCJ6KGMXHJcbiAgICogQGRlc2NyaXB0aW9uIOWPlua2iOWLvumAieW9k+WJjeihqOWNleaJgOacieWLvumAieihjFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjbGVhckNoZWNrcygpIHtcclxuICAgIC8vIGNvbnN0IHBhcmFtcyA9IHRoaXMuZXZlbnRQYXJhbTtcclxuICAgIC8vIGlmIChwYXJhbXMgJiYgQXJyYXkuaXNBcnJheShwYXJhbXMpKSB7XHJcbiAgICAvLyBjb25zdCBwYXJhbSA9IHBhcmFtc1swXTtcclxuICAgIC8vIGlmIChwYXJhbSBpbnN0YW5jZW9mIFF1ZXJ5Q29uZGl0aW9uKSB7XHJcbiAgICBjb25zdCBncmlkQ29tcG9uZW50cyA9IHRoaXMuZ2V0Rm9ybUdyaWRDb21wb25lbnRzKHRoaXMuY29udGV4dCk7XHJcbiAgICBpZiAoZ3JpZENvbXBvbmVudHMgJiYgZ3JpZENvbXBvbmVudHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBncmlkQ29tcG9uZW50cy5mb3JFYWNoKChncmlkQ29tcG9uZW50OiBEYXRhZ3JpZENvbXBvbmVudCkgPT4ge1xyXG4gICAgICAgIGxldCBjbGVhclNlbGVjdGlvbnMgPSB0cnVlO1xyXG4gICAgICAgIGlmIChncmlkQ29tcG9uZW50Lmhhc093blByb3BlcnR5KCdjbGVhclNlbGVjdGlvbnNXaGVuRGF0YUlzRW1wdHknKSkge1xyXG4gICAgICAgICAgY2xlYXJTZWxlY3Rpb25zID0gZ3JpZENvbXBvbmVudFsnY2xlYXJTZWxlY3Rpb25zV2hlbkRhdGFJc0VtcHR5J107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjbGVhclNlbGVjdGlvbnMpIHtcclxuICAgICAgICAgIGdyaWRDb21wb25lbnQuY2xlYXJDaGVja2Vkcyh0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgLy8gfVxyXG4gICAgLy8gfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDlj5bmtojli77pgInliKDpmaTnmoTooYxcclxuICAgKiBAcGFyYW0gaWRzIGlkc1xyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqIEBkZXNjcmlwdGlvbiDlj5bmtojli77pgInlvZPliY3nu5Hlrprot6/lvoTkuIvmjIflrprmlbDmja7vvIzmuIXnqbrkuIvnuqfooajmoLzkuK3miYDmnInli77pgInooYzvvIzku4XkvpvliKDpmaTlnLrmma/kvb/nlKhcclxuICAgKi9cclxuICBwdWJsaWMgdW5jaGVja0RlbGV0ZWRSb3dzKGlkczogYW55KSB7XHJcbiAgICBpZiAodHlwZW9mIGlkcyA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgaWYgKGlkcy5pbmRleE9mKCcsJykgIT09IC0xKSB7XHJcbiAgICAgICAgaWRzID0gaWRzLnNwbGl0KCcsJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWRzID0gW2lkc107XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGlmICghaWRzIHx8IGlkcy5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIOiOt+WPlmJpbmRpbmdQYXRo5Y+KbnNcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuY29udGV4dC5mcmFtZUNvbnRleHQ7XHJcbiAgICBpZiAoIWZyYW1lQ29udGV4dCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBhcHBDb250ZXh0ID0gZnJhbWVDb250ZXh0LmFwcENvbnRleHQ7XHJcbiAgICBjb25zdCBucyA9IGZyYW1lQ29udGV4dC5uYW1lc3BhY2U7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcclxuICAgIGlmICghYXBwQ29udGV4dCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDmoLnmja5iaW5kaW5nUGF0aOiOt+WPluaJgOacieWPr+iDveeahGZyYW1lQ29udGV4dFxyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0cyA9IGFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzQnlOYW1lc3BhY2UobnMpO1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0c0luQ3VycmVudEJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0cy5maWx0ZXIoZnJhbWVDb250ZXh0ID0+IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09IGJpbmRpbmdQYXRoKTtcclxuICAgIC8vIOiOt+WPlui/meS6m2ZyYW1l5Lit5omA5pyJ55qE6KGo5qC857uE5Lu2bWFwXHJcbiAgICBjb25zdCBncmlkSW5DdXJyZW50RnJhbWUgPSB0aGlzLmdldEdyaWRDb21wb25lbnRCeUZyYW1lQ29udGV4dHMoZnJhbWVDb250ZXh0c0luQ3VycmVudEJpbmRpbmdQYXRoKTtcclxuICAgIGlmICghZ3JpZEluQ3VycmVudEZyYW1lKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIOS4gOS4qmJpbmRpbmdQYXRo5LiL5bqU6K+l5Y+q5pyJ5LiA5LiqZ3JpZFxyXG4gICAgY29uc3QgZ3JpZDogRGF0YWdyaWRDb21wb25lbnQgPSBncmlkSW5DdXJyZW50RnJhbWUucG9wKCk7XHJcbiAgICAvLyDmuIXnqbrlkb3ku6TmiYDlnKjnmoRmcmFtZeS4i+ihqOagvOeahOaMh+WumuWLvumAiVxyXG4gICAgaWYoZ3JpZCl7XHJcbiAgICAgIGdyaWQudW5DaGVja1Jvd3MoaWRzLCB0cnVlKTtcclxuICAgIH1cclxuICAgIC8vIOa4heepuuS4i+e6p+ihqOagvOeahOaJgOacieWLvumAieihjOaVsOaNrlxyXG4gICAgY29uc3QgY2hpbGRyZW5GcmFtZUNvbnRleHRzID0gZnJhbWVDb250ZXh0cy5maWx0ZXIoZnJhbWVDb250ZXh0ID0+IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggIT09IGJpbmRpbmdQYXRoICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGguc3RhcnRzV2l0aChiaW5kaW5nUGF0aCkpO1xyXG4gICAgY29uc3QgY2hpbGRyZW5HcmlkQ29tcG9uZW50cyA9IHRoaXMuZ2V0R3JpZENvbXBvbmVudEJ5RnJhbWVDb250ZXh0cyhjaGlsZHJlbkZyYW1lQ29udGV4dHMpO1xyXG4gICAgLy8g5riF56m65ZG95Luk5omA5ZyoZnJhbWVcclxuICAgIGlmIChjaGlsZHJlbkdyaWRDb21wb25lbnRzICYmIGNoaWxkcmVuR3JpZENvbXBvbmVudHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBjaGlsZHJlbkdyaWRDb21wb25lbnRzLmZvckVhY2goKGdyaWRDb21wb25lbnQ6IERhdGFncmlkQ29tcG9uZW50KSA9PiB7XHJcbiAgICAgICAgLy8g5riF56m65omA5pyJ5Yu+6YCJXHJcbiAgICAgICAgZ3JpZENvbXBvbmVudC5jaGVja2VkUm93cyA9IFtdO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Y+W5raI5Yu+6YCJ6KGMXHJcbiAgICogQHBhcmFtIGlkcyBpZHNcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgdW5jaGVja1Jvd3MoaWRzOiBhbnkpIHtcclxuICAgIGlmICh0eXBlb2YgaWRzID09PSAnc3RyaW5nJykge1xyXG4gICAgICBpZHMgPSBbaWRzXTtcclxuICAgIH1cclxuICAgIGlmICghaWRzIHx8IGlkcy5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGdyaWRDb21wb25lbnRzID0gdGhpcy5nZXRGb3JtR3JpZENvbXBvbmVudHModGhpcy5jb250ZXh0KTtcclxuICAgIGlmIChncmlkQ29tcG9uZW50cyAmJiBncmlkQ29tcG9uZW50cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGdyaWRDb21wb25lbnRzLmZvckVhY2goKGdyaWRDb21wb25lbnQ6IERhdGFncmlkQ29tcG9uZW50KSA9PiB7XHJcbiAgICAgICAgZ3JpZENvbXBvbmVudC51bkNoZWNrUm93cyhpZHMsIHRydWUpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5qC55o2u5ZG95Luk5LiK5LiL5paH6I635Y+W5b2T5YmN5ZG95Luk5omA5Zyo57uE5Lu255qE6KGo5qC85a6e5L6LXHJcbiAgICogQHBhcmFtIGNvbW1hbmRDb250ZXh0IOWRveS7pOS4iuS4i+aWh1xyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Rm9ybUdyaWRDb21wb25lbnRzKGNvbW1hbmRDb250ZXh0OiBDb21tYW5kQ29udGV4dCkge1xyXG4gICAgbGV0IGdyaWRzID0gW107XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSBjb21tYW5kQ29udGV4dCAmJiBjb21tYW5kQ29udGV4dC5mcmFtZUNvbnRleHQ7XHJcbiAgICBjb25zdCBhcHBDb250ZXh0ID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5hcHBDb250ZXh0IHx8IG51bGw7XHJcbiAgICBpZiAoYXBwQ29udGV4dCkge1xyXG4gICAgICBjb25zdCBjb21wb25lbnRSZWZzOiBNYXA8c3RyaW5nLCBNYXA8c3RyaW5nLCBhbnk+PiA9IGFwcENvbnRleHQuY29tcG9uZW50UmVmcztcclxuICAgICAgY29uc3QgY29sbGVjdCA9IEFycmF5LmZyb20oY29tcG9uZW50UmVmcy52YWx1ZXMoKSk7Ly8gW01hcDxzdHJpbmcsYW55PixNYXA8c3RyaW5nLGFueT5dXHJcbiAgICAgIGNvbGxlY3QuZm9yRWFjaCgoaXRlbTogTWFwPHN0cmluZywgYW55PikgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNvbXBvbmVudHMgPSBBcnJheS5mcm9tKGl0ZW0udmFsdWVzKCkpO1xyXG4gICAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0XHJcbiAgICAgICAgY29uc3QgZ3JpZENvbXBvbmVudHMgPSBjb21wb25lbnRzLmZpbHRlcigoY29tcG9uZW50OiBhbnkpID0+IGNvbXBvbmVudCBpbnN0YW5jZW9mIERhdGFncmlkQ29tcG9uZW50KTtcclxuICAgICAgICBncmlkcyA9IGdyaWRzLmNvbmNhdChncmlkQ29tcG9uZW50cyk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGdyaWRzO1xyXG4gIH1cclxuICBwcml2YXRlIGdldEdyaWRDb21wb25lbnRCeUZyYW1lQ29udGV4dHMoZnJhbWVDb250ZXh0czogRnJhbWVDb250ZXh0W10pIHtcclxuICAgIHJldHVybiBmcmFtZUNvbnRleHRzLnJlZHVjZSgocmVzdWx0LCBmcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgY29uc3QgYXBwQ29udGV4dCA9IGZyYW1lQ29udGV4dC5hcHBDb250ZXh0O1xyXG4gICAgICBjb25zdCBmcmFtZUlkID0gZnJhbWVDb250ZXh0LmZyYW1lSWQ7XHJcbiAgICAgIC8vIOiOt+WPluW9k+WJjee7hOS7tuS4i+aJgOacieeahOe7hOS7tuWunuS+i1xyXG4gICAgICBjb25zdCBjb21wb25lbnRzUmVmID0gYXBwQ29udGV4dC5jb21wb25lbnRSZWZzLmdldChmcmFtZUlkKTtcclxuICAgICAgY29uc3QgZ3JpZHMgPSBjb21wb25lbnRzUmVmICYmIEFycmF5LmZyb20oY29tcG9uZW50c1JlZi52YWx1ZXMoKSkuZmlsdGVyKGNvbXBvbmVudCA9PiBjb21wb25lbnQgaW5zdGFuY2VvZiBEYXRhZ3JpZENvbXBvbmVudCk7XHJcbiAgICAgIGlmIChncmlkcyAmJiBncmlkcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgcmVzdWx0ID0gcmVzdWx0LmNvbmNhdChncmlkcyk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH0sIFtdKTtcclxuICB9XHJcbn0iXX0=