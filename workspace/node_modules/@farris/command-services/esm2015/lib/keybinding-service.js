import { Injectable } from '@angular/core';
import * as Mousetrap from 'mousetrap';
/**
 * 快捷键服务
 * @scope FormModule
 */
export class KeybindingService {
    constructor() {
        this.keyMap = new Map();
        this.bindingProvider = Mousetrap.default;
        this.ready = true;
    }
    /**
     * 对视图模型设置的快捷键进行绑定处理
     * @param viewModel 视图模型
     */
    bind(viewModel) {
        viewModel.keybindingMap.forEach((keyBinding, method) => {
            this.register(keyBinding, () => {
                return viewModel[method]();
            });
        });
    }
    /**
     * 注册快捷键
     * @param binding 键盘绑定信息
     * @param handler 响应事件
     */
    register(binding, handler) {
        var combo = this._getCombo(binding);
        if (combo) {
            this.keyMap.set(combo, handler);
            if (binding.ctrlKey && binding.altKey && !binding.shiftKey) {
                // 实际发现，ctrl+alt组合，只能触发keyup事件
                this.bindingProvider.bind(combo, this._dispatch.bind(this), 'keyup');
            }
            else {
                this.bindingProvider.bind(combo, this._dispatch.bind(this));
            }
        }
    }
    /**
     * 取消快捷键注册
     * @param binding 键盘绑定信息
     */
    unregister(binding) {
        var combo = this._getCombo(binding);
        if (combo) {
            this.keyMap.delete(combo);
            this.bindingProvider.unbind(combo);
        }
    }
    _dispatch(e) {
        if (e.repeat)
            return false;
        if (this.ready) {
            var combo = this._getCombo(e);
            if (combo && this.keyMap.has(combo)) {
                this.ready = false;
                this.keyMap.get(combo)().subscribe(() => {
                    this.ready = true;
                }, (error) => {
                    this.ready = true;
                }, () => {
                    this.ready = true;
                });
            }
        }
        return false;
    }
    /**
     * 返回ctrl+shift+alt+a形式的组合字符串，全部为小写
     * @param keyInfo
     */
    _getCombo(keyInfo) {
        var key = keyInfo.key.toLowerCase();
        if (key.length != 1 || key.charCodeAt(0) < 97 /* a */ || key.charCodeAt(0) > 122 /* z */) {
            console.warn("快捷键字母形式为a-z");
            return null;
        }
        var combo = (keyInfo.ctrlKey ? 'ctrl+' : '')
            + (keyInfo.shiftKey ? 'shift+' : '')
            + (keyInfo.altKey ? 'alt+' : '')
            + (keyInfo.metaKey ? 'meta+' : '')
            + key;
        if (combo.length == 1) {
            console.warn("快捷键至少包含一个Modifier键");
            return null;
        }
        return combo;
    }
}
KeybindingService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
KeybindingService.ctorParameters = () => [];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2V5YmluZGluZy1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2tleWJpbmRpbmctc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sS0FBSyxTQUFTLE1BQU0sV0FBVyxDQUFDO0FBdUV2Qzs7O0dBR0c7QUFFSCxNQUFNLE9BQU8saUJBQWlCO0lBSzVCO1FBQ0UsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBaUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsZUFBZSxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUM7UUFDekMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7SUFDcEIsQ0FBQztJQUVEOzs7T0FHRztJQUNJLElBQUksQ0FBQyxTQUFvQjtRQUM5QixTQUFTLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNyRCxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUU7Z0JBQzdCLE9BQU8sU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDN0IsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRjs7OztPQUlHO0lBQ0ssUUFBUSxDQUFDLE9BQW1CLEVBQUUsT0FBOEI7UUFDakUsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNwQyxJQUFJLEtBQUssRUFBRTtZQUNULElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztZQUNoQyxJQUFJLE9BQU8sQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFR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Y2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEtleWJpbmRpbmcsIFZpZXdNb2RlbCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0J1xyXG5pbXBvcnQgKiBhcyBNb3VzZXRyYXAgZnJvbSAnbW91c2V0cmFwJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5cclxuY29uc3QgZW51bSBDaGFyQ29kZSB7XHJcblxyXG4gIERpZ2l0MCA9IDQ4LFxyXG4gIERpZ2l0MSA9IDQ5LFxyXG4gIERpZ2l0MiA9IDUwLFxyXG4gIERpZ2l0MyA9IDUxLFxyXG4gIERpZ2l0NCA9IDUyLFxyXG4gIERpZ2l0NSA9IDUzLFxyXG4gIERpZ2l0NiA9IDU0LFxyXG4gIERpZ2l0NyA9IDU1LFxyXG4gIERpZ2l0OCA9IDU2LFxyXG4gIERpZ2l0OSA9IDU3LFxyXG5cclxuICBBID0gNjUsXHJcbiAgQiA9IDY2LFxyXG4gIEMgPSA2NyxcclxuICBEID0gNjgsXHJcbiAgRSA9IDY5LFxyXG4gIEYgPSA3MCxcclxuICBHID0gNzEsXHJcbiAgSCA9IDcyLFxyXG4gIEkgPSA3MyxcclxuICBKID0gNzQsXHJcbiAgSyA9IDc1LFxyXG4gIEwgPSA3NixcclxuICBNID0gNzcsXHJcbiAgTiA9IDc4LFxyXG4gIE8gPSA3OSxcclxuICBQID0gODAsXHJcbiAgUSA9IDgxLFxyXG4gIFIgPSA4MixcclxuICBTID0gODMsXHJcbiAgVCA9IDg0LFxyXG4gIFUgPSA4NSxcclxuICBWID0gODYsXHJcbiAgVyA9IDg3LFxyXG4gIFggPSA4OCxcclxuICBZID0gODksXHJcbiAgWiA9IDkwLFxyXG5cclxuICBhID0gOTcsXHJcbiAgYiA9IDk4LFxyXG4gIGMgPSA5OSxcclxuICBkID0gMTAwLFxyXG4gIGUgPSAxMDEsXHJcbiAgZiA9IDEwMixcclxuICBnID0gMTAzLFxyXG4gIGggPSAxMDQsXHJcbiAgaSA9IDEwNSxcclxuICBqID0gMTA2LFxyXG4gIGsgPSAxMDcsXHJcbiAgbCA9IDEwOCxcclxuICBtID0gMTA5LFxyXG4gIG4gPSAxMTAsXHJcbiAgbyA9IDExMSxcclxuICBwID0gMTEyLFxyXG4gIHEgPSAxMTMsXHJcbiAgciA9IDExNCxcclxuICBzID0gMTE1LFxyXG4gIHQgPSAxMTYsXHJcbiAgdSA9IDExNyxcclxuICB2ID0gMTE4LFxyXG4gIHcgPSAxMTksXHJcbiAgeCA9IDEyMCxcclxuICB5ID0gMTIxLFxyXG4gIHogPSAxMjJcclxufVxyXG5cclxuLyoqXHJcbiAqIOW/q+aNt+mUruacjeWKoVxyXG4gKiBAc2NvcGUgRm9ybU1vZHVsZVxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgS2V5YmluZGluZ1NlcnZpY2Uge1xyXG4gIHByaXZhdGUga2V5TWFwOiBNYXA8U3RyaW5nLCAoKSA9PiBPYnNlcnZhYmxlPGFueT4+O1xyXG4gIHByaXZhdGUgYmluZGluZ1Byb3ZpZGVyOiBNb3VzZXRyYXA7XHJcbiAgcHJpdmF0ZSByZWFkeTogYm9vbGVhbjtcclxuXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICB0aGlzLmtleU1hcCA9IG5ldyBNYXA8U3RyaW5nLCAoKSA9PiBPYnNlcnZhYmxlPGFueT4+KCk7XHJcbiAgICB0aGlzLmJpbmRpbmdQcm92aWRlciA9IE1vdXNldHJhcC5kZWZhdWx0O1xyXG4gICAgdGhpcy5yZWFkeSA9IHRydWU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlr7nop4blm77mqKHlnovorr7nva7nmoTlv6vmjbfplK7ov5vooYznu5HlrprlpITnkIZcclxuICAgKiBAcGFyYW0gdmlld01vZGVsIOinhuWbvuaooeWei1xyXG4gICAqL1xyXG4gIHB1YmxpYyBiaW5kKHZpZXdNb2RlbDogVmlld01vZGVsKSB7XHJcbiAgICB2aWV3TW9kZWwua2V5YmluZGluZ01hcC5mb3JFYWNoKChrZXlCaW5kaW5nLCBtZXRob2QpID0+IHtcclxuICAgICAgdGhpcy5yZWdpc3RlcihrZXlCaW5kaW5nLCAoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHZpZXdNb2RlbFttZXRob2RdKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuXHQvKipcclxuXHQgKiDms6jlhozlv6vmjbfplK5cclxuXHQgKiBAcGFyYW0gYmluZGluZyDplK7nm5jnu5Hlrprkv6Hmga9cclxuXHQgKiBAcGFyYW0gaGFuZGxlciDlk43lupTkuovku7ZcclxuXHQgKi9cclxuICBwdWJsaWMgcmVnaXN0ZXIoYmluZGluZzogS2V5YmluZGluZywgaGFuZGxlcjogKCkgPT4gT2JzZXJ2YWJsZTxhbnk+KSB7XHJcbiAgICB2YXIgY29tYm8gPSB0aGlzLl9nZXRDb21ibyhiaW5kaW5nKTtcclxuICAgIGlmIChjb21ibykge1xyXG4gICAgICB0aGlzLmtleU1hcC5zZXQoY29tYm8sIGhhbmRsZXIpO1xyXG4gICAgICBpZiAoYmluZGluZy5jdHJsS2V5ICYmIGJpbmRpbmcuYWx0S2V5ICYmICFiaW5kaW5nLnNoaWZ0S2V5KSB7XHJcbiAgICAgICAgLy8g5a6e6ZmF5Y+R546w77yMY3RybCthbHTnu4TlkIjvvIzlj6rog73op6blj5FrZXl1cOS6i+S7tlxyXG4gICAgICAgIHRoaXMuYmluZGluZ1Byb3ZpZGVyLmJpbmQoY29tYm8sIHRoaXMuX2Rpc3BhdGNoLmJpbmQodGhpcyksICdrZXl1cCcpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuYmluZGluZ1Byb3ZpZGVyLmJpbmQoY29tYm8sIHRoaXMuX2Rpc3BhdGNoLmJpbmQodGhpcykpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlj5bmtojlv6vmjbfplK7ms6jlhoxcclxuICAgKiBAcGFyYW0gYmluZGluZyDplK7nm5jnu5Hlrprkv6Hmga8gXHJcbiAgICovXHJcbiAgcHVibGljIHVucmVnaXN0ZXIoYmluZGluZzogS2V5YmluZGluZykge1xyXG4gICAgdmFyIGNvbWJvID0gdGhpcy5fZ2V0Q29tYm8oYmluZGluZyk7XHJcbiAgICBpZiAoY29tYm8pIHtcclxuICAgICAgdGhpcy5rZXlNYXAuZGVsZXRlKGNvbWJvKTtcclxuICAgICAgdGhpcy5iaW5kaW5nUHJvdmlkZXIudW5iaW5kKGNvbWJvKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgX2Rpc3BhdGNoKGU6IEtleWJvYXJkRXZlbnQpOiBib29sZWFuIHtcclxuICAgIGlmIChlLnJlcGVhdCkgcmV0dXJuIGZhbHNlO1xyXG4gICAgaWYgKHRoaXMucmVhZHkpIHtcclxuICAgICAgdmFyIGNvbWJvID0gdGhpcy5fZ2V0Q29tYm8oZSk7XHJcbiAgICAgIGlmIChjb21ibyAmJiB0aGlzLmtleU1hcC5oYXMoY29tYm8pKSB7XHJcbiAgICAgICAgdGhpcy5yZWFkeSA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMua2V5TWFwLmdldChjb21ibykoKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5yZWFkeSA9IHRydWU7XHJcbiAgICAgICAgfSwgKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnJlYWR5ID0gdHJ1ZTtcclxuICAgICAgICB9LCAoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnJlYWR5ID0gdHJ1ZTtcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuXHJcblx0LyoqXHJcblx0ICog6L+U5ZueY3RybCtzaGlmdCthbHQrYeW9ouW8j+eahOe7hOWQiOWtl+espuS4su+8jOWFqOmDqOS4uuWwj+WGmVxyXG5cdCAqIEBwYXJhbSBrZXlJbmZvIFxyXG5cdCAqL1xyXG4gIHByaXZhdGUgX2dldENvbWJvKGtleUluZm86IEtleWJpbmRpbmcgfCBLZXlib2FyZEV2ZW50KTogU3RyaW5nIHwgbnVsbCB7XHJcbiAgICB2YXIga2V5ID0ga2V5SW5mby5rZXkudG9Mb3dlckNhc2UoKTtcclxuICAgIGlmIChrZXkubGVuZ3RoICE9IDEgfHwga2V5LmNoYXJDb2RlQXQoMCkgPCBDaGFyQ29kZS5hIHx8IGtleS5jaGFyQ29kZUF0KDApID4gQ2hhckNvZGUueikge1xyXG4gICAgICBjb25zb2xlLndhcm4oXCLlv6vmjbfplK7lrZfmr43lvaLlvI/kuLphLXpcIik7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgdmFyIGNvbWJvID0gKGtleUluZm8uY3RybEtleSA/ICdjdHJsKycgOiAnJylcclxuICAgICAgKyAoa2V5SW5mby5zaGlmdEtleSA/ICdzaGlmdCsnIDogJycpXHJcbiAgICAgICsgKGtleUluZm8uYWx0S2V5ID8gJ2FsdCsnIDogJycpXHJcbiAgICAgICsgKGtleUluZm8ubWV0YUtleSA/ICdtZXRhKycgOiAnJylcclxuICAgICAgKyBrZXk7XHJcblxyXG4gICAgaWYgKGNvbWJvLmxlbmd0aCA9PSAxKSB7XHJcbiAgICAgIGNvbnNvbGUud2FybihcIuW/q+aNt+mUruiHs+WwkeWMheWQq+S4gOS4qk1vZGlmaWVy6ZSuXCIpO1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gY29tYm87XHJcbiAgfVxyXG59Il19