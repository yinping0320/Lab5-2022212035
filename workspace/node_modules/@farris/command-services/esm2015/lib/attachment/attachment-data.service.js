import { Injectable } from '@angular/core';
import { of } from 'rxjs';
import { tap, switchMap, map } from 'rxjs/operators';
import { FrameContext, BindingPathConverter } from '@farris/devkit';
import { BefDataPathUtil } from '@farris/bef';
import { FormLoadingService } from '../form-loading/form-loading.service';
import { AttachmentUtil } from './attachment.util';
/**
 * 附件调用
 */
class AttachmentDataService {
    constructor(frameContext, loadingService) {
        this.frameContext = frameContext;
        this.loadingService = loadingService;
    }
    /**
     * 实体仓库
     */
    get repository() {
        return this.frameContext.repository;
    }
    /**
     * 绑定数据
     */
    get bindingData() {
        return this.frameContext.bindingData;
    }
    /**
     * 更新附件信息
     */
    updateRow(attachmentInfoFieldPath, attachmentInfo) {
        const restService = this.repository.restService;
        const baseUri = restService.baseUri;
        const updateUri = `${baseUri}/service/updateattachment`;
        const serverAttachInfo = this.createUpdateAttachInfo(attachmentInfoFieldPath, attachmentInfo);
        const body = {
            updateAttachInfo: serverAttachInfo,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            body: body
        };
        this.loadingService.show();
        return restService.invoke(updateUri, 'PUT', null, options).pipe(switchMap((responseInfo) => {
            return this.syncAttachmentInfosToClient();
        }), tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 通过属性名更新附件信息
     * @param attachmentInfoFieldPath 附件字段
     * @param attachmentInfo 附件信息
     */
    updateRowWithPropertyName(attachmentInfoFieldPath, attachmentInfo) {
        const restService = this.repository.restService;
        const baseUri = restService.baseUri;
        const updateUri = `${baseUri}/service/updateattachmentwithproptyname`;
        const serverAttachInfo = this.createUpdateAttachInfo(attachmentInfoFieldPath, attachmentInfo);
        const propertyName = attachmentInfoFieldPath.split('/').filter(p => p).pop();
        const body = {
            updateAttachInfo: serverAttachInfo,
            propertyName,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            body: body
        };
        this.loadingService.show();
        return restService.invoke(updateUri, 'PUT', null, options).pipe(switchMap((responseInfo) => {
            return this.syncAttachmentInfosToClient();
        }), tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 删除附件
     * @param attachmentInfoFieldPath
     * @param attachmentInfo
     * @returns
     */
    removeAttachment(attachmentInfoFieldPath, attachmentInfo) {
        const restService = this.repository.restService;
        const baseUri = restService.baseUri;
        const updateUri = `${baseUri}/service/deleteattachment`;
        const serverAttachInfo = this.createUpdateAttachInfo(attachmentInfoFieldPath, attachmentInfo);
        const propertyName = attachmentInfoFieldPath.split('/').filter(p => p).pop();
        const body = {
            deleteAttachInfo: serverAttachInfo,
            requestInfo: restService.buildRequestInfo(),
            propertyName,
        };
        const options = {
            body: body
        };
        this.loadingService.show();
        return restService.invoke(updateUri, 'PUT', null, options).pipe(switchMap((responseInfo) => {
            return this.syncAttachmentInfosToClient();
        }), tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 批量创建附件行数据
     */
    updateRows(attachmentInfoFieldPath, attachmentInfos) {
        const restService = this.repository.restService;
        const baseUri = restService.baseUri;
        const updateUri = `${baseUri}/service/batchuploadattachment`;
        const serverAttachInfo = this.createBatchCreateAttachInfo(attachmentInfoFieldPath, attachmentInfos);
        const isRootEntity = serverAttachInfo.NodeCodes.length === 0;
        const body = {
            batchUploadInfo: serverAttachInfo,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            body: body
        };
        return restService.invoke(updateUri, 'PUT', null, options).pipe(switchMap((responseInfo) => {
            return this.appendAttachmentInfosToClient(responseInfo.returnValue, isRootEntity);
        }), tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 批量创建附件行数据
     */
    updateRowsWithConfigs(attachmentInfoFieldPath, attachmentInfos, configs) {
        const restService = this.repository.restService;
        const baseUri = restService.baseUri;
        const updateUri = `${baseUri}/service/batchuploadattachment`;
        const serverAttachInfo = this.createBatchCreateAttachInfo(attachmentInfoFieldPath, attachmentInfos);
        // const isRootEntity = serverAttachInfo.NodeCodes.length === 0;
        const body = {
            batchUploadInfo: serverAttachInfo,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            body: body
        };
        return restService.invoke(updateUri, 'PUT', null, options).pipe(switchMap((responseInfo) => {
            return this.appendAttachmentInfos(responseInfo.returnValue, configs);
        }), tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 根据属性名批量创建附件行数据
     */
    updateRowsWithPropertyName(attachmentInfoFieldPath, attachmentInfos) {
        const restService = this.repository.restService;
        const baseUri = restService.baseUri;
        const updateUri = `${baseUri}/service/batchuploadattachmentwithproptyname`;
        const serverAttachInfo = this.createBatchCreateAttachInfo(attachmentInfoFieldPath, attachmentInfos);
        const isRootEntity = serverAttachInfo.NodeCodes.length === 0;
        const propertyName = attachmentInfoFieldPath.split('/').filter(p => p).pop();
        const body = {
            batchUploadInfo: serverAttachInfo,
            propertyName,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            body: body
        };
        return restService.invoke(updateUri, 'PUT', null, options).pipe(switchMap((responseInfo) => {
            return this.appendAttachmentInfosToClient(responseInfo.returnValue, isRootEntity);
        }), tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 创建服务器端需要的更新信息
     */
    createUpdateAttachInfo(attachmentInfoFieldPath, attachmentInfo) {
        const attachmentId = attachmentInfo.attachmentId;
        const parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        const nodeCodes = BefDataPathUtil.convertToObjectCodes(parentBindingPathArray, this.bindingData);
        const hiretryIds = BefDataPathUtil.convertToDataIdsForUpdate(parentBindingPathArray, this.bindingData);
        const serverAttachInfo = {
            NodeCodes: nodeCodes,
            HiretryIds: hiretryIds,
            AttachmentIds: [attachmentId],
            AttachmentId: attachmentId
        };
        return serverAttachInfo;
    }
    /**
     * 创建服务器端需要的批量新增附件信息
     */
    createBatchCreateAttachInfo(attachmentInfoFieldPath, attachmentInfo) {
        const attachmentIds = AttachmentUtil.peekAttachmentIds(attachmentInfo);
        const parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        const nodeCodes = BefDataPathUtil.convertToObjectCodes(parentBindingPathArray, this.bindingData);
        const hiretryIds = BefDataPathUtil.convertToDataIdsForAdd(parentBindingPathArray, this.bindingData);
        const serverAttachInfo = {
            NodeCodes: nodeCodes,
            HiretryIds: hiretryIds,
            AttachmentIds: attachmentIds,
            AttachmentId: null
        };
        return serverAttachInfo;
    }
    /**
     * 同步服务器端最新信息到客户端
     * @todo:
     * 1、主对象批量新增时不支持
     */
    syncAttachmentInfosToClient() {
        const rootDataId = this.bindingData.list.currentId;
        return this.repository.updateEntityById(rootDataId);
    }
    /**
     * 追加主表数据到客户端
     */
    appendAttachmentInfosToClient(listData, isRootEntity) {
        if (isRootEntity === true) {
            const entities = this.repository.buildEntities(listData);
            this.repository.entityCollection.addEntities(entities);
            return of(listData);
        }
        else {
            const rootDataId = this.bindingData.list.currentId;
            return this.repository.updateEntityById(rootDataId).pipe(map(() => listData));
        }
    }
    appendAttachmentInfos(listData, keyValues) {
        const entities = this.repository.buildEntities(listData);
        this.repository.entityCollection.addEntities(entities);
        // 更新实体使之产生变更集
        this.updateEntities(entities, keyValues);
        return of(listData);
    }
    updateEntities(entities, keyValues) {
        entities.forEach((entity) => {
            this.updateEntity(entity, keyValues);
        });
    }
    updateEntity(target, keyValues) {
        Object.keys(keyValues).forEach((key) => {
            this.setValueByPath(target, key, keyValues[key]);
        });
    }
    setValueByPath(target, path, value) {
        if (target) {
            const paths = path.split('.');
            if (paths.length <= 1) {
                target[path] = value;
            }
            else {
                paths.slice(0, -1).reduce((prev, path) => {
                    if (!(prev.hasOwnProperty(path) || prev['__proto__'].hasOwnProperty(path))) {
                        prev[path] = {};
                    }
                    return prev[path];
                }, target)[paths[paths.length - 1]] = value;
            }
        }
    }
}
AttachmentDataService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
AttachmentDataService.ctorParameters = () => [
    { type: FrameContext },
    { type: FormLoadingService }
];
export { AttachmentDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0YWNobWVudC1kYXRhLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvYXR0YWNobWVudC9hdHRhY2htZW50LWRhdGEuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckQsT0FBTyxFQUFFLFlBQVksRUFBdUIsb0JBQW9CLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RixPQUFPLEVBQWlCLGVBQWUsRUFBZ0IsTUFBTSxhQUFhLENBQUM7QUFDM0UsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFFMUUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRW5EOztHQUVHO0FBQ0gsTUFDTSxxQkFBcUI7SUFnQnpCLFlBQW9CLFlBQTBCLEVBQVUsY0FBa0M7UUFBdEUsaUJBQVksR0FBWixZQUFZLENBQWM7UUFBVSxtQkFBYyxHQUFkLGNBQWMsQ0FBb0I7SUFDMUYsQ0FBQztJQWZEOztPQUVHO0lBQ0gsSUFBWSxVQUFVO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFtQyxDQUFDO0lBQy9ELENBQUM7SUFFRDs7T0FFRztJQUNILElBQVksV0FBVztRQUNyQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO0lBQ3ZDLENBQUM7SUFLRDs7T0FFRztJQUNJLFNBQVMsQ0FBQyx1QkFBK0IsRUFBRSxjQUE4QjtRQUM5RSxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQztRQUNoRCxNQUFNLE9BQU8sR0FB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RTtvQkFDdkMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUU7d0JBQzFFLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7cUJBQ2pCO29CQUNELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNwQixDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUM7YUFDN0M7U0FDRjtJQUNILENBQUM7OztZQTNSRixVQUFVOzs7O1lBVEYsWUFBWTtZQUVaLGtCQUFrQjs7QUFzUzNCLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YXAsIHN3aXRjaE1hcCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQsIEVudGl0eSwgQmluZGluZ0RhdGEsIEJpbmRpbmdQYXRoQ29udmVydGVyIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBCZWZSZXBvc2l0b3J5LCBCZWZEYXRhUGF0aFV0aWwsIFJlc3BvbnNlSW5mbyB9IGZyb20gJ0BmYXJyaXMvYmVmJztcclxuaW1wb3J0IHsgRm9ybUxvYWRpbmdTZXJ2aWNlIH0gZnJvbSAnLi4vZm9ybS1sb2FkaW5nL2Zvcm0tbG9hZGluZy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQXR0YWNobWVudEluZm8sIFNlcnZlckF0dGFjaG1lbnRJbmZvIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IEF0dGFjaG1lbnRVdGlsIH0gZnJvbSAnLi9hdHRhY2htZW50LnV0aWwnO1xyXG5cclxuLyoqXHJcbiAqIOmZhOS7tuiwg+eUqFxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5jbGFzcyBBdHRhY2htZW50RGF0YVNlcnZpY2Uge1xyXG5cclxuICAvKipcclxuICAgKiDlrp7kvZPku5PlupNcclxuICAgKi9cclxuICBwcml2YXRlIGdldCByZXBvc2l0b3J5KCk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiB7XHJcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PEVudGl0eT47XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDnu5HlrprmlbDmja5cclxuICAgKi9cclxuICBwcml2YXRlIGdldCBiaW5kaW5nRGF0YSgpOiBCaW5kaW5nRGF0YSB7XHJcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGE7XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBwcml2YXRlIGxvYWRpbmdTZXJ2aWNlOiBGb3JtTG9hZGluZ1NlcnZpY2UpIHtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOabtOaWsOmZhOS7tuS/oeaBr1xyXG4gICAqL1xyXG4gIHB1YmxpYyB1cGRhdGVSb3coYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgYXR0YWNobWVudEluZm86IEF0dGFjaG1lbnRJbmZvKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5yZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XHJcbiAgICBjb25zdCB1cGRhdGVVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL3VwZGF0ZWF0dGFjaG1lbnRgO1xyXG4gICAgY29uc3Qgc2VydmVyQXR0YWNoSW5mbyA9IHRoaXMuY3JlYXRlVXBkYXRlQXR0YWNoSW5mbyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgYXR0YWNobWVudEluZm8pO1xyXG4gICAgY29uc3QgYm9keSA9IHtcclxuICAgICAgdXBkYXRlQXR0YWNoSW5mbzogc2VydmVyQXR0YWNoSW5mbyxcclxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxyXG4gICAgfTtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgIGJvZHk6IGJvZHlcclxuICAgIH07XHJcbiAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UodXBkYXRlVXJpLCAnUFVUJywgbnVsbCwgb3B0aW9ucykucGlwZShcclxuICAgICAgc3dpdGNoTWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnN5bmNBdHRhY2htZW50SW5mb3NUb0NsaWVudCgpO1xyXG4gICAgICB9KSxcclxuICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOmAmui/h+WxnuaAp+WQjeabtOaWsOmZhOS7tuS/oeaBr1xyXG4gICAqIEBwYXJhbSBhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCDpmYTku7blrZfmrrVcclxuICAgKiBAcGFyYW0gYXR0YWNobWVudEluZm8g6ZmE5Lu25L+h5oGvXHJcbiAgICovXHJcbiAgcHVibGljIHVwZGF0ZVJvd1dpdGhQcm9wZXJ0eU5hbWUoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgYXR0YWNobWVudEluZm86IEF0dGFjaG1lbnRJbmZvKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5yZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XHJcbiAgICBjb25zdCB1cGRhdGVVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL3VwZGF0ZWF0dGFjaG1lbnR3aXRocHJvcHR5bmFtZWA7XHJcbiAgICBjb25zdCBzZXJ2ZXJBdHRhY2hJbmZvID0gdGhpcy5jcmVhdGVVcGRhdGVBdHRhY2hJbmZvKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBhdHRhY2htZW50SW5mbyk7XHJcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBhdHRhY2htZW50SW5mb0ZpZWxkUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLnBvcCgpO1xyXG4gICAgY29uc3QgYm9keSA9IHtcclxuICAgICAgdXBkYXRlQXR0YWNoSW5mbzogc2VydmVyQXR0YWNoSW5mbyxcclxuICAgICAgcHJvcGVydHlOYW1lLFxyXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgYm9keTogYm9keVxyXG4gICAgfTtcclxuICAgIHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZSh1cGRhdGVVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc3luY0F0dGFjaG1lbnRJbmZvc1RvQ2xpZW50KCk7XHJcbiAgICAgIH0pLFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yig6Zmk6ZmE5Lu2XHJcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoIFxyXG4gICAqIEBwYXJhbSBhdHRhY2htZW50SW5mbyBcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgcmVtb3ZlQXR0YWNobWVudChhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBhdHRhY2htZW50SW5mbzogQXR0YWNobWVudEluZm8pIHtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5yZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XHJcbiAgICBjb25zdCB1cGRhdGVVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL2RlbGV0ZWF0dGFjaG1lbnRgO1xyXG4gICAgY29uc3Qgc2VydmVyQXR0YWNoSW5mbyA9IHRoaXMuY3JlYXRlVXBkYXRlQXR0YWNoSW5mbyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgYXR0YWNobWVudEluZm8pO1xyXG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gYXR0YWNobWVudEluZm9GaWVsZFBhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS5wb3AoKTtcclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgIGRlbGV0ZUF0dGFjaEluZm86IHNlcnZlckF0dGFjaEluZm8sXHJcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKCksXHJcbiAgICAgIHByb3BlcnR5TmFtZSxcclxuICAgIH07XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBib2R5OiBib2R5XHJcbiAgICB9O1xyXG4gICAgdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KCk7XHJcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKHVwZGF0ZVVyaSwgJ1BVVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zeW5jQXR0YWNobWVudEluZm9zVG9DbGllbnQoKTtcclxuICAgICAgfSksXHJcbiAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmibnph4/liJvlu7rpmYTku7booYzmlbDmja5cclxuICAgKi9cclxuICBwdWJsaWMgdXBkYXRlUm93cyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBhdHRhY2htZW50SW5mb3M6IEF0dGFjaG1lbnRJbmZvW10pOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSB0aGlzLnJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XHJcbiAgICBjb25zdCBiYXNlVXJpID0gcmVzdFNlcnZpY2UuYmFzZVVyaTtcclxuICAgIGNvbnN0IHVwZGF0ZVVyaSA9IGAke2Jhc2VVcml9L3NlcnZpY2UvYmF0Y2h1cGxvYWRhdHRhY2htZW50YDtcclxuICAgIGNvbnN0IHNlcnZlckF0dGFjaEluZm8gPSB0aGlzLmNyZWF0ZUJhdGNoQ3JlYXRlQXR0YWNoSW5mbyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgYXR0YWNobWVudEluZm9zKTtcclxuICAgIGNvbnN0IGlzUm9vdEVudGl0eSA9IHNlcnZlckF0dGFjaEluZm8uTm9kZUNvZGVzLmxlbmd0aCA9PT0gMDtcclxuXHJcbiAgICBjb25zdCBib2R5ID0ge1xyXG4gICAgICBiYXRjaFVwbG9hZEluZm86IHNlcnZlckF0dGFjaEluZm8sXHJcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcclxuICAgIH07XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBib2R5OiBib2R5XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZSh1cGRhdGVVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwZW5kQXR0YWNobWVudEluZm9zVG9DbGllbnQocmVzcG9uc2VJbmZvLnJldHVyblZhbHVlLCBpc1Jvb3RFbnRpdHkpO1xyXG4gICAgICB9KSxcclxuICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJuemHj+WIm+W7uumZhOS7tuihjOaVsOaNrlxyXG4gICAqL1xyXG4gIHB1YmxpYyB1cGRhdGVSb3dzV2l0aENvbmZpZ3MoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgYXR0YWNobWVudEluZm9zOiBBdHRhY2htZW50SW5mb1tdLCBjb25maWdzOiB7IFtwcm9wOiBzdHJpbmddOiBhbnkgfSk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHRoaXMucmVwb3NpdG9yeS5yZXN0U2VydmljZTtcclxuICAgIGNvbnN0IGJhc2VVcmkgPSByZXN0U2VydmljZS5iYXNlVXJpO1xyXG4gICAgY29uc3QgdXBkYXRlVXJpID0gYCR7YmFzZVVyaX0vc2VydmljZS9iYXRjaHVwbG9hZGF0dGFjaG1lbnRgO1xyXG4gICAgY29uc3Qgc2VydmVyQXR0YWNoSW5mbyA9IHRoaXMuY3JlYXRlQmF0Y2hDcmVhdGVBdHRhY2hJbmZvKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBhdHRhY2htZW50SW5mb3MpO1xyXG4gICAgLy8gY29uc3QgaXNSb290RW50aXR5ID0gc2VydmVyQXR0YWNoSW5mby5Ob2RlQ29kZXMubGVuZ3RoID09PSAwO1xyXG5cclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgIGJhdGNoVXBsb2FkSW5mbzogc2VydmVyQXR0YWNoSW5mbyxcclxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxyXG4gICAgfTtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgIGJvZHk6IGJvZHlcclxuICAgIH07XHJcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKHVwZGF0ZVVyaSwgJ1BVVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5hcHBlbmRBdHRhY2htZW50SW5mb3MocmVzcG9uc2VJbmZvLnJldHVyblZhbHVlLCBjb25maWdzKTtcclxuICAgICAgfSksXHJcbiAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmoLnmja7lsZ7mgKflkI3mibnph4/liJvlu7rpmYTku7booYzmlbDmja5cclxuICAgKi9cclxuICBwdWJsaWMgdXBkYXRlUm93c1dpdGhQcm9wZXJ0eU5hbWUoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgYXR0YWNobWVudEluZm9zOiBBdHRhY2htZW50SW5mb1tdKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5yZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XHJcbiAgICBjb25zdCB1cGRhdGVVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL2JhdGNodXBsb2FkYXR0YWNobWVudHdpdGhwcm9wdHluYW1lYDtcclxuICAgIGNvbnN0IHNlcnZlckF0dGFjaEluZm8gPSB0aGlzLmNyZWF0ZUJhdGNoQ3JlYXRlQXR0YWNoSW5mbyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgYXR0YWNobWVudEluZm9zKTtcclxuICAgIGNvbnN0IGlzUm9vdEVudGl0eSA9IHNlcnZlckF0dGFjaEluZm8uTm9kZUNvZGVzLmxlbmd0aCA9PT0gMDtcclxuICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkucG9wKCk7XHJcblxyXG4gICAgY29uc3QgYm9keSA9IHtcclxuICAgICAgYmF0Y2hVcGxvYWRJbmZvOiBzZXJ2ZXJBdHRhY2hJbmZvLFxyXG4gICAgICBwcm9wZXJ0eU5hbWUsXHJcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcclxuICAgIH07XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBib2R5OiBib2R5XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZSh1cGRhdGVVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwZW5kQXR0YWNobWVudEluZm9zVG9DbGllbnQocmVzcG9uc2VJbmZvLnJldHVyblZhbHVlLCBpc1Jvb3RFbnRpdHkpO1xyXG4gICAgICB9KSxcclxuICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliJvlu7rmnI3liqHlmajnq6/pnIDopoHnmoTmm7TmlrDkv6Hmga9cclxuICAgKi9cclxuICBwcml2YXRlIGNyZWF0ZVVwZGF0ZUF0dGFjaEluZm8oYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgYXR0YWNobWVudEluZm86IEF0dGFjaG1lbnRJbmZvKTogU2VydmVyQXR0YWNobWVudEluZm8ge1xyXG5cclxuICAgIGNvbnN0IGF0dGFjaG1lbnRJZCA9IGF0dGFjaG1lbnRJbmZvLmF0dGFjaG1lbnRJZDtcclxuICAgIGNvbnN0IHBhcmVudEJpbmRpbmdQYXRoQXJyYXkgPSBCaW5kaW5nUGF0aENvbnZlcnRlci50b0JpbmRpbmdQYXRoQXJyYXkoYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xyXG4gICAgcGFyZW50QmluZGluZ1BhdGhBcnJheS5wb3AoKTtcclxuICAgIGNvbnN0IG5vZGVDb2RlcyA9IEJlZkRhdGFQYXRoVXRpbC5jb252ZXJ0VG9PYmplY3RDb2RlcyhwYXJlbnRCaW5kaW5nUGF0aEFycmF5LCB0aGlzLmJpbmRpbmdEYXRhKTtcclxuICAgIGNvbnN0IGhpcmV0cnlJZHMgPSBCZWZEYXRhUGF0aFV0aWwuY29udmVydFRvRGF0YUlkc0ZvclVwZGF0ZShwYXJlbnRCaW5kaW5nUGF0aEFycmF5LCB0aGlzLmJpbmRpbmdEYXRhKTtcclxuXHJcbiAgICBjb25zdCBzZXJ2ZXJBdHRhY2hJbmZvOiBTZXJ2ZXJBdHRhY2htZW50SW5mbyA9IHtcclxuICAgICAgTm9kZUNvZGVzOiBub2RlQ29kZXMsXHJcbiAgICAgIEhpcmV0cnlJZHM6IGhpcmV0cnlJZHMsXHJcbiAgICAgIEF0dGFjaG1lbnRJZHM6IFthdHRhY2htZW50SWRdLFxyXG4gICAgICBBdHRhY2htZW50SWQ6IGF0dGFjaG1lbnRJZFxyXG4gICAgfTtcclxuXHJcbiAgICByZXR1cm4gc2VydmVyQXR0YWNoSW5mbztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIm+W7uuacjeWKoeWZqOerr+mcgOimgeeahOaJuemHj+aWsOWinumZhOS7tuS/oeaBr1xyXG4gICAqL1xyXG4gIHByaXZhdGUgY3JlYXRlQmF0Y2hDcmVhdGVBdHRhY2hJbmZvKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIGF0dGFjaG1lbnRJbmZvOiBBdHRhY2htZW50SW5mb1tdKTogU2VydmVyQXR0YWNobWVudEluZm8ge1xyXG4gICAgY29uc3QgYXR0YWNobWVudElkcyA9IEF0dGFjaG1lbnRVdGlsLnBlZWtBdHRhY2htZW50SWRzKGF0dGFjaG1lbnRJbmZvKTtcclxuXHJcbiAgICBjb25zdCBwYXJlbnRCaW5kaW5nUGF0aEFycmF5ID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcclxuICAgIHBhcmVudEJpbmRpbmdQYXRoQXJyYXkucG9wKCk7XHJcbiAgICBjb25zdCBub2RlQ29kZXMgPSBCZWZEYXRhUGF0aFV0aWwuY29udmVydFRvT2JqZWN0Q29kZXMocGFyZW50QmluZGluZ1BhdGhBcnJheSwgdGhpcy5iaW5kaW5nRGF0YSk7XHJcbiAgICBjb25zdCBoaXJldHJ5SWRzID0gQmVmRGF0YVBhdGhVdGlsLmNvbnZlcnRUb0RhdGFJZHNGb3JBZGQocGFyZW50QmluZGluZ1BhdGhBcnJheSwgdGhpcy5iaW5kaW5nRGF0YSk7XHJcblxyXG4gICAgY29uc3Qgc2VydmVyQXR0YWNoSW5mbyA9IHtcclxuICAgICAgTm9kZUNvZGVzOiBub2RlQ29kZXMsXHJcbiAgICAgIEhpcmV0cnlJZHM6IGhpcmV0cnlJZHMsXHJcbiAgICAgIEF0dGFjaG1lbnRJZHM6IGF0dGFjaG1lbnRJZHMsXHJcbiAgICAgIEF0dGFjaG1lbnRJZDogbnVsbFxyXG4gICAgfTtcclxuXHJcbiAgICByZXR1cm4gc2VydmVyQXR0YWNoSW5mbztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWQjOatpeacjeWKoeWZqOerr+acgOaWsOS/oeaBr+WIsOWuouaIt+err1xyXG4gICAqIEB0b2RvOlxyXG4gICAqIDHjgIHkuLvlr7nosaHmibnph4/mlrDlop7ml7bkuI3mlK/mjIFcclxuICAgKi9cclxuICBwdWJsaWMgc3luY0F0dGFjaG1lbnRJbmZvc1RvQ2xpZW50KCkge1xyXG4gICAgY29uc3Qgcm9vdERhdGFJZCA9IHRoaXMuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XHJcbiAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5LnVwZGF0ZUVudGl0eUJ5SWQocm9vdERhdGFJZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDov73liqDkuLvooajmlbDmja7liLDlrqLmiLfnq69cclxuICAgKi9cclxuICBwdWJsaWMgYXBwZW5kQXR0YWNobWVudEluZm9zVG9DbGllbnQobGlzdERhdGE6IGFueVtdLCBpc1Jvb3RFbnRpdHk6IGJvb2xlYW4pOiBPYnNlcnZhYmxlPGFueVtdPiB7XHJcbiAgICBpZiAoaXNSb290RW50aXR5ID09PSB0cnVlKSB7XHJcbiAgICAgIGNvbnN0IGVudGl0aWVzID0gdGhpcy5yZXBvc2l0b3J5LmJ1aWxkRW50aXRpZXMobGlzdERhdGEpO1xyXG4gICAgICB0aGlzLnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdGllcyhlbnRpdGllcyk7XHJcbiAgICAgIHJldHVybiBvZihsaXN0RGF0YSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCByb290RGF0YUlkID0gdGhpcy5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZDtcclxuICAgICAgcmV0dXJuIHRoaXMucmVwb3NpdG9yeS51cGRhdGVFbnRpdHlCeUlkKHJvb3REYXRhSWQpLnBpcGUoXHJcbiAgICAgICAgbWFwKCgpID0+IGxpc3REYXRhKVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuICBwdWJsaWMgYXBwZW5kQXR0YWNobWVudEluZm9zKGxpc3REYXRhOiBhbnlbXSwga2V5VmFsdWVzOiB7IFtwcm9wOiBzdHJpbmddOiBhbnkgfSk6IE9ic2VydmFibGU8YW55W10+IHtcclxuICAgIGNvbnN0IGVudGl0aWVzID0gdGhpcy5yZXBvc2l0b3J5LmJ1aWxkRW50aXRpZXMobGlzdERhdGEpO1xyXG4gICAgdGhpcy5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uYWRkRW50aXRpZXMoZW50aXRpZXMpO1xyXG4gICAgLy8g5pu05paw5a6e5L2T5L2/5LmL5Lqn55Sf5Y+Y5pu06ZuGXHJcbiAgICB0aGlzLnVwZGF0ZUVudGl0aWVzKGVudGl0aWVzLCBrZXlWYWx1ZXMpO1xyXG4gICAgcmV0dXJuIG9mKGxpc3REYXRhKTtcclxuICB9XHJcbiAgcHJpdmF0ZSB1cGRhdGVFbnRpdGllcyhlbnRpdGllczogRW50aXR5W10sIGtleVZhbHVlczogeyBbcHJvcDogc3RyaW5nXTogYW55IH0pIHtcclxuICAgIGVudGl0aWVzLmZvckVhY2goKGVudGl0eTogRW50aXR5KSA9PiB7XHJcbiAgICAgIHRoaXMudXBkYXRlRW50aXR5KGVudGl0eSwga2V5VmFsdWVzKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIHVwZGF0ZUVudGl0eSh0YXJnZXQ6IEVudGl0eSwga2V5VmFsdWVzOiB7IFtwcm9wOiBzdHJpbmddOiBhbnkgfSkge1xyXG4gICAgT2JqZWN0LmtleXMoa2V5VmFsdWVzKS5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICB0aGlzLnNldFZhbHVlQnlQYXRoKHRhcmdldCwga2V5LCBrZXlWYWx1ZXNba2V5XSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHJpdmF0ZSBzZXRWYWx1ZUJ5UGF0aCh0YXJnZXQ6IG9iamVjdCwgcGF0aDogc3RyaW5nLCB2YWx1ZTogYW55KSB7XHJcbiAgICBpZiAodGFyZ2V0KSB7XHJcbiAgICAgIGNvbnN0IHBhdGhzID0gcGF0aC5zcGxpdCgnLicpO1xyXG4gICAgICBpZiAocGF0aHMubGVuZ3RoIDw9IDEpIHtcclxuICAgICAgICB0YXJnZXRbcGF0aF0gPSB2YWx1ZTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBwYXRocy5zbGljZSgwLCAtMSkucmVkdWNlKChwcmV2LCBwYXRoKSA9PiB7XHJcbiAgICAgICAgICBpZiAoIShwcmV2Lmhhc093blByb3BlcnR5KHBhdGgpIHx8IHByZXZbJ19fcHJvdG9fXyddLmhhc093blByb3BlcnR5KHBhdGgpKSkge1xyXG4gICAgICAgICAgICBwcmV2W3BhdGhdID0ge307XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gcHJldltwYXRoXTtcclxuICAgICAgICB9LCB0YXJnZXQpW3BhdGhzW3BhdGhzLmxlbmd0aCAtIDFdXSA9IHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5cclxuZXhwb3J0IHsgQXR0YWNobWVudERhdGFTZXJ2aWNlIH07XHJcbiJdfQ==