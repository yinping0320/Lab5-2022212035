import { Inject, Injectable, Injector } from "@angular/core";
import { BigNumber } from 'bignumber.js';
import moment from 'moment';
import { UserSettingsToken } from "@farris/devkit";
export class LocalizationService {
    constructor(injector, userSettings) {
        this.injector = injector;
        this.userSettings = userSettings;
    }
    /**
     * 用户配置格式
     */
    get formats() {
        const { dateFormat = null, timeFormat = null } = this.userSettings || {};
        let dateTimeFormat = null;
        if (dateFormat && timeFormat) {
            dateTimeFormat = `${dateFormat} ${timeFormat}`;
        }
        const date = {
            dateFormat,
            timeFormat,
            dateTimeFormat
        };
        const { negativeSign = null, numberDecimalDigits = null, numberDecimalSeparator = null, numberGroupSeparator = null } = this.numberFormat || {};
        const number = {
            negativeSign,
            numberDecimalDigits,
            numberDecimalSeparator,
            numberGroupSeparator
        };
        return { date, number };
    }
    /**
     * 根据数据类型本地化数据
     * @param value value
     * @param dataType 数据类型
     * @returns string
     */
    localize(value, dataType) {
        if (dataType && value) {
            dataType = dataType.toLowerCase();
            if (dataType === 'date') {
                return this.transformDate(value);
            }
            else if (dataType === 'datetime') {
                return this.transformDateTime(value);
            }
            else if (dataType === 'number') {
                return this.transformNumber(value);
            }
            else {
                return value;
            }
        }
        else {
            return value;
        }
    }
    /**
     * 根据国际化类型获取格式化字符串
     * @param localizationType 国际化类型
     * @returns
     */
    getFormat(localizationType) {
        if (localizationType) {
            localizationType = localizationType.toLowerCase();
        }
        if (localizationType === 'date') {
            return this.formats.date.dateFormat;
        }
        else if (localizationType === 'datetime') {
            return this.formats.date.dateTimeFormat;
        }
        else {
            return '';
        }
    }
    /**
     * 转换日期
     * @param value value
     */
    transformDate(value) {
        let dateFormat = this.userSettings && this.userSettings.dateFormat || 'YYYY-MM-DD';
        if (!dateFormat || !value) {
            return value;
        }
        const date = moment(value);
        const isValid = date.isValid();
        if (!isValid) {
            return value;
        }
        dateFormat = this.parseDateFormat(dateFormat);
        return date.format(dateFormat);
    }
    /**
     * 转换日期时间
     * @param value value
     * todo: 目前无法定义日期时间格式
     */
    transformDateTime(value) {
        let dateFormat = this.userSettings && this.userSettings.dateFormat || 'YYYY-MM-DD';
        let timeFormat = this.userSettings && this.userSettings.timeFormat || 'HH:mm:ss';
        if (!dateFormat || !timeFormat) {
            return value;
        }
        const dateTime = moment(value);
        const isValid = dateTime.isValid();
        if (!isValid) {
            return value;
        }
        if (dateFormat) {
            dateFormat = this.parseDateFormat(dateFormat);
        }
        if (timeFormat) {
            timeFormat = this.parseTimeFormat(timeFormat);
        }
        const dateTimeFormat = dateFormat + ' ' + timeFormat;
        return dateTime.format(dateTimeFormat);
    }
    /**
     * 转换数字
     * @param value value
     */
    transformNumber(value) {
        if (value === null || value === undefined || value === '') {
            return '';
        }
        const bigNumber = new BigNumber(value);
        // 如果不是数字，不做任何处理
        if (!BigNumber.isBigNumber(bigNumber)) {
            return value;
        }
        const isNegative = bigNumber.isNegative();
        const format = this.buildNumberFormat();
        const { negativeSign = null, numberDecimalDigits = null } = this.numberFormat || {};
        if (isNegative) {
            if (negativeSign !== null) {
                format.prefix = negativeSign;
                return bigNumber.absoluteValue().toFormat(numberDecimalDigits, null, format);
            }
        }
        return bigNumber.toFormat(numberDecimalDigits, null, format);
    }
    /**
     * 转换日期格式规则为moment的format规则
     * @param format format
     */
    parseDateFormat(format) {
        return format.replace(/y/g, 'Y').replace(/d/g, 'D');
    }
    /**
     * 转换时间格式规则为moment的format规则
     * @param format format
     */
    parseTimeFormat(format) {
        return format.replace(/M/g, 'm');
    }
    /**
     * 构造bignumber数字格式化选项
     */
    buildNumberFormat() {
        if (this.numberFormat) {
            const { numberDecimalSeparator = null, numberGroupSeparator = null } = this.numberFormat;
            const format = {
                groupSize: 3,
            };
            if (numberDecimalSeparator !== null) {
                format.decimalSeparator = numberDecimalSeparator;
            }
            if (numberGroupSeparator !== null) {
                format.groupSeparator = numberGroupSeparator;
            }
            return format;
        }
    }
    get numberFormat() {
        return this.userSettings && this.userSettings.numberFormat || null;
    }
}
LocalizationService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
LocalizationService.ctorParameters = () => [
    { type: Injector },
    { type: undefined, decorators: [{ type: Inject, args: [UserSettingsToken,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWxpemF0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvbG9jYWxpemF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDekMsT0FBTyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBQzVCLE9BQU8sRUFBOEIsaUJBQWlCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUcvRSxNQUFNLE9BQU8sbUJBQW1CO0lBQzlCLFlBQW9CLFFBQWtCLEVBQXFDLFlBQTBCO1FBQWpGLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBcUMsaUJBQVksR0FBWixZQUFZLENBQWM7SUFBSSxDQUFDO0lBRTFHOztPQUVHO0lBQ0gsSUFBVyxPQUFPO1FBQ2hCLE1BQU0sRUFBRSxVQUFVLEdBQUcsSUFBSSxFQUFFLFVBQVUsR0FBRyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsWUFBWSxJQUFJLEVBQUUsQ0FBQztRQUN6RSxJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUM7UUFDMUIsSUFBSSxVQUFVLElBQUksVUFBVSxFQUFFO1lBQzVCLGNBQWMsR0FBRyxHQUFHLFVBQVUsSUFBSSxVQUFVLEVBQUUsQ0FBQztTQUNoRDtRQUNELE1BQU0sSUFBSSxHQUFHO1lBQ1gsVUFBVTtZQUNWLFVBQVU7WUFDVixjQUFjO1NBQ2YsQ0FBQztRQUNGLE1BQU0sRUFBRSxZQUFZLEdBQUcsSUFBSSxFQUFFLG1CQUFtQixHQUFHLElBQUksRUFBRSxzQkFBc0IsR0FBRyxJQUFJLEVBQUUsb0JBQW9CLEdBQUcsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUM7UUFDaEosTUFBTSxNQUFNLEdBQUc7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OztPQUdHO0lBQ0ssZUFBZSxDQUFDLE1BQWM7UUFDcEMsT0FBTyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFDRDs7O09BR0c7SUFDSyxlQUFlLENBQUMsTUFBYztRQUNwQyxPQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFDRDs7T0FFRztJQUNLLGlCQUFpQjtRQUN2QixJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDckIsTUFBTSxFQUFFLHNCQUFzQixHQUFHLElBQUksRUFBRSxvQkFBb0IsR0FBRyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDO1lBQ3pGLE1BQU0sTUFBTSxHQUFRO2dCQUNsQixTQUFTLEVBQUUsQ0FBQzthQUNiLENBQUM7WUFDRixJQUFJLHNCQUFzQixLQUFLLElBQUksRUFBRTtnQkFDbkMsTUFBTSxDQUFDLGdCQUFnQixHQUFHLHNCQUFzQixDQUFDO2FBQ2xEO1lBQ0QsSUFBSSxvQkFBb0IsS0FBSyxJQUFJLEVBQUU7Z0JBQ2pDLE1BQU0sQ0FBQyxjQUFjLEdBQUcsb0JBQW9CLENBQUM7YUFDOUM7WUFDRCxPQUFPLE1BQU0sQ0FBQztTQUNmO0lBQ0gsQ0FBQztJQUNELElBQVksWUFBWTtRQUN0QixPQUFPLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDO0lBQ3JFLENBQUM7OztZQXRLRixVQUFVOzs7O1lBTGtCLFFBQVE7NENBT00sTUFBTSxTQUFDLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdiaWdudW1iZXIuanMnO1xyXG5pbXBvcnQgbW9tZW50IGZyb20gJ21vbWVudCc7XHJcbmltcG9ydCB7IE51bWJlckZvcm1hdCwgVXNlclNldHRpbmdzLCBVc2VyU2V0dGluZ3NUb2tlbiB9IGZyb20gXCJAZmFycmlzL2RldmtpdFwiO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgTG9jYWxpemF0aW9uU2VydmljZSB7XHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIEBJbmplY3QoVXNlclNldHRpbmdzVG9rZW4pIHByaXZhdGUgdXNlclNldHRpbmdzOiBVc2VyU2V0dGluZ3MpIHsgfVxyXG5cclxuICAvKipcclxuICAgKiDnlKjmiLfphY3nva7moLzlvI9cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0IGZvcm1hdHMoKTogeyBkYXRlOiB7IGRhdGVGb3JtYXQ6IHN0cmluZywgdGltZUZvcm1hdDogc3RyaW5nLCBkYXRlVGltZUZvcm1hdDogc3RyaW5nIH0sIG51bWJlcjogeyBuZWdhdGl2ZVNpZ246IHN0cmluZywgbnVtYmVyRGVjaW1hbERpZ2l0czogbnVtYmVyLCBudW1iZXJEZWNpbWFsU2VwYXJhdG9yOiBzdHJpbmcsIG51bWJlckdyb3VwU2VwYXJhdG9yOiBzdHJpbmcgfSwgW3Byb3A6IHN0cmluZ106IGFueSB9IHtcclxuICAgIGNvbnN0IHsgZGF0ZUZvcm1hdCA9IG51bGwsIHRpbWVGb3JtYXQgPSBudWxsIH0gPSB0aGlzLnVzZXJTZXR0aW5ncyB8fCB7fTtcclxuICAgIGxldCBkYXRlVGltZUZvcm1hdCA9IG51bGw7XHJcbiAgICBpZiAoZGF0ZUZvcm1hdCAmJiB0aW1lRm9ybWF0KSB7XHJcbiAgICAgIGRhdGVUaW1lRm9ybWF0ID0gYCR7ZGF0ZUZvcm1hdH0gJHt0aW1lRm9ybWF0fWA7XHJcbiAgICB9XHJcbiAgICBjb25zdCBkYXRlID0ge1xyXG4gICAgICBkYXRlRm9ybWF0LFxyXG4gICAgICB0aW1lRm9ybWF0LFxyXG4gICAgICBkYXRlVGltZUZvcm1hdFxyXG4gICAgfTtcclxuICAgIGNvbnN0IHsgbmVnYXRpdmVTaWduID0gbnVsbCwgbnVtYmVyRGVjaW1hbERpZ2l0cyA9IG51bGwsIG51bWJlckRlY2ltYWxTZXBhcmF0b3IgPSBudWxsLCBudW1iZXJHcm91cFNlcGFyYXRvciA9IG51bGwgfSA9IHRoaXMubnVtYmVyRm9ybWF0IHx8IHt9O1xyXG4gICAgY29uc3QgbnVtYmVyID0ge1xyXG4gICAgICBuZWdhdGl2ZVNpZ24sXHJcbiAgICAgIG51bWJlckRlY2ltYWxEaWdpdHMsXHJcbiAgICAgIG51bWJlckRlY2ltYWxTZXBhcmF0b3IsXHJcbiAgICAgIG51bWJlckdyb3VwU2VwYXJhdG9yXHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIHsgZGF0ZSwgbnVtYmVyIH07XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOagueaNruaVsOaNruexu+Wei+acrOWcsOWMluaVsOaNrlxyXG4gICAqIEBwYXJhbSB2YWx1ZSB2YWx1ZVxyXG4gICAqIEBwYXJhbSBkYXRhVHlwZSDmlbDmja7nsbvlnotcclxuICAgKiBAcmV0dXJucyBzdHJpbmdcclxuICAgKi9cclxuICBwdWJsaWMgbG9jYWxpemUodmFsdWU6IGFueSwgZGF0YVR5cGU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBpZiAoZGF0YVR5cGUgJiYgdmFsdWUpIHtcclxuICAgICAgZGF0YVR5cGUgPSBkYXRhVHlwZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICBpZiAoZGF0YVR5cGUgPT09ICdkYXRlJykge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnRyYW5zZm9ybURhdGUodmFsdWUpO1xyXG4gICAgICB9IGVsc2UgaWYgKGRhdGFUeXBlID09PSAnZGF0ZXRpbWUnKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtRGF0ZVRpbWUodmFsdWUpO1xyXG4gICAgICB9IGVsc2UgaWYgKGRhdGFUeXBlID09PSAnbnVtYmVyJykge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnRyYW5zZm9ybU51bWJlcih2YWx1ZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOagueaNruWbvemZheWMluexu+Wei+iOt+WPluagvOW8j+WMluWtl+espuS4slxyXG4gICAqIEBwYXJhbSBsb2NhbGl6YXRpb25UeXBlIOWbvemZheWMluexu+Wei1xyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRGb3JtYXQobG9jYWxpemF0aW9uVHlwZTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGlmIChsb2NhbGl6YXRpb25UeXBlKSB7XHJcbiAgICAgIGxvY2FsaXphdGlvblR5cGUgPSBsb2NhbGl6YXRpb25UeXBlLnRvTG93ZXJDYXNlKCk7XHJcbiAgICB9XHJcbiAgICBpZiAobG9jYWxpemF0aW9uVHlwZSA9PT0gJ2RhdGUnKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmZvcm1hdHMuZGF0ZS5kYXRlRm9ybWF0O1xyXG4gICAgfSBlbHNlIGlmIChsb2NhbGl6YXRpb25UeXBlID09PSAnZGF0ZXRpbWUnKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmZvcm1hdHMuZGF0ZS5kYXRlVGltZUZvcm1hdDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6L2s5o2i5pel5pyfXHJcbiAgICogQHBhcmFtIHZhbHVlIHZhbHVlXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB0cmFuc2Zvcm1EYXRlKHZhbHVlOiBhbnkpIHtcclxuICAgIGxldCBkYXRlRm9ybWF0ID0gdGhpcy51c2VyU2V0dGluZ3MgJiYgdGhpcy51c2VyU2V0dGluZ3MuZGF0ZUZvcm1hdCB8fCAnWVlZWS1NTS1ERCc7XHJcbiAgICBpZiAoIWRhdGVGb3JtYXQgfHwgIXZhbHVlKSB7XHJcbiAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuICAgIGNvbnN0IGRhdGUgPSBtb21lbnQodmFsdWUpO1xyXG4gICAgY29uc3QgaXNWYWxpZCA9IGRhdGUuaXNWYWxpZCgpO1xyXG4gICAgaWYgKCFpc1ZhbGlkKSB7XHJcbiAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuICAgIGRhdGVGb3JtYXQgPSB0aGlzLnBhcnNlRGF0ZUZvcm1hdChkYXRlRm9ybWF0KTtcclxuICAgIHJldHVybiBkYXRlLmZvcm1hdChkYXRlRm9ybWF0KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6L2s5o2i5pel5pyf5pe26Ze0XHJcbiAgICogQHBhcmFtIHZhbHVlIHZhbHVlXHJcbiAgICogdG9kbzog55uu5YmN5peg5rOV5a6a5LmJ5pel5pyf5pe26Ze05qC85byPXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB0cmFuc2Zvcm1EYXRlVGltZSh2YWx1ZTogYW55KSB7XHJcbiAgICBsZXQgZGF0ZUZvcm1hdCA9IHRoaXMudXNlclNldHRpbmdzICYmIHRoaXMudXNlclNldHRpbmdzLmRhdGVGb3JtYXQgfHwgJ1lZWVktTU0tREQnO1xyXG4gICAgbGV0IHRpbWVGb3JtYXQgPSB0aGlzLnVzZXJTZXR0aW5ncyAmJiB0aGlzLnVzZXJTZXR0aW5ncy50aW1lRm9ybWF0IHx8ICdISDptbTpzcyc7XHJcbiAgICBpZiAoIWRhdGVGb3JtYXQgfHwgIXRpbWVGb3JtYXQpIHtcclxuICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZGF0ZVRpbWUgPSBtb21lbnQodmFsdWUpO1xyXG4gICAgY29uc3QgaXNWYWxpZCA9IGRhdGVUaW1lLmlzVmFsaWQoKTtcclxuICAgIGlmICghaXNWYWxpZCkge1xyXG4gICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcbiAgICBpZiAoZGF0ZUZvcm1hdCkge1xyXG4gICAgICBkYXRlRm9ybWF0ID0gdGhpcy5wYXJzZURhdGVGb3JtYXQoZGF0ZUZvcm1hdCk7XHJcbiAgICB9XHJcbiAgICBpZiAodGltZUZvcm1hdCkge1xyXG4gICAgICB0aW1lRm9ybWF0ID0gdGhpcy5wYXJzZVRpbWVGb3JtYXQodGltZUZvcm1hdCk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBkYXRlVGltZUZvcm1hdCA9IGRhdGVGb3JtYXQgKyAnICcgKyB0aW1lRm9ybWF0O1xyXG4gICAgcmV0dXJuIGRhdGVUaW1lLmZvcm1hdChkYXRlVGltZUZvcm1hdCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOi9rOaNouaVsOWtl1xyXG4gICAqIEBwYXJhbSB2YWx1ZSB2YWx1ZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgdHJhbnNmb3JtTnVtYmVyKHZhbHVlKTogc3RyaW5nIHtcclxuICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSAnJykge1xyXG4gICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcbiAgICBjb25zdCBiaWdOdW1iZXIgPSBuZXcgQmlnTnVtYmVyKHZhbHVlKTtcclxuICAgIC8vIOWmguaenOS4jeaYr+aVsOWtl++8jOS4jeWBmuS7u+S9leWkhOeQhlxyXG4gICAgaWYgKCFCaWdOdW1iZXIuaXNCaWdOdW1iZXIoYmlnTnVtYmVyKSkge1xyXG4gICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcbiAgICBjb25zdCBpc05lZ2F0aXZlID0gYmlnTnVtYmVyLmlzTmVnYXRpdmUoKTtcclxuICAgIGNvbnN0IGZvcm1hdCA9IHRoaXMuYnVpbGROdW1iZXJGb3JtYXQoKTtcclxuICAgIGNvbnN0IHsgbmVnYXRpdmVTaWduID0gbnVsbCwgbnVtYmVyRGVjaW1hbERpZ2l0cyA9IG51bGwgfSA9IHRoaXMubnVtYmVyRm9ybWF0IHx8IHt9O1xyXG4gICAgaWYgKGlzTmVnYXRpdmUpIHtcclxuICAgICAgaWYgKG5lZ2F0aXZlU2lnbiAhPT0gbnVsbCkge1xyXG4gICAgICAgIGZvcm1hdC5wcmVmaXggPSBuZWdhdGl2ZVNpZ247XHJcbiAgICAgICAgcmV0dXJuIGJpZ051bWJlci5hYnNvbHV0ZVZhbHVlKCkudG9Gb3JtYXQobnVtYmVyRGVjaW1hbERpZ2l0cywgbnVsbCwgZm9ybWF0KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGJpZ051bWJlci50b0Zvcm1hdChudW1iZXJEZWNpbWFsRGlnaXRzLCBudWxsLCBmb3JtYXQpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDovazmjaLml6XmnJ/moLzlvI/op4TliJnkuLptb21lbnTnmoRmb3JtYXTop4TliJlcclxuICAgKiBAcGFyYW0gZm9ybWF0IGZvcm1hdFxyXG4gICAqL1xyXG4gIHByaXZhdGUgcGFyc2VEYXRlRm9ybWF0KGZvcm1hdDogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gZm9ybWF0LnJlcGxhY2UoL3kvZywgJ1knKS5yZXBsYWNlKC9kL2csICdEJyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOi9rOaNouaXtumXtOagvOW8j+inhOWImeS4um1vbWVudOeahGZvcm1hdOinhOWImVxyXG4gICAqIEBwYXJhbSBmb3JtYXQgZm9ybWF0XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBwYXJzZVRpbWVGb3JtYXQoZm9ybWF0OiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBmb3JtYXQucmVwbGFjZSgvTS9nLCAnbScpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmnoTpgKBiaWdudW1iZXLmlbDlrZfmoLzlvI/ljJbpgInpoblcclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkTnVtYmVyRm9ybWF0KCkge1xyXG4gICAgaWYgKHRoaXMubnVtYmVyRm9ybWF0KSB7XHJcbiAgICAgIGNvbnN0IHsgbnVtYmVyRGVjaW1hbFNlcGFyYXRvciA9IG51bGwsIG51bWJlckdyb3VwU2VwYXJhdG9yID0gbnVsbCB9ID0gdGhpcy5udW1iZXJGb3JtYXQ7XHJcbiAgICAgIGNvbnN0IGZvcm1hdDogYW55ID0ge1xyXG4gICAgICAgIGdyb3VwU2l6ZTogMyxcclxuICAgICAgfTtcclxuICAgICAgaWYgKG51bWJlckRlY2ltYWxTZXBhcmF0b3IgIT09IG51bGwpIHtcclxuICAgICAgICBmb3JtYXQuZGVjaW1hbFNlcGFyYXRvciA9IG51bWJlckRlY2ltYWxTZXBhcmF0b3I7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKG51bWJlckdyb3VwU2VwYXJhdG9yICE9PSBudWxsKSB7XHJcbiAgICAgICAgZm9ybWF0Lmdyb3VwU2VwYXJhdG9yID0gbnVtYmVyR3JvdXBTZXBhcmF0b3I7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGZvcm1hdDtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBnZXQgbnVtYmVyRm9ybWF0KCk6IE51bWJlckZvcm1hdCB7XHJcbiAgICByZXR1cm4gdGhpcy51c2VyU2V0dGluZ3MgJiYgdGhpcy51c2VyU2V0dGluZ3MubnVtYmVyRm9ybWF0IHx8IG51bGw7XHJcbiAgfVxyXG59Il19