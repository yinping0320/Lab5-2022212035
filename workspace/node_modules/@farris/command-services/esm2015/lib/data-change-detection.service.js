import { BefRepositoryUtil } from "@farris/bef";
import { of } from "rxjs";
import { map } from "rxjs/operators";
export class DataChangeDetectionService {
    static hasChange(frameContext) {
        const befRepository = frameContext && frameContext.repository;
        const hasLocalChanges = BefRepositoryUtil.isExistUnsaveData(befRepository);
        if (hasLocalChanges) {
            return of(true);
        }
        // 本地没有变更，确认服务器端是否有未保存的变更
        const virtualRootFrameContext = frameContext && frameContext.getVirtualRootFrameContext();
        const serverSideChangeDetectionEnabled = virtualRootFrameContext && virtualRootFrameContext.enableServerSideChangeDetection;
        if (!serverSideChangeDetectionEnabled) {
            return of(false);
        }
        else {
            // 启用了后端变更检测
            return frameContext.repository.hasChanges().pipe(map((response) => {
                return response.returnValue;
            }));
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1jaGFuZ2UtZGV0ZWN0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZGF0YS1jaGFuZ2UtZGV0ZWN0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFpQixpQkFBaUIsRUFBZ0IsTUFBTSxhQUFhLENBQUM7QUFFN0UsT0FBTyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0QyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFckMsTUFBTSxPQUFPLDBCQUEwQjtJQUM1QixNQUFNLENBQUMsU0FBUyxDQUFDLFlBQTBCO1FBQzlDLE1BQU0sYUFBYSxHQUFHLFlBQVksSUFBSSxZQUFZLENBQUMsVUFBZ0MsQ0FBQztRQUNwRixNQUFNLGVBQWUsR0FBRyxpQkFBaUIsQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUMzRSxJQUFJLGVBQWUsRUFBRTtZQUNqQixPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNuQjtRQUNELHlCQUF5QjtRQUN6QixNQUFNLHVCQUF1QixHQUFHLFlBQVksSUFBSSxZQUFZLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztRQUMxRixNQUFNLGdDQUFnQyxHQUFHLHVCQUF1QixJQUFJLHVCQUF1QixDQUFDLCtCQUErQixDQUFDO1FBQzVILElBQUksQ0FBQyxnQ0FBZ0MsRUFBRTtZQUNuQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNwQjthQUFNO1lBQ0gsWUFBWTtZQUNaLE9BQU8sWUFBWSxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBc0IsRUFBRSxFQUFFO2dCQUM1RSxPQUFPLFFBQVEsQ0FBQyxXQUFXLENBQUM7WUFDaEMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNQO0lBQ0wsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSwgQmVmUmVwb3NpdG9yeVV0aWwsIFJlc3BvbnNlSW5mbyB9IGZyb20gXCJAZmFycmlzL2JlZlwiO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQgfSBmcm9tIFwiQGZhcnJpcy9kZXZraXRcIjtcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tIFwicnhqc1wiO1xyXG5pbXBvcnQgeyBtYXAgfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBEYXRhQ2hhbmdlRGV0ZWN0aW9uU2VydmljZSB7XHJcbiAgICBwdWJsaWMgc3RhdGljIGhhc0NoYW5nZShmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxhbnk+O1xyXG4gICAgICAgIGNvbnN0IGhhc0xvY2FsQ2hhbmdlcyA9IEJlZlJlcG9zaXRvcnlVdGlsLmlzRXhpc3RVbnNhdmVEYXRhKGJlZlJlcG9zaXRvcnkpO1xyXG4gICAgICAgIGlmIChoYXNMb2NhbENoYW5nZXMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDmnKzlnLDmsqHmnInlj5jmm7TvvIznoa7orqTmnI3liqHlmajnq6/mmK/lkKbmnInmnKrkv53lrZjnmoTlj5jmm7RcclxuICAgICAgICBjb25zdCB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKTtcclxuICAgICAgICBjb25zdCBzZXJ2ZXJTaWRlQ2hhbmdlRGV0ZWN0aW9uRW5hYmxlZCA9IHZpcnR1YWxSb290RnJhbWVDb250ZXh0ICYmIHZpcnR1YWxSb290RnJhbWVDb250ZXh0LmVuYWJsZVNlcnZlclNpZGVDaGFuZ2VEZXRlY3Rpb247XHJcbiAgICAgICAgaWYgKCFzZXJ2ZXJTaWRlQ2hhbmdlRGV0ZWN0aW9uRW5hYmxlZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIOWQr+eUqOS6huWQjuerr+WPmOabtOajgOa1i1xyXG4gICAgICAgICAgICByZXR1cm4gZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuaGFzQ2hhbmdlcygpLnBpcGUobWFwKChyZXNwb25zZTogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UucmV0dXJuVmFsdWU7XHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0iXX0=