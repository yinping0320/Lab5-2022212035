/*
 * @Author: aalizzwell
 * @Date: 2019-08-02 15:31:34
 * @Last Modified by: aalizzwell
 * @Last Modified time: 2020-03-03 09:33:43
 */
import { Injectable, Optional, Injector, ComponentFactoryResolver, ReflectiveInjector } from '@angular/core';
import { Router, ActivatedRoute } from '@angular/router';
import { RuntimeFrameworkService } from './rtf-service';
import { AppType } from '@gsp-sys/rtf-common';
import { MenuStateService } from './menu-state.service';
import { NavigationEventService } from './navigation-event.service';
import { QuerystringService } from './querystring';
import { FrameContext, TranslateToken } from '@farris/devkit';
import { FEPageModalService } from '@farris/extend-page-modal';
import lodash from 'lodash-es';
import { FarrisFormService } from './farris-form.service';
import { LanguageService } from './languag.service';
import { map, switchMap } from 'rxjs/operators';
import { EMPTY, of } from 'rxjs';
import { FormNotifyService } from './form-notify.service';
import { INSIDE_DIALOG_TOKEN, MODAL_REF } from './types';
// tslint:disable: no-string-literal max-line-length
const APP_CONTEXT_MANAGER = 'DEVKIT_APP_CONTEXT_MANAGER';
/**
 * 导航服务
 * @scope FormModule
 */
export class NavigationService {
    constructor(runtimeFrameworkService, menuStateService, navigationEventService, querystringService, frameContext, injector, languageService
    // @Optional() private pageModalService: FEPageModalService,
    // @Optional() private farrisFormService: FarrisFormService,
    // @Optional() private languageService: LanguageService
    ) {
        this.runtimeFrameworkService = runtimeFrameworkService;
        this.menuStateService = menuStateService;
        this.navigationEventService = navigationEventService;
        this.querystringService = querystringService;
        this.frameContext = frameContext;
        this.injector = injector;
        this.languageService = languageService;
        // appId不同于tabId，每次表单实例化时都会重新生成
        const appId = this.formAppContext && this.formAppContext.ApplicationId;
        let tabId = this.querystrings.tabId || this.querystrings.funcId || this.querystrings.appId;
        // 已经编译的表单，使用appId记录hash
        if (appId) {
            const appContextManager = window[APP_CONTEXT_MANAGER] || new Map();
            if (appContextManager && !appContextManager.has(appId)) {
                appContextManager.set(appId, { hash: window.location.hash });
                window[APP_CONTEXT_MANAGER] = appContextManager;
            }
        }
        if (tabId) {
            const formEventServices = window['formEventServices'] || new Map();
            // tabId、appId都存在时，使用appId替换tabId
            if (appId) {
                tabId = appId;
            }
            if (formEventServices && formEventServices.has(tabId)) {
                this.navigationEventService = formEventServices.get(tabId);
            }
            else {
                this.navigationEventService.registerEvent();
                formEventServices.set(tabId, this.navigationEventService);
                this.navigationEventService.frameContext = this.frameContext;
                window['formEventServices'] = formEventServices;
                this.registerDestroyEvent(tabId);
            }
        }
        if (!languageService) {
            this.languageService = new LanguageService();
        }
    }
    set context(context) {
        this.navigationEventService['context'] = context;
        this['commandContext'] = context;
    }
    /**
     * 获取整个表单的appcontext（除module上的appcontext）
     */
    get formAppContext() {
        if (this.frameContext) {
            let appContext = this.frameContext.appContext;
            // tslint:disable-next-line: max-line-length
            while (appContext && appContext.parent && appContext.parent.injector && appContext.parent.injector.get(FrameContext, null) !== null) {
                appContext = appContext.parent;
            }
            return appContext;
        }
        return null;
    }
    get querystrings() {
        let hash = window.location.hash;
        const appId = this.formAppContext && this.formAppContext.ApplicationId;
        if (appId) {
            const appContextManager = window[APP_CONTEXT_MANAGER];
            const appContext = appContextManager && appContextManager.get(appId);
            hash = appContext && appContext.hash || hash;
        }
        const params = this.querystringService.parse(hash);
        if (params) {
            params.formToken = this.runtimeFrameworkService.formToken;
        }
        return params;
    }
    /**
     * 提示服务
     */
    get formNotifyService() {
        return this.injector && this.injector.get(FormNotifyService, null);
    }
    /**
     * 注册销毁事件
     * @param tabId
     */
    registerDestroyEvent(tabId) {
        if (this.frameContext && this.frameContext.destorySignal) {
            this.frameContext.destorySignal.subscribe(() => {
                this.navigationEventService = null;
            });
        }
        if (this.frameContext && this.frameContext.appContext && this.frameContext.appContext.destorySignal) {
            this.frameContext.appContext.destorySignal.subscribe(() => {
                const formEventServices = window['formEventServices'];
                if (formEventServices) {
                    formEventServices.delete(tabId);
                }
                const appContextManager = window[APP_CONTEXT_MANAGER];
                if (appContextManager) {
                    appContextManager.delete(tabId);
                }
            });
        }
    }
    // #region 接口
    /**
     * 打开菜单
     * @param tabId 根据TabId决定打开新标签页或定位之前打开的标签页
     * @param funcId 菜单Id
     * @param params 参数
     * @param reload 是否重新刷新
     * @param enableRefresh 启用数据刷新
     * @param tabName tab标题
     * @param destructuring 是否解构参数
     */
    openMenu(tabId, funcId, params, reload, enableRefresh, tabName, destructuring) {
        if (!funcId && this.formNotifyService) {
            this.formNotifyService.warning(this.languageService.appOrFuncIdRequired, { hideTitle: true });
            return EMPTY;
        }
        if (tabName) {
            tabName = this.translate(tabName);
        }
        let queryStringParams = this.buildParamMap(params);
        destructuring = this.convertToBoolean(destructuring, false);
        if (destructuring === true) {
            queryStringParams = this.buildParam(params);
        }
        // const paramsMap = this.buildParamMap(params);
        const currentTabId = this.querystrings.tabId || this.querystrings.funcId || this.querystrings.appId;
        const options = {
            tabId,
            funcId,
            appType: AppType.Menu,
            queryStringParams: queryStringParams,
            entityParams: queryStringParams,
            appId: undefined,
            appEntrance: undefined,
            isReload: reload,
            tabName: tabName || null
        };
        // 启用数据刷新参数为true或者没有定义，则按刷新处理
        // 没有传递该参数或该参数为空，则认为按照之前的逻辑处理，默认刷新
        // null false "false" "true" undefined
        enableRefresh = this.convertToBoolean(enableRefresh, true);
        if (enableRefresh === true) {
            const frameworkTabId = tabId ? `${funcId}_${tabId}` : funcId;
            this.menuStateService.addMenuState(currentTabId, frameworkTabId);
        }
        this.runtimeFrameworkService.openMenu(options);
    }
    /**
     * 打开菜单（流）
     * @param tabId 根据TabId决定打开新标签页或定位之前打开的标签页
     * @param funcId 菜单Id
     * @param params 参数
     * @param reload 是否重新刷新
     * @param enableRefresh 启用数据刷新
     * @param destructuring 解构参数
     */
    openMenu$(tabId, funcId, params, reload, enableRefresh, tabName, destructuring) {
        if (!funcId && this.formNotifyService) {
            this.formNotifyService.warning(this.languageService.appOrFuncIdRequired, { hideTitle: true });
            return EMPTY;
        }
        if (tabName) {
            tabName = this.translate(tabName);
        }
        let queryStringParams = this.buildParamMap(params);
        destructuring = this.convertToBoolean(destructuring, false);
        if (destructuring === true) {
            queryStringParams = this.buildParam(params);
        }
        // const paramsMap = this.buildParamMap(params);
        const currentTabId = this.querystrings.tabId || this.querystrings.funcId || this.querystrings.appId;
        const options = {
            tabId,
            funcId,
            appType: AppType.Menu,
            queryStringParams: queryStringParams,
            entityParams: queryStringParams,
            appId: undefined,
            appEntrance: undefined,
            isReload: reload,
            tabName: tabName || null
        };
        // 启用数据刷新参数为true或者没有定义，则按刷新处理
        enableRefresh = this.convertToBoolean(enableRefresh, true);
        if (enableRefresh === true) {
            const frameworkTabId = tabId ? `${funcId}_${tabId}` : funcId;
            this.menuStateService.addMenuState(currentTabId, frameworkTabId);
        }
        return this.runtimeFrameworkService.openMenu$(options);
    }
    /**
     * 打开菜单(带维度)
     * @param tabId 根据TabId决定打开新标签页或定位之前打开的标签页
     * @param funcId 菜单Id
     * @param params 参数
     * @param reload 是否重新刷新
     * @param enableRefresh 启用数据刷新
     * @param dim1 dim1
     * @param dim2 dim2
     * @param destructuring 解构参数
     */
    openMenuWithDimension(tabId, funcId, params, enableRefresh, dim1, dim2, tabName, metadataId, destructuring) {
        if (!funcId && this.formNotifyService) {
            this.formNotifyService.warning(this.languageService.appOrFuncIdRequired, { hideTitle: true });
            return EMPTY;
        }
        if (tabName) {
            tabName = this.translate(tabName);
        }
        if (metadataId === undefined || metadataId === null) {
            metadataId = '';
        }
        let queryStringParams = this.buildParamMap(params);
        destructuring = this.convertToBoolean(destructuring, false);
        if (destructuring === true) {
            queryStringParams = this.buildParam(params);
        }
        // const paramsMap = this.buildParamMap(params);
        queryStringParams.set('dim1', dim1 ? dim1 : 'public');
        queryStringParams.set('dim2', dim2 ? dim2 : 'public');
        queryStringParams.set('metadataId', metadataId);
        queryStringParams.set('isRtc', '1');
        queryStringParams.set('isRootMetadata', 'true');
        const currentTabId = this.querystrings.tabId || this.querystrings.funcId || this.querystrings.appId;
        const options = {
            tabId,
            funcId,
            appType: AppType.Menu,
            queryStringParams: queryStringParams,
            entityParams: queryStringParams,
            appId: undefined,
            appEntrance: undefined,
            isReload: false,
            tabName: tabName || null
        };
        // 启用数据刷新参数为true或者没有定义，则按刷新处理
        // 没有传递该参数或该参数为空，则认为按照之前的逻辑处理，默认刷新
        // null false "false" "true" undefined
        enableRefresh = this.convertToBoolean(enableRefresh, true);
        if (enableRefresh === true) {
            const frameworkTabId = tabId ? `${funcId}_${tabId}` : funcId;
            this.menuStateService.addMenuState(currentTabId, frameworkTabId);
        }
        this.runtimeFrameworkService.openMenu(options);
    }
    /**
     * 打开应用
     * @param tabId tabId 根据TabId决定打开新标签页或定位之前打开的标签页
     * @param appId 应用Id
     * @param appEntrance 应用入口
     * @param params 参数
     * @param reload 是否重新刷新
     * @param tabName tab标题
     * @param enableRefresh 启用数据刷新
     * @param destructuring 解构参数
     */
    openApp(tabId, appId, appEntrance, params, reload, tabName, enableRefresh, destructuring) {
        if (!appId && this.formNotifyService) {
            this.formNotifyService.warning(this.languageService.appOrFuncIdRequired, { hideTitle: true });
            return EMPTY;
        }
        if (tabName) {
            tabName = this.translate(tabName);
        }
        let queryStringParams = this.buildParamMap(params);
        destructuring = this.convertToBoolean(destructuring, false);
        if (destructuring === true) {
            queryStringParams = this.buildParam(params);
        }
        // const paramsMap = this.buildParamMap(params);
        const currentTabId = this.querystrings.tabId || this.querystrings.funcId || this.querystrings.appId;
        const options = {
            tabId,
            appId,
            appEntrance,
            funcId: undefined,
            appType: AppType.App,
            queryStringParams: queryStringParams,
            entityParams: queryStringParams,
            isReload: reload,
            tabName: tabName || null
        };
        enableRefresh = this.convertToBoolean(enableRefresh, true);
        if (enableRefresh === true) {
            const frameworkTabId = tabId ? `${appId}_${appEntrance}_${tabId}` : `${appId}_${appEntrance}`;
            this.menuStateService.addMenuState(currentTabId, frameworkTabId);
        }
        this.runtimeFrameworkService.openMenu(options);
    }
    /**
     * 打开应用(流式)
     * @param tabId tabId 根据TabId决定打开新标签页或定位之前打开的标签页
     * @param appId 应用Id
     * @param appEntrance 应用入口
     * @param params 参数
     * @param reload 是否重新刷新
     * @param tabName tab标题
     * @param enableRefresh 启用数据刷新
     * @param destructuring 解构参数
     */
    openApp$(tabId, appId, appEntrance, params, reload, tabName, enableRefresh, destructuring) {
        if (!appId && this.formNotifyService) {
            this.formNotifyService.warning(this.languageService.appOrFuncIdRequired, { hideTitle: true });
            return EMPTY;
        }
        if (tabName) {
            tabName = this.translate(tabName);
        }
        let queryStringParams = this.buildParamMap(params);
        destructuring = this.convertToBoolean(destructuring, false);
        if (destructuring === true) {
            queryStringParams = this.buildParam(params);
        }
        // const paramsMap = this.buildParamMap(params);
        const currentTabId = this.querystrings.tabId || this.querystrings.funcId || this.querystrings.appId;
        const options = {
            tabId,
            appId,
            appEntrance,
            funcId: undefined,
            appType: AppType.App,
            queryStringParams: queryStringParams,
            entityParams: queryStringParams,
            isReload: reload,
            tabName: tabName || null
        };
        enableRefresh = this.convertToBoolean(enableRefresh, true);
        if (enableRefresh === true) {
            const frameworkTabId = tabId ? `${appId}_${appEntrance}_${tabId}` : `${appId}_${appEntrance}`;
            this.menuStateService.addMenuState(currentTabId, frameworkTabId);
        }
        return this.runtimeFrameworkService.openMenu$(options);
    }
    /**
     * 关闭
     * @param onCloseing 关闭前事件处理器
     */
    close() {
        const options = this.querystrings;
        const { isDialogComponent: isInDialog, rootComponent } = this.findDialog();
        if (isInDialog) {
            const modalRefFactory = this.get(rootComponent, 'dialogRef');
            let modalRef = null;
            if (typeof modalRefFactory === 'function') {
                const refs = modalRefFactory();
                modalRef = refs && refs.modalRef;
            }
            else {
                modalRef = modalRefFactory;
            }
            modalRef && modalRef['close']();
            return;
        }
        options.token = options.formToken;
        this.runtimeFrameworkService.beforeCloseMenu(options);
    }
    /**
     * 强制关闭
     */
    destory() {
        const options = this.querystrings;
        options.token = options.formToken;
        this.runtimeFrameworkService.closeMenu(options);
    }
    /**
     *
     * @param params params
     * @deprecated 待废弃，与buildParamMap重复
     */
    parseParams(params) {
        if (typeof params === 'undefined' || params === null || (typeof params === 'string' && params.length < 1)) {
            params = {};
        }
        const paramMap = new Map();
        if (typeof params === 'object') {
            params = JSON.stringify(params);
        }
        params = window['encodeURIComponent'](params);
        paramMap.set('WEB_FORM_ROUTE_PARAMS', params);
        return paramMap;
    }
    /**
     * 注册事件监听器
     * @param eventType 事件类型 onTabClosed
     * @param handler 处理器
     * @returns string 返回事件标识
     */
    addEventListener(eventType, handler) {
        return this.navigationEventService.addEventListener(eventType, handler);
    }
    /**
     * 移除事件监听器
     * @param eventType 事件类型 onTabClosed | onTabCloseing
     * @param key 事件标识
     */
    removeEventListener(eventType, key) {
        return this.navigationEventService.removeEventListener(eventType, key);
    }
    /**
     * 清空事件监听器
     * @param eventType 事件类型
     */
    clearEventListener(eventType) {
        this.navigationEventService.clearEventListener(eventType);
    }
    /**
     * 以弹框、侧边栏或新标签页方式打开表单
     * @param mode 打开方式，支持`modal`弹窗、`sidebar`侧边栏、`tab`新标签页
     * @param modalId 弹窗id，如果mode=`modal`且没有url，
     * @param configs 弹窗配置
     * @param url 远端表单url
     * @param tabId 标签页id，modal=tab时必填
     * @param tabType 标签页类型，`menu` 或`app`
     * @param funcOrAppId 菜单或应用id
     * @param appEntrance 应用入口
     * @param params 参数
     * @param tabName 新标签页名称
     * @param enableRefresh 启用启动刷新
     * @param destructuring 是否解构
     */
    open(mode, modalId, url, configs, tabId, tabType, funcOrAppId, appEntrance, params, tabName, enableRefresh, destructuring) {
        const pageModalService = this.injector.get(FEPageModalService, null);
        if (!pageModalService) {
            throw new Error('get FEPageModalService failed.');
        }
        // 校验参数是否合法
        if (!mode) {
            throw new Error('[NavigationService]->open,mode参数不能为空！');
        }
        if (mode === 'modal' || mode === 'sidebar') {
            if (!modalId && !url) {
                throw new Error('弹窗及侧边栏模式时弹窗容器id和表单路径不能同时为空！');
            }
            if (modalId && url) {
                throw new Error('弹窗及侧边栏模式时弹窗容器id和表单路径不能同时存在！');
            }
            const uiStateConfig = this.getObjectTypeConfig(params);
            const modalConfig = this.buildConfigs(configs);
            if (mode === 'sidebar') {
                modalConfig.dialogType = mode;
            }
            let pageModalRef = null;
            if (modalId) {
                const farrisFormService = this.injector.get(FarrisFormService, null);
                if (!farrisFormService) {
                    return;
                }
                const componentType = farrisFormService.getControls(modalId);
                const componentRef = this.createComponentRef(componentType, uiStateConfig);
                pageModalRef = pageModalService.show(componentRef, modalConfig);
            }
            else if (url) {
                pageModalRef = pageModalService.showByUrl(url, modalConfig);
            }
            if (pageModalRef && !!pageModalRef.content) {
                pageModalRef.content.isDialogRootComponent = true;
                pageModalRef.content.dialogRef = pageModalRef;
                const header = pageModalRef.dialog && pageModalRef.dialog.instance && pageModalRef.dialog.instance.el && pageModalRef.dialog.instance.el.nativeElement && pageModalRef.dialog.instance.el.nativeElement.querySelector(".f-page-header");
                if (header && pageModalRef.dialog.instance.draggbar) {
                    pageModalRef.dialog.instance.draggbar.handle = header;
                    header.style.cursor = 'move';
                }
            }
        }
        else if (mode === 'tab') {
            if (!tabId || !tabType || !funcOrAppId) {
                if (this.formNotifyService) {
                    this.formNotifyService.warning(this.languageService.appOrFuncIdRequired, { hideTitle: true });
                }
                throw new Error('新标签模式时标签页id、标签类型、菜单或应用id均不能为空！');
            }
            if (tabType === 'app' && !appEntrance) {
                throw new Error('以应用方式打开时入口应用不能为空！');
            }
            if (tabType == 'app') {
                this.openApp(tabId, funcOrAppId, appEntrance, params, false, tabName, enableRefresh, destructuring);
            }
            else if (tabType === 'menu') {
                this.openMenu(tabId, funcOrAppId, params, false, enableRefresh, tabName, destructuring);
            }
        }
        else {
            throw new Error('不支持的模式！');
        }
        // this.pageModalService.
    }
    /**
     * in app navigate
     * @param commands commands
     */
    // public navigate(commands: any[]);
    /**
     * in app navigate
     * @param commands commands
     * @param options options
     * @description options:{ relativeTo: this.activatedRoute, queryParams:{a:1,b:2},etc:...}
     */
    navigate(commands, options) {
        const router = this.injector && this.injector.get(Router, null);
        const activatedRoute = this.injector && this.injector.get(ActivatedRoute, null);
        const queryParams = lodash.merge({}, this.querystrings, options && options.queryParams || {});
        if (options && options.hasOwnProperty('queryParams')) {
            delete options.queryParams;
        }
        const extras = lodash.merge({ skipLocationChange: false, relativeTo: activatedRoute, queryParams }, options || {});
        if (router) {
            return router.navigate(commands, extras);
        }
        else {
            return null;
        }
    }
    // #endregion
    // #region 私有方法
    /**
     * 封装路由参数
     * @param params 参数
     * @param options 配置参数
     */
    buildParamMap(params, options) {
        if (typeof params === 'undefined' || params === null || (typeof params === 'string' && params.length < 1)) {
            params = {};
        }
        const paramMap = new Map();
        if (options && Object.keys(options).length > 0) {
            if (typeof params !== 'object') {
                params = JSON.parse(params);
            }
            params = lodash.merge(params, options);
        }
        if (typeof params === 'object') {
            params = JSON.stringify(params);
        }
        const currentTabId = this.querystrings.tabId || this.querystrings.funcId || this.querystrings.appId;
        params = window['encodeURIComponent'](params);
        paramMap.set('WEB_FORM_ROUTE_PARAMS', params);
        paramMap.set('WEB_FORM_ROUTER_PARENT_ID', currentTabId);
        return paramMap;
    }
    buildParam(params, options) {
        if (typeof params === 'undefined' || params === null || (typeof params === 'string' && params.length < 1)) {
            params = {};
        }
        const paramMap = new Map();
        if (options && Object.keys(options).length > 0) {
            if (typeof params !== 'object') {
                params = JSON.parse(params);
            }
            params = lodash.merge(params, options);
        }
        if (typeof params !== 'object') {
            params = JSON.parse(params);
        }
        Object.keys(params).forEach(key => {
            paramMap.set(key, params[key]);
        });
        const currentTabId = this.querystrings.tabId || this.querystrings.funcId || this.querystrings.appId;
        params = window['encodeURIComponent'](JSON.stringify(params));
        paramMap.set('WEB_FORM_ROUTE_PARAMS', params);
        paramMap.set('WEB_FORM_ROUTER_PARENT_ID', currentTabId);
        return paramMap;
    }
    /**
     * 查找弹窗组件
     */
    findDialog() {
        let frameContext = this.get(this, 'commandContext.frameContext');
        let isDialogComponent = this.get(frameContext, 'frameComponent.isDialogRootComponent', false);
        let rootComponent = null;
        let parentFrameContext = this.get(frameContext, 'parent');
        while (parentFrameContext != null && !isDialogComponent) {
            frameContext = this.get(frameContext, 'parent');
            parentFrameContext = this.get(parentFrameContext, 'parent');
            isDialogComponent = this.get(frameContext, 'frameComponent.isDialogRootComponent', false);
        }
        rootComponent = this.get(frameContext, 'frameComponent');
        if (!isDialogComponent) {
            isDialogComponent = this.frameContext.injector.get(INSIDE_DIALOG_TOKEN, false);
            if (isDialogComponent) {
                const modalRef = this.frameContext.injector.get(MODAL_REF, null);
                rootComponent = { dialogRef: modalRef };
            }
        }
        return { isDialogComponent, rootComponent };
    }
    /**
     * loadsh get
     * @param object 对象
     * @param path 路径
     * @param defaultVal 默认值
     */
    get(object, path, defaultVal = null) {
        const PATH = Array.isArray(path)
            ? path
            : path.split('.').filter(i => i.length);
        if (!PATH.length) {
            return object === undefined ? defaultVal : object;
        }
        if (object === null || object === undefined || typeof (object[PATH[0]]) === 'undefined') {
            return defaultVal;
        }
        return this.get(object[PATH.shift()], PATH, defaultVal);
    }
    convertToBoolean(value, defaultVal = false) {
        if (typeof value === 'undefined' || value === null) {
            value = defaultVal;
        }
        if (typeof value === 'string') {
            value = value || String(defaultVal);
            value = value === 'true' ? true : false;
        }
        return value;
    }
    /**
     * 翻译资源项
     * @param key 资源项key
     */
    translate(key) {
        const translateService = this.injector && this.injector.get(TranslateToken, null) || null;
        if (translateService && key && key.startsWith('{{') && key.endsWith('}}')) {
            key = key.replace('{{', '').replace('}}', '').trim();
            return translateService.transform(key, null);
        }
        return key;
    }
    // #endregion
    //#region 弹窗相关方法
    buildConfigs(config) {
        let languageService = this.injector.get(LanguageService, null);
        if (!languageService) {
            languageService = LanguageService.getInstance();
        }
        const defaultConfigs = {
            title: languageService && languageService.defaultDialogTitle || '',
            width: 800,
            height: 500,
            showButtons: false
        };
        const objectTypeConfig = this.getObjectTypeConfig(config);
        const configs = Object.assign(defaultConfigs, objectTypeConfig);
        const onClosingHandler = configs.beforeClose;
        const refresh = configs['refresh'] || {};
        const refreshCommandName = refresh && refresh.commandName || null;
        const refreshFrameId = refresh && refresh.frameId || null;
        // tslint:disable: no-string-literal
        const cancelChanges = configs['cancelChanges'] || false;
        configs.beforeClose = (ref) => {
            if (!!onClosingHandler && typeof onClosingHandler === 'function') {
                return onClosingHandler(ref).pipe(switchMap(result => {
                    if (result) {
                        if (cancelChanges) {
                            return this.cancelChanges(ref).pipe(switchMap(() => this.refreshForm(refreshCommandName, refreshFrameId)));
                        }
                    }
                    return of(result);
                }));
            }
            else {
                if (cancelChanges) {
                    return this.cancelChanges(ref).pipe(switchMap(() => this.refreshForm(refreshCommandName, refreshFrameId)));
                }
                else {
                    return of(true);
                }
            }
        };
        return configs;
    }
    getObjectTypeConfig(config) {
        let objectTypeConfig;
        if (typeof config === 'undefined') {
            config = {};
        }
        if (typeof config === 'string') {
            if (config.length) {
                try {
                    objectTypeConfig = JSON.parse(config);
                }
                catch (_a) {
                    throw new Error(config + '不是合法的json字符串');
                }
            }
            else {
                objectTypeConfig = {};
            }
        }
        else if (typeof config === 'object') {
            objectTypeConfig = Object.assign({}, config);
        }
        else {
            throw new Error('填写对象格式或json字符串');
        }
        return objectTypeConfig;
    }
    /**
     * 取消服务器变更集
     */
    cancelChanges(ref) {
        if (ref && ref.modalRef && ref.modalRef.content) {
            const component = ref.modalRef.content;
            if (component && component.context) {
                const repository = component.context.repository || null;
                if (repository) {
                    return repository.cancelChanges().pipe(switchMap(() => of(true)));
                }
            }
        }
        return of(true);
    }
    refreshForm(refreshCommandName, refreshFrameId) {
        if (refreshCommandName && refreshFrameId) {
            const frameContext = this.frameContext.appContext.frameContextManager.getFrameContextById(refreshFrameId);
            if (frameContext) {
                const viewModel = frameContext.viewModel;
                return viewModel[refreshCommandName]().pipe(map(() => true));
            }
        }
        return of(true);
    }
    createComponentRef(componentType, uiStateObject) {
        let componentRef;
        const frameContext = this.getFrameContext();
        const componentFactoryResolver = this.getComponentFactoryResolver();
        if (frameContext && componentFactoryResolver) {
            const contentCmptFactory = componentFactoryResolver.resolveComponentFactory(componentType);
            const modalContentInjector = ReflectiveInjector.resolveAndCreate([], frameContext.injector);
            componentRef = contentCmptFactory.create(modalContentInjector);
            if (componentRef && componentRef.instance && componentRef.instance.viewModel && componentRef.instance.viewModel.uiState) {
                if (typeof uiStateObject === 'object' && Object.keys(uiStateObject).length) {
                    Object.keys(uiStateObject).forEach(item => {
                        componentRef.instance.viewModel.uiState.setPropertyValue(item, uiStateObject[item]);
                    });
                }
                // 附加isDialog参数
                componentRef.instance.viewModel.uiState.setPropertyValue('DEVKIT_DIALOG', true);
            }
        }
        return componentRef;
    }
    /**
     * 兼容旧弹窗，获取frameContext
     */
    getFrameContext() {
        if (this.frameContext) {
            return this.frameContext;
        }
        if (this['context'] && this['context']['frameContext']) {
            return this['context']['frameContext'];
        }
        return null;
    }
    /**
     * 兼容旧弹窗，获取ComponentFactoryResolver
     */
    getComponentFactoryResolver() {
        const frameContext = this.getFrameContext();
        let componentFactoryResolver;
        if (frameContext) {
            componentFactoryResolver = frameContext.injector.get(ComponentFactoryResolver);
        }
        return componentFactoryResolver;
    }
}
NavigationService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
NavigationService.ctorParameters = () => [
    { type: RuntimeFrameworkService },
    { type: MenuStateService },
    { type: NavigationEventService },
    { type: QuerystringService },
    { type: FrameContext, decorators: [{ type: Optional }] },
    { type: Injector, decorators: [{ type: Optional }] },
    { type: LanguageService, decorators: [{ type: Optional }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL25hdmlnYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7R0FLRztBQUNILE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSx3QkFBd0IsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RyxPQUFPLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RCxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDeEQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDcEUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxZQUFZLEVBQUUsY0FBYyxFQUE2QixNQUFNLGdCQUFnQixDQUFDO0FBQ3pGLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQy9ELE9BQU8sTUFBTSxNQUFNLFdBQVcsQ0FBQztBQUMvQixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsS0FBSyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM3QyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFP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LENBQUMsZUFBZSxFQUFFLENBQUM7UUFDNUMsSUFBSSx3QkFBNkIsQ0FBQztRQUNsQyxJQUFJLFlBQVksRUFBRTtZQUNoQix3QkFBd0IsR0FBRyxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1NBQ2hGO1FBQ0QsT0FBTyx3QkFBd0IsQ0FBQztJQUNsQyxDQUFDOzs7WUF6d0JGLFVBQVU7Ozs7WUF0QkYsdUJBQXVCO1lBRXZCLGdCQUFnQjtZQUNoQixzQkFBc0I7WUFDdEIsa0JBQWtCO1lBQ2xCLFlBQVksdUJBeUJoQixRQUFRO1lBaENrQixRQUFRLHVCQWlDbEMsUUFBUTtZQXRCSixlQUFlLHVCQXVCbkIsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIEBBdXRob3I6IGFhbGl6endlbGxcclxuICogQERhdGU6IDIwMTktMDgtMDIgMTU6MzE6MzRcclxuICogQExhc3QgTW9kaWZpZWQgYnk6IGFhbGl6endlbGxcclxuICogQExhc3QgTW9kaWZpZWQgdGltZTogMjAyMC0wMy0wMyAwOTozMzo0M1xyXG4gKi9cclxuaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwsIEluamVjdG9yLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIFJlZmxlY3RpdmVJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBSb3V0ZXIsIEFjdGl2YXRlZFJvdXRlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcclxuaW1wb3J0IHsgUnVudGltZUZyYW1ld29ya1NlcnZpY2UgfSBmcm9tICcuL3J0Zi1zZXJ2aWNlJztcclxuaW1wb3J0IHsgQXBwT3B0aW9ucywgQXBwVHlwZSB9IGZyb20gJ0Bnc3Atc3lzL3J0Zi1jb21tb24nO1xyXG5pbXBvcnQgeyBNZW51U3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi9tZW51LXN0YXRlLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBOYXZpZ2F0aW9uRXZlbnRTZXJ2aWNlIH0gZnJvbSAnLi9uYXZpZ2F0aW9uLWV2ZW50LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBRdWVyeXN0cmluZ1NlcnZpY2UgfSBmcm9tICcuL3F1ZXJ5c3RyaW5nJztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0LCBUcmFuc2xhdGVUb2tlbiwgVHJhbnNsYXRlLCBGcmFtZUNvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgRkVQYWdlTW9kYWxTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy9leHRlbmQtcGFnZS1tb2RhbCc7XHJcbmltcG9ydCBsb2Rhc2ggZnJvbSAnbG9kYXNoLWVzJztcclxuaW1wb3J0IHsgRmFycmlzRm9ybVNlcnZpY2UgfSBmcm9tICcuL2ZhcnJpcy1mb3JtLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuL2xhbmd1YWcuc2VydmljZSc7XHJcbmltcG9ydCB7IG1hcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBFTVBUWSwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgRm9ybU5vdGlmeVNlcnZpY2UgfSBmcm9tICcuL2Zvcm0tbm90aWZ5LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBJTlNJREVfRElBTE9HX1RPS0VOLCBNT0RBTF9SRUYgfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgQnNNb2RhbFJlZiB9IGZyb20gJ0BmYXJyaXMvdWktbW9kYWwnO1xyXG5kZWNsYXJlIGNvbnN0IFN5c3RlbTogYW55O1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZTogbm8tc3RyaW5nLWxpdGVyYWwgbWF4LWxpbmUtbGVuZ3RoXHJcbmNvbnN0IEFQUF9DT05URVhUX01BTkFHRVIgPSAnREVWS0lUX0FQUF9DT05URVhUX01BTkFHRVInO1xyXG4vKipcclxuICog5a+86Iiq5pyN5YqhXHJcbiAqIEBzY29wZSBGb3JtTW9kdWxlXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBOYXZpZ2F0aW9uU2VydmljZSB7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBydW50aW1lRnJhbWV3b3JrU2VydmljZTogUnVudGltZUZyYW1ld29ya1NlcnZpY2UsXHJcbiAgICBwcml2YXRlIG1lbnVTdGF0ZVNlcnZpY2U6IE1lbnVTdGF0ZVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIG5hdmlnYXRpb25FdmVudFNlcnZpY2U6IE5hdmlnYXRpb25FdmVudFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHF1ZXJ5c3RyaW5nU2VydmljZTogUXVlcnlzdHJpbmdTZXJ2aWNlLFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IExhbmd1YWdlU2VydmljZVxyXG4gICAgLy8gQE9wdGlvbmFsKCkgcHJpdmF0ZSBwYWdlTW9kYWxTZXJ2aWNlOiBGRVBhZ2VNb2RhbFNlcnZpY2UsXHJcbiAgICAvLyBAT3B0aW9uYWwoKSBwcml2YXRlIGZhcnJpc0Zvcm1TZXJ2aWNlOiBGYXJyaXNGb3JtU2VydmljZSxcclxuICAgIC8vIEBPcHRpb25hbCgpIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2VcclxuICApIHtcclxuICAgIC8vIGFwcElk5LiN5ZCM5LqOdGFiSWTvvIzmr4/mrKHooajljZXlrp7kvovljJbml7bpg73kvJrph43mlrDnlJ/miJBcclxuICAgIGNvbnN0IGFwcElkID0gdGhpcy5mb3JtQXBwQ29udGV4dCAmJiB0aGlzLmZvcm1BcHBDb250ZXh0LkFwcGxpY2F0aW9uSWQ7XHJcbiAgICBsZXQgdGFiSWQgPSB0aGlzLnF1ZXJ5c3RyaW5ncy50YWJJZCB8fCB0aGlzLnF1ZXJ5c3RyaW5ncy5mdW5jSWQgfHwgdGhpcy5xdWVyeXN0cmluZ3MuYXBwSWQ7XHJcbiAgICAvLyDlt7Lnu4/nvJbor5HnmoTooajljZXvvIzkvb/nlKhhcHBJZOiusOW9lWhhc2hcclxuICAgIGlmIChhcHBJZCkge1xyXG4gICAgICBjb25zdCBhcHBDb250ZXh0TWFuYWdlciA9IHdpbmRvd1tBUFBfQ09OVEVYVF9NQU5BR0VSXSB8fCBuZXcgTWFwPHN0cmluZywgYW55PigpO1xyXG4gICAgICBpZiAoYXBwQ29udGV4dE1hbmFnZXIgJiYgIWFwcENvbnRleHRNYW5hZ2VyLmhhcyhhcHBJZCkpIHtcclxuICAgICAgICBhcHBDb250ZXh0TWFuYWdlci5zZXQoYXBwSWQsIHsgaGFzaDogd2luZG93LmxvY2F0aW9uLmhhc2ggfSk7XHJcbiAgICAgICAgd2luZG93W0FQUF9DT05URVhUX01BTkFHRVJdID0gYXBwQ29udGV4dE1hbmFnZXI7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGlmICh0YWJJZCkge1xyXG4gICAgICBjb25zdCBmb3JtRXZlbnRTZXJ2aWNlczogTWFwPHN0cmluZywgYW55PiA9IHdpbmRvd1snZm9ybUV2ZW50U2VydmljZXMnXSB8fCBuZXcgTWFwPHN0cmluZywgYW55PigpO1xyXG4gICAgICAvLyB0YWJJZOOAgWFwcElk6YO95a2Y5Zyo5pe277yM5L2/55SoYXBwSWTmm7/mjaJ0YWJJZFxyXG4gICAgICBpZiAoYXBwSWQpIHtcclxuICAgICAgICB0YWJJZCA9IGFwcElkO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChmb3JtRXZlbnRTZXJ2aWNlcyAmJiBmb3JtRXZlbnRTZXJ2aWNlcy5oYXModGFiSWQpKSB7XHJcbiAgICAgICAgdGhpcy5uYXZpZ2F0aW9uRXZlbnRTZXJ2aWNlID0gZm9ybUV2ZW50U2VydmljZXMuZ2V0KHRhYklkKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLm5hdmlnYXRpb25FdmVudFNlcnZpY2UucmVnaXN0ZXJFdmVudCgpO1xyXG4gICAgICAgIGZvcm1FdmVudFNlcnZpY2VzLnNldCh0YWJJZCwgdGhpcy5uYXZpZ2F0aW9uRXZlbnRTZXJ2aWNlKTtcclxuICAgICAgICB0aGlzLm5hdmlnYXRpb25FdmVudFNlcnZpY2UuZnJhbWVDb250ZXh0ID0gdGhpcy5mcmFtZUNvbnRleHQ7XHJcbiAgICAgICAgd2luZG93Wydmb3JtRXZlbnRTZXJ2aWNlcyddID0gZm9ybUV2ZW50U2VydmljZXM7XHJcbiAgICAgICAgdGhpcy5yZWdpc3RlckRlc3Ryb3lFdmVudCh0YWJJZCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGlmICghbGFuZ3VhZ2VTZXJ2aWNlKSB7XHJcbiAgICAgIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlID0gbmV3IExhbmd1YWdlU2VydmljZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuICBwdWJsaWMgc2V0IGNvbnRleHQoY29udGV4dCkge1xyXG4gICAgdGhpcy5uYXZpZ2F0aW9uRXZlbnRTZXJ2aWNlWydjb250ZXh0J10gPSBjb250ZXh0O1xyXG4gICAgdGhpc1snY29tbWFuZENvbnRleHQnXSA9IGNvbnRleHQ7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluaVtOS4quihqOWNleeahGFwcGNvbnRleHTvvIjpmaRtb2R1bGXkuIrnmoRhcHBjb250ZXh077yJXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXQgZm9ybUFwcENvbnRleHQoKSB7XHJcbiAgICBpZiAodGhpcy5mcmFtZUNvbnRleHQpIHtcclxuICAgICAgbGV0IGFwcENvbnRleHQgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0O1xyXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1heC1saW5lLWxlbmd0aFxyXG4gICAgICB3aGlsZSAoYXBwQ29udGV4dCAmJiBhcHBDb250ZXh0LnBhcmVudCAmJiBhcHBDb250ZXh0LnBhcmVudC5pbmplY3RvciAmJiBhcHBDb250ZXh0LnBhcmVudC5pbmplY3Rvci5nZXQoRnJhbWVDb250ZXh0LCBudWxsKSAhPT0gbnVsbCkge1xyXG4gICAgICAgIGFwcENvbnRleHQgPSBhcHBDb250ZXh0LnBhcmVudDtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gYXBwQ29udGV4dDtcclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuICBwcml2YXRlIGdldCBxdWVyeXN0cmluZ3MoKSB7XHJcbiAgICBsZXQgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoO1xyXG4gICAgY29uc3QgYXBwSWQgPSB0aGlzLmZvcm1BcHBDb250ZXh0ICYmIHRoaXMuZm9ybUFwcENvbnRleHQuQXBwbGljYXRpb25JZDtcclxuICAgIGlmIChhcHBJZCkge1xyXG4gICAgICBjb25zdCBhcHBDb250ZXh0TWFuYWdlciA9IHdpbmRvd1tBUFBfQ09OVEVYVF9NQU5BR0VSXTtcclxuICAgICAgY29uc3QgYXBwQ29udGV4dCA9IGFwcENvbnRleHRNYW5hZ2VyICYmIGFwcENvbnRleHRNYW5hZ2VyLmdldChhcHBJZCk7XHJcbiAgICAgIGhhc2ggPSBhcHBDb250ZXh0ICYmIGFwcENvbnRleHQuaGFzaCB8fCBoYXNoO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcGFyYW1zID0gdGhpcy5xdWVyeXN0cmluZ1NlcnZpY2UucGFyc2UoaGFzaCk7XHJcbiAgICBpZiAocGFyYW1zKSB7XHJcbiAgICAgIHBhcmFtcy5mb3JtVG9rZW4gPSB0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlLmZvcm1Ub2tlbjtcclxuICAgIH1cclxuICAgIHJldHVybiBwYXJhbXM7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaPkOekuuacjeWKoVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0IGZvcm1Ob3RpZnlTZXJ2aWNlKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuaW5qZWN0b3IgJiYgdGhpcy5pbmplY3Rvci5nZXQ8Rm9ybU5vdGlmeVNlcnZpY2U+KEZvcm1Ob3RpZnlTZXJ2aWNlLCBudWxsKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5rOo5YaM6ZSA5q+B5LqL5Lu2XHJcbiAgICogQHBhcmFtIHRhYklkXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZWdpc3RlckRlc3Ryb3lFdmVudCh0YWJJZDogc3RyaW5nKSB7XHJcbiAgICBpZiAodGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuZGVzdG9yeVNpZ25hbCkge1xyXG4gICAgICB0aGlzLmZyYW1lQ29udGV4dC5kZXN0b3J5U2lnbmFsLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5uYXZpZ2F0aW9uRXZlbnRTZXJ2aWNlID0gbnVsbDtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dCAmJiB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmRlc3RvcnlTaWduYWwpIHtcclxuICAgICAgdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5kZXN0b3J5U2lnbmFsLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZm9ybUV2ZW50U2VydmljZXMgPSB3aW5kb3dbJ2Zvcm1FdmVudFNlcnZpY2VzJ10gYXMgTWFwPHN0cmluZywgYW55PjtcclxuICAgICAgICBpZiAoZm9ybUV2ZW50U2VydmljZXMpIHtcclxuICAgICAgICAgIGZvcm1FdmVudFNlcnZpY2VzLmRlbGV0ZSh0YWJJZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGFwcENvbnRleHRNYW5hZ2VyID0gd2luZG93W0FQUF9DT05URVhUX01BTkFHRVJdIGFzIE1hcDxzdHJpbmcsIGFueT47XHJcbiAgICAgICAgaWYgKGFwcENvbnRleHRNYW5hZ2VyKSB7XHJcbiAgICAgICAgICBhcHBDb250ZXh0TWFuYWdlci5kZWxldGUodGFiSWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8vICNyZWdpb24g5o6l5Y+jXHJcblxyXG4gIC8qKlxyXG4gICAqIOaJk+W8gOiPnOWNlVxyXG4gICAqIEBwYXJhbSB0YWJJZCDmoLnmja5UYWJJZOWGs+WumuaJk+W8gOaWsOagh+etvumhteaIluWumuS9jeS5i+WJjeaJk+W8gOeahOagh+etvumhtVxyXG4gICAqIEBwYXJhbSBmdW5jSWQg6I+c5Y2VSWRcclxuICAgKiBAcGFyYW0gcGFyYW1zIOWPguaVsFxyXG4gICAqIEBwYXJhbSByZWxvYWQg5piv5ZCm6YeN5paw5Yi35pawXHJcbiAgICogQHBhcmFtIGVuYWJsZVJlZnJlc2gg5ZCv55So5pWw5o2u5Yi35pawXHJcbiAgICogQHBhcmFtIHRhYk5hbWUgdGFi5qCH6aKYXHJcbiAgICogQHBhcmFtIGRlc3RydWN0dXJpbmcg5piv5ZCm6Kej5p6E5Y+C5pWwXHJcbiAgICovXHJcbiAgcHVibGljIG9wZW5NZW51KHRhYklkOiBzdHJpbmcsIGZ1bmNJZDogc3RyaW5nLCBwYXJhbXM6IGFueSwgcmVsb2FkPzogYm9vbGVhbiwgZW5hYmxlUmVmcmVzaD86IGFueSwgdGFiTmFtZT86IHN0cmluZywgZGVzdHJ1Y3R1cmluZz86IGFueSkge1xyXG4gICAgaWYgKCFmdW5jSWQgJiYgdGhpcy5mb3JtTm90aWZ5U2VydmljZSkge1xyXG4gICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UuYXBwT3JGdW5jSWRSZXF1aXJlZCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIGlmICh0YWJOYW1lKSB7XHJcbiAgICAgIHRhYk5hbWUgPSB0aGlzLnRyYW5zbGF0ZSh0YWJOYW1lKTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgcXVlcnlTdHJpbmdQYXJhbXMgPSB0aGlzLmJ1aWxkUGFyYW1NYXAocGFyYW1zKTtcclxuICAgIGRlc3RydWN0dXJpbmcgPSB0aGlzLmNvbnZlcnRUb0Jvb2xlYW4oZGVzdHJ1Y3R1cmluZywgZmFsc2UpO1xyXG4gICAgaWYgKGRlc3RydWN0dXJpbmcgPT09IHRydWUpIHtcclxuICAgICAgcXVlcnlTdHJpbmdQYXJhbXMgPSB0aGlzLmJ1aWxkUGFyYW0ocGFyYW1zKTtcclxuICAgIH1cclxuICAgIC8vIGNvbnN0IHBhcmFtc01hcCA9IHRoaXMuYnVpbGRQYXJhbU1hcChwYXJhbXMpO1xyXG4gICAgY29uc3QgY3VycmVudFRhYklkID0gdGhpcy5xdWVyeXN0cmluZ3MudGFiSWQgfHwgdGhpcy5xdWVyeXN0cmluZ3MuZnVuY0lkIHx8IHRoaXMucXVlcnlzdHJpbmdzLmFwcElkO1xyXG4gICAgY29uc3Qgb3B0aW9uczogQXBwT3B0aW9ucyA9IHtcclxuICAgICAgdGFiSWQsXHJcbiAgICAgIGZ1bmNJZCxcclxuICAgICAgYXBwVHlwZTogQXBwVHlwZS5NZW51LFxyXG4gICAgICBxdWVyeVN0cmluZ1BhcmFtczogcXVlcnlTdHJpbmdQYXJhbXMsXHJcbiAgICAgIGVudGl0eVBhcmFtczogcXVlcnlTdHJpbmdQYXJhbXMsXHJcbiAgICAgIGFwcElkOiB1bmRlZmluZWQsXHJcbiAgICAgIGFwcEVudHJhbmNlOiB1bmRlZmluZWQsXHJcbiAgICAgIGlzUmVsb2FkOiByZWxvYWQsXHJcbiAgICAgIHRhYk5hbWU6IHRhYk5hbWUgfHwgbnVsbFxyXG4gICAgfTtcclxuICAgIC8vIOWQr+eUqOaVsOaNruWIt+aWsOWPguaVsOS4unRydWXmiJbogIXmsqHmnInlrprkuYnvvIzliJnmjInliLfmlrDlpITnkIZcclxuICAgIC8vIOayoeacieS8oOmAkuivpeWPguaVsOaIluivpeWPguaVsOS4uuepuu+8jOWImeiupOS4uuaMieeFp+S5i+WJjeeahOmAu+i+keWkhOeQhu+8jOm7mOiupOWIt+aWsFxyXG4gICAgLy8gbnVsbCBmYWxzZSBcImZhbHNlXCIgXCJ0cnVlXCIgdW5kZWZpbmVkXHJcbiAgICBlbmFibGVSZWZyZXNoID0gdGhpcy5jb252ZXJ0VG9Cb29sZWFuKGVuYWJsZVJlZnJlc2gsIHRydWUpO1xyXG4gICAgaWYgKGVuYWJsZVJlZnJlc2ggPT09IHRydWUpIHtcclxuICAgICAgY29uc3QgZnJhbWV3b3JrVGFiSWQgPSB0YWJJZCA/IGAke2Z1bmNJZH1fJHt0YWJJZH1gIDogZnVuY0lkO1xyXG4gICAgICB0aGlzLm1lbnVTdGF0ZVNlcnZpY2UuYWRkTWVudVN0YXRlKGN1cnJlbnRUYWJJZCwgZnJhbWV3b3JrVGFiSWQpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5vcGVuTWVudShvcHRpb25zKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5omT5byA6I+c5Y2V77yI5rWB77yJXHJcbiAgICogQHBhcmFtIHRhYklkIOagueaNrlRhYklk5Yaz5a6a5omT5byA5paw5qCH562+6aG15oiW5a6a5L2N5LmL5YmN5omT5byA55qE5qCH562+6aG1XHJcbiAgICogQHBhcmFtIGZ1bmNJZCDoj5zljZVJZFxyXG4gICAqIEBwYXJhbSBwYXJhbXMg5Y+C5pWwXHJcbiAgICogQHBhcmFtIHJlbG9hZCDmmK/lkKbph43mlrDliLfmlrBcclxuICAgKiBAcGFyYW0gZW5hYmxlUmVmcmVzaCDlkK/nlKjmlbDmja7liLfmlrBcclxuICAgKiBAcGFyYW0gZGVzdHJ1Y3R1cmluZyDop6PmnoTlj4LmlbBcclxuICAgKi9cclxuICBwdWJsaWMgb3Blbk1lbnUkKHRhYklkOiBzdHJpbmcsIGZ1bmNJZDogc3RyaW5nLCBwYXJhbXM6IGFueSwgcmVsb2FkPzogYm9vbGVhbiwgZW5hYmxlUmVmcmVzaD86IGFueSwgdGFiTmFtZT86IHN0cmluZywgZGVzdHJ1Y3R1cmluZz86IGFueSkge1xyXG4gICAgaWYgKCFmdW5jSWQgJiYgdGhpcy5mb3JtTm90aWZ5U2VydmljZSkge1xyXG4gICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UuYXBwT3JGdW5jSWRSZXF1aXJlZCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIGlmICh0YWJOYW1lKSB7XHJcbiAgICAgIHRhYk5hbWUgPSB0aGlzLnRyYW5zbGF0ZSh0YWJOYW1lKTtcclxuICAgIH1cclxuICAgIGxldCBxdWVyeVN0cmluZ1BhcmFtcyA9IHRoaXMuYnVpbGRQYXJhbU1hcChwYXJhbXMpO1xyXG4gICAgZGVzdHJ1Y3R1cmluZyA9IHRoaXMuY29udmVydFRvQm9vbGVhbihkZXN0cnVjdHVyaW5nLCBmYWxzZSk7XHJcbiAgICBpZiAoZGVzdHJ1Y3R1cmluZyA9PT0gdHJ1ZSkge1xyXG4gICAgICBxdWVyeVN0cmluZ1BhcmFtcyA9IHRoaXMuYnVpbGRQYXJhbShwYXJhbXMpO1xyXG4gICAgfVxyXG4gICAgLy8gY29uc3QgcGFyYW1zTWFwID0gdGhpcy5idWlsZFBhcmFtTWFwKHBhcmFtcyk7XHJcbiAgICBjb25zdCBjdXJyZW50VGFiSWQgPSB0aGlzLnF1ZXJ5c3RyaW5ncy50YWJJZCB8fCB0aGlzLnF1ZXJ5c3RyaW5ncy5mdW5jSWQgfHwgdGhpcy5xdWVyeXN0cmluZ3MuYXBwSWQ7XHJcbiAgICBjb25zdCBvcHRpb25zOiBBcHBPcHRpb25zID0ge1xyXG4gICAgICB0YWJJZCxcclxuICAgICAgZnVuY0lkLFxyXG4gICAgICBhcHBUeXBlOiBBcHBUeXBlLk1lbnUsXHJcbiAgICAgIHF1ZXJ5U3RyaW5nUGFyYW1zOiBxdWVyeVN0cmluZ1BhcmFtcyxcclxuICAgICAgZW50aXR5UGFyYW1zOiBxdWVyeVN0cmluZ1BhcmFtcyxcclxuICAgICAgYXBwSWQ6IHVuZGVmaW5lZCxcclxuICAgICAgYXBwRW50cmFuY2U6IHVuZGVmaW5lZCxcclxuICAgICAgaXNSZWxvYWQ6IHJlbG9hZCxcclxuICAgICAgdGFiTmFtZTogdGFiTmFtZSB8fCBudWxsXHJcbiAgICB9O1xyXG4gICAgLy8g5ZCv55So5pWw5o2u5Yi35paw5Y+C5pWw5Li6dHJ1ZeaIluiAheayoeacieWumuS5ie+8jOWImeaMieWIt+aWsOWkhOeQhlxyXG4gICAgZW5hYmxlUmVmcmVzaCA9IHRoaXMuY29udmVydFRvQm9vbGVhbihlbmFibGVSZWZyZXNoLCB0cnVlKTtcclxuICAgIGlmIChlbmFibGVSZWZyZXNoID09PSB0cnVlKSB7XHJcbiAgICAgIGNvbnN0IGZyYW1ld29ya1RhYklkID0gdGFiSWQgPyBgJHtmdW5jSWR9XyR7dGFiSWR9YCA6IGZ1bmNJZDtcclxuICAgICAgdGhpcy5tZW51U3RhdGVTZXJ2aWNlLmFkZE1lbnVTdGF0ZShjdXJyZW50VGFiSWQsIGZyYW1ld29ya1RhYklkKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlLm9wZW5NZW51JChvcHRpb25zKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5omT5byA6I+c5Y2VKOW4pue7tOW6pilcclxuICAgKiBAcGFyYW0gdGFiSWQg5qC55o2uVGFiSWTlhrPlrprmiZPlvIDmlrDmoIfnrb7pobXmiJblrprkvY3kuYvliY3miZPlvIDnmoTmoIfnrb7pobVcclxuICAgKiBAcGFyYW0gZnVuY0lkIOiPnOWNlUlkXHJcbiAgICogQHBhcmFtIHBhcmFtcyDlj4LmlbBcclxuICAgKiBAcGFyYW0gcmVsb2FkIOaYr+WQpumHjeaWsOWIt+aWsFxyXG4gICAqIEBwYXJhbSBlbmFibGVSZWZyZXNoIOWQr+eUqOaVsOaNruWIt+aWsFxyXG4gICAqIEBwYXJhbSBkaW0xIGRpbTFcclxuICAgKiBAcGFyYW0gZGltMiBkaW0yXHJcbiAgICogQHBhcmFtIGRlc3RydWN0dXJpbmcg6Kej5p6E5Y+C5pWwXHJcbiAgICovXHJcbiAgcHVibGljIG9wZW5NZW51V2l0aERpbWVuc2lvbih0YWJJZDogc3RyaW5nLCBmdW5jSWQ6IHN0cmluZywgcGFyYW1zOiBhbnksIGVuYWJsZVJlZnJlc2g/OiBhbnksIGRpbTE/OiBhbnksIGRpbTI/OiBhbnksIHRhYk5hbWU/OiBzdHJpbmcsIG1ldGFkYXRhSWQ/OiBzdHJpbmcsIGRlc3RydWN0dXJpbmc/OiBhbnkpIHtcclxuICAgIGlmICghZnVuY0lkICYmIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2UpIHtcclxuICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmFwcE9yRnVuY0lkUmVxdWlyZWQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcbiAgICBpZiAodGFiTmFtZSkge1xyXG4gICAgICB0YWJOYW1lID0gdGhpcy50cmFuc2xhdGUodGFiTmFtZSk7XHJcbiAgICB9XHJcbiAgICBpZiAobWV0YWRhdGFJZCA9PT0gdW5kZWZpbmVkIHx8IG1ldGFkYXRhSWQgPT09IG51bGwpIHtcclxuICAgICAgbWV0YWRhdGFJZCA9ICcnO1xyXG4gICAgfVxyXG4gICAgbGV0IHF1ZXJ5U3RyaW5nUGFyYW1zID0gdGhpcy5idWlsZFBhcmFtTWFwKHBhcmFtcyk7XHJcbiAgICBkZXN0cnVjdHVyaW5nID0gdGhpcy5jb252ZXJ0VG9Cb29sZWFuKGRlc3RydWN0dXJpbmcsIGZhbHNlKTtcclxuICAgIGlmIChkZXN0cnVjdHVyaW5nID09PSB0cnVlKSB7XHJcbiAgICAgIHF1ZXJ5U3RyaW5nUGFyYW1zID0gdGhpcy5idWlsZFBhcmFtKHBhcmFtcyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gY29uc3QgcGFyYW1zTWFwID0gdGhpcy5idWlsZFBhcmFtTWFwKHBhcmFtcyk7XHJcbiAgICBxdWVyeVN0cmluZ1BhcmFtcy5zZXQoJ2RpbTEnLCBkaW0xID8gZGltMSA6ICdwdWJsaWMnKTtcclxuICAgIHF1ZXJ5U3RyaW5nUGFyYW1zLnNldCgnZGltMicsIGRpbTIgPyBkaW0yIDogJ3B1YmxpYycpO1xyXG4gICAgcXVlcnlTdHJpbmdQYXJhbXMuc2V0KCdtZXRhZGF0YUlkJywgbWV0YWRhdGFJZCk7XHJcbiAgICBxdWVyeVN0cmluZ1BhcmFtcy5zZXQoJ2lzUnRjJywgJzEnKTtcclxuICAgIHF1ZXJ5U3RyaW5nUGFyYW1zLnNldCgnaXNSb290TWV0YWRhdGEnLCAndHJ1ZScpO1xyXG4gICAgY29uc3QgY3VycmVudFRhYklkID0gdGhpcy5xdWVyeXN0cmluZ3MudGFiSWQgfHwgdGhpcy5xdWVyeXN0cmluZ3MuZnVuY0lkIHx8IHRoaXMucXVlcnlzdHJpbmdzLmFwcElkO1xyXG4gICAgY29uc3Qgb3B0aW9uczogQXBwT3B0aW9ucyA9IHtcclxuICAgICAgdGFiSWQsXHJcbiAgICAgIGZ1bmNJZCxcclxuICAgICAgYXBwVHlwZTogQXBwVHlwZS5NZW51LFxyXG4gICAgICBxdWVyeVN0cmluZ1BhcmFtczogcXVlcnlTdHJpbmdQYXJhbXMsXHJcbiAgICAgIGVudGl0eVBhcmFtczogcXVlcnlTdHJpbmdQYXJhbXMsXHJcbiAgICAgIGFwcElkOiB1bmRlZmluZWQsXHJcbiAgICAgIGFwcEVudHJhbmNlOiB1bmRlZmluZWQsXHJcbiAgICAgIGlzUmVsb2FkOiBmYWxzZSxcclxuICAgICAgdGFiTmFtZTogdGFiTmFtZSB8fCBudWxsXHJcbiAgICB9O1xyXG4gICAgLy8g5ZCv55So5pWw5o2u5Yi35paw5Y+C5pWw5Li6dHJ1ZeaIluiAheayoeacieWumuS5ie+8jOWImeaMieWIt+aWsOWkhOeQhlxyXG4gICAgLy8g5rKh5pyJ5Lyg6YCS6K+l5Y+C5pWw5oiW6K+l5Y+C5pWw5Li656m677yM5YiZ6K6k5Li65oyJ54Wn5LmL5YmN55qE6YC76L6R5aSE55CG77yM6buY6K6k5Yi35pawXHJcbiAgICAvLyBudWxsIGZhbHNlIFwiZmFsc2VcIiBcInRydWVcIiB1bmRlZmluZWRcclxuICAgIGVuYWJsZVJlZnJlc2ggPSB0aGlzLmNvbnZlcnRUb0Jvb2xlYW4oZW5hYmxlUmVmcmVzaCwgdHJ1ZSk7XHJcbiAgICBpZiAoZW5hYmxlUmVmcmVzaCA9PT0gdHJ1ZSkge1xyXG4gICAgICBjb25zdCBmcmFtZXdvcmtUYWJJZCA9IHRhYklkID8gYCR7ZnVuY0lkfV8ke3RhYklkfWAgOiBmdW5jSWQ7XHJcbiAgICAgIHRoaXMubWVudVN0YXRlU2VydmljZS5hZGRNZW51U3RhdGUoY3VycmVudFRhYklkLCBmcmFtZXdvcmtUYWJJZCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlLm9wZW5NZW51KG9wdGlvbnMpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmiZPlvIDlupTnlKhcclxuICAgKiBAcGFyYW0gdGFiSWQgdGFiSWQg5qC55o2uVGFiSWTlhrPlrprmiZPlvIDmlrDmoIfnrb7pobXmiJblrprkvY3kuYvliY3miZPlvIDnmoTmoIfnrb7pobVcclxuICAgKiBAcGFyYW0gYXBwSWQg5bqU55SoSWRcclxuICAgKiBAcGFyYW0gYXBwRW50cmFuY2Ug5bqU55So5YWl5Y+jXHJcbiAgICogQHBhcmFtIHBhcmFtcyDlj4LmlbBcclxuICAgKiBAcGFyYW0gcmVsb2FkIOaYr+WQpumHjeaWsOWIt+aWsFxyXG4gICAqIEBwYXJhbSB0YWJOYW1lIHRhYuagh+mimFxyXG4gICAqIEBwYXJhbSBlbmFibGVSZWZyZXNoIOWQr+eUqOaVsOaNruWIt+aWsFxyXG4gICAqIEBwYXJhbSBkZXN0cnVjdHVyaW5nIOino+aehOWPguaVsFxyXG4gICAqL1xyXG5cclxuICBwdWJsaWMgb3BlbkFwcCh0YWJJZDogc3RyaW5nLCBhcHBJZDogc3RyaW5nLCBhcHBFbnRyYW5jZTogc3RyaW5nLCBwYXJhbXM6IGFueSwgcmVsb2FkPzogYm9vbGVhbiwgdGFiTmFtZT86IHN0cmluZywgZW5hYmxlUmVmcmVzaD86IGFueSwgZGVzdHJ1Y3R1cmluZz86IGFueSkge1xyXG4gICAgaWYgKCFhcHBJZCAmJiB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlKSB7XHJcbiAgICAgIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5hcHBPckZ1bmNJZFJlcXVpcmVkLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgaWYgKHRhYk5hbWUpIHtcclxuICAgICAgdGFiTmFtZSA9IHRoaXMudHJhbnNsYXRlKHRhYk5hbWUpO1xyXG4gICAgfVxyXG4gICAgbGV0IHF1ZXJ5U3RyaW5nUGFyYW1zID0gdGhpcy5idWlsZFBhcmFtTWFwKHBhcmFtcyk7XHJcbiAgICBkZXN0cnVjdHVyaW5nID0gdGhpcy5jb252ZXJ0VG9Cb29sZWFuKGRlc3RydWN0dXJpbmcsIGZhbHNlKTtcclxuICAgIGlmIChkZXN0cnVjdHVyaW5nID09PSB0cnVlKSB7XHJcbiAgICAgIHF1ZXJ5U3RyaW5nUGFyYW1zID0gdGhpcy5idWlsZFBhcmFtKHBhcmFtcyk7XHJcbiAgICB9XHJcbiAgICAvLyBjb25zdCBwYXJhbXNNYXAgPSB0aGlzLmJ1aWxkUGFyYW1NYXAocGFyYW1zKTtcclxuICAgIGNvbnN0IGN1cnJlbnRUYWJJZCA9IHRoaXMucXVlcnlzdHJpbmdzLnRhYklkIHx8IHRoaXMucXVlcnlzdHJpbmdzLmZ1bmNJZCB8fCB0aGlzLnF1ZXJ5c3RyaW5ncy5hcHBJZDtcclxuICAgIGNvbnN0IG9wdGlvbnM6IEFwcE9wdGlvbnMgPSB7XHJcbiAgICAgIHRhYklkLFxyXG4gICAgICBhcHBJZCxcclxuICAgICAgYXBwRW50cmFuY2UsXHJcbiAgICAgIGZ1bmNJZDogdW5kZWZpbmVkLFxyXG4gICAgICBhcHBUeXBlOiBBcHBUeXBlLkFwcCxcclxuICAgICAgcXVlcnlTdHJpbmdQYXJhbXM6IHF1ZXJ5U3RyaW5nUGFyYW1zLFxyXG4gICAgICBlbnRpdHlQYXJhbXM6IHF1ZXJ5U3RyaW5nUGFyYW1zLFxyXG4gICAgICBpc1JlbG9hZDogcmVsb2FkLFxyXG4gICAgICB0YWJOYW1lOiB0YWJOYW1lIHx8IG51bGxcclxuICAgIH07XHJcbiAgICBlbmFibGVSZWZyZXNoID0gdGhpcy5jb252ZXJ0VG9Cb29sZWFuKGVuYWJsZVJlZnJlc2gsIHRydWUpO1xyXG4gICAgaWYgKGVuYWJsZVJlZnJlc2ggPT09IHRydWUpIHtcclxuICAgICAgY29uc3QgZnJhbWV3b3JrVGFiSWQgPSB0YWJJZCA/IGAke2FwcElkfV8ke2FwcEVudHJhbmNlfV8ke3RhYklkfWAgOiBgJHthcHBJZH1fJHthcHBFbnRyYW5jZX1gO1xyXG4gICAgICB0aGlzLm1lbnVTdGF0ZVNlcnZpY2UuYWRkTWVudVN0YXRlKGN1cnJlbnRUYWJJZCwgZnJhbWV3b3JrVGFiSWQpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5vcGVuTWVudShvcHRpb25zKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5omT5byA5bqU55SoKOa1geW8jylcclxuICAgKiBAcGFyYW0gdGFiSWQgdGFiSWQg5qC55o2uVGFiSWTlhrPlrprmiZPlvIDmlrDmoIfnrb7pobXmiJblrprkvY3kuYvliY3miZPlvIDnmoTmoIfnrb7pobVcclxuICAgKiBAcGFyYW0gYXBwSWQg5bqU55SoSWRcclxuICAgKiBAcGFyYW0gYXBwRW50cmFuY2Ug5bqU55So5YWl5Y+jXHJcbiAgICogQHBhcmFtIHBhcmFtcyDlj4LmlbBcclxuICAgKiBAcGFyYW0gcmVsb2FkIOaYr+WQpumHjeaWsOWIt+aWsFxyXG4gICAqIEBwYXJhbSB0YWJOYW1lIHRhYuagh+mimFxyXG4gICAqIEBwYXJhbSBlbmFibGVSZWZyZXNoIOWQr+eUqOaVsOaNruWIt+aWsFxyXG4gICAqIEBwYXJhbSBkZXN0cnVjdHVyaW5nIOino+aehOWPguaVsFxyXG4gICAqL1xyXG4gIHB1YmxpYyBvcGVuQXBwJCh0YWJJZDogc3RyaW5nLCBhcHBJZDogc3RyaW5nLCBhcHBFbnRyYW5jZTogc3RyaW5nLCBwYXJhbXM6IGFueSwgcmVsb2FkPzogYm9vbGVhbiwgdGFiTmFtZT86IHN0cmluZywgZW5hYmxlUmVmcmVzaD86IGFueSwgZGVzdHJ1Y3R1cmluZz86IGFueSkge1xyXG4gICAgaWYgKCFhcHBJZCAmJiB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlKSB7XHJcbiAgICAgIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5hcHBPckZ1bmNJZFJlcXVpcmVkLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgaWYgKHRhYk5hbWUpIHtcclxuICAgICAgdGFiTmFtZSA9IHRoaXMudHJhbnNsYXRlKHRhYk5hbWUpO1xyXG4gICAgfVxyXG4gICAgbGV0IHF1ZXJ5U3RyaW5nUGFyYW1zID0gdGhpcy5idWlsZFBhcmFtTWFwKHBhcmFtcyk7XHJcbiAgICBkZXN0cnVjdHVyaW5nID0gdGhpcy5jb252ZXJ0VG9Cb29sZWFuKGRlc3RydWN0dXJpbmcsIGZhbHNlKTtcclxuICAgIGlmIChkZXN0cnVjdHVyaW5nID09PSB0cnVlKSB7XHJcbiAgICAgIHF1ZXJ5U3RyaW5nUGFyYW1zID0gdGhpcy5idWlsZFBhcmFtKHBhcmFtcyk7XHJcbiAgICB9XHJcbiAgICAvLyBjb25zdCBwYXJhbXNNYXAgPSB0aGlzLmJ1aWxkUGFyYW1NYXAocGFyYW1zKTtcclxuICAgIGNvbnN0IGN1cnJlbnRUYWJJZCA9IHRoaXMucXVlcnlzdHJpbmdzLnRhYklkIHx8IHRoaXMucXVlcnlzdHJpbmdzLmZ1bmNJZCB8fCB0aGlzLnF1ZXJ5c3RyaW5ncy5hcHBJZDtcclxuICAgIGNvbnN0IG9wdGlvbnM6IEFwcE9wdGlvbnMgPSB7XHJcbiAgICAgIHRhYklkLFxyXG4gICAgICBhcHBJZCxcclxuICAgICAgYXBwRW50cmFuY2UsXHJcbiAgICAgIGZ1bmNJZDogdW5kZWZpbmVkLFxyXG4gICAgICBhcHBUeXBlOiBBcHBUeXBlLkFwcCxcclxuICAgICAgcXVlcnlTdHJpbmdQYXJhbXM6IHF1ZXJ5U3RyaW5nUGFyYW1zLFxyXG4gICAgICBlbnRpdHlQYXJhbXM6IHF1ZXJ5U3RyaW5nUGFyYW1zLFxyXG4gICAgICBpc1JlbG9hZDogcmVsb2FkLFxyXG4gICAgICB0YWJOYW1lOiB0YWJOYW1lIHx8IG51bGxcclxuICAgIH07XHJcbiAgICBlbmFibGVSZWZyZXNoID0gdGhpcy5jb252ZXJ0VG9Cb29sZWFuKGVuYWJsZVJlZnJlc2gsIHRydWUpO1xyXG4gICAgaWYgKGVuYWJsZVJlZnJlc2ggPT09IHRydWUpIHtcclxuICAgICAgY29uc3QgZnJhbWV3b3JrVGFiSWQgPSB0YWJJZCA/IGAke2FwcElkfV8ke2FwcEVudHJhbmNlfV8ke3RhYklkfWAgOiBgJHthcHBJZH1fJHthcHBFbnRyYW5jZX1gO1xyXG4gICAgICB0aGlzLm1lbnVTdGF0ZVNlcnZpY2UuYWRkTWVudVN0YXRlKGN1cnJlbnRUYWJJZCwgZnJhbWV3b3JrVGFiSWQpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2Uub3Blbk1lbnUkKG9wdGlvbnMpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlhbPpl61cclxuICAgKiBAcGFyYW0gb25DbG9zZWluZyDlhbPpl63liY3kuovku7blpITnkIblmahcclxuICAgKi9cclxuICBwdWJsaWMgY2xvc2UoKSB7XHJcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5xdWVyeXN0cmluZ3M7XHJcbiAgICBjb25zdCB7IGlzRGlhbG9nQ29tcG9uZW50OiBpc0luRGlhbG9nLCByb290Q29tcG9uZW50IH0gPSB0aGlzLmZpbmREaWFsb2coKTtcclxuICAgIGlmIChpc0luRGlhbG9nKSB7XHJcbiAgICAgIGNvbnN0IG1vZGFsUmVmRmFjdG9yeSA9IHRoaXMuZ2V0KHJvb3RDb21wb25lbnQsICdkaWFsb2dSZWYnKTtcclxuICAgICAgbGV0IG1vZGFsUmVmID0gbnVsbDtcclxuICAgICAgaWYgKHR5cGVvZiBtb2RhbFJlZkZhY3RvcnkgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICBjb25zdCByZWZzID0gbW9kYWxSZWZGYWN0b3J5KCk7XHJcbiAgICAgICAgbW9kYWxSZWYgPSByZWZzICYmIHJlZnMubW9kYWxSZWY7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgbW9kYWxSZWYgPSBtb2RhbFJlZkZhY3Rvcnk7XHJcbiAgICAgIH1cclxuICAgICAgbW9kYWxSZWYgJiYgbW9kYWxSZWZbJ2Nsb3NlJ10oKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgb3B0aW9ucy50b2tlbiA9IG9wdGlvbnMuZm9ybVRva2VuO1xyXG4gICAgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5iZWZvcmVDbG9zZU1lbnUob3B0aW9ucyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOW8uuWItuWFs+mXrVxyXG4gICAqL1xyXG4gIHB1YmxpYyBkZXN0b3J5KCkge1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMucXVlcnlzdHJpbmdzO1xyXG4gICAgb3B0aW9ucy50b2tlbiA9IG9wdGlvbnMuZm9ybVRva2VuO1xyXG4gICAgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5jbG9zZU1lbnUob3B0aW9ucyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqXHJcbiAgICogQHBhcmFtIHBhcmFtcyBwYXJhbXNcclxuICAgKiBAZGVwcmVjYXRlZCDlvoXlup/lvIPvvIzkuI5idWlsZFBhcmFtTWFw6YeN5aSNXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBwYXJzZVBhcmFtcyhwYXJhbXM6IGFueSkge1xyXG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICd1bmRlZmluZWQnIHx8IHBhcmFtcyA9PT0gbnVsbCB8fCAodHlwZW9mIHBhcmFtcyA9PT0gJ3N0cmluZycgJiYgcGFyYW1zLmxlbmd0aCA8IDEpKSB7XHJcbiAgICAgIHBhcmFtcyA9IHt9O1xyXG4gICAgfVxyXG4gICAgY29uc3QgcGFyYW1NYXAgPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xyXG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgIHBhcmFtcyA9IEpTT04uc3RyaW5naWZ5KHBhcmFtcyk7XHJcbiAgICB9XHJcbiAgICBwYXJhbXMgPSB3aW5kb3dbJ2VuY29kZVVSSUNvbXBvbmVudCddKHBhcmFtcyk7XHJcbiAgICBwYXJhbU1hcC5zZXQoJ1dFQl9GT1JNX1JPVVRFX1BBUkFNUycsIHBhcmFtcyk7XHJcbiAgICByZXR1cm4gcGFyYW1NYXA7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOazqOWGjOS6i+S7tuebkeWQrOWZqFxyXG4gICAqIEBwYXJhbSBldmVudFR5cGUg5LqL5Lu257G75Z6LIG9uVGFiQ2xvc2VkXHJcbiAgICogQHBhcmFtIGhhbmRsZXIg5aSE55CG5ZmoXHJcbiAgICogQHJldHVybnMgc3RyaW5nIOi/lOWbnuS6i+S7tuagh+ivhlxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZTogc3RyaW5nLCBoYW5kbGVyOiAob3B0aW9uczogQXBwT3B0aW9ucykgPT4gYW55KTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLm5hdmlnYXRpb25FdmVudFNlcnZpY2UuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGhhbmRsZXIpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDnp7vpmaTkuovku7bnm5HlkKzlmahcclxuICAgKiBAcGFyYW0gZXZlbnRUeXBlIOS6i+S7tuexu+WeiyBvblRhYkNsb3NlZCB8IG9uVGFiQ2xvc2VpbmdcclxuICAgKiBAcGFyYW0ga2V5IOS6i+S7tuagh+ivhlxyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50VHlwZTogc3RyaW5nLCBrZXk6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMubmF2aWdhdGlvbkV2ZW50U2VydmljZS5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwga2V5KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5riF56m65LqL5Lu255uR5ZCs5ZmoXHJcbiAgICogQHBhcmFtIGV2ZW50VHlwZSDkuovku7bnsbvlnotcclxuICAgKi9cclxuICBwdWJsaWMgY2xlYXJFdmVudExpc3RlbmVyKGV2ZW50VHlwZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLm5hdmlnYXRpb25FdmVudFNlcnZpY2UuY2xlYXJFdmVudExpc3RlbmVyKGV2ZW50VHlwZSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOS7peW8ueahhuOAgeS+p+i+ueagj+aIluaWsOagh+etvumhteaWueW8j+aJk+W8gOihqOWNlVxyXG4gICAqIEBwYXJhbSBtb2RlIOaJk+W8gOaWueW8j++8jOaUr+aMgWBtb2RhbGDlvLnnqpfjgIFgc2lkZWJhcmDkvqfovrnmoI/jgIFgdGFiYOaWsOagh+etvumhtVxyXG4gICAqIEBwYXJhbSBtb2RhbElkIOW8ueeql2lk77yM5aaC5p6cbW9kZT1gbW9kYWxg5LiU5rKh5pyJdXJs77yMXHJcbiAgICogQHBhcmFtIGNvbmZpZ3Mg5by556qX6YWN572uXHJcbiAgICogQHBhcmFtIHVybCDov5znq6/ooajljZV1cmxcclxuICAgKiBAcGFyYW0gdGFiSWQg5qCH562+6aG1aWTvvIxtb2RhbD10YWLml7blv4XloatcclxuICAgKiBAcGFyYW0gdGFiVHlwZSDmoIfnrb7pobXnsbvlnovvvIxgbWVudWAg5oiWYGFwcGBcclxuICAgKiBAcGFyYW0gZnVuY09yQXBwSWQg6I+c5Y2V5oiW5bqU55SoaWRcclxuICAgKiBAcGFyYW0gYXBwRW50cmFuY2Ug5bqU55So5YWl5Y+jXHJcbiAgICogQHBhcmFtIHBhcmFtcyDlj4LmlbBcclxuICAgKiBAcGFyYW0gdGFiTmFtZSDmlrDmoIfnrb7pobXlkI3np7BcclxuICAgKiBAcGFyYW0gZW5hYmxlUmVmcmVzaCDlkK/nlKjlkK/liqjliLfmlrBcclxuICAgKiBAcGFyYW0gZGVzdHJ1Y3R1cmluZyDmmK/lkKbop6PmnoRcclxuICAgKi9cclxuICBwdWJsaWMgb3Blbihtb2RlOiAnbW9kYWwnIHwgJ3NpZGViYXInIHwgJ3RhYicsIG1vZGFsSWQ/OiBzdHJpbmcsIHVybD86IHN0cmluZywgY29uZmlncz86IGFueSwgdGFiSWQ/OiBzdHJpbmcsIHRhYlR5cGU/OiAnbWVudScgfCAnYXBwJywgZnVuY09yQXBwSWQ/OiBzdHJpbmcsIGFwcEVudHJhbmNlPzogc3RyaW5nLCBwYXJhbXM/OiBhbnksIHRhYk5hbWU/OiBzdHJpbmcsIGVuYWJsZVJlZnJlc2g/OiBhbnksIGRlc3RydWN0dXJpbmc/OiBhbnkpIHtcclxuICAgIGNvbnN0IHBhZ2VNb2RhbFNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldDxGRVBhZ2VNb2RhbFNlcnZpY2U+KEZFUGFnZU1vZGFsU2VydmljZSwgbnVsbCk7XHJcbiAgICBpZiAoIXBhZ2VNb2RhbFNlcnZpY2UpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdnZXQgRkVQYWdlTW9kYWxTZXJ2aWNlIGZhaWxlZC4nKTtcclxuICAgIH1cclxuICAgIC8vIOagoemqjOWPguaVsOaYr+WQpuWQiOazlVxyXG4gICAgaWYgKCFtb2RlKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignW05hdmlnYXRpb25TZXJ2aWNlXS0+b3Blbixtb2Rl5Y+C5pWw5LiN6IO95Li656m677yBJyk7XHJcbiAgICB9XHJcbiAgICBpZiAobW9kZSA9PT0gJ21vZGFsJyB8fCBtb2RlID09PSAnc2lkZWJhcicpIHtcclxuICAgICAgaWYgKCFtb2RhbElkICYmICF1cmwpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ+W8ueeql+WPiuS+p+i+ueagj+aooeW8j+aXtuW8ueeql+WuueWZqGlk5ZKM6KGo5Y2V6Lev5b6E5LiN6IO95ZCM5pe25Li656m677yBJyk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKG1vZGFsSWQgJiYgdXJsKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCflvLnnqpflj4rkvqfovrnmoI/mqKHlvI/ml7blvLnnqpflrrnlmahpZOWSjOihqOWNlei3r+W+hOS4jeiDveWQjOaXtuWtmOWcqO+8gScpO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IHVpU3RhdGVDb25maWcgPSB0aGlzLmdldE9iamVjdFR5cGVDb25maWcocGFyYW1zKTtcclxuICAgICAgY29uc3QgbW9kYWxDb25maWcgPSB0aGlzLmJ1aWxkQ29uZmlncyhjb25maWdzKTtcclxuICAgICAgaWYgKG1vZGUgPT09ICdzaWRlYmFyJykge1xyXG4gICAgICAgIG1vZGFsQ29uZmlnLmRpYWxvZ1R5cGUgPSBtb2RlO1xyXG4gICAgICB9XHJcbiAgICAgIGxldCBwYWdlTW9kYWxSZWYgPSBudWxsO1xyXG4gICAgICBpZiAobW9kYWxJZCkge1xyXG4gICAgICAgIGNvbnN0IGZhcnJpc0Zvcm1TZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQ8RmFycmlzRm9ybVNlcnZpY2U+KEZhcnJpc0Zvcm1TZXJ2aWNlLCBudWxsKTtcclxuICAgICAgICBpZiAoIWZhcnJpc0Zvcm1TZXJ2aWNlKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGNvbXBvbmVudFR5cGUgPSBmYXJyaXNGb3JtU2VydmljZS5nZXRDb250cm9scyhtb2RhbElkKTtcclxuICAgICAgICBjb25zdCBjb21wb25lbnRSZWYgPSB0aGlzLmNyZWF0ZUNvbXBvbmVudFJlZihjb21wb25lbnRUeXBlLCB1aVN0YXRlQ29uZmlnKTtcclxuICAgICAgICBwYWdlTW9kYWxSZWYgPSBwYWdlTW9kYWxTZXJ2aWNlLnNob3coY29tcG9uZW50UmVmLCBtb2RhbENvbmZpZyk7XHJcbiAgICAgIH0gZWxzZSBpZiAodXJsKSB7XHJcbiAgICAgICAgcGFnZU1vZGFsUmVmID0gcGFnZU1vZGFsU2VydmljZS5zaG93QnlVcmwodXJsLCBtb2RhbENvbmZpZyk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHBhZ2VNb2RhbFJlZiAmJiAhIXBhZ2VNb2RhbFJlZi5jb250ZW50KSB7XHJcbiAgICAgICAgcGFnZU1vZGFsUmVmLmNvbnRlbnQuaXNEaWFsb2dSb290Q29tcG9uZW50ID0gdHJ1ZTtcclxuICAgICAgICBwYWdlTW9kYWxSZWYuY29udGVudC5kaWFsb2dSZWYgPSBwYWdlTW9kYWxSZWY7XHJcbiAgICAgICAgY29uc3QgaGVhZGVyID0gcGFnZU1vZGFsUmVmLmRpYWxvZyAmJiBwYWdlTW9kYWxSZWYuZGlhbG9nLmluc3RhbmNlICYmIHBhZ2VNb2RhbFJlZi5kaWFsb2cuaW5zdGFuY2UuZWwgJiYgcGFnZU1vZGFsUmVmLmRpYWxvZy5pbnN0YW5jZS5lbC5uYXRpdmVFbGVtZW50ICYmIHBhZ2VNb2RhbFJlZi5kaWFsb2cuaW5zdGFuY2UuZWwubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKFwiLmYtcGFnZS1oZWFkZXJcIik7XHJcbiAgICAgICAgaWYgKGhlYWRlciAmJiBwYWdlTW9kYWxSZWYuZGlhbG9nLmluc3RhbmNlLmRyYWdnYmFyKSB7XHJcbiAgICAgICAgICBwYWdlTW9kYWxSZWYuZGlhbG9nLmluc3RhbmNlLmRyYWdnYmFyLmhhbmRsZSA9IGhlYWRlcjtcclxuICAgICAgICAgIGhlYWRlci5zdHlsZS5jdXJzb3IgPSAnbW92ZSc7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKG1vZGUgPT09ICd0YWInKSB7XHJcbiAgICAgIGlmICghdGFiSWQgfHwgIXRhYlR5cGUgfHwgIWZ1bmNPckFwcElkKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZm9ybU5vdGlmeVNlcnZpY2UpIHtcclxuICAgICAgICAgIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5hcHBPckZ1bmNJZFJlcXVpcmVkLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCfmlrDmoIfnrb7mqKHlvI/ml7bmoIfnrb7pobVpZOOAgeagh+etvuexu+Wei+OAgeiPnOWNleaIluW6lOeUqGlk5Z2H5LiN6IO95Li656m677yBJyk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHRhYlR5cGUgPT09ICdhcHAnICYmICFhcHBFbnRyYW5jZSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcign5Lul5bqU55So5pa55byP5omT5byA5pe25YWl5Y+j5bqU55So5LiN6IO95Li656m677yBJyk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHRhYlR5cGUgPT0gJ2FwcCcpIHtcclxuICAgICAgICB0aGlzLm9wZW5BcHAodGFiSWQsIGZ1bmNPckFwcElkLCBhcHBFbnRyYW5jZSwgcGFyYW1zLCBmYWxzZSwgdGFiTmFtZSwgZW5hYmxlUmVmcmVzaCwgZGVzdHJ1Y3R1cmluZyk7XHJcbiAgICAgIH0gZWxzZSBpZiAodGFiVHlwZSA9PT0gJ21lbnUnKSB7XHJcbiAgICAgICAgdGhpcy5vcGVuTWVudSh0YWJJZCwgZnVuY09yQXBwSWQsIHBhcmFtcywgZmFsc2UsIGVuYWJsZVJlZnJlc2gsIHRhYk5hbWUsIGRlc3RydWN0dXJpbmcpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ+S4jeaUr+aMgeeahOaooeW8j++8gScpO1xyXG4gICAgfVxyXG4gICAgLy8gdGhpcy5wYWdlTW9kYWxTZXJ2aWNlLlxyXG4gIH1cclxuICAvKipcclxuICAgKiBpbiBhcHAgbmF2aWdhdGVcclxuICAgKiBAcGFyYW0gY29tbWFuZHMgY29tbWFuZHNcclxuICAgKi9cclxuICAvLyBwdWJsaWMgbmF2aWdhdGUoY29tbWFuZHM6IGFueVtdKTtcclxuICAvKipcclxuICAgKiBpbiBhcHAgbmF2aWdhdGVcclxuICAgKiBAcGFyYW0gY29tbWFuZHMgY29tbWFuZHNcclxuICAgKiBAcGFyYW0gb3B0aW9ucyBvcHRpb25zXHJcbiAgICogQGRlc2NyaXB0aW9uIG9wdGlvbnM6eyByZWxhdGl2ZVRvOiB0aGlzLmFjdGl2YXRlZFJvdXRlLCBxdWVyeVBhcmFtczp7YToxLGI6Mn0sZXRjOi4uLn1cclxuICAgKi9cclxuICBwdWJsaWMgbmF2aWdhdGUoY29tbWFuZHM6IGFueVtdLCBvcHRpb25zPzogYW55KTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICBjb25zdCByb3V0ZXIgPSB0aGlzLmluamVjdG9yICYmIHRoaXMuaW5qZWN0b3IuZ2V0PFJvdXRlcj4oUm91dGVyLCBudWxsKTtcclxuICAgIGNvbnN0IGFjdGl2YXRlZFJvdXRlID0gdGhpcy5pbmplY3RvciAmJiB0aGlzLmluamVjdG9yLmdldDxBY3RpdmF0ZWRSb3V0ZT4oQWN0aXZhdGVkUm91dGUsIG51bGwpO1xyXG4gICAgY29uc3QgcXVlcnlQYXJhbXMgPSBsb2Rhc2gubWVyZ2Uoe30sIHRoaXMucXVlcnlzdHJpbmdzLCBvcHRpb25zICYmIG9wdGlvbnMucXVlcnlQYXJhbXMgfHwge30pO1xyXG4gICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgncXVlcnlQYXJhbXMnKSkge1xyXG4gICAgICBkZWxldGUgb3B0aW9ucy5xdWVyeVBhcmFtcztcclxuICAgIH1cclxuICAgIGNvbnN0IGV4dHJhcyA9IGxvZGFzaC5tZXJnZSh7IHNraXBMb2NhdGlvbkNoYW5nZTogZmFsc2UsIHJlbGF0aXZlVG86IGFjdGl2YXRlZFJvdXRlLCBxdWVyeVBhcmFtcyB9LCBvcHRpb25zIHx8IHt9KTtcclxuICAgIGlmIChyb3V0ZXIpIHtcclxuICAgICAgcmV0dXJuIHJvdXRlci5uYXZpZ2F0ZShjb21tYW5kcywgZXh0cmFzKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuICAvLyAjZW5kcmVnaW9uXHJcblxyXG4gIC8vICNyZWdpb24g56eB5pyJ5pa55rOVXHJcblxyXG4gIC8qKlxyXG4gICAqIOWwgeijhei3r+eUseWPguaVsFxyXG4gICAqIEBwYXJhbSBwYXJhbXMg5Y+C5pWwXHJcbiAgICogQHBhcmFtIG9wdGlvbnMg6YWN572u5Y+C5pWwXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZFBhcmFtTWFwKHBhcmFtczogYW55LCBvcHRpb25zPzogYW55KTogTWFwPHN0cmluZywgc3RyaW5nPiB7XHJcbiAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFyYW1zID09PSBudWxsIHx8ICh0eXBlb2YgcGFyYW1zID09PSAnc3RyaW5nJyAmJiBwYXJhbXMubGVuZ3RoIDwgMSkpIHtcclxuICAgICAgcGFyYW1zID0ge307XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXJhbU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcbiAgICBpZiAob3B0aW9ucyAmJiBPYmplY3Qua2V5cyhvcHRpb25zKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGlmICh0eXBlb2YgcGFyYW1zICE9PSAnb2JqZWN0Jykge1xyXG4gICAgICAgIHBhcmFtcyA9IEpTT04ucGFyc2UocGFyYW1zKTtcclxuICAgICAgfVxyXG4gICAgICBwYXJhbXMgPSBsb2Rhc2gubWVyZ2UocGFyYW1zLCBvcHRpb25zKTtcclxuICAgIH1cclxuICAgIGlmICh0eXBlb2YgcGFyYW1zID09PSAnb2JqZWN0Jykge1xyXG4gICAgICBwYXJhbXMgPSBKU09OLnN0cmluZ2lmeShwYXJhbXMpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgY3VycmVudFRhYklkID0gdGhpcy5xdWVyeXN0cmluZ3MudGFiSWQgfHwgdGhpcy5xdWVyeXN0cmluZ3MuZnVuY0lkIHx8IHRoaXMucXVlcnlzdHJpbmdzLmFwcElkO1xyXG4gICAgcGFyYW1zID0gd2luZG93WydlbmNvZGVVUklDb21wb25lbnQnXShwYXJhbXMpO1xyXG4gICAgcGFyYW1NYXAuc2V0KCdXRUJfRk9STV9ST1VURV9QQVJBTVMnLCBwYXJhbXMpO1xyXG4gICAgcGFyYW1NYXAuc2V0KCdXRUJfRk9STV9ST1VURVJfUEFSRU5UX0lEJywgY3VycmVudFRhYklkKTtcclxuICAgIHJldHVybiBwYXJhbU1hcDtcclxuICB9XHJcbiAgcHJpdmF0ZSBidWlsZFBhcmFtKHBhcmFtcywgb3B0aW9ucz86IGFueSk6IE1hcDxzdHJpbmcsIHN0cmluZz4ge1xyXG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICd1bmRlZmluZWQnIHx8IHBhcmFtcyA9PT0gbnVsbCB8fCAodHlwZW9mIHBhcmFtcyA9PT0gJ3N0cmluZycgJiYgcGFyYW1zLmxlbmd0aCA8IDEpKSB7XHJcbiAgICAgIHBhcmFtcyA9IHt9O1xyXG4gICAgfVxyXG4gICAgY29uc3QgcGFyYW1NYXAgPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xyXG4gICAgaWYgKG9wdGlvbnMgJiYgT2JqZWN0LmtleXMob3B0aW9ucykubGVuZ3RoID4gMCkge1xyXG4gICAgICBpZiAodHlwZW9mIHBhcmFtcyAhPT0gJ29iamVjdCcpIHtcclxuICAgICAgICBwYXJhbXMgPSBKU09OLnBhcnNlKHBhcmFtcyk7XHJcbiAgICAgIH1cclxuICAgICAgcGFyYW1zID0gbG9kYXNoLm1lcmdlKHBhcmFtcywgb3B0aW9ucyk7XHJcbiAgICB9XHJcbiAgICBpZiAodHlwZW9mIHBhcmFtcyAhPT0gJ29iamVjdCcpIHtcclxuICAgICAgcGFyYW1zID0gSlNPTi5wYXJzZShwYXJhbXMpO1xyXG4gICAgfVxyXG4gICAgT2JqZWN0LmtleXMocGFyYW1zKS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgIHBhcmFtTWFwLnNldChrZXksIHBhcmFtc1trZXldKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IGN1cnJlbnRUYWJJZCA9IHRoaXMucXVlcnlzdHJpbmdzLnRhYklkIHx8IHRoaXMucXVlcnlzdHJpbmdzLmZ1bmNJZCB8fCB0aGlzLnF1ZXJ5c3RyaW5ncy5hcHBJZDtcclxuICAgIHBhcmFtcyA9IHdpbmRvd1snZW5jb2RlVVJJQ29tcG9uZW50J10oSlNPTi5zdHJpbmdpZnkocGFyYW1zKSk7XHJcbiAgICBwYXJhbU1hcC5zZXQoJ1dFQl9GT1JNX1JPVVRFX1BBUkFNUycsIHBhcmFtcyk7XHJcbiAgICBwYXJhbU1hcC5zZXQoJ1dFQl9GT1JNX1JPVVRFUl9QQVJFTlRfSUQnLCBjdXJyZW50VGFiSWQpO1xyXG4gICAgcmV0dXJuIHBhcmFtTWFwO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmn6Xmib7lvLnnqpfnu4Tku7ZcclxuICAgKi9cclxuICBwcml2YXRlIGZpbmREaWFsb2coKSB7XHJcbiAgICBsZXQgZnJhbWVDb250ZXh0ID0gdGhpcy5nZXQodGhpcywgJ2NvbW1hbmRDb250ZXh0LmZyYW1lQ29udGV4dCcpO1xyXG4gICAgbGV0IGlzRGlhbG9nQ29tcG9uZW50ID0gdGhpcy5nZXQoZnJhbWVDb250ZXh0LCAnZnJhbWVDb21wb25lbnQuaXNEaWFsb2dSb290Q29tcG9uZW50JywgZmFsc2UpO1xyXG4gICAgbGV0IHJvb3RDb21wb25lbnQgPSBudWxsO1xyXG4gICAgbGV0IHBhcmVudEZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0KGZyYW1lQ29udGV4dCwgJ3BhcmVudCcpO1xyXG4gICAgd2hpbGUgKHBhcmVudEZyYW1lQ29udGV4dCAhPSBudWxsICYmICFpc0RpYWxvZ0NvbXBvbmVudCkge1xyXG4gICAgICBmcmFtZUNvbnRleHQgPSB0aGlzLmdldChmcmFtZUNvbnRleHQsICdwYXJlbnQnKTtcclxuICAgICAgcGFyZW50RnJhbWVDb250ZXh0ID0gdGhpcy5nZXQocGFyZW50RnJhbWVDb250ZXh0LCAncGFyZW50Jyk7XHJcbiAgICAgIGlzRGlhbG9nQ29tcG9uZW50ID0gdGhpcy5nZXQoZnJhbWVDb250ZXh0LCAnZnJhbWVDb21wb25lbnQuaXNEaWFsb2dSb290Q29tcG9uZW50JywgZmFsc2UpO1xyXG4gICAgfVxyXG4gICAgcm9vdENvbXBvbmVudCA9IHRoaXMuZ2V0KGZyYW1lQ29udGV4dCwgJ2ZyYW1lQ29tcG9uZW50Jyk7XHJcbiAgICBpZiAoIWlzRGlhbG9nQ29tcG9uZW50KSB7XHJcbiAgICAgIGlzRGlhbG9nQ29tcG9uZW50ID0gdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PGJvb2xlYW4+KElOU0lERV9ESUFMT0dfVE9LRU4sIGZhbHNlKTtcclxuICAgICAgaWYgKGlzRGlhbG9nQ29tcG9uZW50KSB7XHJcbiAgICAgICAgY29uc3QgbW9kYWxSZWYgPSB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8QnNNb2RhbFJlZj4oTU9EQUxfUkVGLCBudWxsKTtcclxuICAgICAgICByb290Q29tcG9uZW50ID0geyBkaWFsb2dSZWY6IG1vZGFsUmVmIH07XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB7IGlzRGlhbG9nQ29tcG9uZW50LCByb290Q29tcG9uZW50IH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBsb2Fkc2ggZ2V0XHJcbiAgICogQHBhcmFtIG9iamVjdCDlr7nosaFcclxuICAgKiBAcGFyYW0gcGF0aCDot6/lvoRcclxuICAgKiBAcGFyYW0gZGVmYXVsdFZhbCDpu5jorqTlgLxcclxuICAgKi9cclxuICBwcml2YXRlIGdldChvYmplY3Q6IGFueSwgcGF0aDogQXJyYXk8c3RyaW5nPiB8IHN0cmluZywgZGVmYXVsdFZhbDogYW55ID0gbnVsbCkge1xyXG4gICAgY29uc3QgUEFUSCA9IEFycmF5LmlzQXJyYXkocGF0aClcclxuICAgICAgPyBwYXRoXHJcbiAgICAgIDogcGF0aC5zcGxpdCgnLicpLmZpbHRlcihpID0+IGkubGVuZ3RoKTtcclxuICAgIGlmICghUEFUSC5sZW5ndGgpIHtcclxuICAgICAgcmV0dXJuIG9iamVjdCA9PT0gdW5kZWZpbmVkID8gZGVmYXVsdFZhbCA6IG9iamVjdDtcclxuICAgIH1cclxuXHJcbiAgICBpZiAob2JqZWN0ID09PSBudWxsIHx8IG9iamVjdCA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiAob2JqZWN0W1BBVEhbMF1dKSA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgcmV0dXJuIGRlZmF1bHRWYWw7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuZ2V0KG9iamVjdFtQQVRILnNoaWZ0KCldLCBQQVRILCBkZWZhdWx0VmFsKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBjb252ZXJ0VG9Cb29sZWFuKHZhbHVlOiBhbnksIGRlZmF1bHRWYWw6IGJvb2xlYW4gPSBmYWxzZSkge1xyXG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgdmFsdWUgPT09IG51bGwpIHtcclxuICAgICAgdmFsdWUgPSBkZWZhdWx0VmFsO1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgdmFsdWUgPSB2YWx1ZSB8fCBTdHJpbmcoZGVmYXVsdFZhbCk7XHJcbiAgICAgIHZhbHVlID0gdmFsdWUgPT09ICd0cnVlJyA/IHRydWUgOiBmYWxzZTtcclxuICAgIH1cclxuICAgIHJldHVybiB2YWx1ZTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog57+76K+R6LWE5rqQ6aG5XHJcbiAgICogQHBhcmFtIGtleSDotYTmupDpoblrZXlcclxuICAgKi9cclxuICBwcml2YXRlIHRyYW5zbGF0ZShrZXk6IHN0cmluZykge1xyXG4gICAgY29uc3QgdHJhbnNsYXRlU2VydmljZSA9IHRoaXMuaW5qZWN0b3IgJiYgdGhpcy5pbmplY3Rvci5nZXQ8VHJhbnNsYXRlPihUcmFuc2xhdGVUb2tlbiwgbnVsbCkgfHwgbnVsbDtcclxuICAgIGlmICh0cmFuc2xhdGVTZXJ2aWNlICYmIGtleSAmJiBrZXkuc3RhcnRzV2l0aCgne3snKSAmJiBrZXkuZW5kc1dpdGgoJ319JykpIHtcclxuICAgICAga2V5ID0ga2V5LnJlcGxhY2UoJ3t7JywgJycpLnJlcGxhY2UoJ319JywgJycpLnRyaW0oKTtcclxuICAgICAgcmV0dXJuIHRyYW5zbGF0ZVNlcnZpY2UudHJhbnNmb3JtKGtleSwgbnVsbCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4ga2V5O1xyXG4gIH1cclxuICAvLyAjZW5kcmVnaW9uXHJcblxyXG4gIC8vI3JlZ2lvbiDlvLnnqpfnm7jlhbPmlrnms5VcclxuICBwcml2YXRlIGJ1aWxkQ29uZmlncyhjb25maWc6IGFueSk6IHsgW3Byb3A6IHN0cmluZ106IGFueSB9IHtcclxuICAgIGxldCBsYW5ndWFnZVNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldDxMYW5ndWFnZVNlcnZpY2U+KExhbmd1YWdlU2VydmljZSwgbnVsbCk7XHJcbiAgICBpZiAoIWxhbmd1YWdlU2VydmljZSkge1xyXG4gICAgICBsYW5ndWFnZVNlcnZpY2UgPSBMYW5ndWFnZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBkZWZhdWx0Q29uZmlnczogYW55ID0ge1xyXG4gICAgICB0aXRsZTogbGFuZ3VhZ2VTZXJ2aWNlICYmIGxhbmd1YWdlU2VydmljZS5kZWZhdWx0RGlhbG9nVGl0bGUgfHwgJycsXHJcbiAgICAgIHdpZHRoOiA4MDAsXHJcbiAgICAgIGhlaWdodDogNTAwLFxyXG4gICAgICBzaG93QnV0dG9uczogZmFsc2VcclxuICAgIH07XHJcbiAgICBjb25zdCBvYmplY3RUeXBlQ29uZmlnID0gdGhpcy5nZXRPYmplY3RUeXBlQ29uZmlnKGNvbmZpZyk7XHJcbiAgICBjb25zdCBjb25maWdzID0gT2JqZWN0LmFzc2lnbihkZWZhdWx0Q29uZmlncywgb2JqZWN0VHlwZUNvbmZpZyk7XHJcbiAgICBjb25zdCBvbkNsb3NpbmdIYW5kbGVyID0gY29uZmlncy5iZWZvcmVDbG9zZTtcclxuICAgIGNvbnN0IHJlZnJlc2ggPSBjb25maWdzWydyZWZyZXNoJ10gfHwge307XHJcbiAgICBjb25zdCByZWZyZXNoQ29tbWFuZE5hbWUgPSByZWZyZXNoICYmIHJlZnJlc2guY29tbWFuZE5hbWUgfHwgbnVsbDtcclxuICAgIGNvbnN0IHJlZnJlc2hGcmFtZUlkID0gcmVmcmVzaCAmJiByZWZyZXNoLmZyYW1lSWQgfHwgbnVsbDtcclxuICAgIC8vIHRzbGludDpkaXNhYmxlOiBuby1zdHJpbmctbGl0ZXJhbFxyXG4gICAgY29uc3QgY2FuY2VsQ2hhbmdlcyA9IGNvbmZpZ3NbJ2NhbmNlbENoYW5nZXMnXSB8fCBmYWxzZTtcclxuICAgIGNvbmZpZ3MuYmVmb3JlQ2xvc2UgPSAocmVmKSA9PiB7XHJcbiAgICAgIGlmICghIW9uQ2xvc2luZ0hhbmRsZXIgJiYgdHlwZW9mIG9uQ2xvc2luZ0hhbmRsZXIgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICByZXR1cm4gb25DbG9zaW5nSGFuZGxlcihyZWYpLnBpcGUoXHJcbiAgICAgICAgICBzd2l0Y2hNYXAocmVzdWx0ID0+IHtcclxuICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xyXG4gICAgICAgICAgICAgIGlmIChjYW5jZWxDaGFuZ2VzKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jYW5jZWxDaGFuZ2VzKHJlZikucGlwZShcclxuICAgICAgICAgICAgICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMucmVmcmVzaEZvcm0ocmVmcmVzaENvbW1hbmROYW1lLCByZWZyZXNoRnJhbWVJZCkpXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gb2YocmVzdWx0KTtcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoY2FuY2VsQ2hhbmdlcykge1xyXG4gICAgICAgICAgcmV0dXJuIHRoaXMuY2FuY2VsQ2hhbmdlcyhyZWYpLnBpcGUoXHJcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLnJlZnJlc2hGb3JtKHJlZnJlc2hDb21tYW5kTmFtZSwgcmVmcmVzaEZyYW1lSWQpKVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgIH07XHJcbiAgICByZXR1cm4gY29uZmlncztcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRPYmplY3RUeXBlQ29uZmlnKGNvbmZpZzogYW55KSB7XHJcbiAgICBsZXQgb2JqZWN0VHlwZUNvbmZpZzogYW55XHJcbiAgICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgY29uZmlnID0ge307XHJcbiAgICB9XHJcbiAgICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgaWYgKGNvbmZpZy5sZW5ndGgpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgb2JqZWN0VHlwZUNvbmZpZyA9IEpTT04ucGFyc2UoY29uZmlnKTtcclxuICAgICAgICB9IGNhdGNoIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihjb25maWcgKyAn5LiN5piv5ZCI5rOV55qEanNvbuWtl+espuS4sicpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBvYmplY3RUeXBlQ29uZmlnID0ge307XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAodHlwZW9mIGNvbmZpZyA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgb2JqZWN0VHlwZUNvbmZpZyA9IE9iamVjdC5hc3NpZ24oe30sIGNvbmZpZyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ+Whq+WGmeWvueixoeagvOW8j+aIlmpzb27lrZfnrKbkuLInKTtcclxuICAgIH1cclxuICAgIHJldHVybiBvYmplY3RUeXBlQ29uZmlnO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlj5bmtojmnI3liqHlmajlj5jmm7Tpm4ZcclxuICAgKi9cclxuICBwcml2YXRlIGNhbmNlbENoYW5nZXMocmVmOiBhbnkpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIGlmIChyZWYgJiYgcmVmLm1vZGFsUmVmICYmIHJlZi5tb2RhbFJlZi5jb250ZW50KSB7XHJcbiAgICAgIGNvbnN0IGNvbXBvbmVudDogRnJhbWVDb21wb25lbnQgPSByZWYubW9kYWxSZWYuY29udGVudCBhcyBGcmFtZUNvbXBvbmVudDtcclxuICAgICAgaWYgKGNvbXBvbmVudCAmJiBjb21wb25lbnQuY29udGV4dCkge1xyXG4gICAgICAgIGNvbnN0IHJlcG9zaXRvcnkgPSBjb21wb25lbnQuY29udGV4dC5yZXBvc2l0b3J5IHx8IG51bGw7XHJcbiAgICAgICAgaWYgKHJlcG9zaXRvcnkpIHtcclxuICAgICAgICAgIHJldHVybiByZXBvc2l0b3J5LmNhbmNlbENoYW5nZXMoKS5waXBlKHN3aXRjaE1hcCgoKSA9PiBvZih0cnVlKSkpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gIH1cclxuICBwcml2YXRlIHJlZnJlc2hGb3JtKHJlZnJlc2hDb21tYW5kTmFtZTogc3RyaW5nLCByZWZyZXNoRnJhbWVJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmIChyZWZyZXNoQ29tbWFuZE5hbWUgJiYgcmVmcmVzaEZyYW1lSWQpIHtcclxuICAgICAgY29uc3QgZnJhbWVDb250ZXh0ID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dEJ5SWQocmVmcmVzaEZyYW1lSWQpO1xyXG4gICAgICBpZiAoZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgY29uc3Qgdmlld01vZGVsID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbDtcclxuICAgICAgICByZXR1cm4gdmlld01vZGVsW3JlZnJlc2hDb21tYW5kTmFtZV0oKS5waXBlKFxyXG4gICAgICAgICAgbWFwKCgpID0+IHRydWUpXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gIH1cclxuICBwcml2YXRlIGNyZWF0ZUNvbXBvbmVudFJlZihjb21wb25lbnRUeXBlOiBhbnksIHVpU3RhdGVPYmplY3Q6IGFueSkge1xyXG4gICAgbGV0IGNvbXBvbmVudFJlZjogYW55O1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gdGhpcy5nZXRGcmFtZUNvbnRleHQoKTtcclxuICAgIGNvbnN0IGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlciA9IHRoaXMuZ2V0Q29tcG9uZW50RmFjdG9yeVJlc29sdmVyKCk7XHJcbiAgICBpZiAoZnJhbWVDb250ZXh0ICYmIGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlcikge1xyXG4gICAgICBjb25zdCBjb250ZW50Q21wdEZhY3RvcnkgPSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoY29tcG9uZW50VHlwZSk7XHJcbiAgICAgIGNvbnN0IG1vZGFsQ29udGVudEluamVjdG9yID0gUmVmbGVjdGl2ZUluamVjdG9yLnJlc29sdmVBbmRDcmVhdGUoW10sIGZyYW1lQ29udGV4dC5pbmplY3Rvcik7XHJcbiAgICAgIGNvbXBvbmVudFJlZiA9IGNvbnRlbnRDbXB0RmFjdG9yeS5jcmVhdGUobW9kYWxDb250ZW50SW5qZWN0b3IpO1xyXG4gICAgICBpZiAoY29tcG9uZW50UmVmICYmIGNvbXBvbmVudFJlZi5pbnN0YW5jZSAmJiBjb21wb25lbnRSZWYuaW5zdGFuY2Uudmlld01vZGVsICYmIGNvbXBvbmVudFJlZi5pbnN0YW5jZS52aWV3TW9kZWwudWlTdGF0ZSkge1xyXG4gICAgICAgIGlmICh0eXBlb2YgdWlTdGF0ZU9iamVjdCA9PT0gJ29iamVjdCcgJiYgT2JqZWN0LmtleXModWlTdGF0ZU9iamVjdCkubGVuZ3RoKSB7XHJcbiAgICAgICAgICBPYmplY3Qua2V5cyh1aVN0YXRlT2JqZWN0KS5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICBjb21wb25lbnRSZWYuaW5zdGFuY2Uudmlld01vZGVsLnVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZShpdGVtLCB1aVN0YXRlT2JqZWN0W2l0ZW1dKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDpmYTliqBpc0RpYWxvZ+WPguaVsFxyXG4gICAgICAgIGNvbXBvbmVudFJlZi5pbnN0YW5jZS52aWV3TW9kZWwudWlTdGF0ZS5zZXRQcm9wZXJ0eVZhbHVlKCdERVZLSVRfRElBTE9HJywgdHJ1ZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBjb21wb25lbnRSZWY7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWFvOWuueaXp+W8ueeql++8jOiOt+WPlmZyYW1lQ29udGV4dFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RnJhbWVDb250ZXh0KCkge1xyXG4gICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dFxyXG4gICAgfVxyXG4gICAgaWYgKHRoaXNbJ2NvbnRleHQnXSAmJiB0aGlzWydjb250ZXh0J11bJ2ZyYW1lQ29udGV4dCddKSB7XHJcbiAgICAgIHJldHVybiB0aGlzWydjb250ZXh0J11bJ2ZyYW1lQ29udGV4dCddO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWFvOWuueaXp+W8ueeql++8jOiOt+WPlkNvbXBvbmVudEZhY3RvcnlSZXNvbHZlclxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Q29tcG9uZW50RmFjdG9yeVJlc29sdmVyKCkge1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gdGhpcy5nZXRGcmFtZUNvbnRleHQoKTtcclxuICAgIGxldCBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IGFueTtcclxuICAgIGlmIChmcmFtZUNvbnRleHQpIHtcclxuICAgICAgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyID0gZnJhbWVDb250ZXh0LmluamVjdG9yLmdldChDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjtcclxuICB9XHJcbiAgLy8jZW5kcmVnaW9uXHJcbn1cclxuIl19