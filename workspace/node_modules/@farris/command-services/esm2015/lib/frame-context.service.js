import { Injectable, Injector } from "@angular/core";
import { AppContext, FrameContext, Repository } from "@farris/devkit";
import { BindingPathService } from "./binding-path.service";
import { FormControlService } from './form-control.service';
export class FrameContextService {
    constructor(injector, appContext, frameContext, repository, bindingPathService, formControlService) {
        this.injector = injector;
        this.appContext = appContext;
        this.frameContext = frameContext;
        this.repository = repository;
        this.bindingPathService = bindingPathService;
        this.formControlService = formControlService;
    }
    /**
       * 通过BE表名获取对应的frameContext
       * @param tableName
       * @returns
       */
    getFrameContextsByTableName(tableName) {
        if (!tableName) {
            throw new Error('tableName 不能为空。');
        }
        const dataTypeInfo = this.repository && this.repository.entityTypeInfo || null;
        if (!dataTypeInfo) {
            return null;
        }
        const bindingPaths = [];
        this.bindingPathService.getBindingPathsByTableName(dataTypeInfo, tableName, bindingPaths);
        const frameContexts = this.appContext && this.appContext.frameContextManager.getFrameContexts() || [];
        if (!frameContexts || frameContexts.length === 0) {
            return null;
        }
        return frameContexts.filter((frameContext) => frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(p => p).join('/') === bindingPaths.join('/'));
    }
    /**
     * 根据字段完整路径获取所在的上下文
     * @param propertyPath
     * @param separtor
     * @returns
     */
    getFrameContextsByPropertyPath(propertyPath, separtor = '/') {
        if (!propertyPath) {
            throw new Error('propertyPath 不能为空。');
        }
        const frameContexts = this.appContext && this.appContext.frameContextManager.getFrameContexts() || [];
        return frameContexts.filter((frameContext) => {
            const formControls = frameContext && frameContext.form && frameContext.form.ngFormControls || {};
            const bindingPath = frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath || '';
            if (formControls && Object.keys(formControls).length > 0) {
                const key = Object.keys(formControls).find((key) => {
                    const formControl = formControls[key];
                    if (!formControl || !formControl.binding) {
                        return false;
                    }
                    const bindings = formControl.binding.split('.').filter(p => p);
                    const bindingPaths = bindingPath.split('/').filter(p => p);
                    const fullPath = bindingPaths.concat(bindings);
                    return propertyPath.split(separtor).filter(p => p).join('/') === fullPath.join('/');
                });
                return key ? true : false;
            }
            return false;
        });
    }
    /**
     * 通过BE字段名获取字段的bindingPath
     * @param bindingPaths 绑定路径
     * @param columnName BE字段名
     * @returns
     */
    getFrameContextsByColumnName(bindingPaths, columnName) {
        if (!bindingPaths) {
            throw new Error('bindingPath 不能为空。');
        }
        if (!columnName) {
            throw new Error('columnName 不能为空。');
        }
        bindingPaths = bindingPaths.filter(p => p);
        const entityTypeInfo = this.repository && this.repository.entityTypeInfo || null;
        if (!entityTypeInfo) {
            return null;
        }
        const dataTypeInfo = entityTypeInfo.getTypeInfoByPath(bindingPaths);
        const dataPropInfos = dataTypeInfo && dataTypeInfo.getPropInfos() || [];
        const columnPropInfo = dataPropInfos.find((dataPropInfo) => dataPropInfo.metadataInfo && (dataPropInfo.metadataInfo.originalDataField === columnName || dataPropInfo.metadataInfo.dataField === columnName));
        if (!columnPropInfo || !columnPropInfo.metadataInfo) {
            return null;
        }
        const frameContexts = this.appContext.frameContextManager.getFrameContexts();
        return frameContexts.filter((frameContext) => {
            const ngFormControls = this.formControlService.getFormControlsByFrameContext(frameContext);
            if (!ngFormControls || Object.keys(ngFormControls).length < 1) {
                return false;
            }
            const currentBindingPaths = this.bindingPathService.getBindingPathsByFrameContext(frameContext) || [];
            const isValidFrameContext = currentBindingPaths.join('/') === bindingPaths.join('/');
            if (!isValidFrameContext) {
                return false;
            }
            const ngFormControl = Object.values(frameContext.viewModel.form.ngFormControls).find(item => item.binding === columnPropInfo.metadataInfo.path);
            return ngFormControl ? true : false;
        });
    }
    /**
     * 通过绑定路径获取对应的组件上下文数组
     * @param bindingPath bindingPath字符串
     * @param namespace ns,默认为''
     */
    getFrameContextsByBindingPath(bindingPath, namespace = '') {
        if (Array.isArray(bindingPath)) {
            bindingPath = bindingPath.join('/');
        }
        const frameContexts = this.appContext && this.appContext.frameContextManager.getFrameContexts() || [];
        return frameContexts.filter((frameContext) => frameContext && frameContext.namespace === namespace && frameContext.viewModel.bindingPath === bindingPath);
    }
}
FrameContextService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
FrameContextService.ctorParameters = () => [
    { type: Injector },
    { type: AppContext },
    { type: FrameContext },
    { type: Repository },
    { type: BindingPathService },
    { type: FormControlService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJhbWUtY29udGV4dC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2ZyYW1lLWNvbnRleHQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsVUFBVSxFQUF3QixZQUFZLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUYsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFHNUQsTUFBTSxPQUFPLG1CQUFtQjtJQUM5QixZQUNVLFFBQWtCLEVBQ2xCLFVBQXNCLEVBQ3RCLFlBQTBCLEVBQzFCLFVBQThCLEVBQzlCLGtCQUFzQyxFQUN0QyxrQkFBc0M7UUFMdEMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGVBQVUsR0FBVixVQUFVLENBQW9CO1FBQzlCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtJQUMxQyxDQUFDO0lBQ1A7Ozs7U0FJSztJQUNFLDJCQUEyQixDQUFDLFNBQWlCO1FBQ2xELElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDZCxNQUFNLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUM7U0FDcEM7UUFDRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsY0FBYyxJQUFJLElBQUksQ0FBQztRQUMvRSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ2pCLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxNQUFNLFlB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QUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFDdEcsT0FBTyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsWUFBMEIsRUFBRSxFQUFFLENBQUMsWUFBWSxJQUFJLFlBQVksQ0FBQyxTQUFTLEtBQUssU0FBUyxJQUFJLFlBQVksQ0FBQyxTQUFTLENBQUMsV0FBVyxLQUFLLFdBQVcsQ0FBQyxDQUFDO0lBQzFLLENBQUM7OztZQWhIRixVQUFVOzs7O1lBTFUsUUFBUTtZQUNwQixVQUFVO1lBQXdCLFlBQVk7WUFBRSxVQUFVO1lBQzFELGtCQUFrQjtZQUNsQixrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IEFwcENvbnRleHQsIERhdGFQcm9wSW5mbywgRW50aXR5LCBGcmFtZUNvbnRleHQsIFJlcG9zaXRvcnkgfSBmcm9tIFwiQGZhcnJpcy9kZXZraXRcIjtcclxuaW1wb3J0IHsgQmluZGluZ1BhdGhTZXJ2aWNlIH0gZnJvbSBcIi4vYmluZGluZy1wYXRoLnNlcnZpY2VcIjtcclxuaW1wb3J0IHsgRm9ybUNvbnRyb2xTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLWNvbnRyb2wuc2VydmljZSc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBGcmFtZUNvbnRleHRTZXJ2aWNlIHtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBcclxuICAgIHByaXZhdGUgYXBwQ29udGV4dDogQXBwQ29udGV4dCwgXHJcbiAgICBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBcclxuICAgIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxFbnRpdHk+LFxyXG4gICAgcHJpdmF0ZSBiaW5kaW5nUGF0aFNlcnZpY2U6IEJpbmRpbmdQYXRoU2VydmljZSxcclxuICAgIHByaXZhdGUgZm9ybUNvbnRyb2xTZXJ2aWNlOiBGb3JtQ29udHJvbFNlcnZpY2VcclxuICAgICkgeyB9XHJcbiAgLyoqXHJcbiAgICAgKiDpgJrov4dCReihqOWQjeiOt+WPluWvueW6lOeahGZyYW1lQ29udGV4dFxyXG4gICAgICogQHBhcmFtIHRhYmxlTmFtZSBcclxuICAgICAqIEByZXR1cm5zIFxyXG4gICAgICovXHJcbiAgcHVibGljIGdldEZyYW1lQ29udGV4dHNCeVRhYmxlTmFtZSh0YWJsZU5hbWU6IHN0cmluZyk6IG51bGwgfCBGcmFtZUNvbnRleHRbXSB7XHJcbiAgICBpZiAoIXRhYmxlTmFtZSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3RhYmxlTmFtZSDkuI3og73kuLrnqbrjgIInKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGRhdGFUeXBlSW5mbyA9IHRoaXMucmVwb3NpdG9yeSAmJiB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8gfHwgbnVsbDtcclxuICAgIGlmICghZGF0YVR5cGVJbmZvKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gW107XHJcbiAgICB0aGlzLmJpbmRpbmdQYXRoU2VydmljZS5nZXRCaW5kaW5nUGF0aHNCeVRhYmxlTmFtZShkYXRhVHlwZUluZm8sIHRhYmxlTmFtZSwgYmluZGluZ1BhdGhzKTtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dHMgPSB0aGlzLmFwcENvbnRleHQgJiYgdGhpcy5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpIHx8IFtdO1xyXG4gICAgaWYgKCFmcmFtZUNvbnRleHRzIHx8IGZyYW1lQ29udGV4dHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZyYW1lQ29udGV4dHMuZmlsdGVyKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLmpvaW4oJy8nKSA9PT0gYmluZGluZ1BhdGhzLmpvaW4oJy8nKSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOagueaNruWtl+auteWujOaVtOi3r+W+hOiOt+WPluaJgOWcqOeahOS4iuS4i+aWh1xyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eVBhdGggXHJcbiAgICogQHBhcmFtIHNlcGFydG9yIFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRGcmFtZUNvbnRleHRzQnlQcm9wZXJ0eVBhdGgocHJvcGVydHlQYXRoOiBzdHJpbmcsIHNlcGFydG9yOiBzdHJpbmcgPSAnLycpOiBGcmFtZUNvbnRleHRbXSB7XHJcbiAgICBpZiAoIXByb3BlcnR5UGF0aCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb3BlcnR5UGF0aCDkuI3og73kuLrnqbrjgIInKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dHMgPSB0aGlzLmFwcENvbnRleHQgJiYgdGhpcy5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpIHx8IFtdO1xyXG4gICAgcmV0dXJuIGZyYW1lQ29udGV4dHMuZmlsdGVyKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICBjb25zdCBmb3JtQ29udHJvbHMgPSBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LmZvcm0gJiYgZnJhbWVDb250ZXh0LmZvcm0ubmdGb3JtQ29udHJvbHMgfHwge307XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCB8fCAnJztcclxuICAgICAgaWYgKGZvcm1Db250cm9scyAmJiBPYmplY3Qua2V5cyhmb3JtQ29udHJvbHMpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb25zdCBrZXkgPSBPYmplY3Qua2V5cyhmb3JtQ29udHJvbHMpLmZpbmQoKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBmb3JtQ29udHJvbCA9IGZvcm1Db250cm9sc1trZXldO1xyXG4gICAgICAgICAgaWYgKCFmb3JtQ29udHJvbCB8fCAhZm9ybUNvbnRyb2wuYmluZGluZykge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjb25zdCBiaW5kaW5ncyA9IGZvcm1Db250cm9sLmJpbmRpbmcuc3BsaXQoJy4nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgICAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgICAgICBjb25zdCBmdWxsUGF0aCA9IGJpbmRpbmdQYXRocy5jb25jYXQoYmluZGluZ3MpO1xyXG4gICAgICAgICAgcmV0dXJuIHByb3BlcnR5UGF0aC5zcGxpdChzZXBhcnRvcikuZmlsdGVyKHAgPT4gcCkuam9pbignLycpID09PSBmdWxsUGF0aC5qb2luKCcvJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIGtleSA/IHRydWUgOiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6YCa6L+HQkXlrZfmrrXlkI3ojrflj5blrZfmrrXnmoRiaW5kaW5nUGF0aFxyXG4gICAqIEBwYXJhbSBiaW5kaW5nUGF0aHMg57uR5a6a6Lev5b6EXHJcbiAgICogQHBhcmFtIGNvbHVtbk5hbWUgQkXlrZfmrrXlkI1cclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RnJhbWVDb250ZXh0c0J5Q29sdW1uTmFtZShiaW5kaW5nUGF0aHM6IHN0cmluZ1tdLCBjb2x1bW5OYW1lOiBzdHJpbmcpOiBGcmFtZUNvbnRleHRbXSB8IG51bGwge1xyXG4gICAgaWYgKCFiaW5kaW5nUGF0aHMpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdiaW5kaW5nUGF0aCDkuI3og73kuLrnqbrjgIInKTtcclxuICAgIH1cclxuICAgIGlmICghY29sdW1uTmFtZSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NvbHVtbk5hbWUg5LiN6IO95Li656m644CCJyk7XHJcbiAgICB9XHJcbiAgICBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aHMuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICBjb25zdCBlbnRpdHlUeXBlSW5mbyA9IHRoaXMucmVwb3NpdG9yeSAmJiB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8gfHwgbnVsbDtcclxuICAgIGlmICghZW50aXR5VHlwZUluZm8pIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCBkYXRhVHlwZUluZm8gPSBlbnRpdHlUeXBlSW5mby5nZXRUeXBlSW5mb0J5UGF0aChiaW5kaW5nUGF0aHMpO1xyXG4gICAgY29uc3QgZGF0YVByb3BJbmZvcyA9IGRhdGFUeXBlSW5mbyAmJiBkYXRhVHlwZUluZm8uZ2V0UHJvcEluZm9zKCkgfHwgW107XHJcbiAgICBjb25zdCBjb2x1bW5Qcm9wSW5mbyA9IGRhdGFQcm9wSW5mb3MuZmluZCgoZGF0YVByb3BJbmZvOiBEYXRhUHJvcEluZm8pID0+IGRhdGFQcm9wSW5mby5tZXRhZGF0YUluZm8gJiYgKGRhdGFQcm9wSW5mby5tZXRhZGF0YUluZm8ub3JpZ2luYWxEYXRhRmllbGQgPT09IGNvbHVtbk5hbWUgfHwgZGF0YVByb3BJbmZvLm1ldGFkYXRhSW5mby5kYXRhRmllbGQgPT09IGNvbHVtbk5hbWUpKTtcclxuICAgIGlmICghY29sdW1uUHJvcEluZm8gfHwgIWNvbHVtblByb3BJbmZvLm1ldGFkYXRhSW5mbykge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dHMgPSB0aGlzLmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzKCk7XHJcbiAgICByZXR1cm4gZnJhbWVDb250ZXh0cy5maWx0ZXIoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgIGNvbnN0IG5nRm9ybUNvbnRyb2xzID0gdGhpcy5mb3JtQ29udHJvbFNlcnZpY2UuZ2V0Rm9ybUNvbnRyb2xzQnlGcmFtZUNvbnRleHQoZnJhbWVDb250ZXh0KTtcclxuICAgICAgaWYgKCFuZ0Zvcm1Db250cm9scyB8fCBPYmplY3Qua2V5cyhuZ0Zvcm1Db250cm9scykubGVuZ3RoIDwgMSkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBjdXJyZW50QmluZGluZ1BhdGhzID0gdGhpcy5iaW5kaW5nUGF0aFNlcnZpY2UuZ2V0QmluZGluZ1BhdGhzQnlGcmFtZUNvbnRleHQoZnJhbWVDb250ZXh0KSB8fCBbXTtcclxuICAgICAgY29uc3QgaXNWYWxpZEZyYW1lQ29udGV4dCA9IGN1cnJlbnRCaW5kaW5nUGF0aHMuam9pbignLycpID09PSBiaW5kaW5nUGF0aHMuam9pbignLycpO1xyXG4gICAgICBpZiAoIWlzVmFsaWRGcmFtZUNvbnRleHQpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgbmdGb3JtQ29udHJvbCA9IE9iamVjdC52YWx1ZXMoZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5mb3JtLm5nRm9ybUNvbnRyb2xzKS5maW5kKGl0ZW0gPT4gaXRlbS5iaW5kaW5nID09PSBjb2x1bW5Qcm9wSW5mby5tZXRhZGF0YUluZm8ucGF0aCk7XHJcbiAgICAgIHJldHVybiBuZ0Zvcm1Db250cm9sID8gdHJ1ZSA6IGZhbHNlO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIFxyXG4gIC8qKlxyXG4gICAqIOmAmui/h+e7keWumui3r+W+hOiOt+WPluWvueW6lOeahOe7hOS7tuS4iuS4i+aWh+aVsOe7hFxyXG4gICAqIEBwYXJhbSBiaW5kaW5nUGF0aCBiaW5kaW5nUGF0aOWtl+espuS4slxyXG4gICAqIEBwYXJhbSBuYW1lc3BhY2UgbnMs6buY6K6k5Li6JydcclxuICAgKi9cclxuICAgcHVibGljIGdldEZyYW1lQ29udGV4dHNCeUJpbmRpbmdQYXRoKGJpbmRpbmdQYXRoOiBzdHJpbmcgfCBzdHJpbmdbXSwgbmFtZXNwYWNlOiBzdHJpbmcgPSAnJyk6IEZyYW1lQ29udGV4dFtdIHtcclxuICAgIGlmIChBcnJheS5pc0FycmF5KGJpbmRpbmdQYXRoKSkge1xyXG4gICAgICBiaW5kaW5nUGF0aCA9IGJpbmRpbmdQYXRoLmpvaW4oJy8nKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dHMgPSB0aGlzLmFwcENvbnRleHQgJiYgdGhpcy5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpIHx8IFtdO1xyXG4gICAgcmV0dXJuIGZyYW1lQ29udGV4dHMuZmlsdGVyKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5uYW1lc3BhY2UgPT09IG5hbWVzcGFjZSAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoID09PSBiaW5kaW5nUGF0aCk7XHJcbiAgfVxyXG59Il19