import { Injectable, ElementRef } from '@angular/core';
import { Repository, FrameContext } from '@farris/devkit';
import { FrameContextService } from './frame-context.service';
import { FormControlService } from './form-control.service';
const FIXED_COLUMN_START_INDEX = 5000;
const GRID_COLUMN_START_INDEX = 10000;
/**
 * 表单验证服务
 * @scope FrameComponent
 */
class FocusInvalidService {
    /**
     * 构造函数
     */
    constructor(repository, frameContext, frameContextService, formControlService) {
        this.repository = repository;
        this.frameContext = frameContext;
        this.frameContextService = frameContextService;
        this.formControlService = formControlService;
    }
    /**
     * 向第一个验证不通过的字段设置焦点
     */
    focusInvalidInput(verifyInformations, rootElement) {
        // 无验证不通过信息时，直接返回。
        if (!verifyInformations || !verifyInformations.length) {
            return;
        }
        let targetField = null;
        const firstVerifyInformation = this.selectFirstVerifyInformation(verifyInformations, rootElement);
        if (firstVerifyInformation) {
            targetField = firstVerifyInformation.targetField;
            if (targetField) {
                const canFocus = this.focusElement(targetField, rootElement);
                if (canFocus) {
                    verifyInformations['focused'] = true;
                }
            }
        }
    }
    /**
     * 设置DataGrid单元格焦点
     */
    focusGridCell(verifyInformations, focusableDataGrid) {
        if (!verifyInformations || !verifyInformations.length || verifyInformations['focused'] == true || focusableDataGrid.disabled === true) {
            return;
        }
        let targetField = null;
        let targetId = null;
        const firstVerifyInformation = this.selectFirstVerifyInformation(verifyInformations);
        if (firstVerifyInformation) {
            targetField = firstVerifyInformation.targetField;
            targetId = firstVerifyInformation.id;
            verifyInformations['focused'] = true;
            focusableDataGrid.editCell(targetId, targetField);
        }
    }
    updateVerifyInformationsIndex(verifyInformations, rootElement) {
        verifyInformations = verifyInformations.filter((verifyInformation) => {
            const frameContexts = this.getFrameContextsByPropertyPath(verifyInformation.fullPath, '/');
            const frameContext = frameContexts && frameContexts.filter(frameContext => frameContext && frameContext.frameId === this.frameContext.frameId);
            return frameContext ? true : false;
        });
        return verifyInformations.map((verifyInformation) => {
            let tabIndex = -1;
            if (verifyInformation) {
                if (rootElement && verifyInformation.targetField) {
                    const input = this.getInputElementById(verifyInformation.targetField, rootElement);
                    tabIndex = input && input.getAttribute('tabindex') || -1;
                    tabIndex = Number(tabIndex);
                }
                // const frameContexts = this.getFrameContextsByPropertyPath(verifyInformation.fullPath, '/');
                const frameContext = this.frameContext; //frameContexts && frameContexts[0] || null;
                const frameIndex = frameContext.index + 1;
                verifyInformation.tabIndex = tabIndex;
                verifyInformation.domIndex = -1;
                verifyInformation.frameIndex = -1;
                verifyInformation.position = tabIndex;
                if (frameContext) {
                    const domIndex = verifyInformation.fullPath && this.getFieldIndex(frameContext, verifyInformation.fullPath) || 0;
                    if (domIndex > 0) {
                        const rowIndex = verifyInformation.index || 0;
                        verifyInformation.domIndex = domIndex;
                        verifyInformation.frameIndex = frameContext.index;
                        verifyInformation.position = tabIndex > 0 ? tabIndex : (frameIndex * 1000 + rowIndex * 1000 + domIndex);
                    }
                }
            }
            return verifyInformation;
        });
    }
    isGridComponent(frameContext) {
        if (frameContext) {
            const dataGridColumnsName = frameContext.viewModel['dataGridColumnsName'] || null;
            return dataGridColumnsName ? true : false;
        }
        return undefined;
    }
    getColumnIndex(frameContext, binding) {
        binding = binding.split('/').filter(p => p).join('/');
        const bindingPaths = frameContext.viewModel.bindingPath.split('/').filter(p => p);
        const dataGridColumnsName = frameContext.viewModel['dataGridColumnsName'] || null;
        const frameIndex = frameContext.index + 1;
        if (!dataGridColumnsName) {
            return undefined;
        }
        let columns = frameContext.viewModel[dataGridColumnsName];
        if (!columns || columns.length < 1) {
            return undefined;
        }
        // 打平columns
        columns = columns.reduce((results, item) => {
            if (Array.isArray(item)) {
                return results.concat(item);
            }
            return results.concat([item]);
        }, []);
        let position = -1;
        for (let index = 0; index < columns.length; index++) {
            const column = columns[index];
            const fields = column && column.field && column.field.split('.').filter(p => p) || null;
            if (!fields) {
                continue;
            }
            if (bindingPaths.concat(fields).join('/') === binding) {
                const fixed = column.fixed;
                if (fixed) {
                    const fixedColumns = columns.filter(item => item.fixed === fixed);
                    const fixedColumnIndex = this.getIndexFromColumns(fixedColumns, binding);
                    if (fixed === 'left') {
                        position = frameIndex * FIXED_COLUMN_START_INDEX + fixedColumnIndex;
                    }
                    else {
                        position = frameIndex * GRID_COLUMN_START_INDEX + 1000 + fixedColumnIndex;
                    }
                }
                else {
                    position = frameIndex * GRID_COLUMN_START_INDEX + index;
                }
                break;
            }
        }
        return position;
    }
    getIndexFromColumns(columns, binding) {
        const bindingPaths = this.frameContext.viewModel.bindingPath.split('/').filter(p => p);
        return columns.findIndex(column => {
            const fields = column && column.field && column.field.split('.').filter(p => p) || null;
            if (!fields) {
                return false;
            }
            if (bindingPaths.concat(fields).join('/') === binding) {
                return true;
            }
            return false;
        });
    }
    selectFirstVerifyInformation(verifyInformations, rootElement) {
        verifyInformations = this.updateVerifyInformationsIndex(verifyInformations, rootElement);
        verifyInformations.sort((v1, v2) => Number(v1.position) - Number(v2.position));
        return verifyInformations && verifyInformations.length > 0 && verifyInformations[0] || null;
    }
    getInputElementById(targetField, rootElement) {
        let element = rootElement.nativeElement.ownerDocument.getElementById(targetField) || null;
        if (element && element.tagName !== 'INPUT') {
            const inputs = element.getElementsByTagName('input');
            if (inputs.length) {
                element = inputs[0];
            }
        }
        return element;
    }
    getFrameContextsByPropertyPath(propertyPath, separtor = '/') {
        if (!propertyPath) {
            return [];
        }
        const frameContexts = this.frameContext && this.frameContext.appContext.frameContextManager.getFrameContexts() || [];
        return frameContexts.filter((frameContext) => {
            const formControls = frameContext && frameContext.form && frameContext.form.ngFormControls || {};
            const bindingPath = frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath || '';
            if (formControls && Object.keys(formControls).length > 0) {
                const key = Object.keys(formControls).find((key) => {
                    const formControl = formControls[key];
                    if (!formControl || !formControl.binding) {
                        return false;
                    }
                    const bindings = formControl.binding.split('.').filter(p => p);
                    const bindingPaths = bindingPath.split('/').filter(p => p);
                    const fullPath = bindingPaths.concat(bindings);
                    return propertyPath.split(separtor).filter(p => p).join('/') === fullPath.join('/');
                });
                return key ? true : false;
            }
            return false;
        });
    }
    getFormControlIndexByBindingPath(frameContext, binding) {
        const ngFormControls = this.getFormControlsByFrameContext(frameContext);
        if (!ngFormControls) {
            return null;
        }
        const bindings = binding.split('/').filter(p => p);
        return Object.values(ngFormControls).findIndex((ngFormControl) => {
            if (!ngFormControl) {
                return false;
            }
            const bindingPath = frameContext.viewModel.bindingPath;
            const bindingPaths = bindingPath.split('/').filter(p => p);
            const formControlBindingPaths = ngFormControl.binding.split('.').filter(p => p);
            const fullPath = bindingPaths.concat(formControlBindingPaths);
            return fullPath.join('/') === bindings.join('/');
        });
    }
    getFieldIndex(frameContext, binding) {
        const isGridComponent = this.isGridComponent(frameContext);
        if (isGridComponent) {
            return this.getColumnIndex(frameContext, binding);
        }
        else {
            return this.getFormControlIndexByBindingPath(frameContext, binding);
        }
    }
    getFormControlsByFrameContext(frameContext) {
        return frameContext && frameContext.form && frameContext.form.ngFormControls || null;
    }
    focusElement(elementId, rootElement) {
        let focused = false;
        let elementToFocus = rootElement.nativeElement.ownerDocument.getElementById(elementId);
        // 未获取到指定字段时，返回，不再设置焦点。
        if (elementToFocus) {
            // 如果有多个id重复的元素，则不定位
            const elements = rootElement.nativeElement.ownerDocument.querySelectorAll(`#${elementId}`);
            if (elements && elements.length > 1) {
                return focused;
            }
            // 如果绑定目标字段的控件不是Input元素，则查找其下级节点。
            if (elementToFocus.tagName !== 'INPUT') {
                const subElements = elementToFocus.getElementsByTagName('input');
                if (subElements.length) {
                    elementToFocus = subElements[0];
                }
            }
            elementToFocus.focus();
            focused = true;
        }
        return focused;
    }
    /**
     * 设置焦点
     * @param verifyInformation 错误信息
     * @param frameContext 上下文
     * @returns
     */
    focus(verifyInformation, frameContext) {
        if (!verifyInformation) {
            return;
        }
        const isGridValidation = verifyInformation.index !== null;
        if (isGridValidation) {
            const grid = this.getGridRef(frameContext);
            if (grid) {
                setTimeout(() => {
                    grid.editCell(verifyInformation.id, verifyInformation.targetField);
                }, 0);
            }
        }
        else {
            const frameElement = this.getComponentRef(frameContext);
            const elementId = verifyInformation.targetField;
            this.focusById(elementId, frameElement);
        }
    }
    /**
     * 通过控件id设置焦点
     * @param elementId
     * @param elementRef
     */
    focusById(elementId, elementRef) {
        const document = elementRef && elementRef.nativeElement.ownerDocument || window.document;
        if (document) {
            const element = document.getElementById(elementId);
            if (element.tagName !== 'INPUT') {
                const subElements = element.getElementsByTagName('input');
                if (subElements.length) {
                    const input = subElements[0];
                    if (input && typeof input.focus === 'function') {
                        input.focus();
                    }
                }
            }
            else {
                element.focus();
            }
        }
    }
    /**
     * 获取组件实例
     * @param frameContext
     * @returns
     */
    getComponentRef(frameContext) {
        return this.frameContext && this.frameContext.injector.get(ElementRef, null) || null;
    }
    /**
     * 获取grid实例
     * @param frameContext frameContext
     * @returns
     */
    getGridRef(frameContext) {
        const namespace = frameContext.namespace;
        const bindingPath = frameContext.viewModel.bindingPath;
        const frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace) || [];
        const matchedFrameContexts = frameContexts.filter((frameContext) => frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(p => p).toString() === bindingPath.split('/').filter(p => p).toString());
        let result = null;
        if (matchedFrameContexts) {
            matchedFrameContexts.every((frameContext) => {
                const frameId = frameContext.frameId;
                const componentsMap = this.frameContext.appContext.componentManager.getComponentsByFrameId(frameId);
                if (!componentsMap) {
                    return true;
                }
                const datagridComponent = Array.from(componentsMap.values()).find((component) => component && component['__component_type__'] === 'DatagridComponent');
                if (datagridComponent) {
                    result = datagridComponent;
                    return false;
                }
                else {
                    return true;
                }
            });
        }
        return result;
    }
}
FocusInvalidService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
FocusInvalidService.ctorParameters = () => [
    { type: Repository },
    { type: FrameContext },
    { type: FrameContextService },
    { type: FormControlService }
];
export { FocusInvalidService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9jdXMtaW52YWxpZC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2ZvY3VzLWludmFsaWQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RCxPQUFPLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBaUIsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUU1RCxNQUFNLHdCQUF3QixHQUFHLElBQUksQ0FBQztBQUN0QyxNQUFNLHVCQUF1QixHQUFHLEtBQUssQ0FBQztBQU10Qzs7O0dBR0c7QUFDSCxNQUNNLG1CQUFtQjtJQUN2Qjs7T0FFRztJQUNILFlBQ1UsVUFBMkIsRUFDM0IsWUFBMEIsRUFDMUIsbUJBQXdDLEVBQ3hDLGtCQUFzQztRQUh0QyxlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7SUFFaEQsQ0FBQztJQUVEOztPQUVHO0lBQ0ksaUJBQWlCLENBQUMsa0JBQXlCLEVBQUUsV0FBNEI7UUFDOUUsa0JBQWtCO1FBQ2xCLElBQUksQ0FBQyxrQkFBa0IsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sRUFBRTtZQUNyRCxPQUFPO1NBQ1I7UUFDRCxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDdkIsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLENBQUMsNEJBQTRCLENBQUMsa0JBQWtCLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDbEcsSUFBSSxzQkFBc0IsRUFBRTtZ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Q0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLFNBQWMsRUFBRSxFQUFFLENBQUMsU0FBUyxJQUFJLFNBQVMsQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLG1CQUFtQixDQUFDLENBQUM7Z0JBQzVKLElBQUksaUJBQWlCLEVBQUU7b0JBQ3JCLE1BQU0sR0FBRyxpQkFBaUIsQ0FBQztvQkFDM0IsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7cUJBQU07b0JBQ0wsT0FBTyxJQUFJLENBQUM7aUJBQ2I7WUFDSCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQzs7O1lBalVGLFVBQVU7Ozs7WUFmRixVQUFVO1lBQUUsWUFBWTtZQUN4QixtQkFBbUI7WUFDbkIsa0JBQWtCOztBQWlWM0IsT0FBTyxFQUE2QixtQkFBbUIsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgRWxlbWVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5LCBGcmFtZUNvbnRleHQsIE5nRm9ybUNvbnRyb2wgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IEZyYW1lQ29udGV4dFNlcnZpY2UgfSBmcm9tICcuL2ZyYW1lLWNvbnRleHQuc2VydmljZSc7XHJcbmltcG9ydCB7IEZvcm1Db250cm9sU2VydmljZSB9IGZyb20gJy4vZm9ybS1jb250cm9sLnNlcnZpY2UnO1xyXG5cclxuY29uc3QgRklYRURfQ09MVU1OX1NUQVJUX0lOREVYID0gNTAwMDtcclxuY29uc3QgR1JJRF9DT0xVTU5fU1RBUlRfSU5ERVggPSAxMDAwMDtcclxuaW50ZXJmYWNlIEZvY3VzYWJsZUludmFsaWRhdGlvbkdyaWQge1xyXG4gIGVkaXRDZWxsKHJvd0lkOiBhbnksIGZpZWxkOiBzdHJpbmcpOiB2b2lkO1xyXG4gIGRpc2FibGVkOiBib29sZWFuO1xyXG59XHJcblxyXG4vKipcclxuICog6KGo5Y2V6aqM6K+B5pyN5YqhXHJcbiAqIEBzY29wZSBGcmFtZUNvbXBvbmVudFxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5jbGFzcyBGb2N1c0ludmFsaWRTZXJ2aWNlIHtcclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+LFxyXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCxcclxuICAgIHByaXZhdGUgZnJhbWVDb250ZXh0U2VydmljZTogRnJhbWVDb250ZXh0U2VydmljZSxcclxuICAgIHByaXZhdGUgZm9ybUNvbnRyb2xTZXJ2aWNlOiBGb3JtQ29udHJvbFNlcnZpY2VcclxuICApIHtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWQkeesrOS4gOS4qumqjOivgeS4jemAmui/h+eahOWtl+auteiuvue9rueEpueCuVxyXG4gICAqL1xyXG4gIHB1YmxpYyBmb2N1c0ludmFsaWRJbnB1dCh2ZXJpZnlJbmZvcm1hdGlvbnM6IGFueVtdLCByb290RWxlbWVudDogRWxlbWVudFJlZjxhbnk+KSB7XHJcbiAgICAvLyDml6Dpqozor4HkuI3pgJrov4fkv6Hmga/ml7bvvIznm7TmjqXov5Tlm57jgIJcclxuICAgIGlmICghdmVyaWZ5SW5mb3JtYXRpb25zIHx8ICF2ZXJpZnlJbmZvcm1hdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGxldCB0YXJnZXRGaWVsZCA9IG51bGw7XHJcbiAgICBjb25zdCBmaXJzdFZlcmlmeUluZm9ybWF0aW9uID0gdGhpcy5zZWxlY3RGaXJzdFZlcmlmeUluZm9ybWF0aW9uKHZlcmlmeUluZm9ybWF0aW9ucywgcm9vdEVsZW1lbnQpO1xyXG4gICAgaWYgKGZpcnN0VmVyaWZ5SW5mb3JtYXRpb24pIHtcclxuICAgICAgdGFyZ2V0RmllbGQgPSBmaXJzdFZlcmlmeUluZm9ybWF0aW9uLnRhcmdldEZpZWxkO1xyXG4gICAgICBpZiAodGFyZ2V0RmllbGQpIHtcclxuICAgICAgICBjb25zdCBjYW5Gb2N1cyA9IHRoaXMuZm9jdXNFbGVtZW50KHRhcmdldEZpZWxkLCByb290RWxlbWVudCk7XHJcbiAgICAgICAgaWYgKGNhbkZvY3VzKSB7XHJcbiAgICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbnNbJ2ZvY3VzZWQnXSA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDorr7nva5EYXRhR3JpZOWNleWFg+agvOeEpueCuVxyXG4gICAqL1xyXG4gIHB1YmxpYyBmb2N1c0dyaWRDZWxsKHZlcmlmeUluZm9ybWF0aW9uczogYW55W10sIGZvY3VzYWJsZURhdGFHcmlkOiBGb2N1c2FibGVJbnZhbGlkYXRpb25HcmlkKSB7XHJcbiAgICBpZiAoIXZlcmlmeUluZm9ybWF0aW9ucyB8fCAhdmVyaWZ5SW5mb3JtYXRpb25zLmxlbmd0aCB8fCB2ZXJpZnlJbmZvcm1hdGlvbnNbJ2ZvY3VzZWQnXSA9PSB0cnVlIHx8IGZvY3VzYWJsZURhdGFHcmlkLmRpc2FibGVkID09PSB0cnVlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGxldCB0YXJnZXRGaWVsZCA9IG51bGw7XHJcbiAgICBsZXQgdGFyZ2V0SWQgPSBudWxsO1xyXG4gICAgY29uc3QgZmlyc3RWZXJpZnlJbmZvcm1hdGlvbiA9IHRoaXMuc2VsZWN0Rmlyc3RWZXJpZnlJbmZvcm1hdGlvbih2ZXJpZnlJbmZvcm1hdGlvbnMpO1xyXG4gICAgaWYgKGZpcnN0VmVyaWZ5SW5mb3JtYXRpb24pIHtcclxuICAgICAgdGFyZ2V0RmllbGQgPSBmaXJzdFZlcmlmeUluZm9ybWF0aW9uLnRhcmdldEZpZWxkO1xyXG4gICAgICB0YXJnZXRJZCA9IGZpcnN0VmVyaWZ5SW5mb3JtYXRpb24uaWQ7XHJcbiAgICAgIHZlcmlmeUluZm9ybWF0aW9uc1snZm9jdXNlZCddID0gdHJ1ZTtcclxuICAgICAgZm9jdXNhYmxlRGF0YUdyaWQuZWRpdENlbGwodGFyZ2V0SWQsIHRhcmdldEZpZWxkKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSB1cGRhdGVWZXJpZnlJbmZvcm1hdGlvbnNJbmRleCh2ZXJpZnlJbmZvcm1hdGlvbnM6IGFueVtdLCByb290RWxlbWVudD86IEVsZW1lbnRSZWY8YW55Pikge1xyXG4gICAgdmVyaWZ5SW5mb3JtYXRpb25zID0gdmVyaWZ5SW5mb3JtYXRpb25zLmZpbHRlcigodmVyaWZ5SW5mb3JtYXRpb246IGFueSkgPT4ge1xyXG4gICAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gdGhpcy5nZXRGcmFtZUNvbnRleHRzQnlQcm9wZXJ0eVBhdGgodmVyaWZ5SW5mb3JtYXRpb24uZnVsbFBhdGgsICcvJyk7XHJcbiAgICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dHMgJiYgZnJhbWVDb250ZXh0cy5maWx0ZXIoZnJhbWVDb250ZXh0ID0+IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQuZnJhbWVJZCA9PT0gdGhpcy5mcmFtZUNvbnRleHQuZnJhbWVJZCk7XHJcbiAgICAgIHJldHVybiBmcmFtZUNvbnRleHQgPyB0cnVlIDogZmFsc2U7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB2ZXJpZnlJbmZvcm1hdGlvbnMubWFwKCh2ZXJpZnlJbmZvcm1hdGlvbjogYW55KSA9PiB7XHJcbiAgICAgIGxldCB0YWJJbmRleCA9IC0xO1xyXG4gICAgICBpZiAodmVyaWZ5SW5mb3JtYXRpb24pIHtcclxuICAgICAgICBpZiAocm9vdEVsZW1lbnQgJiYgdmVyaWZ5SW5mb3JtYXRpb24udGFyZ2V0RmllbGQpIHtcclxuICAgICAgICAgIGNvbnN0IGlucHV0ID0gdGhpcy5nZXRJbnB1dEVsZW1lbnRCeUlkKHZlcmlmeUluZm9ybWF0aW9uLnRhcmdldEZpZWxkLCByb290RWxlbWVudCk7XHJcbiAgICAgICAgICB0YWJJbmRleCA9IGlucHV0ICYmIGlucHV0LmdldEF0dHJpYnV0ZSgndGFiaW5kZXgnKSB8fCAtMTtcclxuICAgICAgICAgIHRhYkluZGV4ID0gTnVtYmVyKHRhYkluZGV4KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gY29uc3QgZnJhbWVDb250ZXh0cyA9IHRoaXMuZ2V0RnJhbWVDb250ZXh0c0J5UHJvcGVydHlQYXRoKHZlcmlmeUluZm9ybWF0aW9uLmZ1bGxQYXRoLCAnLycpO1xyXG4gICAgICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuZnJhbWVDb250ZXh0Oy8vZnJhbWVDb250ZXh0cyAmJiBmcmFtZUNvbnRleHRzWzBdIHx8IG51bGw7XHJcbiAgICAgICAgY29uc3QgZnJhbWVJbmRleCA9IGZyYW1lQ29udGV4dC5pbmRleCArIDE7XHJcbiAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb24udGFiSW5kZXggPSB0YWJJbmRleDtcclxuICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbi5kb21JbmRleCA9IC0xO1xyXG4gICAgICAgIHZlcmlmeUluZm9ybWF0aW9uLmZyYW1lSW5kZXggPSAtMTtcclxuICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbi5wb3NpdGlvbiA9IHRhYkluZGV4O1xyXG4gICAgICAgIGlmIChmcmFtZUNvbnRleHQpIHtcclxuICAgICAgICAgIGNvbnN0IGRvbUluZGV4ID0gdmVyaWZ5SW5mb3JtYXRpb24uZnVsbFBhdGggJiYgdGhpcy5nZXRGaWVsZEluZGV4KGZyYW1lQ29udGV4dCwgdmVyaWZ5SW5mb3JtYXRpb24uZnVsbFBhdGgpIHx8IDA7XHJcbiAgICAgICAgICBpZiAoZG9tSW5kZXggPiAwKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJvd0luZGV4ID0gdmVyaWZ5SW5mb3JtYXRpb24uaW5kZXggfHwgMDtcclxuICAgICAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb24uZG9tSW5kZXggPSBkb21JbmRleDtcclxuICAgICAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb24uZnJhbWVJbmRleCA9IGZyYW1lQ29udGV4dC5pbmRleDtcclxuICAgICAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb24ucG9zaXRpb24gPSB0YWJJbmRleCA+IDAgPyB0YWJJbmRleCA6IChmcmFtZUluZGV4ICogMTAwMCArIHJvd0luZGV4ICogMTAwMCArIGRvbUluZGV4KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHZlcmlmeUluZm9ybWF0aW9uO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgaXNHcmlkQ29tcG9uZW50KGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSB7XHJcbiAgICBpZiAoZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIGNvbnN0IGRhdGFHcmlkQ29sdW1uc05hbWUgPSBmcmFtZUNvbnRleHQudmlld01vZGVsWydkYXRhR3JpZENvbHVtbnNOYW1lJ10gfHwgbnVsbDtcclxuICAgICAgcmV0dXJuIGRhdGFHcmlkQ29sdW1uc05hbWUgPyB0cnVlIDogZmFsc2U7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIH1cclxuICBwcml2YXRlIGdldENvbHVtbkluZGV4KGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBiaW5kaW5nOiBzdHJpbmcpIHtcclxuICAgIGJpbmRpbmcgPSBiaW5kaW5nLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkuam9pbignLycpO1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgY29uc3QgZGF0YUdyaWRDb2x1bW5zTmFtZSA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWxbJ2RhdGFHcmlkQ29sdW1uc05hbWUnXSB8fCBudWxsO1xyXG4gICAgY29uc3QgZnJhbWVJbmRleCA9IGZyYW1lQ29udGV4dC5pbmRleCArIDE7XHJcbiAgICBpZiAoIWRhdGFHcmlkQ29sdW1uc05hbWUpIHtcclxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgIH1cclxuICAgIGxldCBjb2x1bW5zOiBhbnlbXSA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWxbZGF0YUdyaWRDb2x1bW5zTmFtZV07XHJcbiAgICBpZiAoIWNvbHVtbnMgfHwgY29sdW1ucy5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbiAgICAvLyDmiZPlubNjb2x1bW5zXHJcbiAgICBjb2x1bW5zID0gY29sdW1ucy5yZWR1Y2UoKHJlc3VsdHM6IGFueVtdLCBpdGVtKSA9PiB7XHJcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGl0ZW0pKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdHMuY29uY2F0KGl0ZW0pO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiByZXN1bHRzLmNvbmNhdChbaXRlbV0pO1xyXG4gICAgfSwgW10pO1xyXG4gICAgbGV0IHBvc2l0aW9uID0gLTE7XHJcbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgY29sdW1ucy5sZW5ndGg7IGluZGV4KyspIHtcclxuICAgICAgY29uc3QgY29sdW1uOiBhbnkgfCBhbnlbXSA9IGNvbHVtbnNbaW5kZXhdO1xyXG4gICAgICBjb25zdCBmaWVsZHMgPSBjb2x1bW4gJiYgY29sdW1uLmZpZWxkICYmIGNvbHVtbi5maWVsZC5zcGxpdCgnLicpLmZpbHRlcihwID0+IHApIHx8IG51bGw7XHJcbiAgICAgIGlmICghZmllbGRzKSB7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGJpbmRpbmdQYXRocy5jb25jYXQoZmllbGRzKS5qb2luKCcvJykgPT09IGJpbmRpbmcpIHtcclxuICAgICAgICBjb25zdCBmaXhlZCA9IGNvbHVtbi5maXhlZDtcclxuICAgICAgICBpZiAoZml4ZWQpIHtcclxuICAgICAgICAgIGNvbnN0IGZpeGVkQ29sdW1ucyA9IGNvbHVtbnMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5maXhlZCA9PT0gZml4ZWQpO1xyXG4gICAgICAgICAgY29uc3QgZml4ZWRDb2x1bW5JbmRleCA9IHRoaXMuZ2V0SW5kZXhGcm9tQ29sdW1ucyhmaXhlZENvbHVtbnMsIGJpbmRpbmcpO1xyXG4gICAgICAgICAgaWYgKGZpeGVkID09PSAnbGVmdCcpIHtcclxuICAgICAgICAgICAgcG9zaXRpb24gPSBmcmFtZUluZGV4ICogRklYRURfQ09MVU1OX1NUQVJUX0lOREVYICsgZml4ZWRDb2x1bW5JbmRleDtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHBvc2l0aW9uID0gZnJhbWVJbmRleCAqIEdSSURfQ09MVU1OX1NUQVJUX0lOREVYICsgMTAwMCArIGZpeGVkQ29sdW1uSW5kZXg7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHBvc2l0aW9uID0gZnJhbWVJbmRleCAqIEdSSURfQ09MVU1OX1NUQVJUX0lOREVYICsgaW5kZXg7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcG9zaXRpb247XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0SW5kZXhGcm9tQ29sdW1ucyhjb2x1bW5zOiBhbnlbXSwgYmluZGluZzogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSB0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgIHJldHVybiBjb2x1bW5zLmZpbmRJbmRleChjb2x1bW4gPT4ge1xyXG4gICAgICBjb25zdCBmaWVsZHMgPSBjb2x1bW4gJiYgY29sdW1uLmZpZWxkICYmIGNvbHVtbi5maWVsZC5zcGxpdCgnLicpLmZpbHRlcihwID0+IHApIHx8IG51bGw7XHJcbiAgICAgIGlmICghZmllbGRzKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChiaW5kaW5nUGF0aHMuY29uY2F0KGZpZWxkcykuam9pbignLycpID09PSBiaW5kaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgc2VsZWN0Rmlyc3RWZXJpZnlJbmZvcm1hdGlvbih2ZXJpZnlJbmZvcm1hdGlvbnM6IGFueVtdLCByb290RWxlbWVudD86IEVsZW1lbnRSZWY8YW55Pikge1xyXG4gICAgdmVyaWZ5SW5mb3JtYXRpb25zID0gdGhpcy51cGRhdGVWZXJpZnlJbmZvcm1hdGlvbnNJbmRleCh2ZXJpZnlJbmZvcm1hdGlvbnMsIHJvb3RFbGVtZW50KTtcclxuICAgIHZlcmlmeUluZm9ybWF0aW9ucy5zb3J0KCh2MTogYW55LCB2MjogYW55KSA9PiBOdW1iZXIodjEucG9zaXRpb24pIC0gTnVtYmVyKHYyLnBvc2l0aW9uKSk7XHJcbiAgICByZXR1cm4gdmVyaWZ5SW5mb3JtYXRpb25zICYmIHZlcmlmeUluZm9ybWF0aW9ucy5sZW5ndGggPiAwICYmIHZlcmlmeUluZm9ybWF0aW9uc1swXSB8fCBudWxsO1xyXG4gIH1cclxuICBwcml2YXRlIGdldElucHV0RWxlbWVudEJ5SWQodGFyZ2V0RmllbGQ6IHN0cmluZywgcm9vdEVsZW1lbnQ6IEVsZW1lbnRSZWY8YW55Pikge1xyXG4gICAgbGV0IGVsZW1lbnQgPSByb290RWxlbWVudC5uYXRpdmVFbGVtZW50Lm93bmVyRG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGFyZ2V0RmllbGQpIHx8IG51bGw7XHJcbiAgICBpZiAoZWxlbWVudCAmJiBlbGVtZW50LnRhZ05hbWUgIT09ICdJTlBVVCcpIHtcclxuICAgICAgY29uc3QgaW5wdXRzID0gZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaW5wdXQnKTtcclxuICAgICAgaWYgKGlucHV0cy5sZW5ndGgpIHtcclxuICAgICAgICBlbGVtZW50ID0gaW5wdXRzWzBdO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZWxlbWVudDtcclxuICB9XHJcbiAgcHVibGljIGdldEZyYW1lQ29udGV4dHNCeVByb3BlcnR5UGF0aChwcm9wZXJ0eVBhdGg6IHN0cmluZywgc2VwYXJ0b3I6IHN0cmluZyA9ICcvJyk6IEZyYW1lQ29udGV4dFtdIHtcclxuICAgIGlmICghcHJvcGVydHlQYXRoKSB7XHJcbiAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dHMgPSB0aGlzLmZyYW1lQ29udGV4dCAmJiB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpIHx8IFtdO1xyXG4gICAgcmV0dXJuIGZyYW1lQ29udGV4dHMuZmlsdGVyKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICBjb25zdCBmb3JtQ29udHJvbHMgPSBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LmZvcm0gJiYgZnJhbWVDb250ZXh0LmZvcm0ubmdGb3JtQ29udHJvbHMgfHwge307XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCB8fCAnJztcclxuICAgICAgaWYgKGZvcm1Db250cm9scyAmJiBPYmplY3Qua2V5cyhmb3JtQ29udHJvbHMpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb25zdCBrZXkgPSBPYmplY3Qua2V5cyhmb3JtQ29udHJvbHMpLmZpbmQoKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBmb3JtQ29udHJvbCA9IGZvcm1Db250cm9sc1trZXldO1xyXG4gICAgICAgICAgaWYgKCFmb3JtQ29udHJvbCB8fCAhZm9ybUNvbnRyb2wuYmluZGluZykge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjb25zdCBiaW5kaW5ncyA9IGZvcm1Db250cm9sLmJpbmRpbmcuc3BsaXQoJy4nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgICAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgICAgICBjb25zdCBmdWxsUGF0aCA9IGJpbmRpbmdQYXRocy5jb25jYXQoYmluZGluZ3MpO1xyXG4gICAgICAgICAgcmV0dXJuIHByb3BlcnR5UGF0aC5zcGxpdChzZXBhcnRvcikuZmlsdGVyKHAgPT4gcCkuam9pbignLycpID09PSBmdWxsUGF0aC5qb2luKCcvJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIGtleSA/IHRydWUgOiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHVibGljIGdldEZvcm1Db250cm9sSW5kZXhCeUJpbmRpbmdQYXRoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBiaW5kaW5nOiBzdHJpbmcpOiBudW1iZXIge1xyXG4gICAgY29uc3QgbmdGb3JtQ29udHJvbHMgPSB0aGlzLmdldEZvcm1Db250cm9sc0J5RnJhbWVDb250ZXh0KGZyYW1lQ29udGV4dCk7XHJcbiAgICBpZiAoIW5nRm9ybUNvbnRyb2xzKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgYmluZGluZ3MgPSBiaW5kaW5nLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyhuZ0Zvcm1Db250cm9scykuZmluZEluZGV4KChuZ0Zvcm1Db250cm9sOiBOZ0Zvcm1Db250cm9sKSA9PiB7XHJcbiAgICAgIGlmICghbmdGb3JtQ29udHJvbCkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBiaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGg7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgIGNvbnN0IGZvcm1Db250cm9sQmluZGluZ1BhdGhzID0gbmdGb3JtQ29udHJvbC5iaW5kaW5nLnNwbGl0KCcuJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgIGNvbnN0IGZ1bGxQYXRoID0gYmluZGluZ1BhdGhzLmNvbmNhdChmb3JtQ29udHJvbEJpbmRpbmdQYXRocyk7XHJcbiAgICAgIHJldHVybiBmdWxsUGF0aC5qb2luKCcvJykgPT09IGJpbmRpbmdzLmpvaW4oJy8nKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwdWJsaWMgZ2V0RmllbGRJbmRleChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgYmluZGluZzogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBpc0dyaWRDb21wb25lbnQgPSB0aGlzLmlzR3JpZENvbXBvbmVudChmcmFtZUNvbnRleHQpO1xyXG4gICAgaWYgKGlzR3JpZENvbXBvbmVudCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5nZXRDb2x1bW5JbmRleChmcmFtZUNvbnRleHQsIGJpbmRpbmcpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZ2V0Rm9ybUNvbnRyb2xJbmRleEJ5QmluZGluZ1BhdGgoZnJhbWVDb250ZXh0LCBiaW5kaW5nKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHVibGljIGdldEZvcm1Db250cm9sc0J5RnJhbWVDb250ZXh0KGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KTogeyBbcHJvcGVydHlOYW1lOiBzdHJpbmddOiBOZ0Zvcm1Db250cm9sIH0gfCBudWxsIHtcclxuICAgIHJldHVybiBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LmZvcm0gJiYgZnJhbWVDb250ZXh0LmZvcm0ubmdGb3JtQ29udHJvbHMgfHwgbnVsbDtcclxuICB9XHJcbiAgcHVibGljIGZvY3VzRWxlbWVudChlbGVtZW50SWQ6IHN0cmluZywgcm9vdEVsZW1lbnQ6IEVsZW1lbnRSZWY8YW55Pik6IGJvb2xlYW4ge1xyXG4gICAgbGV0IGZvY3VzZWQgPSBmYWxzZTtcclxuICAgIGxldCBlbGVtZW50VG9Gb2N1cyA9IHJvb3RFbGVtZW50Lm5hdGl2ZUVsZW1lbnQub3duZXJEb2N1bWVudC5nZXRFbGVtZW50QnlJZChlbGVtZW50SWQpO1xyXG4gICAgLy8g5pyq6I635Y+W5Yiw5oyH5a6a5a2X5q615pe277yM6L+U5Zue77yM5LiN5YaN6K6+572u54Sm54K544CCXHJcbiAgICBpZiAoZWxlbWVudFRvRm9jdXMpIHtcclxuICAgICAgLy8g5aaC5p6c5pyJ5aSa5LiqaWTph43lpI3nmoTlhYPntKDvvIzliJnkuI3lrprkvY1cclxuICAgICAgY29uc3QgZWxlbWVudHMgPSByb290RWxlbWVudC5uYXRpdmVFbGVtZW50Lm93bmVyRG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChgIyR7ZWxlbWVudElkfWApO1xyXG4gICAgICBpZiAoZWxlbWVudHMgJiYgZWxlbWVudHMubGVuZ3RoID4gMSkge1xyXG4gICAgICAgIHJldHVybiBmb2N1c2VkO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIOWmguaenOe7keWumuebruagh+Wtl+auteeahOaOp+S7tuS4jeaYr0lucHV05YWD57Sg77yM5YiZ5p+l5om+5YW25LiL57qn6IqC54K544CCXHJcbiAgICAgIGlmIChlbGVtZW50VG9Gb2N1cy50YWdOYW1lICE9PSAnSU5QVVQnKSB7XHJcbiAgICAgICAgY29uc3Qgc3ViRWxlbWVudHMgPSBlbGVtZW50VG9Gb2N1cy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaW5wdXQnKTtcclxuICAgICAgICBpZiAoc3ViRWxlbWVudHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICBlbGVtZW50VG9Gb2N1cyA9IHN1YkVsZW1lbnRzWzBdO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBlbGVtZW50VG9Gb2N1cy5mb2N1cygpO1xyXG4gICAgICBmb2N1c2VkID0gdHJ1ZTtcclxuICAgIH1cclxuICAgIHJldHVybiBmb2N1c2VkO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDorr7nva7nhKbngrlcclxuICAgKiBAcGFyYW0gdmVyaWZ5SW5mb3JtYXRpb24g6ZSZ6K+v5L+h5oGvXHJcbiAgICogQHBhcmFtIGZyYW1lQ29udGV4dCDkuIrkuIvmlodcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZm9jdXModmVyaWZ5SW5mb3JtYXRpb246IGFueSwgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpIHtcclxuICAgIGlmICghdmVyaWZ5SW5mb3JtYXRpb24pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgaXNHcmlkVmFsaWRhdGlvbiA9IHZlcmlmeUluZm9ybWF0aW9uLmluZGV4ICE9PSBudWxsO1xyXG4gICAgaWYgKGlzR3JpZFZhbGlkYXRpb24pIHtcclxuICAgICAgY29uc3QgZ3JpZCA9IHRoaXMuZ2V0R3JpZFJlZihmcmFtZUNvbnRleHQpO1xyXG4gICAgICBpZiAoZ3JpZCkge1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgZ3JpZC5lZGl0Q2VsbCh2ZXJpZnlJbmZvcm1hdGlvbi5pZCwgdmVyaWZ5SW5mb3JtYXRpb24udGFyZ2V0RmllbGQpO1xyXG4gICAgICAgIH0sIDApO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCBmcmFtZUVsZW1lbnQgPSB0aGlzLmdldENvbXBvbmVudFJlZihmcmFtZUNvbnRleHQpO1xyXG4gICAgICBjb25zdCBlbGVtZW50SWQgPSB2ZXJpZnlJbmZvcm1hdGlvbi50YXJnZXRGaWVsZDtcclxuICAgICAgdGhpcy5mb2N1c0J5SWQoZWxlbWVudElkLCBmcmFtZUVsZW1lbnQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6YCa6L+H5o6n5Lu2aWTorr7nva7nhKbngrlcclxuICAgKiBAcGFyYW0gZWxlbWVudElkIFxyXG4gICAqIEBwYXJhbSBlbGVtZW50UmVmIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZm9jdXNCeUlkKGVsZW1lbnRJZDogc3RyaW5nLCBlbGVtZW50UmVmPzogRWxlbWVudFJlZikge1xyXG4gICAgY29uc3QgZG9jdW1lbnQ6IGFueSA9IGVsZW1lbnRSZWYgJiYgZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50Lm93bmVyRG9jdW1lbnQgfHwgd2luZG93LmRvY3VtZW50O1xyXG4gICAgaWYgKGRvY3VtZW50KSB7XHJcbiAgICAgIGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChlbGVtZW50SWQpO1xyXG4gICAgICBpZiAoZWxlbWVudC50YWdOYW1lICE9PSAnSU5QVVQnKSB7XHJcbiAgICAgICAgY29uc3Qgc3ViRWxlbWVudHMgPSBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpbnB1dCcpO1xyXG4gICAgICAgIGlmIChzdWJFbGVtZW50cy5sZW5ndGgpIHtcclxuICAgICAgICAgIGNvbnN0IGlucHV0ID0gc3ViRWxlbWVudHNbMF07XHJcbiAgICAgICAgICBpZiAoaW5wdXQgJiYgdHlwZW9mIGlucHV0LmZvY3VzID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgIGlucHV0LmZvY3VzKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGVsZW1lbnQuZm9jdXMoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bnu4Tku7blrp7kvotcclxuICAgKiBAcGFyYW0gZnJhbWVDb250ZXh0IFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Q29tcG9uZW50UmVmKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSB7XHJcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PEVsZW1lbnRSZWY+KEVsZW1lbnRSZWYsIG51bGwpIHx8IG51bGw7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlmdyaWTlrp7kvotcclxuICAgKiBAcGFyYW0gZnJhbWVDb250ZXh0IGZyYW1lQ29udGV4dFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0R3JpZFJlZihmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCk6IEZvY3VzYWJsZUludmFsaWRhdGlvbkdyaWQge1xyXG4gICAgY29uc3QgbmFtZXNwYWNlID0gZnJhbWVDb250ZXh0Lm5hbWVzcGFjZTtcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dHM6IEZyYW1lQ29udGV4dFtdID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHNCeU5hbWVzcGFjZShuYW1lc3BhY2UpIHx8IFtdO1xyXG4gICAgY29uc3QgbWF0Y2hlZEZyYW1lQ29udGV4dHMgPSBmcmFtZUNvbnRleHRzLmZpbHRlcigoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IGZyYW1lQ29udGV4dC52aWV3TW9kZWwgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLnRvU3RyaW5nKCkgPT09IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkudG9TdHJpbmcoKSk7XHJcbiAgICBsZXQgcmVzdWx0ID0gbnVsbDtcclxuICAgIGlmIChtYXRjaGVkRnJhbWVDb250ZXh0cykge1xyXG4gICAgICBtYXRjaGVkRnJhbWVDb250ZXh0cy5ldmVyeSgoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgICBjb25zdCBmcmFtZUlkID0gZnJhbWVDb250ZXh0LmZyYW1lSWQ7XHJcbiAgICAgICAgY29uc3QgY29tcG9uZW50c01hcCA9IHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuY29tcG9uZW50TWFuYWdlci5nZXRDb21wb25lbnRzQnlGcmFtZUlkKGZyYW1lSWQpO1xyXG4gICAgICAgIGlmICghY29tcG9uZW50c01hcCkge1xyXG4gICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGRhdGFncmlkQ29tcG9uZW50ID0gQXJyYXkuZnJvbShjb21wb25lbnRzTWFwLnZhbHVlcygpKS5maW5kKChjb21wb25lbnQ6IGFueSkgPT4gY29tcG9uZW50ICYmIGNvbXBvbmVudFsnX19jb21wb25lbnRfdHlwZV9fJ10gPT09ICdEYXRhZ3JpZENvbXBvbmVudCcpO1xyXG4gICAgICAgIGlmIChkYXRhZ3JpZENvbXBvbmVudCkge1xyXG4gICAgICAgICAgcmVzdWx0ID0gZGF0YWdyaWRDb21wb25lbnQ7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgRm9jdXNhYmxlSW52YWxpZGF0aW9uR3JpZCwgRm9jdXNJbnZhbGlkU2VydmljZSB9O1xyXG4iXX0=