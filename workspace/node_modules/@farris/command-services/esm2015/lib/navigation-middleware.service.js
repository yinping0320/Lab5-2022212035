import { Injectable, Optional } from '@angular/core';
import { EMPTY, of } from 'rxjs';
import { switchMap, throwIfEmpty } from 'rxjs/operators';
import { INSIDE_DIALOG_TOKEN, TAB_EVENT } from './types';
import { NavigationService } from './navigation.service';
import { FrameContext, UID } from '@farris/devkit';
import { FormMessageService } from './form-message.service';
import { LanguageService } from './languag.service';
import { CardDataService } from './data-services/card-data.service';
import { DataChangeDetectionService } from './data-change-detection.service';
/**
 * 导航中间件服务
 * @scope FrameComponent
 */
// tslint:disable: no-string-literal
export class NavigationMiddlewareService {
    constructor(navigationService, frameContext, msgService, languageService, cardDataService) {
        this.navigationService = navigationService;
        this.frameContext = frameContext;
        this.msgService = msgService;
        this.languageService = languageService;
        this.cardDataService = cardDataService;
        this.repository = frameContext.repository;
        if (!this.languageService) {
            this.languageService = LanguageService.getInstance();
        }
        if (this.frameContext) {
            this.appContext = this.frameContext.getFormAppContext() || null;
        }
    }
    /**
     * 关闭前处理
     */
    onClosing() {
        if (this.isInDialog()) {
            return;
        }
        this.navigationService.addEventListener(TAB_EVENT.onTabClosing, (options) => {
            if (!this.frameContext || this.frameContext.isDisposed) {
                return of(true);
            }
            return this.isChanged.pipe(switchMap((changed) => {
                if (changed && !this.appContext.opened) {
                    // 如果需要用户确认就切换到当前tab
                    if (options && options.beforeCloseHandle && typeof options.beforeCloseHandle === 'function') {
                        options.beforeCloseHandle({ selectedChange: true });
                    }
                    const conform = this.msgService.question(this.languageService['exitWithoutSave']);
                    /*记录弹窗已打开*/
                    this.appContext.opened = true;
                    return conform.pipe(switchMap((result) => {
                        this.appContext.opened = false;
                        if (result) {
                            /*记录用户关闭弹窗*/
                            if (!!this.cardDataService) {
                                const revert$ = this.cardDataService.revert(options);
                                return revert$.pipe(switchMap(() => of(result)));
                            }
                        }
                        return of(result);
                    }));
                }
                else if (changed && this.appContext.opened) {
                    return of(false);
                }
                else {
                    return of(true);
                }
            }));
        });
    }
    /**
     * 是否在是弹窗窗口内
     */
    isInDialog() {
        let frameContext = this.frameContext;
        let isDialogRootComponent = frameContext.frameComponent['isDialogRootComponent'] || false;
        while (frameContext.parent !== null && !isDialogRootComponent) {
            frameContext = frameContext.parent;
            isDialogRootComponent = frameContext.frameComponent['isDialogRootComponent'];
        }
        if (!isDialogRootComponent) {
            isDialogRootComponent = this.frameContext.injector.get(INSIDE_DIALOG_TOKEN, false);
        }
        return isDialogRootComponent;
    }
    /**
     * 获取tabid,如果targetId存在则直接使用targetId
     * @description 将用户要查看的数据id转换为运行框架需要的tabId
     * @param params - router参数
     * @param targetId - 要编辑/查看的数据id
     */
    getTabId(params, targetId) {
        if (!!targetId) {
            return targetId;
        }
        let paramsObj = null;
        if (!!params && params.startsWith('{') && params.endsWith('}')) {
            paramsObj = JSON.parse(params);
        }
        let paramId = null;
        if (paramsObj && paramsObj.hasOwnProperty('id') && !!paramsObj.id) {
            paramId = paramsObj.id;
        }
        else {
            paramId = UID.create();
        }
        return paramId;
    }
    /**
     * 是否有未保存的变更
     */
    get isChanged() {
        return DataChangeDetectionService.hasChange(this.frameContext).pipe(throwIfEmpty(() => EMPTY));
    }
}
NavigationMiddlewareService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
NavigationMiddlewareService.ctorParameters = () => [
    { type: NavigationService },
    { type: FrameContext },
    { type: FormMessageService },
    { type: LanguageService, decorators: [{ type: Optional }] },
    { type: CardDataService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdGlvbi1taWRkbGV3YXJlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvbmF2aWdhdGlvbi1taWRkbGV3YXJlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLEtBQUssRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsU0FBUyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3pELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3pELE9BQU8sRUFBYyxZQUFZLEVBQWMsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0UsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUNwRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUM3RTs7O0dBR0c7QUFDSCxvQ0FBb0M7QUFFcEMsTUFBTSxPQUFPLDJCQUEyQjtJQUl0QyxZQUNVLGlCQUFvQyxFQUNwQyxZQUEwQixFQUMxQixVQUE4QixFQUNsQixlQUFnQyxFQUM1QyxlQUFnQztRQUpoQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGVBQVUsR0FBVixVQUFVLENBQW9CO1FBQ2xCLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUM1QyxvQkFBZSxHQUFm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QyxDQUFDO0lBQy9GLENBQUM7OztZQXpHRixVQUFVOzs7O1lBWEYsaUJBQWlCO1lBQ0wsWUFBWTtZQUN4QixrQkFBa0I7WUFDbEIsZUFBZSx1QkFpQm5CLFFBQVE7WUFoQkosZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEVNUFRZLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBzd2l0Y2hNYXAsIHRocm93SWZFbXB0eSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgSU5TSURFX0RJQUxPR19UT0tFTiwgVEFCX0VWRU5UIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IE5hdmlnYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi9uYXZpZ2F0aW9uLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBBcHBDb250ZXh0LCBGcmFtZUNvbnRleHQsIFJlcG9zaXRvcnksIFVJRCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgRm9ybU1lc3NhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLW1lc3NhZ2Uuc2VydmljZSc7XHJcbmltcG9ydCB7IExhbmd1YWdlU2VydmljZSB9IGZyb20gJy4vbGFuZ3VhZy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ2FyZERhdGFTZXJ2aWNlIH0gZnJvbSAnLi9kYXRhLXNlcnZpY2VzL2NhcmQtZGF0YS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRGF0YUNoYW5nZURldGVjdGlvblNlcnZpY2UgfSBmcm9tICcuL2RhdGEtY2hhbmdlLWRldGVjdGlvbi5zZXJ2aWNlJztcclxuLyoqXHJcbiAqIOWvvOiIquS4remXtOS7tuacjeWKoVxyXG4gKiBAc2NvcGUgRnJhbWVDb21wb25lbnRcclxuICovXHJcbi8vIHRzbGludDpkaXNhYmxlOiBuby1zdHJpbmctbGl0ZXJhbFxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBOYXZpZ2F0aW9uTWlkZGxld2FyZVNlcnZpY2Uge1xyXG4gIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+O1xyXG5cclxuICBwcml2YXRlIGFwcENvbnRleHQ6IEFwcENvbnRleHQ7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIG5hdmlnYXRpb25TZXJ2aWNlOiBOYXZpZ2F0aW9uU2VydmljZSxcclxuICAgIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXHJcbiAgICBwcml2YXRlIG1zZ1NlcnZpY2U6IEZvcm1NZXNzYWdlU2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGNhcmREYXRhU2VydmljZTogQ2FyZERhdGFTZXJ2aWNlXHJcbiAgKSB7XHJcbiAgICB0aGlzLnJlcG9zaXRvcnkgPSBmcmFtZUNvbnRleHQucmVwb3NpdG9yeTtcclxuICAgIGlmICghdGhpcy5sYW5ndWFnZVNlcnZpY2UpIHtcclxuICAgICAgdGhpcy5sYW5ndWFnZVNlcnZpY2UgPSBMYW5ndWFnZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmZyYW1lQ29udGV4dCkge1xyXG4gICAgICB0aGlzLmFwcENvbnRleHQgPSB0aGlzLmZyYW1lQ29udGV4dC5nZXRGb3JtQXBwQ29udGV4dCgpIHx8IG51bGw7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWFs+mXreWJjeWkhOeQhlxyXG4gICAqL1xyXG4gIHB1YmxpYyBvbkNsb3NpbmcoKSB7XHJcbiAgICBpZiAodGhpcy5pc0luRGlhbG9nKCkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5uYXZpZ2F0aW9uU2VydmljZS5hZGRFdmVudExpc3RlbmVyKFRBQl9FVkVOVC5vblRhYkNsb3NpbmcsIChvcHRpb25zKSA9PiB7XHJcbiAgICAgIGlmICghdGhpcy5mcmFtZUNvbnRleHQgfHwgdGhpcy5mcmFtZUNvbnRleHQuaXNEaXNwb3NlZCkge1xyXG4gICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdGhpcy5pc0NoYW5nZWQucGlwZShzd2l0Y2hNYXAoKGNoYW5nZWQ6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBpZiAoY2hhbmdlZCAmJiAhdGhpcy5hcHBDb250ZXh0Lm9wZW5lZCkge1xyXG4gICAgICAgICAgLy8g5aaC5p6c6ZyA6KaB55So5oi356Gu6K6k5bCx5YiH5o2i5Yiw5b2T5YmNdGFiXHJcbiAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmJlZm9yZUNsb3NlSGFuZGxlICYmIHR5cGVvZiBvcHRpb25zLmJlZm9yZUNsb3NlSGFuZGxlID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgIG9wdGlvbnMuYmVmb3JlQ2xvc2VIYW5kbGUoeyBzZWxlY3RlZENoYW5nZTogdHJ1ZSB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNvbnN0IGNvbmZvcm0gPSB0aGlzLm1zZ1NlcnZpY2UucXVlc3Rpb24odGhpcy5sYW5ndWFnZVNlcnZpY2VbJ2V4aXRXaXRob3V0U2F2ZSddKTtcclxuICAgICAgICAgIC8q6K6w5b2V5by556qX5bey5omT5byAKi9cclxuICAgICAgICAgIHRoaXMuYXBwQ29udGV4dC5vcGVuZWQgPSB0cnVlO1xyXG4gICAgICAgICAgcmV0dXJuIGNvbmZvcm0ucGlwZShcclxuICAgICAgICAgICAgc3dpdGNoTWFwKChyZXN1bHQ6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICAgICAgICB0aGlzLmFwcENvbnRleHQub3BlbmVkID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgLyrorrDlvZXnlKjmiLflhbPpl63lvLnnqpcqL1xyXG4gICAgICAgICAgICAgICAgaWYgKCEhdGhpcy5jYXJkRGF0YVNlcnZpY2UpIHtcclxuICAgICAgICAgICAgICAgICAgY29uc3QgcmV2ZXJ0JCA9IHRoaXMuY2FyZERhdGFTZXJ2aWNlLnJldmVydChvcHRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldmVydCQucGlwZShcclxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT4gb2YocmVzdWx0KSlcclxuICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgcmV0dXJuIG9mKHJlc3VsdCk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoY2hhbmdlZCAmJiB0aGlzLmFwcENvbnRleHQub3BlbmVkKSB7XHJcbiAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5piv5ZCm5Zyo5piv5by556qX56qX5Y+j5YaFXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpc0luRGlhbG9nKCkge1xyXG4gICAgbGV0IGZyYW1lQ29udGV4dCA9IHRoaXMuZnJhbWVDb250ZXh0O1xyXG4gICAgbGV0IGlzRGlhbG9nUm9vdENvbXBvbmVudCA9IGZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudFsnaXNEaWFsb2dSb290Q29tcG9uZW50J10gfHwgZmFsc2U7XHJcbiAgICB3aGlsZSAoZnJhbWVDb250ZXh0LnBhcmVudCAhPT0gbnVsbCAmJiAhaXNEaWFsb2dSb290Q29tcG9uZW50KSB7XHJcbiAgICAgIGZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dC5wYXJlbnQ7XHJcbiAgICAgIGlzRGlhbG9nUm9vdENvbXBvbmVudCA9IGZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudFsnaXNEaWFsb2dSb290Q29tcG9uZW50J107XHJcbiAgICB9XHJcbiAgICBpZiAoIWlzRGlhbG9nUm9vdENvbXBvbmVudCkge1xyXG4gICAgICBpc0RpYWxvZ1Jvb3RDb21wb25lbnQgPSB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8Ym9vbGVhbj4oSU5TSURFX0RJQUxPR19UT0tFTiwgZmFsc2UpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGlzRGlhbG9nUm9vdENvbXBvbmVudDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+WdGFiaWQs5aaC5p6cdGFyZ2V0SWTlrZjlnKjliJnnm7TmjqXkvb/nlKh0YXJnZXRJZFxyXG4gICAqIEBkZXNjcmlwdGlvbiDlsIbnlKjmiLfopoHmn6XnnIvnmoTmlbDmja5pZOi9rOaNouS4uui/kOihjOahhuaetumcgOimgeeahHRhYklkXHJcbiAgICogQHBhcmFtIHBhcmFtcyAtIHJvdXRlcuWPguaVsFxyXG4gICAqIEBwYXJhbSB0YXJnZXRJZCAtIOimgee8lui+kS/mn6XnnIvnmoTmlbDmja5pZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRUYWJJZChwYXJhbXM6IHN0cmluZywgdGFyZ2V0SWQ6IHN0cmluZyk6IGFueSB7XHJcbiAgICBpZiAoISF0YXJnZXRJZCkge1xyXG4gICAgICByZXR1cm4gdGFyZ2V0SWQ7XHJcbiAgICB9XHJcbiAgICBsZXQgcGFyYW1zT2JqOiBhbnkgPSBudWxsO1xyXG4gICAgaWYgKCEhcGFyYW1zICYmIHBhcmFtcy5zdGFydHNXaXRoKCd7JykgJiYgcGFyYW1zLmVuZHNXaXRoKCd9JykpIHtcclxuICAgICAgcGFyYW1zT2JqID0gSlNPTi5wYXJzZShwYXJhbXMpO1xyXG4gICAgfVxyXG4gICAgbGV0IHBhcmFtSWQgPSBudWxsO1xyXG4gICAgaWYgKHBhcmFtc09iaiAmJiBwYXJhbXNPYmouaGFzT3duUHJvcGVydHkoJ2lkJykgJiYgISFwYXJhbXNPYmouaWQpIHtcclxuICAgICAgcGFyYW1JZCA9IHBhcmFtc09iai5pZDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHBhcmFtSWQgPSBVSUQuY3JlYXRlKCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcGFyYW1JZDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5piv5ZCm5pyJ5pyq5L+d5a2Y55qE5Y+Y5pu0XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXQgaXNDaGFuZ2VkKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgcmV0dXJuIERhdGFDaGFuZ2VEZXRlY3Rpb25TZXJ2aWNlLmhhc0NoYW5nZSh0aGlzLmZyYW1lQ29udGV4dCkucGlwZSh0aHJvd0lmRW1wdHkoKCk9PkVNUFRZKSk7XHJcbiAgfVxyXG59XHJcbiJdfQ==