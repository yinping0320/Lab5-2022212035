import * as tslib_1 from "tslib";
// tslint:disable: max-line-length
import { ElementRef, InjectFlags, Injectable, Optional } from '@angular/core';
import { Repository, FrameContext, PARENT_CLASS, ChangeType, DataPropGroup } from '@farris/devkit';
import { tap, switchMap } from 'rxjs/operators';
import { EMPTY, Subject } from 'rxjs';
import { zip } from 'rxjs/observable/zip';
import { empty } from 'rxjs/observable/empty';
import { of } from 'rxjs/observable/of';
import { VerifyDetailService } from '@farris/ui-verify-detail';
import { FormNotifyService } from './form-notify.service';
import { LanguageService } from './languag.service';
import { VerifyService } from './verify.service';
import { DatagridComponent } from '@farris/ui-datagrid';
/**
 * 表单验证服务
 * @scope FrameComponent
 */
var ValidationService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function ValidationService(repository, frameContext, notifyService, languageService) {
        this.repository = repository;
        this.frameContext = frameContext;
        this.notifyService = notifyService;
        this.languageService = languageService;
        this.validationResults = new Subject();
        this.validationAllResult = new Subject();
        if (!this.languageService) {
            this.languageService = new LanguageService();
        }
    }
    /**
     * 验证表单内的所有表单
     */
    ValidationService.prototype.validate = function () {
        var _this = this;
        this.repository.getList().subscribe(function (result) {
            var e_1, _a;
            try {
                for (var result_1 = tslib_1.__values(result), result_1_1 = result_1.next(); !result_1_1.done; result_1_1 = result_1.next()) {
                    var entity = result_1_1.value;
                    entity.validate().subscribe(function (result) {
                        if (!result.isValid) {
                            alert(result.message);
                            _this.validationResults.next(result);
                        }
                    });
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (result_1_1 && !result_1_1.done && (_a = result_1.return)) _a.call(result_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
        });
        return this.validationResults;
    };
    /**
     * 校验当前行
     */
    ValidationService.prototype.validateCurrentRow = function () {
        var _this = this;
        var entityTypeInfo = this.repository.entityTypeInfo;
        // 组合表单只校验当前按钮所在的表单
        var primaryValue = this.frameContext.bindingData.list.currentId;
        if (!primaryValue) {
            return of(true);
        }
        // 首先校验实体不能为空规则
        var entity = this.repository.entityCollection.getEntityById(primaryValue);
        if (!entity) {
            return of(true);
        }
        var entities = [entity];
        var namespace = this.frameContext.namespace;
        var frameContexts = [];
        // 修复使用相同be创建的vo的组合表单校验时多个表单校验规则被合并的问题
        // TODO: 目前未考虑组合表单统一保存的场景，后续支持组合表单统一保存时再修改
        if (namespace !== null) {
            // 存在命名空间，说明表单较新，可以依赖该特性
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace);
        }
        else {
            // 表单较老，获取所有的上下文，在校验阶段过滤规则
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContexts();
        }
        var isModal = this.isInDialog();
        var hasOwnVerifyDetailService = this.hasOwnVerifyDetailService();
        var rootViewModel = this.frameContext.root.viewModel;
        if (isModal && hasOwnVerifyDetailService) {
            rootViewModel = this.frameContext.getVirtualRootFrameContext().viewModel;
        }
        var toValidate = false;
        var formErrors = [];
        frameContexts.forEach(function (frameContext) {
            if (frameContext.form && frameContext.form.enableValidate) {
                toValidate = true;
            }
        });
        if (!toValidate || entities.length < 1) {
            return of(true);
        }
        rootViewModel.verifyInformations = [];
        var formValid = true;
        var entityValid = true;
        var formValidationRules = new Map();
        frameContexts.forEach(function (formContext) {
            var bindingObject = formContext.bindingData.getObject();
            // 通知所有bindingData,
            bindingObject && bindingObject.setShowValidationMsg(true);
            if (formContext.form && formContext.form.enableValidate) {
                // 获取当前表单上的所有验证规则
                var currentFormValidationRules = formContext.form.getValidationRules();
                currentFormValidationRules.forEach(function (rules, path) {
                    if (formValidationRules.has(path)) {
                        rules.forEach(function (rule) { return formValidationRules.get(path).push(rule); });
                    }
                    else {
                        formValidationRules.set(path, tslib_1.__spread(rules));
                    }
                });
                formContext.form.setShowValidationMsg(true);
                // 逐个调用表单的验证，验证前端表单规则
                if (!formContext.form.isFormValid()) {
                    formErrors.push(formContext.form);
                    formValid = false;
                }
            }
        });
        // 验证所有实体
        var observableList = entities.map(function (entity) {
            var index = _this.frameContext.bindingData.list.getIndexById(entity.primaryValue);
            return entity.validate(undefined, undefined, formValidationRules, null, _this.frameContext);
        });
        var result$ = zip.apply(void 0, tslib_1.__spread(observableList)).pipe(tap(function (resultList) {
            frameContexts.forEach(function (formContext) {
                if (!formContext.form.enableValidate) {
                    return;
                }
                var handleErrors = function (errors) {
                    errors.forEach(function (validationError) {
                        if (validationError.children && validationError.children.length) {
                            handleErrors(validationError.children);
                        }
                        var errMsgObj = {};
                        var id = '';
                        var findId = function (target) {
                            if (target && target.data && target.data.id) {
                                id = target.data.id;
                                return;
                            }
                            else if (target[PARENT_CLASS]) {
                                findId(target[PARENT_CLASS]);
                            }
                        };
                        findId(validationError.target);
                        // 实体验证出错，需要将错误展示到界面上
                        // 实体不一定是当前行
                        var parentPathData = {
                            path: [],
                            isUdt: false,
                            isGrid: false
                        };
                        if (validationError.target) {
                            parentPathData = validationError.target.getPaths();
                        }
                        var bindingPath = '/' + parentPathData.path.join('/');
                        if (validationError.constraints) {
                            Object.keys(validationError.constraints).forEach(function (key) {
                                errMsgObj[key] = {
                                    name: validationError.constraints[key]
                                };
                                // if (this.frameContext.viewModel.bindingPath === bindingPath) {
                                //   rootViewModel['verifyInformations'].push({
                                //     id: id,
                                //     title: key,
                                //     msg: validationError.constraints[key],
                                //     type: 'warn'
                                //   })
                                // }
                            });
                        }
                        var paths = parentPathData.path.concat(validationError.property);
                        //if (this.frameContext.viewModel.bindingPath === bindingPath) {
                        // 将错误信息更新到formControl上
                        formContext.bindingData.changes.next({
                            type: ChangeType.UpdateErrors,
                            id: id,
                            path: paths,
                            isUdt: parentPathData.isUdt,
                            isGrid: parentPathData.isGrid,
                            value: validationError.value,
                            errors: errMsgObj
                        });
                        //}
                    });
                };
                // 展开验证结果
                var isValidList = resultList.map(function (result) { return result.isValid; });
                // 保存前先调用实体上的验证规则，全部通过之后才保存
                // 实体验证通过
                if (isValidList.filter(function (x) { return x; }).length === observableList.length) {
                    // 将错误信息更新到formControl上
                    formContext.bindingData.changes.next({
                        type: ChangeType.UpdateErrors,
                        path: []
                    });
                    // 验证成功后隐藏输入时的验证
                    if (formValid) {
                        var bindingObject = formContext.bindingData.getObject();
                        bindingObject && bindingObject.setShowValidationMsg(false);
                        var form = formContext.form;
                        if (form) {
                            form.setShowValidationMsg(false);
                        }
                    }
                }
                else {
                    // 实体验证有错误
                    entityValid = false;
                    resultList.forEach(function (result) {
                        if (result.isValid) {
                            // 清除验证通过的错误
                            formContext.bindingData.changes.next({
                                type: ChangeType.UpdateErrors,
                                path: []
                            });
                        }
                        else {
                            handleErrors(result.errors);
                        }
                    });
                }
            });
        }), switchMap(function (resultList) {
            var isValidated = true;
            var errors = [];
            resultList.forEach(function (result) {
                if (!result.isValid) {
                    isValidated = false;
                }
                errors.push.apply(errors, tslib_1.__spread(result.errors));
            });
            if (errors.length > 0) {
                _this.collectValidationErrors(rootViewModel, errors, _this.frameContext.namespace);
            }
            // rootViewModel.verifycationChanged.next(rootViewModel.verifyInformations);
            var verifyInformations = rootViewModel.verifyInformations;
            if (isModal && hasOwnVerifyDetailService) {
                verifyInformations = rootViewModel.verifyInformations.filter(function (item) { return item.namespace === namespace; });
            }
            rootViewModel.verifycationChanged.next(verifyInformations);
            _this.handleErrorClickEvent();
            if (isValidated && !formValid) {
                // 实体校验通过但表单校验不通过，此时实体和表单存在校验规则不一致的情况
                console.warn('实体和控件校验规则不一致，请确认实体校验规则配置与控件一致。如果配置不一致可能会导致校验失效！');
            }
            // 实体校验通过，实体校验使用的规则是控件+实体，正常实体校验通过后控件校验一定也会通过
            if (isValidated) {
                var isEntityValid = _this.validateEntityAllowEmptyRule(entityTypeInfo);
                if (!isEntityValid) {
                    return EMPTY;
                }
                return of(true);
            }
            else {
                return empty();
            }
        }));
        return result$;
    };
    /**
     * 调用表单和实体上的验证规则, 通过后调用回调cb
     */
    ValidationService.prototype.validateAll = function () {
        var _this = this;
        var entityTypeInfo = this.repository.entityTypeInfo;
        // 组合表单只校验当前按钮所在的表单
        var entities = this.repository.entityCollection.getAllEntities();
        var namespace = this.frameContext.namespace;
        var frameContexts = [];
        if (namespace !== null) {
            // 存在命名空间，说明表单较新，可以依赖该特性
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace);
        }
        else {
            // 表单较老，获取所有的上下文，在校验阶段过滤规则
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContexts();
        }
        var toValidate = false;
        var formErrors = [];
        frameContexts.forEach(function (frameContext) {
            if (frameContext.form && frameContext.form.enableValidate) {
                toValidate = true;
            }
        });
        if (!toValidate || entities.length < 1) {
            return of(true);
        }
        var isModal = this.isInDialog();
        var hasOwnVerifyDetailService = this.hasOwnVerifyDetailService();
        var rootViewModel = this.frameContext.root.viewModel;
        if (isModal && hasOwnVerifyDetailService) {
            rootViewModel = this.frameContext.getVirtualRootFrameContext().viewModel;
        }
        var formValid = true;
        var entityValid = true;
        var formValidationRules = new Map();
        frameContexts.forEach(function (formContext) {
            var bindingObject = formContext.bindingData.getObject();
            // 通知所有bindingData,
            bindingObject && bindingObject.setShowValidationMsg(true);
            if (formContext.form && formContext.form.enableValidate) {
                // 获取当前表单上的所有验证规则
                var currentFormValidationRules = formContext.form.getValidationRules();
                currentFormValidationRules.forEach(function (rules, path) {
                    if (formValidationRules.has(path)) {
                        rules.forEach(function (rule) { return formValidationRules.get(path).push(rule); });
                    }
                    else {
                        formValidationRules.set(path, tslib_1.__spread(rules));
                    }
                });
                formContext.form.setShowValidationMsg(true);
                // 逐个调用表单的验证，验证前端表单规则
                if (!formContext.form.isFormValid()) {
                    formErrors.push(formContext.form);
                    formValid = false;
                }
            }
        });
        // 触发所有实体的validate事件
        var isMultiEntityValiate = entities.length > 0;
        // 验证所有实体
        var observableList = entities.map(function (entity, index) {
            return entity.validate(undefined, undefined, formValidationRules, isMultiEntityValiate ? index : null, _this.frameContext);
        });
        var result$ = zip.apply(void 0, tslib_1.__spread(observableList)).pipe(tap(function (resultList) {
            frameContexts.forEach(function (formContext) {
                if (!formContext.form.enableValidate) {
                    return;
                }
                var handleErrors = function (errors) {
                    errors.forEach(function (validationError) {
                        if (validationError.children && validationError.children.length) {
                            handleErrors(validationError.children);
                        }
                        var errMsgObj = {};
                        var id = '';
                        var findId = function (target) {
                            if (target && target.data && target.data.id) {
                                id = target.data.id;
                                return;
                            }
                            else if (target[PARENT_CLASS]) {
                                findId(target[PARENT_CLASS]);
                            }
                        };
                        findId(validationError.target);
                        // 实体验证出错，需要将错误展示到界面上
                        // 实体不一定是当前行
                        var parentPathData = {
                            path: [],
                            isUdt: false,
                            isGrid: false
                        };
                        if (validationError.target) {
                            parentPathData = validationError.target.getPaths();
                        }
                        var bindingPath = '/' + parentPathData.path.join('/');
                        if (validationError.constraints) {
                            Object.keys(validationError.constraints).forEach(function (key) {
                                errMsgObj[key] = {
                                    name: validationError.constraints[key]
                                };
                                // if (this.frameContext.viewModel.bindingPath === bindingPath) {
                                //   rootViewModel['verifyInformations'].push({
                                //     id: id,
                                //     title: key,
                                //     msg: validationError.constraints[key],
                                //     type: 'warn'
                                //   })
                                // }
                            });
                        }
                        var paths = parentPathData.path.concat(validationError.property);
                        //if (this.frameContext.viewModel.bindingPath === bindingPath) {
                        // 将错误信息更新到formControl上
                        formContext.bindingData.changes.next({
                            type: ChangeType.UpdateErrors,
                            id: id,
                            path: paths,
                            isUdt: parentPathData.isUdt,
                            isGrid: parentPathData.isGrid,
                            value: validationError.value,
                            errors: errMsgObj
                        });
                        //}
                    });
                };
                // 展开验证结果
                var isValidList = resultList.map(function (result) { return result.isValid; });
                // 保存前先调用实体上的验证规则，全部通过之后才保存
                // 实体验证通过
                if (isValidList.filter(function (x) { return x; }).length === observableList.length) {
                    // 将错误信息更新到formControl上
                    formContext.bindingData.changes.next({
                        type: ChangeType.UpdateErrors,
                        path: []
                    });
                    // 验证成功后隐藏输入时的验证
                    if (formValid) {
                        var bindingObject = formContext.bindingData.getObject();
                        bindingObject && bindingObject.setShowValidationMsg(false);
                        var form = formContext.form;
                        if (form) {
                            form.setShowValidationMsg(false);
                        }
                    }
                }
                else {
                    // 实体验证有错误
                    entityValid = false;
                    resultList.forEach(function (result) {
                        if (result.isValid) {
                            // 清除验证通过的错误
                            formContext.bindingData.changes.next({
                                type: ChangeType.UpdateErrors,
                                path: []
                            });
                        }
                        else {
                            handleErrors(result.errors);
                        }
                    });
                }
            });
        }), switchMap(function (resultList) {
            var isValidated = true;
            var errors = [];
            resultList.forEach(function (result) {
                if (!result.isValid) {
                    isValidated = false;
                }
                errors.push.apply(errors, tslib_1.__spread(result.errors));
            });
            if (errors.length > 0) {
                _this.collectValidationErrors(rootViewModel, errors, _this.frameContext.namespace);
            }
            var verifyInformations = rootViewModel.verifyInformations;
            if (isModal && hasOwnVerifyDetailService) {
                verifyInformations = rootViewModel.verifyInformations.filter(function (item) { return item.namespace === namespace; });
            }
            // 因为校验累加的缘故，导致之前的校验信息一直存在，只能通过校验结果来确定是否还有错误信息
            if (isValidated && formValid) {
                verifyInformations = rootViewModel.verifyInformations = [];
            }
            rootViewModel.verifycationChanged.next(verifyInformations);
            _this.handleErrorClickEvent();
            if (isValidated) {
                var isEntityValid = _this.validateEntityAllowEmptyRule(entityTypeInfo);
                if (!isEntityValid) {
                    return EMPTY;
                }
                return of(true);
            }
            else {
                return empty();
            }
        }));
        return result$;
    };
    /**
     * 校验实体是否满足不能为空的规则
     * @param entity 主实体
     */
    ValidationService.prototype.validateEntityAllowEmptyRule = function (entityTypeInfo) {
        var _this = this;
        // 确认实体各个层级中是否存在不能为空的规则
        var paths = this.getNotAllowEmptyBindingPaths(entityTypeInfo);
        if (!paths || paths.length < 1) {
            return true;
        }
        // 找到所有不合法的bindingPaths
        var invalidPaths = paths.filter(function (path) {
            var bindingPaths = path.split('/').filter(function (p) { return p; });
            var bindingList = _this.frameContext.bindingData.getValue(bindingPaths);
            if (!bindingList || bindingList.length < 1) {
                return true;
            }
            return false;
        });
        // 有实体必填，但实体数据为空
        if (invalidPaths.length > 0) {
            var tableNames_1 = [];
            invalidPaths.forEach(function (path) {
                //const frameContexts = this.getFrameContextByBindingPath(path.split('/'));
                //const frameComponents = frameContexts.map(frameContext => frameContext.frameComponent);
                // 找到所有容器类组件
                //const containerComponents = frameComponents.filter(frameComponent => [ComponentType.farrisDataGridComponent, ComponentType.farrisTreeTalbeComponent, ComponentType.kendoGridComponent, ComponentType.primengTreeComponent].includes(frameComponent.componentType));
                //if (!(!containerComponents || containerComponents.length < 1)) {
                var viewModelName = _this.getViewModelNameByBindingPaths(path.split('/')) || "\u7ED1\u5B9A\u8DEF\u5F84" + path;
                tableNames_1.push(viewModelName);
                //}
            });
            if (this.notifyService) {
                this.notifyService.error(tableNames_1.join('，') + " " + this.languageService.tableCanNotEmpty, { hideTitle: true });
            }
            return false;
        }
        return true;
    };
    /**
     *
     * @param bindingPaths path不能为空或/，不支持主表
     */
    ValidationService.prototype.getViewModelNameByBindingPaths = function (bindingPaths) {
        var namespace = this.frameContext.namespace;
        var frameContexts = null;
        if (namespace !== null) {
            // 存在命名空间，说明表单较新，可以依赖该特性
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace);
        }
        else {
            // 表单较老，获取所有的上下文，在校验阶段过滤规则
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContexts();
        }
        var bindingPath = bindingPaths.filter(function (p) { return p; }).join('/');
        var frameContext = frameContexts.find(function (frameContext) { return frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; }).join('/') === bindingPath; });
        var viewModelName = frameContext && frameContext.form && frameContext.form.formGroupName || '';
        return viewModelName;
    };
    /**
     * 遍历获取所有不能为空的实体的绑定路径
     * @param entityTypeInfo
     * @param results
     * @returns
     */
    ValidationService.prototype.getNotAllowEmptyBindingPaths = function (entityTypeInfo, results) {
        if (results === void 0) { results = []; }
        if (!entityTypeInfo) {
            return;
        }
        this.deepFirstTraversalEntityTypeInfo(entityTypeInfo, results);
        return results;
    };
    ValidationService.prototype.deepFirstTraversalEntityTypeInfo = function (entityTypeInfo, result, previousValue) {
        var _this = this;
        if (result === void 0) { result = []; }
        if (previousValue === void 0) { previousValue = []; }
        // 确认当前实体是否必填
        var isAllowEmpty = this.isAllowEmpty(entityTypeInfo.entityInfo.allowEmpty, previousValue);
        if (isAllowEmpty === false) {
            if (previousValue.length < 1) {
                result.push('');
            }
            else {
                result.push(previousValue.join('/'));
            }
        }
        // 获取所有子表
        var list = entityTypeInfo.getPropInfosByGroup(DataPropGroup.List);
        if (list && list.length > 0) {
            list.forEach(function (propInfo) {
                var typeInfo = propInfo.typeInfo;
                if (typeInfo && typeInfo.entityInfo) {
                    previousValue.push(typeInfo.entityInfo.nodeCode);
                    _this.deepFirstTraversalEntityTypeInfo(typeInfo, result, previousValue);
                }
            });
        }
        // 没有下级了，此时应该清空游标，将收集到的路径放到结果集中
        if (previousValue && previousValue.length > 0) {
            previousValue.pop();
        }
    };
    ValidationService.prototype.isAllowEmpty = function (value, paths) {
        if (value === undefined || value === true || value === '') {
            return true;
        }
        // 开发者定义了不能为空的规则
        var frameContexts = this.getFrameContextByBindingPath(paths);
        var caller = this.frameContext.frameComponent;
        if (!frameContexts || frameContexts.length < 1) {
            // 定义了规则但对应的Frame没有渲染
            console.warn("\u7ED1\u5B9A\u8DEF\u5F84 " + paths.join('/') + " \u5B9A\u4E49\u4E86\u4E0D\u80FD\u4E3A\u7A7A\u7684\u89C4\u5219\uFF0C\u4F46\u627E\u4E0D\u5230\u8BE5\u7ED1\u5B9A\u8DEF\u5F84\u5BF9\u5E94\u7684\u7EC4\u4EF6\u3002\u8BF7\u786E\u4FDD\u7EC4\u4EF6\u663E\u9690\u4E0E\u5FC5\u586B\u4E00\u81F4\u3002");
        }
        else {
            caller = frameContexts.pop().frameComponent;
        }
        if (typeof value === 'boolean') {
            return value;
        }
        else if (typeof value === 'string') {
            value = value.trim().startsWith('return') ? value : "return " + value;
            var factory = new Function("\n        var viewModel = this.viewModel;\n        var bindingData = this.bindingData;\n        var context = this.context;\n        " + value + "\n      ");
            return factory.apply(caller);
        }
        else {
            console.warn("\u65E0\u6548\u7684\u5FC5\u586B\u89C4\u5219\u3002");
        }
    };
    ValidationService.prototype.collectValidationErrors = function (rootViewModel, errors, namespace, filter) {
        var _this = this;
        if (filter === void 0) { filter = true; }
        if (filter) {
            rootViewModel.verifyInformations = rootViewModel.verifyInformations.filter(function (item) { return item.namespace !== namespace; });
        }
        errors.forEach(function (validationError) {
            if (validationError.children && validationError.children.length) {
                _this.collectValidationErrors(rootViewModel, validationError.children, namespace, false);
            }
            var id = '';
            var findId = function (target) {
                if (target && target.data && target.data.id) {
                    id = target.data.id;
                    return;
                }
                else if (target[PARENT_CLASS]) {
                    findId(target[PARENT_CLASS]);
                }
            };
            findId(validationError.target);
            if (validationError.constraints) {
                var validationResultTypes = Object.keys(validationError.constraints);
                if (validationResultTypes.length) {
                    var offset = rootViewModel.verifyInformations.filter(function (item) { return item.namespace === namespace; }).length;
                    var index = rootViewModel.verifyInformations.findIndex(function (item) { return item.namespace === namespace; });
                    index = index === -1 ? 0 : index + offset;
                    rootViewModel.verifyInformations.splice(index, 0, {
                        id: id,
                        namespace: namespace,
                        targetField: validationError.field,
                        index: validationError.index,
                        title: validationError.propertyName,
                        msg: validationError.constraints[validationResultTypes[0]],
                        frameContext: validationError.frameContext,
                        fullPath: validationError.fullPath,
                        type: validationResultTypes[0] === 'required' ? 'empty' : 'error'
                    });
                }
            }
        });
    };
    /**
     * 重置校验信息（仅当前表单）
     */
    ValidationService.prototype.resetValidation = function () {
        var isDialog = this.isInDialog();
        var rootViewModel = this.frameContext.root.viewModel;
        if (isDialog) {
            rootViewModel = this.frameContext.getVirtualRootFrameContext().viewModel;
        }
        var verifyInformations = rootViewModel.verifyInformations;
        if (verifyInformations.length) {
            var namespace_1 = this.frameContext.namespace;
            if (namespace_1 !== null) {
                verifyInformations = rootViewModel.verifyInformations.filter(function (item) { return item.namespace !== namespace_1; });
            }
            rootViewModel.verifyInformations = verifyInformations;
            //rootViewModel.verifyInformations.splice(0, rootViewModel.verifyInformations.length);
        }
        if (rootViewModel && rootViewModel.verifycationChanged) {
            rootViewModel.verifycationChanged.next(verifyInformations);
        }
        return of(null);
    };
    /**
     * 是否在弹窗内部
     */
    ValidationService.prototype.isInDialog = function () {
        return this.frameContext && this.frameContext.getVirtualRootFrameContext() && this.frameContext.getVirtualRootFrameContext().frameComponent && this.frameContext.getVirtualRootFrameContext().frameComponent['isDialogRootComponent'] || false;
    };
    /**
     * 拥有独自的校验提示服务
     */
    ValidationService.prototype.hasOwnVerifyDetailService = function () {
        return this.frameContext.injector.get(VerifyDetailService, null) !== this.frameContext.root.appContext.injector.get(VerifyDetailService, null);
        ;
    };
    /**
     * 通过bindingPath获取所有匹配的frameContext
     * @param bindingPath
     * @returns
     */
    ValidationService.prototype.getFrameContextByBindingPath = function (bindingPaths) {
        var bindingPath = bindingPaths.filter(function (p) { return p; }).join('/');
        return this.frameContext.appContext.frameContextManager.getFrameContexts().filter(function (frameContext) { return frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; }).join('/') === bindingPath; });
    };
    Object.defineProperty(ValidationService.prototype, "verifyDetailService", {
        get: function () {
            return this.frameContext.injector.get(VerifyDetailService, null, InjectFlags.Self);
        },
        enumerable: true,
        configurable: true
    });
    ValidationService.prototype.handleErrorClickEvent = function () {
        var _this = this;
        if (this.verifyDetailService && this.verifyDetailService.verifyContainer && this.verifyDetailService.verifyContainer.instance) {
            this.verifyDetailService.verifyContainer.instance.validatorClick.subscribe(function (item) {
                _this.onErrorItemClick(item);
            });
        }
    };
    ValidationService.prototype.onErrorItemClick = function (item) {
        if (item === void 0) { item = { frameContext: null, id: null, targetField: null, fullPath: null }; }
        var frameContext = item.frameContext, id = item.id, targetField = item.targetField, fullPath = item.fullPath;
        var isGridComponent = frameContext && frameContext.frameComponent.isGridComponent || false;
        if (!isGridComponent) {
            if (!targetField) { }
            var elementRef = frameContext.injector.get(ElementRef, null, InjectFlags.Self) || frameContext.injector.get(ElementRef, null);
            VerifyService.focusElement(targetField, elementRef);
            this.verifyDetailService.verifyContainer.instance.showList = false;
        }
        else {
            // find grid component
            var grid = frameContext.componentRefManager.getComponentByType(DatagridComponent);
            if (grid && targetField && id) {
                grid.editCell(id, targetField);
                this.verifyDetailService.verifyContainer.instance.showList = false;
            }
        }
    };
    ValidationService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ValidationService.ctorParameters = function () { return [
        { type: Repository },
        { type: FrameContext },
        { type: FormNotifyService, decorators: [{ type: Optional }] },
        { type: LanguageService, decorators: [{ type: Optional }] }
    ]; };
    return ValidationService;
}());
export { ValidationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL3ZhbGlkYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsa0NBQWtDO0FBQ2xDLE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQVEsTUFBTSxlQUFlLENBQUM7QUFDcEYsT0FBTyxFQUFFLFVBQVUsRUFBVSxZQUFZLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBNEUsYUFBYSxFQUE0QyxNQUFNLGdCQUFnQixDQUFDO0FBQy9OLE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDaEQsT0FBTyxFQUFFLEtBQUssRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDeEMsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDL0QsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUV4RDs7O0dBR0c7QUFFSDtJQUtFOztPQUVHO0lBQ0gsMkJBQ1UsVUFBMkIsRUFDM0IsWUFBMEIsRUFDZCxhQUFnQyxFQUNoQyxlQUFnQztRQUg1QyxlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUNkLGtCQUFhLEdBQWIsYUFBYSxDQUFtQjtRQUNoQyxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFUOUMsc0JBQWlCLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQUN2Qyx3QkFBbUIsR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDO1FBVS9DLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFO1lBQ3pCLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxlQUFlLEVBQUUsQ0FBQztTQUM5QztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNJLG9DQUFRLEdBQWY7UUFBQSxpQkFjQztRQWJDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLENBQUMsU0FBUyxDQUNqQyxVQUFDLE1BQWdCOzs7Z0JBQ2YsS0FBcUIsSUFBQSxXQUFBLGlCQUFBLE1BQU0sQ0FBQSw4QkFBQSxrREFBRTtvQkFBeEIsSUFBTSxNQUFNLG1CQUFBO29CQUNmLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxTQUFTLENBQUMsVUFBQyxNQUF3Qjt3QkFDbkQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUU7NEJBQ25CLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7NEJBQ3RCLEtBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7eUJBQ3JDO29CQUNILENBQUMsQ0FBQyxDQUFDO2lCQUNKOzs7Ozs7Ozs7UUFDSCxDQUFDLENBQ0YsQ0FBQztRQUNGLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDO0lBQ2hDLENBQUM7SUFDRDs7T0FFRztJQUNJLDhDQUFrQixHQUF6QjtRQUFBLGlCQW9OQztRQW5OQyxJQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQztRQUN0RCxtQkFBbUI7UUFDbkIsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUNsRSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ2pCLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2pCO1FBQ0QsZUFBZTtRQUNmLElBQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzVFLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNqQjtRQUVELElBQU0sUUFBUSxHQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDcEMsSUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUM7UUFDOUMsSUFBSSxhQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLHNDQUFzQztRQUN0QywwQ0FBMEM7UUFDMUMsSUFBSSxTQUFTLEtBQUssSUFBSSxFQUFFO1lBQ3RCLHdCQUF3QjtZQUN4QixhQUFhLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsMkJBQTJCLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDekc7YUFBTTtZQUNMLDBCQUEwQjtZQUMxQixhQUFhLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztTQUNyRjtRQUVELElBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUNsQyxJQUFNLHlCQUF5QixHQUFHLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO1FBQ25FLElBQUksYUFBYSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUNyRCxJQUFJLE9BQU8sSUFBSSx5QkFBeUIsRUFBRTtZQUN4QyxhQUFhLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQywwQkFBMEIsRUFBRSxDQUFDLFNBQVMsQ0FBQztTQUMxRTtRQUVELElBQUksVUFBVSxHQUFHLEtBQUssQ0FBQztRQUN2QixJQUFNLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDdEIsYUFBYSxDQUFDLE9BQU8sQ0FBQyxVQUFDLFlBQTBCO1lBQy9DLElBQUksWUFBWSxDQUFDLElBQUksSUFBSSxZQUFZLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRTtnQkFDekQsVUFBVSxHQUFHLElBQUksQ0FBQzthQUNuQjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFVBQVUsSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN0QyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNqQjtRQUNELGFBQWEsQ0FBQyxrQkFBa0IsR0FBRyxFQUFFLENBQUM7UUFDdEMsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLElBQUksV0FBVyxHQUFHLElBQUksQ0FBQztRQUN2QixJQUFNLG1CQUFtQixHQUFHLElBQUksR0FBRyxFQUEwQixDQUFDO1FBQzlELGFBQWEsQ0FBQyxPQUFPLENBQUMsVUFBQyxXQUF5QjtZQUM5QyxJQUFNLGFBQWEsR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQzFELG1CQUFtQjtZQUNuQixhQUFhLElBQUksYUFBYSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzFELElBQUksV0FBVyxDQUFDLElBQUksSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRTtnQkFDdkQsaUJBQWlCO2dCQUNqQixJQUFNLDBCQUEwQixHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztnQkFDekUsMEJBQTBCLENBQUMsT0FBTyxDQUFDLFVBQUMsS0FBSyxFQUFFLElBQUk7b0JBQzdDLElBQUksbUJBQW1CLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO3dCQUNqQyxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQUEsSUFBSSxJQUFJLE9BQUEsbUJBQW1CLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBeEMsQ0FBd0MsQ0FBQyxDQUFDO3FCQUNqRTt5QkFBTTt3QkFDTCxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsSUFBSSxtQkFBTSxLQUFLLEVBQUUsQ0FBQztxQkFDM0M7Z0JBQ0gsQ0FBQyxDQUFDLENBQUM7Z0JBQ0gsV0FBVyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDNUMscUJBQXFCO2dCQUNyQixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRTtvQkFDbkMsVUFBVSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ2xDLFNBQVMsR0FBRyxLQUFLLENBQUM7aUJBQ25CO2FBQ0Y7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILFNBQVM7UUFDVCxJQUFNLGNBQWMsR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLFVBQUMsTUFBYztZQUNqRCxJQUFNLEtBQUssR0FBRyxLQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNuRixPQUFPLE1BQU0sQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLFNBQVMsRUFBRSxtQkFBbUIsRUFBRSxJQUFJLEVBQUUsS0FBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzdGLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBTSxPQUFPLEdBQUcsR0FBRyxnQ0FBSSxjQUFjLEdBQUUsSUFBSSxDQUN6QyxHQUFHLENBQUMsVUFBQyxVQUFVO1lBQ2IsYUFBYSxDQUFDLE9BQU8sQ0FBQyxVQUFDLFdBQXlCO2dCQUM5QyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUU7b0JBQ3BDLE9BQU87aUJBQ1I7Z0JBQ0QsSUFBTSxZQUFZLEdBQUcsVUFBQyxNQUF5QjtvQkFDN0MsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFDLGVBQWdDO3dCQUM5QyxJQUFJLGVBQWUsQ0FBQyxRQUFRLElBQUksZUFBZSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUU7NEJBQy9ELFlBQVksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7eUJBQ3hDO3dCQUNELElBQU0sU0FBUyxHQUFHLEVBQUUsQ0FBQzt3QkFDckIsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDO3dCQUNaLElBQU0sTUFBTSxHQUFHLFVBQUMsTUFBVzs0QkFDekIsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLElBQUksSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQ0FDM0MsRUFBRSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2dDQUNwQixPQUFPOzZCQUNSO2lDQUFNLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxFQUFFO2dDQUMvQixNQUFNLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7NkJBQzlCO3dCQUNILENBQUMsQ0FBQzt3QkFDRixNQUFNLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDO3dCQUUvQixxQkFBcUI7d0JBQ3JCLFlBQVk7d0JBQ1osSUFBSSxjQUFjLEdBQUc7NEJBQ25CLElBQUksRUFBRSxFQUFFOzRCQUNSLEtBQUssRUFBRSxLQUFLOzRCQUNaLE1BQU0sRUFBRSxLQUFLO3lCQUNkLENBQUM7d0JBQ0YsSUFBSSxlQUFlLENBQUMsTUFBTSxFQUFFOzRCQUMxQixjQUFjLEdBQUcsZUFBZSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQzt5QkFDcEQ7d0JBQ0QsSUFBTSxXQUFXLEdBQUcsR0FBRyxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO3dCQUN4RCxJQUFJLGVBQWUsQ0FBQyxXQUFXLEVBQUU7NEJBQy9CLE1BQU0sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFBLEdBQUc7Z0NBQ2xELFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRztvQ0FDZixJQUFJLEVBQUUsZUFBZSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUM7aUNBQ3ZDLENBQUM7Z0NBQ0YsaUVBQWlFO2dDQUNqRSwrQ0FBK0M7Z0NBQy9DLGNBQWM7Z0NBQ2Qsa0JBQWtCO2dDQUNsQiw2Q0FBNkM7Z0NBQzdDLG1CQUFtQjtnQ0FDbkIsT0FBTztnQ0FDUCxJQUFJOzRCQUNOLENBQUMsQ0FBQyxDQUFDO3lCQUNKO3dCQUNELElBQU0sS0FBSyxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQzt3QkFFbkUsZ0VBQWdFO3dCQUNoRSx1QkFBdUI7d0JBQ3ZCLFdBQVcsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQzs0QkFDbkMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxZQUFZOzRCQUM3QixFQUFFLElBQUE7NEJBQ0YsSUFBSSxFQUFFLEtBQUs7NEJBQ1gsS0FBSyxFQUFFLGNBQWMsQ0FBQyxLQUFLOzRCQUMzQixNQUFNLEVBQUUsY0FBYyxDQUFDLE1BQU07NEJBQzdCLEtBQUssRUFBRSxlQUFlLENBQUMsS0FBSzs0QkFDNUIsTUFBTSxFQUFFLFNBQVM7eUJBQ2xCLENBQUMsQ0FBQzt3QkFDSCxHQUFHO29CQUNMLENBQUMsQ0FBQyxDQUFDO2dCQUNMLENBQUMsQ0FBQztnQkFDRixTQUFTO2dCQUNULElBQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsVUFBQyxNQUF3QixJQUFLLE9BQUEsTUFBTSxDQUFDLE9BQU8sRUFBZCxDQUFjLENBQUMsQ0FBQztnQkFDakYsMkJBQTJCO2dCQUMzQixTQUFTO2dCQUNULElBQUksV0FBVyxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsRUFBRCxDQUFDLENBQUMsQ0FBQyxNQUFNLEtBQUssY0FBYyxDQUFDLE1BQU0sRUFBRTtvQkFDL0QsdUJBQXVCO29CQUN2QixXQUFXLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7d0JBQ25DLElBQUksRUFBRSxVQUFVLENBQUMsWUFBWTt3QkFDN0IsSUFBSSxFQUFFLEVBQUU7cUJBQ1QsQ0FBQyxDQUFDO29CQUNILGdCQUFnQjtvQkFDaEIsSUFBSSxTQUFTLEVBQUU7d0JBQ2IsSUFBTSxhQUFhLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQzt3QkFDMUQsYUFBYSxJQUFJLGFBQWEsQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsQ0FBQzt3QkFDM0QsSUFBTSxJQUFJLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQzt3QkFDOUIsSUFBSSxJQUFJLEVBQUU7NEJBQ1IsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDO3lCQUNsQztxQkFDRjtpQkFDRjtxQkFBTTtvQkFDTCxVQUFVO29CQUNWLFdBQVcsR0FBRyxLQUFLLENBQUM7b0JBQ3BCLFVBQVUsQ0FBQyxPQUFPLENBQUMsVUFBQyxNQUF3Qjt3QkFDMUMsSUFBSSxNQUFNLENBQUMsT0FBTyxFQUFFOzRCQUNsQixZQUFZOzRCQUNaLFdBQVcsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQztnQ0FDbkMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxZQUFZO2dDQUM3QixJQUFJLEVBQUUsRUFBRTs2QkFDVCxDQUFDLENBQUM7eUJBQ0o7NkJBQU07NEJBQ0wsWUFBWSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQzt5QkFDN0I7b0JBQ0gsQ0FBQyxDQUFDLENBQUM7aUJBQ0o7WUFDSCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxFQUNGLFNBQVMsQ0FBQyxVQUFDLFVBQVU7WUFDbkIsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDO1lBQ3ZCLElBQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQztZQUNsQixVQUFVLENBQUMsT0FBTyxDQUFDLFVBQUMsTUFBd0I7Z0JBQzFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFO29CQUNuQixXQUFXLEdBQUcsS0FBSyxDQUFDO2lCQUNyQjtnQkFDRCxNQUFNLENBQUMsSUFBSSxPQUFYLE1BQU0sbUJBQVMsTUFBTSxDQUFDLE1BQU0sR0FBRTtZQUNoQyxDQUFDLENBQUMsQ0FBQztZQUNILElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQ3JCLEtBQUksQ0FBQyx1QkFBdUIsQ0FBQyxhQUFhLEVBQUUsTUFBTSxFQUFFLEtBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDbEY7WUFDRCw0RUFBNEU7WUFDNUUsSUFBSSxrQkFBa0IsR0FBRyxhQUFhLENBQUMsa0JBQWtCLENBQUM7WUFDMUQsSUFBSSxPQUFPLElBQUkseUJBQXlCLEVBQUU7Z0JBQ3hDLGtCQUFrQixHQUFHLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsVUFBQSxJQUFJLElBQUksT0FBQSxJQUFJLENBQUMsU0FBUyxLQUFLLFNBQVMsRUFBNUIsQ0FBNEIsQ0FBQyxDQUFDO2FBQ3BHO1lBQ0QsYUFBYSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQzNELEtBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1lBQzdCLElBQUksV0FBVyxJQUFJLENBQUMsU0FBUyxFQUFFO2dCQUM3QixxQ0FBcUM7Z0JBQ3JDLE9BQU8sQ0FBQyxJQUFJLENBQUMsaURBQWlELENBQUMsQ0FBQzthQUNqRTtZQUNELDZDQUE2QztZQUM3QyxJQUFJLFdBQVcsRUFBRTtnQkFDZixJQUFNLGFBQWEsR0FBRyxLQUFJLENBQUMsNEJBQTRCLENBQUMsY0FBYyxDQUFDLENBQUM7Z0JBQ3hFLElBQUksQ0FBQyxhQUFhLEVBQUU7b0JBQ2xCLE9BQU8sS0FBSyxDQUFDO2lCQUNkO2dCQUNELE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ2pCO2lCQUFNO2dCQUNMLE9BQU8sS0FBSyxFQUFFLENBQUM7YUFDaEI7UUFDSCxDQUFDLENBQUMsQ0FDSCxDQUFDO1FBQ0YsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUNEOztPQUVHO0lBQ0gsdUNBQVcsR0FBWDtRQUFBLGlCQXFNQztRQXBNQyxJQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQztRQUN0RCxtQkFBbUI7UUFDbkIsSUFBTSxRQUFRLEdBQWEsSUFBSSxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUM3RSxJQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQztRQUM5QyxJQUFJLGFBQWEsR0FBRyxFQUFFLENBQUM7UUFDdkIsSUFBSSxTQUFTLEtBQUssSUFBSSxFQUFFO1lBQ3RCLHdCQUF3QjtZQUN4QixhQUFhLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsMkJBQTJCLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDekc7YUFBTTtZQUNMLDBCQUEwQjtZQUMxQixhQUFhLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztTQUNyRjtRQUVELElBQUksVUFBVSxHQUFHLEtBQUssQ0FBQztRQUN2QixJQUFNLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDdEIsYUFBYSxDQUFDLE9BQU8sQ0FBQyxVQUFDLFlBQTBCO1lBQy9DLElBQUksWUFBWSxDQUFDLElBQUksSUFBSSxZQUFZLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRTtnQkFDekQsVUFBVSxHQUFHLElBQUksQ0FBQzthQUNuQjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFVBQVUsSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN0QyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNqQjtRQUNELElBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUNsQyxJQUFNLHlCQUF5QixHQUFHLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO1FBQ25FLElBQUksYUFBYSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUNyRCxJQUFJLE9BQU8sSUFBSSx5QkFBeUIsRUFBRTtZQUN4QyxhQUFhLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQywwQkFBMEIsRUFBRSxDQUFDLFNBQVMsQ0FBQztTQUMxRTtRQUVELElBQUksU0FBUyxHQUFHLElBQUksQ0FBQztRQUNyQixJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDdkIsSUFBTSxtQkFBbUIsR0FBRyxJQUFJLEdBQUcsRUFBMEIsQ0FBQztRQUM5RCxhQUFhLENBQUMsT0FBTyxDQUFDLFVBQUMsV0FBeUI7WUFDOUMsSUFBTSxhQUFhLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUMxRCxtQkFBbUI7WUFDbkIsYUFBYSxJQUFJLGFBQWEsQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMxRCxJQUFJLFdBQVcsQ0FBQyxJQUFJLElBQUksV0FBVyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUU7Z0JBQ3ZELGlCQUFpQjtnQkFDakIsSUFBTSwwQkFBMEIsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7Z0JBQ3pFLDBCQUEwQixDQUFDLE9BQU8sQ0FBQyxVQUFDLEtBQUssRUFBRSxJQUFJO29CQUM3QyxJQUFJLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRTt3QkFDakMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQXhDLENBQXdDLENBQUMsQ0FBQztxQkFDakU7eUJBQU07d0JBQ0wsbUJBQW1CLENBQUMsR0FBRyxDQUFDLElBQUksbUJBQU0sS0FBSyxFQUFFLENBQUM7cUJBQzNDO2dCQUNILENBQUMsQ0FBQyxDQUFDO2dCQUNILFdBQVcsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzVDLHFCQUFxQjtnQkFDckIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUU7b0JBQ25DLFVBQVUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUNsQyxTQUFTLEdBQUcsS0FBSyxDQUFDO2lCQUNuQjthQUNGO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxvQkFBb0I7UUFDcEIsSUFBTSxvQkFBb0IsR0FBRyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUVqRCxTQUFTO1FBQ1QsSUFBTSxjQUFjLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFDLE1BQWMsRUFBRSxLQUFhO1lBQ2hFLE9BQUEsTUFBTSxDQUFDLFFBQVEsQ0FBQyxTQUFTLEVBQUUsU0FBUyxFQUFFLG1CQUFtQixFQUFFLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFJLENBQUMsWUFBWSxDQUFDO1FBQWxILENBQWtILENBQUMsQ0FBQztRQUN0SCxJQUFNLE9BQU8sR0FBRyxHQUFHLGdDQUFJLGNBQWMsR0FBRSxJQUFJLENBQ3pDLEdBQUcsQ0FBQyxVQUFDLFVBQVU7WUFDYixhQUFhLENBQUMsT0FBTyxDQUFDLFVBQUMsV0FBeUI7Z0JBQzlDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRTtvQkFDcEMsT0FBTztpQkFDUjtnQkFDRCxJQUFNLFlBQVksR0FBRyxVQUFDLE1BQXlCO29CQUM3QyxNQUFNLENBQUMsT0FBTyxDQUFDLFVBQUMsZUFBZ0M7d0JBQzlDLElBQUksZUFBZSxDQUFDLFFBQVEsSUFBSSxlQUFlLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRTs0QkFDL0QsWUFBWSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQzt5QkFDeEM7d0JBQ0QsSUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO3dCQUNyQixJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUM7d0JBQ1osSUFBTSxNQUFNLEdBQUcsVUFBQyxNQUFXOzRCQUN6QixJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFO2dDQUMzQyxFQUFFLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7Z0NBQ3BCLE9BQU87NkJBQ1I7aUNBQU0sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLEVBQUU7Z0NBQy9CLE1BQU0sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQzs2QkFDOUI7d0JBQ0gsQ0FBQyxDQUFDO3dCQUNGLE1BQU0sQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUM7d0JBRS9CLHFCQUFxQjt3QkFDckIsWUFBWTt3QkFDWixJQUFJLGNBQWMsR0FBRzs0QkFDbkIsSUFBSSxFQUFFLEVBQUU7NEJBQ1IsS0FBSyxFQUFFLEtBQUs7NEJBQ1osTUFBTSxFQUFFLEtBQUs7eUJBQ2QsQ0FBQzt3QkFDRixJQUFJLGVBQWUsQ0FBQyxNQUFNLEVBQUU7NEJBQzFCLGNBQWMsR0FBRyxlQUFlLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO3lCQUNwRDt3QkFDRCxJQUFNLFdBQVcsR0FBRyxHQUFHLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7d0JBQ3hELElBQUksZUFBZSxDQUFDLFdBQVcsRUFBRTs0QkFDL0IsTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsV0FBVyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUEsR0FBRztnQ0FDbEQsU0FBUyxDQUFDLEdBQUcsQ0FBQyxHQUFHO29DQUNmLElBQUksRUFBRSxlQUFlLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQztpQ0FDdkMsQ0FBQztnQ0FDRixpRUFBaUU7Z0NBQ2pFLCtDQUErQztnQ0FDL0MsY0FBYztnQ0FDZCxrQkFBa0I7Z0NBQ2xCLDZDQUE2QztnQ0FDN0MsbUJBQW1CO2dDQUNuQixPQUFPO2dDQUNQLElBQUk7NEJBQ04sQ0FBQyxDQUFDLENBQUM7eUJBQ0o7d0JBQ0QsSUFBTSxLQUFLLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO3dCQUVuRSxnRUFBZ0U7d0JBQ2hFLHVCQUF1Qjt3QkFDdkIsV0FBVyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDOzRCQUNuQyxJQUFJLEVBQUUsVUFBVSxDQUFDLFlBQVk7NEJBQzdCLEVBQUUsSUFBQTs0QkFDRixJQUFJLEVBQUUsS0FBSzs0QkFDWCxLQUFLLEVBQUUsY0FBYyxDQUFDLEtBQUs7NEJBQzNCLE1BQU0sRUFBRSxjQUFjLENBQUMsTUFBTTs0QkFDN0IsS0FBSyxFQUFFLGVBQWUsQ0FBQyxLQUFLOzRCQUM1QixNQUFNLEVBQUUsU0FBUzt5QkFDbEIsQ0FBQyxDQUFDO3dCQUNILEdBQUc7b0JBQ0wsQ0FBQyxDQUFDLENBQUM7Z0JBQ0wsQ0FBQyxDQUFDO2dCQUNGLFNBQVM7Z0JBQ1QsSUFBTSxXQUFXLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxVQUFDLE1BQXdCLElBQUssT0FBQSxNQUFNLENBQUMsT0FBTyxFQUFkLENBQWMsQ0FBQyxDQUFDO2dCQUNqRiwyQkFBMkI7Z0JBQzNCLFNBQVM7Z0JBQ1QsSUFBSSxXQUFXLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFELENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxjQUFjLENBQUMsTUFBTSxFQUFFO29CQUMvRCx1QkFBdUI7b0JBQ3ZCLFdBQVcsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQzt3QkFDbkMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxZQUFZO3dCQUM3QixJQUFJLEVBQUUsRUFBRTtxQkFDVCxDQUFDLENBQUM7b0JBQ0gsZ0JBQWdCO29CQUNoQixJQUFJLFNBQVMsRUFBRTt3QkFDYixJQUFNLGFBQWEsR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxDQUFDO3dCQUMxRCxhQUFhLElBQUksYUFBYSxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDO3dCQUMzRCxJQUFNLElBQUksR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDO3dCQUM5QixJQUFJLElBQUksRUFBRTs0QkFDUixJQUFJLENBQUMsb0JBQW9CLENBQUMsS0FBSyxDQUFDLENBQUM7eUJBQ2xDO3FCQUNGO2lCQUNGO3FCQUFNO29CQUNMLFVBQVU7b0JBQ1YsV0FBVyxHQUFHLEtBQUssQ0FBQztvQkFDcEIsVUFBVSxDQUFDLE9BQU8sQ0FBQyxVQUFDLE1BQXdCO3dCQUMxQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUU7NEJBQ2xCLFlBQVk7NEJBQ1osV0FBVyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO2dDQUNuQyxJQUFJLEVBQUUsVUFBVSxDQUFDLFlBQVk7Z0NBQzdCLElBQUksRUFBRSxFQUFFOzZCQUNULENBQUMsQ0FBQzt5QkFDSjs2QkFBTTs0QkFDTCxZQUFZLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO3lCQUM3QjtvQkFDSCxDQUFDLENBQUMsQ0FBQztpQkFDSjtZQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLEVBQ0YsU0FBUyxDQUFDLFVBQUMsVUFBVTtZQUNuQixJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUM7WUFDdkIsSUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDO1lBQ2xCLFVBQVUsQ0FBQyxPQUFPLENBQUMsVUFBQyxNQUF3QjtnQkFDMUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUU7b0JBQ25CLFdBQVcsR0FBRyxLQUFLLENBQUM7aUJBQ3JCO2dCQUNELE1BQU0sQ0FBQyxJQUFJLE9BQVgsTUFBTSxtQkFBUyxNQUFNLENBQUMsTUFBTSxHQUFFO1lBQ2hDLENBQUMsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDckIsS0FBSSxDQUFDLHVCQUF1QixDQUFDLGFBQWEsRUFBRSxNQUFNLEVBQUUsS0FBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQzthQUNsRjtZQUNELElBQUksa0JBQWtCLEdBQUcsYUFBYSxDQUFDLGtCQUFrQixDQUFDO1lBQzFELElBQUksT0FBTyxJQUFJLHlCQUF5QixFQUFFO2dCQUN4QyxrQkFBa0IsR0FBRyxhQUFhLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLFVBQUEsSUFBSSxJQUFJLE9BQUEsSUFBSSxDQUFDLFNBQVMsS0FBSyxTQUFTLEVBQTVCLENBQTRCLENBQUMsQ0FBQzthQUNwRztZQUNELDhDQUE4QztZQUM5QyxJQUFJLFdBQVcsSUFBSSxTQUFTLEVBQUU7Z0JBQzVCLGtCQUFrQixHQUFHLGFBQWEsQ0FBQyxrQkFBa0IsR0FBRyxFQUFFLENBQUM7YUFDNUQ7WUFDRCxhQUFhLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFDM0QsS0FBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7WUFDN0IsSUFBSSxXQUFXLEVBQUU7Z0JBQ2YsSUFBTSxhQUFhLEdBQUcsS0FBSSxDQUFDLDRCQUE0QixDQUFDLGNBQWMsQ0FBQyxDQUFDO2dCQUN4RSxJQUFJLENBQUMsYUFBYSxFQUFFO29CQUNsQixPQUFPLEtBQUssQ0FBQztpQkFDZDtnQkFDRCxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNqQjtpQkFBTTtnQkFDTCxPQUFPLEtBQUssRUFBRSxDQUFDO2FBQ2hCO1FBQ0gsQ0FBQyxDQUFDLENBQ0gsQ0FBQztRQUNGLE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFDRDs7O09BR0c7SUFDSyx3REFBNEIsR0FBcEMsVUFBcUMsY0FBNEI7UUFBakUsaUJBa0NDO1FBakNDLHVCQUF1QjtRQUN2QixJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsNEJBQTRCLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUM5QixPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsdUJBQXVCO1FBQ3ZCLElBQU0sWUFBWSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBQyxJQUFZO1lBQzdDLElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFELENBQUMsQ0FBQyxDQUFDO1lBQ3BELElBQU0sV0FBVyxHQUFHLEtBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQWdCLENBQUM7WUFDeEYsSUFBSSxDQUFDLFdBQVcsSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDMUMsT0FBTyxJQUFJLENBQUM7YUFDYjtZQUNELE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQyxDQUFDLENBQUM7UUFDSCxnQkFBZ0I7UUFDaEIsSUFBSSxZQUFZLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMzQixJQUFNLFlBQVUsR0FBRyxFQUFFLENBQUM7WUFDdEIsWUFBWSxDQUFDLE9BQU8sQ0FBQyxVQUFDLElBQVk7Z0JBQ2hDLDJFQUEyRTtnQkFDM0UseUZBQXlGO2dCQUN6RixZQUFZO2dCQUNaLHFRQUFxUTtnQkFDclEsa0VBQWtFO2dCQUNsRSxJQUFNLGFBQWEsR0FBRyxLQUFJLENBQUMsOEJBQThCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLDZCQUFPLElBQU0sQ0FBQztnQkFDNUYsWUFBVSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztnQkFDL0IsR0FBRztZQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFO2dCQUN0QixJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBSSxZQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsZ0JBQWtCLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQzthQUNuSDtZQUNELE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFDRDs7O09BR0c7SUFDSywwREFBOEIsR0FBdEMsVUFBdUMsWUFBc0I7UUFDM0QsSUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUM7UUFDOUMsSUFBSSxhQUFhLEdBQW1CLElBQUksQ0FBQztRQUN6QyxJQUFJLFNBQVMsS0FBSyxJQUFJLEVBQUU7WUFDdEIsd0JBQXdCO1lBQ3hCLGFBQWEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQywyQkFBMkIsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUN6RzthQUFNO1lBQ0wsMEJBQTBCO1lBQzFCLGFBQWEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1NBQ3JGO1FBQ0QsSUFBTSxXQUFXLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsRUFBRCxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDMUQsSUFBTSxZQUFZLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxVQUFDLFlBQTBCLElBQUssT0FBQSxZQUFZLENBQUMsU0FBUyxJQUFJLFlBQVksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEVBQUQsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFdBQVcsRUFBaEgsQ0FBZ0gsQ0FBQyxDQUFDO1FBQzFMLElBQU0sYUFBYSxHQUFHLFlBQVksSUFBSSxZQUFZLENBQUMsSUFBSSxJQUFJLFlBQVksQ0FBQyxJQUFJLENBQUMsYUFBYSxJQUFJLEVBQUUsQ0FBQztRQUNqRyxPQUFPLGFBQWEsQ0FBQztJQUN2QixDQUFDO0lBQ0Q7Ozs7O09BS0c7SUFDSyx3REFBNEIsR0FBcEMsVUFBcUMsY0FBNEIsRUFBRSxPQUFzQjtRQUF0Qix3QkFBQSxFQUFBLFlBQXNCO1FBQ3ZGLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDbkIsT0FBTztTQUNSO1FBQ0QsSUFBSSxDQUFDLGdDQUFnQyxDQUFDLGNBQWMsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUMvRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBQ08sNERBQWdDLEdBQXhDLFVBQXlDLGNBQTRCLEVBQUUsTUFBcUIsRUFBRSxhQUE0QjtRQUExSCxpQkF5QkM7UUF6QnNFLHVCQUFBLEVBQUEsV0FBcUI7UUFBRSw4QkFBQSxFQUFBLGtCQUE0QjtRQUN4SCxhQUFhO1FBQ2IsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLFVBQVUsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUM1RixJQUFJLFlBQVksS0FBSyxLQUFLLEVBQUU7WUFDMUIsSUFBSSxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDNUIsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUNqQjtpQkFBTTtnQkFDTCxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQzthQUN0QztTQUNGO1FBQ0QsU0FBUztRQUNULElBQU0sSUFBSSxHQUFHLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDcEUsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDM0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFDLFFBQXNCO2dCQUNsQyxJQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsUUFBUSxDQUFDO2dCQUNuQyxJQUFJLFFBQVEsSUFBSSxRQUFRLENBQUMsVUFBVSxFQUFFO29CQUNuQyxhQUFhLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7b0JBQ2pELEtBQUksQ0FBQyxnQ0FBZ0MsQ0FBQyxRQUFRLEVBQUUsTUFBTSxFQUFFLGFBQWEsQ0FBQyxDQUFDO2lCQUN4RTtZQUNILENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFDRCwrQkFBK0I7UUFDL0IsSUFBSSxhQUFhLElBQUksYUFBYSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDN0MsYUFBYSxDQUFDLEdBQUcsRUFBRSxDQUFDO1NBQ3JCO0lBQ0gsQ0FBQztJQUNPLHdDQUFZLEdBQXBCLFVBQXFCLEtBQXVCLEVBQUUsS0FBZTtRQUMzRCxJQUFJLEtBQUssS0FBSyxTQUFTLElBQUksS0FBSyxLQUFLLElBQUksSUFBSSxLQUFLLEtBQUssRUFBRSxFQUFFO1lBQ3pELE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxnQkFBZ0I7UUFDaEIsSUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLDRCQUE0QixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQy9ELElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDO1FBQzlDLElBQUksQ0FBQyxhQUFhLElBQUksYUFBYSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDOUMscUJBQXFCO1lBQ3JCLE9BQU8sQ0FBQyxJQUFJLENBQUMsOEJBQVEsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsZ1BBQTBDLENBQUMsQ0FBQztTQUNqRjthQUFNO1lBQ0wsTUFBTSxHQUFHLGFBQWEsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxjQUFjLENBQUM7U0FDN0M7UUFDRCxJQUFJLE9BQU8sS0FBSyxLQUFLLFNBQVMsRUFBRTtZQUM5QixPQUFPLEtBQUssQ0FBQztTQUNkO2FBQU0sSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUU7WUFDcEMsS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsWUFBVSxLQUFPLENBQUM7WUFDdEUsSUFBTSxPQUFPLEdBQUcsSUFBSSxRQUFRLENBQUMsMElBSXpCLEtBQUssYUFDUixDQUFDLENBQUM7WUFDSCxPQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDOUI7YUFBTTtZQUNMLE9BQU8sQ0FBQyxJQUFJLENBQUMsa0RBQVUsQ0FBQyxDQUFDO1NBQzFCO0lBQ0gsQ0FBQztJQUNELG1EQUF1QixHQUF2QixVQUF3QixhQUF3QixFQUFFLE1BQXlCLEVBQUUsU0FBaUIsRUFBRSxNQUFzQjtRQUF0SCxpQkFzQ0M7UUF0QytGLHVCQUFBLEVBQUEsYUFBc0I7UUFDcEgsSUFBSSxNQUFNLEVBQUU7WUFDVixhQUFhLENBQUMsa0JBQWtCLEdBQUcsYUFBYSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksQ0FBQyxTQUFTLEtBQUssU0FBUyxFQUE1QixDQUE0QixDQUFDLENBQUM7U0FDbEg7UUFDRCxNQUFNLENBQUMsT0FBTyxDQUFDLFVBQUMsZUFBZ0M7WUFDOUMsSUFBSSxlQUFlLENBQUMsUUFBUSxJQUFJLGVBQWUsQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFO2dCQUMvRCxLQUFJLENBQUMsdUJBQXVCLENBQUMsYUFBYSxFQUFFLGVBQWUsQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFDO2FBQ3pGO1lBQ0QsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDO1lBQ1osSUFBTSxNQUFNLEdBQUcsVUFBQyxNQUFXO2dCQUN6QixJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFO29CQUMzQyxFQUFFLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7b0JBQ3BCLE9BQU87aUJBQ1I7cUJBQU0sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLEVBQUU7b0JBQy9CLE1BQU0sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztpQkFDOUI7WUFDSCxDQUFDLENBQUM7WUFDRixNQUFNLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQy9CLElBQUksZUFBZSxDQUFDLFdBQVcsRUFBRTtnQkFDL0IsSUFBTSxxQkFBcUIsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDdkUsSUFBSSxxQkFBcUIsQ0FBQyxNQUFNLEVBQUU7b0JBQ2hDLElBQU0sTUFBTSxHQUFHLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsVUFBQSxJQUFJLElBQUksT0FBQSxJQUFJLENBQUMsU0FBUyxLQUFLLFNBQVMsRUFBNUIsQ0FBNEIsQ0FBQyxDQUFDLE1BQU0sQ0FBQztvQkFDcEcsSUFBSSxLQUFLLEdBQUcsYUFBYSxDQUFDLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksQ0FBQyxTQUFTLEtBQUssU0FBUyxFQUE1QixDQUE0QixDQUFDLENBQUM7b0JBQzdGLEtBQUssR0FBRyxLQUFLLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQztvQkFDMUMsYUFBYSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFO3dCQUNoRCxFQUFFLEVBQUUsRUFBRTt3QkFDTixTQUFTLFdBQUE7d0JBQ1QsV0FBVyxFQUFFLGVBQWUsQ0FBQyxLQUFLO3dCQUNsQyxLQUFLLEVBQUUsZUFBZSxDQUFDLEtBQUs7d0JBQzVCLEtBQUssRUFBRSxlQUFlLENBQUMsWUFBWTt3QkFDbkMsR0FBRyxFQUFFLGVBQWUsQ0FBQyxXQUFXLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQzFELFlBQVksRUFBRSxlQUFlLENBQUMsWUFBWTt3QkFDMUMsUUFBUSxFQUFFLGVBQWUsQ0FBQyxRQUFRO3dCQUNsQyxJQUFJLEVBQUUscUJBQXFCLENBQUMsQ0FBQyxDQUFDLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU87cUJBQ2xFLENBQUMsQ0FBQztpQkFDSjthQUNGO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0Q7O09BRUc7SUFDSSwyQ0FBZSxHQUF0QjtRQUNFLElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUNuQyxJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7UUFDckQsSUFBSSxRQUFRLEVBQUU7WUFDWixhQUFhLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQywwQkFBMEIsRUFBRSxDQUFDLFNBQVMsQ0FBQztTQUMxRTtRQUNELElBQUksa0JBQWtCLEdBQUcsYUFBYSxDQUFDLGtCQUFrQixDQUFDO1FBQzFELElBQUksa0JBQWtCLENBQUMsTUFBTSxFQUFFO1lBQzdCLElBQU0sV0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDO1lBQzlDLElBQUksV0FBUyxLQUFLLElBQUksRUFBRTtnQkFDdEIsa0JBQWtCLEdBQUcsYUFBYSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksQ0FBQyxTQUFTLEtBQUssV0FBUyxFQUE1QixDQUE0QixDQUFDLENBQUM7YUFDcEc7WUFDRCxhQUFhLENBQUMsa0JBQWtCLEdBQUcsa0JBQWtCLENBQUM7WUFDdEQsc0ZBQXNGO1NBQ3ZGO1FBQ0QsSUFBSSxhQUFhLElBQUksYUFBYSxDQUFDLG1CQUFtQixFQUFFO1lBQ3RELGFBQWEsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztTQUM1RDtRQUNELE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xCLENBQUM7SUFDRDs7T0FFRztJQUNLLHNDQUFVLEdBQWxCO1FBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsMEJBQTBCLEVBQUUsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLDBCQUEwQixFQUFFLENBQUMsY0FBYyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsMEJBQTBCLEVBQUUsQ0FBQyxjQUFjLENBQUMsdUJBQXVCLENBQUMsSUFBSSxLQUFLLENBQUM7SUFDalAsQ0FBQztJQUNEOztPQUVHO0lBQ0sscURBQXlCLEdBQWpDO1FBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQXNCLG1CQUFtQixFQUFFLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFzQixtQkFBbUIsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUFBLENBQUM7SUFDNUwsQ0FBQztJQUNEOzs7O09BSUc7SUFDSyx3REFBNEIsR0FBcEMsVUFBcUMsWUFBc0I7UUFDekQsSUFBTSxXQUFXLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsRUFBRCxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDMUQsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLE1BQU0sQ0FBQyxVQUFBLFlBQVksSUFBSSxPQUFBLFlBQVksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEVBQUQsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFdBQVcsRUFBdEYsQ0FBc0YsQ0FBQyxDQUFDO0lBQzVMLENBQUM7SUFDRCxzQkFBWSxrREFBbUI7YUFBL0I7WUFDRSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBc0IsbUJBQW1CLEVBQUUsSUFBSSxFQUFFLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMxRyxDQUFDOzs7T0FBQTtJQUNPLGlEQUFxQixHQUE3QjtRQUFBLGlCQU1DO1FBTEMsSUFBSSxJQUFJLENBQUMsbUJBQW1CLElBQUksSUFBSSxDQUFDLG1CQUFtQixDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsbUJBQW1CLENBQUMsZUFBZSxDQUFDLFFBQVEsRUFBRTtZQUM3SCxJQUFJLENBQUMsbUJBQW1CLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLFVBQUMsSUFBUztnQkFDbkYsS0FBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzlCLENBQUMsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDO0lBQ08sNENBQWdCLEdBQXhCLFVBQXlCLElBQTZKO1FBQTdKLHFCQUFBLEVBQUEsU0FBNEYsWUFBWSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRTtRQUM1SyxJQUFBLGdDQUFZLEVBQUUsWUFBRSxFQUFFLDhCQUFXLEVBQUUsd0JBQVEsQ0FBVTtRQUN6RCxJQUFNLGVBQWUsR0FBRyxZQUFZLElBQUksWUFBWSxDQUFDLGNBQWMsQ0FBQyxlQUFlLElBQUksS0FBSyxDQUFDO1FBQzdGLElBQUksQ0FBQyxlQUFlLEVBQUU7WUFDcEIsSUFBSSxDQUFDLFdBQVcsRUFBRSxHQUFHO1lBQ3JCLElBQU0sVUFBVSxHQUFHLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxJQUFJLEVBQUUsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUNoSSxhQUFhLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FBQztZQUNwRCxJQUFJLENBQUMsbUJBQW1CLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO1NBQ3BFO2FBQU07WUFDTCxzQkFBc0I7WUFDdEIsSUFBTSxJQUFJLEdBQXNCLFlBQVksQ0FBQyxtQkFBbUIsQ0FBQyxrQkFBa0IsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1lBQ3ZHLElBQUksSUFBSSxJQUFJLFdBQVcsSUFBSSxFQUFFLEVBQUU7Z0JBQzdCLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFLFdBQVcsQ0FBQyxDQUFDO2dCQUMvQixJQUFJLENBQUMsbUJBQW1CLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO2FBQ3BFO1NBQ0Y7SUFDSCxDQUFDOztnQkFockJGLFVBQVU7Ozs7Z0JBakJGLFVBQVU7Z0JBQVUsWUFBWTtnQkFPaEMsaUJBQWlCLHVCQXFCckIsUUFBUTtnQkFwQkosZUFBZSx1QkFxQm5CLFFBQVE7O0lBcXFCYix3QkFBQztDQUFBLEFBanJCRCxJQWlyQkM7QUFFRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlOiBtYXgtbGluZS1sZW5ndGhcclxuaW1wb3J0IHsgRWxlbWVudFJlZiwgSW5qZWN0RmxhZ3MsIEluamVjdGFibGUsIE9wdGlvbmFsLCBTZWxmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnksIEVudGl0eSwgRnJhbWVDb250ZXh0LCBQQVJFTlRfQ0xBU1MsIENoYW5nZVR5cGUsIFZhbGlkYXRpb25SZXN1bHQsIFZhbGlkYXRpb25FcnJvciwgVmFsaWRhdGVSdWxlLCBWaWV3TW9kZWwsIERhdGFUeXBlSW5mbywgRGF0YVByb3BHcm91cCwgRGF0YVByb3BJbmZvLCBCaW5kaW5nTGlzdCwgQ29tcG9uZW50VHlwZSB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgdGFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEVNUFRZLCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHppcCB9IGZyb20gJ3J4anMvb2JzZXJ2YWJsZS96aXAnO1xyXG5pbXBvcnQgeyBlbXB0eSB9IGZyb20gJ3J4anMvb2JzZXJ2YWJsZS9lbXB0eSc7XHJcbmltcG9ydCB7IG9mIH0gZnJvbSAncnhqcy9vYnNlcnZhYmxlL29mJztcclxuaW1wb3J0IHsgVmVyaWZ5RGV0YWlsU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktdmVyaWZ5LWRldGFpbCc7XHJcbmltcG9ydCB7IEZvcm1Ob3RpZnlTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLW5vdGlmeS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9sYW5ndWFnLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBWZXJpZnlTZXJ2aWNlIH0gZnJvbSAnLi92ZXJpZnkuc2VydmljZSc7XHJcbmltcG9ydCB7IERhdGFncmlkQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1kYXRhZ3JpZCc7XHJcblxyXG4vKipcclxuICog6KGo5Y2V6aqM6K+B5pyN5YqhXHJcbiAqIEBzY29wZSBGcmFtZUNvbXBvbmVudFxyXG4gKi9cclxuXHJcbkBJbmplY3RhYmxlKClcclxuY2xhc3MgVmFsaWRhdGlvblNlcnZpY2Uge1xyXG5cclxuICBwcml2YXRlIHZhbGlkYXRpb25SZXN1bHRzID0gbmV3IFN1YmplY3Q8YW55PigpO1xyXG4gIHByaXZhdGUgdmFsaWRhdGlvbkFsbFJlc3VsdCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+LFxyXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgbm90aWZ5U2VydmljZTogRm9ybU5vdGlmeVNlcnZpY2UsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlXHJcbiAgKSB7XHJcbiAgICBpZiAoIXRoaXMubGFuZ3VhZ2VTZXJ2aWNlKSB7XHJcbiAgICAgIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlID0gbmV3IExhbmd1YWdlU2VydmljZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6aqM6K+B6KGo5Y2V5YaF55qE5omA5pyJ6KGo5Y2VXHJcbiAgICovXHJcbiAgcHVibGljIHZhbGlkYXRlKCkge1xyXG4gICAgdGhpcy5yZXBvc2l0b3J5LmdldExpc3QoKS5zdWJzY3JpYmUoXHJcbiAgICAgIChyZXN1bHQ6IEVudGl0eVtdKSA9PiB7XHJcbiAgICAgICAgZm9yIChjb25zdCBlbnRpdHkgb2YgcmVzdWx0KSB7XHJcbiAgICAgICAgICBlbnRpdHkudmFsaWRhdGUoKS5zdWJzY3JpYmUoKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIXJlc3VsdC5pc1ZhbGlkKSB7XHJcbiAgICAgICAgICAgICAgYWxlcnQocmVzdWx0Lm1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgIHRoaXMudmFsaWRhdGlvblJlc3VsdHMubmV4dChyZXN1bHQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICk7XHJcbiAgICByZXR1cm4gdGhpcy52YWxpZGF0aW9uUmVzdWx0cztcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5qCh6aqM5b2T5YmN6KGMXHJcbiAgICovXHJcbiAgcHVibGljIHZhbGlkYXRlQ3VycmVudFJvdygpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3QgZW50aXR5VHlwZUluZm8gPSB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm87XHJcbiAgICAvLyDnu4TlkIjooajljZXlj6rmoKHpqozlvZPliY3mjInpkq7miYDlnKjnmoTooajljZVcclxuICAgIGNvbnN0IHByaW1hcnlWYWx1ZSA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkO1xyXG4gICAgaWYgKCFwcmltYXJ5VmFsdWUpIHtcclxuICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgfVxyXG4gICAgLy8g6aaW5YWI5qCh6aqM5a6e5L2T5LiN6IO95Li656m66KeE5YiZXHJcbiAgICBjb25zdCBlbnRpdHkgPSB0aGlzLnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdHlCeUlkKHByaW1hcnlWYWx1ZSk7XHJcbiAgICBpZiAoIWVudGl0eSkge1xyXG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZW50aXRpZXM6IEVudGl0eVtdID0gW2VudGl0eV07XHJcbiAgICBjb25zdCBuYW1lc3BhY2UgPSB0aGlzLmZyYW1lQ29udGV4dC5uYW1lc3BhY2U7XHJcbiAgICBsZXQgZnJhbWVDb250ZXh0cyA9IFtdO1xyXG4gICAgLy8g5L+u5aSN5L2/55So55u45ZCMYmXliJvlu7rnmoR2b+eahOe7hOWQiOihqOWNleagoemqjOaXtuWkmuS4quihqOWNleagoemqjOinhOWImeiiq+WQiOW5tueahOmXrumimFxyXG4gICAgLy8gVE9ETzog55uu5YmN5pyq6ICD6JmR57uE5ZCI6KGo5Y2V57uf5LiA5L+d5a2Y55qE5Zy65pmv77yM5ZCO57ut5pSv5oyB57uE5ZCI6KGo5Y2V57uf5LiA5L+d5a2Y5pe25YaN5L+u5pS5XHJcbiAgICBpZiAobmFtZXNwYWNlICE9PSBudWxsKSB7XHJcbiAgICAgIC8vIOWtmOWcqOWRveWQjeepuumXtO+8jOivtOaYjuihqOWNlei+g+aWsO+8jOWPr+S7peS+nei1luivpeeJueaAp1xyXG4gICAgICBmcmFtZUNvbnRleHRzID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHNCeU5hbWVzcGFjZShuYW1lc3BhY2UpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8g6KGo5Y2V6L6D6ICB77yM6I635Y+W5omA5pyJ55qE5LiK5LiL5paH77yM5Zyo5qCh6aqM6Zi25q616L+H5ruk6KeE5YiZXHJcbiAgICAgIGZyYW1lQ29udGV4dHMgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGlzTW9kYWwgPSB0aGlzLmlzSW5EaWFsb2coKTtcclxuICAgIGNvbnN0IGhhc093blZlcmlmeURldGFpbFNlcnZpY2UgPSB0aGlzLmhhc093blZlcmlmeURldGFpbFNlcnZpY2UoKTtcclxuICAgIGxldCByb290Vmlld01vZGVsID0gdGhpcy5mcmFtZUNvbnRleHQucm9vdC52aWV3TW9kZWw7XHJcbiAgICBpZiAoaXNNb2RhbCAmJiBoYXNPd25WZXJpZnlEZXRhaWxTZXJ2aWNlKSB7XHJcbiAgICAgIHJvb3RWaWV3TW9kZWwgPSB0aGlzLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpLnZpZXdNb2RlbDtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgdG9WYWxpZGF0ZSA9IGZhbHNlO1xyXG4gICAgY29uc3QgZm9ybUVycm9ycyA9IFtdO1xyXG4gICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICBpZiAoZnJhbWVDb250ZXh0LmZvcm0gJiYgZnJhbWVDb250ZXh0LmZvcm0uZW5hYmxlVmFsaWRhdGUpIHtcclxuICAgICAgICB0b1ZhbGlkYXRlID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICBpZiAoIXRvVmFsaWRhdGUgfHwgZW50aXRpZXMubGVuZ3RoIDwgMSkge1xyXG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICB9XHJcbiAgICByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucyA9IFtdO1xyXG4gICAgbGV0IGZvcm1WYWxpZCA9IHRydWU7XHJcbiAgICBsZXQgZW50aXR5VmFsaWQgPSB0cnVlO1xyXG4gICAgY29uc3QgZm9ybVZhbGlkYXRpb25SdWxlcyA9IG5ldyBNYXA8c3RyaW5nLCBWYWxpZGF0ZVJ1bGVbXT4oKTtcclxuICAgIGZyYW1lQ29udGV4dHMuZm9yRWFjaCgoZm9ybUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gZm9ybUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0T2JqZWN0KCk7XHJcbiAgICAgIC8vIOmAmuefpeaJgOaciWJpbmRpbmdEYXRhLFxyXG4gICAgICBiaW5kaW5nT2JqZWN0ICYmIGJpbmRpbmdPYmplY3Quc2V0U2hvd1ZhbGlkYXRpb25Nc2codHJ1ZSk7XHJcbiAgICAgIGlmIChmb3JtQ29udGV4dC5mb3JtICYmIGZvcm1Db250ZXh0LmZvcm0uZW5hYmxlVmFsaWRhdGUpIHtcclxuICAgICAgICAvLyDojrflj5blvZPliY3ooajljZXkuIrnmoTmiYDmnInpqozor4Hop4TliJlcclxuICAgICAgICBjb25zdCBjdXJyZW50Rm9ybVZhbGlkYXRpb25SdWxlcyA9IGZvcm1Db250ZXh0LmZvcm0uZ2V0VmFsaWRhdGlvblJ1bGVzKCk7XHJcbiAgICAgICAgY3VycmVudEZvcm1WYWxpZGF0aW9uUnVsZXMuZm9yRWFjaCgocnVsZXMsIHBhdGgpID0+IHtcclxuICAgICAgICAgIGlmIChmb3JtVmFsaWRhdGlvblJ1bGVzLmhhcyhwYXRoKSkge1xyXG4gICAgICAgICAgICBydWxlcy5mb3JFYWNoKHJ1bGUgPT4gZm9ybVZhbGlkYXRpb25SdWxlcy5nZXQocGF0aCkucHVzaChydWxlKSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBmb3JtVmFsaWRhdGlvblJ1bGVzLnNldChwYXRoLCBbLi4ucnVsZXNdKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBmb3JtQ29udGV4dC5mb3JtLnNldFNob3dWYWxpZGF0aW9uTXNnKHRydWUpO1xyXG4gICAgICAgIC8vIOmAkOS4quiwg+eUqOihqOWNleeahOmqjOivge+8jOmqjOivgeWJjeerr+ihqOWNleinhOWImVxyXG4gICAgICAgIGlmICghZm9ybUNvbnRleHQuZm9ybS5pc0Zvcm1WYWxpZCgpKSB7XHJcbiAgICAgICAgICBmb3JtRXJyb3JzLnB1c2goZm9ybUNvbnRleHQuZm9ybSk7XHJcbiAgICAgICAgICBmb3JtVmFsaWQgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOmqjOivgeaJgOacieWunuS9k1xyXG4gICAgY29uc3Qgb2JzZXJ2YWJsZUxpc3QgPSBlbnRpdGllcy5tYXAoKGVudGl0eTogRW50aXR5KSA9PiB7XHJcbiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5nZXRJbmRleEJ5SWQoZW50aXR5LnByaW1hcnlWYWx1ZSk7XHJcbiAgICAgIHJldHVybiBlbnRpdHkudmFsaWRhdGUodW5kZWZpbmVkLCB1bmRlZmluZWQsIGZvcm1WYWxpZGF0aW9uUnVsZXMsIG51bGwsIHRoaXMuZnJhbWVDb250ZXh0KTtcclxuICAgIH0pO1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IHppcCguLi5vYnNlcnZhYmxlTGlzdCkucGlwZShcclxuICAgICAgdGFwKChyZXN1bHRMaXN0KSA9PiB7XHJcbiAgICAgICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKChmb3JtQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgICBpZiAoIWZvcm1Db250ZXh0LmZvcm0uZW5hYmxlVmFsaWRhdGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgaGFuZGxlRXJyb3JzID0gKGVycm9yczogVmFsaWRhdGlvbkVycm9yW10pID0+IHtcclxuICAgICAgICAgICAgZXJyb3JzLmZvckVhY2goKHZhbGlkYXRpb25FcnJvcjogVmFsaWRhdGlvbkVycm9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbiAmJiB2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4ubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBoYW5kbGVFcnJvcnModmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgY29uc3QgZXJyTXNnT2JqID0ge307XHJcbiAgICAgICAgICAgICAgbGV0IGlkID0gJyc7XHJcbiAgICAgICAgICAgICAgY29uc3QgZmluZElkID0gKHRhcmdldDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5kYXRhICYmIHRhcmdldC5kYXRhLmlkKSB7XHJcbiAgICAgICAgICAgICAgICAgIGlkID0gdGFyZ2V0LmRhdGEuaWQ7XHJcbiAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFyZ2V0W1BBUkVOVF9DTEFTU10pIHtcclxuICAgICAgICAgICAgICAgICAgZmluZElkKHRhcmdldFtQQVJFTlRfQ0xBU1NdKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgIGZpbmRJZCh2YWxpZGF0aW9uRXJyb3IudGFyZ2V0KTtcclxuXHJcbiAgICAgICAgICAgICAgLy8g5a6e5L2T6aqM6K+B5Ye66ZSZ77yM6ZyA6KaB5bCG6ZSZ6K+v5bGV56S65Yiw55WM6Z2i5LiKXHJcbiAgICAgICAgICAgICAgLy8g5a6e5L2T5LiN5LiA5a6a5piv5b2T5YmN6KGMXHJcbiAgICAgICAgICAgICAgbGV0IHBhcmVudFBhdGhEYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgcGF0aDogW10sXHJcbiAgICAgICAgICAgICAgICBpc1VkdDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBpc0dyaWQ6IGZhbHNlXHJcbiAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICBpZiAodmFsaWRhdGlvbkVycm9yLnRhcmdldCkge1xyXG4gICAgICAgICAgICAgICAgcGFyZW50UGF0aERhdGEgPSB2YWxpZGF0aW9uRXJyb3IudGFyZ2V0LmdldFBhdGhzKCk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gJy8nICsgcGFyZW50UGF0aERhdGEucGF0aC5qb2luKCcvJyk7XHJcbiAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50cykge1xyXG4gICAgICAgICAgICAgICAgT2JqZWN0LmtleXModmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzKS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIGVyck1zZ09ialtrZXldID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50c1trZXldXHJcbiAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgIC8vIGlmICh0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09IGJpbmRpbmdQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgIC8vICAgcm9vdFZpZXdNb2RlbFsndmVyaWZ5SW5mb3JtYXRpb25zJ10ucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgIC8vICAgICBpZDogaWQsXHJcbiAgICAgICAgICAgICAgICAgIC8vICAgICB0aXRsZToga2V5LFxyXG4gICAgICAgICAgICAgICAgICAvLyAgICAgbXNnOiB2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHNba2V5XSxcclxuICAgICAgICAgICAgICAgICAgLy8gICAgIHR5cGU6ICd3YXJuJ1xyXG4gICAgICAgICAgICAgICAgICAvLyAgIH0pXHJcbiAgICAgICAgICAgICAgICAgIC8vIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBjb25zdCBwYXRocyA9IHBhcmVudFBhdGhEYXRhLnBhdGguY29uY2F0KHZhbGlkYXRpb25FcnJvci5wcm9wZXJ0eSk7XHJcblxyXG4gICAgICAgICAgICAgIC8vaWYgKHRoaXMuZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCA9PT0gYmluZGluZ1BhdGgpIHtcclxuICAgICAgICAgICAgICAvLyDlsIbplJnor6/kv6Hmga/mm7TmlrDliLBmb3JtQ29udHJvbOS4ilxyXG4gICAgICAgICAgICAgIGZvcm1Db250ZXh0LmJpbmRpbmdEYXRhLmNoYW5nZXMubmV4dCh7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiBDaGFuZ2VUeXBlLlVwZGF0ZUVycm9ycyxcclxuICAgICAgICAgICAgICAgIGlkLFxyXG4gICAgICAgICAgICAgICAgcGF0aDogcGF0aHMsXHJcbiAgICAgICAgICAgICAgICBpc1VkdDogcGFyZW50UGF0aERhdGEuaXNVZHQsXHJcbiAgICAgICAgICAgICAgICBpc0dyaWQ6IHBhcmVudFBhdGhEYXRhLmlzR3JpZCxcclxuICAgICAgICAgICAgICAgIHZhbHVlOiB2YWxpZGF0aW9uRXJyb3IudmFsdWUsXHJcbiAgICAgICAgICAgICAgICBlcnJvcnM6IGVyck1zZ09ialxyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIC8vfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICAvLyDlsZXlvIDpqozor4Hnu5PmnpxcclxuICAgICAgICAgIGNvbnN0IGlzVmFsaWRMaXN0ID0gcmVzdWx0TGlzdC5tYXAoKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCkgPT4gcmVzdWx0LmlzVmFsaWQpO1xyXG4gICAgICAgICAgLy8g5L+d5a2Y5YmN5YWI6LCD55So5a6e5L2T5LiK55qE6aqM6K+B6KeE5YiZ77yM5YWo6YOo6YCa6L+H5LmL5ZCO5omN5L+d5a2YXHJcbiAgICAgICAgICAvLyDlrp7kvZPpqozor4HpgJrov4dcclxuICAgICAgICAgIGlmIChpc1ZhbGlkTGlzdC5maWx0ZXIoeCA9PiB4KS5sZW5ndGggPT09IG9ic2VydmFibGVMaXN0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICAvLyDlsIbplJnor6/kv6Hmga/mm7TmlrDliLBmb3JtQ29udHJvbOS4ilxyXG4gICAgICAgICAgICBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5jaGFuZ2VzLm5leHQoe1xyXG4gICAgICAgICAgICAgIHR5cGU6IENoYW5nZVR5cGUuVXBkYXRlRXJyb3JzLFxyXG4gICAgICAgICAgICAgIHBhdGg6IFtdXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvLyDpqozor4HmiJDlip/lkI7pmpDol4/ovpPlhaXml7bnmoTpqozor4FcclxuICAgICAgICAgICAgaWYgKGZvcm1WYWxpZCkge1xyXG4gICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRPYmplY3QoKTtcclxuICAgICAgICAgICAgICBiaW5kaW5nT2JqZWN0ICYmIGJpbmRpbmdPYmplY3Quc2V0U2hvd1ZhbGlkYXRpb25Nc2coZmFsc2UpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGZvcm0gPSBmb3JtQ29udGV4dC5mb3JtO1xyXG4gICAgICAgICAgICAgIGlmIChmb3JtKSB7XHJcbiAgICAgICAgICAgICAgICBmb3JtLnNldFNob3dWYWxpZGF0aW9uTXNnKGZhbHNlKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIOWunuS9k+mqjOivgeaciemUmeivr1xyXG4gICAgICAgICAgICBlbnRpdHlWYWxpZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICByZXN1bHRMaXN0LmZvckVhY2goKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICAgIGlmIChyZXN1bHQuaXNWYWxpZCkge1xyXG4gICAgICAgICAgICAgICAgLy8g5riF6Zmk6aqM6K+B6YCa6L+H55qE6ZSZ6K+vXHJcbiAgICAgICAgICAgICAgICBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5jaGFuZ2VzLm5leHQoe1xyXG4gICAgICAgICAgICAgICAgICB0eXBlOiBDaGFuZ2VUeXBlLlVwZGF0ZUVycm9ycyxcclxuICAgICAgICAgICAgICAgICAgcGF0aDogW11cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBoYW5kbGVFcnJvcnMocmVzdWx0LmVycm9ycyk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfSksXHJcbiAgICAgIHN3aXRjaE1hcCgocmVzdWx0TGlzdCkgPT4ge1xyXG4gICAgICAgIGxldCBpc1ZhbGlkYXRlZCA9IHRydWU7XHJcbiAgICAgICAgY29uc3QgZXJyb3JzID0gW107XHJcbiAgICAgICAgcmVzdWx0TGlzdC5mb3JFYWNoKChyZXN1bHQ6IFZhbGlkYXRpb25SZXN1bHQpID0+IHtcclxuICAgICAgICAgIGlmICghcmVzdWx0LmlzVmFsaWQpIHtcclxuICAgICAgICAgICAgaXNWYWxpZGF0ZWQgPSBmYWxzZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGVycm9ycy5wdXNoKC4uLnJlc3VsdC5lcnJvcnMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgdGhpcy5jb2xsZWN0VmFsaWRhdGlvbkVycm9ycyhyb290Vmlld01vZGVsLCBlcnJvcnMsIHRoaXMuZnJhbWVDb250ZXh0Lm5hbWVzcGFjZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHJvb3RWaWV3TW9kZWwudmVyaWZ5Y2F0aW9uQ2hhbmdlZC5uZXh0KHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zKTtcclxuICAgICAgICBsZXQgdmVyaWZ5SW5mb3JtYXRpb25zID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnM7XHJcbiAgICAgICAgaWYgKGlzTW9kYWwgJiYgaGFzT3duVmVyaWZ5RGV0YWlsU2VydmljZSkge1xyXG4gICAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb25zID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5uYW1lc3BhY2UgPT09IG5hbWVzcGFjZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJvb3RWaWV3TW9kZWwudmVyaWZ5Y2F0aW9uQ2hhbmdlZC5uZXh0KHZlcmlmeUluZm9ybWF0aW9ucyk7XHJcbiAgICAgICAgdGhpcy5oYW5kbGVFcnJvckNsaWNrRXZlbnQoKTtcclxuICAgICAgICBpZiAoaXNWYWxpZGF0ZWQgJiYgIWZvcm1WYWxpZCkge1xyXG4gICAgICAgICAgLy8g5a6e5L2T5qCh6aqM6YCa6L+H5L2G6KGo5Y2V5qCh6aqM5LiN6YCa6L+H77yM5q2k5pe25a6e5L2T5ZKM6KGo5Y2V5a2Y5Zyo5qCh6aqM6KeE5YiZ5LiN5LiA6Ie055qE5oOF5Ya1XHJcbiAgICAgICAgICBjb25zb2xlLndhcm4oJ+WunuS9k+WSjOaOp+S7tuagoemqjOinhOWImeS4jeS4gOiHtO+8jOivt+ehruiupOWunuS9k+agoemqjOinhOWImemFjee9ruS4juaOp+S7tuS4gOiHtOOAguWmguaenOmFjee9ruS4jeS4gOiHtOWPr+iDveS8muWvvOiHtOagoemqjOWkseaViO+8gScpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDlrp7kvZPmoKHpqozpgJrov4fvvIzlrp7kvZPmoKHpqozkvb/nlKjnmoTop4TliJnmmK/mjqfku7Yr5a6e5L2T77yM5q2j5bi45a6e5L2T5qCh6aqM6YCa6L+H5ZCO5o6n5Lu25qCh6aqM5LiA5a6a5Lmf5Lya6YCa6L+HXHJcbiAgICAgICAgaWYgKGlzVmFsaWRhdGVkKSB7XHJcbiAgICAgICAgICBjb25zdCBpc0VudGl0eVZhbGlkID0gdGhpcy52YWxpZGF0ZUVudGl0eUFsbG93RW1wdHlSdWxlKGVudGl0eVR5cGVJbmZvKTtcclxuICAgICAgICAgIGlmICghaXNFbnRpdHlWYWxpZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBlbXB0eSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgICByZXR1cm4gcmVzdWx0JDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6LCD55So6KGo5Y2V5ZKM5a6e5L2T5LiK55qE6aqM6K+B6KeE5YiZLCDpgJrov4flkI7osIPnlKjlm57osINjYlxyXG4gICAqL1xyXG4gIHZhbGlkYXRlQWxsKCk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCBlbnRpdHlUeXBlSW5mbyA9IHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbztcclxuICAgIC8vIOe7hOWQiOihqOWNleWPquagoemqjOW9k+WJjeaMiemSruaJgOWcqOeahOihqOWNlVxyXG4gICAgY29uc3QgZW50aXRpZXM6IEVudGl0eVtdID0gdGhpcy5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0QWxsRW50aXRpZXMoKTtcclxuICAgIGNvbnN0IG5hbWVzcGFjZSA9IHRoaXMuZnJhbWVDb250ZXh0Lm5hbWVzcGFjZTtcclxuICAgIGxldCBmcmFtZUNvbnRleHRzID0gW107XHJcbiAgICBpZiAobmFtZXNwYWNlICE9PSBudWxsKSB7XHJcbiAgICAgIC8vIOWtmOWcqOWRveWQjeepuumXtO+8jOivtOaYjuihqOWNlei+g+aWsO+8jOWPr+S7peS+nei1luivpeeJueaAp1xyXG4gICAgICBmcmFtZUNvbnRleHRzID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHNCeU5hbWVzcGFjZShuYW1lc3BhY2UpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8g6KGo5Y2V6L6D6ICB77yM6I635Y+W5omA5pyJ55qE5LiK5LiL5paH77yM5Zyo5qCh6aqM6Zi25q616L+H5ruk6KeE5YiZXHJcbiAgICAgIGZyYW1lQ29udGV4dHMgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCB0b1ZhbGlkYXRlID0gZmFsc2U7XHJcbiAgICBjb25zdCBmb3JtRXJyb3JzID0gW107XHJcbiAgICBmcmFtZUNvbnRleHRzLmZvckVhY2goKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgIGlmIChmcmFtZUNvbnRleHQuZm9ybSAmJiBmcmFtZUNvbnRleHQuZm9ybS5lbmFibGVWYWxpZGF0ZSkge1xyXG4gICAgICAgIHRvVmFsaWRhdGUgPSB0cnVlO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIGlmICghdG9WYWxpZGF0ZSB8fCBlbnRpdGllcy5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGlzTW9kYWwgPSB0aGlzLmlzSW5EaWFsb2coKTtcclxuICAgIGNvbnN0IGhhc093blZlcmlmeURldGFpbFNlcnZpY2UgPSB0aGlzLmhhc093blZlcmlmeURldGFpbFNlcnZpY2UoKTtcclxuICAgIGxldCByb290Vmlld01vZGVsID0gdGhpcy5mcmFtZUNvbnRleHQucm9vdC52aWV3TW9kZWw7XHJcbiAgICBpZiAoaXNNb2RhbCAmJiBoYXNPd25WZXJpZnlEZXRhaWxTZXJ2aWNlKSB7XHJcbiAgICAgIHJvb3RWaWV3TW9kZWwgPSB0aGlzLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpLnZpZXdNb2RlbDtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgZm9ybVZhbGlkID0gdHJ1ZTtcclxuICAgIGxldCBlbnRpdHlWYWxpZCA9IHRydWU7XHJcbiAgICBjb25zdCBmb3JtVmFsaWRhdGlvblJ1bGVzID0gbmV3IE1hcDxzdHJpbmcsIFZhbGlkYXRlUnVsZVtdPigpO1xyXG4gICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKChmb3JtQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRPYmplY3QoKTtcclxuICAgICAgLy8g6YCa55+l5omA5pyJYmluZGluZ0RhdGEsXHJcbiAgICAgIGJpbmRpbmdPYmplY3QgJiYgYmluZGluZ09iamVjdC5zZXRTaG93VmFsaWRhdGlvbk1zZyh0cnVlKTtcclxuICAgICAgaWYgKGZvcm1Db250ZXh0LmZvcm0gJiYgZm9ybUNvbnRleHQuZm9ybS5lbmFibGVWYWxpZGF0ZSkge1xyXG4gICAgICAgIC8vIOiOt+WPluW9k+WJjeihqOWNleS4iueahOaJgOaciemqjOivgeinhOWImVxyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRGb3JtVmFsaWRhdGlvblJ1bGVzID0gZm9ybUNvbnRleHQuZm9ybS5nZXRWYWxpZGF0aW9uUnVsZXMoKTtcclxuICAgICAgICBjdXJyZW50Rm9ybVZhbGlkYXRpb25SdWxlcy5mb3JFYWNoKChydWxlcywgcGF0aCkgPT4ge1xyXG4gICAgICAgICAgaWYgKGZvcm1WYWxpZGF0aW9uUnVsZXMuaGFzKHBhdGgpKSB7XHJcbiAgICAgICAgICAgIHJ1bGVzLmZvckVhY2gocnVsZSA9PiBmb3JtVmFsaWRhdGlvblJ1bGVzLmdldChwYXRoKS5wdXNoKHJ1bGUpKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGZvcm1WYWxpZGF0aW9uUnVsZXMuc2V0KHBhdGgsIFsuLi5ydWxlc10pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGZvcm1Db250ZXh0LmZvcm0uc2V0U2hvd1ZhbGlkYXRpb25Nc2codHJ1ZSk7XHJcbiAgICAgICAgLy8g6YCQ5Liq6LCD55So6KGo5Y2V55qE6aqM6K+B77yM6aqM6K+B5YmN56uv6KGo5Y2V6KeE5YiZXHJcbiAgICAgICAgaWYgKCFmb3JtQ29udGV4dC5mb3JtLmlzRm9ybVZhbGlkKCkpIHtcclxuICAgICAgICAgIGZvcm1FcnJvcnMucHVzaChmb3JtQ29udGV4dC5mb3JtKTtcclxuICAgICAgICAgIGZvcm1WYWxpZCA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICAvLyDop6blj5HmiYDmnInlrp7kvZPnmoR2YWxpZGF0ZeS6i+S7tlxyXG4gICAgY29uc3QgaXNNdWx0aUVudGl0eVZhbGlhdGUgPSBlbnRpdGllcy5sZW5ndGggPiAwO1xyXG5cclxuICAgIC8vIOmqjOivgeaJgOacieWunuS9k1xyXG4gICAgY29uc3Qgb2JzZXJ2YWJsZUxpc3QgPSBlbnRpdGllcy5tYXAoKGVudGl0eTogRW50aXR5LCBpbmRleDogbnVtYmVyKSA9PlxyXG4gICAgICBlbnRpdHkudmFsaWRhdGUodW5kZWZpbmVkLCB1bmRlZmluZWQsIGZvcm1WYWxpZGF0aW9uUnVsZXMsIGlzTXVsdGlFbnRpdHlWYWxpYXRlID8gaW5kZXggOiBudWxsLCB0aGlzLmZyYW1lQ29udGV4dCkpO1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IHppcCguLi5vYnNlcnZhYmxlTGlzdCkucGlwZShcclxuICAgICAgdGFwKChyZXN1bHRMaXN0KSA9PiB7XHJcbiAgICAgICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKChmb3JtQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgICBpZiAoIWZvcm1Db250ZXh0LmZvcm0uZW5hYmxlVmFsaWRhdGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgaGFuZGxlRXJyb3JzID0gKGVycm9yczogVmFsaWRhdGlvbkVycm9yW10pID0+IHtcclxuICAgICAgICAgICAgZXJyb3JzLmZvckVhY2goKHZhbGlkYXRpb25FcnJvcjogVmFsaWRhdGlvbkVycm9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbiAmJiB2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4ubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBoYW5kbGVFcnJvcnModmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgY29uc3QgZXJyTXNnT2JqID0ge307XHJcbiAgICAgICAgICAgICAgbGV0IGlkID0gJyc7XHJcbiAgICAgICAgICAgICAgY29uc3QgZmluZElkID0gKHRhcmdldDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5kYXRhICYmIHRhcmdldC5kYXRhLmlkKSB7XHJcbiAgICAgICAgICAgICAgICAgIGlkID0gdGFyZ2V0LmRhdGEuaWQ7XHJcbiAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFyZ2V0W1BBUkVOVF9DTEFTU10pIHtcclxuICAgICAgICAgICAgICAgICAgZmluZElkKHRhcmdldFtQQVJFTlRfQ0xBU1NdKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgIGZpbmRJZCh2YWxpZGF0aW9uRXJyb3IudGFyZ2V0KTtcclxuXHJcbiAgICAgICAgICAgICAgLy8g5a6e5L2T6aqM6K+B5Ye66ZSZ77yM6ZyA6KaB5bCG6ZSZ6K+v5bGV56S65Yiw55WM6Z2i5LiKXHJcbiAgICAgICAgICAgICAgLy8g5a6e5L2T5LiN5LiA5a6a5piv5b2T5YmN6KGMXHJcbiAgICAgICAgICAgICAgbGV0IHBhcmVudFBhdGhEYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgcGF0aDogW10sXHJcbiAgICAgICAgICAgICAgICBpc1VkdDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBpc0dyaWQ6IGZhbHNlXHJcbiAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICBpZiAodmFsaWRhdGlvbkVycm9yLnRhcmdldCkge1xyXG4gICAgICAgICAgICAgICAgcGFyZW50UGF0aERhdGEgPSB2YWxpZGF0aW9uRXJyb3IudGFyZ2V0LmdldFBhdGhzKCk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gJy8nICsgcGFyZW50UGF0aERhdGEucGF0aC5qb2luKCcvJyk7XHJcbiAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50cykge1xyXG4gICAgICAgICAgICAgICAgT2JqZWN0LmtleXModmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzKS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIGVyck1zZ09ialtrZXldID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50c1trZXldXHJcbiAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgIC8vIGlmICh0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09IGJpbmRpbmdQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgIC8vICAgcm9vdFZpZXdNb2RlbFsndmVyaWZ5SW5mb3JtYXRpb25zJ10ucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgIC8vICAgICBpZDogaWQsXHJcbiAgICAgICAgICAgICAgICAgIC8vICAgICB0aXRsZToga2V5LFxyXG4gICAgICAgICAgICAgICAgICAvLyAgICAgbXNnOiB2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHNba2V5XSxcclxuICAgICAgICAgICAgICAgICAgLy8gICAgIHR5cGU6ICd3YXJuJ1xyXG4gICAgICAgICAgICAgICAgICAvLyAgIH0pXHJcbiAgICAgICAgICAgICAgICAgIC8vIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBjb25zdCBwYXRocyA9IHBhcmVudFBhdGhEYXRhLnBhdGguY29uY2F0KHZhbGlkYXRpb25FcnJvci5wcm9wZXJ0eSk7XHJcblxyXG4gICAgICAgICAgICAgIC8vaWYgKHRoaXMuZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCA9PT0gYmluZGluZ1BhdGgpIHtcclxuICAgICAgICAgICAgICAvLyDlsIbplJnor6/kv6Hmga/mm7TmlrDliLBmb3JtQ29udHJvbOS4ilxyXG4gICAgICAgICAgICAgIGZvcm1Db250ZXh0LmJpbmRpbmdEYXRhLmNoYW5nZXMubmV4dCh7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiBDaGFuZ2VUeXBlLlVwZGF0ZUVycm9ycyxcclxuICAgICAgICAgICAgICAgIGlkLFxyXG4gICAgICAgICAgICAgICAgcGF0aDogcGF0aHMsXHJcbiAgICAgICAgICAgICAgICBpc1VkdDogcGFyZW50UGF0aERhdGEuaXNVZHQsXHJcbiAgICAgICAgICAgICAgICBpc0dyaWQ6IHBhcmVudFBhdGhEYXRhLmlzR3JpZCxcclxuICAgICAgICAgICAgICAgIHZhbHVlOiB2YWxpZGF0aW9uRXJyb3IudmFsdWUsXHJcbiAgICAgICAgICAgICAgICBlcnJvcnM6IGVyck1zZ09ialxyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIC8vfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICAvLyDlsZXlvIDpqozor4Hnu5PmnpxcclxuICAgICAgICAgIGNvbnN0IGlzVmFsaWRMaXN0ID0gcmVzdWx0TGlzdC5tYXAoKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCkgPT4gcmVzdWx0LmlzVmFsaWQpO1xyXG4gICAgICAgICAgLy8g5L+d5a2Y5YmN5YWI6LCD55So5a6e5L2T5LiK55qE6aqM6K+B6KeE5YiZ77yM5YWo6YOo6YCa6L+H5LmL5ZCO5omN5L+d5a2YXHJcbiAgICAgICAgICAvLyDlrp7kvZPpqozor4HpgJrov4dcclxuICAgICAgICAgIGlmIChpc1ZhbGlkTGlzdC5maWx0ZXIoeCA9PiB4KS5sZW5ndGggPT09IG9ic2VydmFibGVMaXN0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICAvLyDlsIbplJnor6/kv6Hmga/mm7TmlrDliLBmb3JtQ29udHJvbOS4ilxyXG4gICAgICAgICAgICBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5jaGFuZ2VzLm5leHQoe1xyXG4gICAgICAgICAgICAgIHR5cGU6IENoYW5nZVR5cGUuVXBkYXRlRXJyb3JzLFxyXG4gICAgICAgICAgICAgIHBhdGg6IFtdXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvLyDpqozor4HmiJDlip/lkI7pmpDol4/ovpPlhaXml7bnmoTpqozor4FcclxuICAgICAgICAgICAgaWYgKGZvcm1WYWxpZCkge1xyXG4gICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRPYmplY3QoKTtcclxuICAgICAgICAgICAgICBiaW5kaW5nT2JqZWN0ICYmIGJpbmRpbmdPYmplY3Quc2V0U2hvd1ZhbGlkYXRpb25Nc2coZmFsc2UpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGZvcm0gPSBmb3JtQ29udGV4dC5mb3JtO1xyXG4gICAgICAgICAgICAgIGlmIChmb3JtKSB7XHJcbiAgICAgICAgICAgICAgICBmb3JtLnNldFNob3dWYWxpZGF0aW9uTXNnKGZhbHNlKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIOWunuS9k+mqjOivgeaciemUmeivr1xyXG4gICAgICAgICAgICBlbnRpdHlWYWxpZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICByZXN1bHRMaXN0LmZvckVhY2goKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICAgIGlmIChyZXN1bHQuaXNWYWxpZCkge1xyXG4gICAgICAgICAgICAgICAgLy8g5riF6Zmk6aqM6K+B6YCa6L+H55qE6ZSZ6K+vXHJcbiAgICAgICAgICAgICAgICBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5jaGFuZ2VzLm5leHQoe1xyXG4gICAgICAgICAgICAgICAgICB0eXBlOiBDaGFuZ2VUeXBlLlVwZGF0ZUVycm9ycyxcclxuICAgICAgICAgICAgICAgICAgcGF0aDogW11cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBoYW5kbGVFcnJvcnMocmVzdWx0LmVycm9ycyk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfSksXHJcbiAgICAgIHN3aXRjaE1hcCgocmVzdWx0TGlzdCkgPT4ge1xyXG4gICAgICAgIGxldCBpc1ZhbGlkYXRlZCA9IHRydWU7XHJcbiAgICAgICAgY29uc3QgZXJyb3JzID0gW107XHJcbiAgICAgICAgcmVzdWx0TGlzdC5mb3JFYWNoKChyZXN1bHQ6IFZhbGlkYXRpb25SZXN1bHQpID0+IHtcclxuICAgICAgICAgIGlmICghcmVzdWx0LmlzVmFsaWQpIHtcclxuICAgICAgICAgICAgaXNWYWxpZGF0ZWQgPSBmYWxzZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGVycm9ycy5wdXNoKC4uLnJlc3VsdC5lcnJvcnMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgdGhpcy5jb2xsZWN0VmFsaWRhdGlvbkVycm9ycyhyb290Vmlld01vZGVsLCBlcnJvcnMsIHRoaXMuZnJhbWVDb250ZXh0Lm5hbWVzcGFjZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCB2ZXJpZnlJbmZvcm1hdGlvbnMgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucztcclxuICAgICAgICBpZiAoaXNNb2RhbCAmJiBoYXNPd25WZXJpZnlEZXRhaWxTZXJ2aWNlKSB7XHJcbiAgICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbnMgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucy5maWx0ZXIoaXRlbSA9PiBpdGVtLm5hbWVzcGFjZSA9PT0gbmFtZXNwYWNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5Zug5Li65qCh6aqM57Sv5Yqg55qE57yY5pWF77yM5a+86Ie05LmL5YmN55qE5qCh6aqM5L+h5oGv5LiA55u05a2Y5Zyo77yM5Y+q6IO96YCa6L+H5qCh6aqM57uT5p6c5p2l56Gu5a6a5piv5ZCm6L+Y5pyJ6ZSZ6K+v5L+h5oGvXHJcbiAgICAgICAgaWYgKGlzVmFsaWRhdGVkICYmIGZvcm1WYWxpZCkge1xyXG4gICAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb25zID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMgPSBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcm9vdFZpZXdNb2RlbC52ZXJpZnljYXRpb25DaGFuZ2VkLm5leHQodmVyaWZ5SW5mb3JtYXRpb25zKTtcclxuICAgICAgICB0aGlzLmhhbmRsZUVycm9yQ2xpY2tFdmVudCgpO1xyXG4gICAgICAgIGlmIChpc1ZhbGlkYXRlZCkge1xyXG4gICAgICAgICAgY29uc3QgaXNFbnRpdHlWYWxpZCA9IHRoaXMudmFsaWRhdGVFbnRpdHlBbGxvd0VtcHR5UnVsZShlbnRpdHlUeXBlSW5mbyk7XHJcbiAgICAgICAgICBpZiAoIWlzRW50aXR5VmFsaWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gZW1wdHkoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gICAgcmV0dXJuIHJlc3VsdCQ7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOagoemqjOWunuS9k+aYr+WQpua7oei2s+S4jeiDveS4uuepuueahOinhOWImVxyXG4gICAqIEBwYXJhbSBlbnRpdHkg5Li75a6e5L2TXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB2YWxpZGF0ZUVudGl0eUFsbG93RW1wdHlSdWxlKGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8pIHtcclxuICAgIC8vIOehruiupOWunuS9k+WQhOS4quWxgue6p+S4reaYr+WQpuWtmOWcqOS4jeiDveS4uuepuueahOinhOWImVxyXG4gICAgY29uc3QgcGF0aHMgPSB0aGlzLmdldE5vdEFsbG93RW1wdHlCaW5kaW5nUGF0aHMoZW50aXR5VHlwZUluZm8pO1xyXG4gICAgaWYgKCFwYXRocyB8fCBwYXRocy5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgLy8g5om+5Yiw5omA5pyJ5LiN5ZCI5rOV55qEYmluZGluZ1BhdGhzXHJcbiAgICBjb25zdCBpbnZhbGlkUGF0aHMgPSBwYXRocy5maWx0ZXIoKHBhdGg6IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBwYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0VmFsdWUoYmluZGluZ1BhdGhzKSBhcyBCaW5kaW5nTGlzdDtcclxuICAgICAgaWYgKCFiaW5kaW5nTGlzdCB8fCBiaW5kaW5nTGlzdC5sZW5ndGggPCAxKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfSk7XHJcbiAgICAvLyDmnInlrp7kvZPlv4XloavvvIzkvYblrp7kvZPmlbDmja7kuLrnqbpcclxuICAgIGlmIChpbnZhbGlkUGF0aHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBjb25zdCB0YWJsZU5hbWVzID0gW107XHJcbiAgICAgIGludmFsaWRQYXRocy5mb3JFYWNoKChwYXRoOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAvL2NvbnN0IGZyYW1lQ29udGV4dHMgPSB0aGlzLmdldEZyYW1lQ29udGV4dEJ5QmluZGluZ1BhdGgocGF0aC5zcGxpdCgnLycpKTtcclxuICAgICAgICAvL2NvbnN0IGZyYW1lQ29tcG9uZW50cyA9IGZyYW1lQ29udGV4dHMubWFwKGZyYW1lQ29udGV4dCA9PiBmcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnQpO1xyXG4gICAgICAgIC8vIOaJvuWIsOaJgOacieWuueWZqOexu+e7hOS7tlxyXG4gICAgICAgIC8vY29uc3QgY29udGFpbmVyQ29tcG9uZW50cyA9IGZyYW1lQ29tcG9uZW50cy5maWx0ZXIoZnJhbWVDb21wb25lbnQgPT4gW0NvbXBvbmVudFR5cGUuZmFycmlzRGF0YUdyaWRDb21wb25lbnQsIENvbXBvbmVudFR5cGUuZmFycmlzVHJlZVRhbGJlQ29tcG9uZW50LCBDb21wb25lbnRUeXBlLmtlbmRvR3JpZENvbXBvbmVudCwgQ29tcG9uZW50VHlwZS5wcmltZW5nVHJlZUNvbXBvbmVudF0uaW5jbHVkZXMoZnJhbWVDb21wb25lbnQuY29tcG9uZW50VHlwZSkpO1xyXG4gICAgICAgIC8vaWYgKCEoIWNvbnRhaW5lckNvbXBvbmVudHMgfHwgY29udGFpbmVyQ29tcG9uZW50cy5sZW5ndGggPCAxKSkge1xyXG4gICAgICAgIGNvbnN0IHZpZXdNb2RlbE5hbWUgPSB0aGlzLmdldFZpZXdNb2RlbE5hbWVCeUJpbmRpbmdQYXRocyhwYXRoLnNwbGl0KCcvJykpIHx8IGDnu5Hlrprot6/lvoQke3BhdGh9YDtcclxuICAgICAgICB0YWJsZU5hbWVzLnB1c2godmlld01vZGVsTmFtZSk7XHJcbiAgICAgICAgLy99XHJcbiAgICAgIH0pO1xyXG4gICAgICBpZiAodGhpcy5ub3RpZnlTZXJ2aWNlKSB7XHJcbiAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLmVycm9yKGAke3RhYmxlTmFtZXMuam9pbign77yMJyl9ICR7dGhpcy5sYW5ndWFnZVNlcnZpY2UudGFibGVDYW5Ob3RFbXB0eX1gLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICogXHJcbiAgICogQHBhcmFtIGJpbmRpbmdQYXRocyBwYXRo5LiN6IO95Li656m65oiWL++8jOS4jeaUr+aMgeS4u+ihqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Vmlld01vZGVsTmFtZUJ5QmluZGluZ1BhdGhzKGJpbmRpbmdQYXRoczogc3RyaW5nW10pIHtcclxuICAgIGNvbnN0IG5hbWVzcGFjZSA9IHRoaXMuZnJhbWVDb250ZXh0Lm5hbWVzcGFjZTtcclxuICAgIGxldCBmcmFtZUNvbnRleHRzOiBGcmFtZUNvbnRleHRbXSA9IG51bGw7XHJcbiAgICBpZiAobmFtZXNwYWNlICE9PSBudWxsKSB7XHJcbiAgICAgIC8vIOWtmOWcqOWRveWQjeepuumXtO+8jOivtOaYjuihqOWNlei+g+aWsO+8jOWPr+S7peS+nei1luivpeeJueaAp1xyXG4gICAgICBmcmFtZUNvbnRleHRzID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHNCeU5hbWVzcGFjZShuYW1lc3BhY2UpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8g6KGo5Y2V6L6D6ICB77yM6I635Y+W5omA5pyJ55qE5LiK5LiL5paH77yM5Zyo5qCh6aqM6Zi25q616L+H5ruk6KeE5YiZXHJcbiAgICAgIGZyYW1lQ29udGV4dHMgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgYmluZGluZ1BhdGggPSBiaW5kaW5nUGF0aHMuZmlsdGVyKHAgPT4gcCkuam9pbignLycpO1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0cy5maW5kKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4gZnJhbWVDb250ZXh0LnZpZXdNb2RlbCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkuam9pbignLycpID09PSBiaW5kaW5nUGF0aCk7XHJcbiAgICBjb25zdCB2aWV3TW9kZWxOYW1lID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5mb3JtICYmIGZyYW1lQ29udGV4dC5mb3JtLmZvcm1Hcm91cE5hbWUgfHwgJyc7XHJcbiAgICByZXR1cm4gdmlld01vZGVsTmFtZTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6YGN5Y6G6I635Y+W5omA5pyJ5LiN6IO95Li656m655qE5a6e5L2T55qE57uR5a6a6Lev5b6EXHJcbiAgICogQHBhcmFtIGVudGl0eVR5cGVJbmZvIFxyXG4gICAqIEBwYXJhbSByZXN1bHRzIFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Tm90QWxsb3dFbXB0eUJpbmRpbmdQYXRocyhlbnRpdHlUeXBlSW5mbzogRGF0YVR5cGVJbmZvLCByZXN1bHRzOiBzdHJpbmdbXSA9IFtdKTogc3RyaW5nW10ge1xyXG4gICAgaWYgKCFlbnRpdHlUeXBlSW5mbykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLmRlZXBGaXJzdFRyYXZlcnNhbEVudGl0eVR5cGVJbmZvKGVudGl0eVR5cGVJbmZvLCByZXN1bHRzKTtcclxuICAgIHJldHVybiByZXN1bHRzO1xyXG4gIH1cclxuICBwcml2YXRlIGRlZXBGaXJzdFRyYXZlcnNhbEVudGl0eVR5cGVJbmZvKGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8sIHJlc3VsdDogc3RyaW5nW10gPSBbXSwgcHJldmlvdXNWYWx1ZTogc3RyaW5nW10gPSBbXSkge1xyXG4gICAgLy8g56Gu6K6k5b2T5YmN5a6e5L2T5piv5ZCm5b+F5aGrXHJcbiAgICBjb25zdCBpc0FsbG93RW1wdHkgPSB0aGlzLmlzQWxsb3dFbXB0eShlbnRpdHlUeXBlSW5mby5lbnRpdHlJbmZvLmFsbG93RW1wdHksIHByZXZpb3VzVmFsdWUpO1xyXG4gICAgaWYgKGlzQWxsb3dFbXB0eSA9PT0gZmFsc2UpIHtcclxuICAgICAgaWYgKHByZXZpb3VzVmFsdWUubGVuZ3RoIDwgMSkge1xyXG4gICAgICAgIHJlc3VsdC5wdXNoKCcnKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXN1bHQucHVzaChwcmV2aW91c1ZhbHVlLmpvaW4oJy8nKSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIOiOt+WPluaJgOacieWtkOihqFxyXG4gICAgY29uc3QgbGlzdCA9IGVudGl0eVR5cGVJbmZvLmdldFByb3BJbmZvc0J5R3JvdXAoRGF0YVByb3BHcm91cC5MaXN0KTtcclxuICAgIGlmIChsaXN0ICYmIGxpc3QubGVuZ3RoID4gMCkge1xyXG4gICAgICBsaXN0LmZvckVhY2goKHByb3BJbmZvOiBEYXRhUHJvcEluZm8pID0+IHtcclxuICAgICAgICBjb25zdCB0eXBlSW5mbyA9IHByb3BJbmZvLnR5cGVJbmZvO1xyXG4gICAgICAgIGlmICh0eXBlSW5mbyAmJiB0eXBlSW5mby5lbnRpdHlJbmZvKSB7XHJcbiAgICAgICAgICBwcmV2aW91c1ZhbHVlLnB1c2godHlwZUluZm8uZW50aXR5SW5mby5ub2RlQ29kZSk7XHJcbiAgICAgICAgICB0aGlzLmRlZXBGaXJzdFRyYXZlcnNhbEVudGl0eVR5cGVJbmZvKHR5cGVJbmZvLCByZXN1bHQsIHByZXZpb3VzVmFsdWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICAvLyDmsqHmnInkuIvnuqfkuobvvIzmraTml7blupTor6XmuIXnqbrmuLjmoIfvvIzlsIbmlLbpm4bliLDnmoTot6/lvoTmlL7liLDnu5Pmnpzpm4bkuK1cclxuICAgIGlmIChwcmV2aW91c1ZhbHVlICYmIHByZXZpb3VzVmFsdWUubGVuZ3RoID4gMCkge1xyXG4gICAgICBwcmV2aW91c1ZhbHVlLnBvcCgpO1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIGlzQWxsb3dFbXB0eSh2YWx1ZTogc3RyaW5nIHwgYm9vbGVhbiwgcGF0aHM6IHN0cmluZ1tdKSB7XHJcbiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gJycpIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICAvLyDlvIDlj5HogIXlrprkuYnkuobkuI3og73kuLrnqbrnmoTop4TliJlcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dHMgPSB0aGlzLmdldEZyYW1lQ29udGV4dEJ5QmluZGluZ1BhdGgocGF0aHMpO1xyXG4gICAgbGV0IGNhbGxlciA9IHRoaXMuZnJhbWVDb250ZXh0LmZyYW1lQ29tcG9uZW50O1xyXG4gICAgaWYgKCFmcmFtZUNvbnRleHRzIHx8IGZyYW1lQ29udGV4dHMubGVuZ3RoIDwgMSkge1xyXG4gICAgICAvLyDlrprkuYnkuobop4TliJnkvYblr7nlupTnmoRGcmFtZeayoeaciea4suafk1xyXG4gICAgICBjb25zb2xlLndhcm4oYOe7keWumui3r+W+hCAke3BhdGhzLmpvaW4oJy8nKX0g5a6a5LmJ5LqG5LiN6IO95Li656m655qE6KeE5YiZ77yM5L2G5om+5LiN5Yiw6K+l57uR5a6a6Lev5b6E5a+55bqU55qE57uE5Lu244CC6K+356Gu5L+d57uE5Lu25pi+6ZqQ5LiO5b+F5aGr5LiA6Ie044CCYCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjYWxsZXIgPSBmcmFtZUNvbnRleHRzLnBvcCgpLmZyYW1lQ29tcG9uZW50O1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nKSB7XHJcbiAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xyXG4gICAgICB2YWx1ZSA9IHZhbHVlLnRyaW0oKS5zdGFydHNXaXRoKCdyZXR1cm4nKSA/IHZhbHVlIDogYHJldHVybiAke3ZhbHVlfWA7XHJcbiAgICAgIGNvbnN0IGZhY3RvcnkgPSBuZXcgRnVuY3Rpb24oYFxyXG4gICAgICAgIHZhciB2aWV3TW9kZWwgPSB0aGlzLnZpZXdNb2RlbDtcclxuICAgICAgICB2YXIgYmluZGluZ0RhdGEgPSB0aGlzLmJpbmRpbmdEYXRhO1xyXG4gICAgICAgIHZhciBjb250ZXh0ID0gdGhpcy5jb250ZXh0O1xyXG4gICAgICAgICR7dmFsdWV9XHJcbiAgICAgIGApO1xyXG4gICAgICByZXR1cm4gZmFjdG9yeS5hcHBseShjYWxsZXIpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc29sZS53YXJuKGDml6DmlYjnmoTlv4Xloavop4TliJnjgIJgKTtcclxuICAgIH1cclxuICB9XHJcbiAgY29sbGVjdFZhbGlkYXRpb25FcnJvcnMocm9vdFZpZXdNb2RlbDogVmlld01vZGVsLCBlcnJvcnM6IFZhbGlkYXRpb25FcnJvcltdLCBuYW1lc3BhY2U6IHN0cmluZywgZmlsdGVyOiBib29sZWFuID0gdHJ1ZSkge1xyXG4gICAgaWYgKGZpbHRlcikge1xyXG4gICAgICByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucyA9IHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zLmZpbHRlcihpdGVtID0+IGl0ZW0ubmFtZXNwYWNlICE9PSBuYW1lc3BhY2UpO1xyXG4gICAgfVxyXG4gICAgZXJyb3JzLmZvckVhY2goKHZhbGlkYXRpb25FcnJvcjogVmFsaWRhdGlvbkVycm9yKSA9PiB7XHJcbiAgICAgIGlmICh2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4gJiYgdmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuLmxlbmd0aCkge1xyXG4gICAgICAgIHRoaXMuY29sbGVjdFZhbGlkYXRpb25FcnJvcnMocm9vdFZpZXdNb2RlbCwgdmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuLCBuYW1lc3BhY2UsIGZhbHNlKTtcclxuICAgICAgfVxyXG4gICAgICBsZXQgaWQgPSAnJztcclxuICAgICAgY29uc3QgZmluZElkID0gKHRhcmdldDogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKHRhcmdldCAmJiB0YXJnZXQuZGF0YSAmJiB0YXJnZXQuZGF0YS5pZCkge1xyXG4gICAgICAgICAgaWQgPSB0YXJnZXQuZGF0YS5pZDtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9IGVsc2UgaWYgKHRhcmdldFtQQVJFTlRfQ0xBU1NdKSB7XHJcbiAgICAgICAgICBmaW5kSWQodGFyZ2V0W1BBUkVOVF9DTEFTU10pO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgZmluZElkKHZhbGlkYXRpb25FcnJvci50YXJnZXQpO1xyXG4gICAgICBpZiAodmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzKSB7XHJcbiAgICAgICAgY29uc3QgdmFsaWRhdGlvblJlc3VsdFR5cGVzID0gT2JqZWN0LmtleXModmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzKTtcclxuICAgICAgICBpZiAodmFsaWRhdGlvblJlc3VsdFR5cGVzLmxlbmd0aCkge1xyXG4gICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5uYW1lc3BhY2UgPT09IG5hbWVzcGFjZSkubGVuZ3RoO1xyXG4gICAgICAgICAgbGV0IGluZGV4ID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMuZmluZEluZGV4KGl0ZW0gPT4gaXRlbS5uYW1lc3BhY2UgPT09IG5hbWVzcGFjZSk7XHJcbiAgICAgICAgICBpbmRleCA9IGluZGV4ID09PSAtMSA/IDAgOiBpbmRleCArIG9mZnNldDtcclxuICAgICAgICAgIHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zLnNwbGljZShpbmRleCwgMCwge1xyXG4gICAgICAgICAgICBpZDogaWQsXHJcbiAgICAgICAgICAgIG5hbWVzcGFjZSxcclxuICAgICAgICAgICAgdGFyZ2V0RmllbGQ6IHZhbGlkYXRpb25FcnJvci5maWVsZCxcclxuICAgICAgICAgICAgaW5kZXg6IHZhbGlkYXRpb25FcnJvci5pbmRleCxcclxuICAgICAgICAgICAgdGl0bGU6IHZhbGlkYXRpb25FcnJvci5wcm9wZXJ0eU5hbWUsXHJcbiAgICAgICAgICAgIG1zZzogdmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzW3ZhbGlkYXRpb25SZXN1bHRUeXBlc1swXV0sXHJcbiAgICAgICAgICAgIGZyYW1lQ29udGV4dDogdmFsaWRhdGlvbkVycm9yLmZyYW1lQ29udGV4dCxcclxuICAgICAgICAgICAgZnVsbFBhdGg6IHZhbGlkYXRpb25FcnJvci5mdWxsUGF0aCxcclxuICAgICAgICAgICAgdHlwZTogdmFsaWRhdGlvblJlc3VsdFR5cGVzWzBdID09PSAncmVxdWlyZWQnID8gJ2VtcHR5JyA6ICdlcnJvcidcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOmHjee9ruagoemqjOS/oeaBr++8iOS7heW9k+WJjeihqOWNle+8iVxyXG4gICAqL1xyXG4gIHB1YmxpYyByZXNldFZhbGlkYXRpb24oKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IGlzRGlhbG9nID0gdGhpcy5pc0luRGlhbG9nKCk7XHJcbiAgICBsZXQgcm9vdFZpZXdNb2RlbCA9IHRoaXMuZnJhbWVDb250ZXh0LnJvb3Qudmlld01vZGVsO1xyXG4gICAgaWYgKGlzRGlhbG9nKSB7XHJcbiAgICAgIHJvb3RWaWV3TW9kZWwgPSB0aGlzLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpLnZpZXdNb2RlbDtcclxuICAgIH1cclxuICAgIGxldCB2ZXJpZnlJbmZvcm1hdGlvbnMgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucztcclxuICAgIGlmICh2ZXJpZnlJbmZvcm1hdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgIGNvbnN0IG5hbWVzcGFjZSA9IHRoaXMuZnJhbWVDb250ZXh0Lm5hbWVzcGFjZTtcclxuICAgICAgaWYgKG5hbWVzcGFjZSAhPT0gbnVsbCkge1xyXG4gICAgICAgIHZlcmlmeUluZm9ybWF0aW9ucyA9IHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zLmZpbHRlcihpdGVtID0+IGl0ZW0ubmFtZXNwYWNlICE9PSBuYW1lc3BhY2UpO1xyXG4gICAgICB9XHJcbiAgICAgIHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zID0gdmVyaWZ5SW5mb3JtYXRpb25zO1xyXG4gICAgICAvL3Jvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zLnNwbGljZSgwLCByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucy5sZW5ndGgpO1xyXG4gICAgfVxyXG4gICAgaWYgKHJvb3RWaWV3TW9kZWwgJiYgcm9vdFZpZXdNb2RlbC52ZXJpZnljYXRpb25DaGFuZ2VkKSB7XHJcbiAgICAgIHJvb3RWaWV3TW9kZWwudmVyaWZ5Y2F0aW9uQ2hhbmdlZC5uZXh0KHZlcmlmeUluZm9ybWF0aW9ucyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gb2YobnVsbCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaYr+WQpuWcqOW8ueeql+WGhemDqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNJbkRpYWxvZygpIHtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dCAmJiB0aGlzLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpICYmIHRoaXMuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkuZnJhbWVDb21wb25lbnQgJiYgdGhpcy5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKS5mcmFtZUNvbXBvbmVudFsnaXNEaWFsb2dSb290Q29tcG9uZW50J10gfHwgZmFsc2U7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaLpeacieeLrOiHqueahOagoemqjOaPkOekuuacjeWKoVxyXG4gICAqL1xyXG4gIHByaXZhdGUgaGFzT3duVmVyaWZ5RGV0YWlsU2VydmljZSgpIHtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8VmVyaWZ5RGV0YWlsU2VydmljZT4oVmVyaWZ5RGV0YWlsU2VydmljZSwgbnVsbCkgIT09IHRoaXMuZnJhbWVDb250ZXh0LnJvb3QuYXBwQ29udGV4dC5pbmplY3Rvci5nZXQ8VmVyaWZ5RGV0YWlsU2VydmljZT4oVmVyaWZ5RGV0YWlsU2VydmljZSwgbnVsbCk7O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDpgJrov4diaW5kaW5nUGF0aOiOt+WPluaJgOacieWMuemFjeeahGZyYW1lQ29udGV4dFxyXG4gICAqIEBwYXJhbSBiaW5kaW5nUGF0aCBcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwcml2YXRlIGdldEZyYW1lQ29udGV4dEJ5QmluZGluZ1BhdGgoYmluZGluZ1BhdGhzOiBzdHJpbmdbXSk6IEZyYW1lQ29udGV4dFtdIHtcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gYmluZGluZ1BhdGhzLmZpbHRlcihwID0+IHApLmpvaW4oJy8nKTtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpLmZpbHRlcihmcmFtZUNvbnRleHQgPT4gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLmpvaW4oJy8nKSA9PT0gYmluZGluZ1BhdGgpO1xyXG4gIH1cclxuICBwcml2YXRlIGdldCB2ZXJpZnlEZXRhaWxTZXJ2aWNlKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxWZXJpZnlEZXRhaWxTZXJ2aWNlPihWZXJpZnlEZXRhaWxTZXJ2aWNlLCBudWxsLCBJbmplY3RGbGFncy5TZWxmKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBoYW5kbGVFcnJvckNsaWNrRXZlbnQoKSB7XHJcbiAgICBpZiAodGhpcy52ZXJpZnlEZXRhaWxTZXJ2aWNlICYmIHRoaXMudmVyaWZ5RGV0YWlsU2VydmljZS52ZXJpZnlDb250YWluZXIgJiYgdGhpcy52ZXJpZnlEZXRhaWxTZXJ2aWNlLnZlcmlmeUNvbnRhaW5lci5pbnN0YW5jZSkge1xyXG4gICAgICB0aGlzLnZlcmlmeURldGFpbFNlcnZpY2UudmVyaWZ5Q29udGFpbmVyLmluc3RhbmNlLnZhbGlkYXRvckNsaWNrLnN1YnNjcmliZSgoaXRlbTogYW55KSA9PiB7XHJcbiAgICAgICAgdGhpcy5vbkVycm9ySXRlbUNsaWNrKGl0ZW0pO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBvbkVycm9ySXRlbUNsaWNrKGl0ZW06IHsgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIGlkOiBzdHJpbmcsIHRhcmdldEZpZWxkOiBzdHJpbmcsIGZ1bGxQYXRoOiBzdHJpbmcgfSA9IHsgZnJhbWVDb250ZXh0OiBudWxsLCBpZDogbnVsbCwgdGFyZ2V0RmllbGQ6IG51bGwsIGZ1bGxQYXRoOiBudWxsIH0pIHtcclxuICAgIGNvbnN0IHsgZnJhbWVDb250ZXh0LCBpZCwgdGFyZ2V0RmllbGQsIGZ1bGxQYXRoIH0gPSBpdGVtO1xyXG4gICAgY29uc3QgaXNHcmlkQ29tcG9uZW50ID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudC5pc0dyaWRDb21wb25lbnQgfHwgZmFsc2U7XHJcbiAgICBpZiAoIWlzR3JpZENvbXBvbmVudCkge1xyXG4gICAgICBpZiAoIXRhcmdldEZpZWxkKSB7IH1cclxuICAgICAgY29uc3QgZWxlbWVudFJlZiA9IGZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQoRWxlbWVudFJlZiwgbnVsbCwgSW5qZWN0RmxhZ3MuU2VsZikgfHwgZnJhbWVDb250ZXh0LmluamVjdG9yLmdldChFbGVtZW50UmVmLCBudWxsKTtcclxuICAgICAgVmVyaWZ5U2VydmljZS5mb2N1c0VsZW1lbnQodGFyZ2V0RmllbGQsIGVsZW1lbnRSZWYpO1xyXG4gICAgICB0aGlzLnZlcmlmeURldGFpbFNlcnZpY2UudmVyaWZ5Q29udGFpbmVyLmluc3RhbmNlLnNob3dMaXN0ID0gZmFsc2U7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyBmaW5kIGdyaWQgY29tcG9uZW50XHJcbiAgICAgIGNvbnN0IGdyaWQ6IERhdGFncmlkQ29tcG9uZW50ID0gZnJhbWVDb250ZXh0LmNvbXBvbmVudFJlZk1hbmFnZXIuZ2V0Q29tcG9uZW50QnlUeXBlKERhdGFncmlkQ29tcG9uZW50KTtcclxuICAgICAgaWYgKGdyaWQgJiYgdGFyZ2V0RmllbGQgJiYgaWQpIHtcclxuICAgICAgICBncmlkLmVkaXRDZWxsKGlkLCB0YXJnZXRGaWVsZCk7XHJcbiAgICAgICAgdGhpcy52ZXJpZnlEZXRhaWxTZXJ2aWNlLnZlcmlmeUNvbnRhaW5lci5pbnN0YW5jZS5zaG93TGlzdCA9IGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgeyBWYWxpZGF0aW9uU2VydmljZSB9O1xyXG4iXX0=