import { Injectable, Injector } from '@angular/core';
import { EMPTY, of } from 'rxjs';
import { switchMap, tap } from 'rxjs/operators';
import { FrameContext, DataPathCreator, Repository } from '@farris/devkit';
import { LanguageService } from './languag.service';
import { FormMessageService } from './form-message.service';
var PopUpService = /** @class */ (function () {
    function PopUpService(injector, frameContext, repository, languageService, messageService) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.repository = repository;
        this.languageService = languageService;
        this.messageService = messageService;
    }
    PopUpService.prototype.confirm = function () { };
    /**
     * 取消变更
     * @param frameId
     * @param id
     * @returns
     * @throws invalid frameid
     */
    PopUpService.prototype.cancel = function (frameId, id) {
        var frameContext = this.frameContext.appContext.frameContextManager.getFrameContextById(frameId);
        if (!frameContext) {
            throw new Error("[PopUpService]Invalid frameId " + frameId);
        }
        var primaryValue = this.frameContext.bindingData.list.currentId;
        var bindingPath = frameContext.viewModel.bindingPath;
        var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
        if (!id) {
            var bindingList = this.frameContext.bindingData.getList();
            id = bindingList.currentId;
        }
        var befRepository = this.repository;
        var longPaths = DataPathCreator.createByShortPathFromRoot(bindingPaths, befRepository.entityManager, this.frameContext.bindingData).toArray().map(function (path) { return path.split(':')[1]; });
        var entityListPaths = Array.from(longPaths);
        // 舍弃当前表当前行
        entityListPaths.pop();
        var dialogRef = this.frameContext.frameComponent['dialogRef'];
        if (entityListPaths.length < 1) {
            // 主表
            var entity = this.repository.entityCollection.getEntityById(id);
            var originalData = entity['originalData'];
            entity.load(originalData, { loadChild: false });
        }
        else {
            var entityList_1 = befRepository.entityManager.getEntityNodeByPath(entityListPaths);
            if (entityList_1) {
                var originalData = entityList_1['originalData'];
                var item_1 = originalData.find(function (item) { return item.id === id; });
                if (item_1) {
                    // 已有数据，还原变更
                    var entity_1 = befRepository.entityManager.getEntityByPath(longPaths);
                    if (entity_1.changes && entity_1.changes.length > 0) {
                        return this.messageService.confirm(this.languageService.cancelWithoutSave).pipe(tap(function (result) {
                            if (result) {
                                entity_1.load(item_1, { loadChild: false });
                                entity_1.changes.splice(0, entity_1.changes.length);
                            }
                        }));
                    }
                    else {
                        // 没有修改，直接关闭
                        if (dialogRef) {
                            dialogRef.close();
                        }
                    }
                }
                else {
                    // 新增的数据，删除
                    var paths_1 = this.buildPath(bindingPath, primaryValue);
                    return this.messageService.confirm(this.languageService.cancelWithoutSave).pipe(switchMap(function (result) {
                        if (result) {
                            return befRepository.removeEntityByPath(paths_1, id).pipe(tap(function () {
                                befRepository.entityManager.removeEntityByPath(paths_1, id);
                                if (entityList_1.count() === 0 && dialogRef) {
                                    dialogRef.close();
                                }
                            }));
                        }
                        else {
                            return EMPTY;
                        }
                    }));
                }
            }
        }
        return of([]);
    };
    /**
     * 同步当前行
     * @param id 当前行
     */
    PopUpService.prototype.updateCurrentRow = function (id) {
        var _this = this;
        var bindingPath = this.frameContext.viewModel.bindingPath;
        var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
        // const frameId = this.frameContext.frameId;
        var root = this.frameContext.getVirtualRootFrameContext();
        var primaryKeyValue = root.bindingData.list.currentId;
        this.frameContext.bindingData.list.setCurrentId(primaryKeyValue);
        if (bindingPaths.length > 0) {
            var paths_2 = [];
            bindingPaths.forEach(function (path, index, array) {
                paths_2.push(path);
                var bindingList = root.bindingData.getValue(paths_2);
                if (bindingList) {
                    var currentId = bindingList.currentId;
                    var modalBindingList = _this.frameContext.bindingData.getValue(paths_2);
                    if (index === bindingPath.length - 1 && id) {
                        modalBindingList.setCurrentId(id);
                    }
                    else if (modalBindingList) {
                        modalBindingList.setCurrentId(currentId);
                    }
                }
            });
        }
    };
    PopUpService.prototype.closeCheck = function () {
        var frameContext = this.frameContext;
        var bindingPath = frameContext.viewModel.bindingPath;
        var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
        var befRepository = this.repository;
        var longPaths = DataPathCreator.createByShortPathFromRoot(bindingPaths, befRepository.entityManager, this.frameContext.bindingData).toArray().map(function (path) { return path.split(':')[1]; });
        var entityListPaths = Array.from(longPaths);
        entityListPaths.pop();
        var entityList = befRepository.entityManager.getEntityNodeByPath(entityListPaths);
        var dialogRef = this.frameContext.frameComponent['dialogRef'];
        if (entityList.count() === 0 && dialogRef) {
            dialogRef.close();
        }
    };
    /**
     * 删除弹窗中的当前行数据
     * @param frameId -可选，要删除数据所在组件的id，默认为命令所在的组件
     * @param id -可选，要删除数据的id，默认为命令所在组件的当前行数据id
     * @param showConfirm -可选，删除数据时是否进行删除前的确认，默认为`true`
     * @returns
     * @throws 组件id错误时抛出错误
     */
    PopUpService.prototype.removeRow = function (frameId, id, showConfirm) {
        if (showConfirm === void 0) { showConfirm = true; }
        var frameContext = frameId ? this.frameContext.appContext.frameContextManager.getFrameContextById(frameId) : this.frameContext;
        if (!frameContext) {
            throw new Error("\u65E0\u6548\u7684\u7EC4\u4EF6id\uFF1A" + frameId);
        }
        // 纠正主键
        if (!id) {
            var bindingList = frameContext.bindingData.getList();
            id = bindingList.currentId;
        }
        var bindingPath = frameContext.viewModel.bindingPath;
        var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
        var paths = this.buildPath(bindingPath, this.frameContext.bindingData.list.currentId);
        var befRepository = this.repository;
        // 转换showConfirm为布尔
        if (typeof showConfirm == 'string') {
            showConfirm = showConfirm.trim() === 'false' ? false : true;
        }
        var confirm$ = of(true);
        if (showConfirm) {
            confirm$ = this.messageService.confirm(this.languageService.confirmDeletion);
        }
        return confirm$.pipe(switchMap(function (result) {
            if (result) {
                if (bindingPaths.length === 0) {
                    // 主表删除，不立即保存
                    return befRepository.removeEntityById(id, false);
                }
                else {
                    return befRepository.removeEntityByPath(paths, id).pipe(tap(function () {
                        befRepository.entityManager.removeEntityByPath(paths, id);
                    }));
                }
            }
            else {
                return EMPTY;
            }
        }));
    };
    /**
     * 关闭弹窗
     * @param frameId -可选，组件id，不指定时使用命令所在的上下文组件
     * @throws 使用指定的组件id无法获取组件及弹窗组件实例获取失败时会抛出异常
     */
    PopUpService.prototype.closeDialog = function (frameId) {
        var frameContext = this.frameContext;
        var dialogRef = null;
        // 开发者指定了组件id
        if (frameId) {
            frameContext = this.frameContext.appContext.frameContextManager.getFrameContextById(frameId);
            if (!frameContext) {
                throw new Error('指定了无效的组件id');
            }
            dialogRef = frameContext.frameComponent['dialogRef'];
        }
        else {
            // 尝试从当前组件上下文中获取弹窗引用
            dialogRef = frameContext.frameComponent['dialogRef'];
            if (!dialogRef) {
                // 如果命令挂载到了内容组件上
                dialogRef = this.frameContext.parent.frameComponent['dialogRef'];
            }
        }
        if (!dialogRef) {
            throw new Error("\u65E0\u6CD5\u83B7\u53D6\u5F39\u7A97\u7EC4\u4EF6\u5B9E\u4F8B");
        }
        dialogRef.close();
    };
    /**
     * 还原自上次持久化以后产生的变更
     * @param frameId - 组件id
     * @param id - 数据id
     * @param showConfirm - 是否展示提示信息
     */
    PopUpService.prototype.cancelChanges = function (frameId, id, showConfirm) {
        var _this = this;
        if (showConfirm === void 0) { showConfirm = true; }
        var frameContext = this.getFrameContext(frameId);
        // 纠正主键
        id = this.getPrimaryValue(frameId, id);
        var data = this.getPersisteData(frameId, id);
        if (typeof showConfirm === 'string') {
            showConfirm = showConfirm.trim().toLowerCase() === 'false' ? false : true;
        }
        var isDataChanged = this.isDataChanged(data, frameId, id);
        var result$ = of(true);
        if (showConfirm && isDataChanged) {
            result$ = this.messageService.confirm(this.languageService.cancelWithoutSave);
        }
        return result$.pipe(switchMap(function (result) {
            if (result) {
                var befRepository = frameContext.repository;
                var bindingPaths = frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; });
                var longPaths = DataPathCreator.createByShortPathFromRoot(bindingPaths, befRepository.entityManager, _this.frameContext.bindingData).toArray().map(function (path) { return path.split(':')[1]; });
                var entityPaths = Array.from(longPaths);
                var entity = befRepository.entityManager.getEntityNodeByPath(entityPaths);
                if (entity) {
                    entity.load(data);
                }
                return of(true);
            }
            else {
                return EMPTY;
            }
        }));
    };
    /**
     * 持久化数据
     * @param frameId - 组件id
     * @param id - 数据id
     */
    PopUpService.prototype.persiste = function (frameId, id) {
        // 持久化数据
        var bindingObject = this.getBindingObject(frameId, id);
        bindingObject['__PSESISTE__DATA'] = bindingObject.toJSON();
    };
    /**
     * 获取持久化数据
     * @param frameId - 组件id
     * @param id - 数据id
     * @returns
     */
    PopUpService.prototype.getPersisteData = function (frameId, id) {
        var bindingObject = this.getBindingObject(frameId, id);
        return bindingObject['__PSESISTE__DATA'];
    };
    PopUpService.prototype.isDataChanged = function (data, frameId, id) {
        var bindingObject = this.getBindingObject(frameId, id);
        var value = bindingObject.toJSON();
        return JSON.stringify(value) !== JSON.stringify(data);
    };
    /**
     * 获取当前行
     * @param frameId - 组件id
     * @param id - 数据id
     * @returns
     * @throws 找不到对应数据时抛出无法找到对应数据的异常
     */
    PopUpService.prototype.getBindingObject = function (frameId, id) {
        var frameContext = this.getFrameContext(frameId);
        // 纠正主键
        id = this.getPrimaryValue(frameId, id);
        var bindingPaths = frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; });
        // 拿到当前行
        var bindingList = frameContext.bindingData.getValue(bindingPaths);
        if (!bindingList || bindingList.length < 1) {
            throw new Error("\u65E0\u6CD5\u627E\u5230id\u4E3A:" + id + "\u7684\u6570\u636E");
        }
        return bindingList.currentItem;
    };
    /**
     * 构造子表路径
     * @param bindingPath - 绑定路径
     * @param id - id
     * @throws 子表路径错误
     */
    PopUpService.prototype.buildPath = function (bindingPath, id) {
        var path = '/' + id;
        var subPaths = bindingPath.split('/');
        if (subPaths.length > 0) {
            // eg:bindingPath形如/edus/grades,split后是['', 'edus', 'grades']
            // 因此index从1开始
            for (var index = 1; index < subPaths.length - 1; index++) {
                var subPath = subPaths[index];
                var subData = this.frameContext.viewModel.bindingData[subPath];
                if (!subData || !subData.currentId) {
                    throw Error("\u83B7\u53D6\u5B50\u8868\u5B8C\u6574\u8DEF\u5F84\u51FA\u9519\uFF0C\u627E\u4E0D\u5230" + subData + "\u5BF9\u5E94\u7684\u5B50\u8868\uFF0C\u6216\u5BF9\u5E94\u5B50\u8868\u6CA1\u6709\u5F53\u524D\u884C\u3002");
                }
                path += "/" + subPath + "/" + subData.currentId;
            }
        }
        path += '/' + subPaths[subPaths.length - 1];
        return path;
    };
    /**
     * 根据组件id获取组件上下文
     * @param frameId - 组件id
     * @returns
     * @throws 无效的组件id
     */
    PopUpService.prototype.getFrameContext = function (frameId) {
        var frameContext = frameId ? this.frameContext.appContext.frameContextManager.getFrameContextById(frameId) : this.frameContext;
        if (!frameContext) {
            throw new Error("\u65E0\u6548\u7684\u7EC4\u4EF6id\uFF1A" + frameId);
        }
        return frameContext;
    };
    /**
     * 获取主键
     * @param frameId - 组件id
     * @param id - 数据id
     * @returns
     * @throws 组件id无效时抛出异常
     */
    PopUpService.prototype.getPrimaryValue = function (frameId, id) {
        if (!id) {
            var frameContext = this.getFrameContext(frameId);
            if (!frameContext) {
                throw new Error("\u65E0\u6548\u7684\u7EC4\u4EF6id\uFF1A" + frameId);
            }
            var bindingList = frameContext.bindingData.getList();
            if (!bindingList || bindingList.length < 1) {
                throw new Error("\u65E0\u6548\u7684\u4E3B\u952E:" + id);
            }
            id = bindingList.currentId;
        }
        return id;
    };
    PopUpService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    PopUpService.ctorParameters = function () { return [
        { type: Injector },
        { type: FrameContext },
        { type: Repository },
        { type: LanguageService },
        { type: FormMessageService }
    ]; };
    return PopUpService;
}());
export { PopUpService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wX3VwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvcG9wX3VwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDakMsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVoRCxPQUFPLEVBQUUsWUFBWSxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQTZDLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEgsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRTVEO0lBRUUsc0JBQ1UsUUFBa0IsRUFDbEIsWUFBMEIsRUFDMUIsVUFBMkIsRUFDM0IsZUFBZ0MsRUFDaEMsY0FBa0M7UUFKbEMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDaEMsbUJBQWMsR0FBZCxjQUFjLENBQW9CO0lBQ3hDLENBQUM7SUFDRSw4QkFBTyxHQUFkLGNBQW1CLENBQUM7SUFDcEI7Ozs7OztPQU1HO0lBQ0ksNkJBQU0sR0FBYixVQUFjLE9BQWUsRUFBRSxFQUFXO1FBQ3hDLElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ25HLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDakIsTUFBTSxJQUFJLEtBQUssQ0FBQyxtQ0FBaUMsT0FB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Q0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQztRQUNqSSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ2pCLE1BQU0sSUFBSSxLQUFLLENBQUMsMkNBQVcsT0FBUyxDQUFDLENBQUM7U0FDdkM7UUFDRCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDO0lBQ0Q7Ozs7OztPQU1HO0lBQ0ssc0NBQWUsR0FBdkIsVUFBd0IsT0FBZ0IsRUFBRSxFQUFXO1FBQ25ELElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDUCxJQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ25ELElBQUksQ0FBQyxZQUFZLEVBQUU7Z0JBQ2pCLE1BQU0sSUFBSSxLQUFLLENBQUMsMkNBQVcsT0FBUyxDQUFDLENBQUM7YUFDdkM7WUFDRCxJQUFNLFdBQVcsR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBaUIsQ0FBQztZQUN0RSxJQUFJLENBQUMsV0FBVyxJQUFJLFdBQVcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUMxQyxNQUFNLElBQUksS0FBSyxDQUFDLG9DQUFTLEVBQUksQ0FBQyxDQUFDO2FBQ2hDO1lBQ0QsRUFBRSxHQUFHLFdBQVcsQ0FBQyxTQUFTLENBQUM7U0FDNUI7UUFDRCxPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7O2dCQXpWRixVQUFVOzs7O2dCQVJVLFFBQVE7Z0JBSXBCLFlBQVk7Z0JBQW1CLFVBQVU7Z0JBQ3pDLGVBQWU7Z0JBQ2Ysa0JBQWtCOztJQTRWM0IsbUJBQUM7Q0FBQSxBQTFWRCxJQTBWQztTQXpWWSxZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRU1QVFksIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHN3aXRjaE1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBCZWZSZXBvc2l0b3J5IH0gZnJvbSAnQGZhcnJpcy9iZWYnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQsIERhdGFQYXRoQ3JlYXRvciwgUmVwb3NpdG9yeSwgRGF0YVBhdGgsIEVudGl0eUxpc3QsIEJpbmRpbmdMaXN0LCBFbnRpdHkgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IExhbmd1YWdlU2VydmljZSB9IGZyb20gJy4vbGFuZ3VhZy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRm9ybU1lc3NhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLW1lc3NhZ2Uuc2VydmljZSc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBQb3BVcFNlcnZpY2Uge1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXHJcbiAgICBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LFxyXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4sXHJcbiAgICBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBtZXNzYWdlU2VydmljZTogRm9ybU1lc3NhZ2VTZXJ2aWNlXHJcbiAgKSB7IH1cclxuICBwdWJsaWMgY29uZmlybSgpIHsgfVxyXG4gIC8qKlxyXG4gICAqIOWPlua2iOWPmOabtFxyXG4gICAqIEBwYXJhbSBmcmFtZUlkXHJcbiAgICogQHBhcmFtIGlkXHJcbiAgICogQHJldHVybnNcclxuICAgKiBAdGhyb3dzIGludmFsaWQgZnJhbWVpZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjYW5jZWwoZnJhbWVJZDogc3RyaW5nLCBpZD86IHN0cmluZykge1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dEJ5SWQoZnJhbWVJZCk7XHJcbiAgICBpZiAoIWZyYW1lQ29udGV4dCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFtQb3BVcFNlcnZpY2VdSW52YWxpZCBmcmFtZUlkICR7ZnJhbWVJZH1gKTtcclxuICAgIH1cclxuICAgIGNvbnN0IHByaW1hcnlWYWx1ZSA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkO1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGggPSBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoO1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIoKHApID0+IHApO1xyXG4gICAgaWYgKCFpZCkge1xyXG4gICAgICBjb25zdCBiaW5kaW5nTGlzdCA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldExpc3QoKSBhcyBCaW5kaW5nTGlzdDtcclxuICAgICAgaWQgPSBiaW5kaW5nTGlzdC5jdXJyZW50SWQ7XHJcbiAgICB9XHJcbiAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcclxuICAgIGNvbnN0IGxvbmdQYXRocyA9IChEYXRhUGF0aENyZWF0b3IuY3JlYXRlQnlTaG9ydFBhdGhGcm9tUm9vdChiaW5kaW5nUGF0aHMsIGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlciwgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEpIGFzIERhdGFQYXRoKS50b0FycmF5KCkubWFwKChwYXRoOiBzdHJpbmcpID0+IHBhdGguc3BsaXQoJzonKVsxXSk7XHJcbiAgICBjb25zdCBlbnRpdHlMaXN0UGF0aHMgPSBBcnJheS5mcm9tKGxvbmdQYXRocyk7XHJcbiAgICAvLyDoiI3lvIPlvZPliY3ooajlvZPliY3ooYxcclxuICAgIGVudGl0eUxpc3RQYXRocy5wb3AoKTtcclxuICAgIGNvbnN0IGRpYWxvZ1JlZiA9IHRoaXMuZnJhbWVDb250ZXh0LmZyYW1lQ29tcG9uZW50WydkaWFsb2dSZWYnXTtcclxuICAgIGlmIChlbnRpdHlMaXN0UGF0aHMubGVuZ3RoIDwgMSkge1xyXG4gICAgICAvLyDkuLvooahcclxuICAgICAgY29uc3QgZW50aXR5ID0gdGhpcy5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChpZCkgYXMgRW50aXR5O1xyXG4gICAgICBjb25zdCBvcmlnaW5hbERhdGEgPSBlbnRpdHlbJ29yaWdpbmFsRGF0YSddO1xyXG4gICAgICBlbnRpdHkubG9hZChvcmlnaW5hbERhdGEsIHsgbG9hZENoaWxkOiBmYWxzZSB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IGVudGl0eUxpc3QgPSBiZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIuZ2V0RW50aXR5Tm9kZUJ5UGF0aChlbnRpdHlMaXN0UGF0aHMpIGFzIEVudGl0eUxpc3Q8YW55PjtcclxuICAgICAgaWYgKGVudGl0eUxpc3QpIHtcclxuICAgICAgICBjb25zdCBvcmlnaW5hbERhdGE6IGFueVtdID0gZW50aXR5TGlzdFsnb3JpZ2luYWxEYXRhJ107XHJcbiAgICAgICAgY29uc3QgaXRlbSA9IG9yaWdpbmFsRGF0YS5maW5kKChpdGVtKSA9PiBpdGVtLmlkID09PSBpZCk7XHJcbiAgICAgICAgaWYgKGl0ZW0pIHtcclxuICAgICAgICAgIC8vIOW3suacieaVsOaNru+8jOi/mOWOn+WPmOabtFxyXG4gICAgICAgICAgY29uc3QgZW50aXR5OiBFbnRpdHkgPSBiZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIuZ2V0RW50aXR5QnlQYXRoKGxvbmdQYXRocykgYXMgRW50aXR5O1xyXG4gICAgICAgICAgaWYgKGVudGl0eS5jaGFuZ2VzICYmIGVudGl0eS5jaGFuZ2VzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMubWVzc2FnZVNlcnZpY2UuY29uZmlybSh0aGlzLmxhbmd1YWdlU2VydmljZS5jYW5jZWxXaXRob3V0U2F2ZSkucGlwZShcclxuICAgICAgICAgICAgICB0YXAoKHJlc3VsdDogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgICBlbnRpdHkubG9hZChpdGVtLCB7IGxvYWRDaGlsZDogZmFsc2UgfSk7XHJcbiAgICAgICAgICAgICAgICAgIGVudGl0eS5jaGFuZ2VzLnNwbGljZSgwLCBlbnRpdHkuY2hhbmdlcy5sZW5ndGgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyDmsqHmnInkv67mlLnvvIznm7TmjqXlhbPpl61cclxuICAgICAgICAgICAgaWYgKGRpYWxvZ1JlZikge1xyXG4gICAgICAgICAgICAgIGRpYWxvZ1JlZi5jbG9zZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIC8vIOaWsOWinueahOaVsOaNru+8jOWIoOmZpFxyXG4gICAgICAgICAgY29uc3QgcGF0aHMgPSB0aGlzLmJ1aWxkUGF0aChiaW5kaW5nUGF0aCwgcHJpbWFyeVZhbHVlKTtcclxuICAgICAgICAgIHJldHVybiB0aGlzLm1lc3NhZ2VTZXJ2aWNlLmNvbmZpcm0odGhpcy5sYW5ndWFnZVNlcnZpY2UuY2FuY2VsV2l0aG91dFNhdmUpLnBpcGUoXHJcbiAgICAgICAgICAgIHN3aXRjaE1hcCgocmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGJlZlJlcG9zaXRvcnkucmVtb3ZlRW50aXR5QnlQYXRoKHBhdGhzLCBpZCkucGlwZShcclxuICAgICAgICAgICAgICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBiZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIucmVtb3ZlRW50aXR5QnlQYXRoKHBhdGhzLCBpZCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHlMaXN0LmNvdW50KCkgPT09IDAgJiYgZGlhbG9nUmVmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICBkaWFsb2dSZWYuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBvZihbXSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWQjOatpeW9k+WJjeihjFxyXG4gICAqIEBwYXJhbSBpZCDlvZPliY3ooYxcclxuICAgKi9cclxuICBwdWJsaWMgdXBkYXRlQ3VycmVudFJvdyhpZD86IHN0cmluZykge1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGggPSB0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGg7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcigocCkgPT4gcCk7XHJcbiAgICAvLyBjb25zdCBmcmFtZUlkID0gdGhpcy5mcmFtZUNvbnRleHQuZnJhbWVJZDtcclxuICAgIGNvbnN0IHJvb3QgPSB0aGlzLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpO1xyXG4gICAgY29uc3QgcHJpbWFyeUtleVZhbHVlID0gcm9vdC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZDtcclxuICAgIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3Quc2V0Q3VycmVudElkKHByaW1hcnlLZXlWYWx1ZSk7XHJcbiAgICBpZiAoYmluZGluZ1BhdGhzLmxlbmd0aCA+IDApIHtcclxuICAgICAgY29uc3QgcGF0aHMgPSBbXTtcclxuICAgICAgYmluZGluZ1BhdGhzLmZvckVhY2goKHBhdGg6IHN0cmluZywgaW5kZXg6IG51bWJlciwgYXJyYXkpID0+IHtcclxuICAgICAgICBwYXRocy5wdXNoKHBhdGgpO1xyXG4gICAgICAgIGNvbnN0IGJpbmRpbmdMaXN0ID0gcm9vdC5iaW5kaW5nRGF0YS5nZXRWYWx1ZShwYXRocykgYXMgQmluZGluZ0xpc3Q7XHJcbiAgICAgICAgaWYgKGJpbmRpbmdMaXN0KSB7XHJcbiAgICAgICAgICBjb25zdCBjdXJyZW50SWQgPSBiaW5kaW5nTGlzdC5jdXJyZW50SWQ7XHJcbiAgICAgICAgICBjb25zdCBtb2RhbEJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xyXG4gICAgICAgICAgaWYgKGluZGV4ID09PSBiaW5kaW5nUGF0aC5sZW5ndGggLSAxICYmIGlkKSB7XHJcbiAgICAgICAgICAgIG1vZGFsQmluZGluZ0xpc3Quc2V0Q3VycmVudElkKGlkKTtcclxuICAgICAgICAgIH0gZWxzZSBpZiAobW9kYWxCaW5kaW5nTGlzdCkge1xyXG4gICAgICAgICAgICBtb2RhbEJpbmRpbmdMaXN0LnNldEN1cnJlbnRJZChjdXJyZW50SWQpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHB1YmxpYyBjbG9zZUNoZWNrKCkge1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gdGhpcy5mcmFtZUNvbnRleHQ7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGg7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcigocCkgPT4gcCk7XHJcbiAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcclxuICAgIGNvbnN0IGxvbmdQYXRocyA9IChEYXRhUGF0aENyZWF0b3IuY3JlYXRlQnlTaG9ydFBhdGhGcm9tUm9vdChiaW5kaW5nUGF0aHMsIGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlciwgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEpIGFzIERhdGFQYXRoKS50b0FycmF5KCkubWFwKChwYXRoOiBzdHJpbmcpID0+IHBhdGguc3BsaXQoJzonKVsxXSk7XHJcbiAgICBjb25zdCBlbnRpdHlMaXN0UGF0aHMgPSBBcnJheS5mcm9tKGxvbmdQYXRocyk7XHJcbiAgICBlbnRpdHlMaXN0UGF0aHMucG9wKCk7XHJcbiAgICBjb25zdCBlbnRpdHlMaXN0ID0gYmVmUmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLmdldEVudGl0eU5vZGVCeVBhdGgoZW50aXR5TGlzdFBhdGhzKSBhcyBFbnRpdHlMaXN0PGFueT47XHJcbiAgICBjb25zdCBkaWFsb2dSZWYgPSB0aGlzLmZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudFsnZGlhbG9nUmVmJ107XHJcbiAgICBpZiAoZW50aXR5TGlzdC5jb3VudCgpID09PSAwICYmIGRpYWxvZ1JlZikge1xyXG4gICAgICBkaWFsb2dSZWYuY2xvc2UoKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yig6Zmk5by556qX5Lit55qE5b2T5YmN6KGM5pWw5o2uXHJcbiAgICogQHBhcmFtIGZyYW1lSWQgLeWPr+mAie+8jOimgeWIoOmZpOaVsOaNruaJgOWcqOe7hOS7tueahGlk77yM6buY6K6k5Li65ZG95Luk5omA5Zyo55qE57uE5Lu2XHJcbiAgICogQHBhcmFtIGlkIC3lj6/pgInvvIzopoHliKDpmaTmlbDmja7nmoRpZO+8jOm7mOiupOS4uuWRveS7pOaJgOWcqOe7hOS7tueahOW9k+WJjeihjOaVsOaNrmlkXHJcbiAgICogQHBhcmFtIHNob3dDb25maXJtIC3lj6/pgInvvIzliKDpmaTmlbDmja7ml7bmmK/lkKbov5vooYzliKDpmaTliY3nmoTnoa7orqTvvIzpu5jorqTkuLpgdHJ1ZWBcclxuICAgKiBAcmV0dXJuc1xyXG4gICAqIEB0aHJvd3Mg57uE5Lu2aWTplJnor6/ml7bmipvlh7rplJnor69cclxuICAgKi9cclxuICBwdWJsaWMgcmVtb3ZlUm93KGZyYW1lSWQ/OiBzdHJpbmcsIGlkPzogc3RyaW5nLCBzaG93Q29uZmlybTogc3RyaW5nIHwgYm9vbGVhbiA9IHRydWUpIHtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IGZyYW1lSWQgPyB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0QnlJZChmcmFtZUlkKSA6IHRoaXMuZnJhbWVDb250ZXh0O1xyXG4gICAgaWYgKCFmcmFtZUNvbnRleHQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGDml6DmlYjnmoTnu4Tku7ZpZO+8miR7ZnJhbWVJZH1gKTtcclxuICAgIH1cclxuICAgIC8vIOe6oOato+S4u+mUrlxyXG4gICAgaWYgKCFpZCkge1xyXG4gICAgICBjb25zdCBiaW5kaW5nTGlzdCA9IGZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRMaXN0KCkgYXMgQmluZGluZ0xpc3Q7XHJcbiAgICAgIGlkID0gYmluZGluZ0xpc3QuY3VycmVudElkO1xyXG4gICAgfVxyXG4gICAgY29uc3QgYmluZGluZ1BhdGggPSBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoO1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIoKHApID0+IHApO1xyXG4gICAgY29uc3QgcGF0aHMgPSB0aGlzLmJ1aWxkUGF0aChiaW5kaW5nUGF0aCwgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQpO1xyXG4gICAgY29uc3QgYmVmUmVwb3NpdG9yeSA9IHRoaXMucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PGFueT47XHJcbiAgICAvLyDovazmjaJzaG93Q29uZmlybeS4uuW4g+WwlFxyXG4gICAgaWYgKHR5cGVvZiBzaG93Q29uZmlybSA9PSAnc3RyaW5nJykge1xyXG4gICAgICBzaG93Q29uZmlybSA9IHNob3dDb25maXJtLnRyaW0oKSA9PT0gJ2ZhbHNlJyA/IGZhbHNlIDogdHJ1ZTtcclxuICAgIH1cclxuICAgIGxldCBjb25maXJtJCA9IG9mKHRydWUpO1xyXG4gICAgaWYgKHNob3dDb25maXJtKSB7XHJcbiAgICAgIGNvbmZpcm0kID0gdGhpcy5tZXNzYWdlU2VydmljZS5jb25maXJtKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNvbmZpcm1EZWxldGlvbik7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gY29uZmlybSQucGlwZShcclxuICAgICAgc3dpdGNoTWFwKChyZXN1bHQpID0+IHtcclxuICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICBpZiAoYmluZGluZ1BhdGhzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAvLyDkuLvooajliKDpmaTvvIzkuI3nq4vljbPkv53lrZhcclxuICAgICAgICAgICAgcmV0dXJuIGJlZlJlcG9zaXRvcnkucmVtb3ZlRW50aXR5QnlJZChpZCwgZmFsc2UpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIGJlZlJlcG9zaXRvcnkucmVtb3ZlRW50aXR5QnlQYXRoKHBhdGhzLCBpZCkucGlwZShcclxuICAgICAgICAgICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgYmVmUmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLnJlbW92ZUVudGl0eUJ5UGF0aChwYXRocywgaWQpO1xyXG4gICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlhbPpl63lvLnnqpdcclxuICAgKiBAcGFyYW0gZnJhbWVJZCAt5Y+v6YCJ77yM57uE5Lu2aWTvvIzkuI3mjIflrprml7bkvb/nlKjlkb3ku6TmiYDlnKjnmoTkuIrkuIvmlofnu4Tku7ZcclxuICAgKiBAdGhyb3dzIOS9v+eUqOaMh+WumueahOe7hOS7tmlk5peg5rOV6I635Y+W57uE5Lu25Y+K5by556qX57uE5Lu25a6e5L6L6I635Y+W5aSx6LSl5pe25Lya5oqb5Ye65byC5bi4XHJcbiAgICovXHJcbiAgcHVibGljIGNsb3NlRGlhbG9nKGZyYW1lSWQ/OiBzdHJpbmcpIHtcclxuICAgIGxldCBmcmFtZUNvbnRleHQgPSB0aGlzLmZyYW1lQ29udGV4dDtcclxuICAgIGxldCBkaWFsb2dSZWYgPSBudWxsO1xyXG4gICAgLy8g5byA5Y+R6ICF5oyH5a6a5LqG57uE5Lu2aWRcclxuICAgIGlmIChmcmFtZUlkKSB7XHJcbiAgICAgIGZyYW1lQ29udGV4dCA9IHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRCeUlkKGZyYW1lSWQpO1xyXG4gICAgICBpZiAoIWZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcign5oyH5a6a5LqG5peg5pWI55qE57uE5Lu2aWQnKTtcclxuICAgICAgfVxyXG4gICAgICBkaWFsb2dSZWYgPSBmcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnRbJ2RpYWxvZ1JlZiddO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8g5bCd6K+V5LuO5b2T5YmN57uE5Lu25LiK5LiL5paH5Lit6I635Y+W5by556qX5byV55SoXHJcbiAgICAgIGRpYWxvZ1JlZiA9IGZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudFsnZGlhbG9nUmVmJ107XHJcbiAgICAgIGlmICghZGlhbG9nUmVmKSB7XHJcbiAgICAgICAgLy8g5aaC5p6c5ZG95Luk5oyC6L295Yiw5LqG5YaF5a6557uE5Lu25LiKXHJcbiAgICAgICAgZGlhbG9nUmVmID0gdGhpcy5mcmFtZUNvbnRleHQucGFyZW50LmZyYW1lQ29tcG9uZW50WydkaWFsb2dSZWYnXTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKCFkaWFsb2dSZWYpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGDml6Dms5Xojrflj5blvLnnqpfnu4Tku7blrp7kvotgKTtcclxuICAgIH1cclxuICAgIGRpYWxvZ1JlZi5jbG9zZSgpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDov5jljp/oh6rkuIrmrKHmjIHkuYXljJbku6XlkI7kuqfnlJ/nmoTlj5jmm7RcclxuICAgKiBAcGFyYW0gZnJhbWVJZCAtIOe7hOS7tmlkXHJcbiAgICogQHBhcmFtIGlkIC0g5pWw5o2uaWRcclxuICAgKiBAcGFyYW0gc2hvd0NvbmZpcm0gLSDmmK/lkKblsZXnpLrmj5DnpLrkv6Hmga9cclxuICAgKi9cclxuICBwdWJsaWMgY2FuY2VsQ2hhbmdlcyhmcmFtZUlkPzogc3RyaW5nLCBpZD86IHN0cmluZywgc2hvd0NvbmZpcm06IGJvb2xlYW4gfCBzdHJpbmcgPSB0cnVlKSB7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSB0aGlzLmdldEZyYW1lQ29udGV4dChmcmFtZUlkKTtcclxuICAgIC8vIOe6oOato+S4u+mUrlxyXG4gICAgaWQgPSB0aGlzLmdldFByaW1hcnlWYWx1ZShmcmFtZUlkLCBpZCk7XHJcbiAgICBjb25zdCBkYXRhID0gdGhpcy5nZXRQZXJzaXN0ZURhdGEoZnJhbWVJZCwgaWQpO1xyXG4gICAgaWYgKHR5cGVvZiBzaG93Q29uZmlybSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgc2hvd0NvbmZpcm0gPSBzaG93Q29uZmlybS50cmltKCkudG9Mb3dlckNhc2UoKSA9PT0gJ2ZhbHNlJyA/IGZhbHNlIDogdHJ1ZTtcclxuICAgIH1cclxuICAgIGNvbnN0IGlzRGF0YUNoYW5nZWQgPSB0aGlzLmlzRGF0YUNoYW5nZWQoZGF0YSwgZnJhbWVJZCwgaWQpO1xyXG4gICAgbGV0IHJlc3VsdCQgPSBvZih0cnVlKTtcclxuICAgIGlmIChzaG93Q29uZmlybSAmJiBpc0RhdGFDaGFuZ2VkKSB7XHJcbiAgICAgIHJlc3VsdCQgPSB0aGlzLm1lc3NhZ2VTZXJ2aWNlLmNvbmZpcm0odGhpcy5sYW5ndWFnZVNlcnZpY2UuY2FuY2VsV2l0aG91dFNhdmUpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdCQucGlwZShcclxuICAgICAgc3dpdGNoTWFwKChyZXN1bHQ6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxhbnk+O1xyXG4gICAgICAgICAgY29uc3QgYmluZGluZ1BhdGhzID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcigocCkgPT4gcCk7XHJcbiAgICAgICAgICBjb25zdCBsb25nUGF0aHMgPSAoRGF0YVBhdGhDcmVhdG9yLmNyZWF0ZUJ5U2hvcnRQYXRoRnJvbVJvb3QoYmluZGluZ1BhdGhzLCBiZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIsIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhKSBhcyBEYXRhUGF0aCkudG9BcnJheSgpLm1hcCgocGF0aDogc3RyaW5nKSA9PiBwYXRoLnNwbGl0KCc6JylbMV0pO1xyXG4gICAgICAgICAgY29uc3QgZW50aXR5UGF0aHMgPSBBcnJheS5mcm9tKGxvbmdQYXRocyk7XHJcbiAgICAgICAgICBjb25zdCBlbnRpdHkgPSBiZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIuZ2V0RW50aXR5Tm9kZUJ5UGF0aChlbnRpdHlQYXRocykgYXMgRW50aXR5O1xyXG4gICAgICAgICAgaWYgKGVudGl0eSkge1xyXG4gICAgICAgICAgICBlbnRpdHkubG9hZChkYXRhKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaMgeS5heWMluaVsOaNrlxyXG4gICAqIEBwYXJhbSBmcmFtZUlkIC0g57uE5Lu2aWRcclxuICAgKiBAcGFyYW0gaWQgLSDmlbDmja5pZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBwZXJzaXN0ZShmcmFtZUlkPzogc3RyaW5nLCBpZD86IHN0cmluZykge1xyXG4gICAgLy8g5oyB5LmF5YyW5pWw5o2uXHJcbiAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gdGhpcy5nZXRCaW5kaW5nT2JqZWN0KGZyYW1lSWQsIGlkKTtcclxuICAgIGJpbmRpbmdPYmplY3RbJ19fUFNFU0lTVEVfX0RBVEEnXSA9IGJpbmRpbmdPYmplY3QudG9KU09OKCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluaMgeS5heWMluaVsOaNrlxyXG4gICAqIEBwYXJhbSBmcmFtZUlkIC0g57uE5Lu2aWRcclxuICAgKiBAcGFyYW0gaWQgLSDmlbDmja5pZFxyXG4gICAqIEByZXR1cm5zXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRQZXJzaXN0ZURhdGEoZnJhbWVJZD86IHN0cmluZywgaWQ/OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSB0aGlzLmdldEJpbmRpbmdPYmplY3QoZnJhbWVJZCwgaWQpO1xyXG4gICAgcmV0dXJuIGJpbmRpbmdPYmplY3RbJ19fUFNFU0lTVEVfX0RBVEEnXTtcclxuICB9XHJcbiAgcHJpdmF0ZSBpc0RhdGFDaGFuZ2VkKGRhdGE6IHsgW3Byb3A6IHN0cmluZ106IGFueSB9LCBmcmFtZUlkPzogc3RyaW5nLCBpZD86IHN0cmluZykge1xyXG4gICAgY29uc3QgYmluZGluZ09iamVjdCA9IHRoaXMuZ2V0QmluZGluZ09iamVjdChmcmFtZUlkLCBpZCk7XHJcbiAgICBjb25zdCB2YWx1ZSA9IGJpbmRpbmdPYmplY3QudG9KU09OKCk7XHJcbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodmFsdWUpICE9PSBKU09OLnN0cmluZ2lmeShkYXRhKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5b2T5YmN6KGMXHJcbiAgICogQHBhcmFtIGZyYW1lSWQgLSDnu4Tku7ZpZFxyXG4gICAqIEBwYXJhbSBpZCAtIOaVsOaNrmlkXHJcbiAgICogQHJldHVybnNcclxuICAgKiBAdGhyb3dzIOaJvuS4jeWIsOWvueW6lOaVsOaNruaXtuaKm+WHuuaXoOazleaJvuWIsOWvueW6lOaVsOaNrueahOW8guW4uFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0QmluZGluZ09iamVjdChmcmFtZUlkPzogc3RyaW5nLCBpZD86IHN0cmluZykge1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gdGhpcy5nZXRGcmFtZUNvbnRleHQoZnJhbWVJZCk7XHJcbiAgICAvLyDnuqDmraPkuLvplK5cclxuICAgIGlkID0gdGhpcy5nZXRQcmltYXJ5VmFsdWUoZnJhbWVJZCwgaWQpO1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcigocCkgPT4gcCk7XHJcbiAgICAvLyDmi7/liLDlvZPliY3ooYxcclxuICAgIGNvbnN0IGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCA9IGZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRWYWx1ZShiaW5kaW5nUGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xyXG4gICAgaWYgKCFiaW5kaW5nTGlzdCB8fCBiaW5kaW5nTGlzdC5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihg5peg5rOV5om+5YiwaWTkuLo6JHtpZH3nmoTmlbDmja5gKTtcclxuICAgIH1cclxuICAgIHJldHVybiBiaW5kaW5nTGlzdC5jdXJyZW50SXRlbTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5a2Q6KGo6Lev5b6EXHJcbiAgICogQHBhcmFtIGJpbmRpbmdQYXRoIC0g57uR5a6a6Lev5b6EXHJcbiAgICogQHBhcmFtIGlkIC0gaWRcclxuICAgKiBAdGhyb3dzIOWtkOihqOi3r+W+hOmUmeivr1xyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGRQYXRoKGJpbmRpbmdQYXRoOiBzdHJpbmcsIGlkOiBhbnkpIHtcclxuICAgIGxldCBwYXRoID0gJy8nICsgaWQ7XHJcbiAgICBjb25zdCBzdWJQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJyk7XHJcbiAgICBpZiAoc3ViUGF0aHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAvLyBlZzpiaW5kaW5nUGF0aOW9ouWmgi9lZHVzL2dyYWRlcyxzcGxpdOWQjuaYr1snJywgJ2VkdXMnLCAnZ3JhZGVzJ11cclxuICAgICAgLy8g5Zug5q2kaW5kZXjku44x5byA5aeLXHJcbiAgICAgIGZvciAobGV0IGluZGV4ID0gMTsgaW5kZXggPCBzdWJQYXRocy5sZW5ndGggLSAxOyBpbmRleCsrKSB7XHJcbiAgICAgICAgY29uc3Qgc3ViUGF0aCA9IHN1YlBhdGhzW2luZGV4XTtcclxuICAgICAgICBjb25zdCBzdWJEYXRhID0gdGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdEYXRhW3N1YlBhdGhdO1xyXG4gICAgICAgIGlmICghc3ViRGF0YSB8fCAhc3ViRGF0YS5jdXJyZW50SWQpIHtcclxuICAgICAgICAgIHRocm93IEVycm9yKGDojrflj5blrZDooajlrozmlbTot6/lvoTlh7rplJnvvIzmib7kuI3liLAke3N1YkRhdGF95a+55bqU55qE5a2Q6KGo77yM5oiW5a+55bqU5a2Q6KGo5rKh5pyJ5b2T5YmN6KGM44CCYCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHBhdGggKz0gYC8ke3N1YlBhdGh9LyR7c3ViRGF0YS5jdXJyZW50SWR9YDtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcGF0aCArPSAnLycgKyBzdWJQYXRoc1tzdWJQYXRocy5sZW5ndGggLSAxXTtcclxuICAgIHJldHVybiBwYXRoO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmoLnmja7nu4Tku7ZpZOiOt+WPlue7hOS7tuS4iuS4i+aWh1xyXG4gICAqIEBwYXJhbSBmcmFtZUlkIC0g57uE5Lu2aWRcclxuICAgKiBAcmV0dXJuc1xyXG4gICAqIEB0aHJvd3Mg5peg5pWI55qE57uE5Lu2aWRcclxuICAgKi9cclxuICBwcml2YXRlIGdldEZyYW1lQ29udGV4dChmcmFtZUlkPzogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSBmcmFtZUlkID8gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dEJ5SWQoZnJhbWVJZCkgOiB0aGlzLmZyYW1lQ29udGV4dDtcclxuICAgIGlmICghZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihg5peg5pWI55qE57uE5Lu2aWTvvJoke2ZyYW1lSWR9YCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZnJhbWVDb250ZXh0O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bkuLvplK5cclxuICAgKiBAcGFyYW0gZnJhbWVJZCAtIOe7hOS7tmlkXHJcbiAgICogQHBhcmFtIGlkIC0g5pWw5o2uaWRcclxuICAgKiBAcmV0dXJuc1xyXG4gICAqIEB0aHJvd3Mg57uE5Lu2aWTml6DmlYjml7bmipvlh7rlvILluLhcclxuICAgKi9cclxuICBwcml2YXRlIGdldFByaW1hcnlWYWx1ZShmcmFtZUlkPzogc3RyaW5nLCBpZD86IHN0cmluZykge1xyXG4gICAgaWYgKCFpZCkge1xyXG4gICAgICBjb25zdCBmcmFtZUNvbnRleHQgPSB0aGlzLmdldEZyYW1lQ29udGV4dChmcmFtZUlkKTtcclxuICAgICAgaWYgKCFmcmFtZUNvbnRleHQpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYOaXoOaViOeahOe7hOS7tmlk77yaJHtmcmFtZUlkfWApO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdMaXN0ID0gZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldExpc3QoKSBhcyBCaW5kaW5nTGlzdDtcclxuICAgICAgaWYgKCFiaW5kaW5nTGlzdCB8fCBiaW5kaW5nTGlzdC5sZW5ndGggPCAxKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGDml6DmlYjnmoTkuLvplK46JHtpZH1gKTtcclxuICAgICAgfVxyXG4gICAgICBpZCA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJZDtcclxuICAgIH1cclxuICAgIHJldHVybiBpZDtcclxuICB9XHJcbn1cclxuIl19