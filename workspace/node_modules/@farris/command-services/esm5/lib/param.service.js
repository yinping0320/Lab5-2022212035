import { Injectable } from '@angular/core';
import { QuerystringService } from './querystring';
import { RuntimeFrameworkService } from './rtf-service';
import { of, Subject } from 'rxjs';
import { switchMap } from 'rxjs/operators';
// tslint:disable: no-string-literal
/**
 * 参数服务
 * @scope FormModule
 */
var ParamService = /** @class */ (function () {
    function ParamService(querystringService, runtimeFrameworkService) {
        this.querystringService = querystringService;
        this.runtimeFrameworkService = runtimeFrameworkService;
    }
    Object.defineProperty(ParamService.prototype, "params", {
        /**
         * 适配获取所有参数
         */
        get: function () {
            var _this = this;
            // 先从hash中获取参数
            var hash = window.location.hash;
            var params = this.querystringService.parse(hash);
            /*
            const appMode = params.appMode;
            // appMode没有定义，认为是老表单,appMode = mdi 或 spa
            if (typeof appMode === 'undefined' || appMode === null) {
                return of(params);
            }
            // appMode存在，但为空，也认为是老表单
            if (appMode.length < 1) {
                return of(params);
            }
            // 新表单，使用iframe模式
            if (appMode.toLowerCase() === 'mdi') {
                return of(params);
            }
            */
            // 获取tabId，最新版本一定有tabId，如果取不到tabId则认为是老表单，直接从url获取参数
            var tabId = params.tabId;
            if (!tabId) {
                // throw new Error('TabId can`t be empty!');
                return of(params);
            }
            var subject = new Subject();
            // 管道参数e可能为object、Map类型
            this.runtimeFrameworkService.addEventListener(tabId, function (e) {
                var map = {};
                if (e instanceof Map || (e && typeof (e['get']) === 'function' && typeof e['entries'] === 'function')) {
                    map = _this.parseMapParams(e);
                }
                var args = {};
                if (e instanceof Map || (e && typeof (e['get']) === 'function' && typeof e['entries'] === 'function')) {
                    args = new Map(e);
                }
                else {
                    args = Object.assign({}, e);
                }
                setTimeout(function () {
                    subject.next(Object.assign({}, args, map, params));
                }, 0);
            }, params);
            return subject.asObservable();
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 解析map类型的参数
     * @param params params
     */
    ParamService.prototype.parseMapParams = function (params) {
        var map = {};
        map['WEB_FORM_ROUTE_PARAMS'] = decodeURIComponent(params.get('WEB_FORM_ROUTE_PARAMS'));
        params.forEach(function (value, key) {
            if (key !== 'WEB_FORM_ROUTE_PARAMS') {
                map[key] = value;
            }
        });
        return map;
    };
    /**
     * 获取param参数
     * @param param key
     */
    ParamService.prototype.get = function (param) {
        return this.params.pipe(switchMap(function (options) {
            if (!!options && options.hasOwnProperty(param)) {
                return of(options.param);
            }
            else {
                return of(undefined);
            }
        }));
    };
    /**
     * 参数转为对象
     */
    ParamService.prototype.parse = function () {
        return this.params.pipe(switchMap(function (options) {
            return of(options);
        }));
    };
    ParamService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ParamService.ctorParameters = function () { return [
        { type: QuerystringService },
        { type: RuntimeFrameworkService }
    ]; };
    return ParamService;
}());
export { ParamService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyYW0uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9wYXJhbS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RCxPQUFPLEVBQUUsRUFBRSxFQUErQixPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDaEUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLG9DQUFvQztBQUNwQzs7O0dBR0c7QUFDSDtJQUVFLHNCQUNVLGtCQUFzQyxFQUN0Qyx1QkFBZ0Q7UUFEaEQsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0Qyw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXlCO0lBQ3RELENBQUM7SUFJTCxzQkFBVyxnQ0FBTTtRQUhqQjs7V0FFRzthQUNIO1lBQUEsaUJBMkNDO1lBMUNDLGNBQWM7WUFDZCxJQUFNLElBQUksR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztZQUNsQyxJQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ25EOzs7Ozs7Ozs7Ozs7OztjQWNFO1lBQ0Ysb0RBQW9EO1lBQ3BELElBQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUM7WUFDM0IsSUFBSSxDQUFDLEtBQUssRUFBRTtnQkFDViw0Q0FBNEM7Z0JBQzVDLE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ25CO1lBQ0QsSUFBTSxPQUFPLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztZQUNuQyx1QkFBdUI7WUFDdkIsSUFBSSxDQUFDLHVCQUF1QixDQUFDLGdCQUFnQixDQUFDLEtBQUssRUFBRSxVQUFDLENBQU07Z0JBQzFELElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQztnQkFDYixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxDQUFDLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLFVBQVUsSUFBSSxPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxVQUFVLENBQUMsRUFBRTtvQkFDckcsR0FBRyxHQUFHLEtBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQzlCO2dCQUNELElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztnQkFDZCxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxDQUFDLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLFVBQVUsSUFBSSxPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxVQUFVLENBQUMsRUFBRTtvQkFDckcsSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNuQjtxQkFBTTtvQkFDTCxJQUFJLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7aUJBQzdCO2dCQUNELFVBQVUsQ0FBQztvQkFDVCxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDckQsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ1IsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ1gsT0FBTyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDaEMsQ0FBQzs7O09BQUE7SUFDRDs7O09BR0c7SUFDSyxxQ0FBYyxHQUF0QixVQUF1QixNQUFxQjtRQUMxQyxJQUFNLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDZixHQUFHLENBQUMsdUJBQXVCLENBQUMsR0FBRyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHVCQUF1QixDQUFDLENBQUMsQ0FBQztRQUN2RixNQUFNLENBQUMsT0FBTyxDQUFDLFVBQUMsS0FBSyxFQUFFLEdBQUc7WUFDeEIsSUFBSSxHQUFHLEtBQUssdUJBQXVCLEVBQUU7Z0JBQ25DLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUM7YUFDbEI7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztJQUNEOzs7T0FHRztJQUNJLDBCQUFHLEdBQVYsVUFBVyxLQUFhO1FBQ3RCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQ3JCLFNBQVMsQ0FBQyxVQUFBLE9BQU87WUFDZixJQUFJLENBQUMsQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDOUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQzFCO2lCQUFNO2dCQUNMLE9BQU8sRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQ3RCO1FBQ0gsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFDRDs7T0FFRztJQUNJLDRCQUFLLEdBQVo7UUFDRSxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNyQixTQUFTLENBQUMsVUFBQSxPQUFPO1lBQ2YsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDckIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7O2dCQTNGRixVQUFVOzs7O2dCQVRGLGtCQUFrQjtnQkFDbEIsdUJBQXVCOztJQW9HaEMsbUJBQUM7Q0FBQSxBQTVGRCxJQTRGQztTQTNGWSxZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBRdWVyeXN0cmluZ1NlcnZpY2UgfSBmcm9tICcuL3F1ZXJ5c3RyaW5nJztcclxuaW1wb3J0IHsgUnVudGltZUZyYW1ld29ya1NlcnZpY2UgfSBmcm9tICcuL3J0Zi1zZXJ2aWNlJztcclxuaW1wb3J0IHsgb2YsIE9ic2VydmFibGUsIEJlaGF2aW9yU3ViamVjdCwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbi8vIHRzbGludDpkaXNhYmxlOiBuby1zdHJpbmctbGl0ZXJhbFxyXG4vKipcclxuICog5Y+C5pWw5pyN5YqhXHJcbiAqIEBzY29wZSBGb3JtTW9kdWxlXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBQYXJhbVNlcnZpY2Uge1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBxdWVyeXN0cmluZ1NlcnZpY2U6IFF1ZXJ5c3RyaW5nU2VydmljZSxcclxuICAgIHByaXZhdGUgcnVudGltZUZyYW1ld29ya1NlcnZpY2U6IFJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlXHJcbiAgKSB7IH1cclxuICAvKipcclxuICAgKiDpgILphY3ojrflj5bmiYDmnInlj4LmlbBcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0IHBhcmFtcygpOiBPYnNlcnZhYmxlPHsgW3Byb3BOYW1lOiBzdHJpbmddOiBhbnkgfT4ge1xyXG4gICAgLy8g5YWI5LuOaGFzaOS4reiOt+WPluWPguaVsFxyXG4gICAgY29uc3QgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoO1xyXG4gICAgY29uc3QgcGFyYW1zID0gdGhpcy5xdWVyeXN0cmluZ1NlcnZpY2UucGFyc2UoaGFzaCk7XHJcbiAgICAvKlxyXG4gICAgY29uc3QgYXBwTW9kZSA9IHBhcmFtcy5hcHBNb2RlO1xyXG4gICAgLy8gYXBwTW9kZeayoeacieWumuS5ie+8jOiupOS4uuaYr+iAgeihqOWNlSxhcHBNb2RlID0gbWRpIOaIliBzcGFcclxuICAgIGlmICh0eXBlb2YgYXBwTW9kZSA9PT0gJ3VuZGVmaW5lZCcgfHwgYXBwTW9kZSA9PT0gbnVsbCkge1xyXG4gICAgICAgIHJldHVybiBvZihwYXJhbXMpO1xyXG4gICAgfVxyXG4gICAgLy8gYXBwTW9kZeWtmOWcqO+8jOS9huS4uuepuu+8jOS5n+iupOS4uuaYr+iAgeihqOWNlVxyXG4gICAgaWYgKGFwcE1vZGUubGVuZ3RoIDwgMSkge1xyXG4gICAgICAgIHJldHVybiBvZihwYXJhbXMpO1xyXG4gICAgfVxyXG4gICAgLy8g5paw6KGo5Y2V77yM5L2/55SoaWZyYW1l5qih5byPXHJcbiAgICBpZiAoYXBwTW9kZS50b0xvd2VyQ2FzZSgpID09PSAnbWRpJykge1xyXG4gICAgICAgIHJldHVybiBvZihwYXJhbXMpO1xyXG4gICAgfVxyXG4gICAgKi9cclxuICAgIC8vIOiOt+WPlnRhYklk77yM5pyA5paw54mI5pys5LiA5a6a5pyJdGFiSWTvvIzlpoLmnpzlj5bkuI3liLB0YWJJZOWImeiupOS4uuaYr+iAgeihqOWNle+8jOebtOaOpeS7jnVybOiOt+WPluWPguaVsFxyXG4gICAgY29uc3QgdGFiSWQgPSBwYXJhbXMudGFiSWQ7XHJcbiAgICBpZiAoIXRhYklkKSB7XHJcbiAgICAgIC8vIHRocm93IG5ldyBFcnJvcignVGFiSWQgY2FuYHQgYmUgZW1wdHkhJyk7XHJcbiAgICAgIHJldHVybiBvZihwYXJhbXMpO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgc3ViamVjdCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcclxuICAgIC8vIOeuoemBk+WPguaVsGXlj6/og73kuLpvYmplY3TjgIFNYXDnsbvlnotcclxuICAgIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UuYWRkRXZlbnRMaXN0ZW5lcih0YWJJZCwgKGU6IGFueSkgPT4ge1xyXG4gICAgICBsZXQgbWFwID0ge307XHJcbiAgICAgIGlmIChlIGluc3RhbmNlb2YgTWFwIHx8IChlICYmIHR5cGVvZiAoZVsnZ2V0J10pID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBlWydlbnRyaWVzJ10gPT09ICdmdW5jdGlvbicpKSB7XHJcbiAgICAgICAgbWFwID0gdGhpcy5wYXJzZU1hcFBhcmFtcyhlKTtcclxuICAgICAgfVxyXG4gICAgICBsZXQgYXJncyA9IHt9O1xyXG4gICAgICBpZiAoZSBpbnN0YW5jZW9mIE1hcCB8fCAoZSAmJiB0eXBlb2YgKGVbJ2dldCddKSA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgZVsnZW50cmllcyddID09PSAnZnVuY3Rpb24nKSkge1xyXG4gICAgICAgIGFyZ3MgPSBuZXcgTWFwKGUpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGFyZ3MgPSBPYmplY3QuYXNzaWduKHt9LCBlKTtcclxuICAgICAgfVxyXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICBzdWJqZWN0Lm5leHQoT2JqZWN0LmFzc2lnbih7fSwgYXJncywgbWFwLCBwYXJhbXMpKTtcclxuICAgICAgfSwgMCk7XHJcbiAgICB9LCBwYXJhbXMpO1xyXG4gICAgcmV0dXJuIHN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOino+aekG1hcOexu+Wei+eahOWPguaVsFxyXG4gICAqIEBwYXJhbSBwYXJhbXMgcGFyYW1zXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBwYXJzZU1hcFBhcmFtcyhwYXJhbXM6IE1hcDxhbnksIGFueT4pIHtcclxuICAgIGNvbnN0IG1hcCA9IHt9O1xyXG4gICAgbWFwWydXRUJfRk9STV9ST1VURV9QQVJBTVMnXSA9IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbXMuZ2V0KCdXRUJfRk9STV9ST1VURV9QQVJBTVMnKSk7XHJcbiAgICBwYXJhbXMuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4ge1xyXG4gICAgICBpZiAoa2V5ICE9PSAnV0VCX0ZPUk1fUk9VVEVfUEFSQU1TJykge1xyXG4gICAgICAgIG1hcFtrZXldID0gdmFsdWU7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIG1hcDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+WcGFyYW3lj4LmlbBcclxuICAgKiBAcGFyYW0gcGFyYW0ga2V5XHJcbiAgICovXHJcbiAgcHVibGljIGdldChwYXJhbTogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHJldHVybiB0aGlzLnBhcmFtcy5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAob3B0aW9ucyA9PiB7XHJcbiAgICAgICAgaWYgKCEhb3B0aW9ucyAmJiBvcHRpb25zLmhhc093blByb3BlcnR5KHBhcmFtKSkge1xyXG4gICAgICAgICAgcmV0dXJuIG9mKG9wdGlvbnMucGFyYW0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gb2YodW5kZWZpbmVkKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlj4LmlbDovazkuLrlr7nosaFcclxuICAgKi9cclxuICBwdWJsaWMgcGFyc2UoKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHJldHVybiB0aGlzLnBhcmFtcy5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAob3B0aW9ucyA9PiB7XHJcbiAgICAgICAgcmV0dXJuIG9mKG9wdGlvbnMpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuIl19