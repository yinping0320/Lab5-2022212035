import { Injectable, InjectFlags, Optional } from '@angular/core';
import { from, of, empty, EMPTY } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { UploadDialogService, UploadLimit, DownloadService, FileState } from '@gsp-svc/formdoc-upload';
import { FileViewerService } from '@gsp-svc/file-viewer';
import { FrameContext, BindingPathConverter, DataPathCreator } from '@farris/devkit';
import { FormNotifyService } from '../form-notify.service';
import { AttachmentUtil } from './attachment.util';
import { AttachmentDataService } from './attachment-data.service';
import { LanguageService } from '../languag.service';
import { EntityService } from '../entity-services/index';
import { BasePathService } from '@farris/rtf';
// tslint:disable: max-line-length
/**
 * 附件服务
 */
var AttachmentService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function AttachmentService(frameContext, attachDataService, notifyService, uploadDialogService, downloadService) {
        this.frameContext = frameContext;
        this.attachDataService = attachDataService;
        this.notifyService = notifyService;
        this.uploadDialogService = uploadDialogService;
        this.downloadService = downloadService;
        /**
         * 默认根目录
         */
        this.defaultRootDirId = '';
        this.setLanguageService();
        this.fileViewerService = this.frameContext.injector.get(FileViewerService, null, InjectFlags.Optional);
        this.entityService = this.frameContext.injector.get(EntityService, null, InjectFlags.Optional);
        if (!this.downloadService && typeof DownloadService !== 'undefined') {
            this.downloadService = this.frameContext.injector.get(DownloadService, null);
        }
    }
    Object.defineProperty(AttachmentService.prototype, "defaultParentDirName", {
        /**
         * 默认父路径
         */
        get: function () {
            return this.frameContext.bindingData.list.currentId;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AttachmentService.prototype, "bindingData", {
        /**
         * 绑定数据
         */
        get: function () {
            return this.frameContext.bindingData;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 设置语言服务
     */
    AttachmentService.prototype.setLanguageService = function () {
        var injector = this.frameContext.injector;
        this.languageService = injector.get(LanguageService, null, InjectFlags.Optional);
        if (!this.languageService) {
            this.languageService = LanguageService.getInstance();
        }
    };
    /**
     * 上传单个文件
     * @param attachmentIdPath 附件内码字段的路径，形如/attachInfo/attachmentId；
     * @param attachmentNamePath 附件名称字段的路径
     */
    AttachmentService.prototype.uploadAndUpdateRow = function (attachmentInfoFieldPath, rootDirId, parentDirName, fileType, id) {
        var _this = this;
        var rootId = rootDirId ? rootDirId : this.defaultRootDirId;
        var formId = parentDirName ? parentDirName : this.defaultParentDirName;
        if (!rootId || !formId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        var uploadLimit = new UploadLimit();
        uploadLimit.fileCount = 1;
        if (fileType) {
            uploadLimit.fileType = fileType;
        }
        // 获取老的附件id数组
        var attachmentIdList = [];
        var currentItem = null;
        if (id) {
            // 修正当前行
            var bindingList = this.frameContext.bindingData.getList();
            if (bindingList.currentId !== id) {
                bindingList.setCurrentId(id, true, true);
            }
            // 如果指定了id则获取指定id的行
            currentItem = this.getSpecialRow(attachmentInfoFieldPath, id);
        }
        else {
            // 没有指定则使用当前行，可能存在当前行和事件行不一致的情况，此时应该在命令中传递id参数
            currentItem = this.getCurrentRow(attachmentInfoFieldPath);
        }
        if (currentItem && currentItem.primaryKeyValue) {
            var attachmentIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, [currentItem.primaryKeyValue]);
            if (attachmentIds && attachmentIds.length > 0) {
                attachmentIdList.push.apply(attachmentIdList, attachmentIds);
            }
        }
        else {
            this.notifyService.warning(this.languageService.plsSelectUpdateRow, { hideTitle: true });
            return EMPTY;
        }
        var dialog$ = from(this.uploadDialogService.uploadFileWithLimit(formId, rootId, uploadLimit, attachmentIdList));
        var result$ = dialog$.pipe(switchMap(function (fileInfos) {
            if (!fileInfos || fileInfos.length === 0) {
                _this.notifyService.warning(_this.languageService.plsUploadFirst, { hideTitle: true });
                return empty();
            }
            // 过滤出state为新增的附件
            fileInfos = fileInfos.filter(function (fileInfo) {
                if (fileInfo.hasOwnProperty('state')) {
                    return fileInfo.state === FileState.New;
                }
                return true;
            });
            if (fileInfos.length === 0) {
                return of(true);
            }
            // 是否上传判断
            var attachmentInfos = AttachmentUtil.convertToAttachmentInfos(fileInfos);
            var firstAttachmentInfo = AttachmentUtil.getFirstAttachmentInfo(attachmentInfos);
            return _this.attachDataService.updateRow(attachmentInfoFieldPath, firstAttachmentInfo);
        }));
        return result$;
    };
    /**
     * 上传单个文件（支持多列）
     * @param attachmentInfoFieldPath 附件内码字段的路径，形如/attachInfo/attachmentId；
     * @param rootDirId 附件存储根目录
     * @param parentDirName 附件存储目录
     * @param fileType 文件类型，like .txt,.docx
     */
    AttachmentService.prototype.uploadAndUpdateRowWithPropertyName = function (attachmentInfoFieldPath, rootDirId, parentDirName, fileType, id) {
        var _this = this;
        var rootId = rootDirId ? rootDirId : this.defaultRootDirId;
        var formId = parentDirName ? parentDirName : this.defaultParentDirName;
        if (!rootId || !formId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        var uploadLimit = new UploadLimit();
        uploadLimit.fileCount = 1;
        if (fileType) {
            uploadLimit.fileType = fileType;
        }
        // 获取老的附件id数组
        var attachmentIdList = [];
        var currentItem = null;
        if (id) {
            // 修正当前行
            var bindingList = this.frameContext.bindingData.getList();
            if (bindingList.currentId !== id) {
                bindingList.setCurrentId(id, true, true);
            }
            // 如果指定了id则获取指定id的行
            currentItem = this.getSpecialRow(attachmentInfoFieldPath, id);
        }
        else {
            // 没有指定则使用当前行，可能存在当前行和事件行不一致的情况，此时应该在命令中传递id参数
            currentItem = this.getCurrentRow(attachmentInfoFieldPath);
        }
        if (currentItem && currentItem.primaryKeyValue) {
            var attachmentIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, [currentItem.primaryKeyValue]);
            if (attachmentIds && attachmentIds.length > 0) {
                attachmentIdList.push.apply(attachmentIdList, attachmentIds);
            }
        }
        else {
            this.notifyService.warning(this.languageService.plsSelectUpdateRow, { hideTitle: true });
            return EMPTY;
        }
        var dialog$ = from(this.uploadDialogService.uploadFileWithLimit(formId, rootId, uploadLimit, attachmentIdList));
        var result$ = dialog$.pipe(switchMap(function (fileInfos) {
            if (!fileInfos || fileInfos.length === 0) {
                _this.notifyService.warning(_this.languageService.plsUploadFirst, { hideTitle: true });
                return EMPTY;
            }
            // 过滤出state为新增的附件
            fileInfos = fileInfos.filter(function (fileInfo) {
                if (fileInfo.hasOwnProperty('state')) {
                    return fileInfo.state === FileState.New;
                }
                return true;
            });
            if (fileInfos.length === 0) {
                return of(true);
            }
            // 是否上传判断
            var attachmentInfos = AttachmentUtil.convertToAttachmentInfos(fileInfos);
            var firstAttachmentInfo = AttachmentUtil.getFirstAttachmentInfo(attachmentInfos);
            return _this.attachDataService.updateRowWithPropertyName(attachmentInfoFieldPath, firstAttachmentInfo);
        }));
        return result$;
    };
    /**
     * 上传多个文件
     */
    AttachmentService.prototype.uploadAndBatchAddRows = function (attachmentInfoFieldPath, rootDirId, parentDirName, fileType) {
        var _this = this;
        var rootId = rootDirId ? rootDirId : this.defaultRootDirId;
        var formId = parentDirName ? parentDirName : this.defaultParentDirName;
        if (!rootId || !formId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        var uploadLimit = new UploadLimit();
        if (fileType) {
            uploadLimit.fileType = fileType;
        }
        var dialog$ = from(this.uploadDialogService.uploadFileWithLimit(formId, rootId, uploadLimit));
        var result$ = dialog$.pipe(switchMap(function (fileInfos) {
            if (!fileInfos || fileInfos.length === 0) {
                _this.notifyService.warning(_this.languageService.plsUploadFirst, { hideTitle: true });
                return EMPTY;
            }
            // 过滤出state为新增的附件
            fileInfos = fileInfos.filter(function (fileInfo) {
                if (fileInfo.hasOwnProperty('state')) {
                    return fileInfo.state === FileState.New;
                }
                return true;
            });
            if (fileInfos.length === 0) {
                return of(true);
            }
            var attachmentInfos = AttachmentUtil.convertToAttachmentInfos(fileInfos);
            return _this.attachDataService.updateRows(attachmentInfoFieldPath, attachmentInfos);
        }));
        return result$;
    };
    /**
     * 上传多个文件
     */
    AttachmentService.prototype.uploadAndBatchAddRowsWithPropertyName = function (attachmentInfoFieldPath, rootDirId, parentDirName, fileType, id) {
        var _this = this;
        var rootId = rootDirId ? rootDirId : this.defaultRootDirId;
        var formId = parentDirName ? parentDirName : this.defaultParentDirName;
        if (!rootId || !formId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        var uploadLimit = new UploadLimit();
        if (fileType) {
            uploadLimit.fileType = fileType;
        }
        if (id) {
            // 修正当前行
            var bindingList = this.frameContext.bindingData.getList();
            if (bindingList.currentId !== id) {
                bindingList.setCurrentId(id, true, true);
            }
        }
        var dialog$ = from(this.uploadDialogService.uploadFileWithLimit(formId, rootId, uploadLimit));
        var result$ = dialog$.pipe(switchMap(function (fileInfos) {
            if (!fileInfos || fileInfos.length === 0) {
                _this.notifyService.warning(_this.languageService.plsUploadFirst, { hideTitle: true });
                return EMPTY;
            }
            // 过滤出state为新增的附件
            fileInfos = fileInfos.filter(function (fileInfo) {
                if (fileInfo.hasOwnProperty('state')) {
                    return fileInfo.state === FileState.New;
                }
                return true;
            });
            if (fileInfos.length === 0) {
                return of(true);
            }
            var attachmentInfos = AttachmentUtil.convertToAttachmentInfos(fileInfos);
            return _this.attachDataService.updateRowsWithPropertyName(attachmentInfoFieldPath, attachmentInfos);
        }));
        return result$;
    };
    /**
     * 下载附件（根据附件id）
     */
    AttachmentService.prototype.download = function (attachId, rootId) {
        if (!attachId) {
            this.notifyService.warning(this.languageService.plsSelectDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        rootId = rootId || 'default-root';
        var url = this.getDownloadUrl([attachId], rootId);
        // let url = '';
        // if (rootId) {
        //   url = `/api/runtime/dfs/v1.0/formdoc/filecontent?metadataid=${attachId}&rootid=${rootId}`;
        // } else {
        //   url = `/api/runtime/dfs/v1.0/formdoc/download/${attachId}`;
        // }
        window.open(url);
        return of(true);
    };
    /**
     * 批量下载附件（根据附件id数组）
     */
    AttachmentService.prototype.batchDownload = function (attachIds, rootId) {
        if (!attachIds || attachIds.length === 0) {
            this.notifyService.warning(this.languageService.plsSelectDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        // 只选择一个附件时按单个附件下载处理
        if (attachIds.length === 1) {
            return this.download(attachIds[0], rootId);
        }
        // const attachIdsString = JSON.stringify(attachIds);
        // const url = `/api/runtime/dfs/v1.0/formdoc/multiple/download?metadataidlist=${attachIdsString}&rootid=${rootId}`;
        var url = this.getDownloadUrl(attachIds, rootId);
        window.open(url);
        return of(true);
    };
    /**
     * 获取下载路径
     * @param metadataidlist 附件id数组
     * @param rootId rootId
     */
    AttachmentService.prototype.getDownloadUrl = function (metadataidlist, rootId) {
        rootId = rootId || 'default-root';
        if (this.downloadService) {
            if (metadataidlist.length === 1) {
                return this.downloadService.getDownloadUrl(metadataidlist[0], rootId);
            }
            else {
                var attachIdsString = JSON.stringify(metadataidlist);
                return this.downloadService.getMultipleDownloadUrl(attachIdsString, rootId);
            }
        }
        else {
            console.warn('因安全问题，附件下载提供安全校验机制，附件下载功能需重新编译。');
            if (metadataidlist.length === 1) {
                return BasePathService.convertPath("/api/runtime/dfs/v1.0/formdoc/filecontent?metadataid=" + metadataidlist[0] + "&rootid=" + rootId);
            }
            else {
                var attachIdsString = JSON.stringify(metadataidlist);
                return BasePathService.convertPath("/api/runtime/dfs/v1.0/formdoc/multiple/download?metadataidlist=" + attachIdsString + "&rootid=" + rootId);
            }
        }
    };
    /**
     * 下载（根据数据id）
     */
    AttachmentService.prototype.downloadByDataId = function (dataId, attachmentInfoFieldPath, rootId) {
        if (!dataId) {
            this.notifyService.warning(this.languageService.plsSelectDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        var dataIds = [dataId];
        var attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, dataIds);
        if (attachIds.length === 0) {
            this.notifyService.warning(this.languageService.noDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        var attachId = attachIds[0];
        return this.download(attachId);
    };
    /**
     * 批量下载附件
     */
    AttachmentService.prototype.batchDownloadByDataIds = function (dataIds, attachmentInfoFieldPath, rootId) {
        if (typeof dataIds === 'string' && dataIds && dataIds.length > 0) {
            dataIds = dataIds.split(',').filter(function (p) { return p; });
        }
        if (!dataIds || Array.isArray(dataIds) === false || dataIds.length === 0) {
            this.notifyService.warning(this.languageService.plsSelectDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        var ids = [].concat(dataIds);
        var attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, ids);
        if (attachIds.length === 0) {
            this.notifyService.warning(this.languageService.noDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        return this.batchDownload(attachIds, rootId);
    };
    /**
     * 根据附件UDT字段的路径预览附件
     * @param attachmentInfoFieldPath 附件UDT字段path
     * @param rootDirId 跟目录id
     * @param ids 附件id
     */
    AttachmentService.prototype.previewByAttachmentInfoFieldPath = function (attachmentInfoFieldPath, rootDirId, ids) {
        if (!attachmentInfoFieldPath || !rootDirId) {
            throw new Error('attachmentInfoFieldPath和rootDirId不能为空，请填写');
        }
        var attachIds = [];
        var dataIds = [];
        if (ids && ids.length > 0) {
            if (typeof (ids) === 'string') {
                dataIds.push(ids);
            }
            else {
                dataIds = ids;
            }
            attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, dataIds);
        }
        else {
            attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, null);
        }
        if (attachIds && attachIds.length === 0) {
            this.notifyService.warning(this.languageService.noAttachment, { hideTitle: true });
            return EMPTY;
        }
        return this.previewByAttachmentIds(attachIds, rootDirId);
    };
    /**
     * 根据附件UDT字段的路径预览当前行的附件
     * @param attachmentInfoFieldPath 附件UDT字段path
     * @param rootDirId 根目录id
     */
    AttachmentService.prototype.previewByAttachmentInfoFieldPathWithIndex = function (attachmentInfoFieldPath, rootDirId) {
        if (!attachmentInfoFieldPath || !rootDirId) {
            throw new Error('attachmentInfoFieldPath和rootDirId不能为空，请填写');
        }
        var currentRow = this.getCurrentRow(attachmentInfoFieldPath);
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        var attachmentFieldName = parentBindingPathArray.pop();
        if (!currentRow[attachmentFieldName] || !currentRow[attachmentFieldName]['attachmentId']) {
            this.notifyService.warning(this.languageService.noAttachment, { hideTitle: true });
            return EMPTY;
        }
        var attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, null);
        if (attachIds && attachIds.length === 0) {
            this.notifyService.warning(this.languageService.noAttachment, { hideTitle: true });
            return EMPTY;
        }
        var attachmentId = this.getCurrentAttachmentId(attachmentInfoFieldPath);
        if (!attachmentId) {
            throw new Error('要预览的附件id不存在，请确认');
        }
        else {
            return this.previewFileListWithIndex(attachIds, rootDirId, attachmentId);
        }
    };
    /**
     * 根据目录预览附件
     * @param subDirName 父目录名称
     * @param rootDirId 根目录id
     */
    AttachmentService.prototype.previewBySubDirName = function (subDirName, rootDirId) {
        if (!subDirName || !rootDirId) {
            throw new Error('subDirName和rootDirId不能为空，请填写');
        }
        var viewer$ = from(this.fileViewerService.viewerFormFile(subDirName, rootDirId));
        return viewer$;
    };
    /**
     * 根据目录预览指定索引的附件
     * @param attachmentInfoFieldPath 附件UDT字段path
     * @param subDirName 子目录名称
     * @param rootDirId 根目录id
     */
    AttachmentService.prototype.previewBySubDirNameWithIndex = function (attachmentInfoFieldPath, subDirName, rootDirId) {
        if (!subDirName || !rootDirId) {
            throw new Error('subDirName和rootDirId不能为空，请填写');
        }
        // const attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, null);
        var attachmentId = this.getCurrentAttachmentId(attachmentInfoFieldPath);
        if (!attachmentId) {
            this.notifyService.warning(this.languageService.noAttachment, { hideTitle: true });
            return EMPTY;
        }
        var viewer$ = from(this.fileViewerService.viewerFormFileWithIndex(subDirName, rootDirId, attachmentId));
        return viewer$;
    };
    /**
     * 根据附件id数组预览附件
     * @param attachmentIds 附件id数组
     * @param rootDirId 根目录id
     */
    AttachmentService.prototype.previewByAttachmentIds = function (attachmentIds, rootDirId) {
        var viewer$ = from(this.fileViewerService.viewerFileList(attachmentIds, rootDirId));
        return viewer$;
    };
    /**
     * 根据附件id数组预览指定索引的附件
     * @param attachmentIds 附件id数组
     * @param rootDirId 根目录id
     * @param attachmentId 附件Id
     */
    AttachmentService.prototype.previewFileListWithIndex = function (attachmentIds, rootDirId, attachmentId) {
        var viewer$ = from(this.fileViewerService.viewerFileListWithIndex(attachmentIds, rootDirId, attachmentId));
        return viewer$;
    };
    /**
     * 生成版本号
     * @param versions 历史版本号
     * @description 默认编码规则v1.0 v2.0 ...
     */
    AttachmentService.prototype.genVersion = function (versions) {
        if (!versions) {
            versions = [];
        }
        var mainCode = versions.length + 1;
        return "V" + mainCode + ".0";
    };
    /**
     * 更新附件版本信息
     * @param versionField 附件版本字段
     * @param historyField 是否历史版本字段
     * @param attachmentFieldPath 附件udt字段路径
     */
    AttachmentService.prototype.updateAttachmentVersion = function (versionField, historyField, attachmentFieldPath) {
        var _this = this;
        /**
         * 遍历所有附件行
         * 找到所有没有附件版本的行
         * 遍历这些行
         * 通过文件名去查找同名的且有附件版本号的行
         * 这些行历史版本字段置为true
         * 无版本号的行，版本= 上行数 + 1
         *
         */
        var bindingPaths = attachmentFieldPath.split('/').filter(function (p) { return p; });
        // 弹出附件udt字段
        var attachmentField = bindingPaths.pop();
        // 获取到所有的附件
        var attachmentBindingList = this.frameContext.bindingData.getValue(bindingPaths);
        var befRepository = this.frameContext.repository;
        var entityManager = befRepository.entityManager;
        var dataPath = DataPathCreator.createByShortPathFromRoot(bindingPaths, entityManager, this.frameContext.bindingData);
        var paths = dataPath.toArray().map(function (path) {
            if (path.startsWith('PropName:')) {
                return path.split(':')[1];
            }
            else {
                return path;
            }
        });
        if (attachmentBindingList) {
            var attachments_1 = attachmentBindingList.toJSON();
            // 只处理有附件的情况
            if (attachments_1) {
                var versionLessRows = attachments_1.filter(function (item) { return !item[versionField]; });
                versionLessRows.forEach(function (item) {
                    var fileName = item[attachmentField]['fileName'];
                    var versionedRows = attachments_1.filter(function (row) { return row[attachmentField]['fileName'] === fileName && row[versionField]; });
                    paths.pop();
                    paths.push("DataId:" + item[attachmentBindingList.primaryKey]);
                    var entity = _this.frameContext.repository.entityCollection.getEntityByPath(paths);
                    var version = _this.genVersion(versionedRows);
                    entity[versionField] = version;
                    entity[historyField] = false;
                    // 处理历史记录
                    versionedRows.forEach(function (row) {
                        paths.pop();
                        paths.push("DataId:" + row[attachmentBindingList.primaryKey]);
                        entity = _this.frameContext.repository.entityCollection.getEntityByPath(paths);
                        entity[historyField] = true;
                    });
                });
            }
        }
    };
    AttachmentService.prototype.isAttachmentCanDelete = function (historyField, attachmentFieldPath) {
        var bindingPaths = attachmentFieldPath.split('/').filter(function (p) { return p; });
        // 弹出附件udt字段
        bindingPaths.pop();
        var attachmentBindingList = this.frameContext.bindingData.getValue(bindingPaths);
        var bindingObject = attachmentBindingList.currentItem;
        if (bindingObject[historyField] === true) {
            this.notifyService.warning(this.languageService.historyAttachment, { hideTitle: true });
            return EMPTY;
        }
    };
    AttachmentService.prototype.updateAttachmentHistory = function (versionField, historyField, attachmentFieldPath) {
        var _this = this;
        var bindingPaths = attachmentFieldPath.split('/').filter(function (p) { return p; });
        // 弹出附件udt字段
        var attachmentField = bindingPaths.pop();
        // 获取到所有的附件
        var attachmentBindingList = this.frameContext.bindingData.getValue(bindingPaths);
        // const befRepository = this.frameContext.repository as BefRepository<any>;
        // const entityManager = befRepository.entityManager;
        if (attachmentBindingList) {
            var attachments = attachmentBindingList.toJSON();
            var versionedRows = attachments.filter(function (item) { return item[versionField]; });
            var fileNameMap_1 = new Map();
            var befRepository = this.frameContext.repository;
            var entityManager = befRepository.entityManager;
            var dataPath = DataPathCreator.createByShortPathFromRoot(bindingPaths, entityManager, this.frameContext.bindingData);
            var paths_1 = dataPath.toArray().map(function (path) {
                if (path.startsWith('PropName:')) {
                    return path.split(':')[1];
                }
                else {
                    return path;
                }
            });
            versionedRows.forEach(function (item) {
                var fileName = item[attachmentField]['fileName'];
                if (fileNameMap_1.has(fileName)) {
                    fileNameMap_1.get(fileName).push(item);
                }
                else {
                    fileNameMap_1.set(fileName, [item]);
                }
            });
            Array.from(fileNameMap_1.values()).forEach(function (array) {
                array.sort(function (x, y) {
                    var xVersion = parseInt(x[versionField].replace(/[a-zA-Z\.]/g, ''));
                    var yVersion = parseInt(y[versionField].replace(/[a-zA-Z\.]/g, ''));
                    return yVersion - xVersion;
                });
                var row = array[0];
                paths_1.pop();
                paths_1.push("DataId:" + row[attachmentBindingList.primaryKey]);
                var entity = _this.frameContext.repository.entityCollection.getEntityByPath(paths_1);
                entity[historyField] = false;
            });
        }
    };
    /**
     * 删除附件
     * @param attachmentInfoFieldPath 附件udt字段路径
     * @param id 数据id
     * @param rootDirId 根目录
     * @returns
     */
    AttachmentService.prototype.removeAttachment = function (attachmentInfoFieldPath, id, rootDirId) {
        var rootId = rootDirId;
        if (!rootId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        var dataIds = [id];
        var attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, dataIds);
        if (attachIds.length === 0) {
            this.notifyService.warning(this.languageService.plsSelectRemoveAtt, { hideTitle: true });
            return EMPTY;
        }
        var attachmentId = attachIds[0];
        return this.attachDataService.removeAttachment(attachmentInfoFieldPath, { attachmentId: attachmentId, fileName: null });
    };
    /**
     * 获取当前视图模型当前行的附件id
     * @param attachmentInfoFieldPath 附件udt字段
     */
    AttachmentService.prototype.getCurrentAttachmentId = function (attachmentInfoFieldPath) {
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        var attachmentFieldName = parentBindingPathArray.pop();
        var bindingList = this.frameContext.bindingData.getValue(parentBindingPathArray);
        var currentItem = bindingList.currentItem;
        if (currentItem && currentItem.primaryKeyValue) {
            return currentItem[attachmentFieldName] && currentItem[attachmentFieldName]['attachmentId'] || null;
        }
        else {
            return null;
        }
    };
    /**
     * 获取当前行
     * @param attachmentInfoFieldPath udt字段
     */
    AttachmentService.prototype.getCurrentRow = function (attachmentInfoFieldPath) {
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        var bindingList = this.frameContext.bindingData.getValue(parentBindingPathArray);
        var currentItem = bindingList && bindingList.currentItem;
        return currentItem;
    };
    /**
     * 获取指定附件信息表的指定行
     * @param attachmentInfoFieldPath
     * @param primaryValue
     * @returns
     */
    AttachmentService.prototype.getSpecialRow = function (attachmentInfoFieldPath, primaryValue) {
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        var bindingList = this.frameContext.bindingData.getValue(parentBindingPathArray);
        var currentItem = bindingList && bindingList.findById(primaryValue);
        return currentItem;
    };
    /**
     * 获取dataIds对应Entity上的附件id数组
     */
    AttachmentService.prototype.getAttachmentIdsByPathAndDataIds = function (attachmentInfoFieldPath, dataIds) {
        // 解析路径
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        var attachmentFieldName = parentBindingPathArray.pop();
        // 获取附件所在实体的数据列表，不传递dataIds参数，则返回全部
        var entityListData = this.entityService.getEntityListData(parentBindingPathArray);
        var filteredEntityListData = [];
        if (dataIds && Array.isArray(dataIds) === true) {
            filteredEntityListData = entityListData.filter(function (entityData) {
                return dataIds.indexOf(entityData.id) > -1;
            });
        }
        else {
            filteredEntityListData = entityListData;
        }
        // 转换为附件Id数组
        var attachmentIds = [];
        filteredEntityListData.forEach(function (entityData) {
            if (entityData[attachmentFieldName]) {
                var attachmentId = entityData[attachmentFieldName]['attachmentId'];
                if (attachmentId) {
                    attachmentIds.push(attachmentId);
                }
            }
        });
        return attachmentIds;
    };
    AttachmentService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    AttachmentService.ctorParameters = function () { return [
        { type: FrameContext },
        { type: AttachmentDataService },
        { type: FormNotifyService },
        { type: UploadDialogService },
        { type: DownloadService, decorators: [{ type: Optional }] }
    ]; };
    return AttachmentService;
}());
export { AttachmentService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0YWNobWVudC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2F0dGFjaG1lbnQvYXR0YWNobWVudC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNsRSxPQUFPLEVBQWMsSUFBSSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsbUJBQW1CLEVBQWtCLFdBQVcsRUFBRSxlQUFlLEVBQUUsU0FBUyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDdkgsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDekQsT0FBTyxFQUFFLFlBQVksRUFBZSxvQkFBb0IsRUFBNkIsZUFBZSxFQUFzQixNQUFNLGdCQUFnQixDQUFDO0FBQ2pKLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzNELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDckQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRXpELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFOUMsa0NBQWtDO0FBQ2xDOztHQUVHO0FBQ0g7SUFvQ0U7O09BRUc7SUFDSCwyQkFDVSxZQUEwQixFQUMxQixpQkFBd0MsRUFDeEMsYUFBZ0MsRUFDaEMsbUJBQXdDLEVBQzVCLGVBQWdDO1FBSjVD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QUM7SUFDdkIsQ0FBQzs7Z0JBbnNCRixVQUFVOzs7O2dCQWJGLFlBQVk7Z0JBR1oscUJBQXFCO2dCQUZyQixpQkFBaUI7Z0JBSGpCLG1CQUFtQjtnQkFBK0IsZUFBZSx1QkEyRHJFLFFBQVE7O0lBd3BCYix3QkFBQztDQUFBLEFBcHNCRCxJQW9zQkM7QUFFRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdEZsYWdzLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBmcm9tLCBvZiwgZW1wdHksIEVNUFRZIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgVXBsb2FkRGlhbG9nU2VydmljZSwgVXBsb2FkRmlsZUluZm8sIFVwbG9hZExpbWl0LCBEb3dubG9hZFNlcnZpY2UsIEZpbGVTdGF0ZSB9IGZyb20gJ0Bnc3Atc3ZjL2Zvcm1kb2MtdXBsb2FkJztcclxuaW1wb3J0IHsgRmlsZVZpZXdlclNlcnZpY2UgfSBmcm9tICdAZ3NwLXN2Yy9maWxlLXZpZXdlcic7XHJcbmltcG9ydCB7IEZyYW1lQ29udGV4dCwgQmluZGluZ0RhdGEsIEJpbmRpbmdQYXRoQ29udmVydGVyLCBCaW5kaW5nTGlzdCwgRGF0YVBhdGhVdGlsLCBEYXRhUGF0aENyZWF0b3IsIEVudGl0eUxpc3QsIEVudGl0eSB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgRm9ybU5vdGlmeVNlcnZpY2UgfSBmcm9tICcuLi9mb3JtLW5vdGlmeS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQXR0YWNobWVudFV0aWwgfSBmcm9tICcuL2F0dGFjaG1lbnQudXRpbCc7XHJcbmltcG9ydCB7IEF0dGFjaG1lbnREYXRhU2VydmljZSB9IGZyb20gJy4vYXR0YWNobWVudC1kYXRhLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuLi9sYW5ndWFnLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBFbnRpdHlTZXJ2aWNlIH0gZnJvbSAnLi4vZW50aXR5LXNlcnZpY2VzL2luZGV4JztcclxuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSB9IGZyb20gJ0BmYXJyaXMvYmVmJztcclxuaW1wb3J0IHsgQmFzZVBhdGhTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy9ydGYnO1xyXG5cclxuLy8gdHNsaW50OmRpc2FibGU6IG1heC1saW5lLWxlbmd0aFxyXG4vKipcclxuICog6ZmE5Lu25pyN5YqhXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmNsYXNzIEF0dGFjaG1lbnRTZXJ2aWNlIHtcclxuICAvKipcclxuICAgKiDpu5jorqTmoLnnm67lvZVcclxuICAgKi9cclxuICBwcml2YXRlIGRlZmF1bHRSb290RGlySWQgPSAnJztcclxuXHJcbiAgLyoqXHJcbiAgICog6buY6K6k54i26Lev5b6EXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXQgZGVmYXVsdFBhcmVudERpck5hbWUoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOe7keWumuaVsOaNrlxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0IGJpbmRpbmdEYXRhKCk6IEJpbmRpbmdEYXRhIHtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWkmuivreacjeWKoVxyXG4gICAqL1xyXG4gIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2U7XHJcblxyXG4gIC8qKlxyXG4gICAqIOmZhOS7tumihOiniOacjeWKoVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZmlsZVZpZXdlclNlcnZpY2U6IEZpbGVWaWV3ZXJTZXJ2aWNlO1xyXG5cclxuICAvKipcclxuICAgKiDlrp7kvZPmnI3liqFcclxuICAgKi9cclxuICBwcml2YXRlIGVudGl0eVNlcnZpY2U6IEVudGl0eVNlcnZpY2U7XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCxcclxuICAgIHByaXZhdGUgYXR0YWNoRGF0YVNlcnZpY2U6IEF0dGFjaG1lbnREYXRhU2VydmljZSxcclxuICAgIHByaXZhdGUgbm90aWZ5U2VydmljZTogRm9ybU5vdGlmeVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHVwbG9hZERpYWxvZ1NlcnZpY2U6IFVwbG9hZERpYWxvZ1NlcnZpY2UsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGRvd25sb2FkU2VydmljZTogRG93bmxvYWRTZXJ2aWNlXHJcbiAgKSB7XHJcbiAgICB0aGlzLnNldExhbmd1YWdlU2VydmljZSgpO1xyXG4gICAgdGhpcy5maWxlVmlld2VyU2VydmljZSA9IHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxGaWxlVmlld2VyU2VydmljZT4oRmlsZVZpZXdlclNlcnZpY2UsIG51bGwsIEluamVjdEZsYWdzLk9wdGlvbmFsKTtcclxuICAgIHRoaXMuZW50aXR5U2VydmljZSA9IHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxFbnRpdHlTZXJ2aWNlPihFbnRpdHlTZXJ2aWNlLCBudWxsLCBJbmplY3RGbGFncy5PcHRpb25hbCk7XHJcbiAgICBpZiAoIXRoaXMuZG93bmxvYWRTZXJ2aWNlICYmIHR5cGVvZiBEb3dubG9hZFNlcnZpY2UgIT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIHRoaXMuZG93bmxvYWRTZXJ2aWNlID0gdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PERvd25sb2FkU2VydmljZT4oRG93bmxvYWRTZXJ2aWNlLCBudWxsKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuvue9ruivreiogOacjeWKoVxyXG4gICAqL1xyXG4gIHByaXZhdGUgc2V0TGFuZ3VhZ2VTZXJ2aWNlKCkge1xyXG4gICAgY29uc3QgaW5qZWN0b3IgPSB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3RvcjtcclxuICAgIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlID0gaW5qZWN0b3IuZ2V0PExhbmd1YWdlU2VydmljZT4oTGFuZ3VhZ2VTZXJ2aWNlLCBudWxsLCBJbmplY3RGbGFncy5PcHRpb25hbCk7XHJcbiAgICBpZiAoIXRoaXMubGFuZ3VhZ2VTZXJ2aWNlKSB7XHJcbiAgICAgIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlID0gTGFuZ3VhZ2VTZXJ2aWNlLmdldEluc3RhbmNlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDkuIrkvKDljZXkuKrmlofku7ZcclxuICAgKiBAcGFyYW0gYXR0YWNobWVudElkUGF0aCDpmYTku7blhoXnoIHlrZfmrrXnmoTot6/lvoTvvIzlvaLlpoIvYXR0YWNoSW5mby9hdHRhY2htZW50SWTvvJtcclxuICAgKiBAcGFyYW0gYXR0YWNobWVudE5hbWVQYXRoIOmZhOS7tuWQjeensOWtl+auteeahOi3r+W+hFxyXG4gICAqL1xyXG4gIHB1YmxpYyB1cGxvYWRBbmRVcGRhdGVSb3coYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgcm9vdERpcklkPzogc3RyaW5nLCBwYXJlbnREaXJOYW1lPzogc3RyaW5nLCBmaWxlVHlwZT86IHN0cmluZywgaWQ/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3Qgcm9vdElkID0gcm9vdERpcklkID8gcm9vdERpcklkIDogdGhpcy5kZWZhdWx0Um9vdERpcklkO1xyXG4gICAgY29uc3QgZm9ybUlkID0gcGFyZW50RGlyTmFtZSA/IHBhcmVudERpck5hbWUgOiB0aGlzLmRlZmF1bHRQYXJlbnREaXJOYW1lO1xyXG4gICAgaWYgKCFyb290SWQgfHwgIWZvcm1JZCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Jvb3REaXJJZOWSjHBhcmVudERpck5hbWXkuI3og73kuLrnqbrvvIzor7floavlhpknKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB1cGxvYWRMaW1pdDogVXBsb2FkTGltaXQgPSBuZXcgVXBsb2FkTGltaXQoKTtcclxuICAgIHVwbG9hZExpbWl0LmZpbGVDb3VudCA9IDE7XHJcbiAgICBpZiAoZmlsZVR5cGUpIHtcclxuICAgICAgdXBsb2FkTGltaXQuZmlsZVR5cGUgPSBmaWxlVHlwZTtcclxuICAgIH1cclxuICAgIC8vIOiOt+WPluiAgeeahOmZhOS7tmlk5pWw57uEXHJcbiAgICBjb25zdCBhdHRhY2htZW50SWRMaXN0ID0gW107XHJcbiAgICBsZXQgY3VycmVudEl0ZW0gPSBudWxsO1xyXG4gICAgaWYgKGlkKSB7XHJcbiAgICAgIC8vIOS/ruato+W9k+WJjeihjFxyXG4gICAgICBjb25zdCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRMaXN0KCk7XHJcbiAgICAgIGlmIChiaW5kaW5nTGlzdC5jdXJyZW50SWQgIT09IGlkKSB7XHJcbiAgICAgICAgYmluZGluZ0xpc3Quc2V0Q3VycmVudElkKGlkLCB0cnVlLCB0cnVlKTtcclxuICAgICAgfVxyXG4gICAgICAvLyDlpoLmnpzmjIflrprkuoZpZOWImeiOt+WPluaMh+Wummlk55qE6KGMXHJcbiAgICAgIGN1cnJlbnRJdGVtID0gdGhpcy5nZXRTcGVjaWFsUm93KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBpZCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyDmsqHmnInmjIflrprliJnkvb/nlKjlvZPliY3ooYzvvIzlj6/og73lrZjlnKjlvZPliY3ooYzlkozkuovku7booYzkuI3kuIDoh7TnmoTmg4XlhrXvvIzmraTml7blupTor6XlnKjlkb3ku6TkuK3kvKDpgJJpZOWPguaVsFxyXG4gICAgICBjdXJyZW50SXRlbSA9IHRoaXMuZ2V0Q3VycmVudFJvdyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCk7XHJcbiAgICB9XHJcbiAgICBpZiAoY3VycmVudEl0ZW0gJiYgY3VycmVudEl0ZW0ucHJpbWFyeUtleVZhbHVlKSB7XHJcbiAgICAgIGNvbnN0IGF0dGFjaG1lbnRJZHMgPSB0aGlzLmdldEF0dGFjaG1lbnRJZHNCeVBhdGhBbmREYXRhSWRzKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBbY3VycmVudEl0ZW0ucHJpbWFyeUtleVZhbHVlXSk7XHJcbiAgICAgIGlmIChhdHRhY2htZW50SWRzICYmIGF0dGFjaG1lbnRJZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGF0dGFjaG1lbnRJZExpc3QucHVzaC5hcHBseShhdHRhY2htZW50SWRMaXN0LCBhdHRhY2htZW50SWRzKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UucGxzU2VsZWN0VXBkYXRlUm93LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGRpYWxvZyQgPSBmcm9tKHRoaXMudXBsb2FkRGlhbG9nU2VydmljZS51cGxvYWRGaWxlV2l0aExpbWl0KGZvcm1JZCwgcm9vdElkLCB1cGxvYWRMaW1pdCwgYXR0YWNobWVudElkTGlzdCkpO1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IGRpYWxvZyQucGlwZShcclxuICAgICAgc3dpdGNoTWFwKChmaWxlSW5mb3M6IFVwbG9hZEZpbGVJbmZvW10pID0+IHtcclxuICAgICAgICBpZiAoIWZpbGVJbmZvcyB8fCBmaWxlSW5mb3MubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5wbHNVcGxvYWRGaXJzdCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgICAgICByZXR1cm4gZW1wdHkoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g6L+H5ruk5Ye6c3RhdGXkuLrmlrDlop7nmoTpmYTku7ZcclxuICAgICAgICBmaWxlSW5mb3MgPSBmaWxlSW5mb3MuZmlsdGVyKChmaWxlSW5mbzogVXBsb2FkRmlsZUluZm8pID0+IHtcclxuICAgICAgICAgIGlmIChmaWxlSW5mby5oYXNPd25Qcm9wZXJ0eSgnc3RhdGUnKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmlsZUluZm8uc3RhdGUgPT09IEZpbGVTdGF0ZS5OZXc7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAoZmlsZUluZm9zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDmmK/lkKbkuIrkvKDliKTmlq1cclxuICAgICAgICBjb25zdCBhdHRhY2htZW50SW5mb3MgPSBBdHRhY2htZW50VXRpbC5jb252ZXJ0VG9BdHRhY2htZW50SW5mb3MoZmlsZUluZm9zKTtcclxuICAgICAgICBjb25zdCBmaXJzdEF0dGFjaG1lbnRJbmZvID0gQXR0YWNobWVudFV0aWwuZ2V0Rmlyc3RBdHRhY2htZW50SW5mbyhhdHRhY2htZW50SW5mb3MpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmF0dGFjaERhdGFTZXJ2aWNlLnVwZGF0ZVJvdyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgZmlyc3RBdHRhY2htZW50SW5mbyk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIHJldHVybiByZXN1bHQkO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDkuIrkvKDljZXkuKrmlofku7bvvIjmlK/mjIHlpJrliJfvvIlcclxuICAgKiBAcGFyYW0gYXR0YWNobWVudEluZm9GaWVsZFBhdGgg6ZmE5Lu25YaF56CB5a2X5q6155qE6Lev5b6E77yM5b2i5aaCL2F0dGFjaEluZm8vYXR0YWNobWVudElk77ybXHJcbiAgICogQHBhcmFtIHJvb3REaXJJZCDpmYTku7blrZjlgqjmoLnnm67lvZVcclxuICAgKiBAcGFyYW0gcGFyZW50RGlyTmFtZSDpmYTku7blrZjlgqjnm67lvZVcclxuICAgKiBAcGFyYW0gZmlsZVR5cGUg5paH5Lu257G75Z6L77yMbGlrZSAudHh0LC5kb2N4XHJcbiAgICovXHJcbiAgcHVibGljIHVwbG9hZEFuZFVwZGF0ZVJvd1dpdGhQcm9wZXJ0eU5hbWUoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgcm9vdERpcklkPzogc3RyaW5nLCBwYXJlbnREaXJOYW1lPzogc3RyaW5nLCBmaWxlVHlwZT86IHN0cmluZywgaWQ/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3Qgcm9vdElkID0gcm9vdERpcklkID8gcm9vdERpcklkIDogdGhpcy5kZWZhdWx0Um9vdERpcklkO1xyXG4gICAgY29uc3QgZm9ybUlkID0gcGFyZW50RGlyTmFtZSA/IHBhcmVudERpck5hbWUgOiB0aGlzLmRlZmF1bHRQYXJlbnREaXJOYW1lO1xyXG4gICAgaWYgKCFyb290SWQgfHwgIWZvcm1JZCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Jvb3REaXJJZOWSjHBhcmVudERpck5hbWXkuI3og73kuLrnqbrvvIzor7floavlhpknKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB1cGxvYWRMaW1pdDogVXBsb2FkTGltaXQgPSBuZXcgVXBsb2FkTGltaXQoKTtcclxuICAgIHVwbG9hZExpbWl0LmZpbGVDb3VudCA9IDE7XHJcbiAgICBpZiAoZmlsZVR5cGUpIHtcclxuICAgICAgdXBsb2FkTGltaXQuZmlsZVR5cGUgPSBmaWxlVHlwZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDojrflj5bogIHnmoTpmYTku7ZpZOaVsOe7hFxyXG4gICAgY29uc3QgYXR0YWNobWVudElkTGlzdCA9IFtdO1xyXG4gICAgbGV0IGN1cnJlbnRJdGVtID0gbnVsbDtcclxuICAgIGlmIChpZCkge1xyXG4gICAgICAvLyDkv67mraPlvZPliY3ooYxcclxuICAgICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0TGlzdCgpO1xyXG4gICAgICBpZiAoYmluZGluZ0xpc3QuY3VycmVudElkICE9PSBpZCkge1xyXG4gICAgICAgIGJpbmRpbmdMaXN0LnNldEN1cnJlbnRJZChpZCwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgIH1cclxuICAgICAgLy8g5aaC5p6c5oyH5a6a5LqGaWTliJnojrflj5bmjIflrpppZOeahOihjFxyXG4gICAgICBjdXJyZW50SXRlbSA9IHRoaXMuZ2V0U3BlY2lhbFJvdyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgaWQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8g5rKh5pyJ5oyH5a6a5YiZ5L2/55So5b2T5YmN6KGM77yM5Y+v6IO95a2Y5Zyo5b2T5YmN6KGM5ZKM5LqL5Lu26KGM5LiN5LiA6Ie055qE5oOF5Ya177yM5q2k5pe25bqU6K+l5Zyo5ZG95Luk5Lit5Lyg6YCSaWTlj4LmlbBcclxuICAgICAgY3VycmVudEl0ZW0gPSB0aGlzLmdldEN1cnJlbnRSb3coYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xyXG4gICAgfVxyXG4gICAgaWYgKGN1cnJlbnRJdGVtICYmIGN1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZSkge1xyXG4gICAgICBjb25zdCBhdHRhY2htZW50SWRzID0gdGhpcy5nZXRBdHRhY2htZW50SWRzQnlQYXRoQW5kRGF0YUlkcyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgW2N1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZV0pO1xyXG4gICAgICBpZiAoYXR0YWNobWVudElkcyAmJiBhdHRhY2htZW50SWRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBhdHRhY2htZW50SWRMaXN0LnB1c2guYXBwbHkoYXR0YWNobWVudElkTGlzdCwgYXR0YWNobWVudElkcyk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnBsc1NlbGVjdFVwZGF0ZVJvdywgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBkaWFsb2ckID0gZnJvbSh0aGlzLnVwbG9hZERpYWxvZ1NlcnZpY2UudXBsb2FkRmlsZVdpdGhMaW1pdChmb3JtSWQsIHJvb3RJZCwgdXBsb2FkTGltaXQsIGF0dGFjaG1lbnRJZExpc3QpKTtcclxuICAgIGNvbnN0IHJlc3VsdCQgPSBkaWFsb2ckLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcCgoZmlsZUluZm9zOiBVcGxvYWRGaWxlSW5mb1tdKSA9PiB7XHJcbiAgICAgICAgaWYgKCFmaWxlSW5mb3MgfHwgZmlsZUluZm9zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UucGxzVXBsb2FkRmlyc3QsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDov4fmu6Tlh7pzdGF0ZeS4uuaWsOWinueahOmZhOS7tlxyXG4gICAgICAgIGZpbGVJbmZvcyA9IGZpbGVJbmZvcy5maWx0ZXIoKGZpbGVJbmZvOiBVcGxvYWRGaWxlSW5mbykgPT4ge1xyXG4gICAgICAgICAgaWYgKGZpbGVJbmZvLmhhc093blByb3BlcnR5KCdzdGF0ZScpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmaWxlSW5mby5zdGF0ZSA9PT0gRmlsZVN0YXRlLk5ldztcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGlmIChmaWxlSW5mb3MubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOaYr+WQpuS4iuS8oOWIpOaWrVxyXG4gICAgICAgIGNvbnN0IGF0dGFjaG1lbnRJbmZvcyA9IEF0dGFjaG1lbnRVdGlsLmNvbnZlcnRUb0F0dGFjaG1lbnRJbmZvcyhmaWxlSW5mb3MpO1xyXG4gICAgICAgIGNvbnN0IGZpcnN0QXR0YWNobWVudEluZm8gPSBBdHRhY2htZW50VXRpbC5nZXRGaXJzdEF0dGFjaG1lbnRJbmZvKGF0dGFjaG1lbnRJbmZvcyk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXR0YWNoRGF0YVNlcnZpY2UudXBkYXRlUm93V2l0aFByb3BlcnR5TmFtZShhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgZmlyc3RBdHRhY2htZW50SW5mbyk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIHJldHVybiByZXN1bHQkO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDkuIrkvKDlpJrkuKrmlofku7ZcclxuICAgKi9cclxuICBwdWJsaWMgdXBsb2FkQW5kQmF0Y2hBZGRSb3dzKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIHJvb3REaXJJZD86IHN0cmluZywgcGFyZW50RGlyTmFtZT86IHN0cmluZywgZmlsZVR5cGU/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3Qgcm9vdElkID0gcm9vdERpcklkID8gcm9vdERpcklkIDogdGhpcy5kZWZhdWx0Um9vdERpcklkO1xyXG4gICAgY29uc3QgZm9ybUlkID0gcGFyZW50RGlyTmFtZSA/IHBhcmVudERpck5hbWUgOiB0aGlzLmRlZmF1bHRQYXJlbnREaXJOYW1lO1xyXG4gICAgaWYgKCFyb290SWQgfHwgIWZvcm1JZCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Jvb3REaXJJZOWSjHBhcmVudERpck5hbWXkuI3og73kuLrnqbrvvIzor7floavlhpknKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB1cGxvYWRMaW1pdDogVXBsb2FkTGltaXQgPSBuZXcgVXBsb2FkTGltaXQoKTtcclxuICAgIGlmIChmaWxlVHlwZSkge1xyXG4gICAgICB1cGxvYWRMaW1pdC5maWxlVHlwZSA9IGZpbGVUeXBlO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZGlhbG9nJCA9IGZyb20odGhpcy51cGxvYWREaWFsb2dTZXJ2aWNlLnVwbG9hZEZpbGVXaXRoTGltaXQoZm9ybUlkLCByb290SWQsIHVwbG9hZExpbWl0KSk7XHJcbiAgICBjb25zdCByZXN1bHQkID0gZGlhbG9nJC5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKGZpbGVJbmZvczogVXBsb2FkRmlsZUluZm9bXSkgPT4ge1xyXG4gICAgICAgIGlmICghZmlsZUluZm9zIHx8IGZpbGVJbmZvcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnBsc1VwbG9hZEZpcnN0LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g6L+H5ruk5Ye6c3RhdGXkuLrmlrDlop7nmoTpmYTku7ZcclxuICAgICAgICBmaWxlSW5mb3MgPSBmaWxlSW5mb3MuZmlsdGVyKChmaWxlSW5mbzogVXBsb2FkRmlsZUluZm8pID0+IHtcclxuICAgICAgICAgIGlmIChmaWxlSW5mby5oYXNPd25Qcm9wZXJ0eSgnc3RhdGUnKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmlsZUluZm8uc3RhdGUgPT09IEZpbGVTdGF0ZS5OZXc7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAoZmlsZUluZm9zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBhdHRhY2htZW50SW5mb3MgPSBBdHRhY2htZW50VXRpbC5jb252ZXJ0VG9BdHRhY2htZW50SW5mb3MoZmlsZUluZm9zKTtcclxuICAgICAgICByZXR1cm4gdGhpcy5hdHRhY2hEYXRhU2VydmljZS51cGRhdGVSb3dzKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBhdHRhY2htZW50SW5mb3MpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICAgIHJldHVybiByZXN1bHQkO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDkuIrkvKDlpJrkuKrmlofku7ZcclxuICAgKi9cclxuICBwdWJsaWMgdXBsb2FkQW5kQmF0Y2hBZGRSb3dzV2l0aFByb3BlcnR5TmFtZShhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCByb290RGlySWQ/OiBzdHJpbmcsIHBhcmVudERpck5hbWU/OiBzdHJpbmcsIGZpbGVUeXBlPzogc3RyaW5nLCBpZD86IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCByb290SWQgPSByb290RGlySWQgPyByb290RGlySWQgOiB0aGlzLmRlZmF1bHRSb290RGlySWQ7XHJcbiAgICBjb25zdCBmb3JtSWQgPSBwYXJlbnREaXJOYW1lID8gcGFyZW50RGlyTmFtZSA6IHRoaXMuZGVmYXVsdFBhcmVudERpck5hbWU7XHJcbiAgICBpZiAoIXJvb3RJZCB8fCAhZm9ybUlkKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcigncm9vdERpcklk5ZKMcGFyZW50RGlyTmFtZeS4jeiDveS4uuepuu+8jOivt+Whq+WGmScpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgdXBsb2FkTGltaXQ6IFVwbG9hZExpbWl0ID0gbmV3IFVwbG9hZExpbWl0KCk7XHJcbiAgICBpZiAoZmlsZVR5cGUpIHtcclxuICAgICAgdXBsb2FkTGltaXQuZmlsZVR5cGUgPSBmaWxlVHlwZTtcclxuICAgIH1cclxuICAgIGlmIChpZCkge1xyXG4gICAgICAvLyDkv67mraPlvZPliY3ooYxcclxuICAgICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0TGlzdCgpO1xyXG4gICAgICBpZiAoYmluZGluZ0xpc3QuY3VycmVudElkICE9PSBpZCkge1xyXG4gICAgICAgIGJpbmRpbmdMaXN0LnNldEN1cnJlbnRJZChpZCwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGNvbnN0IGRpYWxvZyQgPSBmcm9tKHRoaXMudXBsb2FkRGlhbG9nU2VydmljZS51cGxvYWRGaWxlV2l0aExpbWl0KGZvcm1JZCwgcm9vdElkLCB1cGxvYWRMaW1pdCkpO1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IGRpYWxvZyQucGlwZShcclxuICAgICAgc3dpdGNoTWFwKChmaWxlSW5mb3M6IFVwbG9hZEZpbGVJbmZvW10pID0+IHtcclxuICAgICAgICBpZiAoIWZpbGVJbmZvcyB8fCBmaWxlSW5mb3MubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5wbHNVcGxvYWRGaXJzdCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOi/h+a7pOWHunN0YXRl5Li65paw5aKe55qE6ZmE5Lu2XHJcbiAgICAgICAgZmlsZUluZm9zID0gZmlsZUluZm9zLmZpbHRlcigoZmlsZUluZm86IFVwbG9hZEZpbGVJbmZvKSA9PiB7XHJcbiAgICAgICAgICBpZiAoZmlsZUluZm8uaGFzT3duUHJvcGVydHkoJ3N0YXRlJykpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZpbGVJbmZvLnN0YXRlID09PSBGaWxlU3RhdGUuTmV3O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKGZpbGVJbmZvcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgYXR0YWNobWVudEluZm9zID0gQXR0YWNobWVudFV0aWwuY29udmVydFRvQXR0YWNobWVudEluZm9zKGZpbGVJbmZvcyk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXR0YWNoRGF0YVNlcnZpY2UudXBkYXRlUm93c1dpdGhQcm9wZXJ0eU5hbWUoYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGF0dGFjaG1lbnRJbmZvcyk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gICAgcmV0dXJuIHJlc3VsdCQ7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOS4i+i9vemZhOS7tu+8iOagueaNrumZhOS7tmlk77yJXHJcbiAgICovXHJcbiAgcHVibGljIGRvd25sb2FkKGF0dGFjaElkOiBzdHJpbmcsIHJvb3RJZD86IHN0cmluZyk6IGFueSB7XHJcbiAgICBpZiAoIWF0dGFjaElkKSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnBsc1NlbGVjdERvd25sb2FkQXR0LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgcm9vdElkID0gcm9vdElkIHx8ICdkZWZhdWx0LXJvb3QnO1xyXG4gICAgY29uc3QgdXJsID0gdGhpcy5nZXREb3dubG9hZFVybChbYXR0YWNoSWRdLCByb290SWQpO1xyXG4gICAgLy8gbGV0IHVybCA9ICcnO1xyXG4gICAgLy8gaWYgKHJvb3RJZCkge1xyXG4gICAgLy8gICB1cmwgPSBgL2FwaS9ydW50aW1lL2Rmcy92MS4wL2Zvcm1kb2MvZmlsZWNvbnRlbnQ/bWV0YWRhdGFpZD0ke2F0dGFjaElkfSZyb290aWQ9JHtyb290SWR9YDtcclxuICAgIC8vIH0gZWxzZSB7XHJcbiAgICAvLyAgIHVybCA9IGAvYXBpL3J1bnRpbWUvZGZzL3YxLjAvZm9ybWRvYy9kb3dubG9hZC8ke2F0dGFjaElkfWA7XHJcbiAgICAvLyB9XHJcbiAgICB3aW5kb3cub3Blbih1cmwpO1xyXG4gICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmibnph4/kuIvovb3pmYTku7bvvIjmoLnmja7pmYTku7ZpZOaVsOe7hO+8iVxyXG4gICAqL1xyXG4gIHB1YmxpYyBiYXRjaERvd25sb2FkKGF0dGFjaElkczogc3RyaW5nW10sIHJvb3RJZDogc3RyaW5nKTogYW55IHtcclxuICAgIGlmICghYXR0YWNoSWRzIHx8IGF0dGFjaElkcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UucGxzU2VsZWN0RG93bmxvYWRBdHQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcbiAgICAvLyDlj6rpgInmi6nkuIDkuKrpmYTku7bml7bmjInljZXkuKrpmYTku7bkuIvovb3lpITnkIZcclxuICAgIGlmIChhdHRhY2hJZHMubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmRvd25sb2FkKGF0dGFjaElkc1swXSwgcm9vdElkKTtcclxuICAgIH1cclxuICAgIC8vIGNvbnN0IGF0dGFjaElkc1N0cmluZyA9IEpTT04uc3RyaW5naWZ5KGF0dGFjaElkcyk7XHJcbiAgICAvLyBjb25zdCB1cmwgPSBgL2FwaS9ydW50aW1lL2Rmcy92MS4wL2Zvcm1kb2MvbXVsdGlwbGUvZG93bmxvYWQ/bWV0YWRhdGFpZGxpc3Q9JHthdHRhY2hJZHNTdHJpbmd9JnJvb3RpZD0ke3Jvb3RJZH1gO1xyXG4gICAgY29uc3QgdXJsID0gdGhpcy5nZXREb3dubG9hZFVybChhdHRhY2hJZHMsIHJvb3RJZCk7XHJcbiAgICB3aW5kb3cub3Blbih1cmwpO1xyXG4gICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bkuIvovb3ot6/lvoRcclxuICAgKiBAcGFyYW0gbWV0YWRhdGFpZGxpc3Qg6ZmE5Lu2aWTmlbDnu4RcclxuICAgKiBAcGFyYW0gcm9vdElkIHJvb3RJZFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RG93bmxvYWRVcmwobWV0YWRhdGFpZGxpc3Q6IEFycmF5PHN0cmluZz4sIHJvb3RJZDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJvb3RJZCA9IHJvb3RJZCB8fCAnZGVmYXVsdC1yb290JztcclxuICAgIGlmICh0aGlzLmRvd25sb2FkU2VydmljZSkge1xyXG4gICAgICBpZiAobWV0YWRhdGFpZGxpc3QubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZG93bmxvYWRTZXJ2aWNlLmdldERvd25sb2FkVXJsKG1ldGFkYXRhaWRsaXN0WzBdLCByb290SWQpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IGF0dGFjaElkc1N0cmluZyA9IEpTT04uc3RyaW5naWZ5KG1ldGFkYXRhaWRsaXN0KTtcclxuICAgICAgICByZXR1cm4gdGhpcy5kb3dubG9hZFNlcnZpY2UuZ2V0TXVsdGlwbGVEb3dubG9hZFVybChhdHRhY2hJZHNTdHJpbmcsIHJvb3RJZCk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnNvbGUud2Fybign5Zug5a6J5YWo6Zeu6aKY77yM6ZmE5Lu25LiL6L295o+Q5L6b5a6J5YWo5qCh6aqM5py65Yi277yM6ZmE5Lu25LiL6L295Yqf6IO96ZyA6YeN5paw57yW6K+R44CCJyk7XHJcbiAgICAgIGlmIChtZXRhZGF0YWlkbGlzdC5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICByZXR1cm4gQmFzZVBhdGhTZXJ2aWNlLmNvbnZlcnRQYXRoKGAvYXBpL3J1bnRpbWUvZGZzL3YxLjAvZm9ybWRvYy9maWxlY29udGVudD9tZXRhZGF0YWlkPSR7bWV0YWRhdGFpZGxpc3RbMF19JnJvb3RpZD0ke3Jvb3RJZH1gKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCBhdHRhY2hJZHNTdHJpbmcgPSBKU09OLnN0cmluZ2lmeShtZXRhZGF0YWlkbGlzdCk7XHJcbiAgICAgICAgcmV0dXJuIEJhc2VQYXRoU2VydmljZS5jb252ZXJ0UGF0aChgL2FwaS9ydW50aW1lL2Rmcy92MS4wL2Zvcm1kb2MvbXVsdGlwbGUvZG93bmxvYWQ/bWV0YWRhdGFpZGxpc3Q9JHthdHRhY2hJZHNTdHJpbmd9JnJvb3RpZD0ke3Jvb3RJZH1gKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDkuIvovb3vvIjmoLnmja7mlbDmja5pZO+8iVxyXG4gICAqL1xyXG4gIHB1YmxpYyBkb3dubG9hZEJ5RGF0YUlkKGRhdGFJZDogc3RyaW5nLCBhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCByb290SWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBpZiAoIWRhdGFJZCkge1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5wbHNTZWxlY3REb3dubG9hZEF0dCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBkYXRhSWRzID0gW2RhdGFJZF07XHJcbiAgICBjb25zdCBhdHRhY2hJZHMgPSB0aGlzLmdldEF0dGFjaG1lbnRJZHNCeVBhdGhBbmREYXRhSWRzKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBkYXRhSWRzKTtcclxuICAgIGlmIChhdHRhY2hJZHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLm5vRG93bmxvYWRBdHQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgYXR0YWNoSWQgPSBhdHRhY2hJZHNbMF07XHJcbiAgICByZXR1cm4gdGhpcy5kb3dubG9hZChhdHRhY2hJZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmibnph4/kuIvovb3pmYTku7ZcclxuICAgKi9cclxuICBwdWJsaWMgYmF0Y2hEb3dubG9hZEJ5RGF0YUlkcyhkYXRhSWRzOiBzdHJpbmdbXSB8IHN0cmluZywgYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgcm9vdElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgaWYgKHR5cGVvZiBkYXRhSWRzID09PSAnc3RyaW5nJyAmJiBkYXRhSWRzICYmIGRhdGFJZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBkYXRhSWRzID0gZGF0YUlkcy5zcGxpdCgnLCcpLmZpbHRlcihwID0+IHApO1xyXG4gICAgfVxyXG4gICAgaWYgKCFkYXRhSWRzIHx8IEFycmF5LmlzQXJyYXkoZGF0YUlkcykgPT09IGZhbHNlIHx8IGRhdGFJZHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnBsc1NlbGVjdERvd25sb2FkQXR0LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgY29uc3QgaWRzID0gW10uY29uY2F0KGRhdGFJZHMpO1xyXG4gICAgY29uc3QgYXR0YWNoSWRzID0gdGhpcy5nZXRBdHRhY2htZW50SWRzQnlQYXRoQW5kRGF0YUlkcyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgaWRzKTtcclxuICAgIGlmIChhdHRhY2hJZHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLm5vRG93bmxvYWRBdHQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuYmF0Y2hEb3dubG9hZChhdHRhY2hJZHMsIHJvb3RJZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmoLnmja7pmYTku7ZVRFTlrZfmrrXnmoTot6/lvoTpooTop4jpmYTku7ZcclxuICAgKiBAcGFyYW0gYXR0YWNobWVudEluZm9GaWVsZFBhdGgg6ZmE5Lu2VURU5a2X5q61cGF0aFxyXG4gICAqIEBwYXJhbSByb290RGlySWQg6Lef55uu5b2VaWRcclxuICAgKiBAcGFyYW0gaWRzIOmZhOS7tmlkXHJcbiAgICovXHJcbiAgcHVibGljIHByZXZpZXdCeUF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIHJvb3REaXJJZDogc3RyaW5nLCBpZHM/OiBhbnkpIHtcclxuICAgIGlmICghYXR0YWNobWVudEluZm9GaWVsZFBhdGggfHwgIXJvb3REaXJJZCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2F0dGFjaG1lbnRJbmZvRmllbGRQYXRo5ZKMcm9vdERpcklk5LiN6IO95Li656m677yM6K+35aGr5YaZJyk7XHJcbiAgICB9XHJcbiAgICBsZXQgYXR0YWNoSWRzID0gW107XHJcbiAgICBsZXQgZGF0YUlkcyA9IFtdO1xyXG4gICAgaWYgKGlkcyAmJiBpZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBpZiAodHlwZW9mIChpZHMpID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgIGRhdGFJZHMucHVzaChpZHMpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGRhdGFJZHMgPSBpZHM7XHJcbiAgICAgIH1cclxuICAgICAgYXR0YWNoSWRzID0gdGhpcy5nZXRBdHRhY2htZW50SWRzQnlQYXRoQW5kRGF0YUlkcyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgZGF0YUlkcyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBhdHRhY2hJZHMgPSB0aGlzLmdldEF0dGFjaG1lbnRJZHNCeVBhdGhBbmREYXRhSWRzKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBudWxsKTtcclxuICAgIH1cclxuICAgIGlmIChhdHRhY2hJZHMgJiYgYXR0YWNoSWRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5ub0F0dGFjaG1lbnQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5wcmV2aWV3QnlBdHRhY2htZW50SWRzKGF0dGFjaElkcywgcm9vdERpcklkKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5qC55o2u6ZmE5Lu2VURU5a2X5q6155qE6Lev5b6E6aKE6KeI5b2T5YmN6KGM55qE6ZmE5Lu2XHJcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoIOmZhOS7tlVEVOWtl+autXBhdGhcclxuICAgKiBAcGFyYW0gcm9vdERpcklkIOagueebruW9lWlkXHJcbiAgICovXHJcbiAgcHVibGljIHByZXZpZXdCeUF0dGFjaG1lbnRJbmZvRmllbGRQYXRoV2l0aEluZGV4KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIHJvb3REaXJJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmICghYXR0YWNobWVudEluZm9GaWVsZFBhdGggfHwgIXJvb3REaXJJZCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2F0dGFjaG1lbnRJbmZvRmllbGRQYXRo5ZKMcm9vdERpcklk5LiN6IO95Li656m677yM6K+35aGr5YaZJyk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBjdXJyZW50Um93ID0gdGhpcy5nZXRDdXJyZW50Um93KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcclxuICAgIGNvbnN0IHBhcmVudEJpbmRpbmdQYXRoQXJyYXkgPSBCaW5kaW5nUGF0aENvbnZlcnRlci50b0JpbmRpbmdQYXRoQXJyYXkoYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xyXG4gICAgY29uc3QgYXR0YWNobWVudEZpZWxkTmFtZSA9IHBhcmVudEJpbmRpbmdQYXRoQXJyYXkucG9wKCk7XHJcbiAgICBpZiAoIWN1cnJlbnRSb3dbYXR0YWNobWVudEZpZWxkTmFtZV0gfHwgIWN1cnJlbnRSb3dbYXR0YWNobWVudEZpZWxkTmFtZV1bJ2F0dGFjaG1lbnRJZCddKSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLm5vQXR0YWNobWVudCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIGNvbnN0IGF0dGFjaElkcyA9IHRoaXMuZ2V0QXR0YWNobWVudElkc0J5UGF0aEFuZERhdGFJZHMoYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIG51bGwpO1xyXG4gICAgaWYgKGF0dGFjaElkcyAmJiBhdHRhY2hJZHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLm5vQXR0YWNobWVudCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIGNvbnN0IGF0dGFjaG1lbnRJZCA9IHRoaXMuZ2V0Q3VycmVudEF0dGFjaG1lbnRJZChhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCk7XHJcbiAgICBpZiAoIWF0dGFjaG1lbnRJZCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ+imgemihOiniOeahOmZhOS7tmlk5LiN5a2Y5Zyo77yM6K+356Gu6K6kJyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdGhpcy5wcmV2aWV3RmlsZUxpc3RXaXRoSW5kZXgoYXR0YWNoSWRzLCByb290RGlySWQsIGF0dGFjaG1lbnRJZCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOagueaNruebruW9lemihOiniOmZhOS7tlxyXG4gICAqIEBwYXJhbSBzdWJEaXJOYW1lIOeItuebruW9leWQjeensFxyXG4gICAqIEBwYXJhbSByb290RGlySWQg5qC555uu5b2VaWRcclxuICAgKi9cclxuICBwdWJsaWMgcHJldmlld0J5U3ViRGlyTmFtZShzdWJEaXJOYW1lOiBzdHJpbmcsIHJvb3REaXJJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmICghc3ViRGlyTmFtZSB8fCAhcm9vdERpcklkKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignc3ViRGlyTmFtZeWSjHJvb3REaXJJZOS4jeiDveS4uuepuu+8jOivt+Whq+WGmScpO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgdmlld2VyJCA9IGZyb20odGhpcy5maWxlVmlld2VyU2VydmljZS52aWV3ZXJGb3JtRmlsZShzdWJEaXJOYW1lLCByb290RGlySWQpKTtcclxuICAgIHJldHVybiB2aWV3ZXIkO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmoLnmja7nm67lvZXpooTop4jmjIflrprntKLlvJXnmoTpmYTku7ZcclxuICAgKiBAcGFyYW0gYXR0YWNobWVudEluZm9GaWVsZFBhdGgg6ZmE5Lu2VURU5a2X5q61cGF0aFxyXG4gICAqIEBwYXJhbSBzdWJEaXJOYW1lIOWtkOebruW9leWQjeensFxyXG4gICAqIEBwYXJhbSByb290RGlySWQg5qC555uu5b2VaWRcclxuICAgKi9cclxuICBwdWJsaWMgcHJldmlld0J5U3ViRGlyTmFtZVdpdGhJbmRleChhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBzdWJEaXJOYW1lOiBzdHJpbmcsIHJvb3REaXJJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmICghc3ViRGlyTmFtZSB8fCAhcm9vdERpcklkKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignc3ViRGlyTmFtZeWSjHJvb3REaXJJZOS4jeiDveS4uuepuu+8jOivt+Whq+WGmScpO1xyXG4gICAgfVxyXG4gICAgLy8gY29uc3QgYXR0YWNoSWRzID0gdGhpcy5nZXRBdHRhY2htZW50SWRzQnlQYXRoQW5kRGF0YUlkcyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgbnVsbCk7XHJcbiAgICBjb25zdCBhdHRhY2htZW50SWQgPSB0aGlzLmdldEN1cnJlbnRBdHRhY2htZW50SWQoYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xyXG4gICAgaWYgKCFhdHRhY2htZW50SWQpIHtcclxuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2Uubm9BdHRhY2htZW50LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgdmlld2VyJCA9IGZyb20odGhpcy5maWxlVmlld2VyU2VydmljZS52aWV3ZXJGb3JtRmlsZVdpdGhJbmRleChzdWJEaXJOYW1lLCByb290RGlySWQsIGF0dGFjaG1lbnRJZCkpO1xyXG4gICAgcmV0dXJuIHZpZXdlciQ7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOagueaNrumZhOS7tmlk5pWw57uE6aKE6KeI6ZmE5Lu2XHJcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJZHMg6ZmE5Lu2aWTmlbDnu4RcclxuICAgKiBAcGFyYW0gcm9vdERpcklkIOagueebruW9lWlkXHJcbiAgICovXHJcbiAgcHVibGljIHByZXZpZXdCeUF0dGFjaG1lbnRJZHMoYXR0YWNobWVudElkczogc3RyaW5nW10sIHJvb3REaXJJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHZpZXdlciQgPSBmcm9tKHRoaXMuZmlsZVZpZXdlclNlcnZpY2Uudmlld2VyRmlsZUxpc3QoYXR0YWNobWVudElkcywgcm9vdERpcklkKSk7XHJcbiAgICByZXR1cm4gdmlld2VyJDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5qC55o2u6ZmE5Lu2aWTmlbDnu4TpooTop4jmjIflrprntKLlvJXnmoTpmYTku7ZcclxuICAgKiBAcGFyYW0gYXR0YWNobWVudElkcyDpmYTku7ZpZOaVsOe7hFxyXG4gICAqIEBwYXJhbSByb290RGlySWQg5qC555uu5b2VaWRcclxuICAgKiBAcGFyYW0gYXR0YWNobWVudElkIOmZhOS7tklkXHJcbiAgICovXHJcbiAgcHVibGljIHByZXZpZXdGaWxlTGlzdFdpdGhJbmRleChhdHRhY2htZW50SWRzOiBzdHJpbmdbXSwgcm9vdERpcklkOiBzdHJpbmcsIGF0dGFjaG1lbnRJZDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCB2aWV3ZXIkID0gZnJvbSh0aGlzLmZpbGVWaWV3ZXJTZXJ2aWNlLnZpZXdlckZpbGVMaXN0V2l0aEluZGV4KGF0dGFjaG1lbnRJZHMsIHJvb3REaXJJZCwgYXR0YWNobWVudElkKSk7XHJcbiAgICByZXR1cm4gdmlld2VyJDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog55Sf5oiQ54mI5pys5Y+3XHJcbiAgICogQHBhcmFtIHZlcnNpb25zIOWOhuWPsueJiOacrOWPt1xyXG4gICAqIEBkZXNjcmlwdGlvbiDpu5jorqTnvJbnoIHop4TliJl2MS4wIHYyLjAgLi4uXHJcbiAgICovXHJcbiAgcHVibGljIGdlblZlcnNpb24odmVyc2lvbnM6IHN0cmluZ1tdKSB7XHJcbiAgICBpZiAoIXZlcnNpb25zKSB7XHJcbiAgICAgIHZlcnNpb25zID0gW107XHJcbiAgICB9XHJcbiAgICBjb25zdCBtYWluQ29kZSA9IHZlcnNpb25zLmxlbmd0aCArIDE7XHJcbiAgICByZXR1cm4gYFYke21haW5Db2RlfS4wYDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5pu05paw6ZmE5Lu254mI5pys5L+h5oGvXHJcbiAgICogQHBhcmFtIHZlcnNpb25GaWVsZCDpmYTku7bniYjmnKzlrZfmrrVcclxuICAgKiBAcGFyYW0gaGlzdG9yeUZpZWxkIOaYr+WQpuWOhuWPsueJiOacrOWtl+autVxyXG4gICAqIEBwYXJhbSBhdHRhY2htZW50RmllbGRQYXRoIOmZhOS7tnVkdOWtl+autei3r+W+hFxyXG4gICAqL1xyXG4gIHB1YmxpYyB1cGRhdGVBdHRhY2htZW50VmVyc2lvbih2ZXJzaW9uRmllbGQ6IHN0cmluZywgaGlzdG9yeUZpZWxkOiBzdHJpbmcsIGF0dGFjaG1lbnRGaWVsZFBhdGg6IHN0cmluZykge1xyXG4gICAgLyoqXHJcbiAgICAgKiDpgY3ljobmiYDmnInpmYTku7booYxcclxuICAgICAqIOaJvuWIsOaJgOacieayoeaciemZhOS7tueJiOacrOeahOihjFxyXG4gICAgICog6YGN5Y6G6L+Z5Lqb6KGMXHJcbiAgICAgKiDpgJrov4fmlofku7blkI3ljrvmn6Xmib7lkIzlkI3nmoTkuJTmnInpmYTku7bniYjmnKzlj7fnmoTooYxcclxuICAgICAqIOi/meS6m+ihjOWOhuWPsueJiOacrOWtl+autee9ruS4unRydWVcclxuICAgICAqIOaXoOeJiOacrOWPt+eahOihjO+8jOeJiOacrD0g5LiK6KGM5pWwICsgMVxyXG4gICAgICpcclxuICAgICAqL1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gYXR0YWNobWVudEZpZWxkUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgLy8g5by55Ye66ZmE5Lu2dWR05a2X5q61XHJcbiAgICBjb25zdCBhdHRhY2htZW50RmllbGQgPSBiaW5kaW5nUGF0aHMucG9wKCk7XHJcbiAgICAvLyDojrflj5bliLDmiYDmnInnmoTpmYTku7ZcclxuICAgIGNvbnN0IGF0dGFjaG1lbnRCaW5kaW5nTGlzdCA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldFZhbHVlKGJpbmRpbmdQYXRocykgYXMgQmluZGluZ0xpc3Q7XHJcbiAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PGFueT47XHJcbiAgICBjb25zdCBlbnRpdHlNYW5hZ2VyID0gYmVmUmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyO1xyXG4gICAgY29uc3QgZGF0YVBhdGggPSBEYXRhUGF0aENyZWF0b3IuY3JlYXRlQnlTaG9ydFBhdGhGcm9tUm9vdChiaW5kaW5nUGF0aHMsIGVudGl0eU1hbmFnZXIsIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhKTtcclxuICAgIGNvbnN0IHBhdGhzID0gZGF0YVBhdGgudG9BcnJheSgpLm1hcCgocGF0aDogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGlmIChwYXRoLnN0YXJ0c1dpdGgoJ1Byb3BOYW1lOicpKSB7XHJcbiAgICAgICAgcmV0dXJuIHBhdGguc3BsaXQoJzonKVsxXTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gcGF0aDtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICBpZiAoYXR0YWNobWVudEJpbmRpbmdMaXN0KSB7XHJcbiAgICAgIGNvbnN0IGF0dGFjaG1lbnRzID0gYXR0YWNobWVudEJpbmRpbmdMaXN0LnRvSlNPTigpO1xyXG4gICAgICAvLyDlj6rlpITnkIbmnInpmYTku7bnmoTmg4XlhrVcclxuICAgICAgaWYgKGF0dGFjaG1lbnRzKSB7XHJcbiAgICAgICAgY29uc3QgdmVyc2lvbkxlc3NSb3dzID0gYXR0YWNobWVudHMuZmlsdGVyKGl0ZW0gPT4gIWl0ZW1bdmVyc2lvbkZpZWxkXSk7XHJcbiAgICAgICAgdmVyc2lvbkxlc3NSb3dzLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBmaWxlTmFtZSA9IGl0ZW1bYXR0YWNobWVudEZpZWxkXVsnZmlsZU5hbWUnXTtcclxuICAgICAgICAgIGNvbnN0IHZlcnNpb25lZFJvd3MgPSBhdHRhY2htZW50cy5maWx0ZXIocm93ID0+IHJvd1thdHRhY2htZW50RmllbGRdWydmaWxlTmFtZSddID09PSBmaWxlTmFtZSAmJiByb3dbdmVyc2lvbkZpZWxkXSk7XHJcbiAgICAgICAgICBwYXRocy5wb3AoKTtcclxuICAgICAgICAgIHBhdGhzLnB1c2goYERhdGFJZDoke2l0ZW1bYXR0YWNobWVudEJpbmRpbmdMaXN0LnByaW1hcnlLZXldfWApO1xyXG4gICAgICAgICAgbGV0IGVudGl0eSA9IHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdHlCeVBhdGgocGF0aHMpO1xyXG4gICAgICAgICAgY29uc3QgdmVyc2lvbiA9IHRoaXMuZ2VuVmVyc2lvbih2ZXJzaW9uZWRSb3dzKTtcclxuICAgICAgICAgIGVudGl0eVt2ZXJzaW9uRmllbGRdID0gdmVyc2lvbjtcclxuICAgICAgICAgIGVudGl0eVtoaXN0b3J5RmllbGRdID0gZmFsc2U7XHJcbiAgICAgICAgICAvLyDlpITnkIbljoblj7LorrDlvZVcclxuICAgICAgICAgIHZlcnNpb25lZFJvd3MuZm9yRWFjaChyb3cgPT4ge1xyXG4gICAgICAgICAgICBwYXRocy5wb3AoKTtcclxuICAgICAgICAgICAgcGF0aHMucHVzaChgRGF0YUlkOiR7cm93W2F0dGFjaG1lbnRCaW5kaW5nTGlzdC5wcmltYXJ5S2V5XX1gKTtcclxuICAgICAgICAgICAgZW50aXR5ID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0eUJ5UGF0aChwYXRocyk7XHJcbiAgICAgICAgICAgIGVudGl0eVtoaXN0b3J5RmllbGRdID0gdHJ1ZTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIHB1YmxpYyBpc0F0dGFjaG1lbnRDYW5EZWxldGUoaGlzdG9yeUZpZWxkOiBzdHJpbmcsIGF0dGFjaG1lbnRGaWVsZFBhdGg6IHN0cmluZykge1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gYXR0YWNobWVudEZpZWxkUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgLy8g5by55Ye66ZmE5Lu2dWR05a2X5q61XHJcbiAgICBiaW5kaW5nUGF0aHMucG9wKCk7XHJcbiAgICBjb25zdCBhdHRhY2htZW50QmluZGluZ0xpc3QgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRWYWx1ZShiaW5kaW5nUGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xyXG4gICAgY29uc3QgYmluZGluZ09iamVjdCA9IGF0dGFjaG1lbnRCaW5kaW5nTGlzdC5jdXJyZW50SXRlbTtcclxuICAgIGlmIChiaW5kaW5nT2JqZWN0W2hpc3RvcnlGaWVsZF0gPT09IHRydWUpIHtcclxuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UuaGlzdG9yeUF0dGFjaG1lbnQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHB1YmxpYyB1cGRhdGVBdHRhY2htZW50SGlzdG9yeSh2ZXJzaW9uRmllbGQ6IHN0cmluZywgaGlzdG9yeUZpZWxkOiBzdHJpbmcsIGF0dGFjaG1lbnRGaWVsZFBhdGg6IHN0cmluZykge1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gYXR0YWNobWVudEZpZWxkUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgLy8g5by55Ye66ZmE5Lu2dWR05a2X5q61XHJcbiAgICBjb25zdCBhdHRhY2htZW50RmllbGQgPSBiaW5kaW5nUGF0aHMucG9wKCk7XHJcbiAgICAvLyDojrflj5bliLDmiYDmnInnmoTpmYTku7ZcclxuICAgIGNvbnN0IGF0dGFjaG1lbnRCaW5kaW5nTGlzdCA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldFZhbHVlKGJpbmRpbmdQYXRocykgYXMgQmluZGluZ0xpc3Q7XHJcbiAgICAvLyBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PGFueT47XHJcbiAgICAvLyBjb25zdCBlbnRpdHlNYW5hZ2VyID0gYmVmUmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyO1xyXG4gICAgaWYgKGF0dGFjaG1lbnRCaW5kaW5nTGlzdCkge1xyXG4gICAgICBjb25zdCBhdHRhY2htZW50cyA9IGF0dGFjaG1lbnRCaW5kaW5nTGlzdC50b0pTT04oKTtcclxuICAgICAgY29uc3QgdmVyc2lvbmVkUm93cyA9IGF0dGFjaG1lbnRzLmZpbHRlcihpdGVtID0+IGl0ZW1bdmVyc2lvbkZpZWxkXSk7XHJcbiAgICAgIGNvbnN0IGZpbGVOYW1lTWFwID0gbmV3IE1hcDxzdHJpbmcsIEFycmF5PGFueT4+KCk7XHJcbiAgICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcclxuICAgICAgY29uc3QgZW50aXR5TWFuYWdlciA9IGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlcjtcclxuICAgICAgY29uc3QgZGF0YVBhdGggPSBEYXRhUGF0aENyZWF0b3IuY3JlYXRlQnlTaG9ydFBhdGhGcm9tUm9vdChiaW5kaW5nUGF0aHMsIGVudGl0eU1hbmFnZXIsIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhKTtcclxuICAgICAgY29uc3QgcGF0aHMgPSBkYXRhUGF0aC50b0FycmF5KCkubWFwKChwYXRoOiBzdHJpbmcpID0+IHtcclxuICAgICAgICBpZiAocGF0aC5zdGFydHNXaXRoKCdQcm9wTmFtZTonKSkge1xyXG4gICAgICAgICAgcmV0dXJuIHBhdGguc3BsaXQoJzonKVsxXTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIHBhdGg7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgdmVyc2lvbmVkUm93cy5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgIGNvbnN0IGZpbGVOYW1lID0gaXRlbVthdHRhY2htZW50RmllbGRdWydmaWxlTmFtZSddO1xyXG4gICAgICAgIGlmIChmaWxlTmFtZU1hcC5oYXMoZmlsZU5hbWUpKSB7XHJcbiAgICAgICAgICBmaWxlTmFtZU1hcC5nZXQoZmlsZU5hbWUpLnB1c2goaXRlbSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGZpbGVOYW1lTWFwLnNldChmaWxlTmFtZSwgW2l0ZW1dKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICBBcnJheS5mcm9tKGZpbGVOYW1lTWFwLnZhbHVlcygpKS5mb3JFYWNoKChhcnJheTogQXJyYXk8YW55PikgPT4ge1xyXG4gICAgICAgIGFycmF5LnNvcnQoKHgsIHkpID0+IHtcclxuICAgICAgICAgIGNvbnN0IHhWZXJzaW9uID0gcGFyc2VJbnQoeFt2ZXJzaW9uRmllbGRdLnJlcGxhY2UoL1thLXpBLVpcXC5dL2csICcnKSk7XHJcbiAgICAgICAgICBjb25zdCB5VmVyc2lvbiA9IHBhcnNlSW50KHlbdmVyc2lvbkZpZWxkXS5yZXBsYWNlKC9bYS16QS1aXFwuXS9nLCAnJykpO1xyXG4gICAgICAgICAgcmV0dXJuIHlWZXJzaW9uIC0geFZlcnNpb247XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29uc3Qgcm93ID0gYXJyYXlbMF07XHJcbiAgICAgICAgcGF0aHMucG9wKCk7XHJcbiAgICAgICAgcGF0aHMucHVzaChgRGF0YUlkOiR7cm93W2F0dGFjaG1lbnRCaW5kaW5nTGlzdC5wcmltYXJ5S2V5XX1gKTtcclxuICAgICAgICBjb25zdCBlbnRpdHkgPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlQYXRoKHBhdGhzKTtcclxuICAgICAgICBlbnRpdHlbaGlzdG9yeUZpZWxkXSA9IGZhbHNlO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yig6Zmk6ZmE5Lu2XHJcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoIOmZhOS7tnVkdOWtl+autei3r+W+hFxyXG4gICAqIEBwYXJhbSBpZCDmlbDmja5pZFxyXG4gICAqIEBwYXJhbSByb290RGlySWQg5qC555uu5b2VXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwdWJsaWMgcmVtb3ZlQXR0YWNobWVudChhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBpZDogc3RyaW5nLCByb290RGlySWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCByb290SWQgPSByb290RGlySWQ7XHJcbiAgICBpZiAoIXJvb3RJZCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Jvb3REaXJJZOWSjHBhcmVudERpck5hbWXkuI3og73kuLrnqbrvvIzor7floavlhpknKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGRhdGFJZHMgPSBbaWRdO1xyXG4gICAgY29uc3QgYXR0YWNoSWRzID0gdGhpcy5nZXRBdHRhY2htZW50SWRzQnlQYXRoQW5kRGF0YUlkcyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgZGF0YUlkcyk7XHJcbiAgICBpZiAoYXR0YWNoSWRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5wbHNTZWxlY3RSZW1vdmVBdHQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBhdHRhY2htZW50SWQgPSBhdHRhY2hJZHNbMF07XHJcbiAgICByZXR1cm4gdGhpcy5hdHRhY2hEYXRhU2VydmljZS5yZW1vdmVBdHRhY2htZW50KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCB7IGF0dGFjaG1lbnRJZCwgZmlsZU5hbWU6IG51bGwgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluW9k+WJjeinhuWbvuaooeWei+W9k+WJjeihjOeahOmZhOS7tmlkXHJcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoIOmZhOS7tnVkdOWtl+autVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Q3VycmVudEF0dGFjaG1lbnRJZChhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBwYXJlbnRCaW5kaW5nUGF0aEFycmF5ID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcclxuICAgIGNvbnN0IGF0dGFjaG1lbnRGaWVsZE5hbWUgPSBwYXJlbnRCaW5kaW5nUGF0aEFycmF5LnBvcCgpO1xyXG4gICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0VmFsdWUocGFyZW50QmluZGluZ1BhdGhBcnJheSkgYXMgQmluZGluZ0xpc3Q7XHJcbiAgICBjb25zdCBjdXJyZW50SXRlbSA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtO1xyXG4gICAgaWYgKGN1cnJlbnRJdGVtICYmIGN1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZSkge1xyXG4gICAgICByZXR1cm4gY3VycmVudEl0ZW1bYXR0YWNobWVudEZpZWxkTmFtZV0gJiYgY3VycmVudEl0ZW1bYXR0YWNobWVudEZpZWxkTmFtZV1bJ2F0dGFjaG1lbnRJZCddIHx8IG51bGw7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5b2T5YmN6KGMXHJcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoIHVkdOWtl+autVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Q3VycmVudFJvdyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBwYXJlbnRCaW5kaW5nUGF0aEFycmF5ID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcclxuICAgIHBhcmVudEJpbmRpbmdQYXRoQXJyYXkucG9wKCk7XHJcbiAgICBjb25zdCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRWYWx1ZShwYXJlbnRCaW5kaW5nUGF0aEFycmF5KSBhcyBCaW5kaW5nTGlzdDtcclxuICAgIGNvbnN0IGN1cnJlbnRJdGVtID0gYmluZGluZ0xpc3QgJiYgYmluZGluZ0xpc3QuY3VycmVudEl0ZW07XHJcbiAgICByZXR1cm4gY3VycmVudEl0ZW07XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluaMh+WumumZhOS7tuS/oeaBr+ihqOeahOaMh+WumuihjFxyXG4gICAqIEBwYXJhbSBhdHRhY2htZW50SW5mb0ZpZWxkUGF0aFxyXG4gICAqIEBwYXJhbSBwcmltYXJ5VmFsdWVcclxuICAgKiBAcmV0dXJuc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0U3BlY2lhbFJvdyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBwcmltYXJ5VmFsdWU6IHN0cmluZykge1xyXG4gICAgY29uc3QgcGFyZW50QmluZGluZ1BhdGhBcnJheSA9IEJpbmRpbmdQYXRoQ29udmVydGVyLnRvQmluZGluZ1BhdGhBcnJheShhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCk7XHJcbiAgICBwYXJlbnRCaW5kaW5nUGF0aEFycmF5LnBvcCgpO1xyXG4gICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0VmFsdWUocGFyZW50QmluZGluZ1BhdGhBcnJheSkgYXMgQmluZGluZ0xpc3Q7XHJcbiAgICBjb25zdCBjdXJyZW50SXRlbSA9IGJpbmRpbmdMaXN0ICYmIGJpbmRpbmdMaXN0LmZpbmRCeUlkKHByaW1hcnlWYWx1ZSk7XHJcbiAgICByZXR1cm4gY3VycmVudEl0ZW07XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlmRhdGFJZHPlr7nlupRFbnRpdHnkuIrnmoTpmYTku7ZpZOaVsOe7hFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0QXR0YWNobWVudElkc0J5UGF0aEFuZERhdGFJZHMoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgZGF0YUlkcz86IHN0cmluZ1tdKTogc3RyaW5nW10ge1xyXG5cclxuICAgIC8vIOino+aekOi3r+W+hFxyXG4gICAgY29uc3QgcGFyZW50QmluZGluZ1BhdGhBcnJheSA9IEJpbmRpbmdQYXRoQ29udmVydGVyLnRvQmluZGluZ1BhdGhBcnJheShhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCk7XHJcbiAgICBjb25zdCBhdHRhY2htZW50RmllbGROYW1lID0gcGFyZW50QmluZGluZ1BhdGhBcnJheS5wb3AoKTtcclxuXHJcbiAgICAvLyDojrflj5bpmYTku7bmiYDlnKjlrp7kvZPnmoTmlbDmja7liJfooajvvIzkuI3kvKDpgJJkYXRhSWRz5Y+C5pWw77yM5YiZ6L+U5Zue5YWo6YOoXHJcbiAgICBjb25zdCBlbnRpdHlMaXN0RGF0YSA9IHRoaXMuZW50aXR5U2VydmljZS5nZXRFbnRpdHlMaXN0RGF0YShwYXJlbnRCaW5kaW5nUGF0aEFycmF5KTtcclxuICAgIGxldCBmaWx0ZXJlZEVudGl0eUxpc3REYXRhID0gW107XHJcbiAgICBpZiAoZGF0YUlkcyAmJiBBcnJheS5pc0FycmF5KGRhdGFJZHMpID09PSB0cnVlKSB7XHJcbiAgICAgIGZpbHRlcmVkRW50aXR5TGlzdERhdGEgPSBlbnRpdHlMaXN0RGF0YS5maWx0ZXIoKGVudGl0eURhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgIHJldHVybiBkYXRhSWRzLmluZGV4T2YoZW50aXR5RGF0YS5pZCkgPiAtMTtcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBmaWx0ZXJlZEVudGl0eUxpc3REYXRhID0gZW50aXR5TGlzdERhdGE7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g6L2s5o2i5Li66ZmE5Lu2SWTmlbDnu4RcclxuICAgIGNvbnN0IGF0dGFjaG1lbnRJZHMgPSBbXTtcclxuICAgIGZpbHRlcmVkRW50aXR5TGlzdERhdGEuZm9yRWFjaCgoZW50aXR5RGF0YTogYW55KSA9PiB7XHJcbiAgICAgIGlmIChlbnRpdHlEYXRhW2F0dGFjaG1lbnRGaWVsZE5hbWVdKSB7XHJcbiAgICAgICAgY29uc3QgYXR0YWNobWVudElkID0gZW50aXR5RGF0YVthdHRhY2htZW50RmllbGROYW1lXVsnYXR0YWNobWVudElkJ107XHJcbiAgICAgICAgaWYgKGF0dGFjaG1lbnRJZCkge1xyXG4gICAgICAgICAgYXR0YWNobWVudElkcy5wdXNoKGF0dGFjaG1lbnRJZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gYXR0YWNobWVudElkcztcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IEF0dGFjaG1lbnRTZXJ2aWNlIH07XHJcbiJdfQ==