import { Injectable, Optional } from '@angular/core';
import { forkJoin, Subject } from 'rxjs';
import { FrameContext, BindingPathConverter } from '@farris/devkit';
import { FormNotifyService } from '../form-notify.service';
import { ATTACHMENT_ORDER_FIELD } from './types';
import { AttachmentDataService } from './attachment-data.service';
import { LanguageService } from '../languag.service';
import { EntityService } from '../entity-services/index';
import { ListDataService, SubListDataService } from '../data-services/index';
import { FormLoadingService } from '../form-loading/form-loading.service';
import { debounceTime, tap } from 'rxjs/operators';
/**
 * 附件上传
 * @summary
 * fileExtend：命名文件上传或预览组件传递过来的数据；
 * fileExtendFieldPath：命名附件UDT的字段路径；
 * attachmentInfo：命名附件UDT所需的信息；
 */
var FileService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function FileService(frameContext, attachDataService, entityService, subListDataService, notifyService, languageService, listDataService, formLoadingService) {
        var _this = this;
        this.frameContext = frameContext;
        this.attachDataService = attachDataService;
        this.entityService = entityService;
        this.subListDataService = subListDataService;
        this.notifyService = notifyService;
        this.languageService = languageService;
        this.listDataService = listDataService;
        this.formLoadingService = formLoadingService;
        this.subject = new Subject();
        this.subject.pipe(debounceTime(500)).subscribe(function (data) {
            _this.process(data.fileInfoFieldPath, data.configs);
        });
        this.attachmentInfos = [];
    }
    // #region 上传文件
    /**
     * 批量添加附件行
     */
    FileService.prototype.addFileRows = function (fileInfoFieldPath) {
        var attachmentInfos = this.getAttachmentInfosToAddFromContext();
        if (attachmentInfos.length === 0) {
            this.notifyService.info('请先上传附件');
        }
        return this.attachDataService.updateRows(fileInfoFieldPath, attachmentInfos);
    };
    /**
     * 批量添加带附件类型的附件行
     * @param fileInfoFieldPath 附件udt字段
     * @param configs 附件扩展信息配置
     * @description configs配置如{"billId":"{UISTATE~/root/billId}","rowId":"{UISTATE~/root/rowId}","attachmentType":"xueli"}
     */
    FileService.prototype.addFileRowsWithConfigs = function (fileInfoFieldPath, configs) {
        var attachmentInfos = this.getAttachmentInfosToAddFromContext();
        if (attachmentInfos.length === 0) {
            this.notifyService.info('请先上传附件');
        }
        // let mapFields = null;
        // if (typeof configs === 'string') {
        //   // 去掉首尾空格
        //   configs = configs.trim();
        // }
        // if (configs.startsWith('{') && configs.endsWith('}')) {
        //   try {
        //     mapFields = JSON.parse(configs);
        //   } catch {
        //     throw new Error('附件扩展信息配置不是合法的json字符串。');
        //   }
        // } else {
        //   throw new Error('附件扩展信息配置不是合法的json字符串。');
        // }
        this.attachmentInfos = this.attachmentInfos.concat(attachmentInfos);
        this.subject.next({ fileInfoFieldPath: fileInfoFieldPath, configs: configs });
        //return this.attachDataService.updateRowsWithConfigs(fileInfoFieldPath, attachmentInfos, mapFields);
    };
    FileService.prototype.process = function (fileInfoFieldPath, configs) {
        var _this = this;
        if (this.attachmentInfos && this.attachmentInfos.length > 0) {
            var attachmentInfos_1 = this.attachmentInfos.concat([]);
            var mapFields = null;
            if (typeof configs === 'string') {
                // 去掉首尾空格
                configs = configs.trim();
            }
            if (configs.startsWith('{') && configs.endsWith('}')) {
                try {
                    mapFields = JSON.parse(configs);
                }
                catch (_a) {
                    throw new Error('附件扩展信息配置不是合法的json字符串。');
                }
            }
            else {
                throw new Error('附件扩展信息配置不是合法的json字符串。');
            }
            this.attachDataService.updateRowsWithConfigs(fileInfoFieldPath, attachmentInfos_1, mapFields).pipe(tap(function () {
                _this.attachmentInfos = _this.attachmentInfos.filter(function (item) { return !attachmentInfos_1.find(function (attachmentInfo) { return attachmentInfo.attachmentId === item.attachmentId; }); });
                if (_this.attachmentInfos.length > 0) {
                    _this.process(fileInfoFieldPath, configs);
                }
            })).subscribe();
        }
    };
    /**
     * 获取要添加的附件信息数组
     */
    FileService.prototype.getAttachmentInfosToAddFromContext = function () {
        var fileExtends = this.getFileExtendsFromContext();
        var attachmentInfos = this.convertToAttachmentInfos(fileExtends);
        return attachmentInfos;
    };
    /**
     * 将附件上传组件返回的附件信息转换为服务器端需要的格式
     */
    FileService.prototype.convertToAttachmentInfos = function (fileExtends) {
        if (!fileExtends) {
            return [];
        }
        var attachmentInfos = [];
        fileExtends.forEach(function (fUploadOutPut) {
            var attachmentInfo = {
                attachmentId: fUploadOutPut.extend.metadataId,
                fileName: fUploadOutPut.extend.fileName,
            };
            attachmentInfos.push(attachmentInfo);
        });
        return attachmentInfos;
    };
    // #endregion
    // #region 删除文件
    /**
     * 删除附件行
     */
    FileService.prototype.removeFileRows = function (fileInfoFieldPath) {
        var _this = this;
        var dataIds = this.getDataIdsToRemoveFromContext(fileInfoFieldPath);
        if (dataIds.length === 0) {
            this.notifyService.info('请选择要删除的附件');
        }
        var isSublist = fileInfoFieldPath.split('/').filter(function (p) { return p; }).length >= 2;
        var removeObservables = [];
        if (isSublist) {
            dataIds.forEach(function (dataId) {
                var removeObservable;
                removeObservable = _this.subListDataService.removeWithoutConfirm(dataId);
                removeObservables.push(removeObservable);
            });
            return forkJoin(removeObservables);
        }
        else {
            return this.listDataService.removeRows(dataIds, false, null, false);
        }
    };
    /**
     * 获取要删除的数据
     */
    FileService.prototype.getDataIdsToRemoveFromContext = function (fileExtendFieldPath) {
        var _this = this;
        // 从上下文中获取要处理的附件信息数组
        var fileExtends = this.getFileExtendsFromContext();
        // 将附件数组转换为对应的数据id
        var dataIds = [];
        fileExtends.forEach(function (fileExtend) {
            // 上传删除和预览删除传递过来的fileId的key可能不一致，要做兼容
            var fileId = fileExtend.extend.metadataId;
            var dataId = _this.convertFileIdToDataId(fileId, fileExtendFieldPath);
            dataIds.push(dataId);
        });
        return dataIds;
    };
    /**
     * 根据路径获取附件字段值数组
     * @param fieldPath 字段路径
     */
    FileService.prototype.convertFileIdToDataId = function (fileId, fileExtendFieldPath) {
        // 解析路径
        var fileBindingPath = BindingPathConverter.toBindingPathArray(fileExtendFieldPath);
        var fileFieldName = fileBindingPath.pop();
        var fileListBindingPath = fileBindingPath;
        // 获取附件id数组
        var entityListData = this.entityService.getEntityListData(fileListBindingPath);
        var targetEntityData = entityListData.find(function (entityData) {
            if (entityData[fileFieldName]) {
                var attachmentId = entityData[fileFieldName]['attachmentId'];
                if (attachmentId === fileId) {
                    return true;
                }
            }
        });
        return targetEntityData.id;
    };
    // #endregion
    //#region 文件排序
    /**
     * 更新附件排序
     * @param attachmentInfoFieldPath 附件udt字段路径
     * @param ids 附件排序后的附件id数组
     */
    FileService.prototype.updateOrder = function (attachmentInfoFieldPath, ids) {
        if (!attachmentInfoFieldPath) {
            throw new Error('附件udt字段路径参数不能为空');
        }
        // 支持从代码中直接调用，如果参数中传递了ids则使用，否则使用命令上下文中的事件参数
        if (!ids) {
            // 获取事件参数
            var commandContext = this['context'];
            // 与组件约定事件参数为数据主键数组
            ids = commandContext && commandContext.eventParam && commandContext.eventParam.data;
        }
        // 对收集的主键数组进行判断
        if (!ids || !Array.isArray(ids)) {
            return;
        }
        // 当前命令所在组件的绑定数据
        var bindingList = this.frameContext.bindingData.getList();
        // 无绑定数据时不处理
        if (!bindingList || bindingList.length < 1) {
            return;
        }
        // 统一获取附件udt信息
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        var attachmentField = parentBindingPathArray.pop();
        // 出现udt字段不存在的情况，说明命令中附件udt字段配置错误或vo中没有附件udt。控制器不兼容错误，此处判断只为阻止后续的遍历
        if (!attachmentField) {
            throw new Error('无法获取附件udt字段，请确认命令中附件udt字段路径配置正确，且视图模型中存在附件udt字段');
        }
        var data = bindingList.toJSON();
        // 更新绑定数据中附件udt字段中排序字段的值,仅更新有附件的行
        ids.forEach(function (id, index) {
            var item = data.find(function (item) { return item && item[attachmentField] && item[attachmentField]['attachmentId'] === id; });
            var primaryKeyValue = item && item.id;
            if (!primaryKeyValue) {
                return;
            }
            var bindingObject = bindingList.findById(primaryKeyValue);
            if (bindingObject) {
                // 附件udt对象
                var attachment = bindingObject[attachmentField];
                if (attachment) {
                    // 获取旧值
                    var order = attachment.getValue(ATTACHMENT_ORDER_FIELD);
                    if (order !== index) {
                        // 更新排序
                        attachment.setValue(ATTACHMENT_ORDER_FIELD, index, true, true);
                    }
                }
            }
        });
    };
    //#endregion
    // #region 其他工具方法
    /**
     * 从上下文中获取要处理的附件信息数组
     * @summary
     * 为了统一单个和多个附件的处理方式，统一包装为数组
     */
    FileService.prototype.getFileExtendsFromContext = function () {
        var commandContext = this['context'];
        var eventParam = commandContext.eventParam;
        if (!eventParam) {
            return [];
        }
        var fileExtends;
        if (Array.isArray(eventParam) === false) {
            fileExtends = [eventParam];
        }
        else {
            fileExtends = eventParam.concat([]);
        }
        return fileExtends;
    };
    FileService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    FileService.ctorParameters = function () { return [
        { type: FrameContext },
        { type: AttachmentDataService },
        { type: EntityService },
        { type: SubListDataService },
        { type: FormNotifyService },
        { type: LanguageService },
        { type: ListDataService },
        { type: FormLoadingService, decorators: [{ type: Optional }] }
    ]; };
    return FileService;
}());
export { FileService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2F0dGFjaG1lbnQvZmlsZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBYyxRQUFRLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRXJELE9BQU8sRUFBRSxZQUFZLEVBQWtCLG9CQUFvQixFQUE4QixNQUFNLGdCQUFnQixDQUFDO0FBQ2hILE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzNELE9BQU8sRUFBa0Isc0JBQXNCLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDakUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDbEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsZUFBZSxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDN0UsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDMUUsT0FBTyxFQUFFLFlBQVksRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVuRDs7Ozs7O0dBTUc7QUFDSDtJQUlFOztPQUVHO0lBQ0gscUJBQ1UsWUFBMEIsRUFDMUIsaUJBQXdDLEVBQ3hDLGFBQTRCLEVBQzVCLGtCQUFzQyxFQUN0QyxhQUFnQyxFQUNoQyxlQUFnQyxFQUNoQyxlQUFnQyxFQUNwQixrQkFBc0M7UUFSNUQsaUJBZUM7UUFkUyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQXVCO1FBQ3hDLGtCQUFh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LEVBQUU7WUFDZixPQUFPLEVBQUUsQ0FBQztTQUNYO1FBRUQsSUFBSSxXQUFrQixDQUFDO1FBQ3ZCLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsS0FBSyxLQUFLLEVBQUU7WUFDdkMsV0FBVyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDNUI7YUFBTTtZQUNMLFdBQVcsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ3JDO1FBRUQsT0FBTyxXQUFrQyxDQUFDO0lBQzVDLENBQUM7O2dCQXJSRixVQUFVOzs7O2dCQWpCRixZQUFZO2dCQUdaLHFCQUFxQjtnQkFFckIsYUFBYTtnQkFDSSxrQkFBa0I7Z0JBTG5DLGlCQUFpQjtnQkFHakIsZUFBZTtnQkFFZixlQUFlO2dCQUNmLGtCQUFrQix1QkF5QnRCLFFBQVE7O0lBd1FiLGtCQUFDO0NBQUEsQUF2UkQsSUF1UkM7QUFFRCxPQUFPLEVBQUUsV0FBVyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBmb3JrSm9pbiwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBGVXBsb2FkRmlsZUV4dGVuZCB9IGZyb20gJ0BmYXJyaXMvZXh0ZW5kLWZpbGUtdXBsb2FkJztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0LCBDb21tYW5kQ29udGV4dCwgQmluZGluZ1BhdGhDb252ZXJ0ZXIsIEJpbmRpbmdMaXN0LCBCaW5kaW5nT2JqZWN0IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBGb3JtTm90aWZ5U2VydmljZSB9IGZyb20gJy4uL2Zvcm0tbm90aWZ5LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBBdHRhY2htZW50SW5mbywgQVRUQUNITUVOVF9PUkRFUl9GSUVMRCB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBBdHRhY2htZW50RGF0YVNlcnZpY2UgfSBmcm9tICcuL2F0dGFjaG1lbnQtZGF0YS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vbGFuZ3VhZy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRW50aXR5U2VydmljZSB9IGZyb20gJy4uL2VudGl0eS1zZXJ2aWNlcy9pbmRleCc7XHJcbmltcG9ydCB7IExpc3REYXRhU2VydmljZSwgU3ViTGlzdERhdGFTZXJ2aWNlIH0gZnJvbSAnLi4vZGF0YS1zZXJ2aWNlcy9pbmRleCc7XHJcbmltcG9ydCB7IEZvcm1Mb2FkaW5nU2VydmljZSB9IGZyb20gJy4uL2Zvcm0tbG9hZGluZy9mb3JtLWxvYWRpbmcuc2VydmljZSc7XHJcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuLyoqXHJcbiAqIOmZhOS7tuS4iuS8oFxyXG4gKiBAc3VtbWFyeVxyXG4gKiBmaWxlRXh0ZW5k77ya5ZG95ZCN5paH5Lu25LiK5Lyg5oiW6aKE6KeI57uE5Lu25Lyg6YCS6L+H5p2l55qE5pWw5o2u77ybXHJcbiAqIGZpbGVFeHRlbmRGaWVsZFBhdGjvvJrlkb3lkI3pmYTku7ZVRFTnmoTlrZfmrrXot6/lvoTvvJtcclxuICogYXR0YWNobWVudEluZm/vvJrlkb3lkI3pmYTku7ZVRFTmiYDpnIDnmoTkv6Hmga/vvJtcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuY2xhc3MgRmlsZVNlcnZpY2Uge1xyXG4gIHByaXZhdGUgc3ViamVjdDogU3ViamVjdDx7IGZpbGVJbmZvRmllbGRQYXRoOiBzdHJpbmcsIGNvbmZpZ3M6IHN0cmluZyB9PjtcclxuICBwcml2YXRlIGF0dGFjaG1lbnRJbmZvczogQXR0YWNobWVudEluZm9bXTtcclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXHJcbiAgICBwcml2YXRlIGF0dGFjaERhdGFTZXJ2aWNlOiBBdHRhY2htZW50RGF0YVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGVudGl0eVNlcnZpY2U6IEVudGl0eVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHN1Ykxpc3REYXRhU2VydmljZTogU3ViTGlzdERhdGFTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBub3RpZnlTZXJ2aWNlOiBGb3JtTm90aWZ5U2VydmljZSxcclxuICAgIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGxpc3REYXRhU2VydmljZTogTGlzdERhdGFTZXJ2aWNlLFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBmb3JtTG9hZGluZ1NlcnZpY2U6IEZvcm1Mb2FkaW5nU2VydmljZVxyXG4gICkge1xyXG4gICAgdGhpcy5zdWJqZWN0ID0gbmV3IFN1YmplY3Q8eyBmaWxlSW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBjb25maWdzOiBzdHJpbmcgfT4oKTtcclxuICAgIHRoaXMuc3ViamVjdC5waXBlKGRlYm91bmNlVGltZSg1MDApKS5zdWJzY3JpYmUoKGRhdGE6IHsgZmlsZUluZm9GaWVsZFBhdGg6IHN0cmluZywgY29uZmlnczogc3RyaW5nIH0pID0+IHtcclxuICAgICAgdGhpcy5wcm9jZXNzKGRhdGEuZmlsZUluZm9GaWVsZFBhdGgsIGRhdGEuY29uZmlncyk7XHJcbiAgICB9KTtcclxuICAgIHRoaXMuYXR0YWNobWVudEluZm9zID0gW107XHJcbiAgfVxyXG5cclxuICAvLyAjcmVnaW9uIOS4iuS8oOaWh+S7tlxyXG5cclxuICAvKipcclxuICAgKiDmibnph4/mt7vliqDpmYTku7booYxcclxuICAgKi9cclxuICBwdWJsaWMgYWRkRmlsZVJvd3MoZmlsZUluZm9GaWVsZFBhdGg6IHN0cmluZykge1xyXG4gICAgY29uc3QgYXR0YWNobWVudEluZm9zID0gdGhpcy5nZXRBdHRhY2htZW50SW5mb3NUb0FkZEZyb21Db250ZXh0KCk7XHJcbiAgICBpZiAoYXR0YWNobWVudEluZm9zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2UuaW5mbygn6K+35YWI5LiK5Lyg6ZmE5Lu2Jyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5hdHRhY2hEYXRhU2VydmljZS51cGRhdGVSb3dzKGZpbGVJbmZvRmllbGRQYXRoLCBhdHRhY2htZW50SW5mb3MpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmibnph4/mt7vliqDluKbpmYTku7bnsbvlnovnmoTpmYTku7booYxcclxuICAgKiBAcGFyYW0gZmlsZUluZm9GaWVsZFBhdGgg6ZmE5Lu2dWR05a2X5q61XHJcbiAgICogQHBhcmFtIGNvbmZpZ3Mg6ZmE5Lu25omp5bGV5L+h5oGv6YWN572uIFxyXG4gICAqIEBkZXNjcmlwdGlvbiBjb25maWdz6YWN572u5aaCe1wiYmlsbElkXCI6XCJ7VUlTVEFURX4vcm9vdC9iaWxsSWR9XCIsXCJyb3dJZFwiOlwie1VJU1RBVEV+L3Jvb3Qvcm93SWR9XCIsXCJhdHRhY2htZW50VHlwZVwiOlwieHVlbGlcIn1cclxuICAgKi9cclxuICBwdWJsaWMgYWRkRmlsZVJvd3NXaXRoQ29uZmlncyhmaWxlSW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBjb25maWdzOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGF0dGFjaG1lbnRJbmZvcyA9IHRoaXMuZ2V0QXR0YWNobWVudEluZm9zVG9BZGRGcm9tQ29udGV4dCgpO1xyXG4gICAgaWYgKGF0dGFjaG1lbnRJbmZvcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLmluZm8oJ+ivt+WFiOS4iuS8oOmZhOS7ticpO1xyXG4gICAgfVxyXG4gICAgLy8gbGV0IG1hcEZpZWxkcyA9IG51bGw7XHJcbiAgICAvLyBpZiAodHlwZW9mIGNvbmZpZ3MgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAvLyAgIC8vIOWOu+aOiemmluWwvuepuuagvFxyXG4gICAgLy8gICBjb25maWdzID0gY29uZmlncy50cmltKCk7XHJcbiAgICAvLyB9XHJcbiAgICAvLyBpZiAoY29uZmlncy5zdGFydHNXaXRoKCd7JykgJiYgY29uZmlncy5lbmRzV2l0aCgnfScpKSB7XHJcbiAgICAvLyAgIHRyeSB7XHJcbiAgICAvLyAgICAgbWFwRmllbGRzID0gSlNPTi5wYXJzZShjb25maWdzKTtcclxuICAgIC8vICAgfSBjYXRjaCB7XHJcbiAgICAvLyAgICAgdGhyb3cgbmV3IEVycm9yKCfpmYTku7bmianlsZXkv6Hmga/phY3nva7kuI3mmK/lkIjms5XnmoRqc29u5a2X56ym5Liy44CCJyk7XHJcbiAgICAvLyAgIH1cclxuICAgIC8vIH0gZWxzZSB7XHJcbiAgICAvLyAgIHRocm93IG5ldyBFcnJvcign6ZmE5Lu25omp5bGV5L+h5oGv6YWN572u5LiN5piv5ZCI5rOV55qEanNvbuWtl+espuS4suOAgicpO1xyXG4gICAgLy8gfVxyXG4gICAgdGhpcy5hdHRhY2htZW50SW5mb3MgPSB0aGlzLmF0dGFjaG1lbnRJbmZvcy5jb25jYXQoYXR0YWNobWVudEluZm9zKTtcclxuICAgIHRoaXMuc3ViamVjdC5uZXh0KHsgZmlsZUluZm9GaWVsZFBhdGgsIGNvbmZpZ3MgfSk7XHJcbiAgICAvL3JldHVybiB0aGlzLmF0dGFjaERhdGFTZXJ2aWNlLnVwZGF0ZVJvd3NXaXRoQ29uZmlncyhmaWxlSW5mb0ZpZWxkUGF0aCwgYXR0YWNobWVudEluZm9zLCBtYXBGaWVsZHMpO1xyXG4gIH1cclxuICBwcml2YXRlIHByb2Nlc3MoZmlsZUluZm9GaWVsZFBhdGg6IHN0cmluZywgY29uZmlnczogc3RyaW5nKSB7XHJcbiAgICBpZiAodGhpcy5hdHRhY2htZW50SW5mb3MgJiYgdGhpcy5hdHRhY2htZW50SW5mb3MubGVuZ3RoID4gMCkge1xyXG4gICAgICBjb25zdCBhdHRhY2htZW50SW5mb3MgPSB0aGlzLmF0dGFjaG1lbnRJbmZvcy5jb25jYXQoW10pO1xyXG4gICAgICBsZXQgbWFwRmllbGRzID0gbnVsbDtcclxuICAgICAgaWYgKHR5cGVvZiBjb25maWdzID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgIC8vIOWOu+aOiemmluWwvuepuuagvFxyXG4gICAgICAgIGNvbmZpZ3MgPSBjb25maWdzLnRyaW0oKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoY29uZmlncy5zdGFydHNXaXRoKCd7JykgJiYgY29uZmlncy5lbmRzV2l0aCgnfScpKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIG1hcEZpZWxkcyA9IEpTT04ucGFyc2UoY29uZmlncyk7XHJcbiAgICAgICAgfSBjYXRjaCB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ+mZhOS7tuaJqeWxleS/oeaBr+mFjee9ruS4jeaYr+WQiOazleeahGpzb27lrZfnrKbkuLLjgIInKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCfpmYTku7bmianlsZXkv6Hmga/phY3nva7kuI3mmK/lkIjms5XnmoRqc29u5a2X56ym5Liy44CCJyk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5hdHRhY2hEYXRhU2VydmljZS51cGRhdGVSb3dzV2l0aENvbmZpZ3MoZmlsZUluZm9GaWVsZFBhdGgsIGF0dGFjaG1lbnRJbmZvcywgbWFwRmllbGRzKS5waXBlKFxyXG4gICAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmF0dGFjaG1lbnRJbmZvcyA9IHRoaXMuYXR0YWNobWVudEluZm9zLmZpbHRlcihpdGVtID0+ICFhdHRhY2htZW50SW5mb3MuZmluZChhdHRhY2htZW50SW5mbyA9PiBhdHRhY2htZW50SW5mby5hdHRhY2htZW50SWQgPT09IGl0ZW0uYXR0YWNobWVudElkKSk7XHJcbiAgICAgICAgICBpZiAodGhpcy5hdHRhY2htZW50SW5mb3MubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICB0aGlzLnByb2Nlc3MoZmlsZUluZm9GaWVsZFBhdGgsIGNvbmZpZ3MpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgICkuc3Vic2NyaWJlKCk7XHJcbiAgICB9XHJcblxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W6KaB5re75Yqg55qE6ZmE5Lu25L+h5oGv5pWw57uEXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRBdHRhY2htZW50SW5mb3NUb0FkZEZyb21Db250ZXh0KCk6IEF0dGFjaG1lbnRJbmZvW10ge1xyXG4gICAgY29uc3QgZmlsZUV4dGVuZHMgPSB0aGlzLmdldEZpbGVFeHRlbmRzRnJvbUNvbnRleHQoKTtcclxuICAgIGNvbnN0IGF0dGFjaG1lbnRJbmZvcyA9IHRoaXMuY29udmVydFRvQXR0YWNobWVudEluZm9zKGZpbGVFeHRlbmRzKTtcclxuICAgIHJldHVybiBhdHRhY2htZW50SW5mb3M7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlsIbpmYTku7bkuIrkvKDnu4Tku7bov5Tlm57nmoTpmYTku7bkv6Hmga/ovazmjaLkuLrmnI3liqHlmajnq6/pnIDopoHnmoTmoLzlvI9cclxuICAgKi9cclxuICBwcml2YXRlIGNvbnZlcnRUb0F0dGFjaG1lbnRJbmZvcyhmaWxlRXh0ZW5kczogRlVwbG9hZEZpbGVFeHRlbmRbXSk6IEF0dGFjaG1lbnRJbmZvW10ge1xyXG4gICAgaWYgKCFmaWxlRXh0ZW5kcykge1xyXG4gICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgYXR0YWNobWVudEluZm9zOiBBdHRhY2htZW50SW5mb1tdID0gW107XHJcbiAgICBmaWxlRXh0ZW5kcy5mb3JFYWNoKChmVXBsb2FkT3V0UHV0OiBGVXBsb2FkRmlsZUV4dGVuZCkgPT4ge1xyXG4gICAgICBjb25zdCBhdHRhY2htZW50SW5mbzogQXR0YWNobWVudEluZm8gPSB7XHJcbiAgICAgICAgYXR0YWNobWVudElkOiBmVXBsb2FkT3V0UHV0LmV4dGVuZC5tZXRhZGF0YUlkLFxyXG4gICAgICAgIGZpbGVOYW1lOiBmVXBsb2FkT3V0UHV0LmV4dGVuZC5maWxlTmFtZSxcclxuICAgICAgfTtcclxuICAgICAgYXR0YWNobWVudEluZm9zLnB1c2goYXR0YWNobWVudEluZm8pO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gYXR0YWNobWVudEluZm9zO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLy8gI3JlZ2lvbiDliKDpmaTmlofku7ZcclxuXHJcbiAgLyoqXHJcbiAgICog5Yig6Zmk6ZmE5Lu26KGMXHJcbiAgICovXHJcbiAgcHVibGljIHJlbW92ZUZpbGVSb3dzKGZpbGVJbmZvRmllbGRQYXRoOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3QgZGF0YUlkcyA9IHRoaXMuZ2V0RGF0YUlkc1RvUmVtb3ZlRnJvbUNvbnRleHQoZmlsZUluZm9GaWVsZFBhdGgpO1xyXG4gICAgaWYgKGRhdGFJZHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS5pbmZvKCfor7fpgInmi6nopoHliKDpmaTnmoTpmYTku7YnKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGlzU3VibGlzdCA9IGZpbGVJbmZvRmllbGRQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkubGVuZ3RoID49IDI7XHJcbiAgICBjb25zdCByZW1vdmVPYnNlcnZhYmxlczogT2JzZXJ2YWJsZTxhbnk+W10gPSBbXTtcclxuICAgIGlmIChpc1N1Ymxpc3QpIHtcclxuICAgICAgZGF0YUlkcy5mb3JFYWNoKChkYXRhSWQ6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGxldCByZW1vdmVPYnNlcnZhYmxlO1xyXG4gICAgICAgIHJlbW92ZU9ic2VydmFibGUgPSB0aGlzLnN1Ykxpc3REYXRhU2VydmljZS5yZW1vdmVXaXRob3V0Q29uZmlybShkYXRhSWQpO1xyXG4gICAgICAgIHJlbW92ZU9ic2VydmFibGVzLnB1c2gocmVtb3ZlT2JzZXJ2YWJsZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gZm9ya0pvaW4ocmVtb3ZlT2JzZXJ2YWJsZXMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHRoaXMubGlzdERhdGFTZXJ2aWNlLnJlbW92ZVJvd3MoZGF0YUlkcywgZmFsc2UsIG51bGwsIGZhbHNlKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluimgeWIoOmZpOeahOaVsOaNrlxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RGF0YUlkc1RvUmVtb3ZlRnJvbUNvbnRleHQoZmlsZUV4dGVuZEZpZWxkUGF0aDogc3RyaW5nKTogc3RyaW5nW10ge1xyXG5cclxuICAgIC8vIOS7juS4iuS4i+aWh+S4reiOt+WPluimgeWkhOeQhueahOmZhOS7tuS/oeaBr+aVsOe7hFxyXG4gICAgY29uc3QgZmlsZUV4dGVuZHMgPSB0aGlzLmdldEZpbGVFeHRlbmRzRnJvbUNvbnRleHQoKTtcclxuXHJcbiAgICAvLyDlsIbpmYTku7bmlbDnu4TovazmjaLkuLrlr7nlupTnmoTmlbDmja5pZFxyXG4gICAgY29uc3QgZGF0YUlkczogc3RyaW5nW10gPSBbXTtcclxuICAgIGZpbGVFeHRlbmRzLmZvckVhY2goKGZpbGVFeHRlbmQ6IEZVcGxvYWRGaWxlRXh0ZW5kKSA9PiB7XHJcblxyXG4gICAgICAvLyDkuIrkvKDliKDpmaTlkozpooTop4jliKDpmaTkvKDpgJLov4fmnaXnmoRmaWxlSWTnmoRrZXnlj6/og73kuI3kuIDoh7TvvIzopoHlgZrlhbzlrrlcclxuICAgICAgY29uc3QgZmlsZUlkID0gZmlsZUV4dGVuZC5leHRlbmQubWV0YWRhdGFJZDtcclxuICAgICAgY29uc3QgZGF0YUlkID0gdGhpcy5jb252ZXJ0RmlsZUlkVG9EYXRhSWQoZmlsZUlkLCBmaWxlRXh0ZW5kRmllbGRQYXRoKTtcclxuICAgICAgZGF0YUlkcy5wdXNoKGRhdGFJZCk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBkYXRhSWRzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2u6Lev5b6E6I635Y+W6ZmE5Lu25a2X5q615YC85pWw57uEXHJcbiAgICogQHBhcmFtIGZpZWxkUGF0aCDlrZfmrrXot6/lvoRcclxuICAgKi9cclxuICBwcml2YXRlIGNvbnZlcnRGaWxlSWRUb0RhdGFJZChmaWxlSWQ6IHN0cmluZywgZmlsZUV4dGVuZEZpZWxkUGF0aDogc3RyaW5nKTogc3RyaW5nIHtcclxuXHJcbiAgICAvLyDop6PmnpDot6/lvoRcclxuICAgIGNvbnN0IGZpbGVCaW5kaW5nUGF0aCA9IEJpbmRpbmdQYXRoQ29udmVydGVyLnRvQmluZGluZ1BhdGhBcnJheShmaWxlRXh0ZW5kRmllbGRQYXRoKTtcclxuICAgIGNvbnN0IGZpbGVGaWVsZE5hbWUgPSBmaWxlQmluZGluZ1BhdGgucG9wKCk7XHJcbiAgICBjb25zdCBmaWxlTGlzdEJpbmRpbmdQYXRoID0gZmlsZUJpbmRpbmdQYXRoO1xyXG5cclxuICAgIC8vIOiOt+WPlumZhOS7tmlk5pWw57uEXHJcbiAgICBjb25zdCBlbnRpdHlMaXN0RGF0YSA9IHRoaXMuZW50aXR5U2VydmljZS5nZXRFbnRpdHlMaXN0RGF0YShmaWxlTGlzdEJpbmRpbmdQYXRoKTtcclxuICAgIGNvbnN0IHRhcmdldEVudGl0eURhdGEgPSBlbnRpdHlMaXN0RGF0YS5maW5kKChlbnRpdHlEYXRhOiBhbnkpID0+IHtcclxuICAgICAgaWYgKGVudGl0eURhdGFbZmlsZUZpZWxkTmFtZV0pIHtcclxuICAgICAgICBjb25zdCBhdHRhY2htZW50SWQgPSBlbnRpdHlEYXRhW2ZpbGVGaWVsZE5hbWVdWydhdHRhY2htZW50SWQnXTtcclxuICAgICAgICBpZiAoYXR0YWNobWVudElkID09PSBmaWxlSWQpIHtcclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHRhcmdldEVudGl0eURhdGEuaWQ7XHJcbiAgfVxyXG5cclxuICAvLyAjZW5kcmVnaW9uXHJcbiAgLy8jcmVnaW9uIOaWh+S7tuaOkuW6j1xyXG4gIC8qKlxyXG4gICAqIOabtOaWsOmZhOS7tuaOkuW6j1xyXG4gICAqIEBwYXJhbSBhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCDpmYTku7Z1ZHTlrZfmrrXot6/lvoRcclxuICAgKiBAcGFyYW0gaWRzIOmZhOS7tuaOkuW6j+WQjueahOmZhOS7tmlk5pWw57uEXHJcbiAgICovXHJcbiAgcHVibGljIHVwZGF0ZU9yZGVyKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIGlkczogc3RyaW5nW10pIHtcclxuICAgIGlmICghYXR0YWNobWVudEluZm9GaWVsZFBhdGgpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCfpmYTku7Z1ZHTlrZfmrrXot6/lvoTlj4LmlbDkuI3og73kuLrnqbonKTtcclxuICAgIH1cclxuICAgIC8vIOaUr+aMgeS7juS7o+eggeS4reebtOaOpeiwg+eUqO+8jOWmguaenOWPguaVsOS4reS8oOmAkuS6hmlkc+WImeS9v+eUqO+8jOWQpuWImeS9v+eUqOWRveS7pOS4iuS4i+aWh+S4reeahOS6i+S7tuWPguaVsFxyXG4gICAgaWYgKCFpZHMpIHtcclxuICAgICAgLy8g6I635Y+W5LqL5Lu25Y+C5pWwXHJcbiAgICAgIGNvbnN0IGNvbW1hbmRDb250ZXh0ID0gdGhpc1snY29udGV4dCddIGFzIENvbW1hbmRDb250ZXh0O1xyXG4gICAgICAvLyDkuI7nu4Tku7bnuqblrprkuovku7blj4LmlbDkuLrmlbDmja7kuLvplK7mlbDnu4RcclxuICAgICAgaWRzID0gY29tbWFuZENvbnRleHQgJiYgY29tbWFuZENvbnRleHQuZXZlbnRQYXJhbSAmJiBjb21tYW5kQ29udGV4dC5ldmVudFBhcmFtLmRhdGE7XHJcbiAgICB9XHJcbiAgICAvLyDlr7nmlLbpm4bnmoTkuLvplK7mlbDnu4Tov5vooYzliKTmlq1cclxuICAgIGlmICghaWRzIHx8ICFBcnJheS5pc0FycmF5KGlkcykpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgLy8g5b2T5YmN5ZG95Luk5omA5Zyo57uE5Lu255qE57uR5a6a5pWw5o2uXHJcbiAgICBjb25zdCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRMaXN0KCk7XHJcbiAgICAvLyDml6Dnu5HlrprmlbDmja7ml7bkuI3lpITnkIZcclxuICAgIGlmICghYmluZGluZ0xpc3QgfHwgYmluZGluZ0xpc3QubGVuZ3RoIDwgMSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDnu5/kuIDojrflj5bpmYTku7Z1ZHTkv6Hmga9cclxuICAgIGNvbnN0IHBhcmVudEJpbmRpbmdQYXRoQXJyYXkgPSBCaW5kaW5nUGF0aENvbnZlcnRlci50b0JpbmRpbmdQYXRoQXJyYXkoYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xyXG4gICAgY29uc3QgYXR0YWNobWVudEZpZWxkID0gcGFyZW50QmluZGluZ1BhdGhBcnJheS5wb3AoKTtcclxuICAgIC8vIOWHuueOsHVkdOWtl+auteS4jeWtmOWcqOeahOaDheWGte+8jOivtOaYjuWRveS7pOS4remZhOS7tnVkdOWtl+autemFjee9rumUmeivr+aIlnZv5Lit5rKh5pyJ6ZmE5Lu2dWR044CC5o6n5Yi25Zmo5LiN5YW85a656ZSZ6K+v77yM5q2k5aSE5Yik5pat5Y+q5Li66Zi75q2i5ZCO57ut55qE6YGN5Y6GXHJcbiAgICBpZiAoIWF0dGFjaG1lbnRGaWVsZCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ+aXoOazleiOt+WPlumZhOS7tnVkdOWtl+aute+8jOivt+ehruiupOWRveS7pOS4remZhOS7tnVkdOWtl+autei3r+W+hOmFjee9ruato+ehru+8jOS4lOinhuWbvuaooeWei+S4reWtmOWcqOmZhOS7tnVkdOWtl+autScpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZGF0YSA9IGJpbmRpbmdMaXN0LnRvSlNPTigpO1xyXG4gICAgLy8g5pu05paw57uR5a6a5pWw5o2u5Lit6ZmE5Lu2dWR05a2X5q615Lit5o6S5bqP5a2X5q6155qE5YC8LOS7heabtOaWsOaciemZhOS7tueahOihjFxyXG4gICAgaWRzLmZvckVhY2goKGlkOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgY29uc3QgaXRlbSA9IGRhdGEuZmluZChpdGVtID0+IGl0ZW0gJiYgaXRlbVthdHRhY2htZW50RmllbGRdICYmIGl0ZW1bYXR0YWNobWVudEZpZWxkXVsnYXR0YWNobWVudElkJ10gPT09IGlkKTtcclxuICAgICAgY29uc3QgcHJpbWFyeUtleVZhbHVlID0gaXRlbSAmJiBpdGVtLmlkO1xyXG4gICAgICBpZiAoIXByaW1hcnlLZXlWYWx1ZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gYmluZGluZ0xpc3QuZmluZEJ5SWQocHJpbWFyeUtleVZhbHVlKTtcclxuICAgICAgaWYgKGJpbmRpbmdPYmplY3QpIHtcclxuICAgICAgICAvLyDpmYTku7Z1ZHTlr7nosaFcclxuICAgICAgICBjb25zdCBhdHRhY2htZW50ID0gYmluZGluZ09iamVjdFthdHRhY2htZW50RmllbGRdIGFzIEJpbmRpbmdPYmplY3Q7XHJcbiAgICAgICAgaWYgKGF0dGFjaG1lbnQpIHtcclxuICAgICAgICAgIC8vIOiOt+WPluaXp+WAvFxyXG4gICAgICAgICAgY29uc3Qgb3JkZXIgPSBhdHRhY2htZW50LmdldFZhbHVlKEFUVEFDSE1FTlRfT1JERVJfRklFTEQpO1xyXG4gICAgICAgICAgaWYgKG9yZGVyICE9PSBpbmRleCkge1xyXG4gICAgICAgICAgICAvLyDmm7TmlrDmjpLluo9cclxuICAgICAgICAgICAgYXR0YWNobWVudC5zZXRWYWx1ZShBVFRBQ0hNRU5UX09SREVSX0ZJRUxELCBpbmRleCwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLy8jZW5kcmVnaW9uXHJcblxyXG4gIC8vICNyZWdpb24g5YW25LuW5bel5YW35pa55rOVXHJcblxyXG4gIC8qKlxyXG4gICAqIOS7juS4iuS4i+aWh+S4reiOt+WPluimgeWkhOeQhueahOmZhOS7tuS/oeaBr+aVsOe7hFxyXG4gICAqIEBzdW1tYXJ5XHJcbiAgICog5Li65LqG57uf5LiA5Y2V5Liq5ZKM5aSa5Liq6ZmE5Lu255qE5aSE55CG5pa55byP77yM57uf5LiA5YyF6KOF5Li65pWw57uEXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRGaWxlRXh0ZW5kc0Zyb21Db250ZXh0KCk6IEZVcGxvYWRGaWxlRXh0ZW5kW10ge1xyXG5cclxuICAgIGNvbnN0IGNvbW1hbmRDb250ZXh0ID0gdGhpc1snY29udGV4dCddIGFzIENvbW1hbmRDb250ZXh0O1xyXG4gICAgY29uc3QgZXZlbnRQYXJhbSA9IGNvbW1hbmRDb250ZXh0LmV2ZW50UGFyYW07XHJcbiAgICBpZiAoIWV2ZW50UGFyYW0pIHtcclxuICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBmaWxlRXh0ZW5kczogYW55W107XHJcbiAgICBpZiAoQXJyYXkuaXNBcnJheShldmVudFBhcmFtKSA9PT0gZmFsc2UpIHtcclxuICAgICAgZmlsZUV4dGVuZHMgPSBbZXZlbnRQYXJhbV07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBmaWxlRXh0ZW5kcyA9IGV2ZW50UGFyYW0uY29uY2F0KFtdKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZmlsZUV4dGVuZHMgYXMgRlVwbG9hZEZpbGVFeHRlbmRbXTtcclxuICB9XHJcbiAgLy8gI2VuZHJlZ2lvblxyXG59XHJcblxyXG5leHBvcnQgeyBGaWxlU2VydmljZSB9O1xyXG4iXX0=