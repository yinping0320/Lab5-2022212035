import { Injectable, Optional } from '@angular/core';
import { LoadingService } from '@farris/ui-loading';
import { HideEventService } from './hide-event.service';
import { AppContext } from '@farris/devkit';
// tslint:disable: no-string-literal
/**
 * 加载提示Helper
 * 1、包装@farris/ui的LoadingService；
 * 2、提供针对表单的快捷方法；
 */
var FormLoadingService = /** @class */ (function () {
    /**
     * 强制显示，不能隐藏
     */
    /**
     * 构造函数
     * 注入@farris/ui的LoadingService
     */
    function FormLoadingService(loadingService, hideEventService, applicationContext) {
        var _this = this;
        this.loadingService = loadingService;
        this.hideEventService = hideEventService;
        this.applicationContext = applicationContext;
        /**
         * 延迟loading定时器
         */
        this.loadingTimerIds = [];
        if (hideEventService) {
            this.hideEventService.hideEvent.subscribe(function (result) {
                _this.hide();
            });
        }
    }
    FormLoadingService.prototype.setSuspend = function (flag) {
        FormLoadingService.isSuspend = flag;
    };
    /**
     * 显示加载中
     */
    FormLoadingService.prototype.show = function (configOrMessage) {
        if (FormLoadingService.isSuspend === true) {
            return;
        }
        if (this.loadingCmp) {
            this.loadingCmp.close();
            this.loadingCmp = null;
        }
        this.registerService();
        var loadingConfig = this.buildLoadingConfig(configOrMessage);
        this.loadingCmp = this.loadingService.show(loadingConfig);
        return this.loadingCmp;
    };
    /**
     * 延迟显示Loading
     */
    FormLoadingService.prototype.showLoadingWithDelay = function (delayTime, configOrMessage) {
        var _this = this;
        // this.show(configOrMessage);
        var timerId = setTimeout(function () {
            _this.show(configOrMessage);
        }, delayTime);
        this.loadingTimerIds.push(timerId);
        this.registerService();
        return timerId;
    };
    /**
     * 隐藏延迟的Loading
     */
    FormLoadingService.prototype.hideDelayLoading = function (timerIdToClear) {
        this.clearLoadingTimer(timerIdToClear);
        this.hide();
    };
    /**
     * 构造LoadingConfig
     * @param configOrMessage 配置对象或消息字符串
     */
    FormLoadingService.prototype.buildLoadingConfig = function (configOrMessage) {
        var loadingConfig;
        if (!!configOrMessage) {
            if (typeof configOrMessage === 'object') {
                loadingConfig = configOrMessage;
            }
            else {
                loadingConfig = { 'message': configOrMessage };
            }
        }
        else {
            loadingConfig = {};
        }
        if (!loadingConfig.hasOwnProperty('delay')) {
            loadingConfig.delay = 0;
        }
        return loadingConfig;
    };
    /**
     * 关闭所有loading
     */
    FormLoadingService.prototype.clearAll = function () {
        var _this = this;
        FormLoadingService.isSuspend = false;
        window.setTimeout(function () {
            _this.loadingService.clearAll();
        }, 350);
        this.loadingCmp = null;
        this.clearAllLoadingTimers();
        this.destroy();
    };
    /**
     * 清空Loading定时器
     */
    FormLoadingService.prototype.clearLoadingTimer = function (timerIdToClear) {
        clearTimeout(timerIdToClear);
        this.loadingTimerIds = this.loadingTimerIds.filter(function (timerId) {
            return timerId !== timerIdToClear;
        });
    };
    /**
     * 清空所有Loading定时器
     */
    FormLoadingService.prototype.clearAllLoadingTimers = function () {
        var _this = this;
        this.loadingTimerIds.forEach(function (timerId) {
            _this.clearLoadingTimer(timerId);
        });
    };
    /**
     * 隐藏加载中
     */
    FormLoadingService.prototype.hide = function () {
        if (!this.loadingCmp) {
            this.destroy();
            return;
        }
        if (FormLoadingService.isSuspend === true) {
            return;
        }
        this.loadingCmp.close();
        this.loadingCmp = null;
        this.destroy();
    };
    /**
     * 销毁loadingService
     */
    FormLoadingService.prototype.destroy = function () {
        if (FormLoadingService.isSuspend === true) {
            return;
        }
        var services = window['DEVKIT_LOADING_SERVICE'] || [];
        if (services && Array.isArray(services) && services.length > 0) {
            services.forEach(function (service) {
                if (service) {
                    service.clearAllLoadingTimers();
                    if (service.loadingCmp) {
                        service.loadingCmp.close();
                        service.loadingCmp = null;
                    }
                }
            });
        }
        window['DEVKIT_LOADING_SERVICE'] = [];
    };
    /**
     * 注册所有的LoadingService实例
     */
    FormLoadingService.prototype.registerService = function () {
        var services = window['DEVKIT_LOADING_SERVICE'] || [];
        services.push(this);
        window['DEVKIT_LOADING_SERVICE'] = services;
    };
    FormLoadingService.isSuspend = false;
    FormLoadingService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    FormLoadingService.ctorParameters = function () { return [
        { type: LoadingService },
        { type: HideEventService, decorators: [{ type: Optional }] },
        { type: AppContext, decorators: [{ type: Optional }] }
    ]; };
    return FormLoadingService;
}());
export { FormLoadingService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1sb2FkaW5nLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZm9ybS1sb2FkaW5nL2Zvcm0tbG9hZGluZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQVksUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxjQUFjLEVBQW1DLE1BQU0sb0JBQW9CLENBQUM7QUFDckYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFVBQVUsRUFBZ0IsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxRCxvQ0FBb0M7QUFDcEM7Ozs7R0FJRztBQUNIO0lBYUU7O09BRUc7SUFFSDs7O09BR0c7SUFDSCw0QkFDVSxjQUE4QixFQUNsQixnQkFBa0MsRUFDbEMsa0JBQThCO1FBSHBELGlCQVlDO1FBWFMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQ2xCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFZO1FBaEJwRDs7V0FFRztRQUNLLG9CQUFlLEdBQVUsRUFBRSxDQUFDO1FBZWxDLElBQUksZ0JBQWdCLEVBQUU7WUFDcEIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQ3ZDLFVBQUEsTUFBTTtnQkFDSixLQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDZCxDQUFDLENBQ0YsQ0FBQztTQUNIO0lBQ0gsQ0FBQztJQUNNLHVDQUFVLEdBQWpCLFVBQWtCLElBQWE7UUFDN0Isa0JBQWtCLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztJQUN0QyxDQUFDO0lBQ0Q7O09BRUc7SUFDSSxpQ0FBSSxHQUFYLFVBQVksZUFBcUI7UUFDL0IsSUFBSSxrQkFBa0IsQ0FBQyxTQUFTLEtBQUssSUFBSSxFQUFFO1lB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Q0FBQztRQUNwQixNQUFNLENBQUMsd0JBQXdCLENBQUMsR0FBRyxRQUFRLENBQUM7SUFDOUMsQ0FBQztJQTFLYyw0QkFBUyxHQUFHLEtBQUssQ0FBQzs7Z0JBRmxDLFVBQVU7Ozs7Z0JBVEYsY0FBYztnQkFDZCxnQkFBZ0IsdUJBK0JwQixRQUFRO2dCQTlCSixVQUFVLHVCQStCZCxRQUFROztJQXFKYix5QkFBQztDQUFBLEFBN0tELElBNktDO0FBR0QsT0FBTyxFQUFFLGtCQUFrQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBTa2lwU2VsZiwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTG9hZGluZ1NlcnZpY2UsIExvYWRpbmdDb25maWcsIExvYWRpbmdDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWxvYWRpbmcnO1xyXG5pbXBvcnQgeyBIaWRlRXZlbnRTZXJ2aWNlIH0gZnJvbSAnLi9oaWRlLWV2ZW50LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBBcHBDb250ZXh0LCBGcmFtZUNvbnRleHQgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbi8vIHRzbGludDpkaXNhYmxlOiBuby1zdHJpbmctbGl0ZXJhbFxyXG4vKipcclxuICog5Yqg6L295o+Q56S6SGVscGVyXHJcbiAqIDHjgIHljIXoo4VAZmFycmlzL3Vp55qETG9hZGluZ1NlcnZpY2XvvJtcclxuICogMuOAgeaPkOS+m+mSiOWvueihqOWNleeahOW/q+aNt+aWueazle+8m1xyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5jbGFzcyBGb3JtTG9hZGluZ1NlcnZpY2Uge1xyXG4gIHByaXZhdGUgc3RhdGljIGlzU3VzcGVuZCA9IGZhbHNlO1xyXG4gIC8qKlxyXG4gICAqIOWKoOi9veS4ree7hOS7tuWunuS+i1xyXG4gICAqL1xyXG4gIHByaXZhdGUgbG9hZGluZ0NtcDogTG9hZGluZ0NvbXBvbmVudDtcclxuXHJcbiAgLyoqXHJcbiAgICog5bu26L+fbG9hZGluZ+WumuaXtuWZqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgbG9hZGluZ1RpbWVySWRzOiBhbnlbXSA9IFtdO1xyXG5cclxuICAvKipcclxuICAgKiDlvLrliLbmmL7npLrvvIzkuI3og73pmpDol49cclxuICAgKi9cclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICog5rOo5YWlQGZhcnJpcy91aeeahExvYWRpbmdTZXJ2aWNlXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGxvYWRpbmdTZXJ2aWNlOiBMb2FkaW5nU2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgaGlkZUV2ZW50U2VydmljZTogSGlkZUV2ZW50U2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgYXBwbGljYXRpb25Db250ZXh0OiBBcHBDb250ZXh0LFxyXG4gICkge1xyXG4gICAgaWYgKGhpZGVFdmVudFNlcnZpY2UpIHtcclxuICAgICAgdGhpcy5oaWRlRXZlbnRTZXJ2aWNlLmhpZGVFdmVudC5zdWJzY3JpYmUoXHJcbiAgICAgICAgcmVzdWx0ID0+IHtcclxuICAgICAgICAgIHRoaXMuaGlkZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHVibGljIHNldFN1c3BlbmQoZmxhZzogYm9vbGVhbikge1xyXG4gICAgRm9ybUxvYWRpbmdTZXJ2aWNlLmlzU3VzcGVuZCA9IGZsYWc7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaYvuekuuWKoOi9veS4rVxyXG4gICAqL1xyXG4gIHB1YmxpYyBzaG93KGNvbmZpZ09yTWVzc2FnZT86IGFueSk6IExvYWRpbmdDb21wb25lbnQge1xyXG4gICAgaWYgKEZvcm1Mb2FkaW5nU2VydmljZS5pc1N1c3BlbmQgPT09IHRydWUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMubG9hZGluZ0NtcCkge1xyXG4gICAgICB0aGlzLmxvYWRpbmdDbXAuY2xvc2UoKTtcclxuICAgICAgdGhpcy5sb2FkaW5nQ21wID0gbnVsbDtcclxuICAgIH1cclxuICAgIHRoaXMucmVnaXN0ZXJTZXJ2aWNlKCk7XHJcbiAgICBjb25zdCBsb2FkaW5nQ29uZmlnID0gdGhpcy5idWlsZExvYWRpbmdDb25maWcoY29uZmlnT3JNZXNzYWdlKTtcclxuICAgIHRoaXMubG9hZGluZ0NtcCA9IHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdyhsb2FkaW5nQ29uZmlnKTtcclxuICAgIHJldHVybiB0aGlzLmxvYWRpbmdDbXA7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlu7bov5/mmL7npLpMb2FkaW5nXHJcbiAgICovXHJcbiAgcHVibGljIHNob3dMb2FkaW5nV2l0aERlbGF5KGRlbGF5VGltZTogbnVtYmVyLCBjb25maWdPck1lc3NhZ2U/OiBhbnkpOiBhbnkge1xyXG4gICAgLy8gdGhpcy5zaG93KGNvbmZpZ09yTWVzc2FnZSk7XHJcbiAgICBjb25zdCB0aW1lcklkID0gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgIHRoaXMuc2hvdyhjb25maWdPck1lc3NhZ2UpO1xyXG4gICAgfSwgZGVsYXlUaW1lKTtcclxuICAgIHRoaXMubG9hZGluZ1RpbWVySWRzLnB1c2godGltZXJJZCk7XHJcbiAgICB0aGlzLnJlZ2lzdGVyU2VydmljZSgpO1xyXG4gICAgcmV0dXJuIHRpbWVySWQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDpmpDol4/lu7bov5/nmoRMb2FkaW5nXHJcbiAgICovXHJcbiAgcHVibGljIGhpZGVEZWxheUxvYWRpbmcodGltZXJJZFRvQ2xlYXI6IGFueSkge1xyXG4gICAgdGhpcy5jbGVhckxvYWRpbmdUaW1lcih0aW1lcklkVG9DbGVhcik7XHJcbiAgICB0aGlzLmhpZGUoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoExvYWRpbmdDb25maWdcclxuICAgKiBAcGFyYW0gY29uZmlnT3JNZXNzYWdlIOmFjee9ruWvueixoeaIlua2iOaBr+Wtl+espuS4slxyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGRMb2FkaW5nQ29uZmlnKGNvbmZpZ09yTWVzc2FnZTogYW55KTogTG9hZGluZ0NvbmZpZyB7XHJcbiAgICBsZXQgbG9hZGluZ0NvbmZpZzogTG9hZGluZ0NvbmZpZztcclxuICAgIGlmICghIWNvbmZpZ09yTWVzc2FnZSkge1xyXG4gICAgICBpZiAodHlwZW9mIGNvbmZpZ09yTWVzc2FnZSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICBsb2FkaW5nQ29uZmlnID0gY29uZmlnT3JNZXNzYWdlO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGxvYWRpbmdDb25maWcgPSB7ICdtZXNzYWdlJzogY29uZmlnT3JNZXNzYWdlIH07XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGxvYWRpbmdDb25maWcgPSB7fTtcclxuICAgIH1cclxuICAgIGlmICghbG9hZGluZ0NvbmZpZy5oYXNPd25Qcm9wZXJ0eSgnZGVsYXknKSkge1xyXG4gICAgICBsb2FkaW5nQ29uZmlnLmRlbGF5ID0gMDtcclxuICAgIH1cclxuICAgIHJldHVybiBsb2FkaW5nQ29uZmlnO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5YWz6Zet5omA5pyJbG9hZGluZ1xyXG4gICAqL1xyXG4gIHB1YmxpYyBjbGVhckFsbCgpIHtcclxuICAgIEZvcm1Mb2FkaW5nU2VydmljZS5pc1N1c3BlbmQgPSBmYWxzZTtcclxuICAgIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5jbGVhckFsbCgpO1xyXG4gICAgfSwgMzUwKTtcclxuICAgIHRoaXMubG9hZGluZ0NtcCA9IG51bGw7XHJcbiAgICB0aGlzLmNsZWFyQWxsTG9hZGluZ1RpbWVycygpO1xyXG4gICAgdGhpcy5kZXN0cm95KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmuIXnqbpMb2FkaW5n5a6a5pe25ZmoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjbGVhckxvYWRpbmdUaW1lcih0aW1lcklkVG9DbGVhcjogYW55KSB7XHJcbiAgICBjbGVhclRpbWVvdXQodGltZXJJZFRvQ2xlYXIpO1xyXG4gICAgdGhpcy5sb2FkaW5nVGltZXJJZHMgPSB0aGlzLmxvYWRpbmdUaW1lcklkcy5maWx0ZXIoKHRpbWVySWQ6IGFueSkgPT4ge1xyXG4gICAgICByZXR1cm4gdGltZXJJZCAhPT0gdGltZXJJZFRvQ2xlYXI7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa4heepuuaJgOaciUxvYWRpbmflrprml7blmahcclxuICAgKi9cclxuICBwcml2YXRlIGNsZWFyQWxsTG9hZGluZ1RpbWVycygpIHtcclxuICAgIHRoaXMubG9hZGluZ1RpbWVySWRzLmZvckVhY2goKHRpbWVySWQ6IGFueSkgPT4ge1xyXG4gICAgICB0aGlzLmNsZWFyTG9hZGluZ1RpbWVyKHRpbWVySWQpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDpmpDol4/liqDovb3kuK1cclxuICAgKi9cclxuICBwdWJsaWMgaGlkZSgpIHtcclxuICAgIGlmICghdGhpcy5sb2FkaW5nQ21wKSB7XHJcbiAgICAgIHRoaXMuZGVzdHJveSgpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoRm9ybUxvYWRpbmdTZXJ2aWNlLmlzU3VzcGVuZCA9PT0gdHJ1ZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLmxvYWRpbmdDbXAuY2xvc2UoKTtcclxuICAgIHRoaXMubG9hZGluZ0NtcCA9IG51bGw7XHJcbiAgICB0aGlzLmRlc3Ryb3koKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6ZSA5q+BbG9hZGluZ1NlcnZpY2VcclxuICAgKi9cclxuICBwdWJsaWMgZGVzdHJveSgpIHtcclxuICAgIGlmIChGb3JtTG9hZGluZ1NlcnZpY2UuaXNTdXNwZW5kID09PSB0cnVlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IHNlcnZpY2VzOiBhbnlbXSA9IHdpbmRvd1snREVWS0lUX0xPQURJTkdfU0VSVklDRSddIHx8IFtdO1xyXG4gICAgaWYgKHNlcnZpY2VzICYmIEFycmF5LmlzQXJyYXkoc2VydmljZXMpICYmIHNlcnZpY2VzLmxlbmd0aCA+IDApIHtcclxuICAgICAgc2VydmljZXMuZm9yRWFjaCgoc2VydmljZTogRm9ybUxvYWRpbmdTZXJ2aWNlKSA9PiB7XHJcbiAgICAgICAgaWYgKHNlcnZpY2UpIHtcclxuICAgICAgICAgIHNlcnZpY2UuY2xlYXJBbGxMb2FkaW5nVGltZXJzKCk7XHJcbiAgICAgICAgICBpZiAoc2VydmljZS5sb2FkaW5nQ21wKSB7XHJcbiAgICAgICAgICAgIHNlcnZpY2UubG9hZGluZ0NtcC5jbG9zZSgpO1xyXG4gICAgICAgICAgICBzZXJ2aWNlLmxvYWRpbmdDbXAgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgd2luZG93WydERVZLSVRfTE9BRElOR19TRVJWSUNFJ10gPSBbXTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOazqOWGjOaJgOacieeahExvYWRpbmdTZXJ2aWNl5a6e5L6LXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZWdpc3RlclNlcnZpY2UoKSB7XHJcbiAgICBjb25zdCBzZXJ2aWNlczogYW55W10gPSB3aW5kb3dbJ0RFVktJVF9MT0FESU5HX1NFUlZJQ0UnXSB8fCBbXTtcclxuICAgIHNlcnZpY2VzLnB1c2godGhpcyk7XHJcbiAgICB3aW5kb3dbJ0RFVktJVF9MT0FESU5HX1NFUlZJQ0UnXSA9IHNlcnZpY2VzO1xyXG4gIH1cclxufVxyXG5cclxuXHJcbmV4cG9ydCB7IEZvcm1Mb2FkaW5nU2VydmljZSB9O1xyXG4iXX0=