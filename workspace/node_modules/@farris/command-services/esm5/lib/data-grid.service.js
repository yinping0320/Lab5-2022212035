import * as tslib_1 from "tslib";
import { Injectable } from "@angular/core";
import { Service } from "./service";
import { DatagridComponent } from '@farris/ui-datagrid';
var DataGridService = /** @class */ (function (_super) {
    tslib_1.__extends(DataGridService, _super);
    function DataGridService() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    /**
     * 清空所有勾选行
     * @description 取消勾选当前表单所有勾选行
     */
    DataGridService.prototype.clearChecks = function () {
        // const params = this.eventParam;
        // if (params && Array.isArray(params)) {
        // const param = params[0];
        // if (param instanceof QueryCondition) {
        var gridComponents = this.getFormGridComponents(this.context);
        if (gridComponents && gridComponents.length > 0) {
            gridComponents.forEach(function (gridComponent) {
                var clearSelections = true;
                if (gridComponent.hasOwnProperty('clearSelectionsWhenDataIsEmpty')) {
                    clearSelections = gridComponent['clearSelectionsWhenDataIsEmpty'];
                }
                if (clearSelections) {
                    gridComponent.clearCheckeds(true);
                }
            });
        }
        // }
        // }
    };
    /**
     * 取消勾选删除的行
     * @param ids ids
     * @returns
     * @description 取消勾选当前绑定路径下指定数据，清空下级表格中所有勾选行，仅供删除场景使用
     */
    DataGridService.prototype.uncheckDeletedRows = function (ids) {
        if (typeof ids === 'string') {
            if (ids.indexOf(',') !== -1) {
                ids = ids.split(',').filter(function (p) { return p; });
            }
            else {
                ids = [ids];
            }
        }
        if (!ids || ids.length < 1) {
            return;
        }
        // 获取bindingPath及ns
        var frameContext = this.context.frameContext;
        if (!frameContext) {
            return;
        }
        var appContext = frameContext.appContext;
        var ns = frameContext.namespace;
        var bindingPath = frameContext.viewModel && frameContext.viewModel.bindingPath;
        if (!appContext) {
            return;
        }
        // 根据bindingPath获取所有可能的frameContext
        var frameContexts = appContext.frameContextManager.getFrameContextsByNamespace(ns);
        var frameContextsInCurrentBindingPath = frameContexts.filter(function (frameContext) { return frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath === bindingPath; });
        // 获取这些frame中所有的表格组件map
        var gridInCurrentFrame = this.getGridComponentByFrameContexts(frameContextsInCurrentBindingPath);
        if (!gridInCurrentFrame) {
            return;
        }
        // 一个bindingPath下应该只有一个grid
        var grid = gridInCurrentFrame.pop();
        // 清空命令所在的frame下表格的指定勾选
        if (grid) {
            grid.unCheckRows(ids, true);
        }
        // 清空下级表格的所有勾选行数据
        var childrenFrameContexts = frameContexts.filter(function (frameContext) { return frameContext.viewModel.bindingPath !== bindingPath && frameContext.viewModel.bindingPath.startsWith(bindingPath); });
        var childrenGridComponents = this.getGridComponentByFrameContexts(childrenFrameContexts);
        // 清空命令所在frame
        if (childrenGridComponents && childrenGridComponents.length > 0) {
            childrenGridComponents.forEach(function (gridComponent) {
                // 清空所有勾选
                gridComponent.checkedRows = [];
            });
        }
    };
    /**
     * 取消勾选行
     * @param ids ids
     * @returns
     */
    DataGridService.prototype.uncheckRows = function (ids) {
        if (typeof ids === 'string') {
            ids = [ids];
        }
        if (!ids || ids.length < 1) {
            return;
        }
        var gridComponents = this.getFormGridComponents(this.context);
        if (gridComponents && gridComponents.length > 0) {
            gridComponents.forEach(function (gridComponent) {
                gridComponent.unCheckRows(ids, true);
            });
        }
    };
    /**
     * 根据命令上下文获取当前命令所在组件的表格实例
     * @param commandContext 命令上下文
     * @returns
     */
    DataGridService.prototype.getFormGridComponents = function (commandContext) {
        var grids = [];
        var frameContext = commandContext && commandContext.frameContext;
        var appContext = frameContext && frameContext.appContext || null;
        if (appContext) {
            var componentRefs = appContext.componentRefs;
            var collect = Array.from(componentRefs.values()); // [Map<string,any>,Map<string,any>]
            collect.forEach(function (item) {
                var components = Array.from(item.values());
                var bindingPath = frameContext;
                var gridComponents = components.filter(function (component) { return component instanceof DatagridComponent; });
                grids = grids.concat(gridComponents);
            });
        }
        return grids;
    };
    DataGridService.prototype.getGridComponentByFrameContexts = function (frameContexts) {
        return frameContexts.reduce(function (result, frameContext) {
            var appContext = frameContext.appContext;
            var frameId = frameContext.frameId;
            // 获取当前组件下所有的组件实例
            var componentsRef = appContext.componentRefs.get(frameId);
            var grids = componentsRef && Array.from(componentsRef.values()).filter(function (component) { return component instanceof DatagridComponent; });
            if (grids && grids.length > 0) {
                result = result.concat(grids);
            }
            return result;
        }, []);
    };
    DataGridService.decorators = [
        { type: Injectable }
    ];
    return DataGridService;
}(Service));
export { DataGridService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1ncmlkLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZGF0YS1ncmlkLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNwQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUd4RDtJQUNxQywyQ0FBTztJQUQ1Qzs7SUFvSUEsQ0FBQztJQWxJQzs7O09BR0c7SUFDSSxxQ0FBVyxHQUFsQjtRQUNFLGtDQUFrQztRQUNsQyx5Q0FBeUM7UUFDekMsMkJBQTJCO1FBQzNCLHlDQUF5QztRQUN6QyxJQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2hFLElBQUksY0FBYyxJQUFJLGNBQWMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQy9DLGNBQWMsQ0FBQyxPQUFPLENBQUMsVUFBQyxhQUFnQztnQkFDdEQsSUFBSSxlQUFlLEdBQUcsSUFBSSxDQUFDO2dCQUMzQixJQUFJLGFBQWEsQ0FBQyxjQUFjLENBQUMsZ0NBQWdDLENBQUMsRUFBRTtvQkFDbEUsZUFBZSxHQUFHLGFBQWEsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO2lCQUNuRTtnQkFDRCxJQUFJLGVBQWUsRUFBRTtvQkFDbkIsYUFBYSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDbkM7WUFDSCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBQ0QsSUFBSTtRQUNKLElBQUk7SUFDTixDQUFDO0lBQ0Q7Ozs7O09BS0c7SUFDSSw0Q0FBa0IsR0FBekIsVUFBMEIsR0FBUTtRQUNoQyxJQUFJLE9BQU8sR0FBRyxLQUFLLFFBQVEsRUFBRTtZQUMzQixJQUFJLEdB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QUFNLEVBQUUsWUFBWTtZQUMvQyxJQUFNLFVBQVUsR0FBRyxZQUFZLENBQUMsVUFBVSxDQUFDO1lBQzNDLElBQU0sT0FBTyxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUM7WUFDckMsaUJBQWlCO1lBQ2pCLElBQU0sYUFBYSxHQUFHLFVBQVUsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzVELElBQU0sS0FBSyxHQUFHLGFBQWEsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFBLFNBQVMsSUFBSSxPQUFBLFNBQVMsWUFBWSxpQkFBaUIsRUFBdEMsQ0FBc0MsQ0FBQyxDQUFDO1lBQzlILElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUM3QixNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUMvQjtZQUNELE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNULENBQUM7O2dCQW5JRixVQUFVOztJQW9JWCxzQkFBQztDQUFBLEFBcElELENBQ3FDLE9BQU8sR0FtSTNDO1NBbklZLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VcIjtcclxuaW1wb3J0IHsgRGF0YWdyaWRDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWRhdGFncmlkJztcclxuaW1wb3J0IHsgUXVlcnlDb25kaXRpb24gfSBmcm9tICdAZmFycmlzL2NvbXBvbmVudC1xdWVyeWNvbmRpdGlvbic7XHJcbmltcG9ydCB7IENvbW1hbmRDb250ZXh0LCBGcmFtZUNvbnRleHQgfSBmcm9tIFwiQGZhcnJpcy9kZXZraXRcIjtcclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRGF0YUdyaWRTZXJ2aWNlIGV4dGVuZHMgU2VydmljZSB7XHJcbiAgLyoqXHJcbiAgICog5riF56m65omA5pyJ5Yu+6YCJ6KGMXHJcbiAgICogQGRlc2NyaXB0aW9uIOWPlua2iOWLvumAieW9k+WJjeihqOWNleaJgOacieWLvumAieihjFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjbGVhckNoZWNrcygpIHtcclxuICAgIC8vIGNvbnN0IHBhcmFtcyA9IHRoaXMuZXZlbnRQYXJhbTtcclxuICAgIC8vIGlmIChwYXJhbXMgJiYgQXJyYXkuaXNBcnJheShwYXJhbXMpKSB7XHJcbiAgICAvLyBjb25zdCBwYXJhbSA9IHBhcmFtc1swXTtcclxuICAgIC8vIGlmIChwYXJhbSBpbnN0YW5jZW9mIFF1ZXJ5Q29uZGl0aW9uKSB7XHJcbiAgICBjb25zdCBncmlkQ29tcG9uZW50cyA9IHRoaXMuZ2V0Rm9ybUdyaWRDb21wb25lbnRzKHRoaXMuY29udGV4dCk7XHJcbiAgICBpZiAoZ3JpZENvbXBvbmVudHMgJiYgZ3JpZENvbXBvbmVudHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBncmlkQ29tcG9uZW50cy5mb3JFYWNoKChncmlkQ29tcG9uZW50OiBEYXRhZ3JpZENvbXBvbmVudCkgPT4ge1xyXG4gICAgICAgIGxldCBjbGVhclNlbGVjdGlvbnMgPSB0cnVlO1xyXG4gICAgICAgIGlmIChncmlkQ29tcG9uZW50Lmhhc093blByb3BlcnR5KCdjbGVhclNlbGVjdGlvbnNXaGVuRGF0YUlzRW1wdHknKSkge1xyXG4gICAgICAgICAgY2xlYXJTZWxlY3Rpb25zID0gZ3JpZENvbXBvbmVudFsnY2xlYXJTZWxlY3Rpb25zV2hlbkRhdGFJc0VtcHR5J107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjbGVhclNlbGVjdGlvbnMpIHtcclxuICAgICAgICAgIGdyaWRDb21wb25lbnQuY2xlYXJDaGVja2Vkcyh0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgLy8gfVxyXG4gICAgLy8gfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDlj5bmtojli77pgInliKDpmaTnmoTooYxcclxuICAgKiBAcGFyYW0gaWRzIGlkc1xyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqIEBkZXNjcmlwdGlvbiDlj5bmtojli77pgInlvZPliY3nu5Hlrprot6/lvoTkuIvmjIflrprmlbDmja7vvIzmuIXnqbrkuIvnuqfooajmoLzkuK3miYDmnInli77pgInooYzvvIzku4XkvpvliKDpmaTlnLrmma/kvb/nlKhcclxuICAgKi9cclxuICBwdWJsaWMgdW5jaGVja0RlbGV0ZWRSb3dzKGlkczogYW55KSB7XHJcbiAgICBpZiAodHlwZW9mIGlkcyA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgaWYgKGlkcy5pbmRleE9mKCcsJykgIT09IC0xKSB7XHJcbiAgICAgICAgaWRzID0gaWRzLnNwbGl0KCcsJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWRzID0gW2lkc107XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGlmICghaWRzIHx8IGlkcy5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIOiOt+WPlmJpbmRpbmdQYXRo5Y+KbnNcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuY29udGV4dC5mcmFtZUNvbnRleHQ7XHJcbiAgICBpZiAoIWZyYW1lQ29udGV4dCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBhcHBDb250ZXh0ID0gZnJhbWVDb250ZXh0LmFwcENvbnRleHQ7XHJcbiAgICBjb25zdCBucyA9IGZyYW1lQ29udGV4dC5uYW1lc3BhY2U7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcclxuICAgIGlmICghYXBwQ29udGV4dCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDmoLnmja5iaW5kaW5nUGF0aOiOt+WPluaJgOacieWPr+iDveeahGZyYW1lQ29udGV4dFxyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0cyA9IGFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzQnlOYW1lc3BhY2UobnMpO1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0c0luQ3VycmVudEJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0cy5maWx0ZXIoZnJhbWVDb250ZXh0ID0+IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09IGJpbmRpbmdQYXRoKTtcclxuICAgIC8vIOiOt+WPlui/meS6m2ZyYW1l5Lit5omA5pyJ55qE6KGo5qC857uE5Lu2bWFwXHJcbiAgICBjb25zdCBncmlkSW5DdXJyZW50RnJhbWUgPSB0aGlzLmdldEdyaWRDb21wb25lbnRCeUZyYW1lQ29udGV4dHMoZnJhbWVDb250ZXh0c0luQ3VycmVudEJpbmRpbmdQYXRoKTtcclxuICAgIGlmICghZ3JpZEluQ3VycmVudEZyYW1lKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIOS4gOS4qmJpbmRpbmdQYXRo5LiL5bqU6K+l5Y+q5pyJ5LiA5LiqZ3JpZFxyXG4gICAgY29uc3QgZ3JpZDogRGF0YWdyaWRDb21wb25lbnQgPSBncmlkSW5DdXJyZW50RnJhbWUucG9wKCk7XHJcbiAgICAvLyDmuIXnqbrlkb3ku6TmiYDlnKjnmoRmcmFtZeS4i+ihqOagvOeahOaMh+WumuWLvumAiVxyXG4gICAgaWYoZ3JpZCl7XHJcbiAgICAgIGdyaWQudW5DaGVja1Jvd3MoaWRzLCB0cnVlKTtcclxuICAgIH1cclxuICAgIC8vIOa4heepuuS4i+e6p+ihqOagvOeahOaJgOacieWLvumAieihjOaVsOaNrlxyXG4gICAgY29uc3QgY2hpbGRyZW5GcmFtZUNvbnRleHRzID0gZnJhbWVDb250ZXh0cy5maWx0ZXIoZnJhbWVDb250ZXh0ID0+IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggIT09IGJpbmRpbmdQYXRoICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGguc3RhcnRzV2l0aChiaW5kaW5nUGF0aCkpO1xyXG4gICAgY29uc3QgY2hpbGRyZW5HcmlkQ29tcG9uZW50cyA9IHRoaXMuZ2V0R3JpZENvbXBvbmVudEJ5RnJhbWVDb250ZXh0cyhjaGlsZHJlbkZyYW1lQ29udGV4dHMpO1xyXG4gICAgLy8g5riF56m65ZG95Luk5omA5ZyoZnJhbWVcclxuICAgIGlmIChjaGlsZHJlbkdyaWRDb21wb25lbnRzICYmIGNoaWxkcmVuR3JpZENvbXBvbmVudHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBjaGlsZHJlbkdyaWRDb21wb25lbnRzLmZvckVhY2goKGdyaWRDb21wb25lbnQ6IERhdGFncmlkQ29tcG9uZW50KSA9PiB7XHJcbiAgICAgICAgLy8g5riF56m65omA5pyJ5Yu+6YCJXHJcbiAgICAgICAgZ3JpZENvbXBvbmVudC5jaGVja2VkUm93cyA9IFtdO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Y+W5raI5Yu+6YCJ6KGMXHJcbiAgICogQHBhcmFtIGlkcyBpZHNcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgdW5jaGVja1Jvd3MoaWRzOiBhbnkpIHtcclxuICAgIGlmICh0eXBlb2YgaWRzID09PSAnc3RyaW5nJykge1xyXG4gICAgICBpZHMgPSBbaWRzXTtcclxuICAgIH1cclxuICAgIGlmICghaWRzIHx8IGlkcy5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGdyaWRDb21wb25lbnRzID0gdGhpcy5nZXRGb3JtR3JpZENvbXBvbmVudHModGhpcy5jb250ZXh0KTtcclxuICAgIGlmIChncmlkQ29tcG9uZW50cyAmJiBncmlkQ29tcG9uZW50cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGdyaWRDb21wb25lbnRzLmZvckVhY2goKGdyaWRDb21wb25lbnQ6IERhdGFncmlkQ29tcG9uZW50KSA9PiB7XHJcbiAgICAgICAgZ3JpZENvbXBvbmVudC51bkNoZWNrUm93cyhpZHMsIHRydWUpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5qC55o2u5ZG95Luk5LiK5LiL5paH6I635Y+W5b2T5YmN5ZG95Luk5omA5Zyo57uE5Lu255qE6KGo5qC85a6e5L6LXHJcbiAgICogQHBhcmFtIGNvbW1hbmRDb250ZXh0IOWRveS7pOS4iuS4i+aWh1xyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Rm9ybUdyaWRDb21wb25lbnRzKGNvbW1hbmRDb250ZXh0OiBDb21tYW5kQ29udGV4dCkge1xyXG4gICAgbGV0IGdyaWRzID0gW107XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSBjb21tYW5kQ29udGV4dCAmJiBjb21tYW5kQ29udGV4dC5mcmFtZUNvbnRleHQ7XHJcbiAgICBjb25zdCBhcHBDb250ZXh0ID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5hcHBDb250ZXh0IHx8IG51bGw7XHJcbiAgICBpZiAoYXBwQ29udGV4dCkge1xyXG4gICAgICBjb25zdCBjb21wb25lbnRSZWZzOiBNYXA8c3RyaW5nLCBNYXA8c3RyaW5nLCBhbnk+PiA9IGFwcENvbnRleHQuY29tcG9uZW50UmVmcztcclxuICAgICAgY29uc3QgY29sbGVjdCA9IEFycmF5LmZyb20oY29tcG9uZW50UmVmcy52YWx1ZXMoKSk7Ly8gW01hcDxzdHJpbmcsYW55PixNYXA8c3RyaW5nLGFueT5dXHJcbiAgICAgIGNvbGxlY3QuZm9yRWFjaCgoaXRlbTogTWFwPHN0cmluZywgYW55PikgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNvbXBvbmVudHMgPSBBcnJheS5mcm9tKGl0ZW0udmFsdWVzKCkpO1xyXG4gICAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0XHJcbiAgICAgICAgY29uc3QgZ3JpZENvbXBvbmVudHMgPSBjb21wb25lbnRzLmZpbHRlcigoY29tcG9uZW50OiBhbnkpID0+IGNvbXBvbmVudCBpbnN0YW5jZW9mIERhdGFncmlkQ29tcG9uZW50KTtcclxuICAgICAgICBncmlkcyA9IGdyaWRzLmNvbmNhdChncmlkQ29tcG9uZW50cyk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGdyaWRzO1xyXG4gIH1cclxuICBwcml2YXRlIGdldEdyaWRDb21wb25lbnRCeUZyYW1lQ29udGV4dHMoZnJhbWVDb250ZXh0czogRnJhbWVDb250ZXh0W10pIHtcclxuICAgIHJldHVybiBmcmFtZUNvbnRleHRzLnJlZHVjZSgocmVzdWx0LCBmcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgY29uc3QgYXBwQ29udGV4dCA9IGZyYW1lQ29udGV4dC5hcHBDb250ZXh0O1xyXG4gICAgICBjb25zdCBmcmFtZUlkID0gZnJhbWVDb250ZXh0LmZyYW1lSWQ7XHJcbiAgICAgIC8vIOiOt+WPluW9k+WJjee7hOS7tuS4i+aJgOacieeahOe7hOS7tuWunuS+i1xyXG4gICAgICBjb25zdCBjb21wb25lbnRzUmVmID0gYXBwQ29udGV4dC5jb21wb25lbnRSZWZzLmdldChmcmFtZUlkKTtcclxuICAgICAgY29uc3QgZ3JpZHMgPSBjb21wb25lbnRzUmVmICYmIEFycmF5LmZyb20oY29tcG9uZW50c1JlZi52YWx1ZXMoKSkuZmlsdGVyKGNvbXBvbmVudCA9PiBjb21wb25lbnQgaW5zdGFuY2VvZiBEYXRhZ3JpZENvbXBvbmVudCk7XHJcbiAgICAgIGlmIChncmlkcyAmJiBncmlkcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgcmVzdWx0ID0gcmVzdWx0LmNvbmNhdChncmlkcyk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH0sIFtdKTtcclxuICB9XHJcbn0iXX0=