/*
 * @Author: Witt
 * @Date: 2018-11-15 15:56:11
 * @Last Modified by: aalizzwell
 * @Last Modified time: 2019-07-09 16:23:04
 */
import { Injectable, Optional } from '@angular/core';
import { Router } from '@angular/router';
import { RouterParamService } from '@farris/devkit';
import { FrameworkService, AppService } from '@gsp-sys/rtf-common';
import { MenuStateService } from './menu-state.service';
import { Subject } from 'rxjs';
import { LanguageService } from './languag.service';
// tslint:disable: no-string-literal
/**
 * 路由服务
 * @scope FormModule
 */
var RouterService = /** @class */ (function () {
    function RouterService(router, routerParamService, frameworkService, appService, menuStateService, languageService) {
        this.router = router;
        this.routerParamService = routerParamService;
        this.frameworkService = frameworkService;
        this.appService = appService;
        this.menuStateService = menuStateService;
        this.languageService = languageService;
        /**
         * 上次切换的TabId
         */
        this.lastSwitchId = null;
        /**
         * 上次关闭的TabId
         */
        this.lastCloseId = null;
        // private menuStateService: MenuStateService = null;
        this.onClosed = null;
        if (!this.menuStateService) {
            this.menuStateService = new MenuStateService();
        }
        if (!this.languageService) {
            this.languageService = LanguageService.getInstance();
        }
        this.onClosed = new Subject();
        this.registerEvent();
    }
    /**
     * 切换路由
     * @param url 菜单ID
     * @param params 路由参数
     */
    RouterService.prototype.route = function (url, params) {
        url = this.router.createUrlTree([url]).toString();
        this.setParams(url, params);
        this.router.navigateByUrl(url);
    };
    /**
     * 注册运行框架事件
     */
    RouterService.prototype.registerEvent = function () {
        var _this = this;
        var params = this.getParams(window.location.hash);
        var menuId = this.getAppId() || this.getFuncId();
        this.frameworkService.eventListner(this.frameworkService.FuncSwitch, function (e) {
            if (!e) {
                return;
            }
            var id = _this.getOriginalId(e.id) || e.tabId;
            var menuState = _this.menuStateService.getMenuState(id);
            if (!!id && menuId === id && !!menuState && menuState.length > 0) {
                _this.formReload();
                _this.lastSwitchId = id;
            }
        }, params);
        this.frameworkService.eventListner(this.frameworkService.FuncClosed, function (e) {
            if (!e) {
                return;
            }
            _this.onClosed.next(e);
            var id = _this.getOriginalId(e.id) || e.tabId;
            if (menuId === id) {
                return;
            }
            var menuState = _this.menuStateService.getMenuState(menuId, id);
            // && id !== this.lastCloseId
            if (!!id && !!menuState && menuState.length > 0) {
                _this.removeMenuState(id);
                _this.formReload();
                _this.lastCloseId = id;
            }
        }, params);
    };
    RouterService.prototype.removeMenuState = function (tabId) {
        if (this['context']) {
            this.menuStateService.removeMenu(tabId);
        }
    };
    /**
     * 获取原始功能id
     * @param id id
     */
    RouterService.prototype.getOriginalId = function (id) {
        if (!id) {
            return id;
        }
        if (id.indexOf('_') !== -1) {
            id = id.split('_')[0];
        }
        return id;
    };
    /**
     * 刷新组件数据
     */
    RouterService.prototype.formReload = function () {
        try {
            this['context']['frameContext']['appContext']['refresh']();
        }
        catch (_a) { }
    };
    /**
     * 打开功能菜单
     * @param funcId 菜单内码
     * @param params 路由参数，形如： { key1: val1, key2: value2 }
     */
    RouterService.prototype.openMenu = function (funcId, params, reload) {
        if (typeof reload === 'undefined' || typeof reload !== 'boolean') {
            reload = false;
        }
        var paramsMap = this.buildParamMap(params);
        var parentMenuId = this.getFuncId() || this.getAppId();
        this.menuStateService.addMenuState(parentMenuId, funcId);
        paramsMap.set('WEB_FORM_ROUTER_PARENT_ID', parentMenuId);
        this.frameworkService.openFuncWithParam(funcId, paramsMap, reload);
    };
    /**
     * 打开应用
     * @param appId 应用内码
     * @param appEntrance 应用入口
     * @param params 路由参数，形如： { key1: val1, key2: value2 }
     */
    RouterService.prototype.openApp = function (appId, appEntrance, params, reload) {
        if (typeof reload === 'undefined' || typeof reload !== 'boolean') {
            reload = false;
        }
        var paramMap = this.buildParamMap(params);
        var parentMenuId = this.getAppId() || this.getFuncId();
        this.menuStateService.addMenuState(parentMenuId, appId);
        paramMap.set('WEB_FORM_ROUTER_PARENT_ID', parentMenuId);
        if (!!this.appService) {
            this.appService.openApp(appId, appEntrance, paramMap, reload);
        }
    };
    /**
     * 构造参数
     */
    RouterService.prototype.buildParamMap = function (params) {
        if (typeof params === 'undefined' || params === null || (typeof params === 'string' && params.length < 1)) {
            params = {};
        }
        var paramMap = new Map();
        if (typeof params === 'object') {
            params = JSON.stringify(params);
        }
        params = window['encodeURIComponent'](params);
        paramMap.set('WEB_FORM_ROUTE_PARAMS', params);
        return paramMap;
    };
    /**
     * 关闭功能菜单
     */
    RouterService.prototype.closeMenu = function () {
        var funcId = this.getFuncId();
        var appId = this.getAppId();
        var _a = this.findDialog(), isDialogComponent = _a.isDialogComponent, rootComponent = _a.rootComponent;
        if (isDialogComponent) {
            var modalRef = this.get(rootComponent, 'dialogRef');
            modalRef['close']();
            return;
        }
        if (funcId !== null && typeof funcId === 'string' && funcId.length > 0) {
            this.closeFunc(funcId);
        }
        else if (appId !== null && typeof appId === 'string' && appId.length > 0) {
            var appEntrance = this.getAppEntrance();
            this.closeApp(appId, appEntrance);
        }
        else {
            console.error(this.languageService['notSupportMenuType']);
        }
    };
    /**
     * 查找弹窗组件
     */
    RouterService.prototype.findDialog = function () {
        var frameContext = this.get(this, 'context.frameContext');
        var isDialogComponent = this.get(frameContext, 'frameComponent.isDialogRootComponent', false);
        var parentFrameContext = this.get(frameContext, 'parent');
        while (parentFrameContext != null && !isDialogComponent) {
            frameContext = this.get(frameContext, 'parent');
            parentFrameContext = this.get(parentFrameContext, 'parent');
            isDialogComponent = this.get(frameContext, 'frameComponent.isDialogRootComponent', false);
        }
        var rootComponent = this.get(frameContext, 'frameComponent');
        return { isDialogComponent: isDialogComponent, rootComponent: rootComponent };
    };
    /**
     * loadsh get
     * @param object 对象
     * @param path 路径
     * @param defaultVal 默认值
     */
    RouterService.prototype.get = function (object, path, defaultVal) {
        if (defaultVal === void 0) { defaultVal = null; }
        var PATH = Array.isArray(path)
            ? path
            : path.split('.').filter(function (i) { return i.length; });
        if (!PATH.length) {
            return object === undefined ? defaultVal : object;
        }
        if (object === null || object === undefined || typeof (object[PATH[0]]) === 'undefined') {
            return defaultVal;
        }
        return this.get(object[PATH.shift()], PATH, defaultVal);
    };
    /**
     * 关闭菜单
     * @param funcId 菜单id
     */
    RouterService.prototype.closeFunc = function (funcId) {
        if (!funcId) {
            funcId = this.getFuncId();
        }
        if (!!this.frameworkService) {
            this.frameworkService.closeFunc(funcId).subscribe();
        }
    };
    /**
     * 关闭app
     * @param appId 应用id
     */
    RouterService.prototype.closeApp = function (appId, appEntrance) {
        if (!appId) {
            appId = this.getAppId();
        }
        if (typeof appEntrance === 'undefined') {
            appEntrance = this.getAppEntrance();
        }
        if (!!this.appService) {
            this.appService.closeApp(appId, appEntrance).subscribe();
        }
    };
    /**
     * 设置参数
     * @param params 路由参数
     */
    RouterService.prototype.setParams = function (url, params) {
        var paramsObj;
        if (typeof params === 'string' && params !== '') {
            paramsObj = JSON.parse(params);
        }
        else {
            paramsObj = params || {};
        }
        // 设置路由参数
        this.routerParamService.setParams(url, paramsObj);
    };
    /**
     * 获取funcId
     */
    RouterService.prototype.getFuncId = function () {
        var hash = window.location.hash;
        if (!hash) {
            return null;
        }
        var params = this.decodeURLParams(hash);
        if (params && params.hasOwnProperty('funcId')) {
            return params.funcId;
        }
        else {
            return null;
        }
    };
    /**
     * 获取appId
     */
    RouterService.prototype.getAppId = function () {
        var hash = window.location.hash;
        if (!hash) {
            return null;
        }
        var params = this.decodeURLParams(hash);
        if (params && params.hasOwnProperty('appId')) {
            return params.appId;
        }
        else {
            return null;
        }
    };
    RouterService.prototype.getParentMenuId = function () {
        var hash = window.location.hash;
        if (!hash) {
            return null;
        }
        var params = this.decodeURLParams(hash);
        if (params && params.hasOwnProperty('WEB_FORM_ROUTER_PARENT_ID')) {
            return params.WEB_FORM_ROUTER_PARENT_ID;
        }
        else {
            return null;
        }
    };
    /**
     * 获取应用入口
     */
    RouterService.prototype.getAppEntrance = function () {
        var hash = window.location.hash;
        if (!hash) {
            return null;
        }
        var params = this.decodeURLParams(hash);
        if (params && params.hasOwnProperty('appEntrance')) {
            return params.appEntrance;
        }
        else {
            return null;
        }
    };
    /**
     * 解码参数
     * @param query search|hash
     */
    RouterService.prototype.decodeURLParams = function (query) {
        if (typeof query === 'undefined') {
            query = window.location.hash || window.location.search;
        }
        var hashes = query.slice(query.indexOf('?') + 1).split('&');
        return hashes.reduce(function (params, hash) {
            var _a;
            var split = hash.indexOf('=');
            var key = hash.slice(0, split);
            var val = hash.slice(split + 1);
            return Object.assign(params, (_a = {}, _a[key] = decodeURIComponent(val), _a));
        }, {});
    };
    RouterService.prototype.getParams = function (queryString) {
        if (!queryString) {
            return {};
        }
        var hashes = queryString.slice(queryString.indexOf('?') + 1).split('&');
        return hashes.reduce(function (params, hash) {
            var _a;
            var split = hash.indexOf('=');
            var key = hash.slice(0, split);
            var val = hash.slice(split + 1);
            return Object.assign(params, (_a = {}, _a[key] = decodeURIComponent(val), _a));
        }, {});
    };
    RouterService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    RouterService.ctorParameters = function () { return [
        { type: Router },
        { type: RouterParamService },
        { type: FrameworkService },
        { type: AppService, decorators: [{ type: Optional }] },
        { type: MenuStateService, decorators: [{ type: Optional }] },
        { type: LanguageService, decorators: [{ type: Optional }] }
    ]; };
    return RouterService;
}());
export { RouterService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvcm91dGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7O0dBS0c7QUFFSCxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDcEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRXBELG9DQUFvQztBQUNwQzs7O0dBR0c7QUFDSDtJQVlFLHVCQUNVLE1BQWMsRUFDZCxrQkFBc0MsRUFDdEMsZ0JBQWtDLEVBQ3RCLFVBQXNCLEVBQ3RCLGdCQUFrQyxFQUNsQyxlQUFnQztRQUw1QyxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ3RCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFoQnREOztXQUVHO1FBQ0ssaUJBQVksR0FBVyxJQUFJLENBQUM7UUFDcEM7O1dBRUc7UUFDSyxnQkFBVyxHQUFXLElBQUksQ0FBQztRQUNuQyxxREFBcUQ7UUFDOUMsYUFBUSxHQUFpQixJQUFJLENBQUM7UUFTbkMsSUFBSSxDQUFDLElB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SSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDbEMsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sWUFBSSxHQUFDLEdBQUcsSUFBRyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsTUFBRyxDQUFDO1FBQ25FLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNULENBQUM7O2dCQTNWRixVQUFVOzs7O2dCQVpGLE1BQU07Z0JBQ04sa0JBQWtCO2dCQUNsQixnQkFBZ0I7Z0JBQUUsVUFBVSx1QkEwQmhDLFFBQVE7Z0JBekJKLGdCQUFnQix1QkEwQnBCLFFBQVE7Z0JBeEJKLGVBQWUsdUJBeUJuQixRQUFROztJQTBVYixvQkFBQztDQUFBLEFBNVZELElBNFZDO0FBRUQsT0FBTyxFQUFFLGFBQWEsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogQEF1dGhvcjogV2l0dFxyXG4gKiBARGF0ZTogMjAxOC0xMS0xNSAxNTo1NjoxMVxyXG4gKiBATGFzdCBNb2RpZmllZCBieTogYWFsaXp6d2VsbFxyXG4gKiBATGFzdCBNb2RpZmllZCB0aW1lOiAyMDE5LTA3LTA5IDE2OjIzOjA0XHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcclxuaW1wb3J0IHsgUm91dGVyUGFyYW1TZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBGcmFtZXdvcmtTZXJ2aWNlLCBBcHBTZXJ2aWNlIH0gZnJvbSAnQGdzcC1zeXMvcnRmLWNvbW1vbic7XHJcbmltcG9ydCB7IE1lbnVTdGF0ZVNlcnZpY2UgfSBmcm9tICcuL21lbnUtc3RhdGUuc2VydmljZSc7XHJcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9sYW5ndWFnLnNlcnZpY2UnO1xyXG5cclxuLy8gdHNsaW50OmRpc2FibGU6IG5vLXN0cmluZy1saXRlcmFsXHJcbi8qKlxyXG4gKiDot6/nlLHmnI3liqFcclxuICogQHNjb3BlIEZvcm1Nb2R1bGVcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuY2xhc3MgUm91dGVyU2VydmljZSB7XHJcbiAgLyoqXHJcbiAgICog5LiK5qyh5YiH5o2i55qEVGFiSWRcclxuICAgKi9cclxuICBwcml2YXRlIGxhc3RTd2l0Y2hJZDogc3RyaW5nID0gbnVsbDtcclxuICAvKipcclxuICAgKiDkuIrmrKHlhbPpl63nmoRUYWJJZFxyXG4gICAqL1xyXG4gIHByaXZhdGUgbGFzdENsb3NlSWQ6IHN0cmluZyA9IG51bGw7XHJcbiAgLy8gcHJpdmF0ZSBtZW51U3RhdGVTZXJ2aWNlOiBNZW51U3RhdGVTZXJ2aWNlID0gbnVsbDtcclxuICBwdWJsaWMgb25DbG9zZWQ6IFN1YmplY3Q8YW55PiA9IG51bGw7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxyXG4gICAgcHJpdmF0ZSByb3V0ZXJQYXJhbVNlcnZpY2U6IFJvdXRlclBhcmFtU2VydmljZSxcclxuICAgIHByaXZhdGUgZnJhbWV3b3JrU2VydmljZTogRnJhbWV3b3JrU2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgYXBwU2VydmljZTogQXBwU2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgbWVudVN0YXRlU2VydmljZTogTWVudVN0YXRlU2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2UsXHJcbiAgKSB7XHJcbiAgICBpZiAoIXRoaXMubWVudVN0YXRlU2VydmljZSkge1xyXG4gICAgICB0aGlzLm1lbnVTdGF0ZVNlcnZpY2UgPSBuZXcgTWVudVN0YXRlU2VydmljZSgpO1xyXG4gICAgfVxyXG4gICAgaWYgKCF0aGlzLmxhbmd1YWdlU2VydmljZSkge1xyXG4gICAgICB0aGlzLmxhbmd1YWdlU2VydmljZSA9IExhbmd1YWdlU2VydmljZS5nZXRJbnN0YW5jZSgpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5vbkNsb3NlZCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcclxuICAgIHRoaXMucmVnaXN0ZXJFdmVudCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5YiH5o2i6Lev55SxXHJcbiAgICogQHBhcmFtIHVybCDoj5zljZVJRFxyXG4gICAqIEBwYXJhbSBwYXJhbXMg6Lev55Sx5Y+C5pWwXHJcbiAgICovXHJcbiAgcHVibGljIHJvdXRlKHVybDogc3RyaW5nLCBwYXJhbXM6IGFueSkge1xyXG4gICAgdXJsID0gdGhpcy5yb3V0ZXIuY3JlYXRlVXJsVHJlZShbdXJsXSkudG9TdHJpbmcoKTtcclxuICAgIHRoaXMuc2V0UGFyYW1zKHVybCwgcGFyYW1zKTtcclxuICAgIHRoaXMucm91dGVyLm5hdmlnYXRlQnlVcmwodXJsKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5rOo5YaM6L+Q6KGM5qGG5p625LqL5Lu2XHJcbiAgICovXHJcbiAgcHVibGljIHJlZ2lzdGVyRXZlbnQoKSB7XHJcbiAgICBjb25zdCBwYXJhbXM6IGFueSA9IHRoaXMuZ2V0UGFyYW1zKHdpbmRvdy5sb2NhdGlvbi5oYXNoKTtcclxuICAgIGNvbnN0IG1lbnVJZCA9IHRoaXMuZ2V0QXBwSWQoKSB8fCB0aGlzLmdldEZ1bmNJZCgpO1xyXG4gICAgdGhpcy5mcmFtZXdvcmtTZXJ2aWNlLmV2ZW50TGlzdG5lcih0aGlzLmZyYW1ld29ya1NlcnZpY2UuRnVuY1N3aXRjaCwgZSA9PiB7XHJcbiAgICAgIGlmICghZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBpZCA9IHRoaXMuZ2V0T3JpZ2luYWxJZChlLmlkKSB8fCBlLnRhYklkO1xyXG4gICAgICBjb25zdCBtZW51U3RhdGUgPSB0aGlzLm1lbnVTdGF0ZVNlcnZpY2UuZ2V0TWVudVN0YXRlKGlkKTtcclxuICAgICAgaWYgKCEhaWQgJiYgbWVudUlkID09PSBpZCAmJiAhIW1lbnVTdGF0ZSAmJiBtZW51U3RhdGUubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHRoaXMuZm9ybVJlbG9hZCgpO1xyXG4gICAgICAgIHRoaXMubGFzdFN3aXRjaElkID0gaWQ7XHJcbiAgICAgIH1cclxuICAgIH0sIHBhcmFtcyk7XHJcblxyXG4gICAgdGhpcy5mcmFtZXdvcmtTZXJ2aWNlLmV2ZW50TGlzdG5lcih0aGlzLmZyYW1ld29ya1NlcnZpY2UuRnVuY0Nsb3NlZCwgZSA9PiB7XHJcbiAgICAgIGlmICghZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLm9uQ2xvc2VkLm5leHQoZSk7XHJcbiAgICAgIGNvbnN0IGlkID0gdGhpcy5nZXRPcmlnaW5hbElkKGUuaWQpIHx8IGUudGFiSWQ7XHJcbiAgICAgIGlmIChtZW51SWQgPT09IGlkKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IG1lbnVTdGF0ZSA9IHRoaXMubWVudVN0YXRlU2VydmljZS5nZXRNZW51U3RhdGUobWVudUlkLCBpZCk7XHJcbiAgICAgIC8vICYmIGlkICE9PSB0aGlzLmxhc3RDbG9zZUlkXHJcbiAgICAgIGlmICghIWlkICYmICEhbWVudVN0YXRlICYmIG1lbnVTdGF0ZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgdGhpcy5yZW1vdmVNZW51U3RhdGUoaWQpO1xyXG4gICAgICAgIHRoaXMuZm9ybVJlbG9hZCgpO1xyXG4gICAgICAgIHRoaXMubGFzdENsb3NlSWQgPSBpZDtcclxuICAgICAgfVxyXG4gICAgfSwgcGFyYW1zKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVtb3ZlTWVudVN0YXRlKHRhYklkOiBzdHJpbmcpIHtcclxuICAgIGlmICh0aGlzWydjb250ZXh0J10pIHtcclxuICAgICAgdGhpcy5tZW51U3RhdGVTZXJ2aWNlLnJlbW92ZU1lbnUodGFiSWQpO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bljp/lp4vlip/og71pZFxyXG4gICAqIEBwYXJhbSBpZCBpZFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0T3JpZ2luYWxJZChpZDogc3RyaW5nKSB7XHJcbiAgICBpZiAoIWlkKSB7XHJcbiAgICAgIHJldHVybiBpZDtcclxuICAgIH1cclxuICAgIGlmIChpZC5pbmRleE9mKCdfJykgIT09IC0xKSB7XHJcbiAgICAgIGlkID0gaWQuc3BsaXQoJ18nKVswXTtcclxuICAgIH1cclxuICAgIHJldHVybiBpZDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yi35paw57uE5Lu25pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmb3JtUmVsb2FkKCkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgdGhpc1snY29udGV4dCddWydmcmFtZUNvbnRleHQnXVsnYXBwQ29udGV4dCddWydyZWZyZXNoJ10oKTtcclxuICAgIH0gY2F0Y2h7IH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5omT5byA5Yqf6IO96I+c5Y2VXHJcbiAgICogQHBhcmFtIGZ1bmNJZCDoj5zljZXlhoXnoIFcclxuICAgKiBAcGFyYW0gcGFyYW1zIOi3r+eUseWPguaVsO+8jOW9ouWmgu+8miB7IGtleTE6IHZhbDEsIGtleTI6IHZhbHVlMiB9XHJcbiAgICovXHJcbiAgcHVibGljIG9wZW5NZW51KGZ1bmNJZDogc3RyaW5nLCBwYXJhbXM6IGFueSwgcmVsb2FkPzogYm9vbGVhbikge1xyXG4gICAgaWYgKHR5cGVvZiByZWxvYWQgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiByZWxvYWQgIT09ICdib29sZWFuJykge1xyXG4gICAgICByZWxvYWQgPSBmYWxzZTtcclxuICAgIH1cclxuICAgIGNvbnN0IHBhcmFtc01hcCA9IHRoaXMuYnVpbGRQYXJhbU1hcChwYXJhbXMpO1xyXG4gICAgY29uc3QgcGFyZW50TWVudUlkID0gdGhpcy5nZXRGdW5jSWQoKSB8fCB0aGlzLmdldEFwcElkKCk7XHJcbiAgICB0aGlzLm1lbnVTdGF0ZVNlcnZpY2UuYWRkTWVudVN0YXRlKHBhcmVudE1lbnVJZCwgZnVuY0lkKTtcclxuICAgIHBhcmFtc01hcC5zZXQoJ1dFQl9GT1JNX1JPVVRFUl9QQVJFTlRfSUQnLCBwYXJlbnRNZW51SWQpO1xyXG4gICAgdGhpcy5mcmFtZXdvcmtTZXJ2aWNlLm9wZW5GdW5jV2l0aFBhcmFtKGZ1bmNJZCwgcGFyYW1zTWFwLCByZWxvYWQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5omT5byA5bqU55SoXHJcbiAgICogQHBhcmFtIGFwcElkIOW6lOeUqOWGheeggVxyXG4gICAqIEBwYXJhbSBhcHBFbnRyYW5jZSDlupTnlKjlhaXlj6NcclxuICAgKiBAcGFyYW0gcGFyYW1zIOi3r+eUseWPguaVsO+8jOW9ouWmgu+8miB7IGtleTE6IHZhbDEsIGtleTI6IHZhbHVlMiB9XHJcbiAgICovXHJcbiAgcHVibGljIG9wZW5BcHAoYXBwSWQ6IHN0cmluZywgYXBwRW50cmFuY2U6IHN0cmluZywgcGFyYW1zOiBhbnksIHJlbG9hZD86IGJvb2xlYW4pIHtcclxuICAgIGlmICh0eXBlb2YgcmVsb2FkID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgcmVsb2FkICE9PSAnYm9vbGVhbicpIHtcclxuICAgICAgcmVsb2FkID0gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXJhbU1hcCA9IHRoaXMuYnVpbGRQYXJhbU1hcChwYXJhbXMpO1xyXG4gICAgY29uc3QgcGFyZW50TWVudUlkID0gdGhpcy5nZXRBcHBJZCgpIHx8IHRoaXMuZ2V0RnVuY0lkKCk7XHJcbiAgICB0aGlzLm1lbnVTdGF0ZVNlcnZpY2UuYWRkTWVudVN0YXRlKHBhcmVudE1lbnVJZCwgYXBwSWQpO1xyXG4gICAgcGFyYW1NYXAuc2V0KCdXRUJfRk9STV9ST1VURVJfUEFSRU5UX0lEJywgcGFyZW50TWVudUlkKTtcclxuICAgIGlmICghIXRoaXMuYXBwU2VydmljZSkge1xyXG4gICAgICB0aGlzLmFwcFNlcnZpY2Uub3BlbkFwcChhcHBJZCwgYXBwRW50cmFuY2UsIHBhcmFtTWFwLCByZWxvYWQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Y+C5pWwXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZFBhcmFtTWFwKHBhcmFtczogYW55KTogTWFwPHN0cmluZywgc3RyaW5nPiB7XHJcbiAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFyYW1zID09PSBudWxsIHx8ICh0eXBlb2YgcGFyYW1zID09PSAnc3RyaW5nJyAmJiBwYXJhbXMubGVuZ3RoIDwgMSkpIHtcclxuICAgICAgcGFyYW1zID0ge307XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXJhbU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcbiAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgcGFyYW1zID0gSlNPTi5zdHJpbmdpZnkocGFyYW1zKTtcclxuICAgIH1cclxuICAgIHBhcmFtcyA9IHdpbmRvd1snZW5jb2RlVVJJQ29tcG9uZW50J10ocGFyYW1zKTtcclxuICAgIHBhcmFtTWFwLnNldCgnV0VCX0ZPUk1fUk9VVEVfUEFSQU1TJywgcGFyYW1zKTtcclxuICAgIHJldHVybiBwYXJhbU1hcDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWFs+mXreWKn+iDveiPnOWNlVxyXG4gICAqL1xyXG4gIHB1YmxpYyBjbG9zZU1lbnUoKSB7XHJcbiAgICBjb25zdCBmdW5jSWQ6IHN0cmluZyB8IG51bGwgPSB0aGlzLmdldEZ1bmNJZCgpO1xyXG4gICAgY29uc3QgYXBwSWQ6IHN0cmluZyB8IG51bGwgPSB0aGlzLmdldEFwcElkKCk7XHJcbiAgICBjb25zdCB7IGlzRGlhbG9nQ29tcG9uZW50LCByb290Q29tcG9uZW50IH0gPSB0aGlzLmZpbmREaWFsb2coKTtcclxuICAgIGlmIChpc0RpYWxvZ0NvbXBvbmVudCkge1xyXG4gICAgICBjb25zdCBtb2RhbFJlZiA9IHRoaXMuZ2V0KHJvb3RDb21wb25lbnQsICdkaWFsb2dSZWYnKTtcclxuICAgICAgbW9kYWxSZWZbJ2Nsb3NlJ10oKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChmdW5jSWQgIT09IG51bGwgJiYgdHlwZW9mIGZ1bmNJZCA9PT0gJ3N0cmluZycgJiYgZnVuY0lkLmxlbmd0aCA+IDApIHtcclxuICAgICAgdGhpcy5jbG9zZUZ1bmMoZnVuY0lkKTtcclxuICAgIH0gZWxzZSBpZiAoYXBwSWQgIT09IG51bGwgJiYgdHlwZW9mIGFwcElkID09PSAnc3RyaW5nJyAmJiBhcHBJZC5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGNvbnN0IGFwcEVudHJhbmNlID0gdGhpcy5nZXRBcHBFbnRyYW5jZSgpO1xyXG4gICAgICB0aGlzLmNsb3NlQXBwKGFwcElkLCBhcHBFbnRyYW5jZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zb2xlLmVycm9yKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlWydub3RTdXBwb3J0TWVudVR5cGUnXSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmn6Xmib7lvLnnqpfnu4Tku7ZcclxuICAgKi9cclxuICBwcml2YXRlIGZpbmREaWFsb2coKSB7XHJcbiAgICBsZXQgZnJhbWVDb250ZXh0ID0gdGhpcy5nZXQodGhpcywgJ2NvbnRleHQuZnJhbWVDb250ZXh0Jyk7XHJcbiAgICBsZXQgaXNEaWFsb2dDb21wb25lbnQgPSB0aGlzLmdldChmcmFtZUNvbnRleHQsICdmcmFtZUNvbXBvbmVudC5pc0RpYWxvZ1Jvb3RDb21wb25lbnQnLCBmYWxzZSk7XHJcblxyXG4gICAgbGV0IHBhcmVudEZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0KGZyYW1lQ29udGV4dCwgJ3BhcmVudCcpO1xyXG4gICAgd2hpbGUgKHBhcmVudEZyYW1lQ29udGV4dCAhPSBudWxsICYmICFpc0RpYWxvZ0NvbXBvbmVudCkge1xyXG4gICAgICBmcmFtZUNvbnRleHQgPSB0aGlzLmdldChmcmFtZUNvbnRleHQsICdwYXJlbnQnKTtcclxuICAgICAgcGFyZW50RnJhbWVDb250ZXh0ID0gdGhpcy5nZXQocGFyZW50RnJhbWVDb250ZXh0LCAncGFyZW50Jyk7XHJcbiAgICAgIGlzRGlhbG9nQ29tcG9uZW50ID0gdGhpcy5nZXQoZnJhbWVDb250ZXh0LCAnZnJhbWVDb21wb25lbnQuaXNEaWFsb2dSb290Q29tcG9uZW50JywgZmFsc2UpO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgcm9vdENvbXBvbmVudCA9IHRoaXMuZ2V0KGZyYW1lQ29udGV4dCwgJ2ZyYW1lQ29tcG9uZW50Jyk7XHJcbiAgICByZXR1cm4geyBpc0RpYWxvZ0NvbXBvbmVudCwgcm9vdENvbXBvbmVudCB9O1xyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIGxvYWRzaCBnZXRcclxuICAgKiBAcGFyYW0gb2JqZWN0IOWvueixoVxyXG4gICAqIEBwYXJhbSBwYXRoIOi3r+W+hFxyXG4gICAqIEBwYXJhbSBkZWZhdWx0VmFsIOm7mOiupOWAvFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0KG9iamVjdDogYW55LCBwYXRoOiBBcnJheTxzdHJpbmc+IHwgc3RyaW5nLCBkZWZhdWx0VmFsOiBhbnkgPSBudWxsKSB7XHJcbiAgICBjb25zdCBQQVRIID0gQXJyYXkuaXNBcnJheShwYXRoKVxyXG4gICAgICA/IHBhdGhcclxuICAgICAgOiBwYXRoLnNwbGl0KCcuJykuZmlsdGVyKGkgPT4gaS5sZW5ndGgpO1xyXG4gICAgaWYgKCFQQVRILmxlbmd0aCkge1xyXG4gICAgICByZXR1cm4gb2JqZWN0ID09PSB1bmRlZmluZWQgPyBkZWZhdWx0VmFsIDogb2JqZWN0O1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChvYmplY3QgPT09IG51bGwgfHwgb2JqZWN0ID09PSB1bmRlZmluZWQgfHwgdHlwZW9mIChvYmplY3RbUEFUSFswXV0pID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICByZXR1cm4gZGVmYXVsdFZhbDtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGhpcy5nZXQob2JqZWN0W1BBVEguc2hpZnQoKV0sIFBBVEgsIGRlZmF1bHRWYWwpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5YWz6Zet6I+c5Y2VXHJcbiAgICogQHBhcmFtIGZ1bmNJZCDoj5zljZVpZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjbG9zZUZ1bmMoZnVuY0lkPzogc3RyaW5nKSB7XHJcbiAgICBpZiAoIWZ1bmNJZCkge1xyXG4gICAgICBmdW5jSWQgPSB0aGlzLmdldEZ1bmNJZCgpO1xyXG4gICAgfVxyXG4gICAgaWYgKCEhdGhpcy5mcmFtZXdvcmtTZXJ2aWNlKSB7XHJcbiAgICAgIHRoaXMuZnJhbWV3b3JrU2VydmljZS5jbG9zZUZ1bmMoZnVuY0lkKS5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWFs+mXrWFwcFxyXG4gICAqIEBwYXJhbSBhcHBJZCDlupTnlKhpZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjbG9zZUFwcChhcHBJZD86IHN0cmluZywgYXBwRW50cmFuY2U/OiBzdHJpbmcpIHtcclxuICAgIGlmICghYXBwSWQpIHtcclxuICAgICAgYXBwSWQgPSB0aGlzLmdldEFwcElkKCk7XHJcbiAgICB9XHJcbiAgICBpZiAodHlwZW9mIGFwcEVudHJhbmNlID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICBhcHBFbnRyYW5jZSA9IHRoaXMuZ2V0QXBwRW50cmFuY2UoKTtcclxuICAgIH1cclxuICAgIGlmICghIXRoaXMuYXBwU2VydmljZSkge1xyXG4gICAgICB0aGlzLmFwcFNlcnZpY2UuY2xvc2VBcHAoYXBwSWQsIGFwcEVudHJhbmNlKS5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuvue9ruWPguaVsFxyXG4gICAqIEBwYXJhbSBwYXJhbXMg6Lev55Sx5Y+C5pWwXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzZXRQYXJhbXModXJsOiBzdHJpbmcsIHBhcmFtczogc3RyaW5nIHwgeyBba2V5OiBzdHJpbmddOiBhbnk7IH0pIHtcclxuICAgIGxldCBwYXJhbXNPYmo7XHJcbiAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ3N0cmluZycgJiYgcGFyYW1zICE9PSAnJykge1xyXG4gICAgICBwYXJhbXNPYmogPSBKU09OLnBhcnNlKHBhcmFtcyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBwYXJhbXNPYmogPSBwYXJhbXMgfHwge307XHJcbiAgICB9XHJcblxyXG4gICAgLy8g6K6+572u6Lev55Sx5Y+C5pWwXHJcbiAgICB0aGlzLnJvdXRlclBhcmFtU2VydmljZS5zZXRQYXJhbXModXJsLCBwYXJhbXNPYmopO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+WZnVuY0lkXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRGdW5jSWQoKSB7XHJcbiAgICBjb25zdCBoYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2g7XHJcbiAgICBpZiAoIWhhc2gpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXJhbXMgPSB0aGlzLmRlY29kZVVSTFBhcmFtcyhoYXNoKTtcclxuICAgIGlmIChwYXJhbXMgJiYgcGFyYW1zLmhhc093blByb3BlcnR5KCdmdW5jSWQnKSkge1xyXG4gICAgICByZXR1cm4gcGFyYW1zLmZ1bmNJZDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+WYXBwSWRcclxuICAgKi9cclxuICBwcml2YXRlIGdldEFwcElkKCkge1xyXG4gICAgY29uc3QgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoO1xyXG4gICAgaWYgKCFoYXNoKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcGFyYW1zID0gdGhpcy5kZWNvZGVVUkxQYXJhbXMoaGFzaCk7XHJcbiAgICBpZiAocGFyYW1zICYmIHBhcmFtcy5oYXNPd25Qcm9wZXJ0eSgnYXBwSWQnKSkge1xyXG4gICAgICByZXR1cm4gcGFyYW1zLmFwcElkO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldFBhcmVudE1lbnVJZCgpIHtcclxuICAgIGNvbnN0IGhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaDtcclxuICAgIGlmICghaGFzaCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuZGVjb2RlVVJMUGFyYW1zKGhhc2gpO1xyXG4gICAgaWYgKHBhcmFtcyAmJiBwYXJhbXMuaGFzT3duUHJvcGVydHkoJ1dFQl9GT1JNX1JPVVRFUl9QQVJFTlRfSUQnKSkge1xyXG4gICAgICByZXR1cm4gcGFyYW1zLldFQl9GT1JNX1JPVVRFUl9QQVJFTlRfSUQ7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5bqU55So5YWl5Y+jXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRBcHBFbnRyYW5jZSgpIHtcclxuICAgIGNvbnN0IGhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaDtcclxuICAgIGlmICghaGFzaCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuZGVjb2RlVVJMUGFyYW1zKGhhc2gpO1xyXG4gICAgaWYgKHBhcmFtcyAmJiBwYXJhbXMuaGFzT3duUHJvcGVydHkoJ2FwcEVudHJhbmNlJykpIHtcclxuICAgICAgcmV0dXJuIHBhcmFtcy5hcHBFbnRyYW5jZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDop6PnoIHlj4LmlbBcclxuICAgKiBAcGFyYW0gcXVlcnkgc2VhcmNofGhhc2hcclxuICAgKi9cclxuICBwcml2YXRlIGRlY29kZVVSTFBhcmFtcyhxdWVyeTogc3RyaW5nKTogeyBbcHJvcE5hbWU6IHN0cmluZ106IGFueSB9IHtcclxuICAgIGlmICh0eXBlb2YgcXVlcnkgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIHF1ZXJ5ID0gd2luZG93LmxvY2F0aW9uLmhhc2ggfHwgd2luZG93LmxvY2F0aW9uLnNlYXJjaDtcclxuICAgIH1cclxuICAgIGNvbnN0IGhhc2hlcyA9IHF1ZXJ5LnNsaWNlKHF1ZXJ5LmluZGV4T2YoJz8nKSArIDEpLnNwbGl0KCcmJyk7XHJcbiAgICByZXR1cm4gaGFzaGVzLnJlZHVjZSgocGFyYW1zLCBoYXNoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHNwbGl0ID0gaGFzaC5pbmRleE9mKCc9Jyk7XHJcbiAgICAgIGNvbnN0IGtleSA9IGhhc2guc2xpY2UoMCwgc3BsaXQpO1xyXG4gICAgICBjb25zdCB2YWwgPSBoYXNoLnNsaWNlKHNwbGl0ICsgMSk7XHJcbiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHBhcmFtcywgeyBba2V5XTogZGVjb2RlVVJJQ29tcG9uZW50KHZhbCkgfSk7XHJcbiAgICB9LCB7fSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0UGFyYW1zKHF1ZXJ5U3RyaW5nOiBzdHJpbmcpOiB7IFtwcm9wTmFtZTogc3RyaW5nXTogYW55IH0ge1xyXG4gICAgaWYgKCFxdWVyeVN0cmluZykge1xyXG4gICAgICByZXR1cm4ge307XHJcbiAgICB9XHJcbiAgICBjb25zdCBoYXNoZXMgPSBxdWVyeVN0cmluZy5zbGljZShxdWVyeVN0cmluZy5pbmRleE9mKCc/JykgKyAxKS5zcGxpdCgnJicpO1xyXG4gICAgcmV0dXJuIGhhc2hlcy5yZWR1Y2UoKHBhcmFtcywgaGFzaCkgPT4ge1xyXG4gICAgICBjb25zdCBzcGxpdCA9IGhhc2guaW5kZXhPZignPScpO1xyXG4gICAgICBjb25zdCBrZXkgPSBoYXNoLnNsaWNlKDAsIHNwbGl0KTtcclxuICAgICAgY29uc3QgdmFsID0gaGFzaC5zbGljZShzcGxpdCArIDEpO1xyXG4gICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihwYXJhbXMsIHsgW2tleV06IGRlY29kZVVSSUNvbXBvbmVudCh2YWwpIH0pO1xyXG4gICAgfSwge30pO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgUm91dGVyU2VydmljZSB9O1xyXG4iXX0=