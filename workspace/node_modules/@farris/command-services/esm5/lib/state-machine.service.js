import { Injectable, ElementRef } from '@angular/core';
import { StateMachine } from '@farris/devkit';
// tslint:disable: max-line-length
/**
 * 状态机服务
 * @scope FrameComponent
 */
var StateMachineService = /** @class */ (function () {
    function StateMachineService(stateMachine) {
        var _this = this;
        this.stateMachine = stateMachine;
        this._clsDefaultName = 'f-form-state-default';
        this._initLoad = true;
        if (this.stateMachine.initialState.name === 'init') {
            window.setTimeout(function () {
                _this.initFormState();
            }, 0);
        }
    }
    StateMachineService.prototype.transit = function (action) {
        if (action && typeof this.stateMachine[action] === 'function') {
            this.stateMachine[action]();
            this._currentFrameContext = this['context'] && this['context']['frameContext'];
            if (this._initLoad) {
                this.initFormState();
                this._initLoad = false;
            }
            if (!this._currentFrameContext) {
                return;
            }
            var currentRootFrameContext = this.getCurrentRootFrameContext(this._currentFrameContext);
            if (!!currentRootFrameContext) {
                this.toggleFormState(action, currentRootFrameContext);
            }
        }
    };
    StateMachineService.prototype.getCurrentRootFrameContext = function (currentFrameContext) {
        var currentRootFrameContext;
        this.getAllRootFrameContext().forEach(function (rootFc) {
            if (currentFrameContext.namespace === rootFc.namespace) {
                currentRootFrameContext = rootFc;
            }
        });
        return currentRootFrameContext;
    };
    StateMachineService.prototype.getFrameContextManagerMap = function () {
        if (this.stateMachine && this.stateMachine.frameContext) {
            var appContext = this.stateMachine.frameContext.appContext;
            if (appContext) {
                var frameContextManager = appContext.frameContextManager;
                return frameContextManager.getFrameContextMap();
            }
        }
        return null;
        // return this.stateMachine && this.stateMachine.frameContext && this.stateMachine.frameContext.appContext && this.stateMachine.frameContext.appContext.frameContextManager && this.stateMachine.frameContext.appContext.frameContextManager.getFrameContextMap();
    };
    StateMachineService.prototype.getAllRootFrameContext = function () {
        var rootFrameContextArr = [];
        var frameContexts = this.getFrameContextManagerMap();
        if (frameContexts) {
            frameContexts.forEach(function (item) {
                if ((item['namespace'] === '' && item['parent'] === null) || (item['parent'] !== null && item['namespace'] !== item['parent']['namespace'])) {
                    rootFrameContextArr.push(item);
                }
            });
        }
        return rootFrameContextArr;
    };
    StateMachineService.prototype.initFormState = function () {
        var _this = this;
        if (!this.getFrameContextManagerMap()) {
            return;
        }
        this.getAllRootFrameContext().forEach(function (rootFc) {
            var rootComponent = rootFc.injector.get(ElementRef, null) || null;
            if (!rootComponent || !rootComponent.nativeElement) {
                return;
            }
            if (!rootComponent.nativeElement.className.includes(_this._clsDefaultName) && !rootComponent.nativeElement.className.includes('f-form-state-create') && !rootComponent.nativeElement.className.includes('f-form-state-edit')) {
                _this.addCssClass(rootComponent, _this._clsDefaultName);
            }
        });
    };
    StateMachineService.prototype.toggleFormState = function (action, frameContext) {
        var _this = this;
        var rootComponent = frameContext.injector.get(ElementRef, null) || null;
        if (!rootComponent || !rootComponent.nativeElement || !action) {
            return;
        }
        action = action.toLowerCase();
        if (action && ['create', 'edit'].includes(action)) {
            if (action === 'create') {
                this.addCssClass(rootComponent, 'f-form-state-create');
            }
            else if (action === 'edit') {
                this.addCssClass(rootComponent, 'f-form-state-edit');
            }
            this.removeCssClass(rootComponent, this._clsDefaultName);
        }
        else {
            ['f-form-state-create', 'f-form-state-edit'].forEach(function (item) { return _this.removeCssClass(rootComponent, item); });
            this.addCssClass(rootComponent, this._clsDefaultName);
        }
    };
    StateMachineService.prototype.addCssClass = function (elementRef, className) {
        if (!elementRef || !className || !elementRef.nativeElement) {
            return;
        }
        var originalClassName = elementRef.nativeElement.className || '';
        if (!originalClassName.includes(className)) {
            elementRef.nativeElement.className = originalClassName + " " + className;
        }
    };
    StateMachineService.prototype.removeCssClass = function (elementRef, className) {
        if (!elementRef || !className || !elementRef.nativeElement) {
            return;
        }
        var originalClassName = elementRef.nativeElement.className || '';
        if (originalClassName.includes(className)) {
            elementRef.nativeElement.className = originalClassName.split(' ').filter(function (p) { return p && p !== className; }).join(' ');
        }
    };
    StateMachineService.prototype.getFormRootComponent = function () {
        if (this.stateMachine && this.stateMachine.frameContext) {
            var viewContext = this.stateMachine.frameContext;
            if (viewContext) {
                var virtualRootContext = viewContext.getVirtualRootFrameContext();
                if (virtualRootContext) {
                    var injector = virtualRootContext.injector;
                    if (typeof injector.get === 'function') {
                        return injector.get(ElementRef, null);
                    }
                }
            }
        }
        return null;
        // return this.stateMachine && this.stateMachine.frameContext && this.stateMachine.frameContext.getVirtualRootFrameContext() && this.stateMachine.frameContext.getVirtualRootFrameContext().injector && typeof this.stateMachine.frameContext.getVirtualRootFrameContext().injector.get === 'function' && this.stateMachine.frameContext.getVirtualRootFrameContext().injector.get<ElementRef>(ElementRef, null) || null;
    };
    StateMachineService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    StateMachineService.ctorParameters = function () { return [
        { type: StateMachine }
    ]; };
    return StateMachineService;
}());
export { StateMachineService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUtbWFjaGluZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL3N0YXRlLW1hY2hpbmUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RCxPQUFPLEVBQUUsWUFBWSxFQUE0QixNQUFNLGdCQUFnQixDQUFDO0FBQ3hFLGtDQUFrQztBQUNsQzs7O0dBR0c7QUFDSDtJQUdFLDZCQUNVLFlBQTBCO1FBRHBDLGlCQVFDO1FBUFMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFTNUIsb0JBQWUsR0FBRyxzQkFBc0IsQ0FBQztRQUN6QyxjQUFTLEdBQUcsSUFBSSxDQUFDO1FBUnZCLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRTtZQUNsRCxNQUFNLENBQUMsVUFBVSxDQUFDO2dCQUNoQixLQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDdkIsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ1A7SUFDSCxDQUFDO0lBTUQscUNBQU8sR0FBUCxVQUFRLE1BQWM7UUFDcEIsSUFBSSxNQUFNLElBQUksT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxLQUFLLFVBQVUsRUFBRTtZQUM3RCxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDNUIsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDL0UsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO2dCQUNsQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7Z0JBQ3JCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO2FBQ3hC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b0JBQ3RCLElBQU0sUUFBUSxHQUFHLGtCQUFrQixDQUFDLFFBQVEsQ0FBQztvQkFDN0MsSUFBSSxPQUFPLFFBQVEsQ0FBQyxHQUFHLEtBQUssVUFBVSxFQUFFO3dCQUN0QyxPQUFPLFFBQVEsQ0FBQyxHQUFHLENBQWEsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO3FCQUNuRDtpQkFDRjthQUNGO1NBQ0Y7UUFDRCxPQUFPLElBQUksQ0FBQztRQUNaLHlaQUF5WjtJQUMzWixDQUFDOztnQkF4SUYsVUFBVTs7OztnQkFORixZQUFZOztJQStJckIsMEJBQUM7Q0FBQSxBQXpJRCxJQXlJQztBQUVELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgRWxlbWVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBTdGF0ZU1hY2hpbmUsIEZyYW1lQ29udGV4dCwgQXBwQ29udGV4dCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuLy8gdHNsaW50OmRpc2FibGU6IG1heC1saW5lLWxlbmd0aFxyXG4vKipcclxuICog54q25oCB5py65pyN5YqhXHJcbiAqIEBzY29wZSBGcmFtZUNvbXBvbmVudFxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5jbGFzcyBTdGF0ZU1hY2hpbmVTZXJ2aWNlIHtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIHN0YXRlTWFjaGluZTogU3RhdGVNYWNoaW5lXHJcbiAgKSB7XHJcbiAgICBpZiAodGhpcy5zdGF0ZU1hY2hpbmUuaW5pdGlhbFN0YXRlLm5hbWUgPT09ICdpbml0Jykge1xyXG4gICAgICB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5pbml0Rm9ybVN0YXRlKCk7XHJcbiAgICAgIH0sIDApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfY2xzRGVmYXVsdE5hbWUgPSAnZi1mb3JtLXN0YXRlLWRlZmF1bHQnO1xyXG4gIHByaXZhdGUgX2luaXRMb2FkID0gdHJ1ZTtcclxuICBwcml2YXRlIF9jdXJyZW50RnJhbWVDb250ZXh0OiBhbnlcclxuXHJcbiAgdHJhbnNpdChhY3Rpb246IHN0cmluZykge1xyXG4gICAgaWYgKGFjdGlvbiAmJiB0eXBlb2YgdGhpcy5zdGF0ZU1hY2hpbmVbYWN0aW9uXSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICB0aGlzLnN0YXRlTWFjaGluZVthY3Rpb25dKCk7XHJcbiAgICAgIHRoaXMuX2N1cnJlbnRGcmFtZUNvbnRleHQgPSB0aGlzWydjb250ZXh0J10gJiYgdGhpc1snY29udGV4dCddWydmcmFtZUNvbnRleHQnXTtcclxuICAgICAgaWYgKHRoaXMuX2luaXRMb2FkKSB7XHJcbiAgICAgICAgdGhpcy5pbml0Rm9ybVN0YXRlKCk7XHJcbiAgICAgICAgdGhpcy5faW5pdExvYWQgPSBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoIXRoaXMuX2N1cnJlbnRGcmFtZUNvbnRleHQpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgY3VycmVudFJvb3RGcmFtZUNvbnRleHQgPSB0aGlzLmdldEN1cnJlbnRSb290RnJhbWVDb250ZXh0KHRoaXMuX2N1cnJlbnRGcmFtZUNvbnRleHQpO1xyXG4gICAgICBpZiAoISFjdXJyZW50Um9vdEZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgIHRoaXMudG9nZ2xlRm9ybVN0YXRlKGFjdGlvbiwgY3VycmVudFJvb3RGcmFtZUNvbnRleHQpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEN1cnJlbnRSb290RnJhbWVDb250ZXh0KGN1cnJlbnRGcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCk6IEZyYW1lQ29udGV4dCB7XHJcbiAgICBsZXQgY3VycmVudFJvb3RGcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dDtcclxuICAgIHRoaXMuZ2V0QWxsUm9vdEZyYW1lQ29udGV4dCgpLmZvckVhY2goKHJvb3RGYzogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgIGlmIChjdXJyZW50RnJhbWVDb250ZXh0Lm5hbWVzcGFjZSA9PT0gcm9vdEZjLm5hbWVzcGFjZSkge1xyXG4gICAgICAgIGN1cnJlbnRSb290RnJhbWVDb250ZXh0ID0gcm9vdEZjO1xyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gICAgcmV0dXJuIGN1cnJlbnRSb290RnJhbWVDb250ZXh0O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRGcmFtZUNvbnRleHRNYW5hZ2VyTWFwKCkge1xyXG4gICAgaWYgKHRoaXMuc3RhdGVNYWNoaW5lICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dCkge1xyXG4gICAgICBjb25zdCBhcHBDb250ZXh0ID0gdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0LmFwcENvbnRleHQgYXMgQXBwQ29udGV4dDtcclxuICAgICAgaWYgKGFwcENvbnRleHQpIHtcclxuICAgICAgICBjb25zdCBmcmFtZUNvbnRleHRNYW5hZ2VyID0gYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyO1xyXG4gICAgICAgIHJldHVybiBmcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dE1hcCgpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICAgIC8vIHJldHVybiB0aGlzLnN0YXRlTWFjaGluZSAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0LmFwcENvbnRleHQgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlciAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dE1hcCgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRBbGxSb290RnJhbWVDb250ZXh0KCk6IGFueVtdIHtcclxuICAgIGNvbnN0IHJvb3RGcmFtZUNvbnRleHRBcnIgPSBbXTtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dHMgPSB0aGlzLmdldEZyYW1lQ29udGV4dE1hbmFnZXJNYXAoKTtcclxuICAgIGlmIChmcmFtZUNvbnRleHRzKSB7XHJcbiAgICAgIGZyYW1lQ29udGV4dHMuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICBpZiAoKGl0ZW1bJ25hbWVzcGFjZSddID09PSAnJyAmJiBpdGVtWydwYXJlbnQnXSA9PT0gbnVsbCkgfHwgKGl0ZW1bJ3BhcmVudCddICE9PSBudWxsICYmIGl0ZW1bJ25hbWVzcGFjZSddICE9PSBpdGVtWydwYXJlbnQnXVsnbmFtZXNwYWNlJ10pKSB7XHJcbiAgICAgICAgICByb290RnJhbWVDb250ZXh0QXJyLnB1c2goaXRlbSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJvb3RGcmFtZUNvbnRleHRBcnI7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRGb3JtU3RhdGUoKSB7XHJcbiAgICBpZiAoIXRoaXMuZ2V0RnJhbWVDb250ZXh0TWFuYWdlck1hcCgpKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuZ2V0QWxsUm9vdEZyYW1lQ29udGV4dCgpLmZvckVhY2goKHJvb3RGYzogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgIGNvbnN0IHJvb3RDb21wb25lbnQgPSByb290RmMuaW5qZWN0b3IuZ2V0PEVsZW1lbnRSZWY+KEVsZW1lbnRSZWYsIG51bGwpIHx8IG51bGw7XHJcbiAgICAgIGlmICghcm9vdENvbXBvbmVudCB8fCAhcm9vdENvbXBvbmVudC5uYXRpdmVFbGVtZW50KSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICghcm9vdENvbXBvbmVudC5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZS5pbmNsdWRlcyh0aGlzLl9jbHNEZWZhdWx0TmFtZSkgJiYgIXJvb3RDb21wb25lbnQubmF0aXZlRWxlbWVudC5jbGFzc05hbWUuaW5jbHVkZXMoJ2YtZm9ybS1zdGF0ZS1jcmVhdGUnKSAmJiAhcm9vdENvbXBvbmVudC5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZS5pbmNsdWRlcygnZi1mb3JtLXN0YXRlLWVkaXQnKSkge1xyXG4gICAgICAgIHRoaXMuYWRkQ3NzQ2xhc3Mocm9vdENvbXBvbmVudCwgdGhpcy5fY2xzRGVmYXVsdE5hbWUpO1xyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB0b2dnbGVGb3JtU3RhdGUoYWN0aW9uOiBzdHJpbmcsIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSB7XHJcbiAgICBjb25zdCByb290Q29tcG9uZW50ID0gZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxFbGVtZW50UmVmPihFbGVtZW50UmVmLCBudWxsKSB8fCBudWxsO1xyXG4gICAgaWYgKCFyb290Q29tcG9uZW50IHx8ICFyb290Q29tcG9uZW50Lm5hdGl2ZUVsZW1lbnQgfHwgIWFjdGlvbikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBhY3Rpb24gPSBhY3Rpb24udG9Mb3dlckNhc2UoKTtcclxuICAgIGlmIChhY3Rpb24gJiYgWydjcmVhdGUnLCAnZWRpdCddLmluY2x1ZGVzKGFjdGlvbikpIHtcclxuICAgICAgaWYgKGFjdGlvbiA9PT0gJ2NyZWF0ZScpIHtcclxuICAgICAgICB0aGlzLmFkZENzc0NsYXNzKHJvb3RDb21wb25lbnQsICdmLWZvcm0tc3RhdGUtY3JlYXRlJyk7XHJcbiAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnZWRpdCcpIHtcclxuICAgICAgICB0aGlzLmFkZENzc0NsYXNzKHJvb3RDb21wb25lbnQsICdmLWZvcm0tc3RhdGUtZWRpdCcpO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMucmVtb3ZlQ3NzQ2xhc3Mocm9vdENvbXBvbmVudCwgdGhpcy5fY2xzRGVmYXVsdE5hbWUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgWydmLWZvcm0tc3RhdGUtY3JlYXRlJywgJ2YtZm9ybS1zdGF0ZS1lZGl0J10uZm9yRWFjaChpdGVtID0+IHRoaXMucmVtb3ZlQ3NzQ2xhc3Mocm9vdENvbXBvbmVudCwgaXRlbSkpO1xyXG4gICAgICB0aGlzLmFkZENzc0NsYXNzKHJvb3RDb21wb25lbnQsIHRoaXMuX2Nsc0RlZmF1bHROYW1lKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBhZGRDc3NDbGFzcyhlbGVtZW50UmVmOiBFbGVtZW50UmVmLCBjbGFzc05hbWU6IHN0cmluZykge1xyXG4gICAgaWYgKCFlbGVtZW50UmVmIHx8ICFjbGFzc05hbWUgfHwgIWVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBvcmlnaW5hbENsYXNzTmFtZTogc3RyaW5nID0gZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZSB8fCAnJztcclxuICAgIGlmICghb3JpZ2luYWxDbGFzc05hbWUuaW5jbHVkZXMoY2xhc3NOYW1lKSkge1xyXG4gICAgICBlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lID0gYCR7b3JpZ2luYWxDbGFzc05hbWV9ICR7Y2xhc3NOYW1lfWA7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgcmVtb3ZlQ3NzQ2xhc3MoZWxlbWVudFJlZjogRWxlbWVudFJlZiwgY2xhc3NOYW1lOiBzdHJpbmcpIHtcclxuICAgIGlmICghZWxlbWVudFJlZiB8fCAhY2xhc3NOYW1lIHx8ICFlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgb3JpZ2luYWxDbGFzc05hbWU6IHN0cmluZyA9IGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc05hbWUgfHwgJyc7XHJcbiAgICBpZiAob3JpZ2luYWxDbGFzc05hbWUuaW5jbHVkZXMoY2xhc3NOYW1lKSkge1xyXG4gICAgICBlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lID0gb3JpZ2luYWxDbGFzc05hbWUuc3BsaXQoJyAnKS5maWx0ZXIocCA9PiBwICYmIHAgIT09IGNsYXNzTmFtZSkuam9pbignICcpO1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIGdldEZvcm1Sb290Q29tcG9uZW50KCkge1xyXG4gICAgaWYgKHRoaXMuc3RhdGVNYWNoaW5lICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dCkge1xyXG4gICAgICBjb25zdCB2aWV3Q29udGV4dCA9IHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dDtcclxuICAgICAgaWYgKHZpZXdDb250ZXh0KSB7XHJcbiAgICAgICAgY29uc3QgdmlydHVhbFJvb3RDb250ZXh0ID0gdmlld0NvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKTtcclxuICAgICAgICBpZiAodmlydHVhbFJvb3RDb250ZXh0KSB7XHJcbiAgICAgICAgICBjb25zdCBpbmplY3RvciA9IHZpcnR1YWxSb290Q29udGV4dC5pbmplY3RvcjtcclxuICAgICAgICAgIGlmICh0eXBlb2YgaW5qZWN0b3IuZ2V0ID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBpbmplY3Rvci5nZXQ8RWxlbWVudFJlZj4oRWxlbWVudFJlZiwgbnVsbCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICAgIC8vIHJldHVybiB0aGlzLnN0YXRlTWFjaGluZSAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkuaW5qZWN0b3IgJiYgdHlwZW9mIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpLmluamVjdG9yLmdldCA9PT0gJ2Z1bmN0aW9uJyAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKS5pbmplY3Rvci5nZXQ8RWxlbWVudFJlZj4oRWxlbWVudFJlZiwgbnVsbCkgfHwgbnVsbDtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IFN0YXRlTWFjaGluZVNlcnZpY2UgfTtcclxuIl19