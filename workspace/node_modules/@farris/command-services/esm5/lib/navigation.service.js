/*
 * @Author: aalizzwell
 * @Date: 2019-08-02 15:31:34
 * @Last Modified by: aalizzwell
 * @Last Modified time: 2020-03-03 09:33:43
 */
import { Injectable, Optional, Injector, ComponentFactoryResolver, ReflectiveInjector } from '@angular/core';
import { Router, ActivatedRoute } from '@angular/router';
import { RuntimeFrameworkService } from './rtf-service';
import { AppType } from '@gsp-sys/rtf-common';
import { MenuStateService } from './menu-state.service';
import { NavigationEventService } from './navigation-event.service';
import { QuerystringService } from './querystring';
import { FrameContext, TranslateToken } from '@farris/devkit';
import { FEPageModalService } from '@farris/extend-page-modal';
import lodash from 'lodash-es';
import { FarrisFormService } from './farris-form.service';
import { LanguageService } from './languag.service';
import { map, switchMap } from 'rxjs/operators';
import { EMPTY, of } from 'rxjs';
import { FormNotifyService } from './form-notify.service';
import { INSIDE_DIALOG_TOKEN, MODAL_REF } from './types';
// tslint:disable: no-string-literal max-line-length
var APP_CONTEXT_MANAGER = 'DEVKIT_APP_CONTEXT_MANAGER';
/**
 * 导航服务
 * @scope FormModule
 */
var NavigationService = /** @class */ (function () {
    function NavigationService(runtimeFrameworkService, menuStateService, navigationEventService, querystringService, frameContext, injector, languageService
    // @Optional() private pageModalService: FEPageModalService,
    // @Optional() private farrisFormService: FarrisFormService,
    // @Optional() private languageService: LanguageService
    ) {
        this.runtimeFrameworkService = runtimeFrameworkService;
        this.menuStateService = menuStateService;
        this.navigationEventService = navigationEventService;
        this.querystringService = querystringService;
        this.frameContext = frameContext;
        this.injector = injector;
        this.languageService = languageService;
        // appId不同于tabId，每次表单实例化时都会重新生成
        var appId = this.formAppContext && this.formAppContext.ApplicationId;
        var tabId = this.querystrings.tabId || this.querystrings.funcId || this.querystrings.appId;
        // 已经编译的表单，使用appId记录hash
        if (appId) {
            var appContextManager = window[APP_CONTEXT_MANAGER] || new Map();
            if (appContextManager && !appContextManager.has(appId)) {
                appContextManager.set(appId, { hash: window.location.hash });
                window[APP_CONTEXT_MANAGER] = appContextManager;
            }
        }
        if (tabId) {
            var formEventServices = window['formEventServices'] || new Map();
            // tabId、appId都存在时，使用appId替换tabId
            if (appId) {
                tabId = appId;
            }
            if (formEventServices && formEventServices.has(tabId)) {
                this.navigationEventService = formEventServices.get(tabId);
            }
            else {
                this.navigationEventService.registerEvent();
                formEventServices.set(tabId, this.navigationEventService);
                this.navigationEventService.frameContext = this.frameContext;
                window['formEventServices'] = formEventServices;
                this.registerDestroyEvent(tabId);
            }
        }
        if (!languageService) {
            this.languageService = new LanguageService();
        }
    }
    Object.defineProperty(NavigationService.prototype, "context", {
        set: function (context) {
            this.navigationEventService['context'] = context;
            this['commandContext'] = context;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NavigationService.prototype, "formAppContext", {
        /**
         * 获取整个表单的appcontext（除module上的appcontext）
         */
        get: function () {
            if (this.frameContext) {
                var appContext = this.frameContext.appContext;
                // tslint:disable-next-line: max-line-length
                while (appContext && appContext.parent && appContext.parent.injector && appContext.parent.injector.get(FrameContext, null) !== null) {
                    appContext = appContext.parent;
                }
                return appContext;
            }
            return null;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NavigationService.prototype, "querystrings", {
        get: function () {
            var hash = window.location.hash;
            var appId = this.formAppContext && this.formAppContext.ApplicationId;
            if (appId) {
                var appContextManager = window[APP_CONTEXT_MANAGER];
                var appContext = appContextManager && appContextManager.get(appId);
                hash = appContext && appContext.hash || hash;
            }
            var params = this.querystringService.parse(hash);
            if (params) {
                params.formToken = this.runtimeFrameworkService.formToken;
            }
            return params;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NavigationService.prototype, "formNotifyService", {
        /**
         * 提示服务
         */
        get: function () {
            return this.injector && this.injector.get(FormNotifyService, null);
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 注册销毁事件
     * @param tabId
     */
    NavigationService.prototype.registerDestroyEvent = function (tabId) {
        var _this = this;
        if (this.frameContext && this.frameContext.destorySignal) {
            this.frameContext.destorySignal.subscribe(function () {
                _this.navigationEventService = null;
            });
        }
        if (this.frameContext && this.frameContext.appContext && this.frameContext.appContext.destorySignal) {
            this.frameContext.appContext.destorySignal.subscribe(function () {
                var formEventServices = window['formEventServices'];
                if (formEventServices) {
                    formEventServices.delete(tabId);
                }
                var appContextManager = window[APP_CONTEXT_MANAGER];
                if (appContextManager) {
                    appContextManager.delete(tabId);
                }
            });
        }
    };
    // #region 接口
    /**
     * 打开菜单
     * @param tabId 根据TabId决定打开新标签页或定位之前打开的标签页
     * @param funcId 菜单Id
     * @param params 参数
     * @param reload 是否重新刷新
     * @param enableRefresh 启用数据刷新
     * @param tabName tab标题
     * @param destructuring 是否解构参数
     */
    NavigationService.prototype.openMenu = function (tabId, funcId, params, reload, enableRefresh, tabName, destructuring) {
        if (!funcId && this.formNotifyService) {
            this.formNotifyService.warning(this.languageService.appOrFuncIdRequired, { hideTitle: true });
            return EMPTY;
        }
        if (tabName) {
            tabName = this.translate(tabName);
        }
        var queryStringParams = this.buildParamMap(params);
        destructuring = this.convertToBoolean(destructuring, false);
        if (destructuring === true) {
            queryStringParams = this.buildParam(params);
        }
        // const paramsMap = this.buildParamMap(params);
        var currentTabId = this.querystrings.tabId || this.querystrings.funcId || this.querystrings.appId;
        var options = {
            tabId: tabId,
            funcId: funcId,
            appType: AppType.Menu,
            queryStringParams: queryStringParams,
            entityParams: queryStringParams,
            appId: undefined,
            appEntrance: undefined,
            isReload: reload,
            tabName: tabName || null
        };
        // 启用数据刷新参数为true或者没有定义，则按刷新处理
        // 没有传递该参数或该参数为空，则认为按照之前的逻辑处理，默认刷新
        // null false "false" "true" undefined
        enableRefresh = this.convertToBoolean(enableRefresh, true);
        if (enableRefresh === true) {
            var frameworkTabId = tabId ? funcId + "_" + tabId : funcId;
            this.menuStateService.addMenuState(currentTabId, frameworkTabId);
        }
        this.runtimeFrameworkService.openMenu(options);
    };
    /**
     * 打开菜单（流）
     * @param tabId 根据TabId决定打开新标签页或定位之前打开的标签页
     * @param funcId 菜单Id
     * @param params 参数
     * @param reload 是否重新刷新
     * @param enableRefresh 启用数据刷新
     * @param destructuring 解构参数
     */
    NavigationService.prototype.openMenu$ = function (tabId, funcId, params, reload, enableRefresh, tabName, destructuring) {
        if (!funcId && this.formNotifyService) {
            this.formNotifyService.warning(this.languageService.appOrFuncIdRequired, { hideTitle: true });
            return EMPTY;
        }
        if (tabName) {
            tabName = this.translate(tabName);
        }
        var queryStringParams = this.buildParamMap(params);
        destructuring = this.convertToBoolean(destructuring, false);
        if (destructuring === true) {
            queryStringParams = this.buildParam(params);
        }
        // const paramsMap = this.buildParamMap(params);
        var currentTabId = this.querystrings.tabId || this.querystrings.funcId || this.querystrings.appId;
        var options = {
            tabId: tabId,
            funcId: funcId,
            appType: AppType.Menu,
            queryStringParams: queryStringParams,
            entityParams: queryStringParams,
            appId: undefined,
            appEntrance: undefined,
            isReload: reload,
            tabName: tabName || null
        };
        // 启用数据刷新参数为true或者没有定义，则按刷新处理
        enableRefresh = this.convertToBoolean(enableRefresh, true);
        if (enableRefresh === true) {
            var frameworkTabId = tabId ? funcId + "_" + tabId : funcId;
            this.menuStateService.addMenuState(currentTabId, frameworkTabId);
        }
        return this.runtimeFrameworkService.openMenu$(options);
    };
    /**
     * 打开菜单(带维度)
     * @param tabId 根据TabId决定打开新标签页或定位之前打开的标签页
     * @param funcId 菜单Id
     * @param params 参数
     * @param reload 是否重新刷新
     * @param enableRefresh 启用数据刷新
     * @param dim1 dim1
     * @param dim2 dim2
     * @param destructuring 解构参数
     */
    NavigationService.prototype.openMenuWithDimension = function (tabId, funcId, params, enableRefresh, dim1, dim2, tabName, metadataId, destructuring) {
        if (!funcId && this.formNotifyService) {
            this.formNotifyService.warning(this.languageService.appOrFuncIdRequired, { hideTitle: true });
            return EMPTY;
        }
        if (tabName) {
            tabName = this.translate(tabName);
        }
        if (metadataId === undefined || metadataId === null) {
            metadataId = '';
        }
        var queryStringParams = this.buildParamMap(params);
        destructuring = this.convertToBoolean(destructuring, false);
        if (destructuring === true) {
            queryStringParams = this.buildParam(params);
        }
        // const paramsMap = this.buildParamMap(params);
        queryStringParams.set('dim1', dim1 ? dim1 : 'public');
        queryStringParams.set('dim2', dim2 ? dim2 : 'public');
        queryStringParams.set('metadataId', metadataId);
        queryStringParams.set('isRtc', '1');
        queryStringParams.set('isRootMetadata', 'true');
        var currentTabId = this.querystrings.tabId || this.querystrings.funcId || this.querystrings.appId;
        var options = {
            tabId: tabId,
            funcId: funcId,
            appType: AppType.Menu,
            queryStringParams: queryStringParams,
            entityParams: queryStringParams,
            appId: undefined,
            appEntrance: undefined,
            isReload: false,
            tabName: tabName || null
        };
        // 启用数据刷新参数为true或者没有定义，则按刷新处理
        // 没有传递该参数或该参数为空，则认为按照之前的逻辑处理，默认刷新
        // null false "false" "true" undefined
        enableRefresh = this.convertToBoolean(enableRefresh, true);
        if (enableRefresh === true) {
            var frameworkTabId = tabId ? funcId + "_" + tabId : funcId;
            this.menuStateService.addMenuState(currentTabId, frameworkTabId);
        }
        this.runtimeFrameworkService.openMenu(options);
    };
    /**
     * 打开应用
     * @param tabId tabId 根据TabId决定打开新标签页或定位之前打开的标签页
     * @param appId 应用Id
     * @param appEntrance 应用入口
     * @param params 参数
     * @param reload 是否重新刷新
     * @param tabName tab标题
     * @param enableRefresh 启用数据刷新
     * @param destructuring 解构参数
     */
    NavigationService.prototype.openApp = function (tabId, appId, appEntrance, params, reload, tabName, enableRefresh, destructuring) {
        if (!appId && this.formNotifyService) {
            this.formNotifyService.warning(this.languageService.appOrFuncIdRequired, { hideTitle: true });
            return EMPTY;
        }
        if (tabName) {
            tabName = this.translate(tabName);
        }
        var queryStringParams = this.buildParamMap(params);
        destructuring = this.convertToBoolean(destructuring, false);
        if (destructuring === true) {
            queryStringParams = this.buildParam(params);
        }
        // const paramsMap = this.buildParamMap(params);
        var currentTabId = this.querystrings.tabId || this.querystrings.funcId || this.querystrings.appId;
        var options = {
            tabId: tabId,
            appId: appId,
            appEntrance: appEntrance,
            funcId: undefined,
            appType: AppType.App,
            queryStringParams: queryStringParams,
            entityParams: queryStringParams,
            isReload: reload,
            tabName: tabName || null
        };
        enableRefresh = this.convertToBoolean(enableRefresh, true);
        if (enableRefresh === true) {
            var frameworkTabId = tabId ? appId + "_" + appEntrance + "_" + tabId : appId + "_" + appEntrance;
            this.menuStateService.addMenuState(currentTabId, frameworkTabId);
        }
        this.runtimeFrameworkService.openMenu(options);
    };
    /**
     * 打开应用(流式)
     * @param tabId tabId 根据TabId决定打开新标签页或定位之前打开的标签页
     * @param appId 应用Id
     * @param appEntrance 应用入口
     * @param params 参数
     * @param reload 是否重新刷新
     * @param tabName tab标题
     * @param enableRefresh 启用数据刷新
     * @param destructuring 解构参数
     */
    NavigationService.prototype.openApp$ = function (tabId, appId, appEntrance, params, reload, tabName, enableRefresh, destructuring) {
        if (!appId && this.formNotifyService) {
            this.formNotifyService.warning(this.languageService.appOrFuncIdRequired, { hideTitle: true });
            return EMPTY;
        }
        if (tabName) {
            tabName = this.translate(tabName);
        }
        var queryStringParams = this.buildParamMap(params);
        destructuring = this.convertToBoolean(destructuring, false);
        if (destructuring === true) {
            queryStringParams = this.buildParam(params);
        }
        // const paramsMap = this.buildParamMap(params);
        var currentTabId = this.querystrings.tabId || this.querystrings.funcId || this.querystrings.appId;
        var options = {
            tabId: tabId,
            appId: appId,
            appEntrance: appEntrance,
            funcId: undefined,
            appType: AppType.App,
            queryStringParams: queryStringParams,
            entityParams: queryStringParams,
            isReload: reload,
            tabName: tabName || null
        };
        enableRefresh = this.convertToBoolean(enableRefresh, true);
        if (enableRefresh === true) {
            var frameworkTabId = tabId ? appId + "_" + appEntrance + "_" + tabId : appId + "_" + appEntrance;
            this.menuStateService.addMenuState(currentTabId, frameworkTabId);
        }
        return this.runtimeFrameworkService.openMenu$(options);
    };
    /**
     * 关闭
     * @param onCloseing 关闭前事件处理器
     */
    NavigationService.prototype.close = function () {
        var options = this.querystrings;
        var _a = this.findDialog(), isInDialog = _a.isDialogComponent, rootComponent = _a.rootComponent;
        if (isInDialog) {
            var modalRefFactory = this.get(rootComponent, 'dialogRef');
            var modalRef = null;
            if (typeof modalRefFactory === 'function') {
                var refs = modalRefFactory();
                modalRef = refs && refs.modalRef;
            }
            else {
                modalRef = modalRefFactory;
            }
            modalRef && modalRef['close']();
            return;
        }
        options.token = options.formToken;
        this.runtimeFrameworkService.beforeCloseMenu(options);
    };
    /**
     * 强制关闭
     */
    NavigationService.prototype.destory = function () {
        var options = this.querystrings;
        options.token = options.formToken;
        this.runtimeFrameworkService.closeMenu(options);
    };
    /**
     *
     * @param params params
     * @deprecated 待废弃，与buildParamMap重复
     */
    NavigationService.prototype.parseParams = function (params) {
        if (typeof params === 'undefined' || params === null || (typeof params === 'string' && params.length < 1)) {
            params = {};
        }
        var paramMap = new Map();
        if (typeof params === 'object') {
            params = JSON.stringify(params);
        }
        params = window['encodeURIComponent'](params);
        paramMap.set('WEB_FORM_ROUTE_PARAMS', params);
        return paramMap;
    };
    /**
     * 注册事件监听器
     * @param eventType 事件类型 onTabClosed
     * @param handler 处理器
     * @returns string 返回事件标识
     */
    NavigationService.prototype.addEventListener = function (eventType, handler) {
        return this.navigationEventService.addEventListener(eventType, handler);
    };
    /**
     * 移除事件监听器
     * @param eventType 事件类型 onTabClosed | onTabCloseing
     * @param key 事件标识
     */
    NavigationService.prototype.removeEventListener = function (eventType, key) {
        return this.navigationEventService.removeEventListener(eventType, key);
    };
    /**
     * 清空事件监听器
     * @param eventType 事件类型
     */
    NavigationService.prototype.clearEventListener = function (eventType) {
        this.navigationEventService.clearEventListener(eventType);
    };
    /**
     * 以弹框、侧边栏或新标签页方式打开表单
     * @param mode 打开方式，支持`modal`弹窗、`sidebar`侧边栏、`tab`新标签页
     * @param modalId 弹窗id，如果mode=`modal`且没有url，
     * @param configs 弹窗配置
     * @param url 远端表单url
     * @param tabId 标签页id，modal=tab时必填
     * @param tabType 标签页类型，`menu` 或`app`
     * @param funcOrAppId 菜单或应用id
     * @param appEntrance 应用入口
     * @param params 参数
     * @param tabName 新标签页名称
     * @param enableRefresh 启用启动刷新
     * @param destructuring 是否解构
     */
    NavigationService.prototype.open = function (mode, modalId, url, configs, tabId, tabType, funcOrAppId, appEntrance, params, tabName, enableRefresh, destructuring) {
        var pageModalService = this.injector.get(FEPageModalService, null);
        if (!pageModalService) {
            throw new Error('get FEPageModalService failed.');
        }
        // 校验参数是否合法
        if (!mode) {
            throw new Error('[NavigationService]->open,mode参数不能为空！');
        }
        if (mode === 'modal' || mode === 'sidebar') {
            if (!modalId && !url) {
                throw new Error('弹窗及侧边栏模式时弹窗容器id和表单路径不能同时为空！');
            }
            if (modalId && url) {
                throw new Error('弹窗及侧边栏模式时弹窗容器id和表单路径不能同时存在！');
            }
            var uiStateConfig = this.getObjectTypeConfig(params);
            var modalConfig = this.buildConfigs(configs);
            if (mode === 'sidebar') {
                modalConfig.dialogType = mode;
            }
            var pageModalRef = null;
            if (modalId) {
                var farrisFormService = this.injector.get(FarrisFormService, null);
                if (!farrisFormService) {
                    return;
                }
                var componentType = farrisFormService.getControls(modalId);
                var componentRef = this.createComponentRef(componentType, uiStateConfig);
                pageModalRef = pageModalService.show(componentRef, modalConfig);
            }
            else if (url) {
                pageModalRef = pageModalService.showByUrl(url, modalConfig);
            }
            if (pageModalRef && !!pageModalRef.content) {
                pageModalRef.content.isDialogRootComponent = true;
                pageModalRef.content.dialogRef = pageModalRef;
                var header = pageModalRef.dialog && pageModalRef.dialog.instance && pageModalRef.dialog.instance.el && pageModalRef.dialog.instance.el.nativeElement && pageModalRef.dialog.instance.el.nativeElement.querySelector(".f-page-header");
                if (header && pageModalRef.dialog.instance.draggbar) {
                    pageModalRef.dialog.instance.draggbar.handle = header;
                    header.style.cursor = 'move';
                }
            }
        }
        else if (mode === 'tab') {
            if (!tabId || !tabType || !funcOrAppId) {
                if (this.formNotifyService) {
                    this.formNotifyService.warning(this.languageService.appOrFuncIdRequired, { hideTitle: true });
                }
                throw new Error('新标签模式时标签页id、标签类型、菜单或应用id均不能为空！');
            }
            if (tabType === 'app' && !appEntrance) {
                throw new Error('以应用方式打开时入口应用不能为空！');
            }
            if (tabType == 'app') {
                this.openApp(tabId, funcOrAppId, appEntrance, params, false, tabName, enableRefresh, destructuring);
            }
            else if (tabType === 'menu') {
                this.openMenu(tabId, funcOrAppId, params, false, enableRefresh, tabName, destructuring);
            }
        }
        else {
            throw new Error('不支持的模式！');
        }
        // this.pageModalService.
    };
    /**
     * in app navigate
     * @param commands commands
     */
    // public navigate(commands: any[]);
    /**
     * in app navigate
     * @param commands commands
     * @param options options
     * @description options:{ relativeTo: this.activatedRoute, queryParams:{a:1,b:2},etc:...}
     */
    NavigationService.prototype.navigate = function (commands, options) {
        var router = this.injector && this.injector.get(Router, null);
        var activatedRoute = this.injector && this.injector.get(ActivatedRoute, null);
        var queryParams = lodash.merge({}, this.querystrings, options && options.queryParams || {});
        if (options && options.hasOwnProperty('queryParams')) {
            delete options.queryParams;
        }
        var extras = lodash.merge({ skipLocationChange: false, relativeTo: activatedRoute, queryParams: queryParams }, options || {});
        if (router) {
            return router.navigate(commands, extras);
        }
        else {
            return null;
        }
    };
    // #endregion
    // #region 私有方法
    /**
     * 封装路由参数
     * @param params 参数
     * @param options 配置参数
     */
    NavigationService.prototype.buildParamMap = function (params, options) {
        if (typeof params === 'undefined' || params === null || (typeof params === 'string' && params.length < 1)) {
            params = {};
        }
        var paramMap = new Map();
        if (options && Object.keys(options).length > 0) {
            if (typeof params !== 'object') {
                params = JSON.parse(params);
            }
            params = lodash.merge(params, options);
        }
        if (typeof params === 'object') {
            params = JSON.stringify(params);
        }
        var currentTabId = this.querystrings.tabId || this.querystrings.funcId || this.querystrings.appId;
        params = window['encodeURIComponent'](params);
        paramMap.set('WEB_FORM_ROUTE_PARAMS', params);
        paramMap.set('WEB_FORM_ROUTER_PARENT_ID', currentTabId);
        return paramMap;
    };
    NavigationService.prototype.buildParam = function (params, options) {
        if (typeof params === 'undefined' || params === null || (typeof params === 'string' && params.length < 1)) {
            params = {};
        }
        var paramMap = new Map();
        if (options && Object.keys(options).length > 0) {
            if (typeof params !== 'object') {
                params = JSON.parse(params);
            }
            params = lodash.merge(params, options);
        }
        if (typeof params !== 'object') {
            params = JSON.parse(params);
        }
        Object.keys(params).forEach(function (key) {
            paramMap.set(key, params[key]);
        });
        var currentTabId = this.querystrings.tabId || this.querystrings.funcId || this.querystrings.appId;
        params = window['encodeURIComponent'](JSON.stringify(params));
        paramMap.set('WEB_FORM_ROUTE_PARAMS', params);
        paramMap.set('WEB_FORM_ROUTER_PARENT_ID', currentTabId);
        return paramMap;
    };
    /**
     * 查找弹窗组件
     */
    NavigationService.prototype.findDialog = function () {
        var frameContext = this.get(this, 'commandContext.frameContext');
        var isDialogComponent = this.get(frameContext, 'frameComponent.isDialogRootComponent', false);
        var rootComponent = null;
        var parentFrameContext = this.get(frameContext, 'parent');
        while (parentFrameContext != null && !isDialogComponent) {
            frameContext = this.get(frameContext, 'parent');
            parentFrameContext = this.get(parentFrameContext, 'parent');
            isDialogComponent = this.get(frameContext, 'frameComponent.isDialogRootComponent', false);
        }
        rootComponent = this.get(frameContext, 'frameComponent');
        if (!isDialogComponent) {
            isDialogComponent = this.frameContext.injector.get(INSIDE_DIALOG_TOKEN, false);
            if (isDialogComponent) {
                var modalRef = this.frameContext.injector.get(MODAL_REF, null);
                rootComponent = { dialogRef: modalRef };
            }
        }
        return { isDialogComponent: isDialogComponent, rootComponent: rootComponent };
    };
    /**
     * loadsh get
     * @param object 对象
     * @param path 路径
     * @param defaultVal 默认值
     */
    NavigationService.prototype.get = function (object, path, defaultVal) {
        if (defaultVal === void 0) { defaultVal = null; }
        var PATH = Array.isArray(path)
            ? path
            : path.split('.').filter(function (i) { return i.length; });
        if (!PATH.length) {
            return object === undefined ? defaultVal : object;
        }
        if (object === null || object === undefined || typeof (object[PATH[0]]) === 'undefined') {
            return defaultVal;
        }
        return this.get(object[PATH.shift()], PATH, defaultVal);
    };
    NavigationService.prototype.convertToBoolean = function (value, defaultVal) {
        if (defaultVal === void 0) { defaultVal = false; }
        if (typeof value === 'undefined' || value === null) {
            value = defaultVal;
        }
        if (typeof value === 'string') {
            value = value || String(defaultVal);
            value = value === 'true' ? true : false;
        }
        return value;
    };
    /**
     * 翻译资源项
     * @param key 资源项key
     */
    NavigationService.prototype.translate = function (key) {
        var translateService = this.injector && this.injector.get(TranslateToken, null) || null;
        if (translateService && key && key.startsWith('{{') && key.endsWith('}}')) {
            key = key.replace('{{', '').replace('}}', '').trim();
            return translateService.transform(key, null);
        }
        return key;
    };
    // #endregion
    //#region 弹窗相关方法
    NavigationService.prototype.buildConfigs = function (config) {
        var _this = this;
        var languageService = this.injector.get(LanguageService, null);
        if (!languageService) {
            languageService = LanguageService.getInstance();
        }
        var defaultConfigs = {
            title: languageService && languageService.defaultDialogTitle || '',
            width: 800,
            height: 500,
            showButtons: false
        };
        var objectTypeConfig = this.getObjectTypeConfig(config);
        var configs = Object.assign(defaultConfigs, objectTypeConfig);
        var onClosingHandler = configs.beforeClose;
        var refresh = configs['refresh'] || {};
        var refreshCommandName = refresh && refresh.commandName || null;
        var refreshFrameId = refresh && refresh.frameId || null;
        // tslint:disable: no-string-literal
        var cancelChanges = configs['cancelChanges'] || false;
        configs.beforeClose = function (ref) {
            if (!!onClosingHandler && typeof onClosingHandler === 'function') {
                return onClosingHandler(ref).pipe(switchMap(function (result) {
                    if (result) {
                        if (cancelChanges) {
                            return _this.cancelChanges(ref).pipe(switchMap(function () { return _this.refreshForm(refreshCommandName, refreshFrameId); }));
                        }
                    }
                    return of(result);
                }));
            }
            else {
                if (cancelChanges) {
                    return _this.cancelChanges(ref).pipe(switchMap(function () { return _this.refreshForm(refreshCommandName, refreshFrameId); }));
                }
                else {
                    return of(true);
                }
            }
        };
        return configs;
    };
    NavigationService.prototype.getObjectTypeConfig = function (config) {
        var objectTypeConfig;
        if (typeof config === 'undefined') {
            config = {};
        }
        if (typeof config === 'string') {
            if (config.length) {
                try {
                    objectTypeConfig = JSON.parse(config);
                }
                catch (_a) {
                    throw new Error(config + '不是合法的json字符串');
                }
            }
            else {
                objectTypeConfig = {};
            }
        }
        else if (typeof config === 'object') {
            objectTypeConfig = Object.assign({}, config);
        }
        else {
            throw new Error('填写对象格式或json字符串');
        }
        return objectTypeConfig;
    };
    /**
     * 取消服务器变更集
     */
    NavigationService.prototype.cancelChanges = function (ref) {
        if (ref && ref.modalRef && ref.modalRef.content) {
            var component = ref.modalRef.content;
            if (component && component.context) {
                var repository = component.context.repository || null;
                if (repository) {
                    return repository.cancelChanges().pipe(switchMap(function () { return of(true); }));
                }
            }
        }
        return of(true);
    };
    NavigationService.prototype.refreshForm = function (refreshCommandName, refreshFrameId) {
        if (refreshCommandName && refreshFrameId) {
            var frameContext = this.frameContext.appContext.frameContextManager.getFrameContextById(refreshFrameId);
            if (frameContext) {
                var viewModel = frameContext.viewModel;
                return viewModel[refreshCommandName]().pipe(map(function () { return true; }));
            }
        }
        return of(true);
    };
    NavigationService.prototype.createComponentRef = function (componentType, uiStateObject) {
        var componentRef;
        var frameContext = this.getFrameContext();
        var componentFactoryResolver = this.getComponentFactoryResolver();
        if (frameContext && componentFactoryResolver) {
            var contentCmptFactory = componentFactoryResolver.resolveComponentFactory(componentType);
            var modalContentInjector = ReflectiveInjector.resolveAndCreate([], frameContext.injector);
            componentRef = contentCmptFactory.create(modalContentInjector);
            if (componentRef && componentRef.instance && componentRef.instance.viewModel && componentRef.instance.viewModel.uiState) {
                if (typeof uiStateObject === 'object' && Object.keys(uiStateObject).length) {
                    Object.keys(uiStateObject).forEach(function (item) {
                        componentRef.instance.viewModel.uiState.setPropertyValue(item, uiStateObject[item]);
                    });
                }
                // 附加isDialog参数
                componentRef.instance.viewModel.uiState.setPropertyValue('DEVKIT_DIALOG', true);
            }
        }
        return componentRef;
    };
    /**
     * 兼容旧弹窗，获取frameContext
     */
    NavigationService.prototype.getFrameContext = function () {
        if (this.frameContext) {
            return this.frameContext;
        }
        if (this['context'] && this['context']['frameContext']) {
            return this['context']['frameContext'];
        }
        return null;
    };
    /**
     * 兼容旧弹窗，获取ComponentFactoryResolver
     */
    NavigationService.prototype.getComponentFactoryResolver = function () {
        var frameContext = this.getFrameContext();
        var componentFactoryResolver;
        if (frameContext) {
            componentFactoryResolver = frameContext.injector.get(ComponentFactoryResolver);
        }
        return componentFactoryResolver;
    };
    NavigationService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    NavigationService.ctorParameters = function () { return [
        { type: RuntimeFrameworkService },
        { type: MenuStateService },
        { type: NavigationEventService },
        { type: QuerystringService },
        { type: FrameContext, decorators: [{ type: Optional }] },
        { type: Injector, decorators: [{ type: Optional }] },
        { type: LanguageService, decorators: [{ type: Optional }] }
    ]; };
    return NavigationService;
}());
export { NavigationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL25hdmlnYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7R0FLRztBQUNILE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSx3QkFBd0IsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RyxPQUFPLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RCxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDeEQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDcEUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxZQUFZLEVBQUUsY0FBYyxFQUE2QixNQUFNLGdCQUFnQixDQUFDO0FBQ3pGLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQy9ELE9BQU8sTUFBTSxNQUFNLFdBQVcsQ0FBQztBQUMvQixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsS0FBSyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM3QyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFP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QUMsWUFBWSxFQUFFO1lBQ3JCLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQTtTQUN6QjtRQUNELElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxjQUFjLENBQUMsRUFBRTtZQUN0RCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQztTQUN4QztRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUNEOztPQUVHO0lBQ0ssdURBQTJCLEdBQW5DO1FBQ0UsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQzVDLElBQUksd0JBQTZCLENBQUM7UUFDbEMsSUFBSSxZQUFZLEVBQUU7WUFDaEIsd0JBQXdCLEdBQUcsWUFBWSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsd0JBQXdCLENBQUMsQ0FBQztTQUNoRjtRQUNELE9BQU8sd0JBQXdCLENBQUM7SUFDbEMsQ0FBQzs7Z0JBendCRixVQUFVOzs7O2dCQXRCRix1QkFBdUI7Z0JBRXZCLGdCQUFnQjtnQkFDaEIsc0JBQXNCO2dCQUN0QixrQkFBa0I7Z0JBQ2xCLFlBQVksdUJBeUJoQixRQUFRO2dCQWhDa0IsUUFBUSx1QkFpQ2xDLFFBQVE7Z0JBdEJKLGVBQWUsdUJBdUJuQixRQUFROztJQWl3QmIsd0JBQUM7Q0FBQSxBQTN3QkQsSUEyd0JDO1NBMXdCWSxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiBhYWxpenp3ZWxsXHJcbiAqIEBEYXRlOiAyMDE5LTA4LTAyIDE1OjMxOjM0XHJcbiAqIEBMYXN0IE1vZGlmaWVkIGJ5OiBhYWxpenp3ZWxsXHJcbiAqIEBMYXN0IE1vZGlmaWVkIHRpbWU6IDIwMjAtMDMtMDMgMDk6MzM6NDNcclxuICovXHJcbmltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsLCBJbmplY3RvciwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBSZWZsZWN0aXZlSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUm91dGVyLCBBY3RpdmF0ZWRSb3V0ZSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcbmltcG9ydCB7IFJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlIH0gZnJvbSAnLi9ydGYtc2VydmljZSc7XHJcbmltcG9ydCB7IEFwcE9wdGlvbnMsIEFwcFR5cGUgfSBmcm9tICdAZ3NwLXN5cy9ydGYtY29tbW9uJztcclxuaW1wb3J0IHsgTWVudVN0YXRlU2VydmljZSB9IGZyb20gJy4vbWVudS1zdGF0ZS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTmF2aWdhdGlvbkV2ZW50U2VydmljZSB9IGZyb20gJy4vbmF2aWdhdGlvbi1ldmVudC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgUXVlcnlzdHJpbmdTZXJ2aWNlIH0gZnJvbSAnLi9xdWVyeXN0cmluZyc7XHJcbmltcG9ydCB7IEZyYW1lQ29udGV4dCwgVHJhbnNsYXRlVG9rZW4sIFRyYW5zbGF0ZSwgRnJhbWVDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IEZFUGFnZU1vZGFsU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvZXh0ZW5kLXBhZ2UtbW9kYWwnO1xyXG5pbXBvcnQgbG9kYXNoIGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IEZhcnJpc0Zvcm1TZXJ2aWNlIH0gZnJvbSAnLi9mYXJyaXMtZm9ybS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9sYW5ndWFnLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBtYXAsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgRU1QVFksIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IEZvcm1Ob3RpZnlTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLW5vdGlmeS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgSU5TSURFX0RJQUxPR19UT0tFTiwgTU9EQUxfUkVGIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IEJzTW9kYWxSZWYgfSBmcm9tICdAZmFycmlzL3VpLW1vZGFsJztcclxuZGVjbGFyZSBjb25zdCBTeXN0ZW06IGFueTtcclxuLy8gdHNsaW50OmRpc2FibGU6IG5vLXN0cmluZy1saXRlcmFsIG1heC1saW5lLWxlbmd0aFxyXG5jb25zdCBBUFBfQ09OVEVYVF9NQU5BR0VSID0gJ0RFVktJVF9BUFBfQ09OVEVYVF9NQU5BR0VSJztcclxuLyoqXHJcbiAqIOWvvOiIquacjeWKoVxyXG4gKiBAc2NvcGUgRm9ybU1vZHVsZVxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgTmF2aWdhdGlvblNlcnZpY2Uge1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgcnVudGltZUZyYW1ld29ya1NlcnZpY2U6IFJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBtZW51U3RhdGVTZXJ2aWNlOiBNZW51U3RhdGVTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBuYXZpZ2F0aW9uRXZlbnRTZXJ2aWNlOiBOYXZpZ2F0aW9uRXZlbnRTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBxdWVyeXN0cmluZ1NlcnZpY2U6IFF1ZXJ5c3RyaW5nU2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcixcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2VcclxuICAgIC8vIEBPcHRpb25hbCgpIHByaXZhdGUgcGFnZU1vZGFsU2VydmljZTogRkVQYWdlTW9kYWxTZXJ2aWNlLFxyXG4gICAgLy8gQE9wdGlvbmFsKCkgcHJpdmF0ZSBmYXJyaXNGb3JtU2VydmljZTogRmFycmlzRm9ybVNlcnZpY2UsXHJcbiAgICAvLyBAT3B0aW9uYWwoKSBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlXHJcbiAgKSB7XHJcbiAgICAvLyBhcHBJZOS4jeWQjOS6jnRhYklk77yM5q+P5qyh6KGo5Y2V5a6e5L6L5YyW5pe26YO95Lya6YeN5paw55Sf5oiQXHJcbiAgICBjb25zdCBhcHBJZCA9IHRoaXMuZm9ybUFwcENvbnRleHQgJiYgdGhpcy5mb3JtQXBwQ29udGV4dC5BcHBsaWNhdGlvbklkO1xyXG4gICAgbGV0IHRhYklkID0gdGhpcy5xdWVyeXN0cmluZ3MudGFiSWQgfHwgdGhpcy5xdWVyeXN0cmluZ3MuZnVuY0lkIHx8IHRoaXMucXVlcnlzdHJpbmdzLmFwcElkO1xyXG4gICAgLy8g5bey57uP57yW6K+R55qE6KGo5Y2V77yM5L2/55SoYXBwSWTorrDlvZVoYXNoXHJcbiAgICBpZiAoYXBwSWQpIHtcclxuICAgICAgY29uc3QgYXBwQ29udGV4dE1hbmFnZXIgPSB3aW5kb3dbQVBQX0NPTlRFWFRfTUFOQUdFUl0gfHwgbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcclxuICAgICAgaWYgKGFwcENvbnRleHRNYW5hZ2VyICYmICFhcHBDb250ZXh0TWFuYWdlci5oYXMoYXBwSWQpKSB7XHJcbiAgICAgICAgYXBwQ29udGV4dE1hbmFnZXIuc2V0KGFwcElkLCB7IGhhc2g6IHdpbmRvdy5sb2NhdGlvbi5oYXNoIH0pO1xyXG4gICAgICAgIHdpbmRvd1tBUFBfQ09OVEVYVF9NQU5BR0VSXSA9IGFwcENvbnRleHRNYW5hZ2VyO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBpZiAodGFiSWQpIHtcclxuICAgICAgY29uc3QgZm9ybUV2ZW50U2VydmljZXM6IE1hcDxzdHJpbmcsIGFueT4gPSB3aW5kb3dbJ2Zvcm1FdmVudFNlcnZpY2VzJ10gfHwgbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcclxuICAgICAgLy8gdGFiSWTjgIFhcHBJZOmDveWtmOWcqOaXtu+8jOS9v+eUqGFwcElk5pu/5o2idGFiSWRcclxuICAgICAgaWYgKGFwcElkKSB7XHJcbiAgICAgICAgdGFiSWQgPSBhcHBJZDtcclxuICAgICAgfVxyXG4gICAgICBpZiAoZm9ybUV2ZW50U2VydmljZXMgJiYgZm9ybUV2ZW50U2VydmljZXMuaGFzKHRhYklkKSkge1xyXG4gICAgICAgIHRoaXMubmF2aWdhdGlvbkV2ZW50U2VydmljZSA9IGZvcm1FdmVudFNlcnZpY2VzLmdldCh0YWJJZCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5uYXZpZ2F0aW9uRXZlbnRTZXJ2aWNlLnJlZ2lzdGVyRXZlbnQoKTtcclxuICAgICAgICBmb3JtRXZlbnRTZXJ2aWNlcy5zZXQodGFiSWQsIHRoaXMubmF2aWdhdGlvbkV2ZW50U2VydmljZSk7XHJcbiAgICAgICAgdGhpcy5uYXZpZ2F0aW9uRXZlbnRTZXJ2aWNlLmZyYW1lQ29udGV4dCA9IHRoaXMuZnJhbWVDb250ZXh0O1xyXG4gICAgICAgIHdpbmRvd1snZm9ybUV2ZW50U2VydmljZXMnXSA9IGZvcm1FdmVudFNlcnZpY2VzO1xyXG4gICAgICAgIHRoaXMucmVnaXN0ZXJEZXN0cm95RXZlbnQodGFiSWQpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBpZiAoIWxhbmd1YWdlU2VydmljZSkge1xyXG4gICAgICB0aGlzLmxhbmd1YWdlU2VydmljZSA9IG5ldyBMYW5ndWFnZVNlcnZpY2UoKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHVibGljIHNldCBjb250ZXh0KGNvbnRleHQpIHtcclxuICAgIHRoaXMubmF2aWdhdGlvbkV2ZW50U2VydmljZVsnY29udGV4dCddID0gY29udGV4dDtcclxuICAgIHRoaXNbJ2NvbW1hbmRDb250ZXh0J10gPSBjb250ZXh0O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bmlbTkuKrooajljZXnmoRhcHBjb250ZXh077yI6ZmkbW9kdWxl5LiK55qEYXBwY29udGV4dO+8iVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0IGZvcm1BcHBDb250ZXh0KCkge1xyXG4gICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIGxldCBhcHBDb250ZXh0ID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dDtcclxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtYXgtbGluZS1sZW5ndGhcclxuICAgICAgd2hpbGUgKGFwcENvbnRleHQgJiYgYXBwQ29udGV4dC5wYXJlbnQgJiYgYXBwQ29udGV4dC5wYXJlbnQuaW5qZWN0b3IgJiYgYXBwQ29udGV4dC5wYXJlbnQuaW5qZWN0b3IuZ2V0KEZyYW1lQ29udGV4dCwgbnVsbCkgIT09IG51bGwpIHtcclxuICAgICAgICBhcHBDb250ZXh0ID0gYXBwQ29udGV4dC5wYXJlbnQ7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGFwcENvbnRleHQ7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXQgcXVlcnlzdHJpbmdzKCkge1xyXG4gICAgbGV0IGhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaDtcclxuICAgIGNvbnN0IGFwcElkID0gdGhpcy5mb3JtQXBwQ29udGV4dCAmJiB0aGlzLmZvcm1BcHBDb250ZXh0LkFwcGxpY2F0aW9uSWQ7XHJcbiAgICBpZiAoYXBwSWQpIHtcclxuICAgICAgY29uc3QgYXBwQ29udGV4dE1hbmFnZXIgPSB3aW5kb3dbQVBQX0NPTlRFWFRfTUFOQUdFUl07XHJcbiAgICAgIGNvbnN0IGFwcENvbnRleHQgPSBhcHBDb250ZXh0TWFuYWdlciAmJiBhcHBDb250ZXh0TWFuYWdlci5nZXQoYXBwSWQpO1xyXG4gICAgICBoYXNoID0gYXBwQ29udGV4dCAmJiBhcHBDb250ZXh0Lmhhc2ggfHwgaGFzaDtcclxuICAgIH1cclxuICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMucXVlcnlzdHJpbmdTZXJ2aWNlLnBhcnNlKGhhc2gpO1xyXG4gICAgaWYgKHBhcmFtcykge1xyXG4gICAgICBwYXJhbXMuZm9ybVRva2VuID0gdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5mb3JtVG9rZW47XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcGFyYW1zO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmj5DnpLrmnI3liqFcclxuICAgKi9cclxuICBwcml2YXRlIGdldCBmb3JtTm90aWZ5U2VydmljZSgpIHtcclxuICAgIHJldHVybiB0aGlzLmluamVjdG9yICYmIHRoaXMuaW5qZWN0b3IuZ2V0PEZvcm1Ob3RpZnlTZXJ2aWNlPihGb3JtTm90aWZ5U2VydmljZSwgbnVsbCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOazqOWGjOmUgOavgeS6i+S7tlxyXG4gICAqIEBwYXJhbSB0YWJJZFxyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVnaXN0ZXJEZXN0cm95RXZlbnQodGFiSWQ6IHN0cmluZykge1xyXG4gICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmRlc3RvcnlTaWduYWwpIHtcclxuICAgICAgdGhpcy5mcmFtZUNvbnRleHQuZGVzdG9yeVNpZ25hbC5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMubmF2aWdhdGlvbkV2ZW50U2VydmljZSA9IG51bGw7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5kZXN0b3J5U2lnbmFsKSB7XHJcbiAgICAgIHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZGVzdG9yeVNpZ25hbC5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZvcm1FdmVudFNlcnZpY2VzID0gd2luZG93Wydmb3JtRXZlbnRTZXJ2aWNlcyddIGFzIE1hcDxzdHJpbmcsIGFueT47XHJcbiAgICAgICAgaWYgKGZvcm1FdmVudFNlcnZpY2VzKSB7XHJcbiAgICAgICAgICBmb3JtRXZlbnRTZXJ2aWNlcy5kZWxldGUodGFiSWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBhcHBDb250ZXh0TWFuYWdlciA9IHdpbmRvd1tBUFBfQ09OVEVYVF9NQU5BR0VSXSBhcyBNYXA8c3RyaW5nLCBhbnk+O1xyXG4gICAgICAgIGlmIChhcHBDb250ZXh0TWFuYWdlcikge1xyXG4gICAgICAgICAgYXBwQ29udGV4dE1hbmFnZXIuZGVsZXRlKHRhYklkKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICAvLyAjcmVnaW9uIOaOpeWPo1xyXG5cclxuICAvKipcclxuICAgKiDmiZPlvIDoj5zljZVcclxuICAgKiBAcGFyYW0gdGFiSWQg5qC55o2uVGFiSWTlhrPlrprmiZPlvIDmlrDmoIfnrb7pobXmiJblrprkvY3kuYvliY3miZPlvIDnmoTmoIfnrb7pobVcclxuICAgKiBAcGFyYW0gZnVuY0lkIOiPnOWNlUlkXHJcbiAgICogQHBhcmFtIHBhcmFtcyDlj4LmlbBcclxuICAgKiBAcGFyYW0gcmVsb2FkIOaYr+WQpumHjeaWsOWIt+aWsFxyXG4gICAqIEBwYXJhbSBlbmFibGVSZWZyZXNoIOWQr+eUqOaVsOaNruWIt+aWsFxyXG4gICAqIEBwYXJhbSB0YWJOYW1lIHRhYuagh+mimFxyXG4gICAqIEBwYXJhbSBkZXN0cnVjdHVyaW5nIOaYr+WQpuino+aehOWPguaVsFxyXG4gICAqL1xyXG4gIHB1YmxpYyBvcGVuTWVudSh0YWJJZDogc3RyaW5nLCBmdW5jSWQ6IHN0cmluZywgcGFyYW1zOiBhbnksIHJlbG9hZD86IGJvb2xlYW4sIGVuYWJsZVJlZnJlc2g/OiBhbnksIHRhYk5hbWU/OiBzdHJpbmcsIGRlc3RydWN0dXJpbmc/OiBhbnkpIHtcclxuICAgIGlmICghZnVuY0lkICYmIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2UpIHtcclxuICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmFwcE9yRnVuY0lkUmVxdWlyZWQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcbiAgICBpZiAodGFiTmFtZSkge1xyXG4gICAgICB0YWJOYW1lID0gdGhpcy50cmFuc2xhdGUodGFiTmFtZSk7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHF1ZXJ5U3RyaW5nUGFyYW1zID0gdGhpcy5idWlsZFBhcmFtTWFwKHBhcmFtcyk7XHJcbiAgICBkZXN0cnVjdHVyaW5nID0gdGhpcy5jb252ZXJ0VG9Cb29sZWFuKGRlc3RydWN0dXJpbmcsIGZhbHNlKTtcclxuICAgIGlmIChkZXN0cnVjdHVyaW5nID09PSB0cnVlKSB7XHJcbiAgICAgIHF1ZXJ5U3RyaW5nUGFyYW1zID0gdGhpcy5idWlsZFBhcmFtKHBhcmFtcyk7XHJcbiAgICB9XHJcbiAgICAvLyBjb25zdCBwYXJhbXNNYXAgPSB0aGlzLmJ1aWxkUGFyYW1NYXAocGFyYW1zKTtcclxuICAgIGNvbnN0IGN1cnJlbnRUYWJJZCA9IHRoaXMucXVlcnlzdHJpbmdzLnRhYklkIHx8IHRoaXMucXVlcnlzdHJpbmdzLmZ1bmNJZCB8fCB0aGlzLnF1ZXJ5c3RyaW5ncy5hcHBJZDtcclxuICAgIGNvbnN0IG9wdGlvbnM6IEFwcE9wdGlvbnMgPSB7XHJcbiAgICAgIHRhYklkLFxyXG4gICAgICBmdW5jSWQsXHJcbiAgICAgIGFwcFR5cGU6IEFwcFR5cGUuTWVudSxcclxuICAgICAgcXVlcnlTdHJpbmdQYXJhbXM6IHF1ZXJ5U3RyaW5nUGFyYW1zLFxyXG4gICAgICBlbnRpdHlQYXJhbXM6IHF1ZXJ5U3RyaW5nUGFyYW1zLFxyXG4gICAgICBhcHBJZDogdW5kZWZpbmVkLFxyXG4gICAgICBhcHBFbnRyYW5jZTogdW5kZWZpbmVkLFxyXG4gICAgICBpc1JlbG9hZDogcmVsb2FkLFxyXG4gICAgICB0YWJOYW1lOiB0YWJOYW1lIHx8IG51bGxcclxuICAgIH07XHJcbiAgICAvLyDlkK/nlKjmlbDmja7liLfmlrDlj4LmlbDkuLp0cnVl5oiW6ICF5rKh5pyJ5a6a5LmJ77yM5YiZ5oyJ5Yi35paw5aSE55CGXHJcbiAgICAvLyDmsqHmnInkvKDpgJLor6Xlj4LmlbDmiJbor6Xlj4LmlbDkuLrnqbrvvIzliJnorqTkuLrmjInnhafkuYvliY3nmoTpgLvovpHlpITnkIbvvIzpu5jorqTliLfmlrBcclxuICAgIC8vIG51bGwgZmFsc2UgXCJmYWxzZVwiIFwidHJ1ZVwiIHVuZGVmaW5lZFxyXG4gICAgZW5hYmxlUmVmcmVzaCA9IHRoaXMuY29udmVydFRvQm9vbGVhbihlbmFibGVSZWZyZXNoLCB0cnVlKTtcclxuICAgIGlmIChlbmFibGVSZWZyZXNoID09PSB0cnVlKSB7XHJcbiAgICAgIGNvbnN0IGZyYW1ld29ya1RhYklkID0gdGFiSWQgPyBgJHtmdW5jSWR9XyR7dGFiSWR9YCA6IGZ1bmNJZDtcclxuICAgICAgdGhpcy5tZW51U3RhdGVTZXJ2aWNlLmFkZE1lbnVTdGF0ZShjdXJyZW50VGFiSWQsIGZyYW1ld29ya1RhYklkKTtcclxuICAgIH1cclxuICAgIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2Uub3Blbk1lbnUob3B0aW9ucyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJk+W8gOiPnOWNle+8iOa1ge+8iVxyXG4gICAqIEBwYXJhbSB0YWJJZCDmoLnmja5UYWJJZOWGs+WumuaJk+W8gOaWsOagh+etvumhteaIluWumuS9jeS5i+WJjeaJk+W8gOeahOagh+etvumhtVxyXG4gICAqIEBwYXJhbSBmdW5jSWQg6I+c5Y2VSWRcclxuICAgKiBAcGFyYW0gcGFyYW1zIOWPguaVsFxyXG4gICAqIEBwYXJhbSByZWxvYWQg5piv5ZCm6YeN5paw5Yi35pawXHJcbiAgICogQHBhcmFtIGVuYWJsZVJlZnJlc2gg5ZCv55So5pWw5o2u5Yi35pawXHJcbiAgICogQHBhcmFtIGRlc3RydWN0dXJpbmcg6Kej5p6E5Y+C5pWwXHJcbiAgICovXHJcbiAgcHVibGljIG9wZW5NZW51JCh0YWJJZDogc3RyaW5nLCBmdW5jSWQ6IHN0cmluZywgcGFyYW1zOiBhbnksIHJlbG9hZD86IGJvb2xlYW4sIGVuYWJsZVJlZnJlc2g/OiBhbnksIHRhYk5hbWU/OiBzdHJpbmcsIGRlc3RydWN0dXJpbmc/OiBhbnkpIHtcclxuICAgIGlmICghZnVuY0lkICYmIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2UpIHtcclxuICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmFwcE9yRnVuY0lkUmVxdWlyZWQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcbiAgICBpZiAodGFiTmFtZSkge1xyXG4gICAgICB0YWJOYW1lID0gdGhpcy50cmFuc2xhdGUodGFiTmFtZSk7XHJcbiAgICB9XHJcbiAgICBsZXQgcXVlcnlTdHJpbmdQYXJhbXMgPSB0aGlzLmJ1aWxkUGFyYW1NYXAocGFyYW1zKTtcclxuICAgIGRlc3RydWN0dXJpbmcgPSB0aGlzLmNvbnZlcnRUb0Jvb2xlYW4oZGVzdHJ1Y3R1cmluZywgZmFsc2UpO1xyXG4gICAgaWYgKGRlc3RydWN0dXJpbmcgPT09IHRydWUpIHtcclxuICAgICAgcXVlcnlTdHJpbmdQYXJhbXMgPSB0aGlzLmJ1aWxkUGFyYW0ocGFyYW1zKTtcclxuICAgIH1cclxuICAgIC8vIGNvbnN0IHBhcmFtc01hcCA9IHRoaXMuYnVpbGRQYXJhbU1hcChwYXJhbXMpO1xyXG4gICAgY29uc3QgY3VycmVudFRhYklkID0gdGhpcy5xdWVyeXN0cmluZ3MudGFiSWQgfHwgdGhpcy5xdWVyeXN0cmluZ3MuZnVuY0lkIHx8IHRoaXMucXVlcnlzdHJpbmdzLmFwcElkO1xyXG4gICAgY29uc3Qgb3B0aW9uczogQXBwT3B0aW9ucyA9IHtcclxuICAgICAgdGFiSWQsXHJcbiAgICAgIGZ1bmNJZCxcclxuICAgICAgYXBwVHlwZTogQXBwVHlwZS5NZW51LFxyXG4gICAgICBxdWVyeVN0cmluZ1BhcmFtczogcXVlcnlTdHJpbmdQYXJhbXMsXHJcbiAgICAgIGVudGl0eVBhcmFtczogcXVlcnlTdHJpbmdQYXJhbXMsXHJcbiAgICAgIGFwcElkOiB1bmRlZmluZWQsXHJcbiAgICAgIGFwcEVudHJhbmNlOiB1bmRlZmluZWQsXHJcbiAgICAgIGlzUmVsb2FkOiByZWxvYWQsXHJcbiAgICAgIHRhYk5hbWU6IHRhYk5hbWUgfHwgbnVsbFxyXG4gICAgfTtcclxuICAgIC8vIOWQr+eUqOaVsOaNruWIt+aWsOWPguaVsOS4unRydWXmiJbogIXmsqHmnInlrprkuYnvvIzliJnmjInliLfmlrDlpITnkIZcclxuICAgIGVuYWJsZVJlZnJlc2ggPSB0aGlzLmNvbnZlcnRUb0Jvb2xlYW4oZW5hYmxlUmVmcmVzaCwgdHJ1ZSk7XHJcbiAgICBpZiAoZW5hYmxlUmVmcmVzaCA9PT0gdHJ1ZSkge1xyXG4gICAgICBjb25zdCBmcmFtZXdvcmtUYWJJZCA9IHRhYklkID8gYCR7ZnVuY0lkfV8ke3RhYklkfWAgOiBmdW5jSWQ7XHJcbiAgICAgIHRoaXMubWVudVN0YXRlU2VydmljZS5hZGRNZW51U3RhdGUoY3VycmVudFRhYklkLCBmcmFtZXdvcmtUYWJJZCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5vcGVuTWVudSQob3B0aW9ucyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJk+W8gOiPnOWNlSjluKbnu7TluqYpXHJcbiAgICogQHBhcmFtIHRhYklkIOagueaNrlRhYklk5Yaz5a6a5omT5byA5paw5qCH562+6aG15oiW5a6a5L2N5LmL5YmN5omT5byA55qE5qCH562+6aG1XHJcbiAgICogQHBhcmFtIGZ1bmNJZCDoj5zljZVJZFxyXG4gICAqIEBwYXJhbSBwYXJhbXMg5Y+C5pWwXHJcbiAgICogQHBhcmFtIHJlbG9hZCDmmK/lkKbph43mlrDliLfmlrBcclxuICAgKiBAcGFyYW0gZW5hYmxlUmVmcmVzaCDlkK/nlKjmlbDmja7liLfmlrBcclxuICAgKiBAcGFyYW0gZGltMSBkaW0xXHJcbiAgICogQHBhcmFtIGRpbTIgZGltMlxyXG4gICAqIEBwYXJhbSBkZXN0cnVjdHVyaW5nIOino+aehOWPguaVsFxyXG4gICAqL1xyXG4gIHB1YmxpYyBvcGVuTWVudVdpdGhEaW1lbnNpb24odGFiSWQ6IHN0cmluZywgZnVuY0lkOiBzdHJpbmcsIHBhcmFtczogYW55LCBlbmFibGVSZWZyZXNoPzogYW55LCBkaW0xPzogYW55LCBkaW0yPzogYW55LCB0YWJOYW1lPzogc3RyaW5nLCBtZXRhZGF0YUlkPzogc3RyaW5nLCBkZXN0cnVjdHVyaW5nPzogYW55KSB7XHJcbiAgICBpZiAoIWZ1bmNJZCAmJiB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlKSB7XHJcbiAgICAgIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5hcHBPckZ1bmNJZFJlcXVpcmVkLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgaWYgKHRhYk5hbWUpIHtcclxuICAgICAgdGFiTmFtZSA9IHRoaXMudHJhbnNsYXRlKHRhYk5hbWUpO1xyXG4gICAgfVxyXG4gICAgaWYgKG1ldGFkYXRhSWQgPT09IHVuZGVmaW5lZCB8fCBtZXRhZGF0YUlkID09PSBudWxsKSB7XHJcbiAgICAgIG1ldGFkYXRhSWQgPSAnJztcclxuICAgIH1cclxuICAgIGxldCBxdWVyeVN0cmluZ1BhcmFtcyA9IHRoaXMuYnVpbGRQYXJhbU1hcChwYXJhbXMpO1xyXG4gICAgZGVzdHJ1Y3R1cmluZyA9IHRoaXMuY29udmVydFRvQm9vbGVhbihkZXN0cnVjdHVyaW5nLCBmYWxzZSk7XHJcbiAgICBpZiAoZGVzdHJ1Y3R1cmluZyA9PT0gdHJ1ZSkge1xyXG4gICAgICBxdWVyeVN0cmluZ1BhcmFtcyA9IHRoaXMuYnVpbGRQYXJhbShwYXJhbXMpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGNvbnN0IHBhcmFtc01hcCA9IHRoaXMuYnVpbGRQYXJhbU1hcChwYXJhbXMpO1xyXG4gICAgcXVlcnlTdHJpbmdQYXJhbXMuc2V0KCdkaW0xJywgZGltMSA/IGRpbTEgOiAncHVibGljJyk7XHJcbiAgICBxdWVyeVN0cmluZ1BhcmFtcy5zZXQoJ2RpbTInLCBkaW0yID8gZGltMiA6ICdwdWJsaWMnKTtcclxuICAgIHF1ZXJ5U3RyaW5nUGFyYW1zLnNldCgnbWV0YWRhdGFJZCcsIG1ldGFkYXRhSWQpO1xyXG4gICAgcXVlcnlTdHJpbmdQYXJhbXMuc2V0KCdpc1J0YycsICcxJyk7XHJcbiAgICBxdWVyeVN0cmluZ1BhcmFtcy5zZXQoJ2lzUm9vdE1ldGFkYXRhJywgJ3RydWUnKTtcclxuICAgIGNvbnN0IGN1cnJlbnRUYWJJZCA9IHRoaXMucXVlcnlzdHJpbmdzLnRhYklkIHx8IHRoaXMucXVlcnlzdHJpbmdzLmZ1bmNJZCB8fCB0aGlzLnF1ZXJ5c3RyaW5ncy5hcHBJZDtcclxuICAgIGNvbnN0IG9wdGlvbnM6IEFwcE9wdGlvbnMgPSB7XHJcbiAgICAgIHRhYklkLFxyXG4gICAgICBmdW5jSWQsXHJcbiAgICAgIGFwcFR5cGU6IEFwcFR5cGUuTWVudSxcclxuICAgICAgcXVlcnlTdHJpbmdQYXJhbXM6IHF1ZXJ5U3RyaW5nUGFyYW1zLFxyXG4gICAgICBlbnRpdHlQYXJhbXM6IHF1ZXJ5U3RyaW5nUGFyYW1zLFxyXG4gICAgICBhcHBJZDogdW5kZWZpbmVkLFxyXG4gICAgICBhcHBFbnRyYW5jZTogdW5kZWZpbmVkLFxyXG4gICAgICBpc1JlbG9hZDogZmFsc2UsXHJcbiAgICAgIHRhYk5hbWU6IHRhYk5hbWUgfHwgbnVsbFxyXG4gICAgfTtcclxuICAgIC8vIOWQr+eUqOaVsOaNruWIt+aWsOWPguaVsOS4unRydWXmiJbogIXmsqHmnInlrprkuYnvvIzliJnmjInliLfmlrDlpITnkIZcclxuICAgIC8vIOayoeacieS8oOmAkuivpeWPguaVsOaIluivpeWPguaVsOS4uuepuu+8jOWImeiupOS4uuaMieeFp+S5i+WJjeeahOmAu+i+keWkhOeQhu+8jOm7mOiupOWIt+aWsFxyXG4gICAgLy8gbnVsbCBmYWxzZSBcImZhbHNlXCIgXCJ0cnVlXCIgdW5kZWZpbmVkXHJcbiAgICBlbmFibGVSZWZyZXNoID0gdGhpcy5jb252ZXJ0VG9Cb29sZWFuKGVuYWJsZVJlZnJlc2gsIHRydWUpO1xyXG4gICAgaWYgKGVuYWJsZVJlZnJlc2ggPT09IHRydWUpIHtcclxuICAgICAgY29uc3QgZnJhbWV3b3JrVGFiSWQgPSB0YWJJZCA/IGAke2Z1bmNJZH1fJHt0YWJJZH1gIDogZnVuY0lkO1xyXG4gICAgICB0aGlzLm1lbnVTdGF0ZVNlcnZpY2UuYWRkTWVudVN0YXRlKGN1cnJlbnRUYWJJZCwgZnJhbWV3b3JrVGFiSWQpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5vcGVuTWVudShvcHRpb25zKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5omT5byA5bqU55SoXHJcbiAgICogQHBhcmFtIHRhYklkIHRhYklkIOagueaNrlRhYklk5Yaz5a6a5omT5byA5paw5qCH562+6aG15oiW5a6a5L2N5LmL5YmN5omT5byA55qE5qCH562+6aG1XHJcbiAgICogQHBhcmFtIGFwcElkIOW6lOeUqElkXHJcbiAgICogQHBhcmFtIGFwcEVudHJhbmNlIOW6lOeUqOWFpeWPo1xyXG4gICAqIEBwYXJhbSBwYXJhbXMg5Y+C5pWwXHJcbiAgICogQHBhcmFtIHJlbG9hZCDmmK/lkKbph43mlrDliLfmlrBcclxuICAgKiBAcGFyYW0gdGFiTmFtZSB0YWLmoIfpophcclxuICAgKiBAcGFyYW0gZW5hYmxlUmVmcmVzaCDlkK/nlKjmlbDmja7liLfmlrBcclxuICAgKiBAcGFyYW0gZGVzdHJ1Y3R1cmluZyDop6PmnoTlj4LmlbBcclxuICAgKi9cclxuXHJcbiAgcHVibGljIG9wZW5BcHAodGFiSWQ6IHN0cmluZywgYXBwSWQ6IHN0cmluZywgYXBwRW50cmFuY2U6IHN0cmluZywgcGFyYW1zOiBhbnksIHJlbG9hZD86IGJvb2xlYW4sIHRhYk5hbWU/OiBzdHJpbmcsIGVuYWJsZVJlZnJlc2g/OiBhbnksIGRlc3RydWN0dXJpbmc/OiBhbnkpIHtcclxuICAgIGlmICghYXBwSWQgJiYgdGhpcy5mb3JtTm90aWZ5U2VydmljZSkge1xyXG4gICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UuYXBwT3JGdW5jSWRSZXF1aXJlZCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIGlmICh0YWJOYW1lKSB7XHJcbiAgICAgIHRhYk5hbWUgPSB0aGlzLnRyYW5zbGF0ZSh0YWJOYW1lKTtcclxuICAgIH1cclxuICAgIGxldCBxdWVyeVN0cmluZ1BhcmFtcyA9IHRoaXMuYnVpbGRQYXJhbU1hcChwYXJhbXMpO1xyXG4gICAgZGVzdHJ1Y3R1cmluZyA9IHRoaXMuY29udmVydFRvQm9vbGVhbihkZXN0cnVjdHVyaW5nLCBmYWxzZSk7XHJcbiAgICBpZiAoZGVzdHJ1Y3R1cmluZyA9PT0gdHJ1ZSkge1xyXG4gICAgICBxdWVyeVN0cmluZ1BhcmFtcyA9IHRoaXMuYnVpbGRQYXJhbShwYXJhbXMpO1xyXG4gICAgfVxyXG4gICAgLy8gY29uc3QgcGFyYW1zTWFwID0gdGhpcy5idWlsZFBhcmFtTWFwKHBhcmFtcyk7XHJcbiAgICBjb25zdCBjdXJyZW50VGFiSWQgPSB0aGlzLnF1ZXJ5c3RyaW5ncy50YWJJZCB8fCB0aGlzLnF1ZXJ5c3RyaW5ncy5mdW5jSWQgfHwgdGhpcy5xdWVyeXN0cmluZ3MuYXBwSWQ7XHJcbiAgICBjb25zdCBvcHRpb25zOiBBcHBPcHRpb25zID0ge1xyXG4gICAgICB0YWJJZCxcclxuICAgICAgYXBwSWQsXHJcbiAgICAgIGFwcEVudHJhbmNlLFxyXG4gICAgICBmdW5jSWQ6IHVuZGVmaW5lZCxcclxuICAgICAgYXBwVHlwZTogQXBwVHlwZS5BcHAsXHJcbiAgICAgIHF1ZXJ5U3RyaW5nUGFyYW1zOiBxdWVyeVN0cmluZ1BhcmFtcyxcclxuICAgICAgZW50aXR5UGFyYW1zOiBxdWVyeVN0cmluZ1BhcmFtcyxcclxuICAgICAgaXNSZWxvYWQ6IHJlbG9hZCxcclxuICAgICAgdGFiTmFtZTogdGFiTmFtZSB8fCBudWxsXHJcbiAgICB9O1xyXG4gICAgZW5hYmxlUmVmcmVzaCA9IHRoaXMuY29udmVydFRvQm9vbGVhbihlbmFibGVSZWZyZXNoLCB0cnVlKTtcclxuICAgIGlmIChlbmFibGVSZWZyZXNoID09PSB0cnVlKSB7XHJcbiAgICAgIGNvbnN0IGZyYW1ld29ya1RhYklkID0gdGFiSWQgPyBgJHthcHBJZH1fJHthcHBFbnRyYW5jZX1fJHt0YWJJZH1gIDogYCR7YXBwSWR9XyR7YXBwRW50cmFuY2V9YDtcclxuICAgICAgdGhpcy5tZW51U3RhdGVTZXJ2aWNlLmFkZE1lbnVTdGF0ZShjdXJyZW50VGFiSWQsIGZyYW1ld29ya1RhYklkKTtcclxuICAgIH1cclxuICAgIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2Uub3Blbk1lbnUob3B0aW9ucyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJk+W8gOW6lOeUqCjmtYHlvI8pXHJcbiAgICogQHBhcmFtIHRhYklkIHRhYklkIOagueaNrlRhYklk5Yaz5a6a5omT5byA5paw5qCH562+6aG15oiW5a6a5L2N5LmL5YmN5omT5byA55qE5qCH562+6aG1XHJcbiAgICogQHBhcmFtIGFwcElkIOW6lOeUqElkXHJcbiAgICogQHBhcmFtIGFwcEVudHJhbmNlIOW6lOeUqOWFpeWPo1xyXG4gICAqIEBwYXJhbSBwYXJhbXMg5Y+C5pWwXHJcbiAgICogQHBhcmFtIHJlbG9hZCDmmK/lkKbph43mlrDliLfmlrBcclxuICAgKiBAcGFyYW0gdGFiTmFtZSB0YWLmoIfpophcclxuICAgKiBAcGFyYW0gZW5hYmxlUmVmcmVzaCDlkK/nlKjmlbDmja7liLfmlrBcclxuICAgKiBAcGFyYW0gZGVzdHJ1Y3R1cmluZyDop6PmnoTlj4LmlbBcclxuICAgKi9cclxuICBwdWJsaWMgb3BlbkFwcCQodGFiSWQ6IHN0cmluZywgYXBwSWQ6IHN0cmluZywgYXBwRW50cmFuY2U6IHN0cmluZywgcGFyYW1zOiBhbnksIHJlbG9hZD86IGJvb2xlYW4sIHRhYk5hbWU/OiBzdHJpbmcsIGVuYWJsZVJlZnJlc2g/OiBhbnksIGRlc3RydWN0dXJpbmc/OiBhbnkpIHtcclxuICAgIGlmICghYXBwSWQgJiYgdGhpcy5mb3JtTm90aWZ5U2VydmljZSkge1xyXG4gICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UuYXBwT3JGdW5jSWRSZXF1aXJlZCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIGlmICh0YWJOYW1lKSB7XHJcbiAgICAgIHRhYk5hbWUgPSB0aGlzLnRyYW5zbGF0ZSh0YWJOYW1lKTtcclxuICAgIH1cclxuICAgIGxldCBxdWVyeVN0cmluZ1BhcmFtcyA9IHRoaXMuYnVpbGRQYXJhbU1hcChwYXJhbXMpO1xyXG4gICAgZGVzdHJ1Y3R1cmluZyA9IHRoaXMuY29udmVydFRvQm9vbGVhbihkZXN0cnVjdHVyaW5nLCBmYWxzZSk7XHJcbiAgICBpZiAoZGVzdHJ1Y3R1cmluZyA9PT0gdHJ1ZSkge1xyXG4gICAgICBxdWVyeVN0cmluZ1BhcmFtcyA9IHRoaXMuYnVpbGRQYXJhbShwYXJhbXMpO1xyXG4gICAgfVxyXG4gICAgLy8gY29uc3QgcGFyYW1zTWFwID0gdGhpcy5idWlsZFBhcmFtTWFwKHBhcmFtcyk7XHJcbiAgICBjb25zdCBjdXJyZW50VGFiSWQgPSB0aGlzLnF1ZXJ5c3RyaW5ncy50YWJJZCB8fCB0aGlzLnF1ZXJ5c3RyaW5ncy5mdW5jSWQgfHwgdGhpcy5xdWVyeXN0cmluZ3MuYXBwSWQ7XHJcbiAgICBjb25zdCBvcHRpb25zOiBBcHBPcHRpb25zID0ge1xyXG4gICAgICB0YWJJZCxcclxuICAgICAgYXBwSWQsXHJcbiAgICAgIGFwcEVudHJhbmNlLFxyXG4gICAgICBmdW5jSWQ6IHVuZGVmaW5lZCxcclxuICAgICAgYXBwVHlwZTogQXBwVHlwZS5BcHAsXHJcbiAgICAgIHF1ZXJ5U3RyaW5nUGFyYW1zOiBxdWVyeVN0cmluZ1BhcmFtcyxcclxuICAgICAgZW50aXR5UGFyYW1zOiBxdWVyeVN0cmluZ1BhcmFtcyxcclxuICAgICAgaXNSZWxvYWQ6IHJlbG9hZCxcclxuICAgICAgdGFiTmFtZTogdGFiTmFtZSB8fCBudWxsXHJcbiAgICB9O1xyXG4gICAgZW5hYmxlUmVmcmVzaCA9IHRoaXMuY29udmVydFRvQm9vbGVhbihlbmFibGVSZWZyZXNoLCB0cnVlKTtcclxuICAgIGlmIChlbmFibGVSZWZyZXNoID09PSB0cnVlKSB7XHJcbiAgICAgIGNvbnN0IGZyYW1ld29ya1RhYklkID0gdGFiSWQgPyBgJHthcHBJZH1fJHthcHBFbnRyYW5jZX1fJHt0YWJJZH1gIDogYCR7YXBwSWR9XyR7YXBwRW50cmFuY2V9YDtcclxuICAgICAgdGhpcy5tZW51U3RhdGVTZXJ2aWNlLmFkZE1lbnVTdGF0ZShjdXJyZW50VGFiSWQsIGZyYW1ld29ya1RhYklkKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlLm9wZW5NZW51JChvcHRpb25zKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5YWz6ZetXHJcbiAgICogQHBhcmFtIG9uQ2xvc2Vpbmcg5YWz6Zet5YmN5LqL5Lu25aSE55CG5ZmoXHJcbiAgICovXHJcbiAgcHVibGljIGNsb3NlKCkge1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMucXVlcnlzdHJpbmdzO1xyXG4gICAgY29uc3QgeyBpc0RpYWxvZ0NvbXBvbmVudDogaXNJbkRpYWxvZywgcm9vdENvbXBvbmVudCB9ID0gdGhpcy5maW5kRGlhbG9nKCk7XHJcbiAgICBpZiAoaXNJbkRpYWxvZykge1xyXG4gICAgICBjb25zdCBtb2RhbFJlZkZhY3RvcnkgPSB0aGlzLmdldChyb290Q29tcG9uZW50LCAnZGlhbG9nUmVmJyk7XHJcbiAgICAgIGxldCBtb2RhbFJlZiA9IG51bGw7XHJcbiAgICAgIGlmICh0eXBlb2YgbW9kYWxSZWZGYWN0b3J5ID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgY29uc3QgcmVmcyA9IG1vZGFsUmVmRmFjdG9yeSgpO1xyXG4gICAgICAgIG1vZGFsUmVmID0gcmVmcyAmJiByZWZzLm1vZGFsUmVmO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIG1vZGFsUmVmID0gbW9kYWxSZWZGYWN0b3J5O1xyXG4gICAgICB9XHJcbiAgICAgIG1vZGFsUmVmICYmIG1vZGFsUmVmWydjbG9zZSddKCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIG9wdGlvbnMudG9rZW4gPSBvcHRpb25zLmZvcm1Ub2tlbjtcclxuICAgIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UuYmVmb3JlQ2xvc2VNZW51KG9wdGlvbnMpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlvLrliLblhbPpl61cclxuICAgKi9cclxuICBwdWJsaWMgZGVzdG9yeSgpIHtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLnF1ZXJ5c3RyaW5ncztcclxuICAgIG9wdGlvbnMudG9rZW4gPSBvcHRpb25zLmZvcm1Ub2tlbjtcclxuICAgIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UuY2xvc2VNZW51KG9wdGlvbnMpO1xyXG4gIH1cclxuICAvKipcclxuICAgKlxyXG4gICAqIEBwYXJhbSBwYXJhbXMgcGFyYW1zXHJcbiAgICogQGRlcHJlY2F0ZWQg5b6F5bqf5byD77yM5LiOYnVpbGRQYXJhbU1hcOmHjeWkjVxyXG4gICAqL1xyXG4gIHByaXZhdGUgcGFyc2VQYXJhbXMocGFyYW1zOiBhbnkpIHtcclxuICAgIGlmICh0eXBlb2YgcGFyYW1zID09PSAndW5kZWZpbmVkJyB8fCBwYXJhbXMgPT09IG51bGwgfHwgKHR5cGVvZiBwYXJhbXMgPT09ICdzdHJpbmcnICYmIHBhcmFtcy5sZW5ndGggPCAxKSkge1xyXG4gICAgICBwYXJhbXMgPSB7fTtcclxuICAgIH1cclxuICAgIGNvbnN0IHBhcmFtTWFwID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcclxuICAgIGlmICh0eXBlb2YgcGFyYW1zID09PSAnb2JqZWN0Jykge1xyXG4gICAgICBwYXJhbXMgPSBKU09OLnN0cmluZ2lmeShwYXJhbXMpO1xyXG4gICAgfVxyXG4gICAgcGFyYW1zID0gd2luZG93WydlbmNvZGVVUklDb21wb25lbnQnXShwYXJhbXMpO1xyXG4gICAgcGFyYW1NYXAuc2V0KCdXRUJfRk9STV9ST1VURV9QQVJBTVMnLCBwYXJhbXMpO1xyXG4gICAgcmV0dXJuIHBhcmFtTWFwO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDms6jlhozkuovku7bnm5HlkKzlmahcclxuICAgKiBAcGFyYW0gZXZlbnRUeXBlIOS6i+S7tuexu+WeiyBvblRhYkNsb3NlZFxyXG4gICAqIEBwYXJhbSBoYW5kbGVyIOWkhOeQhuWZqFxyXG4gICAqIEByZXR1cm5zIHN0cmluZyDov5Tlm57kuovku7bmoIfor4ZcclxuICAgKi9cclxuICBwdWJsaWMgYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGU6IHN0cmluZywgaGFuZGxlcjogKG9wdGlvbnM6IEFwcE9wdGlvbnMpID0+IGFueSk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5uYXZpZ2F0aW9uRXZlbnRTZXJ2aWNlLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBoYW5kbGVyKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog56e76Zmk5LqL5Lu255uR5ZCs5ZmoXHJcbiAgICogQHBhcmFtIGV2ZW50VHlwZSDkuovku7bnsbvlnosgb25UYWJDbG9zZWQgfCBvblRhYkNsb3NlaW5nXHJcbiAgICogQHBhcmFtIGtleSDkuovku7bmoIfor4ZcclxuICAgKi9cclxuICBwdWJsaWMgcmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudFR5cGU6IHN0cmluZywga2V5OiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzLm5hdmlnYXRpb25FdmVudFNlcnZpY2UucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGtleSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOa4heepuuS6i+S7tuebkeWQrOWZqFxyXG4gICAqIEBwYXJhbSBldmVudFR5cGUg5LqL5Lu257G75Z6LXHJcbiAgICovXHJcbiAgcHVibGljIGNsZWFyRXZlbnRMaXN0ZW5lcihldmVudFR5cGU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5uYXZpZ2F0aW9uRXZlbnRTZXJ2aWNlLmNsZWFyRXZlbnRMaXN0ZW5lcihldmVudFR5cGUpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDku6XlvLnmoYbjgIHkvqfovrnmoI/miJbmlrDmoIfnrb7pobXmlrnlvI/miZPlvIDooajljZVcclxuICAgKiBAcGFyYW0gbW9kZSDmiZPlvIDmlrnlvI/vvIzmlK/mjIFgbW9kYWxg5by556qX44CBYHNpZGViYXJg5L6n6L655qCP44CBYHRhYmDmlrDmoIfnrb7pobVcclxuICAgKiBAcGFyYW0gbW9kYWxJZCDlvLnnqpdpZO+8jOWmguaenG1vZGU9YG1vZGFsYOS4lOayoeaciXVybO+8jFxyXG4gICAqIEBwYXJhbSBjb25maWdzIOW8ueeql+mFjee9rlxyXG4gICAqIEBwYXJhbSB1cmwg6L+c56uv6KGo5Y2VdXJsXHJcbiAgICogQHBhcmFtIHRhYklkIOagh+etvumhtWlk77yMbW9kYWw9dGFi5pe25b+F5aGrXHJcbiAgICogQHBhcmFtIHRhYlR5cGUg5qCH562+6aG157G75Z6L77yMYG1lbnVgIOaIlmBhcHBgXHJcbiAgICogQHBhcmFtIGZ1bmNPckFwcElkIOiPnOWNleaIluW6lOeUqGlkXHJcbiAgICogQHBhcmFtIGFwcEVudHJhbmNlIOW6lOeUqOWFpeWPo1xyXG4gICAqIEBwYXJhbSBwYXJhbXMg5Y+C5pWwXHJcbiAgICogQHBhcmFtIHRhYk5hbWUg5paw5qCH562+6aG15ZCN56ewXHJcbiAgICogQHBhcmFtIGVuYWJsZVJlZnJlc2gg5ZCv55So5ZCv5Yqo5Yi35pawXHJcbiAgICogQHBhcmFtIGRlc3RydWN0dXJpbmcg5piv5ZCm6Kej5p6EXHJcbiAgICovXHJcbiAgcHVibGljIG9wZW4obW9kZTogJ21vZGFsJyB8ICdzaWRlYmFyJyB8ICd0YWInLCBtb2RhbElkPzogc3RyaW5nLCB1cmw/OiBzdHJpbmcsIGNvbmZpZ3M/OiBhbnksIHRhYklkPzogc3RyaW5nLCB0YWJUeXBlPzogJ21lbnUnIHwgJ2FwcCcsIGZ1bmNPckFwcElkPzogc3RyaW5nLCBhcHBFbnRyYW5jZT86IHN0cmluZywgcGFyYW1zPzogYW55LCB0YWJOYW1lPzogc3RyaW5nLCBlbmFibGVSZWZyZXNoPzogYW55LCBkZXN0cnVjdHVyaW5nPzogYW55KSB7XHJcbiAgICBjb25zdCBwYWdlTW9kYWxTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQ8RkVQYWdlTW9kYWxTZXJ2aWNlPihGRVBhZ2VNb2RhbFNlcnZpY2UsIG51bGwpO1xyXG4gICAgaWYgKCFwYWdlTW9kYWxTZXJ2aWNlKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignZ2V0IEZFUGFnZU1vZGFsU2VydmljZSBmYWlsZWQuJyk7XHJcbiAgICB9XHJcbiAgICAvLyDmoKHpqozlj4LmlbDmmK/lkKblkIjms5VcclxuICAgIGlmICghbW9kZSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tOYXZpZ2F0aW9uU2VydmljZV0tPm9wZW4sbW9kZeWPguaVsOS4jeiDveS4uuepuu+8gScpO1xyXG4gICAgfVxyXG4gICAgaWYgKG1vZGUgPT09ICdtb2RhbCcgfHwgbW9kZSA9PT0gJ3NpZGViYXInKSB7XHJcbiAgICAgIGlmICghbW9kYWxJZCAmJiAhdXJsKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCflvLnnqpflj4rkvqfovrnmoI/mqKHlvI/ml7blvLnnqpflrrnlmahpZOWSjOihqOWNlei3r+W+hOS4jeiDveWQjOaXtuS4uuepuu+8gScpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChtb2RhbElkICYmIHVybCkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcign5by556qX5Y+K5L6n6L655qCP5qih5byP5pe25by556qX5a655ZmoaWTlkozooajljZXot6/lvoTkuI3og73lkIzml7blrZjlnKjvvIEnKTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCB1aVN0YXRlQ29uZmlnID0gdGhpcy5nZXRPYmplY3RUeXBlQ29uZmlnKHBhcmFtcyk7XHJcbiAgICAgIGNvbnN0IG1vZGFsQ29uZmlnID0gdGhpcy5idWlsZENvbmZpZ3MoY29uZmlncyk7XHJcbiAgICAgIGlmIChtb2RlID09PSAnc2lkZWJhcicpIHtcclxuICAgICAgICBtb2RhbENvbmZpZy5kaWFsb2dUeXBlID0gbW9kZTtcclxuICAgICAgfVxyXG4gICAgICBsZXQgcGFnZU1vZGFsUmVmID0gbnVsbDtcclxuICAgICAgaWYgKG1vZGFsSWQpIHtcclxuICAgICAgICBjb25zdCBmYXJyaXNGb3JtU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0PEZhcnJpc0Zvcm1TZXJ2aWNlPihGYXJyaXNGb3JtU2VydmljZSwgbnVsbCk7XHJcbiAgICAgICAgaWYgKCFmYXJyaXNGb3JtU2VydmljZSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBjb21wb25lbnRUeXBlID0gZmFycmlzRm9ybVNlcnZpY2UuZ2V0Q29udHJvbHMobW9kYWxJZCk7XHJcbiAgICAgICAgY29uc3QgY29tcG9uZW50UmVmID0gdGhpcy5jcmVhdGVDb21wb25lbnRSZWYoY29tcG9uZW50VHlwZSwgdWlTdGF0ZUNvbmZpZyk7XHJcbiAgICAgICAgcGFnZU1vZGFsUmVmID0gcGFnZU1vZGFsU2VydmljZS5zaG93KGNvbXBvbmVudFJlZiwgbW9kYWxDb25maWcpO1xyXG4gICAgICB9IGVsc2UgaWYgKHVybCkge1xyXG4gICAgICAgIHBhZ2VNb2RhbFJlZiA9IHBhZ2VNb2RhbFNlcnZpY2Uuc2hvd0J5VXJsKHVybCwgbW9kYWxDb25maWcpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChwYWdlTW9kYWxSZWYgJiYgISFwYWdlTW9kYWxSZWYuY29udGVudCkge1xyXG4gICAgICAgIHBhZ2VNb2RhbFJlZi5jb250ZW50LmlzRGlhbG9nUm9vdENvbXBvbmVudCA9IHRydWU7XHJcbiAgICAgICAgcGFnZU1vZGFsUmVmLmNvbnRlbnQuZGlhbG9nUmVmID0gcGFnZU1vZGFsUmVmO1xyXG4gICAgICAgIGNvbnN0IGhlYWRlciA9IHBhZ2VNb2RhbFJlZi5kaWFsb2cgJiYgcGFnZU1vZGFsUmVmLmRpYWxvZy5pbnN0YW5jZSAmJiBwYWdlTW9kYWxSZWYuZGlhbG9nLmluc3RhbmNlLmVsICYmIHBhZ2VNb2RhbFJlZi5kaWFsb2cuaW5zdGFuY2UuZWwubmF0aXZlRWxlbWVudCAmJiBwYWdlTW9kYWxSZWYuZGlhbG9nLmluc3RhbmNlLmVsLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcihcIi5mLXBhZ2UtaGVhZGVyXCIpO1xyXG4gICAgICAgIGlmIChoZWFkZXIgJiYgcGFnZU1vZGFsUmVmLmRpYWxvZy5pbnN0YW5jZS5kcmFnZ2Jhcikge1xyXG4gICAgICAgICAgcGFnZU1vZGFsUmVmLmRpYWxvZy5pbnN0YW5jZS5kcmFnZ2Jhci5oYW5kbGUgPSBoZWFkZXI7XHJcbiAgICAgICAgICBoZWFkZXIuc3R5bGUuY3Vyc29yID0gJ21vdmUnO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChtb2RlID09PSAndGFiJykge1xyXG4gICAgICBpZiAoIXRhYklkIHx8ICF0YWJUeXBlIHx8ICFmdW5jT3JBcHBJZCkge1xyXG4gICAgICAgIGlmICh0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlKSB7XHJcbiAgICAgICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UuYXBwT3JGdW5jSWRSZXF1aXJlZCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcign5paw5qCH562+5qih5byP5pe25qCH562+6aG1aWTjgIHmoIfnrb7nsbvlnovjgIHoj5zljZXmiJblupTnlKhpZOWdh+S4jeiDveS4uuepuu+8gScpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICh0YWJUeXBlID09PSAnYXBwJyAmJiAhYXBwRW50cmFuY2UpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ+S7peW6lOeUqOaWueW8j+aJk+W8gOaXtuWFpeWPo+W6lOeUqOS4jeiDveS4uuepuu+8gScpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICh0YWJUeXBlID09ICdhcHAnKSB7XHJcbiAgICAgICAgdGhpcy5vcGVuQXBwKHRhYklkLCBmdW5jT3JBcHBJZCwgYXBwRW50cmFuY2UsIHBhcmFtcywgZmFsc2UsIHRhYk5hbWUsIGVuYWJsZVJlZnJlc2gsIGRlc3RydWN0dXJpbmcpO1xyXG4gICAgICB9IGVsc2UgaWYgKHRhYlR5cGUgPT09ICdtZW51Jykge1xyXG4gICAgICAgIHRoaXMub3Blbk1lbnUodGFiSWQsIGZ1bmNPckFwcElkLCBwYXJhbXMsIGZhbHNlLCBlbmFibGVSZWZyZXNoLCB0YWJOYW1lLCBkZXN0cnVjdHVyaW5nKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCfkuI3mlK/mjIHnmoTmqKHlvI/vvIEnKTtcclxuICAgIH1cclxuICAgIC8vIHRoaXMucGFnZU1vZGFsU2VydmljZS5cclxuICB9XHJcbiAgLyoqXHJcbiAgICogaW4gYXBwIG5hdmlnYXRlXHJcbiAgICogQHBhcmFtIGNvbW1hbmRzIGNvbW1hbmRzXHJcbiAgICovXHJcbiAgLy8gcHVibGljIG5hdmlnYXRlKGNvbW1hbmRzOiBhbnlbXSk7XHJcbiAgLyoqXHJcbiAgICogaW4gYXBwIG5hdmlnYXRlXHJcbiAgICogQHBhcmFtIGNvbW1hbmRzIGNvbW1hbmRzXHJcbiAgICogQHBhcmFtIG9wdGlvbnMgb3B0aW9uc1xyXG4gICAqIEBkZXNjcmlwdGlvbiBvcHRpb25zOnsgcmVsYXRpdmVUbzogdGhpcy5hY3RpdmF0ZWRSb3V0ZSwgcXVlcnlQYXJhbXM6e2E6MSxiOjJ9LGV0YzouLi59XHJcbiAgICovXHJcbiAgcHVibGljIG5hdmlnYXRlKGNvbW1hbmRzOiBhbnlbXSwgb3B0aW9ucz86IGFueSk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgY29uc3Qgcm91dGVyID0gdGhpcy5pbmplY3RvciAmJiB0aGlzLmluamVjdG9yLmdldDxSb3V0ZXI+KFJvdXRlciwgbnVsbCk7XHJcbiAgICBjb25zdCBhY3RpdmF0ZWRSb3V0ZSA9IHRoaXMuaW5qZWN0b3IgJiYgdGhpcy5pbmplY3Rvci5nZXQ8QWN0aXZhdGVkUm91dGU+KEFjdGl2YXRlZFJvdXRlLCBudWxsKTtcclxuICAgIGNvbnN0IHF1ZXJ5UGFyYW1zID0gbG9kYXNoLm1lcmdlKHt9LCB0aGlzLnF1ZXJ5c3RyaW5ncywgb3B0aW9ucyAmJiBvcHRpb25zLnF1ZXJ5UGFyYW1zIHx8IHt9KTtcclxuICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuaGFzT3duUHJvcGVydHkoJ3F1ZXJ5UGFyYW1zJykpIHtcclxuICAgICAgZGVsZXRlIG9wdGlvbnMucXVlcnlQYXJhbXM7XHJcbiAgICB9XHJcbiAgICBjb25zdCBleHRyYXMgPSBsb2Rhc2gubWVyZ2UoeyBza2lwTG9jYXRpb25DaGFuZ2U6IGZhbHNlLCByZWxhdGl2ZVRvOiBhY3RpdmF0ZWRSb3V0ZSwgcXVlcnlQYXJhbXMgfSwgb3B0aW9ucyB8fCB7fSk7XHJcbiAgICBpZiAocm91dGVyKSB7XHJcbiAgICAgIHJldHVybiByb3V0ZXIubmF2aWdhdGUoY29tbWFuZHMsIGV4dHJhcyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICB9XHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuICAvLyAjcmVnaW9uIOengeacieaWueazlVxyXG5cclxuICAvKipcclxuICAgKiDlsIHoo4Xot6/nlLHlj4LmlbBcclxuICAgKiBAcGFyYW0gcGFyYW1zIOWPguaVsFxyXG4gICAqIEBwYXJhbSBvcHRpb25zIOmFjee9ruWPguaVsFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGRQYXJhbU1hcChwYXJhbXM6IGFueSwgb3B0aW9ucz86IGFueSk6IE1hcDxzdHJpbmcsIHN0cmluZz4ge1xyXG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICd1bmRlZmluZWQnIHx8IHBhcmFtcyA9PT0gbnVsbCB8fCAodHlwZW9mIHBhcmFtcyA9PT0gJ3N0cmluZycgJiYgcGFyYW1zLmxlbmd0aCA8IDEpKSB7XHJcbiAgICAgIHBhcmFtcyA9IHt9O1xyXG4gICAgfVxyXG4gICAgY29uc3QgcGFyYW1NYXAgPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xyXG4gICAgaWYgKG9wdGlvbnMgJiYgT2JqZWN0LmtleXMob3B0aW9ucykubGVuZ3RoID4gMCkge1xyXG4gICAgICBpZiAodHlwZW9mIHBhcmFtcyAhPT0gJ29iamVjdCcpIHtcclxuICAgICAgICBwYXJhbXMgPSBKU09OLnBhcnNlKHBhcmFtcyk7XHJcbiAgICAgIH1cclxuICAgICAgcGFyYW1zID0gbG9kYXNoLm1lcmdlKHBhcmFtcywgb3B0aW9ucyk7XHJcbiAgICB9XHJcbiAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgcGFyYW1zID0gSlNPTi5zdHJpbmdpZnkocGFyYW1zKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGN1cnJlbnRUYWJJZCA9IHRoaXMucXVlcnlzdHJpbmdzLnRhYklkIHx8IHRoaXMucXVlcnlzdHJpbmdzLmZ1bmNJZCB8fCB0aGlzLnF1ZXJ5c3RyaW5ncy5hcHBJZDtcclxuICAgIHBhcmFtcyA9IHdpbmRvd1snZW5jb2RlVVJJQ29tcG9uZW50J10ocGFyYW1zKTtcclxuICAgIHBhcmFtTWFwLnNldCgnV0VCX0ZPUk1fUk9VVEVfUEFSQU1TJywgcGFyYW1zKTtcclxuICAgIHBhcmFtTWFwLnNldCgnV0VCX0ZPUk1fUk9VVEVSX1BBUkVOVF9JRCcsIGN1cnJlbnRUYWJJZCk7XHJcbiAgICByZXR1cm4gcGFyYW1NYXA7XHJcbiAgfVxyXG4gIHByaXZhdGUgYnVpbGRQYXJhbShwYXJhbXMsIG9wdGlvbnM/OiBhbnkpOiBNYXA8c3RyaW5nLCBzdHJpbmc+IHtcclxuICAgIGlmICh0eXBlb2YgcGFyYW1zID09PSAndW5kZWZpbmVkJyB8fCBwYXJhbXMgPT09IG51bGwgfHwgKHR5cGVvZiBwYXJhbXMgPT09ICdzdHJpbmcnICYmIHBhcmFtcy5sZW5ndGggPCAxKSkge1xyXG4gICAgICBwYXJhbXMgPSB7fTtcclxuICAgIH1cclxuICAgIGNvbnN0IHBhcmFtTWFwID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcclxuICAgIGlmIChvcHRpb25zICYmIE9iamVjdC5rZXlzKG9wdGlvbnMpLmxlbmd0aCA+IDApIHtcclxuICAgICAgaWYgKHR5cGVvZiBwYXJhbXMgIT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgcGFyYW1zID0gSlNPTi5wYXJzZShwYXJhbXMpO1xyXG4gICAgICB9XHJcbiAgICAgIHBhcmFtcyA9IGxvZGFzaC5tZXJnZShwYXJhbXMsIG9wdGlvbnMpO1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgIT09ICdvYmplY3QnKSB7XHJcbiAgICAgIHBhcmFtcyA9IEpTT04ucGFyc2UocGFyYW1zKTtcclxuICAgIH1cclxuICAgIE9iamVjdC5rZXlzKHBhcmFtcykuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICBwYXJhbU1hcC5zZXQoa2V5LCBwYXJhbXNba2V5XSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCBjdXJyZW50VGFiSWQgPSB0aGlzLnF1ZXJ5c3RyaW5ncy50YWJJZCB8fCB0aGlzLnF1ZXJ5c3RyaW5ncy5mdW5jSWQgfHwgdGhpcy5xdWVyeXN0cmluZ3MuYXBwSWQ7XHJcbiAgICBwYXJhbXMgPSB3aW5kb3dbJ2VuY29kZVVSSUNvbXBvbmVudCddKEpTT04uc3RyaW5naWZ5KHBhcmFtcykpO1xyXG4gICAgcGFyYW1NYXAuc2V0KCdXRUJfRk9STV9ST1VURV9QQVJBTVMnLCBwYXJhbXMpO1xyXG4gICAgcGFyYW1NYXAuc2V0KCdXRUJfRk9STV9ST1VURVJfUEFSRU5UX0lEJywgY3VycmVudFRhYklkKTtcclxuICAgIHJldHVybiBwYXJhbU1hcDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p+l5om+5by556qX57uE5Lu2XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmaW5kRGlhbG9nKCkge1xyXG4gICAgbGV0IGZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0KHRoaXMsICdjb21tYW5kQ29udGV4dC5mcmFtZUNvbnRleHQnKTtcclxuICAgIGxldCBpc0RpYWxvZ0NvbXBvbmVudCA9IHRoaXMuZ2V0KGZyYW1lQ29udGV4dCwgJ2ZyYW1lQ29tcG9uZW50LmlzRGlhbG9nUm9vdENvbXBvbmVudCcsIGZhbHNlKTtcclxuICAgIGxldCByb290Q29tcG9uZW50ID0gbnVsbDtcclxuICAgIGxldCBwYXJlbnRGcmFtZUNvbnRleHQgPSB0aGlzLmdldChmcmFtZUNvbnRleHQsICdwYXJlbnQnKTtcclxuICAgIHdoaWxlIChwYXJlbnRGcmFtZUNvbnRleHQgIT0gbnVsbCAmJiAhaXNEaWFsb2dDb21wb25lbnQpIHtcclxuICAgICAgZnJhbWVDb250ZXh0ID0gdGhpcy5nZXQoZnJhbWVDb250ZXh0LCAncGFyZW50Jyk7XHJcbiAgICAgIHBhcmVudEZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0KHBhcmVudEZyYW1lQ29udGV4dCwgJ3BhcmVudCcpO1xyXG4gICAgICBpc0RpYWxvZ0NvbXBvbmVudCA9IHRoaXMuZ2V0KGZyYW1lQ29udGV4dCwgJ2ZyYW1lQ29tcG9uZW50LmlzRGlhbG9nUm9vdENvbXBvbmVudCcsIGZhbHNlKTtcclxuICAgIH1cclxuICAgIHJvb3RDb21wb25lbnQgPSB0aGlzLmdldChmcmFtZUNvbnRleHQsICdmcmFtZUNvbXBvbmVudCcpO1xyXG4gICAgaWYgKCFpc0RpYWxvZ0NvbXBvbmVudCkge1xyXG4gICAgICBpc0RpYWxvZ0NvbXBvbmVudCA9IHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxib29sZWFuPihJTlNJREVfRElBTE9HX1RPS0VOLCBmYWxzZSk7XHJcbiAgICAgIGlmIChpc0RpYWxvZ0NvbXBvbmVudCkge1xyXG4gICAgICAgIGNvbnN0IG1vZGFsUmVmID0gdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PEJzTW9kYWxSZWY+KE1PREFMX1JFRiwgbnVsbCk7XHJcbiAgICAgICAgcm9vdENvbXBvbmVudCA9IHsgZGlhbG9nUmVmOiBtb2RhbFJlZiB9O1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4geyBpc0RpYWxvZ0NvbXBvbmVudCwgcm9vdENvbXBvbmVudCB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogbG9hZHNoIGdldFxyXG4gICAqIEBwYXJhbSBvYmplY3Qg5a+56LGhXHJcbiAgICogQHBhcmFtIHBhdGgg6Lev5b6EXHJcbiAgICogQHBhcmFtIGRlZmF1bHRWYWwg6buY6K6k5YC8XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXQob2JqZWN0OiBhbnksIHBhdGg6IEFycmF5PHN0cmluZz4gfCBzdHJpbmcsIGRlZmF1bHRWYWw6IGFueSA9IG51bGwpIHtcclxuICAgIGNvbnN0IFBBVEggPSBBcnJheS5pc0FycmF5KHBhdGgpXHJcbiAgICAgID8gcGF0aFxyXG4gICAgICA6IHBhdGguc3BsaXQoJy4nKS5maWx0ZXIoaSA9PiBpLmxlbmd0aCk7XHJcbiAgICBpZiAoIVBBVEgubGVuZ3RoKSB7XHJcbiAgICAgIHJldHVybiBvYmplY3QgPT09IHVuZGVmaW5lZCA/IGRlZmF1bHRWYWwgOiBvYmplY3Q7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG9iamVjdCA9PT0gbnVsbCB8fCBvYmplY3QgPT09IHVuZGVmaW5lZCB8fCB0eXBlb2YgKG9iamVjdFtQQVRIWzBdXSkgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIHJldHVybiBkZWZhdWx0VmFsO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0aGlzLmdldChvYmplY3RbUEFUSC5zaGlmdCgpXSwgUEFUSCwgZGVmYXVsdFZhbCk7XHJcbiAgfVxyXG4gIHByaXZhdGUgY29udmVydFRvQm9vbGVhbih2YWx1ZTogYW55LCBkZWZhdWx0VmFsOiBib29sZWFuID0gZmFsc2UpIHtcclxuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnIHx8IHZhbHVlID09PSBudWxsKSB7XHJcbiAgICAgIHZhbHVlID0gZGVmYXVsdFZhbDtcclxuICAgIH1cclxuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgIHZhbHVlID0gdmFsdWUgfHwgU3RyaW5nKGRlZmF1bHRWYWwpO1xyXG4gICAgICB2YWx1ZSA9IHZhbHVlID09PSAndHJ1ZScgPyB0cnVlIDogZmFsc2U7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdmFsdWU7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOe/u+ivkei1hOa6kOmhuVxyXG4gICAqIEBwYXJhbSBrZXkg6LWE5rqQ6aG5a2V5XHJcbiAgICovXHJcbiAgcHJpdmF0ZSB0cmFuc2xhdGUoa2V5OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHRyYW5zbGF0ZVNlcnZpY2UgPSB0aGlzLmluamVjdG9yICYmIHRoaXMuaW5qZWN0b3IuZ2V0PFRyYW5zbGF0ZT4oVHJhbnNsYXRlVG9rZW4sIG51bGwpIHx8IG51bGw7XHJcbiAgICBpZiAodHJhbnNsYXRlU2VydmljZSAmJiBrZXkgJiYga2V5LnN0YXJ0c1dpdGgoJ3t7JykgJiYga2V5LmVuZHNXaXRoKCd9fScpKSB7XHJcbiAgICAgIGtleSA9IGtleS5yZXBsYWNlKCd7eycsICcnKS5yZXBsYWNlKCd9fScsICcnKS50cmltKCk7XHJcbiAgICAgIHJldHVybiB0cmFuc2xhdGVTZXJ2aWNlLnRyYW5zZm9ybShrZXksIG51bGwpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGtleTtcclxuICB9XHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuICAvLyNyZWdpb24g5by556qX55u45YWz5pa55rOVXHJcbiAgcHJpdmF0ZSBidWlsZENvbmZpZ3MoY29uZmlnOiBhbnkpOiB7IFtwcm9wOiBzdHJpbmddOiBhbnkgfSB7XHJcbiAgICBsZXQgbGFuZ3VhZ2VTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQ8TGFuZ3VhZ2VTZXJ2aWNlPihMYW5ndWFnZVNlcnZpY2UsIG51bGwpO1xyXG4gICAgaWYgKCFsYW5ndWFnZVNlcnZpY2UpIHtcclxuICAgICAgbGFuZ3VhZ2VTZXJ2aWNlID0gTGFuZ3VhZ2VTZXJ2aWNlLmdldEluc3RhbmNlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZGVmYXVsdENvbmZpZ3M6IGFueSA9IHtcclxuICAgICAgdGl0bGU6IGxhbmd1YWdlU2VydmljZSAmJiBsYW5ndWFnZVNlcnZpY2UuZGVmYXVsdERpYWxvZ1RpdGxlIHx8ICcnLFxyXG4gICAgICB3aWR0aDogODAwLFxyXG4gICAgICBoZWlnaHQ6IDUwMCxcclxuICAgICAgc2hvd0J1dHRvbnM6IGZhbHNlXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgb2JqZWN0VHlwZUNvbmZpZyA9IHRoaXMuZ2V0T2JqZWN0VHlwZUNvbmZpZyhjb25maWcpO1xyXG4gICAgY29uc3QgY29uZmlncyA9IE9iamVjdC5hc3NpZ24oZGVmYXVsdENvbmZpZ3MsIG9iamVjdFR5cGVDb25maWcpO1xyXG4gICAgY29uc3Qgb25DbG9zaW5nSGFuZGxlciA9IGNvbmZpZ3MuYmVmb3JlQ2xvc2U7XHJcbiAgICBjb25zdCByZWZyZXNoID0gY29uZmlnc1sncmVmcmVzaCddIHx8IHt9O1xyXG4gICAgY29uc3QgcmVmcmVzaENvbW1hbmROYW1lID0gcmVmcmVzaCAmJiByZWZyZXNoLmNvbW1hbmROYW1lIHx8IG51bGw7XHJcbiAgICBjb25zdCByZWZyZXNoRnJhbWVJZCA9IHJlZnJlc2ggJiYgcmVmcmVzaC5mcmFtZUlkIHx8IG51bGw7XHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZTogbm8tc3RyaW5nLWxpdGVyYWxcclxuICAgIGNvbnN0IGNhbmNlbENoYW5nZXMgPSBjb25maWdzWydjYW5jZWxDaGFuZ2VzJ10gfHwgZmFsc2U7XHJcbiAgICBjb25maWdzLmJlZm9yZUNsb3NlID0gKHJlZikgPT4ge1xyXG4gICAgICBpZiAoISFvbkNsb3NpbmdIYW5kbGVyICYmIHR5cGVvZiBvbkNsb3NpbmdIYW5kbGVyID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgcmV0dXJuIG9uQ2xvc2luZ0hhbmRsZXIocmVmKS5waXBlKFxyXG4gICAgICAgICAgc3dpdGNoTWFwKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICAgICAgICBpZiAoY2FuY2VsQ2hhbmdlcykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2FuY2VsQ2hhbmdlcyhyZWYpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLnJlZnJlc2hGb3JtKHJlZnJlc2hDb21tYW5kTmFtZSwgcmVmcmVzaEZyYW1lSWQpKVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG9mKHJlc3VsdCk7XHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWYgKGNhbmNlbENoYW5nZXMpIHtcclxuICAgICAgICAgIHJldHVybiB0aGlzLmNhbmNlbENoYW5nZXMocmVmKS5waXBlKFxyXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5yZWZyZXNoRm9ybShyZWZyZXNoQ29tbWFuZE5hbWUsIHJlZnJlc2hGcmFtZUlkKSlcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGNvbmZpZ3M7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0T2JqZWN0VHlwZUNvbmZpZyhjb25maWc6IGFueSkge1xyXG4gICAgbGV0IG9iamVjdFR5cGVDb25maWc6IGFueVxyXG4gICAgaWYgKHR5cGVvZiBjb25maWcgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIGNvbmZpZyA9IHt9O1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiBjb25maWcgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgIGlmIChjb25maWcubGVuZ3RoKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIG9iamVjdFR5cGVDb25maWcgPSBKU09OLnBhcnNlKGNvbmZpZyk7XHJcbiAgICAgICAgfSBjYXRjaCB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoY29uZmlnICsgJ+S4jeaYr+WQiOazleeahGpzb27lrZfnrKbkuLInKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgb2JqZWN0VHlwZUNvbmZpZyA9IHt9O1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBjb25maWcgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgIG9iamVjdFR5cGVDb25maWcgPSBPYmplY3QuYXNzaWduKHt9LCBjb25maWcpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCfloavlhpnlr7nosaHmoLzlvI/miJZqc29u5a2X56ym5LiyJyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gb2JqZWN0VHlwZUNvbmZpZztcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Y+W5raI5pyN5Yqh5Zmo5Y+Y5pu06ZuGXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjYW5jZWxDaGFuZ2VzKHJlZjogYW55KTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICBpZiAocmVmICYmIHJlZi5tb2RhbFJlZiAmJiByZWYubW9kYWxSZWYuY29udGVudCkge1xyXG4gICAgICBjb25zdCBjb21wb25lbnQ6IEZyYW1lQ29tcG9uZW50ID0gcmVmLm1vZGFsUmVmLmNvbnRlbnQgYXMgRnJhbWVDb21wb25lbnQ7XHJcbiAgICAgIGlmIChjb21wb25lbnQgJiYgY29tcG9uZW50LmNvbnRleHQpIHtcclxuICAgICAgICBjb25zdCByZXBvc2l0b3J5ID0gY29tcG9uZW50LmNvbnRleHQucmVwb3NpdG9yeSB8fCBudWxsO1xyXG4gICAgICAgIGlmIChyZXBvc2l0b3J5KSB7XHJcbiAgICAgICAgICByZXR1cm4gcmVwb3NpdG9yeS5jYW5jZWxDaGFuZ2VzKCkucGlwZShzd2l0Y2hNYXAoKCkgPT4gb2YodHJ1ZSkpKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBvZih0cnVlKTtcclxuICB9XHJcbiAgcHJpdmF0ZSByZWZyZXNoRm9ybShyZWZyZXNoQ29tbWFuZE5hbWU6IHN0cmluZywgcmVmcmVzaEZyYW1lSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBpZiAocmVmcmVzaENvbW1hbmROYW1lICYmIHJlZnJlc2hGcmFtZUlkKSB7XHJcbiAgICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRCeUlkKHJlZnJlc2hGcmFtZUlkKTtcclxuICAgICAgaWYgKGZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgIGNvbnN0IHZpZXdNb2RlbCA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWw7XHJcbiAgICAgICAgcmV0dXJuIHZpZXdNb2RlbFtyZWZyZXNoQ29tbWFuZE5hbWVdKCkucGlwZShcclxuICAgICAgICAgIG1hcCgoKSA9PiB0cnVlKVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBvZih0cnVlKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBjcmVhdGVDb21wb25lbnRSZWYoY29tcG9uZW50VHlwZTogYW55LCB1aVN0YXRlT2JqZWN0OiBhbnkpIHtcclxuICAgIGxldCBjb21wb25lbnRSZWY6IGFueTtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0RnJhbWVDb250ZXh0KCk7XHJcbiAgICBjb25zdCBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIgPSB0aGlzLmdldENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcigpO1xyXG4gICAgaWYgKGZyYW1lQ29udGV4dCAmJiBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpIHtcclxuICAgICAgY29uc3QgY29udGVudENtcHRGYWN0b3J5ID0gY29tcG9uZW50RmFjdG9yeVJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KGNvbXBvbmVudFR5cGUpO1xyXG4gICAgICBjb25zdCBtb2RhbENvbnRlbnRJbmplY3RvciA9IFJlZmxlY3RpdmVJbmplY3Rvci5yZXNvbHZlQW5kQ3JlYXRlKFtdLCBmcmFtZUNvbnRleHQuaW5qZWN0b3IpO1xyXG4gICAgICBjb21wb25lbnRSZWYgPSBjb250ZW50Q21wdEZhY3RvcnkuY3JlYXRlKG1vZGFsQ29udGVudEluamVjdG9yKTtcclxuICAgICAgaWYgKGNvbXBvbmVudFJlZiAmJiBjb21wb25lbnRSZWYuaW5zdGFuY2UgJiYgY29tcG9uZW50UmVmLmluc3RhbmNlLnZpZXdNb2RlbCAmJiBjb21wb25lbnRSZWYuaW5zdGFuY2Uudmlld01vZGVsLnVpU3RhdGUpIHtcclxuICAgICAgICBpZiAodHlwZW9mIHVpU3RhdGVPYmplY3QgPT09ICdvYmplY3QnICYmIE9iamVjdC5rZXlzKHVpU3RhdGVPYmplY3QpLmxlbmd0aCkge1xyXG4gICAgICAgICAgT2JqZWN0LmtleXModWlTdGF0ZU9iamVjdCkuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICAgICAgY29tcG9uZW50UmVmLmluc3RhbmNlLnZpZXdNb2RlbC51aVN0YXRlLnNldFByb3BlcnR5VmFsdWUoaXRlbSwgdWlTdGF0ZU9iamVjdFtpdGVtXSk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g6ZmE5YqgaXNEaWFsb2flj4LmlbBcclxuICAgICAgICBjb21wb25lbnRSZWYuaW5zdGFuY2Uudmlld01vZGVsLnVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZSgnREVWS0lUX0RJQUxPRycsIHRydWUpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gY29tcG9uZW50UmVmO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlhbzlrrnml6flvLnnqpfvvIzojrflj5ZmcmFtZUNvbnRleHRcclxuICAgKi9cclxuICBwcml2YXRlIGdldEZyYW1lQ29udGV4dCgpIHtcclxuICAgIGlmICh0aGlzLmZyYW1lQ29udGV4dCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHRcclxuICAgIH1cclxuICAgIGlmICh0aGlzWydjb250ZXh0J10gJiYgdGhpc1snY29udGV4dCddWydmcmFtZUNvbnRleHQnXSkge1xyXG4gICAgICByZXR1cm4gdGhpc1snY29udGV4dCddWydmcmFtZUNvbnRleHQnXTtcclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlhbzlrrnml6flvLnnqpfvvIzojrflj5ZDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXJcclxuICAgKi9cclxuICBwcml2YXRlIGdldENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcigpIHtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0RnJhbWVDb250ZXh0KCk7XHJcbiAgICBsZXQgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyOiBhbnk7XHJcbiAgICBpZiAoZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlciA9IGZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQoQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyKTtcclxuICAgIH1cclxuICAgIHJldHVybiBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI7XHJcbiAgfVxyXG4gIC8vI2VuZHJlZ2lvblxyXG59XHJcbiJdfQ==