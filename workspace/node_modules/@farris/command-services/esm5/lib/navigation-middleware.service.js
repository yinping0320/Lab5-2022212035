import { Injectable, Optional } from '@angular/core';
import { EMPTY, of } from 'rxjs';
import { switchMap, throwIfEmpty } from 'rxjs/operators';
import { INSIDE_DIALOG_TOKEN, TAB_EVENT } from './types';
import { NavigationService } from './navigation.service';
import { FrameContext, UID } from '@farris/devkit';
import { FormMessageService } from './form-message.service';
import { LanguageService } from './languag.service';
import { CardDataService } from './data-services/card-data.service';
import { DataChangeDetectionService } from './data-change-detection.service';
/**
 * 导航中间件服务
 * @scope FrameComponent
 */
// tslint:disable: no-string-literal
var NavigationMiddlewareService = /** @class */ (function () {
    function NavigationMiddlewareService(navigationService, frameContext, msgService, languageService, cardDataService) {
        this.navigationService = navigationService;
        this.frameContext = frameContext;
        this.msgService = msgService;
        this.languageService = languageService;
        this.cardDataService = cardDataService;
        this.repository = frameContext.repository;
        if (!this.languageService) {
            this.languageService = LanguageService.getInstance();
        }
        if (this.frameContext) {
            this.appContext = this.frameContext.getFormAppContext() || null;
        }
    }
    /**
     * 关闭前处理
     */
    NavigationMiddlewareService.prototype.onClosing = function () {
        var _this = this;
        if (this.isInDialog()) {
            return;
        }
        this.navigationService.addEventListener(TAB_EVENT.onTabClosing, function (options) {
            if (!_this.frameContext || _this.frameContext.isDisposed) {
                return of(true);
            }
            return _this.isChanged.pipe(switchMap(function (changed) {
                if (changed && !_this.appContext.opened) {
                    // 如果需要用户确认就切换到当前tab
                    if (options && options.beforeCloseHandle && typeof options.beforeCloseHandle === 'function') {
                        options.beforeCloseHandle({ selectedChange: true });
                    }
                    var conform = _this.msgService.question(_this.languageService['exitWithoutSave']);
                    /*记录弹窗已打开*/
                    _this.appContext.opened = true;
                    return conform.pipe(switchMap(function (result) {
                        _this.appContext.opened = false;
                        if (result) {
                            /*记录用户关闭弹窗*/
                            if (!!_this.cardDataService) {
                                var revert$ = _this.cardDataService.revert(options);
                                return revert$.pipe(switchMap(function () { return of(result); }));
                            }
                        }
                        return of(result);
                    }));
                }
                else if (changed && _this.appContext.opened) {
                    return of(false);
                }
                else {
                    return of(true);
                }
            }));
        });
    };
    /**
     * 是否在是弹窗窗口内
     */
    NavigationMiddlewareService.prototype.isInDialog = function () {
        var frameContext = this.frameContext;
        var isDialogRootComponent = frameContext.frameComponent['isDialogRootComponent'] || false;
        while (frameContext.parent !== null && !isDialogRootComponent) {
            frameContext = frameContext.parent;
            isDialogRootComponent = frameContext.frameComponent['isDialogRootComponent'];
        }
        if (!isDialogRootComponent) {
            isDialogRootComponent = this.frameContext.injector.get(INSIDE_DIALOG_TOKEN, false);
        }
        return isDialogRootComponent;
    };
    /**
     * 获取tabid,如果targetId存在则直接使用targetId
     * @description 将用户要查看的数据id转换为运行框架需要的tabId
     * @param params - router参数
     * @param targetId - 要编辑/查看的数据id
     */
    NavigationMiddlewareService.prototype.getTabId = function (params, targetId) {
        if (!!targetId) {
            return targetId;
        }
        var paramsObj = null;
        if (!!params && params.startsWith('{') && params.endsWith('}')) {
            paramsObj = JSON.parse(params);
        }
        var paramId = null;
        if (paramsObj && paramsObj.hasOwnProperty('id') && !!paramsObj.id) {
            paramId = paramsObj.id;
        }
        else {
            paramId = UID.create();
        }
        return paramId;
    };
    Object.defineProperty(NavigationMiddlewareService.prototype, "isChanged", {
        /**
         * 是否有未保存的变更
         */
        get: function () {
            return DataChangeDetectionService.hasChange(this.frameContext).pipe(throwIfEmpty(function () { return EMPTY; }));
        },
        enumerable: true,
        configurable: true
    });
    NavigationMiddlewareService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    NavigationMiddlewareService.ctorParameters = function () { return [
        { type: NavigationService },
        { type: FrameContext },
        { type: FormMessageService },
        { type: LanguageService, decorators: [{ type: Optional }] },
        { type: CardDataService }
    ]; };
    return NavigationMiddlewareService;
}());
export { NavigationMiddlewareService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdGlvbi1taWRkbGV3YXJlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvbmF2aWdhdGlvbi1taWRkbGV3YXJlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLEtBQUssRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsU0FBUyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3pELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3pELE9BQU8sRUFBYyxZQUFZLEVBQWMsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0UsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUNwRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUM3RTs7O0dBR0c7QUFDSCxvQ0FBb0M7QUFDcEM7SUFLRSxxQ0FDVSxpQkFBb0MsRUFDcEMsWUFBMEIsRUFDMUIsVUFBOEIsRUFDbEIsZUFBZ0MsRUFDNUMsZUFBZ0M7UUFKaEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUNwQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFvQjtRQUNsQixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDNUMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBRXhD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Q0FBQyxDQUFDO1FBQy9GLENBQUM7OztPQUFBOztnQkF6R0YsVUFBVTs7OztnQkFYRixpQkFBaUI7Z0JBQ0wsWUFBWTtnQkFDeEIsa0JBQWtCO2dCQUNsQixlQUFlLHVCQWlCbkIsUUFBUTtnQkFoQkosZUFBZTs7SUFpSHhCLGtDQUFDO0NBQUEsQUExR0QsSUEwR0M7U0F6R1ksMkJBQTJCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRU1QVFksIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHN3aXRjaE1hcCwgdGhyb3dJZkVtcHR5IH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBJTlNJREVfRElBTE9HX1RPS0VOLCBUQUJfRVZFTlQgfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgTmF2aWdhdGlvblNlcnZpY2UgfSBmcm9tICcuL25hdmlnYXRpb24uc2VydmljZSc7XHJcbmltcG9ydCB7IEFwcENvbnRleHQsIEZyYW1lQ29udGV4dCwgUmVwb3NpdG9yeSwgVUlEIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBGb3JtTWVzc2FnZVNlcnZpY2UgfSBmcm9tICcuL2Zvcm0tbWVzc2FnZS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9sYW5ndWFnLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBDYXJkRGF0YVNlcnZpY2UgfSBmcm9tICcuL2RhdGEtc2VydmljZXMvY2FyZC1kYXRhLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBEYXRhQ2hhbmdlRGV0ZWN0aW9uU2VydmljZSB9IGZyb20gJy4vZGF0YS1jaGFuZ2UtZGV0ZWN0aW9uLnNlcnZpY2UnO1xyXG4vKipcclxuICog5a+86Iiq5Lit6Ze05Lu25pyN5YqhXHJcbiAqIEBzY29wZSBGcmFtZUNvbXBvbmVudFxyXG4gKi9cclxuLy8gdHNsaW50OmRpc2FibGU6IG5vLXN0cmluZy1saXRlcmFsXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIE5hdmlnYXRpb25NaWRkbGV3YXJlU2VydmljZSB7XHJcbiAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT47XHJcblxyXG4gIHByaXZhdGUgYXBwQ29udGV4dDogQXBwQ29udGV4dDtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgbmF2aWdhdGlvblNlcnZpY2U6IE5hdmlnYXRpb25TZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCxcclxuICAgIHByaXZhdGUgbXNnU2VydmljZTogRm9ybU1lc3NhZ2VTZXJ2aWNlLFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IExhbmd1YWdlU2VydmljZSxcclxuICAgIHByaXZhdGUgY2FyZERhdGFTZXJ2aWNlOiBDYXJkRGF0YVNlcnZpY2VcclxuICApIHtcclxuICAgIHRoaXMucmVwb3NpdG9yeSA9IGZyYW1lQ29udGV4dC5yZXBvc2l0b3J5O1xyXG4gICAgaWYgKCF0aGlzLmxhbmd1YWdlU2VydmljZSkge1xyXG4gICAgICB0aGlzLmxhbmd1YWdlU2VydmljZSA9IExhbmd1YWdlU2VydmljZS5nZXRJbnN0YW5jZSgpO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIHRoaXMuYXBwQ29udGV4dCA9IHRoaXMuZnJhbWVDb250ZXh0LmdldEZvcm1BcHBDb250ZXh0KCkgfHwgbnVsbDtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5YWz6Zet5YmN5aSE55CGXHJcbiAgICovXHJcbiAgcHVibGljIG9uQ2xvc2luZygpIHtcclxuICAgIGlmICh0aGlzLmlzSW5EaWFsb2coKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLm5hdmlnYXRpb25TZXJ2aWNlLmFkZEV2ZW50TGlzdGVuZXIoVEFCX0VWRU5ULm9uVGFiQ2xvc2luZywgKG9wdGlvbnMpID0+IHtcclxuICAgICAgaWYgKCF0aGlzLmZyYW1lQ29udGV4dCB8fCB0aGlzLmZyYW1lQ29udGV4dC5pc0Rpc3Bvc2VkKSB7XHJcbiAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB0aGlzLmlzQ2hhbmdlZC5waXBlKHN3aXRjaE1hcCgoY2hhbmdlZDogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgIGlmIChjaGFuZ2VkICYmICF0aGlzLmFwcENvbnRleHQub3BlbmVkKSB7XHJcbiAgICAgICAgICAvLyDlpoLmnpzpnIDopoHnlKjmiLfnoa7orqTlsLHliIfmjaLliLDlvZPliY10YWJcclxuICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuYmVmb3JlQ2xvc2VIYW5kbGUgJiYgdHlwZW9mIG9wdGlvbnMuYmVmb3JlQ2xvc2VIYW5kbGUgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgb3B0aW9ucy5iZWZvcmVDbG9zZUhhbmRsZSh7IHNlbGVjdGVkQ2hhbmdlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgY29uZm9ybSA9IHRoaXMubXNnU2VydmljZS5xdWVzdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZVsnZXhpdFdpdGhvdXRTYXZlJ10pO1xyXG4gICAgICAgICAgLyrorrDlvZXlvLnnqpflt7LmiZPlvIAqL1xyXG4gICAgICAgICAgdGhpcy5hcHBDb250ZXh0Lm9wZW5lZCA9IHRydWU7XHJcbiAgICAgICAgICByZXR1cm4gY29uZm9ybS5waXBlKFxyXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKHJlc3VsdDogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICAgIHRoaXMuYXBwQ29udGV4dC5vcGVuZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICAvKuiusOW9leeUqOaIt+WFs+mXreW8ueeqlyovXHJcbiAgICAgICAgICAgICAgICBpZiAoISF0aGlzLmNhcmREYXRhU2VydmljZSkge1xyXG4gICAgICAgICAgICAgICAgICBjb25zdCByZXZlcnQkID0gdGhpcy5jYXJkRGF0YVNlcnZpY2UucmV2ZXJ0KG9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICByZXR1cm4gcmV2ZXJ0JC5waXBlKFxyXG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiBvZihyZXN1bHQpKVxyXG4gICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICByZXR1cm4gb2YocmVzdWx0KTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChjaGFuZ2VkICYmIHRoaXMuYXBwQ29udGV4dC5vcGVuZWQpIHtcclxuICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmmK/lkKblnKjmmK/lvLnnqpfnqpflj6PlhoVcclxuICAgKi9cclxuICBwcml2YXRlIGlzSW5EaWFsb2coKSB7XHJcbiAgICBsZXQgZnJhbWVDb250ZXh0ID0gdGhpcy5mcmFtZUNvbnRleHQ7XHJcbiAgICBsZXQgaXNEaWFsb2dSb290Q29tcG9uZW50ID0gZnJhbWVDb250ZXh0LmZyYW1lQ29tcG9uZW50Wydpc0RpYWxvZ1Jvb3RDb21wb25lbnQnXSB8fCBmYWxzZTtcclxuICAgIHdoaWxlIChmcmFtZUNvbnRleHQucGFyZW50ICE9PSBudWxsICYmICFpc0RpYWxvZ1Jvb3RDb21wb25lbnQpIHtcclxuICAgICAgZnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0LnBhcmVudDtcclxuICAgICAgaXNEaWFsb2dSb290Q29tcG9uZW50ID0gZnJhbWVDb250ZXh0LmZyYW1lQ29tcG9uZW50Wydpc0RpYWxvZ1Jvb3RDb21wb25lbnQnXTtcclxuICAgIH1cclxuICAgIGlmICghaXNEaWFsb2dSb290Q29tcG9uZW50KSB7XHJcbiAgICAgIGlzRGlhbG9nUm9vdENvbXBvbmVudCA9IHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxib29sZWFuPihJTlNJREVfRElBTE9HX1RPS0VOLCBmYWxzZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaXNEaWFsb2dSb290Q29tcG9uZW50O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5Z0YWJpZCzlpoLmnpx0YXJnZXRJZOWtmOWcqOWImeebtOaOpeS9v+eUqHRhcmdldElkXHJcbiAgICogQGRlc2NyaXB0aW9uIOWwhueUqOaIt+imgeafpeeci+eahOaVsOaNrmlk6L2s5o2i5Li66L+Q6KGM5qGG5p626ZyA6KaB55qEdGFiSWRcclxuICAgKiBAcGFyYW0gcGFyYW1zIC0gcm91dGVy5Y+C5pWwXHJcbiAgICogQHBhcmFtIHRhcmdldElkIC0g6KaB57yW6L6RL+afpeeci+eahOaVsOaNrmlkXHJcbiAgICovXHJcbiAgcHVibGljIGdldFRhYklkKHBhcmFtczogc3RyaW5nLCB0YXJnZXRJZDogc3RyaW5nKTogYW55IHtcclxuICAgIGlmICghIXRhcmdldElkKSB7XHJcbiAgICAgIHJldHVybiB0YXJnZXRJZDtcclxuICAgIH1cclxuICAgIGxldCBwYXJhbXNPYmo6IGFueSA9IG51bGw7XHJcbiAgICBpZiAoISFwYXJhbXMgJiYgcGFyYW1zLnN0YXJ0c1dpdGgoJ3snKSAmJiBwYXJhbXMuZW5kc1dpdGgoJ30nKSkge1xyXG4gICAgICBwYXJhbXNPYmogPSBKU09OLnBhcnNlKHBhcmFtcyk7XHJcbiAgICB9XHJcbiAgICBsZXQgcGFyYW1JZCA9IG51bGw7XHJcbiAgICBpZiAocGFyYW1zT2JqICYmIHBhcmFtc09iai5oYXNPd25Qcm9wZXJ0eSgnaWQnKSAmJiAhIXBhcmFtc09iai5pZCkge1xyXG4gICAgICBwYXJhbUlkID0gcGFyYW1zT2JqLmlkO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcGFyYW1JZCA9IFVJRC5jcmVhdGUoKTtcclxuICAgIH1cclxuICAgIHJldHVybiBwYXJhbUlkO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmmK/lkKbmnInmnKrkv53lrZjnmoTlj5jmm7RcclxuICAgKi9cclxuICBwcml2YXRlIGdldCBpc0NoYW5nZWQoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICByZXR1cm4gRGF0YUNoYW5nZURldGVjdGlvblNlcnZpY2UuaGFzQ2hhbmdlKHRoaXMuZnJhbWVDb250ZXh0KS5waXBlKHRocm93SWZFbXB0eSgoKT0+RU1QVFkpKTtcclxuICB9XHJcbn1cclxuIl19