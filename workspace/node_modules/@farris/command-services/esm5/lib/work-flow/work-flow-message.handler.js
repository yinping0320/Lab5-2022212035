import { Injectable, Injector } from "@angular/core";
import { AppContextManager, FrameContext } from "@farris/devkit";
import { from, of } from "rxjs";
import { BefRepositoryUtil } from '@farris/bef';
import { concatMap, throwIfEmpty } from "rxjs/operators";
import { ValidationService } from "../validation.service";
import { WorkFlowMessage } from "./work-flow-message";
import { WorkFlowMessageService } from "./work-flow-message.service";
var WorkFlowMessageHandler = /** @class */ (function () {
    function WorkFlowMessageHandler(injector, frameContext, workFlowMessageService, workFlowMessage) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.workFlowMessageService = workFlowMessageService;
        this.workFlowMessage = workFlowMessage;
    }
    WorkFlowMessageHandler.prototype.onComponentInit = function (frameContext) {
        var _this = this;
        var eventId = this.workFlowMessage.addEventListener(this.handle.bind(this));
        var frameContextDestroySignal = this.frameContext.destorySignal;
        if (frameContextDestroySignal) {
            frameContextDestroySignal.subscribe(function () {
                _this.workFlowMessage.removeEventListener(eventId);
            });
        }
        var appContextDestroySignal = this.frameContext.appContext.destorySignal;
        if (appContextDestroySignal) {
            appContextDestroySignal.subscribe(function () {
                _this.workFlowMessage.workFlowMessageService.destroy();
            });
        }
    };
    WorkFlowMessageHandler.prototype.handle = function (message) {
        var _this = this;
        var source = message.sender;
        var data = message.data;
        var commandName = data && data.command || null;
        var resultTask = null;
        if (!commandName) {
            return;
        }
        if (commandName == 'wf-required-verification') {
            // 工作流的必填校验
            // 如此获取的是当前组件的校验服务，应该按namespace来区分，不同的namespace需要分别执行校验
            var formFrameContexts = this.getFormFrameContexts();
            resultTask = from(formFrameContexts).pipe(concatMap(function (frameContext) {
                var validation = frameContext.injector.get(ValidationService, null);
                if (validation) {
                    return validation.validateAll();
                }
                return of(true);
            }));
        }
        else {
            var command = this.frameContext.viewModel[commandName];
            if (command) {
                resultTask = command(data.arguments);
            }
        }
        if (resultTask) {
            var message_1 = this.buildMessage(true, source, this.isChanged);
            resultTask.pipe(throwIfEmpty()).subscribe(function (result) {
                // 向来源方回传消息
                _this.workFlowMessageService.send(message_1);
            }, function () {
                message_1.data.result = false;
                _this.workFlowMessageService.send(message_1);
            });
        }
    };
    WorkFlowMessageHandler.prototype.buildMessage = function (result, target, dataChanged, type) {
        if (type === void 0) { type = 'message'; }
        var message = {
            data: {
                result: result,
                dataChanged: dataChanged
            },
            type: type,
            target: target,
        };
        return message;
    };
    WorkFlowMessageHandler.prototype.getFormFrameContexts = function () {
        var appContextManager = this.injector.get(AppContextManager, null);
        var formFrameContexts = [];
        if (appContextManager) {
            var appContexts = appContextManager.getAppContexts();
            if (appContexts && appContexts.length > 0) {
                appContexts.forEach(function (appContext) {
                    var frameContexts = appContext.frameContextManager.getFrameContexts();
                    frameContexts.reduce(function (contexts, frameContext) {
                        var namespace = frameContext.namespace;
                        var index = contexts.findIndex(function (frame) { return frame.namespace === namespace; });
                        if (index === -1) {
                            var root = frameContext.getVirtualRootFrameContext();
                            contexts.push(root);
                        }
                        return contexts;
                    }, formFrameContexts);
                });
            }
        }
        return formFrameContexts;
    };
    Object.defineProperty(WorkFlowMessageHandler.prototype, "isChanged", {
        /**
         * 是否有未保存的变更
         */
        get: function () {
            var befRepository = this.frameContext.repository;
            return BefRepositoryUtil.isExistUnsaveData(befRepository);
        },
        enumerable: true,
        configurable: true
    });
    WorkFlowMessageHandler.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    WorkFlowMessageHandler.ctorParameters = function () { return [
        { type: Injector },
        { type: FrameContext },
        { type: WorkFlowMessageService },
        { type: WorkFlowMessage }
    ]; };
    return WorkFlowMessageHandler;
}());
export { WorkFlowMessageHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29yay1mbG93LW1lc3NhZ2UuaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi93b3JrLWZsb3cvd29yay1mbG93LW1lc3NhZ2UuaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQWMsaUJBQWlCLEVBQUUsWUFBWSxFQUF3QixNQUFNLGdCQUFnQixDQUFDO0FBQ25HLE9BQU8sRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVDLE9BQU8sRUFBaUIsaUJBQWlCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDL0QsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUUxRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFFckU7SUFFRSxnQ0FBb0IsUUFBa0IsRUFBVSxZQUEwQixFQUFVLHNCQUE4QyxFQUFVLGVBQWdDO1FBQXhKLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUFVLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7UUFBVSxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7SUFFNUssQ0FBQztJQUNNLGdEQUFlLEdBQXRCLFVBQXVCLFlBQTBCO1FBQWpELGlCQWNDO1FBYkMsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQzlFLElBQU0seUJB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O1lBQ3pFLE9BQU8saUJBQWlCLENBQUMsaUJBQWlCLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDNUQsQ0FBQzs7O09BQUE7O2dCQWpHRixVQUFVOzs7O2dCQVZVLFFBQVE7Z0JBQ1csWUFBWTtnQkFPM0Msc0JBQXNCO2dCQUR0QixlQUFlOztJQXFHeEIsNkJBQUM7Q0FBQSxBQWxHRCxJQWtHQztTQWpHWSxzQkFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IEFwcENvbnRleHQsIEFwcENvbnRleHRNYW5hZ2VyLCBGcmFtZUNvbnRleHQsIG9uRnJhbWVDb21wb25lbnRJbml0IH0gZnJvbSBcIkBmYXJyaXMvZGV2a2l0XCI7XHJcbmltcG9ydCB7IGZyb20sIE9ic2VydmFibGUsIG9mIH0gZnJvbSBcInJ4anNcIjtcclxuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSwgQmVmUmVwb3NpdG9yeVV0aWwgfSBmcm9tICdAZmFycmlzL2JlZic7XHJcbmltcG9ydCB7IGNvbmNhdE1hcCwgdGhyb3dJZkVtcHR5IH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XHJcbmltcG9ydCB7IFZhbGlkYXRpb25TZXJ2aWNlIH0gZnJvbSBcIi4uL3ZhbGlkYXRpb24uc2VydmljZVwiO1xyXG5pbXBvcnQgeyBXb3JrRmxvdyB9IGZyb20gXCIuL3R5cGVzXCI7XHJcbmltcG9ydCB7IFdvcmtGbG93TWVzc2FnZSB9IGZyb20gXCIuL3dvcmstZmxvdy1tZXNzYWdlXCI7XHJcbmltcG9ydCB7IFdvcmtGbG93TWVzc2FnZVNlcnZpY2UgfSBmcm9tIFwiLi93b3JrLWZsb3ctbWVzc2FnZS5zZXJ2aWNlXCI7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBXb3JrRmxvd01lc3NhZ2VIYW5kbGVyIGltcGxlbWVudHMgb25GcmFtZUNvbXBvbmVudEluaXQge1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBwcml2YXRlIHdvcmtGbG93TWVzc2FnZVNlcnZpY2U6IFdvcmtGbG93TWVzc2FnZVNlcnZpY2UsIHByaXZhdGUgd29ya0Zsb3dNZXNzYWdlOiBXb3JrRmxvd01lc3NhZ2UpIHtcclxuXHJcbiAgfVxyXG4gIHB1YmxpYyBvbkNvbXBvbmVudEluaXQoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpIHtcclxuICAgIGNvbnN0IGV2ZW50SWQgPSB0aGlzLndvcmtGbG93TWVzc2FnZS5hZGRFdmVudExpc3RlbmVyKHRoaXMuaGFuZGxlLmJpbmQodGhpcykpO1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0RGVzdHJveVNpZ25hbCA9IHRoaXMuZnJhbWVDb250ZXh0LmRlc3RvcnlTaWduYWw7XHJcbiAgICBpZiAoZnJhbWVDb250ZXh0RGVzdHJveVNpZ25hbCkge1xyXG4gICAgICBmcmFtZUNvbnRleHREZXN0cm95U2lnbmFsLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy53b3JrRmxvd01lc3NhZ2UucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudElkKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBhcHBDb250ZXh0RGVzdHJveVNpZ25hbCA9IHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZGVzdG9yeVNpZ25hbDtcclxuICAgIGlmIChhcHBDb250ZXh0RGVzdHJveVNpZ25hbCkge1xyXG4gICAgICBhcHBDb250ZXh0RGVzdHJveVNpZ25hbC5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMud29ya0Zsb3dNZXNzYWdlLndvcmtGbG93TWVzc2FnZVNlcnZpY2UuZGVzdHJveSgpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgcHVibGljIGhhbmRsZShtZXNzYWdlOiBXb3JrRmxvdy5JTWVzc2FnZSk6IHZvaWQge1xyXG4gICAgY29uc3Qgc291cmNlID0gbWVzc2FnZS5zZW5kZXIgYXMgV2luZG93O1xyXG4gICAgY29uc3QgZGF0YSA9IG1lc3NhZ2UuZGF0YSBhcyBXb3JrRmxvdy5JTWVzc2FnZUJvZHk7XHJcbiAgICBjb25zdCBjb21tYW5kTmFtZSA9IGRhdGEgJiYgZGF0YS5jb21tYW5kIHx8IG51bGw7XHJcbiAgICBsZXQgcmVzdWx0VGFzazogT2JzZXJ2YWJsZTxhbnk+ID0gbnVsbDtcclxuICAgIGlmICghY29tbWFuZE5hbWUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKGNvbW1hbmROYW1lID09ICd3Zi1yZXF1aXJlZC12ZXJpZmljYXRpb24nKSB7XHJcbiAgICAgIC8vIOW3peS9nOa1geeahOW/heWhq+agoemqjFxyXG4gICAgICAvLyDlpoLmraTojrflj5bnmoTmmK/lvZPliY3nu4Tku7bnmoTmoKHpqozmnI3liqHvvIzlupTor6XmjIluYW1lc3BhY2XmnaXljLrliIbvvIzkuI3lkIznmoRuYW1lc3BhY2XpnIDopoHliIbliKvmiafooYzmoKHpqoxcclxuICAgICAgY29uc3QgZm9ybUZyYW1lQ29udGV4dHMgPSB0aGlzLmdldEZvcm1GcmFtZUNvbnRleHRzKCk7XHJcbiAgICAgIHJlc3VsdFRhc2sgPSBmcm9tKGZvcm1GcmFtZUNvbnRleHRzKS5waXBlKFxyXG4gICAgICAgIGNvbmNhdE1hcCgoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgICAgIHZhciB2YWxpZGF0aW9uID0gZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxWYWxpZGF0aW9uU2VydmljZT4oVmFsaWRhdGlvblNlcnZpY2UsIG51bGwpO1xyXG4gICAgICAgICAgaWYgKHZhbGlkYXRpb24pIHtcclxuICAgICAgICAgICAgcmV0dXJuIHZhbGlkYXRpb24udmFsaWRhdGVBbGwoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgICB9KVxyXG4gICAgICApO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdmFyIGNvbW1hbmQgPSB0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWxbY29tbWFuZE5hbWVdO1xyXG4gICAgICBpZiAoY29tbWFuZCkge1xyXG4gICAgICAgIHJlc3VsdFRhc2sgPSBjb21tYW5kKGRhdGEuYXJndW1lbnRzKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKHJlc3VsdFRhc2spIHtcclxuICAgICAgY29uc3QgbWVzc2FnZTogV29ya0Zsb3cuSU1lc3NhZ2UgPSB0aGlzLmJ1aWxkTWVzc2FnZSh0cnVlLCBzb3VyY2UsIHRoaXMuaXNDaGFuZ2VkKTtcclxuICAgICAgcmVzdWx0VGFzay5waXBlKHRocm93SWZFbXB0eSgpKS5zdWJzY3JpYmUoKHJlc3VsdCkgPT4ge1xyXG4gICAgICAgIC8vIOWQkeadpea6kOaWueWbnuS8oOa2iOaBr1xyXG4gICAgICAgIHRoaXMud29ya0Zsb3dNZXNzYWdlU2VydmljZS5zZW5kKG1lc3NhZ2UpO1xyXG4gICAgICB9LCAoKSA9PiB7XHJcbiAgICAgICAgbWVzc2FnZS5kYXRhLnJlc3VsdCA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMud29ya0Zsb3dNZXNzYWdlU2VydmljZS5zZW5kKG1lc3NhZ2UpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBidWlsZE1lc3NhZ2UocmVzdWx0OiBib29sZWFuLCB0YXJnZXQ6IGFueSwgZGF0YUNoYW5nZWQ6IGJvb2xlYW4sIHR5cGU6IHN0cmluZyA9ICdtZXNzYWdlJykge1xyXG4gICAgY29uc3QgbWVzc2FnZTogV29ya0Zsb3cuSU1lc3NhZ2UgPSB7XHJcbiAgICAgIGRhdGE6IHtcclxuICAgICAgICByZXN1bHQsXHJcbiAgICAgICAgZGF0YUNoYW5nZWRcclxuICAgICAgfSxcclxuICAgICAgdHlwZTogdHlwZSxcclxuICAgICAgdGFyZ2V0OiB0YXJnZXQsXHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIG1lc3NhZ2U7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0Rm9ybUZyYW1lQ29udGV4dHMoKTogRnJhbWVDb250ZXh0W10ge1xyXG4gICAgY29uc3QgYXBwQ29udGV4dE1hbmFnZXIgPSB0aGlzLmluamVjdG9yLmdldDxBcHBDb250ZXh0TWFuYWdlcj4oQXBwQ29udGV4dE1hbmFnZXIsIG51bGwpO1xyXG4gICAgY29uc3QgZm9ybUZyYW1lQ29udGV4dHMgPSBbXTtcclxuICAgIGlmIChhcHBDb250ZXh0TWFuYWdlcikge1xyXG4gICAgICBjb25zdCBhcHBDb250ZXh0czogQXBwQ29udGV4dFtdID0gYXBwQ29udGV4dE1hbmFnZXIuZ2V0QXBwQ29udGV4dHMoKTtcclxuICAgICAgaWYgKGFwcENvbnRleHRzICYmIGFwcENvbnRleHRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBhcHBDb250ZXh0cy5mb3JFYWNoKChhcHBDb250ZXh0OiBBcHBDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBmcmFtZUNvbnRleHRzOiBGcmFtZUNvbnRleHRbXSA9IGFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzKCk7XHJcbiAgICAgICAgICBmcmFtZUNvbnRleHRzLnJlZHVjZSgoY29udGV4dHM6IEZyYW1lQ29udGV4dFtdLCBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lc3BhY2UgPSBmcmFtZUNvbnRleHQubmFtZXNwYWNlO1xyXG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IGNvbnRleHRzLmZpbmRJbmRleCgoZnJhbWU6IEZyYW1lQ29udGV4dCkgPT4gZnJhbWUubmFtZXNwYWNlID09PSBuYW1lc3BhY2UpO1xyXG4gICAgICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgY29uc3Qgcm9vdCA9IGZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpO1xyXG4gICAgICAgICAgICAgIGNvbnRleHRzLnB1c2gocm9vdCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGNvbnRleHRzO1xyXG4gICAgICAgICAgfSwgZm9ybUZyYW1lQ29udGV4dHMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZm9ybUZyYW1lQ29udGV4dHM7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaYr+WQpuacieacquS/neWtmOeahOWPmOabtFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0IGlzQ2hhbmdlZCgpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcclxuICAgIHJldHVybiBCZWZSZXBvc2l0b3J5VXRpbC5pc0V4aXN0VW5zYXZlRGF0YShiZWZSZXBvc2l0b3J5KTtcclxuICB9XHJcbn0iXX0=