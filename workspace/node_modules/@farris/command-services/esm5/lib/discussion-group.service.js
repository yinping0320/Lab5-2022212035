import * as tslib_1 from "tslib";
import { Injectable, Injector } from '@angular/core';
import { FrameContext } from '@farris/devkit';
import { FormLoadingService } from './form-loading/form-loading.service';
import { RuntimeFrameworkService } from './rtf-service';
import { tap } from 'rxjs/operators';
import { EMPTY } from 'rxjs';
import { BasePathService } from '@farris/rtf';
// tslint:disable: max-line-length
var DiscussionGroupService = /** @class */ (function () {
    function DiscussionGroupService(injector, frameContext, loadingService, runtimeFrameworkService) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.loadingService = loadingService;
        this.runtimeFrameworkService = runtimeFrameworkService;
    }
    Object.defineProperty(DiscussionGroupService.prototype, "repository", {
        /**
         * 实体仓库
         */
        get: function () {
            return this.frameContext.repository;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DiscussionGroupService.prototype, "params", {
        /**
         * 命令参数
         */
        get: function () {
            return this['context'] && this['context']['eventParam'] || {};
        },
        enumerable: true,
        configurable: true
    });
    DiscussionGroupService.prototype.addComment = function (id, summary, configId, text, visibility, parentId) {
        var _this = this;
        id = id || this.frameContext && this.frameContext.bindingData.list.currentId || null;
        if (!id) {
            return EMPTY;
        }
        var params = this.buildAddCommentParam(id, text, parentId, summary, visibility, configId);
        var restService = this.repository.restService;
        var url = BasePathService.convertPath('/api/runtime/comment/v1.0/bill-comment/comment');
        var requestInfo = restService.buildRequestInfo();
        var options = {
            body: tslib_1.__assign({ requestInfo: requestInfo }, params)
        };
        this.loadingService.show();
        return restService.invoke(url, 'POST', null, options).pipe(tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 查询评论
     * @param id id
     */
    DiscussionGroupService.prototype.queryComments = function (id, configId, pageIndex, pageSize) {
        var _this = this;
        id = id || this.frameContext && this.frameContext.bindingData.list.currentId || null;
        if (!id) {
            return EMPTY;
        }
        var restService = this.repository.restService;
        var url = this.buildQueryCommentsUrl(id, pageIndex, pageSize, configId);
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 查询所有部门信息
     */
    DiscussionGroupService.prototype.queryAllOrgs = function () {
        var _this = this;
        var restService = this.repository.restService;
        var url = BasePathService.convertPath('/api/runtime/sys/v1.0/sysOrgs?param={"layer":"1"}');
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 查询常用@用户
     * @param pageIndex
     * @param pageSize
     */
    DiscussionGroupService.prototype.queryFrequentAtUsers = function (pageIndex, pageSize) {
        var _this = this;
        var restService = this.repository.restService;
        var url = this.buildQueryFrequentAtUsersUrl(pageIndex, pageSize);
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 获取at用户列表
     * @param user 用户编号或者用户名称（过滤使用）
     * @param pageIndex pageIndex
     * @param pageSize pageSize
     */
    DiscussionGroupService.prototype.queryAtUsers = function (user, pageIndex, pageSize) {
        var _this = this;
        var restService = this.repository.restService;
        var url = this.buildQueryAtUsersUrl(user, pageIndex, pageSize);
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 构造获取评论列表的url
     * @param id id
     */
    DiscussionGroupService.prototype.buildQueryCommentsUrl = function (id, pageIndex, pageSize, configId) {
        if (typeof pageIndex === 'undefined' || pageIndex === null) {
            pageIndex = this.params.pageIndex || 0;
        }
        if (typeof pageSize === 'undefined' || pageSize === null) {
            pageSize = this.params.pageSize || 10;
        }
        var serverUri = this.repository.serverUri;
        // const funcId = this.runtimeFrameworkService && this.runtimeFrameworkService.funcId || '';
        return BasePathService.convertPath("/api/runtime/comment/v1.0/bill-comment/comment/byBill?configId=" + configId + "&billId=" + id + "&pageSize=" + pageSize + "&pageIndex=" + pageIndex);
    };
    /**
     * 构造获取@用户url
     */
    DiscussionGroupService.prototype.buildQueryAtUsersUrl = function (user, pageIndex, pageSize) {
        var params = [];
        if (typeof pageIndex === 'undefined' || pageIndex === null) {
            pageIndex = this.params.pageIndex || 0;
        }
        if (typeof pageSize === 'undefined' || pageSize === null) {
            pageSize = this.params.pageSize || 1000;
        }
        if (user) {
            params.push("param=" + user);
        }
        params.push("pageSize=" + pageSize);
        params.push("pageIndex=" + pageIndex);
        return BasePathService.convertPath("/api/runtime/comment/v1.0/bill-comment/atUser?" + params.join('&'));
    };
    DiscussionGroupService.prototype.buildQueryFrequentAtUsersUrl = function (pageIndex, pageSize) {
        var params = [];
        if (typeof pageIndex === 'undefined' || pageIndex === null) {
            pageIndex = this.params.pageIndex || 0;
        }
        if (typeof pageSize === 'undefined' || pageSize === null) {
            pageSize = this.params.pageSize || 6;
        }
        params.push("pageSize=" + pageSize);
        params.push("pageIndex=" + pageIndex);
        return BasePathService.convertPath("/api/runtime/comment/v1.0/bill-comment/frequentAtUsers?" + params.join('&'));
    };
    DiscussionGroupService.prototype.buildAddCommentParam = function (id, text, parentId, summary, visibility, configId) {
        if (typeof text === 'undefined') {
            text = this.params.text;
        }
        if (typeof parentId === 'undefined') {
            parentId = this.params.parentId;
        }
        if (typeof visibility === 'undefined') {
            visibility = this.params.visibility;
        }
        return {
            'bill': {
                'billId': id,
                'configId': configId,
                'summary': summary
            },
            'comment': {
                'billId': id,
                'configId': configId,
                'parentId': parentId || null,
                'text': text,
                'visibility': visibility
            }
        };
    };
    DiscussionGroupService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    DiscussionGroupService.ctorParameters = function () { return [
        { type: Injector },
        { type: FrameContext },
        { type: FormLoadingService },
        { type: RuntimeFrameworkService }
    ]; };
    return DiscussionGroupService;
}());
export { DiscussionGroupService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlzY3Vzc2lvbi1ncm91cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2Rpc2N1c3Npb24tZ3JvdXAuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLFlBQVksRUFBVSxNQUFNLGdCQUFnQixDQUFDO0FBRXRELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFrQixLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUM5QyxrQ0FBa0M7QUFDbEM7SUFjRSxnQ0FBb0IsUUFBa0IsRUFBVSxZQUEwQixFQUFVLGNBQWtDLEVBQVUsdUJBQWdEO1FBQTVKLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUFVLG1CQUFjLEdBQWQsY0FBYyxDQUFvQjtRQUFVLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBeUI7SUFDaEwsQ0FBQztJQVZELHNCQUFZLDhDQUFVO1FBSHRCOztXQUVHO2FBQ0g7WUFDRSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBbUMsQ0FBQztRQUMvRCxDQUFDOzs7T0FBQTtJQUlELHNCQUFZLDBDQUFNO1FBSGxCOztXQUVHO2FBQ0g7WUFDRSxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2hFLENBQUM7OztPQUFBO0lBSU0s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WixVQUFVLEVBQUUsUUFBUTtnQkFDcEIsVUFBVSxFQUFFLFFBQVEsSUFBSSxJQUFJO2dCQUM1QixNQUFNLEVBQUUsSUFBSTtnQkFDWixZQUFZLEVBQUUsVUFBVTthQUN6QjtTQUNGLENBQUE7SUFDSCxDQUFDOztnQkE1S0YsVUFBVTs7OztnQkFUVSxRQUFRO2dCQUNwQixZQUFZO2dCQUVaLGtCQUFrQjtnQkFDbEIsdUJBQXVCOztJQWtMaEMsNkJBQUM7Q0FBQSxBQTdLRCxJQTZLQztTQTVLWSxzQkFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQsIEVudGl0eSB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSB9IGZyb20gJ0BmYXJyaXMvYmVmJztcclxuaW1wb3J0IHsgRm9ybUxvYWRpbmdTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLWxvYWRpbmcvZm9ybS1sb2FkaW5nLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBSdW50aW1lRnJhbWV3b3JrU2VydmljZSB9IGZyb20gJy4vcnRmLXNlcnZpY2UnO1xyXG5pbXBvcnQgeyB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBFTVBUWSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBCYXNlUGF0aFNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3J0Zic7XHJcbi8vIHRzbGludDpkaXNhYmxlOiBtYXgtbGluZS1sZW5ndGhcclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRGlzY3Vzc2lvbkdyb3VwU2VydmljZSB7XHJcbiAgLyoqXHJcbiAgICog5a6e5L2T5LuT5bqTXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXQgcmVwb3NpdG9yeSgpOiBCZWZSZXBvc2l0b3J5PEVudGl0eT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxFbnRpdHk+O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlkb3ku6Tlj4LmlbBcclxuICAgKi9cclxuICBwcml2YXRlIGdldCBwYXJhbXMoKSB7XHJcbiAgICByZXR1cm4gdGhpc1snY29udGV4dCddICYmIHRoaXNbJ2NvbnRleHQnXVsnZXZlbnRQYXJhbSddIHx8IHt9O1xyXG4gIH1cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgcHJpdmF0ZSBsb2FkaW5nU2VydmljZTogRm9ybUxvYWRpbmdTZXJ2aWNlLCBwcml2YXRlIHJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlOiBSdW50aW1lRnJhbWV3b3JrU2VydmljZSkge1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFkZENvbW1lbnQoaWQ/OiBzdHJpbmcsIHN1bW1hcnk/OiBzdHJpbmcsIGNvbmZpZ0lkPzogc3RyaW5nLCB0ZXh0Pzogc3RyaW5nLCB2aXNpYmlsaXR5Pzogc3RyaW5nLCBwYXJlbnRJZD86IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBpZCA9IGlkIHx8IHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkIHx8IG51bGw7XHJcbiAgICBpZiAoIWlkKSB7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuYnVpbGRBZGRDb21tZW50UGFyYW0oaWQsIHRleHQsIHBhcmVudElkLCBzdW1tYXJ5LCB2aXNpYmlsaXR5LCBjb25maWdJZCk7XHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHRoaXMucmVwb3NpdG9yeS5yZXN0U2VydmljZTtcclxuICAgIGNvbnN0IHVybCA9IEJhc2VQYXRoU2VydmljZS5jb252ZXJ0UGF0aCgnL2FwaS9ydW50aW1lL2NvbW1lbnQvdjEuMC9iaWxsLWNvbW1lbnQvY29tbWVudCcpO1xyXG4gICAgY29uc3QgcmVxdWVzdEluZm8gPSByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKCk7XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBib2R5OiB7XHJcbiAgICAgICAgcmVxdWVzdEluZm8sXHJcbiAgICAgICAgLi4ucGFyYW1zXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UodXJsLCAnUE9TVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXHJcbiAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmn6Xor6Lor4TorrpcclxuICAgKiBAcGFyYW0gaWQgaWRcclxuICAgKi9cclxuICBwdWJsaWMgcXVlcnlDb21tZW50cyhpZDogc3RyaW5nLCBjb25maWdJZDogc3RyaW5nLCBwYWdlSW5kZXg/OiBudW1iZXIgfCBudWxsLCBwYWdlU2l6ZT86IG51bWJlciB8IG51bGwpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgaWQgPSBpZCB8fCB0aGlzLmZyYW1lQ29udGV4dCAmJiB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZCB8fCBudWxsO1xyXG4gICAgaWYgKCFpZCkge1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSB0aGlzLnJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XHJcblxyXG4gICAgY29uc3QgdXJsID0gdGhpcy5idWlsZFF1ZXJ5Q29tbWVudHNVcmwoaWQsIHBhZ2VJbmRleCwgcGFnZVNpemUsIGNvbmZpZ0lkKTtcclxuICAgIHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZSh1cmwsICdHRVQnKS5waXBlKFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p+l6K+i5omA5pyJ6YOo6Zeo5L+h5oGvXHJcbiAgICovXHJcbiAgcHVibGljIHF1ZXJ5QWxsT3JncygpIHtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5yZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgdXJsID0gQmFzZVBhdGhTZXJ2aWNlLmNvbnZlcnRQYXRoKCcvYXBpL3J1bnRpbWUvc3lzL3YxLjAvc3lzT3Jncz9wYXJhbT17XCJsYXllclwiOlwiMVwifScpO1xyXG4gICAgdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KCk7XHJcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKHVybCwgJ0dFVCcpLnBpcGUoXHJcbiAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmn6Xor6LluLjnlKhA55So5oi3XHJcbiAgICogQHBhcmFtIHBhZ2VJbmRleFxyXG4gICAqIEBwYXJhbSBwYWdlU2l6ZVxyXG4gICAqL1xyXG4gIHB1YmxpYyBxdWVyeUZyZXF1ZW50QXRVc2VycyhwYWdlSW5kZXg/OiBudW1iZXIgfCBudWxsLCBwYWdlU2l6ZT86IG51bWJlciB8IG51bGwpIHtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5yZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgdXJsID0gdGhpcy5idWlsZFF1ZXJ5RnJlcXVlbnRBdFVzZXJzVXJsKHBhZ2VJbmRleCwgcGFnZVNpemUpO1xyXG4gICAgdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KCk7XHJcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKHVybCwgJ0dFVCcpLnBpcGUoXHJcbiAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5ZhdOeUqOaIt+WIl+ihqFxyXG4gICAqIEBwYXJhbSB1c2VyIOeUqOaIt+e8luWPt+aIluiAheeUqOaIt+WQjeensO+8iOi/h+a7pOS9v+eUqO+8iVxyXG4gICAqIEBwYXJhbSBwYWdlSW5kZXggcGFnZUluZGV4XHJcbiAgICogQHBhcmFtIHBhZ2VTaXplIHBhZ2VTaXplXHJcbiAgICovXHJcbiAgcHVibGljIHF1ZXJ5QXRVc2Vycyh1c2VyPzogc3RyaW5nLCBwYWdlSW5kZXg/OiBudW1iZXIgfCBudWxsLCBwYWdlU2l6ZT86IG51bWJlciB8IG51bGwpIHtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5yZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgdXJsID0gdGhpcy5idWlsZFF1ZXJ5QXRVc2Vyc1VybCh1c2VyLCBwYWdlSW5kZXgsIHBhZ2VTaXplKTtcclxuICAgIHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZSh1cmwsICdHRVQnKS5waXBlKFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p6E6YCg6I635Y+W6K+E6K665YiX6KGo55qEdXJsXHJcbiAgICogQHBhcmFtIGlkIGlkXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZFF1ZXJ5Q29tbWVudHNVcmwoaWQ6IHN0cmluZywgcGFnZUluZGV4OiBudW1iZXIgfCBudWxsLCBwYWdlU2l6ZTogbnVtYmVyIHwgbnVsbCwgY29uZmlnSWQ6IHN0cmluZykge1xyXG4gICAgaWYgKHR5cGVvZiBwYWdlSW5kZXggPT09ICd1bmRlZmluZWQnIHx8IHBhZ2VJbmRleCA9PT0gbnVsbCkge1xyXG4gICAgICBwYWdlSW5kZXggPSB0aGlzLnBhcmFtcy5wYWdlSW5kZXggfHwgMDtcclxuICAgIH1cclxuICAgIGlmICh0eXBlb2YgcGFnZVNpemUgPT09ICd1bmRlZmluZWQnIHx8IHBhZ2VTaXplID09PSBudWxsKSB7XHJcbiAgICAgIHBhZ2VTaXplID0gdGhpcy5wYXJhbXMucGFnZVNpemUgfHwgMTA7XHJcbiAgICB9XHJcbiAgICBjb25zdCBzZXJ2ZXJVcmkgPSB0aGlzLnJlcG9zaXRvcnkuc2VydmVyVXJpO1xyXG4gICAgLy8gY29uc3QgZnVuY0lkID0gdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZSAmJiB0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlLmZ1bmNJZCB8fCAnJztcclxuICAgIHJldHVybiBCYXNlUGF0aFNlcnZpY2UuY29udmVydFBhdGgoYC9hcGkvcnVudGltZS9jb21tZW50L3YxLjAvYmlsbC1jb21tZW50L2NvbW1lbnQvYnlCaWxsP2NvbmZpZ0lkPSR7Y29uZmlnSWR9JmJpbGxJZD0ke2lkfSZwYWdlU2l6ZT0ke3BhZ2VTaXplfSZwYWdlSW5kZXg9JHtwYWdlSW5kZXh9YCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOiOt+WPlkDnlKjmiLd1cmxcclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkUXVlcnlBdFVzZXJzVXJsKHVzZXI/OiBzdHJpbmcsIHBhZ2VJbmRleD86IG51bWJlciB8IG51bGwsIHBhZ2VTaXplPzogbnVtYmVyIHwgbnVsbCkge1xyXG4gICAgY29uc3QgcGFyYW1zOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgaWYgKHR5cGVvZiBwYWdlSW5kZXggPT09ICd1bmRlZmluZWQnIHx8IHBhZ2VJbmRleCA9PT0gbnVsbCkge1xyXG4gICAgICBwYWdlSW5kZXggPSB0aGlzLnBhcmFtcy5wYWdlSW5kZXggfHwgMDtcclxuICAgIH1cclxuICAgIGlmICh0eXBlb2YgcGFnZVNpemUgPT09ICd1bmRlZmluZWQnIHx8IHBhZ2VTaXplID09PSBudWxsKSB7XHJcbiAgICAgIHBhZ2VTaXplID0gdGhpcy5wYXJhbXMucGFnZVNpemUgfHwgMTAwMDtcclxuICAgIH1cclxuICAgIGlmICh1c2VyKSB7XHJcbiAgICAgIHBhcmFtcy5wdXNoKGBwYXJhbT0ke3VzZXJ9YCk7XHJcbiAgICB9XHJcbiAgICBwYXJhbXMucHVzaChgcGFnZVNpemU9JHtwYWdlU2l6ZX1gKTtcclxuICAgIHBhcmFtcy5wdXNoKGBwYWdlSW5kZXg9JHtwYWdlSW5kZXh9YCk7XHJcbiAgICByZXR1cm4gQmFzZVBhdGhTZXJ2aWNlLmNvbnZlcnRQYXRoKGAvYXBpL3J1bnRpbWUvY29tbWVudC92MS4wL2JpbGwtY29tbWVudC9hdFVzZXI/JHtwYXJhbXMuam9pbignJicpfWApO1xyXG4gIH1cclxuICBwcml2YXRlIGJ1aWxkUXVlcnlGcmVxdWVudEF0VXNlcnNVcmwocGFnZUluZGV4PzogbnVtYmVyIHwgbnVsbCwgcGFnZVNpemU/OiBudW1iZXIgfCBudWxsKSB7XHJcbiAgICBjb25zdCBwYXJhbXM6IHN0cmluZ1tdID0gW107XHJcbiAgICBpZiAodHlwZW9mIHBhZ2VJbmRleCA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFnZUluZGV4ID09PSBudWxsKSB7XHJcbiAgICAgIHBhZ2VJbmRleCA9IHRoaXMucGFyYW1zLnBhZ2VJbmRleCB8fCAwO1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiBwYWdlU2l6ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFnZVNpemUgPT09IG51bGwpIHtcclxuICAgICAgcGFnZVNpemUgPSB0aGlzLnBhcmFtcy5wYWdlU2l6ZSB8fCA2O1xyXG4gICAgfVxyXG4gICAgcGFyYW1zLnB1c2goYHBhZ2VTaXplPSR7cGFnZVNpemV9YCk7XHJcbiAgICBwYXJhbXMucHVzaChgcGFnZUluZGV4PSR7cGFnZUluZGV4fWApO1xyXG4gICAgcmV0dXJuIEJhc2VQYXRoU2VydmljZS5jb252ZXJ0UGF0aChgL2FwaS9ydW50aW1lL2NvbW1lbnQvdjEuMC9iaWxsLWNvbW1lbnQvZnJlcXVlbnRBdFVzZXJzPyR7cGFyYW1zLmpvaW4oJyYnKX1gKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBidWlsZEFkZENvbW1lbnRQYXJhbShpZDogc3RyaW5nLCB0ZXh0OiBzdHJpbmcsIHBhcmVudElkOiBzdHJpbmcsIHN1bW1hcnk6IHN0cmluZywgdmlzaWJpbGl0eTogc3RyaW5nLCBjb25maWdJZDogc3RyaW5nKSB7XHJcbiAgICBpZiAodHlwZW9mIHRleHQgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIHRleHQgPSB0aGlzLnBhcmFtcy50ZXh0O1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiBwYXJlbnRJZCA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgcGFyZW50SWQgPSB0aGlzLnBhcmFtcy5wYXJlbnRJZDtcclxuICAgIH1cclxuICAgIGlmICh0eXBlb2YgdmlzaWJpbGl0eSA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgdmlzaWJpbGl0eSA9IHRoaXMucGFyYW1zLnZpc2liaWxpdHk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAnYmlsbCc6IHtcclxuICAgICAgICAnYmlsbElkJzogaWQsXHJcbiAgICAgICAgJ2NvbmZpZ0lkJzogY29uZmlnSWQsXHJcbiAgICAgICAgJ3N1bW1hcnknOiBzdW1tYXJ5XHJcbiAgICAgIH0sXHJcbiAgICAgICdjb21tZW50Jzoge1xyXG4gICAgICAgICdiaWxsSWQnOiBpZCxcclxuICAgICAgICAnY29uZmlnSWQnOiBjb25maWdJZCxcclxuICAgICAgICAncGFyZW50SWQnOiBwYXJlbnRJZCB8fCBudWxsLFxyXG4gICAgICAgICd0ZXh0JzogdGV4dCxcclxuICAgICAgICAndmlzaWJpbGl0eSc6IHZpc2liaWxpdHlcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=