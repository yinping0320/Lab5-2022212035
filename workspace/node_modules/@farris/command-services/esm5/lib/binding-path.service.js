import { Injectable, Injector } from "@angular/core";
import { AppContext, Repository } from "@farris/devkit";
var BindingPathService = /** @class */ (function () {
    function BindingPathService(injector, appContext, repository) {
        this.injector = injector;
        this.appContext = appContext;
        this.repository = repository;
    }
    /**
     * 获取组件上下文的绑定路径
     * @param frameContext 组件上下文
     * @returns
     */
    BindingPathService.prototype.getBindingPathsByFrameContext = function (frameContext) {
        return frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath && frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; }) || null;
    };
    /**
     * 通过BE表名获取bindingPath
     * @param dataTypeInfo
     * @param tableName
     * @param paths
     * @param level
     * @returns
     */
    BindingPathService.prototype.getBindingPathsByTableName = function (dataTypeInfo, tableName, paths, level) {
        if (paths === void 0) { paths = []; }
        if (level === void 0) { level = 0; }
        level++;
        if (dataTypeInfo.entityInfo && (dataTypeInfo.entityInfo.nodeCode === tableName || dataTypeInfo.entityInfo.originalCode === tableName)) {
            if (level !== 1) {
                paths.push(dataTypeInfo.entityInfo.nodeCode);
            }
            return paths;
        }
        var props = Array.from(dataTypeInfo.propInfoMap.values()).filter(function (p) { return p.typeInfo; });
        if (props.length < 1) {
            paths = [];
            return paths;
        }
        if (dataTypeInfo.entityInfo) {
            if (level !== 1) {
                paths.push(dataTypeInfo.entityInfo.nodeCode);
            }
        }
        for (var idx = 0; idx < props.length; idx++) {
            var dataTypeInfo_1 = props[idx].typeInfo;
            var path = this.getBindingPathsByTableName(dataTypeInfo_1, tableName, paths, level);
            if (!path || path.length < 1) {
                continue;
            }
            else {
                paths = paths.concat(path);
                return paths;
            }
        }
        return null;
    };
    /**
     * 获取属性路径中的绑定路径
     * @param paths paths
     * @param entityTypeInfo
     * @returns
     */
    BindingPathService.prototype.getBindingPathsByPath = function (paths, entityTypeInfo) {
        var nodeCodes = [];
        if (typeof paths === 'string') {
            paths = paths.split('/').filter(function (p) { return p; });
        }
        paths = paths.concat([]);
        while (paths.length > 0) {
            var dataPropInfo = entityTypeInfo.getPropInfoByPath(paths);
            if (dataPropInfo.group === 'List') {
                nodeCodes = paths;
                break;
            }
            paths.pop();
        }
        return nodeCodes;
    };
    /**
     * 获取属性路径信息
     * @param path 属性路径
     * @returns
     */
    BindingPathService.prototype.getPathInfo = function (path) {
        var paths = path.split('/').filter(function (p) { return p; });
        // 获取最大实体层级，其余为属性（简单属性、udt、关联、关联嵌套关联）
        var entityPath = this.getBindingPathsByPath(paths, this.repository.entityTypeInfo);
        var propertyName = paths.slice(entityPath.length).join('/');
        return { bindingPath: entityPath.join('/'), propertyName: propertyName, bindingPaths: entityPath, propertyNames: propertyName.split('/').filter(function (p) { return p; }) };
    };
    BindingPathService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    BindingPathService.ctorParameters = function () { return [
        { type: Injector },
        { type: AppContext },
        { type: Repository }
    ]; };
    return BindingPathService;
}());
export { BindingPathService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZy1wYXRoLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvYmluZGluZy1wYXRoLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLFVBQVUsRUFBc0MsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFNUY7SUFFRSw0QkFBb0IsUUFBa0IsRUFBVSxVQUFzQixFQUFVLFVBQThCO1FBQTFGLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQVUsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7SUFBSSxDQUFDO0lBQ25IOzs7O09BSUc7SUFDSSwwREFBNkIsR0FBcEMsVUFBcUMsWUFBMEI7UUFDN0QsT0FBTyxZQUFZLElBQUksWUFBWSxDQUFDLFNBQVMsSUFBSSxZQUFZLENBQUMsU0FBUyxDQUFDLFdBQVcsSUFBSSxZQUFZLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFELENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQztJQUM5SixDQUFDO0lBQ0Q7Ozs7Ozs7T0FPRztJQUNJLHVEQUEwQixHQUFqQyxVQUFrQyxZQUEwQixFQUFFLFNBQWlCLEVBQUUsS0FBb0IsRUFBRSxLQUFpQjtRQUF2QyxzQkFBQSxFQUFBLFVBQW9CO1FBQUUsc0JBQUEsRUFBQSxTQUFpQjtRQUN0SCxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksWUFBWSxDQUFDLFVBQVUsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsUUFBUSxLQUFLLFNBQVMsSUFBSSxZQUFZLENBQUMsVUFBVSxDQUFDLFlBQVksS0FBSyxTQUFTLENBQUMs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QU8sRUFBRSxXQUFXLEVBQUUsVUFBVSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxZQUFZLGNBQUEsRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRSxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsRUFBRCxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQzlJLENBQUM7O2dCQW5GRixVQUFVOzs7O2dCQUhVLFFBQVE7Z0JBQ3BCLFVBQVU7Z0JBQXNDLFVBQVU7O0lBc0ZuRSx5QkFBQztDQUFBLEFBcEZELElBb0ZDO1NBbkZZLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgQXBwQ29udGV4dCwgRGF0YVR5cGVJbmZvLCBFbnRpdHksIEZyYW1lQ29udGV4dCwgUmVwb3NpdG9yeSB9IGZyb20gXCJAZmFycmlzL2RldmtpdFwiO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQmluZGluZ1BhdGhTZXJ2aWNlIHtcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSBhcHBDb250ZXh0OiBBcHBDb250ZXh0LCBwcml2YXRlIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8RW50aXR5PikgeyB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W57uE5Lu25LiK5LiL5paH55qE57uR5a6a6Lev5b6EXHJcbiAgICogQHBhcmFtIGZyYW1lQ29udGV4dCDnu4Tku7bkuIrkuIvmlodcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0QmluZGluZ1BhdGhzQnlGcmFtZUNvbnRleHQoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpOiBzdHJpbmdbXSB7XHJcbiAgICByZXR1cm4gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkgfHwgbnVsbDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6YCa6L+HQkXooajlkI3ojrflj5ZiaW5kaW5nUGF0aFxyXG4gICAqIEBwYXJhbSBkYXRhVHlwZUluZm8gXHJcbiAgICogQHBhcmFtIHRhYmxlTmFtZSBcclxuICAgKiBAcGFyYW0gcGF0aHMgXHJcbiAgICogQHBhcmFtIGxldmVsXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIGdldEJpbmRpbmdQYXRoc0J5VGFibGVOYW1lKGRhdGFUeXBlSW5mbzogRGF0YVR5cGVJbmZvLCB0YWJsZU5hbWU6IHN0cmluZywgcGF0aHM6IHN0cmluZ1tdID0gW10sIGxldmVsOiBudW1iZXIgPSAwKTogc3RyaW5nW10ge1xyXG4gICAgbGV2ZWwrKztcclxuICAgIGlmIChkYXRhVHlwZUluZm8uZW50aXR5SW5mbyAmJiAoZGF0YVR5cGVJbmZvLmVudGl0eUluZm8ubm9kZUNvZGUgPT09IHRhYmxlTmFtZSB8fCBkYXRhVHlwZUluZm8uZW50aXR5SW5mby5vcmlnaW5hbENvZGUgPT09IHRhYmxlTmFtZSkpIHtcclxuICAgICAgaWYgKGxldmVsICE9PSAxKSB7XHJcbiAgICAgICAgcGF0aHMucHVzaChkYXRhVHlwZUluZm8uZW50aXR5SW5mby5ub2RlQ29kZSk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHBhdGhzO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcHJvcHMgPSBBcnJheS5mcm9tKGRhdGFUeXBlSW5mby5wcm9wSW5mb01hcC52YWx1ZXMoKSkuZmlsdGVyKHAgPT4gcC50eXBlSW5mbyk7XHJcbiAgICBpZiAocHJvcHMubGVuZ3RoIDwgMSkge1xyXG4gICAgICBwYXRocyA9IFtdO1xyXG4gICAgICByZXR1cm4gcGF0aHM7XHJcbiAgICB9XHJcbiAgICBpZiAoZGF0YVR5cGVJbmZvLmVudGl0eUluZm8pIHtcclxuICAgICAgaWYgKGxldmVsICE9PSAxKSB7XHJcbiAgICAgICAgcGF0aHMucHVzaChkYXRhVHlwZUluZm8uZW50aXR5SW5mby5ub2RlQ29kZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmb3IgKGxldCBpZHggPSAwOyBpZHggPCBwcm9wcy5sZW5ndGg7IGlkeCsrKSB7XHJcbiAgICAgIGNvbnN0IGRhdGFUeXBlSW5mbyA9IHByb3BzW2lkeF0udHlwZUluZm87XHJcbiAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmdldEJpbmRpbmdQYXRoc0J5VGFibGVOYW1lKGRhdGFUeXBlSW5mbywgdGFibGVOYW1lLCBwYXRocywgbGV2ZWwpO1xyXG4gICAgICBpZiAoIXBhdGggfHwgcGF0aC5sZW5ndGggPCAxKSB7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcGF0aHMgPSBwYXRocy5jb25jYXQocGF0aCk7XHJcbiAgICAgICAgcmV0dXJuIHBhdGhzO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5bGe5oCn6Lev5b6E5Lit55qE57uR5a6a6Lev5b6EXHJcbiAgICogQHBhcmFtIHBhdGhzIHBhdGhzXHJcbiAgICogQHBhcmFtIGVudGl0eVR5cGVJbmZvIFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRCaW5kaW5nUGF0aHNCeVBhdGgocGF0aHM6IHN0cmluZ1tdIHwgc3RyaW5nLCBlbnRpdHlUeXBlSW5mbzogRGF0YVR5cGVJbmZvKTogc3RyaW5nW10ge1xyXG4gICAgbGV0IG5vZGVDb2RlcyA9IFtdO1xyXG4gICAgaWYgKHR5cGVvZiBwYXRocyA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgcGF0aHMgPSBwYXRocy5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgfVxyXG4gICAgcGF0aHMgPSBwYXRocy5jb25jYXQoW10pO1xyXG4gICAgd2hpbGUgKHBhdGhzLmxlbmd0aCA+IDApIHtcclxuICAgICAgY29uc3QgZGF0YVByb3BJbmZvID0gZW50aXR5VHlwZUluZm8uZ2V0UHJvcEluZm9CeVBhdGgocGF0aHMpO1xyXG4gICAgICBpZiAoZGF0YVByb3BJbmZvLmdyb3VwID09PSAnTGlzdCcpIHtcclxuICAgICAgICBub2RlQ29kZXMgPSBwYXRocztcclxuICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG4gICAgICBwYXRocy5wb3AoKTtcclxuICAgIH1cclxuICAgIHJldHVybiBub2RlQ29kZXM7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWxnuaAp+i3r+W+hOS/oeaBr1xyXG4gICAqIEBwYXJhbSBwYXRoIOWxnuaAp+i3r+W+hFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRQYXRoSW5mbyhwYXRoOiBzdHJpbmcpOiB7IGJpbmRpbmdQYXRoOiBzdHJpbmcsIHByb3BlcnR5TmFtZTogc3RyaW5nLCBiaW5kaW5nUGF0aHM6IHN0cmluZ1tdLCBwcm9wZXJ0eU5hbWVzOiBzdHJpbmdbXSB9IHtcclxuICAgIGNvbnN0IHBhdGhzID0gcGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgLy8g6I635Y+W5pyA5aSn5a6e5L2T5bGC57qn77yM5YW25L2Z5Li65bGe5oCn77yI566A5Y2V5bGe5oCn44CBdWR044CB5YWz6IGU44CB5YWz6IGU5bWM5aWX5YWz6IGU77yJXHJcbiAgICBjb25zdCBlbnRpdHlQYXRoID0gdGhpcy5nZXRCaW5kaW5nUGF0aHNCeVBhdGgocGF0aHMsIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbyk7XHJcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwYXRocy5zbGljZShlbnRpdHlQYXRoLmxlbmd0aCkuam9pbignLycpO1xyXG4gICAgcmV0dXJuIHsgYmluZGluZ1BhdGg6IGVudGl0eVBhdGguam9pbignLycpLCBwcm9wZXJ0eU5hbWUsIGJpbmRpbmdQYXRoczogZW50aXR5UGF0aCwgcHJvcGVydHlOYW1lczogcHJvcGVydHlOYW1lLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkgfTtcclxuICB9XHJcbn0iXX0=