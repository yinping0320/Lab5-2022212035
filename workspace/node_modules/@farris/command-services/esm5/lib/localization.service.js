import { Inject, Injectable, Injector } from "@angular/core";
import { BigNumber } from 'bignumber.js';
import moment from 'moment';
import { UserSettingsToken } from "@farris/devkit";
var LocalizationService = /** @class */ (function () {
    function LocalizationService(injector, userSettings) {
        this.injector = injector;
        this.userSettings = userSettings;
    }
    Object.defineProperty(LocalizationService.prototype, "formats", {
        /**
         * 用户配置格式
         */
        get: function () {
            var _a = this.userSettings || {}, _b = _a.dateFormat, dateFormat = _b === void 0 ? null : _b, _c = _a.timeFormat, timeFormat = _c === void 0 ? null : _c;
            var dateTimeFormat = null;
            if (dateFormat && timeFormat) {
                dateTimeFormat = dateFormat + " " + timeFormat;
            }
            var date = {
                dateFormat: dateFormat,
                timeFormat: timeFormat,
                dateTimeFormat: dateTimeFormat
            };
            var _d = this.numberFormat || {}, _e = _d.negativeSign, negativeSign = _e === void 0 ? null : _e, _f = _d.numberDecimalDigits, numberDecimalDigits = _f === void 0 ? null : _f, _g = _d.numberDecimalSeparator, numberDecimalSeparator = _g === void 0 ? null : _g, _h = _d.numberGroupSeparator, numberGroupSeparator = _h === void 0 ? null : _h;
            var number = {
                negativeSign: negativeSign,
                numberDecimalDigits: numberDecimalDigits,
                numberDecimalSeparator: numberDecimalSeparator,
                numberGroupSeparator: numberGroupSeparator
            };
            return { date: date, number: number };
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 根据数据类型本地化数据
     * @param value value
     * @param dataType 数据类型
     * @returns string
     */
    LocalizationService.prototype.localize = function (value, dataType) {
        if (dataType && value) {
            dataType = dataType.toLowerCase();
            if (dataType === 'date') {
                return this.transformDate(value);
            }
            else if (dataType === 'datetime') {
                return this.transformDateTime(value);
            }
            else if (dataType === 'number') {
                return this.transformNumber(value);
            }
            else {
                return value;
            }
        }
        else {
            return value;
        }
    };
    /**
     * 根据国际化类型获取格式化字符串
     * @param localizationType 国际化类型
     * @returns
     */
    LocalizationService.prototype.getFormat = function (localizationType) {
        if (localizationType) {
            localizationType = localizationType.toLowerCase();
        }
        if (localizationType === 'date') {
            return this.formats.date.dateFormat;
        }
        else if (localizationType === 'datetime') {
            return this.formats.date.dateTimeFormat;
        }
        else {
            return '';
        }
    };
    /**
     * 转换日期
     * @param value value
     */
    LocalizationService.prototype.transformDate = function (value) {
        var dateFormat = this.userSettings && this.userSettings.dateFormat || 'YYYY-MM-DD';
        if (!dateFormat || !value) {
            return value;
        }
        var date = moment(value);
        var isValid = date.isValid();
        if (!isValid) {
            return value;
        }
        dateFormat = this.parseDateFormat(dateFormat);
        return date.format(dateFormat);
    };
    /**
     * 转换日期时间
     * @param value value
     * todo: 目前无法定义日期时间格式
     */
    LocalizationService.prototype.transformDateTime = function (value) {
        var dateFormat = this.userSettings && this.userSettings.dateFormat || 'YYYY-MM-DD';
        var timeFormat = this.userSettings && this.userSettings.timeFormat || 'HH:mm:ss';
        if (!dateFormat || !timeFormat) {
            return value;
        }
        var dateTime = moment(value);
        var isValid = dateTime.isValid();
        if (!isValid) {
            return value;
        }
        if (dateFormat) {
            dateFormat = this.parseDateFormat(dateFormat);
        }
        if (timeFormat) {
            timeFormat = this.parseTimeFormat(timeFormat);
        }
        var dateTimeFormat = dateFormat + ' ' + timeFormat;
        return dateTime.format(dateTimeFormat);
    };
    /**
     * 转换数字
     * @param value value
     */
    LocalizationService.prototype.transformNumber = function (value) {
        if (value === null || value === undefined || value === '') {
            return '';
        }
        var bigNumber = new BigNumber(value);
        // 如果不是数字，不做任何处理
        if (!BigNumber.isBigNumber(bigNumber)) {
            return value;
        }
        var isNegative = bigNumber.isNegative();
        var format = this.buildNumberFormat();
        var _a = this.numberFormat || {}, _b = _a.negativeSign, negativeSign = _b === void 0 ? null : _b, _c = _a.numberDecimalDigits, numberDecimalDigits = _c === void 0 ? null : _c;
        if (isNegative) {
            if (negativeSign !== null) {
                format.prefix = negativeSign;
                return bigNumber.absoluteValue().toFormat(numberDecimalDigits, null, format);
            }
        }
        return bigNumber.toFormat(numberDecimalDigits, null, format);
    };
    /**
     * 转换日期格式规则为moment的format规则
     * @param format format
     */
    LocalizationService.prototype.parseDateFormat = function (format) {
        return format.replace(/y/g, 'Y').replace(/d/g, 'D');
    };
    /**
     * 转换时间格式规则为moment的format规则
     * @param format format
     */
    LocalizationService.prototype.parseTimeFormat = function (format) {
        return format.replace(/M/g, 'm');
    };
    /**
     * 构造bignumber数字格式化选项
     */
    LocalizationService.prototype.buildNumberFormat = function () {
        if (this.numberFormat) {
            var _a = this.numberFormat, _b = _a.numberDecimalSeparator, numberDecimalSeparator = _b === void 0 ? null : _b, _c = _a.numberGroupSeparator, numberGroupSeparator = _c === void 0 ? null : _c;
            var format = {
                groupSize: 3,
            };
            if (numberDecimalSeparator !== null) {
                format.decimalSeparator = numberDecimalSeparator;
            }
            if (numberGroupSeparator !== null) {
                format.groupSeparator = numberGroupSeparator;
            }
            return format;
        }
    };
    Object.defineProperty(LocalizationService.prototype, "numberFormat", {
        get: function () {
            return this.userSettings && this.userSettings.numberFormat || null;
        },
        enumerable: true,
        configurable: true
    });
    LocalizationService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    LocalizationService.ctorParameters = function () { return [
        { type: Injector },
        { type: undefined, decorators: [{ type: Inject, args: [UserSettingsToken,] }] }
    ]; };
    return LocalizationService;
}());
export { LocalizationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWxpemF0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvbG9jYWxpemF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDekMsT0FBTyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBQzVCLE9BQU8sRUFBOEIsaUJBQWlCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUUvRTtJQUVFLDZCQUFvQixRQUFrQixFQUFxQyxZQUEwQjtRQUFqRixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQXFDLGlCQUFZLEdBQVosWUFBWSxDQUFjO0lBQUksQ0FBQztJQUsxRyxzQkFBVyx3Q0FBTztRQUhsQjs7V0FFRzthQUNIO1lBQ1EsSUFBQSw0QkFBa0UsRUFBaEUsa0JBQWlCLEVBQWpCLHNDQUFpQixFQUFFLGtCQUFpQixFQUFqQixzQ0FBNkMsQ0FBQztZQUN6RSxJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUM7WUFDMUIsSUFBSSxVQUFVLElBQUksVUFBVSxFQUFFO2dCQUM1QixjQUFjLEdBQU0sVUFBVSxTQUFJLFVBQVksQ0FBQzthQUNoRDtZQUNELElBQU0sSUFBSSxHQUFHO2dCQUNYLFVBQVUsWUFBQTtnQkFDVixVQUFVLFlBQUE7Z0JBQ1YsY0FBYyxnQkFBQTthQUNmLENBQUM7WUFDSSxJQUFBLDRCQUF5SSxFQUF2SSxvQkFBbUIsRUFBbkIsd0NBQW1CLEVBQUUsMkJBQTBCLEVBQTFCLCtDQUEwQixFQUFFLDhCQUE2QixFQUE3QixrREFBNkIsRUFBRSw0QkFBMkIsRUFBM0IsZ0RBQXVELENBQUM7WUFDaEosSUFBTSxNQUFNLEdBQUc7Z0JBQ2IsWUFBWSxjQUFBO2dCQUNaLG1CQUFtQixx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Y3RhYmxlLCBJbmplY3RvciB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IEJpZ051bWJlciB9IGZyb20gJ2JpZ251bWJlci5qcyc7XHJcbmltcG9ydCBtb21lbnQgZnJvbSAnbW9tZW50JztcclxuaW1wb3J0IHsgTnVtYmVyRm9ybWF0LCBVc2VyU2V0dGluZ3MsIFVzZXJTZXR0aW5nc1Rva2VuIH0gZnJvbSBcIkBmYXJyaXMvZGV2a2l0XCI7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBMb2NhbGl6YXRpb25TZXJ2aWNlIHtcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgQEluamVjdChVc2VyU2V0dGluZ3NUb2tlbikgcHJpdmF0ZSB1c2VyU2V0dGluZ3M6IFVzZXJTZXR0aW5ncykgeyB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOeUqOaIt+mFjee9ruagvOW8j1xyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQgZm9ybWF0cygpOiB7IGRhdGU6IHsgZGF0ZUZvcm1hdDogc3RyaW5nLCB0aW1lRm9ybWF0OiBzdHJpbmcsIGRhdGVUaW1lRm9ybWF0OiBzdHJpbmcgfSwgbnVtYmVyOiB7IG5lZ2F0aXZlU2lnbjogc3RyaW5nLCBudW1iZXJEZWNpbWFsRGlnaXRzOiBudW1iZXIsIG51bWJlckRlY2ltYWxTZXBhcmF0b3I6IHN0cmluZywgbnVtYmVyR3JvdXBTZXBhcmF0b3I6IHN0cmluZyB9LCBbcHJvcDogc3RyaW5nXTogYW55IH0ge1xyXG4gICAgY29uc3QgeyBkYXRlRm9ybWF0ID0gbnVsbCwgdGltZUZvcm1hdCA9IG51bGwgfSA9IHRoaXMudXNlclNldHRpbmdzIHx8IHt9O1xyXG4gICAgbGV0IGRhdGVUaW1lRm9ybWF0ID0gbnVsbDtcclxuICAgIGlmIChkYXRlRm9ybWF0ICYmIHRpbWVGb3JtYXQpIHtcclxuICAgICAgZGF0ZVRpbWVGb3JtYXQgPSBgJHtkYXRlRm9ybWF0fSAke3RpbWVGb3JtYXR9YDtcclxuICAgIH1cclxuICAgIGNvbnN0IGRhdGUgPSB7XHJcbiAgICAgIGRhdGVGb3JtYXQsXHJcbiAgICAgIHRpbWVGb3JtYXQsXHJcbiAgICAgIGRhdGVUaW1lRm9ybWF0XHJcbiAgICB9O1xyXG4gICAgY29uc3QgeyBuZWdhdGl2ZVNpZ24gPSBudWxsLCBudW1iZXJEZWNpbWFsRGlnaXRzID0gbnVsbCwgbnVtYmVyRGVjaW1hbFNlcGFyYXRvciA9IG51bGwsIG51bWJlckdyb3VwU2VwYXJhdG9yID0gbnVsbCB9ID0gdGhpcy5udW1iZXJGb3JtYXQgfHwge307XHJcbiAgICBjb25zdCBudW1iZXIgPSB7XHJcbiAgICAgIG5lZ2F0aXZlU2lnbixcclxuICAgICAgbnVtYmVyRGVjaW1hbERpZ2l0cyxcclxuICAgICAgbnVtYmVyRGVjaW1hbFNlcGFyYXRvcixcclxuICAgICAgbnVtYmVyR3JvdXBTZXBhcmF0b3JcclxuICAgIH07XHJcbiAgICByZXR1cm4geyBkYXRlLCBudW1iZXIgfTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5qC55o2u5pWw5o2u57G75Z6L5pys5Zyw5YyW5pWw5o2uXHJcbiAgICogQHBhcmFtIHZhbHVlIHZhbHVlXHJcbiAgICogQHBhcmFtIGRhdGFUeXBlIOaVsOaNruexu+Wei1xyXG4gICAqIEByZXR1cm5zIHN0cmluZ1xyXG4gICAqL1xyXG4gIHB1YmxpYyBsb2NhbGl6ZSh2YWx1ZTogYW55LCBkYXRhVHlwZTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGlmIChkYXRhVHlwZSAmJiB2YWx1ZSkge1xyXG4gICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgIGlmIChkYXRhVHlwZSA9PT0gJ2RhdGUnKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtRGF0ZSh2YWx1ZSk7XHJcbiAgICAgIH0gZWxzZSBpZiAoZGF0YVR5cGUgPT09ICdkYXRldGltZScpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy50cmFuc2Zvcm1EYXRlVGltZSh2YWx1ZSk7XHJcbiAgICAgIH0gZWxzZSBpZiAoZGF0YVR5cGUgPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtTnVtYmVyKHZhbHVlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5qC55o2u5Zu96ZmF5YyW57G75Z6L6I635Y+W5qC85byP5YyW5a2X56ym5LiyXHJcbiAgICogQHBhcmFtIGxvY2FsaXphdGlvblR5cGUg5Zu96ZmF5YyW57G75Z6LXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIGdldEZvcm1hdChsb2NhbGl6YXRpb25UeXBlOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgaWYgKGxvY2FsaXphdGlvblR5cGUpIHtcclxuICAgICAgbG9jYWxpemF0aW9uVHlwZSA9IGxvY2FsaXphdGlvblR5cGUudG9Mb3dlckNhc2UoKTtcclxuICAgIH1cclxuICAgIGlmIChsb2NhbGl6YXRpb25UeXBlID09PSAnZGF0ZScpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0cy5kYXRlLmRhdGVGb3JtYXQ7XHJcbiAgICB9IGVsc2UgaWYgKGxvY2FsaXphdGlvblR5cGUgPT09ICdkYXRldGltZScpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0cy5kYXRlLmRhdGVUaW1lRm9ybWF0O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDovazmjaLml6XmnJ9cclxuICAgKiBAcGFyYW0gdmFsdWUgdmFsdWVcclxuICAgKi9cclxuICBwcml2YXRlIHRyYW5zZm9ybURhdGUodmFsdWU6IGFueSkge1xyXG4gICAgbGV0IGRhdGVGb3JtYXQgPSB0aGlzLnVzZXJTZXR0aW5ncyAmJiB0aGlzLnVzZXJTZXR0aW5ncy5kYXRlRm9ybWF0IHx8ICdZWVlZLU1NLUREJztcclxuICAgIGlmICghZGF0ZUZvcm1hdCB8fCAhdmFsdWUpIHtcclxuICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZGF0ZSA9IG1vbWVudCh2YWx1ZSk7XHJcbiAgICBjb25zdCBpc1ZhbGlkID0gZGF0ZS5pc1ZhbGlkKCk7XHJcbiAgICBpZiAoIWlzVmFsaWQpIHtcclxuICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG4gICAgZGF0ZUZvcm1hdCA9IHRoaXMucGFyc2VEYXRlRm9ybWF0KGRhdGVGb3JtYXQpO1xyXG4gICAgcmV0dXJuIGRhdGUuZm9ybWF0KGRhdGVGb3JtYXQpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDovazmjaLml6XmnJ/ml7bpl7RcclxuICAgKiBAcGFyYW0gdmFsdWUgdmFsdWVcclxuICAgKiB0b2RvOiDnm67liY3ml6Dms5XlrprkuYnml6XmnJ/ml7bpl7TmoLzlvI9cclxuICAgKi9cclxuICBwcml2YXRlIHRyYW5zZm9ybURhdGVUaW1lKHZhbHVlOiBhbnkpIHtcclxuICAgIGxldCBkYXRlRm9ybWF0ID0gdGhpcy51c2VyU2V0dGluZ3MgJiYgdGhpcy51c2VyU2V0dGluZ3MuZGF0ZUZvcm1hdCB8fCAnWVlZWS1NTS1ERCc7XHJcbiAgICBsZXQgdGltZUZvcm1hdCA9IHRoaXMudXNlclNldHRpbmdzICYmIHRoaXMudXNlclNldHRpbmdzLnRpbWVGb3JtYXQgfHwgJ0hIOm1tOnNzJztcclxuICAgIGlmICghZGF0ZUZvcm1hdCB8fCAhdGltZUZvcm1hdCkge1xyXG4gICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcbiAgICBjb25zdCBkYXRlVGltZSA9IG1vbWVudCh2YWx1ZSk7XHJcbiAgICBjb25zdCBpc1ZhbGlkID0gZGF0ZVRpbWUuaXNWYWxpZCgpO1xyXG4gICAgaWYgKCFpc1ZhbGlkKSB7XHJcbiAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuICAgIGlmIChkYXRlRm9ybWF0KSB7XHJcbiAgICAgIGRhdGVGb3JtYXQgPSB0aGlzLnBhcnNlRGF0ZUZvcm1hdChkYXRlRm9ybWF0KTtcclxuICAgIH1cclxuICAgIGlmICh0aW1lRm9ybWF0KSB7XHJcbiAgICAgIHRpbWVGb3JtYXQgPSB0aGlzLnBhcnNlVGltZUZvcm1hdCh0aW1lRm9ybWF0KTtcclxuICAgIH1cclxuICAgIGNvbnN0IGRhdGVUaW1lRm9ybWF0ID0gZGF0ZUZvcm1hdCArICcgJyArIHRpbWVGb3JtYXQ7XHJcbiAgICByZXR1cm4gZGF0ZVRpbWUuZm9ybWF0KGRhdGVUaW1lRm9ybWF0KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6L2s5o2i5pWw5a2XXHJcbiAgICogQHBhcmFtIHZhbHVlIHZhbHVlXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB0cmFuc2Zvcm1OdW1iZXIodmFsdWUpOiBzdHJpbmcge1xyXG4gICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09ICcnKSB7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIGNvbnN0IGJpZ051bWJlciA9IG5ldyBCaWdOdW1iZXIodmFsdWUpO1xyXG4gICAgLy8g5aaC5p6c5LiN5piv5pWw5a2X77yM5LiN5YGa5Lu75L2V5aSE55CGXHJcbiAgICBpZiAoIUJpZ051bWJlci5pc0JpZ051bWJlcihiaWdOdW1iZXIpKSB7XHJcbiAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuICAgIGNvbnN0IGlzTmVnYXRpdmUgPSBiaWdOdW1iZXIuaXNOZWdhdGl2ZSgpO1xyXG4gICAgY29uc3QgZm9ybWF0ID0gdGhpcy5idWlsZE51bWJlckZvcm1hdCgpO1xyXG4gICAgY29uc3QgeyBuZWdhdGl2ZVNpZ24gPSBudWxsLCBudW1iZXJEZWNpbWFsRGlnaXRzID0gbnVsbCB9ID0gdGhpcy5udW1iZXJGb3JtYXQgfHwge307XHJcbiAgICBpZiAoaXNOZWdhdGl2ZSkge1xyXG4gICAgICBpZiAobmVnYXRpdmVTaWduICE9PSBudWxsKSB7XHJcbiAgICAgICAgZm9ybWF0LnByZWZpeCA9IG5lZ2F0aXZlU2lnbjtcclxuICAgICAgICByZXR1cm4gYmlnTnVtYmVyLmFic29sdXRlVmFsdWUoKS50b0Zvcm1hdChudW1iZXJEZWNpbWFsRGlnaXRzLCBudWxsLCBmb3JtYXQpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYmlnTnVtYmVyLnRvRm9ybWF0KG51bWJlckRlY2ltYWxEaWdpdHMsIG51bGwsIGZvcm1hdCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOi9rOaNouaXpeacn+agvOW8j+inhOWImeS4um1vbWVudOeahGZvcm1hdOinhOWImVxyXG4gICAqIEBwYXJhbSBmb3JtYXQgZm9ybWF0XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBwYXJzZURhdGVGb3JtYXQoZm9ybWF0OiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBmb3JtYXQucmVwbGFjZSgveS9nLCAnWScpLnJlcGxhY2UoL2QvZywgJ0QnKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6L2s5o2i5pe26Ze05qC85byP6KeE5YiZ5Li6bW9tZW5055qEZm9ybWF06KeE5YiZXHJcbiAgICogQHBhcmFtIGZvcm1hdCBmb3JtYXRcclxuICAgKi9cclxuICBwcml2YXRlIHBhcnNlVGltZUZvcm1hdChmb3JtYXQ6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIGZvcm1hdC5yZXBsYWNlKC9NL2csICdtJyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaehOmAoGJpZ251bWJlcuaVsOWtl+agvOW8j+WMlumAiemhuVxyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGROdW1iZXJGb3JtYXQoKSB7XHJcbiAgICBpZiAodGhpcy5udW1iZXJGb3JtYXQpIHtcclxuICAgICAgY29uc3QgeyBudW1iZXJEZWNpbWFsU2VwYXJhdG9yID0gbnVsbCwgbnVtYmVyR3JvdXBTZXBhcmF0b3IgPSBudWxsIH0gPSB0aGlzLm51bWJlckZvcm1hdDtcclxuICAgICAgY29uc3QgZm9ybWF0OiBhbnkgPSB7XHJcbiAgICAgICAgZ3JvdXBTaXplOiAzLFxyXG4gICAgICB9O1xyXG4gICAgICBpZiAobnVtYmVyRGVjaW1hbFNlcGFyYXRvciAhPT0gbnVsbCkge1xyXG4gICAgICAgIGZvcm1hdC5kZWNpbWFsU2VwYXJhdG9yID0gbnVtYmVyRGVjaW1hbFNlcGFyYXRvcjtcclxuICAgICAgfVxyXG4gICAgICBpZiAobnVtYmVyR3JvdXBTZXBhcmF0b3IgIT09IG51bGwpIHtcclxuICAgICAgICBmb3JtYXQuZ3JvdXBTZXBhcmF0b3IgPSBudW1iZXJHcm91cFNlcGFyYXRvcjtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gZm9ybWF0O1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIGdldCBudW1iZXJGb3JtYXQoKTogTnVtYmVyRm9ybWF0IHtcclxuICAgIHJldHVybiB0aGlzLnVzZXJTZXR0aW5ncyAmJiB0aGlzLnVzZXJTZXR0aW5ncy5udW1iZXJGb3JtYXQgfHwgbnVsbDtcclxuICB9XHJcbn0iXX0=