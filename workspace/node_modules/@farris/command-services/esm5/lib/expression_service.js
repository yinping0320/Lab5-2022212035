import * as tslib_1 from "tslib";
import { Injectable, Injector } from "@angular/core";
import { BigNumber } from 'bignumber.js';
import { AppContext, FrameContext, Repository, ENTITY_TEMPLATE, ResolveService, ExpressionUtil, ExpressionExecutor } from "@farris/devkit";
import { of } from "rxjs";
var ExpressionService = /** @class */ (function () {
    function ExpressionService(injector, resolveService, frameContext, expressionExecutor) {
        this.injector = injector;
        this.resolveService = resolveService;
        this.frameContext = frameContext;
        this.expressionExecutor = expressionExecutor;
    }
    /**
     * 执行表达式计算
     * @param expression 表达式
     * @param customContext 自定义上下文
     * @returns
     */
    ExpressionService.prototype.execute = function (expression, customContext) {
        var _a;
        var deps = this.resolveService.resolve(expression);
        var groupDependencies = ExpressionUtil.getGroupFunctionDependency(expression, this.frameContext.repository.entityTypeInfo);
        var entityContext = this.buildEntityContext(deps, groupDependencies);
        var stateContext = this.buildStateContext();
        var context = tslib_1.__assign((_a = {}, _a[this.entityOriginalNodeCode] = entityContext, _a), stateContext, { BigNumber: BigNumber, frameContext: this.frameContext, bindingData: this.frameContext.bindingData, repository: this.frameContext.repository }, customContext);
        return this.expressionExecutor.eval(expression, context);
    };
    /**
     * 执行表达式（返回可观察对象）
     * @param expression 表达式
     * @param customContext 自定义上下文
     * @returns
     */
    ExpressionService.prototype.executeAsync = function (expression, customContext) {
        var result = this.execute(expression, customContext);
        return of(result);
    };
    /**
     * 构造实体上下文
     * @param deps
     * @param groupDependencies
     * @param context
     * @returns
     */
    ExpressionService.prototype.buildEntityContext = function (deps, groupDependencies, context) {
        var _this = this;
        var isGroupdMainEntity = false;
        deps.forEach(function (dep) {
            var isEntityDependency = _this.isEntityDependency(dep);
            var isGroupDependency = groupDependencies.findIndex(function (item) { return item === dep; }) !== -1;
            // 如果依赖的是state，无需处理，现在需要确定的是返回多少实体的问题，和state没有关系
            // 表达式依赖了实体
            if (isEntityDependency) {
                // 是聚合依赖
                if (isGroupDependency) {
                    var dependencyLength = dep.split('/').filter(function (p) { return p; }).length - 1;
                    if (dependencyLength === 1) {
                        // 聚合了主表字段，所有主表数据都需要参与运算，此时已经确定计算的实体上下文了。
                        isGroupdMainEntity = true;
                    }
                    else {
                        // 聚合了子表字段，只需要传递当前实体
                    }
                }
                else {
                    // 当前依赖不是聚合，只需要传递当前实体
                }
            }
        });
        var data = this.getEntity();
        if (isGroupdMainEntity) {
            var collection = this.frameContext.repository.entityCollection.toJSON();
            data['__type__'] = 'List';
            data['__items__'] = collection;
        }
        return data;
    };
    /**
     * 是否为实体依赖
     * @param dep
     * @returns
     */
    ExpressionService.prototype.isEntityDependency = function (dep) {
        return dep.startsWith(ENTITY_TEMPLATE);
    };
    /**
     * 获取实体
     * @param event
     * @returns
     */
    ExpressionService.prototype.getEntity = function () {
        var entityTypeInfo = this.frameContext.repository.entityTypeInfo;
        var bindingData = this.frameContext.bindingData;
        var childrenEntityPaths = [];
        ExpressionUtil.getChildrenEntityPaths(entityTypeInfo, childrenEntityPaths);
        var entity = this.frameContext.bindingData.list.currentItem.toJSON();
        entity['__type__'] = 'Entity';
        if (!childrenEntityPaths || childrenEntityPaths.length < 1) {
            return entity;
        }
        // 找到所有子表
        childrenEntityPaths.forEach(function (paths) {
            var row = ExpressionUtil.getCurrentRowByPaths(paths, bindingData);
            if (row) {
                var propertyName = paths.pop();
                var parent_1 = paths.reduce(function (object, path) {
                    return object && object[path] || null;
                }, entity);
                var node = tslib_1.__assign({ __items__: tslib_1.__spread(parent_1[propertyName]) }, row, { __type__: 'List' });
                parent_1[propertyName] = node;
            }
        });
        return entity;
    };
    Object.defineProperty(ExpressionService.prototype, "entityOriginalNodeCode", {
        /**
         * 获取主实体原始字段名
         */
        get: function () {
            var repository = this.injector.get(Repository);
            return repository && repository.entityTypeInfo && repository.entityTypeInfo.entityInfo && repository.entityTypeInfo.entityInfo.originalCode || null;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 构造变量上下文
     * @param event
     * @returns
     */
    ExpressionService.prototype.buildStateContext = function () {
        var ns = this.frameContext.namespace;
        var appContext = this.injector.get(AppContext, null);
        var frameContexts = appContext.frameContextManager.getFrameContextsByNamespace(ns);
        var result = {};
        if (frameContexts && frameContexts.length > 0) {
            var anonymousFrameContext = frameContexts[0];
            var rootFrameContext = anonymousFrameContext.getVirtualRootFrameContext();
            if (rootFrameContext) {
                var uiState_1 = rootFrameContext.viewModel.uiState;
                var propertyNames = Object.getOwnPropertyNames(uiState_1) || [];
                propertyNames.forEach(function (prop) {
                    if (prop.match(/^[a-zA-Z0-9_\$]+$/g) !== null) {
                        result[prop] = uiState_1[prop];
                    }
                });
            }
        }
        return result;
    };
    ExpressionService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ExpressionService.ctorParameters = function () { return [
        { type: Injector },
        { type: ResolveService },
        { type: FrameContext },
        { type: ExpressionExecutor }
    ]; };
    return ExpressionService;
}());
export { ExpressionService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl9zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2V4cHJlc3Npb25fc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN6QyxPQUFPLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzSSxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRXRDO0lBRUUsMkJBQW9CLFFBQWtCLEVBQVUsY0FBOEIsRUFBVSxZQUEwQixFQUFVLGtCQUFzQztRQUE5SSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQVUsaUJBQVksR0FBWixZQUFZLENBQWM7UUFBVSx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO0lBQUksQ0FBQztJQUN2Szs7Ozs7T0FLRztJQUNJLG1DQUFPLEdBQWQsVUFBZSxVQUFrQixFQUFFLGFBQXVDOztRQUN4RSxJQUFNLElBQUksR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNyRCxJQUFNLGlCQUFpQixHQUFHLGNBQWMsQ0FBQywwQkFBMEIsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDN0gsSUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3ZFLElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsRUFB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SUQsSUE2SUM7U0E1SVksaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdiaWdudW1iZXIuanMnO1xyXG5pbXBvcnQgeyBBcHBDb250ZXh0LCBGcmFtZUNvbnRleHQsIFJlcG9zaXRvcnksIEVOVElUWV9URU1QTEFURSwgUmVzb2x2ZVNlcnZpY2UsIEV4cHJlc3Npb25VdGlsLCBFeHByZXNzaW9uRXhlY3V0b3IgfSBmcm9tIFwiQGZhcnJpcy9kZXZraXRcIjtcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tIFwicnhqc1wiO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRXhwcmVzc2lvblNlcnZpY2Uge1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIHJlc29sdmVTZXJ2aWNlOiBSZXNvbHZlU2VydmljZSwgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgcHJpdmF0ZSBleHByZXNzaW9uRXhlY3V0b3I6IEV4cHJlc3Npb25FeGVjdXRvcikgeyB9XHJcbiAgLyoqXHJcbiAgICog5omn6KGM6KGo6L6+5byP6K6h566XXHJcbiAgICogQHBhcmFtIGV4cHJlc3Npb24g6KGo6L6+5byPXHJcbiAgICogQHBhcmFtIGN1c3RvbUNvbnRleHQg6Ieq5a6a5LmJ5LiK5LiL5paHXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIGV4ZWN1dGUoZXhwcmVzc2lvbjogc3RyaW5nLCBjdXN0b21Db250ZXh0PzogeyBbcHJvcDogc3RyaW5nXTogYW55IH0pOiBhbnkge1xyXG4gICAgY29uc3QgZGVwcyA9IHRoaXMucmVzb2x2ZVNlcnZpY2UucmVzb2x2ZShleHByZXNzaW9uKTtcclxuICAgIGNvbnN0IGdyb3VwRGVwZW5kZW5jaWVzID0gRXhwcmVzc2lvblV0aWwuZ2V0R3JvdXBGdW5jdGlvbkRlcGVuZGVuY3koZXhwcmVzc2lvbiwgdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbyk7XHJcbiAgICBjb25zdCBlbnRpdHlDb250ZXh0ID0gdGhpcy5idWlsZEVudGl0eUNvbnRleHQoZGVwcywgZ3JvdXBEZXBlbmRlbmNpZXMpO1xyXG4gICAgY29uc3Qgc3RhdGVDb250ZXh0ID0gdGhpcy5idWlsZFN0YXRlQ29udGV4dCgpO1xyXG4gICAgY29uc3QgY29udGV4dCA9IHtcclxuICAgICAgW3RoaXMuZW50aXR5T3JpZ2luYWxOb2RlQ29kZV06IGVudGl0eUNvbnRleHQsXHJcbiAgICAgIC4uLnN0YXRlQ29udGV4dCxcclxuICAgICAgQmlnTnVtYmVyLFxyXG4gICAgICBmcmFtZUNvbnRleHQ6IHRoaXMuZnJhbWVDb250ZXh0LFxyXG4gICAgICBiaW5kaW5nRGF0YTogdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEsXHJcbiAgICAgIHJlcG9zaXRvcnk6IHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnksXHJcbiAgICAgIC4uLmN1c3RvbUNvbnRleHRcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLmV4cHJlc3Npb25FeGVjdXRvci5ldmFsKGV4cHJlc3Npb24sIGNvbnRleHQpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmiafooYzooajovr7lvI/vvIjov5Tlm57lj6/op4Llr5/lr7nosaHvvIlcclxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbiDooajovr7lvI9cclxuICAgKiBAcGFyYW0gY3VzdG9tQ29udGV4dCDoh6rlrprkuYnkuIrkuIvmlodcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZXhlY3V0ZUFzeW5jKGV4cHJlc3Npb246IHN0cmluZywgY3VzdG9tQ29udGV4dD86IHsgW3Byb3A6IHN0cmluZ106IGFueSB9KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuZXhlY3V0ZShleHByZXNzaW9uLCBjdXN0b21Db250ZXh0KTtcclxuICAgIHJldHVybiBvZihyZXN1bHQpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmnoTpgKDlrp7kvZPkuIrkuIvmlodcclxuICAgKiBAcGFyYW0gZGVwcyBcclxuICAgKiBAcGFyYW0gZ3JvdXBEZXBlbmRlbmNpZXMgXHJcbiAgICogQHBhcmFtIGNvbnRleHQgXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZEVudGl0eUNvbnRleHQoZGVwczogc3RyaW5nW10sIGdyb3VwRGVwZW5kZW5jaWVzOiBzdHJpbmdbXSwgY29udGV4dD86IHsgW3Byb3A6IHN0cmluZ106IGFueSB9KSB7XHJcbiAgICBsZXQgaXNHcm91cGRNYWluRW50aXR5ID0gZmFsc2U7XHJcbiAgICBkZXBzLmZvckVhY2goKGRlcDogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IGlzRW50aXR5RGVwZW5kZW5jeSA9IHRoaXMuaXNFbnRpdHlEZXBlbmRlbmN5KGRlcCk7XHJcbiAgICAgIGNvbnN0IGlzR3JvdXBEZXBlbmRlbmN5ID0gZ3JvdXBEZXBlbmRlbmNpZXMuZmluZEluZGV4KGl0ZW0gPT4gaXRlbSA9PT0gZGVwKSAhPT0gLTE7XHJcbiAgICAgIC8vIOWmguaenOS+nei1lueahOaYr3N0YXRl77yM5peg6ZyA5aSE55CG77yM546w5Zyo6ZyA6KaB56Gu5a6a55qE5piv6L+U5Zue5aSa5bCR5a6e5L2T55qE6Zeu6aKY77yM5ZKMc3RhdGXmsqHmnInlhbPns7tcclxuICAgICAgLy8g6KGo6L6+5byP5L6d6LWW5LqG5a6e5L2TXHJcbiAgICAgIGlmIChpc0VudGl0eURlcGVuZGVuY3kpIHtcclxuICAgICAgICAvLyDmmK/ogZrlkIjkvp3otZZcclxuICAgICAgICBpZiAoaXNHcm91cERlcGVuZGVuY3kpIHtcclxuICAgICAgICAgIGNvbnN0IGRlcGVuZGVuY3lMZW5ndGggPSBkZXAuc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS5sZW5ndGggLSAxO1xyXG4gICAgICAgICAgaWYgKGRlcGVuZGVuY3lMZW5ndGggPT09IDEpIHtcclxuICAgICAgICAgICAgLy8g6IGa5ZCI5LqG5Li76KGo5a2X5q6177yM5omA5pyJ5Li76KGo5pWw5o2u6YO96ZyA6KaB5Y+C5LiO6L+Q566X77yM5q2k5pe25bey57uP56Gu5a6a6K6h566X55qE5a6e5L2T5LiK5LiL5paH5LqG44CCXHJcbiAgICAgICAgICAgIGlzR3JvdXBkTWFpbkVudGl0eSA9IHRydWU7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyDogZrlkIjkuoblrZDooajlrZfmrrXvvIzlj6rpnIDopoHkvKDpgJLlvZPliY3lrp7kvZNcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8g5b2T5YmN5L6d6LWW5LiN5piv6IGa5ZCI77yM5Y+q6ZyA6KaB5Lyg6YCS5b2T5YmN5a6e5L2TXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIGNvbnN0IGRhdGEgPSB0aGlzLmdldEVudGl0eSgpO1xyXG4gICAgaWYgKGlzR3JvdXBkTWFpbkVudGl0eSkge1xyXG4gICAgICBjb25zdCBjb2xsZWN0aW9uID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLnRvSlNPTigpO1xyXG4gICAgICBkYXRhWydfX3R5cGVfXyddID0gJ0xpc3QnO1xyXG4gICAgICBkYXRhWydfX2l0ZW1zX18nXSA9IGNvbGxlY3Rpb247XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZGF0YTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5piv5ZCm5Li65a6e5L2T5L6d6LWWXHJcbiAgICogQHBhcmFtIGRlcCBcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwcml2YXRlIGlzRW50aXR5RGVwZW5kZW5jeShkZXA6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIGRlcC5zdGFydHNXaXRoKEVOVElUWV9URU1QTEFURSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWunuS9k1xyXG4gICAqIEBwYXJhbSBldmVudCBcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RW50aXR5KCkge1xyXG4gICAgY29uc3QgZW50aXR5VHlwZUluZm8gPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvO1xyXG4gICAgY29uc3QgYmluZGluZ0RhdGEgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YTtcclxuICAgIGNvbnN0IGNoaWxkcmVuRW50aXR5UGF0aHMgPSBbXTtcclxuICAgIEV4cHJlc3Npb25VdGlsLmdldENoaWxkcmVuRW50aXR5UGF0aHMoZW50aXR5VHlwZUluZm8sIGNoaWxkcmVuRW50aXR5UGF0aHMpO1xyXG4gICAgY29uc3QgZW50aXR5ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SXRlbS50b0pTT04oKTtcclxuICAgIGVudGl0eVsnX190eXBlX18nXSA9ICdFbnRpdHknO1xyXG4gICAgaWYgKCFjaGlsZHJlbkVudGl0eVBhdGhzIHx8IGNoaWxkcmVuRW50aXR5UGF0aHMubGVuZ3RoIDwgMSkge1xyXG4gICAgICByZXR1cm4gZW50aXR5O1xyXG4gICAgfVxyXG4gICAgLy8g5om+5Yiw5omA5pyJ5a2Q6KGoXHJcbiAgICBjaGlsZHJlbkVudGl0eVBhdGhzLmZvckVhY2goKHBhdGhzOiBzdHJpbmdbXSkgPT4ge1xyXG4gICAgICBjb25zdCByb3cgPSBFeHByZXNzaW9uVXRpbC5nZXRDdXJyZW50Um93QnlQYXRocyhwYXRocywgYmluZGluZ0RhdGEpO1xyXG4gICAgICBpZiAocm93KSB7XHJcbiAgICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gcGF0aHMucG9wKCk7XHJcbiAgICAgICAgbGV0IHBhcmVudCA9IHBhdGhzLnJlZHVjZSgob2JqZWN0OiBhbnksIHBhdGg6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIG9iamVjdCAmJiBvYmplY3RbcGF0aF0gfHwgbnVsbDtcclxuICAgICAgICB9LCBlbnRpdHkpO1xyXG4gICAgICAgIGNvbnN0IG5vZGUgPSB7IF9faXRlbXNfXzogWy4uLnBhcmVudFtwcm9wZXJ0eU5hbWVdXSwgLi4ucm93LCBfX3R5cGVfXzogJ0xpc3QnIH07XHJcbiAgICAgICAgcGFyZW50W3Byb3BlcnR5TmFtZV0gPSBub2RlO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBlbnRpdHk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluS4u+WunuS9k+WOn+Wni+Wtl+auteWQjVxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBnZXQgZW50aXR5T3JpZ2luYWxOb2RlQ29kZSgpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgcmVwb3NpdG9yeSA9IHRoaXMuaW5qZWN0b3IuZ2V0KFJlcG9zaXRvcnkpO1xyXG4gICAgcmV0dXJuIHJlcG9zaXRvcnkgJiYgcmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbyAmJiByZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvLmVudGl0eUluZm8gJiYgcmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mby5lbnRpdHlJbmZvLm9yaWdpbmFsQ29kZSB8fCBudWxsO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmnoTpgKDlj5jph4/kuIrkuIvmlodcclxuICAgKiBAcGFyYW0gZXZlbnQgXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIGJ1aWxkU3RhdGVDb250ZXh0KCkge1xyXG4gICAgY29uc3QgbnMgPSB0aGlzLmZyYW1lQ29udGV4dC5uYW1lc3BhY2U7XHJcbiAgICBjb25zdCBhcHBDb250ZXh0ID0gdGhpcy5pbmplY3Rvci5nZXQ8QXBwQ29udGV4dD4oQXBwQ29udGV4dCwgbnVsbCk7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHNCeU5hbWVzcGFjZShucyk7XHJcbiAgICBjb25zdCByZXN1bHQgPSB7fTtcclxuICAgIGlmIChmcmFtZUNvbnRleHRzICYmIGZyYW1lQ29udGV4dHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBjb25zdCBhbm9ueW1vdXNGcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHRzWzBdO1xyXG4gICAgICBjb25zdCByb290RnJhbWVDb250ZXh0ID0gYW5vbnltb3VzRnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XHJcbiAgICAgIGlmIChyb290RnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgY29uc3QgdWlTdGF0ZSA9IHJvb3RGcmFtZUNvbnRleHQudmlld01vZGVsLnVpU3RhdGU7XHJcbiAgICAgICAgY29uc3QgcHJvcGVydHlOYW1lcyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHVpU3RhdGUpIHx8IFtdO1xyXG4gICAgICAgIHByb3BlcnR5TmFtZXMuZm9yRWFjaCgocHJvcDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICBpZiAocHJvcC5tYXRjaCgvXlthLXpBLVowLTlfXFwkXSskL2cpICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdFtwcm9wXSA9IHVpU3RhdGVbcHJvcF07XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG59Il19