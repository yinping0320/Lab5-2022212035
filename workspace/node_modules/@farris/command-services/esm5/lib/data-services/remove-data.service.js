import { Injectable } from '@angular/core';
import { of, EMPTY } from 'rxjs';
import { tap, switchMap, concatMap } from 'rxjs/operators';
import { FrameContext, } from '@farris/devkit';
import { FormLoadingService } from '../form-loading/form-loading.service';
import { FormNotifyService } from '../form-notify.service';
import { LanguageService } from '../languag.service';
import { FormMessageService } from '../form-message.service';
import { FormErrorService } from '../error/form-error.service';
import { CommandService } from '../command-service';
import { ListDataService } from './list-data.service';
import { TreeDataService } from './tree-data.service';
/**
 * 删除服务
 */
var RemoveDataService = /** @class */ (function () {
    /**
     * 构造函数
     * @param frameContext 组件上下文
     */
    function RemoveDataService(frameContext) {
        this.frameContext = frameContext;
        this.notifyService = this.frameContext.injector.get(FormNotifyService, null);
        this.messageService = this.frameContext.injector.get(FormMessageService, null);
        this.errorService = this.frameContext.injector.get(FormErrorService, null);
        this.loadingService = this.frameContext.injector.get(FormLoadingService, null);
        this.languageService = this.frameContext.injector.get(LanguageService, null);
        this.commandService = this.frameContext.injector.get(CommandService, null);
        this.listDataService = this.frameContext.injector.get(ListDataService, null);
        this.treeDataService = this.frameContext.injector.get(TreeDataService, null);
        this.befRepository = this.frameContext.repository;
    }
    /**
     * 删除id对应的实体
     * @param id 要删除的数据id
     * @param ifSave 是否保存
     * @param enableRemoveAndSave 是否启用删除并保存（仅为兼容，新调用请勿设置）
     * @summary
     * enableRemoveAndSave存在的意义：
     * 1、老表单的可能没有delAndSave方法；
     * 2、为了将ListDataService中的remove方法迁移到此方法上，显示设置为false，保持和以前行为一致；
     * 3、该参数默认为true，并且在WebComponent层不暴露，新命令不需要传递，默认为true；
     */
    RemoveDataService.prototype.removeById = function (id, ifSave, enableRemoveAndSave, successMsg) {
        if (enableRemoveAndSave === void 0) { enableRemoveAndSave = true; }
        var msg = successMsg ? successMsg : '';
        return this.innerRemoveById(id, ifSave, enableRemoveAndSave, msg);
    };
    RemoveDataService.prototype.removeByIds = function (ids) {
        throw new Error('Not Implemented');
    };
    /**
     * 删除id对应的实体，并执行保存
     */
    RemoveDataService.prototype.removeAndSaveById = function (id, successMsg) {
        var msg = successMsg ? successMsg : '';
        return this.innerRemoveById(id, true, true, msg);
    };
    /**
     * 删除并保存树节点数据
     */
    RemoveDataService.prototype.removeAndSaveByIdForTree = function (id, successMsg) {
        var _this = this;
        var msg = successMsg ? successMsg : '';
        // 检查要删除的id是否存在
        if (this.checkIdsToRemove([id]) === false) {
            this.notifyService.warning(this.languageService.plsSelectDeleteData, { hideTitle: true });
            return EMPTY;
        }
        // 检查是否有子节点
        var treeNodesData = this.befRepository.entityCollection.toJSON();
        if (this.treeDataService.hasChildNodes(id, treeNodesData) === true) {
            this.messageService.warning(this.languageService.deleteChildFirst);
            return EMPTY;
        }
        // 执行删除
        var remove$ = this.innerRemoveById(id, true, true, msg);
        var nextNodeId = this.treeDataService.getNextNodeIdAfterRemoving(id, treeNodesData);
        ;
        var result$ = remove$.pipe(tap(function () {
            _this.treeDataService.setNextNodeAfterRemoving(nextNodeId);
        }));
        return result$;
    };
    /**
     * 批量删除并保存
     */
    RemoveDataService.prototype.removeAndSaveByIds = function () {
        throw new Error('Not Implemented');
    };
    /**
     * 删除后的刷新
     */
    RemoveDataService.prototype.refreshAfterRemoving = function (loadCmdName, loadCmdFrameId) {
        if (!this.frameContext || !loadCmdName || !loadCmdFrameId) {
            return;
        }
        var commandService = this.frameContext.injector.get(CommandService, null);
        return commandService.execute(loadCmdName, loadCmdFrameId);
    };
    /**
     * 删除id对应的实体
     * @param id 实体id
     * @param ifSave 是否保存
     * @param enableRemoveAndSave 是否启用删除并保存（老EAPI上没有此方法，通过开关进行兼容）
     * @summary
     * enableRemoveAndSave参数说明：
     * 1、老EAPI上没有delAndSave方法，只能发两次请求（删除和保存）；
     * 2、此开关用于选择使用哪种方式，兼容老表单。
     */
    RemoveDataService.prototype.innerRemoveById = function (id, ifSave, enableRemoveAndSave, successMsg) {
        var _this = this;
        // 检查要删除的id是否存在
        if (this.checkIdsToRemove([id]) === false) {
            this.notifyService.warning(this.languageService.plsSelectDeleteData, { hideTitle: true });
            return EMPTY;
        }
        var confirm$ = this.confirmToRemove();
        var remove$ = enableRemoveAndSave && ifSave ?
            this.befRepository.removeEntityAndSaveById(id) :
            this.befRepository.removeById(id, ifSave);
        var result$ = confirm$.pipe(concatMap(function (ifRemove) {
            if (ifRemove === false) {
                return EMPTY;
            }
            var loadingTimerId = _this.loadingService.showLoadingWithDelay(500);
            return remove$.pipe(tap(function () {
                _this.loadingService.hideDelayLoading(loadingTimerId);
                if (successMsg && successMsg.trim()) {
                    var showMessage = true;
                    if (successMsg.startsWith('{') && successMsg.endsWith('}')) {
                        try {
                            var options = JSON.parse(successMsg);
                            if (options.showMessage === false) {
                                showMessage = false;
                            }
                        }
                        catch (_a) { }
                    }
                    if (showMessage !== false) {
                        _this.notifyService.success(successMsg, { hideTitle: true });
                    }
                }
                else {
                    _this.notifyService.success(_this.languageService.deleteSuccess, { hideTitle: true });
                }
                // this.notifyService.success(this.languageService.deleteSuccess, { hideTitle: true });
            }, function (error) {
                _this.loadingService.hideDelayLoading(loadingTimerId);
                _this.errorService.exception(_this.languageService.deleteFailed, error);
            }), switchMap(function () {
                var saved = enableRemoveAndSave && ifSave;
                if (!saved) {
                    return EMPTY;
                }
                else {
                    return of(null);
                }
            }));
        }));
        return result$;
    };
    /**
     * 检查要删除的ids是否为空
     */
    RemoveDataService.prototype.checkIdsToRemove = function (ids) {
        if (!ids) {
            return false;
        }
        var filteredIds = ids.filter(function (id) {
            return !!id;
        });
        if (filteredIds.length === 0) {
            return false;
        }
        return true;
    };
    /**
     * 确认删除
     */
    RemoveDataService.prototype.confirmToRemove = function () {
        var confirm$ = this.messageService.question(this.languageService.confirmDeletion);
        var result$ = confirm$.pipe(concatMap(function (ifRemove) {
            if (ifRemove === false) {
                return EMPTY;
            }
            else {
                return of(true);
            }
        }));
        return result$;
    };
    RemoveDataService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    RemoveDataService.ctorParameters = function () { return [
        { type: FrameContext }
    ]; };
    return RemoveDataService;
}());
export { RemoveDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVtb3ZlLWRhdGEuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9kYXRhLXNlcnZpY2VzL3JlbW92ZS1kYXRhLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWMsRUFBRSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM3QyxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzRCxPQUFPLEVBQUUsWUFBWSxHQUFXLE1BQU0sZ0JBQWdCLENBQUM7QUFFdkQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDMUUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzdELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRXREOztHQUVHO0FBQ0g7SUFxQkU7OztPQUdHO0lBQ0gsMkJBQW9CLFlBQTBCO1FBQTFCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzVDLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFvQixpQkFBaUIsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNoRyxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBcUIsa0JBQWtCLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbkcsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQW1CLGdCQUFnQixFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzdGLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFxQixrQkFBa0IsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVuRyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBa0IsZUFBZSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzlGLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFpQixjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDM0YsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQWtCLGVBQWUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM5RixJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBa0IsZUFBZSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzlGLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFtQyxDQUFDO0lBQzdFLENBQUM7SUFFRDs7Ozs7Ozs7OztPQVVHO0lBQ0ksc0NBQVUsR0FBakIsVUFBa0IsRUFBVSxFQUFFLE1BQWUsRUFBRSxtQkFBbUMsRUFBRSxVQUFtQjtRQUF4RCxvQ0FBQSxFQUFBLDBCQUFtQztRQUNoRixJQUFNLEdBQUcsR0FBRyxVQUFVLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQ3pDLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxFQUFFLEVBQUUsTUFBTSxFQUFFLG1CQUFtQixFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3BFLENBQUM7SUFFTSx1Q0FBVyxHQUFsQixVQUFtQixHQUFhO1FBQzlCLE1BQU0sSUFBSSxLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBRUQ7O09BRUc7SUFDSSw2Q0FBaUIsR0FBeEIsVUFBeUIsRUFBVSxFQUFFLFVBQW1CO1FBQ3RELElBQU0sR0FBRyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDekMsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFFRDs7T0FFRztJQUNJLG9EQUF3QixHQUEvQixVQUFnQyxFQUFVLEVBQUUsVUFBbUI7UUFBL0QsaUJBeUJDO1FBeEJDLElBQU0sR0FBRyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDekMsZUFBZTtRQUNmLElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxLQUFLLEVBQUU7WUFDekMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxtQkFBbUIsRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQzFGLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFFRCxXQUFXO1FBQ1gsSUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNuRSxJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsYUFBYSxDQUFDLEVBQUUsRUFBRSxhQUFhLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDbEUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ25FLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFFRCxPQUFPO1FBQ1AsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztRQUMxRCxJQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLDBCQUEwQixDQUFDLEVBQUUsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUFBLENBQUM7UUFDdkYsSUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FDMUIsR0FBRyxDQUFDO1lBQ0YsS0FBSSxDQUFDLGVBQWUsQ0FBQyx3QkFBd0IsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUM1RCxDQUFDLENBQUMsQ0FDSCxDQUFDO1FBRUYsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUdEOztPQUVHO0lBQ0ksOENBQWtCLEdBQXpCO1FBQ0UsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFRDs7T0FFRztJQUNJLGdEQUFvQixHQUEzQixVQUE0QixXQUFtQixFQUFFLGNBQXNCO1FBQ3JFLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsV0FBVyxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ3pELE9BQU87U0FDUjtRQUNELElBQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBaUIsY0FBYyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzVGLE9BQU8sY0FBYyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFDN0QsQ0FBQztJQUVEOzs7Ozs7Ozs7T0FTRztJQUNLLDJDQUFlLEdBQXZCLFVBQXdCLEVBQVUsRUFBRSxNQUFlLEVBQUUsbUJBQTRCLEVBQUUsVUFBa0I7UUFBckcsaUJBMkRDO1FBekRDLGVBQWU7UUFDZixJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxFQUFFO1lBQ3pDLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsbUJBQW1CLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUMxRixPQUFPLEtBQUssQ0FBQztTQUNkO1FBRUQsSUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ3hDLElBQU0sT0FBTyxHQUFHLG1CQUFtQixJQUFJLE1BQU0sQ0FBQyxDQUFDO1lBQzdDLElBQUksQ0FBQyxhQUFhLENBQUMsdUJBQXVCLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNoRCxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFNUMsSUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FDM0IsU0FBUyxDQUFDLFVBQUMsUUFBaUI7WUFDMUIsSUFBSSxRQUFRLEtBQUssS0FBSyxFQUFFO2dCQUN0QixPQUFPLEtBQUssQ0FBQzthQUNkO1lBQ0QsSUFBTSxjQUFjLEdBQUcsS0FBSSxDQUFDLGNBQWMsQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNyRSxPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQ2pCLEdBQUcsQ0FDRDtnQkFDRSxLQUFJLENBQUMsY0FBYyxDQUFDLGdCQUFnQixDQUFDLGNBQWMsQ0FBQyxDQUFDO2dCQUNyRCxJQUFJLFVBQVUsSUFBSSxVQUFVLENBQUMsSUFBSSxFQUFFLEVBQUU7b0JBQ25DLElBQUksV0FBVyxHQUFZLElBQUksQ0FBQztvQkFDaEMsSUFBSSxVQUFVLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLFVBQVUsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7d0JBQzFELElBQUk7NEJBQ0YsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQzs0QkFDdkMsSUFBSSxPQUFPLENBQUMsV0FBVyxLQUFLLEtBQUssRUFBRTtnQ0FDakMsV0FBVyxHQUFHLEtBQUssQ0FBQzs2QkFDckI7eUJBQ0Y7d0JBQUMsV0FBTSxHQUFHO3FCQUNaO29CQUNELElBQUksV0FBVyxLQUFLLEtBQUssRUFBRTt3QkFDekIsS0FBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7cUJBQzdEO2lCQUNGO3FCQUFNO29CQUNMLEtBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEtBQUksQ0FBQyxlQUFlLENBQUMsYUFBYSxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7aUJBQ3JGO2dCQUNELHVGQUF1RjtZQUN6RixDQUFDLEVBQ0QsVUFBQyxLQUFVO2dCQUNULEtBQUksQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLENBQUM7Z0JBQ3JELEtBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLEtBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3hFLENBQUMsQ0FDRixFQUNELFNBQVMsQ0FBQztnQkFDUixJQUFNLEtBQUssR0FBRyxtQkFBbUIsSUFBSSxNQUFNLENBQUM7Z0JBQzVDLElBQUksQ0FBQyxLQUFLLEVBQUU7b0JBQ1YsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7cUJBQU07b0JBQ0wsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQ2pCO1lBQ0gsQ0FBQyxDQUFDLENBQ0gsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUNILENBQUM7UUFFRixPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBRUQ7O09BRUc7SUFDSyw0Q0FBZ0IsR0FBeEIsVUFBeUIsR0FBYTtRQUNwQyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ1IsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUNELElBQU0sV0FBVyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsVUFBQyxFQUFVO1lBQ3hDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUNkLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxXQUFXLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUM1QixPQUFPLEtBQUssQ0FBQztTQUNkO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQ7O09BRUc7SUFDSywyQ0FBZSxHQUF2QjtRQUNFLElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDcEYsSUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FDM0IsU0FBUyxDQUFDLFVBQUMsUUFBaUI7WUFDMUIsSUFBSSxRQUFRLEtBQUssS0FBSyxFQUFFO2dCQUN0QixPQUFPLEtBQUssQ0FBQzthQUNkO2lCQUFNO2dCQUNMLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ2pCO1FBQ0gsQ0FBQyxDQUNBLENBQUMsQ0FBQztRQUNMLE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7O2dCQTFORixVQUFVOzs7O2dCQWRGLFlBQVk7O0lBeU9yQix3QkFBQztDQUFBLEFBM05ELElBMk5DO0FBRUQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBFTVBUWSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YXAsIHN3aXRjaE1hcCwgY29uY2F0TWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQsIEVudGl0eSwgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnksIH0gZnJvbSAnQGZhcnJpcy9iZWYnO1xyXG5pbXBvcnQgeyBGb3JtTG9hZGluZ1NlcnZpY2UgfSBmcm9tICcuLi9mb3JtLWxvYWRpbmcvZm9ybS1sb2FkaW5nLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGb3JtTm90aWZ5U2VydmljZSB9IGZyb20gJy4uL2Zvcm0tbm90aWZ5LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuLi9sYW5ndWFnLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGb3JtTWVzc2FnZVNlcnZpY2UgfSBmcm9tICcuLi9mb3JtLW1lc3NhZ2Uuc2VydmljZSc7XHJcbmltcG9ydCB7IEZvcm1FcnJvclNlcnZpY2UgfSBmcm9tICcuLi9lcnJvci9mb3JtLWVycm9yLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBDb21tYW5kU2VydmljZSB9IGZyb20gJy4uL2NvbW1hbmQtc2VydmljZSc7XHJcbmltcG9ydCB7IExpc3REYXRhU2VydmljZSB9IGZyb20gJy4vbGlzdC1kYXRhLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBUcmVlRGF0YVNlcnZpY2UgfSBmcm9tICcuL3RyZWUtZGF0YS5zZXJ2aWNlJztcclxuXHJcbi8qKlxyXG4gKiDliKDpmaTmnI3liqFcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuY2xhc3MgUmVtb3ZlRGF0YVNlcnZpY2Uge1xyXG5cclxuICBwcml2YXRlIG5vdGlmeVNlcnZpY2U6IEZvcm1Ob3RpZnlTZXJ2aWNlO1xyXG5cclxuICBwcml2YXRlIG1lc3NhZ2VTZXJ2aWNlOiBGb3JtTWVzc2FnZVNlcnZpY2U7XHJcblxyXG4gIHByaXZhdGUgbG9hZGluZ1NlcnZpY2U6IEZvcm1Mb2FkaW5nU2VydmljZTtcclxuXHJcbiAgcHJpdmF0ZSBlcnJvclNlcnZpY2U6IEZvcm1FcnJvclNlcnZpY2U7XHJcblxyXG4gIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2U7XHJcblxyXG4gIHByaXZhdGUgYmVmUmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxhbnk+O1xyXG5cclxuICBwcml2YXRlIGNvbW1hbmRTZXJ2aWNlOiBDb21tYW5kU2VydmljZTtcclxuXHJcbiAgcHJpdmF0ZSBsaXN0RGF0YVNlcnZpY2U6IExpc3REYXRhU2VydmljZTtcclxuXHJcbiAgcHJpdmF0ZSB0cmVlRGF0YVNlcnZpY2U6IFRyZWVEYXRhU2VydmljZTtcclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICogQHBhcmFtIGZyYW1lQ29udGV4dCDnu4Tku7bkuIrkuIvmlodcclxuICAgKi9cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSB7XHJcbiAgICB0aGlzLm5vdGlmeVNlcnZpY2UgPSB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8Rm9ybU5vdGlmeVNlcnZpY2U+KEZvcm1Ob3RpZnlTZXJ2aWNlLCBudWxsKTtcclxuICAgIHRoaXMubWVzc2FnZVNlcnZpY2UgPSB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8Rm9ybU1lc3NhZ2VTZXJ2aWNlPihGb3JtTWVzc2FnZVNlcnZpY2UsIG51bGwpO1xyXG4gICAgdGhpcy5lcnJvclNlcnZpY2UgPSB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8Rm9ybUVycm9yU2VydmljZT4oRm9ybUVycm9yU2VydmljZSwgbnVsbCk7XHJcbiAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlID0gdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PEZvcm1Mb2FkaW5nU2VydmljZT4oRm9ybUxvYWRpbmdTZXJ2aWNlLCBudWxsKTtcclxuXHJcbiAgICB0aGlzLmxhbmd1YWdlU2VydmljZSA9IHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxMYW5ndWFnZVNlcnZpY2U+KExhbmd1YWdlU2VydmljZSwgbnVsbCk7XHJcbiAgICB0aGlzLmNvbW1hbmRTZXJ2aWNlID0gdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PENvbW1hbmRTZXJ2aWNlPihDb21tYW5kU2VydmljZSwgbnVsbCk7XHJcbiAgICB0aGlzLmxpc3REYXRhU2VydmljZSA9IHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxMaXN0RGF0YVNlcnZpY2U+KExpc3REYXRhU2VydmljZSwgbnVsbCk7XHJcbiAgICB0aGlzLnRyZWVEYXRhU2VydmljZSA9IHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxUcmVlRGF0YVNlcnZpY2U+KFRyZWVEYXRhU2VydmljZSwgbnVsbCk7XHJcbiAgICB0aGlzLmJlZlJlcG9zaXRvcnkgPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8RW50aXR5PjtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIoOmZpGlk5a+55bqU55qE5a6e5L2TXHJcbiAgICogQHBhcmFtIGlkIOimgeWIoOmZpOeahOaVsOaNrmlkXHJcbiAgICogQHBhcmFtIGlmU2F2ZSDmmK/lkKbkv53lrZhcclxuICAgKiBAcGFyYW0gZW5hYmxlUmVtb3ZlQW5kU2F2ZSDmmK/lkKblkK/nlKjliKDpmaTlubbkv53lrZjvvIjku4XkuLrlhbzlrrnvvIzmlrDosIPnlKjor7fli7/orr7nva7vvIlcclxuICAgKiBAc3VtbWFyeVxyXG4gICAqIGVuYWJsZVJlbW92ZUFuZFNhdmXlrZjlnKjnmoTmhI/kuYnvvJpcclxuICAgKiAx44CB6ICB6KGo5Y2V55qE5Y+v6IO95rKh5pyJZGVsQW5kU2F2ZeaWueazle+8m1xyXG4gICAqIDLjgIHkuLrkuoblsIZMaXN0RGF0YVNlcnZpY2XkuK3nmoRyZW1vdmXmlrnms5Xov4Hnp7vliLDmraTmlrnms5XkuIrvvIzmmL7npLrorr7nva7kuLpmYWxzZe+8jOS/neaMgeWSjOS7peWJjeihjOS4uuS4gOiHtO+8m1xyXG4gICAqIDPjgIHor6Xlj4LmlbDpu5jorqTkuLp0cnVl77yM5bm25LiU5ZyoV2ViQ29tcG9uZW505bGC5LiN5pq06Zyy77yM5paw5ZG95Luk5LiN6ZyA6KaB5Lyg6YCS77yM6buY6K6k5Li6dHJ1Ze+8m1xyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmVCeUlkKGlkOiBzdHJpbmcsIGlmU2F2ZTogYm9vbGVhbiwgZW5hYmxlUmVtb3ZlQW5kU2F2ZTogYm9vbGVhbiA9IHRydWUsIHN1Y2Nlc3NNc2c/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIGNvbnN0IG1zZyA9IHN1Y2Nlc3NNc2cgPyBzdWNjZXNzTXNnIDogJyc7XHJcbiAgICByZXR1cm4gdGhpcy5pbm5lclJlbW92ZUJ5SWQoaWQsIGlmU2F2ZSwgZW5hYmxlUmVtb3ZlQW5kU2F2ZSwgbXNnKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyByZW1vdmVCeUlkcyhpZHM6IHN0cmluZ1tdKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBJbXBsZW1lbnRlZCcpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yig6ZmkaWTlr7nlupTnmoTlrp7kvZPvvIzlubbmiafooYzkv53lrZhcclxuICAgKi9cclxuICBwdWJsaWMgcmVtb3ZlQW5kU2F2ZUJ5SWQoaWQ6IHN0cmluZywgc3VjY2Vzc01zZz86IHN0cmluZyk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgY29uc3QgbXNnID0gc3VjY2Vzc01zZyA/IHN1Y2Nlc3NNc2cgOiAnJztcclxuICAgIHJldHVybiB0aGlzLmlubmVyUmVtb3ZlQnlJZChpZCwgdHJ1ZSwgdHJ1ZSwgbXNnKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIoOmZpOW5tuS/neWtmOagkeiKgueCueaVsOaNrlxyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmVBbmRTYXZlQnlJZEZvclRyZWUoaWQ6IHN0cmluZywgc3VjY2Vzc01zZz86IHN0cmluZyk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgY29uc3QgbXNnID0gc3VjY2Vzc01zZyA/IHN1Y2Nlc3NNc2cgOiAnJztcclxuICAgIC8vIOajgOafpeimgeWIoOmZpOeahGlk5piv5ZCm5a2Y5ZyoXHJcbiAgICBpZiAodGhpcy5jaGVja0lkc1RvUmVtb3ZlKFtpZF0pID09PSBmYWxzZSkge1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5wbHNTZWxlY3REZWxldGVEYXRhLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOajgOafpeaYr+WQpuacieWtkOiKgueCuVxyXG4gICAgY29uc3QgdHJlZU5vZGVzRGF0YSA9IHRoaXMuYmVmUmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLnRvSlNPTigpO1xyXG4gICAgaWYgKHRoaXMudHJlZURhdGFTZXJ2aWNlLmhhc0NoaWxkTm9kZXMoaWQsIHRyZWVOb2Rlc0RhdGEpID09PSB0cnVlKSB7XHJcbiAgICAgIHRoaXMubWVzc2FnZVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5kZWxldGVDaGlsZEZpcnN0KTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOaJp+ihjOWIoOmZpFxyXG4gICAgY29uc3QgcmVtb3ZlJCA9IHRoaXMuaW5uZXJSZW1vdmVCeUlkKGlkLCB0cnVlLCB0cnVlLCBtc2cpO1xyXG4gICAgY29uc3QgbmV4dE5vZGVJZCA9IHRoaXMudHJlZURhdGFTZXJ2aWNlLmdldE5leHROb2RlSWRBZnRlclJlbW92aW5nKGlkLCB0cmVlTm9kZXNEYXRhKTs7XHJcbiAgICBjb25zdCByZXN1bHQkID0gcmVtb3ZlJC5waXBlKFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMudHJlZURhdGFTZXJ2aWNlLnNldE5leHROb2RlQWZ0ZXJSZW1vdmluZyhuZXh0Tm9kZUlkKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcblxyXG4gICAgcmV0dXJuIHJlc3VsdCQ7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICog5om56YeP5Yig6Zmk5bm25L+d5a2YXHJcbiAgICovXHJcbiAgcHVibGljIHJlbW92ZUFuZFNhdmVCeUlkcygpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTm90IEltcGxlbWVudGVkJyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliKDpmaTlkI7nmoTliLfmlrBcclxuICAgKi9cclxuICBwdWJsaWMgcmVmcmVzaEFmdGVyUmVtb3ZpbmcobG9hZENtZE5hbWU6IHN0cmluZywgbG9hZENtZEZyYW1lSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBpZiAoIXRoaXMuZnJhbWVDb250ZXh0IHx8ICFsb2FkQ21kTmFtZSB8fCAhbG9hZENtZEZyYW1lSWQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgY29tbWFuZFNlcnZpY2UgPSB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8Q29tbWFuZFNlcnZpY2U+KENvbW1hbmRTZXJ2aWNlLCBudWxsKTtcclxuICAgIHJldHVybiBjb21tYW5kU2VydmljZS5leGVjdXRlKGxvYWRDbWROYW1lLCBsb2FkQ21kRnJhbWVJZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliKDpmaRpZOWvueW6lOeahOWunuS9k1xyXG4gICAqIEBwYXJhbSBpZCDlrp7kvZNpZFxyXG4gICAqIEBwYXJhbSBpZlNhdmUg5piv5ZCm5L+d5a2YXHJcbiAgICogQHBhcmFtIGVuYWJsZVJlbW92ZUFuZFNhdmUg5piv5ZCm5ZCv55So5Yig6Zmk5bm25L+d5a2Y77yI6ICBRUFQSeS4iuayoeacieatpOaWueazle+8jOmAmui/h+W8gOWFs+i/m+ihjOWFvOWuue+8iVxyXG4gICAqIEBzdW1tYXJ5XHJcbiAgICogZW5hYmxlUmVtb3ZlQW5kU2F2ZeWPguaVsOivtOaYju+8mlxyXG4gICAqIDHjgIHogIFFQVBJ5LiK5rKh5pyJZGVsQW5kU2F2ZeaWueazle+8jOWPquiDveWPkeS4pOasoeivt+axgu+8iOWIoOmZpOWSjOS/neWtmO+8ie+8m1xyXG4gICAqIDLjgIHmraTlvIDlhbPnlKjkuo7pgInmi6nkvb/nlKjlk6rnp43mlrnlvI/vvIzlhbzlrrnogIHooajljZXjgIJcclxuICAgKi9cclxuICBwcml2YXRlIGlubmVyUmVtb3ZlQnlJZChpZDogc3RyaW5nLCBpZlNhdmU6IGJvb2xlYW4sIGVuYWJsZVJlbW92ZUFuZFNhdmU6IGJvb2xlYW4sIHN1Y2Nlc3NNc2c6IHN0cmluZyk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG5cclxuICAgIC8vIOajgOafpeimgeWIoOmZpOeahGlk5piv5ZCm5a2Y5ZyoXHJcbiAgICBpZiAodGhpcy5jaGVja0lkc1RvUmVtb3ZlKFtpZF0pID09PSBmYWxzZSkge1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5wbHNTZWxlY3REZWxldGVEYXRhLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGNvbmZpcm0kID0gdGhpcy5jb25maXJtVG9SZW1vdmUoKTtcclxuICAgIGNvbnN0IHJlbW92ZSQgPSBlbmFibGVSZW1vdmVBbmRTYXZlICYmIGlmU2F2ZSA/XHJcbiAgICAgIHRoaXMuYmVmUmVwb3NpdG9yeS5yZW1vdmVFbnRpdHlBbmRTYXZlQnlJZChpZCkgOlxyXG4gICAgICB0aGlzLmJlZlJlcG9zaXRvcnkucmVtb3ZlQnlJZChpZCwgaWZTYXZlKTtcclxuXHJcbiAgICBjb25zdCByZXN1bHQkID0gY29uZmlybSQucGlwZShcclxuICAgICAgY29uY2F0TWFwKChpZlJlbW92ZTogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgIGlmIChpZlJlbW92ZSA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgbG9hZGluZ1RpbWVySWQgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3dMb2FkaW5nV2l0aERlbGF5KDUwMCk7XHJcbiAgICAgICAgcmV0dXJuIHJlbW92ZSQucGlwZShcclxuICAgICAgICAgIHRhcChcclxuICAgICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XHJcbiAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3NNc2cgJiYgc3VjY2Vzc01zZy50cmltKCkpIHtcclxuICAgICAgICAgICAgICAgIGxldCBzaG93TWVzc2FnZTogYm9vbGVhbiA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3VjY2Vzc01zZy5zdGFydHNXaXRoKCd7JykgJiYgc3VjY2Vzc01zZy5lbmRzV2l0aCgnfScpKSB7XHJcbiAgICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IEpTT04ucGFyc2Uoc3VjY2Vzc01zZyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuc2hvd01lc3NhZ2UgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICBzaG93TWVzc2FnZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgfSBjYXRjaCB7IH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChzaG93TWVzc2FnZSAhPT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLnN1Y2Nlc3Moc3VjY2Vzc01zZywgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZS5zdWNjZXNzKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmRlbGV0ZVN1Y2Nlc3MsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAvLyB0aGlzLm5vdGlmeVNlcnZpY2Uuc3VjY2Vzcyh0aGlzLmxhbmd1YWdlU2VydmljZS5kZWxldGVTdWNjZXNzLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xyXG4gICAgICAgICAgICAgIHRoaXMuZXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5kZWxldGVGYWlsZWQsIGVycm9yKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgKSxcclxuICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNhdmVkID0gZW5hYmxlUmVtb3ZlQW5kU2F2ZSAmJiBpZlNhdmU7XHJcbiAgICAgICAgICAgIGlmICghc2F2ZWQpIHtcclxuICAgICAgICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIG9mKG51bGwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIHJldHVybiByZXN1bHQkO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qOA5p+l6KaB5Yig6Zmk55qEaWRz5piv5ZCm5Li656m6XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjaGVja0lkc1RvUmVtb3ZlKGlkczogc3RyaW5nW10pOiBib29sZWFuIHtcclxuICAgIGlmICghaWRzKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGNvbnN0IGZpbHRlcmVkSWRzID0gaWRzLmZpbHRlcigoaWQ6IHN0cmluZykgPT4ge1xyXG4gICAgICByZXR1cm4gISFpZDtcclxuICAgIH0pO1xyXG4gICAgaWYgKGZpbHRlcmVkSWRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDnoa7orqTliKDpmaRcclxuICAgKi9cclxuICBwcml2YXRlIGNvbmZpcm1Ub1JlbW92ZSgpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIGNvbnN0IGNvbmZpcm0kID0gdGhpcy5tZXNzYWdlU2VydmljZS5xdWVzdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5jb25maXJtRGVsZXRpb24pO1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IGNvbmZpcm0kLnBpcGUoXHJcbiAgICAgIGNvbmNhdE1hcCgoaWZSZW1vdmU6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICBpZiAoaWZSZW1vdmUgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgKSk7XHJcbiAgICByZXR1cm4gcmVzdWx0JDtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IFJlbW92ZURhdGFTZXJ2aWNlIH07XHJcblxyXG5cclxuIl19