import * as tslib_1 from "tslib";
import { Injectable, Optional } from '@angular/core';
import { EMPTY } from 'rxjs';
import { tap, concatMap } from 'rxjs/operators';
import { FrameContext, ViewModel } from '@farris/devkit';
import { BaseDataService } from './base-data.service';
import { FormMessageService } from '../form-message.service';
import { FormLoadingService } from '../form-loading/form-loading.service';
import { FormErrorService } from '../error/form-error.service';
import { FormNotifyService } from '../form-notify.service';
import { LanguageService } from '../languag.service';
import { TreeRepositoryFactory } from './tree-table/repository/tree-repository-factory';
import { TreeUtilFactory } from './tree-table/util/tree-util-factory';
/**
 * 树数据服务
 */
var SubTreeDataService = /** @class */ (function (_super) {
    tslib_1.__extends(SubTreeDataService, _super);
    /**
     * 构造函数
     */
    function SubTreeDataService(frameContext, viewModel, messageService, loadingService, errorService, formNotifyService, languageService) {
        var _this = _super.call(this, frameContext) || this;
        _this.viewModel = viewModel;
        _this.messageService = messageService;
        _this.loadingService = loadingService;
        _this.errorService = errorService;
        _this.formNotifyService = formNotifyService;
        _this.languageService = languageService;
        if (!languageService) {
            _this.languageService = LanguageService.getInstance();
        }
        return _this;
    }
    Object.defineProperty(SubTreeDataService.prototype, "hierarchyInfoKey", {
        /**
         * 分级码信息
         */
        get: function () {
            return this.virtualRootFrameContext.getParam('hierarchyInfoKey');
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SubTreeDataService.prototype, "hierarchyInfoField", {
        get: function () {
            return this.hierarchyInfoKey.split('/').filter(function (p) { return p; }).pop();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SubTreeDataService.prototype, "virtualRootFrameContext", {
        get: function () {
            return this.frameContext.getVirtualRootFrameContext();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SubTreeDataService.prototype, "messagePipe", {
        get: function () {
            if (this.viewModel && this.viewModel.frameContext) {
                var appContext = this.viewModel.frameContext.getFormAppContext() || null;
                if (appContext) {
                    return appContext.messagePipe || null;
                }
            }
            return null;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 新增子表同级
     */
    SubTreeDataService.prototype.addSubSibling = function () {
        var _this = this;
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'addSubSibling' });
        }
        var params = this.getParams();
        // 获取分级方式
        var hierarchyType = this.getHierarchyType();
        // 执行取数
        var loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        var repository = TreeRepositoryFactory.getInstance(hierarchyType);
        if (!repository) {
            // 错误的分级码
            throw new Error(this.languageService['errorHierarchyKey']);
        }
        var result$ = repository.addSubSibling(this.repository, params.nodeCodes, params.ids);
        return result$.pipe(tap(function () {
            _this.loadingService.hideDelayLoading(loadingTimerId);
        }, function (error) {
            _this.errorService.exception(_this.languageService.addSubSiblingFailed, error);
        }));
    };
    /**
     * 新增下级
     */
    SubTreeDataService.prototype.addSubChild = function () {
        var _this = this;
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'addSubChild' });
        }
        var params = this.getParams();
        // 获取分级方式
        var hierarchyType = this.getHierarchyType();
        var currentList = this.frameContext && this.frameContext.bindingData && this.frameContext.bindingData.getList();
        if (!currentList['currentId']) {
            // 请选择父节点
            this.formNotifyService.warning(this.languageService['plsSelectParentNode'], { hideTitle: true });
            return EMPTY;
        }
        // 执行取数
        var loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        var repository = TreeRepositoryFactory.getInstance(hierarchyType);
        if (!repository) {
            throw new Error(this.languageService['errorHierarchyKey']);
        }
        var addSubChild$ = repository.addSubChild(this.repository, params.nodeCodes, params.ids);
        var result$ = addSubChild$.pipe(tap(function () {
            _this.loadingService.hideDelayLoading(loadingTimerId);
        }, function (error) {
            _this.loadingService.hideDelayLoading(loadingTimerId);
            _this.errorService.exception(_this.languageService.addSubChildFailed, error);
        }));
        return result$;
    };
    /**
     * 删除子表树节点
     * @param id id
     */
    SubTreeDataService.prototype.remove = function (id, successMsg) {
        var _this = this;
        // 参数检查
        if (!id) {
            this.formNotifyService.warning(this.languageService['plsSelectDeleteData'], { hideTitle: true });
            return EMPTY;
        }
        // 获取分级方式
        var hierarchyType = this.getHierarchyType();
        // 有子节点时不允许删除
        var treeNodesData = this.frameContext.bindingData.getList().toJSON();
        var bindingList = this.frameContext.bindingData.getList();
        var treeNodeUtil = TreeUtilFactory.getInstance(hierarchyType);
        if (treeNodeUtil === null) {
            return EMPTY;
        }
        if (treeNodeUtil.hasChildNodes(treeNodesData, this.hierarchyInfoField, id) === true) {
            this.messageService.warning(this.languageService['deleteChildFirst']);
            return EMPTY;
        }
        // 确认删除
        var action$ = this.messageService.question(this.languageService.confirmDeletion);
        return action$.pipe(concatMap(function (result) {
            if (!result) {
                return EMPTY;
            }
            // 获取删除后要设置的节点id
            var nextNodeId = treeNodeUtil.getNextNodeId(treeNodesData, _this.hierarchyInfoField, id);
            // 执行删除
            var loadingTimerId = _this.loadingService.show();
            var path = _this.getPath();
            var remove$ = _this.frameContext.repository.removeByPath(path, id);
            return remove$.pipe(tap(function () {
                // 设置选中节点
                treeNodeUtil.selectNodeByBindingList(bindingList, _this.hierarchyInfoField, nextNodeId);
                _this.loadingService.hideDelayLoading(loadingTimerId);
                if (successMsg && successMsg.trim()) {
                    var showMessage = true;
                    if (successMsg.startsWith('{') && successMsg.endsWith('}')) {
                        try {
                            var options = JSON.parse(successMsg);
                            if (options.showMessage === false) {
                                showMessage = false;
                            }
                        }
                        catch (_a) { }
                    }
                    if (showMessage !== false) {
                        _this.formNotifyService.success(successMsg, { hideTitle: true });
                    }
                }
                else {
                    _this.formNotifyService.success(_this.languageService.deleteSuccess, { hideTitle: true });
                }
                // this.formNotifyService.success(this.languageService.deleteSuccess, { hideTitle: true });
            }, function (error) {
                _this.loadingService.hideDelayLoading(loadingTimerId);
                _this.errorService.exception(_this.languageService.deleteFailed, error);
            }));
        }));
    };
    SubTreeDataService.prototype.getHierarchyType = function () {
        var propInfo = this.repository.entityTypeInfo.getPropInfoByPath(this.hierarchyInfoKey.split('/'));
        var hierarchyType = propInfo.metadataInfo['hierarchyType'] || null;
        if (hierarchyType == null || hierarchyType.length < 1) {
            // '分级码配置信息错误'
            throw new Error(this.languageService['incorrectHierarchyConfig']);
        }
        return hierarchyType;
    };
    /**
     * 获取参数
     * /parentId/childCodes/childId/grandsonCodes
     * [childCodes, grandsonCodes]
     * [parntId, childId]
     */
    SubTreeDataService.prototype.getParams = function () {
        var nodeCodes = this.viewModel.bindingPath.substr(1).split('/');
        var ids = [];
        var nodeCodeArray = [];
        var rid = this.viewModel.bindingData.list.currentId; // root表数据id
        ids.push(rid);
        var subData = this.viewModel.bindingData;
        if (nodeCodes.length > 0) {
            nodeCodes.map(function (nodeCode) {
                subData = subData[nodeCode];
                if (subData && subData.currentId) {
                    ids.push(subData.currentId);
                }
                //去除nodeCode的s
                nodeCode ? nodeCodeArray.push(nodeCode.substring(0, nodeCode.length - 1)) : nodeCodeArray.push(nodeCode);
            });
        }
        return { nodeCodes: nodeCodeArray, ids: ids };
    };
    /**
     * 获取完整路径
     * fixed by justin: 根据bindingPath，如果是从从表，需要获取主表数据id和从表数据id
     */
    SubTreeDataService.prototype.getPath = function () {
        var bindingPath = this.viewModel.bindingPath;
        var rid = this.viewModel.bindingData.list.currentId; // root表数据id
        var path = '/' + rid;
        var subPaths = bindingPath.split('/').filter(function (p) { return p; });
        if (subPaths.length > 0) {
            // eg:bindingPath形如/edus/grades,split后是['edus', 'grades']
            var subData = this.viewModel.bindingData;
            for (var index = 1; index < subPaths.length - 1; index++) {
                var subPath = subPaths[index];
                subData = subData[subPath];
                if (!subData || !subData.currentId) {
                    throw Error("\u83B7\u53D6\u5B50\u8868\u5B8C\u6574\u8DEF\u5F84\u51FA\u9519\uFF0C\u627E\u4E0D\u5230" + subData + "\u5BF9\u5E94\u7684\u5B50\u8868\uFF0C\u6216\u5BF9\u5E94\u5B50\u8868\u6CA1\u6709\u5F53\u524D\u884C\u3002");
                }
                path += "/" + subPath + "/" + subData.currentId;
            }
        }
        path += '/' + subPaths[subPaths.length - 1];
        return path;
    };
    SubTreeDataService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    SubTreeDataService.ctorParameters = function () { return [
        { type: FrameContext },
        { type: ViewModel },
        { type: FormMessageService },
        { type: FormLoadingService },
        { type: FormErrorService },
        { type: FormNotifyService },
        { type: LanguageService, decorators: [{ type: Optional }] }
    ]; };
    return SubTreeDataService;
}(BaseDataService));
export { SubTreeDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ViLXRyZWUtZGF0YS1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2RhdGEtc2VydmljZXMvc3ViLXRyZWUtZGF0YS1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsS0FBSyxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxHQUFHLEVBQWEsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0QsT0FBTyxFQUFlLFlBQVksRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN0RSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDN0QsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDMUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDL0QsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBQ3hGLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUl0RTs7R0FFRztBQUNIO0lBQ2lDLDhDQUFlO0lBZTlDOztPQUVHO0lBQ0gsNEJBQ0UsWUFBMEIsRUFDbEIsU0FBb0IsRUFDcEIsY0FBa0MsRUFDbEMsY0FBa0MsRUFDbEMsWUFBOEIsRUFDOUIsaUJBQW9DLEVBQ3hCLGVBQWdDO1FBUHRELFlBU0Usa0JBQU0sWUFBWSxDQUFDLFNBSXBCO1FBWFMsZUFBUyxHQUFULFNBQVMsQ0FBVztRQUNwQixvQkFBYyxHQUFkLGNBQWMsQ0FBb0I7UUFDbEMsb0JBQWMsR0FBZCxjQUFjLENBQW9CO1FBQ2xDLGtCQUFZLEdBQVosWUFBWSxDQUFrQjtRQUM5Qix1QkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3hCLHFCQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUdwRCxJQUFJLENBQUMsZUFBZSxFQUFFO1lBQ3BCLEtBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQ3REOztJQUNILENBQUM7SUExQkQsc0JBQVksZ0RBQWdCO1FBSDVCOztXQUVHO2FBQ0g7WUFDRSxPQUFPLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUNuRSxDQUFDOzs7T0FBQTtJQUNELHNCQUFZLGtEQUFrQjthQUE5QjtZQUNFLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEVBQUQsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDL0QsQ0FBQzs7O09BQUE7SUFDRCxzQkFBWSx1REFBdUI7YUFBbkM7WUFDRSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztRQUN4RCxDQUFDOzs7T0FBQTtJQW9CRCxzQkFBWSwyQ0FBVzthQUF2QjtZQUNFLElBQUksSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksRUFBRTtnQkFDakQsSUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsaUJBQWlCLEVBQUUsSUFBSSxJQUFJLENBQUM7Z0JBQzNFLElBQUksVUFBVSxFQUFFO29CQUNkLE9BQU8sVUFBVSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUM7aUJBQ3ZDO2FBQ0Y7WUFDRCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7OztPQUFBO0lBRUQ7O09BRUc7SUFDSSwwQ0FBYSxHQUFwQjtRQUFBLGlCQXlCQztRQXhCQyxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDcEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsRUFBRSxXQUFXLEVBQUUsZUFBZSxFQUFFLENBQUMsQ0FBQztTQUN6RDtRQUNELElBQUksTUFBTSxHQUEyQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDdEUsU0FBUztRQUNULElBQU0sYUFBYSxHQUFXLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ3RELE9BQU87UUFDUCxJQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3JFLElBQU0sVUFBVSxHQUFHLHFCQUFxQixDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNwRSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ2YsU0FBUztZQUNULE1BQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUM7U0FDNUQ7UUFDRCxJQUFNLE9BQU8sR0FBRyxVQUFVLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsTUFBTSxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDeEYsT0FBTyxPQUFPLENBQUMsSUFBSSxDQUNqQixHQUFHLENBQ0Q7WUFDRSxLQUFJLENBQUMsY0FBYyxDQUFDLGdCQUFnQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ3ZELENBQUMsRUFDRCxVQUFBLEtBQUs7WUFDSCxLQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxLQUFJLENBQUMsZUFBZSxDQUFDLG1CQUFtQixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQy9FLENBQUMsQ0FDRixDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSSx3Q0FBVyxHQUFsQjtRQUFBLGlCQWtDQztRQWpDQyxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDcEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQztTQUN2RDtRQUNELElBQUksTUFBTSxHQUEyQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDdEUsU0FBUztRQUNULElBQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBRTlDLElBQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDbEgsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsRUFBRTtZQUM3QixTQUFTO1lBQ1QsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLHFCQUFxQixDQUFDLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUNqRyxPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsT0FBTztRQUNQLElBQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFckUsSUFBTSxVQUFVLEdBQUcscUJBQXFCLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3BFLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDZixNQUFNLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO1NBQzVEO1FBQ0QsSUFBTSxZQUFZLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzNGLElBQU0sT0FBTyxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQy9CLEdBQUcsQ0FDRDtZQUNFLEtBQUksQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDdkQsQ0FBQyxFQUNELFVBQUEsS0FBSztZQUNILEtBQUksQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDckQsS0FBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsS0FBSSxDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUM3RSxDQUFDLENBQ0YsQ0FDRixDQUFDO1FBQ0YsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUNEOzs7T0FHRztJQUNJLG1DQUFNLEdBQWIsVUFBYyxFQUFVLEVBQUUsVUFBbUI7UUFBN0MsaUJBZ0VDO1FBL0RDLE9BQU87UUFDUCxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ1AsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLHFCQUFxQixDQUFDLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUNqRyxPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsU0FBUztRQUNULElBQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQzlDLGFBQWE7UUFDYixJQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUN2RSxJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUM1RCxJQUFNLFlBQVksR0FBRyxlQUFlLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2hFLElBQUksWUFBWSxLQUFLLElBQUksRUFBRTtZQUN6QixPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBSSxZQUFZLENBQUMsYUFBYSxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsa0JBQWtCLEVBQUUsRUFBRSxDQUFDLEtBQUssSUFBSSxFQUFFO1lBQ25GLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO1lBQ3RFLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFDRCxPQUFPO1FBQ1AsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUNuRixPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQ2pCLFNBQVMsQ0FBQyxVQUFBLE1BQU07WUFDZCxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNYLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7WUFDRCxnQkFBZ0I7WUFDaEIsSUFBTSxVQUFVLEdBQUcsWUFBWSxDQUFDLGFBQWEsQ0FBQyxhQUFhLEVBQUUsS0FBSSxDQUFDLGtCQUFrQixFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBRTFGLE9BQU87WUFDUCxJQUFNLGNBQWMsR0FBRyxLQUFJLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2xELElBQU0sSUFBSSxHQUFHLEtBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUM1QixJQUFNLE9BQU8sR0FBRyxLQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ3BFLE9BQU8sT0FBTyxDQUFDLElBQUksQ0FDakIsR0FBRyxDQUFDO2dCQUNGLFNBQVM7Z0JBQ1QsWUFBWSxDQUFDLHVCQUF1QixDQUFDLFdBQVcsRUFBRSxLQUFJLENBQUMsa0JBQWtCLEVBQUUsVUFBVSxDQUFDLENBQUM7Z0JBQ3ZGLEtBQUksQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLENBQUM7Z0JBQ3JELElBQUksVUFBVSxJQUFJLFVBQVUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtvQkFDbkMsSUFBSSxXQUFXLEdBQVksSUFBSSxDQUFDO29CQUNoQyxJQUFJLFVBQVUsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksVUFBVSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRTt3QkFDMUQsSUFBSTs0QkFDRixJQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDOzRCQUN2QyxJQUFJLE9BQU8sQ0FBQyxXQUFXLEtBQUssS0FBSyxFQUFFO2dDQUNqQyxXQUFXLEdBQUcsS0FBSyxDQUFDOzZCQUNyQjt5QkFDRjt3QkFBQyxXQUFNLEdBQUc7cUJBQ1o7b0JBQ0QsSUFBSSxXQUFXLEtBQUssS0FBSyxFQUFFO3dCQUN6QixLQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO3FCQUNqRTtpQkFDRjtxQkFBTTtvQkFDTCxLQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLEtBQUksQ0FBQyxlQUFlLENBQUMsYUFBYSxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7aUJBQ3pGO2dCQUNELDJGQUEyRjtZQUM3RixDQUFDLEVBQ0MsVUFBQSxLQUFLO2dCQUNILEtBQUksQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLENBQUM7Z0JBQ3JELEtBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLEtBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3hFLENBQUMsQ0FDRixDQUNGLENBQUM7UUFDSixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVPLDZDQUFnQixHQUF4QjtRQUNFLElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNwRyxJQUFJLGFBQWEsR0FBRyxRQUFRLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxJQUFJLElBQUksQ0FBQztRQUNuRSxJQUFJLGFBQWEsSUFBSSxJQUFJLElBQUksYUFBYSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDckQsY0FBYztZQUNkLE1BQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDLENBQUM7U0FDbkU7UUFDRCxPQUFPLGFBQWEsQ0FBQztJQUN2QixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSyxzQ0FBUyxHQUFqQjtRQUNFLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDaEUsSUFBSSxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ2IsSUFBSSxhQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLElBQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxZQUFZO1FBQ25FLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDZCxJQUFJLE9BQU8sR0FBUSxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQztRQUM5QyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3hCLFNBQVMsQ0FBQyxHQUFHLENBQUMsVUFBQSxRQUFRO2dCQUNwQixPQUFPLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUM1QixJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsU0FBUyxFQUFFO29CQUNoQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztpQkFDN0I7Z0JBQ0QsY0FBYztnQkFDZCxRQUFRLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzNHLENBQUMsQ0FBQyxDQUFBO1NBQ0g7UUFDRCxPQUFPLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUM7SUFDaEQsQ0FBQztJQUNEOzs7T0FHRztJQUNLLG9DQUFPLEdBQWY7UUFDRSxJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQztRQUMvQyxJQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsWUFBWTtRQUNuRSxJQUFJLElBQUksR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBRXJCLElBQU0sUUFBUSxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFELENBQUMsQ0FBQyxDQUFDO1FBQ3ZELElBQUksUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDdkIseURBQXlEO1lBQ3pELElBQUksT0FBTyxHQUFRLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDO1lBQzlDLEtBQUssSUFBSSxLQUFLLEdBQUcsQ0FBQyxFQUFFLEtBQUssR0FBRyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRTtnQkFDeEQsSUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNoQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUMzQixJQUFJLENBQUMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRTtvQkFDbEMsTUFBTSxLQUFLLENBQUMseUZBQWlCLE9BQU8sMkdBQW1CLENBQUMsQ0FBQztpQkFDMUQ7Z0JBQ0QsSUFBSSxJQUFJLE1BQUksT0FBTyxTQUFJLE9BQU8sQ0FBQyxTQUFXLENBQUM7YUFDNUM7U0FDRjtRQUNELElBQUksSUFBSSxHQUFHLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFNUMsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDOztnQkFsUEYsVUFBVTs7OztnQkFmVyxZQUFZO2dCQUFFLFNBQVM7Z0JBRXBDLGtCQUFrQjtnQkFDbEIsa0JBQWtCO2dCQUNsQixnQkFBZ0I7Z0JBQ2hCLGlCQUFpQjtnQkFDakIsZUFBZSx1QkFtQ25CLFFBQVE7O0lBeU5iLHlCQUFDO0NBQUEsQUFuUEQsQ0FDaUMsZUFBZSxHQWtQL0M7QUFDRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEVNUFRZLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHRhcCwgc3dpdGNoTWFwLCBjb25jYXRNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBCaW5kaW5nTGlzdCwgRnJhbWVDb250ZXh0LCBWaWV3TW9kZWwgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IEJhc2VEYXRhU2VydmljZSB9IGZyb20gJy4vYmFzZS1kYXRhLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGb3JtTWVzc2FnZVNlcnZpY2UgfSBmcm9tICcuLi9mb3JtLW1lc3NhZ2Uuc2VydmljZSc7XHJcbmltcG9ydCB7IEZvcm1Mb2FkaW5nU2VydmljZSB9IGZyb20gJy4uL2Zvcm0tbG9hZGluZy9mb3JtLWxvYWRpbmcuc2VydmljZSc7XHJcbmltcG9ydCB7IEZvcm1FcnJvclNlcnZpY2UgfSBmcm9tICcuLi9lcnJvci9mb3JtLWVycm9yLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGb3JtTm90aWZ5U2VydmljZSB9IGZyb20gJy4uL2Zvcm0tbm90aWZ5LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuLi9sYW5ndWFnLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBUcmVlUmVwb3NpdG9yeUZhY3RvcnkgfSBmcm9tICcuL3RyZWUtdGFibGUvcmVwb3NpdG9yeS90cmVlLXJlcG9zaXRvcnktZmFjdG9yeSc7XHJcbmltcG9ydCB7IFRyZWVVdGlsRmFjdG9yeSB9IGZyb20gJy4vdHJlZS10YWJsZS91dGlsL3RyZWUtdXRpbC1mYWN0b3J5JztcclxuXHJcblxyXG5cclxuLyoqXHJcbiAqIOagkeaVsOaNruacjeWKoVxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5jbGFzcyBTdWJUcmVlRGF0YVNlcnZpY2UgZXh0ZW5kcyBCYXNlRGF0YVNlcnZpY2Uge1xyXG5cclxuICAvKipcclxuICAgKiDliIbnuqfnoIHkv6Hmga9cclxuICAgKi9cclxuICBwcml2YXRlIGdldCBoaWVyYXJjaHlJbmZvS2V5KCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy52aXJ0dWFsUm9vdEZyYW1lQ29udGV4dC5nZXRQYXJhbSgnaGllcmFyY2h5SW5mb0tleScpO1xyXG4gIH1cclxuICBwcml2YXRlIGdldCBoaWVyYXJjaHlJbmZvRmllbGQoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLmhpZXJhcmNoeUluZm9LZXkuc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS5wb3AoKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXQgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXHJcbiAgICBwcml2YXRlIHZpZXdNb2RlbDogVmlld01vZGVsLFxyXG4gICAgcHJpdmF0ZSBtZXNzYWdlU2VydmljZTogRm9ybU1lc3NhZ2VTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBsb2FkaW5nU2VydmljZTogRm9ybUxvYWRpbmdTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBlcnJvclNlcnZpY2U6IEZvcm1FcnJvclNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGZvcm1Ob3RpZnlTZXJ2aWNlOiBGb3JtTm90aWZ5U2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2VcclxuICApIHtcclxuICAgIHN1cGVyKGZyYW1lQ29udGV4dCk7XHJcbiAgICBpZiAoIWxhbmd1YWdlU2VydmljZSkge1xyXG4gICAgICB0aGlzLmxhbmd1YWdlU2VydmljZSA9IExhbmd1YWdlU2VydmljZS5nZXRJbnN0YW5jZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXQgbWVzc2FnZVBpcGUoKSB7XHJcbiAgICBpZiAodGhpcy52aWV3TW9kZWwgJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuZ2V0Rm9ybUFwcENvbnRleHQoKSB8fCBudWxsO1xyXG4gICAgICBpZiAoYXBwQ29udGV4dCkge1xyXG4gICAgICAgIHJldHVybiBhcHBDb250ZXh0Lm1lc3NhZ2VQaXBlIHx8IG51bGw7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5paw5aKe5a2Q6KGo5ZCM57qnXHJcbiAgICovXHJcbiAgcHVibGljIGFkZFN1YlNpYmxpbmcoKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmICh0aGlzLm1lc3NhZ2VQaXBlKSB7XHJcbiAgICAgIHRoaXMubWVzc2FnZVBpcGUubmV4dCh7IG1lc3NhZ2VUeXBlOiAnYWRkU3ViU2libGluZycgfSk7XHJcbiAgICB9XHJcbiAgICBsZXQgcGFyYW1zOiB7IG5vZGVDb2Rlczogc3RyaW5nW10sIGlkczogc3RyaW5nW10gfSA9IHRoaXMuZ2V0UGFyYW1zKCk7XHJcbiAgICAvLyDojrflj5bliIbnuqfmlrnlvI9cclxuICAgIGNvbnN0IGhpZXJhcmNoeVR5cGU6IHN0cmluZyA9IHRoaXMuZ2V0SGllcmFyY2h5VHlwZSgpO1xyXG4gICAgLy8g5omn6KGM5Y+W5pWwXHJcbiAgICBjb25zdCBsb2FkaW5nVGltZXJJZCA9IHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvd0xvYWRpbmdXaXRoRGVsYXkoNTAwKTtcclxuICAgIGNvbnN0IHJlcG9zaXRvcnkgPSBUcmVlUmVwb3NpdG9yeUZhY3RvcnkuZ2V0SW5zdGFuY2UoaGllcmFyY2h5VHlwZSk7XHJcbiAgICBpZiAoIXJlcG9zaXRvcnkpIHtcclxuICAgICAgLy8g6ZSZ6K+v55qE5YiG57qn56CBXHJcbiAgICAgIHRocm93IG5ldyBFcnJvcih0aGlzLmxhbmd1YWdlU2VydmljZVsnZXJyb3JIaWVyYXJjaHlLZXknXSk7XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXN1bHQkID0gcmVwb3NpdG9yeS5hZGRTdWJTaWJsaW5nKHRoaXMucmVwb3NpdG9yeSwgcGFyYW1zLm5vZGVDb2RlcywgcGFyYW1zLmlkcyk7XHJcbiAgICByZXR1cm4gcmVzdWx0JC5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGVycm9yID0+IHtcclxuICAgICAgICAgIHRoaXMuZXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5hZGRTdWJTaWJsaW5nRmFpbGVkLCBlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5paw5aKe5LiL57qnXHJcbiAgICovXHJcbiAgcHVibGljIGFkZFN1YkNoaWxkKCk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBpZiAodGhpcy5tZXNzYWdlUGlwZSkge1xyXG4gICAgICB0aGlzLm1lc3NhZ2VQaXBlLm5leHQoeyBtZXNzYWdlVHlwZTogJ2FkZFN1YkNoaWxkJyB9KTtcclxuICAgIH1cclxuICAgIGxldCBwYXJhbXM6IHsgbm9kZUNvZGVzOiBzdHJpbmdbXSwgaWRzOiBzdHJpbmdbXSB9ID0gdGhpcy5nZXRQYXJhbXMoKTtcclxuICAgIC8vIOiOt+WPluWIhue6p+aWueW8j1xyXG4gICAgY29uc3QgaGllcmFyY2h5VHlwZSA9IHRoaXMuZ2V0SGllcmFyY2h5VHlwZSgpO1xyXG5cclxuICAgIGNvbnN0IGN1cnJlbnRMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEgJiYgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0TGlzdCgpO1xyXG4gICAgaWYgKCFjdXJyZW50TGlzdFsnY3VycmVudElkJ10pIHtcclxuICAgICAgLy8g6K+36YCJ5oup54i26IqC54K5XHJcbiAgICAgIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZVsncGxzU2VsZWN0UGFyZW50Tm9kZSddLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgLy8g5omn6KGM5Y+W5pWwXHJcbiAgICBjb25zdCBsb2FkaW5nVGltZXJJZCA9IHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvd0xvYWRpbmdXaXRoRGVsYXkoNTAwKTtcclxuXHJcbiAgICBjb25zdCByZXBvc2l0b3J5ID0gVHJlZVJlcG9zaXRvcnlGYWN0b3J5LmdldEluc3RhbmNlKGhpZXJhcmNoeVR5cGUpO1xyXG4gICAgaWYgKCFyZXBvc2l0b3J5KSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcih0aGlzLmxhbmd1YWdlU2VydmljZVsnZXJyb3JIaWVyYXJjaHlLZXknXSk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBhZGRTdWJDaGlsZCQgPSByZXBvc2l0b3J5LmFkZFN1YkNoaWxkKHRoaXMucmVwb3NpdG9yeSwgcGFyYW1zLm5vZGVDb2RlcywgcGFyYW1zLmlkcyk7XHJcbiAgICBjb25zdCByZXN1bHQkID0gYWRkU3ViQ2hpbGQkLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXJyb3IgPT4ge1xyXG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcclxuICAgICAgICAgIHRoaXMuZXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5hZGRTdWJDaGlsZEZhaWxlZCwgZXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICAgIHJldHVybiByZXN1bHQkO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDliKDpmaTlrZDooajmoJHoioLngrlcclxuICAgKiBAcGFyYW0gaWQgaWRcclxuICAgKi9cclxuICBwdWJsaWMgcmVtb3ZlKGlkOiBzdHJpbmcsIHN1Y2Nlc3NNc2c/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgLy8g5Y+C5pWw5qOA5p+lXHJcbiAgICBpZiAoIWlkKSB7XHJcbiAgICAgIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZVsncGxzU2VsZWN0RGVsZXRlRGF0YSddLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgLy8g6I635Y+W5YiG57qn5pa55byPXHJcbiAgICBjb25zdCBoaWVyYXJjaHlUeXBlID0gdGhpcy5nZXRIaWVyYXJjaHlUeXBlKCk7XHJcbiAgICAvLyDmnInlrZDoioLngrnml7bkuI3lhYHorrjliKDpmaRcclxuICAgIGNvbnN0IHRyZWVOb2Rlc0RhdGEgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRMaXN0KCkudG9KU09OKCk7XHJcbiAgICBjb25zdCBiaW5kaW5nTGlzdCA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldExpc3QoKTtcclxuICAgIGNvbnN0IHRyZWVOb2RlVXRpbCA9IFRyZWVVdGlsRmFjdG9yeS5nZXRJbnN0YW5jZShoaWVyYXJjaHlUeXBlKTtcclxuICAgIGlmICh0cmVlTm9kZVV0aWwgPT09IG51bGwpIHtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgaWYgKHRyZWVOb2RlVXRpbC5oYXNDaGlsZE5vZGVzKHRyZWVOb2Rlc0RhdGEsIHRoaXMuaGllcmFyY2h5SW5mb0ZpZWxkLCBpZCkgPT09IHRydWUpIHtcclxuICAgICAgdGhpcy5tZXNzYWdlU2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlWydkZWxldGVDaGlsZEZpcnN0J10pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcbiAgICAvLyDnoa7orqTliKDpmaRcclxuICAgIGNvbnN0IGFjdGlvbiQgPSB0aGlzLm1lc3NhZ2VTZXJ2aWNlLnF1ZXN0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNvbmZpcm1EZWxldGlvbik7XHJcbiAgICByZXR1cm4gYWN0aW9uJC5waXBlKFxyXG4gICAgICBjb25jYXRNYXAocmVzdWx0ID0+IHtcclxuICAgICAgICBpZiAoIXJlc3VsdCkge1xyXG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDojrflj5bliKDpmaTlkI7opoHorr7nva7nmoToioLngrlpZFxyXG4gICAgICAgIGNvbnN0IG5leHROb2RlSWQgPSB0cmVlTm9kZVV0aWwuZ2V0TmV4dE5vZGVJZCh0cmVlTm9kZXNEYXRhLCB0aGlzLmhpZXJhcmNoeUluZm9GaWVsZCwgaWQpO1xyXG5cclxuICAgICAgICAvLyDmiafooYzliKDpmaRcclxuICAgICAgICBjb25zdCBsb2FkaW5nVGltZXJJZCA9IHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xyXG4gICAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmdldFBhdGgoKTtcclxuICAgICAgICBjb25zdCByZW1vdmUkID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5yZW1vdmVCeVBhdGgocGF0aCwgaWQpO1xyXG4gICAgICAgIHJldHVybiByZW1vdmUkLnBpcGUoXHJcbiAgICAgICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgICAgICAvLyDorr7nva7pgInkuK3oioLngrlcclxuICAgICAgICAgICAgdHJlZU5vZGVVdGlsLnNlbGVjdE5vZGVCeUJpbmRpbmdMaXN0KGJpbmRpbmdMaXN0LCB0aGlzLmhpZXJhcmNoeUluZm9GaWVsZCwgbmV4dE5vZGVJZCk7XHJcbiAgICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XHJcbiAgICAgICAgICAgIGlmIChzdWNjZXNzTXNnICYmIHN1Y2Nlc3NNc2cudHJpbSgpKSB7XHJcbiAgICAgICAgICAgICAgbGV0IHNob3dNZXNzYWdlOiBib29sZWFuID0gdHJ1ZTtcclxuICAgICAgICAgICAgICBpZiAoc3VjY2Vzc01zZy5zdGFydHNXaXRoKCd7JykgJiYgc3VjY2Vzc01zZy5lbmRzV2l0aCgnfScpKSB7XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICBjb25zdCBvcHRpb25zID0gSlNPTi5wYXJzZShzdWNjZXNzTXNnKTtcclxuICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuc2hvd01lc3NhZ2UgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2hvd01lc3NhZ2UgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBjYXRjaCB7IH1cclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgaWYgKHNob3dNZXNzYWdlICE9PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS5zdWNjZXNzKHN1Y2Nlc3NNc2csIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLnN1Y2Nlc3ModGhpcy5sYW5ndWFnZVNlcnZpY2UuZGVsZXRlU3VjY2VzcywgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gdGhpcy5mb3JtTm90aWZ5U2VydmljZS5zdWNjZXNzKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmRlbGV0ZVN1Y2Nlc3MsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgICAgZXJyb3IgPT4ge1xyXG4gICAgICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XHJcbiAgICAgICAgICAgICAgdGhpcy5lcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmRlbGV0ZUZhaWxlZCwgZXJyb3IpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICApXHJcbiAgICAgICAgKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEhpZXJhcmNoeVR5cGUoKSB7XHJcbiAgICBjb25zdCBwcm9wSW5mbyA9IHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mby5nZXRQcm9wSW5mb0J5UGF0aCh0aGlzLmhpZXJhcmNoeUluZm9LZXkuc3BsaXQoJy8nKSk7XHJcbiAgICBsZXQgaGllcmFyY2h5VHlwZSA9IHByb3BJbmZvLm1ldGFkYXRhSW5mb1snaGllcmFyY2h5VHlwZSddIHx8IG51bGw7XHJcbiAgICBpZiAoaGllcmFyY2h5VHlwZSA9PSBudWxsIHx8IGhpZXJhcmNoeVR5cGUubGVuZ3RoIDwgMSkge1xyXG4gICAgICAvLyAn5YiG57qn56CB6YWN572u5L+h5oGv6ZSZ6K+vJ1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IodGhpcy5sYW5ndWFnZVNlcnZpY2VbJ2luY29ycmVjdEhpZXJhcmNoeUNvbmZpZyddKTtcclxuICAgIH1cclxuICAgIHJldHVybiBoaWVyYXJjaHlUeXBlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5Y+C5pWwXHJcbiAgICogL3BhcmVudElkL2NoaWxkQ29kZXMvY2hpbGRJZC9ncmFuZHNvbkNvZGVzXHJcbiAgICogW2NoaWxkQ29kZXMsIGdyYW5kc29uQ29kZXNdXHJcbiAgICogW3Bhcm50SWQsIGNoaWxkSWRdXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRQYXJhbXMoKTogeyBub2RlQ29kZXM6IHN0cmluZ1tdLCBpZHM6IHN0cmluZ1tdIH0ge1xyXG4gICAgbGV0IG5vZGVDb2RlcyA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoLnN1YnN0cigxKS5zcGxpdCgnLycpO1xyXG4gICAgbGV0IGlkcyA9IFtdO1xyXG4gICAgbGV0IG5vZGVDb2RlQXJyYXkgPSBbXTtcclxuICAgIGNvbnN0IHJpZCA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkOyAvLyByb2906KGo5pWw5o2uaWRcclxuICAgIGlkcy5wdXNoKHJpZCk7XHJcbiAgICBsZXQgc3ViRGF0YTogYW55ID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGE7XHJcbiAgICBpZiAobm9kZUNvZGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgbm9kZUNvZGVzLm1hcChub2RlQ29kZSA9PiB7XHJcbiAgICAgICAgc3ViRGF0YSA9IHN1YkRhdGFbbm9kZUNvZGVdO1xyXG4gICAgICAgIGlmIChzdWJEYXRhICYmIHN1YkRhdGEuY3VycmVudElkKSB7XHJcbiAgICAgICAgICBpZHMucHVzaChzdWJEYXRhLmN1cnJlbnRJZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8v5Y676Zmkbm9kZUNvZGXnmoRzXHJcbiAgICAgICAgbm9kZUNvZGUgPyBub2RlQ29kZUFycmF5LnB1c2gobm9kZUNvZGUuc3Vic3RyaW5nKDAsIG5vZGVDb2RlLmxlbmd0aCAtIDEpKSA6IG5vZGVDb2RlQXJyYXkucHVzaChub2RlQ29kZSk7XHJcbiAgICAgIH0pXHJcbiAgICB9XHJcbiAgICByZXR1cm4geyBub2RlQ29kZXM6IG5vZGVDb2RlQXJyYXksIGlkczogaWRzIH07XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWujOaVtOi3r+W+hFxyXG4gICAqIGZpeGVkIGJ5IGp1c3Rpbjog5qC55o2uYmluZGluZ1BhdGjvvIzlpoLmnpzmmK/ku47ku47ooajvvIzpnIDopoHojrflj5bkuLvooajmlbDmja5pZOWSjOS7juihqOaVsOaNrmlkXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRQYXRoKCk6IHN0cmluZyB7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoO1xyXG4gICAgY29uc3QgcmlkID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7IC8vIHJvb3TooajmlbDmja5pZFxyXG4gICAgbGV0IHBhdGggPSAnLycgKyByaWQ7XHJcblxyXG4gICAgY29uc3Qgc3ViUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgaWYgKHN1YlBhdGhzLmxlbmd0aCA+IDApIHtcclxuICAgICAgLy8gZWc6YmluZGluZ1BhdGjlvaLlpoIvZWR1cy9ncmFkZXMsc3BsaXTlkI7mmK9bJ2VkdXMnLCAnZ3JhZGVzJ11cclxuICAgICAgbGV0IHN1YkRhdGE6IGFueSA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhO1xyXG4gICAgICBmb3IgKGxldCBpbmRleCA9IDE7IGluZGV4IDwgc3ViUGF0aHMubGVuZ3RoIC0gMTsgaW5kZXgrKykge1xyXG4gICAgICAgIGNvbnN0IHN1YlBhdGggPSBzdWJQYXRoc1tpbmRleF07XHJcbiAgICAgICAgc3ViRGF0YSA9IHN1YkRhdGFbc3ViUGF0aF07XHJcbiAgICAgICAgaWYgKCFzdWJEYXRhIHx8ICFzdWJEYXRhLmN1cnJlbnRJZCkge1xyXG4gICAgICAgICAgdGhyb3cgRXJyb3IoYOiOt+WPluWtkOihqOWujOaVtOi3r+W+hOWHuumUme+8jOaJvuS4jeWIsCR7c3ViRGF0YX3lr7nlupTnmoTlrZDooajvvIzmiJblr7nlupTlrZDooajmsqHmnInlvZPliY3ooYzjgIJgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcGF0aCArPSBgLyR7c3ViUGF0aH0vJHtzdWJEYXRhLmN1cnJlbnRJZH1gO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBwYXRoICs9ICcvJyArIHN1YlBhdGhzW3N1YlBhdGhzLmxlbmd0aCAtIDFdO1xyXG5cclxuICAgIHJldHVybiBwYXRoO1xyXG4gIH1cclxufVxyXG5leHBvcnQgeyBTdWJUcmVlRGF0YVNlcnZpY2UgfTtcclxuIl19