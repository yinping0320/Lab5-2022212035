import { HttpHeaders } from '@angular/common/http';
import { of } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { FieldMetadataUtil } from '@farris/devkit';
/**
 * 父子树仓库
 */
var ParentTreeRepository = /** @class */ (function () {
    function ParentTreeRepository() {
    }
    /**
     * 添加兄弟节点
     */
    ParentTreeRepository.prototype.addSibling = function (repository, id) {
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var addSiblingUri = baseUri + "/service/parenthierarchycreatesibling";
        var body = {
            dataID: id,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSiblingUri, 'PUT', null, options).pipe(map(function (responseInfo) {
            var entity = repository.buildEntity(responseInfo.returnValue);
            repository.entityCollection.addEntity(entity);
            return entity;
        }));
    };
    /**
     * 添加兄弟节点
     */
    ParentTreeRepository.prototype.addChild = function (repository, parentId) {
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var addChildUri = baseUri + "/service/parenthierarchycreatechildlayer";
        var body = {
            dataID: parentId,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addChildUri, 'PUT', null, options).pipe(map(function (responseInfo) {
            var entity = repository.buildEntity(responseInfo.returnValue);
            repository.entityCollection.addEntity(entity);
            return entity;
        }));
    };
    /**
     * 添加子表兄弟节点
     */
    ParentTreeRepository.prototype.addSubSibling = function (repository, nodes, ids) {
        var _this = this;
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var addSubSiblingUri = baseUri + "/service/childnodeparenthierarchycreatesibling";
        var body = {
            nodes: nodes,
            ids: ids,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSubSiblingUri, 'PUT', null, options).pipe(map(function (responseInfo) {
            var path = _this.getPaths(nodes, ids);
            var entity = repository.entityManager.appendEntityByPath(path, responseInfo.returnValue);
            return entity;
        }));
    };
    /**
     * 添加子表子节点
     */
    ParentTreeRepository.prototype.addSubChild = function (repository, nodes, ids) {
        var _this = this;
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var addSubChildUri = baseUri + "/service/childnodeparenthierarchycreatechildlayer";
        var body = {
            nodes: nodes,
            ids: ids,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSubChildUri, 'PUT', null, options).pipe(map(function (responseInfo) {
            var paths = _this.getPaths(nodes, ids);
            var entity = repository.entityManager.appendEntityByPath(paths, responseInfo.returnValue);
            return entity;
        }));
    };
    ParentTreeRepository.prototype.getPaths = function (nodes, ids) {
        var paths = '';
        if (nodes && nodes.length > 0 && ids && ids.length > 0) {
            for (var i = 0; i < ids.length; i++) {
                if (nodes[i]) {
                    paths = paths + ("/" + ids[i]);
                    paths = paths + ("/" + nodes[i] + "s");
                }
            }
        }
        return paths;
    };
    /**
     * 加载父节点
     */
    // tslint:disable-next-line: max-line-length
    ParentTreeRepository.prototype.loadByParentId = function (repository, hierarchyInfoKey, parentId, filters, sorts, frozenCurrentRow, pagination, frameContext, reload) {
        var _this = this;
        if (frozenCurrentRow === void 0) { frozenCurrentRow = false; }
        if (reload === void 0) { reload = false; }
        var localEntities = this.getChildren(repository, hierarchyInfoKey, parentId);
        if (localEntities && localEntities.length > 0 && !reload) {
            return of(localEntities);
        }
        var restService = repository.restService;
        var parentHierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, parentId);
        var originalHierarchyInfoKey = this.getOriginalHierarchyInfoKey(repository, hierarchyInfoKey);
        var filtersWithParent = this.buildFiltersWithParent(originalHierarchyInfoKey, parentHierarchyInfo, filters);
        var isUsePagination = pagination && pagination.pageSize > 0 || false;
        // 组织EntityFilter
        var entityFilter = {
            FilterConditions: filtersWithParent,
            SortConditions: sorts,
            IsUsePagination: isUsePagination,
            Pagination: { PageIndex: pagination && pagination.pageIndex || 0, PageSize: pagination && pagination.pageSize || 0, PageCount: 0, TotalCount: 0 }
        };
        var requestInfo = restService.buildRequestInfo();
        return restService.extendQuery(entityFilter, requestInfo).pipe(map(function (responseInfo) {
            var paginationInfo = _this.getPaginationInfo(responseInfo);
            if (parentId) {
                if (paginationInfo && paginationInfo.pageSize !== 0 && frameContext) {
                    frameContext.params.set("_NODE_" + parentId + "_PAGINATION_INFO_", paginationInfo);
                }
            }
            else {
                if (paginationInfo && paginationInfo.pageSize !== 0 && frameContext) {
                    frameContext.repository.entityCollection.updatePaginationInfoByPath('/', paginationInfo);
                }
            }
            // 先清空下级实体
            _this.clearDescendantEntities(repository, hierarchyInfoKey, parentHierarchyInfo, frozenCurrentRow);
            // 追加下级实体
            var listData = responseInfo.returnValue.result;
            var entities = repository.buildEntities(listData);
            if (frozenCurrentRow) {
                repository.entityCollection.addData(entities, { isTreeNodeLoadScene: true });
            }
            else {
                repository.entityCollection.addEntities(entities, { isTreeNodeLoadScene: true });
            }
            return entities;
        }));
    };
    // tslint:disable-next-line: max-line-length
    ParentTreeRepository.prototype.loadFullTree = function (repository, hierarchyInfoKey, parentId, propertyName, fullTreeType, loadType, filters, context) {
        var _this = this;
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var queryUrl = baseUri + "/service/parentidfulltreequery";
        var parentHierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, parentId);
        var entityFilter = this.buildEntityFilter(filters, null, 0, 0);
        var body = {
            dataId: parentId || '',
            isUsePagination: false,
            virtualPropertyName: propertyName,
            pagination: {},
            fullTreeType: fullTreeType,
            loadType: loadType,
            filter: entityFilter,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            body: body
        };
        return restService.invoke(queryUrl, 'PUT', null, options).pipe(tap(function (responseInfo) {
            // 保存展开的节点
            if (responseInfo.returnValue && responseInfo.returnValue.selectedRowId && context && context.frameContext) {
                var frameContext = context.frameContext;
                var virtualRootFrameContext = frameContext && frameContext.getVirtualRootFrameContext() || null;
                if (virtualRootFrameContext) {
                    var list = responseInfo.returnValue.result;
                    var selectedRowId_1 = responseInfo.returnValue.selectedRowId;
                    // 从顶层开始计算所有需要展开的节点
                    var leafNodeInfo = list.find(function (item) { return item[repository.primaryKey] === selectedRowId_1; });
                    var hierarchyInfo = leafNodeInfo[hierarchyInfoKey];
                    var ids = _this.getAllParentIds(hierarchyInfo, list, hierarchyInfoKey, repository);
                    virtualRootFrameContext.params.set('_DEVKIT_expandRowIds', ids.join(','));
                    virtualRootFrameContext.params.set('_DEVKIT_selectedRowId', selectedRowId_1);
                    virtualRootFrameContext.uiState.setPropertyValue('__DEVKIT__selectedRow', selectedRowId_1);
                }
            }
        }), map(function (responseInfo) {
            var frozenCurrentRow = context && context.frozenCurrentRow || false;
            // 先清空下级实体
            _this.clearDescendantEntities(repository, hierarchyInfoKey, parentHierarchyInfo, frozenCurrentRow);
            // 追加下级实体
            var listData = responseInfo.returnValue.result;
            var entities = repository.buildEntities(listData);
            if (frozenCurrentRow) {
                repository.entityCollection.addData(entities, { isTreeNodeLoadScene: true });
            }
            else {
                repository.entityCollection.addEntities(entities, { isTreeNodeLoadScene: true });
            }
            return entities;
        }));
    };
    /**
     * 插入对父节点的过滤
     */
    ParentTreeRepository.prototype.buildFiltersWithParent = function (originalHierarchyInfoKey, parentHierarchyInfo, filterArray) {
        var relationType = filterArray && filterArray.length >= 1 ? 1 : 0;
        var parentLayer = parentHierarchyInfo ? parentHierarchyInfo['layer'] : 0;
        var parentElement = parentHierarchyInfo ? parentHierarchyInfo['id'] : '';
        var parentFilterArray = [
            {
                "FilterField": originalHierarchyInfoKey + ".Layer",
                "Value": parentLayer + 1,
                "Lbracket": null,
                "Rbracket": null,
                "Relation": 1,
                "Expresstype": 0,
                "Compare": 0
            }
        ];
        if (parentElement) {
            parentFilterArray.push({
                "FilterField": originalHierarchyInfoKey + ".ParentElement",
                "Value": parentElement,
                "Lbracket": null,
                "Rbracket": null,
                "Relation": relationType,
                "Expresstype": 0,
                "Compare": 0
            });
        }
        else {
            parentFilterArray[0].Relation = relationType;
        }
        return parentFilterArray.concat(filterArray);
    };
    ParentTreeRepository.prototype.buildEntityFilter = function (filter, sort, pageSize, pageIndex) {
        // @todo：临时兼容老代码，降低改动带来的风险
        if (!filter && !sort && !pageSize && !pageIndex) {
            return null;
        }
        if (!filter) {
            filter = [];
        }
        if (!sort) {
            sort = [];
        }
        // 纠正最后一个过滤条件的Relation
        if (filter && filter.length > 0) {
            filter[filter.length - 1].Relation = 0;
        }
        var entityFilter = {
            FilterConditions: filter,
            SortConditions: sort,
            IsUsePagination: pageSize === 0 ? false : true,
            Pagination: {
                PageIndex: pageIndex,
                PageSize: pageSize,
                PageCount: 0,
                TotalCount: 0
            }
        };
        return entityFilter;
    };
    /**
     * 清空后代实体
     * @description parentHierarchyInfo中layer为要清空后代节点的layer，但里面的parentElement不是父级的id，而是要清空后代节点的id
     */
    ParentTreeRepository.prototype.clearDescendantEntities = function (repository, hierarchyInfokey, parentHierarchyInfo, frozenCurrentRow) {
        if (frozenCurrentRow === void 0) { frozenCurrentRow = false; }
        // 清空根节点
        if (!parentHierarchyInfo) {
            repository.entityCollection.clear();
            return;
        }
        var nodes = this.getChildNodes(repository, hierarchyInfokey, parentHierarchyInfo);
        if (frozenCurrentRow) {
            repository.entityCollection.removeEntities(function (entity) {
                var id = entity[entity.primaryKey];
                return nodes.includes(id);
            });
        }
        else {
            repository.entityCollection.removeData(function (entity) {
                var id = entity[entity.primaryKey];
                return nodes.includes(id);
            });
        }
    };
    /**
     * 获取某个节点的所有子节点
     * @param repository repository
     * @param hierarchyInfokey hierarchyInfokey
     * @param parentHierarchyInfo parentHierarchyInfo
     */
    ParentTreeRepository.prototype.getChildNodes = function (repository, hierarchyInfokey, parentHierarchyInfo) {
        var _this = this;
        var fparentElement = parentHierarchyInfo.id;
        var flayer = parentHierarchyInfo.layer;
        var nodes = [];
        repository.entityCollection.getAllEntities().forEach(function (entity) {
            var hierarchyInfo = entity[hierarchyInfokey];
            var parentElement = hierarchyInfo.parentElement;
            var layer = hierarchyInfo.layer;
            var result = layer >= (flayer + 1) && parentElement === fparentElement;
            if (result) {
                var id = entity[entity.primaryKey];
                nodes.push(id);
                var childHierarchyInfo = _this.getHierarchyInfoById(repository, hierarchyInfokey, id);
                var childs = _this.getChildNodes(repository, hierarchyInfokey, childHierarchyInfo);
                if (childs && childs.length > 0) {
                    nodes = nodes.concat(childs);
                }
            }
        });
        return nodes;
    };
    /**
     * 获取实体的分级信息
     */
    ParentTreeRepository.prototype.getHierarchyInfoById = function (repository, hierarchyInfokey, id) {
        if (!id) {
            return null;
        }
        var entity = repository.entityCollection.getEntityById(id);
        var hierarchyInfoEntity = entity[hierarchyInfokey];
        var result = hierarchyInfoEntity.toJSON();
        result['id'] = id;
        return result;
    };
    ParentTreeRepository.prototype.getHierarchyInfo = function (entity, hierarchyInfokey) {
        return entity[hierarchyInfokey];
    };
    /**
     * 获取分级码的原始的字段名
     */
    ParentTreeRepository.prototype.getOriginalHierarchyInfoKey = function (repository, hierarchyInfokey) {
        var ngObjects = FieldMetadataUtil.getNgObjects(repository.entityType);
        var hierarchyInfoNgObject = ngObjects[hierarchyInfokey];
        return hierarchyInfoNgObject.originalDataField;
    };
    ParentTreeRepository.prototype.getPaginationInfo = function (responseInfo) {
        return responseInfo && responseInfo.returnValue && responseInfo.returnValue.pagination || null;
    };
    ParentTreeRepository.prototype.findParent = function (hierarchyInfo, list, hierarchyInfoKey) {
        return list.find(function (item) {
            var currentHierarchyInfo = item[hierarchyInfoKey];
            return currentHierarchyInfo.layer === hierarchyInfo.layer - 1 && hierarchyInfo.parentElement === currentHierarchyInfo.parentElement;
        });
    };
    ParentTreeRepository.prototype.getAllParentIds = function (hierarchyInfo, list, hierarchyInfoKey, repository) {
        var item = this.findParent(hierarchyInfo, list, hierarchyInfoKey);
        var ids = [];
        while (item) {
            ids.push(item[repository.primaryKey]);
            item = this.findParent(item[hierarchyInfoKey], list, hierarchyInfoKey);
        }
        return ids;
    };
    /**
     * 查找节点下所有子级（第一级）
     * @param repository repository
     * @param hierarchyInfoKey 分级码字段
     * @param id id
     * @returns
     */
    ParentTreeRepository.prototype.getChildren = function (repository, hierarchyInfoKey, id) {
        var _this = this;
        var hierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, id);
        if (!hierarchyInfo) {
            return null;
        }
        var layer = hierarchyInfo.layer;
        var parentElement = hierarchyInfo.parentElement;
        var entities = repository.entityCollection.getEntities(function (entity) {
            var hierarchyInfo = _this.getHierarchyInfo(entity, hierarchyInfoKey);
            var matched = hierarchyInfo.layer === layer + 1 && (hierarchyInfo.parentElement === parentElement || !parentElement && !hierarchyInfo.parentElement);
            if (matched) {
                return entity;
            }
            else {
                return null;
            }
        });
        return entities;
    };
    return ParentTreeRepository;
}());
export { ParentTreeRepository };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyZW50LXRyZWUtcmVwb3NpdG9yeS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9kYXRhLXNlcnZpY2VzL3RyZWUtdGFibGUvcmVwb3NpdG9yeS9wYXJlbnQtdHJlZS1yZXBvc2l0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNuRCxPQUFPLEVBQUUsRUFBRSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUMsT0FBTyxFQUFVLGlCQUFpQixFQUE0QixNQUFNLGdCQUFnQixDQUFDO0FBR3JGOztHQUVHO0FBQ0g7SUFBQTtJQWtaQSxDQUFDO0lBaFpDOztPQUVHO0lBQ0kseUNBQVUsR0FBakIsVUFBa0IsVUFBaUMsRUFBRSxFQUFVO1FBQzdELElBQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUM7UUFDM0MsSUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUNwQyxJQUFNLGFBQWEsR0FBTSxPQUFPLDBDQUF1QyxDQUFDO1FBQ3hFLElBQU0sSUFBSSxHQUFHO1lBQ1gsTUFBTSxFQUFFLEVBQUU7WUFDVixXQUFXLEVBQUUsV0FBVyxDQUFDLGdCQUFnQixFQUFFO1NBQzVDLENBQUM7UUFDRixJQUFNLE9BQU8sR0FBRztZQUNkLE9BQU8sRUFBRSxJQUFJLFdBQVcsQ0FBQyxFQUFFLGNBQWMsRUFBRSxrQkFBa0IsRUFBRSxDQUFDO1lBQ2hFLElBQUksRUFBRSxJQUFJO1NBQ1gsQ0FBQztRQUNGLE9BQU8sV0FBVyxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQ2pFLEdBQUcsQ0FBQyxVQUFDLFlBQTBCO1lBQzdCLElB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aUJDO1FBaEJDLElBQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDbEYsSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUNsQixPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsSUFBTSxLQUFLLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQztRQUNsQyxJQUFNLGFBQWEsR0FBRyxhQUFhLENBQUMsYUFBYSxDQUFDO1FBQ2xELElBQU0sUUFBUSxHQUFhLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsVUFBQyxNQUFjO1lBQ2hGLElBQU0sYUFBYSxHQUFHLEtBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztZQUN0RSxJQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsS0FBSyxLQUFLLEtBQUssR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsYUFBYSxLQUFLLGFBQWEsSUFBSSxDQUFDLGFBQWEsSUFBSSxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUN2SixJQUFJLE9BQU8sRUFBRTtnQkFDWCxPQUFPLE1BQU0sQ0FBQzthQUNmO2lCQUFNO2dCQUNMLE9BQU8sSUFBSSxDQUFDO2FBQ2I7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFDSCwyQkFBQztBQUFELENBQUMsQUFsWkQsSUFrWkM7QUFFRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBIZWFkZXJzIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBvZiwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBtYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgRW50aXR5LCBGaWVsZE1ldGFkYXRhVXRpbCwgRnJhbWVDb250ZXh0LCBSZXBvc2l0b3J5IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBSZXNwb25zZUluZm8sIEJlZlJlcG9zaXRvcnkgfSBmcm9tICdAZmFycmlzL2JlZic7XHJcblxyXG4vKipcclxuICog54i25a2Q5qCR5LuT5bqTXHJcbiAqL1xyXG5jbGFzcyBQYXJlbnRUcmVlUmVwb3NpdG9yeSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOWFhOW8n+iKgueCuVxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZGRTaWJsaW5nKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8RW50aXR5PiB7XHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XHJcbiAgICBjb25zdCBiYXNlVXJpID0gcmVzdFNlcnZpY2UuYmFzZVVyaTtcclxuICAgIGNvbnN0IGFkZFNpYmxpbmdVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL3BhcmVudGhpZXJhcmNoeWNyZWF0ZXNpYmxpbmdgO1xyXG4gICAgY29uc3QgYm9keSA9IHtcclxuICAgICAgZGF0YUlEOiBpZCxcclxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxyXG4gICAgfTtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgIGhlYWRlcnM6IG5ldyBIdHRwSGVhZGVycyh7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSksXHJcbiAgICAgIGJvZHk6IGJvZHlcclxuICAgIH07XHJcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKGFkZFNpYmxpbmdVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxyXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZW50aXR5ID0gcmVwb3NpdG9yeS5idWlsZEVudGl0eShyZXNwb25zZUluZm8ucmV0dXJuVmFsdWUpO1xyXG4gICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdHkoZW50aXR5KTtcclxuICAgICAgICByZXR1cm4gZW50aXR5O1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOWFhOW8n+iKgueCuVxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZGRDaGlsZChyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIHBhcmVudElkOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gcmVwb3NpdG9yeS5yZXN0U2VydmljZTtcclxuICAgIGNvbnN0IGJhc2VVcmkgPSByZXN0U2VydmljZS5iYXNlVXJpO1xyXG4gICAgY29uc3QgYWRkQ2hpbGRVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL3BhcmVudGhpZXJhcmNoeWNyZWF0ZWNoaWxkbGF5ZXJgO1xyXG5cclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgIGRhdGFJRDogcGFyZW50SWQsXHJcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcclxuICAgIH07XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBoZWFkZXJzOiBuZXcgSHR0cEhlYWRlcnMoeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0pLFxyXG4gICAgICBib2R5OiBib2R5XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZShhZGRDaGlsZFVyaSwgJ1BVVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXHJcbiAgICAgIG1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcclxuICAgICAgICBjb25zdCBlbnRpdHkgPSByZXBvc2l0b3J5LmJ1aWxkRW50aXR5KHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSk7XHJcbiAgICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmFkZEVudGl0eShlbnRpdHkpO1xyXG4gICAgICAgIHJldHVybiBlbnRpdHk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5re75Yqg5a2Q6KGo5YWE5byf6IqC54K5XHJcbiAgICovXHJcbiAgcHVibGljIGFkZFN1YlNpYmxpbmcocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBub2RlczogQXJyYXk8c3RyaW5nPiwgaWRzOiBBcnJheTxzdHJpbmc+KTogT2JzZXJ2YWJsZTxFbnRpdHk+IHtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gcmVwb3NpdG9yeS5yZXN0U2VydmljZTtcclxuICAgIGNvbnN0IGJhc2VVcmkgPSByZXN0U2VydmljZS5iYXNlVXJpO1xyXG4gICAgY29uc3QgYWRkU3ViU2libGluZ1VyaSA9IGAke2Jhc2VVcml9L3NlcnZpY2UvY2hpbGRub2RlcGFyZW50aGllcmFyY2h5Y3JlYXRlc2libGluZ2A7XHJcbiAgICBjb25zdCBib2R5ID0ge1xyXG4gICAgICBub2Rlczogbm9kZXMsXHJcbiAgICAgIGlkczogaWRzLFxyXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9KSxcclxuICAgICAgYm9keTogYm9keVxyXG4gICAgfTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UoYWRkU3ViU2libGluZ1VyaSwgJ1BVVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXHJcbiAgICAgIG1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcclxuICAgICAgICBsZXQgcGF0aCA9IHRoaXMuZ2V0UGF0aHMobm9kZXMsIGlkcyk7XHJcbiAgICAgICAgY29uc3QgZW50aXR5ID0gcmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLmFwcGVuZEVudGl0eUJ5UGF0aChwYXRoLCByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUpXHJcbiAgICAgICAgcmV0dXJuIGVudGl0eTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmt7vliqDlrZDooajlrZDoioLngrlcclxuICAgKi9cclxuICBwdWJsaWMgYWRkU3ViQ2hpbGQocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBub2RlczogQXJyYXk8c3RyaW5nPiwgaWRzOiBBcnJheTxzdHJpbmc+KSB7XHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XHJcbiAgICBjb25zdCBiYXNlVXJpID0gcmVzdFNlcnZpY2UuYmFzZVVyaTtcclxuICAgIGNvbnN0IGFkZFN1YkNoaWxkVXJpID0gYCR7YmFzZVVyaX0vc2VydmljZS9jaGlsZG5vZGVwYXJlbnRoaWVyYXJjaHljcmVhdGVjaGlsZGxheWVyYDtcclxuXHJcbiAgICBjb25zdCBib2R5ID0ge1xyXG4gICAgICBub2Rlczogbm9kZXMsXHJcbiAgICAgIGlkczogaWRzLFxyXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9KSxcclxuICAgICAgYm9keTogYm9keVxyXG4gICAgfTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UoYWRkU3ViQ2hpbGRVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxyXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgbGV0IHBhdGhzID0gdGhpcy5nZXRQYXRocyhub2RlcywgaWRzKTtcclxuICAgICAgICBjb25zdCBlbnRpdHkgPSByZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIuYXBwZW5kRW50aXR5QnlQYXRoKHBhdGhzLCByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUpO1xyXG4gICAgICAgIHJldHVybiBlbnRpdHk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRQYXRocyhub2Rlczogc3RyaW5nW10sIGlkczogc3RyaW5nW10pIHtcclxuICAgIGxldCBwYXRocyA9ICcnO1xyXG4gICAgaWYgKG5vZGVzICYmIG5vZGVzLmxlbmd0aCA+IDAgJiYgaWRzICYmIGlkcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaWRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgaWYgKG5vZGVzW2ldKSB7XHJcbiAgICAgICAgICBwYXRocyA9IHBhdGhzICsgYC8ke2lkc1tpXX1gO1xyXG4gICAgICAgICAgcGF0aHMgPSBwYXRocyArIGAvJHtub2Rlc1tpXX1zYDtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBwYXRocztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWKoOi9veeItuiKgueCuVxyXG4gICAqL1xyXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbWF4LWxpbmUtbGVuZ3RoXHJcbiAgcHVibGljIGxvYWRCeVBhcmVudElkKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCBwYXJlbnRJZDogc3RyaW5nLCBmaWx0ZXJzOiBhbnlbXSwgc29ydHM6IGFueVtdLCBmcm96ZW5DdXJyZW50Um93OiBib29sZWFuID0gZmFsc2UsIHBhZ2luYXRpb24/OiB7IHBhZ2VTaXplOiBudW1iZXIsIHBhZ2VJbmRleDogbnVtYmVyIH0sIGZyYW1lQ29udGV4dD86IEZyYW1lQ29udGV4dCwgcmVsb2FkOiBib29sZWFuID0gZmFsc2UpOiBPYnNlcnZhYmxlPEVudGl0eVtdPiB7XHJcbiAgICBjb25zdCBsb2NhbEVudGl0aWVzID0gdGhpcy5nZXRDaGlsZHJlbihyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZvS2V5LCBwYXJlbnRJZCk7XHJcbiAgICBpZiAobG9jYWxFbnRpdGllcyAmJiBsb2NhbEVudGl0aWVzLmxlbmd0aCA+IDAgJiYgIXJlbG9hZCkge1xyXG4gICAgICByZXR1cm4gb2YobG9jYWxFbnRpdGllcyk7XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XHJcbiAgICBjb25zdCBwYXJlbnRIaWVyYXJjaHlJbmZvID0gdGhpcy5nZXRIaWVyYXJjaHlJbmZvQnlJZChyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZvS2V5LCBwYXJlbnRJZCk7XHJcbiAgICBjb25zdCBvcmlnaW5hbEhpZXJhcmNoeUluZm9LZXkgPSB0aGlzLmdldE9yaWdpbmFsSGllcmFyY2h5SW5mb0tleShyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZvS2V5KTtcclxuICAgIGNvbnN0IGZpbHRlcnNXaXRoUGFyZW50ID0gdGhpcy5idWlsZEZpbHRlcnNXaXRoUGFyZW50KG9yaWdpbmFsSGllcmFyY2h5SW5mb0tleSwgcGFyZW50SGllcmFyY2h5SW5mbywgZmlsdGVycyk7XHJcbiAgICBjb25zdCBpc1VzZVBhZ2luYXRpb24gPSBwYWdpbmF0aW9uICYmIHBhZ2luYXRpb24ucGFnZVNpemUgPiAwIHx8IGZhbHNlO1xyXG4gICAgLy8g57uE57uHRW50aXR5RmlsdGVyXHJcbiAgICBjb25zdCBlbnRpdHlGaWx0ZXIgPSB7XHJcbiAgICAgIEZpbHRlckNvbmRpdGlvbnM6IGZpbHRlcnNXaXRoUGFyZW50LFxyXG4gICAgICBTb3J0Q29uZGl0aW9uczogc29ydHMsXHJcbiAgICAgIElzVXNlUGFnaW5hdGlvbjogaXNVc2VQYWdpbmF0aW9uLFxyXG4gICAgICBQYWdpbmF0aW9uOiB7IFBhZ2VJbmRleDogcGFnaW5hdGlvbiAmJiBwYWdpbmF0aW9uLnBhZ2VJbmRleCB8fCAwLCBQYWdlU2l6ZTogcGFnaW5hdGlvbiAmJiBwYWdpbmF0aW9uLnBhZ2VTaXplIHx8IDAsIFBhZ2VDb3VudDogMCwgVG90YWxDb3VudDogMCB9XHJcbiAgICB9O1xyXG4gICAgY29uc3QgcmVxdWVzdEluZm8gPSByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKCk7XHJcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuZXh0ZW5kUXVlcnkoZW50aXR5RmlsdGVyLCByZXF1ZXN0SW5mbykucGlwZShcclxuICAgICAgbWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xyXG4gICAgICAgIGNvbnN0IHBhZ2luYXRpb25JbmZvID0gdGhpcy5nZXRQYWdpbmF0aW9uSW5mbyhyZXNwb25zZUluZm8pO1xyXG4gICAgICAgIGlmIChwYXJlbnRJZCkge1xyXG4gICAgICAgICAgaWYgKHBhZ2luYXRpb25JbmZvICYmIHBhZ2luYXRpb25JbmZvLnBhZ2VTaXplICE9PSAwICYmIGZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgICAgICBmcmFtZUNvbnRleHQucGFyYW1zLnNldChgX05PREVfJHtwYXJlbnRJZH1fUEFHSU5BVElPTl9JTkZPX2AsIHBhZ2luYXRpb25JbmZvKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgaWYgKHBhZ2luYXRpb25JbmZvICYmIHBhZ2luYXRpb25JbmZvLnBhZ2VTaXplICE9PSAwICYmIGZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgICAgICBmcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLnVwZGF0ZVBhZ2luYXRpb25JbmZvQnlQYXRoKCcvJywgcGFnaW5hdGlvbkluZm8pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDlhYjmuIXnqbrkuIvnuqflrp7kvZNcclxuICAgICAgICB0aGlzLmNsZWFyRGVzY2VuZGFudEVudGl0aWVzKHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9LZXksIHBhcmVudEhpZXJhcmNoeUluZm8sIGZyb3plbkN1cnJlbnRSb3cpO1xyXG4gICAgICAgIC8vIOi/veWKoOS4i+e6p+WunuS9k1xyXG4gICAgICAgIGNvbnN0IGxpc3REYXRhID0gcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlLnJlc3VsdDtcclxuICAgICAgICBjb25zdCBlbnRpdGllcyA9IHJlcG9zaXRvcnkuYnVpbGRFbnRpdGllcyhsaXN0RGF0YSk7XHJcbiAgICAgICAgaWYgKGZyb3plbkN1cnJlbnRSb3cpIHtcclxuICAgICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGREYXRhKGVudGl0aWVzLCB7IGlzVHJlZU5vZGVMb2FkU2NlbmU6IHRydWUgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdGllcyhlbnRpdGllcywgeyBpc1RyZWVOb2RlTG9hZFNjZW5lOiB0cnVlIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZW50aXRpZXM7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1heC1saW5lLWxlbmd0aFxyXG4gIHB1YmxpYyBsb2FkRnVsbFRyZWUocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcsIHBhcmVudElkOiBzdHJpbmcsIHByb3BlcnR5TmFtZTogc3RyaW5nLCBmdWxsVHJlZVR5cGU6IHN0cmluZywgbG9hZFR5cGU6IHN0cmluZywgZmlsdGVycz86IGFueVtdLCBjb250ZXh0PzogYW55KTogT2JzZXJ2YWJsZTxFbnRpdHlbXT4ge1xyXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSByZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XHJcbiAgICBjb25zdCBxdWVyeVVybCA9IGAke2Jhc2VVcml9L3NlcnZpY2UvcGFyZW50aWRmdWxsdHJlZXF1ZXJ5YDtcclxuICAgIGNvbnN0IHBhcmVudEhpZXJhcmNoeUluZm8gPSB0aGlzLmdldEhpZXJhcmNoeUluZm9CeUlkKHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9LZXksIHBhcmVudElkKTtcclxuICAgIGNvbnN0IGVudGl0eUZpbHRlciA9IHRoaXMuYnVpbGRFbnRpdHlGaWx0ZXIoZmlsdGVycywgbnVsbCwgMCwgMCk7XHJcblxyXG4gICAgY29uc3QgYm9keSA9IHtcclxuICAgICAgZGF0YUlkOiBwYXJlbnRJZCB8fCAnJyxcclxuICAgICAgaXNVc2VQYWdpbmF0aW9uOiBmYWxzZSxcclxuICAgICAgdmlydHVhbFByb3BlcnR5TmFtZTogcHJvcGVydHlOYW1lLFxyXG4gICAgICBwYWdpbmF0aW9uOiB7fSxcclxuICAgICAgZnVsbFRyZWVUeXBlLFxyXG4gICAgICBsb2FkVHlwZSxcclxuICAgICAgZmlsdGVyOiBlbnRpdHlGaWx0ZXIsXHJcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcclxuICAgIH07XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBib2R5OiBib2R5XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZShxdWVyeVVybCwgJ1BVVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXHJcbiAgICAgIHRhcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcclxuICAgICAgICAvLyDkv53lrZjlsZXlvIDnmoToioLngrlcclxuICAgICAgICBpZiAocmVzcG9uc2VJbmZvLnJldHVyblZhbHVlICYmIHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZS5zZWxlY3RlZFJvd0lkICYmIGNvbnRleHQgJiYgY29udGV4dC5mcmFtZUNvbnRleHQpIHtcclxuICAgICAgICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IGNvbnRleHQuZnJhbWVDb250ZXh0IGFzIEZyYW1lQ29udGV4dDtcclxuICAgICAgICAgIGNvbnN0IHZpcnR1YWxSb290RnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpIHx8IG51bGw7XHJcbiAgICAgICAgICBpZiAodmlydHVhbFJvb3RGcmFtZUNvbnRleHQpIHtcclxuICAgICAgICAgICAgY29uc3QgbGlzdCA9IHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZS5yZXN1bHQgYXMgYW55W107XHJcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkUm93SWQgPSByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUuc2VsZWN0ZWRSb3dJZDtcclxuICAgICAgICAgICAgLy8g5LuO6aG25bGC5byA5aeL6K6h566X5omA5pyJ6ZyA6KaB5bGV5byA55qE6IqC54K5XHJcbiAgICAgICAgICAgIGNvbnN0IGxlYWZOb2RlSW5mbyA9IGxpc3QuZmluZChpdGVtID0+IGl0ZW1bcmVwb3NpdG9yeS5wcmltYXJ5S2V5XSA9PT0gc2VsZWN0ZWRSb3dJZCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGhpZXJhcmNoeUluZm8gPSBsZWFmTm9kZUluZm9baGllcmFyY2h5SW5mb0tleV0gYXMgeyBpc0RldGFpbDogYm9vbGVhbiwgbGF5ZXI6IG51bWJlciwgcGFyZW50RWxlbWVudDogc3RyaW5nIH07XHJcbiAgICAgICAgICAgIGNvbnN0IGlkcyA9IHRoaXMuZ2V0QWxsUGFyZW50SWRzKGhpZXJhcmNoeUluZm8sIGxpc3QsIGhpZXJhcmNoeUluZm9LZXksIHJlcG9zaXRvcnkpO1xyXG4gICAgICAgICAgICB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dC5wYXJhbXMuc2V0KCdfREVWS0lUX2V4cGFuZFJvd0lkcycsIGlkcy5qb2luKCcsJykpO1xyXG4gICAgICAgICAgICB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dC5wYXJhbXMuc2V0KCdfREVWS0lUX3NlbGVjdGVkUm93SWQnLCBzZWxlY3RlZFJvd0lkKTtcclxuICAgICAgICAgICAgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQudWlTdGF0ZS5zZXRQcm9wZXJ0eVZhbHVlKCdfX0RFVktJVF9fc2VsZWN0ZWRSb3cnLCBzZWxlY3RlZFJvd0lkKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pLFxyXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZnJvemVuQ3VycmVudFJvdyA9IGNvbnRleHQgJiYgY29udGV4dC5mcm96ZW5DdXJyZW50Um93IHx8IGZhbHNlO1xyXG4gICAgICAgIC8vIOWFiOa4heepuuS4i+e6p+WunuS9k1xyXG4gICAgICAgIHRoaXMuY2xlYXJEZXNjZW5kYW50RW50aXRpZXMocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSwgcGFyZW50SGllcmFyY2h5SW5mbywgZnJvemVuQ3VycmVudFJvdyk7XHJcbiAgICAgICAgLy8g6L+95Yqg5LiL57qn5a6e5L2TXHJcbiAgICAgICAgY29uc3QgbGlzdERhdGEgPSByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUucmVzdWx0O1xyXG4gICAgICAgIGNvbnN0IGVudGl0aWVzID0gcmVwb3NpdG9yeS5idWlsZEVudGl0aWVzKGxpc3REYXRhKTtcclxuICAgICAgICBpZiAoZnJvemVuQ3VycmVudFJvdykge1xyXG4gICAgICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmFkZERhdGEoZW50aXRpZXMsIHsgaXNUcmVlTm9kZUxvYWRTY2VuZTogdHJ1ZSB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmFkZEVudGl0aWVzKGVudGl0aWVzLCB7IGlzVHJlZU5vZGVMb2FkU2NlbmU6IHRydWUgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBlbnRpdGllcztcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaPkuWFpeWvueeItuiKgueCueeahOi/h+a7pFxyXG4gICAqL1xyXG4gIHB1YmxpYyBidWlsZEZpbHRlcnNXaXRoUGFyZW50KG9yaWdpbmFsSGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCBwYXJlbnRIaWVyYXJjaHlJbmZvOiBhbnksIGZpbHRlckFycmF5OiBhbnlbXSk6IGFueSB7XHJcbiAgICBjb25zdCByZWxhdGlvblR5cGUgPSBmaWx0ZXJBcnJheSAmJiBmaWx0ZXJBcnJheS5sZW5ndGggPj0gMSA/IDEgOiAwO1xyXG4gICAgY29uc3QgcGFyZW50TGF5ZXIgPSBwYXJlbnRIaWVyYXJjaHlJbmZvID8gcGFyZW50SGllcmFyY2h5SW5mb1snbGF5ZXInXSA6IDA7XHJcbiAgICBjb25zdCBwYXJlbnRFbGVtZW50ID0gcGFyZW50SGllcmFyY2h5SW5mbyA/IHBhcmVudEhpZXJhcmNoeUluZm9bJ2lkJ10gOiAnJztcclxuXHJcbiAgICBjb25zdCBwYXJlbnRGaWx0ZXJBcnJheSA9IFtcclxuICAgICAge1xyXG4gICAgICAgIFwiRmlsdGVyRmllbGRcIjogYCR7b3JpZ2luYWxIaWVyYXJjaHlJbmZvS2V5fS5MYXllcmAsXHJcbiAgICAgICAgXCJWYWx1ZVwiOiBwYXJlbnRMYXllciArIDEsXHJcbiAgICAgICAgXCJMYnJhY2tldFwiOiBudWxsLFxyXG4gICAgICAgIFwiUmJyYWNrZXRcIjogbnVsbCxcclxuICAgICAgICBcIlJlbGF0aW9uXCI6IDEsXHJcbiAgICAgICAgXCJFeHByZXNzdHlwZVwiOiAwLFxyXG4gICAgICAgIFwiQ29tcGFyZVwiOiAwXHJcbiAgICAgIH1cclxuICAgIF07XHJcbiAgICBpZiAocGFyZW50RWxlbWVudCkge1xyXG4gICAgICBwYXJlbnRGaWx0ZXJBcnJheS5wdXNoKFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIFwiRmlsdGVyRmllbGRcIjogYCR7b3JpZ2luYWxIaWVyYXJjaHlJbmZvS2V5fS5QYXJlbnRFbGVtZW50YCxcclxuICAgICAgICAgIFwiVmFsdWVcIjogcGFyZW50RWxlbWVudCxcclxuICAgICAgICAgIFwiTGJyYWNrZXRcIjogbnVsbCxcclxuICAgICAgICAgIFwiUmJyYWNrZXRcIjogbnVsbCxcclxuICAgICAgICAgIFwiUmVsYXRpb25cIjogcmVsYXRpb25UeXBlLFxyXG4gICAgICAgICAgXCJFeHByZXNzdHlwZVwiOiAwLFxyXG4gICAgICAgICAgXCJDb21wYXJlXCI6IDBcclxuICAgICAgICB9XHJcbiAgICAgICk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBwYXJlbnRGaWx0ZXJBcnJheVswXS5SZWxhdGlvbiA9IHJlbGF0aW9uVHlwZTtcclxuICAgIH1cclxuICAgIHJldHVybiBwYXJlbnRGaWx0ZXJBcnJheS5jb25jYXQoZmlsdGVyQXJyYXkpO1xyXG4gIH1cclxuICBwdWJsaWMgYnVpbGRFbnRpdHlGaWx0ZXIoZmlsdGVyOiBhbnlbXSwgc29ydDogYW55W10sIHBhZ2VTaXplOiBudW1iZXIsIHBhZ2VJbmRleDogbnVtYmVyKSB7XHJcblxyXG4gICAgLy8gQHRvZG/vvJrkuLTml7blhbzlrrnogIHku6PnoIHvvIzpmY3kvY7mlLnliqjluKbmnaXnmoTpo47pmalcclxuICAgIGlmICghZmlsdGVyICYmICFzb3J0ICYmICFwYWdlU2l6ZSAmJiAhcGFnZUluZGV4KSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgaWYgKCFmaWx0ZXIpIHtcclxuICAgICAgZmlsdGVyID0gW107XHJcbiAgICB9XHJcbiAgICBpZiAoIXNvcnQpIHtcclxuICAgICAgc29ydCA9IFtdO1xyXG4gICAgfVxyXG4gICAgLy8g57qg5q2j5pyA5ZCO5LiA5Liq6L+H5ruk5p2h5Lu255qEUmVsYXRpb25cclxuICAgIGlmIChmaWx0ZXIgJiYgZmlsdGVyLmxlbmd0aCA+IDApIHtcclxuICAgICAgZmlsdGVyW2ZpbHRlci5sZW5ndGggLSAxXS5SZWxhdGlvbiA9IDA7XHJcbiAgICB9XHJcbiAgICBjb25zdCBlbnRpdHlGaWx0ZXIgPSB7XHJcbiAgICAgIEZpbHRlckNvbmRpdGlvbnM6IGZpbHRlcixcclxuICAgICAgU29ydENvbmRpdGlvbnM6IHNvcnQsXHJcbiAgICAgIElzVXNlUGFnaW5hdGlvbjogcGFnZVNpemUgPT09IDAgPyBmYWxzZSA6IHRydWUsXHJcbiAgICAgIFBhZ2luYXRpb246IHtcclxuICAgICAgICBQYWdlSW5kZXg6IHBhZ2VJbmRleCxcclxuICAgICAgICBQYWdlU2l6ZTogcGFnZVNpemUsXHJcbiAgICAgICAgUGFnZUNvdW50OiAwLFxyXG4gICAgICAgIFRvdGFsQ291bnQ6IDBcclxuICAgICAgfVxyXG4gICAgfTtcclxuICAgIHJldHVybiBlbnRpdHlGaWx0ZXI7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOa4heepuuWQjuS7o+WunuS9k1xyXG4gICAqIEBkZXNjcmlwdGlvbiBwYXJlbnRIaWVyYXJjaHlJbmZv5LitbGF5ZXLkuLropoHmuIXnqbrlkI7ku6PoioLngrnnmoRsYXllcu+8jOS9humHjOmdoueahHBhcmVudEVsZW1lbnTkuI3mmK/niLbnuqfnmoRpZO+8jOiAjOaYr+imgea4heepuuWQjuS7o+iKgueCueeahGlkXHJcbiAgICovXHJcbiAgcHVibGljIGNsZWFyRGVzY2VuZGFudEVudGl0aWVzKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb2tleTogc3RyaW5nLCBwYXJlbnRIaWVyYXJjaHlJbmZvOiBhbnksIGZyb3plbkN1cnJlbnRSb3c6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xyXG4gICAgLy8g5riF56m65qC56IqC54K5XHJcbiAgICBpZiAoIXBhcmVudEhpZXJhcmNoeUluZm8pIHtcclxuICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmNsZWFyKCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IG5vZGVzID0gdGhpcy5nZXRDaGlsZE5vZGVzKHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9rZXksIHBhcmVudEhpZXJhcmNoeUluZm8pO1xyXG4gICAgaWYgKGZyb3plbkN1cnJlbnRSb3cpIHtcclxuICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLnJlbW92ZUVudGl0aWVzKChlbnRpdHk6IEVudGl0eSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGlkID0gZW50aXR5W2VudGl0eS5wcmltYXJ5S2V5XTtcclxuICAgICAgICByZXR1cm4gbm9kZXMuaW5jbHVkZXMoaWQpO1xyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5yZW1vdmVEYXRhKChlbnRpdHk6IEVudGl0eSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGlkID0gZW50aXR5W2VudGl0eS5wcmltYXJ5S2V5XTtcclxuICAgICAgICByZXR1cm4gbm9kZXMuaW5jbHVkZXMoaWQpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluafkOS4quiKgueCueeahOaJgOacieWtkOiKgueCuVxyXG4gICAqIEBwYXJhbSByZXBvc2l0b3J5IHJlcG9zaXRvcnlcclxuICAgKiBAcGFyYW0gaGllcmFyY2h5SW5mb2tleSBoaWVyYXJjaHlJbmZva2V5XHJcbiAgICogQHBhcmFtIHBhcmVudEhpZXJhcmNoeUluZm8gcGFyZW50SGllcmFyY2h5SW5mb1xyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Q2hpbGROb2RlcyhyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9rZXk6IHN0cmluZywgcGFyZW50SGllcmFyY2h5SW5mbzogYW55KSB7XHJcbiAgICBjb25zdCBmcGFyZW50RWxlbWVudCA9IHBhcmVudEhpZXJhcmNoeUluZm8uaWQ7XHJcbiAgICBjb25zdCBmbGF5ZXIgPSBwYXJlbnRIaWVyYXJjaHlJbmZvLmxheWVyO1xyXG4gICAgbGV0IG5vZGVzID0gW107XHJcbiAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0QWxsRW50aXRpZXMoKS5mb3JFYWNoKGVudGl0eSA9PiB7XHJcbiAgICAgIGNvbnN0IGhpZXJhcmNoeUluZm8gPSBlbnRpdHlbaGllcmFyY2h5SW5mb2tleV07XHJcbiAgICAgIGNvbnN0IHBhcmVudEVsZW1lbnQgPSBoaWVyYXJjaHlJbmZvLnBhcmVudEVsZW1lbnQ7XHJcbiAgICAgIGNvbnN0IGxheWVyID0gaGllcmFyY2h5SW5mby5sYXllcjtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gbGF5ZXIgPj0gKGZsYXllciArIDEpICYmIHBhcmVudEVsZW1lbnQgPT09IGZwYXJlbnRFbGVtZW50O1xyXG4gICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgY29uc3QgaWQgPSBlbnRpdHlbZW50aXR5LnByaW1hcnlLZXldO1xyXG4gICAgICAgIG5vZGVzLnB1c2goaWQpO1xyXG4gICAgICAgIGNvbnN0IGNoaWxkSGllcmFyY2h5SW5mbyA9IHRoaXMuZ2V0SGllcmFyY2h5SW5mb0J5SWQocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb2tleSwgaWQpO1xyXG4gICAgICAgIGNvbnN0IGNoaWxkcyA9IHRoaXMuZ2V0Q2hpbGROb2RlcyhyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZva2V5LCBjaGlsZEhpZXJhcmNoeUluZm8pO1xyXG4gICAgICAgIGlmIChjaGlsZHMgJiYgY2hpbGRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIG5vZGVzID0gbm9kZXMuY29uY2F0KGNoaWxkcyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBub2RlcztcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5a6e5L2T55qE5YiG57qn5L+h5oGvXHJcbiAgICovXHJcbiAgcHVibGljIGdldEhpZXJhcmNoeUluZm9CeUlkKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb2tleTogc3RyaW5nLCBpZDogc3RyaW5nKTogYW55IHtcclxuICAgIGlmICghaWQpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCBlbnRpdHk6IEVudGl0eSA9IHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdHlCeUlkKGlkKTtcclxuICAgIGNvbnN0IGhpZXJhcmNoeUluZm9FbnRpdHk6IEVudGl0eSA9IGVudGl0eVtoaWVyYXJjaHlJbmZva2V5XTtcclxuICAgIGNvbnN0IHJlc3VsdCA9IGhpZXJhcmNoeUluZm9FbnRpdHkudG9KU09OKCk7XHJcbiAgICByZXN1bHRbJ2lkJ10gPSBpZDtcclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG4gIHB1YmxpYyBnZXRIaWVyYXJjaHlJbmZvKGVudGl0eTogRW50aXR5LCBoaWVyYXJjaHlJbmZva2V5OiBzdHJpbmcpOiB7IHBhcmVudEVsZW1lbnQ6IHN0cmluZywgbGF5ZXI6IG51bWJlciwgaXNEZXRhaWw6IGJvb2xlYW4gfSB7XHJcbiAgICByZXR1cm4gZW50aXR5W2hpZXJhcmNoeUluZm9rZXldO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bliIbnuqfnoIHnmoTljp/lp4vnmoTlrZfmrrXlkI1cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0T3JpZ2luYWxIaWVyYXJjaHlJbmZvS2V5KHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb2tleTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IG5nT2JqZWN0cyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nT2JqZWN0cyhyZXBvc2l0b3J5LmVudGl0eVR5cGUpO1xyXG4gICAgY29uc3QgaGllcmFyY2h5SW5mb05nT2JqZWN0ID0gbmdPYmplY3RzW2hpZXJhcmNoeUluZm9rZXldO1xyXG4gICAgcmV0dXJuIGhpZXJhcmNoeUluZm9OZ09iamVjdC5vcmlnaW5hbERhdGFGaWVsZCBhcyBzdHJpbmc7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0UGFnaW5hdGlvbkluZm8ocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pIHtcclxuICAgIHJldHVybiByZXNwb25zZUluZm8gJiYgcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlICYmIHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZS5wYWdpbmF0aW9uIHx8IG51bGw7XHJcbiAgfVxyXG4gIHByaXZhdGUgZmluZFBhcmVudChoaWVyYXJjaHlJbmZvOiB7IGlzRGV0YWlsOiBib29sZWFuLCBsYXllcjogbnVtYmVyLCBwYXJlbnRFbGVtZW50OiBzdHJpbmcgfSwgbGlzdDogYW55W10sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIGxpc3QuZmluZChpdGVtID0+IHtcclxuICAgICAgY29uc3QgY3VycmVudEhpZXJhcmNoeUluZm8gPSBpdGVtW2hpZXJhcmNoeUluZm9LZXldIGFzIHsgaXNEZXRhaWw6IGJvb2xlYW4sIGxheWVyOiBudW1iZXIsIHBhcmVudEVsZW1lbnQ6IHN0cmluZyB9O1xyXG4gICAgICByZXR1cm4gY3VycmVudEhpZXJhcmNoeUluZm8ubGF5ZXIgPT09IGhpZXJhcmNoeUluZm8ubGF5ZXIgLSAxICYmIGhpZXJhcmNoeUluZm8ucGFyZW50RWxlbWVudCA9PT0gY3VycmVudEhpZXJhcmNoeUluZm8ucGFyZW50RWxlbWVudDtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIGdldEFsbFBhcmVudElkcyhoaWVyYXJjaHlJbmZvOiB7IGlzRGV0YWlsOiBib29sZWFuLCBsYXllcjogbnVtYmVyLCBwYXJlbnRFbGVtZW50OiBzdHJpbmcgfSwgbGlzdDogYW55W10sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+KSB7XHJcbiAgICBsZXQgaXRlbSA9IHRoaXMuZmluZFBhcmVudChoaWVyYXJjaHlJbmZvLCBsaXN0LCBoaWVyYXJjaHlJbmZvS2V5KTtcclxuICAgIGNvbnN0IGlkcyA9IFtdO1xyXG4gICAgd2hpbGUgKGl0ZW0pIHtcclxuICAgICAgaWRzLnB1c2goaXRlbVtyZXBvc2l0b3J5LnByaW1hcnlLZXldKTtcclxuICAgICAgaXRlbSA9IHRoaXMuZmluZFBhcmVudChpdGVtW2hpZXJhcmNoeUluZm9LZXldLCBsaXN0LCBoaWVyYXJjaHlJbmZvS2V5KTtcclxuICAgIH1cclxuICAgIHJldHVybiBpZHM7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOafpeaJvuiKgueCueS4i+aJgOacieWtkOe6p++8iOesrOS4gOe6p++8iVxyXG4gICAqIEBwYXJhbSByZXBvc2l0b3J5IHJlcG9zaXRvcnlcclxuICAgKiBAcGFyYW0gaGllcmFyY2h5SW5mb0tleSDliIbnuqfnoIHlrZfmrrVcclxuICAgKiBAcGFyYW0gaWQgaWRcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwcml2YXRlIGdldENoaWxkcmVuKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCBpZDogc3RyaW5nKTogRW50aXR5W10ge1xyXG4gICAgY29uc3QgaGllcmFyY2h5SW5mbyA9IHRoaXMuZ2V0SGllcmFyY2h5SW5mb0J5SWQocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSwgaWQpO1xyXG4gICAgaWYgKCFoaWVyYXJjaHlJbmZvKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgbGF5ZXIgPSBoaWVyYXJjaHlJbmZvLmxheWVyO1xyXG4gICAgY29uc3QgcGFyZW50RWxlbWVudCA9IGhpZXJhcmNoeUluZm8ucGFyZW50RWxlbWVudDtcclxuICAgIGNvbnN0IGVudGl0aWVzOiBFbnRpdHlbXSA9IHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdGllcygoZW50aXR5OiBFbnRpdHkpID0+IHtcclxuICAgICAgY29uc3QgaGllcmFyY2h5SW5mbyA9IHRoaXMuZ2V0SGllcmFyY2h5SW5mbyhlbnRpdHksIGhpZXJhcmNoeUluZm9LZXkpO1xyXG4gICAgICBjb25zdCBtYXRjaGVkID0gaGllcmFyY2h5SW5mby5sYXllciA9PT0gbGF5ZXIgKyAxICYmIChoaWVyYXJjaHlJbmZvLnBhcmVudEVsZW1lbnQgPT09IHBhcmVudEVsZW1lbnQgfHwgIXBhcmVudEVsZW1lbnQgJiYgIWhpZXJhcmNoeUluZm8ucGFyZW50RWxlbWVudCk7XHJcbiAgICAgIGlmIChtYXRjaGVkKSB7XHJcbiAgICAgICAgcmV0dXJuIGVudGl0eTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gZW50aXRpZXM7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgeyBQYXJlbnRUcmVlUmVwb3NpdG9yeSB9O1xyXG4iXX0=