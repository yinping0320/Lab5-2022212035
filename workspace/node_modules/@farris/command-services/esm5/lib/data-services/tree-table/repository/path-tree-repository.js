import { HttpHeaders } from '@angular/common/http';
import { of } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { FieldMetadataUtil } from '@farris/devkit';
/**
 * 路径树仓库
 */
var PathTreeRepository = /** @class */ (function () {
    function PathTreeRepository() {
    }
    /**
     * 添加兄弟节点
     */
    PathTreeRepository.prototype.addSibling = function (repository, id) {
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var addSiblingUri = baseUri + "/service/pathhierarchycreatesibling";
        var body = {
            dataID: id,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSiblingUri, 'PUT', null, options).pipe(map(function (responseInfo) {
            var entity = repository.buildEntity(responseInfo.returnValue);
            repository.entityCollection.addEntity(entity);
            return entity;
        }));
    };
    /**
     * 添加兄弟节点
     */
    PathTreeRepository.prototype.addChild = function (repository, parentId) {
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var addChildUri = baseUri + "/service/pathhierarchycreatechildlayer";
        var body = {
            dataID: parentId,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addChildUri, 'PUT', null, options).pipe(map(function (responseInfo) {
            var entity = repository.buildEntity(responseInfo.returnValue);
            repository.entityCollection.addEntity(entity);
            return entity;
        }));
    };
    /**
     * 添加子表兄弟节点
     */
    PathTreeRepository.prototype.addSubSibling = function (repository, nodes, ids) {
        var _this = this;
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var addSubSiblingUri = baseUri + "/service/childnodepathhierarchycreatesibling";
        var body = {
            nodes: nodes,
            ids: ids,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSubSiblingUri, 'PUT', null, options).pipe(map(function (responseInfo) {
            var path = _this.getPaths(nodes, ids);
            var entity = repository.entityManager.appendEntityByPath(path, responseInfo.returnValue);
            return entity;
        }));
    };
    /**
    * 添加子表子节点
    */
    PathTreeRepository.prototype.addSubChild = function (repository, nodes, ids) {
        var _this = this;
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var addSubChildUri = baseUri + "/service/childnodepathhierarchycreatechildlayer";
        var body = {
            nodes: nodes,
            ids: ids,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSubChildUri, 'PUT', null, options).pipe(map(function (responseInfo) {
            var path = _this.getPaths(nodes, ids);
            var entity = repository.entityManager.appendEntityByPath(path, responseInfo.returnValue);
            return entity;
        }));
    };
    PathTreeRepository.prototype.getPaths = function (nodes, ids) {
        var paths = '';
        if (nodes && nodes.length > 0 && ids && ids.length > 0) {
            for (var i = 0; i < ids.length; i++) {
                if (nodes[i]) {
                    paths = paths + ("/" + ids[i]);
                    paths = paths + ("/" + nodes[i] + "s");
                }
            }
        }
        return paths;
    };
    /**
     * 加载父节点
     */
    // tslint:disable-next-line: max-line-length
    PathTreeRepository.prototype.loadByParentId = function (repository, hierarchyInfoKey, parentId, filters, sorts, frozenCurrentRow, pagination, frameContext, reload) {
        var _this = this;
        if (frozenCurrentRow === void 0) { frozenCurrentRow = false; }
        if (reload === void 0) { reload = false; }
        var localEntities = this.getChildren(repository, hierarchyInfoKey, parentId);
        if (localEntities && localEntities.length > 0 && !reload) {
            return of(localEntities);
        }
        var restService = repository.restService;
        var parentHierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, parentId);
        var originalHierarchyInfoKey = this.getOriginalHierarchyInfoKey(repository, hierarchyInfoKey);
        var filtersWithParent = this.buildFiltersWithParent(originalHierarchyInfoKey, parentHierarchyInfo, filters);
        var isUsePagination = pagination && pagination.pageSize > 0 || false;
        // 组织EntityFilter
        var entityFilter = {
            FilterConditions: filtersWithParent,
            SortConditions: sorts,
            IsUsePagination: isUsePagination,
            Pagination: { PageIndex: pagination && pagination.pageIndex || 0, PageSize: pagination && pagination.pageSize || 0, PageCount: 0, TotalCount: 0 }
        };
        var requestInfo = restService.buildRequestInfo();
        return restService.extendQuery(entityFilter, requestInfo).pipe(map(function (responseInfo) {
            var paginationInfo = _this.getPaginationInfo(responseInfo);
            if (parentId) {
                if (paginationInfo && paginationInfo.pageSize !== 0 && frameContext) {
                    frameContext.params.set("_NODE_" + parentId + "_PAGINATION_INFO_", paginationInfo);
                }
            }
            else {
                if (paginationInfo && paginationInfo.pageSize !== 0 && frameContext) {
                    frameContext.repository.entityCollection.updatePaginationInfoByPath('/', paginationInfo);
                }
            }
            // 先清空下级实体
            _this.clearDescendantEntities(repository, hierarchyInfoKey, parentHierarchyInfo, frozenCurrentRow);
            // 追加下级实体
            var listData = responseInfo.returnValue.result;
            var entities = repository.buildEntities(listData);
            if (frozenCurrentRow) {
                repository.entityCollection.addData(entities, { isTreeNodeLoadScene: true });
            }
            else {
                repository.entityCollection.addEntities(entities, { isTreeNodeLoadScene: true });
            }
            return entities;
        }));
    };
    // tslint:disable-next-line: max-line-length
    PathTreeRepository.prototype.loadFullTree = function (repository, hierarchyInfoKey, parentId, propertyName, fullTreeType, loadType, filters, context) {
        var _this = this;
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var queryUrl = baseUri + "/service/parentidfulltreequery";
        var pathHierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, parentId);
        var entityFilter = this.buildEntityFilter(filters, null, 0, 0);
        var body = {
            dataId: parentId || '',
            isUsePagination: false,
            virtualPropertyName: propertyName,
            pagination: {},
            fullTreeType: fullTreeType,
            loadType: loadType,
            filter: entityFilter,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            body: body
        };
        return restService.invoke(queryUrl, 'PUT', null, options).pipe(tap(function (responseInfo) {
            // 保存展开的节点
            if (responseInfo.returnValue && responseInfo.returnValue.selectedRowId && context && context.frameContext) {
                var frameContext = context.frameContext;
                var virtualRootFrameContext = frameContext && frameContext.getVirtualRootFrameContext() || null;
                if (virtualRootFrameContext) {
                    var list = responseInfo.returnValue.result;
                    var selectedRowId_1 = responseInfo.returnValue.selectedRowId;
                    // 从顶层开始计算所有需要展开的节点
                    var leafNodeInfo = list.find(function (item) { return item[repository.primaryKey] === selectedRowId_1; });
                    var hierarchyInfo = leafNodeInfo[hierarchyInfoKey];
                    var ids = _this.getAllParentIds(hierarchyInfo, list, hierarchyInfoKey, repository);
                    virtualRootFrameContext.params.set('_DEVKIT_expandRowIds', ids.join(','));
                    virtualRootFrameContext.params.set('_DEVKIT_selectedRowId', selectedRowId_1);
                    virtualRootFrameContext.uiState.setPropertyValue('__DEVKIT__selectedRow', selectedRowId_1);
                }
            }
        }), map(function (responseInfo) {
            var frozenCurrentRow = context && context.frozenCurrentRow || false;
            // 先清空下级实体
            _this.clearDescendantEntities(repository, hierarchyInfoKey, pathHierarchyInfo, frozenCurrentRow);
            // 追加下级实体
            var listData = responseInfo.returnValue.result;
            var entities = repository.buildEntities(listData);
            if (frozenCurrentRow) {
                repository.entityCollection.addData(entities, { isTreeNodeLoadScene: true });
            }
            else {
                repository.entityCollection.addEntities(entities, { isTreeNodeLoadScene: true });
            }
            return entities;
        }));
    };
    /**
     * 插入对父节点的过滤
     */
    PathTreeRepository.prototype.buildFiltersWithParent = function (originalHierarchyInfoKey, parentHierarchyInfo, filterArray) {
        var relationType = filterArray && filterArray.length >= 1 ? 1 : 0;
        var parentLayer = parentHierarchyInfo ? parentHierarchyInfo['layer'] : 0;
        var parentFilterArray = [
            {
                "FilterField": originalHierarchyInfoKey + ".Layer",
                "Value": parentLayer + 1,
                "Lbracket": null,
                "Rbracket": null,
                "Relation": 1,
                "Expresstype": 0,
                "Compare": 0
            }
        ];
        // 父路径过滤，如果为空，则不添加（兼容oracle取数）
        var parentPath = parentHierarchyInfo ? parentHierarchyInfo['path'] : '';
        if (parentPath) {
            parentFilterArray.push({
                "FilterField": originalHierarchyInfoKey + ".Path",
                "Value": parentPath,
                "Lbracket": null,
                "Rbracket": null,
                "Relation": relationType,
                "Expresstype": 0,
                "Compare": 7
            });
        }
        else {
            parentFilterArray[0].Relation = relationType;
        }
        return parentFilterArray.concat(filterArray);
    };
    PathTreeRepository.prototype.buildEntityFilter = function (filter, sort, pageSize, pageIndex) {
        // @todo：临时兼容老代码，降低改动带来的风险
        if (!filter && !sort && !pageSize && !pageIndex) {
            return null;
        }
        if (!filter) {
            filter = [];
        }
        if (!sort) {
            sort = [];
        }
        // 纠正最后一个过滤条件的Relation
        if (filter && filter.length > 0) {
            filter[filter.length - 1].Relation = 0;
        }
        var entityFilter = {
            FilterConditions: filter,
            SortConditions: sort,
            IsUsePagination: pageSize === 0 ? false : true,
            Pagination: {
                PageIndex: pageIndex,
                PageSize: pageSize,
                PageCount: 0,
                TotalCount: 0
            }
        };
        return entityFilter;
    };
    /**
     * 清空后代实体
     */
    PathTreeRepository.prototype.clearDescendantEntities = function (repository, hierarchyInfokey, parentHierarchyInfo, frozenCurrentRow) {
        if (frozenCurrentRow === void 0) { frozenCurrentRow = false; }
        // 清空根节点
        if (!parentHierarchyInfo) {
            repository.entityCollection.clear();
            return;
        }
        var fPath = parentHierarchyInfo.path;
        var fLayer = parentHierarchyInfo.layer;
        if (frozenCurrentRow) {
            repository.entityCollection.removeData(function (entity) {
                var hierarchyInfo = entity[hierarchyInfokey];
                var path = hierarchyInfo.path;
                var layer = hierarchyInfo.layer;
                return layer > fLayer && path.startsWith(fPath);
            });
        }
        else {
            repository.entityCollection.removeEntities(function (entity) {
                var hierarchyInfo = entity[hierarchyInfokey];
                var path = hierarchyInfo.path;
                var layer = hierarchyInfo.layer;
                return layer > fLayer && path.startsWith(fPath);
            });
        }
    };
    /**
     * 获取实体的分级信息
     */
    PathTreeRepository.prototype.getHierarchyInfoById = function (repository, hierarchyInfokey, id) {
        if (!id) {
            return null;
        }
        var entity = repository.entityCollection.getEntityById(id);
        var hierarchyInfoEntity = entity[hierarchyInfokey];
        return hierarchyInfoEntity.toJSON();
    };
    /**
     * 获取分级码的原始的字段名
     */
    PathTreeRepository.prototype.getOriginalHierarchyInfoKey = function (repository, hierarchyInfokey) {
        var ngObjects = FieldMetadataUtil.getNgObjects(repository.entityType);
        var hierarchyInfoNgObject = ngObjects[hierarchyInfokey];
        return hierarchyInfoNgObject.originalDataField;
    };
    PathTreeRepository.prototype.getPaginationInfo = function (responseInfo) {
        return responseInfo && responseInfo.returnValue && responseInfo.returnValue.pagination || null;
    };
    PathTreeRepository.prototype.findParent = function (hierarchyInfo, list, hierarchyInfoKey) {
        return list.find(function (item) {
            var currentHierarchyInfo = item[hierarchyInfoKey];
            return currentHierarchyInfo.layer === hierarchyInfo.layer - 1 && hierarchyInfo.path.startsWith(currentHierarchyInfo.path);
        });
    };
    PathTreeRepository.prototype.getAllParentIds = function (hierarchyInfo, list, hierarchyInfoKey, repository) {
        var item = this.findParent(hierarchyInfo, list, hierarchyInfoKey);
        var ids = [];
        while (item) {
            ids.push(item[repository.primaryKey]);
            item = this.findParent(item[hierarchyInfoKey], list, hierarchyInfoKey);
        }
        return ids;
    };
    PathTreeRepository.prototype.getHierarchyInfo = function (entity, hierarchyInfoKey) {
        return entity[hierarchyInfoKey];
    };
    /**
     * 查找节点下所有子级（第一级）
     * @param repository repository
     * @param hierarchyInfoKey 分级码字段
     * @param id id
     * @returns
     */
    PathTreeRepository.prototype.getChildren = function (repository, hierarchyInfoKey, id) {
        var _this = this;
        var hierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, id);
        if (!hierarchyInfo) {
            return null;
        }
        var layer = hierarchyInfo.layer;
        var path = hierarchyInfo.path;
        var entities = repository.entityCollection.getEntities(function (entity) {
            var hierarchyInfo = _this.getHierarchyInfo(entity, hierarchyInfoKey);
            var matched = hierarchyInfo.layer === layer + 1 && hierarchyInfo.path.startsWith(path);
            if (matched) {
                return entity;
            }
            else {
                return null;
            }
        });
        return entities;
    };
    return PathTreeRepository;
}());
export { PathTreeRepository };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0aC10cmVlLXJlcG9zaXRvcnkuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZGF0YS1zZXJ2aWNlcy90cmVlLXRhYmxlL3JlcG9zaXRvcnkvcGF0aC10cmVlLXJlcG9zaXRvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ25ELE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxQyxPQUFPLEVBQVUsaUJBQWlCLEVBQTRCLE1BQU0sZ0JBQWdCLENBQUM7QUFHckY7O0dBRUc7QUFDSDtJQUFBO0lBNlhBLENBQUM7SUEzWEM7O09BRUc7SUFDSSx1Q0FBVSxHQUFqQixVQUFrQixVQUFpQyxFQUFFLEVBQVU7UUFDN0QsSUFBTSxXQUFXLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQztRQUMzQyxJQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDO1FBQ3BDLElBQU0sYUFBYSxHQUFNLE9BQU8sd0NBQXFDLENBQUM7UUFDdEUsSUFBTSxJQUFJLEdBQUc7WUFDWCxNQUFNLEVBQUUsRUFBRTtZQUNWLFdBQVcsRUFBRSxXQUFXLENBQUMsZ0JBQWdCLEVBQUU7U0FDNUMsQ0FBQztRQUNGLElBQU0sT0FBTyxHQUFHO1lBQ2QsT0FBTyxFQUFFLElBQUksV0FBVyxDQUFDLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLENBQUM7WUFDaEUsSUFBSSxFQUFFLElBQUk7U0FDWCxDQUFDO1FBQ0YsT0FBTyxXQUFXLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDakUsR0FBRyxDQUFDLFVBQUMsWUFBMEI7WUFDN0IsSUFBTSxN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QXdCO1FBQy9ELE9BQU8sTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUNEOzs7Ozs7T0FNRztJQUNLLHdDQUFXLEdBQW5CLFVBQW9CLFVBQWlDLEVBQUUsZ0JBQXdCLEVBQUUsRUFBVTtRQUEzRixpQkFpQkM7UUFoQkMsSUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNsRixJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ2xCLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxJQUFNLEtBQUssR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDO1FBQ2xDLElBQU0sSUFBSSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUM7UUFDaEMsSUFBTSxRQUFRLEdBQWEsVUFBVSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxVQUFDLE1BQWM7WUFDaEYsSUFBTSxhQUFhLEdBQUcsS0FBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3RFLElBQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxLQUFLLEtBQUssS0FBSyxHQUFHLENBQUMsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN6RixJQUFJLE9BQU8sRUFBRTtnQkFDWCxPQUFPLE1BQU0sQ0FBQzthQUNmO2lCQUFNO2dCQUNMLE9BQU8sSUFBSSxDQUFDO2FBQ2I7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFDSCx5QkFBQztBQUFELENBQUMsQUE3WEQsSUE2WEM7QUFFRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBIZWFkZXJzIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBtYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgRW50aXR5LCBGaWVsZE1ldGFkYXRhVXRpbCwgRnJhbWVDb250ZXh0LCBSZXBvc2l0b3J5IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBSZXNwb25zZUluZm8sIEJlZlJlcG9zaXRvcnkgfSBmcm9tICdAZmFycmlzL2JlZic7XHJcblxyXG4vKipcclxuICog6Lev5b6E5qCR5LuT5bqTXHJcbiAqL1xyXG5jbGFzcyBQYXRoVHJlZVJlcG9zaXRvcnkge1xyXG5cclxuICAvKipcclxuICAgKiDmt7vliqDlhYTlvJ/oioLngrlcclxuICAgKi9cclxuICBwdWJsaWMgYWRkU2libGluZyhyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEVudGl0eT4ge1xyXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSByZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XHJcbiAgICBjb25zdCBhZGRTaWJsaW5nVXJpID0gYCR7YmFzZVVyaX0vc2VydmljZS9wYXRoaGllcmFyY2h5Y3JlYXRlc2libGluZ2A7XHJcbiAgICBjb25zdCBib2R5ID0ge1xyXG4gICAgICBkYXRhSUQ6IGlkLFxyXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9KSxcclxuICAgICAgYm9keTogYm9keVxyXG4gICAgfTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UoYWRkU2libGluZ1VyaSwgJ1BVVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXHJcbiAgICAgIG1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcclxuICAgICAgICBjb25zdCBlbnRpdHkgPSByZXBvc2l0b3J5LmJ1aWxkRW50aXR5KHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSk7XHJcbiAgICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmFkZEVudGl0eShlbnRpdHkpO1xyXG4gICAgICAgIHJldHVybiBlbnRpdHk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5re75Yqg5YWE5byf6IqC54K5XHJcbiAgICovXHJcbiAgcHVibGljIGFkZENoaWxkKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgcGFyZW50SWQ6IHN0cmluZykge1xyXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSByZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XHJcbiAgICBjb25zdCBhZGRDaGlsZFVyaSA9IGAke2Jhc2VVcml9L3NlcnZpY2UvcGF0aGhpZXJhcmNoeWNyZWF0ZWNoaWxkbGF5ZXJgO1xyXG5cclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgIGRhdGFJRDogcGFyZW50SWQsXHJcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcclxuICAgIH07XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBoZWFkZXJzOiBuZXcgSHR0cEhlYWRlcnMoeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0pLFxyXG4gICAgICBib2R5OiBib2R5XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZShhZGRDaGlsZFVyaSwgJ1BVVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXHJcbiAgICAgIG1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcclxuICAgICAgICBjb25zdCBlbnRpdHkgPSByZXBvc2l0b3J5LmJ1aWxkRW50aXR5KHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSk7XHJcbiAgICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmFkZEVudGl0eShlbnRpdHkpO1xyXG4gICAgICAgIHJldHVybiBlbnRpdHk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5re75Yqg5a2Q6KGo5YWE5byf6IqC54K5XHJcbiAgICovXHJcbiAgcHVibGljIGFkZFN1YlNpYmxpbmcocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBub2RlczogQXJyYXk8c3RyaW5nPiwgaWRzOiBBcnJheTxzdHJpbmc+KTogT2JzZXJ2YWJsZTxFbnRpdHk+IHtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gcmVwb3NpdG9yeS5yZXN0U2VydmljZTtcclxuICAgIGNvbnN0IGJhc2VVcmkgPSByZXN0U2VydmljZS5iYXNlVXJpO1xyXG4gICAgY29uc3QgYWRkU3ViU2libGluZ1VyaSA9IGAke2Jhc2VVcml9L3NlcnZpY2UvY2hpbGRub2RlcGF0aGhpZXJhcmNoeWNyZWF0ZXNpYmxpbmdgO1xyXG4gICAgY29uc3QgYm9keSA9IHtcclxuICAgICAgbm9kZXM6IG5vZGVzLFxyXG4gICAgICBpZHM6IGlkcyxcclxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxyXG4gICAgfTtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgIGhlYWRlcnM6IG5ldyBIdHRwSGVhZGVycyh7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSksXHJcbiAgICAgIGJvZHk6IGJvZHlcclxuICAgIH07XHJcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKGFkZFN1YlNpYmxpbmdVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxyXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgbGV0IHBhdGggPSB0aGlzLmdldFBhdGhzKG5vZGVzLCBpZHMpO1xyXG4gICAgICAgIGNvbnN0IGVudGl0eSA9IHJlcG9zaXRvcnkuZW50aXR5TWFuYWdlci5hcHBlbmRFbnRpdHlCeVBhdGgocGF0aCwgcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlKVxyXG4gICAgICAgIHJldHVybiBlbnRpdHk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgKiDmt7vliqDlrZDooajlrZDoioLngrlcclxuICAqL1xyXG4gIHB1YmxpYyBhZGRTdWJDaGlsZChyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIG5vZGVzOiBBcnJheTxzdHJpbmc+LCBpZHM6IEFycmF5PHN0cmluZz4pIHtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gcmVwb3NpdG9yeS5yZXN0U2VydmljZTtcclxuICAgIGNvbnN0IGJhc2VVcmkgPSByZXN0U2VydmljZS5iYXNlVXJpO1xyXG4gICAgY29uc3QgYWRkU3ViQ2hpbGRVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL2NoaWxkbm9kZXBhdGhoaWVyYXJjaHljcmVhdGVjaGlsZGxheWVyYDtcclxuXHJcbiAgICBjb25zdCBib2R5ID0ge1xyXG4gICAgICBub2Rlczogbm9kZXMsXHJcbiAgICAgIGlkczogaWRzLFxyXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9KSxcclxuICAgICAgYm9keTogYm9keVxyXG4gICAgfTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UoYWRkU3ViQ2hpbGRVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxyXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgbGV0IHBhdGggPSB0aGlzLmdldFBhdGhzKG5vZGVzLCBpZHMpO1xyXG4gICAgICAgIGNvbnN0IGVudGl0eSA9IHJlcG9zaXRvcnkuZW50aXR5TWFuYWdlci5hcHBlbmRFbnRpdHlCeVBhdGgocGF0aCwgcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlKVxyXG4gICAgICAgIHJldHVybiBlbnRpdHk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRQYXRocyhub2Rlczogc3RyaW5nW10sIGlkczogc3RyaW5nW10pIHtcclxuICAgIGxldCBwYXRocyA9ICcnO1xyXG4gICAgaWYgKG5vZGVzICYmIG5vZGVzLmxlbmd0aCA+IDAgJiYgaWRzICYmIGlkcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaWRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgaWYgKG5vZGVzW2ldKSB7XHJcbiAgICAgICAgICBwYXRocyA9IHBhdGhzICsgYC8ke2lkc1tpXX1gO1xyXG4gICAgICAgICAgcGF0aHMgPSBwYXRocyArIGAvJHtub2Rlc1tpXX1zYDtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBwYXRocztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWKoOi9veeItuiKgueCuVxyXG4gICAqL1xyXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbWF4LWxpbmUtbGVuZ3RoXHJcbiAgcHVibGljIGxvYWRCeVBhcmVudElkKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCBwYXJlbnRJZDogc3RyaW5nLCBmaWx0ZXJzOiBhbnlbXSwgc29ydHM6IGFueVtdLCBmcm96ZW5DdXJyZW50Um93OiBib29sZWFuID0gZmFsc2UsIHBhZ2luYXRpb24/OiB7IHBhZ2VTaXplOiBudW1iZXIsIHBhZ2VJbmRleDogbnVtYmVyIH0sIGZyYW1lQ29udGV4dD86IEZyYW1lQ29udGV4dCwgcmVsb2FkOiBib29sZWFuID0gZmFsc2UpOiBPYnNlcnZhYmxlPEVudGl0eVtdPiB7XHJcbiAgICBjb25zdCBsb2NhbEVudGl0aWVzID0gdGhpcy5nZXRDaGlsZHJlbihyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZvS2V5LCBwYXJlbnRJZCk7XHJcbiAgICBpZiAobG9jYWxFbnRpdGllcyAmJiBsb2NhbEVudGl0aWVzLmxlbmd0aCA+IDAgJiYgIXJlbG9hZCkge1xyXG4gICAgICByZXR1cm4gb2YobG9jYWxFbnRpdGllcyk7XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XHJcbiAgICBjb25zdCBwYXJlbnRIaWVyYXJjaHlJbmZvID0gdGhpcy5nZXRIaWVyYXJjaHlJbmZvQnlJZChyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZvS2V5LCBwYXJlbnRJZCk7XHJcbiAgICBjb25zdCBvcmlnaW5hbEhpZXJhcmNoeUluZm9LZXkgPSB0aGlzLmdldE9yaWdpbmFsSGllcmFyY2h5SW5mb0tleShyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZvS2V5KTtcclxuICAgIGNvbnN0IGZpbHRlcnNXaXRoUGFyZW50ID0gdGhpcy5idWlsZEZpbHRlcnNXaXRoUGFyZW50KG9yaWdpbmFsSGllcmFyY2h5SW5mb0tleSwgcGFyZW50SGllcmFyY2h5SW5mbywgZmlsdGVycyk7XHJcbiAgICBjb25zdCBpc1VzZVBhZ2luYXRpb24gPSBwYWdpbmF0aW9uICYmIHBhZ2luYXRpb24ucGFnZVNpemUgPiAwIHx8IGZhbHNlO1xyXG4gICAgLy8g57uE57uHRW50aXR5RmlsdGVyXHJcbiAgICBjb25zdCBlbnRpdHlGaWx0ZXIgPSB7XHJcbiAgICAgIEZpbHRlckNvbmRpdGlvbnM6IGZpbHRlcnNXaXRoUGFyZW50LFxyXG4gICAgICBTb3J0Q29uZGl0aW9uczogc29ydHMsXHJcbiAgICAgIElzVXNlUGFnaW5hdGlvbjogaXNVc2VQYWdpbmF0aW9uLFxyXG4gICAgICBQYWdpbmF0aW9uOiB7IFBhZ2VJbmRleDogcGFnaW5hdGlvbiAmJiBwYWdpbmF0aW9uLnBhZ2VJbmRleCB8fCAwLCBQYWdlU2l6ZTogcGFnaW5hdGlvbiAmJiBwYWdpbmF0aW9uLnBhZ2VTaXplIHx8IDAsIFBhZ2VDb3VudDogMCwgVG90YWxDb3VudDogMCB9XHJcbiAgICB9O1xyXG4gICAgY29uc3QgcmVxdWVzdEluZm8gPSByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKCk7XHJcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuZXh0ZW5kUXVlcnkoZW50aXR5RmlsdGVyLCByZXF1ZXN0SW5mbykucGlwZShcclxuICAgICAgbWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xyXG4gICAgICAgIGNvbnN0IHBhZ2luYXRpb25JbmZvID0gdGhpcy5nZXRQYWdpbmF0aW9uSW5mbyhyZXNwb25zZUluZm8pO1xyXG4gICAgICAgIGlmIChwYXJlbnRJZCkge1xyXG4gICAgICAgICAgaWYgKHBhZ2luYXRpb25JbmZvICYmIHBhZ2luYXRpb25JbmZvLnBhZ2VTaXplICE9PSAwICYmIGZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgICAgICBmcmFtZUNvbnRleHQucGFyYW1zLnNldChgX05PREVfJHtwYXJlbnRJZH1fUEFHSU5BVElPTl9JTkZPX2AsIHBhZ2luYXRpb25JbmZvKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgaWYgKHBhZ2luYXRpb25JbmZvICYmIHBhZ2luYXRpb25JbmZvLnBhZ2VTaXplICE9PSAwICYmIGZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgICAgICBmcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLnVwZGF0ZVBhZ2luYXRpb25JbmZvQnlQYXRoKCcvJywgcGFnaW5hdGlvbkluZm8pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDlhYjmuIXnqbrkuIvnuqflrp7kvZNcclxuICAgICAgICB0aGlzLmNsZWFyRGVzY2VuZGFudEVudGl0aWVzKHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9LZXksIHBhcmVudEhpZXJhcmNoeUluZm8sIGZyb3plbkN1cnJlbnRSb3cpO1xyXG4gICAgICAgIC8vIOi/veWKoOS4i+e6p+WunuS9k1xyXG4gICAgICAgIGNvbnN0IGxpc3REYXRhID0gcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlLnJlc3VsdDtcclxuICAgICAgICBjb25zdCBlbnRpdGllcyA9IHJlcG9zaXRvcnkuYnVpbGRFbnRpdGllcyhsaXN0RGF0YSk7XHJcbiAgICAgICAgaWYgKGZyb3plbkN1cnJlbnRSb3cpIHtcclxuICAgICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGREYXRhKGVudGl0aWVzLCB7IGlzVHJlZU5vZGVMb2FkU2NlbmU6IHRydWUgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdGllcyhlbnRpdGllcywgeyBpc1RyZWVOb2RlTG9hZFNjZW5lOiB0cnVlIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGVudGl0aWVzO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtYXgtbGluZS1sZW5ndGhcclxuICBwdWJsaWMgbG9hZEZ1bGxUcmVlKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCBwYXJlbnRJZDogc3RyaW5nLCBwcm9wZXJ0eU5hbWU6IHN0cmluZywgZnVsbFRyZWVUeXBlOiBzdHJpbmcsIGxvYWRUeXBlOiBzdHJpbmcsIGZpbHRlcnM/OiBhbnlbXSwgY29udGV4dD86IGFueSk6IE9ic2VydmFibGU8RW50aXR5W10+IHtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gcmVwb3NpdG9yeS5yZXN0U2VydmljZTtcclxuICAgIGNvbnN0IGJhc2VVcmkgPSByZXN0U2VydmljZS5iYXNlVXJpO1xyXG4gICAgY29uc3QgcXVlcnlVcmwgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL3BhcmVudGlkZnVsbHRyZWVxdWVyeWA7XHJcbiAgICBjb25zdCBwYXRoSGllcmFyY2h5SW5mbyA9IHRoaXMuZ2V0SGllcmFyY2h5SW5mb0J5SWQocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSwgcGFyZW50SWQpO1xyXG4gICAgY29uc3QgZW50aXR5RmlsdGVyID0gdGhpcy5idWlsZEVudGl0eUZpbHRlcihmaWx0ZXJzLCBudWxsLCAwLCAwKTtcclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgIGRhdGFJZDogcGFyZW50SWQgfHwgJycsXHJcbiAgICAgIGlzVXNlUGFnaW5hdGlvbjogZmFsc2UsXHJcbiAgICAgIHZpcnR1YWxQcm9wZXJ0eU5hbWU6IHByb3BlcnR5TmFtZSxcclxuICAgICAgcGFnaW5hdGlvbjoge30sXHJcbiAgICAgIGZ1bGxUcmVlVHlwZSxcclxuICAgICAgbG9hZFR5cGUsXHJcbiAgICAgIGZpbHRlcjogZW50aXR5RmlsdGVyLFxyXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgYm9keTogYm9keVxyXG4gICAgfTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UocXVlcnlVcmwsICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxyXG4gICAgICB0YXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgLy8g5L+d5a2Y5bGV5byA55qE6IqC54K5XHJcbiAgICAgICAgaWYgKHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSAmJiByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUuc2VsZWN0ZWRSb3dJZCAmJiBjb250ZXh0ICYmIGNvbnRleHQuZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgICBjb25zdCBmcmFtZUNvbnRleHQgPSBjb250ZXh0LmZyYW1lQ29udGV4dCBhcyBGcmFtZUNvbnRleHQ7XHJcbiAgICAgICAgICBjb25zdCB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKSB8fCBudWxsO1xyXG4gICAgICAgICAgaWYgKHZpcnR1YWxSb290RnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGxpc3QgPSByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUucmVzdWx0IGFzIGFueVtdO1xyXG4gICAgICAgICAgICBjb25zdCBzZWxlY3RlZFJvd0lkID0gcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlLnNlbGVjdGVkUm93SWQ7XHJcbiAgICAgICAgICAgIC8vIOS7jumhtuWxguW8gOWni+iuoeeul+aJgOaciemcgOimgeWxleW8gOeahOiKgueCuVxyXG4gICAgICAgICAgICBjb25zdCBsZWFmTm9kZUluZm8gPSBsaXN0LmZpbmQoaXRlbSA9PiBpdGVtW3JlcG9zaXRvcnkucHJpbWFyeUtleV0gPT09IHNlbGVjdGVkUm93SWQpO1xyXG4gICAgICAgICAgICBjb25zdCBoaWVyYXJjaHlJbmZvID0gbGVhZk5vZGVJbmZvW2hpZXJhcmNoeUluZm9LZXldIGFzIHsgaXNEZXRhaWw6IGJvb2xlYW4sIGxheWVyOiBudW1iZXIsIHBhdGg6IHN0cmluZyB9O1xyXG4gICAgICAgICAgICBjb25zdCBpZHMgPSB0aGlzLmdldEFsbFBhcmVudElkcyhoaWVyYXJjaHlJbmZvLCBsaXN0LCBoaWVyYXJjaHlJbmZvS2V5LCByZXBvc2l0b3J5KTtcclxuICAgICAgICAgICAgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQucGFyYW1zLnNldCgnX0RFVktJVF9leHBhbmRSb3dJZHMnLCBpZHMuam9pbignLCcpKTtcclxuICAgICAgICAgICAgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQucGFyYW1zLnNldCgnX0RFVktJVF9zZWxlY3RlZFJvd0lkJywgc2VsZWN0ZWRSb3dJZCk7XHJcbiAgICAgICAgICAgIHZpcnR1YWxSb290RnJhbWVDb250ZXh0LnVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZSgnX19ERVZLSVRfX3NlbGVjdGVkUm93Jywgc2VsZWN0ZWRSb3dJZCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KSxcclxuICAgICAgbWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZyb3plbkN1cnJlbnRSb3c6IGJvb2xlYW4gPSBjb250ZXh0ICYmIGNvbnRleHQuZnJvemVuQ3VycmVudFJvdyB8fCBmYWxzZTtcclxuICAgICAgICAvLyDlhYjmuIXnqbrkuIvnuqflrp7kvZNcclxuICAgICAgICB0aGlzLmNsZWFyRGVzY2VuZGFudEVudGl0aWVzKHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9LZXksIHBhdGhIaWVyYXJjaHlJbmZvLCBmcm96ZW5DdXJyZW50Um93KTtcclxuICAgICAgICAvLyDov73liqDkuIvnuqflrp7kvZNcclxuICAgICAgICBjb25zdCBsaXN0RGF0YSA9IHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZS5yZXN1bHQ7XHJcbiAgICAgICAgY29uc3QgZW50aXRpZXMgPSByZXBvc2l0b3J5LmJ1aWxkRW50aXRpZXMobGlzdERhdGEpO1xyXG4gICAgICAgIGlmIChmcm96ZW5DdXJyZW50Um93KSB7XHJcbiAgICAgICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uYWRkRGF0YShlbnRpdGllcywge2lzVHJlZU5vZGVMb2FkU2NlbmU6IHRydWV9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmFkZEVudGl0aWVzKGVudGl0aWVzLCB7aXNUcmVlTm9kZUxvYWRTY2VuZTogdHJ1ZX0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZW50aXRpZXM7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmj5LlhaXlr7nniLboioLngrnnmoTov4fmu6RcclxuICAgKi9cclxuICBwdWJsaWMgYnVpbGRGaWx0ZXJzV2l0aFBhcmVudChvcmlnaW5hbEhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgcGFyZW50SGllcmFyY2h5SW5mbzogYW55LCBmaWx0ZXJBcnJheTogYW55W10pOiBhbnkge1xyXG4gICAgY29uc3QgcmVsYXRpb25UeXBlID0gZmlsdGVyQXJyYXkgJiYgZmlsdGVyQXJyYXkubGVuZ3RoID49IDEgPyAxIDogMDtcclxuXHJcbiAgICBjb25zdCBwYXJlbnRMYXllciA9IHBhcmVudEhpZXJhcmNoeUluZm8gPyBwYXJlbnRIaWVyYXJjaHlJbmZvWydsYXllciddIDogMDtcclxuICAgIGNvbnN0IHBhcmVudEZpbHRlckFycmF5ID0gW1xyXG4gICAgICB7XHJcbiAgICAgICAgXCJGaWx0ZXJGaWVsZFwiOiBgJHtvcmlnaW5hbEhpZXJhcmNoeUluZm9LZXl9LkxheWVyYCxcclxuICAgICAgICBcIlZhbHVlXCI6IHBhcmVudExheWVyICsgMSxcclxuICAgICAgICBcIkxicmFja2V0XCI6IG51bGwsXHJcbiAgICAgICAgXCJSYnJhY2tldFwiOiBudWxsLFxyXG4gICAgICAgIFwiUmVsYXRpb25cIjogMSxcclxuICAgICAgICBcIkV4cHJlc3N0eXBlXCI6IDAsXHJcbiAgICAgICAgXCJDb21wYXJlXCI6IDBcclxuICAgICAgfVxyXG4gICAgXTtcclxuXHJcbiAgICAvLyDniLbot6/lvoTov4fmu6TvvIzlpoLmnpzkuLrnqbrvvIzliJnkuI3mt7vliqDvvIjlhbzlrrlvcmFjbGXlj5bmlbDvvIlcclxuICAgIGNvbnN0IHBhcmVudFBhdGggPSBwYXJlbnRIaWVyYXJjaHlJbmZvID8gcGFyZW50SGllcmFyY2h5SW5mb1sncGF0aCddIDogJyc7XHJcbiAgICBpZiAocGFyZW50UGF0aCkge1xyXG4gICAgICBwYXJlbnRGaWx0ZXJBcnJheS5wdXNoKHtcclxuICAgICAgICBcIkZpbHRlckZpZWxkXCI6IGAke29yaWdpbmFsSGllcmFyY2h5SW5mb0tleX0uUGF0aGAsXHJcbiAgICAgICAgXCJWYWx1ZVwiOiBwYXJlbnRQYXRoLFxyXG4gICAgICAgIFwiTGJyYWNrZXRcIjogbnVsbCxcclxuICAgICAgICBcIlJicmFja2V0XCI6IG51bGwsXHJcbiAgICAgICAgXCJSZWxhdGlvblwiOiByZWxhdGlvblR5cGUsXHJcbiAgICAgICAgXCJFeHByZXNzdHlwZVwiOiAwLFxyXG4gICAgICAgIFwiQ29tcGFyZVwiOiA3XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcGFyZW50RmlsdGVyQXJyYXlbMF0uUmVsYXRpb24gPSByZWxhdGlvblR5cGU7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHBhcmVudEZpbHRlckFycmF5LmNvbmNhdChmaWx0ZXJBcnJheSk7XHJcbiAgfVxyXG4gIHB1YmxpYyBidWlsZEVudGl0eUZpbHRlcihmaWx0ZXI6IGFueVtdLCBzb3J0OiBhbnlbXSwgcGFnZVNpemU6IG51bWJlciwgcGFnZUluZGV4OiBudW1iZXIpIHtcclxuXHJcbiAgICAvLyBAdG9kb++8muS4tOaXtuWFvOWuueiAgeS7o+egge+8jOmZjeS9juaUueWKqOW4puadpeeahOmjjumZqVxyXG4gICAgaWYgKCFmaWx0ZXIgJiYgIXNvcnQgJiYgIXBhZ2VTaXplICYmICFwYWdlSW5kZXgpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBpZiAoIWZpbHRlcikge1xyXG4gICAgICBmaWx0ZXIgPSBbXTtcclxuICAgIH1cclxuICAgIGlmICghc29ydCkge1xyXG4gICAgICBzb3J0ID0gW107XHJcbiAgICB9XHJcbiAgICAvLyDnuqDmraPmnIDlkI7kuIDkuKrov4fmu6TmnaHku7bnmoRSZWxhdGlvblxyXG4gICAgaWYgKGZpbHRlciAmJiBmaWx0ZXIubGVuZ3RoID4gMCkge1xyXG4gICAgICBmaWx0ZXJbZmlsdGVyLmxlbmd0aCAtIDFdLlJlbGF0aW9uID0gMDtcclxuICAgIH1cclxuICAgIGNvbnN0IGVudGl0eUZpbHRlciA9IHtcclxuICAgICAgRmlsdGVyQ29uZGl0aW9uczogZmlsdGVyLFxyXG4gICAgICBTb3J0Q29uZGl0aW9uczogc29ydCxcclxuICAgICAgSXNVc2VQYWdpbmF0aW9uOiBwYWdlU2l6ZSA9PT0gMCA/IGZhbHNlIDogdHJ1ZSxcclxuICAgICAgUGFnaW5hdGlvbjoge1xyXG4gICAgICAgIFBhZ2VJbmRleDogcGFnZUluZGV4LFxyXG4gICAgICAgIFBhZ2VTaXplOiBwYWdlU2l6ZSxcclxuICAgICAgICBQYWdlQ291bnQ6IDAsXHJcbiAgICAgICAgVG90YWxDb3VudDogMFxyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGVudGl0eUZpbHRlcjtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5riF56m65ZCO5Luj5a6e5L2TXHJcbiAgICovXHJcbiAgcHVibGljIGNsZWFyRGVzY2VuZGFudEVudGl0aWVzKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb2tleTogc3RyaW5nLCBwYXJlbnRIaWVyYXJjaHlJbmZvOiBhbnksIGZyb3plbkN1cnJlbnRSb3c6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xyXG5cclxuICAgIC8vIOa4heepuuagueiKgueCuVxyXG4gICAgaWYgKCFwYXJlbnRIaWVyYXJjaHlJbmZvKSB7XHJcbiAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5jbGVhcigpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBmUGF0aCA9IHBhcmVudEhpZXJhcmNoeUluZm8ucGF0aDtcclxuICAgIGNvbnN0IGZMYXllciA9IHBhcmVudEhpZXJhcmNoeUluZm8ubGF5ZXI7XHJcbiAgICBpZiAoZnJvemVuQ3VycmVudFJvdykge1xyXG4gICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24ucmVtb3ZlRGF0YSgoZW50aXR5OiBFbnRpdHkpID0+IHtcclxuICAgICAgICBjb25zdCBoaWVyYXJjaHlJbmZvID0gZW50aXR5W2hpZXJhcmNoeUluZm9rZXldO1xyXG4gICAgICAgIGNvbnN0IHBhdGggPSBoaWVyYXJjaHlJbmZvLnBhdGg7XHJcbiAgICAgICAgY29uc3QgbGF5ZXIgPSBoaWVyYXJjaHlJbmZvLmxheWVyO1xyXG4gICAgICAgIHJldHVybiBsYXllciA+IGZMYXllciAmJiBwYXRoLnN0YXJ0c1dpdGgoZlBhdGgpO1xyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5yZW1vdmVFbnRpdGllcygoZW50aXR5OiBFbnRpdHkpID0+IHtcclxuICAgICAgICBjb25zdCBoaWVyYXJjaHlJbmZvID0gZW50aXR5W2hpZXJhcmNoeUluZm9rZXldO1xyXG4gICAgICAgIGNvbnN0IHBhdGggPSBoaWVyYXJjaHlJbmZvLnBhdGg7XHJcbiAgICAgICAgY29uc3QgbGF5ZXIgPSBoaWVyYXJjaHlJbmZvLmxheWVyO1xyXG4gICAgICAgIHJldHVybiBsYXllciA+IGZMYXllciAmJiBwYXRoLnN0YXJ0c1dpdGgoZlBhdGgpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blrp7kvZPnmoTliIbnuqfkv6Hmga9cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0SGllcmFyY2h5SW5mb0J5SWQocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBoaWVyYXJjaHlJbmZva2V5OiBzdHJpbmcsIGlkOiBzdHJpbmcpOiBhbnkge1xyXG4gICAgaWYgKCFpZCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IGVudGl0eTogRW50aXR5ID0gcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0eUJ5SWQoaWQpO1xyXG4gICAgY29uc3QgaGllcmFyY2h5SW5mb0VudGl0eTogRW50aXR5ID0gZW50aXR5W2hpZXJhcmNoeUluZm9rZXldO1xyXG4gICAgcmV0dXJuIGhpZXJhcmNoeUluZm9FbnRpdHkudG9KU09OKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bliIbnuqfnoIHnmoTljp/lp4vnmoTlrZfmrrXlkI1cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0T3JpZ2luYWxIaWVyYXJjaHlJbmZvS2V5KHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb2tleTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IG5nT2JqZWN0cyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nT2JqZWN0cyhyZXBvc2l0b3J5LmVudGl0eVR5cGUpO1xyXG4gICAgY29uc3QgaGllcmFyY2h5SW5mb05nT2JqZWN0ID0gbmdPYmplY3RzW2hpZXJhcmNoeUluZm9rZXldO1xyXG4gICAgcmV0dXJuIGhpZXJhcmNoeUluZm9OZ09iamVjdC5vcmlnaW5hbERhdGFGaWVsZCBhcyBzdHJpbmc7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0UGFnaW5hdGlvbkluZm8ocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pIHtcclxuICAgIHJldHVybiByZXNwb25zZUluZm8gJiYgcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlICYmIHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZS5wYWdpbmF0aW9uIHx8IG51bGw7XHJcbiAgfVxyXG4gIHByaXZhdGUgZmluZFBhcmVudChoaWVyYXJjaHlJbmZvOiB7IGlzRGV0YWlsOiBib29sZWFuLCBsYXllcjogbnVtYmVyLCBwYXRoOiBzdHJpbmcgfSwgbGlzdDogYW55W10sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIGxpc3QuZmluZChpdGVtID0+IHtcclxuICAgICAgY29uc3QgY3VycmVudEhpZXJhcmNoeUluZm8gPSBpdGVtW2hpZXJhcmNoeUluZm9LZXldIGFzIHsgaXNEZXRhaWw6IGJvb2xlYW4sIGxheWVyOiBudW1iZXIsIHBhdGg6IHN0cmluZyB9O1xyXG4gICAgICByZXR1cm4gY3VycmVudEhpZXJhcmNoeUluZm8ubGF5ZXIgPT09IGhpZXJhcmNoeUluZm8ubGF5ZXIgLSAxICYmIGhpZXJhcmNoeUluZm8ucGF0aC5zdGFydHNXaXRoKGN1cnJlbnRIaWVyYXJjaHlJbmZvLnBhdGgpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0QWxsUGFyZW50SWRzKGhpZXJhcmNoeUluZm86IHsgaXNEZXRhaWw6IGJvb2xlYW4sIGxheWVyOiBudW1iZXIsIHBhdGg6IHN0cmluZyB9LCBsaXN0OiBhbnlbXSwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4pIHtcclxuICAgIGxldCBpdGVtID0gdGhpcy5maW5kUGFyZW50KGhpZXJhcmNoeUluZm8sIGxpc3QsIGhpZXJhcmNoeUluZm9LZXkpO1xyXG4gICAgY29uc3QgaWRzID0gW107XHJcbiAgICB3aGlsZSAoaXRlbSkge1xyXG4gICAgICBpZHMucHVzaChpdGVtW3JlcG9zaXRvcnkucHJpbWFyeUtleV0pO1xyXG4gICAgICBpdGVtID0gdGhpcy5maW5kUGFyZW50KGl0ZW1baGllcmFyY2h5SW5mb0tleV0sIGxpc3QsIGhpZXJhcmNoeUluZm9LZXkpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGlkcztcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRIaWVyYXJjaHlJbmZvKGVudGl0eTogRW50aXR5LCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcpOiB7IHBhdGg6IHN0cmluZywgbGF5ZXI6IG51bWJlciwgaXNEZXRhaWw6IGJvb2xlYW4gfSB7XHJcbiAgICByZXR1cm4gZW50aXR5W2hpZXJhcmNoeUluZm9LZXldO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmn6Xmib7oioLngrnkuIvmiYDmnInlrZDnuqfvvIjnrKzkuIDnuqfvvIlcclxuICAgKiBAcGFyYW0gcmVwb3NpdG9yeSByZXBvc2l0b3J5XHJcbiAgICogQHBhcmFtIGhpZXJhcmNoeUluZm9LZXkg5YiG57qn56CB5a2X5q61XHJcbiAgICogQHBhcmFtIGlkIGlkXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRDaGlsZHJlbihyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgaWQ6IHN0cmluZyk6IEVudGl0eVtdIHtcclxuICAgIGNvbnN0IGhpZXJhcmNoeUluZm8gPSB0aGlzLmdldEhpZXJhcmNoeUluZm9CeUlkKHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9LZXksIGlkKTtcclxuICAgIGlmICghaGllcmFyY2h5SW5mbykge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IGxheWVyID0gaGllcmFyY2h5SW5mby5sYXllcjtcclxuICAgIGNvbnN0IHBhdGggPSBoaWVyYXJjaHlJbmZvLnBhdGg7XHJcbiAgICBjb25zdCBlbnRpdGllczogRW50aXR5W10gPSByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXRpZXMoKGVudGl0eTogRW50aXR5KSA9PiB7XHJcbiAgICAgIGNvbnN0IGhpZXJhcmNoeUluZm8gPSB0aGlzLmdldEhpZXJhcmNoeUluZm8oZW50aXR5LCBoaWVyYXJjaHlJbmZvS2V5KTtcclxuICAgICAgY29uc3QgbWF0Y2hlZCA9IGhpZXJhcmNoeUluZm8ubGF5ZXIgPT09IGxheWVyICsgMSAmJiBoaWVyYXJjaHlJbmZvLnBhdGguc3RhcnRzV2l0aChwYXRoKTtcclxuICAgICAgaWYgKG1hdGNoZWQpIHtcclxuICAgICAgICByZXR1cm4gZW50aXR5O1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBlbnRpdGllcztcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IFBhdGhUcmVlUmVwb3NpdG9yeSB9O1xyXG4iXX0=