import * as tslib_1 from "tslib";
import { Injectable, Optional } from '@angular/core';
import { empty, of, from, EMPTY } from 'rxjs';
import { tap, map, switchMap, catchError } from 'rxjs/operators';
import { BeActionService } from './be-action.service';
import { FormMessageService } from './form-message.service';
import { FormNotifyService } from './form-notify.service';
import { LanguageService } from './languag.service';
import { FormLoadingService } from './form-loading/form-loading.service';
import { FormErrorService } from './error/form-error.service';
import { WFSubmiteService } from '@gsp-wf/rtdevkit';
import { WfTaskHandlerService } from '@gsp-wf/wf-task-handler';
import { FrameContext } from '@farris/devkit';
import { WFFlowchartService } from '@gsp-wf/ui-flowchart';
import { FormNotifyStrategyService } from './form-notify-strategy.service';
// tslint:disable: max-line-length
/**
 * 审批服务
 * @Scope FrameComponent
 */
var ApproveService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function ApproveService(formLoadingService, beActionService, msgService, notifyService, languageService, formErrorService, frameContext, submitter, flowchartService, wfTaskHandlerService) {
        this.formLoadingService = formLoadingService;
        this.beActionService = beActionService;
        this.msgService = msgService;
        this.notifyService = notifyService;
        this.languageService = languageService;
        this.formErrorService = formErrorService;
        this.frameContext = frameContext;
        this.submitter = submitter;
        this.flowchartService = flowchartService;
        this.wfTaskHandlerService = wfTaskHandlerService;
        if (this.frameContext) {
            this.repository = this.frameContext.repository;
            if (!this.wfTaskHandlerService) {
                this.wfTaskHandlerService = this.frameContext.injector.get(WfTaskHandlerService, null);
            }
        }
    }
    /**
     * 带有交互的提交审批
     */
    ApproveService.prototype.submitApproveWithInteraction = function (bizBillID) {
        return this.submitApprove(bizBillID);
    };
    /**
     * 提交审批
     * @param bizBillID 业务单据id
     * @param interactionResult 前端交互结果
     * @deprecated 已废弃，清使用包含入口单据的审批
     */
    ApproveService.prototype.submitApprove = function (bizBillID, interactionResult) {
        var _this = this;
        if (!bizBillID) {
            // this.msgService.error(this.languageService.unallowEmptyBizBillId);
            this.notifyService.info(this.languageService.unallowEmptyBizBillId, { hideTitle: true });
            return empty();
        }
        var actionUri = 'submittoapprovevoaction';
        var restService = this.beActionService.getRestService();
        var body = {
            requestInfo: restService.buildRequestInfo(),
            bizInstID: bizBillID,
            interactionResult: interactionResult ? {
                procDefId: interactionResult.processDefinitionId
            } : {}
        };
        this.formLoadingService.show();
        // 添加提示
        var action$ = this.beActionService.invokeAction(actionUri, 'PUT', null, null, body);
        // 目前包含三种情况：
        // 1. 第一次提交成功，服务端返回流程实例id
        // 2. 第一次提交成功，服务端返回流程实例id，并返回多个参与者，交互时提交参与者
        // 3. 第一次提交未成功，服务端返回多个流程定义，需要交互后第二次提交审批；第二次提交会出现情况1和情况2
        return action$.pipe(map(function (result) {
            if (result && result.returnValue && result.returnValue.excutionResponse) {
                var wfResponse = result.returnValue.excutionResponse;
                return wfResponse;
            }
        }), switchMap(function (response) {
            if (response && response.procInstId) {
                if (_this.repository) {
                    var updating$ = _this.repository.updateById(bizBillID);
                    return updating$.pipe(tap(function () {
                        _this.formLoadingService.hide();
                        // this.notifyService.info(this.languageService.submitSuccess);
                        FormNotifyStrategyService.success(_this.notifyService, _this.languageService.submitSuccess);
                    }), map(function () {
                        return response;
                    }));
                }
                else {
                    _this.formLoadingService.hide();
                    // this.notifyService.info(this.languageService.submitSuccess);
                    FormNotifyStrategyService.success(_this.notifyService, _this.languageService.submitSuccess);
                    return of(response);
                }
            }
            else {
                return of(response);
            }
        }), switchMap(function (response) {
            if (response.needInteraction) {
                return from(new Promise(function (resolve) {
                    _this.submitter.excute(response, function (interactionResponse) {
                        // 如果此次未提交，而选择后得到了流程定义ID，则在此提交审批
                        if (!response.procInstId && interactionResponse.processDefinitionId) {
                            _this.submitApprove(bizBillID, interactionResponse).subscribe(function () {
                                resolve();
                            });
                        }
                        else {
                            resolve();
                        }
                    });
                }));
            }
            else {
                return of(null);
            }
        }), catchError(function (error) {
            _this.formLoadingService.hide();
            // this.formErrorService.exception(this.languageService.submitFaild, error);
            return of(error);
        }));
    };
    /**
     * 提交审批(带入口单据)
     * @param bizBillID 业务单据Id
     * @param bizDefKey 入口单据Id
     * @param options options
     * @param interactionResult 交互结果
     */
    ApproveService.prototype.submitApproveWithBizDefKey = function (bizBillID, bizDefKey, options, interactionResult) {
        var _this = this;
        if (!bizBillID) {
            this.notifyService.warning(this.languageService.unallowEmptyBizBillId, { hideTitle: true });
            return EMPTY;
        }
        if (!bizDefKey) {
            this.notifyService.warning(this.languageService.bizDefKeyRequired, { hideTitle: true });
            return EMPTY;
        }
        try {
            if (options && typeof (options) === 'string') {
                options = JSON.parse(options);
            }
        }
        catch (e) {
            throw new Error('ArgumentError:options not a valid json string.');
        }
        var actionUri = 'submittoapprovewithpayload';
        var restService = this.beActionService.getRestService();
        var body = {
            requestInfo: restService.buildRequestInfo(),
            approvePayload: {
                startProcessPayload: {
                    bizDefKey: bizDefKey,
                    dataId: bizBillID,
                    name: options && options.name || '',
                    variables: options && options.variables || {}
                }
            }
        };
        if (interactionResult) {
            body.approvePayload.startProcessPayload.processDefinitionId = interactionResult.processDefinitionId;
            body.approvePayload.startProcessPayload.processDefinitionKey = interactionResult['processDefinitionKey'];
        }
        this.formLoadingService.show();
        // 添加提示
        var action$ = this.beActionService.invokeAction(actionUri, 'PUT', null, null, body);
        // 目前包含三种情况：
        // 1. 第一次提交成功，服务端返回流程实例id
        // 2. 第一次提交成功，服务端返回流程实例id，并返回多个参与者，交互时提交参与者
        // 3. 第一次提交未成功，服务端返回多个流程定义，需要交互后第二次提交审批；第二次提交会出现情况1和情况2
        return action$.pipe(map(function (result) {
            if (result && result.returnValue && result.returnValue.excutionResponse) {
                var wfResponse = result.returnValue.excutionResponse;
                return wfResponse;
            }
        }), switchMap(function (response) {
            if (response && response.procInstId) {
                if (_this.repository) {
                    var updating$ = _this.repository.updateById(bizBillID);
                    return updating$.pipe(tap(function () {
                        _this.formLoadingService.hide();
                        // this.notifyService.info(this.languageService.submitSuccess);
                        FormNotifyStrategyService.success(_this.notifyService, _this.languageService.submitSuccess);
                    }), map(function () {
                        return response;
                    }));
                }
                else {
                    _this.formLoadingService.hide();
                    // this.notifyService.info(this.languageService.submitSuccess);
                    FormNotifyStrategyService.success(_this.notifyService, _this.languageService.submitSuccess);
                    return of(response);
                }
            }
            else {
                return of(response);
            }
        }), switchMap(function (response) {
            if (response.needInteraction) {
                return from(new Promise(function (resolve) {
                    _this.submitter.excute(response, function (interactionResponse) {
                        // 如果此次未提交，而选择后得到了流程定义ID，则在此提交审批
                        if (!response.procInstId && interactionResponse.processDefinitionId) {
                            _this.submitApproveWithBizDefKey(bizBillID, bizDefKey, options, interactionResponse).subscribe(function () {
                                resolve();
                            });
                        }
                        else {
                            resolve();
                        }
                    });
                }));
            }
            else {
                return of(null);
            }
        }), catchError(function (error) {
            _this.formLoadingService.hide();
            // this.formErrorService.exception(this.languageService.submitFaild, error);
            return of(error);
        }));
    };
    /**
     * 提交审批(带入口单据使用wf控件)
     * @param bizBillID 业务单据Id
     * @param bizDefKey 入口单据Id
     * @param options 上下文参数
     * @param variables 可选参数
     */
    ApproveService.prototype.submitApproveWithBizDefKeyUseControl = function (bizBillID, bizDefKey, options, variables) {
        if (options === void 0) { options = {}; }
        if (!bizBillID) {
            this.notifyService.warning(this.languageService.unallowEmptyBizBillId, { hideTitle: true });
            return EMPTY;
        }
        if (!bizDefKey) {
            this.notifyService.warning(this.languageService.bizDefKeyRequired, { hideTitle: true });
            return EMPTY;
        }
        if (!options || typeof options !== 'object') {
            options = {};
        }
        var payload = tslib_1.__assign({ dataId: bizBillID, bizDefKey: bizDefKey }, options);
        // 处理variables参数
        if (variables) {
            if (variables.startsWith('{') && variables.endsWith('}')) {
                try {
                    variables = JSON.parse(variables);
                }
                catch (_a) {
                    variables = {};
                }
            }
            payload.variables = variables;
        }
        return this.wfTaskHandlerService && this.wfTaskHandlerService.startProcess(payload);
    };
    /**
     * 子表提交审批
     * @param bizDefKey 入口单据Id
     * @param bizId 业务单据Id（主表）
     * @param childBizId 业务单据Id（从表）
     * @param options 上下文参数
     * @param variables 可选参数
     */
    ApproveService.prototype.childSubmitApproveWithBizDefKey = function (bizDefKey, bizId, childBizId, options, variables) {
        if (options === void 0) { options = {}; }
        // 入口单据不能为空
        if (!bizDefKey) {
            this.notifyService.warning(this.languageService.bizDefKeyRequired, { hideTitle: true });
            return EMPTY;
        }
        // 主业务单据Id不能为空
        if (!bizId) {
            this.notifyService.warning(this.languageService.unallowEmptyBizBillId, { hideTitle: true });
            return EMPTY;
        }
        // 从表业务单据Id不能为空
        if (!childBizId) {
            this.notifyService.warning(this.languageService.unallowEmptyChildBizBillId, { hideTitle: true });
            return EMPTY;
        }
        if (!options || typeof options !== 'object') {
            options = {};
        }
        var payload = tslib_1.__assign({ dataId: bizId + "," + childBizId, bizDefKey: bizDefKey }, options);
        // 处理variables参数
        if (variables) {
            if (variables.startsWith('{') && variables.endsWith('}')) {
                try {
                    variables = JSON.parse(variables);
                }
                catch (_a) {
                    variables = {};
                }
            }
            payload.variables = variables;
        }
        return this.wfTaskHandlerService && this.wfTaskHandlerService.startProcess(payload);
    };
    /**
     * 取消审批
     * @deprecated 已废弃，请使用cancelSubmit
     */
    ApproveService.prototype.cancelApprove = function (bizBillID) {
        var _this = this;
        if (!bizBillID) {
            this.notifyService.warning(this.languageService.unallowEmptyBizBillId, { hideTitle: true });
            return empty();
        }
        var actionUri = 'canceltosubmitvoaction';
        var restService = this.beActionService.getRestService();
        var body = {
            requestInfo: restService.buildRequestInfo(),
            bizInstID: bizBillID,
        };
        this.formLoadingService.show();
        var action$ = this.beActionService.executeAction(actionUri, 'PUT', null, null, body);
        return action$.pipe(switchMap(function () {
            if (_this.repository) {
                var updating$ = _this.repository.updateById(bizBillID);
                return updating$.pipe(tap(function () {
                    _this.formLoadingService.hide();
                    // this.notifyService.info(this.languageService.cancelApproveSuccess);
                    FormNotifyStrategyService.success(_this.notifyService, _this.languageService.cancelApproveSuccess);
                }));
            }
            else {
                _this.formLoadingService.hide();
                // this.notifyService.info(this.languageService.cancelApproveSuccess);
                FormNotifyStrategyService.success(_this.notifyService, _this.languageService.cancelApproveSuccess);
                return of();
            }
        }), catchError(function (error) {
            _this.formLoadingService.hide();
            // this.formErrorService.exception(this.languageService.cancelApproveFailed, error);
            return of(error);
        }));
    };
    /**
     * 取消审批(支持主表、子表)
     * @param procInstId 流程实例Id
     */
    ApproveService.prototype.cancelSubmit = function (procInstId) {
        if (!procInstId) {
            this.notifyService.warning(this.languageService.procInsIdRequired, { hideTitle: true });
            return EMPTY;
        }
        return this.wfTaskHandlerService && this.wfTaskHandlerService.cancelSubmit({ procInstId: procInstId });
    };
    /**
     * 查看流程图
     * @param procInstId 流程实例ID
     */
    ApproveService.prototype.viewProcess = function (procInstId) {
        if (this.flowchartService) {
            if (!procInstId) {
                this.notifyService.warning(this.languageService.noProcessInstanceId, { hideTitle: true });
                return;
            }
            return this.flowchartService.viewFlowChart(procInstId);
        }
    };
    /**
     * 转换配置大小写
     * @param jsonObj Object
     * @deprecated
     */
    ApproveService.prototype.switchPrefixLetter = function (jsonObj, toUpper) {
        var e_1, _a;
        if (typeof (jsonObj) === 'object' && !!jsonObj) {
            if (Array.isArray(jsonObj)) {
                for (var i = 0; i < jsonObj.length; i++) {
                    this.switchPrefixLetter(jsonObj[i], toUpper);
                }
            }
            else {
                try {
                    for (var _b = tslib_1.__values(Object.keys(jsonObj)), _c = _b.next(); !_c.done; _c = _b.next()) {
                        var key = _c.value;
                        var newKey = (toUpper ? key.substring(0, 1).toUpperCase() : key.substring(0, 1).toLowerCase()) + key.substring(1);
                        jsonObj[newKey] = jsonObj[key];
                        if (typeof jsonObj[key] === 'object') {
                            this.switchPrefixLetter(jsonObj[key], toUpper);
                        }
                        delete (jsonObj[key]);
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
            }
        }
        return jsonObj;
    };
    ApproveService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ApproveService.ctorParameters = function () { return [
        { type: FormLoadingService },
        { type: BeActionService },
        { type: FormMessageService },
        { type: FormNotifyService },
        { type: LanguageService, decorators: [{ type: Optional }] },
        { type: FormErrorService },
        { type: FrameContext },
        { type: WFSubmiteService, decorators: [{ type: Optional }] },
        { type: WFFlowchartService, decorators: [{ type: Optional }] },
        { type: WfTaskHandlerService, decorators: [{ type: Optional }] }
    ]; };
    return ApproveService;
}());
export { ApproveService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwcm92ZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2FwcHJvdmUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFjLEtBQUssRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxRCxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDakUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzFELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUN6RSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQXlDLE1BQU0sa0JBQWtCLENBQUM7QUFDM0YsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFFL0QsT0FBTyxFQUFVLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzFELE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBRTNFLGtDQUFrQztBQUNsQzs7O0dBR0c7QUFDSDtJQVFFOztPQUVHO0lBQ0gsd0JBQ1Usa0JBQXNDLEVBQ3RDLGVBQWdDLEVBQ2hDLFVBQThCLEVBQzlCLGFBQWdDLEVBQ3BCLGVBQWdDLEVBQzVDLGdCQUFrQyxFQUNsQyxZQUEwQixFQUNkLFNBQTJCLEVBQzNCLGdCQUFvQyxFQUNwQyxvQkFBMEM7UUFUdEQsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QyxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDaEMsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7UUFDOUIsa0JBQWEsR0FBYixhQUFhLENBQW1CO1FBQ3BCLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUM1QyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQ2QsY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFDM0IscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFvQjtRQUNwQyx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBRTlELElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNyQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBbUMsQ0FBQztZQUN4RSxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixFQUFFO2dCQUM5QixJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLG9CQUFvQixFQUFFLElBQUksQ0FBQyxDQUFDO2FBQ3hGO1NBQ0Y7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxxREFBNEIsR0FBNUIsVUFBNkIsU0FBaUI7UUFDNUMsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILHNDQUFhLEdBQWIsVUFBYyxTQUFpQixFQUFFLGlCQUF1QztRQUF4RSxpQkFrRkM7UUFqRkMsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLHFFQUFxRTtZQUNyRSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLHFCQUFxQixFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7WUFDekYsT0FBTyxLQUFLLEVBQUUsQ0FBQztTQUNoQjtRQUVELElBQU0sU0FBUyxHQUFHLHlCQUF5QixDQUFDO1FBRTVDLElBQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsY0FBYyxFQUFFLENBQUM7UUFFMUQsSUFBTSxJQUFJLEdBQXdCO1lBQ2hDLFdBQVcsRUFBRSxXQUFXLENBQUMsZ0JBQWdCLEVBQUU7WUFDM0MsU0FBUyxFQUFFLFNBQVM7WUFDcEIsaUJBQWlCLEVBQUUsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO2dCQUNyQyxTQUFTLEVBQUUsaUJBQWlCLENBQUMsbUJBQW1CO2FBQ2pELENBQUMsQ0FBQyxDQUFDLEVBQUU7U0FDUCxDQUFDO1FBRUYsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxDQUFDO1FBRS9CLE9BQU87UUFDUCxJQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDdEYsWUFBWTtRQUNaLHlCQUF5QjtRQUN6QiwyQ0FBMkM7UUFDM0MsdURBQXVEO1FBRXZELE9BQU8sT0FBTyxDQUFDLElBQUksQ0FDakIsR0FBRyxDQUFDLFVBQUMsTUFBTTtZQUNULElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxXQUFXLElBQUksTUFBTSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRTtnQkFDdkUsSUFBSSxVQUFVLEdBQXFCLE1BQU0sQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUM7Z0JBQ3ZFLE9BQU8sVUFBVSxDQUFDO2FBQ25CO1FBQ0gsQ0FBQyxDQUFDLEVBQ0YsU0FBUyxDQUFDLFVBQUMsUUFBMEI7WUFDbkMsSUFBSSxRQUFRLElBQUksUUFBUSxDQUFDLFVBQVUsRUFBRTtnQkFDbkMsSUFBSSxLQUFJLENBQUMsVUFBVSxFQUFFO29CQUNuQixJQUFNLFNBQVMsR0FBRyxLQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQztvQkFDeEQsT0FBTyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQzt3QkFDeEIsS0FBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxDQUFDO3dCQUMvQiwrREFBK0Q7d0JBQy9ELHlCQUF5QixDQUFDLE9BQU8sQ0FBQyxLQUFJLENBQUMsYUFBYSxFQUFFLEtBQUksQ0FBQyxlQUFlLENBQUMsYUFBYSxDQUFDLENBQUM7b0JBQzVGLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQzt3QkFDTixPQUFPLFFBQVEsQ0FBQztvQkFDbEIsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDTDtxQkFBTTtvQkFDTCxLQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLENBQUM7b0JBQy9CLCtEQUErRDtvQkFDL0QseUJBQXlCLENBQUMsT0FBTyxDQUFDLEtBQUksQ0FBQyxhQUFhLEVBQUUsS0FBSSxDQUFDLGVBQWUsQ0FBQyxhQUFhLENBQUMsQ0FBQztvQkFDMUYsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7aUJBQ3JCO2FBQ0Y7aUJBQU07Z0JBQ0wsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDckI7UUFDSCxDQUFDLENBQUMsRUFDRixTQUFTLENBQUMsVUFBQyxRQUEwQjtZQUNuQyxJQUFJLFFBQVEsQ0FBQyxlQUFlLEVBQUU7Z0JBQzVCLE9BQU8sSUFBSSxDQUFDLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTztvQkFDOUIsS0FBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLFVBQUMsbUJBQXdDO3dCQUN2RSxnQ0FBZ0M7d0JBQ2hDLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxJQUFJLG1CQUFtQixDQUFDLG1CQUFtQixFQUFFOzRCQUNuRSxLQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDLFNBQVMsQ0FBQztnQ0FDM0QsT0FBTyxFQUFFLENBQUM7NEJBQ1osQ0FBQyxDQUFDLENBQUM7eUJBQ0o7NkJBQU07NEJBQ0wsT0FBTyxFQUFFLENBQUM7eUJBQ1g7b0JBQ0gsQ0FBQyxDQUFDLENBQUM7Z0JBQ0wsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUNMO2lCQUFNO2dCQUNMLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ2pCO1FBQ0gsQ0FBQyxDQUFDLEVBQ0YsVUFBVSxDQUNSLFVBQUEsS0FBSztZQUNILEtBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUMvQiw0RUFBNEU7WUFDNUUsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbkIsQ0FBQyxDQUNGLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFDRDs7Ozs7O09BTUc7SUFFSSxtREFBMEIsR0FBakMsVUFBa0MsU0FBaUIsRUFBRSxTQUFpQixFQUFFLE9BQWEsRUFBRSxpQkFBdUM7UUFBOUgsaUJBbUdDO1FBbEdDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDZCxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLHFCQUFxQixFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7WUFDNUYsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUNELElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDZCxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLGlCQUFpQixFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7WUFDeEYsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUNELElBQUk7WUFDRixJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssUUFBUSxFQUFFO2dCQUM1QyxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUMvQjtTQUNGO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixNQUFNLElBQUksS0FBSyxDQUFDLGdEQUFnRCxDQUFDLENBQUM7U0FDbkU7UUFFRCxJQUFNLFNBQVMsR0FBRyw0QkFBNEIsQ0FBQztRQUUvQyxJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBRTFELElBQU0sSUFBSSxHQUF3QjtZQUNoQyxXQUFXLEVBQUUsV0FBVyxDQUFDLGdCQUFnQixFQUFFO1lBQzNDLGNBQWMsRUFBRTtnQkFDZCxtQkFBbUIsRUFBRTtvQkFDbkIsU0FBUyxFQUFFLFNBQVM7b0JBQ3BCLE1BQU0sRUFBRSxTQUFTO29CQUNqQixJQUFJLEVBQUUsT0FBTyxJQUFJLE9BQU8sQ0FBQyxJQUFJLElBQUksRUFBRTtvQkFDbkMsU0FBUyxFQUFFLE9BQU8sSUFBSSxPQUFPLENBQUMsU0FBUyxJQUFJLEVBQUU7aUJBQzlDO2FBQ0Y7U0FDRixDQUFDO1FBQ0YsSUFBSSxpQkFBaUIsRUFBRTtZQUNyQixJQUFJLENBQUMsY0FBYyxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixHQUFHLGlCQUFpQixDQUFDLG1CQUFtQixDQUFDO1lBQ3BHLElBQUksQ0FBQyxjQUFjLENBQUMsbUJBQW1CLENBQUMsb0JBQW9CLEdBQUcsaUJBQWlCLENBQUMsc0JBQXNCLENBQUMsQ0FBQztTQUMxRztRQUNELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUUvQixPQUFPO1FBQ1AsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3RGLFlBQVk7UUFDWix5QkFBeUI7UUFDekIsMkNBQTJDO1FBQzNDLHVEQUF1RDtRQUV2RCxPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQ2pCLEdBQUcsQ0FBQyxVQUFDLE1BQU07WUFDVCxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsV0FBVyxJQUFJLE1BQU0sQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLEVBQUU7Z0JBQ3ZFLElBQU0sVUFBVSxHQUFxQixNQUFNLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDO2dCQUN6RSxPQUFPLFVBQVUsQ0FBQzthQUNuQjtRQUNILENBQUMsQ0FBQyxFQUNGLFNBQVMsQ0FBQyxVQUFDLFFBQTBCO1lBQ25DLElBQUksUUFBUSxJQUFJLFFBQVEsQ0FBQyxVQUFVLEVBQUU7Z0JBQ25DLElBQUksS0FBSSxDQUFDLFVBQVUsRUFBRTtvQkFDbkIsSUFBTSxTQUFTLEdBQUcsS0FBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUM7b0JBQ3hELE9BQU8sU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7d0JBQ3hCLEtBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQzt3QkFDL0IsK0RBQStEO3dCQUMvRCx5QkFBeUIsQ0FBQyxPQUFPLENBQUMsS0FBSSxDQUFDLGFBQWEsRUFBRSxLQUFJLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQyxDQUFDO29CQUM1RixDQUFDLENBQUMsRUFBRSxHQUFHLENBQUM7d0JBQ04sT0FBTyxRQUFRLENBQUM7b0JBQ2xCLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQ0w7cUJBQU07b0JBQ0wsS0FBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxDQUFDO29CQUMvQiwrREFBK0Q7b0JBQy9ELHlCQUF5QixDQUFDLE9BQU8sQ0FBQyxLQUFJLENBQUMsYUFBYSxFQUFFLEtBQUksQ0FBQyxlQUFlLENBQUMsYUFBYSxDQUFDLENBQUM7b0JBQzFGLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2lCQUNyQjthQUNGO2lCQUFNO2dCQUNMLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ3JCO1FBQ0gsQ0FBQyxDQUFDLEVBQ0YsU0FBUyxDQUFDLFVBQUMsUUFBMEI7WUFDbkMsSUFBSSxRQUFRLENBQUMsZUFBZSxFQUFFO2dCQUM1QixPQUFPLElBQUksQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU87b0JBQzlCLEtBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxVQUFDLG1CQUF3Qzt3QkFDdkUsZ0NBQWdDO3dCQUNoQyxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsSUFBSSxtQkFBbUIsQ0FBQyxtQkFBbUIsRUFBRTs0QkFDbkUsS0FBSSxDQUFDLDBCQUEwQixDQUFDLFNBQVMsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLG1CQUFtQixDQUFDLENBQUMsU0FBUyxDQUFDO2dDQUM1RixPQUFPLEVBQUUsQ0FBQzs0QkFDWixDQUFDLENBQUMsQ0FBQzt5QkFDSjs2QkFBTTs0QkFDTCxPQUFPLEVBQUUsQ0FBQzt5QkFDWDtvQkFDSCxDQUFDLENBQUMsQ0FBQztnQkFDTCxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ0w7aUJBQU07Z0JBQ0wsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDakI7UUFDSCxDQUFDLENBQUMsRUFDRixVQUFVLENBQ1IsVUFBQSxLQUFLO1lBQ0gsS0FBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxDQUFDO1lBQy9CLDRFQUE0RTtZQUM1RSxPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNuQixDQUFDLENBQ0YsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUNEOzs7Ozs7T0FNRztJQUNJLDZEQUFvQyxHQUEzQyxVQUE0QyxTQUFpQixFQUFFLFNBQWlCLEVBQUUsT0FBaUIsRUFBRSxTQUFlO1FBQWxDLHdCQUFBLEVBQUEsWUFBaUI7UUFDakcsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMscUJBQXFCLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUM1RixPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUN4RixPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBSSxDQUFDLE9BQU8sSUFBSSxPQUFPLE9BQU8sS0FBSyxRQUFRLEVBQUU7WUFDM0MsT0FBTyxHQUFHLEVBQUUsQ0FBQztTQUNkO1FBQ0QsSUFBTSxPQUFPLHNCQUNYLE1BQU0sRUFBRSxTQUFTLEVBQ2pCLFNBQVMsV0FBQSxJQUNOLE9BQU8sQ0FDWCxDQUFDO1FBQ0YsZ0JBQWdCO1FBQ2hCLElBQUksU0FBUyxFQUFFO1lBQ2IsSUFBSSxTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLFNBQVMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQ3hELElBQUk7b0JBQ0YsU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7aUJBQ25DO2dCQUFDLFdBQU07b0JBQ04sU0FBUyxHQUFHLEVBQUUsQ0FBQztpQkFDaEI7YUFDRjtZQUNELE9BQU8sQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1NBQy9CO1FBQ0QsT0FBTyxJQUFJLENBQUMsb0JBQW9CLElBQUksSUFBSSxDQUFDLG9CQUFvQixDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN0RixDQUFDO0lBQ0Q7Ozs7Ozs7T0FPRztJQUNJLHdEQUErQixHQUF0QyxVQUF1QyxTQUFpQixFQUFFLEtBQWEsRUFBRSxVQUFrQixFQUFFLE9BQWlCLEVBQUUsU0FBZTtRQUFsQyx3QkFBQSxFQUFBLFlBQWlCO1FBQzVHLFdBQVc7UUFDWCxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2QsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ3hGLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFDRCxjQUFjO1FBQ2QsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNWLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMscUJBQXFCLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUM1RixPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsZUFBZTtRQUNmLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDZixJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLDBCQUEwQixFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7WUFDakcsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUNELElBQUksQ0FBQyxPQUFPLElBQUksT0FBTyxPQUFPLEtBQUssUUFBUSxFQUFFO1lBQzNDLE9BQU8sR0FBRyxFQUFFLENBQUM7U0FDZDtRQUNELElBQU0sT0FBTyxzQkFDWCxNQUFNLEVBQUssS0FBSyxTQUFJLFVBQVksRUFDaEMsU0FBUyxXQUFBLElBQ04sT0FBTyxDQUNYLENBQUM7UUFDRixnQkFBZ0I7UUFDaEIsSUFBSSxTQUFTLEVBQUU7WUFDYixJQUFJLFNBQVMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksU0FBUyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDeEQsSUFBSTtvQkFDRixTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztpQkFDbkM7Z0JBQUMsV0FBTTtvQkFDTixTQUFTLEdBQUcsRUFBRSxDQUFDO2lCQUNoQjthQUNGO1lBQ0QsT0FBTyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7U0FDL0I7UUFDRCxPQUFPLElBQUksQ0FBQyxvQkFBb0IsSUFBSSxJQUFJLENBQUMsb0JBQW9CLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3RGLENBQUM7SUFDRDs7O09BR0c7SUFDSSxzQ0FBYSxHQUFwQixVQUFxQixTQUFpQjtRQUF0QyxpQkF3Q0M7UUF2Q0MsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMscUJBQXFCLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUM1RixPQUFPLEtBQUssRUFBRSxDQUFDO1NBQ2hCO1FBRUQsSUFBTSxTQUFTLEdBQUcsd0JBQXdCLENBQUM7UUFFM0MsSUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUUxRCxJQUFNLElBQUksR0FBRztZQUNYLFdBQVcsRUFBRSxXQUFXLENBQUMsZ0JBQWdCLEVBQUU7WUFDM0MsU0FBUyxFQUFFLFNBQVM7U0FDckIsQ0FBQztRQUVGLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUUvQixJQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDdkYsT0FBTyxPQUFPLENBQUMsSUFBSSxDQUNqQixTQUFTLENBQUM7WUFDUixJQUFJLEtBQUksQ0FBQyxVQUFVLEVBQUU7Z0JBQ25CLElBQU0sU0FBUyxHQUFHLEtBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUN4RCxPQUFPLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO29CQUN4QixLQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLENBQUM7b0JBQy9CLHNFQUFzRTtvQkFDdEUseUJBQXlCLENBQUMsT0FBTyxDQUFDLEtBQUksQ0FBQyxhQUFhLEVBQUUsS0FBSSxDQUFDLGVBQWUsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO2dCQUNuRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ0w7aUJBQU07Z0JBQ0wsS0FBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxDQUFDO2dCQUMvQixzRUFBc0U7Z0JBQ3RFLHlCQUF5QixDQUFDLE9BQU8sQ0FBQyxLQUFJLENBQUMsYUFBYSxFQUFFLEtBQUksQ0FBQyxlQUFlLENBQUMsb0JBQW9CLENBQUMsQ0FBQztnQkFDakcsT0FBTyxFQUFFLEVBQUUsQ0FBQzthQUNiO1FBQ0gsQ0FBQyxDQUNBLEVBQ0QsVUFBVSxDQUFDLFVBQUEsS0FBSztZQUNkLEtBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUMvQixvRkFBb0Y7WUFDcEYsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbkIsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNSLENBQUM7SUFDRDs7O09BR0c7SUFDSSxxQ0FBWSxHQUFuQixVQUFvQixVQUFrQjtRQUNwQyxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ2YsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ3hGLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFDRCxPQUFPLElBQUksQ0FBQyxvQkFBb0IsSUFBSSxJQUFJLENBQUMsb0JBQW9CLENBQUMsWUFBWSxDQUFDLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUM7SUFDekcsQ0FBQztJQUNEOzs7T0FHRztJQUNILG9DQUFXLEdBQVgsVUFBWSxVQUFrQjtRQUM1QixJQUFJLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtZQUN6QixJQUFJLENBQUMsVUFBVSxFQUFFO2dCQUNmLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsbUJBQW1CLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztnQkFDMUYsT0FBTzthQUNSO1lBQ0QsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQ3hEO0lBQ0gsQ0FBQztJQUdEOzs7O09BSUc7SUFDSywyQ0FBa0IsR0FBMUIsVUFBMkIsT0FBWSxFQUFFLE9BQWdCOztRQUN2RCxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxRQUFRLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRTtZQUM5QyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQzFCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUN2QyxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO2lCQUM5QzthQUNGO2lCQUFNOztvQkFDTCxLQUFrQixJQUFBLEtBQUEsaUJBQUEsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQSxnQkFBQSw0QkFBRTt3QkFBbkMsSUFBTSxHQUFHLFdBQUE7d0JBQ1osSUFBSSxNQUFNLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ2xILE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7d0JBQy9CLElBQUksT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssUUFBUSxFQUFFOzRCQUNwQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO3lCQUNoRDt3QkFDRCxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7cUJBQ3ZCOzs7Ozs7Ozs7YUFDRjtTQUNGO1FBQ0QsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQzs7Z0JBM1pGLFVBQVU7Ozs7Z0JBZEYsa0JBQWtCO2dCQUpsQixlQUFlO2dCQUNmLGtCQUFrQjtnQkFDbEIsaUJBQWlCO2dCQUNqQixlQUFlLHVCQStCbkIsUUFBUTtnQkE3QkosZ0JBQWdCO2dCQUlSLFlBQVk7Z0JBSHBCLGdCQUFnQix1QkErQnBCLFFBQVE7Z0JBM0JKLGtCQUFrQix1QkE0QnRCLFFBQVE7Z0JBL0JKLG9CQUFvQix1QkFnQ3hCLFFBQVE7O0lBdVliLHFCQUFDO0NBQUEsQUE1WkQsSUE0WkM7QUFDRCxPQUFPLEVBQUUsY0FBYyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBlbXB0eSwgb2YsIGZyb20sIEVNUFRZIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHRhcCwgbWFwLCBzd2l0Y2hNYXAsIGNhdGNoRXJyb3IgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEJlQWN0aW9uU2VydmljZSB9IGZyb20gJy4vYmUtYWN0aW9uLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGb3JtTWVzc2FnZVNlcnZpY2UgfSBmcm9tICcuL2Zvcm0tbWVzc2FnZS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRm9ybU5vdGlmeVNlcnZpY2UgfSBmcm9tICcuL2Zvcm0tbm90aWZ5LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuL2xhbmd1YWcuc2VydmljZSc7XHJcbmltcG9ydCB7IEZvcm1Mb2FkaW5nU2VydmljZSB9IGZyb20gJy4vZm9ybS1sb2FkaW5nL2Zvcm0tbG9hZGluZy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRm9ybUVycm9yU2VydmljZSB9IGZyb20gJy4vZXJyb3IvZm9ybS1lcnJvci5zZXJ2aWNlJztcclxuaW1wb3J0IHsgV0ZTdWJtaXRlU2VydmljZSwgSW50ZXJhY3Rpb25SZXNwb25zZSwgRXhjdXRpb25SZXNwb25zZSB9IGZyb20gJ0Bnc3Atd2YvcnRkZXZraXQnO1xyXG5pbXBvcnQgeyBXZlRhc2tIYW5kbGVyU2VydmljZSB9IGZyb20gJ0Bnc3Atd2Yvd2YtdGFzay1oYW5kbGVyJztcclxuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSB9IGZyb20gJ0BmYXJyaXMvYmVmJztcclxuaW1wb3J0IHsgRW50aXR5LCBGcmFtZUNvbnRleHQgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IFdGRmxvd2NoYXJ0U2VydmljZSB9IGZyb20gJ0Bnc3Atd2YvdWktZmxvd2NoYXJ0JztcclxuaW1wb3J0IHsgRm9ybU5vdGlmeVN0cmF0ZWd5U2VydmljZSB9IGZyb20gJy4vZm9ybS1ub3RpZnktc3RyYXRlZ3kuc2VydmljZSc7XHJcbmltcG9ydCB7IEJvZHlXaXRoUmVxdWVzdEluZm8gfSBmcm9tICcuLy4uL2xpYi90eXBlcyc7XHJcbi8vIHRzbGludDpkaXNhYmxlOiBtYXgtbGluZS1sZW5ndGhcclxuLyoqXHJcbiAqIOWuoeaJueacjeWKoVxyXG4gKiBAU2NvcGUgRnJhbWVDb21wb25lbnRcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuY2xhc3MgQXBwcm92ZVNlcnZpY2Uge1xyXG5cclxuICAvKipcclxuICAgKiDlrp7kvZPku5PlupNcclxuICAgKi9cclxuICBwcml2YXRlIHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PjtcclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGZvcm1Mb2FkaW5nU2VydmljZTogRm9ybUxvYWRpbmdTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBiZUFjdGlvblNlcnZpY2U6IEJlQWN0aW9uU2VydmljZSxcclxuICAgIHByaXZhdGUgbXNnU2VydmljZTogRm9ybU1lc3NhZ2VTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBub3RpZnlTZXJ2aWNlOiBGb3JtTm90aWZ5U2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGZvcm1FcnJvclNlcnZpY2U6IEZvcm1FcnJvclNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBzdWJtaXR0ZXI6IFdGU3VibWl0ZVNlcnZpY2UsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGZsb3djaGFydFNlcnZpY2U6IFdGRmxvd2NoYXJ0U2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgd2ZUYXNrSGFuZGxlclNlcnZpY2U6IFdmVGFza0hhbmRsZXJTZXJ2aWNlXHJcbiAgKSB7XHJcbiAgICBpZiAodGhpcy5mcmFtZUNvbnRleHQpIHtcclxuICAgICAgdGhpcy5yZXBvc2l0b3J5ID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PEVudGl0eT47XHJcbiAgICAgIGlmICghdGhpcy53ZlRhc2tIYW5kbGVyU2VydmljZSkge1xyXG4gICAgICAgIHRoaXMud2ZUYXNrSGFuZGxlclNlcnZpY2UgPSB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQoV2ZUYXNrSGFuZGxlclNlcnZpY2UsIG51bGwpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDluKbmnInkuqTkupLnmoTmj5DkuqTlrqHmiblcclxuICAgKi9cclxuICBzdWJtaXRBcHByb3ZlV2l0aEludGVyYWN0aW9uKGJpekJpbGxJRDogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gdGhpcy5zdWJtaXRBcHByb3ZlKGJpekJpbGxJRCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmj5DkuqTlrqHmiblcclxuICAgKiBAcGFyYW0gYml6QmlsbElEIOS4muWKoeWNleaNrmlkXHJcbiAgICogQHBhcmFtIGludGVyYWN0aW9uUmVzdWx0IOWJjeerr+S6pOS6kue7k+aenFxyXG4gICAqIEBkZXByZWNhdGVkIOW3suW6n+W8g++8jOa4heS9v+eUqOWMheWQq+WFpeWPo+WNleaNrueahOWuoeaJuVxyXG4gICAqL1xyXG4gIHN1Ym1pdEFwcHJvdmUoYml6QmlsbElEOiBzdHJpbmcsIGludGVyYWN0aW9uUmVzdWx0PzogSW50ZXJhY3Rpb25SZXNwb25zZSk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBpZiAoIWJpekJpbGxJRCkge1xyXG4gICAgICAvLyB0aGlzLm1zZ1NlcnZpY2UuZXJyb3IodGhpcy5sYW5ndWFnZVNlcnZpY2UudW5hbGxvd0VtcHR5Qml6QmlsbElkKTtcclxuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLmluZm8odGhpcy5sYW5ndWFnZVNlcnZpY2UudW5hbGxvd0VtcHR5Qml6QmlsbElkLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIGVtcHR5KCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgYWN0aW9uVXJpID0gJ3N1Ym1pdHRvYXBwcm92ZXZvYWN0aW9uJztcclxuXHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHRoaXMuYmVBY3Rpb25TZXJ2aWNlLmdldFJlc3RTZXJ2aWNlKCk7XHJcblxyXG4gICAgY29uc3QgYm9keTogQm9keVdpdGhSZXF1ZXN0SW5mbyA9IHtcclxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKSxcclxuICAgICAgYml6SW5zdElEOiBiaXpCaWxsSUQsXHJcbiAgICAgIGludGVyYWN0aW9uUmVzdWx0OiBpbnRlcmFjdGlvblJlc3VsdCA/IHtcclxuICAgICAgICBwcm9jRGVmSWQ6IGludGVyYWN0aW9uUmVzdWx0LnByb2Nlc3NEZWZpbml0aW9uSWRcclxuICAgICAgfSA6IHt9XHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMuZm9ybUxvYWRpbmdTZXJ2aWNlLnNob3coKTtcclxuXHJcbiAgICAvLyDmt7vliqDmj5DnpLpcclxuICAgIGNvbnN0IGFjdGlvbiQgPSB0aGlzLmJlQWN0aW9uU2VydmljZS5pbnZva2VBY3Rpb24oYWN0aW9uVXJpLCAnUFVUJywgbnVsbCwgbnVsbCwgYm9keSk7XHJcbiAgICAvLyDnm67liY3ljIXlkKvkuInnp43mg4XlhrXvvJpcclxuICAgIC8vIDEuIOesrOS4gOasoeaPkOS6pOaIkOWKn++8jOacjeWKoeerr+i/lOWbnua1geeoi+WunuS+i2lkXHJcbiAgICAvLyAyLiDnrKzkuIDmrKHmj5DkuqTmiJDlip/vvIzmnI3liqHnq6/ov5Tlm57mtYHnqIvlrp7kvotpZO+8jOW5tui/lOWbnuWkmuS4quWPguS4juiAhe+8jOS6pOS6kuaXtuaPkOS6pOWPguS4juiAhVxyXG4gICAgLy8gMy4g56ys5LiA5qyh5o+Q5Lqk5pyq5oiQ5Yqf77yM5pyN5Yqh56uv6L+U5Zue5aSa5Liq5rWB56iL5a6a5LmJ77yM6ZyA6KaB5Lqk5LqS5ZCO56ys5LqM5qyh5o+Q5Lqk5a6h5om577yb56ys5LqM5qyh5o+Q5Lqk5Lya5Ye6546w5oOF5Ya1MeWSjOaDheWGtTJcclxuXHJcbiAgICByZXR1cm4gYWN0aW9uJC5waXBlKFxyXG4gICAgICBtYXAoKHJlc3VsdCk6IEV4Y3V0aW9uUmVzcG9uc2UgPT4ge1xyXG4gICAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LnJldHVyblZhbHVlICYmIHJlc3VsdC5yZXR1cm5WYWx1ZS5leGN1dGlvblJlc3BvbnNlKSB7XHJcbiAgICAgICAgICB2YXIgd2ZSZXNwb25zZTogRXhjdXRpb25SZXNwb25zZSA9IHJlc3VsdC5yZXR1cm5WYWx1ZS5leGN1dGlvblJlc3BvbnNlO1xyXG4gICAgICAgICAgcmV0dXJuIHdmUmVzcG9uc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KSxcclxuICAgICAgc3dpdGNoTWFwKChyZXNwb25zZTogRXhjdXRpb25SZXNwb25zZSkgPT4ge1xyXG4gICAgICAgIGlmIChyZXNwb25zZSAmJiByZXNwb25zZS5wcm9jSW5zdElkKSB7XHJcbiAgICAgICAgICBpZiAodGhpcy5yZXBvc2l0b3J5KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHVwZGF0aW5nJCA9IHRoaXMucmVwb3NpdG9yeS51cGRhdGVCeUlkKGJpekJpbGxJRCk7XHJcbiAgICAgICAgICAgIHJldHVybiB1cGRhdGluZyQucGlwZSh0YXAoKCkgPT4ge1xyXG4gICAgICAgICAgICAgIHRoaXMuZm9ybUxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgICAgICAgICAvLyB0aGlzLm5vdGlmeVNlcnZpY2UuaW5mbyh0aGlzLmxhbmd1YWdlU2VydmljZS5zdWJtaXRTdWNjZXNzKTtcclxuICAgICAgICAgICAgICBGb3JtTm90aWZ5U3RyYXRlZ3lTZXJ2aWNlLnN1Y2Nlc3ModGhpcy5ub3RpZnlTZXJ2aWNlLCB0aGlzLmxhbmd1YWdlU2VydmljZS5zdWJtaXRTdWNjZXNzKTtcclxuICAgICAgICAgICAgfSksIG1hcCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmZvcm1Mb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgICAgICAgIC8vIHRoaXMubm90aWZ5U2VydmljZS5pbmZvKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnN1Ym1pdFN1Y2Nlc3MpO1xyXG4gICAgICAgICAgICBGb3JtTm90aWZ5U3RyYXRlZ3lTZXJ2aWNlLnN1Y2Nlc3ModGhpcy5ub3RpZnlTZXJ2aWNlLCB0aGlzLmxhbmd1YWdlU2VydmljZS5zdWJtaXRTdWNjZXNzKTtcclxuICAgICAgICAgICAgcmV0dXJuIG9mKHJlc3BvbnNlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIG9mKHJlc3BvbnNlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pLFxyXG4gICAgICBzd2l0Y2hNYXAoKHJlc3BvbnNlOiBFeGN1dGlvblJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgaWYgKHJlc3BvbnNlLm5lZWRJbnRlcmFjdGlvbikge1xyXG4gICAgICAgICAgcmV0dXJuIGZyb20obmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5zdWJtaXR0ZXIuZXhjdXRlKHJlc3BvbnNlLCAoaW50ZXJhY3Rpb25SZXNwb25zZTogSW50ZXJhY3Rpb25SZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgICAgIC8vIOWmguaenOatpOasoeacquaPkOS6pO+8jOiAjOmAieaLqeWQjuW+l+WIsOS6hua1geeoi+WumuS5iUlE77yM5YiZ5Zyo5q2k5o+Q5Lqk5a6h5om5XHJcbiAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZS5wcm9jSW5zdElkICYmIGludGVyYWN0aW9uUmVzcG9uc2UucHJvY2Vzc0RlZmluaXRpb25JZCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdWJtaXRBcHByb3ZlKGJpekJpbGxJRCwgaW50ZXJhY3Rpb25SZXNwb25zZSkuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfSkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gb2YobnVsbCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KSxcclxuICAgICAgY2F0Y2hFcnJvcihcclxuICAgICAgICBlcnJvciA9PiB7XHJcbiAgICAgICAgICB0aGlzLmZvcm1Mb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgICAgICAvLyB0aGlzLmZvcm1FcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnN1Ym1pdEZhaWxkLCBlcnJvcik7XHJcbiAgICAgICAgICByZXR1cm4gb2YoZXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5o+Q5Lqk5a6h5om5KOW4puWFpeWPo+WNleaNrilcclxuICAgKiBAcGFyYW0gYml6QmlsbElEIOS4muWKoeWNleaNrklkXHJcbiAgICogQHBhcmFtIGJpekRlZktleSDlhaXlj6PljZXmja5JZFxyXG4gICAqIEBwYXJhbSBvcHRpb25zIG9wdGlvbnNcclxuICAgKiBAcGFyYW0gaW50ZXJhY3Rpb25SZXN1bHQg5Lqk5LqS57uT5p6cXHJcbiAgICovXHJcblxyXG4gIHB1YmxpYyBzdWJtaXRBcHByb3ZlV2l0aEJpekRlZktleShiaXpCaWxsSUQ6IHN0cmluZywgYml6RGVmS2V5OiBzdHJpbmcsIG9wdGlvbnM/OiBhbnksIGludGVyYWN0aW9uUmVzdWx0PzogSW50ZXJhY3Rpb25SZXNwb25zZSk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBpZiAoIWJpekJpbGxJRCkge1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS51bmFsbG93RW1wdHlCaXpCaWxsSWQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcbiAgICBpZiAoIWJpekRlZktleSkge1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5iaXpEZWZLZXlSZXF1aXJlZCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIHRyeSB7XHJcbiAgICAgIGlmIChvcHRpb25zICYmIHR5cGVvZiAob3B0aW9ucykgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgb3B0aW9ucyA9IEpTT04ucGFyc2Uob3B0aW9ucyk7XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdBcmd1bWVudEVycm9yOm9wdGlvbnMgbm90IGEgdmFsaWQganNvbiBzdHJpbmcuJyk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgYWN0aW9uVXJpID0gJ3N1Ym1pdHRvYXBwcm92ZXdpdGhwYXlsb2FkJztcclxuXHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHRoaXMuYmVBY3Rpb25TZXJ2aWNlLmdldFJlc3RTZXJ2aWNlKCk7XHJcblxyXG4gICAgY29uc3QgYm9keTogQm9keVdpdGhSZXF1ZXN0SW5mbyA9IHtcclxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKSxcclxuICAgICAgYXBwcm92ZVBheWxvYWQ6IHtcclxuICAgICAgICBzdGFydFByb2Nlc3NQYXlsb2FkOiB7XHJcbiAgICAgICAgICBiaXpEZWZLZXk6IGJpekRlZktleSxcclxuICAgICAgICAgIGRhdGFJZDogYml6QmlsbElELFxyXG4gICAgICAgICAgbmFtZTogb3B0aW9ucyAmJiBvcHRpb25zLm5hbWUgfHwgJycsXHJcbiAgICAgICAgICB2YXJpYWJsZXM6IG9wdGlvbnMgJiYgb3B0aW9ucy52YXJpYWJsZXMgfHwge31cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICBpZiAoaW50ZXJhY3Rpb25SZXN1bHQpIHtcclxuICAgICAgYm9keS5hcHByb3ZlUGF5bG9hZC5zdGFydFByb2Nlc3NQYXlsb2FkLnByb2Nlc3NEZWZpbml0aW9uSWQgPSBpbnRlcmFjdGlvblJlc3VsdC5wcm9jZXNzRGVmaW5pdGlvbklkO1xyXG4gICAgICBib2R5LmFwcHJvdmVQYXlsb2FkLnN0YXJ0UHJvY2Vzc1BheWxvYWQucHJvY2Vzc0RlZmluaXRpb25LZXkgPSBpbnRlcmFjdGlvblJlc3VsdFsncHJvY2Vzc0RlZmluaXRpb25LZXknXTtcclxuICAgIH1cclxuICAgIHRoaXMuZm9ybUxvYWRpbmdTZXJ2aWNlLnNob3coKTtcclxuXHJcbiAgICAvLyDmt7vliqDmj5DnpLpcclxuICAgIGNvbnN0IGFjdGlvbiQgPSB0aGlzLmJlQWN0aW9uU2VydmljZS5pbnZva2VBY3Rpb24oYWN0aW9uVXJpLCAnUFVUJywgbnVsbCwgbnVsbCwgYm9keSk7XHJcbiAgICAvLyDnm67liY3ljIXlkKvkuInnp43mg4XlhrXvvJpcclxuICAgIC8vIDEuIOesrOS4gOasoeaPkOS6pOaIkOWKn++8jOacjeWKoeerr+i/lOWbnua1geeoi+WunuS+i2lkXHJcbiAgICAvLyAyLiDnrKzkuIDmrKHmj5DkuqTmiJDlip/vvIzmnI3liqHnq6/ov5Tlm57mtYHnqIvlrp7kvotpZO+8jOW5tui/lOWbnuWkmuS4quWPguS4juiAhe+8jOS6pOS6kuaXtuaPkOS6pOWPguS4juiAhVxyXG4gICAgLy8gMy4g56ys5LiA5qyh5o+Q5Lqk5pyq5oiQ5Yqf77yM5pyN5Yqh56uv6L+U5Zue5aSa5Liq5rWB56iL5a6a5LmJ77yM6ZyA6KaB5Lqk5LqS5ZCO56ys5LqM5qyh5o+Q5Lqk5a6h5om577yb56ys5LqM5qyh5o+Q5Lqk5Lya5Ye6546w5oOF5Ya1MeWSjOaDheWGtTJcclxuXHJcbiAgICByZXR1cm4gYWN0aW9uJC5waXBlKFxyXG4gICAgICBtYXAoKHJlc3VsdCk6IEV4Y3V0aW9uUmVzcG9uc2UgPT4ge1xyXG4gICAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LnJldHVyblZhbHVlICYmIHJlc3VsdC5yZXR1cm5WYWx1ZS5leGN1dGlvblJlc3BvbnNlKSB7XHJcbiAgICAgICAgICBjb25zdCB3ZlJlc3BvbnNlOiBFeGN1dGlvblJlc3BvbnNlID0gcmVzdWx0LnJldHVyblZhbHVlLmV4Y3V0aW9uUmVzcG9uc2U7XHJcbiAgICAgICAgICByZXR1cm4gd2ZSZXNwb25zZTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pLFxyXG4gICAgICBzd2l0Y2hNYXAoKHJlc3BvbnNlOiBFeGN1dGlvblJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgaWYgKHJlc3BvbnNlICYmIHJlc3BvbnNlLnByb2NJbnN0SWQpIHtcclxuICAgICAgICAgIGlmICh0aGlzLnJlcG9zaXRvcnkpIHtcclxuICAgICAgICAgICAgY29uc3QgdXBkYXRpbmckID0gdGhpcy5yZXBvc2l0b3J5LnVwZGF0ZUJ5SWQoYml6QmlsbElEKTtcclxuICAgICAgICAgICAgcmV0dXJuIHVwZGF0aW5nJC5waXBlKHRhcCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgdGhpcy5mb3JtTG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xyXG4gICAgICAgICAgICAgIC8vIHRoaXMubm90aWZ5U2VydmljZS5pbmZvKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnN1Ym1pdFN1Y2Nlc3MpO1xyXG4gICAgICAgICAgICAgIEZvcm1Ob3RpZnlTdHJhdGVneVNlcnZpY2Uuc3VjY2Vzcyh0aGlzLm5vdGlmeVNlcnZpY2UsIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnN1Ym1pdFN1Y2Nlc3MpO1xyXG4gICAgICAgICAgICB9KSwgbWFwKCgpID0+IHtcclxuICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7XHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZm9ybUxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgICAgICAgLy8gdGhpcy5ub3RpZnlTZXJ2aWNlLmluZm8odGhpcy5sYW5ndWFnZVNlcnZpY2Uuc3VibWl0U3VjY2Vzcyk7XHJcbiAgICAgICAgICAgIEZvcm1Ob3RpZnlTdHJhdGVneVNlcnZpY2Uuc3VjY2Vzcyh0aGlzLm5vdGlmeVNlcnZpY2UsIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnN1Ym1pdFN1Y2Nlc3MpO1xyXG4gICAgICAgICAgICByZXR1cm4gb2YocmVzcG9uc2UpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gb2YocmVzcG9uc2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSksXHJcbiAgICAgIHN3aXRjaE1hcCgocmVzcG9uc2U6IEV4Y3V0aW9uUmVzcG9uc2UpID0+IHtcclxuICAgICAgICBpZiAocmVzcG9uc2UubmVlZEludGVyYWN0aW9uKSB7XHJcbiAgICAgICAgICByZXR1cm4gZnJvbShuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnN1Ym1pdHRlci5leGN1dGUocmVzcG9uc2UsIChpbnRlcmFjdGlvblJlc3BvbnNlOiBJbnRlcmFjdGlvblJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgLy8g5aaC5p6c5q2k5qyh5pyq5o+Q5Lqk77yM6ICM6YCJ5oup5ZCO5b6X5Yiw5LqG5rWB56iL5a6a5LmJSUTvvIzliJnlnKjmraTmj5DkuqTlrqHmiblcclxuICAgICAgICAgICAgICBpZiAoIXJlc3BvbnNlLnByb2NJbnN0SWQgJiYgaW50ZXJhY3Rpb25SZXNwb25zZS5wcm9jZXNzRGVmaW5pdGlvbklkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN1Ym1pdEFwcHJvdmVXaXRoQml6RGVmS2V5KGJpekJpbGxJRCwgYml6RGVmS2V5LCBvcHRpb25zLCBpbnRlcmFjdGlvblJlc3BvbnNlKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9KSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBvZihudWxsKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pLFxyXG4gICAgICBjYXRjaEVycm9yKFxyXG4gICAgICAgIGVycm9yID0+IHtcclxuICAgICAgICAgIHRoaXMuZm9ybUxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgICAgIC8vIHRoaXMuZm9ybUVycm9yU2VydmljZS5leGNlcHRpb24odGhpcy5sYW5ndWFnZVNlcnZpY2Uuc3VibWl0RmFpbGQsIGVycm9yKTtcclxuICAgICAgICAgIHJldHVybiBvZihlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmj5DkuqTlrqHmibko5bim5YWl5Y+j5Y2V5o2u5L2/55Sod2bmjqfku7YpXHJcbiAgICogQHBhcmFtIGJpekJpbGxJRCDkuJrliqHljZXmja5JZFxyXG4gICAqIEBwYXJhbSBiaXpEZWZLZXkg5YWl5Y+j5Y2V5o2uSWRcclxuICAgKiBAcGFyYW0gb3B0aW9ucyDkuIrkuIvmloflj4LmlbBcclxuICAgKiBAcGFyYW0gdmFyaWFibGVzIOWPr+mAieWPguaVsFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdWJtaXRBcHByb3ZlV2l0aEJpekRlZktleVVzZUNvbnRyb2woYml6QmlsbElEOiBzdHJpbmcsIGJpekRlZktleTogc3RyaW5nLCBvcHRpb25zOiBhbnkgPSB7fSwgdmFyaWFibGVzPzogYW55KSB7XHJcbiAgICBpZiAoIWJpekJpbGxJRCkge1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS51bmFsbG93RW1wdHlCaXpCaWxsSWQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcbiAgICBpZiAoIWJpekRlZktleSkge1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5iaXpEZWZLZXlSZXF1aXJlZCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIGlmICghb3B0aW9ucyB8fCB0eXBlb2Ygb3B0aW9ucyAhPT0gJ29iamVjdCcpIHtcclxuICAgICAgb3B0aW9ucyA9IHt9O1xyXG4gICAgfVxyXG4gICAgY29uc3QgcGF5bG9hZDogYW55ID0ge1xyXG4gICAgICBkYXRhSWQ6IGJpekJpbGxJRCxcclxuICAgICAgYml6RGVmS2V5LFxyXG4gICAgICAuLi5vcHRpb25zXHJcbiAgICB9O1xyXG4gICAgLy8g5aSE55CGdmFyaWFibGVz5Y+C5pWwXHJcbiAgICBpZiAodmFyaWFibGVzKSB7XHJcbiAgICAgIGlmICh2YXJpYWJsZXMuc3RhcnRzV2l0aCgneycpICYmIHZhcmlhYmxlcy5lbmRzV2l0aCgnfScpKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIHZhcmlhYmxlcyA9IEpTT04ucGFyc2UodmFyaWFibGVzKTtcclxuICAgICAgICB9IGNhdGNoIHtcclxuICAgICAgICAgIHZhcmlhYmxlcyA9IHt9O1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBwYXlsb2FkLnZhcmlhYmxlcyA9IHZhcmlhYmxlcztcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLndmVGFza0hhbmRsZXJTZXJ2aWNlICYmIHRoaXMud2ZUYXNrSGFuZGxlclNlcnZpY2Uuc3RhcnRQcm9jZXNzKHBheWxvYWQpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlrZDooajmj5DkuqTlrqHmiblcclxuICAgKiBAcGFyYW0gYml6RGVmS2V5IOWFpeWPo+WNleaNrklkXHJcbiAgICogQHBhcmFtIGJpeklkIOS4muWKoeWNleaNrklk77yI5Li76KGo77yJXHJcbiAgICogQHBhcmFtIGNoaWxkQml6SWQg5Lia5Yqh5Y2V5o2uSWTvvIjku47ooajvvIlcclxuICAgKiBAcGFyYW0gb3B0aW9ucyDkuIrkuIvmloflj4LmlbBcclxuICAgKiBAcGFyYW0gdmFyaWFibGVzIOWPr+mAieWPguaVsFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjaGlsZFN1Ym1pdEFwcHJvdmVXaXRoQml6RGVmS2V5KGJpekRlZktleTogc3RyaW5nLCBiaXpJZDogc3RyaW5nLCBjaGlsZEJpeklkOiBzdHJpbmcsIG9wdGlvbnM6IGFueSA9IHt9LCB2YXJpYWJsZXM/OiBhbnkpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgLy8g5YWl5Y+j5Y2V5o2u5LiN6IO95Li656m6XHJcbiAgICBpZiAoIWJpekRlZktleSkge1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5iaXpEZWZLZXlSZXF1aXJlZCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIC8vIOS4u+S4muWKoeWNleaNrklk5LiN6IO95Li656m6XHJcbiAgICBpZiAoIWJpeklkKSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnVuYWxsb3dFbXB0eUJpekJpbGxJZCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIC8vIOS7juihqOS4muWKoeWNleaNrklk5LiN6IO95Li656m6XHJcbiAgICBpZiAoIWNoaWxkQml6SWQpIHtcclxuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UudW5hbGxvd0VtcHR5Q2hpbGRCaXpCaWxsSWQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcbiAgICBpZiAoIW9wdGlvbnMgfHwgdHlwZW9mIG9wdGlvbnMgIT09ICdvYmplY3QnKSB7XHJcbiAgICAgIG9wdGlvbnMgPSB7fTtcclxuICAgIH1cclxuICAgIGNvbnN0IHBheWxvYWQ6IGFueSA9IHtcclxuICAgICAgZGF0YUlkOiBgJHtiaXpJZH0sJHtjaGlsZEJpeklkfWAsXHJcbiAgICAgIGJpekRlZktleSxcclxuICAgICAgLi4ub3B0aW9uc1xyXG4gICAgfTtcclxuICAgIC8vIOWkhOeQhnZhcmlhYmxlc+WPguaVsFxyXG4gICAgaWYgKHZhcmlhYmxlcykge1xyXG4gICAgICBpZiAodmFyaWFibGVzLnN0YXJ0c1dpdGgoJ3snKSAmJiB2YXJpYWJsZXMuZW5kc1dpdGgoJ30nKSkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICB2YXJpYWJsZXMgPSBKU09OLnBhcnNlKHZhcmlhYmxlcyk7XHJcbiAgICAgICAgfSBjYXRjaCB7XHJcbiAgICAgICAgICB2YXJpYWJsZXMgPSB7fTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcGF5bG9hZC52YXJpYWJsZXMgPSB2YXJpYWJsZXM7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy53ZlRhc2tIYW5kbGVyU2VydmljZSAmJiB0aGlzLndmVGFza0hhbmRsZXJTZXJ2aWNlLnN0YXJ0UHJvY2VzcyhwYXlsb2FkKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Y+W5raI5a6h5om5XHJcbiAgICogQGRlcHJlY2F0ZWQg5bey5bqf5byD77yM6K+35L2/55SoY2FuY2VsU3VibWl0XHJcbiAgICovXHJcbiAgcHVibGljIGNhbmNlbEFwcHJvdmUoYml6QmlsbElEOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgaWYgKCFiaXpCaWxsSUQpIHtcclxuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UudW5hbGxvd0VtcHR5Qml6QmlsbElkLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIGVtcHR5KCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgYWN0aW9uVXJpID0gJ2NhbmNlbHRvc3VibWl0dm9hY3Rpb24nO1xyXG5cclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5iZUFjdGlvblNlcnZpY2UuZ2V0UmVzdFNlcnZpY2UoKTtcclxuXHJcbiAgICBjb25zdCBib2R5ID0ge1xyXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpLFxyXG4gICAgICBiaXpJbnN0SUQ6IGJpekJpbGxJRCxcclxuICAgIH07XHJcblxyXG4gICAgdGhpcy5mb3JtTG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xyXG5cclxuICAgIGNvbnN0IGFjdGlvbiQgPSB0aGlzLmJlQWN0aW9uU2VydmljZS5leGVjdXRlQWN0aW9uKGFjdGlvblVyaSwgJ1BVVCcsIG51bGwsIG51bGwsIGJvZHkpO1xyXG4gICAgcmV0dXJuIGFjdGlvbiQucGlwZShcclxuICAgICAgc3dpdGNoTWFwKCgpID0+IHtcclxuICAgICAgICBpZiAodGhpcy5yZXBvc2l0b3J5KSB7XHJcbiAgICAgICAgICBjb25zdCB1cGRhdGluZyQgPSB0aGlzLnJlcG9zaXRvcnkudXBkYXRlQnlJZChiaXpCaWxsSUQpO1xyXG4gICAgICAgICAgcmV0dXJuIHVwZGF0aW5nJC5waXBlKHRhcCgoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuZm9ybUxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgICAgICAgLy8gdGhpcy5ub3RpZnlTZXJ2aWNlLmluZm8odGhpcy5sYW5ndWFnZVNlcnZpY2UuY2FuY2VsQXBwcm92ZVN1Y2Nlc3MpO1xyXG4gICAgICAgICAgICBGb3JtTm90aWZ5U3RyYXRlZ3lTZXJ2aWNlLnN1Y2Nlc3ModGhpcy5ub3RpZnlTZXJ2aWNlLCB0aGlzLmxhbmd1YWdlU2VydmljZS5jYW5jZWxBcHByb3ZlU3VjY2Vzcyk7XHJcbiAgICAgICAgICB9KSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMuZm9ybUxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgICAgIC8vIHRoaXMubm90aWZ5U2VydmljZS5pbmZvKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNhbmNlbEFwcHJvdmVTdWNjZXNzKTtcclxuICAgICAgICAgIEZvcm1Ob3RpZnlTdHJhdGVneVNlcnZpY2Uuc3VjY2Vzcyh0aGlzLm5vdGlmeVNlcnZpY2UsIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNhbmNlbEFwcHJvdmVTdWNjZXNzKTtcclxuICAgICAgICAgIHJldHVybiBvZigpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICApLFxyXG4gICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcclxuICAgICAgICB0aGlzLmZvcm1Mb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgICAgLy8gdGhpcy5mb3JtRXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5jYW5jZWxBcHByb3ZlRmFpbGVkLCBlcnJvcik7XHJcbiAgICAgICAgcmV0dXJuIG9mKGVycm9yKTtcclxuICAgICAgfSkpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlj5bmtojlrqHmibko5pSv5oyB5Li76KGo44CB5a2Q6KGoKVxyXG4gICAqIEBwYXJhbSBwcm9jSW5zdElkIOa1geeoi+WunuS+i0lkXHJcbiAgICovXHJcbiAgcHVibGljIGNhbmNlbFN1Ym1pdChwcm9jSW5zdElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgaWYgKCFwcm9jSW5zdElkKSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnByb2NJbnNJZFJlcXVpcmVkLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMud2ZUYXNrSGFuZGxlclNlcnZpY2UgJiYgdGhpcy53ZlRhc2tIYW5kbGVyU2VydmljZS5jYW5jZWxTdWJtaXQoeyBwcm9jSW5zdElkOiBwcm9jSW5zdElkIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmn6XnnIvmtYHnqIvlm75cclxuICAgKiBAcGFyYW0gcHJvY0luc3RJZCDmtYHnqIvlrp7kvotJRFxyXG4gICAqL1xyXG4gIHZpZXdQcm9jZXNzKHByb2NJbnN0SWQ6IHN0cmluZykge1xyXG4gICAgaWYgKHRoaXMuZmxvd2NoYXJ0U2VydmljZSkge1xyXG4gICAgICBpZiAoIXByb2NJbnN0SWQpIHtcclxuICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5ub1Byb2Nlc3NJbnN0YW5jZUlkLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHRoaXMuZmxvd2NoYXJ0U2VydmljZS52aWV3Rmxvd0NoYXJ0KHByb2NJbnN0SWQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOi9rOaNoumFjee9ruWkp+Wwj+WGmVxyXG4gICAqIEBwYXJhbSBqc29uT2JqIE9iamVjdFxyXG4gICAqIEBkZXByZWNhdGVkXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzd2l0Y2hQcmVmaXhMZXR0ZXIoanNvbk9iajogYW55LCB0b1VwcGVyOiBib29sZWFuKTogYW55IHtcclxuICAgIGlmICh0eXBlb2YgKGpzb25PYmopID09PSAnb2JqZWN0JyAmJiAhIWpzb25PYmopIHtcclxuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoanNvbk9iaikpIHtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGpzb25PYmoubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgIHRoaXMuc3dpdGNoUHJlZml4TGV0dGVyKGpzb25PYmpbaV0sIHRvVXBwZXIpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhqc29uT2JqKSkge1xyXG4gICAgICAgICAgdmFyIG5ld0tleSA9ICh0b1VwcGVyID8ga2V5LnN1YnN0cmluZygwLCAxKS50b1VwcGVyQ2FzZSgpIDoga2V5LnN1YnN0cmluZygwLCAxKS50b0xvd2VyQ2FzZSgpKSArIGtleS5zdWJzdHJpbmcoMSk7XHJcbiAgICAgICAgICBqc29uT2JqW25ld0tleV0gPSBqc29uT2JqW2tleV07XHJcbiAgICAgICAgICBpZiAodHlwZW9mIGpzb25PYmpba2V5XSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgdGhpcy5zd2l0Y2hQcmVmaXhMZXR0ZXIoanNvbk9ialtrZXldLCB0b1VwcGVyKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGRlbGV0ZSAoanNvbk9ialtrZXldKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBqc29uT2JqO1xyXG4gIH1cclxufVxyXG5leHBvcnQgeyBBcHByb3ZlU2VydmljZSB9O1xyXG4iXX0=