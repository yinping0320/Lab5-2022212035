import { Injectable, Injector } from "@angular/core";
import { AppContext, FrameContext, Repository } from "@farris/devkit";
import { BindingPathService } from "./binding-path.service";
import { FormControlService } from './form-control.service';
var FrameContextService = /** @class */ (function () {
    function FrameContextService(injector, appContext, frameContext, repository, bindingPathService, formControlService) {
        this.injector = injector;
        this.appContext = appContext;
        this.frameContext = frameContext;
        this.repository = repository;
        this.bindingPathService = bindingPathService;
        this.formControlService = formControlService;
    }
    /**
       * 通过BE表名获取对应的frameContext
       * @param tableName
       * @returns
       */
    FrameContextService.prototype.getFrameContextsByTableName = function (tableName) {
        if (!tableName) {
            throw new Error('tableName 不能为空。');
        }
        var dataTypeInfo = this.repository && this.repository.entityTypeInfo || null;
        if (!dataTypeInfo) {
            return null;
        }
        var bindingPaths = [];
        this.bindingPathService.getBindingPathsByTableName(dataTypeInfo, tableName, bindingPaths);
        var frameContexts = this.appContext && this.appContext.frameContextManager.getFrameContexts() || [];
        if (!frameContexts || frameContexts.length === 0) {
            return null;
        }
        return frameContexts.filter(function (frameContext) { return frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; }).join('/') === bindingPaths.join('/'); });
    };
    /**
     * 根据字段完整路径获取所在的上下文
     * @param propertyPath
     * @param separtor
     * @returns
     */
    FrameContextService.prototype.getFrameContextsByPropertyPath = function (propertyPath, separtor) {
        if (separtor === void 0) { separtor = '/'; }
        if (!propertyPath) {
            throw new Error('propertyPath 不能为空。');
        }
        var frameContexts = this.appContext && this.appContext.frameContextManager.getFrameContexts() || [];
        return frameContexts.filter(function (frameContext) {
            var formControls = frameContext && frameContext.form && frameContext.form.ngFormControls || {};
            var bindingPath = frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath || '';
            if (formControls && Object.keys(formControls).length > 0) {
                var key = Object.keys(formControls).find(function (key) {
                    var formControl = formControls[key];
                    if (!formControl || !formControl.binding) {
                        return false;
                    }
                    var bindings = formControl.binding.split('.').filter(function (p) { return p; });
                    var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
                    var fullPath = bindingPaths.concat(bindings);
                    return propertyPath.split(separtor).filter(function (p) { return p; }).join('/') === fullPath.join('/');
                });
                return key ? true : false;
            }
            return false;
        });
    };
    /**
     * 通过BE字段名获取字段的bindingPath
     * @param bindingPaths 绑定路径
     * @param columnName BE字段名
     * @returns
     */
    FrameContextService.prototype.getFrameContextsByColumnName = function (bindingPaths, columnName) {
        var _this = this;
        if (!bindingPaths) {
            throw new Error('bindingPath 不能为空。');
        }
        if (!columnName) {
            throw new Error('columnName 不能为空。');
        }
        bindingPaths = bindingPaths.filter(function (p) { return p; });
        var entityTypeInfo = this.repository && this.repository.entityTypeInfo || null;
        if (!entityTypeInfo) {
            return null;
        }
        var dataTypeInfo = entityTypeInfo.getTypeInfoByPath(bindingPaths);
        var dataPropInfos = dataTypeInfo && dataTypeInfo.getPropInfos() || [];
        var columnPropInfo = dataPropInfos.find(function (dataPropInfo) { return dataPropInfo.metadataInfo && (dataPropInfo.metadataInfo.originalDataField === columnName || dataPropInfo.metadataInfo.dataField === columnName); });
        if (!columnPropInfo || !columnPropInfo.metadataInfo) {
            return null;
        }
        var frameContexts = this.appContext.frameContextManager.getFrameContexts();
        return frameContexts.filter(function (frameContext) {
            var ngFormControls = _this.formControlService.getFormControlsByFrameContext(frameContext);
            if (!ngFormControls || Object.keys(ngFormControls).length < 1) {
                return false;
            }
            var currentBindingPaths = _this.bindingPathService.getBindingPathsByFrameContext(frameContext) || [];
            var isValidFrameContext = currentBindingPaths.join('/') === bindingPaths.join('/');
            if (!isValidFrameContext) {
                return false;
            }
            var ngFormControl = Object.values(frameContext.viewModel.form.ngFormControls).find(function (item) { return item.binding === columnPropInfo.metadataInfo.path; });
            return ngFormControl ? true : false;
        });
    };
    /**
     * 通过绑定路径获取对应的组件上下文数组
     * @param bindingPath bindingPath字符串
     * @param namespace ns,默认为''
     */
    FrameContextService.prototype.getFrameContextsByBindingPath = function (bindingPath, namespace) {
        if (namespace === void 0) { namespace = ''; }
        if (Array.isArray(bindingPath)) {
            bindingPath = bindingPath.join('/');
        }
        var frameContexts = this.appContext && this.appContext.frameContextManager.getFrameContexts() || [];
        return frameContexts.filter(function (frameContext) { return frameContext && frameContext.namespace === namespace && frameContext.viewModel.bindingPath === bindingPath; });
    };
    FrameContextService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    FrameContextService.ctorParameters = function () { return [
        { type: Injector },
        { type: AppContext },
        { type: FrameContext },
        { type: Repository },
        { type: BindingPathService },
        { type: FormControlService }
    ]; };
    return FrameContextService;
}());
export { FrameContextService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJhbWUtY29udGV4dC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2ZyYW1lLWNvbnRleHQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsVUFBVSxFQUF3QixZQUFZLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUYsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFFNUQ7SUFFRSw2QkFDVSxRQUFrQixFQUNsQixVQUFzQixFQUN0QixZQUEwQixFQUMxQixVQUE4QixFQUM5QixrQkFBc0MsRUFDdEMsa0JBQXNDO1FBTHRDLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUN0QixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFvQjtRQUM5Qix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7SUFDMUMsQ0FBQztJQUNQOzs7O1NBSUs7SUFDRSx5REFBMkIsR0FBbEMsVUFBbUMsU0FBaUI7UUFDbEQsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLE1BQU0sSUFBSSxLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQztTQUNwQztRQUNELElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLElBQUksSUFBSSxDQUFDO1FBQy9FLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDakIsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELElBQU0sWUFBWSxHQUFHLEVB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QUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxFQUFFO1lBQzlCLFdBQVcsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3JDO1FBQ0QsSUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLG1CQUFtQixDQUFDLGdCQUFnQixFQUFFLElBQUksRUFBRSxDQUFDO1FBQ3RHLE9BQU8sYUFBYSxDQUFDLE1BQU0sQ0FBQyxVQUFDLFlBQTBCLElBQUssT0FBQSxZQUFZLElBQUksWUFBWSxDQUFDLFNBQVMsS0FBSyxTQUFTLElBQUksWUFBWSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEtBQUssV0FBVyxFQUExRyxDQUEwRyxDQUFDLENBQUM7SUFDMUssQ0FBQzs7Z0JBaEhGLFVBQVU7Ozs7Z0JBTFUsUUFBUTtnQkFDcEIsVUFBVTtnQkFBd0IsWUFBWTtnQkFBRSxVQUFVO2dCQUMxRCxrQkFBa0I7Z0JBQ2xCLGtCQUFrQjs7SUFtSDNCLDBCQUFDO0NBQUEsQUFqSEQsSUFpSEM7U0FoSFksbUJBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBBcHBDb250ZXh0LCBEYXRhUHJvcEluZm8sIEVudGl0eSwgRnJhbWVDb250ZXh0LCBSZXBvc2l0b3J5IH0gZnJvbSBcIkBmYXJyaXMvZGV2a2l0XCI7XHJcbmltcG9ydCB7IEJpbmRpbmdQYXRoU2VydmljZSB9IGZyb20gXCIuL2JpbmRpbmctcGF0aC5zZXJ2aWNlXCI7XHJcbmltcG9ydCB7IEZvcm1Db250cm9sU2VydmljZSB9IGZyb20gJy4vZm9ybS1jb250cm9sLnNlcnZpY2UnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRnJhbWVDb250ZXh0U2VydmljZSB7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgXHJcbiAgICBwcml2YXRlIGFwcENvbnRleHQ6IEFwcENvbnRleHQsIFxyXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgXHJcbiAgICBwcml2YXRlIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8RW50aXR5PixcclxuICAgIHByaXZhdGUgYmluZGluZ1BhdGhTZXJ2aWNlOiBCaW5kaW5nUGF0aFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGZvcm1Db250cm9sU2VydmljZTogRm9ybUNvbnRyb2xTZXJ2aWNlXHJcbiAgICApIHsgfVxyXG4gIC8qKlxyXG4gICAgICog6YCa6L+HQkXooajlkI3ojrflj5blr7nlupTnmoRmcmFtZUNvbnRleHRcclxuICAgICAqIEBwYXJhbSB0YWJsZU5hbWUgXHJcbiAgICAgKiBAcmV0dXJucyBcclxuICAgICAqL1xyXG4gIHB1YmxpYyBnZXRGcmFtZUNvbnRleHRzQnlUYWJsZU5hbWUodGFibGVOYW1lOiBzdHJpbmcpOiBudWxsIHwgRnJhbWVDb250ZXh0W10ge1xyXG4gICAgaWYgKCF0YWJsZU5hbWUpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCd0YWJsZU5hbWUg5LiN6IO95Li656m644CCJyk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBkYXRhVHlwZUluZm8gPSB0aGlzLnJlcG9zaXRvcnkgJiYgdGhpcy5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvIHx8IG51bGw7XHJcbiAgICBpZiAoIWRhdGFUeXBlSW5mbykge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IFtdO1xyXG4gICAgdGhpcy5iaW5kaW5nUGF0aFNlcnZpY2UuZ2V0QmluZGluZ1BhdGhzQnlUYWJsZU5hbWUoZGF0YVR5cGVJbmZvLCB0YWJsZU5hbWUsIGJpbmRpbmdQYXRocyk7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gdGhpcy5hcHBDb250ZXh0ICYmIHRoaXMuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHMoKSB8fCBbXTtcclxuICAgIGlmICghZnJhbWVDb250ZXh0cyB8fCBmcmFtZUNvbnRleHRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIHJldHVybiBmcmFtZUNvbnRleHRzLmZpbHRlcigoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS5qb2luKCcvJykgPT09IGJpbmRpbmdQYXRocy5qb2luKCcvJykpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmoLnmja7lrZfmrrXlrozmlbTot6/lvoTojrflj5bmiYDlnKjnmoTkuIrkuIvmlodcclxuICAgKiBAcGFyYW0gcHJvcGVydHlQYXRoIFxyXG4gICAqIEBwYXJhbSBzZXBhcnRvciBcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RnJhbWVDb250ZXh0c0J5UHJvcGVydHlQYXRoKHByb3BlcnR5UGF0aDogc3RyaW5nLCBzZXBhcnRvcjogc3RyaW5nID0gJy8nKTogRnJhbWVDb250ZXh0W10ge1xyXG4gICAgaWYgKCFwcm9wZXJ0eVBhdGgpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdwcm9wZXJ0eVBhdGgg5LiN6IO95Li656m644CCJyk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gdGhpcy5hcHBDb250ZXh0ICYmIHRoaXMuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHMoKSB8fCBbXTtcclxuICAgIHJldHVybiBmcmFtZUNvbnRleHRzLmZpbHRlcigoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgY29uc3QgZm9ybUNvbnRyb2xzID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5mb3JtICYmIGZyYW1lQ29udGV4dC5mb3JtLm5nRm9ybUNvbnRyb2xzIHx8IHt9O1xyXG4gICAgICBjb25zdCBiaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggfHwgJyc7XHJcbiAgICAgIGlmIChmb3JtQ29udHJvbHMgJiYgT2JqZWN0LmtleXMoZm9ybUNvbnRyb2xzKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgY29uc3Qga2V5ID0gT2JqZWN0LmtleXMoZm9ybUNvbnRyb2xzKS5maW5kKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgY29uc3QgZm9ybUNvbnRyb2wgPSBmb3JtQ29udHJvbHNba2V5XTtcclxuICAgICAgICAgIGlmICghZm9ybUNvbnRyb2wgfHwgIWZvcm1Db250cm9sLmJpbmRpbmcpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgYmluZGluZ3MgPSBmb3JtQ29udHJvbC5iaW5kaW5nLnNwbGl0KCcuJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgICAgICAgY29uc3QgZnVsbFBhdGggPSBiaW5kaW5nUGF0aHMuY29uY2F0KGJpbmRpbmdzKTtcclxuICAgICAgICAgIHJldHVybiBwcm9wZXJ0eVBhdGguc3BsaXQoc2VwYXJ0b3IpLmZpbHRlcihwID0+IHApLmpvaW4oJy8nKSA9PT0gZnVsbFBhdGguam9pbignLycpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBrZXkgPyB0cnVlIDogZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOmAmui/h0JF5a2X5q615ZCN6I635Y+W5a2X5q6155qEYmluZGluZ1BhdGhcclxuICAgKiBAcGFyYW0gYmluZGluZ1BhdGhzIOe7keWumui3r+W+hFxyXG4gICAqIEBwYXJhbSBjb2x1bW5OYW1lIEJF5a2X5q615ZCNXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIGdldEZyYW1lQ29udGV4dHNCeUNvbHVtbk5hbWUoYmluZGluZ1BhdGhzOiBzdHJpbmdbXSwgY29sdW1uTmFtZTogc3RyaW5nKTogRnJhbWVDb250ZXh0W10gfCBudWxsIHtcclxuICAgIGlmICghYmluZGluZ1BhdGhzKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignYmluZGluZ1BhdGgg5LiN6IO95Li656m644CCJyk7XHJcbiAgICB9XHJcbiAgICBpZiAoIWNvbHVtbk5hbWUpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdjb2x1bW5OYW1lIOS4jeiDveS4uuepuuOAgicpO1xyXG4gICAgfVxyXG4gICAgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGhzLmZpbHRlcihwID0+IHApO1xyXG4gICAgY29uc3QgZW50aXR5VHlwZUluZm8gPSB0aGlzLnJlcG9zaXRvcnkgJiYgdGhpcy5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvIHx8IG51bGw7XHJcbiAgICBpZiAoIWVudGl0eVR5cGVJbmZvKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZGF0YVR5cGVJbmZvID0gZW50aXR5VHlwZUluZm8uZ2V0VHlwZUluZm9CeVBhdGgoYmluZGluZ1BhdGhzKTtcclxuICAgIGNvbnN0IGRhdGFQcm9wSW5mb3MgPSBkYXRhVHlwZUluZm8gJiYgZGF0YVR5cGVJbmZvLmdldFByb3BJbmZvcygpIHx8IFtdO1xyXG4gICAgY29uc3QgY29sdW1uUHJvcEluZm8gPSBkYXRhUHJvcEluZm9zLmZpbmQoKGRhdGFQcm9wSW5mbzogRGF0YVByb3BJbmZvKSA9PiBkYXRhUHJvcEluZm8ubWV0YWRhdGFJbmZvICYmIChkYXRhUHJvcEluZm8ubWV0YWRhdGFJbmZvLm9yaWdpbmFsRGF0YUZpZWxkID09PSBjb2x1bW5OYW1lIHx8IGRhdGFQcm9wSW5mby5tZXRhZGF0YUluZm8uZGF0YUZpZWxkID09PSBjb2x1bW5OYW1lKSk7XHJcbiAgICBpZiAoIWNvbHVtblByb3BJbmZvIHx8ICFjb2x1bW5Qcm9wSW5mby5tZXRhZGF0YUluZm8pIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gdGhpcy5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpO1xyXG4gICAgcmV0dXJuIGZyYW1lQ29udGV4dHMuZmlsdGVyKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICBjb25zdCBuZ0Zvcm1Db250cm9scyA9IHRoaXMuZm9ybUNvbnRyb2xTZXJ2aWNlLmdldEZvcm1Db250cm9sc0J5RnJhbWVDb250ZXh0KGZyYW1lQ29udGV4dCk7XHJcbiAgICAgIGlmICghbmdGb3JtQ29udHJvbHMgfHwgT2JqZWN0LmtleXMobmdGb3JtQ29udHJvbHMpLmxlbmd0aCA8IDEpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgY3VycmVudEJpbmRpbmdQYXRocyA9IHRoaXMuYmluZGluZ1BhdGhTZXJ2aWNlLmdldEJpbmRpbmdQYXRoc0J5RnJhbWVDb250ZXh0KGZyYW1lQ29udGV4dCkgfHwgW107XHJcbiAgICAgIGNvbnN0IGlzVmFsaWRGcmFtZUNvbnRleHQgPSBjdXJyZW50QmluZGluZ1BhdGhzLmpvaW4oJy8nKSA9PT0gYmluZGluZ1BhdGhzLmpvaW4oJy8nKTtcclxuICAgICAgaWYgKCFpc1ZhbGlkRnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IG5nRm9ybUNvbnRyb2wgPSBPYmplY3QudmFsdWVzKGZyYW1lQ29udGV4dC52aWV3TW9kZWwuZm9ybS5uZ0Zvcm1Db250cm9scykuZmluZChpdGVtID0+IGl0ZW0uYmluZGluZyA9PT0gY29sdW1uUHJvcEluZm8ubWV0YWRhdGFJbmZvLnBhdGgpO1xyXG4gICAgICByZXR1cm4gbmdGb3JtQ29udHJvbCA/IHRydWUgOiBmYWxzZTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBcclxuICAvKipcclxuICAgKiDpgJrov4fnu5Hlrprot6/lvoTojrflj5blr7nlupTnmoTnu4Tku7bkuIrkuIvmlofmlbDnu4RcclxuICAgKiBAcGFyYW0gYmluZGluZ1BhdGggYmluZGluZ1BhdGjlrZfnrKbkuLJcclxuICAgKiBAcGFyYW0gbmFtZXNwYWNlIG5zLOm7mOiupOS4uicnXHJcbiAgICovXHJcbiAgIHB1YmxpYyBnZXRGcmFtZUNvbnRleHRzQnlCaW5kaW5nUGF0aChiaW5kaW5nUGF0aDogc3RyaW5nIHwgc3RyaW5nW10sIG5hbWVzcGFjZTogc3RyaW5nID0gJycpOiBGcmFtZUNvbnRleHRbXSB7XHJcbiAgICBpZiAoQXJyYXkuaXNBcnJheShiaW5kaW5nUGF0aCkpIHtcclxuICAgICAgYmluZGluZ1BhdGggPSBiaW5kaW5nUGF0aC5qb2luKCcvJyk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gdGhpcy5hcHBDb250ZXh0ICYmIHRoaXMuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHMoKSB8fCBbXTtcclxuICAgIHJldHVybiBmcmFtZUNvbnRleHRzLmZpbHRlcigoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQubmFtZXNwYWNlID09PSBuYW1lc3BhY2UgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCA9PT0gYmluZGluZ1BhdGgpO1xyXG4gIH1cclxufSJdfQ==