import { Injectable } from '@angular/core';
import * as Mousetrap from 'mousetrap';
/**
 * 快捷键服务
 * @scope FormModule
 */
var KeybindingService = /** @class */ (function () {
    function KeybindingService() {
        this.keyMap = new Map();
        this.bindingProvider = Mousetrap.default;
        this.ready = true;
    }
    /**
     * 对视图模型设置的快捷键进行绑定处理
     * @param viewModel 视图模型
     */
    KeybindingService.prototype.bind = function (viewModel) {
        var _this = this;
        viewModel.keybindingMap.forEach(function (keyBinding, method) {
            _this.register(keyBinding, function () {
                return viewModel[method]();
            });
        });
    };
    /**
     * 注册快捷键
     * @param binding 键盘绑定信息
     * @param handler 响应事件
     */
    KeybindingService.prototype.register = function (binding, handler) {
        var combo = this._getCombo(binding);
        if (combo) {
            this.keyMap.set(combo, handler);
            if (binding.ctrlKey && binding.altKey && !binding.shiftKey) {
                // 实际发现，ctrl+alt组合，只能触发keyup事件
                this.bindingProvider.bind(combo, this._dispatch.bind(this), 'keyup');
            }
            else {
                this.bindingProvider.bind(combo, this._dispatch.bind(this));
            }
        }
    };
    /**
     * 取消快捷键注册
     * @param binding 键盘绑定信息
     */
    KeybindingService.prototype.unregister = function (binding) {
        var combo = this._getCombo(binding);
        if (combo) {
            this.keyMap.delete(combo);
            this.bindingProvider.unbind(combo);
        }
    };
    KeybindingService.prototype._dispatch = function (e) {
        var _this = this;
        if (e.repeat)
            return false;
        if (this.ready) {
            var combo = this._getCombo(e);
            if (combo && this.keyMap.has(combo)) {
                this.ready = false;
                this.keyMap.get(combo)().subscribe(function () {
                    _this.ready = true;
                }, function (error) {
                    _this.ready = true;
                }, function () {
                    _this.ready = true;
                });
            }
        }
        return false;
    };
    /**
     * 返回ctrl+shift+alt+a形式的组合字符串，全部为小写
     * @param keyInfo
     */
    KeybindingService.prototype._getCombo = function (keyInfo) {
        var key = keyInfo.key.toLowerCase();
        if (key.length != 1 || key.charCodeAt(0) < 97 /* a */ || key.charCodeAt(0) > 122 /* z */) {
            console.warn("快捷键字母形式为a-z");
            return null;
        }
        var combo = (keyInfo.ctrlKey ? 'ctrl+' : '')
            + (keyInfo.shiftKey ? 'shift+' : '')
            + (keyInfo.altKey ? 'alt+' : '')
            + (keyInfo.metaKey ? 'meta+' : '')
            + key;
        if (combo.length == 1) {
            console.warn("快捷键至少包含一个Modifier键");
            return null;
        }
        return combo;
    };
    KeybindingService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    KeybindingService.ctorParameters = function () { return []; };
    return KeybindingService;
}());
export { KeybindingService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2V5YmluZGluZy1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2tleWJpbmRpbmctc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sS0FBSyxTQUFTLE1BQU0sV0FBVyxDQUFDO0FBdUV2Qzs7O0dBR0c7QUFDSDtJQU1FO1FBQ0UsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBaUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsZUFBZSxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUM7UUFDekMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7SUFDcEIsQ0FBQztJQUVEOzs7T0FHRztJQUNJLGdDQUFJLEdBQVgsVUFBWSxTQUFvQjtRQUFoQyxpQkFNQztRQUxDLFNBQVMsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLFVBQUMsVUFBVSxFQUFFLE1BQU07WUFDakQsS0FBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUU7Z0JBQ3hCLE9BQU8sU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDN0IsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRjs7OztPQUlHO0lBQ0ssb0NBQVEsR0FBZixVQUFnQixPQUFtQixFQUFFLE9BQThCO1FBQ2pFLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDcEMsSUFBSSxLQUFLLEVBQUU7WUFDVCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDaEMsSUFBSSxPQUFPLENBQUMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFO2dCQUMxRCw4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O0NBQUEsQUEvRkQsSUErRkM7U0E5RlksaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBLZXliaW5kaW5nLCBWaWV3TW9kZWwgfSBmcm9tICdAZmFycmlzL2RldmtpdCdcclxuaW1wb3J0ICogYXMgTW91c2V0cmFwIGZyb20gJ21vdXNldHJhcCc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuXHJcbmNvbnN0IGVudW0gQ2hhckNvZGUge1xyXG5cclxuICBEaWdpdDAgPSA0OCxcclxuICBEaWdpdDEgPSA0OSxcclxuICBEaWdpdDIgPSA1MCxcclxuICBEaWdpdDMgPSA1MSxcclxuICBEaWdpdDQgPSA1MixcclxuICBEaWdpdDUgPSA1MyxcclxuICBEaWdpdDYgPSA1NCxcclxuICBEaWdpdDcgPSA1NSxcclxuICBEaWdpdDggPSA1NixcclxuICBEaWdpdDkgPSA1NyxcclxuXHJcbiAgQSA9IDY1LFxyXG4gIEIgPSA2NixcclxuICBDID0gNjcsXHJcbiAgRCA9IDY4LFxyXG4gIEUgPSA2OSxcclxuICBGID0gNzAsXHJcbiAgRyA9IDcxLFxyXG4gIEggPSA3MixcclxuICBJID0gNzMsXHJcbiAgSiA9IDc0LFxyXG4gIEsgPSA3NSxcclxuICBMID0gNzYsXHJcbiAgTSA9IDc3LFxyXG4gIE4gPSA3OCxcclxuICBPID0gNzksXHJcbiAgUCA9IDgwLFxyXG4gIFEgPSA4MSxcclxuICBSID0gODIsXHJcbiAgUyA9IDgzLFxyXG4gIFQgPSA4NCxcclxuICBVID0gODUsXHJcbiAgViA9IDg2LFxyXG4gIFcgPSA4NyxcclxuICBYID0gODgsXHJcbiAgWSA9IDg5LFxyXG4gIFogPSA5MCxcclxuXHJcbiAgYSA9IDk3LFxyXG4gIGIgPSA5OCxcclxuICBjID0gOTksXHJcbiAgZCA9IDEwMCxcclxuICBlID0gMTAxLFxyXG4gIGYgPSAxMDIsXHJcbiAgZyA9IDEwMyxcclxuICBoID0gMTA0LFxyXG4gIGkgPSAxMDUsXHJcbiAgaiA9IDEwNixcclxuICBrID0gMTA3LFxyXG4gIGwgPSAxMDgsXHJcbiAgbSA9IDEwOSxcclxuICBuID0gMTEwLFxyXG4gIG8gPSAxMTEsXHJcbiAgcCA9IDExMixcclxuICBxID0gMTEzLFxyXG4gIHIgPSAxMTQsXHJcbiAgcyA9IDExNSxcclxuICB0ID0gMTE2LFxyXG4gIHUgPSAxMTcsXHJcbiAgdiA9IDExOCxcclxuICB3ID0gMTE5LFxyXG4gIHggPSAxMjAsXHJcbiAgeSA9IDEyMSxcclxuICB6ID0gMTIyXHJcbn1cclxuXHJcbi8qKlxyXG4gKiDlv6vmjbfplK7mnI3liqFcclxuICogQHNjb3BlIEZvcm1Nb2R1bGVcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEtleWJpbmRpbmdTZXJ2aWNlIHtcclxuICBwcml2YXRlIGtleU1hcDogTWFwPFN0cmluZywgKCkgPT4gT2JzZXJ2YWJsZTxhbnk+PjtcclxuICBwcml2YXRlIGJpbmRpbmdQcm92aWRlcjogTW91c2V0cmFwO1xyXG4gIHByaXZhdGUgcmVhZHk6IGJvb2xlYW47XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy5rZXlNYXAgPSBuZXcgTWFwPFN0cmluZywgKCkgPT4gT2JzZXJ2YWJsZTxhbnk+PigpO1xyXG4gICAgdGhpcy5iaW5kaW5nUHJvdmlkZXIgPSBNb3VzZXRyYXAuZGVmYXVsdDtcclxuICAgIHRoaXMucmVhZHkgPSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5a+56KeG5Zu+5qih5Z6L6K6+572u55qE5b+r5o236ZSu6L+b6KGM57uR5a6a5aSE55CGXHJcbiAgICogQHBhcmFtIHZpZXdNb2RlbCDop4blm77mqKHlnotcclxuICAgKi9cclxuICBwdWJsaWMgYmluZCh2aWV3TW9kZWw6IFZpZXdNb2RlbCkge1xyXG4gICAgdmlld01vZGVsLmtleWJpbmRpbmdNYXAuZm9yRWFjaCgoa2V5QmluZGluZywgbWV0aG9kKSA9PiB7XHJcbiAgICAgIHRoaXMucmVnaXN0ZXIoa2V5QmluZGluZywgKCkgPT4ge1xyXG4gICAgICAgIHJldHVybiB2aWV3TW9kZWxbbWV0aG9kXSgpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcblx0LyoqXHJcblx0ICog5rOo5YaM5b+r5o236ZSuXHJcblx0ICogQHBhcmFtIGJpbmRpbmcg6ZSu55uY57uR5a6a5L+h5oGvXHJcblx0ICogQHBhcmFtIGhhbmRsZXIg5ZON5bqU5LqL5Lu2XHJcblx0ICovXHJcbiAgcHVibGljIHJlZ2lzdGVyKGJpbmRpbmc6IEtleWJpbmRpbmcsIGhhbmRsZXI6ICgpID0+IE9ic2VydmFibGU8YW55Pikge1xyXG4gICAgdmFyIGNvbWJvID0gdGhpcy5fZ2V0Q29tYm8oYmluZGluZyk7XHJcbiAgICBpZiAoY29tYm8pIHtcclxuICAgICAgdGhpcy5rZXlNYXAuc2V0KGNvbWJvLCBoYW5kbGVyKTtcclxuICAgICAgaWYgKGJpbmRpbmcuY3RybEtleSAmJiBiaW5kaW5nLmFsdEtleSAmJiAhYmluZGluZy5zaGlmdEtleSkge1xyXG4gICAgICAgIC8vIOWunumZheWPkeeOsO+8jGN0cmwrYWx057uE5ZCI77yM5Y+q6IO96Kem5Y+Ra2V5dXDkuovku7ZcclxuICAgICAgICB0aGlzLmJpbmRpbmdQcm92aWRlci5iaW5kKGNvbWJvLCB0aGlzLl9kaXNwYXRjaC5iaW5kKHRoaXMpLCAna2V5dXAnKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLmJpbmRpbmdQcm92aWRlci5iaW5kKGNvbWJvLCB0aGlzLl9kaXNwYXRjaC5iaW5kKHRoaXMpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Y+W5raI5b+r5o236ZSu5rOo5YaMXHJcbiAgICogQHBhcmFtIGJpbmRpbmcg6ZSu55uY57uR5a6a5L+h5oGvIFxyXG4gICAqL1xyXG4gIHB1YmxpYyB1bnJlZ2lzdGVyKGJpbmRpbmc6IEtleWJpbmRpbmcpIHtcclxuICAgIHZhciBjb21ibyA9IHRoaXMuX2dldENvbWJvKGJpbmRpbmcpO1xyXG4gICAgaWYgKGNvbWJvKSB7XHJcbiAgICAgIHRoaXMua2V5TWFwLmRlbGV0ZShjb21ibyk7XHJcbiAgICAgIHRoaXMuYmluZGluZ1Byb3ZpZGVyLnVuYmluZChjb21ibyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9kaXNwYXRjaChlOiBLZXlib2FyZEV2ZW50KTogYm9vbGVhbiB7XHJcbiAgICBpZiAoZS5yZXBlYXQpIHJldHVybiBmYWxzZTtcclxuICAgIGlmICh0aGlzLnJlYWR5KSB7XHJcbiAgICAgIHZhciBjb21ibyA9IHRoaXMuX2dldENvbWJvKGUpO1xyXG4gICAgICBpZiAoY29tYm8gJiYgdGhpcy5rZXlNYXAuaGFzKGNvbWJvKSkge1xyXG4gICAgICAgIHRoaXMucmVhZHkgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmtleU1hcC5nZXQoY29tYm8pKCkuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgIHRoaXMucmVhZHkgPSB0cnVlO1xyXG4gICAgICAgIH0sIChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgdGhpcy5yZWFkeSA9IHRydWU7XHJcbiAgICAgICAgfSwgKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5yZWFkeSA9IHRydWU7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG5cdC8qKlxyXG5cdCAqIOi/lOWbnmN0cmwrc2hpZnQrYWx0K2HlvaLlvI/nmoTnu4TlkIjlrZfnrKbkuLLvvIzlhajpg6jkuLrlsI/lhplcclxuXHQgKiBAcGFyYW0ga2V5SW5mbyBcclxuXHQgKi9cclxuICBwcml2YXRlIF9nZXRDb21ibyhrZXlJbmZvOiBLZXliaW5kaW5nIHwgS2V5Ym9hcmRFdmVudCk6IFN0cmluZyB8IG51bGwge1xyXG4gICAgdmFyIGtleSA9IGtleUluZm8ua2V5LnRvTG93ZXJDYXNlKCk7XHJcbiAgICBpZiAoa2V5Lmxlbmd0aCAhPSAxIHx8IGtleS5jaGFyQ29kZUF0KDApIDwgQ2hhckNvZGUuYSB8fCBrZXkuY2hhckNvZGVBdCgwKSA+IENoYXJDb2RlLnopIHtcclxuICAgICAgY29uc29sZS53YXJuKFwi5b+r5o236ZSu5a2X5q+N5b2i5byP5Li6YS16XCIpO1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIHZhciBjb21ibyA9IChrZXlJbmZvLmN0cmxLZXkgPyAnY3RybCsnIDogJycpXHJcbiAgICAgICsgKGtleUluZm8uc2hpZnRLZXkgPyAnc2hpZnQrJyA6ICcnKVxyXG4gICAgICArIChrZXlJbmZvLmFsdEtleSA/ICdhbHQrJyA6ICcnKVxyXG4gICAgICArIChrZXlJbmZvLm1ldGFLZXkgPyAnbWV0YSsnIDogJycpXHJcbiAgICAgICsga2V5O1xyXG5cclxuICAgIGlmIChjb21iby5sZW5ndGggPT0gMSkge1xyXG4gICAgICBjb25zb2xlLndhcm4oXCLlv6vmjbfplK7oh7PlsJHljIXlkKvkuIDkuKpNb2RpZmllcumUrlwiKTtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGNvbWJvO1xyXG4gIH1cclxufSJdfQ==