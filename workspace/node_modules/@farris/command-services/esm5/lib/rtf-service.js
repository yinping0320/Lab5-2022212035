import { Injectable } from '@angular/core';
import { EMPTY, Subject } from 'rxjs';
import { UID } from '@farris/devkit';
/*
 * @Author: aalizzwell
 * @Date: 2019-07-23 15:56:11
 * @Last Modified by: aalizzwell
 * @Last Modified time: 2019-11-27 15:31:36
 */
/**
 * RuntimeFrameworkService
 * @scope @FormModule
 */
// tslint:disable: no-string-literal disable: max-line-length
var RuntimeFrameworkService = /** @class */ (function () {
    function RuntimeFrameworkService() {
        this.rtfService = this.getService();
    }
    /**
     * 遍历获取rtf服务
     */
    RuntimeFrameworkService.prototype.getService = function () {
        var env = window;
        while (!env['gspframeworkService'] && env !== window.top && this.isSameOrigin(env)) {
            env = env.parent;
        }
        return env['gspframeworkService'] && env['gspframeworkService']['rtf'] || {};
    };
    // #region 导航服务
    /**
     * 打开菜单或应用
     * @param options options
     */
    RuntimeFrameworkService.prototype.openMenu = function (options) {
        if (this.rtfService && this.rtfService.hasOwnProperty('func') && typeof this.rtfService['func']['openMenu'] === 'function') {
            this.rtfService.func.openMenu(options);
        }
    };
    /**
     * 打开菜单或应用
     * @param options options
     */
    RuntimeFrameworkService.prototype.openMenu$ = function (options) {
        if (this.rtfService && this.rtfService.hasOwnProperty('func') && typeof this.rtfService['func']['openMenuByStream'] === 'function') {
            return this.rtfService.func.openMenuByStream(options);
        }
        return EMPTY;
    };
    /**
     * 获取导航实体数据
     * @param tabId tabid
     * @param callback callback
     * @param once once
     */
    RuntimeFrameworkService.prototype.getEntityParam = function (tabId, callback, once) {
        if (once === void 0) { once = true; }
        if (this.rtfService && this.rtfService.hasOwnProperty('func') && typeof this.rtfService['func']['getEntityParam'] === 'function') {
            this.rtfService.func.getEntityParam(tabId, callback, once);
        }
    };
    /**
     * 尝试关闭菜单或应用
     * @param options optins
     */
    RuntimeFrameworkService.prototype.beforeCloseMenu = function (options) {
        if (this.rtfService && this.rtfService.hasOwnProperty('func') && typeof this.rtfService['func']['beforeClose'] === 'function') {
            this.rtfService.func.beforeClose(options);
        }
    };
    /**
     * 关闭菜单
     * @param options options
     */
    RuntimeFrameworkService.prototype.closeMenu = function (options) {
        if (this.rtfService && this.rtfService.hasOwnProperty('func') && typeof this.rtfService['func']['close'] === 'function') {
            this.rtfService.func.close(options);
        }
    };
    /**
     * 获取菜单静态参数
     * @param funcId 菜单id
     * @param callback 回调
     */
    RuntimeFrameworkService.prototype.getMenuParams = function (funcId, callback) {
        if (this.rtfService && this.rtfService.hasOwnProperty('func') && typeof this.rtfService['func']['getMenuParams'] === 'function') {
            this.rtfService.func.getMenuParams(funcId, callback);
        }
    };
    /**
     * 添加事件监听
     */
    RuntimeFrameworkService.prototype.addEventListener = function (token, handler, options) {
        if (this.rtfService && this.rtfService.hasOwnProperty('frmEvent') && typeof this.rtfService['frmEvent']['eventListener'] === 'function') {
            this.rtfService.frmEvent.eventListener(token, handler, options);
        }
    };
    /**
     * 获取运行框架菜单切换控制事件
     * @returns Observable<any>
     */
    RuntimeFrameworkService.prototype.getMenuSwitchControlEvent = function () {
        var subject = new Subject();
        var frmEvent = this.rtfService && this.rtfService.frmEvent || null;
        if (frmEvent) {
            var tabId_1 = this.tabId;
            var options_1 = this.params;
            window.setTimeout(function () {
                frmEvent.eventListener(tabId_1, function (response) {
                    var menuSwitchControl = response && response.menuSwitchControl || null;
                    if (menuSwitchControl && menuSwitchControl.key === tabId_1) {
                        subject.next(menuSwitchControl.value);
                    }
                    else {
                        subject.next(null);
                    }
                }, options_1);
            }, 0);
        }
        return subject;
    };
    Object.defineProperty(RuntimeFrameworkService.prototype, "params", {
        //#endregion
        // #region 适配层属性
        get: function () {
            if (this.rtfService && this.rtfService.hasOwnProperty('session') && typeof this.rtfService['session']['getCommonVariable'] === 'function') {
                return this.rtfService['session']['getCommonVariable']();
            }
            return null;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RuntimeFrameworkService.prototype, "tabId", {
        /**
         * 获取tabId
         */
        get: function () {
            return this.params && this.params['tabId'] || null;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RuntimeFrameworkService.prototype, "formToken", {
        /**
         * 获取formToken
         */
        get: function () {
            return this.params && this.params['formToken'] || null;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RuntimeFrameworkService.prototype, "funcId", {
        /**
         * 获取funcId
         */
        get: function () {
            return this.params && this.params['funcId'] || null;
        },
        enumerable: true,
        configurable: true
    });
    // #endregion
    // #region 事件通信
    /**
     * 注册主题
     * @param code 主题的标识
     * @param options token生成规则
     * @param subject 自定义主题，默认使用Subject
     * @returns string 注册成功后返回主题的唯一标识
     */
    RuntimeFrameworkService.prototype.subjectRegister = function (code, options, subject) {
        if (this.rtfService && this.rtfService.hasOwnProperty('broadcast') && typeof this.rtfService['broadcast']['subjectRegister'] === 'function') {
            return this.rtfService.broadcast.subjectRegister(code, options, subject);
        }
        return null;
    };
    /**
     * 移除主题
     * @param token 主题唯一标识
     */
    RuntimeFrameworkService.prototype.subjectRemove = function (token) {
        if (this.rtfService && this.rtfService.hasOwnProperty('broadcast') && typeof this.rtfService['broadcast']['subjectRemove'] === 'function') {
            this.rtfService.broadcast.subjectRemove(token);
        }
    };
    /**
     * 给主题发送消息
     * @param token 主题标识
     * @param info 消息
     */
    RuntimeFrameworkService.prototype.subjectNotify = function (token, info) {
        if (this.rtfService && this.rtfService.hasOwnProperty('broadcast') && typeof this.rtfService['broadcast']['notify'] === 'function') {
            this.rtfService.broadcast.notify(token, info);
        }
    };
    /**
     * 注册主题监听器
     * @param token 主题标识
     * @param handler 主题处理器
     * @param observerToken 监听器id(可选)
     * @returns 监听器Id
     * @description 监听主题消息，监听成功返回当前监听者的唯一标识
     */
    RuntimeFrameworkService.prototype.subjectResponse = function (token, handler, observerToken) {
        if (this.rtfService && this.rtfService.hasOwnProperty('broadcast') && typeof this.rtfService['broadcast']['response'] === 'function') {
            var code = observerToken;
            if (typeof observerToken === 'undefined' || !observerToken || observerToken.length < 1) {
                code = UID.create();
            }
            this.rtfService.broadcast.response(token, code, handler);
            return code;
        }
        return null;
    };
    /**
     * 取消对主题的监听
     * @param token 主题标识
     * @param observerToken 监听器标识
     */
    RuntimeFrameworkService.prototype.responseUnSubscribe = function (token, observerToken) {
        if (this.rtfService && this.rtfService.hasOwnProperty('broadcast') && typeof this.rtfService['broadcast']['responseUnSubscribe'] === 'function') {
            this.rtfService.broadcast.responseUnSubscribe(token, observerToken);
        }
    };
    // #endregion
    // #region 工具函数
    /**
     * 是否同源
     * @param environment window
     */
    RuntimeFrameworkService.prototype.isSameOrigin = function (environment) {
        var host = window.location.host;
        try {
            if (environment && environment.location && typeof environment.location.host !== 'undefined') {
                return environment.location.host === host;
            }
        }
        catch (e) {
            return false;
        }
        return false;
    };
    RuntimeFrameworkService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    RuntimeFrameworkService.ctorParameters = function () { return []; };
    return RuntimeFrameworkService;
}());
export { RuntimeFrameworkService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnRmLXNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvcnRmLXNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsS0FBSyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsRCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFckM7Ozs7O0dBS0c7QUFHSDs7O0dBR0c7QUFDSCw2REFBNkQ7QUFDN0Q7SUFHRTtRQUNFLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ3RDLENBQUM7SUFDRDs7T0FFRztJQUNLLDRDQUFVLEdBQWxCO1FBQ0UsSUFBSSxHQUFHLEdBQVcsTUFBTSxDQUFDO1FBQ3pCLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUMsSUFBSSxHQUFHLEtBQUssTUFBTSxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2xGLEdBQUcsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO1NBQ2xCO1FBQ0QsT0FBTyxHQUFHLENBQUMscUJBQXFCLENBQUMsSUFBSSxHQUFHLENBQUMscUJBQXFCLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDL0UsQ0FBQztJQUNELGVBQWU7SUFDZjs7O09BR0c7SUFDSCwwQ0FBUSxHQUFSLFVBQVMsT0FBWTtRQUNuQixJQUFJLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLElBQUksT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFVBQVUsQ0FBQyxLQUFLLFVBQVUsRUFBRTtZQUMxSCxJQUFJLENBQUMsVUFB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O0lBQ0kscURBQW1CLEdBQTFCLFVBQTJCLEtBQWEsRUFBRSxhQUFxQjtRQUM3RCxJQUFJLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLElBQUksT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDLHFCQUFxQixDQUFDLEtBQUssVUFBVSxFQUFFO1lBQy9JLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLEtBQUssRUFBRSxhQUFhLENBQUMsQ0FBQztTQUNyRTtJQUNILENBQUM7SUFDRCxhQUFhO0lBRWIsZUFBZTtJQUNmOzs7T0FHRztJQUNLLDhDQUFZLEdBQXBCLFVBQXFCLFdBQW1CO1FBQ3RDLElBQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1FBQ2xDLElBQUk7WUFDRixJQUFJLFdBQVcsSUFBSSxXQUFXLENBQUMsUUFBUSxJQUFJLE9BQU8sV0FBVyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEtBQUssV0FBVyxFQUFFO2dCQUMzRixPQUFPLFdBQVcsQ0FBQyxRQUFRLENBQUMsSUFBSSxLQUFLLElBQUksQ0FBQzthQUMzQztTQUNGO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixPQUFPLEtBQUssQ0FBQztTQUNkO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDOztnQkF2TkYsVUFBVTs7OztJQXlOWCw4QkFBQztDQUFBLEFBek5ELElBeU5DO1NBeE5ZLHVCQUF1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRU1QVFksIE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgVUlEIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbi8qXHJcbiAqIEBBdXRob3I6IGFhbGl6endlbGwgXHJcbiAqIEBEYXRlOiAyMDE5LTA3LTIzIDE1OjU2OjExIFxyXG4gKiBATGFzdCBNb2RpZmllZCBieTogYWFsaXp6d2VsbFxyXG4gKiBATGFzdCBNb2RpZmllZCB0aW1lOiAyMDE5LTExLTI3IDE1OjMxOjM2XHJcbiAqL1xyXG5cclxuXHJcbi8qKlxyXG4gKiBSdW50aW1lRnJhbWV3b3JrU2VydmljZVxyXG4gKiBAc2NvcGUgQEZvcm1Nb2R1bGVcclxuICovXHJcbi8vIHRzbGludDpkaXNhYmxlOiBuby1zdHJpbmctbGl0ZXJhbCBkaXNhYmxlOiBtYXgtbGluZS1sZW5ndGhcclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgUnVudGltZUZyYW1ld29ya1NlcnZpY2Uge1xyXG4gIHByaXZhdGUgcnRmU2VydmljZTogYW55O1xyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy5ydGZTZXJ2aWNlID0gdGhpcy5nZXRTZXJ2aWNlKCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOmBjeWOhuiOt+WPlnJ0ZuacjeWKoVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0U2VydmljZSgpIHtcclxuICAgIGxldCBlbnY6IFdpbmRvdyA9IHdpbmRvdztcclxuICAgIHdoaWxlICghZW52Wydnc3BmcmFtZXdvcmtTZXJ2aWNlJ10gJiYgZW52ICE9PSB3aW5kb3cudG9wICYmIHRoaXMuaXNTYW1lT3JpZ2luKGVudikpIHtcclxuICAgICAgZW52ID0gZW52LnBhcmVudDtcclxuICAgIH1cclxuICAgIHJldHVybiBlbnZbJ2dzcGZyYW1ld29ya1NlcnZpY2UnXSAmJiBlbnZbJ2dzcGZyYW1ld29ya1NlcnZpY2UnXVsncnRmJ10gfHwge307XHJcbiAgfVxyXG4gIC8vICNyZWdpb24g5a+86Iiq5pyN5YqhXHJcbiAgLyoqXHJcbiAgICog5omT5byA6I+c5Y2V5oiW5bqU55SoXHJcbiAgICogQHBhcmFtIG9wdGlvbnMgb3B0aW9uc1xyXG4gICAqL1xyXG4gIG9wZW5NZW51KG9wdGlvbnM6IGFueSkge1xyXG4gICAgaWYgKHRoaXMucnRmU2VydmljZSAmJiB0aGlzLnJ0ZlNlcnZpY2UuaGFzT3duUHJvcGVydHkoJ2Z1bmMnKSAmJiB0eXBlb2YgdGhpcy5ydGZTZXJ2aWNlWydmdW5jJ11bJ29wZW5NZW51J10gPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5ydGZTZXJ2aWNlLmZ1bmMub3Blbk1lbnUob3B0aW9ucyk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJk+W8gOiPnOWNleaIluW6lOeUqFxyXG4gICAqIEBwYXJhbSBvcHRpb25zIG9wdGlvbnNcclxuICAgKi9cclxuICBvcGVuTWVudSQob3B0aW9uczogYW55KSB7XHJcbiAgICBpZiAodGhpcy5ydGZTZXJ2aWNlICYmIHRoaXMucnRmU2VydmljZS5oYXNPd25Qcm9wZXJ0eSgnZnVuYycpICYmIHR5cGVvZiB0aGlzLnJ0ZlNlcnZpY2VbJ2Z1bmMnXVsnb3Blbk1lbnVCeVN0cmVhbSddID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnJ0ZlNlcnZpY2UuZnVuYy5vcGVuTWVudUJ5U3RyZWFtKG9wdGlvbnMpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIEVNUFRZO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5blr7zoiKrlrp7kvZPmlbDmja5cclxuICAgKiBAcGFyYW0gdGFiSWQgdGFiaWRcclxuICAgKiBAcGFyYW0gY2FsbGJhY2sgY2FsbGJhY2tcclxuICAgKiBAcGFyYW0gb25jZSBvbmNlXHJcbiAgICovXHJcbiAgZ2V0RW50aXR5UGFyYW0odGFiSWQ6IHN0cmluZywgY2FsbGJhY2s6IGFueSwgb25jZTogYm9vbGVhbiA9IHRydWUpIHtcclxuICAgIGlmICh0aGlzLnJ0ZlNlcnZpY2UgJiYgdGhpcy5ydGZTZXJ2aWNlLmhhc093blByb3BlcnR5KCdmdW5jJykgJiYgdHlwZW9mIHRoaXMucnRmU2VydmljZVsnZnVuYyddWydnZXRFbnRpdHlQYXJhbSddID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIHRoaXMucnRmU2VydmljZS5mdW5jLmdldEVudGl0eVBhcmFtKHRhYklkLCBjYWxsYmFjaywgb25jZSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWwneivleWFs+mXreiPnOWNleaIluW6lOeUqFxyXG4gICAqIEBwYXJhbSBvcHRpb25zIG9wdGluc1xyXG4gICAqL1xyXG4gIGJlZm9yZUNsb3NlTWVudShvcHRpb25zOiBhbnkpIHtcclxuICAgIGlmICh0aGlzLnJ0ZlNlcnZpY2UgJiYgdGhpcy5ydGZTZXJ2aWNlLmhhc093blByb3BlcnR5KCdmdW5jJykgJiYgdHlwZW9mIHRoaXMucnRmU2VydmljZVsnZnVuYyddWydiZWZvcmVDbG9zZSddID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIHRoaXMucnRmU2VydmljZS5mdW5jLmJlZm9yZUNsb3NlKG9wdGlvbnMpO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDlhbPpl63oj5zljZVcclxuICAgKiBAcGFyYW0gb3B0aW9ucyBvcHRpb25zXHJcbiAgICovXHJcbiAgY2xvc2VNZW51KG9wdGlvbnM6IGFueSkge1xyXG4gICAgaWYgKHRoaXMucnRmU2VydmljZSAmJiB0aGlzLnJ0ZlNlcnZpY2UuaGFzT3duUHJvcGVydHkoJ2Z1bmMnKSAmJiB0eXBlb2YgdGhpcy5ydGZTZXJ2aWNlWydmdW5jJ11bJ2Nsb3NlJ10gPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5ydGZTZXJ2aWNlLmZ1bmMuY2xvc2Uob3B0aW9ucyk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluiPnOWNlemdmeaAgeWPguaVsFxyXG4gICAqIEBwYXJhbSBmdW5jSWQg6I+c5Y2VaWRcclxuICAgKiBAcGFyYW0gY2FsbGJhY2sg5Zue6LCDXHJcbiAgICovXHJcbiAgZ2V0TWVudVBhcmFtcyhmdW5jSWQ6IHN0cmluZywgY2FsbGJhY2s6IChwYXJhbXMpID0+IHZvaWQpIHtcclxuICAgIGlmICh0aGlzLnJ0ZlNlcnZpY2UgJiYgdGhpcy5ydGZTZXJ2aWNlLmhhc093blByb3BlcnR5KCdmdW5jJykgJiYgdHlwZW9mIHRoaXMucnRmU2VydmljZVsnZnVuYyddWydnZXRNZW51UGFyYW1zJ10gPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5ydGZTZXJ2aWNlLmZ1bmMuZ2V0TWVudVBhcmFtcyhmdW5jSWQsIGNhbGxiYWNrKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5re75Yqg5LqL5Lu255uR5ZCsXHJcbiAgICovXHJcbiAgYWRkRXZlbnRMaXN0ZW5lcih0b2tlbjogc3RyaW5nLCBoYW5kbGVyOiAodmFsdWU6IGFueSkgPT4gdm9pZCwgb3B0aW9uczogYW55KSB7XHJcbiAgICBpZiAodGhpcy5ydGZTZXJ2aWNlICYmIHRoaXMucnRmU2VydmljZS5oYXNPd25Qcm9wZXJ0eSgnZnJtRXZlbnQnKSAmJiB0eXBlb2YgdGhpcy5ydGZTZXJ2aWNlWydmcm1FdmVudCddWydldmVudExpc3RlbmVyJ10gPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5ydGZTZXJ2aWNlLmZybUV2ZW50LmV2ZW50TGlzdGVuZXIodG9rZW4sIGhhbmRsZXIsIG9wdGlvbnMpO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bov5DooYzmoYbmnrboj5zljZXliIfmjaLmjqfliLbkuovku7ZcclxuICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlPGFueT5cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0TWVudVN3aXRjaENvbnRyb2xFdmVudCgpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3Qgc3ViamVjdCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcclxuICAgIGNvbnN0IGZybUV2ZW50ID0gdGhpcy5ydGZTZXJ2aWNlICYmIHRoaXMucnRmU2VydmljZS5mcm1FdmVudCB8fCBudWxsO1xyXG4gICAgaWYgKGZybUV2ZW50KSB7XHJcbiAgICAgIGNvbnN0IHRhYklkID0gdGhpcy50YWJJZDtcclxuICAgICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMucGFyYW1zO1xyXG4gICAgICB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgZnJtRXZlbnQuZXZlbnRMaXN0ZW5lcih0YWJJZCwgKHJlc3BvbnNlOiB7IG1lbnVTd2l0Y2hDb250cm9sOiB7IGtleTogYW55LCB2YWx1ZTogYW55IH0sIFtwcm9wOiBzdHJpbmddOiBhbnkgfSkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgbWVudVN3aXRjaENvbnRyb2wgPSByZXNwb25zZSAmJiByZXNwb25zZS5tZW51U3dpdGNoQ29udHJvbCB8fCBudWxsO1xyXG4gICAgICAgICAgaWYgKG1lbnVTd2l0Y2hDb250cm9sICYmIG1lbnVTd2l0Y2hDb250cm9sLmtleSA9PT0gdGFiSWQpIHtcclxuICAgICAgICAgICAgc3ViamVjdC5uZXh0KG1lbnVTd2l0Y2hDb250cm9sLnZhbHVlKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHN1YmplY3QubmV4dChudWxsKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9LCBvcHRpb25zKTtcclxuICAgICAgfSwgMCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc3ViamVjdDtcclxuICB9XHJcbiAgLy8jZW5kcmVnaW9uXHJcblxyXG4gIC8vICNyZWdpb24g6YCC6YWN5bGC5bGe5oCnXHJcbiAgcHVibGljIGdldCBwYXJhbXMoKSB7XHJcbiAgICBpZiAodGhpcy5ydGZTZXJ2aWNlICYmIHRoaXMucnRmU2VydmljZS5oYXNPd25Qcm9wZXJ0eSgnc2Vzc2lvbicpICYmIHR5cGVvZiB0aGlzLnJ0ZlNlcnZpY2VbJ3Nlc3Npb24nXVsnZ2V0Q29tbW9uVmFyaWFibGUnXSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICByZXR1cm4gdGhpcy5ydGZTZXJ2aWNlWydzZXNzaW9uJ11bJ2dldENvbW1vblZhcmlhYmxlJ10oKTtcclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5Z0YWJJZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQgdGFiSWQoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5wYXJhbXMgJiYgdGhpcy5wYXJhbXNbJ3RhYklkJ10gfHwgbnVsbDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+WZm9ybVRva2VuXHJcbiAgICovXHJcbiAgcHVibGljIGdldCBmb3JtVG9rZW4oKSB7XHJcbiAgICByZXR1cm4gdGhpcy5wYXJhbXMgJiYgdGhpcy5wYXJhbXNbJ2Zvcm1Ub2tlbiddIHx8IG51bGw7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlmZ1bmNJZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQgZnVuY0lkKCkge1xyXG4gICAgcmV0dXJuIHRoaXMucGFyYW1zICYmIHRoaXMucGFyYW1zWydmdW5jSWQnXSB8fCBudWxsO1xyXG4gIH1cclxuICAvLyAjZW5kcmVnaW9uXHJcblxyXG4gIC8vICNyZWdpb24g5LqL5Lu26YCa5L+hXHJcbiAgLyoqXHJcbiAgICog5rOo5YaM5Li76aKYXHJcbiAgICogQHBhcmFtIGNvZGUg5Li76aKY55qE5qCH6K+GXHJcbiAgICogQHBhcmFtIG9wdGlvbnMgdG9rZW7nlJ/miJDop4TliJlcclxuICAgKiBAcGFyYW0gc3ViamVjdCDoh6rlrprkuYnkuLvpopjvvIzpu5jorqTkvb/nlKhTdWJqZWN0XHJcbiAgICogQHJldHVybnMgc3RyaW5nIOazqOWGjOaIkOWKn+WQjui/lOWbnuS4u+mimOeahOWUr+S4gOagh+ivhlxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdWJqZWN0UmVnaXN0ZXIoY29kZTogc3RyaW5nLCBvcHRpb25zOiBhbnksIHN1YmplY3Q/OiBTdWJqZWN0PGFueT4pOiBzdHJpbmcge1xyXG4gICAgaWYgKHRoaXMucnRmU2VydmljZSAmJiB0aGlzLnJ0ZlNlcnZpY2UuaGFzT3duUHJvcGVydHkoJ2Jyb2FkY2FzdCcpICYmIHR5cGVvZiB0aGlzLnJ0ZlNlcnZpY2VbJ2Jyb2FkY2FzdCddWydzdWJqZWN0UmVnaXN0ZXInXSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICByZXR1cm4gdGhpcy5ydGZTZXJ2aWNlLmJyb2FkY2FzdC5zdWJqZWN0UmVnaXN0ZXIoY29kZSwgb3B0aW9ucywgc3ViamVjdCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog56e76Zmk5Li76aKYXHJcbiAgICogQHBhcmFtIHRva2VuIOS4u+mimOWUr+S4gOagh+ivhlxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdWJqZWN0UmVtb3ZlKHRva2VuOiBzdHJpbmcpIHtcclxuICAgIGlmICh0aGlzLnJ0ZlNlcnZpY2UgJiYgdGhpcy5ydGZTZXJ2aWNlLmhhc093blByb3BlcnR5KCdicm9hZGNhc3QnKSAmJiB0eXBlb2YgdGhpcy5ydGZTZXJ2aWNlWydicm9hZGNhc3QnXVsnc3ViamVjdFJlbW92ZSddID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIHRoaXMucnRmU2VydmljZS5icm9hZGNhc3Quc3ViamVjdFJlbW92ZSh0b2tlbik7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOe7meS4u+mimOWPkemAgea2iOaBr1xyXG4gICAqIEBwYXJhbSB0b2tlbiDkuLvpopjmoIfor4ZcclxuICAgKiBAcGFyYW0gaW5mbyDmtojmga9cclxuICAgKi9cclxuICBwdWJsaWMgc3ViamVjdE5vdGlmeSh0b2tlbjogc3RyaW5nLCBpbmZvOiBhbnkpIHtcclxuICAgIGlmICh0aGlzLnJ0ZlNlcnZpY2UgJiYgdGhpcy5ydGZTZXJ2aWNlLmhhc093blByb3BlcnR5KCdicm9hZGNhc3QnKSAmJiB0eXBlb2YgdGhpcy5ydGZTZXJ2aWNlWydicm9hZGNhc3QnXVsnbm90aWZ5J10gPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5ydGZTZXJ2aWNlLmJyb2FkY2FzdC5ub3RpZnkodG9rZW4sIGluZm8pO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDms6jlhozkuLvpopjnm5HlkKzlmahcclxuICAgKiBAcGFyYW0gdG9rZW4g5Li76aKY5qCH6K+GXHJcbiAgICogQHBhcmFtIGhhbmRsZXIg5Li76aKY5aSE55CG5ZmoXHJcbiAgICogQHBhcmFtIG9ic2VydmVyVG9rZW4g55uR5ZCs5ZmoaWQo5Y+v6YCJKVxyXG4gICAqIEByZXR1cm5zIOebkeWQrOWZqElkXHJcbiAgICogQGRlc2NyaXB0aW9uIOebkeWQrOS4u+mimOa2iOaBr++8jOebkeWQrOaIkOWKn+i/lOWbnuW9k+WJjeebkeWQrOiAheeahOWUr+S4gOagh+ivhlxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdWJqZWN0UmVzcG9uc2UodG9rZW46IHN0cmluZywgaGFuZGxlcjogKGRhdGE6IGFueSkgPT4gdm9pZCwgb2JzZXJ2ZXJUb2tlbj86IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBpZiAodGhpcy5ydGZTZXJ2aWNlICYmIHRoaXMucnRmU2VydmljZS5oYXNPd25Qcm9wZXJ0eSgnYnJvYWRjYXN0JykgJiYgdHlwZW9mIHRoaXMucnRmU2VydmljZVsnYnJvYWRjYXN0J11bJ3Jlc3BvbnNlJ10gPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgbGV0IGNvZGUgPSBvYnNlcnZlclRva2VuO1xyXG4gICAgICBpZiAodHlwZW9mIG9ic2VydmVyVG9rZW4gPT09ICd1bmRlZmluZWQnIHx8ICFvYnNlcnZlclRva2VuIHx8IG9ic2VydmVyVG9rZW4ubGVuZ3RoIDwgMSkge1xyXG4gICAgICAgIGNvZGUgPSBVSUQuY3JlYXRlKCk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5ydGZTZXJ2aWNlLmJyb2FkY2FzdC5yZXNwb25zZSh0b2tlbiwgY29kZSwgaGFuZGxlcik7XHJcbiAgICAgIHJldHVybiBjb2RlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWPlua2iOWvueS4u+mimOeahOebkeWQrFxyXG4gICAqIEBwYXJhbSB0b2tlbiDkuLvpopjmoIfor4ZcclxuICAgKiBAcGFyYW0gb2JzZXJ2ZXJUb2tlbiDnm5HlkKzlmajmoIfor4ZcclxuICAgKi9cclxuICBwdWJsaWMgcmVzcG9uc2VVblN1YnNjcmliZSh0b2tlbjogc3RyaW5nLCBvYnNlcnZlclRva2VuOiBzdHJpbmcpIHtcclxuICAgIGlmICh0aGlzLnJ0ZlNlcnZpY2UgJiYgdGhpcy5ydGZTZXJ2aWNlLmhhc093blByb3BlcnR5KCdicm9hZGNhc3QnKSAmJiB0eXBlb2YgdGhpcy5ydGZTZXJ2aWNlWydicm9hZGNhc3QnXVsncmVzcG9uc2VVblN1YnNjcmliZSddID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIHRoaXMucnRmU2VydmljZS5icm9hZGNhc3QucmVzcG9uc2VVblN1YnNjcmliZSh0b2tlbiwgb2JzZXJ2ZXJUb2tlbik7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8vICNlbmRyZWdpb25cclxuXHJcbiAgLy8gI3JlZ2lvbiDlt6Xlhbflh73mlbBcclxuICAvKipcclxuICAgKiDmmK/lkKblkIzmupBcclxuICAgKiBAcGFyYW0gZW52aXJvbm1lbnQgd2luZG93XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpc1NhbWVPcmlnaW4oZW52aXJvbm1lbnQ6IFdpbmRvdykge1xyXG4gICAgY29uc3QgaG9zdCA9IHdpbmRvdy5sb2NhdGlvbi5ob3N0O1xyXG4gICAgdHJ5IHtcclxuICAgICAgaWYgKGVudmlyb25tZW50ICYmIGVudmlyb25tZW50LmxvY2F0aW9uICYmIHR5cGVvZiBlbnZpcm9ubWVudC5sb2NhdGlvbi5ob3N0ICE9PSAndW5kZWZpbmVkJykge1xyXG4gICAgICAgIHJldHVybiBlbnZpcm9ubWVudC5sb2NhdGlvbi5ob3N0ID09PSBob3N0O1xyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG4gIC8vICNlbmRyZWdpb25cclxufVxyXG4iXX0=