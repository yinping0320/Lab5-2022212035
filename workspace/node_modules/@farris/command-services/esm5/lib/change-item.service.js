import { Injectable } from '@angular/core';
import { Repository, FrameContext } from '@farris/devkit';
import { switchMap } from 'rxjs/operators';
import { EMPTY, Observable, Subject } from 'rxjs';
import { of } from 'rxjs/observable/of';
import { FormNotifyService } from './form-notify.service';
import { LanguageService } from './languag.service';
var POSTER = 'iframePoster';
var RECEIVER = 'iframeReceiver';
var REPOSITORY = 'repository';
// window.hash中funcId的属性名
var FUNC_ID = 'funcId=';
var TAB_ID = 'tabId=';
/**
 * ChangeItemService
 * @scope FrameComponent
 */
var ChangeItemService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function ChangeItemService(repository, frameContext, notifyService, languageService) {
        this.repository = repository;
        this.frameContext = frameContext;
        this.notifyService = notifyService;
        this.languageService = languageService;
        this.top = top;
        this.itemChangePoster = new Subject();
        this.itemChangeReceiver = new Subject();
    }
    ChangeItemService.prototype.init = function () {
        this.top['topMap'] = this.top['topMap'] || {};
        this.changeItem = this.changeItem.bind(this);
    };
    ChangeItemService.prototype.setBykey = function (key, value) {
        this.top['topMap'] = this.top['topMap'] || {};
        this.top['topMap'][this.tabId] = this.top['topMap'][this.tabId] || {};
        var topObject = this.top['topMap'][this.tabId];
        topObject[key] = value;
    };
    ChangeItemService.prototype.getByKey = function (key) {
        var topObject = this.top['topMap'][this.tabId] || {};
        return topObject[key];
    };
    // 建立iframe通信
    ChangeItemService.prototype.setIframePoster = function () {
        if (this.getByKey[POSTER]) {
            return;
        }
        else {
            this.setBykey(POSTER, this.itemChangePoster);
        }
    };
    ChangeItemService.prototype.getIframePoster = function () {
        this.itemChangePoster = this.getByKey(RECEIVER);
        this.setBykey(RECEIVER, this.itemChangeReceiver);
    };
    ChangeItemService.prototype.changeItem = function (type, id, parentId) {
        var _this = this;
        // 根据是否是弹出式卡片取不同的tabId
        var virtualRootFrameContext = this.frameContext.getVirtualRootFrameContext();
        var virtualRootComponent = virtualRootFrameContext.frameComponent;
        var isDialogComponent = virtualRootComponent['isDialogRootComponent'] || false;
        if (isDialogComponent) {
            this.tabId = window.location.hash.split(TAB_ID)[1].slice(0, window.location.hash.split(TAB_ID)[1].indexOf('&'));
        }
        else {
            this.tabId = parentId;
        }
        this.itemChangeReceiver = this.getByKey(RECEIVER);
        return Observable.create(function (subscriber) {
            _this.getNextItemByCurrentId(id, type).subscribe(function (result) {
                subscriber.next(result);
            });
        });
    };
    // 在list初始化时调用，缓存list的repository
    ChangeItemService.prototype.setRepository = function () {
        if (window.location.hash.includes(TAB_ID)) {
            this.tabId = window.location.hash.split(TAB_ID)[1].slice(0, window.location.hash.split(TAB_ID)[1].indexOf('&'));
            this.setBykey(REPOSITORY, this.frameContext.repository);
            this.setIframePoster();
            this.getIframePoster();
        }
    };
    // 根据类型和id获取相邻的数据
    ChangeItemService.prototype.getNextItemByCurrentId = function (currentId, type) {
        var repository = this.getByKey(REPOSITORY);
        var _a = repository.entityCollection.paginationInfo, pageSize = _a.pageSize, pageIndex = _a.pageIndex, total = _a.total;
        var currentIdx = null;
        var list = repository.entityCollection.getAllEntities();
        list.find(function (x, idx) {
            if (x.id === currentId) {
                currentIdx = idx;
            }
        });
        // 没有在列表中找到数据，返回空
        if (currentIdx === null) {
            // 新增取消当前无数据时点上一条下一条
            if (list.length) {
                switch (type) {
                    case 'prev':
                        return of(list[list.length - 1].id);
                        break;
                    case 'next':
                        this.notifyService.info(this.languageService.changeToLast, { hideTitle: true });
                        return EMPTY;
                }
            }
            return of(null);
        }
        var nextIdx = currentIdx;
        switch (type) {
            case 'prev':
                // 当前页第一条,且非第一页,取上一页最后一条
                if (currentIdx === 0 && pageIndex !== 1) {
                    return repository.getEntities([], [], pageSize, pageIndex - 1).pipe(switchMap(function (result) {
                        nextIdx = pageSize - 1;
                        return of(result[nextIdx].id);
                    }));
                }
                // 第一页第一条，仍返回原有数据
                else if (currentIdx === 0 && pageIndex === 1) {
                    this.notifyService.info(this.languageService.changeToFirst, { hideTitle: true });
                    return of(list[nextIdx].id);
                }
                // 不是第一条，返回上一条
                else {
                    nextIdx = currentIdx - 1;
                    return of(list[nextIdx].id);
                }
                break;
            case 'next':
                // 超过当前页
                if (currentIdx + 1 + 1 > list.length) {
                    // 且非最后一条数据,取下一页第一条数据
                    if (((pageIndex - 1) * pageSize + currentIdx + 1) < total) {
                        return repository.getEntities([], [], pageSize, pageIndex + 1).pipe(switchMap(function (result) {
                            return of(result[0].id);
                        }));
                    }
                    // 最后一条数据，仍返回原数据
                    else {
                        this.notifyService.info(this.languageService.changeToLast, { hideTitle: true });
                        return of(list[nextIdx].id);
                    }
                }
                else {
                    nextIdx = currentIdx + 1;
                    return of(list[nextIdx].id);
                }
                break;
        }
    };
    ChangeItemService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ChangeItemService.ctorParameters = function () { return [
        { type: Repository },
        { type: FrameContext },
        { type: FormNotifyService },
        { type: LanguageService }
    ]; };
    return ChangeItemService;
}());
export { ChangeItemService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbmdlLWl0ZW0uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9jaGFuZ2UtaXRlbS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQzlELE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN4QyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFHcEQsSUFBTSxNQUFNLEdBQUcsY0FBYyxDQUFDO0FBQzlCLElBQU0sUUFBUSxHQUFHLGdCQUFnQixDQUFDO0FBQ2xDLElBQU0sVUFBVSxHQUFHLFlBQVksQ0FBQztBQUNoQyx5QkFBeUI7QUFDekIsSUFBTSxPQUFPLEdBQUcsU0FBUyxDQUFDO0FBQzFCLElBQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQztBQUN4Qjs7O0dBR0c7QUFDSDtJQVFFOztPQUVHO0lBQ0gsMkJBQ1UsVUFBMkIsRUFDM0IsWUFBMEIsRUFDMUIsYUFBZ0MsRUFDaEMsZUFBZ0M7UUFIaEMsZUFBVSxHQUFWLFVBQVUsQ0FBaUI7UUFDM0IsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsa0JBQWEsR0FBYixhQUFhLENBQW1CO1FBQ2hDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQVpuQyxRQUFHLEdBQUcsR0FBRyxDQUFDO1FBR1YscUJBQWdCLEdBQUcsSUFBSSxPQUFPLEVB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LEVBQUUsQ0FBQyxDQUFDO3FCQUM3QjtpQkFDRjtxQkFBTTtvQkFDTCxPQUFPLEdBQUcsVUFBVSxHQUFHLENBQUMsQ0FBQztvQkFDekIsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO2lCQUM3QjtnQkFDRCxNQUFNO1NBQ1Q7SUFDSCxDQUFDOztnQkFuSkYsVUFBVTs7OztnQkFsQkYsVUFBVTtnQkFBRSxZQUFZO2dCQUl4QixpQkFBaUI7Z0JBQ2pCLGVBQWU7O0lBbUt4Qix3QkFBQztDQUFBLEFBdEpELElBc0pDO0FBRUQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnksIEZyYW1lQ29udGV4dCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBFTVBUWSwgT2JzZXJ2YWJsZSwgU3ViamVjdCwgU3Vic2NyaWJlciB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBvZiB9IGZyb20gJ3J4anMvb2JzZXJ2YWJsZS9vZic7XHJcbmltcG9ydCB7IEZvcm1Ob3RpZnlTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLW5vdGlmeS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9sYW5ndWFnLnNlcnZpY2UnO1xyXG5cclxuXHJcbmNvbnN0IFBPU1RFUiA9ICdpZnJhbWVQb3N0ZXInO1xyXG5jb25zdCBSRUNFSVZFUiA9ICdpZnJhbWVSZWNlaXZlcic7XHJcbmNvbnN0IFJFUE9TSVRPUlkgPSAncmVwb3NpdG9yeSc7XHJcbi8vIHdpbmRvdy5oYXNo5LitZnVuY0lk55qE5bGe5oCn5ZCNXHJcbmNvbnN0IEZVTkNfSUQgPSAnZnVuY0lkPSc7XHJcbmNvbnN0IFRBQl9JRCA9ICd0YWJJZD0nO1xyXG4vKipcclxuICogQ2hhbmdlSXRlbVNlcnZpY2VcclxuICogQHNjb3BlIEZyYW1lQ29tcG9uZW50XHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmNsYXNzIENoYW5nZUl0ZW1TZXJ2aWNlIHtcclxuXHJcbiAgcHVibGljIHRvcCA9IHRvcDtcclxuICBwcml2YXRlIGZ1bmNJZDogc3RyaW5nO1xyXG4gIHByaXZhdGUgdGFiSWQ6IHN0cmluZztcclxuICBwdWJsaWMgaXRlbUNoYW5nZVBvc3RlciA9IG5ldyBTdWJqZWN0PGFueT4oKTtcclxuICBwdWJsaWMgaXRlbUNoYW5nZVJlY2VpdmVyID0gbmV3IFN1YmplY3Q8YW55PigpO1xyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4sXHJcbiAgICBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LFxyXG4gICAgcHJpdmF0ZSBub3RpZnlTZXJ2aWNlOiBGb3JtTm90aWZ5U2VydmljZSxcclxuICAgIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2VcclxuICApIHtcclxuICB9XHJcblxyXG4gIGluaXQoKSB7XHJcbiAgICB0aGlzLnRvcFsndG9wTWFwJ10gPSB0aGlzLnRvcFsndG9wTWFwJ10gfHwge307XHJcbiAgICB0aGlzLmNoYW5nZUl0ZW0gPSB0aGlzLmNoYW5nZUl0ZW0uYmluZCh0aGlzKTtcclxuICB9XHJcblxyXG4gIHNldEJ5a2V5KGtleTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XHJcbiAgICB0aGlzLnRvcFsndG9wTWFwJ10gPSB0aGlzLnRvcFsndG9wTWFwJ10gfHwge307XHJcbiAgICB0aGlzLnRvcFsndG9wTWFwJ11bdGhpcy50YWJJZF0gPSB0aGlzLnRvcFsndG9wTWFwJ11bdGhpcy50YWJJZF0gfHwge307XHJcbiAgICBjb25zdCB0b3BPYmplY3QgPSB0aGlzLnRvcFsndG9wTWFwJ11bdGhpcy50YWJJZF07XHJcbiAgICB0b3BPYmplY3Rba2V5XSA9IHZhbHVlO1xyXG4gIH1cclxuXHJcbiAgZ2V0QnlLZXkoa2V5OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHRvcE9iamVjdCA9IHRoaXMudG9wWyd0b3BNYXAnXVt0aGlzLnRhYklkXSB8fCB7fTtcclxuICAgIHJldHVybiB0b3BPYmplY3Rba2V5XTtcclxuICB9XHJcblxyXG4gIC8vIOW7uueri2lmcmFtZemAmuS/oVxyXG4gIHNldElmcmFtZVBvc3RlcigpIHtcclxuICAgIGlmICh0aGlzLmdldEJ5S2V5W1BPU1RFUl0pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5zZXRCeWtleShQT1NURVIsIHRoaXMuaXRlbUNoYW5nZVBvc3Rlcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnZXRJZnJhbWVQb3N0ZXIoKSB7XHJcbiAgICB0aGlzLml0ZW1DaGFuZ2VQb3N0ZXIgPSB0aGlzLmdldEJ5S2V5KFJFQ0VJVkVSKTtcclxuICAgIHRoaXMuc2V0QnlrZXkoUkVDRUlWRVIsIHRoaXMuaXRlbUNoYW5nZVJlY2VpdmVyKTtcclxuICB9XHJcblxyXG4gIGNoYW5nZUl0ZW0odHlwZTogc3RyaW5nLCBpZDogc3RyaW5nLCBwYXJlbnRJZDogc3RyaW5nKSB7XHJcbiAgICAvLyDmoLnmja7mmK/lkKbmmK/lvLnlh7rlvI/ljaHniYflj5bkuI3lkIznmoR0YWJJZFxyXG4gICAgY29uc3QgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQgPSB0aGlzLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpO1xyXG4gICAgY29uc3QgdmlydHVhbFJvb3RDb21wb25lbnQgPSB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudDtcclxuICAgIGNvbnN0IGlzRGlhbG9nQ29tcG9uZW50ID0gdmlydHVhbFJvb3RDb21wb25lbnRbJ2lzRGlhbG9nUm9vdENvbXBvbmVudCddIHx8IGZhbHNlO1xyXG4gICAgaWYgKGlzRGlhbG9nQ29tcG9uZW50KSB7XHJcbiAgICAgIHRoaXMudGFiSWQgPSB3aW5kb3cubG9jYXRpb24uaGFzaC5zcGxpdChUQUJfSUQpWzFdLnNsaWNlKDAsIHdpbmRvdy5sb2NhdGlvbi5oYXNoLnNwbGl0KFRBQl9JRClbMV0uaW5kZXhPZignJicpKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMudGFiSWQgPSBwYXJlbnRJZDtcclxuICAgIH1cclxuICAgIHRoaXMuaXRlbUNoYW5nZVJlY2VpdmVyID0gdGhpcy5nZXRCeUtleShSRUNFSVZFUik7XHJcbiAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKHN1YnNjcmliZXI6IFN1YnNjcmliZXI8YW55PikgPT4ge1xyXG4gICAgICB0aGlzLmdldE5leHRJdGVtQnlDdXJyZW50SWQoaWQsIHR5cGUpLnN1YnNjcmliZSgocmVzdWx0OiBhbnkpID0+IHtcclxuICAgICAgICBzdWJzY3JpYmVyLm5leHQocmVzdWx0KTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8vIOWcqGxpc3TliJ3lp4vljJbml7bosIPnlKjvvIznvJPlrZhsaXN055qEcmVwb3NpdG9yeVxyXG4gIHNldFJlcG9zaXRvcnkoKSB7XHJcbiAgICBpZiAod2luZG93LmxvY2F0aW9uLmhhc2guaW5jbHVkZXMoVEFCX0lEKSkge1xyXG4gICAgICB0aGlzLnRhYklkID0gd2luZG93LmxvY2F0aW9uLmhhc2guc3BsaXQoVEFCX0lEKVsxXS5zbGljZSgwLCB3aW5kb3cubG9jYXRpb24uaGFzaC5zcGxpdChUQUJfSUQpWzFdLmluZGV4T2YoJyYnKSk7XHJcbiAgICAgIHRoaXMuc2V0QnlrZXkoUkVQT1NJVE9SWSwgdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSk7XHJcbiAgICAgIHRoaXMuc2V0SWZyYW1lUG9zdGVyKCk7XHJcbiAgICAgIHRoaXMuZ2V0SWZyYW1lUG9zdGVyKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyDmoLnmja7nsbvlnovlkoxpZOiOt+WPluebuOmCu+eahOaVsOaNrlxyXG4gIGdldE5leHRJdGVtQnlDdXJyZW50SWQoY3VycmVudElkOiBzdHJpbmcsIHR5cGU6IHN0cmluZykge1xyXG4gICAgY29uc3QgcmVwb3NpdG9yeSA9IHRoaXMuZ2V0QnlLZXkoUkVQT1NJVE9SWSk7XHJcbiAgICBjb25zdCB7IHBhZ2VTaXplLCBwYWdlSW5kZXgsIHRvdGFsIH0gPSByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24ucGFnaW5hdGlvbkluZm87XHJcbiAgICBsZXQgY3VycmVudElkeCA9IG51bGw7XHJcbiAgICBjb25zdCBsaXN0ID0gcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEFsbEVudGl0aWVzKCk7XHJcbiAgICBsaXN0LmZpbmQoKHg6IGFueSwgaWR4OiBzdHJpbmcpID0+IHtcclxuICAgICAgaWYgKHguaWQgPT09IGN1cnJlbnRJZCkge1xyXG4gICAgICAgIGN1cnJlbnRJZHggPSBpZHg7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgLy8g5rKh5pyJ5Zyo5YiX6KGo5Lit5om+5Yiw5pWw5o2u77yM6L+U5Zue56m6XHJcbiAgICBpZiAoY3VycmVudElkeCA9PT0gbnVsbCkge1xyXG4gICAgICAvLyDmlrDlop7lj5bmtojlvZPliY3ml6DmlbDmja7ml7bngrnkuIrkuIDmnaHkuIvkuIDmnaFcclxuICAgICAgaWYgKGxpc3QubGVuZ3RoKSB7XHJcbiAgICAgICAgc3dpdGNoICh0eXBlKSB7XHJcbiAgICAgICAgICBjYXNlICdwcmV2JzpcclxuICAgICAgICAgICAgcmV0dXJuIG9mKGxpc3RbbGlzdC5sZW5ndGggLSAxXS5pZCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgY2FzZSAnbmV4dCc6XHJcbiAgICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZS5pbmZvKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNoYW5nZVRvTGFzdCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIG9mKG51bGwpO1xyXG4gICAgfVxyXG4gICAgbGV0IG5leHRJZHggPSBjdXJyZW50SWR4O1xyXG4gICAgc3dpdGNoICh0eXBlKSB7XHJcbiAgICAgIGNhc2UgJ3ByZXYnOlxyXG4gICAgICAgIC8vIOW9k+WJjemhteesrOS4gOadoSzkuJTpnZ7nrKzkuIDpobUs5Y+W5LiK5LiA6aG15pyA5ZCO5LiA5p2hXHJcbiAgICAgICAgaWYgKGN1cnJlbnRJZHggPT09IDAgJiYgcGFnZUluZGV4ICE9PSAxKSB7XHJcbiAgICAgICAgICByZXR1cm4gcmVwb3NpdG9yeS5nZXRFbnRpdGllcyhbXSwgW10sIHBhZ2VTaXplLCBwYWdlSW5kZXggLSAxKS5waXBlKFxyXG4gICAgICAgICAgICBzd2l0Y2hNYXAocmVzdWx0ID0+IHtcclxuICAgICAgICAgICAgICBuZXh0SWR4ID0gcGFnZVNpemUgLSAxO1xyXG4gICAgICAgICAgICAgIHJldHVybiBvZihyZXN1bHRbbmV4dElkeF0uaWQpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g56ys5LiA6aG156ys5LiA5p2h77yM5LuN6L+U5Zue5Y6f5pyJ5pWw5o2uXHJcbiAgICAgICAgZWxzZSBpZiAoY3VycmVudElkeCA9PT0gMCAmJiBwYWdlSW5kZXggPT09IDEpIHtcclxuICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZS5pbmZvKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNoYW5nZVRvRmlyc3QsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgcmV0dXJuIG9mKGxpc3RbbmV4dElkeF0uaWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDkuI3mmK/nrKzkuIDmnaHvvIzov5Tlm57kuIrkuIDmnaFcclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgIG5leHRJZHggPSBjdXJyZW50SWR4IC0gMTtcclxuICAgICAgICAgIHJldHVybiBvZihsaXN0W25leHRJZHhdLmlkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGNhc2UgJ25leHQnOlxyXG4gICAgICAgIC8vIOi2hei/h+W9k+WJjemhtVxyXG4gICAgICAgIGlmIChjdXJyZW50SWR4ICsgMSArIDEgPiBsaXN0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgLy8g5LiU6Z2e5pyA5ZCO5LiA5p2h5pWw5o2uLOWPluS4i+S4gOmhteesrOS4gOadoeaVsOaNrlxyXG4gICAgICAgICAgaWYgKCgocGFnZUluZGV4IC0gMSkgKiBwYWdlU2l6ZSArIGN1cnJlbnRJZHggKyAxKSA8IHRvdGFsKSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXBvc2l0b3J5LmdldEVudGl0aWVzKFtdLCBbXSwgcGFnZVNpemUsIHBhZ2VJbmRleCArIDEpLnBpcGUoc3dpdGNoTWFwKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIG9mKHJlc3VsdFswXS5pZCk7XHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIC8vIOacgOWQjuS4gOadoeaVsOaNru+8jOS7jei/lOWbnuWOn+aVsOaNrlxyXG4gICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZS5pbmZvKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNoYW5nZVRvTGFzdCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBvZihsaXN0W25leHRJZHhdLmlkKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgbmV4dElkeCA9IGN1cnJlbnRJZHggKyAxO1xyXG4gICAgICAgICAgcmV0dXJuIG9mKGxpc3RbbmV4dElkeF0uaWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBicmVhaztcclxuICAgIH1cclxuICB9XHJcblxyXG5cclxufVxyXG5cclxuZXhwb3J0IHsgQ2hhbmdlSXRlbVNlcnZpY2UgfTtcclxuIl19