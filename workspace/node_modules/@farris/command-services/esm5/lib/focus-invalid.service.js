import { Injectable, ElementRef } from '@angular/core';
import { Repository, FrameContext } from '@farris/devkit';
import { FrameContextService } from './frame-context.service';
import { FormControlService } from './form-control.service';
var FIXED_COLUMN_START_INDEX = 5000;
var GRID_COLUMN_START_INDEX = 10000;
/**
 * 表单验证服务
 * @scope FrameComponent
 */
var FocusInvalidService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function FocusInvalidService(repository, frameContext, frameContextService, formControlService) {
        this.repository = repository;
        this.frameContext = frameContext;
        this.frameContextService = frameContextService;
        this.formControlService = formControlService;
    }
    /**
     * 向第一个验证不通过的字段设置焦点
     */
    FocusInvalidService.prototype.focusInvalidInput = function (verifyInformations, rootElement) {
        // 无验证不通过信息时，直接返回。
        if (!verifyInformations || !verifyInformations.length) {
            return;
        }
        var targetField = null;
        var firstVerifyInformation = this.selectFirstVerifyInformation(verifyInformations, rootElement);
        if (firstVerifyInformation) {
            targetField = firstVerifyInformation.targetField;
            if (targetField) {
                var canFocus = this.focusElement(targetField, rootElement);
                if (canFocus) {
                    verifyInformations['focused'] = true;
                }
            }
        }
    };
    /**
     * 设置DataGrid单元格焦点
     */
    FocusInvalidService.prototype.focusGridCell = function (verifyInformations, focusableDataGrid) {
        if (!verifyInformations || !verifyInformations.length || verifyInformations['focused'] == true || focusableDataGrid.disabled === true) {
            return;
        }
        var targetField = null;
        var targetId = null;
        var firstVerifyInformation = this.selectFirstVerifyInformation(verifyInformations);
        if (firstVerifyInformation) {
            targetField = firstVerifyInformation.targetField;
            targetId = firstVerifyInformation.id;
            verifyInformations['focused'] = true;
            focusableDataGrid.editCell(targetId, targetField);
        }
    };
    FocusInvalidService.prototype.updateVerifyInformationsIndex = function (verifyInformations, rootElement) {
        var _this = this;
        verifyInformations = verifyInformations.filter(function (verifyInformation) {
            var frameContexts = _this.getFrameContextsByPropertyPath(verifyInformation.fullPath, '/');
            var frameContext = frameContexts && frameContexts.filter(function (frameContext) { return frameContext && frameContext.frameId === _this.frameContext.frameId; });
            return frameContext ? true : false;
        });
        return verifyInformations.map(function (verifyInformation) {
            var tabIndex = -1;
            if (verifyInformation) {
                if (rootElement && verifyInformation.targetField) {
                    var input = _this.getInputElementById(verifyInformation.targetField, rootElement);
                    tabIndex = input && input.getAttribute('tabindex') || -1;
                    tabIndex = Number(tabIndex);
                }
                // const frameContexts = this.getFrameContextsByPropertyPath(verifyInformation.fullPath, '/');
                var frameContext = _this.frameContext; //frameContexts && frameContexts[0] || null;
                var frameIndex = frameContext.index + 1;
                verifyInformation.tabIndex = tabIndex;
                verifyInformation.domIndex = -1;
                verifyInformation.frameIndex = -1;
                verifyInformation.position = tabIndex;
                if (frameContext) {
                    var domIndex = verifyInformation.fullPath && _this.getFieldIndex(frameContext, verifyInformation.fullPath) || 0;
                    if (domIndex > 0) {
                        var rowIndex = verifyInformation.index || 0;
                        verifyInformation.domIndex = domIndex;
                        verifyInformation.frameIndex = frameContext.index;
                        verifyInformation.position = tabIndex > 0 ? tabIndex : (frameIndex * 1000 + rowIndex * 1000 + domIndex);
                    }
                }
            }
            return verifyInformation;
        });
    };
    FocusInvalidService.prototype.isGridComponent = function (frameContext) {
        if (frameContext) {
            var dataGridColumnsName = frameContext.viewModel['dataGridColumnsName'] || null;
            return dataGridColumnsName ? true : false;
        }
        return undefined;
    };
    FocusInvalidService.prototype.getColumnIndex = function (frameContext, binding) {
        binding = binding.split('/').filter(function (p) { return p; }).join('/');
        var bindingPaths = frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; });
        var dataGridColumnsName = frameContext.viewModel['dataGridColumnsName'] || null;
        var frameIndex = frameContext.index + 1;
        if (!dataGridColumnsName) {
            return undefined;
        }
        var columns = frameContext.viewModel[dataGridColumnsName];
        if (!columns || columns.length < 1) {
            return undefined;
        }
        // 打平columns
        columns = columns.reduce(function (results, item) {
            if (Array.isArray(item)) {
                return results.concat(item);
            }
            return results.concat([item]);
        }, []);
        var position = -1;
        var _loop_1 = function (index) {
            var column = columns[index];
            var fields = column && column.field && column.field.split('.').filter(function (p) { return p; }) || null;
            if (!fields) {
                return "continue";
            }
            if (bindingPaths.concat(fields).join('/') === binding) {
                var fixed_1 = column.fixed;
                if (fixed_1) {
                    var fixedColumns = columns.filter(function (item) { return item.fixed === fixed_1; });
                    var fixedColumnIndex = this_1.getIndexFromColumns(fixedColumns, binding);
                    if (fixed_1 === 'left') {
                        position = frameIndex * FIXED_COLUMN_START_INDEX + fixedColumnIndex;
                    }
                    else {
                        position = frameIndex * GRID_COLUMN_START_INDEX + 1000 + fixedColumnIndex;
                    }
                }
                else {
                    position = frameIndex * GRID_COLUMN_START_INDEX + index;
                }
                return "break";
            }
        };
        var this_1 = this;
        for (var index = 0; index < columns.length; index++) {
            var state_1 = _loop_1(index);
            if (state_1 === "break")
                break;
        }
        return position;
    };
    FocusInvalidService.prototype.getIndexFromColumns = function (columns, binding) {
        var bindingPaths = this.frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; });
        return columns.findIndex(function (column) {
            var fields = column && column.field && column.field.split('.').filter(function (p) { return p; }) || null;
            if (!fields) {
                return false;
            }
            if (bindingPaths.concat(fields).join('/') === binding) {
                return true;
            }
            return false;
        });
    };
    FocusInvalidService.prototype.selectFirstVerifyInformation = function (verifyInformations, rootElement) {
        verifyInformations = this.updateVerifyInformationsIndex(verifyInformations, rootElement);
        verifyInformations.sort(function (v1, v2) { return Number(v1.position) - Number(v2.position); });
        return verifyInformations && verifyInformations.length > 0 && verifyInformations[0] || null;
    };
    FocusInvalidService.prototype.getInputElementById = function (targetField, rootElement) {
        var element = rootElement.nativeElement.ownerDocument.getElementById(targetField) || null;
        if (element && element.tagName !== 'INPUT') {
            var inputs = element.getElementsByTagName('input');
            if (inputs.length) {
                element = inputs[0];
            }
        }
        return element;
    };
    FocusInvalidService.prototype.getFrameContextsByPropertyPath = function (propertyPath, separtor) {
        if (separtor === void 0) { separtor = '/'; }
        if (!propertyPath) {
            return [];
        }
        var frameContexts = this.frameContext && this.frameContext.appContext.frameContextManager.getFrameContexts() || [];
        return frameContexts.filter(function (frameContext) {
            var formControls = frameContext && frameContext.form && frameContext.form.ngFormControls || {};
            var bindingPath = frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath || '';
            if (formControls && Object.keys(formControls).length > 0) {
                var key = Object.keys(formControls).find(function (key) {
                    var formControl = formControls[key];
                    if (!formControl || !formControl.binding) {
                        return false;
                    }
                    var bindings = formControl.binding.split('.').filter(function (p) { return p; });
                    var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
                    var fullPath = bindingPaths.concat(bindings);
                    return propertyPath.split(separtor).filter(function (p) { return p; }).join('/') === fullPath.join('/');
                });
                return key ? true : false;
            }
            return false;
        });
    };
    FocusInvalidService.prototype.getFormControlIndexByBindingPath = function (frameContext, binding) {
        var ngFormControls = this.getFormControlsByFrameContext(frameContext);
        if (!ngFormControls) {
            return null;
        }
        var bindings = binding.split('/').filter(function (p) { return p; });
        return Object.values(ngFormControls).findIndex(function (ngFormControl) {
            if (!ngFormControl) {
                return false;
            }
            var bindingPath = frameContext.viewModel.bindingPath;
            var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
            var formControlBindingPaths = ngFormControl.binding.split('.').filter(function (p) { return p; });
            var fullPath = bindingPaths.concat(formControlBindingPaths);
            return fullPath.join('/') === bindings.join('/');
        });
    };
    FocusInvalidService.prototype.getFieldIndex = function (frameContext, binding) {
        var isGridComponent = this.isGridComponent(frameContext);
        if (isGridComponent) {
            return this.getColumnIndex(frameContext, binding);
        }
        else {
            return this.getFormControlIndexByBindingPath(frameContext, binding);
        }
    };
    FocusInvalidService.prototype.getFormControlsByFrameContext = function (frameContext) {
        return frameContext && frameContext.form && frameContext.form.ngFormControls || null;
    };
    FocusInvalidService.prototype.focusElement = function (elementId, rootElement) {
        var focused = false;
        var elementToFocus = rootElement.nativeElement.ownerDocument.getElementById(elementId);
        // 未获取到指定字段时，返回，不再设置焦点。
        if (elementToFocus) {
            // 如果有多个id重复的元素，则不定位
            var elements = rootElement.nativeElement.ownerDocument.querySelectorAll("#" + elementId);
            if (elements && elements.length > 1) {
                return focused;
            }
            // 如果绑定目标字段的控件不是Input元素，则查找其下级节点。
            if (elementToFocus.tagName !== 'INPUT') {
                var subElements = elementToFocus.getElementsByTagName('input');
                if (subElements.length) {
                    elementToFocus = subElements[0];
                }
            }
            elementToFocus.focus();
            focused = true;
        }
        return focused;
    };
    /**
     * 设置焦点
     * @param verifyInformation 错误信息
     * @param frameContext 上下文
     * @returns
     */
    FocusInvalidService.prototype.focus = function (verifyInformation, frameContext) {
        if (!verifyInformation) {
            return;
        }
        var isGridValidation = verifyInformation.index !== null;
        if (isGridValidation) {
            var grid_1 = this.getGridRef(frameContext);
            if (grid_1) {
                setTimeout(function () {
                    grid_1.editCell(verifyInformation.id, verifyInformation.targetField);
                }, 0);
            }
        }
        else {
            var frameElement_1 = this.getComponentRef(frameContext);
            var elementId = verifyInformation.targetField;
            this.focusById(elementId, frameElement_1);
        }
    };
    /**
     * 通过控件id设置焦点
     * @param elementId
     * @param elementRef
     */
    FocusInvalidService.prototype.focusById = function (elementId, elementRef) {
        var document = elementRef && elementRef.nativeElement.ownerDocument || window.document;
        if (document) {
            var element = document.getElementById(elementId);
            if (element.tagName !== 'INPUT') {
                var subElements = element.getElementsByTagName('input');
                if (subElements.length) {
                    var input = subElements[0];
                    if (input && typeof input.focus === 'function') {
                        input.focus();
                    }
                }
            }
            else {
                element.focus();
            }
        }
    };
    /**
     * 获取组件实例
     * @param frameContext
     * @returns
     */
    FocusInvalidService.prototype.getComponentRef = function (frameContext) {
        return this.frameContext && this.frameContext.injector.get(ElementRef, null) || null;
    };
    /**
     * 获取grid实例
     * @param frameContext frameContext
     * @returns
     */
    FocusInvalidService.prototype.getGridRef = function (frameContext) {
        var _this = this;
        var namespace = frameContext.namespace;
        var bindingPath = frameContext.viewModel.bindingPath;
        var frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace) || [];
        var matchedFrameContexts = frameContexts.filter(function (frameContext) { return frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; }).toString() === bindingPath.split('/').filter(function (p) { return p; }).toString(); });
        var result = null;
        if (matchedFrameContexts) {
            matchedFrameContexts.every(function (frameContext) {
                var frameId = frameContext.frameId;
                var componentsMap = _this.frameContext.appContext.componentManager.getComponentsByFrameId(frameId);
                if (!componentsMap) {
                    return true;
                }
                var datagridComponent = Array.from(componentsMap.values()).find(function (component) { return component && component['__component_type__'] === 'DatagridComponent'; });
                if (datagridComponent) {
                    result = datagridComponent;
                    return false;
                }
                else {
                    return true;
                }
            });
        }
        return result;
    };
    FocusInvalidService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    FocusInvalidService.ctorParameters = function () { return [
        { type: Repository },
        { type: FrameContext },
        { type: FrameContextService },
        { type: FormControlService }
    ]; };
    return FocusInvalidService;
}());
export { FocusInvalidService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9jdXMtaW52YWxpZC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2ZvY3VzLWludmFsaWQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RCxPQUFPLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBaUIsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUU1RCxJQUFNLHdCQUF3QixHQUFHLElBQUksQ0FBQztBQUN0QyxJQUFNLHVCQUF1QixHQUFHLEtBQUssQ0FBQztBQU10Qzs7O0dBR0c7QUFDSDtJQUVFOztPQUVHO0lBQ0gsNkJBQ1UsVUFBMkIsRUFDM0IsWUFBMEIsRUFDMUIsbUJBQXdDLEVBQ3hDLGtCQUFzQztRQUh0QyxlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7SUFFaEQsQ0FBQztJQUVEOztPQUVHO0lBQ0ksK0NBQWlCLEdBQXhCLFVBQXlCLGtCQUF5QixFQUFFLFdBQTRCO1FBQzlFLGtCQUFrQjtRQUNsQixJQUFJLENBQUMsa0JBQWtCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLEVBQUU7WUFDckQsT0FBTztTQUNSO1FBQ0QsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDO1FBQ3ZCLElBQU0sc0JBQXNCLEdBQUcsSUFBSSxDQUFDLDRCQUE0QixDQUFDLGtCQUFrQixFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQ2xHLElBQUksc0JBQXNCLEVBQUU7WUFDMUIsV0FBVyxHQUFHLHNCQUFzQixDQUFDLFdBQVcsQ0FBQztZQUNqRCxJQUFJLFdBQVcsRUFBRTtnQkFDZixJQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxXQUFXLENBQUMsQ0FBQztnQkFDN0QsSUFBSSxRQUFRLEVBQUU7b0JBQ1osa0JBQWtCLENBQUMsU0FBUyxDQUFDLEdBQUcsSUFBSSxDQUFDO2lCQUN0QzthQUNGO1NBQ0Y7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSSwyQ0FBYSxHQUFwQixVQUFxQixrQkFBeUIsRUFBRSxpQkFBNEM7UUFDMUYsSUFBSSxDQUFDLGtCQUFrQixJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxJQUFJLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksSUFBSSxpQkFBaUIsQ0FBQyxRQUFRLEtBQUssSUFBSSxFQUFFO1lBQ3JJLE9BQU87U0FDUjtRQUNELElBQUksV0FBVyxHQUFHLElBQUksQ0FBQztRQUN2QixJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDcEIsSUFBTSxzQkFBc0IsR0FBRyxJQUFJLENBQUMsNEJBQTRCLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUNyRixJQUFJLHNCQUFzQixFQUFFO1lBQzFCLFdBQVcsR0FBRyxzQkFBc0IsQ0FBQyxXQUFXLENBQUM7WUFDakQsUUFBUSxHQUFHLHNCQUFzQixDQUFDLEVBQUUsQ0FBQztZQUNyQyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDckMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FBQztTQUNuRDtJQUNILENBQUM7SUFDTywyREFBNkIsR0FBckMsVUFBc0Msa0JBQXlCLEVBQUUsV0FBNkI7UUFBOUYsaUJBaUNDO1FBaENDLGtCQUFrQixHQUFHLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxVQUFDLGlCQUFzQjtZQUNwRSxJQUFNLGFBQWEsR0FBRyxLQUFJLENBQUMsOEJBQThCLENBQUMsaUJBQWlCLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQzNGLElBQU0sWUFBWSxHQUFHLGFBQWEsSUFBSSxhQUFhLENBQUMsTUFBTSxDQUFDLFVBQUEsWUFBWSxJQUFJLE9BQUEsWUFBWSxJQUFJLFlBQVksQ0FBQyxPQUFPLEtBQUssS0FBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQWxFLENBQWtFLENBQUMsQ0FBQztZQUMvSSxPQUFPLFlBQVksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDckMsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxVQUFDLGlCQUFzQjtZQUNuRCxJQUFJLFFBQVEsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNsQixJQUFJLGlCQUFpQixFQUFFO2dCQUNyQixJQUFJLFdBQVcsSUFBSSxpQkFBaUIsQ0FBQyxXQUFXLEVBQUU7b0JBQ2hELElBQU0sS0FBSyxHQUFHLEtBQUksQ0FBQyxtQkFBbUIsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLENBQUM7b0JBQ25GLFFBQVEsR0FBRyxLQUFLLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztvQkFDekQsUUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztpQkFDN0I7Z0JBQ0QsOEZBQThGO2dCQUM5RixJQUFNLFlBQVksR0FBRyxLQUFJLENBQUMsWUFBWSxDQUFDLENBQUEsNENBQTRDO2dCQUNuRixJQUFNLFVBQVUsR0FBRyxZQUFZLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztnQkFDMUMsaUJBQWlCLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztnQkFDdEMsaUJBQWlCLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUNoQyxpQkFBaUIsQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xDLGlCQUFpQixDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7Z0JBQ3RDLElBQUksWUFBWSxFQUFFO29CQUNoQixJQUFNLFFBQVEsR0FBRyxpQkFBaUIsQ0FBQyxRQUFRLElBQUksS0FBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLEVBQUUsaUJBQWlCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUNqSCxJQUFJLFFBQVEsR0FBRyxDQUFDLEVBQUU7d0JBQ2hCLElBQU0sUUFBUSxHQUFHLGlCQUFpQixDQUFDLEtBQUssSUFBSSxDQUFDLENBQUM7d0JBQzlDLGlCQUFpQixDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7d0JBQ3RDLGlCQUFpQixDQUFDLFVBQVUsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDO3dCQUNsRCxpQkFBaUIsQ0FBQyxRQUFRLEdBQUcsUUFBUSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsR0FBRyxJQUFJLEdBQUcsUUFBUSxHQUFHLElBQUksR0FBRyxRQUFRLENBQUMsQ0FBQztxQkFDekc7aUJBQ0Y7YUFDRjtZQUNELE9BQU8saUJBQWlCLENBQUM7UUFDM0IsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ08sNkNBQWUsR0FBdkIsVUFBd0IsWUFBMEI7UUFDaEQsSUFBSSxZQUFZLEVBQUU7WUFDaEIsSUFBTSxtQkFBbUIsR0FBRyxZQUFZLENBQUMsU0FBUyxDQUFDLHFCQUFxQixDQUFDLElBQUksSUFBSSxDQUFDO1lBQ2xGLE9BQU8sbUJBQW1CLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1NBQzNDO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUNPLDRDQUFjLEdBQXRCLFVBQXVCLFlBQTBCLEVBQUUsT0FBZTtRQUNoRSxPQUFPLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEVBQUQsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RELElBQU0sWUFBWSxHQUFHLFlBQVksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEVBQUQsQ0FBQyxDQUFDLENBQUM7UUFDbEYsSUFBTSxtQkFBbUIsR0FBRyxZQUFZLENBQUMsU0FBUyxDQUFDLHFCQUFxQixDQUFDLElBQUksSUFBSSxDQUFDO1FBQ2xGLElBQU0sVUFBVSxHQUFHLFlBQVksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxtQkFBbUIsRUFBRTtZQUN4QixPQUFPLFNBQVMsQ0FBQztTQUNsQjtRQUNELElBQUksT0FBTyxHQUFVLFlBQVksQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUNqRSxJQUFJLENBQUMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ2xDLE9BQU8sU0FBUyxDQUFDO1NBQ2xCO1FBQ0QsWUFBWTtRQUNaLE9BQU8sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLFVBQUMsT0FBYyxFQUFFLElBQUk7WUFDNUMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUN2QixPQUFPLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDN0I7WUFDRCxPQUFPLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2hDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNQLElBQUksUUFBUSxHQUFHLENBQUMsQ0FBQyxDQUFDO2dDQUNULEtBQUs7WUFDWixJQUFNLE1BQU0sR0FBZ0IsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzNDLElBQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxNQUFNLENBQUMsS0FBSyxJQUFJLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsRUFBRCxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUM7WUFDeEYsSUFBSSxDQUFDLE1BQU0sRUFBRTs7YUFFWjtZQUNELElBQUksWUFBWSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssT0FBTyxFQUFFO2dCQUNyRCxJQUFNLE9BQUssR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDO2dCQUMzQixJQUFJLE9BQUssRUFBRTtvQkFDVCxJQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLFVBQUEsSUFBSSxJQUFJLE9BQUEsSUFBSSxDQUFDLEtBQUssS0FBSyxPQUFLLEVBQXBCLENBQW9CLENBQUMsQ0FBQztvQkFDbEUsSUFBTSxnQkFBZ0IsR0FBRyxPQUFLLG1CQUFtQixDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsQ0FBQztvQkFDekUsSUFBSSxPQUFLLEtBQUssTUFBTSxFQUFFO3dCQUNwQixRQUFRLEdBQUcsVUFBVSxHQUFHLHdCQUF3QixHQUFHLGdCQUFnQixDQUFDO3FCQUNyRTt5QkFBTTt3QkFDTCxRQUFRLEdBQUcsVUFBVSxHQUFHLHVCQUF1QixHQUFHLElBQUksR0FBRyxnQkFBZ0IsQ0FBQztxQkFDM0U7aUJBQ0Y7cUJBQU07b0JBQ0wsUUFBUSxHQUFHLFVBQVUsR0FBRyx1QkFBdUIsR0FBRyxLQUFLLENBQUM7aUJBQ3pEOzthQUVGOzs7UUFwQkgsS0FBSyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsS0FBSyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFO2tDQUExQyxLQUFLOzs7U0FxQmI7UUFDRCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBQ08saURBQW1CLEdBQTNCLFVBQTRCLE9BQWMsRUFBRSxPQUFlO1FBQ3pELElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFELENBQUMsQ0FBQyxDQUFDO1FBQ3ZGLE9BQU8sT0FBTyxDQUFDLFNBQVMsQ0FBQyxVQUFBLE1BQU07WUFDN0IsSUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLE1BQU0sQ0FBQyxLQUFLLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFELENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQztZQUN4RixJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNYLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7WUFDRCxJQUFJLFlBQVksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLE9BQU8sRUFBRTtnQkFDckQsT0FBTyxJQUFJLENBQUM7YUFDYjtZQUNELE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ08sMERBQTRCLEdBQXBDLFVBQXFDLGtCQUF5QixFQUFFLFdBQTZCO1FBQzNGLGtCQUFrQixHQUFHLElBQUksQ0FBQyw2QkFBNkIsQ0FBQyxrQkFBa0IsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUN6RixrQkFBa0IsQ0FBQyxJQUFJLENBQUMsVUFBQyxFQUFPLEVBQUUsRUFBTyxJQUFLLE9BQUEsTUFBTSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsR0FBRyxNQUFNLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUF6QyxDQUF5QyxDQUFDLENBQUM7UUFDekYsT0FBTyxrQkFBa0IsSUFBSSxrQkFBa0IsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQztJQUM5RixDQUFDO0lBQ08saURBQW1CLEdBQTNCLFVBQTRCLFdBQW1CLEVBQUUsV0FBNEI7UUFDM0UsSUFBSSxPQUFPLEdBQUcsV0FBVyxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLElBQUksQ0FBQztRQUMxRixJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxLQUFLLE9BQU8sRUFBRTtZQUMxQyxJQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDckQsSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFO2dCQUNqQixPQUFPLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ3JCO1NBQ0Y7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBQ00sNERBQThCLEdBQXJDLFVBQXNDLFlBQW9CLEVBQUUsUUFBc0I7UUFBdEIseUJBQUEsRUFBQSxjQUFzQjtRQUNoRixJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ2pCLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFDRCxJQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLG1CQUFtQixDQUFDLGdCQUFnQixFQUFFLElBQUksRUFBRSxDQUFDO1FBQ3JILE9BQU8sYUFBYSxDQUFDLE1BQU0sQ0FBQyxVQUFDLFlBQTBCO1lBQ3JELElBQU0sWUFBWSxHQUFHLFlBQVksSUFBSSxZQUFZLENBQUMsSUFBSSxJQUFJLFlBQVksQ0FBQyxJQUFJLENBQUMsY0FBYyxJQUFJLEVBQUUsQ0FBQztZQUNqRyxJQUFNLFdBQVcsR0FBRyxZQUFZLElBQUksWUFBWSxDQUFDLFNBQVMsSUFBSSxZQUFZLENBQUMsU0FBUyxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUM7WUFDdkcsSUFBSSxZQUFZLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUN4RCxJQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLEdBQVc7b0JBQ3JELElBQU0sV0FBVyxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDdEMsSUFBSSxDQUFDLFdBQVcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUU7d0JBQ3hDLE9BQU8sS0FBSyxDQUFDO3FCQUNkO29CQUNELElBQU0sUUFBUSxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsRUFBRCxDQUFDLENBQUMsQ0FBQztvQkFDL0QsSUFBTSxZQUFZLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEVBQUQsQ0FBQyxDQUFDLENBQUM7b0JBQzNELElBQU0sUUFBUSxHQUFHLFlBQVksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7b0JBQy9DLE9BQU8sWUFBWSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEVBQUQsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ3RGLENBQUMsQ0FBQyxDQUFDO2dCQUNILE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQzthQUMzQjtZQUNELE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ00sOERBQWdDLEdBQXZDLFVBQXdDLFlBQTBCLEVBQUUsT0FBZTtRQUNqRixJQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsNkJBQTZCLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDeEUsSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUNuQixPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsSUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEVBQUQsQ0FBQyxDQUFDLENBQUM7UUFDbkQsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxVQUFDLGFBQTRCO1lBQzFFLElBQUksQ0FBQyxhQUFhLEVBQUU7Z0JBQ2xCLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7WUFDRCxJQUFNLFdBQVcsR0FBRyxZQUFZLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQztZQUN2RCxJQUFNLFlBQVksR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsRUFBRCxDQUFDLENBQUMsQ0FBQztZQUMzRCxJQUFNLHVCQUF1QixHQUFHLGFBQWEsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsRUFBRCxDQUFDLENBQUMsQ0FBQztZQUNoRixJQUFNLFFBQVEsR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDLHVCQUF1QixDQUFDLENBQUM7WUFDOUQsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbkQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ00sMkNBQWEsR0FBcEIsVUFBcUIsWUFBMEIsRUFBRSxPQUFlO1FBQzlELElBQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDM0QsSUFBSSxlQUFlLEVBQUU7WUFDbkIsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsQ0FBQztTQUNuRDthQUFNO1lBQ0wsT0FBTyxJQUFJLENBQUMsZ0NBQWdDLENBQUMsWUFBWSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQ3JFO0lBQ0gsQ0FBQztJQUNNLDJEQUE2QixHQUFwQyxVQUFxQyxZQUEwQjtRQUM3RCxPQUFPLFlBQVksSUFBSSxZQUFZLENBQUMsSUFBSSxJQUFJLFlBQVksQ0FBQyxJQUFJLENBQUMsY0FBYyxJQUFJLElBQUksQ0FBQztJQUN2RixDQUFDO0lBQ00sMENBQVksR0FBbkIsVUFBb0IsU0FBaUIsRUFBRSxXQUE0QjtRQUNqRSxJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDcEIsSUFBSSxjQUFjLEdBQUcsV0FBVyxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZGLHVCQUF1QjtRQUN2QixJQUFJLGNBQWMsRUFBRTtZQUNsQixvQkFBb0I7WUFDcEIsSUFBTSxRQUFRLEdBQUcsV0FBVyxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLENBQUMsTUFBSSxTQUFXLENBQUMsQ0FBQztZQUMzRixJQUFJLFFBQVEsSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDbkMsT0FBTyxPQUFPLENBQUM7YUFDaEI7WUFDRCxpQ0FBaUM7WUFDakMsSUFBSSxjQUFjLENBQUMsT0FBTyxLQUFLLE9BQU8sRUFBRTtnQkFDdEMsSUFBTSxXQUFXLEdBQUcsY0FBYyxDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNqRSxJQUFJLFdBQVcsQ0FBQyxNQUFNLEVBQUU7b0JBQ3RCLGNBQWMsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQ2pDO2FBQ0Y7WUFDRCxjQUFjLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDdkIsT0FBTyxHQUFHLElBQUksQ0FBQztTQUNoQjtRQUNELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFDRDs7Ozs7T0FLRztJQUNJLG1DQUFLLEdBQVosVUFBYSxpQkFBc0IsRUFBRSxZQUEwQjtRQUM3RCxJQUFJLENBQUMsaUJBQWlCLEVBQUU7WUFDdEIsT0FBTztTQUNSO1FBQ0QsSUFBTSxnQkFBZ0IsR0FBRyxpQkFBaUIsQ0FBQyxLQUFLLEtBQUssSUFBSSxDQUFDO1FBQzFELElBQUksZ0JBQWdCLEVBQUU7WUFDcEIsSUFBTSxNQUFJLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUMzQyxJQUFJLE1BQUksRUFBRTtnQkFDUixVQUFVLENBQUM7b0JBQ1QsTUFBSSxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLEVBQUUsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7Z0JBQ3JFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQzthQUNQO1NBQ0Y7YUFBTTtZQUNMLElBQU0sY0FBWSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDeEQsSUFBTSxTQUFTLEdBQUcsaUJBQWlCLENBQUMsV0FBVyxDQUFDO1lBQ2hELElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLGNBQVksQ0FBQyxDQUFDO1NBQ3pDO0lBQ0gsQ0FBQztJQUVEOzs7O09BSUc7SUFDSyx1Q0FBUyxHQUFqQixVQUFrQixTQUFpQixFQUFFLFVBQXVCO1FBQzFELElBQU0sUUFBUSxHQUFRLFVBQVUsSUFBSSxVQUFVLENBQUMsYUFBYSxDQUFDLGFBQWEsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDO1FBQzlGLElBQUksUUFBUSxFQUFFO1lBQ1osSUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNuRCxJQUFJLE9BQU8sQ0FBQyxPQUFPLEtBQUssT0FBTyxFQUFFO2dCQUMvQixJQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQzFELElBQUksV0FBVyxDQUFDLE1BQU0sRUFBRTtvQkFDdEIsSUFBTSxLQUFLLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUM3QixJQUFJLEtBQUssSUFBSSxPQUFPLEtBQUssQ0FBQyxLQUFLLEtBQUssVUFBVSxFQUFFO3dCQUM5QyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7cUJBQ2Y7aUJBQ0Y7YUFDRjtpQkFBTTtnQkFDTCxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7YUFDakI7U0FDRjtJQUNILENBQUM7SUFDRDs7OztPQUlHO0lBQ0ssNkNBQWUsR0FBdkIsVUFBd0IsWUFBMEI7UUFDaEQsT0FBTyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBYSxVQUFVLEVBQUUsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDO0lBQ25HLENBQUM7SUFDRDs7OztPQUlHO0lBQ0ssd0NBQVUsR0FBbEIsVUFBbUIsWUFBMEI7UUFBN0MsaUJBdUJDO1FBdEJDLElBQU0sU0FBUyxHQUFHLFlBQVksQ0FBQyxTQUFTLENBQUM7UUFDekMsSUFBTSxXQUFXLEdBQUcsWUFBWSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUM7UUFDdkQsSUFBTSxhQUFhLEdBQW1CLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLG1CQUFtQixDQUFDLDJCQUEyQixDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNwSSxJQUFNLG9CQUFvQixHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsVUFBQyxZQUEwQixJQUFLLE9BQUEsWUFBWSxDQUFDLFNBQVMsSUFBSSxZQUFZLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFELENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxLQUFLLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFELENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUF0SixDQUFzSixDQUFDLENBQUM7UUFDMU8sSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUksb0JBQW9CLEVBQUU7WUFDeEIsb0JBQW9CLENBQUMsS0FBSyxDQUFDLFVBQUMsWUFBMEI7Z0JBQ3BELElBQU0sT0FBTyxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUM7Z0JBQ3JDLElBQU0sYUFBYSxHQUFHLEtBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLHNCQUFzQixDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNwRyxJQUFJLENBQUMsYUFBYSxFQUFFO29CQUNsQixPQUFPLElBQUksQ0FBQztpQkFDYjtnQkFDRCxJQUFNLGlCQUFpQixHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsU0FBYyxJQUFLLE9BQUEsU0FBUyxJQUFJLFNBQVMsQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLG1CQUFtQixFQUFwRSxDQUFvRSxDQUFDLENBQUM7Z0JBQzVKLElBQUksaUJBQWlCLEVBQUU7b0JBQ3JCLE1BQU0sR0FBRyxpQkFBaUIsQ0FBQztvQkFDM0IsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7cUJBQU07b0JBQ0wsT0FBTyxJQUFJLENBQUM7aUJBQ2I7WUFDSCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQzs7Z0JBalVGLFVBQVU7Ozs7Z0JBZkYsVUFBVTtnQkFBRSxZQUFZO2dCQUN4QixtQkFBbUI7Z0JBQ25CLGtCQUFrQjs7SUErVTNCLDBCQUFDO0NBQUEsQUFsVUQsSUFrVUM7QUFFRCxPQUFPLEVBQTZCLG1CQUFtQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnksIEZyYW1lQ29udGV4dCwgTmdGb3JtQ29udHJvbCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0U2VydmljZSB9IGZyb20gJy4vZnJhbWUtY29udGV4dC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRm9ybUNvbnRyb2xTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLWNvbnRyb2wuc2VydmljZSc7XHJcblxyXG5jb25zdCBGSVhFRF9DT0xVTU5fU1RBUlRfSU5ERVggPSA1MDAwO1xyXG5jb25zdCBHUklEX0NPTFVNTl9TVEFSVF9JTkRFWCA9IDEwMDAwO1xyXG5pbnRlcmZhY2UgRm9jdXNhYmxlSW52YWxpZGF0aW9uR3JpZCB7XHJcbiAgZWRpdENlbGwocm93SWQ6IGFueSwgZmllbGQ6IHN0cmluZyk6IHZvaWQ7XHJcbiAgZGlzYWJsZWQ6IGJvb2xlYW47XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDooajljZXpqozor4HmnI3liqFcclxuICogQHNjb3BlIEZyYW1lQ29tcG9uZW50XHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmNsYXNzIEZvY3VzSW52YWxpZFNlcnZpY2Uge1xyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4sXHJcbiAgICBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LFxyXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHRTZXJ2aWNlOiBGcmFtZUNvbnRleHRTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBmb3JtQ29udHJvbFNlcnZpY2U6IEZvcm1Db250cm9sU2VydmljZVxyXG4gICkge1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5ZCR56ys5LiA5Liq6aqM6K+B5LiN6YCa6L+H55qE5a2X5q616K6+572u54Sm54K5XHJcbiAgICovXHJcbiAgcHVibGljIGZvY3VzSW52YWxpZElucHV0KHZlcmlmeUluZm9ybWF0aW9uczogYW55W10sIHJvb3RFbGVtZW50OiBFbGVtZW50UmVmPGFueT4pIHtcclxuICAgIC8vIOaXoOmqjOivgeS4jemAmui/h+S/oeaBr+aXtu+8jOebtOaOpei/lOWbnuOAglxyXG4gICAgaWYgKCF2ZXJpZnlJbmZvcm1hdGlvbnMgfHwgIXZlcmlmeUluZm9ybWF0aW9ucy5sZW5ndGgpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgbGV0IHRhcmdldEZpZWxkID0gbnVsbDtcclxuICAgIGNvbnN0IGZpcnN0VmVyaWZ5SW5mb3JtYXRpb24gPSB0aGlzLnNlbGVjdEZpcnN0VmVyaWZ5SW5mb3JtYXRpb24odmVyaWZ5SW5mb3JtYXRpb25zLCByb290RWxlbWVudCk7XHJcbiAgICBpZiAoZmlyc3RWZXJpZnlJbmZvcm1hdGlvbikge1xyXG4gICAgICB0YXJnZXRGaWVsZCA9IGZpcnN0VmVyaWZ5SW5mb3JtYXRpb24udGFyZ2V0RmllbGQ7XHJcbiAgICAgIGlmICh0YXJnZXRGaWVsZCkge1xyXG4gICAgICAgIGNvbnN0IGNhbkZvY3VzID0gdGhpcy5mb2N1c0VsZW1lbnQodGFyZ2V0RmllbGQsIHJvb3RFbGVtZW50KTtcclxuICAgICAgICBpZiAoY2FuRm9jdXMpIHtcclxuICAgICAgICAgIHZlcmlmeUluZm9ybWF0aW9uc1snZm9jdXNlZCddID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuvue9rkRhdGFHcmlk5Y2V5YWD5qC854Sm54K5XHJcbiAgICovXHJcbiAgcHVibGljIGZvY3VzR3JpZENlbGwodmVyaWZ5SW5mb3JtYXRpb25zOiBhbnlbXSwgZm9jdXNhYmxlRGF0YUdyaWQ6IEZvY3VzYWJsZUludmFsaWRhdGlvbkdyaWQpIHtcclxuICAgIGlmICghdmVyaWZ5SW5mb3JtYXRpb25zIHx8ICF2ZXJpZnlJbmZvcm1hdGlvbnMubGVuZ3RoIHx8IHZlcmlmeUluZm9ybWF0aW9uc1snZm9jdXNlZCddID09IHRydWUgfHwgZm9jdXNhYmxlRGF0YUdyaWQuZGlzYWJsZWQgPT09IHRydWUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgbGV0IHRhcmdldEZpZWxkID0gbnVsbDtcclxuICAgIGxldCB0YXJnZXRJZCA9IG51bGw7XHJcbiAgICBjb25zdCBmaXJzdFZlcmlmeUluZm9ybWF0aW9uID0gdGhpcy5zZWxlY3RGaXJzdFZlcmlmeUluZm9ybWF0aW9uKHZlcmlmeUluZm9ybWF0aW9ucyk7XHJcbiAgICBpZiAoZmlyc3RWZXJpZnlJbmZvcm1hdGlvbikge1xyXG4gICAgICB0YXJnZXRGaWVsZCA9IGZpcnN0VmVyaWZ5SW5mb3JtYXRpb24udGFyZ2V0RmllbGQ7XHJcbiAgICAgIHRhcmdldElkID0gZmlyc3RWZXJpZnlJbmZvcm1hdGlvbi5pZDtcclxuICAgICAgdmVyaWZ5SW5mb3JtYXRpb25zWydmb2N1c2VkJ10gPSB0cnVlO1xyXG4gICAgICBmb2N1c2FibGVEYXRhR3JpZC5lZGl0Q2VsbCh0YXJnZXRJZCwgdGFyZ2V0RmllbGQpO1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIHVwZGF0ZVZlcmlmeUluZm9ybWF0aW9uc0luZGV4KHZlcmlmeUluZm9ybWF0aW9uczogYW55W10sIHJvb3RFbGVtZW50PzogRWxlbWVudFJlZjxhbnk+KSB7XHJcbiAgICB2ZXJpZnlJbmZvcm1hdGlvbnMgPSB2ZXJpZnlJbmZvcm1hdGlvbnMuZmlsdGVyKCh2ZXJpZnlJbmZvcm1hdGlvbjogYW55KSA9PiB7XHJcbiAgICAgIGNvbnN0IGZyYW1lQ29udGV4dHMgPSB0aGlzLmdldEZyYW1lQ29udGV4dHNCeVByb3BlcnR5UGF0aCh2ZXJpZnlJbmZvcm1hdGlvbi5mdWxsUGF0aCwgJy8nKTtcclxuICAgICAgY29uc3QgZnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0cyAmJiBmcmFtZUNvbnRleHRzLmZpbHRlcihmcmFtZUNvbnRleHQgPT4gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5mcmFtZUlkID09PSB0aGlzLmZyYW1lQ29udGV4dC5mcmFtZUlkKTtcclxuICAgICAgcmV0dXJuIGZyYW1lQ29udGV4dCA/IHRydWUgOiBmYWxzZTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHZlcmlmeUluZm9ybWF0aW9ucy5tYXAoKHZlcmlmeUluZm9ybWF0aW9uOiBhbnkpID0+IHtcclxuICAgICAgbGV0IHRhYkluZGV4ID0gLTE7XHJcbiAgICAgIGlmICh2ZXJpZnlJbmZvcm1hdGlvbikge1xyXG4gICAgICAgIGlmIChyb290RWxlbWVudCAmJiB2ZXJpZnlJbmZvcm1hdGlvbi50YXJnZXRGaWVsZCkge1xyXG4gICAgICAgICAgY29uc3QgaW5wdXQgPSB0aGlzLmdldElucHV0RWxlbWVudEJ5SWQodmVyaWZ5SW5mb3JtYXRpb24udGFyZ2V0RmllbGQsIHJvb3RFbGVtZW50KTtcclxuICAgICAgICAgIHRhYkluZGV4ID0gaW5wdXQgJiYgaW5wdXQuZ2V0QXR0cmlidXRlKCd0YWJpbmRleCcpIHx8IC0xO1xyXG4gICAgICAgICAgdGFiSW5kZXggPSBOdW1iZXIodGFiSW5kZXgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBjb25zdCBmcmFtZUNvbnRleHRzID0gdGhpcy5nZXRGcmFtZUNvbnRleHRzQnlQcm9wZXJ0eVBhdGgodmVyaWZ5SW5mb3JtYXRpb24uZnVsbFBhdGgsICcvJyk7XHJcbiAgICAgICAgY29uc3QgZnJhbWVDb250ZXh0ID0gdGhpcy5mcmFtZUNvbnRleHQ7Ly9mcmFtZUNvbnRleHRzICYmIGZyYW1lQ29udGV4dHNbMF0gfHwgbnVsbDtcclxuICAgICAgICBjb25zdCBmcmFtZUluZGV4ID0gZnJhbWVDb250ZXh0LmluZGV4ICsgMTtcclxuICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbi50YWJJbmRleCA9IHRhYkluZGV4O1xyXG4gICAgICAgIHZlcmlmeUluZm9ybWF0aW9uLmRvbUluZGV4ID0gLTE7XHJcbiAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb24uZnJhbWVJbmRleCA9IC0xO1xyXG4gICAgICAgIHZlcmlmeUluZm9ybWF0aW9uLnBvc2l0aW9uID0gdGFiSW5kZXg7XHJcbiAgICAgICAgaWYgKGZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgICAgY29uc3QgZG9tSW5kZXggPSB2ZXJpZnlJbmZvcm1hdGlvbi5mdWxsUGF0aCAmJiB0aGlzLmdldEZpZWxkSW5kZXgoZnJhbWVDb250ZXh0LCB2ZXJpZnlJbmZvcm1hdGlvbi5mdWxsUGF0aCkgfHwgMDtcclxuICAgICAgICAgIGlmIChkb21JbmRleCA+IDApIHtcclxuICAgICAgICAgICAgY29uc3Qgcm93SW5kZXggPSB2ZXJpZnlJbmZvcm1hdGlvbi5pbmRleCB8fCAwO1xyXG4gICAgICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbi5kb21JbmRleCA9IGRvbUluZGV4O1xyXG4gICAgICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbi5mcmFtZUluZGV4ID0gZnJhbWVDb250ZXh0LmluZGV4O1xyXG4gICAgICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbi5wb3NpdGlvbiA9IHRhYkluZGV4ID4gMCA/IHRhYkluZGV4IDogKGZyYW1lSW5kZXggKiAxMDAwICsgcm93SW5kZXggKiAxMDAwICsgZG9tSW5kZXgpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdmVyaWZ5SW5mb3JtYXRpb247XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHJpdmF0ZSBpc0dyaWRDb21wb25lbnQoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpIHtcclxuICAgIGlmIChmcmFtZUNvbnRleHQpIHtcclxuICAgICAgY29uc3QgZGF0YUdyaWRDb2x1bW5zTmFtZSA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWxbJ2RhdGFHcmlkQ29sdW1uc05hbWUnXSB8fCBudWxsO1xyXG4gICAgICByZXR1cm4gZGF0YUdyaWRDb2x1bW5zTmFtZSA/IHRydWUgOiBmYWxzZTtcclxuICAgIH1cclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0Q29sdW1uSW5kZXgoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIGJpbmRpbmc6IHN0cmluZykge1xyXG4gICAgYmluZGluZyA9IGJpbmRpbmcuc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS5qb2luKCcvJyk7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICBjb25zdCBkYXRhR3JpZENvbHVtbnNOYW1lID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbFsnZGF0YUdyaWRDb2x1bW5zTmFtZSddIHx8IG51bGw7XHJcbiAgICBjb25zdCBmcmFtZUluZGV4ID0gZnJhbWVDb250ZXh0LmluZGV4ICsgMTtcclxuICAgIGlmICghZGF0YUdyaWRDb2x1bW5zTmFtZSkge1xyXG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgfVxyXG4gICAgbGV0IGNvbHVtbnM6IGFueVtdID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbFtkYXRhR3JpZENvbHVtbnNOYW1lXTtcclxuICAgIGlmICghY29sdW1ucyB8fCBjb2x1bW5zLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgIH1cclxuICAgIC8vIOaJk+W5s2NvbHVtbnNcclxuICAgIGNvbHVtbnMgPSBjb2x1bW5zLnJlZHVjZSgocmVzdWx0czogYW55W10sIGl0ZW0pID0+IHtcclxuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkpIHtcclxuICAgICAgICByZXR1cm4gcmVzdWx0cy5jb25jYXQoaXRlbSk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHJlc3VsdHMuY29uY2F0KFtpdGVtXSk7XHJcbiAgICB9LCBbXSk7XHJcbiAgICBsZXQgcG9zaXRpb24gPSAtMTtcclxuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBjb2x1bW5zLmxlbmd0aDsgaW5kZXgrKykge1xyXG4gICAgICBjb25zdCBjb2x1bW46IGFueSB8IGFueVtdID0gY29sdW1uc1tpbmRleF07XHJcbiAgICAgIGNvbnN0IGZpZWxkcyA9IGNvbHVtbiAmJiBjb2x1bW4uZmllbGQgJiYgY29sdW1uLmZpZWxkLnNwbGl0KCcuJykuZmlsdGVyKHAgPT4gcCkgfHwgbnVsbDtcclxuICAgICAgaWYgKCFmaWVsZHMpIHtcclxuICAgICAgICBjb250aW51ZTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoYmluZGluZ1BhdGhzLmNvbmNhdChmaWVsZHMpLmpvaW4oJy8nKSA9PT0gYmluZGluZykge1xyXG4gICAgICAgIGNvbnN0IGZpeGVkID0gY29sdW1uLmZpeGVkO1xyXG4gICAgICAgIGlmIChmaXhlZCkge1xyXG4gICAgICAgICAgY29uc3QgZml4ZWRDb2x1bW5zID0gY29sdW1ucy5maWx0ZXIoaXRlbSA9PiBpdGVtLmZpeGVkID09PSBmaXhlZCk7XHJcbiAgICAgICAgICBjb25zdCBmaXhlZENvbHVtbkluZGV4ID0gdGhpcy5nZXRJbmRleEZyb21Db2x1bW5zKGZpeGVkQ29sdW1ucywgYmluZGluZyk7XHJcbiAgICAgICAgICBpZiAoZml4ZWQgPT09ICdsZWZ0Jykge1xyXG4gICAgICAgICAgICBwb3NpdGlvbiA9IGZyYW1lSW5kZXggKiBGSVhFRF9DT0xVTU5fU1RBUlRfSU5ERVggKyBmaXhlZENvbHVtbkluZGV4O1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcG9zaXRpb24gPSBmcmFtZUluZGV4ICogR1JJRF9DT0xVTU5fU1RBUlRfSU5ERVggKyAxMDAwICsgZml4ZWRDb2x1bW5JbmRleDtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcG9zaXRpb24gPSBmcmFtZUluZGV4ICogR1JJRF9DT0xVTU5fU1RBUlRfSU5ERVggKyBpbmRleDtcclxuICAgICAgICB9XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBwb3NpdGlvbjtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRJbmRleEZyb21Db2x1bW5zKGNvbHVtbnM6IGFueVtdLCBiaW5kaW5nOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IHRoaXMuZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgcmV0dXJuIGNvbHVtbnMuZmluZEluZGV4KGNvbHVtbiA9PiB7XHJcbiAgICAgIGNvbnN0IGZpZWxkcyA9IGNvbHVtbiAmJiBjb2x1bW4uZmllbGQgJiYgY29sdW1uLmZpZWxkLnNwbGl0KCcuJykuZmlsdGVyKHAgPT4gcCkgfHwgbnVsbDtcclxuICAgICAgaWYgKCFmaWVsZHMpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGJpbmRpbmdQYXRocy5jb25jYXQoZmllbGRzKS5qb2luKCcvJykgPT09IGJpbmRpbmcpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHJpdmF0ZSBzZWxlY3RGaXJzdFZlcmlmeUluZm9ybWF0aW9uKHZlcmlmeUluZm9ybWF0aW9uczogYW55W10sIHJvb3RFbGVtZW50PzogRWxlbWVudFJlZjxhbnk+KSB7XHJcbiAgICB2ZXJpZnlJbmZvcm1hdGlvbnMgPSB0aGlzLnVwZGF0ZVZlcmlmeUluZm9ybWF0aW9uc0luZGV4KHZlcmlmeUluZm9ybWF0aW9ucywgcm9vdEVsZW1lbnQpO1xyXG4gICAgdmVyaWZ5SW5mb3JtYXRpb25zLnNvcnQoKHYxOiBhbnksIHYyOiBhbnkpID0+IE51bWJlcih2MS5wb3NpdGlvbikgLSBOdW1iZXIodjIucG9zaXRpb24pKTtcclxuICAgIHJldHVybiB2ZXJpZnlJbmZvcm1hdGlvbnMgJiYgdmVyaWZ5SW5mb3JtYXRpb25zLmxlbmd0aCA+IDAgJiYgdmVyaWZ5SW5mb3JtYXRpb25zWzBdIHx8IG51bGw7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0SW5wdXRFbGVtZW50QnlJZCh0YXJnZXRGaWVsZDogc3RyaW5nLCByb290RWxlbWVudDogRWxlbWVudFJlZjxhbnk+KSB7XHJcbiAgICBsZXQgZWxlbWVudCA9IHJvb3RFbGVtZW50Lm5hdGl2ZUVsZW1lbnQub3duZXJEb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0YXJnZXRGaWVsZCkgfHwgbnVsbDtcclxuICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQudGFnTmFtZSAhPT0gJ0lOUFVUJykge1xyXG4gICAgICBjb25zdCBpbnB1dHMgPSBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpbnB1dCcpO1xyXG4gICAgICBpZiAoaW5wdXRzLmxlbmd0aCkge1xyXG4gICAgICAgIGVsZW1lbnQgPSBpbnB1dHNbMF07XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBlbGVtZW50O1xyXG4gIH1cclxuICBwdWJsaWMgZ2V0RnJhbWVDb250ZXh0c0J5UHJvcGVydHlQYXRoKHByb3BlcnR5UGF0aDogc3RyaW5nLCBzZXBhcnRvcjogc3RyaW5nID0gJy8nKTogRnJhbWVDb250ZXh0W10ge1xyXG4gICAgaWYgKCFwcm9wZXJ0eVBhdGgpIHtcclxuICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0cyA9IHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzKCkgfHwgW107XHJcbiAgICByZXR1cm4gZnJhbWVDb250ZXh0cy5maWx0ZXIoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgIGNvbnN0IGZvcm1Db250cm9scyA9IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQuZm9ybSAmJiBmcmFtZUNvbnRleHQuZm9ybS5uZ0Zvcm1Db250cm9scyB8fCB7fTtcclxuICAgICAgY29uc3QgYmluZGluZ1BhdGggPSBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoIHx8ICcnO1xyXG4gICAgICBpZiAoZm9ybUNvbnRyb2xzICYmIE9iamVjdC5rZXlzKGZvcm1Db250cm9scykubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGNvbnN0IGtleSA9IE9iamVjdC5rZXlzKGZvcm1Db250cm9scykuZmluZCgoa2V5OiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgIGNvbnN0IGZvcm1Db250cm9sID0gZm9ybUNvbnRyb2xzW2tleV07XHJcbiAgICAgICAgICBpZiAoIWZvcm1Db250cm9sIHx8ICFmb3JtQ29udHJvbC5iaW5kaW5nKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNvbnN0IGJpbmRpbmdzID0gZm9ybUNvbnRyb2wuYmluZGluZy5zcGxpdCgnLicpLmZpbHRlcihwID0+IHApO1xyXG4gICAgICAgICAgY29uc3QgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgICAgICAgIGNvbnN0IGZ1bGxQYXRoID0gYmluZGluZ1BhdGhzLmNvbmNhdChiaW5kaW5ncyk7XHJcbiAgICAgICAgICByZXR1cm4gcHJvcGVydHlQYXRoLnNwbGl0KHNlcGFydG9yKS5maWx0ZXIocCA9PiBwKS5qb2luKCcvJykgPT09IGZ1bGxQYXRoLmpvaW4oJy8nKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4ga2V5ID8gdHJ1ZSA6IGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwdWJsaWMgZ2V0Rm9ybUNvbnRyb2xJbmRleEJ5QmluZGluZ1BhdGgoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIGJpbmRpbmc6IHN0cmluZyk6IG51bWJlciB7XHJcbiAgICBjb25zdCBuZ0Zvcm1Db250cm9scyA9IHRoaXMuZ2V0Rm9ybUNvbnRyb2xzQnlGcmFtZUNvbnRleHQoZnJhbWVDb250ZXh0KTtcclxuICAgIGlmICghbmdGb3JtQ29udHJvbHMpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCBiaW5kaW5ncyA9IGJpbmRpbmcuc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgIHJldHVybiBPYmplY3QudmFsdWVzKG5nRm9ybUNvbnRyb2xzKS5maW5kSW5kZXgoKG5nRm9ybUNvbnRyb2w6IE5nRm9ybUNvbnRyb2wpID0+IHtcclxuICAgICAgaWYgKCFuZ0Zvcm1Db250cm9sKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcclxuICAgICAgY29uc3QgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgICAgY29uc3QgZm9ybUNvbnRyb2xCaW5kaW5nUGF0aHMgPSBuZ0Zvcm1Db250cm9sLmJpbmRpbmcuc3BsaXQoJy4nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgICAgY29uc3QgZnVsbFBhdGggPSBiaW5kaW5nUGF0aHMuY29uY2F0KGZvcm1Db250cm9sQmluZGluZ1BhdGhzKTtcclxuICAgICAgcmV0dXJuIGZ1bGxQYXRoLmpvaW4oJy8nKSA9PT0gYmluZGluZ3Muam9pbignLycpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHB1YmxpYyBnZXRGaWVsZEluZGV4KGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBiaW5kaW5nOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGlzR3JpZENvbXBvbmVudCA9IHRoaXMuaXNHcmlkQ29tcG9uZW50KGZyYW1lQ29udGV4dCk7XHJcbiAgICBpZiAoaXNHcmlkQ29tcG9uZW50KSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmdldENvbHVtbkluZGV4KGZyYW1lQ29udGV4dCwgYmluZGluZyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdGhpcy5nZXRGb3JtQ29udHJvbEluZGV4QnlCaW5kaW5nUGF0aChmcmFtZUNvbnRleHQsIGJpbmRpbmcpO1xyXG4gICAgfVxyXG4gIH1cclxuICBwdWJsaWMgZ2V0Rm9ybUNvbnRyb2xzQnlGcmFtZUNvbnRleHQoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpOiB7IFtwcm9wZXJ0eU5hbWU6IHN0cmluZ106IE5nRm9ybUNvbnRyb2wgfSB8IG51bGwge1xyXG4gICAgcmV0dXJuIGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQuZm9ybSAmJiBmcmFtZUNvbnRleHQuZm9ybS5uZ0Zvcm1Db250cm9scyB8fCBudWxsO1xyXG4gIH1cclxuICBwdWJsaWMgZm9jdXNFbGVtZW50KGVsZW1lbnRJZDogc3RyaW5nLCByb290RWxlbWVudDogRWxlbWVudFJlZjxhbnk+KTogYm9vbGVhbiB7XHJcbiAgICBsZXQgZm9jdXNlZCA9IGZhbHNlO1xyXG4gICAgbGV0IGVsZW1lbnRUb0ZvY3VzID0gcm9vdEVsZW1lbnQubmF0aXZlRWxlbWVudC5vd25lckRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGVsZW1lbnRJZCk7XHJcbiAgICAvLyDmnKrojrflj5bliLDmjIflrprlrZfmrrXml7bvvIzov5Tlm57vvIzkuI3lho3orr7nva7nhKbngrnjgIJcclxuICAgIGlmIChlbGVtZW50VG9Gb2N1cykge1xyXG4gICAgICAvLyDlpoLmnpzmnInlpJrkuKppZOmHjeWkjeeahOWFg+e0oO+8jOWImeS4jeWumuS9jVxyXG4gICAgICBjb25zdCBlbGVtZW50cyA9IHJvb3RFbGVtZW50Lm5hdGl2ZUVsZW1lbnQub3duZXJEb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGAjJHtlbGVtZW50SWR9YCk7XHJcbiAgICAgIGlmIChlbGVtZW50cyAmJiBlbGVtZW50cy5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgcmV0dXJuIGZvY3VzZWQ7XHJcbiAgICAgIH1cclxuICAgICAgLy8g5aaC5p6c57uR5a6a55uu5qCH5a2X5q6155qE5o6n5Lu25LiN5pivSW5wdXTlhYPntKDvvIzliJnmn6Xmib7lhbbkuIvnuqfoioLngrnjgIJcclxuICAgICAgaWYgKGVsZW1lbnRUb0ZvY3VzLnRhZ05hbWUgIT09ICdJTlBVVCcpIHtcclxuICAgICAgICBjb25zdCBzdWJFbGVtZW50cyA9IGVsZW1lbnRUb0ZvY3VzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpbnB1dCcpO1xyXG4gICAgICAgIGlmIChzdWJFbGVtZW50cy5sZW5ndGgpIHtcclxuICAgICAgICAgIGVsZW1lbnRUb0ZvY3VzID0gc3ViRWxlbWVudHNbMF07XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGVsZW1lbnRUb0ZvY3VzLmZvY3VzKCk7XHJcbiAgICAgIGZvY3VzZWQgPSB0cnVlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZvY3VzZWQ7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiuvue9rueEpueCuVxyXG4gICAqIEBwYXJhbSB2ZXJpZnlJbmZvcm1hdGlvbiDplJnor6/kv6Hmga9cclxuICAgKiBAcGFyYW0gZnJhbWVDb250ZXh0IOS4iuS4i+aWh1xyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBmb2N1cyh2ZXJpZnlJbmZvcm1hdGlvbjogYW55LCBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkge1xyXG4gICAgaWYgKCF2ZXJpZnlJbmZvcm1hdGlvbikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBpc0dyaWRWYWxpZGF0aW9uID0gdmVyaWZ5SW5mb3JtYXRpb24uaW5kZXggIT09IG51bGw7XHJcbiAgICBpZiAoaXNHcmlkVmFsaWRhdGlvbikge1xyXG4gICAgICBjb25zdCBncmlkID0gdGhpcy5nZXRHcmlkUmVmKGZyYW1lQ29udGV4dCk7XHJcbiAgICAgIGlmIChncmlkKSB7XHJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICBncmlkLmVkaXRDZWxsKHZlcmlmeUluZm9ybWF0aW9uLmlkLCB2ZXJpZnlJbmZvcm1hdGlvbi50YXJnZXRGaWVsZCk7XHJcbiAgICAgICAgfSwgMCk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IGZyYW1lRWxlbWVudCA9IHRoaXMuZ2V0Q29tcG9uZW50UmVmKGZyYW1lQ29udGV4dCk7XHJcbiAgICAgIGNvbnN0IGVsZW1lbnRJZCA9IHZlcmlmeUluZm9ybWF0aW9uLnRhcmdldEZpZWxkO1xyXG4gICAgICB0aGlzLmZvY3VzQnlJZChlbGVtZW50SWQsIGZyYW1lRWxlbWVudCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDpgJrov4fmjqfku7ZpZOiuvue9rueEpueCuVxyXG4gICAqIEBwYXJhbSBlbGVtZW50SWQgXHJcbiAgICogQHBhcmFtIGVsZW1lbnRSZWYgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmb2N1c0J5SWQoZWxlbWVudElkOiBzdHJpbmcsIGVsZW1lbnRSZWY/OiBFbGVtZW50UmVmKSB7XHJcbiAgICBjb25zdCBkb2N1bWVudDogYW55ID0gZWxlbWVudFJlZiAmJiBlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQub3duZXJEb2N1bWVudCB8fCB3aW5kb3cuZG9jdW1lbnQ7XHJcbiAgICBpZiAoZG9jdW1lbnQpIHtcclxuICAgICAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGVsZW1lbnRJZCk7XHJcbiAgICAgIGlmIChlbGVtZW50LnRhZ05hbWUgIT09ICdJTlBVVCcpIHtcclxuICAgICAgICBjb25zdCBzdWJFbGVtZW50cyA9IGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2lucHV0Jyk7XHJcbiAgICAgICAgaWYgKHN1YkVsZW1lbnRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgY29uc3QgaW5wdXQgPSBzdWJFbGVtZW50c1swXTtcclxuICAgICAgICAgIGlmIChpbnB1dCAmJiB0eXBlb2YgaW5wdXQuZm9jdXMgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgaW5wdXQuZm9jdXMoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZWxlbWVudC5mb2N1cygpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlue7hOS7tuWunuS+i1xyXG4gICAqIEBwYXJhbSBmcmFtZUNvbnRleHQgXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRDb21wb25lbnRSZWYoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpIHtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dCAmJiB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8RWxlbWVudFJlZj4oRWxlbWVudFJlZiwgbnVsbCkgfHwgbnVsbDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+WZ3JpZOWunuS+i1xyXG4gICAqIEBwYXJhbSBmcmFtZUNvbnRleHQgZnJhbWVDb250ZXh0XHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRHcmlkUmVmKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KTogRm9jdXNhYmxlSW52YWxpZGF0aW9uR3JpZCB7XHJcbiAgICBjb25zdCBuYW1lc3BhY2UgPSBmcmFtZUNvbnRleHQubmFtZXNwYWNlO1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGggPSBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoO1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0czogRnJhbWVDb250ZXh0W10gPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0c0J5TmFtZXNwYWNlKG5hbWVzcGFjZSkgfHwgW107XHJcbiAgICBjb25zdCBtYXRjaGVkRnJhbWVDb250ZXh0cyA9IGZyYW1lQ29udGV4dHMuZmlsdGVyKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4gZnJhbWVDb250ZXh0LnZpZXdNb2RlbCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkudG9TdHJpbmcoKSA9PT0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS50b1N0cmluZygpKTtcclxuICAgIGxldCByZXN1bHQgPSBudWxsO1xyXG4gICAgaWYgKG1hdGNoZWRGcmFtZUNvbnRleHRzKSB7XHJcbiAgICAgIG1hdGNoZWRGcmFtZUNvbnRleHRzLmV2ZXJ5KChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZyYW1lSWQgPSBmcmFtZUNvbnRleHQuZnJhbWVJZDtcclxuICAgICAgICBjb25zdCBjb21wb25lbnRzTWFwID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5jb21wb25lbnRNYW5hZ2VyLmdldENvbXBvbmVudHNCeUZyYW1lSWQoZnJhbWVJZCk7XHJcbiAgICAgICAgaWYgKCFjb21wb25lbnRzTWFwKSB7XHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZGF0YWdyaWRDb21wb25lbnQgPSBBcnJheS5mcm9tKGNvbXBvbmVudHNNYXAudmFsdWVzKCkpLmZpbmQoKGNvbXBvbmVudDogYW55KSA9PiBjb21wb25lbnQgJiYgY29tcG9uZW50WydfX2NvbXBvbmVudF90eXBlX18nXSA9PT0gJ0RhdGFncmlkQ29tcG9uZW50Jyk7XHJcbiAgICAgICAgaWYgKGRhdGFncmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgICByZXN1bHQgPSBkYXRhZ3JpZENvbXBvbmVudDtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgeyBGb2N1c2FibGVJbnZhbGlkYXRpb25HcmlkLCBGb2N1c0ludmFsaWRTZXJ2aWNlIH07XHJcbiJdfQ==