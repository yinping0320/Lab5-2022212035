import { BefRepositoryUtil } from "@farris/bef";
import { of } from "rxjs";
import { map } from "rxjs/operators";
var DataChangeDetectionService = /** @class */ (function () {
    function DataChangeDetectionService() {
    }
    DataChangeDetectionService.hasChange = function (frameContext) {
        var befRepository = frameContext && frameContext.repository;
        var hasLocalChanges = BefRepositoryUtil.isExistUnsaveData(befRepository);
        if (hasLocalChanges) {
            return of(true);
        }
        // 本地没有变更，确认服务器端是否有未保存的变更
        var virtualRootFrameContext = frameContext && frameContext.getVirtualRootFrameContext();
        var serverSideChangeDetectionEnabled = virtualRootFrameContext && virtualRootFrameContext.enableServerSideChangeDetection;
        if (!serverSideChangeDetectionEnabled) {
            return of(false);
        }
        else {
            // 启用了后端变更检测
            return frameContext.repository.hasChanges().pipe(map(function (response) {
                return response.returnValue;
            }));
        }
    };
    return DataChangeDetectionService;
}());
export { DataChangeDetectionService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1jaGFuZ2UtZGV0ZWN0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZGF0YS1jaGFuZ2UtZGV0ZWN0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFpQixpQkFBaUIsRUFBZ0IsTUFBTSxhQUFhLENBQUM7QUFFN0UsT0FBTyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0QyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFckM7SUFBQTtJQW1CQSxDQUFDO0lBbEJpQixvQ0FBUyxHQUF2QixVQUF3QixZQUEwQjtRQUM5QyxJQUFNLGFBQWEsR0FBRyxZQUFZLElBQUksWUFBWSxDQUFDLFVBQWdDLENBQUM7UUFDcEYsSUFBTSxlQUFlLEdBQUcsaUJBQWlCLENBQUMsaUJBQWlCLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDM0UsSUFBSSxlQUFlLEVBQUU7WUFDakIsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDbkI7UUFDRCx5QkFBeUI7UUFDekIsSUFBTSx1QkFBdUIsR0FBRyxZQUFZLElBQUksWUFBWSxDQUFDLDBCQUEwQixFQUFFLENBQUM7UUFDMUYsSUFBTSxnQ0FBZ0MsR0FBRyx1QkFBdUIsSUFBSSx1QkFBdUIsQ0FBQywrQkFBK0IsQ0FBQztRQUM1SCxJQUFJLENBQUMsZ0NBQWdDLEVBQUU7WUFDbkMsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDcEI7YUFBTTtZQUNILFlBQVk7WUFDWixPQUFPLFlBQVksQ0FBQyxVQUFVLENBQUMsVUFBVSxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFDLFFBQXNCO2dCQUN4RSxPQUFPLFFBQVEsQ0FBQyxXQUFXLENBQUM7WUFDaEMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNQO0lBQ0wsQ0FBQztJQUNMLGlDQUFDO0FBQUQsQ0FBQyxBQW5CRCxJQW1CQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJlZlJlcG9zaXRvcnksIEJlZlJlcG9zaXRvcnlVdGlsLCBSZXNwb25zZUluZm8gfSBmcm9tIFwiQGZhcnJpcy9iZWZcIjtcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0IH0gZnJvbSBcIkBmYXJyaXMvZGV2a2l0XCI7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSBcInJ4anNcIjtcclxuaW1wb3J0IHsgbWFwIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgRGF0YUNoYW5nZURldGVjdGlvblNlcnZpY2Uge1xyXG4gICAgcHVibGljIHN0YXRpYyBoYXNDaGFuZ2UoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgICAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcclxuICAgICAgICBjb25zdCBoYXNMb2NhbENoYW5nZXMgPSBCZWZSZXBvc2l0b3J5VXRpbC5pc0V4aXN0VW5zYXZlRGF0YShiZWZSZXBvc2l0b3J5KTtcclxuICAgICAgICBpZiAoaGFzTG9jYWxDaGFuZ2VzKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5pys5Zyw5rKh5pyJ5Y+Y5pu077yM56Gu6K6k5pyN5Yqh5Zmo56uv5piv5ZCm5pyJ5pyq5L+d5a2Y55qE5Y+Y5pu0XHJcbiAgICAgICAgY29uc3QgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XHJcbiAgICAgICAgY29uc3Qgc2VydmVyU2lkZUNoYW5nZURldGVjdGlvbkVuYWJsZWQgPSB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dCAmJiB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dC5lbmFibGVTZXJ2ZXJTaWRlQ2hhbmdlRGV0ZWN0aW9uO1xyXG4gICAgICAgIGlmICghc2VydmVyU2lkZUNoYW5nZURldGVjdGlvbkVuYWJsZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyDlkK/nlKjkuoblkI7nq6/lj5jmm7Tmo4DmtYtcclxuICAgICAgICAgICAgcmV0dXJuIGZyYW1lQ29udGV4dC5yZXBvc2l0b3J5Lmhhc0NoYW5nZXMoKS5waXBlKG1hcCgocmVzcG9uc2U6IFJlc3BvbnNlSW5mbykgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnJldHVyblZhbHVlO1xyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59Il19