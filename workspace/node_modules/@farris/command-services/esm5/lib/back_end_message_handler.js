import * as tslib_1 from "tslib";
import { Inject, Injectable, Injector } from '@angular/core';
import { FrameContext, TranslateToken } from '@farris/devkit';
/**
 * 后端消息处理服务
 * @description
 * ### 服务注入位置
 *  1、整个表单的root-component
 *  2、弹出窗口的root-component
 */
var BackEndMessageHandler = /** @class */ (function () {
    function BackEndMessageHandler(injector, frameContext, translate) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.translate = translate;
    }
    /**
     * 处理后端返回的消息或错误
     * @param message 消息或错误
     */
    BackEndMessageHandler.prototype.handle = function (message, context) {
        var isException = context && context.isException || false;
        var hasThrowError = context && context.hasThrowError || false;
        var eventBus = context && context.eventBus || null;
        var error = context && context.error || null;
        var formAppContext = context && context.formAppContext || null;
        var result = this.collect(message, isException, hasThrowError, eventBus, error, formAppContext);
        if (result && result.form && result.form.length > 0) {
            result.form.forEach(function (item) {
                item.frameContext.viewModel.form.updateFormErrors(item.message, true, 'backend');
            });
        }
        else {
            this.resetFormMessage(message.context.appContext, message.context.ns);
        }
        var targetFrameContext = this.findTargetFrameContext(this.frameContext);
        if (result && result.all && result.all.length > 0) {
            targetFrameContext.viewModel.verifycationChanged.next(result.all);
        }
        else {
            if (result !== null) {
                targetFrameContext.viewModel.verifycationChanged.next([]);
            }
        }
    };
    /**
     * 收集汇总信息和form信息
     * @param backEndMessage
     */
    BackEndMessageHandler.prototype.collect = function (backEndMessage, isException, hasThrowError, eventBus, error, formAppContext) {
        var _this = this;
        if (isException === void 0) { isException = false; }
        if (hasThrowError === void 0) { hasThrowError = false; }
        if (eventBus === void 0) { eventBus = null; }
        if (error === void 0) { error = null; }
        if (formAppContext === void 0) { formAppContext = null; }
        var e_1, _a;
        var bizMessages = backEndMessage && backEndMessage.bizMessages || null;
        var appContext = backEndMessage && backEndMessage.context.appContext;
        var ns = backEndMessage.context.ns;
        if (!bizMessages || bizMessages.length < 1) {
            return null;
        }
        var result = {
            form: [],
            all: []
        };
        var hasFormlessError = false;
        var _loop_1 = function (bizMessage) {
            var e_2, _a;
            var message = bizMessage.message;
            var location_1 = bizMessage.location || null;
            var columns = location_1 && location_1.columns || null;
            var nodeCode = location_1 && location_1.nodeCode || null;
            var rows = location_1 && location_1.rows;
            var bindingPath = this_1.getBindingPath(appContext, ns, nodeCode);
            var bindingPaths = bindingPath && bindingPath.split('/').filter(function (p) { return p; });
            // 目前仅处理有location，且有id、列名、表名的。
            if (!location_1 || !columns || columns.length < 1 || !nodeCode || !rows || rows.length < 1) {
                return "continue";
            }
            var _loop_2 = function (row) {
                var e_3, _a;
                var _loop_3 = function (column) {
                    // 获取到所有绑定该列数据的frameContext
                    var frameContexts = this_1.getFrameContextsByBindingPathAndColumnName(appContext, ns, bindingPath, column);
                    if (!frameContexts || frameContexts.length < 1) {
                        // 没有任何一个组件绑定该列的数据
                        hasFormlessError = true;
                        return "continue";
                    }
                    // 排除掉只读datagrid
                    frameContexts = frameContexts.filter(function (frameContext) {
                        var isDataGridComponent = _this.isDataGridComponent(frameContext.frameComponent);
                        if (isDataGridComponent) {
                            var isReadonlyDataGrid = _this.isReadonlyDataGrid(frameContext.frameComponent);
                            if (isReadonlyDataGrid) {
                                return false;
                            }
                            else {
                                return true;
                            }
                        }
                        return true;
                    });
                    // 遍历的行是否为当前行
                    var isCurrentRow = this_1.isCurrentRow(appContext, ns, bindingPath, row);
                    // 如果是当前行的话需要将错误信息放到form中
                    if (isCurrentRow) {
                        // 忽略grid
                        // const formFrameContexts = frameContexts.filter(frameContext => !this.isGridComponent(frameContext.frameComponent));
                        if (frameContexts && frameContexts.length > 0) {
                            frameContexts.forEach(function (frameContext) {
                                // 只处理了一个组件中列只绑定到一个前端控件的场景
                                var formControls = _this.getFormControlByColumnName(frameContext, column);
                                if (formControls && formControls.length > 0) {
                                    formControls.forEach(function (_a) {
                                        var _b = tslib_1.__read(_a, 2), domPropertyName = _b[0], formControl = _b[1];
                                        //const domPropertyName = formControl && formControl. || null;
                                        _this.mergeMessage(result.form, frameContext, domPropertyName, message);
                                    });
                                }
                                //if (formControl && domPropertyName) {
                                //}
                            });
                        }
                        else {
                        }
                    }
                    // 将错误信息放到汇总中
                    frameContexts.forEach(function (frameContext) {
                        var viewModelName = frameContext.viewModel.form.formGroupName;
                        var formControls = _this.getFormControlByColumnName(frameContext, column);
                        if (formControls && formControls.length > 0) {
                            var _a = tslib_1.__read(formControls.find(function (_a) {
                                var _b = tslib_1.__read(_a, 2), propertyName = _b[0], formControl = _b[1];
                                return propertyName && propertyName.length > 0;
                            }), 2), domPropertyName = _a[0], formControl = _a[1];
                            // const domPropertyName = domProperty && domProperty.propertyName;
                            var bindingList = frameContext.viewModel.bindingData.getValue(bindingPaths);
                            var index = bindingList.getIndexById(row);
                            var primary_1 = row + "_" + column + "_" + message;
                            // TODO:虽然能纠正汇总消息显示重复的问题，但可能导致点击错误无法定位到对应控件的问题，待后续优化
                            if (index >= 0 && result.all.findIndex(function (p) { return p.id === primary_1; }) === -1) {
                                // 数据源中有多于1行时显示索引
                                var position = (bindingList && bindingList.length > 1) ? (index + 1) : -1;
                                var title = _this.buildItemTitle(viewModelName, formControl.name || formControl.defaultI18nValue || domPropertyName, position);
                                var item = {
                                    id: primary_1,
                                    index: index,
                                    targetField: formControl.id,
                                    title: title,
                                    msg: message,
                                    namespace: ns,
                                    bindingPath: bindingPath,
                                    type: 'error'
                                };
                                result.all.push(item);
                            }
                        }
                    });
                };
                try {
                    for (var columns_1 = tslib_1.__values(columns), columns_1_1 = columns_1.next(); !columns_1_1.done; columns_1_1 = columns_1.next()) {
                        var column = columns_1_1.value;
                        _loop_3(column);
                    }
                }
                catch (e_3_1) { e_3 = { error: e_3_1 }; }
                finally {
                    try {
                        if (columns_1_1 && !columns_1_1.done && (_a = columns_1.return)) _a.call(columns_1);
                    }
                    finally { if (e_3) throw e_3.error; }
                }
            };
            try {
                // 遍历数据行
                for (var rows_1 = tslib_1.__values(rows), rows_1_1 = rows_1.next(); !rows_1_1.done; rows_1_1 = rows_1.next()) {
                    var row = rows_1_1.value;
                    _loop_2(row);
                }
            }
            catch (e_2_1) { e_2 = { error: e_2_1 }; }
            finally {
                try {
                    if (rows_1_1 && !rows_1_1.done && (_a = rows_1.return)) _a.call(rows_1);
                }
                finally { if (e_2) throw e_2.error; }
            }
        };
        var this_1 = this;
        try {
            for (var bizMessages_1 = tslib_1.__values(bizMessages), bizMessages_1_1 = bizMessages_1.next(); !bizMessages_1_1.done; bizMessages_1_1 = bizMessages_1.next()) {
                var bizMessage = bizMessages_1_1.value;
                _loop_1(bizMessage);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (bizMessages_1_1 && !bizMessages_1_1.done && (_a = bizMessages_1.return)) _a.call(bizMessages_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        if (hasFormlessError && isException && !hasThrowError && eventBus) {
            eventBus.post('Exception', '', 'onException', error, formAppContext);
        }
        return result;
    };
    BackEndMessageHandler.prototype.mergeMessage = function (formItems, frameContext, domPropertyName, message) {
        var _a, _b;
        var targetItem = formItems.find(function (item) { return item.frameContext.frameId === frameContext.frameId; });
        if (targetItem) {
            var isPropertyExist = targetItem.message && Object.keys(targetItem.message).includes(domPropertyName);
            var messageType = "backend-message-" + (Object.keys(targetItem.message).length + 1);
            if (isPropertyExist) {
                targetItem.message[domPropertyName]['errors'][messageType] = { name: message };
            }
            else {
                targetItem.message[domPropertyName] = { errors: (_a = {}, _a[messageType] = { name: message }, _a) };
            }
        }
        else {
            formItems.push({
                frameContext: frameContext,
                message: (_b = {},
                    _b[domPropertyName] = {
                        errors: {
                            'backend-message-1': { name: message }
                        }
                    },
                    _b)
            });
        }
    };
    BackEndMessageHandler.prototype.buildItemTitle = function (viewModelName, propertyName, index) {
        var template = {
            'zh-CHS': {
                viewModelName: "$viewModel",
                index: "\u7B2C $index \u884C",
                propertyName: "- $propertyName"
            },
            'en': {
                viewModelName: "$viewModel",
                index: "row $index",
                propertyName: "- $propertyName"
            },
            'zh-CHT': {
                viewModelName: "$viewModel",
                index: "\u7B2C $index \u884C",
                propertyName: "- $propertyName"
            }
        };
        var currentLanguage = this.translate.getCurrentLanguage() || 'zh-CHS';
        var message = [];
        if (viewModelName) {
            message.push(template[currentLanguage]['viewModelName'].replace('$viewModel', viewModelName));
        }
        if (index > 0) {
            message.push(template[currentLanguage]['index'].replace('$index', index));
        }
        if (propertyName) {
            message.push(template[currentLanguage]['propertyName'].replace('$propertyName', propertyName));
        }
        return message.join(' ');
    };
    /**
     * 根据表名或nodeCode获取绑定路径
     * @param appContext appContext
     * @param ns ns
     * @param nodeCode 表名
     */
    BackEndMessageHandler.prototype.getBindingPath = function (appContext, ns, nodeCode) {
        var frameContext = this.getFrameContext(appContext, ns);
        return frameContext.repository.entityTypeInfo.getBindingPathByTableName(nodeCode);
    };
    /**
     * 通过绑定路径和列名找到所有符合条件的视图模型(包括grid和form)
     * @param appContext appContext
     * @param ns namespace
     * @param bindingPath 绑定路径
     * @param columnName 列名
     */
    BackEndMessageHandler.prototype.getFrameContextsByBindingPathAndColumnName = function (appContext, ns, bindingPath, columnName) {
        var frameContexts = appContext.frameContextManager.getFrameContexts();
        if (frameContexts && frameContexts.length > 0) {
            // 找到form中有控件的frameContext
            frameContexts = frameContexts.filter(function (frameContext) {
                // 基本条件是否满足
                var isValidFrameContext = frameContext.namespace === ns && frameContext.viewModel.bindingPath === bindingPath && frameContext.viewModel.form && frameContext.viewModel.form.controls && Object.keys(frameContext.viewModel.form.controls).length > 0;
                if (!isValidFrameContext) {
                    return false;
                }
                // 再通过列名过滤
                var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
                var dataTypeInfo = frameContext.repository.entityTypeInfo.getTypeInfoByPath(bindingPaths);
                if (dataTypeInfo) {
                    var dataPropInfos = Array.from(dataTypeInfo.propInfoMap.values());
                    // 从当前实体属性中找到数据字段为列名的属性
                    var entityPropertyInfo = dataPropInfos.find(function (propInfo) { return propInfo.metadataInfo && (propInfo.metadataInfo.originalDataField === columnName || propInfo.metadataInfo.dataField === columnName); });
                    if (entityPropertyInfo) {
                        var entityPropertyName_1 = entityPropertyInfo.name;
                        var ngFormControl = Object.values(frameContext.viewModel.form.ngFormControls).find(function (item) { return item.binding === entityPropertyName_1; });
                        if (ngFormControl) {
                            return true;
                        }
                        else {
                            var item = Object.keys(frameContext.viewModel.form.ngFormControls).find(function (key) { return key === entityPropertyName_1; });
                            return item ? true : false;
                        }
                    }
                    else {
                        return false;
                    }
                }
                else {
                    return false;
                }
            });
            return frameContexts;
        }
        return null;
    };
    /**
     * 是否为datagrid组件
     * @param frameComponent component
     */
    BackEndMessageHandler.prototype.isDataGridComponent = function (frameComponent) {
        var columnNames = frameComponent.context.viewModel['dataGridColumnsName'] || null;
        return columnNames ? true : false;
    };
    /**
     * grid组件是否是只读的
     * @param frameComponent frameComponent
     * @returns
     */
    BackEndMessageHandler.prototype.isReadonlyDataGrid = function (frameComponent) {
        var frameContext = frameComponent.context;
        var dataGridColumnsName = frameContext.viewModel['dataGridColumnsName'] || null;
        if (dataGridColumnsName) {
            var datagridColumns = frameContext.viewModel[dataGridColumnsName];
            return datagridColumns.every(function (group) {
                return group.every(function (item) { return !item.editor; });
            });
        }
        else {
            throw new Error("\u4F20\u5165\u7684\u7EC4\u4EF6\u4E0D\u662F\u4E00\u4E2A\u8868\u683C\uFF01");
        }
    };
    /**
     * id是否为当前行
     * @param appContext appContext
     * @param ns namespace
     * @param bindingPath bindingPath
     * @param id id
     */
    BackEndMessageHandler.prototype.isCurrentRow = function (appContext, ns, bindingPath, id) {
        var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
        var frameContext = this.getFrameContext(appContext, ns);
        var bindingData = frameContext.bindingData;
        var bindingList = bindingData.getValue(bindingPaths);
        return bindingList.currentItem.primaryKeyValue === id;
    };
    /**
     * 获取当前ns下的rootFrameContext
     * @param appContext appcontext
     * @param ns namespace
     */
    BackEndMessageHandler.prototype.getFrameContext = function (appContext, ns) {
        var frameContexts = appContext.frameContextManager.getFrameContexts();
        if (frameContexts && frameContexts.length > 0) {
            var randomFrameContext = frameContexts.find(function (frameContext) { return frameContext.namespace === ns; });
            if (randomFrameContext) {
                var virtualRootFrameContext = randomFrameContext.getVirtualRootFrameContext();
                return virtualRootFrameContext;
            }
        }
        return null;
    };
    /**
     * 通过绑定路径和列名获取绑定到该列的formControl
     */
    BackEndMessageHandler.prototype.getFormControlByColumnName = function (frameContext, columnName) {
        var bindingPaths = frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; });
        // 通过bindingPath找到对应的实体信息
        var typeInfo = frameContext.repository.entityTypeInfo.getTypeInfoByPath(bindingPaths);
        var propsInfo = Array.from(typeInfo.propInfoMap.values());
        var propInfo = propsInfo.find(function (propInfo) { return propInfo.metadataInfo && (propInfo.metadataInfo.originalDataField === columnName || propInfo.metadataInfo.dataField === columnName); });
        if (propInfo) {
            var mappingName_1 = propInfo.name;
            var formControls = Object.entries(frameContext.viewModel.form.ngFormControls).filter(function (item) { return item[1].binding === mappingName_1 || item[0] === mappingName_1; });
            // const ngFormControl = Object.values(frameContext.viewModel.form.ngFormControls).find(item => item.binding === mappingName);
            if (formControls) {
                return formControls;
            }
        }
        return null;
    };
    BackEndMessageHandler.prototype.resetFormMessage = function (appContext, ns) {
        var frameContexts = appContext.frameContextManager.getFrameContexts().filter(function (frameContext) { return frameContext.namespace === ns; });
        frameContexts.forEach(function (frameContext) { return frameContext && frameContext.viewModel && frameContext.viewModel.form && frameContext.viewModel.form.clearBackendError(); });
    };
    /**
     * 递归找到展示消息的组件上下文
     * @param frameContext frameContext
     */
    BackEndMessageHandler.prototype.findTargetFrameContext = function (frameContext) {
        var virtualRootFrameContext = frameContext.getVirtualRootFrameContext();
        var virtualRootComponent = virtualRootFrameContext.frameComponent;
        var isDialogComponent = virtualRootComponent && virtualRootComponent['isDialogRootComponent'] || false;
        if (isDialogComponent) {
            // 如果消息处理服务是弹窗内的，则消息提示展示在弹窗内
            return virtualRootFrameContext;
        }
        else {
            // 当前消息服务不在弹窗内，递归向上查找，找到第一个弹窗，如果找不到则找到最上的root-component
            var parentFrameContext = virtualRootFrameContext.parent;
            if (parentFrameContext) {
                return this.findTargetFrameContext(parentFrameContext);
            }
            else {
                return virtualRootFrameContext;
            }
        }
    };
    BackEndMessageHandler.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    BackEndMessageHandler.ctorParameters = function () { return [
        { type: Injector },
        { type: FrameContext },
        { type: undefined, decorators: [{ type: Inject, args: [TranslateToken,] }] }
    ]; };
    return BackEndMessageHandler;
}());
export { BackEndMessageHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja19lbmRfbWVzc2FnZV9oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2JhY2tfZW5kX21lc3NhZ2VfaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBbUYsWUFBWSxFQUE0QixjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6Szs7Ozs7O0dBTUc7QUFDSDtJQUVFLCtCQUFvQixRQUFrQixFQUFVLFlBQTBCLEVBQWtDLFNBQW9CO1FBQTVHLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUFrQyxjQUFTLEdBQVQsU0FBUyxDQUFXO0lBQUksQ0FBQztJQUNySTs7O09BR0c7SUFDSSxzQ0FBTSxHQUFiLFVBQWMsT0FBZ0MsRUFBRSxPQUFZO1FBQzFELElBQU0sV0FBVyxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsV0FBVyxJQUFJLEtBQUssQ0FBQztRQUM1RCxJQUFNLGFBQWEsR0FBRyxPQUFPLElBQUksT0FBTyxDQUFDLGFBQWEsSUFBSSxLQUFLLENBQUM7UUFDaEUsSUFBTSxRQUFRLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDO1FBQ3JELElBQU0sS0FBSyxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQztRQUMvQyxJQUFNLGNBQWMsR0FBRyxPQUFPLElBQUksT0FBTyxDQUFDLGNBQWMsSUFBSSxJQUFJLENBQUM7UUFDakUsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQ2xHLElB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LENBQUM7YUFDeEQ7aUJBQU07Z0JBQ0wsT0FBTyx1QkFBdUIsQ0FBQzthQUNoQztTQUNGO0lBQ0gsQ0FBQzs7Z0JBL1ZGLFVBQVU7Ozs7Z0JBVGtCLFFBQVE7Z0JBQ3FELFlBQVk7Z0RBVXZCLE1BQU0sU0FBQyxjQUFjOztJQThWcEcsNEJBQUM7Q0FBQSxBQWhXRCxJQWdXQztTQS9WWSxxQkFBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEFwcENvbnRleHQsIEJhY2tFbmRNZXNzYWdlLCBCaW5kaW5nTGlzdCwgRGF0YVByb3BJbmZvLCBFdmVudEJ1cywgRnJhbWVDb21wb25lbnQsIEZyYW1lQ29udGV4dCwgTmdGb3JtQ29udHJvbCwgVHJhbnNsYXRlLCBUcmFuc2xhdGVUb2tlbiB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuLyoqXHJcbiAqIOWQjuerr+a2iOaBr+WkhOeQhuacjeWKoVxyXG4gKiBAZGVzY3JpcHRpb25cclxuICogIyMjIOacjeWKoeazqOWFpeS9jee9rlxyXG4gKiAgMeOAgeaVtOS4quihqOWNleeahHJvb3QtY29tcG9uZW50IFxyXG4gKiAgMuOAgeW8ueWHuueql+WPo+eahHJvb3QtY29tcG9uZW50IFxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQmFja0VuZE1lc3NhZ2VIYW5kbGVyIGltcGxlbWVudHMgQmFja0VuZE1lc3NhZ2UuSUJhY2tFbmRNZXNzYWdlSGFuZGxlciB7XHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIEBJbmplY3QoVHJhbnNsYXRlVG9rZW4pIHByaXZhdGUgdHJhbnNsYXRlOiBUcmFuc2xhdGUpIHsgfVxyXG4gIC8qKlxyXG4gICAqIOWkhOeQhuWQjuerr+i/lOWbnueahOa2iOaBr+aIlumUmeivr1xyXG4gICAqIEBwYXJhbSBtZXNzYWdlIOa2iOaBr+aIlumUmeivr1xyXG4gICAqL1xyXG4gIHB1YmxpYyBoYW5kbGUobWVzc2FnZTogQmFja0VuZE1lc3NhZ2UuSU1lc3NhZ2UsIGNvbnRleHQ6IGFueSkge1xyXG4gICAgY29uc3QgaXNFeGNlcHRpb24gPSBjb250ZXh0ICYmIGNvbnRleHQuaXNFeGNlcHRpb24gfHwgZmFsc2U7XHJcbiAgICBjb25zdCBoYXNUaHJvd0Vycm9yID0gY29udGV4dCAmJiBjb250ZXh0Lmhhc1Rocm93RXJyb3IgfHwgZmFsc2U7XHJcbiAgICBjb25zdCBldmVudEJ1cyA9IGNvbnRleHQgJiYgY29udGV4dC5ldmVudEJ1cyB8fCBudWxsO1xyXG4gICAgY29uc3QgZXJyb3IgPSBjb250ZXh0ICYmIGNvbnRleHQuZXJyb3IgfHwgbnVsbDtcclxuICAgIGNvbnN0IGZvcm1BcHBDb250ZXh0ID0gY29udGV4dCAmJiBjb250ZXh0LmZvcm1BcHBDb250ZXh0IHx8IG51bGw7XHJcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmNvbGxlY3QobWVzc2FnZSwgaXNFeGNlcHRpb24sIGhhc1Rocm93RXJyb3IsIGV2ZW50QnVzLCBlcnJvciwgZm9ybUFwcENvbnRleHQpO1xyXG4gICAgaWYgKHJlc3VsdCAmJiByZXN1bHQuZm9ybSAmJiByZXN1bHQuZm9ybS5sZW5ndGggPiAwKSB7XHJcbiAgICAgIHJlc3VsdC5mb3JtLmZvckVhY2goKGl0ZW06IHsgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIG1lc3NhZ2U6IGFueSB9KSA9PiB7XHJcbiAgICAgICAgaXRlbS5mcmFtZUNvbnRleHQudmlld01vZGVsLmZvcm0udXBkYXRlRm9ybUVycm9ycyhpdGVtLm1lc3NhZ2UsIHRydWUsICdiYWNrZW5kJyk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5yZXNldEZvcm1NZXNzYWdlKG1lc3NhZ2UuY29udGV4dC5hcHBDb250ZXh0LCBtZXNzYWdlLmNvbnRleHQubnMpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgdGFyZ2V0RnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQgPSB0aGlzLmZpbmRUYXJnZXRGcmFtZUNvbnRleHQodGhpcy5mcmFtZUNvbnRleHQpO1xyXG4gICAgaWYgKHJlc3VsdCAmJiByZXN1bHQuYWxsICYmIHJlc3VsdC5hbGwubGVuZ3RoID4gMCkge1xyXG4gICAgICB0YXJnZXRGcmFtZUNvbnRleHQudmlld01vZGVsLnZlcmlmeWNhdGlvbkNoYW5nZWQubmV4dChyZXN1bHQuYWxsKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmIChyZXN1bHQgIT09IG51bGwpIHtcclxuICAgICAgICB0YXJnZXRGcmFtZUNvbnRleHQudmlld01vZGVsLnZlcmlmeWNhdGlvbkNoYW5nZWQubmV4dChbXSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5pS26ZuG5rGH5oC75L+h5oGv5ZKMZm9ybeS/oeaBr1xyXG4gICAqIEBwYXJhbSBiYWNrRW5kTWVzc2FnZSBcclxuICAgKi9cclxuICBwcml2YXRlIGNvbGxlY3QoYmFja0VuZE1lc3NhZ2U6IEJhY2tFbmRNZXNzYWdlLklNZXNzYWdlLCBpc0V4Y2VwdGlvbjogYm9vbGVhbiA9IGZhbHNlLCBoYXNUaHJvd0Vycm9yOiBib29sZWFuID0gZmFsc2UsIGV2ZW50QnVzOiBFdmVudEJ1cyA9IG51bGwsIGVycm9yOiBhbnkgPSBudWxsLCBmb3JtQXBwQ29udGV4dDogQXBwQ29udGV4dCA9IG51bGwpOiB7IGZvcm06IHsgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIG1lc3NhZ2U6IGFueSB9W10sIGFsbDogYW55W10gfSB7XHJcbiAgICBjb25zdCBiaXpNZXNzYWdlcyA9IGJhY2tFbmRNZXNzYWdlICYmIGJhY2tFbmRNZXNzYWdlLmJpek1lc3NhZ2VzIHx8IG51bGw7XHJcbiAgICBjb25zdCBhcHBDb250ZXh0ID0gYmFja0VuZE1lc3NhZ2UgJiYgYmFja0VuZE1lc3NhZ2UuY29udGV4dC5hcHBDb250ZXh0O1xyXG4gICAgY29uc3QgbnMgPSBiYWNrRW5kTWVzc2FnZS5jb250ZXh0Lm5zO1xyXG4gICAgaWYgKCFiaXpNZXNzYWdlcyB8fCBiaXpNZXNzYWdlcy5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcmVzdWx0ID0ge1xyXG4gICAgICBmb3JtOiBbXSxcclxuICAgICAgYWxsOiBbXVxyXG4gICAgfTtcclxuICAgIGxldCBoYXNGb3JtbGVzc0Vycm9yID0gZmFsc2U7XHJcbiAgICBmb3IgKGxldCBiaXpNZXNzYWdlIG9mIGJpek1lc3NhZ2VzKSB7XHJcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBiaXpNZXNzYWdlLm1lc3NhZ2U7XHJcbiAgICAgIGNvbnN0IGxvY2F0aW9uID0gYml6TWVzc2FnZS5sb2NhdGlvbiB8fCBudWxsO1xyXG4gICAgICBjb25zdCBjb2x1bW5zID0gbG9jYXRpb24gJiYgbG9jYXRpb24uY29sdW1ucyB8fCBudWxsO1xyXG4gICAgICBjb25zdCBub2RlQ29kZSA9IGxvY2F0aW9uICYmIGxvY2F0aW9uLm5vZGVDb2RlIHx8IG51bGw7XHJcbiAgICAgIGNvbnN0IHJvd3MgPSBsb2NhdGlvbiAmJiBsb2NhdGlvbi5yb3dzO1xyXG4gICAgICBjb25zdCBiaW5kaW5nUGF0aCA9IHRoaXMuZ2V0QmluZGluZ1BhdGgoYXBwQ29udGV4dCwgbnMsIG5vZGVDb2RlKTtcclxuICAgICAgY29uc3QgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGggJiYgYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuXHJcbiAgICAgIC8vIOebruWJjeS7heWkhOeQhuaciWxvY2F0aW9u77yM5LiU5pyJaWTjgIHliJflkI3jgIHooajlkI3nmoTjgIJcclxuICAgICAgaWYgKCFsb2NhdGlvbiB8fCAhY29sdW1ucyB8fCBjb2x1bW5zLmxlbmd0aCA8IDEgfHwgIW5vZGVDb2RlIHx8ICFyb3dzIHx8IHJvd3MubGVuZ3RoIDwgMSkge1xyXG4gICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIOmBjeWOhuaVsOaNruihjFxyXG4gICAgICBmb3IgKGxldCByb3cgb2Ygcm93cykge1xyXG4gICAgICAgIGZvciAobGV0IGNvbHVtbiBvZiBjb2x1bW5zKSB7XHJcbiAgICAgICAgICAvLyDojrflj5bliLDmiYDmnInnu5Hlrpror6XliJfmlbDmja7nmoRmcmFtZUNvbnRleHRcclxuICAgICAgICAgIGxldCBmcmFtZUNvbnRleHRzID0gdGhpcy5nZXRGcmFtZUNvbnRleHRzQnlCaW5kaW5nUGF0aEFuZENvbHVtbk5hbWUoYXBwQ29udGV4dCwgbnMsIGJpbmRpbmdQYXRoLCBjb2x1bW4pO1xyXG4gICAgICAgICAgaWYgKCFmcmFtZUNvbnRleHRzIHx8IGZyYW1lQ29udGV4dHMubGVuZ3RoIDwgMSkge1xyXG4gICAgICAgICAgICAvLyDmsqHmnInku7vkvZXkuIDkuKrnu4Tku7bnu5Hlrpror6XliJfnmoTmlbDmja5cclxuICAgICAgICAgICAgaGFzRm9ybWxlc3NFcnJvciA9IHRydWU7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgLy8g5o6S6Zmk5o6J5Y+q6K+7ZGF0YWdyaWRcclxuICAgICAgICAgIGZyYW1lQ29udGV4dHMgPSBmcmFtZUNvbnRleHRzLmZpbHRlcigoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgaXNEYXRhR3JpZENvbXBvbmVudCA9IHRoaXMuaXNEYXRhR3JpZENvbXBvbmVudChmcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnQpO1xyXG4gICAgICAgICAgICBpZiAoaXNEYXRhR3JpZENvbXBvbmVudCkge1xyXG4gICAgICAgICAgICAgIGNvbnN0IGlzUmVhZG9ubHlEYXRhR3JpZCA9IHRoaXMuaXNSZWFkb25seURhdGFHcmlkKGZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudCk7XHJcbiAgICAgICAgICAgICAgaWYgKGlzUmVhZG9ubHlEYXRhR3JpZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICAgIC8vIOmBjeWOhueahOihjOaYr+WQpuS4uuW9k+WJjeihjFxyXG4gICAgICAgICAgY29uc3QgaXNDdXJyZW50Um93ID0gdGhpcy5pc0N1cnJlbnRSb3coYXBwQ29udGV4dCwgbnMsIGJpbmRpbmdQYXRoLCByb3cpO1xyXG4gICAgICAgICAgLy8g5aaC5p6c5piv5b2T5YmN6KGM55qE6K+d6ZyA6KaB5bCG6ZSZ6K+v5L+h5oGv5pS+5YiwZm9ybeS4rVxyXG4gICAgICAgICAgaWYgKGlzQ3VycmVudFJvdykge1xyXG4gICAgICAgICAgICAvLyDlv73nlaVncmlkXHJcbiAgICAgICAgICAgIC8vIGNvbnN0IGZvcm1GcmFtZUNvbnRleHRzID0gZnJhbWVDb250ZXh0cy5maWx0ZXIoZnJhbWVDb250ZXh0ID0+ICF0aGlzLmlzR3JpZENvbXBvbmVudChmcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnQpKTtcclxuICAgICAgICAgICAgaWYgKGZyYW1lQ29udGV4dHMgJiYgZnJhbWVDb250ZXh0cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8g5Y+q5aSE55CG5LqG5LiA5Liq57uE5Lu25Lit5YiX5Y+q57uR5a6a5Yiw5LiA5Liq5YmN56uv5o6n5Lu255qE5Zy65pmvXHJcbiAgICAgICAgICAgICAgICBjb25zdCBmb3JtQ29udHJvbHMgPSB0aGlzLmdldEZvcm1Db250cm9sQnlDb2x1bW5OYW1lKGZyYW1lQ29udGV4dCwgY29sdW1uKTtcclxuICAgICAgICAgICAgICAgIGlmIChmb3JtQ29udHJvbHMgJiYgZm9ybUNvbnRyb2xzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgZm9ybUNvbnRyb2xzLmZvckVhY2goKFtkb21Qcm9wZXJ0eU5hbWUsIGZvcm1Db250cm9sXSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vY29uc3QgZG9tUHJvcGVydHlOYW1lID0gZm9ybUNvbnRyb2wgJiYgZm9ybUNvbnRyb2wuIHx8IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXJnZU1lc3NhZ2UocmVzdWx0LmZvcm0sIGZyYW1lQ29udGV4dCwgZG9tUHJvcGVydHlOYW1lLCBtZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgLy9pZiAoZm9ybUNvbnRyb2wgJiYgZG9tUHJvcGVydHlOYW1lKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgLy99XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICAgIC8vIOWwhumUmeivr+S/oeaBr+aUvuWIsOaxh+aAu+S4rVxyXG4gICAgICAgICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB2aWV3TW9kZWxOYW1lID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5mb3JtLmZvcm1Hcm91cE5hbWU7XHJcbiAgICAgICAgICAgIGNvbnN0IGZvcm1Db250cm9scyA9IHRoaXMuZ2V0Rm9ybUNvbnRyb2xCeUNvbHVtbk5hbWUoZnJhbWVDb250ZXh0LCBjb2x1bW4pO1xyXG4gICAgICAgICAgICBpZiAoZm9ybUNvbnRyb2xzICYmIGZvcm1Db250cm9scy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgY29uc3QgW2RvbVByb3BlcnR5TmFtZSwgZm9ybUNvbnRyb2xdID0gZm9ybUNvbnRyb2xzLmZpbmQoKFtwcm9wZXJ0eU5hbWUsIGZvcm1Db250cm9sXSkgPT4gcHJvcGVydHlOYW1lICYmIHByb3BlcnR5TmFtZS5sZW5ndGggPiAwKTtcclxuICAgICAgICAgICAgICAvLyBjb25zdCBkb21Qcm9wZXJ0eU5hbWUgPSBkb21Qcm9wZXJ0eSAmJiBkb21Qcm9wZXJ0eS5wcm9wZXJ0eU5hbWU7XHJcbiAgICAgICAgICAgICAgY29uc3QgYmluZGluZ0xpc3QgPSBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdEYXRhLmdldFZhbHVlKGJpbmRpbmdQYXRocykgYXMgQmluZGluZ0xpc3Q7XHJcbiAgICAgICAgICAgICAgbGV0IGluZGV4ID0gYmluZGluZ0xpc3QuZ2V0SW5kZXhCeUlkKHJvdyk7XHJcbiAgICAgICAgICAgICAgY29uc3QgcHJpbWFyeSA9IGAke3Jvd31fJHtjb2x1bW59XyR7bWVzc2FnZX1gO1xyXG4gICAgICAgICAgICAgIC8vIFRPRE866Jm954S26IO957qg5q2j5rGH5oC75raI5oGv5pi+56S66YeN5aSN55qE6Zeu6aKY77yM5L2G5Y+v6IO95a+86Ie054K55Ye76ZSZ6K+v5peg5rOV5a6a5L2N5Yiw5a+55bqU5o6n5Lu255qE6Zeu6aKY77yM5b6F5ZCO57ut5LyY5YyWXHJcbiAgICAgICAgICAgICAgaWYgKGluZGV4ID49IDAgJiYgcmVzdWx0LmFsbC5maW5kSW5kZXgocCA9PiBwLmlkID09PSBwcmltYXJ5KSA9PT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIC8vIOaVsOaNrua6kOS4reacieWkmuS6jjHooYzml7bmmL7npLrntKLlvJVcclxuICAgICAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gKGJpbmRpbmdMaXN0ICYmIGJpbmRpbmdMaXN0Lmxlbmd0aCA+IDEpID8gKGluZGV4ICsgMSkgOiAtMTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRpdGxlID0gdGhpcy5idWlsZEl0ZW1UaXRsZSh2aWV3TW9kZWxOYW1lLCBmb3JtQ29udHJvbC5uYW1lIHx8IGZvcm1Db250cm9sLmRlZmF1bHRJMThuVmFsdWUgfHwgZG9tUHJvcGVydHlOYW1lLCBwb3NpdGlvbik7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpdGVtID0ge1xyXG4gICAgICAgICAgICAgICAgICBpZDogcHJpbWFyeSxcclxuICAgICAgICAgICAgICAgICAgaW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgIHRhcmdldEZpZWxkOiBmb3JtQ29udHJvbC5pZCxcclxuICAgICAgICAgICAgICAgICAgdGl0bGUsXHJcbiAgICAgICAgICAgICAgICAgIG1zZzogbWVzc2FnZSxcclxuICAgICAgICAgICAgICAgICAgbmFtZXNwYWNlOiBucyxcclxuICAgICAgICAgICAgICAgICAgYmluZGluZ1BhdGgsXHJcbiAgICAgICAgICAgICAgICAgIHR5cGU6ICdlcnJvcidcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICByZXN1bHQuYWxsLnB1c2goaXRlbSk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBpZiAoaGFzRm9ybWxlc3NFcnJvciAmJiBpc0V4Y2VwdGlvbiAmJiAhaGFzVGhyb3dFcnJvciAmJiBldmVudEJ1cykge1xyXG4gICAgICBldmVudEJ1cy5wb3N0KCdFeGNlcHRpb24nLCAnJywgJ29uRXhjZXB0aW9uJywgZXJyb3IsIGZvcm1BcHBDb250ZXh0KTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG4gIHByaXZhdGUgbWVyZ2VNZXNzYWdlKGZvcm1JdGVtczogeyBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgbWVzc2FnZTogeyBbZG9tUHJvcGVydHlOYW1lOiBzdHJpbmddOiB7IGVycm9yczogeyBbbWVzc2FnZVR5cGU6IHN0cmluZ106IHsgbmFtZTogc3RyaW5nIH0gfSB9IH0gfVtdLCBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgZG9tUHJvcGVydHlOYW1lOiBzdHJpbmcsIG1lc3NhZ2U6IHN0cmluZykge1xyXG4gICAgY29uc3QgdGFyZ2V0SXRlbSA9IGZvcm1JdGVtcy5maW5kKGl0ZW0gPT4gaXRlbS5mcmFtZUNvbnRleHQuZnJhbWVJZCA9PT0gZnJhbWVDb250ZXh0LmZyYW1lSWQpO1xyXG4gICAgaWYgKHRhcmdldEl0ZW0pIHtcclxuICAgICAgY29uc3QgaXNQcm9wZXJ0eUV4aXN0ID0gdGFyZ2V0SXRlbS5tZXNzYWdlICYmIE9iamVjdC5rZXlzKHRhcmdldEl0ZW0ubWVzc2FnZSkuaW5jbHVkZXMoZG9tUHJvcGVydHlOYW1lKTtcclxuICAgICAgY29uc3QgbWVzc2FnZVR5cGUgPSBgYmFja2VuZC1tZXNzYWdlLSR7T2JqZWN0LmtleXModGFyZ2V0SXRlbS5tZXNzYWdlKS5sZW5ndGggKyAxfWA7XHJcbiAgICAgIGlmIChpc1Byb3BlcnR5RXhpc3QpIHtcclxuICAgICAgICB0YXJnZXRJdGVtLm1lc3NhZ2VbZG9tUHJvcGVydHlOYW1lXVsnZXJyb3JzJ11bbWVzc2FnZVR5cGVdID0geyBuYW1lOiBtZXNzYWdlIH07XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGFyZ2V0SXRlbS5tZXNzYWdlW2RvbVByb3BlcnR5TmFtZV0gPSB7IGVycm9yczogeyBbbWVzc2FnZVR5cGVdOiB7IG5hbWU6IG1lc3NhZ2UgfSB9IH07XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGZvcm1JdGVtcy5wdXNoKHtcclxuICAgICAgICBmcmFtZUNvbnRleHQ6IGZyYW1lQ29udGV4dCxcclxuICAgICAgICBtZXNzYWdlOiB7XHJcbiAgICAgICAgICBbZG9tUHJvcGVydHlOYW1lXToge1xyXG4gICAgICAgICAgICBlcnJvcnM6IHtcclxuICAgICAgICAgICAgICAnYmFja2VuZC1tZXNzYWdlLTEnOiB7IG5hbWU6IG1lc3NhZ2UgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBidWlsZEl0ZW1UaXRsZSh2aWV3TW9kZWxOYW1lOiBzdHJpbmcsIHByb3BlcnR5TmFtZTogc3RyaW5nLCBpbmRleDogYW55KSB7XHJcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IHtcclxuICAgICAgJ3poLUNIUyc6IHtcclxuICAgICAgICB2aWV3TW9kZWxOYW1lOiBgJHZpZXdNb2RlbGAsXHJcbiAgICAgICAgaW5kZXg6IGDnrKwgJGluZGV4IOihjGAsXHJcbiAgICAgICAgcHJvcGVydHlOYW1lOiBgLSAkcHJvcGVydHlOYW1lYFxyXG4gICAgICB9LFxyXG4gICAgICAnZW4nOiB7XHJcbiAgICAgICAgdmlld01vZGVsTmFtZTogYCR2aWV3TW9kZWxgLFxyXG4gICAgICAgIGluZGV4OiBgcm93ICRpbmRleGAsXHJcbiAgICAgICAgcHJvcGVydHlOYW1lOiBgLSAkcHJvcGVydHlOYW1lYFxyXG4gICAgICB9LFxyXG4gICAgICAnemgtQ0hUJzoge1xyXG4gICAgICAgIHZpZXdNb2RlbE5hbWU6IGAkdmlld01vZGVsYCxcclxuICAgICAgICBpbmRleDogYOesrCAkaW5kZXgg6KGMYCxcclxuICAgICAgICBwcm9wZXJ0eU5hbWU6IGAtICRwcm9wZXJ0eU5hbWVgXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICBjb25zdCBjdXJyZW50TGFuZ3VhZ2UgPSB0aGlzLnRyYW5zbGF0ZS5nZXRDdXJyZW50TGFuZ3VhZ2UoKSB8fCAnemgtQ0hTJztcclxuICAgIGNvbnN0IG1lc3NhZ2UgPSBbXTtcclxuICAgIGlmICh2aWV3TW9kZWxOYW1lKSB7XHJcbiAgICAgIG1lc3NhZ2UucHVzaCh0ZW1wbGF0ZVtjdXJyZW50TGFuZ3VhZ2VdWyd2aWV3TW9kZWxOYW1lJ10ucmVwbGFjZSgnJHZpZXdNb2RlbCcsIHZpZXdNb2RlbE5hbWUpKTtcclxuICAgIH1cclxuICAgIGlmIChpbmRleCA+IDApIHtcclxuICAgICAgbWVzc2FnZS5wdXNoKHRlbXBsYXRlW2N1cnJlbnRMYW5ndWFnZV1bJ2luZGV4J10ucmVwbGFjZSgnJGluZGV4JywgaW5kZXgpKTtcclxuICAgIH1cclxuICAgIGlmIChwcm9wZXJ0eU5hbWUpIHtcclxuICAgICAgbWVzc2FnZS5wdXNoKHRlbXBsYXRlW2N1cnJlbnRMYW5ndWFnZV1bJ3Byb3BlcnR5TmFtZSddLnJlcGxhY2UoJyRwcm9wZXJ0eU5hbWUnLCBwcm9wZXJ0eU5hbWUpKTtcclxuICAgIH1cclxuICAgIHJldHVybiBtZXNzYWdlLmpvaW4oJyAnKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5qC55o2u6KGo5ZCN5oiWbm9kZUNvZGXojrflj5bnu5Hlrprot6/lvoRcclxuICAgKiBAcGFyYW0gYXBwQ29udGV4dCBhcHBDb250ZXh0XHJcbiAgICogQHBhcmFtIG5zIG5zXHJcbiAgICogQHBhcmFtIG5vZGVDb2RlIOihqOWQjVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0QmluZGluZ1BhdGgoYXBwQ29udGV4dDogQXBwQ29udGV4dCwgbnM6IHN0cmluZywgbm9kZUNvZGU6IHN0cmluZykge1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gdGhpcy5nZXRGcmFtZUNvbnRleHQoYXBwQ29udGV4dCwgbnMpO1xyXG4gICAgcmV0dXJuIGZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvLmdldEJpbmRpbmdQYXRoQnlUYWJsZU5hbWUobm9kZUNvZGUpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDpgJrov4fnu5Hlrprot6/lvoTlkozliJflkI3mib7liLDmiYDmnInnrKblkIjmnaHku7bnmoTop4blm77mqKHlnoso5YyF5ousZ3JpZOWSjGZvcm0pXHJcbiAgICogQHBhcmFtIGFwcENvbnRleHQgYXBwQ29udGV4dFxyXG4gICAqIEBwYXJhbSBucyBuYW1lc3BhY2VcclxuICAgKiBAcGFyYW0gYmluZGluZ1BhdGgg57uR5a6a6Lev5b6EXHJcbiAgICogQHBhcmFtIGNvbHVtbk5hbWUg5YiX5ZCNXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRGcmFtZUNvbnRleHRzQnlCaW5kaW5nUGF0aEFuZENvbHVtbk5hbWUoYXBwQ29udGV4dDogQXBwQ29udGV4dCwgbnM6IHN0cmluZywgYmluZGluZ1BhdGg6IHN0cmluZywgY29sdW1uTmFtZTogc3RyaW5nKTogRnJhbWVDb250ZXh0W10ge1xyXG4gICAgbGV0IGZyYW1lQ29udGV4dHMgPSBhcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpO1xyXG4gICAgaWYgKGZyYW1lQ29udGV4dHMgJiYgZnJhbWVDb250ZXh0cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIC8vIOaJvuWIsGZvcm3kuK3mnInmjqfku7bnmoRmcmFtZUNvbnRleHRcclxuICAgICAgZnJhbWVDb250ZXh0cyA9IGZyYW1lQ29udGV4dHMuZmlsdGVyKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICAgIC8vIOWfuuacrOadoeS7tuaYr+WQpua7oei2s1xyXG4gICAgICAgIGxldCBpc1ZhbGlkRnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0Lm5hbWVzcGFjZSA9PT0gbnMgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCA9PT0gYmluZGluZ1BhdGggJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5mb3JtICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuZm9ybS5jb250cm9scyAmJiBPYmplY3Qua2V5cyhmcmFtZUNvbnRleHQudmlld01vZGVsLmZvcm0uY29udHJvbHMpLmxlbmd0aCA+IDA7XHJcbiAgICAgICAgaWYgKCFpc1ZhbGlkRnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOWGjemAmui/h+WIl+WQjei/h+a7pFxyXG4gICAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgICAgY29uc3QgZGF0YVR5cGVJbmZvID0gZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8uZ2V0VHlwZUluZm9CeVBhdGgoYmluZGluZ1BhdGhzKTtcclxuICAgICAgICBpZiAoZGF0YVR5cGVJbmZvKSB7XHJcbiAgICAgICAgICBjb25zdCBkYXRhUHJvcEluZm9zID0gQXJyYXkuZnJvbShkYXRhVHlwZUluZm8ucHJvcEluZm9NYXAudmFsdWVzKCkpO1xyXG4gICAgICAgICAgLy8g5LuO5b2T5YmN5a6e5L2T5bGe5oCn5Lit5om+5Yiw5pWw5o2u5a2X5q615Li65YiX5ZCN55qE5bGe5oCnXHJcbiAgICAgICAgICBjb25zdCBlbnRpdHlQcm9wZXJ0eUluZm8gPSBkYXRhUHJvcEluZm9zLmZpbmQoKHByb3BJbmZvOiBEYXRhUHJvcEluZm8pID0+IHByb3BJbmZvLm1ldGFkYXRhSW5mbyAmJiAocHJvcEluZm8ubWV0YWRhdGFJbmZvLm9yaWdpbmFsRGF0YUZpZWxkID09PSBjb2x1bW5OYW1lIHx8IHByb3BJbmZvLm1ldGFkYXRhSW5mby5kYXRhRmllbGQgPT09IGNvbHVtbk5hbWUpKTtcclxuICAgICAgICAgIGlmIChlbnRpdHlQcm9wZXJ0eUluZm8pIHtcclxuICAgICAgICAgICAgY29uc3QgZW50aXR5UHJvcGVydHlOYW1lID0gZW50aXR5UHJvcGVydHlJbmZvLm5hbWU7XHJcbiAgICAgICAgICAgIGNvbnN0IG5nRm9ybUNvbnRyb2wgPSBPYmplY3QudmFsdWVzKGZyYW1lQ29udGV4dC52aWV3TW9kZWwuZm9ybS5uZ0Zvcm1Db250cm9scykuZmluZChpdGVtID0+IGl0ZW0uYmluZGluZyA9PT0gZW50aXR5UHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgICAgaWYgKG5nRm9ybUNvbnRyb2wpIHtcclxuICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICBjb25zdCBpdGVtID0gT2JqZWN0LmtleXMoZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5mb3JtLm5nRm9ybUNvbnRyb2xzKS5maW5kKGtleSA9PiBrZXkgPT09IGVudGl0eVByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGl0ZW0gPyB0cnVlIDogZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIHJldHVybiBmcmFtZUNvbnRleHRzO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaYr+WQpuS4umRhdGFncmlk57uE5Lu2XHJcbiAgICogQHBhcmFtIGZyYW1lQ29tcG9uZW50IGNvbXBvbmVudFxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNEYXRhR3JpZENvbXBvbmVudChmcmFtZUNvbXBvbmVudDogRnJhbWVDb21wb25lbnQpIHtcclxuICAgIGNvbnN0IGNvbHVtbk5hbWVzID0gZnJhbWVDb21wb25lbnQuY29udGV4dC52aWV3TW9kZWxbJ2RhdGFHcmlkQ29sdW1uc05hbWUnXSB8fCBudWxsO1xyXG4gICAgcmV0dXJuIGNvbHVtbk5hbWVzID8gdHJ1ZSA6IGZhbHNlO1xyXG4gIH1cclxuICAvKipcclxuICAgKiBncmlk57uE5Lu25piv5ZCm5piv5Y+q6K+755qEXHJcbiAgICogQHBhcmFtIGZyYW1lQ29tcG9uZW50IGZyYW1lQ29tcG9uZW50XHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpc1JlYWRvbmx5RGF0YUdyaWQoZnJhbWVDb21wb25lbnQ6IEZyYW1lQ29tcG9uZW50KSB7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSBmcmFtZUNvbXBvbmVudC5jb250ZXh0O1xyXG4gICAgY29uc3QgZGF0YUdyaWRDb2x1bW5zTmFtZSA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWxbJ2RhdGFHcmlkQ29sdW1uc05hbWUnXSB8fCBudWxsO1xyXG4gICAgaWYgKGRhdGFHcmlkQ29sdW1uc05hbWUpIHtcclxuICAgICAgY29uc3QgZGF0YWdyaWRDb2x1bW5zOiBhbnlbXSA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWxbZGF0YUdyaWRDb2x1bW5zTmFtZV07XHJcbiAgICAgIHJldHVybiBkYXRhZ3JpZENvbHVtbnMuZXZlcnkoKGdyb3VwOiBBcnJheTxhbnk+KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGdyb3VwLmV2ZXJ5KGl0ZW0gPT4gIWl0ZW0uZWRpdG9yKTtcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYOS8oOWFpeeahOe7hOS7tuS4jeaYr+S4gOS4quihqOagvO+8gWApO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiBpZOaYr+WQpuS4uuW9k+WJjeihjFxyXG4gICAqIEBwYXJhbSBhcHBDb250ZXh0IGFwcENvbnRleHRcclxuICAgKiBAcGFyYW0gbnMgbmFtZXNwYWNlXHJcbiAgICogQHBhcmFtIGJpbmRpbmdQYXRoIGJpbmRpbmdQYXRoXHJcbiAgICogQHBhcmFtIGlkIGlkXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpc0N1cnJlbnRSb3coYXBwQ29udGV4dDogQXBwQ29udGV4dCwgbnM6IHN0cmluZywgYmluZGluZ1BhdGg6IHN0cmluZywgaWQ6IHN0cmluZykge1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0RnJhbWVDb250ZXh0KGFwcENvbnRleHQsIG5zKTtcclxuICAgIGNvbnN0IGJpbmRpbmdEYXRhID0gZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhO1xyXG4gICAgY29uc3QgYmluZGluZ0xpc3QgPSBiaW5kaW5nRGF0YS5nZXRWYWx1ZShiaW5kaW5nUGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xyXG4gICAgcmV0dXJuIGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZSA9PT0gaWQ7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluW9k+WJjW5z5LiL55qEcm9vdEZyYW1lQ29udGV4dFxyXG4gICAqIEBwYXJhbSBhcHBDb250ZXh0IGFwcGNvbnRleHRcclxuICAgKiBAcGFyYW0gbnMgbmFtZXNwYWNlXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRGcmFtZUNvbnRleHQoYXBwQ29udGV4dDogQXBwQ29udGV4dCwgbnM6IHN0cmluZykge1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0cyA9IGFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzKCk7XHJcbiAgICBpZiAoZnJhbWVDb250ZXh0cyAmJiBmcmFtZUNvbnRleHRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgY29uc3QgcmFuZG9tRnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0cy5maW5kKGZyYW1lQ29udGV4dCA9PiBmcmFtZUNvbnRleHQubmFtZXNwYWNlID09PSBucyk7XHJcbiAgICAgIGlmIChyYW5kb21GcmFtZUNvbnRleHQpIHtcclxuICAgICAgICBjb25zdCB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dCA9IHJhbmRvbUZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpO1xyXG4gICAgICAgIHJldHVybiB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dDtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOmAmui/h+e7keWumui3r+W+hOWSjOWIl+WQjeiOt+WPlue7keWumuWIsOivpeWIl+eahGZvcm1Db250cm9sXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRGb3JtQ29udHJvbEJ5Q29sdW1uTmFtZShmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgY29sdW1uTmFtZTogc3RyaW5nKTogQXJyYXk8W3N0cmluZywgTmdGb3JtQ29udHJvbF0+IHtcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgIC8vIOmAmui/h2JpbmRpbmdQYXRo5om+5Yiw5a+55bqU55qE5a6e5L2T5L+h5oGvXHJcbiAgICBjb25zdCB0eXBlSW5mbyA9IGZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvLmdldFR5cGVJbmZvQnlQYXRoKGJpbmRpbmdQYXRocyk7XHJcblxyXG4gICAgY29uc3QgcHJvcHNJbmZvID0gQXJyYXkuZnJvbSh0eXBlSW5mby5wcm9wSW5mb01hcC52YWx1ZXMoKSk7XHJcbiAgICBjb25zdCBwcm9wSW5mbyA9IHByb3BzSW5mby5maW5kKChwcm9wSW5mbzogRGF0YVByb3BJbmZvKSA9PiBwcm9wSW5mby5tZXRhZGF0YUluZm8gJiYgKHByb3BJbmZvLm1ldGFkYXRhSW5mby5vcmlnaW5hbERhdGFGaWVsZCA9PT0gY29sdW1uTmFtZSB8fCBwcm9wSW5mby5tZXRhZGF0YUluZm8uZGF0YUZpZWxkID09PSBjb2x1bW5OYW1lKSk7XHJcbiAgICBpZiAocHJvcEluZm8pIHtcclxuICAgICAgY29uc3QgbWFwcGluZ05hbWUgPSBwcm9wSW5mby5uYW1lO1xyXG4gICAgICBjb25zdCBmb3JtQ29udHJvbHM6IEFycmF5PFtzdHJpbmcsIE5nRm9ybUNvbnRyb2xdPiA9IE9iamVjdC5lbnRyaWVzKGZyYW1lQ29udGV4dC52aWV3TW9kZWwuZm9ybS5uZ0Zvcm1Db250cm9scykuZmlsdGVyKChpdGVtKSA9PiBpdGVtWzFdLmJpbmRpbmcgPT09IG1hcHBpbmdOYW1lIHx8IGl0ZW1bMF0gPT09IG1hcHBpbmdOYW1lKTtcclxuICAgICAgLy8gY29uc3QgbmdGb3JtQ29udHJvbCA9IE9iamVjdC52YWx1ZXMoZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5mb3JtLm5nRm9ybUNvbnRyb2xzKS5maW5kKGl0ZW0gPT4gaXRlbS5iaW5kaW5nID09PSBtYXBwaW5nTmFtZSk7XHJcbiAgICAgIGlmIChmb3JtQ29udHJvbHMpIHtcclxuICAgICAgICByZXR1cm4gZm9ybUNvbnRyb2xzO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcbiAgcHJpdmF0ZSByZXNldEZvcm1NZXNzYWdlKGFwcENvbnRleHQ6IEFwcENvbnRleHQsIG5zOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dHMgPSBhcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpLmZpbHRlcihmcmFtZUNvbnRleHQgPT4gZnJhbWVDb250ZXh0Lm5hbWVzcGFjZSA9PT0gbnMpO1xyXG4gICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKGZyYW1lQ29udGV4dCA9PiBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmZvcm0gJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5mb3JtLmNsZWFyQmFja2VuZEVycm9yKCkpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDpgJLlvZLmib7liLDlsZXnpLrmtojmga/nmoTnu4Tku7bkuIrkuIvmlodcclxuICAgKiBAcGFyYW0gZnJhbWVDb250ZXh0IGZyYW1lQ29udGV4dFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZmluZFRhcmdldEZyYW1lQ29udGV4dChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCk6IEZyYW1lQ29udGV4dCB7XHJcbiAgICBjb25zdCB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpO1xyXG4gICAgY29uc3QgdmlydHVhbFJvb3RDb21wb25lbnQgPSB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudDtcclxuICAgIGNvbnN0IGlzRGlhbG9nQ29tcG9uZW50ID0gdmlydHVhbFJvb3RDb21wb25lbnQgJiYgdmlydHVhbFJvb3RDb21wb25lbnRbJ2lzRGlhbG9nUm9vdENvbXBvbmVudCddIHx8IGZhbHNlO1xyXG4gICAgaWYgKGlzRGlhbG9nQ29tcG9uZW50KSB7XHJcbiAgICAgIC8vIOWmguaenOa2iOaBr+WkhOeQhuacjeWKoeaYr+W8ueeql+WGheeahO+8jOWImea2iOaBr+aPkOekuuWxleekuuWcqOW8ueeql+WGhVxyXG4gICAgICByZXR1cm4gdmlydHVhbFJvb3RGcmFtZUNvbnRleHQ7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyDlvZPliY3mtojmga/mnI3liqHkuI3lnKjlvLnnqpflhoXvvIzpgJLlvZLlkJHkuIrmn6Xmib7vvIzmib7liLDnrKzkuIDkuKrlvLnnqpfvvIzlpoLmnpzmib7kuI3liLDliJnmib7liLDmnIDkuIrnmoRyb290LWNvbXBvbmVudFxyXG4gICAgICBjb25zdCBwYXJlbnRGcmFtZUNvbnRleHQgPSB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dC5wYXJlbnQ7XHJcbiAgICAgIGlmIChwYXJlbnRGcmFtZUNvbnRleHQpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5maW5kVGFyZ2V0RnJhbWVDb250ZXh0KHBhcmVudEZyYW1lQ29udGV4dCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIHZpcnR1YWxSb290RnJhbWVDb250ZXh0O1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59Il19