/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, HostBinding, ElementRef, Input, } from "@angular/core";
import { CommonUtils, OverLayHiddenService } from "@farris/ui-common";
import { debounceTime } from "rxjs/operators";
import { FDropdownDirective } from "./f-dropdown.directive";
export class FDropdownMenuDirective {
    /**
     * @param {?} elementRef
     * @param {?} dropdown
     */
    constructor(elementRef, dropdown) {
        this.elementRef = elementRef;
        this.dropdown = dropdown;
        this._docRect = { width: 0, height: 0 };
        this.showDropdownMenu = true;
        // 内部使用，在不变更依赖的情况下，触发改变
        this.dpIsOpen = false;
        this.overLayService = null;
        this.overLayService = new OverLayHiddenService();
        this.commonUtils = new CommonUtils();
        this.dropdown.getOpenState().pipe(debounceTime(50)).subscribe((/**
         * @param {?} state
         * @return {?}
         */
        (state) => {
            /** @type {?} */
            const ddmel = this.dropdown.getNativeElement();
            this.dpIsOpen = this.dropdown.isOpen;
            if (this.issubMenu()) {
                if (state && !this.dpIsOpen && this.elementRef.nativeElement.className.indexOf("show") < 0) {
                    this.dpIsOpen = true;
                }
                /** @type {?} */
                const dropdownMenus = this.dropdown.getNativeElement().closest('.dropdown-menu');
                if (dropdownMenus) {
                    /** @type {?} */
                    const showMenus = dropdownMenus.querySelectorAll('.show');
                    showMenus.forEach((/**
                     * @param {?} element
                     * @return {?}
                     */
                    (element) => {
                        element.classList.remove('show');
                        element.style.cssText = '';
                    }));
                }
            }
            if (this.dpIsOpen) {
                // 注册鼠标滚轮，点击事件，用于隐藏Panel
                this.overLayService.registerMouseEvent(ddmel, (/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                    /** @type {?} */
                    const tar = (/** @type {?} */ (e.target));
                    /** @type {?} */
                    var classList = Array.from(tar.classList || []);
                    if (classList.includes('dropdown-toggle') || tar.closest('.dropdown-item') || classList.includes("dropdown-item") ||
                        (this.dropdown.getNativeElement().contains(tar) && e.type !== "mousewheel") || this.elementRef.nativeElement.contains(tar)) {
                        return;
                    }
                    this.dpIsOpen = false;
                    this.dropdown.close(false);
                    this.openStateChange();
                }));
            }
            else {
                this.dropdown.close(false);
                this.overLayService.destory(ddmel);
            }
            this.openStateChange();
        }));
    }
    /**
     * @return {?}
     */
    ngAfterViewChecked() { }
    /**
     * @private
     * @param {?} pment
     * @return {?}
     */
    getRealPlacement(pment) {
        /** @type {?} */
        var result = "bottom-right";
        switch (pment) {
            case "top":
                result = "top-right";
                break;
            case "left":
                result = "left-bottom";
                break;
            case "right":
                result = "right-bottom";
                break;
            case "bottom":
                result = "bottom-right";
                break;
            default:
                result = pment;
        }
        return result;
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
    }
    /**
     * @private
     * @return {?}
     */
    openStateChange() {
        if (this.dpIsOpen) {
            if (this.elementRef.nativeElement.className.indexOf("show") < 0) {
                document.body.style.overflow = 'hidden';
                this.elementRef.nativeElement.style.visibility = 'hidden';
                this.elementRef.nativeElement.className += " show";
                if (this.dropdown.needToCalculate()) {
                    this._docRect = this.dropdown.getRectifyReferenceEl();
                }
                setTimeout((/**
                 * @return {?}
                 */
                () => {
                    this.changeDirection();
                    document.body.style.overflow = '';
                    this.elementRef.nativeElement.style.visibility = 'visible';
                }), 0);
            }
        }
        else {
            if (this.elementRef.nativeElement.className.indexOf("show") > -1) {
                this.elementRef.nativeElement.className = this.elementRef.nativeElement.className.replace(' show', ' ');
                this.elementRef.nativeElement.style.cssText = '';
            }
            /** @type {?} */
            const submenu = this.elementRef.nativeElement.querySelectorAll('.dropdown-menu');
            if (submenu && submenu.length) {
                submenu.forEach((/**
                 * @param {?} element
                 * @return {?}
                 */
                element => {
                    element.classList.remove('show');
                    element.style.cssText = '';
                }));
            }
            /** @type {?} */
            const showItem = this.elementRef.nativeElement.querySelector('.show');
            if (showItem) {
                showItem.classList.remove('show');
            }
            /** @type {?} */
            const activeItem = this.elementRef.nativeElement.querySelector('.active');
            if (activeItem) {
                activeItem.classList.remove('active');
            }
            this.dropdown['_internalOpen'] = false;
        }
    }
    /**
     * @private
     * @return {?}
     */
    changeDirection() {
        // if (this.dropdown.needToCalculate()) {
        //     const rect = this.elementRef.nativeElement.getBoundingClientRect();
        //     let placement = this.dropdown.placement;
        //     let newplacement = this.getRealPlacement(placement);
        //     placement = newplacement;
        //     //
        //     if (
        //         newplacement.indexOf("right") > -1 &&
        //         rect.right > this._docRect.width
        //     ) {
        //         placement = placement.replace("right", "left");
        //     }
        //     if (
        //         newplacement.indexOf("left") > -1 &&
        //         rect.left - rect.width < 0
        //     ) {
        //         placement = placement.replace("left", "right");
        //     }
        //     if (
        //         newplacement.indexOf("bottom") > -1 &&
        //         rect.bottom > this._docRect.height
        //     ) {
        //         placement = placement.replace("down", "up");
        //     }
        //     if (
        //         newplacement.indexOf("up") > -1 &&
        //         rect.bottom - rect.height < 0
        //     ) {
        //         placement = placement.replace("up", "bottom");
        //     }
        //     if (newplacement !== this.dropdown.placement) {
        //         this.dropdown.placement = newplacement;
        //     }
        //     if (placement !== newplacement) {
        //         this.dropdown.placement = placement;
        //     }
        //     this.dropdown.resetCalculate(false);
        // }
        this.setMenuPanelPosition();
    }
    /**
     * @private
     * @return {?}
     */
    issubMenu() {
        /** @type {?} */
        const dd = this.dropdown.getNativeElement();
        return dd.className.indexOf('dropdown-submenu') > -1 || dd.closest('.dropdown-submenu') || dd.classList.contains('dropright');
    }
    /**
     * @private
     * @return {?}
     */
    setMenuPanelPosition() {
        /** @type {?} */
        const parentMenuPanel = this.dropdown.getNativeElement();
        const { height, left, top, width } = parentMenuPanel.getBoundingClientRect();
        const { marginTop: menuMt, marginBottom: menuMb } = getComputedStyle(this.elementRef.nativeElement);
        const { width: pw, height: ph } = this.elementRef.nativeElement.getBoundingClientRect();
        /** @type {?} */
        let _maxHeight = 0;
        /** @type {?} */
        let tMenuMargin = Math.ceil(parseFloat(menuMt)) + Math.ceil(parseFloat(menuMb));
        /** @type {?} */
        let _top = top + height;
        /** @type {?} */
        let _left = left;
        if (window.innerHeight - top - height - tMenuMargin < ph) {
            _top = top - ph;
            if (_top < 0) {
                //当前的界面容不下menu上的按钮，限制menu的高度
                _top = 10;
                _maxHeight = top - _top - tMenuMargin;
            }
        }
        else {
        }
        if (window.innerWidth - left - width < pw) {
            _left = left - pw + width;
        }
        if (!this.issubMenu()) {
            document.body.append(this.elementRef.nativeElement);
            this.dropdown.appendMenuEl(this.elementRef.nativeElement);
            this.elementRef.nativeElement.style.cssText = `position:fixed;bottom:unset;left:${_left}px !important;top:${_top}px !important;right: unset;max-height:${_maxHeight ? _maxHeight + 'px;overflow:auto' : 'none'}`;
            this.elementRef.nativeElement.style.zIndex = this.commonUtils.getFloatingLayerIndex();
            // if (this.elementRef.nativeElement.classList.contains('solution-header-title-menu')) {
            //     this.elementRef.nativeElement.classList.add('query-solution');
            // }
            // const solutionBtns = this.elementRef.nativeElement.querySelector('.solution-header-dropdown-item-btns');
            // if (solutionBtns && !solutionBtns.classList.contains('dropdown-item')) {
            //     solutionBtns.classList.add('dropdown-item');
            // }
        }
        else {
            /** @type {?} */
            const childContainerWidth = window.innerWidth - left - parentMenuPanel.offsetWidth;
            /** @type {?} */
            const childMenuPanel = this.elementRef.nativeElement;
            if (childMenuPanel.offsetWidth > childContainerWidth) {
                /** @type {?} */
                const l = -pw;
                childMenuPanel.style.left = l + 'px';
            }
            /** @type {?} */
            const childContainerHeight = window.innerHeight - childMenuPanel.getBoundingClientRect().top;
            if (childContainerHeight < childMenuPanel.offsetHeight) {
                /** @type {?} */
                const t = window.innerHeight - top - childMenuPanel.offsetHeight - 10;
                childMenuPanel.style.top = t + 'px';
            }
        }
    }
}
FDropdownMenuDirective.decorators = [
    { type: Directive, args: [{
                selector: "[fDropdownMenu]",
            },] }
];
/** @nocollapse */
FDropdownMenuDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: FDropdownDirective }
];
FDropdownMenuDirective.propDecorators = {
    showDropdownMenu: [{ type: HostBinding, args: ["class.dropdown-menu",] }],
    dpIsOpen: [{ type: Input }]
};
if (false) {
    /**
     * @type {?}
     * @private
     */
    FDropdownMenuDirective.prototype._docRect;
    /** @type {?} */
    FDropdownMenuDirective.prototype.showDropdownMenu;
    /** @type {?} */
    FDropdownMenuDirective.prototype.dpIsOpen;
    /**
     * @type {?}
     * @private
     */
    FDropdownMenuDirective.prototype.overLayService;
    /**
     * @type {?}
     * @private
     */
    FDropdownMenuDirective.prototype.commonUtils;
    /**
     * @type {?}
     * @private
     */
    FDropdownMenuDirective.prototype.elementRef;
    /**
     * @type {?}
     * @private
     */
    FDropdownMenuDirective.prototype.dropdown;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZi1kcm9wZG93bi1tZW51LmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZHJvcGRvd24vIiwic291cmNlcyI6WyJsaWIvZi1kcm9wZG93bi1tZW51LmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUNILFNBQVMsRUFDVCxXQUFXLEVBRVgsVUFBVSxFQUVWLEtBQUssR0FFUixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsV0FBVyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDdEUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBSzVELE1BQU0sT0FBTyxzQkFBc0I7Ozs7O0lBTy9CLFlBQW9CLFVBQXNCLEVBQVUsUUFBNEI7UUFBNUQsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUFVLGFBQVEsR0FBUixRQUFRLENBQW9CO1FBTnhFLGFBQVEsR0FBRyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQ1AscUJBQWdCLEdBQUcsSUFBSSxDQUFDOztRQUVuRCxhQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ2xCLG1CQUFjLEdBQXlCLElBQUksQ0FBQztRQUdoRCxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksb0JBQW9CLEVBQUUsQ0FBQztRQUNqRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7UUFDckMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQzdCLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FDbkIsQ0FBQyxTQUFTOzs7O1FBQUMsQ0FBQyxLQUFjLEVBQUUsRUFBRTs7a0JBQ3JCLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGdCQUFnQixFQUFFO1lBQzlD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WyJpbXBvcnQge1xyXG4gICAgRGlyZWN0aXZlLFxyXG4gICAgSG9zdEJpbmRpbmcsXHJcbiAgICBBZnRlclZpZXdDaGVja2VkLFxyXG4gICAgRWxlbWVudFJlZixcclxuICAgIE9wdGlvbmFsLFxyXG4gICAgSW5wdXQsXHJcbiAgICBPbkRlc3Ryb3ksXHJcbn0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgQ29tbW9uVXRpbHMsIE92ZXJMYXlIaWRkZW5TZXJ2aWNlIH0gZnJvbSBcIkBmYXJyaXMvdWktY29tbW9uXCI7XHJcbmltcG9ydCB7IGRlYm91bmNlVGltZSB9IGZyb20gXCJyeGpzL29wZXJhdG9yc1wiO1xyXG5pbXBvcnQgeyBGRHJvcGRvd25EaXJlY3RpdmUgfSBmcm9tIFwiLi9mLWRyb3Bkb3duLmRpcmVjdGl2ZVwiO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogXCJbZkRyb3Bkb3duTWVudV1cIixcclxufSlcclxuZXhwb3J0IGNsYXNzIEZEcm9wZG93bk1lbnVEaXJlY3RpdmUgaW1wbGVtZW50cyBBZnRlclZpZXdDaGVja2VkLCBPbkRlc3Ryb3kge1xyXG4gICAgcHJpdmF0ZSBfZG9jUmVjdCA9IHsgd2lkdGg6IDAsIGhlaWdodDogMCB9O1xyXG4gICAgQEhvc3RCaW5kaW5nKFwiY2xhc3MuZHJvcGRvd24tbWVudVwiKSBzaG93RHJvcGRvd25NZW51ID0gdHJ1ZTtcclxuICAgIC8vIOWGhemDqOS9v+eUqO+8jOWcqOS4jeWPmOabtOS+nei1lueahOaDheWGteS4i++8jOinpuWPkeaUueWPmFxyXG4gICAgQElucHV0KCkgZHBJc09wZW4gPSBmYWxzZTtcclxuICAgIHByaXZhdGUgb3ZlckxheVNlcnZpY2U6IE92ZXJMYXlIaWRkZW5TZXJ2aWNlID0gbnVsbDtcclxuICAgIHByaXZhdGUgY29tbW9uVXRpbHM7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIHByaXZhdGUgZHJvcGRvd246IEZEcm9wZG93bkRpcmVjdGl2ZSApIHtcclxuICAgICAgICB0aGlzLm92ZXJMYXlTZXJ2aWNlID0gbmV3IE92ZXJMYXlIaWRkZW5TZXJ2aWNlKCk7XHJcbiAgICAgICAgdGhpcy5jb21tb25VdGlscyA9IG5ldyBDb21tb25VdGlscygpO1xyXG4gICAgICAgIHRoaXMuZHJvcGRvd24uZ2V0T3BlblN0YXRlKCkucGlwZShcclxuICAgICAgICAgICAgZGVib3VuY2VUaW1lKDUwKVxyXG4gICAgICAgICkuc3Vic2NyaWJlKChzdGF0ZTogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBkZG1lbCA9IHRoaXMuZHJvcGRvd24uZ2V0TmF0aXZlRWxlbWVudCgpOyAgICBcclxuICAgICAgICAgICAgdGhpcy5kcElzT3BlbiA9IHRoaXMuZHJvcGRvd24uaXNPcGVuO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuaXNzdWJNZW51KCkpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzdGF0ZSAmJiAhdGhpcy5kcElzT3BlbiAmJiB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc05hbWUuaW5kZXhPZihcInNob3dcIikgPCAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcElzT3BlbiA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgZHJvcGRvd25NZW51cyA9IHRoaXMuZHJvcGRvd24uZ2V0TmF0aXZlRWxlbWVudCgpLmNsb3Nlc3QoJy5kcm9wZG93bi1tZW51JylcclxuICAgICAgICAgICAgICAgIGlmIChkcm9wZG93bk1lbnVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hvd01lbnVzID0gZHJvcGRvd25NZW51cy5xdWVyeVNlbGVjdG9yQWxsKCcuc2hvdycpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNob3dNZW51cy5mb3JFYWNoKChlbGVtZW50OiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCdzaG93Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUuY3NzVGV4dCA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5kcElzT3Blbikge1xyXG4gICAgICAgICAgICAgICAgLy8g5rOo5YaM6byg5qCH5rua6L2u77yM54K55Ye75LqL5Lu277yM55So5LqO6ZqQ6JePUGFuZWxcclxuICAgICAgICAgICAgICAgIHRoaXMub3ZlckxheVNlcnZpY2UucmVnaXN0ZXJNb3VzZUV2ZW50KGRkbWVsLCAoZTogTW91c2VFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhciA9IGUudGFyZ2V0IGFzIGFueTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgY2xhc3NMaXN0ID0gQXJyYXkuZnJvbSh0YXIuY2xhc3NMaXN0IHx8IFtdKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCBjbGFzc0xpc3QuaW5jbHVkZXMoJ2Ryb3Bkb3duLXRvZ2dsZScpIHx8IHRhci5jbG9zZXN0KCcuZHJvcGRvd24taXRlbScpIHx8IGNsYXNzTGlzdC5pbmNsdWRlcyhcImRyb3Bkb3duLWl0ZW1cIikgfHwgXHJcbiAgICAgICAgICAgICAgICAgICAgKHRoaXMuZHJvcGRvd24uZ2V0TmF0aXZlRWxlbWVudCgpLmNvbnRhaW5zKHRhcikgJiYgZS50eXBlICE9PSBcIm1vdXNld2hlZWxcIiAgKSB8fCB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jb250YWlucyh0YXIpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcElzT3BlbiA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uY2xvc2UoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMub3BlblN0YXRlQ2hhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uY2xvc2UoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vdmVyTGF5U2VydmljZS5kZXN0b3J5KGRkbWVsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLm9wZW5TdGF0ZUNoYW5nZSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgbmdBZnRlclZpZXdDaGVja2VkKCkge31cclxuICAgIHByaXZhdGUgZ2V0UmVhbFBsYWNlbWVudChwbWVudCkge1xyXG4gICAgICAgIHZhciByZXN1bHQgPSBcImJvdHRvbS1yaWdodFwiO1xyXG4gICAgICAgIHN3aXRjaCAocG1lbnQpIHtcclxuICAgICAgICAgICAgY2FzZSBcInRvcFwiOlxyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gXCJ0b3AtcmlnaHRcIjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwibGVmdFwiOlxyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gXCJsZWZ0LWJvdHRvbVwiO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJyaWdodFwiOlxyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gXCJyaWdodC1ib3R0b21cIjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwiYm90dG9tXCI6XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBcImJvdHRvbS1yaWdodFwiO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBwbWVudDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIG9wZW5TdGF0ZUNoYW5nZSgpIHtcclxuICAgICAgICBpZiAodGhpcy5kcElzT3Blbikge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lLmluZGV4T2YoXCJzaG93XCIpIDwgMCkge1xyXG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lICs9IFwiIHNob3dcIjtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmRyb3Bkb3duLm5lZWRUb0NhbGN1bGF0ZSgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZG9jUmVjdCA9IHRoaXMuZHJvcGRvd24uZ2V0UmVjdGlmeVJlZmVyZW5jZUVsKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5nZURpcmVjdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUub3ZlcmZsb3cgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnO1xyXG4gICAgICAgICAgICAgICAgfSwgMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lLmluZGV4T2YoXCJzaG93XCIpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZSA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZS5yZXBsYWNlKCcgc2hvdycsJyAnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnN0eWxlLmNzc1RleHQgPSAnJztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3Qgc3VibWVudSA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5kcm9wZG93bi1tZW51Jyk7XHJcbiAgICAgICAgICAgIGlmIChzdWJtZW51ICYmIHN1Ym1lbnUubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBzdWJtZW51LmZvckVhY2goZWxlbWVudCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCdzaG93Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5jc3NUZXh0ID0gJyc7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3Qgc2hvd0l0ZW0gPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCcuc2hvdycpO1xyXG4gICAgICAgICAgICBpZiAoc2hvd0l0ZW0pIHtcclxuICAgICAgICAgICAgICAgIHNob3dJdGVtLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3cnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBhY3RpdmVJdGVtID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignLmFjdGl2ZScpO1xyXG4gICAgICAgICAgICBpZiAoYWN0aXZlSXRlbSkge1xyXG4gICAgICAgICAgICAgICAgYWN0aXZlSXRlbS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5kcm9wZG93blsnX2ludGVybmFsT3BlbiddID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBjaGFuZ2VEaXJlY3Rpb24oKSB7XHJcbiAgICAgICAgLy8gaWYgKHRoaXMuZHJvcGRvd24ubmVlZFRvQ2FsY3VsYXRlKCkpIHtcclxuICAgICAgICAvLyAgICAgY29uc3QgcmVjdCA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgIC8vICAgICBsZXQgcGxhY2VtZW50ID0gdGhpcy5kcm9wZG93bi5wbGFjZW1lbnQ7XHJcbiAgICAgICAgLy8gICAgIGxldCBuZXdwbGFjZW1lbnQgPSB0aGlzLmdldFJlYWxQbGFjZW1lbnQocGxhY2VtZW50KTtcclxuICAgICAgICAvLyAgICAgcGxhY2VtZW50ID0gbmV3cGxhY2VtZW50O1xyXG4gICAgICAgIC8vICAgICAvL1xyXG4gICAgICAgIC8vICAgICBpZiAoXHJcbiAgICAgICAgLy8gICAgICAgICBuZXdwbGFjZW1lbnQuaW5kZXhPZihcInJpZ2h0XCIpID4gLTEgJiZcclxuICAgICAgICAvLyAgICAgICAgIHJlY3QucmlnaHQgPiB0aGlzLl9kb2NSZWN0LndpZHRoXHJcbiAgICAgICAgLy8gICAgICkge1xyXG4gICAgICAgIC8vICAgICAgICAgcGxhY2VtZW50ID0gcGxhY2VtZW50LnJlcGxhY2UoXCJyaWdodFwiLCBcImxlZnRcIik7XHJcbiAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAvLyAgICAgaWYgKFxyXG4gICAgICAgIC8vICAgICAgICAgbmV3cGxhY2VtZW50LmluZGV4T2YoXCJsZWZ0XCIpID4gLTEgJiZcclxuICAgICAgICAvLyAgICAgICAgIHJlY3QubGVmdCAtIHJlY3Qud2lkdGggPCAwXHJcbiAgICAgICAgLy8gICAgICkge1xyXG4gICAgICAgIC8vICAgICAgICAgcGxhY2VtZW50ID0gcGxhY2VtZW50LnJlcGxhY2UoXCJsZWZ0XCIsIFwicmlnaHRcIik7XHJcbiAgICAgICAgLy8gICAgIH1cclxuXHJcbiAgICAgICAgLy8gICAgIGlmIChcclxuICAgICAgICAvLyAgICAgICAgIG5ld3BsYWNlbWVudC5pbmRleE9mKFwiYm90dG9tXCIpID4gLTEgJiZcclxuICAgICAgICAvLyAgICAgICAgIHJlY3QuYm90dG9tID4gdGhpcy5fZG9jUmVjdC5oZWlnaHRcclxuICAgICAgICAvLyAgICAgKSB7XHJcbiAgICAgICAgLy8gICAgICAgICBwbGFjZW1lbnQgPSBwbGFjZW1lbnQucmVwbGFjZShcImRvd25cIiwgXCJ1cFwiKTtcclxuICAgICAgICAvLyAgICAgfVxyXG4gICAgICAgIC8vICAgICBpZiAoXHJcbiAgICAgICAgLy8gICAgICAgICBuZXdwbGFjZW1lbnQuaW5kZXhPZihcInVwXCIpID4gLTEgJiZcclxuICAgICAgICAvLyAgICAgICAgIHJlY3QuYm90dG9tIC0gcmVjdC5oZWlnaHQgPCAwXHJcbiAgICAgICAgLy8gICAgICkge1xyXG4gICAgICAgIC8vICAgICAgICAgcGxhY2VtZW50ID0gcGxhY2VtZW50LnJlcGxhY2UoXCJ1cFwiLCBcImJvdHRvbVwiKTtcclxuICAgICAgICAvLyAgICAgfVxyXG4gICAgICAgIC8vICAgICBpZiAobmV3cGxhY2VtZW50ICE9PSB0aGlzLmRyb3Bkb3duLnBsYWNlbWVudCkge1xyXG4gICAgICAgIC8vICAgICAgICAgdGhpcy5kcm9wZG93bi5wbGFjZW1lbnQgPSBuZXdwbGFjZW1lbnQ7XHJcbiAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAvLyAgICAgaWYgKHBsYWNlbWVudCAhPT0gbmV3cGxhY2VtZW50KSB7XHJcbiAgICAgICAgLy8gICAgICAgICB0aGlzLmRyb3Bkb3duLnBsYWNlbWVudCA9IHBsYWNlbWVudDtcclxuICAgICAgICAvLyAgICAgfVxyXG4gICAgICAgIC8vICAgICB0aGlzLmRyb3Bkb3duLnJlc2V0Q2FsY3VsYXRlKGZhbHNlKTtcclxuICAgICAgICAvLyB9XHJcblxyXG4gICAgICAgIHRoaXMuc2V0TWVudVBhbmVsUG9zaXRpb24oKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBpc3N1Yk1lbnUoKSB7XHJcbiAgICAgICAgY29uc3QgZGQgPSB0aGlzLmRyb3Bkb3duLmdldE5hdGl2ZUVsZW1lbnQoKTtcclxuICAgICAgICBcclxuICAgICAgICByZXR1cm4gZGQuY2xhc3NOYW1lLmluZGV4T2YoJ2Ryb3Bkb3duLXN1Ym1lbnUnKSA+IC0xIHx8IGRkLmNsb3Nlc3QoJy5kcm9wZG93bi1zdWJtZW51JykgfHwgZGQuY2xhc3NMaXN0LmNvbnRhaW5zKCdkcm9wcmlnaHQnKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBzZXRNZW51UGFuZWxQb3NpdGlvbigpIHtcclxuICAgICAgICBjb25zdCBwYXJlbnRNZW51UGFuZWwgPSAgdGhpcy5kcm9wZG93bi5nZXROYXRpdmVFbGVtZW50KCk7XHJcbiAgICAgICAgY29uc3QgeyBoZWlnaHQsIGxlZnQsIHRvcCwgd2lkdGggfSA9IHBhcmVudE1lbnVQYW5lbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICBjb25zdHttYXJnaW5Ub3A6bWVudU10LG1hcmdpbkJvdHRvbTptZW51TWJ9PWdldENvbXB1dGVkU3R5bGUodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgIGNvbnN0IHsgd2lkdGg6IHB3LCBoZWlnaHQ6IHBoIH0gPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICBsZXQgX21heEhlaWdodD0wO1xyXG4gICAgICAgIGxldCB0TWVudU1hcmdpbj0gTWF0aC5jZWlsKHBhcnNlRmxvYXQobWVudU10KSkrIE1hdGguY2VpbChwYXJzZUZsb2F0KG1lbnVNYikpO1xyXG4gICAgICAgIGxldCBfdG9wID0gdG9wICsgaGVpZ2h0O1xyXG4gICAgICAgIGxldCBfbGVmdCA9IGxlZnQ7XHJcbiAgICAgICAgaWYgKHdpbmRvdy5pbm5lckhlaWdodCAtIHRvcCAtIGhlaWdodCAtIHRNZW51TWFyZ2luIDwgcGgpIHtcclxuICAgICAgICAgICAgX3RvcCA9IHRvcCAtIHBoO1xyXG4gICAgICAgICAgICBpZihfdG9wPDApe1xyXG4gICAgICAgICAgICAgICAgLy/lvZPliY3nmoTnlYzpnaLlrrnkuI3kuIttZW515LiK55qE5oyJ6ZKu77yM6ZmQ5Yi2bWVudeeahOmrmOW6plxyXG4gICAgICAgICAgICAgICAgX3RvcD0xMDtcclxuICAgICAgICAgICAgICAgIF9tYXhIZWlnaHQ9dG9wLV90b3AtdE1lbnVNYXJnaW47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh3aW5kb3cuaW5uZXJXaWR0aCAtIGxlZnQgLSB3aWR0aCA8IHB3KSB7XHJcbiAgICAgICAgICAgIF9sZWZ0ID0gbGVmdCAtIHB3ICsgd2lkdGg7XHJcbiAgICAgICAgfSBcclxuXHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKCF0aGlzLmlzc3ViTWVudSgpKSB7XHJcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5hcHBlbmRNZW51RWwodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgICAgICB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5zdHlsZS5jc3NUZXh0ID0gYHBvc2l0aW9uOmZpeGVkO2JvdHRvbTp1bnNldDtsZWZ0OiR7X2xlZnR9cHggIWltcG9ydGFudDt0b3A6JHtfdG9wfXB4ICFpbXBvcnRhbnQ7cmlnaHQ6IHVuc2V0O21heC1oZWlnaHQ6JHtfbWF4SGVpZ2h0P19tYXhIZWlnaHQrJ3B4O292ZXJmbG93OmF1dG8nOidub25lJ31gO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuc3R5bGUuekluZGV4ID0gdGhpcy5jb21tb25VdGlscy5nZXRGbG9hdGluZ0xheWVySW5kZXgoKTtcclxuXHJcbiAgICAgICAgICAgIC8vIGlmICh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoJ3NvbHV0aW9uLWhlYWRlci10aXRsZS1tZW51JykpIHtcclxuICAgICAgICAgICAgLy8gICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ3F1ZXJ5LXNvbHV0aW9uJyk7XHJcbiAgICAgICAgICAgIC8vIH1cclxuXHJcbiAgICAgICAgICAgIC8vIGNvbnN0IHNvbHV0aW9uQnRucyA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5zb2x1dGlvbi1oZWFkZXItZHJvcGRvd24taXRlbS1idG5zJyk7XHJcbiAgICAgICAgICAgIC8vIGlmIChzb2x1dGlvbkJ0bnMgJiYgIXNvbHV0aW9uQnRucy5jbGFzc0xpc3QuY29udGFpbnMoJ2Ryb3Bkb3duLWl0ZW0nKSkge1xyXG4gICAgICAgICAgICAvLyAgICAgc29sdXRpb25CdG5zLmNsYXNzTGlzdC5hZGQoJ2Ryb3Bkb3duLWl0ZW0nKTtcclxuICAgICAgICAgICAgLy8gfVxyXG5cclxuXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgY2hpbGRDb250YWluZXJXaWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoIC0gbGVmdCAtIHBhcmVudE1lbnVQYW5lbC5vZmZzZXRXaWR0aDtcclxuICAgICAgICAgICAgY29uc3QgY2hpbGRNZW51UGFuZWwgPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudDtcclxuICAgICAgICAgICAgaWYgKGNoaWxkTWVudVBhbmVsLm9mZnNldFdpZHRoID4gY2hpbGRDb250YWluZXJXaWR0aCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbCA9IC1wdztcclxuICAgICAgICAgICAgICAgIGNoaWxkTWVudVBhbmVsLnN0eWxlLmxlZnQgPSBsICsgJ3B4JztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgY2hpbGRDb250YWluZXJIZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQgLSBjaGlsZE1lbnVQYW5lbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS50b3A7XHJcbiAgICAgICAgICAgIGlmIChjaGlsZENvbnRhaW5lckhlaWdodCA8IGNoaWxkTWVudVBhbmVsLm9mZnNldEhlaWdodCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdCA9IHdpbmRvdy5pbm5lckhlaWdodCAtIHRvcCAtIGNoaWxkTWVudVBhbmVsLm9mZnNldEhlaWdodCAtIDEwO1xyXG4gICAgICAgICAgICAgICAgY2hpbGRNZW51UGFuZWwuc3R5bGUudG9wID0gdCArICdweCc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19