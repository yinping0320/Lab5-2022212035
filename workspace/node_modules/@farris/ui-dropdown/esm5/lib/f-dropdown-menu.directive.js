/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, HostBinding, ElementRef, Input, } from "@angular/core";
import { CommonUtils, OverLayHiddenService } from "@farris/ui-common";
import { debounceTime } from "rxjs/operators";
import { FDropdownDirective } from "./f-dropdown.directive";
var FDropdownMenuDirective = /** @class */ (function () {
    function FDropdownMenuDirective(elementRef, dropdown) {
        var _this = this;
        this.elementRef = elementRef;
        this.dropdown = dropdown;
        this._docRect = { width: 0, height: 0 };
        this.showDropdownMenu = true;
        // 内部使用，在不变更依赖的情况下，触发改变
        this.dpIsOpen = false;
        this.overLayService = null;
        this.overLayService = new OverLayHiddenService();
        this.commonUtils = new CommonUtils();
        this.dropdown.getOpenState().pipe(debounceTime(50)).subscribe((/**
         * @param {?} state
         * @return {?}
         */
        function (state) {
            /** @type {?} */
            var ddmel = _this.dropdown.getNativeElement();
            _this.dpIsOpen = _this.dropdown.isOpen;
            if (_this.issubMenu()) {
                if (state && !_this.dpIsOpen && _this.elementRef.nativeElement.className.indexOf("show") < 0) {
                    _this.dpIsOpen = true;
                }
                /** @type {?} */
                var dropdownMenus = _this.dropdown.getNativeElement().closest('.dropdown-menu');
                if (dropdownMenus) {
                    /** @type {?} */
                    var showMenus = dropdownMenus.querySelectorAll('.show');
                    showMenus.forEach((/**
                     * @param {?} element
                     * @return {?}
                     */
                    function (element) {
                        element.classList.remove('show');
                        element.style.cssText = '';
                    }));
                }
            }
            if (_this.dpIsOpen) {
                // 注册鼠标滚轮，点击事件，用于隐藏Panel
                _this.overLayService.registerMouseEvent(ddmel, (/**
                 * @param {?} e
                 * @return {?}
                 */
                function (e) {
                    /** @type {?} */
                    var tar = (/** @type {?} */ (e.target));
                    /** @type {?} */
                    var classList = Array.from(tar.classList || []);
                    if (classList.includes('dropdown-toggle') || tar.closest('.dropdown-item') || classList.includes("dropdown-item") ||
                        (_this.dropdown.getNativeElement().contains(tar) && e.type !== "mousewheel") || _this.elementRef.nativeElement.contains(tar)) {
                        return;
                    }
                    _this.dpIsOpen = false;
                    _this.dropdown.close(false);
                    _this.openStateChange();
                }));
            }
            else {
                _this.dropdown.close(false);
                _this.overLayService.destory(ddmel);
            }
            _this.openStateChange();
        }));
    }
    /**
     * @return {?}
     */
    FDropdownMenuDirective.prototype.ngAfterViewChecked = /**
     * @return {?}
     */
    function () { };
    /**
     * @private
     * @param {?} pment
     * @return {?}
     */
    FDropdownMenuDirective.prototype.getRealPlacement = /**
     * @private
     * @param {?} pment
     * @return {?}
     */
    function (pment) {
        /** @type {?} */
        var result = "bottom-right";
        switch (pment) {
            case "top":
                result = "top-right";
                break;
            case "left":
                result = "left-bottom";
                break;
            case "right":
                result = "right-bottom";
                break;
            case "bottom":
                result = "bottom-right";
                break;
            default:
                result = pment;
        }
        return result;
    };
    /**
     * @return {?}
     */
    FDropdownMenuDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @private
     * @return {?}
     */
    FDropdownMenuDirective.prototype.openStateChange = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.dpIsOpen) {
            if (this.elementRef.nativeElement.className.indexOf("show") < 0) {
                document.body.style.overflow = 'hidden';
                this.elementRef.nativeElement.style.visibility = 'hidden';
                this.elementRef.nativeElement.className += " show";
                if (this.dropdown.needToCalculate()) {
                    this._docRect = this.dropdown.getRectifyReferenceEl();
                }
                setTimeout((/**
                 * @return {?}
                 */
                function () {
                    _this.changeDirection();
                    document.body.style.overflow = '';
                    _this.elementRef.nativeElement.style.visibility = 'visible';
                }), 0);
            }
        }
        else {
            if (this.elementRef.nativeElement.className.indexOf("show") > -1) {
                this.elementRef.nativeElement.className = this.elementRef.nativeElement.className.replace(' show', ' ');
                this.elementRef.nativeElement.style.cssText = '';
            }
            /** @type {?} */
            var submenu = this.elementRef.nativeElement.querySelectorAll('.dropdown-menu');
            if (submenu && submenu.length) {
                submenu.forEach((/**
                 * @param {?} element
                 * @return {?}
                 */
                function (element) {
                    element.classList.remove('show');
                    element.style.cssText = '';
                }));
            }
            /** @type {?} */
            var showItem = this.elementRef.nativeElement.querySelector('.show');
            if (showItem) {
                showItem.classList.remove('show');
            }
            /** @type {?} */
            var activeItem = this.elementRef.nativeElement.querySelector('.active');
            if (activeItem) {
                activeItem.classList.remove('active');
            }
            this.dropdown['_internalOpen'] = false;
        }
    };
    /**
     * @private
     * @return {?}
     */
    FDropdownMenuDirective.prototype.changeDirection = /**
     * @private
     * @return {?}
     */
    function () {
        // if (this.dropdown.needToCalculate()) {
        //     const rect = this.elementRef.nativeElement.getBoundingClientRect();
        //     let placement = this.dropdown.placement;
        //     let newplacement = this.getRealPlacement(placement);
        //     placement = newplacement;
        //     //
        //     if (
        //         newplacement.indexOf("right") > -1 &&
        //         rect.right > this._docRect.width
        //     ) {
        //         placement = placement.replace("right", "left");
        //     }
        //     if (
        //         newplacement.indexOf("left") > -1 &&
        //         rect.left - rect.width < 0
        //     ) {
        //         placement = placement.replace("left", "right");
        //     }
        //     if (
        //         newplacement.indexOf("bottom") > -1 &&
        //         rect.bottom > this._docRect.height
        //     ) {
        //         placement = placement.replace("down", "up");
        //     }
        //     if (
        //         newplacement.indexOf("up") > -1 &&
        //         rect.bottom - rect.height < 0
        //     ) {
        //         placement = placement.replace("up", "bottom");
        //     }
        //     if (newplacement !== this.dropdown.placement) {
        //         this.dropdown.placement = newplacement;
        //     }
        //     if (placement !== newplacement) {
        //         this.dropdown.placement = placement;
        //     }
        //     this.dropdown.resetCalculate(false);
        // }
        this.setMenuPanelPosition();
    };
    /**
     * @private
     * @return {?}
     */
    FDropdownMenuDirective.prototype.issubMenu = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var dd = this.dropdown.getNativeElement();
        return dd.className.indexOf('dropdown-submenu') > -1 || dd.closest('.dropdown-submenu') || dd.classList.contains('dropright');
    };
    /**
     * @private
     * @return {?}
     */
    FDropdownMenuDirective.prototype.setMenuPanelPosition = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var parentMenuPanel = this.dropdown.getNativeElement();
        var _a = parentMenuPanel.getBoundingClientRect(), height = _a.height, left = _a.left, top = _a.top, width = _a.width;
        var _b = getComputedStyle(this.elementRef.nativeElement), menuMt = _b.marginTop, menuMb = _b.marginBottom;
        var _c = this.elementRef.nativeElement.getBoundingClientRect(), pw = _c.width, ph = _c.height;
        /** @type {?} */
        var _maxHeight = 0;
        /** @type {?} */
        var tMenuMargin = Math.ceil(parseFloat(menuMt)) + Math.ceil(parseFloat(menuMb));
        /** @type {?} */
        var _top = top + height;
        /** @type {?} */
        var _left = left;
        if (window.innerHeight - top - height - tMenuMargin < ph) {
            _top = top - ph;
            if (_top < 0) {
                //当前的界面容不下menu上的按钮，限制menu的高度
                _top = 10;
                _maxHeight = top - _top - tMenuMargin;
            }
        }
        else {
        }
        if (window.innerWidth - left - width < pw) {
            _left = left - pw + width;
        }
        if (!this.issubMenu()) {
            document.body.append(this.elementRef.nativeElement);
            this.dropdown.appendMenuEl(this.elementRef.nativeElement);
            this.elementRef.nativeElement.style.cssText = "position:fixed;bottom:unset;left:" + _left + "px !important;top:" + _top + "px !important;right: unset;max-height:" + (_maxHeight ? _maxHeight + 'px;overflow:auto' : 'none');
            this.elementRef.nativeElement.style.zIndex = this.commonUtils.getFloatingLayerIndex();
            // if (this.elementRef.nativeElement.classList.contains('solution-header-title-menu')) {
            //     this.elementRef.nativeElement.classList.add('query-solution');
            // }
            // const solutionBtns = this.elementRef.nativeElement.querySelector('.solution-header-dropdown-item-btns');
            // if (solutionBtns && !solutionBtns.classList.contains('dropdown-item')) {
            //     solutionBtns.classList.add('dropdown-item');
            // }
        }
        else {
            /** @type {?} */
            var childContainerWidth = window.innerWidth - left - parentMenuPanel.offsetWidth;
            /** @type {?} */
            var childMenuPanel = this.elementRef.nativeElement;
            if (childMenuPanel.offsetWidth > childContainerWidth) {
                /** @type {?} */
                var l = -pw;
                childMenuPanel.style.left = l + 'px';
            }
            /** @type {?} */
            var childContainerHeight = window.innerHeight - childMenuPanel.getBoundingClientRect().top;
            if (childContainerHeight < childMenuPanel.offsetHeight) {
                /** @type {?} */
                var t = window.innerHeight - top - childMenuPanel.offsetHeight - 10;
                childMenuPanel.style.top = t + 'px';
            }
        }
    };
    FDropdownMenuDirective.decorators = [
        { type: Directive, args: [{
                    selector: "[fDropdownMenu]",
                },] }
    ];
    /** @nocollapse */
    FDropdownMenuDirective.ctorParameters = function () { return [
        { type: ElementRef },
        { type: FDropdownDirective }
    ]; };
    FDropdownMenuDirective.propDecorators = {
        showDropdownMenu: [{ type: HostBinding, args: ["class.dropdown-menu",] }],
        dpIsOpen: [{ type: Input }]
    };
    return FDropdownMenuDirective;
}());
export { FDropdownMenuDirective };
if (false) {
    /**
     * @type {?}
     * @private
     */
    FDropdownMenuDirective.prototype._docRect;
    /** @type {?} */
    FDropdownMenuDirective.prototype.showDropdownMenu;
    /** @type {?} */
    FDropdownMenuDirective.prototype.dpIsOpen;
    /**
     * @type {?}
     * @private
     */
    FDropdownMenuDirective.prototype.overLayService;
    /**
     * @type {?}
     * @private
     */
    FDropdownMenuDirective.prototype.commonUtils;
    /**
     * @type {?}
     * @private
     */
    FDropdownMenuDirective.prototype.elementRef;
    /**
     * @type {?}
     * @private
     */
    FDropdownMenuDirective.prototype.dropdown;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZi1kcm9wZG93bi1tZW51LmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZHJvcGRvd24vIiwic291cmNlcyI6WyJsaWIvZi1kcm9wZG93bi1tZW51LmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUNILFNBQVMsRUFDVCxXQUFXLEVBRVgsVUFBVSxFQUVWLEtBQUssR0FFUixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsV0FBVyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDdEUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRTVEO0lBVUksZ0NBQW9CLFVBQXNCLEVBQVUsUUFBNEI7UUFBaEYsaUJBNENDO1FBNUNtQixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBb0I7UUFOeEUsYUFBUSxHQUFHLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLENBQUM7UUFDUCxxQkFBZ0IsR0FBRyxJQUFJLENBQUM7O1FBRW5ELGFBQVEsR0FBRyxLQUFLLENBQUM7UUFDbEIsbUJBQWMsR0FBeUIsSUFBSSxDQUFDO1FBR2hELElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxvQkFBb0IsRUFBRSxDQUFDO1FBQ2pELElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUNyQyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRSxDQUFDLElBQUksQ0FDN0IsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUNuQixDQUFDLFNBQVM7Ozs7UUFBQyxVQUFDLEtBQWM7O2dCQUNqQixLQUFLLEdBQUcsS0FBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRTtZQUM5QyxLQUFJLENBQUMsUUFBUSxH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QTJHO1lBQzNHLDJFQUEyRTtZQUMzRSxtREFBbUQ7WUFDbkQsSUFBSTtTQUdQO2FBQU07O2dCQUNHLG1CQUFtQixHQUFHLE1BQU0sQ0FBQyxVQUFVLEdBQUcsSUFBSSxHQUFHLGVBQWUsQ0FBQyxXQUFXOztnQkFDNUUsY0FBYyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYTtZQUNwRCxJQUFJLGNBQWMsQ0FBQyxXQUFXLEdBQUcsbUJBQW1CLEVBQUU7O29CQUM1QyxDQUFDLEdBQUcsQ0FBQyxFQUFFO2dCQUNiLGNBQWMsQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUM7YUFDeEM7O2dCQUVLLG9CQUFvQixHQUFHLE1BQU0sQ0FBQyxXQUFXLEdBQUcsY0FBYyxDQUFDLHFCQUFxQixFQUFFLENBQUMsR0FBRztZQUM1RixJQUFJLG9CQUFvQixHQUFHLGNBQWMsQ0FBQyxZQUFZLEVBQUU7O29CQUM5QyxDQUFDLEdBQUcsTUFBTSxDQUFDLFdBQVcsR0FBRyxHQUFHLEdBQUcsY0FBYyxDQUFDLFlBQVksR0FBRyxFQUFFO2dCQUNyRSxjQUFjLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDO2FBQ3ZDO1NBQ0o7SUFDTCxDQUFDOztnQkFyT0osU0FBUyxTQUFDO29CQUNQLFFBQVEsRUFBRSxpQkFBaUI7aUJBQzlCOzs7O2dCQVhHLFVBQVU7Z0JBT0wsa0JBQWtCOzs7bUNBT3RCLFdBQVcsU0FBQyxxQkFBcUI7MkJBRWpDLEtBQUs7O0lBK05WLDZCQUFDO0NBQUEsQUF0T0QsSUFzT0M7U0FuT1ksc0JBQXNCOzs7Ozs7SUFDL0IsMENBQTJDOztJQUMzQyxrREFBNEQ7O0lBRTVELDBDQUEwQjs7Ozs7SUFDMUIsZ0RBQW9EOzs7OztJQUNwRCw2Q0FBb0I7Ozs7O0lBQ1IsNENBQThCOzs7OztJQUFFLDBDQUFvQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgICBEaXJlY3RpdmUsXHJcbiAgICBIb3N0QmluZGluZyxcclxuICAgIEFmdGVyVmlld0NoZWNrZWQsXHJcbiAgICBFbGVtZW50UmVmLFxyXG4gICAgT3B0aW9uYWwsXHJcbiAgICBJbnB1dCxcclxuICAgIE9uRGVzdHJveSxcclxufSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBDb21tb25VdGlscywgT3ZlckxheUhpZGRlblNlcnZpY2UgfSBmcm9tIFwiQGZhcnJpcy91aS1jb21tb25cIjtcclxuaW1wb3J0IHsgZGVib3VuY2VUaW1lIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XHJcbmltcG9ydCB7IEZEcm9wZG93bkRpcmVjdGl2ZSB9IGZyb20gXCIuL2YtZHJvcGRvd24uZGlyZWN0aXZlXCI7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICAgIHNlbGVjdG9yOiBcIltmRHJvcGRvd25NZW51XVwiLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgRkRyb3Bkb3duTWVudURpcmVjdGl2ZSBpbXBsZW1lbnRzIEFmdGVyVmlld0NoZWNrZWQsIE9uRGVzdHJveSB7XHJcbiAgICBwcml2YXRlIF9kb2NSZWN0ID0geyB3aWR0aDogMCwgaGVpZ2h0OiAwIH07XHJcbiAgICBASG9zdEJpbmRpbmcoXCJjbGFzcy5kcm9wZG93bi1tZW51XCIpIHNob3dEcm9wZG93bk1lbnUgPSB0cnVlO1xyXG4gICAgLy8g5YaF6YOo5L2/55So77yM5Zyo5LiN5Y+Y5pu05L6d6LWW55qE5oOF5Ya15LiL77yM6Kem5Y+R5pS55Y+YXHJcbiAgICBASW5wdXQoKSBkcElzT3BlbiA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSBvdmVyTGF5U2VydmljZTogT3ZlckxheUhpZGRlblNlcnZpY2UgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBjb21tb25VdGlscztcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgZWxlbWVudFJlZjogRWxlbWVudFJlZiwgcHJpdmF0ZSBkcm9wZG93bjogRkRyb3Bkb3duRGlyZWN0aXZlICkge1xyXG4gICAgICAgIHRoaXMub3ZlckxheVNlcnZpY2UgPSBuZXcgT3ZlckxheUhpZGRlblNlcnZpY2UoKTtcclxuICAgICAgICB0aGlzLmNvbW1vblV0aWxzID0gbmV3IENvbW1vblV0aWxzKCk7XHJcbiAgICAgICAgdGhpcy5kcm9wZG93bi5nZXRPcGVuU3RhdGUoKS5waXBlKFxyXG4gICAgICAgICAgICBkZWJvdW5jZVRpbWUoNTApXHJcbiAgICAgICAgKS5zdWJzY3JpYmUoKHN0YXRlOiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRkbWVsID0gdGhpcy5kcm9wZG93bi5nZXROYXRpdmVFbGVtZW50KCk7ICAgIFxyXG4gICAgICAgICAgICB0aGlzLmRwSXNPcGVuID0gdGhpcy5kcm9wZG93bi5pc09wZW47XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5pc3N1Yk1lbnUoKSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlICYmICF0aGlzLmRwSXNPcGVuICYmIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZS5pbmRleE9mKFwic2hvd1wiKSA8IDApIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRwSXNPcGVuID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBkcm9wZG93bk1lbnVzID0gdGhpcy5kcm9wZG93bi5nZXROYXRpdmVFbGVtZW50KCkuY2xvc2VzdCgnLmRyb3Bkb3duLW1lbnUnKVxyXG4gICAgICAgICAgICAgICAgaWYgKGRyb3Bkb3duTWVudXMpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzaG93TWVudXMgPSBkcm9wZG93bk1lbnVzLnF1ZXJ5U2VsZWN0b3JBbGwoJy5zaG93Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2hvd01lbnVzLmZvckVhY2goKGVsZW1lbnQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3cnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5jc3NUZXh0ID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmRwSXNPcGVuKSB7XHJcbiAgICAgICAgICAgICAgICAvLyDms6jlhozpvKDmoIfmu5rova7vvIzngrnlh7vkuovku7bvvIznlKjkuo7pmpDol49QYW5lbFxyXG4gICAgICAgICAgICAgICAgdGhpcy5vdmVyTGF5U2VydmljZS5yZWdpc3Rlck1vdXNlRXZlbnQoZGRtZWwsIChlOiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFyID0gZS50YXJnZXQgYXMgYW55O1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjbGFzc0xpc3QgPSBBcnJheS5mcm9tKHRhci5jbGFzc0xpc3QgfHwgW10pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoIGNsYXNzTGlzdC5pbmNsdWRlcygnZHJvcGRvd24tdG9nZ2xlJykgfHwgdGFyLmNsb3Nlc3QoJy5kcm9wZG93bi1pdGVtJykgfHwgY2xhc3NMaXN0LmluY2x1ZGVzKFwiZHJvcGRvd24taXRlbVwiKSB8fCBcclxuICAgICAgICAgICAgICAgICAgICAodGhpcy5kcm9wZG93bi5nZXROYXRpdmVFbGVtZW50KCkuY29udGFpbnModGFyKSAmJiBlLnR5cGUgIT09IFwibW91c2V3aGVlbFwiICApIHx8IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNvbnRhaW5zKHRhcikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRwSXNPcGVuID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5jbG9zZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuU3RhdGVDaGFuZ2UoKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5jbG9zZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm92ZXJMYXlTZXJ2aWNlLmRlc3RvcnkoZGRtZWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMub3BlblN0YXRlQ2hhbmdlKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBuZ0FmdGVyVmlld0NoZWNrZWQoKSB7fVxyXG4gICAgcHJpdmF0ZSBnZXRSZWFsUGxhY2VtZW50KHBtZW50KSB7XHJcbiAgICAgICAgdmFyIHJlc3VsdCA9IFwiYm90dG9tLXJpZ2h0XCI7XHJcbiAgICAgICAgc3dpdGNoIChwbWVudCkge1xyXG4gICAgICAgICAgICBjYXNlIFwidG9wXCI6XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBcInRvcC1yaWdodFwiO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJsZWZ0XCI6XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBcImxlZnQtYm90dG9tXCI7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcInJpZ2h0XCI6XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBcInJpZ2h0LWJvdHRvbVwiO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJib3R0b21cIjpcclxuICAgICAgICAgICAgICAgIHJlc3VsdCA9IFwiYm90dG9tLXJpZ2h0XCI7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIHJlc3VsdCA9IHBtZW50O1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgb3BlblN0YXRlQ2hhbmdlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmRwSXNPcGVuKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc05hbWUuaW5kZXhPZihcInNob3dcIikgPCAwKSB7XHJcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LnN0eWxlLm92ZXJmbG93ID0gJ2hpZGRlbic7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc05hbWUgKz0gXCIgc2hvd1wiO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZHJvcGRvd24ubmVlZFRvQ2FsY3VsYXRlKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9kb2NSZWN0ID0gdGhpcy5kcm9wZG93bi5nZXRSZWN0aWZ5UmVmZXJlbmNlRWwoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhbmdlRGlyZWN0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS5vdmVyZmxvdyA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7XHJcbiAgICAgICAgICAgICAgICB9LCAwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc05hbWUuaW5kZXhPZihcInNob3dcIikgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lLnJlcGxhY2UoJyBzaG93JywnICcpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuc3R5bGUuY3NzVGV4dCA9ICcnO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBzdWJtZW51ID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmRyb3Bkb3duLW1lbnUnKTtcclxuICAgICAgICAgICAgaWYgKHN1Ym1lbnUgJiYgc3VibWVudS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHN1Ym1lbnUuZm9yRWFjaChlbGVtZW50ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3cnKTtcclxuICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnN0eWxlLmNzc1RleHQgPSAnJztcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBzaG93SXRlbSA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5zaG93Jyk7XHJcbiAgICAgICAgICAgIGlmIChzaG93SXRlbSkge1xyXG4gICAgICAgICAgICAgICAgc2hvd0l0ZW0uY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGFjdGl2ZUl0ZW0gPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCcuYWN0aXZlJyk7XHJcbiAgICAgICAgICAgIGlmIChhY3RpdmVJdGVtKSB7XHJcbiAgICAgICAgICAgICAgICBhY3RpdmVJdGVtLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRyb3Bkb3duWydfaW50ZXJuYWxPcGVuJ10gPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGNoYW5nZURpcmVjdGlvbigpIHtcclxuICAgICAgICAvLyBpZiAodGhpcy5kcm9wZG93bi5uZWVkVG9DYWxjdWxhdGUoKSkge1xyXG4gICAgICAgIC8vICAgICBjb25zdCByZWN0ID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgLy8gICAgIGxldCBwbGFjZW1lbnQgPSB0aGlzLmRyb3Bkb3duLnBsYWNlbWVudDtcclxuICAgICAgICAvLyAgICAgbGV0IG5ld3BsYWNlbWVudCA9IHRoaXMuZ2V0UmVhbFBsYWNlbWVudChwbGFjZW1lbnQpO1xyXG4gICAgICAgIC8vICAgICBwbGFjZW1lbnQgPSBuZXdwbGFjZW1lbnQ7XHJcbiAgICAgICAgLy8gICAgIC8vXHJcbiAgICAgICAgLy8gICAgIGlmIChcclxuICAgICAgICAvLyAgICAgICAgIG5ld3BsYWNlbWVudC5pbmRleE9mKFwicmlnaHRcIikgPiAtMSAmJlxyXG4gICAgICAgIC8vICAgICAgICAgcmVjdC5yaWdodCA+IHRoaXMuX2RvY1JlY3Qud2lkdGhcclxuICAgICAgICAvLyAgICAgKSB7XHJcbiAgICAgICAgLy8gICAgICAgICBwbGFjZW1lbnQgPSBwbGFjZW1lbnQucmVwbGFjZShcInJpZ2h0XCIsIFwibGVmdFwiKTtcclxuICAgICAgICAvLyAgICAgfVxyXG4gICAgICAgIC8vICAgICBpZiAoXHJcbiAgICAgICAgLy8gICAgICAgICBuZXdwbGFjZW1lbnQuaW5kZXhPZihcImxlZnRcIikgPiAtMSAmJlxyXG4gICAgICAgIC8vICAgICAgICAgcmVjdC5sZWZ0IC0gcmVjdC53aWR0aCA8IDBcclxuICAgICAgICAvLyAgICAgKSB7XHJcbiAgICAgICAgLy8gICAgICAgICBwbGFjZW1lbnQgPSBwbGFjZW1lbnQucmVwbGFjZShcImxlZnRcIiwgXCJyaWdodFwiKTtcclxuICAgICAgICAvLyAgICAgfVxyXG5cclxuICAgICAgICAvLyAgICAgaWYgKFxyXG4gICAgICAgIC8vICAgICAgICAgbmV3cGxhY2VtZW50LmluZGV4T2YoXCJib3R0b21cIikgPiAtMSAmJlxyXG4gICAgICAgIC8vICAgICAgICAgcmVjdC5ib3R0b20gPiB0aGlzLl9kb2NSZWN0LmhlaWdodFxyXG4gICAgICAgIC8vICAgICApIHtcclxuICAgICAgICAvLyAgICAgICAgIHBsYWNlbWVudCA9IHBsYWNlbWVudC5yZXBsYWNlKFwiZG93blwiLCBcInVwXCIpO1xyXG4gICAgICAgIC8vICAgICB9XHJcbiAgICAgICAgLy8gICAgIGlmIChcclxuICAgICAgICAvLyAgICAgICAgIG5ld3BsYWNlbWVudC5pbmRleE9mKFwidXBcIikgPiAtMSAmJlxyXG4gICAgICAgIC8vICAgICAgICAgcmVjdC5ib3R0b20gLSByZWN0LmhlaWdodCA8IDBcclxuICAgICAgICAvLyAgICAgKSB7XHJcbiAgICAgICAgLy8gICAgICAgICBwbGFjZW1lbnQgPSBwbGFjZW1lbnQucmVwbGFjZShcInVwXCIsIFwiYm90dG9tXCIpO1xyXG4gICAgICAgIC8vICAgICB9XHJcbiAgICAgICAgLy8gICAgIGlmIChuZXdwbGFjZW1lbnQgIT09IHRoaXMuZHJvcGRvd24ucGxhY2VtZW50KSB7XHJcbiAgICAgICAgLy8gICAgICAgICB0aGlzLmRyb3Bkb3duLnBsYWNlbWVudCA9IG5ld3BsYWNlbWVudDtcclxuICAgICAgICAvLyAgICAgfVxyXG4gICAgICAgIC8vICAgICBpZiAocGxhY2VtZW50ICE9PSBuZXdwbGFjZW1lbnQpIHtcclxuICAgICAgICAvLyAgICAgICAgIHRoaXMuZHJvcGRvd24ucGxhY2VtZW50ID0gcGxhY2VtZW50O1xyXG4gICAgICAgIC8vICAgICB9XHJcbiAgICAgICAgLy8gICAgIHRoaXMuZHJvcGRvd24ucmVzZXRDYWxjdWxhdGUoZmFsc2UpO1xyXG4gICAgICAgIC8vIH1cclxuXHJcbiAgICAgICAgdGhpcy5zZXRNZW51UGFuZWxQb3NpdGlvbigpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIGlzc3ViTWVudSgpIHtcclxuICAgICAgICBjb25zdCBkZCA9IHRoaXMuZHJvcGRvd24uZ2V0TmF0aXZlRWxlbWVudCgpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiBkZC5jbGFzc05hbWUuaW5kZXhPZignZHJvcGRvd24tc3VibWVudScpID4gLTEgfHwgZGQuY2xvc2VzdCgnLmRyb3Bkb3duLXN1Ym1lbnUnKSB8fCBkZC5jbGFzc0xpc3QuY29udGFpbnMoJ2Ryb3ByaWdodCcpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIHNldE1lbnVQYW5lbFBvc2l0aW9uKCkge1xyXG4gICAgICAgIGNvbnN0IHBhcmVudE1lbnVQYW5lbCA9ICB0aGlzLmRyb3Bkb3duLmdldE5hdGl2ZUVsZW1lbnQoKTtcclxuICAgICAgICBjb25zdCB7IGhlaWdodCwgbGVmdCwgdG9wLCB3aWR0aCB9ID0gcGFyZW50TWVudVBhbmVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgIGNvbnN0e21hcmdpblRvcDptZW51TXQsbWFyZ2luQm90dG9tOm1lbnVNYn09Z2V0Q29tcHV0ZWRTdHlsZSh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCk7XHJcbiAgICAgICAgY29uc3QgeyB3aWR0aDogcHcsIGhlaWdodDogcGggfSA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgIGxldCBfbWF4SGVpZ2h0PTA7XHJcbiAgICAgICAgbGV0IHRNZW51TWFyZ2luPSBNYXRoLmNlaWwocGFyc2VGbG9hdChtZW51TXQpKSsgTWF0aC5jZWlsKHBhcnNlRmxvYXQobWVudU1iKSk7XHJcbiAgICAgICAgbGV0IF90b3AgPSB0b3AgKyBoZWlnaHQ7XHJcbiAgICAgICAgbGV0IF9sZWZ0ID0gbGVmdDtcclxuICAgICAgICBpZiAod2luZG93LmlubmVySGVpZ2h0IC0gdG9wIC0gaGVpZ2h0IC0gdE1lbnVNYXJnaW4gPCBwaCkge1xyXG4gICAgICAgICAgICBfdG9wID0gdG9wIC0gcGg7XHJcbiAgICAgICAgICAgIGlmKF90b3A8MCl7XHJcbiAgICAgICAgICAgICAgICAvL+W9k+WJjeeahOeVjOmdouWuueS4jeS4i21lbnXkuIrnmoTmjInpkq7vvIzpmZDliLZtZW5155qE6auY5bqmXHJcbiAgICAgICAgICAgICAgICBfdG9wPTEwO1xyXG4gICAgICAgICAgICAgICAgX21heEhlaWdodD10b3AtX3RvcC10TWVudU1hcmdpbjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHdpbmRvdy5pbm5lcldpZHRoIC0gbGVmdCAtIHdpZHRoIDwgcHcpIHtcclxuICAgICAgICAgICAgX2xlZnQgPSBsZWZ0IC0gcHcgKyB3aWR0aDtcclxuICAgICAgICB9IFxyXG5cclxuICAgICAgICBcclxuICAgICAgICBpZiAoIXRoaXMuaXNzdWJNZW51KCkpIHtcclxuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmQodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgICAgICB0aGlzLmRyb3Bkb3duLmFwcGVuZE1lbnVFbCh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCk7XHJcbiAgICAgICAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnN0eWxlLmNzc1RleHQgPSBgcG9zaXRpb246Zml4ZWQ7Ym90dG9tOnVuc2V0O2xlZnQ6JHtfbGVmdH1weCAhaW1wb3J0YW50O3RvcDoke190b3B9cHggIWltcG9ydGFudDtyaWdodDogdW5zZXQ7bWF4LWhlaWdodDoke19tYXhIZWlnaHQ/X21heEhlaWdodCsncHg7b3ZlcmZsb3c6YXV0byc6J25vbmUnfWA7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5zdHlsZS56SW5kZXggPSB0aGlzLmNvbW1vblV0aWxzLmdldEZsb2F0aW5nTGF5ZXJJbmRleCgpO1xyXG5cclxuICAgICAgICAgICAgLy8gaWYgKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNsYXNzTGlzdC5jb250YWlucygnc29sdXRpb24taGVhZGVyLXRpdGxlLW1lbnUnKSkge1xyXG4gICAgICAgICAgICAvLyAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NMaXN0LmFkZCgncXVlcnktc29sdXRpb24nKTtcclxuICAgICAgICAgICAgLy8gfVxyXG5cclxuICAgICAgICAgICAgLy8gY29uc3Qgc29sdXRpb25CdG5zID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignLnNvbHV0aW9uLWhlYWRlci1kcm9wZG93bi1pdGVtLWJ0bnMnKTtcclxuICAgICAgICAgICAgLy8gaWYgKHNvbHV0aW9uQnRucyAmJiAhc29sdXRpb25CdG5zLmNsYXNzTGlzdC5jb250YWlucygnZHJvcGRvd24taXRlbScpKSB7XHJcbiAgICAgICAgICAgIC8vICAgICBzb2x1dGlvbkJ0bnMuY2xhc3NMaXN0LmFkZCgnZHJvcGRvd24taXRlbScpO1xyXG4gICAgICAgICAgICAvLyB9XHJcblxyXG5cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBjaGlsZENvbnRhaW5lcldpZHRoID0gd2luZG93LmlubmVyV2lkdGggLSBsZWZ0IC0gcGFyZW50TWVudVBhbmVsLm9mZnNldFdpZHRoO1xyXG4gICAgICAgICAgICBjb25zdCBjaGlsZE1lbnVQYW5lbCA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xyXG4gICAgICAgICAgICBpZiAoY2hpbGRNZW51UGFuZWwub2Zmc2V0V2lkdGggPiBjaGlsZENvbnRhaW5lcldpZHRoKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBsID0gLXB3O1xyXG4gICAgICAgICAgICAgICAgY2hpbGRNZW51UGFuZWwuc3R5bGUubGVmdCA9IGwgKyAncHgnO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBjaGlsZENvbnRhaW5lckhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCAtIGNoaWxkTWVudVBhbmVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcDtcclxuICAgICAgICAgICAgaWYgKGNoaWxkQ29udGFpbmVySGVpZ2h0IDwgY2hpbGRNZW51UGFuZWwub2Zmc2V0SGVpZ2h0KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0ID0gd2luZG93LmlubmVySGVpZ2h0IC0gdG9wIC0gY2hpbGRNZW51UGFuZWwub2Zmc2V0SGVpZ2h0IC0gMTA7XHJcbiAgICAgICAgICAgICAgICBjaGlsZE1lbnVQYW5lbC5zdHlsZS50b3AgPSB0ICsgJ3B4JztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=