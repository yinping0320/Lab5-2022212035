/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, Input, Output, HostBinding, EventEmitter, ElementRef, Renderer2 } from '@angular/core';
import { Subject } from 'rxjs';
var FDropdownDirective = /** @class */ (function () {
    function FDropdownDirective(elementRef, render) {
        var _this = this;
        this.elementRef = elementRef;
        this.render = render;
        // tslint:disable-next-line:no-input-rename
        this._internalOpen = false;
        // 计算宽度
        this._calculateMenu = false;
        // 是否自动纠正位置
        this.autoRectify = false;
        this.dpChangeEvent = new EventEmitter();
        this._placement = 'bottom'; // 记录 position
        // 记录 position
        this.isSubDP = false; // 是否是子下拉
        this.isOpenState = new Subject();
        this.menuEls = new WeakMap();
        this._seflEl = this.elementRef.nativeElement;
        this.isOpenState.subscribe((/**
         * @param {?} state
         * @return {?}
         */
        function (state) {
            if (_this._internalOpen !== state) {
                _this._internalOpen = state;
                if (_this._internalOpen) {
                    _this.render.addClass(_this._seflEl, 'show');
                }
                else {
                    _this.render.removeClass(_this._seflEl, 'show');
                }
            }
        }));
    }
    Object.defineProperty(FDropdownDirective.prototype, "forceState", {
        // 在外面强制控制关闭状态
        set: 
        // 在外面强制控制关闭状态
        /**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            if (value && value.length) {
                this.close();
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FDropdownDirective.prototype, "openState", {
        set: /**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            this._internalOpen = value[0];
            this.isOpenState.next(value[0]);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FDropdownDirective.prototype, "placement", {
        get: /**
         * @return {?}
         */
        function () {
            return this._placement;
        },
        set: 
        // 是否是子下拉
        /**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            // 如果相等
            if (!value) {
                return;
            }
            //
            if (value !== this._placement) {
                /** @type {?} */
                var newClsName = this._getClsName(value);
                /** @type {?} */
                var oldClsName = this._getClsName(this._placement);
                this.render.removeClass(this._seflEl, oldClsName);
                this.render.addClass(this._seflEl, newClsName);
                this._placement = value;
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FDropdownDirective.prototype, "isOpen", {
        // @HostBinding('class.show')
        get: 
        // @HostBinding('class.show')
        /**
         * @return {?}
         */
        function () {
            return this._internalOpen;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FDropdownDirective.prototype, "submenuCls", {
        get: /**
         * @return {?}
         */
        function () {
            return this.isSubDP;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FDropdownDirective.prototype, "dropdownCls", {
        get: /**
         * @return {?}
         */
        function () {
            return !this.isSubDP;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    FDropdownDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @return {?}
     */
    FDropdownDirective.prototype.getNativeElement = /**
     * @return {?}
     */
    function () {
        return this._seflEl;
    };
    /**
     * @private
     * @return {?}
     */
    FDropdownDirective.prototype.bindDocumentEvents = /**
     * @private
     * @return {?}
     */
    function () {
        //   this.ngzone.runOutsideAngular(() => {
        this.documentClickEventListener = this.onDocumentClick.bind(this);
        document.addEventListener('click', this.documentClickEventListener);
        // 绑定被操作native时触发
        this.selfDefineEventListener = this.onSelfDefineHandler.bind(this);
        this._seflEl.addEventListener('selfClose', this.selfDefineEventListener);
        // });
    };
    /**
     * @private
     * @return {?}
     */
    FDropdownDirective.prototype.onSelfDefineHandler = /**
     * @private
     * @return {?}
     */
    function () {
        this.close();
    };
    /**
     * @private
     * @return {?}
     */
    FDropdownDirective.prototype.unbindDocumentEvents = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.documentClickEventListener) {
            document.removeEventListener('click', this.documentClickEventListener);
            this.documentClickEventListener = null;
        }
        if (this.selfDefineEventListener) {
            this._seflEl.removeEventListener('selfClose', this.selfDefineEventListener);
            this.selfDefineEventListener = null;
        }
    };
    /**
     * @private
     * @param {?} event
     * @return {?}
     */
    FDropdownDirective.prototype.onDocumentClick = /**
     * @private
     * @param {?} event
     * @return {?}
     */
    function (event) {
        // 如果已经关闭，不需要再响应
        if (!this._internalOpen) {
            return;
        }
        if (event.button !== 2 && !this.isEventFromToggle(event)) {
            this.close();
        }
    };
    // 判断menu展开时是否要计算
    // 判断menu展开时是否要计算
    /**
     * @return {?}
     */
    FDropdownDirective.prototype.needToCalculate = 
    // 判断menu展开时是否要计算
    /**
     * @return {?}
     */
    function () {
        return this.autoRectify && this._calculateMenu;
    };
    /**
     * @param {?} value
     * @return {?}
     */
    FDropdownDirective.prototype.resetCalculate = /**
     * @param {?} value
     * @return {?}
     */
    function (value) {
        this._calculateMenu = value;
    };
    /**
     * @return {?}
     */
    FDropdownDirective.prototype.open = /**
     * @return {?}
     */
    function () {
        if (!this._internalOpen) {
            this.closeSiblingDropdowns();
            this._calculateMenu = true;
            this.render.addClass(this._seflEl, 'show');
            this.isOpenState.next(true);
            this.dpChangeEvent.emit(true);
            // 执行绑定事件
            this.bindDocumentEvents();
        }
    };
    /**
     * @param {?=} emit
     * @return {?}
     */
    FDropdownDirective.prototype.close = /**
     * @param {?=} emit
     * @return {?}
     */
    function (emit) {
        if (emit === void 0) { emit = true; }
        if (this._internalOpen) {
            this._calculateMenu = false;
            this.render.removeClass(this._seflEl, 'show');
            if (emit) {
                this.isOpenState.next(false);
                this.dpChangeEvent.emit(false);
            }
            this.unbindDocumentEvents();
        }
    };
    /**
     * @return {?}
     */
    FDropdownDirective.prototype.toggle = /**
     * @return {?}
     */
    function () {
        if (this._internalOpen) {
            this.close();
        }
        else {
            this.open();
        }
    };
    /**
     * @return {?}
     */
    FDropdownDirective.prototype.getOpenState = /**
     * @return {?}
     */
    function () {
        return this.isOpenState;
    };
    /**
     * @return {?}
     */
    FDropdownDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.isOpenState.unsubscribe();
        this.unbindDocumentEvents();
        /** @type {?} */
        var menuels = this.menuEls.get(this._seflEl);
        if (menuels && menuels.length) {
            menuels.forEach((/**
             * @param {?} element
             * @return {?}
             */
            function (element) {
                element.remove();
            }));
        }
    };
    /**
     * @private
     * @return {?}
     */
    FDropdownDirective.prototype.closeSiblingDropdowns = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var dpParentEl = this._seflEl.parentNode;
        if (dpParentEl && dpParentEl['className'].indexOf('dropdown-menu') > -1) {
            /** @type {?} */
            var dropdowns = dpParentEl.querySelectorAll('[fDropdown]');
            if (dropdowns && dropdowns.length > 1) {
                for (var k = 0; k < dropdowns.length; k++) {
                    if (dropdowns[k].className.indexOf('show')) {
                        // 触发事件试试
                        this.compatibleDispatchEvent(dropdowns[k], 'selfClose');
                        // dropdowns[k].dispatchEvent(new Event('selfClose'));
                    }
                }
            }
        }
    };
    /**
     * @private
     * @param {?} eventEl
     * @param {?} eventName
     * @return {?}
     */
    FDropdownDirective.prototype.compatibleDispatchEvent = /**
     * @private
     * @param {?} eventEl
     * @param {?} eventName
     * @return {?}
     */
    function (eventEl, eventName) {
        /** @type {?} */
        var event;
        if (typeof Event === "function") {
            event = new Event(eventName);
        }
        else {
            event = document.createEvent("Event");
            event.initEvent(eventName, false, false);
        }
        eventEl.dispatchEvent(event);
    };
    /**
     * @private
     * @param {?} position
     * @return {?}
     */
    FDropdownDirective.prototype._getClsName = /**
     * @private
     * @param {?} position
     * @return {?}
     */
    function (position) {
        /** @type {?} */
        var className = '';
        switch (position) {
            case 'top-right':
            case 'top':
                // 朝上，朝上-朝右
                className = 'dropup';
                break;
            case 'top-left':
                // 朝上-朝左
                className = 'dropup-left';
                break;
            case 'left-bottom':
            case 'left':
                // 横向——朝左——朝下
                className = 'dropleft';
                break;
            case 'left-top':
                // 横向——朝左——朝上
                className = 'dropleft-up';
                break;
            case 'right-bottom':
            case 'right':
                // 横向——朝右——朝下
                className = 'dropright';
                break;
            case 'right-top':
                // 横向——朝右——朝上
                className = 'dropright-up';
                break;
            case 'bottom-left':
                // 朝下——朝左
                className = 'dropdown-left';
                break;
            case 'bottom-right':
                className = 'dropdown';
                break;
            default:
                // 朝下，朝下——朝右
                className = 'dropdown';
        }
        return className;
    };
    /**
     * @private
     * @param {?} event
     * @return {?}
     */
    FDropdownDirective.prototype.isEventFromToggle = /**
     * @private
     * @param {?} event
     * @return {?}
     */
    function (event) {
        /** @type {?} */
        var result = this.toggleElement && this.toggleElement.contains(event.target);
        return result;
    };
    /**
     * @return {?}
     */
    FDropdownDirective.prototype.getRectifyReferenceEl = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var resultWidth = window.innerWidth;
        /** @type {?} */
        var resultHeight = window.innerHeight;
        // 横向计算
        if (this.rectifyReference) {
            resultWidth = this.rectifyReference.getBoundingClientRect().right;
        }
        // 纵向计算
        if (this.rectifyReferenceV) {
            resultWidth = this.rectifyReference.getBoundingClientRect().bottom;
        }
        return { width: resultWidth, height: resultHeight };
    };
    /**
     * @param {?} menuEl
     * @return {?}
     */
    FDropdownDirective.prototype.appendMenuEl = /**
     * @param {?} menuEl
     * @return {?}
     */
    function (menuEl) {
        /** @type {?} */
        var m = this.menuEls.get(menuEl) || [];
        m.push(menuEl);
        this.menuEls.set(this._seflEl, m);
    };
    FDropdownDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[fDropdown]',
                    exportAs: 'fDropdown'
                },] }
    ];
    /** @nocollapse */
    FDropdownDirective.ctorParameters = function () { return [
        { type: ElementRef },
        { type: Renderer2 }
    ]; };
    FDropdownDirective.propDecorators = {
        rectifyReference: [{ type: Input }],
        rectifyReferenceV: [{ type: Input }],
        autoRectify: [{ type: Input }],
        forceState: [{ type: Input, args: ['forceState',] }],
        openState: [{ type: Input, args: ['open',] }],
        dpChangeEvent: [{ type: Output }],
        isSubDP: [{ type: Input }],
        placement: [{ type: Input, args: ['placement',] }],
        submenuCls: [{ type: HostBinding, args: ['class.dropdown-submenu',] }],
        dropdownCls: [{ type: HostBinding, args: ['class.dropdown',] }]
    };
    return FDropdownDirective;
}());
export { FDropdownDirective };
if (false) {
    /** @type {?} */
    FDropdownDirective.prototype.toggleElement;
    /** @type {?} */
    FDropdownDirective.prototype.documentClickEventListener;
    /** @type {?} */
    FDropdownDirective.prototype.selfDefineEventListener;
    /**
     * @type {?}
     * @private
     */
    FDropdownDirective.prototype._seflEl;
    /**
     * @type {?}
     * @private
     */
    FDropdownDirective.prototype._internalOpen;
    /**
     * @type {?}
     * @private
     */
    FDropdownDirective.prototype._calculateMenu;
    /** @type {?} */
    FDropdownDirective.prototype.rectifyReference;
    /** @type {?} */
    FDropdownDirective.prototype.rectifyReferenceV;
    /** @type {?} */
    FDropdownDirective.prototype.autoRectify;
    /** @type {?} */
    FDropdownDirective.prototype.dpChangeEvent;
    /**
     * @type {?}
     * @private
     */
    FDropdownDirective.prototype._placement;
    /** @type {?} */
    FDropdownDirective.prototype.isSubDP;
    /**
     * @type {?}
     * @private
     */
    FDropdownDirective.prototype.isOpenState;
    /**
     * @type {?}
     * @private
     */
    FDropdownDirective.prototype.ngZone;
    /**
     * @type {?}
     * @private
     */
    FDropdownDirective.prototype.menuEls;
    /**
     * @type {?}
     * @private
     */
    FDropdownDirective.prototype.elementRef;
    /**
     * @type {?}
     * @private
     */
    FDropdownDirective.prototype.render;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZi1kcm9wZG93bi5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRyb3Bkb3duLyIsInNvdXJjZXMiOlsibGliL2YtZHJvcGRvd24uZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQ0gsU0FBUyxFQUNULEtBQUssRUFDTCxNQUFNLEVBQ04sV0FBVyxFQUNYLFlBQVksRUFDWixVQUFVLEVBQ1YsU0FBUyxFQUdaLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0M7SUE2RUksNEJBQ1ksVUFBc0IsRUFDdEIsTUFBaUI7UUFGN0IsaUJBZUM7UUFkVyxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLFdBQU0sR0FBTixNQUFNLENBQVc7O1FBckVyQixrQkFBYSxHQUFHLEtBQUssQ0FBQzs7UUFFdEIsbUJBQWMsR0FBRyxLQUFLLENBQUM7O1FBTXRCLGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBZW5CLGtCQUFhLEdBQUcsSUFBSSxZQUFZLEVBQVcsQ0FBQztRQUM5QyxlQUFVLEdBQUcsUUFBUSxDQUFDLENBQUMsY0FBYzs7UUFFcEMsWUFBTyxHQUFHLEtBQUssQ0FBQyxDQUFDLFNBQVM7UUEwQjNCLGdCQUFXLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQWE1QixZQUFPLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQU01QixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDO1FBQzdDLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUzs7OztRQUFDLFVBQUMsS0FBYztZQUN0QyxJQUFJLEtBQUksQ0FBQyxhQUFhLEtBQUssS0FBSyxFQUFFO2dCQUM5QixLQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztnQkFDM0IsSUFBSSxLQUFJLENBQUMsYUFBYSxFQUFFO29CQUNwQixLQUFJLENBQUMsTUFB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QUMsd0JBQXdCOzhCQUlwQyxXQUFXLFNBQUMsZ0JBQWdCOztJQXVOakMseUJBQUM7Q0FBQSxBQTVSRCxJQTRSQztTQXhSWSxrQkFBa0I7OztJQUMzQiwyQ0FBbUI7O0lBQ25CLHdEQUFnQzs7SUFDaEMscURBQTZCOzs7OztJQUM3QixxQ0FBNkI7Ozs7O0lBRTdCLDJDQUE4Qjs7Ozs7SUFFOUIsNENBQStCOztJQUUvQiw4Q0FBMEI7O0lBRTFCLCtDQUEyQjs7SUFFM0IseUNBQTZCOztJQWU3QiwyQ0FBc0Q7Ozs7O0lBQ3RELHdDQUE4Qjs7SUFFOUIscUNBQXlCOzs7OztJQTBCekIseUNBQW9DOzs7OztJQVdwQyxvQ0FBZTs7Ozs7SUFFZixxQ0FBZ0M7Ozs7O0lBRzVCLHdDQUE4Qjs7Ozs7SUFDOUIsb0NBQXlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICAgIERpcmVjdGl2ZSxcclxuICAgIElucHV0LFxyXG4gICAgT3V0cHV0LFxyXG4gICAgSG9zdEJpbmRpbmcsXHJcbiAgICBFdmVudEVtaXR0ZXIsXHJcbiAgICBFbGVtZW50UmVmLFxyXG4gICAgUmVuZGVyZXIyLFxyXG4gICAgT25EZXN0cm95LFxyXG4gICAgT25Jbml0XHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogJ1tmRHJvcGRvd25dJyxcclxuICAgIGV4cG9ydEFzOiAnZkRyb3Bkb3duJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgRkRyb3Bkb3duRGlyZWN0aXZlIGltcGxlbWVudHMgT25EZXN0cm95LCBPbkluaXQge1xyXG4gICAgdG9nZ2xlRWxlbWVudDogYW55O1xyXG4gICAgZG9jdW1lbnRDbGlja0V2ZW50TGlzdGVuZXI6IGFueTtcclxuICAgIHNlbGZEZWZpbmVFdmVudExpc3RlbmVyOiBhbnk7XHJcbiAgICBwcml2YXRlIF9zZWZsRWw6IEhUTUxFbGVtZW50O1xyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWlucHV0LXJlbmFtZVxyXG4gICAgcHJpdmF0ZSBfaW50ZXJuYWxPcGVuID0gZmFsc2U7XHJcbiAgICAvLyDorqHnrpflrr3luqZcclxuICAgIHByaXZhdGUgX2NhbGN1bGF0ZU1lbnUgPSBmYWxzZTtcclxuICAgIC8vIOe6oOato+S9jee9rueahOWPgueFpyDmnIl3aW5kb3flkoxwYXJlbnTkuKTkuKrlgLxcclxuICAgIEBJbnB1dCgpIHJlY3RpZnlSZWZlcmVuY2U7XHJcbiAgICAvLyDnuqDmraPnurXlkJHkvY3nva7nmoTlj4LnhacgXHJcbiAgICBASW5wdXQoKSByZWN0aWZ5UmVmZXJlbmNlVjtcclxuICAgIC8vIOaYr+WQpuiHquWKqOe6oOato+S9jee9rlxyXG4gICAgQElucHV0KCkgYXV0b1JlY3RpZnkgPSBmYWxzZTtcclxuICAgIC8vIOWcqOWklumdouW8uuWItuaOp+WItuWFs+mXreeKtuaAgVxyXG4gICAgQElucHV0KCdmb3JjZVN0YXRlJylcclxuICAgIHNldCBmb3JjZVN0YXRlKHZhbHVlOiBBcnJheTxib29sZWFuPikge1xyXG5cclxuICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgQElucHV0KCdvcGVuJylcclxuICAgIHNldCBvcGVuU3RhdGUodmFsdWU6IGJvb2xlYW4pIHtcclxuICAgICAgICB0aGlzLl9pbnRlcm5hbE9wZW4gPSB2YWx1ZVswXTtcclxuICAgICAgICB0aGlzLmlzT3BlblN0YXRlLm5leHQodmFsdWVbMF0pO1xyXG4gICAgfVxyXG4gICAgQE91dHB1dCgpIGRwQ2hhbmdlRXZlbnQgPSBuZXcgRXZlbnRFbWl0dGVyPGJvb2xlYW4+KCk7XHJcbiAgICBwcml2YXRlIF9wbGFjZW1lbnQgPSAnYm90dG9tJzsgLy8g6K6w5b2VIHBvc2l0aW9uXHJcblxyXG4gICAgQElucHV0KCkgaXNTdWJEUCA9IGZhbHNlOyAvLyDmmK/lkKbmmK/lrZDkuIvmi4lcclxuXHJcbiAgICBASW5wdXQoJ3BsYWNlbWVudCcpXHJcbiAgICBzZXQgcGxhY2VtZW50KHZhbHVlKSB7XHJcbiAgICAgICAgLy8g5aaC5p6c55u4562JXHJcbiAgICAgICAgaWYgKCF2YWx1ZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vXHJcbiAgICAgICAgaWYgKHZhbHVlICE9PSB0aGlzLl9wbGFjZW1lbnQpIHtcclxuICAgICAgICAgICAgY29uc3QgbmV3Q2xzTmFtZSA9IHRoaXMuX2dldENsc05hbWUodmFsdWUpO1xyXG4gICAgICAgICAgICBjb25zdCBvbGRDbHNOYW1lID0gdGhpcy5fZ2V0Q2xzTmFtZSh0aGlzLl9wbGFjZW1lbnQpO1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlci5yZW1vdmVDbGFzcyh0aGlzLl9zZWZsRWwsIG9sZENsc05hbWUpO1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlci5hZGRDbGFzcyh0aGlzLl9zZWZsRWwsIG5ld0Nsc05hbWUpO1xyXG4gICAgICAgICAgICB0aGlzLl9wbGFjZW1lbnQgPSB2YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBnZXQgcGxhY2VtZW50KCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3BsYWNlbWVudDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBASG9zdEJpbmRpbmcoJ2NsYXNzLnNob3cnKVxyXG4gICAgZ2V0IGlzT3BlbigpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5faW50ZXJuYWxPcGVuO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaXNPcGVuU3RhdGUgPSBuZXcgU3ViamVjdCgpO1xyXG5cclxuXHJcbiAgICBASG9zdEJpbmRpbmcoJ2NsYXNzLmRyb3Bkb3duLXN1Ym1lbnUnKVxyXG4gICAgZ2V0IHN1Ym1lbnVDbHMoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaXNTdWJEUDtcclxuICAgIH1cclxuICAgIEBIb3N0QmluZGluZygnY2xhc3MuZHJvcGRvd24nKVxyXG4gICAgZ2V0IGRyb3Bkb3duQ2xzKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiAhdGhpcy5pc1N1YkRQO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBuZ1pvbmU7XHJcblxyXG4gICAgcHJpdmF0ZSBtZW51RWxzID0gbmV3IFdlYWtNYXAoKTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsXHJcbiAgICAgICAgcHJpdmF0ZSByZW5kZXI6IFJlbmRlcmVyMlxyXG4gICAgKSB7XHJcbiAgICAgICAgdGhpcy5fc2VmbEVsID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgdGhpcy5pc09wZW5TdGF0ZS5zdWJzY3JpYmUoKHN0YXRlOiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9pbnRlcm5hbE9wZW4gIT09IHN0YXRlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9pbnRlcm5hbE9wZW4gPSBzdGF0ZTtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pbnRlcm5hbE9wZW4pIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlci5hZGRDbGFzcyh0aGlzLl9zZWZsRWwsICdzaG93Jyk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyLnJlbW92ZUNsYXNzKHRoaXMuX3NlZmxFbCwgJ3Nob3cnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgbmdPbkluaXQoKSB7XHJcbiAgICB9XHJcbiAgICBnZXROYXRpdmVFbGVtZW50KCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9zZWZsRWw7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGJpbmREb2N1bWVudEV2ZW50cygpIHtcclxuICAgICAgICAvLyAgIHRoaXMubmd6b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuICAgICAgICB0aGlzLmRvY3VtZW50Q2xpY2tFdmVudExpc3RlbmVyID0gdGhpcy5vbkRvY3VtZW50Q2xpY2suYmluZCh0aGlzKTtcclxuICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMuZG9jdW1lbnRDbGlja0V2ZW50TGlzdGVuZXIpO1xyXG4gICAgICAgIC8vIOe7keWumuiiq+aTjeS9nG5hdGl2ZeaXtuinpuWPkVxyXG4gICAgICAgIHRoaXMuc2VsZkRlZmluZUV2ZW50TGlzdGVuZXIgPSB0aGlzLm9uU2VsZkRlZmluZUhhbmRsZXIuYmluZCh0aGlzKTtcclxuICAgICAgICB0aGlzLl9zZWZsRWwuYWRkRXZlbnRMaXN0ZW5lcignc2VsZkNsb3NlJywgdGhpcy5zZWxmRGVmaW5lRXZlbnRMaXN0ZW5lcik7XHJcbiAgICAgICAgLy8gfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBvblNlbGZEZWZpbmVIYW5kbGVyKCkge1xyXG4gICAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgdW5iaW5kRG9jdW1lbnRFdmVudHMoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZG9jdW1lbnRDbGlja0V2ZW50TGlzdGVuZXIpIHtcclxuICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcclxuICAgICAgICAgICAgICAgICdjbGljaycsXHJcbiAgICAgICAgICAgICAgICB0aGlzLmRvY3VtZW50Q2xpY2tFdmVudExpc3RlbmVyXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIHRoaXMuZG9jdW1lbnRDbGlja0V2ZW50TGlzdGVuZXIgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5zZWxmRGVmaW5lRXZlbnRMaXN0ZW5lcikge1xyXG4gICAgICAgICAgICB0aGlzLl9zZWZsRWwucmVtb3ZlRXZlbnRMaXN0ZW5lcihcclxuICAgICAgICAgICAgICAgICdzZWxmQ2xvc2UnLFxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZWxmRGVmaW5lRXZlbnRMaXN0ZW5lclxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB0aGlzLnNlbGZEZWZpbmVFdmVudExpc3RlbmVyID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIG9uRG9jdW1lbnRDbGljayhldmVudDogTW91c2VFdmVudCkge1xyXG4gICAgICAgIC8vIOWmguaenOW3sue7j+WFs+mXre+8jOS4jemcgOimgeWGjeWTjeW6lFxyXG4gICAgICAgIGlmICghdGhpcy5faW50ZXJuYWxPcGVuKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGV2ZW50LmJ1dHRvbiAhPT0gMiAmJiAhdGhpcy5pc0V2ZW50RnJvbVRvZ2dsZShldmVudCkpIHtcclxuICAgICAgICAgICAgdGhpcy5jbG9zZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyDliKTmlq1tZW515bGV5byA5pe25piv5ZCm6KaB6K6h566XXHJcbiAgICBuZWVkVG9DYWxjdWxhdGUoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXV0b1JlY3RpZnkgJiYgdGhpcy5fY2FsY3VsYXRlTWVudTtcclxuICAgIH1cclxuICAgIHJlc2V0Q2FsY3VsYXRlKHZhbHVlKSB7XHJcbiAgICAgICAgdGhpcy5fY2FsY3VsYXRlTWVudSA9IHZhbHVlO1xyXG4gICAgfVxyXG4gICAgb3BlbigpIHtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLl9pbnRlcm5hbE9wZW4pIHtcclxuICAgICAgICAgICAgdGhpcy5jbG9zZVNpYmxpbmdEcm9wZG93bnMoKTtcclxuICAgICAgICAgICAgdGhpcy5fY2FsY3VsYXRlTWVudSA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLmFkZENsYXNzKHRoaXMuX3NlZmxFbCwgJ3Nob3cnKTtcclxuICAgICAgICAgICAgdGhpcy5pc09wZW5TdGF0ZS5uZXh0KHRydWUpO1xyXG4gICAgICAgICAgICB0aGlzLmRwQ2hhbmdlRXZlbnQuZW1pdCh0cnVlKTtcclxuICAgICAgICAgICAgLy8g5omn6KGM57uR5a6a5LqL5Lu2XHJcbiAgICAgICAgICAgIHRoaXMuYmluZERvY3VtZW50RXZlbnRzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNsb3NlKGVtaXQgPSB0cnVlKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX2ludGVybmFsT3Blbikge1xyXG4gICAgICAgICAgICB0aGlzLl9jYWxjdWxhdGVNZW51ID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLnJlbW92ZUNsYXNzKHRoaXMuX3NlZmxFbCwgJ3Nob3cnKTtcclxuICAgICAgICAgICAgaWYgKGVtaXQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaXNPcGVuU3RhdGUubmV4dChmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRwQ2hhbmdlRXZlbnQuZW1pdChmYWxzZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy51bmJpbmREb2N1bWVudEV2ZW50cygpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB0b2dnbGUoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX2ludGVybmFsT3Blbikge1xyXG4gICAgICAgICAgICB0aGlzLmNsb3NlKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5vcGVuKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZ2V0T3BlblN0YXRlKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmlzT3BlblN0YXRlO1xyXG4gICAgfVxyXG4gICAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICAgICAgdGhpcy5pc09wZW5TdGF0ZS51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgIHRoaXMudW5iaW5kRG9jdW1lbnRFdmVudHMoKTtcclxuXHJcbiAgICAgICAgY29uc3QgbWVudWVscyA9IHRoaXMubWVudUVscy5nZXQodGhpcy5fc2VmbEVsKTtcclxuICAgICAgICBpZiAobWVudWVscyAmJiBtZW51ZWxzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBtZW51ZWxzLmZvckVhY2goZWxlbWVudCA9PiB7XHJcbiAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGNsb3NlU2libGluZ0Ryb3Bkb3ducygpIHtcclxuICAgICAgICBsZXQgZHBQYXJlbnRFbCA9IHRoaXMuX3NlZmxFbC5wYXJlbnROb2RlO1xyXG4gICAgICAgIGlmIChkcFBhcmVudEVsICYmIGRwUGFyZW50RWxbJ2NsYXNzTmFtZSddLmluZGV4T2YoJ2Ryb3Bkb3duLW1lbnUnKSA+IC0xKSB7XHJcbiAgICAgICAgICAgIGxldCBkcm9wZG93bnMgPSBkcFBhcmVudEVsLnF1ZXJ5U2VsZWN0b3JBbGwoJ1tmRHJvcGRvd25dJyk7XHJcbiAgICAgICAgICAgIGlmIChkcm9wZG93bnMgJiYgZHJvcGRvd25zLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgZHJvcGRvd25zLmxlbmd0aDsgaysrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRyb3Bkb3duc1trXS5jbGFzc05hbWUuaW5kZXhPZignc2hvdycpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOinpuWPkeS6i+S7tuivleivlVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBhdGlibGVEaXNwYXRjaEV2ZW50KGRyb3Bkb3duc1trXSwgJ3NlbGZDbG9zZScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBkcm9wZG93bnNba10uZGlzcGF0Y2hFdmVudChuZXcgRXZlbnQoJ3NlbGZDbG9zZScpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGNvbXBhdGlibGVEaXNwYXRjaEV2ZW50KGV2ZW50RWwsIGV2ZW50TmFtZSkge1xyXG4gICAgICAgIHZhciBldmVudDtcclxuICAgICAgICBpZiAodHlwZW9mIEV2ZW50ID09PSBcImZ1bmN0aW9uXCIpIHtcclxuICAgICAgICAgICAgZXZlbnQgPSBuZXcgRXZlbnQoZXZlbnROYW1lKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KFwiRXZlbnRcIik7XHJcbiAgICAgICAgICAgIGV2ZW50LmluaXRFdmVudChldmVudE5hbWUsIGZhbHNlLCBmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGV2ZW50RWwuZGlzcGF0Y2hFdmVudChldmVudCk7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIF9nZXRDbHNOYW1lKHBvc2l0aW9uOiBzdHJpbmcpIHtcclxuICAgICAgICBsZXQgY2xhc3NOYW1lID0gJyc7XHJcbiAgICAgICAgc3dpdGNoIChwb3NpdGlvbikge1xyXG4gICAgICAgICAgICBjYXNlICd0b3AtcmlnaHQnOlxyXG4gICAgICAgICAgICBjYXNlICd0b3AnOlxyXG4gICAgICAgICAgICAgICAgLy8g5pyd5LiK77yM5pyd5LiKLeacneWPs1xyXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gJ2Ryb3B1cCc7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAndG9wLWxlZnQnOlxyXG4gICAgICAgICAgICAgICAgLy8g5pyd5LiKLeacneW3plxyXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gJ2Ryb3B1cC1sZWZ0JztcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdsZWZ0LWJvdHRvbSc6XHJcbiAgICAgICAgICAgIGNhc2UgJ2xlZnQnOlxyXG4gICAgICAgICAgICAgICAgLy8g5qiq5ZCR4oCU4oCU5pyd5bem4oCU4oCU5pyd5LiLXHJcbiAgICAgICAgICAgICAgICBjbGFzc05hbWUgPSAnZHJvcGxlZnQnO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2xlZnQtdG9wJzpcclxuICAgICAgICAgICAgICAgIC8vIOaoquWQkeKAlOKAlOacneW3puKAlOKAlOacneS4ilxyXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gJ2Ryb3BsZWZ0LXVwJztcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdyaWdodC1ib3R0b20nOlxyXG4gICAgICAgICAgICBjYXNlICdyaWdodCc6XHJcbiAgICAgICAgICAgICAgICAvLyDmqKrlkJHigJTigJTmnJ3lj7PigJTigJTmnJ3kuItcclxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA9ICdkcm9wcmlnaHQnO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ3JpZ2h0LXRvcCc6XHJcbiAgICAgICAgICAgICAgICAvLyDmqKrlkJHigJTigJTmnJ3lj7PigJTigJTmnJ3kuIpcclxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA9ICdkcm9wcmlnaHQtdXAnO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2JvdHRvbS1sZWZ0JzpcclxuICAgICAgICAgICAgICAgIC8vIOacneS4i+KAlOKAlOacneW3plxyXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gJ2Ryb3Bkb3duLWxlZnQnO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2JvdHRvbS1yaWdodCc6XHJcbiAgICAgICAgICAgICAgICBjbGFzc05hbWUgPSAnZHJvcGRvd24nO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAvLyDmnJ3kuIvvvIzmnJ3kuIvigJTigJTmnJ3lj7NcclxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA9ICdkcm9wZG93bic7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBjbGFzc05hbWU7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGlzRXZlbnRGcm9tVG9nZ2xlKGV2ZW50OiBNb3VzZUV2ZW50KSB7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID1cclxuICAgICAgICAgICAgdGhpcy50b2dnbGVFbGVtZW50ICYmIHRoaXMudG9nZ2xlRWxlbWVudC5jb250YWlucyhldmVudC50YXJnZXQpO1xyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UmVjdGlmeVJlZmVyZW5jZUVsKCkge1xyXG4gICAgICAgIFxyXG4gICAgICAgIHZhciByZXN1bHRXaWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoLCByZXN1bHRIZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7XHJcbiAgICAgICAgLy8g5qiq5ZCR6K6h566XXHJcbiAgICAgICAgaWYgKHRoaXMucmVjdGlmeVJlZmVyZW5jZSkge1xyXG4gICAgICAgICAgICByZXN1bHRXaWR0aCA9IHRoaXMucmVjdGlmeVJlZmVyZW5jZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5yaWdodDtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g57q15ZCR6K6h566XXHJcbiAgICAgICAgaWYgKHRoaXMucmVjdGlmeVJlZmVyZW5jZVYpIHtcclxuICAgICAgICAgICAgcmVzdWx0V2lkdGggPSB0aGlzLnJlY3RpZnlSZWZlcmVuY2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4geyB3aWR0aDogcmVzdWx0V2lkdGgsIGhlaWdodDogcmVzdWx0SGVpZ2h0IH07XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGFwcGVuZE1lbnVFbChtZW51RWw6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IG0gPSB0aGlzLm1lbnVFbHMuZ2V0KG1lbnVFbCkgfHwgW107XHJcbiAgICAgICAgbS5wdXNoKG1lbnVFbClcclxuICAgICAgICB0aGlzLm1lbnVFbHMuc2V0KHRoaXMuX3NlZmxFbCwgbSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8vIGV4cG9ydCBlbnVtIEZEcm9wZG93blBsYWNlbWVudHtcclxuLy8gICBcInRvcFwiLCBcInRvcC1sZWZ0XCIsIFwidG9wLXJpZ2h0XCIsIFwiYm90dG9tXCIsIFwiYm90dG9tLWxlZnRcIiwgXCJib3R0b20tcmlnaHRcIixcclxuLy8gICAqICAgIFwibGVmdFwiLCBcImxlZnQtdG9wXCIsIFwibGVmdC1ib3R0b21cIiwgXCJyaWdodFwiLCBcInJpZ2h0LXRvcFwiLCBcInJpZ2h0LWJvdHRvbVwiXHJcbi8vIH1cclxuIl19