/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { LocaleService } from '@farris/ui-locale';
import { Injectable, ApplicationRef, ComponentFactoryResolver, Injector, ElementRef } from '@angular/core';
import { LOADING_DEFAULT_CONFIG, loaddingDefaultConfig } from './loading.config';
import { LoadingComponent } from './loading.component';
import { max } from 'lodash-es';
var LoadingService = /** @class */ (function () {
    function LoadingService(appRef, cfr, injecotr) {
        this.appRef = appRef;
        this.cfr = cfr;
        this.injecotr = injecotr;
        this.currentLoadingInstanceID = null;
        this.loadingInstances = {};
        this.localeSer = this.injecotr.get(LocaleService);
    }
    /**
     * @param {?=} config
     * @return {?}
     */
    LoadingService.prototype.show = /**
     * @param {?=} config
     * @return {?}
     */
    function (config) {
        var _this = this;
        this.config = this.injecotr.get(LOADING_DEFAULT_CONFIG) || {};
        this.config = Object.assign(loaddingDefaultConfig, this.config);
        /** @type {?} */
        var _loadingCmpRef;
        /** @type {?} */
        var loadingFactory = this.cfr.resolveComponentFactory(LoadingComponent);
        _loadingCmpRef = loadingFactory.create(this.injecotr);
        if (config) {
            this.config = Object.assign({}, this.config, config);
        }
        // const languageCode = localStorage.getItem('languageCode');
        // if (languageCode === 'en') {
        //     this.config.message = 'Loading...';
        // }
        if (this.localeSer) {
            if (!this.config.message || this.config.message === '正在加载中，请稍候...') {
                this.config.message = this.localeSer.getValue('loading.message');
            }
        }
        /** @type {?} */
        var container = this.config.container;
        /** @type {?} */
        var parentContainer = null;
        if (container === 'body') {
            document.querySelector((/** @type {?} */ (container))).appendChild(_loadingCmpRef.location.nativeElement);
        }
        else {
            if (container instanceof ElementRef) {
                container.nativeElement.appendChild(_loadingCmpRef.location.nativeElement);
                parentContainer = container.nativeElement;
            }
            else {
                if (container instanceof Element) {
                    container.appendChild(_loadingCmpRef.location.nativeElement);
                    parentContainer = container;
                }
            }
        }
        _loadingCmpRef.instance.delay = this.config.delay;
        _loadingCmpRef.instance.isActive = true;
        _loadingCmpRef.instance.parentContainer = parentContainer;
        Object.assign(_loadingCmpRef.instance, this.config);
        _loadingCmpRef.instance.closed.subscribe((/**
         * @param {?} state
         * @return {?}
         */
        function (state) {
            if (!state) {
                delete _this.loadingInstances[_loadingCmpRef.instance.id];
                _this.currentLoadingInstanceID = _this.getMaxLoadingID();
                _this.clearDom(_loadingCmpRef);
            }
        }));
        _loadingCmpRef.changeDetectorRef.markForCheck();
        _loadingCmpRef.changeDetectorRef.detectChanges();
        /** @type {?} */
        var loadingID = this.createInsId();
        _loadingCmpRef.instance.id = loadingID;
        this.loadingInstances[loadingID] = _loadingCmpRef;
        this.currentLoadingInstanceID = loadingID;
        return _loadingCmpRef.instance;
    };
    /**
     * @param {?=} loadingId
     * @return {?}
     */
    LoadingService.prototype.close = /**
     * @param {?=} loadingId
     * @return {?}
     */
    function (loadingId) {
        /** @type {?} */
        var id = loadingId || this.currentLoadingInstanceID;
        /** @type {?} */
        var loadingRef = this.loadingInstances[id];
        if (loadingRef) {
            loadingRef.instance.close();
        }
    };
    /**
     * @return {?}
     */
    LoadingService.prototype.clearAll = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var keys = Object.keys(this.loadingInstances);
        if (keys.length) {
            keys.forEach((/**
             * @param {?} id
             * @return {?}
             */
            function (id) {
                _this.clearDom(_this.loadingInstances[id]);
            }));
        }
        else {
            /** @type {?} */
            var loadings = document.querySelectorAll('farris-loading');
            if (loadings.length) {
                loadings.forEach((/**
                 * @param {?} el
                 * @return {?}
                 */
                function (el) { return el.remove(); }));
            }
            this.loadingInstances = {};
        }
    };
    /**
     * @private
     * @param {?} _loadingCmpRef
     * @return {?}
     */
    LoadingService.prototype.clearDom = /**
     * @private
     * @param {?} _loadingCmpRef
     * @return {?}
     */
    function (_loadingCmpRef) {
        if (_loadingCmpRef && _loadingCmpRef.location) {
            /** @type {?} */
            var loadingEl = _loadingCmpRef.location.nativeElement;
            if (loadingEl.parentNode) {
                loadingEl.parentNode.removeChild(loadingEl);
            }
            _loadingCmpRef.destroy();
        }
        _loadingCmpRef = null;
    };
    /**
     * @private
     * @return {?}
     */
    LoadingService.prototype.createInsId = /**
     * @private
     * @return {?}
     */
    function () {
        return this.getMaxLoadingID() + 1;
    };
    /**
     * @private
     * @return {?}
     */
    LoadingService.prototype.getMaxLoadingID = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var ids = Object.keys(this.loadingInstances).map((/**
         * @param {?} k
         * @return {?}
         */
        function (k) { return parseInt(k, 10); }));
        if (ids.length) {
            return max(ids);
        }
        return 0;
    };
    LoadingService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    LoadingService.ctorParameters = function () { return [
        { type: ApplicationRef },
        { type: ComponentFactoryResolver },
        { type: Injector }
    ]; };
    return LoadingService;
}());
export { LoadingService };
if (false) {
    /** @type {?} */
    LoadingService.prototype.config;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.currentLoadingInstanceID;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.loadingInstances;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.localeSer;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.appRef;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.cfr;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.injecotr;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGluZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb2FkaW5nLyIsInNvdXJjZXMiOlsibGliL2xvYWRpbmcuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLHdCQUF3QixFQUFFLFFBQVEsRUFBZ0IsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pILE9BQU8sRUFBaUIsc0JBQXNCLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNoRyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRWhDO0lBT0ksd0JBQW9CLE1BQXNCLEVBQ3RCLEdBQTZCLEVBQVUsUUFBa0I7UUFEekQsV0FBTSxHQUFOLE1BQU0sQ0FBZ0I7UUFDdEIsUUFBRyxHQUFILEdBQUcsQ0FBMEI7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBSnJFLDZCQUF3QixHQUFHLElBQUksQ0FBQztRQUNoQyxxQkFBZ0IsR0FBc0QsRUFBRSxDQUFDO1FBSWpFLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDbEUsQ0FBQzs7Ozs7SUFFRCw2QkFBSTs7OztJQUFKLFVBQUssTUFBc0I7UUFBM0IsaUJBZ0VDO1FBL0RHLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDOUQsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLHFCQUFxQixFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQzs7WUFFNUQs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QUMvQztZQUVELGNBQWMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUM1QjtRQUVELGNBQWMsR0FBRyxJQUFJLENBQUM7SUFDMUIsQ0FBQzs7Ozs7SUFFTyxvQ0FBVzs7OztJQUFuQjtRQUNJLE9BQU8sSUFBSSxDQUFDLGVBQWUsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUN0QyxDQUFDOzs7OztJQUVPLHdDQUFlOzs7O0lBQXZCOztZQUNVLEdBQUcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLEdBQUc7Ozs7UUFBQyxVQUFBLENBQUMsSUFBSSxPQUFBLFFBQVEsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQWYsQ0FBZSxFQUFDO1FBQ3hFLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRTtZQUNaLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ25CO1FBRUQsT0FBTyxDQUFDLENBQUM7SUFDYixDQUFDOztnQkEvSEosVUFBVTs7OztnQkFMVSxjQUFjO2dCQUFFLHdCQUF3QjtnQkFBRSxRQUFROztJQXFJdkUscUJBQUM7Q0FBQSxBQWhJRCxJQWdJQztTQS9IWSxjQUFjOzs7SUFDdkIsZ0NBQXNCOzs7OztJQUV0QixrREFBd0M7Ozs7O0lBQ3hDLDBDQUFpRjs7Ozs7SUFDakYsbUNBQWlDOzs7OztJQUNyQixnQ0FBOEI7Ozs7O0lBQzlCLDZCQUFxQzs7Ozs7SUFBRSxrQ0FBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMb2NhbGVTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1sb2NhbGUnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlLCBBcHBsaWNhdGlvblJlZiwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBJbmplY3RvciwgQ29tcG9uZW50UmVmLCBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IExvYWRpbmdDb25maWcsIExPQURJTkdfREVGQVVMVF9DT05GSUcsIGxvYWRkaW5nRGVmYXVsdENvbmZpZyB9IGZyb20gJy4vbG9hZGluZy5jb25maWcnO1xyXG5pbXBvcnQgeyBMb2FkaW5nQ29tcG9uZW50IH0gZnJvbSAnLi9sb2FkaW5nLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IG1heCB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBMb2FkaW5nU2VydmljZSB7XHJcbiAgICBjb25maWc6IExvYWRpbmdDb25maWc7XHJcblxyXG4gICAgcHJpdmF0ZSBjdXJyZW50TG9hZGluZ0luc3RhbmNlSUQgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBsb2FkaW5nSW5zdGFuY2VzOiB7IFtrZXk6IG51bWJlcl06IENvbXBvbmVudFJlZjxMb2FkaW5nQ29tcG9uZW50PiB9ID0ge307XHJcbiAgICBwcml2YXRlIGxvY2FsZVNlcjogTG9jYWxlU2VydmljZTtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYXBwUmVmOiBBcHBsaWNhdGlvblJlZixcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgY2ZyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIHByaXZhdGUgaW5qZWNvdHI6IEluamVjdG9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhbGVTZXIgPSB0aGlzLmluamVjb3RyLmdldChMb2NhbGVTZXJ2aWNlKTtcclxuICAgIH1cclxuXHJcbiAgICBzaG93KGNvbmZpZz86IExvYWRpbmdDb25maWcpOiBMb2FkaW5nQ29tcG9uZW50IHtcclxuICAgICAgICB0aGlzLmNvbmZpZyA9IHRoaXMuaW5qZWNvdHIuZ2V0KExPQURJTkdfREVGQVVMVF9DT05GSUcpIHx8IHt9O1xyXG4gICAgICAgIHRoaXMuY29uZmlnID0gT2JqZWN0LmFzc2lnbihsb2FkZGluZ0RlZmF1bHRDb25maWcsIHRoaXMuY29uZmlnKTtcclxuXHJcbiAgICAgICAgbGV0IF9sb2FkaW5nQ21wUmVmOiBDb21wb25lbnRSZWY8TG9hZGluZ0NvbXBvbmVudD47XHJcbiAgICAgICAgY29uc3QgbG9hZGluZ0ZhY3RvcnkgPSB0aGlzLmNmci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShMb2FkaW5nQ29tcG9uZW50KTtcclxuICAgICAgICBfbG9hZGluZ0NtcFJlZiA9IGxvYWRpbmdGYWN0b3J5LmNyZWF0ZSh0aGlzLmluamVjb3RyKTtcclxuXHJcbiAgICAgICAgaWYgKGNvbmZpZykge1xyXG4gICAgICAgICAgICB0aGlzLmNvbmZpZyA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuY29uZmlnLCBjb25maWcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBjb25zdCBsYW5ndWFnZUNvZGUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnbGFuZ3VhZ2VDb2RlJyk7XHJcbiAgICAgICAgLy8gaWYgKGxhbmd1YWdlQ29kZSA9PT0gJ2VuJykge1xyXG4gICAgICAgIC8vICAgICB0aGlzLmNvbmZpZy5tZXNzYWdlID0gJ0xvYWRpbmcuLi4nO1xyXG4gICAgICAgIC8vIH1cclxuICAgICAgICBpZiAodGhpcy5sb2NhbGVTZXIpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmNvbmZpZy5tZXNzYWdlIHx8IHRoaXMuY29uZmlnLm1lc3NhZ2UgPT09ICfmraPlnKjliqDovb3kuK3vvIzor7fnqI3lgJkuLi4nKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZy5tZXNzYWdlID0gdGhpcy5sb2NhbGVTZXIuZ2V0VmFsdWUoJ2xvYWRpbmcubWVzc2FnZScpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmNvbmZpZy5jb250YWluZXI7XHJcbiAgICAgICAgbGV0IHBhcmVudENvbnRhaW5lciA9IG51bGw7XHJcbiAgICAgICAgaWYgKGNvbnRhaW5lciA9PT0gJ2JvZHknKSB7XHJcbiAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoY29udGFpbmVyIGFzIHN0cmluZykuYXBwZW5kQ2hpbGQoIF9sb2FkaW5nQ21wUmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChjb250YWluZXIgaW5zdGFuY2VvZiBFbGVtZW50UmVmICkge1xyXG4gICAgICAgICAgICAgICAgY29udGFpbmVyLm5hdGl2ZUVsZW1lbnQuYXBwZW5kQ2hpbGQoXHJcbiAgICAgICAgICAgICAgICAgICAgX2xvYWRpbmdDbXBSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudFxyXG4gICAgICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgICAgICBwYXJlbnRDb250YWluZXIgPSBjb250YWluZXIubmF0aXZlRWxlbWVudDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChjb250YWluZXIgaW5zdGFuY2VvZiBFbGVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBfbG9hZGluZ0NtcFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50XHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcGFyZW50Q29udGFpbmVyID0gY29udGFpbmVyO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIF9sb2FkaW5nQ21wUmVmLmluc3RhbmNlLmRlbGF5ID0gdGhpcy5jb25maWcuZGVsYXk7XHJcbiAgICAgICAgX2xvYWRpbmdDbXBSZWYuaW5zdGFuY2UuaXNBY3RpdmUgPSB0cnVlO1xyXG4gICAgICAgIF9sb2FkaW5nQ21wUmVmLmluc3RhbmNlLnBhcmVudENvbnRhaW5lciA9IHBhcmVudENvbnRhaW5lcjtcclxuICAgICAgICBPYmplY3QuYXNzaWduKF9sb2FkaW5nQ21wUmVmLmluc3RhbmNlLCB0aGlzLmNvbmZpZyk7XHJcblxyXG4gICAgICAgIF9sb2FkaW5nQ21wUmVmLmluc3RhbmNlLmNsb3NlZC5zdWJzY3JpYmUoc3RhdGUgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIXN0YXRlKSB7XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5sb2FkaW5nSW5zdGFuY2VzW19sb2FkaW5nQ21wUmVmLmluc3RhbmNlLmlkXTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudExvYWRpbmdJbnN0YW5jZUlEID0gdGhpcy5nZXRNYXhMb2FkaW5nSUQoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJEb20oX2xvYWRpbmdDbXBSZWYpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIF9sb2FkaW5nQ21wUmVmLmNoYW5nZURldGVjdG9yUmVmLm1hcmtGb3JDaGVjaygpO1xyXG4gICAgICAgIF9sb2FkaW5nQ21wUmVmLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcclxuXHJcbiAgICAgICAgY29uc3QgbG9hZGluZ0lEID0gdGhpcy5jcmVhdGVJbnNJZCgpO1xyXG4gICAgICAgIF9sb2FkaW5nQ21wUmVmLmluc3RhbmNlLmlkID0gbG9hZGluZ0lEO1xyXG4gICAgICAgIHRoaXMubG9hZGluZ0luc3RhbmNlc1tsb2FkaW5nSURdID0gIF9sb2FkaW5nQ21wUmVmO1xyXG4gICAgICAgIHRoaXMuY3VycmVudExvYWRpbmdJbnN0YW5jZUlEID0gbG9hZGluZ0lEO1xyXG5cclxuICAgICAgICByZXR1cm4gX2xvYWRpbmdDbXBSZWYuaW5zdGFuY2U7XHJcbiAgICB9XHJcblxyXG4gICAgY2xvc2UobG9hZGluZ0lkPzogbnVtYmVyKSB7XHJcbiAgICAgICAgY29uc3QgaWQgPSBsb2FkaW5nSWQgfHwgdGhpcy5jdXJyZW50TG9hZGluZ0luc3RhbmNlSUQ7XHJcbiAgICAgICAgY29uc3QgbG9hZGluZ1JlZiA9IHRoaXMubG9hZGluZ0luc3RhbmNlc1tpZF07XHJcbiAgICAgICAgaWYgKGxvYWRpbmdSZWYpIHtcclxuICAgICAgICAgICAgbG9hZGluZ1JlZi5pbnN0YW5jZS5jbG9zZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjbGVhckFsbCgpIHtcclxuICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXModGhpcy5sb2FkaW5nSW5zdGFuY2VzKTtcclxuICAgICAgICBpZiAoa2V5cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAga2V5cy5mb3JFYWNoKGlkID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJEb20odGhpcy5sb2FkaW5nSW5zdGFuY2VzW2lkXSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGxvYWRpbmdzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnZmFycmlzLWxvYWRpbmcnKTtcclxuICAgICAgICAgICAgaWYgKGxvYWRpbmdzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgbG9hZGluZ3MuZm9yRWFjaCggZWwgPT4gZWwucmVtb3ZlKCkgKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5sb2FkaW5nSW5zdGFuY2VzID0ge307XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2xlYXJEb20oX2xvYWRpbmdDbXBSZWY6IENvbXBvbmVudFJlZjxMb2FkaW5nQ29tcG9uZW50Pikge1xyXG4gICAgICAgIGlmIChfbG9hZGluZ0NtcFJlZiAmJiBfbG9hZGluZ0NtcFJlZi5sb2NhdGlvbikge1xyXG4gICAgICAgICAgICBjb25zdCBsb2FkaW5nRWwgPSBfbG9hZGluZ0NtcFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50O1xyXG5cclxuICAgICAgICAgICAgaWYgKGxvYWRpbmdFbC5wYXJlbnROb2RlKSB7XHJcbiAgICAgICAgICAgICAgICBsb2FkaW5nRWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChsb2FkaW5nRWwpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBfbG9hZGluZ0NtcFJlZi5kZXN0cm95KCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBfbG9hZGluZ0NtcFJlZiA9IG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjcmVhdGVJbnNJZCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRNYXhMb2FkaW5nSUQoKSArIDE7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRNYXhMb2FkaW5nSUQoKSB7XHJcbiAgICAgICAgY29uc3QgaWRzID0gT2JqZWN0LmtleXModGhpcy5sb2FkaW5nSW5zdGFuY2VzKS5tYXAoayA9PiBwYXJzZUludChrLCAxMCkpO1xyXG4gICAgICAgIGlmIChpZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBtYXgoaWRzKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiAwO1xyXG4gICAgfVxyXG59XHJcblxyXG4iXX0=