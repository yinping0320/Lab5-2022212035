/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { LocaleService } from '@farris/ui-locale';
import { Injectable, ApplicationRef, ComponentFactoryResolver, Injector, ElementRef } from '@angular/core';
import { LOADING_DEFAULT_CONFIG, loaddingDefaultConfig } from './loading.config';
import { LoadingComponent } from './loading.component';
import { max } from 'lodash-es';
export class LoadingService {
    /**
     * @param {?} appRef
     * @param {?} cfr
     * @param {?} injecotr
     */
    constructor(appRef, cfr, injecotr) {
        this.appRef = appRef;
        this.cfr = cfr;
        this.injecotr = injecotr;
        this.currentLoadingInstanceID = null;
        this.loadingInstances = {};
        this.localeSer = this.injecotr.get(LocaleService);
    }
    /**
     * @param {?=} config
     * @return {?}
     */
    show(config) {
        this.config = this.injecotr.get(LOADING_DEFAULT_CONFIG) || {};
        this.config = Object.assign(loaddingDefaultConfig, this.config);
        /** @type {?} */
        let _loadingCmpRef;
        /** @type {?} */
        const loadingFactory = this.cfr.resolveComponentFactory(LoadingComponent);
        _loadingCmpRef = loadingFactory.create(this.injecotr);
        if (config) {
            this.config = Object.assign({}, this.config, config);
        }
        // const languageCode = localStorage.getItem('languageCode');
        // if (languageCode === 'en') {
        //     this.config.message = 'Loading...';
        // }
        if (this.localeSer) {
            if (!this.config.message || this.config.message === '正在加载中，请稍候...') {
                this.config.message = this.localeSer.getValue('loading.message');
            }
        }
        /** @type {?} */
        const container = this.config.container;
        /** @type {?} */
        let parentContainer = null;
        if (container === 'body') {
            document.querySelector((/** @type {?} */ (container))).appendChild(_loadingCmpRef.location.nativeElement);
        }
        else {
            if (container instanceof ElementRef) {
                container.nativeElement.appendChild(_loadingCmpRef.location.nativeElement);
                parentContainer = container.nativeElement;
            }
            else {
                if (container instanceof Element) {
                    container.appendChild(_loadingCmpRef.location.nativeElement);
                    parentContainer = container;
                }
            }
        }
        _loadingCmpRef.instance.delay = this.config.delay;
        _loadingCmpRef.instance.isActive = true;
        _loadingCmpRef.instance.parentContainer = parentContainer;
        Object.assign(_loadingCmpRef.instance, this.config);
        _loadingCmpRef.instance.closed.subscribe((/**
         * @param {?} state
         * @return {?}
         */
        state => {
            if (!state) {
                delete this.loadingInstances[_loadingCmpRef.instance.id];
                this.currentLoadingInstanceID = this.getMaxLoadingID();
                this.clearDom(_loadingCmpRef);
            }
        }));
        _loadingCmpRef.changeDetectorRef.markForCheck();
        _loadingCmpRef.changeDetectorRef.detectChanges();
        /** @type {?} */
        const loadingID = this.createInsId();
        _loadingCmpRef.instance.id = loadingID;
        this.loadingInstances[loadingID] = _loadingCmpRef;
        this.currentLoadingInstanceID = loadingID;
        return _loadingCmpRef.instance;
    }
    /**
     * @param {?=} loadingId
     * @return {?}
     */
    close(loadingId) {
        /** @type {?} */
        const id = loadingId || this.currentLoadingInstanceID;
        /** @type {?} */
        const loadingRef = this.loadingInstances[id];
        if (loadingRef) {
            loadingRef.instance.close();
        }
    }
    /**
     * @return {?}
     */
    clearAll() {
        /** @type {?} */
        const keys = Object.keys(this.loadingInstances);
        if (keys.length) {
            keys.forEach((/**
             * @param {?} id
             * @return {?}
             */
            id => {
                this.clearDom(this.loadingInstances[id]);
            }));
        }
        else {
            /** @type {?} */
            const loadings = document.querySelectorAll('farris-loading');
            if (loadings.length) {
                loadings.forEach((/**
                 * @param {?} el
                 * @return {?}
                 */
                el => el.remove()));
            }
            this.loadingInstances = {};
        }
    }
    /**
     * @private
     * @param {?} _loadingCmpRef
     * @return {?}
     */
    clearDom(_loadingCmpRef) {
        if (_loadingCmpRef && _loadingCmpRef.location) {
            /** @type {?} */
            const loadingEl = _loadingCmpRef.location.nativeElement;
            if (loadingEl.parentNode) {
                loadingEl.parentNode.removeChild(loadingEl);
            }
            _loadingCmpRef.destroy();
        }
        _loadingCmpRef = null;
    }
    /**
     * @private
     * @return {?}
     */
    createInsId() {
        return this.getMaxLoadingID() + 1;
    }
    /**
     * @private
     * @return {?}
     */
    getMaxLoadingID() {
        /** @type {?} */
        const ids = Object.keys(this.loadingInstances).map((/**
         * @param {?} k
         * @return {?}
         */
        k => parseInt(k, 10)));
        if (ids.length) {
            return max(ids);
        }
        return 0;
    }
}
LoadingService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
LoadingService.ctorParameters = () => [
    { type: ApplicationRef },
    { type: ComponentFactoryResolver },
    { type: Injector }
];
if (false) {
    /** @type {?} */
    LoadingService.prototype.config;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.currentLoadingInstanceID;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.loadingInstances;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.localeSer;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.appRef;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.cfr;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.injecotr;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGluZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb2FkaW5nLyIsInNvdXJjZXMiOlsibGliL2xvYWRpbmcuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLHdCQUF3QixFQUFFLFFBQVEsRUFBZ0IsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pILE9BQU8sRUFBaUIsc0JBQXNCLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNoRyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBR2hDLE1BQU0sT0FBTyxjQUFjOzs7Ozs7SUFNdkIsWUFBb0IsTUFBc0IsRUFDdEIsR0FBNkIsRUFBVSxRQUFrQjtRQUR6RCxXQUFNLEdBQU4sTUFBTSxDQUFnQjtRQUN0QixRQUFHLEdBQUgsR0FBRyxDQUEwQjtRQUFVLGFBQVEsR0FBUixRQUFRLENBQVU7UUFKckUsNkJBQXdCLEdBQUcsSUFBSSxDQUFDO1FBQ2hDLHFCQUFnQixHQUFzRCxFQUFFLENBQUM7UUFJakUsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNsRSxDQUFDOzs7OztJQUVELElBQUksQ0FBQyxNQUFzQjtRQUN2QixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLHNCQUFzQixDQUFDLElBQUksRUFBRSxDQUFDO1FBQzlELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7O1lBRTVELGNB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QUVELGNBQWMsR0FBRyxJQUFJLENBQUM7SUFDMUIsQ0FBQzs7Ozs7SUFFTyxXQUFXO1FBQ2YsT0FBTyxJQUFJLENBQUMsZUFBZSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7Ozs7O0lBRU8sZUFBZTs7Y0FDYixHQUFHLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxHQUFHOzs7O1FBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFDO1FBQ3hFLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRTtZQUNaLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ25CO1FBRUQsT0FBTyxDQUFDLENBQUM7SUFDYixDQUFDOzs7WUEvSEosVUFBVTs7OztZQUxVLGNBQWM7WUFBRSx3QkFBd0I7WUFBRSxRQUFROzs7O0lBT25FLGdDQUFzQjs7Ozs7SUFFdEIsa0RBQXdDOzs7OztJQUN4QywwQ0FBaUY7Ozs7O0lBQ2pGLG1DQUFpQzs7Ozs7SUFDckIsZ0NBQThCOzs7OztJQUM5Qiw2QkFBcUM7Ozs7O0lBQUUsa0NBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTG9jYWxlU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbG9jYWxlJztcclxuaW1wb3J0IHsgSW5qZWN0YWJsZSwgQXBwbGljYXRpb25SZWYsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgSW5qZWN0b3IsIENvbXBvbmVudFJlZiwgRWxlbWVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBMb2FkaW5nQ29uZmlnLCBMT0FESU5HX0RFRkFVTFRfQ09ORklHLCBsb2FkZGluZ0RlZmF1bHRDb25maWcgfSBmcm9tICcuL2xvYWRpbmcuY29uZmlnJztcclxuaW1wb3J0IHsgTG9hZGluZ0NvbXBvbmVudCB9IGZyb20gJy4vbG9hZGluZy5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBtYXggfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgTG9hZGluZ1NlcnZpY2Uge1xyXG4gICAgY29uZmlnOiBMb2FkaW5nQ29uZmlnO1xyXG5cclxuICAgIHByaXZhdGUgY3VycmVudExvYWRpbmdJbnN0YW5jZUlEID0gbnVsbDtcclxuICAgIHByaXZhdGUgbG9hZGluZ0luc3RhbmNlczogeyBba2V5OiBudW1iZXJdOiBDb21wb25lbnRSZWY8TG9hZGluZ0NvbXBvbmVudD4gfSA9IHt9O1xyXG4gICAgcHJpdmF0ZSBsb2NhbGVTZXI6IExvY2FsZVNlcnZpY2U7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcFJlZjogQXBwbGljYXRpb25SZWYsXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIGNmcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBwcml2YXRlIGluamVjb3RyOiBJbmplY3Rvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYWxlU2VyID0gdGhpcy5pbmplY290ci5nZXQoTG9jYWxlU2VydmljZSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2hvdyhjb25maWc/OiBMb2FkaW5nQ29uZmlnKTogTG9hZGluZ0NvbXBvbmVudCB7XHJcbiAgICAgICAgdGhpcy5jb25maWcgPSB0aGlzLmluamVjb3RyLmdldChMT0FESU5HX0RFRkFVTFRfQ09ORklHKSB8fCB7fTtcclxuICAgICAgICB0aGlzLmNvbmZpZyA9IE9iamVjdC5hc3NpZ24obG9hZGRpbmdEZWZhdWx0Q29uZmlnLCB0aGlzLmNvbmZpZyk7XHJcblxyXG4gICAgICAgIGxldCBfbG9hZGluZ0NtcFJlZjogQ29tcG9uZW50UmVmPExvYWRpbmdDb21wb25lbnQ+O1xyXG4gICAgICAgIGNvbnN0IGxvYWRpbmdGYWN0b3J5ID0gdGhpcy5jZnIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoTG9hZGluZ0NvbXBvbmVudCk7XHJcbiAgICAgICAgX2xvYWRpbmdDbXBSZWYgPSBsb2FkaW5nRmFjdG9yeS5jcmVhdGUodGhpcy5pbmplY290cik7XHJcblxyXG4gICAgICAgIGlmIChjb25maWcpIHtcclxuICAgICAgICAgICAgdGhpcy5jb25maWcgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmNvbmZpZywgY29uZmlnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gY29uc3QgbGFuZ3VhZ2VDb2RlID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2xhbmd1YWdlQ29kZScpO1xyXG4gICAgICAgIC8vIGlmIChsYW5ndWFnZUNvZGUgPT09ICdlbicpIHtcclxuICAgICAgICAvLyAgICAgdGhpcy5jb25maWcubWVzc2FnZSA9ICdMb2FkaW5nLi4uJztcclxuICAgICAgICAvLyB9XHJcbiAgICAgICAgaWYgKHRoaXMubG9jYWxlU2VyKSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5jb25maWcubWVzc2FnZSB8fCB0aGlzLmNvbmZpZy5tZXNzYWdlID09PSAn5q2j5Zyo5Yqg6L295Lit77yM6K+356iN5YCZLi4uJykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb25maWcubWVzc2FnZSA9IHRoaXMubG9jYWxlU2VyLmdldFZhbHVlKCdsb2FkaW5nLm1lc3NhZ2UnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jb25maWcuY29udGFpbmVyO1xyXG4gICAgICAgIGxldCBwYXJlbnRDb250YWluZXIgPSBudWxsO1xyXG4gICAgICAgIGlmIChjb250YWluZXIgPT09ICdib2R5Jykge1xyXG4gICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGNvbnRhaW5lciBhcyBzdHJpbmcpLmFwcGVuZENoaWxkKCBfbG9hZGluZ0NtcFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoY29udGFpbmVyIGluc3RhbmNlb2YgRWxlbWVudFJlZiApIHtcclxuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5uYXRpdmVFbGVtZW50LmFwcGVuZENoaWxkKFxyXG4gICAgICAgICAgICAgICAgICAgIF9sb2FkaW5nQ21wUmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnRcclxuICAgICAgICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgICAgICAgcGFyZW50Q29udGFpbmVyID0gY29udGFpbmVyLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29udGFpbmVyIGluc3RhbmNlb2YgRWxlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChcclxuICAgICAgICAgICAgICAgICAgICAgICAgX2xvYWRpbmdDbXBSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudFxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudENvbnRhaW5lciA9IGNvbnRhaW5lcjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBfbG9hZGluZ0NtcFJlZi5pbnN0YW5jZS5kZWxheSA9IHRoaXMuY29uZmlnLmRlbGF5O1xyXG4gICAgICAgIF9sb2FkaW5nQ21wUmVmLmluc3RhbmNlLmlzQWN0aXZlID0gdHJ1ZTtcclxuICAgICAgICBfbG9hZGluZ0NtcFJlZi5pbnN0YW5jZS5wYXJlbnRDb250YWluZXIgPSBwYXJlbnRDb250YWluZXI7XHJcbiAgICAgICAgT2JqZWN0LmFzc2lnbihfbG9hZGluZ0NtcFJlZi5pbnN0YW5jZSwgdGhpcy5jb25maWcpO1xyXG5cclxuICAgICAgICBfbG9hZGluZ0NtcFJlZi5pbnN0YW5jZS5jbG9zZWQuc3Vic2NyaWJlKHN0YXRlID0+IHtcclxuICAgICAgICAgICAgaWYgKCFzdGF0ZSkge1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubG9hZGluZ0luc3RhbmNlc1tfbG9hZGluZ0NtcFJlZi5pbnN0YW5jZS5pZF07XHJcbiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRMb2FkaW5nSW5zdGFuY2VJRCA9IHRoaXMuZ2V0TWF4TG9hZGluZ0lEKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyRG9tKF9sb2FkaW5nQ21wUmVmKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBfbG9hZGluZ0NtcFJlZi5jaGFuZ2VEZXRlY3RvclJlZi5tYXJrRm9yQ2hlY2soKTtcclxuICAgICAgICBfbG9hZGluZ0NtcFJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGxvYWRpbmdJRCA9IHRoaXMuY3JlYXRlSW5zSWQoKTtcclxuICAgICAgICBfbG9hZGluZ0NtcFJlZi5pbnN0YW5jZS5pZCA9IGxvYWRpbmdJRDtcclxuICAgICAgICB0aGlzLmxvYWRpbmdJbnN0YW5jZXNbbG9hZGluZ0lEXSA9ICBfbG9hZGluZ0NtcFJlZjtcclxuICAgICAgICB0aGlzLmN1cnJlbnRMb2FkaW5nSW5zdGFuY2VJRCA9IGxvYWRpbmdJRDtcclxuXHJcbiAgICAgICAgcmV0dXJuIF9sb2FkaW5nQ21wUmVmLmluc3RhbmNlO1xyXG4gICAgfVxyXG5cclxuICAgIGNsb3NlKGxvYWRpbmdJZD86IG51bWJlcikge1xyXG4gICAgICAgIGNvbnN0IGlkID0gbG9hZGluZ0lkIHx8IHRoaXMuY3VycmVudExvYWRpbmdJbnN0YW5jZUlEO1xyXG4gICAgICAgIGNvbnN0IGxvYWRpbmdSZWYgPSB0aGlzLmxvYWRpbmdJbnN0YW5jZXNbaWRdO1xyXG4gICAgICAgIGlmIChsb2FkaW5nUmVmKSB7XHJcbiAgICAgICAgICAgIGxvYWRpbmdSZWYuaW5zdGFuY2UuY2xvc2UoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY2xlYXJBbGwoKSB7XHJcbiAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMubG9hZGluZ0luc3RhbmNlcyk7XHJcbiAgICAgICAgaWYgKGtleXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGtleXMuZm9yRWFjaChpZCA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyRG9tKHRoaXMubG9hZGluZ0luc3RhbmNlc1tpZF0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBsb2FkaW5ncyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2ZhcnJpcy1sb2FkaW5nJyk7XHJcbiAgICAgICAgICAgIGlmIChsb2FkaW5ncy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGxvYWRpbmdzLmZvckVhY2goIGVsID0+IGVsLnJlbW92ZSgpICk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMubG9hZGluZ0luc3RhbmNlcyA9IHt9O1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNsZWFyRG9tKF9sb2FkaW5nQ21wUmVmOiBDb21wb25lbnRSZWY8TG9hZGluZ0NvbXBvbmVudD4pIHtcclxuICAgICAgICBpZiAoX2xvYWRpbmdDbXBSZWYgJiYgX2xvYWRpbmdDbXBSZWYubG9jYXRpb24pIHtcclxuICAgICAgICAgICAgY29uc3QgbG9hZGluZ0VsID0gX2xvYWRpbmdDbXBSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudDtcclxuXHJcbiAgICAgICAgICAgIGlmIChsb2FkaW5nRWwucGFyZW50Tm9kZSkge1xyXG4gICAgICAgICAgICAgICAgbG9hZGluZ0VsLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobG9hZGluZ0VsKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgX2xvYWRpbmdDbXBSZWYuZGVzdHJveSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgX2xvYWRpbmdDbXBSZWYgPSBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY3JlYXRlSW5zSWQoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TWF4TG9hZGluZ0lEKCkgKyAxO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0TWF4TG9hZGluZ0lEKCkge1xyXG4gICAgICAgIGNvbnN0IGlkcyA9IE9iamVjdC5rZXlzKHRoaXMubG9hZGluZ0luc3RhbmNlcykubWFwKGsgPT4gcGFyc2VJbnQoaywgMTApKTtcclxuICAgICAgICBpZiAoaWRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICByZXR1cm4gbWF4KGlkcyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gMDtcclxuICAgIH1cclxufVxyXG5cclxuIl19