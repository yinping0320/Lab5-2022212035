{"version":3,"file":"farris-extend-organization-selector.js.map","sources":["ng://@farris/extend-organization-selector/lib/organization-selector.directive.ts","ng://@farris/extend-organization-selector/lib/organization-selector-data-mapping.module.ts"],"sourcesContent":["/**\r\n * 使用方法：\r\n * [mapFields]=\"{ id: 'user.userId', name: 'user.userName' }\"\r\n * key 为帮助上的字段， value 为 表单中的字段名\r\n * 帮助上的同一个字段可以映射到表单中的多个字段中，{ ... id: 'user.userid, user.addusid'}\r\n * 多字段以逗号隔开\r\n *\r\n */\r\n\r\nimport { Directive, OnInit, Optional, Self, Input, OnDestroy, AfterViewInit, Injector } from '@angular/core';\r\nimport { ViewModel } from '@farris/devkit';\r\nimport { OrganizationSelectorComponent }  from '@farris/ui-organization-selector';\r\n@Directive({\r\n    // tslint:disable-next-line:directive-selector\r\n    selector: '[organization-selector-data-mapping]'\r\n})\r\nexport class OrganizationSelectorDataMappingDirective implements OnInit, AfterViewInit, OnDestroy {\r\n\r\n    @Input() mapFields: any;\r\n\r\n    constructor(\r\n        @Optional() private vm: ViewModel,\r\n        @Optional() @Self() private targetComponent: OrganizationSelectorComponent,\r\n        private injector: Injector\r\n    ) { }\r\n\r\n    ngOnInit() {\r\n        this.targetComponent.selectionsChange.subscribe((data: any) => {\r\n            const mapfields = this.mapFields;\r\n            if (data.selections && data.selections.length) {\r\n                this.mappingData(data.selections, mapfields);\r\n            } else {\r\n                this.mappingData(null, mapfields);\r\n            }\r\n        });\r\n\r\n        this.targetComponent.inputClear.subscribe(() => {\r\n            const mapfields = this.mapFields;\r\n            this.mappingData(null, mapfields);\r\n        });\r\n\r\n        this.targetComponent.tagRemoved.subscribe((data) => {\r\n            const mapfields = this.mapFields;\r\n            this.tagRemovedMappingData(data.deleteIndex, mapfields);\r\n            // if (this.targetComponent.selections && this.targetComponent.selections.length) {\r\n            //     this.mappingData(this.targetComponent.selections, mapfields);\r\n            // } else {\r\n            //     this.mappingData(null, mapfields);\r\n            // }\r\n        });\r\n        if (!this.targetComponent.mapFields) {\r\n            this.targetComponent.mapFields = this.mapFields;\r\n        }\r\n    }\r\n\r\n    ngAfterViewInit(): void {\r\n\r\n    }\r\n\r\n    ngOnDestroy(): void {\r\n\r\n    }\r\n\r\n    private getFieldBinding() {\r\n        const ngControl = this.targetComponent && this.targetComponent.ngControl && this.targetComponent.ngControl;\r\n        const ngFormControls = ngControl && ngControl.formDirective && ngControl.formDirective.form\r\n            && ngControl.formDirective.form && ngControl.formDirective.form.ngFormControls;\r\n        const name = ngControl && ngControl.name;\r\n        return ngFormControls && ngFormControls[name] && ngFormControls[name].binding;\r\n    }\r\n\r\n    tagRemovedMappingData(index, mapFields) {\r\n        if (!mapFields) {\r\n            return;\r\n        }\r\n        if (\r\n            this.targetComponent.ngControl &&\r\n            this.targetComponent.ngControl.formDirective &&\r\n            this.targetComponent.ngControl.formDirective.form &&\r\n            this.targetComponent.ngControl.formDirective.form.bindingData\r\n        ) {\r\n            const bindingData = this.targetComponent.ngControl.formDirective.form.bindingData;\r\n            if (bindingData.setValue) {\r\n                // 关闭变更检测\r\n                const appContext = this.vm.frameContext.appContext;\r\n                appContext.changeDetectionController.detach();\r\n\r\n                let helpFields = Object.keys(mapFields);\r\n                const idIndex = helpFields.findIndex(item => item === this.targetComponent.primaryField);\r\n                if (helpFields.includes(this.targetComponent.primaryField) && idIndex !== 0) {\r\n                    helpFields.splice(idIndex, 1);\r\n                    helpFields = [this.targetComponent.primaryField, ...helpFields];\r\n                }\r\n                const pathArr = this.getBindingPathArray();\r\n                const anyFieldArr = this.mapFields[helpFields[0]].split(',');\r\n                const formAnyData = bindingData.getValue(pathArr.concat(anyFieldArr[0]));\r\n\r\n                if (!formAnyData || formAnyData.split(',').length < 2) {\r\n                    helpFields.reverse();\r\n                }\r\n\r\n                helpFields.forEach((helpField: any) => {\r\n                    this.mapFields[helpField].split(',').forEach(fieldPath => {\r\n                        const path = pathArr.concat(fieldPath.split('.'));\r\n                        // todo udt关联问题\r\n                        if (this.getFieldBinding() === fieldPath) {\r\n                            return;\r\n                        }\r\n                        const resStr = bindingData.getValue(path);\r\n                        if (!resStr) {\r\n                            bindingData.clearValue(path, true, true);\r\n                        } else {\r\n                            const resArr = resStr.split(',');\r\n                            resArr.splice(index, 1);\r\n                            const result = resArr.join();\r\n                            if (!result) {\r\n                                bindingData.clearValue(path, true, true);\r\n                            } else {\r\n                                bindingData.setValue(path, result, true, true);\r\n                            }\r\n                        }\r\n                    });\r\n                });\r\n                // 重新打开变更检测\r\n                appContext.changeDetectionController.reattach();\r\n            }\r\n        }\r\n    }\r\n    /**\r\n     *\r\n     * @param helpData 清空时，值为null\r\n     * @param mapFields 格式形如：{id: \"assoField.assoField\", code: \"assoField.assoField_Code\", name: \"assoField.assoField_Name\"}\r\n     */\r\n    mappingData(helpData: any, mapFields: any) {\r\n        if (!mapFields) {\r\n            return;\r\n        }\r\n\r\n        // 关闭变更检测\r\n        const appContext = this.vm.frameContext.appContext;\r\n        appContext.changeDetectionController.detach();\r\n\r\n        let helpFields = Object.keys(mapFields);\r\n        const idIndex = helpFields.findIndex(item => item === this.targetComponent.primaryField);\r\n        if (helpFields.includes(this.targetComponent.primaryField) && idIndex !== 0) {\r\n            helpFields.splice(idIndex, 1);\r\n            helpFields = [this.targetComponent.primaryField, ...helpFields];\r\n        }\r\n        if (!helpData) {\r\n            helpFields.reverse();\r\n        }\r\n        helpFields.forEach((f: any) => {\r\n            // 1、获取字段值\r\n            // 如果helpData有选中值，则获取帮助数据源里对应你字段的值；\r\n            // 如果helpData没有值（清空场景），则返回一个空字符串\r\n            let val: any = '';\r\n            if (helpData) {\r\n                if (helpData instanceof Array) {\r\n                    val = helpData.map((h: any) => {\r\n                        return this.getValue(f, h);\r\n                    }).join(',');\r\n                } else {\r\n                    val = this.getValue(f, helpData);\r\n                }\r\n            }\r\n\r\n            // 2、设置字段值\r\n            // 如果helpData不存在（清空场景），获取BindingData里对应字段的值，如果是数值，则设置0，其他设置上一步中的空字符串；\r\n            // 如果helpData存在：直接设置上一步中获取的值。\r\n            const pathArr = this.getBindingPathArray();\r\n            mapFields[f].split(',').forEach((ff: any) => {\r\n                if (this.getFieldBinding() === ff) {\r\n                    return;\r\n                }\r\n                if (!helpData) {\r\n                    this.vm.bindingData.clearValue(pathArr.concat(ff.split('.')), true, true);\r\n                } else {\r\n                    this.vm.bindingData.setValue(pathArr.concat(ff.split('.')), val, true, true);\r\n                }\r\n            });\r\n        });\r\n\r\n        // 重新打开变更检测\r\n        appContext.changeDetectionController.reattach();\r\n    }\r\n\r\n    private getValue(f: string, data: any) {\r\n        let val = '';\r\n        if (f.indexOf('.') === -1) {\r\n            val = data[f];\r\n        } else {\r\n            val = f.split('.').reduce((a, b) => {\r\n                return a[b];\r\n            }, data);\r\n        }\r\n\r\n        return val;\r\n    }\r\n\r\n    private getBindingPathArray(): any[] {\r\n        const path = this.vm.bindingPath;\r\n        if (path) {\r\n            return path.split('/').filter(n => n !== '');\r\n        }\r\n        return [];\r\n    }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { OrganizationSelectorDataMappingDirective } from './organization-selector.directive';\r\nimport { OrganizationSelectorModule } from '@farris/ui-organization-selector';\r\n@NgModule({\r\n  declarations: [OrganizationSelectorDataMappingDirective],\r\n  imports: [\r\n    OrganizationSelectorModule\r\n  ],\r\n  exports: [OrganizationSelectorDataMappingDirective]\r\n})\r\nexport class OrganizationSelectorDataMappingModule { }\r\n"],"names":[],"mappings":"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"}
