/**
 * @fileoverview added by tsickle
 * Generated from: lib/organization-selector.directive.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/**
 * 使用方法：
 * [mapFields]="{ id: 'user.userId', name: 'user.userName' }"
 * key 为帮助上的字段， value 为 表单中的字段名
 * 帮助上的同一个字段可以映射到表单中的多个字段中，{ ... id: 'user.userid, user.addusid'}
 * 多字段以逗号隔开
 *
 */
import { Directive, Optional, Self, Input, Injector } from '@angular/core';
import { ViewModel } from '@farris/devkit';
import { OrganizationSelectorComponent } from '@farris/ui-organization-selector';
export class OrganizationSelectorDataMappingDirective {
    /**
     * @param {?} vm
     * @param {?} targetComponent
     * @param {?} injector
     */
    constructor(vm, targetComponent, injector) {
        this.vm = vm;
        this.targetComponent = targetComponent;
        this.injector = injector;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.targetComponent.selectionsChange.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            /** @type {?} */
            const mapfields = this.mapFields;
            if (data.selections && data.selections.length) {
                this.mappingData(data.selections, mapfields);
            }
            else {
                this.mappingData(null, mapfields);
            }
        }));
        this.targetComponent.inputClear.subscribe((/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            const mapfields = this.mapFields;
            this.mappingData(null, mapfields);
        }));
        this.targetComponent.tagRemoved.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            /** @type {?} */
            const mapfields = this.mapFields;
            this.tagRemovedMappingData(data.deleteIndex, mapfields);
            // if (this.targetComponent.selections && this.targetComponent.selections.length) {
            //     this.mappingData(this.targetComponent.selections, mapfields);
            // } else {
            //     this.mappingData(null, mapfields);
            // }
        }));
        if (!this.targetComponent.mapFields) {
            this.targetComponent.mapFields = this.mapFields;
        }
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
    }
    /**
     * @private
     * @return {?}
     */
    getFieldBinding() {
        /** @type {?} */
        const ngControl = this.targetComponent && this.targetComponent.ngControl && this.targetComponent.ngControl;
        /** @type {?} */
        const ngFormControls = ngControl && ngControl.formDirective && ngControl.formDirective.form
            && ngControl.formDirective.form && ngControl.formDirective.form.ngFormControls;
        /** @type {?} */
        const name = ngControl && ngControl.name;
        return ngFormControls && ngFormControls[name] && ngFormControls[name].binding;
    }
    /**
     * @param {?} index
     * @param {?} mapFields
     * @return {?}
     */
    tagRemovedMappingData(index, mapFields) {
        if (!mapFields) {
            return;
        }
        if (this.targetComponent.ngControl &&
            this.targetComponent.ngControl.formDirective &&
            this.targetComponent.ngControl.formDirective.form &&
            this.targetComponent.ngControl.formDirective.form.bindingData) {
            /** @type {?} */
            const bindingData = this.targetComponent.ngControl.formDirective.form.bindingData;
            if (bindingData.setValue) {
                // 关闭变更检测
                /** @type {?} */
                const appContext = this.vm.frameContext.appContext;
                appContext.changeDetectionController.detach();
                /** @type {?} */
                let helpFields = Object.keys(mapFields);
                /** @type {?} */
                const idIndex = helpFields.findIndex((/**
                 * @param {?} item
                 * @return {?}
                 */
                item => item === this.targetComponent.primaryField));
                if (helpFields.includes(this.targetComponent.primaryField) && idIndex !== 0) {
                    helpFields.splice(idIndex, 1);
                    helpFields = [this.targetComponent.primaryField, ...helpFields];
                }
                /** @type {?} */
                const pathArr = this.getBindingPathArray();
                /** @type {?} */
                const anyFieldArr = this.mapFields[helpFields[0]].split(',');
                /** @type {?} */
                const formAnyData = bindingData.getValue(pathArr.concat(anyFieldArr[0]));
                if (!formAnyData || formAnyData.split(',').length < 2) {
                    helpFields.reverse();
                }
                helpFields.forEach((/**
                 * @param {?} helpField
                 * @return {?}
                 */
                (helpField) => {
                    this.mapFields[helpField].split(',').forEach((/**
                     * @param {?} fieldPath
                     * @return {?}
                     */
                    fieldPath => {
                        /** @type {?} */
                        const path = pathArr.concat(fieldPath.split('.'));
                        // todo udt关联问题
                        if (this.getFieldBinding() === fieldPath) {
                            return;
                        }
                        /** @type {?} */
                        const resStr = bindingData.getValue(path);
                        if (!resStr) {
                            bindingData.clearValue(path, true, true);
                        }
                        else {
                            /** @type {?} */
                            const resArr = resStr.split(',');
                            resArr.splice(index, 1);
                            /** @type {?} */
                            const result = resArr.join();
                            if (!result) {
                                bindingData.clearValue(path, true, true);
                            }
                            else {
                                bindingData.setValue(path, result, true, true);
                            }
                        }
                    }));
                }));
                // 重新打开变更检测
                appContext.changeDetectionController.reattach();
            }
        }
    }
    /**
     *
     * @param {?} helpData 清空时，值为null
     * @param {?} mapFields 格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"}
     * @return {?}
     */
    mappingData(helpData, mapFields) {
        if (!mapFields) {
            return;
        }
        // 关闭变更检测
        /** @type {?} */
        const appContext = this.vm.frameContext.appContext;
        appContext.changeDetectionController.detach();
        /** @type {?} */
        let helpFields = Object.keys(mapFields);
        /** @type {?} */
        const idIndex = helpFields.findIndex((/**
         * @param {?} item
         * @return {?}
         */
        item => item === this.targetComponent.primaryField));
        if (helpFields.includes(this.targetComponent.primaryField) && idIndex !== 0) {
            helpFields.splice(idIndex, 1);
            helpFields = [this.targetComponent.primaryField, ...helpFields];
        }
        if (!helpData) {
            helpFields.reverse();
        }
        helpFields.forEach((/**
         * @param {?} f
         * @return {?}
         */
        (f) => {
            // 1、获取字段值
            // 如果helpData有选中值，则获取帮助数据源里对应你字段的值；
            // 如果helpData没有值（清空场景），则返回一个空字符串
            /** @type {?} */
            let val = '';
            if (helpData) {
                if (helpData instanceof Array) {
                    val = helpData.map((/**
                     * @param {?} h
                     * @return {?}
                     */
                    (h) => {
                        return this.getValue(f, h);
                    })).join(',');
                }
                else {
                    val = this.getValue(f, helpData);
                }
            }
            // 2、设置字段值
            // 如果helpData不存在（清空场景），获取BindingData里对应字段的值，如果是数值，则设置0，其他设置上一步中的空字符串；
            // 如果helpData存在：直接设置上一步中获取的值。
            /** @type {?} */
            const pathArr = this.getBindingPathArray();
            mapFields[f].split(',').forEach((/**
             * @param {?} ff
             * @return {?}
             */
            (ff) => {
                if (this.getFieldBinding() === ff) {
                    return;
                }
                if (!helpData) {
                    this.vm.bindingData.clearValue(pathArr.concat(ff.split('.')), true, true);
                }
                else {
                    this.vm.bindingData.setValue(pathArr.concat(ff.split('.')), val, true, true);
                }
            }));
        }));
        // 重新打开变更检测
        appContext.changeDetectionController.reattach();
    }
    /**
     * @private
     * @param {?} f
     * @param {?} data
     * @return {?}
     */
    getValue(f, data) {
        /** @type {?} */
        let val = '';
        if (f.indexOf('.') === -1) {
            val = data[f];
        }
        else {
            val = f.split('.').reduce((/**
             * @param {?} a
             * @param {?} b
             * @return {?}
             */
            (a, b) => {
                return a[b];
            }), data);
        }
        return val;
    }
    /**
     * @private
     * @return {?}
     */
    getBindingPathArray() {
        /** @type {?} */
        const path = this.vm.bindingPath;
        if (path) {
            return path.split('/').filter((/**
             * @param {?} n
             * @return {?}
             */
            n => n !== ''));
        }
        return [];
    }
}
OrganizationSelectorDataMappingDirective.decorators = [
    { type: Directive, args: [{
                // tslint:disable-next-line:directive-selector
                selector: '[organization-selector-data-mapping]'
            },] }
];
/** @nocollapse */
OrganizationSelectorDataMappingDirective.ctorParameters = () => [
    { type: ViewModel, decorators: [{ type: Optional }] },
    { type: OrganizationSelectorComponent, decorators: [{ type: Optional }, { type: Self }] },
    { type: Injector }
];
OrganizationSelectorDataMappingDirective.propDecorators = {
    mapFields: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    OrganizationSelectorDataMappingDirective.prototype.mapFields;
    /**
     * @type {?}
     * @private
     */
    OrganizationSelectorDataMappingDirective.prototype.vm;
    /**
     * @type {?}
     * @private
     */
    OrganizationSelectorDataMappingDirective.prototype.targetComponent;
    /**
     * @type {?}
     * @private
     */
    OrganizationSelectorDataMappingDirective.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3JnYW5pemF0aW9uLXNlbGVjdG9yLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZXh0ZW5kLW9yZ2FuaXphdGlvbi1zZWxlY3Rvci8iLCJzb3VyY2VzIjpbImxpYi9vcmdhbml6YXRpb24tc2VsZWN0b3IuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFTQSxPQUFPLEVBQUUsU0FBUyxFQUFVLFFBQVEsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUE0QixRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0csT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxNQUFPLGtDQUFrQyxDQUFDO0FBS2xGLE1BQU0sT0FBTyx3Q0FBd0M7Ozs7OztJQUlqRCxZQUN3QixFQUFhLEVBQ0wsZUFBOEMsRUFDbEUsUUFBa0I7UUFGTixPQUFFLEdBQUYsRUFBRSxDQUFXO1FBQ0wsb0JBQWUsR0FBZixlQUFlLENBQStCO1FBQ2xFLGFBQVEsR0FBUixRQUFRLENBQVU7SUFDMUIsQ0FBQzs7OztJQUVMLFFBQVE7UUFDSixJQUFJLENBQUMsZUFBZSxDQUFDLGdCQUFnQixDQUFDLFNBQVM7Ozs7UUFBQyxDQUFDLElBQVMsRUFBRSxFQUFFOztrQkFDcEQsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTO1lBQ2hDLElBQUksSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRTtnQkFDM0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxDQUFDO2FBQ2hEO2lCQUFNO2dCQUNILElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO2FBQ3JDO1FBQ0wsQ0FBQyxFQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxTQUFTOzs7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XT1cInsgaWQ6ICd1c2VyLnVzZXJJZCcsIG5hbWU6ICd1c2VyLnVzZXJOYW1lJyB9XCJcclxuICoga2V5IOS4uuW4ruWKqeS4iueahOWtl+aute+8jCB2YWx1ZSDkuLog6KGo5Y2V5Lit55qE5a2X5q615ZCNXHJcbiAqIOW4ruWKqeS4iueahOWQjOS4gOS4quWtl+auteWPr+S7peaYoOWwhOWIsOihqOWNleS4reeahOWkmuS4quWtl+auteS4re+8jHsgLi4uIGlkOiAndXNlci51c2VyaWQsIHVzZXIuYWRkdXNpZCd9XHJcbiAqIOWkmuWtl+auteS7pemAl+WPt+malOW8gFxyXG4gKlxyXG4gKi9cclxuXHJcbmltcG9ydCB7IERpcmVjdGl2ZSwgT25Jbml0LCBPcHRpb25hbCwgU2VsZiwgSW5wdXQsIE9uRGVzdHJveSwgQWZ0ZXJWaWV3SW5pdCwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgVmlld01vZGVsIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBPcmdhbml6YXRpb25TZWxlY3RvckNvbXBvbmVudCB9ICBmcm9tICdAZmFycmlzL3VpLW9yZ2FuaXphdGlvbi1zZWxlY3Rvcic7XHJcbkBEaXJlY3RpdmUoe1xyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmRpcmVjdGl2ZS1zZWxlY3RvclxyXG4gICAgc2VsZWN0b3I6ICdbb3JnYW5pemF0aW9uLXNlbGVjdG9yLWRhdGEtbWFwcGluZ10nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBPcmdhbml6YXRpb25TZWxlY3RvckRhdGFNYXBwaW5nRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xyXG5cclxuICAgIEBJbnB1dCgpIG1hcEZpZWxkczogYW55O1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIEBPcHRpb25hbCgpIHByaXZhdGUgdm06IFZpZXdNb2RlbCxcclxuICAgICAgICBAT3B0aW9uYWwoKSBAU2VsZigpIHByaXZhdGUgdGFyZ2V0Q29tcG9uZW50OiBPcmdhbml6YXRpb25TZWxlY3RvckNvbXBvbmVudCxcclxuICAgICAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvclxyXG4gICAgKSB7IH1cclxuXHJcbiAgICBuZ09uSW5pdCgpIHtcclxuICAgICAgICB0aGlzLnRhcmdldENvbXBvbmVudC5zZWxlY3Rpb25zQ2hhbmdlLnN1YnNjcmliZSgoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1hcGZpZWxkcyA9IHRoaXMubWFwRmllbGRzO1xyXG4gICAgICAgICAgICBpZiAoZGF0YS5zZWxlY3Rpb25zICYmIGRhdGEuc2VsZWN0aW9ucy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubWFwcGluZ0RhdGEoZGF0YS5zZWxlY3Rpb25zLCBtYXBmaWVsZHMpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tYXBwaW5nRGF0YShudWxsLCBtYXBmaWVsZHMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMudGFyZ2V0Q29tcG9uZW50LmlucHV0Q2xlYXIuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbWFwZmllbGRzID0gdGhpcy5tYXBGaWVsZHM7XHJcbiAgICAgICAgICAgIHRoaXMubWFwcGluZ0RhdGEobnVsbCwgbWFwZmllbGRzKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy50YXJnZXRDb21wb25lbnQudGFnUmVtb3ZlZC5zdWJzY3JpYmUoKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbWFwZmllbGRzID0gdGhpcy5tYXBGaWVsZHM7XHJcbiAgICAgICAgICAgIHRoaXMudGFnUmVtb3ZlZE1hcHBpbmdEYXRhKGRhdGEuZGVsZXRlSW5kZXgsIG1hcGZpZWxkcyk7XHJcbiAgICAgICAgICAgIC8vIGlmICh0aGlzLnRhcmdldENvbXBvbmVudC5zZWxlY3Rpb25zICYmIHRoaXMudGFyZ2V0Q29tcG9uZW50LnNlbGVjdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIC8vICAgICB0aGlzLm1hcHBpbmdEYXRhKHRoaXMudGFyZ2V0Q29tcG9uZW50LnNlbGVjdGlvbnMsIG1hcGZpZWxkcyk7XHJcbiAgICAgICAgICAgIC8vIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vICAgICB0aGlzLm1hcHBpbmdEYXRhKG51bGwsIG1hcGZpZWxkcyk7XHJcbiAgICAgICAgICAgIC8vIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAoIXRoaXMudGFyZ2V0Q29tcG9uZW50Lm1hcEZpZWxkcykge1xyXG4gICAgICAgICAgICB0aGlzLnRhcmdldENvbXBvbmVudC5tYXBGaWVsZHMgPSB0aGlzLm1hcEZpZWxkcztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRGaWVsZEJpbmRpbmcoKSB7XHJcbiAgICAgICAgY29uc3QgbmdDb250cm9sID0gdGhpcy50YXJnZXRDb21wb25lbnQgJiYgdGhpcy50YXJnZXRDb21wb25lbnQubmdDb250cm9sICYmIHRoaXMudGFyZ2V0Q29tcG9uZW50Lm5nQ29udHJvbDtcclxuICAgICAgICBjb25zdCBuZ0Zvcm1Db250cm9scyA9IG5nQ29udHJvbCAmJiBuZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZSAmJiBuZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtXHJcbiAgICAgICAgICAgICYmIG5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0gJiYgbmdDb250cm9sLmZvcm1EaXJlY3RpdmUuZm9ybS5uZ0Zvcm1Db250cm9scztcclxuICAgICAgICBjb25zdCBuYW1lID0gbmdDb250cm9sICYmIG5nQ29udHJvbC5uYW1lO1xyXG4gICAgICAgIHJldHVybiBuZ0Zvcm1Db250cm9scyAmJiBuZ0Zvcm1Db250cm9sc1tuYW1lXSAmJiBuZ0Zvcm1Db250cm9sc1tuYW1lXS5iaW5kaW5nO1xyXG4gICAgfVxyXG5cclxuICAgIHRhZ1JlbW92ZWRNYXBwaW5nRGF0YShpbmRleCwgbWFwRmllbGRzKSB7XHJcbiAgICAgICAgaWYgKCFtYXBGaWVsZHMpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICAgIHRoaXMudGFyZ2V0Q29tcG9uZW50Lm5nQ29udHJvbCAmJlxyXG4gICAgICAgICAgICB0aGlzLnRhcmdldENvbXBvbmVudC5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZSAmJlxyXG4gICAgICAgICAgICB0aGlzLnRhcmdldENvbXBvbmVudC5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtICYmXHJcbiAgICAgICAgICAgIHRoaXMudGFyZ2V0Q29tcG9uZW50Lm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0uYmluZGluZ0RhdGFcclxuICAgICAgICApIHtcclxuICAgICAgICAgICAgY29uc3QgYmluZGluZ0RhdGEgPSB0aGlzLnRhcmdldENvbXBvbmVudC5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtLmJpbmRpbmdEYXRhO1xyXG4gICAgICAgICAgICBpZiAoYmluZGluZ0RhdGEuc2V0VmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIC8vIOWFs+mXreWPmOabtOajgOa1i1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMudm0uZnJhbWVDb250ZXh0LmFwcENvbnRleHQ7XHJcbiAgICAgICAgICAgICAgICBhcHBDb250ZXh0LmNoYW5nZURldGVjdGlvbkNvbnRyb2xsZXIuZGV0YWNoKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IGhlbHBGaWVsZHMgPSBPYmplY3Qua2V5cyhtYXBGaWVsZHMpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaWRJbmRleCA9IGhlbHBGaWVsZHMuZmluZEluZGV4KGl0ZW0gPT4gaXRlbSA9PT0gdGhpcy50YXJnZXRDb21wb25lbnQucHJpbWFyeUZpZWxkKTtcclxuICAgICAgICAgICAgICAgIGlmIChoZWxwRmllbGRzLmluY2x1ZGVzKHRoaXMudGFyZ2V0Q29tcG9uZW50LnByaW1hcnlGaWVsZCkgJiYgaWRJbmRleCAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGhlbHBGaWVsZHMuc3BsaWNlKGlkSW5kZXgsIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGhlbHBGaWVsZHMgPSBbdGhpcy50YXJnZXRDb21wb25lbnQucHJpbWFyeUZpZWxkLCAuLi5oZWxwRmllbGRzXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbnN0IHBhdGhBcnIgPSB0aGlzLmdldEJpbmRpbmdQYXRoQXJyYXkoKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFueUZpZWxkQXJyID0gdGhpcy5tYXBGaWVsZHNbaGVscEZpZWxkc1swXV0uc3BsaXQoJywnKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZvcm1BbnlEYXRhID0gYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aEFyci5jb25jYXQoYW55RmllbGRBcnJbMF0pKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIWZvcm1BbnlEYXRhIHx8IGZvcm1BbnlEYXRhLnNwbGl0KCcsJykubGVuZ3RoIDwgMikge1xyXG4gICAgICAgICAgICAgICAgICAgIGhlbHBGaWVsZHMucmV2ZXJzZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGhlbHBGaWVsZHMuZm9yRWFjaCgoaGVscEZpZWxkOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcEZpZWxkc1toZWxwRmllbGRdLnNwbGl0KCcsJykuZm9yRWFjaChmaWVsZFBhdGggPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXRoID0gcGF0aEFyci5jb25jYXQoZmllbGRQYXRoLnNwbGl0KCcuJykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyB0b2RvIHVkdOWFs+iBlOmXrumimFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXRGaWVsZEJpbmRpbmcoKSA9PT0gZmllbGRQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzU3RyID0gYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVzU3RyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nRGF0YS5jbGVhclZhbHVlKHBhdGgsIHRydWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzQXJyID0gcmVzU3RyLnNwbGl0KCcsJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNBcnIuc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHJlc0Fyci5qb2luKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdEYXRhLmNsZWFyVmFsdWUocGF0aCwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdEYXRhLnNldFZhbHVlKHBhdGgsIHJlc3VsdCwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgLy8g6YeN5paw5omT5byA5Y+Y5pu05qOA5rWLXHJcbiAgICAgICAgICAgICAgICBhcHBDb250ZXh0LmNoYW5nZURldGVjdGlvbkNvbnRyb2xsZXIucmVhdHRhY2goKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICpcclxuICAgICAqIEBwYXJhbSBoZWxwRGF0YSDmuIXnqbrml7bvvIzlgLzkuLpudWxsXHJcbiAgICAgKiBAcGFyYW0gbWFwRmllbGRzIOagvOW8j+W9ouWmgu+8mntpZDogXCJhc3NvRmllbGQuYXNzb0ZpZWxkXCIsIGNvZGU6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZF9Db2RlXCIsIG5hbWU6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZF9OYW1lXCJ9XHJcbiAgICAgKi9cclxuICAgIG1hcHBpbmdEYXRhKGhlbHBEYXRhOiBhbnksIG1hcEZpZWxkczogYW55KSB7XHJcbiAgICAgICAgaWYgKCFtYXBGaWVsZHMpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g5YWz6Zet5Y+Y5pu05qOA5rWLXHJcbiAgICAgICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMudm0uZnJhbWVDb250ZXh0LmFwcENvbnRleHQ7XHJcbiAgICAgICAgYXBwQ29udGV4dC5jaGFuZ2VEZXRlY3Rpb25Db250cm9sbGVyLmRldGFjaCgpO1xyXG5cclxuICAgICAgICBsZXQgaGVscEZpZWxkcyA9IE9iamVjdC5rZXlzKG1hcEZpZWxkcyk7XHJcbiAgICAgICAgY29uc3QgaWRJbmRleCA9IGhlbHBGaWVsZHMuZmluZEluZGV4KGl0ZW0gPT4gaXRlbSA9PT0gdGhpcy50YXJnZXRDb21wb25lbnQucHJpbWFyeUZpZWxkKTtcclxuICAgICAgICBpZiAoaGVscEZpZWxkcy5pbmNsdWRlcyh0aGlzLnRhcmdldENvbXBvbmVudC5wcmltYXJ5RmllbGQpICYmIGlkSW5kZXggIT09IDApIHtcclxuICAgICAgICAgICAgaGVscEZpZWxkcy5zcGxpY2UoaWRJbmRleCwgMSk7XHJcbiAgICAgICAgICAgIGhlbHBGaWVsZHMgPSBbdGhpcy50YXJnZXRDb21wb25lbnQucHJpbWFyeUZpZWxkLCAuLi5oZWxwRmllbGRzXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFoZWxwRGF0YSkge1xyXG4gICAgICAgICAgICBoZWxwRmllbGRzLnJldmVyc2UoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaGVscEZpZWxkcy5mb3JFYWNoKChmOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgLy8gMeOAgeiOt+WPluWtl+auteWAvFxyXG4gICAgICAgICAgICAvLyDlpoLmnpxoZWxwRGF0YeaciemAieS4reWAvO+8jOWImeiOt+WPluW4ruWKqeaVsOaNrua6kOmHjOWvueW6lOS9oOWtl+auteeahOWAvO+8m1xyXG4gICAgICAgICAgICAvLyDlpoLmnpxoZWxwRGF0YeayoeacieWAvO+8iOa4heepuuWcuuaZr++8ie+8jOWImei/lOWbnuS4gOS4quepuuWtl+espuS4slxyXG4gICAgICAgICAgICBsZXQgdmFsOiBhbnkgPSAnJztcclxuICAgICAgICAgICAgaWYgKGhlbHBEYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaGVscERhdGEgaW5zdGFuY2VvZiBBcnJheSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhbCA9IGhlbHBEYXRhLm1hcCgoaDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFZhbHVlKGYsIGgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pLmpvaW4oJywnKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFsID0gdGhpcy5nZXRWYWx1ZShmLCBoZWxwRGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIDLjgIHorr7nva7lrZfmrrXlgLxcclxuICAgICAgICAgICAgLy8g5aaC5p6caGVscERhdGHkuI3lrZjlnKjvvIjmuIXnqbrlnLrmma/vvInvvIzojrflj5ZCaW5kaW5nRGF0YemHjOWvueW6lOWtl+auteeahOWAvO+8jOWmguaenOaYr+aVsOWAvO+8jOWImeiuvue9rjDvvIzlhbbku5borr7nva7kuIrkuIDmraXkuK3nmoTnqbrlrZfnrKbkuLLvvJtcclxuICAgICAgICAgICAgLy8g5aaC5p6caGVscERhdGHlrZjlnKjvvJrnm7TmjqXorr7nva7kuIrkuIDmraXkuK3ojrflj5bnmoTlgLzjgIJcclxuICAgICAgICAgICAgY29uc3QgcGF0aEFyciA9IHRoaXMuZ2V0QmluZGluZ1BhdGhBcnJheSgpO1xyXG4gICAgICAgICAgICBtYXBGaWVsZHNbZl0uc3BsaXQoJywnKS5mb3JFYWNoKChmZjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXRGaWVsZEJpbmRpbmcoKSA9PT0gZmYpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoIWhlbHBEYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy52bS5iaW5kaW5nRGF0YS5jbGVhclZhbHVlKHBhdGhBcnIuY29uY2F0KGZmLnNwbGl0KCcuJykpLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy52bS5iaW5kaW5nRGF0YS5zZXRWYWx1ZShwYXRoQXJyLmNvbmNhdChmZi5zcGxpdCgnLicpKSwgdmFsLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIOmHjeaWsOaJk+W8gOWPmOabtOajgOa1i1xyXG4gICAgICAgIGFwcENvbnRleHQuY2hhbmdlRGV0ZWN0aW9uQ29udHJvbGxlci5yZWF0dGFjaCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0VmFsdWUoZjogc3RyaW5nLCBkYXRhOiBhbnkpIHtcclxuICAgICAgICBsZXQgdmFsID0gJyc7XHJcbiAgICAgICAgaWYgKGYuaW5kZXhPZignLicpID09PSAtMSkge1xyXG4gICAgICAgICAgICB2YWwgPSBkYXRhW2ZdO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHZhbCA9IGYuc3BsaXQoJy4nKS5yZWR1Y2UoKGEsIGIpID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhW2JdO1xyXG4gICAgICAgICAgICB9LCBkYXRhKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB2YWw7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRCaW5kaW5nUGF0aEFycmF5KCk6IGFueVtdIHtcclxuICAgICAgICBjb25zdCBwYXRoID0gdGhpcy52bS5iaW5kaW5nUGF0aDtcclxuICAgICAgICBpZiAocGF0aCkge1xyXG4gICAgICAgICAgICByZXR1cm4gcGF0aC5zcGxpdCgnLycpLmZpbHRlcihuID0+IG4gIT09ICcnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=