!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs/operators"),require("@farris/ui-lookup"),require("rxjs"),require("@farris/ui-common"),require("@angular/core"),require("@farris/ui-datatable"),require("@farris/ui-treetable"),require("@farris/ui-input-group"),require("@angular/common"),require("@angular/forms"),require("@farris/ui-loading"),require("@farris/ui-combo-list")):"function"==typeof define&&define.amd?define("@farris/ui-combo-lookup",["exports","rxjs/operators","@farris/ui-lookup","rxjs","@farris/ui-common","@angular/core","@farris/ui-datatable","@farris/ui-treetable","@farris/ui-input-group","@angular/common","@angular/forms","@farris/ui-loading","@farris/ui-combo-list"],t):t((e.farris=e.farris||{},e.farris["ui-combo-lookup"]={}),e.rxjs.operators,e.uiLookup,e.rxjs,e.uiCommon,e.ng.core,e.uiDatatable,e.uiTreetable,e.uiInputGroup,e.ng.common,e.ng.forms,e.uiLoading,e.uiComboList)}(this,function(e,n,t,s,l,c,i,r,o,a,p,d,u){"use strict";var h=(f.decorators=[{type:c.Injectable,args:[{providedIn:"root"}]}],f.ctorParameters=function(){return[]},f.ngInjectableDef=c.defineInjectable({factory:function(){return new f},token:f,providedIn:"root"}),f);function f(){}var m=function(e,t){return(m=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};var g,y=function(){return(y=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},b={provide:p.NG_VALUE_ACCESSOR,useExisting:c.forwardRef(function(){return v}),multi:!0},v=(function I(e,t){function i(){this.constructor=e}m(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}(S,g=u.BaseComboComponent),Object.defineProperty(S.prototype,"columns",{get:function(){var t=this,e=this._columns!==undefined&&0<this._columns.length?this._columns:this.comboService.columns;return this.useTreeView&&1<e.length&&(e=e.filter(function(e){return e.field===t.textField})),e},set:function(e){this._columns=e},enumerable:!0,configurable:!0}),Object.defineProperty(S.prototype,"pagination",{get:function(){return this._pagination!==undefined?this._pagination:!(!this.comboService.pageInfo||!this.pageInfo.enablePager)&&this.pageInfo.enablePager},set:function(e){this._pagination=e},enumerable:!0,configurable:!0}),Object.defineProperty(S.prototype,"displayType",{get:function(){return this.comboService.displayType},set:function(e){this.comboService.displayType=e+""},enumerable:!0,configurable:!0}),Object.defineProperty(S.prototype,"treeCmpRef",{get:function(){return this._treeCmpRef},set:function(e){e&&(e.cascadeCheck=this.cascade.enable,e.cascadeDown=this.cascade.down,e.cascadeUp=this.cascade.up,this.tt$.next(e)),this._treeCmpRef=e},enumerable:!0,configurable:!0}),Object.defineProperty(S.prototype,"tableCmpRef",{set:function(t){var i=this;t&&this.pagination&&this.loaded$.pipe(n.take(1)).subscribe(function(e){t.loadData({pageSize:i.pageInfo.pageSize,total:i.pageInfo.total,data:i.data,pageIndex:i.pageInfo.pageIndex})}),!this._tableCmpRef&&this.loadFinish&&t&&t.loadData({pageSize:this.pageInfo.pageSize,total:this.pageInfo.total,data:this.data,pageIndex:this.pageInfo.pageIndex}),this._tableCmpRef=t},enumerable:!0,configurable:!0}),S.prototype.ngOnInit=function(){var t=this;g.prototype.ngOnInit.call(this),this.treeClientSearch.pipe(n.debounceTime(300)).subscribe(function(e){!t.remoteSearch&&t.treeCmpRef&&t.treeCmpRef.searchHandle.search(t.textField,e)}),this.comboService.treeInfo$.subscribe(function(e){e&&("default"===t.loadTreeDataType&&(t.loadDataType=e.loadDataType),t.treeInfo=Object.assign(t.treeInfo||{},e))})},S.prototype.onSelectionsChange=function(e){var t=this;"LOOKUPLIST"===this.displayType?(this.multiSelect?(this.ownSelections={},this.comboService.selections.forEach(function(e){t.ownSelections[e[t.idField]]=e})):this.ownSelections=e[0]?e[0]:{},this.pageInfo=y({},this.pageInfo,this.comboService.pageInfo),this.loadFinish=!0,this.cdr.detectChanges(),this.loaded$.next(this.pageInfo)):this.treeCmpRef?this.initTreeData():this.tt$.pipe(n.take(1)).subscribe(function(e){t.treeCmpRef=e,t.initTreeData()})},S.prototype.setTreeNodeExpandBy=function(e,i){var n=this;e&&e.length&&e.forEach(function(e){var t=e.data[n.treeInfo.dataField].layer;e.expanded=t<=i||e.expanded,e.children&&e.children.length&&t+1<=i&&n.setTreeNodeExpandBy(e.children,i)})},S.prototype.initTreeData=function(){var t=this,e=this.comboService.selections.filter(function(e){return null!==e&&e!==undefined}),i=[];this.ownSelections=e.map(function(e){return i.push(e[t.idField]),{data:e,id:e[t.idField]}}),this.treeCmpRef.selections=this.ownSelections,this.treeCmpRef.checkeds=this.ownSelections,-1!=this.expandLevel&&"all"==this.loadDataType&&(0<this.expandLevel?(this.setTreeNodeExpandBy(this.treeCmpRef.data,this.expandLevel),this.treeCmpRef.updateSerializedValue()):this.treeCmpRef.expandAll()),this.comboService.data&&this.comboService.data.length&&this.treeCmpRef.checkValues&&this.treeCmpRef.checkValues.length&&(this.multiSelect&&this.treeCmpRef.checkedNodes(this.treeCmpRef.checkValues),this.treeCmpRef.selectNodes(this.treeCmpRef.checkValues))},S.prototype.isTree=function(){return"LOOKUPTREELIST"===this.displayType},S.prototype.updateMappingFieldValue=function(r){var o=this;if(void 0===r&&(r=!1),this.ngControl&&this.ngControl.formDirective&&this.ngControl.formDirective.form&&this.ngControl.formDirective.form.bindingData){var a=this.ngControl.formDirective.form.bindingData,e=this.ngControl.formDirective.form.bindingPath,s=[];e&&(s=e.split("/").filter(function(e){return""!==e})),this.mappingField=this.mappingField?this.mappingField:{},this.mapFields&&Object.keys(this.mapFields).forEach(function(t){var e=o.mapFields[t]?o.mapFields[t]:"",i="";if(!r){var n=o.comboService.selections&&o.comboService.selections.map(function(e){return o.comboService.getValueByObj(t,e)}).filter(function(e){return null!==e}).join(o.separator);i=n||""}e&&e.split(",").forEach(function(e){var t=i;o.nosearch&&e===o.ngControl.name&&(t=o.displayText),a.setValue?o.useFormDataMapping||a.setValue(s.concat(e.split(".")),t,!0,!0):o.commonUtils.setValue(a,e,i)})})}},S.prototype.updateSelectedValues=function(){if(this.ngControl&&this.ngControl.formDirective&&this.ngControl.formDirective.form&&this.ngControl.formDirective.form.bindingData){var e=this.ngControl.formDirective.form.bindingData,t=this.ngControl.formDirective.form.bindingPath,i=[];t&&(i=t.split("/").filter(function(e){return""!==e}));var n=this.mappingField?this.mapFields[this.idField]:"";n&&-1<n.indexOf(",")&&(n=n.split(",")[0]),n&&e.getValue?this.selectedValues=e.getValue(i.concat(n.split(".")))||"":n?this.selectedValues=this.commonUtils.getValue(n,e)||"":(n=this.mappingField?this.mapFields[this.textField]:"")&&e.getValue&&(this.comboService.__SELECTEDIDS__=this.comboService.getValue(this.idField),this.selectedValues=e.getValue(i.concat(n.split(".")))||"")}else this.el.nativeElement.__zone_symbol__UIStateBindingChangefalse&&(this.selectedValues=this.displayText)},S.prototype.onSelectRows=function(e){if("LOOKUPLIST"===this.displayType){var t=e.data,i=e.index;this.comboService.selectItem(t,i),this.selectChange.emit({data:t,index:i,instance:this})}else if("LOOKUPTREELIST"===this.displayType){var n=e.node;e.nodes?this.comboService.selectItem(e.nodes.map(function(e){return e.data})):this.comboService.selectItem(n.data),this.selectChange.emit(n)}this.updateTextAndValues(),this.multiSelect||this.comboService.isOpen$.next(!1)},S.prototype.onUnSelectRows=function(e){if("LOOKUPLIST"===this.displayType){var t=e.data;this.comboService.unSelectItem(t)}else if("LOOKUPTREELIST"===this.displayType){var i=e.node;this.comboService.unSelectItem(i.data),this.selectChange.emit(i)}this.updateTextAndValues()},S.prototype.onCheckAll=function(e){var t,i=[];i="LOOKUPTREELIST"===this.displayType?(t=e.checked,this.treeCmpRef.state.rowNodes.filter(function(e){return e.node.selectable===undefined||e.node.selectable}).map(function(e){return e.node.data})):(t=e,this.data),t?this.comboService.selectAll(i):this.comboService.unSelectAll(i),this.updateTextAndValues()},S.prototype.updateTextAndValues=function(){this.comboService.__SELECTEDIDS__=this.comboService.getValue(this.idField),this.selectedValues=this.comboService.__SELECTEDIDS__,this.multiSelect||this.updateSelectedValues();var e=this.comboService.getValue(this.textField);this.onValueChange({text:e,value:this.comboService.__SELECTEDIDS__,selections:this.selections})},S.prototype.onKeyup=function(e){},S.prototype.onKeydown=function(e){"Tab"===e.key&&this.hide(!1),"Enter"===e.key&&(e.stopPropagation(),this._searchKeyWords&&!this.multiSelect&&("LOOKUPLIST"===this.displayType?this.onSelectRows({data:this._tableCmpRef.selections}):this.displayType))},S.prototype.onPageChanged=function(t){var i=this;this.uri?this.getData(t).subscribe(function(e){return i.comboService.loadLookUpDataTable(e,!!t.sortName)}):this.pageChanged.emit(t)},S.prototype.onPageSizeChanged=function(t){var i=this;this.uri?this.getData(t).subscribe(function(e){return i.comboService.loadLookUpDataTable(e,!!t.sortName)}):this.pageSizeChanged.emit(t)},S.prototype.onColumnSorted=function(e){var t=this,i=y({},e),n=i.sortName,r=i.sortOrder;this.getData({sortName:n,sortOrder:r},"search").subscribe(function(e){t.comboService.loadLookUpDataTable(e,!0)})},S.prototype.onClear=function(){this.ownSelections=[],this.isTree()&&this.treeCmpRef&&this.treeCmpRef.clearAll(),g.prototype.onClear.call(this)},S.prototype.getChildren=function(e,t,i){var n=y({parentLayer:t,category:"children"},i);"parentId"===this.treeInfo.layerType?n.parentId=e:n.parentPath=e;var r={searchValue:JSON.stringify(n),customData:this.customData,enableFullTree:this.enableFullTree,loadTreeDataType:this.loadTreeDataType};this._searchKeyWords&&(r.enableFullTree=!1,r.loadTreeDataType="layerload","parentId"===this.treeInfo.layerType&&(n.searchValue="",n.searchField="*"),r.searchValue=JSON.stringify(n));var o=this.treeCmpRef;return o&&o.sortName&&Object.assign(r,{sortName:o.sortName,sortOrder:o.sortOrder}),this.comboService.getData(r,"get",!0)},S.prototype.getData=function(e,t){void 0===t&&(t="all"),e=e||{},this._searchKeyWords&&(e.search={field:"*",value:this._searchKeyWords});var i=this.buildQueryParams(e,t);return this.comboService.getData(i)},S.prototype.buildQueryParams=function(e,t){void 0===t&&(t="all");var i={},n={category:t};return e&&(e.pageInfo&&(i.pageIndex=e.pageInfo.pageIndex,i.pageSize=e.pageInfo.pageSize),e.search&&(n.searchField=e.search.field,n.searchValue=e.search.value),e.sortName&&(n.sortName=e.sortName),e.sortOrder&&(n.sortOrder=e.sortOrder)),i.searchValue=JSON.stringify(n),this.customData&&(i.customData=this.customData),i},S.prototype.filterDataOnServer=function(e,t){var i={search:{field:t,value:e}};e?this._searchKeyWords=e:(this._searchKeyWords="",i=null);var n=this.buildQueryParams(i,"search");if(!this.isOpen){if(this.nosearch)return;return this.isOpen=!0,void this.comboService.isOpen$.next({isOpen:this.isOpen,search:n})}this.comboService.serachValue$.next(n)},S.prototype.onExpandNode=function(r){var o=this;if(!(r.leaf||r.showLoading||r.children&&r.children.length)){var e="",t=-1,i=this._searchKeyWords,n=void 0===i?"":i,a=this.treeInfo.dataField;"parentId"===this.treeInfo.layerType?(e=r.id,t=r.data[a][this.treeInfo.layerField]):a?(e=r.data[a][this.treeInfo.pathField],t=r.data[a][this.treeInfo.layerField]):this.treeCmpRef.writeConsole("未找到分级信息。"),this.getChildren(e,t,{searchField:"*",searchValue:n}).subscribe(function(e){if(r&&e.items&&e.items.length){var t=o.comboService.checkNodeCanBeSelect(e.items,!1);o.treeCmpRef.appendChildren(t,r)}o.treeCmpRef.detectChanges();var i=o.comboService.__SELECTEDIDS__;if(i&&i.length){var n=i.split(o.separator);o.multiSelect&&o.treeCmpRef.checkedNodes(n),o.treeCmpRef.selectNodes(n)}o.treeCmpRef.psRef.directiveRef.update()})}},S.prototype.initDatasChangeAction=function(){var i=this;this.comboService.data$.pipe(n.delay(120)).subscribe(function(e){if(!i.uri&&e&&e.length){i.updateSelections(i.selectedValues,e);var t=i.comboService.getValue(i.textField);t=t||(i.nosearch?i.displayText:""),i.displayText=t,i.originalText=i.displayText}i._searchKeyWords&&e&&e.length&&!i.multiSelect&&("LOOKUPLIST"===i.displayType?(i._tableCmpRef.selections=e[0],i._tableCmpRef.cd.detectChanges()):"LOOKUPTREELIST"===i.displayType&&i.comboService.checkNodeCanBeSelect(e.items,!1))})},S.decorators=[{type:c.Component,args:[{selector:"farris-combo-lookup",template:'<input-group\r\n    #input\r\n    [attr.title]="enableTitle ? displayText : \'\'"\r\n    [class.actived]="isOpen"\r\n    [(value)]="displayText"\r\n    [forcePlaceholder]="forcePlaceholder"\r\n    [disabled]="disabled"\r\n    [readonly]="readonly"\r\n    [editable]="editable"\r\n    [groupText]="groupIcon"\r\n    [placeholder]="placeholder"\r\n    [enableClear]="enableClear"\r\n    (clickHandle)="onClick()"\r\n    (inputClick)="onInputclick($event)"\r\n    (blurHandle)="onBlur($event)"\r\n    (focusHandle)="onFocus($event)"\r\n    (valueChange)="onTextChange($event)"\r\n    (clear)="onClear()"\r\n    (keyupHandle)="onKeyup($event)"\r\n    (keydownHandle)="onKeydown($event)"\r\n    [maxLength]="maxLength" \r\n    style="display: block;"\r\n>\r\n</input-group>\r\n<div class="comboPanel f-area-hide" *ngIf="isOpen"  #comboPanel style="overflow: hidden; height: 100%; width: 100%" >\r\n    <farris-datatable\r\n        *ngIf="displayType === \'LOOKUPLIST\'"\r\n        #dt\r\n        [width]="panelWidth"\r\n        [height]="panelHeight"\r\n        [columns]="columns"\r\n        [data]="comboService.data$ | async"\r\n        [selections]="ownSelections"\r\n        [idField]="idField"\r\n        [singleSelect]="!multiSelect"\r\n        [pagination] = "pagination"\r\n        [pageSize]="pageInfo.pageSize"\r\n        [pageIndex]="pageInfo.pageIndex"\r\n        [pageList]="pageInfo.pageList"\r\n        [total]="pageInfo.total"\r\n        [pagerViewMode]="\'simple\'"\r\n        [showPageInfo]="false" \r\n        [showPageNumber]="false" \r\n        [showPageList]="false"\r\n        [remoteSort]="false"\r\n        [showHeader]="showHeader"\r\n        (selectRows)="onSelectRows($event)"\r\n        (unSelectRow)="onUnSelectRows($event)"\r\n        (checkAll)="onCheckAll($event)"\r\n        (pageChanged)="onPageChanged($event)"\r\n        (pageSizeChanged)="onPageSizeChanged($event)"\r\n        (columnSorted)="onColumnSorted($event)"\r\n    ></farris-datatable>\r\n\r\n    <farris-treetable #tt\r\n        *ngIf="displayType === \'LOOKUPTREELIST\'"\r\n        [showHeader]="!useTreeView && showHeader"\r\n        [showBorder]="!useTreeView" \r\n        [showHeader]="!useTreeView"\r\n        [expandLevel]="expandLevel"\r\n        [virtualized]="true"\r\n        [enableFilterRow]="enableFilterRow"\r\n        [columns]="columns"\r\n        [singleSelect]="!multiSelect"\r\n        [idField]="idField"\r\n        [data]="comboService.data$ | async"\r\n        [checkOnSelect]="true"\r\n        [selectOnCheck]="true"\r\n        [fixedHeader]="true"\r\n        [showCheckbox]="multiSelect"\r\n        [fit]="true"\r\n        [remoteSort]="false"\r\n        [loadDataType]="loadDataType"\r\n        (nodeSelected)="onSelectRows($event)"\r\n        (nodeUnSelect)="onUnSelectRows($event)"\r\n        (nodeChecked)="onSelectRows($event)"\r\n        (nodeUnChecked)="onUnSelectRows($event)"\r\n        (checkAll)="onCheckAll($event)"\r\n        (unCheckAll)="onCheckAll($event)"\r\n        (expand)="onExpandNode($event)"\r\n        \r\n    ></farris-treetable>\r\n</div>\r\n\x3c!--\r\n    [width]="panelWidth"\r\n    [height]="panelHeight"\r\n     --\x3e',encapsulation:c.ViewEncapsulation.None,providers:[b,u.ComboService,t.LookupUtils]}]}],S.ctorParameters=function(){return[{type:c.ElementRef},{type:c.ChangeDetectorRef},{type:undefined,decorators:[{type:c.Inject,args:[a.DOCUMENT]}]},{type:c.Renderer2},{type:u.ComboService},{type:c.Injector}]},S.propDecorators={showHeader:[{type:c.Input}],useTreeView:[{type:c.Input}],columns:[{type:c.Input}],pagination:[{type:c.Input}],displayType:[{type:c.Input}],expandLevel:[{type:c.Input}],enableFilterRow:[{type:c.Input}],treeCmpRef:[{type:c.ViewChild,args:["tt"]}],tableCmpRef:[{type:c.ViewChild,args:["dt"]}],cascade:[{type:c.Input}],treeInfo:[{type:c.Input}],loadTreeDataType:[{type:c.Input}],enableFullTree:[{type:c.Input}],pageChanged:[{type:c.Output}],pageSizeChanged:[{type:c.Output}],useFormDataMapping:[{type:c.Input}]},S);function S(e,t,i,n,r,o){var a=g.call(this,e,t,i,n,r,o)||this;return a.el=e,a.cdr=t,a.document=i,a.render=n,a.comboService=r,a.injector=o,a.panelHeight=300,a.comPosition={"height.px":a.panelHeight},a.showHeader=!0,a.useTreeView=!1,a.expandLevel=-1,a.enableFilterRow=!1,a.cascade={enable:!1,up:!1,down:!1},a.loadTreeDataType="default",a.enableFullTree=!0,a.pageChanged=new c.EventEmitter,a.pageSizeChanged=new c.EventEmitter,a.useFormDataMapping=!1,a.loadFinish=!1,a.pageInfo={pageSize:20,pageIndex:1,total:0},a.tt$=new s.Subject,a.loaded$=new s.Subject,a._searchKeyWords="",a.loadDataType="all",a.idSer=a.injector.get(l.IdService,null),a.idSer||(a.idSer=new l.IdService),a}var C=(T.decorators=[{type:c.NgModule,args:[{declarations:[v],imports:[a.CommonModule,p.FormsModule,i.DataTableModule,r.TreeTableModule,o.InputGroupModule,d.LoadingModule.forRoot()],exports:[v],providers:[u.ComboLocaleService]}]}],T);function T(){}e.ComboLookupService=h,e.ComboLookupComponent=v,e.ComboLookupModule=C,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=farris-ui-combo-lookup.umd.min.js.map