/**
 * @fileoverview added by tsickle
 * Generated from: lib/bef_variable_manager.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*
 * @Author: Witt
 * @Date: 2019-03-05 19:55:44
 * @Last Modified by: Witt
 * @Last Modified time: 2019-03-13 20:35:29
 */
import { format } from 'date-fns';
import { AppContext, FrameContext } from '@farris/devkit';
import { ChangeDetailType } from './types';
import { BefChangeUtil } from './bef_change_util';
import { Injector, Optional } from '@angular/core';
/**
 * Be变量管理器
 */
var BefVariableManager = /** @class */ (function () {
    /**
     * 构造函数
     */
    function BefVariableManager(appContext, ngVariables, injector) {
        var _this = this;
        this.appContext = appContext;
        this.ngVariables = ngVariables;
        this.injector = injector;
        this.ngVariableMap = new Map();
        this.innerValueMap = new Map();
        // 重新组织变量元数据
        Object.keys(ngVariables).forEach((/**
         * @param {?} propName
         * @return {?}
         */
        function (propName) {
            _this.ngVariableMap.set(propName, ngVariables[propName]);
        }));
    }
    /**
     * 获取变更集
     */
    /**
     * 获取变更集
     * @param {?} changeDetail
     * @return {?}
     */
    BefVariableManager.prototype.handleChangeDetail = /**
     * 获取变更集
     * @param {?} changeDetail
     * @return {?}
     */
    function (changeDetail) {
        var _this = this;
        /** @type {?} */
        var changeInfo = changeDetail.ChangeInfo;
        Object.keys(changeInfo).forEach((/**
         * @param {?} varName
         * @return {?}
         */
        function (varName) {
            // 变量元数据
            /** @type {?} */
            var ngVariable = _this.ngVariableMap.get(varName);
            if (!ngVariable) {
                return;
            }
            /** @type {?} */
            var mapping = ngVariable.mapping;
            // 更新UIState变更
            /** @type {?} */
            var newValue = changeInfo[varName];
            /** @type {?} */
            var oldValue = _this.getValueFromUIState(mapping);
            if (oldValue === newValue) {
                return;
            }
            // 更新值
            _this.setValueToUIState(mapping, newValue);
            _this.innerValueMap.set(varName, newValue);
        }));
    };
    /**
     * Build ChangeDetail instance for all variables.
     */
    /**
     * Build ChangeDetail instance for all variables.
     * @return {?}
     */
    BefVariableManager.prototype.buildChangeDetail = /**
     * Build ChangeDetail instance for all variables.
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var changeDetail = BefChangeUtil.createEmpty(ChangeDetailType.Modify);
        this.ngVariableMap.forEach((/**
         * @param {?} ngVariable
         * @param {?} varName
         * @return {?}
         */
        function (ngVariable, varName) {
            /** @type {?} */
            var mapping = ngVariable.mapping;
            /** @type {?} */
            var newValue = _this.getValueFromUIState(mapping);
            /** @type {?} */
            var oldValue = _this.innerValueMap.get(varName);
            if (_this.isValueEqual(newValue, oldValue) === false) {
                // 不清除变更，请求成功后清除变更
                // this.innerValueMap.set(varName, newValue);
                _this.appendToChangeInfo(changeDetail, varName, newValue);
            }
        }));
        if (Object.keys(changeDetail.ChangeInfo).length === 0) {
            return null;
        }
        return changeDetail;
    };
    /**
     * Clear variable values cached in the innerValueMap property.
     */
    /**
     * Clear variable values cached in the innerValueMap property.
     * @return {?}
     */
    BefVariableManager.prototype.reset = /**
     * Clear variable values cached in the innerValueMap property.
     * @return {?}
     */
    function () {
        this.innerValueMap.clear();
    };
    /**
     * 清空所有vo变量变更集
     */
    /**
     * 清空所有vo变量变更集
     * @return {?}
     */
    BefVariableManager.prototype.clearChanges = /**
     * 清空所有vo变量变更集
     * @return {?}
     */
    function () {
        var _this = this;
        this.ngVariableMap.forEach((/**
         * @param {?} ngVariable
         * @param {?} varName
         * @return {?}
         */
        function (ngVariable, varName) {
            /** @type {?} */
            var mapping = ngVariable.mapping;
            /** @type {?} */
            var newValue = _this.getValueFromUIState(mapping);
            /** @type {?} */
            var oldValue = _this.innerValueMap.get(varName);
            if (_this.isValueEqual(newValue, oldValue) === false) {
                _this.innerValueMap.set(varName, newValue);
            }
        }));
    };
    /**
     * 清空只读vo变更
     * @param changeDetail
     * @returns
     */
    /**
     * 清空只读vo变更
     * @param {?} changeDetail
     * @return {?}
     */
    BefVariableManager.prototype.clearChangeDetail = /**
     * 清空只读vo变更
     * @param {?} changeDetail
     * @return {?}
     */
    function (changeDetail) {
        var _this = this;
        if (!changeDetail || Object.keys(changeDetail.ChangeInfo).length === 0) {
            return;
        }
        Object.keys(changeDetail.ChangeInfo).forEach((/**
         * @param {?} key
         * @return {?}
         */
        function (key) {
            /** @type {?} */
            var ngVariable = _this.ngVariableMap.get(key);
            if (!ngVariable) {
                return;
            }
            /** @type {?} */
            var mapping = ngVariable.mapping;
            /** @type {?} */
            var newValue = _this.getValueFromUIState(mapping);
            _this.innerValueMap.set(key, newValue);
        }));
    };
    /**
     * Append changed variable to ChangeDetail instance.
     */
    /**
     * Append changed variable to ChangeDetail instance.
     * @private
     * @param {?} changeDetail
     * @param {?} varName
     * @param {?} varValue
     * @return {?}
     */
    BefVariableManager.prototype.appendToChangeInfo = /**
     * Append changed variable to ChangeDetail instance.
     * @private
     * @param {?} changeDetail
     * @param {?} varName
     * @param {?} varValue
     * @return {?}
     */
    function (changeDetail, varName, varValue) {
        if (this.isUdtVariable(varValue) === true) {
            /** @type {?} */
            var udtVarChangeDetail = BefChangeUtil.createEmpty(ChangeDetailType.Modify);
            udtVarChangeDetail.ChangeInfo = varValue;
            changeDetail.ChangeInfo[varName] = udtVarChangeDetail;
        }
        else {
            changeDetail.ChangeInfo[varName] = varValue;
        }
    };
    /**
     * 从UIState上获取值
     */
    /**
     * 从UIState上获取值
     * @private
     * @param {?} mapping
     * @return {?}
     */
    BefVariableManager.prototype.getValueFromUIState = /**
     * 从UIState上获取值
     * @private
     * @param {?} mapping
     * @return {?}
     */
    function (mapping) {
        /** @type {?} */
        var uiState = this.getRootUIState();
        // 计算value
        /** @type {?} */
        var mappingArray = mapping.split('.');
        /** @type {?} */
        var value = mappingArray.reduce((/**
         * @param {?} accumulator
         * @param {?} currentValue
         * @return {?}
         */
        function (accumulator, currentValue) {
            return accumulator ? accumulator[currentValue] : null;
        }), uiState);
        if (value instanceof Date) {
            return format(value, 'yyyy-MM-dd HH:mm:ss');
        }
        return value;
    };
    /**
     * 获取根组件上的UIState
     */
    /**
     * 获取根组件上的UIState
     * @private
     * @return {?}
     */
    BefVariableManager.prototype.getRootUIState = /**
     * 获取根组件上的UIState
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var rootFrameContext = this.appContext.frameContextManager.getRootFrameContext();
        if (this.injector) {
            /** @type {?} */
            var frameContext = this.injector.get(FrameContext, null);
            if (frameContext) {
                /** @type {?} */
                var virtualRootFrameContext = frameContext.getVirtualRootFrameContext();
                rootFrameContext = virtualRootFrameContext || rootFrameContext;
            }
        }
        if (!rootFrameContext) {
            return;
        }
        return rootFrameContext.uiState;
    };
    /**
     * 值比较
     * @todo 临时采用这种方式
     */
    /**
     * 值比较
     * \@todo 临时采用这种方式
     * @private
     * @param {?} srcValue
     * @param {?} dstValue
     * @return {?}
     */
    BefVariableManager.prototype.isValueEqual = /**
     * 值比较
     * \@todo 临时采用这种方式
     * @private
     * @param {?} srcValue
     * @param {?} dstValue
     * @return {?}
     */
    function (srcValue, dstValue) {
        return JSON.stringify(srcValue) === JSON.stringify(dstValue);
    };
    /**
     * Check if the object is a plain object
     */
    /**
     * Check if the object is a plain object
     * @private
     * @param {?} obj
     * @return {?}
     */
    BefVariableManager.prototype.isUdtVariable = /**
     * Check if the object is a plain object
     * @private
     * @param {?} obj
     * @return {?}
     */
    function (obj) {
        return obj && obj.constructor &&
            obj.toString() === '[object Object]' &&
            obj.constructor.prototype.hasOwnProperty('isPrototypeOf');
    };
    /**
     * 设置值到UIState
     * @todo：
     * 1、服务器端不支持；
     * 2、日期类型处理方案待定。
     */
    /**
     * 设置值到UIState
     * \@todo：
     * 1、服务器端不支持；
     * 2、日期类型处理方案待定。
     * @private
     * @param {?} mapping
     * @param {?} value
     * @return {?}
     */
    BefVariableManager.prototype.setValueToUIState = /**
     * 设置值到UIState
     * \@todo：
     * 1、服务器端不支持；
     * 2、日期类型处理方案待定。
     * @private
     * @param {?} mapping
     * @param {?} value
     * @return {?}
     */
    function (mapping, value) {
        /** @type {?} */
        var uiState = this.getRootUIState();
        uiState[mapping] = value;
    };
    /** @nocollapse */
    BefVariableManager.ctorParameters = function () { return [
        { type: AppContext },
        { type: undefined },
        { type: Injector, decorators: [{ type: Optional }] }
    ]; };
    return BefVariableManager;
}());
if (false) {
    /**
     * 变量元数据
     * @type {?}
     * @private
     */
    BefVariableManager.prototype.ngVariableMap;
    /**
     * 设置值
     * @type {?}
     * @private
     */
    BefVariableManager.prototype.innerValueMap;
    /**
     * @type {?}
     * @private
     */
    BefVariableManager.prototype.appContext;
    /**
     * @type {?}
     * @private
     */
    BefVariableManager.prototype.ngVariables;
    /**
     * @type {?}
     * @private
     */
    BefVariableManager.prototype.injector;
}
export { BefVariableManager };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVmX3ZhcmlhYmxlX21hbmFnZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2JlZi8iLCJzb3VyY2VzIjpbImxpYi9iZWZfdmFyaWFibGVfbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQU1BLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQVcsTUFBTSxnQkFBZ0IsQ0FBQztBQUNuRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQWdCLE1BQU0sU0FBUyxDQUFDO0FBRXpELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQzs7OztBQU1uRDtJQVlFOztPQUVHO0lBQ0gsNEJBQW9CLFVBQXNCLEVBQVUsV0FBZ0IsRUFBc0IsUUFBa0I7UUFBNUcsaUJBU0M7UUFUbUIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUFVLGdCQUFXLEdBQVgsV0FBVyxDQUFLO1FBQXNCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFFMUcsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLEdBQUcsRUFBc0IsQ0FBQztRQUNuRCxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksR0FBRyxFQUFlLENBQUM7UUFFNUMsWUFBWTtRQUNaLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsT0FBTzs7OztRQUFDLFVBQUMsUUFBZ0I7WUFDaEQsS0FBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQzFELENBQUMsRUFBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHOzs7Ozs7SUFDSSwrQ0FBa0I7Ozs7O0lBQXpCLFVBQTBCLFlBQTBCO1FBQXBELGlCQXFCQzs7WUFwQk8sVUFBVSxHQUFHLFlBQVksQ0FB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LENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDOUQsQ0FBQztJQUdEOzs7OztPQUtHOzs7Ozs7Ozs7OztJQUNLLDhDQUFpQjs7Ozs7Ozs7OztJQUF6QixVQUEwQixPQUFlLEVBQUUsS0FBVTs7WUFDN0MsT0FBTyxHQUFHLElBQUksQ0FBQyxjQUFjLEVBQUU7UUFDckMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEtBQUssQ0FBQztJQUMzQixDQUFDOzs7Z0JBeE1NLFVBQVU7O2dCQUlWLFFBQVEsdUJBcUJ3RCxRQUFROztJQWtMakYseUJBQUM7Q0FBQSxBQWpNRCxJQWlNQzs7Ozs7OztJQTVMQywyQ0FBK0M7Ozs7OztJQUsvQywyQ0FBd0M7Ozs7O0lBSzVCLHdDQUE4Qjs7Ozs7SUFBRSx5Q0FBd0I7Ozs7O0lBQUUsc0NBQXNDOztBQW9MOUcsT0FBTyxFQUFFLGtCQUFrQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiBXaXR0XHJcbiAqIEBEYXRlOiAyMDE5LTAzLTA1IDE5OjU1OjQ0XHJcbiAqIEBMYXN0IE1vZGlmaWVkIGJ5OiBXaXR0XHJcbiAqIEBMYXN0IE1vZGlmaWVkIHRpbWU6IDIwMTktMDMtMTMgMjA6MzU6MjlcclxuICovXHJcbmltcG9ydCB7IGZvcm1hdCB9IGZyb20gJ2RhdGUtZm5zJztcclxuaW1wb3J0IHsgQXBwQ29udGV4dCwgRnJhbWVDb250ZXh0LCBVSVN0YXRlIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBDaGFuZ2VEZXRhaWxUeXBlLCBDaGFuZ2VEZXRhaWwgfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgTmdWYXJpYWJsZSB9IGZyb20gJy4vZGVjb3JhdG9ycyc7XHJcbmltcG9ydCB7IEJlZkNoYW5nZVV0aWwgfSBmcm9tICcuL2JlZl9jaGFuZ2VfdXRpbCc7XHJcbmltcG9ydCB7IEluamVjdG9yLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5cclxuXHJcbi8qKlxyXG4gKiBCZeWPmOmHj+euoeeQhuWZqFxyXG4gKi9cclxuY2xhc3MgQmVmVmFyaWFibGVNYW5hZ2VyIHtcclxuXHJcbiAgLyoqXHJcbiAgICog5Y+Y6YeP5YWD5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBuZ1ZhcmlhYmxlTWFwOiBNYXA8c3RyaW5nLCBOZ1ZhcmlhYmxlPjtcclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572u5YC8XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpbm5lclZhbHVlTWFwOiBNYXA8c3RyaW5nLCBhbnk+O1xyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcENvbnRleHQ6IEFwcENvbnRleHQsIHByaXZhdGUgbmdWYXJpYWJsZXM6IGFueSwgQE9wdGlvbmFsKCkgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuXHJcbiAgICB0aGlzLm5nVmFyaWFibGVNYXAgPSBuZXcgTWFwPHN0cmluZywgTmdWYXJpYWJsZT4oKTtcclxuICAgIHRoaXMuaW5uZXJWYWx1ZU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcblxyXG4gICAgLy8g6YeN5paw57uE57uH5Y+Y6YeP5YWD5pWw5o2uXHJcbiAgICBPYmplY3Qua2V5cyhuZ1ZhcmlhYmxlcykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICB0aGlzLm5nVmFyaWFibGVNYXAuc2V0KHByb3BOYW1lLCBuZ1ZhcmlhYmxlc1twcm9wTmFtZV0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blj5jmm7Tpm4ZcclxuICAgKi9cclxuICBwdWJsaWMgaGFuZGxlQ2hhbmdlRGV0YWlsKGNoYW5nZURldGFpbDogQ2hhbmdlRGV0YWlsKTogdm9pZCB7XHJcbiAgICBjb25zdCBjaGFuZ2VJbmZvID0gY2hhbmdlRGV0YWlsLkNoYW5nZUluZm87XHJcbiAgICBPYmplY3Qua2V5cyhjaGFuZ2VJbmZvKS5mb3JFYWNoKCh2YXJOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgLy8g5Y+Y6YeP5YWD5pWw5o2uXHJcbiAgICAgIGNvbnN0IG5nVmFyaWFibGUgPSB0aGlzLm5nVmFyaWFibGVNYXAuZ2V0KHZhck5hbWUpO1xyXG4gICAgICBpZiAoIW5nVmFyaWFibGUpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgbWFwcGluZyA9IG5nVmFyaWFibGUubWFwcGluZztcclxuXHJcbiAgICAgIC8vIOabtOaWsFVJU3RhdGXlj5jmm7RcclxuICAgICAgY29uc3QgbmV3VmFsdWUgPSBjaGFuZ2VJbmZvW3Zhck5hbWVdO1xyXG4gICAgICBjb25zdCBvbGRWYWx1ZSA9IHRoaXMuZ2V0VmFsdWVGcm9tVUlTdGF0ZShtYXBwaW5nKTtcclxuXHJcbiAgICAgIGlmIChvbGRWYWx1ZSA9PT0gbmV3VmFsdWUpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgLy8g5pu05paw5YC8XHJcbiAgICAgIHRoaXMuc2V0VmFsdWVUb1VJU3RhdGUobWFwcGluZywgbmV3VmFsdWUpO1xyXG4gICAgICB0aGlzLmlubmVyVmFsdWVNYXAuc2V0KHZhck5hbWUsIG5ld1ZhbHVlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQnVpbGQgQ2hhbmdlRGV0YWlsIGluc3RhbmNlIGZvciBhbGwgdmFyaWFibGVzLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBidWlsZENoYW5nZURldGFpbCgpOiBDaGFuZ2VEZXRhaWwge1xyXG4gICAgY29uc3QgY2hhbmdlRGV0YWlsID0gQmVmQ2hhbmdlVXRpbC5jcmVhdGVFbXB0eShDaGFuZ2VEZXRhaWxUeXBlLk1vZGlmeSk7XHJcbiAgICB0aGlzLm5nVmFyaWFibGVNYXAuZm9yRWFjaCgobmdWYXJpYWJsZTogTmdWYXJpYWJsZSwgdmFyTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IG1hcHBpbmcgPSBuZ1ZhcmlhYmxlLm1hcHBpbmc7XHJcbiAgICAgIGNvbnN0IG5ld1ZhbHVlID0gdGhpcy5nZXRWYWx1ZUZyb21VSVN0YXRlKG1hcHBpbmcpO1xyXG4gICAgICBjb25zdCBvbGRWYWx1ZSA9IHRoaXMuaW5uZXJWYWx1ZU1hcC5nZXQodmFyTmFtZSk7XHJcbiAgICAgIGlmICh0aGlzLmlzVmFsdWVFcXVhbChuZXdWYWx1ZSwgb2xkVmFsdWUpID09PSBmYWxzZSkge1xyXG4gICAgICAgIC8vIOS4jea4hemZpOWPmOabtO+8jOivt+axguaIkOWKn+WQjua4hemZpOWPmOabtFxyXG4gICAgICAgIC8vIHRoaXMuaW5uZXJWYWx1ZU1hcC5zZXQodmFyTmFtZSwgbmV3VmFsdWUpO1xyXG4gICAgICAgIHRoaXMuYXBwZW5kVG9DaGFuZ2VJbmZvKGNoYW5nZURldGFpbCwgdmFyTmFtZSwgbmV3VmFsdWUpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoT2JqZWN0LmtleXMoY2hhbmdlRGV0YWlsLkNoYW5nZUluZm8pLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gY2hhbmdlRGV0YWlsO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2xlYXIgdmFyaWFibGUgdmFsdWVzIGNhY2hlZCBpbiB0aGUgaW5uZXJWYWx1ZU1hcCBwcm9wZXJ0eS5cclxuICAgKi9cclxuICBwdWJsaWMgcmVzZXQoKSB7XHJcbiAgICB0aGlzLmlubmVyVmFsdWVNYXAuY2xlYXIoKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5riF56m65omA5pyJdm/lj5jph4/lj5jmm7Tpm4ZcclxuICAgKi9cclxuICBwdWJsaWMgY2xlYXJDaGFuZ2VzKCkge1xyXG4gICAgdGhpcy5uZ1ZhcmlhYmxlTWFwLmZvckVhY2goKG5nVmFyaWFibGU6IE5nVmFyaWFibGUsIHZhck5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBtYXBwaW5nID0gbmdWYXJpYWJsZS5tYXBwaW5nO1xyXG4gICAgICBjb25zdCBuZXdWYWx1ZSA9IHRoaXMuZ2V0VmFsdWVGcm9tVUlTdGF0ZShtYXBwaW5nKTtcclxuICAgICAgY29uc3Qgb2xkVmFsdWUgPSB0aGlzLmlubmVyVmFsdWVNYXAuZ2V0KHZhck5hbWUpO1xyXG4gICAgICBpZiAodGhpcy5pc1ZhbHVlRXF1YWwobmV3VmFsdWUsIG9sZFZhbHVlKSA9PT0gZmFsc2UpIHtcclxuICAgICAgICB0aGlzLmlubmVyVmFsdWVNYXAuc2V0KHZhck5hbWUsIG5ld1ZhbHVlKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOa4heepuuWPquivu3Zv5Y+Y5pu0XHJcbiAgICogQHBhcmFtIGNoYW5nZURldGFpbCBcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgY2xlYXJDaGFuZ2VEZXRhaWwoY2hhbmdlRGV0YWlsOiBDaGFuZ2VEZXRhaWwpIHtcclxuICAgIGlmICghY2hhbmdlRGV0YWlsIHx8IE9iamVjdC5rZXlzKGNoYW5nZURldGFpbC5DaGFuZ2VJbmZvKS5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgT2JqZWN0LmtleXMoY2hhbmdlRGV0YWlsLkNoYW5nZUluZm8pLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5nVmFyaWFibGU6IE5nVmFyaWFibGUgPSB0aGlzLm5nVmFyaWFibGVNYXAuZ2V0KGtleSk7XHJcbiAgICAgIGlmICghbmdWYXJpYWJsZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBtYXBwaW5nID0gbmdWYXJpYWJsZS5tYXBwaW5nO1xyXG4gICAgICBjb25zdCBuZXdWYWx1ZSA9IHRoaXMuZ2V0VmFsdWVGcm9tVUlTdGF0ZShtYXBwaW5nKTtcclxuICAgICAgdGhpcy5pbm5lclZhbHVlTWFwLnNldChrZXksIG5ld1ZhbHVlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiBBcHBlbmQgY2hhbmdlZCB2YXJpYWJsZSB0byBDaGFuZ2VEZXRhaWwgaW5zdGFuY2UuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhcHBlbmRUb0NoYW5nZUluZm8oY2hhbmdlRGV0YWlsOiBDaGFuZ2VEZXRhaWwsIHZhck5hbWU6IHN0cmluZywgdmFyVmFsdWU6IGFueSk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMuaXNVZHRWYXJpYWJsZSh2YXJWYWx1ZSkgPT09IHRydWUpIHtcclxuICAgICAgY29uc3QgdWR0VmFyQ2hhbmdlRGV0YWlsID0gQmVmQ2hhbmdlVXRpbC5jcmVhdGVFbXB0eShDaGFuZ2VEZXRhaWxUeXBlLk1vZGlmeSk7XHJcbiAgICAgIHVkdFZhckNoYW5nZURldGFpbC5DaGFuZ2VJbmZvID0gdmFyVmFsdWU7XHJcbiAgICAgIGNoYW5nZURldGFpbC5DaGFuZ2VJbmZvW3Zhck5hbWVdID0gdWR0VmFyQ2hhbmdlRGV0YWlsO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY2hhbmdlRGV0YWlsLkNoYW5nZUluZm9bdmFyTmFtZV0gPSB2YXJWYWx1ZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOS7jlVJU3RhdGXkuIrojrflj5blgLxcclxuICAgKi9cclxuICBwcml2YXRlIGdldFZhbHVlRnJvbVVJU3RhdGUobWFwcGluZzogc3RyaW5nKTogYW55IHtcclxuICAgIGNvbnN0IHVpU3RhdGUgPSB0aGlzLmdldFJvb3RVSVN0YXRlKCk7XHJcblxyXG4gICAgLy8g6K6h566XdmFsdWVcclxuICAgIGNvbnN0IG1hcHBpbmdBcnJheSA9IG1hcHBpbmcuc3BsaXQoJy4nKTtcclxuICAgIGNvbnN0IHZhbHVlID0gbWFwcGluZ0FycmF5LnJlZHVjZSgoYWNjdW11bGF0b3I6IGFueSwgY3VycmVudFZhbHVlOiBhbnkpID0+IHtcclxuICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yID8gYWNjdW11bGF0b3JbY3VycmVudFZhbHVlXSA6IG51bGw7XHJcbiAgICB9LCB1aVN0YXRlKTtcclxuXHJcbiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBEYXRlKSB7XHJcbiAgICAgIHJldHVybiBmb3JtYXQodmFsdWUsICd5eXl5LU1NLWRkIEhIOm1tOnNzJyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdmFsdWU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bmoLnnu4Tku7bkuIrnmoRVSVN0YXRlXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRSb290VUlTdGF0ZSgpOiBVSVN0YXRlIHtcclxuXHJcbiAgICBsZXQgcm9vdEZyYW1lQ29udGV4dCA9IHRoaXMuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldFJvb3RGcmFtZUNvbnRleHQoKTtcclxuICAgIGlmICh0aGlzLmluamVjdG9yKSB7XHJcbiAgICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuaW5qZWN0b3IuZ2V0PEZyYW1lQ29udGV4dD4oRnJhbWVDb250ZXh0LCBudWxsKTtcclxuICAgICAgaWYgKGZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgIGNvbnN0IHZpcnR1YWxSb290RnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XHJcbiAgICAgICAgcm9vdEZyYW1lQ29udGV4dCA9IHZpcnR1YWxSb290RnJhbWVDb250ZXh0IHx8IHJvb3RGcmFtZUNvbnRleHQ7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGlmICghcm9vdEZyYW1lQ29udGV4dCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcm9vdEZyYW1lQ29udGV4dC51aVN0YXRlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5YC85q+U6L6DXHJcbiAgICogQHRvZG8g5Li05pe26YeH55So6L+Z56eN5pa55byPXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpc1ZhbHVlRXF1YWwoc3JjVmFsdWU6IGFueSwgZHN0VmFsdWU6IGFueSk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHNyY1ZhbHVlKSA9PT0gSlNPTi5zdHJpbmdpZnkoZHN0VmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2hlY2sgaWYgdGhlIG9iamVjdCBpcyBhIHBsYWluIG9iamVjdFxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNVZHRWYXJpYWJsZShvYmo6IGFueSk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIG9iaiAmJiBvYmouY29uc3RydWN0b3IgJiZcclxuICAgICAgb2JqLnRvU3RyaW5nKCkgPT09ICdbb2JqZWN0IE9iamVjdF0nICYmXHJcbiAgICAgIG9iai5jb25zdHJ1Y3Rvci5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkoJ2lzUHJvdG90eXBlT2YnKTtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiDorr7nva7lgLzliLBVSVN0YXRlXHJcbiAgICogQHRvZG/vvJpcclxuICAgKiAx44CB5pyN5Yqh5Zmo56uv5LiN5pSv5oyB77ybXHJcbiAgICogMuOAgeaXpeacn+exu+Wei+WkhOeQhuaWueahiOW+heWumuOAglxyXG4gICAqL1xyXG4gIHByaXZhdGUgc2V0VmFsdWVUb1VJU3RhdGUobWFwcGluZzogc3RyaW5nLCB2YWx1ZTogYW55KTogdm9pZCB7XHJcbiAgICBjb25zdCB1aVN0YXRlID0gdGhpcy5nZXRSb290VUlTdGF0ZSgpO1xyXG4gICAgdWlTdGF0ZVttYXBwaW5nXSA9IHZhbHVlO1xyXG4gIH1cclxuXHJcblxyXG59XHJcblxyXG5leHBvcnQgeyBCZWZWYXJpYWJsZU1hbmFnZXIgfTtcclxuIl19