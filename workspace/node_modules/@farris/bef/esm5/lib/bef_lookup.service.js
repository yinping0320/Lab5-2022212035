/**
 * @fileoverview added by tsickle
 * Generated from: lib/bef_lookup.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, Optional } from '@angular/core';
import { EMPTY } from 'rxjs';
import { switchMap, map, catchError } from 'rxjs/operators';
import { Repository, FrameContext } from '@farris/devkit';
import { LoadingService } from '@farris/ui-loading';
/**
 * 帮助Rest取数服务
 */
var BefLookupRestService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function BefLookupRestService(repository, frameContext) {
        this.frameContext = frameContext;
        this.befRepository = (/** @type {?} */ (repository));
        this.registerDestroyEvent();
        this.loadingService = this.frameContext && this.frameContext.injector.get(LoadingService, null);
    }
    /**
     * @private
     * @return {?}
     */
    BefLookupRestService.prototype.registerDestroyEvent = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.frameContext && this.frameContext.destorySignal) {
            this.frameContext.destorySignal.subscribe((/**
             * @return {?}
             */
            function () {
                _this.frameContext = null;
                _this.befRepository = null;
            }));
        }
    };
    /**
     * @param {?} helpMetadataId
     * @param {?=} data
     * @return {?}
     */
    BefLookupRestService.prototype.getData = /**
     * @param {?} helpMetadataId
     * @param {?=} data
     * @return {?}
     */
    function (helpMetadataId, data) {
        /** @type {?} */
        var tableName = helpMetadataId.split('.')[0];
        /** @type {?} */
        var labelId = helpMetadataId.split('.')[1];
        data = data || {};
        if (this.frameContext) {
            /** @type {?} */
            var primaryValue = this.frameContext.bindingData.list.currentId;
            data['currentForm'] = {
                id: primaryValue
            };
        }
        /** @type {?} */
        var enableExtendLoadMethod = this.ifEnableExtendLoadMethod(helpMetadataId);
        if (enableExtendLoadMethod === true) {
            return this.extendGetHelpData(labelId, tableName, data);
        }
        return this.getHelpData(labelId, tableName, data);
    };
    /**
     * @param {?} data
     * @return {?}
     */
    BefLookupRestService.prototype.saveUserSettings = /**
     * @param {?} data
     * @return {?}
     */
    function (data) {
        var _this = this;
        /** @type {?} */
        var url = '/api/runtime/bcc/v1.0/datagrid/settings';
        return this.befRepository.restService.invoke(url, 'POST', null, { body: data }, false).pipe(catchError((/**
         * @param {?} error
         * @return {?}
         */
        function (error) {
            _this.clearLoading();
            /** @type {?} */
            var formAppContext = _this.befRepository.appContext.getFormAppContext();
            _this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
            return EMPTY;
        })));
    };
    /**
     * @param {?} key
     * @return {?}
     */
    BefLookupRestService.prototype.getUserSettings = /**
     * @param {?} key
     * @return {?}
     */
    function (key) {
        var _this = this;
        /** @type {?} */
        var url = '/api/runtime/bcc/v1.0/datagrid/settings/' + key;
        return this.befRepository.restService.invoke(url, 'GET', null, null, false).pipe(catchError((/**
         * @param {?} error
         * @return {?}
         */
        function (error) {
            _this.clearLoading();
            /** @type {?} */
            var formAppContext = _this.befRepository.appContext.getFormAppContext();
            _this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
            return EMPTY;
        })));
    };
    /**
     * 是否启用扩展取数方法
     */
    /**
     * 是否启用扩展取数方法
     * @private
     * @param {?} helpMetadataId
     * @return {?}
     */
    BefLookupRestService.prototype.ifEnableExtendLoadMethod = /**
     * 是否启用扩展取数方法
     * @private
     * @param {?} helpMetadataId
     * @return {?}
     */
    function (helpMetadataId) {
        // 优先使用context里的设置
        if (this.context && this.context.hasOwnProperty('enableExtendLoadMethod')) {
            return this.context.enableExtendLoadMethod;
        }
        // context没有设置时，继续使用通过指令设置的开关
        /** @type {?} */
        var enableExtendLoadMethod = false;
        if (this.frameContext) {
            /** @type {?} */
            var befApiUrl = this.frameContext.repository.apiUri;
            /** @type {?} */
            var enableKey = helpMetadataId + "@" + befApiUrl;
            enableExtendLoadMethod = this.frameContext.getParam(enableKey);
        }
        return enableExtendLoadMethod;
    };
    /**
     * 老的帮助取树
     */
    /**
     * 老的帮助取树
     * @private
     * @param {?} labelId
     * @param {?} tableName
     * @param {?} data
     * @return {?}
     */
    BefLookupRestService.prototype.getHelpData = /**
     * 老的帮助取树
     * @private
     * @param {?} labelId
     * @param {?} tableName
     * @param {?} data
     * @return {?}
     */
    function (labelId, tableName, data) {
        var _this = this;
        /** @type {?} */
        var url = this.befRepository.restService.baseUri + "/elementhelps/" + labelId;
        /** @type {?} */
        var update$ = this.befRepository.updateDataAndVariableChanges();
        /** @type {?} */
        var result$ = update$.pipe(switchMap((/**
         * @return {?}
         */
        function () {
            _this.extendQueryParam(data);
            // tslint:disable-next-line: max-line-length
            return _this.befRepository.restService.invoke(url, 'GET', { nodeCode: tableName, queryParam: JSON.stringify(data) }, null, false).pipe(catchError((/**
             * @param {?} error
             * @return {?}
             */
            function (error) {
                _this.clearLoading();
                /** @type {?} */
                var formAppContext = _this.befRepository.appContext.getFormAppContext();
                _this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
                return EMPTY;
            })));
        })));
        return result$;
    };
    /**
     * 扩展的帮助取数
     */
    /**
     * 扩展的帮助取数
     * @private
     * @param {?} labelId
     * @param {?} tableName
     * @param {?} data
     * @return {?}
     */
    BefLookupRestService.prototype.extendGetHelpData = /**
     * 扩展的帮助取数
     * @private
     * @param {?} labelId
     * @param {?} tableName
     * @param {?} data
     * @return {?}
     */
    function (labelId, tableName, data) {
        var _this = this;
        /** @type {?} */
        var url = this.befRepository.restService.baseUri + "/extension/elementhelps";
        this.extendQueryParam(data);
        /** @type {?} */
        var body = {
            labelId: labelId,
            nodeCode: tableName,
            queryParam: data,
            requestInfo: this.befRepository.restService.buildRequestInfo()
        };
        /** @type {?} */
        var options = {
            body: body
        };
        /** @type {?} */
        var result$ = this.befRepository.restService.invoke(url, 'PUT', null, options, false, true);
        return result$.pipe(map((/**
         * @param {?} responseInfo
         * @return {?}
         */
        function (responseInfo) {
            return responseInfo && responseInfo.returnValue || null;
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        function (error) {
            _this.clearLoading();
            /** @type {?} */
            var formAppContext = _this.befRepository.appContext.getFormAppContext();
            _this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
            return EMPTY;
        })));
    };
    /**
     * @private
     * @return {?}
     */
    BefLookupRestService.prototype.clearLoading = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.loadingService) {
            this.loadingService.clearAll();
        }
    };
    /**
     * @private
     * @param {?} data
     * @param {?=} layer
     * @param {?=} parentPathCode
     * @return {?}
     */
    BefLookupRestService.prototype.convert2TreeDataWithPathCode = /**
     * @private
     * @param {?} data
     * @param {?=} layer
     * @param {?=} parentPathCode
     * @return {?}
     */
    function (data, layer, parentPathCode) {
        var _this = this;
        if (layer === void 0) { layer = 1; }
        if (parentPathCode === void 0) { parentPathCode = '01'; }
        /** @type {?} */
        var nodes = data.filter((/**
         * @param {?} d
         * @return {?}
         */
        function (d) { return d.layer === layer && d.pathcode === parentPathCode; }));
        if (layer > 1) {
            nodes = data.filter((/**
             * @param {?} d
             * @return {?}
             */
            function (d) { return d.layer === layer && d.pathcode.substr(0, (layer - 1) * 2) === parentPathCode; }));
        }
        if (nodes.length) {
            /** @type {?} */
            var treeNodes = nodes.map((/**
             * @param {?} n
             * @return {?}
             */
            function (n) {
                return {
                    data: n,
                    children: []
                };
            }));
            treeNodes.forEach((/**
             * @param {?} tn
             * @return {?}
             */
            function (tn) {
                var _a;
                /** @type {?} */
                var _tns = _this.convert2TreeDataWithPathCode(data, tn.data.layer + 1, tn.data.pathcode);
                (_a = tn.children).push.apply(_a, tslib_1.__spread(_tns));
            }));
            return treeNodes;
        }
    };
    /**
     * @private
     * @param {?} queryParam
     * @return {?}
     */
    BefLookupRestService.prototype.extendQueryParam = /**
     * @private
     * @param {?} queryParam
     * @return {?}
     */
    function (queryParam) {
        if (queryParam && typeof queryParam === 'object') {
            /** @type {?} */
            var paths = this.getPath();
            queryParam.relationFilterFieldInfo = paths;
        }
    };
    /**
     * @private
     * @return {?}
     */
    BefLookupRestService.prototype.getPath = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var bindingPath = this.frameContext.viewModel.bindingPath;
        /** @type {?} */
        var rid = this.frameContext.viewModel.bindingData.list.currentId;
        // root表数据id
        /** @type {?} */
        var path = rid;
        /** @type {?} */
        var subPaths = bindingPath.split('/').filter((/**
         * @param {?} p
         * @return {?}
         */
        function (p) { return p; }));
        if (subPaths.length > 0) {
            /** @type {?} */
            var subData = this.frameContext.viewModel.bindingData;
            for (var index = 0; index < subPaths.length; index++) {
                /** @type {?} */
                var subPath = subPaths[index];
                subData = subData[subPath];
                if (!subData || !subData.currentId) {
                    throw Error("\u83B7\u53D6\u5B50\u8868\u5B8C\u6574\u8DEF\u5F84\u51FA\u9519\uFF0C\u627E\u4E0D\u5230" + subData + "\u5BF9\u5E94\u7684\u5B50\u8868\uFF0C\u6216\u5BF9\u5E94\u5B50\u8868\u6CA1\u6709\u5F53\u524D\u884C\u3002");
                }
                path += "/" + subPath.substring(0, subPath.length - 1) + "/" + subData.currentId;
            }
            // path += '/' + subPaths[subPaths.length - 1]+'/' + ;
        }
        return path;
    };
    BefLookupRestService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    BefLookupRestService.ctorParameters = function () { return [
        { type: Repository },
        { type: FrameContext, decorators: [{ type: Optional }] }
    ]; };
    return BefLookupRestService;
}());
export { BefLookupRestService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    BefLookupRestService.prototype.loadingService;
    /**
     * @type {?}
     * @private
     */
    BefLookupRestService.prototype.befRepository;
    /**
     * 帮助取数上下文
     * @type {?}
     */
    BefLookupRestService.prototype.context;
    /**
     * @type {?}
     * @private
     */
    BefLookupRestService.prototype.frameContext;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVmX2xvb2t1cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9iZWYvIiwic291cmNlcyI6WyJsaWIvYmVmX2xvb2t1cC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxLQUFLLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDekMsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQU8sVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFakUsT0FBTyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUcxRCxPQUFPLEVBQUUsY0FBYyxFQUFtQyxNQUFNLG9CQUFvQixDQUFDOzs7O0FBSXJGO0lBVUU7O09BRUc7SUFDSCw4QkFDRSxVQUEyQixFQUNQLFlBQTBCO1FBQTFCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBRTlDLElBQUksQ0FBQyxhQUFhLEdBQUcsbUJBQW9CLFVBQVUsRUFBQSxDQUFDO1FBQ3BELElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2xHLENBQUM7Ozs7O0lBQ08sbURBQW9COzs7O0lBQTVCO1FBQUEsaUJBT0M7UUFOQyxJQUFJLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLEVBQUU7WUFDeEQsSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsU0FBUzs7O1lBQUM7Z0JBQ3hDLEtBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO2dCQUN6QixLQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQztZQUM1QixD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OztvQkFDOUMsT0FBTyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUM7Z0JBQy9CLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQzNCLElBQUksQ0FBQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFO29CQUNsQyxNQUFNLEtBQUssQ0FBQyx5RkFBaUIsT0FBTywyR0FBbUIsQ0FBQyxDQUFDO2lCQUMxRDtnQkFDRCxJQUFJLElBQUksTUFBSSxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxTQUFJLE9BQU8sQ0FBQyxTQUFXLENBQUM7YUFDN0U7WUFDRCxzREFBc0Q7U0FDdkQ7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7O2dCQW5NRixVQUFVOzs7O2dCQVBGLFVBQVU7Z0JBQUUsWUFBWSx1QkFzQjVCLFFBQVE7O0lBcUxiLDJCQUFDO0NBQUEsQUFwTUQsSUFvTUM7U0FuTVksb0JBQW9COzs7Ozs7SUFDL0IsOENBQXVDOzs7OztJQUN2Qyw2Q0FBMEM7Ozs7O0lBSzFDLHVDQUFvQjs7Ozs7SUFPbEIsNENBQThDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRU1QVFksIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgc3dpdGNoTWFwLCBtYXAsIHRhcCwgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgSUxvb2t1cEh0dHBTZXJ2aWNlLCBSZW1vdGVQYXJhbXMsIExvb2t1cEdyaWRSZXN1bHQgfSBmcm9tICdAZmFycmlzL3VpLWxvb2t1cCc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnksIEZyYW1lQ29udGV4dCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSB9IGZyb20gJy4vYmVmX3JlcG9zaXRvcnknO1xyXG5pbXBvcnQgeyBSZXNwb25zZUluZm8gfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgTG9hZGluZ1NlcnZpY2UsIExvYWRpbmdDb25maWcsIExvYWRpbmdDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWxvYWRpbmcnO1xyXG4vKipcclxuICog5biu5YqpUmVzdOWPluaVsOacjeWKoVxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQmVmTG9va3VwUmVzdFNlcnZpY2UgaW1wbGVtZW50cyBJTG9va3VwSHR0cFNlcnZpY2Uge1xyXG4gIHByaXZhdGUgbG9hZGluZ1NlcnZpY2U6IExvYWRpbmdTZXJ2aWNlO1xyXG4gIHByaXZhdGUgYmVmUmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxhbnk+O1xyXG5cclxuICAvKipcclxuICAgKiDluK7liqnlj5bmlbDkuIrkuIvmlodcclxuICAgKi9cclxuICBwdWJsaWMgY29udGV4dDogYW55O1xyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55PixcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHRcclxuICApIHtcclxuICAgIHRoaXMuYmVmUmVwb3NpdG9yeSA9IDxCZWZSZXBvc2l0b3J5PGFueT4+cmVwb3NpdG9yeTtcclxuICAgIHRoaXMucmVnaXN0ZXJEZXN0cm95RXZlbnQoKTtcclxuICAgIHRoaXMubG9hZGluZ1NlcnZpY2UgPSB0aGlzLmZyYW1lQ29udGV4dCAmJiB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQoTG9hZGluZ1NlcnZpY2UsIG51bGwpO1xyXG4gIH1cclxuICBwcml2YXRlIHJlZ2lzdGVyRGVzdHJveUV2ZW50KCkge1xyXG4gICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmRlc3RvcnlTaWduYWwpIHtcclxuICAgICAgdGhpcy5mcmFtZUNvbnRleHQuZGVzdG9yeVNpZ25hbC5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuZnJhbWVDb250ZXh0ID0gbnVsbDtcclxuICAgICAgICB0aGlzLmJlZlJlcG9zaXRvcnkgPSBudWxsO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXREYXRhKGhlbHBNZXRhZGF0YUlkOiBzdHJpbmcsIGRhdGE/OiBSZW1vdGVQYXJhbXMpOiBPYnNlcnZhYmxlPExvb2t1cEdyaWRSZXN1bHQ+IHtcclxuICAgIGNvbnN0IHRhYmxlTmFtZSA9IGhlbHBNZXRhZGF0YUlkLnNwbGl0KCcuJylbMF07XHJcbiAgICBjb25zdCBsYWJlbElkID0gaGVscE1ldGFkYXRhSWQuc3BsaXQoJy4nKVsxXTtcclxuICAgIGRhdGEgPSBkYXRhIHx8IHt9O1xyXG4gICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIGNvbnN0IHByaW1hcnlWYWx1ZSA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkO1xyXG4gICAgICBkYXRhWydjdXJyZW50Rm9ybSddID0ge1xyXG4gICAgICAgIGlkOiBwcmltYXJ5VmFsdWVcclxuICAgICAgfTtcclxuICAgIH1cclxuICAgIGNvbnN0IGVuYWJsZUV4dGVuZExvYWRNZXRob2QgPSB0aGlzLmlmRW5hYmxlRXh0ZW5kTG9hZE1ldGhvZChoZWxwTWV0YWRhdGFJZCk7XHJcbiAgICBpZiAoZW5hYmxlRXh0ZW5kTG9hZE1ldGhvZCA9PT0gdHJ1ZSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5leHRlbmRHZXRIZWxwRGF0YShsYWJlbElkLCB0YWJsZU5hbWUsIGRhdGEpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuZ2V0SGVscERhdGEobGFiZWxJZCwgdGFibGVOYW1lLCBkYXRhKTtcclxuICB9XHJcbiAgcHVibGljIHNhdmVVc2VyU2V0dGluZ3MoZGF0YSkge1xyXG4gICAgY29uc3QgdXJsID0gJy9hcGkvcnVudGltZS9iY2MvdjEuMC9kYXRhZ3JpZC9zZXR0aW5ncyc7XHJcbiAgICByZXR1cm4gdGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmludm9rZSh1cmwsICdQT1NUJywgbnVsbCwgeyBib2R5OiBkYXRhIH0sIGZhbHNlKS5waXBlKFxyXG4gICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcclxuICAgICAgICB0aGlzLmNsZWFyTG9hZGluZygpO1xyXG4gICAgICAgIGNvbnN0IGZvcm1BcHBDb250ZXh0ID0gdGhpcy5iZWZSZXBvc2l0b3J5LmFwcENvbnRleHQuZ2V0Rm9ybUFwcENvbnRleHQoKTtcclxuICAgICAgICB0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuZXZlbnRCdXMucG9zdCgnRXhjZXB0aW9uJywgJycsICdvbkV4Y2VwdGlvbicsIGVycm9yLCBmb3JtQXBwQ29udGV4dCk7XHJcbiAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXRVc2VyU2V0dGluZ3Moa2V5KSB7XHJcbiAgICBjb25zdCB1cmwgPSAnL2FwaS9ydW50aW1lL2JjYy92MS4wL2RhdGFncmlkL3NldHRpbmdzLycgKyBrZXk7XHJcbiAgICByZXR1cm4gdGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmludm9rZSh1cmwsICdHRVQnLCBudWxsLCBudWxsLCBmYWxzZSkucGlwZShcclxuICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XHJcbiAgICAgICAgdGhpcy5jbGVhckxvYWRpbmcoKTtcclxuICAgICAgICBjb25zdCBmb3JtQXBwQ29udGV4dCA9IHRoaXMuYmVmUmVwb3NpdG9yeS5hcHBDb250ZXh0LmdldEZvcm1BcHBDb250ZXh0KCk7XHJcbiAgICAgICAgdGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmV2ZW50QnVzLnBvc3QoJ0V4Y2VwdGlvbicsICcnLCAnb25FeGNlcHRpb24nLCBlcnJvciwgZm9ybUFwcENvbnRleHQpO1xyXG4gICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmmK/lkKblkK/nlKjmianlsZXlj5bmlbDmlrnms5VcclxuICAgKi9cclxuICBwcml2YXRlIGlmRW5hYmxlRXh0ZW5kTG9hZE1ldGhvZChoZWxwTWV0YWRhdGFJZDogc3RyaW5nKSB7XHJcblxyXG4gICAgLy8g5LyY5YWI5L2/55SoY29udGV4dOmHjOeahOiuvue9rlxyXG4gICAgaWYgKHRoaXMuY29udGV4dCAmJiB0aGlzLmNvbnRleHQuaGFzT3duUHJvcGVydHkoJ2VuYWJsZUV4dGVuZExvYWRNZXRob2QnKSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0LmVuYWJsZUV4dGVuZExvYWRNZXRob2Q7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gY29udGV4dOayoeacieiuvue9ruaXtu+8jOe7p+e7reS9v+eUqOmAmui/h+aMh+S7pOiuvue9rueahOW8gOWFs1xyXG4gICAgbGV0IGVuYWJsZUV4dGVuZExvYWRNZXRob2QgPSBmYWxzZTtcclxuICAgIGlmICh0aGlzLmZyYW1lQ29udGV4dCkge1xyXG4gICAgICBjb25zdCBiZWZBcGlVcmwgPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmFwaVVyaTtcclxuICAgICAgY29uc3QgZW5hYmxlS2V5ID0gYCR7aGVscE1ldGFkYXRhSWR9QCR7YmVmQXBpVXJsfWA7XHJcbiAgICAgIGVuYWJsZUV4dGVuZExvYWRNZXRob2QgPSB0aGlzLmZyYW1lQ29udGV4dC5nZXRQYXJhbShlbmFibGVLZXkpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGVuYWJsZUV4dGVuZExvYWRNZXRob2Q7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDogIHnmoTluK7liqnlj5bmoJFcclxuICAgKi9cclxuICBwcml2YXRlIGdldEhlbHBEYXRhKGxhYmVsSWQ6IHN0cmluZywgdGFibGVOYW1lOiBzdHJpbmcsIGRhdGE6IGFueSk6IE9ic2VydmFibGU8TG9va3VwR3JpZFJlc3VsdD4ge1xyXG4gICAgY29uc3QgdXJsID0gYCR7dGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmJhc2VVcml9L2VsZW1lbnRoZWxwcy8ke2xhYmVsSWR9YDtcclxuICAgIGNvbnN0IHVwZGF0ZSQgPSB0aGlzLmJlZlJlcG9zaXRvcnkudXBkYXRlRGF0YUFuZFZhcmlhYmxlQ2hhbmdlcygpO1xyXG5cclxuICAgIGNvbnN0IHJlc3VsdCQgPSB1cGRhdGUkLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5leHRlbmRRdWVyeVBhcmFtKGRhdGEpO1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbWF4LWxpbmUtbGVuZ3RoXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5pbnZva2UodXJsLCAnR0VUJywgeyBub2RlQ29kZTogdGFibGVOYW1lLCBxdWVyeVBhcmFtOiBKU09OLnN0cmluZ2lmeShkYXRhKSB9LCBudWxsLCBmYWxzZSkucGlwZShcclxuICAgICAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmNsZWFyTG9hZGluZygpO1xyXG4gICAgICAgICAgICBjb25zdCBmb3JtQXBwQ29udGV4dCA9IHRoaXMuYmVmUmVwb3NpdG9yeS5hcHBDb250ZXh0LmdldEZvcm1BcHBDb250ZXh0KCk7XHJcbiAgICAgICAgICAgIHRoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5ldmVudEJ1cy5wb3N0KCdFeGNlcHRpb24nLCAnJywgJ29uRXhjZXB0aW9uJywgZXJyb3IsIGZvcm1BcHBDb250ZXh0KTtcclxuICAgICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICApO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICAgIHJldHVybiByZXN1bHQkO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5omp5bGV55qE5biu5Yqp5Y+W5pWwXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBleHRlbmRHZXRIZWxwRGF0YShsYWJlbElkOiBzdHJpbmcsIHRhYmxlTmFtZTogc3RyaW5nLCBkYXRhOiBhbnkpOiBPYnNlcnZhYmxlPExvb2t1cEdyaWRSZXN1bHQ+IHtcclxuICAgIGNvbnN0IHVybCA9IGAke3RoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5iYXNlVXJpfS9leHRlbnNpb24vZWxlbWVudGhlbHBzYDtcclxuICAgIHRoaXMuZXh0ZW5kUXVlcnlQYXJhbShkYXRhKTtcclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgIGxhYmVsSWQ6IGxhYmVsSWQsXHJcbiAgICAgIG5vZGVDb2RlOiB0YWJsZU5hbWUsXHJcbiAgICAgIHF1ZXJ5UGFyYW06IGRhdGEsXHJcbiAgICAgIHJlcXVlc3RJbmZvOiB0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgYm9keTogYm9keVxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCByZXN1bHQkID0gdGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmludm9rZSh1cmwsICdQVVQnLCBudWxsLCBvcHRpb25zLCBmYWxzZSwgdHJ1ZSk7XHJcbiAgICByZXR1cm4gcmVzdWx0JC5waXBlKFxyXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlSW5mbyAmJiByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUgfHwgbnVsbDtcclxuICAgICAgfSksXHJcbiAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xyXG4gICAgICAgIHRoaXMuY2xlYXJMb2FkaW5nKCk7XHJcbiAgICAgICAgY29uc3QgZm9ybUFwcENvbnRleHQgPSB0aGlzLmJlZlJlcG9zaXRvcnkuYXBwQ29udGV4dC5nZXRGb3JtQXBwQ29udGV4dCgpO1xyXG4gICAgICAgIHRoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5ldmVudEJ1cy5wb3N0KCdFeGNlcHRpb24nLCAnJywgJ29uRXhjZXB0aW9uJywgZXJyb3IsIGZvcm1BcHBDb250ZXh0KTtcclxuICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgIH1cclxuICAgICAgKSxcclxuICAgICk7XHJcbiAgfVxyXG4gIHByaXZhdGUgY2xlYXJMb2FkaW5nKCkge1xyXG4gICAgaWYgKHRoaXMubG9hZGluZ1NlcnZpY2UpIHtcclxuICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5jbGVhckFsbCgpO1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIGNvbnZlcnQyVHJlZURhdGFXaXRoUGF0aENvZGUoZGF0YTogYW55W10sIGxheWVyID0gMSwgcGFyZW50UGF0aENvZGUgPSAnMDEnKSB7XHJcbiAgICBsZXQgbm9kZXMgPSBkYXRhLmZpbHRlcihkID0+IGQubGF5ZXIgPT09IGxheWVyICYmIGQucGF0aGNvZGUgPT09IHBhcmVudFBhdGhDb2RlKTtcclxuICAgIGlmIChsYXllciA+IDEpIHtcclxuICAgICAgbm9kZXMgPSBkYXRhLmZpbHRlcihkID0+IGQubGF5ZXIgPT09IGxheWVyICYmIGQucGF0aGNvZGUuc3Vic3RyKDAsIChsYXllciAtIDEpICogMikgPT09IHBhcmVudFBhdGhDb2RlKTtcclxuICAgIH1cclxuICAgIGlmIChub2Rlcy5sZW5ndGgpIHtcclxuICAgICAgY29uc3QgdHJlZU5vZGVzID0gbm9kZXMubWFwKG4gPT4ge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBkYXRhOiBuLFxyXG4gICAgICAgICAgY2hpbGRyZW46IFtdXHJcbiAgICAgICAgfTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0cmVlTm9kZXMuZm9yRWFjaCh0biA9PiB7XHJcbiAgICAgICAgY29uc3QgX3RucyA9IHRoaXMuY29udmVydDJUcmVlRGF0YVdpdGhQYXRoQ29kZShkYXRhLCB0bi5kYXRhLmxheWVyICsgMSwgdG4uZGF0YS5wYXRoY29kZSk7XHJcbiAgICAgICAgdG4uY2hpbGRyZW4ucHVzaCguLi5fdG5zKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICByZXR1cm4gdHJlZU5vZGVzO1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIGV4dGVuZFF1ZXJ5UGFyYW0ocXVlcnlQYXJhbTogYW55KSB7XHJcbiAgICBpZiAocXVlcnlQYXJhbSAmJiB0eXBlb2YgcXVlcnlQYXJhbSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgY29uc3QgcGF0aHMgPSB0aGlzLmdldFBhdGgoKTtcclxuICAgICAgcXVlcnlQYXJhbS5yZWxhdGlvbkZpbHRlckZpZWxkSW5mbyA9IHBhdGhzO1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIGdldFBhdGgoKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gdGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoO1xyXG4gICAgY29uc3QgcmlkID0gdGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkOyAvLyByb2906KGo5pWw5o2uaWRcclxuICAgIGxldCBwYXRoID0gcmlkO1xyXG5cclxuICAgIGNvbnN0IHN1YlBhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgIGlmIChzdWJQYXRocy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGxldCBzdWJEYXRhOiBhbnkgPSB0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ0RhdGE7XHJcbiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBzdWJQYXRocy5sZW5ndGg7IGluZGV4KyspIHtcclxuICAgICAgICBjb25zdCBzdWJQYXRoID0gc3ViUGF0aHNbaW5kZXhdO1xyXG4gICAgICAgIHN1YkRhdGEgPSBzdWJEYXRhW3N1YlBhdGhdO1xyXG4gICAgICAgIGlmICghc3ViRGF0YSB8fCAhc3ViRGF0YS5jdXJyZW50SWQpIHtcclxuICAgICAgICAgIHRocm93IEVycm9yKGDojrflj5blrZDooajlrozmlbTot6/lvoTlh7rplJnvvIzmib7kuI3liLAke3N1YkRhdGF95a+55bqU55qE5a2Q6KGo77yM5oiW5a+55bqU5a2Q6KGo5rKh5pyJ5b2T5YmN6KGM44CCYCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHBhdGggKz0gYC8ke3N1YlBhdGguc3Vic3RyaW5nKDAsIHN1YlBhdGgubGVuZ3RoIC0gMSl9LyR7c3ViRGF0YS5jdXJyZW50SWR9YDtcclxuICAgICAgfVxyXG4gICAgICAvLyBwYXRoICs9ICcvJyArIHN1YlBhdGhzW3N1YlBhdGhzLmxlbmd0aCAtIDFdKycvJyArIDtcclxuICAgIH1cclxuICAgIHJldHVybiBwYXRoO1xyXG4gIH1cclxufSJdfQ==