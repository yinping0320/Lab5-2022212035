/**
 * @fileoverview added by tsickle
 * Generated from: lib/bef_change_builder.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*
 * @Author: Witt
 * @Date: 2018-10-19 15:35:39
 * @Last Modified by: Witt
 * @Last Modified time: 2018-11-18 16:15:47
 */
import { ModifyType } from '@farris/devkit';
import { ChangeDetailType } from './types';
import { EntityUtil } from './entity_util';
/**
 * BEF变更集构造器
 */
class BefChangeBuilder {
    /**
     * 构造函数
     * @param {?} entityType 实体类型
     * @param {?} entityCollection
     */
    constructor(entityType, entityCollection) {
        this.entityType = entityType;
        this.entityCollection = entityCollection;
    }
    /**
     * 构造Bef变更集
     * @param {?} modifications
     * @return {?}
     */
    build(modifications) {
        // 重置changeDetail
        this.changeDetail = {
            ChangeType: ChangeDetailType.Modify,
            ChangeInfo: {
                DataId: ''
            }
        };
        modifications.forEach((/**
         * @param {?} modification
         * @return {?}
         */
        modification => {
            this.buildChangeDetail(modification);
        }));
        return this.changeDetail;
    }
    /**
     * 构造Bef变更详情
     * @param {?} modification
     * @return {?}
     */
    buildChangeDetail(modification) {
        /** @type {?} */
        const paths = modification.path.concat();
        // 设置根节点DataId
        if (!this.changeDetail.ChangeInfo.DataId) {
            this.changeDetail.ChangeInfo.DataId = paths[0].split(':')[1];
        }
        /** @type {?} */
        let parentChangeDetail = this.changeDetail;
        /** @type {?} */
        let parentEntityType = this.entityType;
        for (let i = 1; i < paths.length && parentChangeDetail; i = i + 2) {
            /** @type {?} */
            const parentChangeInfo = this.getChangeInfo(parentChangeDetail);
            /** @type {?} */
            const propName = paths[i];
            const { propType, propEntityType, propMetadata } = EntityUtil.getPropInfo(parentEntityType, propName);
            /** @type {?} */
            const dataField = propMetadata.dataField || propName;
            if (propType === 'NgField') {
                // 不支持主键变更，忽略
                /** @type {?} */
                const primaryKey = EntityUtil.getPrimaryKey(parentEntityType);
                if (propName === primaryKey) {
                    continue;
                }
                if (modification.type !== ModifyType.ValueChange) {
                    throw Error('简单类型的属性上不支持ValueChange类型之外的变更');
                }
                // NgField类型：说明是最后一级
                parentChangeInfo[dataField] = modification.value;
                parentChangeDetail = null;
            }
            else if (propType === 'NgObject') {
                // NgObject属性本身无法触发变更，只有它的子节点才能触发，所以它上边的变更永远是Modify类型的。
                /** @type {?} */
                const childId = paths[i + 1].split(':')[1];
                /** @type {?} */
                const childIdName = paths[i + 1].split(':')[0];
                if (childIdName) {
                    // 有主键（关联对象）：是一个普通的对象
                    /** @type {?} */
                    let changeObject = parentChangeInfo[dataField];
                    // 获取数据
                    /** @type {?} */
                    const entityPath = paths.slice(0, i + 1);
                    /** @type {?} */
                    const changedEntity = this.entityCollection.getEntityByPath(entityPath);
                    changeObject = changedEntity ? changedEntity.toJSON(true) : {};
                    parentChangeInfo[dataField] = changeObject;
                    parentChangeDetail = null;
                    parentEntityType = null;
                }
                else {
                    // 没有主键（值对象）：是一个完整的ChangeDetail
                    /** @type {?} */
                    let changeDetail = (/** @type {?} */ (parentChangeInfo[dataField]));
                    if (!changeDetail) {
                        changeDetail = {
                            ChangeType: ChangeDetailType.Modify,
                            ChangeInfo: {}
                        };
                    }
                    parentChangeInfo[dataField] = changeDetail;
                    parentChangeDetail = changeDetail;
                    parentEntityType = propEntityType;
                }
            }
            else if (propType === 'NgList') {
                // 如果不存在则创建一个空数组
                if (!parentChangeDetail.ChangeInfo[dataField]) {
                    parentChangeDetail.ChangeInfo[dataField] = [];
                }
                /** @type {?} */
                const changeDetails = (/** @type {?} */ (parentChangeDetail.ChangeInfo[dataField]));
                // 如果这个属性，不是叶子节点，需要查找当前属性是否已经存在对应ChangeDetail：
                // 1、不存在：创建一个Modify类型的ChangeDetail；
                // 2、存在：返回查找到的ChangeDetai，这个ChangeDetail可能是一个Add类型也可能是一个Modify类型；
                // 3、现状：目前BEF不支持Add类型的变更，肯定是一个Modify类型的变更。
                if (i !== paths.length - 1) {
                    // 遍历检查变更是否已经存在
                    /** @type {?} */
                    const dataId = paths[i + 1].split(':')[1];
                    /** @type {?} */
                    let changeDetail = changeDetails.find((/**
                     * @param {?} changeDetailItem
                     * @return {?}
                     */
                    changeDetailItem => {
                        return changeDetailItem.ChangeInfo.DataId === dataId;
                    }));
                    // 如果不存在，则创建并添加
                    if (!changeDetail) {
                        changeDetail = this.createEmptyChangeDetail(ChangeDetailType.Modify, dataId);
                        changeDetails.push(changeDetail);
                    }
                    parentChangeDetail = changeDetail;
                    parentEntityType = propEntityType;
                    continue;
                }
                // 如果是叶子节点，则肯定是新增或者删除变更。
                if (modification.type === ModifyType.Add || modification.type === ModifyType.Insert) {
                    // // 遍历添加
                    // modification.value.forEach((entity: any) => {
                    //   this.addAddChangeDetail(changeDetails, entity.toJSON(), propEntityType);
                    // });
                }
                else if (modification.type === ModifyType.Remove) {
                    // @todo：删除变更直接向服务器端提交了，不需要再次提交
                    // 遍历变更集，添加移除变更
                    // modification.value.forEach((entityData) => {
                    //   this.addRemoveChangeDetail(changeDetails, entityData, propEntityType);
                    // });
                }
                // 重置
                parentChangeDetail = null;
                parentEntityType = null;
            }
            else if (propType === 'NgDynamic') {
                // 获取数据
                /** @type {?} */
                const entityPath = paths.slice(0, i + 1);
                /** @type {?} */
                const changedEntity = this.entityCollection.getEntityByPath(entityPath);
                parentChangeInfo[dataField] = {
                    ChangeType: ChangeDetailType.Modify,
                    ChangeInfo: changedEntity ? changedEntity.toJSON(true) : {}
                };
                parentChangeDetail = null;
                parentEntityType = null;
            }
        }
    }
    /**
     * 获取变更信息
     * 在整个ChangeDetail树上，存在两种类型的节点
     * ChangeDetail：实体变更、值对象变更（没有DataID）
     * PlainObject: 关联对象的变更
     * 从这两种节点上拿具体变更信息的时候，需要统一处理，屏蔽这个差异。
     * \@todo：为这两种节点封装ChangeNode基类来解决这个差异。
     * @private
     * @param {?} changeDetail
     * @return {?}
     */
    getChangeInfo(changeDetail) {
        // @todo：可能存在同名属性
        if (changeDetail.hasOwnProperty('ChangeInfo')) {
            return changeDetail.ChangeInfo;
        }
        else {
            return changeDetail;
        }
    }
    /**
     * 创建ChangeDetail
     * @private
     * @param {?} type BEF变更类型
     * @param {?} dataId 数据内码
     * @return {?}
     */
    createEmptyChangeDetail(type, dataId) {
        /** @type {?} */
        const changeDetail = {
            ChangeType: type,
            ChangeInfo: {
                DataId: dataId
            }
        };
        return changeDetail;
    }
}
if (false) {
    /**
     * Bef变更集
     * @type {?}
     */
    BefChangeBuilder.prototype.changeDetail;
    /**
     * @type {?}
     * @private
     */
    BefChangeBuilder.prototype.entityType;
    /**
     * @type {?}
     * @private
     */
    BefChangeBuilder.prototype.entityCollection;
}
export { BefChangeBuilder };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVmX2NoYW5nZV9idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9iZWYvIiwic291cmNlcyI6WyJsaWIvYmVmX2NoYW5nZV9idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBUUEsT0FBTyxFQUFnQixVQUFVLEVBQStDLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkcsT0FBTyxFQUFFLGdCQUFnQixFQUFnQixNQUFNLFNBQVMsQ0FBQztBQUN6RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDOzs7O0FBTTNDLE1BQU0sZ0JBQWdCOzs7Ozs7SUFXcEIsWUFDVSxVQUF3QixFQUN4QixnQkFBMEM7UUFEMUMsZUFBVSxHQUFWLFVBQVUsQ0FBYztRQUN4QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQTBCO0lBRXBELENBQUM7Ozs7OztJQU1NLEtBQUssQ0FBQyxhQUE2QjtRQUV4QyxpQkFBaUI7UUFDakIsSUFBSSxDQUFDLFlBQVksR0FBRztZQUNsQixVQUFVLEVBQUUsZ0JBQWdCLENBQUMsTUFBTTtZQUNuQyxVQUFVLEVBQUU7Z0JBQ1YsTUFBTSxFQUFFLEVBQUU7YUFDWDtTQUNGLENBQUM7UUFFRixhQUFhLENBQUMsT0FBTzs7OztRQUFDLFlBQVksQ0FBQyxFQUFFO1lBQ25DLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUN2QyxDQUFDLEVBQUMsQ0FBQztRQUVILE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQztJQUMzQixDQUFDOzs7Ozs7SUFLTSxpQkFBaUIsQ0FBQyxZQUEwQjs7Y0FFM0MsS0FBSyxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO1FBRXhDLGNBQWM7UUFDZCxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFO1lBQ3hDLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMs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NENBQWtEOztBQXVNdEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiBXaXR0XHJcbiAqIEBEYXRlOiAyMDE4LTEwLTE5IDE1OjM1OjM5XHJcbiAqIEBMYXN0IE1vZGlmaWVkIGJ5OiBXaXR0XHJcbiAqIEBMYXN0IE1vZGlmaWVkIHRpbWU6IDIwMTgtMTEtMTggMTY6MTU6NDdcclxuICovXHJcblxyXG5pbXBvcnQgeyBUeXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE1vZGlmaWNhdGlvbiwgTW9kaWZ5VHlwZSwgRW50aXR5LCBFbnRpdHlDb2xsZWN0aW9uLCBGaWVsZE1ldGFkYXRhVXRpbCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgQ2hhbmdlRGV0YWlsVHlwZSwgQ2hhbmdlRGV0YWlsIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IEVudGl0eVV0aWwgfSBmcm9tICcuL2VudGl0eV91dGlsJztcclxuXHJcblxyXG4vKipcclxuICogQkVG5Y+Y5pu06ZuG5p6E6YCg5ZmoXHJcbiAqL1xyXG5jbGFzcyBCZWZDaGFuZ2VCdWlsZGVyIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQmVm5Y+Y5pu06ZuGXHJcbiAgICovXHJcbiAgcHVibGljIGNoYW5nZURldGFpbDogQ2hhbmdlRGV0YWlsO1xyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKiBAcGFyYW0gZW50aXR5VHlwZSDlrp7kvZPnsbvlnotcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgZW50aXR5VHlwZTogVHlwZTxFbnRpdHk+LFxyXG4gICAgcHJpdmF0ZSBlbnRpdHlDb2xsZWN0aW9uOiBFbnRpdHlDb2xsZWN0aW9uPEVudGl0eT5cclxuICApIHtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoEJlZuWPmOabtOmbhlxyXG4gICAqIEBwYXJhbSBtb2RpZmljYXRpb25zXHJcbiAgICovXHJcbiAgcHVibGljIGJ1aWxkKG1vZGlmaWNhdGlvbnM6IE1vZGlmaWNhdGlvbltdKTogQ2hhbmdlRGV0YWlsIHtcclxuXHJcbiAgICAvLyDph43nva5jaGFuZ2VEZXRhaWxcclxuICAgIHRoaXMuY2hhbmdlRGV0YWlsID0ge1xyXG4gICAgICBDaGFuZ2VUeXBlOiBDaGFuZ2VEZXRhaWxUeXBlLk1vZGlmeSxcclxuICAgICAgQ2hhbmdlSW5mbzoge1xyXG4gICAgICAgIERhdGFJZDogJydcclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBtb2RpZmljYXRpb25zLmZvckVhY2gobW9kaWZpY2F0aW9uID0+IHtcclxuICAgICAgdGhpcy5idWlsZENoYW5nZURldGFpbChtb2RpZmljYXRpb24pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuY2hhbmdlRGV0YWlsO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCgQmVm5Y+Y5pu06K+m5oOFXHJcbiAgICovXHJcbiAgcHVibGljIGJ1aWxkQ2hhbmdlRGV0YWlsKG1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSB7XHJcblxyXG4gICAgY29uc3QgcGF0aHMgPSBtb2RpZmljYXRpb24ucGF0aC5jb25jYXQoKTtcclxuXHJcbiAgICAvLyDorr7nva7moLnoioLngrlEYXRhSWRcclxuICAgIGlmICghdGhpcy5jaGFuZ2VEZXRhaWwuQ2hhbmdlSW5mby5EYXRhSWQpIHtcclxuICAgICAgdGhpcy5jaGFuZ2VEZXRhaWwuQ2hhbmdlSW5mby5EYXRhSWQgPSBwYXRoc1swXS5zcGxpdCgnOicpWzFdO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBwYXJlbnRDaGFuZ2VEZXRhaWwgPSB0aGlzLmNoYW5nZURldGFpbDtcclxuICAgIGxldCBwYXJlbnRFbnRpdHlUeXBlID0gdGhpcy5lbnRpdHlUeXBlO1xyXG5cclxuICAgIGZvciAobGV0IGkgPSAxOyBpIDwgcGF0aHMubGVuZ3RoICYmIHBhcmVudENoYW5nZURldGFpbDsgaSA9IGkgKyAyKSB7XHJcblxyXG4gICAgICBjb25zdCBwYXJlbnRDaGFuZ2VJbmZvID0gdGhpcy5nZXRDaGFuZ2VJbmZvKHBhcmVudENoYW5nZURldGFpbCk7XHJcbiAgICAgIGNvbnN0IHByb3BOYW1lID0gcGF0aHNbaV07XHJcbiAgICAgIGNvbnN0IHsgcHJvcFR5cGUsIHByb3BFbnRpdHlUeXBlLCBwcm9wTWV0YWRhdGEgfSA9IEVudGl0eVV0aWwuZ2V0UHJvcEluZm8ocGFyZW50RW50aXR5VHlwZSwgcHJvcE5hbWUpO1xyXG4gICAgICBjb25zdCBkYXRhRmllbGQgPSBwcm9wTWV0YWRhdGEuZGF0YUZpZWxkIHx8IHByb3BOYW1lO1xyXG5cclxuICAgICAgaWYgKHByb3BUeXBlID09PSAnTmdGaWVsZCcpIHtcclxuXHJcbiAgICAgICAgLy8g5LiN5pSv5oyB5Li76ZSu5Y+Y5pu077yM5b+955WlXHJcbiAgICAgICAgY29uc3QgcHJpbWFyeUtleSA9IEVudGl0eVV0aWwuZ2V0UHJpbWFyeUtleShwYXJlbnRFbnRpdHlUeXBlKTtcclxuICAgICAgICBpZiAocHJvcE5hbWUgPT09IHByaW1hcnlLZXkpIHtcclxuICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKG1vZGlmaWNhdGlvbi50eXBlICE9PSBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlKSB7XHJcbiAgICAgICAgICB0aHJvdyBFcnJvcign566A5Y2V57G75Z6L55qE5bGe5oCn5LiK5LiN5pSv5oyBVmFsdWVDaGFuZ2XnsbvlnovkuYvlpJbnmoTlj5jmm7QnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIE5nRmllbGTnsbvlnovvvJror7TmmI7mmK/mnIDlkI7kuIDnuqdcclxuICAgICAgICBwYXJlbnRDaGFuZ2VJbmZvW2RhdGFGaWVsZF0gPSBtb2RpZmljYXRpb24udmFsdWU7XHJcbiAgICAgICAgcGFyZW50Q2hhbmdlRGV0YWlsID0gbnVsbDtcclxuXHJcbiAgICAgIH0gZWxzZSBpZiAocHJvcFR5cGUgPT09ICdOZ09iamVjdCcpIHtcclxuXHJcbiAgICAgICAgLy8gTmdPYmplY3TlsZ7mgKfmnKzouqvml6Dms5Xop6blj5Hlj5jmm7TvvIzlj6rmnInlroPnmoTlrZDoioLngrnmiY3og73op6blj5HvvIzmiYDku6XlroPkuIrovrnnmoTlj5jmm7TmsLjov5zmmK9Nb2RpZnnnsbvlnovnmoTjgIJcclxuICAgICAgICBjb25zdCBjaGlsZElkID0gcGF0aHNbaSArIDFdLnNwbGl0KCc6JylbMV07XHJcbiAgICAgICAgY29uc3QgY2hpbGRJZE5hbWUgPSBwYXRoc1tpICsgMV0uc3BsaXQoJzonKVswXTtcclxuXHJcbiAgICAgICAgaWYgKGNoaWxkSWROYW1lKSB7XHJcblxyXG4gICAgICAgICAgLy8g5pyJ5Li76ZSu77yI5YWz6IGU5a+56LGh77yJ77ya5piv5LiA5Liq5pmu6YCa55qE5a+56LGhXHJcbiAgICAgICAgICBsZXQgY2hhbmdlT2JqZWN0ID0gcGFyZW50Q2hhbmdlSW5mb1tkYXRhRmllbGRdO1xyXG5cclxuICAgICAgICAgIC8vIOiOt+WPluaVsOaNrlxyXG4gICAgICAgICAgY29uc3QgZW50aXR5UGF0aCA9IHBhdGhzLnNsaWNlKDAsIGkgKyAxKTtcclxuICAgICAgICAgIGNvbnN0IGNoYW5nZWRFbnRpdHkgPSB0aGlzLmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlQYXRoKGVudGl0eVBhdGgpO1xyXG4gICAgICAgICAgY2hhbmdlT2JqZWN0ID0gY2hhbmdlZEVudGl0eSA/IGNoYW5nZWRFbnRpdHkudG9KU09OKHRydWUpIDoge307XHJcbiAgICAgICAgICBwYXJlbnRDaGFuZ2VJbmZvW2RhdGFGaWVsZF0gPSBjaGFuZ2VPYmplY3Q7XHJcbiAgICAgICAgICBwYXJlbnRDaGFuZ2VEZXRhaWwgPSBudWxsO1xyXG4gICAgICAgICAgcGFyZW50RW50aXR5VHlwZSA9IG51bGw7XHJcblxyXG4gICAgICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICAgICAgLy8g5rKh5pyJ5Li76ZSu77yI5YC85a+56LGh77yJ77ya5piv5LiA5Liq5a6M5pW055qEQ2hhbmdlRGV0YWlsXHJcbiAgICAgICAgICBsZXQgY2hhbmdlRGV0YWlsID0gcGFyZW50Q2hhbmdlSW5mb1tkYXRhRmllbGRdIGFzIENoYW5nZURldGFpbDtcclxuICAgICAgICAgIGlmICghY2hhbmdlRGV0YWlsKSB7XHJcbiAgICAgICAgICAgIGNoYW5nZURldGFpbCA9IHtcclxuICAgICAgICAgICAgICBDaGFuZ2VUeXBlOiBDaGFuZ2VEZXRhaWxUeXBlLk1vZGlmeSxcclxuICAgICAgICAgICAgICBDaGFuZ2VJbmZvOiB7fVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcGFyZW50Q2hhbmdlSW5mb1tkYXRhRmllbGRdID0gY2hhbmdlRGV0YWlsO1xyXG4gICAgICAgICAgcGFyZW50Q2hhbmdlRGV0YWlsID0gY2hhbmdlRGV0YWlsO1xyXG4gICAgICAgICAgcGFyZW50RW50aXR5VHlwZSA9IHByb3BFbnRpdHlUeXBlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgIH0gZWxzZSBpZiAocHJvcFR5cGUgPT09ICdOZ0xpc3QnKSB7XHJcblxyXG4gICAgICAgIC8vIOWmguaenOS4jeWtmOWcqOWImeWIm+W7uuS4gOS4quepuuaVsOe7hFxyXG4gICAgICAgIGlmICghcGFyZW50Q2hhbmdlRGV0YWlsLkNoYW5nZUluZm9bZGF0YUZpZWxkXSkge1xyXG4gICAgICAgICAgcGFyZW50Q2hhbmdlRGV0YWlsLkNoYW5nZUluZm9bZGF0YUZpZWxkXSA9IFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBjaGFuZ2VEZXRhaWxzID0gcGFyZW50Q2hhbmdlRGV0YWlsLkNoYW5nZUluZm9bZGF0YUZpZWxkXSBhcyBDaGFuZ2VEZXRhaWxbXTtcclxuXHJcbiAgICAgICAgLy8g5aaC5p6c6L+Z5Liq5bGe5oCn77yM5LiN5piv5Y+25a2Q6IqC54K577yM6ZyA6KaB5p+l5om+5b2T5YmN5bGe5oCn5piv5ZCm5bey57uP5a2Y5Zyo5a+55bqUQ2hhbmdlRGV0YWls77yaXHJcbiAgICAgICAgLy8gMeOAgeS4jeWtmOWcqO+8muWIm+W7uuS4gOS4qk1vZGlmeeexu+Wei+eahENoYW5nZURldGFpbO+8m1xyXG4gICAgICAgIC8vIDLjgIHlrZjlnKjvvJrov5Tlm57mn6Xmib7liLDnmoRDaGFuZ2VEZXRhae+8jOi/meS4qkNoYW5nZURldGFpbOWPr+iDveaYr+S4gOS4qkFkZOexu+Wei+S5n+WPr+iDveaYr+S4gOS4qk1vZGlmeeexu+Wei++8m1xyXG4gICAgICAgIC8vIDPjgIHnjrDnirbvvJrnm67liY1CRUbkuI3mlK/mjIFBZGTnsbvlnovnmoTlj5jmm7TvvIzogq/lrprmmK/kuIDkuKpNb2RpZnnnsbvlnovnmoTlj5jmm7TjgIJcclxuICAgICAgICBpZiAoaSAhPT0gcGF0aHMubGVuZ3RoIC0gMSkge1xyXG5cclxuICAgICAgICAgIC8vIOmBjeWOhuajgOafpeWPmOabtOaYr+WQpuW3sue7j+WtmOWcqFxyXG4gICAgICAgICAgY29uc3QgZGF0YUlkID0gcGF0aHNbaSArIDFdLnNwbGl0KCc6JylbMV07XHJcblxyXG4gICAgICAgICAgbGV0IGNoYW5nZURldGFpbCA9IGNoYW5nZURldGFpbHMuZmluZChjaGFuZ2VEZXRhaWxJdGVtID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGNoYW5nZURldGFpbEl0ZW0uQ2hhbmdlSW5mby5EYXRhSWQgPT09IGRhdGFJZDtcclxuICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgIC8vIOWmguaenOS4jeWtmOWcqO+8jOWImeWIm+W7uuW5tua3u+WKoFxyXG4gICAgICAgICAgaWYgKCFjaGFuZ2VEZXRhaWwpIHtcclxuICAgICAgICAgICAgY2hhbmdlRGV0YWlsID0gdGhpcy5jcmVhdGVFbXB0eUNoYW5nZURldGFpbChDaGFuZ2VEZXRhaWxUeXBlLk1vZGlmeSwgZGF0YUlkKTtcclxuICAgICAgICAgICAgY2hhbmdlRGV0YWlscy5wdXNoKGNoYW5nZURldGFpbCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBwYXJlbnRDaGFuZ2VEZXRhaWwgPSBjaGFuZ2VEZXRhaWw7XHJcbiAgICAgICAgICBwYXJlbnRFbnRpdHlUeXBlID0gcHJvcEVudGl0eVR5cGU7XHJcbiAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOWmguaenOaYr+WPtuWtkOiKgueCue+8jOWImeiCr+WumuaYr+aWsOWinuaIluiAheWIoOmZpOWPmOabtOOAglxyXG4gICAgICAgIGlmIChtb2RpZmljYXRpb24udHlwZSA9PT0gTW9kaWZ5VHlwZS5BZGQgfHwgbW9kaWZpY2F0aW9uLnR5cGUgPT09IE1vZGlmeVR5cGUuSW5zZXJ0KSB7XHJcblxyXG4gICAgICAgICAgLy8gLy8g6YGN5Y6G5re75YqgXHJcbiAgICAgICAgICAvLyBtb2RpZmljYXRpb24udmFsdWUuZm9yRWFjaCgoZW50aXR5OiBhbnkpID0+IHtcclxuICAgICAgICAgIC8vICAgdGhpcy5hZGRBZGRDaGFuZ2VEZXRhaWwoY2hhbmdlRGV0YWlscywgZW50aXR5LnRvSlNPTigpLCBwcm9wRW50aXR5VHlwZSk7XHJcbiAgICAgICAgICAvLyB9KTtcclxuICAgICAgICB9IGVsc2UgaWYgKG1vZGlmaWNhdGlvbi50eXBlID09PSBNb2RpZnlUeXBlLlJlbW92ZSkge1xyXG5cclxuICAgICAgICAgIC8vIEB0b2Rv77ya5Yig6Zmk5Y+Y5pu055u05o6l5ZCR5pyN5Yqh5Zmo56uv5o+Q5Lqk5LqG77yM5LiN6ZyA6KaB5YaN5qyh5o+Q5LqkXHJcbiAgICAgICAgICAvLyDpgY3ljoblj5jmm7Tpm4bvvIzmt7vliqDnp7vpmaTlj5jmm7RcclxuICAgICAgICAgIC8vIG1vZGlmaWNhdGlvbi52YWx1ZS5mb3JFYWNoKChlbnRpdHlEYXRhKSA9PiB7XHJcbiAgICAgICAgICAvLyAgIHRoaXMuYWRkUmVtb3ZlQ2hhbmdlRGV0YWlsKGNoYW5nZURldGFpbHMsIGVudGl0eURhdGEsIHByb3BFbnRpdHlUeXBlKTtcclxuICAgICAgICAgIC8vIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g6YeN572uXHJcbiAgICAgICAgcGFyZW50Q2hhbmdlRGV0YWlsID0gbnVsbDtcclxuICAgICAgICBwYXJlbnRFbnRpdHlUeXBlID0gbnVsbDtcclxuXHJcbiAgICAgIH0gZWxzZSBpZiAocHJvcFR5cGUgPT09ICdOZ0R5bmFtaWMnKSB7XHJcbiAgICAgICAgLy8g6I635Y+W5pWw5o2uXHJcbiAgICAgICAgY29uc3QgZW50aXR5UGF0aCA9IHBhdGhzLnNsaWNlKDAsIGkgKyAxKTtcclxuICAgICAgICBjb25zdCBjaGFuZ2VkRW50aXR5ID0gdGhpcy5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0eUJ5UGF0aChlbnRpdHlQYXRoKTtcclxuICAgICAgICBwYXJlbnRDaGFuZ2VJbmZvW2RhdGFGaWVsZF0gPSB7XHJcbiAgICAgICAgICBDaGFuZ2VUeXBlOiBDaGFuZ2VEZXRhaWxUeXBlLk1vZGlmeSxcclxuICAgICAgICAgIENoYW5nZUluZm86IGNoYW5nZWRFbnRpdHkgPyBjaGFuZ2VkRW50aXR5LnRvSlNPTih0cnVlKSA6IHt9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBwYXJlbnRDaGFuZ2VEZXRhaWwgPSBudWxsO1xyXG4gICAgICAgIHBhcmVudEVudGl0eVR5cGUgPSBudWxsO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5Y+Y5pu05L+h5oGvXHJcbiAgICog5Zyo5pW05LiqQ2hhbmdlRGV0YWls5qCR5LiK77yM5a2Y5Zyo5Lik56eN57G75Z6L55qE6IqC54K5XHJcbiAgICogQ2hhbmdlRGV0YWls77ya5a6e5L2T5Y+Y5pu044CB5YC85a+56LGh5Y+Y5pu077yI5rKh5pyJRGF0YUlE77yJXHJcbiAgICogUGxhaW5PYmplY3Q6IOWFs+iBlOWvueixoeeahOWPmOabtFxyXG4gICAqIOS7jui/meS4pOenjeiKgueCueS4iuaLv+WFt+S9k+WPmOabtOS/oeaBr+eahOaXtuWAme+8jOmcgOimgee7n+S4gOWkhOeQhu+8jOWxj+iUvei/meS4quW3ruW8guOAglxyXG4gICAqIEB0b2Rv77ya5Li66L+Z5Lik56eN6IqC54K55bCB6KOFQ2hhbmdlTm9kZeWfuuexu+adpeino+WGs+i/meS4quW3ruW8guOAglxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Q2hhbmdlSW5mbyhjaGFuZ2VEZXRhaWw6IGFueSk6IGFueSB7XHJcblxyXG4gICAgLy8gQHRvZG/vvJrlj6/og73lrZjlnKjlkIzlkI3lsZ7mgKdcclxuICAgIGlmIChjaGFuZ2VEZXRhaWwuaGFzT3duUHJvcGVydHkoJ0NoYW5nZUluZm8nKSkge1xyXG4gICAgICByZXR1cm4gY2hhbmdlRGV0YWlsLkNoYW5nZUluZm87XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gY2hhbmdlRGV0YWlsO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOWIm+W7ukNoYW5nZURldGFpbFxyXG4gICAqIEBwYXJhbSB0eXBlIEJFRuWPmOabtOexu+Wei1xyXG4gICAqIEBwYXJhbSBkYXRhSWQg5pWw5o2u5YaF56CBXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjcmVhdGVFbXB0eUNoYW5nZURldGFpbCh0eXBlOiBDaGFuZ2VEZXRhaWxUeXBlLCBkYXRhSWQ6IHN0cmluZyk6IENoYW5nZURldGFpbCB7XHJcbiAgICBjb25zdCBjaGFuZ2VEZXRhaWw6IENoYW5nZURldGFpbCA9IHtcclxuICAgICAgQ2hhbmdlVHlwZTogdHlwZSxcclxuICAgICAgQ2hhbmdlSW5mbzoge1xyXG4gICAgICAgIERhdGFJZDogZGF0YUlkXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gY2hhbmdlRGV0YWlsO1xyXG4gIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCB7IEJlZkNoYW5nZUJ1aWxkZXIgfTtcclxuIl19