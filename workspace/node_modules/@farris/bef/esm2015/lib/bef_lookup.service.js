/**
 * @fileoverview added by tsickle
 * Generated from: lib/bef_lookup.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Optional } from '@angular/core';
import { EMPTY } from 'rxjs';
import { switchMap, map, catchError } from 'rxjs/operators';
import { Repository, FrameContext } from '@farris/devkit';
import { LoadingService } from '@farris/ui-loading';
/**
 * 帮助Rest取数服务
 */
export class BefLookupRestService {
    /**
     * 构造函数
     * @param {?} repository
     * @param {?} frameContext
     */
    constructor(repository, frameContext) {
        this.frameContext = frameContext;
        this.befRepository = (/** @type {?} */ (repository));
        this.registerDestroyEvent();
        this.loadingService = this.frameContext && this.frameContext.injector.get(LoadingService, null);
    }
    /**
     * @private
     * @return {?}
     */
    registerDestroyEvent() {
        if (this.frameContext && this.frameContext.destorySignal) {
            this.frameContext.destorySignal.subscribe((/**
             * @return {?}
             */
            () => {
                this.frameContext = null;
                this.befRepository = null;
            }));
        }
    }
    /**
     * @param {?} helpMetadataId
     * @param {?=} data
     * @return {?}
     */
    getData(helpMetadataId, data) {
        /** @type {?} */
        const tableName = helpMetadataId.split('.')[0];
        /** @type {?} */
        const labelId = helpMetadataId.split('.')[1];
        data = data || {};
        if (this.frameContext) {
            /** @type {?} */
            const primaryValue = this.frameContext.bindingData.list.currentId;
            data['currentForm'] = {
                id: primaryValue
            };
        }
        /** @type {?} */
        const enableExtendLoadMethod = this.ifEnableExtendLoadMethod(helpMetadataId);
        if (enableExtendLoadMethod === true) {
            return this.extendGetHelpData(labelId, tableName, data);
        }
        return this.getHelpData(labelId, tableName, data);
    }
    /**
     * @param {?} data
     * @return {?}
     */
    saveUserSettings(data) {
        /** @type {?} */
        const url = '/api/runtime/bcc/v1.0/datagrid/settings';
        return this.befRepository.restService.invoke(url, 'POST', null, { body: data }, false).pipe(catchError((/**
         * @param {?} error
         * @return {?}
         */
        error => {
            this.clearLoading();
            /** @type {?} */
            const formAppContext = this.befRepository.appContext.getFormAppContext();
            this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
            return EMPTY;
        })));
    }
    /**
     * @param {?} key
     * @return {?}
     */
    getUserSettings(key) {
        /** @type {?} */
        const url = '/api/runtime/bcc/v1.0/datagrid/settings/' + key;
        return this.befRepository.restService.invoke(url, 'GET', null, null, false).pipe(catchError((/**
         * @param {?} error
         * @return {?}
         */
        error => {
            this.clearLoading();
            /** @type {?} */
            const formAppContext = this.befRepository.appContext.getFormAppContext();
            this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
            return EMPTY;
        })));
    }
    /**
     * 是否启用扩展取数方法
     * @private
     * @param {?} helpMetadataId
     * @return {?}
     */
    ifEnableExtendLoadMethod(helpMetadataId) {
        // 优先使用context里的设置
        if (this.context && this.context.hasOwnProperty('enableExtendLoadMethod')) {
            return this.context.enableExtendLoadMethod;
        }
        // context没有设置时，继续使用通过指令设置的开关
        /** @type {?} */
        let enableExtendLoadMethod = false;
        if (this.frameContext) {
            /** @type {?} */
            const befApiUrl = this.frameContext.repository.apiUri;
            /** @type {?} */
            const enableKey = `${helpMetadataId}@${befApiUrl}`;
            enableExtendLoadMethod = this.frameContext.getParam(enableKey);
        }
        return enableExtendLoadMethod;
    }
    /**
     * 老的帮助取树
     * @private
     * @param {?} labelId
     * @param {?} tableName
     * @param {?} data
     * @return {?}
     */
    getHelpData(labelId, tableName, data) {
        /** @type {?} */
        const url = `${this.befRepository.restService.baseUri}/elementhelps/${labelId}`;
        /** @type {?} */
        const update$ = this.befRepository.updateDataAndVariableChanges();
        /** @type {?} */
        const result$ = update$.pipe(switchMap((/**
         * @return {?}
         */
        () => {
            this.extendQueryParam(data);
            // tslint:disable-next-line: max-line-length
            return this.befRepository.restService.invoke(url, 'GET', { nodeCode: tableName, queryParam: JSON.stringify(data) }, null, false).pipe(catchError((/**
             * @param {?} error
             * @return {?}
             */
            error => {
                this.clearLoading();
                /** @type {?} */
                const formAppContext = this.befRepository.appContext.getFormAppContext();
                this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
                return EMPTY;
            })));
        })));
        return result$;
    }
    /**
     * 扩展的帮助取数
     * @private
     * @param {?} labelId
     * @param {?} tableName
     * @param {?} data
     * @return {?}
     */
    extendGetHelpData(labelId, tableName, data) {
        /** @type {?} */
        const url = `${this.befRepository.restService.baseUri}/extension/elementhelps`;
        this.extendQueryParam(data);
        /** @type {?} */
        const body = {
            labelId: labelId,
            nodeCode: tableName,
            queryParam: data,
            requestInfo: this.befRepository.restService.buildRequestInfo()
        };
        /** @type {?} */
        const options = {
            body: body
        };
        /** @type {?} */
        const result$ = this.befRepository.restService.invoke(url, 'PUT', null, options, false, true);
        return result$.pipe(map((/**
         * @param {?} responseInfo
         * @return {?}
         */
        (responseInfo) => {
            return responseInfo && responseInfo.returnValue || null;
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        error => {
            this.clearLoading();
            /** @type {?} */
            const formAppContext = this.befRepository.appContext.getFormAppContext();
            this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
            return EMPTY;
        })));
    }
    /**
     * @private
     * @return {?}
     */
    clearLoading() {
        if (this.loadingService) {
            this.loadingService.clearAll();
        }
    }
    /**
     * @private
     * @param {?} data
     * @param {?=} layer
     * @param {?=} parentPathCode
     * @return {?}
     */
    convert2TreeDataWithPathCode(data, layer = 1, parentPathCode = '01') {
        /** @type {?} */
        let nodes = data.filter((/**
         * @param {?} d
         * @return {?}
         */
        d => d.layer === layer && d.pathcode === parentPathCode));
        if (layer > 1) {
            nodes = data.filter((/**
             * @param {?} d
             * @return {?}
             */
            d => d.layer === layer && d.pathcode.substr(0, (layer - 1) * 2) === parentPathCode));
        }
        if (nodes.length) {
            /** @type {?} */
            const treeNodes = nodes.map((/**
             * @param {?} n
             * @return {?}
             */
            n => {
                return {
                    data: n,
                    children: []
                };
            }));
            treeNodes.forEach((/**
             * @param {?} tn
             * @return {?}
             */
            tn => {
                /** @type {?} */
                const _tns = this.convert2TreeDataWithPathCode(data, tn.data.layer + 1, tn.data.pathcode);
                tn.children.push(..._tns);
            }));
            return treeNodes;
        }
    }
    /**
     * @private
     * @param {?} queryParam
     * @return {?}
     */
    extendQueryParam(queryParam) {
        if (queryParam && typeof queryParam === 'object') {
            /** @type {?} */
            const paths = this.getPath();
            queryParam.relationFilterFieldInfo = paths;
        }
    }
    /**
     * @private
     * @return {?}
     */
    getPath() {
        /** @type {?} */
        const bindingPath = this.frameContext.viewModel.bindingPath;
        /** @type {?} */
        const rid = this.frameContext.viewModel.bindingData.list.currentId;
        // root表数据id
        /** @type {?} */
        let path = rid;
        /** @type {?} */
        const subPaths = bindingPath.split('/').filter((/**
         * @param {?} p
         * @return {?}
         */
        p => p));
        if (subPaths.length > 0) {
            /** @type {?} */
            let subData = this.frameContext.viewModel.bindingData;
            for (let index = 0; index < subPaths.length; index++) {
                /** @type {?} */
                const subPath = subPaths[index];
                subData = subData[subPath];
                if (!subData || !subData.currentId) {
                    throw Error(`获取子表完整路径出错，找不到${subData}对应的子表，或对应子表没有当前行。`);
                }
                path += `/${subPath.substring(0, subPath.length - 1)}/${subData.currentId}`;
            }
            // path += '/' + subPaths[subPaths.length - 1]+'/' + ;
        }
        return path;
    }
}
BefLookupRestService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BefLookupRestService.ctorParameters = () => [
    { type: Repository },
    { type: FrameContext, decorators: [{ type: Optional }] }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    BefLookupRestService.prototype.loadingService;
    /**
     * @type {?}
     * @private
     */
    BefLookupRestService.prototype.befRepository;
    /**
     * 帮助取数上下文
     * @type {?}
     */
    BefLookupRestService.prototype.context;
    /**
     * @type {?}
     * @private
     */
    BefLookupRestService.prototype.frameContext;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVmX2xvb2t1cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9iZWYvIiwic291cmNlcyI6WyJsaWIvYmVmX2xvb2t1cC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLEtBQUssRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUN6QyxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBTyxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVqRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzFELE9BQU8sRUFBRSxjQUFjLEVBQW1DLE1BQU0sb0JBQW9CLENBQUM7Ozs7QUFLckYsTUFBTSxPQUFPLG9CQUFvQjs7Ozs7O0lBWS9CLFlBQ0UsVUFBMkIsRUFDUCxZQUEwQjtRQUExQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUU5QyxJQUFJLENBQUMsYUFBYSxHQUFHLG1CQUFvQixVQUFVLEVBQUEsQ0FBQztRQUNwRCxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNsRyxDQUFDOzs7OztJQUNPLG9CQUFvQjtRQUMxQixJQUFJLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLEVBQUU7WUFDeEQsSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsU0FBUzs7O1lBQUMsR0FBRyxFQUFFO2dCQUM3QyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztnQkFDekIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7WUFDNUIs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LElBQUksSUFBSSxJQUFJLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLElBQUksT0FBTyxDQUFDLFNBQVMsRUFBRSxDQUFDO2FBQzdFO1lBQ0Qsc0RBQXNEO1NBQ3ZEO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDOzs7WUFuTUYsVUFBVTs7OztZQVBGLFVBQVU7WUFBRSxZQUFZLHVCQXNCNUIsUUFBUTs7Ozs7OztJQWJYLDhDQUF1Qzs7Ozs7SUFDdkMsNkNBQTBDOzs7OztJQUsxQyx1Q0FBb0I7Ozs7O0lBT2xCLDRDQUE4QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEVNUFRZLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHN3aXRjaE1hcCwgbWFwLCB0YXAsIGNhdGNoRXJyb3IgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IElMb29rdXBIdHRwU2VydmljZSwgUmVtb3RlUGFyYW1zLCBMb29rdXBHcmlkUmVzdWx0IH0gZnJvbSAnQGZhcnJpcy91aS1sb29rdXAnO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5LCBGcmFtZUNvbnRleHQgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnkgfSBmcm9tICcuL2JlZl9yZXBvc2l0b3J5JztcclxuaW1wb3J0IHsgUmVzcG9uc2VJbmZvIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IExvYWRpbmdTZXJ2aWNlLCBMb2FkaW5nQ29uZmlnLCBMb2FkaW5nQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1sb2FkaW5nJztcclxuLyoqXHJcbiAqIOW4ruWKqVJlc3Tlj5bmlbDmnI3liqFcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEJlZkxvb2t1cFJlc3RTZXJ2aWNlIGltcGxlbWVudHMgSUxvb2t1cEh0dHBTZXJ2aWNlIHtcclxuICBwcml2YXRlIGxvYWRpbmdTZXJ2aWNlOiBMb2FkaW5nU2VydmljZTtcclxuICBwcml2YXRlIGJlZlJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8YW55PjtcclxuXHJcbiAgLyoqXHJcbiAgICog5biu5Yqp5Y+W5pWw5LiK5LiL5paHXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnRleHQ6IGFueTtcclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4sXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0XHJcbiAgKSB7XHJcbiAgICB0aGlzLmJlZlJlcG9zaXRvcnkgPSA8QmVmUmVwb3NpdG9yeTxhbnk+PnJlcG9zaXRvcnk7XHJcbiAgICB0aGlzLnJlZ2lzdGVyRGVzdHJveUV2ZW50KCk7XHJcbiAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlID0gdGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0KExvYWRpbmdTZXJ2aWNlLCBudWxsKTtcclxuICB9XHJcbiAgcHJpdmF0ZSByZWdpc3RlckRlc3Ryb3lFdmVudCgpIHtcclxuICAgIGlmICh0aGlzLmZyYW1lQ29udGV4dCAmJiB0aGlzLmZyYW1lQ29udGV4dC5kZXN0b3J5U2lnbmFsKSB7XHJcbiAgICAgIHRoaXMuZnJhbWVDb250ZXh0LmRlc3RvcnlTaWduYWwuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICB0aGlzLmZyYW1lQ29udGV4dCA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5iZWZSZXBvc2l0b3J5ID0gbnVsbDtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0RGF0YShoZWxwTWV0YWRhdGFJZDogc3RyaW5nLCBkYXRhPzogUmVtb3RlUGFyYW1zKTogT2JzZXJ2YWJsZTxMb29rdXBHcmlkUmVzdWx0PiB7XHJcbiAgICBjb25zdCB0YWJsZU5hbWUgPSBoZWxwTWV0YWRhdGFJZC5zcGxpdCgnLicpWzBdO1xyXG4gICAgY29uc3QgbGFiZWxJZCA9IGhlbHBNZXRhZGF0YUlkLnNwbGl0KCcuJylbMV07XHJcbiAgICBkYXRhID0gZGF0YSB8fCB7fTtcclxuICAgIGlmICh0aGlzLmZyYW1lQ29udGV4dCkge1xyXG4gICAgICBjb25zdCBwcmltYXJ5VmFsdWUgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZDtcclxuICAgICAgZGF0YVsnY3VycmVudEZvcm0nXSA9IHtcclxuICAgICAgICBpZDogcHJpbWFyeVZhbHVlXHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgICBjb25zdCBlbmFibGVFeHRlbmRMb2FkTWV0aG9kID0gdGhpcy5pZkVuYWJsZUV4dGVuZExvYWRNZXRob2QoaGVscE1ldGFkYXRhSWQpO1xyXG4gICAgaWYgKGVuYWJsZUV4dGVuZExvYWRNZXRob2QgPT09IHRydWUpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZXh0ZW5kR2V0SGVscERhdGEobGFiZWxJZCwgdGFibGVOYW1lLCBkYXRhKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLmdldEhlbHBEYXRhKGxhYmVsSWQsIHRhYmxlTmFtZSwgZGF0YSk7XHJcbiAgfVxyXG4gIHB1YmxpYyBzYXZlVXNlclNldHRpbmdzKGRhdGEpIHtcclxuICAgIGNvbnN0IHVybCA9ICcvYXBpL3J1bnRpbWUvYmNjL3YxLjAvZGF0YWdyaWQvc2V0dGluZ3MnO1xyXG4gICAgcmV0dXJuIHRoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5pbnZva2UodXJsLCAnUE9TVCcsIG51bGwsIHsgYm9keTogZGF0YSB9LCBmYWxzZSkucGlwZShcclxuICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XHJcbiAgICAgICAgdGhpcy5jbGVhckxvYWRpbmcoKTtcclxuICAgICAgICBjb25zdCBmb3JtQXBwQ29udGV4dCA9IHRoaXMuYmVmUmVwb3NpdG9yeS5hcHBDb250ZXh0LmdldEZvcm1BcHBDb250ZXh0KCk7XHJcbiAgICAgICAgdGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmV2ZW50QnVzLnBvc3QoJ0V4Y2VwdGlvbicsICcnLCAnb25FeGNlcHRpb24nLCBlcnJvciwgZm9ybUFwcENvbnRleHQpO1xyXG4gICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0VXNlclNldHRpbmdzKGtleSkge1xyXG4gICAgY29uc3QgdXJsID0gJy9hcGkvcnVudGltZS9iY2MvdjEuMC9kYXRhZ3JpZC9zZXR0aW5ncy8nICsga2V5O1xyXG4gICAgcmV0dXJuIHRoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5pbnZva2UodXJsLCAnR0VUJywgbnVsbCwgbnVsbCwgZmFsc2UpLnBpcGUoXHJcbiAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xyXG4gICAgICAgIHRoaXMuY2xlYXJMb2FkaW5nKCk7XHJcbiAgICAgICAgY29uc3QgZm9ybUFwcENvbnRleHQgPSB0aGlzLmJlZlJlcG9zaXRvcnkuYXBwQ29udGV4dC5nZXRGb3JtQXBwQ29udGV4dCgpO1xyXG4gICAgICAgIHRoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5ldmVudEJ1cy5wb3N0KCdFeGNlcHRpb24nLCAnJywgJ29uRXhjZXB0aW9uJywgZXJyb3IsIGZvcm1BcHBDb250ZXh0KTtcclxuICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5piv5ZCm5ZCv55So5omp5bGV5Y+W5pWw5pa55rOVXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpZkVuYWJsZUV4dGVuZExvYWRNZXRob2QoaGVscE1ldGFkYXRhSWQ6IHN0cmluZykge1xyXG5cclxuICAgIC8vIOS8mOWFiOS9v+eUqGNvbnRleHTph4znmoTorr7nva5cclxuICAgIGlmICh0aGlzLmNvbnRleHQgJiYgdGhpcy5jb250ZXh0Lmhhc093blByb3BlcnR5KCdlbmFibGVFeHRlbmRMb2FkTWV0aG9kJykpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuY29udGV4dC5lbmFibGVFeHRlbmRMb2FkTWV0aG9kO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGNvbnRleHTmsqHmnInorr7nva7ml7bvvIznu6fnu63kvb/nlKjpgJrov4fmjIfku6Torr7nva7nmoTlvIDlhbNcclxuICAgIGxldCBlbmFibGVFeHRlbmRMb2FkTWV0aG9kID0gZmFsc2U7XHJcbiAgICBpZiAodGhpcy5mcmFtZUNvbnRleHQpIHtcclxuICAgICAgY29uc3QgYmVmQXBpVXJsID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5hcGlVcmk7XHJcbiAgICAgIGNvbnN0IGVuYWJsZUtleSA9IGAke2hlbHBNZXRhZGF0YUlkfUAke2JlZkFwaVVybH1gO1xyXG4gICAgICBlbmFibGVFeHRlbmRMb2FkTWV0aG9kID0gdGhpcy5mcmFtZUNvbnRleHQuZ2V0UGFyYW0oZW5hYmxlS2V5KTtcclxuICAgIH1cclxuICAgIHJldHVybiBlbmFibGVFeHRlbmRMb2FkTWV0aG9kO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6ICB55qE5biu5Yqp5Y+W5qCRXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRIZWxwRGF0YShsYWJlbElkOiBzdHJpbmcsIHRhYmxlTmFtZTogc3RyaW5nLCBkYXRhOiBhbnkpOiBPYnNlcnZhYmxlPExvb2t1cEdyaWRSZXN1bHQ+IHtcclxuICAgIGNvbnN0IHVybCA9IGAke3RoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5iYXNlVXJpfS9lbGVtZW50aGVscHMvJHtsYWJlbElkfWA7XHJcbiAgICBjb25zdCB1cGRhdGUkID0gdGhpcy5iZWZSZXBvc2l0b3J5LnVwZGF0ZURhdGFBbmRWYXJpYWJsZUNoYW5nZXMoKTtcclxuXHJcbiAgICBjb25zdCByZXN1bHQkID0gdXBkYXRlJC5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuZXh0ZW5kUXVlcnlQYXJhbShkYXRhKTtcclxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1heC1saW5lLWxlbmd0aFxyXG4gICAgICAgIHJldHVybiB0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuaW52b2tlKHVybCwgJ0dFVCcsIHsgbm9kZUNvZGU6IHRhYmxlTmFtZSwgcXVlcnlQYXJhbTogSlNPTi5zdHJpbmdpZnkoZGF0YSkgfSwgbnVsbCwgZmFsc2UpLnBpcGUoXHJcbiAgICAgICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcclxuICAgICAgICAgICAgdGhpcy5jbGVhckxvYWRpbmcoKTtcclxuICAgICAgICAgICAgY29uc3QgZm9ybUFwcENvbnRleHQgPSB0aGlzLmJlZlJlcG9zaXRvcnkuYXBwQ29udGV4dC5nZXRGb3JtQXBwQ29udGV4dCgpO1xyXG4gICAgICAgICAgICB0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuZXZlbnRCdXMucG9zdCgnRXhjZXB0aW9uJywgJycsICdvbkV4Y2VwdGlvbicsIGVycm9yLCBmb3JtQXBwQ29udGV4dCk7XHJcbiAgICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgICByZXR1cm4gcmVzdWx0JDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJqeWxleeahOW4ruWKqeWPluaVsFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZXh0ZW5kR2V0SGVscERhdGEobGFiZWxJZDogc3RyaW5nLCB0YWJsZU5hbWU6IHN0cmluZywgZGF0YTogYW55KTogT2JzZXJ2YWJsZTxMb29rdXBHcmlkUmVzdWx0PiB7XHJcbiAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuYmFzZVVyaX0vZXh0ZW5zaW9uL2VsZW1lbnRoZWxwc2A7XHJcbiAgICB0aGlzLmV4dGVuZFF1ZXJ5UGFyYW0oZGF0YSk7XHJcbiAgICBjb25zdCBib2R5ID0ge1xyXG4gICAgICBsYWJlbElkOiBsYWJlbElkLFxyXG4gICAgICBub2RlQ29kZTogdGFibGVOYW1lLFxyXG4gICAgICBxdWVyeVBhcmFtOiBkYXRhLFxyXG4gICAgICByZXF1ZXN0SW5mbzogdGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxyXG4gICAgfTtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgIGJvZHk6IGJvZHlcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgcmVzdWx0JCA9IHRoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5pbnZva2UodXJsLCAnUFVUJywgbnVsbCwgb3B0aW9ucywgZmFsc2UsIHRydWUpO1xyXG4gICAgcmV0dXJuIHJlc3VsdCQucGlwZShcclxuICAgICAgbWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xyXG4gICAgICAgIHJldHVybiByZXNwb25zZUluZm8gJiYgcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlIHx8IG51bGw7XHJcbiAgICAgIH0pLFxyXG4gICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcclxuICAgICAgICB0aGlzLmNsZWFyTG9hZGluZygpO1xyXG4gICAgICAgIGNvbnN0IGZvcm1BcHBDb250ZXh0ID0gdGhpcy5iZWZSZXBvc2l0b3J5LmFwcENvbnRleHQuZ2V0Rm9ybUFwcENvbnRleHQoKTtcclxuICAgICAgICB0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuZXZlbnRCdXMucG9zdCgnRXhjZXB0aW9uJywgJycsICdvbkV4Y2VwdGlvbicsIGVycm9yLCBmb3JtQXBwQ29udGV4dCk7XHJcbiAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICB9XHJcbiAgICAgICksXHJcbiAgICApO1xyXG4gIH1cclxuICBwcml2YXRlIGNsZWFyTG9hZGluZygpIHtcclxuICAgIGlmICh0aGlzLmxvYWRpbmdTZXJ2aWNlKSB7XHJcbiAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuY2xlYXJBbGwoKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBjb252ZXJ0MlRyZWVEYXRhV2l0aFBhdGhDb2RlKGRhdGE6IGFueVtdLCBsYXllciA9IDEsIHBhcmVudFBhdGhDb2RlID0gJzAxJykge1xyXG4gICAgbGV0IG5vZGVzID0gZGF0YS5maWx0ZXIoZCA9PiBkLmxheWVyID09PSBsYXllciAmJiBkLnBhdGhjb2RlID09PSBwYXJlbnRQYXRoQ29kZSk7XHJcbiAgICBpZiAobGF5ZXIgPiAxKSB7XHJcbiAgICAgIG5vZGVzID0gZGF0YS5maWx0ZXIoZCA9PiBkLmxheWVyID09PSBsYXllciAmJiBkLnBhdGhjb2RlLnN1YnN0cigwLCAobGF5ZXIgLSAxKSAqIDIpID09PSBwYXJlbnRQYXRoQ29kZSk7XHJcbiAgICB9XHJcbiAgICBpZiAobm9kZXMubGVuZ3RoKSB7XHJcbiAgICAgIGNvbnN0IHRyZWVOb2RlcyA9IG5vZGVzLm1hcChuID0+IHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgZGF0YTogbixcclxuICAgICAgICAgIGNoaWxkcmVuOiBbXVxyXG4gICAgICAgIH07XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgdHJlZU5vZGVzLmZvckVhY2godG4gPT4ge1xyXG4gICAgICAgIGNvbnN0IF90bnMgPSB0aGlzLmNvbnZlcnQyVHJlZURhdGFXaXRoUGF0aENvZGUoZGF0YSwgdG4uZGF0YS5sYXllciArIDEsIHRuLmRhdGEucGF0aGNvZGUpO1xyXG4gICAgICAgIHRuLmNoaWxkcmVuLnB1c2goLi4uX3Rucyk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgcmV0dXJuIHRyZWVOb2RlcztcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBleHRlbmRRdWVyeVBhcmFtKHF1ZXJ5UGFyYW06IGFueSkge1xyXG4gICAgaWYgKHF1ZXJ5UGFyYW0gJiYgdHlwZW9mIHF1ZXJ5UGFyYW0gPT09ICdvYmplY3QnKSB7XHJcbiAgICAgIGNvbnN0IHBhdGhzID0gdGhpcy5nZXRQYXRoKCk7XHJcbiAgICAgIHF1ZXJ5UGFyYW0ucmVsYXRpb25GaWx0ZXJGaWVsZEluZm8gPSBwYXRocztcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRQYXRoKCk6IHN0cmluZyB7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IHRoaXMuZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcclxuICAgIGNvbnN0IHJpZCA9IHRoaXMuZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZDsgLy8gcm9vdOihqOaVsOaNrmlkXHJcbiAgICBsZXQgcGF0aCA9IHJpZDtcclxuXHJcbiAgICBjb25zdCBzdWJQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICBpZiAoc3ViUGF0aHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBsZXQgc3ViRGF0YTogYW55ID0gdGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdEYXRhO1xyXG4gICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgc3ViUGF0aHMubGVuZ3RoOyBpbmRleCsrKSB7XHJcbiAgICAgICAgY29uc3Qgc3ViUGF0aCA9IHN1YlBhdGhzW2luZGV4XTtcclxuICAgICAgICBzdWJEYXRhID0gc3ViRGF0YVtzdWJQYXRoXTtcclxuICAgICAgICBpZiAoIXN1YkRhdGEgfHwgIXN1YkRhdGEuY3VycmVudElkKSB7XHJcbiAgICAgICAgICB0aHJvdyBFcnJvcihg6I635Y+W5a2Q6KGo5a6M5pW06Lev5b6E5Ye66ZSZ77yM5om+5LiN5YiwJHtzdWJEYXRhfeWvueW6lOeahOWtkOihqO+8jOaIluWvueW6lOWtkOihqOayoeacieW9k+WJjeihjOOAgmApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBwYXRoICs9IGAvJHtzdWJQYXRoLnN1YnN0cmluZygwLCBzdWJQYXRoLmxlbmd0aCAtIDEpfS8ke3N1YkRhdGEuY3VycmVudElkfWA7XHJcbiAgICAgIH1cclxuICAgICAgLy8gcGF0aCArPSAnLycgKyBzdWJQYXRoc1tzdWJQYXRocy5sZW5ndGggLSAxXSsnLycgKyA7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcGF0aDtcclxuICB9XHJcbn0iXX0=