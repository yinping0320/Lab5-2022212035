/**
 * @fileoverview added by tsickle
 * Generated from: lib/bef_variable_manager.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*
 * @Author: Witt
 * @Date: 2019-03-05 19:55:44
 * @Last Modified by: Witt
 * @Last Modified time: 2019-03-13 20:35:29
 */
import { format } from 'date-fns';
import { AppContext, FrameContext } from '@farris/devkit';
import { ChangeDetailType } from './types';
import { BefChangeUtil } from './bef_change_util';
import { Injector, Optional } from '@angular/core';
/**
 * Be变量管理器
 */
class BefVariableManager {
    /**
     * 构造函数
     * @param {?} appContext
     * @param {?} ngVariables
     * @param {?} injector
     */
    constructor(appContext, ngVariables, injector) {
        this.appContext = appContext;
        this.ngVariables = ngVariables;
        this.injector = injector;
        this.ngVariableMap = new Map();
        this.innerValueMap = new Map();
        // 重新组织变量元数据
        Object.keys(ngVariables).forEach((/**
         * @param {?} propName
         * @return {?}
         */
        (propName) => {
            this.ngVariableMap.set(propName, ngVariables[propName]);
        }));
    }
    /**
     * 获取变更集
     * @param {?} changeDetail
     * @return {?}
     */
    handleChangeDetail(changeDetail) {
        /** @type {?} */
        const changeInfo = changeDetail.ChangeInfo;
        Object.keys(changeInfo).forEach((/**
         * @param {?} varName
         * @return {?}
         */
        (varName) => {
            // 变量元数据
            /** @type {?} */
            const ngVariable = this.ngVariableMap.get(varName);
            if (!ngVariable) {
                return;
            }
            /** @type {?} */
            const mapping = ngVariable.mapping;
            // 更新UIState变更
            /** @type {?} */
            const newValue = changeInfo[varName];
            /** @type {?} */
            const oldValue = this.getValueFromUIState(mapping);
            if (oldValue === newValue) {
                return;
            }
            // 更新值
            this.setValueToUIState(mapping, newValue);
            this.innerValueMap.set(varName, newValue);
        }));
    }
    /**
     * Build ChangeDetail instance for all variables.
     * @return {?}
     */
    buildChangeDetail() {
        /** @type {?} */
        const changeDetail = BefChangeUtil.createEmpty(ChangeDetailType.Modify);
        this.ngVariableMap.forEach((/**
         * @param {?} ngVariable
         * @param {?} varName
         * @return {?}
         */
        (ngVariable, varName) => {
            /** @type {?} */
            const mapping = ngVariable.mapping;
            /** @type {?} */
            const newValue = this.getValueFromUIState(mapping);
            /** @type {?} */
            const oldValue = this.innerValueMap.get(varName);
            if (this.isValueEqual(newValue, oldValue) === false) {
                // 不清除变更，请求成功后清除变更
                // this.innerValueMap.set(varName, newValue);
                this.appendToChangeInfo(changeDetail, varName, newValue);
            }
        }));
        if (Object.keys(changeDetail.ChangeInfo).length === 0) {
            return null;
        }
        return changeDetail;
    }
    /**
     * Clear variable values cached in the innerValueMap property.
     * @return {?}
     */
    reset() {
        this.innerValueMap.clear();
    }
    /**
     * 清空所有vo变量变更集
     * @return {?}
     */
    clearChanges() {
        this.ngVariableMap.forEach((/**
         * @param {?} ngVariable
         * @param {?} varName
         * @return {?}
         */
        (ngVariable, varName) => {
            /** @type {?} */
            const mapping = ngVariable.mapping;
            /** @type {?} */
            const newValue = this.getValueFromUIState(mapping);
            /** @type {?} */
            const oldValue = this.innerValueMap.get(varName);
            if (this.isValueEqual(newValue, oldValue) === false) {
                this.innerValueMap.set(varName, newValue);
            }
        }));
    }
    /**
     * 清空只读vo变更
     * @param {?} changeDetail
     * @return {?}
     */
    clearChangeDetail(changeDetail) {
        if (!changeDetail || Object.keys(changeDetail.ChangeInfo).length === 0) {
            return;
        }
        Object.keys(changeDetail.ChangeInfo).forEach((/**
         * @param {?} key
         * @return {?}
         */
        (key) => {
            /** @type {?} */
            const ngVariable = this.ngVariableMap.get(key);
            if (!ngVariable) {
                return;
            }
            /** @type {?} */
            const mapping = ngVariable.mapping;
            /** @type {?} */
            const newValue = this.getValueFromUIState(mapping);
            this.innerValueMap.set(key, newValue);
        }));
    }
    /**
     * Append changed variable to ChangeDetail instance.
     * @private
     * @param {?} changeDetail
     * @param {?} varName
     * @param {?} varValue
     * @return {?}
     */
    appendToChangeInfo(changeDetail, varName, varValue) {
        if (this.isUdtVariable(varValue) === true) {
            /** @type {?} */
            const udtVarChangeDetail = BefChangeUtil.createEmpty(ChangeDetailType.Modify);
            udtVarChangeDetail.ChangeInfo = varValue;
            changeDetail.ChangeInfo[varName] = udtVarChangeDetail;
        }
        else {
            changeDetail.ChangeInfo[varName] = varValue;
        }
    }
    /**
     * 从UIState上获取值
     * @private
     * @param {?} mapping
     * @return {?}
     */
    getValueFromUIState(mapping) {
        /** @type {?} */
        const uiState = this.getRootUIState();
        // 计算value
        /** @type {?} */
        const mappingArray = mapping.split('.');
        /** @type {?} */
        const value = mappingArray.reduce((/**
         * @param {?} accumulator
         * @param {?} currentValue
         * @return {?}
         */
        (accumulator, currentValue) => {
            return accumulator ? accumulator[currentValue] : null;
        }), uiState);
        if (value instanceof Date) {
            return format(value, 'yyyy-MM-dd HH:mm:ss');
        }
        return value;
    }
    /**
     * 获取根组件上的UIState
     * @private
     * @return {?}
     */
    getRootUIState() {
        /** @type {?} */
        let rootFrameContext = this.appContext.frameContextManager.getRootFrameContext();
        if (this.injector) {
            /** @type {?} */
            const frameContext = this.injector.get(FrameContext, null);
            if (frameContext) {
                /** @type {?} */
                const virtualRootFrameContext = frameContext.getVirtualRootFrameContext();
                rootFrameContext = virtualRootFrameContext || rootFrameContext;
            }
        }
        if (!rootFrameContext) {
            return;
        }
        return rootFrameContext.uiState;
    }
    /**
     * 值比较
     * \@todo 临时采用这种方式
     * @private
     * @param {?} srcValue
     * @param {?} dstValue
     * @return {?}
     */
    isValueEqual(srcValue, dstValue) {
        return JSON.stringify(srcValue) === JSON.stringify(dstValue);
    }
    /**
     * Check if the object is a plain object
     * @private
     * @param {?} obj
     * @return {?}
     */
    isUdtVariable(obj) {
        return obj && obj.constructor &&
            obj.toString() === '[object Object]' &&
            obj.constructor.prototype.hasOwnProperty('isPrototypeOf');
    }
    /**
     * 设置值到UIState
     * \@todo：
     * 1、服务器端不支持；
     * 2、日期类型处理方案待定。
     * @private
     * @param {?} mapping
     * @param {?} value
     * @return {?}
     */
    setValueToUIState(mapping, value) {
        /** @type {?} */
        const uiState = this.getRootUIState();
        uiState[mapping] = value;
    }
}
/** @nocollapse */
BefVariableManager.ctorParameters = () => [
    { type: AppContext },
    { type: undefined },
    { type: Injector, decorators: [{ type: Optional }] }
];
if (false) {
    /**
     * 变量元数据
     * @type {?}
     * @private
     */
    BefVariableManager.prototype.ngVariableMap;
    /**
     * 设置值
     * @type {?}
     * @private
     */
    BefVariableManager.prototype.innerValueMap;
    /**
     * @type {?}
     * @private
     */
    BefVariableManager.prototype.appContext;
    /**
     * @type {?}
     * @private
     */
    BefVariableManager.prototype.ngVariables;
    /**
     * @type {?}
     * @private
     */
    BefVariableManager.prototype.injector;
}
export { BefVariableManager };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVmX3ZhcmlhYmxlX21hbmFnZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2JlZi8iLCJzb3VyY2VzIjpbImxpYi9iZWZfdmFyaWFibGVfbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQU1BLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQVcsTUFBTSxnQkFBZ0IsQ0FBQztBQUNuRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQWdCLE1BQU0sU0FBUyxDQUFDO0FBRXpELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQzs7OztBQU1uRCxNQUFNLGtCQUFrQjs7Ozs7OztJQWV0QixZQUFvQixVQUFzQixFQUFVLFdBQWdCLEVBQXNCLFFBQWtCO1FBQXhGLGVBQVUsR0FBVixVQUFVLENBQVk7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBSztRQUFzQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBRTFHLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxHQUFHLEVBQXNCLENBQUM7UUFDbkQsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLEdBQUcsRUFBZSxDQUFDO1FBRTVDLFlBQVk7UUFDWixNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQU87Ozs7UUFBQyxDQUFDLFFBQWdCLEVBQUUsRUFBRTtZQUNwRCxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDMUQsQ0FBQyxFQUFDLENBQUM7SUFDTCxDQUFDOzs7Ozs7SUFLTSxrQkFBa0IsQ0FBQyxZQUEwQjs7Y0FDNUMsVUFBVSxHQUFHLFlBQVksQ0FBQyxVQUFVO1FBQzFDLE1BQU0sQ0FBQyxJQUFJLENB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dUJBcUJ3RCxRQUFROzs7Ozs7OztJQVYvRSwyQ0FBK0M7Ozs7OztJQUsvQywyQ0FBd0M7Ozs7O0lBSzVCLHdDQUE4Qjs7Ozs7SUFBRSx5Q0FBd0I7Ozs7O0lBQUUsc0NBQXNDOztBQW9MOUcsT0FBTyxFQUFFLGtCQUFrQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiBXaXR0XHJcbiAqIEBEYXRlOiAyMDE5LTAzLTA1IDE5OjU1OjQ0XHJcbiAqIEBMYXN0IE1vZGlmaWVkIGJ5OiBXaXR0XHJcbiAqIEBMYXN0IE1vZGlmaWVkIHRpbWU6IDIwMTktMDMtMTMgMjA6MzU6MjlcclxuICovXHJcbmltcG9ydCB7IGZvcm1hdCB9IGZyb20gJ2RhdGUtZm5zJztcclxuaW1wb3J0IHsgQXBwQ29udGV4dCwgRnJhbWVDb250ZXh0LCBVSVN0YXRlIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBDaGFuZ2VEZXRhaWxUeXBlLCBDaGFuZ2VEZXRhaWwgfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgTmdWYXJpYWJsZSB9IGZyb20gJy4vZGVjb3JhdG9ycyc7XHJcbmltcG9ydCB7IEJlZkNoYW5nZVV0aWwgfSBmcm9tICcuL2JlZl9jaGFuZ2VfdXRpbCc7XHJcbmltcG9ydCB7IEluamVjdG9yLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5cclxuXHJcbi8qKlxyXG4gKiBCZeWPmOmHj+euoeeQhuWZqFxyXG4gKi9cclxuY2xhc3MgQmVmVmFyaWFibGVNYW5hZ2VyIHtcclxuXHJcbiAgLyoqXHJcbiAgICog5Y+Y6YeP5YWD5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBuZ1ZhcmlhYmxlTWFwOiBNYXA8c3RyaW5nLCBOZ1ZhcmlhYmxlPjtcclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572u5YC8XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpbm5lclZhbHVlTWFwOiBNYXA8c3RyaW5nLCBhbnk+O1xyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcENvbnRleHQ6IEFwcENvbnRleHQsIHByaXZhdGUgbmdWYXJpYWJsZXM6IGFueSwgQE9wdGlvbmFsKCkgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuXHJcbiAgICB0aGlzLm5nVmFyaWFibGVNYXAgPSBuZXcgTWFwPHN0cmluZywgTmdWYXJpYWJsZT4oKTtcclxuICAgIHRoaXMuaW5uZXJWYWx1ZU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcblxyXG4gICAgLy8g6YeN5paw57uE57uH5Y+Y6YeP5YWD5pWw5o2uXHJcbiAgICBPYmplY3Qua2V5cyhuZ1ZhcmlhYmxlcykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICB0aGlzLm5nVmFyaWFibGVNYXAuc2V0KHByb3BOYW1lLCBuZ1ZhcmlhYmxlc1twcm9wTmFtZV0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blj5jmm7Tpm4ZcclxuICAgKi9cclxuICBwdWJsaWMgaGFuZGxlQ2hhbmdlRGV0YWlsKGNoYW5nZURldGFpbDogQ2hhbmdlRGV0YWlsKTogdm9pZCB7XHJcbiAgICBjb25zdCBjaGFuZ2VJbmZvID0gY2hhbmdlRGV0YWlsLkNoYW5nZUluZm87XHJcbiAgICBPYmplY3Qua2V5cyhjaGFuZ2VJbmZvKS5mb3JFYWNoKCh2YXJOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgLy8g5Y+Y6YeP5YWD5pWw5o2uXHJcbiAgICAgIGNvbnN0IG5nVmFyaWFibGUgPSB0aGlzLm5nVmFyaWFibGVNYXAuZ2V0KHZhck5hbWUpO1xyXG4gICAgICBpZiAoIW5nVmFyaWFibGUpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgbWFwcGluZyA9IG5nVmFyaWFibGUubWFwcGluZztcclxuXHJcbiAgICAgIC8vIOabtOaWsFVJU3RhdGXlj5jmm7RcclxuICAgICAgY29uc3QgbmV3VmFsdWUgPSBjaGFuZ2VJbmZvW3Zhck5hbWVdO1xyXG4gICAgICBjb25zdCBvbGRWYWx1ZSA9IHRoaXMuZ2V0VmFsdWVGcm9tVUlTdGF0ZShtYXBwaW5nKTtcclxuXHJcbiAgICAgIGlmIChvbGRWYWx1ZSA9PT0gbmV3VmFsdWUpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgLy8g5pu05paw5YC8XHJcbiAgICAgIHRoaXMuc2V0VmFsdWVUb1VJU3RhdGUobWFwcGluZywgbmV3VmFsdWUpO1xyXG4gICAgICB0aGlzLmlubmVyVmFsdWVNYXAuc2V0KHZhck5hbWUsIG5ld1ZhbHVlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQnVpbGQgQ2hhbmdlRGV0YWlsIGluc3RhbmNlIGZvciBhbGwgdmFyaWFibGVzLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBidWlsZENoYW5nZURldGFpbCgpOiBDaGFuZ2VEZXRhaWwge1xyXG4gICAgY29uc3QgY2hhbmdlRGV0YWlsID0gQmVmQ2hhbmdlVXRpbC5jcmVhdGVFbXB0eShDaGFuZ2VEZXRhaWxUeXBlLk1vZGlmeSk7XHJcbiAgICB0aGlzLm5nVmFyaWFibGVNYXAuZm9yRWFjaCgobmdWYXJpYWJsZTogTmdWYXJpYWJsZSwgdmFyTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IG1hcHBpbmcgPSBuZ1ZhcmlhYmxlLm1hcHBpbmc7XHJcbiAgICAgIGNvbnN0IG5ld1ZhbHVlID0gdGhpcy5nZXRWYWx1ZUZyb21VSVN0YXRlKG1hcHBpbmcpO1xyXG4gICAgICBjb25zdCBvbGRWYWx1ZSA9IHRoaXMuaW5uZXJWYWx1ZU1hcC5nZXQodmFyTmFtZSk7XHJcbiAgICAgIGlmICh0aGlzLmlzVmFsdWVFcXVhbChuZXdWYWx1ZSwgb2xkVmFsdWUpID09PSBmYWxzZSkge1xyXG4gICAgICAgIC8vIOS4jea4hemZpOWPmOabtO+8jOivt+axguaIkOWKn+WQjua4hemZpOWPmOabtFxyXG4gICAgICAgIC8vIHRoaXMuaW5uZXJWYWx1ZU1hcC5zZXQodmFyTmFtZSwgbmV3VmFsdWUpO1xyXG4gICAgICAgIHRoaXMuYXBwZW5kVG9DaGFuZ2VJbmZvKGNoYW5nZURldGFpbCwgdmFyTmFtZSwgbmV3VmFsdWUpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoT2JqZWN0LmtleXMoY2hhbmdlRGV0YWlsLkNoYW5nZUluZm8pLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gY2hhbmdlRGV0YWlsO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2xlYXIgdmFyaWFibGUgdmFsdWVzIGNhY2hlZCBpbiB0aGUgaW5uZXJWYWx1ZU1hcCBwcm9wZXJ0eS5cclxuICAgKi9cclxuICBwdWJsaWMgcmVzZXQoKSB7XHJcbiAgICB0aGlzLmlubmVyVmFsdWVNYXAuY2xlYXIoKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5riF56m65omA5pyJdm/lj5jph4/lj5jmm7Tpm4ZcclxuICAgKi9cclxuICBwdWJsaWMgY2xlYXJDaGFuZ2VzKCkge1xyXG4gICAgdGhpcy5uZ1ZhcmlhYmxlTWFwLmZvckVhY2goKG5nVmFyaWFibGU6IE5nVmFyaWFibGUsIHZhck5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBtYXBwaW5nID0gbmdWYXJpYWJsZS5tYXBwaW5nO1xyXG4gICAgICBjb25zdCBuZXdWYWx1ZSA9IHRoaXMuZ2V0VmFsdWVGcm9tVUlTdGF0ZShtYXBwaW5nKTtcclxuICAgICAgY29uc3Qgb2xkVmFsdWUgPSB0aGlzLmlubmVyVmFsdWVNYXAuZ2V0KHZhck5hbWUpO1xyXG4gICAgICBpZiAodGhpcy5pc1ZhbHVlRXF1YWwobmV3VmFsdWUsIG9sZFZhbHVlKSA9PT0gZmFsc2UpIHtcclxuICAgICAgICB0aGlzLmlubmVyVmFsdWVNYXAuc2V0KHZhck5hbWUsIG5ld1ZhbHVlKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOa4heepuuWPquivu3Zv5Y+Y5pu0XHJcbiAgICogQHBhcmFtIGNoYW5nZURldGFpbCBcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgY2xlYXJDaGFuZ2VEZXRhaWwoY2hhbmdlRGV0YWlsOiBDaGFuZ2VEZXRhaWwpIHtcclxuICAgIGlmICghY2hhbmdlRGV0YWlsIHx8IE9iamVjdC5rZXlzKGNoYW5nZURldGFpbC5DaGFuZ2VJbmZvKS5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgT2JqZWN0LmtleXMoY2hhbmdlRGV0YWlsLkNoYW5nZUluZm8pLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5nVmFyaWFibGU6IE5nVmFyaWFibGUgPSB0aGlzLm5nVmFyaWFibGVNYXAuZ2V0KGtleSk7XHJcbiAgICAgIGlmICghbmdWYXJpYWJsZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBtYXBwaW5nID0gbmdWYXJpYWJsZS5tYXBwaW5nO1xyXG4gICAgICBjb25zdCBuZXdWYWx1ZSA9IHRoaXMuZ2V0VmFsdWVGcm9tVUlTdGF0ZShtYXBwaW5nKTtcclxuICAgICAgdGhpcy5pbm5lclZhbHVlTWFwLnNldChrZXksIG5ld1ZhbHVlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiBBcHBlbmQgY2hhbmdlZCB2YXJpYWJsZSB0byBDaGFuZ2VEZXRhaWwgaW5zdGFuY2UuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhcHBlbmRUb0NoYW5nZUluZm8oY2hhbmdlRGV0YWlsOiBDaGFuZ2VEZXRhaWwsIHZhck5hbWU6IHN0cmluZywgdmFyVmFsdWU6IGFueSk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMuaXNVZHRWYXJpYWJsZSh2YXJWYWx1ZSkgPT09IHRydWUpIHtcclxuICAgICAgY29uc3QgdWR0VmFyQ2hhbmdlRGV0YWlsID0gQmVmQ2hhbmdlVXRpbC5jcmVhdGVFbXB0eShDaGFuZ2VEZXRhaWxUeXBlLk1vZGlmeSk7XHJcbiAgICAgIHVkdFZhckNoYW5nZURldGFpbC5DaGFuZ2VJbmZvID0gdmFyVmFsdWU7XHJcbiAgICAgIGNoYW5nZURldGFpbC5DaGFuZ2VJbmZvW3Zhck5hbWVdID0gdWR0VmFyQ2hhbmdlRGV0YWlsO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY2hhbmdlRGV0YWlsLkNoYW5nZUluZm9bdmFyTmFtZV0gPSB2YXJWYWx1ZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOS7jlVJU3RhdGXkuIrojrflj5blgLxcclxuICAgKi9cclxuICBwcml2YXRlIGdldFZhbHVlRnJvbVVJU3RhdGUobWFwcGluZzogc3RyaW5nKTogYW55IHtcclxuICAgIGNvbnN0IHVpU3RhdGUgPSB0aGlzLmdldFJvb3RVSVN0YXRlKCk7XHJcblxyXG4gICAgLy8g6K6h566XdmFsdWVcclxuICAgIGNvbnN0IG1hcHBpbmdBcnJheSA9IG1hcHBpbmcuc3BsaXQoJy4nKTtcclxuICAgIGNvbnN0IHZhbHVlID0gbWFwcGluZ0FycmF5LnJlZHVjZSgoYWNjdW11bGF0b3I6IGFueSwgY3VycmVudFZhbHVlOiBhbnkpID0+IHtcclxuICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yID8gYWNjdW11bGF0b3JbY3VycmVudFZhbHVlXSA6IG51bGw7XHJcbiAgICB9LCB1aVN0YXRlKTtcclxuXHJcbiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBEYXRlKSB7XHJcbiAgICAgIHJldHVybiBmb3JtYXQodmFsdWUsICd5eXl5LU1NLWRkIEhIOm1tOnNzJyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdmFsdWU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bmoLnnu4Tku7bkuIrnmoRVSVN0YXRlXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRSb290VUlTdGF0ZSgpOiBVSVN0YXRlIHtcclxuXHJcbiAgICBsZXQgcm9vdEZyYW1lQ29udGV4dCA9IHRoaXMuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldFJvb3RGcmFtZUNvbnRleHQoKTtcclxuICAgIGlmICh0aGlzLmluamVjdG9yKSB7XHJcbiAgICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuaW5qZWN0b3IuZ2V0PEZyYW1lQ29udGV4dD4oRnJhbWVDb250ZXh0LCBudWxsKTtcclxuICAgICAgaWYgKGZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgIGNvbnN0IHZpcnR1YWxSb290RnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XHJcbiAgICAgICAgcm9vdEZyYW1lQ29udGV4dCA9IHZpcnR1YWxSb290RnJhbWVDb250ZXh0IHx8IHJvb3RGcmFtZUNvbnRleHQ7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGlmICghcm9vdEZyYW1lQ29udGV4dCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcm9vdEZyYW1lQ29udGV4dC51aVN0YXRlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5YC85q+U6L6DXHJcbiAgICogQHRvZG8g5Li05pe26YeH55So6L+Z56eN5pa55byPXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpc1ZhbHVlRXF1YWwoc3JjVmFsdWU6IGFueSwgZHN0VmFsdWU6IGFueSk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHNyY1ZhbHVlKSA9PT0gSlNPTi5zdHJpbmdpZnkoZHN0VmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2hlY2sgaWYgdGhlIG9iamVjdCBpcyBhIHBsYWluIG9iamVjdFxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNVZHRWYXJpYWJsZShvYmo6IGFueSk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIG9iaiAmJiBvYmouY29uc3RydWN0b3IgJiZcclxuICAgICAgb2JqLnRvU3RyaW5nKCkgPT09ICdbb2JqZWN0IE9iamVjdF0nICYmXHJcbiAgICAgIG9iai5jb25zdHJ1Y3Rvci5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkoJ2lzUHJvdG90eXBlT2YnKTtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiDorr7nva7lgLzliLBVSVN0YXRlXHJcbiAgICogQHRvZG/vvJpcclxuICAgKiAx44CB5pyN5Yqh5Zmo56uv5LiN5pSv5oyB77ybXHJcbiAgICogMuOAgeaXpeacn+exu+Wei+WkhOeQhuaWueahiOW+heWumuOAglxyXG4gICAqL1xyXG4gIHByaXZhdGUgc2V0VmFsdWVUb1VJU3RhdGUobWFwcGluZzogc3RyaW5nLCB2YWx1ZTogYW55KTogdm9pZCB7XHJcbiAgICBjb25zdCB1aVN0YXRlID0gdGhpcy5nZXRSb290VUlTdGF0ZSgpO1xyXG4gICAgdWlTdGF0ZVttYXBwaW5nXSA9IHZhbHVlO1xyXG4gIH1cclxuXHJcblxyXG59XHJcblxyXG5leHBvcnQgeyBCZWZWYXJpYWJsZU1hbmFnZXIgfTtcclxuIl19