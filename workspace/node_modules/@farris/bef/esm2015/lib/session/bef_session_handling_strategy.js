/**
 * @fileoverview added by tsickle
 * Generated from: lib/session/bef_session_handling_strategy.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*
 * @Author: Witt
 * @Date: 2018-10-11 20:32:02
 * @Last Modified by: Witt
 * @Last Modified time: 2020-03-03 16:46:39
 */
import { HttpHeaders } from '@angular/common/http';
import { of } from 'rxjs';
import { tap } from 'rxjs/operators';
import { HttpHeaderUtil } from '../utils/index';
import { HttpService } from '../http_service';
import { AppContext } from '@farris/devkit';
/**
 * BefSession处理策略类
 * @abstract
 */
class BefSessionHandlingStrategy {
    /**
     * 框架SessionId（用户的或者功能菜单的）
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    getFrmSessionId(runtimeContext) {
        return this.frmSessionService.getCurrentSessionId(runtimeContext);
    }
    /**
     * @protected
     * @return {?}
     */
    get frmSessionId() {
        return this.frmSessionService.getCurrentSessionId();
    }
    /**
     * 构造函数
     * @param {?} storageStrategy
     * @param {?} frmSessionService
     */
    constructor(storageStrategy, frmSessionService) {
        this.storageStrategy = storageStrategy;
        this.frmSessionService = frmSessionService;
    }
    /**
     * 获取框架SessionId
     * @param {?=} runtimeContext
     * @return {?}
     */
    getFrameworkSessionId(runtimeContext) {
        return this.getFrmSessionId(runtimeContext);
    }
    /**
     * 从缓存中获取BeSession
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    getSessionIdFromStorage(runtimeContext) {
        /** @type {?} */
        const sessionStorageKey = this.getSessionStorageKey(runtimeContext);
        /** @type {?} */
        const beSessionId = this.storageStrategy.getItem(sessionStorageKey);
        return beSessionId;
    }
}
if (false) {
    /**
     * 存储策略
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.storageStrategy;
    /**
     * 框架Session服务
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.frmSessionService;
    /**
     * 获取SessionId
     * @abstract
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.getSessionId = function () { };
    /**
     * @abstract
     * @param {?} sessionId
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.setSessionId = function (sessionId) { };
    /**
     * @abstract
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.clearSessionId = function () { };
    /**
     * @abstract
     * @param {?} headers
     * @param {?=} runtimeContext
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.extendRequestHeaders = function (headers, runtimeContext) { };
    /**
     * @abstract
     * @param {?} headers
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.handleReponseHeaders = function (headers) { };
    /**
     * @abstract
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.getSessionStorageKey = function (runtimeContext) { };
}
/**
 * 隔离的BeSession处理策略（此策略必须保证injector为null的情况下正常影讯性）
 * \@summary
 * ----------------------------------------
 * 处理原则：
 * 1、通过createSession创建；
 * 2、每个Repository拥有独立的BeSession；
 * 3、访问BE的EAPI时，通过header里的SessionId传递；
 * ----------------------------------------
 * 兼容性考虑：
 * 1、有产品部直接new BeSessionService()，没有传递
 */
class BefSeparatedSessionHandlingStrategy extends BefSessionHandlingStrategy {
    /**
     * 构造函数
     * @param {?} storageStrategy
     * @param {?} frmSessionService
     * @param {?} httpClient
     * @param {?} beBaseUri
     * @param {?} injector
     */
    constructor(storageStrategy, frmSessionService, httpClient, beBaseUri, injector) {
        super(storageStrategy, frmSessionService);
        this.beSessionUri = beBaseUri;
        this.httpClient = httpClient;
        this.httpService = new HttpService(this.httpClient);
        this.injector = injector;
    }
    /**
     * 获取BeSessionId
     * @return {?}
     */
    getSessionId() {
        /** @type {?} */
        const beSessionId = this.getSessionIdFromStorage();
        if (beSessionId) {
            return of(beSessionId);
        }
        return this.createSession();
    }
    /**
     * 设置BeSessionId
     * @param {?} sessionId
     * @return {?}
     */
    setSessionId(sessionId) {
        /** @type {?} */
        const sessionKey = this.getSessionStorageKey();
        this.storageStrategy.setItem(sessionKey, sessionId);
    }
    /**
     * 清空Sessionid
     * @return {?}
     */
    clearSessionId() {
        /** @type {?} */
        const sessionKey = this.getSessionStorageKey();
        // this.storageStrategy.removeItem(sessionKey);
        this.storageStrategy.clear(this.frmSessionId, sessionKey);
    }
    /**
     * 扩展Session相关头信息
     * @param {?} headers
     * @param {?=} runtimeContext
     * @return {?}
     */
    extendRequestHeaders(headers, runtimeContext) {
        /** @type {?} */
        const frmSessionId = this.getFrameworkSessionId(runtimeContext);
        /** @type {?} */
        const beSessionId = this.getSessionIdFromStorage(runtimeContext);
        headers = HttpHeaderUtil.appendCafRuntimeCommonVariable(headers, frmSessionId);
        if (beSessionId) {
            headers = HttpHeaderUtil.appendCafRuntimeContext(headers, beSessionId);
            headers = HttpHeaderUtil.appendSessionId(headers, beSessionId);
        }
        // const appContext = this.injector.get<AppContext>(AppContext, null);
        //if (appContext) {
        // const appId = appContext.ApplicationId;
        headers = HttpHeaderUtil.appendFuncInstId(headers, this.beSessionUri);
        // }
        // headers = HttpHeaderUtil.appendRequireMessage(headers, true);
        return headers;
    }
    /**
     * 处理服务器端返回的headers
     * @param {?} headers
     * @return {?}
     */
    handleReponseHeaders(headers) {
    }
    /**
     * 创建BeSessionId
     * @return {?}
     */
    createSession() {
        /** @type {?} */
        const params = {
            responseType: 'text'
        };
        if (!!this.frmSessionId) {
            /** @type {?} */
            const appContext = this.injector.get(AppContext, null);
            params.headers = new HttpHeaders({ SessionId: this.frmSessionId });
            params.headers = params.headers.append('X-CAF-Runtime-CommonVariable', this.frmSessionId);
            //if (appContext) {
            // const appId = appContext.ApplicationId;
            params.headers = params.headers.append('Func-Inst-Id', this.beSessionUri);
            //}
            params.headers = HttpHeaderUtil.toJson(params.headers);
        }
        return this.httpService.request('POST', this.beSessionUri, params).pipe(tap((/**
         * @param {?} beSessionId
         * @return {?}
         */
        (beSessionId) => {
            this.setSessionId(beSessionId);
        })));
    }
    /**
     * @return {?}
     */
    extendHttpHeader() {
    }
    /**
     * 获取某个Repository对应的BeSession的唯一key
     * \@summary
     * 1、在使用独立BeSession的组合表单中，需要通过BeSessionUri隔离；
     * 2、在Debug模式下，FrmSessionId=UserSessionid，如果只用它作key，
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    getSessionStorageKey(runtimeContext) {
        /** @type {?} */
        let sessionId = null;
        if (runtimeContext) {
            sessionId = this.getFrameworkSessionId(runtimeContext);
        }
        else {
            sessionId = this.frmSessionId;
        }
        return `${sessionId}_${this.beSessionUri}`;
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    BefSeparatedSessionHandlingStrategy.prototype.injector;
    /**
     * 创建Session的的EAPI地址
     * @type {?}
     * @private
     */
    BefSeparatedSessionHandlingStrategy.prototype.beSessionUri;
    /**
     * httpClient
     * @type {?}
     * @private
     */
    BefSeparatedSessionHandlingStrategy.prototype.httpClient;
    /**
     * @type {?}
     * @private
     */
    BefSeparatedSessionHandlingStrategy.prototype.httpService;
}
class BefUnifiedSessionHandlingStrategy extends BefSessionHandlingStrategy {
    /**
     * 构造函数
     * @param {?} storageStrategy
     * @param {?} frmSessionService
     * @param {?} beBaseUri
     * @param {?} injector
     */
    constructor(storageStrategy, frmSessionService, beBaseUri, injector) {
        super(storageStrategy, frmSessionService);
        this.beSessionUri = beBaseUri;
        this.injector = injector;
    }
    /**
     * @return {?}
     */
    getSessionId() {
        /** @type {?} */
        const sessionKey = this.getSessionStorageKey();
        /** @type {?} */
        const sessionId = this.storageStrategy.getItem(sessionKey);
        return of(sessionId);
        // return of(null);
    }
    /**
     * 设置BeSessionId
     * @param {?} sessionId
     * @return {?}
     */
    setSessionId(sessionId) {
        /** @type {?} */
        const sessionKey = this.getSessionStorageKey();
        this.storageStrategy.setItem(sessionKey, sessionId);
    }
    /**
     * 清空Sessionid
     * @return {?}
     */
    clearSessionId() {
        /** @type {?} */
        const sessionKey = this.getSessionStorageKey();
        this.storageStrategy.removeItem(sessionKey);
    }
    /**
     * 扩展Session相关头信息
     * @param {?} headers
     * @param {?=} runtimeContext
     * @return {?}
     */
    extendRequestHeaders(headers, runtimeContext) {
        /** @type {?} */
        const frmSessionId = this.getFrameworkSessionId(runtimeContext);
        /** @type {?} */
        const beSessionId = this.getSessionIdFromStorage(runtimeContext);
        // headers = HttpHeaderUtil.appendRequireMessage(headers, true);
        /** @type {?} */
        const appContext = this.injector.get(AppContext, null);
        if (appContext) {
            /** @type {?} */
            const token = appContext.Token;
            headers = HttpHeaderUtil.appendFuncInstId(headers, token);
        }
        headers = HttpHeaderUtil.appendCafRuntimeCommonVariable(headers, frmSessionId);
        if (beSessionId) {
            headers = HttpHeaderUtil.appendCafRuntimeContext(headers, beSessionId);
        }
        return headers;
    }
    /**
     * 处理服务器端返回的headers
     * @param {?} headers
     * @return {?}
     */
    handleReponseHeaders(headers) {
    }
    /**
     * 获取某个Repository对应的BeSession的唯一key
     * \@summary
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    getSessionStorageKey(runtimeContext) {
        // const isDebug = false;
        // if (isDebug) {
        //   return `${this.frmSessionId}_${this.beSessionUri}`;
        // } else {
        //   return this.frmSessionId;
        // }
        /** @type {?} */
        let sessionId = null;
        if (runtimeContext) {
            sessionId = this.getFrameworkSessionId(runtimeContext);
        }
        else {
            sessionId = this.frmSessionId;
        }
        return `${sessionId}_${this.beSessionUri}`;
    }
}
if (false) {
    /**
     * 创建Session的的EAPI地址
     * @type {?}
     * @private
     */
    BefUnifiedSessionHandlingStrategy.prototype.beSessionUri;
    /**
     * @type {?}
     * @private
     */
    BefUnifiedSessionHandlingStrategy.prototype.injector;
}
export { BefSessionHandlingStrategy, BefSeparatedSessionHandlingStrategy, BefUnifiedSessionHandlingStrategy };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVmX3Nlc3Npb25faGFuZGxpbmdfc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2JlZi8iLCJzb3VyY2VzIjpbImxpYi9zZXNzaW9uL2JlZl9zZXNzaW9uX2hhbmRsaW5nX3N0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBT0EsT0FBTyxFQUFjLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQy9ELE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXJDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVoRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFOUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7OztBQUk1QyxNQUFlLDBCQUEwQjs7Ozs7OztJQWM3QixlQUFlLENBQUMsY0FBb0I7UUFDNUMsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsbUJBQW1CLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDcEUsQ0FBQzs7Ozs7SUFDRCxJQUFjLFlBQVk7UUFDeEIsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztJQUN0RCxDQUFDOzs7Ozs7SUFLRCxZQUFZLGVBQXlDLEVBQUUsaUJBQTBDO1FBQy9GLElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxpQkFBaUIsQ0FBQztJQUM3QyxDQUFDOzs7Ozs7SUFlTSxxQkFBcUIsQ0FBQyxjQUFvQjtRQUMvQyxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDOUMsQ0FBQzs7Ozs7OztJQUtTLHVCQUF1QixDQUFDLGNBQW9COztjQUM5QyxpQkFBaUIsR0FBRyxJQUFJLENBQUMs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SztZQUM5QixPQUFPLEdBQUcsY0FBYyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztTQUMzRDtRQUNELE9BQU8sR0FBRyxjQUFjLENBQUMsOEJBQThCLENBQUMsT0FBTyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQy9FLElBQUksV0FBVyxFQUFFO1lBQ2YsT0FBTyxHQUFHLGNBQWMsQ0FBQyx1QkFBdUIsQ0FBQyxPQUFPLEVBQUUsV0FBVyxDQUFDLENBQUM7U0FDeEU7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDOzs7Ozs7SUFLTSxvQkFBb0IsQ0FBQyxPQUFvQjtJQUNoRCxDQUFDOzs7Ozs7OztJQU9TLG9CQUFvQixDQUFDLGNBQW9COzs7Ozs7OztZQU83QyxTQUFTLEdBQUcsSUFBSTtRQUNwQixJQUFJLGNBQWMsRUFBRTtZQUNsQixTQUFTLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1NBQ3hEO2FBQU07WUFDTCxTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQztTQUMvQjtRQUNELE9BQU8sR0FBRyxTQUFTLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQzdDLENBQUM7Q0FDRjs7Ozs7OztJQWxGQyx5REFBNkI7Ozs7O0lBQzdCLHFEQUEyQjs7QUFtRjdCLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxtQ0FBbUMsRUFBRSxpQ0FBaUMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogQEF1dGhvcjogV2l0dFxyXG4gKiBARGF0ZTogMjAxOC0xMC0xMSAyMDozMjowMlxyXG4gKiBATGFzdCBNb2RpZmllZCBieTogV2l0dFxyXG4gKiBATGFzdCBNb2RpZmllZCB0aW1lOiAyMDIwLTAzLTAzIDE2OjQ2OjM5XHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgRnJhbWV3b3JrU2Vzc2lvblNlcnZpY2UgfSBmcm9tICcuLi9mcmFtZXdvcmtfc2Vzc2lvbl9zZXJ2aWNlJztcclxuaW1wb3J0IHsgSHR0cEhlYWRlclV0aWwgfSBmcm9tICcuLi91dGlscy9pbmRleCc7XHJcbmltcG9ydCB7IEJlU2Vzc2lvblN0b3JhZ2VTdHJhdGVneSB9IGZyb20gJy4vYmVmX3Nlc3Npb25fc3RvcmFnZV9zdHJhdGVneSc7XHJcbmltcG9ydCB7IEh0dHBTZXJ2aWNlIH0gZnJvbSAnLi4vaHR0cF9zZXJ2aWNlJztcclxuaW1wb3J0IHsgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQXBwQ29udGV4dCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuLyoqXHJcbiAqIEJlZlNlc3Npb27lpITnkIbnrZbnlaXnsbtcclxuICovXHJcbmFic3RyYWN0IGNsYXNzIEJlZlNlc3Npb25IYW5kbGluZ1N0cmF0ZWd5IHtcclxuXHJcbiAgLyoqXHJcbiAgICog5a2Y5YKo562W55WlXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHN0b3JhZ2VTdHJhdGVneTogQmVTZXNzaW9uU3RvcmFnZVN0cmF0ZWd5O1xyXG5cclxuICAvKipcclxuICAgKiDmoYbmnrZTZXNzaW9u5pyN5YqhXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGZybVNlc3Npb25TZXJ2aWNlOiBGcmFtZXdvcmtTZXNzaW9uU2VydmljZTtcclxuICAvKipcclxuICAgKiDmoYbmnrZTZXNzaW9uSWTvvIjnlKjmiLfnmoTmiJbogIXlip/og73oj5zljZXnmoTvvIlcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0RnJtU2Vzc2lvbklkKHJ1bnRpbWVDb250ZXh0PzogYW55KTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLmZybVNlc3Npb25TZXJ2aWNlLmdldEN1cnJlbnRTZXNzaW9uSWQocnVudGltZUNvbnRleHQpO1xyXG4gIH1cclxuICBwcm90ZWN0ZWQgZ2V0IGZybVNlc3Npb25JZCgpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHRoaXMuZnJtU2Vzc2lvblNlcnZpY2UuZ2V0Q3VycmVudFNlc3Npb25JZCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3Ioc3RvcmFnZVN0cmF0ZWd5OiBCZVNlc3Npb25TdG9yYWdlU3RyYXRlZ3ksIGZybVNlc3Npb25TZXJ2aWNlOiBGcmFtZXdvcmtTZXNzaW9uU2VydmljZSkge1xyXG4gICAgdGhpcy5zdG9yYWdlU3RyYXRlZ3kgPSBzdG9yYWdlU3RyYXRlZ3k7XHJcbiAgICB0aGlzLmZybVNlc3Npb25TZXJ2aWNlID0gZnJtU2Vzc2lvblNlcnZpY2U7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5ZTZXNzaW9uSWRcclxuICAgKi9cclxuICBwdWJsaWMgYWJzdHJhY3QgZ2V0U2Vzc2lvbklkKCk6IE9ic2VydmFibGU8c3RyaW5nPjtcclxuICBwdWJsaWMgYWJzdHJhY3Qgc2V0U2Vzc2lvbklkKHNlc3Npb25JZCk6IHZvaWQ7XHJcbiAgcHVibGljIGFic3RyYWN0IGNsZWFyU2Vzc2lvbklkKCk6IHZvaWQ7XHJcbiAgcHVibGljIGFic3RyYWN0IGV4dGVuZFJlcXVlc3RIZWFkZXJzKGhlYWRlcnM6IEh0dHBIZWFkZXJzLCBydW50aW1lQ29udGV4dD86IGFueSk6IEh0dHBIZWFkZXJzO1xyXG4gIHB1YmxpYyBhYnN0cmFjdCBoYW5kbGVSZXBvbnNlSGVhZGVycyhoZWFkZXJzOiBIdHRwSGVhZGVycyk6IHZvaWQ7XHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldFNlc3Npb25TdG9yYWdlS2V5KHJ1bnRpbWVDb250ZXh0PzogYW55KTogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiDojrflj5bmoYbmnrZTZXNzaW9uSWRcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RnJhbWV3b3JrU2Vzc2lvbklkKHJ1bnRpbWVDb250ZXh0PzogYW55KSB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRGcm1TZXNzaW9uSWQocnVudGltZUNvbnRleHQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5LuO57yT5a2Y5Lit6I635Y+WQmVTZXNzaW9uXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGdldFNlc3Npb25JZEZyb21TdG9yYWdlKHJ1bnRpbWVDb250ZXh0PzogYW55KSB7XHJcbiAgICBjb25zdCBzZXNzaW9uU3RvcmFnZUtleSA9IHRoaXMuZ2V0U2Vzc2lvblN0b3JhZ2VLZXkocnVudGltZUNvbnRleHQpO1xyXG4gICAgY29uc3QgYmVTZXNzaW9uSWQgPSB0aGlzLnN0b3JhZ2VTdHJhdGVneS5nZXRJdGVtKHNlc3Npb25TdG9yYWdlS2V5KTtcclxuICAgIHJldHVybiBiZVNlc3Npb25JZDtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDpmpTnprvnmoRCZVNlc3Npb27lpITnkIbnrZbnlaXvvIjmraTnrZbnlaXlv4Xpobvkv53or4FpbmplY3RvcuS4um51bGznmoTmg4XlhrXkuIvmraPluLjlvbHorq/mgKfvvIlcclxuICogQHN1bW1hcnlcclxuICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gKiDlpITnkIbljp/liJnvvJpcclxuICogMeOAgemAmui/h2NyZWF0ZVNlc3Npb27liJvlu7rvvJtcclxuICogMuOAgeavj+S4qlJlcG9zaXRvcnnmi6XmnInni6znq4vnmoRCZVNlc3Npb27vvJtcclxuICogM+OAgeiuv+mXrkJF55qERUFQSeaXtu+8jOmAmui/h2hlYWRlcumHjOeahFNlc3Npb25JZOS8oOmAku+8m1xyXG4gKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiAqIOWFvOWuueaAp+iAg+iZke+8mlxyXG4gKiAx44CB5pyJ5Lqn5ZOB6YOo55u05o6lbmV3IEJlU2Vzc2lvblNlcnZpY2UoKe+8jOayoeacieS8oOmAklxyXG4gKi9cclxuY2xhc3MgQmVmU2VwYXJhdGVkU2Vzc2lvbkhhbmRsaW5nU3RyYXRlZ3kgZXh0ZW5kcyBCZWZTZXNzaW9uSGFuZGxpbmdTdHJhdGVneSB7XHJcbiAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3I7XHJcbiAgLyoqXHJcbiAgICog5Yib5bu6U2Vzc2lvbueahOeahEVBUEnlnLDlnYBcclxuICAgKi9cclxuICBwcml2YXRlIGJlU2Vzc2lvblVyaTogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiBodHRwQ2xpZW50XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBodHRwQ2xpZW50OiBIdHRwQ2xpZW50O1xyXG5cclxuICBwcml2YXRlIGh0dHBTZXJ2aWNlOiBIdHRwU2VydmljZTtcclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHN0b3JhZ2VTdHJhdGVneTogQmVTZXNzaW9uU3RvcmFnZVN0cmF0ZWd5LCBmcm1TZXNzaW9uU2VydmljZTogRnJhbWV3b3JrU2Vzc2lvblNlcnZpY2UsXHJcbiAgICBodHRwQ2xpZW50OiBIdHRwQ2xpZW50LCBiZUJhc2VVcmk6IHN0cmluZywgaW5qZWN0b3I6IEluamVjdG9yXHJcbiAgKSB7XHJcbiAgICBzdXBlcihzdG9yYWdlU3RyYXRlZ3ksIGZybVNlc3Npb25TZXJ2aWNlKTtcclxuICAgIHRoaXMuYmVTZXNzaW9uVXJpID0gYmVCYXNlVXJpO1xyXG4gICAgdGhpcy5odHRwQ2xpZW50ID0gaHR0cENsaWVudDtcclxuICAgIHRoaXMuaHR0cFNlcnZpY2UgPSBuZXcgSHR0cFNlcnZpY2UodGhpcy5odHRwQ2xpZW50KTtcclxuICAgIHRoaXMuaW5qZWN0b3IgPSBpbmplY3RvcjtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlkJlU2Vzc2lvbklkXHJcbiAgICovXHJcbiAgcHVibGljIGdldFNlc3Npb25JZCgpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xyXG4gICAgY29uc3QgYmVTZXNzaW9uSWQgPSB0aGlzLmdldFNlc3Npb25JZEZyb21TdG9yYWdlKCk7XHJcbiAgICBpZiAoYmVTZXNzaW9uSWQpIHtcclxuICAgICAgcmV0dXJuIG9mKGJlU2Vzc2lvbklkKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLmNyZWF0ZVNlc3Npb24oKTtcclxuXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDorr7nva5CZVNlc3Npb25JZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzZXRTZXNzaW9uSWQoc2Vzc2lvbklkOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGNvbnN0IHNlc3Npb25LZXkgPSB0aGlzLmdldFNlc3Npb25TdG9yYWdlS2V5KCk7XHJcbiAgICB0aGlzLnN0b3JhZ2VTdHJhdGVneS5zZXRJdGVtKHNlc3Npb25LZXksIHNlc3Npb25JZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmuIXnqbpTZXNzaW9uaWRcclxuICAgKi9cclxuICBwdWJsaWMgY2xlYXJTZXNzaW9uSWQoKSB7XHJcbiAgICBjb25zdCBzZXNzaW9uS2V5ID0gdGhpcy5nZXRTZXNzaW9uU3RvcmFnZUtleSgpO1xyXG4gICAgLy8gdGhpcy5zdG9yYWdlU3RyYXRlZ3kucmVtb3ZlSXRlbShzZXNzaW9uS2V5KTtcclxuICAgIHRoaXMuc3RvcmFnZVN0cmF0ZWd5LmNsZWFyKHRoaXMuZnJtU2Vzc2lvbklkLCBzZXNzaW9uS2V5KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJqeWxlVNlc3Npb27nm7jlhbPlpLTkv6Hmga9cclxuICAgKi9cclxuICBwdWJsaWMgZXh0ZW5kUmVxdWVzdEhlYWRlcnMoaGVhZGVyczogSHR0cEhlYWRlcnMsIHJ1bnRpbWVDb250ZXh0PzogYW55KTogSHR0cEhlYWRlcnMge1xyXG4gICAgY29uc3QgZnJtU2Vzc2lvbklkID0gdGhpcy5nZXRGcmFtZXdvcmtTZXNzaW9uSWQocnVudGltZUNvbnRleHQpO1xyXG4gICAgY29uc3QgYmVTZXNzaW9uSWQgPSB0aGlzLmdldFNlc3Npb25JZEZyb21TdG9yYWdlKHJ1bnRpbWVDb250ZXh0KTtcclxuICAgIGhlYWRlcnMgPSBIdHRwSGVhZGVyVXRpbC5hcHBlbmRDYWZSdW50aW1lQ29tbW9uVmFyaWFibGUoaGVhZGVycywgZnJtU2Vzc2lvbklkKTtcclxuICAgIGlmIChiZVNlc3Npb25JZCkge1xyXG4gICAgICBoZWFkZXJzID0gSHR0cEhlYWRlclV0aWwuYXBwZW5kQ2FmUnVudGltZUNvbnRleHQoaGVhZGVycywgYmVTZXNzaW9uSWQpO1xyXG4gICAgICBoZWFkZXJzID0gSHR0cEhlYWRlclV0aWwuYXBwZW5kU2Vzc2lvbklkKGhlYWRlcnMsIGJlU2Vzc2lvbklkKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBjb25zdCBhcHBDb250ZXh0ID0gdGhpcy5pbmplY3Rvci5nZXQ8QXBwQ29udGV4dD4oQXBwQ29udGV4dCwgbnVsbCk7XHJcbiAgICAvL2lmIChhcHBDb250ZXh0KSB7XHJcbiAgICAvLyBjb25zdCBhcHBJZCA9IGFwcENvbnRleHQuQXBwbGljYXRpb25JZDtcclxuICAgIGhlYWRlcnMgPSBIdHRwSGVhZGVyVXRpbC5hcHBlbmRGdW5jSW5zdElkKGhlYWRlcnMsIHRoaXMuYmVTZXNzaW9uVXJpKTtcclxuICAgIC8vIH1cclxuICAgIC8vIGhlYWRlcnMgPSBIdHRwSGVhZGVyVXRpbC5hcHBlbmRSZXF1aXJlTWVzc2FnZShoZWFkZXJzLCB0cnVlKTtcclxuICAgIHJldHVybiBoZWFkZXJzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5aSE55CG5pyN5Yqh5Zmo56uv6L+U5Zue55qEaGVhZGVyc1xyXG4gICAqL1xyXG4gIHB1YmxpYyBoYW5kbGVSZXBvbnNlSGVhZGVycyhoZWFkZXJzOiBIdHRwSGVhZGVycyk6IHZvaWQge1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yib5bu6QmVTZXNzaW9uSWRcclxuICAgKi9cclxuICBwdWJsaWMgY3JlYXRlU2Vzc2lvbigpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xyXG4gICAgY29uc3QgcGFyYW1zOiB7IFtwcm9wTmFtZTogc3RyaW5nXTogYW55IH0gPSB7XHJcbiAgICAgIHJlc3BvbnNlVHlwZTogJ3RleHQnXHJcbiAgICB9O1xyXG4gICAgaWYgKCEhdGhpcy5mcm1TZXNzaW9uSWQpIHtcclxuICAgICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMuaW5qZWN0b3IuZ2V0PEFwcENvbnRleHQ+KEFwcENvbnRleHQsIG51bGwpO1xyXG4gICAgICBwYXJhbXMuaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycyh7IFNlc3Npb25JZDogdGhpcy5mcm1TZXNzaW9uSWQgfSk7XHJcbiAgICAgIHBhcmFtcy5oZWFkZXJzID0gcGFyYW1zLmhlYWRlcnMuYXBwZW5kKCdYLUNBRi1SdW50aW1lLUNvbW1vblZhcmlhYmxlJywgdGhpcy5mcm1TZXNzaW9uSWQpO1xyXG4gICAgICAvL2lmIChhcHBDb250ZXh0KSB7XHJcbiAgICAgIC8vIGNvbnN0IGFwcElkID0gYXBwQ29udGV4dC5BcHBsaWNhdGlvbklkO1xyXG4gICAgICBwYXJhbXMuaGVhZGVycyA9IHBhcmFtcy5oZWFkZXJzLmFwcGVuZCgnRnVuYy1JbnN0LUlkJywgdGhpcy5iZVNlc3Npb25VcmkpO1xyXG4gICAgICAvL31cclxuICAgICAgcGFyYW1zLmhlYWRlcnMgPSBIdHRwSGVhZGVyVXRpbC50b0pzb24ocGFyYW1zLmhlYWRlcnMpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0aGlzLmh0dHBTZXJ2aWNlLnJlcXVlc3QoJ1BPU1QnLCB0aGlzLmJlU2Vzc2lvblVyaSwgcGFyYW1zKS5waXBlKFxyXG4gICAgICB0YXAoKGJlU2Vzc2lvbklkOiBzdHJpbmcpID0+IHtcclxuICAgICAgICB0aGlzLnNldFNlc3Npb25JZChiZVNlc3Npb25JZCk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGV4dGVuZEh0dHBIZWFkZXIoKSB7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bmn5DkuKpSZXBvc2l0b3J55a+55bqU55qEQmVTZXNzaW9u55qE5ZSv5LiAa2V5XHJcbiAgICogQHN1bW1hcnlcclxuICAgKiAx44CB5Zyo5L2/55So54us56uLQmVTZXNzaW9u55qE57uE5ZCI6KGo5Y2V5Lit77yM6ZyA6KaB6YCa6L+HQmVTZXNzaW9uVXJp6ZqU56a777ybXHJcbiAgICogMuOAgeWcqERlYnVn5qih5byP5LiL77yMRnJtU2Vzc2lvbklkPVVzZXJTZXNzaW9uaWTvvIzlpoLmnpzlj6rnlKjlroPkvZxrZXnvvIxcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0U2Vzc2lvblN0b3JhZ2VLZXkocnVudGltZUNvbnRleHQ/OiBhbnkpOiBzdHJpbmcge1xyXG4gICAgbGV0IHNlc3Npb25JZCA9IG51bGw7XHJcbiAgICBpZiAocnVudGltZUNvbnRleHQpIHtcclxuICAgICAgc2Vzc2lvbklkID0gdGhpcy5nZXRGcmFtZXdvcmtTZXNzaW9uSWQocnVudGltZUNvbnRleHQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgc2Vzc2lvbklkID0gdGhpcy5mcm1TZXNzaW9uSWQ7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYCR7c2Vzc2lvbklkfV8ke3RoaXMuYmVTZXNzaW9uVXJpfWA7XHJcbiAgfVxyXG5cclxufVxyXG5cclxuXHJcbmNsYXNzIEJlZlVuaWZpZWRTZXNzaW9uSGFuZGxpbmdTdHJhdGVneSBleHRlbmRzIEJlZlNlc3Npb25IYW5kbGluZ1N0cmF0ZWd5IHtcclxuXHJcbiAgLyoqXHJcbiAgICog5Yib5bu6U2Vzc2lvbueahOeahEVBUEnlnLDlnYBcclxuICAgKi9cclxuICBwcml2YXRlIGJlU2Vzc2lvblVyaTogc3RyaW5nO1xyXG4gIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yO1xyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHN0b3JhZ2VTdHJhdGVneTogQmVTZXNzaW9uU3RvcmFnZVN0cmF0ZWd5LCBmcm1TZXNzaW9uU2VydmljZTogRnJhbWV3b3JrU2Vzc2lvblNlcnZpY2UsIGJlQmFzZVVyaTogc3RyaW5nLCBpbmplY3RvcjogSW5qZWN0b3JcclxuICApIHtcclxuICAgIHN1cGVyKHN0b3JhZ2VTdHJhdGVneSwgZnJtU2Vzc2lvblNlcnZpY2UpO1xyXG4gICAgdGhpcy5iZVNlc3Npb25VcmkgPSBiZUJhc2VVcmk7XHJcbiAgICB0aGlzLmluamVjdG9yID0gaW5qZWN0b3I7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0U2Vzc2lvbklkKCk6IE9ic2VydmFibGU8c3RyaW5nPiB7XHJcbiAgICBjb25zdCBzZXNzaW9uS2V5ID0gdGhpcy5nZXRTZXNzaW9uU3RvcmFnZUtleSgpO1xyXG4gICAgY29uc3Qgc2Vzc2lvbklkID0gdGhpcy5zdG9yYWdlU3RyYXRlZ3kuZ2V0SXRlbShzZXNzaW9uS2V5KTtcclxuICAgIHJldHVybiBvZihzZXNzaW9uSWQpXHJcbiAgICAvLyByZXR1cm4gb2YobnVsbCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDorr7nva5CZVNlc3Npb25JZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzZXRTZXNzaW9uSWQoc2Vzc2lvbklkOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGNvbnN0IHNlc3Npb25LZXkgPSB0aGlzLmdldFNlc3Npb25TdG9yYWdlS2V5KCk7XHJcbiAgICB0aGlzLnN0b3JhZ2VTdHJhdGVneS5zZXRJdGVtKHNlc3Npb25LZXksIHNlc3Npb25JZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmuIXnqbpTZXNzaW9uaWRcclxuICAgKi9cclxuICBwdWJsaWMgY2xlYXJTZXNzaW9uSWQoKSB7XHJcbiAgICBjb25zdCBzZXNzaW9uS2V5ID0gdGhpcy5nZXRTZXNzaW9uU3RvcmFnZUtleSgpO1xyXG4gICAgdGhpcy5zdG9yYWdlU3RyYXRlZ3kucmVtb3ZlSXRlbShzZXNzaW9uS2V5KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJqeWxlVNlc3Npb27nm7jlhbPlpLTkv6Hmga9cclxuICAgKi9cclxuICBwdWJsaWMgZXh0ZW5kUmVxdWVzdEhlYWRlcnMoaGVhZGVyczogSHR0cEhlYWRlcnMsIHJ1bnRpbWVDb250ZXh0PzogYW55KTogSHR0cEhlYWRlcnMge1xyXG4gICAgY29uc3QgZnJtU2Vzc2lvbklkID0gdGhpcy5nZXRGcmFtZXdvcmtTZXNzaW9uSWQocnVudGltZUNvbnRleHQpO1xyXG4gICAgY29uc3QgYmVTZXNzaW9uSWQgPSB0aGlzLmdldFNlc3Npb25JZEZyb21TdG9yYWdlKHJ1bnRpbWVDb250ZXh0KTtcclxuICAgIC8vIGhlYWRlcnMgPSBIdHRwSGVhZGVyVXRpbC5hcHBlbmRSZXF1aXJlTWVzc2FnZShoZWFkZXJzLCB0cnVlKTtcclxuICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLmluamVjdG9yLmdldDxBcHBDb250ZXh0PihBcHBDb250ZXh0LCBudWxsKTtcclxuICAgIGlmIChhcHBDb250ZXh0KSB7XHJcbiAgICAgIGNvbnN0IHRva2VuID0gYXBwQ29udGV4dC5Ub2tlbjtcclxuICAgICAgaGVhZGVycyA9IEh0dHBIZWFkZXJVdGlsLmFwcGVuZEZ1bmNJbnN0SWQoaGVhZGVycywgdG9rZW4pO1xyXG4gICAgfVxyXG4gICAgaGVhZGVycyA9IEh0dHBIZWFkZXJVdGlsLmFwcGVuZENhZlJ1bnRpbWVDb21tb25WYXJpYWJsZShoZWFkZXJzLCBmcm1TZXNzaW9uSWQpO1xyXG4gICAgaWYgKGJlU2Vzc2lvbklkKSB7XHJcbiAgICAgIGhlYWRlcnMgPSBIdHRwSGVhZGVyVXRpbC5hcHBlbmRDYWZSdW50aW1lQ29udGV4dChoZWFkZXJzLCBiZVNlc3Npb25JZCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaGVhZGVycztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWkhOeQhuacjeWKoeWZqOerr+i/lOWbnueahGhlYWRlcnNcclxuICAgKi9cclxuICBwdWJsaWMgaGFuZGxlUmVwb25zZUhlYWRlcnMoaGVhZGVyczogSHR0cEhlYWRlcnMpOiB2b2lkIHtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bmn5DkuKpSZXBvc2l0b3J55a+55bqU55qEQmVTZXNzaW9u55qE5ZSv5LiAa2V5XHJcbiAgICogQHN1bW1hcnlcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0U2Vzc2lvblN0b3JhZ2VLZXkocnVudGltZUNvbnRleHQ/OiBhbnkpOiBzdHJpbmcge1xyXG4gICAgLy8gY29uc3QgaXNEZWJ1ZyA9IGZhbHNlO1xyXG4gICAgLy8gaWYgKGlzRGVidWcpIHtcclxuICAgIC8vICAgcmV0dXJuIGAke3RoaXMuZnJtU2Vzc2lvbklkfV8ke3RoaXMuYmVTZXNzaW9uVXJpfWA7XHJcbiAgICAvLyB9IGVsc2Uge1xyXG4gICAgLy8gICByZXR1cm4gdGhpcy5mcm1TZXNzaW9uSWQ7XHJcbiAgICAvLyB9XHJcbiAgICBsZXQgc2Vzc2lvbklkID0gbnVsbDtcclxuICAgIGlmIChydW50aW1lQ29udGV4dCkge1xyXG4gICAgICBzZXNzaW9uSWQgPSB0aGlzLmdldEZyYW1ld29ya1Nlc3Npb25JZChydW50aW1lQ29udGV4dCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBzZXNzaW9uSWQgPSB0aGlzLmZybVNlc3Npb25JZDtcclxuICAgIH1cclxuICAgIHJldHVybiBgJHtzZXNzaW9uSWR9XyR7dGhpcy5iZVNlc3Npb25Vcml9YDtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IEJlZlNlc3Npb25IYW5kbGluZ1N0cmF0ZWd5LCBCZWZTZXBhcmF0ZWRTZXNzaW9uSGFuZGxpbmdTdHJhdGVneSwgQmVmVW5pZmllZFNlc3Npb25IYW5kbGluZ1N0cmF0ZWd5IH07XHJcbiJdfQ==