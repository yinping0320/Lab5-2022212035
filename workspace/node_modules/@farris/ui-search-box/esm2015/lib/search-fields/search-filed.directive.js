/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ApplicationRef, ComponentFactoryResolver, Directive, ElementRef, HostListener, Injector, Input, NgZone, Renderer2 } from '@angular/core';
import { debounceTime } from 'rxjs/operators';
import { SearchFieldPanelComponent } from './search-field-panel.component';
import { SearchFieldsComponent } from './search-fields.component';
import { CommonUtils } from '@farris/ui-common';
export class SearchFieldDirective {
    /**
     * @param {?} injector
     * @param {?} elRef
     * @param {?} ngzone
     * @param {?} render
     * @param {?} cfr
     * @param {?} searchFieldsRef
     * @param {?} _applicationRef
     */
    constructor(injector, elRef, ngzone, render, cfr, searchFieldsRef, _applicationRef) {
        this.injector = injector;
        this.elRef = elRef;
        this.ngzone = ngzone;
        this.render = render;
        this.cfr = cfr;
        this.searchFieldsRef = searchFieldsRef;
        this._applicationRef = _applicationRef;
        this.winResizeHandle = null;
        this.docKeydownEventHandle = null;
        this.commonUtils = null;
        this.commonUtils = this.injector.get(CommonUtils, new CommonUtils());
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        if (this.searchFieldsRef) {
            this.searchFieldsRef.hideShadowbox.subscribe((/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                this.removeFieldPanel();
            }));
        }
        this.winResizeHandle = this.render.listen(window, 'resize', (/**
         * @return {?}
         */
        () => {
            this.removeFieldPanel();
        }));
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.removeFieldPanel();
        if (this.winResizeHandle) {
            this.winResizeHandle();
        }
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    onMouseDown($event) {
        $event.stopPropagation();
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    onFieldClick($event) {
        $event.stopPropagation();
        if (!this.panelElement) {
            this.createFieldPanel();
        }
        else {
            this.removeFieldPanel();
        }
    }
    /**
     * @private
     * @return {?}
     */
    removeFieldPanel() {
        if (this.panelElement) {
            this.panelElement.remove();
            this.panelElement = null;
            this.searchFieldsRef.overLayService.destory(this.elRef.nativeElement);
            this.render.removeClass(this.elRef.nativeElement, 'selected');
        }
        if (this.docKeydownEventHandle) {
            this.docKeydownEventHandle();
            this.docKeydownEventHandle = null;
        }
    }
    /**
     * @private
     * @param {?=} enterFn
     * @return {?}
     */
    registerKeyboardEvent(enterFn) {
        if (this.commonUtils) {
            return this.commonUtils.regBodyKeydownEvent(enterFn, (/**
             * @return {?}
             */
            () => { this.removeFieldPanel(); }));
        }
        return null;
    }
    /**
     * @private
     * @return {?}
     */
    createFieldPanel() {
        this.panelElement = document.createElement('div');
        this.panelElement.classList.add('overlay-pane', 'f-filter-panel', 'f-area-hide', 'f-search-field-container');
        /** @type {?} */
        const zindex = '' + this.searchFieldsRef.commonUtils.getFloatingLayerIndex();
        this.panelElement.style.zIndex = zindex;
        document.body.appendChild(this.panelElement);
        this.setPanelPosition();
        /** @type {?} */
        const fieldPanelRef = this.cfr.resolveComponentFactory(SearchFieldPanelComponent);
        /** @type {?} */
        const _fieldPanelIns = fieldPanelRef.create(this.injector);
        this._applicationRef.attachView(_fieldPanelIns.hostView);
        _fieldPanelIns.instance.fieldOptions = this.field;
        _fieldPanelIns.instance.conditions = { field: this.field.code, value: this.field.value };
        this.panelElement.appendChild(_fieldPanelIns.location.nativeElement);
        this.panelElement.classList.add('f-area-show');
        _fieldPanelIns.instance.filterChange.pipe(debounceTime(100)).subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            // 新的查询条件
            // console.log(e);
            this.searchFieldsRef.setConditions(e);
        }));
        _fieldPanelIns.instance.remove.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        e => {
            this.searchFieldsRef.remove(e.code);
        }));
        _fieldPanelIns.changeDetectorRef.detectChanges();
        this.searchFieldsRef.overLayService.registerMouseEvent(this.elRef.nativeElement, (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (this.elRef.nativeElement.contains(e.target)) {
                return;
            }
            if (e.target.closest('.f-search-field-container')) {
                if (e.target.nodeName === 'BUTTON' && e.target.className.indexOf('close-field-panel') > -1) {
                    this.removeFieldPanel();
                }
                return;
            }
            if (e.target.closest('.date-overlay-container') || e.target.className.indexOf('date-overlay-container') > -1) {
                return;
            }
            this.removeFieldPanel();
        }));
        this.render.addClass(this.elRef.nativeElement, 'selected');
        // 处理 ESC、ENTER
        this.docKeydownEventHandle = this.registerKeyboardEvent((/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            const btnok = _fieldPanelIns.instance.btnSubmit;
            if (btnok && !btnok.nativeElement.disabled) {
                btnok.nativeElement.click();
                this.removeFieldPanel();
            }
        }));
    }
    /**
     * @private
     * @param {?=} updateTopPosition
     * @return {?}
     */
    setPanelPosition(updateTopPosition = true) {
        if (this.panelElement) {
            const { width, left, top, height } = this.getPanelSize();
            this.panelElement.style.width = `${width}px`;
            // this.panelElement.style.maxHeight = `${height}px`;
            if (updateTopPosition) {
                this.panelElement.style.top = `${top}px`;
            }
            this.panelElement.style.left = `${left}px`;
        }
    }
    /**
     * @private
     * @return {?}
     */
    getInputSizeInfo() {
        return this.elRef.nativeElement.getBoundingClientRect();
    }
    /**
     * @private
     * @return {?}
     */
    getPanelSize() {
        /** @type {?} */
        const width = 380;
        let { top, left, height } = this.getInputSizeInfo();
        /** @type {?} */
        const bottom = window.innerHeight - height - top;
        /** @type {?} */
        let panelHeight = 190;
        /** @type {?} */
        const h = top > bottom ? top : bottom;
        if (bottom > panelHeight) {
            top = top + height;
            // 面板由上向下展开
            this.panelElement.style.transformOrigin = '100% top';
        }
        else {
            if (top > bottom) {
                if (h < panelHeight) {
                    panelHeight = h - 10;
                    top = 10;
                }
                else {
                    top = top - parseInt('' + panelHeight, 10) - 5;
                }
                // 面板由下向上展开
                this.panelElement.style.transformOrigin = '100% bottom';
            }
            else {
                if (h < panelHeight) {
                    panelHeight = h - 10;
                }
                top = top + height;
            }
        }
        if (window.innerWidth - left < width) {
            left = left + width - width;
        }
        return { width, top, height: panelHeight, left };
    }
}
SearchFieldDirective.decorators = [
    { type: Directive, args: [{ selector: '[search-field]' },] }
];
/** @nocollapse */
SearchFieldDirective.ctorParameters = () => [
    { type: Injector },
    { type: ElementRef },
    { type: NgZone },
    { type: Renderer2 },
    { type: ComponentFactoryResolver },
    { type: SearchFieldsComponent },
    { type: ApplicationRef }
];
SearchFieldDirective.propDecorators = {
    field: [{ type: Input, args: ['search-field',] }],
    onMouseDown: [{ type: HostListener, args: ['mousedown', ['$event'],] }],
    onFieldClick: [{ type: HostListener, args: ['click', ['$event'],] }]
};
if (false) {
    /** @type {?} */
    SearchFieldDirective.prototype.field;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.panelElement;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.winResizeHandle;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.docKeydownEventHandle;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.commonUtils;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.elRef;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.ngzone;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.cfr;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.searchFieldsRef;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype._applicationRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLWZpbGVkLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktc2VhcmNoLWJveC8iLCJzb3VyY2VzIjpbImxpYi9zZWFyY2gtZmllbGRzL3NlYXJjaC1maWxlZC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBaUIsY0FBYyxFQUFFLHdCQUF3QixFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFxQixTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDcEwsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTlDLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQzNFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUdoRCxNQUFNLE9BQU8sb0JBQW9COzs7Ozs7Ozs7O0lBVTdCLFlBQW9CLFFBQWtCLEVBQVUsS0FBaUIsRUFDckQsTUFBYyxFQUFVLE1BQWlCLEVBQ3pDLEdBQTZCLEVBQVUsZUFBc0MsRUFBVSxlQUErQjtRQUY5RyxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBWTtRQUNyRCxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBVztRQUN6QyxRQUFHLEdBQUgsR0FBRyxDQUEwQjtRQUFVLG9CQUFlLEdBQWYsZUFBZSxDQUF1QjtRQUFVLG9CQUFlLEdBQWYsZUFBZSxDQUFnQjtRQU4xSCxvQkFBZSxHQUFHLElBQUksQ0FBQztRQUN2QiwwQkFBcUIsR0FBRyxJQUFJLENBQUM7UUFDN0IsZ0JBQVcsR0FBRyxJQUFJLENBQUM7UUFLbkIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsUUFBUSxD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OztJQTVDakMscUNBQStDOzs7OztJQUcvQyw0Q0FBa0M7Ozs7O0lBQ2xDLCtDQUErQjs7Ozs7SUFDL0IscURBQXFDOzs7OztJQUNyQywyQ0FBMkI7Ozs7O0lBRWYsd0NBQTBCOzs7OztJQUFFLHFDQUF5Qjs7Ozs7SUFDN0Qsc0NBQXNCOzs7OztJQUFFLHNDQUF5Qjs7Ozs7SUFDakQsbUNBQXFDOzs7OztJQUFFLCtDQUE4Qzs7Ozs7SUFBRSwrQ0FBdUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlclZpZXdJbml0LCBBcHBsaWNhdGlvblJlZiwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBEaXJlY3RpdmUsIEVsZW1lbnRSZWYsIEhvc3RMaXN0ZW5lciwgSW5qZWN0b3IsIElucHV0LCBOZ1pvbmUsIE9uRGVzdHJveSwgT25Jbml0LCBSZW5kZXJlcjIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgZGVib3VuY2VUaW1lIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBTZWFyY2hGaWVsZFZhbHVlIH0gZnJvbSAnLi4vc2VhcmNoLWJveC50eXBlcyc7XHJcbmltcG9ydCB7IFNlYXJjaEZpZWxkUGFuZWxDb21wb25lbnQgfSBmcm9tICcuL3NlYXJjaC1maWVsZC1wYW5lbC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBTZWFyY2hGaWVsZHNDb21wb25lbnQgfSBmcm9tICcuL3NlYXJjaC1maWVsZHMuY29tcG9uZW50JztcclxuaW1wb3J0IHsgQ29tbW9uVXRpbHMgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbic7XHJcblxyXG5ARGlyZWN0aXZlKHsgc2VsZWN0b3I6ICdbc2VhcmNoLWZpZWxkXScgfSlcclxuZXhwb3J0IGNsYXNzIFNlYXJjaEZpZWxkRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xyXG5cclxuICAgIEBJbnB1dCgnc2VhcmNoLWZpZWxkJykgZmllbGQ6IFNlYXJjaEZpZWxkVmFsdWU7XHJcblxyXG5cclxuICAgIHByaXZhdGUgcGFuZWxFbGVtZW50OiBIVE1MRWxlbWVudDtcclxuICAgIHByaXZhdGUgd2luUmVzaXplSGFuZGxlID0gbnVsbDtcclxuICAgIHByaXZhdGUgZG9jS2V5ZG93bkV2ZW50SGFuZGxlID0gbnVsbDtcclxuICAgIHByaXZhdGUgY29tbW9uVXRpbHMgPSBudWxsO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIGVsUmVmOiBFbGVtZW50UmVmLFxyXG4gICAgICAgIHByaXZhdGUgbmd6b25lOiBOZ1pvbmUsIHByaXZhdGUgcmVuZGVyOiBSZW5kZXJlcjIsIFxyXG4gICAgICAgIHByaXZhdGUgY2ZyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIHByaXZhdGUgc2VhcmNoRmllbGRzUmVmOiBTZWFyY2hGaWVsZHNDb21wb25lbnQsIHByaXZhdGUgX2FwcGxpY2F0aW9uUmVmOiBBcHBsaWNhdGlvblJlZikge1xyXG4gICAgICAgICAgICB0aGlzLmNvbW1vblV0aWxzID0gdGhpcy5pbmplY3Rvci5nZXQoQ29tbW9uVXRpbHMsIG5ldyBDb21tb25VdGlscygpKVxyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuc2VhcmNoRmllbGRzUmVmKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2VhcmNoRmllbGRzUmVmLmhpZGVTaGFkb3dib3guc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlRmllbGRQYW5lbCgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMud2luUmVzaXplSGFuZGxlID0gdGhpcy5yZW5kZXIubGlzdGVuKHdpbmRvdywgJ3Jlc2l6ZScsICgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5yZW1vdmVGaWVsZFBhbmVsKCk7ICAgICAgICAgICAgXHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XHJcbiAgICAgICAgXHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5yZW1vdmVGaWVsZFBhbmVsKCk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLndpblJlc2l6ZUhhbmRsZSkge1xyXG4gICAgICAgICAgICB0aGlzLndpblJlc2l6ZUhhbmRsZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBASG9zdExpc3RlbmVyKCdtb3VzZWRvd24nLCBbJyRldmVudCddKVxyXG4gICAgb25Nb3VzZURvd24oJGV2ZW50OiBNb3VzZUV2ZW50KSB7XHJcbiAgICAgICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgfVxyXG5cclxuICAgIEBIb3N0TGlzdGVuZXIoJ2NsaWNrJywgWyckZXZlbnQnXSlcclxuICAgIG9uRmllbGRDbGljaygkZXZlbnQ6IE1vdXNlRXZlbnQpIHtcclxuICAgICAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgaWYgKCF0aGlzLnBhbmVsRWxlbWVudCkge1xyXG4gICAgICAgICAgICB0aGlzLmNyZWF0ZUZpZWxkUGFuZWwoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUZpZWxkUGFuZWwoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZW1vdmVGaWVsZFBhbmVsKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnBhbmVsRWxlbWVudCkge1xyXG4gICAgICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5yZW1vdmUoKTtcclxuICAgICAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQgPSBudWxsO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5zZWFyY2hGaWVsZHNSZWYub3ZlckxheVNlcnZpY2UuZGVzdG9yeSh0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5yZW5kZXIucmVtb3ZlQ2xhc3ModGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LCAnc2VsZWN0ZWQnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmRvY0tleWRvd25FdmVudEhhbmRsZSkge1xyXG4gICAgICAgICAgICB0aGlzLmRvY0tleWRvd25FdmVudEhhbmRsZSgpO1xyXG4gICAgICAgICAgICB0aGlzLmRvY0tleWRvd25FdmVudEhhbmRsZSA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVnaXN0ZXJLZXlib2FyZEV2ZW50KGVudGVyRm4/OiAoKSA9PiB2b2lkKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuY29tbW9uVXRpbHMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29tbW9uVXRpbHMucmVnQm9keUtleWRvd25FdmVudChlbnRlckZuLCAoKSA9PiB7dGhpcy5yZW1vdmVGaWVsZFBhbmVsKCk7fSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY3JlYXRlRmllbGRQYW5lbCgpIHtcclxuICAgICAgICB0aGlzLnBhbmVsRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ292ZXJsYXktcGFuZScsJ2YtZmlsdGVyLXBhbmVsJywgJ2YtYXJlYS1oaWRlJywgJ2Ytc2VhcmNoLWZpZWxkLWNvbnRhaW5lcicpO1xyXG4gICAgICAgIGNvbnN0IHppbmRleCAgPSAnJyArIHRoaXMuc2VhcmNoRmllbGRzUmVmLmNvbW1vblV0aWxzLmdldEZsb2F0aW5nTGF5ZXJJbmRleCgpO1xyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50LnN0eWxlLnpJbmRleCA9IHppbmRleDtcclxuICAgICAgICBcclxuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMucGFuZWxFbGVtZW50KTtcclxuICAgICAgICB0aGlzLnNldFBhbmVsUG9zaXRpb24oKTtcclxuXHJcbiAgICAgICAgY29uc3QgZmllbGRQYW5lbFJlZiA9IHRoaXMuY2ZyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KFNlYXJjaEZpZWxkUGFuZWxDb21wb25lbnQpO1xyXG4gICAgICAgIGNvbnN0IF9maWVsZFBhbmVsSW5zID0gZmllbGRQYW5lbFJlZi5jcmVhdGUodGhpcy5pbmplY3Rvcik7XHJcbiAgICAgICAgdGhpcy5fYXBwbGljYXRpb25SZWYuYXR0YWNoVmlldyhfZmllbGRQYW5lbElucy5ob3N0Vmlldyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgX2ZpZWxkUGFuZWxJbnMuaW5zdGFuY2UuZmllbGRPcHRpb25zID0gdGhpcy5maWVsZDtcclxuICAgICAgICBfZmllbGRQYW5lbElucy5pbnN0YW5jZS5jb25kaXRpb25zID0geyBmaWVsZDogdGhpcy5maWVsZC5jb2RlLCB2YWx1ZTogdGhpcy5maWVsZC52YWx1ZSB9XHJcblxyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50LmFwcGVuZENoaWxkKF9maWVsZFBhbmVsSW5zLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ2YtYXJlYS1zaG93Jyk7XHJcblxyXG4gICAgICAgIF9maWVsZFBhbmVsSW5zLmluc3RhbmNlLmZpbHRlckNoYW5nZS5waXBlKFxyXG4gICAgICAgICAgICBkZWJvdW5jZVRpbWUoMTAwKVxyXG4gICAgICAgICkuc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgLy8g5paw55qE5p+l6K+i5p2h5Lu2XHJcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGUpO1xyXG4gICAgICAgICAgICB0aGlzLnNlYXJjaEZpZWxkc1JlZi5zZXRDb25kaXRpb25zKGUpO1xyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIF9maWVsZFBhbmVsSW5zLmluc3RhbmNlLnJlbW92ZS5zdWJzY3JpYmUoZSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuc2VhcmNoRmllbGRzUmVmLnJlbW92ZShlLmNvZGUpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBfZmllbGRQYW5lbElucy5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcblxyXG4gICAgICAgIHRoaXMuc2VhcmNoRmllbGRzUmVmLm92ZXJMYXlTZXJ2aWNlLnJlZ2lzdGVyTW91c2VFdmVudCh0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQsIChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudC5jb250YWlucyhlLnRhcmdldCkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJy5mLXNlYXJjaC1maWVsZC1jb250YWluZXInKSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGUudGFyZ2V0Lm5vZGVOYW1lID09PSAnQlVUVE9OJyAmJiBlLnRhcmdldC5jbGFzc05hbWUuaW5kZXhPZignY2xvc2UtZmllbGQtcGFuZWwnKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVGaWVsZFBhbmVsKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcuZGF0ZS1vdmVybGF5LWNvbnRhaW5lcicpIHx8IGUudGFyZ2V0LmNsYXNzTmFtZS5pbmRleE9mKCdkYXRlLW92ZXJsYXktY29udGFpbmVyJykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUZpZWxkUGFuZWwoKTtcclxuICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIHRoaXMucmVuZGVyLmFkZENsYXNzKHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudCwgJ3NlbGVjdGVkJyk7XHJcblxyXG4gICAgICAgIC8vIOWkhOeQhiBFU0PjgIFFTlRFUlxyXG4gICAgICAgIHRoaXMuZG9jS2V5ZG93bkV2ZW50SGFuZGxlID0gdGhpcy5yZWdpc3RlcktleWJvYXJkRXZlbnQoKCkgPT4gXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBjb25zdCBidG5vayA9IF9maWVsZFBhbmVsSW5zLmluc3RhbmNlLmJ0blN1Ym1pdDtcclxuICAgICAgICAgICAgaWYgKGJ0bm9rICYmICFidG5vay5uYXRpdmVFbGVtZW50LmRpc2FibGVkICkge1xyXG4gICAgICAgICAgICAgICAgYnRub2submF0aXZlRWxlbWVudC5jbGljaygpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVGaWVsZFBhbmVsKCk7XHJcbiAgICAgICAgICAgIH0gICAgICAgIFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2V0UGFuZWxQb3NpdGlvbih1cGRhdGVUb3BQb3NpdGlvbiA9IHRydWUpIHtcclxuICAgICAgICBpZiAodGhpcy5wYW5lbEVsZW1lbnQpIHtcclxuICAgICAgICAgICAgY29uc3QgeyB3aWR0aCwgbGVmdCwgdG9wLCBoZWlnaHQgfSA9IHRoaXMuZ2V0UGFuZWxTaXplKCk7XHJcbiAgICAgICAgICAgIHRoaXMucGFuZWxFbGVtZW50LnN0eWxlLndpZHRoID0gYCR7d2lkdGh9cHhgO1xyXG4gICAgICAgICAgICAvLyB0aGlzLnBhbmVsRWxlbWVudC5zdHlsZS5tYXhIZWlnaHQgPSBgJHtoZWlnaHR9cHhgO1xyXG4gICAgICAgICAgICBpZiAodXBkYXRlVG9wUG9zaXRpb24pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucGFuZWxFbGVtZW50LnN0eWxlLnRvcCA9IGAke3RvcH1weGA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuc3R5bGUubGVmdCA9IGAke2xlZnR9cHhgO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBcclxuXHJcbiAgICBwcml2YXRlIGdldElucHV0U2l6ZUluZm8oKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFBhbmVsU2l6ZSgpIHtcclxuICAgICAgICBjb25zdCB3aWR0aCA9IDM4MDtcclxuICAgICAgICBsZXQgeyB0b3AsIGxlZnQsIGhlaWdodCB9ID0gdGhpcy5nZXRJbnB1dFNpemVJbmZvKCk7XHJcbiAgICAgICAgY29uc3QgYm90dG9tID0gd2luZG93LmlubmVySGVpZ2h0IC0gaGVpZ2h0IC0gdG9wO1xyXG4gICAgICAgIGxldCBwYW5lbEhlaWdodCA9IDE5MDtcclxuICAgICAgICBjb25zdCBoID0gdG9wID4gYm90dG9tID8gdG9wIDogYm90dG9tO1xyXG4gICAgICAgIGlmIChib3R0b20gPiBwYW5lbEhlaWdodCkge1xyXG4gICAgICAgICAgICB0b3AgPSB0b3AgKyBoZWlnaHQ7XHJcbiAgICAgICAgICAgIC8vIOmdouadv+eUseS4iuWQkeS4i+WxleW8gFxyXG4gICAgICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5zdHlsZS50cmFuc2Zvcm1PcmlnaW4gPSAnMTAwJSB0b3AnO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0b3AgPiBib3R0b20pIHtcclxuICAgICAgICAgICAgICAgIGlmIChoIDwgcGFuZWxIZWlnaHQpIHtcclxuICAgICAgICAgICAgICAgICAgICBwYW5lbEhlaWdodCA9IGggLSAxMDtcclxuICAgICAgICAgICAgICAgICAgICB0b3AgPSAxMDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdG9wID0gdG9wIC0gcGFyc2VJbnQoJycgKyBwYW5lbEhlaWdodCwgMTApIC0gNTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAvLyDpnaLmnb/nlLHkuIvlkJHkuIrlsZXlvIBcclxuICAgICAgICAgICAgICAgIHRoaXMucGFuZWxFbGVtZW50LnN0eWxlLnRyYW5zZm9ybU9yaWdpbiA9ICcxMDAlIGJvdHRvbSc7XHJcblxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKGggPCBwYW5lbEhlaWdodCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhbmVsSGVpZ2h0ID0gaCAtIDEwO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdG9wID0gdG9wICsgaGVpZ2h0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAod2luZG93LmlubmVyV2lkdGggLSBsZWZ0IDwgd2lkdGgpIHtcclxuICAgICAgICAgICAgbGVmdCA9IGxlZnQgKyB3aWR0aCAtIHdpZHRoO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHsgd2lkdGgsIHRvcCwgaGVpZ2h0OiBwYW5lbEhlaWdodCwgbGVmdCB9O1xyXG4gICAgfVxyXG59Il19