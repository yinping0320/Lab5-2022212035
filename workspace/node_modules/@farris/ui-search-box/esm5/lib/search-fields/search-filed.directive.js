/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ApplicationRef, ComponentFactoryResolver, Directive, ElementRef, HostListener, Injector, Input, NgZone, Renderer2 } from '@angular/core';
import { debounceTime } from 'rxjs/operators';
import { SearchFieldPanelComponent } from './search-field-panel.component';
import { SearchFieldsComponent } from './search-fields.component';
import { CommonUtils } from '@farris/ui-common';
var SearchFieldDirective = /** @class */ (function () {
    function SearchFieldDirective(injector, elRef, ngzone, render, cfr, searchFieldsRef, _applicationRef) {
        this.injector = injector;
        this.elRef = elRef;
        this.ngzone = ngzone;
        this.render = render;
        this.cfr = cfr;
        this.searchFieldsRef = searchFieldsRef;
        this._applicationRef = _applicationRef;
        this.winResizeHandle = null;
        this.docKeydownEventHandle = null;
        this.commonUtils = null;
        this.commonUtils = this.injector.get(CommonUtils, new CommonUtils());
    }
    /**
     * @return {?}
     */
    SearchFieldDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.searchFieldsRef) {
            this.searchFieldsRef.hideShadowbox.subscribe((/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                _this.removeFieldPanel();
            }));
        }
        this.winResizeHandle = this.render.listen(window, 'resize', (/**
         * @return {?}
         */
        function () {
            _this.removeFieldPanel();
        }));
    };
    /**
     * @return {?}
     */
    SearchFieldDirective.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @return {?}
     */
    SearchFieldDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.removeFieldPanel();
        if (this.winResizeHandle) {
            this.winResizeHandle();
        }
    };
    /**
     * @param {?} $event
     * @return {?}
     */
    SearchFieldDirective.prototype.onMouseDown = /**
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        $event.stopPropagation();
    };
    /**
     * @param {?} $event
     * @return {?}
     */
    SearchFieldDirective.prototype.onFieldClick = /**
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        $event.stopPropagation();
        if (!this.panelElement) {
            this.createFieldPanel();
        }
        else {
            this.removeFieldPanel();
        }
    };
    /**
     * @private
     * @return {?}
     */
    SearchFieldDirective.prototype.removeFieldPanel = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.panelElement) {
            this.panelElement.remove();
            this.panelElement = null;
            this.searchFieldsRef.overLayService.destory(this.elRef.nativeElement);
            this.render.removeClass(this.elRef.nativeElement, 'selected');
        }
        if (this.docKeydownEventHandle) {
            this.docKeydownEventHandle();
            this.docKeydownEventHandle = null;
        }
    };
    /**
     * @private
     * @param {?=} enterFn
     * @return {?}
     */
    SearchFieldDirective.prototype.registerKeyboardEvent = /**
     * @private
     * @param {?=} enterFn
     * @return {?}
     */
    function (enterFn) {
        var _this = this;
        if (this.commonUtils) {
            return this.commonUtils.regBodyKeydownEvent(enterFn, (/**
             * @return {?}
             */
            function () { _this.removeFieldPanel(); }));
        }
        return null;
    };
    /**
     * @private
     * @return {?}
     */
    SearchFieldDirective.prototype.createFieldPanel = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        this.panelElement = document.createElement('div');
        this.panelElement.classList.add('overlay-pane', 'f-filter-panel', 'f-area-hide', 'f-search-field-container');
        /** @type {?} */
        var zindex = '' + this.searchFieldsRef.commonUtils.getFloatingLayerIndex();
        this.panelElement.style.zIndex = zindex;
        document.body.appendChild(this.panelElement);
        this.setPanelPosition();
        /** @type {?} */
        var fieldPanelRef = this.cfr.resolveComponentFactory(SearchFieldPanelComponent);
        /** @type {?} */
        var _fieldPanelIns = fieldPanelRef.create(this.injector);
        this._applicationRef.attachView(_fieldPanelIns.hostView);
        _fieldPanelIns.instance.fieldOptions = this.field;
        _fieldPanelIns.instance.conditions = { field: this.field.code, value: this.field.value };
        this.panelElement.appendChild(_fieldPanelIns.location.nativeElement);
        this.panelElement.classList.add('f-area-show');
        _fieldPanelIns.instance.filterChange.pipe(debounceTime(100)).subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            // 新的查询条件
            // console.log(e);
            _this.searchFieldsRef.setConditions(e);
        }));
        _fieldPanelIns.instance.remove.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            _this.searchFieldsRef.remove(e.code);
        }));
        _fieldPanelIns.changeDetectorRef.detectChanges();
        this.searchFieldsRef.overLayService.registerMouseEvent(this.elRef.nativeElement, (/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (_this.elRef.nativeElement.contains(e.target)) {
                return;
            }
            if (e.target.closest('.f-search-field-container')) {
                if (e.target.nodeName === 'BUTTON' && e.target.className.indexOf('close-field-panel') > -1) {
                    _this.removeFieldPanel();
                }
                return;
            }
            if (e.target.closest('.date-overlay-container') || e.target.className.indexOf('date-overlay-container') > -1) {
                return;
            }
            _this.removeFieldPanel();
        }));
        this.render.addClass(this.elRef.nativeElement, 'selected');
        // 处理 ESC、ENTER
        this.docKeydownEventHandle = this.registerKeyboardEvent((/**
         * @return {?}
         */
        function () {
            /** @type {?} */
            var btnok = _fieldPanelIns.instance.btnSubmit;
            if (btnok && !btnok.nativeElement.disabled) {
                btnok.nativeElement.click();
                _this.removeFieldPanel();
            }
        }));
    };
    /**
     * @private
     * @param {?=} updateTopPosition
     * @return {?}
     */
    SearchFieldDirective.prototype.setPanelPosition = /**
     * @private
     * @param {?=} updateTopPosition
     * @return {?}
     */
    function (updateTopPosition) {
        if (updateTopPosition === void 0) { updateTopPosition = true; }
        if (this.panelElement) {
            var _a = this.getPanelSize(), width = _a.width, left = _a.left, top_1 = _a.top, height = _a.height;
            this.panelElement.style.width = width + "px";
            // this.panelElement.style.maxHeight = `${height}px`;
            if (updateTopPosition) {
                this.panelElement.style.top = top_1 + "px";
            }
            this.panelElement.style.left = left + "px";
        }
    };
    /**
     * @private
     * @return {?}
     */
    SearchFieldDirective.prototype.getInputSizeInfo = /**
     * @private
     * @return {?}
     */
    function () {
        return this.elRef.nativeElement.getBoundingClientRect();
    };
    /**
     * @private
     * @return {?}
     */
    SearchFieldDirective.prototype.getPanelSize = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var width = 380;
        var _a = this.getInputSizeInfo(), top = _a.top, left = _a.left, height = _a.height;
        /** @type {?} */
        var bottom = window.innerHeight - height - top;
        /** @type {?} */
        var panelHeight = 190;
        /** @type {?} */
        var h = top > bottom ? top : bottom;
        if (bottom > panelHeight) {
            top = top + height;
            // 面板由上向下展开
            this.panelElement.style.transformOrigin = '100% top';
        }
        else {
            if (top > bottom) {
                if (h < panelHeight) {
                    panelHeight = h - 10;
                    top = 10;
                }
                else {
                    top = top - parseInt('' + panelHeight, 10) - 5;
                }
                // 面板由下向上展开
                this.panelElement.style.transformOrigin = '100% bottom';
            }
            else {
                if (h < panelHeight) {
                    panelHeight = h - 10;
                }
                top = top + height;
            }
        }
        if (window.innerWidth - left < width) {
            left = left + width - width;
        }
        return { width: width, top: top, height: panelHeight, left: left };
    };
    SearchFieldDirective.decorators = [
        { type: Directive, args: [{ selector: '[search-field]' },] }
    ];
    /** @nocollapse */
    SearchFieldDirective.ctorParameters = function () { return [
        { type: Injector },
        { type: ElementRef },
        { type: NgZone },
        { type: Renderer2 },
        { type: ComponentFactoryResolver },
        { type: SearchFieldsComponent },
        { type: ApplicationRef }
    ]; };
    SearchFieldDirective.propDecorators = {
        field: [{ type: Input, args: ['search-field',] }],
        onMouseDown: [{ type: HostListener, args: ['mousedown', ['$event'],] }],
        onFieldClick: [{ type: HostListener, args: ['click', ['$event'],] }]
    };
    return SearchFieldDirective;
}());
export { SearchFieldDirective };
if (false) {
    /** @type {?} */
    SearchFieldDirective.prototype.field;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.panelElement;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.winResizeHandle;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.docKeydownEventHandle;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.commonUtils;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.elRef;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.ngzone;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.cfr;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype.searchFieldsRef;
    /**
     * @type {?}
     * @private
     */
    SearchFieldDirective.prototype._applicationRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLWZpbGVkLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktc2VhcmNoLWJveC8iLCJzb3VyY2VzIjpbImxpYi9zZWFyY2gtZmllbGRzL3NlYXJjaC1maWxlZC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBaUIsY0FBYyxFQUFFLHdCQUF3QixFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFxQixTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDcEwsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTlDLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQzNFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUVoRDtJQVdJLDhCQUFvQixRQUFrQixFQUFVLEtBQWlCLEVBQ3JELE1BQWMsRUFBVSxNQUFpQixFQUN6QyxHQUE2QixFQUFVLGVBQXNDLEVBQVUsZUFBK0I7UUFGOUcsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLFVBQUssR0FBTCxLQUFLLENBQVk7UUFDckQsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUFVLFdBQU0sR0FBTixNQUFNLENBQVc7UUFDekMsUUFBRyxHQUFILEdBQUcsQ0FBMEI7UUFBVSxvQkFBZSxHQUFmLGVBQWUsQ0FBdUI7UUFBVSxvQkFBZSxHQUFmLGVBQWUsQ0FBZ0I7UUFOMUgsb0JBQWUsR0FBRyxJQUFJLENBQUM7UUFDdkIsMEJBQXFCLEdBQUcsSUFBSSxDQUFDO1FBQzdCLGdCQUFXLEdBQUcsSUFBSSxDQUFDO1FBS25CLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLElB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QUFDLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQzs7SUF5SnJDLDJCQUFDO0NBQUEsQUF4TUQsSUF3TUM7U0F2TVksb0JBQW9COzs7SUFFN0IscUNBQStDOzs7OztJQUcvQyw0Q0FBa0M7Ozs7O0lBQ2xDLCtDQUErQjs7Ozs7SUFDL0IscURBQXFDOzs7OztJQUNyQywyQ0FBMkI7Ozs7O0lBRWYsd0NBQTBCOzs7OztJQUFFLHFDQUF5Qjs7Ozs7SUFDN0Qsc0NBQXNCOzs7OztJQUFFLHNDQUF5Qjs7Ozs7SUFDakQsbUNBQXFDOzs7OztJQUFFLCtDQUE4Qzs7Ozs7SUFBRSwrQ0FBdUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlclZpZXdJbml0LCBBcHBsaWNhdGlvblJlZiwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBEaXJlY3RpdmUsIEVsZW1lbnRSZWYsIEhvc3RMaXN0ZW5lciwgSW5qZWN0b3IsIElucHV0LCBOZ1pvbmUsIE9uRGVzdHJveSwgT25Jbml0LCBSZW5kZXJlcjIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgZGVib3VuY2VUaW1lIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBTZWFyY2hGaWVsZFZhbHVlIH0gZnJvbSAnLi4vc2VhcmNoLWJveC50eXBlcyc7XHJcbmltcG9ydCB7IFNlYXJjaEZpZWxkUGFuZWxDb21wb25lbnQgfSBmcm9tICcuL3NlYXJjaC1maWVsZC1wYW5lbC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBTZWFyY2hGaWVsZHNDb21wb25lbnQgfSBmcm9tICcuL3NlYXJjaC1maWVsZHMuY29tcG9uZW50JztcclxuaW1wb3J0IHsgQ29tbW9uVXRpbHMgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbic7XHJcblxyXG5ARGlyZWN0aXZlKHsgc2VsZWN0b3I6ICdbc2VhcmNoLWZpZWxkXScgfSlcclxuZXhwb3J0IGNsYXNzIFNlYXJjaEZpZWxkRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xyXG5cclxuICAgIEBJbnB1dCgnc2VhcmNoLWZpZWxkJykgZmllbGQ6IFNlYXJjaEZpZWxkVmFsdWU7XHJcblxyXG5cclxuICAgIHByaXZhdGUgcGFuZWxFbGVtZW50OiBIVE1MRWxlbWVudDtcclxuICAgIHByaXZhdGUgd2luUmVzaXplSGFuZGxlID0gbnVsbDtcclxuICAgIHByaXZhdGUgZG9jS2V5ZG93bkV2ZW50SGFuZGxlID0gbnVsbDtcclxuICAgIHByaXZhdGUgY29tbW9uVXRpbHMgPSBudWxsO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIGVsUmVmOiBFbGVtZW50UmVmLFxyXG4gICAgICAgIHByaXZhdGUgbmd6b25lOiBOZ1pvbmUsIHByaXZhdGUgcmVuZGVyOiBSZW5kZXJlcjIsIFxyXG4gICAgICAgIHByaXZhdGUgY2ZyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIHByaXZhdGUgc2VhcmNoRmllbGRzUmVmOiBTZWFyY2hGaWVsZHNDb21wb25lbnQsIHByaXZhdGUgX2FwcGxpY2F0aW9uUmVmOiBBcHBsaWNhdGlvblJlZikge1xyXG4gICAgICAgICAgICB0aGlzLmNvbW1vblV0aWxzID0gdGhpcy5pbmplY3Rvci5nZXQoQ29tbW9uVXRpbHMsIG5ldyBDb21tb25VdGlscygpKVxyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuc2VhcmNoRmllbGRzUmVmKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2VhcmNoRmllbGRzUmVmLmhpZGVTaGFkb3dib3guc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlRmllbGRQYW5lbCgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMud2luUmVzaXplSGFuZGxlID0gdGhpcy5yZW5kZXIubGlzdGVuKHdpbmRvdywgJ3Jlc2l6ZScsICgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5yZW1vdmVGaWVsZFBhbmVsKCk7ICAgICAgICAgICAgXHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XHJcbiAgICAgICAgXHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5yZW1vdmVGaWVsZFBhbmVsKCk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLndpblJlc2l6ZUhhbmRsZSkge1xyXG4gICAgICAgICAgICB0aGlzLndpblJlc2l6ZUhhbmRsZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBASG9zdExpc3RlbmVyKCdtb3VzZWRvd24nLCBbJyRldmVudCddKVxyXG4gICAgb25Nb3VzZURvd24oJGV2ZW50OiBNb3VzZUV2ZW50KSB7XHJcbiAgICAgICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgfVxyXG5cclxuICAgIEBIb3N0TGlzdGVuZXIoJ2NsaWNrJywgWyckZXZlbnQnXSlcclxuICAgIG9uRmllbGRDbGljaygkZXZlbnQ6IE1vdXNlRXZlbnQpIHtcclxuICAgICAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgaWYgKCF0aGlzLnBhbmVsRWxlbWVudCkge1xyXG4gICAgICAgICAgICB0aGlzLmNyZWF0ZUZpZWxkUGFuZWwoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUZpZWxkUGFuZWwoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZW1vdmVGaWVsZFBhbmVsKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnBhbmVsRWxlbWVudCkge1xyXG4gICAgICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5yZW1vdmUoKTtcclxuICAgICAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQgPSBudWxsO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5zZWFyY2hGaWVsZHNSZWYub3ZlckxheVNlcnZpY2UuZGVzdG9yeSh0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5yZW5kZXIucmVtb3ZlQ2xhc3ModGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LCAnc2VsZWN0ZWQnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmRvY0tleWRvd25FdmVudEhhbmRsZSkge1xyXG4gICAgICAgICAgICB0aGlzLmRvY0tleWRvd25FdmVudEhhbmRsZSgpO1xyXG4gICAgICAgICAgICB0aGlzLmRvY0tleWRvd25FdmVudEhhbmRsZSA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVnaXN0ZXJLZXlib2FyZEV2ZW50KGVudGVyRm4/OiAoKSA9PiB2b2lkKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuY29tbW9uVXRpbHMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29tbW9uVXRpbHMucmVnQm9keUtleWRvd25FdmVudChlbnRlckZuLCAoKSA9PiB7dGhpcy5yZW1vdmVGaWVsZFBhbmVsKCk7fSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY3JlYXRlRmllbGRQYW5lbCgpIHtcclxuICAgICAgICB0aGlzLnBhbmVsRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ292ZXJsYXktcGFuZScsJ2YtZmlsdGVyLXBhbmVsJywgJ2YtYXJlYS1oaWRlJywgJ2Ytc2VhcmNoLWZpZWxkLWNvbnRhaW5lcicpO1xyXG4gICAgICAgIGNvbnN0IHppbmRleCAgPSAnJyArIHRoaXMuc2VhcmNoRmllbGRzUmVmLmNvbW1vblV0aWxzLmdldEZsb2F0aW5nTGF5ZXJJbmRleCgpO1xyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50LnN0eWxlLnpJbmRleCA9IHppbmRleDtcclxuICAgICAgICBcclxuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMucGFuZWxFbGVtZW50KTtcclxuICAgICAgICB0aGlzLnNldFBhbmVsUG9zaXRpb24oKTtcclxuXHJcbiAgICAgICAgY29uc3QgZmllbGRQYW5lbFJlZiA9IHRoaXMuY2ZyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KFNlYXJjaEZpZWxkUGFuZWxDb21wb25lbnQpO1xyXG4gICAgICAgIGNvbnN0IF9maWVsZFBhbmVsSW5zID0gZmllbGRQYW5lbFJlZi5jcmVhdGUodGhpcy5pbmplY3Rvcik7XHJcbiAgICAgICAgdGhpcy5fYXBwbGljYXRpb25SZWYuYXR0YWNoVmlldyhfZmllbGRQYW5lbElucy5ob3N0Vmlldyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgX2ZpZWxkUGFuZWxJbnMuaW5zdGFuY2UuZmllbGRPcHRpb25zID0gdGhpcy5maWVsZDtcclxuICAgICAgICBfZmllbGRQYW5lbElucy5pbnN0YW5jZS5jb25kaXRpb25zID0geyBmaWVsZDogdGhpcy5maWVsZC5jb2RlLCB2YWx1ZTogdGhpcy5maWVsZC52YWx1ZSB9XHJcblxyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50LmFwcGVuZENoaWxkKF9maWVsZFBhbmVsSW5zLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ2YtYXJlYS1zaG93Jyk7XHJcblxyXG4gICAgICAgIF9maWVsZFBhbmVsSW5zLmluc3RhbmNlLmZpbHRlckNoYW5nZS5waXBlKFxyXG4gICAgICAgICAgICBkZWJvdW5jZVRpbWUoMTAwKVxyXG4gICAgICAgICkuc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgLy8g5paw55qE5p+l6K+i5p2h5Lu2XHJcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGUpO1xyXG4gICAgICAgICAgICB0aGlzLnNlYXJjaEZpZWxkc1JlZi5zZXRDb25kaXRpb25zKGUpO1xyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIF9maWVsZFBhbmVsSW5zLmluc3RhbmNlLnJlbW92ZS5zdWJzY3JpYmUoZSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuc2VhcmNoRmllbGRzUmVmLnJlbW92ZShlLmNvZGUpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBfZmllbGRQYW5lbElucy5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcblxyXG4gICAgICAgIHRoaXMuc2VhcmNoRmllbGRzUmVmLm92ZXJMYXlTZXJ2aWNlLnJlZ2lzdGVyTW91c2VFdmVudCh0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQsIChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudC5jb250YWlucyhlLnRhcmdldCkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJy5mLXNlYXJjaC1maWVsZC1jb250YWluZXInKSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGUudGFyZ2V0Lm5vZGVOYW1lID09PSAnQlVUVE9OJyAmJiBlLnRhcmdldC5jbGFzc05hbWUuaW5kZXhPZignY2xvc2UtZmllbGQtcGFuZWwnKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVGaWVsZFBhbmVsKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcuZGF0ZS1vdmVybGF5LWNvbnRhaW5lcicpIHx8IGUudGFyZ2V0LmNsYXNzTmFtZS5pbmRleE9mKCdkYXRlLW92ZXJsYXktY29udGFpbmVyJykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUZpZWxkUGFuZWwoKTtcclxuICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIHRoaXMucmVuZGVyLmFkZENsYXNzKHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudCwgJ3NlbGVjdGVkJyk7XHJcblxyXG4gICAgICAgIC8vIOWkhOeQhiBFU0PjgIFFTlRFUlxyXG4gICAgICAgIHRoaXMuZG9jS2V5ZG93bkV2ZW50SGFuZGxlID0gdGhpcy5yZWdpc3RlcktleWJvYXJkRXZlbnQoKCkgPT4gXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBjb25zdCBidG5vayA9IF9maWVsZFBhbmVsSW5zLmluc3RhbmNlLmJ0blN1Ym1pdDtcclxuICAgICAgICAgICAgaWYgKGJ0bm9rICYmICFidG5vay5uYXRpdmVFbGVtZW50LmRpc2FibGVkICkge1xyXG4gICAgICAgICAgICAgICAgYnRub2submF0aXZlRWxlbWVudC5jbGljaygpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVGaWVsZFBhbmVsKCk7XHJcbiAgICAgICAgICAgIH0gICAgICAgIFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2V0UGFuZWxQb3NpdGlvbih1cGRhdGVUb3BQb3NpdGlvbiA9IHRydWUpIHtcclxuICAgICAgICBpZiAodGhpcy5wYW5lbEVsZW1lbnQpIHtcclxuICAgICAgICAgICAgY29uc3QgeyB3aWR0aCwgbGVmdCwgdG9wLCBoZWlnaHQgfSA9IHRoaXMuZ2V0UGFuZWxTaXplKCk7XHJcbiAgICAgICAgICAgIHRoaXMucGFuZWxFbGVtZW50LnN0eWxlLndpZHRoID0gYCR7d2lkdGh9cHhgO1xyXG4gICAgICAgICAgICAvLyB0aGlzLnBhbmVsRWxlbWVudC5zdHlsZS5tYXhIZWlnaHQgPSBgJHtoZWlnaHR9cHhgO1xyXG4gICAgICAgICAgICBpZiAodXBkYXRlVG9wUG9zaXRpb24pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucGFuZWxFbGVtZW50LnN0eWxlLnRvcCA9IGAke3RvcH1weGA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuc3R5bGUubGVmdCA9IGAke2xlZnR9cHhgO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBcclxuXHJcbiAgICBwcml2YXRlIGdldElucHV0U2l6ZUluZm8oKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFBhbmVsU2l6ZSgpIHtcclxuICAgICAgICBjb25zdCB3aWR0aCA9IDM4MDtcclxuICAgICAgICBsZXQgeyB0b3AsIGxlZnQsIGhlaWdodCB9ID0gdGhpcy5nZXRJbnB1dFNpemVJbmZvKCk7XHJcbiAgICAgICAgY29uc3QgYm90dG9tID0gd2luZG93LmlubmVySGVpZ2h0IC0gaGVpZ2h0IC0gdG9wO1xyXG4gICAgICAgIGxldCBwYW5lbEhlaWdodCA9IDE5MDtcclxuICAgICAgICBjb25zdCBoID0gdG9wID4gYm90dG9tID8gdG9wIDogYm90dG9tO1xyXG4gICAgICAgIGlmIChib3R0b20gPiBwYW5lbEhlaWdodCkge1xyXG4gICAgICAgICAgICB0b3AgPSB0b3AgKyBoZWlnaHQ7XHJcbiAgICAgICAgICAgIC8vIOmdouadv+eUseS4iuWQkeS4i+WxleW8gFxyXG4gICAgICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5zdHlsZS50cmFuc2Zvcm1PcmlnaW4gPSAnMTAwJSB0b3AnO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0b3AgPiBib3R0b20pIHtcclxuICAgICAgICAgICAgICAgIGlmIChoIDwgcGFuZWxIZWlnaHQpIHtcclxuICAgICAgICAgICAgICAgICAgICBwYW5lbEhlaWdodCA9IGggLSAxMDtcclxuICAgICAgICAgICAgICAgICAgICB0b3AgPSAxMDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdG9wID0gdG9wIC0gcGFyc2VJbnQoJycgKyBwYW5lbEhlaWdodCwgMTApIC0gNTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAvLyDpnaLmnb/nlLHkuIvlkJHkuIrlsZXlvIBcclxuICAgICAgICAgICAgICAgIHRoaXMucGFuZWxFbGVtZW50LnN0eWxlLnRyYW5zZm9ybU9yaWdpbiA9ICcxMDAlIGJvdHRvbSc7XHJcblxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKGggPCBwYW5lbEhlaWdodCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhbmVsSGVpZ2h0ID0gaCAtIDEwO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdG9wID0gdG9wICsgaGVpZ2h0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAod2luZG93LmlubmVyV2lkdGggLSBsZWZ0IDwgd2lkdGgpIHtcclxuICAgICAgICAgICAgbGVmdCA9IGxlZnQgKyB3aWR0aCAtIHdpZHRoO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHsgd2lkdGgsIHRvcCwgaGVpZ2h0OiBwYW5lbEhlaWdodCwgbGVmdCB9O1xyXG4gICAgfVxyXG59Il19