/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { ComponentFactoryResolver, Directive, EventEmitter, HostListener, Injector, Input, NgZone, Output, Renderer2 } from '@angular/core';
import { reqAnimFrame } from '@farris/ui-common';
import { InputGroupComponent } from '@farris/ui-input-group';
import { debounceTime } from 'rxjs/operators';
import { SearchBoxComponent } from '../search-box.component';
import { trim } from 'lodash-es';
import { SearchPanelComponent } from './search-panel.component';
var SearchPanelDirective = /** @class */ (function () {
    function SearchPanelDirective(injector, ngzone, render, inputRef, searchBoxRef, cfr) {
        this.injector = injector;
        this.ngzone = ngzone;
        this.render = render;
        this.inputRef = inputRef;
        this.searchBoxRef = searchBoxRef;
        this.cfr = cfr;
        this.maxFields = 5;
        /**
         * 启用 任意字段
         */
        this.useAnyField = true;
        this.escHandler = new EventEmitter();
        this.maxPanelItems = 10;
        this.minPanelWidth = 270;
    }
    /**
     * @return {?}
     */
    SearchPanelDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @return {?}
     */
    SearchPanelDirective.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if ((!this.fields || !this.fields.length) && !this.useAnyField) {
            return;
        }
        this.inputRef.inputClick.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            e.stopPropagation();
        }));
        this.inputRef.valueChange.pipe(debounceTime(50)).subscribe((/**
         * @param {?} val
         * @return {?}
         */
        function (val) {
            if (trim(val)) {
                // 值变化显示查询面板
                if (!_this.panelElement) {
                    _this.createDataPanel();
                    _this.searchPanelRef.instance.setActiveItem(0);
                }
                _this.searchPanelRef.instance.setValue(val);
            }
            else {
                if (_this.panelElement) {
                    _this.hide();
                }
            }
        }));
        this.searchBoxRef.clear.subscribe((/**
         * @return {?}
         */
        function () {
            _this.hide();
        }));
    };
    /**
     * @return {?}
     */
    SearchPanelDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.searchBoxRef.overLayService.destory(this.searchBoxRef.el.nativeElement);
    };
    /**
     * @private
     * @return {?}
     */
    SearchPanelDirective.prototype.removePanelElement = /**
     * @private
     * @return {?}
     */
    function () {
        document.body.removeChild(this.panelElement);
        this.panelElement = null;
        if (this.searchPanelRef) {
            this.searchPanelRef.destroy();
            this.searchPanelRef = null;
        }
    };
    /**
     * @param {?=} e
     * @return {?}
     */
    SearchPanelDirective.prototype.hide = /**
     * @param {?=} e
     * @return {?}
     */
    function (e) {
        var _this = this;
        reqAnimFrame((/**
         * @return {?}
         */
        function () {
            _this.inputRef.value = '';
            if (_this.panelElement) {
                if (e && (e.type === 'mousewheel' || e.type === 'wheel')) {
                    _this.removePanelElement();
                }
                else {
                    _this.panelElement.classList.remove('f-area-show');
                    setTimeout((/**
                     * @return {?}
                     */
                    function () {
                        _this.removePanelElement();
                    }), 120);
                }
                _this.searchBoxRef.overLayService.destory(_this.searchBoxRef.el.nativeElement);
            }
        }));
    };
    /**
     * @private
     * @param {?=} updateTopPosition
     * @return {?}
     */
    SearchPanelDirective.prototype.setPanelPosition = /**
     * @private
     * @param {?=} updateTopPosition
     * @return {?}
     */
    function (updateTopPosition) {
        if (updateTopPosition === void 0) { updateTopPosition = true; }
        if (this.panelElement) {
            var _a = this.getPanelSize(), maxWidth = _a.maxWidth, left = _a.left, top_1 = _a.top, height = _a.height;
            this.panelElement.style.minWidth = this.minPanelWidth + "px";
            this.panelElement.style.maxWidth = maxWidth + "px";
            this.panelElement.style.maxHeight = height + "px";
            if (updateTopPosition) {
                this.panelElement.style.top = top_1 + "px";
            }
            this.panelElement.style.left = left + "px";
        }
    };
    /**
     * @private
     * @return {?}
     */
    SearchPanelDirective.prototype.createDataPanel = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        this.panelElement = document.createElement('div');
        this.panelElement.classList.add('overlay-pane', 'f-search-box-panel', 'f-area-hide');
        /** @type {?} */
        var zindex = '' + this.searchBoxRef.commonUtils.getFloatingLayerIndex();
        document.body.appendChild(this.panelElement);
        this.setPanelPosition();
        this.panelElement.style.zIndex = zindex;
        this.panelElement.style.overflow = 'hidden';
        // 创建数据展示组件
        /** @type {?} */
        var cmpFact = this.cfr.resolveComponentFactory(SearchPanelComponent);
        this.searchPanelRef = cmpFact.create(this.injector);
        if (this.useAnyField && !this.fields.find((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return n.code === '*'; }))) {
            /** @type {?} */
            var anyfieldsName = this.searchBoxRef.localeSer.getValue('searchbox.anyFields');
            this.fields.splice(0, 0, { code: '*', name: anyfieldsName });
        }
        this.searchPanelRef.instance.fields = this.fields;
        this.panelElement.appendChild(this.searchPanelRef.location.nativeElement);
        this.searchPanelRef.changeDetectorRef.detectChanges();
        this.searchPanelRef.instance.searchKeyWord = this.inputRef.value;
        this.searchPanelRef.instance.itemClick.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            var data = e.data;
            _this.selectItem(data);
        }));
        this.searchPanelRef.instance.closepanel.subscribe((/**
         * @return {?}
         */
        function () {
            _this.hide();
        }));
        // 注册鼠标滚轮，点击事件，用于隐藏Panel
        this.searchBoxRef.overLayService.registerMouseEvent(this.searchBoxRef.el.nativeElement, (/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (!_this.panelElement || e.target['closest']('.f-search-box-panel')) {
                return;
            }
            if (_this.inputRef && _this.inputRef.textbox.nativeElement === e.target) {
                return false;
            }
            // 输入框内有文本时，如果不允许关闭弹出面板，可放开
            // if (this.inputRef.value) {
            //     return;
            // }
            _this.hide(e);
        }));
        if (this.searchPanelRef.instance.fields.length + 1 < this.maxPanelItems) {
            /** @type {?} */
            var newHeight = this.searchPanelRef.instance.itemsContainer.nativeElement.querySelector('ul').offsetHeight + 40;
            this.searchPanelRef.instance.itemsContainer.nativeElement.style.height = newHeight + "px";
            if (this.panelElement) {
                if (this.panelElement.style.transformOrigin.indexOf('bottom') > -1) {
                    this.panelElement.style.top = this.getInputSizeInfo().top - newHeight - 5 + "px";
                }
                this.panelElement.style.height = 'auto';
            }
        }
        else {
            this.searchPanelRef.instance.itemsContainer.nativeElement.style.height = '100%';
            if (this.panelElement) {
                this.render.removeStyle(this.panelElement, 'height');
            }
        }
        this.panelElement.classList.add('f-area-show');
    };
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    SearchPanelDirective.prototype.selectItem = /**
     * @private
     * @param {?} data
     * @return {?}
     */
    function (data) {
        if (!data) {
            return;
        }
        this.searchBoxRef.select(tslib_1.__assign({}, data, { value: this.inputRef.value }));
        this.hide();
        this.inputRef.focus();
    };
    /**
     * @private
     * @return {?}
     */
    SearchPanelDirective.prototype.calculationPanelHeight = /**
     * @private
     * @return {?}
     */
    function () {
        return this.maxPanelItems * 30 + 15;
    };
    /**
     * @private
     * @return {?}
     */
    SearchPanelDirective.prototype.getInputSizeInfo = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var el = this.searchBoxRef.enableFloat ? this.searchBoxRef.shadowBox : this.searchBoxRef.container;
        return el.nativeElement.getBoundingClientRect();
    };
    /**
     * @private
     * @return {?}
     */
    SearchPanelDirective.prototype.getPanelSize = /**
     * @private
     * @return {?}
     */
    function () {
        var _a = this.getInputSizeInfo(), width = _a.width, height = _a.height, top = _a.top, left = _a.left;
        /** @type {?} */
        var bottom = window.innerHeight - height - top;
        /** @type {?} */
        var panelHeight = this.calculationPanelHeight();
        /** @type {?} */
        var h = top > bottom ? top : bottom;
        if (bottom > panelHeight) {
            top = top + height;
            // 面板由上向下展开
            this.panelElement.style.transformOrigin = '100% top';
        }
        else {
            if (top > bottom) {
                if (h < panelHeight) {
                    panelHeight = h - 10;
                    top = 10;
                }
                else {
                    top = top - parseInt('' + panelHeight, 10) - 5;
                }
                // 面板由下向上展开
                this.panelElement.style.transformOrigin = '100% bottom';
            }
            else {
                if (h < panelHeight) {
                    panelHeight = h - 10;
                }
                top = top + height;
            }
        }
        /** @type {?} */
        var _width = width < this.minPanelWidth ? this.minPanelWidth : width;
        if (window.innerWidth - left < _width) {
            left = left + width - _width;
        }
        return { width: _width, top: top, height: panelHeight, left: left, maxWidth: Math.floor(window.innerWidth - left - 10) };
    };
    /**
     * @param {?} $event
     * @return {?}
     */
    SearchPanelDirective.prototype.registerKeyboardEvent = /**
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        var _this = this;
        /** @type {?} */
        var rows = this.fields;
        if ($event.code === 'ArrowUp' || $event.code === 'ArrowDown') {
            $event.preventDefault();
            $event.stopPropagation();
            if (this.searchPanelRef) {
                /** @type {?} */
                var idx = this.searchPanelRef.instance.activeIndex;
                /** @type {?} */
                var setActiveItem = (/**
                 * @param {?} index
                 * @return {?}
                 */
                function (index) {
                    _this.searchPanelRef.instance.setActiveItem(index);
                });
                if ($event.code === 'ArrowUp') { // up
                    if (idx > -1) {
                        /** @type {?} */
                        var prevIdx = idx - 1;
                        if (prevIdx < 0) {
                            prevIdx = rows.length - 1;
                        }
                        setActiveItem(prevIdx);
                    }
                    else {
                        setActiveItem(rows.length - 1);
                    }
                }
                if ($event.code === 'ArrowDown') { // down
                    // down
                    /** @type {?} */
                    var nextIdx = idx + 1;
                    if (nextIdx >= rows.length) {
                        nextIdx = 0;
                    }
                    setActiveItem(nextIdx);
                }
            }
        }
        if ($event.code === 'Backspace') {
            if (!this.inputRef.value) {
                if (this.searchBoxRef.displayTextList && this.searchBoxRef.displayTextList.length) {
                    $event.preventDefault();
                    $event.stopPropagation();
                    /** @type {?} */
                    var removeItem = this.searchBoxRef.displayTextList[this.searchBoxRef.displayTextList.length - 1];
                    if (removeItem) {
                        this.searchBoxRef.remove(removeItem.code);
                        if (this.searchPanelRef) {
                            this.searchPanelRef.changeDetectorRef.detectChanges();
                        }
                    }
                }
            }
        }
        if ($event.key === 'Enter') {
            if (rows && rows.length && this.panelElement) {
                /** @type {?} */
                var idx = this.searchPanelRef.instance.activeIndex;
                /** @type {?} */
                var data = rows[idx];
                this.selectItem(data);
            }
            else {
                this.searchBoxRef.onSubmit($event);
            }
        }
        if ($event.key === 'Escape') {
            if (this.panelElement) {
                this.hide();
            }
            else {
                this.escHandler.emit();
            }
        }
    };
    SearchPanelDirective.decorators = [
        { type: Directive, args: [{ selector: '[search-box-panel]' },] }
    ];
    /** @nocollapse */
    SearchPanelDirective.ctorParameters = function () { return [
        { type: Injector },
        { type: NgZone },
        { type: Renderer2 },
        { type: InputGroupComponent },
        { type: SearchBoxComponent },
        { type: ComponentFactoryResolver }
    ]; };
    SearchPanelDirective.propDecorators = {
        fields: [{ type: Input, args: ['search-box-panel',] }],
        maxFields: [{ type: Input }],
        useAnyField: [{ type: Input }],
        escHandler: [{ type: Output }],
        registerKeyboardEvent: [{ type: HostListener, args: ['keydown', ['$event'],] }]
    };
    return SearchPanelDirective;
}());
export { SearchPanelDirective };
if (false) {
    /** @type {?} */
    SearchPanelDirective.prototype.fields;
    /** @type {?} */
    SearchPanelDirective.prototype.maxFields;
    /**
     * 启用 任意字段
     * @type {?}
     */
    SearchPanelDirective.prototype.useAnyField;
    /** @type {?} */
    SearchPanelDirective.prototype.escHandler;
    /**
     * @type {?}
     * @private
     */
    SearchPanelDirective.prototype.panelElement;
    /**
     * @type {?}
     * @private
     */
    SearchPanelDirective.prototype.searchPanelRef;
    /**
     * @type {?}
     * @private
     */
    SearchPanelDirective.prototype.maxPanelItems;
    /**
     * @type {?}
     * @private
     */
    SearchPanelDirective.prototype.minPanelWidth;
    /**
     * @type {?}
     * @private
     */
    SearchPanelDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    SearchPanelDirective.prototype.ngzone;
    /**
     * @type {?}
     * @private
     */
    SearchPanelDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    SearchPanelDirective.prototype.inputRef;
    /**
     * @type {?}
     * @private
     */
    SearchPanelDirective.prototype.searchBoxRef;
    /**
     * @type {?}
     * @private
     */
    SearchPanelDirective.prototype.cfr;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLXBhbmVsLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktc2VhcmNoLWJveC8iLCJzb3VyY2VzIjpbImxpYi9zZWFyY2gtcGFuZWwvc2VhcmNoLXBhbmVsLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBaUIsd0JBQXdCLEVBQWdCLFNBQVMsRUFBYyxZQUFZLEVBQy9GLFlBQVksRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBK0IsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNqSCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDakQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFFN0QsT0FBTyxFQUFFLFlBQVksRUFBZSxNQUFNLGdCQUFnQixDQUFDO0FBQzNELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRTdELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDakMsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFaEU7SUFnQkksOEJBQW9CLFFBQWtCLEVBQzFCLE1BQWMsRUFDZCxNQUFpQixFQUNqQixRQUE2QixFQUM3QixZQUFnQyxFQUNoQyxHQUE2QjtRQUxyQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQzFCLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCxXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQ2pCLGFBQVEsR0FBUixRQUFRLENBQXFCO1FBQzdCLGlCQUFZLEdBQVosWUFBWSxDQUFvQjtRQUNoQyxRQUFHLEdBQUgsR0FBRyxDQUEwQjtRQWxCaEMsY0FBUyxHQUFHLENBQUMsQ0FBQzs7OztRQUdkLGdCQUFXLEdBQUcsSUFBSSxDQUFDO1FBRWxCLGVBQVUsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBS2xDLGtCQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ25CLGtCQUFhLEdBQUcsR0FBRyxDQUFDO0lBUTVCLENBQUM7Ozs7SUFFRCx1Q0FBUTs7O0lBQVI7SUFFQSxDQUFDOzs7O0lBRUQsOENBQWU7OztJQUFmO1FBQUEsaUJBZ0NDO1FBL0JHLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUM1RCxPQUFPO1NBQ1Y7UUFFRCxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxTQUFTOzs7O1FBQUMsVUFBQyxDQUFhO1lBQzdDLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUN4QixDQUFDLEVBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksQ0FDMUIsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUNuQixDQUFDLFNBQVM7Ozs7UUFBQyxVQUFDLEdBQVc7WUFFcEIsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQ1gsWUFBWTtnQkFDWixJQUFJLENBQUMsS0FBSSxDQUFDLFlBQVksRUFBRTtvQkFDcEIsS0FBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO29CQUN2QixLQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQ2pEO2dCQUVELEtBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUM5QztpQkFBTTtnQkFDSCxJQUFJLEtBQUksQ0FBQyxZQUFZLEVBQUU7b0JBQ25CLEtBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztpQkFDZjthQUNKO1FBRUwsQ0FBQyxFQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxTQUFTOzs7UUFBQztZQUM5QixLQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDaEIsQ0FBQyxFQUFDLENBQUM7SUFDUCxDQUFDOzs7O0lBRUQsMENBQVc7OztJQUFYO1FBQ0ksSUFBSSxDQUFDLFlBQVksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ2pGLENBQUM7Ozs7O0lBRU8saURBQWtCOzs7O0lBQTFCO1FBQ0ksUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzdDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1FBRXpCLElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUNyQixJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQzlCLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO1NBQzlCO0lBQ0wsQ0FBQzs7Ozs7SUFHRCxtQ0FBSTs7OztJQUFKLFVBQUssQ0FBTztRQUFaLGlCQWdCQztRQWZHLFlBQVk7OztRQUFDO1lBQ1QsS0FBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1lBQ3pCLElBQUksS0FBSSxDQUFDLFlBQVksRUFBRTtnQkFDbkIsSUFBSSxDQUFDLElBQUksQ0FBRSxDQUFDLENBQUMsSUFBSSxLQUFLLFlBQVksSUFBSSxDQUFDLENBQUMsSUFBSSxLQUFLLE9BQU8sQ0FBQyxFQUFFO29CQUN2RCxLQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztpQkFDN0I7cUJBQU07b0JBQ0gsS0FBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO29CQUNsRCxVQUFVOzs7b0JBQUM7d0JBQ1AsS0FBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7b0JBQzlCLENBQUMsR0FBQyxHQUFHLENBQUMsQ0FBQztpQkFDVjtnQkFFRCxLQUFJLENBQUMsWUFBWSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsS0FBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLENBQUM7YUFDaEY7UUFDTCxDQUFDLEVBQUMsQ0FBQztJQUNQLENBQUM7Ozs7OztJQUVPLCtDQUFnQjs7Ozs7SUFBeEIsVUFBeUIsaUJBQXdCO1FBQXhCLGtDQUFBLEVBQUEsd0JBQXdCO1FBQzdDLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNiLElBQUEsd0JBQXFELEVBQW5ELHNCQUFRLEVBQUUsY0FBSSxFQUFFLGNBQUcsRUFBRSxrQkFBOEI7WUFDM0QsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsUUFBUSxHQUFNLElBQUksQ0FBQyxhQUFhLE9BQUksQ0FBQztZQUM3RCxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQU0sUUFBUSxPQUFJLENBQUM7WUFDbkQsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFNLE1BQU0sT0FBSSxDQUFDO1lBQ2xELElBQUksaUJBQWlCLEVBQUU7Z0JBQ25CLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBTSxLQUFHLE9BQUksQ0FBQzthQUM1QztZQUNELElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLElBQUksR0FBTSxJQUFJLE9BQUksQ0FBQztTQUM5QztJQUNMLENBQUM7Ozs7O0lBRU8sOENBQWU7Ozs7SUFBdkI7UUFBQSxpQkEyRUM7UUExRUcsSUFBSSxDQUFDLFlBQVksR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsb0JBQW9CLEVBQUUsYUFBYSxDQUFDLENBQUM7O1lBQy9FLE1BQU0sR0FBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMscUJBQXFCLEVBQUU7UUFDMUUsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzdDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFHeEMsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQzs7O1lBR3RDLE9BQU8sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLHVCQUF1QixDQUFDLG9CQUFvQixDQUFDO1FBQ3RFLElBQUksQ0FBQyxjQUFjLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFcEQsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJOzs7O1FBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsSUFBSSxLQUFLLEdBQUcsRUFBZCxDQUFjLEVBQUMsRUFBRTs7Z0JBQ3RELGFBQWEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMscUJBQXFCLENBQUM7WUFDakYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFDLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBRSxDQUFDLENBQUM7U0FDL0Q7UUFFRCxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUVsRCxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUUxRSxJQUFJLENBQUMsY0FBYyxDQUFDLGlCQUFpQixDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRXRELElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztRQUdqRSxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsU0FBUzs7OztRQUFDLFVBQUMsQ0FBTTtZQUM1QyxJQUFBLGFBQUk7WUFDWixLQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzFCLENBQUMsRUFBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLFNBQVM7OztRQUFDO1lBQzlDLEtBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNoQixDQUFDLEVBQUMsQ0FBQztRQUVILHdCQUF3QjtRQUN4QixJQUFJLENBQUMsWUFBWSxDQUFDLGNBQWMsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxhQUFhOzs7O1FBQUUsVUFBQyxDQUFhO1lBQ2xHLElBQUksQ0FBQyxLQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMscUJBQXFCLENBQUMsRUFBRTtnQkFDbEUsT0FBTzthQUNWO1lBRUQsSUFBRyxLQUFJLENBQUMsUUFBUSxJQUFJLEtBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLGFBQWEsS0FBSyxDQUFDLENBQUMsTUFBTSxFQUFFO2dCQUNsRSxPQUFPLEtBQUssQ0FBQzthQUNoQjtZQUVELDJCQUEyQjtZQUMzQiw2QkFBNkI7WUFDN0IsY0FBYztZQUNkLElBQUk7WUFFSixLQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pCLENBQUMsRUFBQyxDQUFDO1FBR0gsSUFBSyxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFOztnQkFDbEUsU0FBUyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDLFlBQVksR0FBRyxFQUFFO1lBRS9HLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBTSxTQUFTLE9BQUksQ0FBQztZQUMxRixJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7Z0JBQ25CLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTtvQkFDaEUsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFNLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLEdBQUcsR0FBRyxTQUFTLEdBQUcsQ0FBQyxPQUFJLENBQUU7aUJBQ3JGO2dCQUNELElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7YUFDM0M7U0FDSjthQUFNO1lBQ0gsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztZQUNoRixJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7Z0JBQ25CLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsUUFBUSxDQUFDLENBQUM7YUFDeEQ7U0FDSjtRQUVELElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNuRCxDQUFDOzs7Ozs7SUFFTyx5Q0FBVTs7Ozs7SUFBbEIsVUFBbUIsSUFBUztRQUN4QixJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1AsT0FBTztTQUNWO1FBRUQsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLHNCQUFLLElBQUksSUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLElBQUUsQ0FBQztRQUNoRSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFFWixJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQzFCLENBQUM7Ozs7O0lBR08scURBQXNCOzs7O0lBQTlCO1FBQ0ksT0FBTyxJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUM7SUFDeEMsQ0FBQzs7Ozs7SUFFTywrQ0FBZ0I7Ozs7SUFBeEI7O1lBQ1UsRUFBRSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQSxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTO1FBQ25HLE9BQU8sRUFBRSxDQUFDLGFBQWEsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO0lBQ3BELENBQUM7Ozs7O0lBRU8sMkNBQVk7Ozs7SUFBcEI7UUFDUSxJQUFBLDRCQUFzRCxFQUFwRCxnQkFBSyxFQUFFLGtCQUFNLEVBQUUsWUFBRyxFQUFFLGNBQWdDOztZQUNwRCxNQUFNLEdBQUcsTUFBTSxDQUFDLFdBQVcsR0FBRyxNQUFNLEdBQUcsR0FBRzs7WUFDNUMsV0FBVyxHQUFHLElBQUksQ0FBQyxzQkFBc0IsRUFBRTs7WUFFekMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTTtRQUNyQyxJQUFJLE1BQU0sR0FBRyxXQUFXLEVBQUU7WUFDdEIsR0FBRyxHQUFHLEdBQUcsR0FBRyxNQUFNLENBQUM7WUFDbkIsV0FBVztZQUNYLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLGVBQWUsR0FBRyxVQUFVLENBQUM7U0FDeEQ7YUFBTTtZQUNILElBQUksR0FBRyxHQUFHLE1BQU0sRUFBRTtnQkFDZCxJQUFJLENBQUMsR0FBRyxXQUFXLEVBQUU7b0JBQ2pCLFdBQVcsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO29CQUNyQixHQUFHLEdBQUcsRUFBRSxDQUFDO2lCQUNaO3FCQUFNO29CQUNILEdBQUcsR0FBRyxHQUFHLEdBQUcsUUFBUSxDQUFDLEVBQUUsR0FBRyxXQUFXLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUNsRDtnQkFFRCxXQUFXO2dCQUNYLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLGVBQWUsR0FBRyxhQUFhLENBQUM7YUFFM0Q7aUJBQU07Z0JBQ0gsSUFBSSxDQUFDLEdBQUcsV0FBVyxFQUFFO29CQUNqQixXQUFXLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztpQkFDeEI7Z0JBQ0QsR0FBRyxHQUFHLEdBQUcsR0FBRyxNQUFNLENBQUM7YUFDdEI7U0FDSjs7WUFFRyxNQUFNLEdBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUEsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUEsQ0FBQyxDQUFDLEtBQUs7UUFDbkUsSUFBSSxNQUFNLENBQUMsVUFBVSxHQUFHLElBQUksR0FBRyxNQUFNLEVBQUU7WUFDbkMsSUFBSSxHQUFHLElBQUksR0FBRyxLQUFLLEdBQUcsTUFBTSxDQUFDO1NBQ2hDO1FBRUQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsR0FBRyxLQUFBLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxJQUFJLE1BQUEsRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBVSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDO0lBQ2xILENBQUM7Ozs7O0lBSUQsb0RBQXFCOzs7O0lBRHJCLFVBQ3NCLE1BQXFCO1FBRDNDLGlCQXFFQzs7WUFuRVMsSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNO1FBQ3hCLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxTQUFTLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxXQUFXLEVBQUU7WUFDMUQsTUFBTSxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3hCLE1BQU0sQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUV6QixJQUFJLElBQUksQ0FBQyxjQUFjLEVBQUU7O29CQUNmLEdBQUcsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxXQUFXOztvQkFDOUMsYUFBYTs7OztnQkFBRyxVQUFDLEtBQUs7b0JBQ3hCLEtBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDdEQsQ0FBQyxDQUFBO2dCQUVELElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxTQUFTLEVBQUUsRUFBRyxLQUFLO29CQUNuQyxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUMsRUFBRTs7NEJBQ04sT0FBTyxHQUFHLEdBQUcsR0FBRyxDQUFDO3dCQUNyQixJQUFJLE9BQU8sR0FBRyxDQUFDLEVBQUU7NEJBQ2IsT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO3lCQUM3Qjt3QkFDRCxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7cUJBQzFCO3lCQUFNO3dCQUNILGFBQWEsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO3FCQUNsQztpQkFDSjtnQkFDRCxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssV0FBVyxFQUFFLEVBQUUsT0FBTzs7O3dCQUNsQyxPQUFPLEdBQUcsR0FBRyxHQUFHLENBQUM7b0JBQ3JCLElBQUksT0FBTyxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7d0JBQ3hCLE9BQU8sR0FBRyxDQUFDLENBQUM7cUJBQ2Y7b0JBRUQsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2lCQUMxQjthQUNKO1NBQ0o7UUFFRCxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssV0FBVyxFQUFFO1lBQzdCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRTtnQkFDdEIsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLGVBQWUsSUFBSyxJQUFJLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEVBQUU7b0JBQ2hGLE1BQU0sQ0FBQyxjQUFjLEVBQUUsQ0FBQztvQkFDeEIsTUFBTSxDQUFDLGVBQWUsRUFBRSxDQUFDOzt3QkFDbkIsVUFBVSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsZUFBZSxDQUFDLE1BQU0sR0FBRSxDQUFDLENBQUM7b0JBQ2pHLElBQUksVUFBVSxFQUFFO3dCQUNaLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQzt3QkFDMUMsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFOzRCQUNyQixJQUFJLENBQUMsY0FBYyxDQUFDLGlCQUFpQixDQUFDLGFBQWEsRUFBRSxDQUFDO3lCQUN6RDtxQkFDSjtpQkFDSjthQUNKO1NBQ0o7UUFHRCxJQUFHLE1BQU0sQ0FBQyxHQUFHLEtBQUssT0FBTyxFQUFFO1lBQ3ZCLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTs7b0JBQ3BDLEdBQUcsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxXQUFXOztvQkFDOUMsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7Z0JBQ3RCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDekI7aUJBQU07Z0JBQ0gsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDdEM7U0FDSjtRQUVELElBQUcsTUFBTSxDQUFDLEdBQUcsS0FBSyxRQUFRLEVBQUU7WUFDeEIsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO2dCQUNuQixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDZjtpQkFBTTtnQkFDSCxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDO2FBQzFCO1NBQ0o7SUFDTCxDQUFDOztnQkExVEosU0FBUyxTQUFDLEVBQUUsUUFBUSxFQUFFLG9CQUFvQixFQUFDOzs7O2dCQVYxQixRQUFRO2dCQUFTLE1BQU07Z0JBQXVDLFNBQVM7Z0JBRWhGLG1CQUFtQjtnQkFHbkIsa0JBQWtCO2dCQU5ILHdCQUF3Qjs7O3lCQWEzQyxLQUFLLFNBQUMsa0JBQWtCOzRCQUN4QixLQUFLOzhCQUdMLEtBQUs7NkJBRUwsTUFBTTt3Q0E2T04sWUFBWSxTQUFDLFNBQVMsRUFBRSxDQUFDLFFBQVEsQ0FBQzs7SUFzRXZDLDJCQUFDO0NBQUEsQUEzVEQsSUEyVEM7U0ExVFksb0JBQW9COzs7SUFDN0Isc0NBQXNEOztJQUN0RCx5Q0FBdUI7Ozs7O0lBR3ZCLDJDQUE0Qjs7SUFFNUIsMENBQTBDOzs7OztJQUUxQyw0Q0FBa0M7Ozs7O0lBQ2xDLDhDQUEyRDs7Ozs7SUFFM0QsNkNBQTJCOzs7OztJQUMzQiw2Q0FBNEI7Ozs7O0lBRWhCLHdDQUEwQjs7Ozs7SUFDbEMsc0NBQXNCOzs7OztJQUN0QixzQ0FBeUI7Ozs7O0lBQ3pCLHdDQUFxQzs7Ozs7SUFDckMsNENBQXdDOzs7OztJQUN4QyxtQ0FBcUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlclZpZXdJbml0LCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIENvbXBvbmVudFJlZiwgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIGZvcndhcmRSZWYsIFxyXG4gICAgSG9zdExpc3RlbmVyLCBJbmplY3RvciwgSW5wdXQsIE5nWm9uZSwgT25EZXN0cm95LCBPbkluaXQsIE9wdGlvbmFsLCBPdXRwdXQsIFJlbmRlcmVyMiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyByZXFBbmltRnJhbWUgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbic7XHJcbmltcG9ydCB7IElucHV0R3JvdXBDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWlucHV0LWdyb3VwJztcclxuaW1wb3J0IHsgZnJvbSwgZnJvbUV2ZW50LCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgZmlsdGVyLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IFNlYXJjaEJveENvbXBvbmVudCB9IGZyb20gJy4uL3NlYXJjaC1ib3guY29tcG9uZW50JztcclxuaW1wb3J0IHsgU2VhcmNoRmllbGQgfSBmcm9tICcuLi9zZWFyY2gtYm94LnR5cGVzJztcclxuaW1wb3J0IHsgdHJpbSB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IFNlYXJjaFBhbmVsQ29tcG9uZW50IH0gZnJvbSAnLi9zZWFyY2gtcGFuZWwuY29tcG9uZW50JztcclxuXHJcbkBEaXJlY3RpdmUoeyBzZWxlY3RvcjogJ1tzZWFyY2gtYm94LXBhbmVsXSd9KVxyXG5leHBvcnQgY2xhc3MgU2VhcmNoUGFuZWxEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSB7XHJcbiAgICBASW5wdXQoJ3NlYXJjaC1ib3gtcGFuZWwnKSBmaWVsZHM6IEFycmF5PFNlYXJjaEZpZWxkPjtcclxuICAgIEBJbnB1dCgpIG1heEZpZWxkcyA9IDU7XHJcblxyXG4gICAgLyoqIOWQr+eUqCDku7vmhI/lrZfmrrUgKi9cclxuICAgIEBJbnB1dCgpIHVzZUFueUZpZWxkID0gdHJ1ZTtcclxuXHJcbiAgICBAT3V0cHV0KCkgZXNjSGFuZGxlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcclxuXHJcbiAgICBwcml2YXRlIHBhbmVsRWxlbWVudDogSFRNTEVsZW1lbnQ7XHJcbiAgICBwcml2YXRlIHNlYXJjaFBhbmVsUmVmOiBDb21wb25lbnRSZWY8U2VhcmNoUGFuZWxDb21wb25lbnQ+O1xyXG5cclxuICAgIHByaXZhdGUgbWF4UGFuZWxJdGVtcyA9IDEwO1xyXG4gICAgcHJpdmF0ZSBtaW5QYW5lbFdpZHRoID0gMjcwO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBcclxuICAgICAgICBwcml2YXRlIG5nem9uZTogTmdab25lLFxyXG4gICAgICAgIHByaXZhdGUgcmVuZGVyOiBSZW5kZXJlcjIsIFxyXG4gICAgICAgIHByaXZhdGUgaW5wdXRSZWY6IElucHV0R3JvdXBDb21wb25lbnQsXHJcbiAgICAgICAgcHJpdmF0ZSBzZWFyY2hCb3hSZWY6IFNlYXJjaEJveENvbXBvbmVudCxcclxuICAgICAgICBwcml2YXRlIGNmcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyKSB7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgXHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xyXG4gICAgICAgIGlmICgoIXRoaXMuZmllbGRzIHx8ICF0aGlzLmZpZWxkcy5sZW5ndGgpICYmICF0aGlzLnVzZUFueUZpZWxkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuaW5wdXRSZWYuaW5wdXRDbGljay5zdWJzY3JpYmUoKGU6IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5pbnB1dFJlZi52YWx1ZUNoYW5nZS5waXBlKFxyXG4gICAgICAgICAgICBkZWJvdW5jZVRpbWUoNTApXHJcbiAgICAgICAgKS5zdWJzY3JpYmUoKHZhbDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGlmICh0cmltKHZhbCkpIHtcclxuICAgICAgICAgICAgICAgIC8vIOWAvOWPmOWMluaYvuekuuafpeivoumdouadv1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLnBhbmVsRWxlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlRGF0YVBhbmVsKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWFyY2hQYW5lbFJlZi5pbnN0YW5jZS5zZXRBY3RpdmVJdGVtKDApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoUGFuZWxSZWYuaW5zdGFuY2Uuc2V0VmFsdWUodmFsKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhbmVsRWxlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLnNlYXJjaEJveFJlZi5jbGVhci5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmhpZGUoKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnNlYXJjaEJveFJlZi5vdmVyTGF5U2VydmljZS5kZXN0b3J5KHRoaXMuc2VhcmNoQm94UmVmLmVsLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVtb3ZlUGFuZWxFbGVtZW50KCkge1xyXG4gICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wYW5lbEVsZW1lbnQpO1xyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50ID0gbnVsbDtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuc2VhcmNoUGFuZWxSZWYpIHtcclxuICAgICAgICAgICAgdGhpcy5zZWFyY2hQYW5lbFJlZi5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgIHRoaXMuc2VhcmNoUGFuZWxSZWYgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgaGlkZShlPzogYW55KSB7XHJcbiAgICAgICAgcmVxQW5pbUZyYW1lKCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5pbnB1dFJlZi52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5wYW5lbEVsZW1lbnQpIHtcclxuICAgICAgICAgICAgICAgIGlmIChlICYmICggZS50eXBlID09PSAnbW91c2V3aGVlbCcgfHwgZS50eXBlID09PSAnd2hlZWwnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlUGFuZWxFbGVtZW50KCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGFuZWxFbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoJ2YtYXJlYS1zaG93Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlUGFuZWxFbGVtZW50KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSwxMjApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaEJveFJlZi5vdmVyTGF5U2VydmljZS5kZXN0b3J5KHRoaXMuc2VhcmNoQm94UmVmLmVsLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZXRQYW5lbFBvc2l0aW9uKHVwZGF0ZVRvcFBvc2l0aW9uID0gdHJ1ZSkge1xyXG4gICAgICAgIGlmICh0aGlzLnBhbmVsRWxlbWVudCkge1xyXG4gICAgICAgICAgICBjb25zdCB7IG1heFdpZHRoLCBsZWZ0LCB0b3AsIGhlaWdodCB9ID0gdGhpcy5nZXRQYW5lbFNpemUoKTtcclxuICAgICAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuc3R5bGUubWluV2lkdGggPSBgJHt0aGlzLm1pblBhbmVsV2lkdGh9cHhgO1xyXG4gICAgICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5zdHlsZS5tYXhXaWR0aCA9IGAke21heFdpZHRofXB4YDtcclxuICAgICAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuc3R5bGUubWF4SGVpZ2h0ID0gYCR7aGVpZ2h0fXB4YDtcclxuICAgICAgICAgICAgaWYgKHVwZGF0ZVRvcFBvc2l0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5zdHlsZS50b3AgPSBgJHt0b3B9cHhgO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMucGFuZWxFbGVtZW50LnN0eWxlLmxlZnQgPSBgJHtsZWZ0fXB4YDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjcmVhdGVEYXRhUGFuZWwoKSB7XHJcbiAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5jbGFzc0xpc3QuYWRkKCdvdmVybGF5LXBhbmUnLCAnZi1zZWFyY2gtYm94LXBhbmVsJywgJ2YtYXJlYS1oaWRlJyk7XHJcbiAgICAgICAgY29uc3QgemluZGV4ICA9ICcnICsgdGhpcy5zZWFyY2hCb3hSZWYuY29tbW9uVXRpbHMuZ2V0RmxvYXRpbmdMYXllckluZGV4KCk7XHJcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLnBhbmVsRWxlbWVudCk7XHJcbiAgICAgICAgdGhpcy5zZXRQYW5lbFBvc2l0aW9uKCk7XHJcbiAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuc3R5bGUuekluZGV4ID0gemluZGV4O1xyXG5cclxuXHJcbiAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuc3R5bGUub3ZlcmZsb3cgPSAnaGlkZGVuJztcclxuICAgICAgICBcclxuICAgICAgICAvLyDliJvlu7rmlbDmja7lsZXnpLrnu4Tku7ZcclxuICAgICAgICBjb25zdCBjbXBGYWN0ID0gdGhpcy5jZnIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoU2VhcmNoUGFuZWxDb21wb25lbnQpO1xyXG4gICAgICAgIHRoaXMuc2VhcmNoUGFuZWxSZWYgPSBjbXBGYWN0LmNyZWF0ZSh0aGlzLmluamVjdG9yKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMudXNlQW55RmllbGQgJiYgIXRoaXMuZmllbGRzLmZpbmQobiA9PiBuLmNvZGUgPT09ICcqJykpIHtcclxuICAgICAgICAgICAgY29uc3QgYW55ZmllbGRzTmFtZSA9IHRoaXMuc2VhcmNoQm94UmVmLmxvY2FsZVNlci5nZXRWYWx1ZSgnc2VhcmNoYm94LmFueUZpZWxkcycpXHJcbiAgICAgICAgICAgIHRoaXMuZmllbGRzLnNwbGljZSgwLDAsIHsgY29kZTogJyonLCBuYW1lOiBhbnlmaWVsZHNOYW1lIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5zZWFyY2hQYW5lbFJlZi5pbnN0YW5jZS5maWVsZHMgPSB0aGlzLmZpZWxkcztcclxuXHJcbiAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuYXBwZW5kQ2hpbGQodGhpcy5zZWFyY2hQYW5lbFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50KTtcclxuXHJcbiAgICAgICAgdGhpcy5zZWFyY2hQYW5lbFJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcblxyXG4gICAgICAgIHRoaXMuc2VhcmNoUGFuZWxSZWYuaW5zdGFuY2Uuc2VhcmNoS2V5V29yZCA9IHRoaXMuaW5wdXRSZWYudmFsdWU7XHJcbiAgICAgICAgXHJcblxyXG4gICAgICAgIHRoaXMuc2VhcmNoUGFuZWxSZWYuaW5zdGFuY2UuaXRlbUNsaWNrLnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgZGF0YSB9ID0gZTtcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3RJdGVtKGRhdGEpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLnNlYXJjaFBhbmVsUmVmLmluc3RhbmNlLmNsb3NlcGFuZWwuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5oaWRlKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIOazqOWGjOm8oOagh+a7mui9ru+8jOeCueWHu+S6i+S7tu+8jOeUqOS6jumakOiXj1BhbmVsXHJcbiAgICAgICAgdGhpcy5zZWFyY2hCb3hSZWYub3ZlckxheVNlcnZpY2UucmVnaXN0ZXJNb3VzZUV2ZW50KHRoaXMuc2VhcmNoQm94UmVmLmVsLm5hdGl2ZUVsZW1lbnQsIChlOiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5wYW5lbEVsZW1lbnQgfHwgZS50YXJnZXRbJ2Nsb3Nlc3QnXSgnLmYtc2VhcmNoLWJveC1wYW5lbCcpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmKHRoaXMuaW5wdXRSZWYgJiYgdGhpcy5pbnB1dFJlZi50ZXh0Ym94Lm5hdGl2ZUVsZW1lbnQgPT09IGUudGFyZ2V0KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIOi+k+WFpeahhuWGheacieaWh+acrOaXtu+8jOWmguaenOS4jeWFgeiuuOWFs+mXreW8ueWHuumdouadv++8jOWPr+aUvuW8gFxyXG4gICAgICAgICAgICAvLyBpZiAodGhpcy5pbnB1dFJlZi52YWx1ZSkge1xyXG4gICAgICAgICAgICAvLyAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAvLyB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLmhpZGUoZSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG5cclxuICAgICAgICBpZiAoIHRoaXMuc2VhcmNoUGFuZWxSZWYuaW5zdGFuY2UuZmllbGRzLmxlbmd0aCArIDEgPCB0aGlzLm1heFBhbmVsSXRlbXMpIHtcclxuICAgICAgICAgICAgbGV0IG5ld0hlaWdodCA9IHRoaXMuc2VhcmNoUGFuZWxSZWYuaW5zdGFuY2UuaXRlbXNDb250YWluZXIubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCd1bCcpLm9mZnNldEhlaWdodCArIDQwO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5zZWFyY2hQYW5lbFJlZi5pbnN0YW5jZS5pdGVtc0NvbnRhaW5lci5uYXRpdmVFbGVtZW50LnN0eWxlLmhlaWdodCA9IGAke25ld0hlaWdodH1weGA7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnBhbmVsRWxlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucGFuZWxFbGVtZW50LnN0eWxlLnRyYW5zZm9ybU9yaWdpbi5pbmRleE9mKCdib3R0b20nKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuc3R5bGUudG9wID0gYCR7dGhpcy5nZXRJbnB1dFNpemVJbmZvKCkudG9wIC0gbmV3SGVpZ2h0IC0gNX1weGAgO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gJ2F1dG8nO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5zZWFyY2hQYW5lbFJlZi5pbnN0YW5jZS5pdGVtc0NvbnRhaW5lci5uYXRpdmVFbGVtZW50LnN0eWxlLmhlaWdodCA9ICcxMDAlJztcclxuICAgICAgICAgICAgaWYgKHRoaXMucGFuZWxFbGVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlci5yZW1vdmVTdHlsZSh0aGlzLnBhbmVsRWxlbWVudCwgJ2hlaWdodCcpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5jbGFzc0xpc3QuYWRkKCdmLWFyZWEtc2hvdycpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2VsZWN0SXRlbShkYXRhOiBhbnkpIHtcclxuICAgICAgICBpZiAoIWRhdGEpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5zZWFyY2hCb3hSZWYuc2VsZWN0KHsuLi5kYXRhLCB2YWx1ZTogdGhpcy5pbnB1dFJlZi52YWx1ZX0pO1xyXG4gICAgICAgIHRoaXMuaGlkZSgpO1xyXG5cclxuICAgICAgICB0aGlzLmlucHV0UmVmLmZvY3VzKCk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgY2FsY3VsYXRpb25QYW5lbEhlaWdodCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tYXhQYW5lbEl0ZW1zICogMzAgKyAxNTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldElucHV0U2l6ZUluZm8oKSB7XHJcbiAgICAgICAgY29uc3QgZWwgPSB0aGlzLnNlYXJjaEJveFJlZi5lbmFibGVGbG9hdCA/IHRoaXMuc2VhcmNoQm94UmVmLnNoYWRvd0JveDogdGhpcy5zZWFyY2hCb3hSZWYuY29udGFpbmVyO1xyXG4gICAgICAgIHJldHVybiBlbC5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0UGFuZWxTaXplKCkge1xyXG4gICAgICAgIGxldCB7IHdpZHRoLCBoZWlnaHQsIHRvcCwgbGVmdCB9ID0gdGhpcy5nZXRJbnB1dFNpemVJbmZvKCk7XHJcbiAgICAgICAgY29uc3QgYm90dG9tID0gd2luZG93LmlubmVySGVpZ2h0IC0gaGVpZ2h0IC0gdG9wO1xyXG4gICAgICAgIGxldCBwYW5lbEhlaWdodCA9IHRoaXMuY2FsY3VsYXRpb25QYW5lbEhlaWdodCgpO1xyXG5cclxuICAgICAgICBjb25zdCBoID0gdG9wID4gYm90dG9tID8gdG9wIDogYm90dG9tO1xyXG4gICAgICAgIGlmIChib3R0b20gPiBwYW5lbEhlaWdodCkge1xyXG4gICAgICAgICAgICB0b3AgPSB0b3AgKyBoZWlnaHQ7XHJcbiAgICAgICAgICAgIC8vIOmdouadv+eUseS4iuWQkeS4i+WxleW8gFxyXG4gICAgICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5zdHlsZS50cmFuc2Zvcm1PcmlnaW4gPSAnMTAwJSB0b3AnO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0b3AgPiBib3R0b20pIHtcclxuICAgICAgICAgICAgICAgIGlmIChoIDwgcGFuZWxIZWlnaHQpIHtcclxuICAgICAgICAgICAgICAgICAgICBwYW5lbEhlaWdodCA9IGggLSAxMDtcclxuICAgICAgICAgICAgICAgICAgICB0b3AgPSAxMDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdG9wID0gdG9wIC0gcGFyc2VJbnQoJycgKyBwYW5lbEhlaWdodCwgMTApIC0gNTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAvLyDpnaLmnb/nlLHkuIvlkJHkuIrlsZXlvIBcclxuICAgICAgICAgICAgICAgIHRoaXMucGFuZWxFbGVtZW50LnN0eWxlLnRyYW5zZm9ybU9yaWdpbiA9ICcxMDAlIGJvdHRvbSc7XHJcblxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKGggPCBwYW5lbEhlaWdodCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhbmVsSGVpZ2h0ID0gaCAtIDEwO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdG9wID0gdG9wICsgaGVpZ2h0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgX3dpZHRoID0gIHdpZHRoIDwgdGhpcy5taW5QYW5lbFdpZHRoPyB0aGlzLm1pblBhbmVsV2lkdGg6IHdpZHRoO1xyXG4gICAgICAgIGlmICh3aW5kb3cuaW5uZXJXaWR0aCAtIGxlZnQgPCBfd2lkdGgpIHtcclxuICAgICAgICAgICAgbGVmdCA9IGxlZnQgKyB3aWR0aCAtIF93aWR0aDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB7IHdpZHRoOiBfd2lkdGgsIHRvcCwgaGVpZ2h0OiBwYW5lbEhlaWdodCwgbGVmdCwgbWF4V2lkdGg6IE1hdGguZmxvb3Iod2luZG93LmlubmVyV2lkdGggLSBsZWZ0IC0gMTApIH07XHJcbiAgICB9XHJcblxyXG5cclxuICAgIEBIb3N0TGlzdGVuZXIoJ2tleWRvd24nLCBbJyRldmVudCddKVxyXG4gICAgcmVnaXN0ZXJLZXlib2FyZEV2ZW50KCRldmVudDogS2V5Ym9hcmRFdmVudCkge1xyXG4gICAgICAgIGNvbnN0IHJvd3MgPSB0aGlzLmZpZWxkcztcclxuICAgICAgICBpZiAoJGV2ZW50LmNvZGUgPT09ICdBcnJvd1VwJyB8fCAkZXZlbnQuY29kZSA9PT0gJ0Fycm93RG93bicpIHtcclxuICAgICAgICAgICAgJGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNlYXJjaFBhbmVsUmVmKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpZHggPSB0aGlzLnNlYXJjaFBhbmVsUmVmLmluc3RhbmNlLmFjdGl2ZUluZGV4O1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2V0QWN0aXZlSXRlbSA9IChpbmRleCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoUGFuZWxSZWYuaW5zdGFuY2Uuc2V0QWN0aXZlSXRlbShpbmRleCk7XHJcbiAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICgkZXZlbnQuY29kZSA9PT0gJ0Fycm93VXAnKSB7ICAvLyB1cFxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpZHggPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgcHJldklkeCA9IGlkeCAtIDE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2SWR4IDwgMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldklkeCA9IHJvd3MubGVuZ3RoIC0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRBY3RpdmVJdGVtKHByZXZJZHgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldEFjdGl2ZUl0ZW0ocm93cy5sZW5ndGggLSAxKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoJGV2ZW50LmNvZGUgPT09ICdBcnJvd0Rvd24nKSB7IC8vIGRvd25cclxuICAgICAgICAgICAgICAgICAgICBsZXQgbmV4dElkeCA9IGlkeCArIDE7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5leHRJZHggPj0gcm93cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmV4dElkeCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBzZXRBY3RpdmVJdGVtKG5leHRJZHgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoJGV2ZW50LmNvZGUgPT09ICdCYWNrc3BhY2UnKSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5pbnB1dFJlZi52YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc2VhcmNoQm94UmVmLmRpc3BsYXlUZXh0TGlzdCAmJiAgdGhpcy5zZWFyY2hCb3hSZWYuZGlzcGxheVRleHRMaXN0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZW1vdmVJdGVtID0gdGhpcy5zZWFyY2hCb3hSZWYuZGlzcGxheVRleHRMaXN0W3RoaXMuc2VhcmNoQm94UmVmLmRpc3BsYXlUZXh0TGlzdC5sZW5ndGggLTFdO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZW1vdmVJdGVtKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoQm94UmVmLnJlbW92ZShyZW1vdmVJdGVtLmNvZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zZWFyY2hQYW5lbFJlZikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWFyY2hQYW5lbFJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICBpZigkZXZlbnQua2V5ID09PSAnRW50ZXInKSB7XHJcbiAgICAgICAgICAgIGlmIChyb3dzICYmIHJvd3MubGVuZ3RoICYmIHRoaXMucGFuZWxFbGVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpZHggPSB0aGlzLnNlYXJjaFBhbmVsUmVmLmluc3RhbmNlLmFjdGl2ZUluZGV4O1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHJvd3NbaWR4XTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0SXRlbShkYXRhKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoQm94UmVmLm9uU3VibWl0KCRldmVudCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKCRldmVudC5rZXkgPT09ICdFc2NhcGUnKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnBhbmVsRWxlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVzY0hhbmRsZXIuZW1pdCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59Il19