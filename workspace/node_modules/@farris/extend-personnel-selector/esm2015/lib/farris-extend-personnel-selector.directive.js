/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/**
 * 使用方法：
 * [mapFields]="{ id: 'user.userId', name: 'user.userName' }"
 * key 为帮助上的字段， value 为 表单中的字段名
 * 帮助上的同一个字段可以映射到表单中的多个字段中，{ ... id: 'user.userid, user.addusid'}
 * 多字段以逗号隔开
 *
 */
import { Directive, Optional, Self, Input, Injector } from '@angular/core';
import { ViewModel } from '@farris/devkit';
import { PersonnelSelectorComponent } from '@farris/ui-personnel-selector';
export class PersonnelSelectorDataMappingDirective {
    /**
     * @param {?} vm
     * @param {?} targetComponent
     * @param {?} injector
     */
    constructor(vm, targetComponent, injector) {
        this.vm = vm;
        this.targetComponent = targetComponent;
        this.injector = injector;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.targetComponent.selectionsChange.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            /** @type {?} */
            const mapfields = this.mapFields;
            if (data.data && data.data.length) {
                this.mappingData(data.data, mapfields);
            }
            else {
                this.mappingData(null, mapfields);
            }
        }));
        this.targetComponent.inputClear.subscribe((/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            const mapfields = this.mapFields;
            this.mappingData(null, mapfields);
        }));
        this.targetComponent.tagRemoved.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            /** @type {?} */
            const mapfields = this.mapFields;
            this.tagRemovedMappingData(data.deleteIndex, mapfields);
            // if (this.targetComponent.selections && this.targetComponent.selections.length) {
            //     this.mappingData(this.targetComponent.selections, mapfields);
            // } else {
            //     this.mappingData(null, mapfields);
            // }
        }));
        if (!this.targetComponent.mapFields) {
            this.targetComponent.mapFields = this.mapFields;
        }
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
    }
    /**
     * @param {?} index
     * @param {?} mapFields
     * @return {?}
     */
    tagRemovedMappingData(index, mapFields) {
        if (!mapFields) {
            return;
        }
        if (this.targetComponent.ngControl &&
            this.targetComponent.ngControl.formDirective &&
            this.targetComponent.ngControl.formDirective.form &&
            this.targetComponent.ngControl.formDirective.form.bindingData) {
            /** @type {?} */
            const bindingData = this.targetComponent.ngControl.formDirective.form.bindingData;
            if (bindingData.setValue) {
                // 关闭变更检测
                /** @type {?} */
                const appContext = this.vm.frameContext.appContext;
                appContext.changeDetectionController.detach();
                /** @type {?} */
                let helpFields = Object.keys(mapFields);
                /** @type {?} */
                const idIndex = helpFields.findIndex((/**
                 * @param {?} item
                 * @return {?}
                 */
                item => item === this.targetComponent.idField));
                if (helpFields.includes(this.targetComponent.idField) && idIndex !== 0) {
                    helpFields.splice(idIndex, 1);
                    helpFields = [this.targetComponent.idField, ...helpFields];
                }
                /** @type {?} */
                const pathArr = this.getBindingPathArray();
                /** @type {?} */
                const anyFieldArr = this.mapFields[helpFields[0]].split(',');
                /** @type {?} */
                const formAnyData = bindingData.getValue(pathArr.concat(anyFieldArr[0]));
                if (!formAnyData || formAnyData.split(',').length < 2) {
                    helpFields.reverse();
                }
                helpFields.forEach((/**
                 * @param {?} field
                 * @return {?}
                 */
                (field) => {
                    /** @type {?} */
                    const fieldArr = this.mapFields[field].split(',');
                    fieldArr.forEach((/**
                     * @param {?} fa
                     * @return {?}
                     */
                    fa => {
                        /** @type {?} */
                        const path = pathArr.concat(fa.split('.'));
                        if (this.targetComponent.ngControl.path.join() === path.join()) {
                            return;
                        }
                        /** @type {?} */
                        const resStr = bindingData.getValue(path);
                        if (!resStr) {
                            bindingData.clearValue(path, true, true);
                        }
                        else {
                            /** @type {?} */
                            const resArr = resStr.split(',');
                            resArr.splice(index, 1);
                            /** @type {?} */
                            const result = resArr.join();
                            if (!result) {
                                bindingData.clearValue(path, true, true);
                            }
                            else {
                                bindingData.setValue(path, result, true, true);
                            }
                        }
                    }));
                }));
                // 重新打开变更检测
                appContext.changeDetectionController.reattach();
            }
        }
    }
    /**
     *
     * @param {?} helpData 清空时，值为null
     * @param {?} mapFields 格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"}
     * @return {?}
     */
    mappingData(helpData, mapFields) {
        if (!mapFields) {
            return;
        }
        // 关闭变更检测
        /** @type {?} */
        const appContext = this.vm.frameContext.appContext;
        appContext.changeDetectionController.detach();
        /** @type {?} */
        let helpFields = Object.keys(mapFields);
        /** @type {?} */
        const idIndex = helpFields.findIndex((/**
         * @param {?} item
         * @return {?}
         */
        item => item === this.targetComponent.idField));
        if (helpFields.includes(this.targetComponent.idField) && idIndex !== 0) {
            helpFields.splice(idIndex, 1);
            helpFields = [this.targetComponent.idField, ...helpFields];
        }
        if (!helpData) {
            helpFields.reverse();
        }
        helpFields.forEach((/**
         * @param {?} f
         * @return {?}
         */
        (f) => {
            // 1、获取字段值
            // 如果helpData有选中值，则获取帮助数据源里对应你字段的值；
            // 如果helpData没有值（清空场景），则返回一个空字符串
            /** @type {?} */
            let val = '';
            if (helpData) {
                if (helpData instanceof Array) {
                    val = helpData.map((/**
                     * @param {?} h
                     * @return {?}
                     */
                    (h) => {
                        return this.getValue(f, h);
                    })).join(',');
                }
                else {
                    val = this.getValue(f, helpData);
                }
            }
            // 2、设置字段值
            // 如果helpData不存在（清空场景），获取BindingData里对应字段的值，如果是数值，则设置0，其他设置上一步中的空字符串；
            // 如果helpData存在：直接设置上一步中获取的值。
            /** @type {?} */
            const pathArr = this.getBindingPathArray();
            mapFields[f].split(',').forEach((/**
             * @param {?} ff
             * @return {?}
             */
            (ff) => {
                if (this.targetComponent.ngControl.path.join() === ff) {
                    return;
                }
                if (!helpData) {
                    this.vm.bindingData.clearValue(pathArr.concat(ff.split('.')), true, true);
                }
                else {
                    this.vm.bindingData.setValue(pathArr.concat(ff.split('.')), val, true, true);
                }
            }));
        }));
        // 重新打开变更检测
        appContext.changeDetectionController.reattach();
    }
    /**
     * @private
     * @param {?} f
     * @param {?} data
     * @return {?}
     */
    getValue(f, data) {
        /** @type {?} */
        let val = '';
        if (f.indexOf('.') === -1) {
            val = data[f];
        }
        else {
            val = f.split('.').reduce((/**
             * @param {?} a
             * @param {?} b
             * @return {?}
             */
            (a, b) => {
                return a[b];
            }), data);
        }
        return val;
    }
    /**
     * @private
     * @return {?}
     */
    getBindingPathArray() {
        /** @type {?} */
        const path = this.vm.bindingPath;
        if (path) {
            return path.split('/').filter((/**
             * @param {?} n
             * @return {?}
             */
            n => n !== ''));
        }
        return [];
    }
}
PersonnelSelectorDataMappingDirective.decorators = [
    { type: Directive, args: [{
                // tslint:disable-next-line:directive-selector
                selector: '[personnel-selector-data-mapping]'
            },] }
];
/** @nocollapse */
PersonnelSelectorDataMappingDirective.ctorParameters = () => [
    { type: ViewModel, decorators: [{ type: Optional }] },
    { type: PersonnelSelectorComponent, decorators: [{ type: Optional }, { type: Self }] },
    { type: Injector }
];
PersonnelSelectorDataMappingDirective.propDecorators = {
    mapFields: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    PersonnelSelectorDataMappingDirective.prototype.mapFields;
    /**
     * @type {?}
     * @private
     */
    PersonnelSelectorDataMappingDirective.prototype.vm;
    /**
     * @type {?}
     * @private
     */
    PersonnelSelectorDataMappingDirective.prototype.targetComponent;
    /**
     * @type {?}
     * @private
     */
    PersonnelSelectorDataMappingDirective.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzLWV4dGVuZC1wZXJzb25uZWwtc2VsZWN0b3IuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9leHRlbmQtcGVyc29ubmVsLXNlbGVjdG9yLyIsInNvdXJjZXMiOlsibGliL2ZhcnJpcy1leHRlbmQtcGVyc29ubmVsLXNlbGVjdG9yLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFTQSxPQUFPLEVBQUUsU0FBUyxFQUFVLFFBQVEsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUE0QixRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0csT0FBTyxFQUFzQixTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUUvRCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUszRSxNQUFNLE9BQU8scUNBQXFDOzs7Ozs7SUFJOUMsWUFDd0IsRUFBYSxFQUNMLGVBQTJDLEVBQy9ELFFBQWtCO1FBRk4sT0FBRSxHQUFGLEVBQUUsQ0FBVztRQUNMLG9CQUFlLEdBQWYsZUFBZSxDQUE0QjtRQUMvRCxhQUFRLEdBQVIsUUFBUSxDQUFVO0lBQzFCLENBQUM7Ozs7SUFFTCxRQUFRO1FBQ0osSUFBSSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTOzs7O1FBQUMsQ0FBQyxJQUFTLEVBQUUsRUFBRTs7a0JBQ3BELFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUztZQUNoQyxJQUFJLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQy9CLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQzthQUMxQztpQkFBTTtnQkFDSCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQzthQUNyQztRQUNMLENBQUMsRUFBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLGVBQWUsQ0FB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QUFNOzs7OztZQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUMvQixPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNoQixDQUFDLEdBQUUsSUFBSSxDQUFDLENBQUM7U0FDWjtRQUVELE9BQU8sR0FBRyxDQUFDO0lBQ2YsQ0FBQzs7Ozs7SUFFTyxtQkFBbUI7O2NBQ2pCLElBQUksR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLFdBQVc7UUFDaEMsSUFBSSxJQUFJLEVBQUU7WUFDTixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTTs7OztZQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBQyxDQUFDO1NBQ2hEO1FBQ0QsT0FBTyxFQUFFLENBQUM7SUFDZCxDQUFDOzs7WUF6TEosU0FBUyxTQUFDOztnQkFFUCxRQUFRLEVBQUUsbUNBQW1DO2FBQ2hEOzs7O1lBTjRCLFNBQVMsdUJBWTdCLFFBQVE7WUFWUiwwQkFBMEIsdUJBVzFCLFFBQVEsWUFBSSxJQUFJO1lBZG9ELFFBQVE7Ozt3QkFVaEYsS0FBSzs7OztJQUFOLDBEQUF3Qjs7Ozs7SUFHcEIsbURBQWlDOzs7OztJQUNqQyxnRUFBdUU7Ozs7O0lBQ3ZFLHlEQUEwQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICog5L2/55So5pa55rOV77yaXG4gKiBbbWFwRmllbGRzXT1cInsgaWQ6ICd1c2VyLnVzZXJJZCcsIG5hbWU6ICd1c2VyLnVzZXJOYW1lJyB9XCJcbiAqIGtleSDkuLrluK7liqnkuIrnmoTlrZfmrrXvvIwgdmFsdWUg5Li6IOihqOWNleS4reeahOWtl+auteWQjVxuICog5biu5Yqp5LiK55qE5ZCM5LiA5Liq5a2X5q615Y+v5Lul5pig5bCE5Yiw6KGo5Y2V5Lit55qE5aSa5Liq5a2X5q615Lit77yMeyAuLi4gaWQ6ICd1c2VyLnVzZXJpZCwgdXNlci5hZGR1c2lkJ31cbiAqIOWkmuWtl+auteS7pemAl+WPt+malOW8gFxuICpcbiAqL1xuXG5pbXBvcnQgeyBEaXJlY3RpdmUsIE9uSW5pdCwgT3B0aW9uYWwsIFNlbGYsIElucHV0LCBPbkRlc3Ryb3ksIEFmdGVyVmlld0luaXQsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDaGFuZ2UsIENoYW5nZVR5cGUsIFZpZXdNb2RlbCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcbmltcG9ydCB7IE1lc3NhZ2VyU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbWVzc2FnZXInO1xuaW1wb3J0IHsgUGVyc29ubmVsU2VsZWN0b3JDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLXBlcnNvbm5lbC1zZWxlY3Rvcic7XG5ARGlyZWN0aXZlKHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6ZGlyZWN0aXZlLXNlbGVjdG9yXG4gICAgc2VsZWN0b3I6ICdbcGVyc29ubmVsLXNlbGVjdG9yLWRhdGEtbWFwcGluZ10nXG59KVxuZXhwb3J0IGNsYXNzIFBlcnNvbm5lbFNlbGVjdG9yRGF0YU1hcHBpbmdEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSB7XG5cbiAgICBASW5wdXQoKSBtYXBGaWVsZHM6IGFueTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHZtOiBWaWV3TW9kZWwsXG4gICAgICAgIEBPcHRpb25hbCgpIEBTZWxmKCkgcHJpdmF0ZSB0YXJnZXRDb21wb25lbnQ6IFBlcnNvbm5lbFNlbGVjdG9yQ29tcG9uZW50LFxuICAgICAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvclxuICAgICkgeyB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgdGhpcy50YXJnZXRDb21wb25lbnQuc2VsZWN0aW9uc0NoYW5nZS5zdWJzY3JpYmUoKGRhdGE6IGFueSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbWFwZmllbGRzID0gdGhpcy5tYXBGaWVsZHM7XG4gICAgICAgICAgICBpZiAoZGF0YS5kYXRhICYmIGRhdGEuZGF0YS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1hcHBpbmdEYXRhKGRhdGEuZGF0YSwgbWFwZmllbGRzKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5tYXBwaW5nRGF0YShudWxsLCBtYXBmaWVsZHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnRhcmdldENvbXBvbmVudC5pbnB1dENsZWFyLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBtYXBmaWVsZHMgPSB0aGlzLm1hcEZpZWxkcztcbiAgICAgICAgICAgIHRoaXMubWFwcGluZ0RhdGEobnVsbCwgbWFwZmllbGRzKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy50YXJnZXRDb21wb25lbnQudGFnUmVtb3ZlZC5zdWJzY3JpYmUoKGRhdGEpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1hcGZpZWxkcyA9IHRoaXMubWFwRmllbGRzO1xuICAgICAgICAgICAgdGhpcy50YWdSZW1vdmVkTWFwcGluZ0RhdGEoZGF0YS5kZWxldGVJbmRleCwgbWFwZmllbGRzKTtcbiAgICAgICAgICAgIC8vIGlmICh0aGlzLnRhcmdldENvbXBvbmVudC5zZWxlY3Rpb25zICYmIHRoaXMudGFyZ2V0Q29tcG9uZW50LnNlbGVjdGlvbnMubGVuZ3RoKSB7XG4gICAgICAgICAgICAvLyAgICAgdGhpcy5tYXBwaW5nRGF0YSh0aGlzLnRhcmdldENvbXBvbmVudC5zZWxlY3Rpb25zLCBtYXBmaWVsZHMpO1xuICAgICAgICAgICAgLy8gfSBlbHNlIHtcbiAgICAgICAgICAgIC8vICAgICB0aGlzLm1hcHBpbmdEYXRhKG51bGwsIG1hcGZpZWxkcyk7XG4gICAgICAgICAgICAvLyB9XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoIXRoaXMudGFyZ2V0Q29tcG9uZW50Lm1hcEZpZWxkcykge1xuICAgICAgICAgICAgdGhpcy50YXJnZXRDb21wb25lbnQubWFwRmllbGRzID0gdGhpcy5tYXBGaWVsZHM7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG5cbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcblxuICAgIH1cblxuICAgIHRhZ1JlbW92ZWRNYXBwaW5nRGF0YShpbmRleCwgbWFwRmllbGRzKSB7XG4gICAgICAgIGlmICghbWFwRmllbGRzKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgdGhpcy50YXJnZXRDb21wb25lbnQubmdDb250cm9sICYmXG4gICAgICAgICAgICB0aGlzLnRhcmdldENvbXBvbmVudC5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZSAmJlxuICAgICAgICAgICAgdGhpcy50YXJnZXRDb21wb25lbnQubmdDb250cm9sLmZvcm1EaXJlY3RpdmUuZm9ybSAmJlxuICAgICAgICAgICAgdGhpcy50YXJnZXRDb21wb25lbnQubmdDb250cm9sLmZvcm1EaXJlY3RpdmUuZm9ybS5iaW5kaW5nRGF0YVxuICAgICAgICApIHtcbiAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdEYXRhID0gdGhpcy50YXJnZXRDb21wb25lbnQubmdDb250cm9sLmZvcm1EaXJlY3RpdmUuZm9ybS5iaW5kaW5nRGF0YTtcbiAgICAgICAgICAgIGlmIChiaW5kaW5nRGF0YS5zZXRWYWx1ZSkge1xuICAgICAgICAgICAgICAgIC8vIOWFs+mXreWPmOabtOajgOa1i1xuICAgICAgICAgICAgICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLnZtLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0O1xuICAgICAgICAgICAgICAgIGFwcENvbnRleHQuY2hhbmdlRGV0ZWN0aW9uQ29udHJvbGxlci5kZXRhY2goKTtcblxuICAgICAgICAgICAgICAgIGxldCBoZWxwRmllbGRzID0gT2JqZWN0LmtleXMobWFwRmllbGRzKTtcbiAgICAgICAgICAgICAgICBjb25zdCBpZEluZGV4ID0gaGVscEZpZWxkcy5maW5kSW5kZXgoaXRlbSA9PiBpdGVtID09PSB0aGlzLnRhcmdldENvbXBvbmVudC5pZEZpZWxkKTtcbiAgICAgICAgICAgICAgICBpZiAoaGVscEZpZWxkcy5pbmNsdWRlcyh0aGlzLnRhcmdldENvbXBvbmVudC5pZEZpZWxkKSAmJiBpZEluZGV4ICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGhlbHBGaWVsZHMuc3BsaWNlKGlkSW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgICAgICBoZWxwRmllbGRzID0gW3RoaXMudGFyZ2V0Q29tcG9uZW50LmlkRmllbGQsIC4uLmhlbHBGaWVsZHNdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb25zdCBwYXRoQXJyID0gdGhpcy5nZXRCaW5kaW5nUGF0aEFycmF5KCk7XG4gICAgICAgICAgICAgICAgY29uc3QgYW55RmllbGRBcnIgPSB0aGlzLm1hcEZpZWxkc1toZWxwRmllbGRzWzBdXS5zcGxpdCgnLCcpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGZvcm1BbnlEYXRhID0gYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aEFyci5jb25jYXQoYW55RmllbGRBcnJbMF0pKTtcblxuICAgICAgICAgICAgICAgIGlmICghZm9ybUFueURhdGEgfHwgZm9ybUFueURhdGEuc3BsaXQoJywnKS5sZW5ndGggPCAyKSB7XG4gICAgICAgICAgICAgICAgICAgIGhlbHBGaWVsZHMucmV2ZXJzZSgpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGhlbHBGaWVsZHMuZm9yRWFjaCgoZmllbGQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWVsZEFyciA9IHRoaXMubWFwRmllbGRzW2ZpZWxkXS5zcGxpdCgnLCcpO1xuICAgICAgICAgICAgICAgICAgICBmaWVsZEFyci5mb3JFYWNoKGZhID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhdGggPSBwYXRoQXJyLmNvbmNhdChmYS5zcGxpdCgnLicpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldENvbXBvbmVudC5uZ0NvbnRyb2wucGF0aC5qb2luKCkgPT09IHBhdGguam9pbigpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzU3RyID0gYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc1N0cikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdEYXRhLmNsZWFyVmFsdWUocGF0aCwgdHJ1ZSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc0FyciA9IHJlc1N0ci5zcGxpdCgnLCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc0Fyci5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHJlc0Fyci5qb2luKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmluZGluZ0RhdGEuY2xlYXJWYWx1ZShwYXRoLCB0cnVlLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nRGF0YS5zZXRWYWx1ZShwYXRoLCByZXN1bHQsIHRydWUsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgLy8g6YeN5paw5omT5byA5Y+Y5pu05qOA5rWLXG4gICAgICAgICAgICAgICAgYXBwQ29udGV4dC5jaGFuZ2VEZXRlY3Rpb25Db250cm9sbGVyLnJlYXR0YWNoKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gaGVscERhdGEg5riF56m65pe277yM5YC85Li6bnVsbFxuICAgICAqIEBwYXJhbSBtYXBGaWVsZHMg5qC85byP5b2i5aaC77yae2lkOiBcImFzc29GaWVsZC5hc3NvRmllbGRcIiwgY29kZTogXCJhc3NvRmllbGQuYXNzb0ZpZWxkX0NvZGVcIiwgbmFtZTogXCJhc3NvRmllbGQuYXNzb0ZpZWxkX05hbWVcIn1cbiAgICAgKi9cbiAgICBtYXBwaW5nRGF0YShoZWxwRGF0YTogYW55LCBtYXBGaWVsZHM6IGFueSkge1xuICAgICAgICBpZiAoIW1hcEZpZWxkcykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g5YWz6Zet5Y+Y5pu05qOA5rWLXG4gICAgICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLnZtLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0O1xuICAgICAgICBhcHBDb250ZXh0LmNoYW5nZURldGVjdGlvbkNvbnRyb2xsZXIuZGV0YWNoKCk7XG5cbiAgICAgICAgbGV0IGhlbHBGaWVsZHMgPSBPYmplY3Qua2V5cyhtYXBGaWVsZHMpO1xuICAgICAgICBjb25zdCBpZEluZGV4ID0gaGVscEZpZWxkcy5maW5kSW5kZXgoaXRlbSA9PiBpdGVtID09PSB0aGlzLnRhcmdldENvbXBvbmVudC5pZEZpZWxkKTtcbiAgICAgICAgaWYgKGhlbHBGaWVsZHMuaW5jbHVkZXModGhpcy50YXJnZXRDb21wb25lbnQuaWRGaWVsZCkgJiYgaWRJbmRleCAhPT0gMCkge1xuICAgICAgICAgICAgaGVscEZpZWxkcy5zcGxpY2UoaWRJbmRleCwgMSk7XG4gICAgICAgICAgICBoZWxwRmllbGRzID0gW3RoaXMudGFyZ2V0Q29tcG9uZW50LmlkRmllbGQsIC4uLmhlbHBGaWVsZHNdO1xuICAgICAgICB9XG4gICAgICAgIGlmICghaGVscERhdGEpIHtcbiAgICAgICAgICAgIGhlbHBGaWVsZHMucmV2ZXJzZSgpO1xuICAgICAgICB9XG4gICAgICAgIGhlbHBGaWVsZHMuZm9yRWFjaCgoZjogYW55KSA9PiB7XG4gICAgICAgICAgICAvLyAx44CB6I635Y+W5a2X5q615YC8XG4gICAgICAgICAgICAvLyDlpoLmnpxoZWxwRGF0YeaciemAieS4reWAvO+8jOWImeiOt+WPluW4ruWKqeaVsOaNrua6kOmHjOWvueW6lOS9oOWtl+auteeahOWAvO+8m1xuICAgICAgICAgICAgLy8g5aaC5p6caGVscERhdGHmsqHmnInlgLzvvIjmuIXnqbrlnLrmma/vvInvvIzliJnov5Tlm57kuIDkuKrnqbrlrZfnrKbkuLJcbiAgICAgICAgICAgIGxldCB2YWw6IGFueSA9ICcnO1xuICAgICAgICAgICAgaWYgKGhlbHBEYXRhKSB7XG4gICAgICAgICAgICAgICAgaWYgKGhlbHBEYXRhIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFsID0gaGVscERhdGEubWFwKChoOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFZhbHVlKGYsIGgpO1xuICAgICAgICAgICAgICAgICAgICB9KS5qb2luKCcsJyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdmFsID0gdGhpcy5nZXRWYWx1ZShmLCBoZWxwRGF0YSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyAy44CB6K6+572u5a2X5q615YC8XG4gICAgICAgICAgICAvLyDlpoLmnpxoZWxwRGF0YeS4jeWtmOWcqO+8iOa4heepuuWcuuaZr++8ie+8jOiOt+WPlkJpbmRpbmdEYXRh6YeM5a+55bqU5a2X5q6155qE5YC877yM5aaC5p6c5piv5pWw5YC877yM5YiZ6K6+572uMO+8jOWFtuS7luiuvue9ruS4iuS4gOatpeS4reeahOepuuWtl+espuS4su+8m1xuICAgICAgICAgICAgLy8g5aaC5p6caGVscERhdGHlrZjlnKjvvJrnm7TmjqXorr7nva7kuIrkuIDmraXkuK3ojrflj5bnmoTlgLzjgIJcbiAgICAgICAgICAgIGNvbnN0IHBhdGhBcnIgPSB0aGlzLmdldEJpbmRpbmdQYXRoQXJyYXkoKTtcbiAgICAgICAgICAgIG1hcEZpZWxkc1tmXS5zcGxpdCgnLCcpLmZvckVhY2goKGZmOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy50YXJnZXRDb21wb25lbnQubmdDb250cm9sLnBhdGguam9pbigpID09PSBmZikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghaGVscERhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy52bS5iaW5kaW5nRGF0YS5jbGVhclZhbHVlKHBhdGhBcnIuY29uY2F0KGZmLnNwbGl0KCcuJykpLCB0cnVlLCB0cnVlKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnZtLmJpbmRpbmdEYXRhLnNldFZhbHVlKHBhdGhBcnIuY29uY2F0KGZmLnNwbGl0KCcuJykpLCB2YWwsIHRydWUsIHRydWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyDph43mlrDmiZPlvIDlj5jmm7Tmo4DmtYtcbiAgICAgICAgYXBwQ29udGV4dC5jaGFuZ2VEZXRlY3Rpb25Db250cm9sbGVyLnJlYXR0YWNoKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRWYWx1ZShmOiBzdHJpbmcsIGRhdGE6IGFueSkge1xuICAgICAgICBsZXQgdmFsID0gJyc7XG4gICAgICAgIGlmIChmLmluZGV4T2YoJy4nKSA9PT0gLTEpIHtcbiAgICAgICAgICAgIHZhbCA9IGRhdGFbZl07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB2YWwgPSBmLnNwbGl0KCcuJykucmVkdWNlKChhLCBiKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFbYl07XG4gICAgICAgICAgICB9LCBkYXRhKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB2YWw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRCaW5kaW5nUGF0aEFycmF5KCk6IGFueVtdIHtcbiAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMudm0uYmluZGluZ1BhdGg7XG4gICAgICAgIGlmIChwYXRoKSB7XG4gICAgICAgICAgICByZXR1cm4gcGF0aC5zcGxpdCgnLycpLmZpbHRlcihuID0+IG4gIT09ICcnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuXG59XG4iXX0=