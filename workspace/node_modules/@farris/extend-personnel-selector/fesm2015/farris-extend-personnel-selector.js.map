{"version":3,"file":"farris-extend-personnel-selector.js.map","sources":["ng://@farris/extend-personnel-selector/lib/farris-extend-personnel-selector.directive.ts","ng://@farris/extend-personnel-selector/lib/farris-extend-personnel-selector.module.ts"],"sourcesContent":["/**\n * ä½¿ç¨æ¹æ³ï¼\n * [mapFields]=\"{ id: 'user.userId', name: 'user.userName' }\"\n * key ä¸ºå¸®å©ä¸çå­æ®µï¼ value ä¸º è¡¨åä¸­çå­æ®µå\n * å¸®å©ä¸çåä¸ä¸ªå­æ®µå¯ä»¥æ å°å°è¡¨åä¸­çå¤ä¸ªå­æ®µä¸­ï¼{ ... id: 'user.userid, user.addusid'}\n * å¤å­æ®µä»¥éå·éå¼\n *\n */\n\nimport { Directive, OnInit, Optional, Self, Input, OnDestroy, AfterViewInit, Injector } from '@angular/core';\nimport { Change, ChangeType, ViewModel } from '@farris/devkit';\nimport { MessagerService } from '@farris/ui-messager';\nimport { PersonnelSelectorComponent } from '@farris/ui-personnel-selector';\n@Directive({\n    // tslint:disable-next-line:directive-selector\n    selector: '[personnel-selector-data-mapping]'\n})\nexport class PersonnelSelectorDataMappingDirective implements OnInit, AfterViewInit, OnDestroy {\n\n    @Input() mapFields: any;\n\n    constructor(\n        @Optional() private vm: ViewModel,\n        @Optional() @Self() private targetComponent: PersonnelSelectorComponent,\n        private injector: Injector\n    ) { }\n\n    ngOnInit() {\n        this.targetComponent.selectionsChange.subscribe((data: any) => {\n            const mapfields = this.mapFields;\n            if (data.data && data.data.length) {\n                this.mappingData(data.data, mapfields);\n            } else {\n                this.mappingData(null, mapfields);\n            }\n        });\n\n        this.targetComponent.inputClear.subscribe(() => {\n            const mapfields = this.mapFields;\n            this.mappingData(null, mapfields);\n        });\n\n        this.targetComponent.tagRemoved.subscribe((data) => {\n            const mapfields = this.mapFields;\n            this.tagRemovedMappingData(data.deleteIndex, mapfields);\n            // if (this.targetComponent.selections && this.targetComponent.selections.length) {\n            //     this.mappingData(this.targetComponent.selections, mapfields);\n            // } else {\n            //     this.mappingData(null, mapfields);\n            // }\n        });\n        if (!this.targetComponent.mapFields) {\n            this.targetComponent.mapFields = this.mapFields;\n        }\n    }\n\n    ngAfterViewInit(): void {\n\n    }\n\n    ngOnDestroy(): void {\n\n    }\n\n    tagRemovedMappingData(index, mapFields) {\n        if (!mapFields) {\n            return;\n        }\n        if (\n            this.targetComponent.ngControl &&\n            this.targetComponent.ngControl.formDirective &&\n            this.targetComponent.ngControl.formDirective.form &&\n            this.targetComponent.ngControl.formDirective.form.bindingData\n        ) {\n            const bindingData = this.targetComponent.ngControl.formDirective.form.bindingData;\n            if (bindingData.setValue) {\n                // å³é­åæ´æ£æµ\n                const appContext = this.vm.frameContext.appContext;\n                appContext.changeDetectionController.detach();\n\n                let helpFields = Object.keys(mapFields);\n                const idIndex = helpFields.findIndex(item => item === this.targetComponent.idField);\n                if (helpFields.includes(this.targetComponent.idField) && idIndex !== 0) {\n                    helpFields.splice(idIndex, 1);\n                    helpFields = [this.targetComponent.idField, ...helpFields];\n                }\n                const pathArr = this.getBindingPathArray();\n                const anyFieldArr = this.mapFields[helpFields[0]].split(',');\n                const formAnyData = bindingData.getValue(pathArr.concat(anyFieldArr[0]));\n\n                if (!formAnyData || formAnyData.split(',').length < 2) {\n                    helpFields.reverse();\n                }\n\n                helpFields.forEach((field: any) => {\n                    const fieldArr = this.mapFields[field].split(',');\n                    fieldArr.forEach(fa => {\n                        const path = pathArr.concat(fa.split('.'));\n                        if (this.targetComponent.ngControl.path.join() === path.join()) {\n                            return;\n                        }\n                        const resStr = bindingData.getValue(path);\n                        if (!resStr) {\n                            bindingData.clearValue(path, true, true);\n                        } else {\n                            const resArr = resStr.split(',');\n                            resArr.splice(index, 1);\n                            const result = resArr.join();\n                            if (!result) {\n                                bindingData.clearValue(path, true, true);\n                            } else {\n                                bindingData.setValue(path, result, true, true);\n                            }\n                        }\n                    });\n                });\n                // éæ°æå¼åæ´æ£æµ\n                appContext.changeDetectionController.reattach();\n            }\n        }\n    }\n    /**\n     *\n     * @param helpData æ¸ç©ºæ¶ï¼å¼ä¸ºnull\n     * @param mapFields æ ¼å¼å½¢å¦ï¼{id: \"assoField.assoField\", code: \"assoField.assoField_Code\", name: \"assoField.assoField_Name\"}\n     */\n    mappingData(helpData: any, mapFields: any) {\n        if (!mapFields) {\n            return;\n        }\n\n        // å³é­åæ´æ£æµ\n        const appContext = this.vm.frameContext.appContext;\n        appContext.changeDetectionController.detach();\n\n        let helpFields = Object.keys(mapFields);\n        const idIndex = helpFields.findIndex(item => item === this.targetComponent.idField);\n        if (helpFields.includes(this.targetComponent.idField) && idIndex !== 0) {\n            helpFields.splice(idIndex, 1);\n            helpFields = [this.targetComponent.idField, ...helpFields];\n        }\n        if (!helpData) {\n            helpFields.reverse();\n        }\n        helpFields.forEach((f: any) => {\n            // 1ãè·åå­æ®µå¼\n            // å¦æhelpDataæéä¸­å¼ï¼åè·åå¸®å©æ°æ®æºéå¯¹åºä½ å­æ®µçå¼ï¼\n            // å¦æhelpDataæ²¡æå¼ï¼æ¸ç©ºåºæ¯ï¼ï¼åè¿åä¸ä¸ªç©ºå­ç¬¦ä¸²\n            let val: any = '';\n            if (helpData) {\n                if (helpData instanceof Array) {\n                    val = helpData.map((h: any) => {\n                        return this.getValue(f, h);\n                    }).join(',');\n                } else {\n                    val = this.getValue(f, helpData);\n                }\n            }\n\n            // 2ãè®¾ç½®å­æ®µå¼\n            // å¦æhelpDataä¸å­å¨ï¼æ¸ç©ºåºæ¯ï¼ï¼è·åBindingDataéå¯¹åºå­æ®µçå¼ï¼å¦ææ¯æ°å¼ï¼åè®¾ç½®0ï¼å¶ä»è®¾ç½®ä¸ä¸æ­¥ä¸­çç©ºå­ç¬¦ä¸²ï¼\n            // å¦æhelpDataå­å¨ï¼ç´æ¥è®¾ç½®ä¸ä¸æ­¥ä¸­è·åçå¼ã\n            const pathArr = this.getBindingPathArray();\n            mapFields[f].split(',').forEach((ff: any) => {\n                if (this.targetComponent.ngControl.path.join() === ff) {\n                    return;\n                }\n                if (!helpData) {\n                    this.vm.bindingData.clearValue(pathArr.concat(ff.split('.')), true, true);\n                } else {\n                    this.vm.bindingData.setValue(pathArr.concat(ff.split('.')), val, true, true);\n                }\n            });\n        });\n\n        // éæ°æå¼åæ´æ£æµ\n        appContext.changeDetectionController.reattach();\n    }\n\n    private getValue(f: string, data: any) {\n        let val = '';\n        if (f.indexOf('.') === -1) {\n            val = data[f];\n        } else {\n            val = f.split('.').reduce((a, b) => {\n                return a[b];\n            }, data);\n        }\n\n        return val;\n    }\n\n    private getBindingPathArray(): any[] {\n        const path = this.vm.bindingPath;\n        if (path) {\n            return path.split('/').filter(n => n !== '');\n        }\n        return [];\n    }\n\n}\n","import { NgModule } from '@angular/core';\nimport { PersonnelSelectorDataMappingDirective } from './farris-extend-personnel-selector.directive';\nimport { PersonnelSelectorModule } from '@farris/ui-personnel-selector';\nimport { MessagerModule } from '@farris/ui-messager';\n@NgModule({\n    declarations: [PersonnelSelectorDataMappingDirective],\n    imports: [\n        PersonnelSelectorModule,\n        MessagerModule\n    ],\n    exports: [PersonnelSelectorDataMappingDirective]\n})\nexport class ExtendPersonnelSelectorModule { }\n"],"names":[],"mappings":"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"}
