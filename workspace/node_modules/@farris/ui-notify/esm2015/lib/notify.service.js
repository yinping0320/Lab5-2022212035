/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, ComponentFactoryResolver, Injector, ApplicationRef } from '@angular/core';
import { Subject } from 'rxjs';
import { NotifyConfig } from './notifiy.options';
import { NotifyContainerComponent } from './notify-container.component';
import { LocaleService } from '@farris/ui-locale';
/**
 * Check and return true if an object is type of string
 * @param {?} obj Analyse has to object the string type
 * @return {?} result of analysis
 */
export function isString(obj) {
    return typeof obj === 'string';
}
/**
 * Check and return true if an object is type of number
 * @param {?} obj Analyse has to object the boolean type
 * @return {?} result of analysis
 */
export function isNumber(obj) {
    return typeof obj === 'number';
}
/**
 * Check and return true if an object is type of Function
 * @param {?} obj Analyse has to object the function type
 * @return {?} result of analysis
 */
export function isFunction(obj) {
    return typeof obj === 'function';
}
export class NotifyService {
    /**
     * @param {?} cfr
     * @param {?} injector
     * @param {?} appRef
     */
    constructor(cfr, injector, appRef) {
        this.cfr = cfr;
        this.injector = injector;
        this.appRef = appRef;
        // Init the counter
        this.uniqueCounter = 0;
        this.eventSource = new Subject();
        this.events = this.eventSource.asObservable();
        this.config = new NotifyConfig();
        this.localeService = this.injector.get(LocaleService);
    }
    /**
     * @param {?} options
     * @return {?}
     */
    default(options) {
        this.show(options, 'default');
    }
    /**
     * @param {?} options
     * @return {?}
     */
    info(options) {
        this.show(options, 'info');
    }
    /**
     * @param {?} options
     * @return {?}
     */
    success(options) {
        this.show(options, 'success');
    }
    /**
     * @param {?} options
     * @return {?}
     */
    warning(options) {
        this.show(options, 'warning');
    }
    /**
     * @param {?} options
     * @return {?}
     */
    error(options) {
        this.show(options, 'danger');
    }
    /**
     * @return {?}
     */
    clearAll() {
        // this.eventSource.next(new NotifyEvent(NotifyEventType.CLEAR_ALL));
        this.notifyContainer.instance.clearAll();
    }
    /**
     * @param {?} id
     * @return {?}
     */
    clear(id) {
        // this.eventSource.next(new NotifyEvent(NotifyEventType.CLEAR, id));
        this.notifyContainer.instance.clear(id);
    }
    /**
     * @private
     * @return {?}
     */
    createContainer() {
        if (!this.notifyContainer) {
            /** @type {?} */
            const containerFac = this.cfr.resolveComponentFactory(NotifyContainerComponent);
            /** @type {?} */
            const cmpRef = containerFac.create(this.injector);
            // cmpRef.instance.id = 'Farris-Notify-Container';
            this.appRef.attachView(cmpRef.hostView);
            document.querySelector('body').appendChild(cmpRef.location.nativeElement);
            this.notifyContainer = cmpRef;
        }
    }
    /**
     * @private
     * @param {?} options
     * @param {?} type
     * @return {?}
     */
    show(options, type) {
        this.createContainer();
        /** @type {?} */
        let notifyOptions;
        if (isString(options) && options !== '' || isNumber(options)) {
            notifyOptions = (/** @type {?} */ ({
                //20191129 去除默认标题
                //title: this.localeService.getValue('notify.title'),
                msg: options.toString()
            }));
        }
        else {
            notifyOptions = (/** @type {?} */ (options));
        }
        if (!notifyOptions || !notifyOptions.title && !notifyOptions.msg) {
            throw new Error('Farris-Notify: No notify title or message specified!');
        }
        type = type || 'default';
        this.uniqueCounter++;
        /** @type {?} */
        const showClose = this._checkConfigItem(this.config, notifyOptions, 'showClose');
        /** @type {?} */
        let theme;
        if (notifyOptions.theme) {
            theme = NotifyService.THEMES.indexOf(notifyOptions.theme) > -1 ? notifyOptions.theme : this.config.theme;
        }
        else {
            theme = this.config.theme;
        }
        //判断success类型 展示时间为1.5s
        if (type === 'success') {
            if (!notifyOptions.hasOwnProperty('timeout')) {
                notifyOptions.timeout = 1500;
            }
        }
        /** @type {?} */
        const newNotifyOpts = {
            id: this.uniqueCounter,
            title: notifyOptions.title,
            msg: notifyOptions.msg,
            showClose,
            type: 'toasty-type-' + type,
            theme: 'toasty-theme-' + theme,
            onAdd: notifyOptions.onAdd && isFunction(notifyOptions.onAdd) ? notifyOptions.onAdd : null,
            onRemove: notifyOptions.onRemove && isFunction(notifyOptions.onRemove) ? notifyOptions.onRemove : null
        };
        newNotifyOpts.timeout = notifyOptions.hasOwnProperty('timeout') ? notifyOptions.timeout : this.config.timeout;
        // this.eventSource.next(new NotifyEvent(NotifyEventType.ADD, newNotifyOpts));
        this.notifyContainer.instance.config = this.config;
        this.notifyContainer.instance.position = this.config.position;
        this.notifyContainer.instance.add(newNotifyOpts);
        ((/** @type {?} */ (this.notifyContainer.instance))).empty.subscribe((/**
         * @return {?}
         */
        () => {
            this.clearDom();
        }));
        this.notifyContainer.changeDetectorRef.markForCheck();
        this.notifyContainer.changeDetectorRef.detectChanges();
        if (notifyOptions.onAdd && isFunction(notifyOptions.onAdd)) {
            notifyOptions.onAdd.call(this, newNotifyOpts);
        }
    }
    /**
     * @private
     * @param {?} config
     * @param {?} options
     * @param {?} property
     * @return {?}
     */
    _checkConfigItem(config, options, property) {
        if (options[property] === false) {
            return false;
        }
        else if (!options[property]) {
            return config[property];
        }
        else {
            return true;
        }
    }
    /**
     * @private
     * @return {?}
     */
    clearDom() {
        if (this.notifyContainer) {
            /** @type {?} */
            const el = this.notifyContainer.location.nativeElement;
            if (el.parentNode) {
                el.parentNode.removeChild(el);
            }
            this.notifyContainer.destroy();
            this.notifyContainer = undefined;
        }
    }
}
NotifyService.THEMES = ['default', 'material', 'bootstrap'];
NotifyService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
NotifyService.ctorParameters = () => [
    { type: ComponentFactoryResolver },
    { type: Injector },
    { type: ApplicationRef }
];
if (false) {
    /** @type {?} */
    NotifyService.THEMES;
    /** @type {?} */
    NotifyService.prototype.uniqueCounter;
    /**
     * @type {?}
     * @private
     */
    NotifyService.prototype.eventSource;
    /** @type {?} */
    NotifyService.prototype.events;
    /** @type {?} */
    NotifyService.prototype.notifyContainer;
    /** @type {?} */
    NotifyService.prototype.config;
    /** @type {?} */
    NotifyService.prototype.localeService;
    /**
     * @type {?}
     * @private
     */
    NotifyService.prototype.cfr;
    /**
     * @type {?}
     * @private
     */
    NotifyService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    NotifyService.prototype.appRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZ5LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLW5vdGlmeS8iLCJzb3VyY2VzIjpbImxpYi9ub3RpZnkuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBZ0Isd0JBQXdCLEVBQUUsUUFBUSxFQUFFLGNBQWMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RyxPQUFPLEVBQUUsT0FBTyxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBOEIsWUFBWSxFQUFjLE1BQU0sbUJBQW1CLENBQUM7QUFDekYsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDeEUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDOzs7Ozs7QUFPbEQsTUFBTSxVQUFVLFFBQVEsQ0FBQyxHQUFRO0lBQzdCLE9BQU8sT0FBTyxHQUFHLEtBQUssUUFBUSxDQUFDO0FBQ25DLENBQUM7Ozs7OztBQU9ELE1BQU0sVUFBVSxRQUFRLENBQUMsR0FBUTtJQUM3QixPQUFPLE9BQU8sR0FBRyxLQUFLLFFBQVEsQ0FBQztBQUNuQyxDQUFDOzs7Ozs7QUFPRCxNQUFNLFVBQVUsVUFBVSxDQUFDLEdBQVE7SUFDL0IsT0FBTyxPQUFPLEdBQUcsS0FBSyxVQUFVLENBQUM7QUFDckMsQ0FBQztBQUlELE1BQU0sT0FBTyxhQUFhOzs7Ozs7SUFjdEIsWUFBb0IsR0FBNkIsRUFDN0IsUUFBa0IsRUFBVSxNQUFzQjtRQURsRCxRQUFHLEdBQUgsR0FBRyxDQUEwQjtRQUM3QixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBZ0I7O1FBVnRFLGtCQUFhLEdBQUcsQ0FBQyxDQUFDO1FBRVYsZ0JBQVcsR0FBeUIsSUFBSSxPQUFPLEVBQWUsQ0FBQztRQUN2RSxXQUFNLEdBQTRCLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxFQUFFLENBQUM7UUFJbEUsV0FBTSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFJWixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzFELENBQUM7Ozs7O0lBRWIsT0FBTyxDQUFDLE9BQW9DO1FBQ3hDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7Ozs7O0lBRUQsSUFBSSxDQUFDLE9BQW9DO1FBQ3JDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQy9CLENBQUM7Ozs7O0lBRUQsT0FBTyxDQUFDLE9BQW9DO1FBQ3hDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7Ozs7O0lBRUQsT0FBTyxDQUFDLE9BQW9DO1FBQ3hDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7Ozs7O0lBRUQsS0FBSyxDQUFDLE9BQW9DO1FBQ3RDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7Ozs7SUFFRCxRQUFRO1FBQ0oscUVBQXFFO1FBQ3JFLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzdDLENBQUM7Ozs7O0lBRUQsS0FBSyxDQUFDLEVBQVU7UUFDWixxRUFBcUU7UUFDckUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQzVDLENBQUM7Ozs7O0lBRU8sZUFBZTtRQUNuQixJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRTs7a0JBQ2pCLFlBQVksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLHVCQUF1QixDQUFDLHdCQUF3QixDQUFDOztrQkFDekUsTUFBTSxHQUFHLFlBQVksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztZQUNqRCxrREFBa0Q7WUFDbEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3hDLFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDMUUsSUFBSSxDQUFDLGVBQWUsR0FBRyxNQUFNLENBQUM7U0FDakM7SUFFTCxDQUFDOzs7Ozs7O0lBRU8sSUFBSSxDQUFDLE9BQXdDLEVBQUUsSUFBWTtRQUUvRCxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7O1lBRW5CLGFBQTRCO1FBQ2hDLElBQUksUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLE9BQU8sS0FBSyxFQUFFLElBQUksUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQzFELGFBQWEsR0FBRyxtQkFBQTs7O2dCQUdaLEdBQUcsRUFBRSxPQUFPLENBQUMsUUFBUSxFQUFFO2FBQzFCLEVBQWlCLENBQUM7U0FDdEI7YUFBTTtZQUNILGFBQWEsR0FBRyxtQkFBQSxPQUFPLEVBQWlCLENBQUM7U0FDNUM7UUFFRCxJQUFJLENBQUMsYUFBYSxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUU7WUFDOUQsTUFBTSxJQUFJLEtBQUssQ0FBQyxzREFBc0QsQ0FBQyxDQUFDO1NBQzNFO1FBRUQsSUFBSSxHQUFHLElBQUksSUFBSSxTQUFTLENBQUM7UUFHekIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDOztjQUVmLFNBQVMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxhQUFhLEVBQUUsV0FBVyxDQUFDOztZQUU1RSxLQUFhO1FBQ2pCLElBQUksYUFBYSxDQUFDLEtBQUssRUFBRTtZQUNyQixLQUFLLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztTQUM1RzthQUFNO1lBQ0gsS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO1NBQzdCO1FBQ0QsdUJBQXVCO1FBQ3ZCLElBQUcsSUFBSSxLQUFLLFNBQVMsRUFBQztZQUNsQixJQUFHLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsRUFBQztnQkFDeEMsYUFBYSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7YUFDaEM7U0FDSjs7Y0FFSyxhQUFhLEdBQWU7WUFDOUIsRUFBRSxFQUFFLElBQUksQ0FBQyxhQUFhO1lBQ3RCLEtBQUssRUFBRSxhQUFhLENBQUMsS0FBSztZQUMxQixHQUFHLEVBQUUsYUFBYSxDQUFDLEdBQUc7WUFDdEIsU0FBUztZQUNULElBQUksRUFBRSxjQUFjLEdBQUcsSUFBSTtZQUMzQixLQUFLLEVBQUUsZUFBZSxHQUFHLEtBQUs7WUFDOUIsS0FBSyxFQUFNLGFBQWEsQ0FBQyxLQUFLLElBQUksVUFBVSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSTtZQUM5RixRQUFRLEVBQUcsYUFBYSxDQUFDLFFBQVEsSUFBSSxVQUFVLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJO1NBQzFHO1FBQ0QsYUFBYSxDQUFDLE9BQU8sR0FBRyxhQUFhLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQztRQUU5Ryw4RUFBOEU7UUFDOUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDbkQsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO1FBQzlELElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUVqRCxDQUFDLG1CQUFBLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxFQUE0QixDQUFDLENBQUMsS0FBSyxDQUFDLFNBQVM7OztRQUFDLEdBQUcsRUFBRTtZQUM3RSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDcEIsQ0FBQyxFQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsZUFBZSxDQUFDLGlCQUFpQixDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3RELElBQUksQ0FBQyxlQUFlLENBQUMsaUJBQWlCLENBQUMsYUFBYSxFQUFFLENBQUM7UUFFdkQsSUFBSSxhQUFhLENBQUMsS0FBSyxJQUFJLFVBQVUsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDeEQsYUFBYSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1NBQ2pEO0lBRUwsQ0FBQzs7Ozs7Ozs7SUFFTyxnQkFBZ0IsQ0FBQyxNQUFXLEVBQUUsT0FBWSxFQUFFLFFBQWdCO1FBQ2hFLElBQUksT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEtBQUssRUFBRTtZQUM3QixPQUFPLEtBQUssQ0FBQztTQUNoQjthQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDM0IsT0FBTyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDM0I7YUFBTTtZQUNILE9BQU8sSUFBSSxDQUFDO1NBQ2Y7SUFDTCxDQUFDOzs7OztJQUVPLFFBQVE7UUFDWixJQUFJLElBQUksQ0FBQyxlQUFlLEVBQUU7O2tCQUNoQixFQUFFLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsYUFBYTtZQUN0RCxJQUFJLEVBQUUsQ0FBQyxVQUFVLEVBQUU7Z0JBQ2YsRUFBRSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDakM7WUFFRCxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQy9CLElBQUksQ0FBQyxlQUFlLEdBQUcsU0FBUyxDQUFDO1NBQ3BDO0lBQ0wsQ0FBQzs7QUFwSk0sb0JBQU0sR0FBa0IsQ0FBQyxTQUFTLEVBQUUsVUFBVSxFQUFFLFdBQVcsQ0FBQyxDQUFDOztZQUh2RSxVQUFVOzs7O1lBbEN3Qix3QkFBd0I7WUFBRSxRQUFRO1lBQUUsY0FBYzs7OztJQXFDakYscUJBQW9FOztJQUdwRSxzQ0FBa0I7Ozs7O0lBRWxCLG9DQUF1RTs7SUFDdkUsK0JBQWtFOztJQUdsRSx3Q0FBbUM7O0lBQ25DLCtCQUE0Qjs7SUFDNUIsc0NBQTZCOzs7OztJQUNqQiw0QkFBcUM7Ozs7O0lBQ3JDLGlDQUEwQjs7Ozs7SUFBRSwrQkFBOEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBDb21wb25lbnRSZWYsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgSW5qZWN0b3IsIEFwcGxpY2F0aW9uUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgTm90aWZ5RXZlbnQsIE5vdGlmeU9wdGlvbnMsIE5vdGlmeUNvbmZpZywgTm90aWZ5RGF0YSB9IGZyb20gJy4vbm90aWZpeS5vcHRpb25zJztcclxuaW1wb3J0IHsgTm90aWZ5Q29udGFpbmVyQ29tcG9uZW50IH0gZnJvbSAnLi9ub3RpZnktY29udGFpbmVyLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IExvY2FsZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWxvY2FsZSc7XHJcblxyXG4vKipcclxuICogQ2hlY2sgYW5kIHJldHVybiB0cnVlIGlmIGFuIG9iamVjdCBpcyB0eXBlIG9mIHN0cmluZ1xyXG4gKiBAcGFyYW0gb2JqIEFuYWx5c2UgaGFzIHRvIG9iamVjdCB0aGUgc3RyaW5nIHR5cGVcclxuICogQHJldHVybiByZXN1bHQgb2YgYW5hbHlzaXNcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBpc1N0cmluZyhvYmo6IGFueSk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdzdHJpbmcnO1xyXG59XHJcblxyXG4vKipcclxuICogQ2hlY2sgYW5kIHJldHVybiB0cnVlIGlmIGFuIG9iamVjdCBpcyB0eXBlIG9mIG51bWJlclxyXG4gKiBAcGFyYW0gb2JqIEFuYWx5c2UgaGFzIHRvIG9iamVjdCB0aGUgYm9vbGVhbiB0eXBlXHJcbiAqIEByZXR1cm4gcmVzdWx0IG9mIGFuYWx5c2lzXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gaXNOdW1iZXIob2JqOiBhbnkpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnbnVtYmVyJztcclxufVxyXG5cclxuLyoqXHJcbiAqIENoZWNrIGFuZCByZXR1cm4gdHJ1ZSBpZiBhbiBvYmplY3QgaXMgdHlwZSBvZiBGdW5jdGlvblxyXG4gKiBAcGFyYW0gb2JqIEFuYWx5c2UgaGFzIHRvIG9iamVjdCB0aGUgZnVuY3Rpb24gdHlwZVxyXG4gKiBAcmV0dXJuIHJlc3VsdCBvZiBhbmFseXNpc1xyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGlzRnVuY3Rpb24ob2JqOiBhbnkpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nO1xyXG59XHJcblxyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgTm90aWZ5U2VydmljZSB7XHJcblxyXG4gICAgc3RhdGljIFRIRU1FUzogQXJyYXk8c3RyaW5nPiA9IFsnZGVmYXVsdCcsICdtYXRlcmlhbCcsICdib290c3RyYXAnXTtcclxuXHJcbiAgICAvLyBJbml0IHRoZSBjb3VudGVyXHJcbiAgICB1bmlxdWVDb3VudGVyID0gMDtcclxuXHJcbiAgICBwcml2YXRlIGV2ZW50U291cmNlOiBTdWJqZWN0PE5vdGlmeUV2ZW50PiA9IG5ldyBTdWJqZWN0PE5vdGlmeUV2ZW50PigpO1xyXG4gICAgZXZlbnRzOiBPYnNlcnZhYmxlPE5vdGlmeUV2ZW50PiA9IHRoaXMuZXZlbnRTb3VyY2UuYXNPYnNlcnZhYmxlKCk7XHJcblxyXG5cclxuICAgIG5vdGlmeUNvbnRhaW5lcjogQ29tcG9uZW50UmVmPGFueT47XHJcbiAgICBjb25maWcgPSBuZXcgTm90aWZ5Q29uZmlnKCk7XHJcbiAgICBsb2NhbGVTZXJ2aWNlOiBMb2NhbGVTZXJ2aWNlO1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBjZnI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIGFwcFJlZjogQXBwbGljYXRpb25SZWYpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZVNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChMb2NhbGVTZXJ2aWNlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICBkZWZhdWx0KG9wdGlvbnM6IE5vdGlmeU9wdGlvbnN8c3RyaW5nfG51bWJlcik6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuc2hvdyhvcHRpb25zLCAnZGVmYXVsdCcpO1xyXG4gICAgfVxyXG5cclxuICAgIGluZm8ob3B0aW9uczogTm90aWZ5T3B0aW9uc3xzdHJpbmd8bnVtYmVyKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5zaG93KG9wdGlvbnMsICdpbmZvJyk7XHJcbiAgICB9XHJcblxyXG4gICAgc3VjY2VzcyhvcHRpb25zOiBOb3RpZnlPcHRpb25zfHN0cmluZ3xudW1iZXIpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnNob3cob3B0aW9ucywgJ3N1Y2Nlc3MnKTtcclxuICAgIH1cclxuXHJcbiAgICB3YXJuaW5nKG9wdGlvbnM6IE5vdGlmeU9wdGlvbnN8c3RyaW5nfG51bWJlcik6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuc2hvdyhvcHRpb25zLCAnd2FybmluZycpO1xyXG4gICAgfVxyXG5cclxuICAgIGVycm9yKG9wdGlvbnM6IE5vdGlmeU9wdGlvbnN8c3RyaW5nfG51bWJlcik6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuc2hvdyhvcHRpb25zLCAnZGFuZ2VyJyk7XHJcbiAgICB9XHJcblxyXG4gICAgY2xlYXJBbGwoKSB7XHJcbiAgICAgICAgLy8gdGhpcy5ldmVudFNvdXJjZS5uZXh0KG5ldyBOb3RpZnlFdmVudChOb3RpZnlFdmVudFR5cGUuQ0xFQVJfQUxMKSk7XHJcbiAgICAgICAgdGhpcy5ub3RpZnlDb250YWluZXIuaW5zdGFuY2UuY2xlYXJBbGwoKTtcclxuICAgIH1cclxuXHJcbiAgICBjbGVhcihpZDogbnVtYmVyKSB7XHJcbiAgICAgICAgLy8gdGhpcy5ldmVudFNvdXJjZS5uZXh0KG5ldyBOb3RpZnlFdmVudChOb3RpZnlFdmVudFR5cGUuQ0xFQVIsIGlkKSk7XHJcbiAgICAgICAgdGhpcy5ub3RpZnlDb250YWluZXIuaW5zdGFuY2UuY2xlYXIoaWQpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY3JlYXRlQ29udGFpbmVyKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5ub3RpZnlDb250YWluZXIpIHtcclxuICAgICAgICAgICAgY29uc3QgY29udGFpbmVyRmFjID0gdGhpcy5jZnIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoTm90aWZ5Q29udGFpbmVyQ29tcG9uZW50KTtcclxuICAgICAgICAgICAgY29uc3QgY21wUmVmID0gY29udGFpbmVyRmFjLmNyZWF0ZSh0aGlzLmluamVjdG9yKTtcclxuICAgICAgICAgICAgLy8gY21wUmVmLmluc3RhbmNlLmlkID0gJ0ZhcnJpcy1Ob3RpZnktQ29udGFpbmVyJztcclxuICAgICAgICAgICAgdGhpcy5hcHBSZWYuYXR0YWNoVmlldyhjbXBSZWYuaG9zdFZpZXcpO1xyXG4gICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdib2R5JykuYXBwZW5kQ2hpbGQoY21wUmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgICAgICB0aGlzLm5vdGlmeUNvbnRhaW5lciA9IGNtcFJlZjtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2hvdyhvcHRpb25zOiBOb3RpZnlPcHRpb25zIHwgc3RyaW5nIHwgbnVtYmVyLCB0eXBlOiBzdHJpbmcpIHtcclxuXHJcbiAgICAgICAgdGhpcy5jcmVhdGVDb250YWluZXIoKTtcclxuXHJcbiAgICAgICAgbGV0IG5vdGlmeU9wdGlvbnM6IE5vdGlmeU9wdGlvbnM7XHJcbiAgICAgICAgaWYgKGlzU3RyaW5nKG9wdGlvbnMpICYmIG9wdGlvbnMgIT09ICcnIHx8IGlzTnVtYmVyKG9wdGlvbnMpKSB7XHJcbiAgICAgICAgICAgIG5vdGlmeU9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICAvLzIwMTkxMTI5IOWOu+mZpOm7mOiupOagh+mimFxyXG4gICAgICAgICAgICAgICAgLy90aXRsZTogdGhpcy5sb2NhbGVTZXJ2aWNlLmdldFZhbHVlKCdub3RpZnkudGl0bGUnKSxcclxuICAgICAgICAgICAgICAgIG1zZzogb3B0aW9ucy50b1N0cmluZygpXHJcbiAgICAgICAgICAgIH0gYXMgTm90aWZ5T3B0aW9ucztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBub3RpZnlPcHRpb25zID0gb3B0aW9ucyBhcyBOb3RpZnlPcHRpb25zO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCFub3RpZnlPcHRpb25zIHx8ICFub3RpZnlPcHRpb25zLnRpdGxlICYmICFub3RpZnlPcHRpb25zLm1zZykge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhcnJpcy1Ob3RpZnk6IE5vIG5vdGlmeSB0aXRsZSBvciBtZXNzYWdlIHNwZWNpZmllZCEnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHR5cGUgPSB0eXBlIHx8ICdkZWZhdWx0JztcclxuICAgICAgICBcclxuXHJcbiAgICAgICAgdGhpcy51bmlxdWVDb3VudGVyKys7XHJcblxyXG4gICAgICAgIGNvbnN0IHNob3dDbG9zZSA9IHRoaXMuX2NoZWNrQ29uZmlnSXRlbSh0aGlzLmNvbmZpZywgbm90aWZ5T3B0aW9ucywgJ3Nob3dDbG9zZScpO1xyXG5cclxuICAgICAgICBsZXQgdGhlbWU6IHN0cmluZztcclxuICAgICAgICBpZiAobm90aWZ5T3B0aW9ucy50aGVtZSkge1xyXG4gICAgICAgICAgICB0aGVtZSA9IE5vdGlmeVNlcnZpY2UuVEhFTUVTLmluZGV4T2Yobm90aWZ5T3B0aW9ucy50aGVtZSkgPiAtMSA/IG5vdGlmeU9wdGlvbnMudGhlbWUgOiB0aGlzLmNvbmZpZy50aGVtZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGVtZSA9IHRoaXMuY29uZmlnLnRoZW1lO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvL+WIpOaWrXN1Y2Nlc3Pnsbvlnosg5bGV56S65pe26Ze05Li6MS41c1xyXG4gICAgICAgIGlmKHR5cGUgPT09ICdzdWNjZXNzJyl7XHJcbiAgICAgICAgICAgIGlmKCFub3RpZnlPcHRpb25zLmhhc093blByb3BlcnR5KCd0aW1lb3V0Jykpe1xyXG4gICAgICAgICAgICAgICAgbm90aWZ5T3B0aW9ucy50aW1lb3V0ID0gMTUwMDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgbmV3Tm90aWZ5T3B0czogTm90aWZ5RGF0YSA9IHtcclxuICAgICAgICAgICAgaWQ6IHRoaXMudW5pcXVlQ291bnRlcixcclxuICAgICAgICAgICAgdGl0bGU6IG5vdGlmeU9wdGlvbnMudGl0bGUsXHJcbiAgICAgICAgICAgIG1zZzogbm90aWZ5T3B0aW9ucy5tc2csXHJcbiAgICAgICAgICAgIHNob3dDbG9zZSxcclxuICAgICAgICAgICAgdHlwZTogJ3RvYXN0eS10eXBlLScgKyB0eXBlLFxyXG4gICAgICAgICAgICB0aGVtZTogJ3RvYXN0eS10aGVtZS0nICsgdGhlbWUsXHJcbiAgICAgICAgICAgIG9uQWRkICAgIDogbm90aWZ5T3B0aW9ucy5vbkFkZCAmJiBpc0Z1bmN0aW9uKG5vdGlmeU9wdGlvbnMub25BZGQpID8gbm90aWZ5T3B0aW9ucy5vbkFkZCA6IG51bGwsXHJcbiAgICAgICAgICAgIG9uUmVtb3ZlIDogbm90aWZ5T3B0aW9ucy5vblJlbW92ZSAmJiBpc0Z1bmN0aW9uKG5vdGlmeU9wdGlvbnMub25SZW1vdmUpID8gbm90aWZ5T3B0aW9ucy5vblJlbW92ZSA6IG51bGxcclxuICAgICAgICB9O1xyXG4gICAgICAgIG5ld05vdGlmeU9wdHMudGltZW91dCA9IG5vdGlmeU9wdGlvbnMuaGFzT3duUHJvcGVydHkoJ3RpbWVvdXQnKSA/IG5vdGlmeU9wdGlvbnMudGltZW91dCA6IHRoaXMuY29uZmlnLnRpbWVvdXQ7XHJcblxyXG4gICAgICAgIC8vIHRoaXMuZXZlbnRTb3VyY2UubmV4dChuZXcgTm90aWZ5RXZlbnQoTm90aWZ5RXZlbnRUeXBlLkFERCwgbmV3Tm90aWZ5T3B0cykpO1xyXG4gICAgICAgIHRoaXMubm90aWZ5Q29udGFpbmVyLmluc3RhbmNlLmNvbmZpZyA9IHRoaXMuY29uZmlnO1xyXG4gICAgICAgIHRoaXMubm90aWZ5Q29udGFpbmVyLmluc3RhbmNlLnBvc2l0aW9uID0gdGhpcy5jb25maWcucG9zaXRpb247XHJcbiAgICAgICAgdGhpcy5ub3RpZnlDb250YWluZXIuaW5zdGFuY2UuYWRkKG5ld05vdGlmeU9wdHMpO1xyXG5cclxuICAgICAgICAodGhpcy5ub3RpZnlDb250YWluZXIuaW5zdGFuY2UgYXMgTm90aWZ5Q29udGFpbmVyQ29tcG9uZW50KS5lbXB0eS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmNsZWFyRG9tKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMubm90aWZ5Q29udGFpbmVyLmNoYW5nZURldGVjdG9yUmVmLm1hcmtGb3JDaGVjaygpO1xyXG4gICAgICAgIHRoaXMubm90aWZ5Q29udGFpbmVyLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcclxuXHJcbiAgICAgICAgaWYgKG5vdGlmeU9wdGlvbnMub25BZGQgJiYgaXNGdW5jdGlvbihub3RpZnlPcHRpb25zLm9uQWRkKSkge1xyXG4gICAgICAgICAgICBub3RpZnlPcHRpb25zLm9uQWRkLmNhbGwodGhpcywgbmV3Tm90aWZ5T3B0cyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9jaGVja0NvbmZpZ0l0ZW0oY29uZmlnOiBhbnksIG9wdGlvbnM6IGFueSwgcHJvcGVydHk6IHN0cmluZykge1xyXG4gICAgICAgIGlmIChvcHRpb25zW3Byb3BlcnR5XSA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoIW9wdGlvbnNbcHJvcGVydHldKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjb25maWdbcHJvcGVydHldO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNsZWFyRG9tKCkge1xyXG4gICAgICAgIGlmICh0aGlzLm5vdGlmeUNvbnRhaW5lcikge1xyXG4gICAgICAgICAgICBjb25zdCBlbCA9IHRoaXMubm90aWZ5Q29udGFpbmVyLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgICAgIGlmIChlbC5wYXJlbnROb2RlKSB7XHJcbiAgICAgICAgICAgICAgICBlbC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5ub3RpZnlDb250YWluZXIuZGVzdHJveSgpO1xyXG4gICAgICAgICAgICB0aGlzLm5vdGlmeUNvbnRhaW5lciA9IHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbi8vIGV4cG9ydCBmdW5jdGlvbiBub3RpZnlTZXJ2aWNlRmFjdG9yeShjb25maWc6IE5vdGlmeUNvbmZpZyk6IE5vdGlmeVNlcnZpY2UgIHtcclxuLy8gICAgIHJldHVybiBuZXcgTm90aWZ5U2VydmljZShjb25maWcsICk7XHJcbi8vIH1cclxuIl19