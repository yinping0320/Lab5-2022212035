/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, HostListener, Input, Injector, ElementRef, Renderer2, Optional } from '@angular/core';
import { of } from 'rxjs';
import { FarrisContextMenuService } from './context-menu.service';
export class FarrisContextMenuDirective {
    /**
     * @param {?} ctxMenuSer
     * @param {?} injector
     * @param {?} elRef
     * @param {?} render
     */
    constructor(ctxMenuSer, injector, elRef, render) {
        this.ctxMenuSer = ctxMenuSer;
        this.injector = injector;
        this.elRef = elRef;
        this.render = render;
        this.disabled = false;
        this.highlight = true;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.id = this.contextMenuId();
        if (!this.beforeShowContextMenu) {
            this.beforeShowContextMenu = (/**
             * @return {?}
             */
            () => of(true));
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onContextMenu(event) {
        if (!this.disabled) {
            /** @type {?} */
            let contextMenuDom = null;
            if (this.activeDomName) {
                contextMenuDom = ((/** @type {?} */ (event.target))).closest(this.activeDomName);
                if (contextMenuDom) {
                    this.render.addClass(contextMenuDom, 'f-context-menu-active');
                }
                else {
                    return;
                }
            }
            /** @type {?} */
            const beforeShow$ = this.beforeShowContextMenu({ event, contextMenuDom });
            if (beforeShow$ && beforeShow$.subscribe) {
                beforeShow$.subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                    /** @type {?} */
                    const ctxData = this.getContextData(e);
                    this.removeSurplusMenus();
                    if (ctxData.show) {
                        document.body.click();
                        // if (!this.ctxMenuSer) {
                        //     const cfr = this.injector.get(ComponentFactoryResolver);
                        //     this.ctxMenuSer = new FarrisContextMenuService(cfr, this.injector);
                        // }
                        this.ctxMenuSer.show({
                            menuItems: this.getViewMenuItems(ctxData.data),
                            event,
                            id: this.id,
                            activeDom: contextMenuDom,
                            context: ctxData.data,
                            menuClass: this.menuClass,
                            target: this.elRef.nativeElement,
                            activeWidth: e['focusTargetWidth'],
                            highlight: this.highlight
                        });
                        event.preventDefault();
                        event.stopPropagation();
                    }
                }));
            }
        }
    }
    // 删除第3层及以后的菜单，仅支持两层菜单展示
    /**
     * @private
     * @return {?}
     */
    removeSurplusMenus() {
        if (this.menuItems && this.menuItems.length) {
            this.menuItems.forEach((/**
             * @param {?} m
             * @return {?}
             */
            (m) => {
                if (m !== '-' && m.children && m.children.length) {
                    m.children.forEach((/**
                     * @param {?} cm
                     * @return {?}
                     */
                    cm => {
                        if (cm !== '-') {
                            cm.children = [];
                        }
                    }));
                }
            }));
        }
    }
    /**
     * @private
     * @return {?}
     */
    contextMenuId() {
        /** @type {?} */
        const id = this.elRef.nativeElement.id;
        if (id) {
            return `${id}-context-menu`;
        }
        else {
            return 'context-menu_' + new Date().getTime();
        }
    }
    /**
     * @private
     * @param {?} e
     * @return {?}
     */
    getContextData(e) {
        if (typeof e === 'boolean') {
            return { show: e, data: null };
        }
        return e;
    }
    /**
     * @private
     * @param {?} context
     * @return {?}
     */
    getViewMenuItems(context) {
        if (this.menuItems && this.menuItems.length) {
            return this.checkMenuItems(this.menuItems, context);
        }
        return [];
    }
    /**
     * @private
     * @param {?} menuItems
     * @param {?} context
     * @return {?}
     */
    checkMenuItems(menuItems, context) {
        /** @type {?} */
        const menus = menuItems.map((/**
         * @param {?} m
         * @return {?}
         */
        (m) => {
            if (typeof m === 'string') {
                return m;
            }
            else {
                /** @type {?} */
                const n = this.checkVisibleAndDisable(m, context);
                if (n.children) {
                    n.children = this.checkMenuItems(n.children, context);
                }
                return n;
            }
        })).filter((/**
         * @param {?} n
         * @return {?}
         */
        n => {
            return n === '-' || n.visible;
        }));
        if (menus && menus.length) {
            if (menus[0] === '-') {
                menus.shift(0);
            }
            if (menus[menus.length - 1] === '-') {
                menus.pop(0);
            }
        }
        return menus;
    }
    /**
     * @private
     * @param {?} m
     * @param {?} context
     * @return {?}
     */
    checkVisibleAndDisable(m, context) {
        /** @type {?} */
        const n = Object.assign({}, m);
        if (!n.hasOwnProperty('visible')) {
            n.visible = true;
        }
        else {
            if (typeof n.visible === 'function') {
                n.visible = n.visible(context);
            }
        }
        if (!n.hasOwnProperty('disable')) {
            n.disable = false;
        }
        else {
            if (typeof n.disable === 'function') {
                n.disable = n.disable(context);
            }
        }
        return n;
    }
}
FarrisContextMenuDirective.decorators = [
    { type: Directive, args: [{
                selector: '[farris-context-menus]',
            },] }
];
/** @nocollapse */
FarrisContextMenuDirective.ctorParameters = () => [
    { type: FarrisContextMenuService, decorators: [{ type: Optional }] },
    { type: Injector },
    { type: ElementRef },
    { type: Renderer2 }
];
FarrisContextMenuDirective.propDecorators = {
    menuItems: [{ type: Input, args: ['farris-context-menus',] }],
    menuClass: [{ type: Input }],
    disabled: [{ type: Input }],
    context: [{ type: Input }],
    beforeShowContextMenu: [{ type: Input }],
    activeDomName: [{ type: Input }],
    highlight: [{ type: Input }],
    onContextMenu: [{ type: HostListener, args: ['contextmenu', ['$event'],] }]
};
if (false) {
    /** @type {?} */
    FarrisContextMenuDirective.prototype.menuItems;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.menuClass;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.disabled;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.context;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.beforeShowContextMenu;
    /**
     * 触发右键菜单实际DOM标签名称
     * @type {?}
     */
    FarrisContextMenuDirective.prototype.activeDomName;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.highlight;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.id;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuDirective.prototype.ctxMenuSer;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuDirective.prototype.elRef;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuDirective.prototype.render;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC1tZW51LmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktY29udGV4dC1tZW51LyIsInNvdXJjZXMiOlsibGliL2NvbnRleHQtbWVudS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFVLFNBQVMsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbEgsT0FBTyxFQUFFLEVBQUUsRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUN0QyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQU1sRSxNQUFNLE9BQU8sMEJBQTBCOzs7Ozs7O0lBV25DLFlBQWdDLFVBQW9DLEVBQ2hELFFBQWtCLEVBQVUsS0FBaUIsRUFBVSxNQUFpQjtRQUQ1RCxlQUFVLEdBQVYsVUFBVSxDQUEwQjtRQUNoRCxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBWTtRQUFVLFdBQU0sR0FBTixNQUFNLENBQVc7UUFUbkYsYUFBUSxHQUFHLEtBQUssQ0FBQztRQUtqQixjQUFTLEdBQUcsSUFBSSxDQUFDO0lBS2QsQ0FBQzs7OztJQUViLFFBQVE7UUFDSixJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUUvQixJQUFJLENBQUMsSUFBSSxDQUFDLHFCQUFxQixFQUFFO1lBQzdCLElBQUksQ0FBQyxxQkFBcUI7OztZQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQSxDQUFDO1NBQy9DO0lBQ0wsQ0FBQzs7Ozs7SUFHTSxhQUFhLENBQUMsS0FBaUI7UUFDbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7O2dCQUNaLGNBQWMsR0FBRyxJQUFJO1lBQ3pCLElBQUksSUFBSSxDQUFDLGFBQWEsRUFB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QXNCOztJQUN0QiwyREFBd0U7Ozs7O0lBRXhFLG1EQUErQjs7SUFDL0IsK0NBQTBCOztJQUMxQix3Q0FBVzs7Ozs7SUFFQyxnREFBd0Q7Ozs7O0lBQ3hELDhDQUEwQjs7Ozs7SUFBRSwyQ0FBeUI7Ozs7O0lBQUUsNENBQXlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBIb3N0TGlzdGVuZXIsIElucHV0LCBJbmplY3RvciwgRWxlbWVudFJlZiwgT25Jbml0LCBSZW5kZXJlcjIsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IG9mLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IEZhcnJpc0NvbnRleHRNZW51U2VydmljZSB9IGZyb20gJy4vY29udGV4dC1tZW51LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBCZWZvcmVTaG93TWVudSwgQ29udGV4dE1lbnVJdGVtIH0gZnJvbSAnLi9tZW51LWl0ZW0uaW50ZXJmYWNlJztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gICAgc2VsZWN0b3I6ICdbZmFycmlzLWNvbnRleHQtbWVudXNdJyxcclxufSlcclxuZXhwb3J0IGNsYXNzIEZhcnJpc0NvbnRleHRNZW51RGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0IHtcclxuICAgIEBJbnB1dCgnZmFycmlzLWNvbnRleHQtbWVudXMnKSBtZW51SXRlbXM6IENvbnRleHRNZW51SXRlbVtdO1xyXG4gICAgQElucHV0KCkgbWVudUNsYXNzOiBzdHJpbmc7XHJcbiAgICBASW5wdXQoKSBkaXNhYmxlZCA9IGZhbHNlO1xyXG4gICAgQElucHV0KCkgY29udGV4dDogYW55O1xyXG4gICAgQElucHV0KCkgYmVmb3JlU2hvd0NvbnRleHRNZW51OiAoZT86IGFueSkgPT4gT2JzZXJ2YWJsZTxCZWZvcmVTaG93TWVudT47XHJcbiAgICAvKiog6Kem5Y+R5Y+z6ZSu6I+c5Y2V5a6e6ZmFRE9N5qCH562+5ZCN56ewICovXHJcbiAgICBASW5wdXQoKSBhY3RpdmVEb21OYW1lOiBzdHJpbmc7XHJcbiAgICBASW5wdXQoKSBoaWdobGlnaHQgPSB0cnVlO1xyXG4gICAgaWQ6IHN0cmluZztcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihAT3B0aW9uYWwoKSBwcml2YXRlIGN0eE1lbnVTZXI6IEZhcnJpc0NvbnRleHRNZW51U2VydmljZSxcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIGVsUmVmOiBFbGVtZW50UmVmLCBwcml2YXRlIHJlbmRlcjogUmVuZGVyZXIyKSB7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKSB7XHJcbiAgICAgICAgdGhpcy5pZCA9IHRoaXMuY29udGV4dE1lbnVJZCgpO1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMuYmVmb3JlU2hvd0NvbnRleHRNZW51KSB7XHJcbiAgICAgICAgICAgIHRoaXMuYmVmb3JlU2hvd0NvbnRleHRNZW51ID0gKCkgPT4gb2YodHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIEBIb3N0TGlzdGVuZXIoJ2NvbnRleHRtZW51JywgWyckZXZlbnQnXSlcclxuICAgIHB1YmxpYyBvbkNvbnRleHRNZW51KGV2ZW50OiBNb3VzZUV2ZW50KTogdm9pZCB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmRpc2FibGVkKSB7XHJcbiAgICAgICAgICAgIGxldCBjb250ZXh0TWVudURvbSA9IG51bGw7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZURvbU5hbWUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRleHRNZW51RG9tID0gKGV2ZW50LnRhcmdldCBhcyBhbnkpLmNsb3Nlc3QodGhpcy5hY3RpdmVEb21OYW1lKTtcclxuICAgICAgICAgICAgICAgIGlmIChjb250ZXh0TWVudURvbSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyLmFkZENsYXNzKGNvbnRleHRNZW51RG9tLCAnZi1jb250ZXh0LW1lbnUtYWN0aXZlJyk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgYmVmb3JlU2hvdyQgPSB0aGlzLmJlZm9yZVNob3dDb250ZXh0TWVudSh7IGV2ZW50LCBjb250ZXh0TWVudURvbSB9KTtcclxuICAgICAgICAgICAgaWYgKGJlZm9yZVNob3ckICYmIGJlZm9yZVNob3ckLnN1YnNjcmliZSkge1xyXG4gICAgICAgICAgICAgICAgYmVmb3JlU2hvdyQuc3Vic2NyaWJlKCAoZTogQmVmb3JlU2hvd01lbnUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjdHhEYXRhID0gdGhpcy5nZXRDb250ZXh0RGF0YShlKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZVN1cnBsdXNNZW51cygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjdHhEYXRhLnNob3cpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGljaygpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgKCF0aGlzLmN0eE1lbnVTZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIGNvbnN0IGNmciA9IHRoaXMuaW5qZWN0b3IuZ2V0KENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICB0aGlzLmN0eE1lbnVTZXIgPSBuZXcgRmFycmlzQ29udGV4dE1lbnVTZXJ2aWNlKGNmciwgdGhpcy5pbmplY3Rvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4TWVudVNlci5zaG93KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lbnVJdGVtczogdGhpcy5nZXRWaWV3TWVudUl0ZW1zKGN0eERhdGEuZGF0YSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiB0aGlzLmlkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlRG9tOiBjb250ZXh0TWVudURvbSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQ6IGN0eERhdGEuZGF0YSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lbnVDbGFzczogdGhpcy5tZW51Q2xhc3MsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZVdpZHRoOiBlWydmb2N1c1RhcmdldFdpZHRoJ10sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoaWdobGlnaHQ6IHRoaXMuaGlnaGxpZ2h0XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5Yig6Zmk56ysM+WxguWPiuS7peWQjueahOiPnOWNle+8jOS7heaUr+aMgeS4pOWxguiPnOWNleWxleekulxyXG4gICAgcHJpdmF0ZSByZW1vdmVTdXJwbHVzTWVudXMoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMubWVudUl0ZW1zICYmIHRoaXMubWVudUl0ZW1zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICB0aGlzLm1lbnVJdGVtcy5mb3JFYWNoKChtOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChtICE9PSAnLScgJiYgbS5jaGlsZHJlbiAmJiBtLmNoaWxkcmVuLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG0uY2hpbGRyZW4uZm9yRWFjaChjbSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjbSAhPT0gJy0nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbS5jaGlsZHJlbiA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNvbnRleHRNZW51SWQoKSB7XHJcbiAgICAgICAgY29uc3QgaWQgPSB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQuaWQ7XHJcbiAgICAgICAgaWYgKGlkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBgJHtpZH0tY29udGV4dC1tZW51YDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gJ2NvbnRleHQtbWVudV8nICsgbmV3IERhdGUoKS5nZXRUaW1lKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0Q29udGV4dERhdGEoZTogQmVmb3JlU2hvd01lbnUpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGUgPT09ICdib29sZWFuJykge1xyXG4gICAgICAgICAgICByZXR1cm4geyBzaG93OiBlLCBkYXRhOiBudWxsIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBlO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIGdldFZpZXdNZW51SXRlbXMoY29udGV4dCkge1xyXG4gICAgICAgIGlmICh0aGlzLm1lbnVJdGVtcyAmJiB0aGlzLm1lbnVJdGVtcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hlY2tNZW51SXRlbXModGhpcy5tZW51SXRlbXMsIGNvbnRleHQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gIFtdO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hlY2tNZW51SXRlbXMobWVudUl0ZW1zLCBjb250ZXh0KSB7XHJcbiAgICAgICAgY29uc3QgbWVudXMgPSBtZW51SXRlbXMubWFwKChtOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBtID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG07XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgIGNvbnN0IG4gPSB0aGlzLmNoZWNrVmlzaWJsZUFuZERpc2FibGUobSwgY29udGV4dCk7XHJcbiAgICAgICAgICAgICAgIGlmIChuLmNoaWxkcmVuKSB7XHJcbiAgICAgICAgICAgICAgICAgICBuLmNoaWxkcmVuID0gdGhpcy5jaGVja01lbnVJdGVtcyhuLmNoaWxkcmVuLCBjb250ZXh0KTtcclxuICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICByZXR1cm4gbjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pLmZpbHRlcihuID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIG4gPT09ICctJyB8fCBuLnZpc2libGU7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGlmIChtZW51cyAmJiBtZW51cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgaWYgKG1lbnVzWzBdID09PSAnLScpIHtcclxuICAgICAgICAgICAgICAgIG1lbnVzLnNoaWZ0KDApO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAobWVudXNbbWVudXMubGVuZ3RoIC0gMV0gPT09ICctJykge1xyXG4gICAgICAgICAgICAgICAgbWVudXMucG9wKDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gbWVudXM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjaGVja1Zpc2libGVBbmREaXNhYmxlKG06IGFueSwgY29udGV4dCkge1xyXG4gICAgICAgIGNvbnN0IG4gPSB7Li4ubX07XHJcbiAgICAgICAgaWYgKCFuLmhhc093blByb3BlcnR5KCd2aXNpYmxlJykpIHtcclxuICAgICAgICAgICAgbi52aXNpYmxlID0gdHJ1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIG4udmlzaWJsZSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICAgICAgbi52aXNpYmxlID0gbi52aXNpYmxlKCBjb250ZXh0KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCFuLmhhc093blByb3BlcnR5KCdkaXNhYmxlJykpIHtcclxuICAgICAgICAgICAgbi5kaXNhYmxlID0gZmFsc2U7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBuLmRpc2FibGUgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgICAgIG4uZGlzYWJsZSA9IG4uZGlzYWJsZSggY29udGV4dCApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gbjtcclxuICAgIH1cclxufVxyXG4iXX0=