/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Subject } from 'rxjs';
import { FarrisContextMenuComponent } from './context-menu.component';
import { Injectable, ComponentFactoryResolver, Injector } from '@angular/core';
import { OverLayHiddenService } from '@farris/ui-common';
export class FarrisContextMenuService {
    /**
     * @param {?} cfr
     * @param {?} injector
     */
    constructor(cfr, injector) {
        this.cfr = cfr;
        this.injector = injector;
        this.overlayEle = null;
        this.contextMenuDom = null;
        this.contextMenuRefs = {};
        this.activeDom = null;
        this.showContextMenu = new Subject();
        this.overlayHideSer = this.injector.get(OverLayHiddenService, null);
        if (!this.overlayHideSer) {
            this.overlayHideSer = new OverLayHiddenService();
        }
    }
    /**
     * @private
     * @param {?=} cls
     * @param {?=} opts
     * @return {?}
     */
    createOverlay(cls, opts) {
        /** @type {?} */
        let overlayEle = document.querySelector('.f-context-menu-overlay');
        if (!overlayEle) {
            overlayEle = document.createElement('div');
            overlayEle.classList.add('f-context-menu-overlay', cls);
            overlayEle.style.pointerEvents = 'none';
            document.body.appendChild(overlayEle);
            if (opts.highlight) {
                this.activeDom = document.createElement('div');
                this.activeDom.classList.add('f-context-target-focus');
                overlayEle.appendChild(this.activeDom);
            }
            overlayEle.addEventListener('click', (/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                if (((/** @type {?} */ (e.target))).className.indexOf('f-context-menu-overlay') > -1) {
                    this.hide();
                }
            }));
            overlayEle.addEventListener('contextmenu', (/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                e.preventDefault();
                e.stopPropagation();
                this.hide();
            }));
        }
        return overlayEle;
    }
    /**
     * @param {?} options
     * @return {?}
     */
    show(options) {
        const { menuItems, event, id, activeDom, context, menuClass, target, activeWidth } = options;
        /** @type {?} */
        let cmpRef = null;
        if (!this.contextMenuRefs) {
            this.contextMenuRefs = {};
        }
        if (!this.contextMenuRefs[id]) {
            /** @type {?} */
            const cmpFactory = this.cfr.resolveComponentFactory(FarrisContextMenuComponent);
            cmpRef = cmpFactory.create(this.injector);
            cmpRef.instance.menuItems = menuItems;
            cmpRef.instance.id = id;
            cmpRef.instance.left = event.pageX;
            cmpRef.instance.top = event.pageY;
            this.contextMenuDom = activeDom;
            this.contextMenuRefs[cmpRef.instance.id] = cmpRef;
        }
        else {
            cmpRef = this.contextMenuRefs[id];
        }
        cmpRef.instance.context = context;
        this.overlayEle = this.createOverlay(menuClass, options);
        this.overlayEle.appendChild(cmpRef.location.nativeElement);
        this.overlayHideSer.registerMouseEvent(this.overlayEle, (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (cmpRef.location.nativeElement.contains(e.target)) {
                return;
            }
            this.hide();
        }));
        if (this.activeDom) {
            // const w = target.offsetWidth > this.contextMenuDom.offsetWidth ? this.contextMenuDom.offsetWidth : target.offsetWidth;
            /** @type {?} */
            const w = activeWidth || this.contextMenuDom.offsetWidth;
            this.activeDom.style.width = w + 'px';
            this.activeDom.style.height = this.contextMenuDom.offsetHeight + 'px';
            this.activeDom.style.left = target.getBoundingClientRect().left + 'px';
            this.activeDom.style.top = this.contextMenuDom.getBoundingClientRect().top + 'px';
            this.activeDom.style.display = 'block';
        }
        cmpRef.changeDetectorRef.detectChanges();
        /** @type {?} */
        const menuPanelDom = cmpRef.instance.menuPanel.nativeElement;
        /** @type {?} */
        const menuPanelHeight = menuPanelDom.offsetHeight;
        if (window.innerHeight - event.pageY < menuPanelHeight) {
            cmpRef.instance.top = event.pageY - menuPanelHeight;
        }
        if (window.innerWidth - event.pageX < menuPanelDom.offsetWidth) {
            cmpRef.instance.left = event.pageX - menuPanelDom.offsetWidth;
        }
        cmpRef.changeDetectorRef.detectChanges();
    }
    /**
     * @return {?}
     */
    hide() {
        if (this.overlayEle) {
            this.overlayEle.style.display = 'none';
            if (this.contextMenuRefs) {
                for (const key of Object.keys(this.contextMenuRefs)) {
                    this.contextMenuRefs[key].hostView.destroy();
                }
                this.contextMenuRefs = null;
            }
            // 移除DOM 样式
            if (this.contextMenuDom) {
                this.contextMenuDom.className = this.contextMenuDom.className.replace('f-context-menu-active', '');
            }
            this.overlayHideSer.destory(this.overlayEle);
            this.overlayEle.remove();
        }
        this.activeDom = null;
        this.overlayEle = null;
    }
}
FarrisContextMenuService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
FarrisContextMenuService.ctorParameters = () => [
    { type: ComponentFactoryResolver },
    { type: Injector }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.overlayEle;
    /** @type {?} */
    FarrisContextMenuService.prototype.contextMenuDom;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.contextMenuRefs;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.activeDom;
    /** @type {?} */
    FarrisContextMenuService.prototype.showContextMenu;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.overlayHideSer;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.cfr;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC1tZW51LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWNvbnRleHQtbWVudS8iLCJzb3VyY2VzIjpbImxpYi9jb250ZXh0LW1lbnUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN0RSxPQUFPLEVBQUUsVUFBVSxFQUFFLHdCQUF3QixFQUFFLFFBQVEsRUFBZ0IsTUFBTSxlQUFlLENBQUM7QUFFN0YsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFHekQsTUFBTSxPQUFPLHdCQUF3Qjs7Ozs7SUFVakMsWUFBb0IsR0FBNkIsRUFBVSxRQUFrQjtRQUF6RCxRQUFHLEdBQUgsR0FBRyxDQUEwQjtRQUFVLGFBQVEsR0FBUixRQUFRLENBQVU7UUFSckUsZUFBVSxHQUFHLElBQUksQ0FBQztRQUNuQixtQkFBYyxHQUFHLElBQUksQ0FBQztRQUNyQixvQkFBZSxHQUFnRSxFQUFFLENBQUM7UUFFbEYsY0FBUyxHQUFHLElBQUksQ0FBQztRQUV6QixvQkFBZSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7UUFHNUIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNwRSxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUN0QixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksb0JBQW9CLEVBQUUsQ0FBQztTQUNwRDtJQUNMLENBQUM7Ozs7Ozs7SUFJTyxhQUFhLENBQUMsR0FBWSxFQUFFLElBQXlCOztZQUNyRCxVQUFVLEdBQVEsUUFBUSxDQUFDLGFBQWEsQ0FBQyx5QkFBeUIsQ0FBQztRQUN2RSxJQUFJLENBQUMsVUFBVSxFQUFF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QVMsR0FBRyxJQUFJLENBQUM7UUFDdEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7SUFHM0IsQ0FBQzs7O1lBMUlKLFVBQVU7Ozs7WUFKVSx3QkFBd0I7WUFBRSxRQUFROzs7Ozs7O0lBT25ELDhDQUEwQjs7SUFDMUIsa0RBQTZCOzs7OztJQUM3QixtREFBMEY7Ozs7O0lBRTFGLDZDQUF5Qjs7SUFFekIsbURBQWdDOzs7OztJQUNoQyxrREFBNkM7Ozs7O0lBQ2pDLHVDQUFxQzs7Ozs7SUFBRSw0Q0FBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IEZhcnJpc0NvbnRleHRNZW51Q29tcG9uZW50IH0gZnJvbSAnLi9jb250ZXh0LW1lbnUuY29tcG9uZW50JztcclxuaW1wb3J0IHsgSW5qZWN0YWJsZSwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBJbmplY3RvciwgQ29tcG9uZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IENvbnRleHRNZW51T3B0aW9ucyB9IGZyb20gJy4vbWVudS1pdGVtLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IE92ZXJMYXlIaWRkZW5TZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24nO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRmFycmlzQ29udGV4dE1lbnVTZXJ2aWNlIHtcclxuXHJcbiAgICBwcml2YXRlIG92ZXJsYXlFbGUgPSBudWxsO1xyXG4gICAgcHVibGljIGNvbnRleHRNZW51RG9tID0gbnVsbDtcclxuICAgIHByaXZhdGUgY29udGV4dE1lbnVSZWZzOiB7IFtrZXk6IHN0cmluZ106IENvbXBvbmVudFJlZjxGYXJyaXNDb250ZXh0TWVudUNvbXBvbmVudD4gfSA9IHt9O1xyXG5cclxuICAgIHByaXZhdGUgYWN0aXZlRG9tID0gbnVsbDtcclxuXHJcbiAgICBzaG93Q29udGV4dE1lbnUgPSBuZXcgU3ViamVjdCgpO1xyXG4gICAgcHJpdmF0ZSBvdmVybGF5SGlkZVNlcjogT3ZlckxheUhpZGRlblNlcnZpY2U7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNmcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBwcml2YXRlIGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gICAgICAgIHRoaXMub3ZlcmxheUhpZGVTZXIgPSB0aGlzLmluamVjdG9yLmdldChPdmVyTGF5SGlkZGVuU2VydmljZSwgbnVsbCk7XHJcbiAgICAgICAgaWYgKCF0aGlzLm92ZXJsYXlIaWRlU2VyKSB7XHJcbiAgICAgICAgICAgIHRoaXMub3ZlcmxheUhpZGVTZXIgPSBuZXcgT3ZlckxheUhpZGRlblNlcnZpY2UoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuXHJcbiAgICBwcml2YXRlIGNyZWF0ZU92ZXJsYXkoY2xzPzogc3RyaW5nLCBvcHRzPzogQ29udGV4dE1lbnVPcHRpb25zKSB7XHJcbiAgICAgICAgbGV0IG92ZXJsYXlFbGU6IGFueSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5mLWNvbnRleHQtbWVudS1vdmVybGF5Jyk7XHJcbiAgICAgICAgaWYgKCFvdmVybGF5RWxlKSB7XHJcbiAgICAgICAgICAgIG92ZXJsYXlFbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICAgICAgb3ZlcmxheUVsZS5jbGFzc0xpc3QuYWRkKCdmLWNvbnRleHQtbWVudS1vdmVybGF5JywgY2xzKTtcclxuXHJcbiAgICAgICAgICAgIG92ZXJsYXlFbGUuc3R5bGUucG9pbnRlckV2ZW50cyA9ICdub25lJztcclxuXHJcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQob3ZlcmxheUVsZSk7XHJcblxyXG4gICAgICAgICAgICBpZiAob3B0cy5oaWdobGlnaHQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlRG9tID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZURvbS5jbGFzc0xpc3QuYWRkKCdmLWNvbnRleHQtdGFyZ2V0LWZvY3VzJyk7XHJcbiAgICAgICAgICAgICAgICBvdmVybGF5RWxlLmFwcGVuZENoaWxkKHRoaXMuYWN0aXZlRG9tKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgb3ZlcmxheUVsZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoKGUudGFyZ2V0IGFzIGFueSkuY2xhc3NOYW1lLmluZGV4T2YoJ2YtY29udGV4dC1tZW51LW92ZXJsYXknKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgb3ZlcmxheUVsZS5hZGRFdmVudExpc3RlbmVyKCdjb250ZXh0bWVudScsIChlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gb3ZlcmxheUVsZTtcclxuICAgIH1cclxuXHJcbiAgICBzaG93KG9wdGlvbnM6IENvbnRleHRNZW51T3B0aW9ucykge1xyXG5cclxuICAgICAgICBjb25zdCB7IG1lbnVJdGVtcywgZXZlbnQsIGlkLCBhY3RpdmVEb20sIGNvbnRleHQsIG1lbnVDbGFzcywgdGFyZ2V0LCBhY3RpdmVXaWR0aCB9ID0gb3B0aW9ucztcclxuICAgICAgICBsZXQgY21wUmVmID0gbnVsbDtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLmNvbnRleHRNZW51UmVmcykge1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRleHRNZW51UmVmcyA9IHt9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLmNvbnRleHRNZW51UmVmc1tpZF0pIHtcclxuICAgICAgICAgICAgY29uc3QgY21wRmFjdG9yeSA9IHRoaXMuY2ZyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KEZhcnJpc0NvbnRleHRNZW51Q29tcG9uZW50KTtcclxuICAgICAgICAgICAgY21wUmVmID0gY21wRmFjdG9yeS5jcmVhdGUodGhpcy5pbmplY3Rvcik7XHJcbiAgICAgICAgICAgIGNtcFJlZi5pbnN0YW5jZS5tZW51SXRlbXMgPSBtZW51SXRlbXM7XHJcbiAgICAgICAgICAgIGNtcFJlZi5pbnN0YW5jZS5pZCA9IGlkO1xyXG5cclxuICAgICAgICAgICAgY21wUmVmLmluc3RhbmNlLmxlZnQgPSBldmVudC5wYWdlWDtcclxuICAgICAgICAgICAgY21wUmVmLmluc3RhbmNlLnRvcCA9IGV2ZW50LnBhZ2VZO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5jb250ZXh0TWVudURvbSA9IGFjdGl2ZURvbTtcclxuICAgICAgICAgICAgdGhpcy5jb250ZXh0TWVudVJlZnNbY21wUmVmLmluc3RhbmNlLmlkXSA9IGNtcFJlZjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjbXBSZWYgPSB0aGlzLmNvbnRleHRNZW51UmVmc1tpZF07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjbXBSZWYuaW5zdGFuY2UuY29udGV4dCA9IGNvbnRleHQ7XHJcblxyXG4gICAgICAgIHRoaXMub3ZlcmxheUVsZSA9IHRoaXMuY3JlYXRlT3ZlcmxheShtZW51Q2xhc3MsIG9wdGlvbnMpO1xyXG4gICAgICAgIHRoaXMub3ZlcmxheUVsZS5hcHBlbmRDaGlsZChjbXBSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudCk7XHJcblxyXG5cclxuICAgICAgICB0aGlzLm92ZXJsYXlIaWRlU2VyLnJlZ2lzdGVyTW91c2VFdmVudCh0aGlzLm92ZXJsYXlFbGUsIChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKGNtcFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50LmNvbnRhaW5zKGUudGFyZ2V0KSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuaGlkZSgpO1xyXG4gICAgICAgIH0pXHJcblxyXG5cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuYWN0aXZlRG9tKSB7XHJcbiAgICAgICAgICAgIC8vIGNvbnN0IHcgPSB0YXJnZXQub2Zmc2V0V2lkdGggPiB0aGlzLmNvbnRleHRNZW51RG9tLm9mZnNldFdpZHRoID8gdGhpcy5jb250ZXh0TWVudURvbS5vZmZzZXRXaWR0aCA6IHRhcmdldC5vZmZzZXRXaWR0aDtcclxuICAgICAgICAgICAgY29uc3QgdyA9IGFjdGl2ZVdpZHRoIHx8IHRoaXMuY29udGV4dE1lbnVEb20ub2Zmc2V0V2lkdGg7XHJcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlRG9tLnN0eWxlLndpZHRoID0gIHcgKyAncHgnO1xyXG4gICAgICAgICAgICB0aGlzLmFjdGl2ZURvbS5zdHlsZS5oZWlnaHQgPSB0aGlzLmNvbnRleHRNZW51RG9tLm9mZnNldEhlaWdodCArICdweCc7XHJcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlRG9tLnN0eWxlLmxlZnQgPSB0YXJnZXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdCArICdweCc7XHJcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlRG9tLnN0eWxlLnRvcCA9IHRoaXMuY29udGV4dE1lbnVEb20uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wICsgJ3B4JztcclxuICAgICAgICAgICAgdGhpcy5hY3RpdmVEb20uc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNtcFJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IG1lbnVQYW5lbERvbSA9IGNtcFJlZi5pbnN0YW5jZS5tZW51UGFuZWwubmF0aXZlRWxlbWVudDtcclxuICAgICAgICBjb25zdCBtZW51UGFuZWxIZWlnaHQgPSAgbWVudVBhbmVsRG9tLm9mZnNldEhlaWdodDtcclxuICAgICAgICBpZiAod2luZG93LmlubmVySGVpZ2h0IC0gIGV2ZW50LnBhZ2VZIDwgbWVudVBhbmVsSGVpZ2h0KSB7XHJcbiAgICAgICAgICAgIGNtcFJlZi5pbnN0YW5jZS50b3AgPSBldmVudC5wYWdlWSAtIG1lbnVQYW5lbEhlaWdodDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh3aW5kb3cuaW5uZXJXaWR0aCAtIGV2ZW50LnBhZ2VYIDwgbWVudVBhbmVsRG9tLm9mZnNldFdpZHRoKSB7XHJcbiAgICAgICAgICAgIGNtcFJlZi5pbnN0YW5jZS5sZWZ0ID0gZXZlbnQucGFnZVggLSBtZW51UGFuZWxEb20ub2Zmc2V0V2lkdGg7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjbXBSZWYuY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgfVxyXG5cclxuICAgIGhpZGUoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMub3ZlcmxheUVsZSkge1xyXG4gICAgICAgICAgICB0aGlzLm92ZXJsYXlFbGUuc3R5bGUuZGlzcGxheSA9ICdub25lJztcclxuICAgICAgICAgICAgaWYgKHRoaXMuY29udGV4dE1lbnVSZWZzKSB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyh0aGlzLmNvbnRleHRNZW51UmVmcykpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHRNZW51UmVmc1trZXldLmhvc3RWaWV3LmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dE1lbnVSZWZzID0gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8g56e76ZmkRE9NIOagt+W8j1xyXG4gICAgICAgICAgICBpZiAodGhpcy5jb250ZXh0TWVudURvbSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0TWVudURvbS5jbGFzc05hbWUgPSB0aGlzLmNvbnRleHRNZW51RG9tLmNsYXNzTmFtZS5yZXBsYWNlKCdmLWNvbnRleHQtbWVudS1hY3RpdmUnLCAnJyk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICB0aGlzLm92ZXJsYXlIaWRlU2VyLmRlc3RvcnkodGhpcy5vdmVybGF5RWxlKTtcclxuICAgICAgICAgICAgdGhpcy5vdmVybGF5RWxlLnJlbW92ZSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5hY3RpdmVEb20gPSBudWxsO1xyXG4gICAgICAgIHRoaXMub3ZlcmxheUVsZSA9IG51bGw7XHJcblxyXG4gICAgICAgIFxyXG4gICAgfVxyXG59XHJcbiJdfQ==