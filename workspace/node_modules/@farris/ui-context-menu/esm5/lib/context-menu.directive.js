/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Directive, HostListener, Input, Injector, ElementRef, Renderer2, Optional } from '@angular/core';
import { of } from 'rxjs';
import { FarrisContextMenuService } from './context-menu.service';
var FarrisContextMenuDirective = /** @class */ (function () {
    function FarrisContextMenuDirective(ctxMenuSer, injector, elRef, render) {
        this.ctxMenuSer = ctxMenuSer;
        this.injector = injector;
        this.elRef = elRef;
        this.render = render;
        this.disabled = false;
        this.highlight = true;
    }
    /**
     * @return {?}
     */
    FarrisContextMenuDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.id = this.contextMenuId();
        if (!this.beforeShowContextMenu) {
            this.beforeShowContextMenu = (/**
             * @return {?}
             */
            function () { return of(true); });
        }
    };
    /**
     * @param {?} event
     * @return {?}
     */
    FarrisContextMenuDirective.prototype.onContextMenu = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        var _this = this;
        if (!this.disabled) {
            /** @type {?} */
            var contextMenuDom_1 = null;
            if (this.activeDomName) {
                contextMenuDom_1 = ((/** @type {?} */ (event.target))).closest(this.activeDomName);
                if (contextMenuDom_1) {
                    this.render.addClass(contextMenuDom_1, 'f-context-menu-active');
                }
                else {
                    return;
                }
            }
            /** @type {?} */
            var beforeShow$ = this.beforeShowContextMenu({ event: event, contextMenuDom: contextMenuDom_1 });
            if (beforeShow$ && beforeShow$.subscribe) {
                beforeShow$.subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                function (e) {
                    /** @type {?} */
                    var ctxData = _this.getContextData(e);
                    _this.removeSurplusMenus();
                    if (ctxData.show) {
                        document.body.click();
                        // if (!this.ctxMenuSer) {
                        //     const cfr = this.injector.get(ComponentFactoryResolver);
                        //     this.ctxMenuSer = new FarrisContextMenuService(cfr, this.injector);
                        // }
                        _this.ctxMenuSer.show({
                            menuItems: _this.getViewMenuItems(ctxData.data),
                            event: event,
                            id: _this.id,
                            activeDom: contextMenuDom_1,
                            context: ctxData.data,
                            menuClass: _this.menuClass,
                            target: _this.elRef.nativeElement,
                            activeWidth: e['focusTargetWidth'],
                            highlight: _this.highlight
                        });
                        event.preventDefault();
                        event.stopPropagation();
                    }
                }));
            }
        }
    };
    // 删除第3层及以后的菜单，仅支持两层菜单展示
    // 删除第3层及以后的菜单，仅支持两层菜单展示
    /**
     * @private
     * @return {?}
     */
    FarrisContextMenuDirective.prototype.removeSurplusMenus = 
    // 删除第3层及以后的菜单，仅支持两层菜单展示
    /**
     * @private
     * @return {?}
     */
    function () {
        if (this.menuItems && this.menuItems.length) {
            this.menuItems.forEach((/**
             * @param {?} m
             * @return {?}
             */
            function (m) {
                if (m !== '-' && m.children && m.children.length) {
                    m.children.forEach((/**
                     * @param {?} cm
                     * @return {?}
                     */
                    function (cm) {
                        if (cm !== '-') {
                            cm.children = [];
                        }
                    }));
                }
            }));
        }
    };
    /**
     * @private
     * @return {?}
     */
    FarrisContextMenuDirective.prototype.contextMenuId = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var id = this.elRef.nativeElement.id;
        if (id) {
            return id + "-context-menu";
        }
        else {
            return 'context-menu_' + new Date().getTime();
        }
    };
    /**
     * @private
     * @param {?} e
     * @return {?}
     */
    FarrisContextMenuDirective.prototype.getContextData = /**
     * @private
     * @param {?} e
     * @return {?}
     */
    function (e) {
        if (typeof e === 'boolean') {
            return { show: e, data: null };
        }
        return e;
    };
    /**
     * @private
     * @param {?} context
     * @return {?}
     */
    FarrisContextMenuDirective.prototype.getViewMenuItems = /**
     * @private
     * @param {?} context
     * @return {?}
     */
    function (context) {
        if (this.menuItems && this.menuItems.length) {
            return this.checkMenuItems(this.menuItems, context);
        }
        return [];
    };
    /**
     * @private
     * @param {?} menuItems
     * @param {?} context
     * @return {?}
     */
    FarrisContextMenuDirective.prototype.checkMenuItems = /**
     * @private
     * @param {?} menuItems
     * @param {?} context
     * @return {?}
     */
    function (menuItems, context) {
        var _this = this;
        /** @type {?} */
        var menus = menuItems.map((/**
         * @param {?} m
         * @return {?}
         */
        function (m) {
            if (typeof m === 'string') {
                return m;
            }
            else {
                /** @type {?} */
                var n = _this.checkVisibleAndDisable(m, context);
                if (n.children) {
                    n.children = _this.checkMenuItems(n.children, context);
                }
                return n;
            }
        })).filter((/**
         * @param {?} n
         * @return {?}
         */
        function (n) {
            return n === '-' || n.visible;
        }));
        if (menus && menus.length) {
            if (menus[0] === '-') {
                menus.shift(0);
            }
            if (menus[menus.length - 1] === '-') {
                menus.pop(0);
            }
        }
        return menus;
    };
    /**
     * @private
     * @param {?} m
     * @param {?} context
     * @return {?}
     */
    FarrisContextMenuDirective.prototype.checkVisibleAndDisable = /**
     * @private
     * @param {?} m
     * @param {?} context
     * @return {?}
     */
    function (m, context) {
        /** @type {?} */
        var n = tslib_1.__assign({}, m);
        if (!n.hasOwnProperty('visible')) {
            n.visible = true;
        }
        else {
            if (typeof n.visible === 'function') {
                n.visible = n.visible(context);
            }
        }
        if (!n.hasOwnProperty('disable')) {
            n.disable = false;
        }
        else {
            if (typeof n.disable === 'function') {
                n.disable = n.disable(context);
            }
        }
        return n;
    };
    FarrisContextMenuDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[farris-context-menus]',
                },] }
    ];
    /** @nocollapse */
    FarrisContextMenuDirective.ctorParameters = function () { return [
        { type: FarrisContextMenuService, decorators: [{ type: Optional }] },
        { type: Injector },
        { type: ElementRef },
        { type: Renderer2 }
    ]; };
    FarrisContextMenuDirective.propDecorators = {
        menuItems: [{ type: Input, args: ['farris-context-menus',] }],
        menuClass: [{ type: Input }],
        disabled: [{ type: Input }],
        context: [{ type: Input }],
        beforeShowContextMenu: [{ type: Input }],
        activeDomName: [{ type: Input }],
        highlight: [{ type: Input }],
        onContextMenu: [{ type: HostListener, args: ['contextmenu', ['$event'],] }]
    };
    return FarrisContextMenuDirective;
}());
export { FarrisContextMenuDirective };
if (false) {
    /** @type {?} */
    FarrisContextMenuDirective.prototype.menuItems;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.menuClass;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.disabled;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.context;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.beforeShowContextMenu;
    /**
     * 触发右键菜单实际DOM标签名称
     * @type {?}
     */
    FarrisContextMenuDirective.prototype.activeDomName;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.highlight;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.id;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuDirective.prototype.ctxMenuSer;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuDirective.prototype.elRef;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuDirective.prototype.render;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC1tZW51LmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktY29udGV4dC1tZW51LyIsInNvdXJjZXMiOlsibGliL2NvbnRleHQtbWVudS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBVSxTQUFTLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2xILE9BQU8sRUFBRSxFQUFFLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFHbEU7SUFjSSxvQ0FBZ0MsVUFBb0MsRUFDaEQsUUFBa0IsRUFBVSxLQUFpQixFQUFVLE1BQWlCO1FBRDVELGVBQVUsR0FBVixVQUFVLENBQTBCO1FBQ2hELGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxVQUFLLEdBQUwsS0FBSyxDQUFZO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBVztRQVRuRixhQUFRLEdBQUcsS0FBSyxDQUFDO1FBS2pCLGNBQVMsR0FBRyxJQUFJLENBQUM7SUFLZCxDQUFDOzs7O0lBRWIsNkNBQVE7OztJQUFSO1FBQ0ksSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFFL0IsSUFBSSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRTtZQUM3QixJQUFJLENBQUMscUJBQXFCOzs7WUFBRyxjQUFNLE9BQUEsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFSLENBQVEsQ0FBQSxDQUFDO1NBQy9DO0lBQ0wsQ0FBQzs7Ozs7SUFHTSxrREFBYTs7OztJQURwQixVQUNxQixLQUFpQjtRQUR0QyxpQkE0Q0M7UUExQ0csSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7O2dCQUNaLGdCQUFjLEdBQUcsSUFBSTtZQUN6QixJQUFJLElB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LFlBQVksU0FBQyxhQUFhLEVBQUUsQ0FBQyxRQUFRLENBQUM7O0lBcUkzQyxpQ0FBQztDQUFBLEFBL0pELElBK0pDO1NBNUpZLDBCQUEwQjs7O0lBQ25DLCtDQUE0RDs7SUFDNUQsK0NBQTJCOztJQUMzQiw4Q0FBMEI7O0lBQzFCLDZDQUFzQjs7SUFDdEIsMkRBQXdFOzs7OztJQUV4RSxtREFBK0I7O0lBQy9CLCtDQUEwQjs7SUFDMUIsd0NBQVc7Ozs7O0lBRUMsZ0RBQXdEOzs7OztJQUN4RCw4Q0FBMEI7Ozs7O0lBQUUsMkNBQXlCOzs7OztJQUFFLDRDQUF5QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgSG9zdExpc3RlbmVyLCBJbnB1dCwgSW5qZWN0b3IsIEVsZW1lbnRSZWYsIE9uSW5pdCwgUmVuZGVyZXIyLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBvZiwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBGYXJyaXNDb250ZXh0TWVudVNlcnZpY2UgfSBmcm9tICcuL2NvbnRleHQtbWVudS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQmVmb3JlU2hvd01lbnUsIENvbnRleHRNZW51SXRlbSB9IGZyb20gJy4vbWVudS1pdGVtLmludGVyZmFjZSc7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICAgIHNlbGVjdG9yOiAnW2ZhcnJpcy1jb250ZXh0LW1lbnVzXScsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBGYXJyaXNDb250ZXh0TWVudURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcbiAgICBASW5wdXQoJ2ZhcnJpcy1jb250ZXh0LW1lbnVzJykgbWVudUl0ZW1zOiBDb250ZXh0TWVudUl0ZW1bXTtcclxuICAgIEBJbnB1dCgpIG1lbnVDbGFzczogc3RyaW5nO1xyXG4gICAgQElucHV0KCkgZGlzYWJsZWQgPSBmYWxzZTtcclxuICAgIEBJbnB1dCgpIGNvbnRleHQ6IGFueTtcclxuICAgIEBJbnB1dCgpIGJlZm9yZVNob3dDb250ZXh0TWVudTogKGU/OiBhbnkpID0+IE9ic2VydmFibGU8QmVmb3JlU2hvd01lbnU+O1xyXG4gICAgLyoqIOinpuWPkeWPs+mUruiPnOWNleWunumZhURPTeagh+etvuWQjeensCAqL1xyXG4gICAgQElucHV0KCkgYWN0aXZlRG9tTmFtZTogc3RyaW5nO1xyXG4gICAgQElucHV0KCkgaGlnaGxpZ2h0ID0gdHJ1ZTtcclxuICAgIGlkOiBzdHJpbmc7XHJcblxyXG4gICAgY29uc3RydWN0b3IoQE9wdGlvbmFsKCkgcHJpdmF0ZSBjdHhNZW51U2VyOiBGYXJyaXNDb250ZXh0TWVudVNlcnZpY2UsXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSBlbFJlZjogRWxlbWVudFJlZiwgcHJpdmF0ZSByZW5kZXI6IFJlbmRlcmVyMikge1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgIG5nT25Jbml0KCkge1xyXG4gICAgICAgIHRoaXMuaWQgPSB0aGlzLmNvbnRleHRNZW51SWQoKTtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLmJlZm9yZVNob3dDb250ZXh0TWVudSkge1xyXG4gICAgICAgICAgICB0aGlzLmJlZm9yZVNob3dDb250ZXh0TWVudSA9ICgpID0+IG9mKHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBASG9zdExpc3RlbmVyKCdjb250ZXh0bWVudScsIFsnJGV2ZW50J10pXHJcbiAgICBwdWJsaWMgb25Db250ZXh0TWVudShldmVudDogTW91c2VFdmVudCk6IHZvaWQge1xyXG4gICAgICAgIGlmICghdGhpcy5kaXNhYmxlZCkge1xyXG4gICAgICAgICAgICBsZXQgY29udGV4dE1lbnVEb20gPSBudWxsO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVEb21OYW1lKSB7XHJcbiAgICAgICAgICAgICAgICBjb250ZXh0TWVudURvbSA9IChldmVudC50YXJnZXQgYXMgYW55KS5jbG9zZXN0KHRoaXMuYWN0aXZlRG9tTmFtZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29udGV4dE1lbnVEb20pIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlci5hZGRDbGFzcyhjb250ZXh0TWVudURvbSwgJ2YtY29udGV4dC1tZW51LWFjdGl2ZScpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGJlZm9yZVNob3ckID0gdGhpcy5iZWZvcmVTaG93Q29udGV4dE1lbnUoeyBldmVudCwgY29udGV4dE1lbnVEb20gfSk7XHJcbiAgICAgICAgICAgIGlmIChiZWZvcmVTaG93JCAmJiBiZWZvcmVTaG93JC5zdWJzY3JpYmUpIHtcclxuICAgICAgICAgICAgICAgIGJlZm9yZVNob3ckLnN1YnNjcmliZSggKGU6IEJlZm9yZVNob3dNZW51KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3R4RGF0YSA9IHRoaXMuZ2V0Q29udGV4dERhdGEoZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVTdXJwbHVzTWVudXMoKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY3R4RGF0YS5zaG93KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xpY2soKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmICghdGhpcy5jdHhNZW51U2VyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICBjb25zdCBjZnIgPSB0aGlzLmluamVjdG9yLmdldChDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgdGhpcy5jdHhNZW51U2VyID0gbmV3IEZhcnJpc0NvbnRleHRNZW51U2VydmljZShjZnIsIHRoaXMuaW5qZWN0b3IpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eE1lbnVTZXIuc2hvdyh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZW51SXRlbXM6IHRoaXMuZ2V0Vmlld01lbnVJdGVtcyhjdHhEYXRhLmRhdGEpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogdGhpcy5pZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZURvbTogY29udGV4dE1lbnVEb20sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0OiBjdHhEYXRhLmRhdGEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZW51Q2xhc3M6IHRoaXMubWVudUNsYXNzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVXaWR0aDogZVsnZm9jdXNUYXJnZXRXaWR0aCddLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGlnaGxpZ2h0OiB0aGlzLmhpZ2hsaWdodFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIOWIoOmZpOesrDPlsYLlj4rku6XlkI7nmoToj5zljZXvvIzku4XmlK/mjIHkuKTlsYLoj5zljZXlsZXnpLpcclxuICAgIHByaXZhdGUgcmVtb3ZlU3VycGx1c01lbnVzKCkge1xyXG4gICAgICAgIGlmICh0aGlzLm1lbnVJdGVtcyAmJiB0aGlzLm1lbnVJdGVtcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgdGhpcy5tZW51SXRlbXMuZm9yRWFjaCgobTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAobSAhPT0gJy0nICYmIG0uY2hpbGRyZW4gJiYgbS5jaGlsZHJlbi5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBtLmNoaWxkcmVuLmZvckVhY2goY20gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY20gIT09ICctJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY20uY2hpbGRyZW4gPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjb250ZXh0TWVudUlkKCkge1xyXG4gICAgICAgIGNvbnN0IGlkID0gdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LmlkO1xyXG4gICAgICAgIGlmIChpZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gYCR7aWR9LWNvbnRleHQtbWVudWA7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuICdjb250ZXh0LW1lbnVfJyArIG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldENvbnRleHREYXRhKGU6IEJlZm9yZVNob3dNZW51KSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBlID09PSAnYm9vbGVhbicpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc2hvdzogZSwgZGF0YTogbnVsbCB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBnZXRWaWV3TWVudUl0ZW1zKGNvbnRleHQpIHtcclxuICAgICAgICBpZiAodGhpcy5tZW51SXRlbXMgJiYgdGhpcy5tZW51SXRlbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNoZWNrTWVudUl0ZW1zKHRoaXMubWVudUl0ZW1zLCBjb250ZXh0KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuICBbXTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNoZWNrTWVudUl0ZW1zKG1lbnVJdGVtcywgY29udGV4dCkge1xyXG4gICAgICAgIGNvbnN0IG1lbnVzID0gbWVudUl0ZW1zLm1hcCgobTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgbSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBtO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICBjb25zdCBuID0gdGhpcy5jaGVja1Zpc2libGVBbmREaXNhYmxlKG0sIGNvbnRleHQpO1xyXG4gICAgICAgICAgICAgICBpZiAobi5jaGlsZHJlbikge1xyXG4gICAgICAgICAgICAgICAgICAgbi5jaGlsZHJlbiA9IHRoaXMuY2hlY2tNZW51SXRlbXMobi5jaGlsZHJlbiwgY29udGV4dCk7XHJcbiAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgcmV0dXJuIG47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KS5maWx0ZXIobiA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBuID09PSAnLScgfHwgbi52aXNpYmxlO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpZiAobWVudXMgJiYgbWVudXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGlmIChtZW51c1swXSA9PT0gJy0nKSB7XHJcbiAgICAgICAgICAgICAgICBtZW51cy5zaGlmdCgwKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKG1lbnVzW21lbnVzLmxlbmd0aCAtIDFdID09PSAnLScpIHtcclxuICAgICAgICAgICAgICAgIG1lbnVzLnBvcCgwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG1lbnVzO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hlY2tWaXNpYmxlQW5kRGlzYWJsZShtOiBhbnksIGNvbnRleHQpIHtcclxuICAgICAgICBjb25zdCBuID0gey4uLm19O1xyXG4gICAgICAgIGlmICghbi5oYXNPd25Qcm9wZXJ0eSgndmlzaWJsZScpKSB7XHJcbiAgICAgICAgICAgIG4udmlzaWJsZSA9IHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBuLnZpc2libGUgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgICAgIG4udmlzaWJsZSA9IG4udmlzaWJsZSggY29udGV4dCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICghbi5oYXNPd25Qcm9wZXJ0eSgnZGlzYWJsZScpKSB7XHJcbiAgICAgICAgICAgIG4uZGlzYWJsZSA9IGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygbi5kaXNhYmxlID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgICAgICBuLmRpc2FibGUgPSBuLmRpc2FibGUoIGNvbnRleHQgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG47XHJcbiAgICB9XHJcbn1cclxuIl19