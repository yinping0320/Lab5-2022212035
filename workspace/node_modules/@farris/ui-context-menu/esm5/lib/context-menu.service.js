/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Subject } from 'rxjs';
import { FarrisContextMenuComponent } from './context-menu.component';
import { Injectable, ComponentFactoryResolver, Injector } from '@angular/core';
import { OverLayHiddenService } from '@farris/ui-common';
var FarrisContextMenuService = /** @class */ (function () {
    function FarrisContextMenuService(cfr, injector) {
        this.cfr = cfr;
        this.injector = injector;
        this.overlayEle = null;
        this.contextMenuDom = null;
        this.contextMenuRefs = {};
        this.activeDom = null;
        this.showContextMenu = new Subject();
        this.overlayHideSer = this.injector.get(OverLayHiddenService, null);
        if (!this.overlayHideSer) {
            this.overlayHideSer = new OverLayHiddenService();
        }
    }
    /**
     * @private
     * @param {?=} cls
     * @param {?=} opts
     * @return {?}
     */
    FarrisContextMenuService.prototype.createOverlay = /**
     * @private
     * @param {?=} cls
     * @param {?=} opts
     * @return {?}
     */
    function (cls, opts) {
        var _this = this;
        /** @type {?} */
        var overlayEle = document.querySelector('.f-context-menu-overlay');
        if (!overlayEle) {
            overlayEle = document.createElement('div');
            overlayEle.classList.add('f-context-menu-overlay', cls);
            overlayEle.style.pointerEvents = 'none';
            document.body.appendChild(overlayEle);
            if (opts.highlight) {
                this.activeDom = document.createElement('div');
                this.activeDom.classList.add('f-context-target-focus');
                overlayEle.appendChild(this.activeDom);
            }
            overlayEle.addEventListener('click', (/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                if (((/** @type {?} */ (e.target))).className.indexOf('f-context-menu-overlay') > -1) {
                    _this.hide();
                }
            }));
            overlayEle.addEventListener('contextmenu', (/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                e.preventDefault();
                e.stopPropagation();
                _this.hide();
            }));
        }
        return overlayEle;
    };
    /**
     * @param {?} options
     * @return {?}
     */
    FarrisContextMenuService.prototype.show = /**
     * @param {?} options
     * @return {?}
     */
    function (options) {
        var _this = this;
        var menuItems = options.menuItems, event = options.event, id = options.id, activeDom = options.activeDom, context = options.context, menuClass = options.menuClass, target = options.target, activeWidth = options.activeWidth;
        /** @type {?} */
        var cmpRef = null;
        if (!this.contextMenuRefs) {
            this.contextMenuRefs = {};
        }
        if (!this.contextMenuRefs[id]) {
            /** @type {?} */
            var cmpFactory = this.cfr.resolveComponentFactory(FarrisContextMenuComponent);
            cmpRef = cmpFactory.create(this.injector);
            cmpRef.instance.menuItems = menuItems;
            cmpRef.instance.id = id;
            cmpRef.instance.left = event.pageX;
            cmpRef.instance.top = event.pageY;
            this.contextMenuDom = activeDom;
            this.contextMenuRefs[cmpRef.instance.id] = cmpRef;
        }
        else {
            cmpRef = this.contextMenuRefs[id];
        }
        cmpRef.instance.context = context;
        this.overlayEle = this.createOverlay(menuClass, options);
        this.overlayEle.appendChild(cmpRef.location.nativeElement);
        this.overlayHideSer.registerMouseEvent(this.overlayEle, (/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (cmpRef.location.nativeElement.contains(e.target)) {
                return;
            }
            _this.hide();
        }));
        if (this.activeDom) {
            // const w = target.offsetWidth > this.contextMenuDom.offsetWidth ? this.contextMenuDom.offsetWidth : target.offsetWidth;
            /** @type {?} */
            var w = activeWidth || this.contextMenuDom.offsetWidth;
            this.activeDom.style.width = w + 'px';
            this.activeDom.style.height = this.contextMenuDom.offsetHeight + 'px';
            this.activeDom.style.left = target.getBoundingClientRect().left + 'px';
            this.activeDom.style.top = this.contextMenuDom.getBoundingClientRect().top + 'px';
            this.activeDom.style.display = 'block';
        }
        cmpRef.changeDetectorRef.detectChanges();
        /** @type {?} */
        var menuPanelDom = cmpRef.instance.menuPanel.nativeElement;
        /** @type {?} */
        var menuPanelHeight = menuPanelDom.offsetHeight;
        if (window.innerHeight - event.pageY < menuPanelHeight) {
            cmpRef.instance.top = event.pageY - menuPanelHeight;
        }
        if (window.innerWidth - event.pageX < menuPanelDom.offsetWidth) {
            cmpRef.instance.left = event.pageX - menuPanelDom.offsetWidth;
        }
        cmpRef.changeDetectorRef.detectChanges();
    };
    /**
     * @return {?}
     */
    FarrisContextMenuService.prototype.hide = /**
     * @return {?}
     */
    function () {
        var e_1, _a;
        if (this.overlayEle) {
            this.overlayEle.style.display = 'none';
            if (this.contextMenuRefs) {
                try {
                    for (var _b = tslib_1.__values(Object.keys(this.contextMenuRefs)), _c = _b.next(); !_c.done; _c = _b.next()) {
                        var key = _c.value;
                        this.contextMenuRefs[key].hostView.destroy();
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
                this.contextMenuRefs = null;
            }
            // 移除DOM 样式
            if (this.contextMenuDom) {
                this.contextMenuDom.className = this.contextMenuDom.className.replace('f-context-menu-active', '');
            }
            this.overlayHideSer.destory(this.overlayEle);
            this.overlayEle.remove();
        }
        this.activeDom = null;
        this.overlayEle = null;
    };
    FarrisContextMenuService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    FarrisContextMenuService.ctorParameters = function () { return [
        { type: ComponentFactoryResolver },
        { type: Injector }
    ]; };
    return FarrisContextMenuService;
}());
export { FarrisContextMenuService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.overlayEle;
    /** @type {?} */
    FarrisContextMenuService.prototype.contextMenuDom;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.contextMenuRefs;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.activeDom;
    /** @type {?} */
    FarrisContextMenuService.prototype.showContextMenu;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.overlayHideSer;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.cfr;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC1tZW51LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWNvbnRleHQtbWVudS8iLCJzb3VyY2VzIjpbImxpYi9jb250ZXh0LW1lbnUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDdEUsT0FBTyxFQUFFLFVBQVUsRUFBRSx3QkFBd0IsRUFBRSxRQUFRLEVBQWdCLE1BQU0sZUFBZSxDQUFDO0FBRTdGLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRXpEO0lBV0ksa0NBQW9CLEdBQTZCLEVBQVUsUUFBa0I7UUFBekQsUUFBRyxHQUFILEdBQUcsQ0FBMEI7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBUnJFLGVBQVUsR0FBRyxJQUFJLENBQUM7UUFDbkIsbUJBQWMsR0FBRyxJQUFJLENBQUM7UUFDckIsb0JBQWUsR0FBZ0UsRUFBRSxDQUFDO1FBRWxGLGNBQVMsR0FBRyxJQUFJLENBQUM7UUFFekIsb0JBQWUsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBRzVCLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsb0JBQW9CLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDcEUsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDdEIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLG9CQUFvQixFQUFFLENBQUM7U0FDcEQ7SUFDTCxDQUFDOzs7Ozs7O0lBSU8sZ0RBQWE7Ozs7OztJQUFyQixVQUFzQixHQUFZLEVBQUUsSUFBeUI7UUFBN0QsaUJBNkJDOztZQTVCTyxVQUFVLEdBQVEsUUFBUSxDQUFDLGFBQWEsQ0FBQyx5QkFBeUIsQ0FBQztRQUN2RSxJQUFJLENBQUMsVUFB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Q0FBQyxNQUFNLEVBQUUsQ0FBQztTQUM1QjtRQUVELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO0lBRzNCLENBQUM7O2dCQTFJSixVQUFVOzs7O2dCQUpVLHdCQUF3QjtnQkFBRSxRQUFROztJQStJdkQsK0JBQUM7Q0FBQSxBQTNJRCxJQTJJQztTQTFJWSx3QkFBd0I7Ozs7OztJQUVqQyw4Q0FBMEI7O0lBQzFCLGtEQUE2Qjs7Ozs7SUFDN0IsbURBQTBGOzs7OztJQUUxRiw2Q0FBeUI7O0lBRXpCLG1EQUFnQzs7Ozs7SUFDaEMsa0RBQTZDOzs7OztJQUNqQyx1Q0FBcUM7Ozs7O0lBQUUsNENBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBGYXJyaXNDb250ZXh0TWVudUNvbXBvbmVudCB9IGZyb20gJy4vY29udGV4dC1tZW51LmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IEluamVjdGFibGUsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgSW5qZWN0b3IsIENvbXBvbmVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBDb250ZXh0TWVudU9wdGlvbnMgfSBmcm9tICcuL21lbnUtaXRlbS5pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBPdmVyTGF5SGlkZGVuU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktY29tbW9uJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEZhcnJpc0NvbnRleHRNZW51U2VydmljZSB7XHJcblxyXG4gICAgcHJpdmF0ZSBvdmVybGF5RWxlID0gbnVsbDtcclxuICAgIHB1YmxpYyBjb250ZXh0TWVudURvbSA9IG51bGw7XHJcbiAgICBwcml2YXRlIGNvbnRleHRNZW51UmVmczogeyBba2V5OiBzdHJpbmddOiBDb21wb25lbnRSZWY8RmFycmlzQ29udGV4dE1lbnVDb21wb25lbnQ+IH0gPSB7fTtcclxuXHJcbiAgICBwcml2YXRlIGFjdGl2ZURvbSA9IG51bGw7XHJcblxyXG4gICAgc2hvd0NvbnRleHRNZW51ID0gbmV3IFN1YmplY3QoKTtcclxuICAgIHByaXZhdGUgb3ZlcmxheUhpZGVTZXI6IE92ZXJMYXlIaWRkZW5TZXJ2aWNlO1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBjZnI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuICAgICAgICB0aGlzLm92ZXJsYXlIaWRlU2VyID0gdGhpcy5pbmplY3Rvci5nZXQoT3ZlckxheUhpZGRlblNlcnZpY2UsIG51bGwpO1xyXG4gICAgICAgIGlmICghdGhpcy5vdmVybGF5SGlkZVNlcikge1xyXG4gICAgICAgICAgICB0aGlzLm92ZXJsYXlIaWRlU2VyID0gbmV3IE92ZXJMYXlIaWRkZW5TZXJ2aWNlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBjcmVhdGVPdmVybGF5KGNscz86IHN0cmluZywgb3B0cz86IENvbnRleHRNZW51T3B0aW9ucykge1xyXG4gICAgICAgIGxldCBvdmVybGF5RWxlOiBhbnkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZi1jb250ZXh0LW1lbnUtb3ZlcmxheScpO1xyXG4gICAgICAgIGlmICghb3ZlcmxheUVsZSkge1xyXG4gICAgICAgICAgICBvdmVybGF5RWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgICAgIG92ZXJsYXlFbGUuY2xhc3NMaXN0LmFkZCgnZi1jb250ZXh0LW1lbnUtb3ZlcmxheScsIGNscyk7XHJcblxyXG4gICAgICAgICAgICBvdmVybGF5RWxlLnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnbm9uZSc7XHJcblxyXG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG92ZXJsYXlFbGUpO1xyXG5cclxuICAgICAgICAgICAgaWYgKG9wdHMuaGlnaGxpZ2h0KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZURvbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVEb20uY2xhc3NMaXN0LmFkZCgnZi1jb250ZXh0LXRhcmdldC1mb2N1cycpO1xyXG4gICAgICAgICAgICAgICAgb3ZlcmxheUVsZS5hcHBlbmRDaGlsZCh0aGlzLmFjdGl2ZURvbSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIG92ZXJsYXlFbGUuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKChlLnRhcmdldCBhcyBhbnkpLmNsYXNzTmFtZS5pbmRleE9mKCdmLWNvbnRleHQtbWVudS1vdmVybGF5JykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIG92ZXJsYXlFbGUuYWRkRXZlbnRMaXN0ZW5lcignY29udGV4dG1lbnUnLCAoZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG92ZXJsYXlFbGU7XHJcbiAgICB9XHJcblxyXG4gICAgc2hvdyhvcHRpb25zOiBDb250ZXh0TWVudU9wdGlvbnMpIHtcclxuXHJcbiAgICAgICAgY29uc3QgeyBtZW51SXRlbXMsIGV2ZW50LCBpZCwgYWN0aXZlRG9tLCBjb250ZXh0LCBtZW51Q2xhc3MsIHRhcmdldCwgYWN0aXZlV2lkdGggfSA9IG9wdGlvbnM7XHJcbiAgICAgICAgbGV0IGNtcFJlZiA9IG51bGw7XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5jb250ZXh0TWVudVJlZnMpIHtcclxuICAgICAgICAgICAgdGhpcy5jb250ZXh0TWVudVJlZnMgPSB7fTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5jb250ZXh0TWVudVJlZnNbaWRdKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNtcEZhY3RvcnkgPSB0aGlzLmNmci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShGYXJyaXNDb250ZXh0TWVudUNvbXBvbmVudCk7XHJcbiAgICAgICAgICAgIGNtcFJlZiA9IGNtcEZhY3RvcnkuY3JlYXRlKHRoaXMuaW5qZWN0b3IpO1xyXG4gICAgICAgICAgICBjbXBSZWYuaW5zdGFuY2UubWVudUl0ZW1zID0gbWVudUl0ZW1zO1xyXG4gICAgICAgICAgICBjbXBSZWYuaW5zdGFuY2UuaWQgPSBpZDtcclxuXHJcbiAgICAgICAgICAgIGNtcFJlZi5pbnN0YW5jZS5sZWZ0ID0gZXZlbnQucGFnZVg7XHJcbiAgICAgICAgICAgIGNtcFJlZi5pbnN0YW5jZS50b3AgPSBldmVudC5wYWdlWTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuY29udGV4dE1lbnVEb20gPSBhY3RpdmVEb207XHJcbiAgICAgICAgICAgIHRoaXMuY29udGV4dE1lbnVSZWZzW2NtcFJlZi5pbnN0YW5jZS5pZF0gPSBjbXBSZWY7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY21wUmVmID0gdGhpcy5jb250ZXh0TWVudVJlZnNbaWRdO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY21wUmVmLmluc3RhbmNlLmNvbnRleHQgPSBjb250ZXh0O1xyXG5cclxuICAgICAgICB0aGlzLm92ZXJsYXlFbGUgPSB0aGlzLmNyZWF0ZU92ZXJsYXkobWVudUNsYXNzLCBvcHRpb25zKTtcclxuICAgICAgICB0aGlzLm92ZXJsYXlFbGUuYXBwZW5kQ2hpbGQoY21wUmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpO1xyXG5cclxuXHJcbiAgICAgICAgdGhpcy5vdmVybGF5SGlkZVNlci5yZWdpc3Rlck1vdXNlRXZlbnQodGhpcy5vdmVybGF5RWxlLCAoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChjbXBSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudC5jb250YWlucyhlLnRhcmdldCkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmhpZGUoKTtcclxuICAgICAgICB9KVxyXG5cclxuXHJcblxyXG4gICAgICAgIGlmICh0aGlzLmFjdGl2ZURvbSkge1xyXG4gICAgICAgICAgICAvLyBjb25zdCB3ID0gdGFyZ2V0Lm9mZnNldFdpZHRoID4gdGhpcy5jb250ZXh0TWVudURvbS5vZmZzZXRXaWR0aCA/IHRoaXMuY29udGV4dE1lbnVEb20ub2Zmc2V0V2lkdGggOiB0YXJnZXQub2Zmc2V0V2lkdGg7XHJcbiAgICAgICAgICAgIGNvbnN0IHcgPSBhY3RpdmVXaWR0aCB8fCB0aGlzLmNvbnRleHRNZW51RG9tLm9mZnNldFdpZHRoO1xyXG4gICAgICAgICAgICB0aGlzLmFjdGl2ZURvbS5zdHlsZS53aWR0aCA9ICB3ICsgJ3B4JztcclxuICAgICAgICAgICAgdGhpcy5hY3RpdmVEb20uc3R5bGUuaGVpZ2h0ID0gdGhpcy5jb250ZXh0TWVudURvbS5vZmZzZXRIZWlnaHQgKyAncHgnO1xyXG4gICAgICAgICAgICB0aGlzLmFjdGl2ZURvbS5zdHlsZS5sZWZ0ID0gdGFyZ2V0LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmxlZnQgKyAncHgnO1xyXG4gICAgICAgICAgICB0aGlzLmFjdGl2ZURvbS5zdHlsZS50b3AgPSB0aGlzLmNvbnRleHRNZW51RG9tLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcCArICdweCc7XHJcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlRG9tLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjbXBSZWYuY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpO1xyXG5cclxuICAgICAgICBjb25zdCBtZW51UGFuZWxEb20gPSBjbXBSZWYuaW5zdGFuY2UubWVudVBhbmVsLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgY29uc3QgbWVudVBhbmVsSGVpZ2h0ID0gIG1lbnVQYW5lbERvbS5vZmZzZXRIZWlnaHQ7XHJcbiAgICAgICAgaWYgKHdpbmRvdy5pbm5lckhlaWdodCAtICBldmVudC5wYWdlWSA8IG1lbnVQYW5lbEhlaWdodCkge1xyXG4gICAgICAgICAgICBjbXBSZWYuaW5zdGFuY2UudG9wID0gZXZlbnQucGFnZVkgLSBtZW51UGFuZWxIZWlnaHQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAod2luZG93LmlubmVyV2lkdGggLSBldmVudC5wYWdlWCA8IG1lbnVQYW5lbERvbS5vZmZzZXRXaWR0aCkge1xyXG4gICAgICAgICAgICBjbXBSZWYuaW5zdGFuY2UubGVmdCA9IGV2ZW50LnBhZ2VYIC0gbWVudVBhbmVsRG9tLm9mZnNldFdpZHRoO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY21wUmVmLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcclxuICAgIH1cclxuXHJcbiAgICBoaWRlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLm92ZXJsYXlFbGUpIHtcclxuICAgICAgICAgICAgdGhpcy5vdmVybGF5RWxlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmNvbnRleHRNZW51UmVmcykge1xyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXModGhpcy5jb250ZXh0TWVudVJlZnMpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0TWVudVJlZnNba2V5XS5ob3N0Vmlldy5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHRNZW51UmVmcyA9IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIOenu+mZpERPTSDmoLflvI9cclxuICAgICAgICAgICAgaWYgKHRoaXMuY29udGV4dE1lbnVEb20pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dE1lbnVEb20uY2xhc3NOYW1lID0gdGhpcy5jb250ZXh0TWVudURvbS5jbGFzc05hbWUucmVwbGFjZSgnZi1jb250ZXh0LW1lbnUtYWN0aXZlJywgJycpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAgICAgdGhpcy5vdmVybGF5SGlkZVNlci5kZXN0b3J5KHRoaXMub3ZlcmxheUVsZSk7XHJcbiAgICAgICAgICAgIHRoaXMub3ZlcmxheUVsZS5yZW1vdmUoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuYWN0aXZlRG9tID0gbnVsbDtcclxuICAgICAgICB0aGlzLm92ZXJsYXlFbGUgPSBudWxsO1xyXG5cclxuICAgICAgICBcclxuICAgIH1cclxufVxyXG4iXX0=