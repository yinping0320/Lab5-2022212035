!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@farris/mobile-ui"),require("rxjs"),require("@farris/mobile-business-ui"),require("@farris/mobile-devkit"),require("rxjs/operators"),require("@farris/mobile-bef")):"function"==typeof define&&define.amd?define("@farris/mobile-command-services",["exports","@farris/mobile-ui","rxjs","@farris/mobile-business-ui","@farris/mobile-devkit","rxjs/operators","@farris/mobile-bef"],e):e(((t=t||self).farris=t.farris||{},t.farris["mobile-command-services"]={}),t.mobileUi,t.rxjs,t.mobileBusinessUi,t.mobileDevkit,t.rxjs.operators,t.mobileBef)}(this,(function(t,e,i,n,o,r,a){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var s=function(t,e){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};function c(t,e){function i(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var d=function(){return(d=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var o in e=arguments[i])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function u(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var n,o,r=i.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(n=r.next()).done;)a.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(i=r.return)&&i.call(r)}finally{if(o)throw o.error}}return a}function p(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(u(arguments[e]));return t}var l=function(){function t(t){this.viewModelContext=t}return t.prototype.getService=function(t){return this.viewModelContext.injector.get(t)},t}();var h=function(){function t(){this.registerService()}return t.prototype.show=function(t,i){e.Loading.show(t,i)},t.prototype.hide=function(){e.Loading.hide()},t.prototype.registerService=function(){var t=window.DEVKIT_LOADING_SERVICE||[];t.push(this),window.DEVKIT_LOADING_SERVICE=t},t}(),f=function(){function t(){}return t.prototype.info=function(t,i){e.Toast.info(t,i)},t.prototype.success=function(t,i){e.Toast.success(t,i)},t.prototype.warning=function(t,i){e.Toast.warning(t,i)},t.prototype.error=function(t,i){e.Toast.error(t,i)},t.prototype.show=function(t){e.Toast(t)},t}(),v=function(){function t(){}return t.prototype.info=function(t,i){e.Notify.info(t,d({duration:1500},i))},t.prototype.success=function(t,i){e.Notify.success(t,d({duration:1e3},i))},t.prototype.warning=function(t,i){e.Notify.warning(t,d({duration:1500},i))},t.prototype.error=function(t,i){e.Notify.error(t,d({duration:1500},i))},t.prototype.show=function(t){e.Notify.show(t)},t}(),g=function(){function t(){}return t.prototype.alert=function(t,n){var o=new Promise((function(i,o){e.Dialog.alert(d({title:"提醒",message:t,cancelText:"取消",confirmText:"确定",onConfirm:function(){i(!0)},onCancel:function(){i(!1)}},n))}));return i.from(o)},t.prototype.confirm=function(t){var e=this.confirmPromise(t);return i.from(e)},t.prototype.show=function(t){this.confirmPromise(t)},t.prototype.prompt=function(t,n){var o=new Promise((function(i,o){var r=e.Dialog.prompt(d({title:t,confirmText:"确定",onConfirm:function(){i(r.$data.promptText)},onCancel:function(){i("取消")},onShow:function(){console.log("显示弹窗")}},n))}));return i.from(o)},t.prototype.confirmPromise=function(t){return new Promise((function(i,n){e.Dialog.confirm({message:t,onConfirm:function(){i(!0)},onCancel:function(){i(!1)}})}))},t}(),y=function(){function t(){}return t.prototype.show=function(t){n.AttachmentPreview.show(t)},t}();var m=function(){function t(t){this.viewModelContext=t}return Object.defineProperty(t.prototype,"bindingData",{get:function(){return this.viewModelContext.bindingData},enumerable:!0,configurable:!0}),t.prototype.getPropValue=function(t){return this.bindingData.getValue(t)},t.prototype.getEntityData=function(t){var e=this.bindingData.getValue(t);return(e instanceof o.BindingList==!0?e.currentItem:e).toJSON()},t.prototype.getEntityListData=function(t){return this.bindingData.getValue(t).toJSON()},t}();var w=function(){function t(t){this.viewModelContext=t}return Object.defineProperty(t.prototype,"bindingData",{get:function(){return this.viewModelContext.bindingData},enumerable:!0,configurable:!0}),t.prototype.setPropValue=function(t,e){this.bindingData.setValue(t,e,!0,!0)},t}();var S=function(){function t(t){this.viewModelContext=t,this.traversingService=this.viewModelContext.injector.get(m)}return Object.defineProperty(t.prototype,"bindingData",{get:function(){return this.viewModelContext.bindingData},enumerable:!0,configurable:!0}),t.prototype.count=function(t){var e=this.splitPath(t);return this.traversingService.getEntityListData(e.listPath).length},t.prototype.sum=function(t){var e=this,i=this.splitPath(t);return this.traversingService.getEntityListData(i.listPath).reduce((function(t,n){var o=parseFloat(e.getPropValue(n,i.propPath));return t+=o=isNaN(o)?0:o}),0)},t.prototype.avg=function(t){var e=this.count(t),i=this.sum(t);return 0!==e?i/e:0},t.prototype.max=function(t){var e=this,i=this.splitPath(t),n=this.traversingService.getEntityListData(i.listPath).reduce((function(t,n){var o=parseFloat(e.getPropValue(n,i.propPath));return!1===isNaN(o)&&(!t||o>t)&&(t=o),t}),null);return n||0},t.prototype.min=function(t){var e=this,i=this.splitPath(t),n=this.traversingService.getEntityListData(i.listPath).reduce((function(t,n){var o=parseFloat(e.getPropValue(n,i.propPath));return!1===isNaN(o)&&(!t||o<t)&&(t=o),t}),null);return n||0},t.prototype.getPropValue=function(t,e){var i=t;return e.forEach((function(t){i=i?i[t]:null})),i},t.prototype.splitPath=function(t){for(var e=t.concat([]),i=[],n=this.bindingData.getValue(e);n instanceof o.BindingList!=!0;){var r=e.pop();if(!r)return;i.unshift(r),n=this.bindingData.getValue(e)}return{listPath:e,propPath:i}},t}();var b=function(t){this.viewModelContext=t};var C=function(){function t(t){this.viewModelContext=t,this.traversingService=new m(t),this.manipulationService=new w(t),this.aggregationService=new S(t)}return t.prototype.getPropValue=function(t){return this.traversingService.getPropValue(t)},t.prototype.setPropValue=function(t,e){return this.manipulationService.setPropValue(t,e)},t.prototype.getEntityData=function(t){return this.traversingService.getEntityData(t)},t.prototype.getEntityListData=function(t){return this.traversingService.getEntityListData(t)},t.prototype.count=function(t){return this.aggregationService.count(t)},t.prototype.sum=function(t){return this.aggregationService.sum(t)},t.prototype.avg=function(t){return this.aggregationService.avg(t)},t.prototype.max=function(t){return this.aggregationService.max(t)},t.prototype.min=function(t){return this.aggregationService.min(t)},t}();var I={Info:1,Success:2,Redirect:3,ClientError:4,ServerError:5};I[I.Info]="Info",I[I.Success]="Success",I[I.Redirect]="Redirect",I[I.ClientError]="ClientError",I[I.ServerError]="ServerError";var x=function(){function t(){}return t.getHttpStatusType=function(t){if(!t)return null;var e=null;return t<100||t>600?e=null:t>=100&&t<200?e=I.Info:t>=200&&t<300?e=I.Success:t>=300&&t<400?e=I.Redirect:t>=400&&t<500?e=I.ClientError:t>=500&&t<600&&(e=I.ServerError),e},t}(),P=function(){function t(t,e){this.notifyService=t,this.jsBridgeService=e}return t.prototype.show=function(t){this.exception(t)},t.prototype.exception=function(t){var e=this;if(t.message&&-1!==t.message.indexOf("401"))return this.notifyService.error("登录信息已失效请重新打开"),void setTimeout((function(){e.jsBridgeService.closeWindow()}),2e3);t&&t.response&&this.httpErrorHandler(t.response)},t.prototype.httpErrorHandler=function(t){if(t)switch(x.getHttpStatusType(t.status)){case I.ClientError:this.httpErrorInClient(t);break;case I.ServerError:this.httpErrorInServer(t);break;default:throw new Error("Get invalid status code when using httpErrorHandler method.")}},t.prototype.httpErrorInServer=function(t){var e=t.data;if("string"==typeof e)try{e=JSON.parse(e)}catch(t){}if(e&&null!=e.Level&&null!=e.Level){var i=this.getNotifyServiceMethodName(e.Level);this.notifyService[""+i](e.Message)}else this.notifyService.error(t.message)},t.prototype.httpErrorInClient=function(t){if(t){var e=t.config&&t.config.url&&t.config.url,i=t.status&&t.status;this.notifyService.error(e+" "+i)}},t.prototype.getNotifyServiceMethodName=function(t){var e;switch(t){case 0:e="info";break;case 1:e="warning";break;case 2:e="error";break;case 3:e="fatal";break;default:e="error"}return e},t}();var M=function(){function t(t){this.viewModelContext=t,this.init()}return t.prototype.init=function(){this.initServices()},t.prototype.initServices=function(){this.loadingService=this.getService(h),this.toastService=this.getService(f),this.notifyService=this.getService(v),this.dialogService=this.getService(g),this.exceptionService=this.getService(P),this.entityService=this.getService(C),this.befRepository=this.viewModelContext.repository},t.prototype.getService=function(t){return this.viewModelContext.injector.get(t)},t}();var D=function(){function t(){}return t.convertBindingPathToEntityPath=function(t,e){var i="/"+e.bindingData.list.currentId,n=t.split("/");if(n.length>0)for(var o=1;o<n.length-1;o++){var r=n[o],a=e.bindingData[r];if(!a||!a.currentId)throw Error("获取子表完整路径出错，找不到"+a+"对应的子表，或对应子表没有当前行。");i+="/"+r+"/"+a.currentId}return i+="/"+n[n.length-1]},t.clearFromValidateType=function(t){var e=t.appContext.viewModelContextManager.getContexts().filter((function(e){return e.parent&&t.id===e.parent.id}));e.length>=1&&e.forEach((function(t){t.form.resetFieldsValidate()}))},t.stringTransformArray=function(t){return this.parameIsThreeBoss(t)?[]:JSON.parse(t)},t.parameIsThreeBoss=function(t){return""===t||null==t},t}(),B=function(t){function e(e){return t.call(this,e)||this}return c(e,t),e.prototype.loadForList=function(t,e,i,n){var o=this;"string"==typeof t&&(t=D.stringTransformArray(t)),"string"==typeof e&&(e=D.stringTransformArray(e));var a=this.viewModelContext.repository.paginationInfo||{pageSize:null,pageIndex:null},s=a.pageSize,c=a.pageIndex;return this.loadingService.show(),i||s?i&&(s=i):s=20,n||c?n&&(c=n):c=1,1===c&&this.befRepository.entityCollection.clear(),this.befRepository.getEntities(t,e,s,c).pipe(r.tap((function(){var t=o.viewModelContext.repository.paginationInfo,e=t.pageIndex,i=t.pageCount,n=t.totalCount;e===i||0===n?o.viewModelContext.appContext.eventBus.triggerEvent({type:"listviewFinished"}):o.viewModelContext.appContext.eventBus.triggerEvent({type:"listviewUnFinished"}),o.viewModelContext.appContext.eventBus.triggerEvent({type:"loadDataFinished"}),o.loadingService.hide()}),(function(t){o.loadingService.hide()})))},e.prototype.loadForCard=function(t){var e=this;return D.clearFromValidateType(this.viewModelContext),this.loadingService.show(),this.befRepository.getEntityById(t).pipe(r.tap((function(){e.loadingService.hide()}),(function(t){e.loadingService.hide()})))},e.prototype.loadDataForChildCard=function(t){var e=this.viewModelContext.bindingData[t].id,i=this.viewModelContext.bindingData[t].parentID,n=this.viewModelContext.repository.entityCollection.getEntityById(i)[t].get(e).data;this.viewModelContext.uiState.setPropertyValue("$childEntity",d({},n))},e}(M),A=function(t){function e(e){return t.call(this,e)||this}return c(e,t),e.prototype.create=function(){var t=this;return this.befRepository.entityCollection.clear(),D.clearFromValidateType(this.viewModelContext),this.loadingService.show(),this.befRepository.createEntity().pipe(r.tap((function(){t.loadingService.hide()}),(function(e){t.loadingService.hide()})))},e.prototype.createByPath=function(t){var e=this;this.loadingService.show();var i=D.convertBindingPathToEntityPath(t,this.viewModelContext);return this.befRepository.appendEntityByPath(i).pipe(r.tap((function(i){e.viewModelContext.uiState.setPropertyValue("$isAdd",{status:!0,id:i.id,path:t,child:d({},i.data)}),e.loadingService.hide()}),(function(t){e.loadingService.hide()})))},e}(M),R=function(t){function e(e){return t.call(this,e)||this}return c(e,t),e.prototype.edit=function(t){var e=this;return this.loadingService.show(),this.befRepository.editEntityById(t).pipe(r.tap((function(){e.loadingService.hide()}),(function(t){e.loadingService.hide()})))},e}(M),T=function(t){function e(e){return t.call(this,e)||this}return c(e,t),e.prototype.update=function(t){var e=this;return this.loadingService.show(),this.befRepository.updateEntityById(t).pipe(r.tap((function(){e.loadingService.hide()}),(function(t){e.loadingService.hide()})))},e}(M),O=function(t){function e(e){return t.call(this,e)||this}return c(e,t),e.prototype.removeById=function(t){var e=this;return this.dialogService.confirm("是否删除").pipe(r.switchMap((function(n){return!1===n?i.EMPTY:(e.context&&e.context.eventParams&&e.context.eventParams.swipecellClose&&e.context.eventParams.swipecellClose(),e.cancelChanges(t))})))},e.prototype.cancelChanges=function(t){var e=this;return this.loadingService.show(),this.befRepository.removeEntityAndSaveById(t).pipe(r.tap((function(){e.notifyService.success("删除成功"),e.loadingService.hide()}),(function(){e.loadingService.hide(),e.notifyService.error("删除失败")})))},e.prototype.removeByIds=function(t){var e=this;if(!t){var n=this.context.eventParams;t=n.map((function(t){return t.id}))}return this.dialogService.confirm("是否删除").pipe(r.switchMap((function(n){return!1===n?i.EMPTY:(e.loadingService.show(),e.befRepository.removeEntitiesByIds(t))}))).pipe(r.tap((function(){e.loadingService.hide(),e.notifyService.success("删除成功")}),(function(t){e.loadingService.hide()})))},e.prototype.removeByPathAndId=function(t,e){var n=this;return this.dialogService.confirm("是否删除").pipe(r.switchMap((function(o){return!1===o?i.EMPTY:(n.context&&n.context.eventParams&&n.context.eventParams.swipecellClose&&n.context.eventParams.swipecellClose(),n.removeByPathAndIdChanges(t,e))})))},e.prototype.removeByPathAndIdChanges=function(t,e){var i=this;this.loadingService.show();var n=D.convertBindingPathToEntityPath(t,this.viewModelContext);return this.befRepository.removeEntityByPath(n,e).pipe(r.tap((function(){i.loadingService.hide(),i.notifyService.success("删除成功")}),(function(t){i.loadingService.hide(),console.error(t)})))},e.prototype.removeByPathAndIds=function(t,e){throw new Error("Not Implemented")},e.prototype.removeByBusinessIds=function(t,e){e||(e=this.context.eventParams.map((function(t){return t.id})));var i={params:{ids:e.join(",")},body:{dataChange:[],variableChange:null}};return this.befRepository.apiProxy.request(o.HttpMethods.PUT,t,i,!0)},e.prototype.removeByBusinessPathAndId=function(t,e,n){var a=this;return this.dialogService.confirm("是否删除").pipe(r.switchMap((function(e){return!1===e?i.EMPTY:a.befRepository.apiProxy.request(o.HttpMethods.PUT,t)})))},e.prototype.ClearStatusAfterchildCardSave=function(){return this.viewModelContext.uiState.setPropertyValue("$isAdd",null),this.viewModelContext.uiState.setPropertyValue("$childEntity",null),i.of(!0)},e}(M),E=function(t){function e(e){return t.call(this,e)||this}return c(e,t),e.prototype.save=function(){var t=this;return this.loadingService.show(),this.befRepository.saveEntities().pipe(r.tap((function(){t.loadingService.hide(),t.notifyService.success("保存成功")}),(function(e){t.loadingService.hide()})))},e.prototype.saveByPath=function(){var t=this;this.loadingService.show();var e=this.viewModelContext.bindingData.list.currentId;return this.befRepository.updateEntityById(e).pipe(r.map((function(){return!0})),r.tap((function(){t.viewModelContext.uiState.setPropertyValue("$isAdd",null),t.viewModelContext.uiState.setPropertyValue("$childEntity",null),t.loadingService.hide(),t.notifyService.success("保存成功")}),(function(e){t.loadingService.hide()})))},e}(M),N=function(t){function e(e){return t.call(this,e)||this}return c(e,t),e.prototype.cancel=function(){var t=this;return this.loadingService.show(),this.befRepository.cancelEntityChanges().pipe(r.tap((function(){t.loadingService.hide()}),(function(e){t.loadingService.hide()})))},e}(M),k=function(t){function e(e){var i=t.call(this,e)||this;return i.viewModelContext=e,i}return c(e,t),e.prototype.invokeAction=function(t,e,i,n,o){return this.innerInvokeAction(t,e,i,n,o)},e.prototype.innerInvokeAction=function(t,e,i,n,o){var a=this,s=this.befRepository.apiProxy,c=s.baseUrl+"/service/"+t,d={};return i&&(d.headers=i),n&&(d.params=n),o&&(d.body=o),this.loadingService.show(),s.request(e,c,d).pipe(r.tap((function(){a.loadingService.hide()}),(function(t){a.loadingService.hide(),console.log(t)})))},e}(M);var F=function(){function t(t,e){this.viewModelContext=e,this.wfTaskHandlerService=t,this.notifyService=this.getService(v)}return t.prototype.getService=function(t){return this.viewModelContext.injector.get(t)},t.prototype.submitApproveWithBizDefKeyUseControl=function(t,e,n,o){if(void 0===n&&(n={}),!t)return this.notifyService.error("业务单据Id不能为空"),i.EMPTY;if(!e)return this.notifyService.error("入口单据Id不能为空"),i.EMPTY;n&&"object"==typeof n||(n={});var r=d({dataId:t,bizDefKey:e},n);if(o){if(o.startsWith("{")&&o.endsWith("}"))try{o=JSON.parse(o)}catch(t){console.log("variables parse failed!"),o={}}r.variables=o}return this.wfTaskHandlerService&&this.wfTaskHandlerService.startProcess(r)},t.prototype.cancelSubmit=function(t){return t?this.wfTaskHandlerService&&this.wfTaskHandlerService.cancelSubmit({dataId:null,bizDefKey:null,procInstId:t}):(this.notifyService.error("流程实例Id不能为空"),i.EMPTY)},t.prototype.submitWithBizDefKey=function(t,e){return this.wfTaskHandlerService&&this.wfTaskHandlerService.submitWithBizDefKey(t,e)},t.prototype.cancelSubmitWithDataId=function(t,e){return this.wfTaskHandlerService&&this.wfTaskHandlerService.cancelSubmitWithDataId(t,e)},t.prototype.batchSubmitWithBizDefKey=function(t,e){return this.wfTaskHandlerService&&this.wfTaskHandlerService.batchSubmitWithBizDefKey(t,e)},t.prototype.batchCancelSubmitWithDataId=function(t,e){return this.wfTaskHandlerService&&this.wfTaskHandlerService.batchCancelSubmitWithDataId(t,e)},t.prototype.childSubmit=function(t,e,i){return this.wfTaskHandlerService&&this.wfTaskHandlerService.childSubmit(t,e,i)},t.prototype.childCancelSubmit=function(t,e,i){return this.wfTaskHandlerService&&this.wfTaskHandlerService.childCancelSubmit(t,e,i)},t.prototype.childBatchSubmit=function(t,e,i){return this.wfTaskHandlerService&&this.wfTaskHandlerService.childBatchSubmit(t,e,i)},t.prototype.childBatchCancelSubmit=function(t,e,i){return this.wfTaskHandlerService&&this.wfTaskHandlerService.childBatchCancelSubmit(t,e,i)},t}();var j=function(t){function e(e){return t.call(this,e)||this}return c(e,t),e.prototype.checkChangesBeforeLeave=function(){var t=this;return a.BefRepositoryUtil.isExistUnsaveData(this.befRepository)?this.dialogService.confirm("存在未保存的变更，确认离开当前页面？").pipe(r.switchMap((function(e){return!1===e?i.EMPTY:(t.loadingService.show(),t.befRepository.cancelEntityChanges().pipe(r.switchMap((function(){if(t.befRepository.apiProxy.associatedUrlMap.size>=1){var e=p(t.befRepository.apiProxy.associatedUrlMap.keys());return t.befRepository.apiProxy.request(o.HttpMethods.POST,e[0]+"/service/cancel")}return i.of(!0)})),r.tap((function(){t.loadingService.hide()}))))}))):i.of(!0)},e.prototype.checkChangesBeforeLeaveChild=function(){if(this.viewModelContext.uiState.$isAdd&&!0===this.viewModelContext.uiState.$isAdd.status){var t=this.viewModelContext.uiState.$isAdd.id,e=this.viewModelContext.uiState.$isAdd.path,n=this.viewModelContext.uiState.$isAdd.child,o=e.split("/"),r=void 0;if(o[0]&&1===o.length&&(r=this.viewModelContext.bindingData[o[0]]),o[0]||2!==o.length||(r=this.viewModelContext.bindingData[o[1]]),o.length>2){var a="";o[0]&&(a=o[0]);for(var s=1;s<o.length;s++)a+=o[s];r=this.viewModelContext.bindingData[a]}if(this.checkForVariationBetweenTheTwo(r,n))return i.of(!0);var c=D.convertBindingPathToEntityPath(e,this.viewModelContext);return this.befRepository.removeEntityByPath(c,t)}return i.of(!0)},e.prototype.checkForVariationBetweenTheTwo=function(t,e){for(var i=Object.keys(e),n=!1,o=0;o<i.length;o++)if("[object Object]"===Object.prototype.toString.call(e[i[o]])||"[object Array]"===Object.prototype.toString.call(e[i[o]])){if(JSON.stringify(e[i[o]])!==JSON.stringify(t[i[o]]))return!0}else if(e[i[o]]!==t[i[o]])return!0;return n},e.prototype.checkChangesBeforeLeaveAddOrEditChild=function(t){var e=this;if(this.viewModelContext.uiState.$isAdd&&!0===this.viewModelContext.uiState.$isAdd.status){var n=this.viewModelContext.uiState.$isAdd.id,o=this.viewModelContext.uiState.$isAdd.path,a=D.convertBindingPathToEntityPath(o,this.viewModelContext);return this.befRepository.removeEntityByPath(a,n).pipe(r.tap((function(){e.viewModelContext.uiState.setPropertyValue("$isAdd",null)})))}var s=this.viewModelContext.bindingData[t].id,c=this.viewModelContext.bindingData[t].parentID,d=this.viewModelContext.uiState.$childEntity;return d?(this.viewModelContext.repository.entityCollection.getEntityById(c)[t].get(s).load(d),i.of(!0)):i.of(!0)},e}(M),V=function(){function t(t,e,i){this.jsBridgeService=i,this.viewModelContext=t,this.router=e}return t.prototype.navigate=function(t,e,i,n){if(void 0===e&&(e={}),void 0===i&&(i={}),t){e=this.ParamsFromStringToObject(e),i=this.ParamsFromStringToObject(i);var o=this.sessionStorageSaveHistory(t,n,i);if(t&&o>=0){var r=this.splicePath(t,e);return window.location.href=r,!1}window.MOBILE_ORIGIN_BACK&&window.MOBILE_ORIGIN_BACK.reflushOriginGoback(),this.router.push({path:t,query:e})}},t.prototype.removeParams=function(t,e){var i=e.search("\\?");return(i=-1)&&(i=e.length),e.slice(t,i)},t.prototype.getsessionStorageSaveHistoryKey=function(t){var e=t.search("/apps");return t&&e>=0?this.removeParams(e,t):this.router.options.history.base+t},t.prototype.sessionStorageSaveHistory=function(t,e,i){var n=t.search("/apps"),o=this.getsessionStorageSaveHistoryKey(t),r={};if(e)return r=t.search("/apps")>=0?{routerWay:"href",path:e,query:i}:{routerWay:"Router",path:e,query:i},sessionStorage.setItem(o,JSON.stringify(r)),n;var a=this.router.currentRoute.value.path;return r=t&&n>=0?{routerWay:"href",path:a=this.router.options.history.base+this.router.options.history.location,query:i}:{routerWay:"Router",path:a,query:i},sessionStorage.setItem(o,JSON.stringify(r)),n},t.prototype.navigateForRtc=function(t,e,i,n){var o=this;void 0===e&&(e={}),void 0===i&&(i={}),e&&e.metadataId||this.navigate(t,e,i,n);var a={metadataId:e.metadataId,withDims:!1,dim1:e.dim1,dim2:e.dim2};delete e.metadataId,delete e.dim1,delete e.dim2,this.correctRtcOptions(a).pipe(r.map((function(e){return o.getExtendPath(t,e)}))).pipe(r.tap((function(t){o.navigate(t,e,i)}))).subscribe()},t.prototype.correctRtcOptions=function(t){var e=t.dim1||"public",i=t.dim2||"public",n={isRootMetadata:!0,metadataId:t.metadataId,dim1:e,dim2:i};return this.viewModelContext.injector.get(o.HttpClient).post("/api/runtime/bcc/v1.0/template/beforeNavigate",n,null).pipe(r.map((function(t){return{metadataId:t.metadataId,withDims:1===t.withDims,dim1:t.dim1,dim2:t.dim2}})))},t.prototype.getExtendPath=function(t,e){if(!1===e.withDims)return t;var i=t.split("index.html"),n=(e.dim1+"/"+e.dim2+"/index.html").toLowerCase();return i.join(n)},t.prototype.splicePath=function(t,e){var i=t,n=i.search("\\?");n>-1&&(i=i.slice(0,n));var o=Object.keys(e);return o.length>0&&(i+="?",o.forEach((function(t){i=i+t+"="+e[""+t]+"&"})),i=i.slice(0,i.length-1)),i},t.prototype.ParamsFromStringToObject=function(t){if("[object Object]"===Object.prototype.toString.call(t))return t;try{t=JSON.parse(t)}catch(e){t?(t={},console.error("路由传参params不是JSON串格式")):t={}}return"[object Object]"!==Object.prototype.toString.call(t)?{}:t},t.prototype.navigateReplace=function(t,e){void 0===e&&(e={}),"string"==typeof e&&(e=JSON.parse(e)),this.router.replace({path:t,query:e})},t.prototype.goBack=function(t){t=this.ParamsFromStringToObject(t);var e=this.router.options.history.base+this.router.currentRoute.value.path,i=sessionStorage.getItem(e);if(i){var n=Object.keys(t);if((i=JSON.parse(i))&&"Router"===i.routerWay){var o=i.query;n.length>0&&(o=d({},o,t)),this.router.push({query:o,path:i.path})}if(i&&"href"===i.routerWay){o=i.query;n.length>0&&(o=d({},o,t));var r=i.path;r=this.splicePath(r,o),window.location.href=r}}else{if(window.top.location.pathname.indexOf("mobiletaskcenter")>-1)return;this.jsBridgeService.closeWindow()}},t.prototype.mappingToUIState=function(){var t={params:this.router.currentRoute.value.params,queryParams:this.router.currentRoute.value.query};this.viewModelContext.uiState.routerState=t},t}();var U=function(){function t(t){this.viewModelContext=t}return t.prototype.validateFields=function(t){return t?this.viewModelContext.appContext.viewModelContextManager.getContextById(t).form.validateFields():this.viewModelContext.form.validateFields()},t.prototype.handleValidateFields=function(t){var e=[];return t?e=this.viewModelContext.appContext.viewModelContextManager.getContextById(t).form.validateFields():this.viewModelContext.appContext.viewModelContextManager.getRootContextAndPosterityById(this.viewModelContext.id).forEach((function(t){e=e.concat(t.form.validateFields())})),0===e.length?i.of(!0):i.zip.apply(void 0,p(e)).pipe(r.switchMap((function(t){return t.findIndex((function(t){return!1===t.passing}))>-1?i.EMPTY:i.of(!0)})))},t.prototype.getFieldError=function(t,e){return e?this.viewModelContext.appContext.viewModelContextManager.getContextById(e).form.getFieldError(t):this.viewModelContext.form.getFieldError(t)},t.prototype.resetFieldsValidate=function(t,e){if(t&&"string"==typeof t&&(t=JSON.parse(t)),e)return this.viewModelContext.appContext.viewModelContextManager.getContextById(e).form.resetFieldsValidate(t);this.viewModelContext.appContext.viewModelContextManager.getRootContextAndPosterityById(this.viewModelContext.id).forEach((function(e){e.form.resetFieldsValidate(t)}))},t}();var _=function(){function t(){}return t.prototype.init=function(t){window.top.iCityBridge.init(t)},t.prototype.takePhoto=function(t){void 0===t&&(t={quality:"mid"});var e=new i.Subject;return window.top.iCityBridge.ccworkGetPicsFromCameraAndAlbum(d({},t),(function(t){t&&e.next(t.result)})),e},t.prototype.scanQRCode=function(){var t=new i.Subject;return window.top.iCityBridge.ccworkScanCode({},(function(e){e&&t.next(e.result)})),t},t.prototype.getSysInfo=function(){},t.prototype.getLocation=function(){var t=new i.Subject;return window.top.iCityBridge.ccworkGetLocation((function(e){e&&t.next(e.result)})),t},t.prototype.selectFile=function(){var t=new i.Subject;return t.next([]),t},t.prototype.sendSMS=function(t,e){var i={numbers:[t],content:e};window.top.iCityBridge.ccworkSendSms(i)},t.prototype.openSendSMS=function(t,e){window.top.iCityBridge.sendSMS({tel:t,msg:e})},t.prototype.tel=function(t){window.top.iCityBridge.ringUp(t)},t.prototype.selectPictureFromAlbum=function(t){void 0===t&&(t={maxNum:9,mType:0});var e=new i.Subject;return window.top.iCityBridge.ccworkGetPicsFromAlbum(t,(function(t){t&&e.next(t.result)})),e},t.prototype.takeVideo=function(t){var e=new i.Subject;return window.top.iCityBridge.ccworkTakeShortVideo(d({time:15},t),(function(t){t&&e.next(t.result)})),e},t.prototype.closeWindow=function(){window.top.iCityBridge.closeWebView()},t.prototype.setTitles=function(t){window.top.iCityBridge.setTitle(t)},t.prototype.downloadFile=function(t){alert("暂不支持附件下载")},t.prototype.setOriginGoback=function(t){window.top.iCityBridge.ccworkInterceptOriginGoback(!!t,t,(function(){}))},t.prototype.pushOriginGoback=function(t){window.OriginGoback=window.OriginGoback||[];t&&(window.OriginGoback.push(t),window.top.iCityBridge.ccworkInterceptOriginGoback(!0,(function(){var t=window.OriginGoback.pop();t?t():(window.top.iCityBridge.ccworkInterceptOriginGoback(!1,(function(){}),(function(){})),history.back())}),(function(){})))},t.prototype.popOriginGoback=function(t){window.OriginGoback.pop()},t.prototype.playShortVideo=function(t){window.top.iCityBridge.ccworkPlayShortVideo(t)},t}(),H=function(){function t(){}return t.prototype.playShortVideo=function(t){throw new Error("Method not implemented.")},t.prototype.takePhoto=function(t){void 0===t&&(t={quality:75,encodingType:0,targetWidth:600,targetHeight:600});var e=new i.Subject;return window.imp.iCamera.open(t,(function(t){t&&t.originalData&&e.next(t.originalData)}),(function(t){if(t)return console.log("takePhoto",t),void e.next([])})),e},t.prototype.scanQRCode=function(){var t=new i.Subject;return console.log("调用二维码"),window.imp.iBarCode.scan((function(e){e&&(console.log("二维码回调"),t.next(e))})),t},t.prototype.getLocation=function(){var t=new i.Subject;return window.imp.iGps.getInfo((function(e){if(e){var i=e.latitude,n=e.longitude,o=e.addr,r=e.city,a=e.country,s=e.district,c=e.province,d=e.street,u=e.streetNum;t.next({addr:o,city:r,country:a,district:s,province:c,street:d,streetNum:u,lat:i,lng:n})}})),t},t.prototype.getSysInfo=function(){var t=new i.Subject;return window.imp.iDevice.sysInfo((function(e){e&&t.next(e)})),t},t.prototype.sendSMS=function(t,e){window.imp.iSms.send(t,e)},t.prototype.openSendSMS=function(t,e){window.imp.iSms.open(t,e)},t.prototype.tel=function(t){window.imp.iTel.dial(t)},t.prototype.selectPictureFromAlbum=function(t){void 0===t&&(t={maxNum:9,mType:0});var e={num:9,quality:75,destinationType:0,encodingType:1,targetWidth:600,targetHeight:600};e.num=t.maxNum;var n=new i.Subject;return window.imp.iCamera.select(d({},e,t),(function(t){t&&n.next(t.map((function(t){return t.originalData})))}),(function(t){t&&(console.log("selectPictureFromAlbum",t),n.next([]))})),n},t.prototype.selectFileFromMobile=function(t){void 0===t&&(t={maximum:6,fileType:".jpg|.png"})},t.prototype.getBase64=function(t){var e=new i.Subject;return window.imp.iFile.getBase64(t,(function(t){t&&e.next(t)}),(function(t){t&&(console.log("getBase64",t),e.next([]))})),e},t.prototype.selectFile=function(t){void 0===t&&(t={maximum:6});var e=new i.Subject;return window.imp.iFile.select(d({},t),(function(t){if(t&&t.length>0){var i=[],n=0;t.forEach((function(o){window.imp.iFile.getBase64(o.path,(function(o){i.push({name:t[n].name,size:t[n].size,base64:o}),n++,t.length===i.length&&e.next(i)}),(function(t){t&&(console.log("getBase64",t),e.next([]))}))}))}}),(function(t){t&&(console.log("selectFile",t),e.next([]))})),e},t.prototype.takeVideo=function(t){var e={id:t.id};t.quality?t.quality<=.5?e.fps=30:t.quality<=1&&(e.fps=60):e.fps=30;var n=new i.Subject;return window.imp.iVideo.record(e,(function(t){t&&n.next(t)}),(function(t){t&&(console.log("takeVideo",t),n.next([]))})),n},t.prototype.closeWindow=function(){window.imp.iWindow.close()},t.prototype.setTitles=function(t){document.title=t},t.prototype.downloadFile=function(t){var e=new i.Subject;return window.imp.iFile.download(t,(function(t){1!==t.status&&console.log(t),e.next(!0)})),e},t.prototype.setOriginGoback=function(t){var e=function(t,e){for(var i=t.length>e.length?e.length:t.length,n=0;n<i;n++)if(parseInt(e[n])>parseInt(t[n]))return!1;return!0},i=function(){t?(window.imp.iWindow.onBackKeyDown2(t),e(o.split("."),n.split("."))&&window.imp.iWindow.onTitleBackKeyDown2(t)):(window.imp.iWindow.cancelBackKeyDown(),e(o.split("."),n.split("."))&&window.imp.iWindow.cancelTitleBackKeyDown())},n="4.8.21",o=window.CURRENT_VERSION;o?i():window.imp.iDevice.sysInfo((function(t){var e=t.appVersion.split("-");window.CURRENT_VERSION=e[0],o=window.CURRENT_VERSION,i()}))},t.prototype.pushOriginGoback=function(t){window.OriginGoback=window.OriginGoback||[];var e=function(){var t=window.OriginGoback.pop();t?t():(window.imp.iWindow.cancelBackKeyDown(),window.imp.iWindow.cancelTitleBackKeyDown(),history.back())};t&&(window.OriginGoback.push(t),window.imp.iWindow.onBackKeyDown2(e),window.imp.iWindow.onTitleBackKeyDown2(e))},t.prototype.popOriginGoback=function(){window.OriginGoback.pop()},t}(),L=function(){function t(){}return t.prototype.create=function(){return-1!==navigator.userAgent.toLowerCase().search("ccwork")?(window.top.FARRIS_JSBridge="云上协同",new _):-1!==navigator.userAgent.toLowerCase().search("emmcloud")?(window.top.FARRIS_JSBridge="云加",new H):(window.top.FARRIS_JSBridge="浏览器",new H)},t}(),J=function(){function t(){this.jsBridgeStrategyFactory=new L,this.init()}return t.prototype.getSysInfo=function(){return this.getJsBridgeService(this.strategy.getSysInfo)},t.prototype.init=function(){this.strategy=this.jsBridgeStrategyFactory.create(),window.JsBridgeService=this},t.prototype.takePhoto=function(t){return this.getJsBridgeService(this.strategy.takePhoto,t)},t.prototype.scanQRCode=function(){return this.getJsBridgeService(this.strategy.scanQRCode)},t.prototype.getLocation=function(){return this.getJsBridgeService(this.strategy.getLocation)},t.prototype.sendSMS=function(t,e){return this.getJsBridgeService(this.strategy.sendSMS,t,e)},t.prototype.openSendSMS=function(t,e){return this.getJsBridgeService(this.strategy.openSendSMS,t,e)},t.prototype.tel=function(t){return this.getJsBridgeService(this.strategy.tel,t)},t.prototype.selectPictureFromAlbum=function(t){return this.getJsBridgeService(this.strategy.selectPictureFromAlbum,t)},t.prototype.takeVideo=function(t){return this.getJsBridgeService(this.strategy.takeVideo,t)},t.prototype.closeWindow=function(){return this.getJsBridgeService(this.strategy.closeWindow)},t.prototype.setTitles=function(t){return this.getJsBridgeService(this.strategy.setTitles,t)},t.prototype.selectFile=function(t){return this.getJsBridgeService(this.strategy.selectFile,t)},t.prototype.downloadFile=function(t){return this.getJsBridgeService(this.strategy.downloadFile,t)},t.prototype.setOriginGoback=function(t){return this.getJsBridgeService(this.strategy.setOriginGoback,t)},t.prototype.pushOriginGoback=function(t){return this.getJsBridgeService(this.strategy.pushOriginGoback,t)},t.prototype.popOriginGoback=function(t){return this.getJsBridgeService(this.strategy.popOriginGoback,t)},t.prototype.playShortVideo=function(t){return this.getJsBridgeService(this.strategy.playShortVideo,t)},t.prototype.getJsBridgeService=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];var o=new i.Subject;if("已加载"===window.top.FARRIS_JSBridge)return t.apply(void 0,p(e));if("云上协同"===window.top.FARRIS_JSBridge){if(window.top.iCityBridge)return t.apply(void 0,p(e));var r=window.top.document.createElement("script");r.src="https://ccwork.oss.cn-north-3.inspurcloudoss.com/h5/ccworkJsbridge.js",r.onload=function(){window.top.iCityBridge.init((function(){t.apply(void 0,p(e)).subscribe((function(t){o.next(t)}))}))},window.top.document.head.appendChild(r)}return"云加"===window.top.FARRIS_JSBridge&&System.import("/platform/common/web/imp.js").then((function(i){window.top.FARRIS_JSBridge="已加载",t.apply(void 0,p(e)).subscribe((function(t){o.next(t)}))})),o},t}();var G=function(){function t(){}return t.prototype.init=function(){window.MOBILE_ORIGIN_BACK_ARRAY=window.MOBILE_ORIGIN_BACK_ARRAY||[],window.MOBILE_ORIGIN_BACK={pushOriginGoback:function(t){window.MOBILE_ORIGIN_BACK_ARRAY.push(t)},popOriginGoback:function(){window.MOBILE_ORIGIN_BACK_ARRAY.pop()},reflushOriginGoback:function(){window.MOBILE_ORIGIN_BACK_ARRAY=[]}}},t.prototype.pushOriginGoback=function(t){window.MOBILE_ORIGIN_BACK_ARRAY.push(t)},t.prototype.popOriginGoback=function(){window.MOBILE_ORIGIN_BACK_ARRAY.pop()},t.prototype.reflushOriginGoback=function(){window.MOBILE_ORIGIN_BACK_ARRAY=[]},t.prototype.proxyBack=function(){if(-1!==navigator.userAgent.toLowerCase().search("emmcloud"))if(window.top.location.pathname.indexOf("mobiletaskcenter")>-1)setTimeout((function(){window.top.detailBackBtnClickHandler=function(t){var e=window.MOBILE_ORIGIN_BACK_ARRAY.pop();if(e)return e(),!1;var i=location.pathname+location.hash.slice(0,location.hash.indexOf("?"));return!sessionStorage.getItem(i)||(history.back(),!1)}}),0);else{(new J).setOriginGoback((function(){var t=window.MOBILE_ORIGIN_BACK_ARRAY.pop();t?t():history.back()}))}},t}(),W=function(){function t(t){this.viewModelContext=t}return t.prototype.execute=function(t,e){if(!t||""===t||"undefined"===t)return i.EMPTY;if("noop"===t.toLocaleLowerCase())return i.EMPTY;var n=this.viewModelContext.viewModel;e&&(n=this.viewModelContext.appContext.viewModelContextManager.getContextById(e).viewModel);return n[t]()},t}();var K=function(){function t(t){this.viewModelContext=t}return t.prototype.executeAction=function(t){return t?"function"!=typeof this.viewModelContext.stateMachine[t]?i.EMPTY:void this.viewModelContext.stateMachine[t]():i.EMPTY},t}();var z=function(){},q=function(){function t(t){this.viewModelContext=t}return t.prototype.setValue=function(t,e){this.viewModelContext.repository.variableManager.setValue(t,e)},t.prototype.getValue=function(t){this.viewModelContext.repository.variableManager.getValue(t)},t}();var Y=function(){function t(){}return t.convertToAttachmentInfos=function(t){var e=this;return t?t.map((function(t){return e.convertToAttachmentInfo(t)})):[]},t.convertToAttachmentInfo=function(t){return{attachmentId:t.metadataId,fileName:t.fileName}},t.getFirstAttachmentInfo=function(t){if(t&&0!==t.length)return t[0]},t.peekAttachmentIds=function(t){return t||(t=[]),t.map((function(t){return t.attachmentId}))},t}(),$=function(){function t(t){this.viewModelContext=t}return Object.defineProperty(t.prototype,"befRepository",{get:function(){return this.viewModelContext.repository},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bindingData",{get:function(){return this.viewModelContext.bindingData},enumerable:!0,configurable:!0}),t.prototype.updateRow=function(t,e){var i=this,n=this.befRepository.apiProxy,a=n.baseUrl+"/service/updateattachment",s={body:{updateAttachInfo:this.createUpdateAttachInfo(t,e)}};return console.log("loading show ..."),n.request(o.HttpMethods.PUT,a,s).pipe(r.switchMap((function(t){return i.syncAttachmentInfosToClient()})),r.tap((function(){console.log("loading hide ...")})))},t.prototype.updateRows=function(t,e){var i=this,n=this.befRepository.apiProxy,a=n.baseUrl+"/service/batchuploadattachment",s=this.createBatchCreateAttachInfo(t,e),c=0===s.NodeCodes.length,d={body:{batchUploadInfo:s}};return console.log("loading show ..."),n.request(o.HttpMethods.PUT,a,d).pipe(r.switchMap((function(t){return i.appendAttachmentInfosToClient(t,c)})),r.tap((function(){console.log("hide loading ...")})))},t.prototype.createUpdateAttachInfo=function(t,e){var i=e.attachmentId,n=o.BindingPathConverter.toBindingPathArray(t);return n.pop(),{NodeCodes:a.BefDataPathUtil.convertToObjectCodes(n,this.bindingData),HiretryIds:a.BefDataPathUtil.convertToDataIdsForUpdate(n,this.bindingData),AttachmentIds:[i],AttachmentId:i}},t.prototype.createBatchCreateAttachInfo=function(t,e){var i=Y.peekAttachmentIds(e),n=o.BindingPathConverter.toBindingPathArray(t);return n.pop(),{NodeCodes:a.BefDataPathUtil.convertToObjectCodes(n,this.bindingData),HiretryIds:a.BefDataPathUtil.convertToDataIdsForAdd(n,this.bindingData),AttachmentIds:i,AttachmentId:null}},t.prototype.syncAttachmentInfosToClient=function(){var t=this.bindingData.list.currentId;return this.befRepository.updateEntityById(t)},t.prototype.appendAttachmentInfosToClient=function(t,e){var n=this;if(!0===e){var a=this.befRepository.buildEntities(t);return this.befRepository.entityCollection.addEntities(a),i.of(t)}return this.syncAttachmentInfosToClient().pipe(r.map((function(){return n.befRepository.dataChangeHistory.addChange({dataId:t[0].id,changeType:o.DataChangeType.Add}),t})))},t}();var Q=function(){function t(t,e,i,n){this.defaultRootDirId="default-root",this.viewModelContext=t,this.attachDataService=n,this.entityService=e,this.removeDataService=i}return Object.defineProperty(t.prototype,"defaultParentDirName",{get:function(){return this.viewModelContext.bindingData.list.currentId},enumerable:!0,configurable:!0}),t.prototype.uploadAndUpdateRow=function(t,e,n){var o=e||this.defaultRootDirId,a=n||this.defaultParentDirName;if(!o||!a)throw new Error("rootDirId和parentDirName不能为空，请填写");var s=this.getUploadFileInfosFromContext(),c=Y.convertToAttachmentInfos(s);if(!c||0===c.length)return alert("请先上传附件"),i.EMPTY;console.log("show loading ...");var d=Y.getFirstAttachmentInfo(c);return this.attachDataService.updateRow(t,d).pipe(r.tap((function(){console.log("hide loading ...")})))},t.prototype.uploadAndBatchAddRows=function(t,e,n){var o=e||this.defaultRootDirId,a=n||this.defaultParentDirName;if(!o||!a)throw new Error("rootDirId和parentDirName不能为空，请填写");var s=this.getUploadFileInfosFromContext(),c=Y.convertToAttachmentInfos(s);return c&&0!==c.length?(console.log("show loading ..."),this.attachDataService.updateRows(t,c).pipe(r.tap((function(){console.log("hide loading ...")})))):(alert("请先上传附件"),i.EMPTY)},t.prototype.removeAttachmentRows=function(t){var e=this;if(!t)return i.EMPTY;var n=this.getDataIdsToRemove(t);if(t.split("/").length<=2)return this.removeDataService.removeByIds(n);var o=[];0===n.length&&alert("请选择要删除的文件");var r=this.getBindingListPathWithAttachments(t);return n.forEach((function(t){var i=e.removeDataService.removeByPathAndId(r,t);o.push(i)})),i.forkJoin(o)},t.prototype.getUploadFileInfosFromContext=function(){var t=this.context.eventParams;return t||[]},t.prototype.getDataIdsToRemove=function(t){var e=this,i=this.getAttachmentIdsToRemoveFromContext(),n=[];return i.forEach((function(i){var o=e.convertAttachmentIdToDataId(i,t);n.push(o)})),n},t.prototype.getAttachmentIdsToRemoveFromContext=function(){return this.context.eventParams},t.prototype.convertAttachmentIdToDataId=function(t,e){var i=o.BindingPathConverter.toBindingPathArray(e),n=i.pop(),r=i;return this.entityService.getEntityListData(r).find((function(e){if(e[n]&&e[n].attachmentId===t)return!0})).id},t.prototype.getBindingListPathWithAttachments=function(t){var e=o.BindingPathConverter.toBindingPathArray(t);return e.pop(),"/"+e.join("/")},t}();var X=function(){function t(){}return t.prototype.closeCcWorkWebView=function(){window.iCityBridge.closeWebView()},t.prototype.hideCcWorkNaviBar=function(){window.iCityBridge.hideTitleBar()},t.prototype.setTitle=function(t){window.iCityBridge.setTitle(t)},t.prototype.getLocation=function(t){window.iCityBridge&&window.iCityBridge.ccworkGetLocation(t)},t.prototype.scanCode=function(t,e){if(void 0===e&&(e={}),window.iCityBridge){var i=d({filters:["QR","EAN13","EAN8"],path:""},e);window.iCityBridge.ccworkScanCode(i,t)}},t.prototype.callPhone=function(t,e){if(window.iCityBridge){var i={number:t};window.iCityBridge.ccworkCallPhone(i,e)}},t.prototype.getPicsFromCameraAndAlbum=function(t,e){window.iCityBridge&&window.iCityBridge.ccworkGetPicsFromCameraAndAlbum(t,e)},t}(),Z=function(){function t(){}return t.prototype.getStaticMap=function(t){if(t&&t.location){t.key||(t.key="e01c849062d312e0cbeb2beb1f28ef71"),t.zoom||(t.zoom=10),t.size||(t.size={width:400,height:400});var e=t.markers,i="";e&&e.length&&(i=e.reduce((function(t,e,i){return t+=e.longtitude+","+e.latitude+";"}),""),t.markerSize||(t.markerSize="mid"),t.markerColor||(t.markerColor=""),i&&(i="&markers="+t.markerSize+","+t.markerColor+",A:"+i.substring(0,i.length-1)));var n=t.location.longtitude,o=t.location.latitude,r=n.toString(),a=o.toString();return r.substring(r.indexOf(".")+1).length>6&&(n=n.toFixed(6)),a.substring(a.indexOf(".")+1).length>6&&(o=o.toFixed(6)),"https://restapi.amap.com/v3/staticmap?location="+n+","+o+"&zoom="+t.zoom+"&size="+t.size.width+"*"+t.size.height+i+"&key="+t.key}},t}();var tt=function(){function t(){}return t.convertToAttachmentInfos=function(t){var e=this;return t?t.map((function(t){return e.convertToAttachmentInfo(t)})):[]},t.convertToAttachmentInfo=function(t){return{attachmentId:t.metadataId,fileName:t.fileName}},t.getFirstAttachmentInfo=function(t){if(t&&0!==t.length)return t[0]},t.peekAttachmentIds=function(t){return t||(t=[]),t.map((function(t){return t.attachmentId}))},t.getChangeDetails=function(t,e){var i=this,n=[];return e.forEach((function(e){var o=t.find((function(t){return t.id===e.id}));o||(o={});var r=i.getChangeDetail(o,e);r&&n.push(r)})),n},t.getChangeDetail=function(t,e){var i={ChangeType:a.ChangeDetailType.Modify,ChangeInfo:{DataId:e.id}},n=!1;return Object.keys(e).forEach((function(o){if("id"!==o&&"nodeCode"!==o&&"childs"!==o){var r=t[o],a=e[o];void 0===r&&"object"==typeof a||JSON.stringify(r)!==JSON.stringify(a)&&(i.ChangeInfo[o]=a,n=!0)}})),n?i:null},t}(),et=function(){function t(t){this.viewModelContext=t}return Object.defineProperty(t.prototype,"befReposi",{get:function(){return this.viewModelContext.repository},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bindingData",{get:function(){return this.viewModelContext.bindingData},enumerable:!0,configurable:!0}),t.prototype.getAllBeSessions=function(){var t=window.sessionStorage.getItem("BE_SESSION_ID");if(!t)return{};var e=this.getUserSessionId();return JSON.parse(t)[e+"_/api/gsp/common/v1.0/testForm_mfrm"]},t.prototype.getUserSessionId=function(){return window.localStorage.getItem("sessionId")},t.prototype.handleRequestHeaders=function(t){var e=this.getUserSessionId(),i=this.getAllBeSessions();return e&&(t=o.HttpUtil.appendHeader(t,"X-CAF-Runtime-CommonVariable",e)),i&&(t=o.HttpUtil.appendHeader(t,"X-CAF-Runtime-Context",i),t=o.HttpUtil.appendHeader(t,"SessionId",i)),t=o.HttpUtil.appendHeader(t,"Content-Type","application/json")},t.prototype.extendQueryData=function(t){var e={params:{entityFilter:JSON.stringify({FilterConditions:[],SortConditions:[],IsUsePagination:!1,Pagination:{PageIndex:1,PageSize:5,PageCount:0,TotalCount:0}})}};return this.befReposi.apiProxy.request(o.HttpMethods.PUT,t,e)},t.prototype.updateRow=function(t,e){var i=this.befReposi.apiProxy,n=i.baseUrl+"/service/updateattachment",r={body:{updateAttachInfo:this.createUpdateAttachInfo(t,e)}};return i.request(o.HttpMethods.PUT,n,r)},t.prototype.updateRows=function(t,e,i){var n=this.befReposi.apiProxy,r=this.createBatchCreateAttachInfo(e,i),a=(r.NodeCodes.length,{body:{batchUploadInfo:r}});return n.request(o.HttpMethods.PUT,t,a,!0)},t.prototype.createUpdateAttachInfo=function(t,e){var i=e.attachmentId,n=o.BindingPathConverter.toBindingPathArray(t);return n.pop(),{NodeCodes:a.BefDataPathUtil.convertToObjectCodes(n,this.bindingData),HiretryIds:a.BefDataPathUtil.convertToDataIdsForUpdate(n,this.bindingData),AttachmentIds:[i],AttachmentId:i}},t.prototype.createBatchCreateAttachInfo=function(t,e){var i=tt.peekAttachmentIds(e),n=o.BindingPathConverter.toBindingPathArray(t);return n.pop(),{NodeCodes:a.BefDataPathUtil.convertToObjectCodes(n,this.bindingData),HiretryIds:a.BefDataPathUtil.convertToDataIdsForAdd(n,this.bindingData),AttachmentIds:i,AttachmentId:null}},t.prototype.syncAttachmentInfosToClient=function(){var t=this.bindingData.list.currentId;return this.befReposi.updateEntityById(t)},t.prototype.appendAttachmentInfosToClient=function(t,e){if(!0===e){var n=this.befReposi.buildEntities(t);return this.befReposi.entityCollection.addEntities(n),i.of(t)}return this.syncAttachmentInfosToClient().pipe(r.map((function(){return t})))},t}();var it=function(){function t(t,e,i,n){this.defaultRootDirId="default-root",this.viewModelContext=t,this.attachDataService=n,this.entityService=e,this.removeDataService=i}return Object.defineProperty(t.prototype,"defaultParentDirName",{get:function(){return this.viewModelContext.bindingData.list.currentId},enumerable:!0,configurable:!0}),t.prototype.loadAttachmentRows=function(t,e,i){var n=this.getAttachContext(),a=this.viewModelContext.repository,s=a.sessionService,c=a.apiProxy,d={};"string"==typeof e&&(e=JSON.parse(e)),"string"==typeof i&&(i=JSON.parse(i));var u={FilterConditions:e||null,SortConditions:i||null,IsUsePagination:!1,Pagination:{PageIndex:1,PageSize:0,PageCount:0,TotalCount:0}},p=JSON.stringify(u);d.entityFilter=p;var l={dataChange:[],variableChange:null};return a.apiProxy.setAssociatedUrl(t),this.waitForBeSession().pipe(r.switchMap((function(){t+="/extension/query";var e={headers:s.extendRequestHeaders({}),params:d,body:l};return c.httpClient.request(o.HttpMethods.PUT,t,e).pipe(r.map((function(t){var e=t.returnValue.result;return n.setData(JSON.parse(JSON.stringify(e))),n.updateData(JSON.parse(JSON.stringify(e))),e})))})))},t.prototype.waitForBeSession=function(){return this.viewModelContext.repository.sessionService.getBeSessionExisted().pipe(r.filter((function(t){return!0===t})),r.take(1))},t.prototype.syncAttachmentRowChanges=function(t){var e=this.getAttachContext()||{},n=tt.getChangeDetails(e.oldListData,e.listData);if(!n||0===n.length)return i.of(!1);var a={body:{dataChange:n,variableChange:null}};return t=t+"/extension/retrieve/"+n[0].ChangeInfo.DataId,this.viewModelContext.repository.apiProxy.request(o.HttpMethods.PUT,t,a,!0).pipe(r.map((function(t){var i=e.context,n=i.getData();return i.updateData(JSON.parse(JSON.stringify(n))),t})))},t.prototype.uploadAndUpdateRow=function(t,e,n){var o=e||this.defaultRootDirId,a=n||this.defaultParentDirName;if(!o||!a)throw new Error("rootDirId和parentDirName不能为空，请填写");var s=this.getUploadFileInfosFromContext(),c=tt.convertToAttachmentInfos(s);if(!c||0===c.length)return alert("请先上传附件"),i.EMPTY;console.log("show loading ...");var d=tt.getFirstAttachmentInfo(c);return this.attachDataService.updateRow(t,d).pipe(r.tap((function(){console.log("hide loading ...")})))},t.prototype.uploadAndBatchAddRows=function(t,e){var n=this,a=this.context,s=a.eventParams.rootId,c=a.eventParams.parentDirName,d=s||this.defaultRootDirId,u=c||this.defaultParentDirName;if(!d||!u)throw new Error("rootDirId和parentDirName不能为空，请填写");var p=a.eventParams.context,l=this.getUploadFileInfosFromContext(),h=tt.convertToAttachmentInfos(l);if(!h||0===h.length)return alert("请先上传附件"),i.EMPTY;var f=t+"/service/batchuploadattachment";return this.attachDataService.updateRows(f,e,h).pipe(r.map((function(t){return p.appendData(t),n.getDataIdsToRemove(p,e).forEach((function(t){n.viewModelContext.repository.dataChangeHistory.addChange({fPath:"",dataId:t,changeType:o.DataChangeType.Add})})),t})))},t.prototype.removeAttachmentRows=function(t,e){var n=this,a=this.context.eventParams.context;if(!e)return i.EMPTY;var s=this.getDataIdsToRemove(a,e);if(e.split("/").length<=2){var c=t+"/extension/batchdelete";return this.removeDataService.removeByBusinessIds(c,s).pipe(r.map((function(t){s.forEach((function(t){a.removeDataById(t),n.viewModelContext.repository.dataChangeHistory.addChange({fPath:"",dataId:t,changeType:o.DataChangeType.Delete})}))})))}var d=[];0===s.length&&alert("请选择要删除的文件");var u=this.getBindingListPathWithAttachments(e);return s.forEach((function(e){var i=n.removeDataService.removeByBusinessPathAndId(t,u,e);d.push(i)})),i.forkJoin(d).pipe(r.map((function(t){return console.log(t),t})))},t.prototype.getUploadFileInfosFromContext=function(){var t=this.context.eventParams.data;return t||[]},t.prototype.getDataIdsToRemove=function(t,e){var i=this,n=this.getAttachmentIdsToRemoveFromContext(),o=[];return n.forEach((function(n){var r=i.convertAttachmentIdToDataId(t,n,e);o.push(r)})),o},t.prototype.getAttachmentIdsToRemoveFromContext=function(){return this.context.eventParams.data.map((function(t){return"[object Object]"===Object.prototype.toString.call(t)?t.metadataId:t}))},t.prototype.convertAttachmentIdToDataId=function(t,e,i){var n=o.BindingPathConverter.toBindingPathArray(i),r=n.pop();return t.data.find((function(t){if(t[r]&&t[r].attachmentId===e)return!0})).id},t.prototype.getBindingListPathWithAttachments=function(t){var e=o.BindingPathConverter.toBindingPathArray(t);return e.pop(),"/"+e.join("/")},t.prototype.getAttachContext=function(){var t=this.context;return t&&t.eventParams?t.eventParams:{}},t}();var nt=function(){function t(t,e,i){this.httpSvc=t,this.viewModelContext=e,this.loadingService=i}return Object.defineProperty(t.prototype,"params",{get:function(){return this.context&&this.context.eventParams||{}},enumerable:!0,configurable:!0}),t.prototype.addComment=function(t,e,n,o,a,s){var c=this;if(!(t=t||this.viewModelContext&&this.viewModelContext.bindingData.list.currentId||null))return i.EMPTY;var d=this.buildAddCommentParam(t,o,s,e,a,n);return this.loadingService.show(),this.httpSvc.post("/api/runtime/comment/v1.0/bill-comment/comment",d,{}).pipe(r.tap((function(){c.loadingService.hide()})))},t.prototype.buildAddCommentParam=function(t,e,i,n,o,r){return void 0===e&&(e=this.params.text),void 0===i&&(i=this.params.replyUser&&this.params.replyUser.id),void 0===o&&(o=this.params.visibility||"ALL"),{bill:{billId:t,configId:r,summary:n},comment:{billId:t,configId:r,parentId:i||null,text:e,visibility:o}}},t.prototype.queryComments=function(t,e,n,o){var a=this;if(!(t=t||this.viewModelContext&&this.viewModelContext.bindingData.list.currentId||null))return i.EMPTY;var s=this.buildQueryCommentsUrl(t,n,o,e);return this.loadingService.show(),this.httpSvc.get(s,{}).pipe(r.tap((function(t){a.loadingService.hide(),a.viewModelContext.uiState.setPropertyValue("discussionListData",t)})))},t.prototype.buildQueryCommentsUrl=function(t,e,i,n){return null==e&&(e=this.params.pageIndex||0),null==i&&(i=this.params.pageSize||999),"/api/runtime/comment/v1.0/bill-comment/comment/byBill?configId="+n+"&billId="+t+"&pageSize="+i+"&pageIndex="+e},t.prototype.setReplyUser=function(){this.viewModelContext.uiState.setPropertyValue("replyUser",this.params)},t.prototype.queryFrequentAtUsers=function(t,e){var i=this,n=[];n.push("pageSize="+(e||20)),n.push("pageIndex="+(t||0));var o="/api/runtime/comment/v1.0/bill-comment/frequentAtUsers?"+n.join("&");return this.loadingService.show(),this.httpSvc.get(o,{}).pipe(r.tap((function(t){i.loadingService.hide();var e={pageInfo:{pageSize:t.pageSize,pageIndex:t.pageIndex},total:t.totalCount,items:t.users};i.viewModelContext.uiState.setPropertyValue("personnelsData",e)})))},t.prototype.queryAtUsers=function(t,e,i){var n=this,o=[];t&&o.push("param="+t),o.push("pageSize="+(i||100)),o.push("pageIndex="+(e||0));var a="/api/runtime/comment/v1.0/bill-comment/atUser?"+o.join("&");return this.loadingService.show(),this.httpSvc.get(a,{}).pipe(r.tap((function(t){n.loadingService.hide();var e={pageInfo:{pageSize:t.pageSize,pageIndex:t.pageIndex},total:t.totalCount,items:t.users};n.viewModelContext.uiState.setPropertyValue("personnelsData",e)})))},t}();var ot=function(){function t(t){this.httpSvc=t}return t.prototype.error=function(t,e){if(t&&t.error&&t.error.Message){var i=t.error.Message;return e&&(i=e+"操作失败:"+i),i}},t.prototype.startProcessSimulate=function(t){return this.httpSvc.post("/api/runtime/wf/v1.0/processInstances/startProcess-simulation",t,{})},t.prototype.startProcess=function(t){return this.httpSvc.post("/api/runtime/wf/v1.0/processInstances/startProcess",t,{})},t.prototype.cancelSubmit=function(t){return this.httpSvc.post("/api/runtime/wf/v1.0/processInstances/cancelSubmit",t,{})},t}();var rt=function(){};var at=function(){};var st=function(){};var ct=function(){function t(t){this.taskService=t,this.processPlaceholder="选择流程",this.assignInfos=[],this.selectedValues=["clear"],this.payload=new rt,this.subject=new i.Subject,this.processReadOnly=!1,this.nodeReadOnly=!0}return t.prototype.setParam=function(t){this.payload.id=t.id,this.payload.processDefinitionId=t.processDefinitionId,this.payload.processDefinitionKey=t.processDefinitionKey,this.payload.bizDefKey=t.bizDefKey,this.payload.dataModelId=t.dataModelId,this.payload.dataId=t.dataId,this.payload.name=t.name,this.payload.startUserId=t.startUserId,this.payload.nextFlowNodes=[],this.startProcessSimulate(this.payload)},t.prototype.startProcessSimulate=function(t){var e=this;this.taskService.startProcessSimulate(t).subscribe((function(t){e.destProcesses=t.procDefs.map((function(t){return{id:t.procDefId,name:t.procDefName}})),1===e.destProcesses.length?(e.processReadOnly=!0,e.selectedProcessId=t.procDefs[0].procDefId,e.vm=n.SubmitApprove.confirm({process:e.selectedProcessId,processData:e.destProcesses,processOc:e.selectProcessChange.bind(e),processReadFlag:e.processReadOnly,processHolder:e.processPlaceholder,nextNodeReadFlag:e.nodeReadOnly,submit:e.submit.bind(e),cancel:e.back.bind(e)}),e.response=t,e.setNextNode(t)):e.vm=n.SubmitApprove.confirm({processData:e.destProcesses,processOc:e.selectProcessChange.bind(e),processReadFlag:e.processReadOnly,processHolder:e.processPlaceholder,nextNodeReadFlag:e.nodeReadOnly,submit:e.submit.bind(e),cancel:e.back.bind(e)})}),(function(t){e.subject.next({type:"error",message:t&&t.response&&t.response.data&&t.response.data.Message||"提交失败"})}))},t.prototype.selectProcessChange=function(t){var e=this;this.clearHelp(),this.clearNode(),this.selectedProcessId=t;var i=new rt;i.processDefinitionId=this.selectedProcessId,i.dataId=this.payload.dataId,this.taskService.startProcessSimulate(i).subscribe((function(t){e.response=t,e.setNextNode(t)}),(function(t){e.subject.next({type:"error",message:t&&t.response&&t.response.data&&t.response.data.Message||"该流程存在问题"})}))},t.prototype.getsimulationPathsIndexData=function(t){return this.destNodes.findIndex((function(e){return e.id===t}))},t.prototype.selectNodeChange=function(t){var e=this;this.clearHelp(),this.clearAssignInfos(),this.selectedNodeId=t,this.vm.open({nextNode:this.selectedNodeId});var i=this.getsimulationPathsIndexData(t);if(this.response.simulationPaths[i].nodeInfoList.every((function(t){return!0===t.resolved})))this.setAssignInfo(this.response.simulationPaths[i]);else{var n=new rt;n.processDefinitionId=this.selectedProcessId,n.dataId=this.payload.dataId,n.nextFlowNodes=[],this.selectedNodeId.split("，").forEach((function(t,e){var i=new at;i.activityDefinitionId=t,n.nextFlowNodes.push(i)})),this.taskService.startProcessSimulate(n).subscribe((function(t){e.setAssignInfo(t.simulationPaths[0])}),(function(t){e.subject.next({type:"error",message:t&&t.response&&t.response.data&&t.response.data.Message||"该节点存在问题"})}))}},t.prototype.setNextNode=function(t){this.destNodes=t.simulationPaths&&t.simulationPaths.map((function(t){return{id:t.nodeInfoList.map((function(t){return t.activityDefinitionId})).join("，"),name:t.nodeInfoList.map((function(t){return t.activityDefinitionName})).join("，")}}));var e=t.simulationPaths.findIndex((function(t){return t.default}));e>-1?(1===this.destNodes.length?this.nodeReadOnly=!0:this.nodeReadOnly=!1,this.selectedNodeId=this.destNodes[e].id,this.setAssignInfo(t.simulationPaths[e])):(this.selectedNodeId="",this.nodeReadOnly=!1,this.nodePlaceholder="请选择"),this.vm.open({nextNodeOc:this.selectNodeChange.bind(this),nextNode:this.selectedNodeId,nextNodeData:this.destNodes,nextNodeReadFlag:this.nodeReadOnly,nextNodeHolder:this.nodePlaceholder})},t.prototype.setAssignInfo=function(t){var e=this;this.assignInfos=[],this.selectedNodeId.split("，").forEach((function(i){var n=t.nodeInfoList.find((function(t){return t.activityDefinitionId===i}));if(n){var o=n.selectedAssignees,r=!1,a="",s="请选择人员";o&&o.length>=1&&(r=!0,s="",o.forEach((function(t){a=a+t.name+", "})),a=a.slice(0,a.length-2)),n.anonymous&&(a=""===n.anonymousText?"":n.anonymousText&&n.anonymousText),e.assignInfos.push({label:(e.selectedNodeId&&e.selectedNodeId.split("，").length>1?n.activityDefinitionName:"")+"办理人员",selectedAssignees:o,assigneeReadFlag:r,assignee:a,assigneeHolder:s,assigneeInfo:d({},n.assigneeInfo,{assigneeUsers:{items:n.assigneeInfo&&n.assigneeInfo.assigneeUsers||[]}}),assignees:n.selectedAssignees.map((function(t){return{id:t.id,name:t.name}})),activityName:n.activityDefinitionName,dependency:n.dependency,anonymous:n.anonymous,anonymousText:n.anonymousText})}else e.assignInfos.push({selectedAssignees:[],assigneeInfo:null,assignees:[],activityName:"",dependency:"",anonymous:n.anonymous,anonymousText:n.anonymousText})})),this.vm.open({assigneeOc:this.assigneeOc.bind(this),assignInfos:this.assignInfos})},t.prototype.assigneeOc=function(t,e){this.assignInfos[e].assignees=t.items,this.selectedValues[e]=t.value,this.vm.open({selectedValues:this.selectedValues})},t.prototype.clearHelp=function(){this.vm.open({selectedValues:["clear"]})},t.prototype.clearNode=function(){this.selectedNodeId="",this.destNodes=[],this.nodeReadOnly=!0,this.nodePlaceholder="",this.assignInfos=[],this.vm.open({nextNode:this.selectedNodeId,nextNodeData:this.destNodes,nextNodeReadFlag:this.nodeReadOnly,nodePlaceholder:this.nodePlaceholder,assignInfos:this.assignInfos})},t.prototype.clearAssignInfos=function(){this.assignInfos=[],this.vm.open({assignInfos:this.assignInfos})},t.prototype.back=function(){this.clearProcess(),this.subject.next({type:"success",message:""})},t.prototype.submit=function(){var t=this;if(this.selectedProcessId)if(this.selectedNodeId)if(this.assignInfos.filter((function(t){return(t.assigneeInfo&&t.assigneeInfo.assigneeUsers.items.length||t.selectedAssignees.length)&&!t.assignees.length})).length)this.subject.next({type:"error",message:"请选办理人员"});else{for(var e=this.selectedNodeId.split("，"),i=0;i<e.length;i++){var n={activityDefinitionId:e[i],activityDefinitionName:this.assignInfos[i].activityName,dependency:this.assignInfos[i].dependency,selectedAssignees:this.assignInfos[i].assigneeInfo?this.assignInfos[i].assignees:[],assigneeInfo:null,resolved:!1,anonymous:!1,anonymousText:""};this.payload.nextFlowNodes.push(n)}this.payload.processDefinitionId=this.selectedProcessId,this.taskService.startProcess(this.payload).subscribe((function(){t.clearProcess(),t.subject.next({type:"success",message:"提交成功"})}),(function(e){t.subject.next({type:"error",message:e&&e.response&&e.response.data&&e.response.data.Message||"提交失败"})}))}else this.subject.next({type:"error",message:"请选节点"});else this.subject.next({type:"error",message:"请选流程"})},t.prototype.getSubject=function(){return this.subject.asObservable()},t.prototype.clearProcess=function(){this.vm.close(),this.vm=null,this.selectedProcessId="",this.selectedNodeId="",this.processReadOnly=!1,this.nodeReadOnly=!0},t}();var dt=function(){function t(t,e,n,o){this.processSelectorService=t,this.taskService=e,this.loadingService=n,this.notifyService=o,this.subject=new i.Subject}return t.prototype.startProcess=function(t){var e=this,n=new i.Subject;return this.processSelectorService.setParam(t),this.processSelectorService.getSubject().subscribe((function(t){"success"===t.type?t.message&&(e.notifyService.success(t.message),n.next(!0)):"error"===t.type&&(n.next(!1),e.notifyService.error(t.message))}),(function(){e.loadingService.hide()})),n.asObservable()},t.prototype.cancelSubmit=function(t){var e=this,n=new i.Subject;return this.loadingService.show(),this.taskService.cancelSubmit(t).subscribe((function(t){n.next(!0),e.loadingService.hide(),e.notifyService.success("取消提交成功")}),(function(t){n.next(!1),e.loadingService.hide(),e.notifyService.error(t&&t.response&&t.response.data&&t.response.data.Message||"取消提交失败")})),n.asObservable()},t.prototype.submitWithBizDefKey=function(t,e){if(t){if(e){var i=new rt;return i.dataId=t,i.bizDefKey=e,this.startProcess(i)}this.notifyService.error("入口单据Id不能为空")}else this.notifyService.error("表单id不能为空")},t.prototype.cancelSubmitWithDataId=function(t,e){if(t){if(e){var i=new st;return i.dataId=t,i.bizDefKey=e,this.cancelSubmit(i)}this.notifyService.error("入口单据Id不能为空")}else this.notifyService.error("表单id不能为空")},t.prototype.batchSubmitWithBizDefKey=function(t,e){var n=this;if(t)if(t.length){if(e){if(1===t.length)return(c=new rt).bizDefKey=e,c.dataId=t[0],this.startProcess(c);var o=0,r=0,a=new i.Subject;this.loadingService.show();for(var s=0;s<t.length;s++){var c;(c=new rt).bizDefKey=e,c.dataId=t[s],c.variables={simulate:!1},this.taskService.startProcess(c).subscribe((function(e){e.procDefs.length>1||e.nextFlowNodes.length>1?r++:o++,o+r===t.length&&(n.loadingService.hide(),a.next(!0),n.showBatchSubmitInfo("submit",o,r))}),(function(){r++,o+r===t.length&&(n.loadingService.hide(),a.next(!1),n.showBatchSubmitInfo("submit",o,r))}))}return a.asObservable()}this.notifyService.error("入口单据ID不能为空")}else this.notifyService.error("请选择数据");else this.notifyService.error("dataId不能为空")},t.prototype.batchCancelSubmitWithDataId=function(t,e){var n=this;if(t)if(t.length){if(e){var o=new i.Subject,r=0,a=0;this.loadingService.show();for(var s=0;s<t.length;s++){var c=new st;c.dataId=t[s],c.bizDefKey=e,this.taskService.cancelSubmit(c).subscribe((function(e){++r+a===t.length&&(n.loadingService.hide(),o.next(!0),n.showBatchSubmitInfo("cancel",r,a))}),(function(){a++,r+a===t.length&&(n.loadingService.hide(),o.next(!1),n.showBatchSubmitInfo("cancel",r,a))}))}return o.asObservable()}this.notifyService.error("入口单据ID不能为空")}else this.notifyService.error("请选择数据");else this.notifyService.error("dataId不能为空")},t.prototype.childSubmit=function(t,e,i){if(t&&e){if(i){var n=new rt;return n.dataId=t+","+e,n.bizDefKey=i,this.startProcess(n)}this.notifyService.error("入口单据ID不能为空")}else this.notifyService.error("dataId不能为空")},t.prototype.childCancelSubmit=function(t,e,i){if(t&&e){if(i){var n=new st;return n.dataId=t+","+e,n.bizDefKey=i,this.cancelSubmit(n)}this.notifyService.error("入口单据ID不能为空")}else this.notifyService.error("dataId不能为空")},t.prototype.childBatchSubmit=function(t,e,i){if(t&&e){if(i){var n=e.map((function(e){return t+","+e}));return this.batchSubmitWithBizDefKey(n,i)}this.notifyService.error("入口单据ID不能为空")}else this.notifyService.error("dataId不能为空")},t.prototype.childBatchCancelSubmit=function(t,e,i){if(t&&e){if(i){var n=e.map((function(e){return t+","+e}));return this.batchCancelSubmitWithDataId(n,i)}this.notifyService.error("入口单据ID不能为空")}else this.notifyService.error("dataId不能为空")},t.prototype.showBatchSubmitInfo=function(t,e,i){e&&!i&&("submit"===t&&this.notifyService.success("提交审批成功！"),"cancel"===t&&this.notifyService.success("取消提交成功！")),e&&i&&this.notifyService.warning("操作成功"+e+"条，失败"+i+"条!"),!e&&i&&("submit"===t&&this.notifyService.error("提交审批失败！"),"cancel"===t&&this.notifyService.error("取消提交失败！"))},t}();var ut=[{provide:h,useClass:h,deps:[]},{provide:f,useClass:f,deps:[]},{provide:v,useClass:v,deps:[]},{provide:g,useClass:g,deps:[]},{provide:P,useClass:P,deps:[]},{provide:J,useClass:J,deps:[]},{provide:a.BE_ERROR_HANDLER__TOKEN,useClass:P,deps:[v,J]}],pt=[{provide:V,useClass:V,deps:[o.ViewModelContext,"@farris/mobile-command-services/ROUTER_INSTANCE_TOKEN",J]},{provide:W,useClass:W,deps:[o.ViewModelContext]},{provide:C,useClass:C,deps:[o.ViewModelContext]},{provide:K,useClass:K,deps:[o.ViewModelContext]},{provide:z,useClass:z,deps:[o.ViewModelContext]},{provide:q,useClass:q,deps:[o.ViewModelContext]},{provide:m,useClass:m,deps:[o.ViewModelContext]},{provide:w,useClass:w,deps:[o.ViewModelContext]},{provide:S,useClass:S,deps:[o.ViewModelContext]},{provide:C,useClass:C,deps:[o.ViewModelContext]},{provide:b,useClass:b,deps:[o.ViewModelContext]},{provide:B,useClass:B,deps:[o.ViewModelContext]},{provide:A,useClass:A,deps:[o.ViewModelContext]},{provide:R,useClass:R,deps:[o.ViewModelContext]},{provide:T,useClass:T,deps:[o.ViewModelContext]},{provide:O,useClass:O,deps:[o.ViewModelContext]},{provide:E,useClass:E,deps:[o.ViewModelContext]},{provide:N,useClass:N,deps:[o.ViewModelContext]},{provide:k,useClass:k,deps:[o.ViewModelContext]},{provide:j,useClass:j,deps:[o.ViewModelContext]},{provide:U,useClass:U,deps:[o.ViewModelContext]},{provide:ot,useClass:ot,deps:[o.HttpClient]},{provide:ct,useClass:ct,deps:[ot]},{provide:dt,useClass:dt,deps:[ct,ot,h,v]},{provide:F,useClass:F,deps:[dt,o.ViewModelContext]},{provide:$,useClass:$,deps:[o.ViewModelContext]},{provide:et,useClass:et,deps:[o.ViewModelContext]},{provide:Q,useClass:Q,deps:[o.ViewModelContext,C,O,$]},{provide:it,useClass:it,deps:[o.ViewModelContext,C,O,et]},{provide:X,useClass:X,deps:[o.ViewModelContext]},{provide:Z,useClass:Z,deps:[o.ViewModelContext]},{provide:y,useClass:y,deps:[o.ViewModelContext]},{provide:nt,useClass:nt,deps:[o.HttpClient,o.ViewModelContext,h]}];t.ApproveService=F,t.AttachmentDataService=$,t.AttachmentPreviewService=y,t.AttachmentService=Q,t.BaseDataService=M,t.BaseService=l,t.BeActionService=k,t.BusinessAttachmentDataService=et,t.BusinessAttachmentService=it,t.COMMAND_SERVICES_APP_PROVIDERS=ut,t.COMMAND_SERVICES_VIEWMODEL_PROVIDERS=pt,t.CancelDataService=N,t.CcWorkService=X,t.CheckDataService=j,t.CommandService=W,t.CreateDataService=A,t.DialogService=g,t.DiscussionGroupService=nt,t.EditDataService=R,t.EntityAggregationService=S,t.EntityListService=b,t.EntityManipulationService=w,t.EntityService=C,t.EntityTraversingService=m,t.ExceptionService=P,t.HistoryBackService=G,t.JsBridgeService=J,t.LoadDataService=B,t.LoadingService=h,t.MapService=Z,t.NotifyService=v,t.ROUTER_INSTANCE_TOKEN="@farris/mobile-command-services/ROUTER_INSTANCE_TOKEN",t.RemoveDataService=O,t.RouterService=V,t.SaveDataService=E,t.StateMachineService=K,t.ToastService=f,t.UIStateService=z,t.UpdateDataService=T,t.ValidatorServices=U,t.VoVariableService=q,t.ɵa=dt,t.ɵb=ct,t.ɵc=ot,t.ɵd=v,t.ɵe=U,t.ɵf=Z,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=farris-mobile-command-services.umd.min.js.map