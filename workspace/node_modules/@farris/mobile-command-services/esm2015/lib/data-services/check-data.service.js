/**
 * @fileoverview added by tsickle
 * Generated from: lib/data-services/check-data.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of, EMPTY } from 'rxjs';
import { switchMap, tap } from 'rxjs/operators';
import { BaseDataService } from './base-data.service';
import { DataUtil } from './data-util';
import { BefRepositoryUtil } from '@farris/mobile-bef';
import { HttpMethods } from '@farris/mobile-devkit';
/**
 * 数据检查服务
 */
class CheckDataService extends BaseDataService {
    /**
     * @param {?} viewModelContext
     */
    constructor(viewModelContext) {
        super(viewModelContext);
    }
    /**
     * 离开页面前检查数据变更
     * @return {?}
     */
    checkChangesBeforeLeave() {
        //const isEntitiesChanged = this.befRepository.entityManager.checkAllEntityChanges();
        // 实体数据没有变化，继续执行
        if (!BefRepositoryUtil.isExistUnsaveData(this.befRepository)) {
            return of(true);
        }
        return this.dialogService.confirm('存在未保存的变更，确认离开当前页面？').pipe(switchMap((/**
         * @param {?} ifLeave
         * @return {?}
         */
        (ifLeave) => {
            if (ifLeave === false) {
                return EMPTY;
            }
            else {
                this.loadingService.show();
                /** @type {?} */
                const cancel$ = this.befRepository.cancelEntityChanges();
                return cancel$.pipe(switchMap((/**
                 * @return {?}
                 */
                () => {
                    if (this.befRepository.apiProxy.associatedUrlMap.size >= 1) {
                        /** @type {?} */
                        const urls = [...this.befRepository.apiProxy.associatedUrlMap.keys()];
                        return this.befRepository.apiProxy.request(HttpMethods.POST, `${urls[0]}/service/cancel`);
                    }
                    else {
                        return of(true);
                    }
                })), tap((/**
                 * @return {?}
                 */
                () => {
                    this.loadingService.hide();
                })));
            }
        })));
    }
    /**
     * 子表离开页面前检查数据变更
     * @return {?}
     */
    checkChangesBeforeLeaveChild() {
        // 新增状态
        if (this.viewModelContext.uiState['$isAdd'] && this.viewModelContext.uiState['$isAdd'].status === true) {
            // 继续判断
            /** @type {?} */
            const childId = this.viewModelContext.uiState['$isAdd'].id;
            /** @type {?} */
            const childPath = this.viewModelContext.uiState['$isAdd'].path;
            /** @type {?} */
            const child = this.viewModelContext.uiState['$isAdd'].child;
            /** @type {?} */
            const subPaths = childPath.split('/');
            /** @type {?} */
            let currentChild;
            if (subPaths[0] && subPaths.length === 1) {
                currentChild = this.viewModelContext.bindingData[subPaths[0]];
            }
            if (!subPaths[0] && subPaths.length === 2) {
                currentChild = this.viewModelContext.bindingData[subPaths[1]];
            }
            if (subPaths.length > 2) {
                // 暂不处理从从表
                /** @type {?} */
                let childPath = '';
                if (subPaths[0]) {
                    childPath = subPaths[0];
                }
                for (let index = 1; index < subPaths.length; index++) {
                    childPath = childPath + subPaths[index];
                }
                currentChild = this.viewModelContext.bindingData[childPath];
            }
            /** @type {?} */
            const isChanged = this.checkForVariationBetweenTheTwo(currentChild, child);
            if (isChanged) {
                return of(true);
            }
            /** @type {?} */
            const entityPath = DataUtil.convertBindingPathToEntityPath(childPath, this.viewModelContext);
            return this.befRepository.removeEntityByPath(entityPath, childId);
        }
        return of(true);
    }
    /**
     * @private
     * @param {?} newData
     * @param {?} oldData
     * @return {?}
     */
    checkForVariationBetweenTheTwo(newData, oldData) {
        /** @type {?} */
        const childKeys = Object.keys(oldData);
        /** @type {?} */
        let isChanged = false;
        for (let i = 0; i < childKeys.length; i++) {
            if (Object.prototype.toString.call(oldData[childKeys[i]]) === '[object Object]' || Object.prototype.toString.call(oldData[childKeys[i]]) === '[object Array]') {
                if (JSON.stringify(oldData[childKeys[i]]) !== JSON.stringify(newData[childKeys[i]])) {
                    return isChanged = true;
                }
            }
            else {
                if (oldData[childKeys[i]] !== newData[childKeys[i]]) {
                    return isChanged = true;
                }
            }
        }
        return isChanged;
    }
    /**
     * 进入子表编辑或者新增点击返回都会复原进入子表前的数据
     * @param {?} path 子表路径
     * @return {?}
     */
    checkChangesBeforeLeaveAddOrEditChild(path) {
        // 新增状态
        if (this.viewModelContext.uiState['$isAdd'] && this.viewModelContext.uiState['$isAdd'].status === true) {
            // 新增直接干掉
            /** @type {?} */
            const childId = this.viewModelContext.uiState['$isAdd'].id;
            /** @type {?} */
            const childPath = this.viewModelContext.uiState['$isAdd'].path;
            /** @type {?} */
            const entityPath = DataUtil.convertBindingPathToEntityPath(childPath, this.viewModelContext);
            return this.befRepository.removeEntityByPath(entityPath, childId).pipe(tap((/**
             * @return {?}
             */
            () => {
                this.viewModelContext.uiState.setPropertyValue('$isAdd', null);
            })));
        }
        else {
            // 编辑还原
            /** @type {?} */
            const childID = this.viewModelContext.bindingData[path]['id'];
            /** @type {?} */
            const id = this.viewModelContext.bindingData[path]['parentID'];
            /** @type {?} */
            const childEntityData = this.viewModelContext.uiState['$childEntity'];
            if (!childEntityData) {
                return of(true);
            }
            this.viewModelContext.repository.entityCollection.getEntityById(id)[path].get(childID).load(childEntityData);
            return of(true);
        }
    }
}
export { CheckDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2stZGF0YS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9kYXRhLXNlcnZpY2VzL2NoZWNrLWRhdGEuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDaEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkMsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFDdEQsT0FBTyxFQUFFLFdBQVcsRUFBb0IsTUFBTSx1QkFBdUIsQ0FBQzs7OztBQU10RSxNQUFNLGdCQUFpQixTQUFRLGVBQWU7Ozs7SUFFNUMsWUFBWSxnQkFBa0M7UUFDNUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUE7SUFDekIsQ0FBQzs7Ozs7SUFLTSx1QkFBdUI7UUFFNUIscUZBQXFGO1FBRXJGLGdCQUFnQjtRQUNoQixJQUFJLENBQUMsaUJBQWlCLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFO1lBQzVELE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2pCO1FBRUQsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLElBQUksQ0FDMUQsU0FBUzs7OztRQUFDLENBQUMsT0FBWSxFQUFFLEVBQUU7WUFDekIsSUFBSSxPQUFPLEtBQUssS0FBSyxFQUFFO2dCQUNyQixPQUFPLEtBQUssQ0FBQzthQUNkO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFF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QUMsQ0FBQTthQUNoQjtZQUNELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDN0csT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUE7U0FDaEI7SUFDSCxDQUFDO0NBQ0Y7QUFFRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG9mLCBFTVBUWSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBzd2l0Y2hNYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgQmFzZURhdGFTZXJ2aWNlIH0gZnJvbSAnLi9iYXNlLWRhdGEuc2VydmljZSc7XHJcbmltcG9ydCB7IERhdGFVdGlsIH0gZnJvbSAnLi9kYXRhLXV0aWwnO1xyXG5pbXBvcnQgeyBCZWZSZXBvc2l0b3J5VXRpbCB9IGZyb20gJ0BmYXJyaXMvbW9iaWxlLWJlZidcclxuaW1wb3J0IHsgSHR0cE1ldGhvZHMsIFZpZXdNb2RlbENvbnRleHQgfSBmcm9tICdAZmFycmlzL21vYmlsZS1kZXZraXQnO1xyXG5cclxuXHJcbi8qKlxyXG4gKiDmlbDmja7mo4Dmn6XmnI3liqFcclxuICovXHJcbmNsYXNzIENoZWNrRGF0YVNlcnZpY2UgZXh0ZW5kcyBCYXNlRGF0YVNlcnZpY2Uge1xyXG5cclxuICBjb25zdHJ1Y3Rvcih2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0KSB7XHJcbiAgICBzdXBlcih2aWV3TW9kZWxDb250ZXh0KVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog56a75byA6aG16Z2i5YmN5qOA5p+l5pWw5o2u5Y+Y5pu0XHJcbiAgICovXHJcbiAgcHVibGljIGNoZWNrQ2hhbmdlc0JlZm9yZUxlYXZlKCkge1xyXG5cclxuICAgIC8vY29uc3QgaXNFbnRpdGllc0NoYW5nZWQgPSB0aGlzLmJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlci5jaGVja0FsbEVudGl0eUNoYW5nZXMoKTtcclxuXHJcbiAgICAvLyDlrp7kvZPmlbDmja7msqHmnInlj5jljJbvvIznu6fnu63miafooYxcclxuICAgIGlmICghQmVmUmVwb3NpdG9yeVV0aWwuaXNFeGlzdFVuc2F2ZURhdGEodGhpcy5iZWZSZXBvc2l0b3J5KSkge1xyXG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuZGlhbG9nU2VydmljZS5jb25maXJtKCflrZjlnKjmnKrkv53lrZjnmoTlj5jmm7TvvIznoa7orqTnprvlvIDlvZPliY3pobXpnaLvvJ8nKS5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKGlmTGVhdmU6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmIChpZkxlYXZlID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcclxuICAgICAgICAgIGNvbnN0IGNhbmNlbCQgPSB0aGlzLmJlZlJlcG9zaXRvcnkuY2FuY2VsRW50aXR5Q2hhbmdlcygpO1xyXG4gICAgICAgICAgcmV0dXJuIGNhbmNlbCQucGlwZShcclxuICAgICAgICAgICAgc3dpdGNoTWFwKCgpID0+IHtcclxuICAgICAgICAgICAgICBpZiAodGhpcy5iZWZSZXBvc2l0b3J5LmFwaVByb3h5LmFzc29jaWF0ZWRVcmxNYXAuc2l6ZSA+PSAxKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB1cmxzID0gWy4uLnRoaXMuYmVmUmVwb3NpdG9yeS5hcGlQcm94eS5hc3NvY2lhdGVkVXJsTWFwLmtleXMoKV07XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5iZWZSZXBvc2l0b3J5LmFwaVByb3h5LnJlcXVlc3QoSHR0cE1ldGhvZHMuUE9TVCwgYCR7dXJsc1swXX0vc2VydmljZS9jYW5jZWxgKVxyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb2YodHJ1ZSlcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgKSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlrZDooajnprvlvIDpobXpnaLliY3mo4Dmn6XmlbDmja7lj5jmm7RcclxuICAgKi9cclxuICBwdWJsaWMgY2hlY2tDaGFuZ2VzQmVmb3JlTGVhdmVDaGlsZCgpIHtcclxuICAgIC8vIOaWsOWinueKtuaAgVxyXG4gICAgaWYgKHRoaXMudmlld01vZGVsQ29udGV4dC51aVN0YXRlWyckaXNBZGQnXSAmJiB0aGlzLnZpZXdNb2RlbENvbnRleHQudWlTdGF0ZVsnJGlzQWRkJ10uc3RhdHVzID09PSB0cnVlKSB7XHJcbiAgICAgIC8vIOe7p+e7reWIpOaWrVxyXG4gICAgICBjb25zdCBjaGlsZElkID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LnVpU3RhdGVbJyRpc0FkZCddLmlkO1xyXG4gICAgICBjb25zdCBjaGlsZFBhdGggPSB0aGlzLnZpZXdNb2RlbENvbnRleHQudWlTdGF0ZVsnJGlzQWRkJ10ucGF0aDtcclxuICAgICAgY29uc3QgY2hpbGQgPSB0aGlzLnZpZXdNb2RlbENvbnRleHQudWlTdGF0ZVsnJGlzQWRkJ10uY2hpbGQ7XHJcbiAgICAgIGNvbnN0IHN1YlBhdGhzID0gY2hpbGRQYXRoLnNwbGl0KCcvJyk7XHJcbiAgICAgIGxldCBjdXJyZW50Q2hpbGQ7XHJcbiAgICAgIGlmIChzdWJQYXRoc1swXSAmJiBzdWJQYXRocy5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICBjdXJyZW50Q2hpbGQgPSB0aGlzLnZpZXdNb2RlbENvbnRleHQuYmluZGluZ0RhdGFbc3ViUGF0aHNbMF1dXHJcbiAgICAgIH1cclxuICAgICAgaWYgKCFzdWJQYXRoc1swXSAmJiBzdWJQYXRocy5sZW5ndGggPT09IDIpIHtcclxuICAgICAgICBjdXJyZW50Q2hpbGQgPSB0aGlzLnZpZXdNb2RlbENvbnRleHQuYmluZGluZ0RhdGFbc3ViUGF0aHNbMV1dXHJcbiAgICAgIH1cclxuICAgICAgaWYgKHN1YlBhdGhzLmxlbmd0aCA+IDIpIHtcclxuICAgICAgICAvLyDmmoLkuI3lpITnkIbku47ku47ooahcclxuICAgICAgICBsZXQgY2hpbGRQYXRoID0gJydcclxuICAgICAgICBpZiAoc3ViUGF0aHNbMF0pIHtcclxuICAgICAgICAgIGNoaWxkUGF0aCA9IHN1YlBhdGhzWzBdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKGxldCBpbmRleCA9IDE7IGluZGV4IDwgc3ViUGF0aHMubGVuZ3RoOyBpbmRleCsrKSB7XHJcbiAgICAgICAgICBjaGlsZFBhdGggPSBjaGlsZFBhdGggKyBzdWJQYXRoc1tpbmRleF1cclxuICAgICAgICB9XHJcbiAgICAgICAgY3VycmVudENoaWxkID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LmJpbmRpbmdEYXRhW2NoaWxkUGF0aF1cclxuICAgICAgfVxyXG4gICAgICBjb25zdCBpc0NoYW5nZWQgPSB0aGlzLmNoZWNrRm9yVmFyaWF0aW9uQmV0d2VlblRoZVR3byhjdXJyZW50Q2hpbGQsIGNoaWxkKTtcclxuICAgICAgaWYgKGlzQ2hhbmdlZCkge1xyXG4gICAgICAgIHJldHVybiBvZih0cnVlKVxyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IGVudGl0eVBhdGggPSBEYXRhVXRpbC5jb252ZXJ0QmluZGluZ1BhdGhUb0VudGl0eVBhdGgoY2hpbGRQYXRoLCB0aGlzLnZpZXdNb2RlbENvbnRleHQpO1xyXG4gICAgICByZXR1cm4gdGhpcy5iZWZSZXBvc2l0b3J5LnJlbW92ZUVudGl0eUJ5UGF0aChlbnRpdHlQYXRoLCBjaGlsZElkKTtcclxuICAgIH1cclxuICAgIHJldHVybiBvZih0cnVlKVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjaGVja0ZvclZhcmlhdGlvbkJldHdlZW5UaGVUd28obmV3RGF0YSwgb2xkRGF0YSkge1xyXG4gICAgY29uc3QgY2hpbGRLZXlzID0gT2JqZWN0LmtleXMob2xkRGF0YSk7XHJcbiAgICBsZXQgaXNDaGFuZ2VkID0gZmFsc2U7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkS2V5cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9sZERhdGFbY2hpbGRLZXlzW2ldXSkgPT09ICdbb2JqZWN0IE9iamVjdF0nIHx8IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvbGREYXRhW2NoaWxkS2V5c1tpXV0pID09PSAnW29iamVjdCBBcnJheV0nKSB7XHJcbiAgICAgICAgaWYgKEpTT04uc3RyaW5naWZ5KG9sZERhdGFbY2hpbGRLZXlzW2ldXSkgIT09IEpTT04uc3RyaW5naWZ5KG5ld0RhdGFbY2hpbGRLZXlzW2ldXSkpIHtcclxuICAgICAgICAgIHJldHVybiBpc0NoYW5nZWQgPSB0cnVlXHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGlmIChvbGREYXRhW2NoaWxkS2V5c1tpXV0gIT09IG5ld0RhdGFbY2hpbGRLZXlzW2ldXSkge1xyXG4gICAgICAgICAgcmV0dXJuIGlzQ2hhbmdlZCA9IHRydWVcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBpc0NoYW5nZWQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDov5vlhaXlrZDooajnvJbovpHmiJbogIXmlrDlop7ngrnlh7vov5Tlm57pg73kvJrlpI3ljp/ov5vlhaXlrZDooajliY3nmoTmlbDmja5cclxuICAgKiBAcGFyYW0gcGF0aCDlrZDooajot6/lvoRcclxuICAgKi9cclxuICBwdWJsaWMgY2hlY2tDaGFuZ2VzQmVmb3JlTGVhdmVBZGRPckVkaXRDaGlsZChwYXRoOiBzdHJpbmcpIHtcclxuICAgIC8vIOaWsOWinueKtuaAgVxyXG4gICAgaWYgKHRoaXMudmlld01vZGVsQ29udGV4dC51aVN0YXRlWyckaXNBZGQnXSAmJiB0aGlzLnZpZXdNb2RlbENvbnRleHQudWlTdGF0ZVsnJGlzQWRkJ10uc3RhdHVzID09PSB0cnVlKSB7XHJcbiAgICAgIC8vIOaWsOWinuebtOaOpeW5suaOiVxyXG4gICAgICBjb25zdCBjaGlsZElkID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LnVpU3RhdGVbJyRpc0FkZCddLmlkO1xyXG4gICAgICBjb25zdCBjaGlsZFBhdGggPSB0aGlzLnZpZXdNb2RlbENvbnRleHQudWlTdGF0ZVsnJGlzQWRkJ10ucGF0aDtcclxuICAgICAgY29uc3QgZW50aXR5UGF0aCA9IERhdGFVdGlsLmNvbnZlcnRCaW5kaW5nUGF0aFRvRW50aXR5UGF0aChjaGlsZFBhdGgsIHRoaXMudmlld01vZGVsQ29udGV4dCk7XHJcbiAgICAgIHJldHVybiB0aGlzLmJlZlJlcG9zaXRvcnkucmVtb3ZlRW50aXR5QnlQYXRoKGVudGl0eVBhdGgsIGNoaWxkSWQpLnBpcGUoXHJcbiAgICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICAgIHRoaXMudmlld01vZGVsQ29udGV4dC51aVN0YXRlLnNldFByb3BlcnR5VmFsdWUoJyRpc0FkZCcsIG51bGwpO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIOe8lui+kei/mOWOn1xyXG4gICAgICBjb25zdCBjaGlsZElEID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LmJpbmRpbmdEYXRhW3BhdGhdWydpZCddO1xyXG4gICAgICBjb25zdCBpZCA9IHRoaXMudmlld01vZGVsQ29udGV4dC5iaW5kaW5nRGF0YVtwYXRoXVsncGFyZW50SUQnXTtcclxuICAgICAgY29uc3QgY2hpbGRFbnRpdHlEYXRhID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LnVpU3RhdGVbJyRjaGlsZEVudGl0eSddO1xyXG4gICAgICBpZiAoIWNoaWxkRW50aXR5RGF0YSkge1xyXG4gICAgICAgIHJldHVybiBvZih0cnVlKVxyXG4gICAgICB9XHJcbiAgICAgIHRoaXMudmlld01vZGVsQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChpZClbcGF0aF0uZ2V0KGNoaWxkSUQpLmxvYWQoY2hpbGRFbnRpdHlEYXRhKTtcclxuICAgICAgcmV0dXJuIG9mKHRydWUpXHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgeyBDaGVja0RhdGFTZXJ2aWNlIH07XHJcbiJdfQ==