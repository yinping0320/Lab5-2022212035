/**
 * @fileoverview added by tsickle
 * Generated from: lib/data-services/remove-data.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of, EMPTY } from 'rxjs';
import { tap, switchMap } from 'rxjs/operators';
import { HttpMethods } from '@farris/mobile-devkit';
import { DataUtil } from './data-util';
import { BaseDataService } from './base-data.service';
/**
 * 删除数据服务类
 */
export class RemoveDataService extends BaseDataService {
    /**
     * @param {?} viewModelContext
     */
    constructor(viewModelContext) {
        super(viewModelContext);
    }
    /**
     * 删除数据
     * @param {?} id
     * @return {?}
     */
    removeById(id) {
        /** @type {?} */
        const result$ = this.dialogService.confirm('是否删除').pipe(switchMap((/**
         * @param {?} val
         * @return {?}
         */
        val => {
            if (val === false) {
                return EMPTY;
            }
            if (this['context'] && this['context'].eventParams && this['context'].eventParams.swipecellClose) {
                this['context'].eventParams.swipecellClose();
            }
            return this.cancelChanges(id);
        })));
        return result$;
    }
    /**
     * 确认删除
     * @private
     * @param {?} id
     * @return {?}
     */
    cancelChanges(id) {
        this.loadingService.show();
        /** @type {?} */
        const remove$ = this.befRepository.removeEntityAndSaveById(id);
        return remove$.pipe(tap((/**
         * @return {?}
         */
        () => {
            this.notifyService.success('删除成功');
            this.loadingService.hide();
        }), (/**
         * @return {?}
         */
        () => {
            this.loadingService.hide();
            this.notifyService.error('删除失败');
        })));
    }
    /**
     * 批量删除数据
     * @param {?} ids
     * @return {?}
     */
    removeByIds(ids) {
        // 由于ListView尚未和UIState集成，无法直接获取ids，临时从事件参数中获取
        if (!ids) {
            /** @type {?} */
            const selectedItems = this['context'].eventParams;
            ids = selectedItems.map((/**
             * @param {?} selectedItem
             * @return {?}
             */
            (selectedItem) => {
                return selectedItem.id;
            }));
        }
        /** @type {?} */
        const multiRemove$ = this.dialogService.confirm('是否删除').pipe(switchMap((/**
         * @param {?} val
         * @return {?}
         */
        val => {
            if (val === false) {
                return EMPTY;
            }
            this.loadingService.show();
            return this.befRepository.removeEntitiesByIds(ids);
        })));
        return multiRemove$.pipe(tap((/**
         * @return {?}
         */
        () => {
            this.loadingService.hide();
            this.notifyService.success('删除成功');
        }), (/**
         * @param {?} exception
         * @return {?}
         */
        (exception) => {
            this.loadingService.hide();
            // this.exceptionService.show('删除失败', exception);
        })));
    }
    /**
     * 删除后代节点数据
     * @param {?} path
     * @param {?} id
     * @return {?}
     */
    removeByPathAndId(path, id) {
        /** @type {?} */
        const result$ = this.dialogService.confirm('是否删除').pipe(switchMap((/**
         * @param {?} val
         * @return {?}
         */
        val => {
            if (val === false) {
                return EMPTY;
            }
            if (this['context'] && this['context'].eventParams && this['context'].eventParams.swipecellClose) {
                this['context'].eventParams.swipecellClose();
            }
            return this.removeByPathAndIdChanges(path, id);
        })));
        return result$;
    }
    /**
     * @param {?} path
     * @param {?} id
     * @return {?}
     */
    removeByPathAndIdChanges(path, id) {
        this.loadingService.show();
        /** @type {?} */
        const entityPath = DataUtil.convertBindingPathToEntityPath(path, this.viewModelContext);
        /** @type {?} */
        const remove$ = this.befRepository.removeEntityByPath(entityPath, id);
        return remove$.pipe(tap((/**
         * @return {?}
         */
        () => {
            this.loadingService.hide();
            this.notifyService.success('删除成功');
        }), (/**
         * @param {?} error
         * @return {?}
         */
        (error) => {
            this.loadingService.hide();
            console.error(error);
        })));
    }
    /**
     * 批量删除后代节点数据
     * @param {?} path
     * @param {?} ids
     * @return {?}
     */
    removeByPathAndIds(path, ids) {
        throw new Error('Not Implemented');
    }
    /**
     * 业务附件批量删除数据
     * @param {?} url
     * @param {?} ids
     * @return {?}
     */
    removeByBusinessIds(url, ids) {
        // 由于ListView尚未和UIState集成，无法直接获取ids，临时从事件参数中获取
        if (!ids) {
            /** @type {?} */
            const selectedItems = this['context'].eventParams;
            ids = selectedItems.map((/**
             * @param {?} selectedItem
             * @return {?}
             */
            (selectedItem) => {
                return selectedItem.id;
            }));
        }
        /** @type {?} */
        const params = {
            ids: ids.join(',')
        };
        /** @type {?} */
        const requestConfig = {
            params: params,
            body: {
                dataChange: [],
                variableChange: null
            }
        };
        return this.befRepository.apiProxy.request(HttpMethods.PUT, url, requestConfig, true);
        // this.loadingService.show();
        // const multiRemove$ = this.dialogService.confirm('是否删除').pipe(
        //   switchMap(val => {
        //     if (val === false) {
        //       return EMPTY;
        //     }
        //   }));
        // return multiRemove$.pipe(
        //   tap(
        //     () => {
        //       this.loadingService.hide();
        //     },
        //     (exception: any) => {
        //       this.loadingService.hide();
        //     }
        //   )
        // );
    }
    /**
     * 业务附件删除后代节点数据
     * @param {?} url
     * @param {?} path
     * @param {?} id
     * @return {?}
     */
    removeByBusinessPathAndId(url, path, id) {
        /** @type {?} */
        const result$ = this.dialogService.confirm('是否删除').pipe(switchMap((/**
         * @param {?} val
         * @return {?}
         */
        val => {
            if (val === false) {
                return EMPTY;
            }
            return this.befRepository.apiProxy.request(HttpMethods.PUT, url);
        })));
        return result$;
    }
    /**
     * 子表清除编辑与新增标记
     * @return {?}
     */
    ClearStatusAfterchildCardSave() {
        this.viewModelContext.uiState.setPropertyValue('$isAdd', null);
        this.viewModelContext.uiState.setPropertyValue('$childEntity', null);
        return of(true);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVtb3ZlLWRhdGEuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWNvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZGF0YS1zZXJ2aWNlcy9yZW1vdmUtZGF0YS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFjLEVBQUUsRUFBRSxLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0MsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNoRCxPQUFPLEVBQVUsV0FBVyxFQUF1QyxNQUFNLHVCQUF1QixDQUFDO0FBRWpHLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDOzs7O0FBTXRELE1BQU0sT0FBTyxpQkFBa0IsU0FBUSxlQUFlOzs7O0lBRXBELFlBQVksZ0JBQWtDO1FBQzVDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQzFCLENBQUM7Ozs7OztJQU1NLFVBQVUsQ0FBQyxFQUFVOztjQUVwQixPQUFPLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUNyRCxTQUFTOzs7O1FBQUMsR0FBRyxDQUFDLEVBQUU7WUFDZCxJQUFJLEdBQUcsS0FBSyxLQUFLLEVBQUU7Z0JBQ2pCLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7WUFDRCxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxXQUFXLENBQUMsY0FBYyxFQUFFO2dCQUNoRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsV0FBVyxDQUFDLGNBQWMsRUFBRSxDQUFDO2FBQzlDO1lBQ0QsT0FBTyxJQUFJLENBQUMsYUFBYSxD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Q0FBQztRQUNyRSxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUNqQixDQUFDO0NBRUYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgRU1QVFkgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdGFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEVudGl0eSwgSHR0cE1ldGhvZHMsIEh0dHBSZXF1ZXN0Q29uZmlnLCBWaWV3TW9kZWxDb250ZXh0IH0gZnJvbSAnQGZhcnJpcy9tb2JpbGUtZGV2a2l0JztcclxuXHJcbmltcG9ydCB7IERhdGFVdGlsIH0gZnJvbSAnLi9kYXRhLXV0aWwnO1xyXG5pbXBvcnQgeyBCYXNlRGF0YVNlcnZpY2UgfSBmcm9tICcuL2Jhc2UtZGF0YS5zZXJ2aWNlJztcclxuXHJcblxyXG4vKipcclxuICog5Yig6Zmk5pWw5o2u5pyN5Yqh57G7XHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgUmVtb3ZlRGF0YVNlcnZpY2UgZXh0ZW5kcyBCYXNlRGF0YVNlcnZpY2Uge1xyXG5cclxuICBjb25zdHJ1Y3Rvcih2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0KSB7XHJcbiAgICBzdXBlcih2aWV3TW9kZWxDb250ZXh0KTtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiDliKDpmaTmlbDmja5cclxuICAgKi9cclxuICBwdWJsaWMgcmVtb3ZlQnlJZChpZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuXHJcbiAgICBjb25zdCByZXN1bHQkID0gdGhpcy5kaWFsb2dTZXJ2aWNlLmNvbmZpcm0oJ+aYr+WQpuWIoOmZpCcpLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcCh2YWwgPT4ge1xyXG4gICAgICAgIGlmICh2YWwgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzWydjb250ZXh0J10gJiYgdGhpc1snY29udGV4dCddLmV2ZW50UGFyYW1zICYmIHRoaXNbJ2NvbnRleHQnXS5ldmVudFBhcmFtcy5zd2lwZWNlbGxDbG9zZSkge1xyXG4gICAgICAgICAgdGhpc1snY29udGV4dCddLmV2ZW50UGFyYW1zLnN3aXBlY2VsbENsb3NlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLmNhbmNlbENoYW5nZXMoaWQpO1xyXG4gICAgICB9XHJcbiAgICAgICkpXHJcbiAgICByZXR1cm4gcmVzdWx0JFxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog56Gu6K6k5Yig6ZmkXHJcbiAgICogQHBhcmFtIGlkIFxyXG4gICAqL1xyXG5cclxuICBwcml2YXRlIGNhbmNlbENoYW5nZXMoaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcclxuICAgIGNvbnN0IHJlbW92ZSQgPSB0aGlzLmJlZlJlcG9zaXRvcnkucmVtb3ZlRW50aXR5QW5kU2F2ZUJ5SWQoaWQpO1xyXG4gICAgcmV0dXJuIHJlbW92ZSQucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgICgpID0+IHtcclxuICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZS5zdWNjZXNzKCfliKDpmaTmiJDlip8nKTtcclxuICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2UuZXJyb3IoJ+WIoOmZpOWksei0pScpO1xyXG4gICAgICAgIH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiDmibnph4/liKDpmaTmlbDmja5cclxuICAgKi9cclxuICBwdWJsaWMgcmVtb3ZlQnlJZHMoaWRzOiBzdHJpbmdbXSk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgLy8g55Sx5LqOTGlzdFZpZXflsJrmnKrlkoxVSVN0YXRl6ZuG5oiQ77yM5peg5rOV55u05o6l6I635Y+WaWRz77yM5Li05pe25LuO5LqL5Lu25Y+C5pWw5Lit6I635Y+WXHJcbiAgICBpZiAoIWlkcykge1xyXG4gICAgICBjb25zdCBzZWxlY3RlZEl0ZW1zID0gdGhpc1snY29udGV4dCddLmV2ZW50UGFyYW1zO1xyXG4gICAgICBpZHMgPSBzZWxlY3RlZEl0ZW1zLm1hcCgoc2VsZWN0ZWRJdGVtKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHNlbGVjdGVkSXRlbS5pZDtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbXVsdGlSZW1vdmUkID0gdGhpcy5kaWFsb2dTZXJ2aWNlLmNvbmZpcm0oJ+aYr+WQpuWIoOmZpCcpLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcCh2YWwgPT4ge1xyXG4gICAgICAgIGlmICh2YWwgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmJlZlJlcG9zaXRvcnkucmVtb3ZlRW50aXRpZXNCeUlkcyhpZHMpO1xyXG4gICAgICB9KSk7XHJcbiAgICByZXR1cm4gbXVsdGlSZW1vdmUkLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZS5zdWNjZXNzKCfliKDpmaTmiJDlip8nKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIChleGNlcHRpb246IGFueSkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcblxyXG4gICAgICAgICAgLy8gdGhpcy5leGNlcHRpb25TZXJ2aWNlLnNob3coJ+WIoOmZpOWksei0pScsIGV4Y2VwdGlvbik7XHJcbiAgICAgICAgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yig6Zmk5ZCO5Luj6IqC54K55pWw5o2uXHJcbiAgICovXHJcbiAgcHVibGljIHJlbW92ZUJ5UGF0aEFuZElkKHBhdGg6IHN0cmluZywgaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IHRoaXMuZGlhbG9nU2VydmljZS5jb25maXJtKCfmmK/lkKbliKDpmaQnKS5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAodmFsID0+IHtcclxuICAgICAgICBpZiAodmFsID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpc1snY29udGV4dCddICYmIHRoaXNbJ2NvbnRleHQnXS5ldmVudFBhcmFtcyAmJiB0aGlzWydjb250ZXh0J10uZXZlbnRQYXJhbXMuc3dpcGVjZWxsQ2xvc2UpIHtcclxuICAgICAgICAgIHRoaXNbJ2NvbnRleHQnXS5ldmVudFBhcmFtcy5zd2lwZWNlbGxDbG9zZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5yZW1vdmVCeVBhdGhBbmRJZENoYW5nZXMocGF0aCwgaWQpO1xyXG4gICAgICB9XHJcbiAgICAgICkpO1xyXG4gICAgcmV0dXJuIHJlc3VsdCQ7XHJcbiAgfVxyXG5cclxuXHJcbiAgcHVibGljIHJlbW92ZUJ5UGF0aEFuZElkQ2hhbmdlcyhwYXRoOiBzdHJpbmcsIGlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xyXG4gICAgY29uc3QgZW50aXR5UGF0aCA9IERhdGFVdGlsLmNvbnZlcnRCaW5kaW5nUGF0aFRvRW50aXR5UGF0aChwYXRoLCB0aGlzLnZpZXdNb2RlbENvbnRleHQpO1xyXG4gICAgY29uc3QgcmVtb3ZlJCA9IHRoaXMuYmVmUmVwb3NpdG9yeS5yZW1vdmVFbnRpdHlCeVBhdGgoZW50aXR5UGF0aCwgaWQpO1xyXG4gICAgcmV0dXJuIHJlbW92ZSQucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgICgpID0+IHtcclxuICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xyXG4gICAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLnN1Y2Nlc3MoJ+WIoOmZpOaIkOWKnycpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xyXG4gICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5om56YeP5Yig6Zmk5ZCO5Luj6IqC54K55pWw5o2uXHJcbiAgICovXHJcbiAgcHVibGljIHJlbW92ZUJ5UGF0aEFuZElkcyhwYXRoOiBzdHJpbmcsIGlkczogc3RyaW5nW10pOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTm90IEltcGxlbWVudGVkJyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDkuJrliqHpmYTku7bmibnph4/liKDpmaTmlbDmja5cclxuICAgKi9cclxuICBwdWJsaWMgcmVtb3ZlQnlCdXNpbmVzc0lkcyh1cmw6IHN0cmluZywgaWRzOiBzdHJpbmdbXSk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgLy8g55Sx5LqOTGlzdFZpZXflsJrmnKrlkoxVSVN0YXRl6ZuG5oiQ77yM5peg5rOV55u05o6l6I635Y+WaWRz77yM5Li05pe25LuO5LqL5Lu25Y+C5pWw5Lit6I635Y+WXHJcbiAgICBpZiAoIWlkcykge1xyXG4gICAgICBjb25zdCBzZWxlY3RlZEl0ZW1zID0gdGhpc1snY29udGV4dCddLmV2ZW50UGFyYW1zO1xyXG4gICAgICBpZHMgPSBzZWxlY3RlZEl0ZW1zLm1hcCgoc2VsZWN0ZWRJdGVtKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHNlbGVjdGVkSXRlbS5pZDtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXJhbXMgPSB7XHJcbiAgICAgIGlkczogaWRzLmpvaW4oJywnKVxyXG4gICAgfTtcclxuICAgIGNvbnN0IHJlcXVlc3RDb25maWc6IEh0dHBSZXF1ZXN0Q29uZmlnID0ge1xyXG4gICAgICBwYXJhbXM6IHBhcmFtcyxcclxuICAgICAgYm9keToge1xyXG4gICAgICAgIGRhdGFDaGFuZ2U6IFtdLFxyXG4gICAgICAgIHZhcmlhYmxlQ2hhbmdlOiBudWxsXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gdGhpcy5iZWZSZXBvc2l0b3J5LmFwaVByb3h5LnJlcXVlc3QoSHR0cE1ldGhvZHMuUFVULCB1cmwsIHJlcXVlc3RDb25maWcsIHRydWUpO1xyXG4gICAgLy8gdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KCk7XHJcbiAgICAvLyBjb25zdCBtdWx0aVJlbW92ZSQgPSB0aGlzLmRpYWxvZ1NlcnZpY2UuY29uZmlybSgn5piv5ZCm5Yig6ZmkJykucGlwZShcclxuICAgIC8vICAgc3dpdGNoTWFwKHZhbCA9PiB7XHJcbiAgICAvLyAgICAgaWYgKHZhbCA9PT0gZmFsc2UpIHtcclxuICAgIC8vICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIC8vICAgICB9XHJcbiAgICAvLyAgIH0pKTtcclxuICAgIC8vIHJldHVybiBtdWx0aVJlbW92ZSQucGlwZShcclxuICAgIC8vICAgdGFwKFxyXG4gICAgLy8gICAgICgpID0+IHtcclxuICAgIC8vICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xyXG4gICAgLy8gICAgIH0sXHJcbiAgICAvLyAgICAgKGV4Y2VwdGlvbjogYW55KSA9PiB7XHJcbiAgICAvLyAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgIC8vICAgICB9XHJcbiAgICAvLyAgIClcclxuICAgIC8vICk7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICog5Lia5Yqh6ZmE5Lu25Yig6Zmk5ZCO5Luj6IqC54K55pWw5o2uXHJcbiAgICovXHJcbiAgcHVibGljIHJlbW92ZUJ5QnVzaW5lc3NQYXRoQW5kSWQodXJsOiBzdHJpbmcsIHBhdGg6IHN0cmluZywgaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IHRoaXMuZGlhbG9nU2VydmljZS5jb25maXJtKCfmmK/lkKbliKDpmaQnKS5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAodmFsID0+IHtcclxuICAgICAgICBpZiAodmFsID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5iZWZSZXBvc2l0b3J5LmFwaVByb3h5LnJlcXVlc3QoSHR0cE1ldGhvZHMuUFVULCB1cmwpO1xyXG4gICAgICB9XHJcbiAgICAgICkpO1xyXG4gICAgcmV0dXJuIHJlc3VsdCQ7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICog5a2Q6KGo5riF6Zmk57yW6L6R5LiO5paw5aKe5qCH6K6wXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIENsZWFyU3RhdHVzQWZ0ZXJjaGlsZENhcmRTYXZlKCk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICB0aGlzLnZpZXdNb2RlbENvbnRleHQudWlTdGF0ZS5zZXRQcm9wZXJ0eVZhbHVlKCckaXNBZGQnLCBudWxsKTtcclxuICAgIHRoaXMudmlld01vZGVsQ29udGV4dC51aVN0YXRlLnNldFByb3BlcnR5VmFsdWUoJyRjaGlsZEVudGl0eScsIG51bGwpO1xyXG4gICAgcmV0dXJuIG9mKHRydWUpXHJcbiAgfVxyXG5cclxufVxyXG4iXX0=