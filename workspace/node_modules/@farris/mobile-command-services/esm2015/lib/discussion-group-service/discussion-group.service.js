/**
 * @fileoverview added by tsickle
 * Generated from: lib/discussion-group-service/discussion-group.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { EMPTY } from 'rxjs';
import { tap } from 'rxjs/operators';
export class DiscussionGroupService {
    /**
     * @param {?} httpSvc
     * @param {?} viewModelContext
     * @param {?} loadingService
     */
    constructor(httpSvc, viewModelContext, loadingService) {
        this.httpSvc = httpSvc;
        this.viewModelContext = viewModelContext;
        this.loadingService = loadingService;
    }
    /**
     * @private
     * @return {?}
     */
    get params() {
        return this['context'] && this['context']['eventParams'] || {};
    }
    /**
     *
     * @param {?=} id 表单id
     * @param {?=} summary 消息描述
     * @param {?=} configId 消息配置id
     * @param {?=} text 评论内容
     * @param {?=} visibility 是否所有人可见(移动暂未支持)
     * @param {?=} parentId 是否是回复信息
     * @return {?}
     */
    addComment(id, summary, configId, text, visibility, parentId) {
        id = id || this.viewModelContext && this.viewModelContext.bindingData.list.currentId || null;
        if (!id) {
            return EMPTY;
        }
        /** @type {?} */
        const url = '/api/runtime/comment/v1.0/bill-comment/comment';
        /** @type {?} */
        const body = this.buildAddCommentParam(id, text, parentId, summary, visibility, configId);
        this.loadingService.show();
        return this.httpSvc.post(url, body, {}).pipe(tap((/**
         * @return {?}
         */
        () => {
            this.loadingService.hide();
        })));
    }
    /**
     * @private
     * @param {?} id
     * @param {?} text
     * @param {?} parentId
     * @param {?} summary
     * @param {?} visibility
     * @param {?} configId
     * @return {?}
     */
    buildAddCommentParam(id, text, parentId, summary, visibility, configId) {
        if (typeof text === 'undefined') {
            text = this.params.text;
        }
        if (typeof parentId === 'undefined') {
            parentId = this.params.replyUser && this.params.replyUser.id;
        }
        if (typeof visibility === 'undefined') {
            visibility = this.params.visibility || 'ALL';
        }
        return {
            'bill': {
                'billId': id,
                'configId': configId,
                'summary': summary
            },
            'comment': {
                'billId': id,
                'configId': configId,
                'parentId': parentId || null,
                'text': text,
                'visibility': visibility
            }
        };
    }
    /**
     *
     * @param {?} id 表单id
     * @param {?} configId 消息配置id
     * @param {?=} pageIndex
     * @param {?=} pageSize
     * @return {?}
     */
    queryComments(id, configId, pageIndex, pageSize) {
        id = id || this.viewModelContext && this.viewModelContext.bindingData.list.currentId || null;
        if (!id) {
            return EMPTY;
        }
        /** @type {?} */
        const url = this.buildQueryCommentsUrl(id, pageIndex, pageSize, configId);
        this.loadingService.show();
        return this.httpSvc.get(url, {}).pipe(tap((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            this.loadingService.hide();
            this.viewModelContext.uiState.setPropertyValue('discussionListData', e);
        })));
    }
    /**
     * @private
     * @param {?} id
     * @param {?} pageIndex
     * @param {?} pageSize
     * @param {?} configId
     * @return {?}
     */
    buildQueryCommentsUrl(id, pageIndex, pageSize, configId) {
        if (typeof pageIndex === 'undefined' || pageIndex === null) {
            pageIndex = this.params.pageIndex || 0;
        }
        if (typeof pageSize === 'undefined' || pageSize === null) {
            pageSize = this.params.pageSize || 999;
        }
        return `/api/runtime/comment/v1.0/bill-comment/comment/byBill?configId=${configId}&billId=${id}&pageSize=${pageSize}&pageIndex=${pageIndex}`;
    }
    /**
     * 回复赋值
     * @return {?}
     */
    setReplyUser() {
        this.viewModelContext.uiState.setPropertyValue('replyUser', this.params);
    }
    /**
     * @param {?=} pageIndex
     * @param {?=} pageSize
     * @return {?}
     */
    queryFrequentAtUsers(pageIndex, pageSize) {
        /** @type {?} */
        const params = [];
        params.push(`pageSize=${pageSize || 20}`);
        params.push(`pageIndex=${pageIndex || 0}`);
        /** @type {?} */
        const url = `/api/runtime/comment/v1.0/bill-comment/frequentAtUsers?${params.join('&')}`;
        this.loadingService.show();
        return this.httpSvc.get(url, {}).pipe(tap((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            this.loadingService.hide();
            /** @type {?} */
            const personnelsData = {
                pageInfo: {
                    pageSize: e.pageSize,
                    pageIndex: e.pageIndex
                },
                total: e.totalCount,
                items: e.users
            };
            this.viewModelContext.uiState.setPropertyValue('personnelsData', personnelsData);
        })));
    }
    /**
     * @param {?=} user
     * @param {?=} pageIndex
     * @param {?=} pageSize
     * @return {?}
     */
    queryAtUsers(user, pageIndex, pageSize) {
        /** @type {?} */
        const params = [];
        if (user) {
            params.push(`param=${user}`);
        }
        params.push(`pageSize=${pageSize || 100}`);
        params.push(`pageIndex=${pageIndex || 0}`);
        /** @type {?} */
        const url = `/api/runtime/comment/v1.0/bill-comment/atUser?${params.join('&')}`;
        this.loadingService.show();
        return this.httpSvc.get(url, {}).pipe(tap((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            this.loadingService.hide();
            /** @type {?} */
            const personnelsData = {
                pageInfo: {
                    pageSize: e.pageSize,
                    pageIndex: e.pageIndex
                },
                total: e.totalCount,
                items: e.users
            };
            this.viewModelContext.uiState.setPropertyValue('personnelsData', personnelsData);
        })));
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    DiscussionGroupService.prototype.httpSvc;
    /**
     * @type {?}
     * @private
     */
    DiscussionGroupService.prototype.viewModelContext;
    /**
     * @type {?}
     * @private
     */
    DiscussionGroupService.prototype.loadingService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlzY3Vzc2lvbi1ncm91cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9kaXNjdXNzaW9uLWdyb3VwLXNlcnZpY2UvZGlzY3Vzc2lvbi1ncm91cC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFrQixLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0MsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBS3JDLE1BQU0sT0FBTyxzQkFBc0I7Ozs7OztJQUMvQixZQUNZLE9BQW1CLEVBQ25CLGdCQUFrQyxFQUNsQyxjQUE4QjtRQUY5QixZQUFPLEdBQVAsT0FBTyxDQUFZO1FBQ25CLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO0lBRTFDLENBQUM7Ozs7O0lBRUQsSUFBWSxNQUFNO1FBQ2QsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNuRSxDQUFDOzs7Ozs7Ozs7OztJQVlNLFVBQVUsQ0FBQyxFQUFXLEVBQUUsT0FBZ0IsRUFBRSxRQUFpQixFQUFFLElBQWEsRUFBRSxVQUFtQixFQUFFLFFBQWlCO1FBQ3JILEVBQUUsR0FBRyxFQUFFLElBQUksSUFBSSxDQUFDLGdCQUFnQixJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUM7UUFDN0YsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNMLE9BQU8sS0FBSyxDQUFDO1NBQ2hCOztjQUVLLEdBQUcsR0FBRyxnREFBZ0Q7O2NBQ3RELElBQUksR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxRQUFR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b3J0IHsgT2JzZXJ2YWJsZSwgb2YsIEVNUFRZIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgSHR0cENsaWVudCwgVmlld01vZGVsQ29udGV4dCB9IGZyb20gJ0BmYXJyaXMvbW9iaWxlLWRldmtpdCc7XHJcbmltcG9ydCB7IExvYWRpbmdTZXJ2aWNlIH0gZnJvbSAnLi4vdWktc2VydmljZXMvaW5kZXgnO1xyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBEaXNjdXNzaW9uR3JvdXBTZXJ2aWNlIHtcclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByaXZhdGUgaHR0cFN2YzogSHR0cENsaWVudCxcclxuICAgICAgICBwcml2YXRlIHZpZXdNb2RlbENvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQsXHJcbiAgICAgICAgcHJpdmF0ZSBsb2FkaW5nU2VydmljZTogTG9hZGluZ1NlcnZpY2UsXHJcbiAgICApIHtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldCBwYXJhbXMoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXNbJ2NvbnRleHQnXSAmJiB0aGlzWydjb250ZXh0J11bJ2V2ZW50UGFyYW1zJ10gfHwge307XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSBpZCDooajljZVpZFxyXG4gICAgICogQHBhcmFtIHN1bW1hcnkg5raI5oGv5o+P6L+wXHJcbiAgICAgKiBAcGFyYW0gY29uZmlnSWQg5raI5oGv6YWN572uaWRcclxuICAgICAqIEBwYXJhbSB0ZXh0IOivhOiuuuWGheWuuVxyXG4gICAgICogQHBhcmFtIHZpc2liaWxpdHkg5piv5ZCm5omA5pyJ5Lq65Y+v6KeBKOenu+WKqOaaguacquaUr+aMgSlcclxuICAgICAqIEBwYXJhbSBwYXJlbnRJZCDmmK/lkKbmmK/lm57lpI3kv6Hmga9cclxuICAgICAqIEByZXR1cm5zIFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgYWRkQ29tbWVudChpZD86IHN0cmluZywgc3VtbWFyeT86IHN0cmluZywgY29uZmlnSWQ/OiBzdHJpbmcsIHRleHQ/OiBzdHJpbmcsIHZpc2liaWxpdHk/OiBzdHJpbmcsIHBhcmVudElkPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgICAgICBpZCA9IGlkIHx8IHRoaXMudmlld01vZGVsQ29udGV4dCAmJiB0aGlzLnZpZXdNb2RlbENvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQgfHwgbnVsbDtcclxuICAgICAgICBpZiAoIWlkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHVybCA9ICcvYXBpL3J1bnRpbWUvY29tbWVudC92MS4wL2JpbGwtY29tbWVudC9jb21tZW50JztcclxuICAgICAgICBjb25zdCBib2R5ID0gdGhpcy5idWlsZEFkZENvbW1lbnRQYXJhbShpZCwgdGV4dCwgcGFyZW50SWQsIHN1bW1hcnksIHZpc2liaWxpdHksIGNvbmZpZ0lkKTtcclxuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKVxyXG4gICAgICAgIHJldHVybiB0aGlzLmh0dHBTdmMucG9zdCh1cmwsIGJvZHksIHt9KS5waXBlKFxyXG4gICAgICAgICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKClcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICApXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBidWlsZEFkZENvbW1lbnRQYXJhbShpZDogc3RyaW5nLCB0ZXh0OiBzdHJpbmcsIHBhcmVudElkOiBzdHJpbmcsIHN1bW1hcnk6IHN0cmluZywgdmlzaWJpbGl0eTogc3RyaW5nLCBjb25maWdJZDogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiB0ZXh0ID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICAgICAgICB0ZXh0ID0gdGhpcy5wYXJhbXMudGV4dDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHR5cGVvZiBwYXJlbnRJZCA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgICAgICAgcGFyZW50SWQgPSB0aGlzLnBhcmFtcy5yZXBseVVzZXIgJiYgdGhpcy5wYXJhbXMucmVwbHlVc2VyLmlkO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodHlwZW9mIHZpc2liaWxpdHkgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgICAgICAgIHZpc2liaWxpdHkgPSB0aGlzLnBhcmFtcy52aXNpYmlsaXR5IHx8ICdBTEwnO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAnYmlsbCc6IHtcclxuICAgICAgICAgICAgICAgICdiaWxsSWQnOiBpZCxcclxuICAgICAgICAgICAgICAgICdjb25maWdJZCc6IGNvbmZpZ0lkLFxyXG4gICAgICAgICAgICAgICAgJ3N1bW1hcnknOiBzdW1tYXJ5XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICdjb21tZW50Jzoge1xyXG4gICAgICAgICAgICAgICAgJ2JpbGxJZCc6IGlkLFxyXG4gICAgICAgICAgICAgICAgJ2NvbmZpZ0lkJzogY29uZmlnSWQsXHJcbiAgICAgICAgICAgICAgICAncGFyZW50SWQnOiBwYXJlbnRJZCB8fCBudWxsLFxyXG4gICAgICAgICAgICAgICAgJ3RleHQnOiB0ZXh0LFxyXG4gICAgICAgICAgICAgICAgJ3Zpc2liaWxpdHknOiB2aXNpYmlsaXR5XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSBpZCDooajljZVpZFxyXG4gICAgICogQHBhcmFtIGNvbmZpZ0lkIOa2iOaBr+mFjee9rmlkXHJcbiAgICAgKiBAcGFyYW0gcGFnZUluZGV4IFxyXG4gICAgICogQHBhcmFtIHBhZ2VTaXplIFxyXG4gICAgICogQHJldHVybnMgXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBxdWVyeUNvbW1lbnRzKGlkOiBzdHJpbmcsIGNvbmZpZ0lkOiBzdHJpbmcsIHBhZ2VJbmRleD86IG51bWJlciB8IG51bGwsIHBhZ2VTaXplPzogbnVtYmVyIHwgbnVsbCk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICAgICAgaWQgPSBpZCB8fCB0aGlzLnZpZXdNb2RlbENvbnRleHQgJiYgdGhpcy52aWV3TW9kZWxDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkIHx8IG51bGw7XHJcbiAgICAgICAgaWYgKCFpZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB1cmwgPSB0aGlzLmJ1aWxkUXVlcnlDb21tZW50c1VybChpZCwgcGFnZUluZGV4LCBwYWdlU2l6ZSwgY29uZmlnSWQpO1xyXG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cFN2Yy5nZXQodXJsLCB7fSkucGlwZShcclxuICAgICAgICAgICAgdGFwKChlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKVxyXG4gICAgICAgICAgICAgICAgdGhpcy52aWV3TW9kZWxDb250ZXh0LnVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZSgnZGlzY3Vzc2lvbkxpc3REYXRhJywgZSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYnVpbGRRdWVyeUNvbW1lbnRzVXJsKGlkOiBzdHJpbmcsIHBhZ2VJbmRleDogbnVtYmVyIHwgbnVsbCwgcGFnZVNpemU6IG51bWJlciB8IG51bGwsIGNvbmZpZ0lkOiBzdHJpbmcpIHtcclxuICAgICAgICBpZiAodHlwZW9mIHBhZ2VJbmRleCA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFnZUluZGV4ID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHBhZ2VJbmRleCA9IHRoaXMucGFyYW1zLnBhZ2VJbmRleCB8fCAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodHlwZW9mIHBhZ2VTaXplID09PSAndW5kZWZpbmVkJyB8fCBwYWdlU2l6ZSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICBwYWdlU2l6ZSA9IHRoaXMucGFyYW1zLnBhZ2VTaXplIHx8IDk5OTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGAvYXBpL3J1bnRpbWUvY29tbWVudC92MS4wL2JpbGwtY29tbWVudC9jb21tZW50L2J5QmlsbD9jb25maWdJZD0ke2NvbmZpZ0lkfSZiaWxsSWQ9JHtpZH0mcGFnZVNpemU9JHtwYWdlU2l6ZX0mcGFnZUluZGV4PSR7cGFnZUluZGV4fWA7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Zue5aSN6LWL5YC8XHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzZXRSZXBseVVzZXIoKSB7XHJcbiAgICAgICAgdGhpcy52aWV3TW9kZWxDb250ZXh0LnVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZSgncmVwbHlVc2VyJywgdGhpcy5wYXJhbXMpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBxdWVyeUZyZXF1ZW50QXRVc2VycyhwYWdlSW5kZXg/OiBudW1iZXIgfCBudWxsLCBwYWdlU2l6ZT86IG51bWJlciB8IG51bGwpIHtcclxuICAgICAgICBjb25zdCBwYXJhbXM6IHN0cmluZ1tdID0gW107XHJcbiAgICAgICAgcGFyYW1zLnB1c2goYHBhZ2VTaXplPSR7cGFnZVNpemUgfHwgMjB9YCk7XHJcbiAgICAgICAgcGFyYW1zLnB1c2goYHBhZ2VJbmRleD0ke3BhZ2VJbmRleCB8fCAwfWApO1xyXG4gICAgICAgIGNvbnN0IHVybCA9IGAvYXBpL3J1bnRpbWUvY29tbWVudC92MS4wL2JpbGwtY29tbWVudC9mcmVxdWVudEF0VXNlcnM/JHtwYXJhbXMuam9pbignJicpfWA7XHJcbiAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KClcclxuICAgICAgICByZXR1cm4gdGhpcy5odHRwU3ZjLmdldCh1cmwsIHt9KS5waXBlKFxyXG4gICAgICAgICAgICB0YXAoKGUpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpXHJcbiAgICAgICAgICAgICAgICBjb25zdCBwZXJzb25uZWxzRGF0YSA9IHtcclxuICAgICAgICAgICAgICAgICAgICBwYWdlSW5mbzoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlU2l6ZTogZS5wYWdlU2l6ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUluZGV4OiBlLnBhZ2VJbmRleFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgdG90YWw6IGUudG90YWxDb3VudCxcclxuICAgICAgICAgICAgICAgICAgICBpdGVtczogZS51c2Vyc1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy52aWV3TW9kZWxDb250ZXh0LnVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZSgncGVyc29ubmVsc0RhdGEnLCBwZXJzb25uZWxzRGF0YSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBxdWVyeUF0VXNlcnModXNlcj86IHN0cmluZywgcGFnZUluZGV4PzogbnVtYmVyIHwgbnVsbCwgcGFnZVNpemU/OiBudW1iZXIgfCBudWxsKSB7XHJcbiAgICAgICAgY29uc3QgcGFyYW1zOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgICAgIGlmICh1c2VyKSB7XHJcbiAgICAgICAgICAgIHBhcmFtcy5wdXNoKGBwYXJhbT0ke3VzZXJ9YCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHBhcmFtcy5wdXNoKGBwYWdlU2l6ZT0ke3BhZ2VTaXplIHx8IDEwMH1gKTtcclxuICAgICAgICBwYXJhbXMucHVzaChgcGFnZUluZGV4PSR7cGFnZUluZGV4IHx8IDB9YCk7XHJcbiAgICAgICAgY29uc3QgdXJsID0gYC9hcGkvcnVudGltZS9jb21tZW50L3YxLjAvYmlsbC1jb21tZW50L2F0VXNlcj8ke3BhcmFtcy5qb2luKCcmJyl9YDtcclxuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKVxyXG4gICAgICAgIHJldHVybiB0aGlzLmh0dHBTdmMuZ2V0KHVybCwge30pLnBpcGUoXHJcbiAgICAgICAgICAgIHRhcCgoZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKClcclxuICAgICAgICAgICAgICAgIGNvbnN0IHBlcnNvbm5lbHNEYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VJbmZvOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VTaXplOiBlLnBhZ2VTaXplLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlSW5kZXg6IGUucGFnZUluZGV4XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB0b3RhbDogZS50b3RhbENvdW50LFxyXG4gICAgICAgICAgICAgICAgICAgIGl0ZW1zOiBlLnVzZXJzXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLnZpZXdNb2RlbENvbnRleHQudWlTdGF0ZS5zZXRQcm9wZXJ0eVZhbHVlKCdwZXJzb25uZWxzRGF0YScsIHBlcnNvbm5lbHNEYXRhKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICApXHJcbiAgICB9XHJcbn1cclxuIl19