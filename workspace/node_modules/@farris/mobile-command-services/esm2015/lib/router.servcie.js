/**
 * @fileoverview added by tsickle
 * Generated from: lib/router.servcie.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { tap, map } from 'rxjs/operators';
import { HttpClient } from '@farris/mobile-devkit';
/**
 * 路由服务
 */
class RouterService {
    /**
     * 构造函数
     * @param {?} viewModelContext
     * @param {?} router
     * @param {?} jsBridgeService
     */
    constructor(viewModelContext, router, jsBridgeService) {
        this.jsBridgeService = jsBridgeService;
        this.viewModelContext = viewModelContext;
        this.router = router;
    }
    /**
     * 路由跳转
     * @param {?} path   路由路径
     * @param {?=} queryParams
     * @param {?=} backParams
     * @param {?=} backPath
     * @return {?}
     */
    navigate(path, queryParams = {}, backParams = {}, backPath) {
        if (!path)
            return;
        queryParams = this.ParamsFromStringToObject(queryParams);
        backParams = this.ParamsFromStringToObject(backParams);
        /** @type {?} */
        const pathIndex = this.sessionStorageSaveHistory(path, backPath, backParams)
        // 跨工程跳转
        ;
        // 跨工程跳转
        if (path && pathIndex >= 0) {
            /** @type {?} */
            let urlPath = this.splicePath(path, queryParams);
            window.location.href = urlPath;
            return false;
        }
        window['MOBILE_ORIGIN_BACK'] && window['MOBILE_ORIGIN_BACK'].reflushOriginGoback();
        this.router.push({
            path: path,
            query: queryParams
        });
    }
    /**
     * @private
     * @param {?} pathIndex
     * @param {?} path
     * @return {?}
     */
    removeParams(pathIndex, path) {
        /** @type {?} */
        let end = path.search('\\?');
        if (end = -1) {
            end = path.length;
        }
        return path.slice(pathIndex, end);
    }
    /**
     * @private
     * @param {?} path
     * @return {?}
     */
    getsessionStorageSaveHistoryKey(path) {
        /** @type {?} */
        const pathIndex = path.search('/apps');
        // 跨页面跳转离开
        if (path && pathIndex >= 0) {
            return this.removeParams(pathIndex, path);
        }
        return this.router.options.history.base + path;
    }
    /**
     * @private
     * @param {?} path
     * @param {?} backPath
     * @param {?} backParams
     * @return {?}
     */
    sessionStorageSaveHistory(path, backPath, backParams) {
        /** @type {?} */
        const pathIndex = path.search('/apps');
        /** @type {?} */
        const key = this.getsessionStorageSaveHistoryKey(path);
        /** @type {?} */
        let historyObject = {}
        //判断是否制定了目标页面得返回地址
        ;
        //判断是否制定了目标页面得返回地址
        if (backPath) {
            /** @type {?} */
            const backPathIndex = path.search('/apps');
            //指定返回路由为跨工程跳转
            if (backPathIndex >= 0) {
                historyObject = {
                    routerWay: 'href',
                    path: backPath,
                    query: backParams
                };
            }
            else {
                historyObject = {
                    routerWay: 'Router',
                    path: backPath,
                    query: backParams
                };
            }
            sessionStorage.setItem(key, JSON.stringify(historyObject));
            return pathIndex;
        }
        else {
            /** @type {?} */
            let currentPath = this.router.currentRoute.value.path;
            // 跨页面跳转离开
            if (path && pathIndex >= 0) {
                //拼接当前路由
                currentPath = this.router.options.history.base + this.router.options.history.location;
                //记录当前路由
                historyObject = {
                    routerWay: 'href',
                    path: currentPath,
                    query: backParams
                };
            }
            else {
                // 路由方式跳转记录
                historyObject = {
                    routerWay: 'Router',
                    path: currentPath,
                    query: backParams
                };
            }
            sessionStorage.setItem(key, JSON.stringify(historyObject));
            return pathIndex;
        }
    }
    /**
     * 带维度的路由跳转
     * @param {?} path
     * @param {?=} queryParams
     * @param {?=} backParams
     * @param {?=} backPath
     * @return {?}
     */
    navigateForRtc(path, queryParams = {}, backParams = {}, backPath) {
        if (!queryParams || !queryParams.metadataId) {
            this.navigate(path, queryParams, backParams, backPath);
        }
        /** @type {?} */
        const rtcOptions = {
            metadataId: queryParams.metadataId,
            withDims: false,
            dim1: queryParams.dim1,
            dim2: queryParams.dim2
        };
        delete queryParams['metadataId'];
        delete queryParams['dim1'];
        delete queryParams['dim2'];
        /** @type {?} */
        const correctRtcOptions$ = this.correctRtcOptions(rtcOptions);
        /** @type {?} */
        const extendedPath$ = correctRtcOptions$.pipe(map((/**
         * @param {?} correctedRtcOptions
         * @return {?}
         */
        (correctedRtcOptions) => {
            return this.getExtendPath(path, correctedRtcOptions);
        })));
        /** @type {?} */
        const result$ = extendedPath$.pipe(tap((/**
         * @param {?} extendedPath
         * @return {?}
         */
        (extendedPath) => {
            this.navigate(extendedPath, queryParams, backParams);
        })));
        result$.subscribe();
    }
    /**
     * 纠正维度信息
     * \@summary
     * 1、非运行时定制表单，widthDims=false, 维度为空；
     * 2、运行时定制表单：维度值不存在时，则纠正为public；
     * @private
     * @param {?} rtcOptions
     * @return {?}
     */
    correctRtcOptions(rtcOptions) {
        /** @type {?} */
        const dim1 = rtcOptions.dim1 || 'public';
        /** @type {?} */
        const dim2 = rtcOptions.dim2 || 'public';
        /** @type {?} */
        const metadataId = rtcOptions.metadataId;
        /** @type {?} */
        const httpClient = this.viewModelContext.injector.get(HttpClient);
        /** @type {?} */
        const url = '/api/runtime/bcc/v1.0/template/beforeNavigate';
        /** @type {?} */
        const body = {
            isRootMetadata: true,
            metadataId: metadataId,
            dim1: dim1,
            dim2: dim2,
        };
        /** @type {?} */
        const beforeNavigate$ = httpClient.post(url, body, null).pipe(map((/**
         * @param {?} result
         * @return {?}
         */
        (result) => {
            /** @type {?} */
            const correctedRtcOptions = {
                metadataId: result.metadataId,
                withDims: result.withDims === 1 ? true : false,
                dim1: result.dim1,
                dim2: result.dim2
            };
            return correctedRtcOptions;
        })));
        return beforeNavigate$;
    }
    /**
     * 获取运行时定制表单地址
     * @private
     * @param {?} path
     * @param {?} rtcOptions
     * @return {?}
     */
    getExtendPath(path, rtcOptions) {
        if (rtcOptions.withDims === false) {
            return path;
        }
        /** @type {?} */
        const arrPath = path.split('index.html');
        /** @type {?} */
        const append = `${rtcOptions.dim1}/${rtcOptions.dim2}/index.html`.toLowerCase();
        /** @type {?} */
        const extendPath = arrPath.join(append);
        return extendPath;
    }
    /**
     * 拼接url路径
     * @private
     * @param {?} path 路径
     * @param {?} params 参数
     * @return {?}
     */
    splicePath(path, params) {
        /** @type {?} */
        let urlPath = path;
        /** @type {?} */
        const end = urlPath.search('\\?');
        if (end > -1) {
            urlPath = urlPath.slice(0, end);
        }
        /** @type {?} */
        const keys = Object.keys(params);
        if (keys.length > 0) {
            urlPath = urlPath + '?';
            keys.forEach((/**
             * @param {?} element
             * @return {?}
             */
            element => {
                urlPath = urlPath + element + '=' + params[`${element}`] + '&';
            }));
            urlPath = urlPath.slice(0, urlPath.length - 1);
        }
        return urlPath;
    }
    /**
     * @private
     * @param {?} params
     * @return {?}
     */
    ParamsFromStringToObject(params) {
        if (Object.prototype.toString.call(params) === '[object Object]') {
            return params;
        }
        try {
            params = JSON.parse(params);
        }
        catch (error) {
            if (!params) {
                params = {};
            }
            else {
                params = {};
                console.error('路由传参params不是JSON串格式');
            }
        }
        if (Object.prototype.toString.call(params) !== '[object Object]') {
            return {};
        }
        return params;
    }
    /**
     * 路由跳转
     * @param {?} path   路由路径
     * @param {?=} queryParams
     * @return {?}
     */
    navigateReplace(path, queryParams = {}) {
        if (typeof queryParams === 'string') {
            queryParams = JSON.parse(queryParams);
        }
        this.router.replace({
            path: path,
            query: queryParams
        });
    }
    /**
     * 后退
     * @param {?} params
     * @return {?}
     */
    goBack(params) {
        params = this.ParamsFromStringToObject(params);
        /** @type {?} */
        const currentPath = this.router.options.history.base + this.router.currentRoute.value.path;
        /** @type {?} */
        let need_go_back = sessionStorage.getItem(currentPath);
        if (!need_go_back) {
            if (window.top.location.pathname.indexOf('mobiletaskcenter') > -1) {
                return;
            }
            this.jsBridgeService.closeWindow();
            return;
        }
        /** @type {?} */
        const keys = Object.keys(params);
        need_go_back = JSON.parse(need_go_back);
        if (need_go_back && need_go_back['routerWay'] === 'Router') {
            /** @type {?} */
            let query = need_go_back['query'];
            if (keys.length > 0) {
                query = Object.assign({}, query, params);
            }
            this.router.push({
                query,
                path: need_go_back['path'],
            });
        }
        if (need_go_back && need_go_back['routerWay'] === 'href') {
            /** @type {?} */
            let query = need_go_back['query'];
            if (keys.length > 0) {
                query = Object.assign({}, query, params);
            }
            /** @type {?} */
            let path = need_go_back['path'];
            path = this.splicePath(path, query);
            window.location.href = path;
        }
    }
    /**
     * 映射路由状态
     * @return {?}
     */
    mappingToUIState() {
        /** @type {?} */
        const routerState = {
            params: this.router.currentRoute['value'].params,
            queryParams: this.router.currentRoute['value'].query
        };
        this.viewModelContext.uiState['routerState'] = routerState;
    }
}
if (false) {
    /**
     * ViewModel上下文
     * @type {?}
     * @private
     */
    RouterService.prototype.viewModelContext;
    /**
     * VueRouter实例
     * @type {?}
     * @private
     */
    RouterService.prototype.router;
    /**
     * @type {?}
     * @private
     */
    RouterService.prototype.jsBridgeService;
}
/**
 * Token
 * \@todo：临时方案，直接注入VueRouter实例。
 * @type {?}
 */
const ROUTER_INSTANCE_TOKEN = '@farris/mobile-command-services/ROUTER_INSTANCE_TOKEN';
export { RouterService, ROUTER_INSTANCE_TOKEN };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLnNlcnZjaWUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL3JvdXRlci5zZXJ2Y2llLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUEsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxQyxPQUFPLEVBQW9CLFVBQVUsRUFBRSxNQUFNLHVCQUF1QixDQUFDOzs7O0FBVXJFLE1BQU0sYUFBYTs7Ozs7OztJQWVqQixZQUFZLGdCQUFrQyxFQUFFLE1BQVcsRUFBVSxlQUFnQztRQUFoQyxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDbkcsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDO1FBQ3pDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO0lBQ3ZCLENBQUM7Ozs7Ozs7OztJQU9ELFFBQVEsQ0FBQyxJQUFZLEVBQUUsY0FBbUIsRUFBRSxFQUFFLGFBQWtCLEVBQUUsRUFBRSxRQUFpQjtRQUNuRixJQUFJLENBQUMsSUFBSTtZQUFFLE9BQU07UUFFakIsV0FBVyxHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN6RCxVQUFVLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFVBQVUsQ0FBQyxDQUFDOztjQUVqRCxTQUFTLEdBQUcsSUFBSSxDQUFDLHlCQUF5QixDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsVUFBVSxDQUFDO1FBRTVFLFFBQVE7O1FBQVIsUUFBUTtRQUNSLElBQUksSUFBSSxJQUFJLFNBQVMsSUFBSSxDQUFDLEVBQUU7O2dCQUN0QixPQUFPLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDO1lBQ2hELE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQztZQUMvQixPQUFPLEtBQUssQ0FBQztTQUNk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TSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNO1lBQ2hELFdBQVcsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLO1NBQ3JEO1FBQ0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsR0FBRyxXQUFXLENBQUM7SUFDN0QsQ0FBQztDQUNGOzs7Ozs7O0lBalRDLHlDQUEyQzs7Ozs7O0lBSzNDLCtCQUFvQjs7Ozs7SUFLeUMsd0NBQXdDOzs7Ozs7O01BNlNqRyxxQkFBcUIsR0FBRyx1REFBdUQ7QUFFckYsT0FBTyxFQUFFLGFBQWEsRUFBRSxxQkFBcUIsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAndnVlLXJvdXRlcic7XHJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdGFwLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IFZpZXdNb2RlbENvbnRleHQsIEh0dHBDbGllbnQgfSBmcm9tICdAZmFycmlzL21vYmlsZS1kZXZraXQnO1xyXG5pbXBvcnQgeyBSdGNPcHRpb25zLCBCZWZvcmVOYXZpZ2F0ZVJlcG9uc2VCb2R5LCBCZWZvcmVOYXZpZ2F0ZVJlcXVlc3RCb2R5IH0gZnJvbSAnLi90eXBlcy9pbmRleCc7XHJcbmltcG9ydCB7IEpzQnJpZGdlU2VydmljZSB9IGZyb20gJy4vanMtYnJpZGdlLXNlcnZpY2UvaW5kZXgnO1xyXG5cclxuXHJcblxyXG5cclxuLyoqXHJcbiAqIOi3r+eUseacjeWKoVxyXG4gKi9cclxuY2xhc3MgUm91dGVyU2VydmljZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIFZpZXdNb2RlbOS4iuS4i+aWh1xyXG4gICAqL1xyXG4gIHByaXZhdGUgdmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dDtcclxuXHJcbiAgLyoqXHJcbiAgICogVnVlUm91dGVy5a6e5L6LXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByb3V0ZXI6IGFueTtcclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3Iodmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dCwgcm91dGVyOiBhbnksIHByaXZhdGUganNCcmlkZ2VTZXJ2aWNlOiBKc0JyaWRnZVNlcnZpY2UpIHtcclxuICAgIHRoaXMudmlld01vZGVsQ29udGV4dCA9IHZpZXdNb2RlbENvbnRleHQ7XHJcbiAgICB0aGlzLnJvdXRlciA9IHJvdXRlcjtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOi3r+eUsei3s+i9rFxyXG4gICAqIEBwYXJhbSBwYXRoICAg6Lev55Sx6Lev5b6EXHJcbiAgICogQHBhcmFtIHBhcmFtcyDot6/nlLHlj4LmlbBcclxuICAgKi9cclxuICBuYXZpZ2F0ZShwYXRoOiBzdHJpbmcsIHF1ZXJ5UGFyYW1zOiBhbnkgPSB7fSwgYmFja1BhcmFtczogYW55ID0ge30sIGJhY2tQYXRoPzogc3RyaW5nKSB7XHJcbiAgICBpZiAoIXBhdGgpIHJldHVyblxyXG5cclxuICAgIHF1ZXJ5UGFyYW1zID0gdGhpcy5QYXJhbXNGcm9tU3RyaW5nVG9PYmplY3QocXVlcnlQYXJhbXMpO1xyXG4gICAgYmFja1BhcmFtcyA9IHRoaXMuUGFyYW1zRnJvbVN0cmluZ1RvT2JqZWN0KGJhY2tQYXJhbXMpO1xyXG5cclxuICAgIGNvbnN0IHBhdGhJbmRleCA9IHRoaXMuc2Vzc2lvblN0b3JhZ2VTYXZlSGlzdG9yeShwYXRoLCBiYWNrUGF0aCwgYmFja1BhcmFtcylcclxuXHJcbiAgICAvLyDot6jlt6XnqIvot7PovaxcclxuICAgIGlmIChwYXRoICYmIHBhdGhJbmRleCA+PSAwKSB7XHJcbiAgICAgIGxldCB1cmxQYXRoID0gdGhpcy5zcGxpY2VQYXRoKHBhdGgsIHF1ZXJ5UGFyYW1zKTtcclxuICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSB1cmxQYXRoO1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgd2luZG93WydNT0JJTEVfT1JJR0lOX0JBQ0snXSAmJiB3aW5kb3dbJ01PQklMRV9PUklHSU5fQkFDSyddLnJlZmx1c2hPcmlnaW5Hb2JhY2soKTtcclxuXHJcbiAgICB0aGlzLnJvdXRlci5wdXNoKHtcclxuICAgICAgcGF0aDogcGF0aCxcclxuICAgICAgcXVlcnk6IHF1ZXJ5UGFyYW1zXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVtb3ZlUGFyYW1zKHBhdGhJbmRleCwgcGF0aCkge1xyXG4gICAgbGV0IGVuZCA9IHBhdGguc2VhcmNoKCdcXFxcPycpO1xyXG4gICAgaWYgKGVuZCA9IC0xKSB7XHJcbiAgICAgIGVuZCA9IHBhdGgubGVuZ3RoO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHBhdGguc2xpY2UocGF0aEluZGV4LCBlbmQpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRzZXNzaW9uU3RvcmFnZVNhdmVIaXN0b3J5S2V5KHBhdGgpIHtcclxuICAgIGNvbnN0IHBhdGhJbmRleCA9IHBhdGguc2VhcmNoKCcvYXBwcycpO1xyXG4gICAgLy8g6Leo6aG16Z2i6Lez6L2s56a75byAXHJcbiAgICBpZiAocGF0aCAmJiBwYXRoSW5kZXggPj0gMCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5yZW1vdmVQYXJhbXMocGF0aEluZGV4LCBwYXRoKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLnJvdXRlci5vcHRpb25zLmhpc3RvcnkuYmFzZSArIHBhdGg7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNlc3Npb25TdG9yYWdlU2F2ZUhpc3RvcnkocGF0aCwgYmFja1BhdGgsIGJhY2tQYXJhbXMpIHtcclxuICAgIGNvbnN0IHBhdGhJbmRleCA9IHBhdGguc2VhcmNoKCcvYXBwcycpO1xyXG5cclxuICAgIGNvbnN0IGtleSA9IHRoaXMuZ2V0c2Vzc2lvblN0b3JhZ2VTYXZlSGlzdG9yeUtleShwYXRoKTtcclxuICAgIGxldCBoaXN0b3J5T2JqZWN0ID0ge31cclxuICAgIC8v5Yik5pat5piv5ZCm5Yi25a6a5LqG55uu5qCH6aG16Z2i5b6X6L+U5Zue5Zyw5Z2AXHJcbiAgICBpZiAoYmFja1BhdGgpIHtcclxuICAgICAgY29uc3QgYmFja1BhdGhJbmRleCA9IHBhdGguc2VhcmNoKCcvYXBwcycpO1xyXG4gICAgICAvL+aMh+Wumui/lOWbnui3r+eUseS4uui3qOW3peeoi+i3s+i9rFxyXG4gICAgICBpZiAoYmFja1BhdGhJbmRleCA+PSAwKSB7XHJcbiAgICAgICAgaGlzdG9yeU9iamVjdCA9IHtcclxuICAgICAgICAgIHJvdXRlcldheTogJ2hyZWYnLFxyXG4gICAgICAgICAgcGF0aDogYmFja1BhdGgsXHJcbiAgICAgICAgICBxdWVyeTogYmFja1BhcmFtc1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBoaXN0b3J5T2JqZWN0ID0ge1xyXG4gICAgICAgICAgcm91dGVyV2F5OiAnUm91dGVyJyxcclxuICAgICAgICAgIHBhdGg6IGJhY2tQYXRoLFxyXG4gICAgICAgICAgcXVlcnk6IGJhY2tQYXJhbXNcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShrZXksIEpTT04uc3RyaW5naWZ5KGhpc3RvcnlPYmplY3QpKVxyXG4gICAgICByZXR1cm4gcGF0aEluZGV4O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbGV0IGN1cnJlbnRQYXRoID0gdGhpcy5yb3V0ZXIuY3VycmVudFJvdXRlLnZhbHVlLnBhdGg7XHJcbiAgICAgIC8vIOi3qOmhtemdoui3s+i9rOemu+W8gFxyXG4gICAgICBpZiAocGF0aCAmJiBwYXRoSW5kZXggPj0gMCkge1xyXG4gICAgICAgIC8v5ou85o6l5b2T5YmN6Lev55SxXHJcbiAgICAgICAgY3VycmVudFBhdGggPSAgdGhpcy5yb3V0ZXIub3B0aW9ucy5oaXN0b3J5LmJhc2UgKyB0aGlzLnJvdXRlci5vcHRpb25zLmhpc3RvcnkubG9jYXRpb247XHJcbiAgICAgICAgLy/orrDlvZXlvZPliY3ot6/nlLFcclxuICAgICAgICBoaXN0b3J5T2JqZWN0ID0ge1xyXG4gICAgICAgICAgcm91dGVyV2F5OiAnaHJlZicsXHJcbiAgICAgICAgICBwYXRoOiBjdXJyZW50UGF0aCxcclxuICAgICAgICAgIHF1ZXJ5OiBiYWNrUGFyYW1zXHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIOi3r+eUseaWueW8j+i3s+i9rOiusOW9lVxyXG4gICAgICAgIGhpc3RvcnlPYmplY3QgPSB7XHJcbiAgICAgICAgICByb3V0ZXJXYXk6ICdSb3V0ZXInLFxyXG4gICAgICAgICAgcGF0aDogY3VycmVudFBhdGgsXHJcbiAgICAgICAgICBxdWVyeTogYmFja1BhcmFtc1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKGtleSwgSlNPTi5zdHJpbmdpZnkoaGlzdG9yeU9iamVjdCkpXHJcbiAgICAgIHJldHVybiBwYXRoSW5kZXg7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDluKbnu7TluqbnmoTot6/nlLHot7PovaxcclxuICAgKi9cclxuICBuYXZpZ2F0ZUZvclJ0YyhwYXRoOiBzdHJpbmcsIHF1ZXJ5UGFyYW1zOiBhbnkgPSB7fSwgYmFja1BhcmFtczogYW55ID0ge30sIGJhY2tQYXRoPzogc3RyaW5nKSB7XHJcblxyXG4gICAgaWYgKCFxdWVyeVBhcmFtcyB8fCAhcXVlcnlQYXJhbXMubWV0YWRhdGFJZCkge1xyXG4gICAgICB0aGlzLm5hdmlnYXRlKHBhdGgsIHF1ZXJ5UGFyYW1zLCBiYWNrUGFyYW1zLCBiYWNrUGF0aCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcnRjT3B0aW9uczogUnRjT3B0aW9ucyA9IHtcclxuICAgICAgbWV0YWRhdGFJZDogcXVlcnlQYXJhbXMubWV0YWRhdGFJZCxcclxuICAgICAgd2l0aERpbXM6IGZhbHNlLFxyXG4gICAgICBkaW0xOiBxdWVyeVBhcmFtcy5kaW0xLFxyXG4gICAgICBkaW0yOiBxdWVyeVBhcmFtcy5kaW0yXHJcbiAgICB9O1xyXG4gICAgZGVsZXRlIHF1ZXJ5UGFyYW1zWydtZXRhZGF0YUlkJ107XHJcbiAgICBkZWxldGUgcXVlcnlQYXJhbXNbJ2RpbTEnXTtcclxuICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1snZGltMiddO1xyXG5cclxuICAgIGNvbnN0IGNvcnJlY3RSdGNPcHRpb25zJCA9IHRoaXMuY29ycmVjdFJ0Y09wdGlvbnMocnRjT3B0aW9ucyk7XHJcbiAgICBjb25zdCBleHRlbmRlZFBhdGgkID0gY29ycmVjdFJ0Y09wdGlvbnMkLnBpcGUoXHJcbiAgICAgIG1hcCgoY29ycmVjdGVkUnRjT3B0aW9uczogUnRjT3B0aW9ucykgPT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldEV4dGVuZFBhdGgocGF0aCwgY29ycmVjdGVkUnRjT3B0aW9ucyk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIGNvbnN0IHJlc3VsdCQgPSBleHRlbmRlZFBhdGgkLnBpcGUoXHJcbiAgICAgIHRhcCgoZXh0ZW5kZWRQYXRoOiBzdHJpbmcpID0+IHtcclxuICAgICAgICB0aGlzLm5hdmlnYXRlKGV4dGVuZGVkUGF0aCwgcXVlcnlQYXJhbXMsIGJhY2tQYXJhbXMpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICByZXN1bHQkLnN1YnNjcmliZSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog57qg5q2j57u05bqm5L+h5oGvXHJcbiAgICogQHN1bW1hcnlcclxuICAgKiAx44CB6Z2e6L+Q6KGM5pe25a6a5Yi26KGo5Y2V77yMd2lkdGhEaW1zPWZhbHNlLCDnu7TluqbkuLrnqbrvvJtcclxuICAgKiAy44CB6L+Q6KGM5pe25a6a5Yi26KGo5Y2V77ya57u05bqm5YC85LiN5a2Y5Zyo5pe277yM5YiZ57qg5q2j5Li6cHVibGlj77ybXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjb3JyZWN0UnRjT3B0aW9ucyhydGNPcHRpb25zOiBSdGNPcHRpb25zKTogT2JzZXJ2YWJsZTxSdGNPcHRpb25zPiB7XHJcbiAgICBjb25zdCBkaW0xID0gcnRjT3B0aW9ucy5kaW0xIHx8ICdwdWJsaWMnO1xyXG4gICAgY29uc3QgZGltMiA9IHJ0Y09wdGlvbnMuZGltMiB8fCAncHVibGljJztcclxuICAgIGNvbnN0IG1ldGFkYXRhSWQgPSBydGNPcHRpb25zLm1ldGFkYXRhSWQ7XHJcbiAgICBjb25zdCBodHRwQ2xpZW50ID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LmluamVjdG9yLmdldDxIdHRwQ2xpZW50PihIdHRwQ2xpZW50KTtcclxuXHJcbiAgICBjb25zdCB1cmwgPSAnL2FwaS9ydW50aW1lL2JjYy92MS4wL3RlbXBsYXRlL2JlZm9yZU5hdmlnYXRlJztcclxuICAgIGNvbnN0IGJvZHk6IEJlZm9yZU5hdmlnYXRlUmVxdWVzdEJvZHkgPSB7XHJcbiAgICAgICAgaXNSb290TWV0YWRhdGE6IHRydWUsXHJcbiAgICAgICAgbWV0YWRhdGFJZDogbWV0YWRhdGFJZCxcclxuICAgICAgICBkaW0xOiBkaW0xLFxyXG4gICAgICAgIGRpbTI6IGRpbTIsXHJcbiAgICB9O1xyXG4gICAgY29uc3QgYmVmb3JlTmF2aWdhdGUkID0gaHR0cENsaWVudC5wb3N0KHVybCwgYm9keSwgbnVsbCkucGlwZShcclxuICAgICAgbWFwKChyZXN1bHQ6IEJlZm9yZU5hdmlnYXRlUmVwb25zZUJvZHkpID0+IHtcclxuICAgICAgICBjb25zdCBjb3JyZWN0ZWRSdGNPcHRpb25zOiBSdGNPcHRpb25zID0ge1xyXG4gICAgICAgICAgbWV0YWRhdGFJZDogcmVzdWx0Lm1ldGFkYXRhSWQsXHJcbiAgICAgICAgICB3aXRoRGltczogcmVzdWx0LndpdGhEaW1zID09PSAxID8gdHJ1ZSA6IGZhbHNlLFxyXG4gICAgICAgICAgZGltMTogcmVzdWx0LmRpbTEsXHJcbiAgICAgICAgICBkaW0yOiByZXN1bHQuZGltMlxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHJldHVybiBjb3JyZWN0ZWRSdGNPcHRpb25zO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICAgIHJldHVybiBiZWZvcmVOYXZpZ2F0ZSQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bov5DooYzml7blrprliLbooajljZXlnLDlnYBcclxuICAgKi9cclxuICBwcml2YXRlIGdldEV4dGVuZFBhdGgocGF0aDogc3RyaW5nLCBydGNPcHRpb25zOiBSdGNPcHRpb25zKTogc3RyaW5nIHtcclxuXHJcbiAgICBpZiAocnRjT3B0aW9ucy53aXRoRGltcyA9PT0gZmFsc2UpIHtcclxuICAgICAgcmV0dXJuIHBhdGg7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgYXJyUGF0aCA9IHBhdGguc3BsaXQoJ2luZGV4Lmh0bWwnKTtcclxuICAgIGNvbnN0IGFwcGVuZCA9IGAke3J0Y09wdGlvbnMuZGltMX0vJHtydGNPcHRpb25zLmRpbTJ9L2luZGV4Lmh0bWxgLnRvTG93ZXJDYXNlKCk7XHJcbiAgICBjb25zdCBleHRlbmRQYXRoID0gYXJyUGF0aC5qb2luKGFwcGVuZCk7XHJcbiAgICByZXR1cm4gZXh0ZW5kUGF0aDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaLvOaOpXVybOi3r+W+hFxyXG4gICAqIEBwYXJhbSBwYXRoIOi3r+W+hFxyXG4gICAqIEBwYXJhbSBwYXJhbXMg5Y+C5pWwXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzcGxpY2VQYXRoKHBhdGg6IHN0cmluZywgcGFyYW1zOiBhbnkpIHtcclxuICAgIGxldCB1cmxQYXRoID0gcGF0aFxyXG4gICAgY29uc3QgZW5kID0gdXJsUGF0aC5zZWFyY2goJ1xcXFw/Jyk7XHJcbiAgICBpZiAoZW5kID4gLTEpIHtcclxuICAgICAgdXJsUGF0aCA9IHVybFBhdGguc2xpY2UoMCwgZW5kKVxyXG4gICAgfVxyXG4gICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHBhcmFtcyk7XHJcbiAgICBpZiAoa2V5cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIHVybFBhdGggPSB1cmxQYXRoICsgJz8nO1xyXG4gICAgICBrZXlzLmZvckVhY2goZWxlbWVudCA9PiB7XHJcbiAgICAgICAgdXJsUGF0aCA9IHVybFBhdGggKyBlbGVtZW50ICsgJz0nICsgcGFyYW1zW2Ake2VsZW1lbnR9YF0gKyAnJidcclxuICAgICAgfSk7XHJcbiAgICAgIHVybFBhdGggPSB1cmxQYXRoLnNsaWNlKDAsIHVybFBhdGgubGVuZ3RoIC0gMSlcclxuICAgIH1cclxuICAgIHJldHVybiB1cmxQYXRoO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBQYXJhbXNGcm9tU3RyaW5nVG9PYmplY3QocGFyYW1zOiBhbnkpOiBvYmplY3Qge1xyXG5cclxuICAgIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwocGFyYW1zKSA9PT0gJ1tvYmplY3QgT2JqZWN0XScpIHtcclxuICAgICAgcmV0dXJuIHBhcmFtcztcclxuICAgIH1cclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBwYXJhbXMgPSBKU09OLnBhcnNlKHBhcmFtcyk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBpZiAoIXBhcmFtcykge1xyXG4gICAgICAgIHBhcmFtcyA9IHt9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcGFyYW1zID0ge31cclxuICAgICAgICBjb25zb2xlLmVycm9yKCfot6/nlLHkvKDlj4JwYXJhbXPkuI3mmK9KU09O5Liy5qC85byPJylcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwocGFyYW1zKSAhPT0gJ1tvYmplY3QgT2JqZWN0XScpIHtcclxuICAgICAgcmV0dXJuIHt9O1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBwYXJhbXM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICog6Lev55Sx6Lez6L2sXHJcbiAqIEBwYXJhbSBwYXRoICAg6Lev55Sx6Lev5b6EXHJcbiAqIEBwYXJhbSBwYXJhbXMg6Lev55Sx5Y+C5pWwXHJcbiAqL1xyXG4gIG5hdmlnYXRlUmVwbGFjZShwYXRoOiBzdHJpbmcsIHF1ZXJ5UGFyYW1zOiBhbnkgPSB7fSkge1xyXG4gICAgaWYgKHR5cGVvZiBxdWVyeVBhcmFtcyA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgcXVlcnlQYXJhbXMgPSBKU09OLnBhcnNlKHF1ZXJ5UGFyYW1zKTtcclxuICAgIH1cclxuICAgIHRoaXMucm91dGVyLnJlcGxhY2Uoe1xyXG4gICAgICBwYXRoOiBwYXRoLFxyXG4gICAgICBxdWVyeTogcXVlcnlQYXJhbXNcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5ZCO6YCAXHJcbiAgICovXHJcbiAgZ29CYWNrKHBhcmFtcykge1xyXG4gICAgcGFyYW1zID0gdGhpcy5QYXJhbXNGcm9tU3RyaW5nVG9PYmplY3QocGFyYW1zKTtcclxuICAgIGNvbnN0IGN1cnJlbnRQYXRoID0gdGhpcy5yb3V0ZXIub3B0aW9ucy5oaXN0b3J5LmJhc2UgKyB0aGlzLnJvdXRlci5jdXJyZW50Um91dGUudmFsdWUucGF0aDtcclxuICAgIGxldCBuZWVkX2dvX2JhY2sgPSBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKGN1cnJlbnRQYXRoKTtcclxuICAgIGlmICghbmVlZF9nb19iYWNrKSB7XHJcbiAgICAgIGlmICh3aW5kb3cudG9wLmxvY2F0aW9uLnBhdGhuYW1lLmluZGV4T2YoJ21vYmlsZXRhc2tjZW50ZXInKSA+IC0xKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuanNCcmlkZ2VTZXJ2aWNlLmNsb3NlV2luZG93KClcclxuICAgICAgcmV0dXJuXHJcbiAgICB9XHJcbiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMocGFyYW1zKTtcclxuXHJcbiAgICBuZWVkX2dvX2JhY2sgPSBKU09OLnBhcnNlKG5lZWRfZ29fYmFjayk7XHJcbiAgICBpZiAobmVlZF9nb19iYWNrICYmIG5lZWRfZ29fYmFja1sncm91dGVyV2F5J10gPT09ICdSb3V0ZXInKSB7XHJcbiAgICAgIGxldCBxdWVyeSA9IG5lZWRfZ29fYmFja1sncXVlcnknXTtcclxuICAgICAgaWYgKGtleXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHF1ZXJ5ID0geyAuLi5xdWVyeSwgLi4ucGFyYW1zIH1cclxuICAgICAgfVxyXG4gICAgICB0aGlzLnJvdXRlci5wdXNoKHtcclxuICAgICAgICBxdWVyeSxcclxuICAgICAgICBwYXRoOiBuZWVkX2dvX2JhY2tbJ3BhdGgnXSxcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpZiAobmVlZF9nb19iYWNrICYmIG5lZWRfZ29fYmFja1sncm91dGVyV2F5J10gPT09ICdocmVmJykge1xyXG4gICAgICBsZXQgcXVlcnkgPSBuZWVkX2dvX2JhY2tbJ3F1ZXJ5J107XHJcbiAgICAgIGlmIChrZXlzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBxdWVyeSA9IHsgLi4ucXVlcnksIC4uLnBhcmFtcyB9XHJcbiAgICAgIH1cclxuICAgICAgbGV0IHBhdGggPSBuZWVkX2dvX2JhY2tbJ3BhdGgnXTtcclxuXHJcbiAgICAgIHBhdGggPSB0aGlzLnNwbGljZVBhdGgocGF0aCwgcXVlcnkpO1xyXG5cclxuICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBwYXRoO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5pig5bCE6Lev55Sx54q25oCBXHJcbiAgICovXHJcbiAgbWFwcGluZ1RvVUlTdGF0ZSgpIHtcclxuICAgIGNvbnN0IHJvdXRlclN0YXRlID0ge1xyXG4gICAgICBwYXJhbXM6IHRoaXMucm91dGVyLmN1cnJlbnRSb3V0ZVsndmFsdWUnXS5wYXJhbXMsXHJcbiAgICAgIHF1ZXJ5UGFyYW1zOiB0aGlzLnJvdXRlci5jdXJyZW50Um91dGVbJ3ZhbHVlJ10ucXVlcnlcclxuICAgIH07XHJcbiAgICB0aGlzLnZpZXdNb2RlbENvbnRleHQudWlTdGF0ZVsncm91dGVyU3RhdGUnXSA9IHJvdXRlclN0YXRlO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIFRva2VuXHJcbiAqIEB0b2Rv77ya5Li05pe25pa55qGI77yM55u05o6l5rOo5YWlVnVlUm91dGVy5a6e5L6L44CCXHJcbiAqL1xyXG5jb25zdCBST1VURVJfSU5TVEFOQ0VfVE9LRU4gPSAnQGZhcnJpcy9tb2JpbGUtY29tbWFuZC1zZXJ2aWNlcy9ST1VURVJfSU5TVEFOQ0VfVE9LRU4nO1xyXG5cclxuZXhwb3J0IHsgUm91dGVyU2VydmljZSwgUk9VVEVSX0lOU1RBTkNFX1RPS0VOIH07XHJcbiJdfQ==