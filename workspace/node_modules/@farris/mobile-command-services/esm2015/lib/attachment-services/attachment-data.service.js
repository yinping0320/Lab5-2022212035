/**
 * @fileoverview added by tsickle
 * Generated from: lib/attachment-services/attachment-data.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of } from 'rxjs';
import { tap, switchMap, map } from 'rxjs/operators';
import { HttpMethods, BindingPathConverter, DataChangeType } from '@farris/mobile-devkit';
import { BefDataPathUtil } from '@farris/mobile-bef';
import { AttachmentUtil } from './attachment.util';
/**
 * 附件数据服务
 */
class AttachmentDataService {
    /**
     * 实体仓库
     * @private
     * @return {?}
     */
    get befRepository() {
        return (/** @type {?} */ (this.viewModelContext.repository));
    }
    /**
     * 绑定数据
     * @private
     * @return {?}
     */
    get bindingData() {
        return this.viewModelContext.bindingData;
    }
    /**
     * 构造函数
     * @param {?} viewModelContext
     */
    constructor(viewModelContext) {
        this.viewModelContext = viewModelContext;
    }
    /**
     * 更新附件信息
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfo
     * @return {?}
     */
    updateRow(attachmentInfoFieldPath, attachmentInfo) {
        /** @type {?} */
        const apiProxy = this.befRepository.apiProxy;
        /** @type {?} */
        const updateUrl = `${apiProxy.baseUrl}/service/updateattachment`;
        /** @type {?} */
        const serverAttachInfo = this.createUpdateAttachInfo(attachmentInfoFieldPath, attachmentInfo);
        /** @type {?} */
        const body = {
            updateAttachInfo: serverAttachInfo
        };
        /** @type {?} */
        const requestConfig = {
            body: body
        };
        console.log('loading show ...');
        return apiProxy.request(HttpMethods.PUT, updateUrl, requestConfig).pipe(switchMap((/**
         * @param {?} result
         * @return {?}
         */
        (result) => {
            return this.syncAttachmentInfosToClient();
        })), tap((/**
         * @return {?}
         */
        () => {
            console.log('loading hide ...');
        })));
    }
    /**
     * 批量创建附件行数据
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfos
     * @return {?}
     */
    updateRows(attachmentInfoFieldPath, attachmentInfos) {
        /** @type {?} */
        const apiProxy = this.befRepository.apiProxy;
        /** @type {?} */
        const updateUrl = `${apiProxy.baseUrl}/service/batchuploadattachment`;
        /** @type {?} */
        const serverAttachInfo = this.createBatchCreateAttachInfo(attachmentInfoFieldPath, attachmentInfos);
        /** @type {?} */
        const isRootEntity = serverAttachInfo.NodeCodes.length === 0;
        /** @type {?} */
        const body = {
            batchUploadInfo: serverAttachInfo
        };
        /** @type {?} */
        const requestConfig = {
            body: body
        };
        console.log('loading show ...');
        return apiProxy.request(HttpMethods.PUT, updateUrl, requestConfig).pipe(switchMap((/**
         * @param {?} result
         * @return {?}
         */
        (result) => {
            return this.appendAttachmentInfosToClient(result, isRootEntity);
        })), tap((/**
         * @return {?}
         */
        () => {
            console.log('hide loading ...');
        })));
    }
    /**
     * 创建服务器端需要的更新信息
     * @private
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfo
     * @return {?}
     */
    createUpdateAttachInfo(attachmentInfoFieldPath, attachmentInfo) {
        /** @type {?} */
        const attachmentId = attachmentInfo.attachmentId;
        /** @type {?} */
        const parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        /** @type {?} */
        const nodeCodes = BefDataPathUtil.convertToObjectCodes(parentBindingPathArray, this.bindingData);
        /** @type {?} */
        const hiretryIds = BefDataPathUtil.convertToDataIdsForUpdate(parentBindingPathArray, this.bindingData);
        /** @type {?} */
        const serverAttachInfo = {
            NodeCodes: nodeCodes,
            HiretryIds: hiretryIds,
            AttachmentIds: [attachmentId],
            AttachmentId: attachmentId
        };
        return serverAttachInfo;
    }
    /**
     * 创建服务器端需要的批量新增附件信息
     * @private
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfo
     * @return {?}
     */
    createBatchCreateAttachInfo(attachmentInfoFieldPath, attachmentInfo) {
        /** @type {?} */
        const attachmentIds = AttachmentUtil.peekAttachmentIds(attachmentInfo);
        /** @type {?} */
        const parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        /** @type {?} */
        const nodeCodes = BefDataPathUtil.convertToObjectCodes(parentBindingPathArray, this.bindingData);
        /** @type {?} */
        const hiretryIds = BefDataPathUtil.convertToDataIdsForAdd(parentBindingPathArray, this.bindingData);
        /** @type {?} */
        const serverAttachInfo = {
            NodeCodes: nodeCodes,
            HiretryIds: hiretryIds,
            AttachmentIds: attachmentIds,
            AttachmentId: null
        };
        return serverAttachInfo;
    }
    /**
     * 同步服务器端最新信息到客户端
     * \@todo:
     * 1、主对象批量新增时不支持
     * @return {?}
     */
    syncAttachmentInfosToClient() {
        /** @type {?} */
        const rootDataId = this.bindingData.list.currentId;
        return this.befRepository.updateEntityById(rootDataId);
    }
    /**
     * 追击主表数据到客户端
     * @param {?} listData
     * @param {?} isRootEntity
     * @return {?}
     */
    appendAttachmentInfosToClient(listData, isRootEntity) {
        if (isRootEntity === true) {
            /** @type {?} */
            const entities = this.befRepository.buildEntities(listData);
            this.befRepository.entityCollection.addEntities(entities);
            return of(listData);
        }
        else {
            return this.syncAttachmentInfosToClient().pipe(map((/**
             * @return {?}
             */
            () => {
                this.befRepository.dataChangeHistory.addChange({ dataId: listData[0].id, changeType: DataChangeType.Add });
                return listData;
            })));
        }
    }
}
if (false) {
    /**
     * ViewModel上下文
     * @type {?}
     * @private
     */
    AttachmentDataService.prototype.viewModelContext;
}
export { AttachmentDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0YWNobWVudC1kYXRhLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2F0dGFjaG1lbnQtc2VydmljZXMvYXR0YWNobWVudC1kYXRhLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JELE9BQU8sRUFBcUIsV0FBVyxFQUF5QyxvQkFBb0IsRUFBRSxjQUFjLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNwSixPQUFPLEVBQWlCLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXBFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQzs7OztBQUtuRCxNQUFNLHFCQUFxQjs7Ozs7O0lBVXpCLElBQVksYUFBYTtRQUN2QixPQUFPLG1CQUFBLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEVBQXlCLENBQUM7SUFDbkUsQ0FBQzs7Ozs7O0lBS0QsSUFBWSxXQUFXO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQztJQUMzQyxDQUFDOzs7OztJQUtELFlBQVksZ0JBQWtDO1FBQzVDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztJQUMzQyxDQUFDOzs7Ozs7O0lBS00sU0FBUyxDQUFDLHVCQUErQixFQUFFLGNBQThCOztjQUN4RSxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFROztjQUN0QyxTQUFTLEdBQUcsR0FBRyxRQUFRLENBQUMsT0FBTywyQkFBMkI7O2NBQzFELGdCQUFnQixHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyx1QkFBdUIsRUFBRSxjQUFjLENBQUM7O2NBQ3ZG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QUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YXAsIHN3aXRjaE1hcCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBIdHRwUmVxdWVzdENvbmZpZywgSHR0cE1ldGhvZHMsIEVudGl0eSwgVmlld01vZGVsQ29udGV4dCwgQmluZGluZ0RhdGEsIEJpbmRpbmdQYXRoQ29udmVydGVyLCBEYXRhQ2hhbmdlVHlwZSB9IGZyb20gJ0BmYXJyaXMvbW9iaWxlLWRldmtpdCc7XHJcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnksIEJlZkRhdGFQYXRoVXRpbCB9IGZyb20gJ0BmYXJyaXMvbW9iaWxlLWJlZic7XHJcbmltcG9ydCB7IEF0dGFjaG1lbnRJbmZvLCBTZXJ2ZXJBdHRhY2htZW50SW5mbyB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBBdHRhY2htZW50VXRpbCB9IGZyb20gJy4vYXR0YWNobWVudC51dGlsJztcclxuXHJcbi8qKlxyXG4gKiDpmYTku7bmlbDmja7mnI3liqFcclxuICovXHJcbmNsYXNzIEF0dGFjaG1lbnREYXRhU2VydmljZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIFZpZXdNb2RlbOS4iuS4i+aWh1xyXG4gICAqL1xyXG4gIHByaXZhdGUgdmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dFxyXG5cclxuICAvKipcclxuICAgKiDlrp7kvZPku5PlupNcclxuICAgKi9cclxuICBwcml2YXRlIGdldCBiZWZSZXBvc2l0b3J5KCk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiB7XHJcbiAgICByZXR1cm4gdGhpcy52aWV3TW9kZWxDb250ZXh0LnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxFbnRpdHk+O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog57uR5a6a5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXQgYmluZGluZ0RhdGEoKTogQmluZGluZ0RhdGEge1xyXG4gICAgcmV0dXJuIHRoaXMudmlld01vZGVsQ29udGV4dC5iaW5kaW5nRGF0YTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKHZpZXdNb2RlbENvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQpIHtcclxuICAgIHRoaXMudmlld01vZGVsQ29udGV4dCA9IHZpZXdNb2RlbENvbnRleHQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmm7TmlrDpmYTku7bkv6Hmga9cclxuICAgKi9cclxuICBwdWJsaWMgdXBkYXRlUm93KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIGF0dGFjaG1lbnRJbmZvOiBBdHRhY2htZW50SW5mbyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCBhcGlQcm94eSA9IHRoaXMuYmVmUmVwb3NpdG9yeS5hcGlQcm94eTtcclxuICAgIGNvbnN0IHVwZGF0ZVVybCA9IGAke2FwaVByb3h5LmJhc2VVcmx9L3NlcnZpY2UvdXBkYXRlYXR0YWNobWVudGA7XHJcbiAgICBjb25zdCBzZXJ2ZXJBdHRhY2hJbmZvID0gdGhpcy5jcmVhdGVVcGRhdGVBdHRhY2hJbmZvKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBhdHRhY2htZW50SW5mbyk7XHJcbiAgICBjb25zdCBib2R5ID0ge1xyXG4gICAgICB1cGRhdGVBdHRhY2hJbmZvOiBzZXJ2ZXJBdHRhY2hJbmZvXHJcbiAgICB9O1xyXG4gICAgY29uc3QgcmVxdWVzdENvbmZpZzogSHR0cFJlcXVlc3RDb25maWcgPSB7XHJcbiAgICAgIGJvZHk6IGJvZHlcclxuICAgIH07XHJcblxyXG4gICAgY29uc29sZS5sb2coJ2xvYWRpbmcgc2hvdyAuLi4nKTtcclxuICAgIHJldHVybiBhcGlQcm94eS5yZXF1ZXN0KEh0dHBNZXRob2RzLlBVVCwgdXBkYXRlVXJsLCByZXF1ZXN0Q29uZmlnKS5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKHJlc3VsdDogYW55KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc3luY0F0dGFjaG1lbnRJbmZvc1RvQ2xpZW50KCk7XHJcbiAgICAgIH0pLFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdsb2FkaW5nIGhpZGUgLi4uJyk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5om56YeP5Yib5bu66ZmE5Lu26KGM5pWw5o2uXHJcbiAgICovXHJcbiAgcHVibGljIHVwZGF0ZVJvd3MoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgYXR0YWNobWVudEluZm9zOiBBdHRhY2htZW50SW5mb1tdKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IGFwaVByb3h5ID0gdGhpcy5iZWZSZXBvc2l0b3J5LmFwaVByb3h5O1xyXG4gICAgY29uc3QgdXBkYXRlVXJsID0gYCR7YXBpUHJveHkuYmFzZVVybH0vc2VydmljZS9iYXRjaHVwbG9hZGF0dGFjaG1lbnRgO1xyXG4gICAgY29uc3Qgc2VydmVyQXR0YWNoSW5mbyA9IHRoaXMuY3JlYXRlQmF0Y2hDcmVhdGVBdHRhY2hJbmZvKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBhdHRhY2htZW50SW5mb3MpO1xyXG4gICAgY29uc3QgaXNSb290RW50aXR5ID0gc2VydmVyQXR0YWNoSW5mby5Ob2RlQ29kZXMubGVuZ3RoID09PSAwO1xyXG5cclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgIGJhdGNoVXBsb2FkSW5mbzogc2VydmVyQXR0YWNoSW5mb1xyXG4gICAgfTtcclxuICAgIGNvbnN0IHJlcXVlc3RDb25maWc6IEh0dHBSZXF1ZXN0Q29uZmlnID0ge1xyXG4gICAgICBib2R5OiBib2R5XHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnNvbGUubG9nKCdsb2FkaW5nIHNob3cgLi4uJyk7XHJcbiAgICByZXR1cm4gYXBpUHJveHkucmVxdWVzdChIdHRwTWV0aG9kcy5QVVQsIHVwZGF0ZVVybCwgcmVxdWVzdENvbmZpZykucGlwZShcclxuICAgICAgc3dpdGNoTWFwKChyZXN1bHQ6IGFueSkgPT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmFwcGVuZEF0dGFjaG1lbnRJbmZvc1RvQ2xpZW50KHJlc3VsdCwgaXNSb290RW50aXR5KTtcclxuICAgICAgfSksXHJcbiAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ2hpZGUgbG9hZGluZyAuLi4nKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliJvlu7rmnI3liqHlmajnq6/pnIDopoHnmoTmm7TmlrDkv6Hmga9cclxuICAgKi9cclxuICBwcml2YXRlIGNyZWF0ZVVwZGF0ZUF0dGFjaEluZm8oYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgYXR0YWNobWVudEluZm86IEF0dGFjaG1lbnRJbmZvKTogU2VydmVyQXR0YWNobWVudEluZm8ge1xyXG5cclxuICAgIGNvbnN0IGF0dGFjaG1lbnRJZCA9IGF0dGFjaG1lbnRJbmZvLmF0dGFjaG1lbnRJZDtcclxuICAgIGNvbnN0IHBhcmVudEJpbmRpbmdQYXRoQXJyYXkgPSBCaW5kaW5nUGF0aENvbnZlcnRlci50b0JpbmRpbmdQYXRoQXJyYXkoYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xyXG4gICAgcGFyZW50QmluZGluZ1BhdGhBcnJheS5wb3AoKTtcclxuICAgIGNvbnN0IG5vZGVDb2RlcyA9IEJlZkRhdGFQYXRoVXRpbC5jb252ZXJ0VG9PYmplY3RDb2RlcyhwYXJlbnRCaW5kaW5nUGF0aEFycmF5LCB0aGlzLmJpbmRpbmdEYXRhKTtcclxuICAgIGNvbnN0IGhpcmV0cnlJZHMgPSBCZWZEYXRhUGF0aFV0aWwuY29udmVydFRvRGF0YUlkc0ZvclVwZGF0ZShwYXJlbnRCaW5kaW5nUGF0aEFycmF5LCB0aGlzLmJpbmRpbmdEYXRhKTtcclxuXHJcbiAgICBjb25zdCBzZXJ2ZXJBdHRhY2hJbmZvOiBTZXJ2ZXJBdHRhY2htZW50SW5mbyA9IHtcclxuICAgICAgTm9kZUNvZGVzOiBub2RlQ29kZXMsXHJcbiAgICAgIEhpcmV0cnlJZHM6IGhpcmV0cnlJZHMsXHJcbiAgICAgIEF0dGFjaG1lbnRJZHM6IFthdHRhY2htZW50SWRdLFxyXG4gICAgICBBdHRhY2htZW50SWQ6IGF0dGFjaG1lbnRJZFxyXG4gICAgfTtcclxuXHJcbiAgICByZXR1cm4gc2VydmVyQXR0YWNoSW5mbztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIm+W7uuacjeWKoeWZqOerr+mcgOimgeeahOaJuemHj+aWsOWinumZhOS7tuS/oeaBr1xyXG4gICAqL1xyXG4gIHByaXZhdGUgY3JlYXRlQmF0Y2hDcmVhdGVBdHRhY2hJbmZvKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIGF0dGFjaG1lbnRJbmZvOiBBdHRhY2htZW50SW5mb1tdKTogU2VydmVyQXR0YWNobWVudEluZm8ge1xyXG4gICAgY29uc3QgYXR0YWNobWVudElkcyA9IEF0dGFjaG1lbnRVdGlsLnBlZWtBdHRhY2htZW50SWRzKGF0dGFjaG1lbnRJbmZvKTtcclxuXHJcbiAgICBjb25zdCBwYXJlbnRCaW5kaW5nUGF0aEFycmF5ID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcclxuICAgIHBhcmVudEJpbmRpbmdQYXRoQXJyYXkucG9wKCk7XHJcbiAgICBjb25zdCBub2RlQ29kZXMgPSBCZWZEYXRhUGF0aFV0aWwuY29udmVydFRvT2JqZWN0Q29kZXMocGFyZW50QmluZGluZ1BhdGhBcnJheSwgdGhpcy5iaW5kaW5nRGF0YSk7XHJcbiAgICBjb25zdCBoaXJldHJ5SWRzID0gQmVmRGF0YVBhdGhVdGlsLmNvbnZlcnRUb0RhdGFJZHNGb3JBZGQocGFyZW50QmluZGluZ1BhdGhBcnJheSwgdGhpcy5iaW5kaW5nRGF0YSk7XHJcblxyXG4gICAgY29uc3Qgc2VydmVyQXR0YWNoSW5mbyA9IHtcclxuICAgICAgTm9kZUNvZGVzOiBub2RlQ29kZXMsXHJcbiAgICAgIEhpcmV0cnlJZHM6IGhpcmV0cnlJZHMsXHJcbiAgICAgIEF0dGFjaG1lbnRJZHM6IGF0dGFjaG1lbnRJZHMsXHJcbiAgICAgIEF0dGFjaG1lbnRJZDogbnVsbFxyXG4gICAgfTtcclxuXHJcbiAgICByZXR1cm4gc2VydmVyQXR0YWNoSW5mbztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWQjOatpeacjeWKoeWZqOerr+acgOaWsOS/oeaBr+WIsOWuouaIt+err1xyXG4gICAqIEB0b2RvOlxyXG4gICAqIDHjgIHkuLvlr7nosaHmibnph4/mlrDlop7ml7bkuI3mlK/mjIFcclxuICAgKi9cclxuICBwdWJsaWMgc3luY0F0dGFjaG1lbnRJbmZvc1RvQ2xpZW50KCkge1xyXG4gICAgY29uc3Qgcm9vdERhdGFJZCA9IHRoaXMuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XHJcbiAgICByZXR1cm4gdGhpcy5iZWZSZXBvc2l0b3J5LnVwZGF0ZUVudGl0eUJ5SWQocm9vdERhdGFJZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDov73lh7vkuLvooajmlbDmja7liLDlrqLmiLfnq69cclxuICAgKi9cclxuICBwdWJsaWMgYXBwZW5kQXR0YWNobWVudEluZm9zVG9DbGllbnQobGlzdERhdGE6IGFueVtdLCBpc1Jvb3RFbnRpdHk6IGJvb2xlYW4pOiBPYnNlcnZhYmxlPGFueVtdPiB7XHJcbiAgICBpZiAoaXNSb290RW50aXR5ID09PSB0cnVlKSB7XHJcbiAgICAgIGNvbnN0IGVudGl0aWVzID0gdGhpcy5iZWZSZXBvc2l0b3J5LmJ1aWxkRW50aXRpZXMobGlzdERhdGEpO1xyXG4gICAgICB0aGlzLmJlZlJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdGllcyhlbnRpdGllcyk7XHJcbiAgICAgIHJldHVybiBvZihsaXN0RGF0YSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdGhpcy5zeW5jQXR0YWNobWVudEluZm9zVG9DbGllbnQoKS5waXBlKFxyXG4gICAgICAgIG1hcCgoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmJlZlJlcG9zaXRvcnkuZGF0YUNoYW5nZUhpc3RvcnkuYWRkQ2hhbmdlKHsgZGF0YUlkOiBsaXN0RGF0YVswXS5pZCwgY2hhbmdlVHlwZTogRGF0YUNoYW5nZVR5cGUuQWRkIH0pO1xyXG4gICAgICAgICAgcmV0dXJuIGxpc3REYXRhO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxufVxyXG5cclxuZXhwb3J0IHsgQXR0YWNobWVudERhdGFTZXJ2aWNlIH07XHJcbiJdfQ==