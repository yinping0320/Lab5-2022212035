/**
 * @fileoverview added by tsickle
 * Generated from: lib/attachment-services/attachment.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { EMPTY, forkJoin } from 'rxjs';
import { tap } from 'rxjs/operators';
import { BindingPathConverter } from '@farris/mobile-devkit';
import { AttachmentUtil } from './attachment.util';
/**
 * 附件服务
 */
class AttachmentService {
    /**
     * 构造函数
     * @param {?} viewModelContext
     * @param {?} entityService
     * @param {?} removeDataService
     * @param {?} attachDataService
     */
    constructor(viewModelContext, entityService, removeDataService, attachDataService) {
        /**
         * 默认根目录
         */
        this.defaultRootDirId = 'default-root';
        this.viewModelContext = viewModelContext;
        this.attachDataService = attachDataService;
        this.entityService = entityService;
        this.removeDataService = removeDataService;
    }
    /**
     * 默认子目录
     * @private
     * @return {?}
     */
    get defaultParentDirName() {
        return this.viewModelContext.bindingData.list.currentId;
    }
    /**
     * 上传单个文件
     * @param {?} attachmentInfoFieldPath
     * @param {?=} rootDirId
     * @param {?=} parentDirName
     * @return {?}
     */
    uploadAndUpdateRow(attachmentInfoFieldPath, rootDirId, parentDirName) {
        /** @type {?} */
        const rootId = rootDirId ? rootDirId : this.defaultRootDirId;
        /** @type {?} */
        const formId = parentDirName ? parentDirName : this.defaultParentDirName;
        if (!rootId || !formId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        /** @type {?} */
        const fileInfos = this.getUploadFileInfosFromContext();
        /** @type {?} */
        const attachmentInfos = AttachmentUtil.convertToAttachmentInfos(fileInfos);
        if (!attachmentInfos || attachmentInfos.length === 0) {
            alert('请先上传附件');
            return EMPTY;
        }
        // 更新服务器端
        console.log('show loading ...');
        /** @type {?} */
        const firstAttachmentInfo = AttachmentUtil.getFirstAttachmentInfo(attachmentInfos);
        /** @type {?} */
        const result$ = this.attachDataService.updateRow(attachmentInfoFieldPath, firstAttachmentInfo).pipe(tap((/**
         * @return {?}
         */
        () => {
            console.log('hide loading ...');
        })));
        return result$;
    }
    /**
     * 上传多个文件
     * @param {?} attachmentInfoFieldPath
     * @param {?=} rootDirId
     * @param {?=} parentDirName
     * @return {?}
     */
    uploadAndBatchAddRows(attachmentInfoFieldPath, rootDirId, parentDirName) {
        /** @type {?} */
        const rootId = rootDirId ? rootDirId : this.defaultRootDirId;
        /** @type {?} */
        const formId = parentDirName ? parentDirName : this.defaultParentDirName;
        if (!rootId || !formId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        /** @type {?} */
        const fileInfos = this.getUploadFileInfosFromContext();
        /** @type {?} */
        const attachmentInfos = AttachmentUtil.convertToAttachmentInfos(fileInfos);
        if (!attachmentInfos || attachmentInfos.length === 0) {
            alert('请先上传附件');
            return EMPTY;
        }
        // 更新服务器端
        console.log('show loading ...');
        /** @type {?} */
        const result$ = this.attachDataService.updateRows(attachmentInfoFieldPath, attachmentInfos).pipe(tap((/**
         * @return {?}
         */
        () => {
            console.log('hide loading ...');
        })));
        return result$;
    }
    /**
     * 批量删除附件所在的行
     * @param {?} attachmentInfoFieldPath
     * @return {?}
     */
    removeAttachmentRows(attachmentInfoFieldPath) {
        if (!attachmentInfoFieldPath) {
            return EMPTY;
        }
        /** @type {?} */
        const dataIds = this.getDataIdsToRemove(attachmentInfoFieldPath);
        //如果是主表
        if (attachmentInfoFieldPath.split('/').length <= 2) {
            return this.removeDataService.removeByIds(dataIds);
        }
        // 如果是子表
        else {
            /** @type {?} */
            const removeObservables = [];
            if (dataIds.length === 0) {
                alert('请选择要删除的文件');
            }
            /** @type {?} */
            const bindingListPath = this.getBindingListPathWithAttachments(attachmentInfoFieldPath);
            dataIds.forEach((/**
             * @param {?} dataId
             * @return {?}
             */
            (dataId) => {
                /** @type {?} */
                const removeObservable = this.removeDataService.removeByPathAndId(bindingListPath, dataId);
                removeObservables.push(removeObservable);
            }));
            return forkJoin(removeObservables);
        }
    }
    // #region 工具方法
    /**
     * 从上下文中中获取控件传递的附件信息
     * @private
     * @return {?}
     */
    getUploadFileInfosFromContext() {
        /** @type {?} */
        const commandContext = (/** @type {?} */ (this['context']));
        /** @type {?} */
        const uploadFileInfos = (/** @type {?} */ (commandContext.eventParams));
        if (!uploadFileInfos) {
            return [];
        }
        return uploadFileInfos;
    }
    /**
     * 获取要删除的附件对应的数据id数组
     * @param {?} attachmentInfoFieldPath
     * @return {?}
     */
    getDataIdsToRemove(attachmentInfoFieldPath) {
        /** @type {?} */
        const attachIds = this.getAttachmentIdsToRemoveFromContext();
        /** @type {?} */
        const dataIds = [];
        attachIds.forEach((/**
         * @param {?} attachId
         * @return {?}
         */
        (attachId) => {
            // 上传删除和预览删除传递过来的fileId的key可能不一致，要做兼容
            /** @type {?} */
            const dataId = this.convertAttachmentIdToDataId(attachId, attachmentInfoFieldPath);
            dataIds.push(dataId);
        }));
        return dataIds;
    }
    /**
     * 从命令上下文中获取要删除附件ids
     * @return {?}
     */
    getAttachmentIdsToRemoveFromContext() {
        /** @type {?} */
        const commandContext = (/** @type {?} */ (this['context']));
        return (/** @type {?} */ (commandContext.eventParams));
    }
    /**
     * 根据路径获取附件字段值数组
     * @private
     * @param {?} fileId
     * @param {?} attachmentInfoFieldPath
     * @return {?}
     */
    convertAttachmentIdToDataId(fileId, attachmentInfoFieldPath) {
        // 解析路径
        /** @type {?} */
        const attachInfoBindingPath = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        /** @type {?} */
        const attachFieldName = attachInfoBindingPath.pop();
        /** @type {?} */
        const attachListBindingPath = attachInfoBindingPath;
        // 获取附件id数组
        /** @type {?} */
        const entityListData = this.entityService.getEntityListData(attachListBindingPath);
        /** @type {?} */
        const targetEntityData = entityListData.find((/**
         * @param {?} entityData
         * @return {?}
         */
        (entityData) => {
            if (entityData[attachFieldName]) {
                /** @type {?} */
                const attachmentId = entityData[attachFieldName]['attachmentId'];
                if (attachmentId === fileId) {
                    return true;
                }
            }
        }));
        return targetEntityData.id;
    }
    /**
     * 获取带附件的BindingList的Path
     * @private
     * @param {?} attachmentInfoFieldPath
     * @return {?}
     */
    getBindingListPathWithAttachments(attachmentInfoFieldPath) {
        /** @type {?} */
        const attachInfoBindingPath = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        attachInfoBindingPath.pop();
        /** @type {?} */
        const bindingListPath = attachInfoBindingPath;
        return '/' + bindingListPath.join('/');
    }
}
if (false) {
    /**
     * 默认根目录
     * @type {?}
     * @private
     */
    AttachmentService.prototype.defaultRootDirId;
    /**
     * 视图模型
     * @type {?}
     * @private
     */
    AttachmentService.prototype.viewModelContext;
    /**
     * 附件数据服务
     * @type {?}
     * @private
     */
    AttachmentService.prototype.attachDataService;
    /**
     * 实体服务
     * @type {?}
     * @private
     */
    AttachmentService.prototype.entityService;
    /**
     * 实体服务
     * @type {?}
     * @private
     */
    AttachmentService.prototype.removeDataService;
}
export { AttachmentService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0YWNobWVudC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9hdHRhY2htZW50LXNlcnZpY2VzL2F0dGFjaG1lbnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBYyxLQUFLLEVBQUUsUUFBUSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVyQyxPQUFPLEVBQW9DLG9CQUFvQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFL0YsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDOzs7O0FBU25ELE1BQU0saUJBQWlCOzs7Ozs7OztJQXFDckIsWUFDRSxnQkFBa0MsRUFBRSxhQUE0QixFQUNoRSxpQkFBb0MsRUFBRSxpQkFBd0M7Ozs7UUFsQ3hFLHFCQUFnQixHQUFHLGNBQWMsQ0FBQztRQXFDeEMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDO1FBQ3pDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxpQkFBaUIsQ0FBQztRQUMzQyxJQUFJLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQztRQUNuQyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsaUJBQWlCLENBQUM7SUFDN0MsQ0FBQzs7Ozs7O0lBcENELElBQVksb0JBQW9CO1FBQzlCLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO0lBQzFELENBQUM7Ozs7Ozs7O0lBeUNNLGtCQUFrQixDQUFDLHVCQUErQixFQUFFLFNBQWtCLEVBQUUsYUFBc0I7O2NBQzdGLE1BQU0sR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQjs7Y0FDdEQsTUFBTSxHQUFHLGFBQWEsQ0FB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LDJCQUEyQixDQUFDLE1BQWMsRUFBRSx1QkFBK0I7OztjQUczRSxxQkFBcUIsR0FBRyxvQkFBb0IsQ0FBQyxrQkFBa0IsQ0FBQyx1QkFBdUIsQ0FBQzs7Y0FDeEYsZUFBZSxHQUFHLHFCQUFxQixDQUFDLEdBQUcsRUFBRTs7Y0FDN0MscUJBQXFCLEdBQUcscUJBQXFCOzs7Y0FHN0MsY0FBYyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsaUJBQWlCLENBQUMscUJBQXFCLENBQUM7O2NBQzVFLGdCQUFnQixHQUFHLGNBQWMsQ0FBQyxJQUFJOzs7O1FBQUMsQ0FBQyxVQUFlLEVBQUUsRUFBRTtZQUMvRCxJQUFJLFVBQVUsQ0FBQyxlQUFlLENBQUMsRUFBRTs7c0JBQ3pCLFlBQVksR0FBRyxVQUFVLENBQUMsZUFBZSxDQUFDLENBQUMsY0FBYyxDQUFDO2dCQUNoRSxJQUFJLFlBQVksS0FBSyxNQUFNLEVBQUU7b0JBQzNCLE9BQU8sSUFBSSxDQUFDO2lCQUNiO2FBQ0Y7UUFDSCxDQUFDLEVBQUM7UUFFRixPQUFPLGdCQUFnQixDQUFDLEVBQUUsQ0FBQztJQUM3QixDQUFDOzs7Ozs7O0lBS08saUNBQWlDLENBQUMsdUJBQStCOztjQUNqRSxxQkFBcUIsR0FBRyxvQkFBb0IsQ0FBQyxrQkFBa0IsQ0FBQyx1QkFBdUIsQ0FBQztRQUM5RixxQkFBcUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQzs7Y0FDdEIsZUFBZSxHQUFHLHFCQUFxQjtRQUM3QyxPQUFPLEdBQUcsR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7Q0FJRjs7Ozs7OztJQXpNQyw2Q0FBMEM7Ozs7OztJQVkxQyw2Q0FBMkM7Ozs7OztJQUszQyw4Q0FBaUQ7Ozs7OztJQUtqRCwwQ0FBcUM7Ozs7OztJQUtyQyw4Q0FBNkM7O0FBZ0wvQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIEVNUFRZLCBmb3JrSm9pbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBWaWV3TW9kZWxDb250ZXh0LCBDb21tYW5kQ29udGV4dCwgQmluZGluZ1BhdGhDb252ZXJ0ZXIgfSBmcm9tICdAZmFycmlzL21vYmlsZS1kZXZraXQnO1xyXG5pbXBvcnQgeyBVcGxvYWRGaWxlSW5mbyB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBBdHRhY2htZW50VXRpbCB9IGZyb20gJy4vYXR0YWNobWVudC51dGlsJztcclxuaW1wb3J0IHsgQXR0YWNobWVudERhdGFTZXJ2aWNlIH0gZnJvbSAnLi9hdHRhY2htZW50LWRhdGEuc2VydmljZSc7XHJcbmltcG9ydCB7IEVudGl0eVNlcnZpY2UgfSBmcm9tICcuLi9lbnRpdHktc2VydmljZXMvaW5kZXgnO1xyXG5pbXBvcnQgeyBSZW1vdmVEYXRhU2VydmljZSB9IGZyb20gJy4uL2RhdGEtc2VydmljZXMvcmVtb3ZlLWRhdGEuc2VydmljZSc7XHJcblxyXG5cclxuLyoqXHJcbiAqIOmZhOS7tuacjeWKoVxyXG4gKi9cclxuY2xhc3MgQXR0YWNobWVudFNlcnZpY2Uge1xyXG5cclxuICAvKipcclxuICAgKiDpu5jorqTmoLnnm67lvZVcclxuICAgKi9cclxuICBwcml2YXRlIGRlZmF1bHRSb290RGlySWQgPSAnZGVmYXVsdC1yb290JztcclxuXHJcbiAgLyoqXHJcbiAgICog6buY6K6k5a2Q55uu5b2VXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXQgZGVmYXVsdFBhcmVudERpck5hbWUoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLnZpZXdNb2RlbENvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDop4blm77mqKHlnotcclxuICAgKi9cclxuICBwcml2YXRlIHZpZXdNb2RlbENvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQ7XHJcblxyXG4gIC8qKlxyXG4gICAqIOmZhOS7tuaVsOaNruacjeWKoVxyXG4gICAqL1xyXG4gIHByaXZhdGUgYXR0YWNoRGF0YVNlcnZpY2U6IEF0dGFjaG1lbnREYXRhU2VydmljZTtcclxuXHJcbiAgLyoqXHJcbiAgICog5a6e5L2T5pyN5YqhXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBlbnRpdHlTZXJ2aWNlOiBFbnRpdHlTZXJ2aWNlO1xyXG5cclxuICAvKipcclxuICAgKiDlrp7kvZPmnI3liqFcclxuICAgKi9cclxuICBwcml2YXRlIHJlbW92ZURhdGFTZXJ2aWNlOiBSZW1vdmVEYXRhU2VydmljZTtcclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICB2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0LCBlbnRpdHlTZXJ2aWNlOiBFbnRpdHlTZXJ2aWNlLFxyXG4gICAgcmVtb3ZlRGF0YVNlcnZpY2U6IFJlbW92ZURhdGFTZXJ2aWNlLCBhdHRhY2hEYXRhU2VydmljZTogQXR0YWNobWVudERhdGFTZXJ2aWNlXHJcbiAgKSB7XHJcblxyXG4gICAgdGhpcy52aWV3TW9kZWxDb250ZXh0ID0gdmlld01vZGVsQ29udGV4dDtcclxuICAgIHRoaXMuYXR0YWNoRGF0YVNlcnZpY2UgPSBhdHRhY2hEYXRhU2VydmljZTtcclxuICAgIHRoaXMuZW50aXR5U2VydmljZSA9IGVudGl0eVNlcnZpY2U7XHJcbiAgICB0aGlzLnJlbW92ZURhdGFTZXJ2aWNlID0gcmVtb3ZlRGF0YVNlcnZpY2U7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDkuIrkvKDljZXkuKrmlofku7ZcclxuICAgKiBAcGFyYW0gYXR0YWNobWVudElkUGF0aCDpmYTku7blhoXnoIHlrZfmrrXnmoTot6/lvoTvvIzlvaLlpoIvYXR0YWNoSW5mby9hdHRhY2htZW50SWTvvJtcclxuICAgKiBAcGFyYW0gYXR0YWNobWVudE5hbWVQYXRoIOmZhOS7tuWQjeensOWtl+auteeahOi3r+W+hFxyXG4gICAqL1xyXG4gIHB1YmxpYyB1cGxvYWRBbmRVcGRhdGVSb3coYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgcm9vdERpcklkPzogc3RyaW5nLCBwYXJlbnREaXJOYW1lPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHJvb3RJZCA9IHJvb3REaXJJZCA/IHJvb3REaXJJZCA6IHRoaXMuZGVmYXVsdFJvb3REaXJJZDtcclxuICAgIGNvbnN0IGZvcm1JZCA9IHBhcmVudERpck5hbWUgPyBwYXJlbnREaXJOYW1lIDogdGhpcy5kZWZhdWx0UGFyZW50RGlyTmFtZTtcclxuICAgIGlmICghcm9vdElkIHx8ICFmb3JtSWQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdyb290RGlySWTlkoxwYXJlbnREaXJOYW1l5LiN6IO95Li656m677yM6K+35aGr5YaZJyk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZmlsZUluZm9zID0gdGhpcy5nZXRVcGxvYWRGaWxlSW5mb3NGcm9tQ29udGV4dCgpO1xyXG4gICAgY29uc3QgYXR0YWNobWVudEluZm9zID0gQXR0YWNobWVudFV0aWwuY29udmVydFRvQXR0YWNobWVudEluZm9zKGZpbGVJbmZvcyk7XHJcbiAgICBpZiAoIWF0dGFjaG1lbnRJbmZvcyB8fCBhdHRhY2htZW50SW5mb3MubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIGFsZXJ0KCfor7flhYjkuIrkvKDpmYTku7YnKTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOabtOaWsOacjeWKoeWZqOerr1xyXG4gICAgY29uc29sZS5sb2coJ3Nob3cgbG9hZGluZyAuLi4nKTtcclxuICAgIGNvbnN0IGZpcnN0QXR0YWNobWVudEluZm8gPSBBdHRhY2htZW50VXRpbC5nZXRGaXJzdEF0dGFjaG1lbnRJbmZvKGF0dGFjaG1lbnRJbmZvcyk7XHJcbiAgICBjb25zdCByZXN1bHQkID0gdGhpcy5hdHRhY2hEYXRhU2VydmljZS51cGRhdGVSb3coYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGZpcnN0QXR0YWNobWVudEluZm8pLnBpcGUoXHJcbiAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ2hpZGUgbG9hZGluZyAuLi4nKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgICByZXR1cm4gcmVzdWx0JDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOS4iuS8oOWkmuS4quaWh+S7tlxyXG4gICAqL1xyXG4gIHB1YmxpYyB1cGxvYWRBbmRCYXRjaEFkZFJvd3MoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgcm9vdERpcklkPzogc3RyaW5nLCBwYXJlbnREaXJOYW1lPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHJvb3RJZCA9IHJvb3REaXJJZCA/IHJvb3REaXJJZCA6IHRoaXMuZGVmYXVsdFJvb3REaXJJZDtcclxuICAgIGNvbnN0IGZvcm1JZCA9IHBhcmVudERpck5hbWUgPyBwYXJlbnREaXJOYW1lIDogdGhpcy5kZWZhdWx0UGFyZW50RGlyTmFtZTtcclxuICAgIGlmICghcm9vdElkIHx8ICFmb3JtSWQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdyb290RGlySWTlkoxwYXJlbnREaXJOYW1l5LiN6IO95Li656m677yM6K+35aGr5YaZJyk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZmlsZUluZm9zID0gdGhpcy5nZXRVcGxvYWRGaWxlSW5mb3NGcm9tQ29udGV4dCgpO1xyXG4gICAgY29uc3QgYXR0YWNobWVudEluZm9zID0gQXR0YWNobWVudFV0aWwuY29udmVydFRvQXR0YWNobWVudEluZm9zKGZpbGVJbmZvcyk7XHJcbiAgICBpZiAoIWF0dGFjaG1lbnRJbmZvcyB8fCBhdHRhY2htZW50SW5mb3MubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIGFsZXJ0KCfor7flhYjkuIrkvKDpmYTku7YnKTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOabtOaWsOacjeWKoeWZqOerr1xyXG4gICAgY29uc29sZS5sb2coJ3Nob3cgbG9hZGluZyAuLi4nKTtcclxuICAgIGNvbnN0IHJlc3VsdCQgPSB0aGlzLmF0dGFjaERhdGFTZXJ2aWNlLnVwZGF0ZVJvd3MoYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGF0dGFjaG1lbnRJbmZvcykucGlwZShcclxuICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZygnaGlkZSBsb2FkaW5nIC4uLicpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICByZXR1cm4gcmVzdWx0JDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJuemHj+WIoOmZpOmZhOS7tuaJgOWcqOeahOihjFxyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmVBdHRhY2htZW50Um93cyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmICghYXR0YWNobWVudEluZm9GaWVsZFBhdGgpIHtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZGF0YUlkcyA9IHRoaXMuZ2V0RGF0YUlkc1RvUmVtb3ZlKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcclxuICAgIC8v5aaC5p6c5piv5Li76KGoXHJcbiAgICBpZiAoYXR0YWNobWVudEluZm9GaWVsZFBhdGguc3BsaXQoJy8nKS5sZW5ndGggPD0gMikge1xyXG4gICAgICByZXR1cm4gdGhpcy5yZW1vdmVEYXRhU2VydmljZS5yZW1vdmVCeUlkcyhkYXRhSWRzKTtcclxuICAgIH1cclxuICAgIC8vIOWmguaenOaYr+WtkOihqFxyXG4gICAgZWxzZSB7XHJcbiAgICAgIGNvbnN0IHJlbW92ZU9ic2VydmFibGVzOiBPYnNlcnZhYmxlPGFueT5bXSA9IFtdO1xyXG4gICAgICBpZiAoZGF0YUlkcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICBhbGVydCgn6K+36YCJ5oup6KaB5Yig6Zmk55qE5paH5Lu2Jyk7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgYmluZGluZ0xpc3RQYXRoID0gdGhpcy5nZXRCaW5kaW5nTGlzdFBhdGhXaXRoQXR0YWNobWVudHMoYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xyXG4gICAgICBkYXRhSWRzLmZvckVhY2goKGRhdGFJZDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgY29uc3QgcmVtb3ZlT2JzZXJ2YWJsZSA9IHRoaXMucmVtb3ZlRGF0YVNlcnZpY2UucmVtb3ZlQnlQYXRoQW5kSWQoYmluZGluZ0xpc3RQYXRoLCBkYXRhSWQpO1xyXG4gICAgICAgIHJlbW92ZU9ic2VydmFibGVzLnB1c2gocmVtb3ZlT2JzZXJ2YWJsZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gZm9ya0pvaW4ocmVtb3ZlT2JzZXJ2YWJsZXMpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gI3JlZ2lvbiDlt6Xlhbfmlrnms5VcclxuICAvKipcclxuICAgKiDku47kuIrkuIvmlofkuK3kuK3ojrflj5bmjqfku7bkvKDpgJLnmoTpmYTku7bkv6Hmga9cclxuICAgKi9cclxuICBwcml2YXRlIGdldFVwbG9hZEZpbGVJbmZvc0Zyb21Db250ZXh0KCk6IFVwbG9hZEZpbGVJbmZvW10ge1xyXG4gICAgY29uc3QgY29tbWFuZENvbnRleHQgPSB0aGlzWydjb250ZXh0J10gYXMgQ29tbWFuZENvbnRleHQ7XHJcbiAgICBjb25zdCB1cGxvYWRGaWxlSW5mb3MgPSBjb21tYW5kQ29udGV4dC5ldmVudFBhcmFtcyBhcyBVcGxvYWRGaWxlSW5mb1tdO1xyXG4gICAgaWYgKCF1cGxvYWRGaWxlSW5mb3MpIHtcclxuICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHVwbG9hZEZpbGVJbmZvcztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluimgeWIoOmZpOeahOmZhOS7tuWvueW6lOeahOaVsOaNrmlk5pWw57uEXHJcbiAgICovXHJcbiAgcHVibGljIGdldERhdGFJZHNUb1JlbW92ZShhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBhdHRhY2hJZHMgPSB0aGlzLmdldEF0dGFjaG1lbnRJZHNUb1JlbW92ZUZyb21Db250ZXh0KCk7XHJcbiAgICBjb25zdCBkYXRhSWRzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgYXR0YWNoSWRzLmZvckVhY2goKGF0dGFjaElkOiBzdHJpbmcpID0+IHtcclxuXHJcbiAgICAgIC8vIOS4iuS8oOWIoOmZpOWSjOmihOiniOWIoOmZpOS8oOmAkui/h+adpeeahGZpbGVJZOeahGtleeWPr+iDveS4jeS4gOiHtO+8jOimgeWBmuWFvOWuuVxyXG4gICAgICBjb25zdCBkYXRhSWQgPSB0aGlzLmNvbnZlcnRBdHRhY2htZW50SWRUb0RhdGFJZChhdHRhY2hJZCwgYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xyXG4gICAgICBkYXRhSWRzLnB1c2goZGF0YUlkKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGRhdGFJZHM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDku47lkb3ku6TkuIrkuIvmlofkuK3ojrflj5bopoHliKDpmaTpmYTku7ZpZHNcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0QXR0YWNobWVudElkc1RvUmVtb3ZlRnJvbUNvbnRleHQoKSB7XHJcbiAgICBjb25zdCBjb21tYW5kQ29udGV4dCA9IHRoaXNbJ2NvbnRleHQnXSBhcyBDb21tYW5kQ29udGV4dDtcclxuICAgIHJldHVybiBjb21tYW5kQ29udGV4dC5ldmVudFBhcmFtcyBhcyBzdHJpbmdbXTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOagueaNrui3r+W+hOiOt+WPlumZhOS7tuWtl+auteWAvOaVsOe7hFxyXG4gICAqIEBwYXJhbSBmaWVsZFBhdGgg5a2X5q616Lev5b6EXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjb252ZXJ0QXR0YWNobWVudElkVG9EYXRhSWQoZmlsZUlkOiBzdHJpbmcsIGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xyXG5cclxuICAgIC8vIOino+aekOi3r+W+hFxyXG4gICAgY29uc3QgYXR0YWNoSW5mb0JpbmRpbmdQYXRoID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcclxuICAgIGNvbnN0IGF0dGFjaEZpZWxkTmFtZSA9IGF0dGFjaEluZm9CaW5kaW5nUGF0aC5wb3AoKTtcclxuICAgIGNvbnN0IGF0dGFjaExpc3RCaW5kaW5nUGF0aCA9IGF0dGFjaEluZm9CaW5kaW5nUGF0aDtcclxuXHJcbiAgICAvLyDojrflj5bpmYTku7ZpZOaVsOe7hFxyXG4gICAgY29uc3QgZW50aXR5TGlzdERhdGEgPSB0aGlzLmVudGl0eVNlcnZpY2UuZ2V0RW50aXR5TGlzdERhdGEoYXR0YWNoTGlzdEJpbmRpbmdQYXRoKTtcclxuICAgIGNvbnN0IHRhcmdldEVudGl0eURhdGEgPSBlbnRpdHlMaXN0RGF0YS5maW5kKChlbnRpdHlEYXRhOiBhbnkpID0+IHtcclxuICAgICAgaWYgKGVudGl0eURhdGFbYXR0YWNoRmllbGROYW1lXSkge1xyXG4gICAgICAgIGNvbnN0IGF0dGFjaG1lbnRJZCA9IGVudGl0eURhdGFbYXR0YWNoRmllbGROYW1lXVsnYXR0YWNobWVudElkJ107XHJcbiAgICAgICAgaWYgKGF0dGFjaG1lbnRJZCA9PT0gZmlsZUlkKSB7XHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiB0YXJnZXRFbnRpdHlEYXRhLmlkO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5bim6ZmE5Lu255qEQmluZGluZ0xpc3TnmoRQYXRoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRCaW5kaW5nTGlzdFBhdGhXaXRoQXR0YWNobWVudHMoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZykge1xyXG4gICAgY29uc3QgYXR0YWNoSW5mb0JpbmRpbmdQYXRoID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcclxuICAgIGF0dGFjaEluZm9CaW5kaW5nUGF0aC5wb3AoKTtcclxuICAgIGNvbnN0IGJpbmRpbmdMaXN0UGF0aCA9IGF0dGFjaEluZm9CaW5kaW5nUGF0aDtcclxuICAgIHJldHVybiAnLycgKyBiaW5kaW5nTGlzdFBhdGguam9pbignLycpO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxufVxyXG5cclxuZXhwb3J0IHsgQXR0YWNobWVudFNlcnZpY2UgfTtcclxuIl19