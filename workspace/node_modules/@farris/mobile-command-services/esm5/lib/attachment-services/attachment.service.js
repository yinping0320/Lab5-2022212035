/**
 * @fileoverview added by tsickle
 * Generated from: lib/attachment-services/attachment.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { EMPTY, forkJoin } from 'rxjs';
import { tap } from 'rxjs/operators';
import { BindingPathConverter } from '@farris/mobile-devkit';
import { AttachmentUtil } from './attachment.util';
/**
 * 附件服务
 */
var /**
 * 附件服务
 */
AttachmentService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function AttachmentService(viewModelContext, entityService, removeDataService, attachDataService) {
        /**
         * 默认根目录
         */
        this.defaultRootDirId = 'default-root';
        this.viewModelContext = viewModelContext;
        this.attachDataService = attachDataService;
        this.entityService = entityService;
        this.removeDataService = removeDataService;
    }
    Object.defineProperty(AttachmentService.prototype, "defaultParentDirName", {
        /**
         * 默认子目录
         */
        get: /**
         * 默认子目录
         * @private
         * @return {?}
         */
        function () {
            return this.viewModelContext.bindingData.list.currentId;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 上传单个文件
     * @param attachmentIdPath 附件内码字段的路径，形如/attachInfo/attachmentId；
     * @param attachmentNamePath 附件名称字段的路径
     */
    /**
     * 上传单个文件
     * @param {?} attachmentInfoFieldPath
     * @param {?=} rootDirId
     * @param {?=} parentDirName
     * @return {?}
     */
    AttachmentService.prototype.uploadAndUpdateRow = /**
     * 上传单个文件
     * @param {?} attachmentInfoFieldPath
     * @param {?=} rootDirId
     * @param {?=} parentDirName
     * @return {?}
     */
    function (attachmentInfoFieldPath, rootDirId, parentDirName) {
        /** @type {?} */
        var rootId = rootDirId ? rootDirId : this.defaultRootDirId;
        /** @type {?} */
        var formId = parentDirName ? parentDirName : this.defaultParentDirName;
        if (!rootId || !formId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        /** @type {?} */
        var fileInfos = this.getUploadFileInfosFromContext();
        /** @type {?} */
        var attachmentInfos = AttachmentUtil.convertToAttachmentInfos(fileInfos);
        if (!attachmentInfos || attachmentInfos.length === 0) {
            alert('请先上传附件');
            return EMPTY;
        }
        // 更新服务器端
        console.log('show loading ...');
        /** @type {?} */
        var firstAttachmentInfo = AttachmentUtil.getFirstAttachmentInfo(attachmentInfos);
        /** @type {?} */
        var result$ = this.attachDataService.updateRow(attachmentInfoFieldPath, firstAttachmentInfo).pipe(tap((/**
         * @return {?}
         */
        function () {
            console.log('hide loading ...');
        })));
        return result$;
    };
    /**
     * 上传多个文件
     */
    /**
     * 上传多个文件
     * @param {?} attachmentInfoFieldPath
     * @param {?=} rootDirId
     * @param {?=} parentDirName
     * @return {?}
     */
    AttachmentService.prototype.uploadAndBatchAddRows = /**
     * 上传多个文件
     * @param {?} attachmentInfoFieldPath
     * @param {?=} rootDirId
     * @param {?=} parentDirName
     * @return {?}
     */
    function (attachmentInfoFieldPath, rootDirId, parentDirName) {
        /** @type {?} */
        var rootId = rootDirId ? rootDirId : this.defaultRootDirId;
        /** @type {?} */
        var formId = parentDirName ? parentDirName : this.defaultParentDirName;
        if (!rootId || !formId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        /** @type {?} */
        var fileInfos = this.getUploadFileInfosFromContext();
        /** @type {?} */
        var attachmentInfos = AttachmentUtil.convertToAttachmentInfos(fileInfos);
        if (!attachmentInfos || attachmentInfos.length === 0) {
            alert('请先上传附件');
            return EMPTY;
        }
        // 更新服务器端
        console.log('show loading ...');
        /** @type {?} */
        var result$ = this.attachDataService.updateRows(attachmentInfoFieldPath, attachmentInfos).pipe(tap((/**
         * @return {?}
         */
        function () {
            console.log('hide loading ...');
        })));
        return result$;
    };
    /**
     * 批量删除附件所在的行
     */
    /**
     * 批量删除附件所在的行
     * @param {?} attachmentInfoFieldPath
     * @return {?}
     */
    AttachmentService.prototype.removeAttachmentRows = /**
     * 批量删除附件所在的行
     * @param {?} attachmentInfoFieldPath
     * @return {?}
     */
    function (attachmentInfoFieldPath) {
        var _this = this;
        if (!attachmentInfoFieldPath) {
            return EMPTY;
        }
        /** @type {?} */
        var dataIds = this.getDataIdsToRemove(attachmentInfoFieldPath);
        //如果是主表
        if (attachmentInfoFieldPath.split('/').length <= 2) {
            return this.removeDataService.removeByIds(dataIds);
        }
        // 如果是子表
        else {
            /** @type {?} */
            var removeObservables_1 = [];
            if (dataIds.length === 0) {
                alert('请选择要删除的文件');
            }
            /** @type {?} */
            var bindingListPath_1 = this.getBindingListPathWithAttachments(attachmentInfoFieldPath);
            dataIds.forEach((/**
             * @param {?} dataId
             * @return {?}
             */
            function (dataId) {
                /** @type {?} */
                var removeObservable = _this.removeDataService.removeByPathAndId(bindingListPath_1, dataId);
                removeObservables_1.push(removeObservable);
            }));
            return forkJoin(removeObservables_1);
        }
    };
    // #region 工具方法
    /**
     * 从上下文中中获取控件传递的附件信息
     */
    // #region 工具方法
    /**
     * 从上下文中中获取控件传递的附件信息
     * @private
     * @return {?}
     */
    AttachmentService.prototype.getUploadFileInfosFromContext = 
    // #region 工具方法
    /**
     * 从上下文中中获取控件传递的附件信息
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var commandContext = (/** @type {?} */ (this['context']));
        /** @type {?} */
        var uploadFileInfos = (/** @type {?} */ (commandContext.eventParams));
        if (!uploadFileInfos) {
            return [];
        }
        return uploadFileInfos;
    };
    /**
     * 获取要删除的附件对应的数据id数组
     */
    /**
     * 获取要删除的附件对应的数据id数组
     * @param {?} attachmentInfoFieldPath
     * @return {?}
     */
    AttachmentService.prototype.getDataIdsToRemove = /**
     * 获取要删除的附件对应的数据id数组
     * @param {?} attachmentInfoFieldPath
     * @return {?}
     */
    function (attachmentInfoFieldPath) {
        var _this = this;
        /** @type {?} */
        var attachIds = this.getAttachmentIdsToRemoveFromContext();
        /** @type {?} */
        var dataIds = [];
        attachIds.forEach((/**
         * @param {?} attachId
         * @return {?}
         */
        function (attachId) {
            // 上传删除和预览删除传递过来的fileId的key可能不一致，要做兼容
            /** @type {?} */
            var dataId = _this.convertAttachmentIdToDataId(attachId, attachmentInfoFieldPath);
            dataIds.push(dataId);
        }));
        return dataIds;
    };
    /**
     * 从命令上下文中获取要删除附件ids
     */
    /**
     * 从命令上下文中获取要删除附件ids
     * @return {?}
     */
    AttachmentService.prototype.getAttachmentIdsToRemoveFromContext = /**
     * 从命令上下文中获取要删除附件ids
     * @return {?}
     */
    function () {
        /** @type {?} */
        var commandContext = (/** @type {?} */ (this['context']));
        return (/** @type {?} */ (commandContext.eventParams));
    };
    /**
     * 根据路径获取附件字段值数组
     * @param fieldPath 字段路径
     */
    /**
     * 根据路径获取附件字段值数组
     * @private
     * @param {?} fileId
     * @param {?} attachmentInfoFieldPath
     * @return {?}
     */
    AttachmentService.prototype.convertAttachmentIdToDataId = /**
     * 根据路径获取附件字段值数组
     * @private
     * @param {?} fileId
     * @param {?} attachmentInfoFieldPath
     * @return {?}
     */
    function (fileId, attachmentInfoFieldPath) {
        // 解析路径
        /** @type {?} */
        var attachInfoBindingPath = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        /** @type {?} */
        var attachFieldName = attachInfoBindingPath.pop();
        /** @type {?} */
        var attachListBindingPath = attachInfoBindingPath;
        // 获取附件id数组
        /** @type {?} */
        var entityListData = this.entityService.getEntityListData(attachListBindingPath);
        /** @type {?} */
        var targetEntityData = entityListData.find((/**
         * @param {?} entityData
         * @return {?}
         */
        function (entityData) {
            if (entityData[attachFieldName]) {
                /** @type {?} */
                var attachmentId = entityData[attachFieldName]['attachmentId'];
                if (attachmentId === fileId) {
                    return true;
                }
            }
        }));
        return targetEntityData.id;
    };
    /**
     * 获取带附件的BindingList的Path
     */
    /**
     * 获取带附件的BindingList的Path
     * @private
     * @param {?} attachmentInfoFieldPath
     * @return {?}
     */
    AttachmentService.prototype.getBindingListPathWithAttachments = /**
     * 获取带附件的BindingList的Path
     * @private
     * @param {?} attachmentInfoFieldPath
     * @return {?}
     */
    function (attachmentInfoFieldPath) {
        /** @type {?} */
        var attachInfoBindingPath = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        attachInfoBindingPath.pop();
        /** @type {?} */
        var bindingListPath = attachInfoBindingPath;
        return '/' + bindingListPath.join('/');
    };
    return AttachmentService;
}());
if (false) {
    /**
     * 默认根目录
     * @type {?}
     * @private
     */
    AttachmentService.prototype.defaultRootDirId;
    /**
     * 视图模型
     * @type {?}
     * @private
     */
    AttachmentService.prototype.viewModelContext;
    /**
     * 附件数据服务
     * @type {?}
     * @private
     */
    AttachmentService.prototype.attachDataService;
    /**
     * 实体服务
     * @type {?}
     * @private
     */
    AttachmentService.prototype.entityService;
    /**
     * 实体服务
     * @type {?}
     * @private
     */
    AttachmentService.prototype.removeDataService;
}
export { AttachmentService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0YWNobWVudC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9hdHRhY2htZW50LXNlcnZpY2VzL2F0dGFjaG1lbnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBYyxLQUFLLEVBQUUsUUFBUSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVyQyxPQUFPLEVBQW9DLG9CQUFvQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFL0YsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDOzs7O0FBU25EOzs7O0lBa0NFOztPQUVHO0lBQ0gsMkJBQ0UsZ0JBQWtDLEVBQUUsYUFBNEIsRUFDaEUsaUJBQW9DLEVBQUUsaUJBQXdDOzs7O1FBbEN4RSxxQkFBZ0IsR0FBRyxjQUFjLENBQUM7UUFxQ3hDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztRQUN6QyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsaUJBQWlCLENBQUM7UUFDM0MsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7UUFDbkMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLGlCQUFpQixDQUFDO0lBQzdDLENBQUM7SUFwQ0Qsc0JBQVksbURBQW9CO1FBSGhDOztXQUVHOzs7Ozs7UUFDSDtZQUNFLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQzFELENBQUM7OztPQUFBO0lBb0NEOzs7O09BSUc7Ozs7Ozs7O0lBQ0ksOENBQWtCOzs7Ozs7O0lBQXpCLFVBQTBCLHVCQUErQixFQUFFLFNBQWtCLEVBQUUsYUFBc0I7O1lBQzdGLE1BQU0sR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENB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Q0FBQyxBQTlNRCxJQThNQzs7Ozs7OztJQXpNQyw2Q0FBMEM7Ozs7OztJQVkxQyw2Q0FBMkM7Ozs7OztJQUszQyw4Q0FBaUQ7Ozs7OztJQUtqRCwwQ0FBcUM7Ozs7OztJQUtyQyw4Q0FBNkM7O0FBZ0wvQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIEVNUFRZLCBmb3JrSm9pbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBWaWV3TW9kZWxDb250ZXh0LCBDb21tYW5kQ29udGV4dCwgQmluZGluZ1BhdGhDb252ZXJ0ZXIgfSBmcm9tICdAZmFycmlzL21vYmlsZS1kZXZraXQnO1xyXG5pbXBvcnQgeyBVcGxvYWRGaWxlSW5mbyB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBBdHRhY2htZW50VXRpbCB9IGZyb20gJy4vYXR0YWNobWVudC51dGlsJztcclxuaW1wb3J0IHsgQXR0YWNobWVudERhdGFTZXJ2aWNlIH0gZnJvbSAnLi9hdHRhY2htZW50LWRhdGEuc2VydmljZSc7XHJcbmltcG9ydCB7IEVudGl0eVNlcnZpY2UgfSBmcm9tICcuLi9lbnRpdHktc2VydmljZXMvaW5kZXgnO1xyXG5pbXBvcnQgeyBSZW1vdmVEYXRhU2VydmljZSB9IGZyb20gJy4uL2RhdGEtc2VydmljZXMvcmVtb3ZlLWRhdGEuc2VydmljZSc7XHJcblxyXG5cclxuLyoqXHJcbiAqIOmZhOS7tuacjeWKoVxyXG4gKi9cclxuY2xhc3MgQXR0YWNobWVudFNlcnZpY2Uge1xyXG5cclxuICAvKipcclxuICAgKiDpu5jorqTmoLnnm67lvZVcclxuICAgKi9cclxuICBwcml2YXRlIGRlZmF1bHRSb290RGlySWQgPSAnZGVmYXVsdC1yb290JztcclxuXHJcbiAgLyoqXHJcbiAgICog6buY6K6k5a2Q55uu5b2VXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXQgZGVmYXVsdFBhcmVudERpck5hbWUoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLnZpZXdNb2RlbENvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDop4blm77mqKHlnotcclxuICAgKi9cclxuICBwcml2YXRlIHZpZXdNb2RlbENvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQ7XHJcblxyXG4gIC8qKlxyXG4gICAqIOmZhOS7tuaVsOaNruacjeWKoVxyXG4gICAqL1xyXG4gIHByaXZhdGUgYXR0YWNoRGF0YVNlcnZpY2U6IEF0dGFjaG1lbnREYXRhU2VydmljZTtcclxuXHJcbiAgLyoqXHJcbiAgICog5a6e5L2T5pyN5YqhXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBlbnRpdHlTZXJ2aWNlOiBFbnRpdHlTZXJ2aWNlO1xyXG5cclxuICAvKipcclxuICAgKiDlrp7kvZPmnI3liqFcclxuICAgKi9cclxuICBwcml2YXRlIHJlbW92ZURhdGFTZXJ2aWNlOiBSZW1vdmVEYXRhU2VydmljZTtcclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICB2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0LCBlbnRpdHlTZXJ2aWNlOiBFbnRpdHlTZXJ2aWNlLFxyXG4gICAgcmVtb3ZlRGF0YVNlcnZpY2U6IFJlbW92ZURhdGFTZXJ2aWNlLCBhdHRhY2hEYXRhU2VydmljZTogQXR0YWNobWVudERhdGFTZXJ2aWNlXHJcbiAgKSB7XHJcblxyXG4gICAgdGhpcy52aWV3TW9kZWxDb250ZXh0ID0gdmlld01vZGVsQ29udGV4dDtcclxuICAgIHRoaXMuYXR0YWNoRGF0YVNlcnZpY2UgPSBhdHRhY2hEYXRhU2VydmljZTtcclxuICAgIHRoaXMuZW50aXR5U2VydmljZSA9IGVudGl0eVNlcnZpY2U7XHJcbiAgICB0aGlzLnJlbW92ZURhdGFTZXJ2aWNlID0gcmVtb3ZlRGF0YVNlcnZpY2U7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDkuIrkvKDljZXkuKrmlofku7ZcclxuICAgKiBAcGFyYW0gYXR0YWNobWVudElkUGF0aCDpmYTku7blhoXnoIHlrZfmrrXnmoTot6/lvoTvvIzlvaLlpoIvYXR0YWNoSW5mby9hdHRhY2htZW50SWTvvJtcclxuICAgKiBAcGFyYW0gYXR0YWNobWVudE5hbWVQYXRoIOmZhOS7tuWQjeensOWtl+auteeahOi3r+W+hFxyXG4gICAqL1xyXG4gIHB1YmxpYyB1cGxvYWRBbmRVcGRhdGVSb3coYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgcm9vdERpcklkPzogc3RyaW5nLCBwYXJlbnREaXJOYW1lPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHJvb3RJZCA9IHJvb3REaXJJZCA/IHJvb3REaXJJZCA6IHRoaXMuZGVmYXVsdFJvb3REaXJJZDtcclxuICAgIGNvbnN0IGZvcm1JZCA9IHBhcmVudERpck5hbWUgPyBwYXJlbnREaXJOYW1lIDogdGhpcy5kZWZhdWx0UGFyZW50RGlyTmFtZTtcclxuICAgIGlmICghcm9vdElkIHx8ICFmb3JtSWQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdyb290RGlySWTlkoxwYXJlbnREaXJOYW1l5LiN6IO95Li656m677yM6K+35aGr5YaZJyk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZmlsZUluZm9zID0gdGhpcy5nZXRVcGxvYWRGaWxlSW5mb3NGcm9tQ29udGV4dCgpO1xyXG4gICAgY29uc3QgYXR0YWNobWVudEluZm9zID0gQXR0YWNobWVudFV0aWwuY29udmVydFRvQXR0YWNobWVudEluZm9zKGZpbGVJbmZvcyk7XHJcbiAgICBpZiAoIWF0dGFjaG1lbnRJbmZvcyB8fCBhdHRhY2htZW50SW5mb3MubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIGFsZXJ0KCfor7flhYjkuIrkvKDpmYTku7YnKTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOabtOaWsOacjeWKoeWZqOerr1xyXG4gICAgY29uc29sZS5sb2coJ3Nob3cgbG9hZGluZyAuLi4nKTtcclxuICAgIGNvbnN0IGZpcnN0QXR0YWNobWVudEluZm8gPSBBdHRhY2htZW50VXRpbC5nZXRGaXJzdEF0dGFjaG1lbnRJbmZvKGF0dGFjaG1lbnRJbmZvcyk7XHJcbiAgICBjb25zdCByZXN1bHQkID0gdGhpcy5hdHRhY2hEYXRhU2VydmljZS51cGRhdGVSb3coYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGZpcnN0QXR0YWNobWVudEluZm8pLnBpcGUoXHJcbiAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ2hpZGUgbG9hZGluZyAuLi4nKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgICByZXR1cm4gcmVzdWx0JDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOS4iuS8oOWkmuS4quaWh+S7tlxyXG4gICAqL1xyXG4gIHB1YmxpYyB1cGxvYWRBbmRCYXRjaEFkZFJvd3MoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgcm9vdERpcklkPzogc3RyaW5nLCBwYXJlbnREaXJOYW1lPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHJvb3RJZCA9IHJvb3REaXJJZCA/IHJvb3REaXJJZCA6IHRoaXMuZGVmYXVsdFJvb3REaXJJZDtcclxuICAgIGNvbnN0IGZvcm1JZCA9IHBhcmVudERpck5hbWUgPyBwYXJlbnREaXJOYW1lIDogdGhpcy5kZWZhdWx0UGFyZW50RGlyTmFtZTtcclxuICAgIGlmICghcm9vdElkIHx8ICFmb3JtSWQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdyb290RGlySWTlkoxwYXJlbnREaXJOYW1l5LiN6IO95Li656m677yM6K+35aGr5YaZJyk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZmlsZUluZm9zID0gdGhpcy5nZXRVcGxvYWRGaWxlSW5mb3NGcm9tQ29udGV4dCgpO1xyXG4gICAgY29uc3QgYXR0YWNobWVudEluZm9zID0gQXR0YWNobWVudFV0aWwuY29udmVydFRvQXR0YWNobWVudEluZm9zKGZpbGVJbmZvcyk7XHJcbiAgICBpZiAoIWF0dGFjaG1lbnRJbmZvcyB8fCBhdHRhY2htZW50SW5mb3MubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIGFsZXJ0KCfor7flhYjkuIrkvKDpmYTku7YnKTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOabtOaWsOacjeWKoeWZqOerr1xyXG4gICAgY29uc29sZS5sb2coJ3Nob3cgbG9hZGluZyAuLi4nKTtcclxuICAgIGNvbnN0IHJlc3VsdCQgPSB0aGlzLmF0dGFjaERhdGFTZXJ2aWNlLnVwZGF0ZVJvd3MoYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGF0dGFjaG1lbnRJbmZvcykucGlwZShcclxuICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZygnaGlkZSBsb2FkaW5nIC4uLicpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICByZXR1cm4gcmVzdWx0JDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJuemHj+WIoOmZpOmZhOS7tuaJgOWcqOeahOihjFxyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmVBdHRhY2htZW50Um93cyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmICghYXR0YWNobWVudEluZm9GaWVsZFBhdGgpIHtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZGF0YUlkcyA9IHRoaXMuZ2V0RGF0YUlkc1RvUmVtb3ZlKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcclxuICAgIC8v5aaC5p6c5piv5Li76KGoXHJcbiAgICBpZiAoYXR0YWNobWVudEluZm9GaWVsZFBhdGguc3BsaXQoJy8nKS5sZW5ndGggPD0gMikge1xyXG4gICAgICByZXR1cm4gdGhpcy5yZW1vdmVEYXRhU2VydmljZS5yZW1vdmVCeUlkcyhkYXRhSWRzKTtcclxuICAgIH1cclxuICAgIC8vIOWmguaenOaYr+WtkOihqFxyXG4gICAgZWxzZSB7XHJcbiAgICAgIGNvbnN0IHJlbW92ZU9ic2VydmFibGVzOiBPYnNlcnZhYmxlPGFueT5bXSA9IFtdO1xyXG4gICAgICBpZiAoZGF0YUlkcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICBhbGVydCgn6K+36YCJ5oup6KaB5Yig6Zmk55qE5paH5Lu2Jyk7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgYmluZGluZ0xpc3RQYXRoID0gdGhpcy5nZXRCaW5kaW5nTGlzdFBhdGhXaXRoQXR0YWNobWVudHMoYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xyXG4gICAgICBkYXRhSWRzLmZvckVhY2goKGRhdGFJZDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgY29uc3QgcmVtb3ZlT2JzZXJ2YWJsZSA9IHRoaXMucmVtb3ZlRGF0YVNlcnZpY2UucmVtb3ZlQnlQYXRoQW5kSWQoYmluZGluZ0xpc3RQYXRoLCBkYXRhSWQpO1xyXG4gICAgICAgIHJlbW92ZU9ic2VydmFibGVzLnB1c2gocmVtb3ZlT2JzZXJ2YWJsZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gZm9ya0pvaW4ocmVtb3ZlT2JzZXJ2YWJsZXMpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gI3JlZ2lvbiDlt6Xlhbfmlrnms5VcclxuICAvKipcclxuICAgKiDku47kuIrkuIvmlofkuK3kuK3ojrflj5bmjqfku7bkvKDpgJLnmoTpmYTku7bkv6Hmga9cclxuICAgKi9cclxuICBwcml2YXRlIGdldFVwbG9hZEZpbGVJbmZvc0Zyb21Db250ZXh0KCk6IFVwbG9hZEZpbGVJbmZvW10ge1xyXG4gICAgY29uc3QgY29tbWFuZENvbnRleHQgPSB0aGlzWydjb250ZXh0J10gYXMgQ29tbWFuZENvbnRleHQ7XHJcbiAgICBjb25zdCB1cGxvYWRGaWxlSW5mb3MgPSBjb21tYW5kQ29udGV4dC5ldmVudFBhcmFtcyBhcyBVcGxvYWRGaWxlSW5mb1tdO1xyXG4gICAgaWYgKCF1cGxvYWRGaWxlSW5mb3MpIHtcclxuICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHVwbG9hZEZpbGVJbmZvcztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluimgeWIoOmZpOeahOmZhOS7tuWvueW6lOeahOaVsOaNrmlk5pWw57uEXHJcbiAgICovXHJcbiAgcHVibGljIGdldERhdGFJZHNUb1JlbW92ZShhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBhdHRhY2hJZHMgPSB0aGlzLmdldEF0dGFjaG1lbnRJZHNUb1JlbW92ZUZyb21Db250ZXh0KCk7XHJcbiAgICBjb25zdCBkYXRhSWRzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgYXR0YWNoSWRzLmZvckVhY2goKGF0dGFjaElkOiBzdHJpbmcpID0+IHtcclxuXHJcbiAgICAgIC8vIOS4iuS8oOWIoOmZpOWSjOmihOiniOWIoOmZpOS8oOmAkui/h+adpeeahGZpbGVJZOeahGtleeWPr+iDveS4jeS4gOiHtO+8jOimgeWBmuWFvOWuuVxyXG4gICAgICBjb25zdCBkYXRhSWQgPSB0aGlzLmNvbnZlcnRBdHRhY2htZW50SWRUb0RhdGFJZChhdHRhY2hJZCwgYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xyXG4gICAgICBkYXRhSWRzLnB1c2goZGF0YUlkKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGRhdGFJZHM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDku47lkb3ku6TkuIrkuIvmlofkuK3ojrflj5bopoHliKDpmaTpmYTku7ZpZHNcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0QXR0YWNobWVudElkc1RvUmVtb3ZlRnJvbUNvbnRleHQoKSB7XHJcbiAgICBjb25zdCBjb21tYW5kQ29udGV4dCA9IHRoaXNbJ2NvbnRleHQnXSBhcyBDb21tYW5kQ29udGV4dDtcclxuICAgIHJldHVybiBjb21tYW5kQ29udGV4dC5ldmVudFBhcmFtcyBhcyBzdHJpbmdbXTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOagueaNrui3r+W+hOiOt+WPlumZhOS7tuWtl+auteWAvOaVsOe7hFxyXG4gICAqIEBwYXJhbSBmaWVsZFBhdGgg5a2X5q616Lev5b6EXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjb252ZXJ0QXR0YWNobWVudElkVG9EYXRhSWQoZmlsZUlkOiBzdHJpbmcsIGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xyXG5cclxuICAgIC8vIOino+aekOi3r+W+hFxyXG4gICAgY29uc3QgYXR0YWNoSW5mb0JpbmRpbmdQYXRoID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcclxuICAgIGNvbnN0IGF0dGFjaEZpZWxkTmFtZSA9IGF0dGFjaEluZm9CaW5kaW5nUGF0aC5wb3AoKTtcclxuICAgIGNvbnN0IGF0dGFjaExpc3RCaW5kaW5nUGF0aCA9IGF0dGFjaEluZm9CaW5kaW5nUGF0aDtcclxuXHJcbiAgICAvLyDojrflj5bpmYTku7ZpZOaVsOe7hFxyXG4gICAgY29uc3QgZW50aXR5TGlzdERhdGEgPSB0aGlzLmVudGl0eVNlcnZpY2UuZ2V0RW50aXR5TGlzdERhdGEoYXR0YWNoTGlzdEJpbmRpbmdQYXRoKTtcclxuICAgIGNvbnN0IHRhcmdldEVudGl0eURhdGEgPSBlbnRpdHlMaXN0RGF0YS5maW5kKChlbnRpdHlEYXRhOiBhbnkpID0+IHtcclxuICAgICAgaWYgKGVudGl0eURhdGFbYXR0YWNoRmllbGROYW1lXSkge1xyXG4gICAgICAgIGNvbnN0IGF0dGFjaG1lbnRJZCA9IGVudGl0eURhdGFbYXR0YWNoRmllbGROYW1lXVsnYXR0YWNobWVudElkJ107XHJcbiAgICAgICAgaWYgKGF0dGFjaG1lbnRJZCA9PT0gZmlsZUlkKSB7XHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiB0YXJnZXRFbnRpdHlEYXRhLmlkO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5bim6ZmE5Lu255qEQmluZGluZ0xpc3TnmoRQYXRoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRCaW5kaW5nTGlzdFBhdGhXaXRoQXR0YWNobWVudHMoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZykge1xyXG4gICAgY29uc3QgYXR0YWNoSW5mb0JpbmRpbmdQYXRoID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcclxuICAgIGF0dGFjaEluZm9CaW5kaW5nUGF0aC5wb3AoKTtcclxuICAgIGNvbnN0IGJpbmRpbmdMaXN0UGF0aCA9IGF0dGFjaEluZm9CaW5kaW5nUGF0aDtcclxuICAgIHJldHVybiAnLycgKyBiaW5kaW5nTGlzdFBhdGguam9pbignLycpO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxufVxyXG5cclxuZXhwb3J0IHsgQXR0YWNobWVudFNlcnZpY2UgfTtcclxuIl19