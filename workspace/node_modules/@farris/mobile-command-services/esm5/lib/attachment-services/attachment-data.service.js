/**
 * @fileoverview added by tsickle
 * Generated from: lib/attachment-services/attachment-data.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of } from 'rxjs';
import { tap, switchMap, map } from 'rxjs/operators';
import { HttpMethods, BindingPathConverter, DataChangeType } from '@farris/mobile-devkit';
import { BefDataPathUtil } from '@farris/mobile-bef';
import { AttachmentUtil } from './attachment.util';
/**
 * 附件数据服务
 */
var /**
 * 附件数据服务
 */
AttachmentDataService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function AttachmentDataService(viewModelContext) {
        this.viewModelContext = viewModelContext;
    }
    Object.defineProperty(AttachmentDataService.prototype, "befRepository", {
        /**
         * 实体仓库
         */
        get: /**
         * 实体仓库
         * @private
         * @return {?}
         */
        function () {
            return (/** @type {?} */ (this.viewModelContext.repository));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AttachmentDataService.prototype, "bindingData", {
        /**
         * 绑定数据
         */
        get: /**
         * 绑定数据
         * @private
         * @return {?}
         */
        function () {
            return this.viewModelContext.bindingData;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 更新附件信息
     */
    /**
     * 更新附件信息
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfo
     * @return {?}
     */
    AttachmentDataService.prototype.updateRow = /**
     * 更新附件信息
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfo
     * @return {?}
     */
    function (attachmentInfoFieldPath, attachmentInfo) {
        var _this = this;
        /** @type {?} */
        var apiProxy = this.befRepository.apiProxy;
        /** @type {?} */
        var updateUrl = apiProxy.baseUrl + "/service/updateattachment";
        /** @type {?} */
        var serverAttachInfo = this.createUpdateAttachInfo(attachmentInfoFieldPath, attachmentInfo);
        /** @type {?} */
        var body = {
            updateAttachInfo: serverAttachInfo
        };
        /** @type {?} */
        var requestConfig = {
            body: body
        };
        console.log('loading show ...');
        return apiProxy.request(HttpMethods.PUT, updateUrl, requestConfig).pipe(switchMap((/**
         * @param {?} result
         * @return {?}
         */
        function (result) {
            return _this.syncAttachmentInfosToClient();
        })), tap((/**
         * @return {?}
         */
        function () {
            console.log('loading hide ...');
        })));
    };
    /**
     * 批量创建附件行数据
     */
    /**
     * 批量创建附件行数据
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfos
     * @return {?}
     */
    AttachmentDataService.prototype.updateRows = /**
     * 批量创建附件行数据
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfos
     * @return {?}
     */
    function (attachmentInfoFieldPath, attachmentInfos) {
        var _this = this;
        /** @type {?} */
        var apiProxy = this.befRepository.apiProxy;
        /** @type {?} */
        var updateUrl = apiProxy.baseUrl + "/service/batchuploadattachment";
        /** @type {?} */
        var serverAttachInfo = this.createBatchCreateAttachInfo(attachmentInfoFieldPath, attachmentInfos);
        /** @type {?} */
        var isRootEntity = serverAttachInfo.NodeCodes.length === 0;
        /** @type {?} */
        var body = {
            batchUploadInfo: serverAttachInfo
        };
        /** @type {?} */
        var requestConfig = {
            body: body
        };
        console.log('loading show ...');
        return apiProxy.request(HttpMethods.PUT, updateUrl, requestConfig).pipe(switchMap((/**
         * @param {?} result
         * @return {?}
         */
        function (result) {
            return _this.appendAttachmentInfosToClient(result, isRootEntity);
        })), tap((/**
         * @return {?}
         */
        function () {
            console.log('hide loading ...');
        })));
    };
    /**
     * 创建服务器端需要的更新信息
     */
    /**
     * 创建服务器端需要的更新信息
     * @private
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfo
     * @return {?}
     */
    AttachmentDataService.prototype.createUpdateAttachInfo = /**
     * 创建服务器端需要的更新信息
     * @private
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfo
     * @return {?}
     */
    function (attachmentInfoFieldPath, attachmentInfo) {
        /** @type {?} */
        var attachmentId = attachmentInfo.attachmentId;
        /** @type {?} */
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        /** @type {?} */
        var nodeCodes = BefDataPathUtil.convertToObjectCodes(parentBindingPathArray, this.bindingData);
        /** @type {?} */
        var hiretryIds = BefDataPathUtil.convertToDataIdsForUpdate(parentBindingPathArray, this.bindingData);
        /** @type {?} */
        var serverAttachInfo = {
            NodeCodes: nodeCodes,
            HiretryIds: hiretryIds,
            AttachmentIds: [attachmentId],
            AttachmentId: attachmentId
        };
        return serverAttachInfo;
    };
    /**
     * 创建服务器端需要的批量新增附件信息
     */
    /**
     * 创建服务器端需要的批量新增附件信息
     * @private
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfo
     * @return {?}
     */
    AttachmentDataService.prototype.createBatchCreateAttachInfo = /**
     * 创建服务器端需要的批量新增附件信息
     * @private
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfo
     * @return {?}
     */
    function (attachmentInfoFieldPath, attachmentInfo) {
        /** @type {?} */
        var attachmentIds = AttachmentUtil.peekAttachmentIds(attachmentInfo);
        /** @type {?} */
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        /** @type {?} */
        var nodeCodes = BefDataPathUtil.convertToObjectCodes(parentBindingPathArray, this.bindingData);
        /** @type {?} */
        var hiretryIds = BefDataPathUtil.convertToDataIdsForAdd(parentBindingPathArray, this.bindingData);
        /** @type {?} */
        var serverAttachInfo = {
            NodeCodes: nodeCodes,
            HiretryIds: hiretryIds,
            AttachmentIds: attachmentIds,
            AttachmentId: null
        };
        return serverAttachInfo;
    };
    /**
     * 同步服务器端最新信息到客户端
     * @todo:
     * 1、主对象批量新增时不支持
     */
    /**
     * 同步服务器端最新信息到客户端
     * \@todo:
     * 1、主对象批量新增时不支持
     * @return {?}
     */
    AttachmentDataService.prototype.syncAttachmentInfosToClient = /**
     * 同步服务器端最新信息到客户端
     * \@todo:
     * 1、主对象批量新增时不支持
     * @return {?}
     */
    function () {
        /** @type {?} */
        var rootDataId = this.bindingData.list.currentId;
        return this.befRepository.updateEntityById(rootDataId);
    };
    /**
     * 追击主表数据到客户端
     */
    /**
     * 追击主表数据到客户端
     * @param {?} listData
     * @param {?} isRootEntity
     * @return {?}
     */
    AttachmentDataService.prototype.appendAttachmentInfosToClient = /**
     * 追击主表数据到客户端
     * @param {?} listData
     * @param {?} isRootEntity
     * @return {?}
     */
    function (listData, isRootEntity) {
        var _this = this;
        if (isRootEntity === true) {
            /** @type {?} */
            var entities = this.befRepository.buildEntities(listData);
            this.befRepository.entityCollection.addEntities(entities);
            return of(listData);
        }
        else {
            return this.syncAttachmentInfosToClient().pipe(map((/**
             * @return {?}
             */
            function () {
                _this.befRepository.dataChangeHistory.addChange({ dataId: listData[0].id, changeType: DataChangeType.Add });
                return listData;
            })));
        }
    };
    return AttachmentDataService;
}());
if (false) {
    /**
     * ViewModel上下文
     * @type {?}
     * @private
     */
    AttachmentDataService.prototype.viewModelContext;
}
export { AttachmentDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0YWNobWVudC1kYXRhLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2F0dGFjaG1lbnQtc2VydmljZXMvYXR0YWNobWVudC1kYXRhLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JELE9BQU8sRUFBcUIsV0FBVyxFQUF5QyxvQkFBb0IsRUFBRSxjQUFjLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNwSixPQUFPLEVBQWlCLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXBFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQzs7OztBQUtuRDs7OztJQXFCRTs7T0FFRztJQUNILCtCQUFZLGdCQUFrQztRQUM1QyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUM7SUFDM0MsQ0FBQztJQWhCRCxzQkFBWSxnREFBYTtRQUh6Qjs7V0FFRzs7Ozs7O1FBQ0g7WUFDRSxPQUFPLG1CQUFBLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEVBQXlCLENBQUM7UUFDbkUsQ0FBQzs7O09BQUE7SUFLRCxzQkFBWSw4Q0FBVztRQUh2Qjs7V0FFRzs7Ozs7O1FBQ0g7WUFDRSxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUM7UUFDM0MsQ0FBQzs7O09BQUE7SUFTRDs7T0FFRzs7Ozs7OztJQUNJLHlDQUFTOzs7Ozs7SUFBaEIsVUFBaUIsdUJBQStCLEVBQUUsY0FBOEI7UUFBaEYsaUJBb0JDOztZQW5CTyxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFROztZQUN0QyxTQUFTLEdBQU0sUUFBUSxDQUFD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RUFBRSxFQUFFLFVBQVUsRUFBRSxjQUFjLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDM0csT0FBTyxRQUFRLENBQUM7WUFDbEIsQ0FBQyxFQUFDLENBQ0gsQ0FBQztTQUNIO0lBQ0gsQ0FBQztJQUVILDRCQUFDO0FBQUQsQ0FBQyxBQXRKRCxJQXNKQzs7Ozs7OztJQWpKQyxpREFBMEM7O0FBbUo1QyxPQUFPLEVBQUUscUJBQXFCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHRhcCwgc3dpdGNoTWFwLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEh0dHBSZXF1ZXN0Q29uZmlnLCBIdHRwTWV0aG9kcywgRW50aXR5LCBWaWV3TW9kZWxDb250ZXh0LCBCaW5kaW5nRGF0YSwgQmluZGluZ1BhdGhDb252ZXJ0ZXIsIERhdGFDaGFuZ2VUeXBlIH0gZnJvbSAnQGZhcnJpcy9tb2JpbGUtZGV2a2l0JztcclxuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSwgQmVmRGF0YVBhdGhVdGlsIH0gZnJvbSAnQGZhcnJpcy9tb2JpbGUtYmVmJztcclxuaW1wb3J0IHsgQXR0YWNobWVudEluZm8sIFNlcnZlckF0dGFjaG1lbnRJbmZvIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IEF0dGFjaG1lbnRVdGlsIH0gZnJvbSAnLi9hdHRhY2htZW50LnV0aWwnO1xyXG5cclxuLyoqXHJcbiAqIOmZhOS7tuaVsOaNruacjeWKoVxyXG4gKi9cclxuY2xhc3MgQXR0YWNobWVudERhdGFTZXJ2aWNlIHtcclxuXHJcbiAgLyoqXHJcbiAgICogVmlld01vZGVs5LiK5LiL5paHXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0XHJcblxyXG4gIC8qKlxyXG4gICAqIOWunuS9k+S7k+W6k1xyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0IGJlZlJlcG9zaXRvcnkoKTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+IHtcclxuICAgIHJldHVybiB0aGlzLnZpZXdNb2RlbENvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PEVudGl0eT47XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDnu5HlrprmlbDmja5cclxuICAgKi9cclxuICBwcml2YXRlIGdldCBiaW5kaW5nRGF0YSgpOiBCaW5kaW5nRGF0YSB7XHJcbiAgICByZXR1cm4gdGhpcy52aWV3TW9kZWxDb250ZXh0LmJpbmRpbmdEYXRhO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3Iodmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dCkge1xyXG4gICAgdGhpcy52aWV3TW9kZWxDb250ZXh0ID0gdmlld01vZGVsQ29udGV4dDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOabtOaWsOmZhOS7tuS/oeaBr1xyXG4gICAqL1xyXG4gIHB1YmxpYyB1cGRhdGVSb3coYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgYXR0YWNobWVudEluZm86IEF0dGFjaG1lbnRJbmZvKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IGFwaVByb3h5ID0gdGhpcy5iZWZSZXBvc2l0b3J5LmFwaVByb3h5O1xyXG4gICAgY29uc3QgdXBkYXRlVXJsID0gYCR7YXBpUHJveHkuYmFzZVVybH0vc2VydmljZS91cGRhdGVhdHRhY2htZW50YDtcclxuICAgIGNvbnN0IHNlcnZlckF0dGFjaEluZm8gPSB0aGlzLmNyZWF0ZVVwZGF0ZUF0dGFjaEluZm8oYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGF0dGFjaG1lbnRJbmZvKTtcclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgIHVwZGF0ZUF0dGFjaEluZm86IHNlcnZlckF0dGFjaEluZm9cclxuICAgIH07XHJcbiAgICBjb25zdCByZXF1ZXN0Q29uZmlnOiBIdHRwUmVxdWVzdENvbmZpZyA9IHtcclxuICAgICAgYm9keTogYm9keVxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zb2xlLmxvZygnbG9hZGluZyBzaG93IC4uLicpO1xyXG4gICAgcmV0dXJuIGFwaVByb3h5LnJlcXVlc3QoSHR0cE1ldGhvZHMuUFVULCB1cGRhdGVVcmwsIHJlcXVlc3RDb25maWcpLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcCgocmVzdWx0OiBhbnkpID0+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zeW5jQXR0YWNobWVudEluZm9zVG9DbGllbnQoKTtcclxuICAgICAgfSksXHJcbiAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ2xvYWRpbmcgaGlkZSAuLi4nKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmibnph4/liJvlu7rpmYTku7booYzmlbDmja5cclxuICAgKi9cclxuICBwdWJsaWMgdXBkYXRlUm93cyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBhdHRhY2htZW50SW5mb3M6IEF0dGFjaG1lbnRJbmZvW10pOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3QgYXBpUHJveHkgPSB0aGlzLmJlZlJlcG9zaXRvcnkuYXBpUHJveHk7XHJcbiAgICBjb25zdCB1cGRhdGVVcmwgPSBgJHthcGlQcm94eS5iYXNlVXJsfS9zZXJ2aWNlL2JhdGNodXBsb2FkYXR0YWNobWVudGA7XHJcbiAgICBjb25zdCBzZXJ2ZXJBdHRhY2hJbmZvID0gdGhpcy5jcmVhdGVCYXRjaENyZWF0ZUF0dGFjaEluZm8oYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGF0dGFjaG1lbnRJbmZvcyk7XHJcbiAgICBjb25zdCBpc1Jvb3RFbnRpdHkgPSBzZXJ2ZXJBdHRhY2hJbmZvLk5vZGVDb2Rlcy5sZW5ndGggPT09IDA7XHJcblxyXG4gICAgY29uc3QgYm9keSA9IHtcclxuICAgICAgYmF0Y2hVcGxvYWRJbmZvOiBzZXJ2ZXJBdHRhY2hJbmZvXHJcbiAgICB9O1xyXG4gICAgY29uc3QgcmVxdWVzdENvbmZpZzogSHR0cFJlcXVlc3RDb25maWcgPSB7XHJcbiAgICAgIGJvZHk6IGJvZHlcclxuICAgIH07XHJcblxyXG4gICAgY29uc29sZS5sb2coJ2xvYWRpbmcgc2hvdyAuLi4nKTtcclxuICAgIHJldHVybiBhcGlQcm94eS5yZXF1ZXN0KEh0dHBNZXRob2RzLlBVVCwgdXBkYXRlVXJsLCByZXF1ZXN0Q29uZmlnKS5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKHJlc3VsdDogYW55KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwZW5kQXR0YWNobWVudEluZm9zVG9DbGllbnQocmVzdWx0LCBpc1Jvb3RFbnRpdHkpO1xyXG4gICAgICB9KSxcclxuICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZygnaGlkZSBsb2FkaW5nIC4uLicpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIm+W7uuacjeWKoeWZqOerr+mcgOimgeeahOabtOaWsOS/oeaBr1xyXG4gICAqL1xyXG4gIHByaXZhdGUgY3JlYXRlVXBkYXRlQXR0YWNoSW5mbyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBhdHRhY2htZW50SW5mbzogQXR0YWNobWVudEluZm8pOiBTZXJ2ZXJBdHRhY2htZW50SW5mbyB7XHJcblxyXG4gICAgY29uc3QgYXR0YWNobWVudElkID0gYXR0YWNobWVudEluZm8uYXR0YWNobWVudElkO1xyXG4gICAgY29uc3QgcGFyZW50QmluZGluZ1BhdGhBcnJheSA9IEJpbmRpbmdQYXRoQ29udmVydGVyLnRvQmluZGluZ1BhdGhBcnJheShhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCk7XHJcbiAgICBwYXJlbnRCaW5kaW5nUGF0aEFycmF5LnBvcCgpO1xyXG4gICAgY29uc3Qgbm9kZUNvZGVzID0gQmVmRGF0YVBhdGhVdGlsLmNvbnZlcnRUb09iamVjdENvZGVzKHBhcmVudEJpbmRpbmdQYXRoQXJyYXksIHRoaXMuYmluZGluZ0RhdGEpO1xyXG4gICAgY29uc3QgaGlyZXRyeUlkcyA9IEJlZkRhdGFQYXRoVXRpbC5jb252ZXJ0VG9EYXRhSWRzRm9yVXBkYXRlKHBhcmVudEJpbmRpbmdQYXRoQXJyYXksIHRoaXMuYmluZGluZ0RhdGEpO1xyXG5cclxuICAgIGNvbnN0IHNlcnZlckF0dGFjaEluZm86IFNlcnZlckF0dGFjaG1lbnRJbmZvID0ge1xyXG4gICAgICBOb2RlQ29kZXM6IG5vZGVDb2RlcyxcclxuICAgICAgSGlyZXRyeUlkczogaGlyZXRyeUlkcyxcclxuICAgICAgQXR0YWNobWVudElkczogW2F0dGFjaG1lbnRJZF0sXHJcbiAgICAgIEF0dGFjaG1lbnRJZDogYXR0YWNobWVudElkXHJcbiAgICB9O1xyXG5cclxuICAgIHJldHVybiBzZXJ2ZXJBdHRhY2hJbmZvO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yib5bu65pyN5Yqh5Zmo56uv6ZyA6KaB55qE5om56YeP5paw5aKe6ZmE5Lu25L+h5oGvXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjcmVhdGVCYXRjaENyZWF0ZUF0dGFjaEluZm8oYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgYXR0YWNobWVudEluZm86IEF0dGFjaG1lbnRJbmZvW10pOiBTZXJ2ZXJBdHRhY2htZW50SW5mbyB7XHJcbiAgICBjb25zdCBhdHRhY2htZW50SWRzID0gQXR0YWNobWVudFV0aWwucGVla0F0dGFjaG1lbnRJZHMoYXR0YWNobWVudEluZm8pO1xyXG5cclxuICAgIGNvbnN0IHBhcmVudEJpbmRpbmdQYXRoQXJyYXkgPSBCaW5kaW5nUGF0aENvbnZlcnRlci50b0JpbmRpbmdQYXRoQXJyYXkoYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xyXG4gICAgcGFyZW50QmluZGluZ1BhdGhBcnJheS5wb3AoKTtcclxuICAgIGNvbnN0IG5vZGVDb2RlcyA9IEJlZkRhdGFQYXRoVXRpbC5jb252ZXJ0VG9PYmplY3RDb2RlcyhwYXJlbnRCaW5kaW5nUGF0aEFycmF5LCB0aGlzLmJpbmRpbmdEYXRhKTtcclxuICAgIGNvbnN0IGhpcmV0cnlJZHMgPSBCZWZEYXRhUGF0aFV0aWwuY29udmVydFRvRGF0YUlkc0ZvckFkZChwYXJlbnRCaW5kaW5nUGF0aEFycmF5LCB0aGlzLmJpbmRpbmdEYXRhKTtcclxuXHJcbiAgICBjb25zdCBzZXJ2ZXJBdHRhY2hJbmZvID0ge1xyXG4gICAgICBOb2RlQ29kZXM6IG5vZGVDb2RlcyxcclxuICAgICAgSGlyZXRyeUlkczogaGlyZXRyeUlkcyxcclxuICAgICAgQXR0YWNobWVudElkczogYXR0YWNobWVudElkcyxcclxuICAgICAgQXR0YWNobWVudElkOiBudWxsXHJcbiAgICB9O1xyXG5cclxuICAgIHJldHVybiBzZXJ2ZXJBdHRhY2hJbmZvO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5ZCM5q2l5pyN5Yqh5Zmo56uv5pyA5paw5L+h5oGv5Yiw5a6i5oi356uvXHJcbiAgICogQHRvZG86XHJcbiAgICogMeOAgeS4u+WvueixoeaJuemHj+aWsOWinuaXtuS4jeaUr+aMgVxyXG4gICAqL1xyXG4gIHB1YmxpYyBzeW5jQXR0YWNobWVudEluZm9zVG9DbGllbnQoKSB7XHJcbiAgICBjb25zdCByb290RGF0YUlkID0gdGhpcy5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZDtcclxuICAgIHJldHVybiB0aGlzLmJlZlJlcG9zaXRvcnkudXBkYXRlRW50aXR5QnlJZChyb290RGF0YUlkKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOi/veWHu+S4u+ihqOaVsOaNruWIsOWuouaIt+err1xyXG4gICAqL1xyXG4gIHB1YmxpYyBhcHBlbmRBdHRhY2htZW50SW5mb3NUb0NsaWVudChsaXN0RGF0YTogYW55W10sIGlzUm9vdEVudGl0eTogYm9vbGVhbik6IE9ic2VydmFibGU8YW55W10+IHtcclxuICAgIGlmIChpc1Jvb3RFbnRpdHkgPT09IHRydWUpIHtcclxuICAgICAgY29uc3QgZW50aXRpZXMgPSB0aGlzLmJlZlJlcG9zaXRvcnkuYnVpbGRFbnRpdGllcyhsaXN0RGF0YSk7XHJcbiAgICAgIHRoaXMuYmVmUmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmFkZEVudGl0aWVzKGVudGl0aWVzKTtcclxuICAgICAgcmV0dXJuIG9mKGxpc3REYXRhKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnN5bmNBdHRhY2htZW50SW5mb3NUb0NsaWVudCgpLnBpcGUoXHJcbiAgICAgICAgbWFwKCgpID0+IHtcclxuICAgICAgICAgIHRoaXMuYmVmUmVwb3NpdG9yeS5kYXRhQ2hhbmdlSGlzdG9yeS5hZGRDaGFuZ2UoeyBkYXRhSWQ6IGxpc3REYXRhWzBdLmlkLCBjaGFuZ2VUeXBlOiBEYXRhQ2hhbmdlVHlwZS5BZGQgfSk7XHJcbiAgICAgICAgICByZXR1cm4gbGlzdERhdGE7XHJcbiAgICAgICAgfSlcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQgeyBBdHRhY2htZW50RGF0YVNlcnZpY2UgfTtcclxuIl19