/**
 * @fileoverview added by tsickle
 * Generated from: lib/router.servcie.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { tap, map } from 'rxjs/operators';
import { HttpClient } from '@farris/mobile-devkit';
/**
 * 路由服务
 */
var /**
 * 路由服务
 */
RouterService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function RouterService(viewModelContext, router, jsBridgeService) {
        this.jsBridgeService = jsBridgeService;
        this.viewModelContext = viewModelContext;
        this.router = router;
    }
    /**
     * 路由跳转
     * @param path   路由路径
     * @param params 路由参数
     */
    /**
     * 路由跳转
     * @param {?} path   路由路径
     * @param {?=} queryParams
     * @param {?=} backParams
     * @param {?=} backPath
     * @return {?}
     */
    RouterService.prototype.navigate = /**
     * 路由跳转
     * @param {?} path   路由路径
     * @param {?=} queryParams
     * @param {?=} backParams
     * @param {?=} backPath
     * @return {?}
     */
    function (path, queryParams, backParams, backPath) {
        if (queryParams === void 0) { queryParams = {}; }
        if (backParams === void 0) { backParams = {}; }
        if (!path)
            return;
        queryParams = this.ParamsFromStringToObject(queryParams);
        backParams = this.ParamsFromStringToObject(backParams);
        /** @type {?} */
        var pathIndex = this.sessionStorageSaveHistory(path, backPath, backParams)
        // 跨工程跳转
        ;
        // 跨工程跳转
        if (path && pathIndex >= 0) {
            /** @type {?} */
            var urlPath = this.splicePath(path, queryParams);
            window.location.href = urlPath;
            return false;
        }
        window['MOBILE_ORIGIN_BACK'] && window['MOBILE_ORIGIN_BACK'].reflushOriginGoback();
        this.router.push({
            path: path,
            query: queryParams
        });
    };
    /**
     * @private
     * @param {?} pathIndex
     * @param {?} path
     * @return {?}
     */
    RouterService.prototype.removeParams = /**
     * @private
     * @param {?} pathIndex
     * @param {?} path
     * @return {?}
     */
    function (pathIndex, path) {
        /** @type {?} */
        var end = path.search('\\?');
        if (end = -1) {
            end = path.length;
        }
        return path.slice(pathIndex, end);
    };
    /**
     * @private
     * @param {?} path
     * @return {?}
     */
    RouterService.prototype.getsessionStorageSaveHistoryKey = /**
     * @private
     * @param {?} path
     * @return {?}
     */
    function (path) {
        /** @type {?} */
        var pathIndex = path.search('/apps');
        // 跨页面跳转离开
        if (path && pathIndex >= 0) {
            return this.removeParams(pathIndex, path);
        }
        return this.router.options.history.base + path;
    };
    /**
     * @private
     * @param {?} path
     * @param {?} backPath
     * @param {?} backParams
     * @return {?}
     */
    RouterService.prototype.sessionStorageSaveHistory = /**
     * @private
     * @param {?} path
     * @param {?} backPath
     * @param {?} backParams
     * @return {?}
     */
    function (path, backPath, backParams) {
        /** @type {?} */
        var pathIndex = path.search('/apps');
        /** @type {?} */
        var key = this.getsessionStorageSaveHistoryKey(path);
        /** @type {?} */
        var historyObject = {}
        //判断是否制定了目标页面得返回地址
        ;
        //判断是否制定了目标页面得返回地址
        if (backPath) {
            /** @type {?} */
            var backPathIndex = path.search('/apps');
            //指定返回路由为跨工程跳转
            if (backPathIndex >= 0) {
                historyObject = {
                    routerWay: 'href',
                    path: backPath,
                    query: backParams
                };
            }
            else {
                historyObject = {
                    routerWay: 'Router',
                    path: backPath,
                    query: backParams
                };
            }
            sessionStorage.setItem(key, JSON.stringify(historyObject));
            return pathIndex;
        }
        else {
            /** @type {?} */
            var currentPath = this.router.currentRoute.value.path;
            // 跨页面跳转离开
            if (path && pathIndex >= 0) {
                //拼接当前路由
                currentPath = this.router.options.history.base + this.router.options.history.location;
                //记录当前路由
                historyObject = {
                    routerWay: 'href',
                    path: currentPath,
                    query: backParams
                };
            }
            else {
                // 路由方式跳转记录
                historyObject = {
                    routerWay: 'Router',
                    path: currentPath,
                    query: backParams
                };
            }
            sessionStorage.setItem(key, JSON.stringify(historyObject));
            return pathIndex;
        }
    };
    /**
     * 带维度的路由跳转
     */
    /**
     * 带维度的路由跳转
     * @param {?} path
     * @param {?=} queryParams
     * @param {?=} backParams
     * @param {?=} backPath
     * @return {?}
     */
    RouterService.prototype.navigateForRtc = /**
     * 带维度的路由跳转
     * @param {?} path
     * @param {?=} queryParams
     * @param {?=} backParams
     * @param {?=} backPath
     * @return {?}
     */
    function (path, queryParams, backParams, backPath) {
        var _this = this;
        if (queryParams === void 0) { queryParams = {}; }
        if (backParams === void 0) { backParams = {}; }
        if (!queryParams || !queryParams.metadataId) {
            this.navigate(path, queryParams, backParams, backPath);
        }
        /** @type {?} */
        var rtcOptions = {
            metadataId: queryParams.metadataId,
            withDims: false,
            dim1: queryParams.dim1,
            dim2: queryParams.dim2
        };
        delete queryParams['metadataId'];
        delete queryParams['dim1'];
        delete queryParams['dim2'];
        /** @type {?} */
        var correctRtcOptions$ = this.correctRtcOptions(rtcOptions);
        /** @type {?} */
        var extendedPath$ = correctRtcOptions$.pipe(map((/**
         * @param {?} correctedRtcOptions
         * @return {?}
         */
        function (correctedRtcOptions) {
            return _this.getExtendPath(path, correctedRtcOptions);
        })));
        /** @type {?} */
        var result$ = extendedPath$.pipe(tap((/**
         * @param {?} extendedPath
         * @return {?}
         */
        function (extendedPath) {
            _this.navigate(extendedPath, queryParams, backParams);
        })));
        result$.subscribe();
    };
    /**
     * 纠正维度信息
     * @summary
     * 1、非运行时定制表单，widthDims=false, 维度为空；
     * 2、运行时定制表单：维度值不存在时，则纠正为public；
     */
    /**
     * 纠正维度信息
     * \@summary
     * 1、非运行时定制表单，widthDims=false, 维度为空；
     * 2、运行时定制表单：维度值不存在时，则纠正为public；
     * @private
     * @param {?} rtcOptions
     * @return {?}
     */
    RouterService.prototype.correctRtcOptions = /**
     * 纠正维度信息
     * \@summary
     * 1、非运行时定制表单，widthDims=false, 维度为空；
     * 2、运行时定制表单：维度值不存在时，则纠正为public；
     * @private
     * @param {?} rtcOptions
     * @return {?}
     */
    function (rtcOptions) {
        /** @type {?} */
        var dim1 = rtcOptions.dim1 || 'public';
        /** @type {?} */
        var dim2 = rtcOptions.dim2 || 'public';
        /** @type {?} */
        var metadataId = rtcOptions.metadataId;
        /** @type {?} */
        var httpClient = this.viewModelContext.injector.get(HttpClient);
        /** @type {?} */
        var url = '/api/runtime/bcc/v1.0/template/beforeNavigate';
        /** @type {?} */
        var body = {
            isRootMetadata: true,
            metadataId: metadataId,
            dim1: dim1,
            dim2: dim2,
        };
        /** @type {?} */
        var beforeNavigate$ = httpClient.post(url, body, null).pipe(map((/**
         * @param {?} result
         * @return {?}
         */
        function (result) {
            /** @type {?} */
            var correctedRtcOptions = {
                metadataId: result.metadataId,
                withDims: result.withDims === 1 ? true : false,
                dim1: result.dim1,
                dim2: result.dim2
            };
            return correctedRtcOptions;
        })));
        return beforeNavigate$;
    };
    /**
     * 获取运行时定制表单地址
     */
    /**
     * 获取运行时定制表单地址
     * @private
     * @param {?} path
     * @param {?} rtcOptions
     * @return {?}
     */
    RouterService.prototype.getExtendPath = /**
     * 获取运行时定制表单地址
     * @private
     * @param {?} path
     * @param {?} rtcOptions
     * @return {?}
     */
    function (path, rtcOptions) {
        if (rtcOptions.withDims === false) {
            return path;
        }
        /** @type {?} */
        var arrPath = path.split('index.html');
        /** @type {?} */
        var append = (rtcOptions.dim1 + "/" + rtcOptions.dim2 + "/index.html").toLowerCase();
        /** @type {?} */
        var extendPath = arrPath.join(append);
        return extendPath;
    };
    /**
     * 拼接url路径
     * @param path 路径
     * @param params 参数
     * @returns
     */
    /**
     * 拼接url路径
     * @private
     * @param {?} path 路径
     * @param {?} params 参数
     * @return {?}
     */
    RouterService.prototype.splicePath = /**
     * 拼接url路径
     * @private
     * @param {?} path 路径
     * @param {?} params 参数
     * @return {?}
     */
    function (path, params) {
        /** @type {?} */
        var urlPath = path;
        /** @type {?} */
        var end = urlPath.search('\\?');
        if (end > -1) {
            urlPath = urlPath.slice(0, end);
        }
        /** @type {?} */
        var keys = Object.keys(params);
        if (keys.length > 0) {
            urlPath = urlPath + '?';
            keys.forEach((/**
             * @param {?} element
             * @return {?}
             */
            function (element) {
                urlPath = urlPath + element + '=' + params["" + element] + '&';
            }));
            urlPath = urlPath.slice(0, urlPath.length - 1);
        }
        return urlPath;
    };
    /**
     * @private
     * @param {?} params
     * @return {?}
     */
    RouterService.prototype.ParamsFromStringToObject = /**
     * @private
     * @param {?} params
     * @return {?}
     */
    function (params) {
        if (Object.prototype.toString.call(params) === '[object Object]') {
            return params;
        }
        try {
            params = JSON.parse(params);
        }
        catch (error) {
            if (!params) {
                params = {};
            }
            else {
                params = {};
                console.error('路由传参params不是JSON串格式');
            }
        }
        if (Object.prototype.toString.call(params) !== '[object Object]') {
            return {};
        }
        return params;
    };
    /**
   * 路由跳转
   * @param path   路由路径
   * @param params 路由参数
   */
    /**
     * 路由跳转
     * @param {?} path   路由路径
     * @param {?=} queryParams
     * @return {?}
     */
    RouterService.prototype.navigateReplace = /**
     * 路由跳转
     * @param {?} path   路由路径
     * @param {?=} queryParams
     * @return {?}
     */
    function (path, queryParams) {
        if (queryParams === void 0) { queryParams = {}; }
        if (typeof queryParams === 'string') {
            queryParams = JSON.parse(queryParams);
        }
        this.router.replace({
            path: path,
            query: queryParams
        });
    };
    /**
     * 后退
     */
    /**
     * 后退
     * @param {?} params
     * @return {?}
     */
    RouterService.prototype.goBack = /**
     * 后退
     * @param {?} params
     * @return {?}
     */
    function (params) {
        params = this.ParamsFromStringToObject(params);
        /** @type {?} */
        var currentPath = this.router.options.history.base + this.router.currentRoute.value.path;
        /** @type {?} */
        var need_go_back = sessionStorage.getItem(currentPath);
        if (!need_go_back) {
            if (window.top.location.pathname.indexOf('mobiletaskcenter') > -1) {
                return;
            }
            this.jsBridgeService.closeWindow();
            return;
        }
        /** @type {?} */
        var keys = Object.keys(params);
        need_go_back = JSON.parse(need_go_back);
        if (need_go_back && need_go_back['routerWay'] === 'Router') {
            /** @type {?} */
            var query = need_go_back['query'];
            if (keys.length > 0) {
                query = tslib_1.__assign({}, query, params);
            }
            this.router.push({
                query: query,
                path: need_go_back['path'],
            });
        }
        if (need_go_back && need_go_back['routerWay'] === 'href') {
            /** @type {?} */
            var query = need_go_back['query'];
            if (keys.length > 0) {
                query = tslib_1.__assign({}, query, params);
            }
            /** @type {?} */
            var path = need_go_back['path'];
            path = this.splicePath(path, query);
            window.location.href = path;
        }
    };
    /**
     * 映射路由状态
     */
    /**
     * 映射路由状态
     * @return {?}
     */
    RouterService.prototype.mappingToUIState = /**
     * 映射路由状态
     * @return {?}
     */
    function () {
        /** @type {?} */
        var routerState = {
            params: this.router.currentRoute['value'].params,
            queryParams: this.router.currentRoute['value'].query
        };
        this.viewModelContext.uiState['routerState'] = routerState;
    };
    return RouterService;
}());
if (false) {
    /**
     * ViewModel上下文
     * @type {?}
     * @private
     */
    RouterService.prototype.viewModelContext;
    /**
     * VueRouter实例
     * @type {?}
     * @private
     */
    RouterService.prototype.router;
    /**
     * @type {?}
     * @private
     */
    RouterService.prototype.jsBridgeService;
}
/**
 * Token
 * \@todo：临时方案，直接注入VueRouter实例。
 * @type {?}
 */
var ROUTER_INSTANCE_TOKEN = '@farris/mobile-command-services/ROUTER_INSTANCE_TOKEN';
export { RouterService, ROUTER_INSTANCE_TOKEN };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLnNlcnZjaWUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL3JvdXRlci5zZXJ2Y2llLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUVBLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUMsT0FBTyxFQUFvQixVQUFVLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQzs7OztBQVVyRTs7OztJQVlFOztPQUVHO0lBQ0gsdUJBQVksZ0JBQWtDLEVBQUUsTUFBVyxFQUFVLGVBQWdDO1FBQWhDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUNuRyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUM7UUFDekMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7SUFDdkIsQ0FBQztJQUVEOzs7O09BSUc7Ozs7Ozs7OztJQUNILGdDQUFROzs7Ozs7OztJQUFSLFVBQVMsSUFBWSxFQUFFLFdBQXFCLEVBQUUsVUFBb0IsRUFBRSxRQUFpQjtRQUE5RCw0QkFBQSxFQUFBLGdCQUFxQjtRQUFFLDJCQUFBLEVBQUEsZUFBb0I7UUFDaEUsSUFBSSxDQUFDLElBQUk7WUFBRSxPQUFNO1FBRWpCLFdBQVcsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDekQsVUFBVSxHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxVQUFVLENBQUMsQ0FBQzs7WUFFakQsU0FBUyxHQUFHLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLFVBQVUsQ0FBQztRQUU1RSxRQUFROztRQUFSLFFBQVE7UUFDUixJQUFJLElBQUksSUFBSSxTQUFTLElBQUksQ0FBQyxFQUFFOztnQkFDdEIsT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQztZQUNoRCxNQUFN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LElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUNuQixLQUFLLHdCQUFRLEtBQUssRUFBSyxNQUFNLENBQUUsQ0FBQTthQUNoQzs7Z0JBQ0csSUFBSSxHQUFHLFlBQVksQ0FBQyxNQUFNLENBQUM7WUFFL0IsSUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBRXBDLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztTQUM3QjtJQUNILENBQUM7SUFFRDs7T0FFRzs7Ozs7SUFDSCx3Q0FBZ0I7Ozs7SUFBaEI7O1lBQ1EsV0FBVyxHQUFHO1lBQ2xCLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNO1lBQ2hELFdBQVcsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLO1NBQ3JEO1FBQ0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsR0FBRyxXQUFXLENBQUM7SUFDN0QsQ0FBQztJQUNILG9CQUFDO0FBQUQsQ0FBQyxBQXRURCxJQXNUQzs7Ozs7OztJQWpUQyx5Q0FBMkM7Ozs7OztJQUszQywrQkFBb0I7Ozs7O0lBS3lDLHdDQUF3Qzs7Ozs7OztJQTZTakcscUJBQXFCLEdBQUcsdURBQXVEO0FBRXJGLE9BQU8sRUFBRSxhQUFhLEVBQUUscUJBQXFCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIGltcG9ydCB7IFJvdXRlciB9IGZyb20gJ3Z1ZS1yb3V0ZXInO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHRhcCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBWaWV3TW9kZWxDb250ZXh0LCBIdHRwQ2xpZW50IH0gZnJvbSAnQGZhcnJpcy9tb2JpbGUtZGV2a2l0JztcclxuaW1wb3J0IHsgUnRjT3B0aW9ucywgQmVmb3JlTmF2aWdhdGVSZXBvbnNlQm9keSwgQmVmb3JlTmF2aWdhdGVSZXF1ZXN0Qm9keSB9IGZyb20gJy4vdHlwZXMvaW5kZXgnO1xyXG5pbXBvcnQgeyBKc0JyaWRnZVNlcnZpY2UgfSBmcm9tICcuL2pzLWJyaWRnZS1zZXJ2aWNlL2luZGV4JztcclxuXHJcblxyXG5cclxuXHJcbi8qKlxyXG4gKiDot6/nlLHmnI3liqFcclxuICovXHJcbmNsYXNzIFJvdXRlclNlcnZpY2Uge1xyXG5cclxuICAvKipcclxuICAgKiBWaWV3TW9kZWzkuIrkuIvmlodcclxuICAgKi9cclxuICBwcml2YXRlIHZpZXdNb2RlbENvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQ7XHJcblxyXG4gIC8qKlxyXG4gICAqIFZ1ZVJvdXRlcuWunuS+i1xyXG4gICAqL1xyXG4gIHByaXZhdGUgcm91dGVyOiBhbnk7XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKHZpZXdNb2RlbENvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQsIHJvdXRlcjogYW55LCBwcml2YXRlIGpzQnJpZGdlU2VydmljZTogSnNCcmlkZ2VTZXJ2aWNlKSB7XHJcbiAgICB0aGlzLnZpZXdNb2RlbENvbnRleHQgPSB2aWV3TW9kZWxDb250ZXh0O1xyXG4gICAgdGhpcy5yb3V0ZXIgPSByb3V0ZXI7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDot6/nlLHot7PovaxcclxuICAgKiBAcGFyYW0gcGF0aCAgIOi3r+eUsei3r+W+hFxyXG4gICAqIEBwYXJhbSBwYXJhbXMg6Lev55Sx5Y+C5pWwXHJcbiAgICovXHJcbiAgbmF2aWdhdGUocGF0aDogc3RyaW5nLCBxdWVyeVBhcmFtczogYW55ID0ge30sIGJhY2tQYXJhbXM6IGFueSA9IHt9LCBiYWNrUGF0aD86IHN0cmluZykge1xyXG4gICAgaWYgKCFwYXRoKSByZXR1cm5cclxuXHJcbiAgICBxdWVyeVBhcmFtcyA9IHRoaXMuUGFyYW1zRnJvbVN0cmluZ1RvT2JqZWN0KHF1ZXJ5UGFyYW1zKTtcclxuICAgIGJhY2tQYXJhbXMgPSB0aGlzLlBhcmFtc0Zyb21TdHJpbmdUb09iamVjdChiYWNrUGFyYW1zKTtcclxuXHJcbiAgICBjb25zdCBwYXRoSW5kZXggPSB0aGlzLnNlc3Npb25TdG9yYWdlU2F2ZUhpc3RvcnkocGF0aCwgYmFja1BhdGgsIGJhY2tQYXJhbXMpXHJcblxyXG4gICAgLy8g6Leo5bel56iL6Lez6L2sXHJcbiAgICBpZiAocGF0aCAmJiBwYXRoSW5kZXggPj0gMCkge1xyXG4gICAgICBsZXQgdXJsUGF0aCA9IHRoaXMuc3BsaWNlUGF0aChwYXRoLCBxdWVyeVBhcmFtcyk7XHJcbiAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gdXJsUGF0aDtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIHdpbmRvd1snTU9CSUxFX09SSUdJTl9CQUNLJ10gJiYgd2luZG93WydNT0JJTEVfT1JJR0lOX0JBQ0snXS5yZWZsdXNoT3JpZ2luR29iYWNrKCk7XHJcblxyXG4gICAgdGhpcy5yb3V0ZXIucHVzaCh7XHJcbiAgICAgIHBhdGg6IHBhdGgsXHJcbiAgICAgIHF1ZXJ5OiBxdWVyeVBhcmFtc1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlbW92ZVBhcmFtcyhwYXRoSW5kZXgsIHBhdGgpIHtcclxuICAgIGxldCBlbmQgPSBwYXRoLnNlYXJjaCgnXFxcXD8nKTtcclxuICAgIGlmIChlbmQgPSAtMSkge1xyXG4gICAgICBlbmQgPSBwYXRoLmxlbmd0aDtcclxuICAgIH1cclxuICAgIHJldHVybiBwYXRoLnNsaWNlKHBhdGhJbmRleCwgZW5kKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0c2Vzc2lvblN0b3JhZ2VTYXZlSGlzdG9yeUtleShwYXRoKSB7XHJcbiAgICBjb25zdCBwYXRoSW5kZXggPSBwYXRoLnNlYXJjaCgnL2FwcHMnKTtcclxuICAgIC8vIOi3qOmhtemdoui3s+i9rOemu+W8gFxyXG4gICAgaWYgKHBhdGggJiYgcGF0aEluZGV4ID49IDApIHtcclxuICAgICAgcmV0dXJuIHRoaXMucmVtb3ZlUGFyYW1zKHBhdGhJbmRleCwgcGF0aCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5yb3V0ZXIub3B0aW9ucy5oaXN0b3J5LmJhc2UgKyBwYXRoO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXNzaW9uU3RvcmFnZVNhdmVIaXN0b3J5KHBhdGgsIGJhY2tQYXRoLCBiYWNrUGFyYW1zKSB7XHJcbiAgICBjb25zdCBwYXRoSW5kZXggPSBwYXRoLnNlYXJjaCgnL2FwcHMnKTtcclxuXHJcbiAgICBjb25zdCBrZXkgPSB0aGlzLmdldHNlc3Npb25TdG9yYWdlU2F2ZUhpc3RvcnlLZXkocGF0aCk7XHJcbiAgICBsZXQgaGlzdG9yeU9iamVjdCA9IHt9XHJcbiAgICAvL+WIpOaWreaYr+WQpuWItuWumuS6huebruagh+mhtemdouW+l+i/lOWbnuWcsOWdgFxyXG4gICAgaWYgKGJhY2tQYXRoKSB7XHJcbiAgICAgIGNvbnN0IGJhY2tQYXRoSW5kZXggPSBwYXRoLnNlYXJjaCgnL2FwcHMnKTtcclxuICAgICAgLy/mjIflrprov5Tlm57ot6/nlLHkuLrot6jlt6XnqIvot7PovaxcclxuICAgICAgaWYgKGJhY2tQYXRoSW5kZXggPj0gMCkge1xyXG4gICAgICAgIGhpc3RvcnlPYmplY3QgPSB7XHJcbiAgICAgICAgICByb3V0ZXJXYXk6ICdocmVmJyxcclxuICAgICAgICAgIHBhdGg6IGJhY2tQYXRoLFxyXG4gICAgICAgICAgcXVlcnk6IGJhY2tQYXJhbXNcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaGlzdG9yeU9iamVjdCA9IHtcclxuICAgICAgICAgIHJvdXRlcldheTogJ1JvdXRlcicsXHJcbiAgICAgICAgICBwYXRoOiBiYWNrUGF0aCxcclxuICAgICAgICAgIHF1ZXJ5OiBiYWNrUGFyYW1zXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oa2V5LCBKU09OLnN0cmluZ2lmeShoaXN0b3J5T2JqZWN0KSlcclxuICAgICAgcmV0dXJuIHBhdGhJbmRleDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGxldCBjdXJyZW50UGF0aCA9IHRoaXMucm91dGVyLmN1cnJlbnRSb3V0ZS52YWx1ZS5wYXRoO1xyXG4gICAgICAvLyDot6jpobXpnaLot7PovaznprvlvIBcclxuICAgICAgaWYgKHBhdGggJiYgcGF0aEluZGV4ID49IDApIHtcclxuICAgICAgICAvL+aLvOaOpeW9k+WJjei3r+eUsVxyXG4gICAgICAgIGN1cnJlbnRQYXRoID0gIHRoaXMucm91dGVyLm9wdGlvbnMuaGlzdG9yeS5iYXNlICsgdGhpcy5yb3V0ZXIub3B0aW9ucy5oaXN0b3J5LmxvY2F0aW9uO1xyXG4gICAgICAgIC8v6K6w5b2V5b2T5YmN6Lev55SxXHJcbiAgICAgICAgaGlzdG9yeU9iamVjdCA9IHtcclxuICAgICAgICAgIHJvdXRlcldheTogJ2hyZWYnLFxyXG4gICAgICAgICAgcGF0aDogY3VycmVudFBhdGgsXHJcbiAgICAgICAgICBxdWVyeTogYmFja1BhcmFtc1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyDot6/nlLHmlrnlvI/ot7PovazorrDlvZVcclxuICAgICAgICBoaXN0b3J5T2JqZWN0ID0ge1xyXG4gICAgICAgICAgcm91dGVyV2F5OiAnUm91dGVyJyxcclxuICAgICAgICAgIHBhdGg6IGN1cnJlbnRQYXRoLFxyXG4gICAgICAgICAgcXVlcnk6IGJhY2tQYXJhbXNcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShrZXksIEpTT04uc3RyaW5naWZ5KGhpc3RvcnlPYmplY3QpKVxyXG4gICAgICByZXR1cm4gcGF0aEluZGV4O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bim57u05bqm55qE6Lev55Sx6Lez6L2sXHJcbiAgICovXHJcbiAgbmF2aWdhdGVGb3JSdGMocGF0aDogc3RyaW5nLCBxdWVyeVBhcmFtczogYW55ID0ge30sIGJhY2tQYXJhbXM6IGFueSA9IHt9LCBiYWNrUGF0aD86IHN0cmluZykge1xyXG5cclxuICAgIGlmICghcXVlcnlQYXJhbXMgfHwgIXF1ZXJ5UGFyYW1zLm1ldGFkYXRhSWQpIHtcclxuICAgICAgdGhpcy5uYXZpZ2F0ZShwYXRoLCBxdWVyeVBhcmFtcywgYmFja1BhcmFtcywgYmFja1BhdGgpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHJ0Y09wdGlvbnM6IFJ0Y09wdGlvbnMgPSB7XHJcbiAgICAgIG1ldGFkYXRhSWQ6IHF1ZXJ5UGFyYW1zLm1ldGFkYXRhSWQsXHJcbiAgICAgIHdpdGhEaW1zOiBmYWxzZSxcclxuICAgICAgZGltMTogcXVlcnlQYXJhbXMuZGltMSxcclxuICAgICAgZGltMjogcXVlcnlQYXJhbXMuZGltMlxyXG4gICAgfTtcclxuICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1snbWV0YWRhdGFJZCddO1xyXG4gICAgZGVsZXRlIHF1ZXJ5UGFyYW1zWydkaW0xJ107XHJcbiAgICBkZWxldGUgcXVlcnlQYXJhbXNbJ2RpbTInXTtcclxuXHJcbiAgICBjb25zdCBjb3JyZWN0UnRjT3B0aW9ucyQgPSB0aGlzLmNvcnJlY3RSdGNPcHRpb25zKHJ0Y09wdGlvbnMpO1xyXG4gICAgY29uc3QgZXh0ZW5kZWRQYXRoJCA9IGNvcnJlY3RSdGNPcHRpb25zJC5waXBlKFxyXG4gICAgICBtYXAoKGNvcnJlY3RlZFJ0Y09wdGlvbnM6IFJ0Y09wdGlvbnMpID0+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRFeHRlbmRQYXRoKHBhdGgsIGNvcnJlY3RlZFJ0Y09wdGlvbnMpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICBjb25zdCByZXN1bHQkID0gZXh0ZW5kZWRQYXRoJC5waXBlKFxyXG4gICAgICB0YXAoKGV4dGVuZGVkUGF0aDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgdGhpcy5uYXZpZ2F0ZShleHRlbmRlZFBhdGgsIHF1ZXJ5UGFyYW1zLCBiYWNrUGFyYW1zKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcblxyXG4gICAgcmVzdWx0JC5zdWJzY3JpYmUoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOe6oOato+e7tOW6puS/oeaBr1xyXG4gICAqIEBzdW1tYXJ5XHJcbiAgICogMeOAgemdnui/kOihjOaXtuWumuWItuihqOWNle+8jHdpZHRoRGltcz1mYWxzZSwg57u05bqm5Li656m677ybXHJcbiAgICogMuOAgei/kOihjOaXtuWumuWItuihqOWNle+8mue7tOW6puWAvOS4jeWtmOWcqOaXtu+8jOWImee6oOato+S4unB1YmxpY++8m1xyXG4gICAqL1xyXG4gIHByaXZhdGUgY29ycmVjdFJ0Y09wdGlvbnMocnRjT3B0aW9uczogUnRjT3B0aW9ucyk6IE9ic2VydmFibGU8UnRjT3B0aW9ucz4ge1xyXG4gICAgY29uc3QgZGltMSA9IHJ0Y09wdGlvbnMuZGltMSB8fCAncHVibGljJztcclxuICAgIGNvbnN0IGRpbTIgPSBydGNPcHRpb25zLmRpbTIgfHwgJ3B1YmxpYyc7XHJcbiAgICBjb25zdCBtZXRhZGF0YUlkID0gcnRjT3B0aW9ucy5tZXRhZGF0YUlkO1xyXG4gICAgY29uc3QgaHR0cENsaWVudCA9IHRoaXMudmlld01vZGVsQ29udGV4dC5pbmplY3Rvci5nZXQ8SHR0cENsaWVudD4oSHR0cENsaWVudCk7XHJcblxyXG4gICAgY29uc3QgdXJsID0gJy9hcGkvcnVudGltZS9iY2MvdjEuMC90ZW1wbGF0ZS9iZWZvcmVOYXZpZ2F0ZSc7XHJcbiAgICBjb25zdCBib2R5OiBCZWZvcmVOYXZpZ2F0ZVJlcXVlc3RCb2R5ID0ge1xyXG4gICAgICAgIGlzUm9vdE1ldGFkYXRhOiB0cnVlLFxyXG4gICAgICAgIG1ldGFkYXRhSWQ6IG1ldGFkYXRhSWQsXHJcbiAgICAgICAgZGltMTogZGltMSxcclxuICAgICAgICBkaW0yOiBkaW0yLFxyXG4gICAgfTtcclxuICAgIGNvbnN0IGJlZm9yZU5hdmlnYXRlJCA9IGh0dHBDbGllbnQucG9zdCh1cmwsIGJvZHksIG51bGwpLnBpcGUoXHJcbiAgICAgIG1hcCgocmVzdWx0OiBCZWZvcmVOYXZpZ2F0ZVJlcG9uc2VCb2R5KSA9PiB7XHJcbiAgICAgICAgY29uc3QgY29ycmVjdGVkUnRjT3B0aW9uczogUnRjT3B0aW9ucyA9IHtcclxuICAgICAgICAgIG1ldGFkYXRhSWQ6IHJlc3VsdC5tZXRhZGF0YUlkLFxyXG4gICAgICAgICAgd2l0aERpbXM6IHJlc3VsdC53aXRoRGltcyA9PT0gMSA/IHRydWUgOiBmYWxzZSxcclxuICAgICAgICAgIGRpbTE6IHJlc3VsdC5kaW0xLFxyXG4gICAgICAgICAgZGltMjogcmVzdWx0LmRpbTJcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICByZXR1cm4gY29ycmVjdGVkUnRjT3B0aW9ucztcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgICByZXR1cm4gYmVmb3JlTmF2aWdhdGUkO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W6L+Q6KGM5pe25a6a5Yi26KGo5Y2V5Zyw5Z2AXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRFeHRlbmRQYXRoKHBhdGg6IHN0cmluZywgcnRjT3B0aW9uczogUnRjT3B0aW9ucyk6IHN0cmluZyB7XHJcblxyXG4gICAgaWYgKHJ0Y09wdGlvbnMud2l0aERpbXMgPT09IGZhbHNlKSB7XHJcbiAgICAgIHJldHVybiBwYXRoO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGFyclBhdGggPSBwYXRoLnNwbGl0KCdpbmRleC5odG1sJyk7XHJcbiAgICBjb25zdCBhcHBlbmQgPSBgJHtydGNPcHRpb25zLmRpbTF9LyR7cnRjT3B0aW9ucy5kaW0yfS9pbmRleC5odG1sYC50b0xvd2VyQ2FzZSgpO1xyXG4gICAgY29uc3QgZXh0ZW5kUGF0aCA9IGFyclBhdGguam9pbihhcHBlbmQpO1xyXG4gICAgcmV0dXJuIGV4dGVuZFBhdGg7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmi7zmjqV1cmzot6/lvoRcclxuICAgKiBAcGFyYW0gcGF0aCDot6/lvoRcclxuICAgKiBAcGFyYW0gcGFyYW1zIOWPguaVsFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3BsaWNlUGF0aChwYXRoOiBzdHJpbmcsIHBhcmFtczogYW55KSB7XHJcbiAgICBsZXQgdXJsUGF0aCA9IHBhdGhcclxuICAgIGNvbnN0IGVuZCA9IHVybFBhdGguc2VhcmNoKCdcXFxcPycpO1xyXG4gICAgaWYgKGVuZCA+IC0xKSB7XHJcbiAgICAgIHVybFBhdGggPSB1cmxQYXRoLnNsaWNlKDAsIGVuZClcclxuICAgIH1cclxuICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhwYXJhbXMpO1xyXG4gICAgaWYgKGtleXMubGVuZ3RoID4gMCkge1xyXG4gICAgICB1cmxQYXRoID0gdXJsUGF0aCArICc/JztcclxuICAgICAga2V5cy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xyXG4gICAgICAgIHVybFBhdGggPSB1cmxQYXRoICsgZWxlbWVudCArICc9JyArIHBhcmFtc1tgJHtlbGVtZW50fWBdICsgJyYnXHJcbiAgICAgIH0pO1xyXG4gICAgICB1cmxQYXRoID0gdXJsUGF0aC5zbGljZSgwLCB1cmxQYXRoLmxlbmd0aCAtIDEpXHJcbiAgICB9XHJcbiAgICByZXR1cm4gdXJsUGF0aDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgUGFyYW1zRnJvbVN0cmluZ1RvT2JqZWN0KHBhcmFtczogYW55KTogb2JqZWN0IHtcclxuXHJcbiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHBhcmFtcykgPT09ICdbb2JqZWN0IE9iamVjdF0nKSB7XHJcbiAgICAgIHJldHVybiBwYXJhbXM7XHJcbiAgICB9XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgcGFyYW1zID0gSlNPTi5wYXJzZShwYXJhbXMpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgaWYgKCFwYXJhbXMpIHtcclxuICAgICAgICBwYXJhbXMgPSB7fVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHBhcmFtcyA9IHt9XHJcbiAgICAgICAgY29uc29sZS5lcnJvcign6Lev55Sx5Lyg5Y+CcGFyYW1z5LiN5pivSlNPTuS4suagvOW8jycpXHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHBhcmFtcykgIT09ICdbb2JqZWN0IE9iamVjdF0nKSB7XHJcbiAgICAgIHJldHVybiB7fTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcGFyYW1zO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAqIOi3r+eUsei3s+i9rFxyXG4gKiBAcGFyYW0gcGF0aCAgIOi3r+eUsei3r+W+hFxyXG4gKiBAcGFyYW0gcGFyYW1zIOi3r+eUseWPguaVsFxyXG4gKi9cclxuICBuYXZpZ2F0ZVJlcGxhY2UocGF0aDogc3RyaW5nLCBxdWVyeVBhcmFtczogYW55ID0ge30pIHtcclxuICAgIGlmICh0eXBlb2YgcXVlcnlQYXJhbXMgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgIHF1ZXJ5UGFyYW1zID0gSlNPTi5wYXJzZShxdWVyeVBhcmFtcyk7XHJcbiAgICB9XHJcbiAgICB0aGlzLnJvdXRlci5yZXBsYWNlKHtcclxuICAgICAgcGF0aDogcGF0aCxcclxuICAgICAgcXVlcnk6IHF1ZXJ5UGFyYW1zXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWQjumAgFxyXG4gICAqL1xyXG4gIGdvQmFjayhwYXJhbXMpIHtcclxuICAgIHBhcmFtcyA9IHRoaXMuUGFyYW1zRnJvbVN0cmluZ1RvT2JqZWN0KHBhcmFtcyk7XHJcbiAgICBjb25zdCBjdXJyZW50UGF0aCA9IHRoaXMucm91dGVyLm9wdGlvbnMuaGlzdG9yeS5iYXNlICsgdGhpcy5yb3V0ZXIuY3VycmVudFJvdXRlLnZhbHVlLnBhdGg7XHJcbiAgICBsZXQgbmVlZF9nb19iYWNrID0gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShjdXJyZW50UGF0aCk7XHJcbiAgICBpZiAoIW5lZWRfZ29fYmFjaykge1xyXG4gICAgICBpZiAod2luZG93LnRvcC5sb2NhdGlvbi5wYXRobmFtZS5pbmRleE9mKCdtb2JpbGV0YXNrY2VudGVyJykgPiAtMSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLmpzQnJpZGdlU2VydmljZS5jbG9zZVdpbmRvdygpXHJcbiAgICAgIHJldHVyblxyXG4gICAgfVxyXG4gICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHBhcmFtcyk7XHJcblxyXG4gICAgbmVlZF9nb19iYWNrID0gSlNPTi5wYXJzZShuZWVkX2dvX2JhY2spO1xyXG4gICAgaWYgKG5lZWRfZ29fYmFjayAmJiBuZWVkX2dvX2JhY2tbJ3JvdXRlcldheSddID09PSAnUm91dGVyJykge1xyXG4gICAgICBsZXQgcXVlcnkgPSBuZWVkX2dvX2JhY2tbJ3F1ZXJ5J107XHJcbiAgICAgIGlmIChrZXlzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBxdWVyeSA9IHsgLi4ucXVlcnksIC4uLnBhcmFtcyB9XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5yb3V0ZXIucHVzaCh7XHJcbiAgICAgICAgcXVlcnksXHJcbiAgICAgICAgcGF0aDogbmVlZF9nb19iYWNrWydwYXRoJ10sXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKG5lZWRfZ29fYmFjayAmJiBuZWVkX2dvX2JhY2tbJ3JvdXRlcldheSddID09PSAnaHJlZicpIHtcclxuICAgICAgbGV0IHF1ZXJ5ID0gbmVlZF9nb19iYWNrWydxdWVyeSddO1xyXG4gICAgICBpZiAoa2V5cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgcXVlcnkgPSB7IC4uLnF1ZXJ5LCAuLi5wYXJhbXMgfVxyXG4gICAgICB9XHJcbiAgICAgIGxldCBwYXRoID0gbmVlZF9nb19iYWNrWydwYXRoJ107XHJcblxyXG4gICAgICBwYXRoID0gdGhpcy5zcGxpY2VQYXRoKHBhdGgsIHF1ZXJ5KTtcclxuXHJcbiAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gcGF0aDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaYoOWwhOi3r+eUseeKtuaAgVxyXG4gICAqL1xyXG4gIG1hcHBpbmdUb1VJU3RhdGUoKSB7XHJcbiAgICBjb25zdCByb3V0ZXJTdGF0ZSA9IHtcclxuICAgICAgcGFyYW1zOiB0aGlzLnJvdXRlci5jdXJyZW50Um91dGVbJ3ZhbHVlJ10ucGFyYW1zLFxyXG4gICAgICBxdWVyeVBhcmFtczogdGhpcy5yb3V0ZXIuY3VycmVudFJvdXRlWyd2YWx1ZSddLnF1ZXJ5XHJcbiAgICB9O1xyXG4gICAgdGhpcy52aWV3TW9kZWxDb250ZXh0LnVpU3RhdGVbJ3JvdXRlclN0YXRlJ10gPSByb3V0ZXJTdGF0ZTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBUb2tlblxyXG4gKiBAdG9kb++8muS4tOaXtuaWueahiO+8jOebtOaOpeazqOWFpVZ1ZVJvdXRlcuWunuS+i+OAglxyXG4gKi9cclxuY29uc3QgUk9VVEVSX0lOU1RBTkNFX1RPS0VOID0gJ0BmYXJyaXMvbW9iaWxlLWNvbW1hbmQtc2VydmljZXMvUk9VVEVSX0lOU1RBTkNFX1RPS0VOJztcclxuXHJcbmV4cG9ydCB7IFJvdXRlclNlcnZpY2UsIFJPVVRFUl9JTlNUQU5DRV9UT0tFTiB9O1xyXG4iXX0=