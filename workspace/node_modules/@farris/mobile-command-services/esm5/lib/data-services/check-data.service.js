/**
 * @fileoverview added by tsickle
 * Generated from: lib/data-services/check-data.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { of, EMPTY } from 'rxjs';
import { switchMap, tap } from 'rxjs/operators';
import { BaseDataService } from './base-data.service';
import { DataUtil } from './data-util';
import { BefRepositoryUtil } from '@farris/mobile-bef';
import { HttpMethods } from '@farris/mobile-devkit';
/**
 * 数据检查服务
 */
var /**
 * 数据检查服务
 */
CheckDataService = /** @class */ (function (_super) {
    tslib_1.__extends(CheckDataService, _super);
    function CheckDataService(viewModelContext) {
        return _super.call(this, viewModelContext) || this;
    }
    /**
     * 离开页面前检查数据变更
     */
    /**
     * 离开页面前检查数据变更
     * @return {?}
     */
    CheckDataService.prototype.checkChangesBeforeLeave = /**
     * 离开页面前检查数据变更
     * @return {?}
     */
    function () {
        //const isEntitiesChanged = this.befRepository.entityManager.checkAllEntityChanges();
        var _this = this;
        // 实体数据没有变化，继续执行
        if (!BefRepositoryUtil.isExistUnsaveData(this.befRepository)) {
            return of(true);
        }
        return this.dialogService.confirm('存在未保存的变更，确认离开当前页面？').pipe(switchMap((/**
         * @param {?} ifLeave
         * @return {?}
         */
        function (ifLeave) {
            if (ifLeave === false) {
                return EMPTY;
            }
            else {
                _this.loadingService.show();
                /** @type {?} */
                var cancel$ = _this.befRepository.cancelEntityChanges();
                return cancel$.pipe(switchMap((/**
                 * @return {?}
                 */
                function () {
                    if (_this.befRepository.apiProxy.associatedUrlMap.size >= 1) {
                        /** @type {?} */
                        var urls = tslib_1.__spread(_this.befRepository.apiProxy.associatedUrlMap.keys());
                        return _this.befRepository.apiProxy.request(HttpMethods.POST, urls[0] + "/service/cancel");
                    }
                    else {
                        return of(true);
                    }
                })), tap((/**
                 * @return {?}
                 */
                function () {
                    _this.loadingService.hide();
                })));
            }
        })));
    };
    /**
     * 子表离开页面前检查数据变更
     */
    /**
     * 子表离开页面前检查数据变更
     * @return {?}
     */
    CheckDataService.prototype.checkChangesBeforeLeaveChild = /**
     * 子表离开页面前检查数据变更
     * @return {?}
     */
    function () {
        // 新增状态
        if (this.viewModelContext.uiState['$isAdd'] && this.viewModelContext.uiState['$isAdd'].status === true) {
            // 继续判断
            /** @type {?} */
            var childId = this.viewModelContext.uiState['$isAdd'].id;
            /** @type {?} */
            var childPath = this.viewModelContext.uiState['$isAdd'].path;
            /** @type {?} */
            var child = this.viewModelContext.uiState['$isAdd'].child;
            /** @type {?} */
            var subPaths = childPath.split('/');
            /** @type {?} */
            var currentChild = void 0;
            if (subPaths[0] && subPaths.length === 1) {
                currentChild = this.viewModelContext.bindingData[subPaths[0]];
            }
            if (!subPaths[0] && subPaths.length === 2) {
                currentChild = this.viewModelContext.bindingData[subPaths[1]];
            }
            if (subPaths.length > 2) {
                // 暂不处理从从表
                /** @type {?} */
                var childPath_1 = '';
                if (subPaths[0]) {
                    childPath_1 = subPaths[0];
                }
                for (var index = 1; index < subPaths.length; index++) {
                    childPath_1 = childPath_1 + subPaths[index];
                }
                currentChild = this.viewModelContext.bindingData[childPath_1];
            }
            /** @type {?} */
            var isChanged = this.checkForVariationBetweenTheTwo(currentChild, child);
            if (isChanged) {
                return of(true);
            }
            /** @type {?} */
            var entityPath = DataUtil.convertBindingPathToEntityPath(childPath, this.viewModelContext);
            return this.befRepository.removeEntityByPath(entityPath, childId);
        }
        return of(true);
    };
    /**
     * @private
     * @param {?} newData
     * @param {?} oldData
     * @return {?}
     */
    CheckDataService.prototype.checkForVariationBetweenTheTwo = /**
     * @private
     * @param {?} newData
     * @param {?} oldData
     * @return {?}
     */
    function (newData, oldData) {
        /** @type {?} */
        var childKeys = Object.keys(oldData);
        /** @type {?} */
        var isChanged = false;
        for (var i = 0; i < childKeys.length; i++) {
            if (Object.prototype.toString.call(oldData[childKeys[i]]) === '[object Object]' || Object.prototype.toString.call(oldData[childKeys[i]]) === '[object Array]') {
                if (JSON.stringify(oldData[childKeys[i]]) !== JSON.stringify(newData[childKeys[i]])) {
                    return isChanged = true;
                }
            }
            else {
                if (oldData[childKeys[i]] !== newData[childKeys[i]]) {
                    return isChanged = true;
                }
            }
        }
        return isChanged;
    };
    /**
     * 进入子表编辑或者新增点击返回都会复原进入子表前的数据
     * @param path 子表路径
     */
    /**
     * 进入子表编辑或者新增点击返回都会复原进入子表前的数据
     * @param {?} path 子表路径
     * @return {?}
     */
    CheckDataService.prototype.checkChangesBeforeLeaveAddOrEditChild = /**
     * 进入子表编辑或者新增点击返回都会复原进入子表前的数据
     * @param {?} path 子表路径
     * @return {?}
     */
    function (path) {
        var _this = this;
        // 新增状态
        if (this.viewModelContext.uiState['$isAdd'] && this.viewModelContext.uiState['$isAdd'].status === true) {
            // 新增直接干掉
            /** @type {?} */
            var childId = this.viewModelContext.uiState['$isAdd'].id;
            /** @type {?} */
            var childPath = this.viewModelContext.uiState['$isAdd'].path;
            /** @type {?} */
            var entityPath = DataUtil.convertBindingPathToEntityPath(childPath, this.viewModelContext);
            return this.befRepository.removeEntityByPath(entityPath, childId).pipe(tap((/**
             * @return {?}
             */
            function () {
                _this.viewModelContext.uiState.setPropertyValue('$isAdd', null);
            })));
        }
        else {
            // 编辑还原
            /** @type {?} */
            var childID = this.viewModelContext.bindingData[path]['id'];
            /** @type {?} */
            var id = this.viewModelContext.bindingData[path]['parentID'];
            /** @type {?} */
            var childEntityData = this.viewModelContext.uiState['$childEntity'];
            if (!childEntityData) {
                return of(true);
            }
            this.viewModelContext.repository.entityCollection.getEntityById(id)[path].get(childID).load(childEntityData);
            return of(true);
        }
    };
    return CheckDataService;
}(BaseDataService));
export { CheckDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2stZGF0YS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9kYXRhLXNlcnZpY2VzL2NoZWNrLWRhdGEuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxPQUFPLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqQyxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLG9CQUFvQixDQUFBO0FBQ3RELE9BQU8sRUFBRSxXQUFXLEVBQW9CLE1BQU0sdUJBQXVCLENBQUM7Ozs7QUFNdEU7Ozs7SUFBK0IsNENBQWU7SUFFNUMsMEJBQVksZ0JBQWtDO2VBQzVDLGtCQUFNLGdCQUFnQixDQUFDO0lBQ3pCLENBQUM7SUFFRDs7T0FFRzs7Ozs7SUFDSSxrREFBdUI7Ozs7SUFBOUI7UUFFRSxxRkFBcUY7UUFGdkYsaUJBZ0NDO1FBNUJDLGdCQUFnQjtRQUNoQixJQUFJLENBQUMsaUJBQWlCLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFO1lBQzVELE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2pCO1FBRUQsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLElBQUksQ0FDMUQsU0FBUzs7OztRQUFDLFVBQUMsT0FBWTtZQUNyQixJQUFJLE9BQU8sS0FBSyxLQUFLLEVBQUU7Z0JBQ3JCLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7aUJBQU07Z0JBQ0wsS0FBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsQ0FBQzs7b0JBQ3JCLE9BQU8sR0FBRyxLQUFJLENBQUMsYUFBYSxDQUFDLG1CQUFtQixFQUFFO2dCQUN4RCxPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQ2pCLFNBQVM7OztnQkFBQztvQkFDUixJQUFJLEtBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLElBQUksSUFBSSxDQUFDLEVBQUU7OzRCQUNwRCxJQUFJLG9CQUFPLEtBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxDQUFDO3dCQUNyRSxPQUFPLEtBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsb0JBQWlCLENBQUMsQ0FBQTtxQkFDMUY7eUJBQU07d0JBQ0wsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUE7cUJBQ2hCO2dCQUNILENBQUMsRUFBQyxFQUNGLEdBQUc7OztnQkFBQztvQkFDRixLQUFJLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUM3QixDQUFDLEVBQUMsQ0FDSCxDQUFDO2FBQ0g7UUFDSCxDQUFDLEVBQ0EsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVEOztPQUVHOzs7OztJQUNJLHVEQUE0Qjs7OztJQUFuQztRQUNFLE9BQU87UUFDUCxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLEtBQUssSUFBSSxFQUFFOzs7Z0JBRWhHLE9BQU8sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUU7O2dCQUNwRCxTQUFTLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJOztnQkFDeEQsS0FBSyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSzs7Z0JBQ3JELFFBQVEsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQzs7Z0JBQ2pDLFlBQVksU0FBQTtZQUNoQixJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtnQkFDeEMsWUFBWSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7YUFDOUQ7WUFDRCxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUN6QyxZQUFZLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTthQUM5RDtZQUNELElBQUksUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7OztvQkFFbkIsV0FBUyxHQUFHLEVBQUU7Z0JBQ2xCLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFO29CQUNmLFdBQVMsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQ3pCO2dCQUNELEtBQUssSUFBSSxLQUFLLEdBQUcsQ0FBQyxFQUFFLEtBQUssR0FBRyxRQUFRLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxFQUFFO29CQUNwRCxXQUFTLEdBQUcsV0FBUyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtpQkFDeEM7Z0JBQ0QsWUFBWSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsV0FBUyxDQUFDLENBQUE7YUFDNUQ7O2dCQUNLLFNBQVMsR0FBRyxJQUFJLENBQUMsOEJBQThCLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQztZQUMxRSxJQUFJLFNBQVMsRUFBRTtnQkFDYixPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQTthQUNoQjs7Z0JBQ0ssVUFBVSxHQUFHLFFBQVEsQ0FBQyw4QkFBOEIsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDO1lBQzVGLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDbkU7UUFDRCxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUNqQixDQUFDOzs7Ozs7O0lBRU8seURBQThCOzs7Ozs7SUFBdEMsVUFBdUMsT0FBTyxFQUFFLE9BQU87O1lBQy9DLFNBQVMsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQzs7WUFDbEMsU0FBUyxHQUFHLEtBQUs7UUFDckIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDekMsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssaUJBQWlCLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLGdCQUFnQixFQUFFO2dCQUM3SixJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRTtvQkFDbkYsT0FBTyxTQUFTLEdBQUcsSUFBSSxDQUFBO2lCQUN4QjthQUNGO2lCQUFNO2dCQUNMLElBQUksT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRTtvQkFDbkQsT0FBTyxTQUFTLEdBQUcsSUFBSSxDQUFBO2lCQUN4QjthQUNGO1NBQ0Y7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBRUQ7OztPQUdHOzs7Ozs7SUFDSSxnRUFBcUM7Ozs7O0lBQTVDLFVBQTZDLElBQVk7UUFBekQsaUJBc0JDO1FBckJDLE9BQU87UUFDUCxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLEtBQUssSUFBSSxFQUFFOzs7Z0JBRWhHLE9BQU8sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUU7O2dCQUNwRCxTQUFTLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJOztnQkFDeEQsVUFBVSxHQUFHLFFBQVEsQ0FBQyw4QkFBOEIsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDO1lBQzVGLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUNwRSxHQUFHOzs7WUFBQztnQkFDRixLQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUNqRSxDQUFDLEVBQUMsQ0FBQyxDQUFDO1NBQ1A7YUFBTTs7O2dCQUVDLE9BQU8sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQzs7Z0JBQ3ZELEVBQUUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLFVBQVUsQ0FBQzs7Z0JBQ3hELGVBQWUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQztZQUNyRSxJQUFJLENBQUMsZUFBZSxFQUFFO2dCQUNwQixPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQTthQUNoQjtZQUNELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDN0csT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUE7U0FDaEI7SUFDSCxDQUFDO0lBQ0gsdUJBQUM7QUFBRCxDQUFDLEFBOUhELENBQStCLGVBQWUsR0E4SDdDO0FBRUQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBvZiwgRU1QVFkgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgc3dpdGNoTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEJhc2VEYXRhU2VydmljZSB9IGZyb20gJy4vYmFzZS1kYXRhLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBEYXRhVXRpbCB9IGZyb20gJy4vZGF0YS11dGlsJztcclxuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeVV0aWwgfSBmcm9tICdAZmFycmlzL21vYmlsZS1iZWYnXHJcbmltcG9ydCB7IEh0dHBNZXRob2RzLCBWaWV3TW9kZWxDb250ZXh0IH0gZnJvbSAnQGZhcnJpcy9tb2JpbGUtZGV2a2l0JztcclxuXHJcblxyXG4vKipcclxuICog5pWw5o2u5qOA5p+l5pyN5YqhXHJcbiAqL1xyXG5jbGFzcyBDaGVja0RhdGFTZXJ2aWNlIGV4dGVuZHMgQmFzZURhdGFTZXJ2aWNlIHtcclxuXHJcbiAgY29uc3RydWN0b3Iodmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dCkge1xyXG4gICAgc3VwZXIodmlld01vZGVsQ29udGV4dClcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOemu+W8gOmhtemdouWJjeajgOafpeaVsOaNruWPmOabtFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjaGVja0NoYW5nZXNCZWZvcmVMZWF2ZSgpIHtcclxuXHJcbiAgICAvL2NvbnN0IGlzRW50aXRpZXNDaGFuZ2VkID0gdGhpcy5iZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIuY2hlY2tBbGxFbnRpdHlDaGFuZ2VzKCk7XHJcblxyXG4gICAgLy8g5a6e5L2T5pWw5o2u5rKh5pyJ5Y+Y5YyW77yM57un57ut5omn6KGMXHJcbiAgICBpZiAoIUJlZlJlcG9zaXRvcnlVdGlsLmlzRXhpc3RVbnNhdmVEYXRhKHRoaXMuYmVmUmVwb3NpdG9yeSkpIHtcclxuICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0aGlzLmRpYWxvZ1NlcnZpY2UuY29uZmlybSgn5a2Y5Zyo5pyq5L+d5a2Y55qE5Y+Y5pu077yM56Gu6K6k56a75byA5b2T5YmN6aG16Z2i77yfJykucGlwZShcclxuICAgICAgc3dpdGNoTWFwKChpZkxlYXZlOiBhbnkpID0+IHtcclxuICAgICAgICBpZiAoaWZMZWF2ZSA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KCk7XHJcbiAgICAgICAgICBjb25zdCBjYW5jZWwkID0gdGhpcy5iZWZSZXBvc2l0b3J5LmNhbmNlbEVudGl0eUNoYW5nZXMoKTtcclxuICAgICAgICAgIHJldHVybiBjYW5jZWwkLnBpcGUoXHJcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgaWYgKHRoaXMuYmVmUmVwb3NpdG9yeS5hcGlQcm94eS5hc3NvY2lhdGVkVXJsTWFwLnNpemUgPj0gMSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdXJscyA9IFsuLi50aGlzLmJlZlJlcG9zaXRvcnkuYXBpUHJveHkuYXNzb2NpYXRlZFVybE1hcC5rZXlzKCldO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmVmUmVwb3NpdG9yeS5hcGlQcm94eS5yZXF1ZXN0KEh0dHBNZXRob2RzLlBPU1QsIGAke3VybHNbMF19L3NlcnZpY2UvY2FuY2VsYClcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9mKHRydWUpXHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgICkpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5a2Q6KGo56a75byA6aG16Z2i5YmN5qOA5p+l5pWw5o2u5Y+Y5pu0XHJcbiAgICovXHJcbiAgcHVibGljIGNoZWNrQ2hhbmdlc0JlZm9yZUxlYXZlQ2hpbGQoKSB7XHJcbiAgICAvLyDmlrDlop7nirbmgIFcclxuICAgIGlmICh0aGlzLnZpZXdNb2RlbENvbnRleHQudWlTdGF0ZVsnJGlzQWRkJ10gJiYgdGhpcy52aWV3TW9kZWxDb250ZXh0LnVpU3RhdGVbJyRpc0FkZCddLnN0YXR1cyA9PT0gdHJ1ZSkge1xyXG4gICAgICAvLyDnu6fnu63liKTmlq1cclxuICAgICAgY29uc3QgY2hpbGRJZCA9IHRoaXMudmlld01vZGVsQ29udGV4dC51aVN0YXRlWyckaXNBZGQnXS5pZDtcclxuICAgICAgY29uc3QgY2hpbGRQYXRoID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LnVpU3RhdGVbJyRpc0FkZCddLnBhdGg7XHJcbiAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LnVpU3RhdGVbJyRpc0FkZCddLmNoaWxkO1xyXG4gICAgICBjb25zdCBzdWJQYXRocyA9IGNoaWxkUGF0aC5zcGxpdCgnLycpO1xyXG4gICAgICBsZXQgY3VycmVudENoaWxkO1xyXG4gICAgICBpZiAoc3ViUGF0aHNbMF0gJiYgc3ViUGF0aHMubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgY3VycmVudENoaWxkID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LmJpbmRpbmdEYXRhW3N1YlBhdGhzWzBdXVxyXG4gICAgICB9XHJcbiAgICAgIGlmICghc3ViUGF0aHNbMF0gJiYgc3ViUGF0aHMubGVuZ3RoID09PSAyKSB7XHJcbiAgICAgICAgY3VycmVudENoaWxkID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LmJpbmRpbmdEYXRhW3N1YlBhdGhzWzFdXVxyXG4gICAgICB9XHJcbiAgICAgIGlmIChzdWJQYXRocy5sZW5ndGggPiAyKSB7XHJcbiAgICAgICAgLy8g5pqC5LiN5aSE55CG5LuO5LuO6KGoXHJcbiAgICAgICAgbGV0IGNoaWxkUGF0aCA9ICcnXHJcbiAgICAgICAgaWYgKHN1YlBhdGhzWzBdKSB7XHJcbiAgICAgICAgICBjaGlsZFBhdGggPSBzdWJQYXRoc1swXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yIChsZXQgaW5kZXggPSAxOyBpbmRleCA8IHN1YlBhdGhzLmxlbmd0aDsgaW5kZXgrKykge1xyXG4gICAgICAgICAgY2hpbGRQYXRoID0gY2hpbGRQYXRoICsgc3ViUGF0aHNbaW5kZXhdXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGN1cnJlbnRDaGlsZCA9IHRoaXMudmlld01vZGVsQ29udGV4dC5iaW5kaW5nRGF0YVtjaGlsZFBhdGhdXHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgaXNDaGFuZ2VkID0gdGhpcy5jaGVja0ZvclZhcmlhdGlvbkJldHdlZW5UaGVUd28oY3VycmVudENoaWxkLCBjaGlsZCk7XHJcbiAgICAgIGlmIChpc0NoYW5nZWQpIHtcclxuICAgICAgICByZXR1cm4gb2YodHJ1ZSlcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBlbnRpdHlQYXRoID0gRGF0YVV0aWwuY29udmVydEJpbmRpbmdQYXRoVG9FbnRpdHlQYXRoKGNoaWxkUGF0aCwgdGhpcy52aWV3TW9kZWxDb250ZXh0KTtcclxuICAgICAgcmV0dXJuIHRoaXMuYmVmUmVwb3NpdG9yeS5yZW1vdmVFbnRpdHlCeVBhdGgoZW50aXR5UGF0aCwgY2hpbGRJZCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gb2YodHJ1ZSlcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2hlY2tGb3JWYXJpYXRpb25CZXR3ZWVuVGhlVHdvKG5ld0RhdGEsIG9sZERhdGEpIHtcclxuICAgIGNvbnN0IGNoaWxkS2V5cyA9IE9iamVjdC5rZXlzKG9sZERhdGEpO1xyXG4gICAgbGV0IGlzQ2hhbmdlZCA9IGZhbHNlO1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZEtleXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvbGREYXRhW2NoaWxkS2V5c1tpXV0pID09PSAnW29iamVjdCBPYmplY3RdJyB8fCBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2xkRGF0YVtjaGlsZEtleXNbaV1dKSA9PT0gJ1tvYmplY3QgQXJyYXldJykge1xyXG4gICAgICAgIGlmIChKU09OLnN0cmluZ2lmeShvbGREYXRhW2NoaWxkS2V5c1tpXV0pICE9PSBKU09OLnN0cmluZ2lmeShuZXdEYXRhW2NoaWxkS2V5c1tpXV0pKSB7XHJcbiAgICAgICAgICByZXR1cm4gaXNDaGFuZ2VkID0gdHJ1ZVxyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAob2xkRGF0YVtjaGlsZEtleXNbaV1dICE9PSBuZXdEYXRhW2NoaWxkS2V5c1tpXV0pIHtcclxuICAgICAgICAgIHJldHVybiBpc0NoYW5nZWQgPSB0cnVlXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaXNDaGFuZ2VkO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6L+b5YWl5a2Q6KGo57yW6L6R5oiW6ICF5paw5aKe54K55Ye76L+U5Zue6YO95Lya5aSN5Y6f6L+b5YWl5a2Q6KGo5YmN55qE5pWw5o2uXHJcbiAgICogQHBhcmFtIHBhdGgg5a2Q6KGo6Lev5b6EXHJcbiAgICovXHJcbiAgcHVibGljIGNoZWNrQ2hhbmdlc0JlZm9yZUxlYXZlQWRkT3JFZGl0Q2hpbGQocGF0aDogc3RyaW5nKSB7XHJcbiAgICAvLyDmlrDlop7nirbmgIFcclxuICAgIGlmICh0aGlzLnZpZXdNb2RlbENvbnRleHQudWlTdGF0ZVsnJGlzQWRkJ10gJiYgdGhpcy52aWV3TW9kZWxDb250ZXh0LnVpU3RhdGVbJyRpc0FkZCddLnN0YXR1cyA9PT0gdHJ1ZSkge1xyXG4gICAgICAvLyDmlrDlop7nm7TmjqXlubLmjolcclxuICAgICAgY29uc3QgY2hpbGRJZCA9IHRoaXMudmlld01vZGVsQ29udGV4dC51aVN0YXRlWyckaXNBZGQnXS5pZDtcclxuICAgICAgY29uc3QgY2hpbGRQYXRoID0gdGhpcy52aWV3TW9kZWxDb250ZXh0LnVpU3RhdGVbJyRpc0FkZCddLnBhdGg7XHJcbiAgICAgIGNvbnN0IGVudGl0eVBhdGggPSBEYXRhVXRpbC5jb252ZXJ0QmluZGluZ1BhdGhUb0VudGl0eVBhdGgoY2hpbGRQYXRoLCB0aGlzLnZpZXdNb2RlbENvbnRleHQpO1xyXG4gICAgICByZXR1cm4gdGhpcy5iZWZSZXBvc2l0b3J5LnJlbW92ZUVudGl0eUJ5UGF0aChlbnRpdHlQYXRoLCBjaGlsZElkKS5waXBlKFxyXG4gICAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnZpZXdNb2RlbENvbnRleHQudWlTdGF0ZS5zZXRQcm9wZXJ0eVZhbHVlKCckaXNBZGQnLCBudWxsKTtcclxuICAgICAgICB9KSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyDnvJbovpHov5jljp9cclxuICAgICAgY29uc3QgY2hpbGRJRCA9IHRoaXMudmlld01vZGVsQ29udGV4dC5iaW5kaW5nRGF0YVtwYXRoXVsnaWQnXTtcclxuICAgICAgY29uc3QgaWQgPSB0aGlzLnZpZXdNb2RlbENvbnRleHQuYmluZGluZ0RhdGFbcGF0aF1bJ3BhcmVudElEJ107XHJcbiAgICAgIGNvbnN0IGNoaWxkRW50aXR5RGF0YSA9IHRoaXMudmlld01vZGVsQ29udGV4dC51aVN0YXRlWyckY2hpbGRFbnRpdHknXTtcclxuICAgICAgaWYgKCFjaGlsZEVudGl0eURhdGEpIHtcclxuICAgICAgICByZXR1cm4gb2YodHJ1ZSlcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnZpZXdNb2RlbENvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0eUJ5SWQoaWQpW3BhdGhdLmdldChjaGlsZElEKS5sb2FkKGNoaWxkRW50aXR5RGF0YSk7XHJcbiAgICAgIHJldHVybiBvZih0cnVlKVxyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgQ2hlY2tEYXRhU2VydmljZSB9O1xyXG4iXX0=