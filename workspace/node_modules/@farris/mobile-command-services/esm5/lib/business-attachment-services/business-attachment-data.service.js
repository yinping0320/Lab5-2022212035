/**
 * @fileoverview added by tsickle
 * Generated from: lib/business-attachment-services/business-attachment-data.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of } from 'rxjs';
import { map } from 'rxjs/operators';
import { HttpMethods, BindingPathConverter, HttpUtil } from '@farris/mobile-devkit';
import { BefDataPathUtil } from '@farris/mobile-bef';
import { AttachmentUtil } from './business-attachment.util';
/**
 * 附件数据服务
 */
var /**
 * 附件数据服务
 */
BusinessAttachmentDataService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function BusinessAttachmentDataService(viewModelContext) {
        this.viewModelContext = viewModelContext;
    }
    Object.defineProperty(BusinessAttachmentDataService.prototype, "befReposi", {
        /**
         * 实体仓库
         */
        get: /**
         * 实体仓库
         * @return {?}
         */
        function () {
            return (/** @type {?} */ (this.viewModelContext.repository));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BusinessAttachmentDataService.prototype, "bindingData", {
        /**
         * 绑定数据
         */
        get: /**
         * 绑定数据
         * @private
         * @return {?}
         */
        function () {
            return this.viewModelContext.bindingData;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    BusinessAttachmentDataService.prototype.getAllBeSessions = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var beSessionsJson = window.sessionStorage.getItem("BE_SESSION_ID");
        if (!beSessionsJson) {
            return {};
        }
        /** @type {?} */
        var frmSessionId = this.getUserSessionId();
        /** @type {?} */
        var beSessions = JSON.parse(beSessionsJson);
        /** @type {?} */
        var beSessionKey = frmSessionId + "_/api/gsp/common/v1.0/testForm_mfrm";
        return beSessions[beSessionKey];
    };
    /**
     * 获取用户SessionId
     */
    /**
     * 获取用户SessionId
     * @return {?}
     */
    BusinessAttachmentDataService.prototype.getUserSessionId = /**
     * 获取用户SessionId
     * @return {?}
     */
    function () {
        /** @type {?} */
        var userSessionId = window.localStorage.getItem("sessionId");
        return userSessionId;
    };
    /**
     * 扩展BeSessionId相关头信息
     */
    /**
     * 扩展BeSessionId相关头信息
     * @param {?} headers
     * @return {?}
     */
    BusinessAttachmentDataService.prototype.handleRequestHeaders = /**
     * 扩展BeSessionId相关头信息
     * @param {?} headers
     * @return {?}
     */
    function (headers) {
        /** @type {?} */
        var frmSessionId = this.getUserSessionId();
        /** @type {?} */
        var beSessionId = this.getAllBeSessions();
        if (frmSessionId) {
            headers = HttpUtil.appendHeader(headers, "X-CAF-Runtime-CommonVariable", frmSessionId);
        }
        if (beSessionId) {
            headers = HttpUtil.appendHeader(headers, "X-CAF-Runtime-Context", beSessionId);
            headers = HttpUtil.appendHeader(headers, "SessionId", beSessionId);
        }
        headers = HttpUtil.appendHeader(headers, 'Content-Type', 'application/json');
        return headers;
    };
    /**
     * @param {?} url
     * @return {?}
     */
    BusinessAttachmentDataService.prototype.extendQueryData = /**
     * @param {?} url
     * @return {?}
     */
    function (url) {
        /** @type {?} */
        var entityFilter = {
            FilterConditions: [],
            SortConditions: [],
            IsUsePagination: false,
            Pagination: {
                PageIndex: 1,
                PageSize: 5,
                PageCount: 0,
                TotalCount: 0
            }
        };
        /** @type {?} */
        var entityFilterString = JSON.stringify(entityFilter);
        /** @type {?} */
        var params = {
            entityFilter: entityFilterString
        };
        // const url = `/api/gsp/common/v1.0/attachmentform_mfrm/extension/query`;
        // 拓展header
        // const headers = this.handleRequestHeaders({});
        // 拓展body
        /** @type {?} */
        var requestConfig = { params: params };
        return this.befReposi.apiProxy.request(HttpMethods.PUT, url, requestConfig);
    };
    /**
     * 更新附件信息
     */
    /**
     * 更新附件信息
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfo
     * @return {?}
     */
    BusinessAttachmentDataService.prototype.updateRow = /**
     * 更新附件信息
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfo
     * @return {?}
     */
    function (attachmentInfoFieldPath, attachmentInfo) {
        /** @type {?} */
        var apiProxy = this.befReposi.apiProxy;
        /** @type {?} */
        var updateUrl = apiProxy.baseUrl + "/service/updateattachment";
        /** @type {?} */
        var serverAttachInfo = this.createUpdateAttachInfo(attachmentInfoFieldPath, attachmentInfo);
        /** @type {?} */
        var body = {
            updateAttachInfo: serverAttachInfo
        };
        /** @type {?} */
        var requestConfig = {
            body: body
        };
        return apiProxy.request(HttpMethods.PUT, updateUrl, requestConfig);
    };
    /**
     * 批量创建附件行数据
     */
    /**
     * 批量创建附件行数据
     * @param {?} updateUrl
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfos
     * @return {?}
     */
    BusinessAttachmentDataService.prototype.updateRows = /**
     * 批量创建附件行数据
     * @param {?} updateUrl
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfos
     * @return {?}
     */
    function (updateUrl, attachmentInfoFieldPath, attachmentInfos) {
        /** @type {?} */
        var apiProxy = this.befReposi.apiProxy;
        // const updateUrl = `${apiProxy.baseUrl}/service/batchuploadattachment`;
        /** @type {?} */
        var serverAttachInfo = this.createBatchCreateAttachInfo(attachmentInfoFieldPath, attachmentInfos);
        /** @type {?} */
        var isRootEntity = serverAttachInfo.NodeCodes.length === 0;
        /** @type {?} */
        var body = {
            batchUploadInfo: serverAttachInfo
        };
        /** @type {?} */
        var requestConfig = {
            body: body
        };
        return apiProxy.request(HttpMethods.PUT, updateUrl, requestConfig, true);
    };
    /**
     * 创建服务器端需要的更新信息
     */
    /**
     * 创建服务器端需要的更新信息
     * @private
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfo
     * @return {?}
     */
    BusinessAttachmentDataService.prototype.createUpdateAttachInfo = /**
     * 创建服务器端需要的更新信息
     * @private
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfo
     * @return {?}
     */
    function (attachmentInfoFieldPath, attachmentInfo) {
        /** @type {?} */
        var attachmentId = attachmentInfo.attachmentId;
        /** @type {?} */
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        /** @type {?} */
        var nodeCodes = BefDataPathUtil.convertToObjectCodes(parentBindingPathArray, this.bindingData);
        /** @type {?} */
        var hiretryIds = BefDataPathUtil.convertToDataIdsForUpdate(parentBindingPathArray, this.bindingData);
        /** @type {?} */
        var serverAttachInfo = {
            NodeCodes: nodeCodes,
            HiretryIds: hiretryIds,
            AttachmentIds: [attachmentId],
            AttachmentId: attachmentId
        };
        return serverAttachInfo;
    };
    /**
     * 创建服务器端需要的批量新增附件信息
     */
    /**
     * 创建服务器端需要的批量新增附件信息
     * @private
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfo
     * @return {?}
     */
    BusinessAttachmentDataService.prototype.createBatchCreateAttachInfo = /**
     * 创建服务器端需要的批量新增附件信息
     * @private
     * @param {?} attachmentInfoFieldPath
     * @param {?} attachmentInfo
     * @return {?}
     */
    function (attachmentInfoFieldPath, attachmentInfo) {
        /** @type {?} */
        var attachmentIds = AttachmentUtil.peekAttachmentIds(attachmentInfo);
        /** @type {?} */
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        /** @type {?} */
        var nodeCodes = BefDataPathUtil.convertToObjectCodes(parentBindingPathArray, this.bindingData);
        /** @type {?} */
        var hiretryIds = BefDataPathUtil.convertToDataIdsForAdd(parentBindingPathArray, this.bindingData);
        /** @type {?} */
        var serverAttachInfo = {
            NodeCodes: nodeCodes,
            HiretryIds: hiretryIds,
            AttachmentIds: attachmentIds,
            AttachmentId: null
        };
        return serverAttachInfo;
    };
    /**
     * 同步服务器端最新信息到客户端
     * @todo:
     * 1、主对象批量新增时不支持
     */
    /**
     * 同步服务器端最新信息到客户端
     * \@todo:
     * 1、主对象批量新增时不支持
     * @return {?}
     */
    BusinessAttachmentDataService.prototype.syncAttachmentInfosToClient = /**
     * 同步服务器端最新信息到客户端
     * \@todo:
     * 1、主对象批量新增时不支持
     * @return {?}
     */
    function () {
        /** @type {?} */
        var rootDataId = this.bindingData.list.currentId;
        return this.befReposi.updateEntityById(rootDataId);
    };
    /**
     * 追击主表数据到客户端
     */
    /**
     * 追击主表数据到客户端
     * @param {?} listData
     * @param {?} isRootEntity
     * @return {?}
     */
    BusinessAttachmentDataService.prototype.appendAttachmentInfosToClient = /**
     * 追击主表数据到客户端
     * @param {?} listData
     * @param {?} isRootEntity
     * @return {?}
     */
    function (listData, isRootEntity) {
        if (isRootEntity === true) {
            /** @type {?} */
            var entities = this.befReposi.buildEntities(listData);
            this.befReposi.entityCollection.addEntities(entities);
            return of(listData);
        }
        else {
            return this.syncAttachmentInfosToClient().pipe(map((/**
             * @return {?}
             */
            function () {
                return listData;
            })));
        }
    };
    return BusinessAttachmentDataService;
}());
if (false) {
    /**
     * ViewModel上下文
     * @type {?}
     */
    BusinessAttachmentDataService.prototype.viewModelContext;
}
export { BusinessAttachmentDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVzaW5lc3MtYXR0YWNobWVudC1kYXRhLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2J1c2luZXNzLWF0dGFjaG1lbnQtc2VydmljZXMvYnVzaW5lc3MtYXR0YWNobWVudC1kYXRhLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQWMsRUFBRSxFQUFTLE1BQU0sTUFBTSxDQUFDO0FBQzdDLE9BQU8sRUFBa0IsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckQsT0FBTyxFQUFxQixXQUFXLEVBQXlDLG9CQUFvQixFQUFFLFFBQVEsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzlJLE9BQU8sRUFBaUIsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFcEUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDRCQUE0QixDQUFDOzs7O0FBTTVEOzs7O0lBcUJFOztPQUVHO0lBQ0gsdUNBQVksZ0JBQWtDO1FBQzVDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztJQUMzQyxDQUFDO0lBaEJELHNCQUFXLG9EQUFTO1FBSHBCOztXQUVHOzs7OztRQUNIO1lBQ0UsT0FBTyxtQkFBQSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxFQUF5QixDQUFDO1FBQ25FLENBQUM7OztPQUFBO0lBS0Qsc0JBQVksc0RBQVc7UUFIdkI7O1dBRUc7Ozs7OztRQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDO1FBQzNDLENBQUM7OztPQUFBOzs7O0lBU0Qsd0RBQWdCOzs7SUFBaEI7O1lBQ1EsY0FBYyxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQztRQUNyRSxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ25CLE9BQU8sRUFBRSxDQUFDO1NBQ1g7O1lBQ0ss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OztJQXRNQyx5REFBMEM7O0FBd001QyxPQUFPLEVBQUUsNkJBQTZCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBFTVBUWSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YXAsIHN3aXRjaE1hcCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBIdHRwUmVxdWVzdENvbmZpZywgSHR0cE1ldGhvZHMsIEVudGl0eSwgVmlld01vZGVsQ29udGV4dCwgQmluZGluZ0RhdGEsIEJpbmRpbmdQYXRoQ29udmVydGVyLCBIdHRwVXRpbCB9IGZyb20gJ0BmYXJyaXMvbW9iaWxlLWRldmtpdCc7XHJcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnksIEJlZkRhdGFQYXRoVXRpbCB9IGZyb20gJ0BmYXJyaXMvbW9iaWxlLWJlZic7XHJcbmltcG9ydCB7IEJ1c2luZXNzQXR0YWNobWVudEluZm8sIEJ1c2luZXNzU2VydmVyQXR0YWNobWVudEluZm8gfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgQXR0YWNobWVudFV0aWwgfSBmcm9tICcuL2J1c2luZXNzLWF0dGFjaG1lbnQudXRpbCc7XHJcbmltcG9ydCB7IEJhc2VEYXRhU2VydmljZSB9IGZyb20gJy4uL2RhdGEtc2VydmljZXMnO1xyXG5cclxuLyoqXHJcbiAqIOmZhOS7tuaVsOaNruacjeWKoVxyXG4gKi9cclxuY2xhc3MgQnVzaW5lc3NBdHRhY2htZW50RGF0YVNlcnZpY2Uge1xyXG5cclxuICAvKipcclxuICAgKiBWaWV3TW9kZWzkuIrkuIvmlodcclxuICAgKi9cclxuICBwdWJsaWMgdmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dDtcclxuXHJcbiAgLyoqXHJcbiAgICog5a6e5L2T5LuT5bqTXHJcbiAgICovXHJcbiAgcHVibGljIGdldCBiZWZSZXBvc2koKTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+IHtcclxuICAgIHJldHVybiB0aGlzLnZpZXdNb2RlbENvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PEVudGl0eT47XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDnu5HlrprmlbDmja5cclxuICAgKi9cclxuICBwcml2YXRlIGdldCBiaW5kaW5nRGF0YSgpOiBCaW5kaW5nRGF0YSB7XHJcbiAgICByZXR1cm4gdGhpcy52aWV3TW9kZWxDb250ZXh0LmJpbmRpbmdEYXRhO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3Iodmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dCkge1xyXG4gICAgdGhpcy52aWV3TW9kZWxDb250ZXh0ID0gdmlld01vZGVsQ29udGV4dDtcclxuICB9XHJcblxyXG4gIGdldEFsbEJlU2Vzc2lvbnMoKSB7XHJcbiAgICBjb25zdCBiZVNlc3Npb25zSnNvbiA9IHdpbmRvdy5zZXNzaW9uU3RvcmFnZS5nZXRJdGVtKFwiQkVfU0VTU0lPTl9JRFwiKTtcclxuICAgIGlmICghYmVTZXNzaW9uc0pzb24pIHtcclxuICAgICAgcmV0dXJuIHt9O1xyXG4gICAgfVxyXG4gICAgY29uc3QgZnJtU2Vzc2lvbklkID0gdGhpcy5nZXRVc2VyU2Vzc2lvbklkKCk7XHJcbiAgICBjb25zdCBiZVNlc3Npb25zID0gSlNPTi5wYXJzZShiZVNlc3Npb25zSnNvbik7XHJcbiAgICBjb25zdCBiZVNlc3Npb25LZXkgPSBgJHtmcm1TZXNzaW9uSWR9Xy9hcGkvZ3NwL2NvbW1vbi92MS4wL3Rlc3RGb3JtX21mcm1gO1xyXG4gICAgcmV0dXJuIGJlU2Vzc2lvbnNbYmVTZXNzaW9uS2V5XTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W55So5oi3U2Vzc2lvbklkXHJcbiAgICovXHJcbiAgZ2V0VXNlclNlc3Npb25JZCgpIHtcclxuICAgIGNvbnN0IHVzZXJTZXNzaW9uSWQgPSB3aW5kb3cubG9jYWxTdG9yYWdlLmdldEl0ZW0oXCJzZXNzaW9uSWRcIik7XHJcbiAgICByZXR1cm4gdXNlclNlc3Npb25JZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJqeWxlUJlU2Vzc2lvbklk55u45YWz5aS05L+h5oGvXHJcbiAgICovXHJcbiAgaGFuZGxlUmVxdWVzdEhlYWRlcnMoaGVhZGVycykge1xyXG4gICAgY29uc3QgZnJtU2Vzc2lvbklkID0gdGhpcy5nZXRVc2VyU2Vzc2lvbklkKCk7XHJcbiAgICBjb25zdCBiZVNlc3Npb25JZCA9IHRoaXMuZ2V0QWxsQmVTZXNzaW9ucygpO1xyXG4gICAgaWYgKGZybVNlc3Npb25JZCkge1xyXG4gICAgICBoZWFkZXJzID0gSHR0cFV0aWwuYXBwZW5kSGVhZGVyKFxyXG4gICAgICAgIGhlYWRlcnMsXHJcbiAgICAgICAgXCJYLUNBRi1SdW50aW1lLUNvbW1vblZhcmlhYmxlXCIsXHJcbiAgICAgICAgZnJtU2Vzc2lvbklkXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgICBpZiAoYmVTZXNzaW9uSWQpIHtcclxuICAgICAgaGVhZGVycyA9IEh0dHBVdGlsLmFwcGVuZEhlYWRlcihcclxuICAgICAgICBoZWFkZXJzLFxyXG4gICAgICAgIFwiWC1DQUYtUnVudGltZS1Db250ZXh0XCIsXHJcbiAgICAgICAgYmVTZXNzaW9uSWRcclxuICAgICAgKTtcclxuICAgICAgaGVhZGVycyA9IEh0dHBVdGlsLmFwcGVuZEhlYWRlcihoZWFkZXJzLCBcIlNlc3Npb25JZFwiLCBiZVNlc3Npb25JZCk7XHJcbiAgICB9XHJcbiAgICBoZWFkZXJzID0gSHR0cFV0aWwuYXBwZW5kSGVhZGVyKGhlYWRlcnMsICdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xyXG4gICAgcmV0dXJuIGhlYWRlcnM7XHJcbiAgfVxyXG4gIHB1YmxpYyBleHRlbmRRdWVyeURhdGEodXJsOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3QgZW50aXR5RmlsdGVyID0ge1xyXG4gICAgICBGaWx0ZXJDb25kaXRpb25zOiBbXSxcclxuICAgICAgU29ydENvbmRpdGlvbnM6IFtdLFxyXG4gICAgICBJc1VzZVBhZ2luYXRpb246IGZhbHNlLFxyXG4gICAgICBQYWdpbmF0aW9uOiB7XHJcbiAgICAgICAgUGFnZUluZGV4OiAxLFxyXG4gICAgICAgIFBhZ2VTaXplOiA1LFxyXG4gICAgICAgIFBhZ2VDb3VudDogMCxcclxuICAgICAgICBUb3RhbENvdW50OiAwXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICBjb25zdCBlbnRpdHlGaWx0ZXJTdHJpbmcgPSBKU09OLnN0cmluZ2lmeShlbnRpdHlGaWx0ZXIpO1xyXG4gICAgY29uc3QgcGFyYW1zID0ge1xyXG4gICAgICBlbnRpdHlGaWx0ZXI6IGVudGl0eUZpbHRlclN0cmluZ1xyXG4gICAgfTtcclxuICAgIC8vIGNvbnN0IHVybCA9IGAvYXBpL2dzcC9jb21tb24vdjEuMC9hdHRhY2htZW50Zm9ybV9tZnJtL2V4dGVuc2lvbi9xdWVyeWA7XHJcbiAgICAvLyDmi5PlsZVoZWFkZXJcclxuICAgIC8vIGNvbnN0IGhlYWRlcnMgPSB0aGlzLmhhbmRsZVJlcXVlc3RIZWFkZXJzKHt9KTtcclxuICAgIC8vIOaLk+WxlWJvZHlcclxuICAgIGNvbnN0IHJlcXVlc3RDb25maWcgPSB7IHBhcmFtcyB9O1xyXG4gICAgcmV0dXJuIHRoaXMuYmVmUmVwb3NpLmFwaVByb3h5LnJlcXVlc3QoSHR0cE1ldGhvZHMuUFVULCB1cmwsIHJlcXVlc3RDb25maWcpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5pu05paw6ZmE5Lu25L+h5oGvXHJcbiAgICovXHJcbiAgcHVibGljIHVwZGF0ZVJvdyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBhdHRhY2htZW50SW5mbzogQnVzaW5lc3NBdHRhY2htZW50SW5mbyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCBhcGlQcm94eSA9IHRoaXMuYmVmUmVwb3NpLmFwaVByb3h5O1xyXG4gICAgY29uc3QgdXBkYXRlVXJsID0gYCR7YXBpUHJveHkuYmFzZVVybH0vc2VydmljZS91cGRhdGVhdHRhY2htZW50YDtcclxuICAgIGNvbnN0IHNlcnZlckF0dGFjaEluZm8gPSB0aGlzLmNyZWF0ZVVwZGF0ZUF0dGFjaEluZm8oYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGF0dGFjaG1lbnRJbmZvKTtcclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgIHVwZGF0ZUF0dGFjaEluZm86IHNlcnZlckF0dGFjaEluZm9cclxuICAgIH07XHJcbiAgICBjb25zdCByZXF1ZXN0Q29uZmlnOiBIdHRwUmVxdWVzdENvbmZpZyA9IHtcclxuICAgICAgYm9keTogYm9keVxyXG4gICAgfTtcclxuICAgIHJldHVybiBhcGlQcm94eS5yZXF1ZXN0KEh0dHBNZXRob2RzLlBVVCwgdXBkYXRlVXJsLCByZXF1ZXN0Q29uZmlnKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJuemHj+WIm+W7uumZhOS7tuihjOaVsOaNrlxyXG4gICAqL1xyXG4gIHB1YmxpYyB1cGRhdGVSb3dzKHVwZGF0ZVVybDogc3RyaW5nLCBhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBhdHRhY2htZW50SW5mb3M6IEJ1c2luZXNzQXR0YWNobWVudEluZm9bXSk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCBhcGlQcm94eSA9IHRoaXMuYmVmUmVwb3NpLmFwaVByb3h5O1xyXG4gICAgLy8gY29uc3QgdXBkYXRlVXJsID0gYCR7YXBpUHJveHkuYmFzZVVybH0vc2VydmljZS9iYXRjaHVwbG9hZGF0dGFjaG1lbnRgO1xyXG4gICAgY29uc3Qgc2VydmVyQXR0YWNoSW5mbyA9IHRoaXMuY3JlYXRlQmF0Y2hDcmVhdGVBdHRhY2hJbmZvKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBhdHRhY2htZW50SW5mb3MpO1xyXG4gICAgY29uc3QgaXNSb290RW50aXR5ID0gc2VydmVyQXR0YWNoSW5mby5Ob2RlQ29kZXMubGVuZ3RoID09PSAwO1xyXG5cclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgIGJhdGNoVXBsb2FkSW5mbzogc2VydmVyQXR0YWNoSW5mb1xyXG4gICAgfTtcclxuICAgIGNvbnN0IHJlcXVlc3RDb25maWc6IEh0dHBSZXF1ZXN0Q29uZmlnID0ge1xyXG4gICAgICBib2R5OiBib2R5XHJcbiAgICB9O1xyXG5cclxuICAgIHJldHVybiBhcGlQcm94eS5yZXF1ZXN0KEh0dHBNZXRob2RzLlBVVCwgdXBkYXRlVXJsLCByZXF1ZXN0Q29uZmlnLCB0cnVlKTtcclxuICB9XHJcblxyXG5cclxuXHJcblxyXG5cclxuICAvKipcclxuICAgKiDliJvlu7rmnI3liqHlmajnq6/pnIDopoHnmoTmm7TmlrDkv6Hmga9cclxuICAgKi9cclxuICBwcml2YXRlIGNyZWF0ZVVwZGF0ZUF0dGFjaEluZm8oYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgYXR0YWNobWVudEluZm86IEJ1c2luZXNzQXR0YWNobWVudEluZm8pOiBCdXNpbmVzc1NlcnZlckF0dGFjaG1lbnRJbmZvIHtcclxuXHJcbiAgICBjb25zdCBhdHRhY2htZW50SWQgPSBhdHRhY2htZW50SW5mby5hdHRhY2htZW50SWQ7XHJcbiAgICBjb25zdCBwYXJlbnRCaW5kaW5nUGF0aEFycmF5ID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcclxuICAgIHBhcmVudEJpbmRpbmdQYXRoQXJyYXkucG9wKCk7XHJcbiAgICBjb25zdCBub2RlQ29kZXMgPSBCZWZEYXRhUGF0aFV0aWwuY29udmVydFRvT2JqZWN0Q29kZXMocGFyZW50QmluZGluZ1BhdGhBcnJheSwgdGhpcy5iaW5kaW5nRGF0YSk7XHJcbiAgICBjb25zdCBoaXJldHJ5SWRzID0gQmVmRGF0YVBhdGhVdGlsLmNvbnZlcnRUb0RhdGFJZHNGb3JVcGRhdGUocGFyZW50QmluZGluZ1BhdGhBcnJheSwgdGhpcy5iaW5kaW5nRGF0YSk7XHJcblxyXG4gICAgY29uc3Qgc2VydmVyQXR0YWNoSW5mbzogQnVzaW5lc3NTZXJ2ZXJBdHRhY2htZW50SW5mbyA9IHtcclxuICAgICAgTm9kZUNvZGVzOiBub2RlQ29kZXMsXHJcbiAgICAgIEhpcmV0cnlJZHM6IGhpcmV0cnlJZHMsXHJcbiAgICAgIEF0dGFjaG1lbnRJZHM6IFthdHRhY2htZW50SWRdLFxyXG4gICAgICBBdHRhY2htZW50SWQ6IGF0dGFjaG1lbnRJZFxyXG4gICAgfTtcclxuXHJcbiAgICByZXR1cm4gc2VydmVyQXR0YWNoSW5mbztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIm+W7uuacjeWKoeWZqOerr+mcgOimgeeahOaJuemHj+aWsOWinumZhOS7tuS/oeaBr1xyXG4gICAqL1xyXG4gIHByaXZhdGUgY3JlYXRlQmF0Y2hDcmVhdGVBdHRhY2hJbmZvKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIGF0dGFjaG1lbnRJbmZvOiBCdXNpbmVzc0F0dGFjaG1lbnRJbmZvW10pOlxyXG4gICAgQnVzaW5lc3NTZXJ2ZXJBdHRhY2htZW50SW5mbyB7XHJcbiAgICBjb25zdCBhdHRhY2htZW50SWRzID0gQXR0YWNobWVudFV0aWwucGVla0F0dGFjaG1lbnRJZHMoYXR0YWNobWVudEluZm8pO1xyXG5cclxuICAgIGNvbnN0IHBhcmVudEJpbmRpbmdQYXRoQXJyYXkgPSBCaW5kaW5nUGF0aENvbnZlcnRlci50b0JpbmRpbmdQYXRoQXJyYXkoYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xyXG4gICAgcGFyZW50QmluZGluZ1BhdGhBcnJheS5wb3AoKTtcclxuICAgIGNvbnN0IG5vZGVDb2RlcyA9IEJlZkRhdGFQYXRoVXRpbC5jb252ZXJ0VG9PYmplY3RDb2RlcyhwYXJlbnRCaW5kaW5nUGF0aEFycmF5LCB0aGlzLmJpbmRpbmdEYXRhKTtcclxuICAgIGNvbnN0IGhpcmV0cnlJZHMgPSBCZWZEYXRhUGF0aFV0aWwuY29udmVydFRvRGF0YUlkc0ZvckFkZChwYXJlbnRCaW5kaW5nUGF0aEFycmF5LCB0aGlzLmJpbmRpbmdEYXRhKTtcclxuXHJcbiAgICBjb25zdCBzZXJ2ZXJBdHRhY2hJbmZvID0ge1xyXG4gICAgICBOb2RlQ29kZXM6IG5vZGVDb2RlcyxcclxuICAgICAgSGlyZXRyeUlkczogaGlyZXRyeUlkcyxcclxuICAgICAgQXR0YWNobWVudElkczogYXR0YWNobWVudElkcyxcclxuICAgICAgQXR0YWNobWVudElkOiBudWxsXHJcbiAgICB9O1xyXG5cclxuICAgIHJldHVybiBzZXJ2ZXJBdHRhY2hJbmZvO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5ZCM5q2l5pyN5Yqh5Zmo56uv5pyA5paw5L+h5oGv5Yiw5a6i5oi356uvXHJcbiAgICogQHRvZG86XHJcbiAgICogMeOAgeS4u+WvueixoeaJuemHj+aWsOWinuaXtuS4jeaUr+aMgVxyXG4gICAqL1xyXG4gIHB1YmxpYyBzeW5jQXR0YWNobWVudEluZm9zVG9DbGllbnQoKSB7XHJcbiAgICBjb25zdCByb290RGF0YUlkID0gdGhpcy5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZDtcclxuICAgIHJldHVybiB0aGlzLmJlZlJlcG9zaS51cGRhdGVFbnRpdHlCeUlkKHJvb3REYXRhSWQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6L+95Ye75Li76KGo5pWw5o2u5Yiw5a6i5oi356uvXHJcbiAgICovXHJcbiAgcHVibGljIGFwcGVuZEF0dGFjaG1lbnRJbmZvc1RvQ2xpZW50KGxpc3REYXRhOiBhbnlbXSwgaXNSb290RW50aXR5OiBib29sZWFuKTogT2JzZXJ2YWJsZTxhbnlbXT4ge1xyXG4gICAgaWYgKGlzUm9vdEVudGl0eSA9PT0gdHJ1ZSkge1xyXG4gICAgICBjb25zdCBlbnRpdGllcyA9IHRoaXMuYmVmUmVwb3NpLmJ1aWxkRW50aXRpZXMobGlzdERhdGEpO1xyXG4gICAgICB0aGlzLmJlZlJlcG9zaS5lbnRpdHlDb2xsZWN0aW9uLmFkZEVudGl0aWVzKGVudGl0aWVzKTtcclxuICAgICAgcmV0dXJuIG9mKGxpc3REYXRhKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnN5bmNBdHRhY2htZW50SW5mb3NUb0NsaWVudCgpLnBpcGUoXHJcbiAgICAgICAgbWFwKCgpID0+IHtcclxuICAgICAgICAgIHJldHVybiBsaXN0RGF0YTtcclxuICAgICAgICB9KVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCB7IEJ1c2luZXNzQXR0YWNobWVudERhdGFTZXJ2aWNlIH07XHJcbiJdfQ==