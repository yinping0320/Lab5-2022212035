/**
 * @fileoverview added by tsickle
 * Generated from: lib/grid-employee-selector/grid-employee-selector.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, Injector, Renderer2, ViewChild } from '@angular/core';
import { CommonUtils, RuntimeStateService } from '@farris/ui-common';
import { GRID_EDITORS } from '@farris/ui-datagrid';
import { DatagridBaseEditorDirective } from '@farris/ui-datagrid-editors';
import * as _ from 'lodash-es';
import { isNull, isUndefined, omitBy, trim } from 'lodash-es';
/** @type {?} */
var employeeSelectorDefautOption = {
    absOrgType: 'System_organization',
    readonly: false,
    placeholder: '请选择',
    viewType: 'tag',
    busNum: 'common',
    idField: 'userId'
};
var DatagridEmployeeSelectorComponent = /** @class */ (function (_super) {
    tslib_1.__extends(DatagridEmployeeSelectorComponent, _super);
    function DatagridEmployeeSelectorComponent(render, el, rts, utils, injector) {
        var _this = _super.call(this, render, el, injector) || this;
        _this.rts = rts;
        _this.utils = utils;
        _this.lookupFieldMap = (/**
         * @param {?} helpData
         * @param {?} mapFields
         * @param {?} dataObj
         * @return {?}
         */
        function (helpData, mapFields, dataObj) {
            if (mapFields) {
                /** @type {?} */
                var helpFields = Object.keys(mapFields);
                helpFields.forEach((/**
                 * @param {?} f
                 * @return {?}
                 */
                function (f) {
                    /** @type {?} */
                    var val = '';
                    if (helpData) {
                        if (helpData instanceof Array) {
                            val = helpData.map((/**
                             * @param {?} h
                             * @return {?}
                             */
                            function (h) {
                                return _this.utils.getValue(f, h);
                            })).join(',');
                        }
                        else {
                            val = _this.utils.getValue(f, helpData);
                        }
                    }
                    mapFields[f].split(',').forEach((/**
                     * @param {?} ff
                     * @return {?}
                     */
                    function (ff) {
                        /** @type {?} */
                        var field = trim(ff);
                        _this.utils.setValue(dataObj, field, val);
                    }));
                }));
            }
        });
        return _this;
    }
    /**
     * @return {?}
     */
    DatagridEmployeeSelectorComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        _super.prototype.ngOnInit.call(this);
        // 这里添加了过滤 this.options 中null、undefined,万一 jit 生成了 undefined 的呢，
        this.options = Object.assign({}, employeeSelectorDefautOption, omitBy(this.options, (/**
         * @param {?} itemValue
         * @return {?}
         */
        function (itemValue) { return isUndefined(itemValue) || isNull(itemValue); })));
        this.instance.selectedData = new EventEmitter();
        this.instance.clear = new EventEmitter();
    };
    /**
     * @return {?}
     */
    DatagridEmployeeSelectorComponent.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.inputElement = this.el.nativeElement;
        _super.prototype.ngAfterViewInit.call(this);
        if (this.instance.ngControl &&
            this.instance.ngControl.formDirective &&
            this.instance.ngControl.formDirective.form &&
            this.instance.ngControl.formDirective.form.bindingData) {
            this.bindingData = this.instance.ngControl.formDirective.form.bindingData;
            this.bindingData.setValue = (/**
             * @param {?} fieldPath
             * @return {?}
             */
            function (fieldPath) {
                return _this.utils.setValue(fieldPath.join('.'), _this.bindingData, true);
            });
            this.bindingData.getValue = (/**
             * @param {?} fieldPath
             * @return {?}
             */
            function (fieldPath) {
                return _this.utils.getValue(fieldPath.join('.'), _this.bindingData, true);
            });
        }
    };
    /**
     * @return {?}
     */
    DatagridEmployeeSelectorComponent.prototype.inputClear = /**
     * @return {?}
     */
    function () {
        this.updateControlValue(null);
        this.instance.clear.emit();
        if (this.options.inputClear) {
            // 设计器上配置的清空事件
            this.options.inputClear();
        }
    };
    /**
     * @param {?} removedItem
     * @return {?}
     */
    DatagridEmployeeSelectorComponent.prototype.tagRemoved = /**
     * @param {?} removedItem
     * @return {?}
     */
    function (removedItem) {
        var _this = this;
        /** @type {?} */
        var mapFields = this.instance.mapFields;
        /** @type {?} */
        var helpFields = Object.keys(mapFields);
        /** @type {?} */
        var bindingData = _.cloneDeep(this.bindingData);
        /** @type {?} */
        var selectedData = [];
        helpFields.forEach((/**
         * @param {?} key
         * @return {?}
         */
        function (key) {
            /** @type {?} */
            var value = _this.utils.getValue(mapFields[key], bindingData);
            /** @type {?} */
            var vArr = value.split(',');
            vArr.splice(removedItem.deleteIndex, 1);
            vArr.forEach((/**
             * @param {?} v
             * @param {?} i
             * @return {?}
             */
            function (v, i) {
                if (!selectedData[i]) {
                    selectedData.push({ index: i });
                    selectedData[i][key] = v;
                }
                else {
                    selectedData[i][key] = v;
                }
            }));
            value = vArr.join(',');
            _this.utils.setValue(_this.bindingData, mapFields[key], value);
        }));
        if (selectedData.length) {
            this.instance.selectedData.emit(selectedData);
        }
        else {
            this.instance.clear.emit();
        }
        // 设计器上配置的删除单个标签事件
        if (this.options.tagRemoved) {
            this.options.tagRemoved(this.eventPrams(removedItem));
        }
    };
    /**
     * @param {?} changeData
     * @return {?}
     */
    DatagridEmployeeSelectorComponent.prototype.selectionsChange = /**
     * @param {?} changeData
     * @return {?}
     */
    function (changeData) {
        /** @type {?} */
        var formedSelections = this.formSelectedRowData();
        this.updateControlValue(formedSelections);
        this.instance.selectedData.emit(formedSelections);
        // 设计器上配置的选中数据后事件
        if (this.options.selectionsChange) {
            this.options.selectionsChange(this.eventPrams(changeData));
        }
    };
    /**
     * @param {?} selectedRow
     * @return {?}
     */
    DatagridEmployeeSelectorComponent.prototype.updateControlValue = /**
     * @param {?} selectedRow
     * @return {?}
     */
    function (selectedRow) {
        if (this.instance.mapFields && this.bindingData) {
            this.lookupFieldMap(selectedRow, this.instance.mapFields, this.bindingData);
        }
    };
    /**
     * @return {?}
     */
    DatagridEmployeeSelectorComponent.prototype.formSelectedRowData = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var selectedRowData = [];
        this.instance.selections.forEach((/**
         * @param {?} item
         * @return {?}
         */
        function (item) {
            /** @type {?} */
            var defaultDisplayName = _this.instance.displayField ? item[_this.instance.displayField] : "[" + item.code + "]" + item.name;
            /** @type {?} */
            var displayName = _this.instance.formatFn ? _this.instance.formatFn(item) : defaultDisplayName;
            selectedRowData.push(Object.assign({}, item, { displayName: displayName }));
        }));
        return selectedRowData.length ? selectedRowData : null;
    };
    /**
     * @private
     * @param {?} $event
     * @return {?}
     */
    DatagridEmployeeSelectorComponent.prototype.eventPrams = /**
     * @private
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        /** @type {?} */
        var p = this.eventParams($event);
        p['instance'] = this.instance;
        p['editor'] = this;
        return p;
    };
    DatagridEmployeeSelectorComponent.decorators = [
        { type: Component, args: [{
                    selector: 'farris-grid-employee-selector',
                    template: "<div [formGroup]=\"group\" class=\"f-datagrid-cell-formgroup farris-group-auto\">\r\n    <farris-employee-selector #selection style=\"width: 100%\"\r\n      [placeholder]=\"options.placeholder\" [enableQuick]=\"false\" [readonly]=\"options.readonly\" [absOrgType]=\"options.absOrgType\"\r\n      [viewType]=\"options.viewType\" [multiSelect]=\"options.multiSelect\" [busNum]=\"options.busNum\" [mapFields]=\"options.mapFields\"\r\n      [formatFn]=\"options.formatter\" [formControlName]=\"column.field\" [idField]=\"options.idField\" [displayField]=\"options.textField\"\r\n      [showTabIds]=\"options.showTabIds\" [enableHierarchicalLoading]=\"options.enableHierarchicalLoading\" [filterId]=\"options.filterId\"\r\n      (inputClear)=\"inputClear()\" (selectionsChange)=\"selectionsChange($event)\" (tagRemoved)=\"tagRemoved($event)\">\r\n    </farris-employee-selector>\r\n</div>"
                }] }
    ];
    /** @nocollapse */
    DatagridEmployeeSelectorComponent.ctorParameters = function () { return [
        { type: Renderer2 },
        { type: ElementRef },
        { type: RuntimeStateService },
        { type: CommonUtils },
        { type: Injector }
    ]; };
    DatagridEmployeeSelectorComponent.propDecorators = {
        instance: [{ type: ViewChild, args: ['selection',] }]
    };
    return DatagridEmployeeSelectorComponent;
}(DatagridBaseEditorDirective));
export { DatagridEmployeeSelectorComponent };
if (false) {
    /** @type {?} */
    DatagridEmployeeSelectorComponent.prototype.instance;
    /** @type {?} */
    DatagridEmployeeSelectorComponent.prototype.bindingData;
    /** @type {?} */
    DatagridEmployeeSelectorComponent.prototype.lookupFieldMap;
    /**
     * @type {?}
     * @private
     */
    DatagridEmployeeSelectorComponent.prototype.rts;
    /** @type {?} */
    DatagridEmployeeSelectorComponent.prototype.utils;
}
/** @type {?} */
export var EmployeeSelectorDataGridEditorProvider = { provide: GRID_EDITORS, useValue: { name: 'EmployeeSelector', value: DatagridEmployeeSelectorComponent }, multi: true };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JpZC1lbXBsb3llZS1zZWxlY3Rvci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRhdGFncmlkLWRmZi1lZGl0b3JzLyIsInNvdXJjZXMiOlsibGliL2dyaWQtZW1wbG95ZWUtc2VsZWN0b3IvZ3JpZC1lbXBsb3llZS1zZWxlY3Rvci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsT0FBTyxFQUFpQixTQUFTLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQVUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzSCxPQUFPLEVBQUUsV0FBVyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDckUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25ELE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzFFLE9BQU8sS0FBSyxDQUFDLE1BQU0sV0FBVyxDQUFDO0FBQy9CLE9BQU8sRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7O0lBR3hELDRCQUE0QixHQUFHO0lBQ25DLFVBQVUsRUFBRSxxQkFBcUI7SUFDakMsUUFBUSxFQUFFLEtBQUs7SUFDZixXQUFXLEVBQUUsS0FBSztJQUNsQixRQUFRLEVBQUUsS0FBSztJQUNmLE1BQU0sRUFBRSxRQUFRO0lBQ2hCLE9BQU8sRUFBRSxRQUFRO0NBQ2xCO0FBRUQ7SUFJdUQsNkRBQTJCO0lBTWhGLDJDQUNFLE1BQWlCLEVBQ2pCLEVBQWMsRUFDTixHQUF3QixFQUN6QixLQUFrQixFQUN6QixRQUFrQjtRQUxwQixZQU1FLGtCQUFNLE1BQU0sRUFBRSxFQUFFLEVBQUUsUUFBUSxDQUFDLFNBQzVCO1FBSlMsU0FBRyxHQUFILEdBQUcsQ0FBcUI7UUFDekIsV0FBSyxHQUFMLEtBQUssQ0FBYTtRQTBD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Ozs7O0lBQWxCLFVBQW1CLE1BQU07O1lBQ2pCLENBQUMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQztRQUNsQyxDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUM5QixDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBQ25CLE9BQU8sQ0FBQyxDQUFDO0lBQ1gsQ0FBQzs7Z0JBeEpGLFNBQVMsU0FBQztvQkFDVCxRQUFRLEVBQUUsK0JBQStCO29CQUN6QywrM0JBQXNEO2lCQUN2RDs7OztnQkFwQjhFLFNBQVM7Z0JBQXJELFVBQVU7Z0JBQ3ZCLG1CQUFtQjtnQkFBaEMsV0FBVztnQkFEeUMsUUFBUTs7OzJCQXVCbEUsU0FBUyxTQUFDLFdBQVc7O0lBbUp4Qix3Q0FBQztDQUFBLEFBekpELENBSXVELDJCQUEyQixHQXFKakY7U0FySlksaUNBQWlDOzs7SUFFNUMscURBQTRIOztJQUU1SCx3REFBaUI7O0lBZ0RqQiwyREFzQkM7Ozs7O0lBakVDLGdEQUFnQzs7SUFDaEMsa0RBQXlCOzs7QUE4STdCLE1BQU0sS0FBTyxzQ0FBc0MsR0FBRyxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLEVBQUUsSUFBSSxFQUFFLGtCQUFrQixFQUFFLEtBQUssRUFBRSxpQ0FBaUMsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlclZpZXdJbml0LCBDb21wb25lbnQsIEVsZW1lbnRSZWYsIEV2ZW50RW1pdHRlciwgSW5qZWN0b3IsIE9uSW5pdCwgUmVuZGVyZXIyLCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQ29tbW9uVXRpbHMsIFJ1bnRpbWVTdGF0ZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbic7XHJcbmltcG9ydCB7IEdSSURfRURJVE9SUyB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YWdyaWQnO1xyXG5pbXBvcnQgeyBEYXRhZ3JpZEJhc2VFZGl0b3JEaXJlY3RpdmUgfSBmcm9tICdAZmFycmlzL3VpLWRhdGFncmlkLWVkaXRvcnMnO1xyXG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IGlzTnVsbCwgaXNVbmRlZmluZWQsIG9taXRCeSwgdHJpbSB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IEVtcGxveWVlU2VsZWN0b3JDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWVtcGxveWVlLXNlbGVjdG9yJztcclxuXHJcbmNvbnN0IGVtcGxveWVlU2VsZWN0b3JEZWZhdXRPcHRpb24gPSB7XHJcbiAgYWJzT3JnVHlwZTogJ1N5c3RlbV9vcmdhbml6YXRpb24nLFxyXG4gIHJlYWRvbmx5OiBmYWxzZSxcclxuICBwbGFjZWhvbGRlcjogJ+ivt+mAieaLqScsXHJcbiAgdmlld1R5cGU6ICd0YWcnLFxyXG4gIGJ1c051bTogJ2NvbW1vbicsXHJcbiAgaWRGaWVsZDogJ3VzZXJJZCdcclxufTtcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAnZmFycmlzLWdyaWQtZW1wbG95ZWUtc2VsZWN0b3InLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9ncmlkLWVtcGxveWVlLXNlbGVjdG9yLmNvbXBvbmVudC5odG1sJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgRGF0YWdyaWRFbXBsb3llZVNlbGVjdG9yQ29tcG9uZW50IGV4dGVuZHMgRGF0YWdyaWRCYXNlRWRpdG9yRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcclxuXHJcbiAgQFZpZXdDaGlsZCgnc2VsZWN0aW9uJykgaW5zdGFuY2U6IEVtcGxveWVlU2VsZWN0b3JDb21wb25lbnQgJiB7IGNsZWFyOiBFdmVudEVtaXR0ZXI8YW55Pjsgc2VsZWN0ZWREYXRhOiBFdmVudEVtaXR0ZXI8YW55PiB9O1xyXG5cclxuICBiaW5kaW5nRGF0YTogYW55O1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHJlbmRlcjogUmVuZGVyZXIyLFxyXG4gICAgZWw6IEVsZW1lbnRSZWYsXHJcbiAgICBwcml2YXRlIHJ0czogUnVudGltZVN0YXRlU2VydmljZSxcclxuICAgIHB1YmxpYyB1dGlsczogQ29tbW9uVXRpbHMsXHJcbiAgICBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuICAgIHN1cGVyKHJlbmRlciwgZWwsIGluamVjdG9yKTtcclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgc3VwZXIubmdPbkluaXQoKTtcclxuICAgIC8vIOi/memHjOa3u+WKoOS6hui/h+a7pCB0aGlzLm9wdGlvbnMg5LitbnVsbOOAgXVuZGVmaW5lZCzkuIfkuIAgaml0IOeUn+aIkOS6hiB1bmRlZmluZWQg55qE5ZGi77yMXHJcbiAgICB0aGlzLm9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCBlbXBsb3llZVNlbGVjdG9yRGVmYXV0T3B0aW9uLCBvbWl0QnkodGhpcy5vcHRpb25zLCAoaXRlbVZhbHVlKSA9PiBpc1VuZGVmaW5lZChpdGVtVmFsdWUpIHx8IGlzTnVsbChpdGVtVmFsdWUpKSk7XHJcbiAgICB0aGlzLmluc3RhbmNlLnNlbGVjdGVkRGF0YSA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG4gICAgdGhpcy5pbnN0YW5jZS5jbGVhciA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG4gIH1cclxuXHJcbiAgbmdBZnRlclZpZXdJbml0KCkge1xyXG4gICAgdGhpcy5pbnB1dEVsZW1lbnQgPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICBzdXBlci5uZ0FmdGVyVmlld0luaXQoKTtcclxuICAgIGlmIChcclxuICAgICAgdGhpcy5pbnN0YW5jZS5uZ0NvbnRyb2wgJiZcclxuICAgICAgdGhpcy5pbnN0YW5jZS5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZSAmJlxyXG4gICAgICB0aGlzLmluc3RhbmNlLm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0gJiZcclxuICAgICAgdGhpcy5pbnN0YW5jZS5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtLmJpbmRpbmdEYXRhXHJcbiAgICApIHtcclxuICAgICAgdGhpcy5iaW5kaW5nRGF0YSA9IHRoaXMuaW5zdGFuY2UubmdDb250cm9sLmZvcm1EaXJlY3RpdmUuZm9ybS5iaW5kaW5nRGF0YTtcclxuICAgICAgdGhpcy5iaW5kaW5nRGF0YS5zZXRWYWx1ZSA9IChmaWVsZFBhdGgpID0+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy51dGlscy5zZXRWYWx1ZShmaWVsZFBhdGguam9pbignLicpLCB0aGlzLmJpbmRpbmdEYXRhLCB0cnVlKTtcclxuICAgICAgfTtcclxuICAgICAgdGhpcy5iaW5kaW5nRGF0YS5nZXRWYWx1ZSA9IChmaWVsZFBhdGgpID0+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy51dGlscy5nZXRWYWx1ZShmaWVsZFBhdGguam9pbignLicpLCB0aGlzLmJpbmRpbmdEYXRhLCB0cnVlKTtcclxuICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgfVxyXG5cclxuICBpbnB1dENsZWFyKCkge1xyXG4gICAgdGhpcy51cGRhdGVDb250cm9sVmFsdWUobnVsbCk7XHJcbiAgICB0aGlzLmluc3RhbmNlLmNsZWFyLmVtaXQoKTtcclxuICAgIGlmICh0aGlzLm9wdGlvbnMuaW5wdXRDbGVhcikge1xyXG4gICAgICAvLyDorr7orqHlmajkuIrphY3nva7nmoTmuIXnqbrkuovku7ZcclxuICAgICAgdGhpcy5vcHRpb25zLmlucHV0Q2xlYXIoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGxvb2t1cEZpZWxkTWFwID0gKGhlbHBEYXRhLCBtYXBGaWVsZHMsIGRhdGFPYmopID0+IHtcclxuICAgIGlmIChtYXBGaWVsZHMpIHtcclxuICAgICAgY29uc3QgaGVscEZpZWxkcyA9IE9iamVjdC5rZXlzKG1hcEZpZWxkcyk7XHJcbiAgICAgIGhlbHBGaWVsZHMuZm9yRWFjaCgoZjogYW55KSA9PiB7XHJcbiAgICAgICAgbGV0IHZhbCA9ICcnO1xyXG4gICAgICAgIGlmIChoZWxwRGF0YSkge1xyXG4gICAgICAgICAgaWYgKGhlbHBEYXRhIGluc3RhbmNlb2YgQXJyYXkpIHtcclxuICAgICAgICAgICAgdmFsID0gaGVscERhdGEubWFwKChoOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICByZXR1cm4gdGhpcy51dGlscy5nZXRWYWx1ZShmLCBoKTtcclxuICAgICAgICAgICAgfSkuam9pbignLCcpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdmFsID0gdGhpcy51dGlscy5nZXRWYWx1ZShmLCBoZWxwRGF0YSk7XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbWFwRmllbGRzW2ZdLnNwbGl0KCcsJykuZm9yRWFjaCgoZmY6IGFueSkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgZmllbGQgPSB0cmltKGZmKTtcclxuICAgICAgICAgIHRoaXMudXRpbHMuc2V0VmFsdWUoZGF0YU9iaiwgZmllbGQsIHZhbCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgdGFnUmVtb3ZlZChyZW1vdmVkSXRlbToge1xyXG4gICAgZGVsZXRlSXRlbTogYW55LFxyXG4gICAgZGVsZXRlSW5kZXg6IE51bWJlcixcclxuICAgIHNlbGVjdGlvbnM6IEFycmF5PGFueT5cclxuICB9KSB7XHJcbiAgICBjb25zdCBtYXBGaWVsZHMgPSB0aGlzLmluc3RhbmNlLm1hcEZpZWxkcztcclxuICAgIGNvbnN0IGhlbHBGaWVsZHMgPSBPYmplY3Qua2V5cyhtYXBGaWVsZHMpO1xyXG4gICAgY29uc3QgYmluZGluZ0RhdGEgPSBfLmNsb25lRGVlcCh0aGlzLmJpbmRpbmdEYXRhKTtcclxuICAgIGNvbnN0IHNlbGVjdGVkRGF0YSA9IFtdO1xyXG5cclxuICAgIGhlbHBGaWVsZHMuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICBsZXQgdmFsdWUgPSB0aGlzLnV0aWxzLmdldFZhbHVlKG1hcEZpZWxkc1trZXldLCBiaW5kaW5nRGF0YSk7XHJcbiAgICAgIGNvbnN0IHZBcnIgPSB2YWx1ZS5zcGxpdCgnLCcpO1xyXG4gICAgICB2QXJyLnNwbGljZShyZW1vdmVkSXRlbS5kZWxldGVJbmRleCwgMSk7XHJcbiAgICAgIHZBcnIuZm9yRWFjaCgodiwgaSkgPT4ge1xyXG4gICAgICAgIGlmICghc2VsZWN0ZWREYXRhW2ldKSB7XHJcbiAgICAgICAgICBzZWxlY3RlZERhdGEucHVzaCh7IGluZGV4OiBpIH0pO1xyXG4gICAgICAgICAgc2VsZWN0ZWREYXRhW2ldW2tleV0gPSB2O1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBzZWxlY3RlZERhdGFbaV1ba2V5XSA9IHY7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgdmFsdWUgPSB2QXJyLmpvaW4oJywnKTtcclxuICAgICAgdGhpcy51dGlscy5zZXRWYWx1ZSh0aGlzLmJpbmRpbmdEYXRhLCBtYXBGaWVsZHNba2V5XSwgdmFsdWUpO1xyXG4gICAgfSk7XHJcbiAgICBpZiAoc2VsZWN0ZWREYXRhLmxlbmd0aCkge1xyXG4gICAgICB0aGlzLmluc3RhbmNlLnNlbGVjdGVkRGF0YS5lbWl0KHNlbGVjdGVkRGF0YSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmluc3RhbmNlLmNsZWFyLmVtaXQoKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDorr7orqHlmajkuIrphY3nva7nmoTliKDpmaTljZXkuKrmoIfnrb7kuovku7ZcclxuICAgIGlmICh0aGlzLm9wdGlvbnMudGFnUmVtb3ZlZCkge1xyXG4gICAgICB0aGlzLm9wdGlvbnMudGFnUmVtb3ZlZCh0aGlzLmV2ZW50UHJhbXMocmVtb3ZlZEl0ZW0pKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNlbGVjdGlvbnNDaGFuZ2UoY2hhbmdlRGF0YToge1xyXG4gICAgaW5mbzogc3RyaW5nLFxyXG4gICAgZGF0YTogQXJyYXk8YW55PlxyXG4gIH0pIHtcclxuICAgIGNvbnN0IGZvcm1lZFNlbGVjdGlvbnMgPSB0aGlzLmZvcm1TZWxlY3RlZFJvd0RhdGEoKVxyXG4gICAgdGhpcy51cGRhdGVDb250cm9sVmFsdWUoZm9ybWVkU2VsZWN0aW9ucyk7XHJcbiAgICB0aGlzLmluc3RhbmNlLnNlbGVjdGVkRGF0YS5lbWl0KGZvcm1lZFNlbGVjdGlvbnMpO1xyXG4gICAgLy8g6K6+6K6h5Zmo5LiK6YWN572u55qE6YCJ5Lit5pWw5o2u5ZCO5LqL5Lu2XHJcbiAgICBpZiAodGhpcy5vcHRpb25zLnNlbGVjdGlvbnNDaGFuZ2UpIHtcclxuICAgICAgdGhpcy5vcHRpb25zLnNlbGVjdGlvbnNDaGFuZ2UodGhpcy5ldmVudFByYW1zKGNoYW5nZURhdGEpKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHVwZGF0ZUNvbnRyb2xWYWx1ZShzZWxlY3RlZFJvdykge1xyXG4gICAgaWYgKHRoaXMuaW5zdGFuY2UubWFwRmllbGRzICYmIHRoaXMuYmluZGluZ0RhdGEpIHtcclxuICAgICAgdGhpcy5sb29rdXBGaWVsZE1hcChzZWxlY3RlZFJvdywgdGhpcy5pbnN0YW5jZS5tYXBGaWVsZHMsIHRoaXMuYmluZGluZ0RhdGEpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG4gIGZvcm1TZWxlY3RlZFJvd0RhdGEoKSB7XHJcbiAgICBsZXQgc2VsZWN0ZWRSb3dEYXRhID0gW107XHJcbiAgICB0aGlzLmluc3RhbmNlLnNlbGVjdGlvbnMuZm9yRWFjaCgoaXRlbSkgPT4ge1xyXG4gICAgICBjb25zdCBkZWZhdWx0RGlzcGxheU5hbWUgPSB0aGlzLmluc3RhbmNlLmRpc3BsYXlGaWVsZCA/IGl0ZW1bdGhpcy5pbnN0YW5jZS5kaXNwbGF5RmllbGRdIDogYFske2l0ZW0uY29kZX1dJHtpdGVtLm5hbWV9YDtcclxuICAgICAgY29uc3QgZGlzcGxheU5hbWUgPSB0aGlzLmluc3RhbmNlLmZvcm1hdEZuID8gdGhpcy5pbnN0YW5jZS5mb3JtYXRGbihpdGVtKSA6IGRlZmF1bHREaXNwbGF5TmFtZTtcclxuICAgICAgc2VsZWN0ZWRSb3dEYXRhLnB1c2goT2JqZWN0LmFzc2lnbih7fSwgaXRlbSwgeyBkaXNwbGF5TmFtZSB9KSk7XHJcbiAgICB9KVxyXG4gICAgcmV0dXJuIHNlbGVjdGVkUm93RGF0YS5sZW5ndGggPyBzZWxlY3RlZFJvd0RhdGEgOiBudWxsO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBldmVudFByYW1zKCRldmVudCk6IGFueSB7XHJcbiAgICBjb25zdCBwID0gdGhpcy5ldmVudFBhcmFtcygkZXZlbnQpO1xyXG4gICAgcFsnaW5zdGFuY2UnXSA9IHRoaXMuaW5zdGFuY2U7XHJcbiAgICBwWydlZGl0b3InXSA9IHRoaXM7XHJcbiAgICByZXR1cm4gcDtcclxuICB9XHJcbn1cclxuXHJcblxyXG5leHBvcnQgY29uc3QgRW1wbG95ZWVTZWxlY3RvckRhdGFHcmlkRWRpdG9yUHJvdmlkZXIgPSB7IHByb3ZpZGU6IEdSSURfRURJVE9SUywgdXNlVmFsdWU6IHsgbmFtZTogJ0VtcGxveWVlU2VsZWN0b3InLCB2YWx1ZTogRGF0YWdyaWRFbXBsb3llZVNlbGVjdG9yQ29tcG9uZW50IH0sIG11bHRpOiB0cnVlIH1cclxuIl19