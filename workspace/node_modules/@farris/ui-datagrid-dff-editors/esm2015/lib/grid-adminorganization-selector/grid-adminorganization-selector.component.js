/**
 * @fileoverview added by tsickle
 * Generated from: lib/grid-adminorganization-selector/grid-adminorganization-selector.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ElementRef, EventEmitter, Injector, Renderer2, ViewChild } from '@angular/core';
import { CommonUtils, RuntimeStateService } from '@farris/ui-common';
import { GRID_EDITORS } from '@farris/ui-datagrid';
import { DatagridBaseEditorDirective } from '@farris/ui-datagrid-editors';
import * as _ from 'lodash-es';
import { isNull, isUndefined, omitBy, trim } from 'lodash-es';
/** @type {?} */
const AdminOrganizationSelectorDefautOption = {
    absOrgType: 'System_organization',
    readonly: false,
    placeholder: '请选择',
    busNum: 'common',
    primaryField: 'orgId',
    displayField: 'name'
};
export class DataGridAdminOrganizationSelectorComponent extends DatagridBaseEditorDirective {
    /**
     * @param {?} render
     * @param {?} el
     * @param {?} rts
     * @param {?} utils
     * @param {?} injector
     */
    constructor(render, el, rts, utils, injector) {
        super(render, el, injector);
        this.rts = rts;
        this.utils = utils;
        this.lookupFieldMap = (/**
         * @param {?} helpData
         * @param {?} mapFields
         * @param {?} dataObj
         * @return {?}
         */
        (helpData, mapFields, dataObj) => {
            if (mapFields) {
                /** @type {?} */
                const helpFields = Object.keys(mapFields);
                helpFields.forEach((/**
                 * @param {?} helpField
                 * @return {?}
                 */
                (helpField) => {
                    /** @type {?} */
                    let val = '';
                    if (helpData) {
                        if (helpData instanceof Array) {
                            val = helpData.map((/**
                             * @param {?} data
                             * @return {?}
                             */
                            (data) => { return this.utils.getValue(helpField, data); })).join(',');
                        }
                        else {
                            val = this.utils.getValue(helpField, helpData);
                        }
                    }
                    mapFields[helpField].split(',').forEach((/**
                     * @param {?} ff
                     * @return {?}
                     */
                    (ff) => {
                        /** @type {?} */
                        const formField = trim(ff);
                        this.utils.setValue(dataObj, formField, val);
                    }));
                }));
            }
        });
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        super.ngOnInit();
        this.options = Object.assign({}, AdminOrganizationSelectorDefautOption, omitBy(this.options, (/**
         * @param {?} itemValue
         * @return {?}
         */
        (itemValue) => isUndefined(itemValue) || isNull(itemValue))));
        this.instance.selectedData = new EventEmitter();
        this.instance.clear = new EventEmitter();
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.inputElement = this.el.nativeElement;
        super.ngAfterViewInit();
        if (this.instance.ngControl &&
            this.instance.ngControl.formDirective &&
            this.instance.ngControl.formDirective.form &&
            this.instance.ngControl.formDirective.form.bindingData) {
            this.bindingData = this.instance.ngControl.formDirective.form.bindingData;
            this.bindingData.setValue = (/**
             * @param {?} fieldPath
             * @return {?}
             */
            (fieldPath) => {
                return this.utils.setValue(fieldPath.join('.'), this.bindingData, true);
            });
            this.bindingData.getValue = (/**
             * @param {?} fieldPath
             * @return {?}
             */
            (fieldPath) => {
                return this.utils.getValue(fieldPath.join('.'), this.bindingData, true);
            });
        }
    }
    /**
     * @param {?} selectedRow
     * @return {?}
     */
    updateControlValue(selectedRow) {
        if (this.instance.mapFields && this.bindingData) {
            this.lookupFieldMap(selectedRow, this.instance.mapFields, this.bindingData);
        }
    }
    /**
     * @return {?}
     */
    inputClear() {
        this.updateControlValue(null);
        this.instance.clear.emit();
        // 设计器上配置的清空事件
        if (this.options.inputClear) {
            this.options.inputClear();
        }
    }
    /**
     * @param {?} removedItem
     * @return {?}
     */
    tagRemoved(removedItem) {
        /** @type {?} */
        const mapFields = this.instance.mapFields;
        /** @type {?} */
        const helpFields = Object.keys(mapFields);
        /** @type {?} */
        const bindingData = _.cloneDeep(this.bindingData);
        /** @type {?} */
        const selectedData = [];
        helpFields.forEach((/**
         * @param {?} key
         * @return {?}
         */
        key => {
            /** @type {?} */
            let value = this.utils.getValue(mapFields[key], bindingData);
            /** @type {?} */
            const vArr = value.split(',');
            vArr.splice(removedItem.deleteIndex, 1);
            vArr.forEach((/**
             * @param {?} v
             * @param {?} i
             * @return {?}
             */
            (v, i) => {
                if (!selectedData[i]) {
                    selectedData.push({ index: i });
                    selectedData[i][key] = v;
                }
                else {
                    selectedData[i][key] = v;
                }
            }));
            value = vArr.join(',');
            this.utils.setValue(this.bindingData, mapFields[key], value);
        }));
        if (selectedData.length) {
            this.instance.selectedData.emit(selectedData);
        }
        else {
            this.instance.clear.emit();
        }
        // 设计器上配置的删除单个标签事件
        if (this.options.tagRemoved) {
            this.options.tagRemoved(this.eventPrams(removedItem));
        }
    }
    /**
     * @param {?} changeData
     * @return {?}
     */
    selectionsChange(changeData) {
        /** @type {?} */
        const formedSelections = this.formSelectedRowData();
        this.updateControlValue(formedSelections);
        this.instance.selectedData.emit(formedSelections);
        // 设计器上配置的选中数据后事件
        if (this.options.selectionsChange) {
            this.options.selectionsChange(this.eventPrams(changeData));
        }
    }
    /**
     * @return {?}
     */
    formSelectedRowData() {
        /** @type {?} */
        let selectedRowData = [];
        this.instance.selections.forEach((/**
         * @param {?} item
         * @return {?}
         */
        (item) => {
            /** @type {?} */
            const defaultDisplayName = this.instance.displayField ? item[this.instance.displayField] : `${item.name}`;
            /** @type {?} */
            const displayName = this.instance.formatFn ? this.instance.formatFn(item) : defaultDisplayName;
            selectedRowData.push(Object.assign({}, item, { displayName }));
        }));
        return selectedRowData.length ? selectedRowData : null;
    }
    /**
     * @private
     * @param {?} $event
     * @return {?}
     */
    eventPrams($event) {
        /** @type {?} */
        const p = this.eventParams($event);
        p['instance'] = this.instance;
        p['editor'] = this;
        return p;
    }
}
DataGridAdminOrganizationSelectorComponent.decorators = [
    { type: Component, args: [{
                selector: 'farris-grid-adminorganization-selector',
                template: "<div [formGroup]=\"group\" class=\"f-datagrid-cell-formgroup farris-group-auto\">\r\n    <farris-adminorganization-selector #orgSelection style=\"width: 100%\"\r\n      [placeholder]=\"options.placeholder\" [readonly]=\"options.readonly\" [absOrgType]=\"options.absOrgType\" [multiSelect]=\"options.multiSelect\"\r\n      [mapFields]=\"options.mapFields\" [formControlName]=\"column.field\" [primaryField]=\"options.primaryField\" [displayField]=\"options.displayField\"\r\n      [formatFn]=\"options.formatter\" [layer]=\"options.expandLevel\" [enableHierarchicalLoading]=\"options.enableHierarchicalLoading\"\r\n      [cascadeCheck]=\"options.cascadeCheck\" [cascadeDown]=\"options.cascadeDown\" [cascadeUp]=\"options.cascadeUp\"\r\n      [showTabIds]=\"options.showTabIds\" [activeTabId]=\"options.activeTabId\" [busNum]=\"options.busNum\"\r\n      (inputClear)=\"inputClear()\" (selectionsChange)=\"selectionsChange($event)\" (tagRemoved)=\"tagRemoved($event)\">\r\n    </farris-adminorganization-selector>\r\n</div>"
            }] }
];
/** @nocollapse */
DataGridAdminOrganizationSelectorComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef },
    { type: RuntimeStateService },
    { type: CommonUtils },
    { type: Injector }
];
DataGridAdminOrganizationSelectorComponent.propDecorators = {
    instance: [{ type: ViewChild, args: ['orgSelection',] }]
};
if (false) {
    /** @type {?} */
    DataGridAdminOrganizationSelectorComponent.prototype.instance;
    /** @type {?} */
    DataGridAdminOrganizationSelectorComponent.prototype.bindingData;
    /** @type {?} */
    DataGridAdminOrganizationSelectorComponent.prototype.lookupFieldMap;
    /**
     * @type {?}
     * @private
     */
    DataGridAdminOrganizationSelectorComponent.prototype.rts;
    /** @type {?} */
    DataGridAdminOrganizationSelectorComponent.prototype.utils;
}
/** @type {?} */
export const AdminOrganizationSelectorDataGridEditorProvider = { provide: GRID_EDITORS, useValue: { name: 'AdminOrganizationSelector', value: DataGridAdminOrganizationSelectorComponent }, multi: true };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JpZC1hZG1pbm9yZ2FuaXphdGlvbi1zZWxlY3Rvci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRhdGFncmlkLWRmZi1lZGl0b3JzLyIsInNvdXJjZXMiOlsibGliL2dyaWQtYWRtaW5vcmdhbml6YXRpb24tc2VsZWN0b3IvZ3JpZC1hZG1pbm9yZ2FuaXphdGlvbi1zZWxlY3Rvci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUF5QixVQUFVLEVBQUUsWUFBWSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNILE9BQU8sRUFBRSxXQUFXLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNyRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkQsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDMUUsT0FBTyxLQUFLLENBQUMsTUFBTSxXQUFXLENBQUM7QUFDL0IsT0FBTyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQzs7TUFHeEQscUNBQXFDLEdBQUc7SUFDNUMsVUFBVSxFQUFFLHFCQUFxQjtJQUNqQyxRQUFRLEVBQUUsS0FBSztJQUNmLFdBQVcsRUFBRSxLQUFLO0lBQ2xCLE1BQU0sRUFBRSxRQUFRO0lBQ2hCLFlBQVksRUFBRSxPQUFPO0lBQ3JCLFlBQVksRUFBRSxNQUFNO0NBQ3JCO0FBTUQsTUFBTSxPQUFPLDBDQUEyQyxTQUFRLDJCQUEyQjs7Ozs7Ozs7SUFNdkYsWUFDSSxNQUFpQixFQUNqQixFQUFjLEVBQ04sR0FBd0IsRUFDekIsS0FBa0IsRUFDekIsUUFBa0I7UUFFbEIsS0FBSyxDQUFDLE1BQU0sRUFBRSxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFKcEIsUUFB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QUFDLE1BQU07O2NBQ2pCLENBQUMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQztRQUNsQyxDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUM5QixDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBQ25CLE9BQU8sQ0FBQyxDQUFDO0lBQ1gsQ0FBQzs7O1lBakpKLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsd0NBQXdDO2dCQUNsRCx3Z0NBQStEO2FBQ2hFOzs7O1lBcEI4RSxTQUFTO1lBQTdDLFVBQVU7WUFDL0IsbUJBQW1CO1lBQWhDLFdBQVc7WUFEaUQsUUFBUTs7O3VCQXVCeEUsU0FBUyxTQUFDLGNBQWM7Ozs7SUFBekIsOERBQXdJOztJQUV4SSxpRUFBaUI7O0lBc0NqQixvRUFrQkM7Ozs7O0lBbkRHLHlEQUFnQzs7SUFDaEMsMkRBQXlCOzs7QUFzSWpDLE1BQU0sT0FBTywrQ0FBK0MsR0FBRyxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLEVBQUUsSUFBSSxFQUFFLDJCQUEyQixFQUFFLEtBQUssRUFBRSwwQ0FBMEMsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBJbmplY3RvciwgUmVuZGVyZXIyLCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQ29tbW9uVXRpbHMsIFJ1bnRpbWVTdGF0ZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbic7XHJcbmltcG9ydCB7IEdSSURfRURJVE9SUyB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YWdyaWQnO1xyXG5pbXBvcnQgeyBEYXRhZ3JpZEJhc2VFZGl0b3JEaXJlY3RpdmUgfSBmcm9tICdAZmFycmlzL3VpLWRhdGFncmlkLWVkaXRvcnMnO1xyXG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IGlzTnVsbCwgaXNVbmRlZmluZWQsIG9taXRCeSwgdHJpbSB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IEFkbWluT3JnYW5pemF0aW9uU2VsZWN0b3JDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWFkbWlub3JnYW5pemF0aW9uLXNlbGVjdG9yJztcclxuXHJcbmNvbnN0IEFkbWluT3JnYW5pemF0aW9uU2VsZWN0b3JEZWZhdXRPcHRpb24gPSB7XHJcbiAgYWJzT3JnVHlwZTogJ1N5c3RlbV9vcmdhbml6YXRpb24nLFxyXG4gIHJlYWRvbmx5OiBmYWxzZSxcclxuICBwbGFjZWhvbGRlcjogJ+ivt+mAieaLqScsXHJcbiAgYnVzTnVtOiAnY29tbW9uJyxcclxuICBwcmltYXJ5RmllbGQ6ICdvcmdJZCcsXHJcbiAgZGlzcGxheUZpZWxkOiAnbmFtZSdcclxufTtcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAnZmFycmlzLWdyaWQtYWRtaW5vcmdhbml6YXRpb24tc2VsZWN0b3InLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9ncmlkLWFkbWlub3JnYW5pemF0aW9uLXNlbGVjdG9yLmNvbXBvbmVudC5odG1sJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgRGF0YUdyaWRBZG1pbk9yZ2FuaXphdGlvblNlbGVjdG9yQ29tcG9uZW50IGV4dGVuZHMgRGF0YWdyaWRCYXNlRWRpdG9yRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcclxuXHJcbiAgICBAVmlld0NoaWxkKCdvcmdTZWxlY3Rpb24nKSBpbnN0YW5jZTogQWRtaW5Pcmdhbml6YXRpb25TZWxlY3RvckNvbXBvbmVudCAmIHsgY2xlYXI6IEV2ZW50RW1pdHRlcjxhbnk+OyBzZWxlY3RlZERhdGE6IEV2ZW50RW1pdHRlcjxhbnk+IH07XHJcblxyXG4gICAgYmluZGluZ0RhdGE6IGFueTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICByZW5kZXI6IFJlbmRlcmVyMixcclxuICAgICAgICBlbDogRWxlbWVudFJlZixcclxuICAgICAgICBwcml2YXRlIHJ0czogUnVudGltZVN0YXRlU2VydmljZSxcclxuICAgICAgICBwdWJsaWMgdXRpbHM6IENvbW1vblV0aWxzLFxyXG4gICAgICAgIGluamVjdG9yOiBJbmplY3RvclxyXG4gICAgKSB7XHJcbiAgICAgICAgc3VwZXIocmVuZGVyLCBlbCwgaW5qZWN0b3IpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25Jbml0KCkge1xyXG4gICAgICAgIHN1cGVyLm5nT25Jbml0KCk7XHJcbiAgICAgICAgdGhpcy5vcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgQWRtaW5Pcmdhbml6YXRpb25TZWxlY3RvckRlZmF1dE9wdGlvbiwgb21pdEJ5KHRoaXMub3B0aW9ucywgKGl0ZW1WYWx1ZSkgPT4gaXNVbmRlZmluZWQoaXRlbVZhbHVlKSB8fCBpc051bGwoaXRlbVZhbHVlKSkpO1xyXG4gICAgICAgIHRoaXMuaW5zdGFuY2Uuc2VsZWN0ZWREYXRhID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcbiAgICAgICAgdGhpcy5pbnN0YW5jZS5jbGVhciA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmlucHV0RWxlbWVudCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudDtcclxuICAgICAgICBzdXBlci5uZ0FmdGVyVmlld0luaXQoKTtcclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICB0aGlzLmluc3RhbmNlLm5nQ29udHJvbCAmJlxyXG4gICAgICAgICAgdGhpcy5pbnN0YW5jZS5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZSAmJlxyXG4gICAgICAgICAgdGhpcy5pbnN0YW5jZS5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtICYmXHJcbiAgICAgICAgICB0aGlzLmluc3RhbmNlLm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0uYmluZGluZ0RhdGFcclxuICAgICAgICApIHtcclxuICAgICAgICAgIHRoaXMuYmluZGluZ0RhdGEgPSB0aGlzLmluc3RhbmNlLm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0uYmluZGluZ0RhdGE7XHJcbiAgICAgICAgICB0aGlzLmJpbmRpbmdEYXRhLnNldFZhbHVlID0gKGZpZWxkUGF0aCkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy51dGlscy5zZXRWYWx1ZShmaWVsZFBhdGguam9pbignLicpLCB0aGlzLmJpbmRpbmdEYXRhLCB0cnVlKTtcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICB0aGlzLmJpbmRpbmdEYXRhLmdldFZhbHVlID0gKGZpZWxkUGF0aCkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy51dGlscy5nZXRWYWx1ZShmaWVsZFBhdGguam9pbignLicpLCB0aGlzLmJpbmRpbmdEYXRhLCB0cnVlKTtcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGxvb2t1cEZpZWxkTWFwID0gKGhlbHBEYXRhOiBhbnksIG1hcEZpZWxkczogYW55LCBkYXRhT2JqOiBhbnkpID0+IHtcclxuICAgICAgICBpZiAobWFwRmllbGRzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGhlbHBGaWVsZHMgPSBPYmplY3Qua2V5cyhtYXBGaWVsZHMpO1xyXG4gICAgICAgICAgICBoZWxwRmllbGRzLmZvckVhY2goKGhlbHBGaWVsZDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBsZXQgdmFsID0gJyc7XHJcbiAgICAgICAgICAgICAgICBpZiAoaGVscERhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaGVscERhdGEgaW5zdGFuY2VvZiBBcnJheSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSBoZWxwRGF0YS5tYXAoKGRhdGE6IGFueSkgPT4geyByZXR1cm4gdGhpcy51dGlscy5nZXRWYWx1ZShoZWxwRmllbGQsIGRhdGEpOyB9KS5qb2luKCcsJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gdGhpcy51dGlscy5nZXRWYWx1ZShoZWxwRmllbGQsIGhlbHBEYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBtYXBGaWVsZHNbaGVscEZpZWxkXS5zcGxpdCgnLCcpLmZvckVhY2goKGZmOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBmb3JtRmllbGQgPSB0cmltKGZmKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnV0aWxzLnNldFZhbHVlKGRhdGFPYmosIGZvcm1GaWVsZCwgdmFsKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlQ29udHJvbFZhbHVlKHNlbGVjdGVkUm93OiBhbnkpIHtcclxuICAgICAgICBpZiAodGhpcy5pbnN0YW5jZS5tYXBGaWVsZHMgJiYgdGhpcy5iaW5kaW5nRGF0YSkge1xyXG4gICAgICAgICAgICB0aGlzLmxvb2t1cEZpZWxkTWFwKHNlbGVjdGVkUm93LCB0aGlzLmluc3RhbmNlLm1hcEZpZWxkcywgdGhpcy5iaW5kaW5nRGF0YSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlucHV0Q2xlYXIoKSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGVDb250cm9sVmFsdWUobnVsbCk7XHJcbiAgICAgICAgdGhpcy5pbnN0YW5jZS5jbGVhci5lbWl0KCk7XHJcbiAgICAgICAgLy8g6K6+6K6h5Zmo5LiK6YWN572u55qE5riF56m65LqL5Lu2XHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5pbnB1dENsZWFyKSB7XHJcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5pbnB1dENsZWFyKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHRhZ1JlbW92ZWQocmVtb3ZlZEl0ZW06IHtcclxuICAgICAgICBkZWxldGVJdGVtOiBhbnksXHJcbiAgICAgICAgZGVsZXRlSW5kZXg6IG51bWJlcixcclxuICAgICAgICBzZWxlY3Rpb25zOiBBcnJheTxhbnk+XHJcbiAgICB9KSB7XHJcbiAgICAgICAgY29uc3QgbWFwRmllbGRzID0gdGhpcy5pbnN0YW5jZS5tYXBGaWVsZHM7XHJcbiAgICAgICAgY29uc3QgaGVscEZpZWxkcyA9IE9iamVjdC5rZXlzKG1hcEZpZWxkcyk7XHJcbiAgICAgICAgY29uc3QgYmluZGluZ0RhdGEgPSBfLmNsb25lRGVlcCh0aGlzLmJpbmRpbmdEYXRhKTtcclxuICAgICAgICBjb25zdCBzZWxlY3RlZERhdGEgPSBbXTtcclxuICAgIFxyXG4gICAgICAgIGhlbHBGaWVsZHMuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICAgICAgbGV0IHZhbHVlID0gdGhpcy51dGlscy5nZXRWYWx1ZShtYXBGaWVsZHNba2V5XSwgYmluZGluZ0RhdGEpO1xyXG4gICAgICAgICAgY29uc3QgdkFyciA9IHZhbHVlLnNwbGl0KCcsJyk7XHJcbiAgICAgICAgICB2QXJyLnNwbGljZShyZW1vdmVkSXRlbS5kZWxldGVJbmRleCwgMSk7XHJcbiAgICAgICAgICB2QXJyLmZvckVhY2goKHYsIGkpID0+IHtcclxuICAgICAgICAgICAgaWYgKCFzZWxlY3RlZERhdGFbaV0pIHtcclxuICAgICAgICAgICAgICBzZWxlY3RlZERhdGEucHVzaCh7IGluZGV4OiBpIH0pO1xyXG4gICAgICAgICAgICAgIHNlbGVjdGVkRGF0YVtpXVtrZXldID0gdjtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICBzZWxlY3RlZERhdGFbaV1ba2V5XSA9IHY7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgdmFsdWUgPSB2QXJyLmpvaW4oJywnKTtcclxuICAgICAgICAgIHRoaXMudXRpbHMuc2V0VmFsdWUodGhpcy5iaW5kaW5nRGF0YSwgbWFwRmllbGRzW2tleV0sIHZhbHVlKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAoc2VsZWN0ZWREYXRhLmxlbmd0aCkge1xyXG4gICAgICAgICAgdGhpcy5pbnN0YW5jZS5zZWxlY3RlZERhdGEuZW1pdChzZWxlY3RlZERhdGEpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLmluc3RhbmNlLmNsZWFyLmVtaXQoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g6K6+6K6h5Zmo5LiK6YWN572u55qE5Yig6Zmk5Y2V5Liq5qCH562+5LqL5Lu2XHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy50YWdSZW1vdmVkKSB7XHJcbiAgICAgICAgICB0aGlzLm9wdGlvbnMudGFnUmVtb3ZlZCh0aGlzLmV2ZW50UHJhbXMocmVtb3ZlZEl0ZW0pKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc2VsZWN0aW9uc0NoYW5nZShjaGFuZ2VEYXRhOiB7XHJcbiAgICAgICAgaW5mbzogc3RyaW5nLFxyXG4gICAgICAgIGRhdGE6IEFycmF5PGFueT5cclxuICAgIH0pIHtcclxuICAgICAgY29uc3QgZm9ybWVkU2VsZWN0aW9ucyA9IHRoaXMuZm9ybVNlbGVjdGVkUm93RGF0YSgpO1xyXG4gICAgICB0aGlzLnVwZGF0ZUNvbnRyb2xWYWx1ZShmb3JtZWRTZWxlY3Rpb25zKTtcclxuICAgICAgdGhpcy5pbnN0YW5jZS5zZWxlY3RlZERhdGEuZW1pdChmb3JtZWRTZWxlY3Rpb25zKTtcclxuICAgICAgLy8g6K6+6K6h5Zmo5LiK6YWN572u55qE6YCJ5Lit5pWw5o2u5ZCO5LqL5Lu2XHJcbiAgICAgIGlmICh0aGlzLm9wdGlvbnMuc2VsZWN0aW9uc0NoYW5nZSkge1xyXG4gICAgICAgIHRoaXMub3B0aW9ucy5zZWxlY3Rpb25zQ2hhbmdlKHRoaXMuZXZlbnRQcmFtcyhjaGFuZ2VEYXRhKSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmb3JtU2VsZWN0ZWRSb3dEYXRhKCkge1xyXG4gICAgICBsZXQgc2VsZWN0ZWRSb3dEYXRhID0gW107XHJcbiAgICAgIHRoaXMuaW5zdGFuY2Uuc2VsZWN0aW9ucy5mb3JFYWNoKChpdGVtKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZGVmYXVsdERpc3BsYXlOYW1lID0gdGhpcy5pbnN0YW5jZS5kaXNwbGF5RmllbGQgPyBpdGVtW3RoaXMuaW5zdGFuY2UuZGlzcGxheUZpZWxkXSA6IGAke2l0ZW0ubmFtZX1gO1xyXG4gICAgICAgIGNvbnN0IGRpc3BsYXlOYW1lID0gdGhpcy5pbnN0YW5jZS5mb3JtYXRGbiA/IHRoaXMuaW5zdGFuY2UuZm9ybWF0Rm4oaXRlbSkgOiBkZWZhdWx0RGlzcGxheU5hbWU7XHJcbiAgICAgICAgc2VsZWN0ZWRSb3dEYXRhLnB1c2goT2JqZWN0LmFzc2lnbih7fSwgaXRlbSwgeyBkaXNwbGF5TmFtZSB9KSk7XHJcbiAgICAgIH0pXHJcbiAgICAgIHJldHVybiBzZWxlY3RlZFJvd0RhdGEubGVuZ3RoID8gc2VsZWN0ZWRSb3dEYXRhIDogbnVsbDtcclxuICAgIH1cclxuICBcclxuICAgIHByaXZhdGUgZXZlbnRQcmFtcygkZXZlbnQpOiBhbnkge1xyXG4gICAgICBjb25zdCBwID0gdGhpcy5ldmVudFBhcmFtcygkZXZlbnQpO1xyXG4gICAgICBwWydpbnN0YW5jZSddID0gdGhpcy5pbnN0YW5jZTtcclxuICAgICAgcFsnZWRpdG9yJ10gPSB0aGlzO1xyXG4gICAgICByZXR1cm4gcDtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IEFkbWluT3JnYW5pemF0aW9uU2VsZWN0b3JEYXRhR3JpZEVkaXRvclByb3ZpZGVyID0geyBwcm92aWRlOiBHUklEX0VESVRPUlMsIHVzZVZhbHVlOiB7IG5hbWU6ICdBZG1pbk9yZ2FuaXphdGlvblNlbGVjdG9yJywgdmFsdWU6IERhdGFHcmlkQWRtaW5Pcmdhbml6YXRpb25TZWxlY3RvckNvbXBvbmVudCB9LCBtdWx0aTogdHJ1ZSB9XHJcbiJdfQ==