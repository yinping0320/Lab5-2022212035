/**
 * @fileoverview added by tsickle
 * Generated from: lib/grid-employee-selector/grid-employee-selector.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ElementRef, EventEmitter, Injector, Renderer2, ViewChild } from '@angular/core';
import { CommonUtils, RuntimeStateService } from '@farris/ui-common';
import { GRID_EDITORS } from '@farris/ui-datagrid';
import { DatagridBaseEditorDirective } from '@farris/ui-datagrid-editors';
import * as _ from 'lodash-es';
import { isNull, isUndefined, omitBy, trim } from 'lodash-es';
/** @type {?} */
const employeeSelectorDefautOption = {
    absOrgType: 'System_organization',
    readonly: false,
    placeholder: '请选择',
    viewType: 'tag',
    busNum: 'common',
    idField: 'userId'
};
export class DatagridEmployeeSelectorComponent extends DatagridBaseEditorDirective {
    /**
     * @param {?} render
     * @param {?} el
     * @param {?} rts
     * @param {?} utils
     * @param {?} injector
     */
    constructor(render, el, rts, utils, injector) {
        super(render, el, injector);
        this.rts = rts;
        this.utils = utils;
        this.lookupFieldMap = (/**
         * @param {?} helpData
         * @param {?} mapFields
         * @param {?} dataObj
         * @return {?}
         */
        (helpData, mapFields, dataObj) => {
            if (mapFields) {
                /** @type {?} */
                const helpFields = Object.keys(mapFields);
                helpFields.forEach((/**
                 * @param {?} f
                 * @return {?}
                 */
                (f) => {
                    /** @type {?} */
                    let val = '';
                    if (helpData) {
                        if (helpData instanceof Array) {
                            val = helpData.map((/**
                             * @param {?} h
                             * @return {?}
                             */
                            (h) => {
                                return this.utils.getValue(f, h);
                            })).join(',');
                        }
                        else {
                            val = this.utils.getValue(f, helpData);
                        }
                    }
                    mapFields[f].split(',').forEach((/**
                     * @param {?} ff
                     * @return {?}
                     */
                    (ff) => {
                        /** @type {?} */
                        const field = trim(ff);
                        this.utils.setValue(dataObj, field, val);
                    }));
                }));
            }
        });
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        super.ngOnInit();
        // 这里添加了过滤 this.options 中null、undefined,万一 jit 生成了 undefined 的呢，
        this.options = Object.assign({}, employeeSelectorDefautOption, omitBy(this.options, (/**
         * @param {?} itemValue
         * @return {?}
         */
        (itemValue) => isUndefined(itemValue) || isNull(itemValue))));
        this.instance.selectedData = new EventEmitter();
        this.instance.clear = new EventEmitter();
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.inputElement = this.el.nativeElement;
        super.ngAfterViewInit();
        if (this.instance.ngControl &&
            this.instance.ngControl.formDirective &&
            this.instance.ngControl.formDirective.form &&
            this.instance.ngControl.formDirective.form.bindingData) {
            this.bindingData = this.instance.ngControl.formDirective.form.bindingData;
            this.bindingData.setValue = (/**
             * @param {?} fieldPath
             * @return {?}
             */
            (fieldPath) => {
                return this.utils.setValue(fieldPath.join('.'), this.bindingData, true);
            });
            this.bindingData.getValue = (/**
             * @param {?} fieldPath
             * @return {?}
             */
            (fieldPath) => {
                return this.utils.getValue(fieldPath.join('.'), this.bindingData, true);
            });
        }
    }
    /**
     * @return {?}
     */
    inputClear() {
        this.updateControlValue(null);
        this.instance.clear.emit();
        if (this.options.inputClear) {
            // 设计器上配置的清空事件
            this.options.inputClear();
        }
    }
    /**
     * @param {?} removedItem
     * @return {?}
     */
    tagRemoved(removedItem) {
        /** @type {?} */
        const mapFields = this.instance.mapFields;
        /** @type {?} */
        const helpFields = Object.keys(mapFields);
        /** @type {?} */
        const bindingData = _.cloneDeep(this.bindingData);
        /** @type {?} */
        const selectedData = [];
        helpFields.forEach((/**
         * @param {?} key
         * @return {?}
         */
        key => {
            /** @type {?} */
            let value = this.utils.getValue(mapFields[key], bindingData);
            /** @type {?} */
            const vArr = value.split(',');
            vArr.splice(removedItem.deleteIndex, 1);
            vArr.forEach((/**
             * @param {?} v
             * @param {?} i
             * @return {?}
             */
            (v, i) => {
                if (!selectedData[i]) {
                    selectedData.push({ index: i });
                    selectedData[i][key] = v;
                }
                else {
                    selectedData[i][key] = v;
                }
            }));
            value = vArr.join(',');
            this.utils.setValue(this.bindingData, mapFields[key], value);
        }));
        if (selectedData.length) {
            this.instance.selectedData.emit(selectedData);
        }
        else {
            this.instance.clear.emit();
        }
        // 设计器上配置的删除单个标签事件
        if (this.options.tagRemoved) {
            this.options.tagRemoved(this.eventPrams(removedItem));
        }
    }
    /**
     * @param {?} changeData
     * @return {?}
     */
    selectionsChange(changeData) {
        /** @type {?} */
        const formedSelections = this.formSelectedRowData();
        this.updateControlValue(formedSelections);
        this.instance.selectedData.emit(formedSelections);
        // 设计器上配置的选中数据后事件
        if (this.options.selectionsChange) {
            this.options.selectionsChange(this.eventPrams(changeData));
        }
    }
    /**
     * @param {?} selectedRow
     * @return {?}
     */
    updateControlValue(selectedRow) {
        if (this.instance.mapFields && this.bindingData) {
            this.lookupFieldMap(selectedRow, this.instance.mapFields, this.bindingData);
        }
    }
    /**
     * @return {?}
     */
    formSelectedRowData() {
        /** @type {?} */
        let selectedRowData = [];
        this.instance.selections.forEach((/**
         * @param {?} item
         * @return {?}
         */
        (item) => {
            /** @type {?} */
            const defaultDisplayName = this.instance.displayField ? item[this.instance.displayField] : `[${item.code}]${item.name}`;
            /** @type {?} */
            const displayName = this.instance.formatFn ? this.instance.formatFn(item) : defaultDisplayName;
            selectedRowData.push(Object.assign({}, item, { displayName }));
        }));
        return selectedRowData.length ? selectedRowData : null;
    }
    /**
     * @private
     * @param {?} $event
     * @return {?}
     */
    eventPrams($event) {
        /** @type {?} */
        const p = this.eventParams($event);
        p['instance'] = this.instance;
        p['editor'] = this;
        return p;
    }
}
DatagridEmployeeSelectorComponent.decorators = [
    { type: Component, args: [{
                selector: 'farris-grid-employee-selector',
                template: "<div [formGroup]=\"group\" class=\"f-datagrid-cell-formgroup farris-group-auto\">\r\n    <farris-employee-selector #selection style=\"width: 100%\"\r\n      [placeholder]=\"options.placeholder\" [enableQuick]=\"false\" [readonly]=\"options.readonly\" [absOrgType]=\"options.absOrgType\"\r\n      [viewType]=\"options.viewType\" [multiSelect]=\"options.multiSelect\" [busNum]=\"options.busNum\" [mapFields]=\"options.mapFields\"\r\n      [formatFn]=\"options.formatter\" [formControlName]=\"column.field\" [idField]=\"options.idField\" [displayField]=\"options.textField\"\r\n      [showTabIds]=\"options.showTabIds\" [enableHierarchicalLoading]=\"options.enableHierarchicalLoading\" [filterId]=\"options.filterId\"\r\n      (inputClear)=\"inputClear()\" (selectionsChange)=\"selectionsChange($event)\" (tagRemoved)=\"tagRemoved($event)\">\r\n    </farris-employee-selector>\r\n</div>"
            }] }
];
/** @nocollapse */
DatagridEmployeeSelectorComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef },
    { type: RuntimeStateService },
    { type: CommonUtils },
    { type: Injector }
];
DatagridEmployeeSelectorComponent.propDecorators = {
    instance: [{ type: ViewChild, args: ['selection',] }]
};
if (false) {
    /** @type {?} */
    DatagridEmployeeSelectorComponent.prototype.instance;
    /** @type {?} */
    DatagridEmployeeSelectorComponent.prototype.bindingData;
    /** @type {?} */
    DatagridEmployeeSelectorComponent.prototype.lookupFieldMap;
    /**
     * @type {?}
     * @private
     */
    DatagridEmployeeSelectorComponent.prototype.rts;
    /** @type {?} */
    DatagridEmployeeSelectorComponent.prototype.utils;
}
/** @type {?} */
export const EmployeeSelectorDataGridEditorProvider = { provide: GRID_EDITORS, useValue: { name: 'EmployeeSelector', value: DatagridEmployeeSelectorComponent }, multi: true };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JpZC1lbXBsb3llZS1zZWxlY3Rvci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRhdGFncmlkLWRmZi1lZGl0b3JzLyIsInNvdXJjZXMiOlsibGliL2dyaWQtZW1wbG95ZWUtc2VsZWN0b3IvZ3JpZC1lbXBsb3llZS1zZWxlY3Rvci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQWlCLFNBQVMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLFFBQVEsRUFBVSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNILE9BQU8sRUFBRSxXQUFXLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNyRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkQsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDMUUsT0FBTyxLQUFLLENBQUMsTUFBTSxXQUFXLENBQUM7QUFDL0IsT0FBTyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQzs7TUFHeEQsNEJBQTRCLEdBQUc7SUFDbkMsVUFBVSxFQUFFLHFCQUFxQjtJQUNqQyxRQUFRLEVBQUUsS0FBSztJQUNmLFdBQVcsRUFBRSxLQUFLO0lBQ2xCLFFBQVEsRUFBRSxLQUFLO0lBQ2YsTUFBTSxFQUFFLFFBQVE7SUFDaEIsT0FBTyxFQUFFLFFBQVE7Q0FDbEI7QUFNRCxNQUFNLE9BQU8saUNBQWtDLFNBQVEsMkJBQTJCOzs7Ozs7OztJQU1oRixZQUNFLE1BQWlCLEVBQ2pCLEVBQWMsRUFDTixHQUF3QixFQUN6QixLQUFrQixFQUN6QixRQUFrQjtRQUNsQixLQUFLLENBQUMsTUFBTSxFQUFFLEVBQUUsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUhwQixRQUFHLEdBQUgsR0FBRyxDQUFxQjtRQUN6QixVQUFL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LFVBQVUsQ0FBQyxNQUFNOztjQUNqQixDQUFDLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUM7UUFDbEMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDOUIsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNuQixPQUFPLENBQUMsQ0FBQztJQUNYLENBQUM7OztZQXhKRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLCtCQUErQjtnQkFDekMsKzNCQUFzRDthQUN2RDs7OztZQXBCOEUsU0FBUztZQUFyRCxVQUFVO1lBQ3ZCLG1CQUFtQjtZQUFoQyxXQUFXO1lBRHlDLFFBQVE7Ozt1QkF1QmxFLFNBQVMsU0FBQyxXQUFXOzs7O0lBQXRCLHFEQUE0SDs7SUFFNUgsd0RBQWlCOztJQWdEakIsMkRBc0JDOzs7OztJQWpFQyxnREFBZ0M7O0lBQ2hDLGtEQUF5Qjs7O0FBOEk3QixNQUFNLE9BQU8sc0NBQXNDLEdBQUcsRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLFFBQVEsRUFBRSxFQUFFLElBQUksRUFBRSxrQkFBa0IsRUFBRSxLQUFLLEVBQUUsaUNBQWlDLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWZ0ZXJWaWV3SW5pdCwgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIEluamVjdG9yLCBPbkluaXQsIFJlbmRlcmVyMiwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IENvbW1vblV0aWxzLCBSdW50aW1lU3RhdGVTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24nO1xyXG5pbXBvcnQgeyBHUklEX0VESVRPUlMgfSBmcm9tICdAZmFycmlzL3VpLWRhdGFncmlkJztcclxuaW1wb3J0IHsgRGF0YWdyaWRCYXNlRWRpdG9yRGlyZWN0aXZlIH0gZnJvbSAnQGZhcnJpcy91aS1kYXRhZ3JpZC1lZGl0b3JzJztcclxuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gtZXMnO1xyXG5pbXBvcnQgeyBpc051bGwsIGlzVW5kZWZpbmVkLCBvbWl0QnksIHRyaW0gfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG5pbXBvcnQgeyBFbXBsb3llZVNlbGVjdG9yQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1lbXBsb3llZS1zZWxlY3Rvcic7XHJcblxyXG5jb25zdCBlbXBsb3llZVNlbGVjdG9yRGVmYXV0T3B0aW9uID0ge1xyXG4gIGFic09yZ1R5cGU6ICdTeXN0ZW1fb3JnYW5pemF0aW9uJyxcclxuICByZWFkb25seTogZmFsc2UsXHJcbiAgcGxhY2Vob2xkZXI6ICfor7fpgInmi6knLFxyXG4gIHZpZXdUeXBlOiAndGFnJyxcclxuICBidXNOdW06ICdjb21tb24nLFxyXG4gIGlkRmllbGQ6ICd1c2VySWQnXHJcbn07XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ2ZhcnJpcy1ncmlkLWVtcGxveWVlLXNlbGVjdG9yJyxcclxuICB0ZW1wbGF0ZVVybDogJy4vZ3JpZC1lbXBsb3llZS1zZWxlY3Rvci5jb21wb25lbnQuaHRtbCdcclxufSlcclxuZXhwb3J0IGNsYXNzIERhdGFncmlkRW1wbG95ZWVTZWxlY3RvckNvbXBvbmVudCBleHRlbmRzIERhdGFncmlkQmFzZUVkaXRvckRpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCB7XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ3NlbGVjdGlvbicpIGluc3RhbmNlOiBFbXBsb3llZVNlbGVjdG9yQ29tcG9uZW50ICYgeyBjbGVhcjogRXZlbnRFbWl0dGVyPGFueT47IHNlbGVjdGVkRGF0YTogRXZlbnRFbWl0dGVyPGFueT4gfTtcclxuXHJcbiAgYmluZGluZ0RhdGE6IGFueTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICByZW5kZXI6IFJlbmRlcmVyMixcclxuICAgIGVsOiBFbGVtZW50UmVmLFxyXG4gICAgcHJpdmF0ZSBydHM6IFJ1bnRpbWVTdGF0ZVNlcnZpY2UsXHJcbiAgICBwdWJsaWMgdXRpbHM6IENvbW1vblV0aWxzLFxyXG4gICAgaW5qZWN0b3I6IEluamVjdG9yKSB7XHJcbiAgICBzdXBlcihyZW5kZXIsIGVsLCBpbmplY3Rvcik7XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgIHN1cGVyLm5nT25Jbml0KCk7XHJcbiAgICAvLyDov5nph4zmt7vliqDkuobov4fmu6QgdGhpcy5vcHRpb25zIOS4rW51bGzjgIF1bmRlZmluZWQs5LiH5LiAIGppdCDnlJ/miJDkuoYgdW5kZWZpbmVkIOeahOWRou+8jFxyXG4gICAgdGhpcy5vcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgZW1wbG95ZWVTZWxlY3RvckRlZmF1dE9wdGlvbiwgb21pdEJ5KHRoaXMub3B0aW9ucywgKGl0ZW1WYWx1ZSkgPT4gaXNVbmRlZmluZWQoaXRlbVZhbHVlKSB8fCBpc051bGwoaXRlbVZhbHVlKSkpO1xyXG4gICAgdGhpcy5pbnN0YW5jZS5zZWxlY3RlZERhdGEgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuICAgIHRoaXMuaW5zdGFuY2UuY2xlYXIgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuICB9XHJcblxyXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcclxuICAgIHRoaXMuaW5wdXRFbGVtZW50ID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50O1xyXG4gICAgc3VwZXIubmdBZnRlclZpZXdJbml0KCk7XHJcbiAgICBpZiAoXHJcbiAgICAgIHRoaXMuaW5zdGFuY2UubmdDb250cm9sICYmXHJcbiAgICAgIHRoaXMuaW5zdGFuY2UubmdDb250cm9sLmZvcm1EaXJlY3RpdmUgJiZcclxuICAgICAgdGhpcy5pbnN0YW5jZS5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtICYmXHJcbiAgICAgIHRoaXMuaW5zdGFuY2UubmdDb250cm9sLmZvcm1EaXJlY3RpdmUuZm9ybS5iaW5kaW5nRGF0YVxyXG4gICAgKSB7XHJcbiAgICAgIHRoaXMuYmluZGluZ0RhdGEgPSB0aGlzLmluc3RhbmNlLm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0uYmluZGluZ0RhdGE7XHJcbiAgICAgIHRoaXMuYmluZGluZ0RhdGEuc2V0VmFsdWUgPSAoZmllbGRQYXRoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudXRpbHMuc2V0VmFsdWUoZmllbGRQYXRoLmpvaW4oJy4nKSwgdGhpcy5iaW5kaW5nRGF0YSwgdHJ1ZSk7XHJcbiAgICAgIH07XHJcbiAgICAgIHRoaXMuYmluZGluZ0RhdGEuZ2V0VmFsdWUgPSAoZmllbGRQYXRoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudXRpbHMuZ2V0VmFsdWUoZmllbGRQYXRoLmpvaW4oJy4nKSwgdGhpcy5iaW5kaW5nRGF0YSwgdHJ1ZSk7XHJcbiAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gIH1cclxuXHJcbiAgaW5wdXRDbGVhcigpIHtcclxuICAgIHRoaXMudXBkYXRlQ29udHJvbFZhbHVlKG51bGwpO1xyXG4gICAgdGhpcy5pbnN0YW5jZS5jbGVhci5lbWl0KCk7XHJcbiAgICBpZiAodGhpcy5vcHRpb25zLmlucHV0Q2xlYXIpIHtcclxuICAgICAgLy8g6K6+6K6h5Zmo5LiK6YWN572u55qE5riF56m65LqL5Lu2XHJcbiAgICAgIHRoaXMub3B0aW9ucy5pbnB1dENsZWFyKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBsb29rdXBGaWVsZE1hcCA9IChoZWxwRGF0YSwgbWFwRmllbGRzLCBkYXRhT2JqKSA9PiB7XHJcbiAgICBpZiAobWFwRmllbGRzKSB7XHJcbiAgICAgIGNvbnN0IGhlbHBGaWVsZHMgPSBPYmplY3Qua2V5cyhtYXBGaWVsZHMpO1xyXG4gICAgICBoZWxwRmllbGRzLmZvckVhY2goKGY6IGFueSkgPT4ge1xyXG4gICAgICAgIGxldCB2YWwgPSAnJztcclxuICAgICAgICBpZiAoaGVscERhdGEpIHtcclxuICAgICAgICAgIGlmIChoZWxwRGF0YSBpbnN0YW5jZW9mIEFycmF5KSB7XHJcbiAgICAgICAgICAgIHZhbCA9IGhlbHBEYXRhLm1hcCgoaDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudXRpbHMuZ2V0VmFsdWUoZiwgaCk7XHJcbiAgICAgICAgICAgIH0pLmpvaW4oJywnKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHZhbCA9IHRoaXMudXRpbHMuZ2V0VmFsdWUoZiwgaGVscERhdGEpO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIG1hcEZpZWxkc1tmXS5zcGxpdCgnLCcpLmZvckVhY2goKGZmOiBhbnkpID0+IHtcclxuICAgICAgICAgIGNvbnN0IGZpZWxkID0gdHJpbShmZik7XHJcbiAgICAgICAgICB0aGlzLnV0aWxzLnNldFZhbHVlKGRhdGFPYmosIGZpZWxkLCB2YWwpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHRhZ1JlbW92ZWQocmVtb3ZlZEl0ZW06IHtcclxuICAgIGRlbGV0ZUl0ZW06IGFueSxcclxuICAgIGRlbGV0ZUluZGV4OiBOdW1iZXIsXHJcbiAgICBzZWxlY3Rpb25zOiBBcnJheTxhbnk+XHJcbiAgfSkge1xyXG4gICAgY29uc3QgbWFwRmllbGRzID0gdGhpcy5pbnN0YW5jZS5tYXBGaWVsZHM7XHJcbiAgICBjb25zdCBoZWxwRmllbGRzID0gT2JqZWN0LmtleXMobWFwRmllbGRzKTtcclxuICAgIGNvbnN0IGJpbmRpbmdEYXRhID0gXy5jbG9uZURlZXAodGhpcy5iaW5kaW5nRGF0YSk7XHJcbiAgICBjb25zdCBzZWxlY3RlZERhdGEgPSBbXTtcclxuXHJcbiAgICBoZWxwRmllbGRzLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgbGV0IHZhbHVlID0gdGhpcy51dGlscy5nZXRWYWx1ZShtYXBGaWVsZHNba2V5XSwgYmluZGluZ0RhdGEpO1xyXG4gICAgICBjb25zdCB2QXJyID0gdmFsdWUuc3BsaXQoJywnKTtcclxuICAgICAgdkFyci5zcGxpY2UocmVtb3ZlZEl0ZW0uZGVsZXRlSW5kZXgsIDEpO1xyXG4gICAgICB2QXJyLmZvckVhY2goKHYsIGkpID0+IHtcclxuICAgICAgICBpZiAoIXNlbGVjdGVkRGF0YVtpXSkge1xyXG4gICAgICAgICAgc2VsZWN0ZWREYXRhLnB1c2goeyBpbmRleDogaSB9KTtcclxuICAgICAgICAgIHNlbGVjdGVkRGF0YVtpXVtrZXldID0gdjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgc2VsZWN0ZWREYXRhW2ldW2tleV0gPSB2O1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIHZhbHVlID0gdkFyci5qb2luKCcsJyk7XHJcbiAgICAgIHRoaXMudXRpbHMuc2V0VmFsdWUodGhpcy5iaW5kaW5nRGF0YSwgbWFwRmllbGRzW2tleV0sIHZhbHVlKTtcclxuICAgIH0pO1xyXG4gICAgaWYgKHNlbGVjdGVkRGF0YS5sZW5ndGgpIHtcclxuICAgICAgdGhpcy5pbnN0YW5jZS5zZWxlY3RlZERhdGEuZW1pdChzZWxlY3RlZERhdGEpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5pbnN0YW5jZS5jbGVhci5lbWl0KCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g6K6+6K6h5Zmo5LiK6YWN572u55qE5Yig6Zmk5Y2V5Liq5qCH562+5LqL5Lu2XHJcbiAgICBpZiAodGhpcy5vcHRpb25zLnRhZ1JlbW92ZWQpIHtcclxuICAgICAgdGhpcy5vcHRpb25zLnRhZ1JlbW92ZWQodGhpcy5ldmVudFByYW1zKHJlbW92ZWRJdGVtKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzZWxlY3Rpb25zQ2hhbmdlKGNoYW5nZURhdGE6IHtcclxuICAgIGluZm86IHN0cmluZyxcclxuICAgIGRhdGE6IEFycmF5PGFueT5cclxuICB9KSB7XHJcbiAgICBjb25zdCBmb3JtZWRTZWxlY3Rpb25zID0gdGhpcy5mb3JtU2VsZWN0ZWRSb3dEYXRhKClcclxuICAgIHRoaXMudXBkYXRlQ29udHJvbFZhbHVlKGZvcm1lZFNlbGVjdGlvbnMpO1xyXG4gICAgdGhpcy5pbnN0YW5jZS5zZWxlY3RlZERhdGEuZW1pdChmb3JtZWRTZWxlY3Rpb25zKTtcclxuICAgIC8vIOiuvuiuoeWZqOS4iumFjee9rueahOmAieS4reaVsOaNruWQjuS6i+S7tlxyXG4gICAgaWYgKHRoaXMub3B0aW9ucy5zZWxlY3Rpb25zQ2hhbmdlKSB7XHJcbiAgICAgIHRoaXMub3B0aW9ucy5zZWxlY3Rpb25zQ2hhbmdlKHRoaXMuZXZlbnRQcmFtcyhjaGFuZ2VEYXRhKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICB1cGRhdGVDb250cm9sVmFsdWUoc2VsZWN0ZWRSb3cpIHtcclxuICAgIGlmICh0aGlzLmluc3RhbmNlLm1hcEZpZWxkcyAmJiB0aGlzLmJpbmRpbmdEYXRhKSB7XHJcbiAgICAgIHRoaXMubG9va3VwRmllbGRNYXAoc2VsZWN0ZWRSb3csIHRoaXMuaW5zdGFuY2UubWFwRmllbGRzLCB0aGlzLmJpbmRpbmdEYXRhKTtcclxuICAgIH1cclxuICB9XHJcblxyXG5cclxuICBmb3JtU2VsZWN0ZWRSb3dEYXRhKCkge1xyXG4gICAgbGV0IHNlbGVjdGVkUm93RGF0YSA9IFtdO1xyXG4gICAgdGhpcy5pbnN0YW5jZS5zZWxlY3Rpb25zLmZvckVhY2goKGl0ZW0pID0+IHtcclxuICAgICAgY29uc3QgZGVmYXVsdERpc3BsYXlOYW1lID0gdGhpcy5pbnN0YW5jZS5kaXNwbGF5RmllbGQgPyBpdGVtW3RoaXMuaW5zdGFuY2UuZGlzcGxheUZpZWxkXSA6IGBbJHtpdGVtLmNvZGV9XSR7aXRlbS5uYW1lfWA7XHJcbiAgICAgIGNvbnN0IGRpc3BsYXlOYW1lID0gdGhpcy5pbnN0YW5jZS5mb3JtYXRGbiA/IHRoaXMuaW5zdGFuY2UuZm9ybWF0Rm4oaXRlbSkgOiBkZWZhdWx0RGlzcGxheU5hbWU7XHJcbiAgICAgIHNlbGVjdGVkUm93RGF0YS5wdXNoKE9iamVjdC5hc3NpZ24oe30sIGl0ZW0sIHsgZGlzcGxheU5hbWUgfSkpO1xyXG4gICAgfSlcclxuICAgIHJldHVybiBzZWxlY3RlZFJvd0RhdGEubGVuZ3RoID8gc2VsZWN0ZWRSb3dEYXRhIDogbnVsbDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZXZlbnRQcmFtcygkZXZlbnQpOiBhbnkge1xyXG4gICAgY29uc3QgcCA9IHRoaXMuZXZlbnRQYXJhbXMoJGV2ZW50KTtcclxuICAgIHBbJ2luc3RhbmNlJ10gPSB0aGlzLmluc3RhbmNlO1xyXG4gICAgcFsnZWRpdG9yJ10gPSB0aGlzO1xyXG4gICAgcmV0dXJuIHA7XHJcbiAgfVxyXG59XHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IEVtcGxveWVlU2VsZWN0b3JEYXRhR3JpZEVkaXRvclByb3ZpZGVyID0geyBwcm92aWRlOiBHUklEX0VESVRPUlMsIHVzZVZhbHVlOiB7IG5hbWU6ICdFbXBsb3llZVNlbGVjdG9yJywgdmFsdWU6IERhdGFncmlkRW1wbG95ZWVTZWxlY3RvckNvbXBvbmVudCB9LCBtdWx0aTogdHJ1ZSB9XHJcbiJdfQ==