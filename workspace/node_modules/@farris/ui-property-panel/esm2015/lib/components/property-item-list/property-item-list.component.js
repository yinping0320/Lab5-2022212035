/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, Input, Output, EventEmitter, ViewChildren, ViewEncapsulation } from '@angular/core';
import { ElementPropertyConfig } from '../../entity/property-entity';
import { PropertyItemComponent } from '../property-item/property-item.component';
export class PropertyItemListComponent {
    // 实际属性值
    constructor() {
        // 属性值
        this.valueChanged = new EventEmitter();
        this.submitModal = new EventEmitter();
        this.triggerRefreshPanel = new EventEmitter();
    }
    /**
     * @param {?} simpleChanges
     * @return {?}
     */
    ngOnChanges(simpleChanges) {
        // 若分类下有propertyData，则取分类下的propertyData；否则取整体的propertyData
        if (this.category.propertyData && this.category.enableCascade) {
            this.data = this.category.propertyData;
        }
        else {
            this.data = this.propertyData;
        }
    }
    /**
     * @return {?}
     */
    refresh() {
        // 若分类下有propertyData，则取分类下的propertyData；否则取整体的propertyData
        if (this.category.propertyData && this.category.enableCascade) {
            this.data = this.category.propertyData;
        }
        else {
            this.data = this.propertyData;
        }
        this.items.forEach((/**
         * @param {?} item
         * @return {?}
         */
        item => item.refresh()));
    }
    /**
     * 一般属性变更
     * @param {?} $event
     * @return {?}
     */
    _itemChanged($event) {
        const { changeObject } = $event;
        this.data[changeObject.propertyID] = changeObject.propertyValue;
        if (this.category.setPropertyRelates && typeof (this.category.setPropertyRelates) === 'function') {
            this.category.setPropertyRelates(changeObject, this.data);
            this.items.forEach((/**
             * @param {?} item
             * @return {?}
             */
            item => item.refresh()));
        }
        changeObject.categoryId = this.category.categoryId;
        if (this.category.enableCascade) {
            changeObject.parentPropertyID = this.category.parentPropertyID;
        }
        this.valueChanged.emit(changeObject);
    }
    /**
     * 模态框数据变更（TODO:待优化，合并valueChange事件）
     * @param {?} $event
     * @return {?}
     */
    _submitModal($event) {
        const { changeObject, parameters } = $event;
        this.data[changeObject.propertyID] = changeObject.propertyValue;
        if (this.category.setPropertyRelates && typeof (this.category.setPropertyRelates) === 'function') {
            this.category.setPropertyRelates(changeObject, this.data, parameters);
            this.items.forEach((/**
             * @param {?} item
             * @return {?}
             */
            item => item.refresh()));
        }
        changeObject.categoryId = this.category.categoryId;
        if (this.category.enableCascade) {
            changeObject.parentPropertyID = this.category.parentPropertyID;
        }
        this.submitModal.emit($event);
    }
    /**
     * 级联属性变更
     * @param {?} $event
     * @param {?} parentPropertyID
     * @return {?}
     */
    _cascadeitemChanged($event, parentPropertyID) {
        if (!parentPropertyID) {
            return;
        }
        const { changeObject } = $event;
        if (!this.data[parentPropertyID]) {
            this.data[parentPropertyID] = {};
        }
        this.data[parentPropertyID][changeObject.propertyID] = changeObject.propertyValue;
        changeObject.categoryId = this.category.categoryId;
        changeObject.parentPropertyID = parentPropertyID;
        if (this.category.setPropertyRelates && typeof (this.category.setPropertyRelates) === 'function') {
            this.category.setPropertyRelates(changeObject, this.data);
            this.items.forEach((/**
             * @param {?} item
             * @return {?}
             */
            item => item.refresh()));
        }
        this.valueChanged.emit(changeObject);
    }
    /**
     * 级联模态框属性变更
     * @param {?} $event
     * @param {?} parentPropertyID
     * @return {?}
     */
    __cascadeitemSubmitModal($event, parentPropertyID) {
        if (!parentPropertyID) {
            return;
        }
        const { changeObject, parameters } = $event;
        if (!this.data[parentPropertyID]) {
            this.data[parentPropertyID] = {};
        }
        this.data[parentPropertyID][changeObject.propertyID] = changeObject.propertyValue;
        changeObject.categoryId = this.category.categoryId;
        changeObject.parentPropertyID = parentPropertyID;
        if (this.category.setPropertyRelates && typeof (this.category.setPropertyRelates) === 'function') {
            this.category.setPropertyRelates(changeObject, this.data, parameters);
            this.items.forEach((/**
             * @param {?} item
             * @return {?}
             */
            item => item.refresh()));
        }
        this.submitModal.emit($event);
    }
    /**
     * 级联属性的汇总信息
     * @param {?} propItem
     * @param {?} valueObject
     * @return {?}
     */
    _valueStringify(propItem, valueObject) {
        if (!propItem || !propItem.cascadeConfig || !valueObject) {
            return '';
        }
        if (!propItem.cascadeConverter || !propItem.cascadeConverter.convertTo) {
            return JSON.stringify(valueObject);
        }
        return propItem.cascadeConverter.convertTo(valueObject, propItem.cascadeConfig);
    }
    /**
     * @param {?} propItem
     * @return {?}
     */
    _checkCascadeVisible(propItem) {
        if (Object.keys(propItem).indexOf('visible') < 0) {
            return true;
        }
        else {
            return propItem.visible;
        }
    }
    /**
     * @return {?}
     */
    refreshPanel() {
        this.triggerRefreshPanel.emit();
    }
}
PropertyItemListComponent.decorators = [
    { type: Component, args: [{
                selector: 'webide-property-item-list',
                template: "<div *ngFor=\"let propItem of category.properties\">\r\n    <div *ngIf=\"propItem.propertyType != 'cascade'\" class=\"px-2\">\r\n        <webide-property-item (valueChanged)=\"_itemChanged($event)\" (submitModal)=\"_submitModal($event)\"\r\n            [elementValue]=\"data[propItem.propertyID]\" [elementConfig]=\"propItem\"></webide-property-item>\r\n    </div>\r\n\r\n    <farris-panel *ngIf=\"propItem.propertyType == 'cascade' && _checkCascadeVisible(propItem)\"\r\n        [defaultExpand]=\"propItem.isExpand\">\r\n        <farris-panel-item class=\"propertyCascadeItem\" [value]=\"propItem.propertyID\">\r\n            <ng-template #headTempl>\r\n                <div class=\"form-group farris-form-group\">\r\n                    <label class=\"col-form-label pl-2\">\r\n                        <span class=\"farris-label-text\">{{propItem.propertyName}}</span>\r\n                    </label>\r\n                    <div class=\"farris-input-wrap\" *ngIf=\"!propItem.hideCascadeTitle\">\r\n                        <input type=\"input\" class=\"form-control form-control-sm\" readonly\r\n                            [value]=\"_valueStringify(propItem,data[propItem.propertyID])\">\r\n                    </div>\r\n                </div>\r\n            </ng-template>\r\n            <ng-template #contentTempl>\r\n                <div *ngFor=\"let cascadeItem of propItem.cascadeConfig\" class=\"px-2\">\r\n                    <webide-property-item (valueChanged)=\"_cascadeitemChanged($event,propItem.propertyID)\"\r\n                        (submitModal)=\"__cascadeitemSubmitModal($event, propItem.propertyID)\"\r\n                        [elementValue]=\"data[propItem.propertyID]?data[propItem.propertyID][cascadeItem.propertyID]:''\"\r\n                        [elementConfig]=\"cascadeItem\" (triggerRefreshPanel)=\"refreshPanel()\"></webide-property-item>\r\n                </div>\r\n\r\n            </ng-template>\r\n        </farris-panel-item>\r\n    </farris-panel>\r\n\r\n\r\n</div>",
                encapsulation: ViewEncapsulation.None,
                styles: [".propertyCascadeItem{background-color:transparent!important;border:none!important}.propertyCascadeItem .card-header{background-color:transparent!important;padding:4px 12px!important;color:inherit!important}.propertyCascadeItem .card-header .panel-item-title{width:100%;position:relative;font-size:inherit!important}.propertyCascadeItem .card-header .panel-item-title .farris-input-wrap{margin-left:-5px;margin-right:-5px}.propertyCascadeItem .f-accordion-collapse,.propertyCascadeItem .f-accordion-expand{right:0;left:auto!important;top:6px;color:#6b94ec!important;position:absolute}.propertyCascadeItem .card-body{padding:3px 12px!important;background:rgba(255,255,255,.8);border-radius:8px;margin:4px 8px}"]
            }] }
];
/** @nocollapse */
PropertyItemListComponent.ctorParameters = () => [];
PropertyItemListComponent.propDecorators = {
    category: [{ type: Input }],
    propertyData: [{ type: Input }],
    valueChanged: [{ type: Output }],
    submitModal: [{ type: Output }],
    triggerRefreshPanel: [{ type: Output }],
    items: [{ type: ViewChildren, args: [PropertyItemComponent,] }]
};
if (false) {
    /** @type {?} */
    PropertyItemListComponent.prototype.category;
    /** @type {?} */
    PropertyItemListComponent.prototype.propertyData;
    /** @type {?} */
    PropertyItemListComponent.prototype.valueChanged;
    /** @type {?} */
    PropertyItemListComponent.prototype.submitModal;
    /** @type {?} */
    PropertyItemListComponent.prototype.triggerRefreshPanel;
    /** @type {?} */
    PropertyItemListComponent.prototype.items;
    /** @type {?} */
    PropertyItemListComponent.prototype.data;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvcGVydHktaXRlbS1saXN0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktcHJvcGVydHktcGFuZWwvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9wcm9wZXJ0eS1pdGVtLWxpc3QvcHJvcGVydHktaXRlbS1saXN0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxLQUFLLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQTRCLGlCQUFpQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFJLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ3JFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBU2pGLE1BQU0sT0FBTyx5QkFBeUI7O0lBVXBDOztRQVBVLGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUN2QyxnQkFBVyxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFDdEMsd0JBQW1CLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztJQUt4QyxDQUFDOzs7OztJQUVqQixXQUFXLENBQUMsYUFBNEI7UUFDdEMsMERBQTBEO1FBQzFELElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLEVBQUU7WUFDN0QsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQztTQUN4QzthQUFNO1lBQ0wsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDO1NBQy9CO0lBQ0gsQ0FBQzs7OztJQUNELE9BQU87UUFDTCwwREFBMEQ7UUFDMUQsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRTtZQUM3RCxJQUFJLENBQUMsSUFBSSxH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YUFBYSxFQUFFLGlCQUFpQixDQUFDLElBQUk7O2FBRXRDOzs7Ozt1QkFFRSxLQUFLOzJCQUNMLEtBQUs7MkJBQ0wsTUFBTTswQkFDTixNQUFNO2tDQUNOLE1BQU07b0JBRU4sWUFBWSxTQUFDLHFCQUFxQjs7OztJQU5uQyw2Q0FBeUM7O0lBQ3pDLGlEQUFzQjs7SUFDdEIsaURBQWlEOztJQUNqRCxnREFBZ0Q7O0lBQ2hELHdEQUF3RDs7SUFFeEQsMENBQXlFOztJQUV6RSx5Q0FBSyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0LCBJbnB1dCwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIFZpZXdDaGlsZHJlbiwgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzLCBWaWV3RW5jYXBzdWxhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBFbGVtZW50UHJvcGVydHlDb25maWcgfSBmcm9tICcuLi8uLi9lbnRpdHkvcHJvcGVydHktZW50aXR5JztcclxuaW1wb3J0IHsgUHJvcGVydHlJdGVtQ29tcG9uZW50IH0gZnJvbSAnLi4vcHJvcGVydHktaXRlbS9wcm9wZXJ0eS1pdGVtLmNvbXBvbmVudCc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ3dlYmlkZS1wcm9wZXJ0eS1pdGVtLWxpc3QnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9wcm9wZXJ0eS1pdGVtLWxpc3QuY29tcG9uZW50Lmh0bWwnLFxyXG4gIHN0eWxlVXJsczogWycuL3Byb3BlcnR5LWl0ZW0tbGlzdC5jb21wb25lbnQuY3NzJ10sXHJcbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZVxyXG5cclxufSlcclxuZXhwb3J0IGNsYXNzIFByb3BlcnR5SXRlbUxpc3RDb21wb25lbnQgaW1wbGVtZW50cyBPbkNoYW5nZXMge1xyXG4gIEBJbnB1dCgpIGNhdGVnb3J5OiBFbGVtZW50UHJvcGVydHlDb25maWc7IC8vIOafkOS4gOWIhuexu+S4i+eahOWxnuaAp+mFjee9rlxyXG4gIEBJbnB1dCgpIHByb3BlcnR5RGF0YTsgLy8g5bGe5oCn5YC8XHJcbiAgQE91dHB1dCgpIHZhbHVlQ2hhbmdlZCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG4gIEBPdXRwdXQoKSBzdWJtaXRNb2RhbCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG4gIEBPdXRwdXQoKSB0cmlnZ2VyUmVmcmVzaFBhbmVsID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcblxyXG4gIEBWaWV3Q2hpbGRyZW4oUHJvcGVydHlJdGVtQ29tcG9uZW50KSBpdGVtczogQXJyYXk8UHJvcGVydHlJdGVtQ29tcG9uZW50PjtcclxuXHJcbiAgZGF0YTsgLy8g5a6e6ZmF5bGe5oCn5YC8XHJcbiAgY29uc3RydWN0b3IoKSB7IH1cclxuXHJcbiAgbmdPbkNoYW5nZXMoc2ltcGxlQ2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xyXG4gICAgLy8g6Iul5YiG57G75LiL5pyJcHJvcGVydHlEYXRh77yM5YiZ5Y+W5YiG57G75LiL55qEcHJvcGVydHlEYXRh77yb5ZCm5YiZ5Y+W5pW05L2T55qEcHJvcGVydHlEYXRhXHJcbiAgICBpZiAodGhpcy5jYXRlZ29yeS5wcm9wZXJ0eURhdGEgJiYgdGhpcy5jYXRlZ29yeS5lbmFibGVDYXNjYWRlKSB7XHJcbiAgICAgIHRoaXMuZGF0YSA9IHRoaXMuY2F0ZWdvcnkucHJvcGVydHlEYXRhO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5kYXRhID0gdGhpcy5wcm9wZXJ0eURhdGE7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHJlZnJlc2goKSB7XHJcbiAgICAvLyDoi6XliIbnsbvkuIvmnIlwcm9wZXJ0eURhdGHvvIzliJnlj5bliIbnsbvkuIvnmoRwcm9wZXJ0eURhdGHvvJvlkKbliJnlj5bmlbTkvZPnmoRwcm9wZXJ0eURhdGFcclxuICAgIGlmICh0aGlzLmNhdGVnb3J5LnByb3BlcnR5RGF0YSAmJiB0aGlzLmNhdGVnb3J5LmVuYWJsZUNhc2NhZGUpIHtcclxuICAgICAgdGhpcy5kYXRhID0gdGhpcy5jYXRlZ29yeS5wcm9wZXJ0eURhdGE7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmRhdGEgPSB0aGlzLnByb3BlcnR5RGF0YTtcclxuICAgIH1cclxuICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IGl0ZW0ucmVmcmVzaCgpKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOS4gOiIrOWxnuaAp+WPmOabtFxyXG4gICAqIEBwYXJhbSAkZXZlbnRcclxuICAgKi9cclxuICBfaXRlbUNoYW5nZWQoJGV2ZW50KSB7XHJcbiAgICBjb25zdCB7IGNoYW5nZU9iamVjdCB9ID0gJGV2ZW50O1xyXG4gICAgdGhpcy5kYXRhW2NoYW5nZU9iamVjdC5wcm9wZXJ0eUlEXSA9IGNoYW5nZU9iamVjdC5wcm9wZXJ0eVZhbHVlO1xyXG5cclxuICAgIGlmICh0aGlzLmNhdGVnb3J5LnNldFByb3BlcnR5UmVsYXRlcyAmJiB0eXBlb2YgKHRoaXMuY2F0ZWdvcnkuc2V0UHJvcGVydHlSZWxhdGVzKSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICB0aGlzLmNhdGVnb3J5LnNldFByb3BlcnR5UmVsYXRlcyhjaGFuZ2VPYmplY3QsIHRoaXMuZGF0YSk7XHJcbiAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IGl0ZW0ucmVmcmVzaCgpKTtcclxuICAgIH1cclxuICAgIGNoYW5nZU9iamVjdC5jYXRlZ29yeUlkID0gdGhpcy5jYXRlZ29yeS5jYXRlZ29yeUlkO1xyXG5cclxuICAgIGlmICh0aGlzLmNhdGVnb3J5LmVuYWJsZUNhc2NhZGUpIHtcclxuICAgICAgY2hhbmdlT2JqZWN0LnBhcmVudFByb3BlcnR5SUQgPSB0aGlzLmNhdGVnb3J5LnBhcmVudFByb3BlcnR5SUQ7XHJcbiAgICB9XHJcbiAgICB0aGlzLnZhbHVlQ2hhbmdlZC5lbWl0KGNoYW5nZU9iamVjdCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmqKHmgIHmoYbmlbDmja7lj5jmm7TvvIhUT0RPOuW+heS8mOWMlu+8jOWQiOW5tnZhbHVlQ2hhbmdl5LqL5Lu277yJXHJcbiAgICogQHBhcmFtICRldmVudFxyXG4gICAqL1xyXG4gIF9zdWJtaXRNb2RhbCgkZXZlbnQpIHtcclxuICAgIGNvbnN0IHsgY2hhbmdlT2JqZWN0LCBwYXJhbWV0ZXJzIH0gPSAkZXZlbnQ7XHJcbiAgICB0aGlzLmRhdGFbY2hhbmdlT2JqZWN0LnByb3BlcnR5SURdID0gY2hhbmdlT2JqZWN0LnByb3BlcnR5VmFsdWU7XHJcblxyXG4gICAgaWYgKHRoaXMuY2F0ZWdvcnkuc2V0UHJvcGVydHlSZWxhdGVzICYmIHR5cGVvZiAodGhpcy5jYXRlZ29yeS5zZXRQcm9wZXJ0eVJlbGF0ZXMpID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIHRoaXMuY2F0ZWdvcnkuc2V0UHJvcGVydHlSZWxhdGVzKGNoYW5nZU9iamVjdCwgdGhpcy5kYXRhLCBwYXJhbWV0ZXJzKTtcclxuICAgICAgdGhpcy5pdGVtcy5mb3JFYWNoKGl0ZW0gPT4gaXRlbS5yZWZyZXNoKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIGNoYW5nZU9iamVjdC5jYXRlZ29yeUlkID0gdGhpcy5jYXRlZ29yeS5jYXRlZ29yeUlkO1xyXG4gICAgaWYgKHRoaXMuY2F0ZWdvcnkuZW5hYmxlQ2FzY2FkZSkge1xyXG4gICAgICBjaGFuZ2VPYmplY3QucGFyZW50UHJvcGVydHlJRCA9IHRoaXMuY2F0ZWdvcnkucGFyZW50UHJvcGVydHlJRDtcclxuICAgIH1cclxuICAgIHRoaXMuc3VibWl0TW9kYWwuZW1pdCgkZXZlbnQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog57qn6IGU5bGe5oCn5Y+Y5pu0XHJcbiAgICogQHBhcmFtICRldmVudFxyXG4gICAqIEBwYXJhbSBwYXJlbnRQcm9wZXJ0eUlEXHJcbiAgICovXHJcbiAgX2Nhc2NhZGVpdGVtQ2hhbmdlZCgkZXZlbnQsIHBhcmVudFByb3BlcnR5SUQpIHtcclxuICAgIGlmICghcGFyZW50UHJvcGVydHlJRCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCB7IGNoYW5nZU9iamVjdCB9ID0gJGV2ZW50O1xyXG4gICAgaWYgKCF0aGlzLmRhdGFbcGFyZW50UHJvcGVydHlJRF0pIHtcclxuICAgICAgdGhpcy5kYXRhW3BhcmVudFByb3BlcnR5SURdID0ge307XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5kYXRhW3BhcmVudFByb3BlcnR5SURdW2NoYW5nZU9iamVjdC5wcm9wZXJ0eUlEXSA9IGNoYW5nZU9iamVjdC5wcm9wZXJ0eVZhbHVlO1xyXG5cclxuICAgIGNoYW5nZU9iamVjdC5jYXRlZ29yeUlkID0gdGhpcy5jYXRlZ29yeS5jYXRlZ29yeUlkO1xyXG4gICAgY2hhbmdlT2JqZWN0LnBhcmVudFByb3BlcnR5SUQgPSBwYXJlbnRQcm9wZXJ0eUlEO1xyXG5cclxuICAgIGlmICh0aGlzLmNhdGVnb3J5LnNldFByb3BlcnR5UmVsYXRlcyAmJiB0eXBlb2YgKHRoaXMuY2F0ZWdvcnkuc2V0UHJvcGVydHlSZWxhdGVzKSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICB0aGlzLmNhdGVnb3J5LnNldFByb3BlcnR5UmVsYXRlcyhjaGFuZ2VPYmplY3QsIHRoaXMuZGF0YSk7XHJcbiAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IGl0ZW0ucmVmcmVzaCgpKTtcclxuICAgIH1cclxuICAgIHRoaXMudmFsdWVDaGFuZ2VkLmVtaXQoY2hhbmdlT2JqZWN0KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOe6p+iBlOaooeaAgeahhuWxnuaAp+WPmOabtFxyXG4gICAqIEBwYXJhbSAkZXZlbnRcclxuICAgKiBAcGFyYW0gcGFyZW50UHJvcGVydHlJRFxyXG4gICAqL1xyXG4gIF9fY2FzY2FkZWl0ZW1TdWJtaXRNb2RhbCgkZXZlbnQsIHBhcmVudFByb3BlcnR5SUQpIHtcclxuICAgIGlmICghcGFyZW50UHJvcGVydHlJRCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCB7IGNoYW5nZU9iamVjdCwgcGFyYW1ldGVycyB9ID0gJGV2ZW50O1xyXG4gICAgaWYgKCF0aGlzLmRhdGFbcGFyZW50UHJvcGVydHlJRF0pIHtcclxuICAgICAgdGhpcy5kYXRhW3BhcmVudFByb3BlcnR5SURdID0ge307XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5kYXRhW3BhcmVudFByb3BlcnR5SURdW2NoYW5nZU9iamVjdC5wcm9wZXJ0eUlEXSA9IGNoYW5nZU9iamVjdC5wcm9wZXJ0eVZhbHVlO1xyXG5cclxuICAgIGNoYW5nZU9iamVjdC5jYXRlZ29yeUlkID0gdGhpcy5jYXRlZ29yeS5jYXRlZ29yeUlkO1xyXG4gICAgY2hhbmdlT2JqZWN0LnBhcmVudFByb3BlcnR5SUQgPSBwYXJlbnRQcm9wZXJ0eUlEO1xyXG5cclxuICAgIGlmICh0aGlzLmNhdGVnb3J5LnNldFByb3BlcnR5UmVsYXRlcyAmJiB0eXBlb2YgKHRoaXMuY2F0ZWdvcnkuc2V0UHJvcGVydHlSZWxhdGVzKSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICB0aGlzLmNhdGVnb3J5LnNldFByb3BlcnR5UmVsYXRlcyhjaGFuZ2VPYmplY3QsIHRoaXMuZGF0YSwgcGFyYW1ldGVycyk7XHJcbiAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaChpdGVtID0+IGl0ZW0ucmVmcmVzaCgpKTtcclxuICAgIH1cclxuICAgIHRoaXMuc3VibWl0TW9kYWwuZW1pdCgkZXZlbnQpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDnuqfogZTlsZ7mgKfnmoTmsYfmgLvkv6Hmga9cclxuICAgKiBAcGFyYW0gcHJvcEl0ZW1cclxuICAgKiBAcGFyYW0gdmFsdWVPYmplY3RcclxuICAgKi9cclxuICBfdmFsdWVTdHJpbmdpZnkocHJvcEl0ZW0sIHZhbHVlT2JqZWN0KSB7XHJcbiAgICBpZiAoIXByb3BJdGVtIHx8ICFwcm9wSXRlbS5jYXNjYWRlQ29uZmlnIHx8ICF2YWx1ZU9iamVjdCkge1xyXG4gICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcbiAgICBpZiAoIXByb3BJdGVtLmNhc2NhZGVDb252ZXJ0ZXIgfHwgIXByb3BJdGVtLmNhc2NhZGVDb252ZXJ0ZXIuY29udmVydFRvKSB7XHJcbiAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh2YWx1ZU9iamVjdCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHByb3BJdGVtLmNhc2NhZGVDb252ZXJ0ZXIuY29udmVydFRvKHZhbHVlT2JqZWN0LCBwcm9wSXRlbS5jYXNjYWRlQ29uZmlnKTtcclxuXHJcblxyXG4gIH1cclxuXHJcbiAgX2NoZWNrQ2FzY2FkZVZpc2libGUocHJvcEl0ZW0pIHtcclxuICAgIGlmIChPYmplY3Qua2V5cyhwcm9wSXRlbSkuaW5kZXhPZigndmlzaWJsZScpIDwgMCkge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBwcm9wSXRlbS52aXNpYmxlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG4gIHJlZnJlc2hQYW5lbCgpIHtcclxuICAgIHRoaXMudHJpZ2dlclJlZnJlc2hQYW5lbC5lbWl0KCk7XHJcbiAgfVxyXG59XHJcbiJdfQ==