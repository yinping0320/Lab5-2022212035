/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, NgZone, Injector, Input, ViewChild } from '@angular/core';
import { HttpService } from '@farris/ide-devkit';
import { TreeTableComponent } from '@farris/ui-treetable';
import { DatagridComponent } from '@farris/ui-datagrid';
import { LocaleService } from '@farris/ui-locale';
export class SelectAppComponent {
    /**
     * @param {?} http
     * @param {?} injector
     * @param {?} ngZone
     */
    constructor(http, injector, ngZone) {
        this.http = http;
        this.injector = injector;
        this.ngZone = ngZone;
        this.serverIp = '';
        this.treeData = [];
        this.funcModel = {};
        this.columns = [];
        this.items = [];
        this.selectedAppID = '';
        this.localeSer = this.injector.get(LocaleService, null);
    }
    /**
     * @return {?}
     */
    get APP_URI() {
        return this.serverIp + '/api/runtime/sys/v1.0/gspapp/all';
    }
    /**
     * @return {?}
     */
    get appId() {
        if (this.tt && this.tt.selectedRow) {
            return this.tt.selectedRow.data.id;
        }
        return '';
    }
    /**
     * @return {?}
     */
    get appInvokId() {
        if (this.grid && this.grid.selectedRow) {
            return this.grid.selectedRow.id;
        }
        return '';
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.initTreeData();
        this.columns = [
            { title: this.localeSer.getValue('publishmenu.app.column.code'), field: 'code', width: 200 },
            { title: this.localeSer.getValue('publishmenu.app.column.name'), field: 'name', width: 150 }
        ];
    }
    /**
     * @param {?} e
     * @return {?}
     */
    treeNodeClicked(e) {
        this.items = e.node.data.appInvoks || [];
        setTimeout((/**
         * @return {?}
         */
        () => {
            if (this.funcModel && Object.keys(this.funcModel).length) {
                /** @type {?} */
                const appInvokId = this.funcModel.appInvokId;
                if (!appInvokId) {
                    return;
                }
                this.grid.selectRow(appInvokId, false);
            }
        }), 100);
        // setTimeout(() => {
        //     if (this.grid && this.items.length) {
        //         this.grid.selectRow(this.items[0].id);
        //     }
        // }, 100);
    }
    /**
     * @private
     * @return {?}
     */
    initTreeData() {
        this.http.get(this.APP_URI).subscribe((/**
         * @param {?} data
         * @return {?}
         */
        data => {
            if (data) {
                this.treeData = this.convert2TreeNodes(data);
                setTimeout((/**
                 * @return {?}
                 */
                () => {
                    if (this.funcModel && Object.keys(this.funcModel).length) {
                        /** @type {?} */
                        const appId = this.funcModel.appId;
                        if (!appId) {
                            return;
                        }
                        /** @type {?} */
                        const treeNode = this.tt.findRowNode(appId);
                        if (treeNode) {
                            treeNode.parents.forEach((/**
                             * @param {?} id
                             * @return {?}
                             */
                            (id) => {
                                this.tt.expandNode(id);
                            }));
                        }
                        this.selectedAppID = appId;
                    }
                }), 200);
            }
        }));
    }
    /**
     * @private
     * @param {?} data
     * @param {?=} parentId
     * @return {?}
     */
    convert2TreeNodes(data, parentId = '') {
        if (data.length) {
            /** @type {?} */
            const nodes = data.filter((/**
             * @param {?} v
             * @return {?}
             */
            (v) => {
                /** @type {?} */
                let pid = v.parentId;
                if (pid === undefined || pid === null) {
                    pid = '';
                }
                return pid === parentId;
            }));
            // const nodes = data.filter((v) => (v.parentId || '') === parentId);
            return nodes.map((/**
             * @param {?} item
             * @return {?}
             */
            item => {
                /** @type {?} */
                const node = {
                    data: item,
                    children: [],
                    selectable: item.layer === '4'
                };
                node.children = this.convert2TreeNodes(data, item.id);
                return node;
            }));
        }
        return [];
    }
}
SelectAppComponent.decorators = [
    { type: Component, args: [{
                selector: 'select-app',
                template: "<div class=\"d-flex flex-row\" style=\"width: 760px; height: 400px;border:0px solid #ae00e6\">\r\n        <!-- Left -->\r\n        <div region=\"west\" class=\"west\" style=\"width: 280px;min-width:280px; height: 100%; background-color: #fff;border-right: 1px solid #e2e8f0;\">\r\n            <!-- \u83DC\u5355\u6811 -->\r\n            <perfect-scrollbar style=\"position: relative; width: 280px; height: 100%;\">\r\n                <farris-treetable #tt [data]=\"treeData\" [idField]=\"'id'\" [striped]=\"false\" [findField]=\"'name'\"\r\n                    [singleSelect]=\"true\" [showIcon]=\"true\" [showFilterBar]=\"false\" [selectOnCheck]=\"true\"\r\n                    (nodeSelected)=\"treeNodeClicked($event)\"\r\n                    [selectValue]=\"selectedAppID\"\r\n                    [checkOnSelect]=\"true\" [sortName]=\"'name'\" [sortOrder]=\"'asc'\" [remoteSort]=\"false\">\r\n                    <ng-template farrisTemplate=\"body\" let-rowNode let-treeNode=\"node\" let-rowData=\"rowData\">\r\n                        <tr #row=\"row\" [selectRow]=\"rowNode\" [selectRowDisabled]=\"!rowNode.node.selectable\" [dblclick]=\"true\">\r\n                            <td style=\"border: 0; cursor: pointer;\" [style.color]=\"row.selectRowDisabled? '#595959': '#000000'\">\r\n                                <farris-treeTableToggler [rowNode]=\"rowNode\"></farris-treeTableToggler>\r\n                                <span [innerHTML]=\"rowData['name'] | highlight: tt.findValue: 'name' : 'name'\"></span>\r\n                            </td>\r\n                        </tr>\r\n                    </ng-template>\r\n                </farris-treetable>\r\n            </perfect-scrollbar>\r\n        </div>\r\n    \r\n        <!-- main -->\r\n        <div region=\"center\" class=\"center f-utils-fill \" >\r\n    \r\n            <farris-datagrid [sizeType]=\"'md'\" [fitColumns]=\"true\"\r\n                [columns]=\"columns\" [fit]=\"true\" \r\n                [showCheckbox]=\"true\"\r\n                [selectOnCheck]=\"true\" [checkOnSelect]=\"true\"\r\n                [pagination]=\"false\" #grid\r\n                [data]=\"items\">\r\n            </farris-datagrid>\r\n    \r\n        </div>\r\n    </div>"
            }] }
];
/** @nocollapse */
SelectAppComponent.ctorParameters = () => [
    { type: HttpService },
    { type: Injector },
    { type: NgZone }
];
SelectAppComponent.propDecorators = {
    serverIp: [{ type: Input }],
    grid: [{ type: ViewChild, args: ['grid',] }],
    tt: [{ type: ViewChild, args: ['tt',] }]
};
if (false) {
    /** @type {?} */
    SelectAppComponent.prototype.serverIp;
    /** @type {?} */
    SelectAppComponent.prototype.treeData;
    /** @type {?} */
    SelectAppComponent.prototype.funcModel;
    /** @type {?} */
    SelectAppComponent.prototype.columns;
    /** @type {?} */
    SelectAppComponent.prototype.items;
    /** @type {?} */
    SelectAppComponent.prototype.grid;
    /** @type {?} */
    SelectAppComponent.prototype.tt;
    /** @type {?} */
    SelectAppComponent.prototype.selectedAppID;
    /** @type {?} */
    SelectAppComponent.prototype.localeSer;
    /**
     * @type {?}
     * @private
     */
    SelectAppComponent.prototype.http;
    /**
     * @type {?}
     * @private
     */
    SelectAppComponent.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    SelectAppComponent.prototype.ngZone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LWFwcC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2lkZS1wdWJsaXNoLW1lbnUvIiwic291cmNlcyI6WyJsaWIvc2VsZWN0LWFwcC9zZWxlY3QtYXBwLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxNQUFNLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdEYsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ2pELE9BQU8sRUFBWSxrQkFBa0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQU1sRCxNQUFNLE9BQU8sa0JBQWtCOzs7Ozs7SUE2QjNCLFlBQ1ksSUFBaUIsRUFDakIsUUFBa0IsRUFDbEIsTUFBYztRQUZkLFNBQUksR0FBSixJQUFJLENBQWE7UUFDakIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBL0JqQixhQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLGFBQVEsR0FBRyxFQUFFLENBQUM7UUFDZCxjQUFTLEdBQVEsRUFBRSxDQUFDO1FBRXBCLFlBQU8sR0FBRyxFQUFFLENBQUM7UUFDYixVQUFLLEdBQUcsRUFBRSxDQUFDO1FBcUJYLGtCQUFhLEdBQUcsRUFBRSxDQUFDO1FBTVgsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDNUQsQ0FBQzs7OztJQTFCTCxJQUFJLE9BQU87UUFDUCxPQUFPLElBQUksQ0FBQyxRQUFRLEdBQUcsa0NBQWtDLENBQUM7SUFDOUQsQ0FBQzs7OztJQUlE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SUFleEMsMkNBQW1COztJQUNuQix1Q0FBeUI7Ozs7O0lBRXJCLGtDQUF5Qjs7Ozs7SUFDekIsc0NBQTBCOzs7OztJQUMxQixvQ0FBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgTmdab25lLCBJbmplY3RvciwgSW5wdXQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBIdHRwU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvaWRlLWRldmtpdCc7XHJcbmltcG9ydCB7IFRyZWVOb2RlLCBUcmVlVGFibGVDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLXRyZWV0YWJsZSc7XHJcbmltcG9ydCB7IERhdGFncmlkQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1kYXRhZ3JpZCc7XHJcbmltcG9ydCB7IExvY2FsZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWxvY2FsZSc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICAgIHNlbGVjdG9yOiAnc2VsZWN0LWFwcCcsXHJcbiAgICB0ZW1wbGF0ZVVybDogJy4vc2VsZWN0LWFwcC5jb21wb25lbnQuaHRtbCcsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBTZWxlY3RBcHBDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xyXG4gICAgQElucHV0KCkgc2VydmVySXAgPSAnJztcclxuICAgIHRyZWVEYXRhID0gW107XHJcbiAgICBmdW5jTW9kZWw6IGFueSA9IHt9O1xyXG5cclxuICAgIGNvbHVtbnMgPSBbXTtcclxuICAgIGl0ZW1zID0gW107XHJcblxyXG4gICAgZ2V0IEFQUF9VUkkoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VydmVySXAgKyAnL2FwaS9ydW50aW1lL3N5cy92MS4wL2dzcGFwcC9hbGwnO1xyXG4gICAgfVxyXG4gICAgQFZpZXdDaGlsZCgnZ3JpZCcpIGdyaWQ6IERhdGFncmlkQ29tcG9uZW50O1xyXG4gICAgQFZpZXdDaGlsZCgndHQnKSB0dDogVHJlZVRhYmxlQ29tcG9uZW50O1xyXG5cclxuICAgIGdldCBhcHBJZCgpIHtcclxuICAgICAgICBpZiAodGhpcy50dCAmJiB0aGlzLnR0LnNlbGVjdGVkUm93KSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnR0LnNlbGVjdGVkUm93LmRhdGEuaWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIGdldCBhcHBJbnZva0lkKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmdyaWQgJiYgdGhpcy5ncmlkLnNlbGVjdGVkUm93KSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdyaWQuc2VsZWN0ZWRSb3cuaWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3RlZEFwcElEID0gJyc7XHJcbiAgICBsb2NhbGVTZXI6IExvY2FsZVNlcnZpY2U7XHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlIGh0dHA6IEh0dHBTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxyXG4gICAgICAgIHByaXZhdGUgbmdab25lOiBOZ1pvbmUpIHtcclxuICAgICAgICAgICAgdGhpcy5sb2NhbGVTZXIgPSB0aGlzLmluamVjdG9yLmdldChMb2NhbGVTZXJ2aWNlLCBudWxsKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5pbml0VHJlZURhdGEoKTtcclxuICAgICAgICB0aGlzLmNvbHVtbnMgPSBbXHJcbiAgICAgICAgICAgIHsgdGl0bGU6IHRoaXMubG9jYWxlU2VyLmdldFZhbHVlKCdwdWJsaXNobWVudS5hcHAuY29sdW1uLmNvZGUnKSwgZmllbGQ6ICdjb2RlJywgd2lkdGg6IDIwMCB9LFxyXG4gICAgICAgICAgICB7IHRpdGxlOiB0aGlzLmxvY2FsZVNlci5nZXRWYWx1ZSgncHVibGlzaG1lbnUuYXBwLmNvbHVtbi5uYW1lJyksIGZpZWxkOiAnbmFtZScsIHdpZHRoOiAxNTAgfVxyXG4gICAgICAgIF07XHJcbiAgICB9XHJcblxyXG4gICAgdHJlZU5vZGVDbGlja2VkKGUpIHtcclxuICAgICAgICB0aGlzLml0ZW1zID0gZS5ub2RlLmRhdGEuYXBwSW52b2tzIHx8IFtdO1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5mdW5jTW9kZWwgJiYgT2JqZWN0LmtleXModGhpcy5mdW5jTW9kZWwpLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYXBwSW52b2tJZCA9IHRoaXMuZnVuY01vZGVsLmFwcEludm9rSWQ7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWFwcEludm9rSWQpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLmdyaWQuc2VsZWN0Um93KGFwcEludm9rSWQsIGZhbHNlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sIDEwMCk7XHJcbiAgICAgICAgLy8gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgLy8gICAgIGlmICh0aGlzLmdyaWQgJiYgdGhpcy5pdGVtcy5sZW5ndGgpIHtcclxuICAgICAgICAvLyAgICAgICAgIHRoaXMuZ3JpZC5zZWxlY3RSb3codGhpcy5pdGVtc1swXS5pZCk7XHJcbiAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAvLyB9LCAxMDApO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaW5pdFRyZWVEYXRhKCkge1xyXG4gICAgICAgIHRoaXMuaHR0cC5nZXQodGhpcy5BUFBfVVJJKS5zdWJzY3JpYmUoZGF0YSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnRyZWVEYXRhID0gdGhpcy5jb252ZXJ0MlRyZWVOb2RlcyhkYXRhKTtcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmZ1bmNNb2RlbCAmJiBPYmplY3Qua2V5cyh0aGlzLmZ1bmNNb2RlbCkubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFwcElkID0gdGhpcy5mdW5jTW9kZWwuYXBwSWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXBwSWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJlZU5vZGUgPSB0aGlzLnR0LmZpbmRSb3dOb2RlKGFwcElkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyZWVOb2RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmVlTm9kZS5wYXJlbnRzLmZvckVhY2goKGlkKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50dC5leHBhbmROb2RlKGlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkQXBwSUQgPSBhcHBJZDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LCAyMDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjb252ZXJ0MlRyZWVOb2RlcyhkYXRhOiBhbnlbXSwgcGFyZW50SWQgPSAnJyk6IFRyZWVOb2RlW10ge1xyXG4gICAgICAgIGlmIChkYXRhLmxlbmd0aCkge1xyXG5cclxuICAgICAgICAgICAgY29uc3Qgbm9kZXMgPSBkYXRhLmZpbHRlcigodikgPT4ge1xyXG4gICAgICAgICAgICAgICAgbGV0IHBpZCA9IHYucGFyZW50SWQ7XHJcbiAgICAgICAgICAgICAgICBpZiAocGlkID09PSB1bmRlZmluZWQgfHwgcGlkID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGlkID0gJyc7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcGlkID09PSBwYXJlbnRJZDtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAvLyBjb25zdCBub2RlcyA9IGRhdGEuZmlsdGVyKCh2KSA9PiAodi5wYXJlbnRJZCB8fCAnJykgPT09IHBhcmVudElkKTtcclxuICAgICAgICAgICAgcmV0dXJuIG5vZGVzLm1hcChpdGVtID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5vZGUgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YTogaXRlbSxcclxuICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogW10sXHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0YWJsZTogaXRlbS5sYXllciA9PT0gJzQnXHJcbiAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgIG5vZGUuY2hpbGRyZW4gPSB0aGlzLmNvbnZlcnQyVHJlZU5vZGVzKGRhdGEsIGl0ZW0uaWQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcbn1cclxuIl19