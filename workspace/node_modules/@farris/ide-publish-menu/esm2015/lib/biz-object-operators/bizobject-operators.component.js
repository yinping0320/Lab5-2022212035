/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, Input, Injector, NgZone, ViewChild } from '@angular/core';
import { HttpService } from '@farris/ide-devkit';
import { TreeTableComponent } from '@farris/ui-treetable';
import { DatagridComponent } from '@farris/ui-datagrid';
import { cloneDeep } from 'lodash-es';
import { LocaleService } from '@farris/ui-locale';
export class BizobjectOperatorsComponent {
    /**
     * @param {?} http
     * @param {?} injector
     * @param {?} ngZone
     */
    constructor(http, injector, ngZone) {
        this.http = http;
        this.injector = injector;
        this.ngZone = ngZone;
        this.serverIp = '';
        this.treeData = [];
        this.columns = [];
        this.items = [];
        this.allOperators = [];
        this.funcModel = {};
        this.selectBizObjectId = '';
        this.selectBizOpId = '';
        this.localeSer = this.injector.get(LocaleService, null);
    }
    /**
     * @return {?}
     */
    get BIZ_OBJECT_URI() {
        return this.serverIp + '/api/dev/main/v1.0/business-objects';
    }
    /**
     * @return {?}
     */
    get FUNCTION_OPERATORS_URI() {
        return this.serverIp + '/api/runtime/sys/v1.0/funcOperations/all';
    }
    /**
     * @return {?}
     */
    get bizObjectId() {
        if (this.tt.selectedRow) {
            return this.tt.selectedRow;
        }
        return '';
    }
    /**
     * @return {?}
     */
    get bizOpId() {
        if (this.grid.selectedRow) {
            return this.grid.selectedRow;
        }
        return '';
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.initTreeData();
        this.columns = [
            { title: this.localeSer.getValue('publishmenu.app.column.code'), field: 'code', width: 200 },
            { title: this.localeSer.getValue('publishmenu.app.column.name'), field: 'name', width: 150 }
        ];
    }
    /**
     * @param {?} e
     * @return {?}
     */
    treeNodeClicked(e) {
        this.grid.clearAll();
        this.items = this.allOperators.filter((/**
         * @param {?} n
         * @return {?}
         */
        n => n.businessId === e.node.data.id));
        if (this.funcModel && Object.keys(this.funcModel).length) {
            /** @type {?} */
            const bizOpId = this.funcModel.bizOpId;
            if (!bizOpId) {
                return;
            }
            this.grid.selectRow(bizOpId, false);
        }
    }
    /**
     * @return {?}
     */
    treeNodeUnSelect() {
        this.items = this.allOperators;
    }
    /**
     * @private
     * @return {?}
     */
    initTreeData() {
        this.http.get(this.BIZ_OBJECT_URI).subscribe((/**
         * @param {?} data
         * @return {?}
         */
        data => {
            if (data) {
                this.treeData = this.convert2TreeNodes(data);
                setTimeout((/**
                 * @return {?}
                 */
                () => {
                    if (this.funcModel && Object.keys(this.funcModel).length) {
                        /** @type {?} */
                        const bizObjectId = this.funcModel.bizObjectId;
                        if (!bizObjectId) {
                            return;
                        }
                        /** @type {?} */
                        const treeNode = this.tt.findRowNode(bizObjectId);
                        if (treeNode) {
                            treeNode.parents.forEach((/**
                             * @param {?} id
                             * @return {?}
                             */
                            (id) => {
                                this.tt.expandNode(id);
                            }));
                            // this.tt.selectNode(bizObjectId);
                        }
                        this.selectBizObjectId = bizObjectId;
                    }
                }), 200);
            }
        }));
        this.http.get(this.FUNCTION_OPERATORS_URI).subscribe((/**
         * @param {?} data
         * @return {?}
         */
        data => {
            if (data) {
                this.items = data.filter((/**
                 * @param {?} item
                 * @return {?}
                 */
                item => item.type === 0));
                this.allOperators = cloneDeep(this.items);
            }
        }));
    }
    /**
     * @private
     * @param {?} data
     * @param {?=} parentId
     * @return {?}
     */
    convert2TreeNodes(data, parentId = null) {
        if (data.length) {
            /** @type {?} */
            const nodes = data.filter((/**
             * @param {?} v
             * @return {?}
             */
            (v) => v.parentID === parentId));
            return nodes.map((/**
             * @param {?} item
             * @return {?}
             */
            item => {
                /** @type {?} */
                const node = {
                    data: item,
                    children: [],
                    expanded: parentId === null,
                    selectable: Number(item.isDetail) === 1
                };
                node.children = this.convert2TreeNodes(data, item.id);
                return node;
            }));
        }
        return [];
    }
}
BizobjectOperatorsComponent.decorators = [
    { type: Component, args: [{
                selector: 'bizobj-operators',
                template: "<div class=\"d-flex flex-row\" style=\"width: 760px; height: 400px;border:0px solid #ae00e6\">\r\n        <!-- Left -->\r\n        <div region=\"west\" class=\"west\" style=\"width: 280px;min-width:280px; height: 100%; background-color: #fff;border-right: 1px solid #e2e8f0;\">\r\n            <!-- \u83DC\u5355\u6811 -->\r\n            <perfect-scrollbar style=\"position: relative; width: 280px; height: 100%;\">\r\n                <farris-treetable #tt [data]=\"treeData\" [idField]=\"'id'\" [striped]=\"false\" [findField]=\"'name'\"\r\n                    [singleSelect]=\"true\" [showIcon]=\"true\" [showFilterBar]=\"false\" [selectOnCheck]=\"true\"\r\n                    (nodeSelected)=\"treeNodeClicked($event)\" [keepSelect]=\"true\"\r\n                    (nodeUnSelect)=\"treeNodeUnSelect()\"\r\n                    [selectValue]=\"selectBizObjectId\"\r\n                    [checkOnSelect]=\"true\" [sortName]=\"'name'\" [sortOrder]=\"'asc'\" [remoteSort]=\"false\">\r\n                    <ng-template farrisTemplate=\"body\" let-rowNode let-treeNode=\"node\" let-rowData=\"rowData\">\r\n                        <tr #row=\"row\" [selectRow]=\"rowNode\" [selectRowDisabled]=\"!rowNode.node.selectable\" [dblclick]=\"true\">\r\n                            <td style=\"border: 0; cursor: pointer;\" [style.color]=\"row.selectRowDisabled? '#595959': '#000000'\">\r\n                                <farris-treeTableToggler [rowNode]=\"rowNode\"></farris-treeTableToggler>\r\n                                <span [innerHTML]=\"rowData['name'] | highlight: tt.findValue: 'name' : 'name'\"></span>\r\n                            </td>\r\n                        </tr>\r\n                    </ng-template>\r\n                </farris-treetable>\r\n            </perfect-scrollbar>\r\n        </div>\r\n    \r\n        <!-- main -->\r\n        <div region=\"center\" class=\"center f-utils-fill \">\r\n    \r\n            <farris-datagrid [sizeType]=\"'md'\" [fitColumns]=\"true\"\r\n                [columns]=\"columns\" [fit]=\"true\" \r\n                [showCheckbox]=\"true\"\r\n                [selectOnCheck]=\"true\" [checkOnSelect]=\"true\"\r\n                [pagination]=\"false\" #grid\r\n                [data]=\"items\">\r\n            </farris-datagrid>\r\n    \r\n        </div>\r\n    </div>"
            }] }
];
/** @nocollapse */
BizobjectOperatorsComponent.ctorParameters = () => [
    { type: HttpService },
    { type: Injector },
    { type: NgZone }
];
BizobjectOperatorsComponent.propDecorators = {
    serverIp: [{ type: Input }],
    grid: [{ type: ViewChild, args: ['grid',] }],
    tt: [{ type: ViewChild, args: ['tt',] }]
};
if (false) {
    /** @type {?} */
    BizobjectOperatorsComponent.prototype.serverIp;
    /** @type {?} */
    BizobjectOperatorsComponent.prototype.treeData;
    /** @type {?} */
    BizobjectOperatorsComponent.prototype.columns;
    /** @type {?} */
    BizobjectOperatorsComponent.prototype.items;
    /** @type {?} */
    BizobjectOperatorsComponent.prototype.allOperators;
    /** @type {?} */
    BizobjectOperatorsComponent.prototype.funcModel;
    /** @type {?} */
    BizobjectOperatorsComponent.prototype.selectBizObjectId;
    /** @type {?} */
    BizobjectOperatorsComponent.prototype.selectBizOpId;
    /** @type {?} */
    BizobjectOperatorsComponent.prototype.grid;
    /** @type {?} */
    BizobjectOperatorsComponent.prototype.tt;
    /** @type {?} */
    BizobjectOperatorsComponent.prototype.localeSer;
    /**
     * @type {?}
     * @private
     */
    BizobjectOperatorsComponent.prototype.http;
    /**
     * @type {?}
     * @private
     */
    BizobjectOperatorsComponent.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    BizobjectOperatorsComponent.prototype.ngZone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYml6b2JqZWN0LW9wZXJhdG9ycy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2lkZS1wdWJsaXNoLW1lbnUvIiwic291cmNlcyI6WyJsaWIvYml6LW9iamVjdC1vcGVyYXRvcnMvYml6b2JqZWN0LW9wZXJhdG9ycy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQVUsS0FBSyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3RGLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNqRCxPQUFPLEVBQVksa0JBQWtCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNwRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUtsRCxNQUFNLE9BQU8sMkJBQTJCOzs7Ozs7SUEwQ3BDLFlBQ1ksSUFBaUIsRUFDakIsUUFBa0IsRUFDbEIsTUFBYztRQUZkLFNBQUksR0FBSixJQUFJLENBQWE7UUFDakIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBNUNqQixhQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLGFBQVEsR0FBRyxFQUFFLENBQUM7UUFHZCxZQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2IsVUFBSyxHQUFHLEVBQUUsQ0FBQztRQUNYLGlCQUFZLEdBQUcsRUFBRSxDQUFDO1FBRWxCLGNBQVMsR0FBUSxFQUFFLENBQUM7UUFFcEIsc0JBQWlCLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLGtCQUFhLEdBQUcsRUFBRSxDQUFDO1FBbUNmLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxH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aUJBQzFDO2dCQUVELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ3RELE9BQU8sSUFBSSxDQUFDO1lBQ2hCLENBQUMsRUFBQyxDQUFDO1NBQ047UUFDRCxPQUFPLEVBQUUsQ0FBQztJQUNkLENBQUM7OztZQW5JSixTQUFTLFNBQUM7Z0JBQ1AsUUFBUSxFQUFFLGtCQUFrQjtnQkFDNUIsc3hFQUFtRDthQUN0RDs7OztZQVJRLFdBQVc7WUFEZSxRQUFRO1lBQUUsTUFBTTs7O3VCQVc5QyxLQUFLO21CQXNCTCxTQUFTLFNBQUMsTUFBTTtpQkFDaEIsU0FBUyxTQUFDLElBQUk7Ozs7SUF2QmYsK0NBQXVCOztJQUN2QiwrQ0FBYzs7SUFHZCw4Q0FBYTs7SUFDYiw0Q0FBVzs7SUFDWCxtREFBa0I7O0lBRWxCLGdEQUFvQjs7SUFFcEIsd0RBQXVCOztJQUN2QixvREFBbUI7O0lBV25CLDJDQUEyQzs7SUFDM0MseUNBQXdDOztJQWlCeEMsZ0RBQXlCOzs7OztJQUVyQiwyQ0FBeUI7Ozs7O0lBQ3pCLCtDQUEwQjs7Ozs7SUFDMUIsNkNBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIElucHV0LCBJbmplY3RvciwgTmdab25lLCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgSHR0cFNlcnZpY2UgfSBmcm9tICdAZmFycmlzL2lkZS1kZXZraXQnO1xyXG5pbXBvcnQgeyBUcmVlTm9kZSwgVHJlZVRhYmxlQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS10cmVldGFibGUnO1xyXG5pbXBvcnQgeyBEYXRhZ3JpZENvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YWdyaWQnO1xyXG5pbXBvcnQgeyBjbG9uZURlZXAgfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG5pbXBvcnQgeyBMb2NhbGVTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1sb2NhbGUnO1xyXG5AQ29tcG9uZW50KHtcclxuICAgIHNlbGVjdG9yOiAnYml6b2JqLW9wZXJhdG9ycycsXHJcbiAgICB0ZW1wbGF0ZVVybDogJy4vYml6b2JqZWN0LW9wZXJhdG9ycy5jb21wb25lbnQuaHRtbCdcclxufSlcclxuZXhwb3J0IGNsYXNzIEJpem9iamVjdE9wZXJhdG9yc0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcbiAgICBASW5wdXQoKSBzZXJ2ZXJJcCA9ICcnO1xyXG4gICAgdHJlZURhdGEgPSBbXTtcclxuXHJcblxyXG4gICAgY29sdW1ucyA9IFtdO1xyXG4gICAgaXRlbXMgPSBbXTtcclxuICAgIGFsbE9wZXJhdG9ycyA9IFtdO1xyXG5cclxuICAgIGZ1bmNNb2RlbDogYW55ID0ge307XHJcblxyXG4gICAgc2VsZWN0Qml6T2JqZWN0SWQgPSAnJztcclxuICAgIHNlbGVjdEJpek9wSWQgPSAnJztcclxuXHJcblxyXG4gICAgZ2V0IEJJWl9PQkpFQ1RfVVJJKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNlcnZlcklwICsgJy9hcGkvZGV2L21haW4vdjEuMC9idXNpbmVzcy1vYmplY3RzJztcclxuICAgIH1cclxuXHJcbiAgICBnZXQgRlVOQ1RJT05fT1BFUkFUT1JTX1VSSSgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zZXJ2ZXJJcCArICcvYXBpL3J1bnRpbWUvc3lzL3YxLjAvZnVuY09wZXJhdGlvbnMvYWxsJztcclxuICAgIH1cclxuXHJcbiAgICBAVmlld0NoaWxkKCdncmlkJykgZ3JpZDogRGF0YWdyaWRDb21wb25lbnQ7XHJcbiAgICBAVmlld0NoaWxkKCd0dCcpIHR0OiBUcmVlVGFibGVDb21wb25lbnQ7XHJcblxyXG5cclxuICAgIGdldCBiaXpPYmplY3RJZCgpIHtcclxuICAgICAgICBpZiAodGhpcy50dC5zZWxlY3RlZFJvdykge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy50dC5zZWxlY3RlZFJvdztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBiaXpPcElkKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmdyaWQuc2VsZWN0ZWRSb3cpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ3JpZC5zZWxlY3RlZFJvdztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIGxvY2FsZVNlcjogTG9jYWxlU2VydmljZTtcclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByaXZhdGUgaHR0cDogSHR0cFNlcnZpY2UsXHJcbiAgICAgICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXHJcbiAgICAgICAgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZSkge1xyXG5cclxuICAgICAgICB0aGlzLmxvY2FsZVNlciA9IHRoaXMuaW5qZWN0b3IuZ2V0KExvY2FsZVNlcnZpY2UsIG51bGwpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuaW5pdFRyZWVEYXRhKCk7XHJcblxyXG4gICAgICAgIHRoaXMuY29sdW1ucyA9IFtcclxuICAgICAgICAgICAgeyB0aXRsZTogdGhpcy5sb2NhbGVTZXIuZ2V0VmFsdWUoJ3B1Ymxpc2htZW51LmFwcC5jb2x1bW4uY29kZScpLCBmaWVsZDogJ2NvZGUnLCB3aWR0aDogMjAwIH0sXHJcbiAgICAgICAgICAgIHsgdGl0bGU6IHRoaXMubG9jYWxlU2VyLmdldFZhbHVlKCdwdWJsaXNobWVudS5hcHAuY29sdW1uLm5hbWUnKSwgZmllbGQ6ICduYW1lJywgd2lkdGg6IDE1MCB9XHJcbiAgICAgICAgXTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgdHJlZU5vZGVDbGlja2VkKGUpIHtcclxuICAgICAgICB0aGlzLmdyaWQuY2xlYXJBbGwoKTtcclxuICAgICAgICB0aGlzLml0ZW1zID0gdGhpcy5hbGxPcGVyYXRvcnMuZmlsdGVyKG4gPT4gbi5idXNpbmVzc0lkID09PSBlLm5vZGUuZGF0YS5pZCk7XHJcbiAgICAgICAgaWYgKHRoaXMuZnVuY01vZGVsICYmIE9iamVjdC5rZXlzKHRoaXMuZnVuY01vZGVsKS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgY29uc3QgYml6T3BJZCA9IHRoaXMuZnVuY01vZGVsLmJpek9wSWQ7XHJcbiAgICAgICAgICAgIGlmICghYml6T3BJZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuZ3JpZC5zZWxlY3RSb3coYml6T3BJZCwgZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB0cmVlTm9kZVVuU2VsZWN0KCkge1xyXG4gICAgICAgIHRoaXMuaXRlbXMgPSB0aGlzLmFsbE9wZXJhdG9ycztcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBpbml0VHJlZURhdGEoKSB7XHJcbiAgICAgICAgdGhpcy5odHRwLmdldCh0aGlzLkJJWl9PQkpFQ1RfVVJJKS5zdWJzY3JpYmUoZGF0YSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnRyZWVEYXRhID0gdGhpcy5jb252ZXJ0MlRyZWVOb2RlcyhkYXRhKTtcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmZ1bmNNb2RlbCAmJiBPYmplY3Qua2V5cyh0aGlzLmZ1bmNNb2RlbCkubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJpek9iamVjdElkID0gdGhpcy5mdW5jTW9kZWwuYml6T2JqZWN0SWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYml6T2JqZWN0SWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJlZU5vZGUgPSB0aGlzLnR0LmZpbmRSb3dOb2RlKGJpek9iamVjdElkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyZWVOb2RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmVlTm9kZS5wYXJlbnRzLmZvckVhY2goKGlkKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50dC5leHBhbmROb2RlKGlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy50dC5zZWxlY3ROb2RlKGJpek9iamVjdElkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RCaXpPYmplY3RJZCA9IGJpek9iamVjdElkO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sIDIwMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5odHRwLmdldCh0aGlzLkZVTkNUSU9OX09QRVJBVE9SU19VUkkpLnN1YnNjcmliZSggZGF0YSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLml0ZW1zID0gZGF0YS5maWx0ZXIoaXRlbSA9PiBpdGVtLnR5cGUgPT09IDApO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hbGxPcGVyYXRvcnMgPSBjbG9uZURlZXAodGhpcy5pdGVtcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBjb252ZXJ0MlRyZWVOb2RlcyhkYXRhOiBhbnlbXSwgcGFyZW50SWQgPSBudWxsKTogVHJlZU5vZGVbXSB7XHJcbiAgICAgICAgaWYgKGRhdGEubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5vZGVzID0gZGF0YS5maWx0ZXIoKHYpID0+IHYucGFyZW50SUQgPT09IHBhcmVudElkKTtcclxuICAgICAgICAgICAgcmV0dXJuIG5vZGVzLm1hcChpdGVtID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5vZGUgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YTogaXRlbSxcclxuICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogW10sXHJcbiAgICAgICAgICAgICAgICAgICAgZXhwYW5kZWQ6IHBhcmVudElkID09PSBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGFibGU6IE51bWJlcihpdGVtLmlzRGV0YWlsKSA9PT0gMVxyXG4gICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICBub2RlLmNoaWxkcmVuID0gdGhpcy5jb252ZXJ0MlRyZWVOb2RlcyhkYXRhLCBpdGVtLmlkKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBub2RlO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==