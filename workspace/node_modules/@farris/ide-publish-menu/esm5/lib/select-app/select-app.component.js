/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, NgZone, Injector, Input, ViewChild } from '@angular/core';
import { HttpService } from '@farris/ide-devkit';
import { TreeTableComponent } from '@farris/ui-treetable';
import { DatagridComponent } from '@farris/ui-datagrid';
import { LocaleService } from '@farris/ui-locale';
var SelectAppComponent = /** @class */ (function () {
    function SelectAppComponent(http, injector, ngZone) {
        this.http = http;
        this.injector = injector;
        this.ngZone = ngZone;
        this.serverIp = '';
        this.treeData = [];
        this.funcModel = {};
        this.columns = [];
        this.items = [];
        this.selectedAppID = '';
        this.localeSer = this.injector.get(LocaleService, null);
    }
    Object.defineProperty(SelectAppComponent.prototype, "APP_URI", {
        get: /**
         * @return {?}
         */
        function () {
            return this.serverIp + '/api/runtime/sys/v1.0/gspapp/all';
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SelectAppComponent.prototype, "appId", {
        get: /**
         * @return {?}
         */
        function () {
            if (this.tt && this.tt.selectedRow) {
                return this.tt.selectedRow.data.id;
            }
            return '';
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SelectAppComponent.prototype, "appInvokId", {
        get: /**
         * @return {?}
         */
        function () {
            if (this.grid && this.grid.selectedRow) {
                return this.grid.selectedRow.id;
            }
            return '';
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    SelectAppComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.initTreeData();
        this.columns = [
            { title: this.localeSer.getValue('publishmenu.app.column.code'), field: 'code', width: 200 },
            { title: this.localeSer.getValue('publishmenu.app.column.name'), field: 'name', width: 150 }
        ];
    };
    /**
     * @param {?} e
     * @return {?}
     */
    SelectAppComponent.prototype.treeNodeClicked = /**
     * @param {?} e
     * @return {?}
     */
    function (e) {
        var _this = this;
        this.items = e.node.data.appInvoks || [];
        setTimeout((/**
         * @return {?}
         */
        function () {
            if (_this.funcModel && Object.keys(_this.funcModel).length) {
                /** @type {?} */
                var appInvokId = _this.funcModel.appInvokId;
                if (!appInvokId) {
                    return;
                }
                _this.grid.selectRow(appInvokId, false);
            }
        }), 100);
        // setTimeout(() => {
        //     if (this.grid && this.items.length) {
        //         this.grid.selectRow(this.items[0].id);
        //     }
        // }, 100);
    };
    /**
     * @private
     * @return {?}
     */
    SelectAppComponent.prototype.initTreeData = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        this.http.get(this.APP_URI).subscribe((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            if (data) {
                _this.treeData = _this.convert2TreeNodes(data);
                setTimeout((/**
                 * @return {?}
                 */
                function () {
                    if (_this.funcModel && Object.keys(_this.funcModel).length) {
                        /** @type {?} */
                        var appId = _this.funcModel.appId;
                        if (!appId) {
                            return;
                        }
                        /** @type {?} */
                        var treeNode = _this.tt.findRowNode(appId);
                        if (treeNode) {
                            treeNode.parents.forEach((/**
                             * @param {?} id
                             * @return {?}
                             */
                            function (id) {
                                _this.tt.expandNode(id);
                            }));
                        }
                        _this.selectedAppID = appId;
                    }
                }), 200);
            }
        }));
    };
    /**
     * @private
     * @param {?} data
     * @param {?=} parentId
     * @return {?}
     */
    SelectAppComponent.prototype.convert2TreeNodes = /**
     * @private
     * @param {?} data
     * @param {?=} parentId
     * @return {?}
     */
    function (data, parentId) {
        var _this = this;
        if (parentId === void 0) { parentId = ''; }
        if (data.length) {
            /** @type {?} */
            var nodes = data.filter((/**
             * @param {?} v
             * @return {?}
             */
            function (v) {
                /** @type {?} */
                var pid = v.parentId;
                if (pid === undefined || pid === null) {
                    pid = '';
                }
                return pid === parentId;
            }));
            // const nodes = data.filter((v) => (v.parentId || '') === parentId);
            return nodes.map((/**
             * @param {?} item
             * @return {?}
             */
            function (item) {
                /** @type {?} */
                var node = {
                    data: item,
                    children: [],
                    selectable: item.layer === '4'
                };
                node.children = _this.convert2TreeNodes(data, item.id);
                return node;
            }));
        }
        return [];
    };
    SelectAppComponent.decorators = [
        { type: Component, args: [{
                    selector: 'select-app',
                    template: "<div class=\"d-flex flex-row\" style=\"width: 760px; height: 400px;border:0px solid #ae00e6\">\r\n        <!-- Left -->\r\n        <div region=\"west\" class=\"west\" style=\"width: 280px;min-width:280px; height: 100%; background-color: #fff;border-right: 1px solid #e2e8f0;\">\r\n            <!-- \u83DC\u5355\u6811 -->\r\n            <perfect-scrollbar style=\"position: relative; width: 280px; height: 100%;\">\r\n                <farris-treetable #tt [data]=\"treeData\" [idField]=\"'id'\" [striped]=\"false\" [findField]=\"'name'\"\r\n                    [singleSelect]=\"true\" [showIcon]=\"true\" [showFilterBar]=\"false\" [selectOnCheck]=\"true\"\r\n                    (nodeSelected)=\"treeNodeClicked($event)\"\r\n                    [selectValue]=\"selectedAppID\"\r\n                    [checkOnSelect]=\"true\" [sortName]=\"'name'\" [sortOrder]=\"'asc'\" [remoteSort]=\"false\">\r\n                    <ng-template farrisTemplate=\"body\" let-rowNode let-treeNode=\"node\" let-rowData=\"rowData\">\r\n                        <tr #row=\"row\" [selectRow]=\"rowNode\" [selectRowDisabled]=\"!rowNode.node.selectable\" [dblclick]=\"true\">\r\n                            <td style=\"border: 0; cursor: pointer;\" [style.color]=\"row.selectRowDisabled? '#595959': '#000000'\">\r\n                                <farris-treeTableToggler [rowNode]=\"rowNode\"></farris-treeTableToggler>\r\n                                <span [innerHTML]=\"rowData['name'] | highlight: tt.findValue: 'name' : 'name'\"></span>\r\n                            </td>\r\n                        </tr>\r\n                    </ng-template>\r\n                </farris-treetable>\r\n            </perfect-scrollbar>\r\n        </div>\r\n    \r\n        <!-- main -->\r\n        <div region=\"center\" class=\"center f-utils-fill \" >\r\n    \r\n            <farris-datagrid [sizeType]=\"'md'\" [fitColumns]=\"true\"\r\n                [columns]=\"columns\" [fit]=\"true\" \r\n                [showCheckbox]=\"true\"\r\n                [selectOnCheck]=\"true\" [checkOnSelect]=\"true\"\r\n                [pagination]=\"false\" #grid\r\n                [data]=\"items\">\r\n            </farris-datagrid>\r\n    \r\n        </div>\r\n    </div>"
                }] }
    ];
    /** @nocollapse */
    SelectAppComponent.ctorParameters = function () { return [
        { type: HttpService },
        { type: Injector },
        { type: NgZone }
    ]; };
    SelectAppComponent.propDecorators = {
        serverIp: [{ type: Input }],
        grid: [{ type: ViewChild, args: ['grid',] }],
        tt: [{ type: ViewChild, args: ['tt',] }]
    };
    return SelectAppComponent;
}());
export { SelectAppComponent };
if (false) {
    /** @type {?} */
    SelectAppComponent.prototype.serverIp;
    /** @type {?} */
    SelectAppComponent.prototype.treeData;
    /** @type {?} */
    SelectAppComponent.prototype.funcModel;
    /** @type {?} */
    SelectAppComponent.prototype.columns;
    /** @type {?} */
    SelectAppComponent.prototype.items;
    /** @type {?} */
    SelectAppComponent.prototype.grid;
    /** @type {?} */
    SelectAppComponent.prototype.tt;
    /** @type {?} */
    SelectAppComponent.prototype.selectedAppID;
    /** @type {?} */
    SelectAppComponent.prototype.localeSer;
    /**
     * @type {?}
     * @private
     */
    SelectAppComponent.prototype.http;
    /**
     * @type {?}
     * @private
     */
    SelectAppComponent.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    SelectAppComponent.prototype.ngZone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LWFwcC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2lkZS1wdWJsaXNoLW1lbnUvIiwic291cmNlcyI6WyJsaWIvc2VsZWN0LWFwcC9zZWxlY3QtYXBwLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxNQUFNLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdEYsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ2pELE9BQU8sRUFBWSxrQkFBa0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUVsRDtJQWlDSSw0QkFDWSxJQUFpQixFQUNqQixRQUFrQixFQUNsQixNQUFjO1FBRmQsU0FBSSxHQUFKLElBQUksQ0FBYTtRQUNqQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLFdBQU0sR0FBTixNQUFNLENBQVE7UUEvQmpCLGFBQVEsR0FBRyxFQUFFLENBQUM7UUFDdkIsYUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNkLGNBQVMsR0FBUSxFQUFFLENBQUM7UUFFcEIsWUFBTyxHQUFHLEVBQUUsQ0FBQztRQUNiLFVBQUssR0FBRyxFQUFFLENBQUM7UUFxQlgsa0JBQWEsR0FBRyxFQUFFLENBQUM7UUFNWCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBMUJMLHNCQUFJLHVDQUFPOzs7O1FBQVg7WUFDSSxPQUFPLElBQUksQ0FBQyxRQUFRLEdBQUcsa0NBQWtDLENBQUM7UUFDOUQsQ0FBQzs7O09BQUE7SUFJRCxzQkFBSSxxQ0FB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b0hDO1NBaEhZLGtCQUFrQjs7O0lBQzNCLHNDQUF1Qjs7SUFDdkIsc0NBQWM7O0lBQ2QsdUNBQW9COztJQUVwQixxQ0FBYTs7SUFDYixtQ0FBVzs7SUFLWCxrQ0FBMkM7O0lBQzNDLGdDQUF3Qzs7SUFleEMsMkNBQW1COztJQUNuQix1Q0FBeUI7Ozs7O0lBRXJCLGtDQUF5Qjs7Ozs7SUFDekIsc0NBQTBCOzs7OztJQUMxQixvQ0FBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgTmdab25lLCBJbmplY3RvciwgSW5wdXQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBIdHRwU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvaWRlLWRldmtpdCc7XHJcbmltcG9ydCB7IFRyZWVOb2RlLCBUcmVlVGFibGVDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLXRyZWV0YWJsZSc7XHJcbmltcG9ydCB7IERhdGFncmlkQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1kYXRhZ3JpZCc7XHJcbmltcG9ydCB7IExvY2FsZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWxvY2FsZSc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICAgIHNlbGVjdG9yOiAnc2VsZWN0LWFwcCcsXHJcbiAgICB0ZW1wbGF0ZVVybDogJy4vc2VsZWN0LWFwcC5jb21wb25lbnQuaHRtbCcsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBTZWxlY3RBcHBDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xyXG4gICAgQElucHV0KCkgc2VydmVySXAgPSAnJztcclxuICAgIHRyZWVEYXRhID0gW107XHJcbiAgICBmdW5jTW9kZWw6IGFueSA9IHt9O1xyXG5cclxuICAgIGNvbHVtbnMgPSBbXTtcclxuICAgIGl0ZW1zID0gW107XHJcblxyXG4gICAgZ2V0IEFQUF9VUkkoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VydmVySXAgKyAnL2FwaS9ydW50aW1lL3N5cy92MS4wL2dzcGFwcC9hbGwnO1xyXG4gICAgfVxyXG4gICAgQFZpZXdDaGlsZCgnZ3JpZCcpIGdyaWQ6IERhdGFncmlkQ29tcG9uZW50O1xyXG4gICAgQFZpZXdDaGlsZCgndHQnKSB0dDogVHJlZVRhYmxlQ29tcG9uZW50O1xyXG5cclxuICAgIGdldCBhcHBJZCgpIHtcclxuICAgICAgICBpZiAodGhpcy50dCAmJiB0aGlzLnR0LnNlbGVjdGVkUm93KSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnR0LnNlbGVjdGVkUm93LmRhdGEuaWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIGdldCBhcHBJbnZva0lkKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmdyaWQgJiYgdGhpcy5ncmlkLnNlbGVjdGVkUm93KSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdyaWQuc2VsZWN0ZWRSb3cuaWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3RlZEFwcElEID0gJyc7XHJcbiAgICBsb2NhbGVTZXI6IExvY2FsZVNlcnZpY2U7XHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlIGh0dHA6IEh0dHBTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxyXG4gICAgICAgIHByaXZhdGUgbmdab25lOiBOZ1pvbmUpIHtcclxuICAgICAgICAgICAgdGhpcy5sb2NhbGVTZXIgPSB0aGlzLmluamVjdG9yLmdldChMb2NhbGVTZXJ2aWNlLCBudWxsKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5pbml0VHJlZURhdGEoKTtcclxuICAgICAgICB0aGlzLmNvbHVtbnMgPSBbXHJcbiAgICAgICAgICAgIHsgdGl0bGU6IHRoaXMubG9jYWxlU2VyLmdldFZhbHVlKCdwdWJsaXNobWVudS5hcHAuY29sdW1uLmNvZGUnKSwgZmllbGQ6ICdjb2RlJywgd2lkdGg6IDIwMCB9LFxyXG4gICAgICAgICAgICB7IHRpdGxlOiB0aGlzLmxvY2FsZVNlci5nZXRWYWx1ZSgncHVibGlzaG1lbnUuYXBwLmNvbHVtbi5uYW1lJyksIGZpZWxkOiAnbmFtZScsIHdpZHRoOiAxNTAgfVxyXG4gICAgICAgIF07XHJcbiAgICB9XHJcblxyXG4gICAgdHJlZU5vZGVDbGlja2VkKGUpIHtcclxuICAgICAgICB0aGlzLml0ZW1zID0gZS5ub2RlLmRhdGEuYXBwSW52b2tzIHx8IFtdO1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5mdW5jTW9kZWwgJiYgT2JqZWN0LmtleXModGhpcy5mdW5jTW9kZWwpLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYXBwSW52b2tJZCA9IHRoaXMuZnVuY01vZGVsLmFwcEludm9rSWQ7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWFwcEludm9rSWQpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLmdyaWQuc2VsZWN0Um93KGFwcEludm9rSWQsIGZhbHNlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sIDEwMCk7XHJcbiAgICAgICAgLy8gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgLy8gICAgIGlmICh0aGlzLmdyaWQgJiYgdGhpcy5pdGVtcy5sZW5ndGgpIHtcclxuICAgICAgICAvLyAgICAgICAgIHRoaXMuZ3JpZC5zZWxlY3RSb3codGhpcy5pdGVtc1swXS5pZCk7XHJcbiAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAvLyB9LCAxMDApO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaW5pdFRyZWVEYXRhKCkge1xyXG4gICAgICAgIHRoaXMuaHR0cC5nZXQodGhpcy5BUFBfVVJJKS5zdWJzY3JpYmUoZGF0YSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnRyZWVEYXRhID0gdGhpcy5jb252ZXJ0MlRyZWVOb2RlcyhkYXRhKTtcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmZ1bmNNb2RlbCAmJiBPYmplY3Qua2V5cyh0aGlzLmZ1bmNNb2RlbCkubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFwcElkID0gdGhpcy5mdW5jTW9kZWwuYXBwSWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXBwSWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJlZU5vZGUgPSB0aGlzLnR0LmZpbmRSb3dOb2RlKGFwcElkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyZWVOb2RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmVlTm9kZS5wYXJlbnRzLmZvckVhY2goKGlkKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50dC5leHBhbmROb2RlKGlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkQXBwSUQgPSBhcHBJZDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LCAyMDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjb252ZXJ0MlRyZWVOb2RlcyhkYXRhOiBhbnlbXSwgcGFyZW50SWQgPSAnJyk6IFRyZWVOb2RlW10ge1xyXG4gICAgICAgIGlmIChkYXRhLmxlbmd0aCkge1xyXG5cclxuICAgICAgICAgICAgY29uc3Qgbm9kZXMgPSBkYXRhLmZpbHRlcigodikgPT4ge1xyXG4gICAgICAgICAgICAgICAgbGV0IHBpZCA9IHYucGFyZW50SWQ7XHJcbiAgICAgICAgICAgICAgICBpZiAocGlkID09PSB1bmRlZmluZWQgfHwgcGlkID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGlkID0gJyc7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcGlkID09PSBwYXJlbnRJZDtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAvLyBjb25zdCBub2RlcyA9IGRhdGEuZmlsdGVyKCh2KSA9PiAodi5wYXJlbnRJZCB8fCAnJykgPT09IHBhcmVudElkKTtcclxuICAgICAgICAgICAgcmV0dXJuIG5vZGVzLm1hcChpdGVtID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5vZGUgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YTogaXRlbSxcclxuICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogW10sXHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0YWJsZTogaXRlbS5sYXllciA9PT0gJzQnXHJcbiAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgIG5vZGUuY2hpbGRyZW4gPSB0aGlzLmNvbnZlcnQyVHJlZU5vZGVzKGRhdGEsIGl0ZW0uaWQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcbn1cclxuIl19