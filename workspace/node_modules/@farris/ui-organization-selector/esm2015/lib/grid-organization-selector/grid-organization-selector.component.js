/**
 * @fileoverview added by tsickle
 * Generated from: lib/grid-organization-selector/grid-organization-selector.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ElementRef, EventEmitter, Injector, Renderer2, ViewChild } from '@angular/core';
import { CommonUtils, RuntimeStateService } from '@farris/ui-common';
import { GRID_EDITORS } from '@farris/ui-datagrid';
import { DatagridBaseEditorDirective } from '@farris/ui-datagrid-editors';
import * as _ from 'lodash-es';
import { isNull, isUndefined, omitBy, trim } from 'lodash-es';
/** @type {?} */
const organizationSelectorDefautOption = {
    absOrgType: 'System_organization',
    readonly: false,
    placeholder: '请选择',
    busNum: 'common',
    primaryField: 'orgId',
    displayField: 'name'
};
export class GridOrganizationSelectorComponent extends DatagridBaseEditorDirective {
    /**
     * @param {?} render
     * @param {?} el
     * @param {?} rts
     * @param {?} utils
     * @param {?} injector
     */
    constructor(render, el, rts, utils, injector) {
        super(render, el, injector);
        this.rts = rts;
        this.utils = utils;
        this.lookupFieldMap = (/**
         * @param {?} helpData
         * @param {?} mapFields
         * @param {?} dataObj
         * @return {?}
         */
        (helpData, mapFields, dataObj) => {
            if (mapFields) {
                /** @type {?} */
                const helpFields = Object.keys(mapFields);
                helpFields.forEach((/**
                 * @param {?} helpField
                 * @return {?}
                 */
                (helpField) => {
                    /** @type {?} */
                    let val = '';
                    if (helpData) {
                        if (helpData instanceof Array) {
                            val = helpData.map((/**
                             * @param {?} data
                             * @return {?}
                             */
                            (data) => { return this.utils.getValue(helpField, data); })).join(',');
                        }
                        else {
                            val = this.utils.getValue(helpField, helpData);
                        }
                    }
                    mapFields[helpField].split(',').forEach((/**
                     * @param {?} ff
                     * @return {?}
                     */
                    (ff) => {
                        /** @type {?} */
                        const formField = trim(ff);
                        this.utils.setValue(dataObj, formField, val);
                    }));
                }));
            }
        });
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        super.ngOnInit();
        this.options = Object.assign({}, organizationSelectorDefautOption, omitBy(this.options, (/**
         * @param {?} itemValue
         * @return {?}
         */
        (itemValue) => isUndefined(itemValue) || isNull(itemValue))));
        this.instance.selectedData = new EventEmitter();
        this.instance.clear = new EventEmitter();
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.inputElement = this.el.nativeElement;
        super.ngAfterViewInit();
        if (this.instance.ngControl &&
            this.instance.ngControl.formDirective &&
            this.instance.ngControl.formDirective.form &&
            this.instance.ngControl.formDirective.form.bindingData) {
            this.bindingData = this.instance.ngControl.formDirective.form.bindingData;
            this.bindingData.setValue = (/**
             * @param {?} fieldPath
             * @return {?}
             */
            (fieldPath) => {
                return this.utils.setValue(fieldPath.join('.'), this.bindingData, true);
            });
            this.bindingData.getValue = (/**
             * @param {?} fieldPath
             * @return {?}
             */
            (fieldPath) => {
                return this.utils.getValue(fieldPath.join('.'), this.bindingData, true);
            });
        }
    }
    /**
     * @param {?} selectedRow
     * @return {?}
     */
    updateControlValue(selectedRow) {
        if (this.instance.mapFields && this.bindingData) {
            this.lookupFieldMap(selectedRow, this.instance.mapFields, this.bindingData);
        }
    }
    /**
     * @return {?}
     */
    inputClear() {
        this.updateControlValue(null);
        this.instance.clear.emit();
        // 设计器上配置的清空事件
        if (this.options.inputClear) {
            this.options.inputClear();
        }
    }
    /**
     * @param {?} removedItem
     * @return {?}
     */
    tagRemoved(removedItem) {
        /** @type {?} */
        const mapFields = this.instance.mapFields;
        /** @type {?} */
        const helpFields = Object.keys(mapFields);
        /** @type {?} */
        const bindingData = _.cloneDeep(this.bindingData);
        /** @type {?} */
        const selectedData = [];
        helpFields.forEach((/**
         * @param {?} key
         * @return {?}
         */
        key => {
            /** @type {?} */
            let value = this.utils.getValue(mapFields[key], bindingData);
            /** @type {?} */
            const vArr = value.split(',');
            vArr.splice(removedItem.deleteIndex, 1);
            vArr.forEach((/**
             * @param {?} v
             * @param {?} i
             * @return {?}
             */
            (v, i) => {
                if (!selectedData[i]) {
                    selectedData.push({ index: i });
                    selectedData[i][key] = v;
                }
                else {
                    selectedData[i][key] = v;
                }
            }));
            value = vArr.join(',');
            this.utils.setValue(this.bindingData, mapFields[key], value);
        }));
        if (selectedData.length) {
            this.instance.selectedData.emit(selectedData);
        }
        else {
            this.instance.clear.emit();
        }
        // 设计器上配置的删除单个标签事件
        if (this.options.tagRemoved) {
            this.options.tagRemoved(this.eventPrams(removedItem));
        }
    }
    /**
     * @param {?} changeData
     * @return {?}
     */
    selectionsChange(changeData) {
        /** @type {?} */
        const formedSelections = this.formSelectedRowData();
        this.updateControlValue(formedSelections);
        this.instance.selectedData.emit(formedSelections);
        // 设计器上配置的选中数据后事件
        if (this.options.selectionsChange) {
            this.options.selectionsChange(this.eventPrams(changeData));
        }
    }
    /**
     * @return {?}
     */
    formSelectedRowData() {
        /** @type {?} */
        let selectedRowData = [];
        this.instance.selections.forEach((/**
         * @param {?} item
         * @return {?}
         */
        (item) => {
            /** @type {?} */
            const defaultDisplayName = this.instance.displayField ? item[this.instance.displayField] : `${item.name}`;
            /** @type {?} */
            const displayName = this.instance.formatFn ? this.instance.formatFn(item) : defaultDisplayName;
            selectedRowData.push(Object.assign({}, item, { displayName }));
        }));
        return selectedRowData.length ? selectedRowData : null;
    }
    /**
     * @private
     * @param {?} $event
     * @return {?}
     */
    eventPrams($event) {
        /** @type {?} */
        const p = this.eventParams($event);
        p['instance'] = this.instance;
        p['editor'] = this;
        return p;
    }
}
GridOrganizationSelectorComponent.decorators = [
    { type: Component, args: [{
                selector: 'grid-organization-selector',
                template: "<div [formGroup]=\"group\" class=\"f-datagrid-cell-formgroup farris-group-auto\">\r\n    <farris-organization-selector #orgSelection style=\"width: 100%\"\r\n    [placeholder]=\"options.placeholder\" [readonly]=\"options.readonly\" [absOrgType]=\"options.absOrgType\"\r\n    [multiSelect]=\"options.multiSelect\"  [mapFields]=\"options.mapFields\" [formControlName]=\"column.field\" \r\n    [primaryField]=\"options.primaryField\" [displayField]=\"options.displayField\" [formatFn]=\"options.formatter\"\r\n    [layer]=\"options.expandLevel\" [enableHierarchicalLoading]=\"options.enableHierarchicalLoading\"\r\n    [cascadeCheck]=\"options.cascadeCheck\" [cascadeDown]=\"options.cascadeDown\" [cascadeUp]=\"options.cascadeUp\"\r\n    [showTabIds]=\"options.showTabIds\" [activeTabId]=\"options.activeTabId\" [busNum]=\"options.busNum\"\r\n    (inputClear)=\"inputClear()\" (selectionsChange)=\"selectionsChange($event)\" (tagRemoved)=\"tagRemoved($event)\">\r\n    </farris-organization-selector>\r\n</div>\r\n",
                styles: [""]
            }] }
];
/** @nocollapse */
GridOrganizationSelectorComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef },
    { type: RuntimeStateService },
    { type: CommonUtils },
    { type: Injector }
];
GridOrganizationSelectorComponent.propDecorators = {
    instance: [{ type: ViewChild, args: ['orgSelection',] }]
};
if (false) {
    /** @type {?} */
    GridOrganizationSelectorComponent.prototype.instance;
    /** @type {?} */
    GridOrganizationSelectorComponent.prototype.bindingData;
    /** @type {?} */
    GridOrganizationSelectorComponent.prototype.lookupFieldMap;
    /**
     * @type {?}
     * @private
     */
    GridOrganizationSelectorComponent.prototype.rts;
    /** @type {?} */
    GridOrganizationSelectorComponent.prototype.utils;
}
/** @type {?} */
export const OrganizationSelectorDataGridEditorProvider = { provide: GRID_EDITORS, useValue: { name: 'OrganizationSelector', value: GridOrganizationSelectorComponent }, multi: true };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JpZC1vcmdhbml6YXRpb24tc2VsZWN0b3IuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1vcmdhbml6YXRpb24tc2VsZWN0b3IvIiwic291cmNlcyI6WyJsaWIvZ3JpZC1vcmdhbml6YXRpb24tc2VsZWN0b3IvZ3JpZC1vcmdhbml6YXRpb24tc2VsZWN0b3IuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBeUIsVUFBVSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzSCxPQUFPLEVBQUUsV0FBVyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDckUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25ELE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzFFLE9BQU8sS0FBSyxDQUFDLE1BQU0sV0FBVyxDQUFDO0FBQy9CLE9BQU8sRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7O01BR3hELGdDQUFnQyxHQUFHO0lBQ3ZDLFVBQVUsRUFBRSxxQkFBcUI7SUFDakMsUUFBUSxFQUFFLEtBQUs7SUFDZixXQUFXLEVBQUUsS0FBSztJQUNsQixNQUFNLEVBQUUsUUFBUTtJQUNoQixZQUFZLEVBQUUsT0FBTztJQUNyQixZQUFZLEVBQUUsTUFBTTtDQUNyQjtBQU9ELE1BQU0sT0FBTyxpQ0FBa0MsU0FBUSwyQkFBMkI7Ozs7Ozs7O0lBTTlFLFlBQ0ksTUFBaUIsRUFDakIsRUFBYyxFQUNOLEdBQXdCLEVBQ3pCLEtBQWtCLEVBQ3pCLFFBQWtCO1FBRWxCLEtBQUssQ0FBQyxNQUFNLEVBQUUsRUFBRSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBSnBCLFFBQUcsR0FBSCxHQUFHLENB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QixDQUFDLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUM7UUFDbEMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDOUIsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNuQixPQUFPLENBQUMsQ0FBQztJQUNYLENBQUM7OztZQWxKSixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLDRCQUE0QjtnQkFDdEMsKy9CQUEwRDs7YUFFM0Q7Ozs7WUFyQjhFLFNBQVM7WUFBN0MsVUFBVTtZQUMvQixtQkFBbUI7WUFBaEMsV0FBVztZQURpRCxRQUFROzs7dUJBd0J4RSxTQUFTLFNBQUMsY0FBYzs7OztJQUF6QixxREFBbUk7O0lBRW5JLHdEQUFpQjs7SUFzQ2pCLDJEQWtCQzs7Ozs7SUFuREcsZ0RBQWdDOztJQUNoQyxrREFBeUI7OztBQXNJakMsTUFBTSxPQUFPLDBDQUEwQyxHQUFHLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsRUFBRSxJQUFJLEVBQUUsc0JBQXNCLEVBQUUsS0FBSyxFQUFFLGlDQUFpQyxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0LCBBZnRlclZpZXdJbml0LCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIEluamVjdG9yLCBSZW5kZXJlcjIsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBDb21tb25VdGlscywgUnVudGltZVN0YXRlU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktY29tbW9uJztcclxuaW1wb3J0IHsgR1JJRF9FRElUT1JTIH0gZnJvbSAnQGZhcnJpcy91aS1kYXRhZ3JpZCc7XHJcbmltcG9ydCB7IERhdGFncmlkQmFzZUVkaXRvckRpcmVjdGl2ZSB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YWdyaWQtZWRpdG9ycyc7XHJcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoLWVzJztcclxuaW1wb3J0IHsgaXNOdWxsLCBpc1VuZGVmaW5lZCwgb21pdEJ5LCB0cmltIH0gZnJvbSAnbG9kYXNoLWVzJztcclxuaW1wb3J0IHsgT3JnYW5pemF0aW9uU2VsZWN0b3JDb21wb25lbnQgfSBmcm9tICcuLi9vcmdhbml6YXRpb24tc2VsZWN0b3IuY29tcG9uZW50JztcclxuXHJcbmNvbnN0IG9yZ2FuaXphdGlvblNlbGVjdG9yRGVmYXV0T3B0aW9uID0ge1xyXG4gIGFic09yZ1R5cGU6ICdTeXN0ZW1fb3JnYW5pemF0aW9uJyxcclxuICByZWFkb25seTogZmFsc2UsXHJcbiAgcGxhY2Vob2xkZXI6ICfor7fpgInmi6knLFxyXG4gIGJ1c051bTogJ2NvbW1vbicsXHJcbiAgcHJpbWFyeUZpZWxkOiAnb3JnSWQnLFxyXG4gIGRpc3BsYXlGaWVsZDogJ25hbWUnXHJcbn07XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ2dyaWQtb3JnYW5pemF0aW9uLXNlbGVjdG9yJyxcclxuICB0ZW1wbGF0ZVVybDogJy4vZ3JpZC1vcmdhbml6YXRpb24tc2VsZWN0b3IuY29tcG9uZW50Lmh0bWwnLFxyXG4gIHN0eWxlVXJsczogWycuL2dyaWQtb3JnYW5pemF0aW9uLXNlbGVjdG9yLmNvbXBvbmVudC5jc3MnXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgR3JpZE9yZ2FuaXphdGlvblNlbGVjdG9yQ29tcG9uZW50IGV4dGVuZHMgRGF0YWdyaWRCYXNlRWRpdG9yRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcclxuXHJcbiAgICBAVmlld0NoaWxkKCdvcmdTZWxlY3Rpb24nKSBpbnN0YW5jZTogT3JnYW5pemF0aW9uU2VsZWN0b3JDb21wb25lbnQgJiB7IGNsZWFyOiBFdmVudEVtaXR0ZXI8YW55Pjsgc2VsZWN0ZWREYXRhOiBFdmVudEVtaXR0ZXI8YW55PiB9O1xyXG5cclxuICAgIGJpbmRpbmdEYXRhOiBhbnk7XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcmVuZGVyOiBSZW5kZXJlcjIsXHJcbiAgICAgICAgZWw6IEVsZW1lbnRSZWYsXHJcbiAgICAgICAgcHJpdmF0ZSBydHM6IFJ1bnRpbWVTdGF0ZVNlcnZpY2UsXHJcbiAgICAgICAgcHVibGljIHV0aWxzOiBDb21tb25VdGlscyxcclxuICAgICAgICBpbmplY3RvcjogSW5qZWN0b3JcclxuICAgICkge1xyXG4gICAgICAgIHN1cGVyKHJlbmRlciwgZWwsIGluamVjdG9yKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uSW5pdCgpIHtcclxuICAgICAgICBzdXBlci5uZ09uSW5pdCgpO1xyXG4gICAgICAgIHRoaXMub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIG9yZ2FuaXphdGlvblNlbGVjdG9yRGVmYXV0T3B0aW9uLCBvbWl0QnkodGhpcy5vcHRpb25zLCAoaXRlbVZhbHVlKSA9PiBpc1VuZGVmaW5lZChpdGVtVmFsdWUpIHx8IGlzTnVsbChpdGVtVmFsdWUpKSk7XHJcbiAgICAgICAgdGhpcy5pbnN0YW5jZS5zZWxlY3RlZERhdGEgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuICAgICAgICB0aGlzLmluc3RhbmNlLmNsZWFyID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuaW5wdXRFbGVtZW50ID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50O1xyXG4gICAgICAgIHN1cGVyLm5nQWZ0ZXJWaWV3SW5pdCgpO1xyXG4gICAgICAgIGlmIChcclxuICAgICAgICAgIHRoaXMuaW5zdGFuY2UubmdDb250cm9sICYmXHJcbiAgICAgICAgICB0aGlzLmluc3RhbmNlLm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlICYmXHJcbiAgICAgICAgICB0aGlzLmluc3RhbmNlLm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0gJiZcclxuICAgICAgICAgIHRoaXMuaW5zdGFuY2UubmdDb250cm9sLmZvcm1EaXJlY3RpdmUuZm9ybS5iaW5kaW5nRGF0YVxyXG4gICAgICAgICkge1xyXG4gICAgICAgICAgdGhpcy5iaW5kaW5nRGF0YSA9IHRoaXMuaW5zdGFuY2UubmdDb250cm9sLmZvcm1EaXJlY3RpdmUuZm9ybS5iaW5kaW5nRGF0YTtcclxuICAgICAgICAgIHRoaXMuYmluZGluZ0RhdGEuc2V0VmFsdWUgPSAoZmllbGRQYXRoKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnV0aWxzLnNldFZhbHVlKGZpZWxkUGF0aC5qb2luKCcuJyksIHRoaXMuYmluZGluZ0RhdGEsIHRydWUpO1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIHRoaXMuYmluZGluZ0RhdGEuZ2V0VmFsdWUgPSAoZmllbGRQYXRoKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnV0aWxzLmdldFZhbHVlKGZpZWxkUGF0aC5qb2luKCcuJyksIHRoaXMuYmluZGluZ0RhdGEsIHRydWUpO1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbG9va3VwRmllbGRNYXAgPSAoaGVscERhdGE6IGFueSwgbWFwRmllbGRzOiBhbnksIGRhdGFPYmo6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmIChtYXBGaWVsZHMpIHtcclxuICAgICAgICAgICAgY29uc3QgaGVscEZpZWxkcyA9IE9iamVjdC5rZXlzKG1hcEZpZWxkcyk7XHJcbiAgICAgICAgICAgIGhlbHBGaWVsZHMuZm9yRWFjaCgoaGVscEZpZWxkOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGxldCB2YWwgPSAnJztcclxuICAgICAgICAgICAgICAgIGlmIChoZWxwRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChoZWxwRGF0YSBpbnN0YW5jZW9mIEFycmF5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IGhlbHBEYXRhLm1hcCgoZGF0YTogYW55KSA9PiB7IHJldHVybiB0aGlzLnV0aWxzLmdldFZhbHVlKGhlbHBGaWVsZCwgZGF0YSk7IH0pLmpvaW4oJywnKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSB0aGlzLnV0aWxzLmdldFZhbHVlKGhlbHBGaWVsZCwgaGVscERhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIG1hcEZpZWxkc1toZWxwRmllbGRdLnNwbGl0KCcsJykuZm9yRWFjaCgoZmY6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcm1GaWVsZCA9IHRyaW0oZmYpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXRpbHMuc2V0VmFsdWUoZGF0YU9iaiwgZm9ybUZpZWxkLCB2YWwpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVDb250cm9sVmFsdWUoc2VsZWN0ZWRSb3c6IGFueSkge1xyXG4gICAgICAgIGlmICh0aGlzLmluc3RhbmNlLm1hcEZpZWxkcyAmJiB0aGlzLmJpbmRpbmdEYXRhKSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwRmllbGRNYXAoc2VsZWN0ZWRSb3csIHRoaXMuaW5zdGFuY2UubWFwRmllbGRzLCB0aGlzLmJpbmRpbmdEYXRhKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaW5wdXRDbGVhcigpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZUNvbnRyb2xWYWx1ZShudWxsKTtcclxuICAgICAgICB0aGlzLmluc3RhbmNlLmNsZWFyLmVtaXQoKTtcclxuICAgICAgICAvLyDorr7orqHlmajkuIrphY3nva7nmoTmuIXnqbrkuovku7ZcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmlucHV0Q2xlYXIpIHtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zLmlucHV0Q2xlYXIoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdGFnUmVtb3ZlZChyZW1vdmVkSXRlbToge1xyXG4gICAgICAgIGRlbGV0ZUl0ZW06IGFueSxcclxuICAgICAgICBkZWxldGVJbmRleDogbnVtYmVyLFxyXG4gICAgICAgIHNlbGVjdGlvbnM6IEFycmF5PGFueT5cclxuICAgIH0pIHtcclxuICAgICAgICBjb25zdCBtYXBGaWVsZHMgPSB0aGlzLmluc3RhbmNlLm1hcEZpZWxkcztcclxuICAgICAgICBjb25zdCBoZWxwRmllbGRzID0gT2JqZWN0LmtleXMobWFwRmllbGRzKTtcclxuICAgICAgICBjb25zdCBiaW5kaW5nRGF0YSA9IF8uY2xvbmVEZWVwKHRoaXMuYmluZGluZ0RhdGEpO1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdGVkRGF0YSA9IFtdO1xyXG4gICAgXHJcbiAgICAgICAgaGVscEZpZWxkcy5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLnV0aWxzLmdldFZhbHVlKG1hcEZpZWxkc1trZXldLCBiaW5kaW5nRGF0YSk7XHJcbiAgICAgICAgICBjb25zdCB2QXJyID0gdmFsdWUuc3BsaXQoJywnKTtcclxuICAgICAgICAgIHZBcnIuc3BsaWNlKHJlbW92ZWRJdGVtLmRlbGV0ZUluZGV4LCAxKTtcclxuICAgICAgICAgIHZBcnIuZm9yRWFjaCgodiwgaSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIXNlbGVjdGVkRGF0YVtpXSkge1xyXG4gICAgICAgICAgICAgIHNlbGVjdGVkRGF0YS5wdXNoKHsgaW5kZXg6IGkgfSk7XHJcbiAgICAgICAgICAgICAgc2VsZWN0ZWREYXRhW2ldW2tleV0gPSB2O1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIHNlbGVjdGVkRGF0YVtpXVtrZXldID0gdjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICB2YWx1ZSA9IHZBcnIuam9pbignLCcpO1xyXG4gICAgICAgICAgdGhpcy51dGlscy5zZXRWYWx1ZSh0aGlzLmJpbmRpbmdEYXRhLCBtYXBGaWVsZHNba2V5XSwgdmFsdWUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGlmIChzZWxlY3RlZERhdGEubGVuZ3RoKSB7XHJcbiAgICAgICAgICB0aGlzLmluc3RhbmNlLnNlbGVjdGVkRGF0YS5lbWl0KHNlbGVjdGVkRGF0YSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMuaW5zdGFuY2UuY2xlYXIuZW1pdCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDorr7orqHlmajkuIrphY3nva7nmoTliKDpmaTljZXkuKrmoIfnrb7kuovku7ZcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLnRhZ1JlbW92ZWQpIHtcclxuICAgICAgICAgIHRoaXMub3B0aW9ucy50YWdSZW1vdmVkKHRoaXMuZXZlbnRQcmFtcyhyZW1vdmVkSXRlbSkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3Rpb25zQ2hhbmdlKGNoYW5nZURhdGE6IHtcclxuICAgICAgICBpbmZvOiBzdHJpbmcsXHJcbiAgICAgICAgZGF0YTogQXJyYXk8YW55PlxyXG4gICAgfSkge1xyXG4gICAgICBjb25zdCBmb3JtZWRTZWxlY3Rpb25zID0gdGhpcy5mb3JtU2VsZWN0ZWRSb3dEYXRhKCk7XHJcbiAgICAgIHRoaXMudXBkYXRlQ29udHJvbFZhbHVlKGZvcm1lZFNlbGVjdGlvbnMpO1xyXG4gICAgICB0aGlzLmluc3RhbmNlLnNlbGVjdGVkRGF0YS5lbWl0KGZvcm1lZFNlbGVjdGlvbnMpO1xyXG4gICAgICAvLyDorr7orqHlmajkuIrphY3nva7nmoTpgInkuK3mlbDmja7lkI7kuovku7ZcclxuICAgICAgaWYgKHRoaXMub3B0aW9ucy5zZWxlY3Rpb25zQ2hhbmdlKSB7XHJcbiAgICAgICAgdGhpcy5vcHRpb25zLnNlbGVjdGlvbnNDaGFuZ2UodGhpcy5ldmVudFByYW1zKGNoYW5nZURhdGEpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZvcm1TZWxlY3RlZFJvd0RhdGEoKSB7XHJcbiAgICAgIGxldCBzZWxlY3RlZFJvd0RhdGEgPSBbXTtcclxuICAgICAgdGhpcy5pbnN0YW5jZS5zZWxlY3Rpb25zLmZvckVhY2goKGl0ZW0pID0+IHtcclxuICAgICAgICBjb25zdCBkZWZhdWx0RGlzcGxheU5hbWUgPSB0aGlzLmluc3RhbmNlLmRpc3BsYXlGaWVsZCA/IGl0ZW1bdGhpcy5pbnN0YW5jZS5kaXNwbGF5RmllbGRdIDogYCR7aXRlbS5uYW1lfWA7XHJcbiAgICAgICAgY29uc3QgZGlzcGxheU5hbWUgPSB0aGlzLmluc3RhbmNlLmZvcm1hdEZuID8gdGhpcy5pbnN0YW5jZS5mb3JtYXRGbihpdGVtKSA6IGRlZmF1bHREaXNwbGF5TmFtZTtcclxuICAgICAgICBzZWxlY3RlZFJvd0RhdGEucHVzaChPYmplY3QuYXNzaWduKHt9LCBpdGVtLCB7IGRpc3BsYXlOYW1lIH0pKTtcclxuICAgICAgfSlcclxuICAgICAgcmV0dXJuIHNlbGVjdGVkUm93RGF0YS5sZW5ndGggPyBzZWxlY3RlZFJvd0RhdGEgOiBudWxsO1xyXG4gICAgfVxyXG4gIFxyXG4gICAgcHJpdmF0ZSBldmVudFByYW1zKCRldmVudCk6IGFueSB7XHJcbiAgICAgIGNvbnN0IHAgPSB0aGlzLmV2ZW50UGFyYW1zKCRldmVudCk7XHJcbiAgICAgIHBbJ2luc3RhbmNlJ10gPSB0aGlzLmluc3RhbmNlO1xyXG4gICAgICBwWydlZGl0b3InXSA9IHRoaXM7XHJcbiAgICAgIHJldHVybiBwO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgY29uc3QgT3JnYW5pemF0aW9uU2VsZWN0b3JEYXRhR3JpZEVkaXRvclByb3ZpZGVyID0geyBwcm92aWRlOiBHUklEX0VESVRPUlMsIHVzZVZhbHVlOiB7IG5hbWU6ICdPcmdhbml6YXRpb25TZWxlY3RvcicsIHZhbHVlOiBHcmlkT3JnYW5pemF0aW9uU2VsZWN0b3JDb21wb25lbnQgfSwgbXVsdGk6IHRydWUgfSJdfQ==