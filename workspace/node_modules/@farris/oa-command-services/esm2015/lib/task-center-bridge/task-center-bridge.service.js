/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { MessagerService } from '@farris/ui-messager';
import { SyncTaskSchdule } from '../utils/sync-task-shchdule';
import { WFActionType } from './entity';
import * as i0 from "@angular/core";
import * as i1 from "@farris/ui-messager";
export class TaskCenterBridgeService {
    /**
     * @param {?} msgService
     */
    constructor(msgService) {
        this.msgService = msgService;
        this.taskSchdule = new SyncTaskSchdule();
    }
    /**
     * @param {?} customerCmds
     * @return {?}
     */
    initTaskCenterBridge(customerCmds) {
        /** @type {?} */
        const bridgeWin = window.parent;
        /** @type {?} */
        let frameContext;
        try {
            frameContext = this['context'].frameContext;
        }
        catch (error) {
            throw new Error('can not find frameContex');
        }
        /** @type {?} */
        let slienceSaveTask;
        try {
            slienceSaveTask = this['context'].frameContext.viewModel.slienceSave1;
        }
        catch (error) {
            // 不存在静音保存命令
        }
        if (bridgeWin) {
            bridgeWin['taskCenterBeforeLoad'] = (actionObj) => {
                return new Promise((resolve, reject) => {
                    const { action } = actionObj;
                    if (frameContext.uiState['UIStateInProcess'] == 'Approving' && frameContext.uiState['formConfigId']) {
                        slienceSaveTask.call(this).subscribe(() => {
                            resolve({
                                result: true
                            });
                        }, () => {
                            window.document.body.click();
                            if (action.code === WFActionType.Pass) { // 除了审评通过外，其它的不需要保存 
                                resolve({
                                    result: false
                                });
                            }
                            else if (action.code === WFActionType.Comment) {
                                resolve({
                                    result: true
                                });
                            }
                            else {
                                this.msgService.confirm('检测到单据保存失败，是否继续？').subscribe((confirm) => {
                                    resolve({
                                        result: confirm
                                    });
                                });
                            }
                        });
                    }
                    else if (action.code == WFActionType.Resubmit && slienceSaveTask) {
                        slienceSaveTask.call(this).subscribe(() => {
                            resolve({
                                result: true
                            });
                        });
                    }
                    else {
                        resolve({
                            result: true
                        });
                    }
                });
            };
        }
    }
    /**
     * @param {?} taskArray
     * @return {?}
     */
    executeSchedules(taskArray) {
        // 这里根据 任务名称，从 viewmodel中找到，然后依次执行
        taskArray = taskArray.split(',');
        // 这里需要验证拿到 commandService 
        /** @type {?} */
        let frameContext;
        try {
            frameContext = this['context'].frameContext;
        }
        catch (error) {
            throw new Error('can not find frameContex');
        }
        taskArray.forEach((item) => {
            /** @type {?} */
            let targetTask;
            try {
                targetTask = frameContext.viewModel[item];
                this.taskSchdule.propTask(targetTask, [], this, item).subscribe((res) => {
                    console.log(res);
                });
            }
            catch (error) {
                // 未找到应该在children中继续查找 未找到
                console.log(error);
            }
        });
    }
}
TaskCenterBridgeService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
TaskCenterBridgeService.ctorParameters = () => [
    { type: MessagerService }
];
/** @nocollapse */ TaskCenterBridgeService.ngInjectableDef = i0.defineInjectable({ factory: function TaskCenterBridgeService_Factory() { return new TaskCenterBridgeService(i0.inject(i1.MessagerService)); }, token: TaskCenterBridgeService, providedIn: "root" });
if (false) {
    /** @type {?} */
    TaskCenterBridgeService.prototype.taskSchdule;
    /** @type {?} */
    TaskCenterBridgeService.prototype.msgService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFzay1jZW50ZXItYnJpZGdlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL29hLWNvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvdGFzay1jZW50ZXItYnJpZGdlL3Rhc2stY2VudGVyLWJyaWRnZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDOUQsT0FBTyxFQUFZLFlBQVksRUFBVSxNQUFNLFVBQVUsQ0FBQzs7O0FBTTFELE1BQU0sT0FBTyx1QkFBdUI7Ozs7SUFLbEMsWUFDVSxVQUEyQjtRQUEzQixlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUVuQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksZUFBZSxFQUFFLENBQUM7SUFDM0MsQ0FBQzs7Ozs7SUFFTSxvQkFBb0IsQ0FBQyxZQUFnQjs7Y0FDcEMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxNQUFNOztZQUMzQixZQUEwQjtRQUM5QixJQUFJO1lBQ0YsWUFBWSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxZQUFZLENBQUE7U0FDNUM7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUNkLE1BQU0sSUFBSSxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQztTQUM3Qzs7WUFFRyxlQUFlO1FBRW5CLElBQUk7WUFDRixlQUFlLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDO1NBQ3ZFO1FBQUMsT0FBTyxLQUFLLEVBQUU7WUFDZCxZQUFZO1NBQ2I7UUFDRCxJQUFJLFNBQVMsRUFBRTtZQUNiLFNBQVMsQ0FBQyxzQkFBc0IsQ0FBQyxHQUFHLENBQ2xDLFNBR0MsRUFDRCxF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Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7Ozs7WUFQUSxlQUFlOzs7OztJQVd0Qiw4Q0FBNEI7O0lBRzFCLDZDQUFtQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBNZXNzYWdlclNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLW1lc3NhZ2VyJztcclxuaW1wb3J0IHsgU3luY1Rhc2tTY2hkdWxlIH0gZnJvbSAnLi4vdXRpbHMvc3luYy10YXNrLXNoY2hkdWxlJztcclxuaW1wb3J0IHsgV0ZBY3Rpb24sIFdGQWN0aW9uVHlwZSwgV0ZUYXNrIH0gZnJvbSAnLi9lbnRpdHknO1xyXG5cclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIFRhc2tDZW50ZXJCcmlkZ2VTZXJ2aWNlIHtcclxuXHJcblxyXG4gIHRhc2tTY2hkdWxlOiBTeW5jVGFza1NjaGR1bGVcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIG1zZ1NlcnZpY2U6IE1lc3NhZ2VyU2VydmljZSxcclxuICApIHtcclxuICAgIHRoaXMudGFza1NjaGR1bGUgPSBuZXcgU3luY1Rhc2tTY2hkdWxlKCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgaW5pdFRhc2tDZW50ZXJCcmlkZ2UoY3VzdG9tZXJDbWRzOiB7fSkge1xyXG4gICAgY29uc3QgYnJpZGdlV2luID0gd2luZG93LnBhcmVudDtcclxuICAgIGxldCBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dDtcclxuICAgIHRyeSB7XHJcbiAgICAgIGZyYW1lQ29udGV4dCA9IHRoaXNbJ2NvbnRleHQnXS5mcmFtZUNvbnRleHRcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignY2FuIG5vdCBmaW5kIGZyYW1lQ29udGV4Jyk7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHNsaWVuY2VTYXZlVGFzaztcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBzbGllbmNlU2F2ZVRhc2sgPSB0aGlzWydjb250ZXh0J10uZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5zbGllbmNlU2F2ZTE7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAvLyDkuI3lrZjlnKjpnZnpn7Pkv53lrZjlkb3ku6RcclxuICAgIH1cclxuICAgIGlmIChicmlkZ2VXaW4pIHtcclxuICAgICAgYnJpZGdlV2luWyd0YXNrQ2VudGVyQmVmb3JlTG9hZCddID0gKFxyXG4gICAgICAgIGFjdGlvbk9iajoge1xyXG4gICAgICAgICAgXCJ0YXNrXCI6IFdGVGFzayxcclxuICAgICAgICAgIFwiYWN0aW9uXCI6IFdGQWN0aW9uXHJcbiAgICAgICAgfVxyXG4gICAgICApID0+IHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgeyBhY3Rpb24gfSA9IGFjdGlvbk9iajtcclxuICAgICAgICAgIGlmIChmcmFtZUNvbnRleHQudWlTdGF0ZVsnVUlTdGF0ZUluUHJvY2VzcyddID09ICdBcHByb3ZpbmcnICYmIGZyYW1lQ29udGV4dC51aVN0YXRlWydmb3JtQ29uZmlnSWQnXSkge1xyXG4gICAgICAgICAgICBzbGllbmNlU2F2ZVRhc2suY2FsbCh0aGlzKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICAgIHJlc29sdmUoe1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0OiB0cnVlXHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0sICgpID0+IHtcclxuICAgICAgICAgICAgICB3aW5kb3cuZG9jdW1lbnQuYm9keS5jbGljaygpXHJcbiAgICAgICAgICAgICAgaWYgKGFjdGlvbi5jb2RlID09PSBXRkFjdGlvblR5cGUuUGFzcykgeyAvLyDpmaTkuoblrqHor4TpgJrov4flpJbvvIzlhbblroPnmoTkuI3pnIDopoHkv53lrZggXHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKHtcclxuICAgICAgICAgICAgICAgICAgcmVzdWx0OiBmYWxzZVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24uY29kZSA9PT0gV0ZBY3Rpb25UeXBlLkNvbW1lbnQpIHtcclxuICAgICAgICAgICAgICAgIHJlc29sdmUoe1xyXG4gICAgICAgICAgICAgICAgICByZXN1bHQ6IHRydWVcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1zZ1NlcnZpY2UuY29uZmlybSgn5qOA5rWL5Yiw5Y2V5o2u5L+d5a2Y5aSx6LSl77yM5piv5ZCm57un57ut77yfJykuc3Vic2NyaWJlKChjb25maXJtKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIHJlc29sdmUoe1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdDogY29uZmlybVxyXG4gICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uLmNvZGUgPT0gV0ZBY3Rpb25UeXBlLlJlc3VibWl0ICYmIHNsaWVuY2VTYXZlVGFzaykge1xyXG4gICAgICAgICAgICBzbGllbmNlU2F2ZVRhc2suY2FsbCh0aGlzKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICAgIHJlc29sdmUoe1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0OiB0cnVlXHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXNvbHZlKHtcclxuICAgICAgICAgICAgICByZXN1bHQ6IHRydWVcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGV4ZWN1dGVTY2hlZHVsZXModGFza0FycmF5KSB7XHJcbiAgICAvLyDov5nph4zmoLnmja4g5Lu75Yqh5ZCN56ew77yM5LuOIHZpZXdtb2RlbOS4reaJvuWIsO+8jOeEtuWQjuS+neasoeaJp+ihjFxyXG4gICAgdGFza0FycmF5ID0gdGFza0FycmF5LnNwbGl0KCcsJyk7XHJcbiAgICAvLyDov5nph4zpnIDopoHpqozor4Hmi7/liLAgY29tbWFuZFNlcnZpY2UgXHJcbiAgICBsZXQgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQ7XHJcbiAgICB0cnkge1xyXG4gICAgICBmcmFtZUNvbnRleHQgPSB0aGlzWydjb250ZXh0J10uZnJhbWVDb250ZXh0XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NhbiBub3QgZmluZCBmcmFtZUNvbnRleCcpO1xyXG4gICAgfVxyXG4gICAgdGFza0FycmF5LmZvckVhY2goKGl0ZW0pID0+IHtcclxuICAgICAgbGV0IHRhcmdldFRhc2s7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgdGFyZ2V0VGFzayA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWxbaXRlbV07XHJcbiAgICAgICAgdGhpcy50YXNrU2NoZHVsZS5wcm9wVGFzayh0YXJnZXRUYXNrLCBbXSwgdGhpcywgaXRlbSkuc3Vic2NyaWJlKChyZXMpID0+IHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKHJlcyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgLy8g5pyq5om+5Yiw5bqU6K+l5ZyoY2hpbGRyZW7kuK3nu6fnu63mn6Xmib4g5pyq5om+5YiwXHJcbiAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xyXG4gICAgICB9XHJcbiAgICB9KVxyXG5cclxuICB9XHJcblxyXG59XHJcbiJdfQ==