!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@farris/ui-datagrid-editors"),require("@angular/core"),require("@farris/devkit"),require("rxjs"),require("@angular/common"),require("@farris/ui-dialog"),require("@farris/ui-modal"),require("@angular/common/http"),require("@angular/forms"),require("@farris/ui-locale"),require("@farris/ui-perfect-scrollbar"),require("@farris/ui-tree"),require("@farris/ui-tabs"),require("@farris/ui-common"),require("@farris/ui-forms"),require("@farris/ui-text"),require("@farris/ui-messager"),require("@farris/ui-notify"),require("@farris/ui-layout"),require("@farris/ui-datagrid"),require("@farris/ui-input-group"),require("@farris/ui-forms/validation-message"),require("@farris/ui-list-nav"),require("@farris/ui-list-view"),require("@angular/router")):"function"==typeof define&&define.amd?define("@farris/external-integration",["exports","@farris/ui-datagrid-editors","@angular/core","@farris/devkit","rxjs","@angular/common","@farris/ui-dialog","@farris/ui-modal","@angular/common/http","@angular/forms","@farris/ui-locale","@farris/ui-perfect-scrollbar","@farris/ui-tree","@farris/ui-tabs","@farris/ui-common","@farris/ui-forms","@farris/ui-text","@farris/ui-messager","@farris/ui-notify","@farris/ui-layout","@farris/ui-datagrid","@farris/ui-input-group","@farris/ui-forms/validation-message","@farris/ui-list-nav","@farris/ui-list-view","@angular/router"],e):e((t.farris=t.farris||{},t.farris["external-integration"]={}),t.uiDatagridEditors,t.ng.core,t.devkit,t.rxjs,t.ng.common,t.uiDialog,t.uiModal,t.ng.common.http,t.ng.forms,t.uiLocale,t.uiPerfectScrollbar,t.uiTree,t.uiTabs,t.uiCommon,t.uiForms,t.uiText,t.uiMessager,t.uiNotify,t.uiLayout,t.uiDatagrid,t.uiInputGroup,t.validationMessage,t.uiListNav,t.uiListView,t.ng.router)}(this,function(t,e,s,r,l,i,a,n,o,p,u,c,d,f,g,h,m,y,v,b,x,D,w,S,L,j){"use strict";var C=function(t,e){return(C=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};var M,I,B={readonly:!1,placeholder:"请选择",viewType:"tag"},e=(M=e.DatagridBaseEditorDirective,C(I=E,e=M),I.prototype=null===e?Object.create(e):(k.prototype=e.prototype,new k),E.prototype.ngOnInit=function(){var e=this;M.prototype.ngOnInit.call(this),this.inputElement=this.instance.input.nativeElement,this.options=Object.assign({},B,this.options),this.column.editor.options.onBlur=function(t){t.editorRef.startPending(),t.editorRef.formControl.setValue(e.instance.fieldText),e.instance.callSapService(),e.instance.afterOnblur.subscribe(function(){t.editorRef.endPending()})}},E.prototype.ngAfterViewInit=function(){M.prototype.ngAfterViewInit.call(this)},E.decorators=[{type:s.Component,args:[{selector:"grid-external-integration",template:'\n    <div [formGroup]="group" class="f-datagrid-cell-formgroup farris-group-auto">\n      <web-external-integration\n        #extIntgrtn\n        style="width: 100%"\n        extIntegration-dataMapping\n        [placeholder]="options.placeholder"\n        [readonly]="options.readonly"\n        [mapFields]="options.mapFields"\n        [serviceCode] = "options.serviceCode"\n        [externalParams] = "options.externalParams"\n        [extTableSchemas] = "options.extTableSchemas"\n        [formControlName]="column.field"\n        [mappingType] = "\'grid\'"\n        \n      ></web-external-integration>\n    </div>\n  '}]}],E.ctorParameters=function(){return[{type:s.Renderer2},{type:s.ElementRef},{type:g.RuntimeStateService},{type:s.Injector}]},E.propDecorators={instance:[{type:s.ViewChild,args:["extIntgrtn"]}]},E);function k(){this.constructor=I}function E(t,e,r,i){t=M.call(this,t,e,i)||this;return t.rts=r,t.stopPropagation=!1,t}var N={provide:x.GRID_EDITORS,useValue:{name:"external-integration",value:e},multi:!0},O=(T.prototype.queryExtIntegrationService=function(t,e){var r=this,t=this.assembleSapRequest(t,e);this.http.post(this.sapUrl,t).subscribe(function(t){var t=Object.create(t);t&&t.success&&(t=Object.create(t).data,r.sapData.emit(t))},function(t){console.log(t),r.sapData.emit({})})},T.prototype.assembleSapRequest=function(t,e){t=JSON.parse(JSON.stringify(t));return{code:e,params:this.variableParseService.parse(t,this.vm.frameContext)}},T.decorators=[{type:s.Injectable}],T.ctorParameters=function(){return[{type:o.HttpClient},{type:r.VariableParseService},{type:r.ViewModel}]},T.propDecorators={sapData:[{type:s.Output}]},T);function T(t,e,r){this.http=t,this.variableParseService=e,this.vm=r,this.sapData=new s.EventEmitter,this.sapUrl="/api/runtime/icc/v1.0/externalServiceOpenApi/invokeService"}V.prototype.ngOnChanges=function(t){},V.prototype.fieldTextChange=function(){var t=this.getBindingPathArray();this.vm.bindingData.setValue(t.concat(this.ngControl.name),this.fieldText,!0,!0)},V.prototype.ngAfterViewInit=function(){},V.prototype.ngOnDestroy=function(){},V.prototype.writeValue=function(t){this.fieldText=t},V.prototype.registerOnChange=function(t){},V.prototype.registerOnTouched=function(t){},V.prototype.setDisabledState=function(t){},V.prototype.ngOnInit=function(){var e=this;this.ngControl=this.inj.get(p.NgControl),"grid"!=this.mappingType&&(this.input.nativeElement.onblur=function(){e.callSapService()}),this.extIntgrtnSrvc.sapData.subscribe(function(t){e.sapDataHandle(t)})},V.prototype.showDialog=function(){return this.farrisListView.listClick.emit({data:[this.tableData[0]],index:0,checkChangeEvent:!1}),this.farrisListView.clickItem=this.tableData[0],this.dialog.show(),!1},V.prototype.callSapService=function(){this.fieldTextChange(),this.extIntgrtnSrvc.queryExtIntegrationService(this.externalParams,this.serviceCode)},V.prototype.sapDataHandle=function(e){var r,i,t,a,n=this;e&&(a=Object.keys(e),r=this.getTableListFromMapFields(),1<(a=a.filter(function(t){return-1!=r.indexOf(t)})).length?"open"==(t=this.checkMultiTableData(e,a))?(this.assembleTableData(e),this.showDialog()):"backfill"==t?(i={},a.forEach(function(t){Object.assign(i,n.assembleSapData(t,e[t][0]))}),this.sendSapData(i)):this.sendSapData():1==a.length?(t=a[0],0<(a=(e[t]||[]).length)&&(1==a?(t=this.assembleSapData(t,e[t][0]),this.sendSapData(t)):1<a&&(this.assembleTableData(e),this.showDialog()))):this.sendSapData())},V.prototype.checkMultiTableData=function(t,e){for(var r="",i=0;i<e.length;i++){var a=e[i];if(1<t[a].length){r="open";break}0==t[a].length&&"backfill"!=r?r="none":r="backfill"}return r},V.prototype.assembleTableData=function(e){var r=this,i=Object.keys(e),t=this.getTableListFromMapFields();0<(t=t.filter(function(t){return-1!=i.indexOf(t)})).length&&t.forEach(function(t){t=r.assembleTableInfo(t,e);t&&0<Object.keys(t).length&&0<(t.data||[]).length&&r.tableData.push(t)})},V.prototype.getTableListFromMapFields=function(){var t=Object.keys(this.myField),e=[];return(t||[]).forEach(function(t){e.push(t.split(".")[0])}),e=Array.from(new Set(e))},V.prototype.assembleTableInfo=function(e,r){var i={},a=[];return(this.extTableSchemas||[]).forEach(function(t){t.code==e&&(i.name=t.name,a.push({field:"id",title:"序号"}),t.columns.forEach(function(t){var e={};e.field=t.code,e.title=t.name,a.push(e)}),i.columns=a,i.code=e,(r[e]||[]).forEach(function(t,e){t.id=e+1}),i.data=r[e])}),i},V.prototype.listClick=function(t){var e=t.data;if(t.data.disable)return!1;if("undefined"!=typeof this.currentLink.data){if(e[0].code===this.currentLink.data[0].code)return!1;this.currentLink=t}else this.currentLink=t},V.prototype.confirm=function(t){if("ensure"==t){for(var e={},r=0;r<this.tableData.length;r++){var i=this.tableData[r];Object.assign(e,this.assembleSapData(i.code,i.selectedData.data))}this.sendSapData(e)}this.tableData=[],this.dialog.close()},V.prototype.selectRowChange=function(e,r){this.tableData.forEach(function(t){t.code==r&&(t.selectedData=e)}),this.setEnsureButtonFlag()},V.prototype.unSelect=function(t,e){this.tableData.forEach(function(t){t.code==e&&(t.selectedData=null,t.selectedValue="")}),this.setEnsureButtonFlag()},V.prototype.setEnsureButtonFlag=function(){for(var t=!1,e=0;e<this.tableData.length;e++)if(!this.tableData[e].selectedData){t=!0;break}this.ensureFlag=t},V.prototype.assembleSapData=function(t,e){if(t&&e){for(var r={},i=Object.keys(e),a=0;a<i.length;a++){var n=i[a];r[t+"."+n]=e[n]}return r}},V.prototype.sendSapData=function(t){t&&this.selectSapData.emit(t),"grid"==this.mappingType&&this.afterOnblur.emit()},V.prototype.getBindingPathArray=function(){var t=this.vm.bindingPath;return t?t.split("/").filter(function(t){return""!==t}):[]},V.decorators=[{type:s.Component,args:[{selector:"web-external-integration",template:'<input [(ngModel)]="fieldText" #input  class="form-control" input-end-edit [readonly]="false"\r\n  tabindex="0" maxlength="36" />\r\n\r\n<farris-dialog #dialog [title]="\'选择数据\'" [beforeClose]="beforeClose"  [width]="1000" [height]="834" [showButtons]="true" [showMaxButton]="true"\r\n  [showCloseButton]="true" [enableScroll]="false" [dialogHeaderHeight]="50" [buttons]="defaultButtonRef">\r\n  <div [ngStyle]="containerStyle" style="height: 100%;">\r\n    <div class="listnav-example-wrapper">\r\n      <div class="example-side-nav">\r\n        <farris-list-nav  [listNavWidth]="240" (listClick)="listClick($event)">\r\n          <ng-template listNavContent>\r\n            <farris-list-view #farrisListView [showEmpty]="true" [data]="tableData" [activeIndex]="3" listidName="code" (listClick)="listClick($event)">\r\n              <ng-template #navView listTemplate let-item="item" let-selected="selectedItem">\r\n                <div class="f-template-listnav-row">\r\n                  \x3c!-- routerLinkActive="active" --\x3e\r\n                  <a class="list-nav-link" [ngStyle]="{\'pointer-events\': item.disable ?\'none\' : \'\',\'width\':240 +\'px\'}"\r\n                     [title]="item.name">\r\n                    <span class="nav-item-name">\r\n                      {{ item.name }}\r\n                    </span>\r\n                  </a>\r\n                </div>\r\n              </ng-template>\r\n            </farris-list-view>\r\n          </ng-template>\r\n\r\n          \x3c!-- <ng-template listNavFooter>\r\n                底部部分\r\n            </ng-template> --\x3e\r\n\r\n        </farris-list-nav>\r\n      </div>\r\n      <div class="example-content" >\r\n        <ng-container #girdView *ngFor="let item of tableData;let i = index">\r\n          <div style="height:100%" [hidden]="! (currentLink && item.code == ((currentLink[\'data\'] || [])[0] || {})[\'code\'])" >\r\n            <farris-datagrid \r\n              [autoFitColumns]="true" \r\n              [columns]="item.columns" \r\n              [data]="item.data" \r\n              [fitColumns]="true"\r\n              [fit]="true" \r\n              [showBorder]="true" \r\n              [(selectValue)]="item.selectedValue"\r\n              [keepSelect]="false"\r\n              [pagination]="false"\r\n              (selectChanged)="selectRowChange($event, item.code)"\r\n              (unSelect)="unSelect(null, item.code)">\r\n            </farris-datagrid>\r\n          </div>\r\n        </ng-container>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</farris-dialog>\r\n\r\n<ng-template #defaultButtonRef>\r\n  <button #okbtn type="button" [disabled]="ensureFlag" (click)="confirm(\'ensure\')"  class="btn btn-primary btn-lg">\r\n    {{ \'lookup.okText\' | locale: \'确定\' }}\r\n  </button>\r\n  <button type="button" class="btn btn-secondary btn-lg" (click)="confirm(\'cancel\')" [disabled]="false">\r\n    {{ \'lookup.cancelText\' | locale: \'取消\' }}\r\n  </button>\r\n</ng-template>',providers:[O,{provide:p.NG_VALUE_ACCESSOR,useExisting:s.forwardRef(function(){return V}),multi:!0}],styles:[".listnav-example-wrapper{background-color:#e7ebef;display:flex;height:100%}.listnav-example-wrapper .example-side-nav{flex:0 0 auto}.listnav-example-wrapper .example-content{flex:1 1 0;width:726px;overflow-y:auto;padding:10px 10px 10px 4px}.listnav-example-wrapper .example-content .listnav-content{height:100%;width:100%;background-color:#fff}.listnav-example-wrapper .example-content.example-content-right{padding:10px 4px 10px 10px}"]}]}],V.ctorParameters=function(){return[{type:r.ViewModel,decorators:[{type:s.Optional}]},{type:s.ElementRef},{type:O},{type:r.VariableParseService},{type:s.ComponentFactoryResolver},{type:s.Injector}]},V.propDecorators={width:[{type:s.Input}],height:[{type:s.Input}],serviceCode:[{type:s.Input,args:["serviceCode"]}],externalParams:[{type:s.Input,args:["externalParams"]}],mappingType:[{type:s.Input,args:["mappingType"]}],myField:[{type:s.Input,args:["mapFields"]}],fieldText:[{type:s.Input}],extTableSchemas:[{type:s.Input,args:["extTableSchemas"]}],placeholder:[{type:s.Input}],readonly:[{type:s.Input}],beforeSapSrvc:[{type:s.Input}],customData:[{type:s.Input}],selectSapData:[{type:s.Output}],afterOnblur:[{type:s.Output}],dialog:[{type:s.ViewChild,args:["dialog"]}],input:[{type:s.ViewChild,args:["input"]}],girdView:[{type:s.ViewChild,args:["girdView",{read:s.ViewContainerRef}]}],farrisListView:[{type:s.ViewChild,args:["farrisListView"]}]};var F=V;function V(t,e,r,i,a,n){var o=this;this.vm=t,this.el=e,this.extIntgrtnSrvc=r,this.variableParseService=i,this.resolver=a,this.inj=n,this.width=960,this.height=577,this.fieldText="",this.placeholder="请选择",this.readonly=!1,this.containerMargin={top:0,bottom:5,left:10,right:10},this.selectSapData=new s.EventEmitter,this.afterOnblur=new s.EventEmitter,this.tableData=[],this.currentLink={},this.ensureFlag=!0,this.containerStyle={marginLeft:this.containerMargin.left+"px",marginRight:this.containerMargin.right+"px",marginTop:this.containerMargin.top+"px",marginBottom:this.containerMargin.bottom+"px"},this.beforeClose=function(){return o.tableData=[],o.ensureFlag=!0,o.sendSapData(),l.of(!0)}}P.prototype.ngOnInit=function(){var e=this;this.extIntegrationComponent.selectSapData.subscribe(function(t){e.mappingData(t,e.myField)})},P.prototype.mappingData=function(i,a){var n=this;Object.keys(a).forEach(function(t){var e,r=n.getBindingPathArray();i&&(e=i[t]),n.vm.bindingData.setValue(r.concat(a[t]),e,!0,!0)})},P.prototype.getBindingPathArray=function(){var t=this.vm.bindingPath;return t?t.split("/").filter(function(t){return""!==t}):[]},P.decorators=[{type:s.Directive,args:[{selector:"[extIntegration-dataMapping]"}]}],P.ctorParameters=function(){return[{type:r.ViewModel,decorators:[{type:s.Optional}]},{type:F}]},P.propDecorators={myField:[{type:s.Input,args:["mapFields"]}],showModal:[{type:s.Output}]};var q=P;function P(t,e){this.vm=t,this.extIntegrationComponent=e,this.showModal=new s.EventEmitter}R.decorators=[{type:s.NgModule,args:[{declarations:[q,F,e],imports:[i.CommonModule,p.ReactiveFormsModule,L.ListViewModule,j.RouterModule,S.ListNavModule,D.InputGroupModule,m.TextModule,o.HttpClientModule,w.FormMessageModule,c.PerfectScrollbarModule,d.TreeModule,f.FarrisTabsModule,h.FarrisFormsModule,p.FormsModule,g.FarrisCommonModule.forRoot(),a.FarrisDialogModule.forRoot(),y.MessagerModule.forRoot(),v.NotifyModule.forRoot(),b.LayoutModule,u.LocaleModule.forRoot(),n.ModalModule.forRoot(),x.DatagridModule],providers:[n.BsModalService,a.DialogService],entryComponents:[e,x.DatagridComponent],exports:[q,F,e]}]}];i=R;function R(){}t.DatagridExtIntgrtnComponent=e,t.ExtIntgrtnDataGridEditorProvider=N,t.ExternalIntegrationModule=i,t.ExtIntegrationDataMappingDirective=q,t.ExternalIntegrationService=O,t.ExternalIntegrationComponent=F,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=farris-external-integration.umd.min.js.map