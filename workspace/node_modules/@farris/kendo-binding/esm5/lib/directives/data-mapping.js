import * as tslib_1 from "tslib";
import { isNumber } from 'lodash-es';
/**
 * 帮助映射基类
 */
var DataMapping = /** @class */ (function () {
    function DataMapping() {
        /**
         * 多选帮助默认分隔符
         */
        this.defaultSpliter = ',';
    }
    /**
     * 映射数据
     * @param helpData 清空时，值为null
     * @param mapFields 格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"}
     * @param asClear 类似清空
     * @param [spliter=','] 多选分隔符
     */
    DataMapping.prototype.mappingData = function (helpData, mapFields, asClear, spliter) {
        if (asClear === void 0) { asClear = false; }
        if (spliter === void 0) { spliter = ','; }
        if (!mapFields) {
            return;
        }
        // 关闭变更检测
        var appContext = this.vm.frameContext.appContext;
        appContext.changeDetectionController.detach();
        var helpFields = Object.keys(mapFields);
        var basePaths = this.getBindingPathArray();
        var primaryInfo = this.getMapFieldsPrimaryKey(mapFields, basePaths);
        // 映射到目标主键的源字段数组
        var primaryKeys = primaryInfo && primaryInfo.map(function (item) { return item.primaryKey; }) || [];
        // 目标主键字段数组
        var primaryFields = primaryInfo && primaryInfo.map(function (item) { return item.primaryField; }) || [];
        // 对映射中的key进行排序，使映射到目标主键的key排到前面
        helpFields = this.sortMapFieldKeys(helpFields, primaryKeys);
        if (!helpData || asClear) {
            helpFields.reverse();
        }
        this.mapping(helpFields, mapFields, helpData, primaryFields, basePaths, asClear, spliter);
        // 重新打开变更检测
        appContext.changeDetectionController.reattach();
    };
    DataMapping.prototype.mapping = function (sortedKeyFields, mapFields, helpData, targetPrimaryFields, basePaths, asClear, spliter) {
        var _this = this;
        if (asClear === void 0) { asClear = false; }
        if (spliter === void 0) { spliter = ','; }
        sortedKeyFields.forEach(function (field) {
            var val = _this.getHelpValue(field, helpData, spliter);
            var mappings = mapFields[field].split(',');
            var headMappings = mappings.filter(function (p) { return targetPrimaryFields.includes(p); });
            var leftMappings = mappings.filter(function (p) { return !targetPrimaryFields.includes(p); });
            if (!helpData || asClear) {
                mappings = [].concat(leftMappings).concat(headMappings);
            }
            else {
                mappings = [].concat(headMappings).concat(leftMappings);
            }
            _this.updateTarget(mappings, basePaths, helpData, val);
        });
    };
    DataMapping.prototype.updateTarget = function (mappings, basePaths, helpData, value) {
        var _this = this;
        mappings.forEach(function (targetFieldPath) {
            _this.updateTargetValue(basePaths, targetFieldPath, value, helpData);
        });
    };
    DataMapping.prototype.updateTargetValue = function (basePaths, targetFieldPath, value, helpData) {
        if (this.target) {
            var paths = targetFieldPath.split('.');
            this.setValue(this.target, paths, value);
        }
        else {
            var paths = basePaths.concat(targetFieldPath.split('.'));
            if (!helpData) {
                this.vm.bindingData.clearValue(paths, true, true, { frameContext: this.vm.frameContext });
            }
            else {
                this.vm.bindingData.setValue(paths, value, true, true, null, { frameContext: this.vm.frameContext });
            }
        }
    };
    /**
     * 获取帮助字段对应的值
     * @param field 帮助字段
     * @param helpData 帮助数据
     * @param [spliter=','] 多选帮助分隔符
     * @returns
     */
    DataMapping.prototype.getHelpValue = function (field, helpData, spliter) {
        var _this = this;
        if (spliter === void 0) { spliter = ','; }
        var value = '';
        if (helpData) {
            if (helpData instanceof Array) {
                value = helpData.map(function (item) {
                    return _this.getValue(field, item);
                }).join(spliter);
            }
            else {
                value = this.getValue(field, helpData);
            }
        }
        return value;
    };
    DataMapping.prototype.getValue = function (f, data) {
        var val = '';
        if (f.indexOf('.') === -1) {
            val = data[f];
        }
        else {
            val = f.split('.').reduce(function (a, b) {
                return a[b];
            }, data);
        }
        return val;
    };
    DataMapping.prototype.setValue = function (target, paths, value) {
        if (target) {
            if (paths.length <= 1) {
                target[paths[0]] = value;
            }
            else {
                paths.slice(0, -1).reduce(function (prev, path) {
                    if (!(prev.hasOwnProperty(path) || prev['__proto__'].hasOwnProperty(path))) {
                        prev[path] = {};
                    }
                    return prev[path];
                }, target)[paths[paths.length - 1]] = value;
            }
        }
    };
    DataMapping.prototype.getBindingPathArray = function () {
        var path = this.vm.bindingPath;
        if (path) {
            return path.split('/').filter(function (n) { return n !== ''; });
        }
        return [];
    };
    DataMapping.prototype.isNumberValue = function (field, data) {
        var currentVal = this.getValue(field, data);
        return isNumber(currentVal);
    };
    /**
     *
     * @param mapFields  格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"} 或者 {id:'vid',code:'code',name:'name'}
     */
    DataMapping.prototype.getMapFieldsPrimaryKey = function (mapFields, bindingPaths) {
        if (!mapFields || Object.keys(mapFields).length < 1) {
            return null;
        }
        var results = [];
        // let primaryField = null;
        try {
            var entityTypeInfo_1 = this.vm.frameContext.repository.entityTypeInfo;
            Object.keys(mapFields).forEach(function (key) {
                var mapField = mapFields[key];
                if (mapField && typeof mapField === 'string') {
                    var mappings = mapField.split(',').filter(function (p) { return p; });
                    mappings.forEach(function (item) {
                        var paths = item.split('.');
                        if (bindingPaths && bindingPaths.length > 0) {
                            paths = bindingPaths.concat(paths);
                        }
                        var propInfo = entityTypeInfo_1.getPropInfoByPath(paths);
                        if (propInfo && propInfo.metadataInfo && propInfo.metadataInfo.primary === true) {
                            results.push({
                                primaryKey: key,
                                primaryField: item
                            });
                        }
                    });
                }
            });
        }
        catch (e) {
            console.error(e);
        }
        return results;
    };
    DataMapping.prototype.sortMapFieldKeys = function (keys, primaryKeys) {
        if (!primaryKeys || primaryKeys.length < 1 || !keys || keys.length < 1) {
            return keys;
        }
        primaryKeys = tslib_1.__spread(new Set(primaryKeys));
        // 过滤出非主键映射字段
        keys = keys.filter(function (p) { return !primaryKeys.includes(p); });
        return [].concat(primaryKeys).concat(keys);
    };
    return DataMapping;
}());
export { DataMapping };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1tYXBwaW5nLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9rZW5kby1iaW5kaW5nLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZXMvZGF0YS1tYXBwaW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3JDOztHQUVHO0FBQ0g7SUFBQTtRQUdFOztXQUVHO1FBQ2dCLG1CQUFjLEdBQUcsR0FBRyxDQUFDO0lBc0sxQyxDQUFDO0lBcktDOzs7Ozs7T0FNRztJQUNILGlDQUFXLEdBQVgsVUFBWSxRQUFhLEVBQUUsU0FBYyxFQUFFLE9BQXdCLEVBQUUsT0FBcUI7UUFBL0Msd0JBQUEsRUFBQSxlQUF3QjtRQUFFLHdCQUFBLEVBQUEsYUFBcUI7UUFDeEYsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLE9BQU87U0FDUjtRQUNELFNBQVM7UUFDVCxJQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUM7UUFDbkQsVUFBVSxDQUFDLHlCQUF5QixDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQzlDLElBQUksVUFBVSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDeEMsSUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDN0MsSUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUN0RSxnQkFBZ0I7UUFDaEIsSUFBTSxXQUFXLEdBQWEsV0FBVyxJQUFJLFdBQVcsQ0FBQyxHQUFHLENBQUMsVUFBQyxJQUFJLElBQUssT0FBQSxJQUFJLENBQUMsVUFBVSxFQUFmLENBQWUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUM5RixXQUFXO1FBQ1gsSUFBTSxhQUFhLEdBQWEsV0FBVyxJQUFJLFdBQVcsQ0FBQyxHQUFHLENBQUMsVUFB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Q0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUNILGtCQUFDO0FBQUQsQ0FBQyxBQTVLRCxJQTRLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJpbmRpbmdPYmplY3QsIERhdGFQcm9wSW5mbywgRGF0YVR5cGVJbmZvLCBWaWV3TW9kZWwgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IGlzTnVtYmVyIH0gZnJvbSAnbG9kYXNoLWVzJztcclxuLyoqXHJcbiAqIOW4ruWKqeaYoOWwhOWfuuexu1xyXG4gKi9cclxuZXhwb3J0IGNsYXNzIERhdGFNYXBwaW5nIHtcclxuICBwdWJsaWMgdm06IFZpZXdNb2RlbDtcclxuICBwdWJsaWMgdGFyZ2V0OiBCaW5kaW5nT2JqZWN0O1xyXG4gIC8qKlxyXG4gICAqIOWkmumAieW4ruWKqem7mOiupOWIhumalOesplxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCByZWFkb25seSBkZWZhdWx0U3BsaXRlciA9ICcsJztcclxuICAvKipcclxuICAgKiDmmKDlsITmlbDmja5cclxuICAgKiBAcGFyYW0gaGVscERhdGEg5riF56m65pe277yM5YC85Li6bnVsbFxyXG4gICAqIEBwYXJhbSBtYXBGaWVsZHMg5qC85byP5b2i5aaC77yae2lkOiBcImFzc29GaWVsZC5hc3NvRmllbGRcIiwgY29kZTogXCJhc3NvRmllbGQuYXNzb0ZpZWxkX0NvZGVcIiwgbmFtZTogXCJhc3NvRmllbGQuYXNzb0ZpZWxkX05hbWVcIn1cclxuICAgKiBAcGFyYW0gYXNDbGVhciDnsbvkvLzmuIXnqbpcclxuICAgKiBAcGFyYW0gW3NwbGl0ZXI9JywnXSDlpJrpgInliIbpmpTnrKZcclxuICAgKi9cclxuICBtYXBwaW5nRGF0YShoZWxwRGF0YTogYW55LCBtYXBGaWVsZHM6IGFueSwgYXNDbGVhcjogYm9vbGVhbiA9IGZhbHNlLCBzcGxpdGVyOiBzdHJpbmcgPSAnLCcpIHtcclxuICAgIGlmICghbWFwRmllbGRzKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIOWFs+mXreWPmOabtOajgOa1i1xyXG4gICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMudm0uZnJhbWVDb250ZXh0LmFwcENvbnRleHQ7XHJcbiAgICBhcHBDb250ZXh0LmNoYW5nZURldGVjdGlvbkNvbnRyb2xsZXIuZGV0YWNoKCk7XHJcbiAgICBsZXQgaGVscEZpZWxkcyA9IE9iamVjdC5rZXlzKG1hcEZpZWxkcyk7XHJcbiAgICBjb25zdCBiYXNlUGF0aHMgPSB0aGlzLmdldEJpbmRpbmdQYXRoQXJyYXkoKTtcclxuICAgIGNvbnN0IHByaW1hcnlJbmZvID0gdGhpcy5nZXRNYXBGaWVsZHNQcmltYXJ5S2V5KG1hcEZpZWxkcywgYmFzZVBhdGhzKTtcclxuICAgIC8vIOaYoOWwhOWIsOebruagh+S4u+mUrueahOa6kOWtl+auteaVsOe7hFxyXG4gICAgY29uc3QgcHJpbWFyeUtleXM6IHN0cmluZ1tdID0gcHJpbWFyeUluZm8gJiYgcHJpbWFyeUluZm8ubWFwKChpdGVtKSA9PiBpdGVtLnByaW1hcnlLZXkpIHx8IFtdO1xyXG4gICAgLy8g55uu5qCH5Li76ZSu5a2X5q615pWw57uEXHJcbiAgICBjb25zdCBwcmltYXJ5RmllbGRzOiBzdHJpbmdbXSA9IHByaW1hcnlJbmZvICYmIHByaW1hcnlJbmZvLm1hcCgoaXRlbSkgPT4gaXRlbS5wcmltYXJ5RmllbGQpIHx8IFtdO1xyXG4gICAgLy8g5a+55pig5bCE5Lit55qEa2V56L+b6KGM5o6S5bqP77yM5L2/5pig5bCE5Yiw55uu5qCH5Li76ZSu55qEa2V55o6S5Yiw5YmN6Z2iXHJcbiAgICBoZWxwRmllbGRzID0gdGhpcy5zb3J0TWFwRmllbGRLZXlzKGhlbHBGaWVsZHMsIHByaW1hcnlLZXlzKTtcclxuICAgIGlmICghaGVscERhdGEgfHwgYXNDbGVhcikge1xyXG4gICAgICBoZWxwRmllbGRzLnJldmVyc2UoKTtcclxuICAgIH1cclxuICAgIHRoaXMubWFwcGluZyhoZWxwRmllbGRzLCBtYXBGaWVsZHMsIGhlbHBEYXRhLCBwcmltYXJ5RmllbGRzLCBiYXNlUGF0aHMsIGFzQ2xlYXIsIHNwbGl0ZXIpO1xyXG4gICAgLy8g6YeN5paw5omT5byA5Y+Y5pu05qOA5rWLXHJcbiAgICBhcHBDb250ZXh0LmNoYW5nZURldGVjdGlvbkNvbnRyb2xsZXIucmVhdHRhY2goKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBtYXBwaW5nKHNvcnRlZEtleUZpZWxkczogc3RyaW5nW10sIG1hcEZpZWxkczogYW55LCBoZWxwRGF0YTogYW55LCB0YXJnZXRQcmltYXJ5RmllbGRzOiBzdHJpbmdbXSwgYmFzZVBhdGhzOiBzdHJpbmdbXSwgYXNDbGVhcjogYm9vbGVhbiA9IGZhbHNlLCBzcGxpdGVyID0gJywnKSB7XHJcbiAgICBzb3J0ZWRLZXlGaWVsZHMuZm9yRWFjaCgoZmllbGQ6IGFueSkgPT4ge1xyXG4gICAgICBjb25zdCB2YWwgPSB0aGlzLmdldEhlbHBWYWx1ZShmaWVsZCwgaGVscERhdGEsIHNwbGl0ZXIpO1xyXG4gICAgICBsZXQgbWFwcGluZ3M6IGFueVtdID0gbWFwRmllbGRzW2ZpZWxkXS5zcGxpdCgnLCcpO1xyXG4gICAgICBjb25zdCBoZWFkTWFwcGluZ3MgPSBtYXBwaW5ncy5maWx0ZXIoKHApID0+IHRhcmdldFByaW1hcnlGaWVsZHMuaW5jbHVkZXMocCkpO1xyXG4gICAgICBjb25zdCBsZWZ0TWFwcGluZ3MgPSBtYXBwaW5ncy5maWx0ZXIoKHApID0+ICF0YXJnZXRQcmltYXJ5RmllbGRzLmluY2x1ZGVzKHApKTtcclxuICAgICAgaWYgKCFoZWxwRGF0YSB8fCBhc0NsZWFyKSB7XHJcbiAgICAgICAgbWFwcGluZ3MgPSBbXS5jb25jYXQobGVmdE1hcHBpbmdzKS5jb25jYXQoaGVhZE1hcHBpbmdzKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBtYXBwaW5ncyA9IFtdLmNvbmNhdChoZWFkTWFwcGluZ3MpLmNvbmNhdChsZWZ0TWFwcGluZ3MpO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMudXBkYXRlVGFyZ2V0KG1hcHBpbmdzLCBiYXNlUGF0aHMsIGhlbHBEYXRhLCB2YWwpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgdXBkYXRlVGFyZ2V0KG1hcHBpbmdzOiBzdHJpbmdbXSwgYmFzZVBhdGhzOiBzdHJpbmdbXSwgaGVscERhdGE6IGFueSwgdmFsdWU6IGFueSkge1xyXG4gICAgbWFwcGluZ3MuZm9yRWFjaCgodGFyZ2V0RmllbGRQYXRoOiBhbnkpID0+IHtcclxuICAgICAgdGhpcy51cGRhdGVUYXJnZXRWYWx1ZShiYXNlUGF0aHMsIHRhcmdldEZpZWxkUGF0aCwgdmFsdWUsIGhlbHBEYXRhKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIHVwZGF0ZVRhcmdldFZhbHVlKGJhc2VQYXRoczogc3RyaW5nW10sIHRhcmdldEZpZWxkUGF0aCwgdmFsdWU6IGFueSwgaGVscERhdGE6IGFueSkge1xyXG4gICAgaWYgKHRoaXMudGFyZ2V0KSB7XHJcbiAgICAgIGNvbnN0IHBhdGhzID0gdGFyZ2V0RmllbGRQYXRoLnNwbGl0KCcuJyk7XHJcbiAgICAgIHRoaXMuc2V0VmFsdWUodGhpcy50YXJnZXQsIHBhdGhzLCB2YWx1ZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCBwYXRocyA9IGJhc2VQYXRocy5jb25jYXQodGFyZ2V0RmllbGRQYXRoLnNwbGl0KCcuJykpO1xyXG4gICAgICBpZiAoIWhlbHBEYXRhKSB7XHJcbiAgICAgICAgdGhpcy52bS5iaW5kaW5nRGF0YS5jbGVhclZhbHVlKHBhdGhzLCB0cnVlLCB0cnVlLCB7IGZyYW1lQ29udGV4dDogdGhpcy52bS5mcmFtZUNvbnRleHQgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy52bS5iaW5kaW5nRGF0YS5zZXRWYWx1ZShwYXRocywgdmFsdWUsIHRydWUsIHRydWUsIG51bGwsIHsgZnJhbWVDb250ZXh0OiB0aGlzLnZtLmZyYW1lQ29udGV4dCB9KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bluK7liqnlrZfmrrXlr7nlupTnmoTlgLxcclxuICAgKiBAcGFyYW0gZmllbGQg5biu5Yqp5a2X5q61XHJcbiAgICogQHBhcmFtIGhlbHBEYXRhIOW4ruWKqeaVsOaNrlxyXG4gICAqIEBwYXJhbSBbc3BsaXRlcj0nLCddIOWkmumAieW4ruWKqeWIhumalOesplxyXG4gICAqIEByZXR1cm5zXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRIZWxwVmFsdWUoZmllbGQ6IHN0cmluZywgaGVscERhdGE6IGFueSwgc3BsaXRlciA9ICcsJykge1xyXG4gICAgbGV0IHZhbHVlOiBhbnkgPSAnJztcclxuICAgIGlmIChoZWxwRGF0YSkge1xyXG4gICAgICBpZiAoaGVscERhdGEgaW5zdGFuY2VvZiBBcnJheSkge1xyXG4gICAgICAgIHZhbHVlID0gaGVscERhdGEubWFwKChpdGVtOiBhbnkpID0+IHtcclxuICAgICAgICAgIHJldHVybiB0aGlzLmdldFZhbHVlKGZpZWxkLCBpdGVtKTtcclxuICAgICAgICB9KS5qb2luKHNwbGl0ZXIpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHZhbHVlID0gdGhpcy5nZXRWYWx1ZShmaWVsZCwgaGVscERhdGEpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdmFsdWU7XHJcbiAgfVxyXG4gIHByb3RlY3RlZCBnZXRWYWx1ZShmOiBzdHJpbmcsIGRhdGE6IGFueSkge1xyXG4gICAgbGV0IHZhbCA9ICcnO1xyXG4gICAgaWYgKGYuaW5kZXhPZignLicpID09PSAtMSkge1xyXG4gICAgICB2YWwgPSBkYXRhW2ZdO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdmFsID0gZi5zcGxpdCgnLicpLnJlZHVjZSgoYSwgYikgPT4ge1xyXG4gICAgICAgIHJldHVybiBhW2JdO1xyXG4gICAgICB9LCBkYXRhKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdmFsO1xyXG4gIH1cclxuICBwcm90ZWN0ZWQgc2V0VmFsdWUodGFyZ2V0OiBvYmplY3QsIHBhdGhzOiBzdHJpbmdbXSwgdmFsdWU6IGFueSkge1xyXG4gICAgaWYgKHRhcmdldCkge1xyXG4gICAgICBpZiAocGF0aHMubGVuZ3RoIDw9IDEpIHtcclxuICAgICAgICB0YXJnZXRbcGF0aHNbMF1dID0gdmFsdWU7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcGF0aHMuc2xpY2UoMCwgLTEpLnJlZHVjZSgocHJldiwgcGF0aCkgPT4ge1xyXG4gICAgICAgICAgaWYgKCEocHJldi5oYXNPd25Qcm9wZXJ0eShwYXRoKSB8fCBwcmV2WydfX3Byb3RvX18nXS5oYXNPd25Qcm9wZXJ0eShwYXRoKSkpIHtcclxuICAgICAgICAgICAgcHJldltwYXRoXSA9IHt9O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIHByZXZbcGF0aF07XHJcbiAgICAgICAgfSwgdGFyZ2V0KVtwYXRoc1twYXRocy5sZW5ndGggLSAxXV0gPSB2YWx1ZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIGdldEJpbmRpbmdQYXRoQXJyYXkoKTogYW55W10ge1xyXG4gICAgY29uc3QgcGF0aCA9IHRoaXMudm0uYmluZGluZ1BhdGg7XHJcbiAgICBpZiAocGF0aCkge1xyXG4gICAgICByZXR1cm4gcGF0aC5zcGxpdCgnLycpLmZpbHRlcigobikgPT4gbiAhPT0gJycpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIFtdO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpc051bWJlclZhbHVlKGZpZWxkLCBkYXRhKSB7XHJcbiAgICBjb25zdCBjdXJyZW50VmFsID0gdGhpcy5nZXRWYWx1ZShmaWVsZCwgZGF0YSk7XHJcbiAgICByZXR1cm4gaXNOdW1iZXIoY3VycmVudFZhbCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqXHJcbiAgICogQHBhcmFtIG1hcEZpZWxkcyAg5qC85byP5b2i5aaC77yae2lkOiBcImFzc29GaWVsZC5hc3NvRmllbGRcIiwgY29kZTogXCJhc3NvRmllbGQuYXNzb0ZpZWxkX0NvZGVcIiwgbmFtZTogXCJhc3NvRmllbGQuYXNzb0ZpZWxkX05hbWVcIn0g5oiW6ICFIHtpZDondmlkJyxjb2RlOidjb2RlJyxuYW1lOiduYW1lJ31cclxuICAgKi9cclxuICBwcml2YXRlIGdldE1hcEZpZWxkc1ByaW1hcnlLZXkobWFwRmllbGRzOiBhbnksIGJpbmRpbmdQYXRoczogc3RyaW5nW10pOiBBcnJheTx7IHByaW1hcnlLZXk6IHN0cmluZywgcHJpbWFyeUZpZWxkOiBzdHJpbmcgfT4ge1xyXG4gICAgaWYgKCFtYXBGaWVsZHMgfHwgT2JqZWN0LmtleXMobWFwRmllbGRzKS5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcmVzdWx0cyA9IFtdO1xyXG4gICAgLy8gbGV0IHByaW1hcnlGaWVsZCA9IG51bGw7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBlbnRpdHlUeXBlSW5mbzogRGF0YVR5cGVJbmZvID0gdGhpcy52bS5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbztcclxuICAgICAgT2JqZWN0LmtleXMobWFwRmllbGRzKS5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGNvbnN0IG1hcEZpZWxkID0gbWFwRmllbGRzW2tleV07XHJcbiAgICAgICAgaWYgKG1hcEZpZWxkICYmIHR5cGVvZiBtYXBGaWVsZCA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgIGNvbnN0IG1hcHBpbmdzID0gbWFwRmllbGQuc3BsaXQoJywnKS5maWx0ZXIoKHApID0+IHApO1xyXG4gICAgICAgICAgbWFwcGluZ3MuZm9yRWFjaCgoaXRlbTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBwYXRocyA9IGl0ZW0uc3BsaXQoJy4nKTtcclxuICAgICAgICAgICAgaWYgKGJpbmRpbmdQYXRocyAmJiBiaW5kaW5nUGF0aHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgIHBhdGhzID0gYmluZGluZ1BhdGhzLmNvbmNhdChwYXRocyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgcHJvcEluZm86IERhdGFQcm9wSW5mbyA9IGVudGl0eVR5cGVJbmZvLmdldFByb3BJbmZvQnlQYXRoKHBhdGhzKTtcclxuICAgICAgICAgICAgaWYgKHByb3BJbmZvICYmIHByb3BJbmZvLm1ldGFkYXRhSW5mbyAmJiBwcm9wSW5mby5tZXRhZGF0YUluZm8ucHJpbWFyeSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgIHJlc3VsdHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICBwcmltYXJ5S2V5OiBrZXksXHJcbiAgICAgICAgICAgICAgICBwcmltYXJ5RmllbGQ6IGl0ZW1cclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgY29uc29sZS5lcnJvcihlKTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHRzO1xyXG4gIH1cclxuICBwcml2YXRlIHNvcnRNYXBGaWVsZEtleXMoa2V5czogc3RyaW5nW10sIHByaW1hcnlLZXlzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcclxuICAgIGlmICghcHJpbWFyeUtleXMgfHwgcHJpbWFyeUtleXMubGVuZ3RoIDwgMSB8fCAha2V5cyB8fCBrZXlzLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIGtleXM7XHJcbiAgICB9XHJcbiAgICBwcmltYXJ5S2V5cyA9IFsuLi5uZXcgU2V0KHByaW1hcnlLZXlzKV07XHJcbiAgICAvLyDov4fmu6Tlh7rpnZ7kuLvplK7mmKDlsITlrZfmrrVcclxuICAgIGtleXMgPSBrZXlzLmZpbHRlcigocCkgPT4gIXByaW1hcnlLZXlzLmluY2x1ZGVzKHApKTtcclxuICAgIHJldHVybiBbXS5jb25jYXQocHJpbWFyeUtleXMpLmNvbmNhdChrZXlzKTtcclxuICB9XHJcbn1cclxuIl19