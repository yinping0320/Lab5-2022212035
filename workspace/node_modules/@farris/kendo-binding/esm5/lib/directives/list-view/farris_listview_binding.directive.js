import * as tslib_1 from "tslib";
import { Directive, HostListener, Output, EventEmitter, Input } from '@angular/core';
import { BindingData, ViewModel } from '@farris/devkit';
import { ListViewComponent } from '@farris/ui-list-view';
var FarrisListViewBindingDirective = /** @class */ (function () {
    function FarrisListViewBindingDirective(bindingData, viewModel, listview) {
        this.bindingData = bindingData;
        this.viewModel = viewModel;
        this.listview = listview;
        this.supportPaged = true;
        /**
         * 选中行切换事件
         */
        this.selectedRowChange = new EventEmitter();
    }
    Object.defineProperty(FarrisListViewBindingDirective.prototype, "primaryKey", {
        /**
         * 主键
         */
        get: function () {
            return this.bindingList.primaryKey;
        },
        enumerable: true,
        configurable: true
    });
    FarrisListViewBindingDirective.prototype.ngOnInit = function () {
        // 绑定数据
        this.bindData();
        this.registerBindingDataChangeEvent();
    };
    FarrisListViewBindingDirective.prototype.ngOnChanges = function () {
        this.bindData();
    };
    FarrisListViewBindingDirective.prototype.ngOnDestroy = function () {
        this.unRegisterBindingDataChangeEvent();
    };
    /**
     * 获取分页信息
     */
    FarrisListViewBindingDirective.prototype.getPagingInfo = function () {
        var bindingPath = this.viewModel.bindingPath;
        var bindingData = this.viewModel.bindingData;
        var pagingInfo = bindingData.pagingInfo;
        if (bindingPath === '/') {
            return pagingInfo;
        }
        else {
            var bindingPaths = bindingPath.substr(1).split('/').filter(function (item) { return !!item && item.length > 0; }).map(function (item) {
                return item.substring(0, item.length - 1);
            });
            bindingPaths.forEach(function (path) {
                pagingInfo = pagingInfo && pagingInfo[path];
            });
            return pagingInfo;
        }
    };
    /**
     * 设置listview属性
     */
    FarrisListViewBindingDirective.prototype.setListViewPageProps = function () {
        var data = this.bindingList.toJSON();
        var skip = 0;
        var _a = this.getPagingInfo() || {}, _b = _a.pageIndex, pageIndex = _b === void 0 ? 1 : _b, _c = _a.pageSize, pageSize = _c === void 0 ? 0 : _c;
        var _d = (this.getPagingInfo() || {}).total, total = _d === void 0 ? 0 : _d;
        if (pageIndex > 0) {
            skip = (pageIndex - 1) * pageSize;
        }
        if (pageSize === 0 && total === 0) {
            total = data.length;
        }
        this.listview.supportPaging = this.supportPaged;
        this.listview.pageIndex = pageIndex;
        this.listview.pageSize = pageSize;
        this.listview.total = total;
        var currentPage = pageIndex;
        var itemsPerPage = pageSize;
        var totalItems = total;
        if (pageSize === 0) {
            // this.listview.supportPaging = false;
            this.listview.pageIndex = pageIndex;
            this.listview.total = total;
            currentPage = 1;
            totalItems = total;
        }
        if (this.listview.paginationOptions) {
            this.listview.paginationOptions.itemsPerPage = itemsPerPage;
            this.listview.paginationOptions.currentPage = currentPage;
            this.listview.paginationOptions.pageList = this.listview.pageList;
            this.listview.paginationOptions.totalItems = totalItems;
        }
        var listViewChangeDetectRef = this.listview['cdr'];
        if (listViewChangeDetectRef) {
            listViewChangeDetectRef.detectChanges();
        }
        var paginationDirective = this.listview.pager && this.listview.pager['paginationDirective'];
        if (paginationDirective && paginationDirective['service']) {
            try {
                paginationDirective['service'].instances[this.listview.pager.id] = tslib_1.__assign({}, this.listview.paginationOptions);
                paginationDirective['service'].setTotalItems(this.listview.pager.id, totalItems);
                paginationDirective.changeDetectorRef.detectChanges();
            }
            catch (_e) { }
        }
    };
    Object.defineProperty(FarrisListViewBindingDirective.prototype, "bindingList", {
        /*
         * 获取绑定数据
         */
        get: function () {
            // 根实体
            if (this.viewModel.bindingPath === '/' || !this.viewModel.bindingPath) {
                return this.bindingData.list;
            }
            // 子实体
            var bindingPath = this.viewModel.bindingPath.substr(1);
            bindingPath = bindingPath[0].toLowerCase() + bindingPath.substring(1, bindingPath.length);
            var paths = bindingPath.split('/');
            var filteredPaths = paths.filter(function (part) {
                return part !== '';
            });
            return this.bindingData.getValue(filteredPaths);
        },
        enumerable: true,
        configurable: true
    });
    /* 绑定数据 */
    FarrisListViewBindingDirective.prototype.bindData = function () {
        this.setListViewPageProps();
        var data = this.bindingList.toArray();
        this.listview.setData(data);
    };
    /*
         * 发射选中行切换事件
         * @description 统一单选模式和多选模式下的行切换事件
         */
    FarrisListViewBindingDirective.prototype.fireSelectedRowChange = function (selectedRowContext) {
        this.selectedRowChange.emit(selectedRowContext);
    };
    /**
     * 设置BindingList的当前行
     * @param id 当前行内码
     */
    FarrisListViewBindingDirective.prototype.setSelectionIdToBindingData = function (id) {
        this.bindingList.setCurrentId(id, true);
    };
    /**
     * 数据源发生变更
     * @param change 变更
     */
    FarrisListViewBindingDirective.prototype.onBindingDataChange = function (change) {
        this.bindData();
        this.updateSelectedRow(change);
    };
    /**
     * 设置当前行
     * @param change 变更
     */
    FarrisListViewBindingDirective.prototype.updateSelectedRow = function (change) {
        if (!this.bindingList || !this.bindingList.currentId) {
            return;
        }
        if (this.viewModel && this.viewModel.frameContext.bindingData.rowSelectedEventSuspend === true) {
            return;
        }
        var _a = (this.listview.clickItem || {}).id, id = _a === void 0 ? null : _a;
        var currentId = this.bindingList.currentId;
        // grid当前行与bingingList当前行一致，无须切换
        if (id === currentId) {
            return;
        }
        this.selectRow(this.bindingList.currentId);
    };
    FarrisListViewBindingDirective.prototype.selectRow = function (id) {
        if (this.listview && typeof this.listview.selectRow === 'function') {
            this.listview.selectRow(id);
        }
    };
    /**
     * 注册bindingdata变化事件
     */
    FarrisListViewBindingDirective.prototype.registerBindingDataChangeEvent = function () {
        var _this = this;
        this.bindingDataChangeEvent = this.bindingData.changes.subscribe(function (change) {
            _this.onBindingDataChange(change);
        });
    };
    /**
     * 取消bindingdata变化订阅
     */
    FarrisListViewBindingDirective.prototype.unRegisterBindingDataChangeEvent = function () {
        this.bindingDataChangeEvent.unsubscribe();
    };
    FarrisListViewBindingDirective.prototype.setChecks = function (ids) {
        this.viewModel.uiState.setPropertyValue('ids', ids);
    };
    /* 切换行事件 */
    FarrisListViewBindingDirective.prototype.changeRow = function (event) {
        var index = event.index, data = event.data, checkChangeEvent = event.checkChangeEvent;
        if (checkChangeEvent === false || !event.hasOwnProperty('checkChangeEvent')) {
            if (data && Array.isArray(data) && data.length > 0) {
                var id = data[0] && data[0][this.primaryKey] || null;
                if (id) {
                    this.setSelectionIdToBindingData(id);
                }
            }
            this.listview.activeIndex = index;
            this.fireSelectedRowChange(event);
        }
    };
    /**
     * 切换页码触发事件
     * @param event 切换页码参数
     */
    FarrisListViewBindingDirective.prototype.pageChangedHandler = function (event) {
        var pageIndex = event.pageInfo.pageIndex;
        var pageSize = event.pageInfo.pageSize;
        if (pageIndex < 1) {
            pageIndex = 1;
        }
        var skip = (pageIndex - 1) * pageSize;
        this.bindingData.setPagingInfo(skip, pageSize, this.bindingData.bindingPath);
    };
    /**
     * 设置每页数据条数触发事件
     * @param event 切换页码参数
     */
    FarrisListViewBindingDirective.prototype.pageSizeChangedHandler = function (event) {
        var _a = event.pageInfo, pageIndex = _a.pageIndex, pageSize = _a.pageSize;
        var skip = (pageIndex - 1) * (+pageSize);
        this.bindingData.setPagingInfo(skip, pageSize, this.bindingData.bindingPath);
    };
    FarrisListViewBindingDirective.prototype.checkValuesChange = function (event) {
        var ids = event;
        this.setChecks(ids);
    };
    FarrisListViewBindingDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[farrisListviewBinding]'
                },] }
    ];
    /** @nocollapse */
    FarrisListViewBindingDirective.ctorParameters = function () { return [
        { type: BindingData },
        { type: ViewModel },
        { type: ListViewComponent }
    ]; };
    FarrisListViewBindingDirective.propDecorators = {
        supportPaged: [{ type: Input }],
        selectedRowChange: [{ type: Output }],
        changeRow: [{ type: HostListener, args: ['listClick', ['$event'],] }],
        pageChangedHandler: [{ type: HostListener, args: ['pageChanged', ['$event'],] }],
        pageSizeChangedHandler: [{ type: HostListener, args: ['pageSizeChanged', ['$event'],] }],
        checkValuesChange: [{ type: HostListener, args: ['checkValuesChange', ['$event'],] }]
    };
    return FarrisListViewBindingDirective;
}());
export { FarrisListViewBindingDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzX2xpc3R2aWV3X2JpbmRpbmcuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9rZW5kby1iaW5kaW5nLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZXMvbGlzdC12aWV3L2ZhcnJpc19saXN0dmlld19iaW5kaW5nLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsT0FBTyxFQUFFLFNBQVMsRUFBVSxZQUFZLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBd0IsS0FBSyxFQUFxQixNQUFNLGVBQWUsQ0FBQztBQUN0SSxPQUFPLEVBQUUsV0FBVyxFQUFlLFNBQVMsRUFBVSxNQUFNLGdCQUFnQixDQUFDO0FBQzdFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3pEO0lBb0JFLHdDQUNVLFdBQXdCLEVBQ3hCLFNBQW9CLEVBQ3BCLFFBQTJCO1FBRjNCLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDcEIsYUFBUSxHQUFSLFFBQVEsQ0FBbUI7UUFUNUIsaUJBQVksR0FBWSxJQUFJLENBQUM7UUFDdEM7O1dBRUc7UUFDTyxzQkFBaUIsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztJQU96RSxDQUFDO0lBZkQsc0JBQWMsc0RBQVU7UUFIeEI7O1dBRUc7YUFDSDtZQUNFLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUM7UUFDckMsQ0FBQzs7O09BQUE7SUFlRCxpREFBUSxHQUFSO1FBQ0UsT0FBTztRQUNQLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNoQixJQUFJLENBQUMsOEJBQThCLEVBQUUsQ0FBQztJQUV4QyxDQUFDO0lBRUQsb0RBQVcsR0FBWDtRQUNFLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNsQixDQUFDO0lBRUQsb0RBQVcsR0FBWDtRQUNFLElBQUksQ0FBQyxnQ0FBZ0MsRUFBRSxDQUFDO0lBQzFD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LENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUMvRSxDQUFDO0lBRUQ7OztPQUdHO0lBRUksK0RBQXNCLEdBRDdCLFVBQzhCLEtBQVU7UUFDaEMsSUFBQSxtQkFBd0MsRUFBdEMsd0JBQVMsRUFBRSxzQkFBMkIsQ0FBQztRQUMvQyxJQUFNLElBQUksR0FBRyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFFTSwwREFBaUIsR0FEeEIsVUFDeUIsS0FBVTtRQUNqQyxJQUFNLEdBQUcsR0FBRyxLQUFLLENBQUM7UUFDbEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN0QixDQUFDOztnQkF0UEYsU0FBUyxTQUFDO29CQUNULFFBQVEsRUFBRSx5QkFBeUI7aUJBQ3BDOzs7O2dCQUpRLFdBQVc7Z0JBQWUsU0FBUztnQkFDbkMsaUJBQWlCOzs7K0JBZXZCLEtBQUs7b0NBSUwsTUFBTTs0QkF3TE4sWUFBWSxTQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQztxQ0FtQnBDLFlBQVksU0FBQyxhQUFhLEVBQUUsQ0FBQyxRQUFRLENBQUM7eUNBZXRDLFlBQVksU0FBQyxpQkFBaUIsRUFBRSxDQUFDLFFBQVEsQ0FBQztvQ0FNMUMsWUFBWSxTQUFDLG1CQUFtQixFQUFFLENBQUMsUUFBUSxDQUFDOztJQUsvQyxxQ0FBQztDQUFBLEFBdlBELElBdVBDO1NBblBZLDhCQUE4QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBEaXJlY3RpdmUsIE9uSW5pdCwgSG9zdExpc3RlbmVyLCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgT25EZXN0cm95LCBPbkNoYW5nZXMsIElucHV0LCBDaGFuZ2VEZXRlY3RvclJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBCaW5kaW5nRGF0YSwgQmluZGluZ0xpc3QsIFZpZXdNb2RlbCwgQ2hhbmdlIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBMaXN0Vmlld0NvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktbGlzdC12aWV3JztcclxuQERpcmVjdGl2ZSh7XHJcbiAgc2VsZWN0b3I6ICdbZmFycmlzTGlzdHZpZXdCaW5kaW5nXSdcclxufSlcclxuXHJcbmV4cG9ydCBjbGFzcyBGYXJyaXNMaXN0Vmlld0JpbmRpbmdEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSwgT25DaGFuZ2VzIHtcclxuICBiaW5kaW5nRGF0YUNoYW5nZUV2ZW50OiBTdWJzY3JpcHRpb247XHJcblxyXG4gIC8qKlxyXG4gICAqIOS4u+mUrlxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBnZXQgcHJpbWFyeUtleSgpIHtcclxuICAgIHJldHVybiB0aGlzLmJpbmRpbmdMaXN0LnByaW1hcnlLZXk7XHJcbiAgfVxyXG5cclxuICBASW5wdXQoKSBzdXBwb3J0UGFnZWQ6IGJvb2xlYW4gPSB0cnVlO1xyXG4gIC8qKlxyXG4gICAqIOmAieS4reihjOWIh+aNouS6i+S7tlxyXG4gICAqL1xyXG4gIEBPdXRwdXQoKSBzZWxlY3RlZFJvd0NoYW5nZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGJpbmRpbmdEYXRhOiBCaW5kaW5nRGF0YSxcclxuICAgIHByaXZhdGUgdmlld01vZGVsOiBWaWV3TW9kZWwsXHJcbiAgICBwcml2YXRlIGxpc3R2aWV3OiBMaXN0Vmlld0NvbXBvbmVudCkge1xyXG5cclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgLy8g57uR5a6a5pWw5o2uXHJcbiAgICB0aGlzLmJpbmREYXRhKCk7XHJcbiAgICB0aGlzLnJlZ2lzdGVyQmluZGluZ0RhdGFDaGFuZ2VFdmVudCgpO1xyXG5cclxuICB9XHJcblxyXG4gIG5nT25DaGFuZ2VzKCkge1xyXG4gICAgdGhpcy5iaW5kRGF0YSgpO1xyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICB0aGlzLnVuUmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bliIbpobXkv6Hmga9cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0UGFnaW5nSW5mbygpIHtcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGg7XHJcbiAgICBjb25zdCBiaW5kaW5nRGF0YSA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhO1xyXG4gICAgbGV0IHBhZ2luZ0luZm8gPSBiaW5kaW5nRGF0YS5wYWdpbmdJbmZvO1xyXG4gICAgaWYgKGJpbmRpbmdQYXRoID09PSAnLycpIHtcclxuICAgICAgcmV0dXJuIHBhZ2luZ0luZm87XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zdWJzdHIoMSkuc3BsaXQoJy8nKS5maWx0ZXIoaXRlbSA9PiAhIWl0ZW0gJiYgaXRlbS5sZW5ndGggPiAwKS5tYXAoaXRlbSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGl0ZW0uc3Vic3RyaW5nKDAsIGl0ZW0ubGVuZ3RoIC0gMSk7XHJcbiAgICAgIH0pO1xyXG4gICAgICBiaW5kaW5nUGF0aHMuZm9yRWFjaChwYXRoID0+IHtcclxuICAgICAgICBwYWdpbmdJbmZvID0gcGFnaW5nSW5mbyAmJiBwYWdpbmdJbmZvW3BhdGhdO1xyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuIHBhZ2luZ0luZm87XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDorr7nva5saXN0dmlld+WxnuaAp1xyXG4gICAqL1xyXG4gIHByaXZhdGUgc2V0TGlzdFZpZXdQYWdlUHJvcHMoKSB7XHJcbiAgICBjb25zdCBkYXRhID0gdGhpcy5iaW5kaW5nTGlzdC50b0pTT04oKTtcclxuICAgIGxldCBza2lwID0gMDtcclxuICAgIGNvbnN0IHsgcGFnZUluZGV4ID0gMSwgcGFnZVNpemUgPSAwIH0gPSB0aGlzLmdldFBhZ2luZ0luZm8oKSB8fCB7fTtcclxuICAgIGxldCB7IHRvdGFsID0gMCB9ID0gdGhpcy5nZXRQYWdpbmdJbmZvKCkgfHwge307XHJcbiAgICBpZiAocGFnZUluZGV4ID4gMCkge1xyXG4gICAgICBza2lwID0gKHBhZ2VJbmRleCAtIDEpICogcGFnZVNpemU7XHJcbiAgICB9XHJcbiAgICBpZiAocGFnZVNpemUgPT09IDAgJiYgdG90YWwgPT09IDApIHtcclxuICAgICAgdG90YWwgPSBkYXRhLmxlbmd0aDtcclxuICAgIH1cclxuICAgIHRoaXMubGlzdHZpZXcuc3VwcG9ydFBhZ2luZyA9IHRoaXMuc3VwcG9ydFBhZ2VkO1xyXG4gICAgdGhpcy5saXN0dmlldy5wYWdlSW5kZXggPSBwYWdlSW5kZXg7XHJcbiAgICB0aGlzLmxpc3R2aWV3LnBhZ2VTaXplID0gcGFnZVNpemU7XHJcbiAgICB0aGlzLmxpc3R2aWV3LnRvdGFsID0gdG90YWw7XHJcbiAgICBsZXQgY3VycmVudFBhZ2UgPSBwYWdlSW5kZXg7XHJcbiAgICBjb25zdCBpdGVtc1BlclBhZ2UgPSBwYWdlU2l6ZTtcclxuICAgIGxldCB0b3RhbEl0ZW1zID0gdG90YWw7XHJcbiAgICBpZiAocGFnZVNpemUgPT09IDApIHtcclxuICAgICAgLy8gdGhpcy5saXN0dmlldy5zdXBwb3J0UGFnaW5nID0gZmFsc2U7XHJcbiAgICAgIHRoaXMubGlzdHZpZXcucGFnZUluZGV4ID0gcGFnZUluZGV4O1xyXG4gICAgICB0aGlzLmxpc3R2aWV3LnRvdGFsID0gdG90YWw7XHJcbiAgICAgIGN1cnJlbnRQYWdlID0gMTtcclxuICAgICAgdG90YWxJdGVtcyA9IHRvdGFsO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMubGlzdHZpZXcucGFnaW5hdGlvbk9wdGlvbnMpIHtcclxuICAgICAgdGhpcy5saXN0dmlldy5wYWdpbmF0aW9uT3B0aW9ucy5pdGVtc1BlclBhZ2UgPSBpdGVtc1BlclBhZ2U7XHJcbiAgICAgIHRoaXMubGlzdHZpZXcucGFnaW5hdGlvbk9wdGlvbnMuY3VycmVudFBhZ2UgPSBjdXJyZW50UGFnZTtcclxuICAgICAgdGhpcy5saXN0dmlldy5wYWdpbmF0aW9uT3B0aW9ucy5wYWdlTGlzdCA9IHRoaXMubGlzdHZpZXcucGFnZUxpc3Q7XHJcbiAgICAgIHRoaXMubGlzdHZpZXcucGFnaW5hdGlvbk9wdGlvbnMudG90YWxJdGVtcyA9IHRvdGFsSXRlbXM7XHJcbiAgICB9XHJcbiAgICBjb25zdCBsaXN0Vmlld0NoYW5nZURldGVjdFJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYgPSB0aGlzLmxpc3R2aWV3WydjZHInXSBhcyBDaGFuZ2VEZXRlY3RvclJlZjtcclxuICAgIGlmIChsaXN0Vmlld0NoYW5nZURldGVjdFJlZikge1xyXG4gICAgICBsaXN0Vmlld0NoYW5nZURldGVjdFJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYWdpbmF0aW9uRGlyZWN0aXZlID0gdGhpcy5saXN0dmlldy5wYWdlciAmJiB0aGlzLmxpc3R2aWV3LnBhZ2VyWydwYWdpbmF0aW9uRGlyZWN0aXZlJ107XHJcbiAgICBpZiAocGFnaW5hdGlvbkRpcmVjdGl2ZSAmJiBwYWdpbmF0aW9uRGlyZWN0aXZlWydzZXJ2aWNlJ10pIHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBwYWdpbmF0aW9uRGlyZWN0aXZlWydzZXJ2aWNlJ10uaW5zdGFuY2VzW3RoaXMubGlzdHZpZXcucGFnZXIuaWRdID0geyAuLi50aGlzLmxpc3R2aWV3LnBhZ2luYXRpb25PcHRpb25zIH07XHJcbiAgICAgICAgcGFnaW5hdGlvbkRpcmVjdGl2ZVsnc2VydmljZSddLnNldFRvdGFsSXRlbXModGhpcy5saXN0dmlldy5wYWdlci5pZCwgdG90YWxJdGVtcyk7XHJcbiAgICAgICAgcGFnaW5hdGlvbkRpcmVjdGl2ZS5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgIH0gY2F0Y2ggeyB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKlxyXG4gICAqIOiOt+WPlue7keWumuaVsOaNrlxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBnZXQgYmluZGluZ0xpc3QoKTogQmluZGluZ0xpc3Qge1xyXG4gICAgLy8g5qC55a6e5L2TXHJcbiAgICBpZiAodGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09ICcvJyB8fCAhdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGgpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuYmluZGluZ0RhdGEubGlzdDtcclxuICAgIH1cclxuICAgIC8vIOWtkOWunuS9k1xyXG4gICAgbGV0IGJpbmRpbmdQYXRoID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGguc3Vic3RyKDEpO1xyXG4gICAgYmluZGluZ1BhdGggPSBiaW5kaW5nUGF0aFswXS50b0xvd2VyQ2FzZSgpICsgYmluZGluZ1BhdGguc3Vic3RyaW5nKDEsIGJpbmRpbmdQYXRoLmxlbmd0aCk7XHJcbiAgICBjb25zdCBwYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJyk7XHJcblxyXG4gICAgY29uc3QgZmlsdGVyZWRQYXRocyA9IHBhdGhzLmZpbHRlcigocGFydDogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHJldHVybiBwYXJ0ICE9PSAnJztcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXMuYmluZGluZ0RhdGEuZ2V0VmFsdWUoZmlsdGVyZWRQYXRocyk7XHJcbiAgfVxyXG5cclxuICAvKiDnu5HlrprmlbDmja4gKi9cclxuICBwcml2YXRlIGJpbmREYXRhKCkge1xyXG4gICAgdGhpcy5zZXRMaXN0Vmlld1BhZ2VQcm9wcygpO1xyXG4gICAgY29uc3QgZGF0YSA9IHRoaXMuYmluZGluZ0xpc3QudG9BcnJheSgpO1xyXG4gICAgdGhpcy5saXN0dmlldy5zZXREYXRhKGRhdGEpO1xyXG4gIH1cclxuXHJcbiAgLypcclxuICAgICAgICog5Y+R5bCE6YCJ5Lit6KGM5YiH5o2i5LqL5Lu2XHJcbiAgICAgICAqIEBkZXNjcmlwdGlvbiDnu5/kuIDljZXpgInmqKHlvI/lkozlpJrpgInmqKHlvI/kuIvnmoTooYzliIfmjaLkuovku7ZcclxuICAgICAgICovXHJcbiAgcHJvdGVjdGVkIGZpcmVTZWxlY3RlZFJvd0NoYW5nZShzZWxlY3RlZFJvd0NvbnRleHQ6IGFueSkge1xyXG4gICAgdGhpcy5zZWxlY3RlZFJvd0NoYW5nZS5lbWl0KHNlbGVjdGVkUm93Q29udGV4dCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDorr7nva5CaW5kaW5nTGlzdOeahOW9k+WJjeihjFxyXG4gICAqIEBwYXJhbSBpZCDlvZPliY3ooYzlhoXnoIFcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgc2V0U2VsZWN0aW9uSWRUb0JpbmRpbmdEYXRhKGlkOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMuYmluZGluZ0xpc3Quc2V0Q3VycmVudElkKGlkLCB0cnVlKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaVsOaNrua6kOWPkeeUn+WPmOabtFxyXG4gICAqIEBwYXJhbSBjaGFuZ2Ug5Y+Y5pu0XHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIG9uQmluZGluZ0RhdGFDaGFuZ2UoY2hhbmdlOiBDaGFuZ2UpIHtcclxuICAgIHRoaXMuYmluZERhdGEoKTtcclxuICAgIHRoaXMudXBkYXRlU2VsZWN0ZWRSb3coY2hhbmdlKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6K6+572u5b2T5YmN6KGMXHJcbiAgICogQHBhcmFtIGNoYW5nZSDlj5jmm7RcclxuICAgKi9cclxuICBwcml2YXRlIHVwZGF0ZVNlbGVjdGVkUm93KGNoYW5nZT86IENoYW5nZSkge1xyXG4gICAgaWYgKCF0aGlzLmJpbmRpbmdMaXN0IHx8ICF0aGlzLmJpbmRpbmdMaXN0LmN1cnJlbnRJZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy52aWV3TW9kZWwgJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLnJvd1NlbGVjdGVkRXZlbnRTdXNwZW5kID09PSB0cnVlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IHsgaWQgPSBudWxsIH0gPSB0aGlzLmxpc3R2aWV3LmNsaWNrSXRlbSB8fCB7fTtcclxuICAgIGNvbnN0IGN1cnJlbnRJZCA9IHRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkO1xyXG4gICAgLy8gZ3JpZOW9k+WJjeihjOS4jmJpbmdpbmdMaXN05b2T5YmN6KGM5LiA6Ie077yM5peg6aG75YiH5o2iXHJcbiAgICBpZiAoaWQgPT09IGN1cnJlbnRJZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLnNlbGVjdFJvdyh0aGlzLmJpbmRpbmdMaXN0LmN1cnJlbnRJZCk7XHJcbiAgfVxyXG4gIHByb3RlY3RlZCBzZWxlY3RSb3coaWQ6IGFueSkge1xyXG4gICAgaWYgKHRoaXMubGlzdHZpZXcgJiYgdHlwZW9mIHRoaXMubGlzdHZpZXcuc2VsZWN0Um93ID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIHRoaXMubGlzdHZpZXcuc2VsZWN0Um93KGlkKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5rOo5YaMYmluZGluZ2RhdGHlj5jljJbkuovku7ZcclxuICAgKi9cclxuICBwcml2YXRlIHJlZ2lzdGVyQmluZGluZ0RhdGFDaGFuZ2VFdmVudCgpIHtcclxuICAgIHRoaXMuYmluZGluZ0RhdGFDaGFuZ2VFdmVudCA9IHRoaXMuYmluZGluZ0RhdGEuY2hhbmdlcy5zdWJzY3JpYmUoKGNoYW5nZTogQ2hhbmdlKSA9PiB7XHJcbiAgICAgIHRoaXMub25CaW5kaW5nRGF0YUNoYW5nZShjaGFuZ2UpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWPlua2iGJpbmRpbmdkYXRh5Y+Y5YyW6K6i6ZiFXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB1blJlZ2lzdGVyQmluZGluZ0RhdGFDaGFuZ2VFdmVudCgpIHtcclxuICAgIHRoaXMuYmluZGluZ0RhdGFDaGFuZ2VFdmVudC51bnN1YnNjcmliZSgpO1xyXG4gIH1cclxuICBwcml2YXRlIHNldENoZWNrcyhpZHM6IHN0cmluZ1tdKSB7XHJcbiAgICB0aGlzLnZpZXdNb2RlbC51aVN0YXRlLnNldFByb3BlcnR5VmFsdWUoJ2lkcycsIGlkcyk7XHJcbiAgfVxyXG4gIC8qIOWIh+aNouihjOS6i+S7tiAqL1xyXG4gIEBIb3N0TGlzdGVuZXIoJ2xpc3RDbGljaycsIFsnJGV2ZW50J10pXHJcbiAgY2hhbmdlUm93KGV2ZW50OiBhbnkpIHtcclxuICAgIGNvbnN0IHsgaW5kZXgsIGRhdGEsIGNoZWNrQ2hhbmdlRXZlbnQgfSA9IGV2ZW50O1xyXG4gICAgaWYgKGNoZWNrQ2hhbmdlRXZlbnQgPT09IGZhbHNlIHx8ICFldmVudC5oYXNPd25Qcm9wZXJ0eSgnY2hlY2tDaGFuZ2VFdmVudCcpKSB7XHJcbiAgICAgIGlmIChkYXRhICYmIEFycmF5LmlzQXJyYXkoZGF0YSkgJiYgZGF0YS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgY29uc3QgaWQgPSBkYXRhWzBdICYmIGRhdGFbMF1bdGhpcy5wcmltYXJ5S2V5XSB8fCBudWxsO1xyXG4gICAgICAgIGlmIChpZCkge1xyXG4gICAgICAgICAgdGhpcy5zZXRTZWxlY3Rpb25JZFRvQmluZGluZ0RhdGEoaWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICB0aGlzLmxpc3R2aWV3LmFjdGl2ZUluZGV4ID0gaW5kZXg7XHJcbiAgICAgIHRoaXMuZmlyZVNlbGVjdGVkUm93Q2hhbmdlKGV2ZW50KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIh+aNoumhteeggeinpuWPkeS6i+S7tlxyXG4gICAqIEBwYXJhbSBldmVudCDliIfmjaLpobXnoIHlj4LmlbBcclxuICAgKi9cclxuICBASG9zdExpc3RlbmVyKCdwYWdlQ2hhbmdlZCcsIFsnJGV2ZW50J10pXHJcbiAgcHVibGljIHBhZ2VDaGFuZ2VkSGFuZGxlcihldmVudDogYW55KSB7XHJcbiAgICBsZXQgcGFnZUluZGV4ID0gZXZlbnQucGFnZUluZm8ucGFnZUluZGV4O1xyXG4gICAgY29uc3QgcGFnZVNpemUgPSBldmVudC5wYWdlSW5mby5wYWdlU2l6ZTtcclxuICAgIGlmIChwYWdlSW5kZXggPCAxKSB7XHJcbiAgICAgIHBhZ2VJbmRleCA9IDE7XHJcbiAgICB9XHJcbiAgICBjb25zdCBza2lwID0gKHBhZ2VJbmRleCAtIDEpICogcGFnZVNpemU7XHJcbiAgICB0aGlzLmJpbmRpbmdEYXRhLnNldFBhZ2luZ0luZm8oc2tpcCwgcGFnZVNpemUsIHRoaXMuYmluZGluZ0RhdGEuYmluZGluZ1BhdGgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572u5q+P6aG15pWw5o2u5p2h5pWw6Kem5Y+R5LqL5Lu2XHJcbiAgICogQHBhcmFtIGV2ZW50IOWIh+aNoumhteeggeWPguaVsFxyXG4gICAqL1xyXG4gIEBIb3N0TGlzdGVuZXIoJ3BhZ2VTaXplQ2hhbmdlZCcsIFsnJGV2ZW50J10pXHJcbiAgcHVibGljIHBhZ2VTaXplQ2hhbmdlZEhhbmRsZXIoZXZlbnQ6IGFueSkge1xyXG4gICAgY29uc3QgeyBwYWdlSW5kZXgsIHBhZ2VTaXplIH0gPSBldmVudC5wYWdlSW5mbztcclxuICAgIGNvbnN0IHNraXAgPSAocGFnZUluZGV4IC0gMSkgKiAoK3BhZ2VTaXplKTtcclxuICAgIHRoaXMuYmluZGluZ0RhdGEuc2V0UGFnaW5nSW5mbyhza2lwLCBwYWdlU2l6ZSwgdGhpcy5iaW5kaW5nRGF0YS5iaW5kaW5nUGF0aCk7XHJcbiAgfVxyXG4gIEBIb3N0TGlzdGVuZXIoJ2NoZWNrVmFsdWVzQ2hhbmdlJywgWyckZXZlbnQnXSlcclxuICBwdWJsaWMgY2hlY2tWYWx1ZXNDaGFuZ2UoZXZlbnQ6IGFueSkge1xyXG4gICAgY29uc3QgaWRzID0gZXZlbnQ7XHJcbiAgICB0aGlzLnNldENoZWNrcyhpZHMpO1xyXG4gIH1cclxufVxyXG4iXX0=