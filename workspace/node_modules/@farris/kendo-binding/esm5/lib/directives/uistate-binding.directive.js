import { Directive, Input, HostListener, Self, Host, Optional, Output, EventEmitter, KeyValueDiffers } from '@angular/core';
import { ComboBoxComponent } from '@progress/kendo-angular-dropdowns';
import { LookupGridComponent } from '@farris/ui-lookup';
import { ComboListComponent } from '@farris/ui-combo-list';
import { ComboLookupComponent } from '@farris/ui-combo-lookup';
var UIStateBindingDirective = /** @class */ (function () {
    function UIStateBindingDirective(hostComboComponent, hostHelpComponent, differs, hostComboListComponent, hostComboLookupComponent) {
        this.hostComboComponent = hostComboComponent;
        this.hostHelpComponent = hostHelpComponent;
        this.differs = differs;
        this.hostComboListComponent = hostComboListComponent;
        this.hostComboLookupComponent = hostComboLookupComponent;
        this.defaultSpliter = ',';
        this.differ = null;
        this.UIStateBindingChange = new EventEmitter();
    }
    Object.defineProperty(UIStateBindingDirective.prototype, "bindingObject", {
        get: function () {
            return this._bindingObject;
        },
        set: function (value) {
            this._bindingObject = value;
            if (!this.differ && value && this.differs && typeof (value) === 'object') {
                this.differ = this.differs.find(value).create();
            }
        },
        enumerable: true,
        configurable: true
    });
    UIStateBindingDirective.prototype.onValueChange = function (val) {
        // host is combobox
        if (this.hostComboComponent && this.bindingObject) {
            if (val) {
                this.bindingObject.key = val.value;
                this.bindingObject.value = val.name;
            }
            else {
                this.bindingObject.key = null;
                this.bindingObject.value = null;
            }
        }
    };
    UIStateBindingDirective.prototype.ngOnInit = function () {
        if (this.hostComboComponent) {
            this.hostComboComponent.valuePrimitive = false;
        }
        else if (this.hostHelpComponent) {
            this.bindObjectToHostLookup();
        }
        else if (this.hostComboListComponent) {
            this.bindObjectToHostComboList();
        }
        else if (this.hostComboLookupComponent) {
            this.bindObjectToHostComboLookup();
        }
    };
    UIStateBindingDirective.prototype.ngDoCheck = function () {
        if (this.differ && typeof (this.bindingObject) === 'object') {
            var changes = this.differ && this.differ.diff(this.bindingObject);
            if (changes) {
                this.bindingChanges();
            }
        }
        else { // 兼容未重新编译工程，differ不存在从情况
            this.bindingChanges();
        }
    };
    UIStateBindingDirective.prototype.bindingChanges = function () {
        var text = this.bindingObject ? this.bindingObject.value : null;
        var key = this.bindingObject ? this.bindingObject.key : null;
        if (this.hostComboComponent) {
            this.hostComboComponent.text = text;
            var vField_1 = this.hostComboComponent.valueField;
            var item = this.hostComboComponent.data.find(function (n) { return n[vField_1] === key; });
            this.hostComboComponent.writeValue(item);
        }
        else if (this.hostHelpComponent) {
            this.hostHelpComponent.writeValue(text);
            this.hostHelpComponent.displayValue = key;
        }
        else if (this.hostComboListComponent) {
            this.hostComboListComponent.writeValue(key);
        }
        else if (this.hostComboLookupComponent) {
            this.hostComboLookupComponent.selectedValues = key;
            this.hostComboLookupComponent.writeValue(text);
        }
    };
    UIStateBindingDirective.prototype.ngOnChanges = function (changes) {
        if (changes.bindingObject && !this.differ) {
            this.bindingChanges();
        }
    };
    // 弹出帮助
    UIStateBindingDirective.prototype.bindObjectToHostLookup = function () {
        var _this = this;
        if (!this.hostHelpComponent) {
            return;
        }
        this.hostHelpComponent.selectedData.subscribe(function (data) { return _this.updateHelpBindingObject(data); });
        this.hostHelpComponent.clear.subscribe(function () {
            // this.bindingObject = {key: null, value: null};
            _this.updateHelpBindingObject(null);
        });
        if (this.hostHelpComponent.tagRemoved) {
            this.hostHelpComponent.tagRemoved.subscribe(function (event) {
                var _a = event.removedIndex, index = _a === void 0 ? -1 : _a, _b = event.instance, componentRef = _b === void 0 ? null : _b;
                if (index === -1) {
                    return;
                }
                var isSigleSelect = componentRef.singleSelect;
                if (isSigleSelect || !componentRef.displayValue) {
                    _this.updateHelpBindingObject(null);
                }
                else {
                    _this.UIStateBindingChange.emit({ key: componentRef.displayValue, value: componentRef.displayText });
                }
            });
        }
        if (this.hostHelpComponent.nosearch) {
            this.hostHelpComponent.valueChanged.subscribe(function (txt) {
                var _a;
                var idField = _this.hostHelpComponent.idField;
                var textField = _this.hostHelpComponent.textField;
                _this.updateHelpBindingObject((_a = {},
                    _a[idField] = txt,
                    _a[textField] = txt,
                    _a));
            });
        }
    };
    // 下拉列表
    UIStateBindingDirective.prototype.bindObjectToHostComboList = function () {
        var _this = this;
        if (!this.hostComboListComponent) {
            return;
        }
        this.hostComboListComponent.valueChange.subscribe(function (data) { return _this.updateHelpBindingObject(data.selections); });
        this.hostComboListComponent.clear.subscribe(function () {
            _this.updateHelpBindingObject(null);
        });
    };
    // 下拉帮助
    UIStateBindingDirective.prototype.bindObjectToHostComboLookup = function () {
        var _this = this;
        if (!this.hostComboLookupComponent) {
            return;
        }
        if (this.hostComboLookupComponent.multiSelect) {
            this.hostComboLookupComponent.valueChange.subscribe(function (data) { return _this.updateHelpBindingObject(data.selections); });
        }
        else {
            // this.hostComboLookupComponent.selectChange.subscribe((data: any) => this.updateHelpBindingObject(data));
            this.hostComboLookupComponent.selectChange.subscribe(function (e) {
                var data = e;
                if (e.data) {
                    data = e.data;
                }
                _this.updateHelpBindingObject(data);
            });
        }
        this.hostComboLookupComponent.clear.subscribe(function () {
            _this.updateHelpBindingObject(null);
        });
    };
    // 更新UISTATE
    UIStateBindingDirective.prototype.updateHelpBindingObject = function (data) {
        var idField;
        var textField;
        var spliter = this.defaultSpliter;
        if (this.hostHelpComponent) {
            idField = this.hostHelpComponent.idField;
            textField = this.hostHelpComponent.textField;
            spliter = this.hostHelpComponent.multipleChoiceSeparator || this.defaultSpliter;
        }
        if (this.hostComboListComponent) {
            idField = this.hostComboListComponent.idField;
            textField = this.hostComboListComponent.textField;
        }
        if (this.hostComboLookupComponent) {
            idField = this.hostComboLookupComponent.idField;
            textField = this.hostComboLookupComponent.textField;
            spliter = this.hostComboLookupComponent.separator || this.defaultSpliter;
        }
        this.emitUiStateBinding(data, idField, textField, spliter);
    };
    UIStateBindingDirective.prototype.emitUiStateBinding = function (data, idField, textField, spliter) {
        if (spliter === void 0) { spliter = ','; }
        var newObject = { key: null, value: null };
        if (data) {
            // const idField = this.hostHelpComponent.idField;
            // const textField = this.hostHelpComponent.textField;
            if (Array.isArray(data)) {
                newObject.key = data.map(function (d) { return d[idField]; }).join(spliter);
                newObject.value = data.map(function (d) {
                    if (textField.indexOf('.') > -1) {
                        return textField.split('.').reduce(function (r, c) {
                            return r[c];
                        }, d);
                    }
                    else {
                        return d[textField];
                    }
                }).join(spliter);
            }
            else {
                if (idField) {
                    newObject.key = data[idField];
                }
                if (textField) {
                    if (textField.indexOf('.') > -1) {
                        newObject.value = textField.split('.').reduce(function (r, c) {
                            return r[c];
                        }, data);
                    }
                    else {
                        newObject.value = data[textField];
                    }
                }
            }
        }
        this.UIStateBindingChange.emit(newObject);
    };
    UIStateBindingDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[UIStateBinding]'
                },] }
    ];
    /** @nocollapse */
    UIStateBindingDirective.ctorParameters = function () { return [
        { type: ComboBoxComponent, decorators: [{ type: Host }, { type: Self }, { type: Optional }] },
        { type: LookupGridComponent, decorators: [{ type: Host }, { type: Self }, { type: Optional }] },
        { type: KeyValueDiffers, decorators: [{ type: Optional }] },
        { type: ComboListComponent, decorators: [{ type: Host }, { type: Self }, { type: Optional }] },
        { type: ComboLookupComponent, decorators: [{ type: Host }, { type: Self }, { type: Optional }] }
    ]; };
    UIStateBindingDirective.propDecorators = {
        bindingObject: [{ type: Input, args: ['UIStateBinding',] }],
        UIStateBindingChange: [{ type: Output }],
        onValueChange: [{ type: HostListener, args: ['valueChange', ['$event'],] }]
    };
    return UIStateBindingDirective;
}());
export { UIStateBindingDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidWlzdGF0ZS1iaW5kaW5nLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMva2VuZG8tYmluZGluZy8iLCJzb3VyY2VzIjpbImxpYi9kaXJlY3RpdmVzL3Vpc3RhdGUtYmluZGluZy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQVUsWUFBWSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQXFELGVBQWUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2TCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUN0RSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUUvRDtJQWtDRSxpQ0FDc0Msa0JBQXFDLEVBQ3JDLGlCQUFzQyxFQUN0RCxPQUF3QixFQUNSLHNCQUEwQyxFQUMxQyx3QkFBOEM7UUFKOUMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFtQjtRQUNyQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQXFCO1FBQ3RELFlBQU8sR0FBUCxPQUFPLENBQWlCO1FBQ1IsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUFvQjtRQUMxQyw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQXNCO1FBbENuRSxtQkFBYyxHQUFHLEdBQUcsQ0FBQztRQUM5QixXQUFNLEdBQTZCLElBQUksQ0FBQztRQVl0Qyx5QkFBb0IsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztJQXNCeEUsQ0FBQztJQWhDTCxzQkFDSSxrREFBYTthQU1qQjtZQUNFLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQztRQUM3QixDQUFDO2FBVEQsVUFDa0IsS0FBVTtZQUMxQixJ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QUFDLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7cUJBQ25DO2lCQUNGO2FBQ0Y7U0FDRjtRQUNELElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDNUMsQ0FBQzs7Z0JBN05GLFNBQVMsU0FBQztvQkFDVCxRQUFRLEVBQUUsa0JBQWtCO2lCQUM3Qjs7OztnQkFQUSxpQkFBaUIsdUJBd0NyQixJQUFJLFlBQUksSUFBSSxZQUFJLFFBQVE7Z0JBdkNwQixtQkFBbUIsdUJBd0N2QixJQUFJLFlBQUksSUFBSSxZQUFJLFFBQVE7Z0JBMUNtSCxlQUFlLHVCQTJDMUosUUFBUTtnQkF4Q0osa0JBQWtCLHVCQXlDdEIsSUFBSSxZQUFJLElBQUksWUFBSSxRQUFRO2dCQXhDcEIsb0JBQW9CLHVCQXlDeEIsSUFBSSxZQUFJLElBQUksWUFBSSxRQUFROzs7Z0NBL0IxQixLQUFLLFNBQUMsZ0JBQWdCO3VDQVV0QixNQUFNO2dDQUVOLFlBQVksU0FBQyxhQUFhLEVBQUUsQ0FBQyxRQUFRLENBQUM7O0lBME16Qyw4QkFBQztDQUFBLEFBOU5ELElBOE5DO1NBM05ZLHVCQUF1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgSW5wdXQsIE9uSW5pdCwgSG9zdExpc3RlbmVyLCBTZWxmLCBIb3N0LCBPcHRpb25hbCwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIE9uQ2hhbmdlcywgU2ltcGxlQ2hhbmdlcywgRG9DaGVjaywgS2V5VmFsdWVEaWZmZXIsIEtleVZhbHVlRGlmZmVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBDb21ib0JveENvbXBvbmVudCB9IGZyb20gJ0Bwcm9ncmVzcy9rZW5kby1hbmd1bGFyLWRyb3Bkb3ducyc7XHJcbmltcG9ydCB7IExvb2t1cEdyaWRDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWxvb2t1cCc7XHJcbmltcG9ydCB7IENvbWJvTGlzdENvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktY29tYm8tbGlzdCc7XHJcbmltcG9ydCB7IENvbWJvTG9va3VwQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1jb21iby1sb29rdXAnO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgc2VsZWN0b3I6ICdbVUlTdGF0ZUJpbmRpbmddJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgVUlTdGF0ZUJpbmRpbmdEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgRG9DaGVjayB7XHJcbiAgcHJpdmF0ZSBfYmluZGluZ09iamVjdDogYW55O1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdFNwbGl0ZXIgPSAnLCc7XHJcbiAgcHJpdmF0ZSBkaWZmZXI6IEtleVZhbHVlRGlmZmVyPGFueSwgYW55PiA9IG51bGw7XHJcblxyXG4gIEBJbnB1dCgnVUlTdGF0ZUJpbmRpbmcnKVxyXG4gIHNldCBiaW5kaW5nT2JqZWN0KHZhbHVlOiBhbnkpIHtcclxuICAgIHRoaXMuX2JpbmRpbmdPYmplY3QgPSB2YWx1ZTtcclxuICAgIGlmICghdGhpcy5kaWZmZXIgJiYgdmFsdWUgJiYgdGhpcy5kaWZmZXJzICYmIHR5cGVvZiAodmFsdWUpID09PSAnb2JqZWN0Jykge1xyXG4gICAgICB0aGlzLmRpZmZlciA9IHRoaXMuZGlmZmVycy5maW5kKHZhbHVlKS5jcmVhdGUoKTtcclxuICAgIH1cclxuICB9XHJcbiAgZ2V0IGJpbmRpbmdPYmplY3QoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fYmluZGluZ09iamVjdDtcclxuICB9XHJcbiAgQE91dHB1dCgpIFVJU3RhdGVCaW5kaW5nQ2hhbmdlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG5cclxuICBASG9zdExpc3RlbmVyKCd2YWx1ZUNoYW5nZScsIFsnJGV2ZW50J10pXHJcbiAgb25WYWx1ZUNoYW5nZSh2YWw6IGFueSkge1xyXG4gICAgLy8gaG9zdCBpcyBjb21ib2JveFxyXG4gICAgaWYgKHRoaXMuaG9zdENvbWJvQ29tcG9uZW50ICYmIHRoaXMuYmluZGluZ09iamVjdCkge1xyXG4gICAgICBpZiAodmFsKSB7XHJcbiAgICAgICAgdGhpcy5iaW5kaW5nT2JqZWN0LmtleSA9IHZhbC52YWx1ZTtcclxuICAgICAgICB0aGlzLmJpbmRpbmdPYmplY3QudmFsdWUgPSB2YWwubmFtZTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLmJpbmRpbmdPYmplY3Qua2V5ID0gbnVsbDtcclxuICAgICAgICB0aGlzLmJpbmRpbmdPYmplY3QudmFsdWUgPSBudWxsO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIEBIb3N0KCkgQFNlbGYoKSBAT3B0aW9uYWwoKSBwcml2YXRlIGhvc3RDb21ib0NvbXBvbmVudDogQ29tYm9Cb3hDb21wb25lbnQsXHJcbiAgICBASG9zdCgpIEBTZWxmKCkgQE9wdGlvbmFsKCkgcHJpdmF0ZSBob3N0SGVscENvbXBvbmVudDogTG9va3VwR3JpZENvbXBvbmVudCxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZGlmZmVyczogS2V5VmFsdWVEaWZmZXJzLFxyXG4gICAgQEhvc3QoKSBAU2VsZigpIEBPcHRpb25hbCgpIHByaXZhdGUgaG9zdENvbWJvTGlzdENvbXBvbmVudDogQ29tYm9MaXN0Q29tcG9uZW50LFxyXG4gICAgQEhvc3QoKSBAU2VsZigpIEBPcHRpb25hbCgpIHByaXZhdGUgaG9zdENvbWJvTG9va3VwQ29tcG9uZW50OiBDb21ib0xvb2t1cENvbXBvbmVudFxyXG4gICkgeyB9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgaWYgKHRoaXMuaG9zdENvbWJvQ29tcG9uZW50KSB7XHJcbiAgICAgIHRoaXMuaG9zdENvbWJvQ29tcG9uZW50LnZhbHVlUHJpbWl0aXZlID0gZmFsc2U7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuaG9zdEhlbHBDb21wb25lbnQpIHtcclxuICAgICAgdGhpcy5iaW5kT2JqZWN0VG9Ib3N0TG9va3VwKCk7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuaG9zdENvbWJvTGlzdENvbXBvbmVudCkge1xyXG4gICAgICB0aGlzLmJpbmRPYmplY3RUb0hvc3RDb21ib0xpc3QoKTtcclxuICAgIH0gZWxzZSBpZiAodGhpcy5ob3N0Q29tYm9Mb29rdXBDb21wb25lbnQpIHtcclxuICAgICAgdGhpcy5iaW5kT2JqZWN0VG9Ib3N0Q29tYm9Mb29rdXAoKTtcclxuICAgIH1cclxuICB9XHJcbiAgbmdEb0NoZWNrKCkge1xyXG4gICAgaWYgKHRoaXMuZGlmZmVyICYmIHR5cGVvZiAodGhpcy5iaW5kaW5nT2JqZWN0KSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgY29uc3QgY2hhbmdlcyA9IHRoaXMuZGlmZmVyICYmIHRoaXMuZGlmZmVyLmRpZmYodGhpcy5iaW5kaW5nT2JqZWN0KTtcclxuICAgICAgaWYgKGNoYW5nZXMpIHtcclxuICAgICAgICB0aGlzLmJpbmRpbmdDaGFuZ2VzKCk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7IC8vIOWFvOWuueacqumHjeaWsOe8luivkeW3peeoi++8jGRpZmZlcuS4jeWtmOWcqOS7juaDheWGtVxyXG4gICAgICB0aGlzLmJpbmRpbmdDaGFuZ2VzKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGJpbmRpbmdDaGFuZ2VzKCkge1xyXG4gICAgY29uc3QgdGV4dCA9IHRoaXMuYmluZGluZ09iamVjdCA/IHRoaXMuYmluZGluZ09iamVjdC52YWx1ZSA6IG51bGw7XHJcbiAgICBjb25zdCBrZXkgPSB0aGlzLmJpbmRpbmdPYmplY3QgPyB0aGlzLmJpbmRpbmdPYmplY3Qua2V5IDogbnVsbDtcclxuICAgIGlmICh0aGlzLmhvc3RDb21ib0NvbXBvbmVudCkge1xyXG4gICAgICB0aGlzLmhvc3RDb21ib0NvbXBvbmVudC50ZXh0ID0gdGV4dDtcclxuICAgICAgY29uc3QgdkZpZWxkID0gdGhpcy5ob3N0Q29tYm9Db21wb25lbnQudmFsdWVGaWVsZDtcclxuICAgICAgY29uc3QgaXRlbSA9IHRoaXMuaG9zdENvbWJvQ29tcG9uZW50LmRhdGEuZmluZCgobikgPT4gblt2RmllbGRdID09PSBrZXkpO1xyXG4gICAgICB0aGlzLmhvc3RDb21ib0NvbXBvbmVudC53cml0ZVZhbHVlKGl0ZW0pO1xyXG4gICAgfSBlbHNlIGlmICh0aGlzLmhvc3RIZWxwQ29tcG9uZW50KSB7XHJcbiAgICAgIHRoaXMuaG9zdEhlbHBDb21wb25lbnQud3JpdGVWYWx1ZSh0ZXh0KTtcclxuICAgICAgdGhpcy5ob3N0SGVscENvbXBvbmVudC5kaXNwbGF5VmFsdWUgPSBrZXk7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuaG9zdENvbWJvTGlzdENvbXBvbmVudCkge1xyXG4gICAgICB0aGlzLmhvc3RDb21ib0xpc3RDb21wb25lbnQud3JpdGVWYWx1ZShrZXkpO1xyXG4gICAgfSBlbHNlIGlmICh0aGlzLmhvc3RDb21ib0xvb2t1cENvbXBvbmVudCkge1xyXG4gICAgICB0aGlzLmhvc3RDb21ib0xvb2t1cENvbXBvbmVudC5zZWxlY3RlZFZhbHVlcyA9IGtleTtcclxuICAgICAgdGhpcy5ob3N0Q29tYm9Mb29rdXBDb21wb25lbnQud3JpdGVWYWx1ZSh0ZXh0KTtcclxuICAgIH1cclxuICB9XHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xyXG4gICAgaWYgKGNoYW5nZXMuYmluZGluZ09iamVjdCAmJiAhdGhpcy5kaWZmZXIpIHtcclxuICAgICAgdGhpcy5iaW5kaW5nQ2hhbmdlcygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8g5by55Ye65biu5YqpXHJcbiAgcHJpdmF0ZSBiaW5kT2JqZWN0VG9Ib3N0TG9va3VwKCkge1xyXG4gICAgaWYgKCF0aGlzLmhvc3RIZWxwQ29tcG9uZW50KSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmhvc3RIZWxwQ29tcG9uZW50LnNlbGVjdGVkRGF0YS5zdWJzY3JpYmUoKGRhdGE6IGFueSkgPT4gdGhpcy51cGRhdGVIZWxwQmluZGluZ09iamVjdChkYXRhKSk7XHJcblxyXG4gICAgdGhpcy5ob3N0SGVscENvbXBvbmVudC5jbGVhci5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAvLyB0aGlzLmJpbmRpbmdPYmplY3QgPSB7a2V5OiBudWxsLCB2YWx1ZTogbnVsbH07XHJcbiAgICAgIHRoaXMudXBkYXRlSGVscEJpbmRpbmdPYmplY3QobnVsbCk7XHJcbiAgICB9KTtcclxuICAgIGlmICh0aGlzLmhvc3RIZWxwQ29tcG9uZW50LnRhZ1JlbW92ZWQpIHtcclxuICAgICAgdGhpcy5ob3N0SGVscENvbXBvbmVudC50YWdSZW1vdmVkLnN1YnNjcmliZSgoZXZlbnQ6IHsgcmVtb3ZlZEluZGV4OiBudW1iZXIsIGluc3RhbmNlOiBMb29rdXBHcmlkQ29tcG9uZW50IH0pID0+IHtcclxuICAgICAgICBjb25zdCB7IHJlbW92ZWRJbmRleDogaW5kZXggPSAtMSwgaW5zdGFuY2U6IGNvbXBvbmVudFJlZiA9IG51bGwgfSA9IGV2ZW50O1xyXG4gICAgICAgIGlmIChpbmRleCA9PT0gLTEpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgaXNTaWdsZVNlbGVjdCA9IGNvbXBvbmVudFJlZi5zaW5nbGVTZWxlY3Q7XHJcbiAgICAgICAgaWYgKGlzU2lnbGVTZWxlY3QgfHwgIWNvbXBvbmVudFJlZi5kaXNwbGF5VmFsdWUpIHtcclxuICAgICAgICAgIHRoaXMudXBkYXRlSGVscEJpbmRpbmdPYmplY3QobnVsbCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMuVUlTdGF0ZUJpbmRpbmdDaGFuZ2UuZW1pdCh7IGtleTogY29tcG9uZW50UmVmLmRpc3BsYXlWYWx1ZSwgdmFsdWU6IGNvbXBvbmVudFJlZi5kaXNwbGF5VGV4dCB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuaG9zdEhlbHBDb21wb25lbnQubm9zZWFyY2gpIHtcclxuICAgICAgdGhpcy5ob3N0SGVscENvbXBvbmVudC52YWx1ZUNoYW5nZWQuc3Vic2NyaWJlKCh0eHQ6IGFueSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGlkRmllbGQgPSB0aGlzLmhvc3RIZWxwQ29tcG9uZW50LmlkRmllbGQ7XHJcbiAgICAgICAgY29uc3QgdGV4dEZpZWxkID0gdGhpcy5ob3N0SGVscENvbXBvbmVudC50ZXh0RmllbGQ7XHJcbiAgICAgICAgdGhpcy51cGRhdGVIZWxwQmluZGluZ09iamVjdCh7XHJcbiAgICAgICAgICBbaWRGaWVsZF06IHR4dCxcclxuICAgICAgICAgIFt0ZXh0RmllbGRdOiB0eHRcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyDkuIvmi4nliJfooahcclxuICBwcml2YXRlIGJpbmRPYmplY3RUb0hvc3RDb21ib0xpc3QoKSB7XHJcbiAgICBpZiAoIXRoaXMuaG9zdENvbWJvTGlzdENvbXBvbmVudCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5ob3N0Q29tYm9MaXN0Q29tcG9uZW50LnZhbHVlQ2hhbmdlLnN1YnNjcmliZSgoZGF0YTogYW55KSA9PiB0aGlzLnVwZGF0ZUhlbHBCaW5kaW5nT2JqZWN0KGRhdGEuc2VsZWN0aW9ucykpO1xyXG5cclxuICAgIHRoaXMuaG9zdENvbWJvTGlzdENvbXBvbmVudC5jbGVhci5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICB0aGlzLnVwZGF0ZUhlbHBCaW5kaW5nT2JqZWN0KG51bGwpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvLyDkuIvmi4nluK7liqlcclxuICBwcml2YXRlIGJpbmRPYmplY3RUb0hvc3RDb21ib0xvb2t1cCgpIHtcclxuICAgIGlmICghdGhpcy5ob3N0Q29tYm9Mb29rdXBDb21wb25lbnQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmhvc3RDb21ib0xvb2t1cENvbXBvbmVudC5tdWx0aVNlbGVjdCkge1xyXG4gICAgICB0aGlzLmhvc3RDb21ib0xvb2t1cENvbXBvbmVudC52YWx1ZUNoYW5nZS5zdWJzY3JpYmUoKGRhdGE6IGFueSkgPT4gdGhpcy51cGRhdGVIZWxwQmluZGluZ09iamVjdChkYXRhLnNlbGVjdGlvbnMpKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIHRoaXMuaG9zdENvbWJvTG9va3VwQ29tcG9uZW50LnNlbGVjdENoYW5nZS5zdWJzY3JpYmUoKGRhdGE6IGFueSkgPT4gdGhpcy51cGRhdGVIZWxwQmluZGluZ09iamVjdChkYXRhKSk7XHJcbiAgICAgIHRoaXMuaG9zdENvbWJvTG9va3VwQ29tcG9uZW50LnNlbGVjdENoYW5nZS5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgIGxldCBkYXRhID0gZTtcclxuICAgICAgICBpZiAoZS5kYXRhKSB7XHJcbiAgICAgICAgICBkYXRhID0gZS5kYXRhO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnVwZGF0ZUhlbHBCaW5kaW5nT2JqZWN0KGRhdGEpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmhvc3RDb21ib0xvb2t1cENvbXBvbmVudC5jbGVhci5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICB0aGlzLnVwZGF0ZUhlbHBCaW5kaW5nT2JqZWN0KG51bGwpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvLyDmm7TmlrBVSVNUQVRFXHJcbiAgcHJpdmF0ZSB1cGRhdGVIZWxwQmluZGluZ09iamVjdChkYXRhOiBhbnkpIHtcclxuICAgIGxldCBpZEZpZWxkO1xyXG4gICAgbGV0IHRleHRGaWVsZDtcclxuICAgIGxldCBzcGxpdGVyOiBzdHJpbmcgPSB0aGlzLmRlZmF1bHRTcGxpdGVyO1xyXG4gICAgaWYgKHRoaXMuaG9zdEhlbHBDb21wb25lbnQpIHtcclxuICAgICAgaWRGaWVsZCA9IHRoaXMuaG9zdEhlbHBDb21wb25lbnQuaWRGaWVsZDtcclxuICAgICAgdGV4dEZpZWxkID0gdGhpcy5ob3N0SGVscENvbXBvbmVudC50ZXh0RmllbGQ7XHJcbiAgICAgIHNwbGl0ZXIgPSB0aGlzLmhvc3RIZWxwQ29tcG9uZW50Lm11bHRpcGxlQ2hvaWNlU2VwYXJhdG9yIHx8IHRoaXMuZGVmYXVsdFNwbGl0ZXI7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuaG9zdENvbWJvTGlzdENvbXBvbmVudCkge1xyXG4gICAgICBpZEZpZWxkID0gdGhpcy5ob3N0Q29tYm9MaXN0Q29tcG9uZW50LmlkRmllbGQ7XHJcbiAgICAgIHRleHRGaWVsZCA9IHRoaXMuaG9zdENvbWJvTGlzdENvbXBvbmVudC50ZXh0RmllbGQ7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuaG9zdENvbWJvTG9va3VwQ29tcG9uZW50KSB7XHJcbiAgICAgIGlkRmllbGQgPSB0aGlzLmhvc3RDb21ib0xvb2t1cENvbXBvbmVudC5pZEZpZWxkO1xyXG4gICAgICB0ZXh0RmllbGQgPSB0aGlzLmhvc3RDb21ib0xvb2t1cENvbXBvbmVudC50ZXh0RmllbGQ7XHJcbiAgICAgIHNwbGl0ZXIgPSB0aGlzLmhvc3RDb21ib0xvb2t1cENvbXBvbmVudC5zZXBhcmF0b3IgfHwgdGhpcy5kZWZhdWx0U3BsaXRlcjtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmVtaXRVaVN0YXRlQmluZGluZyhkYXRhLCBpZEZpZWxkLCB0ZXh0RmllbGQsIHNwbGl0ZXIpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBlbWl0VWlTdGF0ZUJpbmRpbmcoZGF0YSwgaWRGaWVsZCwgdGV4dEZpZWxkLCBzcGxpdGVyOiBzdHJpbmcgPSAnLCcpIHtcclxuICAgIGNvbnN0IG5ld09iamVjdCA9IHsga2V5OiBudWxsLCB2YWx1ZTogbnVsbCB9O1xyXG4gICAgaWYgKGRhdGEpIHtcclxuICAgICAgLy8gY29uc3QgaWRGaWVsZCA9IHRoaXMuaG9zdEhlbHBDb21wb25lbnQuaWRGaWVsZDtcclxuICAgICAgLy8gY29uc3QgdGV4dEZpZWxkID0gdGhpcy5ob3N0SGVscENvbXBvbmVudC50ZXh0RmllbGQ7XHJcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSB7XHJcbiAgICAgICAgbmV3T2JqZWN0LmtleSA9IGRhdGEubWFwKChkKSA9PiBkW2lkRmllbGRdKS5qb2luKHNwbGl0ZXIpO1xyXG4gICAgICAgIG5ld09iamVjdC52YWx1ZSA9IGRhdGEubWFwKChkKSA9PiB7XHJcbiAgICAgICAgICBpZiAodGV4dEZpZWxkLmluZGV4T2YoJy4nKSA+IC0xKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0ZXh0RmllbGQuc3BsaXQoJy4nKS5yZWR1Y2UoKHIsIGMpID0+IHtcclxuICAgICAgICAgICAgICByZXR1cm4gcltjXTtcclxuICAgICAgICAgICAgfSwgZCk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gZFt0ZXh0RmllbGRdO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pLmpvaW4oc3BsaXRlcik7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWYgKGlkRmllbGQpIHtcclxuICAgICAgICAgIG5ld09iamVjdC5rZXkgPSBkYXRhW2lkRmllbGRdO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRleHRGaWVsZCkge1xyXG4gICAgICAgICAgaWYgKHRleHRGaWVsZC5pbmRleE9mKCcuJykgPiAtMSkge1xyXG4gICAgICAgICAgICBuZXdPYmplY3QudmFsdWUgPSB0ZXh0RmllbGQuc3BsaXQoJy4nKS5yZWR1Y2UoKHIsIGMpID0+IHtcclxuICAgICAgICAgICAgICByZXR1cm4gcltjXTtcclxuICAgICAgICAgICAgfSwgZGF0YSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBuZXdPYmplY3QudmFsdWUgPSBkYXRhW3RleHRGaWVsZF07XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICB0aGlzLlVJU3RhdGVCaW5kaW5nQ2hhbmdlLmVtaXQobmV3T2JqZWN0KTtcclxuICB9XHJcbn1cclxuIl19