import { Directive, Inject, Injector, Input } from "@angular/core";
import { UserSettingsToken } from "@farris/devkit";
import { BigNumber } from 'bignumber.js';
import moment from 'moment';
import { TextComponent } from '@farris/ui-text';
var FarrisTextLocalizationDirective = /** @class */ (function () {
    function FarrisTextLocalizationDirective(injector, userSettings, componentRef) {
        this.injector = injector;
        this.userSettings = userSettings;
        this.componentRef = componentRef;
        this.transform();
    }
    FarrisTextLocalizationDirective.prototype.ngOnInit = function () {
    };
    FarrisTextLocalizationDirective.prototype.transform = function () {
        var _this = this;
        if (this.componentRef) {
            this.componentRef.beforeWriteValue = function (value, options) {
                var _a = options.localizationType, localizationType = _a === void 0 ? null : _a, _b = options.showTime, showTime = _b === void 0 ? false : _b;
                if (!value) {
                    return '';
                }
                if (localizationType && value) {
                    localizationType = localizationType.toLowerCase();
                    value = _this.transformValue(value, localizationType);
                    return value;
                }
                else {
                    return undefined;
                }
            };
        }
    };
    FarrisTextLocalizationDirective.prototype.transformValue = function (value, dataType) {
        if (dataType === 'date') {
            return this.transformDate(value);
        }
        else if (dataType === 'datetime') {
            return this.transformDateTime(value);
        }
        // 涉及金额计算及显示问题，不予处理
        //  else if (dataType === 'number') {
        //   return this.transformNumber(value);
        // } 
        else {
            return value;
        }
    };
    /**
     * 转换日期
     * @param value value
     */
    FarrisTextLocalizationDirective.prototype.transformDate = function (value) {
        var dateFormat = this.userSettings && this.userSettings.dateFormat || 'YYYY-MM-DD';
        if (!dateFormat || !value) {
            return value;
        }
        var date = moment(value);
        var isValid = date.isValid();
        if (!isValid) {
            return value;
        }
        dateFormat = this.parseDateFormat(dateFormat);
        return date.format(dateFormat);
    };
    /**
     * 转换日期时间
     * @param value value
     * todo: 目前无法定义日期时间格式
     */
    FarrisTextLocalizationDirective.prototype.transformDateTime = function (value) {
        var dateFormat = this.userSettings && this.userSettings.dateFormat || 'YYYY-MM-DD';
        var timeFormat = this.userSettings && this.userSettings.timeFormat || 'HH:mm:ss';
        if (!dateFormat || !timeFormat) {
            return value;
        }
        var dateTime = moment(value);
        var isValid = dateTime.isValid();
        if (!isValid) {
            return value;
        }
        if (dateFormat) {
            dateFormat = this.parseDateFormat(dateFormat);
        }
        if (timeFormat) {
            timeFormat = this.parseTimeFormat(timeFormat);
        }
        var dateTimeFormat = dateFormat + ' ' + timeFormat;
        return dateTime.format(dateTimeFormat);
    };
    /**
     * 转换数字
     * @param value value
     */
    FarrisTextLocalizationDirective.prototype.transformNumber = function (value) {
        if (value === null || value === undefined || value === '') {
            return '';
        }
        var bigNumber = new BigNumber(value);
        // 如果不是数字，不做任何处理
        if (!BigNumber.isBigNumber(bigNumber)) {
            return value;
        }
        var isNegative = bigNumber.isNegative();
        var format = this.buildNumberFormat();
        var _a = this.numberFormat || {}, _b = _a.negativeSign, negativeSign = _b === void 0 ? null : _b, _c = _a.numberDecimalDigits, numberDecimalDigits = _c === void 0 ? null : _c;
        if (isNegative) {
            if (negativeSign !== null) {
                format.prefix = negativeSign;
                return bigNumber.absoluteValue().toFormat(numberDecimalDigits, null, format);
            }
        }
        return bigNumber.toFormat(numberDecimalDigits, null, format);
    };
    /**
     * 转换日期格式规则为moment的format规则
     * @param format format
     */
    FarrisTextLocalizationDirective.prototype.parseDateFormat = function (format) {
        return format.replace(/y/g, 'Y').replace(/d/g, 'D');
    };
    /**
     * 转换时间格式规则为moment的format规则
     * @param format format
     */
    FarrisTextLocalizationDirective.prototype.parseTimeFormat = function (format) {
        return format.replace(/M/g, 'm');
    };
    /**
     * 构造bignumber数字格式化选项
     */
    FarrisTextLocalizationDirective.prototype.buildNumberFormat = function () {
        if (this.numberFormat) {
            var _a = this.numberFormat, _b = _a.numberDecimalSeparator, numberDecimalSeparator = _b === void 0 ? null : _b, _c = _a.numberGroupSeparator, numberGroupSeparator = _c === void 0 ? null : _c;
            var format = {
                groupSize: 3,
            };
            if (numberDecimalSeparator !== null) {
                format.decimalSeparator = numberDecimalSeparator;
            }
            if (numberGroupSeparator !== null) {
                format.groupSeparator = numberGroupSeparator;
            }
            return format;
        }
    };
    Object.defineProperty(FarrisTextLocalizationDirective.prototype, "numberFormat", {
        get: function () {
            return this.userSettings && this.userSettings.numberFormat || null;
        },
        enumerable: true,
        configurable: true
    });
    FarrisTextLocalizationDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[farris-text-localization]'
                },] }
    ];
    /** @nocollapse */
    FarrisTextLocalizationDirective.ctorParameters = function () { return [
        { type: Injector },
        { type: undefined, decorators: [{ type: Inject, args: [UserSettingsToken,] }] },
        { type: TextComponent }
    ]; };
    FarrisTextLocalizationDirective.propDecorators = {
        localization: [{ type: Input, args: ['localization',] }]
    };
    return FarrisTextLocalizationDirective;
}());
export { FarrisTextLocalizationDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzX3RleHRfbG9jYWxpemF0aW9uLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMva2VuZG8tYmluZGluZy8iLCJzb3VyY2VzIjpbImxpYi9kaXJlY3RpdmVzL2xvY2FsaXphdGlvbi9mYXJyaXNfdGV4dF9sb2NhbGl6YXRpb24uZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDM0UsT0FBTyxFQUE4QixpQkFBaUIsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQy9FLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDekMsT0FBTyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBQzVCLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUVoRDtJQUtFLHlDQUFvQixRQUFrQixFQUFxQyxZQUEwQixFQUFVLFlBQTJCO1FBQXRILGFBQVEsR0FBUixRQUFRLENBQVU7UUFBcUMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFBVSxpQkFBWSxHQUFaLFlBQVksQ0FBZTtRQUN4SSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDbkIsQ0FBQztJQUNNLGtEQUFRLEdBQWY7SUFDQSxDQUFDO0lBQ08sbURBQVMsR0FBakI7UUFBQSxpQkFnQkM7UUFmQyxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDckIsSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsR0FBRyxVQUFDLEtBQVUsRUFBRSxPQUFZO2dCQUN0RCxJQUFBLDZCQUF1QixFQUF2Qiw0Q0FBdUIsRUFBRSxxQkFBZ0IsRUFBaEIscUNBQWdCLENBQWE7Z0JBQzVELElBQUksQ0FBQyxLQUFLLEVBQUU7b0JBQ1YsT0FBTyxFQUFFLENBQUM7aUJBQ1g7Z0JBQ0QsSUFBSSxnQkFBZ0IsSUFBSSxLQUFLLEVBQUU7b0JBQzdCLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxDQUFDO29CQUNsRCxLQUFLLEdBQUcsS0FBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztvQkFDckQsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7cUJBQU07b0JBQ0wsT0FBTyxTQUFTLENBQUM7aUJBQ2xCO1lBQ0gsQ0FBQyxDQUFDO1NBQ0g7SUFDSCxDQUFDO0lBQ08sd0RBQWMsR0FBdEIsVUFBdUIsS0FBVSxFQUFFLFFBQWdCO1FBQ2pELElBQUksUUFBUSxLQUFLLE1BQU0sRUFBRTtZQUN2QixPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDbEM7YUFBTSxJQUFJLFFBQVEsS0FBSyxVQUFVLEVBQUU7WUFDbEMsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDdEM7UUFDRCxtQkFBbUI7UUFDbkIscUNBQXFDO1FBQ3JDLHdDQUF3QztRQUN4QyxLQUFLO2FBQ0E7WUFDSCxPQUFPLEtBQUssQ0FBQztTQUNkO0lBQ0gsQ0FBQztJQUNEOzs7T0FHRztJQUNLLHVEQUFhLEdBQXJCLFVBQXNCLEtBQVU7UUFDOUIsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsSUFBSSxZQUFZLENBQUM7UUFDbkYsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUN6QixPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzNCLElBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ1osT0FBTyxLQUFLLENBQUM7U0FDZDtRQUNELFVBQVUsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzlDLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBQ0Q7Ozs7T0FJRztJQUNLLDJEQUFpQixHQUF6QixVQUEwQixLQUFVO1FBQ2xDLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLElBQUksWUFBWSxDQUFDO1FBQ25GLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLElBQUksVUFBVSxDQUFDO1FBQ2pGLElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDOUIsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUNELElBQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMvQixJQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDbkMsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNaLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFDRCxJQUFJLFVBQVUsRUFBRTtZQUNkLFVBQVUsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQy9DO1FBQ0QsSUFBSSxVQUFVLEVBQUU7WUFDZCxVQUFVLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUMvQztRQUNELElBQU0sY0FBYyxHQUFHLFVBQVUsR0FBRyxHQUFHLEdBQUcsVUFBVSxDQUFDO1FBQ3JELE9BQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBQ0Q7OztPQUdHO0lBQ0sseURBQWUsR0FBdkIsVUFBd0IsS0FBSztRQUMzQixJQUFJLEtBQUssS0FBSyxJQUFJLElBQUksS0FBSyxLQUFLLFNBQVMsSUFBSSxLQUFLLEtBQUssRUFBRSxFQUFFO1lBQ3pELE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFDRCxJQUFNLFNBQVMsR0FBRyxJQUFJLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN2QyxnQkFBZ0I7UUFDaEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDckMsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUNELElBQU0sVUFBVSxHQUFHLFNBQVMsQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUMxQyxJQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUNsQyxJQUFBLDRCQUE2RSxFQUEzRSxvQkFBbUIsRUFBbkIsd0NBQW1CLEVBQUUsMkJBQTBCLEVBQTFCLCtDQUFzRCxDQUFDO1FBQ3BGLElBQUksVUFBVSxFQUFFO1lBQ2QsSUFBSSxZQUFZLEtBQUssSUFBSSxFQUFFO2dCQUN6QixNQUFNLENBQUMsTUFBTSxHQUFHLFlBQVksQ0FBQztnQkFDN0IsT0FBTyxTQUFTLENBQUMsYUFBYSxFQUFFLENBQUMsUUFBUSxDQUFDLG1CQUFtQixFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQzthQUM5RTtTQUNGO1FBQ0QsT0FBTyxTQUFTLENBQUMsUUFBUSxDQUFDLG1CQUFtQixFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztJQUMvRCxDQUFDO0lBQ0Q7OztPQUdHO0lBQ0sseURBQWUsR0FBdkIsVUFBd0IsTUFBYztRQUNwQyxPQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUNEOzs7T0FHRztJQUNLLHlEQUFlLEdBQXZCLFVBQXdCLE1BQWM7UUFDcEMsT0FBTyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBQ0Q7O09BRUc7SUFDSywyREFBaUIsR0FBekI7UUFDRSxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDZixJQUFBLHNCQUFrRixFQUFoRiw4QkFBNkIsRUFBN0Isa0RBQTZCLEVBQUUsNEJBQTJCLEVBQTNCLGdEQUFpRCxDQUFDO1lBQ3pGLElBQU0sTUFBTSxHQUFRO2dCQUNsQixTQUFTLEVBQUUsQ0FBQzthQUNiLENBQUM7WUFDRixJQUFJLHNCQUFzQixLQUFLLElBQUksRUFBRTtnQkFDbkMsTUFBTSxDQUFDLGdCQUFnQixHQUFHLHNCQUFzQixDQUFDO2FBQ2xEO1lBQ0QsSUFBSSxvQkFBb0IsS0FBSyxJQUFJLEVBQUU7Z0JBQ2pDLE1BQU0sQ0FBQyxjQUFjLEdBQUcsb0JBQW9CLENBQUM7YUFDOUM7WUFDRCxPQUFPLE1BQU0sQ0FBQztTQUNmO0lBQ0gsQ0FBQztJQUNELHNCQUFZLHlEQUFZO2FBQXhCO1lBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQztRQUNyRSxDQUFDOzs7T0FBQTs7Z0JBN0lGLFNBQVMsU0FBQztvQkFDVCxRQUFRLEVBQUUsNEJBQTRCO2lCQUN2Qzs7OztnQkFSMkIsUUFBUTtnREFXTyxNQUFNLFNBQUMsaUJBQWlCO2dCQVAxRCxhQUFhOzs7K0JBTW5CLEtBQUssU0FBQyxjQUFjOztJQTBJdkIsc0NBQUM7Q0FBQSxBQTlJRCxJQThJQztTQTNJWSwrQkFBK0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIEluamVjdCwgSW5qZWN0b3IsIElucHV0LCBPbkluaXQgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBOdW1iZXJGb3JtYXQsIFVzZXJTZXR0aW5ncywgVXNlclNldHRpbmdzVG9rZW4gfSBmcm9tIFwiQGZhcnJpcy9kZXZraXRcIjtcclxuaW1wb3J0IHsgQmlnTnVtYmVyIH0gZnJvbSAnYmlnbnVtYmVyLmpzJztcclxuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQnO1xyXG5pbXBvcnQgeyBUZXh0Q29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS10ZXh0JztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW2ZhcnJpcy10ZXh0LWxvY2FsaXphdGlvbl0nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBGYXJyaXNUZXh0TG9jYWxpemF0aW9uRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0IHtcclxuICBASW5wdXQoJ2xvY2FsaXphdGlvbicpIGxvY2FsaXphdGlvbjogYm9vbGVhbjtcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgQEluamVjdChVc2VyU2V0dGluZ3NUb2tlbikgcHJpdmF0ZSB1c2VyU2V0dGluZ3M6IFVzZXJTZXR0aW5ncywgcHJpdmF0ZSBjb21wb25lbnRSZWY6IFRleHRDb21wb25lbnQpIHtcclxuICAgIHRoaXMudHJhbnNmb3JtKCk7XHJcbiAgfVxyXG4gIHB1YmxpYyBuZ09uSW5pdCgpIHtcclxuICB9XHJcbiAgcHJpdmF0ZSB0cmFuc2Zvcm0oKSB7XHJcbiAgICBpZiAodGhpcy5jb21wb25lbnRSZWYpIHtcclxuICAgICAgdGhpcy5jb21wb25lbnRSZWYuYmVmb3JlV3JpdGVWYWx1ZSA9ICh2YWx1ZTogYW55LCBvcHRpb25zOiBhbnkpID0+IHtcclxuICAgICAgICBsZXQgeyBsb2NhbGl6YXRpb25UeXBlID0gbnVsbCwgc2hvd1RpbWUgPSBmYWxzZSB9ID0gb3B0aW9ucztcclxuICAgICAgICBpZiAoIXZhbHVlKSB7XHJcbiAgICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChsb2NhbGl6YXRpb25UeXBlICYmIHZhbHVlKSB7XHJcbiAgICAgICAgICBsb2NhbGl6YXRpb25UeXBlID0gbG9jYWxpemF0aW9uVHlwZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgdmFsdWUgPSB0aGlzLnRyYW5zZm9ybVZhbHVlKHZhbHVlLCBsb2NhbGl6YXRpb25UeXBlKTtcclxuICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgdHJhbnNmb3JtVmFsdWUodmFsdWU6IGFueSwgZGF0YVR5cGU6IHN0cmluZykge1xyXG4gICAgaWYgKGRhdGFUeXBlID09PSAnZGF0ZScpIHtcclxuICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtRGF0ZSh2YWx1ZSk7XHJcbiAgICB9IGVsc2UgaWYgKGRhdGFUeXBlID09PSAnZGF0ZXRpbWUnKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnRyYW5zZm9ybURhdGVUaW1lKHZhbHVlKTtcclxuICAgIH1cclxuICAgIC8vIOa2ieWPiumHkemineiuoeeul+WPiuaYvuekuumXrumimO+8jOS4jeS6iOWkhOeQhlxyXG4gICAgLy8gIGVsc2UgaWYgKGRhdGFUeXBlID09PSAnbnVtYmVyJykge1xyXG4gICAgLy8gICByZXR1cm4gdGhpcy50cmFuc2Zvcm1OdW1iZXIodmFsdWUpO1xyXG4gICAgLy8gfSBcclxuICAgIGVsc2Uge1xyXG4gICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOi9rOaNouaXpeacn1xyXG4gICAqIEBwYXJhbSB2YWx1ZSB2YWx1ZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgdHJhbnNmb3JtRGF0ZSh2YWx1ZTogYW55KSB7XHJcbiAgICBsZXQgZGF0ZUZvcm1hdCA9IHRoaXMudXNlclNldHRpbmdzICYmIHRoaXMudXNlclNldHRpbmdzLmRhdGVGb3JtYXQgfHwgJ1lZWVktTU0tREQnO1xyXG4gICAgaWYgKCFkYXRlRm9ybWF0IHx8ICF2YWx1ZSkge1xyXG4gICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcbiAgICBjb25zdCBkYXRlID0gbW9tZW50KHZhbHVlKTtcclxuICAgIGNvbnN0IGlzVmFsaWQgPSBkYXRlLmlzVmFsaWQoKTtcclxuICAgIGlmICghaXNWYWxpZCkge1xyXG4gICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcbiAgICBkYXRlRm9ybWF0ID0gdGhpcy5wYXJzZURhdGVGb3JtYXQoZGF0ZUZvcm1hdCk7XHJcbiAgICByZXR1cm4gZGF0ZS5mb3JtYXQoZGF0ZUZvcm1hdCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOi9rOaNouaXpeacn+aXtumXtFxyXG4gICAqIEBwYXJhbSB2YWx1ZSB2YWx1ZVxyXG4gICAqIHRvZG86IOebruWJjeaXoOazleWumuS5ieaXpeacn+aXtumXtOagvOW8j1xyXG4gICAqL1xyXG4gIHByaXZhdGUgdHJhbnNmb3JtRGF0ZVRpbWUodmFsdWU6IGFueSkge1xyXG4gICAgbGV0IGRhdGVGb3JtYXQgPSB0aGlzLnVzZXJTZXR0aW5ncyAmJiB0aGlzLnVzZXJTZXR0aW5ncy5kYXRlRm9ybWF0IHx8ICdZWVlZLU1NLUREJztcclxuICAgIGxldCB0aW1lRm9ybWF0ID0gdGhpcy51c2VyU2V0dGluZ3MgJiYgdGhpcy51c2VyU2V0dGluZ3MudGltZUZvcm1hdCB8fCAnSEg6bW06c3MnO1xyXG4gICAgaWYgKCFkYXRlRm9ybWF0IHx8ICF0aW1lRm9ybWF0KSB7XHJcbiAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuICAgIGNvbnN0IGRhdGVUaW1lID0gbW9tZW50KHZhbHVlKTtcclxuICAgIGNvbnN0IGlzVmFsaWQgPSBkYXRlVGltZS5pc1ZhbGlkKCk7XHJcbiAgICBpZiAoIWlzVmFsaWQpIHtcclxuICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG4gICAgaWYgKGRhdGVGb3JtYXQpIHtcclxuICAgICAgZGF0ZUZvcm1hdCA9IHRoaXMucGFyc2VEYXRlRm9ybWF0KGRhdGVGb3JtYXQpO1xyXG4gICAgfVxyXG4gICAgaWYgKHRpbWVGb3JtYXQpIHtcclxuICAgICAgdGltZUZvcm1hdCA9IHRoaXMucGFyc2VUaW1lRm9ybWF0KHRpbWVGb3JtYXQpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZGF0ZVRpbWVGb3JtYXQgPSBkYXRlRm9ybWF0ICsgJyAnICsgdGltZUZvcm1hdDtcclxuICAgIHJldHVybiBkYXRlVGltZS5mb3JtYXQoZGF0ZVRpbWVGb3JtYXQpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDovazmjaLmlbDlrZdcclxuICAgKiBAcGFyYW0gdmFsdWUgdmFsdWVcclxuICAgKi9cclxuICBwcml2YXRlIHRyYW5zZm9ybU51bWJlcih2YWx1ZSk6IHN0cmluZyB7XHJcbiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gJycpIHtcclxuICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG4gICAgY29uc3QgYmlnTnVtYmVyID0gbmV3IEJpZ051bWJlcih2YWx1ZSk7XHJcbiAgICAvLyDlpoLmnpzkuI3mmK/mlbDlrZfvvIzkuI3lgZrku7vkvZXlpITnkIZcclxuICAgIGlmICghQmlnTnVtYmVyLmlzQmlnTnVtYmVyKGJpZ051bWJlcikpIHtcclxuICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG4gICAgY29uc3QgaXNOZWdhdGl2ZSA9IGJpZ051bWJlci5pc05lZ2F0aXZlKCk7XHJcbiAgICBjb25zdCBmb3JtYXQgPSB0aGlzLmJ1aWxkTnVtYmVyRm9ybWF0KCk7XHJcbiAgICBjb25zdCB7IG5lZ2F0aXZlU2lnbiA9IG51bGwsIG51bWJlckRlY2ltYWxEaWdpdHMgPSBudWxsIH0gPSB0aGlzLm51bWJlckZvcm1hdCB8fCB7fTtcclxuICAgIGlmIChpc05lZ2F0aXZlKSB7XHJcbiAgICAgIGlmIChuZWdhdGl2ZVNpZ24gIT09IG51bGwpIHtcclxuICAgICAgICBmb3JtYXQucHJlZml4ID0gbmVnYXRpdmVTaWduO1xyXG4gICAgICAgIHJldHVybiBiaWdOdW1iZXIuYWJzb2x1dGVWYWx1ZSgpLnRvRm9ybWF0KG51bWJlckRlY2ltYWxEaWdpdHMsIG51bGwsIGZvcm1hdCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBiaWdOdW1iZXIudG9Gb3JtYXQobnVtYmVyRGVjaW1hbERpZ2l0cywgbnVsbCwgZm9ybWF0KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6L2s5o2i5pel5pyf5qC85byP6KeE5YiZ5Li6bW9tZW5055qEZm9ybWF06KeE5YiZXHJcbiAgICogQHBhcmFtIGZvcm1hdCBmb3JtYXRcclxuICAgKi9cclxuICBwcml2YXRlIHBhcnNlRGF0ZUZvcm1hdChmb3JtYXQ6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIGZvcm1hdC5yZXBsYWNlKC95L2csICdZJykucmVwbGFjZSgvZC9nLCAnRCcpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDovazmjaLml7bpl7TmoLzlvI/op4TliJnkuLptb21lbnTnmoRmb3JtYXTop4TliJlcclxuICAgKiBAcGFyYW0gZm9ybWF0IGZvcm1hdFxyXG4gICAqL1xyXG4gIHByaXZhdGUgcGFyc2VUaW1lRm9ybWF0KGZvcm1hdDogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gZm9ybWF0LnJlcGxhY2UoL00vZywgJ20nKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p6E6YCgYmlnbnVtYmVy5pWw5a2X5qC85byP5YyW6YCJ6aG5XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZE51bWJlckZvcm1hdCgpIHtcclxuICAgIGlmICh0aGlzLm51bWJlckZvcm1hdCkge1xyXG4gICAgICBjb25zdCB7IG51bWJlckRlY2ltYWxTZXBhcmF0b3IgPSBudWxsLCBudW1iZXJHcm91cFNlcGFyYXRvciA9IG51bGwgfSA9IHRoaXMubnVtYmVyRm9ybWF0O1xyXG4gICAgICBjb25zdCBmb3JtYXQ6IGFueSA9IHtcclxuICAgICAgICBncm91cFNpemU6IDMsXHJcbiAgICAgIH07XHJcbiAgICAgIGlmIChudW1iZXJEZWNpbWFsU2VwYXJhdG9yICE9PSBudWxsKSB7XHJcbiAgICAgICAgZm9ybWF0LmRlY2ltYWxTZXBhcmF0b3IgPSBudW1iZXJEZWNpbWFsU2VwYXJhdG9yO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChudW1iZXJHcm91cFNlcGFyYXRvciAhPT0gbnVsbCkge1xyXG4gICAgICAgIGZvcm1hdC5ncm91cFNlcGFyYXRvciA9IG51bWJlckdyb3VwU2VwYXJhdG9yO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBmb3JtYXQ7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0IG51bWJlckZvcm1hdCgpOiBOdW1iZXJGb3JtYXQge1xyXG4gICAgcmV0dXJuIHRoaXMudXNlclNldHRpbmdzICYmIHRoaXMudXNlclNldHRpbmdzLm51bWJlckZvcm1hdCB8fCBudWxsO1xyXG4gIH1cclxufSJdfQ==