import { Directive, HostListener, Injector, Input } from '@angular/core';
import { ChangeType, FrameContext } from '@farris/devkit';
import { AppointmentCalendarComponent } from '@farris/appointment-calendar';
import { ViewType } from './types';
import { isEqual } from 'lodash-es';
import { BasePathService } from '@farris/rtf';
var AppointmentCalendarBindingDirective = /** @class */ (function () {
    function AppointmentCalendarBindingDirective(injector, frameContext, calendarComponent) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.calendarComponent = calendarComponent;
        /**
         * 房间列表api url
         */
        this.url = null;
        /**
         * http method, default PUT
         */
        this.method = 'PUT';
        this.startDateVariable = 'startDate';
        this.endDateVariable = 'endDate';
        this.viewTypeVariable = 'viewType';
    }
    Object.defineProperty(AppointmentCalendarBindingDirective.prototype, "bindingData", {
        get: function () {
            return this.frameContext.bindingData;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AppointmentCalendarBindingDirective.prototype, "viewModel", {
        get: function () {
            return this.frameContext.viewModel;
        },
        enumerable: true,
        configurable: true
    });
    AppointmentCalendarBindingDirective.prototype.restService = function () {
        return this.frameContext.repository.restService;
    };
    Object.defineProperty(AppointmentCalendarBindingDirective.prototype, "bindingList", {
        /**
         * 获取绑定数据
         */
        get: function () {
            // 根实体
            if (this.viewModel.bindingPath === '/' || !this.viewModel.bindingPath) {
                return this.bindingData.list;
            }
            // 子实体
            var bindingPath = this.viewModel.bindingPath.substr(1);
            bindingPath = bindingPath[0].toLowerCase() + bindingPath.substring(1, bindingPath.length);
            var paths = bindingPath.split('/');
            var filteredPaths = paths.filter(function (part) {
                return part !== '';
            });
            return this.bindingData.getValue(filteredPaths);
        },
        enumerable: true,
        configurable: true
    });
    AppointmentCalendarBindingDirective.prototype.ngOnInit = function () {
        this.loadPlacements();
        this.registerBindingDataChangeEvent();
    };
    AppointmentCalendarBindingDirective.prototype.ngOnChanges = function (changes) {
    };
    AppointmentCalendarBindingDirective.prototype.ngOnDestroy = function () {
        this.unRegisterBindingDataChangeEvent();
    };
    AppointmentCalendarBindingDirective.prototype.bindData = function (change) {
        // 再toJSON
        var data = this.bindingList.toJSON();
        if (this.__DATA__ && isEqual(this.__DATA__, data)) {
            return;
        }
        this.__DATA__ = data;
        this.calendarComponent.loadReserveData(data);
    };
    AppointmentCalendarBindingDirective.prototype.onBindingDataChange = function (change) {
        this.bindData(change);
        this.updateSelectedRow(change);
    };
    AppointmentCalendarBindingDirective.prototype.registerBindingDataChangeEvent = function () {
        var _this = this;
        this.bindingDataChangeEvent = this.bindingData.changes.subscribe(function (change) {
            _this.onBindingDataChange(change);
        });
    };
    /**
     * 取消bindingdata变化订阅
     */
    AppointmentCalendarBindingDirective.prototype.unRegisterBindingDataChangeEvent = function () {
        if (this.bindingDataChangeEvent && typeof (this.bindingDataChangeEvent.unsubscribe) === 'function') {
            this.bindingDataChangeEvent.unsubscribe();
        }
    };
    AppointmentCalendarBindingDirective.prototype.loadPlacements = function () {
        var _this = this;
        if (!this.url) {
            console.log('无法加载房间信息，请配置房间列表api地址');
            return;
        }
        var requestInfo = this.restService().buildRequestInfo();
        var options = {
            body: {
                requestInfo: requestInfo
            }
        };
        var url = BasePathService.convertPath(this.url);
        this.restService().request(url, this.method, null, options).subscribe(function (returnValue) {
            _this.bindPlacements(returnValue);
        });
    };
    AppointmentCalendarBindingDirective.prototype.bindPlacements = function (placments) {
        this.calendarComponent.loadPlaceData(placments);
    };
    AppointmentCalendarBindingDirective.prototype.updateState = function (startDate, endDate, viewType) {
        this.viewModel.uiState.setPropertyValue(this.startDateVariable, startDate);
        this.viewModel.uiState.setPropertyValue(this.endDateVariable, endDate);
        this.viewModel.uiState.setPropertyValue(this.viewTypeVariable, viewType);
    };
    AppointmentCalendarBindingDirective.prototype.updateSelectedRow = function (change) {
        if (!this.bindingList || !this.bindingList.currentId) {
            return;
        }
        // 页码切换时不执行当前行切换
        if (change && change.type === ChangeType.PaginationInfoChange) {
            return;
        }
        if (this.viewModel && this.viewModel.frameContext.bindingData.rowSelectedEventSuspend === true) {
            return;
        }
        var id = this.calendarComponent.selectedId;
        var currentId = this.bindingList.currentId;
        // grid当前行与bingingList当前行一致，无须切换
        if (id === currentId) {
            return;
        }
        this.selectCalendarRow(this.bindingList.currentId);
    };
    AppointmentCalendarBindingDirective.prototype.selectCalendarRow = function (id) {
        this.calendarComponent.selectItem(id);
    };
    AppointmentCalendarBindingDirective.prototype.filterChanged = function (event) {
        var _a = event || {}, _b = _a.dateValue, dateValue = _b === void 0 ? null : _b, _c = _a.place, place = _c === void 0 ? null : _c, _d = _a.viewType, viewType = _d === void 0 ? null : _d;
        var startDate = null;
        var endDate = null;
        if (!dateValue) {
            return;
        }
        if (viewType === ViewType.day) {
            startDate = dateValue + " 00:00:00";
            endDate = dateValue + " 23:59:59";
        }
        else if (viewType === ViewType.week && dateValue.indexOf('~') !== -1) {
            var sections = dateValue.split('~');
            startDate = sections[0] + " 00:00:00";
            endDate = sections[1] + " 23:59:59";
        }
        this.updateState(startDate, endDate, viewType);
    };
    AppointmentCalendarBindingDirective.prototype.setSelectionIdToBindingData = function (id) {
        // 如果当前行不存在，则强制设置
        if (this.bindingList.currentId !== id) {
            this.bindingList.setCurrentId(id, true);
        }
    };
    AppointmentCalendarBindingDirective.prototype.selectChange = function (event) {
        var _a = event.item.id, id = _a === void 0 ? null : _a;
        this.setSelectionIdToBindingData(id);
    };
    AppointmentCalendarBindingDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[farris-appointment-calendar-binding]'
                },] }
    ];
    /** @nocollapse */
    AppointmentCalendarBindingDirective.ctorParameters = function () { return [
        { type: Injector },
        { type: FrameContext },
        { type: AppointmentCalendarComponent }
    ]; };
    AppointmentCalendarBindingDirective.propDecorators = {
        url: [{ type: Input }],
        method: [{ type: Input }],
        startDateVariable: [{ type: Input }],
        endDateVariable: [{ type: Input }],
        viewTypeVariable: [{ type: Input }],
        filterChanged: [{ type: HostListener, args: ['filterChange', ['$event'],] }],
        selectChange: [{ type: HostListener, args: ['selectChange', ['$event'],] }]
    };
    return AppointmentCalendarBindingDirective;
}());
export { AppointmentCalendarBindingDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwb2ludG1lbnQtY2FsZW5kYXItYmluZGluZy5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2tlbmRvLWJpbmRpbmcvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy9hcHBvaW50bWVudC1jYWxlbmRhci9hcHBvaW50bWVudC1jYWxlbmRhci1iaW5kaW5nLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUErQyxZQUFZLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFDdEYsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFvQyxVQUFVLEVBQWEsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkcsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDNUUsT0FBTyxFQUFpQyxRQUFRLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDbEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNwQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRTlDO0lBNkNFLDZDQUFvQixRQUFrQixFQUFVLFlBQTBCLEVBQVUsaUJBQStDO1FBQS9HLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUFVLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBOEI7UUFabkk7O1dBRUc7UUFDTSxRQUFHLEdBQVcsSUFBSSxDQUFDO1FBQzVCOztXQUVHO1FBQ00sV0FBTSxHQUFXLEtBQUssQ0FBQztRQUN2QixzQkFBaUIsR0FBVyxXQUFXLENBQUM7UUFDeEMsb0JBQWUsR0FBVyxTQUFTLENBQUM7UUFDcEMscUJBQWdCLEdBQVcsVUFBVSxDQUFDO0lBRXdGLENBQUM7SUF2Q3hJLHNCQUFZLDREQUFXO2FBQXZCO1lBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQztRQUN2QyxDQUFDOzs7T0FBQTtJQUNELHNCQUFZLDBEQUFTO2FBQXJCO1lBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQztRQUNyQyxDQUFDOzs7T0FBQTtJQUNPLHlEQUFXLEdBQW5CO1FBQ0UsT0FBUSxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQTRCLENBQUMsV0FBVyxDQUFDO0lBQ3JFLENBQUM7SUFJRCxzQkFBYyw0REFBVztRQUh6Qjs7V0FFRzthQUNIO1lBQ0UsTUFBTTtZQUNOLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUU7Z0JBQ3JFLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUM7YUFDOUI7WUFDRCxNQUFNO1lBQ04sSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZELFdBQVcsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLEdBQUcsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzFGLElBQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFckMsSUFBTSxhQUFhLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFDLElBQVk7Z0JBQzlDLE9BQU8sSUFBSSxLQUFLLEVBQUUsQ0FBQztZQUNyQixDQUFDLENBQUMsQ0FBQztZQUNILE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDbEQsQ0FBQzs7O09BQUE7SUFlRCxzREFBUSxHQUFSO1FBQ0UsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyw4QkFBOEIsRUFBRSxDQUFDO0lBQ3hDLENBQUM7SUFDRCx5REFBVyxHQUFYLFVBQVksT0FBc0I7SUFFbEMsQ0FBQztJQUNELHlEQUFXLEdBQVg7UUFDRSxJQUFJLENBQUMsZ0NBQWdDLEVBQUUsQ0FBQztJQUMxQyxDQUFDO0lBQ08sc0RBQVEsR0FBaEIsVUFBaUIsTUFBYztRQUM3QixVQUFVO1FBQ1YsSUFBSSxJQUFJLEdBQVEsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUMxQyxJQUFJLElBQUksQ0FBQyxRQUFRLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLEVBQUU7WUFDakQsT0FBTztTQUNSO1FBQ0QsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDckIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBQ08saUVBQW1CLEdBQTNCLFVBQTRCLE1BQWM7UUFDeEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUNPLDRFQUE4QixHQUF0QztRQUFBLGlCQUlDO1FBSEMsSUFBSSxDQUFDLHNCQUFzQixHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxVQUFDLE1BQWM7WUFDOUUsS0FBSSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ25DLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNEOztPQUVHO0lBQ0ssOEVBQWdDLEdBQXhDO1FBQ0UsSUFBSSxJQUFJLENBQUMsc0JBQXNCLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxXQUFXLENBQUMsS0FBSyxVQUFVLEVBQUU7WUFDbEcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQzNDO0lBQ0gsQ0FBQztJQUNPLDREQUFjLEdBQXRCO1FBQUEsaUJBZUM7UUFkQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUNiLE9BQU8sQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsQ0FBQztZQUNyQyxPQUFPO1NBQ1I7UUFDRCxJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUMxRCxJQUFNLE9BQU8sR0FBRztZQUNkLElBQUksRUFBRTtnQkFDSixXQUFXLGFBQUE7YUFDWjtTQUNGLENBQUM7UUFDRixJQUFNLEdBQUcsR0FBRyxlQUFlLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsRCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBQyxXQUFnQjtZQUNyRixLQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ25DLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNPLDREQUFjLEdBQXRCLFVBQXVCLFNBQWM7UUFDbkMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBQ08seURBQVcsR0FBbkIsVUFBb0IsU0FBaUIsRUFBRSxPQUFlLEVBQUUsUUFBZ0I7UUFDdEUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQzNFLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDdkUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzNFLENBQUM7SUFDTywrREFBaUIsR0FBekIsVUFBMEIsTUFBZTtRQUN2QyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFO1lBQ3BELE9BQU87U0FDUjtRQUNELGdCQUFnQjtRQUNoQixJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxvQkFBb0IsRUFBRTtZQUM3RCxPQUFPO1NBQ1I7UUFDRCxJQUFJLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLHVCQUF1QixLQUFLLElBQUksRUFBRTtZQUM5RixPQUFPO1NBQ1I7UUFDRCxJQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsVUFBVSxDQUFDO1FBQzdDLElBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDO1FBQzdDLGdDQUFnQztRQUNoQyxJQUFJLEVBQUUsS0FBSyxTQUFTLEVBQUU7WUFDcEIsT0FBTztTQUNSO1FBQ0QsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUNPLCtEQUFpQixHQUF6QixVQUEwQixFQUFVO1FBQ2xDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVNLDJEQUFhLEdBRHBCLFVBQ3FCLEtBQVU7UUFDdkIsSUFBQSxnQkFBaUUsRUFBL0QsaUJBQWdCLEVBQWhCLHFDQUFnQixFQUFFLGFBQVksRUFBWixpQ0FBWSxFQUFFLGdCQUFlLEVBQWYsb0NBQStCLENBQUM7UUFDeEUsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQztRQUNuQixJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2QsT0FBTztTQUNSO1FBQ0QsSUFBSSxRQUFRLEtBQUssUUFBUSxDQUFDLEdBQUcsRUFBRTtZQUM3QixTQUFTLEdBQU0sU0FBUyxjQUFXLENBQUM7WUFDcEMsT0FBTyxHQUFNLFNBQVMsY0FBVyxDQUFDO1NBQ25DO2FBQU0sSUFBSSxRQUFRLEtBQUssUUFBUSxDQUFDLElBQUksSUFBSSxTQUFTLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO1lBQ3RFLElBQU0sUUFBUSxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdEMsU0FBUyxHQUFNLFFBQVEsQ0FBQyxDQUFDLENBQUMsY0FBVyxDQUFDO1lBQ3RDLE9BQU8sR0FBTSxRQUFRLENBQUMsQ0FBQyxDQUFDLGNBQVcsQ0FBQztTQUNyQztRQUNELElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBQ1MseUVBQTJCLEdBQXJDLFVBQXNDLEVBQVU7UUFDOUMsaUJBQWlCO1FBQ2pCLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLEtBQUssRUFBRSxFQUFFO1lBQ3JDLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztTQUN6QztJQUNILENBQUM7SUFFTSwwREFBWSxHQURuQixVQUNvQixLQUFLO1FBQ1AsSUFBQSxrQkFBUyxFQUFULDhCQUFTLENBQWE7UUFDdEMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7O2dCQTdKRixTQUFTLFNBQUM7b0JBQ1QsUUFBUSxFQUFFLHVDQUF1QztpQkFDbEQ7Ozs7Z0JBWHVFLFFBQVE7Z0JBR2QsWUFBWTtnQkFDckUsNEJBQTRCOzs7c0JBeUNsQyxLQUFLO3lCQUlMLEtBQUs7b0NBQ0wsS0FBSztrQ0FDTCxLQUFLO21DQUNMLEtBQUs7Z0NBc0ZMLFlBQVksU0FBQyxjQUFjLEVBQUUsQ0FBQyxRQUFRLENBQUM7K0JBd0J2QyxZQUFZLFNBQUMsY0FBYyxFQUFFLENBQUMsUUFBUSxDQUFDOztJQUsxQywwQ0FBQztDQUFBLEFBOUpELElBOEpDO1NBM0pZLG1DQUFtQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgRGlyZWN0aXZlLCBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95LCBTaW1wbGVDaGFuZ2VzLCBIb3N0TGlzdGVuZXIsIEluamVjdG9yLCBJbnB1dFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgQmluZGluZ0RhdGEsIEJpbmRpbmdMaXN0LCBDaGFuZ2UsIENoYW5nZVR5cGUsIFZpZXdNb2RlbCwgRnJhbWVDb250ZXh0IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBBcHBvaW50bWVudENhbGVuZGFyQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy9hcHBvaW50bWVudC1jYWxlbmRhcic7XHJcbmltcG9ydCB7IEJlZlJlc3RTZXJ2aWNlLCBCZWZSZXBvc2l0b3J5LCBWaWV3VHlwZSB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBpc0VxdWFsIH0gZnJvbSAnbG9kYXNoLWVzJztcclxuaW1wb3J0IHsgQmFzZVBhdGhTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy9ydGYnO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgc2VsZWN0b3I6ICdbZmFycmlzLWFwcG9pbnRtZW50LWNhbGVuZGFyLWJpbmRpbmddJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgQXBwb2ludG1lbnRDYWxlbmRhckJpbmRpbmdEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcclxuICBwcml2YXRlIF9fREFUQV9fOiBhbnk7XHJcbiAgcHJpdmF0ZSBiaW5kaW5nRGF0YUNoYW5nZUV2ZW50OiBTdWJzY3JpcHRpb247XHJcbiAgcHJpdmF0ZSBnZXQgYmluZGluZ0RhdGEoKTogQmluZGluZ0RhdGEge1xyXG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhO1xyXG4gIH1cclxuICBwcml2YXRlIGdldCB2aWV3TW9kZWwoKTogVmlld01vZGVsIHtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWw7XHJcbiAgfVxyXG4gIHByaXZhdGUgcmVzdFNlcnZpY2UoKTogQmVmUmVzdFNlcnZpY2Uge1xyXG4gICAgcmV0dXJuICh0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnkpLnJlc3RTZXJ2aWNlO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bnu5HlrprmlbDmja5cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0IGJpbmRpbmdMaXN0KCk6IEJpbmRpbmdMaXN0IHtcclxuICAgIC8vIOagueWunuS9k1xyXG4gICAgaWYgKHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoID09PSAnLycgfHwgIXRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmJpbmRpbmdEYXRhLmxpc3Q7XHJcbiAgICB9XHJcbiAgICAvLyDlrZDlrp7kvZNcclxuICAgIGxldCBiaW5kaW5nUGF0aCA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoLnN1YnN0cigxKTtcclxuICAgIGJpbmRpbmdQYXRoID0gYmluZGluZ1BhdGhbMF0udG9Mb3dlckNhc2UoKSArIGJpbmRpbmdQYXRoLnN1YnN0cmluZygxLCBiaW5kaW5nUGF0aC5sZW5ndGgpO1xyXG4gICAgY29uc3QgcGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpO1xyXG5cclxuICAgIGNvbnN0IGZpbHRlcmVkUGF0aHMgPSBwYXRocy5maWx0ZXIoKHBhcnQ6IHN0cmluZykgPT4ge1xyXG4gICAgICByZXR1cm4gcGFydCAhPT0gJyc7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0aGlzLmJpbmRpbmdEYXRhLmdldFZhbHVlKGZpbHRlcmVkUGF0aHMpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmiL/pl7TliJfooahhcGkgdXJsXHJcbiAgICovXHJcbiAgQElucHV0KCkgdXJsOiBzdHJpbmcgPSBudWxsO1xyXG4gIC8qKlxyXG4gICAqIGh0dHAgbWV0aG9kLCBkZWZhdWx0IFBVVFxyXG4gICAqL1xyXG4gIEBJbnB1dCgpIG1ldGhvZDogc3RyaW5nID0gJ1BVVCc7XHJcbiAgQElucHV0KCkgc3RhcnREYXRlVmFyaWFibGU6IHN0cmluZyA9ICdzdGFydERhdGUnO1xyXG4gIEBJbnB1dCgpIGVuZERhdGVWYXJpYWJsZTogc3RyaW5nID0gJ2VuZERhdGUnO1xyXG4gIEBJbnB1dCgpIHZpZXdUeXBlVmFyaWFibGU6IHN0cmluZyA9ICd2aWV3VHlwZSc7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBwcml2YXRlIGNhbGVuZGFyQ29tcG9uZW50OiBBcHBvaW50bWVudENhbGVuZGFyQ29tcG9uZW50KSB7IH1cclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLmxvYWRQbGFjZW1lbnRzKCk7XHJcbiAgICB0aGlzLnJlZ2lzdGVyQmluZGluZ0RhdGFDaGFuZ2VFdmVudCgpO1xyXG4gIH1cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XHJcblxyXG4gIH1cclxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIHRoaXMudW5SZWdpc3RlckJpbmRpbmdEYXRhQ2hhbmdlRXZlbnQoKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBiaW5kRGF0YShjaGFuZ2U6IENoYW5nZSkge1xyXG4gICAgLy8g5YaNdG9KU09OXHJcbiAgICBsZXQgZGF0YTogYW55ID0gdGhpcy5iaW5kaW5nTGlzdC50b0pTT04oKTtcclxuICAgIGlmICh0aGlzLl9fREFUQV9fICYmIGlzRXF1YWwodGhpcy5fX0RBVEFfXywgZGF0YSkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5fX0RBVEFfXyA9IGRhdGE7XHJcbiAgICB0aGlzLmNhbGVuZGFyQ29tcG9uZW50LmxvYWRSZXNlcnZlRGF0YShkYXRhKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBvbkJpbmRpbmdEYXRhQ2hhbmdlKGNoYW5nZTogQ2hhbmdlKSB7XHJcbiAgICB0aGlzLmJpbmREYXRhKGNoYW5nZSk7XHJcbiAgICB0aGlzLnVwZGF0ZVNlbGVjdGVkUm93KGNoYW5nZSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgcmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCkge1xyXG4gICAgdGhpcy5iaW5kaW5nRGF0YUNoYW5nZUV2ZW50ID0gdGhpcy5iaW5kaW5nRGF0YS5jaGFuZ2VzLnN1YnNjcmliZSgoY2hhbmdlOiBDaGFuZ2UpID0+IHtcclxuICAgICAgdGhpcy5vbkJpbmRpbmdEYXRhQ2hhbmdlKGNoYW5nZSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Y+W5raIYmluZGluZ2RhdGHlj5jljJborqLpmIVcclxuICAgKi9cclxuICBwcml2YXRlIHVuUmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCkge1xyXG4gICAgaWYgKHRoaXMuYmluZGluZ0RhdGFDaGFuZ2VFdmVudCAmJiB0eXBlb2YgKHRoaXMuYmluZGluZ0RhdGFDaGFuZ2VFdmVudC51bnN1YnNjcmliZSkgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5iaW5kaW5nRGF0YUNoYW5nZUV2ZW50LnVuc3Vic2NyaWJlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgbG9hZFBsYWNlbWVudHMoKSB7XHJcbiAgICBpZiAoIXRoaXMudXJsKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCfml6Dms5XliqDovb3miL/pl7Tkv6Hmga/vvIzor7fphY3nva7miL/pl7TliJfooahhcGnlnLDlnYAnKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcmVxdWVzdEluZm8gPSB0aGlzLnJlc3RTZXJ2aWNlKCkuYnVpbGRSZXF1ZXN0SW5mbygpO1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgYm9keToge1xyXG4gICAgICAgIHJlcXVlc3RJbmZvXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICBjb25zdCB1cmwgPSBCYXNlUGF0aFNlcnZpY2UuY29udmVydFBhdGgodGhpcy51cmwpO1xyXG4gICAgdGhpcy5yZXN0U2VydmljZSgpLnJlcXVlc3QodXJsLCB0aGlzLm1ldGhvZCwgbnVsbCwgb3B0aW9ucykuc3Vic2NyaWJlKChyZXR1cm5WYWx1ZTogYW55KSA9PiB7XHJcbiAgICAgIHRoaXMuYmluZFBsYWNlbWVudHMocmV0dXJuVmFsdWUpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgYmluZFBsYWNlbWVudHMocGxhY21lbnRzOiBhbnkpIHtcclxuICAgIHRoaXMuY2FsZW5kYXJDb21wb25lbnQubG9hZFBsYWNlRGF0YShwbGFjbWVudHMpO1xyXG4gIH1cclxuICBwcml2YXRlIHVwZGF0ZVN0YXRlKHN0YXJ0RGF0ZTogc3RyaW5nLCBlbmREYXRlOiBzdHJpbmcsIHZpZXdUeXBlOiBzdHJpbmcpIHtcclxuICAgIHRoaXMudmlld01vZGVsLnVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZSh0aGlzLnN0YXJ0RGF0ZVZhcmlhYmxlLCBzdGFydERhdGUpO1xyXG4gICAgdGhpcy52aWV3TW9kZWwudWlTdGF0ZS5zZXRQcm9wZXJ0eVZhbHVlKHRoaXMuZW5kRGF0ZVZhcmlhYmxlLCBlbmREYXRlKTtcclxuICAgIHRoaXMudmlld01vZGVsLnVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZSh0aGlzLnZpZXdUeXBlVmFyaWFibGUsIHZpZXdUeXBlKTtcclxuICB9XHJcbiAgcHJpdmF0ZSB1cGRhdGVTZWxlY3RlZFJvdyhjaGFuZ2U/OiBDaGFuZ2UpIHtcclxuICAgIGlmICghdGhpcy5iaW5kaW5nTGlzdCB8fCAhdGhpcy5iaW5kaW5nTGlzdC5jdXJyZW50SWQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgLy8g6aG156CB5YiH5o2i5pe25LiN5omn6KGM5b2T5YmN6KGM5YiH5o2iXHJcbiAgICBpZiAoY2hhbmdlICYmIGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlBhZ2luYXRpb25JbmZvQ2hhbmdlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLnZpZXdNb2RlbCAmJiB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEucm93U2VsZWN0ZWRFdmVudFN1c3BlbmQgPT09IHRydWUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgaWQgPSB0aGlzLmNhbGVuZGFyQ29tcG9uZW50LnNlbGVjdGVkSWQ7XHJcbiAgICBjb25zdCBjdXJyZW50SWQgPSB0aGlzLmJpbmRpbmdMaXN0LmN1cnJlbnRJZDtcclxuICAgIC8vIGdyaWTlvZPliY3ooYzkuI5iaW5naW5nTGlzdOW9k+WJjeihjOS4gOiHtO+8jOaXoOmhu+WIh+aNolxyXG4gICAgaWYgKGlkID09PSBjdXJyZW50SWQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zZWxlY3RDYWxlbmRhclJvdyh0aGlzLmJpbmRpbmdMaXN0LmN1cnJlbnRJZCk7XHJcbiAgfVxyXG4gIHByaXZhdGUgc2VsZWN0Q2FsZW5kYXJSb3coaWQ6IHN0cmluZykge1xyXG4gICAgdGhpcy5jYWxlbmRhckNvbXBvbmVudC5zZWxlY3RJdGVtKGlkKTtcclxuICB9XHJcbiAgQEhvc3RMaXN0ZW5lcignZmlsdGVyQ2hhbmdlJywgWyckZXZlbnQnXSlcclxuICBwdWJsaWMgZmlsdGVyQ2hhbmdlZChldmVudDogYW55KSB7XHJcbiAgICBjb25zdCB7IGRhdGVWYWx1ZSA9IG51bGwsIHBsYWNlID0gbnVsbCwgdmlld1R5cGUgPSBudWxsIH0gPSBldmVudCB8fCB7fTtcclxuICAgIGxldCBzdGFydERhdGUgPSBudWxsO1xyXG4gICAgbGV0IGVuZERhdGUgPSBudWxsO1xyXG4gICAgaWYgKCFkYXRlVmFsdWUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKHZpZXdUeXBlID09PSBWaWV3VHlwZS5kYXkpIHtcclxuICAgICAgc3RhcnREYXRlID0gYCR7ZGF0ZVZhbHVlfSAwMDowMDowMGA7XHJcbiAgICAgIGVuZERhdGUgPSBgJHtkYXRlVmFsdWV9IDIzOjU5OjU5YDtcclxuICAgIH0gZWxzZSBpZiAodmlld1R5cGUgPT09IFZpZXdUeXBlLndlZWsgJiYgZGF0ZVZhbHVlLmluZGV4T2YoJ34nKSAhPT0gLTEpIHtcclxuICAgICAgY29uc3Qgc2VjdGlvbnMgPSBkYXRlVmFsdWUuc3BsaXQoJ34nKTtcclxuICAgICAgc3RhcnREYXRlID0gYCR7c2VjdGlvbnNbMF19IDAwOjAwOjAwYDtcclxuICAgICAgZW5kRGF0ZSA9IGAke3NlY3Rpb25zWzFdfSAyMzo1OTo1OWA7XHJcbiAgICB9XHJcbiAgICB0aGlzLnVwZGF0ZVN0YXRlKHN0YXJ0RGF0ZSwgZW5kRGF0ZSwgdmlld1R5cGUpO1xyXG4gIH1cclxuICBwcm90ZWN0ZWQgc2V0U2VsZWN0aW9uSWRUb0JpbmRpbmdEYXRhKGlkOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIC8vIOWmguaenOW9k+WJjeihjOS4jeWtmOWcqO+8jOWImeW8uuWItuiuvue9rlxyXG4gICAgaWYgKHRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkICE9PSBpZCkge1xyXG4gICAgICB0aGlzLmJpbmRpbmdMaXN0LnNldEN1cnJlbnRJZChpZCwgdHJ1ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIEBIb3N0TGlzdGVuZXIoJ3NlbGVjdENoYW5nZScsIFsnJGV2ZW50J10pXHJcbiAgcHVibGljIHNlbGVjdENoYW5nZShldmVudCkge1xyXG4gICAgY29uc3QgeyBpdGVtOiB7IGlkID0gbnVsbCB9IH0gPSBldmVudDtcclxuICAgIHRoaXMuc2V0U2VsZWN0aW9uSWRUb0JpbmRpbmdEYXRhKGlkKTtcclxuICB9XHJcbn1cclxuIl19