import * as tslib_1 from "tslib";
import { Directive, Input, Self, Host, Optional, Output, EventEmitter } from '@angular/core';
import { MultiSelectComponent } from '@farris/ui-multi-select';
import { ViewModel } from '@farris/devkit';
var MultiSelectDataMappingDirective = /** @class */ (function () {
    function MultiSelectDataMappingDirective(vm, multiSelectComponent) {
        var _this_1 = this;
        this.vm = vm;
        this.multiSelectComponent = multiSelectComponent;
        this.selectedIdChanged = new EventEmitter();
        this.vm.uiState.changes.subscribe(function (data) {
            _this_1.selectedId = data.value;
        });
    }
    MultiSelectDataMappingDirective.prototype.ngOnInit = function () {
        var _this_1 = this;
        this.multiSelectComponent.dataSource = [];
        if (Array.isArray(this.dataSource)) {
            this.multiSelectComponent.dataSource = this.dataSource;
            this.originalDataSource = this.dataSource;
        }
        else if (this.dataSource && this.dataSource.changes) {
            this.dataSource.changes.subscribe(function (data) {
                if (data.type === 'Load') {
                    _this_1.originalDataSource = data.value;
                    if (_this_1.multiSelectComponent.isTree()) {
                        if (_this_1.fjmField) {
                            // 分级码加载树结构
                            _this_1.multiSelectComponent.dataSource = _this_1.plainToTree(data.value, _this_1.fjmField, 1);
                        }
                        else if (_this_1.fjdField) {
                            // 父节点加载树结构
                            _this_1.multiSelectComponent.dataSource = _this_1.buildTreeNodesByFjd(data.value, _this_1.fjdField);
                        }
                        _this_1.multiSelectComponent.selections = _this_1.getTreeSelectionsById(_this_1.selectedId, _this_1.originalDataSource);
                    }
                    else {
                        _this_1.multiSelectComponent.dataSource = data.value;
                        _this_1.multiSelectComponent.selections = _this_1.getListSelectionsById(_this_1.selectedId, _this_1.multiSelectComponent.dataSource);
                    }
                }
            });
        }
        this.selectIdBindingToUIStateField();
    };
    MultiSelectDataMappingDirective.prototype.selectIdBindingToUIStateField = function () {
        var _this_1 = this;
        if (this.multiSelectComponent && this.multiSelectComponent.selectedIdChange) {
            this.multiSelectComponent.selectedIdChange.subscribe(function (data) {
                _this_1.selectedIdChanged.emit(data);
            });
        }
    };
    /**
     *
     * @param data 需要格式化的数据
     */
    MultiSelectDataMappingDirective.prototype.formatDataSource = function (data, field) {
        var _this_1 = this;
        if (!data || !data.length) {
            return [];
        }
        return data.map(function (item) {
            var _a;
            var n = item['toJSON'] ? item.toJSON() : item;
            return {
                data: Object.assign(tslib_1.__assign({}, n), (_a = {},
                    _a["" + _this_1.idField] = item[_this_1.idField],
                    _a["" + _this_1.textField] = item[_this_1.textField],
                    _a["" + _this_1.valueField] = item[_this_1.valueField],
                    _a["" + field] = item[field],
                    _a)),
                children: []
            };
        });
    };
    /**
     * 把平行结构的数据转换成树形结构
     * @param plainSource
     * @param field
     * @param layer
     */
    MultiSelectDataMappingDirective.prototype.plainToTree = function (plainSource, field, layer) {
        var treeSource = this.formatDataSource(plainSource, field);
        if (!treeSource.length) {
            return [];
        }
        if (!treeSource[0]['data'][field]) {
            return [];
        }
        var parents = treeSource.filter(function (item) {
            return item['data'][field]['layer'] === layer;
        });
        this.recursive(parents, treeSource, field, 1);
        return parents;
    };
    /**
     * 递归遍历树形结构
     * @param parents
     * @param treeSource
     * @param field
     * @param layer
     */
    MultiSelectDataMappingDirective.prototype.recursive = function (parents, treeSource, field, layer) {
        var _this_1 = this;
        parents.forEach(function (parent) {
            var parentPath = parent['data'][field]['path'];
            var parentLayer = parent['data'][field]['layer'];
            if (parent['data'][field]['isDetail'] === false) {
                treeSource.forEach(function (item) {
                    if (item && item['data'] && item['data'][field] && item['data'][field]['path']) {
                        var itemPath = item['data'][field]['path'];
                        var itemLayer = item['data'][field]['layer'];
                        var targetPath = void 0;
                        if (itemPath && itemPath.length > parentPath.length) {
                            targetPath = itemPath.substr(0, Number(layer) * 4);
                        }
                        if (parentPath === targetPath && parentLayer === itemLayer - 1) {
                            parent['children'].push(item);
                        }
                        if (item['data'][field]['isDetail'] === false && parentPath === targetPath) {
                            _this_1.recursive([item], treeSource, field, Number(layer) + 1);
                        }
                    }
                });
            }
        });
    };
    /**
       *
       * @param ids 选中数据的id
       * @param dataSource 原始数据
       */
    MultiSelectDataMappingDirective.prototype.getListSelectionsById = function (ids, dataSource) {
        var result = [];
        var _this = this;
        if ((typeof ids === 'string' && !!ids) || typeof ids === 'number') {
            var reusltObj = dataSource.find(function (item) {
                return item && item[_this.idField] === ids;
            });
            if (reusltObj) {
                result.push(reusltObj);
            }
        }
        else if (Array.isArray(ids)) {
            if (dataSource) {
                ids.forEach(function (id) {
                    var item = dataSource.find(function (item) { return item && item[_this.idField] === id; });
                    if (item) {
                        result.push(item);
                    }
                });
                // dataSource.forEach(item => {
                //   ids.forEach(id => {
                //     if (item[_this.idField] === id) {
                //       result.push(item);
                //     }
                //   })
                // })
            }
            else {
                result = [];
            }
        }
        else {
            result = [];
        }
        return result;
    };
    /**
     *
     * @param ids 选中数据的id
     * @param dataSource 原始数据
     */
    MultiSelectDataMappingDirective.prototype.getTreeSelectionsById = function (ids, dataSource) {
        var result = [];
        var _this = this;
        if ((typeof ids === 'string' && !!ids) || typeof ids === 'number') {
            var reusltObj = dataSource.find(function (item) {
                return item && item[_this.idField] === ids;
            });
            if (reusltObj) {
                result.push(reusltObj);
            }
        }
        else if (Array.isArray(ids)) {
            if (dataSource) {
                ids.forEach(function (id) {
                    var item = dataSource.find(function (item) { return item && item[_this.idField] === id; });
                    if (item) {
                        result.push(item);
                    }
                });
                // dataSource.forEach(item => {
                //   ids.forEach(id => {
                //     if (item.data[_this.idField] === id) {
                //       result.push(item.data);
                //     }
                //   })
                // })
            }
            else {
                result = [];
            }
        }
        else {
            result = [];
        }
        return result;
    };
    /**
     * 根据父节点初始化树结构
     * @param bindingObjects
     */
    MultiSelectDataMappingDirective.prototype.buildTreeNodesByFjd = function (bindingObjects, field) {
        var _this_1 = this;
        var treeData = this.formatDataSource(bindingObjects, field);
        treeData.forEach(function (item) {
            var parent = treeData.find(function (ele) { return item.data[field].parentElement === ele.data[_this_1.idField]; });
            if (parent) {
                parent.children.push(item);
            }
        });
        return treeData.filter(function (ele) { return !ele.data[field].parentElement; });
    };
    MultiSelectDataMappingDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[multiSelectDataMapping]'
                },] }
    ];
    /** @nocollapse */
    MultiSelectDataMappingDirective.ctorParameters = function () { return [
        { type: ViewModel, decorators: [{ type: Optional }] },
        { type: MultiSelectComponent, decorators: [{ type: Host }, { type: Self }, { type: Optional }] }
    ]; };
    MultiSelectDataMappingDirective.propDecorators = {
        dataSource: [{ type: Input }],
        idField: [{ type: Input }],
        textField: [{ type: Input }],
        valueField: [{ type: Input }],
        fjmField: [{ type: Input }],
        fjdField: [{ type: Input }],
        uiStateField: [{ type: Input }],
        selectedId: [{ type: Input }],
        selectedIdChanged: [{ type: Output }]
    };
    return MultiSelectDataMappingDirective;
}());
export { MultiSelectDataMappingDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXVsdGktc2VsZWN0LWRhdGEtbWFwcGluZy5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2tlbmRvLWJpbmRpbmcvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy9tdWx0aS1zZWxlY3QtZGF0YS1tYXBwaW5nLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQVUsTUFBTSxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQTtBQUM5RCxPQUFPLEVBQUUsU0FBUyxFQUFpQixNQUFNLGdCQUFnQixDQUFDO0FBRTFEO0lBZ0JFLHlDQUNzQixFQUFhLEVBQ0csb0JBQTBDO1FBRmhGLG1CQU9DO1FBTnFCLE9BQUUsR0FBRixFQUFFLENBQVc7UUFDRyx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBTHRFLHNCQUFpQixHQUFHLElBQUksWUFBWSxFQUFVLENBQUM7UUFPdkQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxVQUFBLElBQUk7WUFDcEMsT0FBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQy9CLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUNELGtEQUFRLEdBQVI7UUFBQSxtQkEwQkM7UUF6QkMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDMUMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUNsQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7WUFDdkQsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxV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TSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsVUFBVSxDQUFDLEtBQUssS0FBSyxFQUFFO2dCQUMvQyxVQUFVLENBQUMsT0FBTyxDQUFDLFVBQUEsSUFBSTtvQkFDckIsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUU7d0JBQzlFLElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQzt3QkFDN0MsSUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO3dCQUMvQyxJQUFJLFVBQVUsU0FBUSxDQUFDO3dCQUN2QixJQUFJLFFBQVEsSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLFVBQVUsQ0FBQyxNQUFNLEVBQUU7NEJBQ25ELFVBQVUsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7eUJBQ3BEO3dCQUNELElBQUksVUFBVSxLQUFLLFVBQVUsSUFBSSxXQUFXLEtBQUssU0FBUyxHQUFHLENBQUMsRUFBRTs0QkFDOUQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzt5QkFDL0I7d0JBQ0QsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsVUFBVSxDQUFDLEtBQUssS0FBSyxJQUFJLFVBQVUsS0FBSyxVQUFVLEVBQUU7NEJBQzFFLE9BQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQzt5QkFD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QUFLOytCQUNMLEtBQUs7NkJBQ0wsS0FBSztvQ0FDTCxNQUFNOztJQXFOVCxzQ0FBQztDQUFBLEFBbE9ELElBa09DO1NBL05ZLCtCQUErQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgSW5wdXQsIFNlbGYsIEhvc3QsIE9wdGlvbmFsLCBPbkluaXQsIE91dHB1dCwgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE11bHRpU2VsZWN0Q29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1tdWx0aS1zZWxlY3QnXHJcbmltcG9ydCB7IFZpZXdNb2RlbCwgQmluZGluZ09iamVjdCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW211bHRpU2VsZWN0RGF0YU1hcHBpbmddJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgTXVsdGlTZWxlY3REYXRhTWFwcGluZ0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcblxyXG4gIEBJbnB1dCgpIGRhdGFTb3VyY2U6IGFueTtcclxuICBASW5wdXQoKSBpZEZpZWxkOiBzdHJpbmc7XHJcbiAgQElucHV0KCkgdGV4dEZpZWxkOiBzdHJpbmc7XHJcbiAgQElucHV0KCkgdmFsdWVGaWVsZDogc3RyaW5nO1xyXG4gIEBJbnB1dCgpIGZqbUZpZWxkOiBzdHJpbmc7XHJcbiAgQElucHV0KCkgZmpkRmllbGQ6IHN0cmluZztcclxuICBASW5wdXQoKSB1aVN0YXRlRmllbGQ6IGFueTtcclxuICBASW5wdXQoKSBzZWxlY3RlZElkOiBzdHJpbmc7XHJcbiAgQE91dHB1dCgpIHNlbGVjdGVkSWRDaGFuZ2VkID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XHJcbiAgcHJpdmF0ZSBvcmlnaW5hbERhdGFTb3VyY2U6IGFueTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHZtOiBWaWV3TW9kZWwsXHJcbiAgICBASG9zdCgpIEBTZWxmKCkgQE9wdGlvbmFsKCkgcHJpdmF0ZSBtdWx0aVNlbGVjdENvbXBvbmVudDogTXVsdGlTZWxlY3RDb21wb25lbnRcclxuICApIHtcclxuICAgIHRoaXMudm0udWlTdGF0ZS5jaGFuZ2VzLnN1YnNjcmliZShkYXRhID0+IHtcclxuICAgICAgdGhpcy5zZWxlY3RlZElkID0gZGF0YS52YWx1ZTtcclxuICAgIH0pXHJcbiAgfVxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgdGhpcy5tdWx0aVNlbGVjdENvbXBvbmVudC5kYXRhU291cmNlID0gW107XHJcbiAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmRhdGFTb3VyY2UpKSB7XHJcbiAgICAgIHRoaXMubXVsdGlTZWxlY3RDb21wb25lbnQuZGF0YVNvdXJjZSA9IHRoaXMuZGF0YVNvdXJjZTtcclxuICAgICAgdGhpcy5vcmlnaW5hbERhdGFTb3VyY2UgPSB0aGlzLmRhdGFTb3VyY2U7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuZGF0YVNvdXJjZSAmJiB0aGlzLmRhdGFTb3VyY2UuY2hhbmdlcykge1xyXG4gICAgICB0aGlzLmRhdGFTb3VyY2UuY2hhbmdlcy5zdWJzY3JpYmUoKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmIChkYXRhLnR5cGUgPT09ICdMb2FkJykge1xyXG4gICAgICAgICAgdGhpcy5vcmlnaW5hbERhdGFTb3VyY2UgPSBkYXRhLnZhbHVlO1xyXG4gICAgICAgICAgaWYgKHRoaXMubXVsdGlTZWxlY3RDb21wb25lbnQuaXNUcmVlKCkpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZmptRmllbGQpIHtcclxuICAgICAgICAgICAgICAvLyDliIbnuqfnoIHliqDovb3moJHnu5PmnoRcclxuICAgICAgICAgICAgICB0aGlzLm11bHRpU2VsZWN0Q29tcG9uZW50LmRhdGFTb3VyY2UgPSB0aGlzLnBsYWluVG9UcmVlKGRhdGEudmFsdWUsIHRoaXMuZmptRmllbGQsIDEpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZmpkRmllbGQpIHtcclxuICAgICAgICAgICAgICAvLyDniLboioLngrnliqDovb3moJHnu5PmnoRcclxuICAgICAgICAgICAgICB0aGlzLm11bHRpU2VsZWN0Q29tcG9uZW50LmRhdGFTb3VyY2UgPSB0aGlzLmJ1aWxkVHJlZU5vZGVzQnlGamQoZGF0YS52YWx1ZSwgdGhpcy5mamRGaWVsZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5tdWx0aVNlbGVjdENvbXBvbmVudC5zZWxlY3Rpb25zID0gdGhpcy5nZXRUcmVlU2VsZWN0aW9uc0J5SWQodGhpcy5zZWxlY3RlZElkLCB0aGlzLm9yaWdpbmFsRGF0YVNvdXJjZSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLm11bHRpU2VsZWN0Q29tcG9uZW50LmRhdGFTb3VyY2UgPSBkYXRhLnZhbHVlO1xyXG4gICAgICAgICAgICB0aGlzLm11bHRpU2VsZWN0Q29tcG9uZW50LnNlbGVjdGlvbnMgPSB0aGlzLmdldExpc3RTZWxlY3Rpb25zQnlJZCh0aGlzLnNlbGVjdGVkSWQsIHRoaXMubXVsdGlTZWxlY3RDb21wb25lbnQuZGF0YVNvdXJjZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgfVxyXG4gICAgdGhpcy5zZWxlY3RJZEJpbmRpbmdUb1VJU3RhdGVGaWVsZCgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZWxlY3RJZEJpbmRpbmdUb1VJU3RhdGVGaWVsZCgpIHtcclxuICAgIGlmICh0aGlzLm11bHRpU2VsZWN0Q29tcG9uZW50ICYmIHRoaXMubXVsdGlTZWxlY3RDb21wb25lbnQuc2VsZWN0ZWRJZENoYW5nZSkge1xyXG4gICAgICB0aGlzLm11bHRpU2VsZWN0Q29tcG9uZW50LnNlbGVjdGVkSWRDaGFuZ2Uuc3Vic2NyaWJlKGRhdGEgPT4ge1xyXG4gICAgICAgIHRoaXMuc2VsZWN0ZWRJZENoYW5nZWQuZW1pdChkYXRhKTtcclxuICAgICAgfSlcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICogXHJcbiAgICogQHBhcmFtIGRhdGEg6ZyA6KaB5qC85byP5YyW55qE5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmb3JtYXREYXRhU291cmNlKGRhdGE6IGFueVtdLCBmaWVsZDogc3RyaW5nKSB7XHJcbiAgICBpZiAoIWRhdGEgfHwgIWRhdGEubGVuZ3RoKSB7XHJcbiAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuICAgIHJldHVybiBkYXRhLm1hcChpdGVtID0+IHtcclxuICAgICAgY29uc3QgbiA9IGl0ZW1bJ3RvSlNPTiddID8gaXRlbS50b0pTT04oKSA6IGl0ZW07XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgZGF0YTogT2JqZWN0LmFzc2lnbih7IC4uLm4gfSwge1xyXG4gICAgICAgICAgW2Ake3RoaXMuaWRGaWVsZH1gXTogaXRlbVt0aGlzLmlkRmllbGRdLFxyXG4gICAgICAgICAgW2Ake3RoaXMudGV4dEZpZWxkfWBdOiBpdGVtW3RoaXMudGV4dEZpZWxkXSxcclxuICAgICAgICAgIFtgJHt0aGlzLnZhbHVlRmllbGR9YF06IGl0ZW1bdGhpcy52YWx1ZUZpZWxkXSxcclxuICAgICAgICAgIFtgJHtmaWVsZH1gXTogaXRlbVtmaWVsZF1cclxuICAgICAgICB9KSxcclxuICAgICAgICBjaGlsZHJlbjogW11cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaKiuW5s+ihjOe7k+aehOeahOaVsOaNrui9rOaNouaIkOagkeW9oue7k+aehFxyXG4gICAqIEBwYXJhbSBwbGFpblNvdXJjZSBcclxuICAgKiBAcGFyYW0gZmllbGQgXHJcbiAgICogQHBhcmFtIGxheWVyIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgcGxhaW5Ub1RyZWUocGxhaW5Tb3VyY2U6IGFueVtdLCBmaWVsZDogc3RyaW5nLCBsYXllcjogbnVtYmVyKSB7XHJcbiAgICBjb25zdCB0cmVlU291cmNlID0gdGhpcy5mb3JtYXREYXRhU291cmNlKHBsYWluU291cmNlLCBmaWVsZCk7XHJcbiAgICBpZiAoIXRyZWVTb3VyY2UubGVuZ3RoKSB7XHJcbiAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuICAgIGlmICghdHJlZVNvdXJjZVswXVsnZGF0YSddW2ZpZWxkXSkge1xyXG4gICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXJlbnRzID0gdHJlZVNvdXJjZS5maWx0ZXIoaXRlbSA9PiB7XHJcbiAgICAgIHJldHVybiBpdGVtWydkYXRhJ11bZmllbGRdWydsYXllciddID09PSBsYXllcjtcclxuICAgIH0pXHJcbiAgICB0aGlzLnJlY3Vyc2l2ZShwYXJlbnRzLCB0cmVlU291cmNlLCBmaWVsZCwgMSk7XHJcbiAgICByZXR1cm4gcGFyZW50cztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOmAkuW9kumBjeWOhuagkeW9oue7k+aehFxyXG4gICAqIEBwYXJhbSBwYXJlbnRzIFxyXG4gICAqIEBwYXJhbSB0cmVlU291cmNlIFxyXG4gICAqIEBwYXJhbSBmaWVsZCBcclxuICAgKiBAcGFyYW0gbGF5ZXIgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZWN1cnNpdmUocGFyZW50czogYW55W10sIHRyZWVTb3VyY2U6IGFueVtdLCBmaWVsZDogc3RyaW5nLCBsYXllcjogbnVtYmVyKSB7XHJcbiAgICBwYXJlbnRzLmZvckVhY2gocGFyZW50ID0+IHtcclxuICAgICAgY29uc3QgcGFyZW50UGF0aCA9IHBhcmVudFsnZGF0YSddW2ZpZWxkXVsncGF0aCddO1xyXG4gICAgICBjb25zdCBwYXJlbnRMYXllciA9IHBhcmVudFsnZGF0YSddW2ZpZWxkXVsnbGF5ZXInXTtcclxuICAgICAgaWYgKHBhcmVudFsnZGF0YSddW2ZpZWxkXVsnaXNEZXRhaWwnXSA9PT0gZmFsc2UpIHtcclxuICAgICAgICB0cmVlU291cmNlLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICBpZiAoaXRlbSAmJiBpdGVtWydkYXRhJ10gJiYgaXRlbVsnZGF0YSddW2ZpZWxkXSAmJiBpdGVtWydkYXRhJ11bZmllbGRdWydwYXRoJ10pIHtcclxuICAgICAgICAgICAgY29uc3QgaXRlbVBhdGggPSBpdGVtWydkYXRhJ11bZmllbGRdWydwYXRoJ107XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1MYXllciA9IGl0ZW1bJ2RhdGEnXVtmaWVsZF1bJ2xheWVyJ107XHJcbiAgICAgICAgICAgIGxldCB0YXJnZXRQYXRoOiBzdHJpbmc7XHJcbiAgICAgICAgICAgIGlmIChpdGVtUGF0aCAmJiBpdGVtUGF0aC5sZW5ndGggPiBwYXJlbnRQYXRoLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgIHRhcmdldFBhdGggPSBpdGVtUGF0aC5zdWJzdHIoMCwgTnVtYmVyKGxheWVyKSAqIDQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChwYXJlbnRQYXRoID09PSB0YXJnZXRQYXRoICYmIHBhcmVudExheWVyID09PSBpdGVtTGF5ZXIgLSAxKSB7XHJcbiAgICAgICAgICAgICAgcGFyZW50WydjaGlsZHJlbiddLnB1c2goaXRlbSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGl0ZW1bJ2RhdGEnXVtmaWVsZF1bJ2lzRGV0YWlsJ10gPT09IGZhbHNlICYmIHBhcmVudFBhdGggPT09IHRhcmdldFBhdGgpIHtcclxuICAgICAgICAgICAgICB0aGlzLnJlY3Vyc2l2ZShbaXRlbV0sIHRyZWVTb3VyY2UsIGZpZWxkLCBOdW1iZXIobGF5ZXIpICsgMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9XHJcbiAgLyoqXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSBpZHMg6YCJ5Lit5pWw5o2u55qEaWRcclxuICAgICAqIEBwYXJhbSBkYXRhU291cmNlIOWOn+Wni+aVsOaNrlxyXG4gICAgICovXHJcbiAgcHJpdmF0ZSBnZXRMaXN0U2VsZWN0aW9uc0J5SWQoaWRzOiBhbnksIGRhdGFTb3VyY2U6IGFueSkge1xyXG4gICAgbGV0IHJlc3VsdCA9IFtdO1xyXG4gICAgY29uc3QgX3RoaXMgPSB0aGlzO1xyXG4gICAgaWYgKCh0eXBlb2YgaWRzID09PSAnc3RyaW5nJyAmJiAhIWlkcykgfHwgdHlwZW9mIGlkcyA9PT0gJ251bWJlcicpIHtcclxuICAgICAgY29uc3QgcmV1c2x0T2JqID0gZGF0YVNvdXJjZS5maW5kKGl0ZW0gPT4ge1xyXG4gICAgICAgIHJldHVybiBpdGVtICYmIGl0ZW1bX3RoaXMuaWRGaWVsZF0gPT09IGlkcztcclxuICAgICAgfSk7XHJcbiAgICAgIGlmIChyZXVzbHRPYmopIHtcclxuICAgICAgICByZXN1bHQucHVzaChyZXVzbHRPYmopO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoaWRzKSkge1xyXG4gICAgICBpZiAoZGF0YVNvdXJjZSkge1xyXG4gICAgICAgIGlkcy5mb3JFYWNoKGlkID0+IHtcclxuICAgICAgICAgIGNvbnN0IGl0ZW0gPSBkYXRhU291cmNlLmZpbmQoaXRlbSA9PiBpdGVtICYmIGl0ZW1bX3RoaXMuaWRGaWVsZF0gPT09IGlkKTtcclxuICAgICAgICAgIGlmIChpdGVtKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIGRhdGFTb3VyY2UuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICAvLyAgIGlkcy5mb3JFYWNoKGlkID0+IHtcclxuICAgICAgICAvLyAgICAgaWYgKGl0ZW1bX3RoaXMuaWRGaWVsZF0gPT09IGlkKSB7XHJcbiAgICAgICAgLy8gICAgICAgcmVzdWx0LnB1c2goaXRlbSk7XHJcbiAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAvLyAgIH0pXHJcbiAgICAgICAgLy8gfSlcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXN1bHQgPSBbXTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmVzdWx0ID0gW107XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogXHJcbiAgICogQHBhcmFtIGlkcyDpgInkuK3mlbDmja7nmoRpZFxyXG4gICAqIEBwYXJhbSBkYXRhU291cmNlIOWOn+Wni+aVsOaNrlxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0VHJlZVNlbGVjdGlvbnNCeUlkKGlkczogYW55LCBkYXRhU291cmNlOiBhbnkpIHtcclxuICAgIGxldCByZXN1bHQgPSBbXTtcclxuICAgIGNvbnN0IF90aGlzID0gdGhpcztcclxuICAgIGlmICgodHlwZW9mIGlkcyA9PT0gJ3N0cmluZycgJiYgISFpZHMpIHx8IHR5cGVvZiBpZHMgPT09ICdudW1iZXInKSB7XHJcbiAgICAgIGNvbnN0IHJldXNsdE9iaiA9IGRhdGFTb3VyY2UuZmluZChpdGVtID0+IHtcclxuICAgICAgICByZXR1cm4gaXRlbSAmJiBpdGVtW190aGlzLmlkRmllbGRdID09PSBpZHM7XHJcbiAgICAgIH0pO1xyXG4gICAgICBpZiAocmV1c2x0T2JqKSB7XHJcbiAgICAgICAgcmVzdWx0LnB1c2gocmV1c2x0T2JqKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGlkcykpIHtcclxuICAgICAgaWYgKGRhdGFTb3VyY2UpIHtcclxuICAgICAgICBpZHMuZm9yRWFjaChpZCA9PiB7XHJcbiAgICAgICAgICBjb25zdCBpdGVtID0gZGF0YVNvdXJjZS5maW5kKGl0ZW0gPT4gaXRlbSAmJiBpdGVtW190aGlzLmlkRmllbGRdID09PSBpZCk7XHJcbiAgICAgICAgICBpZiAoaXRlbSkge1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaChpdGVtKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICAvLyBkYXRhU291cmNlLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgLy8gICBpZHMuZm9yRWFjaChpZCA9PiB7XHJcbiAgICAgICAgLy8gICAgIGlmIChpdGVtLmRhdGFbX3RoaXMuaWRGaWVsZF0gPT09IGlkKSB7XHJcbiAgICAgICAgLy8gICAgICAgcmVzdWx0LnB1c2goaXRlbS5kYXRhKTtcclxuICAgICAgICAvLyAgICAgfVxyXG4gICAgICAgIC8vICAgfSlcclxuICAgICAgICAvLyB9KVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlc3VsdCA9IFtdO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXN1bHQgPSBbXTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG5cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOagueaNrueItuiKgueCueWIneWni+WMluagkee7k+aehFxyXG4gICAqIEBwYXJhbSBiaW5kaW5nT2JqZWN0cyBcclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkVHJlZU5vZGVzQnlGamQoYmluZGluZ09iamVjdHM6IEJpbmRpbmdPYmplY3RbXSwgZmllbGQ6IHN0cmluZykge1xyXG4gICAgY29uc3QgdHJlZURhdGEgPSB0aGlzLmZvcm1hdERhdGFTb3VyY2UoYmluZGluZ09iamVjdHMsIGZpZWxkKTtcclxuICAgIHRyZWVEYXRhLmZvckVhY2goKGl0ZW06IGFueSkgPT4ge1xyXG4gICAgICBjb25zdCBwYXJlbnQgPSB0cmVlRGF0YS5maW5kKChlbGU6IGFueSkgPT4gaXRlbS5kYXRhW2ZpZWxkXS5wYXJlbnRFbGVtZW50ID09PSBlbGUuZGF0YVt0aGlzLmlkRmllbGRdKTtcclxuICAgICAgaWYgKHBhcmVudCkge1xyXG4gICAgICAgIHBhcmVudC5jaGlsZHJlbi5wdXNoKGl0ZW0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0cmVlRGF0YS5maWx0ZXIoKGVsZTogYW55KSA9PiAhZWxlLmRhdGFbZmllbGRdLnBhcmVudEVsZW1lbnQpO1xyXG4gIH1cclxufVxyXG4iXX0=