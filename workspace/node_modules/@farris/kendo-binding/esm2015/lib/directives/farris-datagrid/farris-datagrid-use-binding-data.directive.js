import { Directive, HostListener, EventEmitter, Output } from '@angular/core';
import { Subject } from 'rxjs';
import { BindingData, ChangeType, ViewModel, DataTypeInfo, EntityPathConverter, RunMode, ComponentType, ExpressionUtil, ENABLE_EDIT_STATE_FILTER_SORTING } from '@farris/devkit';
import { DatagridComponent } from '@farris/ui-datagrid';
import { debounceTime, finalize } from 'rxjs/operators';
// tslint:disable: max-line-length
/*
 * 使用绑定数据指令
 */
export class FarrisDatagridUseBindingDataDirective {
    // private renderGridDebounce;
    constructor(bindingData, viewModel, grid) {
        this.bindingData = bindingData;
        this.viewModel = viewModel;
        this.grid = grid;
        // 排序字段
        this.sortFields = null;
        // 排序方向
        this.sortDirections = null;
        /**
         * 是否已排序
         */
        this.hasSorted = false;
        /**
         * 过滤条件
         */
        this.filters = null;
        /**
         * 渲染grid
         */
        this.renderGridSubject = new Subject();
        this.enableFilterSorting = false;
        /**
         * 选中行切换事件
         */
        this.selectedRowChange = new EventEmitter();
        this.setChecks([]);
        this.enableFilterSorting = this.viewModel && this.viewModel.frameContext && this.viewModel.frameContext.injector.get(ENABLE_EDIT_STATE_FILTER_SORTING, false) || false;
        this.registerEvent();
    }
    get props() {
        return this._PROPS;
    }
    set props(value) {
        this._PROPS = value;
    }
    // #region Ng Event
    ngOnInit() {
        const { pageSize = 0 } = this.getPagingInfo() || {};
        if (pageSize !== 0) {
            // 启用分页
            if ((!this.grid.pageList || this.grid.pageList.length < 1) && typeof this.grid['setPageList'] === 'function') {
                this.grid['setPageList']([pageSize, pageSize * 2, pageSize * 3, pageSize * 4]);
            }
        }
        this.setComponentRef();
        this.bindData();
        window.setTimeout(() => {
            this.updateSelectedRow();
        }, 0);
        this.registerBindingDataChangeEvent();
        this.renderGridSubject.pipe(debounceTime(500)).subscribe((change) => {
            if (!this.viewModel || !this.viewModel.frameContext || this.viewModel.frameContext.isDisposed) {
                return;
            }
            this.bindData(change);
            /*if (!this.renderGridDebounce) {
              this.renderGridDebounce = this.debounce((change) => {
                this.bindData(change);
              }, 500);
            }
            this.renderGridDebounce(change);*/
        });
        if (this.viewModel && this.viewModel.frameContext && this.viewModel.frameContext.frameComponent) {
            this.viewModel.frameContext.frameComponent.componentType = ComponentType.farrisDataGridComponent;
        }
    }
    ngOnChanges(changes) {
        this.bindData();
    }
    // #endregion
    /**
     * 主键
     */
    get primaryKey() {
        return this.bindingList.primaryKey;
    }
    /**
     * 获取绑定数据
     */
    get bindingList() {
        // 根实体
        if (this.viewModel.bindingPath === '/' || !this.viewModel.bindingPath) {
            return this.bindingData.list;
        }
        // 子实体
        let bindingPath = this.viewModel.bindingPath.substr(1);
        bindingPath = bindingPath[0].toLowerCase() + bindingPath.substring(1, bindingPath.length);
        const paths = bindingPath.split('/');
        const filteredPaths = paths.filter((part) => {
            return part !== '';
        });
        return this.bindingData.getValue(filteredPaths);
    }
    /**
     * 设置组件引用
     */
    setComponentRef() {
        const appContext = this.viewModel && this.viewModel.frameContext && this.viewModel.frameContext.getFormAppContext();
        const frameId = this.viewModel && this.viewModel.frameContext && this.viewModel.frameContext.frameId;
        const id = this.grid && this.grid.id;
        // 如果frameId不存在或farris grid没有id属性，说明不符合使用场景
        if (!frameId || !id) {
            return;
        }
        const map = appContext && appContext.componentRefs && appContext.componentRefs.get(frameId) || new Map();
        appContext && appContext.componentRefs && appContext.componentRefs.set(frameId, map.set(id, this.grid));
    }
    /**
     * 获取分页信息
     */
    getPagingInfo() {
        const bindingPath = this.viewModel.bindingPath;
        const bindingData = this.viewModel.bindingData;
        const pagingInfo = bindingData && bindingData.pagingInfo || {};
        if (bindingPath === '/') {
            return pagingInfo;
        }
        else {
            const bindingPaths = bindingPath.substr(1).split('/').filter((item) => !!item && item.length > 0);
            // 从表及从从表分页和数据是关联的，因为不同的从表行有不同的从从表数据，分页信息的结构为nodeCode_parentId:{分页信息}且分页信息是平级的
            // {pagination:{a_pid:{pageSize:2,pageIndex:1},b_pid:{pageSize:2,pageIndex:1}}}
            // 取出当前路径下实体的nodeCode
            let nodeCode = bindingPaths[bindingPaths.length - 1];
            nodeCode = nodeCode.substr(0, nodeCode.length - 1);
            // 获取当前实体上级的主键
            // const result = pagingInfo[nodeCode] || {};
            // if (result.hasOwnProperty('totalCount')) {
            //   result.total = result.totalCount;
            // }
            // return result;
            const paths = bindingPaths.slice(0, bindingPaths.length - 1);
            const bindingList = bindingData.getValue(paths);
            const { pageSize = 0 } = pagingInfo[`${nodeCode}`] || {};
            // 上级表有数据
            if (bindingList && bindingList.currentId) {
                const key = `${nodeCode}_${bindingList.currentId}`;
                // const key = nodeCode;
                const result = pagingInfo[key] || {};
                if (result.hasOwnProperty('totalCount')) {
                    result.total = result.totalCount;
                }
                // 上级表虽然有数据，但上级表当前行的下级表可能没有数据，这就导致获取不到分页信息，所以需要在返回前对结果进行处理，如果没有分页信息的话起码应该返回分页大小及当前页码
                if (Object.keys(result).length < 1) {
                    result.pageIndex = 1;
                    result.pageSize = pageSize;
                }
                return result;
            }
            else {
                // 上级表没有数据，此时需要获取当前表的分页信息，如分页大小。当前页默认为1即可。
                return { pageIndex: 1, pageSize };
            }
        }
    }
    // #region Input
    /**
     * 组件是否需要更新
     * @param props 当前属性
     * @param nextProps 新属性
     * @param change 变更
     */
    shouldComponentUpdate(change, data) {
        const props = this.buildProps(data);
        if (this.viewModel && this.viewModel.frameContext && this.viewModel.frameContext.appContext && this.viewModel.frameContext.appContext.runMode === RunMode.highSpeed && change) {
            if (change.type === ChangeType.Load || change.type === ChangeType.Remove || change.type === ChangeType.PaginationInfoChange) {
                return { result: true, props };
            }
        }
        const gridProps = this.buildGridProps();
        if (JSON.stringify(props) === JSON.stringify(gridProps)) {
            return { result: false };
        }
        return { result: true, props };
    }
    registerEvent() {
        // 排序事件
        this.grid && this.grid.columnSorted && this.grid.columnSorted.subscribe((event) => {
            const isRemoteSort = this.grid.remoteSort;
            // 本地排序
            if (!isRemoteSort) {
                this.sortFields = this.grid.sortName;
                this.sortDirections = this.grid.sortOrder;
                this.sortBindingList();
                // this.props = this.buildProps();
            }
            else {
                // 服务器端排序
                const groupField = this.grid && this.grid.groupField || null;
                let sortFields = this.grid.sortName && this.grid.sortName.split(',') || [];
                const sortDirection = this.grid.sortOrder && this.grid.sortOrder.split(',') || [];
                if (groupField) {
                    if (!sortFields.includes(groupField)) {
                        sortFields.splice(0, 0, groupField);
                        sortDirection.splice(0, 0, 'asc');
                    }
                }
                // 获取当前entity上所有object属性
                const entityType = this.viewModel && this.viewModel.frameContext.repository.entityType || null;
                if (sortFields.length > 0) {
                    if (entityType) {
                        const dataTypeInfo = new DataTypeInfo(entityType);
                        sortFields = sortFields.map(field => {
                            //if (field && field.indexOf('.') !== -1) {
                            const paths = field.split('.');
                            const propInfo = dataTypeInfo.getPropInfoByPath(paths);
                            const originalField = propInfo && propInfo.metadataInfo['path'] || null;
                            return originalField;
                            //}
                            //return field;
                        });
                    }
                }
                // 遍历属性，根据datafield转换为originalDataField
                const fields = sortFields.join(',');
                const directions = sortDirection.join(',') || 'asc';
                const frameContext = this.viewModel && this.viewModel.frameContext || null;
                if (frameContext) {
                    frameContext.repository.sortConditionManager.setConditions(this.viewModel.bindingPath, fields, directions);
                }
            }
        });
        // 过滤事件
        this.grid && this.grid.filterChanged && this.grid.filterChanged.subscribe((event) => {
            this.filters = event;
            if (!this.grid.remoteFilter) {
                if (this.bindingList.length > 0 && !this.bindingList.currentId) {
                    const id = this.bindingList.getIdByIndex(0);
                    this.bindingList.setCurrentId(id);
                }
                this.bindingList.filter(this.filters);
                this.bindData();
            }
        });
        this.viewModel.frameContext.appContext.messagePipe.subscribe((message) => {
            if (message && message === 'CLEAR_GRID_CONDITION' && this.filters && Object.keys(this.filters).length > 0) {
                this.filters = {};
                this.bindData();
            }
        });
    }
    /**
     * 对bindingList排序
     * @param change change
     */
    sortBindingList(change) {
        // groupField可能有多个，以逗号分隔的字符串
        const groupField = this.grid && this.grid.groupField || null;
        if (groupField) {
            const arrSortFields = this.sortFields && this.sortFields.split(',') || [];
            const groupFields = groupField.split(',').reverse();
            groupFields.forEach((field) => {
                if (!arrSortFields.includes(field)) {
                    arrSortFields.splice(0, 0, field);
                    const arrSortDirection = this.sortDirections && this.sortDirections.split(',') || [];
                    arrSortDirection.splice(0, 0, 'asc');
                    this.sortFields = arrSortFields.join(',');
                    this.sortDirections = arrSortDirection.join(',') || 'asc';
                }
            });
        }
        this.bindingList.sortBy(this.sortFields, this.sortDirections);
        this.bindData(change);
    }
    // #endregion
    // #region 数据绑定部分
    /**
     * 更新数据
     * @param change? 变更
     */
    bindData(change) {
        const isRemoteFilter = this.grid && this.grid.remoteFilter || false;
        // 先执行排序
        const shouldSort = this.shouldSort(change);
        if (shouldSort) {
            this.hasSorted = true;
            this.sortBindingList(change);
            return;
        }
        this.hasSorted = false;
        // 新增数据时清空表格筛选条件
        if ((this.grid.editable === true || change && change.type === ChangeType.Append) && this.filters && Object.keys(this.filters).length > 0 && !isRemoteFilter) {
            if (!this.viewModel.frameContext.appContext.enableGridHeaderWhenEditing && !this.enableFilterSorting) {
                this.filters = {};
                this.grid.clearCondition();
            }
        }
        const shouldFiltering = this.shouldFiltering(change);
        if (shouldFiltering) {
            this.bindingList.filter(this.filters);
        }
        // 再toJSON
        const data = this.bindingList.toJSON();
        // if (this.filters && Object.keys(this.filters).length > 0 && !isRemoteFilter) {
        //   // data = this.grid.clientFilterService.executeFilter(data, this.filters);
        // }
        if (this.filters && Object.keys(this.filters).length > 0 && !isRemoteFilter && (!change || change && change.type !== ChangeType.SelectionChanged && change.type !== ChangeType.GlobalSelectionChanged)) {
            if (data && data.length > 0) {
                // 判断当前行是否在过滤后的数据中
                const row = data.find((item) => item[this.bindingList.primaryKey] === this.bindingList.currentId);
                if (!row) {
                    const firstRowId = data[0][this.bindingList.primaryKey];
                    this.bindingList.setCurrentId(firstRowId, true, true);
                }
            }
            else {
                // 本地过滤完之后没有数据了
                // this.bindingList.currentId = null;
                if (this.bindingList.currentId) {
                    this.bindingList.setCurrentId(null, true, true, true);
                }
                // 单选时清空ids
                if (!this.grid.multiSelect) {
                    this.setChecks([]);
                }
            }
        }
        const result = this.shouldComponentUpdate(change, data);
        if (!result.result) {
            return;
        }
        // const nextProps = this.buildProps(result);
        this.renderGrid(result.props);
        this.props = JSON.parse(JSON.stringify(result.props));
    }
    /**
     * 是否应该过滤
     * @param change - change
     * @returns {boolean}
     */
    shouldFiltering(change) {
        const isRemoteFilter = this.grid && this.grid.remoteFilter || false;
        // 启用远端过滤时不需要本地过滤
        if (isRemoteFilter === true) {
            return false;
        }
        // 没有过滤条件时不需要执行过滤
        if (!this.filters || Object.keys(this.filters).length < 1) {
            return false;
        }
        if (change) {
            return change.type === ChangeType.Load;
        }
        return !this.grid.editable;
    }
    shouldSort(change) {
        // this.sortFields && !this.grid.editable && change && (change.type === 'Load' || change.type === 'SelectionChanged')
        if (!this.sortFields || Object.keys(this.sortFields).length < 1) {
            return false;
        }
        if (this.hasSorted) {
            return false;
        }
        if (change) {
            return change.type === 'Load' || change.type === 'SelectionChanged';
        }
        return this.grid.editable;
    }
    /**
     * 渲染grid
     * @param props 属性
     */
    renderGrid(props) {
        const { pageIndex, pageSize, total, pagination, data } = props;
        const virtualizedLoad = this.grid.virtualizedAsyncLoad || false;
        this.grid.total = total;
        this.grid.pageSize = pageSize;
        this.grid.pageIndex = pageIndex;
        this.grid.pagination = pagination;
        this.grid.controlPaginationState = false;
        // this.endCellEdit();
        if (pageSize === 0) {
            this.grid.pagination = false;
            this.grid.pageIndex = 1;
            // 修复不分页时grid启用分组仍会重新邦数的问题
            // this.grid.pageSize = total;
        }
        if (virtualizedLoad) {
            this.grid.loadVirtualData({
                items: data,
                pageIndex,
                pageSize,
                total
            });
        }
        else {
            this.grid.loadData(data);
        }
    }
    /**
     * 构造表格数据属性
     */
    buildProps(datas) {
        let data;
        if (typeof (datas) !== 'undefined') {
            data = datas;
        }
        else {
            data = this.bindingList.toJSON();
        }
        // let skip = 0;
        let { pageIndex = 1, pageSize = 0 } = this.getPagingInfo() || {};
        let { total = 0 } = this.getPagingInfo() || {};
        // if (pageIndex > 0) {
        //   skip = (pageIndex - 1) * pageSize;
        // }
        if (pageSize === 0 && total === 0) {
            total = data.length;
        }
        return { data, pageIndex, pageSize, total, pagination: pageSize !== 0 };
    }
    /**
     * 计算grid状态
     */
    buildGridProps() {
        const data = this.grid.data || [];
        let skip = 0;
        const { pageIndex = 1, pageSize = 0 } = { pageIndex: this.grid.pageIndex, pageSize: this.grid.pageSize };
        let total = this.grid.total || 0;
        if (pageIndex > 0) {
            skip = (pageIndex - 1) * pageSize;
        }
        if (pageSize === 0 && total === 0) {
            total = data.length;
        }
        return { data, pageIndex, pageSize, total, pagination: this.grid.pagination };
    }
    /**
     * 数据源发生变更
     * @param change 变更
     */
    onBindingDataChange(change) {
        this.updateDataSource(change);
        this.updateSelectedRow(change);
        // this.updateGrid(change);
        // 不清除勾选行，需要保留勾选状态
        // this.clearCheckedRows(change);
        this.endCellEdit(change);
        // 更新勾选行数据
        this.updateCheckedRows(change);
        this.updateData(change);
    }
    /**
     * 更新数据
     */
    updateDataSource(change) {
        if (change && change.type === ChangeType.ValueChanged) {
            // 计算变更路径中表名及字段名
            const paths = change.path;
            try {
                const entityPath = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(paths, this.viewModel.frameContext.repository.entityTypeInfo);
                if (this.viewModel.bindingPath === '/' + entityPath.join('/')) {
                    const propertyNames = paths.slice(entityPath.length);
                    if (change.id && this.grid && change.path && this.viewModel.frameContext.appContext.runMode !== RunMode.highSpeed && propertyNames && propertyNames.length > 0) {
                        this.grid.updateRow(change.id, { [propertyNames.join('.')]: change.value });
                    }
                }
            }
            catch (error) {
                console.warn(error);
            }
            this.renderGridSubject.next(change);
        }
        else if (change && (change.type === ChangeType.SelectionChanged || change.type === ChangeType.GlobalSelectionChanged)) {
            if (this.bindingList.currentId === (this.grid.selectedRow && this.grid.selectedRow.id) && this.grid.total > 0) {
            }
            else {
                this.bindData(change);
            }
        }
        else {
            this.bindData(change);
        }
    }
    // private endCellEdit() {
    //   const isEditing = this.grid.isEditing();
    //   if (isEditing) {
    //     this.grid.endCellEdit();
    //   }
    // }
    endCellEdit(change) {
        const isEditing = this.grid.isEditing();
        if (change.type === ChangeType.Load && isEditing) {
            this.grid.endCellEdit();
        }
    }
    /**
     * 设置grid当前选择行
     * @param change 变更
     */
    updateSelectedRow(change) {
        if (!this.bindingList || !this.bindingList.currentId) {
            return;
        }
        // 页码切换时不执行当前行切换
        if (change && change.type === ChangeType.PaginationInfoChange) {
            return;
        }
        if (this.viewModel && this.viewModel.frameContext.bindingData.rowSelectedEventSuspend === true) {
            return;
        }
        const { id: gridSelectedRowId = null } = this.grid.selectedRow || {};
        const currentId = this.bindingList.currentId;
        // grid当前行与bingingList当前行一致，无须切换
        if (gridSelectedRowId === currentId) {
            const isMatch = change && (change.path.toString() === this.viewModel.bindingPath.split('/').filter(p => p).toString());
            if (change && change.type === ChangeType.Load && isMatch) {
                this.grid.clearSelections();
                this.grid.selectRow(currentId, true, true);
            }
            return;
        }
        this.selectGridRow(this.bindingList.currentId);
    }
    /**
     * 注册bindingdata变化事件
     */
    registerBindingDataChangeEvent() {
        this.bindingDataChangeEvent = this.bindingData.changes.subscribe((change) => {
            this.onBindingDataChange(change);
        });
        this.viewModel.frameContext.appContext.messagePipe.subscribe(message => {
            if (message === 'bindData') {
                this.bindData();
            }
        });
    }
    /**
     * 取消bindingdata变化订阅
     */
    unRegisterBindingDataChangeEvent() {
        if (this.bindingDataChangeEvent && typeof (this.bindingDataChangeEvent.unsubscribe) === 'function') {
            this.bindingDataChangeEvent.unsubscribe();
        }
    }
    /**
     * 触发页码切换事件
     * @description 本方法适用场景仅为父级grid数据重新load，需要触发该grid重新取数使用。其他场景请勿使用
     * @TODO: 待重构，控制下级数据加载应该依赖表格的行切换事件，临时这样处理，后续提供LoadChildren事件
     */
    updateData(change) {
        if (!(change && (change.type === ChangeType.SelectionChanged || change.type === ChangeType.Load))) {
            return;
        }
        const bindingPath = this.viewModel.bindingPath;
        const eventBindingPath = '/' + change.path.join('/');
        const isRetrieve = this.viewModel.frameContext.appContext.params.get('retrieveing') || false;
        if (change.path.length < 1 || bindingPath === '/' || bindingPath === eventBindingPath || !bindingPath.startsWith(eventBindingPath)) {
            return;
        }
        // retrieve时会自动带回从表第一页及从表第一行的从从表数据，所以不需要再去单独请求
        if (isRetrieve) {
            return;
        }
        const fullPaths = EntityPathConverter.toEntityPathArray(this.viewModel.bindingPath, this.bindingData);
        const paths = fullPaths.slice(0, fullPaths.length - 1);
        const parent = this.bindingList.parent;
        const parentId = parent && parent[parent.primaryKey];
        // 上级表没有数据
        if (!parentId) {
            return;
        }
        // 获取nodecode
        const bindingPaths = this.viewModel.bindingPath.split('/').filter(item => item);
        let nodeCode = bindingPaths[bindingPaths.length - 1];
        nodeCode = nodeCode.substr(0, nodeCode.length - 1);
        // const configPath = `/${nodeCode}_${parentId}`;
        const configPath = `/${nodeCode}`;
        let { pageIndex = 1 } = this.viewModel.frameContext.repository.entityCollection.getPaginationConfigByPath(configPath) || {};
        const { pageSize = 0 } = this.viewModel.frameContext.repository.entityCollection.getPaginationConfigByPath(configPath) || {};
        const parentNodeCode = change.path[change.path.length - 1];
        const parentConfigPath = '/' + parentNodeCode.substring(0, parentNodeCode.length - 1);
        const { pageSize: parentPageSize = 0 } = this.viewModel.frameContext.repository.entityCollection.getPaginationConfigByPath(parentConfigPath) || {};
        const isQueryChild = this.viewModel.frameContext.appContext.params.get('queryChild') || false;
        if (isQueryChild) {
            // this.viewModel.frameContext.appContext.params.delete('queryChild');
            pageIndex = 1;
        }
        // 当上级表切换行时
        if (parentPageSize + pageSize !== 0) {
            this.viewModel.frameContext.appContext.params.set('forceQueryChild', true);
            this.viewModel.frameContext.repository.queryChild(paths, pageIndex, pageSize).pipe(finalize(() => this.viewModel.frameContext.appContext.params.delete('forceQueryChild'))).subscribe();
        }
    }
    ngOnDestroy() {
        this.unRegisterBindingDataChangeEvent();
    }
    // #endregion
    // #region 事件发射器
    /**
     * 发射选中行切换事件
     * @description 统一单选模式和多选模式下的行切换事件
     */
    fireSelectedRowChange(selectedRowContext) {
        this.selectedRowChange.emit(selectedRowContext);
    }
    /**
     * 清空选定行
     * @param change 变更
     */
    clearCheckedRows(change) {
        if (change.type === ChangeType.Load && this.grid.multiSelect) {
            const isMatch = this.checkIfChangeMatchBindingPath(change);
            if (isMatch) {
                this.setChecks([]);
                if (typeof (this.grid.clearCheckeds) === 'function') {
                    this.grid.clearCheckeds();
                }
            }
        }
    }
    // #endregion
    // #region 通信
    /**
     * 设置BindingList的当前行
     * @param id 当前行内码
     */
    setSelectionIdToBindingData(id) {
        // 如果当前行不存在，则强制设置
        if (!id) {
            this.bindingList.currentId = id;
            if (!this.grid.multiSelect) {
                this.setChecks([]);
            }
            return;
        }
        if (this.bindingList.currentId !== id) {
            this.bindingList.setCurrentId(id, true);
        }
        // 单选模式下将当前行设置到ids
        if (!this.grid.multiSelect) {
            this.setChecks([id]);
        }
    }
    updateCheckedRows(changes) {
        if (changes.type === ChangeType.Load) {
            this.setCheckedRows();
        }
        else if (changes.type === ChangeType.ValueChanged) {
            const ids = this.getChecks();
            if (changes.id && ids.includes(changes.id)) {
                this.setCheckedRows();
            }
        }
    }
    /**
     * 设置选择行
     */
    setChecks(ids) {
        this.viewModel.uiState.setPropertyValue('ids', ids);
        this.setCheckedRows(ids);
    }
    /**
     * 获取勾选行id数组
     * @returns
     */
    getChecks() {
        return this.viewModel.uiState['ids'] || [];
    }
    /**
     * 更新勾选行数据
     */
    setCheckedRows(ids) {
        // 高速模式时不再设置rows
        // if (this.viewModel.frameContext.appContext.runMode === RunMode.highSpeed) {
        //   return;
        // }
        if (typeof ids === 'undefined') {
            ids = this.viewModel.uiState['ids'] || [];
        }
        if (!Array.isArray(ids) || ids.length < 1) {
            // 此时ids没有值，rows中也不应该有
            this.viewModel.uiState.setPropertyValue('rows', null);
            return;
        }
        let list = [];
        // TODO：rows中数据在高速模式和普通模式下多语字段的值表现不一致，高速模式下多语字段值为对象，普通模式为当前语言。暂不处理高速模式场景
        if (this.viewModel.frameContext.appContext.runMode === RunMode.highSpeed) {
            list = this.grid.data || [];
        }
        else {
            list = this.bindingList.toJSON({ ignoreMultiLangInput: true });
        }
        const rows = this.viewModel.uiState['rows'] || new Map();
        const result = new Map();
        ids.forEach((id) => {
            const item = list.find(item => item[this.primaryKey] === id);
            const otherPageItem = rows.get(id);
            if (item) {
                result.set(id, item);
            }
            else if (otherPageItem) {
                result.set(id, otherPageItem);
            }
        });
        this.viewModel.uiState.setPropertyValue('rows', result);
    }
    /**
     * 选中grid行
     * @param id id
     */
    selectGridRow(id) {
        this.grid.selectRow(id);
        this.grid.scrollToCurrentRow();
    }
    // #endregion
    // #region 事件处理器
    /**
     * 页码切换事件
     * @param event event
     */
    pageChangedHandler(event) {
        let { pageIndex, pageSize } = event;
        if (pageIndex < 1) {
            pageIndex = 1;
        }
        const skip = (pageIndex - 1) * pageSize;
        this.bindingData.setPagingInfo(skip, pageSize, this.bindingData.bindingPath);
    }
    /**
     * 行切换事件
     * @param event event
     */
    selectedRowChanged(event) {
        const { index, data } = event;
        const id = data[this.primaryKey];
        this.setSelectionIdToBindingData(id);
        this.fireSelectedRowChange(event);
    }
    /**
     * 取消行选择事件
     * @param event event
     */
    unSelected(event) {
        if (!event) {
            return;
        }
        const { data = {} } = event;
        const id = data[this.primaryKey];
        const currentId = this.bindingList.currentId;
        if (id === currentId) {
            this.setSelectionIdToBindingData(null);
        }
        // this.fireSelectedRowChange(event);
    }
    /**
     * 勾选行发生变化
     * @param event event
     */
    checkedChanged(event) {
        event = event || [];
        const ids = event.map(item => item.id);
        this.setChecks(ids);
    }
    /**
     * 分页大小变更事件
     * @param event event
     */
    pageSizeChanged(event) {
        const { pageIndex, pageSize } = event;
        const skip = 0; //(pageIndex - 1) * pageSize;
        // this.bindingList.setPaginationInfo(skip, pageSize);
        this.bindingData.setPagingInfo(skip, pageSize, this.bindingData.bindingPath);
    }
    /**
     * grid滚动加载数据
     * @param event event
     */
    scrollY(event) {
        const { pager: pageIndex, pageSize } = event;
        const skip = (pageIndex - 1) * pageSize;
        this.bindingData.setPagingInfo(skip, pageSize, this.bindingData.bindingPath);
    }
    filterChanged(event) {
        this.filters = event;
    }
    // #endregion
    checkIfChangeMatchBindingPath(change) {
        let isMatch = false;
        if (!change || !change.path) {
            return isMatch;
        }
        const changePathArray = change.path;
        if (!changePathArray) {
            return isMatch;
        }
        if (!(this.bindingData) && !(this.bindingData.bindingPath)) {
            return isMatch;
        }
        const bingdingPathArray = this.bindingData.bindingPath.split('/');
        if (bingdingPathArray.length <= 0) {
            return isMatch;
        }
        if (changePathArray.length === 0) { // 主表
            if (this.bindingData.bindingPath === '/') {
                isMatch = true;
            }
        }
        else if (change.path.length === 1) { // 主从表
            if (bingdingPathArray.length === 2 && bingdingPathArray[1] === change.path[0]) {
                isMatch = true;
            }
        }
        else if (change.path.length === 2) { // 主从从表
            if (bingdingPathArray.length === 3 && bingdingPathArray[1] === change.path[0] && bingdingPathArray[2] === change.path[1]) {
                isMatch = true;
            }
        }
        return isMatch;
    }
    debounce(callback, wait) {
        let timeoutId = null;
        return (...args) => {
            window.clearTimeout(timeoutId);
            timeoutId = window.setTimeout(() => {
                callback.apply(null, args);
            }, wait);
        };
    }
}
FarrisDatagridUseBindingDataDirective.decorators = [
    { type: Directive, args: [{
                selector: '[farris-use-binding-data]'
            },] }
];
/** @nocollapse */
FarrisDatagridUseBindingDataDirective.ctorParameters = () => [
    { type: BindingData },
    { type: ViewModel },
    { type: DatagridComponent }
];
FarrisDatagridUseBindingDataDirective.propDecorators = {
    selectedRowChange: [{ type: Output }],
    pageChangedHandler: [{ type: HostListener, args: ['pageChanged', ['$event'],] }],
    selectedRowChanged: [{ type: HostListener, args: ['selectChanged', ['$event'],] }],
    unSelected: [{ type: HostListener, args: ['unSelect', ['$event'],] }],
    checkedChanged: [{ type: HostListener, args: ['checkedChange', ['$event'],] }],
    pageSizeChanged: [{ type: HostListener, args: ['pageSizeChanged', ['$event'],] }],
    scrollY: [{ type: HostListener, args: ['scrollYLoad', ['$event'],] }],
    filterChanged: [{ type: HostListener, args: ['filterChanged', ['$event'],] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzLWRhdGFncmlkLXVzZS1iaW5kaW5nLWRhdGEuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9rZW5kby1iaW5kaW5nLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZXMvZmFycmlzLWRhdGFncmlkL2ZhcnJpcy1kYXRhZ3JpZC11c2UtYmluZGluZy1kYXRhLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUErQyxZQUFZLEVBQ3BFLFlBQVksRUFBRSxNQUFNLEVBQ3JCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxPQUFPLEVBQWdCLE1BQU0sTUFBTSxDQUFDO0FBQzdDLE9BQU8sRUFBRSxXQUFXLEVBQXVCLFVBQVUsRUFBRSxTQUFTLEVBQWdCLFlBQVksRUFBRSxtQkFBbUIsRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFLGNBQWMsRUFBRSxnQ0FBZ0MsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3BOLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEQsa0NBQWtDO0FBRWxDOztHQUVHO0FBSUgsTUFBTSxPQUFPLHFDQUFxQztJQThCaEQsOEJBQThCO0lBQzlCLFlBQW1CLFdBQXdCLEVBQVMsU0FBb0IsRUFBUyxJQUF1QjtRQUFyRixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUFTLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFBUyxTQUFJLEdBQUosSUFBSSxDQUFtQjtRQTdCeEcsT0FBTztRQUNDLGVBQVUsR0FBVyxJQUFJLENBQUM7UUFDbEMsT0FBTztRQUNDLG1CQUFjLEdBQVcsSUFBSSxDQUFDO1FBQ3RDOztXQUVHO1FBQ0ssY0FBUyxHQUFHLEtBQUssQ0FBQztRQUMxQjs7V0FFRztRQUNLLFlBQU8sR0FBUSxJQUFJLENBQUM7UUFRNUI7O1dBRUc7UUFDSyxzQkFBaUIsR0FBaUIsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQUNyRCx3QkFBbUIsR0FBRyxLQUFLLENBQUM7UUFDcEM7O1dBRUc7UUFDTyxzQkFBaUIsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUd2RSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ25CLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQVUsZ0NBQWdDLEVBQUUsS0FBSyxDQUFDLElBQUksS0FBSyxDQUFDO1FBQ2hMLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBckJELElBQWMsS0FBSztRQUNqQixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDckIsQ0FBQztJQUNELElBQWMsS0FBSyxDQUFDLEtBQUs7UUFDdkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUM7SUFDdEIsQ0FBQztJQWtCRCxtQkFBbUI7SUFFbkIsUUFBUTtRQUNOLE1BQU0sRUFBRSxRQUFRLEdBQUcsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxJQUFJLEVBQUUsQ0FBQztRQUNwRCxJQUFJLFFBQVEsS0FBSyxDQUFDLEVBQUU7WUFDbEIsT0FBTztZQUNQLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsSUFBSSxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssVUFBVSxFQUFFO2dCQUM1RyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLFFBQVEsR0FBRyxDQUFDLEVBQUUsUUFBUSxHQUFHLENBQUMsRUFBRSxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUNoRjtTQUNGO1FBQ0QsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNoQixNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNyQixJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUMzQixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDTixJQUFJLENBQUMsOEJBQThCLEVBQUUsQ0FBQztRQUN0QyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQWMsRUFBRSxFQUFFO1lBQzFFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFO2dCQUM3RixPQUFPO2FBQ1I7WUFDRCxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3RCOzs7Ozs4Q0FLa0M7UUFDcEMsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsY0FBYyxFQUFFO1lBQy9GLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLGNBQWMsQ0FBQyxhQUFhLEdBQUcsYUFBYSxDQUFDLHVCQUF1QixDQUFDO1NBQ2xHO0lBQ0gsQ0FBQztJQUVELFdBQVcsQ0FBQyxPQUFzQjtRQUNoQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDbEIsQ0FBQztJQUVELGFBQWE7SUFHYjs7T0FFRztJQUNILElBQWMsVUFBVTtRQUN0QixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDO0lBQ3JDLENBQUM7SUFDRDs7T0FFRztJQUNILElBQWMsV0FBVztRQUN2QixNQUFNO1FBQ04sSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRTtZQUNyRSxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO1NBQzlCO1FBQ0QsTUFBTTtRQUNOLElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2RCxXQUFXLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxHQUFHLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMxRixNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXJDLE1BQU0sYUFBYSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFZLEVBQUUsRUFBRTtZQUNsRCxPQUFPLElBQUksS0FBSyxFQUFFLENBQUM7UUFDckIsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFDRDs7T0FFRztJQUNLLGVBQWU7UUFDckIsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQ3BILE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDO1FBQ3JHLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDckMsMkNBQTJDO1FBQzNDLElBQUksQ0FBQyxPQUFPLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDbkIsT0FBTztTQUNSO1FBQ0QsTUFBTSxHQUFHLEdBQUcsVUFBVSxJQUFJLFVBQVUsQ0FBQyxhQUFhLElBQUksVUFBVSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxHQUFHLEVBQWUsQ0FBQztRQUN0SCxVQUFVLElBQUksVUFBVSxDQUFDLGFBQWEsSUFBSSxVQUFVLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDMUcsQ0FBQztJQUNEOztPQUVHO0lBQ08sYUFBYTtRQUNyQixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQztRQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQztRQUMvQyxNQUFNLFVBQVUsR0FBRyxXQUFXLElBQUksV0FBVyxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUM7UUFDL0QsSUFBSSxXQUFXLEtBQUssR0FBRyxFQUFFO1lBQ3ZCLE9BQU8sVUFBVSxDQUFDO1NBQ25CO2FBQU07WUFDTCxNQUFNLFlBQVksR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNsRyw4RUFBOEU7WUFDOUUsK0VBQStFO1lBQy9FLHFCQUFxQjtZQUNyQixJQUFJLFFBQVEsR0FBRyxZQUFZLENBQUMsWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNyRCxRQUFRLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNuRCxjQUFjO1lBQ2QsNkNBQTZDO1lBQzdDLDZDQUE2QztZQUM3QyxzQ0FBc0M7WUFDdEMsSUFBSTtZQUNKLGlCQUFpQjtZQUVqQixNQUFNLEtBQUssR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxZQUFZLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzdELE1BQU0sV0FBVyxHQUFHLFdBQVcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFnQixDQUFDO1lBQy9ELE1BQU0sRUFBRSxRQUFRLEdBQUcsQ0FBQyxFQUFFLEdBQUcsVUFBVSxDQUFDLEdBQUcsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDekQsU0FBUztZQUNULElBQUksV0FBVyxJQUFJLFdBQVcsQ0FBQyxTQUFTLEVBQUU7Z0JBQ3hDLE1BQU0sR0FBRyxHQUFHLEdBQUcsUUFBUSxJQUFJLFdBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDbkQsd0JBQXdCO2dCQUN4QixNQUFNLE1BQU0sR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNyQyxJQUFJLE1BQU0sQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLEVBQUU7b0JBQ3ZDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQztpQkFDbEM7Z0JBQ0Qsb0ZBQW9GO2dCQUNwRixJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtvQkFDbEMsTUFBTSxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUM7b0JBQ3JCLE1BQU0sQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO2lCQUM1QjtnQkFDRCxPQUFPLE1BQU0sQ0FBQzthQUNmO2lCQUFNO2dCQUNMLDBDQUEwQztnQkFDMUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLENBQUM7YUFDbkM7U0FDRjtJQUNILENBQUM7SUFFRCxnQkFBZ0I7SUFDaEI7Ozs7O09BS0c7SUFDTyxxQkFBcUIsQ0FBQyxNQUFjLEVBQUUsSUFBUztRQUN2RCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BDLElBQUksSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLE9BQU8sS0FBSyxPQUFPLENBQUMsU0FBUyxJQUFJLE1BQU0sRUFBRTtZQUM3SyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLElBQUksSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsb0JBQW9CLEVBQUU7Z0JBQzNILE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDO2FBQ2hDO1NBQ0Y7UUFDRCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDeEMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDdkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQztTQUMxQjtRQUNELE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDO0lBQ2pDLENBQUM7SUFDUyxhQUFhO1FBQ3JCLE9BQU87UUFDUCxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEtBQVUsRUFBRSxFQUFFO1lBQ3JGLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1lBQzFDLE9BQU87WUFDUCxJQUFJLENBQUMsWUFBWSxFQUFFO2dCQUNqQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO2dCQUNyQyxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO2dCQUMxQyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7Z0JBQ3ZCLGtDQUFrQzthQUNuQztpQkFBTTtnQkFDTCxTQUFTO2dCQUNULE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDO2dCQUM3RCxJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUMzRSxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNsRixJQUFJLFVBQVUsRUFBRTtvQkFDZCxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsRUFBRTt3QkFDcEMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDO3dCQUNwQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7cUJBQ25DO2lCQUNGO2dCQUNELHdCQUF3QjtnQkFDeEIsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQztnQkFFL0YsSUFBSSxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtvQkFDekIsSUFBSSxVQUFVLEVBQUU7d0JBQ2QsTUFBTSxZQUFZLEdBQUcsSUFBSSxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7d0JBQ2xELFVBQVUsR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFOzRCQUNsQywyQ0FBMkM7NEJBQzNDLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7NEJBQy9CLE1BQU0sUUFBUSxHQUFHLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQzs0QkFDdkQsTUFBTSxhQUFhLEdBQUcsUUFBUSxJQUFJLFFBQVEsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDOzRCQUN4RSxPQUFPLGFBQWEsQ0FBQzs0QkFDckIsR0FBRzs0QkFDSCxlQUFlO3dCQUNqQixDQUFDLENBQUMsQ0FBQztxQkFDSjtpQkFDRjtnQkFDRCx1Q0FBdUM7Z0JBQ3ZDLE1BQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ3BDLE1BQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksS0FBSyxDQUFDO2dCQUNwRCxNQUFNLFlBQVksR0FBaUIsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUM7Z0JBQ3pGLElBQUksWUFBWSxFQUFFO29CQUNoQixZQUFZLENBQUMsVUFBVSxDQUFDLG9CQUFvQixDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUM7aUJBQzVHO2FBQ0Y7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU87UUFDUCxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEtBQVUsRUFBRSxFQUFFO1lBQ3ZGLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO1lBQ3JCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtnQkFDM0IsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRTtvQkFDOUQsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzVDLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2lCQUNuQztnQkFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ3RDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQzthQUNqQjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUN2RSxJQUFJLE9BQU8sSUFBSSxPQUFPLEtBQUssc0JBQXNCLElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUN6RyxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztnQkFDbEIsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2FBQ2pCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssZUFBZSxDQUFDLE1BQWU7UUFDckMsNEJBQTRCO1FBQzVCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDO1FBQzdELElBQUksVUFBVSxFQUFFO1lBQ2QsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDMUUsTUFBTSxXQUFXLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNwRCxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBYSxFQUFFLEVBQUU7Z0JBQ3BDLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFO29CQUNsQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7b0JBQ2xDLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGNBQWMsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7b0JBQ3JGLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO29CQUNyQyxJQUFJLENBQUMsVUFBVSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQzFDLElBQUksQ0FBQyxjQUFjLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEtBQUssQ0FBQztpQkFDM0Q7WUFDSCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBQ0QsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDOUQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN4QixDQUFDO0lBQ0QsYUFBYTtJQUViLGlCQUFpQjtJQUNqQjs7O09BR0c7SUFDSCxRQUFRLENBQUMsTUFBZTtRQUN0QixNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxJQUFJLEtBQUssQ0FBQztRQUNwRSxRQUFRO1FBQ1IsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMzQyxJQUFJLFVBQVUsRUFBRTtZQUNkLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1lBQ3RCLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDN0IsT0FBTztTQUNSO1FBQ0QsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7UUFDdkIsZ0JBQWdCO1FBQ2hCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsS0FBSyxJQUFJLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUMzSixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLDJCQUEyQixJQUFJLENBQUMsSUFBSSxDQUFDLG1CQUFtQixFQUFFO2dCQUNwRyxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztnQkFDbEIsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQzthQUM1QjtTQUNGO1FBQ0QsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNyRCxJQUFJLGVBQWUsRUFBRTtZQUNuQixJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDdkM7UUFDRCxVQUFVO1FBQ1YsTUFBTSxJQUFJLEdBQVEsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUM1QyxpRkFBaUY7UUFDakYsK0VBQStFO1FBQy9FLElBQUk7UUFFSixJQUFJLElBQUksQ0FBQyxPQUFPLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLGNBQWMsSUFBSSxDQUFDLENBQUMsTUFBTSxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxnQkFBZ0IsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQyxFQUFFO1lBQ3RNLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUMzQixrQkFBa0I7Z0JBQ2xCLE1BQU0sR0FBRyxHQUFJLElBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxLQUFLLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQzFHLElBQUksQ0FBQyxHQUFHLEVBQUU7b0JBQ1IsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUM7b0JBQ3hELElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7aUJBQ3ZEO2FBQ0Y7aUJBQU07Z0JBQ0wsZUFBZTtnQkFDZixxQ0FBcUM7Z0JBQ3JDLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLEVBQUU7b0JBQzlCLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO2lCQUN2RDtnQkFDRCxXQUFXO2dCQUNYLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtvQkFDMUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDcEI7YUFDRjtTQUNGO1FBQ0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRTtZQUNsQixPQUFPO1NBQ1I7UUFDRCw2Q0FBNkM7UUFDN0MsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDOUIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUNEOzs7O09BSUc7SUFDSyxlQUFlLENBQUMsTUFBZTtRQUNyQyxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxJQUFJLEtBQUssQ0FBQztRQUNwRSxpQkFBaUI7UUFDakIsSUFBSSxjQUFjLEtBQUssSUFBSSxFQUFFO1lBQzNCLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFDRCxpQkFBaUI7UUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN6RCxPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBSSxNQUFNLEVBQUU7WUFDVixPQUFPLE1BQU0sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLElBQUksQ0FBQztTQUN4QztRQUNELE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUM3QixDQUFDO0lBQ08sVUFBVSxDQUFDLE1BQWU7UUFDaEMscUhBQXFIO1FBQ3JILElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDL0QsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUNELElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNsQixPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBSSxNQUFNLEVBQUU7WUFDVixPQUFPLE1BQU0sQ0FBQyxJQUFJLEtBQUssTUFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssa0JBQWtCLENBQUM7U0FDckU7UUFDRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO0lBQzVCLENBQUM7SUFDRDs7O09BR0c7SUFDSyxVQUFVLENBQUMsS0FBVTtRQUMzQixNQUFNLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxHQUFHLEtBQUssQ0FBQztRQUMvRCxNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixJQUFJLEtBQUssQ0FBQztRQUNoRSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDeEIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQzlCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztRQUNoQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxLQUFLLENBQUM7UUFDekMsc0JBQXNCO1FBQ3RCLElBQUksUUFBUSxLQUFLLENBQUMsRUFBRTtZQUNsQixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7WUFDN0IsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDO1lBQ3hCLDBCQUEwQjtZQUMxQiw4QkFBOEI7U0FDL0I7UUFDRCxJQUFJLGVBQWUsRUFBRTtZQUNuQixJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQztnQkFDeEIsS0FBSyxFQUFFLElBQUk7Z0JBQ1gsU0FBUztnQkFDVCxRQUFRO2dCQUNSLEtBQUs7YUFDTixDQUFDLENBQUM7U0FDSjthQUFNO1lBQ0wsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDMUI7SUFDSCxDQUFDO0lBQ0Q7O09BRUc7SUFDTyxVQUFVLENBQUMsS0FBa0I7UUFDckMsSUFBSSxJQUFJLENBQUM7UUFDVCxJQUFJLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxXQUFXLEVBQUU7WUFDbEMsSUFBSSxHQUFHLEtBQUssQ0FBQztTQUNkO2FBQU07WUFDTCxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUNsQztRQUNELGdCQUFnQjtRQUNoQixJQUFJLEVBQUUsU0FBUyxHQUFHLENBQUMsRUFBRSxRQUFRLEdBQUcsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxJQUFJLEVBQUUsQ0FBQztRQUNqRSxJQUFJLEVBQUUsS0FBSyxHQUFHLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFDL0MsdUJBQXVCO1FBQ3ZCLHVDQUF1QztRQUN2QyxJQUFJO1FBQ0osSUFBSSxRQUFRLEtBQUssQ0FBQyxJQUFJLEtBQUssS0FBSyxDQUFDLEVBQUU7WUFDakMsS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7U0FDckI7UUFDRCxPQUFPLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxRQUFRLEtBQUssQ0FBQyxFQUFFLENBQUM7SUFDMUUsQ0FBQztJQUNEOztPQUVHO0lBQ0ssY0FBYztRQUNwQixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUM7UUFDbEMsSUFBSSxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ2IsTUFBTSxFQUFFLFNBQVMsR0FBRyxDQUFDLEVBQUUsUUFBUSxHQUFHLENBQUMsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3pHLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQztRQUNqQyxJQUFJLFNBQVMsR0FBRyxDQUFDLEVBQUU7WUFDakIsSUFBSSxHQUFHLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQyxHQUFHLFFBQVEsQ0FBQztTQUNuQztRQUNELElBQUksUUFBUSxLQUFLLENBQUMsSUFBSSxLQUFLLEtBQUssQ0FBQyxFQUFFO1lBQ2pDLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1NBQ3JCO1FBQ0QsT0FBTyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUNoRixDQUFDO0lBQ0Q7OztPQUdHO0lBQ08sbUJBQW1CLENBQUMsTUFBYztRQUMxQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDOUIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQy9CLDJCQUEyQjtRQUMzQixrQkFBa0I7UUFDbEIsaUNBQWlDO1FBQ2pDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDekIsVUFBVTtRQUNWLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFDRDs7T0FFRztJQUNLLGdCQUFnQixDQUFDLE1BQWM7UUFDckMsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsWUFBWSxFQUFFO1lBQ3JELGdCQUFnQjtZQUNoQixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDO1lBQzFCLElBQUk7Z0JBQ0YsTUFBTSxVQUFVLEdBQUcsY0FBYyxDQUFDLHdDQUF3QyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUM7Z0JBQ3pJLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEtBQUssR0FBRyxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7b0JBQzdELE1BQU0sYUFBYSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUNyRCxJQUFJLE1BQU0sQ0FBQyxFQUFFLElBQUksSUFBSSxDQUFDLElBQUksSUFBSSxNQUFNLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEtBQUssT0FBTyxDQUFDLFNBQVMsSUFBSSxhQUFhLElBQUksYUFBYSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7d0JBQzlKLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztxQkFDN0U7aUJBQ0Y7YUFDRjtZQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUNkLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDckI7WUFDRCxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3JDO2FBQU0sSUFBSSxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxnQkFBZ0IsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQyxFQUFFO1lBQ3ZILElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLEVBQUU7YUFDOUc7aUJBQU07Z0JBQ0wsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQzthQUN2QjtTQUNGO2FBQU07WUFDTCxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3ZCO0lBQ0gsQ0FBQztJQUNELDBCQUEwQjtJQUMxQiw2Q0FBNkM7SUFDN0MscUJBQXFCO0lBQ3JCLCtCQUErQjtJQUMvQixNQUFNO0lBQ04sSUFBSTtJQUNJLFdBQVcsQ0FBQyxNQUFjO1FBQ2hDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDeEMsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxJQUFJLElBQUksU0FBUyxFQUFFO1lBQ2hELElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDekI7SUFDSCxDQUFDO0lBQ0Q7OztPQUdHO0lBQ0ssaUJBQWlCLENBQUMsTUFBZTtRQUN2QyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFO1lBQ3BELE9BQU87U0FDUjtRQUNELGdCQUFnQjtRQUNoQixJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxvQkFBb0IsRUFBRTtZQUM3RCxPQUFPO1NBQ1I7UUFDRCxJQUFJLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLHVCQUF1QixLQUFLLElBQUksRUFBRTtZQUM5RixPQUFPO1NBQ1I7UUFDRCxNQUFNLEVBQUUsRUFBRSxFQUFFLGlCQUFpQixHQUFHLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQztRQUNyRSxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQztRQUM3QyxnQ0FBZ0M7UUFDaEMsSUFBSSxpQkFBaUIsS0FBSyxTQUFTLEVBQUU7WUFDbkMsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsS0FBSyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztZQUN2SCxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxJQUFJLElBQUksT0FBTyxFQUFFO2dCQUN4RCxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO2dCQUM1QixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO2FBQzVDO1lBQ0QsT0FBTztTQUNSO1FBQ0QsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFDRDs7T0FFRztJQUNLLDhCQUE4QjtRQUNwQyxJQUFJLENBQUMsc0JBQXNCLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBYyxFQUFFLEVBQUU7WUFDbEYsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ25DLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDckUsSUFBSSxPQUFPLEtBQUssVUFBVSxFQUFFO2dCQUMxQixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7YUFDakI7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDRDs7T0FFRztJQUNLLGdDQUFnQztRQUN0QyxJQUFJLElBQUksQ0FBQyxzQkFBc0IsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFdBQVcsQ0FBQyxLQUFLLFVBQVUsRUFBRTtZQUNsRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDM0M7SUFDSCxDQUFDO0lBQ0Q7Ozs7T0FJRztJQUNLLFVBQVUsQ0FBQyxNQUFlO1FBQ2hDLElBQUksQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLGdCQUFnQixJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUU7WUFDakcsT0FBTztTQUNSO1FBQ0QsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUM7UUFDL0MsTUFBTSxnQkFBZ0IsR0FBRyxHQUFHLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDckQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLElBQUksS0FBSyxDQUFDO1FBQzdGLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLFdBQVcsS0FBSyxHQUFHLElBQUksV0FBVyxLQUFLLGdCQUFnQixJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFO1lBQ2xJLE9BQU87U0FDUjtRQUNELDhDQUE4QztRQUM5QyxJQUFJLFVBQVUsRUFBRTtZQUNkLE9BQU87U0FDUjtRQUNELE1BQU0sU0FBUyxHQUFHLG1CQUFtQixDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN0RyxNQUFNLEtBQUssR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3ZELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDO1FBQ3ZDLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3JELFVBQVU7UUFDVixJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2IsT0FBTztTQUNSO1FBQ0QsYUFBYTtRQUNiLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoRixJQUFJLFFBQVEsR0FBRyxZQUFZLENBQUMsWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNyRCxRQUFRLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNuRCxpREFBaUQ7UUFDakQsTUFBTSxVQUFVLEdBQUcsSUFBSSxRQUFRLEVBQUUsQ0FBQztRQUNsQyxJQUFJLEVBQUUsU0FBUyxHQUFHLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyx5QkFBeUIsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDNUgsTUFBTSxFQUFFLFFBQVEsR0FBRyxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMseUJBQXlCLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDO1FBRTdILE1BQU0sY0FBYyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDM0QsTUFBTSxnQkFBZ0IsR0FBRyxHQUFHLEdBQUcsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsY0FBYyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztRQUN0RixNQUFNLEVBQUUsUUFBUSxFQUFFLGNBQWMsR0FBRyxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMseUJBQXlCLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDbkosTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLElBQUksS0FBSyxDQUFDO1FBQzlGLElBQUksWUFBWSxFQUFFO1lBQ2hCLHNFQUFzRTtZQUN0RSxTQUFTLEdBQUcsQ0FBQyxDQUFDO1NBQ2Y7UUFDRCxXQUFXO1FBQ1gsSUFBSSxjQUFjLEdBQUcsUUFBUSxLQUFLLENBQUMsRUFBRTtZQUNuQyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUMzRSxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUNoRixRQUFRLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUN4RixDQUFDLFNBQVMsRUFBRSxDQUFDO1NBQ2Y7SUFDSCxDQUFDO0lBQ0QsV0FBVztRQUNULElBQUksQ0FBQyxnQ0FBZ0MsRUFBRSxDQUFDO0lBQzFDLENBQUM7SUFDRCxhQUFhO0lBRWIsZ0JBQWdCO0lBRWhCOzs7T0FHRztJQUNPLHFCQUFxQixDQUFDLGtCQUF1QjtRQUNyRCxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUNEOzs7T0FHRztJQUNLLGdCQUFnQixDQUFDLE1BQWM7UUFDckMsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDNUQsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLDZCQUE2QixDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzNELElBQUksT0FBTyxFQUFFO2dCQUNYLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ25CLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssVUFBVSxFQUFFO29CQUNuRCxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO2lCQUMzQjthQUNGO1NBQ0Y7SUFDSCxDQUFDO0lBRUQsYUFBYTtJQUliLGFBQWE7SUFFYjs7O09BR0c7SUFDTywyQkFBMkIsQ0FBQyxFQUFVO1FBQzlDLGlCQUFpQjtRQUNqQixJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ1AsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1lBQ2hDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtnQkFDMUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUNwQjtZQUNELE9BQU87U0FDUjtRQUNELElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLEtBQUssRUFBRSxFQUFFO1lBQ3JDLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztTQUN6QztRQUNELGtCQUFrQjtRQUNsQixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDMUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDdEI7SUFDSCxDQUFDO0lBQ08saUJBQWlCLENBQUMsT0FBZTtRQUN2QyxJQUFJLE9BQU8sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLElBQUksRUFBRTtZQUNwQyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7U0FDdkI7YUFBTSxJQUFJLE9BQU8sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLFlBQVksRUFBRTtZQUNuRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDN0IsSUFBSSxPQUFPLENBQUMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFO2dCQUMxQyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7YUFDdkI7U0FDRjtJQUNILENBQUM7SUFDRDs7T0FFRztJQUNPLFNBQVMsQ0FBQyxHQUFhO1FBQy9CLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFDRDs7O09BR0c7SUFDTyxTQUFTO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQzdDLENBQUM7SUFDRDs7T0FFRztJQUNPLGNBQWMsQ0FBQyxHQUFjO1FBQ3JDLGdCQUFnQjtRQUNoQiw4RUFBOEU7UUFDOUUsWUFBWTtRQUNaLElBQUk7UUFDSixJQUFJLE9BQU8sR0FBRyxLQUFLLFdBQVcsRUFBRTtZQUM5QixHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1NBQzNDO1FBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDekMsc0JBQXNCO1lBQ3RCLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztZQUN0RCxPQUFPO1NBQ1I7UUFDRCxJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7UUFDZCx3RUFBd0U7UUFDeEUsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsT0FBTyxLQUFLLE9BQU8sQ0FBQyxTQUFTLEVBQUU7WUFDeEUsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQztTQUM3QjthQUFNO1lBQ0wsSUFBSSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEVBQUUsb0JBQW9CLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztTQUNoRTtRQUNELE1BQU0sSUFBSSxHQUFxQixJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxJQUFJLEdBQUcsRUFBZSxDQUFDO1FBRXhGLE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxFQUFlLENBQUM7UUFDdEMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQU8sRUFBRSxFQUFFO1lBQ3RCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQzdELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDbkMsSUFBSSxJQUFJLEVBQUU7Z0JBQ1IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDdEI7aUJBQU0sSUFBSSxhQUFhLEVBQUU7Z0JBQ3hCLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLGFBQWEsQ0FBQyxDQUFDO2FBQy9CO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDMUQsQ0FBQztJQUNEOzs7T0FHRztJQUNPLGFBQWEsQ0FBQyxFQUFPO1FBQzdCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztJQUNqQyxDQUFDO0lBQ0QsYUFBYTtJQUNiLGdCQUFnQjtJQUVoQjs7O09BR0c7SUFFSSxrQkFBa0IsQ0FBQyxLQUFVO1FBQ2xDLElBQUksRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLEdBQUcsS0FBSyxDQUFDO1FBQ3BDLElBQUksU0FBUyxHQUFHLENBQUMsRUFBRTtZQUNqQixTQUFTLEdBQUcsQ0FBQyxDQUFDO1NBQ2Y7UUFDRCxNQUFNLElBQUksR0FBRyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUM7UUFDeEMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFFRDs7O09BR0c7SUFFSSxrQkFBa0IsQ0FBQyxLQUFVO1FBQ2xDLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEdBQUcsS0FBSyxDQUFDO1FBQzlCLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDakMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQ7OztPQUdHO0lBRUksVUFBVSxDQUFDLEtBQVU7UUFDMUIsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNWLE9BQU87U0FDUjtRQUNELE1BQU0sRUFBRSxJQUFJLEdBQUcsRUFBRSxFQUFFLEdBQUcsS0FBSyxDQUFDO1FBQzVCLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDakMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUM7UUFDN0MsSUFBSSxFQUFFLEtBQUssU0FBUyxFQUFFO1lBQ3BCLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN4QztRQUNELHFDQUFxQztJQUN2QyxDQUFDO0lBQ0Q7OztPQUdHO0lBRUksY0FBYyxDQUFDLEtBQVU7UUFDOUIsS0FBSyxHQUFHLEtBQUssSUFBSSxFQUFFLENBQUM7UUFDcEIsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN2QyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFDRDs7O09BR0c7SUFFSSxlQUFlLENBQUMsS0FBVTtRQUMvQixNQUFNLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxHQUFHLEtBQUssQ0FBQztRQUN0QyxNQUFNLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQSw2QkFBNkI7UUFDNUMsc0RBQXNEO1FBQ3RELElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUMvRSxDQUFDO0lBRUQ7OztPQUdHO0lBRUksT0FBTyxDQUFDLEtBQVU7UUFDdkIsTUFBTSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLEdBQUcsS0FBSyxDQUFDO1FBQzdDLE1BQU0sSUFBSSxHQUFHLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQyxHQUFHLFFBQVEsQ0FBQztRQUN4QyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDL0UsQ0FBQztJQUVNLGFBQWEsQ0FBQyxLQUFVO1FBQzdCLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO0lBQ3ZCLENBQUM7SUFDRCxhQUFhO0lBQ0wsNkJBQTZCLENBQUMsTUFBYztRQUNsRCxJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDcEIsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUU7WUFDM0IsT0FBTyxPQUFPLENBQUM7U0FDaEI7UUFFRCxNQUFNLGVBQWUsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ3BDLElBQUksQ0FBQyxlQUFlLEVBQUU7WUFDcEIsT0FBTyxPQUFPLENBQUM7U0FDaEI7UUFFRCxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLEVBQUU7WUFDMUQsT0FBTyxPQUFPLENBQUM7U0FDaEI7UUFDRCxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsRSxJQUFJLGlCQUFpQixDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUU7WUFDakMsT0FBTyxPQUFPLENBQUM7U0FDaEI7UUFFRCxJQUFJLGVBQWUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLEVBQUUsS0FBSztZQUN2QyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxLQUFLLEdBQUcsRUFBRTtnQkFDeEMsT0FBTyxHQUFHLElBQUksQ0FBQzthQUNoQjtTQUNGO2FBQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsRUFBQyxNQUFNO1lBQzFDLElBQUksaUJBQWlCLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsS0FBSyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUM3RSxPQUFPLEdBQUcsSUFBSSxDQUFDO2FBQ2hCO1NBQ0Y7YUFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxFQUFFLE9BQU87WUFDNUMsSUFBSSxpQkFBaUIsQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxLQUFLLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksaUJBQWlCLENBQUMsQ0FBQyxDQUFDLEtBQUssTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRTtnQkFDeEgsT0FBTyxHQUFHLElBQUksQ0FBQzthQUNoQjtTQUNGO1FBRUQsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUNPLFFBQVEsQ0FBQyxRQUEwQixFQUFFLElBQUk7UUFDL0MsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLE9BQU8sQ0FBQyxHQUFHLElBQUksRUFBRSxFQUFFO1lBQ2pCLE1BQU0sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDL0IsU0FBUyxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFO2dCQUNqQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztZQUM3QixDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDWCxDQUFDLENBQUM7SUFDSixDQUFDOzs7WUE3MEJGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsMkJBQTJCO2FBQ3RDOzs7O1lBVlEsV0FBVztZQUFtQyxTQUFTO1lBQ3ZELGlCQUFpQjs7O2dDQXVDdkIsTUFBTTtpQ0FzckJOLFlBQVksU0FBQyxhQUFhLEVBQUUsQ0FBQyxRQUFRLENBQUM7aUNBY3RDLFlBQVksU0FBQyxlQUFlLEVBQUUsQ0FBQyxRQUFRLENBQUM7eUJBWXhDLFlBQVksU0FBQyxVQUFVLEVBQUUsQ0FBQyxRQUFRLENBQUM7NkJBaUJuQyxZQUFZLFNBQUMsZUFBZSxFQUFFLENBQUMsUUFBUSxDQUFDOzhCQVV4QyxZQUFZLFNBQUMsaUJBQWlCLEVBQUUsQ0FBQyxRQUFRLENBQUM7c0JBWTFDLFlBQVksU0FBQyxhQUFhLEVBQUUsQ0FBQyxRQUFRLENBQUM7NEJBTXRDLFlBQVksU0FBQyxlQUFlLEVBQUUsQ0FBQyxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIERpcmVjdGl2ZSwgT25Jbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSwgU2ltcGxlQ2hhbmdlcywgSG9zdExpc3RlbmVyLFxyXG4gIEV2ZW50RW1pdHRlciwgT3V0cHV0XHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBCaW5kaW5nRGF0YSwgQmluZGluZ0xpc3QsIENoYW5nZSwgQ2hhbmdlVHlwZSwgVmlld01vZGVsLCBGcmFtZUNvbnRleHQsIERhdGFUeXBlSW5mbywgRW50aXR5UGF0aENvbnZlcnRlciwgUnVuTW9kZSwgQ29tcG9uZW50VHlwZSwgRXhwcmVzc2lvblV0aWwsIEVOQUJMRV9FRElUX1NUQVRFX0ZJTFRFUl9TT1JUSU5HIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBEYXRhZ3JpZENvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YWdyaWQnO1xyXG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUsIGZpbmFsaXplIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZTogbWF4LWxpbmUtbGVuZ3RoXHJcblxyXG4vKlxyXG4gKiDkvb/nlKjnu5HlrprmlbDmja7mjIfku6RcclxuICovXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW2ZhcnJpcy11c2UtYmluZGluZy1kYXRhXSdcclxufSlcclxuZXhwb3J0IGNsYXNzIEZhcnJpc0RhdGFncmlkVXNlQmluZGluZ0RhdGFEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcclxuICBwcml2YXRlIF9QUk9QUzogeyBbcHJvcE5hbWU6IHN0cmluZ106IGFueSB9O1xyXG4gIC8vIOaOkuW6j+Wtl+autVxyXG4gIHByaXZhdGUgc29ydEZpZWxkczogc3RyaW5nID0gbnVsbDtcclxuICAvLyDmjpLluo/mlrnlkJFcclxuICBwcml2YXRlIHNvcnREaXJlY3Rpb25zOiBzdHJpbmcgPSBudWxsO1xyXG4gIC8qKlxyXG4gICAqIOaYr+WQpuW3suaOkuW6j1xyXG4gICAqL1xyXG4gIHByaXZhdGUgaGFzU29ydGVkID0gZmFsc2U7XHJcbiAgLyoqXHJcbiAgICog6L+H5ruk5p2h5Lu2XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmaWx0ZXJzOiBhbnkgPSBudWxsO1xyXG4gIHByb3RlY3RlZCBnZXQgcHJvcHMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fUFJPUFM7XHJcbiAgfVxyXG4gIHByb3RlY3RlZCBzZXQgcHJvcHModmFsdWUpIHtcclxuICAgIHRoaXMuX1BST1BTID0gdmFsdWU7XHJcbiAgfVxyXG4gIHByb3RlY3RlZCBiaW5kaW5nRGF0YUNoYW5nZUV2ZW50OiBTdWJzY3JpcHRpb247XHJcbiAgLyoqXHJcbiAgICog5riy5p+TZ3JpZFxyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVuZGVyR3JpZFN1YmplY3Q6IFN1YmplY3Q8YW55PiA9IG5ldyBTdWJqZWN0PGFueT4oKTtcclxuICBwcml2YXRlIGVuYWJsZUZpbHRlclNvcnRpbmcgPSBmYWxzZTtcclxuICAvKipcclxuICAgKiDpgInkuK3ooYzliIfmjaLkuovku7ZcclxuICAgKi9cclxuICBAT3V0cHV0KCkgc2VsZWN0ZWRSb3dDaGFuZ2U6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcbiAgLy8gcHJpdmF0ZSByZW5kZXJHcmlkRGVib3VuY2U7XHJcbiAgY29uc3RydWN0b3IocHVibGljIGJpbmRpbmdEYXRhOiBCaW5kaW5nRGF0YSwgcHVibGljIHZpZXdNb2RlbDogVmlld01vZGVsLCBwdWJsaWMgZ3JpZDogRGF0YWdyaWRDb21wb25lbnQpIHtcclxuICAgIHRoaXMuc2V0Q2hlY2tzKFtdKTtcclxuICAgIHRoaXMuZW5hYmxlRmlsdGVyU29ydGluZyA9IHRoaXMudmlld01vZGVsICYmIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dCAmJiB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PGJvb2xlYW4+KEVOQUJMRV9FRElUX1NUQVRFX0ZJTFRFUl9TT1JUSU5HLCBmYWxzZSkgfHwgZmFsc2U7XHJcbiAgICB0aGlzLnJlZ2lzdGVyRXZlbnQoKTtcclxuICB9XHJcblxyXG4gIC8vICNyZWdpb24gTmcgRXZlbnRcclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICBjb25zdCB7IHBhZ2VTaXplID0gMCB9ID0gdGhpcy5nZXRQYWdpbmdJbmZvKCkgfHwge307XHJcbiAgICBpZiAocGFnZVNpemUgIT09IDApIHtcclxuICAgICAgLy8g5ZCv55So5YiG6aG1XHJcbiAgICAgIGlmICgoIXRoaXMuZ3JpZC5wYWdlTGlzdCB8fCB0aGlzLmdyaWQucGFnZUxpc3QubGVuZ3RoIDwgMSkgJiYgdHlwZW9mIHRoaXMuZ3JpZFsnc2V0UGFnZUxpc3QnXSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgIHRoaXMuZ3JpZFsnc2V0UGFnZUxpc3QnXShbcGFnZVNpemUsIHBhZ2VTaXplICogMiwgcGFnZVNpemUgKiAzLCBwYWdlU2l6ZSAqIDRdKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgdGhpcy5zZXRDb21wb25lbnRSZWYoKTtcclxuICAgIHRoaXMuYmluZERhdGEoKTtcclxuICAgIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgdGhpcy51cGRhdGVTZWxlY3RlZFJvdygpO1xyXG4gICAgfSwgMCk7XHJcbiAgICB0aGlzLnJlZ2lzdGVyQmluZGluZ0RhdGFDaGFuZ2VFdmVudCgpO1xyXG4gICAgdGhpcy5yZW5kZXJHcmlkU3ViamVjdC5waXBlKGRlYm91bmNlVGltZSg1MDApKS5zdWJzY3JpYmUoKGNoYW5nZTogQ2hhbmdlKSA9PiB7XHJcbiAgICAgIGlmICghdGhpcy52aWV3TW9kZWwgfHwgIXRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dCB8fCB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuaXNEaXNwb3NlZCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLmJpbmREYXRhKGNoYW5nZSk7XHJcbiAgICAgIC8qaWYgKCF0aGlzLnJlbmRlckdyaWREZWJvdW5jZSkge1xyXG4gICAgICAgIHRoaXMucmVuZGVyR3JpZERlYm91bmNlID0gdGhpcy5kZWJvdW5jZSgoY2hhbmdlKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmJpbmREYXRhKGNoYW5nZSk7XHJcbiAgICAgICAgfSwgNTAwKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnJlbmRlckdyaWREZWJvdW5jZShjaGFuZ2UpOyovXHJcbiAgICB9KTtcclxuICAgIGlmICh0aGlzLnZpZXdNb2RlbCAmJiB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQgJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmZyYW1lQ29tcG9uZW50KSB7XHJcbiAgICAgIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudC5jb21wb25lbnRUeXBlID0gQ29tcG9uZW50VHlwZS5mYXJyaXNEYXRhR3JpZENvbXBvbmVudDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcclxuICAgIHRoaXMuYmluZERhdGEoKTtcclxuICB9XHJcblxyXG4gIC8vICNlbmRyZWdpb25cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOS4u+mUrlxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBnZXQgcHJpbWFyeUtleSgpIHtcclxuICAgIHJldHVybiB0aGlzLmJpbmRpbmdMaXN0LnByaW1hcnlLZXk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlue7keWumuaVsOaNrlxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBnZXQgYmluZGluZ0xpc3QoKTogQmluZGluZ0xpc3Qge1xyXG4gICAgLy8g5qC55a6e5L2TXHJcbiAgICBpZiAodGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09ICcvJyB8fCAhdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGgpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuYmluZGluZ0RhdGEubGlzdDtcclxuICAgIH1cclxuICAgIC8vIOWtkOWunuS9k1xyXG4gICAgbGV0IGJpbmRpbmdQYXRoID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGguc3Vic3RyKDEpO1xyXG4gICAgYmluZGluZ1BhdGggPSBiaW5kaW5nUGF0aFswXS50b0xvd2VyQ2FzZSgpICsgYmluZGluZ1BhdGguc3Vic3RyaW5nKDEsIGJpbmRpbmdQYXRoLmxlbmd0aCk7XHJcbiAgICBjb25zdCBwYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJyk7XHJcblxyXG4gICAgY29uc3QgZmlsdGVyZWRQYXRocyA9IHBhdGhzLmZpbHRlcigocGFydDogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHJldHVybiBwYXJ0ICE9PSAnJztcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXMuYmluZGluZ0RhdGEuZ2V0VmFsdWUoZmlsdGVyZWRQYXRocyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiuvue9rue7hOS7tuW8leeUqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgc2V0Q29tcG9uZW50UmVmKCkge1xyXG4gICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMudmlld01vZGVsICYmIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dCAmJiB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuZ2V0Rm9ybUFwcENvbnRleHQoKTtcclxuICAgIGNvbnN0IGZyYW1lSWQgPSB0aGlzLnZpZXdNb2RlbCAmJiB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQgJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmZyYW1lSWQ7XHJcbiAgICBjb25zdCBpZCA9IHRoaXMuZ3JpZCAmJiB0aGlzLmdyaWQuaWQ7XHJcbiAgICAvLyDlpoLmnpxmcmFtZUlk5LiN5a2Y5Zyo5oiWZmFycmlzIGdyaWTmsqHmnIlpZOWxnuaAp++8jOivtOaYjuS4jeespuWQiOS9v+eUqOWcuuaZr1xyXG4gICAgaWYgKCFmcmFtZUlkIHx8ICFpZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBtYXAgPSBhcHBDb250ZXh0ICYmIGFwcENvbnRleHQuY29tcG9uZW50UmVmcyAmJiBhcHBDb250ZXh0LmNvbXBvbmVudFJlZnMuZ2V0KGZyYW1lSWQpIHx8IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcbiAgICBhcHBDb250ZXh0ICYmIGFwcENvbnRleHQuY29tcG9uZW50UmVmcyAmJiBhcHBDb250ZXh0LmNvbXBvbmVudFJlZnMuc2V0KGZyYW1lSWQsIG1hcC5zZXQoaWQsIHRoaXMuZ3JpZCkpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bliIbpobXkv6Hmga9cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0UGFnaW5nSW5mbygpIHtcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGg7XHJcbiAgICBjb25zdCBiaW5kaW5nRGF0YSA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhO1xyXG4gICAgY29uc3QgcGFnaW5nSW5mbyA9IGJpbmRpbmdEYXRhICYmIGJpbmRpbmdEYXRhLnBhZ2luZ0luZm8gfHwge307XHJcbiAgICBpZiAoYmluZGluZ1BhdGggPT09ICcvJykge1xyXG4gICAgICByZXR1cm4gcGFnaW5nSW5mbztcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnN1YnN0cigxKS5zcGxpdCgnLycpLmZpbHRlcigoaXRlbSkgPT4gISFpdGVtICYmIGl0ZW0ubGVuZ3RoID4gMCk7XHJcbiAgICAgIC8vIOS7juihqOWPiuS7juS7juihqOWIhumhteWSjOaVsOaNruaYr+WFs+iBlOeahO+8jOWboOS4uuS4jeWQjOeahOS7juihqOihjOacieS4jeWQjOeahOS7juS7juihqOaVsOaNru+8jOWIhumhteS/oeaBr+eahOe7k+aehOS4um5vZGVDb2RlX3BhcmVudElkOnvliIbpobXkv6Hmga995LiU5YiG6aG15L+h5oGv5piv5bmz57qn55qEXHJcbiAgICAgIC8vIHtwYWdpbmF0aW9uOnthX3BpZDp7cGFnZVNpemU6MixwYWdlSW5kZXg6MX0sYl9waWQ6e3BhZ2VTaXplOjIscGFnZUluZGV4OjF9fX1cclxuICAgICAgLy8g5Y+W5Ye65b2T5YmN6Lev5b6E5LiL5a6e5L2T55qEbm9kZUNvZGVcclxuICAgICAgbGV0IG5vZGVDb2RlID0gYmluZGluZ1BhdGhzW2JpbmRpbmdQYXRocy5sZW5ndGggLSAxXTtcclxuICAgICAgbm9kZUNvZGUgPSBub2RlQ29kZS5zdWJzdHIoMCwgbm9kZUNvZGUubGVuZ3RoIC0gMSk7XHJcbiAgICAgIC8vIOiOt+WPluW9k+WJjeWunuS9k+S4iue6p+eahOS4u+mUrlxyXG4gICAgICAvLyBjb25zdCByZXN1bHQgPSBwYWdpbmdJbmZvW25vZGVDb2RlXSB8fCB7fTtcclxuICAgICAgLy8gaWYgKHJlc3VsdC5oYXNPd25Qcm9wZXJ0eSgndG90YWxDb3VudCcpKSB7XHJcbiAgICAgIC8vICAgcmVzdWx0LnRvdGFsID0gcmVzdWx0LnRvdGFsQ291bnQ7XHJcbiAgICAgIC8vIH1cclxuICAgICAgLy8gcmV0dXJuIHJlc3VsdDtcclxuXHJcbiAgICAgIGNvbnN0IHBhdGhzID0gYmluZGluZ1BhdGhzLnNsaWNlKDAsIGJpbmRpbmdQYXRocy5sZW5ndGggLSAxKTtcclxuICAgICAgY29uc3QgYmluZGluZ0xpc3QgPSBiaW5kaW5nRGF0YS5nZXRWYWx1ZShwYXRocykgYXMgQmluZGluZ0xpc3Q7XHJcbiAgICAgIGNvbnN0IHsgcGFnZVNpemUgPSAwIH0gPSBwYWdpbmdJbmZvW2Ake25vZGVDb2RlfWBdIHx8IHt9O1xyXG4gICAgICAvLyDkuIrnuqfooajmnInmlbDmja5cclxuICAgICAgaWYgKGJpbmRpbmdMaXN0ICYmIGJpbmRpbmdMaXN0LmN1cnJlbnRJZCkge1xyXG4gICAgICAgIGNvbnN0IGtleSA9IGAke25vZGVDb2RlfV8ke2JpbmRpbmdMaXN0LmN1cnJlbnRJZH1gO1xyXG4gICAgICAgIC8vIGNvbnN0IGtleSA9IG5vZGVDb2RlO1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHBhZ2luZ0luZm9ba2V5XSB8fCB7fTtcclxuICAgICAgICBpZiAocmVzdWx0Lmhhc093blByb3BlcnR5KCd0b3RhbENvdW50JykpIHtcclxuICAgICAgICAgIHJlc3VsdC50b3RhbCA9IHJlc3VsdC50b3RhbENvdW50O1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDkuIrnuqfooajomb3nhLbmnInmlbDmja7vvIzkvYbkuIrnuqfooajlvZPliY3ooYznmoTkuIvnuqfooajlj6/og73msqHmnInmlbDmja7vvIzov5nlsLHlr7zoh7Tojrflj5bkuI3liLDliIbpobXkv6Hmga/vvIzmiYDku6XpnIDopoHlnKjov5Tlm57liY3lr7nnu5Pmnpzov5vooYzlpITnkIbvvIzlpoLmnpzmsqHmnInliIbpobXkv6Hmga/nmoTor53otbfnoIHlupTor6Xov5Tlm57liIbpobXlpKflsI/lj4rlvZPliY3pobXnoIFcclxuICAgICAgICBpZiAoT2JqZWN0LmtleXMocmVzdWx0KS5sZW5ndGggPCAxKSB7XHJcbiAgICAgICAgICByZXN1bHQucGFnZUluZGV4ID0gMTtcclxuICAgICAgICAgIHJlc3VsdC5wYWdlU2l6ZSA9IHBhZ2VTaXplO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIOS4iue6p+ihqOayoeacieaVsOaNru+8jOatpOaXtumcgOimgeiOt+WPluW9k+WJjeihqOeahOWIhumhteS/oeaBr++8jOWmguWIhumhteWkp+Wwj+OAguW9k+WJjemhtem7mOiupOS4ujHljbPlj6/jgIJcclxuICAgICAgICByZXR1cm4geyBwYWdlSW5kZXg6IDEsIHBhZ2VTaXplIH07XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vICNyZWdpb24gSW5wdXRcclxuICAvKipcclxuICAgKiDnu4Tku7bmmK/lkKbpnIDopoHmm7TmlrBcclxuICAgKiBAcGFyYW0gcHJvcHMg5b2T5YmN5bGe5oCnXHJcbiAgICogQHBhcmFtIG5leHRQcm9wcyDmlrDlsZ7mgKdcclxuICAgKiBAcGFyYW0gY2hhbmdlIOWPmOabtFxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBzaG91bGRDb21wb25lbnRVcGRhdGUoY2hhbmdlOiBDaGFuZ2UsIGRhdGE6IGFueSwpOiB7IHJlc3VsdDogYm9vbGVhbiwgcHJvcHM/OiBhbnkgfSB7XHJcbiAgICBjb25zdCBwcm9wcyA9IHRoaXMuYnVpbGRQcm9wcyhkYXRhKTtcclxuICAgIGlmICh0aGlzLnZpZXdNb2RlbCAmJiB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQgJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQgJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQucnVuTW9kZSA9PT0gUnVuTW9kZS5oaWdoU3BlZWQgJiYgY2hhbmdlKSB7XHJcbiAgICAgIGlmIChjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5Mb2FkIHx8IGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlJlbW92ZSB8fCBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5QYWdpbmF0aW9uSW5mb0NoYW5nZSkge1xyXG4gICAgICAgIHJldHVybiB7IHJlc3VsdDogdHJ1ZSwgcHJvcHMgfTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgY29uc3QgZ3JpZFByb3BzID0gdGhpcy5idWlsZEdyaWRQcm9wcygpO1xyXG4gICAgaWYgKEpTT04uc3RyaW5naWZ5KHByb3BzKSA9PT0gSlNPTi5zdHJpbmdpZnkoZ3JpZFByb3BzKSkge1xyXG4gICAgICByZXR1cm4geyByZXN1bHQ6IGZhbHNlIH07XHJcbiAgICB9XHJcbiAgICByZXR1cm4geyByZXN1bHQ6IHRydWUsIHByb3BzIH07XHJcbiAgfVxyXG4gIHByb3RlY3RlZCByZWdpc3RlckV2ZW50KCkge1xyXG4gICAgLy8g5o6S5bqP5LqL5Lu2XHJcbiAgICB0aGlzLmdyaWQgJiYgdGhpcy5ncmlkLmNvbHVtblNvcnRlZCAmJiB0aGlzLmdyaWQuY29sdW1uU29ydGVkLnN1YnNjcmliZSgoZXZlbnQ6IGFueSkgPT4ge1xyXG4gICAgICBjb25zdCBpc1JlbW90ZVNvcnQgPSB0aGlzLmdyaWQucmVtb3RlU29ydDtcclxuICAgICAgLy8g5pys5Zyw5o6S5bqPXHJcbiAgICAgIGlmICghaXNSZW1vdGVTb3J0KSB7XHJcbiAgICAgICAgdGhpcy5zb3J0RmllbGRzID0gdGhpcy5ncmlkLnNvcnROYW1lO1xyXG4gICAgICAgIHRoaXMuc29ydERpcmVjdGlvbnMgPSB0aGlzLmdyaWQuc29ydE9yZGVyO1xyXG4gICAgICAgIHRoaXMuc29ydEJpbmRpbmdMaXN0KCk7XHJcbiAgICAgICAgLy8gdGhpcy5wcm9wcyA9IHRoaXMuYnVpbGRQcm9wcygpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIOacjeWKoeWZqOerr+aOkuW6j1xyXG4gICAgICAgIGNvbnN0IGdyb3VwRmllbGQgPSB0aGlzLmdyaWQgJiYgdGhpcy5ncmlkLmdyb3VwRmllbGQgfHwgbnVsbDtcclxuICAgICAgICBsZXQgc29ydEZpZWxkcyA9IHRoaXMuZ3JpZC5zb3J0TmFtZSAmJiB0aGlzLmdyaWQuc29ydE5hbWUuc3BsaXQoJywnKSB8fCBbXTtcclxuICAgICAgICBjb25zdCBzb3J0RGlyZWN0aW9uID0gdGhpcy5ncmlkLnNvcnRPcmRlciAmJiB0aGlzLmdyaWQuc29ydE9yZGVyLnNwbGl0KCcsJykgfHwgW107XHJcbiAgICAgICAgaWYgKGdyb3VwRmllbGQpIHtcclxuICAgICAgICAgIGlmICghc29ydEZpZWxkcy5pbmNsdWRlcyhncm91cEZpZWxkKSkge1xyXG4gICAgICAgICAgICBzb3J0RmllbGRzLnNwbGljZSgwLCAwLCBncm91cEZpZWxkKTtcclxuICAgICAgICAgICAgc29ydERpcmVjdGlvbi5zcGxpY2UoMCwgMCwgJ2FzYycpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDojrflj5blvZPliY1lbnRpdHnkuIrmiYDmnIlvYmplY3TlsZ7mgKdcclxuICAgICAgICBjb25zdCBlbnRpdHlUeXBlID0gdGhpcy52aWV3TW9kZWwgJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5VHlwZSB8fCBudWxsO1xyXG5cclxuICAgICAgICBpZiAoc29ydEZpZWxkcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICBpZiAoZW50aXR5VHlwZSkge1xyXG4gICAgICAgICAgICBjb25zdCBkYXRhVHlwZUluZm8gPSBuZXcgRGF0YVR5cGVJbmZvKGVudGl0eVR5cGUpO1xyXG4gICAgICAgICAgICBzb3J0RmllbGRzID0gc29ydEZpZWxkcy5tYXAoZmllbGQgPT4ge1xyXG4gICAgICAgICAgICAgIC8vaWYgKGZpZWxkICYmIGZpZWxkLmluZGV4T2YoJy4nKSAhPT0gLTEpIHtcclxuICAgICAgICAgICAgICBjb25zdCBwYXRocyA9IGZpZWxkLnNwbGl0KCcuJyk7XHJcbiAgICAgICAgICAgICAgY29uc3QgcHJvcEluZm8gPSBkYXRhVHlwZUluZm8uZ2V0UHJvcEluZm9CeVBhdGgocGF0aHMpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IG9yaWdpbmFsRmllbGQgPSBwcm9wSW5mbyAmJiBwcm9wSW5mby5tZXRhZGF0YUluZm9bJ3BhdGgnXSB8fCBudWxsO1xyXG4gICAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbEZpZWxkO1xyXG4gICAgICAgICAgICAgIC8vfVxyXG4gICAgICAgICAgICAgIC8vcmV0dXJuIGZpZWxkO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g6YGN5Y6G5bGe5oCn77yM5qC55o2uZGF0YWZpZWxk6L2s5o2i5Li6b3JpZ2luYWxEYXRhRmllbGRcclxuICAgICAgICBjb25zdCBmaWVsZHMgPSBzb3J0RmllbGRzLmpvaW4oJywnKTtcclxuICAgICAgICBjb25zdCBkaXJlY3Rpb25zID0gc29ydERpcmVjdGlvbi5qb2luKCcsJykgfHwgJ2FzYyc7XHJcbiAgICAgICAgY29uc3QgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQgPSB0aGlzLnZpZXdNb2RlbCAmJiB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQgfHwgbnVsbDtcclxuICAgICAgICBpZiAoZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgICBmcmFtZUNvbnRleHQucmVwb3NpdG9yeS5zb3J0Q29uZGl0aW9uTWFuYWdlci5zZXRDb25kaXRpb25zKHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoLCBmaWVsZHMsIGRpcmVjdGlvbnMpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICAvLyDov4fmu6Tkuovku7ZcclxuICAgIHRoaXMuZ3JpZCAmJiB0aGlzLmdyaWQuZmlsdGVyQ2hhbmdlZCAmJiB0aGlzLmdyaWQuZmlsdGVyQ2hhbmdlZC5zdWJzY3JpYmUoKGV2ZW50OiBhbnkpID0+IHtcclxuICAgICAgdGhpcy5maWx0ZXJzID0gZXZlbnQ7XHJcbiAgICAgIGlmICghdGhpcy5ncmlkLnJlbW90ZUZpbHRlcikge1xyXG4gICAgICAgIGlmICh0aGlzLmJpbmRpbmdMaXN0Lmxlbmd0aCA+IDAgJiYgIXRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkKSB7XHJcbiAgICAgICAgICBjb25zdCBpZCA9IHRoaXMuYmluZGluZ0xpc3QuZ2V0SWRCeUluZGV4KDApO1xyXG4gICAgICAgICAgdGhpcy5iaW5kaW5nTGlzdC5zZXRDdXJyZW50SWQoaWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmJpbmRpbmdMaXN0LmZpbHRlcih0aGlzLmZpbHRlcnMpO1xyXG4gICAgICAgIHRoaXMuYmluZERhdGEoKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5tZXNzYWdlUGlwZS5zdWJzY3JpYmUoKG1lc3NhZ2UpID0+IHtcclxuICAgICAgaWYgKG1lc3NhZ2UgJiYgbWVzc2FnZSA9PT0gJ0NMRUFSX0dSSURfQ09ORElUSU9OJyAmJiB0aGlzLmZpbHRlcnMgJiYgT2JqZWN0LmtleXModGhpcy5maWx0ZXJzKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgdGhpcy5maWx0ZXJzID0ge307XHJcbiAgICAgICAgdGhpcy5iaW5kRGF0YSgpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWvuWJpbmRpbmdMaXN05o6S5bqPXHJcbiAgICogQHBhcmFtIGNoYW5nZSBjaGFuZ2VcclxuICAgKi9cclxuICBwcml2YXRlIHNvcnRCaW5kaW5nTGlzdChjaGFuZ2U/OiBDaGFuZ2UpIHtcclxuICAgIC8vIGdyb3VwRmllbGTlj6/og73mnInlpJrkuKrvvIzku6XpgJflj7fliIbpmpTnmoTlrZfnrKbkuLJcclxuICAgIGNvbnN0IGdyb3VwRmllbGQgPSB0aGlzLmdyaWQgJiYgdGhpcy5ncmlkLmdyb3VwRmllbGQgfHwgbnVsbDtcclxuICAgIGlmIChncm91cEZpZWxkKSB7XHJcbiAgICAgIGNvbnN0IGFyclNvcnRGaWVsZHMgPSB0aGlzLnNvcnRGaWVsZHMgJiYgdGhpcy5zb3J0RmllbGRzLnNwbGl0KCcsJykgfHwgW107XHJcbiAgICAgIGNvbnN0IGdyb3VwRmllbGRzID0gZ3JvdXBGaWVsZC5zcGxpdCgnLCcpLnJldmVyc2UoKTtcclxuICAgICAgZ3JvdXBGaWVsZHMuZm9yRWFjaCgoZmllbGQ6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGlmICghYXJyU29ydEZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHtcclxuICAgICAgICAgIGFyclNvcnRGaWVsZHMuc3BsaWNlKDAsIDAsIGZpZWxkKTtcclxuICAgICAgICAgIGNvbnN0IGFyclNvcnREaXJlY3Rpb24gPSB0aGlzLnNvcnREaXJlY3Rpb25zICYmIHRoaXMuc29ydERpcmVjdGlvbnMuc3BsaXQoJywnKSB8fCBbXTtcclxuICAgICAgICAgIGFyclNvcnREaXJlY3Rpb24uc3BsaWNlKDAsIDAsICdhc2MnKTtcclxuICAgICAgICAgIHRoaXMuc29ydEZpZWxkcyA9IGFyclNvcnRGaWVsZHMuam9pbignLCcpO1xyXG4gICAgICAgICAgdGhpcy5zb3J0RGlyZWN0aW9ucyA9IGFyclNvcnREaXJlY3Rpb24uam9pbignLCcpIHx8ICdhc2MnO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmJpbmRpbmdMaXN0LnNvcnRCeSh0aGlzLnNvcnRGaWVsZHMsIHRoaXMuc29ydERpcmVjdGlvbnMpO1xyXG4gICAgdGhpcy5iaW5kRGF0YShjaGFuZ2UpO1xyXG4gIH1cclxuICAvLyAjZW5kcmVnaW9uXHJcblxyXG4gIC8vICNyZWdpb24g5pWw5o2u57uR5a6a6YOo5YiGXHJcbiAgLyoqXHJcbiAgICog5pu05paw5pWw5o2uXHJcbiAgICogQHBhcmFtIGNoYW5nZT8g5Y+Y5pu0XHJcbiAgICovXHJcbiAgYmluZERhdGEoY2hhbmdlPzogQ2hhbmdlKSB7XHJcbiAgICBjb25zdCBpc1JlbW90ZUZpbHRlciA9IHRoaXMuZ3JpZCAmJiB0aGlzLmdyaWQucmVtb3RlRmlsdGVyIHx8IGZhbHNlO1xyXG4gICAgLy8g5YWI5omn6KGM5o6S5bqPXHJcbiAgICBjb25zdCBzaG91bGRTb3J0ID0gdGhpcy5zaG91bGRTb3J0KGNoYW5nZSk7XHJcbiAgICBpZiAoc2hvdWxkU29ydCkge1xyXG4gICAgICB0aGlzLmhhc1NvcnRlZCA9IHRydWU7XHJcbiAgICAgIHRoaXMuc29ydEJpbmRpbmdMaXN0KGNoYW5nZSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuaGFzU29ydGVkID0gZmFsc2U7XHJcbiAgICAvLyDmlrDlop7mlbDmja7ml7bmuIXnqbrooajmoLznrZvpgInmnaHku7ZcclxuICAgIGlmICgodGhpcy5ncmlkLmVkaXRhYmxlID09PSB0cnVlIHx8IGNoYW5nZSAmJiBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5BcHBlbmQpICYmIHRoaXMuZmlsdGVycyAmJiBPYmplY3Qua2V5cyh0aGlzLmZpbHRlcnMpLmxlbmd0aCA+IDAgJiYgIWlzUmVtb3RlRmlsdGVyKSB7XHJcbiAgICAgIGlmICghdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZW5hYmxlR3JpZEhlYWRlcldoZW5FZGl0aW5nICYmICF0aGlzLmVuYWJsZUZpbHRlclNvcnRpbmcpIHtcclxuICAgICAgICB0aGlzLmZpbHRlcnMgPSB7fTtcclxuICAgICAgICB0aGlzLmdyaWQuY2xlYXJDb25kaXRpb24oKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgY29uc3Qgc2hvdWxkRmlsdGVyaW5nID0gdGhpcy5zaG91bGRGaWx0ZXJpbmcoY2hhbmdlKTtcclxuICAgIGlmIChzaG91bGRGaWx0ZXJpbmcpIHtcclxuICAgICAgdGhpcy5iaW5kaW5nTGlzdC5maWx0ZXIodGhpcy5maWx0ZXJzKTtcclxuICAgIH1cclxuICAgIC8vIOWGjXRvSlNPTlxyXG4gICAgY29uc3QgZGF0YTogYW55ID0gdGhpcy5iaW5kaW5nTGlzdC50b0pTT04oKTtcclxuICAgIC8vIGlmICh0aGlzLmZpbHRlcnMgJiYgT2JqZWN0LmtleXModGhpcy5maWx0ZXJzKS5sZW5ndGggPiAwICYmICFpc1JlbW90ZUZpbHRlcikge1xyXG4gICAgLy8gICAvLyBkYXRhID0gdGhpcy5ncmlkLmNsaWVudEZpbHRlclNlcnZpY2UuZXhlY3V0ZUZpbHRlcihkYXRhLCB0aGlzLmZpbHRlcnMpO1xyXG4gICAgLy8gfVxyXG5cclxuICAgIGlmICh0aGlzLmZpbHRlcnMgJiYgT2JqZWN0LmtleXModGhpcy5maWx0ZXJzKS5sZW5ndGggPiAwICYmICFpc1JlbW90ZUZpbHRlciAmJiAoIWNoYW5nZSB8fCBjaGFuZ2UgJiYgY2hhbmdlLnR5cGUgIT09IENoYW5nZVR5cGUuU2VsZWN0aW9uQ2hhbmdlZCAmJiBjaGFuZ2UudHlwZSAhPT0gQ2hhbmdlVHlwZS5HbG9iYWxTZWxlY3Rpb25DaGFuZ2VkKSkge1xyXG4gICAgICBpZiAoZGF0YSAmJiBkYXRhLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAvLyDliKTmlq3lvZPliY3ooYzmmK/lkKblnKjov4fmu6TlkI7nmoTmlbDmja7kuK1cclxuICAgICAgICBjb25zdCByb3cgPSAoZGF0YSBhcyBbXSkuZmluZCgoaXRlbSkgPT4gaXRlbVt0aGlzLmJpbmRpbmdMaXN0LnByaW1hcnlLZXldID09PSB0aGlzLmJpbmRpbmdMaXN0LmN1cnJlbnRJZCk7XHJcbiAgICAgICAgaWYgKCFyb3cpIHtcclxuICAgICAgICAgIGNvbnN0IGZpcnN0Um93SWQgPSBkYXRhWzBdW3RoaXMuYmluZGluZ0xpc3QucHJpbWFyeUtleV07XHJcbiAgICAgICAgICB0aGlzLmJpbmRpbmdMaXN0LnNldEN1cnJlbnRJZChmaXJzdFJvd0lkLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8g5pys5Zyw6L+H5ruk5a6M5LmL5ZCO5rKh5pyJ5pWw5o2u5LqGXHJcbiAgICAgICAgLy8gdGhpcy5iaW5kaW5nTGlzdC5jdXJyZW50SWQgPSBudWxsO1xyXG4gICAgICAgIGlmICh0aGlzLmJpbmRpbmdMaXN0LmN1cnJlbnRJZCkge1xyXG4gICAgICAgICAgdGhpcy5iaW5kaW5nTGlzdC5zZXRDdXJyZW50SWQobnVsbCwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOWNlemAieaXtua4heepumlkc1xyXG4gICAgICAgIGlmICghdGhpcy5ncmlkLm11bHRpU2VsZWN0KSB7XHJcbiAgICAgICAgICB0aGlzLnNldENoZWNrcyhbXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLnNob3VsZENvbXBvbmVudFVwZGF0ZShjaGFuZ2UsIGRhdGEpO1xyXG4gICAgaWYgKCFyZXN1bHQucmVzdWx0KSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIGNvbnN0IG5leHRQcm9wcyA9IHRoaXMuYnVpbGRQcm9wcyhyZXN1bHQpO1xyXG4gICAgdGhpcy5yZW5kZXJHcmlkKHJlc3VsdC5wcm9wcyk7XHJcbiAgICB0aGlzLnByb3BzID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShyZXN1bHQucHJvcHMpKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5piv5ZCm5bqU6K+l6L+H5rukXHJcbiAgICogQHBhcmFtIGNoYW5nZSAtIGNoYW5nZVxyXG4gICAqIEByZXR1cm5zIHtib29sZWFufVxyXG4gICAqL1xyXG4gIHByaXZhdGUgc2hvdWxkRmlsdGVyaW5nKGNoYW5nZT86IENoYW5nZSkge1xyXG4gICAgY29uc3QgaXNSZW1vdGVGaWx0ZXIgPSB0aGlzLmdyaWQgJiYgdGhpcy5ncmlkLnJlbW90ZUZpbHRlciB8fCBmYWxzZTtcclxuICAgIC8vIOWQr+eUqOi/nOerr+i/h+a7pOaXtuS4jemcgOimgeacrOWcsOi/h+a7pFxyXG4gICAgaWYgKGlzUmVtb3RlRmlsdGVyID09PSB0cnVlKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIC8vIOayoeaciei/h+a7pOadoeS7tuaXtuS4jemcgOimgeaJp+ihjOi/h+a7pFxyXG4gICAgaWYgKCF0aGlzLmZpbHRlcnMgfHwgT2JqZWN0LmtleXModGhpcy5maWx0ZXJzKS5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGlmIChjaGFuZ2UpIHtcclxuICAgICAgcmV0dXJuIGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLkxvYWQ7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gIXRoaXMuZ3JpZC5lZGl0YWJsZTtcclxuICB9XHJcbiAgcHJpdmF0ZSBzaG91bGRTb3J0KGNoYW5nZT86IENoYW5nZSkge1xyXG4gICAgLy8gdGhpcy5zb3J0RmllbGRzICYmICF0aGlzLmdyaWQuZWRpdGFibGUgJiYgY2hhbmdlICYmIChjaGFuZ2UudHlwZSA9PT0gJ0xvYWQnIHx8IGNoYW5nZS50eXBlID09PSAnU2VsZWN0aW9uQ2hhbmdlZCcpXHJcbiAgICBpZiAoIXRoaXMuc29ydEZpZWxkcyB8fCBPYmplY3Qua2V5cyh0aGlzLnNvcnRGaWVsZHMpLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuaGFzU29ydGVkKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGlmIChjaGFuZ2UpIHtcclxuICAgICAgcmV0dXJuIGNoYW5nZS50eXBlID09PSAnTG9hZCcgfHwgY2hhbmdlLnR5cGUgPT09ICdTZWxlY3Rpb25DaGFuZ2VkJztcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLmdyaWQuZWRpdGFibGU7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOa4suafk2dyaWRcclxuICAgKiBAcGFyYW0gcHJvcHMg5bGe5oCnXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZW5kZXJHcmlkKHByb3BzOiBhbnkpIHtcclxuICAgIGNvbnN0IHsgcGFnZUluZGV4LCBwYWdlU2l6ZSwgdG90YWwsIHBhZ2luYXRpb24sIGRhdGEgfSA9IHByb3BzO1xyXG4gICAgY29uc3QgdmlydHVhbGl6ZWRMb2FkID0gdGhpcy5ncmlkLnZpcnR1YWxpemVkQXN5bmNMb2FkIHx8IGZhbHNlO1xyXG4gICAgdGhpcy5ncmlkLnRvdGFsID0gdG90YWw7XHJcbiAgICB0aGlzLmdyaWQucGFnZVNpemUgPSBwYWdlU2l6ZTtcclxuICAgIHRoaXMuZ3JpZC5wYWdlSW5kZXggPSBwYWdlSW5kZXg7XHJcbiAgICB0aGlzLmdyaWQucGFnaW5hdGlvbiA9IHBhZ2luYXRpb247XHJcbiAgICB0aGlzLmdyaWQuY29udHJvbFBhZ2luYXRpb25TdGF0ZSA9IGZhbHNlO1xyXG4gICAgLy8gdGhpcy5lbmRDZWxsRWRpdCgpO1xyXG4gICAgaWYgKHBhZ2VTaXplID09PSAwKSB7XHJcbiAgICAgIHRoaXMuZ3JpZC5wYWdpbmF0aW9uID0gZmFsc2U7XHJcbiAgICAgIHRoaXMuZ3JpZC5wYWdlSW5kZXggPSAxO1xyXG4gICAgICAvLyDkv67lpI3kuI3liIbpobXml7Zncmlk5ZCv55So5YiG57uE5LuN5Lya6YeN5paw6YKm5pWw55qE6Zeu6aKYXHJcbiAgICAgIC8vIHRoaXMuZ3JpZC5wYWdlU2l6ZSA9IHRvdGFsO1xyXG4gICAgfVxyXG4gICAgaWYgKHZpcnR1YWxpemVkTG9hZCkge1xyXG4gICAgICB0aGlzLmdyaWQubG9hZFZpcnR1YWxEYXRhKHtcclxuICAgICAgICBpdGVtczogZGF0YSxcclxuICAgICAgICBwYWdlSW5kZXgsXHJcbiAgICAgICAgcGFnZVNpemUsXHJcbiAgICAgICAgdG90YWxcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmdyaWQubG9hZERhdGEoZGF0YSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOihqOagvOaVsOaNruWxnuaAp1xyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBidWlsZFByb3BzKGRhdGFzPzogQXJyYXk8YW55Pikge1xyXG4gICAgbGV0IGRhdGE7XHJcbiAgICBpZiAodHlwZW9mIChkYXRhcykgIT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIGRhdGEgPSBkYXRhcztcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGRhdGEgPSB0aGlzLmJpbmRpbmdMaXN0LnRvSlNPTigpO1xyXG4gICAgfVxyXG4gICAgLy8gbGV0IHNraXAgPSAwO1xyXG4gICAgbGV0IHsgcGFnZUluZGV4ID0gMSwgcGFnZVNpemUgPSAwIH0gPSB0aGlzLmdldFBhZ2luZ0luZm8oKSB8fCB7fTtcclxuICAgIGxldCB7IHRvdGFsID0gMCB9ID0gdGhpcy5nZXRQYWdpbmdJbmZvKCkgfHwge307XHJcbiAgICAvLyBpZiAocGFnZUluZGV4ID4gMCkge1xyXG4gICAgLy8gICBza2lwID0gKHBhZ2VJbmRleCAtIDEpICogcGFnZVNpemU7XHJcbiAgICAvLyB9XHJcbiAgICBpZiAocGFnZVNpemUgPT09IDAgJiYgdG90YWwgPT09IDApIHtcclxuICAgICAgdG90YWwgPSBkYXRhLmxlbmd0aDtcclxuICAgIH1cclxuICAgIHJldHVybiB7IGRhdGEsIHBhZ2VJbmRleCwgcGFnZVNpemUsIHRvdGFsLCBwYWdpbmF0aW9uOiBwYWdlU2l6ZSAhPT0gMCB9O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDorqHnrpdncmlk54q25oCBXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZEdyaWRQcm9wcygpIHtcclxuICAgIGNvbnN0IGRhdGEgPSB0aGlzLmdyaWQuZGF0YSB8fCBbXTtcclxuICAgIGxldCBza2lwID0gMDtcclxuICAgIGNvbnN0IHsgcGFnZUluZGV4ID0gMSwgcGFnZVNpemUgPSAwIH0gPSB7IHBhZ2VJbmRleDogdGhpcy5ncmlkLnBhZ2VJbmRleCwgcGFnZVNpemU6IHRoaXMuZ3JpZC5wYWdlU2l6ZSB9O1xyXG4gICAgbGV0IHRvdGFsID0gdGhpcy5ncmlkLnRvdGFsIHx8IDA7XHJcbiAgICBpZiAocGFnZUluZGV4ID4gMCkge1xyXG4gICAgICBza2lwID0gKHBhZ2VJbmRleCAtIDEpICogcGFnZVNpemU7XHJcbiAgICB9XHJcbiAgICBpZiAocGFnZVNpemUgPT09IDAgJiYgdG90YWwgPT09IDApIHtcclxuICAgICAgdG90YWwgPSBkYXRhLmxlbmd0aDtcclxuICAgIH1cclxuICAgIHJldHVybiB7IGRhdGEsIHBhZ2VJbmRleCwgcGFnZVNpemUsIHRvdGFsLCBwYWdpbmF0aW9uOiB0aGlzLmdyaWQucGFnaW5hdGlvbiB9O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmlbDmja7mupDlj5HnlJ/lj5jmm7RcclxuICAgKiBAcGFyYW0gY2hhbmdlIOWPmOabtFxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBvbkJpbmRpbmdEYXRhQ2hhbmdlKGNoYW5nZTogQ2hhbmdlKSB7XHJcbiAgICB0aGlzLnVwZGF0ZURhdGFTb3VyY2UoY2hhbmdlKTtcclxuICAgIHRoaXMudXBkYXRlU2VsZWN0ZWRSb3coY2hhbmdlKTtcclxuICAgIC8vIHRoaXMudXBkYXRlR3JpZChjaGFuZ2UpO1xyXG4gICAgLy8g5LiN5riF6Zmk5Yu+6YCJ6KGM77yM6ZyA6KaB5L+d55WZ5Yu+6YCJ54q25oCBXHJcbiAgICAvLyB0aGlzLmNsZWFyQ2hlY2tlZFJvd3MoY2hhbmdlKTtcclxuICAgIHRoaXMuZW5kQ2VsbEVkaXQoY2hhbmdlKTtcclxuICAgIC8vIOabtOaWsOWLvumAieihjOaVsOaNrlxyXG4gICAgdGhpcy51cGRhdGVDaGVja2VkUm93cyhjaGFuZ2UpO1xyXG4gICAgdGhpcy51cGRhdGVEYXRhKGNoYW5nZSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOabtOaWsOaVsOaNrlxyXG4gICAqL1xyXG4gIHByaXZhdGUgdXBkYXRlRGF0YVNvdXJjZShjaGFuZ2U6IENoYW5nZSkge1xyXG4gICAgaWYgKGNoYW5nZSAmJiBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5WYWx1ZUNoYW5nZWQpIHtcclxuICAgICAgLy8g6K6h566X5Y+Y5pu06Lev5b6E5Lit6KGo5ZCN5Y+K5a2X5q615ZCNXHJcbiAgICAgIGNvbnN0IHBhdGhzID0gY2hhbmdlLnBhdGg7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgZW50aXR5UGF0aCA9IEV4cHJlc3Npb25VdGlsLmdldEF2YWlsYWJsZUNoaWxkcmVuUGF0aHNGcm9tRW50aXR5UGF0aHMocGF0aHMsIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvKTtcclxuICAgICAgICBpZiAodGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09ICcvJyArIGVudGl0eVBhdGguam9pbignLycpKSB7XHJcbiAgICAgICAgICBjb25zdCBwcm9wZXJ0eU5hbWVzID0gcGF0aHMuc2xpY2UoZW50aXR5UGF0aC5sZW5ndGgpO1xyXG4gICAgICAgICAgaWYgKGNoYW5nZS5pZCAmJiB0aGlzLmdyaWQgJiYgY2hhbmdlLnBhdGggJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQucnVuTW9kZSAhPT0gUnVuTW9kZS5oaWdoU3BlZWQgJiYgcHJvcGVydHlOYW1lcyAmJiBwcm9wZXJ0eU5hbWVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgdGhpcy5ncmlkLnVwZGF0ZVJvdyhjaGFuZ2UuaWQsIHsgW3Byb3BlcnR5TmFtZXMuam9pbignLicpXTogY2hhbmdlLnZhbHVlIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICBjb25zb2xlLndhcm4oZXJyb3IpO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMucmVuZGVyR3JpZFN1YmplY3QubmV4dChjaGFuZ2UpO1xyXG4gICAgfSBlbHNlIGlmIChjaGFuZ2UgJiYgKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlNlbGVjdGlvbkNoYW5nZWQgfHwgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuR2xvYmFsU2VsZWN0aW9uQ2hhbmdlZCkpIHtcclxuICAgICAgaWYgKHRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkID09PSAodGhpcy5ncmlkLnNlbGVjdGVkUm93ICYmIHRoaXMuZ3JpZC5zZWxlY3RlZFJvdy5pZCkgJiYgdGhpcy5ncmlkLnRvdGFsID4gMCkge1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuYmluZERhdGEoY2hhbmdlKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5iaW5kRGF0YShjaGFuZ2UpO1xyXG4gICAgfVxyXG4gIH1cclxuICAvLyBwcml2YXRlIGVuZENlbGxFZGl0KCkge1xyXG4gIC8vICAgY29uc3QgaXNFZGl0aW5nID0gdGhpcy5ncmlkLmlzRWRpdGluZygpO1xyXG4gIC8vICAgaWYgKGlzRWRpdGluZykge1xyXG4gIC8vICAgICB0aGlzLmdyaWQuZW5kQ2VsbEVkaXQoKTtcclxuICAvLyAgIH1cclxuICAvLyB9XHJcbiAgcHJpdmF0ZSBlbmRDZWxsRWRpdChjaGFuZ2U6IENoYW5nZSkge1xyXG4gICAgY29uc3QgaXNFZGl0aW5nID0gdGhpcy5ncmlkLmlzRWRpdGluZygpO1xyXG4gICAgaWYgKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLkxvYWQgJiYgaXNFZGl0aW5nKSB7XHJcbiAgICAgIHRoaXMuZ3JpZC5lbmRDZWxsRWRpdCgpO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDorr7nva5ncmlk5b2T5YmN6YCJ5oup6KGMXHJcbiAgICogQHBhcmFtIGNoYW5nZSDlj5jmm7RcclxuICAgKi9cclxuICBwcml2YXRlIHVwZGF0ZVNlbGVjdGVkUm93KGNoYW5nZT86IENoYW5nZSkge1xyXG4gICAgaWYgKCF0aGlzLmJpbmRpbmdMaXN0IHx8ICF0aGlzLmJpbmRpbmdMaXN0LmN1cnJlbnRJZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDpobXnoIHliIfmjaLml7bkuI3miafooYzlvZPliY3ooYzliIfmjaJcclxuICAgIGlmIChjaGFuZ2UgJiYgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuUGFnaW5hdGlvbkluZm9DaGFuZ2UpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMudmlld01vZGVsICYmIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5yb3dTZWxlY3RlZEV2ZW50U3VzcGVuZCA9PT0gdHJ1ZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCB7IGlkOiBncmlkU2VsZWN0ZWRSb3dJZCA9IG51bGwgfSA9IHRoaXMuZ3JpZC5zZWxlY3RlZFJvdyB8fCB7fTtcclxuICAgIGNvbnN0IGN1cnJlbnRJZCA9IHRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkO1xyXG4gICAgLy8gZ3JpZOW9k+WJjeihjOS4jmJpbmdpbmdMaXN05b2T5YmN6KGM5LiA6Ie077yM5peg6aG75YiH5o2iXHJcbiAgICBpZiAoZ3JpZFNlbGVjdGVkUm93SWQgPT09IGN1cnJlbnRJZCkge1xyXG4gICAgICBjb25zdCBpc01hdGNoID0gY2hhbmdlICYmIChjaGFuZ2UucGF0aC50b1N0cmluZygpID09PSB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLnRvU3RyaW5nKCkpO1xyXG4gICAgICBpZiAoY2hhbmdlICYmIGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLkxvYWQgJiYgaXNNYXRjaCkge1xyXG4gICAgICAgIHRoaXMuZ3JpZC5jbGVhclNlbGVjdGlvbnMoKTtcclxuICAgICAgICB0aGlzLmdyaWQuc2VsZWN0Um93KGN1cnJlbnRJZCwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zZWxlY3RHcmlkUm93KHRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5rOo5YaMYmluZGluZ2RhdGHlj5jljJbkuovku7ZcclxuICAgKi9cclxuICBwcml2YXRlIHJlZ2lzdGVyQmluZGluZ0RhdGFDaGFuZ2VFdmVudCgpIHtcclxuICAgIHRoaXMuYmluZGluZ0RhdGFDaGFuZ2VFdmVudCA9IHRoaXMuYmluZGluZ0RhdGEuY2hhbmdlcy5zdWJzY3JpYmUoKGNoYW5nZTogQ2hhbmdlKSA9PiB7XHJcbiAgICAgIHRoaXMub25CaW5kaW5nRGF0YUNoYW5nZShjaGFuZ2UpO1xyXG4gICAgfSk7XHJcbiAgICB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5tZXNzYWdlUGlwZS5zdWJzY3JpYmUobWVzc2FnZSA9PiB7XHJcbiAgICAgIGlmIChtZXNzYWdlID09PSAnYmluZERhdGEnKSB7XHJcbiAgICAgICAgdGhpcy5iaW5kRGF0YSgpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Y+W5raIYmluZGluZ2RhdGHlj5jljJborqLpmIVcclxuICAgKi9cclxuICBwcml2YXRlIHVuUmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCkge1xyXG4gICAgaWYgKHRoaXMuYmluZGluZ0RhdGFDaGFuZ2VFdmVudCAmJiB0eXBlb2YgKHRoaXMuYmluZGluZ0RhdGFDaGFuZ2VFdmVudC51bnN1YnNjcmliZSkgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5iaW5kaW5nRGF0YUNoYW5nZUV2ZW50LnVuc3Vic2NyaWJlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOinpuWPkemhteeggeWIh+aNouS6i+S7tlxyXG4gICAqIEBkZXNjcmlwdGlvbiDmnKzmlrnms5XpgILnlKjlnLrmma/ku4XkuLrniLbnuqdncmlk5pWw5o2u6YeN5pawbG9hZO+8jOmcgOimgeinpuWPkeivpWdyaWTph43mlrDlj5bmlbDkvb/nlKjjgILlhbbku5blnLrmma/or7fli7/kvb/nlKhcclxuICAgKiBAVE9ETzog5b6F6YeN5p6E77yM5o6n5Yi25LiL57qn5pWw5o2u5Yqg6L295bqU6K+l5L6d6LWW6KGo5qC855qE6KGM5YiH5o2i5LqL5Lu277yM5Li05pe26L+Z5qC35aSE55CG77yM5ZCO57ut5o+Q5L6bTG9hZENoaWxkcmVu5LqL5Lu2XHJcbiAgICovXHJcbiAgcHJpdmF0ZSB1cGRhdGVEYXRhKGNoYW5nZT86IENoYW5nZSkge1xyXG4gICAgaWYgKCEoY2hhbmdlICYmIChjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5TZWxlY3Rpb25DaGFuZ2VkIHx8IGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLkxvYWQpKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoO1xyXG4gICAgY29uc3QgZXZlbnRCaW5kaW5nUGF0aCA9ICcvJyArIGNoYW5nZS5wYXRoLmpvaW4oJy8nKTtcclxuICAgIGNvbnN0IGlzUmV0cmlldmUgPSB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5wYXJhbXMuZ2V0KCdyZXRyaWV2ZWluZycpIHx8IGZhbHNlO1xyXG4gICAgaWYgKGNoYW5nZS5wYXRoLmxlbmd0aCA8IDEgfHwgYmluZGluZ1BhdGggPT09ICcvJyB8fCBiaW5kaW5nUGF0aCA9PT0gZXZlbnRCaW5kaW5nUGF0aCB8fCAhYmluZGluZ1BhdGguc3RhcnRzV2l0aChldmVudEJpbmRpbmdQYXRoKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyByZXRyaWV2ZeaXtuS8muiHquWKqOW4puWbnuS7juihqOesrOS4gOmhteWPiuS7juihqOesrOS4gOihjOeahOS7juS7juihqOaVsOaNru+8jOaJgOS7peS4jemcgOimgeWGjeWOu+WNleeLrOivt+axglxyXG4gICAgaWYgKGlzUmV0cmlldmUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZnVsbFBhdGhzID0gRW50aXR5UGF0aENvbnZlcnRlci50b0VudGl0eVBhdGhBcnJheSh0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCwgdGhpcy5iaW5kaW5nRGF0YSk7XHJcbiAgICBjb25zdCBwYXRocyA9IGZ1bGxQYXRocy5zbGljZSgwLCBmdWxsUGF0aHMubGVuZ3RoIC0gMSk7XHJcbiAgICBjb25zdCBwYXJlbnQgPSB0aGlzLmJpbmRpbmdMaXN0LnBhcmVudDtcclxuICAgIGNvbnN0IHBhcmVudElkID0gcGFyZW50ICYmIHBhcmVudFtwYXJlbnQucHJpbWFyeUtleV07XHJcbiAgICAvLyDkuIrnuqfooajmsqHmnInmlbDmja5cclxuICAgIGlmICghcGFyZW50SWQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgLy8g6I635Y+Wbm9kZWNvZGVcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKGl0ZW0gPT4gaXRlbSk7XHJcbiAgICBsZXQgbm9kZUNvZGUgPSBiaW5kaW5nUGF0aHNbYmluZGluZ1BhdGhzLmxlbmd0aCAtIDFdO1xyXG4gICAgbm9kZUNvZGUgPSBub2RlQ29kZS5zdWJzdHIoMCwgbm9kZUNvZGUubGVuZ3RoIC0gMSk7XHJcbiAgICAvLyBjb25zdCBjb25maWdQYXRoID0gYC8ke25vZGVDb2RlfV8ke3BhcmVudElkfWA7XHJcbiAgICBjb25zdCBjb25maWdQYXRoID0gYC8ke25vZGVDb2RlfWA7XHJcbiAgICBsZXQgeyBwYWdlSW5kZXggPSAxIH0gPSB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldFBhZ2luYXRpb25Db25maWdCeVBhdGgoY29uZmlnUGF0aCkgfHwge307XHJcbiAgICBjb25zdCB7IHBhZ2VTaXplID0gMCB9ID0gdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRQYWdpbmF0aW9uQ29uZmlnQnlQYXRoKGNvbmZpZ1BhdGgpIHx8IHt9O1xyXG5cclxuICAgIGNvbnN0IHBhcmVudE5vZGVDb2RlID0gY2hhbmdlLnBhdGhbY2hhbmdlLnBhdGgubGVuZ3RoIC0gMV07XHJcbiAgICBjb25zdCBwYXJlbnRDb25maWdQYXRoID0gJy8nICsgcGFyZW50Tm9kZUNvZGUuc3Vic3RyaW5nKDAsIHBhcmVudE5vZGVDb2RlLmxlbmd0aCAtIDEpO1xyXG4gICAgY29uc3QgeyBwYWdlU2l6ZTogcGFyZW50UGFnZVNpemUgPSAwIH0gPSB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldFBhZ2luYXRpb25Db25maWdCeVBhdGgocGFyZW50Q29uZmlnUGF0aCkgfHwge307XHJcbiAgICBjb25zdCBpc1F1ZXJ5Q2hpbGQgPSB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5wYXJhbXMuZ2V0KCdxdWVyeUNoaWxkJykgfHwgZmFsc2U7XHJcbiAgICBpZiAoaXNRdWVyeUNoaWxkKSB7XHJcbiAgICAgIC8vIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LnBhcmFtcy5kZWxldGUoJ3F1ZXJ5Q2hpbGQnKTtcclxuICAgICAgcGFnZUluZGV4ID0gMTtcclxuICAgIH1cclxuICAgIC8vIOW9k+S4iue6p+ihqOWIh+aNouihjOaXtlxyXG4gICAgaWYgKHBhcmVudFBhZ2VTaXplICsgcGFnZVNpemUgIT09IDApIHtcclxuICAgICAgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQucGFyYW1zLnNldCgnZm9yY2VRdWVyeUNoaWxkJywgdHJ1ZSk7XHJcbiAgICAgIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LnF1ZXJ5Q2hpbGQocGF0aHMsIHBhZ2VJbmRleCwgcGFnZVNpemUpLnBpcGUoXHJcbiAgICAgICAgZmluYWxpemUoKCkgPT4gdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQucGFyYW1zLmRlbGV0ZSgnZm9yY2VRdWVyeUNoaWxkJykpXHJcbiAgICAgICkuc3Vic2NyaWJlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIG5nT25EZXN0cm95KCkge1xyXG4gICAgdGhpcy51blJlZ2lzdGVyQmluZGluZ0RhdGFDaGFuZ2VFdmVudCgpO1xyXG4gIH1cclxuICAvLyAjZW5kcmVnaW9uXHJcblxyXG4gIC8vICNyZWdpb24g5LqL5Lu25Y+R5bCE5ZmoXHJcblxyXG4gIC8qKlxyXG4gICAqIOWPkeWwhOmAieS4reihjOWIh+aNouS6i+S7tlxyXG4gICAqIEBkZXNjcmlwdGlvbiDnu5/kuIDljZXpgInmqKHlvI/lkozlpJrpgInmqKHlvI/kuIvnmoTooYzliIfmjaLkuovku7ZcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZmlyZVNlbGVjdGVkUm93Q2hhbmdlKHNlbGVjdGVkUm93Q29udGV4dDogYW55KSB7XHJcbiAgICB0aGlzLnNlbGVjdGVkUm93Q2hhbmdlLmVtaXQoc2VsZWN0ZWRSb3dDb250ZXh0KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5riF56m66YCJ5a6a6KGMXHJcbiAgICogQHBhcmFtIGNoYW5nZSDlj5jmm7RcclxuICAgKi9cclxuICBwcml2YXRlIGNsZWFyQ2hlY2tlZFJvd3MoY2hhbmdlOiBDaGFuZ2UpIHtcclxuICAgIGlmIChjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5Mb2FkICYmIHRoaXMuZ3JpZC5tdWx0aVNlbGVjdCkge1xyXG4gICAgICBjb25zdCBpc01hdGNoID0gdGhpcy5jaGVja0lmQ2hhbmdlTWF0Y2hCaW5kaW5nUGF0aChjaGFuZ2UpO1xyXG4gICAgICBpZiAoaXNNYXRjaCkge1xyXG4gICAgICAgIHRoaXMuc2V0Q2hlY2tzKFtdKTtcclxuICAgICAgICBpZiAodHlwZW9mICh0aGlzLmdyaWQuY2xlYXJDaGVja2VkcykgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgIHRoaXMuZ3JpZC5jbGVhckNoZWNrZWRzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyAjZW5kcmVnaW9uXHJcblxyXG5cclxuXHJcbiAgLy8gI3JlZ2lvbiDpgJrkv6FcclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572uQmluZGluZ0xpc3TnmoTlvZPliY3ooYxcclxuICAgKiBAcGFyYW0gaWQg5b2T5YmN6KGM5YaF56CBXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHNldFNlbGVjdGlvbklkVG9CaW5kaW5nRGF0YShpZDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICAvLyDlpoLmnpzlvZPliY3ooYzkuI3lrZjlnKjvvIzliJnlvLrliLborr7nva5cclxuICAgIGlmICghaWQpIHtcclxuICAgICAgdGhpcy5iaW5kaW5nTGlzdC5jdXJyZW50SWQgPSBpZDtcclxuICAgICAgaWYgKCF0aGlzLmdyaWQubXVsdGlTZWxlY3QpIHtcclxuICAgICAgICB0aGlzLnNldENoZWNrcyhbXSk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkICE9PSBpZCkge1xyXG4gICAgICB0aGlzLmJpbmRpbmdMaXN0LnNldEN1cnJlbnRJZChpZCwgdHJ1ZSk7XHJcbiAgICB9XHJcbiAgICAvLyDljZXpgInmqKHlvI/kuIvlsIblvZPliY3ooYzorr7nva7liLBpZHNcclxuICAgIGlmICghdGhpcy5ncmlkLm11bHRpU2VsZWN0KSB7XHJcbiAgICAgIHRoaXMuc2V0Q2hlY2tzKFtpZF0pO1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIHVwZGF0ZUNoZWNrZWRSb3dzKGNoYW5nZXM6IENoYW5nZSkge1xyXG4gICAgaWYgKGNoYW5nZXMudHlwZSA9PT0gQ2hhbmdlVHlwZS5Mb2FkKSB7XHJcbiAgICAgIHRoaXMuc2V0Q2hlY2tlZFJvd3MoKTtcclxuICAgIH0gZWxzZSBpZiAoY2hhbmdlcy50eXBlID09PSBDaGFuZ2VUeXBlLlZhbHVlQ2hhbmdlZCkge1xyXG4gICAgICBjb25zdCBpZHMgPSB0aGlzLmdldENoZWNrcygpO1xyXG4gICAgICBpZiAoY2hhbmdlcy5pZCAmJiBpZHMuaW5jbHVkZXMoY2hhbmdlcy5pZCkpIHtcclxuICAgICAgICB0aGlzLnNldENoZWNrZWRSb3dzKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6K6+572u6YCJ5oup6KGMXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHNldENoZWNrcyhpZHM6IHN0cmluZ1tdKSB7XHJcbiAgICB0aGlzLnZpZXdNb2RlbC51aVN0YXRlLnNldFByb3BlcnR5VmFsdWUoJ2lkcycsIGlkcyk7XHJcbiAgICB0aGlzLnNldENoZWNrZWRSb3dzKGlkcyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWLvumAieihjGlk5pWw57uEXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0Q2hlY2tzKCk6IHN0cmluZ1tdIHtcclxuICAgIHJldHVybiB0aGlzLnZpZXdNb2RlbC51aVN0YXRlWydpZHMnXSB8fCBbXTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5pu05paw5Yu+6YCJ6KGM5pWw5o2uXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHNldENoZWNrZWRSb3dzKGlkcz86IHN0cmluZ1tdKSB7XHJcbiAgICAvLyDpq5jpgJ/mqKHlvI/ml7bkuI3lho3orr7nva5yb3dzXHJcbiAgICAvLyBpZiAodGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQucnVuTW9kZSA9PT0gUnVuTW9kZS5oaWdoU3BlZWQpIHtcclxuICAgIC8vICAgcmV0dXJuO1xyXG4gICAgLy8gfVxyXG4gICAgaWYgKHR5cGVvZiBpZHMgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIGlkcyA9IHRoaXMudmlld01vZGVsLnVpU3RhdGVbJ2lkcyddIHx8IFtdO1xyXG4gICAgfVxyXG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGlkcykgfHwgaWRzLmxlbmd0aCA8IDEpIHtcclxuICAgICAgLy8g5q2k5pe2aWRz5rKh5pyJ5YC877yMcm93c+S4reS5n+S4jeW6lOivpeaciVxyXG4gICAgICB0aGlzLnZpZXdNb2RlbC51aVN0YXRlLnNldFByb3BlcnR5VmFsdWUoJ3Jvd3MnLCBudWxsKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgbGV0IGxpc3QgPSBbXTtcclxuICAgIC8vIFRPRE/vvJpyb3dz5Lit5pWw5o2u5Zyo6auY6YCf5qih5byP5ZKM5pmu6YCa5qih5byP5LiL5aSa6K+t5a2X5q6155qE5YC86KGo546w5LiN5LiA6Ie077yM6auY6YCf5qih5byP5LiL5aSa6K+t5a2X5q615YC85Li65a+56LGh77yM5pmu6YCa5qih5byP5Li65b2T5YmN6K+t6KiA44CC5pqC5LiN5aSE55CG6auY6YCf5qih5byP5Zy65pmvXHJcbiAgICBpZiAodGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQucnVuTW9kZSA9PT0gUnVuTW9kZS5oaWdoU3BlZWQpIHtcclxuICAgICAgbGlzdCA9IHRoaXMuZ3JpZC5kYXRhIHx8IFtdO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbGlzdCA9IHRoaXMuYmluZGluZ0xpc3QudG9KU09OKHsgaWdub3JlTXVsdGlMYW5nSW5wdXQ6IHRydWUgfSk7XHJcbiAgICB9XHJcbiAgICBjb25zdCByb3dzOiBNYXA8c3RyaW5nLCBhbnk+ID0gdGhpcy52aWV3TW9kZWwudWlTdGF0ZVsncm93cyddIHx8IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcclxuICAgIGlkcy5mb3JFYWNoKChpZDogYW55KSA9PiB7XHJcbiAgICAgIGNvbnN0IGl0ZW0gPSBsaXN0LmZpbmQoaXRlbSA9PiBpdGVtW3RoaXMucHJpbWFyeUtleV0gPT09IGlkKTtcclxuICAgICAgY29uc3Qgb3RoZXJQYWdlSXRlbSA9IHJvd3MuZ2V0KGlkKTtcclxuICAgICAgaWYgKGl0ZW0pIHtcclxuICAgICAgICByZXN1bHQuc2V0KGlkLCBpdGVtKTtcclxuICAgICAgfSBlbHNlIGlmIChvdGhlclBhZ2VJdGVtKSB7XHJcbiAgICAgICAgcmVzdWx0LnNldChpZCwgb3RoZXJQYWdlSXRlbSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgdGhpcy52aWV3TW9kZWwudWlTdGF0ZS5zZXRQcm9wZXJ0eVZhbHVlKCdyb3dzJywgcmVzdWx0KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6YCJ5LitZ3JpZOihjFxyXG4gICAqIEBwYXJhbSBpZCBpZFxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBzZWxlY3RHcmlkUm93KGlkOiBhbnkpIHtcclxuICAgIHRoaXMuZ3JpZC5zZWxlY3RSb3coaWQpO1xyXG4gICAgdGhpcy5ncmlkLnNjcm9sbFRvQ3VycmVudFJvdygpO1xyXG4gIH1cclxuICAvLyAjZW5kcmVnaW9uXHJcbiAgLy8gI3JlZ2lvbiDkuovku7blpITnkIblmahcclxuXHJcbiAgLyoqXHJcbiAgICog6aG156CB5YiH5o2i5LqL5Lu2XHJcbiAgICogQHBhcmFtIGV2ZW50IGV2ZW50XHJcbiAgICovXHJcbiAgQEhvc3RMaXN0ZW5lcigncGFnZUNoYW5nZWQnLCBbJyRldmVudCddKVxyXG4gIHB1YmxpYyBwYWdlQ2hhbmdlZEhhbmRsZXIoZXZlbnQ6IGFueSkge1xyXG4gICAgbGV0IHsgcGFnZUluZGV4LCBwYWdlU2l6ZSB9ID0gZXZlbnQ7XHJcbiAgICBpZiAocGFnZUluZGV4IDwgMSkge1xyXG4gICAgICBwYWdlSW5kZXggPSAxO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgc2tpcCA9IChwYWdlSW5kZXggLSAxKSAqIHBhZ2VTaXplO1xyXG4gICAgdGhpcy5iaW5kaW5nRGF0YS5zZXRQYWdpbmdJbmZvKHNraXAsIHBhZ2VTaXplLCB0aGlzLmJpbmRpbmdEYXRhLmJpbmRpbmdQYXRoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOihjOWIh+aNouS6i+S7tlxyXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxyXG4gICAqL1xyXG4gIEBIb3N0TGlzdGVuZXIoJ3NlbGVjdENoYW5nZWQnLCBbJyRldmVudCddKVxyXG4gIHB1YmxpYyBzZWxlY3RlZFJvd0NoYW5nZWQoZXZlbnQ6IGFueSkge1xyXG4gICAgY29uc3QgeyBpbmRleCwgZGF0YSB9ID0gZXZlbnQ7XHJcbiAgICBjb25zdCBpZCA9IGRhdGFbdGhpcy5wcmltYXJ5S2V5XTtcclxuICAgIHRoaXMuc2V0U2VsZWN0aW9uSWRUb0JpbmRpbmdEYXRhKGlkKTtcclxuICAgIHRoaXMuZmlyZVNlbGVjdGVkUm93Q2hhbmdlKGV2ZW50KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWPlua2iOihjOmAieaLqeS6i+S7tlxyXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxyXG4gICAqL1xyXG4gIEBIb3N0TGlzdGVuZXIoJ3VuU2VsZWN0JywgWyckZXZlbnQnXSlcclxuICBwdWJsaWMgdW5TZWxlY3RlZChldmVudDogYW55KSB7XHJcbiAgICBpZiAoIWV2ZW50KSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IHsgZGF0YSA9IHt9IH0gPSBldmVudDtcclxuICAgIGNvbnN0IGlkID0gZGF0YVt0aGlzLnByaW1hcnlLZXldO1xyXG4gICAgY29uc3QgY3VycmVudElkID0gdGhpcy5iaW5kaW5nTGlzdC5jdXJyZW50SWQ7XHJcbiAgICBpZiAoaWQgPT09IGN1cnJlbnRJZCkge1xyXG4gICAgICB0aGlzLnNldFNlbGVjdGlvbklkVG9CaW5kaW5nRGF0YShudWxsKTtcclxuICAgIH1cclxuICAgIC8vIHRoaXMuZmlyZVNlbGVjdGVkUm93Q2hhbmdlKGV2ZW50KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yu+6YCJ6KGM5Y+R55Sf5Y+Y5YyWXHJcbiAgICogQHBhcmFtIGV2ZW50IGV2ZW50XHJcbiAgICovXHJcbiAgQEhvc3RMaXN0ZW5lcignY2hlY2tlZENoYW5nZScsIFsnJGV2ZW50J10pXHJcbiAgcHVibGljIGNoZWNrZWRDaGFuZ2VkKGV2ZW50OiBhbnkpIHtcclxuICAgIGV2ZW50ID0gZXZlbnQgfHwgW107XHJcbiAgICBjb25zdCBpZHMgPSBldmVudC5tYXAoaXRlbSA9PiBpdGVtLmlkKTtcclxuICAgIHRoaXMuc2V0Q2hlY2tzKGlkcyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWIhumhteWkp+Wwj+WPmOabtOS6i+S7tlxyXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxyXG4gICAqL1xyXG4gIEBIb3N0TGlzdGVuZXIoJ3BhZ2VTaXplQ2hhbmdlZCcsIFsnJGV2ZW50J10pXHJcbiAgcHVibGljIHBhZ2VTaXplQ2hhbmdlZChldmVudDogYW55KSB7XHJcbiAgICBjb25zdCB7IHBhZ2VJbmRleCwgcGFnZVNpemUgfSA9IGV2ZW50O1xyXG4gICAgY29uc3Qgc2tpcCA9IDA7Ly8ocGFnZUluZGV4IC0gMSkgKiBwYWdlU2l6ZTtcclxuICAgIC8vIHRoaXMuYmluZGluZ0xpc3Quc2V0UGFnaW5hdGlvbkluZm8oc2tpcCwgcGFnZVNpemUpO1xyXG4gICAgdGhpcy5iaW5kaW5nRGF0YS5zZXRQYWdpbmdJbmZvKHNraXAsIHBhZ2VTaXplLCB0aGlzLmJpbmRpbmdEYXRhLmJpbmRpbmdQYXRoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIGdyaWTmu5rliqjliqDovb3mlbDmja5cclxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcclxuICAgKi9cclxuICBASG9zdExpc3RlbmVyKCdzY3JvbGxZTG9hZCcsIFsnJGV2ZW50J10pXHJcbiAgcHVibGljIHNjcm9sbFkoZXZlbnQ6IGFueSkge1xyXG4gICAgY29uc3QgeyBwYWdlcjogcGFnZUluZGV4LCBwYWdlU2l6ZSB9ID0gZXZlbnQ7XHJcbiAgICBjb25zdCBza2lwID0gKHBhZ2VJbmRleCAtIDEpICogcGFnZVNpemU7XHJcbiAgICB0aGlzLmJpbmRpbmdEYXRhLnNldFBhZ2luZ0luZm8oc2tpcCwgcGFnZVNpemUsIHRoaXMuYmluZGluZ0RhdGEuYmluZGluZ1BhdGgpO1xyXG4gIH1cclxuICBASG9zdExpc3RlbmVyKCdmaWx0ZXJDaGFuZ2VkJywgWyckZXZlbnQnXSlcclxuICBwdWJsaWMgZmlsdGVyQ2hhbmdlZChldmVudDogYW55KSB7XHJcbiAgICB0aGlzLmZpbHRlcnMgPSBldmVudDtcclxuICB9XHJcbiAgLy8gI2VuZHJlZ2lvblxyXG4gIHByaXZhdGUgY2hlY2tJZkNoYW5nZU1hdGNoQmluZGluZ1BhdGgoY2hhbmdlOiBDaGFuZ2UpOiBib29sZWFuIHtcclxuICAgIGxldCBpc01hdGNoID0gZmFsc2U7XHJcbiAgICBpZiAoIWNoYW5nZSB8fCAhY2hhbmdlLnBhdGgpIHtcclxuICAgICAgcmV0dXJuIGlzTWF0Y2g7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY2hhbmdlUGF0aEFycmF5ID0gY2hhbmdlLnBhdGg7XHJcbiAgICBpZiAoIWNoYW5nZVBhdGhBcnJheSkge1xyXG4gICAgICByZXR1cm4gaXNNYXRjaDtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoISh0aGlzLmJpbmRpbmdEYXRhKSAmJiAhKHRoaXMuYmluZGluZ0RhdGEuYmluZGluZ1BhdGgpKSB7XHJcbiAgICAgIHJldHVybiBpc01hdGNoO1xyXG4gICAgfVxyXG4gICAgY29uc3QgYmluZ2RpbmdQYXRoQXJyYXkgPSB0aGlzLmJpbmRpbmdEYXRhLmJpbmRpbmdQYXRoLnNwbGl0KCcvJyk7XHJcbiAgICBpZiAoYmluZ2RpbmdQYXRoQXJyYXkubGVuZ3RoIDw9IDApIHtcclxuICAgICAgcmV0dXJuIGlzTWF0Y2g7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGNoYW5nZVBhdGhBcnJheS5sZW5ndGggPT09IDApIHsgLy8g5Li76KGoXHJcbiAgICAgIGlmICh0aGlzLmJpbmRpbmdEYXRhLmJpbmRpbmdQYXRoID09PSAnLycpIHtcclxuICAgICAgICBpc01hdGNoID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChjaGFuZ2UucGF0aC5sZW5ndGggPT09IDEpIHsvLyDkuLvku47ooahcclxuICAgICAgaWYgKGJpbmdkaW5nUGF0aEFycmF5Lmxlbmd0aCA9PT0gMiAmJiBiaW5nZGluZ1BhdGhBcnJheVsxXSA9PT0gY2hhbmdlLnBhdGhbMF0pIHtcclxuICAgICAgICBpc01hdGNoID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChjaGFuZ2UucGF0aC5sZW5ndGggPT09IDIpIHsgLy8g5Li75LuO5LuO6KGoXHJcbiAgICAgIGlmIChiaW5nZGluZ1BhdGhBcnJheS5sZW5ndGggPT09IDMgJiYgYmluZ2RpbmdQYXRoQXJyYXlbMV0gPT09IGNoYW5nZS5wYXRoWzBdICYmIGJpbmdkaW5nUGF0aEFycmF5WzJdID09PSBjaGFuZ2UucGF0aFsxXSkge1xyXG4gICAgICAgIGlzTWF0Y2ggPSB0cnVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGlzTWF0Y2g7XHJcbiAgfVxyXG4gIHByaXZhdGUgZGVib3VuY2UoY2FsbGJhY2s6ICguLi5hcmdzKSA9PiBhbnksIHdhaXQpIHtcclxuICAgIGxldCB0aW1lb3V0SWQgPSBudWxsO1xyXG4gICAgcmV0dXJuICguLi5hcmdzKSA9PiB7XHJcbiAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGltZW91dElkKTtcclxuICAgICAgdGltZW91dElkID0gd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgIGNhbGxiYWNrLmFwcGx5KG51bGwsIGFyZ3MpO1xyXG4gICAgICB9LCB3YWl0KTtcclxuICAgIH07XHJcbiAgfVxyXG59XHJcbiJdfQ==