import { Directive, Input, Injector, NgZone, } from '@angular/core';
import { of } from 'rxjs';
import { BindingData, ViewModel, ENABLE_EDIT_STATE_FILTER_SORTING } from '@farris/devkit';
import { DatagridComponent } from '@farris/ui-datagrid';
import { isNumber } from 'lodash-es';
import { DateTimeHelperService } from '@farris/ui-common/date';
import { RuntimeStateService } from '@farris/ui-common';
import { DialogService } from '@farris/ui-dialog';
export class EditableDirective {
    constructor(bindingData, viewModel, grid, dateService, injector, rts, dialogSer, ngZone) {
        this.bindingData = bindingData;
        this.viewModel = viewModel;
        this.grid = grid;
        this.dateService = dateService;
        this.injector = injector;
        this.rts = rts;
        this.dialogSer = dialogSer;
        this.ngZone = ngZone;
        /**
         * 编辑时取消分组
         */
        this.disableGroupOnEditing = true;
        /**
         * 多选帮助默认分隔符
         */
        this.defaultSpliter = ',';
        /**
         * 临时记录grid分组字段
         */
        this.groupFields = [];
    }
    get bindingList() {
        // 根实体
        if (this.viewModel.bindingPath === '/' || !this.viewModel.bindingPath) {
            return this.bindingData.list;
        }
        // 子实体
        let bindingPath = this.viewModel.bindingPath.substr(1);
        bindingPath = bindingPath[0].toLowerCase() + bindingPath.substring(1, bindingPath.length);
        const paths = bindingPath.split('/');
        const filteredPaths = paths.filter((part) => {
            return part !== '';
        });
        return this.bindingData.getValue(filteredPaths);
    }
    ngOnInit() {
        this.apply();
    }
    ngOnChanges(changes) {
        this.apply();
    }
    ngOnDestroy() {
        this.detach();
    }
    /**
     * 应用属性
     */
    apply() {
        if (!this.grid) {
            return;
        }
        this.handleGroupStatus();
        // 是否启用了编辑态过滤排序
        if (this.gridEditable) {
            const enableFilterSorting = this.injector && this.injector.get(ENABLE_EDIT_STATE_FILTER_SORTING, false) || false;
            if (!this.grid.remoteFilter && !enableFilterSorting) {
                this.grid.clearCondition();
                // 发送清空过滤条件事件
                this.viewModel.frameContext.appContext.messagePipe.next('CLEAR_GRID_CONDITION');
            }
            this.grid.editable = true;
            if (!this.viewModel.frameContext.appContext.enableGridHeaderWhenEditing && !enableFilterSorting) {
                this.grid.disableHeader(true);
            }
            this.handleBeginEditEvent();
            this.handleAfterEditEvent();
            this.handleEndEditEvent();
        }
        else {
            this.grid.editable = false;
            this.grid.disableHeader(false);
            // TODO:应由表格兼容，但目前补丁不能继续依赖表格组件，临时使用该方案处理
            // 2023-12-25 表格内部已解决列设置后表头无法拖动问题，且兼容代码存在覆盖开发者设置的自定义列名称的问题
            // this.grid.columns = this.grid.columns.map((cols) => {
            //   return cols.map((col) => Object.assign({}, col));
            // });
            // this.grid.columnsChanged(false);
            if (this.grid && typeof this.grid.sort === 'function' && this.grid.sortName) {
                this.grid.sort();
            }
            this.detach();
        }
    }
    /**
     * 编辑时取消分组
     */
    handleGroupStatus() {
        if (this.disableGroupOnEditing === false) {
            return;
        }
        const groupField = this.grid && this.grid.groupField || null;
        if (groupField) {
            if (this.gridEditable) {
                this.groupFields = [groupField];
                this.grid.setGroupFields('');
            }
        }
        else {
            if (this.groupFields && this.groupFields.length > 0) {
                const groupField = this.groupFields.pop();
                if (this.groupFields.length > 0) {
                    this.groupFields = [];
                }
                this.grid.setGroupFields(groupField);
            }
        }
    }
    /**
     * 处理开始编辑事件
     */
    handleBeginEditEvent() {
        this.beginEditSubscription = this.grid.beginEdit.subscribe((e) => {
            if (!e) {
                return;
            }
            const column = e.column;
            if (column && column.editor) {
                const editorInstance = e.editor.componentRef.instance;
                if (!editorInstance || !editorInstance.instance) {
                    return;
                }
                let mapFields = editorInstance.instance.mapFields;
                if (column.editor.type === 'lookup' || column.editor.type === 'PersonnelSelector' || column.editor.type === 'OrganizationSelector' || column.editor.type === 'external-integration' || 'EmployeeSelector' === column.editor.type || 'EmployeeOrgSelector' === column.editor.type) {
                    const lookupGrid = editorInstance.instance;
                    const subject = editorInstance.instance.selectedData;
                    if (subject) {
                        subject.subscribe((data) => {
                            mapFields = editorInstance.instance.mapFields;
                            const spliter = lookupGrid.multipleChoiceSeparator || this.defaultSpliter;
                            this.lookupMapping(data, mapFields, false, spliter);
                        });
                    }
                    const clearMappings = editorInstance.instance.clearMappings;
                    if (clearMappings) {
                        clearMappings.subscribe((result) => {
                            const mapFields = Object.assign({}, editorInstance.instance.mapFields);
                            const value = result && result.value || null;
                            const binding = editorInstance.column && editorInstance.column.field;
                            const lookupTextField = editorInstance.instance.textField;
                            const data = {};
                            if (binding) {
                                const textFieldMapping = mapFields[lookupTextField];
                                if (textFieldMapping) {
                                    const otherField = textFieldMapping.split(',').filter((item) => item !== binding).join(',');
                                    if (otherField) {
                                        mapFields[lookupTextField] = otherField;
                                    }
                                    else {
                                        delete mapFields[lookupTextField];
                                    }
                                }
                                const parentPaths = this.getBindingPathArray();
                                this.bindingData.setValue(parentPaths.concat(binding.split('.')), value, true, true);
                            }
                            // this.setValue(data, lookupTextField.split('.'), value);
                            if (mapFields && Object.keys(mapFields).length > 0) {
                                Object.keys(mapFields).forEach((field) => {
                                    this.setValue(data, field.split('.'), '');
                                });
                                this.lookupMapping(data, mapFields, true);
                            }
                        });
                    }
                }
                if (column.editor.type === 'combo-lookup') {
                    editorInstance.instance.valueChange.subscribe((e) => {
                        const asClear = e && e.selections && e.selections.length === 0;
                        const comboLookup = editorInstance.instance;
                        mapFields = editorInstance.instance.mapFields;
                        const spliter = comboLookup.separator || this.defaultSpliter;
                        this.lookupMapping(e.selections || [], mapFields, asClear, spliter);
                    });
                }
                if (['combo-lookup', 'combolist', 'lookup', 'PersonnelSelector', 'OrganizationSelector', 'external-integration', 'EmployeeSelector', 'EmployeeOrgSelector'].includes(column.editor.type)) {
                    if (editorInstance.instance.clear && editorInstance.instance.clear.subscribe) {
                        editorInstance.instance.clear.subscribe(() => {
                            this.lookupMapping(null, mapFields);
                        });
                    }
                }
                if (column.editor.type === 'combolist') {
                    if (mapFields) {
                        editorInstance.instance.valueChange.subscribe((e) => {
                            const pathArr = this.getBindingPathArray();
                            this.viewModel.bindingData.setValue(pathArr.concat(mapFields.split('.')), editorInstance.instance.selectedValues, true, true);
                        });
                    }
                }
            }
        });
    }
    /**
     * 处理编辑事件
     */
    handleAfterEditEvent() {
        this.grid.afterEdit = (rowIndex, rowData, column, editor) => {
            if (this.dialogSer.hasDialogOpened()) {
                return of(false);
            }
            if (this.rts) {
                // 帮助组件文本变化后去查询
                if (this.rts.getFormState('lookup.pending')) {
                    return of(false);
                }
            }
            // 更新数据源
            if (!editor || !editor.formControl) {
                return of(false);
            }
            return of(true);
        };
    }
    /**
     * 处理结束编辑事件
     */
    handleEndEditEvent() {
        this.endEditSubscription = this.grid && this.grid.endEdit && this.grid.endEdit.subscribe((event) => {
            const { value = undefined, column = undefined, rowData = {} } = event || {};
            const primaryValue = rowData && rowData[this.grid.idField] || null;
            this.updateBindingData(value, column, primaryValue);
        });
    }
    /*
     * 给列表赋值 或给formcontrol赋值
     */
    updateBindingData(value, column, primaryValue) {
        if (!column) {
            return;
        }
        const currentColumnType = column.dataType;
        // 同时判断gridOption的列对象
        const fieldPaths = column.field.split('.');
        // 是否为大数
        const isBigNumber = column && column.editor && column.editor.options && column.editor.options.bigNumber;
        // 存在行编辑器
        if (currentColumnType === 'date') {
            let result;
            if (value) {
                result = this.dateService.formatTo(value, 'yyyy-MM-dd');
            }
            else {
                result = value;
            }
            this.updateBindingList(primaryValue, fieldPaths.join('.'), result);
        }
        else if (currentColumnType === 'datetime') {
            // if (!value) {
            //   value = '0001-01-01T00:00:00';
            // }
            this.updateBindingList(primaryValue, fieldPaths.join('.'), value);
        }
        else if (currentColumnType === 'number' && !isBigNumber) {
            if (value === null || value === undefined) {
                this.updateBindingList(primaryValue, fieldPaths.join('.'), null);
            }
            else {
                this.updateBindingList(primaryValue, fieldPaths.join('.'), Number(value));
            }
        }
        else {
            this.updateBindingList(primaryValue, fieldPaths.join('.'), value);
        }
    }
    updateBindingList(primaryValue, propertyName, value) {
        const viewModel = this.viewModel || null;
        if (!viewModel || !propertyName) {
            return;
        }
        // 更新主表部分行的字段
        const propertyNames = propertyName.split('.').filter((item) => item);
        const bindingPath = this.getBindingPathArray();
        // 取出来的一定是bindingList
        const list = this.bindingData.getValue(bindingPath);
        // 修改的是当前行
        if (list && primaryValue === list.currentItem.primaryKeyValue) {
            const paths = bindingPath.concat(propertyNames);
            this.bindingData.setValue(paths, value, true, true);
            return;
        }
        const bindingObject = this.bindingList.findById(primaryValue);
        if (!bindingObject) {
            return;
        }
        if (propertyNames.length < 2) {
            bindingObject.setValue(propertyName, value, true, true);
        }
        else {
            let targetBindingObject = null;
            const fpaths = propertyNames.slice(0, propertyNames.length - 1);
            const targetPropertyName = propertyNames[propertyNames.length - 1];
            fpaths.forEach((prop) => {
                targetBindingObject = targetBindingObject && targetBindingObject[prop] || bindingObject[prop];
            });
            // todo:需要添加值变化事件
            targetBindingObject.setValue(targetPropertyName, value, true, true);
        }
    }
    detach() {
        if (this.beginEditSubscription && typeof this.beginEditSubscription.unsubscribe === 'function') {
            this.beginEditSubscription.unsubscribe();
        }
        if (this.endEditSubscription && typeof this.endEditSubscription.unsubscribe === 'function') {
            this.endEditSubscription.unsubscribe();
        }
    }
    //#region 帮助字段映射
    lookupMapping(helpData, mapFields, asClear = false, spliter = ',') {
        if (!mapFields) {
            return;
        }
        // 关闭变更检测
        const appContext = this.viewModel.frameContext.appContext;
        appContext.changeDetectionController.detach();
        const pathArr = this.getBindingPathArray();
        let helpFields = Object.keys(mapFields);
        const primaryInfo = this.getMapFieldsPrimaryKey(mapFields, pathArr);
        let primaryKeys = primaryInfo && primaryInfo.map((item) => item.primaryKey) || [];
        const primaryFields = primaryInfo && primaryInfo.map((item) => item.primaryField) || [];
        // 去重
        if (primaryKeys && primaryKeys.length > 0) {
            primaryKeys = [...new Set(primaryKeys)];
            helpFields = this.sortMapFieldKeys(helpFields, primaryKeys);
        }
        if (!helpData || asClear) {
            helpFields.reverse();
        }
        helpFields.forEach((f) => {
            let val = '';
            if (helpData) {
                if (helpData instanceof Array) {
                    val = helpData.map((h) => {
                        return this.getValue(f, h);
                    }).join(spliter);
                }
                else {
                    val = this.getValue(f, helpData);
                }
            }
            let mappings = mapFields[f].split(',');
            const headMappings = mappings.filter((p) => primaryFields.includes(p));
            const leftMappings = mappings.filter((p) => !primaryFields.includes(p));
            if (!helpData) {
                mappings = [].concat(leftMappings).concat(headMappings);
            }
            else {
                mappings = [].concat(headMappings).concat(leftMappings);
            }
            mappings.forEach((ff) => {
                if (!helpData) {
                    this.viewModel.bindingData.clearValue(pathArr.concat(ff.split('.')), true, true);
                }
                else {
                    this.viewModel.bindingData.setValue(pathArr.concat(ff.split('.')), val, true, true);
                }
            });
        });
        // 重新打开变更检测
        appContext.changeDetectionController.reattach();
    }
    getValue(f, data) {
        let val = '';
        if (f.indexOf('.') === -1) {
            val = data[f];
        }
        else {
            val = f.split('.').reduce((a, b) => {
                return a[b];
            }, data);
        }
        return val;
    }
    getBindingPathArray() {
        const path = this.viewModel.bindingPath;
        if (path) {
            return path.split('/').filter((n) => n !== '');
        }
        return [];
    }
    isNumberValue(field, data) {
        const currentVal = this.getValue(field, data);
        return isNumber(currentVal);
    }
    //#endregion
    /**
     *
     * @param mapFields  格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"} 或者 {id:'vid',code:'code',name:'name'}
     */
    getMapFieldsPrimaryKey(mapFields, bindingPaths) {
        if (!mapFields || Object.keys(mapFields).length < 1) {
            return null;
        }
        const results = [];
        // let primaryField = null;
        try {
            const entityTypeInfo = this.viewModel.frameContext.repository.entityTypeInfo;
            Object.keys(mapFields).forEach((key) => {
                const mapField = mapFields[key];
                if (mapField && typeof mapField === 'string') {
                    const mappings = mapField.split(',').filter((p) => p);
                    mappings.forEach((item) => {
                        let paths = item.split('.');
                        if (bindingPaths && bindingPaths.length > 0) {
                            paths = bindingPaths.concat(paths);
                        }
                        const propInfo = entityTypeInfo.getPropInfoByPath(paths);
                        if (propInfo && propInfo.metadataInfo && propInfo.metadataInfo.primary === true) {
                            results.push({
                                primaryKey: key,
                                primaryField: item
                            });
                        }
                    });
                }
            });
        }
        catch (e) {
            console.error(e);
        }
        return results;
    }
    setValue(target, paths, value) {
        if (target) {
            if (paths.length <= 1) {
                target[paths[0]] = value;
            }
            else {
                paths.slice(0, -1).reduce((prev, path) => {
                    if (!(prev.hasOwnProperty(path) || prev['__proto__'].hasOwnProperty(path))) {
                        prev[path] = {};
                    }
                    return prev[path];
                }, target)[paths[paths.length - 1]] = value;
            }
        }
    }
    sortMapFieldKeys(keys, primaryKeys) {
        if (!primaryKeys || primaryKeys.length < 1 || !keys || keys.length < 1) {
            return keys;
        }
        // 过滤出非主键映射字段
        keys = keys.filter((p) => !primaryKeys.includes(p));
        return [].concat(primaryKeys).concat(keys);
    }
}
EditableDirective.decorators = [
    { type: Directive, args: [{
                selector: '[farris-datagrid-editable]'
            },] }
];
/** @nocollapse */
EditableDirective.ctorParameters = () => [
    { type: BindingData },
    { type: ViewModel },
    { type: DatagridComponent },
    { type: DateTimeHelperService },
    { type: Injector },
    { type: RuntimeStateService },
    { type: DialogService },
    { type: NgZone }
];
EditableDirective.propDecorators = {
    gridEditable: [{ type: Input, args: ['farris-datagrid-editable',] }],
    disableGroupOnEditing: [{ type: Input, args: ['disableGroupOnEditing',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdGFibGUuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9rZW5kby1iaW5kaW5nLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZXMvZmFycmlzLWRhdGFncmlkL2VkaXRhYmxlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUErQyxLQUFLLEVBQUUsUUFBUSxFQUFFLE1BQU0sR0FDaEYsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLEVBQUUsRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDeEMsT0FBTyxFQUNMLFdBQVcsRUFBZSxTQUFTLEVBQThCLGdDQUFnQyxFQUNsRyxNQUFNLGdCQUFnQixDQUFDO0FBQ3hCLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDckMsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDL0QsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBT2xELE1BQU0sT0FBTyxpQkFBaUI7SUFrQzVCLFlBQ1MsV0FBd0IsRUFDeEIsU0FBb0IsRUFDcEIsSUFBdUIsRUFDdEIsV0FBa0MsRUFDbkMsUUFBa0IsRUFDakIsR0FBd0IsRUFDekIsU0FBd0IsRUFDeEIsTUFBYztRQVBkLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDcEIsU0FBSSxHQUFKLElBQUksQ0FBbUI7UUFDdEIsZ0JBQVcsR0FBWCxXQUFXLENBQXVCO1FBQ25DLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDakIsUUFBRyxHQUFILEdBQUcsQ0FBcUI7UUFDekIsY0FBUyxHQUFULFNBQVMsQ0FBZTtRQUN4QixXQUFNLEdB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dGVudCI6WyJpbXBvcnQge1xyXG4gIERpcmVjdGl2ZSwgT25Jbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSwgU2ltcGxlQ2hhbmdlcywgSW5wdXQsIEluamVjdG9yLCBOZ1pvbmUsXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IG9mLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHtcclxuICBCaW5kaW5nRGF0YSwgQmluZGluZ0xpc3QsIFZpZXdNb2RlbCwgRGF0YVR5cGVJbmZvLCBEYXRhUHJvcEluZm8sIEVOQUJMRV9FRElUX1NUQVRFX0ZJTFRFUl9TT1JUSU5HXHJcbn0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBEYXRhZ3JpZENvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YWdyaWQnO1xyXG5pbXBvcnQgeyBpc051bWJlciB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IERhdGVUaW1lSGVscGVyU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktY29tbW9uL2RhdGUnO1xyXG5pbXBvcnQgeyBSdW50aW1lU3RhdGVTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24nO1xyXG5pbXBvcnQgeyBEaWFsb2dTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1kaWFsb2cnO1xyXG5pbXBvcnQgeyBMb29rdXBHcmlkQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1sb29rdXAnO1xyXG5pbXBvcnQgeyBDb21ib0xvb2t1cENvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktY29tYm8tbG9va3VwJztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW2ZhcnJpcy1kYXRhZ3JpZC1lZGl0YWJsZV0nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBFZGl0YWJsZURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xyXG4gIC8qKlxyXG4gICAqIGdyaWTmmK/lkKblj6/ku6XnvJbovpFcclxuICAgKi9cclxuICBASW5wdXQoJ2ZhcnJpcy1kYXRhZ3JpZC1lZGl0YWJsZScpIGdyaWRFZGl0YWJsZTogYm9vbGVhbjtcclxuICAvKipcclxuICAgKiDnvJbovpHml7blj5bmtojliIbnu4RcclxuICAgKi9cclxuICBASW5wdXQoJ2Rpc2FibGVHcm91cE9uRWRpdGluZycpIGRpc2FibGVHcm91cE9uRWRpdGluZzogYm9vbGVhbiA9IHRydWU7XHJcbiAgLyoqXHJcbiAgICog5aSa6YCJ5biu5Yqp6buY6K6k5YiG6ZqU56ymXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBkZWZhdWx0U3BsaXRlcjogc3RyaW5nID0gJywnO1xyXG4gIHByaXZhdGUgYmVnaW5FZGl0U3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XHJcbiAgcHJpdmF0ZSBlbmRFZGl0U3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XHJcbiAgLyoqXHJcbiAgICog5Li05pe26K6w5b2VZ3JpZOWIhue7hOWtl+autVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ3JvdXBGaWVsZHM6IGFueVtdID0gW107XHJcbiAgcHJvdGVjdGVkIGdldCBiaW5kaW5nTGlzdCgpOiBCaW5kaW5nTGlzdCB7XHJcbiAgICAvLyDmoLnlrp7kvZNcclxuICAgIGlmICh0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCA9PT0gJy8nIHx8ICF0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5iaW5kaW5nRGF0YS5saXN0O1xyXG4gICAgfVxyXG4gICAgLy8g5a2Q5a6e5L2TXHJcbiAgICBsZXQgYmluZGluZ1BhdGggPSB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zdWJzdHIoMSk7XHJcbiAgICBiaW5kaW5nUGF0aCA9IGJpbmRpbmdQYXRoWzBdLnRvTG93ZXJDYXNlKCkgKyBiaW5kaW5nUGF0aC5zdWJzdHJpbmcoMSwgYmluZGluZ1BhdGgubGVuZ3RoKTtcclxuICAgIGNvbnN0IHBhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKTtcclxuXHJcbiAgICBjb25zdCBmaWx0ZXJlZFBhdGhzID0gcGF0aHMuZmlsdGVyKChwYXJ0OiBzdHJpbmcpID0+IHtcclxuICAgICAgcmV0dXJuIHBhcnQgIT09ICcnO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcy5iaW5kaW5nRGF0YS5nZXRWYWx1ZShmaWx0ZXJlZFBhdGhzKTtcclxuICB9XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwdWJsaWMgYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhLFxyXG4gICAgcHVibGljIHZpZXdNb2RlbDogVmlld01vZGVsLFxyXG4gICAgcHVibGljIGdyaWQ6IERhdGFncmlkQ29tcG9uZW50LFxyXG4gICAgcHJpdmF0ZSBkYXRlU2VydmljZTogRGF0ZVRpbWVIZWxwZXJTZXJ2aWNlLFxyXG4gICAgcHVibGljIGluamVjdG9yOiBJbmplY3RvcixcclxuICAgIHByaXZhdGUgcnRzOiBSdW50aW1lU3RhdGVTZXJ2aWNlLFxyXG4gICAgcHVibGljIGRpYWxvZ1NlcjogRGlhbG9nU2VydmljZSxcclxuICAgIHB1YmxpYyBuZ1pvbmU6IE5nWm9uZVxyXG4gICkgeyB9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgdGhpcy5hcHBseSgpO1xyXG4gIH1cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XHJcbiAgICB0aGlzLmFwcGx5KCk7XHJcbiAgfVxyXG4gIG5nT25EZXN0cm95KCkge1xyXG4gICAgdGhpcy5kZXRhY2goKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5bqU55So5bGe5oCnXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhcHBseSgpIHtcclxuICAgIGlmICghdGhpcy5ncmlkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuaGFuZGxlR3JvdXBTdGF0dXMoKTtcclxuICAgIC8vIOaYr+WQpuWQr+eUqOS6hue8lui+keaAgei/h+a7pOaOkuW6j1xyXG4gICAgaWYgKHRoaXMuZ3JpZEVkaXRhYmxlKSB7XHJcbiAgICAgIGNvbnN0IGVuYWJsZUZpbHRlclNvcnRpbmcgPSB0aGlzLmluamVjdG9yICYmIHRoaXMuaW5qZWN0b3IuZ2V0PGJvb2xlYW4+KEVOQUJMRV9FRElUX1NUQVRFX0ZJTFRFUl9TT1JUSU5HLCBmYWxzZSkgfHwgZmFsc2U7XHJcbiAgICAgIGlmICghdGhpcy5ncmlkLnJlbW90ZUZpbHRlciAmJiAhZW5hYmxlRmlsdGVyU29ydGluZykge1xyXG4gICAgICAgIHRoaXMuZ3JpZC5jbGVhckNvbmRpdGlvbigpO1xyXG4gICAgICAgIC8vIOWPkemAgea4heepuui/h+a7pOadoeS7tuS6i+S7tlxyXG4gICAgICAgIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0Lm1lc3NhZ2VQaXBlLm5leHQoJ0NMRUFSX0dSSURfQ09ORElUSU9OJyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMuZ3JpZC5lZGl0YWJsZSA9IHRydWU7XHJcbiAgICAgIGlmICghdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZW5hYmxlR3JpZEhlYWRlcldoZW5FZGl0aW5nICYmICFlbmFibGVGaWx0ZXJTb3J0aW5nKSB7XHJcbiAgICAgICAgdGhpcy5ncmlkLmRpc2FibGVIZWFkZXIodHJ1ZSk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5oYW5kbGVCZWdpbkVkaXRFdmVudCgpO1xyXG4gICAgICB0aGlzLmhhbmRsZUFmdGVyRWRpdEV2ZW50KCk7XHJcbiAgICAgIHRoaXMuaGFuZGxlRW5kRWRpdEV2ZW50KCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmdyaWQuZWRpdGFibGUgPSBmYWxzZTtcclxuICAgICAgdGhpcy5ncmlkLmRpc2FibGVIZWFkZXIoZmFsc2UpO1xyXG4gICAgICAvLyBUT0RPOuW6lOeUseihqOagvOWFvOWuue+8jOS9huebruWJjeihpeS4geS4jeiDvee7p+e7reS+nei1luihqOagvOe7hOS7tu+8jOS4tOaXtuS9v+eUqOivpeaWueahiOWkhOeQhlxyXG4gICAgICAvLyAyMDIzLTEyLTI1IOihqOagvOWGhemDqOW3suino+WGs+WIl+iuvue9ruWQjuihqOWktOaXoOazleaLluWKqOmXrumimO+8jOS4lOWFvOWuueS7o+eggeWtmOWcqOimhuebluW8gOWPkeiAheiuvue9rueahOiHquWumuS5ieWIl+WQjeensOeahOmXrumimFxyXG4gICAgICAvLyB0aGlzLmdyaWQuY29sdW1ucyA9IHRoaXMuZ3JpZC5jb2x1bW5zLm1hcCgoY29scykgPT4ge1xyXG4gICAgICAvLyAgIHJldHVybiBjb2xzLm1hcCgoY29sKSA9PiBPYmplY3QuYXNzaWduKHt9LCBjb2wpKTtcclxuICAgICAgLy8gfSk7XHJcbiAgICAgIC8vIHRoaXMuZ3JpZC5jb2x1bW5zQ2hhbmdlZChmYWxzZSk7XHJcbiAgICAgIGlmICh0aGlzLmdyaWQgJiYgdHlwZW9mIHRoaXMuZ3JpZC5zb3J0ID09PSAnZnVuY3Rpb24nICYmIHRoaXMuZ3JpZC5zb3J0TmFtZSkge1xyXG4gICAgICAgIHRoaXMuZ3JpZC5zb3J0KCk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5kZXRhY2goKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog57yW6L6R5pe25Y+W5raI5YiG57uEXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBoYW5kbGVHcm91cFN0YXR1cygpIHtcclxuICAgIGlmICh0aGlzLmRpc2FibGVHcm91cE9uRWRpdGluZyA9PT0gZmFsc2UpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZ3JvdXBGaWVsZCA9IHRoaXMuZ3JpZCAmJiB0aGlzLmdyaWQuZ3JvdXBGaWVsZCB8fCBudWxsO1xyXG4gICAgaWYgKGdyb3VwRmllbGQpIHtcclxuICAgICAgaWYgKHRoaXMuZ3JpZEVkaXRhYmxlKSB7XHJcbiAgICAgICAgdGhpcy5ncm91cEZpZWxkcyA9IFtncm91cEZpZWxkXTtcclxuICAgICAgICB0aGlzLmdyaWQuc2V0R3JvdXBGaWVsZHMoJycpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAodGhpcy5ncm91cEZpZWxkcyAmJiB0aGlzLmdyb3VwRmllbGRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb25zdCBncm91cEZpZWxkID0gdGhpcy5ncm91cEZpZWxkcy5wb3AoKTtcclxuICAgICAgICBpZiAodGhpcy5ncm91cEZpZWxkcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICB0aGlzLmdyb3VwRmllbGRzID0gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZ3JpZC5zZXRHcm91cEZpZWxkcyhncm91cEZpZWxkKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDlpITnkIblvIDlp4vnvJbovpHkuovku7ZcclxuICAgKi9cclxuICBwcml2YXRlIGhhbmRsZUJlZ2luRWRpdEV2ZW50KCkge1xyXG4gICAgdGhpcy5iZWdpbkVkaXRTdWJzY3JpcHRpb24gPSB0aGlzLmdyaWQuYmVnaW5FZGl0LnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgIGlmICghZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBjb2x1bW4gPSBlLmNvbHVtbjtcclxuICAgICAgaWYgKGNvbHVtbiAmJiBjb2x1bW4uZWRpdG9yKSB7XHJcbiAgICAgICAgY29uc3QgZWRpdG9ySW5zdGFuY2UgPSBlLmVkaXRvci5jb21wb25lbnRSZWYuaW5zdGFuY2U7XHJcbiAgICAgICAgaWYgKCFlZGl0b3JJbnN0YW5jZSB8fCAhZWRpdG9ySW5zdGFuY2UuaW5zdGFuY2UpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IG1hcEZpZWxkcyA9IGVkaXRvckluc3RhbmNlLmluc3RhbmNlLm1hcEZpZWxkcztcclxuICAgICAgICBpZiAoY29sdW1uLmVkaXRvci50eXBlID09PSAnbG9va3VwJyB8fCBjb2x1bW4uZWRpdG9yLnR5cGUgPT09ICdQZXJzb25uZWxTZWxlY3RvcicgfHwgY29sdW1uLmVkaXRvci50eXBlID09PSAnT3JnYW5pemF0aW9uU2VsZWN0b3InIHx8IGNvbHVtbi5lZGl0b3IudHlwZSA9PT0gJ2V4dGVybmFsLWludGVncmF0aW9uJyB8fCAnRW1wbG95ZWVTZWxlY3RvcicgPT09IGNvbHVtbi5lZGl0b3IudHlwZSB8fCAnRW1wbG95ZWVPcmdTZWxlY3RvcicgPT09IGNvbHVtbi5lZGl0b3IudHlwZSkge1xyXG4gICAgICAgICAgY29uc3QgbG9va3VwR3JpZDogTG9va3VwR3JpZENvbXBvbmVudCA9IGVkaXRvckluc3RhbmNlLmluc3RhbmNlO1xyXG4gICAgICAgICAgY29uc3Qgc3ViamVjdCA9IGVkaXRvckluc3RhbmNlLmluc3RhbmNlLnNlbGVjdGVkRGF0YTtcclxuICAgICAgICAgIGlmIChzdWJqZWN0KSB7XHJcbiAgICAgICAgICAgIHN1YmplY3Quc3Vic2NyaWJlKChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICBtYXBGaWVsZHMgPSBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS5tYXBGaWVsZHM7XHJcbiAgICAgICAgICAgICAgY29uc3Qgc3BsaXRlciA9IGxvb2t1cEdyaWQubXVsdGlwbGVDaG9pY2VTZXBhcmF0b3IgfHwgdGhpcy5kZWZhdWx0U3BsaXRlcjtcclxuICAgICAgICAgICAgICB0aGlzLmxvb2t1cE1hcHBpbmcoZGF0YSwgbWFwRmllbGRzLCBmYWxzZSwgc3BsaXRlcik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgY2xlYXJNYXBwaW5ncyA9IGVkaXRvckluc3RhbmNlLmluc3RhbmNlLmNsZWFyTWFwcGluZ3M7XHJcbiAgICAgICAgICBpZiAoY2xlYXJNYXBwaW5ncykge1xyXG4gICAgICAgICAgICBjbGVhck1hcHBpbmdzLnN1YnNjcmliZSgocmVzdWx0OiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICBjb25zdCBtYXBGaWVsZHMgPSBPYmplY3QuYXNzaWduKHt9LCBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS5tYXBGaWVsZHMpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gcmVzdWx0ICYmIHJlc3VsdC52YWx1ZSB8fCBudWxsO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmcgPSBlZGl0b3JJbnN0YW5jZS5jb2x1bW4gJiYgZWRpdG9ySW5zdGFuY2UuY29sdW1uLmZpZWxkO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGxvb2t1cFRleHRGaWVsZCA9IGVkaXRvckluc3RhbmNlLmluc3RhbmNlLnRleHRGaWVsZDtcclxuICAgICAgICAgICAgICBjb25zdCBkYXRhID0ge307XHJcbiAgICAgICAgICAgICAgaWYgKGJpbmRpbmcpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRleHRGaWVsZE1hcHBpbmcgPSBtYXBGaWVsZHNbbG9va3VwVGV4dEZpZWxkXTtcclxuICAgICAgICAgICAgICAgIGlmICh0ZXh0RmllbGRNYXBwaW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgIGNvbnN0IG90aGVyRmllbGQ6IHN0cmluZyA9IHRleHRGaWVsZE1hcHBpbmcuc3BsaXQoJywnKS5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0gIT09IGJpbmRpbmcpLmpvaW4oJywnKTtcclxuICAgICAgICAgICAgICAgICAgaWYgKG90aGVyRmllbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICBtYXBGaWVsZHNbbG9va3VwVGV4dEZpZWxkXSA9IG90aGVyRmllbGQ7XHJcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIG1hcEZpZWxkc1tsb29rdXBUZXh0RmllbGRdO1xyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnRQYXRocyA9IHRoaXMuZ2V0QmluZGluZ1BhdGhBcnJheSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5iaW5kaW5nRGF0YS5zZXRWYWx1ZShwYXJlbnRQYXRocy5jb25jYXQoYmluZGluZy5zcGxpdCgnLicpKSwgdmFsdWUsIHRydWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAvLyB0aGlzLnNldFZhbHVlKGRhdGEsIGxvb2t1cFRleHRGaWVsZC5zcGxpdCgnLicpLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgaWYgKG1hcEZpZWxkcyAmJiBPYmplY3Qua2V5cyhtYXBGaWVsZHMpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKG1hcEZpZWxkcykuZm9yRWFjaCgoZmllbGQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZShkYXRhLCBmaWVsZC5zcGxpdCgnLicpLCAnJyk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9va3VwTWFwcGluZyhkYXRhLCBtYXBGaWVsZHMsIHRydWUpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoY29sdW1uLmVkaXRvci50eXBlID09PSAnY29tYm8tbG9va3VwJykge1xyXG4gICAgICAgICAgZWRpdG9ySW5zdGFuY2UuaW5zdGFuY2UudmFsdWVDaGFuZ2Uuc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgYXNDbGVhciA9IGUgJiYgZS5zZWxlY3Rpb25zICYmIGUuc2VsZWN0aW9ucy5sZW5ndGggPT09IDA7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbWJvTG9va3VwOiBDb21ib0xvb2t1cENvbXBvbmVudCA9IGVkaXRvckluc3RhbmNlLmluc3RhbmNlO1xyXG4gICAgICAgICAgICBtYXBGaWVsZHMgPSBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS5tYXBGaWVsZHM7XHJcbiAgICAgICAgICAgIGNvbnN0IHNwbGl0ZXIgPSBjb21ib0xvb2t1cC5zZXBhcmF0b3IgfHwgdGhpcy5kZWZhdWx0U3BsaXRlcjtcclxuICAgICAgICAgICAgdGhpcy5sb29rdXBNYXBwaW5nKGUuc2VsZWN0aW9ucyB8fCBbXSwgbWFwRmllbGRzLCBhc0NsZWFyLCBzcGxpdGVyKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoWydjb21iby1sb29rdXAnLCAnY29tYm9saXN0JywgJ2xvb2t1cCcsICdQZXJzb25uZWxTZWxlY3RvcicsICdPcmdhbml6YXRpb25TZWxlY3RvcicsICdleHRlcm5hbC1pbnRlZ3JhdGlvbicsICdFbXBsb3llZVNlbGVjdG9yJywgJ0VtcGxveWVlT3JnU2VsZWN0b3InXS5pbmNsdWRlcyhjb2x1bW4uZWRpdG9yLnR5cGUpKSB7XHJcbiAgICAgICAgICBpZiAoZWRpdG9ySW5zdGFuY2UuaW5zdGFuY2UuY2xlYXIgJiYgZWRpdG9ySW5zdGFuY2UuaW5zdGFuY2UuY2xlYXIuc3Vic2NyaWJlKSB7XHJcbiAgICAgICAgICAgIGVkaXRvckluc3RhbmNlLmluc3RhbmNlLmNsZWFyLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgdGhpcy5sb29rdXBNYXBwaW5nKG51bGwsIG1hcEZpZWxkcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGNvbHVtbi5lZGl0b3IudHlwZSA9PT0gJ2NvbWJvbGlzdCcpIHtcclxuICAgICAgICAgIGlmIChtYXBGaWVsZHMpIHtcclxuICAgICAgICAgICAgZWRpdG9ySW5zdGFuY2UuaW5zdGFuY2UudmFsdWVDaGFuZ2Uuc3Vic2NyaWJlKChlKSA9PiB7XHJcbiAgICAgICAgICAgICAgY29uc3QgcGF0aEFyciA9IHRoaXMuZ2V0QmluZGluZ1BhdGhBcnJheSgpO1xyXG4gICAgICAgICAgICAgIHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhLnNldFZhbHVlKHBhdGhBcnIuY29uY2F0KG1hcEZpZWxkcy5zcGxpdCgnLicpKSwgZWRpdG9ySW5zdGFuY2UuaW5zdGFuY2Uuc2VsZWN0ZWRWYWx1ZXMsIHRydWUsIHRydWUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlpITnkIbnvJbovpHkuovku7ZcclxuICAgKi9cclxuICBwcml2YXRlIGhhbmRsZUFmdGVyRWRpdEV2ZW50KCkge1xyXG4gICAgdGhpcy5ncmlkLmFmdGVyRWRpdCA9IChyb3dJbmRleCwgcm93RGF0YSwgY29sdW1uLCBlZGl0b3IpID0+IHtcclxuICAgICAgaWYgKHRoaXMuZGlhbG9nU2VyLmhhc0RpYWxvZ09wZW5lZCgpKSB7XHJcbiAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAodGhpcy5ydHMpIHtcclxuICAgICAgICAvLyDluK7liqnnu4Tku7bmlofmnKzlj5jljJblkI7ljrvmn6Xor6JcclxuICAgICAgICBpZiAodGhpcy5ydHMuZ2V0Rm9ybVN0YXRlKCdsb29rdXAucGVuZGluZycpKSB7XHJcbiAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICAvLyDmm7TmlrDmlbDmja7mupBcclxuICAgICAgaWYgKCFlZGl0b3IgfHwgIWVkaXRvci5mb3JtQ29udHJvbCkge1xyXG4gICAgICAgIHJldHVybiBvZihmYWxzZSk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgfTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5aSE55CG57uT5p2f57yW6L6R5LqL5Lu2XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBoYW5kbGVFbmRFZGl0RXZlbnQoKSB7XHJcbiAgICB0aGlzLmVuZEVkaXRTdWJzY3JpcHRpb24gPSB0aGlzLmdyaWQgJiYgdGhpcy5ncmlkLmVuZEVkaXQgJiYgdGhpcy5ncmlkLmVuZEVkaXQuc3Vic2NyaWJlKChldmVudDogYW55KSA9PiB7XHJcbiAgICAgIGNvbnN0IHsgdmFsdWUgPSB1bmRlZmluZWQsIGNvbHVtbiA9IHVuZGVmaW5lZCwgcm93RGF0YSA9IHt9IH0gPSBldmVudCB8fCB7fTtcclxuICAgICAgY29uc3QgcHJpbWFyeVZhbHVlID0gcm93RGF0YSAmJiByb3dEYXRhW3RoaXMuZ3JpZC5pZEZpZWxkXSB8fCBudWxsO1xyXG4gICAgICB0aGlzLnVwZGF0ZUJpbmRpbmdEYXRhKHZhbHVlLCBjb2x1bW4sIHByaW1hcnlWYWx1ZSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLypcclxuICAgKiDnu5nliJfooajotYvlgLwg5oiW57uZZm9ybWNvbnRyb2zotYvlgLxcclxuICAgKi9cclxuICBwcml2YXRlIHVwZGF0ZUJpbmRpbmdEYXRhKHZhbHVlOiBhbnksIGNvbHVtbjogYW55LCBwcmltYXJ5VmFsdWU/OiBhbnkpIHtcclxuICAgIGlmICghY29sdW1uKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGN1cnJlbnRDb2x1bW5UeXBlID0gY29sdW1uLmRhdGFUeXBlO1xyXG4gICAgLy8g5ZCM5pe25Yik5patZ3JpZE9wdGlvbueahOWIl+WvueixoVxyXG5cclxuICAgIGNvbnN0IGZpZWxkUGF0aHMgPSBjb2x1bW4uZmllbGQuc3BsaXQoJy4nKTtcclxuICAgIC8vIOaYr+WQpuS4uuWkp+aVsFxyXG4gICAgY29uc3QgaXNCaWdOdW1iZXIgPSBjb2x1bW4gJiYgY29sdW1uLmVkaXRvciAmJiBjb2x1bW4uZWRpdG9yLm9wdGlvbnMgJiYgY29sdW1uLmVkaXRvci5vcHRpb25zLmJpZ051bWJlcjtcclxuICAgIC8vIOWtmOWcqOihjOe8lui+keWZqFxyXG4gICAgaWYgKGN1cnJlbnRDb2x1bW5UeXBlID09PSAnZGF0ZScpIHtcclxuICAgICAgbGV0IHJlc3VsdDtcclxuICAgICAgaWYgKHZhbHVlKSB7XHJcbiAgICAgICAgcmVzdWx0ID0gdGhpcy5kYXRlU2VydmljZS5mb3JtYXRUbyh2YWx1ZSwgJ3l5eXktTU0tZGQnKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXN1bHQgPSB2YWx1ZTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnVwZGF0ZUJpbmRpbmdMaXN0KHByaW1hcnlWYWx1ZSwgZmllbGRQYXRocy5qb2luKCcuJyksIHJlc3VsdCk7XHJcbiAgICB9IGVsc2UgaWYgKGN1cnJlbnRDb2x1bW5UeXBlID09PSAnZGF0ZXRpbWUnKSB7XHJcbiAgICAgIC8vIGlmICghdmFsdWUpIHtcclxuICAgICAgLy8gICB2YWx1ZSA9ICcwMDAxLTAxLTAxVDAwOjAwOjAwJztcclxuICAgICAgLy8gfVxyXG4gICAgICB0aGlzLnVwZGF0ZUJpbmRpbmdMaXN0KHByaW1hcnlWYWx1ZSwgZmllbGRQYXRocy5qb2luKCcuJyksIHZhbHVlKTtcclxuICAgIH0gZWxzZSBpZiAoY3VycmVudENvbHVtblR5cGUgPT09ICdudW1iZXInICYmICFpc0JpZ051bWJlcikge1xyXG4gICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlQmluZGluZ0xpc3QocHJpbWFyeVZhbHVlLCBmaWVsZFBhdGhzLmpvaW4oJy4nKSwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGVCaW5kaW5nTGlzdChwcmltYXJ5VmFsdWUsIGZpZWxkUGF0aHMuam9pbignLicpLCBOdW1iZXIodmFsdWUpKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy51cGRhdGVCaW5kaW5nTGlzdChwcmltYXJ5VmFsdWUsIGZpZWxkUGF0aHMuam9pbignLicpLCB2YWx1ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgdXBkYXRlQmluZGluZ0xpc3QocHJpbWFyeVZhbHVlOiBhbnksIHByb3BlcnR5TmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XHJcbiAgICBjb25zdCB2aWV3TW9kZWwgPSB0aGlzLnZpZXdNb2RlbCB8fCBudWxsO1xyXG4gICAgaWYgKCF2aWV3TW9kZWwgfHwgIXByb3BlcnR5TmFtZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDmm7TmlrDkuLvooajpg6jliIbooYznmoTlrZfmrrVcclxuICAgIGNvbnN0IHByb3BlcnR5TmFtZXMgPSBwcm9wZXJ0eU5hbWUuc3BsaXQoJy4nKS5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0pO1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGggPSB0aGlzLmdldEJpbmRpbmdQYXRoQXJyYXkoKTtcclxuICAgIC8vIOWPluWHuuadpeeahOS4gOWumuaYr2JpbmRpbmdMaXN0XHJcbiAgICBjb25zdCBsaXN0ID0gdGhpcy5iaW5kaW5nRGF0YS5nZXRWYWx1ZShiaW5kaW5nUGF0aCkgYXMgQmluZGluZ0xpc3Q7XHJcbiAgICAvLyDkv67mlLnnmoTmmK/lvZPliY3ooYxcclxuICAgIGlmIChsaXN0ICYmIHByaW1hcnlWYWx1ZSA9PT0gbGlzdC5jdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWUpIHtcclxuICAgICAgY29uc3QgcGF0aHMgPSBiaW5kaW5nUGF0aC5jb25jYXQocHJvcGVydHlOYW1lcyk7XHJcbiAgICAgIHRoaXMuYmluZGluZ0RhdGEuc2V0VmFsdWUocGF0aHMsIHZhbHVlLCB0cnVlLCB0cnVlKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgYmluZGluZ09iamVjdCA9IHRoaXMuYmluZGluZ0xpc3QuZmluZEJ5SWQocHJpbWFyeVZhbHVlKTtcclxuICAgIGlmICghYmluZGluZ09iamVjdCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAocHJvcGVydHlOYW1lcy5sZW5ndGggPCAyKSB7XHJcbiAgICAgIGJpbmRpbmdPYmplY3Quc2V0VmFsdWUocHJvcGVydHlOYW1lLCB2YWx1ZSwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBsZXQgdGFyZ2V0QmluZGluZ09iamVjdCA9IG51bGw7XHJcbiAgICAgIGNvbnN0IGZwYXRocyA9IHByb3BlcnR5TmFtZXMuc2xpY2UoMCwgcHJvcGVydHlOYW1lcy5sZW5ndGggLSAxKTtcclxuICAgICAgY29uc3QgdGFyZ2V0UHJvcGVydHlOYW1lID0gcHJvcGVydHlOYW1lc1twcm9wZXJ0eU5hbWVzLmxlbmd0aCAtIDFdO1xyXG4gICAgICBmcGF0aHMuZm9yRWFjaCgocHJvcCkgPT4ge1xyXG4gICAgICAgIHRhcmdldEJpbmRpbmdPYmplY3QgPSB0YXJnZXRCaW5kaW5nT2JqZWN0ICYmIHRhcmdldEJpbmRpbmdPYmplY3RbcHJvcF0gfHwgYmluZGluZ09iamVjdFtwcm9wXTtcclxuICAgICAgfSk7XHJcbiAgICAgIC8vIHRvZG866ZyA6KaB5re75Yqg5YC85Y+Y5YyW5LqL5Lu2XHJcbiAgICAgIHRhcmdldEJpbmRpbmdPYmplY3Quc2V0VmFsdWUodGFyZ2V0UHJvcGVydHlOYW1lLCB2YWx1ZSwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgZGV0YWNoKCkge1xyXG4gICAgaWYgKHRoaXMuYmVnaW5FZGl0U3Vic2NyaXB0aW9uICYmIHR5cGVvZiB0aGlzLmJlZ2luRWRpdFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICB0aGlzLmJlZ2luRWRpdFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuZW5kRWRpdFN1YnNjcmlwdGlvbiAmJiB0eXBlb2YgdGhpcy5lbmRFZGl0U3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIHRoaXMuZW5kRWRpdFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8jcmVnaW9uIOW4ruWKqeWtl+auteaYoOWwhFxyXG5cclxuICBwcml2YXRlIGxvb2t1cE1hcHBpbmcoaGVscERhdGE6IGFueSwgbWFwRmllbGRzOiBhbnksIGFzQ2xlYXI6IGJvb2xlYW4gPSBmYWxzZSwgc3BsaXRlcjogc3RyaW5nID0gJywnKSB7XHJcbiAgICBpZiAoIW1hcEZpZWxkcykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDlhbPpl63lj5jmm7Tmo4DmtYtcclxuICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuYXBwQ29udGV4dDtcclxuICAgIGFwcENvbnRleHQuY2hhbmdlRGV0ZWN0aW9uQ29udHJvbGxlci5kZXRhY2goKTtcclxuXHJcbiAgICBjb25zdCBwYXRoQXJyID0gdGhpcy5nZXRCaW5kaW5nUGF0aEFycmF5KCk7XHJcbiAgICBsZXQgaGVscEZpZWxkcyA9IE9iamVjdC5rZXlzKG1hcEZpZWxkcyk7XHJcbiAgICBjb25zdCBwcmltYXJ5SW5mbyA9IHRoaXMuZ2V0TWFwRmllbGRzUHJpbWFyeUtleShtYXBGaWVsZHMsIHBhdGhBcnIpO1xyXG5cclxuICAgIGxldCBwcmltYXJ5S2V5cyA9IHByaW1hcnlJbmZvICYmIHByaW1hcnlJbmZvLm1hcCgoaXRlbSkgPT4gaXRlbS5wcmltYXJ5S2V5KSB8fCBbXTtcclxuICAgIGNvbnN0IHByaW1hcnlGaWVsZHMgPSBwcmltYXJ5SW5mbyAmJiBwcmltYXJ5SW5mby5tYXAoKGl0ZW0pID0+IGl0ZW0ucHJpbWFyeUZpZWxkKSB8fCBbXTtcclxuICAgIC8vIOWOu+mHjVxyXG4gICAgaWYgKHByaW1hcnlLZXlzICYmIHByaW1hcnlLZXlzLmxlbmd0aCA+IDApIHtcclxuICAgICAgcHJpbWFyeUtleXMgPSBbLi4ubmV3IFNldChwcmltYXJ5S2V5cyldO1xyXG4gICAgICBoZWxwRmllbGRzID0gdGhpcy5zb3J0TWFwRmllbGRLZXlzKGhlbHBGaWVsZHMsIHByaW1hcnlLZXlzKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIWhlbHBEYXRhIHx8IGFzQ2xlYXIpIHtcclxuICAgICAgaGVscEZpZWxkcy5yZXZlcnNlKCk7XHJcbiAgICB9XHJcbiAgICBoZWxwRmllbGRzLmZvckVhY2goKGY6IGFueSkgPT4ge1xyXG4gICAgICBsZXQgdmFsOiBhbnkgPSAnJztcclxuICAgICAgaWYgKGhlbHBEYXRhKSB7XHJcbiAgICAgICAgaWYgKGhlbHBEYXRhIGluc3RhbmNlb2YgQXJyYXkpIHtcclxuICAgICAgICAgIHZhbCA9IGhlbHBEYXRhLm1hcCgoaDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFZhbHVlKGYsIGgpO1xyXG4gICAgICAgICAgfSkuam9pbihzcGxpdGVyKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdmFsID0gdGhpcy5nZXRWYWx1ZShmLCBoZWxwRGF0YSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICBsZXQgbWFwcGluZ3M6IGFueVtdID0gbWFwRmllbGRzW2ZdLnNwbGl0KCcsJyk7XHJcbiAgICAgIGNvbnN0IGhlYWRNYXBwaW5ncyA9IG1hcHBpbmdzLmZpbHRlcigocCkgPT4gcHJpbWFyeUZpZWxkcy5pbmNsdWRlcyhwKSk7XHJcbiAgICAgIGNvbnN0IGxlZnRNYXBwaW5ncyA9IG1hcHBpbmdzLmZpbHRlcigocCkgPT4gIXByaW1hcnlGaWVsZHMuaW5jbHVkZXMocCkpO1xyXG4gICAgICBpZiAoIWhlbHBEYXRhKSB7XHJcbiAgICAgICAgbWFwcGluZ3MgPSBbXS5jb25jYXQobGVmdE1hcHBpbmdzKS5jb25jYXQoaGVhZE1hcHBpbmdzKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBtYXBwaW5ncyA9IFtdLmNvbmNhdChoZWFkTWFwcGluZ3MpLmNvbmNhdChsZWZ0TWFwcGluZ3MpO1xyXG4gICAgICB9XHJcbiAgICAgIG1hcHBpbmdzLmZvckVhY2goKGZmOiBhbnkpID0+IHtcclxuICAgICAgICBpZiAoIWhlbHBEYXRhKSB7XHJcbiAgICAgICAgICB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nRGF0YS5jbGVhclZhbHVlKHBhdGhBcnIuY29uY2F0KGZmLnNwbGl0KCcuJykpLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGEuc2V0VmFsdWUocGF0aEFyci5jb25jYXQoZmYuc3BsaXQoJy4nKSksIHZhbCwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOmHjeaWsOaJk+W8gOWPmOabtOajgOa1i1xyXG4gICAgYXBwQ29udGV4dC5jaGFuZ2VEZXRlY3Rpb25Db250cm9sbGVyLnJlYXR0YWNoKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldFZhbHVlKGY6IHN0cmluZywgZGF0YTogYW55KSB7XHJcbiAgICBsZXQgdmFsID0gJyc7XHJcbiAgICBpZiAoZi5pbmRleE9mKCcuJykgPT09IC0xKSB7XHJcbiAgICAgIHZhbCA9IGRhdGFbZl07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB2YWwgPSBmLnNwbGl0KCcuJykucmVkdWNlKChhLCBiKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGFbYl07XHJcbiAgICAgIH0sIGRhdGEpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB2YWw7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEJpbmRpbmdQYXRoQXJyYXkoKTogYW55W10ge1xyXG4gICAgY29uc3QgcGF0aCA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoO1xyXG4gICAgaWYgKHBhdGgpIHtcclxuICAgICAgcmV0dXJuIHBhdGguc3BsaXQoJy8nKS5maWx0ZXIoKG4pID0+IG4gIT09ICcnKTtcclxuICAgIH1cclxuICAgIHJldHVybiBbXTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaXNOdW1iZXJWYWx1ZShmaWVsZCwgZGF0YSkge1xyXG4gICAgY29uc3QgY3VycmVudFZhbCA9IHRoaXMuZ2V0VmFsdWUoZmllbGQsIGRhdGEpO1xyXG4gICAgcmV0dXJuIGlzTnVtYmVyKGN1cnJlbnRWYWwpO1xyXG4gIH1cclxuXHJcbiAgLy8jZW5kcmVnaW9uXHJcbiAgLyoqXHJcbiAgICpcclxuICAgKiBAcGFyYW0gbWFwRmllbGRzICDmoLzlvI/lvaLlpoLvvJp7aWQ6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZFwiLCBjb2RlOiBcImFzc29GaWVsZC5hc3NvRmllbGRfQ29kZVwiLCBuYW1lOiBcImFzc29GaWVsZC5hc3NvRmllbGRfTmFtZVwifSDmiJbogIUge2lkOid2aWQnLGNvZGU6J2NvZGUnLG5hbWU6J25hbWUnfVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0TWFwRmllbGRzUHJpbWFyeUtleShtYXBGaWVsZHM6IGFueSwgYmluZGluZ1BhdGhzOiBzdHJpbmdbXSk6IEFycmF5PHsgcHJpbWFyeUtleTogc3RyaW5nLCBwcmltYXJ5RmllbGQ6IHN0cmluZyB9PiB7XHJcbiAgICBpZiAoIW1hcEZpZWxkcyB8fCBPYmplY3Qua2V5cyhtYXBGaWVsZHMpLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXN1bHRzID0gW107XHJcbiAgICAvLyBsZXQgcHJpbWFyeUZpZWxkID0gbnVsbDtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8gPSB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbztcclxuICAgICAgT2JqZWN0LmtleXMobWFwRmllbGRzKS5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGNvbnN0IG1hcEZpZWxkID0gbWFwRmllbGRzW2tleV07XHJcbiAgICAgICAgaWYgKG1hcEZpZWxkICYmIHR5cGVvZiBtYXBGaWVsZCA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgIGNvbnN0IG1hcHBpbmdzID0gbWFwRmllbGQuc3BsaXQoJywnKS5maWx0ZXIoKHApID0+IHApO1xyXG4gICAgICAgICAgbWFwcGluZ3MuZm9yRWFjaCgoaXRlbTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBwYXRocyA9IGl0ZW0uc3BsaXQoJy4nKTtcclxuICAgICAgICAgICAgaWYgKGJpbmRpbmdQYXRocyAmJiBiaW5kaW5nUGF0aHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgIHBhdGhzID0gYmluZGluZ1BhdGhzLmNvbmNhdChwYXRocyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgcHJvcEluZm86IERhdGFQcm9wSW5mbyA9IGVudGl0eVR5cGVJbmZvLmdldFByb3BJbmZvQnlQYXRoKHBhdGhzKTtcclxuICAgICAgICAgICAgaWYgKHByb3BJbmZvICYmIHByb3BJbmZvLm1ldGFkYXRhSW5mbyAmJiBwcm9wSW5mby5tZXRhZGF0YUluZm8ucHJpbWFyeSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgIHJlc3VsdHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICBwcmltYXJ5S2V5OiBrZXksXHJcbiAgICAgICAgICAgICAgICBwcmltYXJ5RmllbGQ6IGl0ZW1cclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgY29uc29sZS5lcnJvcihlKTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHRzO1xyXG4gIH1cclxuICBwcml2YXRlIHNldFZhbHVlKHRhcmdldDogb2JqZWN0LCBwYXRoczogc3RyaW5nW10sIHZhbHVlOiBhbnkpIHtcclxuICAgIGlmICh0YXJnZXQpIHtcclxuICAgICAgaWYgKHBhdGhzLmxlbmd0aCA8PSAxKSB7XHJcbiAgICAgICAgdGFyZ2V0W3BhdGhzWzBdXSA9IHZhbHVlO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHBhdGhzLnNsaWNlKDAsIC0xKS5yZWR1Y2UoKHByZXYsIHBhdGgpID0+IHtcclxuICAgICAgICAgIGlmICghKHByZXYuaGFzT3duUHJvcGVydHkocGF0aCkgfHwgcHJldlsnX19wcm90b19fJ10uaGFzT3duUHJvcGVydHkocGF0aCkpKSB7XHJcbiAgICAgICAgICAgIHByZXZbcGF0aF0gPSB7fTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiBwcmV2W3BhdGhdO1xyXG4gICAgICAgIH0sIHRhcmdldClbcGF0aHNbcGF0aHMubGVuZ3RoIC0gMV1dID0gdmFsdWU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBzb3J0TWFwRmllbGRLZXlzKGtleXM6IHN0cmluZ1tdLCBwcmltYXJ5S2V5czogc3RyaW5nW10pOiBzdHJpbmdbXSB7XHJcbiAgICBpZiAoIXByaW1hcnlLZXlzIHx8IHByaW1hcnlLZXlzLmxlbmd0aCA8IDEgfHwgIWtleXMgfHwga2V5cy5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybiBrZXlzO1xyXG4gICAgfVxyXG4gICAgLy8g6L+H5ruk5Ye66Z2e5Li76ZSu5pig5bCE5a2X5q61XHJcbiAgICBrZXlzID0ga2V5cy5maWx0ZXIoKHApID0+ICFwcmltYXJ5S2V5cy5pbmNsdWRlcyhwKSk7XHJcbiAgICByZXR1cm4gW10uY29uY2F0KHByaW1hcnlLZXlzKS5jb25jYXQoa2V5cyk7XHJcbiAgfVxyXG59XHJcbiJdfQ==