import { Directive, Inject, Injector, Input } from "@angular/core";
import { UserSettingsToken } from "@farris/devkit";
import { BigNumber } from 'bignumber.js';
import moment from 'moment';
import { TextComponent } from '@farris/ui-text';
export class FarrisTextLocalizationDirective {
    constructor(injector, userSettings, componentRef) {
        this.injector = injector;
        this.userSettings = userSettings;
        this.componentRef = componentRef;
        this.transform();
    }
    ngOnInit() {
    }
    transform() {
        if (this.componentRef) {
            this.componentRef.beforeWriteValue = (value, options) => {
                let { localizationType = null, showTime = false } = options;
                if (!value) {
                    return '';
                }
                if (localizationType && value) {
                    localizationType = localizationType.toLowerCase();
                    value = this.transformValue(value, localizationType);
                    return value;
                }
                else {
                    return undefined;
                }
            };
        }
    }
    transformValue(value, dataType) {
        if (dataType === 'date') {
            return this.transformDate(value);
        }
        else if (dataType === 'datetime') {
            return this.transformDateTime(value);
        }
        // 涉及金额计算及显示问题，不予处理
        //  else if (dataType === 'number') {
        //   return this.transformNumber(value);
        // } 
        else {
            return value;
        }
    }
    /**
     * 转换日期
     * @param value value
     */
    transformDate(value) {
        let dateFormat = this.userSettings && this.userSettings.dateFormat || 'YYYY-MM-DD';
        if (!dateFormat || !value) {
            return value;
        }
        const date = moment(value);
        const isValid = date.isValid();
        if (!isValid) {
            return value;
        }
        dateFormat = this.parseDateFormat(dateFormat);
        return date.format(dateFormat);
    }
    /**
     * 转换日期时间
     * @param value value
     * todo: 目前无法定义日期时间格式
     */
    transformDateTime(value) {
        let dateFormat = this.userSettings && this.userSettings.dateFormat || 'YYYY-MM-DD';
        let timeFormat = this.userSettings && this.userSettings.timeFormat || 'HH:mm:ss';
        if (!dateFormat || !timeFormat) {
            return value;
        }
        const dateTime = moment(value);
        const isValid = dateTime.isValid();
        if (!isValid) {
            return value;
        }
        if (dateFormat) {
            dateFormat = this.parseDateFormat(dateFormat);
        }
        if (timeFormat) {
            timeFormat = this.parseTimeFormat(timeFormat);
        }
        const dateTimeFormat = dateFormat + ' ' + timeFormat;
        return dateTime.format(dateTimeFormat);
    }
    /**
     * 转换数字
     * @param value value
     */
    transformNumber(value) {
        if (value === null || value === undefined || value === '') {
            return '';
        }
        const bigNumber = new BigNumber(value);
        // 如果不是数字，不做任何处理
        if (!BigNumber.isBigNumber(bigNumber)) {
            return value;
        }
        const isNegative = bigNumber.isNegative();
        const format = this.buildNumberFormat();
        const { negativeSign = null, numberDecimalDigits = null } = this.numberFormat || {};
        if (isNegative) {
            if (negativeSign !== null) {
                format.prefix = negativeSign;
                return bigNumber.absoluteValue().toFormat(numberDecimalDigits, null, format);
            }
        }
        return bigNumber.toFormat(numberDecimalDigits, null, format);
    }
    /**
     * 转换日期格式规则为moment的format规则
     * @param format format
     */
    parseDateFormat(format) {
        return format.replace(/y/g, 'Y').replace(/d/g, 'D');
    }
    /**
     * 转换时间格式规则为moment的format规则
     * @param format format
     */
    parseTimeFormat(format) {
        return format.replace(/M/g, 'm');
    }
    /**
     * 构造bignumber数字格式化选项
     */
    buildNumberFormat() {
        if (this.numberFormat) {
            const { numberDecimalSeparator = null, numberGroupSeparator = null } = this.numberFormat;
            const format = {
                groupSize: 3,
            };
            if (numberDecimalSeparator !== null) {
                format.decimalSeparator = numberDecimalSeparator;
            }
            if (numberGroupSeparator !== null) {
                format.groupSeparator = numberGroupSeparator;
            }
            return format;
        }
    }
    get numberFormat() {
        return this.userSettings && this.userSettings.numberFormat || null;
    }
}
FarrisTextLocalizationDirective.decorators = [
    { type: Directive, args: [{
                selector: '[farris-text-localization]'
            },] }
];
/** @nocollapse */
FarrisTextLocalizationDirective.ctorParameters = () => [
    { type: Injector },
    { type: undefined, decorators: [{ type: Inject, args: [UserSettingsToken,] }] },
    { type: TextComponent }
];
FarrisTextLocalizationDirective.propDecorators = {
    localization: [{ type: Input, args: ['localization',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzX3RleHRfbG9jYWxpemF0aW9uLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMva2VuZG8tYmluZGluZy8iLCJzb3VyY2VzIjpbImxpYi9kaXJlY3RpdmVzL2xvY2FsaXphdGlvbi9mYXJyaXNfdGV4dF9sb2NhbGl6YXRpb24uZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDM0UsT0FBTyxFQUE4QixpQkFBaUIsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQy9FLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDekMsT0FBTyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBQzVCLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUtoRCxNQUFNLE9BQU8sK0JBQStCO0lBRTFDLFlBQW9CLFFBQWtCLEVBQXFDLFlBQTBCLEVBQVUsWUFBMkI7UUFBdEgsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFxQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUFlO1FBQ3hJLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUNuQixDQUFDO0lBQ00sUUFBUTtJQUNmLENBQUM7SUFDTyxTQUFTO1FBQ2YsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3JCLElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLEdBQUcsQ0FBQyxLQUFVLEVBQUUsT0FBWSxFQUFFLEVBQUU7Z0JBQ2hFLElBQUksRUFBRSxnQkFBZ0IsR0FBRyxJQUFJLEVBQUUsUUFBUSxHQUFHLEtBQUssRUFBRSxHQUFHLE9BQU8sQ0FBQztnQkFDNUQsSUFBSSxDQUFDLEtBQUssRUFBRTtvQkFDVixPQUFPLEVBQUUsQ0FBQztpQkFDWDtnQkFDRCxJQUFJLGdCQUFnQixJQUFJ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QVE7Z0JBQ2xCLFNBQVMsRUFBRSxDQUFDO2FBQ2IsQ0FBQztZQUNGLElBQUksc0JBQXNCLEtBQUssSUFBSSxFQUFFO2dCQUNuQyxNQUFNLENBQUMsZ0JBQWdCLEdBQUcsc0JBQXNCLENBQUM7YUFDbEQ7WUFDRCxJQUFJLG9CQUFvQixLQUFLLElBQUksRUFBRTtnQkFDakMsTUFBTSxDQUFDLGNBQWMsR0FBRyxvQkFBb0IsQ0FBQzthQUM5QztZQUNELE9BQU8sTUFBTSxDQUFDO1NBQ2Y7SUFDSCxDQUFDO0lBQ0QsSUFBWSxZQUFZO1FBQ3RCLE9BQU8sSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUM7SUFDckUsQ0FBQzs7O1lBN0lGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsNEJBQTRCO2FBQ3ZDOzs7O1lBUjJCLFFBQVE7NENBV08sTUFBTSxTQUFDLGlCQUFpQjtZQVAxRCxhQUFhOzs7MkJBTW5CLEtBQUssU0FBQyxjQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBJbmplY3QsIEluamVjdG9yLCBJbnB1dCwgT25Jbml0IH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgTnVtYmVyRm9ybWF0LCBVc2VyU2V0dGluZ3MsIFVzZXJTZXR0aW5nc1Rva2VuIH0gZnJvbSBcIkBmYXJyaXMvZGV2a2l0XCI7XHJcbmltcG9ydCB7IEJpZ051bWJlciB9IGZyb20gJ2JpZ251bWJlci5qcyc7XHJcbmltcG9ydCBtb21lbnQgZnJvbSAnbW9tZW50JztcclxuaW1wb3J0IHsgVGV4dENvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktdGV4dCc7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1tmYXJyaXMtdGV4dC1sb2NhbGl6YXRpb25dJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgRmFycmlzVGV4dExvY2FsaXphdGlvbkRpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcbiAgQElucHV0KCdsb2NhbGl6YXRpb24nKSBsb2NhbGl6YXRpb246IGJvb2xlYW47XHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIEBJbmplY3QoVXNlclNldHRpbmdzVG9rZW4pIHByaXZhdGUgdXNlclNldHRpbmdzOiBVc2VyU2V0dGluZ3MsIHByaXZhdGUgY29tcG9uZW50UmVmOiBUZXh0Q29tcG9uZW50KSB7XHJcbiAgICB0aGlzLnRyYW5zZm9ybSgpO1xyXG4gIH1cclxuICBwdWJsaWMgbmdPbkluaXQoKSB7XHJcbiAgfVxyXG4gIHByaXZhdGUgdHJhbnNmb3JtKCkge1xyXG4gICAgaWYgKHRoaXMuY29tcG9uZW50UmVmKSB7XHJcbiAgICAgIHRoaXMuY29tcG9uZW50UmVmLmJlZm9yZVdyaXRlVmFsdWUgPSAodmFsdWU6IGFueSwgb3B0aW9uczogYW55KSA9PiB7XHJcbiAgICAgICAgbGV0IHsgbG9jYWxpemF0aW9uVHlwZSA9IG51bGwsIHNob3dUaW1lID0gZmFsc2UgfSA9IG9wdGlvbnM7XHJcbiAgICAgICAgaWYgKCF2YWx1ZSkge1xyXG4gICAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobG9jYWxpemF0aW9uVHlwZSAmJiB2YWx1ZSkge1xyXG4gICAgICAgICAgbG9jYWxpemF0aW9uVHlwZSA9IGxvY2FsaXphdGlvblR5cGUudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgIHZhbHVlID0gdGhpcy50cmFuc2Zvcm1WYWx1ZSh2YWx1ZSwgbG9jYWxpemF0aW9uVHlwZSk7XHJcbiAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIHRyYW5zZm9ybVZhbHVlKHZhbHVlOiBhbnksIGRhdGFUeXBlOiBzdHJpbmcpIHtcclxuICAgIGlmIChkYXRhVHlwZSA9PT0gJ2RhdGUnKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnRyYW5zZm9ybURhdGUodmFsdWUpO1xyXG4gICAgfSBlbHNlIGlmIChkYXRhVHlwZSA9PT0gJ2RhdGV0aW1lJykge1xyXG4gICAgICByZXR1cm4gdGhpcy50cmFuc2Zvcm1EYXRlVGltZSh2YWx1ZSk7XHJcbiAgICB9XHJcbiAgICAvLyDmtonlj4rph5Hpop3orqHnrpflj4rmmL7npLrpl67popjvvIzkuI3kuojlpITnkIZcclxuICAgIC8vICBlbHNlIGlmIChkYXRhVHlwZSA9PT0gJ251bWJlcicpIHtcclxuICAgIC8vICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtTnVtYmVyKHZhbHVlKTtcclxuICAgIC8vIH0gXHJcbiAgICBlbHNlIHtcclxuICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDovazmjaLml6XmnJ9cclxuICAgKiBAcGFyYW0gdmFsdWUgdmFsdWVcclxuICAgKi9cclxuICBwcml2YXRlIHRyYW5zZm9ybURhdGUodmFsdWU6IGFueSkge1xyXG4gICAgbGV0IGRhdGVGb3JtYXQgPSB0aGlzLnVzZXJTZXR0aW5ncyAmJiB0aGlzLnVzZXJTZXR0aW5ncy5kYXRlRm9ybWF0IHx8ICdZWVlZLU1NLUREJztcclxuICAgIGlmICghZGF0ZUZvcm1hdCB8fCAhdmFsdWUpIHtcclxuICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZGF0ZSA9IG1vbWVudCh2YWx1ZSk7XHJcbiAgICBjb25zdCBpc1ZhbGlkID0gZGF0ZS5pc1ZhbGlkKCk7XHJcbiAgICBpZiAoIWlzVmFsaWQpIHtcclxuICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG4gICAgZGF0ZUZvcm1hdCA9IHRoaXMucGFyc2VEYXRlRm9ybWF0KGRhdGVGb3JtYXQpO1xyXG4gICAgcmV0dXJuIGRhdGUuZm9ybWF0KGRhdGVGb3JtYXQpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDovazmjaLml6XmnJ/ml7bpl7RcclxuICAgKiBAcGFyYW0gdmFsdWUgdmFsdWVcclxuICAgKiB0b2RvOiDnm67liY3ml6Dms5XlrprkuYnml6XmnJ/ml7bpl7TmoLzlvI9cclxuICAgKi9cclxuICBwcml2YXRlIHRyYW5zZm9ybURhdGVUaW1lKHZhbHVlOiBhbnkpIHtcclxuICAgIGxldCBkYXRlRm9ybWF0ID0gdGhpcy51c2VyU2V0dGluZ3MgJiYgdGhpcy51c2VyU2V0dGluZ3MuZGF0ZUZvcm1hdCB8fCAnWVlZWS1NTS1ERCc7XHJcbiAgICBsZXQgdGltZUZvcm1hdCA9IHRoaXMudXNlclNldHRpbmdzICYmIHRoaXMudXNlclNldHRpbmdzLnRpbWVGb3JtYXQgfHwgJ0hIOm1tOnNzJztcclxuICAgIGlmICghZGF0ZUZvcm1hdCB8fCAhdGltZUZvcm1hdCkge1xyXG4gICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcbiAgICBjb25zdCBkYXRlVGltZSA9IG1vbWVudCh2YWx1ZSk7XHJcbiAgICBjb25zdCBpc1ZhbGlkID0gZGF0ZVRpbWUuaXNWYWxpZCgpO1xyXG4gICAgaWYgKCFpc1ZhbGlkKSB7XHJcbiAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuICAgIGlmIChkYXRlRm9ybWF0KSB7XHJcbiAgICAgIGRhdGVGb3JtYXQgPSB0aGlzLnBhcnNlRGF0ZUZvcm1hdChkYXRlRm9ybWF0KTtcclxuICAgIH1cclxuICAgIGlmICh0aW1lRm9ybWF0KSB7XHJcbiAgICAgIHRpbWVGb3JtYXQgPSB0aGlzLnBhcnNlVGltZUZvcm1hdCh0aW1lRm9ybWF0KTtcclxuICAgIH1cclxuICAgIGNvbnN0IGRhdGVUaW1lRm9ybWF0ID0gZGF0ZUZvcm1hdCArICcgJyArIHRpbWVGb3JtYXQ7XHJcbiAgICByZXR1cm4gZGF0ZVRpbWUuZm9ybWF0KGRhdGVUaW1lRm9ybWF0KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6L2s5o2i5pWw5a2XXHJcbiAgICogQHBhcmFtIHZhbHVlIHZhbHVlXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB0cmFuc2Zvcm1OdW1iZXIodmFsdWUpOiBzdHJpbmcge1xyXG4gICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09ICcnKSB7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIGNvbnN0IGJpZ051bWJlciA9IG5ldyBCaWdOdW1iZXIodmFsdWUpO1xyXG4gICAgLy8g5aaC5p6c5LiN5piv5pWw5a2X77yM5LiN5YGa5Lu75L2V5aSE55CGXHJcbiAgICBpZiAoIUJpZ051bWJlci5pc0JpZ051bWJlcihiaWdOdW1iZXIpKSB7XHJcbiAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuICAgIGNvbnN0IGlzTmVnYXRpdmUgPSBiaWdOdW1iZXIuaXNOZWdhdGl2ZSgpO1xyXG4gICAgY29uc3QgZm9ybWF0ID0gdGhpcy5idWlsZE51bWJlckZvcm1hdCgpO1xyXG4gICAgY29uc3QgeyBuZWdhdGl2ZVNpZ24gPSBudWxsLCBudW1iZXJEZWNpbWFsRGlnaXRzID0gbnVsbCB9ID0gdGhpcy5udW1iZXJGb3JtYXQgfHwge307XHJcbiAgICBpZiAoaXNOZWdhdGl2ZSkge1xyXG4gICAgICBpZiAobmVnYXRpdmVTaWduICE9PSBudWxsKSB7XHJcbiAgICAgICAgZm9ybWF0LnByZWZpeCA9IG5lZ2F0aXZlU2lnbjtcclxuICAgICAgICByZXR1cm4gYmlnTnVtYmVyLmFic29sdXRlVmFsdWUoKS50b0Zvcm1hdChudW1iZXJEZWNpbWFsRGlnaXRzLCBudWxsLCBmb3JtYXQpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYmlnTnVtYmVyLnRvRm9ybWF0KG51bWJlckRlY2ltYWxEaWdpdHMsIG51bGwsIGZvcm1hdCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOi9rOaNouaXpeacn+agvOW8j+inhOWImeS4um1vbWVudOeahGZvcm1hdOinhOWImVxyXG4gICAqIEBwYXJhbSBmb3JtYXQgZm9ybWF0XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBwYXJzZURhdGVGb3JtYXQoZm9ybWF0OiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBmb3JtYXQucmVwbGFjZSgveS9nLCAnWScpLnJlcGxhY2UoL2QvZywgJ0QnKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6L2s5o2i5pe26Ze05qC85byP6KeE5YiZ5Li6bW9tZW5055qEZm9ybWF06KeE5YiZXHJcbiAgICogQHBhcmFtIGZvcm1hdCBmb3JtYXRcclxuICAgKi9cclxuICBwcml2YXRlIHBhcnNlVGltZUZvcm1hdChmb3JtYXQ6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIGZvcm1hdC5yZXBsYWNlKC9NL2csICdtJyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaehOmAoGJpZ251bWJlcuaVsOWtl+agvOW8j+WMlumAiemhuVxyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGROdW1iZXJGb3JtYXQoKSB7XHJcbiAgICBpZiAodGhpcy5udW1iZXJGb3JtYXQpIHtcclxuICAgICAgY29uc3QgeyBudW1iZXJEZWNpbWFsU2VwYXJhdG9yID0gbnVsbCwgbnVtYmVyR3JvdXBTZXBhcmF0b3IgPSBudWxsIH0gPSB0aGlzLm51bWJlckZvcm1hdDtcclxuICAgICAgY29uc3QgZm9ybWF0OiBhbnkgPSB7XHJcbiAgICAgICAgZ3JvdXBTaXplOiAzLFxyXG4gICAgICB9O1xyXG4gICAgICBpZiAobnVtYmVyRGVjaW1hbFNlcGFyYXRvciAhPT0gbnVsbCkge1xyXG4gICAgICAgIGZvcm1hdC5kZWNpbWFsU2VwYXJhdG9yID0gbnVtYmVyRGVjaW1hbFNlcGFyYXRvcjtcclxuICAgICAgfVxyXG4gICAgICBpZiAobnVtYmVyR3JvdXBTZXBhcmF0b3IgIT09IG51bGwpIHtcclxuICAgICAgICBmb3JtYXQuZ3JvdXBTZXBhcmF0b3IgPSBudW1iZXJHcm91cFNlcGFyYXRvcjtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gZm9ybWF0O1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIGdldCBudW1iZXJGb3JtYXQoKTogTnVtYmVyRm9ybWF0IHtcclxuICAgIHJldHVybiB0aGlzLnVzZXJTZXR0aW5ncyAmJiB0aGlzLnVzZXJTZXR0aW5ncy5udW1iZXJGb3JtYXQgfHwgbnVsbDtcclxuICB9XHJcbn0iXX0=