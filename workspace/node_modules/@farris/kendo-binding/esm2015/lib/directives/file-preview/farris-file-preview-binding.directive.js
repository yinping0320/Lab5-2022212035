import { Directive, Input, Injector, Optional, HostListener } from '@angular/core';
import { BindingData, BindingList, FrameContext, ChangeType } from '@farris/devkit';
import { FFilePreviewComponent, UploadAndPreviewComponent } from '@farris/extend-file-upload';
/**
 * 树表格绑定指令
 */
class FarrisFilePreviewBindingDirective {
    /**
     * 构造函数
     * @param previewComponent - 附件组件
     * @param frameContext - 控制器上下文
     * @param uploadAndPreviewComponent - 附件上传预览组件
     * @param injector - injector
     * @TODO: 该指令被用于不同的组件中，因此uploadAndPreviewComponent可能为null
     */
    constructor(previewComponent, frameContext, uploadAndPreviewComponent, injector) {
        this.previewComponent = previewComponent;
        this.frameContext = frameContext;
        this.uploadAndPreviewComponent = uploadAndPreviewComponent;
        this.injector = injector;
        /**
         * 未启用排序时默认按上传时间字段排序
         */
        this.DEFAULT_SORT_FIELD = 'createTime';
        /**
         * 启用排序时使用fileSortOrder做排序字段，与零代码的拖拽排序统一
         */
        this.SORT_FIELD_ON_SORTING = 'fileSortOrder';
    }
    /**
     * 绑定数据
     */
    get bindingData() {
        return this.frameContext.bindingData;
    }
    /**
     * 绑定数据列表
     */
    get bindingList() {
        return this.bindingData.getList();
    }
    /**
     * 排序字段
     * @description
     * 组件排序字段只有一个，不支持多个。
     * 如果启用了拖拽排序，则为fileSortOrder，否则使用默认的createTime
     */
    get orderField() {
        return this.uploadAndPreviewComponent && this.uploadAndPreviewComponent.enableOrder && this.uploadAndPreviewComponent.orderField || this.fileSortOrderKey && this.SORT_FIELD_ON_SORTING || this.DEFAULT_SORT_FIELD;
    }
    /**
     * 默认降序
     */
    get orderType() {
        return this.farrisOrderType ? this.farrisOrderType : this.orderField === this.DEFAULT_SORT_FIELD ? 'desc' : 'asc';
    }
    /**
     * 指令初始化
     */
    ngOnInit() {
        this.bindData();
        if (this.uploadAndPreviewComponent) {
            if (this.uploadAndPreviewComponent.enableOrder) {
                this.uploadAndPreviewComponent.orderField = this.SORT_FIELD_ON_SORTING;
            }
            // 禁用组件内置排序，控制器负责排序并将排序后的数据绑定到附件上传预览组件
            this.uploadAndPreviewComponent.enableSorting = false;
            this.uploadAndPreviewComponent.fSelectedEvent.subscribe((event) => {
                const primaryKey = this.bindingList.primaryKey;
                const id = event && event.originalData && event.originalData[primaryKey];
                if (id && id !== this.bindingList.currentId) {
                    this.bindingList.setCurrentId(id, true);
                }
            });
        }
        this.bindingData.changes.subscribe((change) => {
            // 因排序需要，值变化时也应进行数据绑定
            if (change.type === ChangeType.Load || change.type === ChangeType.Append || change.type === ChangeType.Remove || change.type === ChangeType.ValueChanged || change.type === ChangeType.SelectionChanged) {
                this.bindData(change);
                this.updateCurrentRow(change);
                this.updateChecks(change);
            }
        });
        this.setChecks([]);
    }
    /**
     * 指令输入变更
     * @param changes -变更
     */
    ngOnChanges(changes) {
    }
    shouldComponentUpdate(data) {
        return !(JSON.stringify(this.__DATA__) === JSON.stringify(data));
        // return !(this.__DATA__ && isEqual(this.__DATA__, data));
    }
    /**
     * 绑定数据
     * @param change -变更
     */
    bindData(change) {
        const bindingPath = this.frameContext.viewModel.bindingPath.split('/').filter(p => p).join('/');
        const eventPath = change && change.path && change.path.filter(p => p).join('/');
        // 行切换、删除、加载、新增数据、页码切换 场景
        if (change && [ChangeType.SelectionChanged, ChangeType.Remove, ChangeType.Load, ChangeType.Append].includes(change.type)) {
            // 非上级实体不重新绑定数据
            if (!bindingPath.startsWith(eventPath)) {
                return;
            }
            // 当前附件组件切换当前行不需要重新渲染
            if (change.type === ChangeType.SelectionChanged && bindingPath === eventPath) {
                return;
            }
        }
        // 非当前实体发生了值变化
        if (change && change.type === ChangeType.ValueChanged && !eventPath.startsWith(bindingPath)) {
            return;
        }
        const fileInfos = this.getFileInfos();
        if (!this.shouldComponentUpdate(fileInfos)) {
            return;
        }
        if (this.componentRef) {
            this.__DATA__ = fileInfos;
            this.componentRef.fileInfos = fileInfos;
            if (this.uploadAndPreviewComponent && fileInfos && fileInfos.length > 0) {
                const extendInfos = fileInfos.map((item) => item.originalData);
                this.uploadAndPreviewComponent.extendInfos = extendInfos;
            }
            this.changeCurrentRow(fileInfos, change);
        }
    }
    updateChecks(change) {
        if (!this.uploadAndPreviewComponent) {
            return;
        }
        const bindingPath = this.frameContext.viewModel.bindingPath.split('/').filter(p => p).join('/');
        const eventPath = change && change.path && change.path.filter(p => p).join('/');
        // 删除自身表时更新勾选记录
        if (change && change.type === ChangeType.Remove && eventPath === bindingPath) {
            const values = change.value || [];
            const ids = this.frameContext.uiState['ids'] || [];
            if (values.length > 0 && ids.length > 0) {
                values.forEach((id) => {
                    const index = ids.indexOf(id);
                    if (index !== -1) {
                        ids.splice(index, 1);
                    }
                });
            }
        }
        else if ((change.type === ChangeType.Remove || change.type === ChangeType.SelectionChanged) && bindingPath.startsWith(eventPath) && bindingPath !== eventPath) {
            //上级（上上级）表删除、上级（上上级）表切换当前行时更新勾选记录
            this.setChecks([]);
            // 清空组件勾选
            this.clearComponentChecks();
        }
        else if (change && change.type === ChangeType.Load && (bindingPath === eventPath || bindingPath.startsWith(eventPath) && bindingPath !== eventPath)) {
            // 当前附件组件数据重新加载 or 上级或上上级重新加载
            this.setChecks([]);
            // 清空组件勾选
            this.clearComponentChecks();
        }
    }
    /**
     * 主动更新当前行
     * @param data - 数据
     * @param change - 变更
     */
    changeCurrentRow(data, change) {
        if (!this.uploadAndPreviewComponent) {
            return;
        }
        const changePath = change && change.path.join('/');
        const paths = this.frameContext.viewModel.bindingPath.split('/').filter(p => p);
        const path = paths.join('/');
        const isParentSelectChange = path.startsWith(changePath) && change.type === ChangeType.SelectionChanged && path !== changePath;
        const isSelfRowDelete = change && change.type === ChangeType.Remove && path === changePath;
        if (data && data.length > 0 && change && (change.type === ChangeType.Load || isParentSelectChange || isSelfRowDelete)) {
            const primaryKey = this.bindingList.primaryKey;
            const id = data[0]['originalData'] && data[0]['originalData'][primaryKey];
            if (this.bindingList.currentId !== id) {
                setTimeout(() => {
                    this.bindingList.setCurrentId(id, true, true);
                }, 100);
            }
        }
    }
    /**
     * 为控件设置当前行
     * @param change - 控制器变更
     * @returns
     */
    updateCurrentRow(change) {
        if (!this.bindingList || !this.bindingList.currentId || !this.uploadAndPreviewComponent) {
            return;
        }
        if (change && change.type !== ChangeType.SelectionChanged && change.type !== ChangeType.Load && change.type !== ChangeType.Remove) {
            return;
        }
        const currentId = this.uploadAndPreviewComponent.previewCurrent;
        // 组件id和数据id进行转换
        const id = this.getValueByPath(this.bindingList.currentItem, this.fileIdKey);
        if (id === currentId) {
            return;
        }
        this.selectComponentRow(id);
    }
    /**
     * 获取附件信息列表
     */
    getFileInfos() {
        const listData = this.bindingList.toJSON();
        const fileInfos = [];
        listData.forEach((itemData) => {
            const fileInfo = this.convertToFileInfo(itemData);
            fileInfos.push(fileInfo);
        });
        // 排序
        if (this.orderField) {
            this.sort(fileInfos, this.orderField, this.orderType);
        }
        return fileInfos;
    }
    /**
     * 行数据转换为文件信息
     * @param itemData - 行数据
     * @returns
     */
    convertToFileInfo(itemData) {
        // const idKey = this.bindingList.primaryKey;
        // const id = this.getValueByPath(itemData, idKey);
        const fileId = this.getValueByPath(itemData, this.fileIdKey);
        const fileName = this.getValueByPath(itemData, this.fileNameKey);
        const fileSize = this.getValueByPath(itemData, this.fileSizeKey);
        const fileCreateTime = this.getValueByPath(itemData, this.fileCreateTimeKey);
        const fileInfo = {
            id: fileId,
            name: fileName,
            size: fileSize,
            createTime: fileCreateTime,
            originalData: itemData,
            extend: {
                metadataId: fileId
            }
        };
        if (this.extendFileInfo && Array.isArray(this.extendFileInfo) && this.extendFileInfo.length > 0) {
            this.extendFileInfo.forEach((item) => {
                fileInfo[item.key] = this.getValueByPath(itemData, item.path);
            });
        }
        if (this.fileSortOrderKey) {
            const fileSortOrder = this.getValueByPath(itemData, this.fileSortOrderKey);
            fileInfo[this.SORT_FIELD_ON_SORTING] = fileSortOrder;
        }
        return fileInfo;
    }
    /**
     * 设置控件的当前行
     * @param id 主键
     */
    selectComponentRow(id) {
        if (this.uploadAndPreviewComponent) {
            this.uploadAndPreviewComponent.previewCurrent = id;
        }
    }
    /**
     * 根据字段路径获取值
     * @param data - 数据源
     * @param path - 字段路径
     */
    getValueByPath(data, path) {
        const keys = path.split('.');
        let currentValue = data;
        keys.forEach((key) => {
            currentValue = currentValue && currentValue[key];
        });
        return currentValue;
    }
    getUdtPaths() {
        const paths = this.fileIdKey.split('.');
        paths.pop();
        return paths;
    }
    get fileSizeKey() {
        const basePaths = this.getUdtPaths();
        return basePaths.concat(['fileSize']).join('.');
    }
    get fileCreateTimeKey() {
        const basePaths = this.getUdtPaths();
        return basePaths.concat(['fileCreateTime']).join('.');
    }
    get componentRef() {
        return this.previewComponent || this.uploadAndPreviewComponent || null;
    }
    setChecks(ids) {
        this.frameContext.uiState.setPropertyValue('ids', ids);
    }
    /**
     * 清空组件勾选
     */
    clearComponentChecks() {
        if (this.uploadAndPreviewComponent) {
            this.uploadAndPreviewComponent.previewUpdateRefresh();
        }
    }
    sort(data, fields, directions) {
        if (!fields || fields.length < 1 || !directions || directions.length < 1) {
            throw new Error('sortBy:argument error');
        }
        // 默认升序
        const arrFields = typeof fields === 'string' ? fields.split(',') : fields || [];
        const arrDirections = typeof directions === 'string' ? directions.split(',') : directions || [];
        // 排序字段和排序方式应一致
        if (arrFields.length !== arrDirections.length || arrFields.length < 1) {
            throw new Error('sortBy:fields and directions not match');
        }
        // nage,age,total
        const comparator = (props, orders) => (item1, item2) => {
            return props.reduce((result, prop) => {
                if (result === 0) {
                    const order = ['asc'].includes(orders[props.indexOf(prop)]) ? 1 : -1;
                    const item1Value = this.getValue(item1, prop);
                    const item2Value = this.getValue(item2, prop);
                    if (item1Value === null || item1Value === undefined) {
                        return 1;
                    }
                    if (item2Value === null || item2Value === undefined) {
                        return -1;
                    }
                    if (typeof item1Value !== typeof item2Value) {
                        const localeCompareResult = String(item1Value).localeCompare(String(item2Value));
                        result = localeCompareResult * order;
                    }
                    else if (typeof item1Value === 'string' && typeof item2Value === 'string') {
                        const localeCompareResult = item1Value.localeCompare(item2Value);
                        result = localeCompareResult * order;
                    }
                    else {
                        if (item1Value > item2Value) {
                            result = order * 1;
                        }
                        if (item1Value < item2Value) {
                            result = order * -1;
                        }
                    }
                }
                return result;
            }, 0);
        };
        data.sort(comparator(arrFields, arrDirections));
    }
    getValue(target, propName) {
        if (target instanceof BindingList) {
            target = target.currentItem;
        }
        else if (target instanceof BindingData) {
            target = target.list.currentItem;
        }
        let result = null;
        if (propName.indexOf('.') === -1) {
            result = target[propName];
        }
        else {
            const props = propName.split('.');
            for (const prop of props) {
                target = result = this.getValue(target, prop);
            }
        }
        return result;
    }
    /**
     * 勾选变化事件
     * @param event
     */
    checkedChanged(event) {
        const primaryKey = this.bindingList.primaryKey;
        const ids = event && event.map((item) => item && item.originalData && item.originalData[primaryKey] || '').filter(p => p) || [];
        this.setChecks(ids);
    }
    /**
     * 行切换事件
     * @param event
     */
    selectChanged(event) {
    }
}
FarrisFilePreviewBindingDirective.decorators = [
    { type: Directive, args: [{
                selector: '[farrisFilePreviewBinding]'
            },] }
];
/** @nocollapse */
FarrisFilePreviewBindingDirective.ctorParameters = () => [
    { type: FFilePreviewComponent, decorators: [{ type: Optional }] },
    { type: FrameContext },
    { type: UploadAndPreviewComponent, decorators: [{ type: Optional }] },
    { type: Injector, decorators: [{ type: Optional }] }
];
FarrisFilePreviewBindingDirective.propDecorators = {
    extendFileInfo: [{ type: Input, args: ['extendFileInfo',] }],
    farrisOrderType: [{ type: Input, args: ['farrisOrderType',] }],
    fileIdKey: [{ type: Input, args: ['farrisFileIdKey',] }],
    fileSortOrderKey: [{ type: Input, args: ['farrisFileSortOrderKey',] }],
    fileNameKey: [{ type: Input, args: ['farrisFileNameKey',] }],
    checkedChanged: [{ type: HostListener, args: ['fPreviewMultiSelectedEvent', ['$event'],] }],
    selectChanged: [{ type: HostListener, args: ['fSelectedEvent', ['$event'],] }]
};
export { FarrisFilePreviewBindingDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzLWZpbGUtcHJldmlldy1iaW5kaW5nLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMva2VuZG8tYmluZGluZy8iLCJzb3VyY2VzIjpbImxpYi9kaXJlY3RpdmVzL2ZpbGUtcHJldmlldy9mYXJyaXMtZmlsZS1wcmV2aWV3LWJpbmRpbmcuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQW9DLEtBQUssRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNySCxPQUFPLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxZQUFZLEVBQVUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUYsT0FBTyxFQUFjLHFCQUFxQixFQUFFLHlCQUF5QixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFFMUc7O0dBRUc7QUFDSCxNQUdNLGlDQUFpQztJQTZEckM7Ozs7Ozs7T0FPRztJQUNILFlBQ3NCLGdCQUF1QyxFQUNuRCxZQUEwQixFQUNkLHlCQUFvRCxFQUNwRCxRQUFrQjtRQUhsQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQXVCO1FBQ25ELGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQ2QsOEJBQXlCLEdBQXpCLHlCQUF5QixDQUEyQjtRQUNwRCxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBdkV4Qzs7V0FFRztRQUNjLHVCQUFrQixHQUFHLFlBQVksQ0FBQztRQUNuRDs7V0FFRztRQUNjLDBCQUFxQixHQUFHLGVBQWUsQ0FBQztJQWtFekQsQ0FBQztJQTFDRDs7T0FFRztJQUNILElBQVksV0FBVztRQUNyQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO0lBQ3ZDLENBQUM7SUFFRDs7T0FFRztJQUNILElBQVksV0FBVztRQUNyQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDcEMsQ0FBQztJQUNEOzs7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dkIsS0FBSyxTQUFDLGlCQUFpQjsrQkFLdkIsS0FBSyxTQUFDLHdCQUF3QjswQkFLOUIsS0FBSyxTQUFDLG1CQUFtQjs2QkEwV3pCLFlBQVksU0FBQyw0QkFBNEIsRUFBRSxDQUFDLFFBQVEsQ0FBQzs0QkFVckQsWUFBWSxTQUFDLGdCQUFnQixFQUFFLENBQUMsUUFBUSxDQUFDOztBQU01QyxPQUFPLEVBQUUsaUNBQWlDLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgT25Jbml0LCBPbkNoYW5nZXMsIFNpbXBsZUNoYW5nZXMsIElucHV0LCBJbmplY3RvciwgT3B0aW9uYWwsIEhvc3RMaXN0ZW5lciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBCaW5kaW5nRGF0YSwgQmluZGluZ0xpc3QsIEZyYW1lQ29udGV4dCwgQ2hhbmdlLCBDaGFuZ2VUeXBlIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBVcGxvYWRGaWxlLCBGRmlsZVByZXZpZXdDb21wb25lbnQsIFVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL2V4dGVuZC1maWxlLXVwbG9hZCc7XHJcblxyXG4vKipcclxuICog5qCR6KGo5qC857uR5a6a5oyH5LukXHJcbiAqL1xyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1tmYXJyaXNGaWxlUHJldmlld0JpbmRpbmddJ1xyXG59KVxyXG5jbGFzcyBGYXJyaXNGaWxlUHJldmlld0JpbmRpbmdEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcyB7XHJcbiAgcHJpdmF0ZSBfX0RBVEFfXzogYW55O1xyXG4gIC8qKlxyXG4gICAqIOacquWQr+eUqOaOkuW6j+aXtum7mOiupOaMieS4iuS8oOaXtumXtOWtl+auteaOkuW6j1xyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgREVGQVVMVF9TT1JUX0ZJRUxEID0gJ2NyZWF0ZVRpbWUnO1xyXG4gIC8qKlxyXG4gICAqIOWQr+eUqOaOkuW6j+aXtuS9v+eUqGZpbGVTb3J0T3JkZXLlgZrmjpLluo/lrZfmrrXvvIzkuI7pm7bku6PnoIHnmoTmi5bmi73mjpLluo/nu5/kuIBcclxuICAgKi9cclxuICBwcml2YXRlIHJlYWRvbmx5IFNPUlRfRklFTERfT05fU09SVElORyA9ICdmaWxlU29ydE9yZGVyJztcclxuICBASW5wdXQoJ2V4dGVuZEZpbGVJbmZvJylcclxuICBwdWJsaWMgZXh0ZW5kRmlsZUluZm86IHsga2V5OiBzdHJpbmcsIHBhdGg6IGFueSB9W107XHJcbiAgLyoqXHJcbiAgICog5o6S5bqP5pa55byPXHJcbiAgICovXHJcbiAgQElucHV0KCdmYXJyaXNPcmRlclR5cGUnKVxyXG4gIHB1YmxpYyBmYXJyaXNPcmRlclR5cGU6IHN0cmluZztcclxuICAvKipcclxuICAgKiDmlofku7ZpZOWtl+autei3r+W+hFxyXG4gICAqL1xyXG4gIEBJbnB1dCgnZmFycmlzRmlsZUlkS2V5JylcclxuICBwdWJsaWMgZmlsZUlkS2V5OiBzdHJpbmc7XHJcbiAgLyoqXHJcbiAgICog5o6S5bqP5a2X5q6177yM5ouW5ou95o6S5bqP55u45YWzXHJcbiAgICovXHJcbiAgQElucHV0KCdmYXJyaXNGaWxlU29ydE9yZGVyS2V5JylcclxuICBwdWJsaWMgZmlsZVNvcnRPcmRlcktleTogc3RyaW5nO1xyXG4gIC8qKlxyXG4gICAqIOaWh+S7tm5hbWXlrZfmrrXot6/lvoRcclxuICAgKi9cclxuICBASW5wdXQoJ2ZhcnJpc0ZpbGVOYW1lS2V5JylcclxuICBwdWJsaWMgZmlsZU5hbWVLZXk6IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICog57uR5a6a5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXQgYmluZGluZ0RhdGEoKTogQmluZGluZ0RhdGEge1xyXG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog57uR5a6a5pWw5o2u5YiX6KGoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXQgYmluZGluZ0xpc3QoKTogQmluZGluZ0xpc3Qge1xyXG4gICAgcmV0dXJuIHRoaXMuYmluZGluZ0RhdGEuZ2V0TGlzdCgpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmjpLluo/lrZfmrrVcclxuICAgKiBAZGVzY3JpcHRpb25cclxuICAgKiDnu4Tku7bmjpLluo/lrZfmrrXlj6rmnInkuIDkuKrvvIzkuI3mlK/mjIHlpJrkuKrjgIJcclxuICAgKiDlpoLmnpzlkK/nlKjkuobmi5bmi73mjpLluo/vvIzliJnkuLpmaWxlU29ydE9yZGVy77yM5ZCm5YiZ5L2/55So6buY6K6k55qEY3JlYXRlVGltZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0IG9yZGVyRmllbGQoKSB7XHJcbiAgICByZXR1cm4gdGhpcy51cGxvYWRBbmRQcmV2aWV3Q29tcG9uZW50ICYmIHRoaXMudXBsb2FkQW5kUHJldmlld0NvbXBvbmVudC5lbmFibGVPcmRlciAmJiB0aGlzLnVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQub3JkZXJGaWVsZCB8fCB0aGlzLmZpbGVTb3J0T3JkZXJLZXkgJiYgdGhpcy5TT1JUX0ZJRUxEX09OX1NPUlRJTkcgfHwgdGhpcy5ERUZBVUxUX1NPUlRfRklFTEQ7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOm7mOiupOmZjeW6j1xyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0IG9yZGVyVHlwZSgpIHtcclxuICAgIHJldHVybiB0aGlzLmZhcnJpc09yZGVyVHlwZSA/IHRoaXMuZmFycmlzT3JkZXJUeXBlIDogdGhpcy5vcmRlckZpZWxkID09PSB0aGlzLkRFRkFVTFRfU09SVF9GSUVMRCA/ICdkZXNjJyA6ICdhc2MnO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKiBAcGFyYW0gcHJldmlld0NvbXBvbmVudCAtIOmZhOS7tue7hOS7tlxyXG4gICAqIEBwYXJhbSBmcmFtZUNvbnRleHQgLSDmjqfliLblmajkuIrkuIvmlodcclxuICAgKiBAcGFyYW0gdXBsb2FkQW5kUHJldmlld0NvbXBvbmVudCAtIOmZhOS7tuS4iuS8oOmihOiniOe7hOS7tlxyXG4gICAqIEBwYXJhbSBpbmplY3RvciAtIGluamVjdG9yXHJcbiAgICogQFRPRE86IOivpeaMh+S7pOiiq+eUqOS6juS4jeWQjOeahOe7hOS7tuS4re+8jOWboOatpHVwbG9hZEFuZFByZXZpZXdDb21wb25lbnTlj6/og73kuLpudWxsXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHByZXZpZXdDb21wb25lbnQ6IEZGaWxlUHJldmlld0NvbXBvbmVudCxcclxuICAgIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQ6IFVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvclxyXG4gICkge1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5oyH5Luk5Yid5aeL5YyWXHJcbiAgICovXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICB0aGlzLmJpbmREYXRhKCk7XHJcbiAgICBpZiAodGhpcy51cGxvYWRBbmRQcmV2aWV3Q29tcG9uZW50KSB7XHJcbiAgICAgIGlmICh0aGlzLnVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQuZW5hYmxlT3JkZXIpIHtcclxuICAgICAgICB0aGlzLnVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQub3JkZXJGaWVsZCA9IHRoaXMuU09SVF9GSUVMRF9PTl9TT1JUSU5HO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIOemgeeUqOe7hOS7tuWGhee9ruaOkuW6j++8jOaOp+WItuWZqOi0n+i0o+aOkuW6j+W5tuWwhuaOkuW6j+WQjueahOaVsOaNrue7keWumuWIsOmZhOS7tuS4iuS8oOmihOiniOe7hOS7tlxyXG4gICAgICB0aGlzLnVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQuZW5hYmxlU29ydGluZyA9IGZhbHNlO1xyXG4gICAgICB0aGlzLnVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQuZlNlbGVjdGVkRXZlbnQuc3Vic2NyaWJlKChldmVudDogYW55KSA9PiB7XHJcbiAgICAgICAgY29uc3QgcHJpbWFyeUtleSA9IHRoaXMuYmluZGluZ0xpc3QucHJpbWFyeUtleTtcclxuICAgICAgICBjb25zdCBpZCA9IGV2ZW50ICYmIGV2ZW50Lm9yaWdpbmFsRGF0YSAmJiBldmVudC5vcmlnaW5hbERhdGFbcHJpbWFyeUtleV07XHJcbiAgICAgICAgaWYgKGlkICYmIGlkICE9PSB0aGlzLmJpbmRpbmdMaXN0LmN1cnJlbnRJZCkge1xyXG4gICAgICAgICAgdGhpcy5iaW5kaW5nTGlzdC5zZXRDdXJyZW50SWQoaWQsIHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmJpbmRpbmdEYXRhLmNoYW5nZXMuc3Vic2NyaWJlKChjaGFuZ2U6IENoYW5nZSkgPT4ge1xyXG4gICAgICAvLyDlm6DmjpLluo/pnIDopoHvvIzlgLzlj5jljJbml7bkuZ/lupTov5vooYzmlbDmja7nu5HlrppcclxuICAgICAgaWYgKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLkxvYWQgfHwgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuQXBwZW5kIHx8IGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlJlbW92ZSB8fCBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5WYWx1ZUNoYW5nZWQgfHwgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuU2VsZWN0aW9uQ2hhbmdlZCkge1xyXG4gICAgICAgIHRoaXMuYmluZERhdGEoY2hhbmdlKTtcclxuICAgICAgICB0aGlzLnVwZGF0ZUN1cnJlbnRSb3coY2hhbmdlKTtcclxuICAgICAgICB0aGlzLnVwZGF0ZUNoZWNrcyhjaGFuZ2UpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHRoaXMuc2V0Q2hlY2tzKFtdKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaMh+S7pOi+k+WFpeWPmOabtFxyXG4gICAqIEBwYXJhbSBjaGFuZ2VzIC3lj5jmm7RcclxuICAgKi9cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XHJcbiAgfVxyXG4gIHByaXZhdGUgc2hvdWxkQ29tcG9uZW50VXBkYXRlKGRhdGE6IGFueSkge1xyXG4gICAgcmV0dXJuICEoSlNPTi5zdHJpbmdpZnkodGhpcy5fX0RBVEFfXykgPT09IEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcclxuICAgIC8vIHJldHVybiAhKHRoaXMuX19EQVRBX18gJiYgaXNFcXVhbCh0aGlzLl9fREFUQV9fLCBkYXRhKSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOe7keWumuaVsOaNrlxyXG4gICAqIEBwYXJhbSBjaGFuZ2UgLeWPmOabtFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYmluZERhdGEoY2hhbmdlPzogQ2hhbmdlKSB7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IHRoaXMuZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLmpvaW4oJy8nKTtcclxuICAgIGNvbnN0IGV2ZW50UGF0aCA9IGNoYW5nZSAmJiBjaGFuZ2UucGF0aCAmJiBjaGFuZ2UucGF0aC5maWx0ZXIocCA9PiBwKS5qb2luKCcvJyk7XHJcbiAgICAvLyDooYzliIfmjaLjgIHliKDpmaTjgIHliqDovb3jgIHmlrDlop7mlbDmja7jgIHpobXnoIHliIfmjaIg5Zy65pmvXHJcbiAgICBpZiAoY2hhbmdlICYmIFtDaGFuZ2VUeXBlLlNlbGVjdGlvbkNoYW5nZWQsIENoYW5nZVR5cGUuUmVtb3ZlLCBDaGFuZ2VUeXBlLkxvYWQsIENoYW5nZVR5cGUuQXBwZW5kXS5pbmNsdWRlcyhjaGFuZ2UudHlwZSkpIHtcclxuICAgICAgLy8g6Z2e5LiK57qn5a6e5L2T5LiN6YeN5paw57uR5a6a5pWw5o2uXHJcbiAgICAgIGlmICghYmluZGluZ1BhdGguc3RhcnRzV2l0aChldmVudFBhdGgpKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIOW9k+WJjemZhOS7tue7hOS7tuWIh+aNouW9k+WJjeihjOS4jemcgOimgemHjeaWsOa4suafk1xyXG4gICAgICBpZiAoY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuU2VsZWN0aW9uQ2hhbmdlZCAmJiBiaW5kaW5nUGF0aCA9PT0gZXZlbnRQYXRoKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICAvLyDpnZ7lvZPliY3lrp7kvZPlj5HnlJ/kuoblgLzlj5jljJZcclxuICAgIGlmIChjaGFuZ2UgJiYgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuVmFsdWVDaGFuZ2VkICYmICFldmVudFBhdGguc3RhcnRzV2l0aChiaW5kaW5nUGF0aCkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZmlsZUluZm9zID0gdGhpcy5nZXRGaWxlSW5mb3MoKTtcclxuICAgIGlmICghdGhpcy5zaG91bGRDb21wb25lbnRVcGRhdGUoZmlsZUluZm9zKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5jb21wb25lbnRSZWYpIHtcclxuICAgICAgdGhpcy5fX0RBVEFfXyA9IGZpbGVJbmZvcztcclxuICAgICAgdGhpcy5jb21wb25lbnRSZWYuZmlsZUluZm9zID0gZmlsZUluZm9zO1xyXG4gICAgICBpZiAodGhpcy51cGxvYWRBbmRQcmV2aWV3Q29tcG9uZW50ICYmIGZpbGVJbmZvcyAmJiBmaWxlSW5mb3MubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGNvbnN0IGV4dGVuZEluZm9zID0gZmlsZUluZm9zLm1hcCgoaXRlbTogYW55KSA9PiBpdGVtLm9yaWdpbmFsRGF0YSk7XHJcbiAgICAgICAgdGhpcy51cGxvYWRBbmRQcmV2aWV3Q29tcG9uZW50LmV4dGVuZEluZm9zID0gZXh0ZW5kSW5mb3M7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5jaGFuZ2VDdXJyZW50Um93KGZpbGVJbmZvcywgY2hhbmdlKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSB1cGRhdGVDaGVja3MoY2hhbmdlPzogQ2hhbmdlKSB7XHJcbiAgICBpZiAoIXRoaXMudXBsb2FkQW5kUHJldmlld0NvbXBvbmVudCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IHRoaXMuZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLmpvaW4oJy8nKTtcclxuICAgIGNvbnN0IGV2ZW50UGF0aCA9IGNoYW5nZSAmJiBjaGFuZ2UucGF0aCAmJiBjaGFuZ2UucGF0aC5maWx0ZXIocCA9PiBwKS5qb2luKCcvJyk7XHJcbiAgICAvLyDliKDpmaToh6rouqvooajml7bmm7TmlrDli77pgInorrDlvZVcclxuICAgIGlmIChjaGFuZ2UgJiYgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuUmVtb3ZlICYmIGV2ZW50UGF0aCA9PT0gYmluZGluZ1BhdGgpIHtcclxuICAgICAgY29uc3QgdmFsdWVzID0gY2hhbmdlLnZhbHVlIHx8IFtdO1xyXG4gICAgICBjb25zdCBpZHM6IGFueVtdID0gdGhpcy5mcmFtZUNvbnRleHQudWlTdGF0ZVsnaWRzJ10gfHwgW107XHJcbiAgICAgIGlmICh2YWx1ZXMubGVuZ3RoID4gMCAmJiBpZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHZhbHVlcy5mb3JFYWNoKChpZDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBpbmRleCA9IGlkcy5pbmRleE9mKGlkKTtcclxuICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcclxuICAgICAgICAgICAgaWRzLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAoKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlJlbW92ZSB8fCBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5TZWxlY3Rpb25DaGFuZ2VkKSAmJiBiaW5kaW5nUGF0aC5zdGFydHNXaXRoKGV2ZW50UGF0aCkgJiYgYmluZGluZ1BhdGggIT09IGV2ZW50UGF0aCkge1xyXG4gICAgICAvL+S4iue6p++8iOS4iuS4iue6p++8ieihqOWIoOmZpOOAgeS4iue6p++8iOS4iuS4iue6p++8ieihqOWIh+aNouW9k+WJjeihjOaXtuabtOaWsOWLvumAieiusOW9lVxyXG4gICAgICB0aGlzLnNldENoZWNrcyhbXSk7XHJcbiAgICAgIC8vIOa4heepuue7hOS7tuWLvumAiVxyXG4gICAgICB0aGlzLmNsZWFyQ29tcG9uZW50Q2hlY2tzKCk7XHJcbiAgICB9IGVsc2UgaWYgKGNoYW5nZSAmJiBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5Mb2FkICYmIChiaW5kaW5nUGF0aCA9PT0gZXZlbnRQYXRoIHx8IGJpbmRpbmdQYXRoLnN0YXJ0c1dpdGgoZXZlbnRQYXRoKSAmJiBiaW5kaW5nUGF0aCAhPT0gZXZlbnRQYXRoKSkge1xyXG4gICAgICAvLyDlvZPliY3pmYTku7bnu4Tku7bmlbDmja7ph43mlrDliqDovb0gb3Ig5LiK57qn5oiW5LiK5LiK57qn6YeN5paw5Yqg6L29XHJcbiAgICAgIHRoaXMuc2V0Q2hlY2tzKFtdKTtcclxuICAgICAgLy8g5riF56m657uE5Lu25Yu+6YCJXHJcbiAgICAgIHRoaXMuY2xlYXJDb21wb25lbnRDaGVja3MoKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Li75Yqo5pu05paw5b2T5YmN6KGMXHJcbiAgICogQHBhcmFtIGRhdGEgLSDmlbDmja5cclxuICAgKiBAcGFyYW0gY2hhbmdlIC0g5Y+Y5pu0XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjaGFuZ2VDdXJyZW50Um93KGRhdGE6IGFueSwgY2hhbmdlPzogQ2hhbmdlKSB7XHJcbiAgICBpZiAoIXRoaXMudXBsb2FkQW5kUHJldmlld0NvbXBvbmVudCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBjaGFuZ2VQYXRoID0gY2hhbmdlICYmIGNoYW5nZS5wYXRoLmpvaW4oJy8nKTtcclxuICAgIGNvbnN0IHBhdGhzID0gdGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICBjb25zdCBwYXRoID0gcGF0aHMuam9pbignLycpO1xyXG4gICAgY29uc3QgaXNQYXJlbnRTZWxlY3RDaGFuZ2UgPSBwYXRoLnN0YXJ0c1dpdGgoY2hhbmdlUGF0aCkgJiYgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuU2VsZWN0aW9uQ2hhbmdlZCAmJiBwYXRoICE9PSBjaGFuZ2VQYXRoO1xyXG4gICAgY29uc3QgaXNTZWxmUm93RGVsZXRlID0gY2hhbmdlICYmIGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlJlbW92ZSAmJiBwYXRoID09PSBjaGFuZ2VQYXRoO1xyXG4gICAgaWYgKGRhdGEgJiYgZGF0YS5sZW5ndGggPiAwICYmIGNoYW5nZSAmJiAoY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuTG9hZCB8fCBpc1BhcmVudFNlbGVjdENoYW5nZSB8fCBpc1NlbGZSb3dEZWxldGUpKSB7XHJcbiAgICAgIGNvbnN0IHByaW1hcnlLZXkgPSB0aGlzLmJpbmRpbmdMaXN0LnByaW1hcnlLZXk7XHJcbiAgICAgIGNvbnN0IGlkID0gZGF0YVswXVsnb3JpZ2luYWxEYXRhJ10gJiYgZGF0YVswXVsnb3JpZ2luYWxEYXRhJ11bcHJpbWFyeUtleV07XHJcbiAgICAgIGlmICh0aGlzLmJpbmRpbmdMaXN0LmN1cnJlbnRJZCAhPT0gaWQpIHtcclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgIHRoaXMuYmluZGluZ0xpc3Quc2V0Q3VycmVudElkKGlkLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICB9LCAxMDApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOS4uuaOp+S7tuiuvue9ruW9k+WJjeihjFxyXG4gICAqIEBwYXJhbSBjaGFuZ2UgLSDmjqfliLblmajlj5jmm7RcclxuICAgKiBAcmV0dXJuc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgdXBkYXRlQ3VycmVudFJvdyhjaGFuZ2U/OiBDaGFuZ2UpIHtcclxuICAgIGlmICghdGhpcy5iaW5kaW5nTGlzdCB8fCAhdGhpcy5iaW5kaW5nTGlzdC5jdXJyZW50SWQgfHwgIXRoaXMudXBsb2FkQW5kUHJldmlld0NvbXBvbmVudCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoY2hhbmdlICYmIGNoYW5nZS50eXBlICE9PSBDaGFuZ2VUeXBlLlNlbGVjdGlvbkNoYW5nZWQgJiYgY2hhbmdlLnR5cGUgIT09IENoYW5nZVR5cGUuTG9hZCAmJiBjaGFuZ2UudHlwZSAhPT0gQ2hhbmdlVHlwZS5SZW1vdmUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgY3VycmVudElkID0gdGhpcy51cGxvYWRBbmRQcmV2aWV3Q29tcG9uZW50LnByZXZpZXdDdXJyZW50O1xyXG4gICAgLy8g57uE5Lu2aWTlkozmlbDmja5pZOi/m+ihjOi9rOaNolxyXG4gICAgY29uc3QgaWQgPSB0aGlzLmdldFZhbHVlQnlQYXRoKHRoaXMuYmluZGluZ0xpc3QuY3VycmVudEl0ZW0sIHRoaXMuZmlsZUlkS2V5KTtcclxuICAgIGlmIChpZCA9PT0gY3VycmVudElkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuc2VsZWN0Q29tcG9uZW50Um93KGlkKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W6ZmE5Lu25L+h5oGv5YiX6KGoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRGaWxlSW5mb3MoKTogVXBsb2FkRmlsZVtdIHtcclxuICAgIGNvbnN0IGxpc3REYXRhID0gdGhpcy5iaW5kaW5nTGlzdC50b0pTT04oKTtcclxuICAgIGNvbnN0IGZpbGVJbmZvczogVXBsb2FkRmlsZVtdID0gW107XHJcbiAgICBsaXN0RGF0YS5mb3JFYWNoKChpdGVtRGF0YTogYW55KSA9PiB7XHJcbiAgICAgIGNvbnN0IGZpbGVJbmZvID0gdGhpcy5jb252ZXJ0VG9GaWxlSW5mbyhpdGVtRGF0YSk7XHJcbiAgICAgIGZpbGVJbmZvcy5wdXNoKGZpbGVJbmZvKTtcclxuICAgIH0pO1xyXG4gICAgLy8g5o6S5bqPXHJcbiAgICBpZiAodGhpcy5vcmRlckZpZWxkKSB7XHJcbiAgICAgIHRoaXMuc29ydChmaWxlSW5mb3MsIHRoaXMub3JkZXJGaWVsZCwgdGhpcy5vcmRlclR5cGUpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZpbGVJbmZvcztcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6KGM5pWw5o2u6L2s5o2i5Li65paH5Lu25L+h5oGvXHJcbiAgICogQHBhcmFtIGl0ZW1EYXRhIC0g6KGM5pWw5o2uXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwcml2YXRlIGNvbnZlcnRUb0ZpbGVJbmZvKGl0ZW1EYXRhOiBhbnkpIHtcclxuICAgIC8vIGNvbnN0IGlkS2V5ID0gdGhpcy5iaW5kaW5nTGlzdC5wcmltYXJ5S2V5O1xyXG4gICAgLy8gY29uc3QgaWQgPSB0aGlzLmdldFZhbHVlQnlQYXRoKGl0ZW1EYXRhLCBpZEtleSk7XHJcbiAgICBjb25zdCBmaWxlSWQgPSB0aGlzLmdldFZhbHVlQnlQYXRoKGl0ZW1EYXRhLCB0aGlzLmZpbGVJZEtleSk7XHJcbiAgICBjb25zdCBmaWxlTmFtZSA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbURhdGEsIHRoaXMuZmlsZU5hbWVLZXkpO1xyXG4gICAgY29uc3QgZmlsZVNpemUgPSB0aGlzLmdldFZhbHVlQnlQYXRoKGl0ZW1EYXRhLCB0aGlzLmZpbGVTaXplS2V5KTtcclxuICAgIGNvbnN0IGZpbGVDcmVhdGVUaW1lID0gdGhpcy5nZXRWYWx1ZUJ5UGF0aChpdGVtRGF0YSwgdGhpcy5maWxlQ3JlYXRlVGltZUtleSk7XHJcblxyXG4gICAgY29uc3QgZmlsZUluZm86IGFueSA9IHtcclxuICAgICAgaWQ6IGZpbGVJZCxcclxuICAgICAgbmFtZTogZmlsZU5hbWUsXHJcbiAgICAgIHNpemU6IGZpbGVTaXplLFxyXG4gICAgICBjcmVhdGVUaW1lOiBmaWxlQ3JlYXRlVGltZSxcclxuICAgICAgb3JpZ2luYWxEYXRhOiBpdGVtRGF0YSxcclxuICAgICAgZXh0ZW5kOiB7XHJcbiAgICAgICAgbWV0YWRhdGFJZDogZmlsZUlkXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICBpZiAodGhpcy5leHRlbmRGaWxlSW5mbyAmJiBBcnJheS5pc0FycmF5KHRoaXMuZXh0ZW5kRmlsZUluZm8pICYmIHRoaXMuZXh0ZW5kRmlsZUluZm8ubGVuZ3RoID4gMCkge1xyXG4gICAgICB0aGlzLmV4dGVuZEZpbGVJbmZvLmZvckVhY2goKGl0ZW0pID0+IHtcclxuICAgICAgICBmaWxlSW5mb1tpdGVtLmtleV0gPSB0aGlzLmdldFZhbHVlQnlQYXRoKGl0ZW1EYXRhLCBpdGVtLnBhdGgpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmZpbGVTb3J0T3JkZXJLZXkpIHtcclxuICAgICAgY29uc3QgZmlsZVNvcnRPcmRlciA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbURhdGEsIHRoaXMuZmlsZVNvcnRPcmRlcktleSk7XHJcbiAgICAgIGZpbGVJbmZvW3RoaXMuU09SVF9GSUVMRF9PTl9TT1JUSU5HXSA9IGZpbGVTb3J0T3JkZXI7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmlsZUluZm87XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiuvue9ruaOp+S7tueahOW9k+WJjeihjFxyXG4gICAqIEBwYXJhbSBpZCDkuLvplK5cclxuICAgKi9cclxuICBwcml2YXRlIHNlbGVjdENvbXBvbmVudFJvdyhpZCkge1xyXG4gICAgaWYgKHRoaXMudXBsb2FkQW5kUHJldmlld0NvbXBvbmVudCkge1xyXG4gICAgICB0aGlzLnVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQucHJldmlld0N1cnJlbnQgPSBpZDtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5qC55o2u5a2X5q616Lev5b6E6I635Y+W5YC8XHJcbiAgICogQHBhcmFtIGRhdGEgLSDmlbDmja7mupBcclxuICAgKiBAcGFyYW0gcGF0aCAtIOWtl+autei3r+W+hFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0VmFsdWVCeVBhdGgoZGF0YTogYW55LCBwYXRoOiBzdHJpbmcpOiBhbnkge1xyXG4gICAgY29uc3Qga2V5cyA9IHBhdGguc3BsaXQoJy4nKTtcclxuICAgIGxldCBjdXJyZW50VmFsdWUgPSBkYXRhO1xyXG4gICAga2V5cy5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICBjdXJyZW50VmFsdWUgPSBjdXJyZW50VmFsdWUgJiYgY3VycmVudFZhbHVlW2tleV07XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBjdXJyZW50VmFsdWU7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0VWR0UGF0aHMoKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3QgcGF0aHMgPSB0aGlzLmZpbGVJZEtleS5zcGxpdCgnLicpO1xyXG4gICAgcGF0aHMucG9wKCk7XHJcbiAgICByZXR1cm4gcGF0aHM7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0IGZpbGVTaXplS2V5KCkge1xyXG4gICAgY29uc3QgYmFzZVBhdGhzID0gdGhpcy5nZXRVZHRQYXRocygpO1xyXG4gICAgcmV0dXJuIGJhc2VQYXRocy5jb25jYXQoWydmaWxlU2l6ZSddKS5qb2luKCcuJyk7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0IGZpbGVDcmVhdGVUaW1lS2V5KCkge1xyXG4gICAgY29uc3QgYmFzZVBhdGhzID0gdGhpcy5nZXRVZHRQYXRocygpO1xyXG4gICAgcmV0dXJuIGJhc2VQYXRocy5jb25jYXQoWydmaWxlQ3JlYXRlVGltZSddKS5qb2luKCcuJyk7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0IGNvbXBvbmVudFJlZigpIHtcclxuICAgIHJldHVybiB0aGlzLnByZXZpZXdDb21wb25lbnQgfHwgdGhpcy51cGxvYWRBbmRQcmV2aWV3Q29tcG9uZW50IHx8IG51bGw7XHJcbiAgfVxyXG4gIHByaXZhdGUgc2V0Q2hlY2tzKGlkczogYW55KSB7XHJcbiAgICB0aGlzLmZyYW1lQ29udGV4dC51aVN0YXRlLnNldFByb3BlcnR5VmFsdWUoJ2lkcycsIGlkcyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOa4heepuue7hOS7tuWLvumAiVxyXG4gICAqL1xyXG4gIHByaXZhdGUgY2xlYXJDb21wb25lbnRDaGVja3MoKSB7XHJcbiAgICBpZiAodGhpcy51cGxvYWRBbmRQcmV2aWV3Q29tcG9uZW50KSB7XHJcbiAgICAgIHRoaXMudXBsb2FkQW5kUHJldmlld0NvbXBvbmVudC5wcmV2aWV3VXBkYXRlUmVmcmVzaCgpO1xyXG4gICAgfVxyXG4gIH1cclxuICBwdWJsaWMgc29ydChkYXRhOiBhbnlbXSwgZmllbGRzOiBzdHJpbmcgfCBBcnJheTxzdHJpbmc+LCBkaXJlY3Rpb25zOiBzdHJpbmcgfCBBcnJheTxzdHJpbmc+KSB7XHJcbiAgICBpZiAoIWZpZWxkcyB8fCBmaWVsZHMubGVuZ3RoIDwgMSB8fCAhZGlyZWN0aW9ucyB8fCBkaXJlY3Rpb25zLmxlbmd0aCA8IDEpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdzb3J0Qnk6YXJndW1lbnQgZXJyb3InKTtcclxuICAgIH1cclxuICAgIC8vIOm7mOiupOWNh+W6j1xyXG4gICAgY29uc3QgYXJyRmllbGRzOiBBcnJheTxzdHJpbmc+ID0gdHlwZW9mIGZpZWxkcyA9PT0gJ3N0cmluZycgPyBmaWVsZHMuc3BsaXQoJywnKSA6IGZpZWxkcyB8fCBbXTtcclxuICAgIGNvbnN0IGFyckRpcmVjdGlvbnM6IEFycmF5PHN0cmluZz4gPSB0eXBlb2YgZGlyZWN0aW9ucyA9PT0gJ3N0cmluZycgPyBkaXJlY3Rpb25zLnNwbGl0KCcsJykgOiBkaXJlY3Rpb25zIHx8IFtdO1xyXG4gICAgLy8g5o6S5bqP5a2X5q615ZKM5o6S5bqP5pa55byP5bqU5LiA6Ie0XHJcbiAgICBpZiAoYXJyRmllbGRzLmxlbmd0aCAhPT0gYXJyRGlyZWN0aW9ucy5sZW5ndGggfHwgYXJyRmllbGRzLmxlbmd0aCA8IDEpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdzb3J0Qnk6ZmllbGRzIGFuZCBkaXJlY3Rpb25zIG5vdCBtYXRjaCcpO1xyXG4gICAgfVxyXG4gICAgLy8gbmFnZSxhZ2UsdG90YWxcclxuICAgIGNvbnN0IGNvbXBhcmF0b3IgPSAocHJvcHM6IEFycmF5PHN0cmluZz4sIG9yZGVyczogQXJyYXk8c3RyaW5nPikgPT4gKGl0ZW0xOiBhbnksIGl0ZW0yOiBhbnkpID0+IHtcclxuICAgICAgcmV0dXJuIHByb3BzLnJlZHVjZSgocmVzdWx0LCBwcm9wKSA9PiB7XHJcbiAgICAgICAgaWYgKHJlc3VsdCA9PT0gMCkge1xyXG4gICAgICAgICAgY29uc3Qgb3JkZXIgPSBbJ2FzYyddLmluY2x1ZGVzKG9yZGVyc1twcm9wcy5pbmRleE9mKHByb3ApXSkgPyAxIDogLTE7XHJcbiAgICAgICAgICBjb25zdCBpdGVtMVZhbHVlID0gdGhpcy5nZXRWYWx1ZShpdGVtMSwgcHJvcCk7XHJcbiAgICAgICAgICBjb25zdCBpdGVtMlZhbHVlID0gdGhpcy5nZXRWYWx1ZShpdGVtMiwgcHJvcCk7XHJcbiAgICAgICAgICBpZiAoaXRlbTFWYWx1ZSA9PT0gbnVsbCB8fCBpdGVtMVZhbHVlID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIDE7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBpZiAoaXRlbTJWYWx1ZSA9PT0gbnVsbCB8fCBpdGVtMlZhbHVlID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIC0xO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIGlmICh0eXBlb2YgaXRlbTFWYWx1ZSAhPT0gdHlwZW9mIGl0ZW0yVmFsdWUpIHtcclxuICAgICAgICAgICAgY29uc3QgbG9jYWxlQ29tcGFyZVJlc3VsdCA9IFN0cmluZyhpdGVtMVZhbHVlKS5sb2NhbGVDb21wYXJlKFN0cmluZyhpdGVtMlZhbHVlKSk7XHJcbiAgICAgICAgICAgIHJlc3VsdCA9IGxvY2FsZUNvbXBhcmVSZXN1bHQgKiBvcmRlcjtcclxuICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGl0ZW0xVmFsdWUgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBpdGVtMlZhbHVlID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICBjb25zdCBsb2NhbGVDb21wYXJlUmVzdWx0ID0gaXRlbTFWYWx1ZS5sb2NhbGVDb21wYXJlKGl0ZW0yVmFsdWUpO1xyXG4gICAgICAgICAgICByZXN1bHQgPSBsb2NhbGVDb21wYXJlUmVzdWx0ICogb3JkZXI7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoaXRlbTFWYWx1ZSA+IGl0ZW0yVmFsdWUpIHtcclxuICAgICAgICAgICAgICByZXN1bHQgPSBvcmRlciAqIDE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGl0ZW0xVmFsdWUgPCBpdGVtMlZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgcmVzdWx0ID0gb3JkZXIgKiAtMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICB9LCAwKTtcclxuICAgIH07XHJcbiAgICBkYXRhLnNvcnQoY29tcGFyYXRvcihhcnJGaWVsZHMsIGFyckRpcmVjdGlvbnMpKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRWYWx1ZSh0YXJnZXQ6IGFueSwgcHJvcE5hbWU6IHN0cmluZykge1xyXG4gICAgaWYgKHRhcmdldCBpbnN0YW5jZW9mIEJpbmRpbmdMaXN0KSB7XHJcbiAgICAgIHRhcmdldCA9IHRhcmdldC5jdXJyZW50SXRlbTtcclxuICAgIH0gZWxzZSBpZiAodGFyZ2V0IGluc3RhbmNlb2YgQmluZGluZ0RhdGEpIHtcclxuICAgICAgdGFyZ2V0ID0gdGFyZ2V0Lmxpc3QuY3VycmVudEl0ZW07XHJcbiAgICB9XHJcbiAgICBsZXQgcmVzdWx0ID0gbnVsbDtcclxuICAgIGlmIChwcm9wTmFtZS5pbmRleE9mKCcuJykgPT09IC0xKSB7XHJcbiAgICAgIHJlc3VsdCA9IHRhcmdldFtwcm9wTmFtZV07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCBwcm9wcyA9IHByb3BOYW1lLnNwbGl0KCcuJyk7XHJcbiAgICAgIGZvciAoY29uc3QgcHJvcCBvZiBwcm9wcykge1xyXG4gICAgICAgIHRhcmdldCA9IHJlc3VsdCA9IHRoaXMuZ2V0VmFsdWUodGFyZ2V0LCBwcm9wKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yu+6YCJ5Y+Y5YyW5LqL5Lu2XHJcbiAgICogQHBhcmFtIGV2ZW50XHJcbiAgICovXHJcbiAgQEhvc3RMaXN0ZW5lcignZlByZXZpZXdNdWx0aVNlbGVjdGVkRXZlbnQnLCBbJyRldmVudCddKVxyXG4gIHByaXZhdGUgY2hlY2tlZENoYW5nZWQoZXZlbnQ6IGFueVtdKSB7XHJcbiAgICBjb25zdCBwcmltYXJ5S2V5ID0gdGhpcy5iaW5kaW5nTGlzdC5wcmltYXJ5S2V5O1xyXG4gICAgY29uc3QgaWRzID0gZXZlbnQgJiYgZXZlbnQubWFwKChpdGVtKSA9PiBpdGVtICYmIGl0ZW0ub3JpZ2luYWxEYXRhICYmIGl0ZW0ub3JpZ2luYWxEYXRhW3ByaW1hcnlLZXldIHx8ICcnKS5maWx0ZXIocCA9PiBwKSB8fCBbXTtcclxuICAgIHRoaXMuc2V0Q2hlY2tzKGlkcyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOihjOWIh+aNouS6i+S7tlxyXG4gICAqIEBwYXJhbSBldmVudFxyXG4gICAqL1xyXG4gIEBIb3N0TGlzdGVuZXIoJ2ZTZWxlY3RlZEV2ZW50JywgWyckZXZlbnQnXSlcclxuICBwcml2YXRlIHNlbGVjdENoYW5nZWQoZXZlbnQ6IGFueSkge1xyXG5cclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IEZhcnJpc0ZpbGVQcmV2aWV3QmluZGluZ0RpcmVjdGl2ZSB9O1xyXG4iXX0=