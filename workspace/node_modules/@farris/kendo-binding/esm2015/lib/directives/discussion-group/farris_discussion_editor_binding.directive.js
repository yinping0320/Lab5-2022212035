import { Directive, Injector, Input, HostListener } from '@angular/core';
import { DiscussionEditorComponent } from '@farris/discussion-group';
import { ViewModel } from '@farris/devkit';
import { of, EMPTY } from 'rxjs';
import { tap, catchError } from 'rxjs/operators';
const KEY_UISTATE_REPLY_MESSAGE = 'DISCUSSION_REPLY_MESSAGE_INFO';
const KEY_MESSAGE_ON_COMMENT_ADD = 'onCommentAdd';
export class FarrisDiscussionEditorBindingDirective {
    constructor(injector, discussionEditorComponent, viewModel) {
        this.injector = injector;
        this.discussionEditorComponent = discussionEditorComponent;
        this.viewModel = viewModel;
    }
    ngOnInit() {
        this.discussionEditorComponent.replyUser = this.viewModel.frameContext.root.viewModel.uiState[KEY_UISTATE_REPLY_MESSAGE] || {};
        this.viewModel.frameContext.root.viewModel.uiState.changes.subscribe((change) => {
            if (change.field === KEY_UISTATE_REPLY_MESSAGE) {
                this.discussionEditorComponent.replyUser = this.viewModel.frameContext.root.viewModel.uiState[KEY_UISTATE_REPLY_MESSAGE] || {};
            }
        });
        if (this.queryFrequentAtUsersCommand) {
            this.queryFrequentAtUsers();
        }
        else {
            this.queryAtUsers();
        }
        this.queryAllOrgs();
    }
    /**
     * 查询所有部门数据
     */
    queryAllOrgs() {
        this.execute(this.queryAllOrgsCommand).subscribe(result => {
            if (!result) {
                return;
            }
            this.discussionEditorComponent.sectionData = result;
        });
    }
    /**
     * 获取@用户
     */
    queryAtUsers() {
        this.execute(this.userQueryCommand).subscribe(result => {
            if (!result) {
                return;
            }
            const { users = [] } = result;
            this.discussionEditorComponent.personnels = users;
        });
    }
    /**
     * 获取常用@用户
     */
    queryFrequentAtUsers() {
        this.execute(this.queryFrequentAtUsersCommand).subscribe(result => {
            if (!result) {
                return;
            }
            this.discussionEditorComponent.personnels = result && result.users || [];
        });
    }
    /**
     * 提交或取消评论
     * @param event event
     */
    pageChangedHandler(event) {
        const { msgInfo = 0, text = '', visibility = 'ALL', parentId = null } = event || {};
        if (msgInfo === 1) {
            this.execute(this.addCommentCommand, { text, parentId, visibility }).pipe(tap(() => {
                this.viewModel.frameContext.appContext.messagePipe.next(KEY_MESSAGE_ON_COMMENT_ADD);
            }), catchError(e => EMPTY)).subscribe();
        }
        else {
            // 取消的时候同时会将回复用户清空
            this.viewModel.frameContext.root.viewModel.uiState[KEY_UISTATE_REPLY_MESSAGE] = {};
            this.discussionEditorComponent.replyUser = {};
        }
    }
    /**
     * 执行命令
     * @param commandName 命令名称
     */
    execute(commandName, params) {
        if (!commandName || commandName === '' || commandName === 'undefined') {
            return of(null);
        }
        if (typeof params === 'undefined') {
            params = {};
        }
        const paths = commandName.split('.');
        let func = null;
        paths.forEach(path => {
            func = func && func[path] || this[path];
        });
        if (typeof func === 'function') {
            return func(params);
        }
        return of(null);
    }
}
FarrisDiscussionEditorBindingDirective.decorators = [
    { type: Directive, args: [{
                selector: '[farris-discussion-editor-binding]'
            },] }
];
/** @nocollapse */
FarrisDiscussionEditorBindingDirective.ctorParameters = () => [
    { type: Injector },
    { type: DiscussionEditorComponent },
    { type: ViewModel }
];
FarrisDiscussionEditorBindingDirective.propDecorators = {
    userQueryCommand: [{ type: Input, args: ["userQueryCommand",] }],
    addCommentCommand: [{ type: Input, args: ["addCommentCommand",] }],
    queryAllOrgsCommand: [{ type: Input, args: ["queryAllOrgsCommand",] }],
    queryFrequentAtUsersCommand: [{ type: Input, args: ["queryFrequentAtUsersCommand",] }],
    pageChangedHandler: [{ type: HostListener, args: ['valueChange', ['$event'],] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzX2Rpc2N1c3Npb25fZWRpdG9yX2JpbmRpbmcuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9rZW5kby1iaW5kaW5nLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZXMvZGlzY3Vzc2lvbi1ncm91cC9mYXJyaXNfZGlzY3Vzc2lvbl9lZGl0b3JfYmluZGluZy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFVLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNqRixPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNyRSxPQUFPLEVBQUUsU0FBUyxFQUEwQixNQUFNLGdCQUFnQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxFQUFFLEVBQWMsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzdDLE9BQU8sRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDakQsTUFBTSx5QkFBeUIsR0FBRywrQkFBK0IsQ0FBQztBQUNsRSxNQUFNLDBCQUEwQixHQUFHLGNBQWMsQ0FBQztBQUtsRCxNQUFNLE9BQU8sc0NBQXNDO0lBbUJqRCxZQUFtQixRQUFrQixFQUFTLHlCQUFvRCxFQUFTLFNBQW9CO1FBQTVHLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBUyw4QkFBeUIsR0FBekIseUJBQXlCLENBQTJCO1FBQVMsY0FBUyxHQUFULFNBQVMsQ0FBVztJQUMvSCxDQUFDO0lBRUQsUUFBUTtRQUNOLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMseUJBQXlCLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDL0gsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQThCLEVBQUUsRUFBRTtZQUN0RyxJQUFJLE1BQU0sQ0FBQyxLQUFLLEtBQUsseUJBQXlCLEVBQUU7Z0JBQzlDLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMseUJBQXlCLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDaEk7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksSUFBSSxDQUFDLDJCQUEyQixFQUFFO1lBQ3BDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1NBQzdCO2FBQU07WUFDTCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7U0FDckI7UUFFRCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDdEIsQ0FBQztJQUNEOztPQUVHO0lBQ0ssWUFBWTtRQUNsQixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN4RCxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNYLE9BQU87YUFDUjtZQUNELElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDO1FBQ3RELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNEOztPQUVHO0lBQ0ssWUFBWTtRQUNsQixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNyRCxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNYLE9BQU87YUFDUjtZQUNELE1BQU0sRUFBRSxLQUFLLEdBQUcsRUFBRSxFQUFFLEdBQUcsTUFBTSxDQUFDO1lBQzlCLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO1FBQ3BELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNEOztPQUVHO0lBQ0ssb0JBQW9CO1FBQzFCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ2hFLElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQ1gsT0FBTzthQUNSO1lBQ0QsSUFBSSxDQUFDLHlCQUF5QixDQUFDLFVBQVUsR0FBRyxNQUFNLElBQUksTUFBTSxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUM7UUFDM0UsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0Q7OztPQUdHO0lBRUksa0JBQWtCLENBQUMsS0FBVTtRQUNsQyxNQUFNLEVBQUUsT0FBTyxHQUFHLENBQUMsRUFBRSxJQUFJLEdBQUcsRUFBRSxFQUFFLFVBQVUsR0FBRyxLQUFLLEVBQUUsUUFBUSxHQUFHLElBQUksRUFBRSxHQUFHLEtBQUssSUFBSSxFQUFFLENBQUM7UUFDcEYsSUFBSSxPQUFPLEtBQUssQ0FBQyxFQUFFO1lBQ2pCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FDdkUsR0FBRyxDQUFDLEdBQUcsRUFBRTtnQkFDUCxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1lBQ3RGLENBQUMsQ0FBQyxFQUNGLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUN2QixDQUFDLFNBQVMsRUFBRSxDQUFDO1NBQ2Y7YUFBTTtZQUNMLGtCQUFrQjtZQUNsQixJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUNuRixJQUFJLENBQUMseUJBQXlCLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztTQUMvQztJQUNILENBQUM7SUFDRDs7O09BR0c7SUFDSyxPQUFPLENBQUMsV0FBbUIsRUFBRSxNQUFZO1FBQy9DLElBQUksQ0FBQyxXQUFXLElBQUksV0FBVyxLQUFLLEVBQUUsSUFBSSxXQUFXLEtBQUssV0FBVyxFQUFFO1lBQ3JFLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2pCO1FBQ0QsSUFBSSxPQUFPLE1BQU0sS0FBSyxXQUFXLEVBQUU7WUFDakMsTUFBTSxHQUFHLEVBQUUsQ0FBQztTQUNiO1FBQ0QsTUFBTSxLQUFLLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNyQyxJQUFJLElBQUksR0FBRyxJQUFJLENBQUM7UUFDaEIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNuQixJQUFJLEdBQUcsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDMUMsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLE9BQU8sSUFBSSxLQUFLLFVBQVUsRUFBRTtZQUM5QixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNyQjtRQUNELE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xCLENBQUM7OztZQWxIRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLG9DQUFvQzthQUMvQzs7OztZQVZtQixRQUFRO1lBQ25CLHlCQUF5QjtZQUN6QixTQUFTOzs7K0JBY2YsS0FBSyxTQUFDLGtCQUFrQjtnQ0FJeEIsS0FBSyxTQUFDLG1CQUFtQjtrQ0FJekIsS0FBSyxTQUFDLHFCQUFxQjswQ0FJM0IsS0FBSyxTQUFDLDZCQUE2QjtpQ0EwRG5DLFlBQVksU0FBQyxhQUFhLEVBQUUsQ0FBQyxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIEluamVjdG9yLCBJbnB1dCwgT25Jbml0LCBIb3N0TGlzdGVuZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRGlzY3Vzc2lvbkVkaXRvckNvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvZGlzY3Vzc2lvbi1ncm91cCc7XHJcbmltcG9ydCB7IFZpZXdNb2RlbCwgVUlTdGF0ZU9ic2VydmFibGVQYXJhbSB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgb2YsIE9ic2VydmFibGUsIEVNUFRZIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHRhcCwgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuY29uc3QgS0VZX1VJU1RBVEVfUkVQTFlfTUVTU0FHRSA9ICdESVNDVVNTSU9OX1JFUExZX01FU1NBR0VfSU5GTyc7XHJcbmNvbnN0IEtFWV9NRVNTQUdFX09OX0NPTU1FTlRfQUREID0gJ29uQ29tbWVudEFkZCc7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1tmYXJyaXMtZGlzY3Vzc2lvbi1lZGl0b3ItYmluZGluZ10nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBGYXJyaXNEaXNjdXNzaW9uRWRpdG9yQmluZGluZ0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlueUqOaIt+WRveS7pFxyXG4gICAqL1xyXG4gIEBJbnB1dChcInVzZXJRdWVyeUNvbW1hbmRcIikgdXNlclF1ZXJ5Q29tbWFuZDogc3RyaW5nO1xyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOivhOiuuuWRveS7pFxyXG4gICAqL1xyXG4gIEBJbnB1dChcImFkZENvbW1lbnRDb21tYW5kXCIpIGFkZENvbW1lbnRDb21tYW5kOiBzdHJpbmc7XHJcbiAgLyoqXHJcbiAgICog5p+l6K+i5omA5pyJ6YOo6Zeo5ZG95LukXHJcbiAgICovXHJcbiAgQElucHV0KFwicXVlcnlBbGxPcmdzQ29tbWFuZFwiKSBxdWVyeUFsbE9yZ3NDb21tYW5kOiBzdHJpbmc7XHJcbiAgLyoqXHJcbiAgICog5p+l6K+i5bi455SoQOeUqOaIt1xyXG4gICAqL1xyXG4gIEBJbnB1dChcInF1ZXJ5RnJlcXVlbnRBdFVzZXJzQ29tbWFuZFwiKSBxdWVyeUZyZXF1ZW50QXRVc2Vyc0NvbW1hbmQ6IHN0cmluZztcclxuXHJcbiAgY29uc3RydWN0b3IocHVibGljIGluamVjdG9yOiBJbmplY3RvciwgcHVibGljIGRpc2N1c3Npb25FZGl0b3JDb21wb25lbnQ6IERpc2N1c3Npb25FZGl0b3JDb21wb25lbnQsIHB1YmxpYyB2aWV3TW9kZWw6IFZpZXdNb2RlbCkge1xyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLmRpc2N1c3Npb25FZGl0b3JDb21wb25lbnQucmVwbHlVc2VyID0gdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LnJvb3Qudmlld01vZGVsLnVpU3RhdGVbS0VZX1VJU1RBVEVfUkVQTFlfTUVTU0FHRV0gfHwge307XHJcbiAgICB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQucm9vdC52aWV3TW9kZWwudWlTdGF0ZS5jaGFuZ2VzLnN1YnNjcmliZSgoY2hhbmdlOiBVSVN0YXRlT2JzZXJ2YWJsZVBhcmFtKSA9PiB7XHJcbiAgICAgIGlmIChjaGFuZ2UuZmllbGQgPT09IEtFWV9VSVNUQVRFX1JFUExZX01FU1NBR0UpIHtcclxuICAgICAgICB0aGlzLmRpc2N1c3Npb25FZGl0b3JDb21wb25lbnQucmVwbHlVc2VyID0gdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LnJvb3Qudmlld01vZGVsLnVpU3RhdGVbS0VZX1VJU1RBVEVfUkVQTFlfTUVTU0FHRV0gfHwge307XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgaWYgKHRoaXMucXVlcnlGcmVxdWVudEF0VXNlcnNDb21tYW5kKSB7XHJcbiAgICAgIHRoaXMucXVlcnlGcmVxdWVudEF0VXNlcnMoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMucXVlcnlBdFVzZXJzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5xdWVyeUFsbE9yZ3MoKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p+l6K+i5omA5pyJ6YOo6Zeo5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBxdWVyeUFsbE9yZ3MoKSB7XHJcbiAgICB0aGlzLmV4ZWN1dGUodGhpcy5xdWVyeUFsbE9yZ3NDb21tYW5kKS5zdWJzY3JpYmUocmVzdWx0ID0+IHtcclxuICAgICAgaWYgKCFyZXN1bHQpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5kaXNjdXNzaW9uRWRpdG9yQ29tcG9uZW50LnNlY3Rpb25EYXRhID0gcmVzdWx0O1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlkDnlKjmiLdcclxuICAgKi9cclxuICBwcml2YXRlIHF1ZXJ5QXRVc2VycygpIHtcclxuICAgIHRoaXMuZXhlY3V0ZSh0aGlzLnVzZXJRdWVyeUNvbW1hbmQpLnN1YnNjcmliZShyZXN1bHQgPT4ge1xyXG4gICAgICBpZiAoIXJlc3VsdCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCB7IHVzZXJzID0gW10gfSA9IHJlc3VsdDtcclxuICAgICAgdGhpcy5kaXNjdXNzaW9uRWRpdG9yQ29tcG9uZW50LnBlcnNvbm5lbHMgPSB1c2VycztcclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bluLjnlKhA55So5oi3XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBxdWVyeUZyZXF1ZW50QXRVc2VycygpIHtcclxuICAgIHRoaXMuZXhlY3V0ZSh0aGlzLnF1ZXJ5RnJlcXVlbnRBdFVzZXJzQ29tbWFuZCkuc3Vic2NyaWJlKHJlc3VsdCA9PiB7XHJcbiAgICAgIGlmICghcmVzdWx0KSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuZGlzY3Vzc2lvbkVkaXRvckNvbXBvbmVudC5wZXJzb25uZWxzID0gcmVzdWx0ICYmIHJlc3VsdC51c2VycyB8fCBbXTtcclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmj5DkuqTmiJblj5bmtojor4TorrpcclxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcclxuICAgKi9cclxuICBASG9zdExpc3RlbmVyKCd2YWx1ZUNoYW5nZScsIFsnJGV2ZW50J10pXHJcbiAgcHVibGljIHBhZ2VDaGFuZ2VkSGFuZGxlcihldmVudDogYW55KSB7XHJcbiAgICBjb25zdCB7IG1zZ0luZm8gPSAwLCB0ZXh0ID0gJycsIHZpc2liaWxpdHkgPSAnQUxMJywgcGFyZW50SWQgPSBudWxsIH0gPSBldmVudCB8fCB7fTtcclxuICAgIGlmIChtc2dJbmZvID09PSAxKSB7XHJcbiAgICAgIHRoaXMuZXhlY3V0ZSh0aGlzLmFkZENvbW1lbnRDb21tYW5kLCB7IHRleHQsIHBhcmVudElkLCB2aXNpYmlsaXR5IH0pLnBpcGUoXHJcbiAgICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICAgIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0Lm1lc3NhZ2VQaXBlLm5leHQoS0VZX01FU1NBR0VfT05fQ09NTUVOVF9BREQpO1xyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIGNhdGNoRXJyb3IoZSA9PiBFTVBUWSlcclxuICAgICAgKS5zdWJzY3JpYmUoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIOWPlua2iOeahOaXtuWAmeWQjOaXtuS8muWwhuWbnuWkjeeUqOaIt+a4heepulxyXG4gICAgICB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQucm9vdC52aWV3TW9kZWwudWlTdGF0ZVtLRVlfVUlTVEFURV9SRVBMWV9NRVNTQUdFXSA9IHt9O1xyXG4gICAgICB0aGlzLmRpc2N1c3Npb25FZGl0b3JDb21wb25lbnQucmVwbHlVc2VyID0ge307XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJp+ihjOWRveS7pFxyXG4gICAqIEBwYXJhbSBjb21tYW5kTmFtZSDlkb3ku6TlkI3np7BcclxuICAgKi9cclxuICBwcml2YXRlIGV4ZWN1dGUoY29tbWFuZE5hbWU6IHN0cmluZywgcGFyYW1zPzogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmICghY29tbWFuZE5hbWUgfHwgY29tbWFuZE5hbWUgPT09ICcnIHx8IGNvbW1hbmROYW1lID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICByZXR1cm4gb2YobnVsbCk7XHJcbiAgICB9XHJcbiAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgcGFyYW1zID0ge307XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXRocyA9IGNvbW1hbmROYW1lLnNwbGl0KCcuJyk7XHJcbiAgICBsZXQgZnVuYyA9IG51bGw7XHJcbiAgICBwYXRocy5mb3JFYWNoKHBhdGggPT4ge1xyXG4gICAgICBmdW5jID0gZnVuYyAmJiBmdW5jW3BhdGhdIHx8IHRoaXNbcGF0aF07XHJcbiAgICB9KTtcclxuICAgIGlmICh0eXBlb2YgZnVuYyA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICByZXR1cm4gZnVuYyhwYXJhbXMpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG9mKG51bGwpO1xyXG4gIH1cclxufVxyXG4iXX0=