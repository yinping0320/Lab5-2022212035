import { isNumber } from 'lodash-es';
/**
 * 帮助映射基类
 */
export class DataMapping {
    constructor() {
        /**
         * 多选帮助默认分隔符
         */
        this.defaultSpliter = ',';
    }
    /**
     * 映射数据
     * @param helpData 清空时，值为null
     * @param mapFields 格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"}
     * @param asClear 类似清空
     * @param [spliter=','] 多选分隔符
     */
    mappingData(helpData, mapFields, asClear = false, spliter = ',') {
        if (!mapFields) {
            return;
        }
        // 关闭变更检测
        const appContext = this.vm.frameContext.appContext;
        appContext.changeDetectionController.detach();
        let helpFields = Object.keys(mapFields);
        const basePaths = this.getBindingPathArray();
        const primaryInfo = this.getMapFieldsPrimaryKey(mapFields, basePaths);
        // 映射到目标主键的源字段数组
        const primaryKeys = primaryInfo && primaryInfo.map((item) => item.primaryKey) || [];
        // 目标主键字段数组
        const primaryFields = primaryInfo && primaryInfo.map((item) => item.primaryField) || [];
        // 对映射中的key进行排序，使映射到目标主键的key排到前面
        helpFields = this.sortMapFieldKeys(helpFields, primaryKeys);
        if (!helpData || asClear) {
            helpFields.reverse();
        }
        this.mapping(helpFields, mapFields, helpData, primaryFields, basePaths, asClear, spliter);
        // 重新打开变更检测
        appContext.changeDetectionController.reattach();
    }
    mapping(sortedKeyFields, mapFields, helpData, targetPrimaryFields, basePaths, asClear = false, spliter = ',') {
        sortedKeyFields.forEach((field) => {
            const val = this.getHelpValue(field, helpData, spliter);
            let mappings = mapFields[field].split(',');
            const headMappings = mappings.filter((p) => targetPrimaryFields.includes(p));
            const leftMappings = mappings.filter((p) => !targetPrimaryFields.includes(p));
            if (!helpData || asClear) {
                mappings = [].concat(leftMappings).concat(headMappings);
            }
            else {
                mappings = [].concat(headMappings).concat(leftMappings);
            }
            this.updateTarget(mappings, basePaths, helpData, val);
        });
    }
    updateTarget(mappings, basePaths, helpData, value) {
        mappings.forEach((targetFieldPath) => {
            this.updateTargetValue(basePaths, targetFieldPath, value, helpData);
        });
    }
    updateTargetValue(basePaths, targetFieldPath, value, helpData) {
        if (this.target) {
            const paths = targetFieldPath.split('.');
            this.setValue(this.target, paths, value);
        }
        else {
            const paths = basePaths.concat(targetFieldPath.split('.'));
            if (!helpData) {
                this.vm.bindingData.clearValue(paths, true, true, { frameContext: this.vm.frameContext });
            }
            else {
                this.vm.bindingData.setValue(paths, value, true, true, null, { frameContext: this.vm.frameContext });
            }
        }
    }
    /**
     * 获取帮助字段对应的值
     * @param field 帮助字段
     * @param helpData 帮助数据
     * @param [spliter=','] 多选帮助分隔符
     * @returns
     */
    getHelpValue(field, helpData, spliter = ',') {
        let value = '';
        if (helpData) {
            if (helpData instanceof Array) {
                value = helpData.map((item) => {
                    return this.getValue(field, item);
                }).join(spliter);
            }
            else {
                value = this.getValue(field, helpData);
            }
        }
        return value;
    }
    getValue(f, data) {
        let val = '';
        if (f.indexOf('.') === -1) {
            val = data[f];
        }
        else {
            val = f.split('.').reduce((a, b) => {
                return a[b];
            }, data);
        }
        return val;
    }
    setValue(target, paths, value) {
        if (target) {
            if (paths.length <= 1) {
                target[paths[0]] = value;
            }
            else {
                paths.slice(0, -1).reduce((prev, path) => {
                    if (!(prev.hasOwnProperty(path) || prev['__proto__'].hasOwnProperty(path))) {
                        prev[path] = {};
                    }
                    return prev[path];
                }, target)[paths[paths.length - 1]] = value;
            }
        }
    }
    getBindingPathArray() {
        const path = this.vm.bindingPath;
        if (path) {
            return path.split('/').filter((n) => n !== '');
        }
        return [];
    }
    isNumberValue(field, data) {
        const currentVal = this.getValue(field, data);
        return isNumber(currentVal);
    }
    /**
     *
     * @param mapFields  格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"} 或者 {id:'vid',code:'code',name:'name'}
     */
    getMapFieldsPrimaryKey(mapFields, bindingPaths) {
        if (!mapFields || Object.keys(mapFields).length < 1) {
            return null;
        }
        const results = [];
        // let primaryField = null;
        try {
            const entityTypeInfo = this.vm.frameContext.repository.entityTypeInfo;
            Object.keys(mapFields).forEach((key) => {
                const mapField = mapFields[key];
                if (mapField && typeof mapField === 'string') {
                    const mappings = mapField.split(',').filter((p) => p);
                    mappings.forEach((item) => {
                        let paths = item.split('.');
                        if (bindingPaths && bindingPaths.length > 0) {
                            paths = bindingPaths.concat(paths);
                        }
                        const propInfo = entityTypeInfo.getPropInfoByPath(paths);
                        if (propInfo && propInfo.metadataInfo && propInfo.metadataInfo.primary === true) {
                            results.push({
                                primaryKey: key,
                                primaryField: item
                            });
                        }
                    });
                }
            });
        }
        catch (e) {
            console.error(e);
        }
        return results;
    }
    sortMapFieldKeys(keys, primaryKeys) {
        if (!primaryKeys || primaryKeys.length < 1 || !keys || keys.length < 1) {
            return keys;
        }
        primaryKeys = [...new Set(primaryKeys)];
        // 过滤出非主键映射字段
        keys = keys.filter((p) => !primaryKeys.includes(p));
        return [].concat(primaryKeys).concat(keys);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1tYXBwaW5nLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9rZW5kby1iaW5kaW5nLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZXMvZGF0YS1tYXBwaW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDckM7O0dBRUc7QUFDSCxNQUFNLE9BQU8sV0FBVztJQUF4QjtRQUdFOztXQUVHO1FBQ2dCLG1CQUFjLEdBQUcsR0FBRyxDQUFDO0lBc0sxQyxDQUFDO0lBcktDOzs7Ozs7T0FNRztJQUNILFdBQVcsQ0FBQyxRQUFhLEVBQUUsU0FBYyxFQUFFLFVBQW1CLEtBQUssRUFBRSxVQUFrQixHQUFHO1FBQ3hGLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDZCxPQUFPO1NBQ1I7UUFDRCxTQUFTO1FBQ1QsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDO1FBQ25ELFVBQVUsQ0FBQyx5QkFBeUIsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUM5QyxJQUFJLFVBQVUsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3hDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBQzdDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDdEUsZ0JBQWdCO1FBQ2hCLE1BQU0sV0FBVyxHQUFhLFdBQVcsSUFBSSxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzlGLFdBQVc7UUFDWCxNQUFNLGFBQWEsR0FBYSxXQUFXLElBQUksV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFD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d0JBQ0QsTUFBTSxRQUFRLEdBQWlCLGNBQWMsQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQzt3QkFDdkUsSUFBSSxRQUFRLElBQUksUUFBUSxDQUFDLFlBQVksSUFBSSxRQUFRLENBQUMsWUFBWSxDQUFDLE9BQU8sS0FBSyxJQUFJLEVBQUU7NEJBQy9FLE9BQU8sQ0FBQyxJQUFJLENBQUM7Z0NBQ1gsVUFBVSxFQUFFLEdBQUc7Z0NBQ2YsWUFBWSxFQUFFLElBQUk7NkJBQ25CLENBQUMsQ0FBQzt5QkFDSjtvQkFDSCxDQUFDLENBQUMsQ0FBQztpQkFDSjtZQUNILENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNWLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDbEI7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBQ08sZ0JBQWdCLENBQUMsSUFBYyxFQUFFLFdBQXFCO1FBQzVELElBQUksQ0FBQyxXQUFXLElBQUksV0FBVyxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDdEUsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELFdBQVcsR0FBRyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztRQUN4QyxhQUFhO1FBQ2IsSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BELE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDN0MsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmluZGluZ09iamVjdCwgRGF0YVByb3BJbmZvLCBEYXRhVHlwZUluZm8sIFZpZXdNb2RlbCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgaXNOdW1iZXIgfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG4vKipcclxuICog5biu5Yqp5pig5bCE5Z+657G7XHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgRGF0YU1hcHBpbmcge1xyXG4gIHB1YmxpYyB2bTogVmlld01vZGVsO1xyXG4gIHB1YmxpYyB0YXJnZXQ6IEJpbmRpbmdPYmplY3Q7XHJcbiAgLyoqXHJcbiAgICog5aSa6YCJ5biu5Yqp6buY6K6k5YiG6ZqU56ymXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGRlZmF1bHRTcGxpdGVyID0gJywnO1xyXG4gIC8qKlxyXG4gICAqIOaYoOWwhOaVsOaNrlxyXG4gICAqIEBwYXJhbSBoZWxwRGF0YSDmuIXnqbrml7bvvIzlgLzkuLpudWxsXHJcbiAgICogQHBhcmFtIG1hcEZpZWxkcyDmoLzlvI/lvaLlpoLvvJp7aWQ6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZFwiLCBjb2RlOiBcImFzc29GaWVsZC5hc3NvRmllbGRfQ29kZVwiLCBuYW1lOiBcImFzc29GaWVsZC5hc3NvRmllbGRfTmFtZVwifVxyXG4gICAqIEBwYXJhbSBhc0NsZWFyIOexu+S8vOa4heepulxyXG4gICAqIEBwYXJhbSBbc3BsaXRlcj0nLCddIOWkmumAieWIhumalOesplxyXG4gICAqL1xyXG4gIG1hcHBpbmdEYXRhKGhlbHBEYXRhOiBhbnksIG1hcEZpZWxkczogYW55LCBhc0NsZWFyOiBib29sZWFuID0gZmFsc2UsIHNwbGl0ZXI6IHN0cmluZyA9ICcsJykge1xyXG4gICAgaWYgKCFtYXBGaWVsZHMpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgLy8g5YWz6Zet5Y+Y5pu05qOA5rWLXHJcbiAgICBjb25zdCBhcHBDb250ZXh0ID0gdGhpcy52bS5mcmFtZUNvbnRleHQuYXBwQ29udGV4dDtcclxuICAgIGFwcENvbnRleHQuY2hhbmdlRGV0ZWN0aW9uQ29udHJvbGxlci5kZXRhY2goKTtcclxuICAgIGxldCBoZWxwRmllbGRzID0gT2JqZWN0LmtleXMobWFwRmllbGRzKTtcclxuICAgIGNvbnN0IGJhc2VQYXRocyA9IHRoaXMuZ2V0QmluZGluZ1BhdGhBcnJheSgpO1xyXG4gICAgY29uc3QgcHJpbWFyeUluZm8gPSB0aGlzLmdldE1hcEZpZWxkc1ByaW1hcnlLZXkobWFwRmllbGRzLCBiYXNlUGF0aHMpO1xyXG4gICAgLy8g5pig5bCE5Yiw55uu5qCH5Li76ZSu55qE5rqQ5a2X5q615pWw57uEXHJcbiAgICBjb25zdCBwcmltYXJ5S2V5czogc3RyaW5nW10gPSBwcmltYXJ5SW5mbyAmJiBwcmltYXJ5SW5mby5tYXAoKGl0ZW0pID0+IGl0ZW0ucHJpbWFyeUtleSkgfHwgW107XHJcbiAgICAvLyDnm67moIfkuLvplK7lrZfmrrXmlbDnu4RcclxuICAgIGNvbnN0IHByaW1hcnlGaWVsZHM6IHN0cmluZ1tdID0gcHJpbWFyeUluZm8gJiYgcHJpbWFyeUluZm8ubWFwKChpdGVtKSA9PiBpdGVtLnByaW1hcnlGaWVsZCkgfHwgW107XHJcbiAgICAvLyDlr7nmmKDlsITkuK3nmoRrZXnov5vooYzmjpLluo/vvIzkvb/mmKDlsITliLDnm67moIfkuLvplK7nmoRrZXnmjpLliLDliY3pnaJcclxuICAgIGhlbHBGaWVsZHMgPSB0aGlzLnNvcnRNYXBGaWVsZEtleXMoaGVscEZpZWxkcywgcHJpbWFyeUtleXMpO1xyXG4gICAgaWYgKCFoZWxwRGF0YSB8fCBhc0NsZWFyKSB7XHJcbiAgICAgIGhlbHBGaWVsZHMucmV2ZXJzZSgpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5tYXBwaW5nKGhlbHBGaWVsZHMsIG1hcEZpZWxkcywgaGVscERhdGEsIHByaW1hcnlGaWVsZHMsIGJhc2VQYXRocywgYXNDbGVhciwgc3BsaXRlcik7XHJcbiAgICAvLyDph43mlrDmiZPlvIDlj5jmm7Tmo4DmtYtcclxuICAgIGFwcENvbnRleHQuY2hhbmdlRGV0ZWN0aW9uQ29udHJvbGxlci5yZWF0dGFjaCgpO1xyXG4gIH1cclxuICBwcml2YXRlIG1hcHBpbmcoc29ydGVkS2V5RmllbGRzOiBzdHJpbmdbXSwgbWFwRmllbGRzOiBhbnksIGhlbHBEYXRhOiBhbnksIHRhcmdldFByaW1hcnlGaWVsZHM6IHN0cmluZ1tdLCBiYXNlUGF0aHM6IHN0cmluZ1tdLCBhc0NsZWFyOiBib29sZWFuID0gZmFsc2UsIHNwbGl0ZXIgPSAnLCcpIHtcclxuICAgIHNvcnRlZEtleUZpZWxkcy5mb3JFYWNoKChmaWVsZDogYW55KSA9PiB7XHJcbiAgICAgIGNvbnN0IHZhbCA9IHRoaXMuZ2V0SGVscFZhbHVlKGZpZWxkLCBoZWxwRGF0YSwgc3BsaXRlcik7XHJcbiAgICAgIGxldCBtYXBwaW5nczogYW55W10gPSBtYXBGaWVsZHNbZmllbGRdLnNwbGl0KCcsJyk7XHJcbiAgICAgIGNvbnN0IGhlYWRNYXBwaW5ncyA9IG1hcHBpbmdzLmZpbHRlcigocCkgPT4gdGFyZ2V0UHJpbWFyeUZpZWxkcy5pbmNsdWRlcyhwKSk7XHJcbiAgICAgIGNvbnN0IGxlZnRNYXBwaW5ncyA9IG1hcHBpbmdzLmZpbHRlcigocCkgPT4gIXRhcmdldFByaW1hcnlGaWVsZHMuaW5jbHVkZXMocCkpO1xyXG4gICAgICBpZiAoIWhlbHBEYXRhIHx8IGFzQ2xlYXIpIHtcclxuICAgICAgICBtYXBwaW5ncyA9IFtdLmNvbmNhdChsZWZ0TWFwcGluZ3MpLmNvbmNhdChoZWFkTWFwcGluZ3MpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIG1hcHBpbmdzID0gW10uY29uY2F0KGhlYWRNYXBwaW5ncykuY29uY2F0KGxlZnRNYXBwaW5ncyk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy51cGRhdGVUYXJnZXQobWFwcGluZ3MsIGJhc2VQYXRocywgaGVscERhdGEsIHZhbCk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHJpdmF0ZSB1cGRhdGVUYXJnZXQobWFwcGluZ3M6IHN0cmluZ1tdLCBiYXNlUGF0aHM6IHN0cmluZ1tdLCBoZWxwRGF0YTogYW55LCB2YWx1ZTogYW55KSB7XHJcbiAgICBtYXBwaW5ncy5mb3JFYWNoKCh0YXJnZXRGaWVsZFBhdGg6IGFueSkgPT4ge1xyXG4gICAgICB0aGlzLnVwZGF0ZVRhcmdldFZhbHVlKGJhc2VQYXRocywgdGFyZ2V0RmllbGRQYXRoLCB2YWx1ZSwgaGVscERhdGEpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgdXBkYXRlVGFyZ2V0VmFsdWUoYmFzZVBhdGhzOiBzdHJpbmdbXSwgdGFyZ2V0RmllbGRQYXRoLCB2YWx1ZTogYW55LCBoZWxwRGF0YTogYW55KSB7XHJcbiAgICBpZiAodGhpcy50YXJnZXQpIHtcclxuICAgICAgY29uc3QgcGF0aHMgPSB0YXJnZXRGaWVsZFBhdGguc3BsaXQoJy4nKTtcclxuICAgICAgdGhpcy5zZXRWYWx1ZSh0aGlzLnRhcmdldCwgcGF0aHMsIHZhbHVlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IHBhdGhzID0gYmFzZVBhdGhzLmNvbmNhdCh0YXJnZXRGaWVsZFBhdGguc3BsaXQoJy4nKSk7XHJcbiAgICAgIGlmICghaGVscERhdGEpIHtcclxuICAgICAgICB0aGlzLnZtLmJpbmRpbmdEYXRhLmNsZWFyVmFsdWUocGF0aHMsIHRydWUsIHRydWUsIHsgZnJhbWVDb250ZXh0OiB0aGlzLnZtLmZyYW1lQ29udGV4dCB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLnZtLmJpbmRpbmdEYXRhLnNldFZhbHVlKHBhdGhzLCB2YWx1ZSwgdHJ1ZSwgdHJ1ZSwgbnVsbCwgeyBmcmFtZUNvbnRleHQ6IHRoaXMudm0uZnJhbWVDb250ZXh0IH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluW4ruWKqeWtl+auteWvueW6lOeahOWAvFxyXG4gICAqIEBwYXJhbSBmaWVsZCDluK7liqnlrZfmrrVcclxuICAgKiBAcGFyYW0gaGVscERhdGEg5biu5Yqp5pWw5o2uXHJcbiAgICogQHBhcmFtIFtzcGxpdGVyPScsJ10g5aSa6YCJ5biu5Yqp5YiG6ZqU56ymXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwcml2YXRlIGdldEhlbHBWYWx1ZShmaWVsZDogc3RyaW5nLCBoZWxwRGF0YTogYW55LCBzcGxpdGVyID0gJywnKSB7XHJcbiAgICBsZXQgdmFsdWU6IGFueSA9ICcnO1xyXG4gICAgaWYgKGhlbHBEYXRhKSB7XHJcbiAgICAgIGlmIChoZWxwRGF0YSBpbnN0YW5jZW9mIEFycmF5KSB7XHJcbiAgICAgICAgdmFsdWUgPSBoZWxwRGF0YS5tYXAoKGl0ZW06IGFueSkgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VmFsdWUoZmllbGQsIGl0ZW0pO1xyXG4gICAgICAgIH0pLmpvaW4oc3BsaXRlcik7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdmFsdWUgPSB0aGlzLmdldFZhbHVlKGZpZWxkLCBoZWxwRGF0YSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB2YWx1ZTtcclxuICB9XHJcbiAgcHJvdGVjdGVkIGdldFZhbHVlKGY6IHN0cmluZywgZGF0YTogYW55KSB7XHJcbiAgICBsZXQgdmFsID0gJyc7XHJcbiAgICBpZiAoZi5pbmRleE9mKCcuJykgPT09IC0xKSB7XHJcbiAgICAgIHZhbCA9IGRhdGFbZl07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB2YWwgPSBmLnNwbGl0KCcuJykucmVkdWNlKChhLCBiKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGFbYl07XHJcbiAgICAgIH0sIGRhdGEpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB2YWw7XHJcbiAgfVxyXG4gIHByb3RlY3RlZCBzZXRWYWx1ZSh0YXJnZXQ6IG9iamVjdCwgcGF0aHM6IHN0cmluZ1tdLCB2YWx1ZTogYW55KSB7XHJcbiAgICBpZiAodGFyZ2V0KSB7XHJcbiAgICAgIGlmIChwYXRocy5sZW5ndGggPD0gMSkge1xyXG4gICAgICAgIHRhcmdldFtwYXRoc1swXV0gPSB2YWx1ZTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBwYXRocy5zbGljZSgwLCAtMSkucmVkdWNlKChwcmV2LCBwYXRoKSA9PiB7XHJcbiAgICAgICAgICBpZiAoIShwcmV2Lmhhc093blByb3BlcnR5KHBhdGgpIHx8IHByZXZbJ19fcHJvdG9fXyddLmhhc093blByb3BlcnR5KHBhdGgpKSkge1xyXG4gICAgICAgICAgICBwcmV2W3BhdGhdID0ge307XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gcHJldltwYXRoXTtcclxuICAgICAgICB9LCB0YXJnZXQpW3BhdGhzW3BhdGhzLmxlbmd0aCAtIDFdXSA9IHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0QmluZGluZ1BhdGhBcnJheSgpOiBhbnlbXSB7XHJcbiAgICBjb25zdCBwYXRoID0gdGhpcy52bS5iaW5kaW5nUGF0aDtcclxuICAgIGlmIChwYXRoKSB7XHJcbiAgICAgIHJldHVybiBwYXRoLnNwbGl0KCcvJykuZmlsdGVyKChuKSA9PiBuICE9PSAnJyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gW107XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGlzTnVtYmVyVmFsdWUoZmllbGQsIGRhdGEpIHtcclxuICAgIGNvbnN0IGN1cnJlbnRWYWwgPSB0aGlzLmdldFZhbHVlKGZpZWxkLCBkYXRhKTtcclxuICAgIHJldHVybiBpc051bWJlcihjdXJyZW50VmFsKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICpcclxuICAgKiBAcGFyYW0gbWFwRmllbGRzICDmoLzlvI/lvaLlpoLvvJp7aWQ6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZFwiLCBjb2RlOiBcImFzc29GaWVsZC5hc3NvRmllbGRfQ29kZVwiLCBuYW1lOiBcImFzc29GaWVsZC5hc3NvRmllbGRfTmFtZVwifSDmiJbogIUge2lkOid2aWQnLGNvZGU6J2NvZGUnLG5hbWU6J25hbWUnfVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0TWFwRmllbGRzUHJpbWFyeUtleShtYXBGaWVsZHM6IGFueSwgYmluZGluZ1BhdGhzOiBzdHJpbmdbXSk6IEFycmF5PHsgcHJpbWFyeUtleTogc3RyaW5nLCBwcmltYXJ5RmllbGQ6IHN0cmluZyB9PiB7XHJcbiAgICBpZiAoIW1hcEZpZWxkcyB8fCBPYmplY3Qua2V5cyhtYXBGaWVsZHMpLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXN1bHRzID0gW107XHJcbiAgICAvLyBsZXQgcHJpbWFyeUZpZWxkID0gbnVsbDtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8gPSB0aGlzLnZtLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvO1xyXG4gICAgICBPYmplY3Qua2V5cyhtYXBGaWVsZHMpLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgY29uc3QgbWFwRmllbGQgPSBtYXBGaWVsZHNba2V5XTtcclxuICAgICAgICBpZiAobWFwRmllbGQgJiYgdHlwZW9mIG1hcEZpZWxkID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgY29uc3QgbWFwcGluZ3MgPSBtYXBGaWVsZC5zcGxpdCgnLCcpLmZpbHRlcigocCkgPT4gcCk7XHJcbiAgICAgICAgICBtYXBwaW5ncy5mb3JFYWNoKChpdGVtOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgbGV0IHBhdGhzID0gaXRlbS5zcGxpdCgnLicpO1xyXG4gICAgICAgICAgICBpZiAoYmluZGluZ1BhdGhzICYmIGJpbmRpbmdQYXRocy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgcGF0aHMgPSBiaW5kaW5nUGF0aHMuY29uY2F0KHBhdGhzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBwcm9wSW5mbzogRGF0YVByb3BJbmZvID0gZW50aXR5VHlwZUluZm8uZ2V0UHJvcEluZm9CeVBhdGgocGF0aHMpO1xyXG4gICAgICAgICAgICBpZiAocHJvcEluZm8gJiYgcHJvcEluZm8ubWV0YWRhdGFJbmZvICYmIHByb3BJbmZvLm1ldGFkYXRhSW5mby5wcmltYXJ5ID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHtcclxuICAgICAgICAgICAgICAgIHByaW1hcnlLZXk6IGtleSxcclxuICAgICAgICAgICAgICAgIHByaW1hcnlGaWVsZDogaXRlbVxyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICBjb25zb2xlLmVycm9yKGUpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdHM7XHJcbiAgfVxyXG4gIHByaXZhdGUgc29ydE1hcEZpZWxkS2V5cyhrZXlzOiBzdHJpbmdbXSwgcHJpbWFyeUtleXM6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xyXG4gICAgaWYgKCFwcmltYXJ5S2V5cyB8fCBwcmltYXJ5S2V5cy5sZW5ndGggPCAxIHx8ICFrZXlzIHx8IGtleXMubGVuZ3RoIDwgMSkge1xyXG4gICAgICByZXR1cm4ga2V5cztcclxuICAgIH1cclxuICAgIHByaW1hcnlLZXlzID0gWy4uLm5ldyBTZXQocHJpbWFyeUtleXMpXTtcclxuICAgIC8vIOi/h+a7pOWHuumdnuS4u+mUruaYoOWwhOWtl+autVxyXG4gICAga2V5cyA9IGtleXMuZmlsdGVyKChwKSA9PiAhcHJpbWFyeUtleXMuaW5jbHVkZXMocCkpO1xyXG4gICAgcmV0dXJuIFtdLmNvbmNhdChwcmltYXJ5S2V5cykuY29uY2F0KGtleXMpO1xyXG4gIH1cclxufVxyXG4iXX0=