/**
 * 使用方法：
 * [comob-lookup-data-mapping]="{ id: 'user.userId', name: 'user.userName' }"
 * key 为帮助上的字段， value 为 表单中的字段名
 * 帮助上的同一个字段可以映射到表单中的多个字段中，{ ... id: 'user.userid, user.addusid'}
 * 多字段以逗号隔开
 *
 */
import { Directive, Optional, Self, Input } from '@angular/core';
import { BindingObject, ViewModel } from '@farris/devkit';
import { ComboLookupComponent } from '@farris/ui-combo-lookup';
import { DataMapping } from './data-mapping';
export class ComboLookupDataMappingDirective extends DataMapping {
    constructor(vm, lookup) {
        super();
        this.vm = vm;
        this.lookup = lookup;
        this.target = null;
        if (this.lookup) {
            this.lookup.useFormDataMapping = true;
        }
    }
    ngOnInit() {
        // 值变化，亦通过该事件触发任意输入清空事件
        this.lookup.valueChange.subscribe((result) => {
            if (!result['nosearch']) {
                // 值变化
                const data = result.selections && result.selections.length > 0 ? result.selections : null;
                this.onValueChange(data);
            }
            else {
                // 任意输入清空映射字段
                this.onClearMapping();
            }
        });
        // 清空事件
        this.lookup.clear.subscribe(() => {
            const _mapfields = this.mapfields || this.lookup.mapFields;
            this.mappingData(null, _mapfields);
        });
    }
    onClearMapping() {
        const mapfields = Object.assign({}, (this.mapfields || this.lookup.mapFields || {}));
        const lookupTextField = this.lookup.textField;
        const data = {};
        const controlName = this.lookup.ngControl && this.lookup.ngControl.name;
        if (controlName && this.vm) {
            const textFieldMapping = mapfields[lookupTextField];
            const ngFormControl = this.vm && this.vm.form && this.vm.form.ngFormControls && this.vm.form.ngFormControls[controlName];
            const binding = ngFormControl && ngFormControl.binding;
            if (textFieldMapping && binding) {
                const targetField = textFieldMapping.split(',').filter((item) => item !== binding).join(',');
                if (targetField) {
                    mapfields[lookupTextField] = targetField;
                }
                else {
                    delete mapfields[lookupTextField];
                }
            }
        }
        if (mapfields && Object.keys(mapfields).length > 0) {
            Object.keys(mapfields).forEach((field) => {
                this.setValue(data, field.split('.'), '');
            });
            this.mappingData(data, mapfields, true);
        }
    }
    onValueChange(data) {
        const _mapfields = this.mapfields || this.lookup.mapFields;
        const spliter = this.lookup.separator || this.defaultSpliter;
        this.mappingData(data, _mapfields, false, spliter);
    }
}
ComboLookupDataMappingDirective.decorators = [
    { type: Directive, args: [{ selector: '[combo-lookup-data-mapping]' },] }
];
/** @nocollapse */
ComboLookupDataMappingDirective.ctorParameters = () => [
    { type: ViewModel, decorators: [{ type: Optional }] },
    { type: ComboLookupComponent, decorators: [{ type: Optional }, { type: Self }] }
];
ComboLookupDataMappingDirective.propDecorators = {
    mapfields: [{ type: Input, args: ['combo-lookup-data-mapping',] }],
    target: [{ type: Input, args: ['target',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tYm8tbG9va3VwLWRhdGEtbWFwcGluZy5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2tlbmRvLWJpbmRpbmcvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy9jb21iby1sb29rdXAtZGF0YS1tYXBwaW5nLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQTs7Ozs7OztHQU9HO0FBRUgsT0FBTyxFQUFFLFNBQVMsRUFBVSxRQUFRLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6RSxPQUFPLEVBQUUsYUFBYSxFQUFpQixTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV6RSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJN0MsTUFBTSxPQUFPLCtCQUFnQyxTQUFRLFdBQVc7SUFJOUQsWUFBK0IsRUFBYSxFQUE4QixNQUE0QjtRQUNwRyxLQUFLLEVBQUUsQ0FBQztRQURxQixPQUFFLEdBQUYsRUFBRSxDQUFXO1FBQThCLFdBQU0sR0FBTixNQUFNLENBQXNCO1FBRnJGLFdBQU0sR0FBa0IsSUFBSSxDQUFDO1FBSTVDLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDO1NBQ3ZDO0lBQ0gsQ0FBQztJQUVELFFBQVE7UUFDTix1QkFBdUI7UUFDdkIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBb0IsRUFBRSxFQUFFO1lBQ3pELElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEVBQUU7Z0JBQ3ZCLE1BQU07Z0JBQ04sTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLFVBQVUsSUFBSSxNQUFNLENBQUMsVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDMUYsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUMxQjtpQkFBTTtnQkFDTCxhQUFhO2dCQUNiLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQzthQUN2QjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTztRQUNQLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUU7WUFDL0IsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQztZQUMzRCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQztRQUNyQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDTyxjQUFjO1FBQ3BCLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JGLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDO1FBQzlDLE1BQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNoQixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7UUFDeEUsSUFBSSxXQUFXLElBQUksSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUMxQixNQUFNLGdCQUFnQixHQUFHLFNBQVMsQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUNwRCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsRUFBRSxJQUFJLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGNBQWMsSUFBSSxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFrQixDQUFDO1lBQzFJLE1BQU0sT0FBTyxHQUFHLGFBQWEsSUFBSSxhQUFhLENBQUMsT0FBTyxDQUFDO1lBQ3ZELElBQUksZ0JBQWdCLElBQUksT0FBTyxFQUFFO2dCQUMvQixNQUFNLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLEtBQUssT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUM3RixJQUFJLFdBQVcsRUFBRTtvQkFDZixTQUFTLENBQUMsZUFBZSxDQUFDLEdBQUcsV0FBVyxDQUFDO2lCQUMxQztxQkFBTTtvQkFDTCxPQUFPLFNBQVMsQ0FBQyxlQUFlLENBQUMsQ0FBQztpQkFDbkM7YUFDRjtTQUNGO1FBQ0QsSUFBSSxTQUFTLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ2xELE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUU7Z0JBQ3ZDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDNUMsQ0FBQyxDQUFDLENBQUM7WUFDSCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDekM7SUFDSCxDQUFDO0lBQ08sYUFBYSxDQUFDLElBQUk7UUFDeEIsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQztRQUMzRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDO1FBQzdELElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDckQsQ0FBQzs7O1lBM0RGLFNBQVMsU0FBQyxFQUFFLFFBQVEsRUFBRSw2QkFBNkIsRUFBRTs7OztZQU5mLFNBQVMsdUJBV2pDLFFBQVE7WUFUZCxvQkFBb0IsdUJBU29CLFFBQVEsWUFBSSxJQUFJOzs7d0JBSDlELEtBQUssU0FBQywyQkFBMkI7cUJBQ2pDLEtBQUssU0FBQyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbi8qKlxyXG4gKiDkvb/nlKjmlrnms5XvvJpcclxuICogW2NvbW9iLWxvb2t1cC1kYXRhLW1hcHBpbmddPVwieyBpZDogJ3VzZXIudXNlcklkJywgbmFtZTogJ3VzZXIudXNlck5hbWUnIH1cIlxyXG4gKiBrZXkg5Li65biu5Yqp5LiK55qE5a2X5q6177yMIHZhbHVlIOS4uiDooajljZXkuK3nmoTlrZfmrrXlkI1cclxuICog5biu5Yqp5LiK55qE5ZCM5LiA5Liq5a2X5q615Y+v5Lul5pig5bCE5Yiw6KGo5Y2V5Lit55qE5aSa5Liq5a2X5q615Lit77yMeyAuLi4gaWQ6ICd1c2VyLnVzZXJpZCwgdXNlci5hZGR1c2lkJ31cclxuICog5aSa5a2X5q615Lul6YCX5Y+36ZqU5byAXHJcbiAqXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgRGlyZWN0aXZlLCBPbkluaXQsIE9wdGlvbmFsLCBTZWxmLCBJbnB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBCaW5kaW5nT2JqZWN0LCBOZ0Zvcm1Db250cm9sLCBWaWV3TW9kZWwgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IENvbWJvQ2hhbmdlcyB9IGZyb20gJ0BmYXJyaXMvdWktY29tYm8tbGlzdCc7XHJcbmltcG9ydCB7IENvbWJvTG9va3VwQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1jb21iby1sb29rdXAnO1xyXG5pbXBvcnQgeyBEYXRhTWFwcGluZyB9IGZyb20gJy4vZGF0YS1tYXBwaW5nJztcclxuXHJcblxyXG5ARGlyZWN0aXZlKHsgc2VsZWN0b3I6ICdbY29tYm8tbG9va3VwLWRhdGEtbWFwcGluZ10nIH0pXHJcbmV4cG9ydCBjbGFzcyBDb21ib0xvb2t1cERhdGFNYXBwaW5nRGlyZWN0aXZlIGV4dGVuZHMgRGF0YU1hcHBpbmcgaW1wbGVtZW50cyBPbkluaXQge1xyXG4gIEBJbnB1dCgnY29tYm8tbG9va3VwLWRhdGEtbWFwcGluZycpIG1hcGZpZWxkczogYW55O1xyXG4gIEBJbnB1dCgndGFyZ2V0JykgdGFyZ2V0OiBCaW5kaW5nT2JqZWN0ID0gbnVsbDtcclxuXHJcbiAgY29uc3RydWN0b3IoQE9wdGlvbmFsKCkgcHVibGljIHZtOiBWaWV3TW9kZWwsIEBPcHRpb25hbCgpIEBTZWxmKCkgcHJpdmF0ZSBsb29rdXA6IENvbWJvTG9va3VwQ29tcG9uZW50KSB7XHJcbiAgICBzdXBlcigpO1xyXG4gICAgaWYgKHRoaXMubG9va3VwKSB7XHJcbiAgICAgIHRoaXMubG9va3VwLnVzZUZvcm1EYXRhTWFwcGluZyA9IHRydWU7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIC8vIOWAvOWPmOWMlu+8jOS6pumAmui/h+ivpeS6i+S7tuinpuWPkeS7u+aEj+i+k+WFpea4heepuuS6i+S7tlxyXG4gICAgdGhpcy5sb29rdXAudmFsdWVDaGFuZ2Uuc3Vic2NyaWJlKChyZXN1bHQ6IENvbWJvQ2hhbmdlcykgPT4ge1xyXG4gICAgICBpZiAoIXJlc3VsdFsnbm9zZWFyY2gnXSkge1xyXG4gICAgICAgIC8vIOWAvOWPmOWMllxyXG4gICAgICAgIGNvbnN0IGRhdGEgPSByZXN1bHQuc2VsZWN0aW9ucyAmJiByZXN1bHQuc2VsZWN0aW9ucy5sZW5ndGggPiAwID8gcmVzdWx0LnNlbGVjdGlvbnMgOiBudWxsO1xyXG4gICAgICAgIHRoaXMub25WYWx1ZUNoYW5nZShkYXRhKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyDku7vmhI/ovpPlhaXmuIXnqbrmmKDlsITlrZfmrrVcclxuICAgICAgICB0aGlzLm9uQ2xlYXJNYXBwaW5nKCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgLy8g5riF56m65LqL5Lu2XHJcbiAgICB0aGlzLmxvb2t1cC5jbGVhci5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICBjb25zdCBfbWFwZmllbGRzID0gdGhpcy5tYXBmaWVsZHMgfHwgdGhpcy5sb29rdXAubWFwRmllbGRzO1xyXG4gICAgICB0aGlzLm1hcHBpbmdEYXRhKG51bGwsIF9tYXBmaWVsZHMpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgb25DbGVhck1hcHBpbmcoKSB7XHJcbiAgICBjb25zdCBtYXBmaWVsZHMgPSBPYmplY3QuYXNzaWduKHt9LCAodGhpcy5tYXBmaWVsZHMgfHwgdGhpcy5sb29rdXAubWFwRmllbGRzIHx8IHt9KSk7XHJcbiAgICBjb25zdCBsb29rdXBUZXh0RmllbGQgPSB0aGlzLmxvb2t1cC50ZXh0RmllbGQ7XHJcbiAgICBjb25zdCBkYXRhID0ge307XHJcbiAgICBjb25zdCBjb250cm9sTmFtZSA9IHRoaXMubG9va3VwLm5nQ29udHJvbCAmJiB0aGlzLmxvb2t1cC5uZ0NvbnRyb2wubmFtZTtcclxuICAgIGlmIChjb250cm9sTmFtZSAmJiB0aGlzLnZtKSB7XHJcbiAgICAgIGNvbnN0IHRleHRGaWVsZE1hcHBpbmcgPSBtYXBmaWVsZHNbbG9va3VwVGV4dEZpZWxkXTtcclxuICAgICAgY29uc3QgbmdGb3JtQ29udHJvbCA9IHRoaXMudm0gJiYgdGhpcy52bS5mb3JtICYmIHRoaXMudm0uZm9ybS5uZ0Zvcm1Db250cm9scyAmJiB0aGlzLnZtLmZvcm0ubmdGb3JtQ29udHJvbHNbY29udHJvbE5hbWVdIGFzIE5nRm9ybUNvbnRyb2w7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmcgPSBuZ0Zvcm1Db250cm9sICYmIG5nRm9ybUNvbnRyb2wuYmluZGluZztcclxuICAgICAgaWYgKHRleHRGaWVsZE1hcHBpbmcgJiYgYmluZGluZykge1xyXG4gICAgICAgIGNvbnN0IHRhcmdldEZpZWxkID0gdGV4dEZpZWxkTWFwcGluZy5zcGxpdCgnLCcpLmZpbHRlcigoaXRlbSkgPT4gaXRlbSAhPT0gYmluZGluZykuam9pbignLCcpO1xyXG4gICAgICAgIGlmICh0YXJnZXRGaWVsZCkge1xyXG4gICAgICAgICAgbWFwZmllbGRzW2xvb2t1cFRleHRGaWVsZF0gPSB0YXJnZXRGaWVsZDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgZGVsZXRlIG1hcGZpZWxkc1tsb29rdXBUZXh0RmllbGRdO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKG1hcGZpZWxkcyAmJiBPYmplY3Qua2V5cyhtYXBmaWVsZHMpLmxlbmd0aCA+IDApIHtcclxuICAgICAgT2JqZWN0LmtleXMobWFwZmllbGRzKS5mb3JFYWNoKChmaWVsZCkgPT4ge1xyXG4gICAgICAgIHRoaXMuc2V0VmFsdWUoZGF0YSwgZmllbGQuc3BsaXQoJy4nKSwgJycpO1xyXG4gICAgICB9KTtcclxuICAgICAgdGhpcy5tYXBwaW5nRGF0YShkYXRhLCBtYXBmaWVsZHMsIHRydWUpO1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIG9uVmFsdWVDaGFuZ2UoZGF0YSkge1xyXG4gICAgY29uc3QgX21hcGZpZWxkcyA9IHRoaXMubWFwZmllbGRzIHx8IHRoaXMubG9va3VwLm1hcEZpZWxkcztcclxuICAgIGNvbnN0IHNwbGl0ZXIgPSB0aGlzLmxvb2t1cC5zZXBhcmF0b3IgfHwgdGhpcy5kZWZhdWx0U3BsaXRlcjtcclxuICAgIHRoaXMubWFwcGluZ0RhdGEoZGF0YSwgX21hcGZpZWxkcywgZmFsc2UsIHNwbGl0ZXIpO1xyXG4gIH1cclxufVxyXG4iXX0=