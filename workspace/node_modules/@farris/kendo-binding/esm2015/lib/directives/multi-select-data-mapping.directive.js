import { Directive, Input, Self, Host, Optional, Output, EventEmitter } from '@angular/core';
import { MultiSelectComponent } from '@farris/ui-multi-select';
import { ViewModel } from '@farris/devkit';
export class MultiSelectDataMappingDirective {
    constructor(vm, multiSelectComponent) {
        this.vm = vm;
        this.multiSelectComponent = multiSelectComponent;
        this.selectedIdChanged = new EventEmitter();
        this.vm.uiState.changes.subscribe(data => {
            this.selectedId = data.value;
        });
    }
    ngOnInit() {
        this.multiSelectComponent.dataSource = [];
        if (Array.isArray(this.dataSource)) {
            this.multiSelectComponent.dataSource = this.dataSource;
            this.originalDataSource = this.dataSource;
        }
        else if (this.dataSource && this.dataSource.changes) {
            this.dataSource.changes.subscribe((data) => {
                if (data.type === 'Load') {
                    this.originalDataSource = data.value;
                    if (this.multiSelectComponent.isTree()) {
                        if (this.fjmField) {
                            // 分级码加载树结构
                            this.multiSelectComponent.dataSource = this.plainToTree(data.value, this.fjmField, 1);
                        }
                        else if (this.fjdField) {
                            // 父节点加载树结构
                            this.multiSelectComponent.dataSource = this.buildTreeNodesByFjd(data.value, this.fjdField);
                        }
                        this.multiSelectComponent.selections = this.getTreeSelectionsById(this.selectedId, this.originalDataSource);
                    }
                    else {
                        this.multiSelectComponent.dataSource = data.value;
                        this.multiSelectComponent.selections = this.getListSelectionsById(this.selectedId, this.multiSelectComponent.dataSource);
                    }
                }
            });
        }
        this.selectIdBindingToUIStateField();
    }
    selectIdBindingToUIStateField() {
        if (this.multiSelectComponent && this.multiSelectComponent.selectedIdChange) {
            this.multiSelectComponent.selectedIdChange.subscribe(data => {
                this.selectedIdChanged.emit(data);
            });
        }
    }
    /**
     *
     * @param data 需要格式化的数据
     */
    formatDataSource(data, field) {
        if (!data || !data.length) {
            return [];
        }
        return data.map(item => {
            const n = item['toJSON'] ? item.toJSON() : item;
            return {
                data: Object.assign(Object.assign({}, n), {
                    [`${this.idField}`]: item[this.idField],
                    [`${this.textField}`]: item[this.textField],
                    [`${this.valueField}`]: item[this.valueField],
                    [`${field}`]: item[field]
                }),
                children: []
            };
        });
    }
    /**
     * 把平行结构的数据转换成树形结构
     * @param plainSource
     * @param field
     * @param layer
     */
    plainToTree(plainSource, field, layer) {
        const treeSource = this.formatDataSource(plainSource, field);
        if (!treeSource.length) {
            return [];
        }
        if (!treeSource[0]['data'][field]) {
            return [];
        }
        const parents = treeSource.filter(item => {
            return item['data'][field]['layer'] === layer;
        });
        this.recursive(parents, treeSource, field, 1);
        return parents;
    }
    /**
     * 递归遍历树形结构
     * @param parents
     * @param treeSource
     * @param field
     * @param layer
     */
    recursive(parents, treeSource, field, layer) {
        parents.forEach(parent => {
            const parentPath = parent['data'][field]['path'];
            const parentLayer = parent['data'][field]['layer'];
            if (parent['data'][field]['isDetail'] === false) {
                treeSource.forEach(item => {
                    if (item && item['data'] && item['data'][field] && item['data'][field]['path']) {
                        const itemPath = item['data'][field]['path'];
                        const itemLayer = item['data'][field]['layer'];
                        let targetPath;
                        if (itemPath && itemPath.length > parentPath.length) {
                            targetPath = itemPath.substr(0, Number(layer) * 4);
                        }
                        if (parentPath === targetPath && parentLayer === itemLayer - 1) {
                            parent['children'].push(item);
                        }
                        if (item['data'][field]['isDetail'] === false && parentPath === targetPath) {
                            this.recursive([item], treeSource, field, Number(layer) + 1);
                        }
                    }
                });
            }
        });
    }
    /**
       *
       * @param ids 选中数据的id
       * @param dataSource 原始数据
       */
    getListSelectionsById(ids, dataSource) {
        let result = [];
        const _this = this;
        if ((typeof ids === 'string' && !!ids) || typeof ids === 'number') {
            const reusltObj = dataSource.find(item => {
                return item && item[_this.idField] === ids;
            });
            if (reusltObj) {
                result.push(reusltObj);
            }
        }
        else if (Array.isArray(ids)) {
            if (dataSource) {
                ids.forEach(id => {
                    const item = dataSource.find(item => item && item[_this.idField] === id);
                    if (item) {
                        result.push(item);
                    }
                });
                // dataSource.forEach(item => {
                //   ids.forEach(id => {
                //     if (item[_this.idField] === id) {
                //       result.push(item);
                //     }
                //   })
                // })
            }
            else {
                result = [];
            }
        }
        else {
            result = [];
        }
        return result;
    }
    /**
     *
     * @param ids 选中数据的id
     * @param dataSource 原始数据
     */
    getTreeSelectionsById(ids, dataSource) {
        let result = [];
        const _this = this;
        if ((typeof ids === 'string' && !!ids) || typeof ids === 'number') {
            const reusltObj = dataSource.find(item => {
                return item && item[_this.idField] === ids;
            });
            if (reusltObj) {
                result.push(reusltObj);
            }
        }
        else if (Array.isArray(ids)) {
            if (dataSource) {
                ids.forEach(id => {
                    const item = dataSource.find(item => item && item[_this.idField] === id);
                    if (item) {
                        result.push(item);
                    }
                });
                // dataSource.forEach(item => {
                //   ids.forEach(id => {
                //     if (item.data[_this.idField] === id) {
                //       result.push(item.data);
                //     }
                //   })
                // })
            }
            else {
                result = [];
            }
        }
        else {
            result = [];
        }
        return result;
    }
    /**
     * 根据父节点初始化树结构
     * @param bindingObjects
     */
    buildTreeNodesByFjd(bindingObjects, field) {
        const treeData = this.formatDataSource(bindingObjects, field);
        treeData.forEach((item) => {
            const parent = treeData.find((ele) => item.data[field].parentElement === ele.data[this.idField]);
            if (parent) {
                parent.children.push(item);
            }
        });
        return treeData.filter((ele) => !ele.data[field].parentElement);
    }
}
MultiSelectDataMappingDirective.decorators = [
    { type: Directive, args: [{
                selector: '[multiSelectDataMapping]'
            },] }
];
/** @nocollapse */
MultiSelectDataMappingDirective.ctorParameters = () => [
    { type: ViewModel, decorators: [{ type: Optional }] },
    { type: MultiSelectComponent, decorators: [{ type: Host }, { type: Self }, { type: Optional }] }
];
MultiSelectDataMappingDirective.propDecorators = {
    dataSource: [{ type: Input }],
    idField: [{ type: Input }],
    textField: [{ type: Input }],
    valueField: [{ type: Input }],
    fjmField: [{ type: Input }],
    fjdField: [{ type: Input }],
    uiStateField: [{ type: Input }],
    selectedId: [{ type: Input }],
    selectedIdChanged: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXVsdGktc2VsZWN0LWRhdGEtbWFwcGluZy5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2tlbmRvLWJpbmRpbmcvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy9tdWx0aS1zZWxlY3QtZGF0YS1tYXBwaW5nLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBVSxNQUFNLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JHLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHlCQUF5QixDQUFBO0FBQzlELE9BQU8sRUFBRSxTQUFTLEVBQWlCLE1BQU0sZ0JBQWdCLENBQUM7QUFLMUQsTUFBTSxPQUFPLCtCQUErQjtJQWExQyxZQUNzQixFQUFhLEVBQ0csb0JBQTBDO1FBRDFELE9BQUUsR0FBRixFQUFFLENBQVc7UUFDRyx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBTHRFLHNCQUFpQixHQUFHLElBQUksWUFBWSxFQUFVLENBQUM7UUFPdkQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUN2QyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0lBQ0QsUUFBUTtRQUNOLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQzFDLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDbEMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO1lBQ3ZELElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO1NB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InNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgSW5wdXQsIFNlbGYsIEhvc3QsIE9wdGlvbmFsLCBPbkluaXQsIE91dHB1dCwgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE11bHRpU2VsZWN0Q29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1tdWx0aS1zZWxlY3QnXHJcbmltcG9ydCB7IFZpZXdNb2RlbCwgQmluZGluZ09iamVjdCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW211bHRpU2VsZWN0RGF0YU1hcHBpbmddJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgTXVsdGlTZWxlY3REYXRhTWFwcGluZ0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcblxyXG4gIEBJbnB1dCgpIGRhdGFTb3VyY2U6IGFueTtcclxuICBASW5wdXQoKSBpZEZpZWxkOiBzdHJpbmc7XHJcbiAgQElucHV0KCkgdGV4dEZpZWxkOiBzdHJpbmc7XHJcbiAgQElucHV0KCkgdmFsdWVGaWVsZDogc3RyaW5nO1xyXG4gIEBJbnB1dCgpIGZqbUZpZWxkOiBzdHJpbmc7XHJcbiAgQElucHV0KCkgZmpkRmllbGQ6IHN0cmluZztcclxuICBASW5wdXQoKSB1aVN0YXRlRmllbGQ6IGFueTtcclxuICBASW5wdXQoKSBzZWxlY3RlZElkOiBzdHJpbmc7XHJcbiAgQE91dHB1dCgpIHNlbGVjdGVkSWRDaGFuZ2VkID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XHJcbiAgcHJpdmF0ZSBvcmlnaW5hbERhdGFTb3VyY2U6IGFueTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHZtOiBWaWV3TW9kZWwsXHJcbiAgICBASG9zdCgpIEBTZWxmKCkgQE9wdGlvbmFsKCkgcHJpdmF0ZSBtdWx0aVNlbGVjdENvbXBvbmVudDogTXVsdGlTZWxlY3RDb21wb25lbnRcclxuICApIHtcclxuICAgIHRoaXMudm0udWlTdGF0ZS5jaGFuZ2VzLnN1YnNjcmliZShkYXRhID0+IHtcclxuICAgICAgdGhpcy5zZWxlY3RlZElkID0gZGF0YS52YWx1ZTtcclxuICAgIH0pXHJcbiAgfVxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgdGhpcy5tdWx0aVNlbGVjdENvbXBvbmVudC5kYXRhU291cmNlID0gW107XHJcbiAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmRhdGFTb3VyY2UpKSB7XHJcbiAgICAgIHRoaXMubXVsdGlTZWxlY3RDb21wb25lbnQuZGF0YVNvdXJjZSA9IHRoaXMuZGF0YVNvdXJjZTtcclxuICAgICAgdGhpcy5vcmlnaW5hbERhdGFTb3VyY2UgPSB0aGlzLmRhdGFTb3VyY2U7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuZGF0YVNvdXJjZSAmJiB0aGlzLmRhdGFTb3VyY2UuY2hhbmdlcykge1xyXG4gICAgICB0aGlzLmRhdGFTb3VyY2UuY2hhbmdlcy5zdWJzY3JpYmUoKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmIChkYXRhLnR5cGUgPT09ICdMb2FkJykge1xyXG4gICAgICAgICAgdGhpcy5vcmlnaW5hbERhdGFTb3VyY2UgPSBkYXRhLnZhbHVlO1xyXG4gICAgICAgICAgaWYgKHRoaXMubXVsdGlTZWxlY3RDb21wb25lbnQuaXNUcmVlKCkpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZmptRmllbGQpIHtcclxuICAgICAgICAgICAgICAvLyDliIbnuqfnoIHliqDovb3moJHnu5PmnoRcclxuICAgICAgICAgICAgICB0aGlzLm11bHRpU2VsZWN0Q29tcG9uZW50LmRhdGFTb3VyY2UgPSB0aGlzLnBsYWluVG9UcmVlKGRhdGEudmFsdWUsIHRoaXMuZmptRmllbGQsIDEpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZmpkRmllbGQpIHtcclxuICAgICAgICAgICAgICAvLyDniLboioLngrnliqDovb3moJHnu5PmnoRcclxuICAgICAgICAgICAgICB0aGlzLm11bHRpU2VsZWN0Q29tcG9uZW50LmRhdGFTb3VyY2UgPSB0aGlzLmJ1aWxkVHJlZU5vZGVzQnlGamQoZGF0YS52YWx1ZSwgdGhpcy5mamRGaWVsZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5tdWx0aVNlbGVjdENvbXBvbmVudC5zZWxlY3Rpb25zID0gdGhpcy5nZXRUcmVlU2VsZWN0aW9uc0J5SWQodGhpcy5zZWxlY3RlZElkLCB0aGlzLm9yaWdpbmFsRGF0YVNvdXJjZSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLm11bHRpU2VsZWN0Q29tcG9uZW50LmRhdGFTb3VyY2UgPSBkYXRhLnZhbHVlO1xyXG4gICAgICAgICAgICB0aGlzLm11bHRpU2VsZWN0Q29tcG9uZW50LnNlbGVjdGlvbnMgPSB0aGlzLmdldExpc3RTZWxlY3Rpb25zQnlJZCh0aGlzLnNlbGVjdGVkSWQsIHRoaXMubXVsdGlTZWxlY3RDb21wb25lbnQuZGF0YVNvdXJjZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgfVxyXG4gICAgdGhpcy5zZWxlY3RJZEJpbmRpbmdUb1VJU3RhdGVGaWVsZCgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZWxlY3RJZEJpbmRpbmdUb1VJU3RhdGVGaWVsZCgpIHtcclxuICAgIGlmICh0aGlzLm11bHRpU2VsZWN0Q29tcG9uZW50ICYmIHRoaXMubXVsdGlTZWxlY3RDb21wb25lbnQuc2VsZWN0ZWRJZENoYW5nZSkge1xyXG4gICAgICB0aGlzLm11bHRpU2VsZWN0Q29tcG9uZW50LnNlbGVjdGVkSWRDaGFuZ2Uuc3Vic2NyaWJlKGRhdGEgPT4ge1xyXG4gICAgICAgIHRoaXMuc2VsZWN0ZWRJZENoYW5nZWQuZW1pdChkYXRhKTtcclxuICAgICAgfSlcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICogXHJcbiAgICogQHBhcmFtIGRhdGEg6ZyA6KaB5qC85byP5YyW55qE5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmb3JtYXREYXRhU291cmNlKGRhdGE6IGFueVtdLCBmaWVsZDogc3RyaW5nKSB7XHJcbiAgICBpZiAoIWRhdGEgfHwgIWRhdGEubGVuZ3RoKSB7XHJcbiAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuICAgIHJldHVybiBkYXRhLm1hcChpdGVtID0+IHtcclxuICAgICAgY29uc3QgbiA9IGl0ZW1bJ3RvSlNPTiddID8gaXRlbS50b0pTT04oKSA6IGl0ZW07XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgZGF0YTogT2JqZWN0LmFzc2lnbih7IC4uLm4gfSwge1xyXG4gICAgICAgICAgW2Ake3RoaXMuaWRGaWVsZH1gXTogaXRlbVt0aGlzLmlkRmllbGRdLFxyXG4gICAgICAgICAgW2Ake3RoaXMudGV4dEZpZWxkfWBdOiBpdGVtW3RoaXMudGV4dEZpZWxkXSxcclxuICAgICAgICAgIFtgJHt0aGlzLnZhbHVlRmllbGR9YF06IGl0ZW1bdGhpcy52YWx1ZUZpZWxkXSxcclxuICAgICAgICAgIFtgJHtmaWVsZH1gXTogaXRlbVtmaWVsZF1cclxuICAgICAgICB9KSxcclxuICAgICAgICBjaGlsZHJlbjogW11cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaKiuW5s+ihjOe7k+aehOeahOaVsOaNrui9rOaNouaIkOagkeW9oue7k+aehFxyXG4gICAqIEBwYXJhbSBwbGFpblNvdXJjZSBcclxuICAgKiBAcGFyYW0gZmllbGQgXHJcbiAgICogQHBhcmFtIGxheWVyIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgcGxhaW5Ub1RyZWUocGxhaW5Tb3VyY2U6IGFueVtdLCBmaWVsZDogc3RyaW5nLCBsYXllcjogbnVtYmVyKSB7XHJcbiAgICBjb25zdCB0cmVlU291cmNlID0gdGhpcy5mb3JtYXREYXRhU291cmNlKHBsYWluU291cmNlLCBmaWVsZCk7XHJcbiAgICBpZiAoIXRyZWVTb3VyY2UubGVuZ3RoKSB7XHJcbiAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuICAgIGlmICghdHJlZVNvdXJjZVswXVsnZGF0YSddW2ZpZWxkXSkge1xyXG4gICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXJlbnRzID0gdHJlZVNvdXJjZS5maWx0ZXIoaXRlbSA9PiB7XHJcbiAgICAgIHJldHVybiBpdGVtWydkYXRhJ11bZmllbGRdWydsYXllciddID09PSBsYXllcjtcclxuICAgIH0pXHJcbiAgICB0aGlzLnJlY3Vyc2l2ZShwYXJlbnRzLCB0cmVlU291cmNlLCBmaWVsZCwgMSk7XHJcbiAgICByZXR1cm4gcGFyZW50cztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOmAkuW9kumBjeWOhuagkeW9oue7k+aehFxyXG4gICAqIEBwYXJhbSBwYXJlbnRzIFxyXG4gICAqIEBwYXJhbSB0cmVlU291cmNlIFxyXG4gICAqIEBwYXJhbSBmaWVsZCBcclxuICAgKiBAcGFyYW0gbGF5ZXIgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZWN1cnNpdmUocGFyZW50czogYW55W10sIHRyZWVTb3VyY2U6IGFueVtdLCBmaWVsZDogc3RyaW5nLCBsYXllcjogbnVtYmVyKSB7XHJcbiAgICBwYXJlbnRzLmZvckVhY2gocGFyZW50ID0+IHtcclxuICAgICAgY29uc3QgcGFyZW50UGF0aCA9IHBhcmVudFsnZGF0YSddW2ZpZWxkXVsncGF0aCddO1xyXG4gICAgICBjb25zdCBwYXJlbnRMYXllciA9IHBhcmVudFsnZGF0YSddW2ZpZWxkXVsnbGF5ZXInXTtcclxuICAgICAgaWYgKHBhcmVudFsnZGF0YSddW2ZpZWxkXVsnaXNEZXRhaWwnXSA9PT0gZmFsc2UpIHtcclxuICAgICAgICB0cmVlU291cmNlLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICBpZiAoaXRlbSAmJiBpdGVtWydkYXRhJ10gJiYgaXRlbVsnZGF0YSddW2ZpZWxkXSAmJiBpdGVtWydkYXRhJ11bZmllbGRdWydwYXRoJ10pIHtcclxuICAgICAgICAgICAgY29uc3QgaXRlbVBhdGggPSBpdGVtWydkYXRhJ11bZmllbGRdWydwYXRoJ107XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1MYXllciA9IGl0ZW1bJ2RhdGEnXVtmaWVsZF1bJ2xheWVyJ107XHJcbiAgICAgICAgICAgIGxldCB0YXJnZXRQYXRoOiBzdHJpbmc7XHJcbiAgICAgICAgICAgIGlmIChpdGVtUGF0aCAmJiBpdGVtUGF0aC5sZW5ndGggPiBwYXJlbnRQYXRoLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgIHRhcmdldFBhdGggPSBpdGVtUGF0aC5zdWJzdHIoMCwgTnVtYmVyKGxheWVyKSAqIDQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChwYXJlbnRQYXRoID09PSB0YXJnZXRQYXRoICYmIHBhcmVudExheWVyID09PSBpdGVtTGF5ZXIgLSAxKSB7XHJcbiAgICAgICAgICAgICAgcGFyZW50WydjaGlsZHJlbiddLnB1c2goaXRlbSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGl0ZW1bJ2RhdGEnXVtmaWVsZF1bJ2lzRGV0YWlsJ10gPT09IGZhbHNlICYmIHBhcmVudFBhdGggPT09IHRhcmdldFBhdGgpIHtcclxuICAgICAgICAgICAgICB0aGlzLnJlY3Vyc2l2ZShbaXRlbV0sIHRyZWVTb3VyY2UsIGZpZWxkLCBOdW1iZXIobGF5ZXIpICsgMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9XHJcbiAgLyoqXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSBpZHMg6YCJ5Lit5pWw5o2u55qEaWRcclxuICAgICAqIEBwYXJhbSBkYXRhU291cmNlIOWOn+Wni+aVsOaNrlxyXG4gICAgICovXHJcbiAgcHJpdmF0ZSBnZXRMaXN0U2VsZWN0aW9uc0J5SWQoaWRzOiBhbnksIGRhdGFTb3VyY2U6IGFueSkge1xyXG4gICAgbGV0IHJlc3VsdCA9IFtdO1xyXG4gICAgY29uc3QgX3RoaXMgPSB0aGlzO1xyXG4gICAgaWYgKCh0eXBlb2YgaWRzID09PSAnc3RyaW5nJyAmJiAhIWlkcykgfHwgdHlwZW9mIGlkcyA9PT0gJ251bWJlcicpIHtcclxuICAgICAgY29uc3QgcmV1c2x0T2JqID0gZGF0YVNvdXJjZS5maW5kKGl0ZW0gPT4ge1xyXG4gICAgICAgIHJldHVybiBpdGVtICYmIGl0ZW1bX3RoaXMuaWRGaWVsZF0gPT09IGlkcztcclxuICAgICAgfSk7XHJcbiAgICAgIGlmIChyZXVzbHRPYmopIHtcclxuICAgICAgICByZXN1bHQucHVzaChyZXVzbHRPYmopO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoaWRzKSkge1xyXG4gICAgICBpZiAoZGF0YVNvdXJjZSkge1xyXG4gICAgICAgIGlkcy5mb3JFYWNoKGlkID0+IHtcclxuICAgICAgICAgIGNvbnN0IGl0ZW0gPSBkYXRhU291cmNlLmZpbmQoaXRlbSA9PiBpdGVtICYmIGl0ZW1bX3RoaXMuaWRGaWVsZF0gPT09IGlkKTtcclxuICAgICAgICAgIGlmIChpdGVtKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIGRhdGFTb3VyY2UuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICAvLyAgIGlkcy5mb3JFYWNoKGlkID0+IHtcclxuICAgICAgICAvLyAgICAgaWYgKGl0ZW1bX3RoaXMuaWRGaWVsZF0gPT09IGlkKSB7XHJcbiAgICAgICAgLy8gICAgICAgcmVzdWx0LnB1c2goaXRlbSk7XHJcbiAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAvLyAgIH0pXHJcbiAgICAgICAgLy8gfSlcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXN1bHQgPSBbXTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmVzdWx0ID0gW107XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogXHJcbiAgICogQHBhcmFtIGlkcyDpgInkuK3mlbDmja7nmoRpZFxyXG4gICAqIEBwYXJhbSBkYXRhU291cmNlIOWOn+Wni+aVsOaNrlxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0VHJlZVNlbGVjdGlvbnNCeUlkKGlkczogYW55LCBkYXRhU291cmNlOiBhbnkpIHtcclxuICAgIGxldCByZXN1bHQgPSBbXTtcclxuICAgIGNvbnN0IF90aGlzID0gdGhpcztcclxuICAgIGlmICgodHlwZW9mIGlkcyA9PT0gJ3N0cmluZycgJiYgISFpZHMpIHx8IHR5cGVvZiBpZHMgPT09ICdudW1iZXInKSB7XHJcbiAgICAgIGNvbnN0IHJldXNsdE9iaiA9IGRhdGFTb3VyY2UuZmluZChpdGVtID0+IHtcclxuICAgICAgICByZXR1cm4gaXRlbSAmJiBpdGVtW190aGlzLmlkRmllbGRdID09PSBpZHM7XHJcbiAgICAgIH0pO1xyXG4gICAgICBpZiAocmV1c2x0T2JqKSB7XHJcbiAgICAgICAgcmVzdWx0LnB1c2gocmV1c2x0T2JqKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGlkcykpIHtcclxuICAgICAgaWYgKGRhdGFTb3VyY2UpIHtcclxuICAgICAgICBpZHMuZm9yRWFjaChpZCA9PiB7XHJcbiAgICAgICAgICBjb25zdCBpdGVtID0gZGF0YVNvdXJjZS5maW5kKGl0ZW0gPT4gaXRlbSAmJiBpdGVtW190aGlzLmlkRmllbGRdID09PSBpZCk7XHJcbiAgICAgICAgICBpZiAoaXRlbSkge1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaChpdGVtKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICAvLyBkYXRhU291cmNlLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgLy8gICBpZHMuZm9yRWFjaChpZCA9PiB7XHJcbiAgICAgICAgLy8gICAgIGlmIChpdGVtLmRhdGFbX3RoaXMuaWRGaWVsZF0gPT09IGlkKSB7XHJcbiAgICAgICAgLy8gICAgICAgcmVzdWx0LnB1c2goaXRlbS5kYXRhKTtcclxuICAgICAgICAvLyAgICAgfVxyXG4gICAgICAgIC8vICAgfSlcclxuICAgICAgICAvLyB9KVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlc3VsdCA9IFtdO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXN1bHQgPSBbXTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG5cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOagueaNrueItuiKgueCueWIneWni+WMluagkee7k+aehFxyXG4gICAqIEBwYXJhbSBiaW5kaW5nT2JqZWN0cyBcclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkVHJlZU5vZGVzQnlGamQoYmluZGluZ09iamVjdHM6IEJpbmRpbmdPYmplY3RbXSwgZmllbGQ6IHN0cmluZykge1xyXG4gICAgY29uc3QgdHJlZURhdGEgPSB0aGlzLmZvcm1hdERhdGFTb3VyY2UoYmluZGluZ09iamVjdHMsIGZpZWxkKTtcclxuICAgIHRyZWVEYXRhLmZvckVhY2goKGl0ZW06IGFueSkgPT4ge1xyXG4gICAgICBjb25zdCBwYXJlbnQgPSB0cmVlRGF0YS5maW5kKChlbGU6IGFueSkgPT4gaXRlbS5kYXRhW2ZpZWxkXS5wYXJlbnRFbGVtZW50ID09PSBlbGUuZGF0YVt0aGlzLmlkRmllbGRdKTtcclxuICAgICAgaWYgKHBhcmVudCkge1xyXG4gICAgICAgIHBhcmVudC5jaGlsZHJlbi5wdXNoKGl0ZW0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0cmVlRGF0YS5maWx0ZXIoKGVsZTogYW55KSA9PiAhZWxlLmRhdGFbZmllbGRdLnBhcmVudEVsZW1lbnQpO1xyXG4gIH1cclxufVxyXG4iXX0=