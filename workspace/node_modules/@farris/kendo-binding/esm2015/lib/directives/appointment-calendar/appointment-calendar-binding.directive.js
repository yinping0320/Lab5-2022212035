import { Directive, HostListener, Injector, Input } from '@angular/core';
import { ChangeType, FrameContext } from '@farris/devkit';
import { AppointmentCalendarComponent } from '@farris/appointment-calendar';
import { ViewType } from './types';
import { isEqual } from 'lodash-es';
import { BasePathService } from '@farris/rtf';
export class AppointmentCalendarBindingDirective {
    constructor(injector, frameContext, calendarComponent) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.calendarComponent = calendarComponent;
        /**
         * 房间列表api url
         */
        this.url = null;
        /**
         * http method, default PUT
         */
        this.method = 'PUT';
        this.startDateVariable = 'startDate';
        this.endDateVariable = 'endDate';
        this.viewTypeVariable = 'viewType';
    }
    get bindingData() {
        return this.frameContext.bindingData;
    }
    get viewModel() {
        return this.frameContext.viewModel;
    }
    restService() {
        return this.frameContext.repository.restService;
    }
    /**
     * 获取绑定数据
     */
    get bindingList() {
        // 根实体
        if (this.viewModel.bindingPath === '/' || !this.viewModel.bindingPath) {
            return this.bindingData.list;
        }
        // 子实体
        let bindingPath = this.viewModel.bindingPath.substr(1);
        bindingPath = bindingPath[0].toLowerCase() + bindingPath.substring(1, bindingPath.length);
        const paths = bindingPath.split('/');
        const filteredPaths = paths.filter((part) => {
            return part !== '';
        });
        return this.bindingData.getValue(filteredPaths);
    }
    ngOnInit() {
        this.loadPlacements();
        this.registerBindingDataChangeEvent();
    }
    ngOnChanges(changes) {
    }
    ngOnDestroy() {
        this.unRegisterBindingDataChangeEvent();
    }
    bindData(change) {
        // 再toJSON
        let data = this.bindingList.toJSON();
        if (this.__DATA__ && isEqual(this.__DATA__, data)) {
            return;
        }
        this.__DATA__ = data;
        this.calendarComponent.loadReserveData(data);
    }
    onBindingDataChange(change) {
        this.bindData(change);
        this.updateSelectedRow(change);
    }
    registerBindingDataChangeEvent() {
        this.bindingDataChangeEvent = this.bindingData.changes.subscribe((change) => {
            this.onBindingDataChange(change);
        });
    }
    /**
     * 取消bindingdata变化订阅
     */
    unRegisterBindingDataChangeEvent() {
        if (this.bindingDataChangeEvent && typeof (this.bindingDataChangeEvent.unsubscribe) === 'function') {
            this.bindingDataChangeEvent.unsubscribe();
        }
    }
    loadPlacements() {
        if (!this.url) {
            console.log('无法加载房间信息，请配置房间列表api地址');
            return;
        }
        const requestInfo = this.restService().buildRequestInfo();
        const options = {
            body: {
                requestInfo
            }
        };
        const url = BasePathService.convertPath(this.url);
        this.restService().request(url, this.method, null, options).subscribe((returnValue) => {
            this.bindPlacements(returnValue);
        });
    }
    bindPlacements(placments) {
        this.calendarComponent.loadPlaceData(placments);
    }
    updateState(startDate, endDate, viewType) {
        this.viewModel.uiState.setPropertyValue(this.startDateVariable, startDate);
        this.viewModel.uiState.setPropertyValue(this.endDateVariable, endDate);
        this.viewModel.uiState.setPropertyValue(this.viewTypeVariable, viewType);
    }
    updateSelectedRow(change) {
        if (!this.bindingList || !this.bindingList.currentId) {
            return;
        }
        // 页码切换时不执行当前行切换
        if (change && change.type === ChangeType.PaginationInfoChange) {
            return;
        }
        if (this.viewModel && this.viewModel.frameContext.bindingData.rowSelectedEventSuspend === true) {
            return;
        }
        const id = this.calendarComponent.selectedId;
        const currentId = this.bindingList.currentId;
        // grid当前行与bingingList当前行一致，无须切换
        if (id === currentId) {
            return;
        }
        this.selectCalendarRow(this.bindingList.currentId);
    }
    selectCalendarRow(id) {
        this.calendarComponent.selectItem(id);
    }
    filterChanged(event) {
        const { dateValue = null, place = null, viewType = null } = event || {};
        let startDate = null;
        let endDate = null;
        if (!dateValue) {
            return;
        }
        if (viewType === ViewType.day) {
            startDate = `${dateValue} 00:00:00`;
            endDate = `${dateValue} 23:59:59`;
        }
        else if (viewType === ViewType.week && dateValue.indexOf('~') !== -1) {
            const sections = dateValue.split('~');
            startDate = `${sections[0]} 00:00:00`;
            endDate = `${sections[1]} 23:59:59`;
        }
        this.updateState(startDate, endDate, viewType);
    }
    setSelectionIdToBindingData(id) {
        // 如果当前行不存在，则强制设置
        if (this.bindingList.currentId !== id) {
            this.bindingList.setCurrentId(id, true);
        }
    }
    selectChange(event) {
        const { item: { id = null } } = event;
        this.setSelectionIdToBindingData(id);
    }
}
AppointmentCalendarBindingDirective.decorators = [
    { type: Directive, args: [{
                selector: '[farris-appointment-calendar-binding]'
            },] }
];
/** @nocollapse */
AppointmentCalendarBindingDirective.ctorParameters = () => [
    { type: Injector },
    { type: FrameContext },
    { type: AppointmentCalendarComponent }
];
AppointmentCalendarBindingDirective.propDecorators = {
    url: [{ type: Input }],
    method: [{ type: Input }],
    startDateVariable: [{ type: Input }],
    endDateVariable: [{ type: Input }],
    viewTypeVariable: [{ type: Input }],
    filterChanged: [{ type: HostListener, args: ['filterChange', ['$event'],] }],
    selectChange: [{ type: HostListener, args: ['selectChange', ['$event'],] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwb2ludG1lbnQtY2FsZW5kYXItYmluZGluZy5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2tlbmRvLWJpbmRpbmcvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy9hcHBvaW50bWVudC1jYWxlbmRhci9hcHBvaW50bWVudC1jYWxlbmRhci1iaW5kaW5nLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUErQyxZQUFZLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFDdEYsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFvQyxVQUFVLEVBQWEsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkcsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDNUUsT0FBTyxFQUFpQyxRQUFRLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDbEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNwQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBSzlDLE1BQU0sT0FBTyxtQ0FBbUM7SUEwQzlDLFlBQW9CLFFBQWtCLEVBQVUsWUFBMEIsRUFBVSxpQkFBK0M7UUFBL0csYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQVUsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUE4QjtRQVpuSTs7V0FFRztRQUNNLFFBQUcsR0FBVyxJQUFJLENBQUM7UUFDNUI7O1dBRUc7UUFDTSxXQUFNLEdBQVcsS0FBSyxDQUFDO1FBQ3ZCLHNCQUFpQixHQUFXLFdBQVcsQ0FBQztRQUN4QyxvQkFBZSxHQUFXLFNBQVMsQ0FBQztRQUNwQyxxQkFBZ0IsR0FBVyxVQUFVLENBQUM7SUFFd0YsQ0FBQztJQXZDeEksSUFBWSxXQUFXO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUM7SUFDdkMsQ0FB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LE1BQU0sUUFBUSxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdEMsU0FBUyxHQUFHLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUM7WUFDdEMsT0FBTyxHQUFHLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUM7U0FDckM7UUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUNTLDJCQUEyQixDQUFDLEVBQVU7UUFDOUMsaUJBQWlCO1FBQ2pCLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLEtBQUssRUFBRSxFQUFFO1lBQ3JDLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztTQUN6QztJQUNILENBQUM7SUFFTSxZQUFZLENBQUMsS0FBSztRQUN2QixNQUFNLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxHQUFHLElBQUksRUFBRSxFQUFFLEdBQUcsS0FBSyxDQUFDO1FBQ3RDLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN2QyxDQUFDOzs7WUE3SkYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSx1Q0FBdUM7YUFDbEQ7Ozs7WUFYdUUsUUFBUTtZQUdkLFlBQVk7WUFDckUsNEJBQTRCOzs7a0JBeUNsQyxLQUFLO3FCQUlMLEtBQUs7Z0NBQ0wsS0FBSzs4QkFDTCxLQUFLOytCQUNMLEtBQUs7NEJBc0ZMLFlBQVksU0FBQyxjQUFjLEVBQUUsQ0FBQyxRQUFRLENBQUM7MkJBd0J2QyxZQUFZLFNBQUMsY0FBYyxFQUFFLENBQUMsUUFBUSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBEaXJlY3RpdmUsIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3ksIFNpbXBsZUNoYW5nZXMsIEhvc3RMaXN0ZW5lciwgSW5qZWN0b3IsIElucHV0XHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBCaW5kaW5nRGF0YSwgQmluZGluZ0xpc3QsIENoYW5nZSwgQ2hhbmdlVHlwZSwgVmlld01vZGVsLCBGcmFtZUNvbnRleHQgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IEFwcG9pbnRtZW50Q2FsZW5kYXJDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL2FwcG9pbnRtZW50LWNhbGVuZGFyJztcclxuaW1wb3J0IHsgQmVmUmVzdFNlcnZpY2UsIEJlZlJlcG9zaXRvcnksIFZpZXdUeXBlIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IGlzRXF1YWwgfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG5pbXBvcnQgeyBCYXNlUGF0aFNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3J0Zic7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1tmYXJyaXMtYXBwb2ludG1lbnQtY2FsZW5kYXItYmluZGluZ10nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBBcHBvaW50bWVudENhbGVuZGFyQmluZGluZ0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xyXG4gIHByaXZhdGUgX19EQVRBX186IGFueTtcclxuICBwcml2YXRlIGJpbmRpbmdEYXRhQ2hhbmdlRXZlbnQ6IFN1YnNjcmlwdGlvbjtcclxuICBwcml2YXRlIGdldCBiaW5kaW5nRGF0YSgpOiBCaW5kaW5nRGF0YSB7XHJcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGE7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0IHZpZXdNb2RlbCgpOiBWaWV3TW9kZWwge1xyXG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0LnZpZXdNb2RlbDtcclxuICB9XHJcbiAgcHJpdmF0ZSByZXN0U2VydmljZSgpOiBCZWZSZXN0U2VydmljZSB7XHJcbiAgICByZXR1cm4gKHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeSkucmVzdFNlcnZpY2U7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlue7keWumuaVsOaNrlxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBnZXQgYmluZGluZ0xpc3QoKTogQmluZGluZ0xpc3Qge1xyXG4gICAgLy8g5qC55a6e5L2TXHJcbiAgICBpZiAodGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09ICcvJyB8fCAhdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGgpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuYmluZGluZ0RhdGEubGlzdDtcclxuICAgIH1cclxuICAgIC8vIOWtkOWunuS9k1xyXG4gICAgbGV0IGJpbmRpbmdQYXRoID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGguc3Vic3RyKDEpO1xyXG4gICAgYmluZGluZ1BhdGggPSBiaW5kaW5nUGF0aFswXS50b0xvd2VyQ2FzZSgpICsgYmluZGluZ1BhdGguc3Vic3RyaW5nKDEsIGJpbmRpbmdQYXRoLmxlbmd0aCk7XHJcbiAgICBjb25zdCBwYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJyk7XHJcblxyXG4gICAgY29uc3QgZmlsdGVyZWRQYXRocyA9IHBhdGhzLmZpbHRlcigocGFydDogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHJldHVybiBwYXJ0ICE9PSAnJztcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXMuYmluZGluZ0RhdGEuZ2V0VmFsdWUoZmlsdGVyZWRQYXRocyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaIv+mXtOWIl+ihqGFwaSB1cmxcclxuICAgKi9cclxuICBASW5wdXQoKSB1cmw6IHN0cmluZyA9IG51bGw7XHJcbiAgLyoqXHJcbiAgICogaHR0cCBtZXRob2QsIGRlZmF1bHQgUFVUXHJcbiAgICovXHJcbiAgQElucHV0KCkgbWV0aG9kOiBzdHJpbmcgPSAnUFVUJztcclxuICBASW5wdXQoKSBzdGFydERhdGVWYXJpYWJsZTogc3RyaW5nID0gJ3N0YXJ0RGF0ZSc7XHJcbiAgQElucHV0KCkgZW5kRGF0ZVZhcmlhYmxlOiBzdHJpbmcgPSAnZW5kRGF0ZSc7XHJcbiAgQElucHV0KCkgdmlld1R5cGVWYXJpYWJsZTogc3RyaW5nID0gJ3ZpZXdUeXBlJztcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIHByaXZhdGUgY2FsZW5kYXJDb21wb25lbnQ6IEFwcG9pbnRtZW50Q2FsZW5kYXJDb21wb25lbnQpIHsgfVxyXG5cclxuICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgIHRoaXMubG9hZFBsYWNlbWVudHMoKTtcclxuICAgIHRoaXMucmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCk7XHJcbiAgfVxyXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcclxuXHJcbiAgfVxyXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgdGhpcy51blJlZ2lzdGVyQmluZGluZ0RhdGFDaGFuZ2VFdmVudCgpO1xyXG4gIH1cclxuICBwcml2YXRlIGJpbmREYXRhKGNoYW5nZTogQ2hhbmdlKSB7XHJcbiAgICAvLyDlho10b0pTT05cclxuICAgIGxldCBkYXRhOiBhbnkgPSB0aGlzLmJpbmRpbmdMaXN0LnRvSlNPTigpO1xyXG4gICAgaWYgKHRoaXMuX19EQVRBX18gJiYgaXNFcXVhbCh0aGlzLl9fREFUQV9fLCBkYXRhKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLl9fREFUQV9fID0gZGF0YTtcclxuICAgIHRoaXMuY2FsZW5kYXJDb21wb25lbnQubG9hZFJlc2VydmVEYXRhKGRhdGEpO1xyXG4gIH1cclxuICBwcml2YXRlIG9uQmluZGluZ0RhdGFDaGFuZ2UoY2hhbmdlOiBDaGFuZ2UpIHtcclxuICAgIHRoaXMuYmluZERhdGEoY2hhbmdlKTtcclxuICAgIHRoaXMudXBkYXRlU2VsZWN0ZWRSb3coY2hhbmdlKTtcclxuICB9XHJcbiAgcHJpdmF0ZSByZWdpc3RlckJpbmRpbmdEYXRhQ2hhbmdlRXZlbnQoKSB7XHJcbiAgICB0aGlzLmJpbmRpbmdEYXRhQ2hhbmdlRXZlbnQgPSB0aGlzLmJpbmRpbmdEYXRhLmNoYW5nZXMuc3Vic2NyaWJlKChjaGFuZ2U6IENoYW5nZSkgPT4ge1xyXG4gICAgICB0aGlzLm9uQmluZGluZ0RhdGFDaGFuZ2UoY2hhbmdlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlj5bmtohiaW5kaW5nZGF0YeWPmOWMluiuoumYhVxyXG4gICAqL1xyXG4gIHByaXZhdGUgdW5SZWdpc3RlckJpbmRpbmdEYXRhQ2hhbmdlRXZlbnQoKSB7XHJcbiAgICBpZiAodGhpcy5iaW5kaW5nRGF0YUNoYW5nZUV2ZW50ICYmIHR5cGVvZiAodGhpcy5iaW5kaW5nRGF0YUNoYW5nZUV2ZW50LnVuc3Vic2NyaWJlKSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICB0aGlzLmJpbmRpbmdEYXRhQ2hhbmdlRXZlbnQudW5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBsb2FkUGxhY2VtZW50cygpIHtcclxuICAgIGlmICghdGhpcy51cmwpIHtcclxuICAgICAgY29uc29sZS5sb2coJ+aXoOazleWKoOi9veaIv+mXtOS/oeaBr++8jOivt+mFjee9ruaIv+mXtOWIl+ihqGFwaeWcsOWdgCcpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXF1ZXN0SW5mbyA9IHRoaXMucmVzdFNlcnZpY2UoKS5idWlsZFJlcXVlc3RJbmZvKCk7XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBib2R5OiB7XHJcbiAgICAgICAgcmVxdWVzdEluZm9cclxuICAgICAgfVxyXG4gICAgfTtcclxuICAgIGNvbnN0IHVybCA9IEJhc2VQYXRoU2VydmljZS5jb252ZXJ0UGF0aCh0aGlzLnVybCk7XHJcbiAgICB0aGlzLnJlc3RTZXJ2aWNlKCkucmVxdWVzdCh1cmwsIHRoaXMubWV0aG9kLCBudWxsLCBvcHRpb25zKS5zdWJzY3JpYmUoKHJldHVyblZhbHVlOiBhbnkpID0+IHtcclxuICAgICAgdGhpcy5iaW5kUGxhY2VtZW50cyhyZXR1cm5WYWx1ZSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHJpdmF0ZSBiaW5kUGxhY2VtZW50cyhwbGFjbWVudHM6IGFueSkge1xyXG4gICAgdGhpcy5jYWxlbmRhckNvbXBvbmVudC5sb2FkUGxhY2VEYXRhKHBsYWNtZW50cyk7XHJcbiAgfVxyXG4gIHByaXZhdGUgdXBkYXRlU3RhdGUoc3RhcnREYXRlOiBzdHJpbmcsIGVuZERhdGU6IHN0cmluZywgdmlld1R5cGU6IHN0cmluZykge1xyXG4gICAgdGhpcy52aWV3TW9kZWwudWlTdGF0ZS5zZXRQcm9wZXJ0eVZhbHVlKHRoaXMuc3RhcnREYXRlVmFyaWFibGUsIHN0YXJ0RGF0ZSk7XHJcbiAgICB0aGlzLnZpZXdNb2RlbC51aVN0YXRlLnNldFByb3BlcnR5VmFsdWUodGhpcy5lbmREYXRlVmFyaWFibGUsIGVuZERhdGUpO1xyXG4gICAgdGhpcy52aWV3TW9kZWwudWlTdGF0ZS5zZXRQcm9wZXJ0eVZhbHVlKHRoaXMudmlld1R5cGVWYXJpYWJsZSwgdmlld1R5cGUpO1xyXG4gIH1cclxuICBwcml2YXRlIHVwZGF0ZVNlbGVjdGVkUm93KGNoYW5nZT86IENoYW5nZSkge1xyXG4gICAgaWYgKCF0aGlzLmJpbmRpbmdMaXN0IHx8ICF0aGlzLmJpbmRpbmdMaXN0LmN1cnJlbnRJZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDpobXnoIHliIfmjaLml7bkuI3miafooYzlvZPliY3ooYzliIfmjaJcclxuICAgIGlmIChjaGFuZ2UgJiYgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuUGFnaW5hdGlvbkluZm9DaGFuZ2UpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMudmlld01vZGVsICYmIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5yb3dTZWxlY3RlZEV2ZW50U3VzcGVuZCA9PT0gdHJ1ZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBpZCA9IHRoaXMuY2FsZW5kYXJDb21wb25lbnQuc2VsZWN0ZWRJZDtcclxuICAgIGNvbnN0IGN1cnJlbnRJZCA9IHRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkO1xyXG4gICAgLy8gZ3JpZOW9k+WJjeihjOS4jmJpbmdpbmdMaXN05b2T5YmN6KGM5LiA6Ie077yM5peg6aG75YiH5o2iXHJcbiAgICBpZiAoaWQgPT09IGN1cnJlbnRJZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLnNlbGVjdENhbGVuZGFyUm93KHRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBzZWxlY3RDYWxlbmRhclJvdyhpZDogc3RyaW5nKSB7XHJcbiAgICB0aGlzLmNhbGVuZGFyQ29tcG9uZW50LnNlbGVjdEl0ZW0oaWQpO1xyXG4gIH1cclxuICBASG9zdExpc3RlbmVyKCdmaWx0ZXJDaGFuZ2UnLCBbJyRldmVudCddKVxyXG4gIHB1YmxpYyBmaWx0ZXJDaGFuZ2VkKGV2ZW50OiBhbnkpIHtcclxuICAgIGNvbnN0IHsgZGF0ZVZhbHVlID0gbnVsbCwgcGxhY2UgPSBudWxsLCB2aWV3VHlwZSA9IG51bGwgfSA9IGV2ZW50IHx8IHt9O1xyXG4gICAgbGV0IHN0YXJ0RGF0ZSA9IG51bGw7XHJcbiAgICBsZXQgZW5kRGF0ZSA9IG51bGw7XHJcbiAgICBpZiAoIWRhdGVWYWx1ZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAodmlld1R5cGUgPT09IFZpZXdUeXBlLmRheSkge1xyXG4gICAgICBzdGFydERhdGUgPSBgJHtkYXRlVmFsdWV9IDAwOjAwOjAwYDtcclxuICAgICAgZW5kRGF0ZSA9IGAke2RhdGVWYWx1ZX0gMjM6NTk6NTlgO1xyXG4gICAgfSBlbHNlIGlmICh2aWV3VHlwZSA9PT0gVmlld1R5cGUud2VlayAmJiBkYXRlVmFsdWUuaW5kZXhPZignficpICE9PSAtMSkge1xyXG4gICAgICBjb25zdCBzZWN0aW9ucyA9IGRhdGVWYWx1ZS5zcGxpdCgnficpO1xyXG4gICAgICBzdGFydERhdGUgPSBgJHtzZWN0aW9uc1swXX0gMDA6MDA6MDBgO1xyXG4gICAgICBlbmREYXRlID0gYCR7c2VjdGlvbnNbMV19IDIzOjU5OjU5YDtcclxuICAgIH1cclxuICAgIHRoaXMudXBkYXRlU3RhdGUoc3RhcnREYXRlLCBlbmREYXRlLCB2aWV3VHlwZSk7XHJcbiAgfVxyXG4gIHByb3RlY3RlZCBzZXRTZWxlY3Rpb25JZFRvQmluZGluZ0RhdGEoaWQ6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgLy8g5aaC5p6c5b2T5YmN6KGM5LiN5a2Y5Zyo77yM5YiZ5by65Yi26K6+572uXHJcbiAgICBpZiAodGhpcy5iaW5kaW5nTGlzdC5jdXJyZW50SWQgIT09IGlkKSB7XHJcbiAgICAgIHRoaXMuYmluZGluZ0xpc3Quc2V0Q3VycmVudElkKGlkLCB0cnVlKTtcclxuICAgIH1cclxuICB9XHJcbiAgQEhvc3RMaXN0ZW5lcignc2VsZWN0Q2hhbmdlJywgWyckZXZlbnQnXSlcclxuICBwdWJsaWMgc2VsZWN0Q2hhbmdlKGV2ZW50KSB7XHJcbiAgICBjb25zdCB7IGl0ZW06IHsgaWQgPSBudWxsIH0gfSA9IGV2ZW50O1xyXG4gICAgdGhpcy5zZXRTZWxlY3Rpb25JZFRvQmluZGluZ0RhdGEoaWQpO1xyXG4gIH1cclxufVxyXG4iXX0=