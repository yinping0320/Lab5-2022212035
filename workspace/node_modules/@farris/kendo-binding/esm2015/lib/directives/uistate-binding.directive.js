import { Directive, Input, HostListener, Self, Host, Optional, Output, EventEmitter, KeyValueDiffers } from '@angular/core';
import { ComboBoxComponent } from '@progress/kendo-angular-dropdowns';
import { LookupGridComponent } from '@farris/ui-lookup';
import { ComboListComponent } from '@farris/ui-combo-list';
import { ComboLookupComponent } from '@farris/ui-combo-lookup';
export class UIStateBindingDirective {
    constructor(hostComboComponent, hostHelpComponent, differs, hostComboListComponent, hostComboLookupComponent) {
        this.hostComboComponent = hostComboComponent;
        this.hostHelpComponent = hostHelpComponent;
        this.differs = differs;
        this.hostComboListComponent = hostComboListComponent;
        this.hostComboLookupComponent = hostComboLookupComponent;
        this.defaultSpliter = ',';
        this.differ = null;
        this.UIStateBindingChange = new EventEmitter();
    }
    set bindingObject(value) {
        this._bindingObject = value;
        if (!this.differ && value && this.differs && typeof (value) === 'object') {
            this.differ = this.differs.find(value).create();
        }
    }
    get bindingObject() {
        return this._bindingObject;
    }
    onValueChange(val) {
        // host is combobox
        if (this.hostComboComponent && this.bindingObject) {
            if (val) {
                this.bindingObject.key = val.value;
                this.bindingObject.value = val.name;
            }
            else {
                this.bindingObject.key = null;
                this.bindingObject.value = null;
            }
        }
    }
    ngOnInit() {
        if (this.hostComboComponent) {
            this.hostComboComponent.valuePrimitive = false;
        }
        else if (this.hostHelpComponent) {
            this.bindObjectToHostLookup();
        }
        else if (this.hostComboListComponent) {
            this.bindObjectToHostComboList();
        }
        else if (this.hostComboLookupComponent) {
            this.bindObjectToHostComboLookup();
        }
    }
    ngDoCheck() {
        if (this.differ && typeof (this.bindingObject) === 'object') {
            const changes = this.differ && this.differ.diff(this.bindingObject);
            if (changes) {
                this.bindingChanges();
            }
        }
        else { // 兼容未重新编译工程，differ不存在从情况
            this.bindingChanges();
        }
    }
    bindingChanges() {
        const text = this.bindingObject ? this.bindingObject.value : null;
        const key = this.bindingObject ? this.bindingObject.key : null;
        if (this.hostComboComponent) {
            this.hostComboComponent.text = text;
            const vField = this.hostComboComponent.valueField;
            const item = this.hostComboComponent.data.find((n) => n[vField] === key);
            this.hostComboComponent.writeValue(item);
        }
        else if (this.hostHelpComponent) {
            this.hostHelpComponent.writeValue(text);
            this.hostHelpComponent.displayValue = key;
        }
        else if (this.hostComboListComponent) {
            this.hostComboListComponent.writeValue(key);
        }
        else if (this.hostComboLookupComponent) {
            this.hostComboLookupComponent.selectedValues = key;
            this.hostComboLookupComponent.writeValue(text);
        }
    }
    ngOnChanges(changes) {
        if (changes.bindingObject && !this.differ) {
            this.bindingChanges();
        }
    }
    // 弹出帮助
    bindObjectToHostLookup() {
        if (!this.hostHelpComponent) {
            return;
        }
        this.hostHelpComponent.selectedData.subscribe((data) => this.updateHelpBindingObject(data));
        this.hostHelpComponent.clear.subscribe(() => {
            // this.bindingObject = {key: null, value: null};
            this.updateHelpBindingObject(null);
        });
        if (this.hostHelpComponent.tagRemoved) {
            this.hostHelpComponent.tagRemoved.subscribe((event) => {
                const { removedIndex: index = -1, instance: componentRef = null } = event;
                if (index === -1) {
                    return;
                }
                const isSigleSelect = componentRef.singleSelect;
                if (isSigleSelect || !componentRef.displayValue) {
                    this.updateHelpBindingObject(null);
                }
                else {
                    this.UIStateBindingChange.emit({ key: componentRef.displayValue, value: componentRef.displayText });
                }
            });
        }
        if (this.hostHelpComponent.nosearch) {
            this.hostHelpComponent.valueChanged.subscribe((txt) => {
                const idField = this.hostHelpComponent.idField;
                const textField = this.hostHelpComponent.textField;
                this.updateHelpBindingObject({
                    [idField]: txt,
                    [textField]: txt
                });
            });
        }
    }
    // 下拉列表
    bindObjectToHostComboList() {
        if (!this.hostComboListComponent) {
            return;
        }
        this.hostComboListComponent.valueChange.subscribe((data) => this.updateHelpBindingObject(data.selections));
        this.hostComboListComponent.clear.subscribe(() => {
            this.updateHelpBindingObject(null);
        });
    }
    // 下拉帮助
    bindObjectToHostComboLookup() {
        if (!this.hostComboLookupComponent) {
            return;
        }
        if (this.hostComboLookupComponent.multiSelect) {
            this.hostComboLookupComponent.valueChange.subscribe((data) => this.updateHelpBindingObject(data.selections));
        }
        else {
            // this.hostComboLookupComponent.selectChange.subscribe((data: any) => this.updateHelpBindingObject(data));
            this.hostComboLookupComponent.selectChange.subscribe((e) => {
                let data = e;
                if (e.data) {
                    data = e.data;
                }
                this.updateHelpBindingObject(data);
            });
        }
        this.hostComboLookupComponent.clear.subscribe(() => {
            this.updateHelpBindingObject(null);
        });
    }
    // 更新UISTATE
    updateHelpBindingObject(data) {
        let idField;
        let textField;
        let spliter = this.defaultSpliter;
        if (this.hostHelpComponent) {
            idField = this.hostHelpComponent.idField;
            textField = this.hostHelpComponent.textField;
            spliter = this.hostHelpComponent.multipleChoiceSeparator || this.defaultSpliter;
        }
        if (this.hostComboListComponent) {
            idField = this.hostComboListComponent.idField;
            textField = this.hostComboListComponent.textField;
        }
        if (this.hostComboLookupComponent) {
            idField = this.hostComboLookupComponent.idField;
            textField = this.hostComboLookupComponent.textField;
            spliter = this.hostComboLookupComponent.separator || this.defaultSpliter;
        }
        this.emitUiStateBinding(data, idField, textField, spliter);
    }
    emitUiStateBinding(data, idField, textField, spliter = ',') {
        const newObject = { key: null, value: null };
        if (data) {
            // const idField = this.hostHelpComponent.idField;
            // const textField = this.hostHelpComponent.textField;
            if (Array.isArray(data)) {
                newObject.key = data.map((d) => d[idField]).join(spliter);
                newObject.value = data.map((d) => {
                    if (textField.indexOf('.') > -1) {
                        return textField.split('.').reduce((r, c) => {
                            return r[c];
                        }, d);
                    }
                    else {
                        return d[textField];
                    }
                }).join(spliter);
            }
            else {
                if (idField) {
                    newObject.key = data[idField];
                }
                if (textField) {
                    if (textField.indexOf('.') > -1) {
                        newObject.value = textField.split('.').reduce((r, c) => {
                            return r[c];
                        }, data);
                    }
                    else {
                        newObject.value = data[textField];
                    }
                }
            }
        }
        this.UIStateBindingChange.emit(newObject);
    }
}
UIStateBindingDirective.decorators = [
    { type: Directive, args: [{
                selector: '[UIStateBinding]'
            },] }
];
/** @nocollapse */
UIStateBindingDirective.ctorParameters = () => [
    { type: ComboBoxComponent, decorators: [{ type: Host }, { type: Self }, { type: Optional }] },
    { type: LookupGridComponent, decorators: [{ type: Host }, { type: Self }, { type: Optional }] },
    { type: KeyValueDiffers, decorators: [{ type: Optional }] },
    { type: ComboListComponent, decorators: [{ type: Host }, { type: Self }, { type: Optional }] },
    { type: ComboLookupComponent, decorators: [{ type: Host }, { type: Self }, { type: Optional }] }
];
UIStateBindingDirective.propDecorators = {
    bindingObject: [{ type: Input, args: ['UIStateBinding',] }],
    UIStateBindingChange: [{ type: Output }],
    onValueChange: [{ type: HostListener, args: ['valueChange', ['$event'],] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidWlzdGF0ZS1iaW5kaW5nLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMva2VuZG8tYmluZGluZy8iLCJzb3VyY2VzIjpbImxpYi9kaXJlY3RpdmVzL3Vpc3RhdGUtYmluZGluZy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQVUsWUFBWSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQXFELGVBQWUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2TCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUN0RSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUsvRCxNQUFNLE9BQU8sdUJBQXVCO0lBK0JsQyxZQUNzQyxrQkFBcUMsRUFDckMsaUJBQXNDLEVBQ3RELE9BQXdCLEVBQ1Isc0JBQTBDLEVBQzFDLHdCQUE4QztRQUo5Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW1CO1FBQ3JDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBcUI7UUFDdEQsWUFBTyxHQUFQLE9BQU8sQ0FBaUI7UUFDUiwyQkFBc0IsR0FBdEIsc0JBQXNCLENBQW9CO1FBQzFDLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBc0I7UUFsQ25FLG1CQUFjLEdBQUcsR0FBRyxDQUFDO1FBQzlCLFdBQU0sR0FBNkIsSUFBSSxDQUFDO1FBWXRDLHlCQUFvQixHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO0lBc0J4RSxDQUFDO0lBaENMLElBQ0ksYUFBYSxDQUFDLEtBQVU7UUFDMUIsSUFBSSxDQUFDLGNBQWMsR0FBRyxLQUFLLENBQUM7UUFDNUIsSUFB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LFNBQVMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO3FCQUNuQztpQkFDRjthQUNGO1NBQ0Y7UUFDRCxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzVDLENBQUM7OztZQTdORixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLGtCQUFrQjthQUM3Qjs7OztZQVBRLGlCQUFpQix1QkF3Q3JCLElBQUksWUFBSSxJQUFJLFlBQUksUUFBUTtZQXZDcEIsbUJBQW1CLHVCQXdDdkIsSUFBSSxZQUFJLElBQUksWUFBSSxRQUFRO1lBMUNtSCxlQUFlLHVCQTJDMUosUUFBUTtZQXhDSixrQkFBa0IsdUJBeUN0QixJQUFJLFlBQUksSUFBSSxZQUFJLFFBQVE7WUF4Q3BCLG9CQUFvQix1QkF5Q3hCLElBQUksWUFBSSxJQUFJLFlBQUksUUFBUTs7OzRCQS9CMUIsS0FBSyxTQUFDLGdCQUFnQjttQ0FVdEIsTUFBTTs0QkFFTixZQUFZLFNBQUMsYUFBYSxFQUFFLENBQUMsUUFBUSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBJbnB1dCwgT25Jbml0LCBIb3N0TGlzdGVuZXIsIFNlbGYsIEhvc3QsIE9wdGlvbmFsLCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzLCBEb0NoZWNrLCBLZXlWYWx1ZURpZmZlciwgS2V5VmFsdWVEaWZmZXJzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IENvbWJvQm94Q29tcG9uZW50IH0gZnJvbSAnQHByb2dyZXNzL2tlbmRvLWFuZ3VsYXItZHJvcGRvd25zJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktbG9va3VwJztcclxuaW1wb3J0IHsgQ29tYm9MaXN0Q29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1jb21iby1saXN0JztcclxuaW1wb3J0IHsgQ29tYm9Mb29rdXBDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWNvbWJvLWxvb2t1cCc7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1tVSVN0YXRlQmluZGluZ10nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBVSVN0YXRlQmluZGluZ0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBEb0NoZWNrIHtcclxuICBwcml2YXRlIF9iaW5kaW5nT2JqZWN0OiBhbnk7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0U3BsaXRlciA9ICcsJztcclxuICBwcml2YXRlIGRpZmZlcjogS2V5VmFsdWVEaWZmZXI8YW55LCBhbnk+ID0gbnVsbDtcclxuXHJcbiAgQElucHV0KCdVSVN0YXRlQmluZGluZycpXHJcbiAgc2V0IGJpbmRpbmdPYmplY3QodmFsdWU6IGFueSkge1xyXG4gICAgdGhpcy5fYmluZGluZ09iamVjdCA9IHZhbHVlO1xyXG4gICAgaWYgKCF0aGlzLmRpZmZlciAmJiB2YWx1ZSAmJiB0aGlzLmRpZmZlcnMgJiYgdHlwZW9mICh2YWx1ZSkgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgIHRoaXMuZGlmZmVyID0gdGhpcy5kaWZmZXJzLmZpbmQodmFsdWUpLmNyZWF0ZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuICBnZXQgYmluZGluZ09iamVjdCgpIHtcclxuICAgIHJldHVybiB0aGlzLl9iaW5kaW5nT2JqZWN0O1xyXG4gIH1cclxuICBAT3V0cHV0KCkgVUlTdGF0ZUJpbmRpbmdDaGFuZ2U6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ3ZhbHVlQ2hhbmdlJywgWyckZXZlbnQnXSlcclxuICBvblZhbHVlQ2hhbmdlKHZhbDogYW55KSB7XHJcbiAgICAvLyBob3N0IGlzIGNvbWJvYm94XHJcbiAgICBpZiAodGhpcy5ob3N0Q29tYm9Db21wb25lbnQgJiYgdGhpcy5iaW5kaW5nT2JqZWN0KSB7XHJcbiAgICAgIGlmICh2YWwpIHtcclxuICAgICAgICB0aGlzLmJpbmRpbmdPYmplY3Qua2V5ID0gdmFsLnZhbHVlO1xyXG4gICAgICAgIHRoaXMuYmluZGluZ09iamVjdC52YWx1ZSA9IHZhbC5uYW1lO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuYmluZGluZ09iamVjdC5rZXkgPSBudWxsO1xyXG4gICAgICAgIHRoaXMuYmluZGluZ09iamVjdC52YWx1ZSA9IG51bGw7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgQEhvc3QoKSBAU2VsZigpIEBPcHRpb25hbCgpIHByaXZhdGUgaG9zdENvbWJvQ29tcG9uZW50OiBDb21ib0JveENvbXBvbmVudCxcclxuICAgIEBIb3N0KCkgQFNlbGYoKSBAT3B0aW9uYWwoKSBwcml2YXRlIGhvc3RIZWxwQ29tcG9uZW50OiBMb29rdXBHcmlkQ29tcG9uZW50LFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBkaWZmZXJzOiBLZXlWYWx1ZURpZmZlcnMsXHJcbiAgICBASG9zdCgpIEBTZWxmKCkgQE9wdGlvbmFsKCkgcHJpdmF0ZSBob3N0Q29tYm9MaXN0Q29tcG9uZW50OiBDb21ib0xpc3RDb21wb25lbnQsXHJcbiAgICBASG9zdCgpIEBTZWxmKCkgQE9wdGlvbmFsKCkgcHJpdmF0ZSBob3N0Q29tYm9Mb29rdXBDb21wb25lbnQ6IENvbWJvTG9va3VwQ29tcG9uZW50XHJcbiAgKSB7IH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICBpZiAodGhpcy5ob3N0Q29tYm9Db21wb25lbnQpIHtcclxuICAgICAgdGhpcy5ob3N0Q29tYm9Db21wb25lbnQudmFsdWVQcmltaXRpdmUgPSBmYWxzZTtcclxuICAgIH0gZWxzZSBpZiAodGhpcy5ob3N0SGVscENvbXBvbmVudCkge1xyXG4gICAgICB0aGlzLmJpbmRPYmplY3RUb0hvc3RMb29rdXAoKTtcclxuICAgIH0gZWxzZSBpZiAodGhpcy5ob3N0Q29tYm9MaXN0Q29tcG9uZW50KSB7XHJcbiAgICAgIHRoaXMuYmluZE9iamVjdFRvSG9zdENvbWJvTGlzdCgpO1xyXG4gICAgfSBlbHNlIGlmICh0aGlzLmhvc3RDb21ib0xvb2t1cENvbXBvbmVudCkge1xyXG4gICAgICB0aGlzLmJpbmRPYmplY3RUb0hvc3RDb21ib0xvb2t1cCgpO1xyXG4gICAgfVxyXG4gIH1cclxuICBuZ0RvQ2hlY2soKSB7XHJcbiAgICBpZiAodGhpcy5kaWZmZXIgJiYgdHlwZW9mICh0aGlzLmJpbmRpbmdPYmplY3QpID09PSAnb2JqZWN0Jykge1xyXG4gICAgICBjb25zdCBjaGFuZ2VzID0gdGhpcy5kaWZmZXIgJiYgdGhpcy5kaWZmZXIuZGlmZih0aGlzLmJpbmRpbmdPYmplY3QpO1xyXG4gICAgICBpZiAoY2hhbmdlcykge1xyXG4gICAgICAgIHRoaXMuYmluZGluZ0NoYW5nZXMoKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHsgLy8g5YW85a655pyq6YeN5paw57yW6K+R5bel56iL77yMZGlmZmVy5LiN5a2Y5Zyo5LuO5oOF5Ya1XHJcbiAgICAgIHRoaXMuYmluZGluZ0NoYW5nZXMoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgYmluZGluZ0NoYW5nZXMoKSB7XHJcbiAgICBjb25zdCB0ZXh0ID0gdGhpcy5iaW5kaW5nT2JqZWN0ID8gdGhpcy5iaW5kaW5nT2JqZWN0LnZhbHVlIDogbnVsbDtcclxuICAgIGNvbnN0IGtleSA9IHRoaXMuYmluZGluZ09iamVjdCA/IHRoaXMuYmluZGluZ09iamVjdC5rZXkgOiBudWxsO1xyXG4gICAgaWYgKHRoaXMuaG9zdENvbWJvQ29tcG9uZW50KSB7XHJcbiAgICAgIHRoaXMuaG9zdENvbWJvQ29tcG9uZW50LnRleHQgPSB0ZXh0O1xyXG4gICAgICBjb25zdCB2RmllbGQgPSB0aGlzLmhvc3RDb21ib0NvbXBvbmVudC52YWx1ZUZpZWxkO1xyXG4gICAgICBjb25zdCBpdGVtID0gdGhpcy5ob3N0Q29tYm9Db21wb25lbnQuZGF0YS5maW5kKChuKSA9PiBuW3ZGaWVsZF0gPT09IGtleSk7XHJcbiAgICAgIHRoaXMuaG9zdENvbWJvQ29tcG9uZW50LndyaXRlVmFsdWUoaXRlbSk7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuaG9zdEhlbHBDb21wb25lbnQpIHtcclxuICAgICAgdGhpcy5ob3N0SGVscENvbXBvbmVudC53cml0ZVZhbHVlKHRleHQpO1xyXG4gICAgICB0aGlzLmhvc3RIZWxwQ29tcG9uZW50LmRpc3BsYXlWYWx1ZSA9IGtleTtcclxuICAgIH0gZWxzZSBpZiAodGhpcy5ob3N0Q29tYm9MaXN0Q29tcG9uZW50KSB7XHJcbiAgICAgIHRoaXMuaG9zdENvbWJvTGlzdENvbXBvbmVudC53cml0ZVZhbHVlKGtleSk7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuaG9zdENvbWJvTG9va3VwQ29tcG9uZW50KSB7XHJcbiAgICAgIHRoaXMuaG9zdENvbWJvTG9va3VwQ29tcG9uZW50LnNlbGVjdGVkVmFsdWVzID0ga2V5O1xyXG4gICAgICB0aGlzLmhvc3RDb21ib0xvb2t1cENvbXBvbmVudC53cml0ZVZhbHVlKHRleHQpO1xyXG4gICAgfVxyXG4gIH1cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XHJcbiAgICBpZiAoY2hhbmdlcy5iaW5kaW5nT2JqZWN0ICYmICF0aGlzLmRpZmZlcikge1xyXG4gICAgICB0aGlzLmJpbmRpbmdDaGFuZ2VzKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyDlvLnlh7rluK7liqlcclxuICBwcml2YXRlIGJpbmRPYmplY3RUb0hvc3RMb29rdXAoKSB7XHJcbiAgICBpZiAoIXRoaXMuaG9zdEhlbHBDb21wb25lbnQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuaG9zdEhlbHBDb21wb25lbnQuc2VsZWN0ZWREYXRhLnN1YnNjcmliZSgoZGF0YTogYW55KSA9PiB0aGlzLnVwZGF0ZUhlbHBCaW5kaW5nT2JqZWN0KGRhdGEpKTtcclxuXHJcbiAgICB0aGlzLmhvc3RIZWxwQ29tcG9uZW50LmNsZWFyLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgIC8vIHRoaXMuYmluZGluZ09iamVjdCA9IHtrZXk6IG51bGwsIHZhbHVlOiBudWxsfTtcclxuICAgICAgdGhpcy51cGRhdGVIZWxwQmluZGluZ09iamVjdChudWxsKTtcclxuICAgIH0pO1xyXG4gICAgaWYgKHRoaXMuaG9zdEhlbHBDb21wb25lbnQudGFnUmVtb3ZlZCkge1xyXG4gICAgICB0aGlzLmhvc3RIZWxwQ29tcG9uZW50LnRhZ1JlbW92ZWQuc3Vic2NyaWJlKChldmVudDogeyByZW1vdmVkSW5kZXg6IG51bWJlciwgaW5zdGFuY2U6IExvb2t1cEdyaWRDb21wb25lbnQgfSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHsgcmVtb3ZlZEluZGV4OiBpbmRleCA9IC0xLCBpbnN0YW5jZTogY29tcG9uZW50UmVmID0gbnVsbCB9ID0gZXZlbnQ7XHJcbiAgICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBpc1NpZ2xlU2VsZWN0ID0gY29tcG9uZW50UmVmLnNpbmdsZVNlbGVjdDtcclxuICAgICAgICBpZiAoaXNTaWdsZVNlbGVjdCB8fCAhY29tcG9uZW50UmVmLmRpc3BsYXlWYWx1ZSkge1xyXG4gICAgICAgICAgdGhpcy51cGRhdGVIZWxwQmluZGluZ09iamVjdChudWxsKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5VSVN0YXRlQmluZGluZ0NoYW5nZS5lbWl0KHsga2V5OiBjb21wb25lbnRSZWYuZGlzcGxheVZhbHVlLCB2YWx1ZTogY29tcG9uZW50UmVmLmRpc3BsYXlUZXh0IH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5ob3N0SGVscENvbXBvbmVudC5ub3NlYXJjaCkge1xyXG4gICAgICB0aGlzLmhvc3RIZWxwQ29tcG9uZW50LnZhbHVlQ2hhbmdlZC5zdWJzY3JpYmUoKHR4dDogYW55KSA9PiB7XHJcbiAgICAgICAgY29uc3QgaWRGaWVsZCA9IHRoaXMuaG9zdEhlbHBDb21wb25lbnQuaWRGaWVsZDtcclxuICAgICAgICBjb25zdCB0ZXh0RmllbGQgPSB0aGlzLmhvc3RIZWxwQ29tcG9uZW50LnRleHRGaWVsZDtcclxuICAgICAgICB0aGlzLnVwZGF0ZUhlbHBCaW5kaW5nT2JqZWN0KHtcclxuICAgICAgICAgIFtpZEZpZWxkXTogdHh0LFxyXG4gICAgICAgICAgW3RleHRGaWVsZF06IHR4dFxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOS4i+aLieWIl+ihqFxyXG4gIHByaXZhdGUgYmluZE9iamVjdFRvSG9zdENvbWJvTGlzdCgpIHtcclxuICAgIGlmICghdGhpcy5ob3N0Q29tYm9MaXN0Q29tcG9uZW50KSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmhvc3RDb21ib0xpc3RDb21wb25lbnQudmFsdWVDaGFuZ2Uuc3Vic2NyaWJlKChkYXRhOiBhbnkpID0+IHRoaXMudXBkYXRlSGVscEJpbmRpbmdPYmplY3QoZGF0YS5zZWxlY3Rpb25zKSk7XHJcblxyXG4gICAgdGhpcy5ob3N0Q29tYm9MaXN0Q29tcG9uZW50LmNsZWFyLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgIHRoaXMudXBkYXRlSGVscEJpbmRpbmdPYmplY3QobnVsbCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8vIOS4i+aLieW4ruWKqVxyXG4gIHByaXZhdGUgYmluZE9iamVjdFRvSG9zdENvbWJvTG9va3VwKCkge1xyXG4gICAgaWYgKCF0aGlzLmhvc3RDb21ib0xvb2t1cENvbXBvbmVudCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuaG9zdENvbWJvTG9va3VwQ29tcG9uZW50Lm11bHRpU2VsZWN0KSB7XHJcbiAgICAgIHRoaXMuaG9zdENvbWJvTG9va3VwQ29tcG9uZW50LnZhbHVlQ2hhbmdlLnN1YnNjcmliZSgoZGF0YTogYW55KSA9PiB0aGlzLnVwZGF0ZUhlbHBCaW5kaW5nT2JqZWN0KGRhdGEuc2VsZWN0aW9ucykpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gdGhpcy5ob3N0Q29tYm9Mb29rdXBDb21wb25lbnQuc2VsZWN0Q2hhbmdlLnN1YnNjcmliZSgoZGF0YTogYW55KSA9PiB0aGlzLnVwZGF0ZUhlbHBCaW5kaW5nT2JqZWN0KGRhdGEpKTtcclxuICAgICAgdGhpcy5ob3N0Q29tYm9Mb29rdXBDb21wb25lbnQuc2VsZWN0Q2hhbmdlLnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgbGV0IGRhdGEgPSBlO1xyXG4gICAgICAgIGlmIChlLmRhdGEpIHtcclxuICAgICAgICAgIGRhdGEgPSBlLmRhdGE7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMudXBkYXRlSGVscEJpbmRpbmdPYmplY3QoZGF0YSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuaG9zdENvbWJvTG9va3VwQ29tcG9uZW50LmNsZWFyLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgIHRoaXMudXBkYXRlSGVscEJpbmRpbmdPYmplY3QobnVsbCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8vIOabtOaWsFVJU1RBVEVcclxuICBwcml2YXRlIHVwZGF0ZUhlbHBCaW5kaW5nT2JqZWN0KGRhdGE6IGFueSkge1xyXG4gICAgbGV0IGlkRmllbGQ7XHJcbiAgICBsZXQgdGV4dEZpZWxkO1xyXG4gICAgbGV0IHNwbGl0ZXI6IHN0cmluZyA9IHRoaXMuZGVmYXVsdFNwbGl0ZXI7XHJcbiAgICBpZiAodGhpcy5ob3N0SGVscENvbXBvbmVudCkge1xyXG4gICAgICBpZEZpZWxkID0gdGhpcy5ob3N0SGVscENvbXBvbmVudC5pZEZpZWxkO1xyXG4gICAgICB0ZXh0RmllbGQgPSB0aGlzLmhvc3RIZWxwQ29tcG9uZW50LnRleHRGaWVsZDtcclxuICAgICAgc3BsaXRlciA9IHRoaXMuaG9zdEhlbHBDb21wb25lbnQubXVsdGlwbGVDaG9pY2VTZXBhcmF0b3IgfHwgdGhpcy5kZWZhdWx0U3BsaXRlcjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5ob3N0Q29tYm9MaXN0Q29tcG9uZW50KSB7XHJcbiAgICAgIGlkRmllbGQgPSB0aGlzLmhvc3RDb21ib0xpc3RDb21wb25lbnQuaWRGaWVsZDtcclxuICAgICAgdGV4dEZpZWxkID0gdGhpcy5ob3N0Q29tYm9MaXN0Q29tcG9uZW50LnRleHRGaWVsZDtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5ob3N0Q29tYm9Mb29rdXBDb21wb25lbnQpIHtcclxuICAgICAgaWRGaWVsZCA9IHRoaXMuaG9zdENvbWJvTG9va3VwQ29tcG9uZW50LmlkRmllbGQ7XHJcbiAgICAgIHRleHRGaWVsZCA9IHRoaXMuaG9zdENvbWJvTG9va3VwQ29tcG9uZW50LnRleHRGaWVsZDtcclxuICAgICAgc3BsaXRlciA9IHRoaXMuaG9zdENvbWJvTG9va3VwQ29tcG9uZW50LnNlcGFyYXRvciB8fCB0aGlzLmRlZmF1bHRTcGxpdGVyO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuZW1pdFVpU3RhdGVCaW5kaW5nKGRhdGEsIGlkRmllbGQsIHRleHRGaWVsZCwgc3BsaXRlcik7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGVtaXRVaVN0YXRlQmluZGluZyhkYXRhLCBpZEZpZWxkLCB0ZXh0RmllbGQsIHNwbGl0ZXI6IHN0cmluZyA9ICcsJykge1xyXG4gICAgY29uc3QgbmV3T2JqZWN0ID0geyBrZXk6IG51bGwsIHZhbHVlOiBudWxsIH07XHJcbiAgICBpZiAoZGF0YSkge1xyXG4gICAgICAvLyBjb25zdCBpZEZpZWxkID0gdGhpcy5ob3N0SGVscENvbXBvbmVudC5pZEZpZWxkO1xyXG4gICAgICAvLyBjb25zdCB0ZXh0RmllbGQgPSB0aGlzLmhvc3RIZWxwQ29tcG9uZW50LnRleHRGaWVsZDtcclxuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHtcclxuICAgICAgICBuZXdPYmplY3Qua2V5ID0gZGF0YS5tYXAoKGQpID0+IGRbaWRGaWVsZF0pLmpvaW4oc3BsaXRlcik7XHJcbiAgICAgICAgbmV3T2JqZWN0LnZhbHVlID0gZGF0YS5tYXAoKGQpID0+IHtcclxuICAgICAgICAgIGlmICh0ZXh0RmllbGQuaW5kZXhPZignLicpID4gLTEpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRleHRGaWVsZC5zcGxpdCgnLicpLnJlZHVjZSgociwgYykgPT4ge1xyXG4gICAgICAgICAgICAgIHJldHVybiByW2NdO1xyXG4gICAgICAgICAgICB9LCBkKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBkW3RleHRGaWVsZF07XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSkuam9pbihzcGxpdGVyKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoaWRGaWVsZCkge1xyXG4gICAgICAgICAgbmV3T2JqZWN0LmtleSA9IGRhdGFbaWRGaWVsZF07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGV4dEZpZWxkKSB7XHJcbiAgICAgICAgICBpZiAodGV4dEZpZWxkLmluZGV4T2YoJy4nKSA+IC0xKSB7XHJcbiAgICAgICAgICAgIG5ld09iamVjdC52YWx1ZSA9IHRleHRGaWVsZC5zcGxpdCgnLicpLnJlZHVjZSgociwgYykgPT4ge1xyXG4gICAgICAgICAgICAgIHJldHVybiByW2NdO1xyXG4gICAgICAgICAgICB9LCBkYXRhKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIG5ld09iamVjdC52YWx1ZSA9IGRhdGFbdGV4dEZpZWxkXTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHRoaXMuVUlTdGF0ZUJpbmRpbmdDaGFuZ2UuZW1pdChuZXdPYmplY3QpO1xyXG4gIH1cclxufVxyXG4iXX0=