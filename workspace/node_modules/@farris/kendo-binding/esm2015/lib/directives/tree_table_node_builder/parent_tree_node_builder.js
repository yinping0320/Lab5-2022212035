/*
 * @Author: aalizzwell
 * @Date: 2019-05-31 09:48:10
 * @Last Modified by: aalizzwell
 * @Last Modified time: 2019-06-24 17:00:58
 */
// tslint:disable: no-string-literal max-line-length
/**
 * 树节点构造器
 * @summary
 * 将BindingData中的数据集合转换成TreeTable节点集合
 */
class ParentTreeNodeBuilder {
    /**
     * 构造函数
     */
    constructor(allNodesData, oldTreeNodes, primaryKey, hierarchyInfoKey, context) {
        /**
         * 等待展开的节点
         * @description 节点结构
         * ```
         * {id:'xxx',expanded:false}
         * ```
         */
        this.nodesWaitExpand = [];
        this.primaryKey = primaryKey;
        this.hierarchyInfoKey = hierarchyInfoKey;
        this.allNodes = [];
        this.allNodesData = allNodesData;
        this.context = context || {};
        this.nodesWaitExpand = [];
        this.nodesShouldExpand = context && context.nodesShouldExpand || [];
        this.frameContext = context && context.frameContext || null;
        this.addTreeLoadCompleteListener(this.onTreeLoadComplete.bind(this));
        this.allNodesMap = new Map();
        this.allOldNodesMap = new Map();
        this.buildNodesDataMap(oldTreeNodes);
    }
    /**
     * 展开至层级
     * @description -1为不展开
     */
    get expandLevel() {
        return this.context && this.context.hasOwnProperty('expandLevel') ? this.context['expandLevel'] : -1;
    }
    get component() {
        return this.context && this.context['component'];
    }
    get addTreeLoadCompleteListener() {
        return this.context && this.context['addTreeLoadCompleteListener'] || function (args) { };
    }
    updateTreeNode(allNodesData, data) {
        this.allNodesData = allNodesData;
        this.buildNodesDataMap(data);
    }
    build() {
        let tree = [];
        const childrenOf = {};
        const parents = {};
        const nodes = {};
        this.allNodesData.forEach(item => {
            const id = item.id;
            const parentId = this.getHierarchyInfo(item).parentElement;
            // item.parentId = parentId;
            // 展开新增节点的父节点
            const isNewNode = this.isNewNode(item);
            if (isNewNode === true) {
                this.expandParentNode(item);
            }
            // 构造树节点
            const node = this.buildNode(item);
            nodes[id] = node;
            childrenOf[id] = childrenOf[id] || [];
            node.children = childrenOf[id];
            parents[parentId] = parents[parentId] || [];
            parents[parentId].push(node);
            this.allNodesMap.set(item[this.primaryKey], node);
            if (parentId) {
                if (nodes[parentId] && nodes[parentId].unstableState === true) {
                    nodes[parentId].expanded = true;
                    nodes[parentId].unstableState = false;
                }
                childrenOf[parentId] = childrenOf[parentId] || [];
                childrenOf[parentId].push(node);
            }
            else {
                if ((!node.children || node.children.length < 1) && node.expanded === true) {
                    node.unstableState = true;
                    node.expanded = false;
                }
                tree.push(node);
            }
        });
        // 所有节点都是parentId，没有返回根节点
        if ((!tree || tree.length < 1) && this.allNodesData && this.allNodesData.length > 0) {
            const parentIds = Object.keys(parents);
            parentIds.forEach(parentId => {
                if (!this.allNodesData.find(item => item.id === parentId)) {
                    tree = tree.concat(parents[parentId]);
                }
            });
        }
        return tree;
    }
    /**
     * 构造树节点
     */
    build1() {
        let minLayer;
        // 获取最顶级节点的layer
        this.allNodesData.forEach(node => {
            const hierarchyInfo = this.getHierarchyInfo(node);
            if (hierarchyInfo) {
                const layer = hierarchyInfo['layer'];
                if (!isNaN(layer)) {
                    if (minLayer === undefined) {
                        minLayer = layer;
                    }
                    else if (layer < minLayer) {
                        minLayer = layer;
                    }
                }
            }
        });
        const topLayer = minLayer - 1;
        this.buildNodes('', topLayer, this.allNodesData, this.allNodes);
        return this.allNodes;
    }
    /**
     * 构造树节点集合
     */
    buildNodes(fParentElement, fLayer, allNodesData, treeNodes) {
        const childNodesData = this.getChildNodesData(fParentElement, fLayer);
        childNodesData.forEach((nodeData) => {
            // 展开新增节点的父节点
            const isNewNode = this.isNewNode(nodeData);
            if (isNewNode === true) {
                this.expandParentNode(nodeData);
            }
            // 构造树节点
            const node = this.buildNode(nodeData);
            treeNodes.push(node);
            this.allNodesMap.set(nodeData[this.primaryKey], node);
            // 递归遍历下级节点
            const hierarchyInfo = this.getHierarchyInfo(nodeData); //nodeData[this.hierarchyInfoKey];
            const currentLayer = hierarchyInfo['layer'];
            const currentId = nodeData[this.primaryKey];
            this.buildNodes(currentId, currentLayer, allNodesData, node.children);
        });
    }
    /**
     * 创建树节点
     */
    buildNode(nodeData) {
        const isLeaf = this.isLeaf(nodeData);
        // 获取节点的展开状态
        const shouldExpand = this.shouldExpand(nodeData);
        // 节点虽然应该展开，但可能是因为之前就是展开状态，所以应该检查节点之前的状态
        const originExpandStatus = this.isExpanded(nodeData);
        // 如果应该展开该节点，但是该节点之前有状态，那么该节点不应该再由程序展开。
        if (!originExpandStatus && shouldExpand) {
            this.expandNode(nodeData);
        }
        const paginationInfo = this.buildPaginationInfo(nodeData);
        const treeNode = {
            data: Object.assign({}, nodeData),
            children: [],
            expanded: shouldExpand,
            leaf: isLeaf
        };
        if (paginationInfo) {
            treeNode.pagination = paginationInfo;
        }
        return treeNode;
    }
    /**
     * 构造分页信息
     * @param nodeData nodeData
     * @returns
     */
    buildPaginationInfo(nodeData) {
        let result = null;
        if (this.frameContext) {
            const id = this.getPrimary(nodeData);
            // 获取分页信息
            const key = `_NODE_${id}_PAGINATION_INFO_`;
            const pagination = this.frameContext.params.get(key) || null;
            if (pagination && pagination.pageCount > 1) {
                result = {
                    pageIndex: pagination.pageIndex,
                    pageSize: pagination.pageSize,
                    total: pagination.totalCount
                };
            }
        }
        return result;
    }
    /**
     * 计算节点是否要展开
     * @param nodeData nodeData
     */
    shouldExpand(nodeData) {
        const [isLeaf, layer] = [this.isLeaf(nodeData), this.getNodeLayer(nodeData)];
        // 永远不展开叶子节点
        if (isLeaf) {
            return false;
        }
        let expanded = this.isExpanded(nodeData);
        if (!expanded) {
            const id = this.getPrimary(nodeData);
            if (this.nodesWaitExpand.findIndex(node => node && node.id === id) > -1) {
                return false;
            }
            if (this.nodesShouldExpand.findIndex(nodeId => nodeId === id) > -1) {
                return true;
            }
            if (this.expandLevel === -1) {
                // -1 为不展开
                expanded = false;
            }
            else if (this.expandLevel === 0) {
                // 0 为全部展开
                expanded = true;
            }
            else {
                // 没有启用分层加载，通过展开层级确定是否展开该节点
                expanded = layer <= this.expandLevel;
                // 如果节点原本存在且节点没有展开则不展开
                const oldTreeNode = this.getOldNode(nodeData);
                if (oldTreeNode && !oldTreeNode.expanded) {
                    expanded = false;
                }
            }
        }
        return expanded;
    }
    /**
     * 展开树节点
     * @description 完全加载树使用展开属性在buildNode时已经展开，此函数的主要用于展开分级加载树
     * @param nodeData nodeData
     */
    expandNode(nodeData) {
        const [element, layer] = [nodeData[this.primaryKey], this.getNodeLayer(nodeData)];
        const childs = this.getChildNodesData(element, layer);
        // 当前节点不是叶子节点，但在节点数据中又找不到该节点的子节点，则认为树启用了分层加载
        if (!childs || childs.length < 1) {
            // 分层加载树需要通过触发节点展开事件才加载下层,目前树上还不存在该节点，无法直接展开，需要等树加载完之后再展开
            const id = this.getPrimary(nodeData);
            if (this.nodesWaitExpand.findIndex(node => node && node.id === id) < 0) {
                this.nodesWaitExpand.push({ id, expanded: false });
            }
        }
    }
    /**
     * 树加载完成事件
     */
    onTreeLoadComplete() {
        const index = this.nodesWaitExpand.findIndex(node => !node.expanded);
        const nodeData = this.nodesWaitExpand[index] || {};
        const { id } = nodeData;
        if (id) {
            const rowNode = this.component.findRowNode(id);
            if (rowNode) {
                nodeData.expanded = true;
                // if (nodeData && nodeData.node && !nodeData.node.expanded) {
                //   return;
                // }
                this.component.expandNode(id);
            }
        }
    }
    /**
     * 获取主键
     * @param nodeData nodeData
     */
    getPrimary(nodeData) {
        return nodeData[this.primaryKey];
    }
    // #region 工具方法，待单独封装
    /**
     * 获取子级节点的数据集合
     */
    getChildNodesData(fParentElement, fLayer) {
        const childNodesData = [];
        this.allNodesData.forEach((nodeData) => {
            // @todo：待删除，兼容没有hierarchyInfo的数据 
            const hierarchyInfo = this.getHierarchyInfo(nodeData); //nodeData[this.hierarchyInfoKey];
            if (!hierarchyInfo) {
                return;
            }
            // 匹配节点
            const currentLayer = hierarchyInfo['layer'];
            const currentParentElement = hierarchyInfo['parentElement'];
            if ((currentLayer === fLayer + 1) && (currentParentElement === fParentElement || (!currentParentElement && fParentElement === ''))) {
                childNodesData.push(nodeData);
            }
        });
        return childNodesData;
    }
    getHierarchyInfo(nodeData) {
        return this.getValue(nodeData, this.hierarchyInfoKey); //nodeData[this.hierarchyInfoKey];
    }
    getValue(target, path) {
        if (path.indexOf('/') === -1) {
            return target[path];
        }
        const paths = path.split('/').filter(p => p);
        return paths.reduce((result, path) => {
            return result && result[path];
        }, target);
    }
    /**
     * 获取分级信息中的层级
     * @param nodeData nodeData
     */
    getNodeLayer(nodeData) {
        const hierarchyInfo = this.getHierarchyInfo(nodeData);
        return hierarchyInfo['layer'];
    }
    /**
     * 获取分级信息中的父节点
     * @param nodeData nodeData
     */
    getNodeParentElement(nodeData) {
        const hierarchyInfo = this.getHierarchyInfo(nodeData);
        return hierarchyInfo['parentElement'];
    }
    /**
     * 获取展开状态
     */
    isExpanded(newData) {
        const oldTreeNode = this.getOldNode(newData);
        return oldTreeNode ? oldTreeNode.expanded : undefined;
    }
    /**
     * 是否是叶子节点
     * @todo：应该用数据本身的isDetail来保证，但目前不准确，强制前端计算
     */
    isLeaf(nodeData) {
        const hierarchyInfo = this.getHierarchyInfo(nodeData); //nodeData[this.hierarchyInfoKey];
        const isDetail = hierarchyInfo['isDetail'];
        return isDetail;
    }
    /**
     * 判断节点是否是新增
     * @todo：不应该这样判断，待优化。
     * @summary
     * 1、非空树（空树视为初次加载数据）；
     * 2、找不到oldNode。
     */
    isNewNode(nodeData) {
        if (this.allOldNodesMap.size === 0) {
            return false;
        }
        const oldTreeNode = this.getOldNode(nodeData);
        return oldTreeNode ? false : true;
    }
    /**
     * 展开父节点
     */
    expandParentNode(nodeData) {
        const parentTreeNode = this.getParentNode(nodeData);
        if (!parentTreeNode) {
            return;
        }
        parentTreeNode.leaf = false;
        parentTreeNode.expanded = true;
    }
    /**
     * 查找父节点
     */
    getParentNode(nodeData) {
        const hierarchyInfo = this.getHierarchyInfo(nodeData); //nodeData[this.hierarchyInfoKey];
        const layer = hierarchyInfo['layer'];
        const parentElement = hierarchyInfo['parentElement'];
        const allNodes = Array.from(this.allNodesMap.values());
        const parentNode = allNodes.find((node) => {
            const currentLayer = this.getValue(node.data, this.hierarchyInfoKey)['layer']; //node.data[this.hierarchyInfoKey]['layer'];
            const currentId = node.data[this.primaryKey];
            return currentId === parentElement && layer === (currentLayer + 1);
        });
        return parentNode;
    }
    /**
     * 获取老的树节点
     */
    getOldNode(nodeData) {
        const id = nodeData[this.primaryKey];
        return this.allOldNodesMap.get(id);
    }
    /**
     * 打平TreeNodes，并放入一个Map中
     */
    buildNodesDataMap(treeNodes) {
        treeNodes.forEach((treeNode) => {
            this.allOldNodesMap.set(treeNode.data[this.primaryKey], treeNode);
            if (treeNode.children) {
                this.buildNodesDataMap(treeNode.children);
            }
        });
    }
}
export { ParentTreeNodeBuilder };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyZW50X3RyZWVfbm9kZV9idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9rZW5kby1iaW5kaW5nLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZXMvdHJlZV90YWJsZV9ub2RlX2J1aWxkZXIvcGFyZW50X3RyZWVfbm9kZV9idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7OztHQUtHO0FBS0gsb0RBQW9EO0FBQ3BEOzs7O0dBSUc7QUFDSCxNQUFNLHFCQUFxQjtJQUV6Qjs7T0FFRztJQUNILFlBQVksWUFBbUIsRUFBRSxZQUF3QixFQUFFLFVBQWtCLEVBQUUsZ0JBQXdCLEVBQUUsT0FBYTtRQWlDdEg7Ozs7OztXQU1HO1FBQ0ssb0JBQWUsR0FBVSxFQUFFLENBQUM7UUF2Q2xDLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztRQUN6QyxJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztRQUNqQyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLGVBQWUsR0FBRyxFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsaUJBQWlCLElBQUksRUFBRSxDQUFDO1FBQ3BFLElBQUksQ0FBQyxZQUFZLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDO1FBQzVELElBQUksQ0FBQywyQkFBMkIsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFFckUsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLEdBQUcsRUFBb0IsQ0FBQztRQUMvQyxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksR0FBRyxFQUFvQixDQUFDO1FBQ2xELElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBQ0Q7OztPQUdHO0lBQ0gsSUFBWSxXQUFXO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDdkcsQ0FBQztJQUNELElBQVksU0FBUztRQUNuQixPQUFPLElBQUksQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBQ0QsSUFBWSwyQkFBMkI7UUFDckMsT0FBTyxJQUFJLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsNkJBQTZCLENBQUMsSUFBSSxVQUFVLElBQVMsSUFBSSxDQUFDLENBQUM7SUFDakcsQ0FBQztJQWtETSxjQUFjLENBQUMsWUFBaUIsRUFBRSxJQUFTO1FBQ2hELElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBQ00sS0FBSztRQUNWLElBQUksSUFBSSxHQUFlLEVBQUUsQ0FBQztRQUMxQixNQUFNLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDdEIsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ25CLE1BQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUNqQixJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUMvQixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQ25CLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxhQUFhLENBQUM7WUFFM0QsNEJBQTRCO1lBQzVCLGFBQWE7WUFDYixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3ZDLElBQUksU0FBUyxLQUFLLElBQUksRUFBRTtnQkFDdEIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO2FBQzdCO1lBQ0QsUUFBUTtZQUNSLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDbEMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQztZQUNqQixVQUFVLENBQUMsRUFBRSxDQUFDLEdBQUcsVUFBVSxDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUN0QyxJQUFJLENBQUMsUUFBUSxHQUFHLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUUvQixPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUM1QyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzdCLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDbEQsSUFBSSxRQUFRLEVBQUU7Z0JBQ1osSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLGFBQWEsS0FBSyxJQUFJLEVBQUU7b0JBQzdELEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO29CQUNoQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztpQkFDdkM7Z0JBQ0QsVUFBVSxDQUFDLFFBQVEsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ2xELFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDakM7aUJBQU07Z0JBQ0wsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLElBQUksRUFBRTtvQkFDMUUsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7b0JBQzFCLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO2lCQUN2QjtnQkFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ2pCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCx5QkFBeUI7UUFDekIsSUFBSSxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDbkYsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUN2QyxTQUFTLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUMzQixJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLFFBQVEsQ0FBQyxFQUFFO29CQUN6RCxJQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztpQkFDdkM7WUFDSCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBQ0Q7O09BRUc7SUFDSSxNQUFNO1FBQ1gsSUFBSSxRQUFRLENBQUM7UUFDYixnQkFBZ0I7UUFDaEIsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDL0IsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2xELElBQUksYUFBYSxFQUFFO2dCQUNqQixNQUFNLEtBQUssR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ3JDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUU7b0JBQ2pCLElBQUksUUFBUSxLQUFLLFNBQVMsRUFBRTt3QkFDMUIsUUFBUSxHQUFHLEtBQUssQ0FBQztxQkFDbEI7eUJBQU0sSUFBSSxLQUFLLEdBQUcsUUFBUSxFQUFFO3dCQUMzQixRQUFRLEdBQUcsS0FBSyxDQUFDO3FCQUNsQjtpQkFDRjthQUNGO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLFFBQVEsR0FBRyxRQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQzlCLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNoRSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdkIsQ0FBQztJQUVEOztPQUVHO0lBQ0ssVUFBVSxDQUFDLGNBQXNCLEVBQUUsTUFBYyxFQUFFLFlBQW1CLEVBQUUsU0FBcUI7UUFDbkcsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGNBQWMsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUN0RSxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBYSxFQUFFLEVBQUU7WUFFdkMsYUFBYTtZQUNiLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDM0MsSUFBSSxTQUFTLEtBQUssSUFBSSxFQUFFO2dCQUN0QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDakM7WUFFRCxRQUFRO1lBQ1IsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN0QyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3JCLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFFdEQsV0FBVztZQUNYLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLGtDQUFrQztZQUN6RixNQUFNLFlBQVksR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDNUMsTUFBTSxTQUFTLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUM1QyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFFLElBQUksQ0FBQyxRQUFzQixDQUFDLENBQUM7UUFDdEYsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxTQUFTLENBQUMsUUFBYTtRQUM3QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3JDLFlBQVk7UUFDWixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2pELHdDQUF3QztRQUN4QyxNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDckQsdUNBQXVDO1FBQ3ZDLElBQUksQ0FBQyxrQkFBa0IsSUFBSSxZQUFZLEVBQUU7WUFDdkMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUMzQjtRQUNELE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMxRCxNQUFNLFFBQVEsR0FBYTtZQUN6QixJQUFJLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsUUFBUSxDQUFDO1lBQ2pDLFFBQVEsRUFBRSxFQUFFO1lBQ1osUUFBUSxFQUFFLFlBQVk7WUFDdEIsSUFBSSxFQUFFLE1BQU07U0FDYixDQUFDO1FBQ0YsSUFBSSxjQUFjLEVBQUU7WUFDbEIsUUFBUSxDQUFDLFVBQVUsR0FBRyxjQUFjLENBQUM7U0FDdEM7UUFDRCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBQ0Q7Ozs7T0FJRztJQUNLLG1CQUFtQixDQUFDLFFBQWE7UUFDdkMsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNyQixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3JDLFNBQVM7WUFDVCxNQUFNLEdBQUcsR0FBRyxTQUFTLEVBQUUsbUJBQW1CLENBQUM7WUFDM0MsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQztZQUM3RCxJQUFJLFVBQVUsSUFBSSxVQUFVLENBQUMsU0FBUyxHQUFHLENBQUMsRUFBRTtnQkFDMUMsTUFBTSxHQUFHO29CQUNQLFNBQVMsRUFBRSxVQUFVLENBQUMsU0FBUztvQkFDL0IsUUFBUSxFQUFFLFVBQVUsQ0FBQyxRQUFRO29CQUM3QixLQUFLLEVBQUUsVUFBVSxDQUFDLFVBQVU7aUJBQzdCLENBQUM7YUFDSDtTQUNGO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUNEOzs7T0FHRztJQUNLLFlBQVksQ0FBQyxRQUFhO1FBQ2hDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUM3RSxZQUFZO1FBQ1osSUFBSSxNQUFNLEVBQUU7WUFDVixPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN6QyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2IsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNyQyxJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7Z0JBQ3ZFLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7WUFDRCxJQUFJLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEtBQUssRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7Z0JBQ2xFLE9BQU8sSUFBSSxDQUFDO2FBQ2I7WUFDRCxJQUFJLElBQUksQ0FBQyxXQUFXLEtBQUssQ0FBQyxDQUFDLEVBQUU7Z0JBQzNCLFVBQVU7Z0JBQ1YsUUFBUSxHQUFHLEtBQUssQ0FBQzthQUNsQjtpQkFBTSxJQUFJLElBQUksQ0FBQyxXQUFXLEtBQUssQ0FBQyxFQUFFO2dCQUNqQyxVQUFVO2dCQUNWLFFBQVEsR0FBRyxJQUFJLENBQUM7YUFDakI7aUJBQU07Z0JBQ0wsMkJBQTJCO2dCQUMzQixRQUFRLEdBQUcsS0FBSyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUM7Z0JBQ3JDLHNCQUFzQjtnQkFDdEIsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDOUMsSUFBSSxXQUFXLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFO29CQUN4QyxRQUFRLEdBQUcsS0FBSyxDQUFDO2lCQUNsQjthQUNGO1NBQ0Y7UUFDRCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBQ0Q7Ozs7T0FJRztJQUNLLFVBQVUsQ0FBQyxRQUFhO1FBQzlCLE1BQU0sQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUNsRixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXRELDRDQUE0QztRQUM1QyxJQUFJLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ2hDLHlEQUF5RDtZQUN6RCxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3JDLElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQ3RFLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO2FBQ3BEO1NBQ0Y7SUFDSCxDQUFDO0lBQ0Q7O09BRUc7SUFDSyxrQkFBa0I7UUFDeEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNyRSxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNuRCxNQUFNLEVBQUUsRUFBRSxFQUFFLEdBQUcsUUFBUSxDQUFDO1FBQ3hCLElBQUksRUFBRSxFQUFFO1lBQ04sTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDL0MsSUFBSSxPQUFPLEVBQUU7Z0JBQ1gsUUFBUSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7Z0JBQ3pCLDhEQUE4RDtnQkFDOUQsWUFBWTtnQkFDWixJQUFJO2dCQUNKLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2FBQy9CO1NBQ0Y7SUFDSCxDQUFDO0lBQ0Q7OztPQUdHO0lBQ0ssVUFBVSxDQUFDLFFBQWE7UUFDOUIsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFDRCxxQkFBcUI7SUFFckI7O09BRUc7SUFDSyxpQkFBaUIsQ0FBQyxjQUFzQixFQUFFLE1BQWM7UUFDOUQsTUFBTSxjQUFjLEdBQUcsRUFBRSxDQUFDO1FBQzFCLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBYSxFQUFFLEVBQUU7WUFFMUMsa0NBQWtDO1lBQ2xDLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLGtDQUFrQztZQUN6RixJQUFJLENBQUMsYUFBYSxFQUFFO2dCQUNsQixPQUFPO2FBQ1I7WUFFRCxPQUFPO1lBQ1AsTUFBTSxZQUFZLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzVDLE1BQU0sb0JBQW9CLEdBQUcsYUFBYSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQzVELElBQUksQ0FBQyxZQUFZLEtBQUssTUFBTSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEtBQUssY0FBYyxJQUFJLENBQUMsQ0FBQyxvQkFBb0IsSUFBSSxjQUFjLEtBQUssRUFBRSxDQUFDLENBQUMsRUFBRTtnQkFDbEksY0FBYyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUMvQjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxjQUFjLENBQUM7SUFDeEIsQ0FBQztJQUNPLGdCQUFnQixDQUFDLFFBQWE7UUFDcEMsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFBLGtDQUFrQztJQUMxRixDQUFDO0lBQ08sUUFBUSxDQUFDLE1BQVcsRUFBRSxJQUFZO1FBQ3hDLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtZQUM1QixPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNyQjtRQUNELE1BQU0sS0FBSyxHQUFRLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEQsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxFQUFFO1lBQ25DLE9BQU8sTUFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDYixDQUFDO0lBQ0Q7OztPQUdHO0lBQ0ssWUFBWSxDQUFDLFFBQWE7UUFDaEMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RELE9BQU8sYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFDRDs7O09BR0c7SUFDSyxvQkFBb0IsQ0FBQyxRQUFhO1FBQ3hDLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN0RCxPQUFPLGFBQWEsQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBQ0Q7O09BRUc7SUFDSyxVQUFVLENBQUMsT0FBWTtRQUM3QixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzdDLE9BQU8sV0FBVyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7SUFDeEQsQ0FBQztJQUVEOzs7T0FHRztJQUNLLE1BQU0sQ0FBQyxRQUFhO1FBQzFCLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFBLGtDQUFrQztRQUN4RixNQUFNLFFBQVEsR0FBRyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDM0MsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNLLFNBQVMsQ0FBQyxRQUFhO1FBQzdCLElBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEtBQUssQ0FBQyxFQUFFO1lBQ2xDLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFDRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzlDLE9BQU8sV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUNwQyxDQUFDO0lBRUQ7O09BRUc7SUFDSyxnQkFBZ0IsQ0FBQyxRQUFhO1FBQ3BDLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDcEQsSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUNuQixPQUFPO1NBQ1I7UUFDRCxjQUFjLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQztRQUM1QixjQUFjLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztJQUNqQyxDQUFDO0lBRUQ7O09BRUc7SUFDSyxhQUFhLENBQUMsUUFBYTtRQUNqQyxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQSxrQ0FBa0M7UUFDeEYsTUFBTSxLQUFLLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3JDLE1BQU0sYUFBYSxHQUFHLGFBQWEsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUVyRCxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUN2RCxNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBYyxFQUFFLEVBQUU7WUFDbEQsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsNENBQTRDO1lBQzNILE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQzdDLE9BQU8sU0FBUyxLQUFLLGFBQWEsSUFBSSxLQUFLLEtBQUssQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDckUsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0lBRUQ7O09BRUc7SUFDSyxVQUFVLENBQUMsUUFBYTtRQUM5QixNQUFNLEVBQUUsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3JDLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVEOztPQUVHO0lBQ0ssaUJBQWlCLENBQUMsU0FBcUI7UUFDN0MsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQWtCLEVBQUUsRUFBRTtZQUN2QyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUNsRSxJQUFJLFFBQVEsQ0FBQyxRQUFRLEVBQUU7Z0JBQ3JCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDM0M7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FHRjtBQUVELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogQEF1dGhvcjogYWFsaXp6d2VsbCBcclxuICogQERhdGU6IDIwMTktMDUtMzEgMDk6NDg6MTAgXHJcbiAqIEBMYXN0IE1vZGlmaWVkIGJ5OiBhYWxpenp3ZWxsXHJcbiAqIEBMYXN0IE1vZGlmaWVkIHRpbWU6IDIwMTktMDYtMjQgMTc6MDA6NThcclxuICovXHJcblxyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IFRyZWVOb2RlLCBUcmVlVGFibGVDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLXRyZWV0YWJsZSc7XHJcbmltcG9ydCB7IFBhcmVudEhpZXJhcmNoeUluZm8gfSBmcm9tICcuL3R5cGVzJztcclxuLy8gdHNsaW50OmRpc2FibGU6IG5vLXN0cmluZy1saXRlcmFsIG1heC1saW5lLWxlbmd0aFxyXG4vKipcclxuICog5qCR6IqC54K55p6E6YCg5ZmoXHJcbiAqIEBzdW1tYXJ5XHJcbiAqIOWwhkJpbmRpbmdEYXRh5Lit55qE5pWw5o2u6ZuG5ZCI6L2s5o2i5oiQVHJlZVRhYmxl6IqC54K56ZuG5ZCIXHJcbiAqL1xyXG5jbGFzcyBQYXJlbnRUcmVlTm9kZUJ1aWxkZXIge1xyXG4gIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQ7XHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoYWxsTm9kZXNEYXRhOiBhbnlbXSwgb2xkVHJlZU5vZGVzOiBUcmVlTm9kZVtdLCBwcmltYXJ5S2V5OiBzdHJpbmcsIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgY29udGV4dD86IGFueSkge1xyXG4gICAgdGhpcy5wcmltYXJ5S2V5ID0gcHJpbWFyeUtleTtcclxuICAgIHRoaXMuaGllcmFyY2h5SW5mb0tleSA9IGhpZXJhcmNoeUluZm9LZXk7XHJcbiAgICB0aGlzLmFsbE5vZGVzID0gW107XHJcbiAgICB0aGlzLmFsbE5vZGVzRGF0YSA9IGFsbE5vZGVzRGF0YTtcclxuICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQgfHwge307XHJcbiAgICB0aGlzLm5vZGVzV2FpdEV4cGFuZCA9IFtdO1xyXG4gICAgdGhpcy5ub2Rlc1Nob3VsZEV4cGFuZCA9IGNvbnRleHQgJiYgY29udGV4dC5ub2Rlc1Nob3VsZEV4cGFuZCB8fCBbXTtcclxuICAgIHRoaXMuZnJhbWVDb250ZXh0ID0gY29udGV4dCAmJiBjb250ZXh0LmZyYW1lQ29udGV4dCB8fCBudWxsO1xyXG4gICAgdGhpcy5hZGRUcmVlTG9hZENvbXBsZXRlTGlzdGVuZXIodGhpcy5vblRyZWVMb2FkQ29tcGxldGUuYmluZCh0aGlzKSk7XHJcblxyXG4gICAgdGhpcy5hbGxOb2Rlc01hcCA9IG5ldyBNYXA8c3RyaW5nLCBUcmVlTm9kZT4oKTtcclxuICAgIHRoaXMuYWxsT2xkTm9kZXNNYXAgPSBuZXcgTWFwPHN0cmluZywgVHJlZU5vZGU+KCk7XHJcbiAgICB0aGlzLmJ1aWxkTm9kZXNEYXRhTWFwKG9sZFRyZWVOb2Rlcyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWxleW8gOiHs+Wxgue6p1xyXG4gICAqIEBkZXNjcmlwdGlvbiAtMeS4uuS4jeWxleW8gFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0IGV4cGFuZExldmVsKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuY29udGV4dCAmJiB0aGlzLmNvbnRleHQuaGFzT3duUHJvcGVydHkoJ2V4cGFuZExldmVsJykgPyB0aGlzLmNvbnRleHRbJ2V4cGFuZExldmVsJ10gOiAtMTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXQgY29tcG9uZW50KCk6IFRyZWVUYWJsZUNvbXBvbmVudCB7XHJcbiAgICByZXR1cm4gdGhpcy5jb250ZXh0ICYmIHRoaXMuY29udGV4dFsnY29tcG9uZW50J107XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0IGFkZFRyZWVMb2FkQ29tcGxldGVMaXN0ZW5lcigpIHtcclxuICAgIHJldHVybiB0aGlzLmNvbnRleHQgJiYgdGhpcy5jb250ZXh0WydhZGRUcmVlTG9hZENvbXBsZXRlTGlzdGVuZXInXSB8fCBmdW5jdGlvbiAoYXJnczogYW55KSB7IH07XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOmcgOimgeWxleW8gOeahOiKgueCuVxyXG4gICAqL1xyXG4gIHByaXZhdGUgbm9kZXNTaG91bGRFeHBhbmQ6IHN0cmluZ1tdO1xyXG5cclxuICAvKipcclxuICAgKiDnrYnlvoXlsZXlvIDnmoToioLngrlcclxuICAgKiBAZGVzY3JpcHRpb24g6IqC54K557uT5p6EXHJcbiAgICogYGBgXHJcbiAgICoge2lkOid4eHgnLGV4cGFuZGVkOmZhbHNlfVxyXG4gICAqIGBgYFxyXG4gICAqL1xyXG4gIHByaXZhdGUgbm9kZXNXYWl0RXhwYW5kOiBhbnlbXSA9IFtdO1xyXG5cclxuICAvKipcclxuICAgKiDkuLvplK7lrZfmrrXlkI1cclxuICAgKi9cclxuICBwcml2YXRlIHByaW1hcnlLZXk6IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICog5YiG57qn56CB5a2X5q615ZCNXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIOiKgueCueeahOaVsOaNrumbhuWQiFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYWxsTm9kZXNEYXRhOiBhbnlbXTtcclxuXHJcbiAgLyoqXHJcbiAgICog6IqC54K56ZuG5ZCIXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhbGxOb2RlczogVHJlZU5vZGVbXTtcclxuXHJcbiAgLyoqXHJcbiAgICog5LiK5LiA5qyh57uR5a6a55qE5qCR6IqC54K56ZuG5ZCITWFwXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhbGxOb2Rlc01hcDogTWFwPHN0cmluZywgVHJlZU5vZGU+O1xyXG5cclxuICAvKipcclxuICAgKiDkuIrkuIDmrKHnu5HlrprnmoTmoJHoioLngrnpm4blkIhNYXBcclxuICAgKi9cclxuICBwcml2YXRlIGFsbE9sZE5vZGVzTWFwOiBNYXA8c3RyaW5nLCBUcmVlTm9kZT47XHJcblxyXG4gIC8qKlxyXG4gICAqIOS4iuS4i+aWh1xyXG4gICAqL1xyXG4gIHByaXZhdGUgY29udGV4dDogYW55O1xyXG5cclxuICBwdWJsaWMgdXBkYXRlVHJlZU5vZGUoYWxsTm9kZXNEYXRhOiBhbnksIGRhdGE6IGFueSkge1xyXG4gICAgdGhpcy5hbGxOb2Rlc0RhdGEgPSBhbGxOb2Rlc0RhdGE7XHJcbiAgICB0aGlzLmJ1aWxkTm9kZXNEYXRhTWFwKGRhdGEpO1xyXG4gIH1cclxuICBwdWJsaWMgYnVpbGQoKTogVHJlZU5vZGVbXSB7XHJcbiAgICBsZXQgdHJlZTogVHJlZU5vZGVbXSA9IFtdO1xyXG4gICAgY29uc3QgY2hpbGRyZW5PZiA9IHt9O1xyXG4gICAgY29uc3QgcGFyZW50cyA9IHt9O1xyXG4gICAgY29uc3Qgbm9kZXMgPSB7fTtcclxuICAgIHRoaXMuYWxsTm9kZXNEYXRhLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgIGNvbnN0IGlkID0gaXRlbS5pZDtcclxuICAgICAgY29uc3QgcGFyZW50SWQgPSB0aGlzLmdldEhpZXJhcmNoeUluZm8oaXRlbSkucGFyZW50RWxlbWVudDtcclxuXHJcbiAgICAgIC8vIGl0ZW0ucGFyZW50SWQgPSBwYXJlbnRJZDtcclxuICAgICAgLy8g5bGV5byA5paw5aKe6IqC54K555qE54i26IqC54K5XHJcbiAgICAgIGNvbnN0IGlzTmV3Tm9kZSA9IHRoaXMuaXNOZXdOb2RlKGl0ZW0pO1xyXG4gICAgICBpZiAoaXNOZXdOb2RlID09PSB0cnVlKSB7XHJcbiAgICAgICAgdGhpcy5leHBhbmRQYXJlbnROb2RlKGl0ZW0pO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIOaehOmAoOagkeiKgueCuVxyXG4gICAgICBjb25zdCBub2RlID0gdGhpcy5idWlsZE5vZGUoaXRlbSk7XHJcbiAgICAgIG5vZGVzW2lkXSA9IG5vZGU7XHJcbiAgICAgIGNoaWxkcmVuT2ZbaWRdID0gY2hpbGRyZW5PZltpZF0gfHwgW107XHJcbiAgICAgIG5vZGUuY2hpbGRyZW4gPSBjaGlsZHJlbk9mW2lkXTtcclxuXHJcbiAgICAgIHBhcmVudHNbcGFyZW50SWRdID0gcGFyZW50c1twYXJlbnRJZF0gfHwgW107XHJcbiAgICAgIHBhcmVudHNbcGFyZW50SWRdLnB1c2gobm9kZSk7XHJcbiAgICAgIHRoaXMuYWxsTm9kZXNNYXAuc2V0KGl0ZW1bdGhpcy5wcmltYXJ5S2V5XSwgbm9kZSk7XHJcbiAgICAgIGlmIChwYXJlbnRJZCkge1xyXG4gICAgICAgIGlmIChub2Rlc1twYXJlbnRJZF0gJiYgbm9kZXNbcGFyZW50SWRdLnVuc3RhYmxlU3RhdGUgPT09IHRydWUpIHtcclxuICAgICAgICAgIG5vZGVzW3BhcmVudElkXS5leHBhbmRlZCA9IHRydWU7XHJcbiAgICAgICAgICBub2Rlc1twYXJlbnRJZF0udW5zdGFibGVTdGF0ZSA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjaGlsZHJlbk9mW3BhcmVudElkXSA9IGNoaWxkcmVuT2ZbcGFyZW50SWRdIHx8IFtdO1xyXG4gICAgICAgIGNoaWxkcmVuT2ZbcGFyZW50SWRdLnB1c2gobm9kZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWYgKCghbm9kZS5jaGlsZHJlbiB8fCBub2RlLmNoaWxkcmVuLmxlbmd0aCA8IDEpICYmIG5vZGUuZXhwYW5kZWQgPT09IHRydWUpIHtcclxuICAgICAgICAgIG5vZGUudW5zdGFibGVTdGF0ZSA9IHRydWU7XHJcbiAgICAgICAgICBub2RlLmV4cGFuZGVkID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRyZWUucHVzaChub2RlKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICAvLyDmiYDmnInoioLngrnpg73mmK9wYXJlbnRJZO+8jOayoeaciei/lOWbnuagueiKgueCuVxyXG4gICAgaWYgKCghdHJlZSB8fCB0cmVlLmxlbmd0aCA8IDEpICYmIHRoaXMuYWxsTm9kZXNEYXRhICYmIHRoaXMuYWxsTm9kZXNEYXRhLmxlbmd0aCA+IDApIHtcclxuICAgICAgY29uc3QgcGFyZW50SWRzID0gT2JqZWN0LmtleXMocGFyZW50cyk7XHJcbiAgICAgIHBhcmVudElkcy5mb3JFYWNoKHBhcmVudElkID0+IHtcclxuICAgICAgICBpZiAoIXRoaXMuYWxsTm9kZXNEYXRhLmZpbmQoaXRlbSA9PiBpdGVtLmlkID09PSBwYXJlbnRJZCkpIHtcclxuICAgICAgICAgIHRyZWUgPSB0cmVlLmNvbmNhdChwYXJlbnRzW3BhcmVudElkXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiB0cmVlO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmnoTpgKDmoJHoioLngrlcclxuICAgKi9cclxuICBwdWJsaWMgYnVpbGQxKCk6IFRyZWVOb2RlW10ge1xyXG4gICAgbGV0IG1pbkxheWVyO1xyXG4gICAgLy8g6I635Y+W5pyA6aG257qn6IqC54K555qEbGF5ZXJcclxuICAgIHRoaXMuYWxsTm9kZXNEYXRhLmZvckVhY2gobm9kZSA9PiB7XHJcbiAgICAgIGNvbnN0IGhpZXJhcmNoeUluZm8gPSB0aGlzLmdldEhpZXJhcmNoeUluZm8obm9kZSk7XHJcbiAgICAgIGlmIChoaWVyYXJjaHlJbmZvKSB7XHJcbiAgICAgICAgY29uc3QgbGF5ZXIgPSBoaWVyYXJjaHlJbmZvWydsYXllciddO1xyXG4gICAgICAgIGlmICghaXNOYU4obGF5ZXIpKSB7XHJcbiAgICAgICAgICBpZiAobWluTGF5ZXIgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBtaW5MYXllciA9IGxheWVyO1xyXG4gICAgICAgICAgfSBlbHNlIGlmIChsYXllciA8IG1pbkxheWVyKSB7XHJcbiAgICAgICAgICAgIG1pbkxheWVyID0gbGF5ZXI7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIGNvbnN0IHRvcExheWVyID0gbWluTGF5ZXIgLSAxO1xyXG4gICAgdGhpcy5idWlsZE5vZGVzKCcnLCB0b3BMYXllciwgdGhpcy5hbGxOb2Rlc0RhdGEsIHRoaXMuYWxsTm9kZXMpO1xyXG4gICAgcmV0dXJuIHRoaXMuYWxsTm9kZXM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDmoJHoioLngrnpm4blkIhcclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkTm9kZXMoZlBhcmVudEVsZW1lbnQ6IHN0cmluZywgZkxheWVyOiBudW1iZXIsIGFsbE5vZGVzRGF0YTogYW55W10sIHRyZWVOb2RlczogVHJlZU5vZGVbXSk6IHZvaWQge1xyXG4gICAgY29uc3QgY2hpbGROb2Rlc0RhdGEgPSB0aGlzLmdldENoaWxkTm9kZXNEYXRhKGZQYXJlbnRFbGVtZW50LCBmTGF5ZXIpO1xyXG4gICAgY2hpbGROb2Rlc0RhdGEuZm9yRWFjaCgobm9kZURhdGE6IGFueSkgPT4ge1xyXG5cclxuICAgICAgLy8g5bGV5byA5paw5aKe6IqC54K555qE54i26IqC54K5XHJcbiAgICAgIGNvbnN0IGlzTmV3Tm9kZSA9IHRoaXMuaXNOZXdOb2RlKG5vZGVEYXRhKTtcclxuICAgICAgaWYgKGlzTmV3Tm9kZSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgIHRoaXMuZXhwYW5kUGFyZW50Tm9kZShub2RlRGF0YSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIOaehOmAoOagkeiKgueCuVxyXG4gICAgICBjb25zdCBub2RlID0gdGhpcy5idWlsZE5vZGUobm9kZURhdGEpO1xyXG4gICAgICB0cmVlTm9kZXMucHVzaChub2RlKTtcclxuICAgICAgdGhpcy5hbGxOb2Rlc01hcC5zZXQobm9kZURhdGFbdGhpcy5wcmltYXJ5S2V5XSwgbm9kZSk7XHJcblxyXG4gICAgICAvLyDpgJLlvZLpgY3ljobkuIvnuqfoioLngrlcclxuICAgICAgY29uc3QgaGllcmFyY2h5SW5mbyA9IHRoaXMuZ2V0SGllcmFyY2h5SW5mbyhub2RlRGF0YSk7IC8vbm9kZURhdGFbdGhpcy5oaWVyYXJjaHlJbmZvS2V5XTtcclxuICAgICAgY29uc3QgY3VycmVudExheWVyID0gaGllcmFyY2h5SW5mb1snbGF5ZXInXTtcclxuICAgICAgY29uc3QgY3VycmVudElkID0gbm9kZURhdGFbdGhpcy5wcmltYXJ5S2V5XTtcclxuICAgICAgdGhpcy5idWlsZE5vZGVzKGN1cnJlbnRJZCwgY3VycmVudExheWVyLCBhbGxOb2Rlc0RhdGEsIG5vZGUuY2hpbGRyZW4gYXMgVHJlZU5vZGVbXSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIm+W7uuagkeiKgueCuVxyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGROb2RlKG5vZGVEYXRhOiBhbnkpOiBUcmVlTm9kZSAmIHsgdW5zdGFibGVTdGF0ZT86IGJvb2xlYW4gfSB7XHJcbiAgICBjb25zdCBpc0xlYWYgPSB0aGlzLmlzTGVhZihub2RlRGF0YSk7XHJcbiAgICAvLyDojrflj5boioLngrnnmoTlsZXlvIDnirbmgIFcclxuICAgIGNvbnN0IHNob3VsZEV4cGFuZCA9IHRoaXMuc2hvdWxkRXhwYW5kKG5vZGVEYXRhKTtcclxuICAgIC8vIOiKgueCueiZveeEtuW6lOivpeWxleW8gO+8jOS9huWPr+iDveaYr+WboOS4uuS5i+WJjeWwseaYr+WxleW8gOeKtuaAge+8jOaJgOS7peW6lOivpeajgOafpeiKgueCueS5i+WJjeeahOeKtuaAgVxyXG4gICAgY29uc3Qgb3JpZ2luRXhwYW5kU3RhdHVzID0gdGhpcy5pc0V4cGFuZGVkKG5vZGVEYXRhKTtcclxuICAgIC8vIOWmguaenOW6lOivpeWxleW8gOivpeiKgueCue+8jOS9huaYr+ivpeiKgueCueS5i+WJjeacieeKtuaAge+8jOmCo+S5iOivpeiKgueCueS4jeW6lOivpeWGjeeUseeoi+W6j+WxleW8gOOAglxyXG4gICAgaWYgKCFvcmlnaW5FeHBhbmRTdGF0dXMgJiYgc2hvdWxkRXhwYW5kKSB7XHJcbiAgICAgIHRoaXMuZXhwYW5kTm9kZShub2RlRGF0YSk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYWdpbmF0aW9uSW5mbyA9IHRoaXMuYnVpbGRQYWdpbmF0aW9uSW5mbyhub2RlRGF0YSk7XHJcbiAgICBjb25zdCB0cmVlTm9kZTogVHJlZU5vZGUgPSB7XHJcbiAgICAgIGRhdGE6IE9iamVjdC5hc3NpZ24oe30sIG5vZGVEYXRhKSxcclxuICAgICAgY2hpbGRyZW46IFtdLFxyXG4gICAgICBleHBhbmRlZDogc2hvdWxkRXhwYW5kLFxyXG4gICAgICBsZWFmOiBpc0xlYWZcclxuICAgIH07XHJcbiAgICBpZiAocGFnaW5hdGlvbkluZm8pIHtcclxuICAgICAgdHJlZU5vZGUucGFnaW5hdGlvbiA9IHBhZ2luYXRpb25JbmZvO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRyZWVOb2RlO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmnoTpgKDliIbpobXkv6Hmga9cclxuICAgKiBAcGFyYW0gbm9kZURhdGEgbm9kZURhdGFcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkUGFnaW5hdGlvbkluZm8obm9kZURhdGE6IGFueSk6IHsgcGFnZUluZGV4OiBudW1iZXIsIHBhZ2VTaXplOiBudW1iZXIsIHRvdGFsOiBudW1iZXIgfSB8IG51bGwge1xyXG4gICAgbGV0IHJlc3VsdCA9IG51bGw7XHJcbiAgICBpZiAodGhpcy5mcmFtZUNvbnRleHQpIHtcclxuICAgICAgY29uc3QgaWQgPSB0aGlzLmdldFByaW1hcnkobm9kZURhdGEpO1xyXG4gICAgICAvLyDojrflj5bliIbpobXkv6Hmga9cclxuICAgICAgY29uc3Qga2V5ID0gYF9OT0RFXyR7aWR9X1BBR0lOQVRJT05fSU5GT19gO1xyXG4gICAgICBjb25zdCBwYWdpbmF0aW9uID0gdGhpcy5mcmFtZUNvbnRleHQucGFyYW1zLmdldChrZXkpIHx8IG51bGw7XHJcbiAgICAgIGlmIChwYWdpbmF0aW9uICYmIHBhZ2luYXRpb24ucGFnZUNvdW50ID4gMSkge1xyXG4gICAgICAgIHJlc3VsdCA9IHtcclxuICAgICAgICAgIHBhZ2VJbmRleDogcGFnaW5hdGlvbi5wYWdlSW5kZXgsXHJcbiAgICAgICAgICBwYWdlU2l6ZTogcGFnaW5hdGlvbi5wYWdlU2l6ZSxcclxuICAgICAgICAgIHRvdGFsOiBwYWdpbmF0aW9uLnRvdGFsQ291bnRcclxuICAgICAgICB9O1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDorqHnrpfoioLngrnmmK/lkKbopoHlsZXlvIBcclxuICAgKiBAcGFyYW0gbm9kZURhdGEgbm9kZURhdGFcclxuICAgKi9cclxuICBwcml2YXRlIHNob3VsZEV4cGFuZChub2RlRGF0YTogYW55KSB7XHJcbiAgICBjb25zdCBbaXNMZWFmLCBsYXllcl0gPSBbdGhpcy5pc0xlYWYobm9kZURhdGEpLCB0aGlzLmdldE5vZGVMYXllcihub2RlRGF0YSldO1xyXG4gICAgLy8g5rC46L+c5LiN5bGV5byA5Y+25a2Q6IqC54K5XHJcbiAgICBpZiAoaXNMZWFmKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGxldCBleHBhbmRlZCA9IHRoaXMuaXNFeHBhbmRlZChub2RlRGF0YSk7XHJcbiAgICBpZiAoIWV4cGFuZGVkKSB7XHJcbiAgICAgIGNvbnN0IGlkID0gdGhpcy5nZXRQcmltYXJ5KG5vZGVEYXRhKTtcclxuICAgICAgaWYgKHRoaXMubm9kZXNXYWl0RXhwYW5kLmZpbmRJbmRleChub2RlID0+IG5vZGUgJiYgbm9kZS5pZCA9PT0gaWQpID4gLTEpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHRoaXMubm9kZXNTaG91bGRFeHBhbmQuZmluZEluZGV4KG5vZGVJZCA9PiBub2RlSWQgPT09IGlkKSA+IC0xKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHRoaXMuZXhwYW5kTGV2ZWwgPT09IC0xKSB7XHJcbiAgICAgICAgLy8gLTEg5Li65LiN5bGV5byAXHJcbiAgICAgICAgZXhwYW5kZWQgPSBmYWxzZTtcclxuICAgICAgfSBlbHNlIGlmICh0aGlzLmV4cGFuZExldmVsID09PSAwKSB7XHJcbiAgICAgICAgLy8gMCDkuLrlhajpg6jlsZXlvIBcclxuICAgICAgICBleHBhbmRlZCA9IHRydWU7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8g5rKh5pyJ5ZCv55So5YiG5bGC5Yqg6L2977yM6YCa6L+H5bGV5byA5bGC57qn56Gu5a6a5piv5ZCm5bGV5byA6K+l6IqC54K5XHJcbiAgICAgICAgZXhwYW5kZWQgPSBsYXllciA8PSB0aGlzLmV4cGFuZExldmVsO1xyXG4gICAgICAgIC8vIOWmguaenOiKgueCueWOn+acrOWtmOWcqOS4lOiKgueCueayoeacieWxleW8gOWImeS4jeWxleW8gFxyXG4gICAgICAgIGNvbnN0IG9sZFRyZWVOb2RlID0gdGhpcy5nZXRPbGROb2RlKG5vZGVEYXRhKTtcclxuICAgICAgICBpZiAob2xkVHJlZU5vZGUgJiYgIW9sZFRyZWVOb2RlLmV4cGFuZGVkKSB7XHJcbiAgICAgICAgICBleHBhbmRlZCA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGV4cGFuZGVkO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlsZXlvIDmoJHoioLngrlcclxuICAgKiBAZGVzY3JpcHRpb24g5a6M5YWo5Yqg6L295qCR5L2/55So5bGV5byA5bGe5oCn5ZyoYnVpbGROb2Rl5pe25bey57uP5bGV5byA77yM5q2k5Ye95pWw55qE5Li76KaB55So5LqO5bGV5byA5YiG57qn5Yqg6L295qCRXHJcbiAgICogQHBhcmFtIG5vZGVEYXRhIG5vZGVEYXRhXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBleHBhbmROb2RlKG5vZGVEYXRhOiBhbnkpIHtcclxuICAgIGNvbnN0IFtlbGVtZW50LCBsYXllcl0gPSBbbm9kZURhdGFbdGhpcy5wcmltYXJ5S2V5XSwgdGhpcy5nZXROb2RlTGF5ZXIobm9kZURhdGEpXTtcclxuICAgIGNvbnN0IGNoaWxkcyA9IHRoaXMuZ2V0Q2hpbGROb2Rlc0RhdGEoZWxlbWVudCwgbGF5ZXIpO1xyXG5cclxuICAgIC8vIOW9k+WJjeiKgueCueS4jeaYr+WPtuWtkOiKgueCue+8jOS9huWcqOiKgueCueaVsOaNruS4reWPiOaJvuS4jeWIsOivpeiKgueCueeahOWtkOiKgueCue+8jOWImeiupOS4uuagkeWQr+eUqOS6huWIhuWxguWKoOi9vVxyXG4gICAgaWYgKCFjaGlsZHMgfHwgY2hpbGRzLmxlbmd0aCA8IDEpIHtcclxuICAgICAgLy8g5YiG5bGC5Yqg6L295qCR6ZyA6KaB6YCa6L+H6Kem5Y+R6IqC54K55bGV5byA5LqL5Lu25omN5Yqg6L295LiL5bGCLOebruWJjeagkeS4iui/mOS4jeWtmOWcqOivpeiKgueCue+8jOaXoOazleebtOaOpeWxleW8gO+8jOmcgOimgeetieagkeWKoOi9veWujOS5i+WQjuWGjeWxleW8gFxyXG4gICAgICBjb25zdCBpZCA9IHRoaXMuZ2V0UHJpbWFyeShub2RlRGF0YSk7XHJcbiAgICAgIGlmICh0aGlzLm5vZGVzV2FpdEV4cGFuZC5maW5kSW5kZXgobm9kZSA9PiBub2RlICYmIG5vZGUuaWQgPT09IGlkKSA8IDApIHtcclxuICAgICAgICB0aGlzLm5vZGVzV2FpdEV4cGFuZC5wdXNoKHsgaWQsIGV4cGFuZGVkOiBmYWxzZSB9KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDmoJHliqDovb3lrozmiJDkuovku7ZcclxuICAgKi9cclxuICBwcml2YXRlIG9uVHJlZUxvYWRDb21wbGV0ZSgpIHtcclxuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5ub2Rlc1dhaXRFeHBhbmQuZmluZEluZGV4KG5vZGUgPT4gIW5vZGUuZXhwYW5kZWQpO1xyXG4gICAgY29uc3Qgbm9kZURhdGEgPSB0aGlzLm5vZGVzV2FpdEV4cGFuZFtpbmRleF0gfHwge307XHJcbiAgICBjb25zdCB7IGlkIH0gPSBub2RlRGF0YTtcclxuICAgIGlmIChpZCkge1xyXG4gICAgICBjb25zdCByb3dOb2RlID0gdGhpcy5jb21wb25lbnQuZmluZFJvd05vZGUoaWQpO1xyXG4gICAgICBpZiAocm93Tm9kZSkge1xyXG4gICAgICAgIG5vZGVEYXRhLmV4cGFuZGVkID0gdHJ1ZTtcclxuICAgICAgICAvLyBpZiAobm9kZURhdGEgJiYgbm9kZURhdGEubm9kZSAmJiAhbm9kZURhdGEubm9kZS5leHBhbmRlZCkge1xyXG4gICAgICAgIC8vICAgcmV0dXJuO1xyXG4gICAgICAgIC8vIH1cclxuICAgICAgICB0aGlzLmNvbXBvbmVudC5leHBhbmROb2RlKGlkKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bkuLvplK5cclxuICAgKiBAcGFyYW0gbm9kZURhdGEgbm9kZURhdGFcclxuICAgKi9cclxuICBwcml2YXRlIGdldFByaW1hcnkobm9kZURhdGE6IGFueSkge1xyXG4gICAgcmV0dXJuIG5vZGVEYXRhW3RoaXMucHJpbWFyeUtleV07XHJcbiAgfVxyXG4gIC8vICNyZWdpb24g5bel5YW35pa55rOV77yM5b6F5Y2V54us5bCB6KOFXHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWtkOe6p+iKgueCueeahOaVsOaNrumbhuWQiFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Q2hpbGROb2Rlc0RhdGEoZlBhcmVudEVsZW1lbnQ6IHN0cmluZywgZkxheWVyOiBudW1iZXIpOiBhbnlbXSB7XHJcbiAgICBjb25zdCBjaGlsZE5vZGVzRGF0YSA9IFtdO1xyXG4gICAgdGhpcy5hbGxOb2Rlc0RhdGEuZm9yRWFjaCgobm9kZURhdGE6IGFueSkgPT4ge1xyXG5cclxuICAgICAgLy8gQHRvZG/vvJrlvoXliKDpmaTvvIzlhbzlrrnmsqHmnIloaWVyYXJjaHlJbmZv55qE5pWw5o2uIFxyXG4gICAgICBjb25zdCBoaWVyYXJjaHlJbmZvID0gdGhpcy5nZXRIaWVyYXJjaHlJbmZvKG5vZGVEYXRhKTsgLy9ub2RlRGF0YVt0aGlzLmhpZXJhcmNoeUluZm9LZXldO1xyXG4gICAgICBpZiAoIWhpZXJhcmNoeUluZm8pIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIOWMuemFjeiKgueCuVxyXG4gICAgICBjb25zdCBjdXJyZW50TGF5ZXIgPSBoaWVyYXJjaHlJbmZvWydsYXllciddO1xyXG4gICAgICBjb25zdCBjdXJyZW50UGFyZW50RWxlbWVudCA9IGhpZXJhcmNoeUluZm9bJ3BhcmVudEVsZW1lbnQnXTtcclxuICAgICAgaWYgKChjdXJyZW50TGF5ZXIgPT09IGZMYXllciArIDEpICYmIChjdXJyZW50UGFyZW50RWxlbWVudCA9PT0gZlBhcmVudEVsZW1lbnQgfHwgKCFjdXJyZW50UGFyZW50RWxlbWVudCAmJiBmUGFyZW50RWxlbWVudCA9PT0gJycpKSkge1xyXG4gICAgICAgIGNoaWxkTm9kZXNEYXRhLnB1c2gobm9kZURhdGEpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBjaGlsZE5vZGVzRGF0YTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRIaWVyYXJjaHlJbmZvKG5vZGVEYXRhOiBhbnkpOiBQYXJlbnRIaWVyYXJjaHlJbmZvIHtcclxuICAgIHJldHVybiB0aGlzLmdldFZhbHVlKG5vZGVEYXRhLCB0aGlzLmhpZXJhcmNoeUluZm9LZXkpOy8vbm9kZURhdGFbdGhpcy5oaWVyYXJjaHlJbmZvS2V5XTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRWYWx1ZSh0YXJnZXQ6IGFueSwgcGF0aDogc3RyaW5nKSB7XHJcbiAgICBpZiAocGF0aC5pbmRleE9mKCcvJykgPT09IC0xKSB7XHJcbiAgICAgIHJldHVybiB0YXJnZXRbcGF0aF07XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXRoczogYW55ID0gcGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgcmV0dXJuIHBhdGhzLnJlZHVjZSgocmVzdWx0LCBwYXRoKSA9PiB7XHJcbiAgICAgIHJldHVybiByZXN1bHQgJiYgcmVzdWx0W3BhdGhdO1xyXG4gICAgfSwgdGFyZ2V0KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5YiG57qn5L+h5oGv5Lit55qE5bGC57qnXHJcbiAgICogQHBhcmFtIG5vZGVEYXRhIG5vZGVEYXRhXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXROb2RlTGF5ZXIobm9kZURhdGE6IGFueSkge1xyXG4gICAgY29uc3QgaGllcmFyY2h5SW5mbyA9IHRoaXMuZ2V0SGllcmFyY2h5SW5mbyhub2RlRGF0YSk7XHJcbiAgICByZXR1cm4gaGllcmFyY2h5SW5mb1snbGF5ZXInXTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5YiG57qn5L+h5oGv5Lit55qE54i26IqC54K5XHJcbiAgICogQHBhcmFtIG5vZGVEYXRhIG5vZGVEYXRhXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXROb2RlUGFyZW50RWxlbWVudChub2RlRGF0YTogYW55KSB7XHJcbiAgICBjb25zdCBoaWVyYXJjaHlJbmZvID0gdGhpcy5nZXRIaWVyYXJjaHlJbmZvKG5vZGVEYXRhKTtcclxuICAgIHJldHVybiBoaWVyYXJjaHlJbmZvWydwYXJlbnRFbGVtZW50J107XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWxleW8gOeKtuaAgVxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNFeHBhbmRlZChuZXdEYXRhOiBhbnkpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IG9sZFRyZWVOb2RlID0gdGhpcy5nZXRPbGROb2RlKG5ld0RhdGEpO1xyXG4gICAgcmV0dXJuIG9sZFRyZWVOb2RlID8gb2xkVHJlZU5vZGUuZXhwYW5kZWQgOiB1bmRlZmluZWQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmmK/lkKbmmK/lj7blrZDoioLngrlcclxuICAgKiBAdG9kb++8muW6lOivpeeUqOaVsOaNruacrOi6q+eahGlzRGV0YWls5p2l5L+d6K+B77yM5L2G55uu5YmN5LiN5YeG56Gu77yM5by65Yi25YmN56uv6K6h566XXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpc0xlYWYobm9kZURhdGE6IGFueSk6IGJvb2xlYW4ge1xyXG4gICAgY29uc3QgaGllcmFyY2h5SW5mbyA9IHRoaXMuZ2V0SGllcmFyY2h5SW5mbyhub2RlRGF0YSk7Ly9ub2RlRGF0YVt0aGlzLmhpZXJhcmNoeUluZm9LZXldO1xyXG4gICAgY29uc3QgaXNEZXRhaWwgPSBoaWVyYXJjaHlJbmZvWydpc0RldGFpbCddO1xyXG4gICAgcmV0dXJuIGlzRGV0YWlsO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yik5pat6IqC54K55piv5ZCm5piv5paw5aKeXHJcbiAgICogQHRvZG/vvJrkuI3lupTor6Xov5nmoLfliKTmlq3vvIzlvoXkvJjljJbjgIJcclxuICAgKiBAc3VtbWFyeVxyXG4gICAqIDHjgIHpnZ7nqbrmoJHvvIjnqbrmoJHop4bkuLrliJ3mrKHliqDovb3mlbDmja7vvInvvJtcclxuICAgKiAy44CB5om+5LiN5Yiwb2xkTm9kZeOAglxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNOZXdOb2RlKG5vZGVEYXRhOiBhbnkpOiBib29sZWFuIHtcclxuICAgIGlmICh0aGlzLmFsbE9sZE5vZGVzTWFwLnNpemUgPT09IDApIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgb2xkVHJlZU5vZGUgPSB0aGlzLmdldE9sZE5vZGUobm9kZURhdGEpO1xyXG4gICAgcmV0dXJuIG9sZFRyZWVOb2RlID8gZmFsc2UgOiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bGV5byA54i26IqC54K5XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBleHBhbmRQYXJlbnROb2RlKG5vZGVEYXRhOiBhbnkpOiB2b2lkIHtcclxuICAgIGNvbnN0IHBhcmVudFRyZWVOb2RlID0gdGhpcy5nZXRQYXJlbnROb2RlKG5vZGVEYXRhKTtcclxuICAgIGlmICghcGFyZW50VHJlZU5vZGUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgcGFyZW50VHJlZU5vZGUubGVhZiA9IGZhbHNlO1xyXG4gICAgcGFyZW50VHJlZU5vZGUuZXhwYW5kZWQgPSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5p+l5om+54i26IqC54K5XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRQYXJlbnROb2RlKG5vZGVEYXRhOiBhbnkpOiBUcmVlTm9kZSB7XHJcbiAgICBjb25zdCBoaWVyYXJjaHlJbmZvID0gdGhpcy5nZXRIaWVyYXJjaHlJbmZvKG5vZGVEYXRhKTsvL25vZGVEYXRhW3RoaXMuaGllcmFyY2h5SW5mb0tleV07XHJcbiAgICBjb25zdCBsYXllciA9IGhpZXJhcmNoeUluZm9bJ2xheWVyJ107XHJcbiAgICBjb25zdCBwYXJlbnRFbGVtZW50ID0gaGllcmFyY2h5SW5mb1sncGFyZW50RWxlbWVudCddO1xyXG5cclxuICAgIGNvbnN0IGFsbE5vZGVzID0gQXJyYXkuZnJvbSh0aGlzLmFsbE5vZGVzTWFwLnZhbHVlcygpKTtcclxuICAgIGNvbnN0IHBhcmVudE5vZGUgPSBhbGxOb2Rlcy5maW5kKChub2RlOiBUcmVlTm9kZSkgPT4ge1xyXG4gICAgICBjb25zdCBjdXJyZW50TGF5ZXIgPSB0aGlzLmdldFZhbHVlKG5vZGUuZGF0YSwgdGhpcy5oaWVyYXJjaHlJbmZvS2V5KVsnbGF5ZXInXTsgLy9ub2RlLmRhdGFbdGhpcy5oaWVyYXJjaHlJbmZvS2V5XVsnbGF5ZXInXTtcclxuICAgICAgY29uc3QgY3VycmVudElkID0gbm9kZS5kYXRhW3RoaXMucHJpbWFyeUtleV07XHJcbiAgICAgIHJldHVybiBjdXJyZW50SWQgPT09IHBhcmVudEVsZW1lbnQgJiYgbGF5ZXIgPT09IChjdXJyZW50TGF5ZXIgKyAxKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBwYXJlbnROb2RlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W6ICB55qE5qCR6IqC54K5XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRPbGROb2RlKG5vZGVEYXRhOiBhbnkpOiBUcmVlTm9kZSB7XHJcbiAgICBjb25zdCBpZCA9IG5vZGVEYXRhW3RoaXMucHJpbWFyeUtleV07XHJcbiAgICByZXR1cm4gdGhpcy5hbGxPbGROb2Rlc01hcC5nZXQoaWQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5omT5bmzVHJlZU5vZGVz77yM5bm25pS+5YWl5LiA5LiqTWFw5LitXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZE5vZGVzRGF0YU1hcCh0cmVlTm9kZXM6IFRyZWVOb2RlW10pOiB2b2lkIHtcclxuICAgIHRyZWVOb2Rlcy5mb3JFYWNoKCh0cmVlTm9kZTogVHJlZU5vZGUpID0+IHtcclxuICAgICAgdGhpcy5hbGxPbGROb2Rlc01hcC5zZXQodHJlZU5vZGUuZGF0YVt0aGlzLnByaW1hcnlLZXldLCB0cmVlTm9kZSk7XHJcbiAgICAgIGlmICh0cmVlTm9kZS5jaGlsZHJlbikge1xyXG4gICAgICAgIHRoaXMuYnVpbGROb2Rlc0RhdGFNYXAodHJlZU5vZGUuY2hpbGRyZW4pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8vICNlbmRyZWdpb25cclxufVxyXG5cclxuZXhwb3J0IHsgUGFyZW50VHJlZU5vZGVCdWlsZGVyIH07XHJcblxyXG4iXX0=