/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { codes, modifiers } from './keys';
import { Subject } from 'rxjs';
import { filter } from 'rxjs/operators';
import { allPass, any, difference, identity, isNill } from './utils';
import * as i0 from "@angular/core";
/** @type {?} */
var $$ngOnDestroy = Symbol('OnDestroy');
var ShortcutsService = /** @class */ (function () {
    function ShortcutsService() {
        var _this = this;
        /**
         * 解析快捷键
         * 并为每个KEY 创建一个函数
         */
        this._shortcuts = [];
        /**
         * 控制按键时间.
         */
        this.throttleTime = 0;
        this._pressed = new Subject();
        /**
         * Streams of pressed events, can be used instead or with a command.
         */
        this.pressed$ = this._pressed.asObservable();
        /**
         * 禁用快捷键
         */
        this.disabled = false;
        this._ignored = ['INPUT', 'TEXTAREA', 'SELECT'];
        this.isAllowed = (/**
         * @param {?} shortcut
         * @return {?}
         */
        function (shortcut) {
            /** @type {?} */
            var target = (/** @type {?} */ (shortcut.event.target));
            if (target === shortcut.target) {
                return true;
            }
            if (shortcut.allowIn.length) {
                return !((/** @type {?} */ (difference(_this._ignored, shortcut.allowIn)))).includes(target.nodeName);
            }
            return !((/** @type {?} */ (_this._ignored))).includes(target.nodeName);
        });
        this.mapEvent = (/**
         * @param {?} event
         * @return {?}
         */
        function (event) { return _this._shortcuts
            .map((/**
         * @param {?} shortcut
         * @return {?}
         */
        function (shortcut) {
            return Object.assign({}, shortcut, {
                predicates: any(identity, shortcut.predicates.map((/**
                 * @param {?} predicates
                 * @return {?}
                 */
                function (predicates) { return allPass(predicates)(event); }))),
                event: event
            });
        }))
            .filter((/**
         * @param {?} shortcut
         * @return {?}
         */
        function (shortcut) { return shortcut.predicates; }))
            .reduce((/**
         * @param {?} acc
         * @param {?} shortcut
         * @return {?}
         */
        function (acc, shortcut) { return (acc.priority > shortcut.priority ? acc : shortcut); }), (/** @type {?} */ ({
            priority: 0
        }))); });
        /**
         * transforms a shortcut to:
         * a predicate function
         */
        this.getKeys = (/**
         * @param {?} command
         * @return {?}
         */
        function (command) { return command.map((/**
         * @param {?} key
         * @return {?}
         */
        function (key) { return key.trim(); })).filter((/**
         * @param {?} key
         * @return {?}
         */
        function (key) { return key !== '+'; }))
            .map((/**
         * @param {?} key
         * @return {?}
         */
        function (key) {
            // for modifiers like control key
            // look for event['ctrlKey']
            // otherwise use the keyCode
            if (modifiers.hasOwnProperty(key)) {
                return (/**
                 * @param {?} event
                 * @return {?}
                 */
                function (event) { return !!event[modifiers[key]]; });
            }
            return (/**
             * @param {?} event
             * @return {?}
             */
            function (event) {
                return codes[key]
                    ? event.keyCode === codes[key] || event.key === key
                    : event.keyCode === key.toUpperCase().charCodeAt(0);
            });
        })); });
        // this.keydown$ = fromEvent(document, 'keydown').pipe(
        //     filter(_ => !this.disabled),
        //     map(this.mapEvent),
        //     filter(
        //         (shortcut: ParsedShortcut) =>
        //             !shortcut.target || shortcut.event.target === shortcut.target
        //     ),
        //     filter((shortcut: ParsedShortcut) => isFunction(shortcut.command)),
        //     filter(this.isAllowed),
        //     tap((shortcut: any) => !shortcut.preventDefault || shortcut.event.preventDefault()),
        //     debounce(shortcut => timer(shortcut.throttleTime)),
        //     tap(shortcut => shortcut.command({ event: shortcut.event, key: shortcut.key })),
        //     tap(shortcut => this._pressed.next({ event: shortcut.event, key: shortcut.key })),
        //     catchError(error => of(error))
        // );
        // this.subscription = this.keydown$.subscribe();
    }
    Object.defineProperty(ShortcutsService.prototype, "shortcuts", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            return this._shortcuts;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Remove subscription.
     */
    /**
     * Remove subscription.
     * @return {?}
     */
    ShortcutsService.prototype.ngOnDestroy = /**
     * Remove subscription.
     * @return {?}
     */
    function () {
        if (this.subscription) {
            this.subscription.unsubscribe();
        }
    };
    /**
     * Enable all keyboard shortcuts
     */
    /**
     * Enable all keyboard shortcuts
     * @return {?}
     */
    ShortcutsService.prototype.enable = /**
     * Enable all keyboard shortcuts
     * @return {?}
     */
    function () {
        this.disabled = false;
        return this;
    };
    /**
     * Disable all keyboard shortcuts
     */
    /**
     * Disable all keyboard shortcuts
     * @return {?}
     */
    ShortcutsService.prototype.disable = /**
     * Disable all keyboard shortcuts
     * @return {?}
     */
    function () {
        this.disabled = true;
        return this;
    };
    /**
     * Check if all keyboard shortcuts are disabled.
     */
    /**
     * Check if all keyboard shortcuts are disabled.
     * @return {?}
     */
    ShortcutsService.prototype.isDisabled = /**
     * Check if all keyboard shortcuts are disabled.
     * @return {?}
     */
    function () {
        return this.disabled;
    };
    /**
     * Add new shortcut/s
     */
    /**
     * Add new shortcut/s
     * @param {?} shortcuts
     * @param {?=} instance
     * @return {?}
     */
    ShortcutsService.prototype.add = /**
     * Add new shortcut/s
     * @param {?} shortcuts
     * @param {?=} instance
     * @return {?}
     */
    function (shortcuts, instance) {
        var _a;
        shortcuts = Array.isArray(shortcuts) ? shortcuts : [shortcuts];
        if (instance) {
            var _b = tslib_1.__read(tslib_1.__spread(shortcuts.map((/**
             * @param {?} shortcut
             * @return {?}
             */
            function (shortcut) { return shortcut.key; }))), 1), key = _b[0];
            this.bindOnDestroy(instance, key);
        }
        (_a = this._shortcuts).push.apply(_a, tslib_1.__spread(this.parseCommand(shortcuts)));
        return this;
    };
    /**
     * bind to the component ngOnDestroy to remove related keys
     * when component is destroyed.
     * @param instance - component to remove keys when ngOnDestroy is called.
     * @param keys
     */
    /**
     * bind to the component ngOnDestroy to remove related keys
     * when component is destroyed.
     * @private
     * @param {?} instance - component to remove keys when ngOnDestroy is called.
     * @param {?} keys
     * @return {?}
     */
    ShortcutsService.prototype.bindOnDestroy = /**
     * bind to the component ngOnDestroy to remove related keys
     * when component is destroyed.
     * @private
     * @param {?} instance - component to remove keys when ngOnDestroy is called.
     * @param {?} keys
     * @return {?}
     */
    function (instance, keys) {
        if (instance.ngOnDestroy) {
            instance[$$ngOnDestroy] = instance.ngOnDestroy;
        }
        /** @type {?} */
        var that = this;
        instance.ngOnDestroy = (/**
         * @return {?}
         */
        function () {
            /** @type {?} */
            var onDestroy = instance[$$ngOnDestroy];
            if (onDestroy) {
                onDestroy.apply(this);
            }
            that.remove(keys);
        });
        return this;
    };
    /**
     * Remove a command based on key or array of keys.
     * can be used for cleanup.
     * @param key
     * @returns
     */
    /**
     * Remove a command based on key or array of keys.
     * can be used for cleanup.
     * @param {?} key
     * @return {?}
     */
    ShortcutsService.prototype.remove = /**
     * Remove a command based on key or array of keys.
     * can be used for cleanup.
     * @param {?} key
     * @return {?}
     */
    function (key) {
        /** @type {?} */
        var keys = Array.isArray(key) ? key : [key];
        this._shortcuts = this._shortcuts.filter((/**
         * @param {?} shortcut
         * @return {?}
         */
        function (shortcut) {
            return !shortcut.key.find((/**
             * @param {?} sKey
             * @return {?}
             */
            function (sKey) {
                return keys.filter((/**
                 * @param {?} k
                 * @return {?}
                 */
                function (k) { return k === sKey; })).length > 0;
            }));
        }));
        return this;
    };
    /**
     * Returns an observable of keyboard shortcut filtered by a specific key.
     * @param key - the key to filter the observable by.
     */
    /**
     * Returns an observable of keyboard shortcut filtered by a specific key.
     * @param {?} key - the key to filter the observable by.
     * @return {?}
     */
    ShortcutsService.prototype.select = /**
     * Returns an observable of keyboard shortcut filtered by a specific key.
     * @param {?} key - the key to filter the observable by.
     * @return {?}
     */
    function (key) {
        return this.pressed$.pipe(filter((/**
         * @param {?} __0
         * @return {?}
         */
        function (_a) {
            var event = _a.event, eventKeys = _a.key;
            return !!eventKeys.find((/**
             * @param {?} eventKey
             * @return {?}
             */
            function (eventKey) { return eventKey === key; }));
        })));
    };
    /**
     * Parse each command using getKeys function
     */
    /**
     * Parse each command using getKeys function
     * @private
     * @param {?} command
     * @return {?}
     */
    ShortcutsService.prototype.parseCommand = /**
     * Parse each command using getKeys function
     * @private
     * @param {?} command
     * @return {?}
     */
    function (command) {
        var _this = this;
        /** @type {?} */
        var commands = Array.isArray(command) ? command : [command];
        return commands.map((/**
         * @param {?} cmd
         * @return {?}
         */
        function (cmd) {
            /** @type {?} */
            var keys = Array.isArray(cmd.key) ? cmd.key : [cmd.key];
            /** @type {?} */
            var priority = Math.max.apply(Math, tslib_1.__spread(keys.map((/**
             * @param {?} key
             * @return {?}
             */
            function (key) { return key.split(' ').length; }))));
            /** @type {?} */
            var predicates = keys.map((/**
             * @param {?} key
             * @return {?}
             */
            function (key) { return _this.getKeys(key.split(' ')); }));
            return (/** @type {?} */ (tslib_1.__assign({}, cmd, { allowIn: cmd.allowIn || [], key: keys, throttle: isNill(cmd.throttleTime) ? _this.throttleTime : cmd.throttleTime, priority: priority, predicates: predicates })));
        }));
    };
    ShortcutsService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    ShortcutsService.ctorParameters = function () { return []; };
    /** @nocollapse */ ShortcutsService.ngInjectableDef = i0.defineInjectable({ factory: function ShortcutsService_Factory() { return new ShortcutsService(); }, token: ShortcutsService, providedIn: "root" });
    return ShortcutsService;
}());
export { ShortcutsService };
if (false) {
    /**
     * 解析快捷键
     * 并为每个KEY 创建一个函数
     * @type {?}
     * @private
     */
    ShortcutsService.prototype._shortcuts;
    /**
     * 控制按键时间.
     * @type {?}
     * @private
     */
    ShortcutsService.prototype.throttleTime;
    /**
     * @type {?}
     * @private
     */
    ShortcutsService.prototype._pressed;
    /**
     * Streams of pressed events, can be used instead or with a command.
     * @type {?}
     */
    ShortcutsService.prototype.pressed$;
    /**
     * 禁用快捷键
     * @type {?}
     * @private
     */
    ShortcutsService.prototype.disabled;
    /**
     * @type {?}
     * @private
     */
    ShortcutsService.prototype._ignored;
    /**
     * Subscription for on destroy.
     * @type {?}
     * @private
     */
    ShortcutsService.prototype.subscription;
    /**
     * @type {?}
     * @private
     */
    ShortcutsService.prototype.keydown$;
    /**
     * @type {?}
     * @private
     */
    ShortcutsService.prototype.isAllowed;
    /**
     * @type {?}
     * @private
     */
    ShortcutsService.prototype.mapEvent;
    /**
     * transforms a shortcut to:
     * a predicate function
     * @type {?}
     * @private
     */
    ShortcutsService.prototype.getKeys;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hvcnRjdXRzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLXNob3J0Y3V0cy8iLCJzb3VyY2VzIjpbImxpYi9zaG9ydGN1dHMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDdEQsT0FBTyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFFMUMsT0FBTyxFQUEyQixPQUFPLEVBQXVCLE1BQU0sTUFBTSxDQUFDO0FBRTdFLE9BQU8sRUFBTyxNQUFNLEVBQTZCLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBYyxNQUFNLEVBQUUsTUFBTSxTQUFTLENBQUM7OztJQUUzRSxhQUFhLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQztBQUV6QztJQW9FSTtRQUFBLGlCQWlCQzs7Ozs7UUE3RU8sZUFBVSxHQUFxQixFQUFFLENBQUM7Ozs7UUFLbEMsaUJBQVksR0FBRyxDQUFDLENBQUM7UUFFakIsYUFBUSxHQUFHLElBQUksT0FBTyxFQUF1QixDQUFDOzs7O1FBSy9DLGFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRSxDQUFDOzs7O1FBS3ZDLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFFakIsYUFBUSxHQUFHLENBQUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLENBQUMsQ0FBQztRQVMzQyxjQUFTOzs7O1FBQUcsVUFBQyxRQUF3Qjs7Z0JBQ25DLE1BQU0sR0FBRyxtQkFBQSxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBZTtZQUNuRCxJQUFJLE1BQU0sS0FBSyxRQUFRLENBQUMsTUFBTSxFQUFFO2dCQUM1QixPQUFPLElBQUksQ0FBQzthQUNmO1lBQ0QsSUFBSSxRQUFRLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFB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QUMsS0FBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFlBQVksRUFDekUsUUFBUSxFQUFFLFFBQVEsRUFDbEIsVUFBVSxFQUFFLFVBQVUsS0FDUCxDQUFDO1FBQ3hCLENBQUMsRUFBQyxDQUFDO0lBQ1AsQ0FBQzs7Z0JBMU5KLFVBQVUsU0FBQztvQkFDUixVQUFVLEVBQUUsTUFBTTtpQkFDckI7Ozs7OzJCQVpEO0NBcU9DLEFBM05ELElBMk5DO1NBeE5ZLGdCQUFnQjs7Ozs7Ozs7SUFLekIsc0NBQTBDOzs7Ozs7SUFLMUMsd0NBQXlCOzs7OztJQUV6QixvQ0FBc0Q7Ozs7O0lBS3RELG9DQUErQzs7Ozs7O0lBSy9DLG9DQUF5Qjs7Ozs7SUFFekIsb0NBQW1EOzs7Ozs7SUFLbkQsd0NBQTRDOzs7OztJQUU1QyxvQ0FBaUI7Ozs7O0lBRWpCLHFDQVNDOzs7OztJQUVELG9DQWF3Qjs7Ozs7OztJQThIeEIsbUNBWUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgY29kZXMsIG1vZGlmaWVycyB9IGZyb20gJy4va2V5cyc7XHJcblxyXG5pbXBvcnQge1N1YnNjcmlwdGlvbiwgT2JzZXJ2YWJsZSwgU3ViamVjdCwgZnJvbUV2ZW50LCB0aW1lciwgb2Z9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBTaG9ydGN1dEV2ZW50T3V0cHV0LCBQYXJzZWRTaG9ydGN1dCwgU2hvcnRjdXRJbnB1dCB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBtYXAsIGZpbHRlciwgdGFwLCBkZWJvdW5jZSwgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgYWxsUGFzcywgYW55LCBkaWZmZXJlbmNlLCBpZGVudGl0eSwgaXNGdW5jdGlvbiwgaXNOaWxsIH0gZnJvbSAnLi91dGlscyc7XHJcblxyXG5jb25zdCAkJG5nT25EZXN0cm95ID0gU3ltYm9sKCdPbkRlc3Ryb3knKTtcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICAgIHByb3ZpZGVkSW46ICdyb290J1xyXG59KVxyXG5leHBvcnQgY2xhc3MgU2hvcnRjdXRzU2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XHJcbiAgICAvKipcclxuICAgICAqIOino+aekOW/q+aNt+mUrlxyXG4gICAgICog5bm25Li65q+P5LiqS0VZIOWIm+W7uuS4gOS4quWHveaVsFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9zaG9ydGN1dHM6IFBhcnNlZFNob3J0Y3V0W10gPSBbXTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOaOp+WItuaMiemUruaXtumXtC5cclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSB0aHJvdHRsZVRpbWUgPSAwO1xyXG5cclxuICAgIHByaXZhdGUgX3ByZXNzZWQgPSBuZXcgU3ViamVjdDxTaG9ydGN1dEV2ZW50T3V0cHV0PigpO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogU3RyZWFtcyBvZiBwcmVzc2VkIGV2ZW50cywgY2FuIGJlIHVzZWQgaW5zdGVhZCBvciB3aXRoIGEgY29tbWFuZC5cclxuICAgICAqL1xyXG4gICAgcHVibGljIHByZXNzZWQkID0gdGhpcy5fcHJlc3NlZC5hc09ic2VydmFibGUoKTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOemgeeUqOW/q+aNt+mUrlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGRpc2FibGVkID0gZmFsc2U7XHJcblxyXG4gICAgcHJpdmF0ZSBfaWdub3JlZCA9IFsnSU5QVVQnLCAnVEVYVEFSRUEnLCAnU0VMRUNUJ107XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTdWJzY3JpcHRpb24gZm9yIG9uIGRlc3Ryb3kuXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgcmVhZG9ubHkgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XHJcblxyXG4gICAgcHJpdmF0ZSBrZXlkb3duJDtcclxuXHJcbiAgICBwcml2YXRlIGlzQWxsb3dlZCA9IChzaG9ydGN1dDogUGFyc2VkU2hvcnRjdXQpID0+IHtcclxuICAgICAgICBjb25zdCB0YXJnZXQgPSBzaG9ydGN1dC5ldmVudC50YXJnZXQgYXMgSFRNTEVsZW1lbnQ7XHJcbiAgICAgICAgaWYgKHRhcmdldCA9PT0gc2hvcnRjdXQudGFyZ2V0KSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoc2hvcnRjdXQuYWxsb3dJbi5sZW5ndGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuICEoPGFueT5kaWZmZXJlbmNlKHRoaXMuX2lnbm9yZWQsIHNob3J0Y3V0LmFsbG93SW4pKS5pbmNsdWRlcyh0YXJnZXQubm9kZU5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gISg8YW55PnRoaXMuX2lnbm9yZWQpLmluY2x1ZGVzKHRhcmdldC5ub2RlTmFtZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBtYXBFdmVudCA9IGV2ZW50ID0+IHRoaXMuX3Nob3J0Y3V0c1xyXG4gICAgICAgIC5tYXAoc2hvcnRjdXQgPT5cclxuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih7fSwgc2hvcnRjdXQsIHtcclxuICAgICAgICAgICAgICAgIHByZWRpY2F0ZXM6IGFueShcclxuICAgICAgICAgICAgICAgICAgICBpZGVudGl0eSxcclxuICAgICAgICAgICAgICAgICAgICBzaG9ydGN1dC5wcmVkaWNhdGVzLm1hcCgocHJlZGljYXRlczogYW55KSA9PiBhbGxQYXNzKHByZWRpY2F0ZXMpKGV2ZW50KSlcclxuICAgICAgICAgICAgICAgICksXHJcbiAgICAgICAgICAgICAgICBldmVudDogZXZlbnRcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICApXHJcbiAgICAgICAgLmZpbHRlcihzaG9ydGN1dCA9PiBzaG9ydGN1dC5wcmVkaWNhdGVzKVxyXG4gICAgICAgIC5yZWR1Y2UoKGFjYywgc2hvcnRjdXQpID0+IChhY2MucHJpb3JpdHkgPiBzaG9ydGN1dC5wcmlvcml0eSA/IGFjYyA6IHNob3J0Y3V0KSwge1xyXG4gICAgICAgICAgICBwcmlvcml0eTogMFxyXG4gICAgICAgIH0gYXMgUGFyc2VkU2hvcnRjdXQpXHJcblxyXG4gICAgcHJpdmF0ZSBnZXQgc2hvcnRjdXRzKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9zaG9ydGN1dHM7XHJcbiAgICB9XHJcblxyXG5cclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICAvLyB0aGlzLmtleWRvd24kID0gZnJvbUV2ZW50KGRvY3VtZW50LCAna2V5ZG93bicpLnBpcGUoXHJcbiAgICAgICAgLy8gICAgIGZpbHRlcihfID0+ICF0aGlzLmRpc2FibGVkKSxcclxuICAgICAgICAvLyAgICAgbWFwKHRoaXMubWFwRXZlbnQpLFxyXG4gICAgICAgIC8vICAgICBmaWx0ZXIoXHJcbiAgICAgICAgLy8gICAgICAgICAoc2hvcnRjdXQ6IFBhcnNlZFNob3J0Y3V0KSA9PlxyXG4gICAgICAgIC8vICAgICAgICAgICAgICFzaG9ydGN1dC50YXJnZXQgfHwgc2hvcnRjdXQuZXZlbnQudGFyZ2V0ID09PSBzaG9ydGN1dC50YXJnZXRcclxuICAgICAgICAvLyAgICAgKSxcclxuICAgICAgICAvLyAgICAgZmlsdGVyKChzaG9ydGN1dDogUGFyc2VkU2hvcnRjdXQpID0+IGlzRnVuY3Rpb24oc2hvcnRjdXQuY29tbWFuZCkpLFxyXG4gICAgICAgIC8vICAgICBmaWx0ZXIodGhpcy5pc0FsbG93ZWQpLFxyXG4gICAgICAgIC8vICAgICB0YXAoKHNob3J0Y3V0OiBhbnkpID0+ICFzaG9ydGN1dC5wcmV2ZW50RGVmYXVsdCB8fCBzaG9ydGN1dC5ldmVudC5wcmV2ZW50RGVmYXVsdCgpKSxcclxuICAgICAgICAvLyAgICAgZGVib3VuY2Uoc2hvcnRjdXQgPT4gdGltZXIoc2hvcnRjdXQudGhyb3R0bGVUaW1lKSksXHJcbiAgICAgICAgLy8gICAgIHRhcChzaG9ydGN1dCA9PiBzaG9ydGN1dC5jb21tYW5kKHsgZXZlbnQ6IHNob3J0Y3V0LmV2ZW50LCBrZXk6IHNob3J0Y3V0LmtleSB9KSksXHJcbiAgICAgICAgLy8gICAgIHRhcChzaG9ydGN1dCA9PiB0aGlzLl9wcmVzc2VkLm5leHQoeyBldmVudDogc2hvcnRjdXQuZXZlbnQsIGtleTogc2hvcnRjdXQua2V5IH0pKSxcclxuICAgICAgICAvLyAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiBvZihlcnJvcikpXHJcbiAgICAgICAgLy8gKTtcclxuICAgICAgICAvLyB0aGlzLnN1YnNjcmlwdGlvbiA9IHRoaXMua2V5ZG93biQuc3Vic2NyaWJlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZW1vdmUgc3Vic2NyaXB0aW9uLlxyXG4gICAgICovXHJcbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5zdWJzY3JpcHRpb24pIHtcclxuICAgICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBFbmFibGUgYWxsIGtleWJvYXJkIHNob3J0Y3V0c1xyXG4gICAgICovXHJcbiAgICBlbmFibGUoKTogU2hvcnRjdXRzU2VydmljZSB7XHJcbiAgICAgICAgdGhpcy5kaXNhYmxlZCA9IGZhbHNlO1xyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogRGlzYWJsZSBhbGwga2V5Ym9hcmQgc2hvcnRjdXRzXHJcbiAgICAgKi9cclxuICAgIGRpc2FibGUoKTogU2hvcnRjdXRzU2VydmljZSB7XHJcbiAgICAgICAgdGhpcy5kaXNhYmxlZCA9IHRydWU7XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDaGVjayBpZiBhbGwga2V5Ym9hcmQgc2hvcnRjdXRzIGFyZSBkaXNhYmxlZC5cclxuICAgICAqL1xyXG4gICAgaXNEaXNhYmxlZCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5kaXNhYmxlZDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEFkZCBuZXcgc2hvcnRjdXQvc1xyXG4gICAgICovXHJcbiAgICBwdWJsaWMgYWRkKHNob3J0Y3V0czogU2hvcnRjdXRJbnB1dFtdIHwgU2hvcnRjdXRJbnB1dCwgaW5zdGFuY2U/OiBhbnkpOiBTaG9ydGN1dHNTZXJ2aWNlIHtcclxuICAgICAgICBzaG9ydGN1dHMgPSBBcnJheS5pc0FycmF5KHNob3J0Y3V0cykgPyBzaG9ydGN1dHMgOiBbc2hvcnRjdXRzXTtcclxuICAgICAgICBpZiAoaW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgY29uc3QgW2tleV0gPSBbLi4uc2hvcnRjdXRzLm1hcChzaG9ydGN1dCA9PiBzaG9ydGN1dC5rZXkpXTtcclxuICAgICAgICAgICAgdGhpcy5iaW5kT25EZXN0cm95KGluc3RhbmNlLCBrZXkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5fc2hvcnRjdXRzLnB1c2goLi4udGhpcy5wYXJzZUNvbW1hbmQoc2hvcnRjdXRzKSk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBiaW5kIHRvIHRoZSBjb21wb25lbnQgbmdPbkRlc3Ryb3kgdG8gcmVtb3ZlIHJlbGF0ZWQga2V5c1xyXG4gICAgICogd2hlbiBjb21wb25lbnQgaXMgZGVzdHJveWVkLlxyXG4gICAgICogQHBhcmFtIGluc3RhbmNlIC0gY29tcG9uZW50IHRvIHJlbW92ZSBrZXlzIHdoZW4gbmdPbkRlc3Ryb3kgaXMgY2FsbGVkLlxyXG4gICAgICogQHBhcmFtIGtleXNcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBiaW5kT25EZXN0cm95KGluc3RhbmNlOiBhbnksIGtleXM6IHN0cmluZyB8IHN0cmluZ1tdKTogU2hvcnRjdXRzU2VydmljZSB7XHJcbiAgICAgICAgaWYgKGluc3RhbmNlLm5nT25EZXN0cm95KSB7XHJcbiAgICAgICAgICAgIGluc3RhbmNlWyQkbmdPbkRlc3Ryb3ldID0gaW5zdGFuY2UubmdPbkRlc3Ryb3k7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xyXG4gICAgICAgIGluc3RhbmNlLm5nT25EZXN0cm95ID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG9uRGVzdHJveSA9IGluc3RhbmNlWyQkbmdPbkRlc3Ryb3ldO1xyXG4gICAgICAgICAgICBpZiAob25EZXN0cm95KSB7XHJcbiAgICAgICAgICAgICAgICBvbkRlc3Ryb3kuYXBwbHkodGhpcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhhdC5yZW1vdmUoa2V5cyk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJlbW92ZSBhIGNvbW1hbmQgYmFzZWQgb24ga2V5IG9yIGFycmF5IG9mIGtleXMuXHJcbiAgICAgKiBjYW4gYmUgdXNlZCBmb3IgY2xlYW51cC5cclxuICAgICAqIEBwYXJhbSBrZXlcclxuICAgICAqIEByZXR1cm5zXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyByZW1vdmUoa2V5OiBzdHJpbmcgfCBzdHJpbmdbXSk6IFNob3J0Y3V0c1NlcnZpY2Uge1xyXG4gICAgICAgIGNvbnN0IGtleXM6IHN0cmluZ1tdID0gQXJyYXkuaXNBcnJheShrZXkpID8ga2V5IDogW2tleV07XHJcbiAgICAgICAgdGhpcy5fc2hvcnRjdXRzID0gdGhpcy5fc2hvcnRjdXRzLmZpbHRlcihzaG9ydGN1dCA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiAhc2hvcnRjdXQua2V5LmZpbmQoc0tleSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ga2V5cy5maWx0ZXIoayA9PiBrID09PSBzS2V5KS5sZW5ndGggPiAwO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJldHVybnMgYW4gb2JzZXJ2YWJsZSBvZiBrZXlib2FyZCBzaG9ydGN1dCBmaWx0ZXJlZCBieSBhIHNwZWNpZmljIGtleS5cclxuICAgICAqIEBwYXJhbSBrZXkgLSB0aGUga2V5IHRvIGZpbHRlciB0aGUgb2JzZXJ2YWJsZSBieS5cclxuICAgICAqL1xyXG4gICAgcHVibGljIHNlbGVjdChrZXk6IHN0cmluZyk6IE9ic2VydmFibGU8U2hvcnRjdXRFdmVudE91dHB1dD4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnByZXNzZWQkLnBpcGUoXHJcbiAgICAgICAgICAgIGZpbHRlcigoe2V2ZW50LCBrZXk6IGV2ZW50S2V5c30pID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAhIWV2ZW50S2V5cy5maW5kKGV2ZW50S2V5ID0+IGV2ZW50S2V5ID09PSBrZXkpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiB0cmFuc2Zvcm1zIGEgc2hvcnRjdXQgdG86XHJcbiAgICAgKiBhIHByZWRpY2F0ZSBmdW5jdGlvblxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGdldEtleXMgPSAoY29tbWFuZDogc3RyaW5nW10pID0+IGNvbW1hbmQubWFwKGtleSA9PiBrZXkudHJpbSgpKS5maWx0ZXIoa2V5ID0+IGtleSAhPT0gJysnKVxyXG4gICAgLm1hcChrZXkgPT4ge1xyXG4gICAgICAgIC8vIGZvciBtb2RpZmllcnMgbGlrZSBjb250cm9sIGtleVxyXG4gICAgICAgIC8vIGxvb2sgZm9yIGV2ZW50WydjdHJsS2V5J11cclxuICAgICAgICAvLyBvdGhlcndpc2UgdXNlIHRoZSBrZXlDb2RlXHJcbiAgICAgICAgaWYgKG1vZGlmaWVycy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBldmVudCA9PiAhIWV2ZW50W21vZGlmaWVyc1trZXldXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGV2ZW50ID0+XHJcbiAgICAgICAgICAgIGNvZGVzW2tleV1cclxuICAgICAgICAgICAgICAgID8gZXZlbnQua2V5Q29kZSA9PT0gY29kZXNba2V5XSB8fCBldmVudC5rZXkgPT09IGtleVxyXG4gICAgICAgICAgICAgICAgOiBldmVudC5rZXlDb2RlID09PSBrZXkudG9VcHBlckNhc2UoKS5jaGFyQ29kZUF0KDApO1xyXG4gICAgfSlcclxuXHJcbiAgICAvKipcclxuICAgICAqIFBhcnNlIGVhY2ggY29tbWFuZCB1c2luZyBnZXRLZXlzIGZ1bmN0aW9uXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgcGFyc2VDb21tYW5kKGNvbW1hbmQ6IFNob3J0Y3V0SW5wdXQgfCBTaG9ydGN1dElucHV0W10pOiBQYXJzZWRTaG9ydGN1dFtdIHtcclxuICAgICAgICBjb25zdCBjb21tYW5kcyA9IEFycmF5LmlzQXJyYXkoY29tbWFuZCkgPyBjb21tYW5kIDogW2NvbW1hbmRdO1xyXG4gICAgICAgIHJldHVybiBjb21tYW5kcy5tYXAoIChjbWQ6IFNob3J0Y3V0SW5wdXQpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qga2V5cyA9IEFycmF5LmlzQXJyYXkoY21kLmtleSkgPyBjbWQua2V5IDogW2NtZC5rZXldO1xyXG4gICAgICAgICAgICBjb25zdCBwcmlvcml0eSA9IE1hdGgubWF4KC4uLmtleXMubWFwKGtleSA9PiBrZXkuc3BsaXQoJyAnKS5sZW5ndGgpKTtcclxuICAgICAgICAgICAgY29uc3QgcHJlZGljYXRlcyA9IGtleXMubWFwKGtleSA9PiB0aGlzLmdldEtleXMoa2V5LnNwbGl0KCcgJykpKTtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIC4uLmNtZCxcclxuICAgICAgICAgICAgICAgIGFsbG93SW46IGNtZC5hbGxvd0luIHx8IFtdLFxyXG4gICAgICAgICAgICAgICAga2V5OiBrZXlzLFxyXG4gICAgICAgICAgICAgICAgdGhyb3R0bGU6IGlzTmlsbChjbWQudGhyb3R0bGVUaW1lKSA/IHRoaXMudGhyb3R0bGVUaW1lIDogY21kLnRocm90dGxlVGltZSxcclxuICAgICAgICAgICAgICAgIHByaW9yaXR5OiBwcmlvcml0eSxcclxuICAgICAgICAgICAgICAgIHByZWRpY2F0ZXM6IHByZWRpY2F0ZXNcclxuICAgICAgICAgICAgfSBhcyBQYXJzZWRTaG9ydGN1dDtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG4iXX0=