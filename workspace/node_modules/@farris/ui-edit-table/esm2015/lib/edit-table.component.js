/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChangeDetectorRef, Component, EventEmitter, Injector, Input, Output } from "@angular/core";
import { IdService } from "@farris/ui-common";
import { MessagerService } from "@farris/ui-messager";
import { NotifyService } from "@farris/ui-notify";
export class EditTableComponent {
    /**
     * @param {?} injector
     * @param {?} idSer
     * @param {?} cdr
     * @param {?} msgSer
     * @param {?} notifySer
     */
    constructor(injector, idSer, cdr, msgSer, notifySer) {
        this.injector = injector;
        this.idSer = idSer;
        this.cdr = cdr;
        this.msgSer = msgSer;
        this.notifySer = notifySer;
        this.data = [];
        this.selectId = '';
        /**
         * 行数据标识字段
         */
        this.idField = '_id';
        this.dataChange = new EventEmitter();
        this.selectedItem = null;
    }
    /**
     * @return {?}
     */
    ngOnInit() { }
    /**
     * @private
     * @return {?}
     */
    dataChanged() {
        this.dataChange.emit(this.data);
    }
    /**
     * @private
     * @return {?}
     */
    createNewData() {
        return this.columns.reduce((/**
         * @param {?} p
         * @param {?} n
         * @return {?}
         */
        (p, n) => {
            if (n.field.indexOf('.') > -1) {
                p = Object.assign(p, n.defaultValue);
            }
            else {
                p[n.field] = n.defaultValue || null;
            }
            return p;
        }), { _id: this.idSer.guid() });
    }
    /**
     * 插入新行
     * @param {?} index
     * @param {?=} $event
     * @return {?}
     */
    insertRow(index, $event) {
        if ($event) {
            $event.stopPropagation();
        }
        /** @type {?} */
        const newItem = this.createNewData();
        /** @type {?} */
        const _newItem = Object.assign({}, newItem);
        this.data.splice(index + 1, 0, _newItem);
        this.dataChanged();
    }
    /**
     * 新增行
     * @param {?} $event
     * @return {?}
     */
    appendNew($event) {
        $event.stopPropagation();
        /** @type {?} */
        const newItem = this.createNewData();
        this.data = [...this.data, newItem];
        this.dataChanged();
    }
    /**
     * 选中行
     * @param {?} $event
     * @param {?} rowData
     * @param {?} index
     * @return {?}
     */
    selectRow($event, rowData, index) {
        if ($event) {
            $event.stopPropagation();
        }
        this.selectId = rowData[this.idField];
        this.selectedItem = {
            data: rowData,
            index
        };
    }
    /**
     * @param {?} $event
     * @param {?} index
     * @return {?}
     */
    deleteRow($event, index) {
        if ($event) {
            $event.stopPropagation();
        }
        this.data.splice(index, 1);
        this.dataChanged();
        if (this.selectedItem) {
            if (index === this.selectedItem.index) {
                if (this.data[index]) {
                    this.selectedItem = { index: index, data: this.data[index] };
                }
                else {
                    if (this.data[index - 1]) {
                        this.selectedItem = { index: index - 1, data: this.data[index - 1] };
                    }
                    else {
                        this.selectedItem = null;
                    }
                }
            }
            else {
                if (!this.data[this.selectedItem.index]) {
                    if (this.selectedItem.index > index) {
                        this.selectedItem.index = this.selectedItem.index - 1;
                    }
                    else {
                        this.selectedItem.index = this.selectedItem.index + 1;
                    }
                }
            }
            this.cdr.detectChanges();
        }
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    clear($event) {
        this.msgSer.question('确认要清空当前所有条件吗？', (/**
         * @return {?}
         */
        () => {
            this.data = [];
            this.selectedItem = null;
            this.selectId = '';
            this.dataChanged();
        }));
    }
    /**
     * @param {?} $event
     * @param {?} action
     * @return {?}
     */
    moveRow($event, action) {
        if ($event) {
            $event.stopPropagation();
        }
        if (!this.selectedItem) {
            this.notifySer.warning('请选择要移动的行');
            return;
        }
        /** @type {?} */
        const index = this.selectedItem.index;
        /** @type {?} */
        let tempArr = [];
        switch (action) {
            case 'top':
                this.data.unshift(this.selectedItem.data);
                this.data.splice(index + 1, 1);
                this.selectedItem.index = 0;
                break;
            case 'bottom':
                this.data.push(this.selectedItem.data);
                this.data.splice(index, 1);
                this.selectedItem.index = this.data.length - 1;
                break;
            case 'up':
                tempArr = this.data.splice(index, 1);
                this.data.splice(index - 1, 0, ...tempArr);
                this.selectedItem.index = index - 1;
                break;
            case 'down':
                tempArr = this.data.splice(index, 1);
                this.data.splice(index + 1, 0, ...tempArr);
                this.selectedItem.index = index + 1;
                break;
        }
        this.dataChanged();
    }
    /**
     * @param {?} $event
     * @param {?} ctx
     * @return {?}
     */
    onComboLookupValueChange($event, ctx) {
        if (ctx && ctx.options && ctx.options.valueChange) {
            const { rowData, field } = ctx;
            ctx.options.valueChange(Object.assign({}, $event, { data: rowData, field }));
        }
    }
}
EditTableComponent.decorators = [
    { type: Component, args: [{
                selector: "farris-edit-table",
                template: "<table class=\"table table-bordered\">\r\n    <thead>\r\n        <tr>\r\n            <th style=\"width: 80px\"></th>\r\n            <th *ngFor=\"let col of columns\">{{ col.title }}</th>\r\n        </tr>\r\n    </thead>\r\n    <tbody>\r\n        <tr *ngFor=\"let d of data; let i = index\" [class.selected]=\"selectId === d['_id']\" (click)=\"selectRow($event, d, i)\">\r\n            <td style=\"width: 80px;text-overflow: unset;\">\r\n                <button class=\"k-button k-button-icontext k-flat p-0 mr-3\">\r\n                    <span class=\"f-icon f-icon-add\"></span>\r\n                </button>\r\n                <button (click)=\"deleteRow($event, i)\" class=\"k-button k-button-icontext k-flat p-0\">\r\n                    <span class=\"f-icon f-icon-kpi-trend-equal\"></span>\r\n                </button>\r\n            </td>\r\n            <td *ngFor=\"let col of columns\">\r\n                <ng-container *ngIf=\"col.editTemplate\" [ngTemplateOutlet]=\"col.editTemplate\" [ngTemplateOutletContext]=\"{\r\n                        $implicit: { column: col, rowData: d }\r\n                    }\"></ng-container>\r\n                <ng-container *ngIf=\"!col.editTemplage\" [ngSwitch]=\"(d | editortype: col)\">\r\n                    <!-- text -->\r\n                    <ng-container  *ngSwitchCase=\"'text'\"  [ngTemplateOutlet]=\"textTempRef\" [ngTemplateOutletContext]=\"{$implicit: { field: col.field, column: col, rowData: d, options:  (d |editoropts: col) }}\"></ng-container >\r\n                    <!-- input-group -->\r\n                    <ng-container *ngSwitchCase=\"'input-group'\"  [ngTemplateOutlet]=\"inputgroupTempRef\" [ngTemplateOutletContext]=\"{$implicit: { field: col.field, column: col, rowData: d, options: (d |editoropts: col) }}\"></ng-container >\r\n\r\n                    <!-- combo-list -->\r\n                    <ng-container  *ngSwitchCase=\"'combo-list'\"  [ngTemplateOutlet]=\"combolistTempRef\" [ngTemplateOutletContext]=\"{$implicit: { field: col.field, column: col, rowData: d, options: (d |editoropts: col) }}\"></ng-container >\r\n                    <!-- checkbox -->\r\n                    <!-- numberbox -->\r\n                    <ng-container *ngSwitchCase=\"'number-spinner'\" [ngTemplateOutlet]=\"numberspinnerTempRef\" [ngTemplateOutletContext]=\"{$implicit: { field: col.field, column: col, rowData: d, options: (d |editoropts: col) }}\"></ng-container>\r\n                    <!-- combo-lookup -->\r\n                    <!-- combo-tree -->\r\n                    <ng-container *ngSwitchCase=\"'combo-tree'\"  [ngTemplateOutlet]=\"combotreeTempRef\" [ngTemplateOutletContext]=\"{$implicit: { field: col.field, column: col, rowData: d, options: (d |editoropts: col) }}\"></ng-container >\r\n                    <!-- lookup -->\r\n                    <!-- datetime -->\r\n                    <ng-container *ngSwitchCase=\"'datetime'\" [ngTemplateOutlet]=\"datepickerTempRef\" [ngTemplateOutletContext]=\"{$implicit: { field: col.field, column: col, rowData: d, options: (d |editoropts: col) }}\"></ng-container>\r\n                    <!-- color -->\r\n                    <ng-container *ngSwitchCase=\"'color'\"  [ngTemplateOutlet]=\"colorPickerTempRef\" [ngTemplateOutletContext]=\"{$implicit: { field: col.field, column: col, rowData: d, options: (d |editoropts: col) }}\"></ng-container >\r\n                </ng-container>\r\n                \r\n            </td>\r\n        </tr>\r\n    </tbody>\r\n    <tfoot style=\"background-color:#f7f8fb\">\r\n        <tr>\r\n            <td [attr.colspan]=\"columns.length + 1\">\r\n                <button class=\"k-button k-button-icontext k-flat \" (click)=\"appendNew($event)\"><span class=\"f-icon f-icon-add\"></span> \u65B0\u589E</button>\r\n                <button class=\"k-button k-button-icontext k-flat \" (click)=\"clear($event)\"><span class=\"f-icon f-icon-close\"></span> \u6E05\u7A7A</button>\r\n                <button class=\"k-button k-button-icontext k-flat \" (click)=\"moveRow($event, 'top')\"><span class=\"f-icon f-icon-arrow-end-up\"></span> \u7F6E\u9876</button>\r\n                <button class=\"k-button k-button-icontext k-flat \" (click)=\"moveRow($event, 'up')\"><span class=\"f-icon f-icon-arrow-60-up\"></span> \u4E0A\u79FB</button>\r\n                <button class=\"k-button k-button-icontext k-flat \" (click)=\"moveRow($event, 'down')\"><span class=\"f-icon f-icon-arrow-60-down\"></span> \u4E0B\u79FB</button>\r\n                <button class=\"k-button k-button-icontext k-flat \" (click)=\"moveRow($event, 'bottom')\"><span class=\"f-icon f-icon-arrow-end-down\"></span> \u7F6E\u5E95</button>\r\n            </td>\r\n        </tr>\r\n    </tfoot>\r\n</table>\r\n\r\n\r\n<!-- text -->\r\n<ng-template #textTempRef let-ctx>\r\n    <div class=\"f-datagrid-cell-formgroup farris-group-auto \">\r\n        <input class=\"form-control\" type=\"text\" [(ngModel)]=\"ctx.rowData[ctx.field]\" [attr.name]=\"ctx.field\">\r\n    </div>\r\n</ng-template>\r\n\r\n<!--combo-list-->\r\n<ng-template #combolistTempRef let-ctx>\r\n    <farris-combo-list [(ngModel)]=\"ctx.rowData[ctx.field]\" [attr.name]=\"ctx.field\"\r\n        [idField]=\"ctx?.options?.valueField || ctx?.options?.idField || 'id'\" \r\n        [textField]=\"ctx?.options?.textField || 'label'\" \r\n        [data]=\"ctx?.options?.data\">\r\n    </farris-combo-list>\r\n</ng-template>\r\n\r\n<!-- combo-tree -->\r\n<ng-template #combotreeTempRef let-ctx>\r\n    <farris-combo-lookup [(ngModel)]=\"ctx.rowData[ctx.field]\" [attr.name]=\"ctx.field\"\r\n        [idField]=\"ctx?.options?.idField ||'value'\"\r\n        [textField]=\"ctx?.options?.textField ||'label'\"\r\n        [displayType]=\"'LOOKUPTREELIST'\" [useValue]=\"true\"\r\n        [useTreeView]=\"true\"\r\n        [columns]=\"ctx?.options?.columns || []\"\r\n        [data]=\"ctx?.options.data\"\r\n        [remoteSearch]=\"false\"\r\n        [autoWidth]=\"false\"\r\n        [panelWidth]=\"ctx?.options?.panelWidth || 200\"\r\n        (valueChange)=\"onComboLookupValueChange($event, ctx)\">\r\n    </farris-combo-lookup>\r\n</ng-template>\r\n\r\n\r\n<!--input-group-->\r\n<ng-template #inputgroupTempRef let-ctx>\r\n    <input-group [(ngModel)]=\"ctx.rowData[ctx.field]\" [attr.name]=\"ctx.field\" \r\n    [groupText]=\"ctx?.options.groupIcon\"\r\n    (clickHandle)=\"ctx.options?.clickHandle({ ctx: ctx, column: ctx.col, data: ctx.rowData })\"></input-group>\r\n</ng-template>\r\n<!-- Color -->\r\n<ng-template #colorPickerTempRef let-ctx>\r\n    <input type=\"color\" [(ngModel)]=\"ctx.rowData[ctx.field]\" [attr.name]=\"ctx.field\" >\r\n</ng-template>\r\n\r\n<!-- Number -->\r\n<ng-template #numberspinnerTempRef let-ctx>\r\n    <farris-number-spinner [(ngModel)]=\"ctx.rowData[ctx.field]\" [min]=\"ctx?.options?.min\"\r\n      [max]=\"ctx?.options?.max\" [precision]=\"ctx?.options?.precision\" [step]=\"ctx?.options?.step\"\r\n      [showZero]=\"false\" [canNull]=\"true\"\r\n      [useThousands]=\"true\" [prefix]=\"ctx?.options?.prefix || ''\"\r\n      [suffix]=\"ctx?.options?.suffix||''\" [formatter]=\"ctx?.options?.formatter\"\r\n      [showButton]=\"ctx?.options?.showButton\" [bigNumber]=\"ctx?.options?.bigNumber\"\r\n      >\r\n    </farris-number-spinner>\r\n</ng-template>\r\n\r\n<!-- Datebox -->\r\n<ng-template #datepickerTempRef let-ctx>\r\n    <farris-datepicker [(ngModel)]=\"ctx.rowData[ctx.field]\" [dateRange]=\"ctx?.options?.dateRange\">\r\n    </farris-datepicker>\r\n</ng-template>"
            }] }
];
/** @nocollapse */
EditTableComponent.ctorParameters = () => [
    { type: Injector },
    { type: IdService },
    { type: ChangeDetectorRef },
    { type: MessagerService },
    { type: NotifyService }
];
EditTableComponent.propDecorators = {
    columns: [{ type: Input }],
    data: [{ type: Input }],
    selectId: [{ type: Input }],
    idField: [{ type: Input }],
    dataChange: [{ type: Output }]
};
if (false) {
    /** @type {?} */
    EditTableComponent.prototype.columns;
    /** @type {?} */
    EditTableComponent.prototype.data;
    /** @type {?} */
    EditTableComponent.prototype.selectId;
    /**
     * 行数据标识字段
     * @type {?}
     */
    EditTableComponent.prototype.idField;
    /** @type {?} */
    EditTableComponent.prototype.dataChange;
    /**
     * @type {?}
     * @private
     */
    EditTableComponent.prototype.selectedItem;
    /**
     * @type {?}
     * @private
     */
    EditTableComponent.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    EditTableComponent.prototype.idSer;
    /**
     * @type {?}
     * @private
     */
    EditTableComponent.prototype.cdr;
    /**
     * @type {?}
     * @private
     */
    EditTableComponent.prototype.msgSer;
    /**
     * @type {?}
     * @private
     */
    EditTableComponent.prototype.notifySer;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdC10YWJsZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWVkaXQtdGFibGUvIiwic291cmNlcyI6WyJsaWIvZWRpdC10YWJsZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQVUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzVHLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBU2xELE1BQU0sT0FBTyxrQkFBa0I7Ozs7Ozs7O0lBYzNCLFlBQW9CLFFBQWtCLEVBQVUsS0FBZ0IsRUFBVSxHQUFzQixFQUFVLE1BQXVCLEVBQVUsU0FBd0I7UUFBL0ksYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLFVBQUssR0FBTCxLQUFLLENBQVc7UUFBVSxRQUFHLEdBQUgsR0FBRyxDQUFtQjtRQUFVLFdBQU0sR0FBTixNQUFNLENBQWlCO1FBQVUsY0FBUyxHQUFULFNBQVMsQ0FBZTtRQVgxSixTQUFJLEdBQUcsRUFBRSxDQUFDO1FBRVYsYUFBUSxHQUFHLEVBQUUsQ0FBQzs7OztRQUdkLFlBQU8sR0FBRyxLQUFLLENBQUM7UUFFZixlQUFVLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUVsQyxpQkFBWSxHQUFpQyxJQUFJLENBQUM7SUFFNEcsQ0FBQzs7OztJQUV2SyxRQUFRLEtBQUksQ0FBQzs7Ozs7SUFHTCxXQUFXO1FBQ2YsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3BDLENBQUM7Ozs7O0lBR08sYUFBYTtRQUNqQixPQUFPLElBQUksQ0FBQyxPQUFP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QUFDLFlBQVksQ0FBQyxLQUFLLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQztnQkFDcEMsTUFBTTtTQUNiO1FBRUQsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7Ozs7OztJQUVELHdCQUF3QixDQUFDLE1BQU0sRUFBRSxHQUFHO1FBQ2hDLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUU7a0JBQ3pDLEVBQUMsT0FBTyxFQUFFLEtBQUssRUFBQyxHQUFJLEdBQUc7WUFDN0IsR0FBRyxDQUFDLE9BQU8sQ0FBQyxXQUFXLG1CQUFLLE1BQU0sSUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLEtBQUssSUFBRSxDQUFDO1NBQzlEO0lBQ0wsQ0FBQzs7O1lBOUpKLFNBQVMsU0FBQztnQkFDUCxRQUFRLEVBQUUsbUJBQW1CO2dCQUM3QiwyME9BQTBDO2FBRTdDOzs7O1lBWG9ELFFBQVE7WUFDcEQsU0FBUztZQURULGlCQUFpQjtZQUVqQixlQUFlO1lBQ2YsYUFBYTs7O3NCQVdqQixLQUFLO21CQUNMLEtBQUs7dUJBRUwsS0FBSztzQkFHTCxLQUFLO3lCQUVMLE1BQU07Ozs7SUFSUCxxQ0FBeUM7O0lBQ3pDLGtDQUFtQjs7SUFFbkIsc0NBQXVCOzs7OztJQUd2QixxQ0FBeUI7O0lBRXpCLHdDQUEwQzs7Ozs7SUFFMUMsMENBQTBEOzs7OztJQUU5QyxzQ0FBMEI7Ozs7O0lBQUUsbUNBQXdCOzs7OztJQUFFLGlDQUE4Qjs7Ozs7SUFBRSxvQ0FBK0I7Ozs7O0lBQUUsdUNBQWdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2hhbmdlRGV0ZWN0b3JSZWYsIENvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBJbmplY3RvciwgSW5wdXQsIE9uSW5pdCwgT3V0cHV0IH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IElkU2VydmljZSB9IGZyb20gXCJAZmFycmlzL3VpLWNvbW1vblwiO1xuaW1wb3J0IHsgTWVzc2FnZXJTZXJ2aWNlIH0gZnJvbSBcIkBmYXJyaXMvdWktbWVzc2FnZXJcIjtcbmltcG9ydCB7IE5vdGlmeVNlcnZpY2UgfSBmcm9tIFwiQGZhcnJpcy91aS1ub3RpZnlcIjtcblxuaW1wb3J0IHsgRWRpdFRhYmxlQ29sdW1uIH0gZnJvbSBcIi4vZWRpdC10YWJsZS50eXBlc1wiO1xuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogXCJmYXJyaXMtZWRpdC10YWJsZVwiLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9lZGl0LXRhYmxlLmNvbXBvbmVudC5odG1sJyxcbiAgICBzdHlsZXM6IFtdLFxufSlcbmV4cG9ydCBjbGFzcyBFZGl0VGFibGVDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuXG4gICAgQElucHV0KCkgY29sdW1uczogQXJyYXk8RWRpdFRhYmxlQ29sdW1uPjtcbiAgICBASW5wdXQoKSBkYXRhID0gW107XG5cbiAgICBASW5wdXQoKSBzZWxlY3RJZCA9ICcnO1xuXG4gICAgLyoqIOihjOaVsOaNruagh+ivhuWtl+autSAqL1xuICAgIEBJbnB1dCgpIGlkRmllbGQgPSAnX2lkJztcblxuICAgIEBPdXRwdXQoKSBkYXRhQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgcHJpdmF0ZSBzZWxlY3RlZEl0ZW06IHsgaW5kZXg6IG51bWJlciwgZGF0YTogYW55IH0gPSBudWxsO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgaWRTZXI6IElkU2VydmljZSwgcHJpdmF0ZSBjZHI6IENoYW5nZURldGVjdG9yUmVmLCBwcml2YXRlIG1zZ1NlcjogTWVzc2FnZXJTZXJ2aWNlLCBwcml2YXRlIG5vdGlmeVNlcjogTm90aWZ5U2VydmljZSkge31cblxuICAgIG5nT25Jbml0KCkge31cblxuXG4gICAgcHJpdmF0ZSBkYXRhQ2hhbmdlZCgpIHtcbiAgICAgICAgdGhpcy5kYXRhQ2hhbmdlLmVtaXQodGhpcy5kYXRhKTtcbiAgICB9XG5cblxuICAgIHByaXZhdGUgY3JlYXRlTmV3RGF0YSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29sdW1ucy5yZWR1Y2UoKHAsIG4pID0+IHtcbiAgICAgICAgICAgIGlmIChuLmZpZWxkLmluZGV4T2YoJy4nKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgcCA9IE9iamVjdC5hc3NpZ24ocCwgbi5kZWZhdWx0VmFsdWUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBwW24uZmllbGRdID0gbi5kZWZhdWx0VmFsdWUgfHwgbnVsbDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHA7XG4gICAgICAgIH0sIHtfaWQ6IHRoaXMuaWRTZXIuZ3VpZCgpIH0pXG4gICAgfVxuXG4gICAgLyoqIOaPkuWFpeaWsOihjCAqL1xuICAgIGluc2VydFJvdyhpbmRleDogbnVtYmVyLCAkZXZlbnQ/OiBNb3VzZUV2ZW50KSB7XG4gICAgICAgIGlmICgkZXZlbnQpIHtcbiAgICAgICAgICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBuZXdJdGVtID0gdGhpcy5jcmVhdGVOZXdEYXRhKCk7XG4gICAgICAgIGNvbnN0IF9uZXdJdGVtID0gT2JqZWN0LmFzc2lnbih7fSwgbmV3SXRlbSk7XG4gICAgICAgIFxuICAgICAgICB0aGlzLmRhdGEuc3BsaWNlKGluZGV4ICsgMSwgMCwgX25ld0l0ZW0pO1xuICAgICAgICB0aGlzLmRhdGFDaGFuZ2VkKCk7XG4gICAgfVxuXG4gICAgLyoqIOaWsOWinuihjCAqL1xuICAgIGFwcGVuZE5ldygkZXZlbnQ6IE1vdXNlRXZlbnQpIHtcbiAgICAgICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBjb25zdCBuZXdJdGVtID0gdGhpcy5jcmVhdGVOZXdEYXRhKCk7XG4gICAgICAgIHRoaXMuZGF0YSA9IFsuLi50aGlzLmRhdGEsIG5ld0l0ZW1dO1xuICAgICAgICB0aGlzLmRhdGFDaGFuZ2VkKCk7XG4gICAgfVxuXG4gICAgLyoqIOmAieS4reihjCAqL1xuICAgIHNlbGVjdFJvdygkZXZlbnQ6IE1vdXNlRXZlbnQsIHJvd0RhdGEsIGluZGV4KSB7XG4gICAgICAgIGlmICgkZXZlbnQpIHtcbiAgICAgICAgICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNlbGVjdElkID0gcm93RGF0YVt0aGlzLmlkRmllbGRdO1xuICAgICAgICB0aGlzLnNlbGVjdGVkSXRlbSAgPSB7XG4gICAgICAgICAgICBkYXRhOiByb3dEYXRhLFxuICAgICAgICAgICAgaW5kZXhcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBkZWxldGVSb3coJGV2ZW50OiBNb3VzZUV2ZW50LCBpbmRleCkge1xuICAgICAgICBpZiAoJGV2ZW50KSB7XG4gICAgICAgICAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kYXRhLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgIHRoaXMuZGF0YUNoYW5nZWQoKTtcblxuICAgICAgICBpZiAodGhpcy5zZWxlY3RlZEl0ZW0pIHtcbiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gdGhpcy5zZWxlY3RlZEl0ZW0uaW5kZXgpIHtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIHRoaXMuZGF0YVtpbmRleF0gKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRJdGVtID0geyBpbmRleDogaW5kZXgsIGRhdGE6IHRoaXMuZGF0YVtpbmRleF0gfTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIHRoaXMuZGF0YVtpbmRleCAtIDFdICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEl0ZW0gPSB7IGluZGV4OiBpbmRleCAtIDEsIGRhdGE6IHRoaXMuZGF0YVtpbmRleCAtIDFdIH07XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkSXRlbSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmICghdGhpcy5kYXRhW3RoaXMuc2VsZWN0ZWRJdGVtLmluZGV4XSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zZWxlY3RlZEl0ZW0uaW5kZXggPiBpbmRleCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEl0ZW0uaW5kZXggPSB0aGlzLnNlbGVjdGVkSXRlbS5pbmRleCAtIDE7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkSXRlbS5pbmRleCA9IHRoaXMuc2VsZWN0ZWRJdGVtLmluZGV4ICsgMSA7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuY2RyLmRldGVjdENoYW5nZXMoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNsZWFyKCRldmVudCkge1xuICAgICAgICB0aGlzLm1zZ1Nlci5xdWVzdGlvbign56Gu6K6k6KaB5riF56m65b2T5YmN5omA5pyJ5p2h5Lu25ZCX77yfJywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5kYXRhID0gW107XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkSXRlbSA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdElkID0gJyc7XG4gICAgICAgICAgICB0aGlzLmRhdGFDaGFuZ2VkKCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIG1vdmVSb3coJGV2ZW50LCBhY3Rpb246ICd0b3AnfCdib3R0b20nfCd1cCd8J2Rvd24nKSB7XG4gICAgICAgIGlmICgkZXZlbnQpIHtcbiAgICAgICAgICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5zZWxlY3RlZEl0ZW0pIHtcbiAgICAgICAgICAgIHRoaXMubm90aWZ5U2VyLndhcm5pbmcoJ+ivt+mAieaLqeimgeenu+WKqOeahOihjCcpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLnNlbGVjdGVkSXRlbS5pbmRleDtcbiAgICAgICAgbGV0IHRlbXBBcnIgPSBbXTtcbiAgICAgICAgc3dpdGNoKGFjdGlvbikge1xuICAgICAgICAgICAgY2FzZSAndG9wJzogXG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhLnVuc2hpZnQodGhpcy5zZWxlY3RlZEl0ZW0uZGF0YSk7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhLnNwbGljZShpbmRleCArIDEsIDEpO1xuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRJdGVtLmluZGV4ID0gMDtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ2JvdHRvbSc6XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhLnB1c2godGhpcy5zZWxlY3RlZEl0ZW0uZGF0YSk7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEl0ZW0uaW5kZXggPSB0aGlzLmRhdGEubGVuZ3RoIC0gMTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ3VwJzpcbiAgICAgICAgICAgICAgICB0ZW1wQXJyID0gdGhpcy5kYXRhLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhLnNwbGljZShpbmRleCAtIDEsIDAsIC4uLnRlbXBBcnIpO1xuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRJdGVtLmluZGV4ID0gaW5kZXggLSAxO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnZG93bic6XG4gICAgICAgICAgICAgICAgdGVtcEFyciA9IHRoaXMuZGF0YS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0YS5zcGxpY2UoaW5kZXggKyAxLCAwLCAuLi50ZW1wQXJyKTtcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkSXRlbS5pbmRleCA9IGluZGV4ICsgMTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZGF0YUNoYW5nZWQoKTsgIFxuICAgIH1cblxuICAgIG9uQ29tYm9Mb29rdXBWYWx1ZUNoYW5nZSgkZXZlbnQsIGN0eCkge1xuICAgICAgICBpZiAoY3R4ICYmIGN0eC5vcHRpb25zICYmIGN0eC5vcHRpb25zLnZhbHVlQ2hhbmdlKSB7XG4gICAgICAgICAgICBjb25zdCB7cm93RGF0YSwgZmllbGR9ICA9IGN0eDtcbiAgICAgICAgICAgIGN0eC5vcHRpb25zLnZhbHVlQ2hhbmdlKHsuLi4kZXZlbnQsIGRhdGE6IHJvd0RhdGEsIGZpZWxkfSk7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=