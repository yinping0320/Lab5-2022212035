/**
 * @fileoverview added by tsickle
 * Generated from: lib/views/bo-creator/modal/app-modal/app-creator-modal.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, Output, EventEmitter } from '@angular/core';
import { NotifyService } from '@farris/ui-notify';
import { BusinessObjectEntity, BusinessObjectDtService } from '@gsp-lcm/bo-dt-service';
import { ValidatorResult } from '../../common/validation-result';
import { BoCreatorUtils } from '../../utils/bo-create-utils';
export class AppCreatorModalComponent {
    /**
     * @param {?} boCreatorUtils
     * @param {?} boDtService
     * @param {?} notifyService
     */
    constructor(boCreatorUtils, boDtService, notifyService) {
        this.boCreatorUtils = boCreatorUtils;
        this.boDtService = boDtService;
        this.notifyService = notifyService;
        this.appConfirmEmitter = new EventEmitter();
        this.currentBo = new BusinessObjectEntity();
        this.apps = [];
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.initData();
    }
    /**
     * @private
     * @return {?}
     */
    initData() {
        this.boDtService.getBusinessObjects().subscribe((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            if (!data) {
                return;
            }
            //二级节点是APP
            this.apps = data.filter((/**
             * @param {?} x
             * @return {?}
             */
            x => x.layer === 2));
            //一级节点是产品，目前默认一级节点（根节点）只有一个
            this.parent = data.find((/**
             * @param {?} x
             * @return {?}
             */
            x => x.layer === 1));
        }));
    }
    /**
     * @return {?}
     */
    create() {
        /** @type {?} */
        let bo = this.getCurrentBo();
        if (!bo) {
            return;
        }
        this.boDtService.save(bo).subscribe((/**
         * @return {?}
         */
        () => {
            this.appConfirmEmitter.emit(bo);
        }), (/**
         * @param {?} error
         * @return {?}
         */
        error => {
            this.notifyService.error('创建失败');
            throw error;
        }));
    }
    /**
     * @return {?}
     */
    getCurrentBo() {
        /** @type {?} */
        let result = this.appInfoValidator();
        if (result.illegal) {
            this.notifyService.warning(result.message);
            return null;
        }
        this.currentBo.id = this.boCreatorUtils.newGuid();
        this.currentBo.layer = 2;
        this.currentBo.parentID = this.parent.id;
        this.currentBo.sysInit = '0';
        this.currentBo.isSysInit = false;
        this.currentBo.isDetail = '0';
        /** @type {?} */
        let max = this.boCreatorUtils.getMaxOrder(this.apps, this.currentBo.parentID);
        this.currentBo.sortOrder = max + 1;
        return Object.assign(new BusinessObjectEntity(), this.currentBo);
    }
    /**
     * @return {?}
     */
    appInfoValidator() {
        //新增信息空校验
        /** @type {?} */
        let result = this.emptyValidator();
        if (result.illegal) {
            return result;
        }
        //编号，名称命名规范性校验
        result = this.namingConventionValidator();
        if (result.illegal) {
            return result;
        }
        //APP编号重复校验
        return this.repeatValidator();
    }
    /**
     * @return {?}
     */
    emptyValidator() {
        /** @type {?} */
        let result = new ValidatorResult();
        if (!this.currentBo.code) {
            result.illegal = true;
            result.message = `关键应用的编号不能为空`;
            return result;
        }
        if (!this.currentBo.name) {
            result.illegal = true;
            result.message = `关键应用的名称不能为空`;
            return result;
        }
        return result;
    }
    /**
     * @return {?}
     */
    namingConventionValidator() {
        /** @type {?} */
        let result = new ValidatorResult();
        /** @type {?} */
        const codeRegx = new RegExp('^[a-zA-Z\x7f-\xff][a-zA-Z0-9\x7f-\xff]*$');
        if (!codeRegx.test(this.currentBo.code)) {
            result.illegal = true;
            result.message = '关键应用的编号只能包含字母,数字,并且不可以用数字开头!';
            return result;
        }
        /** @type {?} */
        const nameRegx = new RegExp('[`~!@#$^&*()=|{}\':;\',\\[\\].<>/?~！@#￥……&*（）——|{}【】‘；：”“\'。，、？]');
        if (nameRegx.test(this.currentBo.name)) {
            result.illegal = true;
            result.message = '关键应用的名称包含非法字符，请重新输入!';
            return result;
        }
        return result;
    }
    /**
     * @return {?}
     */
    repeatValidator() {
        /** @type {?} */
        let result = new ValidatorResult();
        /** @type {?} */
        let filterApp = this.apps.find((/**
         * @param {?} x
         * @return {?}
         */
        x => x.code.toLowerCase() === this.currentBo.code.toLowerCase()));
        if (filterApp) {
            result.illegal = true;
            result.message = `关键应用的编号${this.currentBo.code}已存在`;
            return result;
        }
        return result;
    }
}
AppCreatorModalComponent.decorators = [
    { type: Component, args: [{
                selector: 'app-app-creator-modal',
                template: "\r\n<div class=\"cloumn\" style=\"margin-top: 28px;\">\r\n\r\n  <div class=\"app-Info row\">\r\n    <label class=\"col-form-label ps-col-form-label\">\r\n      <span class=\"farris-label-info text-danger\">*</span>\r\n      <span class=\"farris-label-text\">\u5E94\u7528\u7F16\u53F7</span>\r\n    </label>\r\n    <div class=\"col-9\">\r\n      <input-group [(ngModel)]=\"currentBo.code\"  autocomplete=\"off\" name=\"code\" ></input-group>\r\n    </div>\r\n  </div>\r\n\r\n  <div class=\"app-Info row\">\r\n    <label class=\"col-form-label ps-col-form-label\">\r\n      <span class=\"farris-label-info text-danger\">*</span>\r\n      <span class=\"farris-label-text\">\u5E94\u7528\u540D\u79F0</span>\r\n    </label>\r\n    <div class=\"col-9\">\r\n      <input-group [(ngModel)]=\"currentBo.name\"  autocomplete=\"off\" name=\"name\" ></input-group>\r\n    </div>\r\n  </div>\r\n\r\n  <div class=\"app-Info row\">\r\n    <label class=\"col-form-label ps-col-form-label\">\r\n      <span class=\"farris-label-text\">\u5E94\u7528\u63CF\u8FF0</span>\r\n    </label>\r\n    <div class=\"col-9\">\r\n      <input-group [(ngModel)]=\"currentBo.description\"  autocomplete=\"off\" name=\"description\"></input-group>\r\n    </div>\r\n  </div>\r\n\r\n</div>",
                styles: [".app-Info{margin:0 0 16px 20px}div .ps-col-form-label{width:94px;text-align:right}"]
            }] }
];
/** @nocollapse */
AppCreatorModalComponent.ctorParameters = () => [
    { type: BoCreatorUtils },
    { type: BusinessObjectDtService },
    { type: NotifyService }
];
AppCreatorModalComponent.propDecorators = {
    appConfirmEmitter: [{ type: Output }]
};
if (false) {
    /** @type {?} */
    AppCreatorModalComponent.prototype.appConfirmEmitter;
    /** @type {?} */
    AppCreatorModalComponent.prototype.currentBo;
    /** @type {?} */
    AppCreatorModalComponent.prototype.parent;
    /** @type {?} */
    AppCreatorModalComponent.prototype.apps;
    /**
     * @type {?}
     * @private
     */
    AppCreatorModalComponent.prototype.boCreatorUtils;
    /**
     * @type {?}
     * @private
     */
    AppCreatorModalComponent.prototype.boDtService;
    /**
     * @type {?}
     * @private
     */
    AppCreatorModalComponent.prototype.notifyService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLWNyZWF0b3ItbW9kYWwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGdzcC1sY20vYm8tY3JlYXRvci8iLCJzb3VyY2VzIjpbImxpYi92aWV3cy9iby1jcmVhdG9yL21vZGFsL2FwcC1tb2RhbC9hcHAtY3JlYXRvci1tb2RhbC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLE1BQU0sRUFBRSxZQUFZLEVBQWlDLE1BQU0sZUFBZSxDQUFDO0FBQ3ZHLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN2RixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDakUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBTzdELE1BQU0sT0FBTyx3QkFBd0I7Ozs7OztJQVVqQyxZQUNZLGNBQTZCLEVBQzdCLFdBQW9DLEVBQ3BDLGFBQTRCO1FBRjVCLG1CQUFjLEdBQWQsY0FBYyxDQUFlO1FBQzdCLGdCQUFXLEdBQVgsV0FBVyxDQUF5QjtRQUNwQyxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQVg5QixzQkFBaUIsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUV6RSxjQUFTLEdBQXlCLElBQUksb0JBQW9CLEVBQUUsQ0FBQztRQUk3RCxTQUFJLEdBQVUsRUFBRSxDQUFDO0lBSzJCLENBQUM7Ozs7SUFFN0MsUUFBUTtRQUNKLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNwQixDQUFDOzs7OztJQUVPLFFBQVE7UUFDWixJQUFJLENBQUMsV0FBVyxDQUFDLGtCQUFrQixFQUFFLENBQUMsU0FBUzs7OztRQUMzQyxDQUFDLElBQVcsRUFBRSxFQUFFO1lBQ1osSUFBSSxDQUFDLElBQUksRUFBRTtnQkFDUCxPQUFPO2FB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QUFFO1lBQ1gsTUFBTSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7WUFDdEIsTUFBTSxDQUFDLE9BQU8sR0FBRyxVQUFVLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxLQUFLLENBQUM7WUFDcEQsT0FBTyxNQUFNLENBQUM7U0FDakI7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDOzs7WUFuSUosU0FBUyxTQUFDO2dCQUNQLFFBQVEsRUFBRSx1QkFBdUI7Z0JBQ2pDLDh1Q0FBaUQ7O2FBRXBEOzs7O1lBTlEsY0FBYztZQUZRLHVCQUF1QjtZQUQ3QyxhQUFhOzs7Z0NBWWpCLE1BQU07Ozs7SUFBUCxxREFBeUU7O0lBRXpFLDZDQUE2RDs7SUFFN0QsMENBQVk7O0lBRVosd0NBQWlCOzs7OztJQUdiLGtEQUFxQzs7Ozs7SUFDckMsK0NBQTRDOzs7OztJQUM1QyxpREFBb0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIFRlbXBsYXRlUmVmLCBWaWV3Q2hpbGQsIElucHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOb3RpZnlTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1ub3RpZnknO1xuaW1wb3J0IHsgQnVzaW5lc3NPYmplY3RFbnRpdHksIEJ1c2luZXNzT2JqZWN0RHRTZXJ2aWNlIH0gZnJvbSAnQGdzcC1sY20vYm8tZHQtc2VydmljZSc7XG5pbXBvcnQgeyBWYWxpZGF0b3JSZXN1bHQgfSBmcm9tICcuLi8uLi9jb21tb24vdmFsaWRhdGlvbi1yZXN1bHQnO1xuaW1wb3J0IHsgQm9DcmVhdG9yVXRpbHMgfSBmcm9tICcuLi8uLi91dGlscy9iby1jcmVhdGUtdXRpbHMnO1xuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ2FwcC1hcHAtY3JlYXRvci1tb2RhbCcsXG4gICAgdGVtcGxhdGVVcmw6ICcuL2FwcC1jcmVhdG9yLW1vZGFsLmNvbXBvbmVudC5odG1sJyxcbiAgICBzdHlsZVVybHM6IFsnLi9hcHAtY3JlYXRvci1tb2RhbC5jb21wb25lbnQuY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgQXBwQ3JlYXRvck1vZGFsQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcblxuICAgIEBPdXRwdXQoKSBhcHBDb25maXJtRW1pdHRlcjogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICAgIGN1cnJlbnRCbzogQnVzaW5lc3NPYmplY3RFbnRpdHkgPSBuZXcgQnVzaW5lc3NPYmplY3RFbnRpdHkoKTtcblxuICAgIHBhcmVudDogYW55O1xuXG4gICAgYXBwczogYW55W10gPSBbXTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGJvQ3JlYXRvclV0aWxzOkJvQ3JlYXRvclV0aWxzLFxuICAgICAgICBwcml2YXRlIGJvRHRTZXJ2aWNlOiBCdXNpbmVzc09iamVjdER0U2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBub3RpZnlTZXJ2aWNlOiBOb3RpZnlTZXJ2aWNlKSB7IH1cblxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICB0aGlzLmluaXREYXRhKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0RGF0YSgpIHtcbiAgICAgICAgdGhpcy5ib0R0U2VydmljZS5nZXRCdXNpbmVzc09iamVjdHMoKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAoZGF0YTogYW55W10pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIWRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvL+S6jOe6p+iKgueCueaYr0FQUFxuICAgICAgICAgICAgICAgIHRoaXMuYXBwcyA9IGRhdGEuZmlsdGVyKHggPT4geC5sYXllciA9PT0gMik7XG4gICAgICAgICAgICAgICAgLy/kuIDnuqfoioLngrnmmK/kuqflk4HvvIznm67liY3pu5jorqTkuIDnuqfoioLngrnvvIjmoLnoioLngrnvvInlj6rmnInkuIDkuKpcbiAgICAgICAgICAgICAgICB0aGlzLnBhcmVudCA9IGRhdGEuZmluZCh4ID0+IHgubGF5ZXIgPT09IDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cblxuICAgIGNyZWF0ZSgpe1xuICAgICAgICBsZXQgYm89dGhpcy5nZXRDdXJyZW50Qm8oKTtcbiAgICAgICAgaWYoIWJvKXtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmJvRHRTZXJ2aWNlLnNhdmUoYm8pLnN1YnNjcmliZShcbiAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcENvbmZpcm1FbWl0dGVyLmVtaXQoYm8pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2UuZXJyb3IoJ+WIm+W7uuWksei0pScpO1xuICAgICAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cblxuICAgIGdldEN1cnJlbnRCbygpe1xuICAgICAgICBsZXQgcmVzdWx0PXRoaXMuYXBwSW5mb1ZhbGlkYXRvcigpO1xuICAgICAgICBpZihyZXN1bHQuaWxsZWdhbCl7IFxuICAgICAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcocmVzdWx0Lm1lc3NhZ2UpO1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jdXJyZW50Qm8uaWQgPSB0aGlzLmJvQ3JlYXRvclV0aWxzLm5ld0d1aWQoKTtcbiAgICAgICAgdGhpcy5jdXJyZW50Qm8ubGF5ZXIgPSAyO1xuICAgICAgICB0aGlzLmN1cnJlbnRCby5wYXJlbnRJRCA9IHRoaXMucGFyZW50LmlkO1xuICAgICAgICB0aGlzLmN1cnJlbnRCby5zeXNJbml0ID0gJzAnO1xuICAgICAgICB0aGlzLmN1cnJlbnRCby5pc1N5c0luaXQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5jdXJyZW50Qm8uaXNEZXRhaWwgPSAnMCc7XG4gICAgICAgIGxldCBtYXggPSB0aGlzLmJvQ3JlYXRvclV0aWxzLmdldE1heE9yZGVyKHRoaXMuYXBwcywgdGhpcy5jdXJyZW50Qm8ucGFyZW50SUQpO1xuICAgICAgICB0aGlzLmN1cnJlbnRCby5zb3J0T3JkZXIgPSBtYXggKyAxO1xuICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXcgQnVzaW5lc3NPYmplY3RFbnRpdHkoKSx0aGlzLmN1cnJlbnRCbyk7XG4gICAgfVxuXG4gICAgYXBwSW5mb1ZhbGlkYXRvcigpOiBWYWxpZGF0b3JSZXN1bHQge1xuXG4gICAgICAgIC8v5paw5aKe5L+h5oGv56m65qCh6aqMXG4gICAgICAgIGxldCByZXN1bHQgPSB0aGlzLmVtcHR5VmFsaWRhdG9yKCk7XG4gICAgICAgIGlmIChyZXN1bHQuaWxsZWdhbCkge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8v57yW5Y+377yM5ZCN56ew5ZG95ZCN6KeE6IyD5oCn5qCh6aqMXG4gICAgICAgIHJlc3VsdCA9IHRoaXMubmFtaW5nQ29udmVudGlvblZhbGlkYXRvcigpO1xuICAgICAgICBpZiAocmVzdWx0LmlsbGVnYWwpIHtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH1cblxuICAgICAgICAvL0FQUOe8luWPt+mHjeWkjeagoemqjFxuICAgICAgICByZXR1cm4gdGhpcy5yZXBlYXRWYWxpZGF0b3IoKTtcblxuICAgIH1cblxuICAgIGVtcHR5VmFsaWRhdG9yKCk6IFZhbGlkYXRvclJlc3VsdCB7XG4gICAgICAgIGxldCByZXN1bHQgPSBuZXcgVmFsaWRhdG9yUmVzdWx0KCk7XG4gICAgICAgIGlmICghdGhpcy5jdXJyZW50Qm8uY29kZSkge1xuICAgICAgICAgICAgcmVzdWx0LmlsbGVnYWwgPSB0cnVlO1xuICAgICAgICAgICAgcmVzdWx0Lm1lc3NhZ2UgPSBg5YWz6ZSu5bqU55So55qE57yW5Y+35LiN6IO95Li656m6YDtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLmN1cnJlbnRCby5uYW1lKSB7XG4gICAgICAgICAgICByZXN1bHQuaWxsZWdhbCA9IHRydWU7XG4gICAgICAgICAgICByZXN1bHQubWVzc2FnZSA9IGDlhbPplK7lupTnlKjnmoTlkI3np7DkuI3og73kuLrnqbpgO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIG5hbWluZ0NvbnZlbnRpb25WYWxpZGF0b3IoKTogVmFsaWRhdG9yUmVzdWx0IHtcbiAgICAgICAgbGV0IHJlc3VsdCA9IG5ldyBWYWxpZGF0b3JSZXN1bHQoKTtcbiAgICAgICAgY29uc3QgY29kZVJlZ3ggPSBuZXcgUmVnRXhwKCdeW2EtekEtWlxceDdmLVxceGZmXVthLXpBLVowLTlcXHg3Zi1cXHhmZl0qJCcpO1xuICAgICAgICBpZiAoIWNvZGVSZWd4LnRlc3QodGhpcy5jdXJyZW50Qm8uY29kZSkpIHtcbiAgICAgICAgICAgIHJlc3VsdC5pbGxlZ2FsID0gdHJ1ZTtcbiAgICAgICAgICAgIHJlc3VsdC5tZXNzYWdlID0gJ+WFs+mUruW6lOeUqOeahOe8luWPt+WPquiDveWMheWQq+Wtl+avjSzmlbDlrZcs5bm25LiU5LiN5Y+v5Lul55So5pWw5a2X5byA5aS0ISc7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG5hbWVSZWd4ID0gbmV3IFJlZ0V4cCgnW2B+IUAjJF4mKigpPXx7fVxcJzo7XFwnLFxcXFxbXFxcXF0uPD4vP37vvIFAI++/peKApuKApiYq77yI77yJ4oCU4oCUfHt944CQ44CR4oCY77yb77ya4oCd4oCcXFwn44CC77yM44CB77yfXScpO1xuICAgICAgICBpZiAobmFtZVJlZ3gudGVzdCh0aGlzLmN1cnJlbnRCby5uYW1lKSkge1xuICAgICAgICAgICAgcmVzdWx0LmlsbGVnYWwgPSB0cnVlO1xuICAgICAgICAgICAgcmVzdWx0Lm1lc3NhZ2UgPSAn5YWz6ZSu5bqU55So55qE5ZCN56ew5YyF5ZCr6Z2e5rOV5a2X56ym77yM6K+36YeN5paw6L6T5YWlISc7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcmVwZWF0VmFsaWRhdG9yKCk6IFZhbGlkYXRvclJlc3VsdCB7XG4gICAgICAgIGxldCByZXN1bHQgPSBuZXcgVmFsaWRhdG9yUmVzdWx0KCk7XG4gICAgICAgIGxldCBmaWx0ZXJBcHAgPSB0aGlzLmFwcHMuZmluZCh4ID0+IHguY29kZS50b0xvd2VyQ2FzZSgpID09PSB0aGlzLmN1cnJlbnRCby5jb2RlLnRvTG93ZXJDYXNlKCkpO1xuICAgICAgICBpZiAoZmlsdGVyQXBwKSB7XG4gICAgICAgICAgICByZXN1bHQuaWxsZWdhbCA9IHRydWU7XG4gICAgICAgICAgICByZXN1bHQubWVzc2FnZSA9IGDlhbPplK7lupTnlKjnmoTnvJblj7cke3RoaXMuY3VycmVudEJvLmNvZGV95bey5a2Y5ZyoYDtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbn1cbiJdfQ==