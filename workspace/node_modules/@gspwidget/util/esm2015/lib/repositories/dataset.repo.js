/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { map } from 'rxjs/operators';
import { addBaseUrl, DATA_PREFIX } from '../const';
import { Agg, Dataset, DpValue, RuntimeAggOption } from '../types/data.type';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
/** @type {?} */
export const datasetUrls = {
    GET_BY_ID: `${DATA_PREFIX}/DataSetService/find/`,
    CREATE: `${DATA_PREFIX}/DataSetService/create`,
    IMPORT_QO: `${DATA_PREFIX}/DataSetService/importQO`,
    DELETE: `${DATA_PREFIX}/DataSetService/delete`,
    GET_ALL: `${DATA_PREFIX}/DataSetService/findAll`,
    // 500
    GET_RAW_DIMS_BY_DATASET: `${DATA_PREFIX}/DataResultSetService/tryGetDimensions`,
    GET_RAW_DATA_BY_DATASET: `${DATA_PREFIX}/DataResultSetService/getResultSet`,
    UPDATE: `${DATA_PREFIX}/DataSetService/update`,
};
/** @type {?} */
export const aggUrls = {
    SAVE: `${DATA_PREFIX}/DataSetService/saveAggConfig`,
    GET_BY_RESOURCE: `${DATA_PREFIX}/DataSetService/findAggConfigByResource`,
};
/** @type {?} */
export const dataResultSetUrls = {
    GET_BY_AGG_ID: `${DATA_PREFIX}/DataResultSetService/getAggResultSet/{aggId}`,
    // ?
    GET_BY_AGG: `${DATA_PREFIX}/DataResultSetService/getAggResultSetForTest`,
    GET_BY_DATASET: `${DATA_PREFIX}/DataResultSetService/getResultSet`,
    // 原始数据，用不到
    GET_BY_RESOURCE: `${DATA_PREFIX}/DataResultSetService/getResultSetByResource`,
};
addBaseUrl(datasetUrls);
addBaseUrl(aggUrls);
addBaseUrl(dataResultSetUrls);
export class DatasetRepo {
    /**
     * @param {?} http
     */
    constructor(http) {
        this.http = http;
    }
    /**
     * @param {?} datasetDto
     * @return {?}
     */
    getRawDimsByDataset(datasetDto) {
        return this.http
            .post(datasetUrls.GET_RAW_DIMS_BY_DATASET, datasetDto);
    }
    /**
     * @param {?} datasetDto
     * @return {?}
     */
    getRawColsNDataByDataset(datasetDto) {
        return this.http
            .post(datasetUrls.GET_RAW_DATA_BY_DATASET, datasetDto);
    }
    /**
     * @return {?}
     */
    getDatasets() {
        return this.http
            .get(datasetUrls.GET_ALL)
            .pipe(map((/**
         * @param {?} datasetDtos
         * @return {?}
         */
        datasetDtos => datasetDtos.map(Dataset.fromDto))));
    }
    /**
     * @param {?} id
     * @return {?}
     */
    getDatasetById(id) {
        return this.http
            .get(datasetUrls.GET_BY_ID + id)
            .pipe(map(Dataset.fromDto));
    }
    /**
     * @param {?} datasetDto
     * @return {?}
     */
    saveDataset(datasetDto) {
        return this.http.post(datasetDto.id ? datasetUrls.UPDATE : datasetUrls.CREATE, 
        // Dataset.toDto(dataset)
        datasetDto).pipe(map(Dataset.fromDto));
        // TODO:
        // , this.success()
    }
    /**
     * @param {?} ids
     * @return {?}
     */
    importQO(ids) {
        return this.http.post(datasetUrls.IMPORT_QO, ids);
    }
    /**
     * @param {?} datasetId
     * @return {?}
     */
    deleteDataset(datasetId) {
        return this.http
            .post(datasetUrls.DELETE, null, { params: { id: datasetId } });
        // TODO:
        // .pipe(this.success())
    }
    /**
     * agg
     * @param {?} portletId
     * @return {?}
     */
    getAggByPortletId(portletId) {
        return this.http.get(aggUrls.GET_BY_RESOURCE, {
            params: {
                resource: 'portlet',
                resourceId: portletId
            }
        }).pipe(map(Agg.fromDto));
    }
    /**
     * @param {?} agg
     * @return {?}
     */
    saveAgg(agg) {
        return this.http
            .post(aggUrls.SAVE, Agg.toDto(agg));
    }
    /**
     * result
     * @param {?} agg
     * @param {?=} dpValues
     * @param {?=} runtimeAgg
     * @return {?}
     */
    getAggResultByAgg(agg, dpValues = [], runtimeAgg) {
        /** @type {?} */
        const body = {
            aggDataDto: Agg.toDto(agg),
            aggregation: RuntimeAggOption.toDto(runtimeAgg)
        }
        // dataParam 为 [] 服务端会报错，若没有直接不传此参数。
        ;
        // dataParam 为 [] 服务端会报错，若没有直接不传此参数。
        if (dpValues && dpValues.length > 0)
            body.dataParam = dpValues.map(DpValue.toDto);
        return this.http.post(dataResultSetUrls.GET_BY_AGG, body);
    }
    /**
     * @param {?} portletId
     * @param {?=} dpValues
     * @param {?=} filter
     * @param {?=} runtimeAgg
     * @return {?}
     */
    getResultByPortletId(portletId, dpValues = [], filter = '""', runtimeAgg) {
        /** @type {?} */
        const body = {
            filter,
            aggregation: RuntimeAggOption.toDto(runtimeAgg)
        }
        // dataParam 为 [] 服务端会报错，若没有直接不传此参数。
        ;
        // dataParam 为 [] 服务端会报错，若没有直接不传此参数。
        if (dpValues && dpValues.length > 0)
            body.dataParam = dpValues.map(DpValue.toDto);
        return this.http.post(dataResultSetUrls.GET_BY_RESOURCE, body, {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            params: {
                resourceType: 'portlet',
                resourceId: portletId
            }
        });
    }
}
DatasetRepo.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
DatasetRepo.ctorParameters = () => [
    { type: HttpClient }
];
/** @nocollapse */ DatasetRepo.ngInjectableDef = i0.defineInjectable({ factory: function DatasetRepo_Factory() { return new DatasetRepo(i0.inject(i1.HttpClient)); }, token: DatasetRepo, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    DatasetRepo.prototype.http;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YXNldC5yZXBvLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGdzcHdpZGdldC91dGlsLyIsInNvdXJjZXMiOlsibGliL3JlcG9zaXRvcmllcy9kYXRhc2V0LnJlcG8udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbkQsT0FBTyxFQUFFLEdBQUcsRUFBYSxPQUFPLEVBQXlCLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG9CQUFvQixDQUFDOzs7O0FBRS9HLE1BQU0sT0FBTyxXQUFXLEdBQUc7SUFDekIsU0FBUyxFQUFFLEdBQUcsV0FBVyx1QkFBdUI7SUFDaEQsTUFBTSxFQUFFLEdBQUcsV0FBVyx3QkFBd0I7SUFDOUMsU0FBUyxFQUFFLEdBQUcsV0FBVywwQkFBMEI7SUFDbkQsTUFBTSxFQUFFLEdBQUcsV0FBVyx3QkFBd0I7SUFDOUMsT0FBTyxFQUFFLEdBQUcsV0FBVyx5QkFBeUI7O0lBQ2hELHVCQUF1QixFQUFFLEdBQUcsV0FBVyx3Q0FBd0M7SUFDL0UsdUJBQXVCLEVBQUUsR0FBRyxXQUFXLG9DQUFvQztJQUMzRSxNQUFNLEVBQUUsR0FBRyxXQUFXLHdCQUF3QjtDQUMvQzs7QUFDRCxNQUFNLE9BQU8sT0FBTyxHQUFHO0lBQ3JCLElBQUksRUFBRSxHQUFHLFdBQVcsK0JBQStCO0lBQ25ELGVBQWUsRUFBRSxHQUFHLFdBQVcseUNBQXlDO0NBQ3pFOztBQUNELE1BQU0sT0FBTyxpQkFBaUIsR0FBRztJQUMvQixhQUFhLEVBQUUsR0FBRyxXQUFXLCtDQUErQzs7SUFDNUUsVUFBVSxFQUFFLEdBQUcsV0FB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LFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7OztZQWhDUSxVQUFVOzs7Ozs7OztJQW9DZiwyQkFBd0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IGFkZEJhc2VVcmwsIERBVEFfUFJFRklYIH0gZnJvbSAnLi4vY29uc3QnO1xuaW1wb3J0IHsgQWdnLCBBZ2dSZXN1bHQsIERhdGFzZXQsIERhdGFzZXREdG8sIERpbWVuc2lvbiwgRHBWYWx1ZSwgUnVudGltZUFnZ09wdGlvbiB9IGZyb20gJy4uL3R5cGVzL2RhdGEudHlwZSc7XG5cbmV4cG9ydCBjb25zdCBkYXRhc2V0VXJscyA9IHtcbiAgR0VUX0JZX0lEOiBgJHtEQVRBX1BSRUZJWH0vRGF0YVNldFNlcnZpY2UvZmluZC9gLFxuICBDUkVBVEU6IGAke0RBVEFfUFJFRklYfS9EYXRhU2V0U2VydmljZS9jcmVhdGVgLFxuICBJTVBPUlRfUU86IGAke0RBVEFfUFJFRklYfS9EYXRhU2V0U2VydmljZS9pbXBvcnRRT2AsXG4gIERFTEVURTogYCR7REFUQV9QUkVGSVh9L0RhdGFTZXRTZXJ2aWNlL2RlbGV0ZWAsXG4gIEdFVF9BTEw6IGAke0RBVEFfUFJFRklYfS9EYXRhU2V0U2VydmljZS9maW5kQWxsYCwgLy8gNTAwXG4gIEdFVF9SQVdfRElNU19CWV9EQVRBU0VUOiBgJHtEQVRBX1BSRUZJWH0vRGF0YVJlc3VsdFNldFNlcnZpY2UvdHJ5R2V0RGltZW5zaW9uc2AsXG4gIEdFVF9SQVdfREFUQV9CWV9EQVRBU0VUOiBgJHtEQVRBX1BSRUZJWH0vRGF0YVJlc3VsdFNldFNlcnZpY2UvZ2V0UmVzdWx0U2V0YCxcbiAgVVBEQVRFOiBgJHtEQVRBX1BSRUZJWH0vRGF0YVNldFNlcnZpY2UvdXBkYXRlYCxcbn1cbmV4cG9ydCBjb25zdCBhZ2dVcmxzID0ge1xuICBTQVZFOiBgJHtEQVRBX1BSRUZJWH0vRGF0YVNldFNlcnZpY2Uvc2F2ZUFnZ0NvbmZpZ2AsXG4gIEdFVF9CWV9SRVNPVVJDRTogYCR7REFUQV9QUkVGSVh9L0RhdGFTZXRTZXJ2aWNlL2ZpbmRBZ2dDb25maWdCeVJlc291cmNlYCxcbn1cbmV4cG9ydCBjb25zdCBkYXRhUmVzdWx0U2V0VXJscyA9IHtcbiAgR0VUX0JZX0FHR19JRDogYCR7REFUQV9QUkVGSVh9L0RhdGFSZXN1bHRTZXRTZXJ2aWNlL2dldEFnZ1Jlc3VsdFNldC97YWdnSWR9YCwgLy8gP1xuICBHRVRfQllfQUdHOiBgJHtEQVRBX1BSRUZJWH0vRGF0YVJlc3VsdFNldFNlcnZpY2UvZ2V0QWdnUmVzdWx0U2V0Rm9yVGVzdGAsXG4gIEdFVF9CWV9EQVRBU0VUOiBgJHtEQVRBX1BSRUZJWH0vRGF0YVJlc3VsdFNldFNlcnZpY2UvZ2V0UmVzdWx0U2V0YCwgLy8g5Y6f5aeL5pWw5o2u77yM55So5LiN5YiwXG4gIEdFVF9CWV9SRVNPVVJDRTogYCR7REFUQV9QUkVGSVh9L0RhdGFSZXN1bHRTZXRTZXJ2aWNlL2dldFJlc3VsdFNldEJ5UmVzb3VyY2VgLCAvL1xufVxuYWRkQmFzZVVybChkYXRhc2V0VXJscylcbmFkZEJhc2VVcmwoYWdnVXJscylcbmFkZEJhc2VVcmwoZGF0YVJlc3VsdFNldFVybHMpXG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIERhdGFzZXRSZXBvIHtcblxuICBjb25zdHJ1Y3RvciAoXG4gICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxuICApIHsgfVxuXG4gIGdldFJhd0RpbXNCeURhdGFzZXQgKGRhdGFzZXREdG86IERhdGFzZXREdG8pIHtcbiAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAucG9zdDxEaW1lbnNpb25bXT4oZGF0YXNldFVybHMuR0VUX1JBV19ESU1TX0JZX0RBVEFTRVQsIGRhdGFzZXREdG8pXG4gIH1cbiAgZ2V0UmF3Q29sc05EYXRhQnlEYXRhc2V0IChkYXRhc2V0RHRvOiBEYXRhc2V0RHRvKSB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLnBvc3Q8e2NvbHVtbnM6IHN0cmluZ1tdLCBkYXRhOmFueVtdfT4oZGF0YXNldFVybHMuR0VUX1JBV19EQVRBX0JZX0RBVEFTRVQsIGRhdGFzZXREdG8pXG4gIH1cbiAgZ2V0RGF0YXNldHMgKCkge1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5nZXQ8RGF0YXNldER0b1tdPihkYXRhc2V0VXJscy5HRVRfQUxMKVxuICAgICAgLnBpcGUobWFwKGRhdGFzZXREdG9zID0+IGRhdGFzZXREdG9zLm1hcChEYXRhc2V0LmZyb21EdG8pKSlcbiAgfVxuICBnZXREYXRhc2V0QnlJZCAoaWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5nZXQ8RGF0YXNldER0bz4oZGF0YXNldFVybHMuR0VUX0JZX0lEICsgaWQpXG4gICAgICAucGlwZShtYXAoRGF0YXNldC5mcm9tRHRvKSlcbiAgfVxuICBzYXZlRGF0YXNldCAoZGF0YXNldER0bzogRGF0YXNldER0bykge1xuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdDxEYXRhc2V0RHRvPihcbiAgICAgIGRhdGFzZXREdG8uaWQgPyBkYXRhc2V0VXJscy5VUERBVEUgOiBkYXRhc2V0VXJscy5DUkVBVEUsXG4gICAgICAvLyBEYXRhc2V0LnRvRHRvKGRhdGFzZXQpXG4gICAgICBkYXRhc2V0RHRvXG4gICAgKS5waXBlKG1hcChEYXRhc2V0LmZyb21EdG8pKVxuICAgIC8vIFRPRE86XG4gICAgLy8gLCB0aGlzLnN1Y2Nlc3MoKVxuICB9XG4gIGltcG9ydFFPIChpZHM6IHN0cmluZ1tdKSB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0KGRhdGFzZXRVcmxzLklNUE9SVF9RTywgaWRzKVxuICB9XG4gIGRlbGV0ZURhdGFzZXQgKGRhdGFzZXRJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLnBvc3Q8YW55PihkYXRhc2V0VXJscy5ERUxFVEUsIG51bGwsIHsgcGFyYW1zOiB7IGlkOiBkYXRhc2V0SWQgfSB9KVxuICAgICAgLy8gVE9ETzpcbiAgICAgIC8vIC5waXBlKHRoaXMuc3VjY2VzcygpKVxuICB9XG5cbiAgLyoqIGFnZyAqL1xuICBnZXRBZ2dCeVBvcnRsZXRJZCAocG9ydGxldElkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldDxBZ2c+KGFnZ1VybHMuR0VUX0JZX1JFU09VUkNFLCB7XG4gICAgICBwYXJhbXM6IHtcbiAgICAgICAgcmVzb3VyY2U6ICdwb3J0bGV0JyxcbiAgICAgICAgcmVzb3VyY2VJZDogcG9ydGxldElkXG4gICAgICB9XG4gICAgfSkucGlwZShtYXAoQWdnLmZyb21EdG8pKVxuICB9XG4gIHNhdmVBZ2cgKGFnZzogQWdnKSB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLnBvc3Q8QWdnPihhZ2dVcmxzLlNBVkUsIEFnZy50b0R0byhhZ2cpKVxuICB9XG5cbiAgLyoqIHJlc3VsdCAqL1xuICBnZXRBZ2dSZXN1bHRCeUFnZyAoXG4gICAgYWdnOiBBZ2csXG4gICAgZHBWYWx1ZXM6IERwVmFsdWVbXSA9IFtdLFxuICAgIHJ1bnRpbWVBZ2c/OiBSdW50aW1lQWdnT3B0aW9uXG4gICkge1xuICAgIGNvbnN0IGJvZHk6IGFueSA9IHtcbiAgICAgIGFnZ0RhdGFEdG86IEFnZy50b0R0byhhZ2cpLFxuICAgICAgYWdncmVnYXRpb246IFJ1bnRpbWVBZ2dPcHRpb24udG9EdG8ocnVudGltZUFnZylcbiAgICB9XG4gICAgLy8gZGF0YVBhcmFtIOS4uiBbXSDmnI3liqHnq6/kvJrmiqXplJnvvIzoi6XmsqHmnInnm7TmjqXkuI3kvKDmraTlj4LmlbDjgIJcbiAgICBpZiAoZHBWYWx1ZXMgJiYgZHBWYWx1ZXMubGVuZ3RoID4gMCkgYm9keS5kYXRhUGFyYW0gPSBkcFZhbHVlcy5tYXAoRHBWYWx1ZS50b0R0bylcbiAgICByZXR1cm4gdGhpcy5odHRwLnBvc3Q8QWdnUmVzdWx0PihkYXRhUmVzdWx0U2V0VXJscy5HRVRfQllfQUdHLCBib2R5KVxuICB9XG4gIGdldFJlc3VsdEJ5UG9ydGxldElkIChcbiAgICBwb3J0bGV0SWQ6IHN0cmluZyxcbiAgICBkcFZhbHVlczogRHBWYWx1ZVtdID0gW10sXG4gICAgZmlsdGVyID0gJ1wiXCInLFxuICAgIHJ1bnRpbWVBZ2c/OiBSdW50aW1lQWdnT3B0aW9uXG4gICAgKSB7XG5cbiAgICBjb25zdCBib2R5OiBhbnkgPSB7XG4gICAgICBmaWx0ZXIsXG4gICAgICBhZ2dyZWdhdGlvbjogUnVudGltZUFnZ09wdGlvbi50b0R0byhydW50aW1lQWdnKVxuICAgIH1cbiAgICAvLyBkYXRhUGFyYW0g5Li6IFtdIOacjeWKoeerr+S8muaKpemUme+8jOiLpeayoeacieebtOaOpeS4jeS8oOatpOWPguaVsOOAglxuICAgIGlmIChkcFZhbHVlcyAmJiBkcFZhbHVlcy5sZW5ndGggPiAwKSBib2R5LmRhdGFQYXJhbSA9IGRwVmFsdWVzLm1hcChEcFZhbHVlLnRvRHRvKVxuXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0PEFnZ1Jlc3VsdD4oXG4gICAgICBkYXRhUmVzdWx0U2V0VXJscy5HRVRfQllfUkVTT1VSQ0UsXG4gICAgICBib2R5LFxuICAgICAge1xuICAgICAgICBoZWFkZXJzOiBuZXcgSHR0cEhlYWRlcnMoeydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbid9KSxcbiAgICAgICAgcGFyYW1zOiB7XG4gICAgICAgICAgcmVzb3VyY2VUeXBlOiAncG9ydGxldCcsXG4gICAgICAgICAgcmVzb3VyY2VJZDogcG9ydGxldElkXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICApXG4gIH1cbn1cbiJdfQ==