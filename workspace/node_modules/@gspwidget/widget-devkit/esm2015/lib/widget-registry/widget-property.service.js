/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { PlThemeColors } from '@gspwidget/util';
import { PropertyTypes } from '../../types';
import { FilterSchema, frontendFilterProp } from '../filter';
import { datalessJumpOption } from '../preset/preset.jump';
// import { WidgetPropertyMap } from './widget-event.decorator';
import { WidgetRegistry } from './widget-registry';
import { WidgetBase } from '../WidgetBase';
import { WidgetPropertyMap } from './widget-property.decorator';
import * as i0 from "@angular/core";
/** @type {?} */
const PropertyTypeDefaultValues = {
    [PropertyTypes.Text]: '',
    [PropertyTypes.Bool]: false,
    [PropertyTypes.Number]: 0,
    [PropertyTypes.DataField]: {}
    // [PropertyTypes.Color]: '#000000',
    // [PropertyTypes.Enum]: 0,
    // [PropertyTypes.Date]: new Date()
    // [PropertyTypes.Object]: {},
}
// const frontendFilterProp: PropertyOption = {
//   name: 'filter',
//   displayName: '筛选',
//   isArray: true,
//   type: PropertyTypes.Filter,
// }
// TODO: filters
;
// const frontendFilterProp: PropertyOption = {
//   name: 'filter',
//   displayName: '筛选',
//   isArray: true,
//   type: PropertyTypes.Filter,
// }
// TODO: filters
/** @type {?} */
const titleBarProps = [{
        category: 'titleBar',
        name: 'titleBarHide',
        type: PropertyTypes.Bool,
        boolOption: {
            default: false
        }
    }, {
        category: 'titleBar',
        name: 'titleBarShowRefresh',
        displayName: 'showRefreshBtn',
        type: PropertyTypes.Bool,
        boolOption: {
            default: true
        }
    }, Object.assign({}, datalessJumpOption, { category: 'titleBar', name: 'titleBarJump' })];
export class WidgetPropertyService {
    constructor() { }
    /**
     * 获得某种类型的全局默认值，在完全没有值时使用
     * @param {?} prop
     * @param {?=} arrayItem 是否是来获取 array 的子项默认值的，默认不是。
     * 如果不是，若 prop.isArray 为真，就返回空数组 []；
     * 如果是，则不管 prop.isArray 是否为真，总返回 prop.type 对应的默认值，仅应用于增加数组项时获取新项。
     * @return {?}
     */
    getPropertyDefaultValue(prop, arrayItem = false) {
        if (!arrayItem && prop.isArray)
            return [];
        // object: 递归生成具有所有 key 的对象，每个 key 的 value 是默认值
        if (prop.type === PropertyTypes.Object) {
            /** @type {?} */
            const newObj = {};
            prop.objectOption.objPropertyOptions.forEach((/**
             * @param {?} childProp
             * @return {?}
             */
            (childProp) => {
                newObj[childProp.name] = (childProp[childProp.type]
                    && childProp[childProp.type].default)
                    || this.getPropertyDefaultValue(childProp);
            }));
            return newObj;
        }
        else if (prop.type === PropertyTypes.Enum) {
            /** @type {?} */
            const firstItem = prop.enumOption.items[0];
            return typeof firstItem === 'string'
                ? firstItem
                : firstItem['value'];
        }
        else if (prop.type === PropertyTypes.Color) {
            /** @type {?} */
            const colors = this.getColorsByColorOption(prop.colorOption);
            /** @type {?} */
            const i = Math.random();
            return colors[Math.floor(i * colors.length)];
        }
        else if (prop.type === PropertyTypes.Filter) {
            return new FilterSchema();
        }
        else {
            return PropertyTypeDefaultValues[prop.type];
        }
    }
    /**
     * 元部件加载、编译完成后，组装新的 properties
     * widget name
     * -> constructor name
     * -> widget + title bar + base properties
     * -> 元部件的所有可配置 properties
     * @param {?} widgetName
     * @param {?} widgetConfig
     * @return {?}
     */
    getWidgetProps(widgetName, widgetConfig) {
        /** @type {?} */
        const ctorName = WidgetRegistry.getWidgetByName(widgetName).ctor.name
        // widget 子类中的 property
        ;
        // widget 子类中的 property
        /** @type {?} */
        const widgetProps = WidgetPropertyMap.get(ctorName) || []
        // 筛选出 widget 子类中没重写过的 property，否则可能会有俩一样的
        ;
        // 筛选出 widget 子类中没重写过的 property，否则可能会有俩一样的
        /** @type {?} */
        const baseProps = WidgetPropertyMap.get(WidgetBase.name)
            .filter((/**
         * @param {?} baseProp
         * @return {?}
         */
        baseProp => !widgetProps.some((/**
         * @param {?} prop
         * @return {?}
         */
        prop => baseProp.name === prop.name))))
        // 组装
        ;
        // 组装
        return [
            // 公共配置都放这
            ...baseProps,
            // 标题配置
            ...(widgetConfig.enableCommonTitleBar
                ? titleBarProps
                : []),
            // 筛选配置
            ...(widgetConfig.enableDataConfig && widgetConfig.enableCommonTitleBar
                ? [frontendFilterProp]
                : []),
            // 元部件自身配置
            ...widgetProps
            // ...testProps,
        ];
    }
    /**
     * mixin 已有pv + 元部件推荐的默认pv + 此类型的全局默认pv
     * @param {?} props
     * @param {?} propValues
     * @return {?}
     */
    mixinWidgetPropValues(props, propValues) {
        /** @type {?} */
        const mixinedPropValues = Object.assign({}, propValues)
        // 检查所有 properties，哪个没有值，就赋上默认推荐值
        ;
        // 检查所有 properties，哪个没有值，就赋上默认推荐值
        props.forEach((/**
         * @param {?} prop
         * @return {?}
         */
        prop => {
            // 这里必须是判断 undefined，否则 bool 类型的 false 也可能判定为无值
            if (mixinedPropValues[prop.name] === undefined) {
                mixinedPropValues[prop.name] = prop[prop.type] && prop[prop.type].default
                    // 如果元部件无默认值，就加入全局的当前类型默认值
                    || this.getPropertyDefaultValue(prop);
            }
        }));
        return mixinedPropValues;
    }
    /**
     * @param {?} colorOption
     * @return {?}
     */
    getColorsByColorOption(colorOption) {
        if (colorOption && colorOption.palette)
            return colorOption.palette;
        /** @type {?} */
        const colorType = colorOption ? colorOption.type : 'pure';
        /** @type {?} */
        let colors;
        switch (colorType) {
            case 'gradient':
                colors = PlThemeColors.gradient;
                break;
            case 'pureOrGradient':
                colors = [...PlThemeColors.pure, ...PlThemeColors.gradient];
                break;
            case 'pure':
            default:
                colors = PlThemeColors.pure;
                break;
        }
        return colors;
    }
}
WidgetPropertyService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
WidgetPropertyService.ctorParameters = () => [];
/** @nocollapse */ WidgetPropertyService.ngInjectableDef = i0.defineInjectable({ factory: function WidgetPropertyService_Factory() { return new WidgetPropertyService(); }, token: WidgetPropertyService, providedIn: "root" });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0LXByb3BlcnR5LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ3Nwd2lkZ2V0L3dpZGdldC1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvd2lkZ2V0LXJlZ2lzdHJ5L3dpZGdldC1wcm9wZXJ0eS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNoRCxPQUFPLEVBQWtCLGFBQWEsRUFBZ0IsTUFBTSxhQUFhLENBQUM7QUFDMUUsT0FBTyxFQUFFLFlBQVksRUFBRSxrQkFBa0IsRUFBaUIsTUFBTSxXQUFXLENBQUM7QUFDNUUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7O0FBRTNELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDZCQUE2QixDQUFDOzs7TUFFMUQseUJBQXlCLEdBQUc7SUFDaEMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUN4QixDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLO0lBQzNCLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7SUFDekIsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRTtJQUM3QixvQ0FBb0M7SUFDcEMsMkJBQTJCO0lBQzNCLG1DQUFtQztJQUNuQyw4QkFBOEI7Q0FDL0I7QUFFRCwrQ0FBK0M7QUFDL0Msb0JBQW9CO0FBQ3BCLHVCQUF1QjtBQUN2QixtQkFBbUI7QUFDbkIsZ0NBQWdDO0FBQ2hDLElBQUk7QUFDSixnQkFBZ0I7Ozs7Ozs7Ozs7TUFHVixhQUFhLEdBQXFCLENBQUM7UUFDdkMsUUFBUSxFQUFFLFVBQVU7UUFDcEIsSUFBSSxFQUFFLGNBQWM7UUFDcEIsSUFBSSxFQUFFLGFBQWEsQ0FBQyxJQUFJO1FBQ3hCLFVBQVUsRUFBRTtZQUNWLE9BQU8sRUFBRSxLQUFLO1NBQ2Y7S0FDRixFQUFFO1FBQ0QsUUFBUSxFQUFFLFVBQVU7UUFDcEIsSUFBSSxFQUFFLHFCQUFxQjtRQUMzQixXQUFXLEVBQUUsZ0JBQWdCO1FBQzdCLElBQUksRUFBRSxhQUFhLENBQUMsSUFBSTtRQUN4QixVQUFVLEVBQUU7WUFDVixPQUFPLEVBQUUsSUFBSTtTQUNkO0tBQ0Ysb0JBQ0ksa0JBQWtCLElBQ3JCLFFBQVEsRUFBRSxVQUFVLEVBQ3BCLElBQUksRUFBRSxjQUFjLElBQ3BCO0FBS0YsTUFBTSxPQUFPLHFCQUFxQjtJQUVoQyxnQkFDSSxDQUFDOzs7Ozs7Ozs7SUFRRSx1QkFBdUIsQ0FBRSxJQUFvQixFQUFFLFNBQVMsR0FBRyxLQUFLO1FBQ3JFLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLE9BQU87WUFBRSxPQUFPLEVBQUUsQ0FBQTtRQUN6QywrQ0FBK0M7UUFDL0MsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLGFBQWEsQ0FBQyxNQUFNLEVBQUU7O2tCQUNoQyxNQUFNLEdBQUcsRUFBRTtZQUNqQixJQUFJLENBQUMsWUFBWSxDQUFDLGtCQUFrQixDQUFDLE9BQU87Ozs7WUFBQyxDQUFDLFNBQXlCLEVBQUUsRUFBRTtnQkFDekUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDO3VCQUM5QyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQzt1QkFDbEMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFNBQVMsQ0FBQyxDQUFBO1lBQzlDLENBQUMsRUFBQyxDQUFBO1lBQ0YsT0FBTyxNQUFNLENBQUE7U0FDZDthQUFNLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxhQUFhLENBQUMsSUFBSSxFQUFFOztrQkFDckMsU0FBUyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUMxQyxPQUFPLE9BQU8sU0FBUyxLQUFLLFFBQVE7Z0JBQ2xDLENBQUMsQ0FBQyxTQUFTO2dCQUNYLENBQUMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUE7U0FDdkI7YUFBTSxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssYUFBYSxDQUFDLEtBQUssRUFBRTs7a0JBQ3RDLE1BQU0sR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQzs7a0JBQ3RELENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ3ZCLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFBO1NBQzdDO2FBQU0sSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLGFBQWEsQ0FBQyxNQUFNLEVBQUU7WUFDN0MsT0FBTyxJQUFJLFlBQVksRUFBRSxDQUFBO1NBQzFCO2FBQU07WUFDTCxPQUFPLHlCQUF5QixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtTQUM1QztJQUNILENBQUM7Ozs7Ozs7Ozs7O0lBUU0sY0FBYyxDQUFFLFVBQWtCLEVBQUUsWUFBMEI7O2NBQzdELFFBQVEsR0FBRyxjQUFjLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJO1FBQ3JFLHVCQUF1Qjs7OztjQUNqQixXQUFXLEdBQUcsaUJBQWlCLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUU7UUFDekQsMENBQTBDOzs7O2NBQ3BDLFNBQVMsR0FBRyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQzthQUNyRCxNQUFNOzs7O1FBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxJQUFJOzs7O1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxLQUFLLElBQUksQ0FBQyxJQUFJLEVBQUMsRUFBQztRQUM3RSxLQUFLOztRQUFMLEtBQUs7UUFDTCxPQUFPO1lBQ0wsVUFBVTtZQUNWLEdBQUcsU0FBUztZQUNaLE9BQU87WUFDUCxHQUFHLENBQUMsWUFBWSxDQUFDLG9CQUFvQjtnQkFDbkMsQ0FBQyxDQUFDLGFBQWE7Z0JBQ2YsQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUNQLE9BQU87WUFDUCxHQUFHLENBQUMsWUFBWSxDQUFDLGdCQUFnQixJQUFJLFlBQVksQ0FBQyxvQkFBb0I7Z0JBQ3BFLENBQUMsQ0FBQyxDQUFDLGtCQUFrQixDQUFDO2dCQUN0QixDQUFDLENBQUMsRUFBRSxDQUFDO1lBQ1AsVUFBVTtZQUNWLEdBQUcsV0FBVztZQUNkLGdCQUFnQjtTQUNqQixDQUFBO0lBQ0gsQ0FBQzs7Ozs7OztJQUlNLHFCQUFxQixDQUFFLEtBQXVCLEVBQUUsVUFBa0I7O2NBQ2pFLGlCQUFpQixxQkFBcUMsVUFBVSxDQUFFO1FBQ3hFLGlDQUFpQzs7UUFBakMsaUNBQWlDO1FBQ2pDLEtBQUssQ0FBQyxPQUFPOzs7O1FBQUMsSUFBSSxDQUFDLEVBQUU7WUFDbkIsK0NBQStDO1lBQy9DLElBQUksaUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLFNBQVMsRUFBRTtnQkFDOUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPO29CQUN2RSwwQkFBMEI7dUJBQ3ZCLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsQ0FBQTthQUN4QztRQUNILENBQUMsRUFBQyxDQUFBO1FBQ0YsT0FBTyxpQkFBaUIsQ0FBQTtJQUMxQixDQUFDOzs7OztJQUVNLHNCQUFzQixDQUFFLFdBQVc7UUFDeEMsSUFBSSxXQUFXLElBQUksV0FBVyxDQUFDLE9BQU87WUFBRSxPQUFPLFdBQVcsQ0FBQyxPQUFPLENBQUE7O2NBQzVELFNBQVMsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU07O1lBQ3JELE1BQU07UUFDVixRQUFRLFNBQVMsRUFBRTtZQUNqQixLQUFLLFVBQVU7Z0JBQ2IsTUFBTSxHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUE7Z0JBQy9CLE1BQUs7WUFDUCxLQUFLLGdCQUFnQjtnQkFDbkIsTUFBTSxHQUFHLENBQUMsR0FBRyxhQUFhLENBQUMsSUFBSSxFQUFFLEdBQUcsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFBO2dCQUMzRCxNQUFLO1lBQ1AsS0FBSyxNQUFNLENBQUM7WUFDWjtnQkFDRSxNQUFNLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQTtnQkFDM0IsTUFBSztTQUNSO1FBQ0QsT0FBTyxNQUFNLENBQUE7SUFDZixDQUFDOzs7WUF6R0YsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUGxUaGVtZUNvbG9ycyB9IGZyb20gJ0Bnc3B3aWRnZXQvdXRpbCc7XG5pbXBvcnQgeyBQcm9wZXJ0eU9wdGlvbiwgUHJvcGVydHlUeXBlcywgV2lkZ2V0Q29uZmlnIH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xuaW1wb3J0IHsgRmlsdGVyU2NoZW1hLCBmcm9udGVuZEZpbHRlclByb3AsIGlmRnNEYXRlUmFuZ2UgfSBmcm9tICcuLi9maWx0ZXInO1xuaW1wb3J0IHsgZGF0YWxlc3NKdW1wT3B0aW9uIH0gZnJvbSAnLi4vcHJlc2V0L3ByZXNldC5qdW1wJztcbi8vIGltcG9ydCB7IFdpZGdldFByb3BlcnR5TWFwIH0gZnJvbSAnLi93aWRnZXQtZXZlbnQuZGVjb3JhdG9yJztcbmltcG9ydCB7IFdpZGdldFJlZ2lzdHJ5IH0gZnJvbSAnLi93aWRnZXQtcmVnaXN0cnknO1xuaW1wb3J0IHsgV2lkZ2V0QmFzZSB9IGZyb20gJy4uL1dpZGdldEJhc2UnO1xuaW1wb3J0IHsgV2lkZ2V0UHJvcGVydHlNYXAgfSBmcm9tICcuL3dpZGdldC1wcm9wZXJ0eS5kZWNvcmF0b3InO1xuXG5jb25zdCBQcm9wZXJ0eVR5cGVEZWZhdWx0VmFsdWVzID0ge1xuICBbUHJvcGVydHlUeXBlcy5UZXh0XTogJycsXG4gIFtQcm9wZXJ0eVR5cGVzLkJvb2xdOiBmYWxzZSxcbiAgW1Byb3BlcnR5VHlwZXMuTnVtYmVyXTogMCxcbiAgW1Byb3BlcnR5VHlwZXMuRGF0YUZpZWxkXToge31cbiAgLy8gW1Byb3BlcnR5VHlwZXMuQ29sb3JdOiAnIzAwMDAwMCcsXG4gIC8vIFtQcm9wZXJ0eVR5cGVzLkVudW1dOiAwLFxuICAvLyBbUHJvcGVydHlUeXBlcy5EYXRlXTogbmV3IERhdGUoKVxuICAvLyBbUHJvcGVydHlUeXBlcy5PYmplY3RdOiB7fSxcbn1cblxuLy8gY29uc3QgZnJvbnRlbmRGaWx0ZXJQcm9wOiBQcm9wZXJ0eU9wdGlvbiA9IHtcbi8vICAgbmFtZTogJ2ZpbHRlcicsXG4vLyAgIGRpc3BsYXlOYW1lOiAn562b6YCJJyxcbi8vICAgaXNBcnJheTogdHJ1ZSxcbi8vICAgdHlwZTogUHJvcGVydHlUeXBlcy5GaWx0ZXIsXG4vLyB9XG4vLyBUT0RPOiBmaWx0ZXJzXG5cblxuY29uc3QgdGl0bGVCYXJQcm9wczogUHJvcGVydHlPcHRpb25bXSA9IFt7XG4gIGNhdGVnb3J5OiAndGl0bGVCYXInLFxuICBuYW1lOiAndGl0bGVCYXJIaWRlJyxcbiAgdHlwZTogUHJvcGVydHlUeXBlcy5Cb29sLFxuICBib29sT3B0aW9uOiB7XG4gICAgZGVmYXVsdDogZmFsc2VcbiAgfVxufSwge1xuICBjYXRlZ29yeTogJ3RpdGxlQmFyJyxcbiAgbmFtZTogJ3RpdGxlQmFyU2hvd1JlZnJlc2gnLFxuICBkaXNwbGF5TmFtZTogJ3Nob3dSZWZyZXNoQnRuJyxcbiAgdHlwZTogUHJvcGVydHlUeXBlcy5Cb29sLFxuICBib29sT3B0aW9uOiB7XG4gICAgZGVmYXVsdDogdHJ1ZVxuICB9XG59LCB7XG4gIC4uLmRhdGFsZXNzSnVtcE9wdGlvbixcbiAgY2F0ZWdvcnk6ICd0aXRsZUJhcicsXG4gIG5hbWU6ICd0aXRsZUJhckp1bXAnLFxufV1cblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgV2lkZ2V0UHJvcGVydHlTZXJ2aWNlIHtcblxuICBjb25zdHJ1Y3RvciAoXG4gICkgeyB9XG4gIC8qKlxuICAgKiDojrflvpfmn5Dnp43nsbvlnovnmoTlhajlsYDpu5jorqTlgLzvvIzlnKjlrozlhajmsqHmnInlgLzml7bkvb/nlKhcbiAgICogQHBhcmFtIHByb3BcbiAgICogQHBhcmFtIGFycmF5SXRlbSDmmK/lkKbmmK/mnaXojrflj5YgYXJyYXkg55qE5a2Q6aG56buY6K6k5YC855qE77yM6buY6K6k5LiN5piv44CCXG4gICAqIOWmguaenOS4jeaYr++8jOiLpSBwcm9wLmlzQXJyYXkg5Li655yf77yM5bCx6L+U5Zue56m65pWw57uEIFtd77ybXG4gICAqIOWmguaenOaYr++8jOWImeS4jeeuoSBwcm9wLmlzQXJyYXkg5piv5ZCm5Li655yf77yM5oC76L+U5ZueIHByb3AudHlwZSDlr7nlupTnmoTpu5jorqTlgLzvvIzku4XlupTnlKjkuo7lop7liqDmlbDnu4Tpobnml7bojrflj5bmlrDpobnjgIJcbiAgICovXG4gIHB1YmxpYyBnZXRQcm9wZXJ0eURlZmF1bHRWYWx1ZSAocHJvcDogUHJvcGVydHlPcHRpb24sIGFycmF5SXRlbSA9IGZhbHNlKSB7XG4gICAgaWYgKCFhcnJheUl0ZW0gJiYgcHJvcC5pc0FycmF5KSByZXR1cm4gW11cbiAgICAvLyBvYmplY3Q6IOmAkuW9kueUn+aIkOWFt+acieaJgOaciSBrZXkg55qE5a+56LGh77yM5q+P5LiqIGtleSDnmoQgdmFsdWUg5piv6buY6K6k5YC8XG4gICAgaWYgKHByb3AudHlwZSA9PT0gUHJvcGVydHlUeXBlcy5PYmplY3QpIHtcbiAgICAgIGNvbnN0IG5ld09iaiA9IHt9XG4gICAgICBwcm9wLm9iamVjdE9wdGlvbi5vYmpQcm9wZXJ0eU9wdGlvbnMuZm9yRWFjaCgoY2hpbGRQcm9wOiBQcm9wZXJ0eU9wdGlvbikgPT4ge1xuICAgICAgICBuZXdPYmpbY2hpbGRQcm9wLm5hbWVdID0gKGNoaWxkUHJvcFtjaGlsZFByb3AudHlwZV1cbiAgICAgICAgICAmJiBjaGlsZFByb3BbY2hpbGRQcm9wLnR5cGVdLmRlZmF1bHQpXG4gICAgICAgICAgfHwgdGhpcy5nZXRQcm9wZXJ0eURlZmF1bHRWYWx1ZShjaGlsZFByb3ApXG4gICAgICB9KVxuICAgICAgcmV0dXJuIG5ld09ialxuICAgIH0gZWxzZSBpZiAocHJvcC50eXBlID09PSBQcm9wZXJ0eVR5cGVzLkVudW0pIHtcbiAgICAgIGNvbnN0IGZpcnN0SXRlbSA9IHByb3AuZW51bU9wdGlvbi5pdGVtc1swXVxuICAgICAgcmV0dXJuIHR5cGVvZiBmaXJzdEl0ZW0gPT09ICdzdHJpbmcnXG4gICAgICAgID8gZmlyc3RJdGVtXG4gICAgICAgIDogZmlyc3RJdGVtWyd2YWx1ZSddXG4gICAgfSBlbHNlIGlmIChwcm9wLnR5cGUgPT09IFByb3BlcnR5VHlwZXMuQ29sb3IpIHtcbiAgICAgIGNvbnN0IGNvbG9ycyA9IHRoaXMuZ2V0Q29sb3JzQnlDb2xvck9wdGlvbihwcm9wLmNvbG9yT3B0aW9uKVxuICAgICAgY29uc3QgaSA9IE1hdGgucmFuZG9tKClcbiAgICAgIHJldHVybiBjb2xvcnNbTWF0aC5mbG9vcihpICogY29sb3JzLmxlbmd0aCldXG4gICAgfSBlbHNlIGlmIChwcm9wLnR5cGUgPT09IFByb3BlcnR5VHlwZXMuRmlsdGVyKSB7XG4gICAgICByZXR1cm4gbmV3IEZpbHRlclNjaGVtYSgpXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9wZXJ0eVR5cGVEZWZhdWx0VmFsdWVzW3Byb3AudHlwZV1cbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOWFg+mDqOS7tuWKoOi9veOAgee8luivkeWujOaIkOWQju+8jOe7hOijheaWsOeahCBwcm9wZXJ0aWVzXG4gICAqIHdpZGdldCBuYW1lXG4gICAqIC0+IGNvbnN0cnVjdG9yIG5hbWVcbiAgICogLT4gd2lkZ2V0ICsgdGl0bGUgYmFyICsgYmFzZSBwcm9wZXJ0aWVzXG4gICAqIC0+IOWFg+mDqOS7tueahOaJgOacieWPr+mFjee9riBwcm9wZXJ0aWVzXG4gICAqL1xuICBwdWJsaWMgZ2V0V2lkZ2V0UHJvcHMgKHdpZGdldE5hbWU6IHN0cmluZywgd2lkZ2V0Q29uZmlnOiBXaWRnZXRDb25maWcpOiBQcm9wZXJ0eU9wdGlvbltdIHtcbiAgICBjb25zdCBjdG9yTmFtZSA9IFdpZGdldFJlZ2lzdHJ5LmdldFdpZGdldEJ5TmFtZSh3aWRnZXROYW1lKS5jdG9yLm5hbWVcbiAgICAvLyB3aWRnZXQg5a2Q57G75Lit55qEIHByb3BlcnR5XG4gICAgY29uc3Qgd2lkZ2V0UHJvcHMgPSBXaWRnZXRQcm9wZXJ0eU1hcC5nZXQoY3Rvck5hbWUpIHx8IFtdXG4gICAgLy8g562b6YCJ5Ye6IHdpZGdldCDlrZDnsbvkuK3msqHph43lhpnov4fnmoQgcHJvcGVydHnvvIzlkKbliJnlj6/og73kvJrmnInkv6nkuIDmoLfnmoRcbiAgICBjb25zdCBiYXNlUHJvcHMgPSBXaWRnZXRQcm9wZXJ0eU1hcC5nZXQoV2lkZ2V0QmFzZS5uYW1lKVxuICAgICAgLmZpbHRlcihiYXNlUHJvcCA9PiAhd2lkZ2V0UHJvcHMuc29tZShwcm9wID0+IGJhc2VQcm9wLm5hbWUgPT09IHByb3AubmFtZSkpXG4gICAgLy8g57uE6KOFXG4gICAgcmV0dXJuIFtcbiAgICAgIC8vIOWFrOWFsemFjee9rumDveaUvui/mVxuICAgICAgLi4uYmFzZVByb3BzLFxuICAgICAgLy8g5qCH6aKY6YWN572uXG4gICAgICAuLi4od2lkZ2V0Q29uZmlnLmVuYWJsZUNvbW1vblRpdGxlQmFyXG4gICAgICAgID8gdGl0bGVCYXJQcm9wc1xuICAgICAgICA6IFtdKSxcbiAgICAgIC8vIOetm+mAiemFjee9rlxuICAgICAgLi4uKHdpZGdldENvbmZpZy5lbmFibGVEYXRhQ29uZmlnICYmIHdpZGdldENvbmZpZy5lbmFibGVDb21tb25UaXRsZUJhclxuICAgICAgICA/IFtmcm9udGVuZEZpbHRlclByb3BdXG4gICAgICAgIDogW10pLFxuICAgICAgLy8g5YWD6YOo5Lu26Ieq6Lqr6YWN572uXG4gICAgICAuLi53aWRnZXRQcm9wc1xuICAgICAgLy8gLi4udGVzdFByb3BzLFxuICAgIF1cbiAgfVxuICAvKipcbiAgICogbWl4aW4g5bey5pyJcHYgKyDlhYPpg6jku7bmjqjojZDnmoTpu5jorqRwdiArIOatpOexu+Wei+eahOWFqOWxgOm7mOiupHB2XG4gICAqL1xuICBwdWJsaWMgbWl4aW5XaWRnZXRQcm9wVmFsdWVzIChwcm9wczogUHJvcGVydHlPcHRpb25bXSwgcHJvcFZhbHVlczogb2JqZWN0KSB7XG4gICAgY29uc3QgbWl4aW5lZFByb3BWYWx1ZXM6IHsgW3Byb3BOYW1lOiBzdHJpbmddOiBhbnkgfSA9IHsgLi4ucHJvcFZhbHVlcyB9XG4gICAgLy8g5qOA5p+l5omA5pyJIHByb3BlcnRpZXPvvIzlk6rkuKrmsqHmnInlgLzvvIzlsLHotYvkuIrpu5jorqTmjqjojZDlgLxcbiAgICBwcm9wcy5mb3JFYWNoKHByb3AgPT4ge1xuICAgICAgLy8g6L+Z6YeM5b+F6aG75piv5Yik5patIHVuZGVmaW5lZO+8jOWQpuWImSBib29sIOexu+Wei+eahCBmYWxzZSDkuZ/lj6/og73liKTlrprkuLrml6DlgLxcbiAgICAgIGlmIChtaXhpbmVkUHJvcFZhbHVlc1twcm9wLm5hbWVdID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgbWl4aW5lZFByb3BWYWx1ZXNbcHJvcC5uYW1lXSA9IHByb3BbcHJvcC50eXBlXSAmJiBwcm9wW3Byb3AudHlwZV0uZGVmYXVsdFxuICAgICAgICAgIC8vIOWmguaenOWFg+mDqOS7tuaXoOm7mOiupOWAvO+8jOWwseWKoOWFpeWFqOWxgOeahOW9k+WJjeexu+Wei+m7mOiupOWAvFxuICAgICAgICAgIHx8IHRoaXMuZ2V0UHJvcGVydHlEZWZhdWx0VmFsdWUocHJvcClcbiAgICAgIH1cbiAgICB9KVxuICAgIHJldHVybiBtaXhpbmVkUHJvcFZhbHVlc1xuICB9XG5cbiAgcHVibGljIGdldENvbG9yc0J5Q29sb3JPcHRpb24gKGNvbG9yT3B0aW9uKSB7XG4gICAgaWYgKGNvbG9yT3B0aW9uICYmIGNvbG9yT3B0aW9uLnBhbGV0dGUpIHJldHVybiBjb2xvck9wdGlvbi5wYWxldHRlXG4gICAgY29uc3QgY29sb3JUeXBlID0gY29sb3JPcHRpb24gPyBjb2xvck9wdGlvbi50eXBlIDogJ3B1cmUnXG4gICAgbGV0IGNvbG9yc1xuICAgIHN3aXRjaCAoY29sb3JUeXBlKSB7XG4gICAgICBjYXNlICdncmFkaWVudCc6XG4gICAgICAgIGNvbG9ycyA9IFBsVGhlbWVDb2xvcnMuZ3JhZGllbnRcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgJ3B1cmVPckdyYWRpZW50JzpcbiAgICAgICAgY29sb3JzID0gWy4uLlBsVGhlbWVDb2xvcnMucHVyZSwgLi4uUGxUaGVtZUNvbG9ycy5ncmFkaWVudF1cbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgJ3B1cmUnOlxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgY29sb3JzID0gUGxUaGVtZUNvbG9ycy5wdXJlXG4gICAgICAgIGJyZWFrXG4gICAgfVxuICAgIHJldHVybiBjb2xvcnNcbiAgfVxuXG59XG4iXX0=