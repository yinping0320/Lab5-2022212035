/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { BsModalService } from 'ngx-bootstrap/modal';
import { JumpTypes } from './preset/preset.jump';
import { CHART_TABLE_FUNC_ID } from './util';
/**
 * @deprecated
 * 为了 widget-devkit 的兼容而暂时保留。不准再用了。
 * 元部件应该直接用 \@gspwidget/util。
 * @type {?}
 */
export const DASHBOARD_API = 'DashboardApi';
export class WidgetDevkitService {
    /**
     * @param {?} modalService
     */
    constructor(modalService) {
        this.modalService = modalService;
    }
    /**
     * @param {?} content
     * @param {?=} config
     * @return {?}
     */
    openModal(content, config) {
        return this.modalService.show(content, config);
    }
    /**
     * @param {?} funcId
     * @param {?=} queryParamsArray
     * @return {?}
     */
    openMenu(funcId, queryParamsArray) {
        window[DASHBOARD_API].openMenu(funcId, queryParamsArray);
    }
    /**
     * @param {?} appId
     * @return {?}
     */
    openApp(appId) {
        window[DASHBOARD_API].openApp(appId);
    }
    /**
     * options 参考 https://ng.ant.design/components/message/zh
     * @param {?} content
     * @param {?=} options
     * @return {?}
     */
    openInfoMsg(content, options) {
        window[DASHBOARD_API].messageSvc.info(content, options);
    }
    /**
     * options 参考 https://ng.ant.design/components/message/zh
     * @param {?} content
     * @param {?=} options
     * @return {?}
     */
    openSuccessMsg(content, options) {
        window[DASHBOARD_API].messageSvc.success(content, options);
    }
    /**
     * options 参考 https://ng.ant.design/components/message/zh
     * @param {?} content
     * @param {?=} options
     * @return {?}
     */
    openWarningMsg(content, options) {
        window[DASHBOARD_API].messageSvc.warning(content, options);
    }
    /**
     * options 参考 https://ng.ant.design/components/message/zh
     * @param {?} content
     * @param {?=} options
     * @return {?}
     */
    openErrorMsg(content, options) {
        window[DASHBOARD_API].messageSvc.error(content, options);
    }
    /**
     * @param {?} dataOption
     * @return {?}
     */
    getData(dataOption) {
        return window[DASHBOARD_API].storageSvc.getData(dataOption);
    }
    /**
     * @param {?=} reload
     * @return {?}
     */
    getUserInfo(reload = false) {
        return window[DASHBOARD_API].storageSvc.getUserInfo(reload);
    }
    /**
     * @param {?=} reload
     * @return {?}
     */
    getUserAvatar(reload = false) {
        return window[DASHBOARD_API].storageSvc.getUserAvatar(reload);
    }
    /**
     * @deprecated 应用另外两个 jump 方法
     * 联查跳转，直接把配置属性的值传进来就行。配成“无”就不跳转。
     * @param {?} jumpProperty 跳转的配置属性的值
     * @param {?=} dataItem 当前跳转对应的数据行。如果是全局跳转，就传入第一行？
     * @return {?}
     */
    jump(jumpProperty, dataItem) {
        const { type, funcId, params } = jumpProperty;
        /** @type {?} */
        const queryParamsArray = Array.isArray(params)
            ? params.map((/**
             * @param {?} param
             * @return {?}
             */
            param => [param.key, (param.valueType === 'fixedValue'
                    ? param.fixedValue
                    : (dataItem
                        ? dataItem[param.fieldName.name]
                        : undefined))]))
            : undefined;
        switch (type) {
            case JumpTypes.None:
                return;
            case JumpTypes.Func:
                this.openMenu(funcId, queryParamsArray);
                break;
            case JumpTypes.ChartTable:
                this.openMenu(CHART_TABLE_FUNC_ID, queryParamsArray);
                break;
        }
    }
    /**
     * @param {?} dataJumpConfig
     * @param {?} dataItem
     * @return {?}
     */
    jumpWithData(dataJumpConfig, dataItem) {
        const { jumpType, funcIdSource, funcIdDataField, funcId, funcParams, url, urlParams, queryParams } = dataJumpConfig;
        /** @type {?} */
        const funcParamsArray = Array.isArray(funcParams)
            ? funcParams.map((/**
             * @param {?} funcParam
             * @return {?}
             */
            funcParam => [funcParam.key, (funcParam.valueType === 'fixedValue'
                    ? funcParam.fixedValue
                    : (dataItem
                        ? dataItem[funcParam.fieldName.name]
                        : undefined))]))
            : undefined;
        switch (jumpType) {
            case JumpTypes.None:
                return;
            case JumpTypes.Func:
                /** @type {?} */
                const resultFuncId = (!funcIdSource || funcIdSource === 'fixed')
                    ? funcId
                    : dataItem[funcIdDataField.name];
                if (resultFuncId)
                    this.openMenu(resultFuncId, funcParamsArray);
                break;
            case JumpTypes.ChartTable:
                this.openMenu(CHART_TABLE_FUNC_ID, funcParamsArray);
                break;
            case JumpTypes.NewBrowserTab:
                // 拼 url
                /** @type {?} */
                let finalUrl = url
                // + urlParams
                ;
                // + urlParams
                if (urlParams && urlParams.length > 0) {
                    /** @type {?} */
                    const urlParamPart = urlParams.map((/**
                     * @param {?} urlParam
                     * @return {?}
                     */
                    urlParam => {
                        const { valueType, fixedValue, fieldName } = urlParam;
                        return valueType === 'fixedValue' ? fixedValue : dataItem[fieldName.name];
                    })).join('/');
                    finalUrl += url.endsWith('/') ? '' : '/';
                    finalUrl += urlParamPart;
                }
                // + queryParams
                if (queryParams && queryParams.length > 0) {
                    /** @type {?} */
                    const queryParamPart = queryParams.map((/**
                     * @param {?} queryParam
                     * @return {?}
                     */
                    queryParam => {
                        const { key, valueType, fixedValue, fieldName } = queryParam;
                        return `${key}=${valueType === 'fixedValue' ? fixedValue : dataItem[fieldName.name]}`;
                    })).join('&');
                    finalUrl += '?' + queryParamPart;
                }
                // 打开
                window.open(finalUrl, '_blank');
        }
    }
    /**
     * @param {?} datalessJumpConfig
     * @return {?}
     */
    jumpWithoutData(datalessJumpConfig) {
        const { jumpType, funcId, funcParams, url } = datalessJumpConfig;
        /** @type {?} */
        const funcParamsArray = Array.isArray(funcParams)
            ? funcParams.map((/**
             * @param {?} funcParam
             * @return {?}
             */
            funcParam => [funcParam.key, funcParam.value]))
            : undefined;
        switch (jumpType) {
            case JumpTypes.None:
                return;
            case JumpTypes.Func:
                this.openMenu(funcId, funcParamsArray);
                break;
            case JumpTypes.ChartTable:
                this.openMenu(CHART_TABLE_FUNC_ID, funcParamsArray);
                break;
            case JumpTypes.NewBrowserTab:
                window.open(url, '_blank');
        }
    }
}
WidgetDevkitService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
WidgetDevkitService.ctorParameters = () => [
    { type: BsModalService }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    WidgetDevkitService.prototype.modalService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0LWRldmtpdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGdzcHdpZGdldC93aWRnZXQtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3dpZGdldC1kZXZraXQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsY0FBYyxFQUFnQixNQUFNLHFCQUFxQixDQUFDO0FBQ25FLE9BQU8sRUFBc0MsU0FBUyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDckYsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sUUFBUSxDQUFDOzs7Ozs7O0FBTzdDLE1BQU0sT0FBTyxhQUFhLEdBQUcsY0FBYztBQUszQyxNQUFNLE9BQU8sbUJBQW1COzs7O0lBRTlCLFlBQ1UsWUFBNEI7UUFBNUIsaUJBQVksR0FBWixZQUFZLENBQWdCO0lBR2xDLENBQUM7Ozs7OztJQUVMLFNBQVMsQ0FBRSxPQUFZLEVBQUUsTUFBcUI7UUFDNUMsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUE7SUFDaEQsQ0FBQzs7Ozs7O0lBRUQsUUFBUSxDQUFFLE1BQWMsRUFBRSxnQkFBNkI7UUFDckQsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQTtJQUMxRCxDQUFDOzs7OztJQUNELE9BQU8sQ0FBRSxLQUFhO1FBQ3BCLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDdEMsQ0FBQzs7Ozs7OztJQUlELFdBQVcsQ0FBRSxPQUFlLEVBQUUsT0FBUTtRQUNwQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUE7SUFDekQsQ0FBQzs7Ozs7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QUFBO2dCQUN0QyxNQUFLO1lBQ1AsS0FBSyxTQUFTLENBQUMsVUFBVTtnQkFDdkIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxlQUFlLENBQUMsQ0FBQTtnQkFDbkQsTUFBSztZQUNQLEtBQUssU0FBUyxDQUFDLGFBQWE7Z0JBQzFCLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFBO1NBQzdCO0lBQ0gsQ0FBQzs7O1lBcEpGLFVBQVU7Ozs7WUFYRixjQUFjOzs7Ozs7O0lBaUJuQiwyQ0FBb0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCc01vZGFsU2VydmljZSwgTW9kYWxPcHRpb25zIH0gZnJvbSAnbmd4LWJvb3RzdHJhcC9tb2RhbCc7XG5pbXBvcnQgeyBEYXRhSnVtcENvbmZpZywgRGF0YWxlc3NKdW1wQ29uZmlnLCBKdW1wVHlwZXMgfSBmcm9tICcuL3ByZXNldC9wcmVzZXQuanVtcCc7XG5pbXBvcnQgeyBDSEFSVF9UQUJMRV9GVU5DX0lEIH0gZnJvbSAnLi91dGlsJztcblxuLyoqXG4gKiBAZGVwcmVjYXRlZFxuICog5Li65LqGIHdpZGdldC1kZXZraXQg55qE5YW85a656ICM5pqC5pe25L+d55WZ44CC5LiN5YeG5YaN55So5LqG44CCXG4gKiDlhYPpg6jku7blupTor6Xnm7TmjqXnlKggQGdzcHdpZGdldC91dGls44CCXG4gKi9cbmV4cG9ydCBjb25zdCBEQVNIQk9BUkRfQVBJID0gJ0Rhc2hib2FyZEFwaSdcblxuQEluamVjdGFibGUoXG4gIC8vIHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH1cbilcbmV4cG9ydCBjbGFzcyBXaWRnZXREZXZraXRTZXJ2aWNlIHtcblxuICBjb25zdHJ1Y3RvciAoXG4gICAgcHJpdmF0ZSBtb2RhbFNlcnZpY2U6IEJzTW9kYWxTZXJ2aWNlLFxuICAgIC8vIHByaXZhdGUgaHR0cDogSHR0cENsaWVudFxuICAgIC8vIHByaXZhdGUgc3RvcmFnZVN2YzogU3RvcmFnZVNlcnZpY2VcbiAgKSB7IH1cblxuICBvcGVuTW9kYWwgKGNvbnRlbnQ6IGFueSwgY29uZmlnPzogTW9kYWxPcHRpb25zKSB7XG4gICAgcmV0dXJuIHRoaXMubW9kYWxTZXJ2aWNlLnNob3coY29udGVudCwgY29uZmlnKVxuICB9XG5cbiAgb3Blbk1lbnUgKGZ1bmNJZDogc3RyaW5nLCBxdWVyeVBhcmFtc0FycmF5Pzogc3RyaW5nW11bXSkge1xuICAgIHdpbmRvd1tEQVNIQk9BUkRfQVBJXS5vcGVuTWVudShmdW5jSWQsIHF1ZXJ5UGFyYW1zQXJyYXkpXG4gIH1cbiAgb3BlbkFwcCAoYXBwSWQ6IHN0cmluZykge1xuICAgIHdpbmRvd1tEQVNIQk9BUkRfQVBJXS5vcGVuQXBwKGFwcElkKVxuICB9XG4gIC8qKlxuICAgKiBvcHRpb25zIOWPguiAgyBodHRwczovL25nLmFudC5kZXNpZ24vY29tcG9uZW50cy9tZXNzYWdlL3poXG4gICAqL1xuICBvcGVuSW5mb01zZyAoY29udGVudDogc3RyaW5nLCBvcHRpb25zPykge1xuICAgIHdpbmRvd1tEQVNIQk9BUkRfQVBJXS5tZXNzYWdlU3ZjLmluZm8oY29udGVudCwgb3B0aW9ucylcbiAgfVxuICAvKipcbiAgICogb3B0aW9ucyDlj4LogIMgaHR0cHM6Ly9uZy5hbnQuZGVzaWduL2NvbXBvbmVudHMvbWVzc2FnZS96aFxuICAgKi9cbiAgb3BlblN1Y2Nlc3NNc2cgKGNvbnRlbnQ6IHN0cmluZywgb3B0aW9ucz8pIHtcbiAgICB3aW5kb3dbREFTSEJPQVJEX0FQSV0ubWVzc2FnZVN2Yy5zdWNjZXNzKGNvbnRlbnQsIG9wdGlvbnMpXG4gIH1cbiAgLyoqXG4gICAqIG9wdGlvbnMg5Y+C6ICDIGh0dHBzOi8vbmcuYW50LmRlc2lnbi9jb21wb25lbnRzL21lc3NhZ2UvemhcbiAgICovXG4gIG9wZW5XYXJuaW5nTXNnIChjb250ZW50OiBzdHJpbmcsIG9wdGlvbnM/KSB7XG4gICAgd2luZG93W0RBU0hCT0FSRF9BUEldLm1lc3NhZ2VTdmMud2FybmluZyhjb250ZW50LCBvcHRpb25zKVxuICB9XG4gIC8qKlxuICAgKiBvcHRpb25zIOWPguiAgyBodHRwczovL25nLmFudC5kZXNpZ24vY29tcG9uZW50cy9tZXNzYWdlL3poXG4gICAqL1xuICBvcGVuRXJyb3JNc2cgKGNvbnRlbnQ6IHN0cmluZywgb3B0aW9ucz8pIHtcbiAgICB3aW5kb3dbREFTSEJPQVJEX0FQSV0ubWVzc2FnZVN2Yy5lcnJvcihjb250ZW50LCBvcHRpb25zKVxuICB9XG5cbiAgZ2V0RGF0YSAoZGF0YU9wdGlvbikge1xuICAgIHJldHVybiB3aW5kb3dbREFTSEJPQVJEX0FQSV0uc3RvcmFnZVN2Yy5nZXREYXRhKGRhdGFPcHRpb24pXG4gIH1cbiAgZ2V0VXNlckluZm8gKHJlbG9hZCA9IGZhbHNlKSB7XG4gICAgcmV0dXJuIHdpbmRvd1tEQVNIQk9BUkRfQVBJXS5zdG9yYWdlU3ZjLmdldFVzZXJJbmZvKHJlbG9hZClcbiAgfVxuICBnZXRVc2VyQXZhdGFyIChyZWxvYWQgPSBmYWxzZSkge1xuICAgIHJldHVybiB3aW5kb3dbREFTSEJPQVJEX0FQSV0uc3RvcmFnZVN2Yy5nZXRVc2VyQXZhdGFyKHJlbG9hZClcbiAgfVxuICAvKipcbiAgICogQGRlcHJlY2F0ZWQg5bqU55So5Y+m5aSW5Lik5LiqIGp1bXAg5pa55rOVXG4gICAqIOiBlOafpei3s+i9rO+8jOebtOaOpeaKiumFjee9ruWxnuaAp+eahOWAvOS8oOi/m+adpeWwseihjOOAgumFjeaIkOKAnOaXoOKAneWwseS4jei3s+i9rOOAglxuICAgKiBAcGFyYW0ganVtcFByb3BlcnR5IOi3s+i9rOeahOmFjee9ruWxnuaAp+eahOWAvFxuICAgKiBAcGFyYW0gZGF0YUl0ZW0g5b2T5YmN6Lez6L2s5a+55bqU55qE5pWw5o2u6KGM44CC5aaC5p6c5piv5YWo5bGA6Lez6L2s77yM5bCx5Lyg5YWl56ys5LiA6KGM77yfXG4gICAqL1xuICBqdW1wIChqdW1wUHJvcGVydHksIGRhdGFJdGVtPzogYW55KSB7XG4gICAgY29uc3QgeyB0eXBlLCBmdW5jSWQsIHBhcmFtcyB9ID0ganVtcFByb3BlcnR5XG4gICAgY29uc3QgcXVlcnlQYXJhbXNBcnJheSA9IEFycmF5LmlzQXJyYXkocGFyYW1zKVxuICAgICAgPyBwYXJhbXMubWFwKHBhcmFtID0+IFtwYXJhbS5rZXksIChwYXJhbS52YWx1ZVR5cGUgPT09ICdmaXhlZFZhbHVlJ1xuICAgICAgICA/IHBhcmFtLmZpeGVkVmFsdWVcbiAgICAgICAgOiAoZGF0YUl0ZW1cbiAgICAgICAgICA/IGRhdGFJdGVtW3BhcmFtLmZpZWxkTmFtZS5uYW1lXVxuICAgICAgICAgIDogdW5kZWZpbmVkXG4gICAgICAgIClcbiAgICAgICldKVxuICAgICAgOiB1bmRlZmluZWRcbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgSnVtcFR5cGVzLk5vbmU6XG4gICAgICAgIHJldHVyblxuICAgICAgY2FzZSBKdW1wVHlwZXMuRnVuYzpcbiAgICAgICAgdGhpcy5vcGVuTWVudShmdW5jSWQsIHF1ZXJ5UGFyYW1zQXJyYXkpXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlIEp1bXBUeXBlcy5DaGFydFRhYmxlOlxuICAgICAgICB0aGlzLm9wZW5NZW51KENIQVJUX1RBQkxFX0ZVTkNfSUQsIHF1ZXJ5UGFyYW1zQXJyYXkpXG4gICAgICAgIGJyZWFrXG4gICAgfVxuICB9XG4gIGp1bXBXaXRoRGF0YSAoZGF0YUp1bXBDb25maWc6IERhdGFKdW1wQ29uZmlnLCBkYXRhSXRlbTogYW55KSB7XG4gICAgY29uc3QgeyBqdW1wVHlwZSwgZnVuY0lkU291cmNlLCBmdW5jSWREYXRhRmllbGQsIGZ1bmNJZCwgZnVuY1BhcmFtcywgdXJsLCB1cmxQYXJhbXMsIHF1ZXJ5UGFyYW1zIH0gPSBkYXRhSnVtcENvbmZpZ1xuICAgIGNvbnN0IGZ1bmNQYXJhbXNBcnJheSA9IEFycmF5LmlzQXJyYXkoZnVuY1BhcmFtcylcbiAgICAgID8gZnVuY1BhcmFtcy5tYXAoZnVuY1BhcmFtID0+IFtmdW5jUGFyYW0ua2V5LCAoZnVuY1BhcmFtLnZhbHVlVHlwZSA9PT0gJ2ZpeGVkVmFsdWUnXG4gICAgICAgID8gZnVuY1BhcmFtLmZpeGVkVmFsdWVcbiAgICAgICAgOiAoZGF0YUl0ZW1cbiAgICAgICAgICA/IGRhdGFJdGVtW2Z1bmNQYXJhbS5maWVsZE5hbWUubmFtZV1cbiAgICAgICAgICA6IHVuZGVmaW5lZFxuICAgICAgICApXG4gICAgICApXSlcbiAgICAgIDogdW5kZWZpbmVkXG4gICAgc3dpdGNoIChqdW1wVHlwZSkge1xuICAgICAgY2FzZSBKdW1wVHlwZXMuTm9uZTpcbiAgICAgICAgcmV0dXJuXG4gICAgICBjYXNlIEp1bXBUeXBlcy5GdW5jOlxuICAgICAgICBjb25zdCByZXN1bHRGdW5jSWQgPVxuICAgICAgICAgICghZnVuY0lkU291cmNlIHx8IGZ1bmNJZFNvdXJjZT09PSdmaXhlZCcpXG4gICAgICAgICAgPyBmdW5jSWRcbiAgICAgICAgICA6IGRhdGFJdGVtW2Z1bmNJZERhdGFGaWVsZC5uYW1lXVxuICAgICAgICBpZiAocmVzdWx0RnVuY0lkKSB0aGlzLm9wZW5NZW51KHJlc3VsdEZ1bmNJZCwgZnVuY1BhcmFtc0FycmF5KVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSBKdW1wVHlwZXMuQ2hhcnRUYWJsZTpcbiAgICAgICAgdGhpcy5vcGVuTWVudShDSEFSVF9UQUJMRV9GVU5DX0lELCBmdW5jUGFyYW1zQXJyYXkpXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlIEp1bXBUeXBlcy5OZXdCcm93c2VyVGFiOlxuICAgICAgICAvLyDmi7wgdXJsXG4gICAgICAgIGxldCBmaW5hbFVybCA9IHVybFxuICAgICAgICAvLyArIHVybFBhcmFtc1xuICAgICAgICBpZiAodXJsUGFyYW1zICYmIHVybFBhcmFtcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgY29uc3QgdXJsUGFyYW1QYXJ0ID0gdXJsUGFyYW1zLm1hcCh1cmxQYXJhbSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IHZhbHVlVHlwZSwgZml4ZWRWYWx1ZSwgZmllbGROYW1lIH0gPSB1cmxQYXJhbVxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlVHlwZSA9PT0gJ2ZpeGVkVmFsdWUnID8gZml4ZWRWYWx1ZSA6IGRhdGFJdGVtW2ZpZWxkTmFtZS5uYW1lXVxuICAgICAgICAgIH0pLmpvaW4oJy8nKVxuICAgICAgICAgIGZpbmFsVXJsICs9IHVybC5lbmRzV2l0aCgnLycpID8gJycgOiAnLydcbiAgICAgICAgICBmaW5hbFVybCArPSB1cmxQYXJhbVBhcnRcbiAgICAgICAgfVxuICAgICAgICAvLyArIHF1ZXJ5UGFyYW1zXG4gICAgICAgIGlmIChxdWVyeVBhcmFtcyAmJiBxdWVyeVBhcmFtcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgY29uc3QgcXVlcnlQYXJhbVBhcnQgPSBxdWVyeVBhcmFtcy5tYXAocXVlcnlQYXJhbSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IGtleSwgdmFsdWVUeXBlLCBmaXhlZFZhbHVlLCBmaWVsZE5hbWUgfSA9IHF1ZXJ5UGFyYW1cbiAgICAgICAgICAgIHJldHVybiBgJHtrZXl9PSR7dmFsdWVUeXBlID09PSAnZml4ZWRWYWx1ZScgPyBmaXhlZFZhbHVlIDogZGF0YUl0ZW1bZmllbGROYW1lLm5hbWVdfWBcbiAgICAgICAgICB9KS5qb2luKCcmJylcbiAgICAgICAgICBmaW5hbFVybCArPSAnPycgKyBxdWVyeVBhcmFtUGFydFxuICAgICAgICB9XG4gICAgICAgIC8vIOaJk+W8gFxuICAgICAgICB3aW5kb3cub3BlbihmaW5hbFVybCwgJ19ibGFuaycpXG4gICAgfVxuICB9XG4gIGp1bXBXaXRob3V0RGF0YSAoZGF0YWxlc3NKdW1wQ29uZmlnOiBEYXRhbGVzc0p1bXBDb25maWcpIHtcbiAgICBjb25zdCB7IGp1bXBUeXBlLCBmdW5jSWQsIGZ1bmNQYXJhbXMsIHVybCB9ID0gZGF0YWxlc3NKdW1wQ29uZmlnXG4gICAgY29uc3QgZnVuY1BhcmFtc0FycmF5ID0gQXJyYXkuaXNBcnJheShmdW5jUGFyYW1zKVxuICAgICAgPyBmdW5jUGFyYW1zLm1hcChmdW5jUGFyYW0gPT4gW2Z1bmNQYXJhbS5rZXksIGZ1bmNQYXJhbS52YWx1ZV0pXG4gICAgICA6IHVuZGVmaW5lZFxuICAgIHN3aXRjaCAoanVtcFR5cGUpIHtcbiAgICAgIGNhc2UgSnVtcFR5cGVzLk5vbmU6XG4gICAgICAgIHJldHVyblxuICAgICAgY2FzZSBKdW1wVHlwZXMuRnVuYzpcbiAgICAgICAgdGhpcy5vcGVuTWVudShmdW5jSWQsIGZ1bmNQYXJhbXNBcnJheSlcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgSnVtcFR5cGVzLkNoYXJ0VGFibGU6XG4gICAgICAgIHRoaXMub3Blbk1lbnUoQ0hBUlRfVEFCTEVfRlVOQ19JRCwgZnVuY1BhcmFtc0FycmF5KVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSBKdW1wVHlwZXMuTmV3QnJvd3NlclRhYjpcbiAgICAgICAgd2luZG93Lm9wZW4odXJsLCAnX2JsYW5rJylcbiAgICB9XG4gIH1cblxufVxuIl19