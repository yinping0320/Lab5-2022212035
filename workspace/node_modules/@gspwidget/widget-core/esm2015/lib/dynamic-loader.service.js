/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { HttpClient } from '@angular/common/http';
import { ComponentFactoryResolver, Injectable, Injector } from '@angular/core';
import { WidgetContainerMode } from '@gspwidget/util';
import { appendScript } from '@gspwidget/util';
import { WidgetPropertyService, WidgetRegistry } from '@gspwidget/widget-devkit';
import * as AngularCommon from '@angular/common';
import * as AngularCommonHttp from '@angular/common/http';
import * as AngularCore from '@angular/core';
import * as AngularForms from '@angular/forms';
import * as AngularPlatformBrowser from '@angular/platform-browser';
import * as AngularPlatformBrowserAnimations from '@angular/platform-browser/animations';
import * as AngularPlatformBrowserDynamic from '@angular/platform-browser-dynamic';
import * as AngularRouter from '@angular/router';
import * as AngularAnimations from '@angular/animations';
import * as AngularAnimationsBrowser from '@angular/animations/browser';
import * as NgxTranslateCore from '@ngx-translate/core';
import * as NgxTranslateHttpLoader from '@ngx-translate/http-loader';
// import * as PortletModule from '@gspwidget/portlet';
import * as WidgetCoreModule from '../public-api';
import * as WidgetDevkitModule from '@gspwidget/widget-devkit';
import * as UtilModule from '@gspwidget/util';
import { IGIX_HOME_PATH } from '@gspwidget/util';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "@gspwidget/widget-devkit";
// import * as UtilModule from '@gspwidget/util';
// import * as GridsterModule from '@gspwidget/gridster';
// declare var System
/* iGIX 内 systemjs 暂时是 3.x */
if (!window.define) {
    appendScript(`${IGIX_HOME_PATH}assets/amd.6.js`);
}
/** @type {?} */
let sys;
export class DynamicLoaderService {
    /**
     * @param {?} injector
     * @param {?} http
     * @param {?} componentFactoryResolver
     * @param {?} widgetProperty
     */
    constructor(injector, http, componentFactoryResolver, widgetProperty) {
        this.injector = injector;
        this.http = http;
        this.componentFactoryResolver = componentFactoryResolver;
        this.widgetProperty = widgetProperty;
        /**
         * 为了避免 ng serve 时，webpack 会把 system.import
         * 拦截为自身的实现，无法满足现在的绝对地址加载
         */
        sys = window['System'];
        this.initSystemjsPromise = this.initSystemjs();
    }
    /**
     * @return {?}
     */
    initSystemjs() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            sys.set('lib:@angular/common', AngularCommon);
            sys.set('lib:@angular/common/http', AngularCommonHttp);
            sys.set('lib:@angular/core', AngularCore);
            sys.set('lib:@angular/forms', AngularForms);
            sys.set('lib:@angular/platform-browser', AngularPlatformBrowser);
            sys.set('lib:@angular/platform-browser/animations', AngularPlatformBrowserAnimations);
            sys.set('lib:@angular/platform-browser-dynamic', AngularPlatformBrowserDynamic);
            sys.set('lib:@angular/router', AngularRouter);
            sys.set('lib:@angular/animations', AngularAnimations);
            sys.set('lib:@angular/animations/browser', AngularAnimationsBrowser);
            sys.set('lib:@ngx-translate/core', NgxTranslateCore);
            sys.set('lib:@ngx-translate/http-loader', NgxTranslateHttpLoader);
            // sys.set('lib:@gspwidget/portlet', PortletModule)
            sys.set('lib:@gspwidget/widget-core', WidgetCoreModule);
            sys.set('lib:@gspwidget/widget-devkit', WidgetDevkitModule);
            sys.set('lib:@gspwidget/util', UtilModule);
            // sys.set('lib:@gspwidget/gridster', GridsterModule)
        });
    }
    /**
     * 加载元部件文件，并获取 widget 的详细信息供外面用
     * @param {?} widgetInfo
     * @param {?} rawPropValues
     * @param {?} mode
     * @return {?}
     */
    loadWidget(widgetInfo, rawPropValues, mode) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const { name: widgetName } = widgetInfo;
            /** @type {?} */
            let widgetCompFactory;
            /** @type {?} */
            let widgetModuleFactory;
            switch (mode) {
                case WidgetContainerMode.AOT:
                    // 加载 widget js 文件
                    yield this.initSystemjsPromise;
                    /** @type {?} */
                    const systemModule = yield sys.import(`${((/** @type {?} */ (widgetInfo))).href}?v=${widgetInfo.version}`);
                    this.fixCompFacError(systemModule);
                    // 加载完成后，获取 widget 的详细信息供外面用
                    widgetCompFactory = getWidgetComponentFactory(widgetName, systemModule);
                    widgetModuleFactory = getModuleFactoryAot(systemModule);
                    break;
                case WidgetContainerMode.DEV:
                    widgetCompFactory = this.componentFactoryResolver.resolveComponentFactory(((/** @type {?} */ (widgetInfo))).widgetComponent);
                    break;
            }
            /** @type {?} */
            const widgetConfig = WidgetRegistry.getWidgetByName(widgetName);
            /** @type {?} */
            const properties = this.widgetProperty.getWidgetProps(widgetName, widgetConfig);
            /** @type {?} */
            const propValues = this.widgetProperty.mixinWidgetPropValues(properties, rawPropValues);
            return {
                widgetCompFactory,
                widgetModuleFactory,
                properties,
                propValues,
                widgetConfig,
            };
        });
    }
    /**
     * TODO:
     * 白萌提的问题，去掉试试，拿他的元部件试试。怀疑是之前一直没传入 module 的原因。
     * 修复元部件依赖的第三方组件中 this.componentFactoryResolver.resolveComponentFactory
     * 找不到第三方组件的 ComponentFactory 的问题，
     * 如 nz RateComponent 找不到 toolTipComponent
     * @param {?} systemModule
     * @return {?}
     */
    fixCompFacError(systemModule) {
        Object.keys(systemModule)
            .filter((/**
         * @param {?} key
         * @return {?}
         */
        key => key.endsWith('ModuleNgFactory')))
            .forEach((/**
         * @param {?} key
         * @return {?}
         */
        key => {
            try {
                const { _factories } = systemModule[key].create(this.injector).componentFactoryResolver;
                _factories.forEach((/**
                 * @param {?} iFactory
                 * @return {?}
                 */
                iFactory => {
                    // @ts-ignore
                    this.componentFactoryResolver._factories.set(iFactory.componentType, iFactory);
                }));
            }
            catch (err) { }
        }));
    }
}
DynamicLoaderService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
/** @nocollapse */
DynamicLoaderService.ctorParameters = () => [
    { type: Injector },
    { type: HttpClient },
    { type: ComponentFactoryResolver },
    { type: WidgetPropertyService }
];
/** @nocollapse */ DynamicLoaderService.ngInjectableDef = i0.defineInjectable({ factory: function DynamicLoaderService_Factory() { return new DynamicLoaderService(i0.inject(i0.INJECTOR), i0.inject(i1.HttpClient), i0.inject(i0.ComponentFactoryResolver), i0.inject(i2.WidgetPropertyService)); }, token: DynamicLoaderService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    DynamicLoaderService.prototype.initSystemjsPromise;
    /**
     * @type {?}
     * @private
     */
    DynamicLoaderService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    DynamicLoaderService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    DynamicLoaderService.prototype.componentFactoryResolver;
    /**
     * @type {?}
     * @private
     */
    DynamicLoaderService.prototype.widgetProperty;
}
/**
 * @param {?} widgetName
 * @param {?} systemModule
 * @return {?}
 */
function getWidgetComponentFactory(widgetName, systemModule) {
    /** @type {?} */
    const componentType = WidgetRegistry.getWidgetByName(widgetName).ctor;
    if (componentType) {
        return Object.values(systemModule)
            .find((/**
         * @param {?} fac
         * @return {?}
         */
        (fac) => fac.componentType === componentType));
    }
}
/**
 * @param {?} systemModule
 * @return {?}
 */
function getModuleFactoryAot(systemModule) {
    /** @type {?} */
    const key = Object
        .keys(systemModule)
        .find((/**
     * @param {?} k
     * @return {?}
     */
    k => k.endsWith('ModuleNgFactory')));
    return (/** @type {?} */ (systemModule[key]));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1sb2FkZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bnc3B3aWRnZXQvd2lkZ2V0LWNvcmUvIiwic291cmNlcyI6WyJsaWIvZHluYW1pYy1sb2FkZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsd0JBQXdCLEVBQW9CLFVBQVUsRUFBRSxRQUFRLEVBQTBDLE1BQU0sZUFBZSxDQUFDO0FBQ3pJLE9BQU8sRUFBa0QsbUJBQW1CLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN0RyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDL0MsT0FBTyxFQUFFLHFCQUFxQixFQUFFLGNBQWMsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRWpGLE9BQU8sS0FBSyxhQUFhLE1BQU0saUJBQWlCLENBQUE7QUFDaEQsT0FBTyxLQUFLLGlCQUFpQixNQUFNLHNCQUFzQixDQUFBO0FBQ3pELE9BQU8sS0FBSyxXQUFXLE1BQU0sZUFBZSxDQUFBO0FBQzVDLE9BQU8sS0FBSyxZQUFZLE1BQU0sZ0JBQWdCLENBQUE7QUFDOUMsT0FBTyxLQUFLLHNCQUFzQixNQUFNLDJCQUEyQixDQUFBO0FBQ25FLE9BQU8sS0FBSyxnQ0FBZ0MsTUFBTSxzQ0FBc0MsQ0FBQTtBQUN4RixPQUFPLEtBQUssNkJBQTZCLE1BQU0sbUNBQW1DLENBQUE7QUFDbEYsT0FBTyxLQUFLLGFBQWEsTUFBTSxpQkFBaUIsQ0FBQTtBQUNoRCxPQUFPLEtBQUssaUJBQWlCLE1BQU0scUJBQXFCLENBQUE7QUFDeEQsT0FBTyxLQUFLLHdCQUF3QixNQUFNLDZCQUE2QixDQUFBO0FBQ3ZFLE9BQU8sS0FBSyxnQkFBZ0IsTUFBTSxxQkFBcUIsQ0FBQTtBQUN2RCxPQUFPLEtBQUssc0JBQXNCLE1BQU0sNEJBQTRCLENBQUE7O0FBRXBFLE9BQU8sS0FB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b0JBQ2IsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDakYsQ0FBQyxFQUFDLENBQUE7YUFDSDtZQUFDLE9BQU8sR0FBRyxFQUFFLEdBQUU7UUFDbEIsQ0FBQyxFQUFDLENBQUE7SUFDSixDQUFDOzs7WUE1RkYsVUFBVSxTQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRTs7OztZQWhDK0IsUUFBUTtZQURoRSxVQUFVO1lBQ1Ysd0JBQXdCO1lBR3hCLHFCQUFxQjs7Ozs7Ozs7SUFnQzVCLG1EQUEwQzs7Ozs7SUFFeEMsd0NBQTBCOzs7OztJQUMxQixvQ0FBd0I7Ozs7O0lBQ3hCLHdEQUEwRDs7Ozs7SUFDMUQsOENBQTZDOzs7Ozs7O0FBc0ZqRCxTQUFTLHlCQUF5QixDQUFFLFVBQWtCLEVBQUUsWUFBaUI7O1VBQ2pFLGFBQWEsR0FBRyxjQUFjLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUk7SUFDckUsSUFBSSxhQUFhLEVBQUU7UUFDakIsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQzthQUMvQixJQUFJOzs7O1FBQUMsQ0FBQyxHQUFRLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEtBQUssYUFBYSxFQUFDLENBQUE7S0FDM0Q7QUFDSCxDQUFDOzs7OztBQUNELFNBQVMsbUJBQW1CLENBQUUsWUFBaUI7O1VBQ3ZDLEdBQUcsR0FBRyxNQUFNO1NBQ2YsSUFBSSxDQUFDLFlBQVksQ0FBQztTQUNsQixJQUFJOzs7O0lBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDLEVBQUM7SUFDM0MsT0FBTyxtQkFBQSxZQUFZLENBQUMsR0FBRyxDQUFDLEVBQXdCLENBQUE7QUFDbEQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIGdldE1vZHVsZUZhY3RvcnksIEluamVjdGFibGUsIEluamVjdG9yLCBOZ01vZHVsZUZhY3RvcnksIE5nTW9kdWxlRmFjdG9yeUxvYWRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQmFzaWNXaWRnZXRJbmZvQW90TW9kZSwgQmFzaWNXaWRnZXRJbmZvRGV2TW9kZSwgV2lkZ2V0Q29udGFpbmVyTW9kZSB9IGZyb20gJ0Bnc3B3aWRnZXQvdXRpbCc7XG5pbXBvcnQgeyBhcHBlbmRTY3JpcHQgfSBmcm9tICdAZ3Nwd2lkZ2V0L3V0aWwnO1xuaW1wb3J0IHsgV2lkZ2V0UHJvcGVydHlTZXJ2aWNlLCBXaWRnZXRSZWdpc3RyeSB9IGZyb20gJ0Bnc3B3aWRnZXQvd2lkZ2V0LWRldmtpdCc7XG5cbmltcG9ydCAqIGFzIEFuZ3VsYXJDb21tb24gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJ1xuaW1wb3J0ICogYXMgQW5ndWxhckNvbW1vbkh0dHAgZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnXG5pbXBvcnQgKiBhcyBBbmd1bGFyQ29yZSBmcm9tICdAYW5ndWxhci9jb3JlJ1xuaW1wb3J0ICogYXMgQW5ndWxhckZvcm1zIGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJ1xuaW1wb3J0ICogYXMgQW5ndWxhclBsYXRmb3JtQnJvd3NlciBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJ1xuaW1wb3J0ICogYXMgQW5ndWxhclBsYXRmb3JtQnJvd3NlckFuaW1hdGlvbnMgZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlci9hbmltYXRpb25zJ1xuaW1wb3J0ICogYXMgQW5ndWxhclBsYXRmb3JtQnJvd3NlckR5bmFtaWMgZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlci1keW5hbWljJ1xuaW1wb3J0ICogYXMgQW5ndWxhclJvdXRlciBmcm9tICdAYW5ndWxhci9yb3V0ZXInXG5pbXBvcnQgKiBhcyBBbmd1bGFyQW5pbWF0aW9ucyBmcm9tICdAYW5ndWxhci9hbmltYXRpb25zJ1xuaW1wb3J0ICogYXMgQW5ndWxhckFuaW1hdGlvbnNCcm93c2VyIGZyb20gJ0Bhbmd1bGFyL2FuaW1hdGlvbnMvYnJvd3NlcidcbmltcG9ydCAqIGFzIE5neFRyYW5zbGF0ZUNvcmUgZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSdcbmltcG9ydCAqIGFzIE5neFRyYW5zbGF0ZUh0dHBMb2FkZXIgZnJvbSAnQG5neC10cmFuc2xhdGUvaHR0cC1sb2FkZXInXG4vLyBpbXBvcnQgKiBhcyBQb3J0bGV0TW9kdWxlIGZyb20gJ0Bnc3B3aWRnZXQvcG9ydGxldCc7XG5pbXBvcnQgKiBhcyBXaWRnZXRDb3JlTW9kdWxlIGZyb20gJy4uL3B1YmxpYy1hcGknO1xuaW1wb3J0ICogYXMgV2lkZ2V0RGV2a2l0TW9kdWxlIGZyb20gJ0Bnc3B3aWRnZXQvd2lkZ2V0LWRldmtpdCc7XG5pbXBvcnQgKiBhcyBVdGlsTW9kdWxlIGZyb20gJ0Bnc3B3aWRnZXQvdXRpbCc7XG5pbXBvcnQgeyBJR0lYX0hPTUVfUEFUSCB9IGZyb20gJ0Bnc3B3aWRnZXQvdXRpbCc7XG4vLyBpbXBvcnQgKiBhcyBVdGlsTW9kdWxlIGZyb20gJ0Bnc3B3aWRnZXQvdXRpbCc7XG4vLyBpbXBvcnQgKiBhcyBHcmlkc3Rlck1vZHVsZSBmcm9tICdAZ3Nwd2lkZ2V0L2dyaWRzdGVyJztcbi8vIGRlY2xhcmUgdmFyIFN5c3RlbVxuLyogaUdJWCDlhoUgc3lzdGVtanMg5pqC5pe25pivIDMueCAqL1xuaWYgKCF3aW5kb3cuZGVmaW5lKSB7XG4gIGFwcGVuZFNjcmlwdChgJHtJR0lYX0hPTUVfUEFUSH1hc3NldHMvYW1kLjYuanNgKVxufVxuXG5sZXQgc3lzXG5cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgRHluYW1pY0xvYWRlclNlcnZpY2Uge1xuXG4gIHByaXZhdGUgaW5pdFN5c3RlbWpzUHJvbWlzZTogUHJvbWlzZTx2b2lkPlxuICBjb25zdHJ1Y3RvciAoXG4gICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxuICAgIHByaXZhdGUgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgcHJpdmF0ZSB3aWRnZXRQcm9wZXJ0eTogV2lkZ2V0UHJvcGVydHlTZXJ2aWNlLFxuICAgICkge1xuICAgIC8qKlxuICAgICAqIOS4uuS6humBv+WFjSBuZyBzZXJ2ZSDml7bvvIx3ZWJwYWNrIOS8muaKiiBzeXN0ZW0uaW1wb3J0XG4gICAgICog5oum5oiq5Li66Ieq6Lqr55qE5a6e546w77yM5peg5rOV5ruh6Laz546w5Zyo55qE57ud5a+55Zyw5Z2A5Yqg6L29XG4gICAgICovXG4gICAgc3lzID0gd2luZG93WydTeXN0ZW0nXVxuICAgIHRoaXMuaW5pdFN5c3RlbWpzUHJvbWlzZSA9IHRoaXMuaW5pdFN5c3RlbWpzKClcbiAgfVxuICBhc3luYyBpbml0U3lzdGVtanMgKCkge1xuICAgIHN5cy5zZXQoJ2xpYjpAYW5ndWxhci9jb21tb24nLCBBbmd1bGFyQ29tbW9uKVxuICAgIHN5cy5zZXQoJ2xpYjpAYW5ndWxhci9jb21tb24vaHR0cCcsIEFuZ3VsYXJDb21tb25IdHRwKVxuICAgIHN5cy5zZXQoJ2xpYjpAYW5ndWxhci9jb3JlJywgQW5ndWxhckNvcmUpXG4gICAgc3lzLnNldCgnbGliOkBhbmd1bGFyL2Zvcm1zJywgQW5ndWxhckZvcm1zKVxuICAgIHN5cy5zZXQoJ2xpYjpAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJywgQW5ndWxhclBsYXRmb3JtQnJvd3NlcilcbiAgICBzeXMuc2V0KCdsaWI6QGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlci9hbmltYXRpb25zJywgQW5ndWxhclBsYXRmb3JtQnJvd3NlckFuaW1hdGlvbnMpXG4gICAgc3lzLnNldCgnbGliOkBhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXItZHluYW1pYycsIEFuZ3VsYXJQbGF0Zm9ybUJyb3dzZXJEeW5hbWljKVxuICAgIHN5cy5zZXQoJ2xpYjpAYW5ndWxhci9yb3V0ZXInLCBBbmd1bGFyUm91dGVyKVxuICAgIHN5cy5zZXQoJ2xpYjpAYW5ndWxhci9hbmltYXRpb25zJywgQW5ndWxhckFuaW1hdGlvbnMpXG4gICAgc3lzLnNldCgnbGliOkBhbmd1bGFyL2FuaW1hdGlvbnMvYnJvd3NlcicsIEFuZ3VsYXJBbmltYXRpb25zQnJvd3NlcilcbiAgICBzeXMuc2V0KCdsaWI6QG5neC10cmFuc2xhdGUvY29yZScsIE5neFRyYW5zbGF0ZUNvcmUpXG4gICAgc3lzLnNldCgnbGliOkBuZ3gtdHJhbnNsYXRlL2h0dHAtbG9hZGVyJywgTmd4VHJhbnNsYXRlSHR0cExvYWRlcilcblxuICAgIC8vIHN5cy5zZXQoJ2xpYjpAZ3Nwd2lkZ2V0L3BvcnRsZXQnLCBQb3J0bGV0TW9kdWxlKVxuICAgIHN5cy5zZXQoJ2xpYjpAZ3Nwd2lkZ2V0L3dpZGdldC1jb3JlJywgV2lkZ2V0Q29yZU1vZHVsZSlcbiAgICBzeXMuc2V0KCdsaWI6QGdzcHdpZGdldC93aWRnZXQtZGV2a2l0JywgV2lkZ2V0RGV2a2l0TW9kdWxlKVxuICAgIHN5cy5zZXQoJ2xpYjpAZ3Nwd2lkZ2V0L3V0aWwnLCBVdGlsTW9kdWxlKVxuICAgIC8vIHN5cy5zZXQoJ2xpYjpAZ3Nwd2lkZ2V0L2dyaWRzdGVyJywgR3JpZHN0ZXJNb2R1bGUpXG4gIH1cblxuICAvKipcbiAgICog5Yqg6L295YWD6YOo5Lu25paH5Lu277yM5bm26I635Y+WIHdpZGdldCDnmoTor6bnu4bkv6Hmga/kvpvlpJbpnaLnlKhcbiAgICovXG4gIGFzeW5jIGxvYWRXaWRnZXQgKFxuICAgIHdpZGdldEluZm86IEJhc2ljV2lkZ2V0SW5mb0FvdE1vZGUgfCBCYXNpY1dpZGdldEluZm9EZXZNb2RlLFxuICAgIHJhd1Byb3BWYWx1ZXM6IG9iamVjdCxcbiAgICBtb2RlOiBXaWRnZXRDb250YWluZXJNb2RlKSB7XG4gICAgY29uc3QgeyBuYW1lOiB3aWRnZXROYW1lIH0gPSB3aWRnZXRJbmZvXG4gICAgbGV0IHdpZGdldENvbXBGYWN0b3J5XG4gICAgbGV0IHdpZGdldE1vZHVsZUZhY3RvcnlcbiAgICBzd2l0Y2ggKG1vZGUpIHtcbiAgICAgIGNhc2UgV2lkZ2V0Q29udGFpbmVyTW9kZS5BT1Q6XG4gICAgICAgIC8vIOWKoOi9vSB3aWRnZXQganMg5paH5Lu2XG4gICAgICAgIGF3YWl0IHRoaXMuaW5pdFN5c3RlbWpzUHJvbWlzZVxuICAgICAgICBjb25zdCBzeXN0ZW1Nb2R1bGUgPSBhd2FpdCBzeXMuaW1wb3J0KGAkeyh3aWRnZXRJbmZvIGFzIEJhc2ljV2lkZ2V0SW5mb0FvdE1vZGUpLmhyZWZ9P3Y9JHt3aWRnZXRJbmZvLnZlcnNpb259YClcbiAgICAgICAgdGhpcy5maXhDb21wRmFjRXJyb3Ioc3lzdGVtTW9kdWxlKVxuICAgICAgICAvLyDliqDovb3lrozmiJDlkI7vvIzojrflj5Ygd2lkZ2V0IOeahOivpue7huS/oeaBr+S+m+WklumdoueUqFxuICAgICAgICB3aWRnZXRDb21wRmFjdG9yeSA9IGdldFdpZGdldENvbXBvbmVudEZhY3Rvcnkod2lkZ2V0TmFtZSwgc3lzdGVtTW9kdWxlKVxuICAgICAgICB3aWRnZXRNb2R1bGVGYWN0b3J5ID0gZ2V0TW9kdWxlRmFjdG9yeUFvdChzeXN0ZW1Nb2R1bGUpXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlIFdpZGdldENvbnRhaW5lck1vZGUuREVWOlxuICAgICAgICB3aWRnZXRDb21wRmFjdG9yeSA9IHRoaXMuY29tcG9uZW50RmFjdG9yeVJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KCh3aWRnZXRJbmZvIGFzIEJhc2ljV2lkZ2V0SW5mb0Rldk1vZGUpLndpZGdldENvbXBvbmVudClcbiAgICAgICAgYnJlYWtcbiAgICB9XG4gICAgY29uc3Qgd2lkZ2V0Q29uZmlnID0gV2lkZ2V0UmVnaXN0cnkuZ2V0V2lkZ2V0QnlOYW1lKHdpZGdldE5hbWUpXG4gICAgY29uc3QgcHJvcGVydGllcyA9IHRoaXMud2lkZ2V0UHJvcGVydHkuZ2V0V2lkZ2V0UHJvcHMod2lkZ2V0TmFtZSwgd2lkZ2V0Q29uZmlnKVxuICAgIGNvbnN0IHByb3BWYWx1ZXMgPSB0aGlzLndpZGdldFByb3BlcnR5Lm1peGluV2lkZ2V0UHJvcFZhbHVlcyhwcm9wZXJ0aWVzLCByYXdQcm9wVmFsdWVzKVxuICAgIHJldHVybiB7XG4gICAgICB3aWRnZXRDb21wRmFjdG9yeSxcbiAgICAgIHdpZGdldE1vZHVsZUZhY3RvcnksXG4gICAgICBwcm9wZXJ0aWVzLFxuICAgICAgcHJvcFZhbHVlcyxcbiAgICAgIHdpZGdldENvbmZpZyxcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIFRPRE86XG4gICAqIOeZveiQjOaPkOeahOmXrumimO+8jOWOu+aOieivleivle+8jOaLv+S7lueahOWFg+mDqOS7tuivleivleOAguaAgOeWkeaYr+S5i+WJjeS4gOebtOayoeS8oOWFpSBtb2R1bGUg55qE5Y6f5Zug44CCXG4gICAqIOS/ruWkjeWFg+mDqOS7tuS+nei1lueahOesrOS4ieaWuee7hOS7tuS4rSB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeVxuICAgKiDmib7kuI3liLDnrKzkuInmlrnnu4Tku7bnmoQgQ29tcG9uZW50RmFjdG9yeSDnmoTpl67popjvvIxcbiAgICog5aaCIG56IFJhdGVDb21wb25lbnQg5om+5LiN5YiwIHRvb2xUaXBDb21wb25lbnRcbiAgICovXG4gIGZpeENvbXBGYWNFcnJvciAoc3lzdGVtTW9kdWxlKSB7XG4gICAgT2JqZWN0LmtleXMoc3lzdGVtTW9kdWxlKVxuICAgIC5maWx0ZXIoa2V5ID0+IGtleS5lbmRzV2l0aCgnTW9kdWxlTmdGYWN0b3J5JykpXG4gICAgLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHsgX2ZhY3RvcmllcyB9ID0gc3lzdGVtTW9kdWxlW2tleV0uY3JlYXRlKHRoaXMuaW5qZWN0b3IpLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlclxuICAgICAgICBfZmFjdG9yaWVzLmZvckVhY2goaUZhY3RvcnkgPT4ge1xuICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5fZmFjdG9yaWVzLnNldChpRmFjdG9yeS5jb21wb25lbnRUeXBlLCBpRmFjdG9yeSk7XG4gICAgICAgIH0pXG4gICAgICB9IGNhdGNoIChlcnIpIHt9XG4gICAgfSlcbiAgfVxufVxuZnVuY3Rpb24gZ2V0V2lkZ2V0Q29tcG9uZW50RmFjdG9yeSAod2lkZ2V0TmFtZTogc3RyaW5nLCBzeXN0ZW1Nb2R1bGU6IGFueSk6IGFueSB7XG4gIGNvbnN0IGNvbXBvbmVudFR5cGUgPSBXaWRnZXRSZWdpc3RyeS5nZXRXaWRnZXRCeU5hbWUod2lkZ2V0TmFtZSkuY3RvclxuICBpZiAoY29tcG9uZW50VHlwZSkge1xuICAgIHJldHVybiBPYmplY3QudmFsdWVzKHN5c3RlbU1vZHVsZSlcbiAgICAgIC5maW5kKChmYWM6IGFueSkgPT4gZmFjLmNvbXBvbmVudFR5cGUgPT09IGNvbXBvbmVudFR5cGUpXG4gIH1cbn1cbmZ1bmN0aW9uIGdldE1vZHVsZUZhY3RvcnlBb3QgKHN5c3RlbU1vZHVsZTogYW55KSB7XG4gIGNvbnN0IGtleSA9IE9iamVjdFxuICAgIC5rZXlzKHN5c3RlbU1vZHVsZSlcbiAgICAuZmluZChrID0+IGsuZW5kc1dpdGgoJ01vZHVsZU5nRmFjdG9yeScpKVxuICByZXR1cm4gc3lzdGVtTW9kdWxlW2tleV0gYXMgTmdNb2R1bGVGYWN0b3J5PGFueT5cbn1cbiJdfQ==