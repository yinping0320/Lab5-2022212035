!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("ng-zorro-antd/auto-complete"),require("ngx-bootstrap/accordion"),require("ngx-color-picker"),require("ng-zorro-antd/modal"),require("resize-observer-polyfill"),require("rxjs/operators"),require("@angular/common/http"),require("@angular/platform-browser"),require("@angular/platform-browser/animations"),require("@angular/platform-browser-dynamic"),require("@angular/router"),require("@angular/animations"),require("@angular/animations/browser"),require("@ngx-translate/http-loader"),require("@gspwidget/util"),require("@gspwidget/widget-devkit"),require("@ngx-translate/core"),require("@angular/forms"),require("ng-zorro-antd/date-picker"),require("@angular/common"),require("@angular/core"),require("ng-zorro-antd/dropdown"),require("ng-zorro-antd/select"),require("ng-zorro-antd/input")):"function"==typeof define&&define.amd?define("@gspwidget/widget-core",["exports","ng-zorro-antd/auto-complete","ngx-bootstrap/accordion","ngx-color-picker","ng-zorro-antd/modal","resize-observer-polyfill","rxjs/operators","@angular/common/http","@angular/platform-browser","@angular/platform-browser/animations","@angular/platform-browser-dynamic","@angular/router","@angular/animations","@angular/animations/browser","@ngx-translate/http-loader","@gspwidget/util","@gspwidget/widget-devkit","@ngx-translate/core","@angular/forms","ng-zorro-antd/date-picker","@angular/common","@angular/core","ng-zorro-antd/dropdown","ng-zorro-antd/select","ng-zorro-antd/input"],t):t((e.gspwidget=e.gspwidget||{},e.gspwidget["widget-core"]={}),e.autoComplete,e.accordion,e.ngxColorPicker,e.modal,e.ResizeObserver,e.rxjs.operators,e.ng.common.http,e.ng.platformBrowser,e.ng.platformBrowser.animations,e.ng.platformBrowserDynamic,e.ng.router,e.ng.animations,e.ng.animations.browser,e.NgxTranslateHttpLoader,e.UtilModule,e.WidgetDevkitModule,e.NgxTranslateCore,e.ng.forms,e.datePicker,e.ng.common,e.ng.core,e.dropdown,e.select,e.input)}(this,function(e,t,n,i,r,a,c,o,s,l,u,d,g,p,h,f,m,v,y,w,C,I,b,x,z){"use strict";a=a&&a.hasOwnProperty("default")?a["default"]:a;var F,S=Object.freeze({get WidgetCoreModule(){return ie},get WCStatus(){return _},get WidgetComponent(){return q},get DynamicLoaderService(){return D},get FilterModule(){return te},get FilterComponent(){return G},get ColValuesPipe(){return Y},get isWidgetRuntimeAggActive(){return N},get chartAggFieldMap(){return V},get FlatSelectComponent(){return K},get FlatSelectModule(){return Z},get TitleBarComponent(){return $},get InstanceService(){return A}});function E(t,o,s,l){return new(s=s||Promise)(function(e,n){function i(e){try{a(l.next(e))}catch(t){n(t)}}function r(e){try{a(l["throw"](e))}catch(t){n(t)}}function a(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(i,r)}a((l=l.apply(t,o||[])).next())})}function M(i,r){var a,o,s,e,l={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),"throw":t(1),"return":t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function n(e){if(a)throw new TypeError("Generator is already executing.");for(;l;)try{if(a=1,o&&(s=2&e[0]?o["return"]:e[0]?o["throw"]||((s=o["return"])&&s.call(o),0):o.next)&&!(s=s.call(o,e[1])).done)return s;switch(o=0,s&&(e=[2&e[0],s.value]),e[0]){case 0:case 1:s=e;break;case 4:return l.label++,{value:e[1],done:!1};case 5:l.label++,o=e[1],e=[0];continue;case 7:e=l.ops.pop(),l.trys.pop();continue;default:if(!(s=0<(s=l.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){l=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3])){l.label=e[1];break}if(6===e[0]&&l.label<s[1]){l.label=s[1],s=e;break}if(s&&l.label<s[2]){l.label=s[2],l.ops.push(e);break}s[2]&&l.ops.pop(),l.trys.pop();continue}e=r.call(i,l)}catch(t){e=[6,t],o=0}finally{a=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([t,e])}}}window.define||f.appendScript(f.IGIX_HOME_PATH+"assets/amd.6.js");var D=(R.prototype.initSystemjs=function(){return E(this,void 0,void 0,function(){return M(this,function(e){return F.set("lib:@angular/common",C),F.set("lib:@angular/common/http",o),F.set("lib:@angular/core",I),F.set("lib:@angular/forms",y),F.set("lib:@angular/platform-browser",s),F.set("lib:@angular/platform-browser/animations",l),F.set("lib:@angular/platform-browser-dynamic",u),F.set("lib:@angular/router",d),F.set("lib:@angular/animations",g),F.set("lib:@angular/animations/browser",p),F.set("lib:@ngx-translate/core",v),F.set("lib:@ngx-translate/http-loader",h),F.set("lib:@gspwidget/widget-core",S),F.set("lib:@gspwidget/widget-devkit",m),F.set("lib:@gspwidget/util",f),[2]})})},R.prototype.loadWidget=function(u,d,g){return E(this,void 0,void 0,function(){var t,r,a,o,s,l,c;return M(this,function(e){switch(e.label){case 0:switch(t=u.name,g){case f.WidgetContainerMode.AOT:return[3,1];case f.WidgetContainerMode.DEV:return[3,4]}return[3,5];case 1:return[4,this.initSystemjsPromise];case 2:return e.sent(),[4,F["import"](u.href+"?v="+u.version)];case 3:return o=e.sent(),this.fixCompFacError(o),r=function i(e,t){var n=m.WidgetRegistry.getWidgetByName(e).ctor;if(n)return Object.values(t).find(function(e){return e.componentType===n})}(t,o),a=function n(e){var t=Object.keys(e).find(function(e){return e.endsWith("ModuleNgFactory")});return e[t]}(o),[3,5];case 4:return r=this.componentFactoryResolver.resolveComponentFactory(u.widgetComponent),[3,5];case 5:return s=m.WidgetRegistry.getWidgetByName(t),l=this.widgetProperty.getWidgetProps(t,s),c=this.widgetProperty.mixinWidgetPropValues(l,d),[2,{widgetCompFactory:r,widgetModuleFactory:a,properties:l,propValues:c,widgetConfig:s}]}})})},R.prototype.fixCompFacError=function(n){var i=this;Object.keys(n).filter(function(e){return e.endsWith("ModuleNgFactory")}).forEach(function(e){try{n[e].create(i.injector).componentFactoryResolver._factories.forEach(function(e){i.componentFactoryResolver._factories.set(e.componentType,e)})}catch(t){}})},R.decorators=[{type:I.Injectable,args:[{providedIn:"root"}]}],R.ctorParameters=function(){return[{type:I.Injector},{type:o.HttpClient},{type:I.ComponentFactoryResolver},{type:m.WidgetPropertyService}]},R.ngInjectableDef=I.defineInjectable({factory:function(){return new R(I.inject(I.INJECTOR),I.inject(o.HttpClient),I.inject(I.ComponentFactoryResolver),I.inject(m.WidgetPropertyService))},token:R,providedIn:"root"}),R);function R(e,t,n,i){this.injector=e,this.http=t,this.componentFactoryResolver=n,this.widgetProperty=i,F=window.System,this.initSystemjsPromise=this.initSystemjs()}var A=(W.prototype.getInsByPInsId=function(e){return this.instances[e]},W.prototype.addInsInfo=function(e,t,n){e||console.warn("ins id 为空"),this.instances[e]||(this.instances[e]={}),this.instances[e][n]=t},W.decorators=[{type:I.Injectable,args:[{providedIn:"root"}]}],W.ctorParameters=function(){return[]},W.ngInjectableDef=I.defineInjectable({factory:function(){return new W},token:W,providedIn:"root"}),W);function W(){this.instances={}}function T(e,t){return j(t,e.dimensions[0])}function k(e,t){return j(t,e.indicators[0].dimName)}function O(r){return void 0===r&&(r=!1),[{name:"yFieldObjs",valueFactory:function(e,n){var i=e.indicators;return i.map(function(e,t){return{valueField:j(n,e.dimName),color:r?f.PlThemeColors.pure[t%i.length]:f.PlThemeColors.gradient[t%i.length]}})}},{name:"categoryFieldName",valueFactory:T}]}var P=[{name:"categoryFieldName",valueFactory:T},{name:"valueFieldName",valueFactory:k}],V={stack:O(),area:O(!0),"bar-group":O(),"widget-line":O(!0),bar:P,pie:P,pie2:P,"bar-horizontal":P,"simple-line":P,"bar-multiple":[{categoryFieldName:T,valueFieldNameOne:k,valueFieldNameTwo:function(e,t){return j(t,e.indicators[1].dimName)}}]};function j(e,t){var n=e.find(function(e){return e.name===t});return{name:n.name,label:n.label}}function N(e){return Object.keys(V).includes(e)}var L=[],_={LoadingWidget:0,LoadingData:1,DataEmpty:2,Normal:3,DataError:4,WidgetLoadError:5};_[_.LoadingWidget]="LoadingWidget",_[_.LoadingData]="LoadingData",_[_.DataEmpty]="DataEmpty",_[_.Normal]="Normal",_[_.DataError]="DataError",_[_.WidgetLoadError]="WidgetLoadError",f.loadCommonStyleNTheme();var q=(B.prototype._initWidgetEnv=function(){var t=this;if(this.translate.defaultLang||this.translate.setDefaultLang("zh-CHS"),!this.translate.currentLang){var e=localStorage.getItem("languageCode")||"zh-CHS";this.translate.use(e||"zh-CHS")}if(!window.widgetI18nResLoaded){var n=this.translate.currentLang;this.http.get(f.IGIX_HOME_PATH+"assets/i18n/"+n+".json").subscribe(function(e){t.translate.setTranslation(n,e,!0)}),window.widgetI18nResLoaded=!0}},B.prototype.ngOnInit=function(){var r=this;this.insSerivce.addInsInfo(this.instanceId,this,"widgetComp"),this.resizeTarget&&new a(function(e){var t=e[0].contentRect,n=t.width,i=t.height;r.widgetInstance&&r.widgetInstance.onResized(n,i),r.width=n,r.height=i,r.cd.markForCheck()}).observe(this.resizeTarget.nativeElement)},B.prototype.ngOnChanges=function(e){var t=e.basicWidgetInfo;t&&t.currentValue&&t.currentValue!==t.previousValue&&this.renderWidget()},B.prototype.triggerWidgetResize=function(){if(this.widgetInstance&&this.widgetInstance.onResized){var e=this.resizeTarget.nativeElement,t=e.clientWidth,n=e.clientHeight;this.widgetInstance.onResized(t,n)}},B.prototype.setPropertyValue=function(e,t){if("__extra"!==e&&("object"==typeof t||this.widgetInstance[e]!==t)){var n=this.processPV(t);this.widgetInstance[e]=n,this.widgetInstance.onPropertyChange&&this.widgetInstance.onPropertyChange(e,n),e===m.FILTER_PROP_NAME&&(this.dpValues=t.filter(function(e){return e.dpId}).map(function(e){return{value:m.FilterSchema.getDefaultValue(e.fs),dpId:e.dpId}})),this.propValues||(this.propValues={}),this.propValues[e]=t,this.cd.markForCheck()}},B.prototype.processPV=function(e){var t=this.translate.currentLang;try{e=JSON.parse(JSON.stringify(e))}catch(n){}return function i(n){return Array.isArray(n)?(n.forEach(function(e,t){n[t]=i(e)}),n):n&&!n._notProcess&&"string"==typeof(n.en+n["zh-CHS"]+n[t])?n[t]:n&&"help"===n.__type?n.value:(n&&["Object"].includes(n.constructor.name)&&Object.keys(n).forEach(function(e){n[e]=i(n[e])}),n)}(e)},B.prototype.renderWidget=function(){return E(this,void 0,void 0,function(){var t,n,i,r,a,o,s,l=this;return M(this,function(e){switch(e.label){case 0:return t=this.basicWidgetInfo.baseUrl,[4,this.loader.loadWidget(this.basicWidgetInfo,this.propValues,this.mode)];case 1:return n=e.sent(),i=n.widgetCompFactory,r=n.widgetModuleFactory,a=n.propValues,o=n.widgetConfig,this.curWidgetConfig=o,this.initRuntimeAgg(),this.curWidgetConfig.enableLoadingI18n&&this.loadI18nRes(),this.widgetLoaded.emit(n),this.widgetContainer.remove(),s=I.Injector.create({providers:[{provide:m.WidgetInstanceInfo,useValue:new m.WidgetInstanceInfo(this.portlet.id,this.instanceId,this.assetsBaseUrl||this.basicWidgetInfo.baseUrl+"/assets/")},{provide:m.WidgetDataService,useFactory:function(){return l.widgetDataService=new m.WidgetDataService,l.widgetDataService.onLoadData.pipe(c.delay(0)).subscribe(l.loadNSetData.bind(l)),l.widgetDataService},deps:[]}],parent:this.injector}),this.widgetInstance=this.widgetContainer.createComponent(i,0,s,undefined,r&&r.create(this.injector)).instance,Object.keys(a).forEach(function(e){l.setPropertyValue(e,a[e])}),this.widgetInstance.id=this.instanceId,this.widgetInstance.portletId=this.portlet.id,this.widgetInstance.assetsBaseUrl=this.assetsBaseUrl||t+"/assets/",this.widgetInstance.useDataEngine&&this.loadNSetData({}),this.initWidgetEventListener(),this.widgetInit.emit(n),this.status=_.Normal,this.cd.markForCheck(),[2]}})})},B.prototype.loadI18nRes=function(){var t=this,n=this.translate.currentLang,e=this.basicWidgetInfo,i=e.name,r=e.baseUrl,a=this.curWidgetConfig.customI18nResourceUrl||r+"/assets/i18n/"+n+".json";if(!L.includes(a))return L.push(a),this.http.get(a).toPromise().then(function(e){t.translate.setTranslation(n,e,!0)},function(){console.log("元部件 "+i+" 无 "+n+" 的资源文件")})["finally"](function(){return Promise.resolve()})},B.prototype.loadNSetData=function(e){var t=this;void 0===e&&(e={});var n=this.getData({dpValues:function i(e,t){void 0===e&&(e=[]),void 0===t&&(t=[]);var n=e.slice();return H(n,t),n}(this.dpValues,e.dpValues),runtimeAgg:this.runtimeAgg});n&&n.subscribe(function(e){t.setData(e)},this.handleDataError.bind(this))},B.prototype.setData=function(e){var t=e;e&&e.tableData&&0!==e.tableData.length||(this.status=_.DataEmpty),!e.dimensions&&e.length&&(t={dimensions:Object.keys(e[0]).map(function(e){return{name:e,label:e}}),tableData:e}),this.status=_.Normal,this.data=t.tableData,this.dims=t.dimensions,this.widgetDataService&&this.widgetDataService.setData(t),this.widgetInstance&&this.widgetInstance.useDataEngine&&this.widgetInstance.onGetData(t.tableData),this.setRuntimeAggDims(),this.cd.markForCheck()},B.prototype.handleClickStatusMore=function(){this.modal.error({nzTitle:"小部件错误",nzContent:"此小部件的数据配置无效，需要管理员重新配置或删除。"})},B.prototype.handleFilterChange=function(e){H(this.dpValues,e),this.loadNSetData()},B.prototype.handleRuntimeAggChange=function(e){this.runtimeAgg=e,this.runtimeAggChange.emit(e),this.loadNSetData()},B.prototype.handleTitleBarInit=function(e){this.showRuntimeAgg&&e.setRuntimeAgg(this.runtimeAgg)},B.prototype.initRuntimeAgg=function(){this.showRuntimeAgg=N(this.basicWidgetInfo.name),this.showRuntimeAgg&&(this.runtimeAgg=this.propValues.__extra?this.propValues.__extra.runtimeAgg:null)},B.prototype.initWidgetEventListener=function(){var t=this;this.linkMap&&(this.amIFilterWidget()?this.initOneEventListener(f.FILTERS_WIDGET_PROP_NAME):this.widgetEventService.getEventsByWidgetName(this.basicWidgetInfo.name,this.propValues).forEach(function(e){t.initOneEventListener(e.propName)}))},B.prototype.initOneEventListener=function(t){var r=this,e=this.widgetInstance[t];e&&e.subscribe(function(n){console.log("联动事件触发，参数："+n);var e=r.amIFilterWidget()?n.eventKey:t,i=r.linkMap[e];Object.keys(i).forEach(function(e){if(i[e]&&i[e].active&&i[e].dpId){var t=r.insSerivce.getInsByPInsId(e).widgetComp;t&&t.loadNSetData({dpValues:[{dpId:i[e].dpId,value:String(n.dataIndex)}]})}})})},B.prototype.setRuntimeAggDims=function(){var t=this;this.runtimeAgg&&V[this.basicWidgetInfo.name].forEach(function(e){t.setPropertyValue(e.name,e.valueFactory(t.runtimeAgg,t.dims))})},B.prototype.amIFilterWidget=function(){return this.basicWidgetInfo.name===f.FILTERS_WIDGET_NAME&&this.basicWidgetInfo.baseUrl.includes("/epp/")},B.decorators=[{type:I.Component,args:[{selector:"lib-widget",template:'<div\n  #resizeTarget\n  class="wc-wrapper h-100 overflow-hidden position-relative">\n  \x3c!-- TODO: 增加公共的加载遮罩层，数据服务加载时、部件内调用时、部件本身加载都用它 --\x3e\n  \x3c!-- loading --\x3e\n  <div\n    *ngIf="[WCStatus.LoadingWidget, WCStatus.LoadingData].includes(status)"\n    class="h-100 d-flex justify-content-center align-items-center">\n    <div class="text-center">\n      <i class="spin-ball loading-color material-icons">public</i>\n      <div class="fs-12 loading-color">{{\'部件加载中\' | trans}}</div>\n    </div>\n  </div>\n\n  \x3c!-- TODO: 部件加载失败。怎么统一处理这几种异常状态？ --\x3e\n  \x3c!-- <div\n    *ngIf="status === WCStatus.WidgetLoadError">\n  </div> --\x3e\n\n  \x3c!-- 无数据 --\x3e\n  <div\n    *ngIf="status === WCStatus.DataEmpty"\n    class="flex-fill no-data h-100 w-100 d-flex flex-column">\n    <lib-title-bar\n      *ngIf="curWidgetConfig?.enableCommonTitleBar\n        && widgetInstance\n        && !widgetInstance[\'titleBarHide\']"\n      [title]="portlet.name"\n      [showRefresh]="widgetInstance[\'titleBarShowRefresh\']"\n      [jumpConfig]="widgetInstance[\'titleBarJump\']"\n      ></lib-title-bar>\n    <div class="flex-fill d-flex flex-column justify-content-center align-items-center">\n      <img src="{{IGIX_HOME_PATH}}assets/img/data-empty.svg" style="transform:translateY(-5px)" alt="">\n      <div class="fs-13" style="color:gray">{{\'noDataAvailable\'|translate}}</div>\n    </div>\n  </div>\n\n  \x3c!-- abnormal --\x3e\n  <div class="d-flex flex-column overflow-hidden h-100"\n    *ngIf="status === WCStatus.DataError">\n    <div class="portlet-title text-truncate flex-shrink-0">{{this.portlet.name}}</div>\n    <div class="status-layer cursor-pointer flex-fill"\n      (click)="handleClickStatusMore()">\n      <ng-container *ngIf="status === WCStatus.DataError">\n        <img src="{{IGIX_HOME_PATH}}assets/img/data-error.svg" alt="">\n        <div class="error-tip fs-12 text-truncate">\n          部件数据加载失败，\n          <span class="theme-color more">查看详情</span>\n        </div>\n      </ng-container>\n    </div>\n  </div>\n\n  \x3c!-- normal --\x3e\n  \x3c!-- *ngIf="status === WCStatus.Normal" --\x3e\n  <div\n    class="h-100 d-flex flex-column">\n    \x3c!-- TODO: 重构 DOM 结构，把 title bar 放在公共位置 --\x3e\n    \x3c!-- 公共 title bar --\x3e\n    <lib-title-bar\n      #titleBar\n      *ngIf="curWidgetConfig?.enableCommonTitleBar\n        && widgetInstance\n        && !widgetInstance[\'titleBarHide\']"\n      [title]="portlet.name"\n      [showRefresh]="widgetInstance[\'titleBarShowRefresh\']"\n      [jumpConfig]="widgetInstance[\'titleBarJump\']"\n      [filterConfigs]="propValues[FILTER_PROP_NAME] || []"\n      [dims]="dims"\n      (clickRefresh)="loadNSetData()"\n      (filterChange)="handleFilterChange($event)"\n      (init)="handleTitleBarInit($event)"\n      [showRuntimeAgg]="showRuntimeAgg"\n      (runtimeAggChange)="handleRuntimeAggChange($event)"\n      >\n    </lib-title-bar>\n    <div class="flex-fill overflow-hidden" >\n      <ng-container #wc></ng-container>\n    </div>\n  </div>\n</div>\n',styles:[".portlet-title{font-weight:700;padding:12px 20px 10px}.status-layer{width:100%;display:flex;align-items:center;justify-content:center;z-index:1;flex-direction:column}.status-layer img{width:75%;max-width:200px}.status-layer .error-tip{color:#666;margin:5px 0}.status-layer .error-tip .more{text-decoration:underline}.no-data{position:absolute;top:0;background:#fff}::ng-deep .widget-title-bar .left{overflow:hidden}::ng-deep .widget-title-bar .left .title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.loading-color{color:#b2bac4}.spin-ball{font-size:30px}"]}]}],B.ctorParameters=function(){return[{type:D},{type:I.ChangeDetectorRef},{type:I.Injector},{type:r.NzModalService},{type:o.HttpClient},{type:v.TranslateService},{type:m.WidgetPropertyService},{type:m.WidgetEventService},{type:A}]},B.propDecorators={basicWidgetInfo:[{type:I.Input}],propValues:[{type:I.Input}],linkMap:[{type:I.Input}],mode:[{type:I.Input}],assetsBaseUrl:[{type:I.Input}],portlet:[{type:I.Input}],instanceId:[{type:I.Input}],getData:[{type:I.Input}],status:[{type:I.Input}],widgetLoaded:[{type:I.Output}],widgetInit:[{type:I.Output}],runtimeAggChange:[{type:I.Output}],resizeTarget:[{type:I.ViewChild,args:["resizeTarget"]}],widgetContainer:[{type:I.ViewChild,args:["wc",{read:I.ViewContainerRef}]}],titleBar:[{type:I.ViewChild,args:["titleBar"]}]},B);function B(e,t,n,i,r,a,o,s,l){var c=this;this.loader=e,this.cd=t,this.injector=n,this.modal=i,this.http=r,this.translate=a,this.widgetPropertyService=o,this.widgetEventService=s,this.insSerivce=l,this.mode=f.WidgetContainerMode.AOT,this.portlet=new f.EppPortlet(null),this.status=_.LoadingWidget,this.widgetLoaded=new I.EventEmitter,this.widgetInit=new I.EventEmitter,this.runtimeAggChange=new I.EventEmitter,this.WCStatus=_,this.IGIX_HOME_PATH=f.IGIX_HOME_PATH,this.FILTER_PROP_NAME=m.FILTER_PROP_NAME,this.data=null,this.showRuntimeAgg=!1,this.dpValues=[],this.handleDataError=function(){c.status=_.DataError,c.cd.markForCheck()},this._initWidgetEnv()}function H(n,e){function t(t){var e=n.find(function(e){return e.dpId===t.dpId});e?e.value=t.value:n.push(t)}var i,r;try{for(var a=function s(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}(e.filter(function(e){return e.dpId})),o=a.next();!o.done;o=a.next()){t(o.value)}}catch(l){i={error:l}}finally{try{o&&!o.done&&(r=a["return"])&&r.call(a)}finally{if(i)throw i.error}}}var $=(U.prototype.ngOnInit=function(){this.init.emit(this)},U.prototype.ngOnChanges=function(e){if(e.filterConfigs){this.outerFC=null,this.innerFCs=null;var t=this.filterConfigs.filter(function(e){return!m.isFsFlat(e.fs)});t&&t[0]&&(this.outerFC=t[0]),t&&1<t.length&&(this.innerFCs=t.slice(1)),this.flatFCs=this.filterConfigs.filter(function(e){return m.isFsFlat(e.fs)})}},U.prototype.setRuntimeAgg=function(e){e&&(this.editingRuntimeAgg=f.deepClone(e),this.confirmedRuntimeAgg=f.deepClone(e))},U.prototype.handleClickJump=function(){this.devkitSvc.jumpWithoutData(this.jumpConfig)},U.prototype.handleFilterSingleChange=function(e,t){this.filterChange.emit([{value:e,dpId:t.dpId}])},U.prototype.handleFilterMultiChange=function(e,t){var n;n=m.ifFsDateRange(t.fs)?[{value:e[0],dpId:t.dpId},{value:e[1],dpId:t.dpId2}]:[{value:e.join(","),dpId:t.dpId}],this.filterChange.emit(n)},U.prototype.handleAddInd=function(){this.editingRuntimeAgg.indicators.push(new f.Indicator)},U.prototype.handleRemoveInd=function(e){f.ArrUtil.Remove(this.editingRuntimeAgg.indicators,e)},U.prototype.handleConfirmAgg=function(){this.runtimeAggDropdownOpen=!1,f.objectLiteralEqual(this.editingRuntimeAgg,this.confirmedRuntimeAgg)||(this.confirmedRuntimeAgg=f.deepClone(this.editingRuntimeAgg),this.runtimeAggChange.emit(this.confirmedRuntimeAgg))},U.decorators=[{type:I.Component,args:[{selector:"lib-title-bar",template:'\x3c!-- --{{filterSchemas | json}}-- --\x3e\n\x3c!-- TODO: 所有其他 filter 收起到 dropdown 里 --\x3e\n\x3c!-- <div class="d-flex">\n  <filter\n    *ngFor="let fc of filterConfigs"\n    [filterSchema]="fc.fs"\n    (singleValueChange)="handleFilterSingleChange($event, fc)"\n    (multiValueChange)="handleFilterMultiChange($event, fc)"\n    ></filter>\n</div> --\x3e\n<div class="title-bar">\n  <div class="d-flex">\n    \x3c!-- left --\x3e\n    <div class="left align-items-center">\n      <i *ngIf="icon!=\'\'" class="material-icons">{{icon}}</i>\n      <div *ngIf="showTitle" class="title">{{title}}</div>\n      <div *ngIf="showNumber" class="number">{{number}}</div>\n      <ng-container *ngTemplateOutlet="leftTemplate"></ng-container>\n    </div>\n    \x3c!-- right --\x3e\n    <div class="right">\n      <ng-container *ngTemplateOutlet="rightTemplate"></ng-container>\n      <filter\n        *ngIf="outerFC"\n        [filterSchema]="outerFC.fs"\n        (singleValueChange)="handleFilterSingleChange($event, outerFC)"\n        (multiValueChange)="handleFilterMultiChange($event, outerFC)"\n        ></filter>\n      <div *ngIf="innerFCs"\n        class="tool-wrap d-flex">\n        <nz-dropdown nzTrigger="click">\n          <i nz-dropdown class="material-icons">more_horiz</i>\n          <ul nz-menu class="p-2">\n            <li\n              *ngFor="let fc of innerFCs"\n              class="mt-1 d-flex align-items-center">\n              <span class="text-truncate" style="width: 50px">{{fc?.fs?.i18nName[translate.currentLang]}}</span>\n              <filter\n                [filterSchema]="fc.fs"\n                (singleValueChange)="handleFilterSingleChange($event, fc)"\n                (multiValueChange)="handleFilterMultiChange($event, fc)"\n                ></filter>\n            </li>\n          </ul>\n        </nz-dropdown>\n      </div>\n      \x3c!-- 聚合配置 --\x3e\n      <div *ngIf="showRuntimeAgg"\n        class="tool-wrap d-flex">\n        <nz-dropdown nzTrigger="click" [(nzVisible)]="runtimeAggDropdownOpen">\n          <i nz-dropdown class="material-icons">show_chart</i>\n          <div nz-menu class="p-2" style="width:200px;box-sizing:content-box;">\n            <h5>聚合配置</h5>\n            <div class="tip p-2">\n              聚合配置仅对 QDP 数据集生效。\n            </div>\n            <div class="sm-title">维度</div>\n            <nz-select\n              [(ngModel)]="editingRuntimeAgg.dimensions[0]"\n              nzPlaceHolder="选择维度字段"\n              style="width:200px">\n              <nz-option\n                *ngFor="let dim of dims"\n                [nzLabel]="dim.label || dim.name"\n                [nzValue]="dim.name"></nz-option>\n            </nz-select>\n            <div class="sm-title mt-2">汇总方式及指标</div>\n            <ul>\n              <li\n                class="mb-1 d-flex align-items-center"\n                *ngFor="let ind of editingRuntimeAgg.indicators">\n                <nz-input-group nzCompact>\n                  <nz-select [(ngModel)]="ind.aggFn" style="width:70px">\n                    <nz-option nzLabel="合计" [nzValue]="1"></nz-option>\n                    <nz-option nzLabel="最大值" [nzValue]="2"></nz-option>\n                    <nz-option nzLabel="最小值" [nzValue]="3"></nz-option>\n                    <nz-option nzLabel="计数" [nzValue]="4"></nz-option>\n                    <nz-option nzLabel="平均值" [nzValue]="5"></nz-option>\n                  </nz-select>\n                  <nz-select\n                    nzPlaceHolder="选择指标字段"\n                    [(ngModel)]="ind.dimName"\n                    style="width:110px">\n                    <nz-option\n                      *ngFor="let dim of dims"\n                      [nzLabel]="dim.label || dim.name"\n                      [nzValue]="dim.name"></nz-option>\n                  </nz-select>\n                </nz-input-group>\n                <i\n                  class="material-icons cursor-pointer fs-15 text-gray-200 hover:text-red-600 transition-colors"\n                  (click)="handleRemoveInd(ind)"\n                  >remove_circle</i>\n              </li>\n            </ul>\n\n            <div class="text-right mt-2">\n              <button class="btn btn-secondary mr-1" (click)="handleAddInd()">增加指标</button>\n              <button class="btn btn-primary" (click)="handleConfirmAgg()">{{\'confirm\' | translate}}</button>\n            </div>\n          </div>\n\n          \x3c!-- <ul nz-menu class="p-2">\n            <li\n              *ngFor="let fc of innerFCs"\n              class="mt-1 d-flex align-items-center">\n              <span class="text-truncate" style="width: 50px">{{fc?.fs?.i18nName[translate.currentLang]}}</span>\n              <filter\n                [filterSchema]="fc.fs"\n                (singleValueChange)="handleFilterSingleChange($event, fc)"\n                (multiValueChange)="handleFilterMultiChange($event, fc)"\n                ></filter>\n            </li>\n          </ul> --\x3e\n        </nz-dropdown>\n      </div>\n      <div\n        class="tool-wrap d-flex"\n        [title]="(settingTitle || \'\') | translate"\n        *ngIf="showSetting">\n        <img\n          class="setting"\n          (click)="clickSetting.emit()"\n          src="assets/img/setting.svg"\n          [alt]="settingTitle">\n      </div>\n      <div\n        class="tool-wrap d-flex"\n        *ngIf="showRefresh"\n        (click)="clickRefresh.emit()">\n        <i class="icon-refresh material-icons" style="font-size: 20px;">refresh</i>\n      </div>\n      \x3c!-- -{{jumpConfig.jumpType}}-{{jumpConfig|json}}- --\x3e\n      <div\n        *ngIf="jumpConfig && jumpConfig.jumpType!==JumpTypes.None"\n        (click)="handleClickJump()"\n        class="tool-wrap d-flex">\n        <i class="material-icons">chevron_right</i>\n      </div>\n    </div>\n  </div>\n  <ul>\n    <li *ngFor="let flatFC of flatFCs" class="mt-1">\n      <filter\n        [filterSchema]="flatFC.fs"\n        (singleValueChange)="handleFilterSingleChange($event, flatFC)"\n        (multiValueChange)="handleFilterMultiChange($event, flatFC)"\n        ></filter>\n    </li>\n  </ul>\n</div>',changeDetection:I.ChangeDetectionStrategy.OnPush,styles:['@charset "UTF-8";.title-bar{padding:12px 20px 10px}.title-bar .left{flex:1 1 auto;display:flex}.title-bar .left .material-icons{font-size:18px;margin-right:8px;color:#3794ff;padding-top:1px}.title-bar .left .title{font-weight:700;font-size:15px}.title-bar .left .number{font-size:15px;margin-left:10px}.title-bar .right{flex:1 1 auto;display:flex;justify-content:flex-end;align-items:center}.title-bar .right .widget-select{margin-left:5px}.title-bar .right .setting{width:16px;height:16px;transition:.3s;opacity:1!important}.title-bar .right .setting:hover{transform:rotate(60deg)}.title-bar .right .tool-wrap{width:20px;margin-left:10px;font-size:14px;color:#000;transition:.3s;cursor:pointer;opacity:.2}.title-bar .right .tool-wrap:hover{opacity:.4}']}]}],U.ctorParameters=function(){return[{type:m.WidgetDevkitService},{type:v.TranslateService}]},U.propDecorators={icon:[{type:I.Input}],showTitle:[{type:I.Input}],title:[{type:I.Input}],showNumber:[{type:I.Input}],number:[{type:I.Input}],showSetting:[{type:I.Input}],settingTitle:[{type:I.Input}],clickSetting:[{type:I.Output}],showRefresh:[{type:I.Input}],clickRefresh:[{type:I.Output}],jumpConfig:[{type:I.Input}],jumpProperty:[{type:I.Input}],data:[{type:I.Input}],filterConfigs:[{type:I.Input}],dims:[{type:I.Input}],showRuntimeAgg:[{type:I.Input}],filterChange:[{type:I.Output}],runtimeAggChange:[{type:I.Output}],init:[{type:I.Output}],leftTemplate:[{type:I.ContentChild,args:["leftTemplate"]}],rightTemplate:[{type:I.ContentChild,args:["rightTemplate"]}]},U);function U(e,t){this.devkitSvc=e,this.translate=t,this.icon="",this.showTitle=!0,this.title="",this.showNumber=!1,this.number=0,this.showSetting=!1,this.clickSetting=new I.EventEmitter,this.showRefresh=!1,this.clickRefresh=new I.EventEmitter,this.dims=[],this.showRuntimeAgg=!1,this.filterChange=new I.EventEmitter,this.runtimeAggChange=new I.EventEmitter,this.init=new I.EventEmitter,this.JumpTypes=m.JumpTypes,this.editingRuntimeAgg=new f.RuntimeAggOption,this.runtimeAggDropdownOpen=!1}var G=(J.prototype.ngOnInit=function(){},J.prototype.ngOnChanges=function(e){e.fs&&e.fs.currentValue!=e.fs.previousValue&&(this.value=m.FilterSchema.getDefaultValue(this.fs))},J.prototype.getEnumItems=function(){return m.FSEnum.GetItems(this.fs["enum"])},J.prototype.handleChange=function(e){this.singleValueChange.emit(e)},J.prototype.handleChangeMulti=function(e){this.multiValueChange.emit(e)},J.decorators=[{type:I.Component,args:[{selector:"filter",template:'\x3c!-- {{fs.type|json}} --\x3e\n<div class="d-flex align-items-center" *ngIf="fs">\n  <span *ngIf="fs.showName"\n    class="text-truncate mr-1">{{fs.i18nName[translate.currentLang]}}</span>\n  <ng-container *ngIf="fs.type===\'date\'">\n    <ng-container *ngIf="fs.date.type===\'single\'">\n      <nz-year-picker\n        *ngIf="fs.date.singleUnit===\'year\'"\n        [(ngModel)]="value"\n        nzFormat="YYYY"\n        (ngModelChange)="handleChange($event)"\n        ></nz-year-picker>\n      <nz-month-picker\n        *ngIf="fs.date.singleUnit===\'month\'"\n        [(ngModel)]="value"\n        nzFormat="YYYY-MM"\n        (ngModelChange)="handleChange($event)"\n        ></nz-month-picker>\n      <nz-date-picker\n        *ngIf="fs.date.singleUnit===\'day\'"\n        [(ngModel)]="value"\n        (ngModelChange)="handleChange($event)"\n        ></nz-date-picker>\n    </ng-container>\n\n    <nz-range-picker\n      *ngIf="fs.date.type===\'range\'"\n      [(ngModel)]="value"\n      (ngModelChange)="handleChangeMulti($event)"\n      ></nz-range-picker>\n\n    <ng-container *ngIf="fs.date.type==\'lastTimeEnum\'">\n      <nz-select\n        class=""\n        nzAllowClear\n        [(ngModel)]="value"\n        (ngModelChange)="handleChange($event)">\n        <nz-option\n          *ngFor="let lastTimeItem of fs.date.lastTimeItems"\n          [nzValue]="lastTimeItem.num"\n          [nzLabel]="">last{{lastTimeItem.num}}{{lastTimeItem.unit}}</nz-option>\n      </nz-select>\n    </ng-container>\n  </ng-container>\n\n\n  <ng-container *ngIf="fs.type===\'enum\'">\n    \x3c!-- -{{getEnumItems()}}- --\x3e\n    \x3c!-- single --\x3e\n    <nz-select\n      *ngIf="fs.enum.displayType===\'select\'"\n      [nzMode]="fs.enum.multi ? \'multiple\' : \'default\'"\n      class="col-sm-5"\n      nzAllowClear\n      [(ngModel)]="value"\n      (ngModelChange)="fs.enum.multi ? handleChangeMulti($event) : handleChange($event)">\n      <nz-option\n        *ngFor="let item of getEnumItems()"\n        [nzValue]="item.value"\n        [nzLabel]="item.label || item.value"></nz-option>\n    </nz-select>\n    <flat-select\n      *ngIf="!fs.enum.multi && fs.enum.displayType===\'flat\'"\n      [options]="getEnumItems()"\n      [(value)]="value"\n      (valueChange)="handleChange($event)"\n      ></flat-select>\n  </ng-container>\n\n\n  <ng-container *ngIf="fs.type===\'number\'">\n    <input\n      type="number"\n      class="form-control form-control-sm"\n      [(ngModel)]="value"\n      (ngModelChange)="handleChange($event)"\n      required />\n  </ng-container>\n\n\n  <ng-container *ngIf="fs.type===\'text\'">\n    <input\n      type="text"\n      class="form-control form-control-sm"\n      [(ngModel)]="value"\n      (ngModelChange)="handleChange($event)"\n      required />\n  </ng-container>\n</div>\n<ng-template #tagPlaceHolder let-selectedList> 已选 {{selectedList.length}} 项</ng-template>\n',styles:["nz-select{min-width:60px}"]}]}],J.ctorParameters=function(){return[{type:v.TranslateService}]},J.propDecorators={fs:[{type:I.Input,args:["filterSchema"]}],singleValueChange:[{type:I.Output}],multiValueChange:[{type:I.Output}]},J);function J(e){this.translate=e,this.singleValueChange=new I.EventEmitter,this.multiValueChange=new I.EventEmitter}var Y=(X.prototype.transform=function(e,t){if(e&&e.map)return Array.from(new Set(e.map(function(e){return e[t]})))},X.decorators=[{type:I.Pipe,args:[{name:"colValues"}]}],X);function X(){}var K=(Q.prototype.ngOnInit=function(){},Q.decorators=[{type:I.Component,args:[{selector:"flat-select",template:'\n<ul class="d-flex">\n  <li\n    *ngFor="let option of options"\n    class="cursor-pointer transition"\n    [class.active]="option.value === value"\n    (click)="valueChange.emit(option.value)"\n    >{{option.label || option.value}}</li>\n</ul>',changeDetection:I.ChangeDetectionStrategy.OnPush,styles:["ul{margin-right:5px}ul li{padding:3px 10px;border-radius:100px}ul li.active,ul li:hover{background:#ecf0f3}"]}]}],Q.ctorParameters=function(){return[]},Q.propDecorators={options:[{type:I.Input}],value:[{type:I.Input}],valueChange:[{type:I.Output}]},Q);function Q(){this.options=[],this.valueChange=new I.EventEmitter}var Z=(ee.decorators=[{type:I.NgModule,args:[{declarations:[K],imports:[C.CommonModule],exports:[K]}]}],ee);function ee(){}var te=(ne.decorators=[{type:I.NgModule,args:[{declarations:[G,Y],imports:[C.CommonModule,x.NzSelectModule,w.NzDatePickerModule,y.FormsModule,Z],exports:[G]}]}],ne);function ne(){}var ie=(re.decorators=[{type:I.NgModule,args:[{declarations:[q,$],entryComponents:[],imports:[C.CommonModule,y.FormsModule,o.HttpClientModule,y.ReactiveFormsModule,n.AccordionModule.forRoot(),i.ColorPickerModule,v.TranslateModule,t.NzAutocompleteModule,r.NzModalModule,w.NzDatePickerModule,m.WidgetDevkitModule,f.UtilModule,te,b.NzDropDownModule,x.NzSelectModule,z.NzInputModule],exports:[q],providers:[]}]}],re);function re(){}e.WidgetCoreModule=ie,e.WCStatus=_,e.WidgetComponent=q,e.DynamicLoaderService=D,e.FilterModule=te,e.FilterComponent=G,e.ColValuesPipe=Y,e.isWidgetRuntimeAggActive=N,e.chartAggFieldMap=V,e.FlatSelectComponent=K,e.FlatSelectModule=Z,e.TitleBarComponent=$,e.InstanceService=A,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=gspwidget-widget-core.umd.min.js.map