/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Optional } from '@angular/core';
import { CacheStorageAbstract } from './storage/cache.storage.abstract.service';
import { CacheSessionStorage } from './storage/sessionstorage/cache.sessionstorage.service';
import { CacheLocalStorage } from './storage/localstorage/cache.localstorage.service';
import { CacheMemoryStorage } from './storage/memory/cache.memory.service';
/** @type {?} */
const CACHE_PREFIX = 'CacheService';
/** @type {?} */
const DEFAULT_STORAGE = 2 /* MEMORY */;
/** @type {?} */
const DEFAULT_ENABLED_STORAGE = 1 /* SESSION_STORAGE */;
export class CacheService {
    /**
     * @param {?} _storage
     */
    constructor(_storage) {
        this._storage = _storage;
        /**
         * Default cache options
         * CacheOptionsInterface
         *
         */
        this._defaultOptions = {
            expires: Number.MAX_VALUE,
            maxAge: Number.MAX_VALUE
        };
        /**
         * Cache prefix
         */
        this._prefix = CACHE_PREFIX;
        this._validateStorage();
    }
    /**
     * Set data to cache
     * @param {?} key
     * @param {?} value
     * @param {?=} options
     * @return {?}
     */
    set(key, value, options) {
        /** @type {?} */
        const storageKey = this._toStorageKey(key);
        options = options ? options : this._defaultOptions;
        if (this._storage.setItem(storageKey, this._toStorageValue(value, options))) {
            if (!this._isSystemKey(key) && options.tag) {
                this._saveTag(options.tag, storageKey);
            }
            return true;
        }
        return false;
    }
    /**
     * Get data from cache
     * @param {?} key
     * @return {?}
     */
    get(key) {
        /** @type {?} */
        const storageValue = this._storage.getItem(this._toStorageKey(key));
        /** @type {?} */
        let value = null;
        if (storageValue) {
            if (this._validateStorageValue(storageValue)) {
                value = storageValue.value;
            }
            else {
                this.remove(key);
            }
        }
        return value;
    }
    /**
     * Check if value exists
     * @param {?} key
     * @return {?}
     */
    exists(key) {
        return !!this.get(key);
    }
    /**
     * Remove item from cache
     * @param {?} key
     * @return {?}
     */
    remove(key) {
        this._storage.removeItem(this._toStorageKey(key));
        this._removeFromTag(this._toStorageKey(key));
    }
    /**
     * Remove all from cache
     * @return {?}
     */
    removeAll() {
        this._storage.clear();
    }
    /**
     * Get all tag data
     * @param {?} tag
     * @return {?}
     */
    getTagData(tag) {
        /** @type {?} */
        const tags = this.get(this._tagsStorageKey()) || {};
        /** @type {?} */
        const result = {};
        if (tags[tag]) {
            tags[tag].forEach((/**
             * @param {?} key
             * @return {?}
             */
            (key) => {
                /** @type {?} */
                const data = this.get(this._fromStorageKey(key));
                if (data) {
                    result[this._fromStorageKey(key)] = data;
                }
            }));
        }
        return result;
    }
    /**
     * Create a new instance of cache with needed storage
     * @param {?} type
     * @return {?}
     */
    useStorage(type) {
        /** @type {?} */
        const service = new CacheService(this._initStorage(type));
        service.setGlobalPrefix(this._getCachePrefix());
        return service;
    }
    /**
     * Remove all by tag
     * @param {?} tag
     * @return {?}
     */
    removeTag(tag) {
        /** @type {?} */
        const tags = this.get(this._tagsStorageKey()) || {};
        if (tags[tag]) {
            tags[tag].forEach((/**
             * @param {?} key
             * @return {?}
             */
            (key) => {
                this._storage.removeItem(key);
            }));
            delete tags[tag];
            this.set(this._tagsStorageKey(), tags);
        }
    }
    /**
     * Set global cache key prefix
     * @param {?} prefix
     * @return {?}
     */
    setGlobalPrefix(prefix) {
        this._prefix = prefix;
    }
    /**
     * Validate cache storage
     *
     * @private
     * @return {?}
     */
    _validateStorage() {
        if (!this._storage) {
            this._storage = this._initStorage(DEFAULT_STORAGE);
        }
        if (!this._storage.isEnabled()) {
            this._storage = this._initStorage(DEFAULT_ENABLED_STORAGE);
        }
    }
    /**
     * Remove key from tags keys list
     * @private
     * @param {?} key
     * @return {?}
     */
    _removeFromTag(key) {
        // tslint:disable-next-line:prefer-const
        /** @type {?} */
        let tags = this.get(this._tagsStorageKey()) || {};
        /** @type {?} */
        let index;
        // tslint:disable-next-line:forin
        for (const tag in tags) {
            index = tags[tag].indexOf(key);
            if (index !== -1) {
                tags[tag].splice(index, 1);
                this.set(this._tagsStorageKey(), tags);
                break;
            }
        }
    }
    /**
     * Init storage by type
     * @private
     * @param {?} type
     * @return {?}
     */
    _initStorage(type) {
        /** @type {?} */
        let storage;
        switch (type) {
            case 1 /* SESSION_STORAGE */:
                storage = new CacheSessionStorage();
                break;
            case 0 /* LOCAL_STORAGE */:
                storage = new CacheLocalStorage();
                break;
            default: storage = new CacheMemoryStorage();
        }
        return storage;
    }
    /**
     * @private
     * @param {?} key
     * @return {?}
     */
    _toStorageKey(key) {
        return this._getCachePrefix() + key;
    }
    /**
     * @private
     * @param {?} key
     * @return {?}
     */
    _fromStorageKey(key) {
        return key.replace(this._getCachePrefix(), '');
    }
    /**
     * Prepare value to set to storage
     *
     * @private
     * @param {?} value
     * @param {?} options
     * @return {?}
     */
    _toStorageValue(value, options) {
        return {
            value: value,
            options: this._toStorageOptions(options)
        };
    }
    /**
     * Prepare options to set to storage
     *
     * @private
     * @param {?} options
     * @return {?}
     */
    _toStorageOptions(options) {
        /** @type {?} */
        const storageOptions = {};
        storageOptions.expires = options.expires ? options.expires :
            (options.maxAge ? Date.now() + (options.maxAge * 1000) : this._defaultOptions.expires);
        storageOptions.maxAge = options.maxAge ? options.maxAge : this._defaultOptions.maxAge;
        return storageOptions;
    }
    /**
     * Validate storage value
     *
     * @private
     * @param {?} value
     * @return {?}
     */
    _validateStorageValue(value) {
        return !!value.options.expires && value.options.expires > Date.now();
    }
    /**
     * check if its system cache key
     *
     * @private
     * @param {?} key
     * @return {?}
     */
    _isSystemKey(key) {
        return [this._tagsStorageKey()].indexOf(key) !== -1;
    }
    /**
     * Save tag to list of tags
     *
     *
     * @private
     * @param {?} tag
     * @param {?} key
     * @return {?}
     */
    _saveTag(tag, key) {
        /** @type {?} */
        const tags = this.get(this._tagsStorageKey()) || {};
        if (!tags[tag]) {
            tags[tag] = [key];
        }
        else {
            tags[tag].push(key);
        }
        this.set(this._tagsStorageKey(), tags);
    }
    /**
     * Get global cache prefix
     *
     *
     * @private
     * @return {?}
     */
    _getCachePrefix() {
        return this._prefix;
    }
    /**
     * @private
     * @return {?}
     */
    _tagsStorageKey() {
        return 'CacheService_tags';
    }
}
CacheService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
CacheService.ctorParameters = () => [
    { type: CacheStorageAbstract, decorators: [{ type: Optional }] }
];
if (false) {
    /**
     * Default cache options
     * CacheOptionsInterface
     *
     * @type {?}
     * @private
     */
    CacheService.prototype._defaultOptions;
    /**
     * Cache prefix
     * @type {?}
     * @private
     */
    CacheService.prototype._prefix;
    /**
     * @type {?}
     * @private
     */
    CacheService.prototype._storage;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BlY3AtY2FmL2NhZi1jb21tb24vIiwic291cmNlcyI6WyJsaWIvY2FjaGUvc2VydmljZXMvY2FjaGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHckQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDaEYsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sdURBQXVELENBQUM7QUFDNUYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sbURBQW1ELENBQUM7QUFDdEYsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUNBQXVDLENBQUM7O01BR3JFLFlBQVksR0FBRyxjQUFjOztNQUU3QixlQUFlLGlCQUEyQjs7TUFDMUMsdUJBQXVCLDBCQUFvQztBQUdqRSxNQUFNLE9BQU8sWUFBWTs7OztJQWlCckIsWUFBdUMsUUFBOEI7UUFBOUIsYUFBUSxHQUFSLFFBQVEsQ0FBc0I7Ozs7OztRQVY3RCxvQkFBZSxHQUEwQjtZQUM3QyxPQUFPLEVBQUUsTUFBTSxDQUFDLFNBQVM7WUFDekIsTUFBTSxFQUFHLE1BQU0sQ0FBQyxTQUFTO1NBQzVCLENBQUM7Ozs7UUFLTSxZQUFPLEdBQVcsWUFBWSxDQUFDO1FBR25DLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQzVCLENBQUM7Ozs7Ozs7O0lBS00sR0FBRyxDQUFDLEdBQVcsRUFBRSxLQUFVLEVBQUUsT0FBK0I7O2NBQ3pELFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQztRQUMxQyxPQUFPLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUM7UUFDbkQsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxV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Qzs7Ozs7SUFFcEIsZ0NBQWtEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQ2FjaGVPcHRpb25zSW50ZXJmYWNlIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9jYWNoZS5vcHRpb25zLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IENhY2hlU3RvcmFnZXNFbnVtIH0gZnJvbSAnLi4vZW51bXMvY2FjaGUuc3RvcmFnZXMuZW51bSc7XHJcbmltcG9ydCB7IENhY2hlU3RvcmFnZUFic3RyYWN0IH0gZnJvbSAnLi9zdG9yYWdlL2NhY2hlLnN0b3JhZ2UuYWJzdHJhY3Quc2VydmljZSc7XHJcbmltcG9ydCB7IENhY2hlU2Vzc2lvblN0b3JhZ2UgfSBmcm9tICcuL3N0b3JhZ2Uvc2Vzc2lvbnN0b3JhZ2UvY2FjaGUuc2Vzc2lvbnN0b3JhZ2Uuc2VydmljZSc7XHJcbmltcG9ydCB7IENhY2hlTG9jYWxTdG9yYWdlIH0gZnJvbSAnLi9zdG9yYWdlL2xvY2Fsc3RvcmFnZS9jYWNoZS5sb2NhbHN0b3JhZ2Uuc2VydmljZSc7XHJcbmltcG9ydCB7IENhY2hlTWVtb3J5U3RvcmFnZSB9IGZyb20gJy4vc3RvcmFnZS9tZW1vcnkvY2FjaGUubWVtb3J5LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBTdG9yYWdlVmFsdWVJbnRlcmZhY2UgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3N0b3JhZ2UudmFsdWUuaW50ZXJmYWNlJztcclxuXHJcbmNvbnN0IENBQ0hFX1BSRUZJWCA9ICdDYWNoZVNlcnZpY2UnO1xyXG5cclxuY29uc3QgREVGQVVMVF9TVE9SQUdFID0gQ2FjaGVTdG9yYWdlc0VudW0uTUVNT1JZO1xyXG5jb25zdCBERUZBVUxUX0VOQUJMRURfU1RPUkFHRSA9IENhY2hlU3RvcmFnZXNFbnVtLlNFU1NJT05fU1RPUkFHRTtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIENhY2hlU2VydmljZSB7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBEZWZhdWx0IGNhY2hlIG9wdGlvbnNcclxuICAgICAqIENhY2hlT3B0aW9uc0ludGVyZmFjZVxyXG4gICAgICogXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX2RlZmF1bHRPcHRpb25zOiBDYWNoZU9wdGlvbnNJbnRlcmZhY2UgPSB7XHJcbiAgICAgICAgZXhwaXJlczogTnVtYmVyLk1BWF9WQUxVRSxcclxuICAgICAgICBtYXhBZ2UgOiBOdW1iZXIuTUFYX1ZBTFVFXHJcbiAgICB9O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ2FjaGUgcHJlZml4XHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX3ByZWZpeDogc3RyaW5nID0gQ0FDSEVfUFJFRklYO1xyXG5cclxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvcihAT3B0aW9uYWwoKSBwcml2YXRlIF9zdG9yYWdlOiBDYWNoZVN0b3JhZ2VBYnN0cmFjdCkge1xyXG4gICAgICAgIHRoaXMuX3ZhbGlkYXRlU3RvcmFnZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogU2V0IGRhdGEgdG8gY2FjaGVcclxuICAgICAqL1xyXG4gICAgcHVibGljIHNldChrZXk6IHN0cmluZywgdmFsdWU6IGFueSwgb3B0aW9ucz86IENhY2hlT3B0aW9uc0ludGVyZmFjZSkge1xyXG4gICAgICAgIGNvbnN0IHN0b3JhZ2VLZXkgPSB0aGlzLl90b1N0b3JhZ2VLZXkoa2V5KTtcclxuICAgICAgICBvcHRpb25zID0gb3B0aW9ucyA/IG9wdGlvbnMgOiB0aGlzLl9kZWZhdWx0T3B0aW9ucztcclxuICAgICAgICBpZiAodGhpcy5fc3RvcmFnZS5zZXRJdGVtKHN0b3JhZ2VLZXksIHRoaXMuX3RvU3RvcmFnZVZhbHVlKHZhbHVlLCBvcHRpb25zKSkpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLl9pc1N5c3RlbUtleShrZXkpICYmIG9wdGlvbnMudGFnKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9zYXZlVGFnKG9wdGlvbnMudGFnLCBzdG9yYWdlS2V5KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldCBkYXRhIGZyb20gY2FjaGVcclxuICAgICAqL1xyXG4gICAgcHVibGljIGdldChrZXk6IHN0cmluZyk6IGFueSB7XHJcbiAgICAgICAgY29uc3Qgc3RvcmFnZVZhbHVlID0gdGhpcy5fc3RvcmFnZS5nZXRJdGVtKHRoaXMuX3RvU3RvcmFnZUtleShrZXkpKTtcclxuICAgICAgICBsZXQgdmFsdWU6IGFueSA9IG51bGw7XHJcbiAgICAgICAgaWYgKHN0b3JhZ2VWYWx1ZSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5fdmFsaWRhdGVTdG9yYWdlVmFsdWUoc3RvcmFnZVZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSBzdG9yYWdlVmFsdWUudmFsdWU7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZShrZXkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENoZWNrIGlmIHZhbHVlIGV4aXN0c1xyXG4gICAgICovXHJcbiAgICBwdWJsaWMgZXhpc3RzKGtleTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuICEhdGhpcy5nZXQoa2V5KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJlbW92ZSBpdGVtIGZyb20gY2FjaGVcclxuICAgICAqL1xyXG4gICAgcHVibGljIHJlbW92ZShrZXk6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuX3N0b3JhZ2UucmVtb3ZlSXRlbSh0aGlzLl90b1N0b3JhZ2VLZXkoa2V5KSk7XHJcbiAgICAgICAgdGhpcy5fcmVtb3ZlRnJvbVRhZyh0aGlzLl90b1N0b3JhZ2VLZXkoa2V5KSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZW1vdmUgYWxsIGZyb20gY2FjaGVcclxuICAgICAqL1xyXG4gICAgcHVibGljIHJlbW92ZUFsbCgpIHtcclxuICAgICAgICB0aGlzLl9zdG9yYWdlLmNsZWFyKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBHZXQgYWxsIHRhZyBkYXRhXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBnZXRUYWdEYXRhKHRhZzogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgdGFncyA9IHRoaXMuZ2V0KHRoaXMuX3RhZ3NTdG9yYWdlS2V5KCkpIHx8IHt9O1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdDoge1trZXk6IHN0cmluZ106IGFueX0gPSB7fTtcclxuICAgICAgICBpZiAodGFnc1t0YWddKSB7XHJcbiAgICAgICAgICAgIHRhZ3NbdGFnXS5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZ2V0KHRoaXMuX2Zyb21TdG9yYWdlS2V5KGtleSkpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHRbdGhpcy5fZnJvbVN0b3JhZ2VLZXkoa2V5KV0gPSBkYXRhO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBjYWNoZSB3aXRoIG5lZWRlZCBzdG9yYWdlXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyB1c2VTdG9yYWdlKHR5cGU6IENhY2hlU3RvcmFnZXNFbnVtKSB7XHJcbiAgICAgICAgY29uc3Qgc2VydmljZSA9IG5ldyBDYWNoZVNlcnZpY2UodGhpcy5faW5pdFN0b3JhZ2UodHlwZSkpO1xyXG4gICAgICAgIHNlcnZpY2Uuc2V0R2xvYmFsUHJlZml4KHRoaXMuX2dldENhY2hlUHJlZml4KCkpO1xyXG4gICAgICAgIHJldHVybiBzZXJ2aWNlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmVtb3ZlIGFsbCBieSB0YWdcclxuICAgICAqL1xyXG4gICAgcHVibGljIHJlbW92ZVRhZyh0YWc6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IHRhZ3MgPSB0aGlzLmdldCh0aGlzLl90YWdzU3RvcmFnZUtleSgpKSB8fCB7fTtcclxuICAgICAgICBpZiAodGFnc1t0YWddKSB7XHJcbiAgICAgICAgICAgIHRhZ3NbdGFnXS5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fc3RvcmFnZS5yZW1vdmVJdGVtKGtleSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBkZWxldGUgdGFnc1t0YWddO1xyXG4gICAgICAgICAgICB0aGlzLnNldCh0aGlzLl90YWdzU3RvcmFnZUtleSgpLCB0YWdzKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTZXQgZ2xvYmFsIGNhY2hlIGtleSBwcmVmaXhcclxuICAgICAqL1xyXG4gICAgcHVibGljIHNldEdsb2JhbFByZWZpeChwcmVmaXg6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuX3ByZWZpeCA9IHByZWZpeDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFZhbGlkYXRlIGNhY2hlIHN0b3JhZ2VcclxuICAgICAqIFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF92YWxpZGF0ZVN0b3JhZ2UoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLl9zdG9yYWdlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3N0b3JhZ2UgPSB0aGlzLl9pbml0U3RvcmFnZShERUZBVUxUX1NUT1JBR0UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRoaXMuX3N0b3JhZ2UuaXNFbmFibGVkKCkpIHtcclxuICAgICAgICAgICAgdGhpcy5fc3RvcmFnZSA9IHRoaXMuX2luaXRTdG9yYWdlKERFRkFVTFRfRU5BQkxFRF9TVE9SQUdFKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZW1vdmUga2V5IGZyb20gdGFncyBrZXlzIGxpc3RcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfcmVtb3ZlRnJvbVRhZyhrZXk6IHN0cmluZykge1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpwcmVmZXItY29uc3RcclxuICAgICAgICBsZXQgdGFncyA9IHRoaXMuZ2V0KHRoaXMuX3RhZ3NTdG9yYWdlS2V5KCkpIHx8IHt9O1xyXG4gICAgICAgIGxldCBpbmRleDogbnVtYmVyO1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpmb3JpblxyXG4gICAgICAgIGZvciAoY29uc3QgdGFnIGluIHRhZ3MpIHtcclxuICAgICAgICAgICAgaW5kZXggPSB0YWdzW3RhZ10uaW5kZXhPZihrZXkpO1xyXG4gICAgICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICB0YWdzW3RhZ10uc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0KHRoaXMuX3RhZ3NTdG9yYWdlS2V5KCksIHRhZ3MpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBJbml0IHN0b3JhZ2UgYnkgdHlwZVxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9pbml0U3RvcmFnZSh0eXBlOiBDYWNoZVN0b3JhZ2VzRW51bSkge1xyXG4gICAgICAgIGxldCBzdG9yYWdlOiBDYWNoZVN0b3JhZ2VBYnN0cmFjdDtcclxuICAgICAgICBzd2l0Y2ggKHR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSBDYWNoZVN0b3JhZ2VzRW51bS5TRVNTSU9OX1NUT1JBR0U6XHJcbiAgICAgICAgICAgICAgICBzdG9yYWdlID0gbmV3IENhY2hlU2Vzc2lvblN0b3JhZ2UoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIENhY2hlU3RvcmFnZXNFbnVtLkxPQ0FMX1NUT1JBR0U6XHJcbiAgICAgICAgICAgICAgICBzdG9yYWdlID0gbmV3IENhY2hlTG9jYWxTdG9yYWdlKCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgZGVmYXVsdDogc3RvcmFnZSA9IG5ldyBDYWNoZU1lbW9yeVN0b3JhZ2UoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHN0b3JhZ2U7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfdG9TdG9yYWdlS2V5KGtleTogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldENhY2hlUHJlZml4KCkgKyBrZXk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfZnJvbVN0b3JhZ2VLZXkoa2V5OiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4ga2V5LnJlcGxhY2UodGhpcy5fZ2V0Q2FjaGVQcmVmaXgoKSwgJycpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUHJlcGFyZSB2YWx1ZSB0byBzZXQgdG8gc3RvcmFnZVxyXG4gICAgICpcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfdG9TdG9yYWdlVmFsdWUodmFsdWU6IGFueSwgb3B0aW9uczogQ2FjaGVPcHRpb25zSW50ZXJmYWNlKTogU3RvcmFnZVZhbHVlSW50ZXJmYWNlIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB2YWx1ZTogdmFsdWUsXHJcbiAgICAgICAgICAgIG9wdGlvbnM6IHRoaXMuX3RvU3RvcmFnZU9wdGlvbnMob3B0aW9ucylcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUHJlcGFyZSBvcHRpb25zIHRvIHNldCB0byBzdG9yYWdlXHJcbiAgICAgKiBcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfdG9TdG9yYWdlT3B0aW9ucyhvcHRpb25zOiBDYWNoZU9wdGlvbnNJbnRlcmZhY2UpOiBDYWNoZU9wdGlvbnNJbnRlcmZhY2Uge1xyXG4gICAgICAgIGNvbnN0IHN0b3JhZ2VPcHRpb25zOiBDYWNoZU9wdGlvbnNJbnRlcmZhY2UgPSB7fTtcclxuICAgICAgICBzdG9yYWdlT3B0aW9ucy5leHBpcmVzID0gb3B0aW9ucy5leHBpcmVzID8gb3B0aW9ucy5leHBpcmVzIDpcclxuICAgICAgICAgICAgKG9wdGlvbnMubWF4QWdlID8gRGF0ZS5ub3coKSArIChvcHRpb25zLm1heEFnZSAqIDEwMDApIDogdGhpcy5fZGVmYXVsdE9wdGlvbnMuZXhwaXJlcyk7XHJcbiAgICAgICAgc3RvcmFnZU9wdGlvbnMubWF4QWdlID0gb3B0aW9ucy5tYXhBZ2UgPyBvcHRpb25zLm1heEFnZSA6IHRoaXMuX2RlZmF1bHRPcHRpb25zLm1heEFnZTtcclxuICAgICAgICByZXR1cm4gc3RvcmFnZU9wdGlvbnM7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBWYWxpZGF0ZSBzdG9yYWdlIHZhbHVlXHJcbiAgICAgKlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF92YWxpZGF0ZVN0b3JhZ2VWYWx1ZSh2YWx1ZTogU3RvcmFnZVZhbHVlSW50ZXJmYWNlKSB7XHJcbiAgICAgICAgcmV0dXJuICEhdmFsdWUub3B0aW9ucy5leHBpcmVzICYmIHZhbHVlLm9wdGlvbnMuZXhwaXJlcyA+IERhdGUubm93KCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBjaGVjayBpZiBpdHMgc3lzdGVtIGNhY2hlIGtleVxyXG4gICAgICogXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX2lzU3lzdGVtS2V5KGtleTogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIFt0aGlzLl90YWdzU3RvcmFnZUtleSgpXS5pbmRleE9mKGtleSkgIT09IC0xO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogU2F2ZSB0YWcgdG8gbGlzdCBvZiB0YWdzXHJcbiAgICAgKiBcclxuICAgICAqIFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9zYXZlVGFnKHRhZzogc3RyaW5nLCBrZXk6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IHRhZ3MgPSB0aGlzLmdldCh0aGlzLl90YWdzU3RvcmFnZUtleSgpKSB8fCB7fTtcclxuICAgICAgICBpZiAoIXRhZ3NbdGFnXSkge1xyXG4gICAgICAgICAgICB0YWdzW3RhZ10gPSBba2V5XTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0YWdzW3RhZ10ucHVzaChrZXkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNldCh0aGlzLl90YWdzU3RvcmFnZUtleSgpLCB0YWdzKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldCBnbG9iYWwgY2FjaGUgcHJlZml4XHJcbiAgICAgKiBcclxuICAgICAqIFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9nZXRDYWNoZVByZWZpeCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fcHJlZml4O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX3RhZ3NTdG9yYWdlS2V5KCkge1xyXG4gICAgICAgIHJldHVybiAnQ2FjaGVTZXJ2aWNlX3RhZ3MnO1xyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=