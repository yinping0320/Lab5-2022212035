/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Optional } from '@angular/core';
import { CacheStorageAbstract } from './storage/cache.storage.abstract.service';
import { CacheSessionStorage } from './storage/sessionstorage/cache.sessionstorage.service';
import { CacheLocalStorage } from './storage/localstorage/cache.localstorage.service';
import { CacheMemoryStorage } from './storage/memory/cache.memory.service';
/** @type {?} */
var CACHE_PREFIX = 'CacheService';
/** @type {?} */
var DEFAULT_STORAGE = 2 /* MEMORY */;
/** @type {?} */
var DEFAULT_ENABLED_STORAGE = 1 /* SESSION_STORAGE */;
var CacheService = /** @class */ (function () {
    function CacheService(_storage) {
        this._storage = _storage;
        /**
         * Default cache options
         * CacheOptionsInterface
         *
         */
        this._defaultOptions = {
            expires: Number.MAX_VALUE,
            maxAge: Number.MAX_VALUE
        };
        /**
         * Cache prefix
         */
        this._prefix = CACHE_PREFIX;
        this._validateStorage();
    }
    /**
     * Set data to cache
     */
    /**
     * Set data to cache
     * @param {?} key
     * @param {?} value
     * @param {?=} options
     * @return {?}
     */
    CacheService.prototype.set = /**
     * Set data to cache
     * @param {?} key
     * @param {?} value
     * @param {?=} options
     * @return {?}
     */
    function (key, value, options) {
        /** @type {?} */
        var storageKey = this._toStorageKey(key);
        options = options ? options : this._defaultOptions;
        if (this._storage.setItem(storageKey, this._toStorageValue(value, options))) {
            if (!this._isSystemKey(key) && options.tag) {
                this._saveTag(options.tag, storageKey);
            }
            return true;
        }
        return false;
    };
    /**
     * Get data from cache
     */
    /**
     * Get data from cache
     * @param {?} key
     * @return {?}
     */
    CacheService.prototype.get = /**
     * Get data from cache
     * @param {?} key
     * @return {?}
     */
    function (key) {
        /** @type {?} */
        var storageValue = this._storage.getItem(this._toStorageKey(key));
        /** @type {?} */
        var value = null;
        if (storageValue) {
            if (this._validateStorageValue(storageValue)) {
                value = storageValue.value;
            }
            else {
                this.remove(key);
            }
        }
        return value;
    };
    /**
     * Check if value exists
     */
    /**
     * Check if value exists
     * @param {?} key
     * @return {?}
     */
    CacheService.prototype.exists = /**
     * Check if value exists
     * @param {?} key
     * @return {?}
     */
    function (key) {
        return !!this.get(key);
    };
    /**
     * Remove item from cache
     */
    /**
     * Remove item from cache
     * @param {?} key
     * @return {?}
     */
    CacheService.prototype.remove = /**
     * Remove item from cache
     * @param {?} key
     * @return {?}
     */
    function (key) {
        this._storage.removeItem(this._toStorageKey(key));
        this._removeFromTag(this._toStorageKey(key));
    };
    /**
     * Remove all from cache
     */
    /**
     * Remove all from cache
     * @return {?}
     */
    CacheService.prototype.removeAll = /**
     * Remove all from cache
     * @return {?}
     */
    function () {
        this._storage.clear();
    };
    /**
     * Get all tag data
     */
    /**
     * Get all tag data
     * @param {?} tag
     * @return {?}
     */
    CacheService.prototype.getTagData = /**
     * Get all tag data
     * @param {?} tag
     * @return {?}
     */
    function (tag) {
        var _this = this;
        /** @type {?} */
        var tags = this.get(this._tagsStorageKey()) || {};
        /** @type {?} */
        var result = {};
        if (tags[tag]) {
            tags[tag].forEach((/**
             * @param {?} key
             * @return {?}
             */
            function (key) {
                /** @type {?} */
                var data = _this.get(_this._fromStorageKey(key));
                if (data) {
                    result[_this._fromStorageKey(key)] = data;
                }
            }));
        }
        return result;
    };
    /**
     * Create a new instance of cache with needed storage
     */
    /**
     * Create a new instance of cache with needed storage
     * @param {?} type
     * @return {?}
     */
    CacheService.prototype.useStorage = /**
     * Create a new instance of cache with needed storage
     * @param {?} type
     * @return {?}
     */
    function (type) {
        /** @type {?} */
        var service = new CacheService(this._initStorage(type));
        service.setGlobalPrefix(this._getCachePrefix());
        return service;
    };
    /**
     * Remove all by tag
     */
    /**
     * Remove all by tag
     * @param {?} tag
     * @return {?}
     */
    CacheService.prototype.removeTag = /**
     * Remove all by tag
     * @param {?} tag
     * @return {?}
     */
    function (tag) {
        var _this = this;
        /** @type {?} */
        var tags = this.get(this._tagsStorageKey()) || {};
        if (tags[tag]) {
            tags[tag].forEach((/**
             * @param {?} key
             * @return {?}
             */
            function (key) {
                _this._storage.removeItem(key);
            }));
            delete tags[tag];
            this.set(this._tagsStorageKey(), tags);
        }
    };
    /**
     * Set global cache key prefix
     */
    /**
     * Set global cache key prefix
     * @param {?} prefix
     * @return {?}
     */
    CacheService.prototype.setGlobalPrefix = /**
     * Set global cache key prefix
     * @param {?} prefix
     * @return {?}
     */
    function (prefix) {
        this._prefix = prefix;
    };
    /**
     * Validate cache storage
     *
     */
    /**
     * Validate cache storage
     *
     * @private
     * @return {?}
     */
    CacheService.prototype._validateStorage = /**
     * Validate cache storage
     *
     * @private
     * @return {?}
     */
    function () {
        if (!this._storage) {
            this._storage = this._initStorage(DEFAULT_STORAGE);
        }
        if (!this._storage.isEnabled()) {
            this._storage = this._initStorage(DEFAULT_ENABLED_STORAGE);
        }
    };
    /**
     * Remove key from tags keys list
     */
    /**
     * Remove key from tags keys list
     * @private
     * @param {?} key
     * @return {?}
     */
    CacheService.prototype._removeFromTag = /**
     * Remove key from tags keys list
     * @private
     * @param {?} key
     * @return {?}
     */
    function (key) {
        // tslint:disable-next-line:prefer-const
        /** @type {?} */
        var tags = this.get(this._tagsStorageKey()) || {};
        /** @type {?} */
        var index;
        // tslint:disable-next-line:forin
        for (var tag in tags) {
            index = tags[tag].indexOf(key);
            if (index !== -1) {
                tags[tag].splice(index, 1);
                this.set(this._tagsStorageKey(), tags);
                break;
            }
        }
    };
    /**
     * Init storage by type
     */
    /**
     * Init storage by type
     * @private
     * @param {?} type
     * @return {?}
     */
    CacheService.prototype._initStorage = /**
     * Init storage by type
     * @private
     * @param {?} type
     * @return {?}
     */
    function (type) {
        /** @type {?} */
        var storage;
        switch (type) {
            case 1 /* SESSION_STORAGE */:
                storage = new CacheSessionStorage();
                break;
            case 0 /* LOCAL_STORAGE */:
                storage = new CacheLocalStorage();
                break;
            default: storage = new CacheMemoryStorage();
        }
        return storage;
    };
    /**
     * @private
     * @param {?} key
     * @return {?}
     */
    CacheService.prototype._toStorageKey = /**
     * @private
     * @param {?} key
     * @return {?}
     */
    function (key) {
        return this._getCachePrefix() + key;
    };
    /**
     * @private
     * @param {?} key
     * @return {?}
     */
    CacheService.prototype._fromStorageKey = /**
     * @private
     * @param {?} key
     * @return {?}
     */
    function (key) {
        return key.replace(this._getCachePrefix(), '');
    };
    /**
     * Prepare value to set to storage
     *
     */
    /**
     * Prepare value to set to storage
     *
     * @private
     * @param {?} value
     * @param {?} options
     * @return {?}
     */
    CacheService.prototype._toStorageValue = /**
     * Prepare value to set to storage
     *
     * @private
     * @param {?} value
     * @param {?} options
     * @return {?}
     */
    function (value, options) {
        return {
            value: value,
            options: this._toStorageOptions(options)
        };
    };
    /**
     * Prepare options to set to storage
     *
     */
    /**
     * Prepare options to set to storage
     *
     * @private
     * @param {?} options
     * @return {?}
     */
    CacheService.prototype._toStorageOptions = /**
     * Prepare options to set to storage
     *
     * @private
     * @param {?} options
     * @return {?}
     */
    function (options) {
        /** @type {?} */
        var storageOptions = {};
        storageOptions.expires = options.expires ? options.expires :
            (options.maxAge ? Date.now() + (options.maxAge * 1000) : this._defaultOptions.expires);
        storageOptions.maxAge = options.maxAge ? options.maxAge : this._defaultOptions.maxAge;
        return storageOptions;
    };
    /**
     * Validate storage value
     *
     */
    /**
     * Validate storage value
     *
     * @private
     * @param {?} value
     * @return {?}
     */
    CacheService.prototype._validateStorageValue = /**
     * Validate storage value
     *
     * @private
     * @param {?} value
     * @return {?}
     */
    function (value) {
        return !!value.options.expires && value.options.expires > Date.now();
    };
    /**
     * check if its system cache key
     *
     */
    /**
     * check if its system cache key
     *
     * @private
     * @param {?} key
     * @return {?}
     */
    CacheService.prototype._isSystemKey = /**
     * check if its system cache key
     *
     * @private
     * @param {?} key
     * @return {?}
     */
    function (key) {
        return [this._tagsStorageKey()].indexOf(key) !== -1;
    };
    /**
     * Save tag to list of tags
     *
     *
     */
    /**
     * Save tag to list of tags
     *
     *
     * @private
     * @param {?} tag
     * @param {?} key
     * @return {?}
     */
    CacheService.prototype._saveTag = /**
     * Save tag to list of tags
     *
     *
     * @private
     * @param {?} tag
     * @param {?} key
     * @return {?}
     */
    function (tag, key) {
        /** @type {?} */
        var tags = this.get(this._tagsStorageKey()) || {};
        if (!tags[tag]) {
            tags[tag] = [key];
        }
        else {
            tags[tag].push(key);
        }
        this.set(this._tagsStorageKey(), tags);
    };
    /**
     * Get global cache prefix
     *
     *
     */
    /**
     * Get global cache prefix
     *
     *
     * @private
     * @return {?}
     */
    CacheService.prototype._getCachePrefix = /**
     * Get global cache prefix
     *
     *
     * @private
     * @return {?}
     */
    function () {
        return this._prefix;
    };
    /**
     * @private
     * @return {?}
     */
    CacheService.prototype._tagsStorageKey = /**
     * @private
     * @return {?}
     */
    function () {
        return 'CacheService_tags';
    };
    CacheService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    CacheService.ctorParameters = function () { return [
        { type: CacheStorageAbstract, decorators: [{ type: Optional }] }
    ]; };
    return CacheService;
}());
export { CacheService };
if (false) {
    /**
     * Default cache options
     * CacheOptionsInterface
     *
     * @type {?}
     * @private
     */
    CacheService.prototype._defaultOptions;
    /**
     * Cache prefix
     * @type {?}
     * @private
     */
    CacheService.prototype._prefix;
    /**
     * @type {?}
     * @private
     */
    CacheService.prototype._storage;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BlY3AtY2FmL2NhZi1jb21tb24vIiwic291cmNlcyI6WyJsaWIvY2FjaGUvc2VydmljZXMvY2FjaGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHckQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDaEYsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sdURBQXVELENBQUM7QUFDNUYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sbURBQW1ELENBQUM7QUFDdEYsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUNBQXVDLENBQUM7O0lBR3JFLFlBQVksR0FBRyxjQUFjOztJQUU3QixlQUFlLGlCQUEyQjs7SUFDMUMsdUJBQXVCLDBCQUFvQztBQUVqRTtJQWtCSSxzQkFBdUMsUUFBOEI7UUFBOUIsYUFBUSxHQUFSLFFBQVEsQ0FBc0I7Ozs7OztRQVY3RCxvQkFBZSxHQUEwQjtZQUM3QyxPQUFPLEVBQUUsTUFBTSxDQUFDLFNBQVM7WUFDekIsTUFBTSxFQUFHLE1BQU0sQ0FBQyxTQUFTO1NBQzVCLENBQUM7Ozs7UUFLTSxZQUFPLEdBQVcsWUFBWSxDQUFDO1FBR25DLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFRDs7T0FFRzs7Ozs7Ozs7SUFDSSwwQkFBRzs7Ozs7OztJQUFWLFVBQVcsR0FBVyxFQUFFLEtBQVUsRUFBRSxPQUErQjs7WUFDekQsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDO1FBQzFDLE9BQU8sR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQztRQUNuRCxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxD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QUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ1osSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDckI7YUFBTTtZQUNILElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDdkI7UUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRUQ7Ozs7T0FJRzs7Ozs7Ozs7SUFDSyxzQ0FBZTs7Ozs7OztJQUF2QjtRQUNJLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN4QixDQUFDOzs7OztJQUVPLHNDQUFlOzs7O0lBQXZCO1FBQ0ksT0FBTyxtQkFBbUIsQ0FBQztJQUMvQixDQUFDOztnQkFwUEosVUFBVTs7OztnQkFYRixvQkFBb0IsdUJBNkJMLFFBQVE7O0lBb09oQyxtQkFBQztDQUFBLEFBdFBELElBc1BDO1NBclBZLFlBQVk7Ozs7Ozs7OztJQU9yQix1Q0FHRTs7Ozs7O0lBS0YsK0JBQXVDOzs7OztJQUVwQixnQ0FBa0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBDYWNoZU9wdGlvbnNJbnRlcmZhY2UgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2NhY2hlLm9wdGlvbnMuaW50ZXJmYWNlJztcclxuaW1wb3J0IHsgQ2FjaGVTdG9yYWdlc0VudW0gfSBmcm9tICcuLi9lbnVtcy9jYWNoZS5zdG9yYWdlcy5lbnVtJztcclxuaW1wb3J0IHsgQ2FjaGVTdG9yYWdlQWJzdHJhY3QgfSBmcm9tICcuL3N0b3JhZ2UvY2FjaGUuc3RvcmFnZS5hYnN0cmFjdC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ2FjaGVTZXNzaW9uU3RvcmFnZSB9IGZyb20gJy4vc3RvcmFnZS9zZXNzaW9uc3RvcmFnZS9jYWNoZS5zZXNzaW9uc3RvcmFnZS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ2FjaGVMb2NhbFN0b3JhZ2UgfSBmcm9tICcuL3N0b3JhZ2UvbG9jYWxzdG9yYWdlL2NhY2hlLmxvY2Fsc3RvcmFnZS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ2FjaGVNZW1vcnlTdG9yYWdlIH0gZnJvbSAnLi9zdG9yYWdlL21lbW9yeS9jYWNoZS5tZW1vcnkuc2VydmljZSc7XHJcbmltcG9ydCB7IFN0b3JhZ2VWYWx1ZUludGVyZmFjZSB9IGZyb20gJy4uL2ludGVyZmFjZXMvc3RvcmFnZS52YWx1ZS5pbnRlcmZhY2UnO1xyXG5cclxuY29uc3QgQ0FDSEVfUFJFRklYID0gJ0NhY2hlU2VydmljZSc7XHJcblxyXG5jb25zdCBERUZBVUxUX1NUT1JBR0UgPSBDYWNoZVN0b3JhZ2VzRW51bS5NRU1PUlk7XHJcbmNvbnN0IERFRkFVTFRfRU5BQkxFRF9TVE9SQUdFID0gQ2FjaGVTdG9yYWdlc0VudW0uU0VTU0lPTl9TVE9SQUdFO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQ2FjaGVTZXJ2aWNlIHtcclxuXHJcbiAgICAvKipcclxuICAgICAqIERlZmF1bHQgY2FjaGUgb3B0aW9uc1xyXG4gICAgICogQ2FjaGVPcHRpb25zSW50ZXJmYWNlXHJcbiAgICAgKiBcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfZGVmYXVsdE9wdGlvbnM6IENhY2hlT3B0aW9uc0ludGVyZmFjZSA9IHtcclxuICAgICAgICBleHBpcmVzOiBOdW1iZXIuTUFYX1ZBTFVFLFxyXG4gICAgICAgIG1heEFnZSA6IE51bWJlci5NQVhfVkFMVUVcclxuICAgIH07XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDYWNoZSBwcmVmaXhcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfcHJlZml4OiBzdHJpbmcgPSBDQUNIRV9QUkVGSVg7XHJcblxyXG4gICAgcHVibGljIGNvbnN0cnVjdG9yKEBPcHRpb25hbCgpIHByaXZhdGUgX3N0b3JhZ2U6IENhY2hlU3RvcmFnZUFic3RyYWN0KSB7XHJcbiAgICAgICAgdGhpcy5fdmFsaWRhdGVTdG9yYWdlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTZXQgZGF0YSB0byBjYWNoZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgc2V0KGtleTogc3RyaW5nLCB2YWx1ZTogYW55LCBvcHRpb25zPzogQ2FjaGVPcHRpb25zSW50ZXJmYWNlKSB7XHJcbiAgICAgICAgY29uc3Qgc3RvcmFnZUtleSA9IHRoaXMuX3RvU3RvcmFnZUtleShrZXkpO1xyXG4gICAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gb3B0aW9ucyA6IHRoaXMuX2RlZmF1bHRPcHRpb25zO1xyXG4gICAgICAgIGlmICh0aGlzLl9zdG9yYWdlLnNldEl0ZW0oc3RvcmFnZUtleSwgdGhpcy5fdG9TdG9yYWdlVmFsdWUodmFsdWUsIG9wdGlvbnMpKSkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuX2lzU3lzdGVtS2V5KGtleSkgJiYgb3B0aW9ucy50YWcpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3NhdmVUYWcob3B0aW9ucy50YWcsIHN0b3JhZ2VLZXkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0IGRhdGEgZnJvbSBjYWNoZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgZ2V0KGtleTogc3RyaW5nKTogYW55IHtcclxuICAgICAgICBjb25zdCBzdG9yYWdlVmFsdWUgPSB0aGlzLl9zdG9yYWdlLmdldEl0ZW0odGhpcy5fdG9TdG9yYWdlS2V5KGtleSkpO1xyXG4gICAgICAgIGxldCB2YWx1ZTogYW55ID0gbnVsbDtcclxuICAgICAgICBpZiAoc3RvcmFnZVZhbHVlKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl92YWxpZGF0ZVN0b3JhZ2VWYWx1ZShzdG9yYWdlVmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHN0b3JhZ2VWYWx1ZS52YWx1ZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlKGtleSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ2hlY2sgaWYgdmFsdWUgZXhpc3RzXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBleGlzdHMoa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gISF0aGlzLmdldChrZXkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmVtb3ZlIGl0ZW0gZnJvbSBjYWNoZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgcmVtb3ZlKGtleTogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5fc3RvcmFnZS5yZW1vdmVJdGVtKHRoaXMuX3RvU3RvcmFnZUtleShrZXkpKTtcclxuICAgICAgICB0aGlzLl9yZW1vdmVGcm9tVGFnKHRoaXMuX3RvU3RvcmFnZUtleShrZXkpKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJlbW92ZSBhbGwgZnJvbSBjYWNoZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgcmVtb3ZlQWxsKCkge1xyXG4gICAgICAgIHRoaXMuX3N0b3JhZ2UuY2xlYXIoKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldCBhbGwgdGFnIGRhdGFcclxuICAgICAqL1xyXG4gICAgcHVibGljIGdldFRhZ0RhdGEodGFnOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCB0YWdzID0gdGhpcy5nZXQodGhpcy5fdGFnc1N0b3JhZ2VLZXkoKSkgfHwge307XHJcbiAgICAgICAgY29uc3QgcmVzdWx0OiB7W2tleTogc3RyaW5nXTogYW55fSA9IHt9O1xyXG4gICAgICAgIGlmICh0YWdzW3RhZ10pIHtcclxuICAgICAgICAgICAgdGFnc1t0YWddLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gdGhpcy5nZXQodGhpcy5fZnJvbVN0b3JhZ2VLZXkoa2V5KSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFt0aGlzLl9mcm9tU3RvcmFnZUtleShrZXkpXSA9IGRhdGE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGNhY2hlIHdpdGggbmVlZGVkIHN0b3JhZ2VcclxuICAgICAqL1xyXG4gICAgcHVibGljIHVzZVN0b3JhZ2UodHlwZTogQ2FjaGVTdG9yYWdlc0VudW0pIHtcclxuICAgICAgICBjb25zdCBzZXJ2aWNlID0gbmV3IENhY2hlU2VydmljZSh0aGlzLl9pbml0U3RvcmFnZSh0eXBlKSk7XHJcbiAgICAgICAgc2VydmljZS5zZXRHbG9iYWxQcmVmaXgodGhpcy5fZ2V0Q2FjaGVQcmVmaXgoKSk7XHJcbiAgICAgICAgcmV0dXJuIHNlcnZpY2U7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZW1vdmUgYWxsIGJ5IHRhZ1xyXG4gICAgICovXHJcbiAgICBwdWJsaWMgcmVtb3ZlVGFnKHRhZzogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgdGFncyA9IHRoaXMuZ2V0KHRoaXMuX3RhZ3NTdG9yYWdlS2V5KCkpIHx8IHt9O1xyXG4gICAgICAgIGlmICh0YWdzW3RhZ10pIHtcclxuICAgICAgICAgICAgdGFnc1t0YWddLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9zdG9yYWdlLnJlbW92ZUl0ZW0oa2V5KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGRlbGV0ZSB0YWdzW3RhZ107XHJcbiAgICAgICAgICAgIHRoaXMuc2V0KHRoaXMuX3RhZ3NTdG9yYWdlS2V5KCksIHRhZ3MpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFNldCBnbG9iYWwgY2FjaGUga2V5IHByZWZpeFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgc2V0R2xvYmFsUHJlZml4KHByZWZpeDogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5fcHJlZml4ID0gcHJlZml4O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogVmFsaWRhdGUgY2FjaGUgc3RvcmFnZVxyXG4gICAgICogXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX3ZhbGlkYXRlU3RvcmFnZSgpIHtcclxuICAgICAgICBpZiAoIXRoaXMuX3N0b3JhZ2UpIHtcclxuICAgICAgICAgICAgdGhpcy5fc3RvcmFnZSA9IHRoaXMuX2luaXRTdG9yYWdlKERFRkFVTFRfU1RPUkFHRSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghdGhpcy5fc3RvcmFnZS5pc0VuYWJsZWQoKSkge1xyXG4gICAgICAgICAgICB0aGlzLl9zdG9yYWdlID0gdGhpcy5faW5pdFN0b3JhZ2UoREVGQVVMVF9FTkFCTEVEX1NUT1JBR0UpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJlbW92ZSBrZXkgZnJvbSB0YWdzIGtleXMgbGlzdFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9yZW1vdmVGcm9tVGFnKGtleTogc3RyaW5nKSB7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnByZWZlci1jb25zdFxyXG4gICAgICAgIGxldCB0YWdzID0gdGhpcy5nZXQodGhpcy5fdGFnc1N0b3JhZ2VLZXkoKSkgfHwge307XHJcbiAgICAgICAgbGV0IGluZGV4OiBudW1iZXI7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmZvcmluXHJcbiAgICAgICAgZm9yIChjb25zdCB0YWcgaW4gdGFncykge1xyXG4gICAgICAgICAgICBpbmRleCA9IHRhZ3NbdGFnXS5pbmRleE9mKGtleSk7XHJcbiAgICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIHRhZ3NbdGFnXS5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXQodGhpcy5fdGFnc1N0b3JhZ2VLZXkoKSwgdGFncyk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEluaXQgc3RvcmFnZSBieSB0eXBlXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX2luaXRTdG9yYWdlKHR5cGU6IENhY2hlU3RvcmFnZXNFbnVtKSB7XHJcbiAgICAgICAgbGV0IHN0b3JhZ2U6IENhY2hlU3RvcmFnZUFic3RyYWN0O1xyXG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlIENhY2hlU3RvcmFnZXNFbnVtLlNFU1NJT05fU1RPUkFHRTpcclxuICAgICAgICAgICAgICAgIHN0b3JhZ2UgPSBuZXcgQ2FjaGVTZXNzaW9uU3RvcmFnZSgpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgQ2FjaGVTdG9yYWdlc0VudW0uTE9DQUxfU1RPUkFHRTpcclxuICAgICAgICAgICAgICAgIHN0b3JhZ2UgPSBuZXcgQ2FjaGVMb2NhbFN0b3JhZ2UoKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OiBzdG9yYWdlID0gbmV3IENhY2hlTWVtb3J5U3RvcmFnZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc3RvcmFnZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF90b1N0b3JhZ2VLZXkoa2V5OiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0Q2FjaGVQcmVmaXgoKSArIGtleTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9mcm9tU3RvcmFnZUtleShrZXk6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiBrZXkucmVwbGFjZSh0aGlzLl9nZXRDYWNoZVByZWZpeCgpLCAnJyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBQcmVwYXJlIHZhbHVlIHRvIHNldCB0byBzdG9yYWdlXHJcbiAgICAgKlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF90b1N0b3JhZ2VWYWx1ZSh2YWx1ZTogYW55LCBvcHRpb25zOiBDYWNoZU9wdGlvbnNJbnRlcmZhY2UpOiBTdG9yYWdlVmFsdWVJbnRlcmZhY2Uge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSxcclxuICAgICAgICAgICAgb3B0aW9uczogdGhpcy5fdG9TdG9yYWdlT3B0aW9ucyhvcHRpb25zKVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBQcmVwYXJlIG9wdGlvbnMgdG8gc2V0IHRvIHN0b3JhZ2VcclxuICAgICAqIFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF90b1N0b3JhZ2VPcHRpb25zKG9wdGlvbnM6IENhY2hlT3B0aW9uc0ludGVyZmFjZSk6IENhY2hlT3B0aW9uc0ludGVyZmFjZSB7XHJcbiAgICAgICAgY29uc3Qgc3RvcmFnZU9wdGlvbnM6IENhY2hlT3B0aW9uc0ludGVyZmFjZSA9IHt9O1xyXG4gICAgICAgIHN0b3JhZ2VPcHRpb25zLmV4cGlyZXMgPSBvcHRpb25zLmV4cGlyZXMgPyBvcHRpb25zLmV4cGlyZXMgOlxyXG4gICAgICAgICAgICAob3B0aW9ucy5tYXhBZ2UgPyBEYXRlLm5vdygpICsgKG9wdGlvbnMubWF4QWdlICogMTAwMCkgOiB0aGlzLl9kZWZhdWx0T3B0aW9ucy5leHBpcmVzKTtcclxuICAgICAgICBzdG9yYWdlT3B0aW9ucy5tYXhBZ2UgPSBvcHRpb25zLm1heEFnZSA/IG9wdGlvbnMubWF4QWdlIDogdGhpcy5fZGVmYXVsdE9wdGlvbnMubWF4QWdlO1xyXG4gICAgICAgIHJldHVybiBzdG9yYWdlT3B0aW9ucztcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFZhbGlkYXRlIHN0b3JhZ2UgdmFsdWVcclxuICAgICAqXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX3ZhbGlkYXRlU3RvcmFnZVZhbHVlKHZhbHVlOiBTdG9yYWdlVmFsdWVJbnRlcmZhY2UpIHtcclxuICAgICAgICByZXR1cm4gISF2YWx1ZS5vcHRpb25zLmV4cGlyZXMgJiYgdmFsdWUub3B0aW9ucy5leHBpcmVzID4gRGF0ZS5ub3coKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIGNoZWNrIGlmIGl0cyBzeXN0ZW0gY2FjaGUga2V5XHJcbiAgICAgKiBcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfaXNTeXN0ZW1LZXkoa2V5OiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4gW3RoaXMuX3RhZ3NTdG9yYWdlS2V5KCldLmluZGV4T2Yoa2V5KSAhPT0gLTE7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTYXZlIHRhZyB0byBsaXN0IG9mIHRhZ3NcclxuICAgICAqIFxyXG4gICAgICogXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX3NhdmVUYWcodGFnOiBzdHJpbmcsIGtleTogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgdGFncyA9IHRoaXMuZ2V0KHRoaXMuX3RhZ3NTdG9yYWdlS2V5KCkpIHx8IHt9O1xyXG4gICAgICAgIGlmICghdGFnc1t0YWddKSB7XHJcbiAgICAgICAgICAgIHRhZ3NbdGFnXSA9IFtrZXldO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRhZ3NbdGFnXS5wdXNoKGtleSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc2V0KHRoaXMuX3RhZ3NTdG9yYWdlS2V5KCksIHRhZ3MpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0IGdsb2JhbCBjYWNoZSBwcmVmaXhcclxuICAgICAqIFxyXG4gICAgICogXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX2dldENhY2hlUHJlZml4KCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9wcmVmaXg7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfdGFnc1N0b3JhZ2VLZXkoKSB7XHJcbiAgICAgICAgcmV0dXJuICdDYWNoZVNlcnZpY2VfdGFncyc7XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==