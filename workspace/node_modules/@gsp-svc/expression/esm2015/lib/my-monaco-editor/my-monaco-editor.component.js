/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ElementRef, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { forwardRef, Inject, NgZone } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { pick } from 'lodash-es';
import { MY_MONACO_EDITOR_CONFIG } from './editorconfig';
import { CodeEditorEventService } from './my-monaco-editor-services/monaco-editor.event.service';
import { CODE_EDITOR_EVENTS } from './my-monaco-editor-services/events';
import { ExpressionEventService } from '../expression-event-service';
/** @type {?} */
let loadedMonaco = false;
/** @type {?} */
let loadPromise;
// 自定义输入控件:1.封装ControlValueAccessor
// https://code-examples.net/zh-CN/q/2154761
/** @type {?} */
export const CODE_EDITOR_INPUT_VALUE_ACCESSOR = {
    // https://blog.csdn.net/wangdan_2013/article/details/81314959
    provide: NG_VALUE_ACCESSOR,
    //
    useExisting: forwardRef((/**
     * @return {?}
     */
    () => MyMonacoEditorComponent)),
    //
    multi: true //
};
/** @type {?} */
const monacoConfig = {
    baseUrl: 'assets',
    defaultOptions: { scrollBeyondLastLine: false }
};
const ɵ0 = monacoConfig;
// 自定义输入控件 <-> Monaco Edtor
// 自定义输入控件:3.1 implements ControlValueAccessor 
export class MyMonacoEditorComponent {
    // 注入AngularMonacoEditorConfig，在创建Editor实例时设置config
    /**
     * @param {?} zone
     * @param {?} config
     * @param {?} codeEditorEventService
     * @param {?} eventService
     */
    constructor(zone, config, codeEditorEventService, eventService) {
        this.zone = zone;
        this.config = config;
        this.codeEditorEventService = codeEditorEventService;
        this.eventService = eventService;
        this._value = '';
        //ControlValueAccessor提供的事件回调
        this.onChangeHandler = (/**
         * @param {?} _
         * @return {?}
         */
        (_) => {
            this.codeEditorEventService.fireEvent({
                eventName: CODE_EDITOR_EVENTS.onChange,
                target: this,
                data: _
            });
        });
        //ControlValueAccessor提供的事件回调
        this.onTouchedHandler = (/**
         * @return {?}
         */
        () => {
            this.codeEditorEventService.fireEvent({
                eventName: CODE_EDITOR_EVENTS.onTouched,
                target: this
            });
        });
        // 初始化自定义事件
        /** @type {?} */
        const self = this;
        codeEditorEventService.eventNames.forEach((/**
         * @param {?} name
         * @return {?}
         */
        (name) => {
            // 创建自定义事件，此处作用等效于: @Output() onInit = new EventEmitter<any>() 
            self[name] = new EventEmitter();
            /** @type {?} */
            const eventPair = pick(self, name);
            codeEditorEventService.addEvent(eventPair);
        }));
    }
    /**
     * @param {?} options
     * @return {?}
     */
    set options(options) {
        // 默认options(this.config.defaultOptions) + 自定义options(options)
        this._options = Object.assign({}, this.config.defaultOptions, options);
        if (this._editor) {
            this._editor.dispose();
            this.initMonaco(options);
        }
    }
    /**
     * @return {?}
     */
    get options() {
        return this._options;
    }
    //在光标处插入表达式的方法
    /**
     * @param {?} insertWord
     * @return {?}
     */
    insertWord(insertWord) {
        if (insertWord && insertWord != undefined && insertWord != "") {
            /** @type {?} */
            let p = {
                lineNumber: 1,
                column: 1
            };
            if (this._editor) {
                p = this._editor.getPosition();
            }
            /** @type {?} */
            let range = new monaco.Range(p.lineNumber, p.column, p.lineNumber, p.column);
            /** @type {?} */
            let id = { major: 1, minor: 1 };
            /** @type {?} */
            let text = insertWord;
            /** @type {?} */
            let op = { identifier: id, range: range, text: text, forceMoveMarkers: true };
            this._editor.executeEdits("my-source", [op]);
        }
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        if (loadedMonaco) {
            // Wait until monaco editor is available
            loadPromise.then((/**
             * @return {?}
             */
            () => {
                this.initMonaco(this.options);
            }));
        }
        else {
            loadedMonaco = true;
            loadPromise = new Promise((/**
             * @param {?} resolve
             * @return {?}
             */
            (resolve) => {
                // const baseUrl = this.config.baseUrl || '/assets';
                /** @type {?} */
                const baseUrl = '/platform/common/web/caf';
                // if (typeof((<any>window).monaco) === 'object') {
                //   resolve();
                //   return;
                // }
                /** @type {?} */
                const onGotAmdLoader = (/**
                 * @return {?}
                 */
                () => {
                    // Load monaco
                    ((/** @type {?} */ (window))).require.config({ paths: { 'vs': `${baseUrl}/monaco/vs` } });
                    ((/** @type {?} */ (window))).require(['vs/editor/editor.main'], (/**
                     * @return {?}
                     */
                    () => {
                        this.onMonacoLoad();
                        this.initMonaco(this.options);
                        resolve();
                    }));
                });
                // Load AMD loader if necessary
                if (!((/** @type {?} */ (window))).require) {
                    /** @type {?} */
                    const loaderScript = document.createElement('script');
                    loaderScript.type = 'text/javascript';
                    loaderScript.src = `${baseUrl}/monaco/vs/loader.js`;
                    loaderScript.onload = onGotAmdLoader;
                    document.body.appendChild(loaderScript);
                }
                else {
                    onGotAmdLoader();
                }
            }));
        }
        //在光标处插入表达式事件订阅
        /** @type {?} */
        let temp = this;
        this.eventService.currentExpression().subscribe((/**
         * @param {?} insertexpression
         * @return {?}
         */
        (insertexpression) => {
            if (temp._editor != undefined) {
                temp.insertWord(insertexpression);
            }
        }));
        this.eventService.clearExpression().subscribe((/**
         * @return {?}
         */
        () => {
            if (temp._editor != undefined) {
                temp._editor.setValue("");
            }
        }));
    }
    /**
     * @private
     * @return {?}
     */
    onMonacoLoad() {
        /** @type {?} */
        const id = "foo.json";
        monaco.languages.json.jsonDefaults.setDiagnosticsOptions({
            validate: true,
            schemas: [{
                    uri: "http://myserver/foo-schema.json",
                    fileMatch: [id],
                    schema: {
                        type: "object",
                        properties: {
                            p1: {
                                enum: ["v1", "v2"]
                            },
                            p2: {
                                $ref: "http://myserver/bar-schema.json"
                            }
                        }
                    }
                }, {
                    uri: "http://myserver/bar-schema.json",
                    fileMatch: [id],
                    schema: {
                        type: "object",
                        properties: {
                            q1: {
                                enum: ["x1", "x2"]
                            }
                        }
                    }
                }]
        });
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        // if (this._windowResizeSubscription) {
        //   this._windowResizeSubscription.unsubscribe();
        // }
        if (this._editor) {
            this._editor.dispose();
            this._editor = undefined;
        }
    }
    /**
     * @protected
     * @param {?} options
     * @return {?}
     */
    initMonaco(options) {
        debugger;
        console.log("Init the custom monaco code editor.");
        // const hasModel = !!options.model;
        /** @type {?} */
        const hasModel = false;
        // if (hasModel) {
        //   options.model = monaco.editor.createModel(options.model.value, options.model.language, options.model.uri);
        // }
        this._editor = monaco.editor.create(this._editorComponent.nativeElement, options);
        if (!hasModel) {
            this._editor.setValue(this._value);
        }
        // monaco editor -> outside component
        this._editor.onDidChangeModelContent((/**
         * @return {?}
         */
        () => this.onChangeModelContentHandler()));
        this._editor.onDidBlurEditorText((/**
         * @return {?}
         */
        () => this.onBlurEditorTextHandler()));
        // refresh layout on resize event.
        // if (this._windowResizeSubscription) {
        //   this._windowResizeSubscription.unsubscribe();
        // }
        // this._windowResizeSubscription = fromEvent(window, 'resize').subscribe(() => this._editor.layout());
        this.codeEditorEventService.fireEvent({
            eventName: CODE_EDITOR_EVENTS.onInit,
            target: this,
            editor: this._editor
        });
    }
    /**
     * @return {?}
     */
    onChangeModelContentHandler() {
        /** @type {?} */
        const _value = this._editor.getValue();
        // monaco editor -> outside component
        // https://github.com/JTangming/tm/issues/4 ngZone详解
        this.zone.run((/**
         * @return {?}
         */
        () => this.value = _value)); // value is not propagated to parent when executing outside zone.
        // console.log("write from the monaco:" + this._value);
    }
    /**
     * @return {?}
     */
    onBlurEditorTextHandler() {
        this.onTouchedHandler();
    }
    //get accessor
    /**
     * @return {?}
     */
    get value() {
        return this._value;
    }
    ;
    //set accessor including call the onchange callback
    /**
     * @param {?} v
     * @return {?}
     */
    set value(v) {
        if (v !== this.value) { // 注意这种写法，值得学习
            this._value = v;
        }
        this.onChangeHandler(this.value); //在属性修饰器里调用onchangeHandler方法
    }
    /**
     * @return {?}
     */
    localEditor() {
        this.writeValue('test');
    }
    // 自定义输入控件:3.2 implements ControlValueAccesso
    // outside component -> monaco editor
    //From ControlValueAccessor interface
    /**
     * @param {?} value
     * @return {?}
     */
    writeValue(value) {
        this.value = value || '';
        // Fix for value change while dispose in process.
        setTimeout((/**
         * @return {?}
         */
        () => {
            if (this._editor /*&& !this.options.model*/) {
                this._editor.setValue(this._value);
                // console.log("write to the editor:" + this._value);
            }
        }));
    }
    //From ControlValueAccessor interface
    /**
     * @param {?} fn
     * @return {?}
     */
    registerOnChange(fn) {
        this.onChangeHandler(this);
    }
    //From ControlValueAccessor interface
    /**
     * @param {?} fn
     * @return {?}
     */
    registerOnTouched(fn) {
        this.onTouchedHandler();
    }
}
MyMonacoEditorComponent.decorators = [
    { type: Component, args: [{
                selector: 'app-my-monaco-editor',
                template: "<div class=\"editor h-100\" #codeEditor></div>",
                // 自定义输入控件:2.引入依赖服务ControlValueAccessor
                providers: [CODE_EDITOR_INPUT_VALUE_ACCESSOR,
                    CodeEditorEventService,
                    {
                        provide: MY_MONACO_EDITOR_CONFIG,
                        useValue: ɵ0
                    }
                ],
                styles: [":host{display:block;height:100%}"]
            }] }
];
/** @nocollapse */
MyMonacoEditorComponent.ctorParameters = () => [
    { type: NgZone },
    { type: undefined, decorators: [{ type: Inject, args: [MY_MONACO_EDITOR_CONFIG,] }] },
    { type: CodeEditorEventService },
    { type: ExpressionEventService }
];
MyMonacoEditorComponent.propDecorators = {
    _editorComponent: [{ type: ViewChild, args: ['codeEditor',] }],
    onInit: [{ type: Output }],
    onChange: [{ type: Output }],
    onTouched: [{ type: Output }],
    options: [{ type: Input, args: ['options',] }]
};
if (false) {
    /**
     * @type {?}
     * @protected
     */
    MyMonacoEditorComponent.prototype._editor;
    /**
     * @type {?}
     * @private
     */
    MyMonacoEditorComponent.prototype._options;
    /** @type {?} */
    MyMonacoEditorComponent.prototype._editorComponent;
    /** @type {?} */
    MyMonacoEditorComponent.prototype.onInit;
    /** @type {?} */
    MyMonacoEditorComponent.prototype.onChange;
    /** @type {?} */
    MyMonacoEditorComponent.prototype.onTouched;
    /**
     * @type {?}
     * @private
     */
    MyMonacoEditorComponent.prototype._value;
    /** @type {?} */
    MyMonacoEditorComponent.prototype.onChangeHandler;
    /** @type {?} */
    MyMonacoEditorComponent.prototype.onTouchedHandler;
    /**
     * @type {?}
     * @private
     */
    MyMonacoEditorComponent.prototype.zone;
    /**
     * @type {?}
     * @private
     */
    MyMonacoEditorComponent.prototype.config;
    /**
     * @type {?}
     * @private
     */
    MyMonacoEditorComponent.prototype.codeEditorEventService;
    /**
     * @type {?}
     * @private
     */
    MyMonacoEditorComponent.prototype.eventService;
    /* Skipping unhandled member: ;*/
}
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXktbW9uYWNvLWVkaXRvci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ3NwLXN2Yy9leHByZXNzaW9uLyIsInNvdXJjZXMiOlsibGliL215LW1vbmFjby1lZGl0b3IvbXktbW9uYWNvLWVkaXRvci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQVUsVUFBVSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQWEsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNqSCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0QsT0FBTyxFQUF3QixpQkFBaUIsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDakMsT0FBTyxFQUFFLHVCQUF1QixFQUF3QixNQUFNLGdCQUFnQixDQUFDO0FBQy9FLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHlEQUF5RCxDQUFDO0FBQ2pHLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDOztJQUlqRSxZQUFZLEdBQVksS0FBSzs7SUFDN0IsV0FBMEI7Ozs7QUFJOUIsTUFBTSxPQUFPLGdDQUFnQyxHQUFROztJQUVuRCxPQUFPLEVBQUUsaUJBQWlCOztJQUMxQixXQUFXLEVBQUUsVUFBVTs7O0lBQUMsR0FBRyxFQUFFLENBQUMsdUJBQXVCLEVBQUM7O0lBQ3RELEtBQUssRUFBRSxJQUFJLENBQUEsRUFBRTtDQUNkOztNQUNLLFlBQVksR0FBeUI7SUFDekMsT0FBTyxFQUFFLFFBQVE7SUFDakIsY0FBYyxFQUFFLEVBQUUsb0JBQW9CLEVBQUUsS0FBSyxFQUFFO0NBQ2hEO1dBVWUsWUFBWTtBQUs1QiwyQkFBMkI7QUFF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dCB7IENvbXBvbmVudCwgT25Jbml0LCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkRlc3Ryb3ksIE91dHB1dCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IGZvcndhcmRSZWYsIEluamVjdCwgTmdab25lIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBOR19WQUxVRV9BQ0NFU1NPUiB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcclxuaW1wb3J0IHsgcGljayB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IE1ZX01PTkFDT19FRElUT1JfQ09ORklHLCBNeU1vbmFjb0VkaXRvckNvbmZpZyB9IGZyb20gJy4vZWRpdG9yY29uZmlnJztcclxuaW1wb3J0IHsgQ29kZUVkaXRvckV2ZW50U2VydmljZSB9IGZyb20gJy4vbXktbW9uYWNvLWVkaXRvci1zZXJ2aWNlcy9tb25hY28tZWRpdG9yLmV2ZW50LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBDT0RFX0VESVRPUl9FVkVOVFMgfSBmcm9tICcuL215LW1vbmFjby1lZGl0b3Itc2VydmljZXMvZXZlbnRzJztcclxuaW1wb3J0IHsgRXhwcmVzc2lvbkV2ZW50U2VydmljZSB9IGZyb20gJy4uL2V4cHJlc3Npb24tZXZlbnQtc2VydmljZSc7XHJcblxyXG5kZWNsYXJlIGNvbnN0IG1vbmFjbzogYW55O1xyXG5cclxubGV0IGxvYWRlZE1vbmFjbzogYm9vbGVhbiA9IGZhbHNlO1xyXG5sZXQgbG9hZFByb21pc2U6IFByb21pc2U8dm9pZD47XHJcblxyXG4vLyDoh6rlrprkuYnovpPlhaXmjqfku7Y6MS7lsIHoo4VDb250cm9sVmFsdWVBY2Nlc3NvclxyXG4vLyBodHRwczovL2NvZGUtZXhhbXBsZXMubmV0L3poLUNOL3EvMjE1NDc2MVxyXG5leHBvcnQgY29uc3QgQ09ERV9FRElUT1JfSU5QVVRfVkFMVUVfQUNDRVNTT1I6IGFueSA9IHtcclxuICAvLyBodHRwczovL2Jsb2cuY3Nkbi5uZXQvd2FuZ2Rhbl8yMDEzL2FydGljbGUvZGV0YWlscy84MTMxNDk1OVxyXG4gIHByb3ZpZGU6IE5HX1ZBTFVFX0FDQ0VTU09SLC8vXHJcbiAgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gTXlNb25hY29FZGl0b3JDb21wb25lbnQpLC8vXHJcbiAgbXVsdGk6IHRydWUvL1xyXG59O1xyXG5jb25zdCBtb25hY29Db25maWc6IE15TW9uYWNvRWRpdG9yQ29uZmlnID0ge1xyXG4gIGJhc2VVcmw6ICdhc3NldHMnLFxyXG4gIGRlZmF1bHRPcHRpb25zOiB7IHNjcm9sbEJleW9uZExhc3RMaW5lOiBmYWxzZSB9XHJcbn07XHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAnYXBwLW15LW1vbmFjby1lZGl0b3InLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9teS1tb25hY28tZWRpdG9yLmNvbXBvbmVudC5odG1sJyxcclxuICBzdHlsZVVybHM6IFsnLi9teS1tb25hY28tZWRpdG9yLmNvbXBvbmVudC5jc3MnXSxcclxuICAvLyDoh6rlrprkuYnovpPlhaXmjqfku7Y6Mi7lvJXlhaXkvp3otZbmnI3liqFDb250cm9sVmFsdWVBY2Nlc3NvclxyXG4gIHByb3ZpZGVyczogW0NPREVfRURJVE9SX0lOUFVUX1ZBTFVFX0FDQ0VTU09SLFxyXG4gICAgQ29kZUVkaXRvckV2ZW50U2VydmljZSxcclxuICAgIHtcclxuICAgICAgcHJvdmlkZTogTVlfTU9OQUNPX0VESVRPUl9DT05GSUcsXHJcbiAgICAgIHVzZVZhbHVlOiBtb25hY29Db25maWdcclxuICAgIH1cclxuICBdXHJcbn0pXHJcblxyXG4vLyDoh6rlrprkuYnovpPlhaXmjqfku7YgPC0+IE1vbmFjbyBFZHRvclxyXG5cclxuLy8g6Ieq5a6a5LmJ6L6T5YWl5o6n5Lu2OjMuMSBpbXBsZW1lbnRzIENvbnRyb2xWYWx1ZUFjY2Vzc29yIFxyXG5leHBvcnQgY2xhc3MgTXlNb25hY29FZGl0b3JDb21wb25lbnQgaW1wbGVtZW50cyBDb250cm9sVmFsdWVBY2Nlc3NvciwgT25EZXN0cm95LCBPbkluaXQge1xyXG4gIHByb3RlY3RlZCBfZWRpdG9yOiBhbnk7XHJcbiAgcHJpdmF0ZSBfb3B0aW9uczogYW55O1xyXG4gIC8vIHByb3RlY3RlZCBfd2luZG93UmVzaXplU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ2NvZGVFZGl0b3InKSBfZWRpdG9yQ29tcG9uZW50OiBFbGVtZW50UmVmOyAvL+WKqOaAgea3u+WKoOS7o+eggee8lui+keWZqFxyXG4gIEBPdXRwdXQoKSBvbkluaXQ7XHJcbiAgQE91dHB1dCgpIG9uQ2hhbmdlO1xyXG4gIEBPdXRwdXQoKSBvblRvdWNoZWQ7XHJcblxyXG4gIEBJbnB1dCgnb3B0aW9ucycpXHJcbiAgc2V0IG9wdGlvbnMob3B0aW9uczogYW55KSB7XHJcbiAgICAvLyDpu5jorqRvcHRpb25zKHRoaXMuY29uZmlnLmRlZmF1bHRPcHRpb25zKSArIOiHquWumuS5iW9wdGlvbnMob3B0aW9ucylcclxuICAgIHRoaXMuX29wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmNvbmZpZy5kZWZhdWx0T3B0aW9ucywgb3B0aW9ucyk7XHJcbiAgICBpZiAodGhpcy5fZWRpdG9yKSB7XHJcbiAgICAgIHRoaXMuX2VkaXRvci5kaXNwb3NlKCk7XHJcbiAgICAgIHRoaXMuaW5pdE1vbmFjbyhvcHRpb25zKTtcclxuICAgIH1cclxuICB9XHJcbiAgZ2V0IG9wdGlvbnMoKTogYW55IHtcclxuICAgIHJldHVybiB0aGlzLl9vcHRpb25zO1xyXG4gIH1cclxuXHJcbiAgLy/lnKjlhYnmoIflpITmj5LlhaXooajovr7lvI/nmoTmlrnms5VcclxuICBpbnNlcnRXb3JkKGluc2VydFdvcmQ6IHN0cmluZykge1xyXG4gICAgaWYgKGluc2VydFdvcmQgJiYgaW5zZXJ0V29yZCAhPSB1bmRlZmluZWQgJiYgaW5zZXJ0V29yZCAhPSBcIlwiKSB7XHJcbiAgICAgIGxldCBwID0ge1xyXG4gICAgICAgIGxpbmVOdW1iZXI6IDEsXHJcbiAgICAgICAgY29sdW1uOiAxXHJcbiAgICAgIH07XHJcbiAgICAgIGlmICh0aGlzLl9lZGl0b3IpIHtcclxuICAgICAgICBwID0gdGhpcy5fZWRpdG9yLmdldFBvc2l0aW9uKCk7XHJcbiAgICAgIH1cclxuICAgICAgbGV0IHJhbmdlID0gbmV3IG1vbmFjby5SYW5nZShwLmxpbmVOdW1iZXIsXHJcbiAgICAgICAgcC5jb2x1bW4sXHJcbiAgICAgICAgcC5saW5lTnVtYmVyLFxyXG4gICAgICAgIHAuY29sdW1uKTtcclxuICAgICAgbGV0IGlkID0geyBtYWpvcjogMSwgbWlub3I6IDEgfTtcclxuICAgICAgbGV0IHRleHQgPSBpbnNlcnRXb3JkO1xyXG4gICAgICBsZXQgb3AgPSB7IGlkZW50aWZpZXI6IGlkLCByYW5nZTogcmFuZ2UsIHRleHQ6IHRleHQsIGZvcmNlTW92ZU1hcmtlcnM6IHRydWUgfTtcclxuICAgICAgdGhpcy5fZWRpdG9yLmV4ZWN1dGVFZGl0cyhcIm15LXNvdXJjZVwiLCBbb3BdKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOazqOWFpUFuZ3VsYXJNb25hY29FZGl0b3JDb25maWfvvIzlnKjliJvlu7pFZGl0b3Llrp7kvovml7borr7nva5jb25maWdcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHpvbmU6IE5nWm9uZSwgQEluamVjdChNWV9NT05BQ09fRURJVE9SX0NPTkZJRykgcHJpdmF0ZSBjb25maWc6IE15TW9uYWNvRWRpdG9yQ29uZmlnLCBwcml2YXRlIGNvZGVFZGl0b3JFdmVudFNlcnZpY2U6IENvZGVFZGl0b3JFdmVudFNlcnZpY2UsIHByaXZhdGUgZXZlbnRTZXJ2aWNlOiBFeHByZXNzaW9uRXZlbnRTZXJ2aWNlKSB7XHJcblxyXG4gICAgLy8g5Yid5aeL5YyW6Ieq5a6a5LmJ5LqL5Lu2XHJcbiAgICBjb25zdCBzZWxmID0gdGhpcztcclxuICAgIGNvZGVFZGl0b3JFdmVudFNlcnZpY2UuZXZlbnROYW1lcy5mb3JFYWNoKChuYW1lKSA9PiB7XHJcbiAgICAgIC8vIOWIm+W7uuiHquWumuS5ieS6i+S7tu+8jOatpOWkhOS9nOeUqOetieaViOS6jjogQE91dHB1dCgpIG9uSW5pdCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpIFxyXG4gICAgICBzZWxmW25hbWVdID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcbiAgICAgIGNvbnN0IGV2ZW50UGFpciA9IHBpY2soc2VsZiwgbmFtZSk7XHJcbiAgICAgIGNvZGVFZGl0b3JFdmVudFNlcnZpY2UuYWRkRXZlbnQoZXZlbnRQYWlyKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICBpZiAobG9hZGVkTW9uYWNvKSB7XHJcbiAgICAgIC8vIFdhaXQgdW50aWwgbW9uYWNvIGVkaXRvciBpcyBhdmFpbGFibGVcclxuICAgICAgbG9hZFByb21pc2UudGhlbigoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5pbml0TW9uYWNvKHRoaXMub3B0aW9ucyk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbG9hZGVkTW9uYWNvID0gdHJ1ZTtcclxuICAgICAgbG9hZFByb21pc2UgPSBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZTogYW55KSA9PiB7XHJcbiAgICAgICAgLy8gY29uc3QgYmFzZVVybCA9IHRoaXMuY29uZmlnLmJhc2VVcmwgfHwgJy9hc3NldHMnO1xyXG4gICAgICAgIGNvbnN0IGJhc2VVcmwgPSAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvY2FmJztcclxuICAgICAgICAvLyBpZiAodHlwZW9mKCg8YW55PndpbmRvdykubW9uYWNvKSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICAvLyAgIHJlc29sdmUoKTtcclxuICAgICAgICAvLyAgIHJldHVybjtcclxuICAgICAgICAvLyB9XHJcbiAgICAgICAgY29uc3Qgb25Hb3RBbWRMb2FkZXI6IGFueSA9ICgpID0+IHtcclxuICAgICAgICAgIC8vIExvYWQgbW9uYWNvXHJcbiAgICAgICAgICAoPGFueT53aW5kb3cpLnJlcXVpcmUuY29uZmlnKHsgcGF0aHM6IHsgJ3ZzJzogYCR7YmFzZVVybH0vbW9uYWNvL3ZzYCB9IH0pO1xyXG4gICAgICAgICAgKDxhbnk+d2luZG93KS5yZXF1aXJlKFsndnMvZWRpdG9yL2VkaXRvci5tYWluJ10sICgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5vbk1vbmFjb0xvYWQoKTtcclxuICAgICAgICAgICAgdGhpcy5pbml0TW9uYWNvKHRoaXMub3B0aW9ucyk7XHJcbiAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vIExvYWQgQU1EIGxvYWRlciBpZiBuZWNlc3NhcnlcclxuICAgICAgICBpZiAoISg8YW55PndpbmRvdykucmVxdWlyZSkge1xyXG4gICAgICAgICAgY29uc3QgbG9hZGVyU2NyaXB0OiBIVE1MU2NyaXB0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xyXG4gICAgICAgICAgbG9hZGVyU2NyaXB0LnR5cGUgPSAndGV4dC9qYXZhc2NyaXB0JztcclxuICAgICAgICAgIGxvYWRlclNjcmlwdC5zcmMgPSBgJHtiYXNlVXJsfS9tb25hY28vdnMvbG9hZGVyLmpzYDtcclxuICAgICAgICAgIGxvYWRlclNjcmlwdC5vbmxvYWQgPSBvbkdvdEFtZExvYWRlcjtcclxuICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobG9hZGVyU2NyaXB0KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgb25Hb3RBbWRMb2FkZXIoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgLy/lnKjlhYnmoIflpITmj5LlhaXooajovr7lvI/kuovku7borqLpmIVcclxuICAgIGxldCB0ZW1wID0gdGhpcztcclxuICAgIHRoaXMuZXZlbnRTZXJ2aWNlLmN1cnJlbnRFeHByZXNzaW9uKCkuc3Vic2NyaWJlKChpbnNlcnRleHByZXNzaW9uOiBhbnkpID0+IHtcclxuICAgICAgaWYgKHRlbXAuX2VkaXRvciAhPSB1bmRlZmluZWQpIHtcclxuICAgICAgICB0ZW1wLmluc2VydFdvcmQoaW5zZXJ0ZXhwcmVzc2lvbilcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICB0aGlzLmV2ZW50U2VydmljZS5jbGVhckV4cHJlc3Npb24oKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICBpZiAodGVtcC5fZWRpdG9yICE9IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIHRlbXAuX2VkaXRvci5zZXRWYWx1ZShcIlwiKVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgb25Nb25hY29Mb2FkKCk6IHZvaWQge1xyXG4gICAgY29uc3QgaWQgPSBcImZvby5qc29uXCI7XHJcbiAgICBtb25hY28ubGFuZ3VhZ2VzLmpzb24uanNvbkRlZmF1bHRzLnNldERpYWdub3N0aWNzT3B0aW9ucyh7XHJcbiAgICAgIHZhbGlkYXRlOiB0cnVlLFxyXG4gICAgICBzY2hlbWFzOiBbe1xyXG4gICAgICAgIHVyaTogXCJodHRwOi8vbXlzZXJ2ZXIvZm9vLXNjaGVtYS5qc29uXCIsXHJcbiAgICAgICAgZmlsZU1hdGNoOiBbaWRdLFxyXG4gICAgICAgIHNjaGVtYToge1xyXG4gICAgICAgICAgdHlwZTogXCJvYmplY3RcIixcclxuICAgICAgICAgIHByb3BlcnRpZXM6IHtcclxuICAgICAgICAgICAgcDE6IHtcclxuICAgICAgICAgICAgICBlbnVtOiBbXCJ2MVwiLCBcInYyXCJdXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHAyOiB7XHJcbiAgICAgICAgICAgICAgJHJlZjogXCJodHRwOi8vbXlzZXJ2ZXIvYmFyLXNjaGVtYS5qc29uXCJcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSwge1xyXG4gICAgICAgIHVyaTogXCJodHRwOi8vbXlzZXJ2ZXIvYmFyLXNjaGVtYS5qc29uXCIsXHJcbiAgICAgICAgZmlsZU1hdGNoOiBbaWRdLFxyXG4gICAgICAgIHNjaGVtYToge1xyXG4gICAgICAgICAgdHlwZTogXCJvYmplY3RcIixcclxuICAgICAgICAgIHByb3BlcnRpZXM6IHtcclxuICAgICAgICAgICAgcTE6IHtcclxuICAgICAgICAgICAgICBlbnVtOiBbXCJ4MVwiLCBcIngyXCJdXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1dXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICAvLyBpZiAodGhpcy5fd2luZG93UmVzaXplU3Vic2NyaXB0aW9uKSB7XHJcbiAgICAvLyAgIHRoaXMuX3dpbmRvd1Jlc2l6ZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgLy8gfVxyXG4gICAgaWYgKHRoaXMuX2VkaXRvcikge1xyXG4gICAgICB0aGlzLl9lZGl0b3IuZGlzcG9zZSgpO1xyXG4gICAgICB0aGlzLl9lZGl0b3IgPSB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgaW5pdE1vbmFjbyhvcHRpb25zOiBhbnkpOiB2b2lkIHtcclxuICAgIGRlYnVnZ2VyO1xyXG4gICAgY29uc29sZS5sb2coXCJJbml0IHRoZSBjdXN0b20gbW9uYWNvIGNvZGUgZWRpdG9yLlwiKTtcclxuXHJcbiAgICAvLyBjb25zdCBoYXNNb2RlbCA9ICEhb3B0aW9ucy5tb2RlbDtcclxuICAgIGNvbnN0IGhhc01vZGVsID0gZmFsc2U7XHJcblxyXG4gICAgLy8gaWYgKGhhc01vZGVsKSB7XHJcbiAgICAvLyAgIG9wdGlvbnMubW9kZWwgPSBtb25hY28uZWRpdG9yLmNyZWF0ZU1vZGVsKG9wdGlvbnMubW9kZWwudmFsdWUsIG9wdGlvbnMubW9kZWwubGFuZ3VhZ2UsIG9wdGlvbnMubW9kZWwudXJpKTtcclxuICAgIC8vIH1cclxuXHJcbiAgICB0aGlzLl9lZGl0b3IgPSBtb25hY28uZWRpdG9yLmNyZWF0ZSh0aGlzLl9lZGl0b3JDb21wb25lbnQubmF0aXZlRWxlbWVudCwgb3B0aW9ucyk7XHJcblxyXG4gICAgaWYgKCFoYXNNb2RlbCkge1xyXG4gICAgICB0aGlzLl9lZGl0b3Iuc2V0VmFsdWUodGhpcy5fdmFsdWUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIG1vbmFjbyBlZGl0b3IgLT4gb3V0c2lkZSBjb21wb25lbnRcclxuICAgIHRoaXMuX2VkaXRvci5vbkRpZENoYW5nZU1vZGVsQ29udGVudCgoKSA9PiB0aGlzLm9uQ2hhbmdlTW9kZWxDb250ZW50SGFuZGxlcigpKTtcclxuXHJcbiAgICB0aGlzLl9lZGl0b3Iub25EaWRCbHVyRWRpdG9yVGV4dCgoKSA9PiB0aGlzLm9uQmx1ckVkaXRvclRleHRIYW5kbGVyKCkpO1xyXG5cclxuICAgIC8vIHJlZnJlc2ggbGF5b3V0IG9uIHJlc2l6ZSBldmVudC5cclxuICAgIC8vIGlmICh0aGlzLl93aW5kb3dSZXNpemVTdWJzY3JpcHRpb24pIHtcclxuICAgIC8vICAgdGhpcy5fd2luZG93UmVzaXplU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAvLyB9XHJcbiAgICAvLyB0aGlzLl93aW5kb3dSZXNpemVTdWJzY3JpcHRpb24gPSBmcm9tRXZlbnQod2luZG93LCAncmVzaXplJykuc3Vic2NyaWJlKCgpID0+IHRoaXMuX2VkaXRvci5sYXlvdXQoKSk7XHJcblxyXG4gICAgdGhpcy5jb2RlRWRpdG9yRXZlbnRTZXJ2aWNlLmZpcmVFdmVudCh7XHJcbiAgICAgIGV2ZW50TmFtZTogQ09ERV9FRElUT1JfRVZFTlRTLm9uSW5pdCxcclxuICAgICAgdGFyZ2V0OiB0aGlzLFxyXG4gICAgICBlZGl0b3I6IHRoaXMuX2VkaXRvclxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBvbkNoYW5nZU1vZGVsQ29udGVudEhhbmRsZXIoKSB7XHJcbiAgICBjb25zdCBfdmFsdWUgPSB0aGlzLl9lZGl0b3IuZ2V0VmFsdWUoKTtcclxuXHJcbiAgICAvLyBtb25hY28gZWRpdG9yIC0+IG91dHNpZGUgY29tcG9uZW50XHJcbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vSlRhbmdtaW5nL3RtL2lzc3Vlcy80IG5nWm9uZeivpuino1xyXG4gICAgdGhpcy56b25lLnJ1bigoKSA9PiB0aGlzLnZhbHVlID0gX3ZhbHVlKTsvLyB2YWx1ZSBpcyBub3QgcHJvcGFnYXRlZCB0byBwYXJlbnQgd2hlbiBleGVjdXRpbmcgb3V0c2lkZSB6b25lLlxyXG4gICAgLy8gY29uc29sZS5sb2coXCJ3cml0ZSBmcm9tIHRoZSBtb25hY286XCIgKyB0aGlzLl92YWx1ZSk7XHJcbiAgfVxyXG5cclxuICBvbkJsdXJFZGl0b3JUZXh0SGFuZGxlcigpIHtcclxuXHJcbiAgICB0aGlzLm9uVG91Y2hlZEhhbmRsZXIoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX3ZhbHVlOiBzdHJpbmcgPSAnJztcclxuXHJcbiAgLy9nZXQgYWNjZXNzb3JcclxuICBnZXQgdmFsdWUoKTogYW55IHtcclxuICAgIHJldHVybiB0aGlzLl92YWx1ZTtcclxuICB9O1xyXG5cclxuICAvL3NldCBhY2Nlc3NvciBpbmNsdWRpbmcgY2FsbCB0aGUgb25jaGFuZ2UgY2FsbGJhY2tcclxuICBzZXQgdmFsdWUodjogYW55KSB7XHJcbiAgICBpZiAodiAhPT0gdGhpcy52YWx1ZSkgey8vIOazqOaEj+i/meenjeWGmeazle+8jOWAvOW+l+WtpuS5oFxyXG4gICAgICB0aGlzLl92YWx1ZSA9IHY7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5vbkNoYW5nZUhhbmRsZXIodGhpcy52YWx1ZSk7Ly/lnKjlsZ7mgKfkv67ppbDlmajph4zosIPnlKhvbmNoYW5nZUhhbmRsZXLmlrnms5VcclxuICB9XHJcblxyXG4gIGxvY2FsRWRpdG9yKCkgey8vRGVtbzogb3V0c2lkZSBjb21wb25lbnQgLT4gbW9uYWNvIGVkaXRvclxyXG4gICAgdGhpcy53cml0ZVZhbHVlKCd0ZXN0Jyk7XHJcbiAgfVxyXG5cclxuICAvLyDoh6rlrprkuYnovpPlhaXmjqfku7Y6My4yIGltcGxlbWVudHMgQ29udHJvbFZhbHVlQWNjZXNzb1xyXG5cclxuICAvLyBvdXRzaWRlIGNvbXBvbmVudCAtPiBtb25hY28gZWRpdG9yXHJcblxyXG4gIC8vRnJvbSBDb250cm9sVmFsdWVBY2Nlc3NvciBpbnRlcmZhY2VcclxuICB3cml0ZVZhbHVlKHZhbHVlOiBhbnkpIHtcclxuICAgIHRoaXMudmFsdWUgPSB2YWx1ZSB8fCAnJztcclxuXHJcbiAgICAvLyBGaXggZm9yIHZhbHVlIGNoYW5nZSB3aGlsZSBkaXNwb3NlIGluIHByb2Nlc3MuXHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgaWYgKHRoaXMuX2VkaXRvciAvKiYmICF0aGlzLm9wdGlvbnMubW9kZWwqLykge1xyXG4gICAgICAgIHRoaXMuX2VkaXRvci5zZXRWYWx1ZSh0aGlzLl92YWx1ZSk7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJ3cml0ZSB0byB0aGUgZWRpdG9yOlwiICsgdGhpcy5fdmFsdWUpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8vRnJvbSBDb250cm9sVmFsdWVBY2Nlc3NvciBpbnRlcmZhY2VcclxuICByZWdpc3Rlck9uQ2hhbmdlKGZuOiBhbnkpIHtcclxuICAgIHRoaXMub25DaGFuZ2VIYW5kbGVyKHRoaXMpO1xyXG4gIH1cclxuXHJcbiAgLy9Gcm9tIENvbnRyb2xWYWx1ZUFjY2Vzc29yIGludGVyZmFjZVxyXG4gIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiBhbnkpIHtcclxuICAgIHRoaXMub25Ub3VjaGVkSGFuZGxlcigpO1xyXG4gIH1cclxuXHJcbiAgLy9Db250cm9sVmFsdWVBY2Nlc3NvcuaPkOS+m+eahOS6i+S7tuWbnuiwg1xyXG4gIG9uQ2hhbmdlSGFuZGxlciA9IChfOiBhbnkpID0+IHsgLy9Qcm9wYWdhdGUgQ2hhbmdlIHRvIG91dHNpZGVcclxuICAgIHRoaXMuY29kZUVkaXRvckV2ZW50U2VydmljZS5maXJlRXZlbnQoe1xyXG4gICAgICBldmVudE5hbWU6IENPREVfRURJVE9SX0VWRU5UUy5vbkNoYW5nZSxcclxuICAgICAgdGFyZ2V0OiB0aGlzLFxyXG4gICAgICBkYXRhOiBfXHJcbiAgICB9KTtcclxuICB9O1xyXG5cclxuICAvL0NvbnRyb2xWYWx1ZUFjY2Vzc29y5o+Q5L6b55qE5LqL5Lu25Zue6LCDXHJcbiAgb25Ub3VjaGVkSGFuZGxlciA9ICgpID0+IHtcclxuICAgIHRoaXMuY29kZUVkaXRvckV2ZW50U2VydmljZS5maXJlRXZlbnQoe1xyXG4gICAgICBldmVudE5hbWU6IENPREVfRURJVE9SX0VWRU5UUy5vblRvdWNoZWQsXHJcbiAgICAgIHRhcmdldDogdGhpc1xyXG4gICAgfSk7XHJcbiAgfTtcclxufSJdfQ==