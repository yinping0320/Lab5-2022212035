/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Injector, ComponentFactoryResolver, LOCALE_ID } from '@angular/core';
import { FileUploadComponent } from './upload/file-upload/file-upload.component';
import { BsModalService } from '@farris/ui-modal';
import { of } from 'rxjs';
import { LocalLangPipe } from './local.pipe';
export class UploadDialogService {
    /**
     * @param {?} modalService
     * @param {?} componentFactoryResolver
     * @param {?} injector
     */
    constructor(modalService, componentFactoryResolver, injector) {
        this.modalService = modalService;
        this.componentFactoryResolver = componentFactoryResolver;
        this.injector = injector;
        this.fileInfoList = [];
        if (this.injector) {
            this.modalService = this.injector.get(BsModalService);
            this.localeid = localStorage.getItem("languageCode") || this.injector.get(LOCALE_ID);
            this.localpipe = new LocalLangPipe(this.localeid);
        }
    }
    /**
     * @param {?} formId
     * @param {?} rootId
     * @return {?}
     */
    showDialog(formId, rootId) {
        /** @type {?} */
        let flag = 0;
        return new Promise((/**
         * @param {?} resolve
         * @return {?}
         */
        resolve => {
            /** @type {?} */
            var viewerFactory = this.componentFactoryResolver.resolveComponentFactory(FileUploadComponent);
            /** @type {?} */
            var viewerRef = viewerFactory.create(this.injector);
            viewerRef.instance.rootId = rootId;
            viewerRef.instance.formId = formId;
            this.dlg = this.modalService.show(viewerRef, {
                title: this.localpipe.transform('uploadFile'),
                width: 950, height: 570,
                buttons: [
                    {
                        text: this.localpipe.transform('save'), cls: 'k-button k-button-icontext k-primary', handle: (/**
                         * @return {?}
                         */
                        () => {
                            this.dlg.content.upload().subscribe((/**
                             * @param {?} res
                             * @return {?}
                             */
                            res => {
                                if (res) {
                                    resolve(res);
                                    flag = 1;
                                    this.dlg.close();
                                }
                            }));
                        })
                    },
                    {
                        text: this.localpipe.transform('close'), cls: 'k-button k-button-icontext', handle: (/**
                         * @return {?}
                         */
                        () => {
                            this.dlg.close();
                        })
                    }
                ],
                showButtons: true,
                showMaxButton: false,
                beforeClose: (/**
                 * @return {?}
                 */
                () => {
                    if (flag == 0)
                        this.dlg.content.cancel();
                    return of(true);
                })
            });
        }));
    }
    /**
     * @param {?} formId
     * @param {?} rootId
     * @param {?=} oldIdList
     * @return {?}
     */
    uploadFile(formId, rootId, oldIdList = []) {
        return this.uploadFileWithLimit(formId, rootId, null, oldIdList);
    }
    /**
     * @param {?} formId
     * @param {?} rootId
     * @param {?} limit
     * @param {?=} oldIdList
     * @return {?}
     */
    uploadFileWithLimit(formId, rootId, limit, oldIdList = []) {
        /** @type {?} */
        let flag = 0;
        return new Promise((/**
         * @param {?} resolve
         * @return {?}
         */
        resolve => {
            /** @type {?} */
            var uploadFactory = this.componentFactoryResolver.resolveComponentFactory(FileUploadComponent);
            /** @type {?} */
            var uploadRef = uploadFactory.create(this.injector);
            if (limit != null) {
                uploadRef.instance.fileCount = limit.fileCount;
                uploadRef.instance.securityInfo = limit.securityInfo;
                if (limit.fileType != null && limit.fileType != "")
                    uploadRef.instance.fileType = limit.fileType;
            }
            uploadRef.instance.rootId = rootId;
            uploadRef.instance.formId = formId;
            uploadRef.instance.oldIdList = oldIdList;
            this.dlg = this.modalService.show(uploadRef, {
                title: this.localpipe.transform('uploadFile'),
                width: 950, height: 570,
                buttons: [
                    {
                        text: this.localpipe.transform('save'), cls: 'k-button k-button-icontext k-primary', handle: (/**
                         * @return {?}
                         */
                        () => {
                            this.dlg.content.upload().subscribe((/**
                             * @param {?} res
                             * @return {?}
                             */
                            res => {
                                if (res) {
                                    resolve(res);
                                    flag = 1;
                                    this.dlg.close();
                                }
                            }));
                        })
                    },
                    {
                        text: this.localpipe.transform('close'), cls: 'k-button k-button-icontext', handle: (/**
                         * @return {?}
                         */
                        () => {
                            this.dlg.close();
                        })
                    }
                ],
                showButtons: true,
                showMaxButton: false,
                beforeClose: (/**
                 * @return {?}
                 */
                () => {
                    if (flag == 0)
                        this.dlg.content.cancel();
                    return of(true);
                })
            });
        }));
    }
}
UploadDialogService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
UploadDialogService.ctorParameters = () => [
    { type: BsModalService },
    { type: ComponentFactoryResolver },
    { type: Injector }
];
if (false) {
    /** @type {?} */
    UploadDialogService.prototype.localeid;
    /** @type {?} */
    UploadDialogService.prototype.localpipe;
    /** @type {?} */
    UploadDialogService.prototype.dlg;
    /** @type {?} */
    UploadDialogService.prototype.fileInfoList;
    /**
     * @type {?}
     * @private
     */
    UploadDialogService.prototype.modalService;
    /**
     * @type {?}
     * @private
     */
    UploadDialogService.prototype.componentFactoryResolver;
    /**
     * @type {?}
     * @private
     */
    UploadDialogService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkZGlhbG9nLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ3NwLXN2Yy9mb3JtZG9jLXVwbG9hZC8iLCJzb3VyY2VzIjpbImxpYi91cGxvYWRkaWFsb2cuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsd0JBQXdCLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFGLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDRDQUE0QyxDQUFDO0FBQ2pGLE9BQU8sRUFBRSxjQUFjLEVBQWMsTUFBTSxrQkFBa0IsQ0FBQztBQUU5RCxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRXRDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFJN0MsTUFBTSxPQUFPLG1CQUFtQjs7Ozs7O0lBSTVCLFlBQW9CLFlBQTRCLEVBQVUsd0JBQWtELEVBQVUsUUFBa0I7UUFBcEgsaUJBQVksR0FBWixZQUFZLENBQWdCO1FBQVUsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjtRQUFVLGFBQVEsR0FBUixRQUFRLENBQVU7UUFVeEksaUJBQVksR0FBcUIsRUFBRSxDQUFDO1FBVGhDLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNmLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDdEQsSUFBSSxDQUFDLFFBQVEsR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3JGLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3JEO0lBQ0wsQ0FBQzs7Ozs7O0lBTUQsVUFBVSxDQUFDLE1BQWMsRUFB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QUFFLE1BQU07Ozt3QkFBRSxHQUFHLEVBQUU7NEJBQ3JGLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7d0JBQ3JCLENBQUMsQ0FBQTtxQkFDSjtpQkFDSjtnQkFFRCxXQUFXLEVBQUUsSUFBSTtnQkFDakIsYUFBYSxFQUFFLEtBQUs7Z0JBQ3BCLFdBQVc7OztnQkFBRSxHQUF3QixFQUFFO29CQUNuQyxJQUFJLElBQUksSUFBSSxDQUFDO3dCQUNULElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO29CQUM5QixPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDcEIsQ0FBQyxDQUFBO2FBQ0osQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxFQUFDLENBQUE7SUFDTixDQUFDOzs7WUFwSEosVUFBVTs7OztZQVBGLGNBQWM7WUFGUSx3QkFBd0I7WUFBbEMsUUFBUTs7OztJQVl6Qix1Q0FBaUI7O0lBQ2pCLHdDQUF5Qjs7SUFTekIsa0NBQWdCOztJQUVoQiwyQ0FBb0M7Ozs7O0lBVnhCLDJDQUFvQzs7Ozs7SUFBRSx1REFBMEQ7Ozs7O0lBQUUsdUNBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgTE9DQUxFX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEZpbGVVcGxvYWRDb21wb25lbnQgfSBmcm9tICcuL3VwbG9hZC9maWxlLXVwbG9hZC9maWxlLXVwbG9hZC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBCc01vZGFsU2VydmljZSwgQnNNb2RhbFJlZiB9IGZyb20gJ0BmYXJyaXMvdWktbW9kYWwnO1xyXG5pbXBvcnQgeyBVcGxvYWRGaWxlSW5mbyB9IGZyb20gJy4vdXBsb2FkL2VudGl0eS91cGxvYWRmaWxlaW5mbyc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IFVwbG9hZExpbWl0IH0gZnJvbSAnLi91cGxvYWQvZW50aXR5L3VwbG9hZGxpbWl0JztcclxuaW1wb3J0IHsgTG9jYWxMYW5nUGlwZSB9IGZyb20gJy4vbG9jYWwucGlwZSc7XHJcblxyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgVXBsb2FkRGlhbG9nU2VydmljZSB7XHJcblxyXG4gICAgbG9jYWxlaWQ6IHN0cmluZztcclxuICAgIGxvY2FscGlwZTogTG9jYWxMYW5nUGlwZTtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgbW9kYWxTZXJ2aWNlOiBCc01vZGFsU2VydmljZSwgcHJpdmF0ZSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuICAgICAgICBpZiAodGhpcy5pbmplY3Rvcikge1xyXG4gICAgICAgICAgICB0aGlzLm1vZGFsU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KEJzTW9kYWxTZXJ2aWNlKTtcclxuICAgICAgICAgICAgdGhpcy5sb2NhbGVpZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFwibGFuZ3VhZ2VDb2RlXCIpIHx8IHRoaXMuaW5qZWN0b3IuZ2V0KExPQ0FMRV9JRCk7XHJcbiAgICAgICAgICAgIHRoaXMubG9jYWxwaXBlID0gbmV3IExvY2FsTGFuZ1BpcGUodGhpcy5sb2NhbGVpZCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGRsZzogQnNNb2RhbFJlZjtcclxuXHJcbiAgICBmaWxlSW5mb0xpc3Q6IFVwbG9hZEZpbGVJbmZvW10gPSBbXTtcclxuXHJcbiAgICBzaG93RGlhbG9nKGZvcm1JZDogc3RyaW5nLCByb290SWQ6IHN0cmluZykge1xyXG4gICAgICAgIGxldCBmbGFnID0gMDtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XHJcbiAgICAgICAgICAgIHZhciB2aWV3ZXJGYWN0b3J5ID0gdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoRmlsZVVwbG9hZENvbXBvbmVudCk7XHJcbiAgICAgICAgICAgIHZhciB2aWV3ZXJSZWYgPSB2aWV3ZXJGYWN0b3J5LmNyZWF0ZSh0aGlzLmluamVjdG9yKTtcclxuXHJcbiAgICAgICAgICAgIHZpZXdlclJlZi5pbnN0YW5jZS5yb290SWQgPSByb290SWQ7XHJcbiAgICAgICAgICAgIHZpZXdlclJlZi5pbnN0YW5jZS5mb3JtSWQgPSBmb3JtSWQ7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRsZyA9IHRoaXMubW9kYWxTZXJ2aWNlLnNob3codmlld2VyUmVmLCB7XHJcbiAgICAgICAgICAgICAgICB0aXRsZTogdGhpcy5sb2NhbHBpcGUudHJhbnNmb3JtKCd1cGxvYWRGaWxlJyksXHJcbiAgICAgICAgICAgICAgICB3aWR0aDogOTUwLCBoZWlnaHQ6IDU3MCxcclxuICAgICAgICAgICAgICAgIGJ1dHRvbnM6IFtcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IHRoaXMubG9jYWxwaXBlLnRyYW5zZm9ybSgnc2F2ZScpLCBjbHM6ICdrLWJ1dHRvbiBrLWJ1dHRvbi1pY29udGV4dCBrLXByaW1hcnknLCBoYW5kbGU6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGxnLmNvbnRlbnQudXBsb2FkKCkuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcyA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYWcgPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kbGcuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogdGhpcy5sb2NhbHBpcGUudHJhbnNmb3JtKCdjbG9zZScpLCBjbHM6ICdrLWJ1dHRvbiBrLWJ1dHRvbi1pY29udGV4dCcsIGhhbmRsZTogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kbGcuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIF0sXHJcblxyXG4gICAgICAgICAgICAgICAgc2hvd0J1dHRvbnM6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBzaG93TWF4QnV0dG9uOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGJlZm9yZUNsb3NlOiAoKTogT2JzZXJ2YWJsZTxib29sZWFuPiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWcgPT0gMClcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kbGcuY29udGVudC5jYW5jZWwoKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgdXBsb2FkRmlsZShmb3JtSWQ6IHN0cmluZywgcm9vdElkOiBzdHJpbmcsIG9sZElkTGlzdDogc3RyaW5nW10gPSBbXSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnVwbG9hZEZpbGVXaXRoTGltaXQoZm9ybUlkLCByb290SWQsIG51bGwsIG9sZElkTGlzdCk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHVwbG9hZEZpbGVXaXRoTGltaXQoZm9ybUlkOiBzdHJpbmcsIHJvb3RJZDogc3RyaW5nLCBsaW1pdDogVXBsb2FkTGltaXQsIG9sZElkTGlzdDogc3RyaW5nW10gPSBbXSkge1xyXG4gICAgICAgIGxldCBmbGFnID0gMDtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XHJcbiAgICAgICAgICAgIHZhciB1cGxvYWRGYWN0b3J5ID0gdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoRmlsZVVwbG9hZENvbXBvbmVudCk7XHJcbiAgICAgICAgICAgIHZhciB1cGxvYWRSZWYgPSB1cGxvYWRGYWN0b3J5LmNyZWF0ZSh0aGlzLmluamVjdG9yKTtcclxuICAgICAgICAgICAgaWYgKGxpbWl0ICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHVwbG9hZFJlZi5pbnN0YW5jZS5maWxlQ291bnQgPSBsaW1pdC5maWxlQ291bnQ7XHJcbiAgICAgICAgICAgICAgICB1cGxvYWRSZWYuaW5zdGFuY2Uuc2VjdXJpdHlJbmZvPWxpbWl0LnNlY3VyaXR5SW5mbztcclxuICAgICAgICAgICAgICAgIGlmIChsaW1pdC5maWxlVHlwZSAhPSBudWxsICYmIGxpbWl0LmZpbGVUeXBlICE9IFwiXCIpXHJcbiAgICAgICAgICAgICAgICAgICAgdXBsb2FkUmVmLmluc3RhbmNlLmZpbGVUeXBlID0gbGltaXQuZmlsZVR5cGVcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdXBsb2FkUmVmLmluc3RhbmNlLnJvb3RJZCA9IHJvb3RJZDtcclxuICAgICAgICAgICAgdXBsb2FkUmVmLmluc3RhbmNlLmZvcm1JZCA9IGZvcm1JZDtcclxuICAgICAgICAgICAgdXBsb2FkUmVmLmluc3RhbmNlLm9sZElkTGlzdCA9IG9sZElkTGlzdDtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZGxnID0gdGhpcy5tb2RhbFNlcnZpY2Uuc2hvdyh1cGxvYWRSZWYsIHtcclxuICAgICAgICAgICAgICAgIHRpdGxlOiB0aGlzLmxvY2FscGlwZS50cmFuc2Zvcm0oJ3VwbG9hZEZpbGUnKSxcclxuICAgICAgICAgICAgICAgIHdpZHRoOiA5NTAsIGhlaWdodDogNTcwLFxyXG4gICAgICAgICAgICAgICAgYnV0dG9uczogW1xyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IHRoaXMubG9jYWxwaXBlLnRyYW5zZm9ybSgnc2F2ZScpLCBjbHM6ICdrLWJ1dHRvbiBrLWJ1dHRvbi1pY29udGV4dCBrLXByaW1hcnknLCBoYW5kbGU6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGxnLmNvbnRlbnQudXBsb2FkKCkuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcyA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYWcgPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kbGcuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogdGhpcy5sb2NhbHBpcGUudHJhbnNmb3JtKCdjbG9zZScpLCBjbHM6ICdrLWJ1dHRvbiBrLWJ1dHRvbi1pY29udGV4dCcsIGhhbmRsZTogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kbGcuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIF0sXHJcblxyXG4gICAgICAgICAgICAgICAgc2hvd0J1dHRvbnM6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBzaG93TWF4QnV0dG9uOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGJlZm9yZUNsb3NlOiAoKTogT2JzZXJ2YWJsZTxib29sZWFuPiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWcgPT0gMClcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kbGcuY29udGVudC5jYW5jZWwoKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcbn0iXX0=