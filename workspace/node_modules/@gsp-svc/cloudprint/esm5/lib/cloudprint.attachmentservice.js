/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, Injector, ApplicationRef, LOCALE_ID } from '@angular/core';
import { ComponentFactoryResolver } from '@angular/core';
import { PrintEntity } from './entitys/printEntity';
import { NotifyService } from '@farris/ui-notify';
import { Urls } from './utils/cloudprint.Urls';
import { AppService } from '@gsp-sys/rtf-common';
import { PrintFormatService } from './services/printFormatService';
import { QueryType } from './entitys/enums/querytype';
import { PrintType } from './entitys/enums/printtype';
import { DataValidator } from './utils/cloudprint.datavalidator';
import { FormatlistjobComponent } from './cloudprint-formatlistjob/formatlistjob.component';
import { BsModalService } from '@farris/ui-modal';
import { LocalLangPipe } from './local.pipe';
import { HttpClient } from '@angular/common/http';
import { Config } from './entitys/config';
/**
 * 附件打印的服务
 */
var CloudPrintAttachmentService = /** @class */ (function () {
    function CloudPrintAttachmentService(formatSrv, resolver, injector, applicationRef, notifyService, appService, modalService, httpClient) {
        this.formatSrv = formatSrv;
        this.resolver = resolver;
        this.injector = injector;
        this.applicationRef = applicationRef;
        this.notifyService = notifyService;
        this.appService = appService;
        this.modalService = modalService;
        this.httpClient = httpClient;
        /**
         * 打印参数实体
         */
        this.printEntity = new PrintEntity();
        // 设置printEntity的默认值
        this.printEntity.appUrl = Urls.CloudPrintBaseUrl;
        this.printEntity.isUseMetaData = true;
        this.printEntity.language = localStorage.getItem("languageCode") || 'zh-CHS';
        this.formatSrv.printEntity = this.printEntity;
        if (this.injector) {
            this.modalService = this.injector.get(BsModalService);
            this.localeid = localStorage.getItem("languageCode") || this.injector.get(LOCALE_ID);
            this.localpipe = new LocalLangPipe(this.localeid);
        }
    }
    Object.defineProperty(CloudPrintAttachmentService.prototype, "setPrintEntity", {
        /**
         * 设置PrintEntity参数
         * @description 如果外界new新的PrintEntity，则需要调用该方法同步service的entity
         *              外界没有new新的PrintEntity，则不需要调用该方法
         */
        set: /**
         * 设置PrintEntity参数
         * \@description 如果外界new新的PrintEntity，则需要调用该方法同步service的entity
         *              外界没有new新的PrintEntity，则不需要调用该方法
         * @param {?} entity
         * @return {?}
         */
        function (entity) {
            this.printEntity = entity;
            // this.designerSrv.printEntity = this.printEntity;
            // this.viewerSrv.printEntity = this.printEntity;
            this.formatSrv.printEntity = this.printEntity;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @param {?} attachmentoptions
     * @param {?} options
     * @param {?=} su
     * @param {?=} param
     * @return {?}
     */
    CloudPrintAttachmentService.prototype.printAttachment = /**
     * @param {?} attachmentoptions
     * @param {?} options
     * @param {?=} su
     * @param {?=} param
     * @return {?}
     */
    function (attachmentoptions, options, su, param) {
        if (su === void 0) { su = null; }
        if (param === void 0) { param = null; }
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var that;
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                if (DataValidator.checkAppUrl(this.printEntity.appUrl) == false) {
                    this.notifyService.info(this.localpipe.transform('appurlerror'));
                    return [2 /*return*/];
                }
                if (attachmentoptions.queryType == undefined) { //兼容以前的逻辑
                    attachmentoptions.queryType = QueryType.Unknown;
                }
                if (options.printType == undefined) { //兼容以前的逻辑这里默认为表单打印
                    options.printType = PrintType.Attachment;
                }
                that = this;
                return [2 /*return*/, this.formatSrv.getPrintDevice().then((/**
                     * @param {?} data
                     * @return {?}
                     */
                    function (data) {
                        /** @type {?} */
                        var device = data || [];
                        /** @type {?} */
                        var factory = that.resolver.resolveComponentFactory(FormatlistjobComponent);
                        /** @type {?} */
                        var printsetting = factory.create(that.injector);
                        printsetting.instance.boxlist = device;
                        printsetting.instance.formatId = '';
                        printsetting.instance.isShowFormat = false;
                        printsetting.instance.printType = 1;
                        printsetting.instance.localepip = that.localpipe;
                        /** @type {?} */
                        var dlg = _this.modalService.show(printsetting, {
                            title: _this.localpipe.transform('printset'),
                            width: 800,
                            height: 500,
                            showButtons: true,
                            showMaxButton: false,
                            buttons: [
                                { text: _this.localpipe.transform('print'), cls: 'btn btn-primary', handle: (/**
                                     * @return {?}
                                     */
                                    function () {
                                        printsetting.instance.printJob();
                                    }) },
                                { text: _this.localpipe.transform('cancel'), cls: 'btn btn-secondary', handle: (/**
                                     * @return {?}
                                     */
                                    function () {
                                        dlg.close();
                                    }) }
                            ],
                        });
                        //订阅了弹出的格式选择列表的关闭事件
                        printsetting.instance.print.subscribe((/**
                         * @param {?} data
                         * @return {?}
                         */
                        function (data) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
                            return tslib_1.__generator(this, function (_a) {
                                switch (_a.label) {
                                    case 0:
                                        dlg.close();
                                        options.printSetting = data.printSetting;
                                        options.printerName = data.printter;
                                        options.DeviceId = data.boxId;
                                        options.printJob = true;
                                        return [4 /*yield*/, this.printAttachmentJob(attachmentoptions, options)];
                                    case 1: return [2 /*return*/, _a.sent()];
                                }
                            });
                        }); }));
                    }))];
            });
        });
    };
    /**
     * @private
     * @param {?} attachmentoptions
     * @param {?} options
     * @return {?}
     */
    CloudPrintAttachmentService.prototype.printAttachmentJob = /**
     * @private
     * @param {?} attachmentoptions
     * @param {?} options
     * @return {?}
     */
    function (attachmentoptions, options) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var url, httpoptions, data;
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        url = this.printEntity.appUrl + Urls.PrintAttachment + 'su=' + Config.PRINT_SU;
                        ;
                        httpoptions = {};
                        httpoptions['headers'] = {
                            SessionId: this.printEntity.sessionId || '',
                            'Content-Type': 'application/json'
                        };
                        data = {
                            attachmentOptions: attachmentoptions,
                            options: options,
                        };
                        return [4 /*yield*/, this.httpClient.post(url, data, httpoptions).toPromise()
                                .then((/**
                             * @return {?}
                             */
                            function () {
                                _this.notifyService.info(_this.localpipe.transform('sendprintjob'));
                                return _this.localpipe.transform('sendprintjob');
                            }))
                                .catch((/**
                             * @param {?} err
                             * @return {?}
                             */
                            function (err) {
                                _this.notifyService.warning(err.error.Message);
                                return err.error.Message;
                            }))];
                    case 1: return [2 /*return*/, _a.sent()];
                }
            });
        });
    };
    CloudPrintAttachmentService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    CloudPrintAttachmentService.ctorParameters = function () { return [
        { type: PrintFormatService },
        { type: ComponentFactoryResolver },
        { type: Injector },
        { type: ApplicationRef },
        { type: NotifyService },
        { type: AppService },
        { type: BsModalService },
        { type: HttpClient }
    ]; };
    return CloudPrintAttachmentService;
}());
export { CloudPrintAttachmentService };
if (false) {
    /**
     * 打印参数实体
     * @type {?}
     */
    CloudPrintAttachmentService.prototype.printEntity;
    /** @type {?} */
    CloudPrintAttachmentService.prototype.localeid;
    /** @type {?} */
    CloudPrintAttachmentService.prototype.localpipe;
    /**
     * @type {?}
     * @private
     */
    CloudPrintAttachmentService.prototype.formatSrv;
    /**
     * @type {?}
     * @private
     */
    CloudPrintAttachmentService.prototype.resolver;
    /**
     * @type {?}
     * @private
     */
    CloudPrintAttachmentService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    CloudPrintAttachmentService.prototype.applicationRef;
    /**
     * @type {?}
     * @private
     */
    CloudPrintAttachmentService.prototype.notifyService;
    /**
     * @type {?}
     * @private
     */
    CloudPrintAttachmentService.prototype.appService;
    /**
     * @type {?}
     * @private
     */
    CloudPrintAttachmentService.prototype.modalService;
    /**
     * @type {?}
     * @private
     */
    CloudPrintAttachmentService.prototype.httpClient;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xvdWRwcmludC5hdHRhY2htZW50c2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bnc3Atc3ZjL2Nsb3VkcHJpbnQvIiwic291cmNlcyI6WyJsaWIvY2xvdWRwcmludC5hdHRhY2htZW50c2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLGNBQWMsRUFBdUIsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JHLE9BQU8sRUFBRSx3QkFBd0IsRUFBbUQsTUFBTSxlQUFlLENBQUM7QUFJMUcsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRXBELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUVsRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFJL0MsT0FBTyxFQUFFLFVBQVUsRUFBd0MsTUFBTSxxQkFBcUIsQ0FBQztBQUl2RixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQVVuRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDdEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUVqRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxvREFBb0QsQ0FBQztBQUM1RixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDbEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUU3QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGtCQUFrQixDQUFDOzs7O0FBTTFDO0lBdUJFLHFDQUNVLFNBQTZCLEVBQzdCLFFBQWtDLEVBQ2xDLFFBQWtCLEVBQ2xCLGNBQThCLEVBQzlCLGFBQTRCLEVBQzVCLFVBQXNCLEVBQ3RCLFlBQTRCLEVBQzVCLFVBQXNCO1FBUHRCLGNBQVMsR0FBVCxTQUFTLENBQW9CO1FBQzdCLGFBQVEsR0FBUixRQUFRLENBQTBCO1FBQ2xDLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIsaUJBQVksR0FBWixZQUFZLENBQWdCO1FBQzVCLGVBQVUsR0FBVixVQUFVLENBQVk7Ozs7UUF6QmhDLGdCQUFXLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQTJCMUIsb0JBQW9CO1FBQ3BCLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQztRQUNqRCxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7UUFDdEMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsSUFBSSxRQUFRLENBQUM7UUFFN0UsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUc5QyxJQUFHLElBQUksQ0FBQyxRQUFRLEVBQ2hCO1lBQ0UsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUN0RCxJQUFJLENBQUMsUUFBUSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDckYsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLGFBQWEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDbkQ7SUFDTCxDQUFDO0lBbENILHNCQUFJLHVEQUFjO1FBTGxCOzs7O1dBSUc7Ozs7Ozs7O1FBQ0gsVUFBbUIsTUFBTTtZQUN2QixJQUFJLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQztZQUMxQixtREFBbUQ7WUFDbkQsaURBQWlEO1lBQ2pELElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDaEQsQ0FBQzs7O09BQUE7Ozs7Ozs7O0lBZ0NPLHFEQUFlOzs7Ozs7O0lBQXJCLFVBQXNCLGlCQUFvQyxFQUFFLE9BQXNCLEVBQUMsRUFBTyxFQUFDLEtBQVU7UUFBbEIsbUJBQUEsRUFBQSxTQUFPO1FBQUMsc0JBQUEsRUFBQSxZQUFVOzs7OztnQkFDbkcsSUFBRyxhQUFhLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLElBQUUsS0FBSyxFQUFDO29CQUMzRCxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO29CQUNqRSxzQkFBTztpQkFDUjtnQkFDRCxJQUFHLGlCQUFpQixDQUFDLFNBQVMsSUFBRSxTQUFTLEVBQUMsRUFBQyxTQUFTO29CQUNsRCxpQkFBaUIsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQztpQkFDakQ7Z0JBRUQsSUFBRyxPQUFPLENBQUMsU0FBUyxJQUFFLFNBQVMsRUFBQyxFQUFDLGtCQUFrQjtvQkFDakQsT0FBTyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUMsVUFBVSxDQUFDO2lCQUMxQztnQkFFSyxJQUFJLEdBQUcsSUFBSTtnQkFDakIsc0JBQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxJQUFJOzs7O29CQUFDLFVBQUMsSUFBSTs7NEJBQ3pDLE1BQU0sR0FBRyxJQUFJLElBQUksRUFBRTs7NEJBQ25CLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLHVCQUF1QixDQUFDLHNCQUFzQixDQUFDOzs0QkFDdkUsWUFBWSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQzt3QkFFbEQsWUFBWSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO3dCQUN2QyxZQUFZLENBQUMsUUFBUSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7d0JBQ3BDLFlBQVksQ0FBQyxRQUFRLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQzt3QkFDM0MsWUFBWSxDQUFDLFFBQVEsQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDO3dCQUNwQyxZQUFZLENBQUMsUUFBUSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDOzs0QkFFM0MsR0FBRyxHQUFHLEtBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBQzs0QkFDOUMsS0FBSyxFQUFFLEtBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQzs0QkFDM0MsS0FBSyxFQUFFLEdBQUc7NEJBQ1YsTUFBTSxFQUFFLEdBQUc7NEJBQ1gsV0FBVyxFQUFFLElBQUk7NEJBQ2pCLGFBQWEsRUFBQyxLQUFLOzRCQUNuQixPQUFPLEVBQUU7Z0NBQ1AsRUFBRSxJQUFJLEVBQUUsS0FBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLEVBQUUsR0FBRyxFQUFFLGlCQUFpQixFQUFFLE1BQU07OztvQ0FBRTt3Q0FDekUsWUFBWSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztvQ0FDbkMsQ0FBQyxDQUFBLEVBQUM7Z0NBQ0YsRUFBRSxJQUFJLEVBQUUsS0FBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLEVBQUUsR0FBRyxFQUFFLG1CQUFtQixFQUFFLE1BQU07OztvQ0FBRTt3Q0FDNUUsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO29DQUNkLENBQUMsQ0FBQSxFQUFDOzZCQUNIO3lCQUNGLENBQUM7d0JBQ0YsbUJBQW1CO3dCQUNuQixZQUFZLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxTQUFTOzs7O3dCQUFDLFVBQU8sSUFBSTs7Ozt3Q0FDN0MsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO3dDQUNaLE9BQU8sQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQzt3Q0FDekMsT0FBTyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO3dDQUNwQyxPQUFPLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7d0NBQzlCLE9BQU8sQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO3dDQUNqQixxQkFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsaUJBQWlCLEVBQUMsT0FBTyxDQUFDLEVBQUE7NENBQS9ELHNCQUFPLFNBQXdELEVBQUM7Ozs2QkFDbkUsRUFBQyxDQUFDO29CQUNMLENBQUMsRUFBQyxFQUFDOzs7S0FJSjs7Ozs7OztJQUVhLHdEQUFrQjs7Ozs7O0lBQWhDLFVBQWlDLGlCQUFvQyxFQUFFLE9BQXNCOzs7Ozs7O3dCQUNyRixHQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGVBQWUsR0FBRSxLQUFLLEdBQUcsTUFBTSxDQUFDLFFBQVE7d0JBQUMsQ0FBQzt3QkFFL0UsV0FBVyxHQUFHLEVBQUU7d0JBQ3RCLFdBQVcsQ0FBQyxTQUFTLENBQUMsR0FBRzs0QkFDckIsU0FBUyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxJQUFJLEVBQUU7NEJBQzNDLGNBQWMsRUFBQyxrQkFBa0I7eUJBQ3BDLENBQUM7d0JBQ0ksSUFBSSxHQUFHOzRCQUNYLGlCQUFpQixFQUFDLGlCQUFpQjs0QkFDbkMsT0FBTyxFQUFDLE9BQU87eUJBQ2hCO3dCQUVNLHFCQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBQyxJQUFJLEVBQUMsV0FBVyxDQUFDLENBQUMsU0FBUyxFQUFFO2lDQUNsRSxJQUFJOzs7NEJBQUM7Z0NBQ0osS0FBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztnQ0FDbEUsT0FBTyxLQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQzs0QkFDbEQsQ0FBQyxFQUFDO2lDQUNELEtBQUs7Ozs7NEJBQUMsVUFBQyxHQUFHO2dDQUNULEtBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7Z0NBQzlDLE9BQU8sR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUM7NEJBQzNCLENBQUMsRUFBQyxFQUFBOzRCQVJGLHNCQUFPLFNBUUwsRUFBQzs7OztLQUNKOztnQkEvSEosVUFBVTs7OztnQkF6QkYsa0JBQWtCO2dCQWhCbEIsd0JBQXdCO2dCQURaLFFBQVE7Z0JBQUUsY0FBYztnQkFPcEMsYUFBYTtnQkFNYixVQUFVO2dCQW1CVixjQUFjO2dCQUdkLFVBQVU7O0lBd0luQixrQ0FBQztDQUFBLEFBaklELElBaUlDO1NBaElZLDJCQUEyQjs7Ozs7O0lBS3RDLGtEQUFnQzs7SUFjaEMsK0NBQWdCOztJQUNoQixnREFBeUI7Ozs7O0lBR3ZCLGdEQUFxQzs7Ozs7SUFDckMsK0NBQTBDOzs7OztJQUMxQywrQ0FBMEI7Ozs7O0lBQzFCLHFEQUFzQzs7Ozs7SUFDdEMsb0RBQW9DOzs7OztJQUNwQyxpREFBOEI7Ozs7O0lBQzlCLG1EQUFvQzs7Ozs7SUFDcEMsaURBQThCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIEFwcGxpY2F0aW9uUmVmLCBFdmVudEVtaXR0ZXIsIFF1ZXJ5LCBMT0NBTEVfSUQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBDb21wb25lbnRSZWYsIEVtYmVkZGVkVmlld1JlZiwgVmlld0NvbnRhaW5lclJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5cclxuaW1wb3J0IHsgQ2xvdWRwcmludERlc2lnbmVyQ29tcG9uZW50IH0gZnJvbSAnLi9jbG91ZHByaW50LWRlc2lnbmVyL2Nsb3VkcHJpbnQtZGVzaWduZXIuY29tcG9uZW50JztcclxuaW1wb3J0IHsgQ2xvdWRwcmludFZpZXdlckNvbXBvbmVudCB9IGZyb20gJy4vY2xvdWRwcmludC12aWV3ZXIvY2xvdWRwcmludC12aWV3ZXIuY29tcG9uZW50JztcclxuaW1wb3J0IHsgUHJpbnRFbnRpdHkgfSBmcm9tICcuL2VudGl0eXMvcHJpbnRFbnRpdHknO1xyXG5cclxuaW1wb3J0IHsgTm90aWZ5U2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbm90aWZ5JztcclxuaW1wb3J0IHsgT3V0cHV0T3B0aW9ucyB9IGZyb20gJy4vZW50aXR5cy9vdXRwdXRvcHRpb25zL291dHB1dE9wdGlvbnMnO1xyXG5pbXBvcnQgeyBVcmxzIH0gZnJvbSAnLi91dGlscy9jbG91ZHByaW50LlVybHMnO1xyXG5pbXBvcnQgeyBTb3VyY2VPcHRpb25zIH0gZnJvbSAnLi9lbnRpdHlzL2RhdGFzb3VyY2VvcHRpb25zL3NvdXJjZU9wdGlvbnMnO1xyXG5pbXBvcnQgeyBTb3VyY2VGaWx0ZXJPcHRpb25zIH0gZnJvbSAnLi9lbnRpdHlzL2RhdGFzb3VyY2VvcHRpb25zL3NvdXJjZUZpbHRlck9wdGlvbnMnO1xyXG5pbXBvcnQgeyBCT09wdGlvbnMgfSBmcm9tICcuL2VudGl0eXMvZGF0YXNvdXJjZW9wdGlvbnMvYm9vcHRpb25zJztcclxuaW1wb3J0IHsgQXBwU2VydmljZSwgQXBwT3B0aW9ucywgRnJhbWV3b3JrVmFyaWFibGVTZXJ2aWNlIH0gZnJvbSAnQGdzcC1zeXMvcnRmLWNvbW1vbic7XHJcbmltcG9ydCB7IEZpbGVUeXBlIH0gZnJvbSAnLi9lbnRpdHlzL291dHB1dG9wdGlvbnMvZmlsZVR5cGUnO1xyXG5pbXBvcnQgeyBDbXBUeXBlIH0gZnJvbSAnLi9lbnRpdHlzL2VudW1zL2NtcFR5cGUnO1xyXG5pbXBvcnQgeyBPdXRwdXRQYXJhbSB9IGZyb20gJy4vZW50aXR5cy9vdXRwdXRvcHRpb25zL291dHB1dFBhcmFtJztcclxuaW1wb3J0IHsgUHJpbnRGb3JtYXRTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9wcmludEZvcm1hdFNlcnZpY2UnO1xyXG5pbXBvcnQgeyBTb3VyY2VUeXBlIH0gZnJvbSAnLi9lbnRpdHlzL2VudW1zL3NvdXJjZVR5cGUnO1xyXG5cclxuaW1wb3J0IHsgUHJpbnRGb3JtYXQgfSBmcm9tICcuL2VudGl0eXMvcHJpbnRGb3JtYXQnO1xyXG5cclxuaW1wb3J0IHsgRm9ybWF0bGlzdENvbXBvbmVudCB9IGZyb20gJy4vY2xvdWRwcmludC1mb3JtYXRsaXN0L2Zvcm1hdGxpc3QuY29tcG9uZW50JztcclxuaW1wb3J0IHsgVXRpbHMgfSBmcm9tICcuL3V0aWxzL2Nsb3VkcHJpbnQudXRpbHMnO1xyXG5pbXBvcnQgeyBDbG91ZHByaW50ZGVzaWduZXJTZXJ2aWNlIH0gZnJvbSAnLi9jbG91ZHByaW50LWRlc2lnbmVyL2Nsb3VkcHJpbnQtZGVzaWduZXIuc2VydmljZSc7XHJcbmltcG9ydCB7IENsb3VkcHJpbnR2aWV3ZXJTZXJ2aWNlIH0gZnJvbSAnLi9jbG91ZHByaW50LXZpZXdlci9jbG91ZHByaW50LXZpZXdlci5zZXJ2aWNlJztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBRdWVyeVR5cGUgfSBmcm9tICcuL2VudGl0eXMvZW51bXMvcXVlcnl0eXBlJztcclxuaW1wb3J0IHsgUHJpbnRUeXBlIH0gZnJvbSAnLi9lbnRpdHlzL2VudW1zL3ByaW50dHlwZSc7XHJcbmltcG9ydCB7IERhdGFWYWxpZGF0b3IgfSBmcm9tICcuL3V0aWxzL2Nsb3VkcHJpbnQuZGF0YXZhbGlkYXRvcic7XHJcbmltcG9ydCB7IEJhc2VTb3VyY2VPcHRpb25zIH0gZnJvbSAnLi9lbnRpdHlzL2RhdGFzb3VyY2VvcHRpb25zL2Jhc2Vzb3VyY2VvcHRpb25zJztcclxuaW1wb3J0IHsgRm9ybWF0bGlzdGpvYkNvbXBvbmVudCB9IGZyb20gJy4vY2xvdWRwcmludC1mb3JtYXRsaXN0am9iL2Zvcm1hdGxpc3Rqb2IuY29tcG9uZW50JztcclxuaW1wb3J0IHsgQnNNb2RhbFNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLW1vZGFsJztcclxuaW1wb3J0IHsgTG9jYWxMYW5nUGlwZSB9IGZyb20gJy4vbG9jYWwucGlwZSc7XHJcbmltcG9ydCB7IEF0dGFjaG1lbnRPcHRpb25zIH0gZnJvbSAnLi9lbnRpdHlzL2RhdGFzb3VyY2VvcHRpb25zL2F0dGFjaG1lbnRvcHRpb25zJztcclxuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHsgQ29uZmlnIH0gZnJvbSAnLi9lbnRpdHlzL2NvbmZpZyc7XHJcblxyXG5cclxuLyoqXHJcbiAqIOmZhOS7tuaJk+WNsOeahOacjeWKoVxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQ2xvdWRQcmludEF0dGFjaG1lbnRTZXJ2aWNlIHtcclxuIFxyXG4gIC8qKlxyXG4gICAqIOaJk+WNsOWPguaVsOWunuS9k1xyXG4gICAqL1xyXG4gIHByaW50RW50aXR5ID0gbmV3IFByaW50RW50aXR5KCk7XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuvue9rlByaW50RW50aXR55Y+C5pWwXHJcbiAgICogQGRlc2NyaXB0aW9uIOWmguaenOWklueVjG5ld+aWsOeahFByaW50RW50aXR577yM5YiZ6ZyA6KaB6LCD55So6K+l5pa55rOV5ZCM5q2lc2VydmljZeeahGVudGl0eVxyXG4gICAqICAgICAgICAgICAgICDlpJbnlYzmsqHmnIluZXfmlrDnmoRQcmludEVudGl0ee+8jOWImeS4jemcgOimgeiwg+eUqOivpeaWueazlVxyXG4gICAqL1xyXG4gIHNldCBzZXRQcmludEVudGl0eShlbnRpdHkpIHtcclxuICAgIHRoaXMucHJpbnRFbnRpdHkgPSBlbnRpdHk7XHJcbiAgICAvLyB0aGlzLmRlc2lnbmVyU3J2LnByaW50RW50aXR5ID0gdGhpcy5wcmludEVudGl0eTtcclxuICAgIC8vIHRoaXMudmlld2VyU3J2LnByaW50RW50aXR5ID0gdGhpcy5wcmludEVudGl0eTtcclxuICAgIHRoaXMuZm9ybWF0U3J2LnByaW50RW50aXR5ID0gdGhpcy5wcmludEVudGl0eTtcclxuICB9XHJcblxyXG4gIGxvY2FsZWlkOnN0cmluZztcclxuICBsb2NhbHBpcGU6IExvY2FsTGFuZ1BpcGU7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBmb3JtYXRTcnY6IFByaW50Rm9ybWF0U2VydmljZSxcclxuICAgIHByaXZhdGUgcmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcclxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxyXG4gICAgcHJpdmF0ZSBhcHBsaWNhdGlvblJlZjogQXBwbGljYXRpb25SZWYsXHJcbiAgICBwcml2YXRlIG5vdGlmeVNlcnZpY2U6IE5vdGlmeVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGFwcFNlcnZpY2U6IEFwcFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIG1vZGFsU2VydmljZTogQnNNb2RhbFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGh0dHBDbGllbnQ6IEh0dHBDbGllbnRcclxuICAgICkge1xyXG4gICAgICAgIC8vIOiuvue9rnByaW50RW50aXR555qE6buY6K6k5YC8XHJcbiAgICAgICAgdGhpcy5wcmludEVudGl0eS5hcHBVcmwgPSBVcmxzLkNsb3VkUHJpbnRCYXNlVXJsO1xyXG4gICAgICAgIHRoaXMucHJpbnRFbnRpdHkuaXNVc2VNZXRhRGF0YSA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5wcmludEVudGl0eS5sYW5ndWFnZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFwibGFuZ3VhZ2VDb2RlXCIpIHx8ICd6aC1DSFMnO1xyXG4gICAgXHJcbiAgICAgICAgdGhpcy5mb3JtYXRTcnYucHJpbnRFbnRpdHkgPSB0aGlzLnByaW50RW50aXR5O1xyXG5cclxuXHJcbiAgICAgICAgaWYodGhpcy5pbmplY3RvcilcclxuICAgICAgICB7XHJcbiAgICAgICAgICB0aGlzLm1vZGFsU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KEJzTW9kYWxTZXJ2aWNlKTtcclxuICAgICAgICAgIHRoaXMubG9jYWxlaWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShcImxhbmd1YWdlQ29kZVwiKSB8fCB0aGlzLmluamVjdG9yLmdldChMT0NBTEVfSUQpO1xyXG4gICAgICAgICAgdGhpcy5sb2NhbHBpcGUgPSBuZXcgTG9jYWxMYW5nUGlwZSh0aGlzLmxvY2FsZWlkKTtcclxuICAgICAgICB9IFxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBhc3luYyBwcmludEF0dGFjaG1lbnQoYXR0YWNobWVudG9wdGlvbnM6IEF0dGFjaG1lbnRPcHRpb25zLCBvcHRpb25zOiBPdXRwdXRPcHRpb25zLHN1PW51bGwscGFyYW09bnVsbCkge1xyXG4gICAgICBpZihEYXRhVmFsaWRhdG9yLmNoZWNrQXBwVXJsKHRoaXMucHJpbnRFbnRpdHkuYXBwVXJsKT09ZmFsc2Upe1xyXG4gICAgICAgIHRoaXMubm90aWZ5U2VydmljZS5pbmZvKHRoaXMubG9jYWxwaXBlLnRyYW5zZm9ybSgnYXBwdXJsZXJyb3InKSk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGlmKGF0dGFjaG1lbnRvcHRpb25zLnF1ZXJ5VHlwZT09dW5kZWZpbmVkKXsvL+WFvOWuueS7peWJjeeahOmAu+i+kVxyXG4gICAgICAgIGF0dGFjaG1lbnRvcHRpb25zLnF1ZXJ5VHlwZSA9IFF1ZXJ5VHlwZS5Vbmtub3duO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZihvcHRpb25zLnByaW50VHlwZT09dW5kZWZpbmVkKXsvL+WFvOWuueS7peWJjeeahOmAu+i+kei/memHjOm7mOiupOS4uuihqOWNleaJk+WNsFxyXG4gICAgICAgIG9wdGlvbnMucHJpbnRUeXBlID0gUHJpbnRUeXBlLkF0dGFjaG1lbnQ7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xyXG4gICAgICByZXR1cm4gdGhpcy5mb3JtYXRTcnYuZ2V0UHJpbnREZXZpY2UoKS50aGVuKChkYXRhKT0+e1xyXG4gICAgICAgIGNvbnN0IGRldmljZSA9IGRhdGEgfHwgW107XHJcbiAgICAgICAgY29uc3QgZmFjdG9yeSA9IHRoYXQucmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoRm9ybWF0bGlzdGpvYkNvbXBvbmVudCk7XHJcbiAgICAgICAgY29uc3QgcHJpbnRzZXR0aW5nID0gZmFjdG9yeS5jcmVhdGUodGhhdC5pbmplY3Rvcik7XHJcbiAgXHJcbiAgICAgICAgcHJpbnRzZXR0aW5nLmluc3RhbmNlLmJveGxpc3QgPSBkZXZpY2U7XHJcbiAgICAgICAgcHJpbnRzZXR0aW5nLmluc3RhbmNlLmZvcm1hdElkID0gJyc7XHJcbiAgICAgICAgcHJpbnRzZXR0aW5nLmluc3RhbmNlLmlzU2hvd0Zvcm1hdCA9IGZhbHNlO1xyXG4gICAgICAgIHByaW50c2V0dGluZy5pbnN0YW5jZS5wcmludFR5cGUgPSAxO1xyXG4gICAgICAgIHByaW50c2V0dGluZy5pbnN0YW5jZS5sb2NhbGVwaXAgPSB0aGF0LmxvY2FscGlwZTtcclxuXHJcbiAgICAgICAgY29uc3QgZGxnID0gdGhpcy5tb2RhbFNlcnZpY2Uuc2hvdyhwcmludHNldHRpbmcse1xyXG4gICAgICAgICAgdGl0bGU6IHRoaXMubG9jYWxwaXBlLnRyYW5zZm9ybSgncHJpbnRzZXQnKSxcclxuICAgICAgICAgIHdpZHRoOiA4MDAsIFxyXG4gICAgICAgICAgaGVpZ2h0OiA1MDAsXHJcbiAgICAgICAgICBzaG93QnV0dG9uczogdHJ1ZSxcclxuICAgICAgICAgIHNob3dNYXhCdXR0b246ZmFsc2UsXHJcbiAgICAgICAgICBidXR0b25zOiBbXHJcbiAgICAgICAgICAgIHsgdGV4dDogdGhpcy5sb2NhbHBpcGUudHJhbnNmb3JtKCdwcmludCcpLCBjbHM6ICdidG4gYnRuLXByaW1hcnknLCBoYW5kbGU6ICgpID0+IHtcclxuICAgICAgICAgICAgICBwcmludHNldHRpbmcuaW5zdGFuY2UucHJpbnRKb2IoKTtcclxuICAgICAgICAgICAgfX0sXHJcbiAgICAgICAgICAgIHsgdGV4dDogdGhpcy5sb2NhbHBpcGUudHJhbnNmb3JtKCdjYW5jZWwnKSwgY2xzOiAnYnRuIGJ0bi1zZWNvbmRhcnknLCBoYW5kbGU6ICgpID0+IHtcclxuICAgICAgICAgICAgICBkbGcuY2xvc2UoKTtcclxuICAgICAgICAgICAgfX1cclxuICAgICAgICAgIF0sXHJcbiAgICAgICAgfSk7ICBcclxuICAgICAgICAvL+iuoumYheS6huW8ueWHuueahOagvOW8j+mAieaLqeWIl+ihqOeahOWFs+mXreS6i+S7tlxyXG4gICAgICAgIHByaW50c2V0dGluZy5pbnN0YW5jZS5wcmludC5zdWJzY3JpYmUoYXN5bmMgKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgZGxnLmNsb3NlKCk7XHJcbiAgICAgICAgICAgIG9wdGlvbnMucHJpbnRTZXR0aW5nID0gZGF0YS5wcmludFNldHRpbmc7XHJcbiAgICAgICAgICAgIG9wdGlvbnMucHJpbnRlck5hbWUgPSBkYXRhLnByaW50dGVyO1xyXG4gICAgICAgICAgICBvcHRpb25zLkRldmljZUlkID0gZGF0YS5ib3hJZDtcclxuICAgICAgICAgICAgb3B0aW9ucy5wcmludEpvYiA9IHRydWU7XHJcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByaW50QXR0YWNobWVudEpvYihhdHRhY2htZW50b3B0aW9ucyxvcHRpb25zKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcblxyXG4gIFxyXG4gICAgICBcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIHByaW50QXR0YWNobWVudEpvYihhdHRhY2htZW50b3B0aW9uczogQXR0YWNobWVudE9wdGlvbnMsIG9wdGlvbnM6IE91dHB1dE9wdGlvbnMpe1xyXG4gICAgICBjb25zdCB1cmwgPSB0aGlzLnByaW50RW50aXR5LmFwcFVybCArIFVybHMuUHJpbnRBdHRhY2htZW50KyAnc3U9JyArIENvbmZpZy5QUklOVF9TVTs7XHJcblxyXG4gICAgICBjb25zdCBodHRwb3B0aW9ucyA9IHt9O1xyXG4gICAgICBodHRwb3B0aW9uc1snaGVhZGVycyddID0ge1xyXG4gICAgICAgICAgU2Vzc2lvbklkOiB0aGlzLnByaW50RW50aXR5LnNlc3Npb25JZCB8fCAnJyxcclxuICAgICAgICAgICdDb250ZW50LVR5cGUnOidhcHBsaWNhdGlvbi9qc29uJ1xyXG4gICAgICB9O1xyXG4gICAgICBjb25zdCBkYXRhID0ge1xyXG4gICAgICAgIGF0dGFjaG1lbnRPcHRpb25zOmF0dGFjaG1lbnRvcHRpb25zLFxyXG4gICAgICAgIG9wdGlvbnM6b3B0aW9ucyxcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuaHR0cENsaWVudC5wb3N0KHVybCxkYXRhLGh0dHBvcHRpb25zKS50b1Byb21pc2UoKVxyXG4gICAgICAudGhlbigoKT0+e1xyXG4gICAgICAgIHRoaXMubm90aWZ5U2VydmljZS5pbmZvKHRoaXMubG9jYWxwaXBlLnRyYW5zZm9ybSgnc2VuZHByaW50am9iJykpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmxvY2FscGlwZS50cmFuc2Zvcm0oJ3NlbmRwcmludGpvYicpO1xyXG4gICAgICB9KVxyXG4gICAgICAuY2F0Y2goKGVycik9PntcclxuICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyhlcnIuZXJyb3IuTWVzc2FnZSk7XHJcbiAgICAgICAgcmV0dXJuIGVyci5lcnJvci5NZXNzYWdlO1xyXG4gICAgICB9KTsgICAgXHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==