{"version":3,"file":"index.js","sources":["../src/template.js","../src/index.js"],"sourcesContent":["import dedent from 'dedent';\n\nexport const scriptsTemplate = [\n  '{{~ it.scripts :script:i }}',\n  '{{? !!script }}',\n  '<script defer src=\"{{= script }}\" type=\"text/javascript\"></script>',\n  // add newline and spaces for every element except last for pretty output by default\n  '{{? i + 1 !== it.scripts.length }}\\n      {{?}}',\n  '{{?}}',\n  '{{~}}',\n];\n\nexport const stylesTemplate = [\n  '{{~ it.styles :style:i }}',\n  '{{? !!style }}',\n  '<link href=\"{{= style }}\" rel=\"stylesheet\">',\n  '{{? i + 1 !== it.styles.length }}\\n      {{?}}',\n  '{{?}}',\n  '{{~}}',\n];\n\nexport default dedent`\n  <!DOCTYPE html>\n  <html>\n    <head>\n      <meta charset=\"utf-8\">\n      <title>{{=it.title}}</title>\n      ${stylesTemplate.join('')}\n    </head>\n    <body>\n      ${scriptsTemplate.join('')}\n    </body>\n  </html>\n`;\n","/**\n * @module rollup-plugin-static-site\n */\n\nimport { relative, resolve } from 'path';\n\nimport doT from 'dot';\nimport { readFile, outputFile } from 'fs-extra';\n\nimport defaultTemplate, { scriptsTemplate, stylesTemplate } from './template';\n\ndoT.templateSettings.strip = false;\nconst name = 'static-site';\n\n/**\n * generate html to serve a static site bundle\n * @param {!Object} opts - plugin options\n * @param {!string} opts.dir - path to output directory containing assets and bundle\n * @param {!(boolean|string)} [opts.css = false] - path to css file.\n *   typically the value of rollup-plugin-postcss' `extract` option.\n * @param {!string} [opts.filename = index.html] - filename of the output html\n * @param {!(string[]|string)} [opts.moreScripts = []] - additional scripts that should be injected\n *   into the output html, useful for loading libraries via a cdn instead the bundle\n * @param {!(string[]|string)} [opts.moreStyles = []] - like `opts.moreScripts`, but for css\n * @param {!Object} [opts.template = {}] - custom template options\n * @param {?Function} opts.template.func - wrapper function used for custom templating engines.\n *   has signature `(templateStr, templateData) => finalHtml`,\n *   where `templateStr` is the contents of the custom template (`opts.template.path`)\n *   and `templateData` is the result of merging `opts.title` and `opts.template.data`\n *   with two array properties, `scripts` and `styles`.\n *   `scripts` is `opts.moreScripts` with the path to the bundle `opts.dir` appended.\n *   `styles` is `opts.moreStyles` with `opts.css` appended, if given.\n *   this function should call whatever custom templating engine api necessary with the arguments\n *   in order to return `finalHtml`, a string of html that the plugin will save.\n * @param {?string} opts.template.path - path to custom template.\n *   if `func` is not given, the default doT engine will be used.\n *   the plugin will inject template strings to handle `scripts` and `styles` data if necessary.\n * @param {!Object} [opts.template.data = {}] - template data object.\n *   `scripts` and `styles` are reserved and will be overwritten if present.\n * @param {!string} [opts.title = rollup app] - string used for the `<title>` tag in the output html\n * @returns {Function} static site plugin\n */\nexport default function staticSite({\n  dir,\n  css = false,\n  filename = 'index.html',\n  moreScripts = [],\n  moreStyles = [],\n  template: {\n    func,\n    path,\n    data = {},\n  } = {},\n  title = 'rollup app',\n} = {}) {\n  const useDefault = !path;\n  const useDoT = !func && !!path;\n\n  return {\n    name,\n    async generateBundle({ file }, bundle, isWrite) {\n      if (!dir) this.error('`opts.dir` is required!');\n\n      // don't do anything when bundle isn't written\n      if (!isWrite) return;\n\n      // figure out paths\n      const outputDir = relative(process.cwd(), resolve(dir));\n      const relativeOutput = p => relative(outputDir, resolve(p));\n\n      // create template data\n      const scripts = (Array.isArray(moreScripts) ? moreScripts : [moreScripts])\n        .concat(relativeOutput(file));\n      const styles = (Array.isArray(moreStyles) ? moreStyles : [moreStyles])\n        .concat(css && relativeOutput(css))\n        .filter(str => !!str);\n      const templateData = {\n        title,\n        ...data,\n        scripts,\n        styles,\n      };\n\n      let templateFn;\n      if (useDefault) {\n        templateFn = doT.compile(defaultTemplate);\n      } else {\n        let userTemplate = await readFile(path, 'utf8').catch(err => this.error(err.toString()));\n\n        if (useDoT) {\n          // inject scripts and styles if the user template doesn't handle them\n          [\n            { arr: scriptsTemplate, hint: `${doT.templateSettings.varname}.scripts`, tag: '</body>' },\n            { arr: stylesTemplate, hint: `${doT.templateSettings.varname}.styles`, tag: '</head>' },\n          ].forEach(({ arr, hint, tag }) => {\n            const matches = userTemplate.match(doT.templateSettings.iterate) || [];\n            const shouldSkip = matches.some(str => str.includes(hint));\n            if (shouldSkip) return;\n\n            const tagClose = userTemplate.lastIndexOf(tag);\n            userTemplate = [\n              userTemplate.slice(0, tagClose),\n              arr.join(''),\n              userTemplate.slice(tagClose, userTemplate.length),\n            ].join('');\n          });\n          templateFn = doT.compile(userTemplate);\n        } else {\n          templateFn = d => func(userTemplate, d);\n        }\n      }\n\n      // generate and write html\n      const html = `${templateFn(templateData).trim()}\\n`;\n      const htmlPath = resolve(outputDir, filename);\n      await outputFile(htmlPath, html).catch(err => this.error(err.toString()));\n    },\n  };\n}\n"],"names":["path","relative","resolve","readFile","outputFile"],"mappings":"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"}