/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { Repository } from '@farris/devkit';
import { CacheService } from '@ecp-caf/caf-common';
import { Router } from '@angular/router';
import { FrameworkService } from '@gsp-sys/rtf-common';
import { FilterManagerService, EventBus } from '@qdp/common';
import { RtfServices } from '@qdp/common';
export class QueryIndexService {
    /**
     * @param {?} repository
     * @param {?} cacheService
     * @param {?} router
     * @param {?} frameworkService
     * @param {?} filterManagerService
     */
    constructor(repository, cacheService, router, frameworkService, filterManagerService) {
        this.repository = repository;
        this.cacheService = cacheService;
        this.router = router;
        this.frameworkService = frameworkService;
        this.filterManagerService = filterManagerService;
        window['excuteQDPQuery'] = this.filterManagerService.isFilterQDP;
    }
    /**
     * @param {?} queryId
     * @param {?=} path
     * @return {?}
     */
    route(queryId, path) {
        /** @type {?} */
        const entitys = this.repository.entityCollection.getAllEntities();
        /** @type {?} */
        let params;
        if (entitys && entitys.length) {
            params = entitys[0].toJSON();
            // const queryIdArray = queryId.split(';'); // 支持一个查询索引跳转多个查询结果的情况
            // queryIdArray.forEach(queryIdInfo => {
            //   this.cacheService.set(queryIdInfo, params);
            // });
            this.cacheService.set(RtfServices.getTabId(queryId), params);
            /** @type {?} */
            let p = 'qdpview';
            if (path) {
                p = path;
            }
            // const url = this.router.createUrlTree([this.router.url, p]).toString();
            this.router.navigateByUrl(p);
        }
    }
    /**
     * @param {?} queryId
     * @param {?} appType
     * @param {?=} appId
     * @param {?=} appEntrance
     * @param {?=} funcId
     * @return {?}
     */
    routeEx(queryId, appType, appId, appEntrance, funcId) {
        /** @type {?} */
        const entitys = this.repository.entityCollection.getAllEntities();
        /** @type {?} */
        let params;
        if (entitys && entitys.length) {
            /** @type {?} */
            const tabId = EventBus.guid();
            params = entitys[0].toJSON();
            /** @type {?} */
            const options = { 'appType': appType, 'appId': appId, 'appEntrance': appEntrance, 'funcId': funcId, 'tabId': tabId };
            /** @type {?} */
            const cacheKey = RtfServices.getFuncId(options);
            this.cacheService.set(cacheKey + 'renderMode', 'queryIndex'); // 索引页的查询参数以功能ID为缓存key进行缓存，解决打开多个结果页查询覆盖问题
            this.cacheService.set(cacheKey, params);
            /** @type {?} */
            const menuSwitchControl = Object.assign({}, RtfServices.getMenuSwitchControlParameter(cacheKey));
            options['entityParams'] = menuSwitchControl;
            this.frameworkService.openMenu(options);
        }
    }
    /**
     * @return {?}
     */
    queryRefresh() {
        this.filterManagerService.isFilterQDP.next(true);
    }
    // 查询过滤
    /**
     * @param {?} queryId
     * @param {?} filterCondition
     * @return {?}
     */
    filterQDP(queryId, filterCondition) {
        /** @type {?} */
        const self = this;
        filterCondition = this['context']['eventParam'];
        /** @type {?} */
        const entityData = { 'id': 'undefined_null' };
        if (filterCondition) {
            filterCondition.forEach((/**
             * @param {?} condition
             * @return {?}
             */
            condition => {
                /** @type {?} */
                const tempDataField = condition.fieldCode;
                /** @type {?} */
                let tempData = condition.value;
                if (tempData && (tempData.dateValue || tempData.value || tempData.numValue || tempData.yearValue || tempData.startTime || tempData.endTime || tempData.startValue || tempData.endValue || tempData.monthValue || tempData.datetimeValue)) {
                    /** @type {?} */
                    const tempDataType = condition.control.getControlType();
                    switch (tempDataType) {
                        case 0: // Text
                        case 14: // Radio
                        case 15: // 只能输入框
                            if (typeof tempData.value + '' === 'string') {
                                tempData = tempData.value;
                            }
                            break;
                        case 1: // SingleDate
                            tempData = tempData.dateValue;
                            break;
                        case 2: // SmartHelp
                            if (tempData && tempData.value && tempData.value.length) {
                                /** @type {?} */
                                const helpValues = [];
                                tempData.value.forEach((/**
                                 * @param {?} el
                                 * @return {?}
                                 */
                                (el) => {
                                    if (tempData.isInputText) {
                                        helpValues.push(el);
                                    }
                                    else {
                                        helpValues.push(self.getValue(tempData.valueField, el));
                                    }
                                }));
                                tempData = helpValues.join(',');
                            }
                            else {
                                tempData = null;
                            }
                            break;
                        case 3: // DropDownList
                            if (tempData && tempData.value && tempData.value.length) {
                                /** @type {?} */
                                const dropDownValues = [];
                                tempData.value.forEach((/**
                                 * @param {?} el
                                 * @return {?}
                                 */
                                (el) => {
                                    dropDownValues.push(el.value);
                                }));
                                tempData = dropDownValues.join(',');
                            }
                            else {
                                tempData = null;
                            }
                            break;
                        case 4: // DateRange
                        case 11: // MonthRange
                            tempData = {
                                beginValue: tempData.startTime ? tempData.startTime : null,
                                endValue: tempData.endTime ? tempData.endTime : null
                            }; // tempData.value;
                            break;
                        case 5: // NumberRange
                            tempData = {
                                beginValue: tempData.startValue ? tempData.startValue : null,
                                endValue: tempData.endValue ? tempData.endValue : null
                            }; // tempData.value;
                            break;
                        case 6: // SingleNumber
                            tempData = tempData.numValue;
                            break;
                        case 7: // SingleYear
                            tempData = tempData.yearValue;
                            break;
                        case 8: // BoolCheck
                            tempData = tempData.value && tempData.value.length ? tempData.value[0] : null;
                            break;
                        case 9: // DateTimeRange
                            tempData = {
                                beginValue: tempData.startTime ? tempData.startTime : null,
                                endValue: tempData.endTime ? tempData.endTime : null
                            }; // tempData.value;
                            break;
                        case 10: // SingleMonth
                            tempData = tempData.monthValue;
                            break;
                        case 12: // SingleDateTime
                            tempData = tempData.datetimeValue;
                            break;
                        default:
                            break;
                    }
                    /** @type {?} */
                    const cacheObject = entityData;
                    if (tempDataField && tempDataField.indexOf(';') >= 0) {
                        /** @type {?} */
                        const fields1 = tempDataField.split(';')[0].split('.');
                        /** @type {?} */
                        const fields2 = tempDataField.split(';')[1].split('.');
                        if (tempData['beginValue'] != null && tempData['beginValue'] !== undefined) {
                            this.setEntityData(fields1, cacheObject, tempData['beginValue']);
                        }
                        if (tempData['endValue'] != null && tempData['endValue'] !== undefined) {
                            this.setEntityData(fields2, cacheObject, tempData['endValue']);
                        }
                    }
                    else {
                        /** @type {?} */
                        const fields = tempDataField.split('.');
                        if (tempData != null && tempData !== undefined) {
                            this.setEntityData(fields, cacheObject, tempData);
                        }
                    }
                }
            }));
        }
        // const queryIdArray = queryId.split(';'); // 支持一个查询索引跳转多个查询结果的情况
        // queryIdArray.forEach(queryIdInfo => {
        //   this.cacheService.set(queryIdInfo, entityData);
        // });
        this.cacheService.set(RtfServices.getTabId(queryId), entityData);
        this.filterManagerService.isFilterQDP.next(true);
    }
    /**
     * @private
     * @param {?} fields
     * @param {?} cacheObject
     * @param {?} tempData
     * @return {?}
     */
    setEntityData(fields, cacheObject, tempData) {
        if (fields.length && fields.length > 1) {
            for (let i = 0; i < fields.length; i++) {
                if (i === 0) {
                    cacheObject = this.getEntityData(fields[i], cacheObject);
                }
                else {
                    cacheObject = this.getEntityData(fields[i], cacheObject[fields[i - 1]]);
                }
                if ((i + 1) === fields.length) {
                    cacheObject[fields[i]] = tempData;
                }
            }
        }
        else {
            cacheObject[fields[0]] = tempData;
        }
    }
    /**
     * @private
     * @param {?} key
     * @param {?} entityData
     * @return {?}
     */
    getEntityData(key, entityData) {
        if (entityData.hasOwnProperty(key)) {
            return entityData;
        }
        else {
            entityData[key] = {};
            return entityData;
        }
    }
    /**
     * @private
     * @param {?} field
     * @param {?} data
     * @param {?=} safe
     * @return {?}
     */
    getValue(field, data, safe = false) {
        if (!data) {
            return '';
        }
        /** @type {?} */
        let resultVal = '';
        if (field.indexOf('.') === -1) {
            resultVal = data[field];
        }
        else {
            resultVal = field.split('.').reduce(((/**
             * @param {?} obj
             * @param {?} key
             * @return {?}
             */
            (obj, key) => {
                if (obj) {
                    return obj[key];
                }
                else {
                    return null;
                }
            })), data);
        }
        if (safe) {
            return this.formatterValue(resultVal);
        }
        else {
            return resultVal;
        }
    }
    /**
     * @private
     * @param {?} val
     * @return {?}
     */
    formatterValue(val) {
        if (val === null || val === undefined || val === '') {
            return '';
        }
        if (typeof val === 'string') {
            return this.escapeHtml(val);
        }
        return val;
    }
    /**
     * @private
     * @param {?} str
     * @return {?}
     */
    escapeHtml(str) {
        if (str === null || str === undefined) {
            return '';
        }
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/\'/g, '&#39;')
            .replace(/\//g, '&#x2F;');
    }
}
QueryIndexService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
QueryIndexService.ctorParameters = () => [
    { type: Repository },
    { type: CacheService },
    { type: Router },
    { type: FrameworkService },
    { type: FilterManagerService }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    QueryIndexService.prototype.repository;
    /**
     * @type {?}
     * @private
     */
    QueryIndexService.prototype.cacheService;
    /**
     * @type {?}
     * @private
     */
    QueryIndexService.prototype.router;
    /**
     * @type {?}
     * @private
     */
    QueryIndexService.prototype.frameworkService;
    /**
     * @type {?}
     * @private
     */
    QueryIndexService.prototype.filterManagerService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnlpbmRleC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHFkcC9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL3F1ZXJ5aW5kZXguc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzdELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFHMUMsTUFBTSxPQUFPLGlCQUFpQjs7Ozs7Ozs7SUFDNUIsWUFDVSxVQUEyQixFQUMzQixZQUEwQixFQUMxQixNQUFjLEVBQ2QsZ0JBQWtDLEVBQ2xDLG9CQUEwQztRQUoxQyxlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBRWxELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLENBQUM7SUFDbkUsQ0FBQzs7Ozs7O0lBRUQsS0FBSyxDQUFDLE9BQVksRUFBRSxJQUFVOztjQUN0QixPQUFPLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLEVBQUU7O1lBQzdELE1BQU07UUFDVixJQUFJLE9BQU8sSUFB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QzthQUN2QixPQUFPLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzlCLENBQUM7OztZQTFPRixVQUFVOzs7O1lBUEYsVUFBVTtZQUNWLFlBQVk7WUFDWixNQUFNO1lBQ04sZ0JBQWdCO1lBQ2hCLG9CQUFvQjs7Ozs7OztJQU16Qix1Q0FBbUM7Ozs7O0lBQ25DLHlDQUFrQzs7Ozs7SUFDbEMsbUNBQXNCOzs7OztJQUN0Qiw2Q0FBMEM7Ozs7O0lBQzFDLGlEQUFrRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUmVwb3NpdG9yeSB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgQ2FjaGVTZXJ2aWNlIH0gZnJvbSAnQGVjcC1jYWYvY2FmLWNvbW1vbic7XHJcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcbmltcG9ydCB7IEZyYW1ld29ya1NlcnZpY2UgfSBmcm9tICdAZ3NwLXN5cy9ydGYtY29tbW9uJztcclxuaW1wb3J0IHsgRmlsdGVyTWFuYWdlclNlcnZpY2UsIEV2ZW50QnVzIH0gZnJvbSAnQHFkcC9jb21tb24nO1xyXG5pbXBvcnQgeyBSdGZTZXJ2aWNlcyB9IGZyb20gJ0BxZHAvY29tbW9uJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFF1ZXJ5SW5kZXhTZXJ2aWNlIHtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+LFxyXG4gICAgcHJpdmF0ZSBjYWNoZVNlcnZpY2U6IENhY2hlU2VydmljZSxcclxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXHJcbiAgICBwcml2YXRlIGZyYW1ld29ya1NlcnZpY2U6IEZyYW1ld29ya1NlcnZpY2UsXHJcbiAgICBwcml2YXRlIGZpbHRlck1hbmFnZXJTZXJ2aWNlOiBGaWx0ZXJNYW5hZ2VyU2VydmljZVxyXG4gICkge1xyXG4gICAgd2luZG93WydleGN1dGVRRFBRdWVyeSddID0gdGhpcy5maWx0ZXJNYW5hZ2VyU2VydmljZS5pc0ZpbHRlclFEUDtcclxuICB9XHJcblxyXG4gIHJvdXRlKHF1ZXJ5SWQ6IGFueSwgcGF0aD86IGFueSkge1xyXG4gICAgY29uc3QgZW50aXR5cyA9IHRoaXMucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEFsbEVudGl0aWVzKCk7XHJcbiAgICBsZXQgcGFyYW1zO1xyXG4gICAgaWYgKGVudGl0eXMgJiYgZW50aXR5cy5sZW5ndGgpIHtcclxuICAgICAgcGFyYW1zID0gZW50aXR5c1swXS50b0pTT04oKTtcclxuICAgICAgLy8gY29uc3QgcXVlcnlJZEFycmF5ID0gcXVlcnlJZC5zcGxpdCgnOycpOyAvLyDmlK/mjIHkuIDkuKrmn6Xor6LntKLlvJXot7PovazlpJrkuKrmn6Xor6Lnu5PmnpznmoTmg4XlhrVcclxuICAgICAgLy8gcXVlcnlJZEFycmF5LmZvckVhY2gocXVlcnlJZEluZm8gPT4ge1xyXG4gICAgICAvLyAgIHRoaXMuY2FjaGVTZXJ2aWNlLnNldChxdWVyeUlkSW5mbywgcGFyYW1zKTtcclxuICAgICAgLy8gfSk7XHJcbiAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlLnNldChSdGZTZXJ2aWNlcy5nZXRUYWJJZChxdWVyeUlkKSwgcGFyYW1zKTtcclxuICAgICAgbGV0IHAgPSAncWRwdmlldyc7XHJcbiAgICAgIGlmIChwYXRoKSB7XHJcbiAgICAgICAgcCA9IHBhdGg7XHJcbiAgICAgIH1cclxuICAgICAgLy8gY29uc3QgdXJsID0gdGhpcy5yb3V0ZXIuY3JlYXRlVXJsVHJlZShbdGhpcy5yb3V0ZXIudXJsLCBwXSkudG9TdHJpbmcoKTtcclxuICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybChwKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJvdXRlRXgocXVlcnlJZDogYW55LCBhcHBUeXBlOiBhbnksIGFwcElkPzogYW55LCBhcHBFbnRyYW5jZT86IGFueSwgZnVuY0lkPzogYW55KSB7XHJcbiAgICBjb25zdCBlbnRpdHlzID0gdGhpcy5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0QWxsRW50aXRpZXMoKTtcclxuICAgIGxldCBwYXJhbXM7XHJcbiAgICBpZiAoZW50aXR5cyAmJiBlbnRpdHlzLmxlbmd0aCkge1xyXG4gICAgICBjb25zdCB0YWJJZCA9IEV2ZW50QnVzLmd1aWQoKTtcclxuICAgICAgcGFyYW1zID0gZW50aXR5c1swXS50b0pTT04oKTtcclxuICAgICAgY29uc3Qgb3B0aW9uczogYW55ID0geyAnYXBwVHlwZSc6IGFwcFR5cGUsICdhcHBJZCc6IGFwcElkLCAnYXBwRW50cmFuY2UnOiBhcHBFbnRyYW5jZSwgJ2Z1bmNJZCc6IGZ1bmNJZCwgJ3RhYklkJzogdGFiSWQgfTtcclxuICAgICAgY29uc3QgY2FjaGVLZXkgPSBSdGZTZXJ2aWNlcy5nZXRGdW5jSWQob3B0aW9ucyk7XHJcbiAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlLnNldChjYWNoZUtleSArICdyZW5kZXJNb2RlJywgJ3F1ZXJ5SW5kZXgnKTsgLy8g57Si5byV6aG155qE5p+l6K+i5Y+C5pWw5Lul5Yqf6IO9SUTkuLrnvJPlrZhrZXnov5vooYznvJPlrZjvvIzop6PlhrPmiZPlvIDlpJrkuKrnu5PmnpzpobXmn6Xor6Lopobnm5bpl67pophcclxuICAgICAgdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KGNhY2hlS2V5LCBwYXJhbXMpO1xyXG4gICAgICBjb25zdCBtZW51U3dpdGNoQ29udHJvbCA9IE9iamVjdC5hc3NpZ24oe30sIFJ0ZlNlcnZpY2VzLmdldE1lbnVTd2l0Y2hDb250cm9sUGFyYW1ldGVyKGNhY2hlS2V5KSk7XHJcbiAgICAgIG9wdGlvbnNbJ2VudGl0eVBhcmFtcyddID0gbWVudVN3aXRjaENvbnRyb2w7XHJcbiAgICAgIHRoaXMuZnJhbWV3b3JrU2VydmljZS5vcGVuTWVudShvcHRpb25zKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHF1ZXJ5UmVmcmVzaCgpIHtcclxuICAgIHRoaXMuZmlsdGVyTWFuYWdlclNlcnZpY2UuaXNGaWx0ZXJRRFAubmV4dCh0cnVlKTtcclxuICB9XHJcblxyXG4gIC8vIOafpeivoui/h+a7pFxyXG4gIGZpbHRlclFEUChxdWVyeUlkOiBhbnksIGZpbHRlckNvbmRpdGlvbjogYW55KSB7XHJcbiAgICBjb25zdCBzZWxmID0gdGhpcztcclxuICAgIGZpbHRlckNvbmRpdGlvbiA9IHRoaXNbJ2NvbnRleHQnXVsnZXZlbnRQYXJhbSddO1xyXG4gICAgY29uc3QgZW50aXR5RGF0YTogYW55ID0geyAnaWQnOiAndW5kZWZpbmVkX251bGwnIH07XHJcbiAgICBpZiAoZmlsdGVyQ29uZGl0aW9uKSB7XHJcbiAgICAgIGZpbHRlckNvbmRpdGlvbi5mb3JFYWNoKGNvbmRpdGlvbiA9PiB7XHJcbiAgICAgICAgY29uc3QgdGVtcERhdGFGaWVsZCA9IGNvbmRpdGlvbi5maWVsZENvZGU7XHJcbiAgICAgICAgbGV0IHRlbXBEYXRhID0gY29uZGl0aW9uLnZhbHVlO1xyXG4gICAgICAgIGlmICh0ZW1wRGF0YSAmJiAodGVtcERhdGEuZGF0ZVZhbHVlIHx8IHRlbXBEYXRhLnZhbHVlIHx8IHRlbXBEYXRhLm51bVZhbHVlIHx8IHRlbXBEYXRhLnllYXJWYWx1ZSB8fCB0ZW1wRGF0YS5zdGFydFRpbWUgfHwgdGVtcERhdGEuZW5kVGltZSB8fCB0ZW1wRGF0YS5zdGFydFZhbHVlIHx8IHRlbXBEYXRhLmVuZFZhbHVlIHx8IHRlbXBEYXRhLm1vbnRoVmFsdWUgfHwgdGVtcERhdGEuZGF0ZXRpbWVWYWx1ZSkpIHtcclxuICAgICAgICAgIGNvbnN0IHRlbXBEYXRhVHlwZSA9IGNvbmRpdGlvbi5jb250cm9sLmdldENvbnRyb2xUeXBlKCk7XHJcbiAgICAgICAgICBzd2l0Y2ggKHRlbXBEYXRhVHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlIDA6IC8vIFRleHRcclxuICAgICAgICAgICAgY2FzZSAxNDogLy8gUmFkaW9cclxuICAgICAgICAgICAgY2FzZSAxNTogLy8g5Y+q6IO96L6T5YWl5qGGXHJcbiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0ZW1wRGF0YS52YWx1ZSArICcnID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICAgICAgdGVtcERhdGEgPSB0ZW1wRGF0YS52YWx1ZTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgMTogLy8gU2luZ2xlRGF0ZVxyXG4gICAgICAgICAgICAgIHRlbXBEYXRhID0gdGVtcERhdGEuZGF0ZVZhbHVlO1xyXG4gICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIDI6IC8vIFNtYXJ0SGVscFxyXG4gICAgICAgICAgICAgIGlmICh0ZW1wRGF0YSAmJiB0ZW1wRGF0YS52YWx1ZSAmJiB0ZW1wRGF0YS52YWx1ZS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGhlbHBWYWx1ZXM6IGFueSA9IFtdO1xyXG4gICAgICAgICAgICAgICAgdGVtcERhdGEudmFsdWUuZm9yRWFjaCgoZWw6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICBpZiAodGVtcERhdGEuaXNJbnB1dFRleHQpIHtcclxuICAgICAgICAgICAgICAgICAgICBoZWxwVmFsdWVzLnB1c2goZWwpO1xyXG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGhlbHBWYWx1ZXMucHVzaChzZWxmLmdldFZhbHVlKHRlbXBEYXRhLnZhbHVlRmllbGQsIGVsKSk7XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgdGVtcERhdGEgPSBoZWxwVmFsdWVzLmpvaW4oJywnKTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGVtcERhdGEgPSBudWxsO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAzOiAvLyBEcm9wRG93bkxpc3RcclxuICAgICAgICAgICAgICBpZiAodGVtcERhdGEgJiYgdGVtcERhdGEudmFsdWUgJiYgdGVtcERhdGEudmFsdWUubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkcm9wRG93blZhbHVlczogYW55ID0gW107XHJcbiAgICAgICAgICAgICAgICB0ZW1wRGF0YS52YWx1ZS5mb3JFYWNoKChlbDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIGRyb3BEb3duVmFsdWVzLnB1c2goZWwudmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB0ZW1wRGF0YSA9IGRyb3BEb3duVmFsdWVzLmpvaW4oJywnKTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGVtcERhdGEgPSBudWxsO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSA0OiAvLyBEYXRlUmFuZ2VcclxuICAgICAgICAgICAgY2FzZSAxMTogLy8gTW9udGhSYW5nZVxyXG4gICAgICAgICAgICAgIHRlbXBEYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgYmVnaW5WYWx1ZTogdGVtcERhdGEuc3RhcnRUaW1lID8gdGVtcERhdGEuc3RhcnRUaW1lIDogbnVsbCxcclxuICAgICAgICAgICAgICAgIGVuZFZhbHVlOiB0ZW1wRGF0YS5lbmRUaW1lID8gdGVtcERhdGEuZW5kVGltZSA6IG51bGxcclxuICAgICAgICAgICAgICB9OyAvLyB0ZW1wRGF0YS52YWx1ZTtcclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSA1OiAvLyBOdW1iZXJSYW5nZVxyXG4gICAgICAgICAgICAgIHRlbXBEYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgYmVnaW5WYWx1ZTogdGVtcERhdGEuc3RhcnRWYWx1ZSA/IHRlbXBEYXRhLnN0YXJ0VmFsdWUgOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgZW5kVmFsdWU6IHRlbXBEYXRhLmVuZFZhbHVlID8gdGVtcERhdGEuZW5kVmFsdWUgOiBudWxsXHJcbiAgICAgICAgICAgICAgfTsgLy8gdGVtcERhdGEudmFsdWU7XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgNjogLy8gU2luZ2xlTnVtYmVyXHJcbiAgICAgICAgICAgICAgdGVtcERhdGEgPSB0ZW1wRGF0YS5udW1WYWx1ZTtcclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSA3OiAvLyBTaW5nbGVZZWFyXHJcbiAgICAgICAgICAgICAgdGVtcERhdGEgPSB0ZW1wRGF0YS55ZWFyVmFsdWU7XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgODogLy8gQm9vbENoZWNrXHJcbiAgICAgICAgICAgICAgdGVtcERhdGEgPSB0ZW1wRGF0YS52YWx1ZSAmJiB0ZW1wRGF0YS52YWx1ZS5sZW5ndGggPyB0ZW1wRGF0YS52YWx1ZVswXSA6IG51bGw7XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgOTogLy8gRGF0ZVRpbWVSYW5nZVxyXG4gICAgICAgICAgICAgIHRlbXBEYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgYmVnaW5WYWx1ZTogdGVtcERhdGEuc3RhcnRUaW1lID8gdGVtcERhdGEuc3RhcnRUaW1lIDogbnVsbCxcclxuICAgICAgICAgICAgICAgIGVuZFZhbHVlOiB0ZW1wRGF0YS5lbmRUaW1lID8gdGVtcERhdGEuZW5kVGltZSA6IG51bGxcclxuICAgICAgICAgICAgICB9OyAvLyB0ZW1wRGF0YS52YWx1ZTtcclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAxMDogLy8gU2luZ2xlTW9udGhcclxuICAgICAgICAgICAgICB0ZW1wRGF0YSA9IHRlbXBEYXRhLm1vbnRoVmFsdWU7XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgMTI6IC8vIFNpbmdsZURhdGVUaW1lXHJcbiAgICAgICAgICAgICAgdGVtcERhdGEgPSB0ZW1wRGF0YS5kYXRldGltZVZhbHVlO1xyXG4gICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgY2FjaGVPYmplY3QgPSBlbnRpdHlEYXRhO1xyXG4gICAgICAgICAgaWYgKHRlbXBEYXRhRmllbGQgJiYgdGVtcERhdGFGaWVsZC5pbmRleE9mKCc7JykgPj0gMCkge1xyXG4gICAgICAgICAgICBjb25zdCBmaWVsZHMxID0gdGVtcERhdGFGaWVsZC5zcGxpdCgnOycpWzBdLnNwbGl0KCcuJyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpZWxkczIgPSB0ZW1wRGF0YUZpZWxkLnNwbGl0KCc7JylbMV0uc3BsaXQoJy4nKTtcclxuICAgICAgICAgICAgaWYgKHRlbXBEYXRhWydiZWdpblZhbHVlJ10gIT0gbnVsbCAmJiB0ZW1wRGF0YVsnYmVnaW5WYWx1ZSddICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICB0aGlzLnNldEVudGl0eURhdGEoZmllbGRzMSwgY2FjaGVPYmplY3QsIHRlbXBEYXRhWydiZWdpblZhbHVlJ10pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0ZW1wRGF0YVsnZW5kVmFsdWUnXSAhPSBudWxsICYmIHRlbXBEYXRhWydlbmRWYWx1ZSddICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICB0aGlzLnNldEVudGl0eURhdGEoZmllbGRzMiwgY2FjaGVPYmplY3QsIHRlbXBEYXRhWydlbmRWYWx1ZSddKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgZmllbGRzID0gdGVtcERhdGFGaWVsZC5zcGxpdCgnLicpO1xyXG4gICAgICAgICAgICBpZiAodGVtcERhdGEgIT0gbnVsbCAmJiB0ZW1wRGF0YSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5zZXRFbnRpdHlEYXRhKGZpZWxkcywgY2FjaGVPYmplY3QsIHRlbXBEYXRhKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICAvLyBjb25zdCBxdWVyeUlkQXJyYXkgPSBxdWVyeUlkLnNwbGl0KCc7Jyk7IC8vIOaUr+aMgeS4gOS4quafpeivoue0ouW8lei3s+i9rOWkmuS4quafpeivoue7k+aenOeahOaDheWGtVxyXG4gICAgLy8gcXVlcnlJZEFycmF5LmZvckVhY2gocXVlcnlJZEluZm8gPT4ge1xyXG4gICAgLy8gICB0aGlzLmNhY2hlU2VydmljZS5zZXQocXVlcnlJZEluZm8sIGVudGl0eURhdGEpO1xyXG4gICAgLy8gfSk7XHJcbiAgICB0aGlzLmNhY2hlU2VydmljZS5zZXQoUnRmU2VydmljZXMuZ2V0VGFiSWQocXVlcnlJZCksIGVudGl0eURhdGEpO1xyXG4gICAgdGhpcy5maWx0ZXJNYW5hZ2VyU2VydmljZS5pc0ZpbHRlclFEUC5uZXh0KHRydWUpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXRFbnRpdHlEYXRhKGZpZWxkczogYW55W10sIGNhY2hlT2JqZWN0OiBhbnksIHRlbXBEYXRhOiBhbnkpIHtcclxuICAgIGlmIChmaWVsZHMubGVuZ3RoICYmIGZpZWxkcy5sZW5ndGggPiAxKSB7XHJcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmllbGRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgaWYgKGkgPT09IDApIHtcclxuICAgICAgICAgIGNhY2hlT2JqZWN0ID0gdGhpcy5nZXRFbnRpdHlEYXRhKGZpZWxkc1tpXSwgY2FjaGVPYmplY3QpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBjYWNoZU9iamVjdCA9IHRoaXMuZ2V0RW50aXR5RGF0YShmaWVsZHNbaV0sIGNhY2hlT2JqZWN0W2ZpZWxkc1tpIC0gMV1dKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKChpICsgMSkgPT09IGZpZWxkcy5sZW5ndGgpIHtcclxuICAgICAgICAgIGNhY2hlT2JqZWN0W2ZpZWxkc1tpXV0gPSB0ZW1wRGF0YTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNhY2hlT2JqZWN0W2ZpZWxkc1swXV0gPSB0ZW1wRGF0YTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0RW50aXR5RGF0YShrZXk6IHN0cmluZywgZW50aXR5RGF0YTogYW55KTogYW55IHtcclxuICAgIGlmIChlbnRpdHlEYXRhLmhhc093blByb3BlcnR5KGtleSkpIHtcclxuICAgICAgcmV0dXJuIGVudGl0eURhdGE7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBlbnRpdHlEYXRhW2tleV0gPSB7fTtcclxuICAgICAgcmV0dXJuIGVudGl0eURhdGE7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldFZhbHVlKGZpZWxkLCBkYXRhLCBzYWZlID0gZmFsc2UpIHtcclxuICAgIGlmICghZGF0YSkge1xyXG4gICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcbiAgICBsZXQgcmVzdWx0VmFsID0gJyc7XHJcbiAgICBpZiAoZmllbGQuaW5kZXhPZignLicpID09PSAtMSkge1xyXG4gICAgICByZXN1bHRWYWwgPSBkYXRhW2ZpZWxkXTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJlc3VsdFZhbCA9IGZpZWxkLnNwbGl0KCcuJykucmVkdWNlKChcclxuICAgICAgICAob2JqLCBrZXkpID0+IHtcclxuICAgICAgICAgIGlmIChvYmopIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9ialtrZXldO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSksIGRhdGEpO1xyXG4gICAgfVxyXG4gICAgaWYgKHNhZmUpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0dGVyVmFsdWUocmVzdWx0VmFsKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiByZXN1bHRWYWw7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGZvcm1hdHRlclZhbHVlKHZhbCkge1xyXG4gICAgaWYgKHZhbCA9PT0gbnVsbCB8fCB2YWwgPT09IHVuZGVmaW5lZCB8fCB2YWwgPT09ICcnKSB7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIGlmICh0eXBlb2YgdmFsID09PSAnc3RyaW5nJykge1xyXG4gICAgICByZXR1cm4gdGhpcy5lc2NhcGVIdG1sKHZhbCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdmFsO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBlc2NhcGVIdG1sKHN0cikge1xyXG4gICAgaWYgKHN0ciA9PT0gbnVsbCB8fCBzdHIgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc3RyXHJcbiAgICAgIC5yZXBsYWNlKC8mL2csICcmYW1wOycpXHJcbiAgICAgIC5yZXBsYWNlKC88L2csICcmbHQ7JylcclxuICAgICAgLnJlcGxhY2UoLz4vZywgJyZndDsnKVxyXG4gICAgICAucmVwbGFjZSgvXFxcIi9nLCAnJnF1b3Q7JylcclxuICAgICAgLnJlcGxhY2UoL1xcJy9nLCAnJiMzOTsnKVxyXG4gICAgICAucmVwbGFjZSgvXFwvL2csICcmI3gyRjsnKTtcclxuICB9XHJcblxyXG4gIC8vIHByaXZhdGUgdW5lc2NhcGVIdG1sKHN0cikge1xyXG4gIC8vICAgaWYgKHN0ciA9PT0gbnVsbCB8fCBzdHIgPT09IHVuZGVmaW5lZCkge1xyXG4gIC8vICAgICByZXR1cm4gJyc7XHJcbiAgLy8gICB9XHJcbiAgLy8gICByZXR1cm4gc3RyXHJcbiAgLy8gICAgIC5yZXBsYWNlKC8mYW1wOy9nLCAnJicpXHJcbiAgLy8gICAgIC5yZXBsYWNlKC8mbHQ7L2csICc8JylcclxuICAvLyAgICAgLnJlcGxhY2UoLyZndDsvZywgJz4nKVxyXG4gIC8vICAgICAucmVwbGFjZSgvJnF1b3Q7L2csICdcIicpXHJcbiAgLy8gICAgIC5yZXBsYWNlKC8mIzM5Oy9nLCAnXFwnJylcclxuICAvLyAgICAgLnJlcGxhY2UoLyYjeDJGOy9nLCAnLycpO1xyXG4gIC8vIH1cclxufVxyXG4iXX0=