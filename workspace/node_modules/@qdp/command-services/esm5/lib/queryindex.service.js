/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { Repository } from '@farris/devkit';
import { CacheService } from '@ecp-caf/caf-common';
import { Router } from '@angular/router';
import { FrameworkService } from '@gsp-sys/rtf-common';
import { FilterManagerService, EventBus } from '@qdp/common';
import { RtfServices } from '@qdp/common';
var QueryIndexService = /** @class */ (function () {
    function QueryIndexService(repository, cacheService, router, frameworkService, filterManagerService) {
        this.repository = repository;
        this.cacheService = cacheService;
        this.router = router;
        this.frameworkService = frameworkService;
        this.filterManagerService = filterManagerService;
        window['excuteQDPQuery'] = this.filterManagerService.isFilterQDP;
    }
    /**
     * @param {?} queryId
     * @param {?=} path
     * @return {?}
     */
    QueryIndexService.prototype.route = /**
     * @param {?} queryId
     * @param {?=} path
     * @return {?}
     */
    function (queryId, path) {
        /** @type {?} */
        var entitys = this.repository.entityCollection.getAllEntities();
        /** @type {?} */
        var params;
        if (entitys && entitys.length) {
            params = entitys[0].toJSON();
            // const queryIdArray = queryId.split(';'); // 支持一个查询索引跳转多个查询结果的情况
            // queryIdArray.forEach(queryIdInfo => {
            //   this.cacheService.set(queryIdInfo, params);
            // });
            this.cacheService.set(RtfServices.getTabId(queryId), params);
            /** @type {?} */
            var p = 'qdpview';
            if (path) {
                p = path;
            }
            // const url = this.router.createUrlTree([this.router.url, p]).toString();
            this.router.navigateByUrl(p);
        }
    };
    /**
     * @param {?} queryId
     * @param {?} appType
     * @param {?=} appId
     * @param {?=} appEntrance
     * @param {?=} funcId
     * @return {?}
     */
    QueryIndexService.prototype.routeEx = /**
     * @param {?} queryId
     * @param {?} appType
     * @param {?=} appId
     * @param {?=} appEntrance
     * @param {?=} funcId
     * @return {?}
     */
    function (queryId, appType, appId, appEntrance, funcId) {
        /** @type {?} */
        var entitys = this.repository.entityCollection.getAllEntities();
        /** @type {?} */
        var params;
        if (entitys && entitys.length) {
            /** @type {?} */
            var tabId = EventBus.guid();
            params = entitys[0].toJSON();
            /** @type {?} */
            var options = { 'appType': appType, 'appId': appId, 'appEntrance': appEntrance, 'funcId': funcId, 'tabId': tabId };
            /** @type {?} */
            var cacheKey = RtfServices.getFuncId(options);
            this.cacheService.set(cacheKey + 'renderMode', 'queryIndex'); // 索引页的查询参数以功能ID为缓存key进行缓存，解决打开多个结果页查询覆盖问题
            this.cacheService.set(cacheKey, params);
            /** @type {?} */
            var menuSwitchControl = Object.assign({}, RtfServices.getMenuSwitchControlParameter(cacheKey));
            options['entityParams'] = menuSwitchControl;
            this.frameworkService.openMenu(options);
        }
    };
    /**
     * @return {?}
     */
    QueryIndexService.prototype.queryRefresh = /**
     * @return {?}
     */
    function () {
        this.filterManagerService.isFilterQDP.next(true);
    };
    // 查询过滤
    // 查询过滤
    /**
     * @param {?} queryId
     * @param {?} filterCondition
     * @return {?}
     */
    QueryIndexService.prototype.filterQDP = 
    // 查询过滤
    /**
     * @param {?} queryId
     * @param {?} filterCondition
     * @return {?}
     */
    function (queryId, filterCondition) {
        var _this = this;
        /** @type {?} */
        var self = this;
        filterCondition = this['context']['eventParam'];
        /** @type {?} */
        var entityData = { 'id': 'undefined_null' };
        if (filterCondition) {
            filterCondition.forEach((/**
             * @param {?} condition
             * @return {?}
             */
            function (condition) {
                /** @type {?} */
                var tempDataField = condition.fieldCode;
                /** @type {?} */
                var tempData = condition.value;
                if (tempData && (tempData.dateValue || tempData.value || tempData.numValue || tempData.yearValue || tempData.startTime || tempData.endTime || tempData.startValue || tempData.endValue || tempData.monthValue || tempData.datetimeValue)) {
                    /** @type {?} */
                    var tempDataType = condition.control.getControlType();
                    switch (tempDataType) {
                        case 0: // Text
                        case 14: // Radio
                        case 15: // 只能输入框
                            if (typeof tempData.value + '' === 'string') {
                                tempData = tempData.value;
                            }
                            break;
                        case 1: // SingleDate
                            tempData = tempData.dateValue;
                            break;
                        case 2: // SmartHelp
                            if (tempData && tempData.value && tempData.value.length) {
                                /** @type {?} */
                                var helpValues_1 = [];
                                tempData.value.forEach((/**
                                 * @param {?} el
                                 * @return {?}
                                 */
                                function (el) {
                                    if (tempData.isInputText) {
                                        helpValues_1.push(el);
                                    }
                                    else {
                                        helpValues_1.push(self.getValue(tempData.valueField, el));
                                    }
                                }));
                                tempData = helpValues_1.join(',');
                            }
                            else {
                                tempData = null;
                            }
                            break;
                        case 3: // DropDownList
                            if (tempData && tempData.value && tempData.value.length) {
                                /** @type {?} */
                                var dropDownValues_1 = [];
                                tempData.value.forEach((/**
                                 * @param {?} el
                                 * @return {?}
                                 */
                                function (el) {
                                    dropDownValues_1.push(el.value);
                                }));
                                tempData = dropDownValues_1.join(',');
                            }
                            else {
                                tempData = null;
                            }
                            break;
                        case 4: // DateRange
                        case 11: // MonthRange
                            tempData = {
                                beginValue: tempData.startTime ? tempData.startTime : null,
                                endValue: tempData.endTime ? tempData.endTime : null
                            }; // tempData.value;
                            break;
                        case 5: // NumberRange
                            tempData = {
                                beginValue: tempData.startValue ? tempData.startValue : null,
                                endValue: tempData.endValue ? tempData.endValue : null
                            }; // tempData.value;
                            break;
                        case 6: // SingleNumber
                            tempData = tempData.numValue;
                            break;
                        case 7: // SingleYear
                            tempData = tempData.yearValue;
                            break;
                        case 8: // BoolCheck
                            tempData = tempData.value && tempData.value.length ? tempData.value[0] : null;
                            break;
                        case 9: // DateTimeRange
                            tempData = {
                                beginValue: tempData.startTime ? tempData.startTime : null,
                                endValue: tempData.endTime ? tempData.endTime : null
                            }; // tempData.value;
                            break;
                        case 10: // SingleMonth
                            tempData = tempData.monthValue;
                            break;
                        case 12: // SingleDateTime
                            tempData = tempData.datetimeValue;
                            break;
                        default:
                            break;
                    }
                    /** @type {?} */
                    var cacheObject = entityData;
                    if (tempDataField && tempDataField.indexOf(';') >= 0) {
                        /** @type {?} */
                        var fields1 = tempDataField.split(';')[0].split('.');
                        /** @type {?} */
                        var fields2 = tempDataField.split(';')[1].split('.');
                        if (tempData['beginValue'] != null && tempData['beginValue'] !== undefined) {
                            _this.setEntityData(fields1, cacheObject, tempData['beginValue']);
                        }
                        if (tempData['endValue'] != null && tempData['endValue'] !== undefined) {
                            _this.setEntityData(fields2, cacheObject, tempData['endValue']);
                        }
                    }
                    else {
                        /** @type {?} */
                        var fields = tempDataField.split('.');
                        if (tempData != null && tempData !== undefined) {
                            _this.setEntityData(fields, cacheObject, tempData);
                        }
                    }
                }
            }));
        }
        // const queryIdArray = queryId.split(';'); // 支持一个查询索引跳转多个查询结果的情况
        // queryIdArray.forEach(queryIdInfo => {
        //   this.cacheService.set(queryIdInfo, entityData);
        // });
        this.cacheService.set(RtfServices.getTabId(queryId), entityData);
        this.filterManagerService.isFilterQDP.next(true);
    };
    /**
     * @private
     * @param {?} fields
     * @param {?} cacheObject
     * @param {?} tempData
     * @return {?}
     */
    QueryIndexService.prototype.setEntityData = /**
     * @private
     * @param {?} fields
     * @param {?} cacheObject
     * @param {?} tempData
     * @return {?}
     */
    function (fields, cacheObject, tempData) {
        if (fields.length && fields.length > 1) {
            for (var i = 0; i < fields.length; i++) {
                if (i === 0) {
                    cacheObject = this.getEntityData(fields[i], cacheObject);
                }
                else {
                    cacheObject = this.getEntityData(fields[i], cacheObject[fields[i - 1]]);
                }
                if ((i + 1) === fields.length) {
                    cacheObject[fields[i]] = tempData;
                }
            }
        }
        else {
            cacheObject[fields[0]] = tempData;
        }
    };
    /**
     * @private
     * @param {?} key
     * @param {?} entityData
     * @return {?}
     */
    QueryIndexService.prototype.getEntityData = /**
     * @private
     * @param {?} key
     * @param {?} entityData
     * @return {?}
     */
    function (key, entityData) {
        if (entityData.hasOwnProperty(key)) {
            return entityData;
        }
        else {
            entityData[key] = {};
            return entityData;
        }
    };
    /**
     * @private
     * @param {?} field
     * @param {?} data
     * @param {?=} safe
     * @return {?}
     */
    QueryIndexService.prototype.getValue = /**
     * @private
     * @param {?} field
     * @param {?} data
     * @param {?=} safe
     * @return {?}
     */
    function (field, data, safe) {
        if (safe === void 0) { safe = false; }
        if (!data) {
            return '';
        }
        /** @type {?} */
        var resultVal = '';
        if (field.indexOf('.') === -1) {
            resultVal = data[field];
        }
        else {
            resultVal = field.split('.').reduce(((/**
             * @param {?} obj
             * @param {?} key
             * @return {?}
             */
            function (obj, key) {
                if (obj) {
                    return obj[key];
                }
                else {
                    return null;
                }
            })), data);
        }
        if (safe) {
            return this.formatterValue(resultVal);
        }
        else {
            return resultVal;
        }
    };
    /**
     * @private
     * @param {?} val
     * @return {?}
     */
    QueryIndexService.prototype.formatterValue = /**
     * @private
     * @param {?} val
     * @return {?}
     */
    function (val) {
        if (val === null || val === undefined || val === '') {
            return '';
        }
        if (typeof val === 'string') {
            return this.escapeHtml(val);
        }
        return val;
    };
    /**
     * @private
     * @param {?} str
     * @return {?}
     */
    QueryIndexService.prototype.escapeHtml = /**
     * @private
     * @param {?} str
     * @return {?}
     */
    function (str) {
        if (str === null || str === undefined) {
            return '';
        }
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/\'/g, '&#39;')
            .replace(/\//g, '&#x2F;');
    };
    QueryIndexService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    QueryIndexService.ctorParameters = function () { return [
        { type: Repository },
        { type: CacheService },
        { type: Router },
        { type: FrameworkService },
        { type: FilterManagerService }
    ]; };
    return QueryIndexService;
}());
export { QueryIndexService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    QueryIndexService.prototype.repository;
    /**
     * @type {?}
     * @private
     */
    QueryIndexService.prototype.cacheService;
    /**
     * @type {?}
     * @private
     */
    QueryIndexService.prototype.router;
    /**
     * @type {?}
     * @private
     */
    QueryIndexService.prototype.frameworkService;
    /**
     * @type {?}
     * @private
     */
    QueryIndexService.prototype.filterManagerService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnlpbmRleC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHFkcC9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL3F1ZXJ5aW5kZXguc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzdELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFMUM7SUFFRSwyQkFDVSxVQUEyQixFQUMzQixZQUEwQixFQUMxQixNQUFjLEVBQ2QsZ0JBQWtDLEVBQ2xDLG9CQUEwQztRQUoxQyxlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBRWxELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLENBQUM7SUFDbkUsQ0FBQzs7Ozs7O0lBRUQsaUNBQUs7Ozs7O0lBQUwsVUFBTSxPQUFZLEVBQUUsSUFBVTs7WUFDdEIsT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxFQUFFOztZQUM3RCxNQUFNO1FBQ1YsSUFBSSxPQUFPLElBQUksT0FBTyxDQUFDLE1B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LEVBQUUsTUFBTSxDQUFDO2FBQ3JCLE9BQU8sQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDO2FBQ3hCLE9BQU8sQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDO2FBQ3ZCLE9BQU8sQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDOUIsQ0FBQzs7Z0JBMU9GLFVBQVU7Ozs7Z0JBUEYsVUFBVTtnQkFDVixZQUFZO2dCQUNaLE1BQU07Z0JBQ04sZ0JBQWdCO2dCQUNoQixvQkFBb0I7O0lBMlA3Qix3QkFBQztDQUFBLEFBeFBELElBd1BDO1NBdlBZLGlCQUFpQjs7Ozs7O0lBRTFCLHVDQUFtQzs7Ozs7SUFDbkMseUNBQWtDOzs7OztJQUNsQyxtQ0FBc0I7Ozs7O0lBQ3RCLDZDQUEwQzs7Ozs7SUFDMUMsaURBQWtEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBDYWNoZVNlcnZpY2UgfSBmcm9tICdAZWNwLWNhZi9jYWYtY29tbW9uJztcclxuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcclxuaW1wb3J0IHsgRnJhbWV3b3JrU2VydmljZSB9IGZyb20gJ0Bnc3Atc3lzL3J0Zi1jb21tb24nO1xyXG5pbXBvcnQgeyBGaWx0ZXJNYW5hZ2VyU2VydmljZSwgRXZlbnRCdXMgfSBmcm9tICdAcWRwL2NvbW1vbic7XHJcbmltcG9ydCB7IFJ0ZlNlcnZpY2VzIH0gZnJvbSAnQHFkcC9jb21tb24nO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgUXVlcnlJbmRleFNlcnZpY2Uge1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4sXHJcbiAgICBwcml2YXRlIGNhY2hlU2VydmljZTogQ2FjaGVTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcclxuICAgIHByaXZhdGUgZnJhbWV3b3JrU2VydmljZTogRnJhbWV3b3JrU2VydmljZSxcclxuICAgIHByaXZhdGUgZmlsdGVyTWFuYWdlclNlcnZpY2U6IEZpbHRlck1hbmFnZXJTZXJ2aWNlXHJcbiAgKSB7XHJcbiAgICB3aW5kb3dbJ2V4Y3V0ZVFEUFF1ZXJ5J10gPSB0aGlzLmZpbHRlck1hbmFnZXJTZXJ2aWNlLmlzRmlsdGVyUURQO1xyXG4gIH1cclxuXHJcbiAgcm91dGUocXVlcnlJZDogYW55LCBwYXRoPzogYW55KSB7XHJcbiAgICBjb25zdCBlbnRpdHlzID0gdGhpcy5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0QWxsRW50aXRpZXMoKTtcclxuICAgIGxldCBwYXJhbXM7XHJcbiAgICBpZiAoZW50aXR5cyAmJiBlbnRpdHlzLmxlbmd0aCkge1xyXG4gICAgICBwYXJhbXMgPSBlbnRpdHlzWzBdLnRvSlNPTigpO1xyXG4gICAgICAvLyBjb25zdCBxdWVyeUlkQXJyYXkgPSBxdWVyeUlkLnNwbGl0KCc7Jyk7IC8vIOaUr+aMgeS4gOS4quafpeivoue0ouW8lei3s+i9rOWkmuS4quafpeivoue7k+aenOeahOaDheWGtVxyXG4gICAgICAvLyBxdWVyeUlkQXJyYXkuZm9yRWFjaChxdWVyeUlkSW5mbyA9PiB7XHJcbiAgICAgIC8vICAgdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KHF1ZXJ5SWRJbmZvLCBwYXJhbXMpO1xyXG4gICAgICAvLyB9KTtcclxuICAgICAgdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KFJ0ZlNlcnZpY2VzLmdldFRhYklkKHF1ZXJ5SWQpLCBwYXJhbXMpO1xyXG4gICAgICBsZXQgcCA9ICdxZHB2aWV3JztcclxuICAgICAgaWYgKHBhdGgpIHtcclxuICAgICAgICBwID0gcGF0aDtcclxuICAgICAgfVxyXG4gICAgICAvLyBjb25zdCB1cmwgPSB0aGlzLnJvdXRlci5jcmVhdGVVcmxUcmVlKFt0aGlzLnJvdXRlci51cmwsIHBdKS50b1N0cmluZygpO1xyXG4gICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKHApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcm91dGVFeChxdWVyeUlkOiBhbnksIGFwcFR5cGU6IGFueSwgYXBwSWQ/OiBhbnksIGFwcEVudHJhbmNlPzogYW55LCBmdW5jSWQ/OiBhbnkpIHtcclxuICAgIGNvbnN0IGVudGl0eXMgPSB0aGlzLnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRBbGxFbnRpdGllcygpO1xyXG4gICAgbGV0IHBhcmFtcztcclxuICAgIGlmIChlbnRpdHlzICYmIGVudGl0eXMubGVuZ3RoKSB7XHJcbiAgICAgIGNvbnN0IHRhYklkID0gRXZlbnRCdXMuZ3VpZCgpO1xyXG4gICAgICBwYXJhbXMgPSBlbnRpdHlzWzBdLnRvSlNPTigpO1xyXG4gICAgICBjb25zdCBvcHRpb25zOiBhbnkgPSB7ICdhcHBUeXBlJzogYXBwVHlwZSwgJ2FwcElkJzogYXBwSWQsICdhcHBFbnRyYW5jZSc6IGFwcEVudHJhbmNlLCAnZnVuY0lkJzogZnVuY0lkLCAndGFiSWQnOiB0YWJJZCB9O1xyXG4gICAgICBjb25zdCBjYWNoZUtleSA9IFJ0ZlNlcnZpY2VzLmdldEZ1bmNJZChvcHRpb25zKTtcclxuICAgICAgdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KGNhY2hlS2V5ICsgJ3JlbmRlck1vZGUnLCAncXVlcnlJbmRleCcpOyAvLyDntKLlvJXpobXnmoTmn6Xor6Llj4LmlbDku6Xlip/og71JROS4uue8k+WtmGtleei/m+ihjOe8k+WtmO+8jOino+WGs+aJk+W8gOWkmuS4que7k+aenOmhteafpeivouimhueblumXrumimFxyXG4gICAgICB0aGlzLmNhY2hlU2VydmljZS5zZXQoY2FjaGVLZXksIHBhcmFtcyk7XHJcbiAgICAgIGNvbnN0IG1lbnVTd2l0Y2hDb250cm9sID0gT2JqZWN0LmFzc2lnbih7fSwgUnRmU2VydmljZXMuZ2V0TWVudVN3aXRjaENvbnRyb2xQYXJhbWV0ZXIoY2FjaGVLZXkpKTtcclxuICAgICAgb3B0aW9uc1snZW50aXR5UGFyYW1zJ10gPSBtZW51U3dpdGNoQ29udHJvbDtcclxuICAgICAgdGhpcy5mcmFtZXdvcmtTZXJ2aWNlLm9wZW5NZW51KG9wdGlvbnMpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcXVlcnlSZWZyZXNoKCkge1xyXG4gICAgdGhpcy5maWx0ZXJNYW5hZ2VyU2VydmljZS5pc0ZpbHRlclFEUC5uZXh0KHRydWUpO1xyXG4gIH1cclxuXHJcbiAgLy8g5p+l6K+i6L+H5rukXHJcbiAgZmlsdGVyUURQKHF1ZXJ5SWQ6IGFueSwgZmlsdGVyQ29uZGl0aW9uOiBhbnkpIHtcclxuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgZmlsdGVyQ29uZGl0aW9uID0gdGhpc1snY29udGV4dCddWydldmVudFBhcmFtJ107XHJcbiAgICBjb25zdCBlbnRpdHlEYXRhOiBhbnkgPSB7ICdpZCc6ICd1bmRlZmluZWRfbnVsbCcgfTtcclxuICAgIGlmIChmaWx0ZXJDb25kaXRpb24pIHtcclxuICAgICAgZmlsdGVyQ29uZGl0aW9uLmZvckVhY2goY29uZGl0aW9uID0+IHtcclxuICAgICAgICBjb25zdCB0ZW1wRGF0YUZpZWxkID0gY29uZGl0aW9uLmZpZWxkQ29kZTtcclxuICAgICAgICBsZXQgdGVtcERhdGEgPSBjb25kaXRpb24udmFsdWU7XHJcbiAgICAgICAgaWYgKHRlbXBEYXRhICYmICh0ZW1wRGF0YS5kYXRlVmFsdWUgfHwgdGVtcERhdGEudmFsdWUgfHwgdGVtcERhdGEubnVtVmFsdWUgfHwgdGVtcERhdGEueWVhclZhbHVlIHx8IHRlbXBEYXRhLnN0YXJ0VGltZSB8fCB0ZW1wRGF0YS5lbmRUaW1lIHx8IHRlbXBEYXRhLnN0YXJ0VmFsdWUgfHwgdGVtcERhdGEuZW5kVmFsdWUgfHwgdGVtcERhdGEubW9udGhWYWx1ZSB8fCB0ZW1wRGF0YS5kYXRldGltZVZhbHVlKSkge1xyXG4gICAgICAgICAgY29uc3QgdGVtcERhdGFUeXBlID0gY29uZGl0aW9uLmNvbnRyb2wuZ2V0Q29udHJvbFR5cGUoKTtcclxuICAgICAgICAgIHN3aXRjaCAodGVtcERhdGFUeXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgMDogLy8gVGV4dFxyXG4gICAgICAgICAgICBjYXNlIDE0OiAvLyBSYWRpb1xyXG4gICAgICAgICAgICBjYXNlIDE1OiAvLyDlj6rog73ovpPlhaXmoYZcclxuICAgICAgICAgICAgICBpZiAodHlwZW9mIHRlbXBEYXRhLnZhbHVlICsgJycgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wRGF0YSA9IHRlbXBEYXRhLnZhbHVlO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAxOiAvLyBTaW5nbGVEYXRlXHJcbiAgICAgICAgICAgICAgdGVtcERhdGEgPSB0ZW1wRGF0YS5kYXRlVmFsdWU7XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgMjogLy8gU21hcnRIZWxwXHJcbiAgICAgICAgICAgICAgaWYgKHRlbXBEYXRhICYmIHRlbXBEYXRhLnZhbHVlICYmIHRlbXBEYXRhLnZhbHVlLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaGVscFZhbHVlczogYW55ID0gW107XHJcbiAgICAgICAgICAgICAgICB0ZW1wRGF0YS52YWx1ZS5mb3JFYWNoKChlbDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIGlmICh0ZW1wRGF0YS5pc0lucHV0VGV4dCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGhlbHBWYWx1ZXMucHVzaChlbCk7XHJcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaGVscFZhbHVlcy5wdXNoKHNlbGYuZ2V0VmFsdWUodGVtcERhdGEudmFsdWVGaWVsZCwgZWwpKTtcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB0ZW1wRGF0YSA9IGhlbHBWYWx1ZXMuam9pbignLCcpO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wRGF0YSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIDM6IC8vIERyb3BEb3duTGlzdFxyXG4gICAgICAgICAgICAgIGlmICh0ZW1wRGF0YSAmJiB0ZW1wRGF0YS52YWx1ZSAmJiB0ZW1wRGF0YS52YWx1ZS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRyb3BEb3duVmFsdWVzOiBhbnkgPSBbXTtcclxuICAgICAgICAgICAgICAgIHRlbXBEYXRhLnZhbHVlLmZvckVhY2goKGVsOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgZHJvcERvd25WYWx1ZXMucHVzaChlbC52YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHRlbXBEYXRhID0gZHJvcERvd25WYWx1ZXMuam9pbignLCcpO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wRGF0YSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIDQ6IC8vIERhdGVSYW5nZVxyXG4gICAgICAgICAgICBjYXNlIDExOiAvLyBNb250aFJhbmdlXHJcbiAgICAgICAgICAgICAgdGVtcERhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICBiZWdpblZhbHVlOiB0ZW1wRGF0YS5zdGFydFRpbWUgPyB0ZW1wRGF0YS5zdGFydFRpbWUgOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgZW5kVmFsdWU6IHRlbXBEYXRhLmVuZFRpbWUgPyB0ZW1wRGF0YS5lbmRUaW1lIDogbnVsbFxyXG4gICAgICAgICAgICAgIH07IC8vIHRlbXBEYXRhLnZhbHVlO1xyXG4gICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIDU6IC8vIE51bWJlclJhbmdlXHJcbiAgICAgICAgICAgICAgdGVtcERhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICBiZWdpblZhbHVlOiB0ZW1wRGF0YS5zdGFydFZhbHVlID8gdGVtcERhdGEuc3RhcnRWYWx1ZSA6IG51bGwsXHJcbiAgICAgICAgICAgICAgICBlbmRWYWx1ZTogdGVtcERhdGEuZW5kVmFsdWUgPyB0ZW1wRGF0YS5lbmRWYWx1ZSA6IG51bGxcclxuICAgICAgICAgICAgICB9OyAvLyB0ZW1wRGF0YS52YWx1ZTtcclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSA2OiAvLyBTaW5nbGVOdW1iZXJcclxuICAgICAgICAgICAgICB0ZW1wRGF0YSA9IHRlbXBEYXRhLm51bVZhbHVlO1xyXG4gICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIDc6IC8vIFNpbmdsZVllYXJcclxuICAgICAgICAgICAgICB0ZW1wRGF0YSA9IHRlbXBEYXRhLnllYXJWYWx1ZTtcclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSA4OiAvLyBCb29sQ2hlY2tcclxuICAgICAgICAgICAgICB0ZW1wRGF0YSA9IHRlbXBEYXRhLnZhbHVlICYmIHRlbXBEYXRhLnZhbHVlLmxlbmd0aCA/IHRlbXBEYXRhLnZhbHVlWzBdIDogbnVsbDtcclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSA5OiAvLyBEYXRlVGltZVJhbmdlXHJcbiAgICAgICAgICAgICAgdGVtcERhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICBiZWdpblZhbHVlOiB0ZW1wRGF0YS5zdGFydFRpbWUgPyB0ZW1wRGF0YS5zdGFydFRpbWUgOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgZW5kVmFsdWU6IHRlbXBEYXRhLmVuZFRpbWUgPyB0ZW1wRGF0YS5lbmRUaW1lIDogbnVsbFxyXG4gICAgICAgICAgICAgIH07IC8vIHRlbXBEYXRhLnZhbHVlO1xyXG4gICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIDEwOiAvLyBTaW5nbGVNb250aFxyXG4gICAgICAgICAgICAgIHRlbXBEYXRhID0gdGVtcERhdGEubW9udGhWYWx1ZTtcclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAxMjogLy8gU2luZ2xlRGF0ZVRpbWVcclxuICAgICAgICAgICAgICB0ZW1wRGF0YSA9IHRlbXBEYXRhLmRhdGV0aW1lVmFsdWU7XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjb25zdCBjYWNoZU9iamVjdCA9IGVudGl0eURhdGE7XHJcbiAgICAgICAgICBpZiAodGVtcERhdGFGaWVsZCAmJiB0ZW1wRGF0YUZpZWxkLmluZGV4T2YoJzsnKSA+PSAwKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpZWxkczEgPSB0ZW1wRGF0YUZpZWxkLnNwbGl0KCc7JylbMF0uc3BsaXQoJy4nKTtcclxuICAgICAgICAgICAgY29uc3QgZmllbGRzMiA9IHRlbXBEYXRhRmllbGQuc3BsaXQoJzsnKVsxXS5zcGxpdCgnLicpO1xyXG4gICAgICAgICAgICBpZiAodGVtcERhdGFbJ2JlZ2luVmFsdWUnXSAhPSBudWxsICYmIHRlbXBEYXRhWydiZWdpblZhbHVlJ10gIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgIHRoaXMuc2V0RW50aXR5RGF0YShmaWVsZHMxLCBjYWNoZU9iamVjdCwgdGVtcERhdGFbJ2JlZ2luVmFsdWUnXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHRlbXBEYXRhWydlbmRWYWx1ZSddICE9IG51bGwgJiYgdGVtcERhdGFbJ2VuZFZhbHVlJ10gIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgIHRoaXMuc2V0RW50aXR5RGF0YShmaWVsZHMyLCBjYWNoZU9iamVjdCwgdGVtcERhdGFbJ2VuZFZhbHVlJ10pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBmaWVsZHMgPSB0ZW1wRGF0YUZpZWxkLnNwbGl0KCcuJyk7XHJcbiAgICAgICAgICAgIGlmICh0ZW1wRGF0YSAhPSBudWxsICYmIHRlbXBEYXRhICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICB0aGlzLnNldEVudGl0eURhdGEoZmllbGRzLCBjYWNoZU9iamVjdCwgdGVtcERhdGEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIC8vIGNvbnN0IHF1ZXJ5SWRBcnJheSA9IHF1ZXJ5SWQuc3BsaXQoJzsnKTsgLy8g5pSv5oyB5LiA5Liq5p+l6K+i57Si5byV6Lez6L2s5aSa5Liq5p+l6K+i57uT5p6c55qE5oOF5Ya1XHJcbiAgICAvLyBxdWVyeUlkQXJyYXkuZm9yRWFjaChxdWVyeUlkSW5mbyA9PiB7XHJcbiAgICAvLyAgIHRoaXMuY2FjaGVTZXJ2aWNlLnNldChxdWVyeUlkSW5mbywgZW50aXR5RGF0YSk7XHJcbiAgICAvLyB9KTtcclxuICAgIHRoaXMuY2FjaGVTZXJ2aWNlLnNldChSdGZTZXJ2aWNlcy5nZXRUYWJJZChxdWVyeUlkKSwgZW50aXR5RGF0YSk7XHJcbiAgICB0aGlzLmZpbHRlck1hbmFnZXJTZXJ2aWNlLmlzRmlsdGVyUURQLm5leHQodHJ1ZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldEVudGl0eURhdGEoZmllbGRzOiBhbnlbXSwgY2FjaGVPYmplY3Q6IGFueSwgdGVtcERhdGE6IGFueSkge1xyXG4gICAgaWYgKGZpZWxkcy5sZW5ndGggJiYgZmllbGRzLmxlbmd0aCA+IDEpIHtcclxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaWVsZHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBpZiAoaSA9PT0gMCkge1xyXG4gICAgICAgICAgY2FjaGVPYmplY3QgPSB0aGlzLmdldEVudGl0eURhdGEoZmllbGRzW2ldLCBjYWNoZU9iamVjdCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGNhY2hlT2JqZWN0ID0gdGhpcy5nZXRFbnRpdHlEYXRhKGZpZWxkc1tpXSwgY2FjaGVPYmplY3RbZmllbGRzW2kgLSAxXV0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoKGkgKyAxKSA9PT0gZmllbGRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgY2FjaGVPYmplY3RbZmllbGRzW2ldXSA9IHRlbXBEYXRhO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY2FjaGVPYmplY3RbZmllbGRzWzBdXSA9IHRlbXBEYXRhO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRFbnRpdHlEYXRhKGtleTogc3RyaW5nLCBlbnRpdHlEYXRhOiBhbnkpOiBhbnkge1xyXG4gICAgaWYgKGVudGl0eURhdGEuaGFzT3duUHJvcGVydHkoa2V5KSkge1xyXG4gICAgICByZXR1cm4gZW50aXR5RGF0YTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGVudGl0eURhdGFba2V5XSA9IHt9O1xyXG4gICAgICByZXR1cm4gZW50aXR5RGF0YTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0VmFsdWUoZmllbGQsIGRhdGEsIHNhZmUgPSBmYWxzZSkge1xyXG4gICAgaWYgKCFkYXRhKSB7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIGxldCByZXN1bHRWYWwgPSAnJztcclxuICAgIGlmIChmaWVsZC5pbmRleE9mKCcuJykgPT09IC0xKSB7XHJcbiAgICAgIHJlc3VsdFZhbCA9IGRhdGFbZmllbGRdO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmVzdWx0VmFsID0gZmllbGQuc3BsaXQoJy4nKS5yZWR1Y2UoKFxyXG4gICAgICAgIChvYmosIGtleSkgPT4ge1xyXG4gICAgICAgICAgaWYgKG9iaikge1xyXG4gICAgICAgICAgICByZXR1cm4gb2JqW2tleV07XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KSwgZGF0YSk7XHJcbiAgICB9XHJcbiAgICBpZiAoc2FmZSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5mb3JtYXR0ZXJWYWx1ZShyZXN1bHRWYWwpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHJlc3VsdFZhbDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZm9ybWF0dGVyVmFsdWUodmFsKSB7XHJcbiAgICBpZiAodmFsID09PSBudWxsIHx8IHZhbCA9PT0gdW5kZWZpbmVkIHx8IHZhbCA9PT0gJycpIHtcclxuICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmVzY2FwZUh0bWwodmFsKTtcclxuICAgIH1cclxuICAgIHJldHVybiB2YWw7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGVzY2FwZUh0bWwoc3RyKSB7XHJcbiAgICBpZiAoc3RyID09PSBudWxsIHx8IHN0ciA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIHJldHVybiBzdHJcclxuICAgICAgLnJlcGxhY2UoLyYvZywgJyZhbXA7JylcclxuICAgICAgLnJlcGxhY2UoLzwvZywgJyZsdDsnKVxyXG4gICAgICAucmVwbGFjZSgvPi9nLCAnJmd0OycpXHJcbiAgICAgIC5yZXBsYWNlKC9cXFwiL2csICcmcXVvdDsnKVxyXG4gICAgICAucmVwbGFjZSgvXFwnL2csICcmIzM5OycpXHJcbiAgICAgIC5yZXBsYWNlKC9cXC8vZywgJyYjeDJGOycpO1xyXG4gIH1cclxuXHJcbiAgLy8gcHJpdmF0ZSB1bmVzY2FwZUh0bWwoc3RyKSB7XHJcbiAgLy8gICBpZiAoc3RyID09PSBudWxsIHx8IHN0ciA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgLy8gICAgIHJldHVybiAnJztcclxuICAvLyAgIH1cclxuICAvLyAgIHJldHVybiBzdHJcclxuICAvLyAgICAgLnJlcGxhY2UoLyZhbXA7L2csICcmJylcclxuICAvLyAgICAgLnJlcGxhY2UoLyZsdDsvZywgJzwnKVxyXG4gIC8vICAgICAucmVwbGFjZSgvJmd0Oy9nLCAnPicpXHJcbiAgLy8gICAgIC5yZXBsYWNlKC8mcXVvdDsvZywgJ1wiJylcclxuICAvLyAgICAgLnJlcGxhY2UoLyYjMzk7L2csICdcXCcnKVxyXG4gIC8vICAgICAucmVwbGFjZSgvJiN4MkY7L2csICcvJyk7XHJcbiAgLy8gfVxyXG59XHJcbiJdfQ==