/**
 * @fileoverview added by tsickle
 * Generated from: lib/component/step-component/step-component.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, ViewContainerRef, ComponentFactoryResolver, Output, Input, ViewChild, EventEmitter } from '@angular/core';
import { find, findIndex, merge } from 'lodash-es';
import { LocalizeService } from '@qdp/localize';
var StepComponentComponent = /** @class */ (function () {
    function StepComponentComponent(viewContainerRef, componentFactoryResolver, localizeService) {
        this.viewContainerRef = viewContainerRef;
        this.componentFactoryResolver = componentFactoryResolver;
        this.localizeService = localizeService;
        this.clickCancelBtn = new EventEmitter();
        this.clickFinishBtn = new EventEmitter();
        this.title = '';
        this.steps = [];
        this._copySteps = [];
        this.curStepIndex = 0;
        this.labelPre = '上一步';
        this.labelNext = '下一步';
        this.labelFinish = '完成';
        this.labelDelete = '删除';
        this.labelPre = this.localizeService.getValue('formular.step.labelPre');
        this.labelNext = this.localizeService.getValue('formular.step.labelNext');
        this.labelFinish = this.localizeService.getValue('formular.step.labelFinish');
        this.labelDelete = this.localizeService.getValue('formular.step.labelDelete');
    }
    /**
     * @return {?}
     */
    StepComponentComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        if (this.steps && this.steps.length > 0) {
            this.curStep = this.steps[this.curStepIndex];
            this.createStepComponent(this.steps[this.curStepIndex]);
            // this.createStepComponent(this.steps[4]);
        }
        this._copySteps = this.steps;
    };
    /**
     * @param {?} step
     * @return {?}
     */
    StepComponentComponent.prototype.createStepComponent = /**
     * @param {?} step
     * @return {?}
     */
    function (step) {
        var _this = this;
        this.stepContainer.clear();
        /** @type {?} */
        var componentFactory = this.componentFactoryResolver.resolveComponentFactory(step.component);
        this.curComponentRef = this.stepContainer.createComponent(componentFactory);
        this.curComponentRef.instance.data = step.data;
        // 新增步骤
        if (this.curComponentRef.instance.addStep) {
            this.curComponentRef.instance.addStep.subscribe((/**
             * @param {?} stepList
             * @return {?}
             */
            function (stepList) {
                var _a;
                /** @type {?} */
                var curIndex = findIndex(_this.steps, _this.curStep);
                (_a = _this.steps).splice.apply(_a, tslib_1.__spread([curIndex + 1, 0], stepList));
                _this.curStep.nextStep = stepList[0].stepId;
                _this.curStep.showFinishBtn = false;
                _this.curStep.showNextStepBtn = true;
            }));
        }
        // 删除步骤
        if (this.curComponentRef.instance.removeStep) {
            this.curComponentRef.instance.removeStep.subscribe((/**
             * @param {?} data
             * @return {?}
             */
            function (data) {
                merge(_this.curStep, data.curStep);
                data.removeSteps.forEach((/**
                 * @param {?} removeStep
                 * @return {?}
                 */
                function (removeStep) {
                    /** @type {?} */
                    var index = findIndex(_this.steps, removeStep);
                    if (index >= 0) {
                        _this.steps.splice(index, 1);
                    }
                }));
            }));
        }
        // 变更步骤
        if (this.curComponentRef.instance.changeStep) {
            this.curComponentRef.instance.changeStep.subscribe((/**
             * @param {?} stepList
             * @return {?}
             */
            function (stepList) {
                stepList.forEach((/**
                 * @param {?} changeStep
                 * @return {?}
                 */
                function (changeStep) {
                    /** @type {?} */
                    var oldStep = find(_this._copySteps, (/**
                     * @param {?} s
                     * @return {?}
                     */
                    function (s) { return s.stepId === changeStep.stepId; }));
                    merge(oldStep, changeStep);
                }));
                _this.steps = _this._copySteps.filter((/**
                 * @param {?} step
                 * @return {?}
                 */
                function (step) { return step.show !== false; }));
            }));
        }
    };
    /**
     * @param {?} nextStep
     * @return {?}
     */
    StepComponentComponent.prototype.jumpStep = /**
     * @param {?} nextStep
     * @return {?}
     */
    function (nextStep) {
        // 判断跳转方向
        if (nextStep === this.curStep) {
            return;
        }
        /** @type {?} */
        var nextIndex = findIndex(this.steps, (/**
         * @param {?} s
         * @return {?}
         */
        function (s) { return s.stepId === nextStep.stepId; }));
        if (nextIndex === this.curStepIndex) {
            return;
        }
        if (nextIndex < this.curStepIndex) { // 向前跳
            this.curStep = nextStep;
            this.curStepIndex = nextIndex;
            this.createStepComponent(nextStep);
            return;
        }
        if (nextStep.stepId === this.curStep.nextStep) { // 下一步
            this.nextStep();
            return;
        }
        //  else if (this.finishedSteps.indexOf(nextStep.stepId) > -1) { // 已完成的后续步骤
        //   this.curStep = nextStep;
        //   this.curStepIndex = nextIndex;
        //   this.createStepComponent(nextStep);
        // }
    };
    /**
      * 点击上一步
      */
    /**
     * 点击上一步
     * @return {?}
     */
    StepComponentComponent.prototype.lastStep = /**
     * 点击上一步
     * @return {?}
     */
    function () {
        /** @type {?} */
        var self = this;
        this.curStepIndex = findIndex(this.steps, (/**
         * @param {?} s
         * @return {?}
         */
        function (s) { return s.nextStep === self.curStep.stepId; }));
        this.curStep = this.steps[this.curStepIndex];
        // 执行各Component定义的nextStepClick事件
        /** @type {?} */
        var clickLastStep = this.curComponentRef.instance.clickLastStep;
        if (clickLastStep && typeof (clickLastStep) === 'function') {
            /** @type {?} */
            var result = clickLastStep();
            if (typeof (result) === 'boolean' && result) {
                this.createStepComponent(this.curStep);
            }
        }
    };
    /**
     * 点击下一步
     */
    /**
     * 点击下一步
     * @return {?}
     */
    StepComponentComponent.prototype.nextStep = /**
     * 点击下一步
     * @return {?}
     */
    function () {
        var _this = this;
        // 校验
        /** @type {?} */
        var validationFunc = this.curComponentRef.instance.validation;
        if (validationFunc && typeof (validationFunc) === 'function') {
            /** @type {?} */
            var result = validationFunc();
            if (!result) {
                return;
            }
        }
        // 执行各Component定义的nextStepClick事件
        /** @type {?} */
        var clickNextStep = this.curComponentRef.instance.clickNextStep;
        if (clickNextStep && typeof (clickNextStep) === 'function') {
            /** @type {?} */
            var result = clickNextStep();
            if (typeof (result) === 'boolean' && result) {
                this.moveToNextStep(result);
            }
            else {
                if (result) {
                    result.subscribe((/**
                     * @param {?} data
                     * @return {?}
                     */
                    function (data) {
                        _this.moveToNextStep(data);
                    }));
                }
            }
        }
        else {
            this.moveToNextStep(true);
        }
    };
    /**
     * @param {?} data
     * @return {?}
     */
    StepComponentComponent.prototype.moveToNextStep = /**
     * @param {?} data
     * @return {?}
     */
    function (data) {
        if (!data) {
            return;
        }
        /** @type {?} */
        var curStep = this.curStep;
        if (curStep.nextStep === '') {
            return;
        }
        // this.finishedSteps.push(curStep.stepId);
        this.curStepIndex = findIndex(this.steps, (/**
         * @param {?} s
         * @return {?}
         */
        function (s) { return s.stepId === curStep.nextStep; }));
        if (this.curStepIndex > -1) {
            this.curStep = this.steps[this.curStepIndex];
            this.createStepComponent(this.curStep);
        }
    };
    /**
     * 取消
     */
    /**
     * 取消
     * @return {?}
     */
    StepComponentComponent.prototype.clickCancel = /**
     * 取消
     * @return {?}
     */
    function () {
        this.clickCancelBtn.emit();
    };
    /**
     * 完成
     */
    /**
     * 完成
     * @return {?}
     */
    StepComponentComponent.prototype.finishWizard = /**
     * 完成
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var validationFunc = this.curComponentRef.instance.validation;
        if (validationFunc && typeof (validationFunc) === 'function') {
            /** @type {?} */
            var result = validationFunc();
            if (!result) {
                return;
            }
        }
        /** @type {?} */
        var beforeFinish = this.curComponentRef.instance.beforeFinish;
        if (this.curComponentRef.instance.qdpResult && !beforeFinish) {
            beforeFinish = this.curComponentRef.instance.qdpResult.beforeFinish;
        }
        if (beforeFinish && typeof (beforeFinish) === 'function') {
            /** @type {?} */
            var result = beforeFinish();
            if (typeof (result) === 'boolean' && result) {
                this.clickFinishBtn.emit();
            }
            else if (typeof (result) !== 'boolean') {
                if (result) {
                    result.subscribe((/**
                     * @param {?} data
                     * @return {?}
                     */
                    function (data) {
                        if (data) {
                            _this.clickFinishBtn.emit(data);
                        }
                    }));
                }
            }
        }
    };
    StepComponentComponent.decorators = [
        { type: Component, args: [{
                    selector: 'lib-step-component',
                    template: "<div class=\"stepWizard\">\r\n  <div class=\"createNav d-flex flex-wrap\" *ngIf=\"steps.length>1\">\r\n    <div *ngFor=\"let step of steps;let i = index\" class=\"d-flex step\" [class.active]=\"curStepIndex>=i\">\r\n      <div class=\"d-flex\" *ngIf=\"step.show\" (click)=\"jumpStep(step)\">\r\n        <div class=\"pointer d-flex\">\r\n          <div class=\"stepIndex\"><span>{{i+1}}</span></div>\r\n          <div class=\"stepTitle\">{{step.title}}</div>\r\n        </div>\r\n        <div class=\"triangle_border_right\" *ngIf=\"step.nextStep\">\r\n          <span>\u00B7\u00B7\u00B7\u00B7\u00B7></span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n\r\n  <div class=\"content\">\r\n    <perfect-scrollbar [config]=\"{suppressScrollX: true}\">\r\n      <ng-container #stepContainer></ng-container>\r\n    </perfect-scrollbar>\r\n  </div>\r\n\r\n\r\n\r\n  <div class=\"footBtns\">\r\n    <button type=\"button\" class=\"btn btn-secondary btn-sm px-3 mx-2\" *ngIf=\"curStep.showLastStepBtn\" (click)=\"lastStep()\"\r\n      type=\"submit\">{{labelPre}}</button>\r\n    <button type=\"button\" class=\"btn btn-primary btn-sm px-3 mx-2\" *ngIf=\"curStep.showNextStepBtn\" (click)=\"nextStep()\"\r\n      type=\"submit\">{{labelNext}}</button>\r\n    <button type=\"button\" class=\"btn btn-primary btn-sm px-3 mx-2\" *ngIf=\"curStep.showFinishBtn\" (click)=\"finishWizard()\">{{labelFinish}}</button>\r\n  </div>\r\n</div>\r\n",
                    styles: [":host{position:absolute;top:0;bottom:0;left:0;right:0}.stepWizard{height:100%;display:flex;flex-direction:column;background:#f8f8fa}.stepWizard .createNav{background:#fff;box-shadow:0 2px 2px 0 rgba(0,0,0,.04);height:50px;overflow:hidden;padding:0 27px}.stepWizard .createNav div{margin:auto 0}.stepWizard .createNav .pointer{cursor:pointer}.stepWizard .createNav .stepIndex{height:24px;width:24px;background-color:#d9d9d9;color:#fff;border-radius:100%;text-align:center}.stepWizard .createNav .step.active .stepIndex{background-color:#59a1ff}.stepWizard .createNav .stepIndex span{line-height:24px}.stepWizard .createNav .step.active .stepIndex span{background-color:#59a1ff}.stepWizard .createNav .stepTitle{color:#8c8c8c;padding-left:11px;font-size:14px}.stepWizard .createNav .step.active .stepTitle{color:rgba(0,0,0,.85)}.stepWizard .createNav .stepTitle.disable{color:#cdcdcf}.stepWizard .createNav .step .triangle_border_right{position:relative}.stepWizard .createNav .step .triangle_border_right span{padding:0 9px;color:#d9d9d9}.stepWizard .createNav .step.active .triangle_border_right span{color:#59a1ff}.stepWizard .content{flex:1;overflow:auto;font-size:.875rem}.stepWizard .content .ps-content{width:inherit;height:inherit}.stepWizard .footBtns{width:100%;display:flex;align-items:center;justify-content:flex-end;padding:10px 1rem;background:#f4f4f4;border-top:1px solid #ddd}"]
                }] }
    ];
    /** @nocollapse */
    StepComponentComponent.ctorParameters = function () { return [
        { type: ViewContainerRef },
        { type: ComponentFactoryResolver },
        { type: LocalizeService }
    ]; };
    StepComponentComponent.propDecorators = {
        clickCancelBtn: [{ type: Output }],
        clickFinishBtn: [{ type: Output }],
        title: [{ type: Input }],
        steps: [{ type: Input }],
        stepContainer: [{ type: ViewChild, args: ['stepContainer', { read: ViewContainerRef },] }]
    };
    return StepComponentComponent;
}());
export { StepComponentComponent };
if (false) {
    /** @type {?} */
    StepComponentComponent.prototype.clickCancelBtn;
    /** @type {?} */
    StepComponentComponent.prototype.clickFinishBtn;
    /** @type {?} */
    StepComponentComponent.prototype.title;
    /** @type {?} */
    StepComponentComponent.prototype.steps;
    /** @type {?} */
    StepComponentComponent.prototype._copySteps;
    /** @type {?} */
    StepComponentComponent.prototype.curStep;
    /** @type {?} */
    StepComponentComponent.prototype.curStepIndex;
    /** @type {?} */
    StepComponentComponent.prototype.curComponentRef;
    /** @type {?} */
    StepComponentComponent.prototype.stepContainer;
    /** @type {?} */
    StepComponentComponent.prototype.labelPre;
    /** @type {?} */
    StepComponentComponent.prototype.labelNext;
    /** @type {?} */
    StepComponentComponent.prototype.labelFinish;
    /** @type {?} */
    StepComponentComponent.prototype.labelDelete;
    /**
     * @type {?}
     * @private
     */
    StepComponentComponent.prototype.viewContainerRef;
    /**
     * @type {?}
     * @private
     */
    StepComponentComponent.prototype.componentFactoryResolver;
    /**
     * @type {?}
     * @private
     */
    StepComponentComponent.prototype.localizeService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RlcC1jb21wb25lbnQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHFkcC9mb3JtdWxhci8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnQvc3RlcC1jb21wb25lbnQvc3RlcC1jb21wb25lbnQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQXdCLGdCQUFnQixFQUFFLHdCQUF3QixFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNwSixPQUFPLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbkQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVoRDtJQXdCRSxnQ0FBb0IsZ0JBQWtDLEVBQzVDLHdCQUFrRCxFQUNsRCxlQUFnQztRQUZ0QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQzVDLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBbkJoQyxtQkFBYyxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFDekMsbUJBQWMsR0FBRyxJQUFJLFlBQVksRUFBTyxDQUFDO1FBRTFDLFVBQUssR0FBRyxFQUFFLENBQUM7UUFDWCxVQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLGVBQVUsR0FBRyxFQUFFLENBQUM7UUFFaEIsaUJBQVksR0FBRyxDQUFDLENBQUM7UUFLakIsYUFBUSxHQUFRLEtBQUssQ0FBQztRQUN0QixjQUFTLEdBQVEsS0FBSyxDQUFDO1FBQ3ZCLGdCQUFXLEdBQVEsSUFBSSxDQUFDO1FBQ3hCLGdCQUFXLEdBQVEsSUFBSSxDQUFDO1FBS3BCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsd0JBQXdCLENBQUMsQ0FBQztRQUN4RSxJ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RTtnQkFDeEMsSUFBSSxNQUFNLEVBQUU7b0JBQ1YsTUFBTSxDQUFDLFNBQVM7Ozs7b0JBQUMsVUFBQSxJQUFJO3dCQUNuQixJQUFJLElBQUksRUFBRTs0QkFDUixLQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzt5QkFDaEM7b0JBQ0gsQ0FBQyxFQUFDLENBQUM7aUJBQ0o7YUFDRjtTQUNGO0lBQ0gsQ0FBQzs7Z0JBN01GLFNBQVMsU0FBQztvQkFDVCxRQUFRLEVBQUUsb0JBQW9CO29CQUM5Qiw4NkNBQThDOztpQkFFL0M7Ozs7Z0JBUnlDLGdCQUFnQjtnQkFBRSx3QkFBd0I7Z0JBRTNFLGVBQWU7OztpQ0FTckIsTUFBTTtpQ0FDTixNQUFNO3dCQUVOLEtBQUs7d0JBQ0wsS0FBSztnQ0FNTCxTQUFTLFNBQUMsZUFBZSxFQUFFLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixFQUFFOztJQThMeEQsNkJBQUM7Q0FBQSxBQS9NRCxJQStNQztTQTFNWSxzQkFBc0I7OztJQUVqQyxnREFBbUQ7O0lBQ25ELGdEQUFtRDs7SUFFbkQsdUNBQW9COztJQUNwQix1Q0FBb0I7O0lBQ3BCLDRDQUFnQjs7SUFDaEIseUNBQVE7O0lBQ1IsOENBQWlCOztJQUNqQixpREFBbUM7O0lBRW5DLCtDQUF3Rjs7SUFFeEYsMENBQXNCOztJQUN0QiwyQ0FBdUI7O0lBQ3ZCLDZDQUF3Qjs7SUFDeEIsNkNBQXdCOzs7OztJQUVaLGtEQUEwQzs7Ozs7SUFDcEQsMERBQTBEOzs7OztJQUMxRCxpREFBd0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgQ29tcG9uZW50UmVmLCBWaWV3Q29udGFpbmVyUmVmLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIE91dHB1dCwgSW5wdXQsIFZpZXdDaGlsZCwgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IGZpbmQsIGZpbmRJbmRleCwgbWVyZ2UgfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG5pbXBvcnQgeyBMb2NhbGl6ZVNlcnZpY2UgfSBmcm9tICdAcWRwL2xvY2FsaXplJztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAnbGliLXN0ZXAtY29tcG9uZW50JyxcclxuICB0ZW1wbGF0ZVVybDogJy4vc3RlcC1jb21wb25lbnQuY29tcG9uZW50Lmh0bWwnLFxyXG4gIHN0eWxlVXJsczogWycuL3N0ZXAtY29tcG9uZW50LmNvbXBvbmVudC5jc3MnXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgU3RlcENvbXBvbmVudENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcblxyXG4gIEBPdXRwdXQoKSBjbGlja0NhbmNlbEJ0biA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG4gIEBPdXRwdXQoKSBjbGlja0ZpbmlzaEJ0biA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG5cclxuICBASW5wdXQoKSB0aXRsZSA9ICcnO1xyXG4gIEBJbnB1dCgpIHN0ZXBzID0gW107XHJcbiAgX2NvcHlTdGVwcyA9IFtdO1xyXG4gIGN1clN0ZXA7XHJcbiAgY3VyU3RlcEluZGV4ID0gMDtcclxuICBjdXJDb21wb25lbnRSZWY6IENvbXBvbmVudFJlZjxhbnk+O1xyXG4gIC8vIGZpbmlzaGVkU3RlcHMgPSBbXTtcclxuICBAVmlld0NoaWxkKCdzdGVwQ29udGFpbmVyJywgeyByZWFkOiBWaWV3Q29udGFpbmVyUmVmIH0pIHN0ZXBDb250YWluZXI6IFZpZXdDb250YWluZXJSZWY7XHJcblxyXG4gIGxhYmVsUHJlOiBhbnkgPSAn5LiK5LiA5q2lJztcclxuICBsYWJlbE5leHQ6IGFueSA9ICfkuIvkuIDmraUnO1xyXG4gIGxhYmVsRmluaXNoOiBhbnkgPSAn5a6M5oiQJztcclxuICBsYWJlbERlbGV0ZTogYW55ID0gJ+WIoOmZpCc7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgdmlld0NvbnRhaW5lclJlZjogVmlld0NvbnRhaW5lclJlZixcclxuICAgIHByaXZhdGUgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICBwcml2YXRlIGxvY2FsaXplU2VydmljZTogTG9jYWxpemVTZXJ2aWNlKSB7XHJcbiAgICAgIHRoaXMubGFiZWxQcmUgPSB0aGlzLmxvY2FsaXplU2VydmljZS5nZXRWYWx1ZSgnZm9ybXVsYXIuc3RlcC5sYWJlbFByZScpO1xyXG4gICAgICB0aGlzLmxhYmVsTmV4dCA9IHRoaXMubG9jYWxpemVTZXJ2aWNlLmdldFZhbHVlKCdmb3JtdWxhci5zdGVwLmxhYmVsTmV4dCcpO1xyXG4gICAgICB0aGlzLmxhYmVsRmluaXNoID0gdGhpcy5sb2NhbGl6ZVNlcnZpY2UuZ2V0VmFsdWUoJ2Zvcm11bGFyLnN0ZXAubGFiZWxGaW5pc2gnKTtcclxuICAgICAgdGhpcy5sYWJlbERlbGV0ZSA9IHRoaXMubG9jYWxpemVTZXJ2aWNlLmdldFZhbHVlKCdmb3JtdWxhci5zdGVwLmxhYmVsRGVsZXRlJyk7XHJcbiAgICAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIGlmICh0aGlzLnN0ZXBzICYmIHRoaXMuc3RlcHMubGVuZ3RoID4gMCkge1xyXG4gICAgICB0aGlzLmN1clN0ZXAgPSB0aGlzLnN0ZXBzW3RoaXMuY3VyU3RlcEluZGV4XTtcclxuICAgICAgdGhpcy5jcmVhdGVTdGVwQ29tcG9uZW50KHRoaXMuc3RlcHNbdGhpcy5jdXJTdGVwSW5kZXhdKTtcclxuICAgICAgLy8gdGhpcy5jcmVhdGVTdGVwQ29tcG9uZW50KHRoaXMuc3RlcHNbNF0pO1xyXG4gICAgfVxyXG4gICAgdGhpcy5fY29weVN0ZXBzID0gdGhpcy5zdGVwcztcclxuICB9XHJcbiAgY3JlYXRlU3RlcENvbXBvbmVudChzdGVwKSB7XHJcbiAgICB0aGlzLnN0ZXBDb250YWluZXIuY2xlYXIoKTtcclxuICAgIGNvbnN0IGNvbXBvbmVudEZhY3RvcnkgPSB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShzdGVwLmNvbXBvbmVudCk7XHJcbiAgICB0aGlzLmN1ckNvbXBvbmVudFJlZiA9IHRoaXMuc3RlcENvbnRhaW5lci5jcmVhdGVDb21wb25lbnQoY29tcG9uZW50RmFjdG9yeSk7XHJcbiAgICB0aGlzLmN1ckNvbXBvbmVudFJlZi5pbnN0YW5jZS5kYXRhID0gc3RlcC5kYXRhO1xyXG5cclxuICAgIC8vIOaWsOWinuatpemqpFxyXG4gICAgaWYgKHRoaXMuY3VyQ29tcG9uZW50UmVmLmluc3RhbmNlLmFkZFN0ZXApIHtcclxuICAgICAgdGhpcy5jdXJDb21wb25lbnRSZWYuaW5zdGFuY2UuYWRkU3RlcC5zdWJzY3JpYmUoKHN0ZXBMaXN0KSA9PiB7XHJcblxyXG4gICAgICAgIGNvbnN0IGN1ckluZGV4ID0gZmluZEluZGV4KHRoaXMuc3RlcHMsIHRoaXMuY3VyU3RlcCk7XHJcbiAgICAgICAgdGhpcy5zdGVwcy5zcGxpY2UoY3VySW5kZXggKyAxLCAwLCAuLi5zdGVwTGlzdCk7XHJcblxyXG4gICAgICAgIHRoaXMuY3VyU3RlcC5uZXh0U3RlcCA9IHN0ZXBMaXN0WzBdLnN0ZXBJZDtcclxuICAgICAgICB0aGlzLmN1clN0ZXAuc2hvd0ZpbmlzaEJ0biA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuY3VyU3RlcC5zaG93TmV4dFN0ZXBCdG4gPSB0cnVlO1xyXG5cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICAvLyDliKDpmaTmraXpqqRcclxuICAgIGlmICh0aGlzLmN1ckNvbXBvbmVudFJlZi5pbnN0YW5jZS5yZW1vdmVTdGVwKSB7XHJcbiAgICAgIHRoaXMuY3VyQ29tcG9uZW50UmVmLmluc3RhbmNlLnJlbW92ZVN0ZXAuc3Vic2NyaWJlKChkYXRhKSA9PiB7XHJcbiAgICAgICAgbWVyZ2UodGhpcy5jdXJTdGVwLCBkYXRhLmN1clN0ZXApO1xyXG4gICAgICAgIGRhdGEucmVtb3ZlU3RlcHMuZm9yRWFjaChyZW1vdmVTdGVwID0+IHtcclxuICAgICAgICAgIGNvbnN0IGluZGV4ID0gZmluZEluZGV4KHRoaXMuc3RlcHMsIHJlbW92ZVN0ZXApO1xyXG4gICAgICAgICAgaWYgKGluZGV4ID49IDApIHtcclxuICAgICAgICAgICAgdGhpcy5zdGVwcy5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIC8vIOWPmOabtOatpemqpFxyXG4gICAgaWYgKHRoaXMuY3VyQ29tcG9uZW50UmVmLmluc3RhbmNlLmNoYW5nZVN0ZXApIHtcclxuICAgICAgdGhpcy5jdXJDb21wb25lbnRSZWYuaW5zdGFuY2UuY2hhbmdlU3RlcC5zdWJzY3JpYmUoKHN0ZXBMaXN0KSA9PiB7XHJcbiAgICAgICAgc3RlcExpc3QuZm9yRWFjaChjaGFuZ2VTdGVwID0+IHtcclxuICAgICAgICAgIGNvbnN0IG9sZFN0ZXAgPSBmaW5kKHRoaXMuX2NvcHlTdGVwcywgZnVuY3Rpb24gKHMpIHsgcmV0dXJuIHMuc3RlcElkID09PSBjaGFuZ2VTdGVwLnN0ZXBJZDsgfSk7XHJcbiAgICAgICAgICBtZXJnZShvbGRTdGVwLCBjaGFuZ2VTdGVwKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnN0ZXBzID0gdGhpcy5fY29weVN0ZXBzLmZpbHRlcihzdGVwID0+IHN0ZXAuc2hvdyAhPT0gZmFsc2UpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgfVxyXG4gIGp1bXBTdGVwKG5leHRTdGVwKSB7XHJcbiAgICAvLyDliKTmlq3ot7PovazmlrnlkJFcclxuICAgIGlmIChuZXh0U3RlcCA9PT0gdGhpcy5jdXJTdGVwKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IG5leHRJbmRleCA9IGZpbmRJbmRleCh0aGlzLnN0ZXBzLCBmdW5jdGlvbiAocykgeyByZXR1cm4gcy5zdGVwSWQgPT09IG5leHRTdGVwLnN0ZXBJZDsgfSk7XHJcbiAgICBpZiAobmV4dEluZGV4ID09PSB0aGlzLmN1clN0ZXBJbmRleCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAobmV4dEluZGV4IDwgdGhpcy5jdXJTdGVwSW5kZXgpIHsgLy8g5ZCR5YmN6LezXHJcbiAgICAgIHRoaXMuY3VyU3RlcCA9IG5leHRTdGVwO1xyXG4gICAgICB0aGlzLmN1clN0ZXBJbmRleCA9IG5leHRJbmRleDtcclxuICAgICAgdGhpcy5jcmVhdGVTdGVwQ29tcG9uZW50KG5leHRTdGVwKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKG5leHRTdGVwLnN0ZXBJZCA9PT0gdGhpcy5jdXJTdGVwLm5leHRTdGVwKSB7IC8vIOS4i+S4gOatpVxyXG4gICAgICB0aGlzLm5leHRTdGVwKCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vICBlbHNlIGlmICh0aGlzLmZpbmlzaGVkU3RlcHMuaW5kZXhPZihuZXh0U3RlcC5zdGVwSWQpID4gLTEpIHsgLy8g5bey5a6M5oiQ55qE5ZCO57ut5q2l6aqkXHJcbiAgICAvLyAgIHRoaXMuY3VyU3RlcCA9IG5leHRTdGVwO1xyXG4gICAgLy8gICB0aGlzLmN1clN0ZXBJbmRleCA9IG5leHRJbmRleDtcclxuICAgIC8vICAgdGhpcy5jcmVhdGVTdGVwQ29tcG9uZW50KG5leHRTdGVwKTtcclxuICAgIC8vIH1cclxuXHJcbiAgfVxyXG4gIC8qKlxyXG4gICAgKiDngrnlh7vkuIrkuIDmraVcclxuICAgICovXHJcbiAgbGFzdFN0ZXAoKSB7XHJcbiAgICBjb25zdCBzZWxmID0gdGhpcztcclxuICAgIHRoaXMuY3VyU3RlcEluZGV4ID0gZmluZEluZGV4KHRoaXMuc3RlcHMsIGZ1bmN0aW9uIChzKSB7IHJldHVybiBzLm5leHRTdGVwID09PSBzZWxmLmN1clN0ZXAuc3RlcElkOyB9KTtcclxuICAgIHRoaXMuY3VyU3RlcCA9IHRoaXMuc3RlcHNbdGhpcy5jdXJTdGVwSW5kZXhdO1xyXG4gICAgLy8g5omn6KGM5ZCEQ29tcG9uZW505a6a5LmJ55qEbmV4dFN0ZXBDbGlja+S6i+S7tlxyXG4gICAgY29uc3QgY2xpY2tMYXN0U3RlcCA9IHRoaXMuY3VyQ29tcG9uZW50UmVmLmluc3RhbmNlLmNsaWNrTGFzdFN0ZXA7XHJcbiAgICBpZiAoY2xpY2tMYXN0U3RlcCAmJiB0eXBlb2YgKGNsaWNrTGFzdFN0ZXApID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGNsaWNrTGFzdFN0ZXAoKTsgLy8g6L+U5Zue5YC85o6l5pS2Ym9vbGVhbuaIlm9ic2VydmFibGXnsbvlnotcclxuICAgICAgaWYgKHR5cGVvZiAocmVzdWx0KSA9PT0gJ2Jvb2xlYW4nICYmIHJlc3VsdCkge1xyXG4gICAgICAgIHRoaXMuY3JlYXRlU3RlcENvbXBvbmVudCh0aGlzLmN1clN0ZXApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDngrnlh7vkuIvkuIDmraVcclxuICAgKi9cclxuICBuZXh0U3RlcCgpIHtcclxuICAgIC8vIOagoemqjFxyXG4gICAgY29uc3QgdmFsaWRhdGlvbkZ1bmMgPSB0aGlzLmN1ckNvbXBvbmVudFJlZi5pbnN0YW5jZS52YWxpZGF0aW9uO1xyXG4gICAgaWYgKHZhbGlkYXRpb25GdW5jICYmIHR5cGVvZiAodmFsaWRhdGlvbkZ1bmMpID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHZhbGlkYXRpb25GdW5jKCk7XHJcbiAgICAgIGlmICghcmVzdWx0KSB7IHJldHVybjsgfVxyXG4gICAgfVxyXG4gICAgLy8g5omn6KGM5ZCEQ29tcG9uZW505a6a5LmJ55qEbmV4dFN0ZXBDbGlja+S6i+S7tlxyXG4gICAgY29uc3QgY2xpY2tOZXh0U3RlcCA9IHRoaXMuY3VyQ29tcG9uZW50UmVmLmluc3RhbmNlLmNsaWNrTmV4dFN0ZXA7XHJcbiAgICBpZiAoY2xpY2tOZXh0U3RlcCAmJiB0eXBlb2YgKGNsaWNrTmV4dFN0ZXApID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGNsaWNrTmV4dFN0ZXAoKTsgLy8g6L+U5Zue5YC85o6l5pS2Ym9vbGVhbuaIlm9ic2VydmFibGXnsbvlnotcclxuICAgICAgaWYgKHR5cGVvZiAocmVzdWx0KSA9PT0gJ2Jvb2xlYW4nICYmIHJlc3VsdCkge1xyXG4gICAgICAgIHRoaXMubW92ZVRvTmV4dFN0ZXAocmVzdWx0KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICByZXN1bHQuc3Vic2NyaWJlKGRhdGEgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLm1vdmVUb05leHRTdGVwKGRhdGEpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLm1vdmVUb05leHRTdGVwKHRydWUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbW92ZVRvTmV4dFN0ZXAoZGF0YSkge1xyXG4gICAgaWYgKCFkYXRhKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGN1clN0ZXAgPSB0aGlzLmN1clN0ZXA7XHJcbiAgICBpZiAoY3VyU3RlcC5uZXh0U3RlcCA9PT0gJycpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgLy8gdGhpcy5maW5pc2hlZFN0ZXBzLnB1c2goY3VyU3RlcC5zdGVwSWQpO1xyXG4gICAgdGhpcy5jdXJTdGVwSW5kZXggPSBmaW5kSW5kZXgodGhpcy5zdGVwcywgZnVuY3Rpb24gKHMpIHsgcmV0dXJuIHMuc3RlcElkID09PSBjdXJTdGVwLm5leHRTdGVwOyB9KTtcclxuICAgIGlmICh0aGlzLmN1clN0ZXBJbmRleCA+IC0xKSB7XHJcbiAgICAgIHRoaXMuY3VyU3RlcCA9IHRoaXMuc3RlcHNbdGhpcy5jdXJTdGVwSW5kZXhdO1xyXG4gICAgICB0aGlzLmNyZWF0ZVN0ZXBDb21wb25lbnQodGhpcy5jdXJTdGVwKTtcclxuICAgIH1cclxuXHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWPlua2iFxyXG4gICAqL1xyXG4gIGNsaWNrQ2FuY2VsKCkge1xyXG4gICAgdGhpcy5jbGlja0NhbmNlbEJ0bi5lbWl0KCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWujOaIkFxyXG4gICAqL1xyXG4gIGZpbmlzaFdpemFyZCgpIHtcclxuICAgIGNvbnN0IHZhbGlkYXRpb25GdW5jID0gdGhpcy5jdXJDb21wb25lbnRSZWYuaW5zdGFuY2UudmFsaWRhdGlvbjtcclxuICAgIGlmICh2YWxpZGF0aW9uRnVuYyAmJiB0eXBlb2YgKHZhbGlkYXRpb25GdW5jKSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICBjb25zdCByZXN1bHQgPSB2YWxpZGF0aW9uRnVuYygpO1xyXG4gICAgICBpZiAoIXJlc3VsdCkgeyByZXR1cm47IH1cclxuICAgIH1cclxuXHJcbiAgICBsZXQgYmVmb3JlRmluaXNoID0gdGhpcy5jdXJDb21wb25lbnRSZWYuaW5zdGFuY2UuYmVmb3JlRmluaXNoO1xyXG4gICAgaWYgKHRoaXMuY3VyQ29tcG9uZW50UmVmLmluc3RhbmNlLnFkcFJlc3VsdCAmJiAhYmVmb3JlRmluaXNoKSB7XHJcbiAgICAgIGJlZm9yZUZpbmlzaCA9IHRoaXMuY3VyQ29tcG9uZW50UmVmLmluc3RhbmNlLnFkcFJlc3VsdC5iZWZvcmVGaW5pc2g7XHJcbiAgICB9XHJcbiAgICBpZiAoYmVmb3JlRmluaXNoICYmIHR5cGVvZiAoYmVmb3JlRmluaXNoKSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICBjb25zdCByZXN1bHQgPSBiZWZvcmVGaW5pc2goKTtcclxuICAgICAgaWYgKHR5cGVvZiAocmVzdWx0KSA9PT0gJ2Jvb2xlYW4nICYmIHJlc3VsdCkge1xyXG4gICAgICAgIHRoaXMuY2xpY2tGaW5pc2hCdG4uZW1pdCgpO1xyXG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiAocmVzdWx0KSAhPT0gJ2Jvb2xlYW4nKSB7XHJcbiAgICAgICAgaWYgKHJlc3VsdCkge1xyXG4gICAgICAgICAgcmVzdWx0LnN1YnNjcmliZShkYXRhID0+IHtcclxuICAgICAgICAgICAgaWYgKGRhdGEpIHtcclxuICAgICAgICAgICAgICB0aGlzLmNsaWNrRmluaXNoQnRuLmVtaXQoZGF0YSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICBcclxufVxyXG4iXX0=