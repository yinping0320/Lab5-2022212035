/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { EventBus } from "@qdp/common";
import { RtfServices } from "@qdp/common";
import { BaseRender } from "./base-render";
var CrosstabRender = /** @class */ (function (_super) {
    tslib_1.__extends(CrosstabRender, _super);
    function CrosstabRender(_queryId, _controlType, _jointsearchInfoList, _funcInfoCache, _serviceCache) {
        var _this = _super.call(this, _queryId, _controlType, _jointsearchInfoList, _funcInfoCache, _serviceCache) || this;
        _this.crosstabInit();
        return _this;
    }
    /**
     * @private
     * @return {?}
     */
    CrosstabRender.prototype.crosstabInit = /**
     * @private
     * @return {?}
     */
    function () {
    };
    /**
     * 渲染
     * @param obj 参数配置项
     */
    /**
     * 渲染
     * @param {?} obj 参数配置项
     * @return {?}
     */
    CrosstabRender.prototype.render = /**
     * 渲染
     * @param {?} obj 参数配置项
     * @return {?}
     */
    function (obj) {
        var _this = this;
        /** @type {?} */
        var self = this;
        this.queryId = obj.queryId;
        obj.schemaId = obj.schemaId === 'prefab' ? '1' : obj.schemaId;
        this.utils.get('schema').getSchemaInfo(obj).subscribe((/**
         * @param {?} schemaValue
         * @return {?}
         */
        function (schemaValue) {
            if (schemaValue) {
                obj['schemaId'] = schemaValue.id;
                obj['schemaValue'] = schemaValue;
                // this.currentSchemaValueChanger.next(schemaValue);
                EventBus.dispatch('schemaValueChanged', schemaValue);
                /** @type {?} */
                var delay = schemaValue.schemaValue.otherOption.delay;
                /** @type {?} */
                var interval_1 = schemaValue.schemaValue.otherOption.interval;
                /** @type {?} */
                var index = self.funcInfoCache.firstLoadCache.findIndex((/**
                 * @param {?} el
                 * @return {?}
                 */
                function (el) { return el === _this.tabId; }));
                /** @type {?} */
                var firstLoad = schemaValue.schemaValue.otherOption.firstLoad;
                if (index < 0 && _this.isSchemaSelectChanged === false) {
                    if (firstLoad === false) {
                        self.funcInfoCache.firstLoadCache.push(_this.tabId);
                        obj.loading.close();
                        if (obj.spread.getActiveSheet()) {
                            obj.spread.getActiveSheet().deleteRows(0, obj.spread.getActiveSheet().getRowCount());
                            obj.spread.getActiveSheet().options.colHeaderVisible = false;
                            obj.spread.invalidateLayout();
                            obj.spread.repaint();
                        }
                        return;
                    }
                }
                if (!delay) {
                    delay = 0;
                }
                setTimeout((/**
                 * @return {?}
                 */
                function () {
                    _this.getRenderDataForCrosstab.call(_this, Object.assign({}, obj));
                    if (interval_1 > 0) {
                        setInterval((/**
                         * @return {?}
                         */
                        function () {
                            _this.getRenderDataForCrosstab.call(_this, Object.assign({}, obj));
                        }), interval_1 * 1000);
                    }
                }), delay * 1000);
            }
            else {
                obj['schemaId'] = '1';
                _this.getRenderDataForCrosstab.call(_this, Object.assign({}, obj));
            }
        }));
    };
    /**
     * @private
     * @param {?} obj
     * @return {?}
     */
    CrosstabRender.prototype.getRenderDataForCrosstab = /**
     * @private
     * @param {?} obj
     * @return {?}
     */
    function (obj) {
        var _this = this;
        /** @type {?} */
        var self = this;
        obj.schemaId = obj.schemaId ? obj.schemaId : (obj.schemaValue && obj.schemaValue.id ? obj.schemaValue.id : '1');
        if (!obj.formData) {
            /** @type {?} */
            var params_1 = this.utils.get('parameter').createParameters(Object.assign({}, obj, { pageIndex: 0, pageSize: 0 }));
            params_1['queryId'] = obj.queryId ? obj.queryId : '';
            // 查询数据前事件
            params_1 = this.utils.get('renderExtends').runRenderExtends('beforeQueryData', this.localizeService.getValue('spread.message.extend.query.before'), params_1, obj.spread);
            try {
                this.cache.set(self.tabId, JSON.parse(params_1['entityData']));
                this.cache.set(self.tabId + 'extendCond', params_1['extendCond']);
            }
            catch (e) { }
            self.lcpService.getCol(params_1, obj.queryRelativeUrl).subscribe((/**
             * @param {?} resultData
             * @return {?}
             */
            function (resultData) {
                /** @type {?} */
                var dynamicColumns = (resultData && resultData.dynamicCols) || [];
                self.initJoinParams(obj, dynamicColumns);
                self.schemaManager.setColInfo(dynamicColumns);
                if (obj.schemaId === '1' || !obj.schemaId) {
                    obj.loading.close();
                    return self.errorHandle(obj.spread, _this.localizeService.getValue('spread.message.validate.schemaInfo'));
                }
                self.lcpService.getCrosstabTemplate(params_1, obj.queryRelativeUrl).subscribe((/**
                 * @param {?} template
                 * @return {?}
                 */
                function (template) {
                    if (!template || !template.sheets || !template.sheets.sheet1 || !template.sheets.sheet1.data || !template.sheets.sheet1.data.dataTable || !template.sheets.sheet1.data.dataTable['0']) {
                        obj.loading.close();
                        return self.errorHandle(obj.spread, _this.localizeService.getValue('spread.message.validate.nodata'));
                    }
                    self.renderCrossTable(Object.assign({}, obj, { template: template }));
                    /** @type {?} */
                    var event = RtfServices.getMenuSwitchControlEvent();
                    if (event && typeof event === 'object') {
                        event.next('ok');
                    }
                    obj.loading.close();
                    _this.utils.get('spreadStyle').bindSelectChanged(obj.spread, obj.queryId);
                }), (/**
                 * @param {?} error
                 * @return {?}
                 */
                function (error) {
                    self.formErrorService.exception(error.Message, error);
                    obj.loading.close();
                }));
            }), (/**
             * @param {?} error
             * @return {?}
             */
            function (error) {
                self.formErrorService.exception(error.Message, error);
                obj.loading.close();
            }));
            this.cache.set('schema_schemaid' + obj.queryId, obj.schemaId);
        }
    };
    /**
     * @private
     * @param {?} obj
     * @return {?}
     */
    CrosstabRender.prototype.renderCrossTable = /**
     * @private
     * @param {?} obj
     * @return {?}
     */
    function (obj) {
        obj.spread.suspendEvent();
        obj.spread.suspendPaint();
        if (obj.template) {
            obj.spread.fromJSON(obj.template);
            obj.spread.getActiveSheet().rowOutlines.direction(GC.Spread.Sheets.Outlines.OutlineDirection.backward);
            /** @type {?} */
            var row = obj.spread.getActiveSheet().getRowCount();
            for (var i = 0; i < row; i++) {
                /** @type {?} */
                var cellType = obj.spread.getActiveSheet().getCellType(i, 0);
                if (cellType && cellType.typeName === 'TreeCellType') {
                    /** @type {?} */
                    var level = cellType.level;
                    for (var r = 0; r <= level; r++) {
                        obj.spread.getActiveSheet().rowOutlines.group(i, 1);
                    }
                }
            }
        }
        /** @type {?} */
        var sheet = obj.spread.getActiveSheet();
        if (sheet) {
            this.titleVariablesReplace(sheet, obj.data);
            sheet.clearSelection();
        }
        // 页面渲染后事件
        this.utils.get('renderExtends').runRenderExtends('afterLoadData', this.localizeService.getValue('spread.message.extend.dataLoading.after'), obj.data, obj.spread);
        obj.spread.resumePaint();
        obj.spread.resumeEvent();
        // 增加当前单元格联查参数缓存
        this.utils.get('spreadStyle').joinParam['controlType'] = obj.controlType;
        this.cache.set(this.tabId + 'joinSearch', this.utils.get('spreadStyle').joinParam);
    };
    /**
     * @private
     * @param {?} obj
     * @param {?} dynamicColumns
     * @return {?}
     */
    CrosstabRender.prototype.initJoinParams = /**
     * @private
     * @param {?} obj
     * @param {?} dynamicColumns
     * @return {?}
     */
    function (obj, dynamicColumns) {
        var _this = this;
        this.utils.get('spreadStyle').joinParam = {
            controlType: obj.controlType,
            rowHeaderColInfo: { start: 0, end: 0 },
            // 行标题起始位置信息（行号）
            colHeaderRowInfo: { start: 0, end: 0 },
            // 列标题信息起始位置信息（列号)
            valueColCount: 0,
            // 行标题信息起始位置信息（列号)
            colInfos: dynamicColumns,
        };
        /** @type {?} */
        var columnHeaderRowCount = this.utils.get('spreadStyle').rowHeadersColumnCount = this.utils.get('spreadStyle').valueHeaderRowCount = 0;
        /** @type {?} */
        var titleCount = 0;
        if (obj.schemaId !== '1') {
            titleCount += obj.schemaValue.schemaValue.titleOption.title ? 1 : 0;
            titleCount += obj.schemaValue.schemaValue.titleOption.subTitles.length;
            obj.schemaValue.schemaValue.columnOption.colList.forEach((/**
             * @param {?} data
             * @return {?}
             */
            function (data) {
                if (data.dimension && data.dimension !== 0) {
                    if (data.dimension === 1) {
                        _this.utils.get('spreadStyle').rowHeadersColumnCount++;
                    }
                    else if (data.dimension === 2) {
                        columnHeaderRowCount++;
                    }
                    else if (data.dimension === 3) {
                        _this.utils.get('spreadStyle').valueHeaderRowCount++;
                    }
                }
            }));
            this.utils.get('spreadStyle').joinParam['controlType'] = obj.controlType;
            this.utils.get('spreadStyle').joinParam['rowHeaderColInfo'] = { start: 0, end: this.utils.get('spreadStyle').rowHeadersColumnCount }; // 行标题起始位置信息（行号）
            this.utils.get('spreadStyle').joinParam['colHeaderRowInfo'] = { start: titleCount, end: titleCount + columnHeaderRowCount }; // 列标题信息起始位置信息（列号)
            this.utils.get('spreadStyle').joinParam['valueColCount'] = this.utils.get('spreadStyle').valueHeaderRowCount; // 行标题信息起始位置信息（列号)
            this.utils.get('spreadStyle').joinParam['colInfos'] = obj.schemaValue.schemaValue.columnOption.colList; // 列信息
        }
        this.cache.set(this.tabId + 'joinSearch', this.utils.get('spreadStyle').joinParam);
    };
    return CrosstabRender;
}(BaseRender));
export { CrosstabRender };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvc3N0YWItcmVuZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHFkcC9zcHJlYWQvIiwic291cmNlcyI6WyJsaWIvZW5naW5lL2Nyb3NzdGFiLXJlbmRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUUxQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBSTNDO0lBQW9DLDBDQUFVO0lBRTFDLHdCQUFZLFFBQWEsRUFBRSxZQUFpQixFQUFFLG9CQUEwQixFQUFFLGNBQW9CLEVBQUUsYUFBbUI7UUFBbkgsWUFDSSxrQkFBTSxRQUFRLEVBQUUsWUFBWSxFQUFFLG9CQUFvQixFQUFFLGNBQWMsRUFBRSxhQUFhLENBQUMsU0FFckY7UUFERyxLQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7O0lBQ3hCLENBQUM7Ozs7O0lBRU8scUNBQVk7Ozs7SUFBcEI7SUFFQSxDQUFDO0lBRUQ7OztPQUdHOzs7Ozs7SUFDSCwrQkFBTTs7Ozs7SUFBTixVQUFPLEdBQWlCO1FBQXhCLGlCQTRDQzs7WUEzQ1MsSUFBSSxHQUFHLElBQUk7UUFDakIsSUFBSSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDO1FBQzNCLEdBQUcsQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDLFFBQVEsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQztRQUM5RCxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsU0FBUzs7OztRQUFDLFVBQUMsV0FBZ0I7WUFDbkUsSUFBSSxXQUFXLEVBQUU7Z0JBQ2IsR0FBRyxDQUFDLFVBQVUsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxFQUFF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Q0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLENBQUMsZ0JBQWdCO1lBQ3RKLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsVUFBVSxHQUFHLG9CQUFvQixFQUFFLENBQUMsQ0FBQyxrQkFBa0I7WUFDL0ksSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDLG1CQUFtQixDQUFDLENBQUMsa0JBQWtCO1lBQ2hJLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsR0FBRyxHQUFHLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTTtTQUNqSDtRQUNELElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsWUFBWSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3ZGLENBQUM7SUFDTCxxQkFBQztBQUFELENBQUMsQUEvS0QsQ0FBb0MsVUFBVSxHQStLN0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEJ1cyB9IGZyb20gXCJAcWRwL2NvbW1vblwiO1xyXG5pbXBvcnQgeyBSdGZTZXJ2aWNlcyB9IGZyb20gXCJAcWRwL2NvbW1vblwiO1xyXG5pbXBvcnQgeyBSZW5kZXJPcHRpb24gfSBmcm9tIFwiLi4vZW50aXR5L1JlbmRlck9wdGlvblwiO1xyXG5pbXBvcnQgeyBCYXNlUmVuZGVyIH0gZnJvbSBcIi4vYmFzZS1yZW5kZXJcIjtcclxuXHJcbmRlY2xhcmUgdmFyIEdDOiBhbnk7XHJcblxyXG5leHBvcnQgY2xhc3MgQ3Jvc3N0YWJSZW5kZXIgZXh0ZW5kcyBCYXNlUmVuZGVyIHtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihfcXVlcnlJZDogYW55LCBfY29udHJvbFR5cGU6IGFueSwgX2pvaW50c2VhcmNoSW5mb0xpc3Q/OiBhbnksIF9mdW5jSW5mb0NhY2hlPzogYW55LCBfc2VydmljZUNhY2hlPzogYW55KSB7XHJcbiAgICAgICAgc3VwZXIoX3F1ZXJ5SWQsIF9jb250cm9sVHlwZSwgX2pvaW50c2VhcmNoSW5mb0xpc3QsIF9mdW5jSW5mb0NhY2hlLCBfc2VydmljZUNhY2hlKTtcclxuICAgICAgICB0aGlzLmNyb3NzdGFiSW5pdCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY3Jvc3N0YWJJbml0KCkge1xyXG5cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOa4suafk1xyXG4gICAgICogQHBhcmFtIG9iaiDlj4LmlbDphY3nva7poblcclxuICAgICAqL1xyXG4gICAgcmVuZGVyKG9iajogUmVuZGVyT3B0aW9uKSB7XHJcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy5xdWVyeUlkID0gb2JqLnF1ZXJ5SWQ7XHJcbiAgICAgICAgb2JqLnNjaGVtYUlkID0gb2JqLnNjaGVtYUlkID09PSAncHJlZmFiJyA/ICcxJyA6IG9iai5zY2hlbWFJZDtcclxuICAgICAgICB0aGlzLnV0aWxzLmdldCgnc2NoZW1hJykuZ2V0U2NoZW1hSW5mbyhvYmopLnN1YnNjcmliZSgoc2NoZW1hVmFsdWU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoc2NoZW1hVmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIG9ialsnc2NoZW1hSWQnXSA9IHNjaGVtYVZhbHVlLmlkO1xyXG4gICAgICAgICAgICAgICAgb2JqWydzY2hlbWFWYWx1ZSddID0gc2NoZW1hVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAvLyB0aGlzLmN1cnJlbnRTY2hlbWFWYWx1ZUNoYW5nZXIubmV4dChzY2hlbWFWYWx1ZSk7XHJcbiAgICAgICAgICAgICAgICBFdmVudEJ1cy5kaXNwYXRjaCgnc2NoZW1hVmFsdWVDaGFuZ2VkJywgc2NoZW1hVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgbGV0IGRlbGF5ID0gc2NoZW1hVmFsdWUuc2NoZW1hVmFsdWUub3RoZXJPcHRpb24uZGVsYXk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpbnRlcnZhbCA9IHNjaGVtYVZhbHVlLnNjaGVtYVZhbHVlLm90aGVyT3B0aW9uLmludGVydmFsO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gc2VsZi5mdW5jSW5mb0NhY2hlLmZpcnN0TG9hZENhY2hlLmZpbmRJbmRleChlbCA9PiBlbCA9PT0gdGhpcy50YWJJZCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmaXJzdExvYWQgPSBzY2hlbWFWYWx1ZS5zY2hlbWFWYWx1ZS5vdGhlck9wdGlvbi5maXJzdExvYWQ7XHJcbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCAwICYmIHRoaXMuaXNTY2hlbWFTZWxlY3RDaGFuZ2VkID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmaXJzdExvYWQgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZnVuY0luZm9DYWNoZS5maXJzdExvYWRDYWNoZS5wdXNoKHRoaXMudGFiSWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvYmoubG9hZGluZy5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob2JqLnNwcmVhZC5nZXRBY3RpdmVTaGVldCgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouc3ByZWFkLmdldEFjdGl2ZVNoZWV0KCkuZGVsZXRlUm93cygwLCBvYmouc3ByZWFkLmdldEFjdGl2ZVNoZWV0KCkuZ2V0Um93Q291bnQoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouc3ByZWFkLmdldEFjdGl2ZVNoZWV0KCkub3B0aW9ucy5jb2xIZWFkZXJWaXNpYmxlID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouc3ByZWFkLmludmFsaWRhdGVMYXlvdXQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcHJlYWQucmVwYWludCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoIWRlbGF5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVsYXkgPSAwO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRSZW5kZXJEYXRhRm9yQ3Jvc3N0YWIuY2FsbCh0aGlzLCBPYmplY3QuYXNzaWduKHt9LCBvYmopKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaW50ZXJ2YWwgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldEludGVydmFsKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0UmVuZGVyRGF0YUZvckNyb3NzdGFiLmNhbGwodGhpcywgT2JqZWN0LmFzc2lnbih7fSwgb2JqKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sIGludGVydmFsICogMTAwMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSwgZGVsYXkgKiAxMDAwKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG9ialsnc2NoZW1hSWQnXSA9ICcxJztcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0UmVuZGVyRGF0YUZvckNyb3NzdGFiLmNhbGwodGhpcywgT2JqZWN0LmFzc2lnbih7fSwgb2JqKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFJlbmRlckRhdGFGb3JDcm9zc3RhYihvYmo6IFJlbmRlck9wdGlvbikge1xyXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgICAgIG9iai5zY2hlbWFJZCA9IG9iai5zY2hlbWFJZCA/IG9iai5zY2hlbWFJZCA6IChvYmouc2NoZW1hVmFsdWUgJiYgb2JqLnNjaGVtYVZhbHVlLmlkID8gb2JqLnNjaGVtYVZhbHVlLmlkIDogJzEnKTtcclxuICAgICAgICBpZiAoIW9iai5mb3JtRGF0YSkge1xyXG4gICAgICAgICAgICBsZXQgcGFyYW1zID0gdGhpcy51dGlscy5nZXQoJ3BhcmFtZXRlcicpLmNyZWF0ZVBhcmFtZXRlcnMoT2JqZWN0LmFzc2lnbih7fSwgb2JqLCB7IHBhZ2VJbmRleDogMCwgcGFnZVNpemU6IDAgfSkpO1xyXG4gICAgICAgICAgICBwYXJhbXNbJ3F1ZXJ5SWQnXSA9IG9iai5xdWVyeUlkID8gb2JqLnF1ZXJ5SWQgOiAnJztcclxuICAgICAgICAgICAgLy8g5p+l6K+i5pWw5o2u5YmN5LqL5Lu2XHJcbiAgICAgICAgICAgIHBhcmFtcyA9IHRoaXMudXRpbHMuZ2V0KCdyZW5kZXJFeHRlbmRzJykucnVuUmVuZGVyRXh0ZW5kcygnYmVmb3JlUXVlcnlEYXRhJywgdGhpcy5sb2NhbGl6ZVNlcnZpY2UuZ2V0VmFsdWUoJ3NwcmVhZC5tZXNzYWdlLmV4dGVuZC5xdWVyeS5iZWZvcmUnKSwgcGFyYW1zLCBvYmouc3ByZWFkKTtcclxuXHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNhY2hlLnNldChzZWxmLnRhYklkLCBKU09OLnBhcnNlKHBhcmFtc1snZW50aXR5RGF0YSddKSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNhY2hlLnNldChzZWxmLnRhYklkICsgJ2V4dGVuZENvbmQnLCBwYXJhbXNbJ2V4dGVuZENvbmQnXSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgfVxyXG5cclxuICAgICAgICAgICAgc2VsZi5sY3BTZXJ2aWNlLmdldENvbChwYXJhbXMsIG9iai5xdWVyeVJlbGF0aXZlVXJsKS5zdWJzY3JpYmUocmVzdWx0RGF0YSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkeW5hbWljQ29sdW1ucyA9IChyZXN1bHREYXRhICYmIHJlc3VsdERhdGEuZHluYW1pY0NvbHMpIHx8IFtdO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5pbml0Sm9pblBhcmFtcyhvYmosIGR5bmFtaWNDb2x1bW5zKTtcclxuICAgICAgICAgICAgICAgIHNlbGYuc2NoZW1hTWFuYWdlci5zZXRDb2xJbmZvKGR5bmFtaWNDb2x1bW5zKTtcclxuICAgICAgICAgICAgICAgIGlmIChvYmouc2NoZW1hSWQgPT09ICcxJyB8fCAhb2JqLnNjaGVtYUlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb2JqLmxvYWRpbmcuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5lcnJvckhhbmRsZShvYmouc3ByZWFkLCB0aGlzLmxvY2FsaXplU2VydmljZS5nZXRWYWx1ZSgnc3ByZWFkLm1lc3NhZ2UudmFsaWRhdGUuc2NoZW1hSW5mbycpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHNlbGYubGNwU2VydmljZS5nZXRDcm9zc3RhYlRlbXBsYXRlKHBhcmFtcywgb2JqLnF1ZXJ5UmVsYXRpdmVVcmwpLnN1YnNjcmliZSgodGVtcGxhdGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGVtcGxhdGUgfHwgIXRlbXBsYXRlLnNoZWV0cyB8fCAhdGVtcGxhdGUuc2hlZXRzLnNoZWV0MSB8fCAhdGVtcGxhdGUuc2hlZXRzLnNoZWV0MS5kYXRhIHx8ICF0ZW1wbGF0ZS5zaGVldHMuc2hlZXQxLmRhdGEuZGF0YVRhYmxlIHx8ICF0ZW1wbGF0ZS5zaGVldHMuc2hlZXQxLmRhdGEuZGF0YVRhYmxlWycwJ10pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb2JqLmxvYWRpbmcuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuZXJyb3JIYW5kbGUob2JqLnNwcmVhZCwgdGhpcy5sb2NhbGl6ZVNlcnZpY2UuZ2V0VmFsdWUoJ3NwcmVhZC5tZXNzYWdlLnZhbGlkYXRlLm5vZGF0YScpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZW5kZXJDcm9zc1RhYmxlKE9iamVjdC5hc3NpZ24oe30sIG9iaiwgeyB0ZW1wbGF0ZSB9KSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGV2ZW50ID0gUnRmU2VydmljZXMuZ2V0TWVudVN3aXRjaENvbnRyb2xFdmVudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChldmVudCAmJiB0eXBlb2YgZXZlbnQgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50Lm5leHQoJ29rJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBvYmoubG9hZGluZy5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLmJpbmRTZWxlY3RDaGFuZ2VkKG9iai5zcHJlYWQsIG9iai5xdWVyeUlkKTtcclxuICAgICAgICAgICAgICAgIH0sIChlcnJvcjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5mb3JtRXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbihlcnJvci5NZXNzYWdlLCBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgb2JqLmxvYWRpbmcuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9LCAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5mb3JtRXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbihlcnJvci5NZXNzYWdlLCBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICBvYmoubG9hZGluZy5jbG9zZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuY2FjaGUuc2V0KCdzY2hlbWFfc2NoZW1haWQnICsgb2JqLnF1ZXJ5SWQsIG9iai5zY2hlbWFJZCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVuZGVyQ3Jvc3NUYWJsZShvYmo6IFJlbmRlck9wdGlvbikge1xyXG4gICAgICAgIG9iai5zcHJlYWQuc3VzcGVuZEV2ZW50KCk7XHJcbiAgICAgICAgb2JqLnNwcmVhZC5zdXNwZW5kUGFpbnQoKTtcclxuICAgICAgICBpZiAob2JqLnRlbXBsYXRlKSB7XHJcbiAgICAgICAgICAgIG9iai5zcHJlYWQuZnJvbUpTT04ob2JqLnRlbXBsYXRlKTtcclxuICAgICAgICAgICAgb2JqLnNwcmVhZC5nZXRBY3RpdmVTaGVldCgpLnJvd091dGxpbmVzLmRpcmVjdGlvbihHQy5TcHJlYWQuU2hlZXRzLk91dGxpbmVzLk91dGxpbmVEaXJlY3Rpb24uYmFja3dhcmQpO1xyXG4gICAgICAgICAgICBjb25zdCByb3cgPSBvYmouc3ByZWFkLmdldEFjdGl2ZVNoZWV0KCkuZ2V0Um93Q291bnQoKTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByb3c7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY2VsbFR5cGUgPSBvYmouc3ByZWFkLmdldEFjdGl2ZVNoZWV0KCkuZ2V0Q2VsbFR5cGUoaSwgMCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2VsbFR5cGUgJiYgY2VsbFR5cGUudHlwZU5hbWUgPT09ICdUcmVlQ2VsbFR5cGUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGV2ZWwgPSBjZWxsVHlwZS5sZXZlbDtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCByID0gMDsgciA8PSBsZXZlbDsgcisrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcHJlYWQuZ2V0QWN0aXZlU2hlZXQoKS5yb3dPdXRsaW5lcy5ncm91cChpLCAxKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3Qgc2hlZXQgPSBvYmouc3ByZWFkLmdldEFjdGl2ZVNoZWV0KCk7XHJcbiAgICAgICAgaWYgKHNoZWV0KSB7XHJcbiAgICAgICAgICAgIHRoaXMudGl0bGVWYXJpYWJsZXNSZXBsYWNlKHNoZWV0LCBvYmouZGF0YSk7XHJcbiAgICAgICAgICAgIHNoZWV0LmNsZWFyU2VsZWN0aW9uKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyDpobXpnaLmuLLmn5PlkI7kuovku7ZcclxuICAgICAgICB0aGlzLnV0aWxzLmdldCgncmVuZGVyRXh0ZW5kcycpLnJ1blJlbmRlckV4dGVuZHMoJ2FmdGVyTG9hZERhdGEnLCB0aGlzLmxvY2FsaXplU2VydmljZS5nZXRWYWx1ZSgnc3ByZWFkLm1lc3NhZ2UuZXh0ZW5kLmRhdGFMb2FkaW5nLmFmdGVyJyksIG9iai5kYXRhLCBvYmouc3ByZWFkKTtcclxuXHJcbiAgICAgICAgb2JqLnNwcmVhZC5yZXN1bWVQYWludCgpO1xyXG4gICAgICAgIG9iai5zcHJlYWQucmVzdW1lRXZlbnQoKTtcclxuICAgICAgICAvLyDlop7liqDlvZPliY3ljZXlhYPmoLzogZTmn6Xlj4LmlbDnvJPlrZhcclxuICAgICAgICB0aGlzLnV0aWxzLmdldCgnc3ByZWFkU3R5bGUnKS5qb2luUGFyYW1bJ2NvbnRyb2xUeXBlJ10gPSBvYmouY29udHJvbFR5cGU7XHJcbiAgICAgICAgdGhpcy5jYWNoZS5zZXQodGhpcy50YWJJZCArICdqb2luU2VhcmNoJywgdGhpcy51dGlscy5nZXQoJ3NwcmVhZFN0eWxlJykuam9pblBhcmFtKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGluaXRKb2luUGFyYW1zKG9iajogUmVuZGVyT3B0aW9uLCBkeW5hbWljQ29sdW1uczogYW55KSB7XHJcbiAgICAgICAgdGhpcy51dGlscy5nZXQoJ3NwcmVhZFN0eWxlJykuam9pblBhcmFtID0ge1xyXG4gICAgICAgICAgICBjb250cm9sVHlwZTogb2JqLmNvbnRyb2xUeXBlLFxyXG4gICAgICAgICAgICByb3dIZWFkZXJDb2xJbmZvOiB7IHN0YXJ0OiAwLCBlbmQ6IDAgfSwgLy8g6KGM5qCH6aKY6LW35aeL5L2N572u5L+h5oGv77yI6KGM5Y+377yJXHJcbiAgICAgICAgICAgIGNvbEhlYWRlclJvd0luZm86IHsgc3RhcnQ6IDAsIGVuZDogMCB9LCAvLyDliJfmoIfpopjkv6Hmga/otbflp4vkvY3nva7kv6Hmga/vvIjliJflj7cpXHJcbiAgICAgICAgICAgIHZhbHVlQ29sQ291bnQ6IDAsIC8vIOihjOagh+mimOS/oeaBr+i1t+Wni+S9jee9ruS/oeaBr++8iOWIl+WPtylcclxuICAgICAgICAgICAgY29sSW5mb3M6IGR5bmFtaWNDb2x1bW5zLCAvLyDliJfkv6Hmga9cclxuICAgICAgICB9O1xyXG4gICAgICAgIGxldCBjb2x1bW5IZWFkZXJSb3dDb3VudCA9IHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLnJvd0hlYWRlcnNDb2x1bW5Db3VudCA9IHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLnZhbHVlSGVhZGVyUm93Q291bnQgPSAwO1xyXG4gICAgICAgIGxldCB0aXRsZUNvdW50ID0gMDtcclxuICAgICAgICBpZiAob2JqLnNjaGVtYUlkICE9PSAnMScpIHtcclxuICAgICAgICAgICAgdGl0bGVDb3VudCArPSBvYmouc2NoZW1hVmFsdWUuc2NoZW1hVmFsdWUudGl0bGVPcHRpb24udGl0bGUgPyAxIDogMDtcclxuICAgICAgICAgICAgdGl0bGVDb3VudCArPSBvYmouc2NoZW1hVmFsdWUuc2NoZW1hVmFsdWUudGl0bGVPcHRpb24uc3ViVGl0bGVzLmxlbmd0aDtcclxuICAgICAgICAgICAgb2JqLnNjaGVtYVZhbHVlLnNjaGVtYVZhbHVlLmNvbHVtbk9wdGlvbi5jb2xMaXN0LmZvckVhY2goKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEuZGltZW5zaW9uICYmIGRhdGEuZGltZW5zaW9uICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuZGltZW5zaW9uID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLnJvd0hlYWRlcnNDb2x1bW5Db3VudCsrO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YS5kaW1lbnNpb24gPT09IDIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uSGVhZGVyUm93Q291bnQrKztcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEuZGltZW5zaW9uID09PSAzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLnZhbHVlSGVhZGVyUm93Q291bnQrKztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLnV0aWxzLmdldCgnc3ByZWFkU3R5bGUnKS5qb2luUGFyYW1bJ2NvbnRyb2xUeXBlJ10gPSBvYmouY29udHJvbFR5cGU7XHJcbiAgICAgICAgICAgIHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLmpvaW5QYXJhbVsncm93SGVhZGVyQ29sSW5mbyddID0geyBzdGFydDogMCwgZW5kOiB0aGlzLnV0aWxzLmdldCgnc3ByZWFkU3R5bGUnKS5yb3dIZWFkZXJzQ29sdW1uQ291bnQgfTsgLy8g6KGM5qCH6aKY6LW35aeL5L2N572u5L+h5oGv77yI6KGM5Y+377yJXHJcbiAgICAgICAgICAgIHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLmpvaW5QYXJhbVsnY29sSGVhZGVyUm93SW5mbyddID0geyBzdGFydDogdGl0bGVDb3VudCwgZW5kOiB0aXRsZUNvdW50ICsgY29sdW1uSGVhZGVyUm93Q291bnQgfTsgLy8g5YiX5qCH6aKY5L+h5oGv6LW35aeL5L2N572u5L+h5oGv77yI5YiX5Y+3KVxyXG4gICAgICAgICAgICB0aGlzLnV0aWxzLmdldCgnc3ByZWFkU3R5bGUnKS5qb2luUGFyYW1bJ3ZhbHVlQ29sQ291bnQnXSA9IHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLnZhbHVlSGVhZGVyUm93Q291bnQ7IC8vIOihjOagh+mimOS/oeaBr+i1t+Wni+S9jee9ruS/oeaBr++8iOWIl+WPtylcclxuICAgICAgICAgICAgdGhpcy51dGlscy5nZXQoJ3NwcmVhZFN0eWxlJykuam9pblBhcmFtWydjb2xJbmZvcyddID0gb2JqLnNjaGVtYVZhbHVlLnNjaGVtYVZhbHVlLmNvbHVtbk9wdGlvbi5jb2xMaXN0OyAvLyDliJfkv6Hmga9cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jYWNoZS5zZXQodGhpcy50YWJJZCArICdqb2luU2VhcmNoJywgdGhpcy51dGlscy5nZXQoJ3NwcmVhZFN0eWxlJykuam9pblBhcmFtKTtcclxuICAgIH1cclxufSJdfQ==