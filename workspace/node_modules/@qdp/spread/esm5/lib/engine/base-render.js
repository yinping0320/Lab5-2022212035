/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ParameterUtils } from "../util/parameter.utils";
import { RenderExtendsUtils } from "../util/render.extends.utils";
import { SchemaUtils } from "../util/schema.utils";
import { ServicesUtils } from "../util/services.utils";
import { SpreadStyleUtils } from "../util/spread.style.utils";
import { RtfServices } from '@qdp/common';
var BaseRender = /** @class */ (function () {
    function BaseRender(_queryId, _controlType, _jointsearchInfoList, _funcInfoCache, _serviceCache) {
        this.utils = new Map();
        this.autoFitColumnIndex = 0;
        this.isSchemaSelectChanged = false;
        this.tabId = RtfServices.getTabId(_queryId);
        this.queryId = _queryId;
        this.type = _controlType;
        this.funcInfoCache = _funcInfoCache;
        this.serviceCache = _serviceCache;
        this.baseRenderInit(_queryId, _controlType, _jointsearchInfoList, _funcInfoCache);
    }
    /**
     * @private
     * @param {?} _queryId
     * @param {?} _controlType
     * @param {?=} _jointsearchInfoList
     * @param {?=} _funcInfoCache
     * @return {?}
     */
    BaseRender.prototype.baseRenderInit = /**
     * @private
     * @param {?} _queryId
     * @param {?} _controlType
     * @param {?=} _jointsearchInfoList
     * @param {?=} _funcInfoCache
     * @return {?}
     */
    function (_queryId, _controlType, _jointsearchInfoList, _funcInfoCache) {
        /** @type {?} */
        var parameterUtils = new ParameterUtils(_queryId, _funcInfoCache, this.serviceCache);
        /** @type {?} */
        var schemaUtils = new SchemaUtils(this.serviceCache);
        /** @type {?} */
        var spreadStyleUtils = new SpreadStyleUtils(_queryId, _controlType, _jointsearchInfoList, this.serviceCache);
        /** @type {?} */
        var renderExtendsUtils = new RenderExtendsUtils(_queryId);
        this.msgService = this.serviceCache.msgService;
        this.cache = this.serviceCache.cacheService;
        this.lcpService = this.serviceCache.lcpService;
        this.loadService = this.serviceCache.loadService;
        this.localizeService = this.serviceCache.localizeService;
        this.schemaManager = this.serviceCache.schemaManagerService;
        this.formErrorService = this.serviceCache.formErrorService;
        this.queryId = _queryId;
        this.utils.set('parameter', parameterUtils);
        this.utils.set('schema', schemaUtils);
        this.utils.set('spreadStyle', spreadStyleUtils);
        this.utils.set('renderExtends', renderExtendsUtils);
        this.utils.set('queryId', _queryId);
    };
    /**
     * @param {?} params
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    BaseRender.prototype.getData = /**
     * @param {?} params
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    function (params, queryRelativeUrl) {
        this.cache.set(this.queryId + 'param', params);
        return this.lcpService.getData(params, queryRelativeUrl);
    };
    /**
     * @param {?} data
     * @param {?} value
     * @return {?}
     */
    BaseRender.prototype.changeData = /**
     * @param {?} data
     * @param {?} value
     * @return {?}
     */
    function (data, value) {
        if (data && data.data && data.dynamicCols && value) {
            if (value.schemaValue.columnOption && value.schemaValue.columnOption.colList && value.schemaValue.columnOption.colList.length) {
                /** @type {?} */
                var columns_1 = value.schemaValue.columnOption.colList.filter((/**
                 * @param {?} x
                 * @return {?}
                 */
                function (x) { return x.type === 'enum'; }));
                if (columns_1 && columns_1.length > 0) {
                    data.data.forEach((/**
                     * @param {?} x
                     * @return {?}
                     */
                    function (x) {
                        columns_1.forEach((/**
                         * @param {?} y
                         * @return {?}
                         */
                        function (y) {
                            /** @type {?} */
                            var orginValue = x[y.bindField];
                            /** @type {?} */
                            var showValue = orginValue;
                            if (data.resultEnumItems) {
                                /** @type {?} */
                                var resultEnumItem = data.resultEnumItems.find((/**
                                 * @param {?} resultEnumItem
                                 * @return {?}
                                 */
                                function (resultEnumItem) { return resultEnumItem.enumName === y.bindField; }));
                                if (resultEnumItem) {
                                    /** @type {?} */
                                    var findShowValue = resultEnumItem.resultEnumInfoList.find((/**
                                     * @param {?} resultEnum
                                     * @return {?}
                                     */
                                    function (resultEnum) { return resultEnum.key === orginValue; }));
                                    if (findShowValue) {
                                        showValue = y.showType === '0' ? findShowValue.key : y.showType === '1' ? findShowValue.code : findShowValue.name;
                                    }
                                }
                            }
                            x[y.bindField] = showValue;
                        }));
                    }));
                }
            }
        }
    };
    /**
     * 二开人员自定义格式方案处理
     */
    /**
     * 二开人员自定义格式方案处理
     * @param {?} data
     * @param {?} obj
     * @return {?}
     */
    BaseRender.prototype.operateCustomFormatSchema = /**
     * 二开人员自定义格式方案处理
     * @param {?} data
     * @param {?} obj
     * @return {?}
     */
    function (data, obj) {
        if (data.customFormatScheme) {
            obj.customFormatScheme = data.customFormatScheme;
            this.schemaManager.customSchema[obj.groupType ? obj.groupType : obj.queryId] = data.customFormatScheme;
            /** @type {?} */
            var customSchema = null;
            if (obj.schemaId === '1') {
                customSchema = this.schemaManager.mergeCustomSchema(obj.groupType ? obj.groupType : obj.queryId, obj.queryId);
            }
            if (customSchema && customSchema.schemaValue) {
                ServicesUtils.setServices(RtfServices.getTabId(obj.queryId) + 'customScheme', JSON.stringify(customSchema.schemaValue));
            }
        }
    };
    /**
     * 处理分页信息
     */
    /**
     * 处理分页信息
     * @param {?} obj
     * @param {?} params
     * @return {?}
     */
    BaseRender.prototype.operatePagination = /**
     * 处理分页信息
     * @param {?} obj
     * @param {?} params
     * @return {?}
     */
    function (obj, params) {
        /** @type {?} */
        var self = this;
        if (obj.controlType === 'list') {
            /** @type {?} */
            var pageSize = 0;
            if (obj.schemaId !== '1' && self.schemaManager.schemaList && self.schemaManager.schemaList[obj.schemaId]) {
                if (typeof self.schemaManager.schemaList[obj.schemaId].schemaValue === "string") {
                    self.schemaManager.schemaList[obj.schemaId].schemaValue = JSON.parse(self.schemaManager.schemaList[obj.schemaId].schemaValue);
                }
                if (self.schemaManager.schemaList[obj.schemaId].schemaValue.otherOption.loadDataType !== 0) {
                    pageSize = self.schemaManager.schemaList[obj.schemaId].schemaValue.otherOption.pageSize;
                }
            }
            else {
                if (obj.schemaId === '1' && self.schemaManager.preSchema && self.schemaManager.preSchema.schemaValue.otherOption.loadDataType !== 0) {
                    pageSize = self.schemaManager.preSchema.schemaValue.otherOption.pageSize;
                }
            }
            if (pageSize !== 0) {
                params['pageSize'] = pageSize;
                params['pageIndex'] = !obj.pageIndex ? 1 : obj.pageIndex;
            }
        }
    };
    /**
     * @param {?} sheet
     * @param {?} data
     * @return {?}
     */
    BaseRender.prototype.titleVariablesReplace = /**
     * @param {?} sheet
     * @param {?} data
     * @return {?}
     */
    function (sheet, data) {
        /** @type {?} */
        var colCount = sheet.getColumnCount(GC.Spread.Sheets.SheetArea.colHeader);
        /** @type {?} */
        var rowCount = sheet.getRowCount(GC.Spread.Sheets.SheetArea.colHeader);
        if (data && data.variables) {
            for (var r = 0; r < rowCount; r++) {
                for (var c = 0; c < colCount; c++) {
                    sheet.setValue(r, c, this.variablesReplace(sheet.getValue(r, c, GC.Spread.Sheets.SheetArea.colHeader), data), GC.Spread.Sheets.SheetArea.colHeader);
                }
            }
        }
    };
    /**
     * @param {?} sheet
     * @param {?} data
     * @return {?}
     */
    BaseRender.prototype.footerVariablesReplace = /**
     * @param {?} sheet
     * @param {?} data
     * @return {?}
     */
    function (sheet, data) {
        /** @type {?} */
        var rowCount = sheet.getRowCount();
        /** @type {?} */
        var colCount = sheet.getColumnCount();
        if (this.utils.get('spreadStyle').footerDataArray && this.utils.get('spreadStyle').footerDataArray.length) {
            for (var r = 0; r < this.utils.get('spreadStyle').footerDataArray.length; r++) {
                for (var c = 0; c < colCount; c++) {
                    sheet.setValue(r + (rowCount - this.utils.get('spreadStyle').footerDataArray.length), c, this.variablesReplace(this.utils.get('spreadStyle').footerDataArray[r][c], data));
                }
            }
        }
    };
    /**
     * @private
     * @param {?} cellValue
     * @param {?} data
     * @return {?}
     */
    BaseRender.prototype.variablesReplace = /**
     * @private
     * @param {?} cellValue
     * @param {?} data
     * @return {?}
     */
    function (cellValue, data) {
        if (data && data.variables) {
            Object.keys(data.variables).forEach((/**
             * @param {?} key
             * @return {?}
             */
            function (key) {
                /** @type {?} */
                var reg = new RegExp(key, 'g');
                if (cellValue) {
                    cellValue = cellValue.replace(reg, data.variables[key]);
                }
            }));
        }
        return cellValue;
    };
    /**
     * @param {?} spread
     * @param {?} errmsg
     * @return {?}
     */
    BaseRender.prototype.errorHandle = /**
     * @param {?} spread
     * @param {?} errmsg
     * @return {?}
     */
    function (spread, errmsg) {
        if (spread.getActiveSheet()) {
            spread.removeSheet(0);
        }
        spread.options.tabStripVisible = false;
        this.msgService.warning(errmsg);
        return;
    };
    return BaseRender;
}());
export { BaseRender };
if (false) {
    /** @type {?} */
    BaseRender.prototype.queryId;
    /** @type {?} */
    BaseRender.prototype.type;
    /** @type {?} */
    BaseRender.prototype.utils;
    /** @type {?} */
    BaseRender.prototype.autoFitColumnIndex;
    /** @type {?} */
    BaseRender.prototype.cache;
    /** @type {?} */
    BaseRender.prototype.msgService;
    /** @type {?} */
    BaseRender.prototype.lcpService;
    /** @type {?} */
    BaseRender.prototype.localizeService;
    /** @type {?} */
    BaseRender.prototype.schemaManager;
    /** @type {?} */
    BaseRender.prototype.formErrorService;
    /** @type {?} */
    BaseRender.prototype.loadService;
    /** @type {?} */
    BaseRender.prototype.funcInfoCache;
    /** @type {?} */
    BaseRender.prototype.serviceCache;
    /** @type {?} */
    BaseRender.prototype.isSchemaSelectChanged;
    /** @type {?} */
    BaseRender.prototype.tabId;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1yZW5kZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcWRwL3NwcmVhZC8iLCJzb3VyY2VzIjpbImxpYi9lbmdpbmUvYmFzZS1yZW5kZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUVBLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzlELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFJMUM7SUFpQkksb0JBQVksUUFBYSxFQUFFLFlBQWlCLEVBQUUsb0JBQTBCLEVBQUUsY0FBb0IsRUFBRSxhQUFtQjtRQWRuSCxVQUFLLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNsQix1QkFBa0IsR0FBRyxDQUFDLENBQUM7UUFVdkIsMEJBQXFCLEdBQUcsS0FBSyxDQUFDO1FBSTFCLElBQUksQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM1QyxJQUFJLENBQUMsT0FBTyxHQUFHLFFBQVEsQ0FBQztRQUN4QixJQUFJLENBQUMsSUFBSSxHQUFHLFlBQVksQ0FBQztRQUN6QixJQUFJLENBQUMsYUFBYSxHQUFHLGNBQWMsQ0FBQztRQUNwQyxJQUFJLENBQUMsWUFBWSxHQUFHLGFBQWEsQ0FBQztRQUNsQyxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxZQUFZLEVBQUUsb0JBQW9CLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFDdEYsQ0FBQzs7Ozs7Ozs7O0lBRU8sbUNBQWM7Ozs7Ozs7O0lBQXRCLFVBQXVCLFFBQWEsRUFBRSxZQUFpQixF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QUFPLENBQUMsZUFBZSxHQUFHLEtBQUssQ0FBQztRQUN2QyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNoQyxPQUFPO0lBQ1gsQ0FBQztJQUNMLGlCQUFDO0FBQUQsQ0FBQyxBQXZLRCxJQXVLQzs7OztJQXRLRyw2QkFBYTs7SUFDYiwwQkFBVTs7SUFDViwyQkFBa0I7O0lBQ2xCLHdDQUF1Qjs7SUFDdkIsMkJBQVc7O0lBQ1gsZ0NBQWdCOztJQUNoQixnQ0FBZ0I7O0lBQ2hCLHFDQUFxQjs7SUFDckIsbUNBQW1COztJQUNuQixzQ0FBc0I7O0lBQ3RCLGlDQUFpQjs7SUFDakIsbUNBQW1COztJQUNuQixrQ0FBa0I7O0lBQ2xCLDJDQUE4Qjs7SUFDOUIsMkJBQVciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSBcInJ4anNcIjtcclxuaW1wb3J0IHsgUmVuZGVyT3B0aW9uIH0gZnJvbSBcIi4uL2VudGl0eS9SZW5kZXJPcHRpb25cIjtcclxuaW1wb3J0IHsgUGFyYW1ldGVyVXRpbHMgfSBmcm9tIFwiLi4vdXRpbC9wYXJhbWV0ZXIudXRpbHNcIjtcclxuaW1wb3J0IHsgUmVuZGVyRXh0ZW5kc1V0aWxzIH0gZnJvbSBcIi4uL3V0aWwvcmVuZGVyLmV4dGVuZHMudXRpbHNcIjtcclxuaW1wb3J0IHsgU2NoZW1hVXRpbHMgfSBmcm9tIFwiLi4vdXRpbC9zY2hlbWEudXRpbHNcIjtcclxuaW1wb3J0IHsgU2VydmljZXNVdGlscyB9IGZyb20gXCIuLi91dGlsL3NlcnZpY2VzLnV0aWxzXCI7XHJcbmltcG9ydCB7IFNwcmVhZFN0eWxlVXRpbHMgfSBmcm9tIFwiLi4vdXRpbC9zcHJlYWQuc3R5bGUudXRpbHNcIjtcclxuaW1wb3J0IHsgUnRmU2VydmljZXMgfSBmcm9tICdAcWRwL2NvbW1vbic7XHJcblxyXG5kZWNsYXJlIHZhciBHQzogYW55O1xyXG5cclxuZXhwb3J0IGNsYXNzIEJhc2VSZW5kZXIge1xyXG4gICAgcXVlcnlJZDogYW55O1xyXG4gICAgdHlwZTogYW55O1xyXG4gICAgdXRpbHMgPSBuZXcgTWFwKCk7XHJcbiAgICBhdXRvRml0Q29sdW1uSW5kZXggPSAwO1xyXG4gICAgY2FjaGU6IGFueTtcclxuICAgIG1zZ1NlcnZpY2U6IGFueTtcclxuICAgIGxjcFNlcnZpY2U6IGFueTtcclxuICAgIGxvY2FsaXplU2VydmljZTogYW55O1xyXG4gICAgc2NoZW1hTWFuYWdlcjogYW55O1xyXG4gICAgZm9ybUVycm9yU2VydmljZTogYW55O1xyXG4gICAgbG9hZFNlcnZpY2U6IGFueTtcclxuICAgIGZ1bmNJbmZvQ2FjaGU6IGFueTtcclxuICAgIHNlcnZpY2VDYWNoZTogYW55O1xyXG4gICAgaXNTY2hlbWFTZWxlY3RDaGFuZ2VkID0gZmFsc2U7XHJcbiAgICB0YWJJZDogYW55O1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKF9xdWVyeUlkOiBhbnksIF9jb250cm9sVHlwZTogYW55LCBfam9pbnRzZWFyY2hJbmZvTGlzdD86IGFueSwgX2Z1bmNJbmZvQ2FjaGU/OiBhbnksIF9zZXJ2aWNlQ2FjaGU/OiBhbnkpIHtcclxuICAgICAgICB0aGlzLnRhYklkID0gUnRmU2VydmljZXMuZ2V0VGFiSWQoX3F1ZXJ5SWQpO1xyXG4gICAgICAgIHRoaXMucXVlcnlJZCA9IF9xdWVyeUlkO1xyXG4gICAgICAgIHRoaXMudHlwZSA9IF9jb250cm9sVHlwZTtcclxuICAgICAgICB0aGlzLmZ1bmNJbmZvQ2FjaGUgPSBfZnVuY0luZm9DYWNoZTtcclxuICAgICAgICB0aGlzLnNlcnZpY2VDYWNoZSA9IF9zZXJ2aWNlQ2FjaGU7XHJcbiAgICAgICAgdGhpcy5iYXNlUmVuZGVySW5pdChfcXVlcnlJZCwgX2NvbnRyb2xUeXBlLCBfam9pbnRzZWFyY2hJbmZvTGlzdCwgX2Z1bmNJbmZvQ2FjaGUpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYmFzZVJlbmRlckluaXQoX3F1ZXJ5SWQ6IGFueSwgX2NvbnRyb2xUeXBlOiBhbnksIF9qb2ludHNlYXJjaEluZm9MaXN0PzogYW55LCBfZnVuY0luZm9DYWNoZT86IGFueSkge1xyXG4gICAgICAgIGNvbnN0IHBhcmFtZXRlclV0aWxzID0gbmV3IFBhcmFtZXRlclV0aWxzKF9xdWVyeUlkLCBfZnVuY0luZm9DYWNoZSwgdGhpcy5zZXJ2aWNlQ2FjaGUpO1xyXG4gICAgICAgIGNvbnN0IHNjaGVtYVV0aWxzID0gbmV3IFNjaGVtYVV0aWxzKHRoaXMuc2VydmljZUNhY2hlKTtcclxuICAgICAgICBjb25zdCBzcHJlYWRTdHlsZVV0aWxzID0gbmV3IFNwcmVhZFN0eWxlVXRpbHMoX3F1ZXJ5SWQsIF9jb250cm9sVHlwZSwgX2pvaW50c2VhcmNoSW5mb0xpc3QsIHRoaXMuc2VydmljZUNhY2hlKTtcclxuICAgICAgICBjb25zdCByZW5kZXJFeHRlbmRzVXRpbHMgPSBuZXcgUmVuZGVyRXh0ZW5kc1V0aWxzKF9xdWVyeUlkKTtcclxuICAgICAgICB0aGlzLm1zZ1NlcnZpY2UgPSB0aGlzLnNlcnZpY2VDYWNoZS5tc2dTZXJ2aWNlOyBcclxuICAgICAgICB0aGlzLmNhY2hlID0gdGhpcy5zZXJ2aWNlQ2FjaGUuY2FjaGVTZXJ2aWNlOyBcclxuICAgICAgICB0aGlzLmxjcFNlcnZpY2UgPSB0aGlzLnNlcnZpY2VDYWNoZS5sY3BTZXJ2aWNlOyBcclxuICAgICAgICB0aGlzLmxvYWRTZXJ2aWNlID0gdGhpcy5zZXJ2aWNlQ2FjaGUubG9hZFNlcnZpY2U7IFxyXG4gICAgICAgIHRoaXMubG9jYWxpemVTZXJ2aWNlID0gdGhpcy5zZXJ2aWNlQ2FjaGUubG9jYWxpemVTZXJ2aWNlOyBcclxuICAgICAgICB0aGlzLnNjaGVtYU1hbmFnZXIgPSB0aGlzLnNlcnZpY2VDYWNoZS5zY2hlbWFNYW5hZ2VyU2VydmljZTsgXHJcbiAgICAgICAgdGhpcy5mb3JtRXJyb3JTZXJ2aWNlID0gdGhpcy5zZXJ2aWNlQ2FjaGUuZm9ybUVycm9yU2VydmljZTsgXHJcbiAgICAgICAgdGhpcy5xdWVyeUlkID0gX3F1ZXJ5SWQ7XHJcbiAgICAgICAgdGhpcy51dGlscy5zZXQoJ3BhcmFtZXRlcicsIHBhcmFtZXRlclV0aWxzKTtcclxuICAgICAgICB0aGlzLnV0aWxzLnNldCgnc2NoZW1hJywgc2NoZW1hVXRpbHMpO1xyXG4gICAgICAgIHRoaXMudXRpbHMuc2V0KCdzcHJlYWRTdHlsZScsIHNwcmVhZFN0eWxlVXRpbHMpO1xyXG4gICAgICAgIHRoaXMudXRpbHMuc2V0KCdyZW5kZXJFeHRlbmRzJywgcmVuZGVyRXh0ZW5kc1V0aWxzKTtcclxuICAgICAgICB0aGlzLnV0aWxzLnNldCgncXVlcnlJZCcsIF9xdWVyeUlkKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXREYXRhKHBhcmFtczogYW55LCBxdWVyeVJlbGF0aXZlVXJsOiBhbnkpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgICAgIHRoaXMuY2FjaGUuc2V0KHRoaXMucXVlcnlJZCArICdwYXJhbScsIHBhcmFtcyk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubGNwU2VydmljZS5nZXREYXRhKHBhcmFtcywgcXVlcnlSZWxhdGl2ZVVybCk7XHJcbiAgICB9XHJcblxyXG4gICAgY2hhbmdlRGF0YShkYXRhOiBhbnksIHZhbHVlOiBhbnkpIHtcclxuICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLmRhdGEgJiYgZGF0YS5keW5hbWljQ29scyAmJiB2YWx1ZSkge1xyXG4gICAgICAgICAgICBpZiAodmFsdWUuc2NoZW1hVmFsdWUuY29sdW1uT3B0aW9uICYmIHZhbHVlLnNjaGVtYVZhbHVlLmNvbHVtbk9wdGlvbi5jb2xMaXN0ICYmIHZhbHVlLnNjaGVtYVZhbHVlLmNvbHVtbk9wdGlvbi5jb2xMaXN0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY29sdW1ucyA9IHZhbHVlLnNjaGVtYVZhbHVlLmNvbHVtbk9wdGlvbi5jb2xMaXN0LmZpbHRlcih4ID0+IHgudHlwZSA9PT0gJ2VudW0nKTtcclxuICAgICAgICAgICAgICAgIGlmIChjb2x1bW5zICYmIGNvbHVtbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEuZGF0YS5mb3JFYWNoKHggPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5zLmZvckVhY2goeSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvcmdpblZhbHVlID0geFt5LmJpbmRGaWVsZF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgc2hvd1ZhbHVlID0gb3JnaW5WYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLnJlc3VsdEVudW1JdGVtcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdEVudW1JdGVtID0gZGF0YS5yZXN1bHRFbnVtSXRlbXMuZmluZChyZXN1bHRFbnVtSXRlbSA9PiByZXN1bHRFbnVtSXRlbS5lbnVtTmFtZSA9PT0geS5iaW5kRmllbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHRFbnVtSXRlbSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmaW5kU2hvd1ZhbHVlID0gcmVzdWx0RW51bUl0ZW0ucmVzdWx0RW51bUluZm9MaXN0LmZpbmQocmVzdWx0RW51bSA9PiByZXN1bHRFbnVtLmtleSA9PT0gb3JnaW5WYWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5kU2hvd1ZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG93VmFsdWUgPSB5LnNob3dUeXBlID09PSAnMCcgPyBmaW5kU2hvd1ZhbHVlLmtleSA6IHkuc2hvd1R5cGUgPT09ICcxJyA/IGZpbmRTaG93VmFsdWUuY29kZSA6IGZpbmRTaG93VmFsdWUubmFtZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhbeS5iaW5kRmllbGRdID0gc2hvd1ZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOS6jOW8gOS6uuWRmOiHquWumuS5ieagvOW8j+aWueahiOWkhOeQhlxyXG4gICAgICovXHJcbiAgICBvcGVyYXRlQ3VzdG9tRm9ybWF0U2NoZW1hKGRhdGE6IGFueSwgb2JqOiBSZW5kZXJPcHRpb24pIHtcclxuICAgICAgICBpZiAoZGF0YS5jdXN0b21Gb3JtYXRTY2hlbWUpIHtcclxuICAgICAgICAgICAgb2JqLmN1c3RvbUZvcm1hdFNjaGVtZSA9IGRhdGEuY3VzdG9tRm9ybWF0U2NoZW1lO1xyXG4gICAgICAgICAgICB0aGlzLnNjaGVtYU1hbmFnZXIuY3VzdG9tU2NoZW1hW29iai5ncm91cFR5cGUgPyBvYmouZ3JvdXBUeXBlIDogb2JqLnF1ZXJ5SWRdID0gZGF0YS5jdXN0b21Gb3JtYXRTY2hlbWU7XHJcbiAgICAgICAgICAgIGxldCBjdXN0b21TY2hlbWEgPSBudWxsO1xyXG4gICAgICAgICAgICBpZiAob2JqLnNjaGVtYUlkID09PSAnMScpIHtcclxuICAgICAgICAgICAgICAgIGN1c3RvbVNjaGVtYSA9IHRoaXMuc2NoZW1hTWFuYWdlci5tZXJnZUN1c3RvbVNjaGVtYShvYmouZ3JvdXBUeXBlID8gb2JqLmdyb3VwVHlwZSA6IG9iai5xdWVyeUlkLCBvYmoucXVlcnlJZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGN1c3RvbVNjaGVtYSAmJiBjdXN0b21TY2hlbWEuc2NoZW1hVmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIFNlcnZpY2VzVXRpbHMuc2V0U2VydmljZXMoUnRmU2VydmljZXMuZ2V0VGFiSWQob2JqLnF1ZXJ5SWQpICsgJ2N1c3RvbVNjaGVtZScsIEpTT04uc3RyaW5naWZ5KGN1c3RvbVNjaGVtYS5zY2hlbWFWYWx1ZSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5aSE55CG5YiG6aG15L+h5oGvXHJcbiAgICAgKi9cclxuICAgIG9wZXJhdGVQYWdpbmF0aW9uKG9iajogUmVuZGVyT3B0aW9uLCBwYXJhbXM6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgICAgIGlmIChvYmouY29udHJvbFR5cGUgPT09ICdsaXN0Jykge1xyXG4gICAgICAgICAgICBsZXQgcGFnZVNpemUgPSAwO1xyXG4gICAgICAgICAgICBpZiAob2JqLnNjaGVtYUlkICE9PSAnMScgJiYgc2VsZi5zY2hlbWFNYW5hZ2VyLnNjaGVtYUxpc3QgJiYgc2VsZi5zY2hlbWFNYW5hZ2VyLnNjaGVtYUxpc3Rbb2JqLnNjaGVtYUlkXSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZWxmLnNjaGVtYU1hbmFnZXIuc2NoZW1hTGlzdFtvYmouc2NoZW1hSWRdLnNjaGVtYVZhbHVlID09PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5zY2hlbWFNYW5hZ2VyLnNjaGVtYUxpc3Rbb2JqLnNjaGVtYUlkXS5zY2hlbWFWYWx1ZSA9IEpTT04ucGFyc2Uoc2VsZi5zY2hlbWFNYW5hZ2VyLnNjaGVtYUxpc3Rbb2JqLnNjaGVtYUlkXS5zY2hlbWFWYWx1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoc2VsZi5zY2hlbWFNYW5hZ2VyLnNjaGVtYUxpc3Rbb2JqLnNjaGVtYUlkXS5zY2hlbWFWYWx1ZS5vdGhlck9wdGlvbi5sb2FkRGF0YVR5cGUgIT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBwYWdlU2l6ZSA9IHNlbGYuc2NoZW1hTWFuYWdlci5zY2hlbWFMaXN0W29iai5zY2hlbWFJZF0uc2NoZW1hVmFsdWUub3RoZXJPcHRpb24ucGFnZVNpemU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAob2JqLnNjaGVtYUlkID09PSAnMScgJiYgc2VsZi5zY2hlbWFNYW5hZ2VyLnByZVNjaGVtYSAmJiBzZWxmLnNjaGVtYU1hbmFnZXIucHJlU2NoZW1hLnNjaGVtYVZhbHVlLm90aGVyT3B0aW9uLmxvYWREYXRhVHlwZSAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VTaXplID0gc2VsZi5zY2hlbWFNYW5hZ2VyLnByZVNjaGVtYS5zY2hlbWFWYWx1ZS5vdGhlck9wdGlvbi5wYWdlU2l6ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAocGFnZVNpemUgIT09IDApIHtcclxuICAgICAgICAgICAgICAgIHBhcmFtc1sncGFnZVNpemUnXSA9IHBhZ2VTaXplO1xyXG4gICAgICAgICAgICAgICAgcGFyYW1zWydwYWdlSW5kZXgnXSA9ICFvYmoucGFnZUluZGV4ID8gMSA6IG9iai5wYWdlSW5kZXg7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdGl0bGVWYXJpYWJsZXNSZXBsYWNlKHNoZWV0OiBhbnksIGRhdGE6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IGNvbENvdW50ID0gc2hlZXQuZ2V0Q29sdW1uQ291bnQoR0MuU3ByZWFkLlNoZWV0cy5TaGVldEFyZWEuY29sSGVhZGVyKTtcclxuICAgICAgICBjb25zdCByb3dDb3VudCA9IHNoZWV0LmdldFJvd0NvdW50KEdDLlNwcmVhZC5TaGVldHMuU2hlZXRBcmVhLmNvbEhlYWRlcik7XHJcbiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS52YXJpYWJsZXMpIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgciA9IDA7IHIgPCByb3dDb3VudDsgcisrKSB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBjID0gMDsgYyA8IGNvbENvdW50OyBjKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBzaGVldC5zZXRWYWx1ZShyLCBjLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZhcmlhYmxlc1JlcGxhY2Uoc2hlZXQuZ2V0VmFsdWUociwgYywgR0MuU3ByZWFkLlNoZWV0cy5TaGVldEFyZWEuY29sSGVhZGVyKSwgZGF0YSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIEdDLlNwcmVhZC5TaGVldHMuU2hlZXRBcmVhLmNvbEhlYWRlcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZm9vdGVyVmFyaWFibGVzUmVwbGFjZShzaGVldDogYW55LCBkYXRhOiBhbnkpIHtcclxuICAgICAgICBjb25zdCByb3dDb3VudCA9IHNoZWV0LmdldFJvd0NvdW50KCk7XHJcbiAgICAgICAgY29uc3QgY29sQ291bnQgPSBzaGVldC5nZXRDb2x1bW5Db3VudCgpO1xyXG4gICAgICAgIGlmICh0aGlzLnV0aWxzLmdldCgnc3ByZWFkU3R5bGUnKS5mb290ZXJEYXRhQXJyYXkgJiYgdGhpcy51dGlscy5nZXQoJ3NwcmVhZFN0eWxlJykuZm9vdGVyRGF0YUFycmF5Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCByID0gMDsgciA8IHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLmZvb3RlckRhdGFBcnJheS5sZW5ndGg7IHIrKykge1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgYyA9IDA7IGMgPCBjb2xDb3VudDsgYysrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2hlZXQuc2V0VmFsdWUociArIChyb3dDb3VudCAtIHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLmZvb3RlckRhdGFBcnJheS5sZW5ndGgpLCBjLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZhcmlhYmxlc1JlcGxhY2UodGhpcy51dGlscy5nZXQoJ3NwcmVhZFN0eWxlJykuZm9vdGVyRGF0YUFycmF5W3JdW2NdLCBkYXRhKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB2YXJpYWJsZXNSZXBsYWNlKGNlbGxWYWx1ZTogYW55LCBkYXRhOiBhbnkpIHtcclxuICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLnZhcmlhYmxlcykge1xyXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhkYXRhLnZhcmlhYmxlcykuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVnID0gbmV3IFJlZ0V4cChrZXksICdnJyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2VsbFZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2VsbFZhbHVlID0gY2VsbFZhbHVlLnJlcGxhY2UocmVnLCBkYXRhLnZhcmlhYmxlc1trZXldKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBjZWxsVmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgZXJyb3JIYW5kbGUoc3ByZWFkOiBhbnksIGVycm1zZzogYW55KSB7XHJcbiAgICAgICAgaWYgKHNwcmVhZC5nZXRBY3RpdmVTaGVldCgpKSB7XHJcbiAgICAgICAgICAgIHNwcmVhZC5yZW1vdmVTaGVldCgwKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgc3ByZWFkLm9wdGlvbnMudGFiU3RyaXBWaXNpYmxlID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5tc2dTZXJ2aWNlLndhcm5pbmcoZXJybXNnKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbn0iXX0=