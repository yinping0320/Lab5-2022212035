/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { RtfServices } from "@qdp/common";
import { ServicesUtils } from "./services.utils";
var ParameterUtils = /** @class */ (function () {
    function ParameterUtils(_queryId, _funcInfoCache, _serviceCache) {
        this.queryId = _queryId;
        this.funcInfoCache = _funcInfoCache;
        this.cache = _serviceCache.cacheService;
    }
    /**
     * 创建参数
     * @param option 参数配置项
     * { queryId: 查询ID, controlType: 查询类型：list  treelist  crosstab, schemaId: 方案ID, qoManagerCode: 查询对象编号, extendCond: 扩展条件, pageIndex: 页索引, pageSize: 分页大小, filterCondition: 结果过滤条件, printIntegration: 打印配置, excelExportName: 导出Excel文件名 }
     * @returns
     */
    /**
     * 创建参数
     * @param {?} option 参数配置项
     * { queryId: 查询ID, controlType: 查询类型：list  treelist  crosstab, schemaId: 方案ID, qoManagerCode: 查询对象编号, extendCond: 扩展条件, pageIndex: 页索引, pageSize: 分页大小, filterCondition: 结果过滤条件, printIntegration: 打印配置, excelExportName: 导出Excel文件名 }
     * @return {?}
     */
    ParameterUtils.prototype.createParameters = /**
     * 创建参数
     * @param {?} option 参数配置项
     * { queryId: 查询ID, controlType: 查询类型：list  treelist  crosstab, schemaId: 方案ID, qoManagerCode: 查询对象编号, extendCond: 扩展条件, pageIndex: 页索引, pageSize: 分页大小, filterCondition: 结果过滤条件, printIntegration: 打印配置, excelExportName: 导出Excel文件名 }
     * @return {?}
     */
    function (option) {
        /** @type {?} */
        var tabId = this.bindCloseTabEvent();
        /** @type {?} */
        var entityData;
        if (this.cache.get(tabId)) {
            entityData = JSON.stringify(this.cache.get(tabId));
        }
        else if (this.cache.get(option.queryId)) {
            entityData = JSON.stringify(this.cache.get(option.queryId));
        }
        else {
            entityData = JSON.stringify({ 'id': 'undefined_null' });
        }
        /** @type {?} */
        var params = {
            entityData: entityData,
            extendCond: this.cache.get(tabId + 'extendCond') ? this.cache.get(tabId + 'extendCond') : option.extendCond,
            pageIndex: option.pageIndex ? option.pageIndex : 0,
            pageSize: option.pageSize ? option.pageSize : 0,
            schemaId: option.schemaId && option.schemaId !== 'prefab' ? option.schemaId : '1',
            filterCond: option.filterCondition ? option.filterCondition : (this.cache.get(tabId + 'filtercondition') ? this.cache.get(tabId + 'filtercondition') : ''),
            qoManagerCode: option.qoManagerCode ? option.qoManagerCode : '',
            voCode: option.voId ? option.voId : '',
        };
        try {
            /** @type {?} */
            var parameterEntityData = JSON.parse(entityData);
            if (parameterEntityData.hasOwnProperty('@filterExpressionString@')) {
                /** @type {?} */
                var filterExpression = params && params.filterCond ? JSON.parse(params.filterCond) : null;
                if (!filterExpression) {
                    params.filterCond = parameterEntityData['@filterExpressionString@'];
                }
                else {
                    /** @type {?} */
                    var advanceFilterExpression = JSON.parse(parameterEntityData['@filterExpressionString@']);
                    advanceFilterExpression.expressItems = advanceFilterExpression.expressItems.concat(filterExpression.expressItems);
                    params.filterCond = JSON.stringify(advanceFilterExpression);
                }
            }
        }
        catch (e) {
        }
        if (option.controlType) {
            params['controlType'] = option.controlType;
        }
        if (option.excelExportName) {
            params['excelExportName'] = option.excelExportName;
        }
        if (option.printIntegration) {
            params['printIntegration'] = option.printIntegration ? JSON.stringify(option.printIntegration) : '';
        }
        if (option.multiSheets) {
            params['multiSheets'] = option.multiSheets && option.multiSheets.length ? option.multiSheets.join(",") : '';
        }
        if (option.curSheet) {
            params['curSheet'] = option.curSheet;
        }
        if (option.multiSheetsSchemaIds) {
            params['multiSheetsSchemaIds'] = option.multiSheetsSchemaIds ? JSON.stringify(option.multiSheetsSchemaIds) : '';
        }
        if (option.groupType) {
            params['groupType'] = option.groupType ? option.groupType : '';
        }
        if (option.queryId) {
            params['queryId'] = option.queryId ? option.queryId : '';
        }
        if (RtfServices.getMenuParameter('enableQOExtends')) {
            params['enableQOExtends'] = RtfServices.getMenuParameter('enableQOExtends');
            params['qoId'] = ServicesUtils.getServices(RtfServices.getTabId(this.queryId) + 'qoId');
        }
        return params;
    };
    /**
     * 绑定功能菜单关闭事件
     */
    /**
     * 绑定功能菜单关闭事件
     * @return {?}
     */
    ParameterUtils.prototype.bindCloseTabEvent = /**
     * 绑定功能菜单关闭事件
     * @return {?}
     */
    function () {
        try {
            /** @type {?} */
            var tab_1 = gspframeworkService.rtf.session.getCommonVariable();
            gspframeworkService.rtf.frmEvent.eventListener('beforeFuncCloseEvent', this.clearParametersCache.bind(this), tab_1);
            /** @type {?} */
            var index = this.funcInfoCache.funcIds.findIndex((/**
             * @param {?} el
             * @return {?}
             */
            function (el) { return el === tab_1.tabId; }));
            if (index < 0) {
                this.funcInfoCache.funcIds.push(tab_1.tabId);
            }
            return tab_1.tabId + RtfServices.getInSuiteFrmUUID();
        }
        catch (e) {
        }
    };
    /**
     * 清除查询缓存
     */
    /**
     * 清除查询缓存
     * @return {?}
     */
    ParameterUtils.prototype.clearParametersCache = /**
     * 清除查询缓存
     * @return {?}
     */
    function () {
        /** @type {?} */
        var tabId = arguments[0].tabId;
        if (this.queryId) {
            this.cache.set(this.queryId, '');
        }
        this.cache.set(tabId, '');
        this.cache.set(tabId + 'renderMode', '');
        /** @type {?} */
        var index = this.funcInfoCache.funcIds.findIndex((/**
         * @param {?} el
         * @return {?}
         */
        function (el) { return el === tabId; }));
        if (index >= 0) {
            this.funcInfoCache.funcIds.splice(index, 1);
            index = this.funcInfoCache.firstLoadCache.findIndex((/**
             * @param {?} el
             * @return {?}
             */
            function (el) { return el === tabId; }));
            if (index >= 0) {
                this.funcInfoCache.firstLoadCache.splice(index, 1);
            }
            gspframeworkService.rtf.func.close(arguments[0]);
        }
    };
    return ParameterUtils;
}());
export { ParameterUtils };
if (false) {
    /**
     * @type {?}
     * @private
     */
    ParameterUtils.prototype.cache;
    /** @type {?} */
    ParameterUtils.prototype.queryId;
    /** @type {?} */
    ParameterUtils.prototype.funcInfoCache;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyYW1ldGVyLnV0aWxzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHFkcC9zcHJlYWQvIiwic291cmNlcyI6WyJsaWIvdXRpbC9wYXJhbWV0ZXIudXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDMUMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBSWpEO0lBS0ksd0JBQVksUUFBYyxFQUFFLGNBQW9CLEVBQUUsYUFBbUI7UUFDakUsSUFBSSxDQUFDLE9BQU8sR0FBRyxRQUFRLENBQUM7UUFDeEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxjQUFjLENBQUM7UUFDcEMsSUFBSSxDQUFDLEtBQUssR0FBRyxhQUFhLENBQUMsWUFBWSxDQUFDO0lBQzVDLENBQUM7SUFFRDs7Ozs7T0FLRzs7Ozs7OztJQUNILHlDQUFnQjs7Ozs7O0lBQWhCLFVBQWlCLE1BQVc7O1lBQ2xCLEtBQUssR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUU7O1lBQ2xDLFVBQWU7UUFDbkIsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUN2QixVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1NBQ3REO2FBQU0sSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDdkMsVUFBVSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7U0FDL0Q7YUFBTTtZQUNILFVBQVUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixFQUFFLENBQUMsQ0FBQztTQUMz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QUMxQixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsWUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDOztZQUNyQyxLQUFLLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsU0FBUzs7OztRQUFDLFVBQUEsRUFBRSxJQUFJLE9BQUEsRUFBRSxLQUFLLEtBQUssRUFBWixDQUFZLEVBQUM7UUFDcEUsSUFBSSxLQUFLLElBQUksQ0FBQyxFQUFFO1lBQ1osSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztZQUM1QyxLQUFLLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsU0FBUzs7OztZQUFDLFVBQUEsRUFBRSxJQUFJLE9BQUEsRUFBRSxLQUFLLEtBQUssRUFBWixDQUFZLEVBQUMsQ0FBQztZQUN4RSxJQUFJLEtBQUssSUFBSSxDQUFDLEVBQUU7Z0JBQ1osSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQzthQUN0RDtZQUNELG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3BEO0lBQ0wsQ0FBQztJQUNMLHFCQUFDO0FBQUQsQ0FBQyxBQXhIRCxJQXdIQzs7Ozs7OztJQXZIRywrQkFBNEI7O0lBQzVCLGlDQUFhOztJQUNiLHVDQUFtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENhY2hlU2VydmljZSB9IGZyb20gXCJAZWNwLWNhZi9jYWYtY29tbW9uXCI7XHJcbmltcG9ydCB7IFJ0ZlNlcnZpY2VzIH0gZnJvbSBcIkBxZHAvY29tbW9uXCI7XHJcbmltcG9ydCB7IFNlcnZpY2VzVXRpbHMgfSBmcm9tIFwiLi9zZXJ2aWNlcy51dGlsc1wiO1xyXG5cclxuZGVjbGFyZSB2YXIgZ3NwZnJhbWV3b3JrU2VydmljZTogYW55O1xyXG5cclxuZXhwb3J0IGNsYXNzIFBhcmFtZXRlclV0aWxzIHtcclxuICAgIHByaXZhdGUgY2FjaGU6IENhY2hlU2VydmljZTtcclxuICAgIHF1ZXJ5SWQ6IGFueTtcclxuICAgIGZ1bmNJbmZvQ2FjaGU6IGFueTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihfcXVlcnlJZD86IGFueSwgX2Z1bmNJbmZvQ2FjaGU/OiBhbnksIF9zZXJ2aWNlQ2FjaGU/OiBhbnkpIHtcclxuICAgICAgICB0aGlzLnF1ZXJ5SWQgPSBfcXVlcnlJZDtcclxuICAgICAgICB0aGlzLmZ1bmNJbmZvQ2FjaGUgPSBfZnVuY0luZm9DYWNoZTtcclxuICAgICAgICB0aGlzLmNhY2hlID0gX3NlcnZpY2VDYWNoZS5jYWNoZVNlcnZpY2U7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDliJvlu7rlj4LmlbBcclxuICAgICAqIEBwYXJhbSBvcHRpb24g5Y+C5pWw6YWN572u6aG5XHJcbiAgICAgKiB7IHF1ZXJ5SWQ6IOafpeivoklELCBjb250cm9sVHlwZTog5p+l6K+i57G75Z6L77yabGlzdCAgdHJlZWxpc3QgIGNyb3NzdGFiLCBzY2hlbWFJZDog5pa55qGISUQsIHFvTWFuYWdlckNvZGU6IOafpeivouWvueixoee8luWPtywgZXh0ZW5kQ29uZDog5omp5bGV5p2h5Lu2LCBwYWdlSW5kZXg6IOmhtee0ouW8lSwgcGFnZVNpemU6IOWIhumhteWkp+WwjywgZmlsdGVyQ29uZGl0aW9uOiDnu5Pmnpzov4fmu6TmnaHku7YsIHByaW50SW50ZWdyYXRpb246IOaJk+WNsOmFjee9riwgZXhjZWxFeHBvcnROYW1lOiDlr7zlh7pFeGNlbOaWh+S7tuWQjSB9XHJcbiAgICAgKiBAcmV0dXJucyBcclxuICAgICAqL1xyXG4gICAgY3JlYXRlUGFyYW1ldGVycyhvcHRpb246IGFueSkge1xyXG4gICAgICAgIGNvbnN0IHRhYklkID0gdGhpcy5iaW5kQ2xvc2VUYWJFdmVudCgpO1xyXG4gICAgICAgIGxldCBlbnRpdHlEYXRhOiBhbnk7XHJcbiAgICAgICAgaWYgKHRoaXMuY2FjaGUuZ2V0KHRhYklkKSkge1xyXG4gICAgICAgICAgICBlbnRpdHlEYXRhID0gSlNPTi5zdHJpbmdpZnkodGhpcy5jYWNoZS5nZXQodGFiSWQpKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2FjaGUuZ2V0KG9wdGlvbi5xdWVyeUlkKSkge1xyXG4gICAgICAgICAgICBlbnRpdHlEYXRhID0gSlNPTi5zdHJpbmdpZnkodGhpcy5jYWNoZS5nZXQob3B0aW9uLnF1ZXJ5SWQpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBlbnRpdHlEYXRhID0gSlNPTi5zdHJpbmdpZnkoeyAnaWQnOiAndW5kZWZpbmVkX251bGwnIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBwYXJhbXMgPSB7XHJcbiAgICAgICAgICAgIGVudGl0eURhdGE6IGVudGl0eURhdGEsXHJcbiAgICAgICAgICAgIGV4dGVuZENvbmQ6IHRoaXMuY2FjaGUuZ2V0KHRhYklkICsgJ2V4dGVuZENvbmQnKSA/IHRoaXMuY2FjaGUuZ2V0KHRhYklkICsgJ2V4dGVuZENvbmQnKSA6IG9wdGlvbi5leHRlbmRDb25kLFxyXG4gICAgICAgICAgICBwYWdlSW5kZXg6IG9wdGlvbi5wYWdlSW5kZXggPyBvcHRpb24ucGFnZUluZGV4IDogMCxcclxuICAgICAgICAgICAgcGFnZVNpemU6IG9wdGlvbi5wYWdlU2l6ZSA/IG9wdGlvbi5wYWdlU2l6ZSA6IDAsXHJcbiAgICAgICAgICAgIHNjaGVtYUlkOiBvcHRpb24uc2NoZW1hSWQgJiYgb3B0aW9uLnNjaGVtYUlkICE9PSAncHJlZmFiJyA/IG9wdGlvbi5zY2hlbWFJZCA6ICcxJyxcclxuICAgICAgICAgICAgZmlsdGVyQ29uZDogb3B0aW9uLmZpbHRlckNvbmRpdGlvbiA/IG9wdGlvbi5maWx0ZXJDb25kaXRpb24gOiAodGhpcy5jYWNoZS5nZXQodGFiSWQgKyAnZmlsdGVyY29uZGl0aW9uJykgPyB0aGlzLmNhY2hlLmdldCh0YWJJZCArICdmaWx0ZXJjb25kaXRpb24nKSA6ICcnKSxcclxuICAgICAgICAgICAgcW9NYW5hZ2VyQ29kZTogb3B0aW9uLnFvTWFuYWdlckNvZGUgPyBvcHRpb24ucW9NYW5hZ2VyQ29kZSA6ICcnLFxyXG4gICAgICAgICAgICB2b0NvZGU6IG9wdGlvbi52b0lkID8gb3B0aW9uLnZvSWQgOiAnJyxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcmFtZXRlckVudGl0eURhdGEgPSBKU09OLnBhcnNlKGVudGl0eURhdGEpO1xyXG4gICAgICAgICAgICBpZiAocGFyYW1ldGVyRW50aXR5RGF0YS5oYXNPd25Qcm9wZXJ0eSgnQGZpbHRlckV4cHJlc3Npb25TdHJpbmdAJykpIHtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBmaWx0ZXJFeHByZXNzaW9uID0gcGFyYW1zICYmIHBhcmFtcy5maWx0ZXJDb25kID8gSlNPTi5wYXJzZShwYXJhbXMuZmlsdGVyQ29uZCkgOiBudWxsO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFmaWx0ZXJFeHByZXNzaW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zLmZpbHRlckNvbmQgPSBwYXJhbWV0ZXJFbnRpdHlEYXRhWydAZmlsdGVyRXhwcmVzc2lvblN0cmluZ0AnXTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWR2YW5jZUZpbHRlckV4cHJlc3Npb24gPSBKU09OLnBhcnNlKHBhcmFtZXRlckVudGl0eURhdGFbJ0BmaWx0ZXJFeHByZXNzaW9uU3RyaW5nQCddKTtcclxuICAgICAgICAgICAgICAgICAgICBhZHZhbmNlRmlsdGVyRXhwcmVzc2lvbi5leHByZXNzSXRlbXMgPSBhZHZhbmNlRmlsdGVyRXhwcmVzc2lvbi5leHByZXNzSXRlbXMuY29uY2F0KGZpbHRlckV4cHJlc3Npb24uZXhwcmVzc0l0ZW1zKTtcclxuICAgICAgICAgICAgICAgICAgICBwYXJhbXMuZmlsdGVyQ29uZCA9IEpTT04uc3RyaW5naWZ5KGFkdmFuY2VGaWx0ZXJFeHByZXNzaW9uKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG9wdGlvbi5jb250cm9sVHlwZSkge1xyXG4gICAgICAgICAgICBwYXJhbXNbJ2NvbnRyb2xUeXBlJ10gPSBvcHRpb24uY29udHJvbFR5cGU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvcHRpb24uZXhjZWxFeHBvcnROYW1lKSB7XHJcbiAgICAgICAgICAgIHBhcmFtc1snZXhjZWxFeHBvcnROYW1lJ10gPSBvcHRpb24uZXhjZWxFeHBvcnROYW1lO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAob3B0aW9uLnByaW50SW50ZWdyYXRpb24pIHtcclxuICAgICAgICAgICAgcGFyYW1zWydwcmludEludGVncmF0aW9uJ10gPSBvcHRpb24ucHJpbnRJbnRlZ3JhdGlvbiA/IEpTT04uc3RyaW5naWZ5KG9wdGlvbi5wcmludEludGVncmF0aW9uKSA6ICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAob3B0aW9uLm11bHRpU2hlZXRzKSB7XHJcbiAgICAgICAgICAgIHBhcmFtc1snbXVsdGlTaGVldHMnXSA9IG9wdGlvbi5tdWx0aVNoZWV0cyAmJiBvcHRpb24ubXVsdGlTaGVldHMubGVuZ3RoID8gb3B0aW9uLm11bHRpU2hlZXRzLmpvaW4oXCIsXCIpIDogJyc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvcHRpb24uY3VyU2hlZXQpIHtcclxuICAgICAgICAgICAgcGFyYW1zWydjdXJTaGVldCddID0gb3B0aW9uLmN1clNoZWV0O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAob3B0aW9uLm11bHRpU2hlZXRzU2NoZW1hSWRzKSB7XHJcbiAgICAgICAgICAgIHBhcmFtc1snbXVsdGlTaGVldHNTY2hlbWFJZHMnXSA9IG9wdGlvbi5tdWx0aVNoZWV0c1NjaGVtYUlkcyA/IEpTT04uc3RyaW5naWZ5KG9wdGlvbi5tdWx0aVNoZWV0c1NjaGVtYUlkcykgOiAnJztcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG9wdGlvbi5ncm91cFR5cGUpIHtcclxuICAgICAgICAgICAgcGFyYW1zWydncm91cFR5cGUnXSA9IG9wdGlvbi5ncm91cFR5cGUgPyBvcHRpb24uZ3JvdXBUeXBlIDogJyc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvcHRpb24ucXVlcnlJZCkge1xyXG4gICAgICAgICAgICBwYXJhbXNbJ3F1ZXJ5SWQnXSA9IG9wdGlvbi5xdWVyeUlkID8gb3B0aW9uLnF1ZXJ5SWQgOiAnJztcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKFJ0ZlNlcnZpY2VzLmdldE1lbnVQYXJhbWV0ZXIoJ2VuYWJsZVFPRXh0ZW5kcycpKSB7XHJcbiAgICAgICAgICAgIHBhcmFtc1snZW5hYmxlUU9FeHRlbmRzJ10gPSBSdGZTZXJ2aWNlcy5nZXRNZW51UGFyYW1ldGVyKCdlbmFibGVRT0V4dGVuZHMnKTtcclxuICAgICAgICAgICAgcGFyYW1zWydxb0lkJ10gPSBTZXJ2aWNlc1V0aWxzLmdldFNlcnZpY2VzKFJ0ZlNlcnZpY2VzLmdldFRhYklkKHRoaXMucXVlcnlJZCkgKyAncW9JZCcpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHBhcmFtcztcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOe7keWumuWKn+iDveiPnOWNleWFs+mXreS6i+S7tlxyXG4gICAgICovXHJcbiAgICBiaW5kQ2xvc2VUYWJFdmVudCgpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCB0YWIgPSBnc3BmcmFtZXdvcmtTZXJ2aWNlLnJ0Zi5zZXNzaW9uLmdldENvbW1vblZhcmlhYmxlKCk7XHJcbiAgICAgICAgICAgIGdzcGZyYW1ld29ya1NlcnZpY2UucnRmLmZybUV2ZW50LmV2ZW50TGlzdGVuZXIoJ2JlZm9yZUZ1bmNDbG9zZUV2ZW50JywgdGhpcy5jbGVhclBhcmFtZXRlcnNDYWNoZS5iaW5kKHRoaXMpLCB0YWIpO1xyXG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMuZnVuY0luZm9DYWNoZS5mdW5jSWRzLmZpbmRJbmRleChlbCA9PiBlbCA9PT0gdGFiLnRhYklkKTtcclxuICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5mdW5jSW5mb0NhY2hlLmZ1bmNJZHMucHVzaCh0YWIudGFiSWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0YWIudGFiSWQgKyBSdGZTZXJ2aWNlcy5nZXRJblN1aXRlRnJtVVVJRCgpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmuIXpmaTmn6Xor6LnvJPlrZhcclxuICAgICAqL1xyXG4gICAgY2xlYXJQYXJhbWV0ZXJzQ2FjaGUoKSB7XHJcbiAgICAgICAgY29uc3QgdGFiSWQgPSBhcmd1bWVudHNbMF0udGFiSWQ7XHJcbiAgICAgICAgaWYgKHRoaXMucXVlcnlJZCkge1xyXG4gICAgICAgICAgICB0aGlzLmNhY2hlLnNldCh0aGlzLnF1ZXJ5SWQsICcnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jYWNoZS5zZXQodGFiSWQsICcnKTtcclxuICAgICAgICB0aGlzLmNhY2hlLnNldCh0YWJJZCArICdyZW5kZXJNb2RlJywgJycpO1xyXG4gICAgICAgIGxldCBpbmRleCA9IHRoaXMuZnVuY0luZm9DYWNoZS5mdW5jSWRzLmZpbmRJbmRleChlbCA9PiBlbCA9PT0gdGFiSWQpO1xyXG4gICAgICAgIGlmIChpbmRleCA+PSAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZnVuY0luZm9DYWNoZS5mdW5jSWRzLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICAgIGluZGV4ID0gdGhpcy5mdW5jSW5mb0NhY2hlLmZpcnN0TG9hZENhY2hlLmZpbmRJbmRleChlbCA9PiBlbCA9PT0gdGFiSWQpO1xyXG4gICAgICAgICAgICBpZiAoaW5kZXggPj0gMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5mdW5jSW5mb0NhY2hlLmZpcnN0TG9hZENhY2hlLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZ3NwZnJhbWV3b3JrU2VydmljZS5ydGYuZnVuYy5jbG9zZShhcmd1bWVudHNbMF0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufSJdfQ==