/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Injector, Optional } from '@angular/core';
import { SchemaManagerService, LcpService } from '@qdp/common';
import { CacheService } from '@ecp-caf/caf-common';
import { LoadingService } from '@farris/ui-loading';
import { NotifyService } from '@farris/ui-notify';
import { DataRenderExtendService } from '@qdp/common';
import { RtfServices } from '@qdp/common';
import { LocalizeService } from '@qdp/localize';
import { MessagerService } from '@farris/ui-messager';
import { FormErrorService } from '@farris/command-services';
import { CloudprintService } from '@gsp-svc/cloudprint';
import { ServicesUtils } from '../../util/services.utils';
import { CrosstabRender } from '../../engine/crosstab-render';
import { ListTreeRender } from '../../engine/list-render';
export class RenderService {
    /**
     * @param {?} schemaManager
     * @param {?} lcpService
     * @param {?} cache
     * @param {?} loadService
     * @param {?} msgService
     * @param {?} dataRenderExtendService
     * @param {?} injector
     */
    constructor(schemaManager, lcpService, cache, loadService, msgService, dataRenderExtendService, injector) {
        this.schemaManager = schemaManager;
        this.lcpService = lcpService;
        this.cache = cache;
        this.loadService = loadService;
        this.msgService = msgService;
        this.dataRenderExtendService = dataRenderExtendService;
        this.injector = injector;
        this.serviceCache = {};
        this.columnCount = 0;
        this.operations = {};
        this.funcInfoCache = {
            funcIds: [],
            firstLoadCache: []
        };
        /** @type {?} */
        const self = this;
        if (this.injector) {
            this.localizeService = this.injector.get(LocalizeService);
            this.formErrorService = this.injector.get(FormErrorService);
            this.cloudprintService = this.injector.get(CloudprintService);
            this.notifyService = this.injector.get(NotifyService);
            this.setService();
            self.schemaManager.operationChange.subscribe((/**
             * @param {?} value
             * @return {?}
             */
            (value) => {
                if (value) {
                    self.operations = value;
                }
            }));
            self.setSecurityLevel();
        }
    }
    /**
     * @private
     * @return {?}
     */
    setService() {
        /** @type {?} */
        const tabId = RtfServices.getTabId() || 'default';
        this.serviceCache[tabId] = {
            'formErrorService': this.formErrorService,
            'cloudprintService': this.cloudprintService,
            'schemaManagerService': this.schemaManager,
            'lcpService': this.lcpService,
            'cacheService': this.cache,
            'loadingService': this.loadService,
            'msgService': this.msgService,
            'localizeService': this.localizeService,
            'notifyService': this.notifyService
        };
    }
    /**
     * @private
     * @return {?}
     */
    getService() {
        /** @type {?} */
        const tabId = RtfServices.getTabId() || 'default';
        return this.serviceCache[tabId];
    }
    /**
     * @private
     * @return {?}
     */
    setSecurityLevel() {
        this.lcpService.variablesChange.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            if (data && data.hasOwnProperty('securityLevel') && data['securityLevel']) {
                this.cache.set(RtfServices.getTabId() + 'securityLevel', data['securityLevel']);
            }
        }));
    }
    /**
     * @private
     * @return {?}
     */
    getSecurityLevel() {
        if (this.cache.get(RtfServices.getTabId() + 'securityLevel')) {
            return this.cache.get(RtfServices.getTabId() + 'securityLevel');
        }
        else {
            return '';
        }
    }
    /**
     * @param {?} option
     * @return {?}
     */
    render(option) {
        if (!option.loading) {
            option.loading = this.loadService.show({ container: 'body' });
        }
        this.spread = option.spread ? option.spread : null;
        this.renderObject = this.getRender(option);
        this.renderObject.render(option);
    }
    /**
     * @private
     * @param {?} obj
     * @return {?}
     */
    getRender(obj) {
        this.setService();
        ServicesUtils.setServices('dataRenderExtendService' + obj.queryId, this.dataRenderExtendService);
        /** @type {?} */
        let render;
        switch (obj.controlType) {
            case 'crosstab':
                render = new CrosstabRender(obj.queryId, obj.controlType, obj.jointsearchInfoList, this.funcInfoCache, this.getService());
                break;
            default:
                render = new ListTreeRender(obj.queryId, obj.controlType, obj.jointsearchInfoList, this.funcInfoCache, this.getService());
                break;
        }
        render.isSchemaSelectChanged = obj.isSchemaSelectChanged ? obj.isSchemaSelectChanged : false;
        return render;
    }
    /**
     * @param {?} renderOption
     * @return {?}
     */
    exportData(renderOption) {
        // exportData(queryId: any, schemaId: any, controlType: any, pageIndex?: number, qoManagerCode?: any, queryRelativeUrl?: any, filterCondition?: any, groupType?: any, voId?: any, totalCount?: any, exportType?: any) {
        /** @type {?} */
        const loading = this.loadService.show({ container: 'body' });
        this.renderObject.utils.get('schema').getSchemaInfo({ schemaId: renderOption.schemaValue, queryId: renderOption.queryId, queryRelativeUrl: renderOption.queryRelativeUrl, groupType: renderOption.groupType }).subscribe((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            renderOption.schemaId = renderOption.schemaId ? renderOption.schemaId : (value && value.id ? value.id : '1');
            /** @type {?} */
            let schemaName = value && value.schemaValue && value.schemaValue.titleOption && value.schemaValue.titleOption.title
                ? value.schemaValue.titleOption.title
                : value && value.schemaName
                    ? value.schemaName
                    : '';
            if (RtfServices.getFuncName()) {
                schemaName = RtfServices.getFuncName() + '-' + schemaName;
            }
            renderOption.excelExportName = schemaName;
            /** @type {?} */
            const params = this.renderObject.utils.get('parameter').createParameters(renderOption);
            params['exportType'] = renderOption.exportType ? renderOption.exportType : '';
            /** @type {?} */
            let isCustomShema = false;
            /** @type {?} */
            let customSchema = null;
            if (params['schemaId'] === '1') {
                if (ServicesUtils.getServices(RtfServices.getTabId(renderOption.queryId) + 'customScheme')) {
                    isCustomShema = true;
                    params.customSchema = ServicesUtils.getServices(RtfServices.getTabId(renderOption.queryId) + 'customScheme');
                    customSchema = JSON.parse(params.customSchema);
                    if (!params.excelExportName) {
                        params.excelExportName = customSchema && customSchema.titleOption && customSchema.titleOption.title
                            ? customSchema.titleOption.title : 'export';
                    }
                }
                else {
                    this.msgService.warning(this.localizeService.getValue('spread.message.export'));
                    loading.close();
                    return;
                }
            }
            if (this.operations['QdpQueryExport'] === false) {
                this.msgService.warning(this.localizeService.getValue('spread.message.validate.qdpQueryExport'));
                loading.close();
                return;
            }
            try {
                if (renderOption.controlType === 'treelist' && this.spread) {
                    /** @type {?} */
                    let expandNodes = '';
                    if (value && value.schemaValue && value.schemaValue.otherOption && value.schemaValue.otherOption.treeInfoType !== 2) {
                        /** @type {?} */
                        const pathField = value.schemaValue.otherOption.treeInfoType === 0 ? value.schemaValue.otherOption.pathField : value.schemaValue.otherOption.idField;
                        if (pathField) {
                            for (let i = 0; i < this.spread.getActiveSheet().getRowCount(); i++) {
                                if (this.spread.getActiveSheet().rowOutlines.isCollapsed(i)) {
                                    expandNodes += ',' + this.spread.getActiveSheet().getDataItem(i)[pathField];
                                }
                            }
                            params['expandNodes'] = expandNodes.substring(1);
                        }
                    }
                }
            }
            catch (e) {
            }
            this.columnCount = 0;
            if (!isCustomShema) {
                this.calculationColumnCount(value.schemaValue.columnOption.colList);
            }
            else {
                if (customSchema && customSchema.columnOption && customSchema.columnOption.colList) {
                    this.calculationColumnCount(customSchema.columnOption.colList);
                }
            }
            this.lcpService.loading = loading;
            if (this.getSecurityLevel()) {
                params.excelExportName += '_' + this.getSecurityLevel();
            }
            if ((this.columnCount * renderOption.totalCount) < 100000) {
                this.lcpService.exportData(params, renderOption.queryRelativeUrl);
                loading.close();
            }
            else {
                this.lcpService.aysnExportData(params, renderOption.queryRelativeUrl);
                loading.close();
                this.msgService.warning(this.localizeService.getValue('spread.message.aysnExport'));
            }
        }));
    }
    /**
     * @private
     * @param {?} colList
     * @return {?}
     */
    calculationColumnCount(colList) {
        try {
            colList.forEach((/**
             * @param {?} item
             * @return {?}
             */
            (item) => {
                if (item.childList && item.childList.length) {
                    this.calculationColumnCount(item.childList);
                }
                else {
                    this.columnCount += 1;
                }
            }));
        }
        catch (e) {
            this.columnCount = 0;
        }
    }
    /**
     * @param {?} queryId
     * @param {?} schemaId
     * @param {?} controlType
     * @param {?=} qoManagerCode
     * @param {?=} queryRelativeUrl
     * @param {?=} filterCondition
     * @param {?=} groupType
     * @param {?=} voId
     * @return {?}
     */
    clearCache(queryId, schemaId, controlType, qoManagerCode, queryRelativeUrl, filterCondition, groupType, voId) {
        this.renderObject.utils.get('schema').getSchemaInfo({ schemaId, queryId, queryRelativeUrl, groupType }).subscribe((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            schemaId = schemaId ? schemaId : (value && value.id ? value.id : '1');
            /** @type {?} */
            const schemaName = value && value.schemaValue && value.schemaValue.titleOption && value.schemaValue.titleOption.title
                ? value.schemaValue.titleOption.title
                : value && value.schemaName
                    ? value.schemaName
                    : '';
            /** @type {?} */
            const params = this.renderObject.utils.get('parameter').createParameters({
                queryId,
                controlType,
                schemaId,
                qoManagerCode,
                pageIndex: 0,
                pageSize: 0,
                excelExportName: schemaName,
                filterCondition,
                voId
            });
            if (ServicesUtils.getServices(RtfServices.getTabId(queryId) + 'customScheme')) {
                params.customSchema = ServicesUtils.getServices(RtfServices.getTabId(queryId) + 'customScheme');
            }
            this.lcpService.clearCache(params).subscribe((/**
             * @param {?} data
             * @return {?}
             */
            data => {
                if (data) {
                    this.notifyService['success']((/** @type {?} */ ({
                        title: this.localizeService.getValue('ideCmp.schemaManager.message.info.title'), msg: this.localizeService.getValue('spread.message.clearCache'), timeout: 3000
                    })));
                }
            }));
        }));
    }
    /**
     * @param {?} renderOption
     * @return {?}
     */
    pdfExportEvent(renderOption) {
        // pdfExportEvent(queryId: any, schemaId: any, controlType: any, qoManagerCode?: any, printIntegration?: any, queryRelativeUrl?: any, filterCondition?: any, groupType?: any, pageIndex?: any, voId?: any) {
        /** @type {?} */
        const loading = this.loadService.show({ container: 'body' });
        try {
            this.renderObject.utils.get('schema').getSchemaInfo({ schemaId: renderOption.schemaValue, queryId: renderOption.queryId, queryRelativeUrl: renderOption.queryRelativeUrl, groupType: renderOption.groupType }).subscribe((/**
             * @param {?} value
             * @return {?}
             */
            value => {
                renderOption.schemaId = renderOption.schemaId ? renderOption.schemaId : (value && value.id ? value.id : '1');
                /** @type {?} */
                let schemaName = value && value.schemaValue && value.schemaValue.titleOption && value.schemaValue.titleOption.title
                    ? value.schemaValue.titleOption.title
                    : value && value.schemaName
                        ? value.schemaName
                        : '';
                if (RtfServices.getFuncName()) {
                    schemaName = RtfServices.getFuncName() + '-' + schemaName;
                }
                renderOption.excelExportName = schemaName;
                /** @type {?} */
                const params = this.renderObject.utils.get('parameter').createParameters(renderOption);
                if (params['schemaId'] === '1') {
                    if (ServicesUtils.getServices(RtfServices.getTabId(renderOption.queryId) + 'customScheme')) {
                        params.customSchema = ServicesUtils.getServices(RtfServices.getTabId(renderOption.queryId) + 'customScheme');
                        /** @type {?} */
                        const customSchema = JSON.parse(params.customSchema);
                        if (!params.excelExportName) {
                            params.excelExportName = customSchema && customSchema.titleOption && customSchema.titleOption.title
                                ? customSchema.titleOption.title : 'export';
                        }
                    }
                    else {
                        this.msgService.warning(this.localizeService.getValue('spread.message.print'));
                        loading.close();
                        return;
                    }
                }
                if (this.operations['QdpQueryPrint'] === false) {
                    this.msgService.warning(this.localizeService.getValue('spread.message.validate.qdpQueryPrint'));
                    loading.close();
                    return;
                }
                if (this.getSecurityLevel()) {
                    params.excelExportName += '_' + this.getSecurityLevel();
                }
                this.lcpService.pdfExportEvent(params, renderOption.queryRelativeUrl);
                loading.close();
            }));
        }
        catch (e) {
            loading.close();
            // console.log(e);
        }
    }
    /**
     * @param {?} renderOption
     * @return {?}
     */
    printPreView(renderOption) {
        // printPreView(queryId: any, schemaId: any, controlType: any, qoManagerCode?: any, printIntegration?: any, queryRelativeUrl?: any, filterCondition?: any, groupType?: any, pageIndex?: any, voId?: any) {
        this.renderObject.utils.get('schema').getSchemaInfo({ schemaId: renderOption.schemaValue, queryId: renderOption.queryId, queryRelativeUrl: renderOption.queryRelativeUrl, groupType: renderOption.groupType }).subscribe((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            renderOption.schemaId = renderOption.schemaId ? renderOption.schemaId : (value && value.id ? value.id : '1');
            /** @type {?} */
            const schemaName = value && value.schemaValue && value.schemaValue.titleOption && value.schemaValue.titleOption.title
                ? value.schemaValue.titleOption.title
                : value && value.schemaName
                    ? value.schemaName
                    : '';
            renderOption.excelExportName = schemaName;
            /** @type {?} */
            const params = this.renderObject.utils.get('parameter').createParameters(renderOption);
            if (params['schemaId'] === '1') {
                if (ServicesUtils.getServices(RtfServices.getTabId(renderOption.queryId) + 'customScheme')) {
                    params.customSchema = ServicesUtils.getServices(RtfServices.getTabId(renderOption.queryId) + 'customScheme');
                    /** @type {?} */
                    const customSchema = JSON.parse(params.customSchema);
                    if (!params.excelExportName) {
                        params.excelExportName = customSchema && customSchema.titleOption && customSchema.titleOption.title
                            ? customSchema.titleOption.title : 'export';
                    }
                }
                else {
                    this.msgService.warning(this.localizeService.getValue('spread.message.preview'));
                    return;
                }
            }
            if (this.getSecurityLevel()) {
                params.excelExportName += '_' + this.getSecurityLevel();
            }
            this.lcpService.cloudprintService = this.cloudprintService;
            this.lcpService.printPreView(params, renderOption.queryRelativeUrl);
        }));
    }
    /**
     * @param {?=} queryId
     * @return {?}
     */
    clearFirstLoadCache(queryId) {
        /** @type {?} */
        const funcId = RtfServices.getTabId(queryId);
        /** @type {?} */
        const index = this.funcInfoCache.firstLoadCache.findIndex((/**
         * @param {?} el
         * @return {?}
         */
        el => el === funcId));
        if (index >= 0) {
            this.funcInfoCache.firstLoadCache.splice(index, 1);
        }
    }
}
RenderService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
RenderService.ctorParameters = () => [
    { type: SchemaManagerService },
    { type: LcpService },
    { type: CacheService },
    { type: LoadingService },
    { type: MessagerService },
    { type: DataRenderExtendService, decorators: [{ type: Optional }] },
    { type: Injector, decorators: [{ type: Optional }] }
];
if (false) {
    /** @type {?} */
    RenderService.prototype.cloudprintService;
    /** @type {?} */
    RenderService.prototype.formErrorService;
    /** @type {?} */
    RenderService.prototype.localizeService;
    /** @type {?} */
    RenderService.prototype.notifyService;
    /** @type {?} */
    RenderService.prototype.serviceCache;
    /** @type {?} */
    RenderService.prototype.columnCount;
    /** @type {?} */
    RenderService.prototype.operations;
    /** @type {?} */
    RenderService.prototype.renderObject;
    /** @type {?} */
    RenderService.prototype.spread;
    /** @type {?} */
    RenderService.prototype.funcInfoCache;
    /** @type {?} */
    RenderService.prototype.schemaManager;
    /** @type {?} */
    RenderService.prototype.lcpService;
    /**
     * @type {?}
     * @private
     */
    RenderService.prototype.cache;
    /**
     * @type {?}
     * @private
     */
    RenderService.prototype.loadService;
    /**
     * @type {?}
     * @private
     */
    RenderService.prototype.msgService;
    /**
     * @type {?}
     * @private
     */
    RenderService.prototype.dataRenderExtendService;
    /**
     * @type {?}
     * @private
     */
    RenderService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcWRwL3NwcmVhZC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlL3JlbmRlci9yZW5kZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFnQixNQUFNLGVBQWUsQ0FBQztBQUM3RSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsVUFBVSxFQUF5RCxNQUFNLGFBQWEsQ0FBQztBQUd0SCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxhQUFhLEVBQWlCLE1BQU0sbUJBQW1CLENBQUM7QUFDakUsT0FBTyxFQUFFLHVCQUF1QixFQUFZLE1BQU0sYUFBYSxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDMUMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNoRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRTFELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFVMUQsTUFBTSxPQUFPLGFBQWE7Ozs7Ozs7Ozs7SUFleEIsWUFDUyxhQUFtQyxFQUNuQyxVQUFzQixFQUNyQixLQUFtQixFQUNuQixXQUEyQixFQUMzQixVQUEyQixFQUNmLHVCQUFnRCxFQUNoRCxRQUFr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QUFDLEVBQUUsS0FBSyxNQUFNLEVBQUM7UUFDOUUsSUFBSSxLQUFLLElBQUksQ0FBQyxFQUFFO1lBQ2QsSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztTQUNwRDtJQUNILENBQUM7OztZQXZURixVQUFVOzs7O1lBeEJGLG9CQUFvQjtZQUFFLFVBQVU7WUFHaEMsWUFBWTtZQUNaLGNBQWM7WUFLZCxlQUFlO1lBSGYsdUJBQXVCLHVCQXdDM0IsUUFBUTtZQS9DUSxRQUFRLHVCQWdEeEIsUUFBUTs7OztJQXJCWCwwQ0FBcUM7O0lBQ3JDLHlDQUFzQjs7SUFDdEIsd0NBQWlDOztJQUNqQyxzQ0FBNkI7O0lBQzdCLHFDQUFrQjs7SUFDbEIsb0NBQWdCOztJQUNoQixtQ0FBZ0I7O0lBQ2hCLHFDQUFrQjs7SUFDbEIsK0JBQVk7O0lBQ1osc0NBR0M7O0lBR0Msc0NBQTBDOztJQUMxQyxtQ0FBNkI7Ozs7O0lBQzdCLDhCQUEyQjs7Ozs7SUFDM0Isb0NBQW1DOzs7OztJQUNuQyxtQ0FBbUM7Ozs7O0lBQ25DLGdEQUFvRTs7Ozs7SUFDcEUsaUNBQXNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIE9wdGlvbmFsLCBFdmVudEVtaXR0ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgU2NoZW1hTWFuYWdlclNlcnZpY2UsIExjcFNlcnZpY2UsIFBhcmFzTWFwcGluZ01hbmFnZXJTZXJ2aWNlLCBKb2ludFNlYXJjaE1hbmFnZXJTZXJ2aWNlIH0gZnJvbSAnQHFkcC9jb21tb24nO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IENhY2hlU2VydmljZSB9IGZyb20gJ0BlY3AtY2FmL2NhZi1jb21tb24nO1xyXG5pbXBvcnQgeyBMb2FkaW5nU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbG9hZGluZyc7XHJcbmltcG9ydCB7IE5vdGlmeVNlcnZpY2UsIE5vdGlmeU9wdGlvbnMgfSBmcm9tICdAZmFycmlzL3VpLW5vdGlmeSc7XHJcbmltcG9ydCB7IERhdGFSZW5kZXJFeHRlbmRTZXJ2aWNlLCBFdmVudEJ1cyB9IGZyb20gJ0BxZHAvY29tbW9uJztcclxuaW1wb3J0IHsgUnRmU2VydmljZXMgfSBmcm9tICdAcWRwL2NvbW1vbic7XHJcbmltcG9ydCB7IExvY2FsaXplU2VydmljZSB9IGZyb20gJ0BxZHAvbG9jYWxpemUnO1xyXG5pbXBvcnQgeyBNZXNzYWdlclNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLW1lc3NhZ2VyJztcclxuaW1wb3J0IHsgRm9ybUVycm9yU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcyc7XHJcbmltcG9ydCB7IENsb3VkcHJpbnRTZXJ2aWNlIH0gZnJvbSAnQGdzcC1zdmMvY2xvdWRwcmludCc7XHJcbmltcG9ydCB7IFNlcnZpY2VzVXRpbHMgfSBmcm9tICcuLi8uLi91dGlsL3NlcnZpY2VzLnV0aWxzJztcclxuaW1wb3J0IHsgUmVuZGVyT3B0aW9uIH0gZnJvbSAnLi4vLi4vZW50aXR5L1JlbmRlck9wdGlvbic7XHJcbmltcG9ydCB7IENyb3NzdGFiUmVuZGVyIH0gZnJvbSAnLi4vLi4vZW5naW5lL2Nyb3NzdGFiLXJlbmRlcic7XHJcbmltcG9ydCB7IExpc3RUcmVlUmVuZGVyIH0gZnJvbSAnLi4vLi4vZW5naW5lL2xpc3QtcmVuZGVyJztcclxuXHJcbmRlY2xhcmUgdmFyIEdDOiBhbnk7XHJcbmRlY2xhcmUgdmFyIFRyZWVDZWxsVHlwZTogYW55O1xyXG5kZWNsYXJlIHZhciBNeU51bUZvcm1hdHRlcjogYW55O1xyXG5kZWNsYXJlIHZhciBGaWx0ZXJDZWxsVHlwZTogYW55O1xyXG5kZWNsYXJlIHZhciBnc3BmcmFtZXdvcmtTZXJ2aWNlOiBhbnk7XHJcbmRlY2xhcmUgdmFyIFNvcnRDZWxsVHlwZTogYW55O1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgUmVuZGVyU2VydmljZSB7XHJcbiAgY2xvdWRwcmludFNlcnZpY2U6IENsb3VkcHJpbnRTZXJ2aWNlO1xyXG4gIGZvcm1FcnJvclNlcnZpY2U6IGFueTtcclxuICBsb2NhbGl6ZVNlcnZpY2U6IExvY2FsaXplU2VydmljZTtcclxuICBub3RpZnlTZXJ2aWNlOiBOb3RpZnlTZXJ2aWNlO1xyXG4gIHNlcnZpY2VDYWNoZSA9IHt9O1xyXG4gIGNvbHVtbkNvdW50ID0gMDtcclxuICBvcGVyYXRpb25zID0ge307XHJcbiAgcmVuZGVyT2JqZWN0OiBhbnk7XHJcbiAgc3ByZWFkOiBhbnk7XHJcbiAgZnVuY0luZm9DYWNoZSA9IHtcclxuICAgIGZ1bmNJZHM6IFtdLFxyXG4gICAgZmlyc3RMb2FkQ2FjaGU6IFtdXHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHB1YmxpYyBzY2hlbWFNYW5hZ2VyOiBTY2hlbWFNYW5hZ2VyU2VydmljZSxcclxuICAgIHB1YmxpYyBsY3BTZXJ2aWNlOiBMY3BTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBjYWNoZTogQ2FjaGVTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBsb2FkU2VydmljZTogTG9hZGluZ1NlcnZpY2UsXHJcbiAgICBwcml2YXRlIG1zZ1NlcnZpY2U6IE1lc3NhZ2VyU2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZGF0YVJlbmRlckV4dGVuZFNlcnZpY2U6IERhdGFSZW5kZXJFeHRlbmRTZXJ2aWNlLFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3JcclxuICApIHtcclxuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgaWYgKHRoaXMuaW5qZWN0b3IpIHtcclxuICAgICAgdGhpcy5sb2NhbGl6ZVNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChMb2NhbGl6ZVNlcnZpY2UpO1xyXG4gICAgICB0aGlzLmZvcm1FcnJvclNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChGb3JtRXJyb3JTZXJ2aWNlKTtcclxuICAgICAgdGhpcy5jbG91ZHByaW50U2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KENsb3VkcHJpbnRTZXJ2aWNlKTtcclxuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQoTm90aWZ5U2VydmljZSk7XHJcbiAgICAgIHRoaXMuc2V0U2VydmljZSgpO1xyXG4gICAgICBzZWxmLnNjaGVtYU1hbmFnZXIub3BlcmF0aW9uQ2hhbmdlLnN1YnNjcmliZSgodmFsdWU6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgICAgc2VsZi5vcGVyYXRpb25zID0gdmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgICBzZWxmLnNldFNlY3VyaXR5TGV2ZWwoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2V0U2VydmljZSgpIHtcclxuICAgIGNvbnN0IHRhYklkID0gUnRmU2VydmljZXMuZ2V0VGFiSWQoKSB8fCAnZGVmYXVsdCc7XHJcbiAgICB0aGlzLnNlcnZpY2VDYWNoZVt0YWJJZF0gPSB7XHJcbiAgICAgICdmb3JtRXJyb3JTZXJ2aWNlJzogdGhpcy5mb3JtRXJyb3JTZXJ2aWNlLFxyXG4gICAgICAnY2xvdWRwcmludFNlcnZpY2UnOiB0aGlzLmNsb3VkcHJpbnRTZXJ2aWNlLFxyXG4gICAgICAnc2NoZW1hTWFuYWdlclNlcnZpY2UnOiB0aGlzLnNjaGVtYU1hbmFnZXIsXHJcbiAgICAgICdsY3BTZXJ2aWNlJzogdGhpcy5sY3BTZXJ2aWNlLFxyXG4gICAgICAnY2FjaGVTZXJ2aWNlJzogdGhpcy5jYWNoZSxcclxuICAgICAgJ2xvYWRpbmdTZXJ2aWNlJzogdGhpcy5sb2FkU2VydmljZSxcclxuICAgICAgJ21zZ1NlcnZpY2UnOiB0aGlzLm1zZ1NlcnZpY2UsXHJcbiAgICAgICdsb2NhbGl6ZVNlcnZpY2UnOiB0aGlzLmxvY2FsaXplU2VydmljZSxcclxuICAgICAgJ25vdGlmeVNlcnZpY2UnOiB0aGlzLm5vdGlmeVNlcnZpY2VcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldFNlcnZpY2UoKSB7XHJcbiAgICBjb25zdCB0YWJJZCA9IFJ0ZlNlcnZpY2VzLmdldFRhYklkKCkgfHwgJ2RlZmF1bHQnO1xyXG4gICAgcmV0dXJuIHRoaXMuc2VydmljZUNhY2hlW3RhYklkXTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2V0U2VjdXJpdHlMZXZlbCgpIHtcclxuICAgIHRoaXMubGNwU2VydmljZS52YXJpYWJsZXNDaGFuZ2Uuc3Vic2NyaWJlKChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgaWYgKGRhdGEgJiYgZGF0YS5oYXNPd25Qcm9wZXJ0eSgnc2VjdXJpdHlMZXZlbCcpICYmIGRhdGFbJ3NlY3VyaXR5TGV2ZWwnXSkge1xyXG4gICAgICAgIHRoaXMuY2FjaGUuc2V0KFJ0ZlNlcnZpY2VzLmdldFRhYklkKCkgKyAnc2VjdXJpdHlMZXZlbCcsIGRhdGFbJ3NlY3VyaXR5TGV2ZWwnXSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRTZWN1cml0eUxldmVsKCkge1xyXG4gICAgaWYgKHRoaXMuY2FjaGUuZ2V0KFJ0ZlNlcnZpY2VzLmdldFRhYklkKCkgKyAnc2VjdXJpdHlMZXZlbCcpKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmNhY2hlLmdldChSdGZTZXJ2aWNlcy5nZXRUYWJJZCgpICsgJ3NlY3VyaXR5TGV2ZWwnKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJlbmRlcihvcHRpb246IFJlbmRlck9wdGlvbikge1xyXG4gICAgaWYgKCFvcHRpb24ubG9hZGluZykge1xyXG4gICAgICBvcHRpb24ubG9hZGluZyA9IHRoaXMubG9hZFNlcnZpY2Uuc2hvdyh7IGNvbnRhaW5lcjogJ2JvZHknIH0pO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zcHJlYWQgPSBvcHRpb24uc3ByZWFkID8gb3B0aW9uLnNwcmVhZCA6IG51bGw7XHJcbiAgICB0aGlzLnJlbmRlck9iamVjdCA9IHRoaXMuZ2V0UmVuZGVyKG9wdGlvbik7XHJcbiAgICB0aGlzLnJlbmRlck9iamVjdC5yZW5kZXIob3B0aW9uKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0UmVuZGVyKG9iajogUmVuZGVyT3B0aW9uKSB7XHJcbiAgICB0aGlzLnNldFNlcnZpY2UoKTtcclxuICAgIFNlcnZpY2VzVXRpbHMuc2V0U2VydmljZXMoJ2RhdGFSZW5kZXJFeHRlbmRTZXJ2aWNlJyArIG9iai5xdWVyeUlkLCB0aGlzLmRhdGFSZW5kZXJFeHRlbmRTZXJ2aWNlKTtcclxuICAgIGxldCByZW5kZXI7XHJcbiAgICBzd2l0Y2ggKG9iai5jb250cm9sVHlwZSkge1xyXG4gICAgICBjYXNlICdjcm9zc3RhYic6XHJcbiAgICAgICAgcmVuZGVyID0gbmV3IENyb3NzdGFiUmVuZGVyKG9iai5xdWVyeUlkLCBvYmouY29udHJvbFR5cGUsIG9iai5qb2ludHNlYXJjaEluZm9MaXN0LCB0aGlzLmZ1bmNJbmZvQ2FjaGUsIHRoaXMuZ2V0U2VydmljZSgpKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgZGVmYXVsdDpcclxuICAgICAgICByZW5kZXIgPSBuZXcgTGlzdFRyZWVSZW5kZXIob2JqLnF1ZXJ5SWQsIG9iai5jb250cm9sVHlwZSwgb2JqLmpvaW50c2VhcmNoSW5mb0xpc3QsIHRoaXMuZnVuY0luZm9DYWNoZSwgdGhpcy5nZXRTZXJ2aWNlKCkpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gICAgcmVuZGVyLmlzU2NoZW1hU2VsZWN0Q2hhbmdlZCA9IG9iai5pc1NjaGVtYVNlbGVjdENoYW5nZWQgPyBvYmouaXNTY2hlbWFTZWxlY3RDaGFuZ2VkIDogZmFsc2U7XHJcbiAgICByZXR1cm4gcmVuZGVyO1xyXG4gIH1cclxuXHJcbiAgZXhwb3J0RGF0YShyZW5kZXJPcHRpb246IFJlbmRlck9wdGlvbikge1xyXG4gIC8vIGV4cG9ydERhdGEocXVlcnlJZDogYW55LCBzY2hlbWFJZDogYW55LCBjb250cm9sVHlwZTogYW55LCBwYWdlSW5kZXg/OiBudW1iZXIsIHFvTWFuYWdlckNvZGU/OiBhbnksIHF1ZXJ5UmVsYXRpdmVVcmw/OiBhbnksIGZpbHRlckNvbmRpdGlvbj86IGFueSwgZ3JvdXBUeXBlPzogYW55LCB2b0lkPzogYW55LCB0b3RhbENvdW50PzogYW55LCBleHBvcnRUeXBlPzogYW55KSB7XHJcbiAgICBjb25zdCBsb2FkaW5nID0gdGhpcy5sb2FkU2VydmljZS5zaG93KHsgY29udGFpbmVyOiAnYm9keScgfSk7XHJcbiAgICB0aGlzLnJlbmRlck9iamVjdC51dGlscy5nZXQoJ3NjaGVtYScpLmdldFNjaGVtYUluZm8oeyBzY2hlbWFJZDogcmVuZGVyT3B0aW9uLnNjaGVtYVZhbHVlLCBxdWVyeUlkOiByZW5kZXJPcHRpb24ucXVlcnlJZCwgcXVlcnlSZWxhdGl2ZVVybDogcmVuZGVyT3B0aW9uLnF1ZXJ5UmVsYXRpdmVVcmwsIGdyb3VwVHlwZTogcmVuZGVyT3B0aW9uLmdyb3VwVHlwZSB9KS5zdWJzY3JpYmUodmFsdWUgPT4ge1xyXG4gICAgICByZW5kZXJPcHRpb24uc2NoZW1hSWQgPSByZW5kZXJPcHRpb24uc2NoZW1hSWQgPyByZW5kZXJPcHRpb24uc2NoZW1hSWQgOiAodmFsdWUgJiYgdmFsdWUuaWQgPyB2YWx1ZS5pZCA6ICcxJyk7XHJcbiAgICAgIGxldCBzY2hlbWFOYW1lID0gdmFsdWUgJiYgdmFsdWUuc2NoZW1hVmFsdWUgJiYgdmFsdWUuc2NoZW1hVmFsdWUudGl0bGVPcHRpb24gJiYgdmFsdWUuc2NoZW1hVmFsdWUudGl0bGVPcHRpb24udGl0bGVcclxuICAgICAgICA/IHZhbHVlLnNjaGVtYVZhbHVlLnRpdGxlT3B0aW9uLnRpdGxlXHJcbiAgICAgICAgOiB2YWx1ZSAmJiB2YWx1ZS5zY2hlbWFOYW1lXHJcbiAgICAgICAgICA/IHZhbHVlLnNjaGVtYU5hbWVcclxuICAgICAgICAgIDogJyc7XHJcbiAgICAgIGlmIChSdGZTZXJ2aWNlcy5nZXRGdW5jTmFtZSgpKSB7XHJcbiAgICAgICAgc2NoZW1hTmFtZSA9IFJ0ZlNlcnZpY2VzLmdldEZ1bmNOYW1lKCkgKyAnLScgKyBzY2hlbWFOYW1lO1xyXG4gICAgICB9XHJcbiAgICAgIHJlbmRlck9wdGlvbi5leGNlbEV4cG9ydE5hbWUgPSBzY2hlbWFOYW1lO1xyXG4gICAgICBjb25zdCBwYXJhbXMgPSB0aGlzLnJlbmRlck9iamVjdC51dGlscy5nZXQoJ3BhcmFtZXRlcicpLmNyZWF0ZVBhcmFtZXRlcnMocmVuZGVyT3B0aW9uKTtcclxuICAgICAgcGFyYW1zWydleHBvcnRUeXBlJ10gPSByZW5kZXJPcHRpb24uZXhwb3J0VHlwZSA/IHJlbmRlck9wdGlvbi5leHBvcnRUeXBlIDogJyc7XHJcbiAgICAgIGxldCBpc0N1c3RvbVNoZW1hID0gZmFsc2U7XHJcbiAgICAgIGxldCBjdXN0b21TY2hlbWEgPSBudWxsO1xyXG4gICAgICBpZiAocGFyYW1zWydzY2hlbWFJZCddID09PSAnMScpIHtcclxuICAgICAgICBpZiAoU2VydmljZXNVdGlscy5nZXRTZXJ2aWNlcyhSdGZTZXJ2aWNlcy5nZXRUYWJJZChyZW5kZXJPcHRpb24ucXVlcnlJZCkgKyAnY3VzdG9tU2NoZW1lJykpIHtcclxuICAgICAgICAgIGlzQ3VzdG9tU2hlbWEgPSB0cnVlO1xyXG4gICAgICAgICAgcGFyYW1zLmN1c3RvbVNjaGVtYSA9IFNlcnZpY2VzVXRpbHMuZ2V0U2VydmljZXMoUnRmU2VydmljZXMuZ2V0VGFiSWQocmVuZGVyT3B0aW9uLnF1ZXJ5SWQpICsgJ2N1c3RvbVNjaGVtZScpO1xyXG4gICAgICAgICAgY3VzdG9tU2NoZW1hID0gSlNPTi5wYXJzZShwYXJhbXMuY3VzdG9tU2NoZW1hKTtcclxuICAgICAgICAgIGlmICghcGFyYW1zLmV4Y2VsRXhwb3J0TmFtZSkge1xyXG4gICAgICAgICAgICBwYXJhbXMuZXhjZWxFeHBvcnROYW1lID0gY3VzdG9tU2NoZW1hICYmIGN1c3RvbVNjaGVtYS50aXRsZU9wdGlvbiAmJiBjdXN0b21TY2hlbWEudGl0bGVPcHRpb24udGl0bGVcclxuICAgICAgICAgICAgICA/IGN1c3RvbVNjaGVtYS50aXRsZU9wdGlvbi50aXRsZSA6ICdleHBvcnQnXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMubXNnU2VydmljZS53YXJuaW5nKHRoaXMubG9jYWxpemVTZXJ2aWNlLmdldFZhbHVlKCdzcHJlYWQubWVzc2FnZS5leHBvcnQnKSk7XHJcbiAgICAgICAgICBsb2FkaW5nLmNsb3NlKCk7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGlmICh0aGlzLm9wZXJhdGlvbnNbJ1FkcFF1ZXJ5RXhwb3J0J10gPT09IGZhbHNlKSB7XHJcbiAgICAgICAgdGhpcy5tc2dTZXJ2aWNlLndhcm5pbmcodGhpcy5sb2NhbGl6ZVNlcnZpY2UuZ2V0VmFsdWUoJ3NwcmVhZC5tZXNzYWdlLnZhbGlkYXRlLnFkcFF1ZXJ5RXhwb3J0JykpO1xyXG4gICAgICAgIGxvYWRpbmcuY2xvc2UoKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgaWYgKHJlbmRlck9wdGlvbi5jb250cm9sVHlwZSA9PT0gJ3RyZWVsaXN0JyAmJiB0aGlzLnNwcmVhZCkge1xyXG4gICAgICAgICAgbGV0IGV4cGFuZE5vZGVzID0gJyc7XHJcbiAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUuc2NoZW1hVmFsdWUgJiYgdmFsdWUuc2NoZW1hVmFsdWUub3RoZXJPcHRpb24gJiYgdmFsdWUuc2NoZW1hVmFsdWUub3RoZXJPcHRpb24udHJlZUluZm9UeXBlICE9PSAyKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhdGhGaWVsZCA9IHZhbHVlLnNjaGVtYVZhbHVlLm90aGVyT3B0aW9uLnRyZWVJbmZvVHlwZSA9PT0gMCA/IHZhbHVlLnNjaGVtYVZhbHVlLm90aGVyT3B0aW9uLnBhdGhGaWVsZCA6IHZhbHVlLnNjaGVtYVZhbHVlLm90aGVyT3B0aW9uLmlkRmllbGQ7XHJcbiAgICAgICAgICAgIGlmIChwYXRoRmllbGQpIHtcclxuICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc3ByZWFkLmdldEFjdGl2ZVNoZWV0KCkuZ2V0Um93Q291bnQoKTsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zcHJlYWQuZ2V0QWN0aXZlU2hlZXQoKS5yb3dPdXRsaW5lcy5pc0NvbGxhcHNlZChpKSkge1xyXG4gICAgICAgICAgICAgICAgICBleHBhbmROb2RlcyArPSAnLCcgKyB0aGlzLnNwcmVhZC5nZXRBY3RpdmVTaGVldCgpLmdldERhdGFJdGVtKGkpW3BhdGhGaWVsZF07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIHBhcmFtc1snZXhwYW5kTm9kZXMnXSA9IGV4cGFuZE5vZGVzLnN1YnN0cmluZygxKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLmNvbHVtbkNvdW50ID0gMDtcclxuICAgICAgaWYgKCFpc0N1c3RvbVNoZW1hKSB7XHJcbiAgICAgICAgdGhpcy5jYWxjdWxhdGlvbkNvbHVtbkNvdW50KHZhbHVlLnNjaGVtYVZhbHVlLmNvbHVtbk9wdGlvbi5jb2xMaXN0KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoY3VzdG9tU2NoZW1hICYmIGN1c3RvbVNjaGVtYS5jb2x1bW5PcHRpb24gJiYgY3VzdG9tU2NoZW1hLmNvbHVtbk9wdGlvbi5jb2xMaXN0KSB7XHJcbiAgICAgICAgICB0aGlzLmNhbGN1bGF0aW9uQ29sdW1uQ291bnQoY3VzdG9tU2NoZW1hLmNvbHVtbk9wdGlvbi5jb2xMaXN0KTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5sY3BTZXJ2aWNlLmxvYWRpbmcgPSBsb2FkaW5nO1xyXG4gICAgICBpZiAodGhpcy5nZXRTZWN1cml0eUxldmVsKCkpIHtcclxuICAgICAgICBwYXJhbXMuZXhjZWxFeHBvcnROYW1lICs9ICdfJyArIHRoaXMuZ2V0U2VjdXJpdHlMZXZlbCgpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICgodGhpcy5jb2x1bW5Db3VudCAqIHJlbmRlck9wdGlvbi50b3RhbENvdW50KSA8IDEwMDAwMCkge1xyXG4gICAgICAgIHRoaXMubGNwU2VydmljZS5leHBvcnREYXRhKHBhcmFtcywgcmVuZGVyT3B0aW9uLnF1ZXJ5UmVsYXRpdmVVcmwpO1xyXG4gICAgICAgIGxvYWRpbmcuY2xvc2UoKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLmxjcFNlcnZpY2UuYXlzbkV4cG9ydERhdGEocGFyYW1zLCByZW5kZXJPcHRpb24ucXVlcnlSZWxhdGl2ZVVybCk7XHJcbiAgICAgICAgbG9hZGluZy5jbG9zZSgpO1xyXG4gICAgICAgIHRoaXMubXNnU2VydmljZS53YXJuaW5nKHRoaXMubG9jYWxpemVTZXJ2aWNlLmdldFZhbHVlKCdzcHJlYWQubWVzc2FnZS5heXNuRXhwb3J0JykpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2FsY3VsYXRpb25Db2x1bW5Db3VudChjb2xMaXN0OiBhbnkpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbExpc3QuZm9yRWFjaCgoaXRlbTogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKGl0ZW0uY2hpbGRMaXN0ICYmIGl0ZW0uY2hpbGRMaXN0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgdGhpcy5jYWxjdWxhdGlvbkNvbHVtbkNvdW50KGl0ZW0uY2hpbGRMaXN0KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5jb2x1bW5Db3VudCArPSAxO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlKSB7IHRoaXMuY29sdW1uQ291bnQgPSAwOyB9XHJcbiAgfVxyXG5cclxuICBjbGVhckNhY2hlKHF1ZXJ5SWQ6IGFueSwgc2NoZW1hSWQ6IGFueSwgY29udHJvbFR5cGU6IGFueSwgcW9NYW5hZ2VyQ29kZT86IGFueSwgcXVlcnlSZWxhdGl2ZVVybD86IGFueSwgZmlsdGVyQ29uZGl0aW9uPzogYW55LCBncm91cFR5cGU/OiBhbnksIHZvSWQ/OiBhbnkpIHtcclxuICAgIHRoaXMucmVuZGVyT2JqZWN0LnV0aWxzLmdldCgnc2NoZW1hJykuZ2V0U2NoZW1hSW5mbyh7IHNjaGVtYUlkLCBxdWVyeUlkLCBxdWVyeVJlbGF0aXZlVXJsLCBncm91cFR5cGUgfSkuc3Vic2NyaWJlKHZhbHVlID0+IHtcclxuICAgICAgc2NoZW1hSWQgPSBzY2hlbWFJZCA/IHNjaGVtYUlkIDogKHZhbHVlICYmIHZhbHVlLmlkID8gdmFsdWUuaWQgOiAnMScpO1xyXG4gICAgICBjb25zdCBzY2hlbWFOYW1lID0gdmFsdWUgJiYgdmFsdWUuc2NoZW1hVmFsdWUgJiYgdmFsdWUuc2NoZW1hVmFsdWUudGl0bGVPcHRpb24gJiYgdmFsdWUuc2NoZW1hVmFsdWUudGl0bGVPcHRpb24udGl0bGVcclxuICAgICAgICA/IHZhbHVlLnNjaGVtYVZhbHVlLnRpdGxlT3B0aW9uLnRpdGxlXHJcbiAgICAgICAgOiB2YWx1ZSAmJiB2YWx1ZS5zY2hlbWFOYW1lXHJcbiAgICAgICAgICA/IHZhbHVlLnNjaGVtYU5hbWVcclxuICAgICAgICAgIDogJyc7XHJcbiAgICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMucmVuZGVyT2JqZWN0LnV0aWxzLmdldCgncGFyYW1ldGVyJykuY3JlYXRlUGFyYW1ldGVycyh7XHJcbiAgICAgICAgcXVlcnlJZCxcclxuICAgICAgICBjb250cm9sVHlwZSxcclxuICAgICAgICBzY2hlbWFJZCxcclxuICAgICAgICBxb01hbmFnZXJDb2RlLFxyXG4gICAgICAgIHBhZ2VJbmRleDogMCxcclxuICAgICAgICBwYWdlU2l6ZTogMCxcclxuICAgICAgICBleGNlbEV4cG9ydE5hbWU6IHNjaGVtYU5hbWUsXHJcbiAgICAgICAgZmlsdGVyQ29uZGl0aW9uLFxyXG4gICAgICAgIHZvSWRcclxuICAgICAgfSk7XHJcbiAgICAgIGlmIChTZXJ2aWNlc1V0aWxzLmdldFNlcnZpY2VzKFJ0ZlNlcnZpY2VzLmdldFRhYklkKHF1ZXJ5SWQpICsgJ2N1c3RvbVNjaGVtZScpKSB7XHJcbiAgICAgICAgcGFyYW1zLmN1c3RvbVNjaGVtYSA9IFNlcnZpY2VzVXRpbHMuZ2V0U2VydmljZXMoUnRmU2VydmljZXMuZ2V0VGFiSWQocXVlcnlJZCkgKyAnY3VzdG9tU2NoZW1lJyk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5sY3BTZXJ2aWNlLmNsZWFyQ2FjaGUocGFyYW1zKS5zdWJzY3JpYmUoZGF0YSA9PiB7XHJcbiAgICAgICAgaWYgKGRhdGEpIHtcclxuICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZVsnc3VjY2VzcyddKHtcclxuICAgICAgICAgICAgdGl0bGU6IHRoaXMubG9jYWxpemVTZXJ2aWNlLmdldFZhbHVlKCdpZGVDbXAuc2NoZW1hTWFuYWdlci5tZXNzYWdlLmluZm8udGl0bGUnKSwgbXNnOiB0aGlzLmxvY2FsaXplU2VydmljZS5nZXRWYWx1ZSgnc3ByZWFkLm1lc3NhZ2UuY2xlYXJDYWNoZScpLCB0aW1lb3V0OiAzMDAwXHJcbiAgICAgICAgICB9IGFzIE5vdGlmeU9wdGlvbnMpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHBkZkV4cG9ydEV2ZW50KHJlbmRlck9wdGlvbjogUmVuZGVyT3B0aW9uKSB7XHJcbiAgLy8gcGRmRXhwb3J0RXZlbnQocXVlcnlJZDogYW55LCBzY2hlbWFJZDogYW55LCBjb250cm9sVHlwZTogYW55LCBxb01hbmFnZXJDb2RlPzogYW55LCBwcmludEludGVncmF0aW9uPzogYW55LCBxdWVyeVJlbGF0aXZlVXJsPzogYW55LCBmaWx0ZXJDb25kaXRpb24/OiBhbnksIGdyb3VwVHlwZT86IGFueSwgcGFnZUluZGV4PzogYW55LCB2b0lkPzogYW55KSB7XHJcbiAgICBjb25zdCBsb2FkaW5nID0gdGhpcy5sb2FkU2VydmljZS5zaG93KHsgY29udGFpbmVyOiAnYm9keScgfSk7XHJcbiAgICB0cnkge1xyXG4gICAgICB0aGlzLnJlbmRlck9iamVjdC51dGlscy5nZXQoJ3NjaGVtYScpLmdldFNjaGVtYUluZm8oeyBzY2hlbWFJZDogcmVuZGVyT3B0aW9uLnNjaGVtYVZhbHVlLCBxdWVyeUlkOiByZW5kZXJPcHRpb24ucXVlcnlJZCwgcXVlcnlSZWxhdGl2ZVVybDogcmVuZGVyT3B0aW9uLnF1ZXJ5UmVsYXRpdmVVcmwsIGdyb3VwVHlwZTogcmVuZGVyT3B0aW9uLmdyb3VwVHlwZSB9KS5zdWJzY3JpYmUodmFsdWUgPT4ge1xyXG4gICAgICAgIHJlbmRlck9wdGlvbi5zY2hlbWFJZCA9IHJlbmRlck9wdGlvbi5zY2hlbWFJZCA/IHJlbmRlck9wdGlvbi5zY2hlbWFJZCA6ICh2YWx1ZSAmJiB2YWx1ZS5pZCA/IHZhbHVlLmlkIDogJzEnKTtcclxuICAgICAgICBsZXQgc2NoZW1hTmFtZSA9IHZhbHVlICYmIHZhbHVlLnNjaGVtYVZhbHVlICYmIHZhbHVlLnNjaGVtYVZhbHVlLnRpdGxlT3B0aW9uICYmIHZhbHVlLnNjaGVtYVZhbHVlLnRpdGxlT3B0aW9uLnRpdGxlXHJcbiAgICAgICAgICA/IHZhbHVlLnNjaGVtYVZhbHVlLnRpdGxlT3B0aW9uLnRpdGxlXHJcbiAgICAgICAgICA6IHZhbHVlICYmIHZhbHVlLnNjaGVtYU5hbWVcclxuICAgICAgICAgICAgPyB2YWx1ZS5zY2hlbWFOYW1lXHJcbiAgICAgICAgICAgIDogJyc7XHJcbiAgICAgICAgaWYgKFJ0ZlNlcnZpY2VzLmdldEZ1bmNOYW1lKCkpIHtcclxuICAgICAgICAgIHNjaGVtYU5hbWUgPSBSdGZTZXJ2aWNlcy5nZXRGdW5jTmFtZSgpICsgJy0nICsgc2NoZW1hTmFtZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmVuZGVyT3B0aW9uLmV4Y2VsRXhwb3J0TmFtZSA9IHNjaGVtYU5hbWU7XHJcbiAgICAgICAgY29uc3QgcGFyYW1zID0gdGhpcy5yZW5kZXJPYmplY3QudXRpbHMuZ2V0KCdwYXJhbWV0ZXInKS5jcmVhdGVQYXJhbWV0ZXJzKHJlbmRlck9wdGlvbik7XHJcbiAgICAgICAgaWYgKHBhcmFtc1snc2NoZW1hSWQnXSA9PT0gJzEnKSB7XHJcbiAgICAgICAgICBpZiAoU2VydmljZXNVdGlscy5nZXRTZXJ2aWNlcyhSdGZTZXJ2aWNlcy5nZXRUYWJJZChyZW5kZXJPcHRpb24ucXVlcnlJZCkgKyAnY3VzdG9tU2NoZW1lJykpIHtcclxuICAgICAgICAgICAgcGFyYW1zLmN1c3RvbVNjaGVtYSA9IFNlcnZpY2VzVXRpbHMuZ2V0U2VydmljZXMoUnRmU2VydmljZXMuZ2V0VGFiSWQocmVuZGVyT3B0aW9uLnF1ZXJ5SWQpICsgJ2N1c3RvbVNjaGVtZScpO1xyXG4gICAgICAgICAgICBjb25zdCBjdXN0b21TY2hlbWEgPSBKU09OLnBhcnNlKHBhcmFtcy5jdXN0b21TY2hlbWEpO1xyXG4gICAgICAgICAgICBpZiAoIXBhcmFtcy5leGNlbEV4cG9ydE5hbWUpIHtcclxuICAgICAgICAgICAgICBwYXJhbXMuZXhjZWxFeHBvcnROYW1lID0gY3VzdG9tU2NoZW1hICYmIGN1c3RvbVNjaGVtYS50aXRsZU9wdGlvbiAmJiBjdXN0b21TY2hlbWEudGl0bGVPcHRpb24udGl0bGVcclxuICAgICAgICAgICAgICAgID8gY3VzdG9tU2NoZW1hLnRpdGxlT3B0aW9uLnRpdGxlIDogJ2V4cG9ydCdcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5tc2dTZXJ2aWNlLndhcm5pbmcodGhpcy5sb2NhbGl6ZVNlcnZpY2UuZ2V0VmFsdWUoJ3NwcmVhZC5tZXNzYWdlLnByaW50JykpO1xyXG4gICAgICAgICAgICBsb2FkaW5nLmNsb3NlKCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMub3BlcmF0aW9uc1snUWRwUXVlcnlQcmludCddID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgdGhpcy5tc2dTZXJ2aWNlLndhcm5pbmcodGhpcy5sb2NhbGl6ZVNlcnZpY2UuZ2V0VmFsdWUoJ3NwcmVhZC5tZXNzYWdlLnZhbGlkYXRlLnFkcFF1ZXJ5UHJpbnQnKSk7XHJcbiAgICAgICAgICBsb2FkaW5nLmNsb3NlKCk7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmdldFNlY3VyaXR5TGV2ZWwoKSkge1xyXG4gICAgICAgICAgcGFyYW1zLmV4Y2VsRXhwb3J0TmFtZSArPSAnXycgKyB0aGlzLmdldFNlY3VyaXR5TGV2ZWwoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5sY3BTZXJ2aWNlLnBkZkV4cG9ydEV2ZW50KHBhcmFtcywgcmVuZGVyT3B0aW9uLnF1ZXJ5UmVsYXRpdmVVcmwpO1xyXG4gICAgICAgIGxvYWRpbmcuY2xvc2UoKTtcclxuICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgIGxvYWRpbmcuY2xvc2UoKTtcclxuICAgICAgLy8gY29uc29sZS5sb2coZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcmludFByZVZpZXcocmVuZGVyT3B0aW9uOiBSZW5kZXJPcHRpb24pIHtcclxuICAvLyBwcmludFByZVZpZXcocXVlcnlJZDogYW55LCBzY2hlbWFJZDogYW55LCBjb250cm9sVHlwZTogYW55LCBxb01hbmFnZXJDb2RlPzogYW55LCBwcmludEludGVncmF0aW9uPzogYW55LCBxdWVyeVJlbGF0aXZlVXJsPzogYW55LCBmaWx0ZXJDb25kaXRpb24/OiBhbnksIGdyb3VwVHlwZT86IGFueSwgcGFnZUluZGV4PzogYW55LCB2b0lkPzogYW55KSB7XHJcbiAgICB0aGlzLnJlbmRlck9iamVjdC51dGlscy5nZXQoJ3NjaGVtYScpLmdldFNjaGVtYUluZm8oeyBzY2hlbWFJZDogcmVuZGVyT3B0aW9uLnNjaGVtYVZhbHVlLCBxdWVyeUlkOiByZW5kZXJPcHRpb24ucXVlcnlJZCwgcXVlcnlSZWxhdGl2ZVVybDogcmVuZGVyT3B0aW9uLnF1ZXJ5UmVsYXRpdmVVcmwsIGdyb3VwVHlwZTogcmVuZGVyT3B0aW9uLmdyb3VwVHlwZSB9KS5zdWJzY3JpYmUodmFsdWUgPT4ge1xyXG4gICAgICByZW5kZXJPcHRpb24uc2NoZW1hSWQgPSByZW5kZXJPcHRpb24uc2NoZW1hSWQgPyByZW5kZXJPcHRpb24uc2NoZW1hSWQgOiAodmFsdWUgJiYgdmFsdWUuaWQgPyB2YWx1ZS5pZCA6ICcxJyk7XHJcbiAgICAgIGNvbnN0IHNjaGVtYU5hbWUgPSB2YWx1ZSAmJiB2YWx1ZS5zY2hlbWFWYWx1ZSAmJiB2YWx1ZS5zY2hlbWFWYWx1ZS50aXRsZU9wdGlvbiAmJiB2YWx1ZS5zY2hlbWFWYWx1ZS50aXRsZU9wdGlvbi50aXRsZVxyXG4gICAgICAgID8gdmFsdWUuc2NoZW1hVmFsdWUudGl0bGVPcHRpb24udGl0bGVcclxuICAgICAgICA6IHZhbHVlICYmIHZhbHVlLnNjaGVtYU5hbWVcclxuICAgICAgICAgID8gdmFsdWUuc2NoZW1hTmFtZVxyXG4gICAgICAgICAgOiAnJztcclxuICAgICAgcmVuZGVyT3B0aW9uLmV4Y2VsRXhwb3J0TmFtZSA9IHNjaGVtYU5hbWU7XHJcbiAgICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMucmVuZGVyT2JqZWN0LnV0aWxzLmdldCgncGFyYW1ldGVyJykuY3JlYXRlUGFyYW1ldGVycyhyZW5kZXJPcHRpb24pO1xyXG4gICAgICBpZiAocGFyYW1zWydzY2hlbWFJZCddID09PSAnMScpIHtcclxuICAgICAgICBpZiAoU2VydmljZXNVdGlscy5nZXRTZXJ2aWNlcyhSdGZTZXJ2aWNlcy5nZXRUYWJJZChyZW5kZXJPcHRpb24ucXVlcnlJZCkgKyAnY3VzdG9tU2NoZW1lJykpIHtcclxuICAgICAgICAgIHBhcmFtcy5jdXN0b21TY2hlbWEgPSBTZXJ2aWNlc1V0aWxzLmdldFNlcnZpY2VzKFJ0ZlNlcnZpY2VzLmdldFRhYklkKHJlbmRlck9wdGlvbi5xdWVyeUlkKSArICdjdXN0b21TY2hlbWUnKTtcclxuICAgICAgICAgIGNvbnN0IGN1c3RvbVNjaGVtYSA9IEpTT04ucGFyc2UocGFyYW1zLmN1c3RvbVNjaGVtYSk7XHJcbiAgICAgICAgICBpZiAoIXBhcmFtcy5leGNlbEV4cG9ydE5hbWUpIHtcclxuICAgICAgICAgICAgcGFyYW1zLmV4Y2VsRXhwb3J0TmFtZSA9IGN1c3RvbVNjaGVtYSAmJiBjdXN0b21TY2hlbWEudGl0bGVPcHRpb24gJiYgY3VzdG9tU2NoZW1hLnRpdGxlT3B0aW9uLnRpdGxlXHJcbiAgICAgICAgICAgICAgPyBjdXN0b21TY2hlbWEudGl0bGVPcHRpb24udGl0bGUgOiAnZXhwb3J0J1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLm1zZ1NlcnZpY2Uud2FybmluZyh0aGlzLmxvY2FsaXplU2VydmljZS5nZXRWYWx1ZSgnc3ByZWFkLm1lc3NhZ2UucHJldmlldycpKTtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHRoaXMuZ2V0U2VjdXJpdHlMZXZlbCgpKSB7XHJcbiAgICAgICAgcGFyYW1zLmV4Y2VsRXhwb3J0TmFtZSArPSAnXycgKyB0aGlzLmdldFNlY3VyaXR5TGV2ZWwoKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLmxjcFNlcnZpY2UuY2xvdWRwcmludFNlcnZpY2UgPSB0aGlzLmNsb3VkcHJpbnRTZXJ2aWNlO1xyXG4gICAgICB0aGlzLmxjcFNlcnZpY2UucHJpbnRQcmVWaWV3KHBhcmFtcywgcmVuZGVyT3B0aW9uLnF1ZXJ5UmVsYXRpdmVVcmwpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBjbGVhckZpcnN0TG9hZENhY2hlKHF1ZXJ5SWQ/OiBhbnkpIHtcclxuICAgIGNvbnN0IGZ1bmNJZCA9IFJ0ZlNlcnZpY2VzLmdldFRhYklkKHF1ZXJ5SWQpO1xyXG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmZ1bmNJbmZvQ2FjaGUuZmlyc3RMb2FkQ2FjaGUuZmluZEluZGV4KGVsID0+IGVsID09PSBmdW5jSWQpO1xyXG4gICAgaWYgKGluZGV4ID49IDApIHtcclxuICAgICAgdGhpcy5mdW5jSW5mb0NhY2hlLmZpcnN0TG9hZENhY2hlLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==