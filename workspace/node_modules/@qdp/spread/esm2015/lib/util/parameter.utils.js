/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { RtfServices } from "@qdp/common";
import { ServicesUtils } from "./services.utils";
export class ParameterUtils {
    /**
     * @param {?=} _queryId
     * @param {?=} _funcInfoCache
     * @param {?=} _serviceCache
     */
    constructor(_queryId, _funcInfoCache, _serviceCache) {
        this.queryId = _queryId;
        this.funcInfoCache = _funcInfoCache;
        this.cache = _serviceCache.cacheService;
    }
    /**
     * 创建参数
     * @param {?} option 参数配置项
     * { queryId: 查询ID, controlType: 查询类型：list  treelist  crosstab, schemaId: 方案ID, qoManagerCode: 查询对象编号, extendCond: 扩展条件, pageIndex: 页索引, pageSize: 分页大小, filterCondition: 结果过滤条件, printIntegration: 打印配置, excelExportName: 导出Excel文件名 }
     * @return {?}
     */
    createParameters(option) {
        /** @type {?} */
        const tabId = this.bindCloseTabEvent();
        /** @type {?} */
        let entityData;
        if (this.cache.get(tabId)) {
            entityData = JSON.stringify(this.cache.get(tabId));
        }
        else if (this.cache.get(option.queryId)) {
            entityData = JSON.stringify(this.cache.get(option.queryId));
        }
        else {
            entityData = JSON.stringify({ 'id': 'undefined_null' });
        }
        /** @type {?} */
        const params = {
            entityData: entityData,
            extendCond: this.cache.get(tabId + 'extendCond') ? this.cache.get(tabId + 'extendCond') : option.extendCond,
            pageIndex: option.pageIndex ? option.pageIndex : 0,
            pageSize: option.pageSize ? option.pageSize : 0,
            schemaId: option.schemaId && option.schemaId !== 'prefab' ? option.schemaId : '1',
            filterCond: option.filterCondition ? option.filterCondition : (this.cache.get(tabId + 'filtercondition') ? this.cache.get(tabId + 'filtercondition') : ''),
            qoManagerCode: option.qoManagerCode ? option.qoManagerCode : '',
            voCode: option.voId ? option.voId : '',
        };
        try {
            /** @type {?} */
            const parameterEntityData = JSON.parse(entityData);
            if (parameterEntityData.hasOwnProperty('@filterExpressionString@')) {
                /** @type {?} */
                const filterExpression = params && params.filterCond ? JSON.parse(params.filterCond) : null;
                if (!filterExpression) {
                    params.filterCond = parameterEntityData['@filterExpressionString@'];
                }
                else {
                    /** @type {?} */
                    const advanceFilterExpression = JSON.parse(parameterEntityData['@filterExpressionString@']);
                    advanceFilterExpression.expressItems = advanceFilterExpression.expressItems.concat(filterExpression.expressItems);
                    params.filterCond = JSON.stringify(advanceFilterExpression);
                }
            }
        }
        catch (e) {
        }
        if (option.controlType) {
            params['controlType'] = option.controlType;
        }
        if (option.excelExportName) {
            params['excelExportName'] = option.excelExportName;
        }
        if (option.printIntegration) {
            params['printIntegration'] = option.printIntegration ? JSON.stringify(option.printIntegration) : '';
        }
        if (option.multiSheets) {
            params['multiSheets'] = option.multiSheets && option.multiSheets.length ? option.multiSheets.join(",") : '';
        }
        if (option.curSheet) {
            params['curSheet'] = option.curSheet;
        }
        if (option.multiSheetsSchemaIds) {
            params['multiSheetsSchemaIds'] = option.multiSheetsSchemaIds ? JSON.stringify(option.multiSheetsSchemaIds) : '';
        }
        if (option.groupType) {
            params['groupType'] = option.groupType ? option.groupType : '';
        }
        if (option.queryId) {
            params['queryId'] = option.queryId ? option.queryId : '';
        }
        if (RtfServices.getMenuParameter('enableQOExtends')) {
            params['enableQOExtends'] = RtfServices.getMenuParameter('enableQOExtends');
            params['qoId'] = ServicesUtils.getServices(RtfServices.getTabId(this.queryId) + 'qoId');
        }
        return params;
    }
    /**
     * 绑定功能菜单关闭事件
     * @return {?}
     */
    bindCloseTabEvent() {
        try {
            /** @type {?} */
            const tab = gspframeworkService.rtf.session.getCommonVariable();
            gspframeworkService.rtf.frmEvent.eventListener('beforeFuncCloseEvent', this.clearParametersCache.bind(this), tab);
            /** @type {?} */
            const index = this.funcInfoCache.funcIds.findIndex((/**
             * @param {?} el
             * @return {?}
             */
            el => el === tab.tabId));
            if (index < 0) {
                this.funcInfoCache.funcIds.push(tab.tabId);
            }
            return tab.tabId + RtfServices.getInSuiteFrmUUID();
        }
        catch (e) {
        }
    }
    /**
     * 清除查询缓存
     * @return {?}
     */
    clearParametersCache() {
        /** @type {?} */
        const tabId = arguments[0].tabId;
        if (this.queryId) {
            this.cache.set(this.queryId, '');
        }
        this.cache.set(tabId, '');
        this.cache.set(tabId + 'renderMode', '');
        /** @type {?} */
        let index = this.funcInfoCache.funcIds.findIndex((/**
         * @param {?} el
         * @return {?}
         */
        el => el === tabId));
        if (index >= 0) {
            this.funcInfoCache.funcIds.splice(index, 1);
            index = this.funcInfoCache.firstLoadCache.findIndex((/**
             * @param {?} el
             * @return {?}
             */
            el => el === tabId));
            if (index >= 0) {
                this.funcInfoCache.firstLoadCache.splice(index, 1);
            }
            gspframeworkService.rtf.func.close(arguments[0]);
        }
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    ParameterUtils.prototype.cache;
    /** @type {?} */
    ParameterUtils.prototype.queryId;
    /** @type {?} */
    ParameterUtils.prototype.funcInfoCache;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyYW1ldGVyLnV0aWxzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHFkcC9zcHJlYWQvIiwic291cmNlcyI6WyJsaWIvdXRpbC9wYXJhbWV0ZXIudXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDMUMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBSWpELE1BQU0sT0FBTyxjQUFjOzs7Ozs7SUFLdkIsWUFBWSxRQUFjLEVBQUUsY0FBb0IsRUFBRSxhQUFtQjtRQUNqRSxJQUFJLENBQUMsT0FBTyxHQUFHLFFBQVEsQ0FBQztRQUN4QixJQUFJLENBQUMsYUFBYSxHQUFHLGNBQWMsQ0FBQztRQUNwQyxJQUFJLENBQUMsS0FBSyxHQUFHLGFBQWEsQ0FBQyxZQUFZLENBQUM7SUFDNUMsQ0FBQzs7Ozs7OztJQVFELGdCQUFnQixDQUFDLE1BQVc7O2NBQ2xCLEtBQUssR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUU7O1lBQ2xDLFVBQWU7UUFDbkIsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUN2QixVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1NBQ3REO2FBQU0sSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDdkMsVUFBVSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7U0FDL0Q7YUFBTTtZQUNILFVBQVUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixFQUFFLENBQUMsQ0FBQztTQUMzRDs7Y0FD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RSxDQUFDLENBQUM7O1lBQ3JDLEtBQUssR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxTQUFTOzs7O1FBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEtBQUssS0FBSyxFQUFDO1FBQ3BFLElBQUksS0FBSyxJQUFJLENBQUMsRUFBRTtZQUNaLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDNUMsS0FBSyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLFNBQVM7Ozs7WUFBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxLQUFLLEVBQUMsQ0FBQztZQUN4RSxJQUFJLEtBQUssSUFBSSxDQUFDLEVBQUU7Z0JBQ1osSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQzthQUN0RDtZQUNELG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3BEO0lBQ0wsQ0FBQztDQUNKOzs7Ozs7SUF2SEcsK0JBQTRCOztJQUM1QixpQ0FBYTs7SUFDYix1Q0FBbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDYWNoZVNlcnZpY2UgfSBmcm9tIFwiQGVjcC1jYWYvY2FmLWNvbW1vblwiO1xyXG5pbXBvcnQgeyBSdGZTZXJ2aWNlcyB9IGZyb20gXCJAcWRwL2NvbW1vblwiO1xyXG5pbXBvcnQgeyBTZXJ2aWNlc1V0aWxzIH0gZnJvbSBcIi4vc2VydmljZXMudXRpbHNcIjtcclxuXHJcbmRlY2xhcmUgdmFyIGdzcGZyYW1ld29ya1NlcnZpY2U6IGFueTtcclxuXHJcbmV4cG9ydCBjbGFzcyBQYXJhbWV0ZXJVdGlscyB7XHJcbiAgICBwcml2YXRlIGNhY2hlOiBDYWNoZVNlcnZpY2U7XHJcbiAgICBxdWVyeUlkOiBhbnk7XHJcbiAgICBmdW5jSW5mb0NhY2hlOiBhbnk7XHJcblxyXG4gICAgY29uc3RydWN0b3IoX3F1ZXJ5SWQ/OiBhbnksIF9mdW5jSW5mb0NhY2hlPzogYW55LCBfc2VydmljZUNhY2hlPzogYW55KSB7XHJcbiAgICAgICAgdGhpcy5xdWVyeUlkID0gX3F1ZXJ5SWQ7XHJcbiAgICAgICAgdGhpcy5mdW5jSW5mb0NhY2hlID0gX2Z1bmNJbmZvQ2FjaGU7XHJcbiAgICAgICAgdGhpcy5jYWNoZSA9IF9zZXJ2aWNlQ2FjaGUuY2FjaGVTZXJ2aWNlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yib5bu65Y+C5pWwXHJcbiAgICAgKiBAcGFyYW0gb3B0aW9uIOWPguaVsOmFjee9rumhuVxyXG4gICAgICogeyBxdWVyeUlkOiDmn6Xor6JJRCwgY29udHJvbFR5cGU6IOafpeivouexu+Wei++8mmxpc3QgIHRyZWVsaXN0ICBjcm9zc3RhYiwgc2NoZW1hSWQ6IOaWueahiElELCBxb01hbmFnZXJDb2RlOiDmn6Xor6Llr7nosaHnvJblj7csIGV4dGVuZENvbmQ6IOaJqeWxleadoeS7tiwgcGFnZUluZGV4OiDpobXntKLlvJUsIHBhZ2VTaXplOiDliIbpobXlpKflsI8sIGZpbHRlckNvbmRpdGlvbjog57uT5p6c6L+H5ruk5p2h5Lu2LCBwcmludEludGVncmF0aW9uOiDmiZPljbDphY3nva4sIGV4Y2VsRXhwb3J0TmFtZTog5a+85Ye6RXhjZWzmlofku7blkI0gfVxyXG4gICAgICogQHJldHVybnMgXHJcbiAgICAgKi9cclxuICAgIGNyZWF0ZVBhcmFtZXRlcnMob3B0aW9uOiBhbnkpIHtcclxuICAgICAgICBjb25zdCB0YWJJZCA9IHRoaXMuYmluZENsb3NlVGFiRXZlbnQoKTtcclxuICAgICAgICBsZXQgZW50aXR5RGF0YTogYW55O1xyXG4gICAgICAgIGlmICh0aGlzLmNhY2hlLmdldCh0YWJJZCkpIHtcclxuICAgICAgICAgICAgZW50aXR5RGF0YSA9IEpTT04uc3RyaW5naWZ5KHRoaXMuY2FjaGUuZ2V0KHRhYklkKSk7XHJcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmNhY2hlLmdldChvcHRpb24ucXVlcnlJZCkpIHtcclxuICAgICAgICAgICAgZW50aXR5RGF0YSA9IEpTT04uc3RyaW5naWZ5KHRoaXMuY2FjaGUuZ2V0KG9wdGlvbi5xdWVyeUlkKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZW50aXR5RGF0YSA9IEpTT04uc3RyaW5naWZ5KHsgJ2lkJzogJ3VuZGVmaW5lZF9udWxsJyB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcGFyYW1zID0ge1xyXG4gICAgICAgICAgICBlbnRpdHlEYXRhOiBlbnRpdHlEYXRhLFxyXG4gICAgICAgICAgICBleHRlbmRDb25kOiB0aGlzLmNhY2hlLmdldCh0YWJJZCArICdleHRlbmRDb25kJykgPyB0aGlzLmNhY2hlLmdldCh0YWJJZCArICdleHRlbmRDb25kJykgOiBvcHRpb24uZXh0ZW5kQ29uZCxcclxuICAgICAgICAgICAgcGFnZUluZGV4OiBvcHRpb24ucGFnZUluZGV4ID8gb3B0aW9uLnBhZ2VJbmRleCA6IDAsXHJcbiAgICAgICAgICAgIHBhZ2VTaXplOiBvcHRpb24ucGFnZVNpemUgPyBvcHRpb24ucGFnZVNpemUgOiAwLFxyXG4gICAgICAgICAgICBzY2hlbWFJZDogb3B0aW9uLnNjaGVtYUlkICYmIG9wdGlvbi5zY2hlbWFJZCAhPT0gJ3ByZWZhYicgPyBvcHRpb24uc2NoZW1hSWQgOiAnMScsXHJcbiAgICAgICAgICAgIGZpbHRlckNvbmQ6IG9wdGlvbi5maWx0ZXJDb25kaXRpb24gPyBvcHRpb24uZmlsdGVyQ29uZGl0aW9uIDogKHRoaXMuY2FjaGUuZ2V0KHRhYklkICsgJ2ZpbHRlcmNvbmRpdGlvbicpID8gdGhpcy5jYWNoZS5nZXQodGFiSWQgKyAnZmlsdGVyY29uZGl0aW9uJykgOiAnJyksXHJcbiAgICAgICAgICAgIHFvTWFuYWdlckNvZGU6IG9wdGlvbi5xb01hbmFnZXJDb2RlID8gb3B0aW9uLnFvTWFuYWdlckNvZGUgOiAnJyxcclxuICAgICAgICAgICAgdm9Db2RlOiBvcHRpb24udm9JZCA/IG9wdGlvbi52b0lkIDogJycsXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBwYXJhbWV0ZXJFbnRpdHlEYXRhID0gSlNPTi5wYXJzZShlbnRpdHlEYXRhKTtcclxuICAgICAgICAgICAgaWYgKHBhcmFtZXRlckVudGl0eURhdGEuaGFzT3duUHJvcGVydHkoJ0BmaWx0ZXJFeHByZXNzaW9uU3RyaW5nQCcpKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyRXhwcmVzc2lvbiA9IHBhcmFtcyAmJiBwYXJhbXMuZmlsdGVyQ29uZCA/IEpTT04ucGFyc2UocGFyYW1zLmZpbHRlckNvbmQpIDogbnVsbDtcclxuICAgICAgICAgICAgICAgIGlmICghZmlsdGVyRXhwcmVzc2lvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtcy5maWx0ZXJDb25kID0gcGFyYW1ldGVyRW50aXR5RGF0YVsnQGZpbHRlckV4cHJlc3Npb25TdHJpbmdAJ107XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFkdmFuY2VGaWx0ZXJFeHByZXNzaW9uID0gSlNPTi5wYXJzZShwYXJhbWV0ZXJFbnRpdHlEYXRhWydAZmlsdGVyRXhwcmVzc2lvblN0cmluZ0AnXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYWR2YW5jZUZpbHRlckV4cHJlc3Npb24uZXhwcmVzc0l0ZW1zID0gYWR2YW5jZUZpbHRlckV4cHJlc3Npb24uZXhwcmVzc0l0ZW1zLmNvbmNhdChmaWx0ZXJFeHByZXNzaW9uLmV4cHJlc3NJdGVtcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zLmZpbHRlckNvbmQgPSBKU09OLnN0cmluZ2lmeShhZHZhbmNlRmlsdGVyRXhwcmVzc2lvbik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvcHRpb24uY29udHJvbFR5cGUpIHtcclxuICAgICAgICAgICAgcGFyYW1zWydjb250cm9sVHlwZSddID0gb3B0aW9uLmNvbnRyb2xUeXBlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAob3B0aW9uLmV4Y2VsRXhwb3J0TmFtZSkge1xyXG4gICAgICAgICAgICBwYXJhbXNbJ2V4Y2VsRXhwb3J0TmFtZSddID0gb3B0aW9uLmV4Y2VsRXhwb3J0TmFtZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG9wdGlvbi5wcmludEludGVncmF0aW9uKSB7XHJcbiAgICAgICAgICAgIHBhcmFtc1sncHJpbnRJbnRlZ3JhdGlvbiddID0gb3B0aW9uLnByaW50SW50ZWdyYXRpb24gPyBKU09OLnN0cmluZ2lmeShvcHRpb24ucHJpbnRJbnRlZ3JhdGlvbikgOiAnJztcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG9wdGlvbi5tdWx0aVNoZWV0cykge1xyXG4gICAgICAgICAgICBwYXJhbXNbJ211bHRpU2hlZXRzJ10gPSBvcHRpb24ubXVsdGlTaGVldHMgJiYgb3B0aW9uLm11bHRpU2hlZXRzLmxlbmd0aCA/IG9wdGlvbi5tdWx0aVNoZWV0cy5qb2luKFwiLFwiKSA6ICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAob3B0aW9uLmN1clNoZWV0KSB7XHJcbiAgICAgICAgICAgIHBhcmFtc1snY3VyU2hlZXQnXSA9IG9wdGlvbi5jdXJTaGVldDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG9wdGlvbi5tdWx0aVNoZWV0c1NjaGVtYUlkcykge1xyXG4gICAgICAgICAgICBwYXJhbXNbJ211bHRpU2hlZXRzU2NoZW1hSWRzJ10gPSBvcHRpb24ubXVsdGlTaGVldHNTY2hlbWFJZHMgPyBKU09OLnN0cmluZ2lmeShvcHRpb24ubXVsdGlTaGVldHNTY2hlbWFJZHMpIDogJyc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvcHRpb24uZ3JvdXBUeXBlKSB7XHJcbiAgICAgICAgICAgIHBhcmFtc1snZ3JvdXBUeXBlJ10gPSBvcHRpb24uZ3JvdXBUeXBlID8gb3B0aW9uLmdyb3VwVHlwZSA6ICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAob3B0aW9uLnF1ZXJ5SWQpIHtcclxuICAgICAgICAgICAgcGFyYW1zWydxdWVyeUlkJ10gPSBvcHRpb24ucXVlcnlJZCA/IG9wdGlvbi5xdWVyeUlkIDogJyc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChSdGZTZXJ2aWNlcy5nZXRNZW51UGFyYW1ldGVyKCdlbmFibGVRT0V4dGVuZHMnKSkge1xyXG4gICAgICAgICAgICBwYXJhbXNbJ2VuYWJsZVFPRXh0ZW5kcyddID0gUnRmU2VydmljZXMuZ2V0TWVudVBhcmFtZXRlcignZW5hYmxlUU9FeHRlbmRzJyk7XHJcbiAgICAgICAgICAgIHBhcmFtc1sncW9JZCddID0gU2VydmljZXNVdGlscy5nZXRTZXJ2aWNlcyhSdGZTZXJ2aWNlcy5nZXRUYWJJZCh0aGlzLnF1ZXJ5SWQpICsgJ3FvSWQnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBwYXJhbXM7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnu5Hlrprlip/og73oj5zljZXlhbPpl63kuovku7ZcclxuICAgICAqL1xyXG4gICAgYmluZENsb3NlVGFiRXZlbnQoKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgdGFiID0gZ3NwZnJhbWV3b3JrU2VydmljZS5ydGYuc2Vzc2lvbi5nZXRDb21tb25WYXJpYWJsZSgpO1xyXG4gICAgICAgICAgICBnc3BmcmFtZXdvcmtTZXJ2aWNlLnJ0Zi5mcm1FdmVudC5ldmVudExpc3RlbmVyKCdiZWZvcmVGdW5jQ2xvc2VFdmVudCcsIHRoaXMuY2xlYXJQYXJhbWV0ZXJzQ2FjaGUuYmluZCh0aGlzKSwgdGFiKTtcclxuICAgICAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLmZ1bmNJbmZvQ2FjaGUuZnVuY0lkcy5maW5kSW5kZXgoZWwgPT4gZWwgPT09IHRhYi50YWJJZCk7XHJcbiAgICAgICAgICAgIGlmIChpbmRleCA8IDApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZnVuY0luZm9DYWNoZS5mdW5jSWRzLnB1c2godGFiLnRhYklkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdGFiLnRhYklkICsgUnRmU2VydmljZXMuZ2V0SW5TdWl0ZUZybVVVSUQoKTtcclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5riF6Zmk5p+l6K+i57yT5a2YXHJcbiAgICAgKi9cclxuICAgIGNsZWFyUGFyYW1ldGVyc0NhY2hlKCkge1xyXG4gICAgICAgIGNvbnN0IHRhYklkID0gYXJndW1lbnRzWzBdLnRhYklkO1xyXG4gICAgICAgIGlmICh0aGlzLnF1ZXJ5SWQpIHtcclxuICAgICAgICAgICAgdGhpcy5jYWNoZS5zZXQodGhpcy5xdWVyeUlkLCAnJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY2FjaGUuc2V0KHRhYklkLCAnJyk7XHJcbiAgICAgICAgdGhpcy5jYWNoZS5zZXQodGFiSWQgKyAncmVuZGVyTW9kZScsICcnKTtcclxuICAgICAgICBsZXQgaW5kZXggPSB0aGlzLmZ1bmNJbmZvQ2FjaGUuZnVuY0lkcy5maW5kSW5kZXgoZWwgPT4gZWwgPT09IHRhYklkKTtcclxuICAgICAgICBpZiAoaW5kZXggPj0gMCkge1xyXG4gICAgICAgICAgICB0aGlzLmZ1bmNJbmZvQ2FjaGUuZnVuY0lkcy5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgICAgICBpbmRleCA9IHRoaXMuZnVuY0luZm9DYWNoZS5maXJzdExvYWRDYWNoZS5maW5kSW5kZXgoZWwgPT4gZWwgPT09IHRhYklkKTtcclxuICAgICAgICAgICAgaWYgKGluZGV4ID49IDApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZnVuY0luZm9DYWNoZS5maXJzdExvYWRDYWNoZS5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGdzcGZyYW1ld29ya1NlcnZpY2UucnRmLmZ1bmMuY2xvc2UoYXJndW1lbnRzWzBdKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0iXX0=