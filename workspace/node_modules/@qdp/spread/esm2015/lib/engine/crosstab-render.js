/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { EventBus } from "@qdp/common";
import { RtfServices } from "@qdp/common";
import { BaseRender } from "./base-render";
export class CrosstabRender extends BaseRender {
    /**
     * @param {?} _queryId
     * @param {?} _controlType
     * @param {?=} _jointsearchInfoList
     * @param {?=} _funcInfoCache
     * @param {?=} _serviceCache
     */
    constructor(_queryId, _controlType, _jointsearchInfoList, _funcInfoCache, _serviceCache) {
        super(_queryId, _controlType, _jointsearchInfoList, _funcInfoCache, _serviceCache);
        this.crosstabInit();
    }
    /**
     * @private
     * @return {?}
     */
    crosstabInit() {
    }
    /**
     * 渲染
     * @param {?} obj 参数配置项
     * @return {?}
     */
    render(obj) {
        /** @type {?} */
        const self = this;
        this.queryId = obj.queryId;
        obj.schemaId = obj.schemaId === 'prefab' ? '1' : obj.schemaId;
        this.utils.get('schema').getSchemaInfo(obj).subscribe((/**
         * @param {?} schemaValue
         * @return {?}
         */
        (schemaValue) => {
            if (schemaValue) {
                obj['schemaId'] = schemaValue.id;
                obj['schemaValue'] = schemaValue;
                // this.currentSchemaValueChanger.next(schemaValue);
                EventBus.dispatch('schemaValueChanged', schemaValue);
                /** @type {?} */
                let delay = schemaValue.schemaValue.otherOption.delay;
                /** @type {?} */
                const interval = schemaValue.schemaValue.otherOption.interval;
                /** @type {?} */
                const index = self.funcInfoCache.firstLoadCache.findIndex((/**
                 * @param {?} el
                 * @return {?}
                 */
                el => el === this.tabId));
                /** @type {?} */
                const firstLoad = schemaValue.schemaValue.otherOption.firstLoad;
                if (index < 0 && this.isSchemaSelectChanged === false) {
                    if (firstLoad === false) {
                        self.funcInfoCache.firstLoadCache.push(this.tabId);
                        obj.loading.close();
                        if (obj.spread.getActiveSheet()) {
                            obj.spread.getActiveSheet().deleteRows(0, obj.spread.getActiveSheet().getRowCount());
                            obj.spread.getActiveSheet().options.colHeaderVisible = false;
                            obj.spread.invalidateLayout();
                            obj.spread.repaint();
                        }
                        return;
                    }
                }
                if (!delay) {
                    delay = 0;
                }
                setTimeout((/**
                 * @return {?}
                 */
                () => {
                    this.getRenderDataForCrosstab.call(this, Object.assign({}, obj));
                    if (interval > 0) {
                        setInterval((/**
                         * @return {?}
                         */
                        () => {
                            this.getRenderDataForCrosstab.call(this, Object.assign({}, obj));
                        }), interval * 1000);
                    }
                }), delay * 1000);
            }
            else {
                obj['schemaId'] = '1';
                this.getRenderDataForCrosstab.call(this, Object.assign({}, obj));
            }
        }));
    }
    /**
     * @private
     * @param {?} obj
     * @return {?}
     */
    getRenderDataForCrosstab(obj) {
        /** @type {?} */
        const self = this;
        obj.schemaId = obj.schemaId ? obj.schemaId : (obj.schemaValue && obj.schemaValue.id ? obj.schemaValue.id : '1');
        if (!obj.formData) {
            /** @type {?} */
            let params = this.utils.get('parameter').createParameters(Object.assign({}, obj, { pageIndex: 0, pageSize: 0 }));
            params['queryId'] = obj.queryId ? obj.queryId : '';
            // 查询数据前事件
            params = this.utils.get('renderExtends').runRenderExtends('beforeQueryData', this.localizeService.getValue('spread.message.extend.query.before'), params, obj.spread);
            try {
                this.cache.set(self.tabId, JSON.parse(params['entityData']));
                this.cache.set(self.tabId + 'extendCond', params['extendCond']);
            }
            catch (e) { }
            self.lcpService.getCol(params, obj.queryRelativeUrl).subscribe((/**
             * @param {?} resultData
             * @return {?}
             */
            resultData => {
                /** @type {?} */
                const dynamicColumns = (resultData && resultData.dynamicCols) || [];
                self.initJoinParams(obj, dynamicColumns);
                self.schemaManager.setColInfo(dynamicColumns);
                if (obj.schemaId === '1' || !obj.schemaId) {
                    obj.loading.close();
                    return self.errorHandle(obj.spread, this.localizeService.getValue('spread.message.validate.schemaInfo'));
                }
                self.lcpService.getCrosstabTemplate(params, obj.queryRelativeUrl).subscribe((/**
                 * @param {?} template
                 * @return {?}
                 */
                (template) => {
                    if (!template || !template.sheets || !template.sheets.sheet1 || !template.sheets.sheet1.data || !template.sheets.sheet1.data.dataTable || !template.sheets.sheet1.data.dataTable['0']) {
                        obj.loading.close();
                        return self.errorHandle(obj.spread, this.localizeService.getValue('spread.message.validate.nodata'));
                    }
                    self.renderCrossTable(Object.assign({}, obj, { template }));
                    /** @type {?} */
                    const event = RtfServices.getMenuSwitchControlEvent();
                    if (event && typeof event === 'object') {
                        event.next('ok');
                    }
                    obj.loading.close();
                    this.utils.get('spreadStyle').bindSelectChanged(obj.spread, obj.queryId);
                }), (/**
                 * @param {?} error
                 * @return {?}
                 */
                (error) => {
                    self.formErrorService.exception(error.Message, error);
                    obj.loading.close();
                }));
            }), (/**
             * @param {?} error
             * @return {?}
             */
            (error) => {
                self.formErrorService.exception(error.Message, error);
                obj.loading.close();
            }));
            this.cache.set('schema_schemaid' + obj.queryId, obj.schemaId);
        }
    }
    /**
     * @private
     * @param {?} obj
     * @return {?}
     */
    renderCrossTable(obj) {
        obj.spread.suspendEvent();
        obj.spread.suspendPaint();
        if (obj.template) {
            obj.spread.fromJSON(obj.template);
            obj.spread.getActiveSheet().rowOutlines.direction(GC.Spread.Sheets.Outlines.OutlineDirection.backward);
            /** @type {?} */
            const row = obj.spread.getActiveSheet().getRowCount();
            for (let i = 0; i < row; i++) {
                /** @type {?} */
                const cellType = obj.spread.getActiveSheet().getCellType(i, 0);
                if (cellType && cellType.typeName === 'TreeCellType') {
                    /** @type {?} */
                    const level = cellType.level;
                    for (let r = 0; r <= level; r++) {
                        obj.spread.getActiveSheet().rowOutlines.group(i, 1);
                    }
                }
            }
        }
        /** @type {?} */
        const sheet = obj.spread.getActiveSheet();
        if (sheet) {
            this.titleVariablesReplace(sheet, obj.data);
            sheet.clearSelection();
        }
        // 页面渲染后事件
        this.utils.get('renderExtends').runRenderExtends('afterLoadData', this.localizeService.getValue('spread.message.extend.dataLoading.after'), obj.data, obj.spread);
        obj.spread.resumePaint();
        obj.spread.resumeEvent();
        // 增加当前单元格联查参数缓存
        this.utils.get('spreadStyle').joinParam['controlType'] = obj.controlType;
        this.cache.set(this.tabId + 'joinSearch', this.utils.get('spreadStyle').joinParam);
    }
    /**
     * @private
     * @param {?} obj
     * @param {?} dynamicColumns
     * @return {?}
     */
    initJoinParams(obj, dynamicColumns) {
        this.utils.get('spreadStyle').joinParam = {
            controlType: obj.controlType,
            rowHeaderColInfo: { start: 0, end: 0 },
            // 行标题起始位置信息（行号）
            colHeaderRowInfo: { start: 0, end: 0 },
            // 列标题信息起始位置信息（列号)
            valueColCount: 0,
            // 行标题信息起始位置信息（列号)
            colInfos: dynamicColumns,
        };
        /** @type {?} */
        let columnHeaderRowCount = this.utils.get('spreadStyle').rowHeadersColumnCount = this.utils.get('spreadStyle').valueHeaderRowCount = 0;
        /** @type {?} */
        let titleCount = 0;
        if (obj.schemaId !== '1') {
            titleCount += obj.schemaValue.schemaValue.titleOption.title ? 1 : 0;
            titleCount += obj.schemaValue.schemaValue.titleOption.subTitles.length;
            obj.schemaValue.schemaValue.columnOption.colList.forEach((/**
             * @param {?} data
             * @return {?}
             */
            (data) => {
                if (data.dimension && data.dimension !== 0) {
                    if (data.dimension === 1) {
                        this.utils.get('spreadStyle').rowHeadersColumnCount++;
                    }
                    else if (data.dimension === 2) {
                        columnHeaderRowCount++;
                    }
                    else if (data.dimension === 3) {
                        this.utils.get('spreadStyle').valueHeaderRowCount++;
                    }
                }
            }));
            this.utils.get('spreadStyle').joinParam['controlType'] = obj.controlType;
            this.utils.get('spreadStyle').joinParam['rowHeaderColInfo'] = { start: 0, end: this.utils.get('spreadStyle').rowHeadersColumnCount }; // 行标题起始位置信息（行号）
            this.utils.get('spreadStyle').joinParam['colHeaderRowInfo'] = { start: titleCount, end: titleCount + columnHeaderRowCount }; // 列标题信息起始位置信息（列号)
            this.utils.get('spreadStyle').joinParam['valueColCount'] = this.utils.get('spreadStyle').valueHeaderRowCount; // 行标题信息起始位置信息（列号)
            this.utils.get('spreadStyle').joinParam['colInfos'] = obj.schemaValue.schemaValue.columnOption.colList; // 列信息
        }
        this.cache.set(this.tabId + 'joinSearch', this.utils.get('spreadStyle').joinParam);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvc3N0YWItcmVuZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHFkcC9zcHJlYWQvIiwic291cmNlcyI6WyJsaWIvZW5naW5lL2Nyb3NzdGFiLXJlbmRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN2QyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRTFDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFJM0MsTUFBTSxPQUFPLGNBQWUsU0FBUSxVQUFVOzs7Ozs7OztJQUUxQyxZQUFZLFFBQWEsRUFBRSxZQUFpQixFQUFFLG9CQUEwQixFQUFFLGNBQW9CLEVBQUUsYUFBbUI7UUFDL0csS0FBSyxDQUFDLFFBQVEsRUFBRSxZQUFZLEVBQUUsb0JBQW9CLEVBQUUsY0FBYyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBQ25GLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUN4QixDQUFDOzs7OztJQUVPLFlBQVk7SUFFcEIsQ0FBQzs7Ozs7O0lBTUQsTUFBTSxDQUFDLEdBQWlCOztjQUNkLElBQUksR0FBRyxJQUFJO1FBQ2pCLElBQUksQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQztRQUMzQixHQUFHLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQyxRQUFRLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUM7UUFDOUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFNBQVM7Ozs7UUFBQyxDQUFDLFdBQWdCLEVBQUUsRUFBRTtZQUN2RSxJQUFJLFdBQVcsRUFBRTtnQkFDYixHQUFHLENBQUMsVUFBVSxDQUFDLEdBQUcsV0FBVyxDQUFDLEVBQUUsQ0FBQztnQkFDakMsR0FBRyxD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QVMsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxDQUFDLGdCQUFnQjtZQUN0SixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxTQUFTLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLFVBQVUsR0FBRyxvQkFBb0IsRUFBRSxDQUFDLENBQUMsa0JBQWtCO1lBQy9JLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLGtCQUFrQjtZQUNoSSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsR0FBRyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU07U0FDakg7UUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLFlBQVksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN2RixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEJ1cyB9IGZyb20gXCJAcWRwL2NvbW1vblwiO1xyXG5pbXBvcnQgeyBSdGZTZXJ2aWNlcyB9IGZyb20gXCJAcWRwL2NvbW1vblwiO1xyXG5pbXBvcnQgeyBSZW5kZXJPcHRpb24gfSBmcm9tIFwiLi4vZW50aXR5L1JlbmRlck9wdGlvblwiO1xyXG5pbXBvcnQgeyBCYXNlUmVuZGVyIH0gZnJvbSBcIi4vYmFzZS1yZW5kZXJcIjtcclxuXHJcbmRlY2xhcmUgdmFyIEdDOiBhbnk7XHJcblxyXG5leHBvcnQgY2xhc3MgQ3Jvc3N0YWJSZW5kZXIgZXh0ZW5kcyBCYXNlUmVuZGVyIHtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihfcXVlcnlJZDogYW55LCBfY29udHJvbFR5cGU6IGFueSwgX2pvaW50c2VhcmNoSW5mb0xpc3Q/OiBhbnksIF9mdW5jSW5mb0NhY2hlPzogYW55LCBfc2VydmljZUNhY2hlPzogYW55KSB7XHJcbiAgICAgICAgc3VwZXIoX3F1ZXJ5SWQsIF9jb250cm9sVHlwZSwgX2pvaW50c2VhcmNoSW5mb0xpc3QsIF9mdW5jSW5mb0NhY2hlLCBfc2VydmljZUNhY2hlKTtcclxuICAgICAgICB0aGlzLmNyb3NzdGFiSW5pdCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY3Jvc3N0YWJJbml0KCkge1xyXG5cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOa4suafk1xyXG4gICAgICogQHBhcmFtIG9iaiDlj4LmlbDphY3nva7poblcclxuICAgICAqL1xyXG4gICAgcmVuZGVyKG9iajogUmVuZGVyT3B0aW9uKSB7XHJcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy5xdWVyeUlkID0gb2JqLnF1ZXJ5SWQ7XHJcbiAgICAgICAgb2JqLnNjaGVtYUlkID0gb2JqLnNjaGVtYUlkID09PSAncHJlZmFiJyA/ICcxJyA6IG9iai5zY2hlbWFJZDtcclxuICAgICAgICB0aGlzLnV0aWxzLmdldCgnc2NoZW1hJykuZ2V0U2NoZW1hSW5mbyhvYmopLnN1YnNjcmliZSgoc2NoZW1hVmFsdWU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoc2NoZW1hVmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIG9ialsnc2NoZW1hSWQnXSA9IHNjaGVtYVZhbHVlLmlkO1xyXG4gICAgICAgICAgICAgICAgb2JqWydzY2hlbWFWYWx1ZSddID0gc2NoZW1hVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAvLyB0aGlzLmN1cnJlbnRTY2hlbWFWYWx1ZUNoYW5nZXIubmV4dChzY2hlbWFWYWx1ZSk7XHJcbiAgICAgICAgICAgICAgICBFdmVudEJ1cy5kaXNwYXRjaCgnc2NoZW1hVmFsdWVDaGFuZ2VkJywgc2NoZW1hVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgbGV0IGRlbGF5ID0gc2NoZW1hVmFsdWUuc2NoZW1hVmFsdWUub3RoZXJPcHRpb24uZGVsYXk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpbnRlcnZhbCA9IHNjaGVtYVZhbHVlLnNjaGVtYVZhbHVlLm90aGVyT3B0aW9uLmludGVydmFsO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gc2VsZi5mdW5jSW5mb0NhY2hlLmZpcnN0TG9hZENhY2hlLmZpbmRJbmRleChlbCA9PiBlbCA9PT0gdGhpcy50YWJJZCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmaXJzdExvYWQgPSBzY2hlbWFWYWx1ZS5zY2hlbWFWYWx1ZS5vdGhlck9wdGlvbi5maXJzdExvYWQ7XHJcbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCAwICYmIHRoaXMuaXNTY2hlbWFTZWxlY3RDaGFuZ2VkID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmaXJzdExvYWQgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZnVuY0luZm9DYWNoZS5maXJzdExvYWRDYWNoZS5wdXNoKHRoaXMudGFiSWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvYmoubG9hZGluZy5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob2JqLnNwcmVhZC5nZXRBY3RpdmVTaGVldCgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouc3ByZWFkLmdldEFjdGl2ZVNoZWV0KCkuZGVsZXRlUm93cygwLCBvYmouc3ByZWFkLmdldEFjdGl2ZVNoZWV0KCkuZ2V0Um93Q291bnQoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouc3ByZWFkLmdldEFjdGl2ZVNoZWV0KCkub3B0aW9ucy5jb2xIZWFkZXJWaXNpYmxlID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouc3ByZWFkLmludmFsaWRhdGVMYXlvdXQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcHJlYWQucmVwYWludCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoIWRlbGF5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVsYXkgPSAwO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRSZW5kZXJEYXRhRm9yQ3Jvc3N0YWIuY2FsbCh0aGlzLCBPYmplY3QuYXNzaWduKHt9LCBvYmopKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaW50ZXJ2YWwgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldEludGVydmFsKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0UmVuZGVyRGF0YUZvckNyb3NzdGFiLmNhbGwodGhpcywgT2JqZWN0LmFzc2lnbih7fSwgb2JqKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sIGludGVydmFsICogMTAwMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSwgZGVsYXkgKiAxMDAwKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG9ialsnc2NoZW1hSWQnXSA9ICcxJztcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0UmVuZGVyRGF0YUZvckNyb3NzdGFiLmNhbGwodGhpcywgT2JqZWN0LmFzc2lnbih7fSwgb2JqKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFJlbmRlckRhdGFGb3JDcm9zc3RhYihvYmo6IFJlbmRlck9wdGlvbikge1xyXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgICAgIG9iai5zY2hlbWFJZCA9IG9iai5zY2hlbWFJZCA/IG9iai5zY2hlbWFJZCA6IChvYmouc2NoZW1hVmFsdWUgJiYgb2JqLnNjaGVtYVZhbHVlLmlkID8gb2JqLnNjaGVtYVZhbHVlLmlkIDogJzEnKTtcclxuICAgICAgICBpZiAoIW9iai5mb3JtRGF0YSkge1xyXG4gICAgICAgICAgICBsZXQgcGFyYW1zID0gdGhpcy51dGlscy5nZXQoJ3BhcmFtZXRlcicpLmNyZWF0ZVBhcmFtZXRlcnMoT2JqZWN0LmFzc2lnbih7fSwgb2JqLCB7IHBhZ2VJbmRleDogMCwgcGFnZVNpemU6IDAgfSkpO1xyXG4gICAgICAgICAgICBwYXJhbXNbJ3F1ZXJ5SWQnXSA9IG9iai5xdWVyeUlkID8gb2JqLnF1ZXJ5SWQgOiAnJztcclxuICAgICAgICAgICAgLy8g5p+l6K+i5pWw5o2u5YmN5LqL5Lu2XHJcbiAgICAgICAgICAgIHBhcmFtcyA9IHRoaXMudXRpbHMuZ2V0KCdyZW5kZXJFeHRlbmRzJykucnVuUmVuZGVyRXh0ZW5kcygnYmVmb3JlUXVlcnlEYXRhJywgdGhpcy5sb2NhbGl6ZVNlcnZpY2UuZ2V0VmFsdWUoJ3NwcmVhZC5tZXNzYWdlLmV4dGVuZC5xdWVyeS5iZWZvcmUnKSwgcGFyYW1zLCBvYmouc3ByZWFkKTtcclxuXHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNhY2hlLnNldChzZWxmLnRhYklkLCBKU09OLnBhcnNlKHBhcmFtc1snZW50aXR5RGF0YSddKSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNhY2hlLnNldChzZWxmLnRhYklkICsgJ2V4dGVuZENvbmQnLCBwYXJhbXNbJ2V4dGVuZENvbmQnXSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgfVxyXG5cclxuICAgICAgICAgICAgc2VsZi5sY3BTZXJ2aWNlLmdldENvbChwYXJhbXMsIG9iai5xdWVyeVJlbGF0aXZlVXJsKS5zdWJzY3JpYmUocmVzdWx0RGF0YSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkeW5hbWljQ29sdW1ucyA9IChyZXN1bHREYXRhICYmIHJlc3VsdERhdGEuZHluYW1pY0NvbHMpIHx8IFtdO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5pbml0Sm9pblBhcmFtcyhvYmosIGR5bmFtaWNDb2x1bW5zKTtcclxuICAgICAgICAgICAgICAgIHNlbGYuc2NoZW1hTWFuYWdlci5zZXRDb2xJbmZvKGR5bmFtaWNDb2x1bW5zKTtcclxuICAgICAgICAgICAgICAgIGlmIChvYmouc2NoZW1hSWQgPT09ICcxJyB8fCAhb2JqLnNjaGVtYUlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb2JqLmxvYWRpbmcuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5lcnJvckhhbmRsZShvYmouc3ByZWFkLCB0aGlzLmxvY2FsaXplU2VydmljZS5nZXRWYWx1ZSgnc3ByZWFkLm1lc3NhZ2UudmFsaWRhdGUuc2NoZW1hSW5mbycpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHNlbGYubGNwU2VydmljZS5nZXRDcm9zc3RhYlRlbXBsYXRlKHBhcmFtcywgb2JqLnF1ZXJ5UmVsYXRpdmVVcmwpLnN1YnNjcmliZSgodGVtcGxhdGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGVtcGxhdGUgfHwgIXRlbXBsYXRlLnNoZWV0cyB8fCAhdGVtcGxhdGUuc2hlZXRzLnNoZWV0MSB8fCAhdGVtcGxhdGUuc2hlZXRzLnNoZWV0MS5kYXRhIHx8ICF0ZW1wbGF0ZS5zaGVldHMuc2hlZXQxLmRhdGEuZGF0YVRhYmxlIHx8ICF0ZW1wbGF0ZS5zaGVldHMuc2hlZXQxLmRhdGEuZGF0YVRhYmxlWycwJ10pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb2JqLmxvYWRpbmcuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuZXJyb3JIYW5kbGUob2JqLnNwcmVhZCwgdGhpcy5sb2NhbGl6ZVNlcnZpY2UuZ2V0VmFsdWUoJ3NwcmVhZC5tZXNzYWdlLnZhbGlkYXRlLm5vZGF0YScpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZW5kZXJDcm9zc1RhYmxlKE9iamVjdC5hc3NpZ24oe30sIG9iaiwgeyB0ZW1wbGF0ZSB9KSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGV2ZW50ID0gUnRmU2VydmljZXMuZ2V0TWVudVN3aXRjaENvbnRyb2xFdmVudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChldmVudCAmJiB0eXBlb2YgZXZlbnQgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50Lm5leHQoJ29rJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBvYmoubG9hZGluZy5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLmJpbmRTZWxlY3RDaGFuZ2VkKG9iai5zcHJlYWQsIG9iai5xdWVyeUlkKTtcclxuICAgICAgICAgICAgICAgIH0sIChlcnJvcjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5mb3JtRXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbihlcnJvci5NZXNzYWdlLCBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgb2JqLmxvYWRpbmcuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9LCAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5mb3JtRXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbihlcnJvci5NZXNzYWdlLCBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICBvYmoubG9hZGluZy5jbG9zZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuY2FjaGUuc2V0KCdzY2hlbWFfc2NoZW1haWQnICsgb2JqLnF1ZXJ5SWQsIG9iai5zY2hlbWFJZCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVuZGVyQ3Jvc3NUYWJsZShvYmo6IFJlbmRlck9wdGlvbikge1xyXG4gICAgICAgIG9iai5zcHJlYWQuc3VzcGVuZEV2ZW50KCk7XHJcbiAgICAgICAgb2JqLnNwcmVhZC5zdXNwZW5kUGFpbnQoKTtcclxuICAgICAgICBpZiAob2JqLnRlbXBsYXRlKSB7XHJcbiAgICAgICAgICAgIG9iai5zcHJlYWQuZnJvbUpTT04ob2JqLnRlbXBsYXRlKTtcclxuICAgICAgICAgICAgb2JqLnNwcmVhZC5nZXRBY3RpdmVTaGVldCgpLnJvd091dGxpbmVzLmRpcmVjdGlvbihHQy5TcHJlYWQuU2hlZXRzLk91dGxpbmVzLk91dGxpbmVEaXJlY3Rpb24uYmFja3dhcmQpO1xyXG4gICAgICAgICAgICBjb25zdCByb3cgPSBvYmouc3ByZWFkLmdldEFjdGl2ZVNoZWV0KCkuZ2V0Um93Q291bnQoKTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByb3c7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY2VsbFR5cGUgPSBvYmouc3ByZWFkLmdldEFjdGl2ZVNoZWV0KCkuZ2V0Q2VsbFR5cGUoaSwgMCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2VsbFR5cGUgJiYgY2VsbFR5cGUudHlwZU5hbWUgPT09ICdUcmVlQ2VsbFR5cGUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGV2ZWwgPSBjZWxsVHlwZS5sZXZlbDtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCByID0gMDsgciA8PSBsZXZlbDsgcisrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5zcHJlYWQuZ2V0QWN0aXZlU2hlZXQoKS5yb3dPdXRsaW5lcy5ncm91cChpLCAxKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3Qgc2hlZXQgPSBvYmouc3ByZWFkLmdldEFjdGl2ZVNoZWV0KCk7XHJcbiAgICAgICAgaWYgKHNoZWV0KSB7XHJcbiAgICAgICAgICAgIHRoaXMudGl0bGVWYXJpYWJsZXNSZXBsYWNlKHNoZWV0LCBvYmouZGF0YSk7XHJcbiAgICAgICAgICAgIHNoZWV0LmNsZWFyU2VsZWN0aW9uKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyDpobXpnaLmuLLmn5PlkI7kuovku7ZcclxuICAgICAgICB0aGlzLnV0aWxzLmdldCgncmVuZGVyRXh0ZW5kcycpLnJ1blJlbmRlckV4dGVuZHMoJ2FmdGVyTG9hZERhdGEnLCB0aGlzLmxvY2FsaXplU2VydmljZS5nZXRWYWx1ZSgnc3ByZWFkLm1lc3NhZ2UuZXh0ZW5kLmRhdGFMb2FkaW5nLmFmdGVyJyksIG9iai5kYXRhLCBvYmouc3ByZWFkKTtcclxuXHJcbiAgICAgICAgb2JqLnNwcmVhZC5yZXN1bWVQYWludCgpO1xyXG4gICAgICAgIG9iai5zcHJlYWQucmVzdW1lRXZlbnQoKTtcclxuICAgICAgICAvLyDlop7liqDlvZPliY3ljZXlhYPmoLzogZTmn6Xlj4LmlbDnvJPlrZhcclxuICAgICAgICB0aGlzLnV0aWxzLmdldCgnc3ByZWFkU3R5bGUnKS5qb2luUGFyYW1bJ2NvbnRyb2xUeXBlJ10gPSBvYmouY29udHJvbFR5cGU7XHJcbiAgICAgICAgdGhpcy5jYWNoZS5zZXQodGhpcy50YWJJZCArICdqb2luU2VhcmNoJywgdGhpcy51dGlscy5nZXQoJ3NwcmVhZFN0eWxlJykuam9pblBhcmFtKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGluaXRKb2luUGFyYW1zKG9iajogUmVuZGVyT3B0aW9uLCBkeW5hbWljQ29sdW1uczogYW55KSB7XHJcbiAgICAgICAgdGhpcy51dGlscy5nZXQoJ3NwcmVhZFN0eWxlJykuam9pblBhcmFtID0ge1xyXG4gICAgICAgICAgICBjb250cm9sVHlwZTogb2JqLmNvbnRyb2xUeXBlLFxyXG4gICAgICAgICAgICByb3dIZWFkZXJDb2xJbmZvOiB7IHN0YXJ0OiAwLCBlbmQ6IDAgfSwgLy8g6KGM5qCH6aKY6LW35aeL5L2N572u5L+h5oGv77yI6KGM5Y+377yJXHJcbiAgICAgICAgICAgIGNvbEhlYWRlclJvd0luZm86IHsgc3RhcnQ6IDAsIGVuZDogMCB9LCAvLyDliJfmoIfpopjkv6Hmga/otbflp4vkvY3nva7kv6Hmga/vvIjliJflj7cpXHJcbiAgICAgICAgICAgIHZhbHVlQ29sQ291bnQ6IDAsIC8vIOihjOagh+mimOS/oeaBr+i1t+Wni+S9jee9ruS/oeaBr++8iOWIl+WPtylcclxuICAgICAgICAgICAgY29sSW5mb3M6IGR5bmFtaWNDb2x1bW5zLCAvLyDliJfkv6Hmga9cclxuICAgICAgICB9O1xyXG4gICAgICAgIGxldCBjb2x1bW5IZWFkZXJSb3dDb3VudCA9IHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLnJvd0hlYWRlcnNDb2x1bW5Db3VudCA9IHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLnZhbHVlSGVhZGVyUm93Q291bnQgPSAwO1xyXG4gICAgICAgIGxldCB0aXRsZUNvdW50ID0gMDtcclxuICAgICAgICBpZiAob2JqLnNjaGVtYUlkICE9PSAnMScpIHtcclxuICAgICAgICAgICAgdGl0bGVDb3VudCArPSBvYmouc2NoZW1hVmFsdWUuc2NoZW1hVmFsdWUudGl0bGVPcHRpb24udGl0bGUgPyAxIDogMDtcclxuICAgICAgICAgICAgdGl0bGVDb3VudCArPSBvYmouc2NoZW1hVmFsdWUuc2NoZW1hVmFsdWUudGl0bGVPcHRpb24uc3ViVGl0bGVzLmxlbmd0aDtcclxuICAgICAgICAgICAgb2JqLnNjaGVtYVZhbHVlLnNjaGVtYVZhbHVlLmNvbHVtbk9wdGlvbi5jb2xMaXN0LmZvckVhY2goKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEuZGltZW5zaW9uICYmIGRhdGEuZGltZW5zaW9uICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuZGltZW5zaW9uID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLnJvd0hlYWRlcnNDb2x1bW5Db3VudCsrO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YS5kaW1lbnNpb24gPT09IDIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uSGVhZGVyUm93Q291bnQrKztcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEuZGltZW5zaW9uID09PSAzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLnZhbHVlSGVhZGVyUm93Q291bnQrKztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLnV0aWxzLmdldCgnc3ByZWFkU3R5bGUnKS5qb2luUGFyYW1bJ2NvbnRyb2xUeXBlJ10gPSBvYmouY29udHJvbFR5cGU7XHJcbiAgICAgICAgICAgIHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLmpvaW5QYXJhbVsncm93SGVhZGVyQ29sSW5mbyddID0geyBzdGFydDogMCwgZW5kOiB0aGlzLnV0aWxzLmdldCgnc3ByZWFkU3R5bGUnKS5yb3dIZWFkZXJzQ29sdW1uQ291bnQgfTsgLy8g6KGM5qCH6aKY6LW35aeL5L2N572u5L+h5oGv77yI6KGM5Y+377yJXHJcbiAgICAgICAgICAgIHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLmpvaW5QYXJhbVsnY29sSGVhZGVyUm93SW5mbyddID0geyBzdGFydDogdGl0bGVDb3VudCwgZW5kOiB0aXRsZUNvdW50ICsgY29sdW1uSGVhZGVyUm93Q291bnQgfTsgLy8g5YiX5qCH6aKY5L+h5oGv6LW35aeL5L2N572u5L+h5oGv77yI5YiX5Y+3KVxyXG4gICAgICAgICAgICB0aGlzLnV0aWxzLmdldCgnc3ByZWFkU3R5bGUnKS5qb2luUGFyYW1bJ3ZhbHVlQ29sQ291bnQnXSA9IHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLnZhbHVlSGVhZGVyUm93Q291bnQ7IC8vIOihjOagh+mimOS/oeaBr+i1t+Wni+S9jee9ruS/oeaBr++8iOWIl+WPtylcclxuICAgICAgICAgICAgdGhpcy51dGlscy5nZXQoJ3NwcmVhZFN0eWxlJykuam9pblBhcmFtWydjb2xJbmZvcyddID0gb2JqLnNjaGVtYVZhbHVlLnNjaGVtYVZhbHVlLmNvbHVtbk9wdGlvbi5jb2xMaXN0OyAvLyDliJfkv6Hmga9cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jYWNoZS5zZXQodGhpcy50YWJJZCArICdqb2luU2VhcmNoJywgdGhpcy51dGlscy5nZXQoJ3NwcmVhZFN0eWxlJykuam9pblBhcmFtKTtcclxuICAgIH1cclxufSJdfQ==