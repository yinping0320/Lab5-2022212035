/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ParameterUtils } from "../util/parameter.utils";
import { RenderExtendsUtils } from "../util/render.extends.utils";
import { SchemaUtils } from "../util/schema.utils";
import { ServicesUtils } from "../util/services.utils";
import { SpreadStyleUtils } from "../util/spread.style.utils";
import { RtfServices } from '@qdp/common';
export class BaseRender {
    /**
     * @param {?} _queryId
     * @param {?} _controlType
     * @param {?=} _jointsearchInfoList
     * @param {?=} _funcInfoCache
     * @param {?=} _serviceCache
     */
    constructor(_queryId, _controlType, _jointsearchInfoList, _funcInfoCache, _serviceCache) {
        this.utils = new Map();
        this.autoFitColumnIndex = 0;
        this.isSchemaSelectChanged = false;
        this.tabId = RtfServices.getTabId(_queryId);
        this.queryId = _queryId;
        this.type = _controlType;
        this.funcInfoCache = _funcInfoCache;
        this.serviceCache = _serviceCache;
        this.baseRenderInit(_queryId, _controlType, _jointsearchInfoList, _funcInfoCache);
    }
    /**
     * @private
     * @param {?} _queryId
     * @param {?} _controlType
     * @param {?=} _jointsearchInfoList
     * @param {?=} _funcInfoCache
     * @return {?}
     */
    baseRenderInit(_queryId, _controlType, _jointsearchInfoList, _funcInfoCache) {
        /** @type {?} */
        const parameterUtils = new ParameterUtils(_queryId, _funcInfoCache, this.serviceCache);
        /** @type {?} */
        const schemaUtils = new SchemaUtils(this.serviceCache);
        /** @type {?} */
        const spreadStyleUtils = new SpreadStyleUtils(_queryId, _controlType, _jointsearchInfoList, this.serviceCache);
        /** @type {?} */
        const renderExtendsUtils = new RenderExtendsUtils(_queryId);
        this.msgService = this.serviceCache.msgService;
        this.cache = this.serviceCache.cacheService;
        this.lcpService = this.serviceCache.lcpService;
        this.loadService = this.serviceCache.loadService;
        this.localizeService = this.serviceCache.localizeService;
        this.schemaManager = this.serviceCache.schemaManagerService;
        this.formErrorService = this.serviceCache.formErrorService;
        this.queryId = _queryId;
        this.utils.set('parameter', parameterUtils);
        this.utils.set('schema', schemaUtils);
        this.utils.set('spreadStyle', spreadStyleUtils);
        this.utils.set('renderExtends', renderExtendsUtils);
        this.utils.set('queryId', _queryId);
    }
    /**
     * @param {?} params
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    getData(params, queryRelativeUrl) {
        this.cache.set(this.queryId + 'param', params);
        return this.lcpService.getData(params, queryRelativeUrl);
    }
    /**
     * @param {?} data
     * @param {?} value
     * @return {?}
     */
    changeData(data, value) {
        if (data && data.data && data.dynamicCols && value) {
            if (value.schemaValue.columnOption && value.schemaValue.columnOption.colList && value.schemaValue.columnOption.colList.length) {
                /** @type {?} */
                const columns = value.schemaValue.columnOption.colList.filter((/**
                 * @param {?} x
                 * @return {?}
                 */
                x => x.type === 'enum'));
                if (columns && columns.length > 0) {
                    data.data.forEach((/**
                     * @param {?} x
                     * @return {?}
                     */
                    x => {
                        columns.forEach((/**
                         * @param {?} y
                         * @return {?}
                         */
                        y => {
                            /** @type {?} */
                            const orginValue = x[y.bindField];
                            /** @type {?} */
                            let showValue = orginValue;
                            if (data.resultEnumItems) {
                                /** @type {?} */
                                const resultEnumItem = data.resultEnumItems.find((/**
                                 * @param {?} resultEnumItem
                                 * @return {?}
                                 */
                                resultEnumItem => resultEnumItem.enumName === y.bindField));
                                if (resultEnumItem) {
                                    /** @type {?} */
                                    const findShowValue = resultEnumItem.resultEnumInfoList.find((/**
                                     * @param {?} resultEnum
                                     * @return {?}
                                     */
                                    resultEnum => resultEnum.key === orginValue));
                                    if (findShowValue) {
                                        showValue = y.showType === '0' ? findShowValue.key : y.showType === '1' ? findShowValue.code : findShowValue.name;
                                    }
                                }
                            }
                            x[y.bindField] = showValue;
                        }));
                    }));
                }
            }
        }
    }
    /**
     * 二开人员自定义格式方案处理
     * @param {?} data
     * @param {?} obj
     * @return {?}
     */
    operateCustomFormatSchema(data, obj) {
        if (data.customFormatScheme) {
            obj.customFormatScheme = data.customFormatScheme;
            this.schemaManager.customSchema[obj.groupType ? obj.groupType : obj.queryId] = data.customFormatScheme;
            /** @type {?} */
            let customSchema = null;
            if (obj.schemaId === '1') {
                customSchema = this.schemaManager.mergeCustomSchema(obj.groupType ? obj.groupType : obj.queryId, obj.queryId);
            }
            if (customSchema && customSchema.schemaValue) {
                ServicesUtils.setServices(RtfServices.getTabId(obj.queryId) + 'customScheme', JSON.stringify(customSchema.schemaValue));
            }
        }
    }
    /**
     * 处理分页信息
     * @param {?} obj
     * @param {?} params
     * @return {?}
     */
    operatePagination(obj, params) {
        /** @type {?} */
        const self = this;
        if (obj.controlType === 'list') {
            /** @type {?} */
            let pageSize = 0;
            if (obj.schemaId !== '1' && self.schemaManager.schemaList && self.schemaManager.schemaList[obj.schemaId]) {
                if (typeof self.schemaManager.schemaList[obj.schemaId].schemaValue === "string") {
                    self.schemaManager.schemaList[obj.schemaId].schemaValue = JSON.parse(self.schemaManager.schemaList[obj.schemaId].schemaValue);
                }
                if (self.schemaManager.schemaList[obj.schemaId].schemaValue.otherOption.loadDataType !== 0) {
                    pageSize = self.schemaManager.schemaList[obj.schemaId].schemaValue.otherOption.pageSize;
                }
            }
            else {
                if (obj.schemaId === '1' && self.schemaManager.preSchema && self.schemaManager.preSchema.schemaValue.otherOption.loadDataType !== 0) {
                    pageSize = self.schemaManager.preSchema.schemaValue.otherOption.pageSize;
                }
            }
            if (pageSize !== 0) {
                params['pageSize'] = pageSize;
                params['pageIndex'] = !obj.pageIndex ? 1 : obj.pageIndex;
            }
        }
    }
    /**
     * @param {?} sheet
     * @param {?} data
     * @return {?}
     */
    titleVariablesReplace(sheet, data) {
        /** @type {?} */
        const colCount = sheet.getColumnCount(GC.Spread.Sheets.SheetArea.colHeader);
        /** @type {?} */
        const rowCount = sheet.getRowCount(GC.Spread.Sheets.SheetArea.colHeader);
        if (data && data.variables) {
            for (let r = 0; r < rowCount; r++) {
                for (let c = 0; c < colCount; c++) {
                    sheet.setValue(r, c, this.variablesReplace(sheet.getValue(r, c, GC.Spread.Sheets.SheetArea.colHeader), data), GC.Spread.Sheets.SheetArea.colHeader);
                }
            }
        }
    }
    /**
     * @param {?} sheet
     * @param {?} data
     * @return {?}
     */
    footerVariablesReplace(sheet, data) {
        /** @type {?} */
        const rowCount = sheet.getRowCount();
        /** @type {?} */
        const colCount = sheet.getColumnCount();
        if (this.utils.get('spreadStyle').footerDataArray && this.utils.get('spreadStyle').footerDataArray.length) {
            for (let r = 0; r < this.utils.get('spreadStyle').footerDataArray.length; r++) {
                for (let c = 0; c < colCount; c++) {
                    sheet.setValue(r + (rowCount - this.utils.get('spreadStyle').footerDataArray.length), c, this.variablesReplace(this.utils.get('spreadStyle').footerDataArray[r][c], data));
                }
            }
        }
    }
    /**
     * @private
     * @param {?} cellValue
     * @param {?} data
     * @return {?}
     */
    variablesReplace(cellValue, data) {
        if (data && data.variables) {
            Object.keys(data.variables).forEach((/**
             * @param {?} key
             * @return {?}
             */
            key => {
                /** @type {?} */
                const reg = new RegExp(key, 'g');
                if (cellValue) {
                    cellValue = cellValue.replace(reg, data.variables[key]);
                }
            }));
        }
        return cellValue;
    }
    /**
     * @param {?} spread
     * @param {?} errmsg
     * @return {?}
     */
    errorHandle(spread, errmsg) {
        if (spread.getActiveSheet()) {
            spread.removeSheet(0);
        }
        spread.options.tabStripVisible = false;
        this.msgService.warning(errmsg);
        return;
    }
}
if (false) {
    /** @type {?} */
    BaseRender.prototype.queryId;
    /** @type {?} */
    BaseRender.prototype.type;
    /** @type {?} */
    BaseRender.prototype.utils;
    /** @type {?} */
    BaseRender.prototype.autoFitColumnIndex;
    /** @type {?} */
    BaseRender.prototype.cache;
    /** @type {?} */
    BaseRender.prototype.msgService;
    /** @type {?} */
    BaseRender.prototype.lcpService;
    /** @type {?} */
    BaseRender.prototype.localizeService;
    /** @type {?} */
    BaseRender.prototype.schemaManager;
    /** @type {?} */
    BaseRender.prototype.formErrorService;
    /** @type {?} */
    BaseRender.prototype.loadService;
    /** @type {?} */
    BaseRender.prototype.funcInfoCache;
    /** @type {?} */
    BaseRender.prototype.serviceCache;
    /** @type {?} */
    BaseRender.prototype.isSchemaSelectChanged;
    /** @type {?} */
    BaseRender.prototype.tabId;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1yZW5kZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcWRwL3NwcmVhZC8iLCJzb3VyY2VzIjpbImxpYi9lbmdpbmUvYmFzZS1yZW5kZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUVBLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzlELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFJMUMsTUFBTSxPQUFPLFVBQVU7Ozs7Ozs7O0lBaUJuQixZQUFZLFFBQWEsRUFBRSxZQUFpQixFQUFFLG9CQUEwQixFQUFFLGNBQW9CLEVBQUUsYUFBbUI7UUFkbkgsVUFBSyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7UUFDbEIsdUJBQWtCLEdBQUcsQ0FBQyxDQUFDO1FBVXZCLDBCQUFxQixHQUFHLEtBQUssQ0FBQztRQUkxQixJQUFJLENBQUMsS0FBSyxHQUFHLFdBQVcsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxRQUFRLENBQUM7UUFDeEIsSUFBSSxDQUFDLElBQUksR0FBRyxZQUFZLENBQUM7UUFDekIsSUFBSSxDQUFDLGFBQWEsR0FBRyxjQUFjLENBQUM7UUFDcEMsSUFBSSxDQUFDLFlBQVksR0FBRyxhQUFhLENBQUM7UUFDbEMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsWUFBWSxFQUFFLG9CQUFvQixFQUFFLGNBQWMsQ0FBQyxDQUFDO0lBQ3RGLENBQUM7Ozs7Ozs7OztJQUVPLGNBQWMsQ0FBQyxRQUFhLEVBQUUs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Q2IsMEJBQVU7O0lBQ1YsMkJBQWtCOztJQUNsQix3Q0FBdUI7O0lBQ3ZCLDJCQUFXOztJQUNYLGdDQUFnQjs7SUFDaEIsZ0NBQWdCOztJQUNoQixxQ0FBcUI7O0lBQ3JCLG1DQUFtQjs7SUFDbkIsc0NBQXNCOztJQUN0QixpQ0FBaUI7O0lBQ2pCLG1DQUFtQjs7SUFDbkIsa0NBQWtCOztJQUNsQiwyQ0FBOEI7O0lBQzlCLDJCQUFXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gXCJyeGpzXCI7XHJcbmltcG9ydCB7IFJlbmRlck9wdGlvbiB9IGZyb20gXCIuLi9lbnRpdHkvUmVuZGVyT3B0aW9uXCI7XHJcbmltcG9ydCB7IFBhcmFtZXRlclV0aWxzIH0gZnJvbSBcIi4uL3V0aWwvcGFyYW1ldGVyLnV0aWxzXCI7XHJcbmltcG9ydCB7IFJlbmRlckV4dGVuZHNVdGlscyB9IGZyb20gXCIuLi91dGlsL3JlbmRlci5leHRlbmRzLnV0aWxzXCI7XHJcbmltcG9ydCB7IFNjaGVtYVV0aWxzIH0gZnJvbSBcIi4uL3V0aWwvc2NoZW1hLnV0aWxzXCI7XHJcbmltcG9ydCB7IFNlcnZpY2VzVXRpbHMgfSBmcm9tIFwiLi4vdXRpbC9zZXJ2aWNlcy51dGlsc1wiO1xyXG5pbXBvcnQgeyBTcHJlYWRTdHlsZVV0aWxzIH0gZnJvbSBcIi4uL3V0aWwvc3ByZWFkLnN0eWxlLnV0aWxzXCI7XHJcbmltcG9ydCB7IFJ0ZlNlcnZpY2VzIH0gZnJvbSAnQHFkcC9jb21tb24nO1xyXG5cclxuZGVjbGFyZSB2YXIgR0M6IGFueTtcclxuXHJcbmV4cG9ydCBjbGFzcyBCYXNlUmVuZGVyIHtcclxuICAgIHF1ZXJ5SWQ6IGFueTtcclxuICAgIHR5cGU6IGFueTtcclxuICAgIHV0aWxzID0gbmV3IE1hcCgpO1xyXG4gICAgYXV0b0ZpdENvbHVtbkluZGV4ID0gMDtcclxuICAgIGNhY2hlOiBhbnk7XHJcbiAgICBtc2dTZXJ2aWNlOiBhbnk7XHJcbiAgICBsY3BTZXJ2aWNlOiBhbnk7XHJcbiAgICBsb2NhbGl6ZVNlcnZpY2U6IGFueTtcclxuICAgIHNjaGVtYU1hbmFnZXI6IGFueTtcclxuICAgIGZvcm1FcnJvclNlcnZpY2U6IGFueTtcclxuICAgIGxvYWRTZXJ2aWNlOiBhbnk7XHJcbiAgICBmdW5jSW5mb0NhY2hlOiBhbnk7XHJcbiAgICBzZXJ2aWNlQ2FjaGU6IGFueTtcclxuICAgIGlzU2NoZW1hU2VsZWN0Q2hhbmdlZCA9IGZhbHNlO1xyXG4gICAgdGFiSWQ6IGFueTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihfcXVlcnlJZDogYW55LCBfY29udHJvbFR5cGU6IGFueSwgX2pvaW50c2VhcmNoSW5mb0xpc3Q/OiBhbnksIF9mdW5jSW5mb0NhY2hlPzogYW55LCBfc2VydmljZUNhY2hlPzogYW55KSB7XHJcbiAgICAgICAgdGhpcy50YWJJZCA9IFJ0ZlNlcnZpY2VzLmdldFRhYklkKF9xdWVyeUlkKTtcclxuICAgICAgICB0aGlzLnF1ZXJ5SWQgPSBfcXVlcnlJZDtcclxuICAgICAgICB0aGlzLnR5cGUgPSBfY29udHJvbFR5cGU7XHJcbiAgICAgICAgdGhpcy5mdW5jSW5mb0NhY2hlID0gX2Z1bmNJbmZvQ2FjaGU7XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlQ2FjaGUgPSBfc2VydmljZUNhY2hlO1xyXG4gICAgICAgIHRoaXMuYmFzZVJlbmRlckluaXQoX3F1ZXJ5SWQsIF9jb250cm9sVHlwZSwgX2pvaW50c2VhcmNoSW5mb0xpc3QsIF9mdW5jSW5mb0NhY2hlKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGJhc2VSZW5kZXJJbml0KF9xdWVyeUlkOiBhbnksIF9jb250cm9sVHlwZTogYW55LCBfam9pbnRzZWFyY2hJbmZvTGlzdD86IGFueSwgX2Z1bmNJbmZvQ2FjaGU/OiBhbnkpIHtcclxuICAgICAgICBjb25zdCBwYXJhbWV0ZXJVdGlscyA9IG5ldyBQYXJhbWV0ZXJVdGlscyhfcXVlcnlJZCwgX2Z1bmNJbmZvQ2FjaGUsIHRoaXMuc2VydmljZUNhY2hlKTtcclxuICAgICAgICBjb25zdCBzY2hlbWFVdGlscyA9IG5ldyBTY2hlbWFVdGlscyh0aGlzLnNlcnZpY2VDYWNoZSk7XHJcbiAgICAgICAgY29uc3Qgc3ByZWFkU3R5bGVVdGlscyA9IG5ldyBTcHJlYWRTdHlsZVV0aWxzKF9xdWVyeUlkLCBfY29udHJvbFR5cGUsIF9qb2ludHNlYXJjaEluZm9MaXN0LCB0aGlzLnNlcnZpY2VDYWNoZSk7XHJcbiAgICAgICAgY29uc3QgcmVuZGVyRXh0ZW5kc1V0aWxzID0gbmV3IFJlbmRlckV4dGVuZHNVdGlscyhfcXVlcnlJZCk7XHJcbiAgICAgICAgdGhpcy5tc2dTZXJ2aWNlID0gdGhpcy5zZXJ2aWNlQ2FjaGUubXNnU2VydmljZTsgXHJcbiAgICAgICAgdGhpcy5jYWNoZSA9IHRoaXMuc2VydmljZUNhY2hlLmNhY2hlU2VydmljZTsgXHJcbiAgICAgICAgdGhpcy5sY3BTZXJ2aWNlID0gdGhpcy5zZXJ2aWNlQ2FjaGUubGNwU2VydmljZTsgXHJcbiAgICAgICAgdGhpcy5sb2FkU2VydmljZSA9IHRoaXMuc2VydmljZUNhY2hlLmxvYWRTZXJ2aWNlOyBcclxuICAgICAgICB0aGlzLmxvY2FsaXplU2VydmljZSA9IHRoaXMuc2VydmljZUNhY2hlLmxvY2FsaXplU2VydmljZTsgXHJcbiAgICAgICAgdGhpcy5zY2hlbWFNYW5hZ2VyID0gdGhpcy5zZXJ2aWNlQ2FjaGUuc2NoZW1hTWFuYWdlclNlcnZpY2U7IFxyXG4gICAgICAgIHRoaXMuZm9ybUVycm9yU2VydmljZSA9IHRoaXMuc2VydmljZUNhY2hlLmZvcm1FcnJvclNlcnZpY2U7IFxyXG4gICAgICAgIHRoaXMucXVlcnlJZCA9IF9xdWVyeUlkO1xyXG4gICAgICAgIHRoaXMudXRpbHMuc2V0KCdwYXJhbWV0ZXInLCBwYXJhbWV0ZXJVdGlscyk7XHJcbiAgICAgICAgdGhpcy51dGlscy5zZXQoJ3NjaGVtYScsIHNjaGVtYVV0aWxzKTtcclxuICAgICAgICB0aGlzLnV0aWxzLnNldCgnc3ByZWFkU3R5bGUnLCBzcHJlYWRTdHlsZVV0aWxzKTtcclxuICAgICAgICB0aGlzLnV0aWxzLnNldCgncmVuZGVyRXh0ZW5kcycsIHJlbmRlckV4dGVuZHNVdGlscyk7XHJcbiAgICAgICAgdGhpcy51dGlscy5zZXQoJ3F1ZXJ5SWQnLCBfcXVlcnlJZCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0RGF0YShwYXJhbXM6IGFueSwgcXVlcnlSZWxhdGl2ZVVybDogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgICAgICB0aGlzLmNhY2hlLnNldCh0aGlzLnF1ZXJ5SWQgKyAncGFyYW0nLCBwYXJhbXMpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmxjcFNlcnZpY2UuZ2V0RGF0YShwYXJhbXMsIHF1ZXJ5UmVsYXRpdmVVcmwpO1xyXG4gICAgfVxyXG5cclxuICAgIGNoYW5nZURhdGEoZGF0YTogYW55LCB2YWx1ZTogYW55KSB7XHJcbiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5kYXRhICYmIGRhdGEuZHluYW1pY0NvbHMgJiYgdmFsdWUpIHtcclxuICAgICAgICAgICAgaWYgKHZhbHVlLnNjaGVtYVZhbHVlLmNvbHVtbk9wdGlvbiAmJiB2YWx1ZS5zY2hlbWFWYWx1ZS5jb2x1bW5PcHRpb24uY29sTGlzdCAmJiB2YWx1ZS5zY2hlbWFWYWx1ZS5jb2x1bW5PcHRpb24uY29sTGlzdC5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbHVtbnMgPSB2YWx1ZS5zY2hlbWFWYWx1ZS5jb2x1bW5PcHRpb24uY29sTGlzdC5maWx0ZXIoeCA9PiB4LnR5cGUgPT09ICdlbnVtJyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29sdW1ucyAmJiBjb2x1bW5zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBkYXRhLmRhdGEuZm9yRWFjaCh4ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1ucy5mb3JFYWNoKHkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3JnaW5WYWx1ZSA9IHhbeS5iaW5kRmllbGRdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHNob3dWYWx1ZSA9IG9yZ2luVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5yZXN1bHRFbnVtSXRlbXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXN1bHRFbnVtSXRlbSA9IGRhdGEucmVzdWx0RW51bUl0ZW1zLmZpbmQocmVzdWx0RW51bUl0ZW0gPT4gcmVzdWx0RW51bUl0ZW0uZW51bU5hbWUgPT09IHkuYmluZEZpZWxkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0RW51bUl0ZW0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmluZFNob3dWYWx1ZSA9IHJlc3VsdEVudW1JdGVtLnJlc3VsdEVudW1JbmZvTGlzdC5maW5kKHJlc3VsdEVudW0gPT4gcmVzdWx0RW51bS5rZXkgPT09IG9yZ2luVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmluZFNob3dWYWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvd1ZhbHVlID0geS5zaG93VHlwZSA9PT0gJzAnID8gZmluZFNob3dWYWx1ZS5rZXkgOiB5LnNob3dUeXBlID09PSAnMScgPyBmaW5kU2hvd1ZhbHVlLmNvZGUgOiBmaW5kU2hvd1ZhbHVlLm5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4W3kuYmluZEZpZWxkXSA9IHNob3dWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDkuozlvIDkurrlkZjoh6rlrprkuYnmoLzlvI/mlrnmoYjlpITnkIZcclxuICAgICAqL1xyXG4gICAgb3BlcmF0ZUN1c3RvbUZvcm1hdFNjaGVtYShkYXRhOiBhbnksIG9iajogUmVuZGVyT3B0aW9uKSB7XHJcbiAgICAgICAgaWYgKGRhdGEuY3VzdG9tRm9ybWF0U2NoZW1lKSB7XHJcbiAgICAgICAgICAgIG9iai5jdXN0b21Gb3JtYXRTY2hlbWUgPSBkYXRhLmN1c3RvbUZvcm1hdFNjaGVtZTtcclxuICAgICAgICAgICAgdGhpcy5zY2hlbWFNYW5hZ2VyLmN1c3RvbVNjaGVtYVtvYmouZ3JvdXBUeXBlID8gb2JqLmdyb3VwVHlwZSA6IG9iai5xdWVyeUlkXSA9IGRhdGEuY3VzdG9tRm9ybWF0U2NoZW1lO1xyXG4gICAgICAgICAgICBsZXQgY3VzdG9tU2NoZW1hID0gbnVsbDtcclxuICAgICAgICAgICAgaWYgKG9iai5zY2hlbWFJZCA9PT0gJzEnKSB7XHJcbiAgICAgICAgICAgICAgICBjdXN0b21TY2hlbWEgPSB0aGlzLnNjaGVtYU1hbmFnZXIubWVyZ2VDdXN0b21TY2hlbWEob2JqLmdyb3VwVHlwZSA/IG9iai5ncm91cFR5cGUgOiBvYmoucXVlcnlJZCwgb2JqLnF1ZXJ5SWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChjdXN0b21TY2hlbWEgJiYgY3VzdG9tU2NoZW1hLnNjaGVtYVZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICBTZXJ2aWNlc1V0aWxzLnNldFNlcnZpY2VzKFJ0ZlNlcnZpY2VzLmdldFRhYklkKG9iai5xdWVyeUlkKSArICdjdXN0b21TY2hlbWUnLCBKU09OLnN0cmluZ2lmeShjdXN0b21TY2hlbWEuc2NoZW1hVmFsdWUpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWkhOeQhuWIhumhteS/oeaBr1xyXG4gICAgICovXHJcbiAgICBvcGVyYXRlUGFnaW5hdGlvbihvYmo6IFJlbmRlck9wdGlvbiwgcGFyYW1zOiBhbnkpIHtcclxuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcclxuICAgICAgICBpZiAob2JqLmNvbnRyb2xUeXBlID09PSAnbGlzdCcpIHtcclxuICAgICAgICAgICAgbGV0IHBhZ2VTaXplID0gMDtcclxuICAgICAgICAgICAgaWYgKG9iai5zY2hlbWFJZCAhPT0gJzEnICYmIHNlbGYuc2NoZW1hTWFuYWdlci5zY2hlbWFMaXN0ICYmIHNlbGYuc2NoZW1hTWFuYWdlci5zY2hlbWFMaXN0W29iai5zY2hlbWFJZF0pIHtcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2VsZi5zY2hlbWFNYW5hZ2VyLnNjaGVtYUxpc3Rbb2JqLnNjaGVtYUlkXS5zY2hlbWFWYWx1ZSA9PT0gXCJzdHJpbmdcIikge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbGYuc2NoZW1hTWFuYWdlci5zY2hlbWFMaXN0W29iai5zY2hlbWFJZF0uc2NoZW1hVmFsdWUgPSBKU09OLnBhcnNlKHNlbGYuc2NoZW1hTWFuYWdlci5zY2hlbWFMaXN0W29iai5zY2hlbWFJZF0uc2NoZW1hVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHNlbGYuc2NoZW1hTWFuYWdlci5zY2hlbWFMaXN0W29iai5zY2hlbWFJZF0uc2NoZW1hVmFsdWUub3RoZXJPcHRpb24ubG9hZERhdGFUeXBlICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGFnZVNpemUgPSBzZWxmLnNjaGVtYU1hbmFnZXIuc2NoZW1hTGlzdFtvYmouc2NoZW1hSWRdLnNjaGVtYVZhbHVlLm90aGVyT3B0aW9uLnBhZ2VTaXplO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKG9iai5zY2hlbWFJZCA9PT0gJzEnICYmIHNlbGYuc2NoZW1hTWFuYWdlci5wcmVTY2hlbWEgJiYgc2VsZi5zY2hlbWFNYW5hZ2VyLnByZVNjaGVtYS5zY2hlbWFWYWx1ZS5vdGhlck9wdGlvbi5sb2FkRGF0YVR5cGUgIT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBwYWdlU2l6ZSA9IHNlbGYuc2NoZW1hTWFuYWdlci5wcmVTY2hlbWEuc2NoZW1hVmFsdWUub3RoZXJPcHRpb24ucGFnZVNpemU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHBhZ2VTaXplICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICBwYXJhbXNbJ3BhZ2VTaXplJ10gPSBwYWdlU2l6ZTtcclxuICAgICAgICAgICAgICAgIHBhcmFtc1sncGFnZUluZGV4J10gPSAhb2JqLnBhZ2VJbmRleCA/IDEgOiBvYmoucGFnZUluZGV4O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHRpdGxlVmFyaWFibGVzUmVwbGFjZShzaGVldDogYW55LCBkYXRhOiBhbnkpIHtcclxuICAgICAgICBjb25zdCBjb2xDb3VudCA9IHNoZWV0LmdldENvbHVtbkNvdW50KEdDLlNwcmVhZC5TaGVldHMuU2hlZXRBcmVhLmNvbEhlYWRlcik7XHJcbiAgICAgICAgY29uc3Qgcm93Q291bnQgPSBzaGVldC5nZXRSb3dDb3VudChHQy5TcHJlYWQuU2hlZXRzLlNoZWV0QXJlYS5jb2xIZWFkZXIpO1xyXG4gICAgICAgIGlmIChkYXRhICYmIGRhdGEudmFyaWFibGVzKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IHIgPSAwOyByIDwgcm93Q291bnQ7IHIrKykge1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgYyA9IDA7IGMgPCBjb2xDb3VudDsgYysrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2hlZXQuc2V0VmFsdWUociwgYyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52YXJpYWJsZXNSZXBsYWNlKHNoZWV0LmdldFZhbHVlKHIsIGMsIEdDLlNwcmVhZC5TaGVldHMuU2hlZXRBcmVhLmNvbEhlYWRlciksIGRhdGEpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBHQy5TcHJlYWQuU2hlZXRzLlNoZWV0QXJlYS5jb2xIZWFkZXIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZvb3RlclZhcmlhYmxlc1JlcGxhY2Uoc2hlZXQ6IGFueSwgZGF0YTogYW55KSB7XHJcbiAgICAgICAgY29uc3Qgcm93Q291bnQgPSBzaGVldC5nZXRSb3dDb3VudCgpO1xyXG4gICAgICAgIGNvbnN0IGNvbENvdW50ID0gc2hlZXQuZ2V0Q29sdW1uQ291bnQoKTtcclxuICAgICAgICBpZiAodGhpcy51dGlscy5nZXQoJ3NwcmVhZFN0eWxlJykuZm9vdGVyRGF0YUFycmF5ICYmIHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLmZvb3RlckRhdGFBcnJheS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgciA9IDA7IHIgPCB0aGlzLnV0aWxzLmdldCgnc3ByZWFkU3R5bGUnKS5mb290ZXJEYXRhQXJyYXkubGVuZ3RoOyByKyspIHtcclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgY29sQ291bnQ7IGMrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIHNoZWV0LnNldFZhbHVlKHIgKyAocm93Q291bnQgLSB0aGlzLnV0aWxzLmdldCgnc3ByZWFkU3R5bGUnKS5mb290ZXJEYXRhQXJyYXkubGVuZ3RoKSwgYyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52YXJpYWJsZXNSZXBsYWNlKHRoaXMudXRpbHMuZ2V0KCdzcHJlYWRTdHlsZScpLmZvb3RlckRhdGFBcnJheVtyXVtjXSwgZGF0YSkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdmFyaWFibGVzUmVwbGFjZShjZWxsVmFsdWU6IGFueSwgZGF0YTogYW55KSB7XHJcbiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS52YXJpYWJsZXMpIHtcclxuICAgICAgICAgICAgT2JqZWN0LmtleXMoZGF0YS52YXJpYWJsZXMpLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlZyA9IG5ldyBSZWdFeHAoa2V5LCAnZycpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNlbGxWYWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNlbGxWYWx1ZSA9IGNlbGxWYWx1ZS5yZXBsYWNlKHJlZywgZGF0YS52YXJpYWJsZXNba2V5XSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gY2VsbFZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIGVycm9ySGFuZGxlKHNwcmVhZDogYW55LCBlcnJtc2c6IGFueSkge1xyXG4gICAgICAgIGlmIChzcHJlYWQuZ2V0QWN0aXZlU2hlZXQoKSkge1xyXG4gICAgICAgICAgICBzcHJlYWQucmVtb3ZlU2hlZXQoMCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHNwcmVhZC5vcHRpb25zLnRhYlN0cmlwVmlzaWJsZSA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMubXNnU2VydmljZS53YXJuaW5nKGVycm1zZyk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG59Il19