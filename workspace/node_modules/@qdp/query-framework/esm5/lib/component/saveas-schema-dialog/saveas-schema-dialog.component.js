/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ViewChild, Injector, LOCALE_ID, Input } from '@angular/core';
import { DialogComponent } from '@farris/ui-dialog';
import { LocalizeService, DEFAULT_LANGUAGE } from '@qdp/localize';
import { EventBus } from '@qdp/common';
import { ConditionSchemaService } from '@qdp/condition-schema';
import { MessagerService } from '@farris/ui-messager';
import { NotifyService } from '@farris/ui-notify';
import { Repository } from '@farris/devkit';
import { FormErrorService } from '@farris/command-services';
var SaveasSchemaDialogComponent = /** @class */ (function () {
    function SaveasSchemaDialogComponent(injector, msgService, conditionService, notifyService) {
        this.injector = injector;
        this.msgService = msgService;
        this.conditionService = conditionService;
        this.notifyService = notifyService;
        this.formInline = true;
        this.conditionSchemaName = 'conditionSchemaName' + EventBus.guid();
        this.schemaName = '';
        this.isDefault = false;
        this.isSchemaType = 0;
        this.publicSchema = 'publicSchema' + EventBus.guid();
        this.personSchema = 'personSchema' + EventBus.guid();
        this.defaultSchema = 'defaultSchema' + EventBus.guid();
        if (this.injector) {
            this.localizeService = this.injector.get(LocalizeService);
            this.localId = this.injector.get(LOCALE_ID) || DEFAULT_LANGUAGE;
            this.formInline = this.localId.toLowerCase() === DEFAULT_LANGUAGE;
            this.repository = this.injector.get(Repository);
            this.formErrorService = this.injector.get(FormErrorService);
        }
    }
    /**
     * @return {?}
     */
    SaveasSchemaDialogComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    SaveasSchemaDialogComponent.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        /** @type {?} */
        var self = this;
        for (var changeName in changes) {
            /** @type {?} */
            var newValue = changes[changeName].currentValue;
            if (newValue !== null && newValue !== void 0) {
                switch (changeName) {
                    case 'currentSchema':
                        break;
                }
            }
        }
    };
    /**
     * @return {?}
     */
    SaveasSchemaDialogComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @return {?}
     */
    SaveasSchemaDialogComponent.prototype.handleDialogShow = /**
     * @return {?}
     */
    function () {
        this.farrisDialog.show();
    };
    /**
     * @return {?}
     */
    SaveasSchemaDialogComponent.prototype.handleOKClick = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var self = this;
        /** @type {?} */
        var data = this.conditionService.schemaList;
        if (!this.schemaName) {
            this.msgService.warning(this.localizeService.getValue('queryFramework.message.validate.notNull'));
            return;
        }
        if (this.schemaName && this.schemaName.length > 15) {
            this.msgService.warning(this.localizeService.getValue('queryFramework.message.lengthValidate'));
            return;
        }
        if (data && data[this.queryId]) {
            for (var key in data[self.queryId]) {
                if (data[self.queryId][key].schemaName === self.schemaName) {
                    this.msgService.warning(this.localizeService.getValue('queryFramework.message.saveas'));
                    return;
                }
            }
        }
        /** @type {?} */
        var params = this.handlerGetEntity();
        if (this.currentSchema && this.currentSchema.id) {
            for (var key in data[self.queryId]) {
                if (data[self.queryId][key].schemaName === self.schemaName) {
                    this.msgService.warning(this.localizeService.getValue('queryFramework.message.saveas'));
                    return;
                }
            }
            /** @type {?} */
            var newValue = JSON.parse(JSON.stringify(this.currentSchema));
            newValue.schemaValue = params;
            newValue.id = '';
            newValue.queryId = self.queryId;
            if (this.filterInstance) {
                if (!newValue.schemaValue) {
                    newValue.schemaValue = {};
                }
                newValue.schemaValue['@filterExpressionString@'] = this.filterInstance.getFilterExpression();
            }
            newValue.schemaValue = newValue.schemaValue ? JSON.stringify(newValue.schemaValue) : null;
            newValue.schemaName = self.schemaName;
            newValue.isDefault = self.isDefault ? 1 : 0;
            newValue.schemaType = self.isSchemaType;
            this.conditionService.saveSchema(newValue).subscribe((/**
             * @return {?}
             */
            function () {
                self.notifyService['success']((/** @type {?} */ ({
                    title: self.localizeService.getValue('queryFramework.message.info.title'), msg: self.localizeService.getValue('queryFramework.message.save.success'), timeout: 3000
                })));
                self.farrisDialog.close();
            }), (/**
             * @param {?} error
             * @return {?}
             */
            function (error) {
                self.formErrorService.exception(error.Message, error);
            }));
        }
        else {
            /** @type {?} */
            var newValue = {
                schemaName: self.schemaName,
                schemaType: self.isSchemaType,
                schemaValue: null,
                isDefault: self.isDefault ? 1 : 0,
                isProtected: 0,
                queryId: self.queryId
            };
            newValue.schemaValue = params;
            if (this.filterInstance) {
                if (!newValue.schemaValue) {
                    newValue.schemaValue = {};
                }
                newValue.schemaValue['@filterExpressionString@'] = this.filterInstance.getFilterExpression();
            }
            newValue.schemaValue = newValue.schemaValue ? JSON.stringify(newValue.schemaValue) : null;
            this.conditionService.saveSchema(newValue).subscribe((/**
             * @return {?}
             */
            function () {
                self.notifyService['success']((/** @type {?} */ ({
                    title: self.localizeService.getValue('queryFramework.message.info.title'), msg: self.localizeService.getValue('queryFramework.message.save.success'), timeout: 3000
                })));
                self.farrisDialog.close();
            }), (/**
             * @param {?} error
             * @return {?}
             */
            function (error) {
                self.formErrorService.exception(error.Message, error);
            }));
        }
    };
    /**
     * @return {?}
     */
    SaveasSchemaDialogComponent.prototype.handleCancelClick = /**
     * @return {?}
     */
    function () {
        this.schemaName = '';
        this.isDefault = false;
        this.isSchemaType = 0;
        this.farrisDialog.close();
    };
    /**
     * @param {?} value
     * @return {?}
     */
    SaveasSchemaDialogComponent.prototype.handleSchemaTypeSelect = /**
     * @param {?} value
     * @return {?}
     */
    function (value) {
        this.isSchemaType = value;
    };
    /**
     * @return {?}
     */
    SaveasSchemaDialogComponent.prototype.handlerGetEntity = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var entitys = this.repository.entityCollection.getAllEntities();
        /** @type {?} */
        var params;
        if (entitys && entitys.length) {
            params = entitys[0].toJSON();
        }
        return params;
    };
    SaveasSchemaDialogComponent.decorators = [
        { type: Component, args: [{
                    selector: 'saveas-schema-dialog',
                    template: "<farris-dialog #farrisDialog [title]=\"localizeService.getValue('queryFramework.dialogTitle2')\" [showButtons]=\"false\"\r\n  [width]=\"509\" [showMaxButton]=\"false\" [showCloseButton]=\"false\" [showMinButton]=\"false\" [resizable]=\"false\" [height]=\"285\">\r\n  <div class=\"f-utils-absolute-all f-utils-flex-column bg-white\">\r\n    <div class=\"f-utils-fill-flex-column\">\r\n      <div class=\"f-utils-flex-row pt-2\">\r\n        <div class=\"farris-group-wrap form-inline farris-form-inline\">\r\n          <div class=\"form-group farris-form-group\">\r\n            <label class=\"col-form-label\" for=\"colName\">\r\n              <span class=\"farris-label-info text-danger\">*</span>\r\n              <span class=\"farris-label-text\">{{localizeService.getValue('queryFramework.schemaName')}}:</span>\r\n            </label>\r\n            <div class=\"farris-input-wrap\">\r\n              <input-group id=\"colName\" [(ngModel)]=\"schemaName\"></input-group>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      <!-- <div class=\"f-utils-flex-row\">\r\n        <div class=\"farris-group-wrap form-inline farris-form-inline\">\r\n          <div class=\"form-group farris-form-group\">\r\n            <label class=\"col-form-label\" for=\"colVisible\">\r\n              <span class=\"farris-label-text\"></span>\r\n            </label>\r\n            <div class=\"farris-input-wrap farris-checkradio-hor\">\r\n              <div class=\"custom-control custom-checkbox mb-0\">\r\n                <input type=\"checkbox\" [(ngModel)]=\"isDefault\" class=\"custom-control-input\" id=\"{{conditionSchemaName}}\"\r\n                  checked=\"\">\r\n                <label class=\"custom-control-label\"\r\n                  for=\"{{conditionSchemaName}}\">{{localizeService.getValue('queryFramework.defaultSchemaName')}}</label>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div> -->\r\n      <div class=\"f-utils-flex-row pt-2\">\r\n        <div class=\"farris-group-wrap form-inline farris-form-inline m-1\">\r\n          <div class=\"form-group farris-group-wrap\">\r\n            <label class=\"col-form-label\" style=\"min-width: 0;\" for=\"range_type_id\">\r\n              <span class=\"farris-label-text\">{{localizeService.getValue('ideCmp.schemaManager.schemeType')}}:</span>\r\n            </label>\r\n            <div class=\"farris-input-wrap farris-checkradio-hor\">\r\n              <div class=\"custom-control custom-radio mb-0\">\r\n                <input type=\"radio\" id=\"{{publicSchema}}\" name=\"custom-radio1\" class=\"custom-control-input\"\r\n                  [checked]=\"isSchemaType==0\">\r\n                <label class=\"custom-control-label\" for=\"{{publicSchema}}\"\r\n                  (click)=\"handleSchemaTypeSelect(0)\">{{localizeService.getValue('ideCmp.schemaManager.schemeTypePublic')}}</label>\r\n              </div>\r\n              <div class=\"custom-control custom-radio mb-0\">\r\n                <input type=\"radio\" id=\"{{personSchema}}\" name=\"custom-radio1\" class=\"custom-control-input\"\r\n                  [checked]=\"isSchemaType==1\">\r\n                <label class=\"custom-control-label\" for=\"{{personSchema}}\"\r\n                  (click)=\"handleSchemaTypeSelect(1)\">{{localizeService.getValue('ideCmp.schemaManager.schemeTypePersonal')}}</label>\r\n              </div>\r\n              <div class=\"custom-control custom-checkbox mb-0\">\r\n                <input type=\"checkbox\" class=\"custom-control-input\" id=\"{{defaultSchema}}\"\r\n                  [(ngModel)]=\"isDefault\">\r\n                <label class=\"custom-control-label\"\r\n                  for=\"{{defaultSchema}}\">{{localizeService.getValue('ideCmp.schemaManager.schemeDefault')}}</label>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    <div class=\"modal-footer\">\r\n      <div class=\"btn-toolbar btn-group-lg\" id=\"page-header-toolbar\">\r\n        <button class=\"btn btn-primary mr-1\" id=\"button-edit\" (click)=\"handleOKClick()\">\r\n          {{localizeService.getValue('queryFramework.btnOk')}}</button>\r\n        <button class=\"btn btn-secondary mr-1\" id=\"button-edit\" (click)=\"handleCancelClick()\">\r\n          {{localizeService.getValue('queryFramework.btnCancel')}}</button>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</farris-dialog>\r\n",
                    styles: [""]
                }] }
    ];
    /** @nocollapse */
    SaveasSchemaDialogComponent.ctorParameters = function () { return [
        { type: Injector },
        { type: MessagerService },
        { type: ConditionSchemaService },
        { type: NotifyService }
    ]; };
    SaveasSchemaDialogComponent.propDecorators = {
        currentSchema: [{ type: Input }],
        queryId: [{ type: Input }],
        farrisDialog: [{ type: ViewChild, args: ['farrisDialog',] }]
    };
    return SaveasSchemaDialogComponent;
}());
export { SaveasSchemaDialogComponent };
if (false) {
    /** @type {?} */
    SaveasSchemaDialogComponent.prototype.currentSchema;
    /** @type {?} */
    SaveasSchemaDialogComponent.prototype.queryId;
    /** @type {?} */
    SaveasSchemaDialogComponent.prototype.farrisDialog;
    /** @type {?} */
    SaveasSchemaDialogComponent.prototype.localizeService;
    /** @type {?} */
    SaveasSchemaDialogComponent.prototype.formInline;
    /** @type {?} */
    SaveasSchemaDialogComponent.prototype.localId;
    /** @type {?} */
    SaveasSchemaDialogComponent.prototype.conditionSchemaName;
    /** @type {?} */
    SaveasSchemaDialogComponent.prototype.schemaName;
    /** @type {?} */
    SaveasSchemaDialogComponent.prototype.isDefault;
    /** @type {?} */
    SaveasSchemaDialogComponent.prototype.isSchemaType;
    /** @type {?} */
    SaveasSchemaDialogComponent.prototype.publicSchema;
    /** @type {?} */
    SaveasSchemaDialogComponent.prototype.personSchema;
    /** @type {?} */
    SaveasSchemaDialogComponent.prototype.defaultSchema;
    /**
     * @type {?}
     * @private
     */
    SaveasSchemaDialogComponent.prototype.repository;
    /** @type {?} */
    SaveasSchemaDialogComponent.prototype.formErrorService;
    /** @type {?} */
    SaveasSchemaDialogComponent.prototype.filterInstance;
    /**
     * @type {?}
     * @private
     */
    SaveasSchemaDialogComponent.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    SaveasSchemaDialogComponent.prototype.msgService;
    /**
     * @type {?}
     * @private
     */
    SaveasSchemaDialogComponent.prototype.conditionService;
    /**
     * @type {?}
     * @private
     */
    SaveasSchemaDialogComponent.prototype.notifyService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2F2ZWFzLXNjaGVtYS1kaWFsb2cuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHFkcC9xdWVyeS1mcmFtZXdvcmsvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50L3NhdmVhcy1zY2hlbWEtZGlhbG9nL3NhdmVhcy1zY2hlbWEtZGlhbG9nLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxTQUFTLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBNEIsS0FBSyxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBQzlILE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsZUFBZSxFQUFFLGdCQUFnQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2xFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkMsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDL0QsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxhQUFhLEVBQWlCLE1BQU0sbUJBQW1CLENBQUM7QUFDakUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRTVEO0lBdUJFLHFDQUNVLFFBQWtCLEVBQ2xCLFVBQTJCLEVBQzNCLGdCQUF3QyxFQUN4QyxhQUE0QjtRQUg1QixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLGVBQVUsR0FBVixVQUFVLENBQWlCO1FBQzNCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBd0I7UUFDeEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFqQnRDLGVBQVUsR0FBRyxJQUFJLENBQUM7UUFFbEIsd0JBQW1CLEdBQUcscUJBQXFCLEdBQUcsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFD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QUM7SUFDNUIsQ0FBQzs7Ozs7SUFFRCw0REFBc0I7Ozs7SUFBdEIsVUFBdUIsS0FBVTtRQUMvQixJQUFJLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQztJQUM1QixDQUFDOzs7O0lBRUQsc0RBQWdCOzs7SUFBaEI7O1lBQ1EsT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxFQUFFOztZQUM3RCxNQUFNO1FBQ1YsSUFBSSxPQUFPLElBQUksT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUM3QixNQUFNLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQzlCO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQzs7Z0JBeEpGLFNBQVMsU0FBQztvQkFDVCxRQUFRLEVBQUUsc0JBQXNCO29CQUNoQywyNElBQW9EOztpQkFFckQ7Ozs7Z0JBZHNDLFFBQVE7Z0JBS3RDLGVBQWU7Z0JBRGYsc0JBQXNCO2dCQUV0QixhQUFhOzs7Z0NBVW5CLEtBQUs7MEJBQ0wsS0FBSzsrQkFDTCxTQUFTLFNBQUMsY0FBYzs7SUFpSjNCLGtDQUFDO0NBQUEsQUF6SkQsSUF5SkM7U0FwSlksMkJBQTJCOzs7SUFDdEMsb0RBQTRCOztJQUM1Qiw4Q0FBc0I7O0lBQ3RCLG1EQUF5RDs7SUFDekQsc0RBQXFCOztJQUNyQixpREFBa0I7O0lBQ2xCLDhDQUFhOztJQUNiLDBEQUE4RDs7SUFDOUQsaURBQXFCOztJQUNyQixnREFBa0I7O0lBQ2xCLG1EQUFpQjs7SUFDakIsbURBQWdEOztJQUNoRCxtREFBZ0Q7O0lBQ2hELG9EQUFrRDs7Ozs7SUFDbEQsaURBQXdCOztJQUN4Qix1REFBc0I7O0lBQ3RCLHFEQUFvQjs7Ozs7SUFHbEIsK0NBQTBCOzs7OztJQUMxQixpREFBbUM7Ozs7O0lBQ25DLHVEQUFnRDs7Ozs7SUFDaEQsb0RBQW9DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIFZpZXdDaGlsZCwgSW5qZWN0b3IsIExPQ0FMRV9JRCwgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzLCBJbnB1dCwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IERpYWxvZ0NvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktZGlhbG9nJztcclxuaW1wb3J0IHsgTG9jYWxpemVTZXJ2aWNlLCBERUZBVUxUX0xBTkdVQUdFIH0gZnJvbSAnQHFkcC9sb2NhbGl6ZSc7XHJcbmltcG9ydCB7IEV2ZW50QnVzIH0gZnJvbSAnQHFkcC9jb21tb24nO1xyXG5pbXBvcnQgeyBDb25kaXRpb25TY2hlbWFTZXJ2aWNlIH0gZnJvbSAnQHFkcC9jb25kaXRpb24tc2NoZW1hJztcclxuaW1wb3J0IHsgTWVzc2FnZXJTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1tZXNzYWdlcic7XHJcbmltcG9ydCB7IE5vdGlmeVNlcnZpY2UsIE5vdGlmeU9wdGlvbnMgfSBmcm9tICdAZmFycmlzL3VpLW5vdGlmeSc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IEZvcm1FcnJvclNlcnZpY2UgfSBmcm9tICdAZmFycmlzL2NvbW1hbmQtc2VydmljZXMnO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdzYXZlYXMtc2NoZW1hLWRpYWxvZycsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL3NhdmVhcy1zY2hlbWEtZGlhbG9nLmNvbXBvbmVudC5odG1sJyxcclxuICBzdHlsZVVybHM6IFsnLi9zYXZlYXMtc2NoZW1hLWRpYWxvZy5jb21wb25lbnQuY3NzJ11cclxufSlcclxuZXhwb3J0IGNsYXNzIFNhdmVhc1NjaGVtYURpYWxvZ0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95LCBPbkNoYW5nZXMge1xyXG4gIEBJbnB1dCgpIGN1cnJlbnRTY2hlbWE6IGFueTtcclxuICBASW5wdXQoKSBxdWVyeUlkOiBhbnk7XHJcbiAgQFZpZXdDaGlsZCgnZmFycmlzRGlhbG9nJykgZmFycmlzRGlhbG9nOiBEaWFsb2dDb21wb25lbnQ7XHJcbiAgbG9jYWxpemVTZXJ2aWNlOiBhbnk7XHJcbiAgZm9ybUlubGluZSA9IHRydWU7XHJcbiAgbG9jYWxJZDogYW55O1xyXG4gIGNvbmRpdGlvblNjaGVtYU5hbWUgPSAnY29uZGl0aW9uU2NoZW1hTmFtZScgKyBFdmVudEJ1cy5ndWlkKCk7XHJcbiAgc2NoZW1hTmFtZTogYW55ID0gJyc7XHJcbiAgaXNEZWZhdWx0ID0gZmFsc2U7XHJcbiAgaXNTY2hlbWFUeXBlID0gMDtcclxuICBwdWJsaWNTY2hlbWEgPSAncHVibGljU2NoZW1hJyArIEV2ZW50QnVzLmd1aWQoKTtcclxuICBwZXJzb25TY2hlbWEgPSAncGVyc29uU2NoZW1hJyArIEV2ZW50QnVzLmd1aWQoKTtcclxuICBkZWZhdWx0U2NoZW1hID0gJ2RlZmF1bHRTY2hlbWEnICsgRXZlbnRCdXMuZ3VpZCgpO1xyXG4gIHByaXZhdGUgcmVwb3NpdG9yeTogYW55O1xyXG4gIGZvcm1FcnJvclNlcnZpY2U6IGFueTtcclxuICBmaWx0ZXJJbnN0YW5jZTogYW55O1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxyXG4gICAgcHJpdmF0ZSBtc2dTZXJ2aWNlOiBNZXNzYWdlclNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGNvbmRpdGlvblNlcnZpY2U6IENvbmRpdGlvblNjaGVtYVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIG5vdGlmeVNlcnZpY2U6IE5vdGlmeVNlcnZpY2UpIHtcclxuICAgIGlmICh0aGlzLmluamVjdG9yKSB7XHJcbiAgICAgIHRoaXMubG9jYWxpemVTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQoTG9jYWxpemVTZXJ2aWNlKTtcclxuICAgICAgdGhpcy5sb2NhbElkID0gdGhpcy5pbmplY3Rvci5nZXQoTE9DQUxFX0lEKSB8fCBERUZBVUxUX0xBTkdVQUdFO1xyXG4gICAgICB0aGlzLmZvcm1JbmxpbmUgPSB0aGlzLmxvY2FsSWQudG9Mb3dlckNhc2UoKSA9PT0gREVGQVVMVF9MQU5HVUFHRTtcclxuICAgICAgdGhpcy5yZXBvc2l0b3J5ID0gdGhpcy5pbmplY3Rvci5nZXQoUmVwb3NpdG9yeSk7XHJcbiAgICAgIHRoaXMuZm9ybUVycm9yU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KEZvcm1FcnJvclNlcnZpY2UpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgfVxyXG5cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XHJcbiAgICBjb25zdCBzZWxmID0gdGhpcztcclxuICAgIGZvciAoY29uc3QgY2hhbmdlTmFtZSBpbiBjaGFuZ2VzKSB7XHJcbiAgICAgIGNvbnN0IG5ld1ZhbHVlID0gY2hhbmdlc1tjaGFuZ2VOYW1lXS5jdXJyZW50VmFsdWU7XHJcbiAgICAgIGlmIChuZXdWYWx1ZSAhPT0gbnVsbCAmJiBuZXdWYWx1ZSAhPT0gdm9pZCAwKSB7XHJcbiAgICAgICAgc3dpdGNoIChjaGFuZ2VOYW1lKSB7XHJcbiAgICAgICAgICBjYXNlICdjdXJyZW50U2NoZW1hJzpcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpIHtcclxuXHJcbiAgfVxyXG5cclxuICBoYW5kbGVEaWFsb2dTaG93KCkge1xyXG4gICAgdGhpcy5mYXJyaXNEaWFsb2cuc2hvdygpO1xyXG4gIH1cclxuXHJcbiAgaGFuZGxlT0tDbGljaygpIHtcclxuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgY29uc3QgZGF0YSA9IHRoaXMuY29uZGl0aW9uU2VydmljZS5zY2hlbWFMaXN0O1xyXG4gICAgaWYgKCF0aGlzLnNjaGVtYU5hbWUpIHtcclxuICAgICAgdGhpcy5tc2dTZXJ2aWNlLndhcm5pbmcodGhpcy5sb2NhbGl6ZVNlcnZpY2UuZ2V0VmFsdWUoJ3F1ZXJ5RnJhbWV3b3JrLm1lc3NhZ2UudmFsaWRhdGUubm90TnVsbCcpKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuc2NoZW1hTmFtZSAmJiB0aGlzLnNjaGVtYU5hbWUubGVuZ3RoID4gMTUpIHtcclxuICAgICAgdGhpcy5tc2dTZXJ2aWNlLndhcm5pbmcodGhpcy5sb2NhbGl6ZVNlcnZpY2UuZ2V0VmFsdWUoJ3F1ZXJ5RnJhbWV3b3JrLm1lc3NhZ2UubGVuZ3RoVmFsaWRhdGUnKSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmIChkYXRhICYmIGRhdGFbdGhpcy5xdWVyeUlkXSkge1xyXG4gICAgICBmb3IgKGNvbnN0IGtleSBpbiBkYXRhW3NlbGYucXVlcnlJZF0pIHtcclxuICAgICAgICBpZiAoZGF0YVtzZWxmLnF1ZXJ5SWRdW2tleV0uc2NoZW1hTmFtZSA9PT0gc2VsZi5zY2hlbWFOYW1lKSB7XHJcbiAgICAgICAgICB0aGlzLm1zZ1NlcnZpY2Uud2FybmluZyh0aGlzLmxvY2FsaXplU2VydmljZS5nZXRWYWx1ZSgncXVlcnlGcmFtZXdvcmsubWVzc2FnZS5zYXZlYXMnKSk7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXJhbXMgPSB0aGlzLmhhbmRsZXJHZXRFbnRpdHkoKTtcclxuICAgIGlmICh0aGlzLmN1cnJlbnRTY2hlbWEgJiYgdGhpcy5jdXJyZW50U2NoZW1hLmlkKSB7XHJcbiAgICAgIGZvciAoY29uc3Qga2V5IGluIGRhdGFbc2VsZi5xdWVyeUlkXSkge1xyXG4gICAgICAgIGlmIChkYXRhW3NlbGYucXVlcnlJZF1ba2V5XS5zY2hlbWFOYW1lID09PSBzZWxmLnNjaGVtYU5hbWUpIHtcclxuICAgICAgICAgIHRoaXMubXNnU2VydmljZS53YXJuaW5nKHRoaXMubG9jYWxpemVTZXJ2aWNlLmdldFZhbHVlKCdxdWVyeUZyYW1ld29yay5tZXNzYWdlLnNhdmVhcycpKTtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgbmV3VmFsdWUgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMuY3VycmVudFNjaGVtYSkpO1xyXG4gICAgICBuZXdWYWx1ZS5zY2hlbWFWYWx1ZSA9IHBhcmFtcztcclxuICAgICAgbmV3VmFsdWUuaWQgPSAnJztcclxuICAgICAgbmV3VmFsdWUucXVlcnlJZCA9IHNlbGYucXVlcnlJZDtcclxuICAgICAgaWYgKHRoaXMuZmlsdGVySW5zdGFuY2UpIHtcclxuICAgICAgICBpZiAoIW5ld1ZhbHVlLnNjaGVtYVZhbHVlKSB7IG5ld1ZhbHVlLnNjaGVtYVZhbHVlID0ge307IH1cclxuICAgICAgICBuZXdWYWx1ZS5zY2hlbWFWYWx1ZVsnQGZpbHRlckV4cHJlc3Npb25TdHJpbmdAJ10gPSB0aGlzLmZpbHRlckluc3RhbmNlLmdldEZpbHRlckV4cHJlc3Npb24oKTtcclxuICAgICAgfVxyXG4gICAgICBuZXdWYWx1ZS5zY2hlbWFWYWx1ZSA9IG5ld1ZhbHVlLnNjaGVtYVZhbHVlID8gSlNPTi5zdHJpbmdpZnkobmV3VmFsdWUuc2NoZW1hVmFsdWUpIDogbnVsbDtcclxuICAgICAgbmV3VmFsdWUuc2NoZW1hTmFtZSA9IHNlbGYuc2NoZW1hTmFtZTtcclxuICAgICAgbmV3VmFsdWUuaXNEZWZhdWx0ID0gc2VsZi5pc0RlZmF1bHQgPyAxIDogMDtcclxuICAgICAgbmV3VmFsdWUuc2NoZW1hVHlwZSA9IHNlbGYuaXNTY2hlbWFUeXBlO1xyXG4gICAgICB0aGlzLmNvbmRpdGlvblNlcnZpY2Uuc2F2ZVNjaGVtYShuZXdWYWx1ZSkuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICBzZWxmLm5vdGlmeVNlcnZpY2VbJ3N1Y2Nlc3MnXSh7XHJcbiAgICAgICAgICB0aXRsZTogc2VsZi5sb2NhbGl6ZVNlcnZpY2UuZ2V0VmFsdWUoJ3F1ZXJ5RnJhbWV3b3JrLm1lc3NhZ2UuaW5mby50aXRsZScpLCBtc2c6IHNlbGYubG9jYWxpemVTZXJ2aWNlLmdldFZhbHVlKCdxdWVyeUZyYW1ld29yay5tZXNzYWdlLnNhdmUuc3VjY2VzcycpLCB0aW1lb3V0OiAzMDAwXHJcbiAgICAgICAgfSBhcyBOb3RpZnlPcHRpb25zKTtcclxuICAgICAgICBzZWxmLmZhcnJpc0RpYWxvZy5jbG9zZSgpO1xyXG4gICAgICB9LCAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgIHNlbGYuZm9ybUVycm9yU2VydmljZS5leGNlcHRpb24oZXJyb3IuTWVzc2FnZSwgZXJyb3IpO1xyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IG5ld1ZhbHVlID0ge1xyXG4gICAgICAgIHNjaGVtYU5hbWU6IHNlbGYuc2NoZW1hTmFtZSxcclxuICAgICAgICBzY2hlbWFUeXBlOiBzZWxmLmlzU2NoZW1hVHlwZSxcclxuICAgICAgICBzY2hlbWFWYWx1ZTogbnVsbCxcclxuICAgICAgICBpc0RlZmF1bHQ6IHNlbGYuaXNEZWZhdWx0ID8gMSA6IDAsXHJcbiAgICAgICAgaXNQcm90ZWN0ZWQ6IDAsXHJcbiAgICAgICAgcXVlcnlJZDogc2VsZi5xdWVyeUlkXHJcbiAgICAgIH07XHJcbiAgICAgIG5ld1ZhbHVlLnNjaGVtYVZhbHVlID0gcGFyYW1zO1xyXG4gICAgICBpZiAodGhpcy5maWx0ZXJJbnN0YW5jZSkge1xyXG4gICAgICAgIGlmICghbmV3VmFsdWUuc2NoZW1hVmFsdWUpIHsgbmV3VmFsdWUuc2NoZW1hVmFsdWUgPSB7fTsgfVxyXG4gICAgICAgIG5ld1ZhbHVlLnNjaGVtYVZhbHVlWydAZmlsdGVyRXhwcmVzc2lvblN0cmluZ0AnXSA9IHRoaXMuZmlsdGVySW5zdGFuY2UuZ2V0RmlsdGVyRXhwcmVzc2lvbigpO1xyXG4gICAgICB9XHJcbiAgICAgIG5ld1ZhbHVlLnNjaGVtYVZhbHVlID0gbmV3VmFsdWUuc2NoZW1hVmFsdWUgPyBKU09OLnN0cmluZ2lmeShuZXdWYWx1ZS5zY2hlbWFWYWx1ZSkgOiBudWxsO1xyXG4gICAgICB0aGlzLmNvbmRpdGlvblNlcnZpY2Uuc2F2ZVNjaGVtYShuZXdWYWx1ZSkuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICBzZWxmLm5vdGlmeVNlcnZpY2VbJ3N1Y2Nlc3MnXSh7XHJcbiAgICAgICAgICB0aXRsZTogc2VsZi5sb2NhbGl6ZVNlcnZpY2UuZ2V0VmFsdWUoJ3F1ZXJ5RnJhbWV3b3JrLm1lc3NhZ2UuaW5mby50aXRsZScpLCBtc2c6IHNlbGYubG9jYWxpemVTZXJ2aWNlLmdldFZhbHVlKCdxdWVyeUZyYW1ld29yay5tZXNzYWdlLnNhdmUuc3VjY2VzcycpLCB0aW1lb3V0OiAzMDAwXHJcbiAgICAgICAgfSBhcyBOb3RpZnlPcHRpb25zKTtcclxuICAgICAgICBzZWxmLmZhcnJpc0RpYWxvZy5jbG9zZSgpO1xyXG4gICAgICB9LCAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgIHNlbGYuZm9ybUVycm9yU2VydmljZS5leGNlcHRpb24oZXJyb3IuTWVzc2FnZSwgZXJyb3IpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGhhbmRsZUNhbmNlbENsaWNrKCkge1xyXG4gICAgdGhpcy5zY2hlbWFOYW1lID0gJyc7XHJcbiAgICB0aGlzLmlzRGVmYXVsdCA9IGZhbHNlO1xyXG4gICAgdGhpcy5pc1NjaGVtYVR5cGUgPSAwO1xyXG4gICAgdGhpcy5mYXJyaXNEaWFsb2cuY2xvc2UoKTtcclxuICB9XHJcblxyXG4gIGhhbmRsZVNjaGVtYVR5cGVTZWxlY3QodmFsdWU6IGFueSkge1xyXG4gICAgdGhpcy5pc1NjaGVtYVR5cGUgPSB2YWx1ZTtcclxuICB9XHJcblxyXG4gIGhhbmRsZXJHZXRFbnRpdHkoKSB7XHJcbiAgICBjb25zdCBlbnRpdHlzID0gdGhpcy5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0QWxsRW50aXRpZXMoKTtcclxuICAgIGxldCBwYXJhbXM7XHJcbiAgICBpZiAoZW50aXR5cyAmJiBlbnRpdHlzLmxlbmd0aCkge1xyXG4gICAgICBwYXJhbXMgPSBlbnRpdHlzWzBdLnRvSlNPTigpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHBhcmFtcztcclxuICB9XHJcbn1cclxuIl19