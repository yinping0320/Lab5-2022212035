!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/common"),require("@angular/core"),require("rxjs/operators"),require("rxjs"),require("@gsp-sys/rtf-common"),require("@ecp-caf/caf-common"),require("@qdp/common"),require("@farris/ui-loading")):"function"==typeof define&&define.amd?define("@qdp/search-join",["exports","@angular/common","@angular/core","rxjs/operators","rxjs","@gsp-sys/rtf-common","@ecp-caf/caf-common","@qdp/common","@farris/ui-loading"],t):t((e.qdp=e.qdp||{},e.qdp["search-join"]={}),e.ng.common,e.ng.core,e.rxjs.operators,e.rxjs,e.rtfCommon,e.cafCommon,e.common$1,e.uiLoading)}(this,function(e,t,r,i,a,s,n,g,o){"use strict";var c=function(){function e(e){this.jointSearchManagerService=e}return e.prototype.getSearchList=function(e,t,r){return this.jointSearchManagerService.getjointsearch(e,t,r)},e.prototype.getVisibleJoint=function(e,t,r){return this.jointSearchManagerService.getVisibleJoint(e,t,r)},e.decorators=[{type:r.Injectable}],e.ctorParameters=function(){return[{type:g.JointSearchManagerService}]},e}(),h=function(){function e(e,t,r,n,i){this.rendererFactory=e,this.cacheService=t,this.searchListService=r,this.cache=n,this.loadingService=i,this.jointsearchInfoChange=new a.Subject,this.render=e.createRenderer(null,null)}return e.prototype.handleContextmenu=function(e,t,r,n){var i,a,o=this;this.qdpView=r;var c=this.cache.get(g.RtfServices.getTabId(this._queryId)+"joinSearch");if(!this.checkDataArea(r,n,c,e)||!this._searchList)return!1;var s=0,h=0;h=c&&"charts"!==c.controlType?(s=e.clientX,e.clientY):(s=e.event.event.clientX,e.event.event.clientY),this.render.setStyle(t.nativeElement,"left",s+"px"),this.render.setStyle(t.nativeElement,"top",h+"px"),this.render.setStyle(t.nativeElement,"display","block"),this.cacheService.set(this._queryId+"currentSelectItem",this.currentSelectItem);var u=this.cacheService.get(this._queryId+"beforeJointSearchMenuShow"),l={},p=!1;try{for(var d=function m(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}(u),f=d.next();!f.done;f=d.next()){var v=f.value;l[v.id]=v.visibleformula,!1===p&&null!=v.visibleformula&&""!==v.visibleformula&&(p=!0)}}catch(y){i={error:y}}finally{try{f&&!f.done&&(a=d["return"])&&a.call(d)}finally{if(i)throw i.error}}if(!0===p){var S={qoManagerCode:r.qoManagerCode,visibleFormulas:l,userId:"",queryId:this._queryId,rowData:this.currentSelectItem};this.searchListService.getVisibleJoint(S,r.queryRelativeUrl,u).subscribe(function(e){e&&o.jointsearchInfoChange.next(e)})}else this.jointsearchInfoChange.next(u);return!1},e.prototype.handleClick=function(e){e&&this.render.setStyle(e.nativeElement,"display","none")},e.prototype.getSearchList=function(e,t,r){var n=this;return this._queryId=t,this._searchList&&this._searchList.queryId===this._queryId?a.of(this._searchList):this.searchListService.getSearchList(e,t,r).pipe(i.map(function(e){return n._searchList=e,n._searchList}))},e.prototype.checkDataArea=function(e,t,i,r){for(var n=this,a=0,o=0,c=t.nativeElement;c;)a+=c.offsetLeft,o+=c.offsetTop,c=c.offsetParent;if("charts"!==i.controlType){var s=e.spread.getActiveSheet(),h=s.hitTest(r.clientX-a,r.clientY-o);if(h.hitTestType!==GC.Spread.Sheets.SheetArea.viewport||h.col===undefined||h.row===undefined)return!1;s.setActiveCell(h.row,h.col);var u={};if("crosstab"===i.controlType){for(var l=function(e){var t=s.getValue(h.row,e,GC.Spread.Sheets.SheetArea.viewport),r=s.getValue(i.colHeaderRowInfo.start,e,GC.Spread.Sheets.SheetArea.colHeader),n=i.colInfos.find(function(e){return 1===e.dimension&&e.name===r}).bindField;u[n]=t},p=i.rowHeaderColInfo.start;p<i.rowHeaderColInfo.end;p++)l(p);for(p=i.colHeaderRowInfo.start;p<i.colHeaderRowInfo.end;p++){var d=s.getValue(p,h.col,GC.Spread.Sheets.SheetArea.colHeader),f=i.colInfos.filter(function(e){return 2===e.dimension})[p-i.colHeaderRowInfo.start].bindField;u[f]=d}var v=s.getValue(h.row,h.col,GC.Spread.Sheets.SheetArea.viewport),S=s.getValue(i.colHeaderRowInfo.end,h.col,GC.Spread.Sheets.SheetArea.colHeader),m=i.colInfos.find(function(e){return 3===e.dimension&&e.name===S});m&&(m=m.bindField,u[m]=v)}else u=s.getDataItem(h.row);return this.currentSelectItem=u,!0}if(i.colList&&i.colList.length){var y=[];i.colList.forEach(function(e){n.getColumn(e,null,y)});for(u={},p=0;p<y.length;p++)p<r.value.length&&(u[y[p].bindField]=r.value[p]);this.currentSelectItem=u}return!(r.event.event.returnValue=!1)},e.prototype.writeParamToCache=function(r){var n=this;this._searchList[0].joinSearch.forEach(function(e){var t=n.cacheService.get(n._queryId);r.currentItem=t,n.cacheService.set(e.queryId,r)})},e.prototype.getColumn=function(e,t,r){var n=this;if(e){var i=JSON.stringify(e);r.push(JSON.parse(i)),e.childList&&e.childList.length&&this.getColumn(null,e.childList,r)}else t.forEach(function(e){var t=JSON.stringify(e);r.push(JSON.parse(t)),e.childList&&e.childList.length&&n.getColumn(null,e.childList,r)})},e.decorators=[{type:r.Injectable}],e.ctorParameters=function(){return[{type:r.RendererFactory2},{type:n.CacheService},{type:c},{type:n.CacheService},{type:o.LoadingService}]},e}(),u=function(){function e(e,t,r,n,i,a,o){var c=this;this.elementRef=e,this.renderFactory=t,this.menuControllerService=r,this.frameWorkService=n,this.cacheService=i,this.jointSearchExtendService=a,this.injector=o,this.injector&&(this.appService=this.injector.get(s.AppService)),this.formId="formff3ea474-cc65-23b0-cdb1-73c9146cea3b",this.renderer=this.renderFactory.createRenderer(null,null),r.jointsearchInfoChange.subscribe(function(e){e&&(c.searchList=e)})}return e.prototype.ngOnInit=function(){var r=this,n=this;this.menuControllerService.getSearchList(this.formId,this.queryId,this.queryRelativeUrl).subscribe(function(e){if(e){var t=JSON.parse(e.joinSearch);t.forEach(function(e){e.searchtype||(e.searchtype="func",e.appEntrance=""),e.functionname=n.getFunctionName(e.functionname)}),r.searchPara=JSON.parse(e.jointparam),r.cacheService.set(r.queryId+"beforeJointSearchMenuShow",t)}})},e.prototype.ngOnChanges=function(e){},e.prototype.handleClick=function(){this.renderer.setStyle(this.elementRef.nativeElement,"display","none")},e.prototype.routeTo=function(t,e,r){var n=this,i={};this.searchList.forEach(function(e){e.id===t&&(i=e)});var a={id:"null"},o=new Map,c=this.searchPara.filter(function(e){return e.functionid===t}),s=this.cacheService.get(this.queryId+"currentSelectItem");0<c.length?c.forEach(function(e){if(e.paravaluetype)if(0<=e.paravalue.indexOf("getParameter(")){var t=e.paravalue.replace(/'/g,"").replace(/"/g,"").replace(/getParameter\(/g,"").replace(/\)/g,"");n.getQueryParameters(a,o,t,e.para)}else a[e.para]=s[e.paravalue],o.set(e.para,s[e.paravalue]);else a[e.para]=e.paravalue,o.set(e.para,e.paravalue)}):a=s;var h={ParentSessionId:this.cacheService.get("session"),EntityParam:a},u={};if(!this.jointSearchExtendService||!this.jointSearchExtendService.beforeJointSearch||(u.eventCode="beforeJointSearch",u.eventName="drill before",u.data={functionid:e,options:h,queryId:r,orginQueryId:this.queryId,qdpView:this.menuControllerService.qdpView},this.jointSearchExtendService.beforeJointSearch(u),u&&u.data&&u.data.options&&(h=Object.assign(h,u.data.options)),"url"!==i.searchtype&&"additional"!==i.searchtype)){var l="";if("func"===i.searchtype){var p={appType:"menu",funcId:e,tabId:g.EventBus.guid(),appId:"",appEntrance:"",entityParams:u.entityParams||a,queryStringParams:o,isNewTab:!0};l=g.RtfServices.getFuncId(p);var d=Object.assign({},p.entityParams,g.RtfServices.getMenuSwitchControlParameter(l));p.entityParams=d,this.cacheService.set(l||r,h.EntityParam),this.frameWorkService.openMenu(p)}else if("app"===i.searchtype){var f={appType:"app",appId:e,appEntrance:i.appEntrance,funcId:"",isReload:!0,tabId:g.EventBus.guid(),entityParams:u.entityParams||a,queryStringParams:o};l=g.RtfServices.getFuncId(f),this.cacheService.set(l||r,h.EntityParam);d=Object.assign({},f.entityParams,g.RtfServices.getMenuSwitchControlParameter(l));f.entityParams=d,this.frameWorkService.openMenu(f)}}},e.prototype.getFunctionName=function(e){var t="zh-chs";return gspframeworkService&&(t=gspframeworkService.rtf.language.getLanguageCode().toLowerCase()),t||(t="zh-chs"),e[t]?e[t]:e},e.prototype.getQueryParameters=function(e,t,r,n){try{var i=gspframeworkService.rtf.session.getCommonVariable();if(i&&i.tabId){var a=i.tabId+g.RtfServices.getInSuiteFrmUUID();this.cacheService.get(a)&&this.cacheService.get(a)[r]&&(e[n]=this.cacheService.get(a)[r],t.set(n,this.cacheService.get(a)[r]))}}catch(o){}},e.decorators=[{type:r.Component,args:[{selector:"qdp-search-join-menu",template:'<div *ngIf="searchList && searchList.length && searchList.length > 0">\r\n  <div class="dropdown-menu" style="display:block">\r\n    <div *ngFor="let item of searchList">\r\n      <button class="dropdown-item" (click)="routeTo(item.id,item.functioncode,item.destinationqueryId)">{{item.functionname}}</button>\r\n    </div>\r\n  </div>\r\n</div>\r\n',styles:[":host{position:fixed;display:none;top:0;left:0}"]}]}],e.ctorParameters=function(){return[{type:r.ElementRef},{type:r.RendererFactory2},{type:h},{type:s.FrameworkService},{type:n.CacheService},{type:g.JointSearchExtendService,decorators:[{type:r.Optional}]},{type:r.Injector,decorators:[{type:r.Optional}]}]},e.propDecorators={queryId:[{type:r.Input}],queryRelativeUrl:[{type:r.Input}],qoManagerCode:[{type:r.Input}],searchList:[{type:r.Input}],handleClick:[{type:r.HostListener,args:["click"]}]},e}(),l=function(){function e(){}return e.decorators=[{type:r.NgModule,args:[{imports:[t.CommonModule,o.LoadingModule],providers:[c,o.LoadingService],declarations:[u],exports:[u]}]}],e}();e.SearchJoinModule=l,e.MenuControllerService=h,e.SearchListService=c,e.SearchJoinMenuComponent=u,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=qdp-search-join.umd.min.js.map