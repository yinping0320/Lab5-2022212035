/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, RendererFactory2 } from '@angular/core';
import { CacheService } from '@ecp-caf/caf-common';
import { SearchListService } from './search-list.service';
import { map } from 'rxjs/operators';
import { Subject, of } from 'rxjs';
import { LoadingService } from '@farris/ui-loading';
import { RtfServices } from '@qdp/common';
var MenuControllerService = /** @class */ (function () {
    function MenuControllerService(rendererFactory, cacheService, searchListService, cache, loadingService) {
        this.rendererFactory = rendererFactory;
        this.cacheService = cacheService;
        this.searchListService = searchListService;
        this.cache = cache;
        this.loadingService = loadingService;
        this.jointsearchInfoChange = new Subject();
        this.render = rendererFactory.createRenderer(null, null);
    }
    /**
     * @param {?} $event
     * @param {?} elementRef
     * @param {?} qdpView
     * @param {?} qdpViewElementRef
     * @return {?}
     */
    MenuControllerService.prototype.handleContextmenu = /**
     * @param {?} $event
     * @param {?} elementRef
     * @param {?} qdpView
     * @param {?} qdpViewElementRef
     * @return {?}
     */
    function ($event, elementRef, qdpView, qdpViewElementRef) {
        var _this = this;
        var e_1, _a;
        this.qdpView = qdpView;
        // const loading = this.loadingService.show({ container: qdpViewElementRef });
        /** @type {?} */
        var joinParam = this.cache.get(RtfServices.getTabId(this._queryId) + 'joinSearch');
        if (!this.checkDataArea(qdpView, qdpViewElementRef, joinParam, $event) || !this._searchList) {
            return false;
        }
        /** @type {?} */
        var left = 0;
        /** @type {?} */
        var top = 0;
        if (joinParam && joinParam.controlType !== 'charts') {
            left = $event.clientX;
            top = $event.clientY;
        }
        else {
            left = $event.event.event.clientX;
            top = $event.event.event.clientY;
        }
        this.render.setStyle(elementRef.nativeElement, 'left', left + 'px');
        this.render.setStyle(elementRef.nativeElement, 'top', top + 'px');
        this.render.setStyle(elementRef.nativeElement, 'display', 'block');
        this.cacheService.set(this._queryId + 'currentSelectItem', this.currentSelectItem); // 将当前参数设置到缓存中
        // 将当前参数设置到缓存中
        // 联查可见表达式
        /** @type {?} */
        var searchList = this.cacheService.get(this._queryId + 'beforeJointSearchMenuShow');
        /** @type {?} */
        var formulas = {};
        /** @type {?} */
        var containVisibleFormula = false;
        try {
            for (var searchList_1 = tslib_1.__values(searchList), searchList_1_1 = searchList_1.next(); !searchList_1_1.done; searchList_1_1 = searchList_1.next()) {
                var search = searchList_1_1.value;
                formulas[search.id] = search.visibleformula;
                if (containVisibleFormula === false && search.visibleformula != void 0 && search.visibleformula !== '') {
                    containVisibleFormula = true;
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (searchList_1_1 && !searchList_1_1.done && (_a = searchList_1.return)) _a.call(searchList_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        if (containVisibleFormula === true) {
            /** @type {?} */
            var param = { qoManagerCode: qdpView.qoManagerCode, visibleFormulas: formulas, userId: '', queryId: this._queryId, rowData: this.currentSelectItem };
            this.searchListService.getVisibleJoint(param, qdpView.queryRelativeUrl, searchList).subscribe((/**
             * @param {?} value
             * @return {?}
             */
            function (value) {
                if (value) {
                    _this.jointsearchInfoChange.next(value);
                }
            }));
        }
        else {
            this.jointsearchInfoChange.next(searchList);
        }
        return false;
    };
    /**
     * 单击之后隐藏菜单
     * @param elementRef 菜单组件
     */
    /**
     * 单击之后隐藏菜单
     * @param {?} elementRef 菜单组件
     * @return {?}
     */
    MenuControllerService.prototype.handleClick = /**
     * 单击之后隐藏菜单
     * @param {?} elementRef 菜单组件
     * @return {?}
     */
    function (elementRef) {
        if (elementRef) {
            this.render.setStyle(elementRef.nativeElement, 'display', 'none');
        }
    };
    /**
     * get searchList
     */
    /**
     * get searchList
     * @param {?} formId
     * @param {?} queryId
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    MenuControllerService.prototype.getSearchList = /**
     * get searchList
     * @param {?} formId
     * @param {?} queryId
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    function (formId, queryId, queryRelativeUrl) {
        var _this = this;
        this._queryId = queryId;
        if (this._searchList && this._searchList.queryId === this._queryId) {
            return of(this._searchList);
        }
        /** @type {?} */
        var result = this.searchListService.getSearchList(formId, queryId, queryRelativeUrl);
        return result.pipe(map((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            _this._searchList = value; // ? JSON.parse(value.joinSearch) : [];
            return _this._searchList;
        })));
    };
    /**
     * 返回当前右键坐标，是否为数据区域
     * @param qdpView qdp-view 组件
     * @param qdpViewElementRef qdp-view ElementRef
     * @param $event 触发事件，主要用来传递坐标
     */
    /**
     * 返回当前右键坐标，是否为数据区域
     * @private
     * @param {?} qdpView qdp-view 组件
     * @param {?} qdpViewElementRef qdp-view ElementRef
     * @param {?} joinParam
     * @param {?} $event 触发事件，主要用来传递坐标
     * @return {?}
     */
    MenuControllerService.prototype.checkDataArea = /**
     * 返回当前右键坐标，是否为数据区域
     * @private
     * @param {?} qdpView qdp-view 组件
     * @param {?} qdpViewElementRef qdp-view ElementRef
     * @param {?} joinParam
     * @param {?} $event 触发事件，主要用来传递坐标
     * @return {?}
     */
    function (qdpView, qdpViewElementRef, joinParam, $event) {
        var _this = this;
        /** @type {?} */
        var x = 0;
        /** @type {?} */
        var y = 0;
        /** @type {?} */
        var qdpviewNative = qdpViewElementRef.nativeElement;
        while (qdpviewNative) {
            x += qdpviewNative.offsetLeft;
            y += qdpviewNative.offsetTop;
            qdpviewNative = qdpviewNative.offsetParent;
        }
        if (joinParam.controlType !== 'charts') {
            /** @type {?} */
            var activeSheet = qdpView.spread.getActiveSheet();
            /** @type {?} */
            var target = activeSheet.hitTest($event.clientX - x, $event.clientY - y);
            if (target.hitTestType !== GC.Spread.Sheets.SheetArea.viewport || target.col === undefined || target.row === undefined) {
                return false;
            }
            activeSheet.setActiveCell(target.row, target.col);
            // 将当前行，写入cache
            /** @type {?} */
            var dataItem = {};
            if (joinParam.controlType === 'crosstab') { // 交叉表
                var _loop_1 = function (i) {
                    /** @type {?} */
                    var value_1 = activeSheet.getValue(target.row, i, GC.Spread.Sheets.SheetArea.viewport);
                    /** @type {?} */
                    var name_1 = activeSheet.getValue(joinParam.colHeaderRowInfo.start, i, GC.Spread.Sheets.SheetArea.colHeader);
                    /** @type {?} */
                    var colInfo_1 = joinParam.colInfos.find((/**
                     * @param {?} x
                     * @return {?}
                     */
                    function (x) { return x.dimension === 1 && x.name === name_1; })).bindField;
                    dataItem[colInfo_1] = value_1;
                };
                // 获取行标题的数据
                for (var i = joinParam.rowHeaderColInfo.start; i < joinParam.rowHeaderColInfo.end; i++) {
                    _loop_1(i);
                }
                // 获取列标题的数据
                for (var i = joinParam.colHeaderRowInfo.start; i < joinParam.colHeaderRowInfo.end; i++) {
                    /** @type {?} */
                    var value_2 = activeSheet.getValue(i, target.col, GC.Spread.Sheets.SheetArea.colHeader);
                    /** @type {?} */
                    var colInfo_2 = joinParam.colInfos.filter((/**
                     * @param {?} x
                     * @return {?}
                     */
                    function (x) { return x.dimension === 2; }))[i - joinParam.colHeaderRowInfo.start].bindField;
                    dataItem[colInfo_2] = value_2;
                }
                // 获取值标题的数据
                /** @type {?} */
                var value = activeSheet.getValue(target.row, target.col, GC.Spread.Sheets.SheetArea.viewport);
                /** @type {?} */
                var name_2 = activeSheet.getValue(joinParam.colHeaderRowInfo.end, target.col, GC.Spread.Sheets.SheetArea.colHeader);
                /** @type {?} */
                var colInfo = joinParam.colInfos.find((/**
                 * @param {?} x
                 * @return {?}
                 */
                function (x) { return x.dimension === 3 && x.name === name_2; }));
                if (colInfo) {
                    colInfo = colInfo.bindField;
                    dataItem[colInfo] = value;
                }
            }
            else {
                dataItem = activeSheet.getDataItem(target.row);
            }
            // 保存参数到searchList
            this.currentSelectItem = dataItem;
            return true;
        }
        else {
            if (joinParam.colList && joinParam.colList.length) {
                /** @type {?} */
                var cacheCols_1 = [];
                joinParam.colList.forEach((/**
                 * @param {?} col
                 * @return {?}
                 */
                function (col) {
                    _this.getColumn(col, null, cacheCols_1);
                }));
                /** @type {?} */
                var dataItem = {};
                for (var i = 0; i < cacheCols_1.length; i++) {
                    if (i < $event.value.length) {
                        dataItem[cacheCols_1[i].bindField] = $event.value[i];
                    }
                }
                this.currentSelectItem = dataItem;
            }
            $event.event.event.returnValue = false;
            return true;
        }
    };
    /**
     * 保存参数到cache
     * @param dataItem 参数
     */
    /**
     * 保存参数到cache
     * @protected
     * @param {?} dataItem 参数
     * @return {?}
     */
    MenuControllerService.prototype.writeParamToCache = /**
     * 保存参数到cache
     * @protected
     * @param {?} dataItem 参数
     * @return {?}
     */
    function (dataItem) {
        var _this = this;
        this._searchList[0]['joinSearch'].forEach((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            /** @type {?} */
            var currentParam = _this.cacheService.get(_this._queryId);
            dataItem['currentItem'] = currentParam;
            _this.cacheService.set(value.queryId, dataItem);
        }));
    };
    /**
     * @private
     * @param {?} col
     * @param {?} childCols
     * @param {?} colcache
     * @return {?}
     */
    MenuControllerService.prototype.getColumn = /**
     * @private
     * @param {?} col
     * @param {?} childCols
     * @param {?} colcache
     * @return {?}
     */
    function (col, childCols, colcache) {
        var _this = this;
        if (col) {
            /** @type {?} */
            var str = JSON.stringify(col);
            colcache.push(JSON.parse(str));
            if (col.childList && col.childList.length) {
                this.getColumn(null, col.childList, colcache);
            }
        }
        else {
            childCols.forEach((/**
             * @param {?} col
             * @return {?}
             */
            function (col) {
                /** @type {?} */
                var str = JSON.stringify(col);
                colcache.push(JSON.parse(str));
                if (col.childList && col.childList.length) {
                    _this.getColumn(null, col.childList, colcache);
                }
            }));
        }
    };
    MenuControllerService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    MenuControllerService.ctorParameters = function () { return [
        { type: RendererFactory2 },
        { type: CacheService },
        { type: SearchListService },
        { type: CacheService },
        { type: LoadingService }
    ]; };
    return MenuControllerService;
}());
export { MenuControllerService };
if (false) {
    /**
     * @type {?}
     * @protected
     */
    MenuControllerService.prototype._searchList;
    /**
     * @type {?}
     * @protected
     */
    MenuControllerService.prototype._queryId;
    /** @type {?} */
    MenuControllerService.prototype.currentSelectItem;
    /** @type {?} */
    MenuControllerService.prototype.queryRelativeUrl;
    /** @type {?} */
    MenuControllerService.prototype.jointsearchInfoChange;
    /** @type {?} */
    MenuControllerService.prototype.qdpView;
    /**
     * @type {?}
     * @protected
     */
    MenuControllerService.prototype.render;
    /**
     * @type {?}
     * @protected
     */
    MenuControllerService.prototype.rendererFactory;
    /**
     * @type {?}
     * @protected
     */
    MenuControllerService.prototype.cacheService;
    /**
     * @type {?}
     * @protected
     */
    MenuControllerService.prototype.searchListService;
    /**
     * @type {?}
     * @private
     */
    MenuControllerService.prototype.cache;
    /**
     * @type {?}
     * @private
     */
    MenuControllerService.prototype.loadingService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudS1jb250cm9sbGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcWRwL3NlYXJjaC1qb2luLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2UvbWVudS1jb250cm9sbGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUF5QixnQkFBZ0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNwRixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JDLE9BQU8sRUFBYyxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9DLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRzFDO0lBVUUsK0JBQ1ksZUFBaUMsRUFDakMsWUFBMEIsRUFDMUIsaUJBQW9DLEVBQ3RDLEtBQW1CLEVBQ25CLGNBQThCO1FBSjVCLG9CQUFlLEdBQWYsZUFBZSxDQUFrQjtRQUNqQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3RDLFVBQUssR0FBTCxLQUFLLENBQWM7UUFDbkIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBVHhDLDBCQUFxQixHQUFHLElBQUksT0FBTyxFQUFPLENBQUM7UUFXekMsSUFBSSxDQUFDLE1BQU0sR0FBRyxlQUFlLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMzRCxDQUFDOzs7Ozs7OztJQUNNLGlEQUFpQjs7Ozs7OztJQUF4QixVQUF5QixNQUFXLEVBQUUsVUFBc0IsRUFBRSxPQUFZLEVBQUUsaUJBQTZCO1FBQXpH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QUFFO2dCQUN6QyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO2FBQy9DO1NBQ0Y7YUFBTTtZQUNMLFNBQVMsQ0FBQyxPQUFPOzs7O1lBQUMsVUFBQyxHQUFROztvQkFDbkIsR0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDO2dCQUMvQixRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDL0IsSUFBSSxHQUFHLENBQUMsU0FBUyxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFO29CQUN6QyxLQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO2lCQUMvQztZQUNILENBQUMsRUFBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDOztnQkF2TUYsVUFBVTs7OztnQkFUaUMsZ0JBQWdCO2dCQUNuRCxZQUFZO2dCQUNaLGlCQUFpQjtnQkFEakIsWUFBWTtnQkFJWixjQUFjOztJQTRNdkIsNEJBQUM7Q0FBQSxBQXhNRCxJQXdNQztTQXZNWSxxQkFBcUI7Ozs7OztJQUNoQyw0Q0FBMkI7Ozs7O0lBQzNCLHlDQUF3Qjs7SUFDeEIsa0RBQXVCOztJQUN2QixpREFBc0I7O0lBQ3RCLHNEQUEyQzs7SUFDM0Msd0NBQWE7Ozs7O0lBRWIsdUNBQTRCOzs7OztJQUUxQixnREFBMkM7Ozs7O0lBQzNDLDZDQUFvQzs7Ozs7SUFDcEMsa0RBQThDOzs7OztJQUM5QyxzQ0FBMkI7Ozs7O0lBQzNCLCtDQUFzQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEVsZW1lbnRSZWYsIFJlbmRlcmVyMiwgUmVuZGVyZXJGYWN0b3J5MiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBDYWNoZVNlcnZpY2UgfSBmcm9tICdAZWNwLWNhZi9jYWYtY29tbW9uJztcclxuaW1wb3J0IHsgU2VhcmNoTGlzdFNlcnZpY2UgfSBmcm9tICcuL3NlYXJjaC1saXN0LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IExvYWRpbmdTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1sb2FkaW5nJztcclxuaW1wb3J0IHsgUnRmU2VydmljZXMgfSBmcm9tICdAcWRwL2NvbW1vbic7XHJcblxyXG5kZWNsYXJlIHZhciBHQzogYW55O1xyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBNZW51Q29udHJvbGxlclNlcnZpY2Uge1xyXG4gIHByb3RlY3RlZCBfc2VhcmNoTGlzdDogYW55O1xyXG4gIHByb3RlY3RlZCBfcXVlcnlJZDogYW55O1xyXG4gIGN1cnJlbnRTZWxlY3RJdGVtOiBhbnk7XHJcbiAgcXVlcnlSZWxhdGl2ZVVybDogYW55O1xyXG4gIGpvaW50c2VhcmNoSW5mb0NoYW5nZSA9IG5ldyBTdWJqZWN0PGFueT4oKTtcclxuICBxZHBWaWV3OiBhbnk7XHJcblxyXG4gIHByb3RlY3RlZCByZW5kZXI6IFJlbmRlcmVyMjtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByb3RlY3RlZCByZW5kZXJlckZhY3Rvcnk6IFJlbmRlcmVyRmFjdG9yeTIsXHJcbiAgICBwcm90ZWN0ZWQgY2FjaGVTZXJ2aWNlOiBDYWNoZVNlcnZpY2UsXHJcbiAgICBwcm90ZWN0ZWQgc2VhcmNoTGlzdFNlcnZpY2U6IFNlYXJjaExpc3RTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBjYWNoZTogQ2FjaGVTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBsb2FkaW5nU2VydmljZTogTG9hZGluZ1NlcnZpY2VcclxuICApIHtcclxuICAgIHRoaXMucmVuZGVyID0gcmVuZGVyZXJGYWN0b3J5LmNyZWF0ZVJlbmRlcmVyKG51bGwsIG51bGwpO1xyXG4gIH1cclxuICBwdWJsaWMgaGFuZGxlQ29udGV4dG1lbnUoJGV2ZW50OiBhbnksIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIHFkcFZpZXc6IGFueSwgcWRwVmlld0VsZW1lbnRSZWY6IEVsZW1lbnRSZWYpIHtcclxuICAgIHRoaXMucWRwVmlldyA9IHFkcFZpZXc7XHJcbiAgICAvLyBjb25zdCBsb2FkaW5nID0gdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KHsgY29udGFpbmVyOiBxZHBWaWV3RWxlbWVudFJlZiB9KTtcclxuICAgIGNvbnN0IGpvaW5QYXJhbSA9IHRoaXMuY2FjaGUuZ2V0KFJ0ZlNlcnZpY2VzLmdldFRhYklkKHRoaXMuX3F1ZXJ5SWQpICsgJ2pvaW5TZWFyY2gnKTtcclxuICAgIGlmICghdGhpcy5jaGVja0RhdGFBcmVhKHFkcFZpZXcsIHFkcFZpZXdFbGVtZW50UmVmLCBqb2luUGFyYW0sICRldmVudCkgfHwgIXRoaXMuX3NlYXJjaExpc3QpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBsZWZ0ID0gMCwgdG9wID0gMDtcclxuICAgIGlmIChqb2luUGFyYW0gJiYgam9pblBhcmFtLmNvbnRyb2xUeXBlICE9PSAnY2hhcnRzJykge1xyXG4gICAgICBsZWZ0ID0gJGV2ZW50LmNsaWVudFg7XHJcbiAgICAgIHRvcCA9ICRldmVudC5jbGllbnRZO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbGVmdCA9ICRldmVudC5ldmVudC5ldmVudC5jbGllbnRYO1xyXG4gICAgICB0b3AgPSAkZXZlbnQuZXZlbnQuZXZlbnQuY2xpZW50WTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsICdsZWZ0JywgbGVmdCArICdweCcpO1xyXG4gICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUoZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCAndG9wJywgdG9wICsgJ3B4Jyk7XHJcbiAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsICdkaXNwbGF5JywgJ2Jsb2NrJyk7XHJcblxyXG4gICAgdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KHRoaXMuX3F1ZXJ5SWQgKyAnY3VycmVudFNlbGVjdEl0ZW0nLCB0aGlzLmN1cnJlbnRTZWxlY3RJdGVtKTsgLy8g5bCG5b2T5YmN5Y+C5pWw6K6+572u5Yiw57yT5a2Y5LitXHJcblxyXG4gICAgLy8g6IGU5p+l5Y+v6KeB6KGo6L6+5byPXHJcbiAgICBjb25zdCBzZWFyY2hMaXN0ID0gdGhpcy5jYWNoZVNlcnZpY2UuZ2V0KHRoaXMuX3F1ZXJ5SWQgKyAnYmVmb3JlSm9pbnRTZWFyY2hNZW51U2hvdycpO1xyXG4gICAgY29uc3QgZm9ybXVsYXMgPSB7fTtcclxuICAgIGxldCBjb250YWluVmlzaWJsZUZvcm11bGEgPSBmYWxzZTtcclxuICAgIGZvciAoY29uc3Qgc2VhcmNoIG9mIHNlYXJjaExpc3QpIHtcclxuICAgICAgZm9ybXVsYXNbc2VhcmNoLmlkXSA9IHNlYXJjaC52aXNpYmxlZm9ybXVsYTtcclxuICAgICAgaWYgKGNvbnRhaW5WaXNpYmxlRm9ybXVsYSA9PT0gZmFsc2UgJiYgc2VhcmNoLnZpc2libGVmb3JtdWxhICE9IHZvaWQgMCAmJiBzZWFyY2gudmlzaWJsZWZvcm11bGEgIT09ICcnKSB7XHJcbiAgICAgICAgY29udGFpblZpc2libGVGb3JtdWxhID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChjb250YWluVmlzaWJsZUZvcm11bGEgPT09IHRydWUpIHtcclxuICAgICAgY29uc3QgcGFyYW0gPSB7IHFvTWFuYWdlckNvZGU6IHFkcFZpZXcucW9NYW5hZ2VyQ29kZSwgdmlzaWJsZUZvcm11bGFzOiBmb3JtdWxhcywgdXNlcklkOiAnJywgcXVlcnlJZDogdGhpcy5fcXVlcnlJZCwgcm93RGF0YTogdGhpcy5jdXJyZW50U2VsZWN0SXRlbSB9O1xyXG5cclxuICAgICAgdGhpcy5zZWFyY2hMaXN0U2VydmljZS5nZXRWaXNpYmxlSm9pbnQocGFyYW0sIHFkcFZpZXcucXVlcnlSZWxhdGl2ZVVybCwgc2VhcmNoTGlzdCkuc3Vic2NyaWJlKHZhbHVlID0+IHtcclxuICAgICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICAgIHRoaXMuam9pbnRzZWFyY2hJbmZvQ2hhbmdlLm5leHQodmFsdWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmpvaW50c2VhcmNoSW5mb0NoYW5nZS5uZXh0KHNlYXJjaExpc3QpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWNleWHu+S5i+WQjumakOiXj+iPnOWNlVxyXG4gICAqIEBwYXJhbSBlbGVtZW50UmVmIOiPnOWNlee7hOS7tlxyXG4gICAqL1xyXG4gIHB1YmxpYyBoYW5kbGVDbGljayhlbGVtZW50UmVmOiBFbGVtZW50UmVmKSB7XHJcbiAgICBpZiAoZWxlbWVudFJlZikge1xyXG4gICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsICdkaXNwbGF5JywgJ25vbmUnKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIGdldCBzZWFyY2hMaXN0XHJcbiAgICovXHJcbiAgcHVibGljIGdldFNlYXJjaExpc3QoZm9ybUlkOiBhbnksIHF1ZXJ5SWQ6IGFueSwgcXVlcnlSZWxhdGl2ZVVybDogYW55KSB7XHJcbiAgICB0aGlzLl9xdWVyeUlkID0gcXVlcnlJZDtcclxuICAgIGlmICh0aGlzLl9zZWFyY2hMaXN0ICYmIHRoaXMuX3NlYXJjaExpc3QucXVlcnlJZCA9PT0gdGhpcy5fcXVlcnlJZCkge1xyXG4gICAgICByZXR1cm4gb2YodGhpcy5fc2VhcmNoTGlzdCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5zZWFyY2hMaXN0U2VydmljZS5nZXRTZWFyY2hMaXN0KGZvcm1JZCwgcXVlcnlJZCwgcXVlcnlSZWxhdGl2ZVVybCk7XHJcbiAgICByZXR1cm4gcmVzdWx0LnBpcGUoXHJcbiAgICAgIG1hcCgodmFsdWU6IGFueSkgPT4ge1xyXG4gICAgICAgIHRoaXMuX3NlYXJjaExpc3QgPSB2YWx1ZTsgLy8gPyBKU09OLnBhcnNlKHZhbHVlLmpvaW5TZWFyY2gpIDogW107XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NlYXJjaExpc3Q7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOi/lOWbnuW9k+WJjeWPs+mUruWdkOagh++8jOaYr+WQpuS4uuaVsOaNruWMuuWfn1xyXG4gICAqIEBwYXJhbSBxZHBWaWV3IHFkcC12aWV3IOe7hOS7tlxyXG4gICAqIEBwYXJhbSBxZHBWaWV3RWxlbWVudFJlZiBxZHAtdmlldyBFbGVtZW50UmVmXHJcbiAgICogQHBhcmFtICRldmVudCDop6blj5Hkuovku7bvvIzkuLvopoHnlKjmnaXkvKDpgJLlnZDmoIdcclxuICAgKi9cclxuICBwcml2YXRlIGNoZWNrRGF0YUFyZWEocWRwVmlldzogYW55LCBxZHBWaWV3RWxlbWVudFJlZjogRWxlbWVudFJlZiwgam9pblBhcmFtOiBhbnksICRldmVudDogYW55KTogYm9vbGVhbiB7XHJcbiAgICBsZXQgeCA9IDAsIHkgPSAwO1xyXG4gICAgbGV0IHFkcHZpZXdOYXRpdmUgPSBxZHBWaWV3RWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xyXG4gICAgd2hpbGUgKHFkcHZpZXdOYXRpdmUpIHtcclxuICAgICAgeCArPSBxZHB2aWV3TmF0aXZlLm9mZnNldExlZnQ7XHJcbiAgICAgIHkgKz0gcWRwdmlld05hdGl2ZS5vZmZzZXRUb3A7XHJcbiAgICAgIHFkcHZpZXdOYXRpdmUgPSBxZHB2aWV3TmF0aXZlLm9mZnNldFBhcmVudDtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoam9pblBhcmFtLmNvbnRyb2xUeXBlICE9PSAnY2hhcnRzJykge1xyXG4gICAgICBjb25zdCBhY3RpdmVTaGVldCA9IHFkcFZpZXcuc3ByZWFkLmdldEFjdGl2ZVNoZWV0KCk7XHJcbiAgICAgIGNvbnN0IHRhcmdldCA9IGFjdGl2ZVNoZWV0LmhpdFRlc3QoJGV2ZW50LmNsaWVudFggLSB4LCAkZXZlbnQuY2xpZW50WSAtIHkpO1xyXG5cclxuXHJcbiAgICAgIGlmICh0YXJnZXQuaGl0VGVzdFR5cGUgIT09IEdDLlNwcmVhZC5TaGVldHMuU2hlZXRBcmVhLnZpZXdwb3J0IHx8IHRhcmdldC5jb2wgPT09IHVuZGVmaW5lZCB8fCB0YXJnZXQucm93ID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgYWN0aXZlU2hlZXQuc2V0QWN0aXZlQ2VsbCh0YXJnZXQucm93LCB0YXJnZXQuY29sKTtcclxuICAgICAgLy8g5bCG5b2T5YmN6KGM77yM5YaZ5YWlY2FjaGVcclxuICAgICAgbGV0IGRhdGFJdGVtID0ge307XHJcbiAgICAgIGlmIChqb2luUGFyYW0uY29udHJvbFR5cGUgPT09ICdjcm9zc3RhYicpIHsgLy8g5Lqk5Y+J6KGoXHJcbiAgICAgICAgLy8g6I635Y+W6KGM5qCH6aKY55qE5pWw5o2uXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IGpvaW5QYXJhbS5yb3dIZWFkZXJDb2xJbmZvLnN0YXJ0OyBpIDwgam9pblBhcmFtLnJvd0hlYWRlckNvbEluZm8uZW5kOyBpKyspIHtcclxuICAgICAgICAgIGNvbnN0IHZhbHVlID0gYWN0aXZlU2hlZXQuZ2V0VmFsdWUodGFyZ2V0LnJvdywgaSwgR0MuU3ByZWFkLlNoZWV0cy5TaGVldEFyZWEudmlld3BvcnQpO1xyXG4gICAgICAgICAgY29uc3QgbmFtZSA9IGFjdGl2ZVNoZWV0LmdldFZhbHVlKGpvaW5QYXJhbS5jb2xIZWFkZXJSb3dJbmZvLnN0YXJ0LCBpLCBHQy5TcHJlYWQuU2hlZXRzLlNoZWV0QXJlYS5jb2xIZWFkZXIpO1xyXG4gICAgICAgICAgY29uc3QgY29sSW5mbyA9IGpvaW5QYXJhbS5jb2xJbmZvcy5maW5kKCh4OiBhbnkpID0+IHguZGltZW5zaW9uID09PSAxICYmIHgubmFtZSA9PT0gbmFtZSkuYmluZEZpZWxkO1xyXG4gICAgICAgICAgZGF0YUl0ZW1bY29sSW5mb10gPSB2YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g6I635Y+W5YiX5qCH6aKY55qE5pWw5o2uXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IGpvaW5QYXJhbS5jb2xIZWFkZXJSb3dJbmZvLnN0YXJ0OyBpIDwgam9pblBhcmFtLmNvbEhlYWRlclJvd0luZm8uZW5kOyBpKyspIHtcclxuICAgICAgICAgIGNvbnN0IHZhbHVlID0gYWN0aXZlU2hlZXQuZ2V0VmFsdWUoaSwgdGFyZ2V0LmNvbCwgR0MuU3ByZWFkLlNoZWV0cy5TaGVldEFyZWEuY29sSGVhZGVyKTtcclxuICAgICAgICAgIGNvbnN0IGNvbEluZm8gPSBqb2luUGFyYW0uY29sSW5mb3MuZmlsdGVyKCh4OiBhbnkpID0+IHguZGltZW5zaW9uID09PSAyKVtpIC0gam9pblBhcmFtLmNvbEhlYWRlclJvd0luZm8uc3RhcnRdLmJpbmRGaWVsZDtcclxuICAgICAgICAgIGRhdGFJdGVtW2NvbEluZm9dID0gdmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOiOt+WPluWAvOagh+mimOeahOaVsOaNrlxyXG4gICAgICAgIGNvbnN0IHZhbHVlID0gYWN0aXZlU2hlZXQuZ2V0VmFsdWUodGFyZ2V0LnJvdywgdGFyZ2V0LmNvbCwgR0MuU3ByZWFkLlNoZWV0cy5TaGVldEFyZWEudmlld3BvcnQpO1xyXG4gICAgICAgIGNvbnN0IG5hbWUgPSBhY3RpdmVTaGVldC5nZXRWYWx1ZShqb2luUGFyYW0uY29sSGVhZGVyUm93SW5mby5lbmQsIHRhcmdldC5jb2wsIEdDLlNwcmVhZC5TaGVldHMuU2hlZXRBcmVhLmNvbEhlYWRlcik7XHJcbiAgICAgICAgbGV0IGNvbEluZm8gPSBqb2luUGFyYW0uY29sSW5mb3MuZmluZCgoeDogYW55KSA9PiB4LmRpbWVuc2lvbiA9PT0gMyAmJiB4Lm5hbWUgPT09IG5hbWUpO1xyXG4gICAgICAgIGlmIChjb2xJbmZvKSB7XHJcbiAgICAgICAgICBjb2xJbmZvID0gY29sSW5mby5iaW5kRmllbGQ7XHJcbiAgICAgICAgICBkYXRhSXRlbVtjb2xJbmZvXSA9IHZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBkYXRhSXRlbSA9IGFjdGl2ZVNoZWV0LmdldERhdGFJdGVtKHRhcmdldC5yb3cpO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIOS/neWtmOWPguaVsOWIsHNlYXJjaExpc3RcclxuICAgICAgdGhpcy5jdXJyZW50U2VsZWN0SXRlbSA9IGRhdGFJdGVtO1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmIChqb2luUGFyYW0uY29sTGlzdCAmJiBqb2luUGFyYW0uY29sTGlzdC5sZW5ndGgpIHtcclxuICAgICAgICBjb25zdCBjYWNoZUNvbHM6IGFueVtdID0gW107XHJcbiAgICAgICAgam9pblBhcmFtLmNvbExpc3QuZm9yRWFjaCgoY29sOiBhbnkpID0+IHtcclxuICAgICAgICAgIHRoaXMuZ2V0Q29sdW1uKGNvbCwgbnVsbCwgY2FjaGVDb2xzKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBjb25zdCBkYXRhSXRlbSA9IHt9O1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2FjaGVDb2xzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICBpZiAoaSA8ICRldmVudC52YWx1ZS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgZGF0YUl0ZW1bY2FjaGVDb2xzW2ldLmJpbmRGaWVsZF0gPSAkZXZlbnQudmFsdWVbaV07XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY3VycmVudFNlbGVjdEl0ZW0gPSBkYXRhSXRlbTtcclxuICAgICAgfVxyXG4gICAgICAkZXZlbnQuZXZlbnQuZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICog5L+d5a2Y5Y+C5pWw5YiwY2FjaGVcclxuICAgKiBAcGFyYW0gZGF0YUl0ZW0g5Y+C5pWwXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHdyaXRlUGFyYW1Ub0NhY2hlKGRhdGFJdGVtOiBhbnkpIHtcclxuICAgIHRoaXMuX3NlYXJjaExpc3RbMF1bJ2pvaW5TZWFyY2gnXS5mb3JFYWNoKHZhbHVlID0+IHtcclxuICAgICAgY29uc3QgY3VycmVudFBhcmFtID0gdGhpcy5jYWNoZVNlcnZpY2UuZ2V0KHRoaXMuX3F1ZXJ5SWQpO1xyXG4gICAgICBkYXRhSXRlbVsnY3VycmVudEl0ZW0nXSA9IGN1cnJlbnRQYXJhbTtcclxuICAgICAgdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KHZhbHVlLnF1ZXJ5SWQsIGRhdGFJdGVtKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRDb2x1bW4oY29sOiBhbnksIGNoaWxkQ29sczogYW55W10sIGNvbGNhY2hlOiBhbnlbXSkge1xyXG4gICAgaWYgKGNvbCkge1xyXG4gICAgICBjb25zdCBzdHIgPSBKU09OLnN0cmluZ2lmeShjb2wpO1xyXG4gICAgICBjb2xjYWNoZS5wdXNoKEpTT04ucGFyc2Uoc3RyKSk7XHJcbiAgICAgIGlmIChjb2wuY2hpbGRMaXN0ICYmIGNvbC5jaGlsZExpc3QubGVuZ3RoKSB7XHJcbiAgICAgICAgdGhpcy5nZXRDb2x1bW4obnVsbCwgY29sLmNoaWxkTGlzdCwgY29sY2FjaGUpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjaGlsZENvbHMuZm9yRWFjaCgoY29sOiBhbnkpID0+IHtcclxuICAgICAgICBjb25zdCBzdHIgPSBKU09OLnN0cmluZ2lmeShjb2wpO1xyXG4gICAgICAgIGNvbGNhY2hlLnB1c2goSlNPTi5wYXJzZShzdHIpKTtcclxuICAgICAgICBpZiAoY29sLmNoaWxkTGlzdCAmJiBjb2wuY2hpbGRMaXN0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgdGhpcy5nZXRDb2x1bW4obnVsbCwgY29sLmNoaWxkTGlzdCwgY29sY2FjaGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==