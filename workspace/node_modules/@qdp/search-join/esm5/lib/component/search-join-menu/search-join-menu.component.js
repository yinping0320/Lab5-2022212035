/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, HostListener, ElementRef, RendererFactory2, Input, Optional, Injector } from '@angular/core';
import { MenuControllerService } from '../../service/menu-controller.service';
import { FrameworkService, AppService } from '@gsp-sys/rtf-common';
import { CacheService } from '@ecp-caf/caf-common';
import { JointSearchExtendService } from '@qdp/common';
import { EventBus, RtfServices } from '@qdp/common';
var SearchJoinMenuComponent = /** @class */ (function () {
    function SearchJoinMenuComponent(elementRef, renderFactory, menuControllerService, frameWorkService, cacheService, jointSearchExtendService, injector) {
        var _this = this;
        this.elementRef = elementRef;
        this.renderFactory = renderFactory;
        this.menuControllerService = menuControllerService;
        this.frameWorkService = frameWorkService;
        this.cacheService = cacheService;
        this.jointSearchExtendService = jointSearchExtendService;
        this.injector = injector;
        if (this.injector) {
            this.appService = this.injector.get(AppService);
        }
        this.formId = 'form' + 'ff3ea474-cc65-23b0-cdb1-73c9146cea3b';
        this.renderer = this.renderFactory.createRenderer(null, null);
        menuControllerService.jointsearchInfoChange.subscribe((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            if (value) {
                _this.searchList = value;
            }
        }));
    }
    /**
     * @return {?}
     */
    SearchJoinMenuComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var self = this;
        this.menuControllerService.getSearchList(this.formId, this.queryId, this.queryRelativeUrl).subscribe((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            if (value) {
                /** @type {?} */
                var _searchList = JSON.parse(value['joinSearch']);
                _searchList.forEach((/**
                 * @param {?} searchL
                 * @return {?}
                 */
                function (searchL) {
                    if (!searchL.searchtype) {
                        searchL.searchtype = 'func';
                        searchL.appEntrance = '';
                    }
                    searchL.functionname = self.getFunctionName(searchL.functionname);
                }));
                _this.searchPara = JSON.parse(value['jointparam']);
                _this.cacheService.set(_this.queryId + 'beforeJointSearchMenuShow', _searchList);
            }
        }));
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    SearchJoinMenuComponent.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
    };
    /**
     * 当点击某一个路由之后，隐藏菜单组件
     */
    /**
     * 当点击某一个路由之后，隐藏菜单组件
     * @return {?}
     */
    SearchJoinMenuComponent.prototype.handleClick = /**
     * 当点击某一个路由之后，隐藏菜单组件
     * @return {?}
     */
    function () {
        this.renderer.setStyle(this.elementRef.nativeElement, 'display', 'none');
    };
    /**
     * 路由到结果页
     * param id 联查功能主键id
     * param functionid 功能菜单id
     */
    /**
     * 路由到结果页
     * param id 联查功能主键id
     * param functionid 功能菜单id
     * @param {?} id
     * @param {?} functionid
     * @param {?} queryId
     * @return {?}
     */
    SearchJoinMenuComponent.prototype.routeTo = /**
     * 路由到结果页
     * param id 联查功能主键id
     * param functionid 功能菜单id
     * @param {?} id
     * @param {?} functionid
     * @param {?} queryId
     * @return {?}
     */
    function (id, functionid, queryId) {
        /** @type {?} */
        var self = this;
        /** @type {?} */
        var chooseList = {};
        this.searchList.forEach((/**
         * @param {?} searchL
         * @return {?}
         */
        function (searchL) {
            if (searchL.id === id) {
                chooseList = searchL;
            }
        }));
        /** @type {?} */
        var entityParam = { 'id': 'null' };
        /** @type {?} */
        var paramMap = new Map();
        /** @type {?} */
        var searchparas = this.searchPara.filter((/**
         * @param {?} x
         * @return {?}
         */
        function (x) { return x.functionid === id; }));
        // 查找对应的参数列表
        /** @type {?} */
        var currentSelectedItem = this.cacheService.get(this.queryId + 'currentSelectItem');
        if (searchparas.length > 0) {
            searchparas.forEach((/**
             * @param {?} value
             * @return {?}
             */
            function (value) {
                if (value.paravaluetype) { // 表达式
                    if (value.paravalue.indexOf('getParameter(') >= 0) {
                        /** @type {?} */
                        var parameterKey = value.paravalue.replace(/'/g, '').replace(/"/g, '').replace(/getParameter\(/g, '').replace(/\)/g, '');
                        self.getQueryParameters(entityParam, paramMap, parameterKey, value.para);
                    }
                    else {
                        entityParam[value.para] = currentSelectedItem[value.paravalue];
                        paramMap.set(value.para, currentSelectedItem[value.paravalue]);
                    }
                }
                else {
                    entityParam[value.para] = value.paravalue;
                    paramMap.set(value.para, value.paravalue);
                }
            }));
        }
        else {
            entityParam = currentSelectedItem;
        }
        /** @type {?} */
        var options = {
            ParentSessionId: this.cacheService.get('session'),
            EntityParam: entityParam
        };
        /** @type {?} */
        var $event = {};
        if (this.jointSearchExtendService && this.jointSearchExtendService.beforeJointSearch) {
            $event['eventCode'] = 'beforeJointSearch';
            $event['eventName'] = 'drill before';
            $event['data'] = {
                'functionid': functionid,
                'options': options,
                'queryId': queryId,
                'orginQueryId': this.queryId,
                'qdpView': this.menuControllerService.qdpView
            };
            this.jointSearchExtendService.beforeJointSearch($event);
            if ($event && $event['data'] && $event['data'].options) {
                options = Object.assign(options, $event['data'].options);
            }
            if (chooseList.searchtype === 'url' || chooseList.searchtype === 'additional') {
                return;
            }
        }
        // this.cacheService.set(queryId, options.EntityParam);
        /** @type {?} */
        var tabId = '';
        if (chooseList.searchtype === 'func') {
            // 联查前
            /** @type {?} */
            var openMenuoptions = {
                'appType': 'menu',
                'funcId': functionid,
                'tabId': EventBus.guid(),
                'appId': '',
                'appEntrance': '',
                'entityParams': $event['entityParams'] || entityParam,
                'queryStringParams': paramMap,
                'isNewTab': true
            };
            tabId = RtfServices.getFuncId(openMenuoptions);
            /** @type {?} */
            var menuSwitchControl = Object.assign({}, openMenuoptions['entityParams'], RtfServices.getMenuSwitchControlParameter(tabId));
            openMenuoptions['entityParams'] = menuSwitchControl;
            this.cacheService.set(tabId ? tabId : queryId, options.EntityParam);
            // 卡片塞进去params
            this.frameWorkService.openMenu(openMenuoptions);
        }
        else if (chooseList.searchtype === 'app') {
            /** @type {?} */
            var appOption = {
                appType: 'app',
                appId: functionid,
                appEntrance: chooseList.appEntrance,
                funcId: '',
                isReload: true,
                tabId: EventBus.guid(),
                entityParams: $event['entityParams'] || entityParam,
                queryStringParams: paramMap
            };
            tabId = RtfServices.getFuncId(appOption);
            this.cacheService.set(tabId ? tabId : queryId, options.EntityParam);
            /** @type {?} */
            var menuSwitchControl = Object.assign({}, appOption['entityParams'], RtfServices.getMenuSwitchControlParameter(tabId));
            appOption['entityParams'] = menuSwitchControl;
            this.frameWorkService.openMenu(appOption);
        }
    };
    /**
     * @param {?} data
     * @return {?}
     */
    SearchJoinMenuComponent.prototype.getFunctionName = /**
     * @param {?} data
     * @return {?}
     */
    function (data) {
        /** @type {?} */
        var local = 'zh-chs';
        if (gspframeworkService) {
            local = gspframeworkService.rtf.language.getLanguageCode().toLowerCase();
        }
        if (!local) {
            local = 'zh-chs';
        }
        return data[local] ? data[local] : data;
    };
    /**
     * @private
     * @param {?} entityParam
     * @param {?} paramMap
     * @param {?} parameterKey
     * @param {?} key
     * @return {?}
     */
    SearchJoinMenuComponent.prototype.getQueryParameters = /**
     * @private
     * @param {?} entityParam
     * @param {?} paramMap
     * @param {?} parameterKey
     * @param {?} key
     * @return {?}
     */
    function (entityParam, paramMap, parameterKey, key) {
        try {
            /** @type {?} */
            var tab = gspframeworkService.rtf.session.getCommonVariable();
            if (tab && tab.tabId) {
                /** @type {?} */
                var tid = tab.tabId + RtfServices.getInSuiteFrmUUID();
                if (this.cacheService.get(tid) && this.cacheService.get(tid)[parameterKey]) {
                    entityParam[key] = this.cacheService.get(tid)[parameterKey];
                    paramMap.set(key, this.cacheService.get(tid)[parameterKey]);
                }
            }
        }
        catch (e) {
        }
    };
    SearchJoinMenuComponent.decorators = [
        { type: Component, args: [{
                    selector: 'qdp-search-join-menu',
                    template: "<div *ngIf=\"searchList && searchList.length && searchList.length > 0\">\r\n  <div class=\"dropdown-menu\" style=\"display:block\">\r\n    <div *ngFor=\"let item of searchList\">\r\n      <button class=\"dropdown-item\" (click)=\"routeTo(item.id,item.functioncode,item.destinationqueryId)\">{{item.functionname}}</button>\r\n    </div>\r\n  </div>\r\n</div>\r\n",
                    styles: [":host{position:fixed;display:none;top:0;left:0}"]
                }] }
    ];
    /** @nocollapse */
    SearchJoinMenuComponent.ctorParameters = function () { return [
        { type: ElementRef },
        { type: RendererFactory2 },
        { type: MenuControllerService },
        { type: FrameworkService },
        { type: CacheService },
        { type: JointSearchExtendService, decorators: [{ type: Optional }] },
        { type: Injector, decorators: [{ type: Optional }] }
    ]; };
    SearchJoinMenuComponent.propDecorators = {
        queryId: [{ type: Input }],
        queryRelativeUrl: [{ type: Input }],
        qoManagerCode: [{ type: Input }],
        searchList: [{ type: Input }],
        handleClick: [{ type: HostListener, args: ['click',] }]
    };
    return SearchJoinMenuComponent;
}());
export { SearchJoinMenuComponent };
if (false) {
    /** @type {?} */
    SearchJoinMenuComponent.prototype.queryId;
    /** @type {?} */
    SearchJoinMenuComponent.prototype.queryRelativeUrl;
    /** @type {?} */
    SearchJoinMenuComponent.prototype.qoManagerCode;
    /** @type {?} */
    SearchJoinMenuComponent.prototype.formId;
    /** @type {?} */
    SearchJoinMenuComponent.prototype.searchList;
    /** @type {?} */
    SearchJoinMenuComponent.prototype.searchPara;
    /** @type {?} */
    SearchJoinMenuComponent.prototype.currentSelectedItem;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.renderer;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.appService;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.elementRef;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.renderFactory;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.menuControllerService;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.frameWorkService;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.cacheService;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.jointSearchExtendService;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLWpvaW4tbWVudS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcWRwL3NlYXJjaC1qb2luLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudC9zZWFyY2gtam9pbi1tZW51L3NlYXJjaC1qb2luLW1lbnUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUVULFlBQVksRUFDWixVQUFVLEVBRVYsZ0JBQWdCLEVBQ2hCLEtBQUssRUFDTCxRQUFRLEVBR1IsUUFBUSxFQUNULE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBQzlFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkQsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3ZELE9BQU8sRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBSXBEO0lBZ0JFLGlDQUNVLFVBQXNCLEVBQ3RCLGFBQStCLEVBQy9CLHFCQUE0QyxFQUM1QyxnQkFBa0MsRUFDbEMsWUFBMEIsRUFDZCx3QkFBa0QsRUFDbEQsUUFBa0I7UUFQeEMsaUJBb0JDO1FBbkJTLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIsa0JBQWEsR0FBYixhQUFhLENBQWtCO1FBQy9CLDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBdUI7UUFDNUMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUNkLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUN0QyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDakIsSUFBSSxDQUFDLFVBQVUsR0FB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QUMsQ0FBQyxZQUFZLENBQUMsRUFBRTtvQkFDMUUsV0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDO29CQUM1RCxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO2lCQUM3RDthQUNGO1NBQ0Y7UUFBQyxPQUFPLENBQUMsRUFBRTtTQUNYO0lBQ0gsQ0FBQzs7Z0JBN0xGLFNBQVMsU0FBQztvQkFDVCxRQUFRLEVBQUUsc0JBQXNCO29CQUNoQyxxWEFBZ0Q7O2lCQUVqRDs7OztnQkFyQkMsVUFBVTtnQkFFVixnQkFBZ0I7Z0JBT1QscUJBQXFCO2dCQUNyQixnQkFBZ0I7Z0JBQ2hCLFlBQVk7Z0JBQ1osd0JBQXdCLHVCQTJCNUIsUUFBUTtnQkFoQ1gsUUFBUSx1QkFpQ0wsUUFBUTs7OzBCQWpCVixLQUFLO21DQUNMLEtBQUs7Z0NBQ0wsS0FBSzs2QkFFTCxLQUFLOzhCQXFETCxZQUFZLFNBQUMsT0FBTzs7SUErSHZCLDhCQUFDO0NBQUEsQUE5TEQsSUE4TEM7U0F6TFksdUJBQXVCOzs7SUFDbEMsMENBQXNCOztJQUN0QixtREFBK0I7O0lBQy9CLGdEQUE0Qjs7SUFDNUIseUNBQVk7O0lBQ1osNkNBQTJCOztJQUMzQiw2Q0FBeUI7O0lBQ3pCLHNEQUF5Qjs7Ozs7SUFDekIsMkNBQTRCOzs7OztJQUM1Qiw2Q0FBK0I7Ozs7O0lBRzdCLDZDQUE4Qjs7Ozs7SUFDOUIsZ0RBQXVDOzs7OztJQUN2Qyx3REFBb0Q7Ozs7O0lBQ3BELG1EQUEwQzs7Ozs7SUFDMUMsK0NBQWtDOzs7OztJQUNsQywyREFBc0U7Ozs7O0lBQ3RFLDJDQUFzQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgQ29tcG9uZW50LFxyXG4gIE9uSW5pdCxcclxuICBIb3N0TGlzdGVuZXIsXHJcbiAgRWxlbWVudFJlZixcclxuICBSZW5kZXJlcjIsXHJcbiAgUmVuZGVyZXJGYWN0b3J5MixcclxuICBJbnB1dCxcclxuICBPcHRpb25hbCxcclxuICBTaW1wbGVDaGFuZ2VzLFxyXG4gIE9uQ2hhbmdlcyxcclxuICBJbmplY3RvclxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBNZW51Q29udHJvbGxlclNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlL21lbnUtY29udHJvbGxlci5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRnJhbWV3b3JrU2VydmljZSwgQXBwU2VydmljZSB9IGZyb20gJ0Bnc3Atc3lzL3J0Zi1jb21tb24nO1xyXG5pbXBvcnQgeyBDYWNoZVNlcnZpY2UgfSBmcm9tICdAZWNwLWNhZi9jYWYtY29tbW9uJztcclxuaW1wb3J0IHsgSm9pbnRTZWFyY2hFeHRlbmRTZXJ2aWNlIH0gZnJvbSAnQHFkcC9jb21tb24nO1xyXG5pbXBvcnQgeyBFdmVudEJ1cywgUnRmU2VydmljZXMgfSBmcm9tICdAcWRwL2NvbW1vbic7XHJcblxyXG5kZWNsYXJlIHZhciBnc3BmcmFtZXdvcmtTZXJ2aWNlOiBhbnk7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ3FkcC1zZWFyY2gtam9pbi1tZW51JyxcclxuICB0ZW1wbGF0ZVVybDogJy4vc2VhcmNoLWpvaW4tbWVudS5jb21wb25lbnQuaHRtbCcsXHJcbiAgc3R5bGVVcmxzOiBbJy4vc2VhcmNoLWpvaW4tbWVudS5jb21wb25lbnQuY3NzJ10sXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBTZWFyY2hKb2luTWVudUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcclxuICBASW5wdXQoKSBxdWVyeUlkOiBhbnk7XHJcbiAgQElucHV0KCkgcXVlcnlSZWxhdGl2ZVVybDogYW55O1xyXG4gIEBJbnB1dCgpIHFvTWFuYWdlckNvZGU6IGFueTtcclxuICBmb3JtSWQ6IGFueTtcclxuICBASW5wdXQoKSBzZWFyY2hMaXN0OiBhbnlbXTtcclxuICBwdWJsaWMgc2VhcmNoUGFyYTogYW55W107XHJcbiAgY3VycmVudFNlbGVjdGVkSXRlbTogYW55O1xyXG4gIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMjtcclxuICBwcml2YXRlIGFwcFNlcnZpY2U6IEFwcFNlcnZpY2U7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmLFxyXG4gICAgcHJpdmF0ZSByZW5kZXJGYWN0b3J5OiBSZW5kZXJlckZhY3RvcnkyLFxyXG4gICAgcHJpdmF0ZSBtZW51Q29udHJvbGxlclNlcnZpY2U6IE1lbnVDb250cm9sbGVyU2VydmljZSxcclxuICAgIHByaXZhdGUgZnJhbWVXb3JrU2VydmljZTogRnJhbWV3b3JrU2VydmljZSxcclxuICAgIHByaXZhdGUgY2FjaGVTZXJ2aWNlOiBDYWNoZVNlcnZpY2UsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGpvaW50U2VhcmNoRXh0ZW5kU2VydmljZTogSm9pbnRTZWFyY2hFeHRlbmRTZXJ2aWNlLFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuICAgIGlmICh0aGlzLmluamVjdG9yKSB7XHJcbiAgICAgIHRoaXMuYXBwU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KEFwcFNlcnZpY2UpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5mb3JtSWQgPSAnZm9ybScgKyAnZmYzZWE0NzQtY2M2NS0yM2IwLWNkYjEtNzNjOTE0NmNlYTNiJztcclxuICAgIHRoaXMucmVuZGVyZXIgPSB0aGlzLnJlbmRlckZhY3RvcnkuY3JlYXRlUmVuZGVyZXIobnVsbCwgbnVsbCk7XHJcblxyXG4gICAgbWVudUNvbnRyb2xsZXJTZXJ2aWNlLmpvaW50c2VhcmNoSW5mb0NoYW5nZS5zdWJzY3JpYmUoKHZhbHVlKSA9PiB7XHJcbiAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgIHRoaXMuc2VhcmNoTGlzdCA9IHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICBjb25zdCBzZWxmID0gdGhpcztcclxuICAgIHRoaXMubWVudUNvbnRyb2xsZXJTZXJ2aWNlLmdldFNlYXJjaExpc3QodGhpcy5mb3JtSWQsIHRoaXMucXVlcnlJZCwgdGhpcy5xdWVyeVJlbGF0aXZlVXJsKS5zdWJzY3JpYmUoXHJcbiAgICAgIHZhbHVlID0+IHtcclxuICAgICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICAgIGNvbnN0IF9zZWFyY2hMaXN0ID0gSlNPTi5wYXJzZSh2YWx1ZVsnam9pblNlYXJjaCddKTtcclxuICAgICAgICAgIF9zZWFyY2hMaXN0LmZvckVhY2goc2VhcmNoTCA9PiB7XHJcbiAgICAgICAgICAgIGlmICghc2VhcmNoTC5zZWFyY2h0eXBlKSB7XHJcbiAgICAgICAgICAgICAgc2VhcmNoTC5zZWFyY2h0eXBlID0gJ2Z1bmMnO1xyXG4gICAgICAgICAgICAgIHNlYXJjaEwuYXBwRW50cmFuY2UgPSAnJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBzZWFyY2hMLmZ1bmN0aW9ubmFtZSA9IHNlbGYuZ2V0RnVuY3Rpb25OYW1lKHNlYXJjaEwuZnVuY3Rpb25uYW1lKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgdGhpcy5zZWFyY2hQYXJhID0gSlNPTi5wYXJzZSh2YWx1ZVsnam9pbnRwYXJhbSddKTtcclxuICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlLnNldCh0aGlzLnF1ZXJ5SWQgKyAnYmVmb3JlSm9pbnRTZWFyY2hNZW51U2hvdycsIF9zZWFyY2hMaXN0KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5b2T54K55Ye75p+Q5LiA5Liq6Lev55Sx5LmL5ZCO77yM6ZqQ6JeP6I+c5Y2V57uE5Lu2XHJcbiAgICovXHJcbiAgQEhvc3RMaXN0ZW5lcignY2xpY2snKVxyXG4gIGhhbmRsZUNsaWNrKCkge1xyXG4gICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ2Rpc3BsYXknLCAnbm9uZScpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6Lev55Sx5Yiw57uT5p6c6aG1XHJcbiAgICogcGFyYW0gaWQg6IGU5p+l5Yqf6IO95Li76ZSuaWRcclxuICAgKiBwYXJhbSBmdW5jdGlvbmlkIOWKn+iDveiPnOWNlWlkXHJcbiAgICovXHJcbiAgcHVibGljIHJvdXRlVG8oaWQ6IGFueSwgZnVuY3Rpb25pZDogYW55LCBxdWVyeUlkOiBhbnkpIHtcclxuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgbGV0IGNob29zZUxpc3Q6IGFueSA9IHt9O1xyXG4gICAgdGhpcy5zZWFyY2hMaXN0LmZvckVhY2goc2VhcmNoTCA9PiB7XHJcbiAgICAgIGlmIChzZWFyY2hMLmlkID09PSBpZCkge1xyXG4gICAgICAgIGNob29zZUxpc3QgPSBzZWFyY2hMO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBsZXQgZW50aXR5UGFyYW0gPSB7ICdpZCc6ICdudWxsJyB9O1xyXG4gICAgY29uc3QgcGFyYW1NYXAgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xyXG4gICAgY29uc3Qgc2VhcmNocGFyYXM6IGFueVtdID0gdGhpcy5zZWFyY2hQYXJhLmZpbHRlcih4ID0+IHguZnVuY3Rpb25pZCA9PT0gaWQpOyAvLyDmn6Xmib7lr7nlupTnmoTlj4LmlbDliJfooahcclxuICAgIGNvbnN0IGN1cnJlbnRTZWxlY3RlZEl0ZW0gPSB0aGlzLmNhY2hlU2VydmljZS5nZXQodGhpcy5xdWVyeUlkICsgJ2N1cnJlbnRTZWxlY3RJdGVtJyk7IC8vIOW9k+WJjemAieS4reaVsOaNrlxyXG4gICAgaWYgKHNlYXJjaHBhcmFzLmxlbmd0aCA+IDApIHtcclxuICAgICAgc2VhcmNocGFyYXMuZm9yRWFjaCh2YWx1ZSA9PiB7XHJcbiAgICAgICAgaWYgKHZhbHVlLnBhcmF2YWx1ZXR5cGUpIHsvLyDooajovr7lvI9cclxuICAgICAgICAgIGlmICh2YWx1ZS5wYXJhdmFsdWUuaW5kZXhPZignZ2V0UGFyYW1ldGVyKCcpID49IDApIHtcclxuICAgICAgICAgICAgY29uc3QgcGFyYW1ldGVyS2V5ID0gdmFsdWUucGFyYXZhbHVlLnJlcGxhY2UoLycvZywgJycpLnJlcGxhY2UoL1wiL2csICcnKS5yZXBsYWNlKC9nZXRQYXJhbWV0ZXJcXCgvZywgJycpLnJlcGxhY2UoL1xcKS9nLCAnJyk7XHJcbiAgICAgICAgICAgIHNlbGYuZ2V0UXVlcnlQYXJhbWV0ZXJzKGVudGl0eVBhcmFtLCBwYXJhbU1hcCwgcGFyYW1ldGVyS2V5LCB2YWx1ZS5wYXJhKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGVudGl0eVBhcmFtW3ZhbHVlLnBhcmFdID0gY3VycmVudFNlbGVjdGVkSXRlbVt2YWx1ZS5wYXJhdmFsdWVdO1xyXG4gICAgICAgICAgICBwYXJhbU1hcC5zZXQodmFsdWUucGFyYSwgY3VycmVudFNlbGVjdGVkSXRlbVt2YWx1ZS5wYXJhdmFsdWVdKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgZW50aXR5UGFyYW1bdmFsdWUucGFyYV0gPSB2YWx1ZS5wYXJhdmFsdWU7XHJcbiAgICAgICAgICBwYXJhbU1hcC5zZXQodmFsdWUucGFyYSwgdmFsdWUucGFyYXZhbHVlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZW50aXR5UGFyYW0gPSBjdXJyZW50U2VsZWN0ZWRJdGVtO1xyXG4gICAgfVxyXG4gICAgbGV0IG9wdGlvbnM6IGFueSA9IHtcclxuICAgICAgUGFyZW50U2Vzc2lvbklkOiB0aGlzLmNhY2hlU2VydmljZS5nZXQoJ3Nlc3Npb24nKSxcclxuICAgICAgRW50aXR5UGFyYW06IGVudGl0eVBhcmFtXHJcbiAgICB9O1xyXG4gICAgY29uc3QgJGV2ZW50ID0ge307XHJcbiAgICBpZiAodGhpcy5qb2ludFNlYXJjaEV4dGVuZFNlcnZpY2UgJiYgdGhpcy5qb2ludFNlYXJjaEV4dGVuZFNlcnZpY2UuYmVmb3JlSm9pbnRTZWFyY2gpIHtcclxuICAgICAgJGV2ZW50WydldmVudENvZGUnXSA9ICdiZWZvcmVKb2ludFNlYXJjaCc7XHJcbiAgICAgICRldmVudFsnZXZlbnROYW1lJ10gPSAnZHJpbGwgYmVmb3JlJztcclxuICAgICAgJGV2ZW50WydkYXRhJ10gPSB7XHJcbiAgICAgICAgJ2Z1bmN0aW9uaWQnOiBmdW5jdGlvbmlkLFxyXG4gICAgICAgICdvcHRpb25zJzogb3B0aW9ucyxcclxuICAgICAgICAncXVlcnlJZCc6IHF1ZXJ5SWQsXHJcbiAgICAgICAgJ29yZ2luUXVlcnlJZCc6IHRoaXMucXVlcnlJZCxcclxuICAgICAgICAncWRwVmlldyc6IHRoaXMubWVudUNvbnRyb2xsZXJTZXJ2aWNlLnFkcFZpZXdcclxuICAgICAgfTtcclxuICAgICAgdGhpcy5qb2ludFNlYXJjaEV4dGVuZFNlcnZpY2UuYmVmb3JlSm9pbnRTZWFyY2goJGV2ZW50KTtcclxuICAgICAgaWYgKCRldmVudCAmJiAkZXZlbnRbJ2RhdGEnXSAmJiAkZXZlbnRbJ2RhdGEnXS5vcHRpb25zKSB7XHJcbiAgICAgICAgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24ob3B0aW9ucywgJGV2ZW50WydkYXRhJ10ub3B0aW9ucyk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGNob29zZUxpc3Quc2VhcmNodHlwZSA9PT0gJ3VybCcgfHwgY2hvb3NlTGlzdC5zZWFyY2h0eXBlID09PSAnYWRkaXRpb25hbCcpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIHRoaXMuY2FjaGVTZXJ2aWNlLnNldChxdWVyeUlkLCBvcHRpb25zLkVudGl0eVBhcmFtKTtcclxuICAgIGxldCB0YWJJZCA9ICcnO1xyXG4gICAgaWYgKGNob29zZUxpc3Quc2VhcmNodHlwZSA9PT0gJ2Z1bmMnKSB7XHJcbiAgICAgIC8vIOiBlOafpeWJjVxyXG4gICAgICBjb25zdCBvcGVuTWVudW9wdGlvbnMgPSB7XHJcbiAgICAgICAgJ2FwcFR5cGUnOiAnbWVudScsXHJcbiAgICAgICAgJ2Z1bmNJZCc6IGZ1bmN0aW9uaWQsXHJcbiAgICAgICAgJ3RhYklkJzogRXZlbnRCdXMuZ3VpZCgpLFxyXG4gICAgICAgICdhcHBJZCc6ICcnLFxyXG4gICAgICAgICdhcHBFbnRyYW5jZSc6ICcnLFxyXG4gICAgICAgICdlbnRpdHlQYXJhbXMnOiAkZXZlbnRbJ2VudGl0eVBhcmFtcyddIHx8IGVudGl0eVBhcmFtLFxyXG4gICAgICAgICdxdWVyeVN0cmluZ1BhcmFtcyc6IHBhcmFtTWFwLFxyXG4gICAgICAgICdpc05ld1RhYic6IHRydWVcclxuICAgICAgfTtcclxuICAgICAgdGFiSWQgPSBSdGZTZXJ2aWNlcy5nZXRGdW5jSWQob3Blbk1lbnVvcHRpb25zKTtcclxuICAgICAgY29uc3QgbWVudVN3aXRjaENvbnRyb2wgPSBPYmplY3QuYXNzaWduKHt9LCBvcGVuTWVudW9wdGlvbnNbJ2VudGl0eVBhcmFtcyddLCBSdGZTZXJ2aWNlcy5nZXRNZW51U3dpdGNoQ29udHJvbFBhcmFtZXRlcih0YWJJZCkpO1xyXG4gICAgICBvcGVuTWVudW9wdGlvbnNbJ2VudGl0eVBhcmFtcyddID0gbWVudVN3aXRjaENvbnRyb2w7XHJcbiAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlLnNldCh0YWJJZCA/IHRhYklkIDogcXVlcnlJZCwgb3B0aW9ucy5FbnRpdHlQYXJhbSk7XHJcbiAgICAgIC8vIOWNoeeJh+Whnui/m+WOu3BhcmFtc1xyXG4gICAgICB0aGlzLmZyYW1lV29ya1NlcnZpY2Uub3Blbk1lbnUob3Blbk1lbnVvcHRpb25zKTtcclxuICAgIH0gZWxzZSBpZiAoY2hvb3NlTGlzdC5zZWFyY2h0eXBlID09PSAnYXBwJykge1xyXG4gICAgICBjb25zdCBhcHBPcHRpb24gPSB7XHJcbiAgICAgICAgYXBwVHlwZTogJ2FwcCcsXHJcbiAgICAgICAgYXBwSWQ6IGZ1bmN0aW9uaWQsXHJcbiAgICAgICAgYXBwRW50cmFuY2U6IGNob29zZUxpc3QuYXBwRW50cmFuY2UsXHJcbiAgICAgICAgZnVuY0lkOiAnJyxcclxuICAgICAgICBpc1JlbG9hZDogdHJ1ZSxcclxuICAgICAgICB0YWJJZDogRXZlbnRCdXMuZ3VpZCgpLFxyXG4gICAgICAgIGVudGl0eVBhcmFtczogJGV2ZW50WydlbnRpdHlQYXJhbXMnXSB8fCBlbnRpdHlQYXJhbSxcclxuICAgICAgICBxdWVyeVN0cmluZ1BhcmFtczogcGFyYW1NYXBcclxuICAgICAgfTtcclxuICAgICAgdGFiSWQgPSBSdGZTZXJ2aWNlcy5nZXRGdW5jSWQoYXBwT3B0aW9uKTtcclxuICAgICAgdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KHRhYklkID8gdGFiSWQgOiBxdWVyeUlkLCBvcHRpb25zLkVudGl0eVBhcmFtKTtcclxuICAgICAgY29uc3QgbWVudVN3aXRjaENvbnRyb2wgPSBPYmplY3QuYXNzaWduKHt9LCBhcHBPcHRpb25bJ2VudGl0eVBhcmFtcyddLCBSdGZTZXJ2aWNlcy5nZXRNZW51U3dpdGNoQ29udHJvbFBhcmFtZXRlcih0YWJJZCkpO1xyXG4gICAgICBhcHBPcHRpb25bJ2VudGl0eVBhcmFtcyddID0gbWVudVN3aXRjaENvbnRyb2w7XHJcbiAgICAgIHRoaXMuZnJhbWVXb3JrU2VydmljZS5vcGVuTWVudShhcHBPcHRpb24pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0RnVuY3Rpb25OYW1lKGRhdGE6IGFueSkge1xyXG4gICAgbGV0IGxvY2FsID0gJ3poLWNocyc7XHJcbiAgICBpZiAoZ3NwZnJhbWV3b3JrU2VydmljZSkge1xyXG4gICAgICBsb2NhbCA9IGdzcGZyYW1ld29ya1NlcnZpY2UucnRmLmxhbmd1YWdlLmdldExhbmd1YWdlQ29kZSgpLnRvTG93ZXJDYXNlKCk7XHJcbiAgICB9XHJcbiAgICBpZiAoIWxvY2FsKSB7XHJcbiAgICAgIGxvY2FsID0gJ3poLWNocyc7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZGF0YVtsb2NhbF0gPyBkYXRhW2xvY2FsXSA6IGRhdGE7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldFF1ZXJ5UGFyYW1ldGVycyhlbnRpdHlQYXJhbTogYW55LCBwYXJhbU1hcDogYW55LCBwYXJhbWV0ZXJLZXk6IGFueSwga2V5OiBhbnkpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHRhYiA9IGdzcGZyYW1ld29ya1NlcnZpY2UucnRmLnNlc3Npb24uZ2V0Q29tbW9uVmFyaWFibGUoKTtcclxuICAgICAgaWYgKHRhYiAmJiB0YWIudGFiSWQpIHtcclxuICAgICAgICBjb25zdCB0aWQgPSB0YWIudGFiSWQgKyBSdGZTZXJ2aWNlcy5nZXRJblN1aXRlRnJtVVVJRCgpO1xyXG4gICAgICAgIGlmICh0aGlzLmNhY2hlU2VydmljZS5nZXQodGlkKSAmJiB0aGlzLmNhY2hlU2VydmljZS5nZXQodGlkKVtwYXJhbWV0ZXJLZXldKSB7XHJcbiAgICAgICAgICBlbnRpdHlQYXJhbVtrZXldID0gdGhpcy5jYWNoZVNlcnZpY2UuZ2V0KHRpZClbcGFyYW1ldGVyS2V5XTtcclxuICAgICAgICAgIHBhcmFtTWFwLnNldChrZXksIHRoaXMuY2FjaGVTZXJ2aWNlLmdldCh0aWQpW3BhcmFtZXRlcktleV0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=