/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, RendererFactory2 } from '@angular/core';
import { CacheService } from '@ecp-caf/caf-common';
import { SearchListService } from './search-list.service';
import { map } from 'rxjs/operators';
import { Subject, of } from 'rxjs';
import { LoadingService } from '@farris/ui-loading';
import { RtfServices } from '@qdp/common';
export class MenuControllerService {
    /**
     * @param {?} rendererFactory
     * @param {?} cacheService
     * @param {?} searchListService
     * @param {?} cache
     * @param {?} loadingService
     */
    constructor(rendererFactory, cacheService, searchListService, cache, loadingService) {
        this.rendererFactory = rendererFactory;
        this.cacheService = cacheService;
        this.searchListService = searchListService;
        this.cache = cache;
        this.loadingService = loadingService;
        this.jointsearchInfoChange = new Subject();
        this.render = rendererFactory.createRenderer(null, null);
    }
    /**
     * @param {?} $event
     * @param {?} elementRef
     * @param {?} qdpView
     * @param {?} qdpViewElementRef
     * @return {?}
     */
    handleContextmenu($event, elementRef, qdpView, qdpViewElementRef) {
        this.qdpView = qdpView;
        // const loading = this.loadingService.show({ container: qdpViewElementRef });
        /** @type {?} */
        const joinParam = this.cache.get(RtfServices.getTabId(this._queryId) + 'joinSearch');
        if (!this.checkDataArea(qdpView, qdpViewElementRef, joinParam, $event) || !this._searchList) {
            return false;
        }
        /** @type {?} */
        let left = 0;
        /** @type {?} */
        let top = 0;
        if (joinParam && joinParam.controlType !== 'charts') {
            left = $event.clientX;
            top = $event.clientY;
        }
        else {
            left = $event.event.event.clientX;
            top = $event.event.event.clientY;
        }
        this.render.setStyle(elementRef.nativeElement, 'left', left + 'px');
        this.render.setStyle(elementRef.nativeElement, 'top', top + 'px');
        this.render.setStyle(elementRef.nativeElement, 'display', 'block');
        this.cacheService.set(this._queryId + 'currentSelectItem', this.currentSelectItem); // 将当前参数设置到缓存中
        // 将当前参数设置到缓存中
        // 联查可见表达式
        /** @type {?} */
        const searchList = this.cacheService.get(this._queryId + 'beforeJointSearchMenuShow');
        /** @type {?} */
        const formulas = {};
        /** @type {?} */
        let containVisibleFormula = false;
        for (const search of searchList) {
            formulas[search.id] = search.visibleformula;
            if (containVisibleFormula === false && search.visibleformula != void 0 && search.visibleformula !== '') {
                containVisibleFormula = true;
            }
        }
        if (containVisibleFormula === true) {
            /** @type {?} */
            const param = { qoManagerCode: qdpView.qoManagerCode, visibleFormulas: formulas, userId: '', queryId: this._queryId, rowData: this.currentSelectItem };
            this.searchListService.getVisibleJoint(param, qdpView.queryRelativeUrl, searchList).subscribe((/**
             * @param {?} value
             * @return {?}
             */
            value => {
                if (value) {
                    this.jointsearchInfoChange.next(value);
                }
            }));
        }
        else {
            this.jointsearchInfoChange.next(searchList);
        }
        return false;
    }
    /**
     * 单击之后隐藏菜单
     * @param {?} elementRef 菜单组件
     * @return {?}
     */
    handleClick(elementRef) {
        if (elementRef) {
            this.render.setStyle(elementRef.nativeElement, 'display', 'none');
        }
    }
    /**
     * get searchList
     * @param {?} formId
     * @param {?} queryId
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    getSearchList(formId, queryId, queryRelativeUrl) {
        this._queryId = queryId;
        if (this._searchList && this._searchList.queryId === this._queryId) {
            return of(this._searchList);
        }
        /** @type {?} */
        const result = this.searchListService.getSearchList(formId, queryId, queryRelativeUrl);
        return result.pipe(map((/**
         * @param {?} value
         * @return {?}
         */
        (value) => {
            this._searchList = value; // ? JSON.parse(value.joinSearch) : [];
            return this._searchList;
        })));
    }
    /**
     * 返回当前右键坐标，是否为数据区域
     * @private
     * @param {?} qdpView qdp-view 组件
     * @param {?} qdpViewElementRef qdp-view ElementRef
     * @param {?} joinParam
     * @param {?} $event 触发事件，主要用来传递坐标
     * @return {?}
     */
    checkDataArea(qdpView, qdpViewElementRef, joinParam, $event) {
        /** @type {?} */
        let x = 0;
        /** @type {?} */
        let y = 0;
        /** @type {?} */
        let qdpviewNative = qdpViewElementRef.nativeElement;
        while (qdpviewNative) {
            x += qdpviewNative.offsetLeft;
            y += qdpviewNative.offsetTop;
            qdpviewNative = qdpviewNative.offsetParent;
        }
        if (joinParam.controlType !== 'charts') {
            /** @type {?} */
            const activeSheet = qdpView.spread.getActiveSheet();
            /** @type {?} */
            const target = activeSheet.hitTest($event.clientX - x, $event.clientY - y);
            if (target.hitTestType !== GC.Spread.Sheets.SheetArea.viewport || target.col === undefined || target.row === undefined) {
                return false;
            }
            activeSheet.setActiveCell(target.row, target.col);
            // 将当前行，写入cache
            /** @type {?} */
            let dataItem = {};
            if (joinParam.controlType === 'crosstab') { // 交叉表
                // 获取行标题的数据
                for (let i = joinParam.rowHeaderColInfo.start; i < joinParam.rowHeaderColInfo.end; i++) {
                    /** @type {?} */
                    const value = activeSheet.getValue(target.row, i, GC.Spread.Sheets.SheetArea.viewport);
                    /** @type {?} */
                    const name = activeSheet.getValue(joinParam.colHeaderRowInfo.start, i, GC.Spread.Sheets.SheetArea.colHeader);
                    /** @type {?} */
                    const colInfo = joinParam.colInfos.find((/**
                     * @param {?} x
                     * @return {?}
                     */
                    (x) => x.dimension === 1 && x.name === name)).bindField;
                    dataItem[colInfo] = value;
                }
                // 获取列标题的数据
                for (let i = joinParam.colHeaderRowInfo.start; i < joinParam.colHeaderRowInfo.end; i++) {
                    /** @type {?} */
                    const value = activeSheet.getValue(i, target.col, GC.Spread.Sheets.SheetArea.colHeader);
                    /** @type {?} */
                    const colInfo = joinParam.colInfos.filter((/**
                     * @param {?} x
                     * @return {?}
                     */
                    (x) => x.dimension === 2))[i - joinParam.colHeaderRowInfo.start].bindField;
                    dataItem[colInfo] = value;
                }
                // 获取值标题的数据
                /** @type {?} */
                const value = activeSheet.getValue(target.row, target.col, GC.Spread.Sheets.SheetArea.viewport);
                /** @type {?} */
                const name = activeSheet.getValue(joinParam.colHeaderRowInfo.end, target.col, GC.Spread.Sheets.SheetArea.colHeader);
                /** @type {?} */
                let colInfo = joinParam.colInfos.find((/**
                 * @param {?} x
                 * @return {?}
                 */
                (x) => x.dimension === 3 && x.name === name));
                if (colInfo) {
                    colInfo = colInfo.bindField;
                    dataItem[colInfo] = value;
                }
            }
            else {
                dataItem = activeSheet.getDataItem(target.row);
            }
            // 保存参数到searchList
            this.currentSelectItem = dataItem;
            return true;
        }
        else {
            if (joinParam.colList && joinParam.colList.length) {
                /** @type {?} */
                const cacheCols = [];
                joinParam.colList.forEach((/**
                 * @param {?} col
                 * @return {?}
                 */
                (col) => {
                    this.getColumn(col, null, cacheCols);
                }));
                /** @type {?} */
                const dataItem = {};
                for (let i = 0; i < cacheCols.length; i++) {
                    if (i < $event.value.length) {
                        dataItem[cacheCols[i].bindField] = $event.value[i];
                    }
                }
                this.currentSelectItem = dataItem;
            }
            $event.event.event.returnValue = false;
            return true;
        }
    }
    /**
     * 保存参数到cache
     * @protected
     * @param {?} dataItem 参数
     * @return {?}
     */
    writeParamToCache(dataItem) {
        this._searchList[0]['joinSearch'].forEach((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            /** @type {?} */
            const currentParam = this.cacheService.get(this._queryId);
            dataItem['currentItem'] = currentParam;
            this.cacheService.set(value.queryId, dataItem);
        }));
    }
    /**
     * @private
     * @param {?} col
     * @param {?} childCols
     * @param {?} colcache
     * @return {?}
     */
    getColumn(col, childCols, colcache) {
        if (col) {
            /** @type {?} */
            const str = JSON.stringify(col);
            colcache.push(JSON.parse(str));
            if (col.childList && col.childList.length) {
                this.getColumn(null, col.childList, colcache);
            }
        }
        else {
            childCols.forEach((/**
             * @param {?} col
             * @return {?}
             */
            (col) => {
                /** @type {?} */
                const str = JSON.stringify(col);
                colcache.push(JSON.parse(str));
                if (col.childList && col.childList.length) {
                    this.getColumn(null, col.childList, colcache);
                }
            }));
        }
    }
}
MenuControllerService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
MenuControllerService.ctorParameters = () => [
    { type: RendererFactory2 },
    { type: CacheService },
    { type: SearchListService },
    { type: CacheService },
    { type: LoadingService }
];
if (false) {
    /**
     * @type {?}
     * @protected
     */
    MenuControllerService.prototype._searchList;
    /**
     * @type {?}
     * @protected
     */
    MenuControllerService.prototype._queryId;
    /** @type {?} */
    MenuControllerService.prototype.currentSelectItem;
    /** @type {?} */
    MenuControllerService.prototype.queryRelativeUrl;
    /** @type {?} */
    MenuControllerService.prototype.jointsearchInfoChange;
    /** @type {?} */
    MenuControllerService.prototype.qdpView;
    /**
     * @type {?}
     * @protected
     */
    MenuControllerService.prototype.render;
    /**
     * @type {?}
     * @protected
     */
    MenuControllerService.prototype.rendererFactory;
    /**
     * @type {?}
     * @protected
     */
    MenuControllerService.prototype.cacheService;
    /**
     * @type {?}
     * @protected
     */
    MenuControllerService.prototype.searchListService;
    /**
     * @type {?}
     * @private
     */
    MenuControllerService.prototype.cache;
    /**
     * @type {?}
     * @private
     */
    MenuControllerService.prototype.loadingService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudS1jb250cm9sbGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcWRwL3NlYXJjaC1qb2luLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2UvbWVudS1jb250cm9sbGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQXlCLGdCQUFnQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3BGLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFjLE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFJMUMsTUFBTSxPQUFPLHFCQUFxQjs7Ozs7Ozs7SUFTaEMsWUFDWSxlQUFpQyxFQUNqQyxZQUEwQixFQUMxQixpQkFBb0MsRUFDdEMsS0FBbUIsRUFDbkIsY0FBOEI7UUFKNUIsb0JBQWUsR0FBZixlQUFlLENBQWtCO1FBQ2pDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDdEMsVUFBSyxHQUFMLEtBQUssQ0FBYztRQUNuQixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFUeEMsMEJBQXFCLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQVd6QyxJQUFJLENBQUMsTUFBTSxHQUFHLGVBQWUsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzNELENBQUM7Ozs7Ozs7O0lBQ00saUJBQWlCLENBQUMsTUFBVyxFQUFFLFVBQXNCLEVBQUUsT0FBWSxFQUFFLGlC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LEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUMvQixJQUFJLEdBQUcsQ0FBQyxTQUFTLElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUU7b0JBQ3pDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQUM7aUJBQy9DO1lBQ0gsQ0FBQyxFQUFDLENBQUM7U0FDSjtJQUNILENBQUM7OztZQXZNRixVQUFVOzs7O1lBVGlDLGdCQUFnQjtZQUNuRCxZQUFZO1lBQ1osaUJBQWlCO1lBRGpCLFlBQVk7WUFJWixjQUFjOzs7Ozs7O0lBTXJCLDRDQUEyQjs7Ozs7SUFDM0IseUNBQXdCOztJQUN4QixrREFBdUI7O0lBQ3ZCLGlEQUFzQjs7SUFDdEIsc0RBQTJDOztJQUMzQyx3Q0FBYTs7Ozs7SUFFYix1Q0FBNEI7Ozs7O0lBRTFCLGdEQUEyQzs7Ozs7SUFDM0MsNkNBQW9DOzs7OztJQUNwQyxrREFBOEM7Ozs7O0lBQzlDLHNDQUEyQjs7Ozs7SUFDM0IsK0NBQXNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgRWxlbWVudFJlZiwgUmVuZGVyZXIyLCBSZW5kZXJlckZhY3RvcnkyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IENhY2hlU2VydmljZSB9IGZyb20gJ0BlY3AtY2FmL2NhZi1jb21tb24nO1xyXG5pbXBvcnQgeyBTZWFyY2hMaXN0U2VydmljZSB9IGZyb20gJy4vc2VhcmNoLWxpc3Quc2VydmljZSc7XHJcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCwgb2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgTG9hZGluZ1NlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWxvYWRpbmcnO1xyXG5pbXBvcnQgeyBSdGZTZXJ2aWNlcyB9IGZyb20gJ0BxZHAvY29tbW9uJztcclxuXHJcbmRlY2xhcmUgdmFyIEdDOiBhbnk7XHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIE1lbnVDb250cm9sbGVyU2VydmljZSB7XHJcbiAgcHJvdGVjdGVkIF9zZWFyY2hMaXN0OiBhbnk7XHJcbiAgcHJvdGVjdGVkIF9xdWVyeUlkOiBhbnk7XHJcbiAgY3VycmVudFNlbGVjdEl0ZW06IGFueTtcclxuICBxdWVyeVJlbGF0aXZlVXJsOiBhbnk7XHJcbiAgam9pbnRzZWFyY2hJbmZvQ2hhbmdlID0gbmV3IFN1YmplY3Q8YW55PigpO1xyXG4gIHFkcFZpZXc6IGFueTtcclxuXHJcbiAgcHJvdGVjdGVkIHJlbmRlcjogUmVuZGVyZXIyO1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJvdGVjdGVkIHJlbmRlcmVyRmFjdG9yeTogUmVuZGVyZXJGYWN0b3J5MixcclxuICAgIHByb3RlY3RlZCBjYWNoZVNlcnZpY2U6IENhY2hlU2VydmljZSxcclxuICAgIHByb3RlY3RlZCBzZWFyY2hMaXN0U2VydmljZTogU2VhcmNoTGlzdFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGNhY2hlOiBDYWNoZVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGxvYWRpbmdTZXJ2aWNlOiBMb2FkaW5nU2VydmljZVxyXG4gICkge1xyXG4gICAgdGhpcy5yZW5kZXIgPSByZW5kZXJlckZhY3RvcnkuY3JlYXRlUmVuZGVyZXIobnVsbCwgbnVsbCk7XHJcbiAgfVxyXG4gIHB1YmxpYyBoYW5kbGVDb250ZXh0bWVudSgkZXZlbnQ6IGFueSwgZWxlbWVudFJlZjogRWxlbWVudFJlZiwgcWRwVmlldzogYW55LCBxZHBWaWV3RWxlbWVudFJlZjogRWxlbWVudFJlZikge1xyXG4gICAgdGhpcy5xZHBWaWV3ID0gcWRwVmlldztcclxuICAgIC8vIGNvbnN0IGxvYWRpbmcgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coeyBjb250YWluZXI6IHFkcFZpZXdFbGVtZW50UmVmIH0pO1xyXG4gICAgY29uc3Qgam9pblBhcmFtID0gdGhpcy5jYWNoZS5nZXQoUnRmU2VydmljZXMuZ2V0VGFiSWQodGhpcy5fcXVlcnlJZCkgKyAnam9pblNlYXJjaCcpO1xyXG4gICAgaWYgKCF0aGlzLmNoZWNrRGF0YUFyZWEocWRwVmlldywgcWRwVmlld0VsZW1lbnRSZWYsIGpvaW5QYXJhbSwgJGV2ZW50KSB8fCAhdGhpcy5fc2VhcmNoTGlzdCkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGxlZnQgPSAwLCB0b3AgPSAwO1xyXG4gICAgaWYgKGpvaW5QYXJhbSAmJiBqb2luUGFyYW0uY29udHJvbFR5cGUgIT09ICdjaGFydHMnKSB7XHJcbiAgICAgIGxlZnQgPSAkZXZlbnQuY2xpZW50WDtcclxuICAgICAgdG9wID0gJGV2ZW50LmNsaWVudFk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBsZWZ0ID0gJGV2ZW50LmV2ZW50LmV2ZW50LmNsaWVudFg7XHJcbiAgICAgIHRvcCA9ICRldmVudC5ldmVudC5ldmVudC5jbGllbnRZO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ2xlZnQnLCBsZWZ0ICsgJ3B4Jyk7XHJcbiAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsICd0b3AnLCB0b3AgKyAncHgnKTtcclxuICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ2Rpc3BsYXknLCAnYmxvY2snKTtcclxuXHJcbiAgICB0aGlzLmNhY2hlU2VydmljZS5zZXQodGhpcy5fcXVlcnlJZCArICdjdXJyZW50U2VsZWN0SXRlbScsIHRoaXMuY3VycmVudFNlbGVjdEl0ZW0pOyAvLyDlsIblvZPliY3lj4LmlbDorr7nva7liLDnvJPlrZjkuK1cclxuXHJcbiAgICAvLyDogZTmn6Xlj6/op4Hooajovr7lvI9cclxuICAgIGNvbnN0IHNlYXJjaExpc3QgPSB0aGlzLmNhY2hlU2VydmljZS5nZXQodGhpcy5fcXVlcnlJZCArICdiZWZvcmVKb2ludFNlYXJjaE1lbnVTaG93Jyk7XHJcbiAgICBjb25zdCBmb3JtdWxhcyA9IHt9O1xyXG4gICAgbGV0IGNvbnRhaW5WaXNpYmxlRm9ybXVsYSA9IGZhbHNlO1xyXG4gICAgZm9yIChjb25zdCBzZWFyY2ggb2Ygc2VhcmNoTGlzdCkge1xyXG4gICAgICBmb3JtdWxhc1tzZWFyY2guaWRdID0gc2VhcmNoLnZpc2libGVmb3JtdWxhO1xyXG4gICAgICBpZiAoY29udGFpblZpc2libGVGb3JtdWxhID09PSBmYWxzZSAmJiBzZWFyY2gudmlzaWJsZWZvcm11bGEgIT0gdm9pZCAwICYmIHNlYXJjaC52aXNpYmxlZm9ybXVsYSAhPT0gJycpIHtcclxuICAgICAgICBjb250YWluVmlzaWJsZUZvcm11bGEgPSB0cnVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGNvbnRhaW5WaXNpYmxlRm9ybXVsYSA9PT0gdHJ1ZSkge1xyXG4gICAgICBjb25zdCBwYXJhbSA9IHsgcW9NYW5hZ2VyQ29kZTogcWRwVmlldy5xb01hbmFnZXJDb2RlLCB2aXNpYmxlRm9ybXVsYXM6IGZvcm11bGFzLCB1c2VySWQ6ICcnLCBxdWVyeUlkOiB0aGlzLl9xdWVyeUlkLCByb3dEYXRhOiB0aGlzLmN1cnJlbnRTZWxlY3RJdGVtIH07XHJcblxyXG4gICAgICB0aGlzLnNlYXJjaExpc3RTZXJ2aWNlLmdldFZpc2libGVKb2ludChwYXJhbSwgcWRwVmlldy5xdWVyeVJlbGF0aXZlVXJsLCBzZWFyY2hMaXN0KS5zdWJzY3JpYmUodmFsdWUgPT4ge1xyXG4gICAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgICAgdGhpcy5qb2ludHNlYXJjaEluZm9DaGFuZ2UubmV4dCh2YWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuam9pbnRzZWFyY2hJbmZvQ2hhbmdlLm5leHQoc2VhcmNoTGlzdCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Y2V5Ye75LmL5ZCO6ZqQ6JeP6I+c5Y2VXHJcbiAgICogQHBhcmFtIGVsZW1lbnRSZWYg6I+c5Y2V57uE5Lu2XHJcbiAgICovXHJcbiAgcHVibGljIGhhbmRsZUNsaWNrKGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYpIHtcclxuICAgIGlmIChlbGVtZW50UmVmKSB7XHJcbiAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ2Rpc3BsYXknLCAnbm9uZScpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogZ2V0IHNlYXJjaExpc3RcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0U2VhcmNoTGlzdChmb3JtSWQ6IGFueSwgcXVlcnlJZDogYW55LCBxdWVyeVJlbGF0aXZlVXJsOiBhbnkpIHtcclxuICAgIHRoaXMuX3F1ZXJ5SWQgPSBxdWVyeUlkO1xyXG4gICAgaWYgKHRoaXMuX3NlYXJjaExpc3QgJiYgdGhpcy5fc2VhcmNoTGlzdC5xdWVyeUlkID09PSB0aGlzLl9xdWVyeUlkKSB7XHJcbiAgICAgIHJldHVybiBvZih0aGlzLl9zZWFyY2hMaXN0KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLnNlYXJjaExpc3RTZXJ2aWNlLmdldFNlYXJjaExpc3QoZm9ybUlkLCBxdWVyeUlkLCBxdWVyeVJlbGF0aXZlVXJsKTtcclxuICAgIHJldHVybiByZXN1bHQucGlwZShcclxuICAgICAgbWFwKCh2YWx1ZTogYW55KSA9PiB7XHJcbiAgICAgICAgdGhpcy5fc2VhcmNoTGlzdCA9IHZhbHVlOyAvLyA/IEpTT04ucGFyc2UodmFsdWUuam9pblNlYXJjaCkgOiBbXTtcclxuICAgICAgICByZXR1cm4gdGhpcy5fc2VhcmNoTGlzdDtcclxuICAgICAgfSlcclxuICAgICk7XHJcblxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6L+U5Zue5b2T5YmN5Y+z6ZSu5Z2Q5qCH77yM5piv5ZCm5Li65pWw5o2u5Yy65Z+fXHJcbiAgICogQHBhcmFtIHFkcFZpZXcgcWRwLXZpZXcg57uE5Lu2XHJcbiAgICogQHBhcmFtIHFkcFZpZXdFbGVtZW50UmVmIHFkcC12aWV3IEVsZW1lbnRSZWZcclxuICAgKiBAcGFyYW0gJGV2ZW50IOinpuWPkeS6i+S7tu+8jOS4u+imgeeUqOadpeS8oOmAkuWdkOagh1xyXG4gICAqL1xyXG4gIHByaXZhdGUgY2hlY2tEYXRhQXJlYShxZHBWaWV3OiBhbnksIHFkcFZpZXdFbGVtZW50UmVmOiBFbGVtZW50UmVmLCBqb2luUGFyYW06IGFueSwgJGV2ZW50OiBhbnkpOiBib29sZWFuIHtcclxuICAgIGxldCB4ID0gMCwgeSA9IDA7XHJcbiAgICBsZXQgcWRwdmlld05hdGl2ZSA9IHFkcFZpZXdFbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICB3aGlsZSAocWRwdmlld05hdGl2ZSkge1xyXG4gICAgICB4ICs9IHFkcHZpZXdOYXRpdmUub2Zmc2V0TGVmdDtcclxuICAgICAgeSArPSBxZHB2aWV3TmF0aXZlLm9mZnNldFRvcDtcclxuICAgICAgcWRwdmlld05hdGl2ZSA9IHFkcHZpZXdOYXRpdmUub2Zmc2V0UGFyZW50O1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChqb2luUGFyYW0uY29udHJvbFR5cGUgIT09ICdjaGFydHMnKSB7XHJcbiAgICAgIGNvbnN0IGFjdGl2ZVNoZWV0ID0gcWRwVmlldy5zcHJlYWQuZ2V0QWN0aXZlU2hlZXQoKTtcclxuICAgICAgY29uc3QgdGFyZ2V0ID0gYWN0aXZlU2hlZXQuaGl0VGVzdCgkZXZlbnQuY2xpZW50WCAtIHgsICRldmVudC5jbGllbnRZIC0geSk7XHJcblxyXG5cclxuICAgICAgaWYgKHRhcmdldC5oaXRUZXN0VHlwZSAhPT0gR0MuU3ByZWFkLlNoZWV0cy5TaGVldEFyZWEudmlld3BvcnQgfHwgdGFyZ2V0LmNvbCA9PT0gdW5kZWZpbmVkIHx8IHRhcmdldC5yb3cgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICBhY3RpdmVTaGVldC5zZXRBY3RpdmVDZWxsKHRhcmdldC5yb3csIHRhcmdldC5jb2wpO1xyXG4gICAgICAvLyDlsIblvZPliY3ooYzvvIzlhpnlhaVjYWNoZVxyXG4gICAgICBsZXQgZGF0YUl0ZW0gPSB7fTtcclxuICAgICAgaWYgKGpvaW5QYXJhbS5jb250cm9sVHlwZSA9PT0gJ2Nyb3NzdGFiJykgeyAvLyDkuqTlj4nooahcclxuICAgICAgICAvLyDojrflj5booYzmoIfpopjnmoTmlbDmja5cclxuICAgICAgICBmb3IgKGxldCBpID0gam9pblBhcmFtLnJvd0hlYWRlckNvbEluZm8uc3RhcnQ7IGkgPCBqb2luUGFyYW0ucm93SGVhZGVyQ29sSW5mby5lbmQ7IGkrKykge1xyXG4gICAgICAgICAgY29uc3QgdmFsdWUgPSBhY3RpdmVTaGVldC5nZXRWYWx1ZSh0YXJnZXQucm93LCBpLCBHQy5TcHJlYWQuU2hlZXRzLlNoZWV0QXJlYS52aWV3cG9ydCk7XHJcbiAgICAgICAgICBjb25zdCBuYW1lID0gYWN0aXZlU2hlZXQuZ2V0VmFsdWUoam9pblBhcmFtLmNvbEhlYWRlclJvd0luZm8uc3RhcnQsIGksIEdDLlNwcmVhZC5TaGVldHMuU2hlZXRBcmVhLmNvbEhlYWRlcik7XHJcbiAgICAgICAgICBjb25zdCBjb2xJbmZvID0gam9pblBhcmFtLmNvbEluZm9zLmZpbmQoKHg6IGFueSkgPT4geC5kaW1lbnNpb24gPT09IDEgJiYgeC5uYW1lID09PSBuYW1lKS5iaW5kRmllbGQ7XHJcbiAgICAgICAgICBkYXRhSXRlbVtjb2xJbmZvXSA9IHZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDojrflj5bliJfmoIfpopjnmoTmlbDmja5cclxuICAgICAgICBmb3IgKGxldCBpID0gam9pblBhcmFtLmNvbEhlYWRlclJvd0luZm8uc3RhcnQ7IGkgPCBqb2luUGFyYW0uY29sSGVhZGVyUm93SW5mby5lbmQ7IGkrKykge1xyXG4gICAgICAgICAgY29uc3QgdmFsdWUgPSBhY3RpdmVTaGVldC5nZXRWYWx1ZShpLCB0YXJnZXQuY29sLCBHQy5TcHJlYWQuU2hlZXRzLlNoZWV0QXJlYS5jb2xIZWFkZXIpO1xyXG4gICAgICAgICAgY29uc3QgY29sSW5mbyA9IGpvaW5QYXJhbS5jb2xJbmZvcy5maWx0ZXIoKHg6IGFueSkgPT4geC5kaW1lbnNpb24gPT09IDIpW2kgLSBqb2luUGFyYW0uY29sSGVhZGVyUm93SW5mby5zdGFydF0uYmluZEZpZWxkO1xyXG4gICAgICAgICAgZGF0YUl0ZW1bY29sSW5mb10gPSB2YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g6I635Y+W5YC85qCH6aKY55qE5pWw5o2uXHJcbiAgICAgICAgY29uc3QgdmFsdWUgPSBhY3RpdmVTaGVldC5nZXRWYWx1ZSh0YXJnZXQucm93LCB0YXJnZXQuY29sLCBHQy5TcHJlYWQuU2hlZXRzLlNoZWV0QXJlYS52aWV3cG9ydCk7XHJcbiAgICAgICAgY29uc3QgbmFtZSA9IGFjdGl2ZVNoZWV0LmdldFZhbHVlKGpvaW5QYXJhbS5jb2xIZWFkZXJSb3dJbmZvLmVuZCwgdGFyZ2V0LmNvbCwgR0MuU3ByZWFkLlNoZWV0cy5TaGVldEFyZWEuY29sSGVhZGVyKTtcclxuICAgICAgICBsZXQgY29sSW5mbyA9IGpvaW5QYXJhbS5jb2xJbmZvcy5maW5kKCh4OiBhbnkpID0+IHguZGltZW5zaW9uID09PSAzICYmIHgubmFtZSA9PT0gbmFtZSk7XHJcbiAgICAgICAgaWYgKGNvbEluZm8pIHtcclxuICAgICAgICAgIGNvbEluZm8gPSBjb2xJbmZvLmJpbmRGaWVsZDtcclxuICAgICAgICAgIGRhdGFJdGVtW2NvbEluZm9dID0gdmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGRhdGFJdGVtID0gYWN0aXZlU2hlZXQuZ2V0RGF0YUl0ZW0odGFyZ2V0LnJvdyk7XHJcbiAgICAgIH1cclxuICAgICAgLy8g5L+d5a2Y5Y+C5pWw5Yiwc2VhcmNoTGlzdFxyXG4gICAgICB0aGlzLmN1cnJlbnRTZWxlY3RJdGVtID0gZGF0YUl0ZW07XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaWYgKGpvaW5QYXJhbS5jb2xMaXN0ICYmIGpvaW5QYXJhbS5jb2xMaXN0Lmxlbmd0aCkge1xyXG4gICAgICAgIGNvbnN0IGNhY2hlQ29sczogYW55W10gPSBbXTtcclxuICAgICAgICBqb2luUGFyYW0uY29sTGlzdC5mb3JFYWNoKChjb2w6IGFueSkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5nZXRDb2x1bW4oY29sLCBudWxsLCBjYWNoZUNvbHMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IGRhdGFJdGVtID0ge307XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjYWNoZUNvbHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgIGlmIChpIDwgJGV2ZW50LnZhbHVlLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBkYXRhSXRlbVtjYWNoZUNvbHNbaV0uYmluZEZpZWxkXSA9ICRldmVudC52YWx1ZVtpXTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jdXJyZW50U2VsZWN0SXRlbSA9IGRhdGFJdGVtO1xyXG4gICAgICB9XHJcbiAgICAgICRldmVudC5ldmVudC5ldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlO1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiDkv53lrZjlj4LmlbDliLBjYWNoZVxyXG4gICAqIEBwYXJhbSBkYXRhSXRlbSDlj4LmlbBcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgd3JpdGVQYXJhbVRvQ2FjaGUoZGF0YUl0ZW06IGFueSkge1xyXG4gICAgdGhpcy5fc2VhcmNoTGlzdFswXVsnam9pblNlYXJjaCddLmZvckVhY2godmFsdWUgPT4ge1xyXG4gICAgICBjb25zdCBjdXJyZW50UGFyYW0gPSB0aGlzLmNhY2hlU2VydmljZS5nZXQodGhpcy5fcXVlcnlJZCk7XHJcbiAgICAgIGRhdGFJdGVtWydjdXJyZW50SXRlbSddID0gY3VycmVudFBhcmFtO1xyXG4gICAgICB0aGlzLmNhY2hlU2VydmljZS5zZXQodmFsdWUucXVlcnlJZCwgZGF0YUl0ZW0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldENvbHVtbihjb2w6IGFueSwgY2hpbGRDb2xzOiBhbnlbXSwgY29sY2FjaGU6IGFueVtdKSB7XHJcbiAgICBpZiAoY29sKSB7XHJcbiAgICAgIGNvbnN0IHN0ciA9IEpTT04uc3RyaW5naWZ5KGNvbCk7XHJcbiAgICAgIGNvbGNhY2hlLnB1c2goSlNPTi5wYXJzZShzdHIpKTtcclxuICAgICAgaWYgKGNvbC5jaGlsZExpc3QgJiYgY29sLmNoaWxkTGlzdC5sZW5ndGgpIHtcclxuICAgICAgICB0aGlzLmdldENvbHVtbihudWxsLCBjb2wuY2hpbGRMaXN0LCBjb2xjYWNoZSk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNoaWxkQ29scy5mb3JFYWNoKChjb2w6IGFueSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHN0ciA9IEpTT04uc3RyaW5naWZ5KGNvbCk7XHJcbiAgICAgICAgY29sY2FjaGUucHVzaChKU09OLnBhcnNlKHN0cikpO1xyXG4gICAgICAgIGlmIChjb2wuY2hpbGRMaXN0ICYmIGNvbC5jaGlsZExpc3QubGVuZ3RoKSB7XHJcbiAgICAgICAgICB0aGlzLmdldENvbHVtbihudWxsLCBjb2wuY2hpbGRMaXN0LCBjb2xjYWNoZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19