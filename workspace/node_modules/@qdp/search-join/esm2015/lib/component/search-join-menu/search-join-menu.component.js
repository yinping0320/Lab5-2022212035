/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, HostListener, ElementRef, RendererFactory2, Input, Optional, Injector } from '@angular/core';
import { MenuControllerService } from '../../service/menu-controller.service';
import { FrameworkService, AppService } from '@gsp-sys/rtf-common';
import { CacheService } from '@ecp-caf/caf-common';
import { JointSearchExtendService } from '@qdp/common';
import { EventBus, RtfServices } from '@qdp/common';
export class SearchJoinMenuComponent {
    /**
     * @param {?} elementRef
     * @param {?} renderFactory
     * @param {?} menuControllerService
     * @param {?} frameWorkService
     * @param {?} cacheService
     * @param {?} jointSearchExtendService
     * @param {?} injector
     */
    constructor(elementRef, renderFactory, menuControllerService, frameWorkService, cacheService, jointSearchExtendService, injector) {
        this.elementRef = elementRef;
        this.renderFactory = renderFactory;
        this.menuControllerService = menuControllerService;
        this.frameWorkService = frameWorkService;
        this.cacheService = cacheService;
        this.jointSearchExtendService = jointSearchExtendService;
        this.injector = injector;
        if (this.injector) {
            this.appService = this.injector.get(AppService);
        }
        this.formId = 'form' + 'ff3ea474-cc65-23b0-cdb1-73c9146cea3b';
        this.renderer = this.renderFactory.createRenderer(null, null);
        menuControllerService.jointsearchInfoChange.subscribe((/**
         * @param {?} value
         * @return {?}
         */
        (value) => {
            if (value) {
                this.searchList = value;
            }
        }));
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        /** @type {?} */
        const self = this;
        this.menuControllerService.getSearchList(this.formId, this.queryId, this.queryRelativeUrl).subscribe((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            if (value) {
                /** @type {?} */
                const _searchList = JSON.parse(value['joinSearch']);
                _searchList.forEach((/**
                 * @param {?} searchL
                 * @return {?}
                 */
                searchL => {
                    if (!searchL.searchtype) {
                        searchL.searchtype = 'func';
                        searchL.appEntrance = '';
                    }
                    searchL.functionname = self.getFunctionName(searchL.functionname);
                }));
                this.searchPara = JSON.parse(value['jointparam']);
                this.cacheService.set(this.queryId + 'beforeJointSearchMenuShow', _searchList);
            }
        }));
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
    }
    /**
     * 当点击某一个路由之后，隐藏菜单组件
     * @return {?}
     */
    handleClick() {
        this.renderer.setStyle(this.elementRef.nativeElement, 'display', 'none');
    }
    /**
     * 路由到结果页
     * param id 联查功能主键id
     * param functionid 功能菜单id
     * @param {?} id
     * @param {?} functionid
     * @param {?} queryId
     * @return {?}
     */
    routeTo(id, functionid, queryId) {
        /** @type {?} */
        const self = this;
        /** @type {?} */
        let chooseList = {};
        this.searchList.forEach((/**
         * @param {?} searchL
         * @return {?}
         */
        searchL => {
            if (searchL.id === id) {
                chooseList = searchL;
            }
        }));
        /** @type {?} */
        let entityParam = { 'id': 'null' };
        /** @type {?} */
        const paramMap = new Map();
        /** @type {?} */
        const searchparas = this.searchPara.filter((/**
         * @param {?} x
         * @return {?}
         */
        x => x.functionid === id));
        // 查找对应的参数列表
        /** @type {?} */
        const currentSelectedItem = this.cacheService.get(this.queryId + 'currentSelectItem');
        if (searchparas.length > 0) {
            searchparas.forEach((/**
             * @param {?} value
             * @return {?}
             */
            value => {
                if (value.paravaluetype) { // 表达式
                    if (value.paravalue.indexOf('getParameter(') >= 0) {
                        /** @type {?} */
                        const parameterKey = value.paravalue.replace(/'/g, '').replace(/"/g, '').replace(/getParameter\(/g, '').replace(/\)/g, '');
                        self.getQueryParameters(entityParam, paramMap, parameterKey, value.para);
                    }
                    else {
                        entityParam[value.para] = currentSelectedItem[value.paravalue];
                        paramMap.set(value.para, currentSelectedItem[value.paravalue]);
                    }
                }
                else {
                    entityParam[value.para] = value.paravalue;
                    paramMap.set(value.para, value.paravalue);
                }
            }));
        }
        else {
            entityParam = currentSelectedItem;
        }
        /** @type {?} */
        let options = {
            ParentSessionId: this.cacheService.get('session'),
            EntityParam: entityParam
        };
        /** @type {?} */
        const $event = {};
        if (this.jointSearchExtendService && this.jointSearchExtendService.beforeJointSearch) {
            $event['eventCode'] = 'beforeJointSearch';
            $event['eventName'] = 'drill before';
            $event['data'] = {
                'functionid': functionid,
                'options': options,
                'queryId': queryId,
                'orginQueryId': this.queryId,
                'qdpView': this.menuControllerService.qdpView
            };
            this.jointSearchExtendService.beforeJointSearch($event);
            if ($event && $event['data'] && $event['data'].options) {
                options = Object.assign(options, $event['data'].options);
            }
            if (chooseList.searchtype === 'url' || chooseList.searchtype === 'additional') {
                return;
            }
        }
        // this.cacheService.set(queryId, options.EntityParam);
        /** @type {?} */
        let tabId = '';
        if (chooseList.searchtype === 'func') {
            // 联查前
            /** @type {?} */
            const openMenuoptions = {
                'appType': 'menu',
                'funcId': functionid,
                'tabId': EventBus.guid(),
                'appId': '',
                'appEntrance': '',
                'entityParams': $event['entityParams'] || entityParam,
                'queryStringParams': paramMap,
                'isNewTab': true
            };
            tabId = RtfServices.getFuncId(openMenuoptions);
            /** @type {?} */
            const menuSwitchControl = Object.assign({}, openMenuoptions['entityParams'], RtfServices.getMenuSwitchControlParameter(tabId));
            openMenuoptions['entityParams'] = menuSwitchControl;
            this.cacheService.set(tabId ? tabId : queryId, options.EntityParam);
            // 卡片塞进去params
            this.frameWorkService.openMenu(openMenuoptions);
        }
        else if (chooseList.searchtype === 'app') {
            /** @type {?} */
            const appOption = {
                appType: 'app',
                appId: functionid,
                appEntrance: chooseList.appEntrance,
                funcId: '',
                isReload: true,
                tabId: EventBus.guid(),
                entityParams: $event['entityParams'] || entityParam,
                queryStringParams: paramMap
            };
            tabId = RtfServices.getFuncId(appOption);
            this.cacheService.set(tabId ? tabId : queryId, options.EntityParam);
            /** @type {?} */
            const menuSwitchControl = Object.assign({}, appOption['entityParams'], RtfServices.getMenuSwitchControlParameter(tabId));
            appOption['entityParams'] = menuSwitchControl;
            this.frameWorkService.openMenu(appOption);
        }
    }
    /**
     * @param {?} data
     * @return {?}
     */
    getFunctionName(data) {
        /** @type {?} */
        let local = 'zh-chs';
        if (gspframeworkService) {
            local = gspframeworkService.rtf.language.getLanguageCode().toLowerCase();
        }
        if (!local) {
            local = 'zh-chs';
        }
        return data[local] ? data[local] : data;
    }
    /**
     * @private
     * @param {?} entityParam
     * @param {?} paramMap
     * @param {?} parameterKey
     * @param {?} key
     * @return {?}
     */
    getQueryParameters(entityParam, paramMap, parameterKey, key) {
        try {
            /** @type {?} */
            const tab = gspframeworkService.rtf.session.getCommonVariable();
            if (tab && tab.tabId) {
                /** @type {?} */
                const tid = tab.tabId + RtfServices.getInSuiteFrmUUID();
                if (this.cacheService.get(tid) && this.cacheService.get(tid)[parameterKey]) {
                    entityParam[key] = this.cacheService.get(tid)[parameterKey];
                    paramMap.set(key, this.cacheService.get(tid)[parameterKey]);
                }
            }
        }
        catch (e) {
        }
    }
}
SearchJoinMenuComponent.decorators = [
    { type: Component, args: [{
                selector: 'qdp-search-join-menu',
                template: "<div *ngIf=\"searchList && searchList.length && searchList.length > 0\">\r\n  <div class=\"dropdown-menu\" style=\"display:block\">\r\n    <div *ngFor=\"let item of searchList\">\r\n      <button class=\"dropdown-item\" (click)=\"routeTo(item.id,item.functioncode,item.destinationqueryId)\">{{item.functionname}}</button>\r\n    </div>\r\n  </div>\r\n</div>\r\n",
                styles: [":host{position:fixed;display:none;top:0;left:0}"]
            }] }
];
/** @nocollapse */
SearchJoinMenuComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: RendererFactory2 },
    { type: MenuControllerService },
    { type: FrameworkService },
    { type: CacheService },
    { type: JointSearchExtendService, decorators: [{ type: Optional }] },
    { type: Injector, decorators: [{ type: Optional }] }
];
SearchJoinMenuComponent.propDecorators = {
    queryId: [{ type: Input }],
    queryRelativeUrl: [{ type: Input }],
    qoManagerCode: [{ type: Input }],
    searchList: [{ type: Input }],
    handleClick: [{ type: HostListener, args: ['click',] }]
};
if (false) {
    /** @type {?} */
    SearchJoinMenuComponent.prototype.queryId;
    /** @type {?} */
    SearchJoinMenuComponent.prototype.queryRelativeUrl;
    /** @type {?} */
    SearchJoinMenuComponent.prototype.qoManagerCode;
    /** @type {?} */
    SearchJoinMenuComponent.prototype.formId;
    /** @type {?} */
    SearchJoinMenuComponent.prototype.searchList;
    /** @type {?} */
    SearchJoinMenuComponent.prototype.searchPara;
    /** @type {?} */
    SearchJoinMenuComponent.prototype.currentSelectedItem;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.renderer;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.appService;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.elementRef;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.renderFactory;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.menuControllerService;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.frameWorkService;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.cacheService;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.jointSearchExtendService;
    /**
     * @type {?}
     * @private
     */
    SearchJoinMenuComponent.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLWpvaW4tbWVudS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcWRwL3NlYXJjaC1qb2luLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudC9zZWFyY2gtam9pbi1tZW51L3NlYXJjaC1qb2luLW1lbnUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUVULFlBQVksRUFDWixVQUFVLEVBRVYsZ0JBQWdCLEVBQ2hCLEtBQUssRUFDTCxRQUFRLEVBR1IsUUFBUSxFQUNULE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBQzlFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkQsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3ZELE9BQU8sRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBU3BELE1BQU0sT0FBTyx1QkFBdUI7Ozs7Ozs7Ozs7SUFXbEMsWUFDVSxVQUFzQixFQUN0QixhQUErQixFQUMvQixxQkFBNEMsRUFDNUMsZ0JBQWtDLEVBQ2xDLFlBQTBCLEVBQ2Qsd0JBQWtELEVBQ2xELFFBQWtCO1FBTjlCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIsa0JBQWEsR0FBYixhQUFhLENBQWtCO1FBQy9CLDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBdUI7UUFDNUMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUNkLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUN0QyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDakIsSUFBSSxD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QUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQztvQkFDNUQsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztpQkFDN0Q7YUFDRjtTQUNGO1FBQUMsT0FBTyxDQUFDLEVBQUU7U0FDWDtJQUNILENBQUM7OztZQTdMRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLHNCQUFzQjtnQkFDaEMscVhBQWdEOzthQUVqRDs7OztZQXJCQyxVQUFVO1lBRVYsZ0JBQWdCO1lBT1QscUJBQXFCO1lBQ3JCLGdCQUFnQjtZQUNoQixZQUFZO1lBQ1osd0JBQXdCLHVCQTJCNUIsUUFBUTtZQWhDWCxRQUFRLHVCQWlDTCxRQUFROzs7c0JBakJWLEtBQUs7K0JBQ0wsS0FBSzs0QkFDTCxLQUFLO3lCQUVMLEtBQUs7MEJBcURMLFlBQVksU0FBQyxPQUFPOzs7O0lBekRyQiwwQ0FBc0I7O0lBQ3RCLG1EQUErQjs7SUFDL0IsZ0RBQTRCOztJQUM1Qix5Q0FBWTs7SUFDWiw2Q0FBMkI7O0lBQzNCLDZDQUF5Qjs7SUFDekIsc0RBQXlCOzs7OztJQUN6QiwyQ0FBNEI7Ozs7O0lBQzVCLDZDQUErQjs7Ozs7SUFHN0IsNkNBQThCOzs7OztJQUM5QixnREFBdUM7Ozs7O0lBQ3ZDLHdEQUFvRDs7Ozs7SUFDcEQsbURBQTBDOzs7OztJQUMxQywrQ0FBa0M7Ozs7O0lBQ2xDLDJEQUFzRTs7Ozs7SUFDdEUsMkNBQXNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBDb21wb25lbnQsXHJcbiAgT25Jbml0LFxyXG4gIEhvc3RMaXN0ZW5lcixcclxuICBFbGVtZW50UmVmLFxyXG4gIFJlbmRlcmVyMixcclxuICBSZW5kZXJlckZhY3RvcnkyLFxyXG4gIElucHV0LFxyXG4gIE9wdGlvbmFsLFxyXG4gIFNpbXBsZUNoYW5nZXMsXHJcbiAgT25DaGFuZ2VzLFxyXG4gIEluamVjdG9yXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE1lbnVDb250cm9sbGVyU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2UvbWVudS1jb250cm9sbGVyLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGcmFtZXdvcmtTZXJ2aWNlLCBBcHBTZXJ2aWNlIH0gZnJvbSAnQGdzcC1zeXMvcnRmLWNvbW1vbic7XHJcbmltcG9ydCB7IENhY2hlU2VydmljZSB9IGZyb20gJ0BlY3AtY2FmL2NhZi1jb21tb24nO1xyXG5pbXBvcnQgeyBKb2ludFNlYXJjaEV4dGVuZFNlcnZpY2UgfSBmcm9tICdAcWRwL2NvbW1vbic7XHJcbmltcG9ydCB7IEV2ZW50QnVzLCBSdGZTZXJ2aWNlcyB9IGZyb20gJ0BxZHAvY29tbW9uJztcclxuXHJcbmRlY2xhcmUgdmFyIGdzcGZyYW1ld29ya1NlcnZpY2U6IGFueTtcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAncWRwLXNlYXJjaC1qb2luLW1lbnUnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9zZWFyY2gtam9pbi1tZW51LmNvbXBvbmVudC5odG1sJyxcclxuICBzdHlsZVVybHM6IFsnLi9zZWFyY2gtam9pbi1tZW51LmNvbXBvbmVudC5jc3MnXSxcclxufSlcclxuZXhwb3J0IGNsYXNzIFNlYXJjaEpvaW5NZW51Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMge1xyXG4gIEBJbnB1dCgpIHF1ZXJ5SWQ6IGFueTtcclxuICBASW5wdXQoKSBxdWVyeVJlbGF0aXZlVXJsOiBhbnk7XHJcbiAgQElucHV0KCkgcW9NYW5hZ2VyQ29kZTogYW55O1xyXG4gIGZvcm1JZDogYW55O1xyXG4gIEBJbnB1dCgpIHNlYXJjaExpc3Q6IGFueVtdO1xyXG4gIHB1YmxpYyBzZWFyY2hQYXJhOiBhbnlbXTtcclxuICBjdXJyZW50U2VsZWN0ZWRJdGVtOiBhbnk7XHJcbiAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyO1xyXG4gIHByaXZhdGUgYXBwU2VydmljZTogQXBwU2VydmljZTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsXHJcbiAgICBwcml2YXRlIHJlbmRlckZhY3Rvcnk6IFJlbmRlcmVyRmFjdG9yeTIsXHJcbiAgICBwcml2YXRlIG1lbnVDb250cm9sbGVyU2VydmljZTogTWVudUNvbnRyb2xsZXJTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBmcmFtZVdvcmtTZXJ2aWNlOiBGcmFtZXdvcmtTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBjYWNoZVNlcnZpY2U6IENhY2hlU2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgam9pbnRTZWFyY2hFeHRlbmRTZXJ2aWNlOiBKb2ludFNlYXJjaEV4dGVuZFNlcnZpY2UsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gICAgaWYgKHRoaXMuaW5qZWN0b3IpIHtcclxuICAgICAgdGhpcy5hcHBTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQoQXBwU2VydmljZSk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmZvcm1JZCA9ICdmb3JtJyArICdmZjNlYTQ3NC1jYzY1LTIzYjAtY2RiMS03M2M5MTQ2Y2VhM2InO1xyXG4gICAgdGhpcy5yZW5kZXJlciA9IHRoaXMucmVuZGVyRmFjdG9yeS5jcmVhdGVSZW5kZXJlcihudWxsLCBudWxsKTtcclxuXHJcbiAgICBtZW51Q29udHJvbGxlclNlcnZpY2Uuam9pbnRzZWFyY2hJbmZvQ2hhbmdlLnN1YnNjcmliZSgodmFsdWUpID0+IHtcclxuICAgICAgaWYgKHZhbHVlKSB7XHJcbiAgICAgICAgdGhpcy5zZWFyY2hMaXN0ID0gdmFsdWU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgdGhpcy5tZW51Q29udHJvbGxlclNlcnZpY2UuZ2V0U2VhcmNoTGlzdCh0aGlzLmZvcm1JZCwgdGhpcy5xdWVyeUlkLCB0aGlzLnF1ZXJ5UmVsYXRpdmVVcmwpLnN1YnNjcmliZShcclxuICAgICAgdmFsdWUgPT4ge1xyXG4gICAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgICAgY29uc3QgX3NlYXJjaExpc3QgPSBKU09OLnBhcnNlKHZhbHVlWydqb2luU2VhcmNoJ10pO1xyXG4gICAgICAgICAgX3NlYXJjaExpc3QuZm9yRWFjaChzZWFyY2hMID0+IHtcclxuICAgICAgICAgICAgaWYgKCFzZWFyY2hMLnNlYXJjaHR5cGUpIHtcclxuICAgICAgICAgICAgICBzZWFyY2hMLnNlYXJjaHR5cGUgPSAnZnVuYyc7XHJcbiAgICAgICAgICAgICAgc2VhcmNoTC5hcHBFbnRyYW5jZSA9ICcnO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHNlYXJjaEwuZnVuY3Rpb25uYW1lID0gc2VsZi5nZXRGdW5jdGlvbk5hbWUoc2VhcmNoTC5mdW5jdGlvbm5hbWUpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICB0aGlzLnNlYXJjaFBhcmEgPSBKU09OLnBhcnNlKHZhbHVlWydqb2ludHBhcmFtJ10pO1xyXG4gICAgICAgICAgdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KHRoaXMucXVlcnlJZCArICdiZWZvcmVKb2ludFNlYXJjaE1lbnVTaG93JywgX3NlYXJjaExpc3QpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlvZPngrnlh7vmn5DkuIDkuKrot6/nlLHkuYvlkI7vvIzpmpDol4/oj5zljZXnu4Tku7ZcclxuICAgKi9cclxuICBASG9zdExpc3RlbmVyKCdjbGljaycpXHJcbiAgaGFuZGxlQ2xpY2soKSB7XHJcbiAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCAnZGlzcGxheScsICdub25lJyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDot6/nlLHliLDnu5PmnpzpobVcclxuICAgKiBwYXJhbSBpZCDogZTmn6Xlip/og73kuLvplK5pZFxyXG4gICAqIHBhcmFtIGZ1bmN0aW9uaWQg5Yqf6IO96I+c5Y2VaWRcclxuICAgKi9cclxuICBwdWJsaWMgcm91dGVUbyhpZDogYW55LCBmdW5jdGlvbmlkOiBhbnksIHF1ZXJ5SWQ6IGFueSkge1xyXG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcbiAgICBsZXQgY2hvb3NlTGlzdDogYW55ID0ge307XHJcbiAgICB0aGlzLnNlYXJjaExpc3QuZm9yRWFjaChzZWFyY2hMID0+IHtcclxuICAgICAgaWYgKHNlYXJjaEwuaWQgPT09IGlkKSB7XHJcbiAgICAgICAgY2hvb3NlTGlzdCA9IHNlYXJjaEw7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIGxldCBlbnRpdHlQYXJhbSA9IHsgJ2lkJzogJ251bGwnIH07XHJcbiAgICBjb25zdCBwYXJhbU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XHJcbiAgICBjb25zdCBzZWFyY2hwYXJhczogYW55W10gPSB0aGlzLnNlYXJjaFBhcmEuZmlsdGVyKHggPT4geC5mdW5jdGlvbmlkID09PSBpZCk7IC8vIOafpeaJvuWvueW6lOeahOWPguaVsOWIl+ihqFxyXG4gICAgY29uc3QgY3VycmVudFNlbGVjdGVkSXRlbSA9IHRoaXMuY2FjaGVTZXJ2aWNlLmdldCh0aGlzLnF1ZXJ5SWQgKyAnY3VycmVudFNlbGVjdEl0ZW0nKTsgLy8g5b2T5YmN6YCJ5Lit5pWw5o2uXHJcbiAgICBpZiAoc2VhcmNocGFyYXMubGVuZ3RoID4gMCkge1xyXG4gICAgICBzZWFyY2hwYXJhcy5mb3JFYWNoKHZhbHVlID0+IHtcclxuICAgICAgICBpZiAodmFsdWUucGFyYXZhbHVldHlwZSkgey8vIOihqOi+vuW8j1xyXG4gICAgICAgICAgaWYgKHZhbHVlLnBhcmF2YWx1ZS5pbmRleE9mKCdnZXRQYXJhbWV0ZXIoJykgPj0gMCkge1xyXG4gICAgICAgICAgICBjb25zdCBwYXJhbWV0ZXJLZXkgPSB2YWx1ZS5wYXJhdmFsdWUucmVwbGFjZSgvJy9nLCAnJykucmVwbGFjZSgvXCIvZywgJycpLnJlcGxhY2UoL2dldFBhcmFtZXRlclxcKC9nLCAnJykucmVwbGFjZSgvXFwpL2csICcnKTtcclxuICAgICAgICAgICAgc2VsZi5nZXRRdWVyeVBhcmFtZXRlcnMoZW50aXR5UGFyYW0sIHBhcmFtTWFwLCBwYXJhbWV0ZXJLZXksIHZhbHVlLnBhcmEpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZW50aXR5UGFyYW1bdmFsdWUucGFyYV0gPSBjdXJyZW50U2VsZWN0ZWRJdGVtW3ZhbHVlLnBhcmF2YWx1ZV07XHJcbiAgICAgICAgICAgIHBhcmFtTWFwLnNldCh2YWx1ZS5wYXJhLCBjdXJyZW50U2VsZWN0ZWRJdGVtW3ZhbHVlLnBhcmF2YWx1ZV0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBlbnRpdHlQYXJhbVt2YWx1ZS5wYXJhXSA9IHZhbHVlLnBhcmF2YWx1ZTtcclxuICAgICAgICAgIHBhcmFtTWFwLnNldCh2YWx1ZS5wYXJhLCB2YWx1ZS5wYXJhdmFsdWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBlbnRpdHlQYXJhbSA9IGN1cnJlbnRTZWxlY3RlZEl0ZW07XHJcbiAgICB9XHJcbiAgICBsZXQgb3B0aW9uczogYW55ID0ge1xyXG4gICAgICBQYXJlbnRTZXNzaW9uSWQ6IHRoaXMuY2FjaGVTZXJ2aWNlLmdldCgnc2Vzc2lvbicpLFxyXG4gICAgICBFbnRpdHlQYXJhbTogZW50aXR5UGFyYW1cclxuICAgIH07XHJcbiAgICBjb25zdCAkZXZlbnQgPSB7fTtcclxuICAgIGlmICh0aGlzLmpvaW50U2VhcmNoRXh0ZW5kU2VydmljZSAmJiB0aGlzLmpvaW50U2VhcmNoRXh0ZW5kU2VydmljZS5iZWZvcmVKb2ludFNlYXJjaCkge1xyXG4gICAgICAkZXZlbnRbJ2V2ZW50Q29kZSddID0gJ2JlZm9yZUpvaW50U2VhcmNoJztcclxuICAgICAgJGV2ZW50WydldmVudE5hbWUnXSA9ICdkcmlsbCBiZWZvcmUnO1xyXG4gICAgICAkZXZlbnRbJ2RhdGEnXSA9IHtcclxuICAgICAgICAnZnVuY3Rpb25pZCc6IGZ1bmN0aW9uaWQsXHJcbiAgICAgICAgJ29wdGlvbnMnOiBvcHRpb25zLFxyXG4gICAgICAgICdxdWVyeUlkJzogcXVlcnlJZCxcclxuICAgICAgICAnb3JnaW5RdWVyeUlkJzogdGhpcy5xdWVyeUlkLFxyXG4gICAgICAgICdxZHBWaWV3JzogdGhpcy5tZW51Q29udHJvbGxlclNlcnZpY2UucWRwVmlld1xyXG4gICAgICB9O1xyXG4gICAgICB0aGlzLmpvaW50U2VhcmNoRXh0ZW5kU2VydmljZS5iZWZvcmVKb2ludFNlYXJjaCgkZXZlbnQpO1xyXG4gICAgICBpZiAoJGV2ZW50ICYmICRldmVudFsnZGF0YSddICYmICRldmVudFsnZGF0YSddLm9wdGlvbnMpIHtcclxuICAgICAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbihvcHRpb25zLCAkZXZlbnRbJ2RhdGEnXS5vcHRpb25zKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoY2hvb3NlTGlzdC5zZWFyY2h0eXBlID09PSAndXJsJyB8fCBjaG9vc2VMaXN0LnNlYXJjaHR5cGUgPT09ICdhZGRpdGlvbmFsJykge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy8gdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KHF1ZXJ5SWQsIG9wdGlvbnMuRW50aXR5UGFyYW0pO1xyXG4gICAgbGV0IHRhYklkID0gJyc7XHJcbiAgICBpZiAoY2hvb3NlTGlzdC5zZWFyY2h0eXBlID09PSAnZnVuYycpIHtcclxuICAgICAgLy8g6IGU5p+l5YmNXHJcbiAgICAgIGNvbnN0IG9wZW5NZW51b3B0aW9ucyA9IHtcclxuICAgICAgICAnYXBwVHlwZSc6ICdtZW51JyxcclxuICAgICAgICAnZnVuY0lkJzogZnVuY3Rpb25pZCxcclxuICAgICAgICAndGFiSWQnOiBFdmVudEJ1cy5ndWlkKCksXHJcbiAgICAgICAgJ2FwcElkJzogJycsXHJcbiAgICAgICAgJ2FwcEVudHJhbmNlJzogJycsXHJcbiAgICAgICAgJ2VudGl0eVBhcmFtcyc6ICRldmVudFsnZW50aXR5UGFyYW1zJ10gfHwgZW50aXR5UGFyYW0sXHJcbiAgICAgICAgJ3F1ZXJ5U3RyaW5nUGFyYW1zJzogcGFyYW1NYXAsXHJcbiAgICAgICAgJ2lzTmV3VGFiJzogdHJ1ZVxyXG4gICAgICB9O1xyXG4gICAgICB0YWJJZCA9IFJ0ZlNlcnZpY2VzLmdldEZ1bmNJZChvcGVuTWVudW9wdGlvbnMpO1xyXG4gICAgICBjb25zdCBtZW51U3dpdGNoQ29udHJvbCA9IE9iamVjdC5hc3NpZ24oe30sIG9wZW5NZW51b3B0aW9uc1snZW50aXR5UGFyYW1zJ10sIFJ0ZlNlcnZpY2VzLmdldE1lbnVTd2l0Y2hDb250cm9sUGFyYW1ldGVyKHRhYklkKSk7XHJcbiAgICAgIG9wZW5NZW51b3B0aW9uc1snZW50aXR5UGFyYW1zJ10gPSBtZW51U3dpdGNoQ29udHJvbDtcclxuICAgICAgdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KHRhYklkID8gdGFiSWQgOiBxdWVyeUlkLCBvcHRpb25zLkVudGl0eVBhcmFtKTtcclxuICAgICAgLy8g5Y2h54mH5aGe6L+b5Y67cGFyYW1zXHJcbiAgICAgIHRoaXMuZnJhbWVXb3JrU2VydmljZS5vcGVuTWVudShvcGVuTWVudW9wdGlvbnMpO1xyXG4gICAgfSBlbHNlIGlmIChjaG9vc2VMaXN0LnNlYXJjaHR5cGUgPT09ICdhcHAnKSB7XHJcbiAgICAgIGNvbnN0IGFwcE9wdGlvbiA9IHtcclxuICAgICAgICBhcHBUeXBlOiAnYXBwJyxcclxuICAgICAgICBhcHBJZDogZnVuY3Rpb25pZCxcclxuICAgICAgICBhcHBFbnRyYW5jZTogY2hvb3NlTGlzdC5hcHBFbnRyYW5jZSxcclxuICAgICAgICBmdW5jSWQ6ICcnLFxyXG4gICAgICAgIGlzUmVsb2FkOiB0cnVlLFxyXG4gICAgICAgIHRhYklkOiBFdmVudEJ1cy5ndWlkKCksXHJcbiAgICAgICAgZW50aXR5UGFyYW1zOiAkZXZlbnRbJ2VudGl0eVBhcmFtcyddIHx8IGVudGl0eVBhcmFtLFxyXG4gICAgICAgIHF1ZXJ5U3RyaW5nUGFyYW1zOiBwYXJhbU1hcFxyXG4gICAgICB9O1xyXG4gICAgICB0YWJJZCA9IFJ0ZlNlcnZpY2VzLmdldEZ1bmNJZChhcHBPcHRpb24pO1xyXG4gICAgICB0aGlzLmNhY2hlU2VydmljZS5zZXQodGFiSWQgPyB0YWJJZCA6IHF1ZXJ5SWQsIG9wdGlvbnMuRW50aXR5UGFyYW0pO1xyXG4gICAgICBjb25zdCBtZW51U3dpdGNoQ29udHJvbCA9IE9iamVjdC5hc3NpZ24oe30sIGFwcE9wdGlvblsnZW50aXR5UGFyYW1zJ10sIFJ0ZlNlcnZpY2VzLmdldE1lbnVTd2l0Y2hDb250cm9sUGFyYW1ldGVyKHRhYklkKSk7XHJcbiAgICAgIGFwcE9wdGlvblsnZW50aXR5UGFyYW1zJ10gPSBtZW51U3dpdGNoQ29udHJvbDtcclxuICAgICAgdGhpcy5mcmFtZVdvcmtTZXJ2aWNlLm9wZW5NZW51KGFwcE9wdGlvbik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnZXRGdW5jdGlvbk5hbWUoZGF0YTogYW55KSB7XHJcbiAgICBsZXQgbG9jYWwgPSAnemgtY2hzJztcclxuICAgIGlmIChnc3BmcmFtZXdvcmtTZXJ2aWNlKSB7XHJcbiAgICAgIGxvY2FsID0gZ3NwZnJhbWV3b3JrU2VydmljZS5ydGYubGFuZ3VhZ2UuZ2V0TGFuZ3VhZ2VDb2RlKCkudG9Mb3dlckNhc2UoKTtcclxuICAgIH1cclxuICAgIGlmICghbG9jYWwpIHtcclxuICAgICAgbG9jYWwgPSAnemgtY2hzJztcclxuICAgIH1cclxuICAgIHJldHVybiBkYXRhW2xvY2FsXSA/IGRhdGFbbG9jYWxdIDogZGF0YTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0UXVlcnlQYXJhbWV0ZXJzKGVudGl0eVBhcmFtOiBhbnksIHBhcmFtTWFwOiBhbnksIHBhcmFtZXRlcktleTogYW55LCBrZXk6IGFueSkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgdGFiID0gZ3NwZnJhbWV3b3JrU2VydmljZS5ydGYuc2Vzc2lvbi5nZXRDb21tb25WYXJpYWJsZSgpO1xyXG4gICAgICBpZiAodGFiICYmIHRhYi50YWJJZCkge1xyXG4gICAgICAgIGNvbnN0IHRpZCA9IHRhYi50YWJJZCArIFJ0ZlNlcnZpY2VzLmdldEluU3VpdGVGcm1VVUlEKCk7XHJcbiAgICAgICAgaWYgKHRoaXMuY2FjaGVTZXJ2aWNlLmdldCh0aWQpICYmIHRoaXMuY2FjaGVTZXJ2aWNlLmdldCh0aWQpW3BhcmFtZXRlcktleV0pIHtcclxuICAgICAgICAgIGVudGl0eVBhcmFtW2tleV0gPSB0aGlzLmNhY2hlU2VydmljZS5nZXQodGlkKVtwYXJhbWV0ZXJLZXldO1xyXG4gICAgICAgICAgcGFyYW1NYXAuc2V0KGtleSwgdGhpcy5jYWNoZVNlcnZpY2UuZ2V0KHRpZClbcGFyYW1ldGVyS2V5XSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==