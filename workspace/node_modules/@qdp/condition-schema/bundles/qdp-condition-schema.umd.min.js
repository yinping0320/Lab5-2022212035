!function(e,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("@farris/devkit"),require("@farris/ui-notify"),require("rxjs/operators"),require("rxjs"),require("@ecp-caf/caf-common"),require("lodash-es"),require("rxjs/Subject"),require("@qdp/localize"),require("@qdp/common"),require("@farris/ui-messager"),require("@angular/core"),require("@angular/common"),require("@angular/forms"),require("@farris/ui-dialog"),require("@farris/ui-dropdown"),require("@farris/ui-datagrid-editors"),require("@farris/ui-datagrid")):"function"==typeof define&&define.amd?define("@qdp/condition-schema",["exports","@farris/devkit","@farris/ui-notify","rxjs/operators","rxjs","@ecp-caf/caf-common","lodash-es","rxjs/Subject","@qdp/localize","@qdp/common","@farris/ui-messager","@angular/core","@angular/common","@angular/forms","@farris/ui-dialog","@farris/ui-dropdown","@farris/ui-datagrid-editors","@farris/ui-datagrid"],i):i((e.qdp=e.qdp||{},e.qdp["condition-schema"]={}),e.devkit,e.uiNotify,e.rxjs.operators,e.rxjs,e.cafCommon,e.lodashEs,e.rxjs.Subject,e.localize,e.common,e.uiMessager,e.ng.core,e.ng.common,e.ng.forms,e.uiDialog,e.uiDropdown,e.uiDatagridEditors,e.uiDatagrid)}(this,function(e,i,t,r,n,s,c,a,o,l,d,h,u,m,f,p,g,v){"use strict";function S(e,i){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var a,r,n=t.call(e),s=[];try{for(;(void 0===i||0<i--)&&!(a=n.next()).done;)s.push(a.value)}catch(c){r={error:c}}finally{try{a&&!a.done&&(t=n["return"])&&t.call(n)}finally{if(r)throw r.error}}return s}var y=function(){function e(e,i,t,a){this.restService=e,this.sessionService=i,this.host=t,this.injector=a,this.uri="/api/runtime/bcc/v1.0/qdpcschemamanager/",this.schemaListChange=new n.Subject,this.uri=this.host+this.uri,this.injector&&(this.cache=this.injector.get(s.CacheService))}return e.prototype.getSchema=function(i,t,e){if(e&&this.schemaList&&this.schemaList[t]&&this.schemaList[t][i])return n.of(this.schemaList[t][i]);var a="";return this.cache&&(a=this.cache.get(l.RtfServices.getTabId(t)+"organizationId")||""),this.getSchemaList(t,"",a).pipe(r.map(function(e){return e&&e[t]&&e[t][i]?e[t][i]:null}))},e.prototype.getDefaultSchema=function(e,i){var t=this;if(i&&this.isDefaultSchema&&this.isDefaultSchema[e]&&this.isDefaultSchema[e].id)return n.of(this.isDefaultSchema[e]);var a="";return this.cache&&(a=this.cache.get(l.RtfServices.getTabId(e)+"organizationId")||""),this.getSchemaList(e,"",a).pipe(r.map(function(){return t.isDefaultSchema&&t.isDefaultSchema[e]&&t.isDefaultSchema[e].id?t.isDefaultSchema[e]:null}))},e.prototype.getSchemaList=function(t,e,i){var a=this;return this.restService.get(this.uri+"getschemalist",{queryId:t,userId:e,organizationId:i},this.createHeaderSessionId()).pipe(r.map(function(e){if(a.schemaList||(a.schemaList={}),a.isDefaultSchema||(a.isDefaultSchema={}),a.schemaList[t]={},e&&e.length){e.forEach(function(e){e.schemaValue=e.schemaValue?JSON.parse(e.schemaValue):null,1===(a.schemaList[t][e.id]=e).isDefault&&(a.isDefaultSchema[t]=e)});var i={schemaType:0};return a.isDefaultSchema[t]&&a.isDefaultSchema[t].id||c.filter(e,i)&&c.filter(e,i).length&&(a.isDefaultSchema[t]=c.filter(e,i)[0]),a.isDefaultSchema[t]&&a.isDefaultSchema[t].id||(i.schemaType=1,c.filter(e,i)&&c.filter(e,i).length&&(a.isDefaultSchema[t]=c.filter(e,i)[0])),a.schemaListChange.next({schemaInfo:a.schemaList,isDefaultSchema:a.isDefaultSchema}),a.schemaList}return a.schemaListChange.next({schemaInfo:null,isDefaultSchema:null}),null}))},e.prototype.getSchemaListByOrgId=function(i,e){var t=this;return this.restService.get(this.uri+"getschemalistbyorgid",{queryId:i,organizationId:e},this.createHeaderSessionId()).pipe(r.map(function(e){return t.schemaList||(t.schemaList={}),t.isDefaultSchema||(t.isDefaultSchema={}),t.schemaList[i]={},e&&e.length?(e.forEach(function(e){e.schemaValue=e.schemaValue?JSON.parse(e.schemaValue):null,1===(t.schemaList[i][e.id]=e).isDefault&&(t.isDefaultSchema[i]=e)}),t.schemaList):null}))},e.prototype.saveSchema=function(e){var i=this,t="";return this.cache&&(t=this.cache.get(l.RtfServices.getTabId(e.queryId)+"organizationId")||""),t&&(e.orgId=t),this.restService.post(this.uri+"saveschema",e,{},this.createHeaderSessionId()).pipe(r.switchMap(function(){return i.getSchemaList(e.queryId,"",t)}))},e.prototype.deleteSchema=function(e,i){var t=this,a="";return this.cache&&(a=this.cache.get(l.RtfServices.getTabId(i)+"organizationId")||""),this.restService["delete"](this.uri+"deleteschema",{id:e},this.createHeaderSessionId()).pipe(r.map(function(e){return!0===e&&t.getSchemaList(i,"",a).pipe(r.map(function(e){return!!e}))}))},e.prototype.deleteSchemaList=function(e,i){var t=this,a="";return this.cache&&(a=this.cache.get(l.RtfServices.getTabId(i)+"organizationId")||""),this.restService["delete"](this.uri+"deleteschemalist",{ids:e},this.createHeaderSessionId()).pipe(r.switchMap(function(){return t.getSchemaList(i,"",a)}))},e.prototype.createHeaderSessionId=function(){return l.RtfServices.createHeaderSessionId(this.sessionService)},e.decorators=[{type:h.Injectable}],e.ctorParameters=function(){return[{type:l.RestfulService},{type:s.SessionService},{type:String,decorators:[{type:h.Inject,args:[l.Server_Host]}]},{type:h.Injector,decorators:[{type:h.Optional}]}]},e}(),b=function(){function e(){this.finish=new a.Subject}return e.decorators=[{type:h.Injectable}],e.ctorParameters=function(){return[]},e}(),D=function(){function e(e,i,t,a,r){this.repository=e,this.conditionSchemaService=i,this.notifyService=t,this.finishLoasService=a,this.injector=r,this.bindingSchema={isDefault:!1,schemaName:"",schemaType:!1,schemavalue:{}},this.columns=[],this.total=0,this.editMode="row",this.pageSize=200,this.pageIndex=1,this.schemaTypeData=[{name:"公共",value:0},{name:"单位",value:2},{name:"个人",value:1}],this.size={},this.colDefault="colDefault"+l.EventBus.guid(),this.colPublic="colPublic"+l.EventBus.guid(),this.operations={},this.subscriptions=[],this.injector&&(this.localizeService=this.injector.get(o.LocalizeService),this.schemaService=this.injector.get(l.SchemaManagerService),this.msgService=this.injector.get(d.MessagerService))}return e.prototype.ngOnInit=function(){var i,t=this,a=this;this.conditionSchemaService.getSchemaList(this.queryId,"","").subscribe(function(e){t.schemaData=e&&e.length?e:[],i=t.schemaData.find(function(e){return 1===e.isDefault}),t.schemaData.forEach(function(e){e.isDefault=1===e.isDefault}),i&&(t.currentSchemaName=i.schemaName,t.finishLoasService.finish.subscribe(function(e){i&&i.schemaValue&&t.repository.entityCollection.getAllEntities()&&t.repository.entityCollection.getAllEntities().length&&(i.schemaValue.id=t.repository.entityCollection.getAllEntities()[0].id),t.repository.entityCollection.getAllEntities()[0].load(i.schemaValue)}))}),this.gridInit(),this.subscriptions.push(a.schemaService.operationChange.subscribe(function(e){e&&(a.operations=e)}))},e.prototype.ngOnDestroy=function(){var e,i;if(this.subscriptions&&this.subscriptions.length)try{for(var t=function r(e){var i="function"==typeof Symbol&&e[Symbol.iterator],t=0;return i?i.call(e):{next:function(){return e&&t>=e.length&&(e=void 0),{value:e&&e[t++],done:!e}}}}(this.subscriptions),a=t.next();!a.done;a=t.next()){a.value.unsubscribe()}}catch(n){e={error:n}}finally{try{a&&!a.done&&(i=t["return"])&&i.call(t)}finally{if(e)throw e.error}}},e.prototype.gridInit=function(){var e=this,i={valueField:"value",textField:"name",data:this.schemaTypeData};this.columns=[{field:"schemaName",width:100,title:e.localizeService.getValue("ideCmp.conditionSchemaManager.schemeName")},{field:"schemaType",width:100,title:e.localizeService.getValue("ideCmp.conditionSchemaManager.schemeType"),formatter:{type:"enum",options:i}},{field:"isDefault",width:100,title:e.localizeService.getValue("ideCmp.conditionSchemaManager.default"),editor:{type:g.EditorTypes.CHECKBOX,options:{}},formatter:{type:"boolean",options:{trueText:e.localizeService.getValue("ideCmp.conditionSchemaManager.default"),falseText:e.localizeService.getValue("ideCmp.conditionSchemaManager.noDefault")}}}]},e.prototype.onResized=function(e){this.size.height=e.newHeight,this.size.width=e.newWidth},e.prototype.handleSaveClick=function(){var i=this;if(this.isSchemaNameValid(this.bindingSchema.schemaName)){var e={};e.isDefault=this.bindingSchema.isDefault?1:0,e.queryId=this.queryId,e.schemaName=this.bindingSchema.schemaName,e.schemaType=this.bindingSchema.schemaType?0:1;var t=this.repository.entityCollection.toArray()[0].toJSON();if(delete t.id,e.schemaValue=JSON.stringify(t),!1!==this.operations.QdpModifyPublicSchema||0!==e.schemaType){if(this.schemaData&&e.isDefault){var a=this.schemaData.find(function(e){return 1===e.isDefault});a&&(a.isDefault=0)}this.schemaData.push(e),this.conditionSchemaService.saveSchema(e).subscribe(function(e){e?(i.schemaData=e,i.notifyService.success(i.localizeService.getValue("ideCmp.conditionSchemaManager.message.save.success"))):i.notifyService.error(i.localizeService.getValue("ideCmp.conditionSchemaManager.message.save.error"))}),this.savingManagerDiglog.close()}else this.msgService.warning(this.localizeService.getValue("ideCmp.schemaManager.message.validate.qdpModifyPublicSchema"))}},e.prototype.handleDefault=function(i){var t=this;if(!0===i.isDefault){var e=t.schemaData.find(function(e){return!0===e.isDefault&&e.id!==i.id});e&&(e.isDefault=!1)}var a=JSON.parse(JSON.stringify(t.schemaData.find(function(e){return e.id===i.id})));!1!==this.operations.QdpModifyPublicSchema||0!==a.schemaType?(a.isDefault=!1===a.isDefault?0:1,a.schemaValue=JSON.stringify(a.schemaValue),t.conditionSchemaService.saveSchema(a).subscribe(function(e){e?(t.notifyService.success(t.localizeService.getValue("ideCmp.conditionSchemaManager.message.update.success")),t.conditionSchemaService.getSchemaList(t.queryId,"","").subscribe(function(e){t.schemaData=e&&e.length?e:[];var i=t.schemaData.find(function(e){return 1===e.isDefault});t.schemaData.forEach(function(e){e.isDefault=1===e.isDefault}),i&&(t.currentSchemaName=i.schemaName)})):t.notifyService.error(t.localizeService.getValue("ideCmp.conditionSchemaManager.message.update.error"))})):this.msgService.warning(this.localizeService.getValue("ideCmp.schemaManager.message.validate.qdpModifyPublicSchema"))},e.prototype.saveDefaultSchemaHandler=function(){this.dg.endRowEdit()},e.prototype.endEdit=function(e){this.handleDefault(e.rowData||undefined)},e.prototype.handleDropDownItemClick=function(e){this.currentSchemaName=e.schemaName,this.bindingSchema.schemaName=e.schemaName,e&&e.schemaValue&&this.repository.entityCollection.getAllEntities()&&this.repository.entityCollection.getAllEntities().length&&(e.schemaValue.id=this.repository.entityCollection.getAllEntities()[0].id),this.repository.entityCollection.getAllEntities()[0].load(e.schemaValue)},e.prototype.deleteSchemerHandler=function(){var i=this;if(i.dg.selectedRow){var e=i.schemaData.findIndex(function(e){return e.id===i.dg.selectedRow.id});if(i.dg.refresh(),!1===this.operations.QdpModifyPublicSchema&&0===i.schemaData[e].schemaType)return void this.msgService.warning(this.localizeService.getValue("ideCmp.schemaManager.message.validate.qdpModifyPublicSchema"));if(1===i.schemaData[e].isDefault)return void i.notifyService.warning(i.localizeService.getValue("ideCmp.conditionSchemaManager.message.validate.delete"));var t=i.schemaData[e].id;i.schemaData.splice(e,1),i.conditionSchemaService.deleteSchema(t,i.queryId).subscribe(function(e){e?i.notifyService.success(i.localizeService.getValue("ideCmp.conditionSchemaManager.message.delete.success")):i.notifyService.error(i.localizeService.getValue("ideCmp.conditionSchemaManager.message.delete.error"))})}else i.notifyService.info(i.localizeService.getValue("ideCmp.conditionSchemaManager.message.validate.select"))},e.prototype.isSchemaNameValid=function(i){return 100<=i.length?(this.notifyService.warning(this.localizeService.getValue("ideCmp.conditionSchemaManager.message.validate.longLimit")),!1):!this.schemaData.find(function(e){return e.schemaName===i})||(this.notifyService.warning(this.localizeService.getValue("ideCmp.conditionSchemaManager.message.validate.repeatName")),!1)},e.decorators=[{type:h.Component,args:[{selector:"condition-schema-manager",template:'<div class="btn-group mr-3" fDropdown>\r\n  <button class="btn f-rt-btn f-btn-ml btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton"\r\n    fDropdownToggle>\r\n    <span class="f-icon f-icon-indent" role="presentation"></span>&nbsp;{{localizeService.getValue(\'ideCmp.conditionSchemaManager.conditionSchemeManagerName\')}}\r\n  </button>\r\n  <div class="dropdown-menu" fDropdownMenu>\r\n    <a class="dropdown-item" href="javascript:void(0);" (click)="savingManager.show()">\r\n      <span class="k-icon"></span>{{localizeService.getValue(\'ideCmp.conditionSchemaManager.schemeSave\')}}</a>\r\n    <div class="dropdown-divider"></div>\r\n\r\n    <a class="dropdown-item" href="javascript:void(0);" (click)="schemaManager.show()">\r\n      <span class="k-icon"></span>{{localizeService.getValue(\'ideCmp.conditionSchemaManager.schemeManagement\')}}</a>\r\n    <div class="dropdown-divider"></div>\r\n\r\n    <a *ngFor="let item of schemaData" class="dropdown-item" href="javascript:void(0);"\r\n      (click)="handleDropDownItemClick(item)">\r\n      <span [class.k-i-check]="currentSchemaName==item.schemaName" class="k-icon"></span>&nbsp;{{item.schemaName}}</a>\r\n  </div>\r\n</div>\r\n\r\n\x3c!-- 方案管理Diglog --\x3e\r\n<farris-dialog #schemaManager [title]="localizeService.getValue(\'ideCmp.conditionSchemaManager.schemeManagement\')" [showButtons]="false" [width]="700" [height]="500">\r\n  <div class="d-flex flex-column flex-fill position-relative h-100 m-0">\r\n    <div class="flex-fill farris-split-section m-1 farris-overflow-hidden" (resized)="onResized($event)">\r\n      <div class="farris-form farris-card-content-bg">\r\n        <fieldSet farrisFold [style.height.px]="size.height">\r\n          <button class="btn btn-primary mr-1 mb-1" id="button-edit" (click)="saveDefaultSchemaHandler()">{{localizeService.getValue(\'ideCmp.conditionSchemaManager.btnSave\')}}</button>\r\n          <button class="btn btn-secondary mr-1 mb-1" id="button-edit" (click)="deleteSchemerHandler()">{{localizeService.getValue(\'ideCmp.conditionSchemaManager.btnDelete\')}}</button>\r\n          <farris-datagrid #dg [data]="schemaData" [columns]="columns" #dg="datagrid" [fit]="true" [editable]="true"\r\n            [editMode]="editMode" [showCheckbox]="false" [fitColumns]="true" [showLineNumber]="true" [striped]="true"\r\n            [total]="total" [pageSize]="100" [virtualized]="true" [pagination]="false" (endEdit)="endEdit($event)">\r\n          </farris-datagrid>\r\n        </fieldSet>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</farris-dialog>\r\n\r\n\x3c!-- 保存方案Diglog --\x3e\r\n<farris-dialog #savingManager [title]="localizeService.getValue(\'ideCmp.conditionSchemaManager.schemeManagement\')" [showButtons]="false" [width]="350" [height]="210">\r\n  <div class="flex-fill farris-split-section m-1 farris-overflow-hidden">\r\n    <div class="farris-form farris-card-content-bg">\r\n      <div class="d-flex flex-wrap mb-2">\r\n        <div class="col-12 col-md-12 col-lg-12">\r\n          <div class="farris-group-wrap form-inline farris-form-inline">\r\n            <div class="form-group farris-form-group">\r\n              <label class="col-form-label" for="colName" style="width: 5rem; min-width: 5rem;">\r\n                <span class="farris-label-text">{{localizeService.getValue(\'ideCmp.conditionSchemaManager.schemeName\')}}:</span>\r\n              </label>\r\n              <div class="farris-input-wrap">\r\n                <input type="text" [(ngModel)]="bindingSchema.schemaName">\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div class="col-12 col-md-12 col-lg-12">\r\n          <div class="farris-group-wrap form-inline farris-form-inline">\r\n            <div class="form-group farris-form-group">\r\n              <label class="col-form-label" for="{{colDefault}}" style="width: 5rem; min-width: 5rem;">\r\n                <span class="farris-label-text">{{localizeService.getValue(\'ideCmp.conditionSchemaManager.default\')}}:</span>\r\n              </label>\r\n              <div class="farris-input-wrap farris-checkradio-hor">\r\n                <div class="custom-control custom-checkbox mb-0">\r\n                  <input type="checkbox" [(ngModel)]="bindingSchema.isDefault" class="custom-control-input"\r\n                    id="{{colDefault}}" checked="">\r\n                  <label class="custom-control-label" for="{{colDefault}}"></label>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div class="col-12 col-md-12 col-lg-12">\r\n          <div class="farris-group-wrap form-inline farris-form-inline">\r\n            <div class="form-group farris-form-group">\r\n              <label class="col-form-label" for="{{colPublic}}" style="width: 5rem; min-width: 5rem;">\r\n                <span class="farris-label-text">{{localizeService.getValue(\'ideCmp.conditionSchemaManager.public\')}}:</span>\r\n              </label>\r\n              <div class="farris-input-wrap farris-checkradio-hor">\r\n                <div class="custom-control custom-checkbox mb-0">\r\n                  <input type="checkbox" [(ngModel)]="bindingSchema.schemaType" class="custom-control-input"\r\n                    id="{{colPublic}}" checked="">\r\n                  <label class="custom-control-label" for="{{colPublic}}"></label>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n  <div style="padding:0px 34px">\r\n    <button class="btn btn-primary mr-1" id="button-edit" (click)="handleSaveClick()">{{localizeService.getValue(\'ideCmp.conditionSchemaManager.btnSave\')}}</button>\r\n  </div>\r\n</farris-dialog>\r\n',styles:[""]}]}],e.ctorParameters=function(){return[{type:i.Repository},{type:y},{type:t.NotifyService},{type:b},{type:h.Injector,decorators:[{type:h.Optional}]}]},e.propDecorators={queryId:[{type:h.Input}],savingManagerDiglog:[{type:h.ViewChild,args:["savingManager"]}],dg:[{type:h.ViewChild,args:["dg"]}]},e}(),M=function(){function e(){}return e.decorators=[{type:h.NgModule,args:[{declarations:[D],imports:[u.CommonModule,m.FormsModule,m.ReactiveFormsModule,f.FarrisDialogModule,v.ScrollbarModule,g.DatagridEditorsModule,v.DatagridModule.forRoot(function t(){for(var e=[],i=0;i<arguments.length;i++)e=e.concat(S(arguments[i]));return e}(g.EditorProviders)),p.FDropdownDirectiveTypeModule],exports:[D],providers:[y]}]}],e}();e.ConditionSchemaManagerComponent=D,e.ConditionSchemaService=y,e.FinishLoadService=b,e.ConditionSchemaModule=M,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=qdp-condition-schema.umd.min.js.map