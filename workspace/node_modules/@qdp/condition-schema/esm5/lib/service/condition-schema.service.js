/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
// import 'rxjs/add/operator/map';
import { Injectable, Inject, Optional, Injector } from '@angular/core';
import { map, switchMap } from 'rxjs/operators';
import { of, Subject } from 'rxjs';
import { CacheService, SessionService } from '@ecp-caf/caf-common';
import { RestfulService, Server_Host } from '@qdp/common';
import { RtfServices } from '@qdp/common';
import { filter } from 'lodash-es';
var ConditionSchemaService = /** @class */ (function () {
    function ConditionSchemaService(restService, sessionService, host, injector) {
        this.restService = restService;
        this.sessionService = sessionService;
        this.host = host;
        this.injector = injector;
        this.uri = '/api/runtime/bcc/v1.0/qdpcschemamanager/';
        this.schemaListChange = new Subject();
        this.uri = this.host + this.uri;
        if (this.injector) {
            this.cache = this.injector.get(CacheService);
        }
    }
    /**
     * 获取指定方案
     * @param id 方案ID
     * @param queryId 查询编号
     */
    /**
     * 获取指定方案
     * @param {?} id 方案ID
     * @param {?} queryId 查询编号
     * @param {?=} useCache
     * @return {?}
     */
    ConditionSchemaService.prototype.getSchema = /**
     * 获取指定方案
     * @param {?} id 方案ID
     * @param {?} queryId 查询编号
     * @param {?=} useCache
     * @return {?}
     */
    function (id, queryId, useCache) {
        if (useCache && this.schemaList && this.schemaList[queryId] && this.schemaList[queryId][id]) {
            return of(this.schemaList[queryId][id]);
        }
        else {
            /** @type {?} */
            var organizationId = '';
            if (this.cache) {
                organizationId = this.cache.get(RtfServices.getTabId(queryId) + 'organizationId') || '';
            }
            /** @type {?} */
            var result$ = this.getSchemaList(queryId, '', organizationId);
            return result$.pipe(map((/**
             * @param {?} value
             * @return {?}
             */
            function (value) {
                if (value && value[queryId] && value[queryId][id]) {
                    return value[queryId][id];
                }
                else {
                    return null;
                }
            })));
        }
    };
    /**
     * 获取默认方案
     */
    /**
     * 获取默认方案
     * @param {?} queryId
     * @param {?=} useCache
     * @return {?}
     */
    ConditionSchemaService.prototype.getDefaultSchema = /**
     * 获取默认方案
     * @param {?} queryId
     * @param {?=} useCache
     * @return {?}
     */
    function (queryId, useCache) {
        /** @type {?} */
        var self = this;
        if (useCache && this.isDefaultSchema && this.isDefaultSchema[queryId] && this.isDefaultSchema[queryId].id) {
            return of(this.isDefaultSchema[queryId]);
        }
        else {
            /** @type {?} */
            var organizationId = '';
            if (this.cache) {
                organizationId = this.cache.get(RtfServices.getTabId(queryId) + 'organizationId') || '';
            }
            /** @type {?} */
            var result$ = this.getSchemaList(queryId, '', organizationId);
            return result$.pipe(map((/**
             * @return {?}
             */
            function () {
                if (self.isDefaultSchema && self.isDefaultSchema[queryId] && self.isDefaultSchema[queryId].id) {
                    return self.isDefaultSchema[queryId];
                }
                else {
                    return null;
                }
            })));
        }
    };
    /**
     * 获取方案列表
     * @param queryId 查询编号
     * @param userId 用户ID
     * @param organizationId 语言类型
     */
    /**
     * 获取方案列表
     * @param {?} queryId 查询编号
     * @param {?} userId 用户ID
     * @param {?} organizationId 语言类型
     * @return {?}
     */
    ConditionSchemaService.prototype.getSchemaList = /**
     * 获取方案列表
     * @param {?} queryId 查询编号
     * @param {?} userId 用户ID
     * @param {?} organizationId 语言类型
     * @return {?}
     */
    function (queryId, userId, organizationId) {
        /** @type {?} */
        var self = this;
        /** @type {?} */
        var result$ = this.restService.get(this.uri + 'getschemalist', {
            queryId: queryId,
            userId: userId,
            organizationId: organizationId
        }, this.createHeaderSessionId());
        return result$.pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            if (!self.schemaList) {
                self.schemaList = {};
            }
            if (!self.isDefaultSchema) {
                self.isDefaultSchema = {};
            }
            self.schemaList[queryId] = {};
            if (data && data.length) {
                data.forEach((/**
                 * @param {?} value
                 * @return {?}
                 */
                function (value) {
                    value.schemaValue = value.schemaValue ? JSON.parse(value.schemaValue) : null;
                    self.schemaList[queryId][value.id] = value;
                    if (value.isDefault === 1) {
                        self.isDefaultSchema[queryId] = value;
                    }
                }));
                /** @type {?} */
                var filterCondition = { schemaType: 0 };
                if (!self.isDefaultSchema[queryId] || !self.isDefaultSchema[queryId].id) {
                    if (filter(data, filterCondition) && filter(data, filterCondition).length) {
                        self.isDefaultSchema[queryId] = filter(data, filterCondition)[0];
                    }
                }
                if (!self.isDefaultSchema[queryId] || !self.isDefaultSchema[queryId].id) {
                    filterCondition.schemaType = 1;
                    if (filter(data, filterCondition) && filter(data, filterCondition).length) {
                        self.isDefaultSchema[queryId] = filter(data, filterCondition)[0];
                    }
                }
                self.schemaListChange.next({ schemaInfo: self.schemaList, isDefaultSchema: self.isDefaultSchema });
                return self.schemaList;
            }
            else {
                self.schemaListChange.next({ schemaInfo: null, isDefaultSchema: null });
                return null;
            }
        })));
    };
    /**
     * 获取方案列表
     * @param queryId 查询编号
     * @param organizationId 组织ID
     */
    /**
     * 获取方案列表
     * @param {?} queryId 查询编号
     * @param {?} organizationId 组织ID
     * @return {?}
     */
    ConditionSchemaService.prototype.getSchemaListByOrgId = /**
     * 获取方案列表
     * @param {?} queryId 查询编号
     * @param {?} organizationId 组织ID
     * @return {?}
     */
    function (queryId, organizationId) {
        /** @type {?} */
        var self = this;
        /** @type {?} */
        var result$ = this.restService.get(this.uri + 'getschemalistbyorgid', {
            queryId: queryId,
            organizationId: organizationId
        }, this.createHeaderSessionId());
        return result$.pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            if (!self.schemaList) {
                self.schemaList = {};
            }
            if (!self.isDefaultSchema) {
                self.isDefaultSchema = {};
            }
            self.schemaList[queryId] = {};
            if (data && data.length) {
                data.forEach((/**
                 * @param {?} value
                 * @return {?}
                 */
                function (value) {
                    value.schemaValue = value.schemaValue ? JSON.parse(value.schemaValue) : null;
                    self.schemaList[queryId][value.id] = value;
                    if (value.isDefault === 1) {
                        self.isDefaultSchema[queryId] = value;
                    }
                }));
                return self.schemaList;
            }
            else {
                return null;
            }
        })));
    };
    /**
     * 保存方案
     * @param schema 方案实体
     */
    /**
     * 保存方案
     * @param {?} schema 方案实体
     * @return {?}
     */
    ConditionSchemaService.prototype.saveSchema = /**
     * 保存方案
     * @param {?} schema 方案实体
     * @return {?}
     */
    function (schema) {
        var _this = this;
        /** @type {?} */
        var organizationId = '';
        if (this.cache) {
            organizationId = this.cache.get(RtfServices.getTabId(schema.queryId) + 'organizationId') || '';
        }
        if (organizationId) {
            schema.orgId = organizationId;
        }
        /** @type {?} */
        var result$ = this.restService.post(this.uri + 'saveschema', schema, {}, this.createHeaderSessionId());
        return result$.pipe(switchMap((/**
         * @return {?}
         */
        function () {
            return _this.getSchemaList(schema.queryId, '', organizationId);
        })));
    };
    /**
     * 删除方案
     * @param id 方案ID
     * @param queryId 查询编号
     */
    /**
     * 删除方案
     * @param {?} id 方案ID
     * @param {?} queryId 查询编号
     * @return {?}
     */
    ConditionSchemaService.prototype.deleteSchema = /**
     * 删除方案
     * @param {?} id 方案ID
     * @param {?} queryId 查询编号
     * @return {?}
     */
    function (id, queryId) {
        var _this = this;
        /** @type {?} */
        var organizationId = '';
        if (this.cache) {
            organizationId = this.cache.get(RtfServices.getTabId(queryId) + 'organizationId') || '';
        }
        /** @type {?} */
        var result$ = this.restService.delete(this.uri + 'deleteschema', { id: id }, this.createHeaderSessionId());
        return result$.pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            if (data === true) {
                /** @type {?} */
                var result$1 = _this.getSchemaList(queryId, '', organizationId);
                return result$1.pipe(map((/**
                 * @param {?} value
                 * @return {?}
                 */
                function (value) {
                    if (value) {
                        return true;
                    }
                    else {
                        return false;
                    }
                })));
            }
            else {
                return false;
            }
        })));
    };
    /**
     * 删除方案
     * @param id 方案ID
     * @param queryId 查询编号
     */
    /**
     * 删除方案
     * @param {?} ids
     * @param {?} queryId 查询编号
     * @return {?}
     */
    ConditionSchemaService.prototype.deleteSchemaList = /**
     * 删除方案
     * @param {?} ids
     * @param {?} queryId 查询编号
     * @return {?}
     */
    function (ids, queryId) {
        var _this = this;
        /** @type {?} */
        var organizationId = '';
        if (this.cache) {
            organizationId = this.cache.get(RtfServices.getTabId(queryId) + 'organizationId') || '';
        }
        /** @type {?} */
        var result$ = this.restService.delete(this.uri + 'deleteschemalist', { ids: ids }, this.createHeaderSessionId());
        return result$.pipe(switchMap((/**
         * @return {?}
         */
        function () {
            return _this.getSchemaList(queryId, '', organizationId);
        })));
    };
    /**
     * @private
     * @return {?}
     */
    ConditionSchemaService.prototype.createHeaderSessionId = /**
     * @private
     * @return {?}
     */
    function () {
        return RtfServices.createHeaderSessionId(this.sessionService);
    };
    ConditionSchemaService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ConditionSchemaService.ctorParameters = function () { return [
        { type: RestfulService },
        { type: SessionService },
        { type: String, decorators: [{ type: Inject, args: [Server_Host,] }] },
        { type: Injector, decorators: [{ type: Optional }] }
    ]; };
    return ConditionSchemaService;
}());
export { ConditionSchemaService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    ConditionSchemaService.prototype.uri;
    /** @type {?} */
    ConditionSchemaService.prototype.isDefaultSchema;
    /** @type {?} */
    ConditionSchemaService.prototype.schemaList;
    /** @type {?} */
    ConditionSchemaService.prototype.schemaListChange;
    /** @type {?} */
    ConditionSchemaService.prototype.cache;
    /**
     * @type {?}
     * @private
     */
    ConditionSchemaService.prototype.restService;
    /**
     * @type {?}
     * @private
     */
    ConditionSchemaService.prototype.sessionService;
    /**
     * @type {?}
     * @private
     */
    ConditionSchemaService.prototype.host;
    /**
     * @type {?}
     * @private
     */
    ConditionSchemaService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZGl0aW9uLXNjaGVtYS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHFkcC9jb25kaXRpb24tc2NoZW1hLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2UvY29uZGl0aW9uLXNjaGVtYS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RSxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hELE9BQU8sRUFBYyxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9DLE9BQU8sRUFBRSxZQUFZLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkUsT0FBTyxFQUFFLGNBQWMsRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDMUQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUMxQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRW5DO0lBWUUsZ0NBQ1UsV0FBMkIsRUFDM0IsY0FBOEIsRUFDVCxJQUFZLEVBQ3JCLFFBQWtCO1FBSDlCLGdCQUFXLEdBQVgsV0FBVyxDQUFnQjtRQUMzQixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDVCxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQ3JCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFkaEMsUUFBRyxHQUFHLDBDQUEwQyxDQUFDO1FBTXpELHFCQUFnQixHQUFHLElBQUksT0FBTyxFQUFPLENBQUM7UUFTcEMsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7UUFDaEMsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2pCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFFB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SSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsRUFBRSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQ3pELENBQUMsRUFBQyxDQUNILENBQUM7SUFDSixDQUFDOzs7OztJQUVPLHNEQUFxQjs7OztJQUE3QjtRQUNFLE9BQU8sV0FBVyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNoRSxDQUFDOztnQkF0T0YsVUFBVTs7OztnQkFKRixjQUFjO2dCQURBLGNBQWM7NkNBb0JoQyxNQUFNLFNBQUMsV0FBVztnQkF2QmdCLFFBQVEsdUJBd0IxQyxRQUFROztJQXdOYiw2QkFBQztDQUFBLEFBeE9ELElBd09DO1NBdk9ZLHNCQUFzQjs7Ozs7O0lBQ2pDLHFDQUF5RDs7SUFFekQsaURBQXFCOztJQUVyQiw0Q0FBZ0I7O0lBRWhCLGtEQUFzQzs7SUFFdEMsdUNBQW9COzs7OztJQUdsQiw2Q0FBbUM7Ozs7O0lBQ25DLGdEQUFzQzs7Ozs7SUFDdEMsc0NBQXlDOzs7OztJQUN6QywwQ0FBc0MiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBpbXBvcnQgJ3J4anMvYWRkL29wZXJhdG9yL21hcCc7XHJcbmltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCwgT3B0aW9uYWwsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IG1hcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBDYWNoZVNlcnZpY2UsIFNlc3Npb25TZXJ2aWNlIH0gZnJvbSAnQGVjcC1jYWYvY2FmLWNvbW1vbic7XHJcbmltcG9ydCB7IFJlc3RmdWxTZXJ2aWNlLCBTZXJ2ZXJfSG9zdCB9IGZyb20gJ0BxZHAvY29tbW9uJztcclxuaW1wb3J0IHsgUnRmU2VydmljZXMgfSBmcm9tICdAcWRwL2NvbW1vbic7XHJcbmltcG9ydCB7IGZpbHRlciB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBDb25kaXRpb25TY2hlbWFTZXJ2aWNlIHtcclxuICBwcml2YXRlIHVyaSA9ICcvYXBpL3J1bnRpbWUvYmNjL3YxLjAvcWRwY3NjaGVtYW1hbmFnZXIvJztcclxuXHJcbiAgaXNEZWZhdWx0U2NoZW1hOiBhbnk7XHJcblxyXG4gIHNjaGVtYUxpc3Q6IGFueTtcclxuXHJcbiAgc2NoZW1hTGlzdENoYW5nZSA9IG5ldyBTdWJqZWN0PGFueT4oKTtcclxuXHJcbiAgY2FjaGU6IENhY2hlU2VydmljZTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIHJlc3RTZXJ2aWNlOiBSZXN0ZnVsU2VydmljZSxcclxuICAgIHByaXZhdGUgc2Vzc2lvblNlcnZpY2U6IFNlc3Npb25TZXJ2aWNlLFxyXG4gICAgQEluamVjdChTZXJ2ZXJfSG9zdCkgcHJpdmF0ZSBob3N0OiBzdHJpbmcsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gICAgdGhpcy51cmkgPSB0aGlzLmhvc3QgKyB0aGlzLnVyaTtcclxuICAgIGlmICh0aGlzLmluamVjdG9yKSB7XHJcbiAgICAgIHRoaXMuY2FjaGUgPSB0aGlzLmluamVjdG9yLmdldChDYWNoZVNlcnZpY2UpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5oyH5a6a5pa55qGIXHJcbiAgICogQHBhcmFtIGlkIOaWueahiElEXHJcbiAgICogQHBhcmFtIHF1ZXJ5SWQg5p+l6K+i57yW5Y+3XHJcbiAgICovXHJcbiAgZ2V0U2NoZW1hKGlkOiBzdHJpbmcsIHF1ZXJ5SWQ6IHN0cmluZywgdXNlQ2FjaGU/OiBib29sZWFuKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmICh1c2VDYWNoZSAmJiB0aGlzLnNjaGVtYUxpc3QgJiYgdGhpcy5zY2hlbWFMaXN0W3F1ZXJ5SWRdICYmIHRoaXMuc2NoZW1hTGlzdFtxdWVyeUlkXVtpZF0pIHtcclxuICAgICAgcmV0dXJuIG9mKHRoaXMuc2NoZW1hTGlzdFtxdWVyeUlkXVtpZF0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbGV0IG9yZ2FuaXphdGlvbklkID0gJyc7XHJcbiAgICAgIGlmICh0aGlzLmNhY2hlKSB7XHJcbiAgICAgICAgb3JnYW5pemF0aW9uSWQgPSB0aGlzLmNhY2hlLmdldChSdGZTZXJ2aWNlcy5nZXRUYWJJZChxdWVyeUlkKSArICdvcmdhbml6YXRpb25JZCcpIHx8ICcnO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IHJlc3VsdCQgPSB0aGlzLmdldFNjaGVtYUxpc3QocXVlcnlJZCwgJycsIG9yZ2FuaXphdGlvbklkKTtcclxuICAgICAgcmV0dXJuIHJlc3VsdCQucGlwZShcclxuICAgICAgICBtYXAodmFsdWUgPT4ge1xyXG4gICAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlW3F1ZXJ5SWRdICYmIHZhbHVlW3F1ZXJ5SWRdW2lkXSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdmFsdWVbcXVlcnlJZF1baWRdO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W6buY6K6k5pa55qGIXHJcbiAgICovXHJcbiAgZ2V0RGVmYXVsdFNjaGVtYShxdWVyeUlkOiBzdHJpbmcsIHVzZUNhY2hlPzogYm9vbGVhbik6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCBzZWxmID0gdGhpcztcclxuICAgIGlmICh1c2VDYWNoZSAmJiB0aGlzLmlzRGVmYXVsdFNjaGVtYSAmJiB0aGlzLmlzRGVmYXVsdFNjaGVtYVtxdWVyeUlkXSAmJiB0aGlzLmlzRGVmYXVsdFNjaGVtYVtxdWVyeUlkXS5pZCkge1xyXG4gICAgICByZXR1cm4gb2YodGhpcy5pc0RlZmF1bHRTY2hlbWFbcXVlcnlJZF0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbGV0IG9yZ2FuaXphdGlvbklkID0gJyc7XHJcbiAgICAgIGlmICh0aGlzLmNhY2hlKSB7XHJcbiAgICAgICAgb3JnYW5pemF0aW9uSWQgPSB0aGlzLmNhY2hlLmdldChSdGZTZXJ2aWNlcy5nZXRUYWJJZChxdWVyeUlkKSArICdvcmdhbml6YXRpb25JZCcpIHx8ICcnO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IHJlc3VsdCQgPSB0aGlzLmdldFNjaGVtYUxpc3QocXVlcnlJZCwgJycsIG9yZ2FuaXphdGlvbklkKTtcclxuICAgICAgcmV0dXJuIHJlc3VsdCQucGlwZShcclxuICAgICAgICBtYXAoKCkgPT4ge1xyXG4gICAgICAgICAgaWYgKHNlbGYuaXNEZWZhdWx0U2NoZW1hICYmIHNlbGYuaXNEZWZhdWx0U2NoZW1hW3F1ZXJ5SWRdICYmIHNlbGYuaXNEZWZhdWx0U2NoZW1hW3F1ZXJ5SWRdLmlkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBzZWxmLmlzRGVmYXVsdFNjaGVtYVtxdWVyeUlkXTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluaWueahiOWIl+ihqFxyXG4gICAqIEBwYXJhbSBxdWVyeUlkIOafpeivoue8luWPt1xyXG4gICAqIEBwYXJhbSB1c2VySWQg55So5oi3SURcclxuICAgKiBAcGFyYW0gb3JnYW5pemF0aW9uSWQg6K+t6KiA57G75Z6LXHJcbiAgICovXHJcbiAgZ2V0U2NoZW1hTGlzdChxdWVyeUlkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nLCBvcmdhbml6YXRpb25JZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IHRoaXMucmVzdFNlcnZpY2UuZ2V0KHRoaXMudXJpICsgJ2dldHNjaGVtYWxpc3QnLCB7XHJcbiAgICAgIHF1ZXJ5SWQsXHJcbiAgICAgIHVzZXJJZCxcclxuICAgICAgb3JnYW5pemF0aW9uSWRcclxuICAgIH0sIHRoaXMuY3JlYXRlSGVhZGVyU2Vzc2lvbklkKCkpO1xyXG5cclxuICAgIHJldHVybiByZXN1bHQkLnBpcGUoXHJcbiAgICAgIG1hcCgoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKCFzZWxmLnNjaGVtYUxpc3QpIHtcclxuICAgICAgICAgIHNlbGYuc2NoZW1hTGlzdCA9IHt9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXNlbGYuaXNEZWZhdWx0U2NoZW1hKSB7XHJcbiAgICAgICAgICBzZWxmLmlzRGVmYXVsdFNjaGVtYSA9IHt9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBzZWxmLnNjaGVtYUxpc3RbcXVlcnlJZF0gPSB7fTtcclxuICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLmxlbmd0aCkge1xyXG4gICAgICAgICAgZGF0YS5mb3JFYWNoKHZhbHVlID0+IHtcclxuICAgICAgICAgICAgdmFsdWUuc2NoZW1hVmFsdWUgPSB2YWx1ZS5zY2hlbWFWYWx1ZSA/IEpTT04ucGFyc2UodmFsdWUuc2NoZW1hVmFsdWUpIDogbnVsbDtcclxuICAgICAgICAgICAgc2VsZi5zY2hlbWFMaXN0W3F1ZXJ5SWRdW3ZhbHVlLmlkXSA9IHZhbHVlO1xyXG4gICAgICAgICAgICBpZiAodmFsdWUuaXNEZWZhdWx0ID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgc2VsZi5pc0RlZmF1bHRTY2hlbWFbcXVlcnlJZF0gPSB2YWx1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICBjb25zdCBmaWx0ZXJDb25kaXRpb246IGFueSA9IHsgc2NoZW1hVHlwZTogMCB9O1xyXG4gICAgICAgICAgaWYgKCFzZWxmLmlzRGVmYXVsdFNjaGVtYVtxdWVyeUlkXSB8fCAhc2VsZi5pc0RlZmF1bHRTY2hlbWFbcXVlcnlJZF0uaWQpIHtcclxuICAgICAgICAgICAgaWYgKGZpbHRlcihkYXRhLCBmaWx0ZXJDb25kaXRpb24pICYmIGZpbHRlcihkYXRhLCBmaWx0ZXJDb25kaXRpb24pLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgIHNlbGYuaXNEZWZhdWx0U2NoZW1hW3F1ZXJ5SWRdID0gZmlsdGVyKGRhdGEsIGZpbHRlckNvbmRpdGlvbilbMF07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGlmICghc2VsZi5pc0RlZmF1bHRTY2hlbWFbcXVlcnlJZF0gfHwgIXNlbGYuaXNEZWZhdWx0U2NoZW1hW3F1ZXJ5SWRdLmlkKSB7XHJcbiAgICAgICAgICAgIGZpbHRlckNvbmRpdGlvbi5zY2hlbWFUeXBlID0gMTtcclxuICAgICAgICAgICAgaWYgKGZpbHRlcihkYXRhLCBmaWx0ZXJDb25kaXRpb24pICYmIGZpbHRlcihkYXRhLCBmaWx0ZXJDb25kaXRpb24pLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgIHNlbGYuaXNEZWZhdWx0U2NoZW1hW3F1ZXJ5SWRdID0gZmlsdGVyKGRhdGEsIGZpbHRlckNvbmRpdGlvbilbMF07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHNlbGYuc2NoZW1hTGlzdENoYW5nZS5uZXh0KHsgc2NoZW1hSW5mbzogc2VsZi5zY2hlbWFMaXN0LCBpc0RlZmF1bHRTY2hlbWE6IHNlbGYuaXNEZWZhdWx0U2NoZW1hIH0pO1xyXG5cclxuICAgICAgICAgIHJldHVybiBzZWxmLnNjaGVtYUxpc3Q7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHNlbGYuc2NoZW1hTGlzdENoYW5nZS5uZXh0KHsgc2NoZW1hSW5mbzogbnVsbCwgaXNEZWZhdWx0U2NoZW1hOiBudWxsIH0pO1xyXG4gICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5pa55qGI5YiX6KGoXHJcbiAgICogQHBhcmFtIHF1ZXJ5SWQg5p+l6K+i57yW5Y+3XHJcbiAgICogQHBhcmFtIG9yZ2FuaXphdGlvbklkIOe7hOe7h0lEXHJcbiAgICovXHJcbiAgZ2V0U2NoZW1hTGlzdEJ5T3JnSWQocXVlcnlJZDogc3RyaW5nLCBvcmdhbml6YXRpb25JZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IHRoaXMucmVzdFNlcnZpY2UuZ2V0KHRoaXMudXJpICsgJ2dldHNjaGVtYWxpc3RieW9yZ2lkJywge1xyXG4gICAgICBxdWVyeUlkLFxyXG4gICAgICBvcmdhbml6YXRpb25JZFxyXG4gICAgfSwgdGhpcy5jcmVhdGVIZWFkZXJTZXNzaW9uSWQoKSk7XHJcblxyXG4gICAgcmV0dXJuIHJlc3VsdCQucGlwZShcclxuICAgICAgbWFwKChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgICBpZiAoIXNlbGYuc2NoZW1hTGlzdCkge1xyXG4gICAgICAgICAgc2VsZi5zY2hlbWFMaXN0ID0ge307XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghc2VsZi5pc0RlZmF1bHRTY2hlbWEpIHtcclxuICAgICAgICAgIHNlbGYuaXNEZWZhdWx0U2NoZW1hID0ge307XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHNlbGYuc2NoZW1hTGlzdFtxdWVyeUlkXSA9IHt9O1xyXG4gICAgICAgIGlmIChkYXRhICYmIGRhdGEubGVuZ3RoKSB7XHJcbiAgICAgICAgICBkYXRhLmZvckVhY2godmFsdWUgPT4ge1xyXG4gICAgICAgICAgICB2YWx1ZS5zY2hlbWFWYWx1ZSA9IHZhbHVlLnNjaGVtYVZhbHVlID8gSlNPTi5wYXJzZSh2YWx1ZS5zY2hlbWFWYWx1ZSkgOiBudWxsO1xyXG4gICAgICAgICAgICBzZWxmLnNjaGVtYUxpc3RbcXVlcnlJZF1bdmFsdWUuaWRdID0gdmFsdWU7XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZS5pc0RlZmF1bHQgPT09IDEpIHtcclxuICAgICAgICAgICAgICBzZWxmLmlzRGVmYXVsdFNjaGVtYVtxdWVyeUlkXSA9IHZhbHVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICAgIHJldHVybiBzZWxmLnNjaGVtYUxpc3Q7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOS/neWtmOaWueahiFxyXG4gICAqIEBwYXJhbSBzY2hlbWEg5pa55qGI5a6e5L2TXHJcbiAgICovXHJcbiAgc2F2ZVNjaGVtYShzY2hlbWE6IGFueSk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBsZXQgb3JnYW5pemF0aW9uSWQgPSAnJztcclxuICAgIGlmICh0aGlzLmNhY2hlKSB7XHJcbiAgICAgIG9yZ2FuaXphdGlvbklkID0gdGhpcy5jYWNoZS5nZXQoUnRmU2VydmljZXMuZ2V0VGFiSWQoc2NoZW1hLnF1ZXJ5SWQpICsgJ29yZ2FuaXphdGlvbklkJykgfHwgJyc7XHJcbiAgICB9XHJcbiAgICBpZiAob3JnYW5pemF0aW9uSWQpIHtcclxuICAgICAgc2NoZW1hLm9yZ0lkID0gb3JnYW5pemF0aW9uSWQ7XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXN1bHQkID0gdGhpcy5yZXN0U2VydmljZS5wb3N0KHRoaXMudXJpICsgJ3NhdmVzY2hlbWEnLCBzY2hlbWEsIHt9LCB0aGlzLmNyZWF0ZUhlYWRlclNlc3Npb25JZCgpKTtcclxuICAgIHJldHVybiByZXN1bHQkLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2NoZW1hTGlzdChzY2hlbWEucXVlcnlJZCwgJycsIG9yZ2FuaXphdGlvbklkKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWIoOmZpOaWueahiFxyXG4gICAqIEBwYXJhbSBpZCDmlrnmoYhJRFxyXG4gICAqIEBwYXJhbSBxdWVyeUlkIOafpeivoue8luWPt1xyXG4gICAqL1xyXG4gIGRlbGV0ZVNjaGVtYShpZDogc3RyaW5nLCBxdWVyeUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgbGV0IG9yZ2FuaXphdGlvbklkID0gJyc7XHJcbiAgICBpZiAodGhpcy5jYWNoZSkge1xyXG4gICAgICBvcmdhbml6YXRpb25JZCA9IHRoaXMuY2FjaGUuZ2V0KFJ0ZlNlcnZpY2VzLmdldFRhYklkKHF1ZXJ5SWQpICsgJ29yZ2FuaXphdGlvbklkJykgfHwgJyc7XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXN1bHQkID0gdGhpcy5yZXN0U2VydmljZS5kZWxldGUodGhpcy51cmkgKyAnZGVsZXRlc2NoZW1hJywgeyBpZCB9LCB0aGlzLmNyZWF0ZUhlYWRlclNlc3Npb25JZCgpKTtcclxuICAgIHJldHVybiByZXN1bHQkLnBpcGUoXHJcbiAgICAgIG1hcCgoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKGRhdGEgPT09IHRydWUpIHtcclxuICAgICAgICAgIGNvbnN0IHJlc3VsdCQxID0gdGhpcy5nZXRTY2hlbWFMaXN0KHF1ZXJ5SWQsICcnLCBvcmdhbml6YXRpb25JZCk7XHJcbiAgICAgICAgICByZXR1cm4gcmVzdWx0JDEucGlwZShcclxuICAgICAgICAgICAgbWFwKHZhbHVlID0+IHtcclxuICAgICAgICAgICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWIoOmZpOaWueahiFxyXG4gICAqIEBwYXJhbSBpZCDmlrnmoYhJRFxyXG4gICAqIEBwYXJhbSBxdWVyeUlkIOafpeivoue8luWPt1xyXG4gICAqL1xyXG4gIGRlbGV0ZVNjaGVtYUxpc3QoaWRzOiBhbnksIHF1ZXJ5SWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBsZXQgb3JnYW5pemF0aW9uSWQgPSAnJztcclxuICAgIGlmICh0aGlzLmNhY2hlKSB7XHJcbiAgICAgIG9yZ2FuaXphdGlvbklkID0gdGhpcy5jYWNoZS5nZXQoUnRmU2VydmljZXMuZ2V0VGFiSWQocXVlcnlJZCkgKyAnb3JnYW5pemF0aW9uSWQnKSB8fCAnJztcclxuICAgIH1cclxuICAgIGNvbnN0IHJlc3VsdCQgPSB0aGlzLnJlc3RTZXJ2aWNlLmRlbGV0ZSh0aGlzLnVyaSArICdkZWxldGVzY2hlbWFsaXN0JywgeyBpZHMgfSwgdGhpcy5jcmVhdGVIZWFkZXJTZXNzaW9uSWQoKSk7XHJcbiAgICByZXR1cm4gcmVzdWx0JC5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldFNjaGVtYUxpc3QocXVlcnlJZCwgJycsIG9yZ2FuaXphdGlvbklkKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNyZWF0ZUhlYWRlclNlc3Npb25JZCgpIHtcclxuICAgIHJldHVybiBSdGZTZXJ2aWNlcy5jcmVhdGVIZWFkZXJTZXNzaW9uSWQodGhpcy5zZXNzaW9uU2VydmljZSk7XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=