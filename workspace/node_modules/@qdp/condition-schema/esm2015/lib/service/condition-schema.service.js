/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
// import 'rxjs/add/operator/map';
import { Injectable, Inject, Optional, Injector } from '@angular/core';
import { map, switchMap } from 'rxjs/operators';
import { of, Subject } from 'rxjs';
import { CacheService, SessionService } from '@ecp-caf/caf-common';
import { RestfulService, Server_Host } from '@qdp/common';
import { RtfServices } from '@qdp/common';
import { filter } from 'lodash-es';
export class ConditionSchemaService {
    /**
     * @param {?} restService
     * @param {?} sessionService
     * @param {?} host
     * @param {?} injector
     */
    constructor(restService, sessionService, host, injector) {
        this.restService = restService;
        this.sessionService = sessionService;
        this.host = host;
        this.injector = injector;
        this.uri = '/api/runtime/bcc/v1.0/qdpcschemamanager/';
        this.schemaListChange = new Subject();
        this.uri = this.host + this.uri;
        if (this.injector) {
            this.cache = this.injector.get(CacheService);
        }
    }
    /**
     * 获取指定方案
     * @param {?} id 方案ID
     * @param {?} queryId 查询编号
     * @param {?=} useCache
     * @return {?}
     */
    getSchema(id, queryId, useCache) {
        if (useCache && this.schemaList && this.schemaList[queryId] && this.schemaList[queryId][id]) {
            return of(this.schemaList[queryId][id]);
        }
        else {
            /** @type {?} */
            let organizationId = '';
            if (this.cache) {
                organizationId = this.cache.get(RtfServices.getTabId(queryId) + 'organizationId') || '';
            }
            /** @type {?} */
            const result$ = this.getSchemaList(queryId, '', organizationId);
            return result$.pipe(map((/**
             * @param {?} value
             * @return {?}
             */
            value => {
                if (value && value[queryId] && value[queryId][id]) {
                    return value[queryId][id];
                }
                else {
                    return null;
                }
            })));
        }
    }
    /**
     * 获取默认方案
     * @param {?} queryId
     * @param {?=} useCache
     * @return {?}
     */
    getDefaultSchema(queryId, useCache) {
        /** @type {?} */
        const self = this;
        if (useCache && this.isDefaultSchema && this.isDefaultSchema[queryId] && this.isDefaultSchema[queryId].id) {
            return of(this.isDefaultSchema[queryId]);
        }
        else {
            /** @type {?} */
            let organizationId = '';
            if (this.cache) {
                organizationId = this.cache.get(RtfServices.getTabId(queryId) + 'organizationId') || '';
            }
            /** @type {?} */
            const result$ = this.getSchemaList(queryId, '', organizationId);
            return result$.pipe(map((/**
             * @return {?}
             */
            () => {
                if (self.isDefaultSchema && self.isDefaultSchema[queryId] && self.isDefaultSchema[queryId].id) {
                    return self.isDefaultSchema[queryId];
                }
                else {
                    return null;
                }
            })));
        }
    }
    /**
     * 获取方案列表
     * @param {?} queryId 查询编号
     * @param {?} userId 用户ID
     * @param {?} organizationId 语言类型
     * @return {?}
     */
    getSchemaList(queryId, userId, organizationId) {
        /** @type {?} */
        const self = this;
        /** @type {?} */
        const result$ = this.restService.get(this.uri + 'getschemalist', {
            queryId,
            userId,
            organizationId
        }, this.createHeaderSessionId());
        return result$.pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            if (!self.schemaList) {
                self.schemaList = {};
            }
            if (!self.isDefaultSchema) {
                self.isDefaultSchema = {};
            }
            self.schemaList[queryId] = {};
            if (data && data.length) {
                data.forEach((/**
                 * @param {?} value
                 * @return {?}
                 */
                value => {
                    value.schemaValue = value.schemaValue ? JSON.parse(value.schemaValue) : null;
                    self.schemaList[queryId][value.id] = value;
                    if (value.isDefault === 1) {
                        self.isDefaultSchema[queryId] = value;
                    }
                }));
                /** @type {?} */
                const filterCondition = { schemaType: 0 };
                if (!self.isDefaultSchema[queryId] || !self.isDefaultSchema[queryId].id) {
                    if (filter(data, filterCondition) && filter(data, filterCondition).length) {
                        self.isDefaultSchema[queryId] = filter(data, filterCondition)[0];
                    }
                }
                if (!self.isDefaultSchema[queryId] || !self.isDefaultSchema[queryId].id) {
                    filterCondition.schemaType = 1;
                    if (filter(data, filterCondition) && filter(data, filterCondition).length) {
                        self.isDefaultSchema[queryId] = filter(data, filterCondition)[0];
                    }
                }
                self.schemaListChange.next({ schemaInfo: self.schemaList, isDefaultSchema: self.isDefaultSchema });
                return self.schemaList;
            }
            else {
                self.schemaListChange.next({ schemaInfo: null, isDefaultSchema: null });
                return null;
            }
        })));
    }
    /**
     * 获取方案列表
     * @param {?} queryId 查询编号
     * @param {?} organizationId 组织ID
     * @return {?}
     */
    getSchemaListByOrgId(queryId, organizationId) {
        /** @type {?} */
        const self = this;
        /** @type {?} */
        const result$ = this.restService.get(this.uri + 'getschemalistbyorgid', {
            queryId,
            organizationId
        }, this.createHeaderSessionId());
        return result$.pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            if (!self.schemaList) {
                self.schemaList = {};
            }
            if (!self.isDefaultSchema) {
                self.isDefaultSchema = {};
            }
            self.schemaList[queryId] = {};
            if (data && data.length) {
                data.forEach((/**
                 * @param {?} value
                 * @return {?}
                 */
                value => {
                    value.schemaValue = value.schemaValue ? JSON.parse(value.schemaValue) : null;
                    self.schemaList[queryId][value.id] = value;
                    if (value.isDefault === 1) {
                        self.isDefaultSchema[queryId] = value;
                    }
                }));
                return self.schemaList;
            }
            else {
                return null;
            }
        })));
    }
    /**
     * 保存方案
     * @param {?} schema 方案实体
     * @return {?}
     */
    saveSchema(schema) {
        /** @type {?} */
        let organizationId = '';
        if (this.cache) {
            organizationId = this.cache.get(RtfServices.getTabId(schema.queryId) + 'organizationId') || '';
        }
        if (organizationId) {
            schema.orgId = organizationId;
        }
        /** @type {?} */
        const result$ = this.restService.post(this.uri + 'saveschema', schema, {}, this.createHeaderSessionId());
        return result$.pipe(switchMap((/**
         * @return {?}
         */
        () => {
            return this.getSchemaList(schema.queryId, '', organizationId);
        })));
    }
    /**
     * 删除方案
     * @param {?} id 方案ID
     * @param {?} queryId 查询编号
     * @return {?}
     */
    deleteSchema(id, queryId) {
        /** @type {?} */
        let organizationId = '';
        if (this.cache) {
            organizationId = this.cache.get(RtfServices.getTabId(queryId) + 'organizationId') || '';
        }
        /** @type {?} */
        const result$ = this.restService.delete(this.uri + 'deleteschema', { id }, this.createHeaderSessionId());
        return result$.pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            if (data === true) {
                /** @type {?} */
                const result$1 = this.getSchemaList(queryId, '', organizationId);
                return result$1.pipe(map((/**
                 * @param {?} value
                 * @return {?}
                 */
                value => {
                    if (value) {
                        return true;
                    }
                    else {
                        return false;
                    }
                })));
            }
            else {
                return false;
            }
        })));
    }
    /**
     * 删除方案
     * @param {?} ids
     * @param {?} queryId 查询编号
     * @return {?}
     */
    deleteSchemaList(ids, queryId) {
        /** @type {?} */
        let organizationId = '';
        if (this.cache) {
            organizationId = this.cache.get(RtfServices.getTabId(queryId) + 'organizationId') || '';
        }
        /** @type {?} */
        const result$ = this.restService.delete(this.uri + 'deleteschemalist', { ids }, this.createHeaderSessionId());
        return result$.pipe(switchMap((/**
         * @return {?}
         */
        () => {
            return this.getSchemaList(queryId, '', organizationId);
        })));
    }
    /**
     * @private
     * @return {?}
     */
    createHeaderSessionId() {
        return RtfServices.createHeaderSessionId(this.sessionService);
    }
}
ConditionSchemaService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ConditionSchemaService.ctorParameters = () => [
    { type: RestfulService },
    { type: SessionService },
    { type: String, decorators: [{ type: Inject, args: [Server_Host,] }] },
    { type: Injector, decorators: [{ type: Optional }] }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    ConditionSchemaService.prototype.uri;
    /** @type {?} */
    ConditionSchemaService.prototype.isDefaultSchema;
    /** @type {?} */
    ConditionSchemaService.prototype.schemaList;
    /** @type {?} */
    ConditionSchemaService.prototype.schemaListChange;
    /** @type {?} */
    ConditionSchemaService.prototype.cache;
    /**
     * @type {?}
     * @private
     */
    ConditionSchemaService.prototype.restService;
    /**
     * @type {?}
     * @private
     */
    ConditionSchemaService.prototype.sessionService;
    /**
     * @type {?}
     * @private
     */
    ConditionSchemaService.prototype.host;
    /**
     * @type {?}
     * @private
     */
    ConditionSchemaService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZGl0aW9uLXNjaGVtYS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHFkcC9jb25kaXRpb24tc2NoZW1hLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2UvY29uZGl0aW9uLXNjaGVtYS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RSxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hELE9BQU8sRUFBYyxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9DLE9BQU8sRUFBRSxZQUFZLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkUsT0FBTyxFQUFFLGNBQWMsRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDMUQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUMxQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBR25DLE1BQU0sT0FBTyxzQkFBc0I7Ozs7Ozs7SUFXakMsWUFDVSxXQUEyQixFQUMzQixjQUE4QixFQUNULElBQVksRUFDckIsUUFBa0I7UUFIOUIsZ0JBQVcsR0FBWCxXQUFXLENBQWdCO1FBQzNCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUNULFNBQUksR0FBSixJQUFJLENBQVE7UUFDckIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQWRoQyxRQUFHLEdBQUcsMENBQTBDLENBQUM7UUFNekQscUJBQWdCLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQVNwQyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQztRQUNoQyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDakIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztTQUM5QztJQUNILENBQUM7Ozs7Ozs7O0lBT0QsU0FBUyxDQUFDLEVBQVUsRUFBRSxPQUFlLEVBQUUsUUFBa0I7UUFDdkQsSUFBSSxRQUFRLElBQUksSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUU7WUFDM0YsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ3pDO2FBQU07O2dCQUNELGNBQWMsR0FBRyxFQUFFO1lBQ3ZCLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtnQkFDZCxjQUFjLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQzthQUN6Rjs7a0JBQ0ssT0FBTyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLEVBQUUsRUFBRSxjQUFjLENBQUM7WUFDL0QsT0FBTyxPQUFPLENBQUMsSUFBSSxDQUNqQixHQUFHOzs7O1lBQUMsS0FBSyxDQUFDLEVBQUU7Z0JBQ1YsSUFBSSxLQUFLLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRTtvQkFDakQsT0FBTyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7aUJBQzNCO3FCQUFNO29CQUNMLE9BQU8sSUFBSSxDQUFDO2lCQUNiO1lBQ0gsQ0FBQyxFQUFDLENBQ0gsQ0FBQztTQUNIO0lBQ0gsQ0FBQzs7Ozs7OztJQUlELGdCQUFnQixDQUFDLE9BQWUsRUFBRSxRQUFrQjs7Y0FDNUMsSUFBSSxHQUFHLElBQUk7UUFDakIsSUFBSSxRQUFRLElBQUksSUFBSSxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxFQUFFO1lBQ3pHLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztTQUMxQzthQUFNOztnQkFDRCxjQUFjLEdBQUcsRUFBRTtZQUN2QixJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7Z0JBQ2QsY0FBYyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDekY7O2tCQUNLLE9BQU8sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxFQUFFLEVBQUUsY0FBYyxDQUFDO1lBQy9ELE9BQU8sT0FBTyxDQUFDLElBQUksQ0FDakIsR0FBRzs7O1lBQUMsR0FBRyxFQUFFO2dCQUNQLElBQUksSUFBSSxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxFQUFFO29CQUM3RixPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQ3RDO3FCQUFNO29CQUNMLE9BQU8sSUFBSSxDQUFDO2lCQUNiO1lBQ0gsQ0FBQyxFQUFDLENBQ0gsQ0FBQztTQUNIO0lBQ0gsQ0FBQzs7Ozs7Ozs7SUFPRCxhQUFhLENBQUMsT0FBZSxFQUFFLE1BQWMsRUFBRSxjQUFzQjs7Y0FDN0QsSUFBSSxHQUFHLElBQUk7O2NBQ1gsT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsZUFBZSxFQUFFO1lBQy9ELE9BQU87WUFDUCxNQUFNO1lBQ04sY0FBYztTQUNmLEVBQUUsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFFaEMsT0FBTyxPQUFPLENBQUMsSUFBSSxDQUNqQixHQUFHOzs7O1FBQUMsQ0FBQyxJQUFTLEVBQUUsRUFBRTtZQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDcEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7YUFDdEI7WUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRTtnQkFDekIsSUFBSSxDQUFDLGVBQWUsR0FBRyxFQUFFLENBQUM7YUFDM0I7WUFDRCxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUM5QixJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUN2QixJQUFJLENBQUMsT0FBTzs7OztnQkFBQyxLQUFLLENBQUMsRUFBRTtvQkFDbkIsS0FBSyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUM3RSxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUM7b0JBQzNDLElBQUksS0FBSyxDQUFDLFNBQVMsS0FBSyxDQUFDLEVBQUU7d0JBQ3pCLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLEdBQUcsS0FBSyxDQUFDO3FCQUN2QztnQkFDSCxDQUFDLEVBQUMsQ0FBQzs7c0JBQ0csZUFBZSxHQUFRLEVBQUUsVUFBVSxFQUFFLENBQUMsRUFBRTtnQkFDOUMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsRUFBRTtvQkFDdkUsSUFBSSxNQUFNLENBQUMsSUFBSSxFQUFFLGVBQWUsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEVBQUUsZUFBZSxDQUFDLENBQUMsTUFBTSxFQUFFO3dCQUN6RSxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxJQUFJLEVBQUUsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7cUJBQ2xFO2lCQUNGO2dCQUNELElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLEVBQUU7b0JBQ3ZFLGVBQWUsQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDO29CQUMvQixJQUFJLE1BQU0sQ0FBQyxJQUFJLEVBQUUsZUFBZSxDQUFDLElBQUksTUFBTSxDQUFDLElBQUksRUFBRSxlQUFlLENBQUMsQ0FBQyxNQUFNLEVBQUU7d0JBQ3pFLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztxQkFDbEU7aUJBQ0Y7Z0JBQ0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxFQUFFLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFLGVBQWUsRUFBRSxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQztnQkFFbkcsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDO2FBQ3hCO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO2dCQUN4RSxPQUFPLElBQUksQ0FBQzthQUNiO1FBQ0gsQ0FBQyxFQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7Ozs7Ozs7SUFNRCxvQkFBb0IsQ0FBQyxPQUFlLEVBQUUsY0FBc0I7O2NBQ3BELElBQUksR0FBRyxJQUFJOztjQUNYLE9BQU8sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLHNCQUFzQixFQUFFO1lBQ3RFLE9BQU87WUFDUCxjQUFjO1NBQ2YsRUFBRSxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUVoQyxPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQ2pCLEdBQUc7Ozs7UUFBQyxDQUFDLElBQVMsRUFBRSxFQUFFO1lBQ2hCLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFO2dCQUNwQixJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQzthQUN0QjtZQUNELElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFO2dCQUN6QixJQUFJLENBQUMsZUFBZSxHQUFHLEVBQUUsQ0FBQzthQUMzQjtZQUNELElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQzlCLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQ3ZCLElBQUksQ0FBQyxPQUFPOzs7O2dCQUFDLEtBQUssQ0FBQyxFQUFFO29CQUNuQixLQUFLLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzdFLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQztvQkFDM0MsSUFBSSxLQUFLLENBQUMsU0FBUyxLQUFLLENBQUMsRUFBRTt3QkFDekIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsR0FBRyxLQUFLLENBQUM7cUJBQ3ZDO2dCQUNILENBQUMsRUFBQyxDQUFDO2dCQUNILE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQzthQUN4QjtpQkFBTTtnQkFDTCxPQUFPLElBQUksQ0FBQzthQUNiO1FBQ0gsQ0FBQyxFQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7Ozs7OztJQUtELFVBQVUsQ0FBQyxNQUFXOztZQUNoQixjQUFjLEdBQUcsRUFBRTtRQUN2QixJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDZCxjQUFjLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDaEc7UUFDRCxJQUFJLGNBQWMsRUFBRTtZQUNsQixNQUFNLENBQUMsS0FBSyxHQUFHLGNBQWMsQ0FBQztTQUMvQjs7Y0FDSyxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxZQUFZLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUN4RyxPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQ2pCLFNBQVM7OztRQUFDLEdBQUcsRUFBRTtZQUNiLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLEVBQUUsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUNoRSxDQUFDLEVBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQzs7Ozs7OztJQU1ELFlBQVksQ0FBQyxFQUFVLEVBQUUsT0FBZTs7WUFDbEMsY0FBYyxHQUFHLEVBQUU7UUFDdkIsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ2QsY0FBYyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDekY7O2NBQ0ssT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsY0FBYyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFDeEcsT0FBTyxPQUFPLENBQUMsSUFBSSxDQUNqQixHQUFHOzs7O1FBQUMsQ0FBQyxJQUFTLEVBQUUsRUFBRTtZQUNoQixJQUFJLElBQUksS0FBSyxJQUFJLEVBQUU7O3NCQUNYLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxFQUFFLEVBQUUsY0FBYyxDQUFDO2dCQUNoRSxPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQ2xCLEdBQUc7Ozs7Z0JBQUMsS0FBSyxDQUFDLEVBQUU7b0JBQ1YsSUFBSSxLQUFLLEVBQUU7d0JBQ1QsT0FBTyxJQUFJLENBQUM7cUJBQ2I7eUJBQU07d0JBQ0wsT0FBTyxLQUFLLENBQUM7cUJBQ2Q7Z0JBQ0gsQ0FBQyxFQUFDLENBQ0gsQ0FBQzthQUNIO2lCQUFNO2dCQUNMLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7UUFDSCxDQUFDLEVBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQzs7Ozs7OztJQU1ELGdCQUFnQixDQUFDLEdBQVEsRUFBRSxPQUFlOztZQUNwQyxjQUFjLEdBQUcsRUFBRTtRQUN2QixJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDZCxjQUFjLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUN6Rjs7Y0FDSyxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxrQkFBa0IsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQzdHLE9BQU8sT0FBTyxDQUFDLElBQUksQ0FDakIsU0FBUzs7O1FBQUMsR0FBRyxFQUFFO1lBQ2IsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxFQUFFLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFDekQsQ0FBQyxFQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7Ozs7O0lBRU8scUJBQXFCO1FBQzNCLE9BQU8sV0FBVyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNoRSxDQUFDOzs7WUF0T0YsVUFBVTs7OztZQUpGLGNBQWM7WUFEQSxjQUFjO3lDQW9CaEMsTUFBTSxTQUFDLFdBQVc7WUF2QmdCLFFBQVEsdUJBd0IxQyxRQUFROzs7Ozs7O0lBZFgscUNBQXlEOztJQUV6RCxpREFBcUI7O0lBRXJCLDRDQUFnQjs7SUFFaEIsa0RBQXNDOztJQUV0Qyx1Q0FBb0I7Ozs7O0lBR2xCLDZDQUFtQzs7Ozs7SUFDbkMsZ0RBQXNDOzs7OztJQUN0QyxzQ0FBeUM7Ozs7O0lBQ3pDLDBDQUFzQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIGltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3IvbWFwJztcclxuaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0LCBPcHRpb25hbCwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgbWFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IENhY2hlU2VydmljZSwgU2Vzc2lvblNlcnZpY2UgfSBmcm9tICdAZWNwLWNhZi9jYWYtY29tbW9uJztcclxuaW1wb3J0IHsgUmVzdGZ1bFNlcnZpY2UsIFNlcnZlcl9Ib3N0IH0gZnJvbSAnQHFkcC9jb21tb24nO1xyXG5pbXBvcnQgeyBSdGZTZXJ2aWNlcyB9IGZyb20gJ0BxZHAvY29tbW9uJztcclxuaW1wb3J0IHsgZmlsdGVyIH0gZnJvbSAnbG9kYXNoLWVzJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIENvbmRpdGlvblNjaGVtYVNlcnZpY2Uge1xyXG4gIHByaXZhdGUgdXJpID0gJy9hcGkvcnVudGltZS9iY2MvdjEuMC9xZHBjc2NoZW1hbWFuYWdlci8nO1xyXG5cclxuICBpc0RlZmF1bHRTY2hlbWE6IGFueTtcclxuXHJcbiAgc2NoZW1hTGlzdDogYW55O1xyXG5cclxuICBzY2hlbWFMaXN0Q2hhbmdlID0gbmV3IFN1YmplY3Q8YW55PigpO1xyXG5cclxuICBjYWNoZTogQ2FjaGVTZXJ2aWNlO1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgcmVzdFNlcnZpY2U6IFJlc3RmdWxTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBzZXNzaW9uU2VydmljZTogU2Vzc2lvblNlcnZpY2UsXHJcbiAgICBASW5qZWN0KFNlcnZlcl9Ib3N0KSBwcml2YXRlIGhvc3Q6IHN0cmluZyxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yKSB7XHJcbiAgICB0aGlzLnVyaSA9IHRoaXMuaG9zdCArIHRoaXMudXJpO1xyXG4gICAgaWYgKHRoaXMuaW5qZWN0b3IpIHtcclxuICAgICAgdGhpcy5jYWNoZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KENhY2hlU2VydmljZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bmjIflrprmlrnmoYhcclxuICAgKiBAcGFyYW0gaWQg5pa55qGISURcclxuICAgKiBAcGFyYW0gcXVlcnlJZCDmn6Xor6LnvJblj7dcclxuICAgKi9cclxuICBnZXRTY2hlbWEoaWQ6IHN0cmluZywgcXVlcnlJZDogc3RyaW5nLCB1c2VDYWNoZT86IGJvb2xlYW4pOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgaWYgKHVzZUNhY2hlICYmIHRoaXMuc2NoZW1hTGlzdCAmJiB0aGlzLnNjaGVtYUxpc3RbcXVlcnlJZF0gJiYgdGhpcy5zY2hlbWFMaXN0W3F1ZXJ5SWRdW2lkXSkge1xyXG4gICAgICByZXR1cm4gb2YodGhpcy5zY2hlbWFMaXN0W3F1ZXJ5SWRdW2lkXSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBsZXQgb3JnYW5pemF0aW9uSWQgPSAnJztcclxuICAgICAgaWYgKHRoaXMuY2FjaGUpIHtcclxuICAgICAgICBvcmdhbml6YXRpb25JZCA9IHRoaXMuY2FjaGUuZ2V0KFJ0ZlNlcnZpY2VzLmdldFRhYklkKHF1ZXJ5SWQpICsgJ29yZ2FuaXphdGlvbklkJykgfHwgJyc7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgcmVzdWx0JCA9IHRoaXMuZ2V0U2NoZW1hTGlzdChxdWVyeUlkLCAnJywgb3JnYW5pemF0aW9uSWQpO1xyXG4gICAgICByZXR1cm4gcmVzdWx0JC5waXBlKFxyXG4gICAgICAgIG1hcCh2YWx1ZSA9PiB7XHJcbiAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWVbcXVlcnlJZF0gJiYgdmFsdWVbcXVlcnlJZF1baWRdKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZVtxdWVyeUlkXVtpZF07XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bpu5jorqTmlrnmoYhcclxuICAgKi9cclxuICBnZXREZWZhdWx0U2NoZW1hKHF1ZXJ5SWQ6IHN0cmluZywgdXNlQ2FjaGU/OiBib29sZWFuKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgaWYgKHVzZUNhY2hlICYmIHRoaXMuaXNEZWZhdWx0U2NoZW1hICYmIHRoaXMuaXNEZWZhdWx0U2NoZW1hW3F1ZXJ5SWRdICYmIHRoaXMuaXNEZWZhdWx0U2NoZW1hW3F1ZXJ5SWRdLmlkKSB7XHJcbiAgICAgIHJldHVybiBvZih0aGlzLmlzRGVmYXVsdFNjaGVtYVtxdWVyeUlkXSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBsZXQgb3JnYW5pemF0aW9uSWQgPSAnJztcclxuICAgICAgaWYgKHRoaXMuY2FjaGUpIHtcclxuICAgICAgICBvcmdhbml6YXRpb25JZCA9IHRoaXMuY2FjaGUuZ2V0KFJ0ZlNlcnZpY2VzLmdldFRhYklkKHF1ZXJ5SWQpICsgJ29yZ2FuaXphdGlvbklkJykgfHwgJyc7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgcmVzdWx0JCA9IHRoaXMuZ2V0U2NoZW1hTGlzdChxdWVyeUlkLCAnJywgb3JnYW5pemF0aW9uSWQpO1xyXG4gICAgICByZXR1cm4gcmVzdWx0JC5waXBlKFxyXG4gICAgICAgIG1hcCgoKSA9PiB7XHJcbiAgICAgICAgICBpZiAoc2VsZi5pc0RlZmF1bHRTY2hlbWEgJiYgc2VsZi5pc0RlZmF1bHRTY2hlbWFbcXVlcnlJZF0gJiYgc2VsZi5pc0RlZmF1bHRTY2hlbWFbcXVlcnlJZF0uaWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHNlbGYuaXNEZWZhdWx0U2NoZW1hW3F1ZXJ5SWRdO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5pa55qGI5YiX6KGoXHJcbiAgICogQHBhcmFtIHF1ZXJ5SWQg5p+l6K+i57yW5Y+3XHJcbiAgICogQHBhcmFtIHVzZXJJZCDnlKjmiLdJRFxyXG4gICAqIEBwYXJhbSBvcmdhbml6YXRpb25JZCDor63oqIDnsbvlnotcclxuICAgKi9cclxuICBnZXRTY2hlbWFMaXN0KHF1ZXJ5SWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcsIG9yZ2FuaXphdGlvbklkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcbiAgICBjb25zdCByZXN1bHQkID0gdGhpcy5yZXN0U2VydmljZS5nZXQodGhpcy51cmkgKyAnZ2V0c2NoZW1hbGlzdCcsIHtcclxuICAgICAgcXVlcnlJZCxcclxuICAgICAgdXNlcklkLFxyXG4gICAgICBvcmdhbml6YXRpb25JZFxyXG4gICAgfSwgdGhpcy5jcmVhdGVIZWFkZXJTZXNzaW9uSWQoKSk7XHJcblxyXG4gICAgcmV0dXJuIHJlc3VsdCQucGlwZShcclxuICAgICAgbWFwKChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgICBpZiAoIXNlbGYuc2NoZW1hTGlzdCkge1xyXG4gICAgICAgICAgc2VsZi5zY2hlbWFMaXN0ID0ge307XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghc2VsZi5pc0RlZmF1bHRTY2hlbWEpIHtcclxuICAgICAgICAgIHNlbGYuaXNEZWZhdWx0U2NoZW1hID0ge307XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHNlbGYuc2NoZW1hTGlzdFtxdWVyeUlkXSA9IHt9O1xyXG4gICAgICAgIGlmIChkYXRhICYmIGRhdGEubGVuZ3RoKSB7XHJcbiAgICAgICAgICBkYXRhLmZvckVhY2godmFsdWUgPT4ge1xyXG4gICAgICAgICAgICB2YWx1ZS5zY2hlbWFWYWx1ZSA9IHZhbHVlLnNjaGVtYVZhbHVlID8gSlNPTi5wYXJzZSh2YWx1ZS5zY2hlbWFWYWx1ZSkgOiBudWxsO1xyXG4gICAgICAgICAgICBzZWxmLnNjaGVtYUxpc3RbcXVlcnlJZF1bdmFsdWUuaWRdID0gdmFsdWU7XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZS5pc0RlZmF1bHQgPT09IDEpIHtcclxuICAgICAgICAgICAgICBzZWxmLmlzRGVmYXVsdFNjaGVtYVtxdWVyeUlkXSA9IHZhbHVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICAgIGNvbnN0IGZpbHRlckNvbmRpdGlvbjogYW55ID0geyBzY2hlbWFUeXBlOiAwIH07XHJcbiAgICAgICAgICBpZiAoIXNlbGYuaXNEZWZhdWx0U2NoZW1hW3F1ZXJ5SWRdIHx8ICFzZWxmLmlzRGVmYXVsdFNjaGVtYVtxdWVyeUlkXS5pZCkge1xyXG4gICAgICAgICAgICBpZiAoZmlsdGVyKGRhdGEsIGZpbHRlckNvbmRpdGlvbikgJiYgZmlsdGVyKGRhdGEsIGZpbHRlckNvbmRpdGlvbikubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgc2VsZi5pc0RlZmF1bHRTY2hlbWFbcXVlcnlJZF0gPSBmaWx0ZXIoZGF0YSwgZmlsdGVyQ29uZGl0aW9uKVswXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgaWYgKCFzZWxmLmlzRGVmYXVsdFNjaGVtYVtxdWVyeUlkXSB8fCAhc2VsZi5pc0RlZmF1bHRTY2hlbWFbcXVlcnlJZF0uaWQpIHtcclxuICAgICAgICAgICAgZmlsdGVyQ29uZGl0aW9uLnNjaGVtYVR5cGUgPSAxO1xyXG4gICAgICAgICAgICBpZiAoZmlsdGVyKGRhdGEsIGZpbHRlckNvbmRpdGlvbikgJiYgZmlsdGVyKGRhdGEsIGZpbHRlckNvbmRpdGlvbikubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgc2VsZi5pc0RlZmF1bHRTY2hlbWFbcXVlcnlJZF0gPSBmaWx0ZXIoZGF0YSwgZmlsdGVyQ29uZGl0aW9uKVswXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgc2VsZi5zY2hlbWFMaXN0Q2hhbmdlLm5leHQoeyBzY2hlbWFJbmZvOiBzZWxmLnNjaGVtYUxpc3QsIGlzRGVmYXVsdFNjaGVtYTogc2VsZi5pc0RlZmF1bHRTY2hlbWEgfSk7XHJcblxyXG4gICAgICAgICAgcmV0dXJuIHNlbGYuc2NoZW1hTGlzdDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgc2VsZi5zY2hlbWFMaXN0Q2hhbmdlLm5leHQoeyBzY2hlbWFJbmZvOiBudWxsLCBpc0RlZmF1bHRTY2hlbWE6IG51bGwgfSk7XHJcbiAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bmlrnmoYjliJfooahcclxuICAgKiBAcGFyYW0gcXVlcnlJZCDmn6Xor6LnvJblj7dcclxuICAgKiBAcGFyYW0gb3JnYW5pemF0aW9uSWQg57uE57uHSURcclxuICAgKi9cclxuICBnZXRTY2hlbWFMaXN0QnlPcmdJZChxdWVyeUlkOiBzdHJpbmcsIG9yZ2FuaXphdGlvbklkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcbiAgICBjb25zdCByZXN1bHQkID0gdGhpcy5yZXN0U2VydmljZS5nZXQodGhpcy51cmkgKyAnZ2V0c2NoZW1hbGlzdGJ5b3JnaWQnLCB7XHJcbiAgICAgIHF1ZXJ5SWQsXHJcbiAgICAgIG9yZ2FuaXphdGlvbklkXHJcbiAgICB9LCB0aGlzLmNyZWF0ZUhlYWRlclNlc3Npb25JZCgpKTtcclxuXHJcbiAgICByZXR1cm4gcmVzdWx0JC5waXBlKFxyXG4gICAgICBtYXAoKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmICghc2VsZi5zY2hlbWFMaXN0KSB7XHJcbiAgICAgICAgICBzZWxmLnNjaGVtYUxpc3QgPSB7fTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFzZWxmLmlzRGVmYXVsdFNjaGVtYSkge1xyXG4gICAgICAgICAgc2VsZi5pc0RlZmF1bHRTY2hlbWEgPSB7fTtcclxuICAgICAgICB9XHJcbiAgICAgICAgc2VsZi5zY2hlbWFMaXN0W3F1ZXJ5SWRdID0ge307XHJcbiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5sZW5ndGgpIHtcclxuICAgICAgICAgIGRhdGEuZm9yRWFjaCh2YWx1ZSA9PiB7XHJcbiAgICAgICAgICAgIHZhbHVlLnNjaGVtYVZhbHVlID0gdmFsdWUuc2NoZW1hVmFsdWUgPyBKU09OLnBhcnNlKHZhbHVlLnNjaGVtYVZhbHVlKSA6IG51bGw7XHJcbiAgICAgICAgICAgIHNlbGYuc2NoZW1hTGlzdFtxdWVyeUlkXVt2YWx1ZS5pZF0gPSB2YWx1ZTtcclxuICAgICAgICAgICAgaWYgKHZhbHVlLmlzRGVmYXVsdCA9PT0gMSkge1xyXG4gICAgICAgICAgICAgIHNlbGYuaXNEZWZhdWx0U2NoZW1hW3F1ZXJ5SWRdID0gdmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgcmV0dXJuIHNlbGYuc2NoZW1hTGlzdDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5L+d5a2Y5pa55qGIXHJcbiAgICogQHBhcmFtIHNjaGVtYSDmlrnmoYjlrp7kvZNcclxuICAgKi9cclxuICBzYXZlU2NoZW1hKHNjaGVtYTogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGxldCBvcmdhbml6YXRpb25JZCA9ICcnO1xyXG4gICAgaWYgKHRoaXMuY2FjaGUpIHtcclxuICAgICAgb3JnYW5pemF0aW9uSWQgPSB0aGlzLmNhY2hlLmdldChSdGZTZXJ2aWNlcy5nZXRUYWJJZChzY2hlbWEucXVlcnlJZCkgKyAnb3JnYW5pemF0aW9uSWQnKSB8fCAnJztcclxuICAgIH1cclxuICAgIGlmIChvcmdhbml6YXRpb25JZCkge1xyXG4gICAgICBzY2hlbWEub3JnSWQgPSBvcmdhbml6YXRpb25JZDtcclxuICAgIH1cclxuICAgIGNvbnN0IHJlc3VsdCQgPSB0aGlzLnJlc3RTZXJ2aWNlLnBvc3QodGhpcy51cmkgKyAnc2F2ZXNjaGVtYScsIHNjaGVtYSwge30sIHRoaXMuY3JlYXRlSGVhZGVyU2Vzc2lvbklkKCkpO1xyXG4gICAgcmV0dXJuIHJlc3VsdCQucGlwZShcclxuICAgICAgc3dpdGNoTWFwKCgpID0+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRTY2hlbWFMaXN0KHNjaGVtYS5xdWVyeUlkLCAnJywgb3JnYW5pemF0aW9uSWQpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yig6Zmk5pa55qGIXHJcbiAgICogQHBhcmFtIGlkIOaWueahiElEXHJcbiAgICogQHBhcmFtIHF1ZXJ5SWQg5p+l6K+i57yW5Y+3XHJcbiAgICovXHJcbiAgZGVsZXRlU2NoZW1hKGlkOiBzdHJpbmcsIHF1ZXJ5SWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBsZXQgb3JnYW5pemF0aW9uSWQgPSAnJztcclxuICAgIGlmICh0aGlzLmNhY2hlKSB7XHJcbiAgICAgIG9yZ2FuaXphdGlvbklkID0gdGhpcy5jYWNoZS5nZXQoUnRmU2VydmljZXMuZ2V0VGFiSWQocXVlcnlJZCkgKyAnb3JnYW5pemF0aW9uSWQnKSB8fCAnJztcclxuICAgIH1cclxuICAgIGNvbnN0IHJlc3VsdCQgPSB0aGlzLnJlc3RTZXJ2aWNlLmRlbGV0ZSh0aGlzLnVyaSArICdkZWxldGVzY2hlbWEnLCB7IGlkIH0sIHRoaXMuY3JlYXRlSGVhZGVyU2Vzc2lvbklkKCkpO1xyXG4gICAgcmV0dXJuIHJlc3VsdCQucGlwZShcclxuICAgICAgbWFwKChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgICBpZiAoZGF0YSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgY29uc3QgcmVzdWx0JDEgPSB0aGlzLmdldFNjaGVtYUxpc3QocXVlcnlJZCwgJycsIG9yZ2FuaXphdGlvbklkKTtcclxuICAgICAgICAgIHJldHVybiByZXN1bHQkMS5waXBlKFxyXG4gICAgICAgICAgICBtYXAodmFsdWUgPT4ge1xyXG4gICAgICAgICAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yig6Zmk5pa55qGIXHJcbiAgICogQHBhcmFtIGlkIOaWueahiElEXHJcbiAgICogQHBhcmFtIHF1ZXJ5SWQg5p+l6K+i57yW5Y+3XHJcbiAgICovXHJcbiAgZGVsZXRlU2NoZW1hTGlzdChpZHM6IGFueSwgcXVlcnlJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGxldCBvcmdhbml6YXRpb25JZCA9ICcnO1xyXG4gICAgaWYgKHRoaXMuY2FjaGUpIHtcclxuICAgICAgb3JnYW5pemF0aW9uSWQgPSB0aGlzLmNhY2hlLmdldChSdGZTZXJ2aWNlcy5nZXRUYWJJZChxdWVyeUlkKSArICdvcmdhbml6YXRpb25JZCcpIHx8ICcnO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcmVzdWx0JCA9IHRoaXMucmVzdFNlcnZpY2UuZGVsZXRlKHRoaXMudXJpICsgJ2RlbGV0ZXNjaGVtYWxpc3QnLCB7IGlkcyB9LCB0aGlzLmNyZWF0ZUhlYWRlclNlc3Npb25JZCgpKTtcclxuICAgIHJldHVybiByZXN1bHQkLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2NoZW1hTGlzdChxdWVyeUlkLCAnJywgb3JnYW5pemF0aW9uSWQpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlSGVhZGVyU2Vzc2lvbklkKCkge1xyXG4gICAgcmV0dXJuIFJ0ZlNlcnZpY2VzLmNyZWF0ZUhlYWRlclNlc3Npb25JZCh0aGlzLnNlc3Npb25TZXJ2aWNlKTtcclxuICB9XHJcblxyXG59XHJcbiJdfQ==