/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, Input, HostListener, ElementRef, Renderer2, Output, EventEmitter } from '@angular/core';
import { DndDraggableService } from '../services/dnd-draggable.service';
import { MSIE_MIME_TYPE, EDGE_MIME_TYPE, MIME_TYPE, ALL_EFFECTS } from '../dnd-constants';
export class DndListDirective {
    /**
     * @param {?} _el
     * @param {?} _renderer
     * @param {?} _dndService
     */
    constructor(_el, _renderer, _dndService) {
        this._el = _el;
        this._renderer = _renderer;
        this._dndService = _dndService;
        this.dndDisable = false;
        this.dndListChange = new EventEmitter();
        this.dndDragover = new EventEmitter();
        this.dndDrop = new EventEmitter();
        this.dndInserted = new EventEmitter();
        this._listSettings = {};
        this._dragOverStopped = false;
        this._counter = 0;
        this._nativeElement = this._el.nativeElement;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        /** @type {?} */
        const placeholder = this._getPlaceholderElement();
        placeholder.remove();
        this._placeholderNode = placeholder;
        this._listNode = this._nativeElement;
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onDragEnter(event) {
        this._counter++;
        this._dragOverStopped = false;
        event = event.originalEvent || event;
        this._listSettings = {
            allowedTypes: Array.isArray(this.dndAllowedTypes) && this.dndAllowedTypes.join('|').toLowerCase().split('|'),
            disabled: this.dndDisable,
            externalSources: this.dndExternalSources,
            horizontal: this.dndHorizontalList
        };
        /** @type {?} */
        const mimeType = this._getMimeType(event.dataTransfer.types);
        if (!mimeType || !this._isDropAllowed(this._getItemType(mimeType))) {
            return true;
        }
        event.preventDefault();
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onDragOver(event) {
        event = event.originalEvent || event;
        // Check whether the drop is allowed and determine mime type.
        /** @type {?} */
        const mimeType = this._getMimeType(event.dataTransfer.types);
        /** @type {?} */
        const itemType = this._getItemType(mimeType);
        if (!mimeType || !this._isDropAllowed(itemType)) {
            return true;
        }
        // Make sure the placeholder is shown, which is especially important if the list is empty.
        if (this._placeholderNode.parentNode !== this._listNode) {
            this._renderer.appendChild(this._nativeElement, this._placeholderNode);
        }
        if (event.target !== this._listNode) {
            // Try to find the node direct directly below the list node.
            /** @type {?} */
            let listItemNode = event.target;
            while (listItemNode.parentNode !== this._listNode && listItemNode.parentNode) {
                listItemNode = listItemNode.parentNode;
            }
            if (listItemNode.parentNode === this._listNode && listItemNode !== this._placeholderNode) {
                // If the mouse pointer is in the upper half of the list item element,
                // we position the placeholder before the list item, otherwise after it.
                /** @type {?} */
                const rect = listItemNode.getBoundingClientRect();
                /** @type {?} */
                let isFirstHalf;
                if (this._listSettings.horizontal) {
                    isFirstHalf = event.clientX < rect.left + rect.width / 2;
                }
                else {
                    isFirstHalf = event.clientY < rect.top + rect.height / 2;
                }
                this._listNode.insertBefore(this._placeholderNode, isFirstHalf ? listItemNode : listItemNode.nextSibling);
            }
        }
        // In IE we set a fake effectAllowed in dragstart to get the correct cursor, we therefore
        // ignore the effectAllowed passed in dataTransfer. We must also not access dataTransfer for
        // drops from external sources, as that throws an exception.
        /** @type {?} */
        const ignoreDataTransfer = mimeType === MSIE_MIME_TYPE;
        /** @type {?} */
        const dropEffect = this._getDropEffect(event, ignoreDataTransfer);
        if (dropEffect === 'none') {
            return this._stopDragover();
        }
        // At this point we invoke the callback, which still can disallow the drop.
        // We can't do this earlier because we want to pass the index of the placeholder.
        this.dndDragover.emit(this._getEventResponse(event, dropEffect, itemType));
        if (this._dragOverStopped) {
            return this._stopDragover();
        }
        // Set dropEffect to modify the cursor shown by the browser, unless we're in IE, where this
        // is not supported. This must be done after preventDefault in Firefox.
        event.preventDefault();
        if (!ignoreDataTransfer) {
            event.dataTransfer.dropEffect = dropEffect;
        }
        this._renderer.addClass(this._nativeElement, 'dndDragover');
        event.stopPropagation();
        return false;
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onDrop(event) {
        this._counter = 0;
        event = event.originalEvent || event;
        // Check whether the drop is allowed and determine mime type.
        /** @type {?} */
        const mimeType = this._getMimeType(event.dataTransfer.types);
        /** @type {?} */
        let itemType = this._getItemType(mimeType);
        if (!mimeType || !this._isDropAllowed(itemType)) {
            return true;
        }
        // The default behavior in Firefox is to interpret the dropped element as URL and
        // forward to it. We want to prevent that even if our drop is aborted.
        event.preventDefault();
        // Unserialize the data that was serialized in dragstart.
        /** @type {?} */
        let data;
        try {
            data = JSON.parse(event.dataTransfer.getData(mimeType));
        }
        catch (e) {
            return this._stopDragover();
        }
        // Drops with invalid types from external sources might not have been filtered out yet.
        if (mimeType === MSIE_MIME_TYPE || mimeType === EDGE_MIME_TYPE) {
            itemType = data.type || undefined;
            data = data.item;
            if (!this._isDropAllowed(itemType)) {
                return this._stopDragover();
            }
        }
        // Special handling for internal IE drops, see dragover handler.
        /** @type {?} */
        const ignoreDataTransfer = mimeType === MSIE_MIME_TYPE;
        /** @type {?} */
        const dropEffect = this._getDropEffect(event, ignoreDataTransfer);
        if (dropEffect === 'none') {
            return this._stopDragover();
        }
        // Invoke the callback, which can transform the transferredObject and even abort the drop.
        /** @type {?} */
        const index = this._getPlaceholderIndex();
        this.dndDrop.emit(this._getEventResponse(event, dropEffect, itemType, index, data));
        if (this._dragOverStopped) {
            return this._stopDragover();
        }
        // The drop is definitely going to happen now, store the dropEffect.
        this._dndService.setDropEffect(dropEffect);
        if (!ignoreDataTransfer) {
            event.dataTransfer.dropEffect = dropEffect;
        }
        if (this.dndList) {
            // Creates a new array adding the object into the array position without mutate the original.
            /** @type {?} */
            const newList = [...this.dndList.slice(0, index), data, ...this.dndList.slice(index)];
            this.dndListChange.emit(newList);
        }
        this._dndService.setRemoveOnDrop(true);
        // this._dndService.dropEndSource()
        this.dndInserted.emit(this._getEventResponse(event, dropEffect, itemType, index, data));
        // Clean up
        this._stopDragover();
        event.stopPropagation();
        return false;
    }
    /**
     * We have to remove the placeholder when the element is no longer dragged over our list. The
     * problem is that the dragleave event is not only fired when the element leaves our list,
     * but also when it leaves a child element. Therefore, we determine whether the mouse cursor
     * is still pointing to an element inside the list or not.
     * @param {?} event
     * @return {?}
     */
    onDragLeave(event) {
        this._counter--;
        event = event.originalEvent || event;
        if (this._counter !== 0) {
            // Signalize to potential parent lists that a placeholder is already shown.
            event._dndPhShown = true;
        }
        else {
            this._stopDragover();
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onmouseout(event) {
        if (this._dndService.getDraggingState()) {
            this._stopDragover();
        }
    }
    /**
     * @private
     * @return {?}
     */
    _stopDrag() {
        this._dragOverStopped = true;
    }
    /**
     * @private
     * @return {?}
     */
    _stopDragover() {
        this._placeholderNode.remove();
        this._renderer.removeClass(this._nativeElement, 'dndDragover');
        return true;
    }
    /**
     * Create a DndListEvent instance for events response.
     * @private
     * @param {?} event
     * @param {?} dropEffect
     * @param {?} itemType
     * @param {?=} index
     * @param {?=} item
     * @return {?}
     */
    _getEventResponse(event, dropEffect, itemType, index, item) {
        return {
            callback: this._dndService.getDropCallback(),
            dropEffect: dropEffect,
            event: event,
            external: !this._dndService.getDraggingState(),
            index: index !== undefined ? index : this._getPlaceholderIndex(),
            item: item || undefined,
            stopDragover: this._stopDrag.bind(this),
            type: itemType
        };
    }
    /**
     * @private
     * @return {?}
     */
    _getPlaceholderIndex() {
        return Array.prototype.indexOf.call(this._nativeElement.children, this._placeholderNode);
    }
    /**
     * @private
     * @return {?}
     */
    _getPlaceholderElement() {
        /** @type {?} */
        let placeholder = [].slice.call(this._nativeElement.children).filter((/**
         * @param {?} childNode
         * @return {?}
         */
        (childNode) => {
            return childNode.className.indexOf('dndPlaceholder') > -1;
        }));
        if (placeholder.length) {
            return placeholder;
        }
        placeholder = this._renderer.createElement('li');
        this._renderer.addClass(placeholder, 'dndPlaceholder');
        return placeholder;
    }
    /**
     * @private
     * @param {?} types
     * @return {?}
     */
    _getMimeType(types) {
        if (!types) {
            return MSIE_MIME_TYPE; // IE 9 workaround.
        }
        for (let i = 0; i < types.length; i++) {
            if (types[i] === MSIE_MIME_TYPE || types[i] === EDGE_MIME_TYPE ||
                types[i].substr(0, MIME_TYPE.length) === MIME_TYPE) {
                return types[i];
            }
        }
        return null;
    }
    /**
     * Determines the type of the item from the dndService, or from the mime type for items from
     * external sources. Returns undefined if no item type was set and null if the item type could
     * not be determined.
     * @private
     * @param {?} mimeType
     * @return {?}
     */
    _getItemType(mimeType) {
        if (this._dndService.getDraggingState()) {
            return this._dndService.getItemType() || undefined;
        }
        if (mimeType === MSIE_MIME_TYPE || mimeType === EDGE_MIME_TYPE) {
            return null;
        }
        return (mimeType && mimeType.substr(MIME_TYPE.length + 1)) || undefined;
    }
    /**
     * @private
     * @param {?} itemType
     * @return {?}
     */
    _isDropAllowed(itemType) {
        if (this._listSettings.disabled) {
            return false;
        }
        if (!this._listSettings.externalSources && !this._dndService.getDraggingState()) {
            return false;
        }
        if (!this._listSettings.allowedTypes || itemType === null) {
            return true;
        }
        return itemType && this._listSettings.allowedTypes.indexOf(itemType) !== -1;
    }
    /**
     * Determines which drop effect to use for the given event. In Internet Explorer we have to
     * ignore the effectAllowed field on dataTransfer, since we set a fake value in dragstart.
     * In those cases we rely on dndState to filter effects. Read the design doc for more details:
     * https://github.com/marceljuenemann/angular-drag-and-drop-lists/wiki/Data-Transfer-Design
     * @private
     * @param {?} event
     * @param {?} ignoreDataTransfer
     * @return {?}
     */
    _getDropEffect(event, ignoreDataTransfer) {
        /** @type {?} */
        let effects = ALL_EFFECTS;
        if (!ignoreDataTransfer) {
            effects = this._filterEffects(effects, event.dataTransfer.effectAllowed);
        }
        if (this._dndService.getDraggingState()) {
            effects = this._filterEffects(effects, this._dndService.getEffectAllowed());
        }
        if (this.dndEffectAllowed) {
            effects = this._filterEffects(effects, this.dndEffectAllowed);
        }
        // MacOS automatically filters dataTransfer.effectAllowed depending on the modifier keys,
        // therefore the following modifier keys will only affect other operating systems.
        if (!effects.length) {
            return 'none';
        }
        else if (event.ctrlKey && effects.indexOf('copy') !== -1) {
            return 'copy';
        }
        else if (event.altKey && effects.indexOf('link') !== -1) {
            return 'link';
        }
        else {
            return effects[0];
        }
    }
    /**
     * Filters an array of drop effects using a HTML5 effectAllowed string.
     * @private
     * @param {?} effects
     * @param {?} effectAllowed
     * @return {?}
     */
    _filterEffects(effects, effectAllowed) {
        if (effectAllowed === 'all') {
            return effects;
        }
        return effects.filter((/**
         * @param {?} effect
         * @return {?}
         */
        function (effect) {
            return effectAllowed.toLowerCase().indexOf(effect) !== -1;
        }));
    }
}
DndListDirective.decorators = [
    { type: Directive, args: [{
                selector: '[dndList]',
            },] }
];
/** @nocollapse */
DndListDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: DndDraggableService }
];
DndListDirective.propDecorators = {
    dndDisable: [{ type: Input }],
    dndAllowedTypes: [{ type: Input }],
    dndExternalSources: [{ type: Input }],
    dndHorizontalList: [{ type: Input }],
    dndEffectAllowed: [{ type: Input }],
    pureComponent: [{ type: Input }],
    dndList: [{ type: Input }],
    dndListChange: [{ type: Output }],
    dndDragover: [{ type: Output }],
    dndDrop: [{ type: Output }],
    dndInserted: [{ type: Output }],
    onDragEnter: [{ type: HostListener, args: ['dragenter', ['$event'],] }],
    onDragOver: [{ type: HostListener, args: ['dragover', ['$event'],] }],
    onDrop: [{ type: HostListener, args: ['drop', ['$event'],] }],
    onDragLeave: [{ type: HostListener, args: ['dragleave', ['$event'],] }],
    onmouseout: [{ type: HostListener, args: ['mouseleave', ['$event'],] }]
};
if (false) {
    /** @type {?} */
    DndListDirective.prototype.dndDisable;
    /** @type {?} */
    DndListDirective.prototype.dndAllowedTypes;
    /** @type {?} */
    DndListDirective.prototype.dndExternalSources;
    /** @type {?} */
    DndListDirective.prototype.dndHorizontalList;
    /** @type {?} */
    DndListDirective.prototype.dndEffectAllowed;
    /** @type {?} */
    DndListDirective.prototype.pureComponent;
    /** @type {?} */
    DndListDirective.prototype.dndList;
    /** @type {?} */
    DndListDirective.prototype.dndListChange;
    /** @type {?} */
    DndListDirective.prototype.dndDragover;
    /** @type {?} */
    DndListDirective.prototype.dndDrop;
    /** @type {?} */
    DndListDirective.prototype.dndInserted;
    /**
     * @type {?}
     * @private
     */
    DndListDirective.prototype._nativeElement;
    /**
     * @type {?}
     * @private
     */
    DndListDirective.prototype._placeholderNode;
    /**
     * @type {?}
     * @private
     */
    DndListDirective.prototype._listSettings;
    /**
     * @type {?}
     * @private
     */
    DndListDirective.prototype._listNode;
    /**
     * @type {?}
     * @private
     */
    DndListDirective.prototype._dragOverStopped;
    /**
     * @type {?}
     * @private
     */
    DndListDirective.prototype._counter;
    /**
     * @type {?}
     * @private
     */
    DndListDirective.prototype._el;
    /**
     * @type {?}
     * @private
     */
    DndListDirective.prototype._renderer;
    /**
     * @type {?}
     * @private
     */
    DndListDirective.prototype._dndService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG5kLWxpc3QuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHFkcC9jb21tb24vIiwic291cmNlcyI6WyJsaWIvZG5kLWxpc3QvZGlyZWN0aXZlcy9kbmQtbGlzdC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFDSixTQUFTLEVBR1QsS0FBSyxFQUNMLFlBQVksRUFDWixVQUFVLEVBQ1YsU0FBUyxFQUVULE1BQU0sRUFDTixZQUFZLEVBQ2QsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFDeEUsT0FBTyxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBTTFGLE1BQU0sT0FBTyxnQkFBZ0I7Ozs7OztJQXdCMUIsWUFBb0IsR0FBZSxFQUFVLFNBQW9CLEVBQVUsV0FBZ0M7UUFBdkYsUUFBRyxHQUFILEdBQUcsQ0FBWTtRQUFVLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBcUI7UUF2QmxHLGVBQVUsR0FBRyxLQUFLLENBQUM7UUFRbEIsa0JBQWEsR0FBRyxJQUFJLFlBQVksRUFBTyxDQUFDO1FBRXhDLGdCQUFXLEdBQUcsSUFBSSxZQUFZLEVBQWdCLENBQUM7UUFDL0MsWUFBTyxHQUFHLElBQUksWUFBWSxFQUFnQixDQUFDO1FBQzNDLGdCQUFXLEdBQUcsSUFBSSxZQUFZLEVBQWdCLENBQUM7UUFLakQsa0JBQWEsR0FBUSxFQUFFLENBQUM7UUFFeEIscUJBQWdCLEdBQUcsS0FBSyxDQUFDO1FBRXpCLGFBQVEsR0FBRyxDQUFDLENBQUM7UUFHbEIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQztJQUNoRCxDQUFDOzs7O0lBRUQsUUFBUTs7Y0FDQyxXQUFXLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixFQUFFO1FBQ2pELFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsV0FBVyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUN4QyxDQUFDOzs7OztJQUdELFdBQVcsQ0FBQyxLQUFLO1FBQ2QsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxLQUFLLENBQUM7UUFDOUIsS0FBSyxHQUFHLEtBQUssQ0FBQyxhQUFhLElBQUksS0FBSyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxhQUFhLEdBQUc7WUFDbEIsWUFBWSxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7WUFDNUcsUUFBUSxFQUFFLElBQUksQ0FBQyxVQUFVO1lBQ3pCLGVBQWUsRUFBRSxJQUFJLENBQUMsa0JBQWtCO1lBQ3hDLFVBQVUsRUFBRSxJQUFJLENBQUMsaUJBQWlCO1NBQ3BDLENBQUM7O2NBQ0ksUUFBUSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUM7UUFDNUQsSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFO1lBQ2pFLE9BQU8sSUFBSSxDQUFDO1NBQ2Q7UUFDRCxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDMUIsQ0FBQzs7Ozs7SUFHRCxVQUFVLENBQUMsS0FBSztRQUNiLEtBQUssR0FBRyxLQUFLLENBQUMsYUFBYSxJQUFJLEtBQUssQ0FBQzs7O2NBRS9CLFFBQVEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDOztjQUN0RCxRQUFRLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUM7UUFDNUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDOUMsT0FBTyxJQUFJLENBQUM7U0FDZDtRQUNELDBGQUEwRjtRQUMxRixJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEtBQUssSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUN0RCxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1NBQ3pFO1FBRUQsSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLElBQUksQ0FBQyxTQUFTLEVBQUU7OztnQkFFOUIsWUFBWSxHQUFHLEtBQUssQ0FBQyxNQUFNO1lBQy9CLE9BQU8sWUFBWSxDQUFDLFVBQVUsS0FBSyxJQUFJLENBQUMsU0FBUyxJQUFJLFlBQVksQ0FBQyxVQUFVLEVBQUU7Z0JBQzNFLFlBQVksR0FBRyxZQUFZLENBQUMsVUFBVSxDQUFDO2FBQ3pDO1lBRUQsSUFBSSxZQUFZLENBQUMsVUFBVSxLQUFLLElBQUksQ0FBQyxTQUFTLElBQUksWUFBWSxLQUFLLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTs7OztzQkFHakYsSUFBSSxHQUFHLFlBQVksQ0FBQyxxQkFBcUIsRUFBRTs7b0JBQzdDLFdBQVc7Z0JBQ2YsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsRUFBRTtvQkFDaEMsV0FBVyxHQUFHLEtBQUssQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztpQkFDM0Q7cUJBQU07b0JBQ0osV0FBVyxHQUFHLEtBQUssQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztpQkFDM0Q7Z0JBQ0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUM5QyxXQUFXLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2FBQzVEO1NBQ0g7Ozs7O2NBS0ssa0JBQWtCLEdBQUcsUUFBUSxLQUFLLGNBQWM7O2NBQ2hELFVBQVUsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxrQkFBa0IsQ0FBQztRQUVqRSxJQUFJLFVBQVUsS0FBSyxNQUFNLEVBQUU7WUFDeEIsT0FBTyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7U0FDOUI7UUFDRCwyRUFBMkU7UUFDM0UsaUZBQWlGO1FBRWpGLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDM0UsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDeEIsT0FBTyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7U0FDOUI7UUFFRCwyRkFBMkY7UUFDM0YsdUVBQXVFO1FBQ3ZFLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsa0JBQWtCLEVBQUU7WUFDdEIsS0FBSyxDQUFDLFlBQVksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1NBQzdDO1FBRUQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUM1RCxLQUFLLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDeEIsT0FBTyxLQUFLLENBQUM7SUFDaEIsQ0FBQzs7Ozs7SUFHRCxNQUFNLENBQUMsS0FBSztRQUNULElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ2xCLEtBQUssR0FBRyxLQUFLLENBQUMsYUFBYSxJQUFJLEtBQUssQ0FBQzs7O2NBRS9CLFFBQVEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDOztZQUN4RCxRQUFRLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUM7UUFDMUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDOUMsT0FBTyxJQUFJLENBQUM7U0FDZDtRQUNELGlGQUFpRjtRQUNqRixzRUFBc0U7UUFDdEUsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDOzs7WUFHbkIsSUFBSTtRQUNSLElBQUk7WUFDRCxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1NBQzFEO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVCxPQUFPLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUM5QjtRQUVELHVGQUF1RjtRQUN2RixJQUFJLFFBQVEsS0FBSyxjQUFjLElBQUksUUFBUSxLQUFLLGNBQWMsRUFBRTtZQUM3RCxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksSUFBSSxTQUFTLENBQUM7WUFDbEMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLEVBQUU7Z0JBQ2pDLE9BQU8sSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO2FBQzlCO1NBQ0g7OztjQUdLLGtCQUFrQixHQUFHLFFBQVEsS0FBSyxjQUFjOztjQUNoRCxVQUFVLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsa0JBQWtCLENBQUM7UUFDakUsSUFBSSxVQUFVLEtBQUssTUFBTSxFQUFFO1lBQ3hCLE9BQU8sSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1NBQzlCOzs7Y0FFSyxLQUFLLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixFQUFFO1FBQ3pDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNwRixJQUFJLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtZQUN4QixPQUFPLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUM5QjtRQUVELG9FQUFvRTtRQUNwRSxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUMzQyxJQUFJLENBQUMsa0JBQWtCLEVBQUU7WUFDdEIsS0FBSyxDQUFDLFlBQVksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1NBQzdDO1FBRUQsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFOzs7a0JBRVQsT0FBTyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLEVBQUUsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDckYsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDbkM7UUFFRCxJQUFJLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2QyxtQ0FBbUM7UUFFbkMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRXhGLFdBQVc7UUFDWCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDckIsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ3hCLE9BQU8sS0FBSyxDQUFDO0lBQ2hCLENBQUM7Ozs7Ozs7OztJQVNELFdBQVcsQ0FBQyxLQUFLO1FBQ2QsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2hCLEtBQUssR0FBRyxLQUFLLENBQUMsYUFBYSxJQUFJLEtBQUssQ0FBQztRQUNyQyxJQUFJLElBQUksQ0FBQyxRQUFRLEtBQUssQ0FBQyxFQUFFO1lBQ3RCLDJFQUEyRTtZQUMzRSxLQUFLLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztTQUMzQjthQUFNO1lBQ0osSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1NBQ3ZCO0lBQ0osQ0FBQzs7Ozs7SUFHRCxVQUFVLENBQUMsS0FBSztRQUNiLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFO1lBQ3RDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUN2QjtJQUNKLENBQUM7Ozs7O0lBRU8sU0FBUztRQUNkLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7SUFDaEMsQ0FBQzs7Ozs7SUFFTyxhQUFhO1FBQ2xCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBQy9ELE9BQU8sSUFBSSxDQUFDO0lBQ2YsQ0FBQzs7Ozs7Ozs7Ozs7SUFNTyxpQkFBaUIsQ0FBQyxLQUFnQixFQUFFLFVBQWtCLEVBQUUsUUFBZ0IsRUFBRSxLQUFjLEVBQUUsSUFBSztRQUNwRyxPQUFPO1lBQ0osUUFBUSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsZUFBZSxFQUFFO1lBQzVDLFVBQVUsRUFBRSxVQUFVO1lBQ3RCLEtBQUssRUFBRSxLQUFLO1lBQ1osUUFBUSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRTtZQUM5QyxLQUFLLEVBQUUsS0FBSyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUU7WUFDaEUsSUFBSSxFQUFFLElBQUksSUFBSSxTQUFTO1lBQ3ZCLFlBQVksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDdkMsSUFBSSxFQUFFLFFBQVE7U0FDaEIsQ0FBQztJQUNMLENBQUM7Ozs7O0lBRU8sb0JBQW9CO1FBQ3pCLE9BQU8sS0FBSyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQzVGLENBQUM7Ozs7O0lBRU8sc0JBQXNCOztZQUN2QixXQUFXLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNOzs7O1FBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRTtZQUNoRixPQUFPLFNBQVMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDN0QsQ0FBQyxFQUFDO1FBQ0YsSUFBSSxXQUFXLENBQUMsTUFBTSxFQUFFO1lBQ3JCLE9BQU8sV0FBVyxDQUFDO1NBQ3JCO1FBQ0QsV0FBVyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pELElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3ZELE9BQU8sV0FBVyxDQUFDO0lBQ3RCLENBQUM7Ozs7OztJQUVPLFlBQVksQ0FBQyxLQUFLO1FBQ3ZCLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDVCxPQUFPLGNBQWMsQ0FBQyxDQUFDLG1CQUFtQjtTQUM1QztRQUNELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ3BDLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLGNBQWMsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssY0FBYztnQkFDM0QsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsU0FBUyxDQUFDLE1BQU0sQ0FBQyxLQUFLLFNBQVMsRUFBRTtnQkFDcEQsT0FBTyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDbEI7U0FDSDtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2YsQ0FBQzs7Ozs7Ozs7O0lBT08sWUFBWSxDQUFDLFFBQVE7UUFDMUIsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixFQUFFLEVBQUU7WUFDdEMsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSxJQUFJLFNBQVMsQ0FBQztTQUNyRDtRQUNELElBQUksUUFBUSxLQUFLLGNBQWMsSUFBSSxRQUFRLEtBQUssY0FBYyxFQUFFO1lBQzdELE9BQU8sSUFBSSxDQUFDO1NBQ2Q7UUFDRCxPQUFPLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLFNBQVMsQ0FBQztJQUMzRSxDQUFDOzs7Ozs7SUFFTyxjQUFjLENBQUMsUUFBUTtRQUM1QixJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFO1lBQzlCLE9BQU8sS0FBSyxDQUFDO1NBQ2Y7UUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixFQUFFLEVBQUU7WUFDOUUsT0FBTyxLQUFLLENBQUM7U0FDZjtRQUNELElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksSUFBSSxRQUFRLEtBQUssSUFBSSxFQUFFO1lBQ3hELE9BQU8sSUFBSSxDQUFDO1NBQ2Q7UUFDRCxPQUFPLFFBQVEsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDL0UsQ0FBQzs7Ozs7Ozs7Ozs7SUFRTyxjQUFjLENBQUMsS0FBSyxFQUFFLGtCQUFrQjs7WUFDekMsT0FBTyxHQUFHLFdBQVc7UUFDekIsSUFBSSxDQUFDLGtCQUFrQixFQUFFO1lBQ3RCLE9BQU8sR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQzNFO1FBQ0QsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixFQUFFLEVBQUU7WUFDdEMsT0FBTyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO1NBQzlFO1FBQ0QsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDeEIsT0FBTyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1NBQ2hFO1FBQ0QseUZBQXlGO1FBQ3pGLGtGQUFrRjtRQUNsRixJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUNsQixPQUFPLE1BQU0sQ0FBQztTQUNoQjthQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO1lBQ3pELE9BQU8sTUFBTSxDQUFDO1NBQ2hCO2FBQU0sSUFBSSxLQUFLLENBQUMsTUFBTSxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDeEQsT0FBTyxNQUFNLENBQUM7U0FDaEI7YUFBTTtZQUNKLE9BQU8sT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3BCO0lBQ0osQ0FBQzs7Ozs7Ozs7SUFLTyxjQUFjLENBQUMsT0FBTyxFQUFFLGFBQWE7UUFDMUMsSUFBSSxhQUFhLEtBQUssS0FBSyxFQUFFO1lBQzFCLE9BQU8sT0FBTyxDQUFDO1NBQ2pCO1FBQ0QsT0FBTyxPQUFPLENBQUMsTUFBTTs7OztRQUFDLFVBQVUsTUFBTTtZQUNuQyxPQUFPLGFBQWEsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDN0QsQ0FBQyxFQUFDLENBQUM7SUFDTixDQUFDOzs7WUFqVkgsU0FBUyxTQUFDO2dCQUNSLFFBQVEsRUFBRSxXQUFXO2FBQ3ZCOzs7O1lBWkUsVUFBVTtZQUNWLFNBQVM7WUFLSCxtQkFBbUI7Ozt5QkFReEIsS0FBSzs4QkFDTCxLQUFLO2lDQUNMLEtBQUs7Z0NBQ0wsS0FBSzsrQkFDTCxLQUFLOzRCQUNMLEtBQUs7c0JBQ0wsS0FBSzs0QkFFTCxNQUFNOzBCQUVOLE1BQU07c0JBQ04sTUFBTTswQkFDTixNQUFNOzBCQXNCTixZQUFZLFNBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDO3lCQWtCcEMsWUFBWSxTQUFDLFVBQVUsRUFBRSxDQUFDLFFBQVEsQ0FBQztxQkFpRW5DLFlBQVksU0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUM7MEJBeUUvQixZQUFZLFNBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDO3lCQVlwQyxZQUFZLFNBQUMsWUFBWSxFQUFFLENBQUMsUUFBUSxDQUFDOzs7O0lBMU10QyxzQ0FBNEI7O0lBQzVCLDJDQUFtQzs7SUFDbkMsOENBQWlDOztJQUNqQyw2Q0FBZ0M7O0lBQ2hDLDRDQUFrQzs7SUFDbEMseUNBQWdDOztJQUNoQyxtQ0FBc0I7O0lBRXRCLHlDQUFrRDs7SUFFbEQsdUNBQXlEOztJQUN6RCxtQ0FBcUQ7O0lBQ3JELHVDQUF5RDs7Ozs7SUFFekQsMENBQWdDOzs7OztJQUNoQyw0Q0FBa0M7Ozs7O0lBRWxDLHlDQUFnQzs7Ozs7SUFDaEMscUNBQXVCOzs7OztJQUN2Qiw0Q0FBaUM7Ozs7O0lBRWpDLG9DQUFxQjs7Ozs7SUFFVCwrQkFBdUI7Ozs7O0lBQUUscUNBQTRCOzs7OztJQUFFLHVDQUF3QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgIERpcmVjdGl2ZSxcclxuICAgSG9zdEJpbmRpbmcsXHJcbiAgIE9uQ2hhbmdlcyxcclxuICAgSW5wdXQsXHJcbiAgIEhvc3RMaXN0ZW5lcixcclxuICAgRWxlbWVudFJlZixcclxuICAgUmVuZGVyZXIyLFxyXG4gICBPbkluaXQsXHJcbiAgIE91dHB1dCxcclxuICAgRXZlbnRFbWl0dGVyXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IERuZERyYWdnYWJsZVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9kbmQtZHJhZ2dhYmxlLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBNU0lFX01JTUVfVFlQRSwgRURHRV9NSU1FX1RZUEUsIE1JTUVfVFlQRSwgQUxMX0VGRkVDVFMgfSBmcm9tICcuLi9kbmQtY29uc3RhbnRzJztcclxuaW1wb3J0IHsgRG5kTGlzdEV2ZW50IH0gZnJvbSAnLi4vbW9kZWxzL2V2ZW50cyc7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICAgc2VsZWN0b3I6ICdbZG5kTGlzdF0nLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgRG5kTGlzdERpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcbiAgIEBJbnB1dCgpIGRuZERpc2FibGUgPSBmYWxzZTtcclxuICAgQElucHV0KCkgZG5kQWxsb3dlZFR5cGVzOiBTdHJpbmdbXTtcclxuICAgQElucHV0KCkgZG5kRXh0ZXJuYWxTb3VyY2VzOiBhbnk7XHJcbiAgIEBJbnB1dCgpIGRuZEhvcml6b250YWxMaXN0OiBhbnk7XHJcbiAgIEBJbnB1dCgpIGRuZEVmZmVjdEFsbG93ZWQ6IHN0cmluZztcclxuICAgQElucHV0KCkgcHVyZUNvbXBvbmVudDogYm9vbGVhbjtcclxuICAgQElucHV0KCkgZG5kTGlzdDogYW55O1xyXG5cclxuICAgQE91dHB1dCgpIGRuZExpc3RDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuXHJcbiAgIEBPdXRwdXQoKSBkbmREcmFnb3ZlciA9IG5ldyBFdmVudEVtaXR0ZXI8RG5kTGlzdEV2ZW50PigpO1xyXG4gICBAT3V0cHV0KCkgZG5kRHJvcCA9IG5ldyBFdmVudEVtaXR0ZXI8RG5kTGlzdEV2ZW50PigpO1xyXG4gICBAT3V0cHV0KCkgZG5kSW5zZXJ0ZWQgPSBuZXcgRXZlbnRFbWl0dGVyPERuZExpc3RFdmVudD4oKTtcclxuXHJcbiAgIHByaXZhdGUgX25hdGl2ZUVsZW1lbnQ6IEVsZW1lbnQ7XHJcbiAgIHByaXZhdGUgX3BsYWNlaG9sZGVyTm9kZTogRWxlbWVudDtcclxuXHJcbiAgIHByaXZhdGUgX2xpc3RTZXR0aW5nczogYW55ID0ge307XHJcbiAgIHByaXZhdGUgX2xpc3ROb2RlOiBhbnk7XHJcbiAgIHByaXZhdGUgX2RyYWdPdmVyU3RvcHBlZCA9IGZhbHNlO1xyXG5cclxuICAgcHJpdmF0ZSBfY291bnRlciA9IDA7XHJcblxyXG4gICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9lbDogRWxlbWVudFJlZiwgcHJpdmF0ZSBfcmVuZGVyZXI6IFJlbmRlcmVyMiwgcHJpdmF0ZSBfZG5kU2VydmljZTogRG5kRHJhZ2dhYmxlU2VydmljZSkge1xyXG4gICAgICB0aGlzLl9uYXRpdmVFbGVtZW50ID0gdGhpcy5fZWwubmF0aXZlRWxlbWVudDtcclxuICAgfVxyXG5cclxuICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgIGNvbnN0IHBsYWNlaG9sZGVyID0gdGhpcy5fZ2V0UGxhY2Vob2xkZXJFbGVtZW50KCk7XHJcbiAgICAgIHBsYWNlaG9sZGVyLnJlbW92ZSgpO1xyXG4gICAgICB0aGlzLl9wbGFjZWhvbGRlck5vZGUgPSBwbGFjZWhvbGRlcjtcclxuICAgICAgdGhpcy5fbGlzdE5vZGUgPSB0aGlzLl9uYXRpdmVFbGVtZW50O1xyXG4gICB9XHJcblxyXG4gICBASG9zdExpc3RlbmVyKCdkcmFnZW50ZXInLCBbJyRldmVudCddKVxyXG4gICBvbkRyYWdFbnRlcihldmVudCkge1xyXG4gICAgICB0aGlzLl9jb3VudGVyKys7XHJcbiAgICAgIHRoaXMuX2RyYWdPdmVyU3RvcHBlZCA9IGZhbHNlO1xyXG4gICAgICBldmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQgfHwgZXZlbnQ7XHJcbiAgICAgIHRoaXMuX2xpc3RTZXR0aW5ncyA9IHtcclxuICAgICAgICAgYWxsb3dlZFR5cGVzOiBBcnJheS5pc0FycmF5KHRoaXMuZG5kQWxsb3dlZFR5cGVzKSAmJiB0aGlzLmRuZEFsbG93ZWRUeXBlcy5qb2luKCd8JykudG9Mb3dlckNhc2UoKS5zcGxpdCgnfCcpLFxyXG4gICAgICAgICBkaXNhYmxlZDogdGhpcy5kbmREaXNhYmxlLFxyXG4gICAgICAgICBleHRlcm5hbFNvdXJjZXM6IHRoaXMuZG5kRXh0ZXJuYWxTb3VyY2VzLFxyXG4gICAgICAgICBob3Jpem9udGFsOiB0aGlzLmRuZEhvcml6b250YWxMaXN0XHJcbiAgICAgIH07XHJcbiAgICAgIGNvbnN0IG1pbWVUeXBlID0gdGhpcy5fZ2V0TWltZVR5cGUoZXZlbnQuZGF0YVRyYW5zZmVyLnR5cGVzKTtcclxuICAgICAgaWYgKCFtaW1lVHlwZSB8fCAhdGhpcy5faXNEcm9wQWxsb3dlZCh0aGlzLl9nZXRJdGVtVHlwZShtaW1lVHlwZSkpKSB7XHJcbiAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9XHJcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgIH1cclxuXHJcbiAgIEBIb3N0TGlzdGVuZXIoJ2RyYWdvdmVyJywgWyckZXZlbnQnXSlcclxuICAgb25EcmFnT3ZlcihldmVudCkge1xyXG4gICAgICBldmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQgfHwgZXZlbnQ7XHJcbiAgICAgIC8vIENoZWNrIHdoZXRoZXIgdGhlIGRyb3AgaXMgYWxsb3dlZCBhbmQgZGV0ZXJtaW5lIG1pbWUgdHlwZS5cclxuICAgICAgY29uc3QgbWltZVR5cGUgPSB0aGlzLl9nZXRNaW1lVHlwZShldmVudC5kYXRhVHJhbnNmZXIudHlwZXMpO1xyXG4gICAgICBjb25zdCBpdGVtVHlwZSA9IHRoaXMuX2dldEl0ZW1UeXBlKG1pbWVUeXBlKTtcclxuICAgICAgaWYgKCFtaW1lVHlwZSB8fCAhdGhpcy5faXNEcm9wQWxsb3dlZChpdGVtVHlwZSkpIHtcclxuICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgICAgLy8gTWFrZSBzdXJlIHRoZSBwbGFjZWhvbGRlciBpcyBzaG93biwgd2hpY2ggaXMgZXNwZWNpYWxseSBpbXBvcnRhbnQgaWYgdGhlIGxpc3QgaXMgZW1wdHkuXHJcbiAgICAgIGlmICh0aGlzLl9wbGFjZWhvbGRlck5vZGUucGFyZW50Tm9kZSAhPT0gdGhpcy5fbGlzdE5vZGUpIHtcclxuICAgICAgICAgdGhpcy5fcmVuZGVyZXIuYXBwZW5kQ2hpbGQodGhpcy5fbmF0aXZlRWxlbWVudCwgdGhpcy5fcGxhY2Vob2xkZXJOb2RlKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKGV2ZW50LnRhcmdldCAhPT0gdGhpcy5fbGlzdE5vZGUpIHtcclxuICAgICAgICAgLy8gVHJ5IHRvIGZpbmQgdGhlIG5vZGUgZGlyZWN0IGRpcmVjdGx5IGJlbG93IHRoZSBsaXN0IG5vZGUuXHJcbiAgICAgICAgIGxldCBsaXN0SXRlbU5vZGUgPSBldmVudC50YXJnZXQ7XHJcbiAgICAgICAgIHdoaWxlIChsaXN0SXRlbU5vZGUucGFyZW50Tm9kZSAhPT0gdGhpcy5fbGlzdE5vZGUgJiYgbGlzdEl0ZW1Ob2RlLnBhcmVudE5vZGUpIHtcclxuICAgICAgICAgICAgbGlzdEl0ZW1Ob2RlID0gbGlzdEl0ZW1Ob2RlLnBhcmVudE5vZGU7XHJcbiAgICAgICAgIH1cclxuXHJcbiAgICAgICAgIGlmIChsaXN0SXRlbU5vZGUucGFyZW50Tm9kZSA9PT0gdGhpcy5fbGlzdE5vZGUgJiYgbGlzdEl0ZW1Ob2RlICE9PSB0aGlzLl9wbGFjZWhvbGRlck5vZGUpIHtcclxuICAgICAgICAgICAgLy8gSWYgdGhlIG1vdXNlIHBvaW50ZXIgaXMgaW4gdGhlIHVwcGVyIGhhbGYgb2YgdGhlIGxpc3QgaXRlbSBlbGVtZW50LFxyXG4gICAgICAgICAgICAvLyB3ZSBwb3NpdGlvbiB0aGUgcGxhY2Vob2xkZXIgYmVmb3JlIHRoZSBsaXN0IGl0ZW0sIG90aGVyd2lzZSBhZnRlciBpdC5cclxuICAgICAgICAgICAgY29uc3QgcmVjdCA9IGxpc3RJdGVtTm9kZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICAgICAgbGV0IGlzRmlyc3RIYWxmO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5fbGlzdFNldHRpbmdzLmhvcml6b250YWwpIHtcclxuICAgICAgICAgICAgICAgaXNGaXJzdEhhbGYgPSBldmVudC5jbGllbnRYIDwgcmVjdC5sZWZ0ICsgcmVjdC53aWR0aCAvIDI7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgIGlzRmlyc3RIYWxmID0gZXZlbnQuY2xpZW50WSA8IHJlY3QudG9wICsgcmVjdC5oZWlnaHQgLyAyO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuX2xpc3ROb2RlLmluc2VydEJlZm9yZSh0aGlzLl9wbGFjZWhvbGRlck5vZGUsXHJcbiAgICAgICAgICAgICAgIGlzRmlyc3RIYWxmID8gbGlzdEl0ZW1Ob2RlIDogbGlzdEl0ZW1Ob2RlLm5leHRTaWJsaW5nKTtcclxuICAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBJbiBJRSB3ZSBzZXQgYSBmYWtlIGVmZmVjdEFsbG93ZWQgaW4gZHJhZ3N0YXJ0IHRvIGdldCB0aGUgY29ycmVjdCBjdXJzb3IsIHdlIHRoZXJlZm9yZVxyXG4gICAgICAvLyBpZ25vcmUgdGhlIGVmZmVjdEFsbG93ZWQgcGFzc2VkIGluIGRhdGFUcmFuc2Zlci4gV2UgbXVzdCBhbHNvIG5vdCBhY2Nlc3MgZGF0YVRyYW5zZmVyIGZvclxyXG4gICAgICAvLyBkcm9wcyBmcm9tIGV4dGVybmFsIHNvdXJjZXMsIGFzIHRoYXQgdGhyb3dzIGFuIGV4Y2VwdGlvbi5cclxuICAgICAgY29uc3QgaWdub3JlRGF0YVRyYW5zZmVyID0gbWltZVR5cGUgPT09IE1TSUVfTUlNRV9UWVBFO1xyXG4gICAgICBjb25zdCBkcm9wRWZmZWN0ID0gdGhpcy5fZ2V0RHJvcEVmZmVjdChldmVudCwgaWdub3JlRGF0YVRyYW5zZmVyKTtcclxuXHJcbiAgICAgIGlmIChkcm9wRWZmZWN0ID09PSAnbm9uZScpIHtcclxuICAgICAgICAgcmV0dXJuIHRoaXMuX3N0b3BEcmFnb3ZlcigpO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIEF0IHRoaXMgcG9pbnQgd2UgaW52b2tlIHRoZSBjYWxsYmFjaywgd2hpY2ggc3RpbGwgY2FuIGRpc2FsbG93IHRoZSBkcm9wLlxyXG4gICAgICAvLyBXZSBjYW4ndCBkbyB0aGlzIGVhcmxpZXIgYmVjYXVzZSB3ZSB3YW50IHRvIHBhc3MgdGhlIGluZGV4IG9mIHRoZSBwbGFjZWhvbGRlci5cclxuXHJcbiAgICAgIHRoaXMuZG5kRHJhZ292ZXIuZW1pdCh0aGlzLl9nZXRFdmVudFJlc3BvbnNlKGV2ZW50LCBkcm9wRWZmZWN0LCBpdGVtVHlwZSkpO1xyXG4gICAgICBpZiAodGhpcy5fZHJhZ092ZXJTdG9wcGVkKSB7XHJcbiAgICAgICAgIHJldHVybiB0aGlzLl9zdG9wRHJhZ292ZXIoKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gU2V0IGRyb3BFZmZlY3QgdG8gbW9kaWZ5IHRoZSBjdXJzb3Igc2hvd24gYnkgdGhlIGJyb3dzZXIsIHVubGVzcyB3ZSdyZSBpbiBJRSwgd2hlcmUgdGhpc1xyXG4gICAgICAvLyBpcyBub3Qgc3VwcG9ydGVkLiBUaGlzIG11c3QgYmUgZG9uZSBhZnRlciBwcmV2ZW50RGVmYXVsdCBpbiBGaXJlZm94LlxyXG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICBpZiAoIWlnbm9yZURhdGFUcmFuc2Zlcikge1xyXG4gICAgICAgICBldmVudC5kYXRhVHJhbnNmZXIuZHJvcEVmZmVjdCA9IGRyb3BFZmZlY3Q7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMuX3JlbmRlcmVyLmFkZENsYXNzKHRoaXMuX25hdGl2ZUVsZW1lbnQsICdkbmREcmFnb3ZlcicpO1xyXG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICB9XHJcblxyXG4gICBASG9zdExpc3RlbmVyKCdkcm9wJywgWyckZXZlbnQnXSlcclxuICAgb25Ecm9wKGV2ZW50KSB7XHJcbiAgICAgIHRoaXMuX2NvdW50ZXIgPSAwO1xyXG4gICAgICBldmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQgfHwgZXZlbnQ7XHJcbiAgICAgIC8vIENoZWNrIHdoZXRoZXIgdGhlIGRyb3AgaXMgYWxsb3dlZCBhbmQgZGV0ZXJtaW5lIG1pbWUgdHlwZS5cclxuICAgICAgY29uc3QgbWltZVR5cGUgPSB0aGlzLl9nZXRNaW1lVHlwZShldmVudC5kYXRhVHJhbnNmZXIudHlwZXMpO1xyXG4gICAgICBsZXQgaXRlbVR5cGUgPSB0aGlzLl9nZXRJdGVtVHlwZShtaW1lVHlwZSk7XHJcbiAgICAgIGlmICghbWltZVR5cGUgfHwgIXRoaXMuX2lzRHJvcEFsbG93ZWQoaXRlbVR5cGUpKSB7XHJcbiAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIFRoZSBkZWZhdWx0IGJlaGF2aW9yIGluIEZpcmVmb3ggaXMgdG8gaW50ZXJwcmV0IHRoZSBkcm9wcGVkIGVsZW1lbnQgYXMgVVJMIGFuZFxyXG4gICAgICAvLyBmb3J3YXJkIHRvIGl0LiBXZSB3YW50IHRvIHByZXZlbnQgdGhhdCBldmVuIGlmIG91ciBkcm9wIGlzIGFib3J0ZWQuXHJcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcblxyXG4gICAgICAvLyBVbnNlcmlhbGl6ZSB0aGUgZGF0YSB0aGF0IHdhcyBzZXJpYWxpemVkIGluIGRyYWdzdGFydC5cclxuICAgICAgbGV0IGRhdGE7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgIGRhdGEgPSBKU09OLnBhcnNlKGV2ZW50LmRhdGFUcmFuc2Zlci5nZXREYXRhKG1pbWVUeXBlKSk7XHJcbiAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgcmV0dXJuIHRoaXMuX3N0b3BEcmFnb3ZlcigpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBEcm9wcyB3aXRoIGludmFsaWQgdHlwZXMgZnJvbSBleHRlcm5hbCBzb3VyY2VzIG1pZ2h0IG5vdCBoYXZlIGJlZW4gZmlsdGVyZWQgb3V0IHlldC5cclxuICAgICAgaWYgKG1pbWVUeXBlID09PSBNU0lFX01JTUVfVFlQRSB8fCBtaW1lVHlwZSA9PT0gRURHRV9NSU1FX1RZUEUpIHtcclxuICAgICAgICAgaXRlbVR5cGUgPSBkYXRhLnR5cGUgfHwgdW5kZWZpbmVkO1xyXG4gICAgICAgICBkYXRhID0gZGF0YS5pdGVtO1xyXG4gICAgICAgICBpZiAoIXRoaXMuX2lzRHJvcEFsbG93ZWQoaXRlbVR5cGUpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zdG9wRHJhZ292ZXIoKTtcclxuICAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBTcGVjaWFsIGhhbmRsaW5nIGZvciBpbnRlcm5hbCBJRSBkcm9wcywgc2VlIGRyYWdvdmVyIGhhbmRsZXIuXHJcbiAgICAgIGNvbnN0IGlnbm9yZURhdGFUcmFuc2ZlciA9IG1pbWVUeXBlID09PSBNU0lFX01JTUVfVFlQRTtcclxuICAgICAgY29uc3QgZHJvcEVmZmVjdCA9IHRoaXMuX2dldERyb3BFZmZlY3QoZXZlbnQsIGlnbm9yZURhdGFUcmFuc2Zlcik7XHJcbiAgICAgIGlmIChkcm9wRWZmZWN0ID09PSAnbm9uZScpIHtcclxuICAgICAgICAgcmV0dXJuIHRoaXMuX3N0b3BEcmFnb3ZlcigpO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIEludm9rZSB0aGUgY2FsbGJhY2ssIHdoaWNoIGNhbiB0cmFuc2Zvcm0gdGhlIHRyYW5zZmVycmVkT2JqZWN0IGFuZCBldmVuIGFib3J0IHRoZSBkcm9wLlxyXG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuX2dldFBsYWNlaG9sZGVySW5kZXgoKTtcclxuICAgICAgdGhpcy5kbmREcm9wLmVtaXQodGhpcy5fZ2V0RXZlbnRSZXNwb25zZShldmVudCwgZHJvcEVmZmVjdCwgaXRlbVR5cGUsIGluZGV4LCBkYXRhKSk7XHJcbiAgICAgIGlmICh0aGlzLl9kcmFnT3ZlclN0b3BwZWQpIHtcclxuICAgICAgICAgcmV0dXJuIHRoaXMuX3N0b3BEcmFnb3ZlcigpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBUaGUgZHJvcCBpcyBkZWZpbml0ZWx5IGdvaW5nIHRvIGhhcHBlbiBub3csIHN0b3JlIHRoZSBkcm9wRWZmZWN0LlxyXG4gICAgICB0aGlzLl9kbmRTZXJ2aWNlLnNldERyb3BFZmZlY3QoZHJvcEVmZmVjdCk7XHJcbiAgICAgIGlmICghaWdub3JlRGF0YVRyYW5zZmVyKSB7XHJcbiAgICAgICAgIGV2ZW50LmRhdGFUcmFuc2Zlci5kcm9wRWZmZWN0ID0gZHJvcEVmZmVjdDtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKHRoaXMuZG5kTGlzdCkge1xyXG4gICAgICAgICAvLyBDcmVhdGVzIGEgbmV3IGFycmF5IGFkZGluZyB0aGUgb2JqZWN0IGludG8gdGhlIGFycmF5IHBvc2l0aW9uIHdpdGhvdXQgbXV0YXRlIHRoZSBvcmlnaW5hbC5cclxuICAgICAgICAgY29uc3QgbmV3TGlzdCA9IFsuLi50aGlzLmRuZExpc3Quc2xpY2UoMCwgaW5kZXgpLCBkYXRhLCAuLi50aGlzLmRuZExpc3Quc2xpY2UoaW5kZXgpXTtcclxuICAgICAgICAgdGhpcy5kbmRMaXN0Q2hhbmdlLmVtaXQobmV3TGlzdCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMuX2RuZFNlcnZpY2Uuc2V0UmVtb3ZlT25Ecm9wKHRydWUpO1xyXG4gICAgICAvLyB0aGlzLl9kbmRTZXJ2aWNlLmRyb3BFbmRTb3VyY2UoKVxyXG5cclxuICAgICAgdGhpcy5kbmRJbnNlcnRlZC5lbWl0KHRoaXMuX2dldEV2ZW50UmVzcG9uc2UoZXZlbnQsIGRyb3BFZmZlY3QsIGl0ZW1UeXBlLCBpbmRleCwgZGF0YSkpO1xyXG5cclxuICAgICAgLy8gQ2xlYW4gdXBcclxuICAgICAgdGhpcy5fc3RvcERyYWdvdmVyKCk7XHJcbiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgIH1cclxuXHJcbiAgIC8qKlxyXG4gICogV2UgaGF2ZSB0byByZW1vdmUgdGhlIHBsYWNlaG9sZGVyIHdoZW4gdGhlIGVsZW1lbnQgaXMgbm8gbG9uZ2VyIGRyYWdnZWQgb3ZlciBvdXIgbGlzdC4gVGhlXHJcbiAgKiBwcm9ibGVtIGlzIHRoYXQgdGhlIGRyYWdsZWF2ZSBldmVudCBpcyBub3Qgb25seSBmaXJlZCB3aGVuIHRoZSBlbGVtZW50IGxlYXZlcyBvdXIgbGlzdCxcclxuICAqIGJ1dCBhbHNvIHdoZW4gaXQgbGVhdmVzIGEgY2hpbGQgZWxlbWVudC4gVGhlcmVmb3JlLCB3ZSBkZXRlcm1pbmUgd2hldGhlciB0aGUgbW91c2UgY3Vyc29yXHJcbiAgKiBpcyBzdGlsbCBwb2ludGluZyB0byBhbiBlbGVtZW50IGluc2lkZSB0aGUgbGlzdCBvciBub3QuXHJcbiAgKi9cclxuICAgQEhvc3RMaXN0ZW5lcignZHJhZ2xlYXZlJywgWyckZXZlbnQnXSlcclxuICAgb25EcmFnTGVhdmUoZXZlbnQpIHtcclxuICAgICAgdGhpcy5fY291bnRlci0tO1xyXG4gICAgICBldmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQgfHwgZXZlbnQ7XHJcbiAgICAgIGlmICh0aGlzLl9jb3VudGVyICE9PSAwKSB7XHJcbiAgICAgICAgIC8vIFNpZ25hbGl6ZSB0byBwb3RlbnRpYWwgcGFyZW50IGxpc3RzIHRoYXQgYSBwbGFjZWhvbGRlciBpcyBhbHJlYWR5IHNob3duLlxyXG4gICAgICAgICBldmVudC5fZG5kUGhTaG93biA9IHRydWU7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgIHRoaXMuX3N0b3BEcmFnb3ZlcigpO1xyXG4gICAgICB9XHJcbiAgIH1cclxuXHJcbiAgIEBIb3N0TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBbJyRldmVudCddKVxyXG4gICBvbm1vdXNlb3V0KGV2ZW50KSB7XHJcbiAgICAgIGlmICh0aGlzLl9kbmRTZXJ2aWNlLmdldERyYWdnaW5nU3RhdGUoKSkge1xyXG4gICAgICAgICB0aGlzLl9zdG9wRHJhZ292ZXIoKTtcclxuICAgICAgfVxyXG4gICB9XHJcblxyXG4gICBwcml2YXRlIF9zdG9wRHJhZygpIHtcclxuICAgICAgdGhpcy5fZHJhZ092ZXJTdG9wcGVkID0gdHJ1ZTtcclxuICAgfVxyXG5cclxuICAgcHJpdmF0ZSBfc3RvcERyYWdvdmVyKCkge1xyXG4gICAgICB0aGlzLl9wbGFjZWhvbGRlck5vZGUucmVtb3ZlKCk7XHJcbiAgICAgIHRoaXMuX3JlbmRlcmVyLnJlbW92ZUNsYXNzKHRoaXMuX25hdGl2ZUVsZW1lbnQsICdkbmREcmFnb3ZlcicpO1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgfVxyXG5cclxuXHJcbiAgIC8qKlxyXG4gICogQ3JlYXRlIGEgRG5kTGlzdEV2ZW50IGluc3RhbmNlIGZvciBldmVudHMgcmVzcG9uc2UuXHJcbiAgKi9cclxuICAgcHJpdmF0ZSBfZ2V0RXZlbnRSZXNwb25zZShldmVudDogRHJhZ0V2ZW50LCBkcm9wRWZmZWN0OiBzdHJpbmcsIGl0ZW1UeXBlOiBzdHJpbmcsIGluZGV4PzogbnVtYmVyLCBpdGVtPyk6IERuZExpc3RFdmVudCB7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgIGNhbGxiYWNrOiB0aGlzLl9kbmRTZXJ2aWNlLmdldERyb3BDYWxsYmFjaygpLFxyXG4gICAgICAgICBkcm9wRWZmZWN0OiBkcm9wRWZmZWN0LFxyXG4gICAgICAgICBldmVudDogZXZlbnQsXHJcbiAgICAgICAgIGV4dGVybmFsOiAhdGhpcy5fZG5kU2VydmljZS5nZXREcmFnZ2luZ1N0YXRlKCksXHJcbiAgICAgICAgIGluZGV4OiBpbmRleCAhPT0gdW5kZWZpbmVkID8gaW5kZXggOiB0aGlzLl9nZXRQbGFjZWhvbGRlckluZGV4KCksXHJcbiAgICAgICAgIGl0ZW06IGl0ZW0gfHwgdW5kZWZpbmVkLFxyXG4gICAgICAgICBzdG9wRHJhZ292ZXI6IHRoaXMuX3N0b3BEcmFnLmJpbmQodGhpcyksXHJcbiAgICAgICAgIHR5cGU6IGl0ZW1UeXBlXHJcbiAgICAgIH07XHJcbiAgIH1cclxuXHJcbiAgIHByaXZhdGUgX2dldFBsYWNlaG9sZGVySW5kZXgoKSB7XHJcbiAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKHRoaXMuX25hdGl2ZUVsZW1lbnQuY2hpbGRyZW4sIHRoaXMuX3BsYWNlaG9sZGVyTm9kZSk7XHJcbiAgIH1cclxuXHJcbiAgIHByaXZhdGUgX2dldFBsYWNlaG9sZGVyRWxlbWVudCgpOiBFbGVtZW50IHtcclxuICAgICAgbGV0IHBsYWNlaG9sZGVyID0gW10uc2xpY2UuY2FsbCh0aGlzLl9uYXRpdmVFbGVtZW50LmNoaWxkcmVuKS5maWx0ZXIoKGNoaWxkTm9kZSkgPT4ge1xyXG4gICAgICAgICByZXR1cm4gY2hpbGROb2RlLmNsYXNzTmFtZS5pbmRleE9mKCdkbmRQbGFjZWhvbGRlcicpID4gLTE7XHJcbiAgICAgIH0pO1xyXG4gICAgICBpZiAocGxhY2Vob2xkZXIubGVuZ3RoKSB7XHJcbiAgICAgICAgIHJldHVybiBwbGFjZWhvbGRlcjtcclxuICAgICAgfVxyXG4gICAgICBwbGFjZWhvbGRlciA9IHRoaXMuX3JlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ2xpJyk7XHJcbiAgICAgIHRoaXMuX3JlbmRlcmVyLmFkZENsYXNzKHBsYWNlaG9sZGVyLCAnZG5kUGxhY2Vob2xkZXInKTtcclxuICAgICAgcmV0dXJuIHBsYWNlaG9sZGVyO1xyXG4gICB9XHJcblxyXG4gICBwcml2YXRlIF9nZXRNaW1lVHlwZSh0eXBlcykge1xyXG4gICAgICBpZiAoIXR5cGVzKSB7XHJcbiAgICAgICAgIHJldHVybiBNU0lFX01JTUVfVFlQRTsgLy8gSUUgOSB3b3JrYXJvdW5kLlxyXG4gICAgICB9XHJcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdHlwZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgaWYgKHR5cGVzW2ldID09PSBNU0lFX01JTUVfVFlQRSB8fCB0eXBlc1tpXSA9PT0gRURHRV9NSU1FX1RZUEUgfHxcclxuICAgICAgICAgICAgdHlwZXNbaV0uc3Vic3RyKDAsIE1JTUVfVFlQRS5sZW5ndGgpID09PSBNSU1FX1RZUEUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHR5cGVzW2ldO1xyXG4gICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgIH1cclxuXHJcbiAgIC8qKlxyXG4gICogRGV0ZXJtaW5lcyB0aGUgdHlwZSBvZiB0aGUgaXRlbSBmcm9tIHRoZSBkbmRTZXJ2aWNlLCBvciBmcm9tIHRoZSBtaW1lIHR5cGUgZm9yIGl0ZW1zIGZyb21cclxuICAqIGV4dGVybmFsIHNvdXJjZXMuIFJldHVybnMgdW5kZWZpbmVkIGlmIG5vIGl0ZW0gdHlwZSB3YXMgc2V0IGFuZCBudWxsIGlmIHRoZSBpdGVtIHR5cGUgY291bGRcclxuICAqIG5vdCBiZSBkZXRlcm1pbmVkLlxyXG4gICovXHJcbiAgIHByaXZhdGUgX2dldEl0ZW1UeXBlKG1pbWVUeXBlKSB7XHJcbiAgICAgIGlmICh0aGlzLl9kbmRTZXJ2aWNlLmdldERyYWdnaW5nU3RhdGUoKSkge1xyXG4gICAgICAgICByZXR1cm4gdGhpcy5fZG5kU2VydmljZS5nZXRJdGVtVHlwZSgpIHx8IHVuZGVmaW5lZDtcclxuICAgICAgfVxyXG4gICAgICBpZiAobWltZVR5cGUgPT09IE1TSUVfTUlNRV9UWVBFIHx8IG1pbWVUeXBlID09PSBFREdFX01JTUVfVFlQRSkge1xyXG4gICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gKG1pbWVUeXBlICYmIG1pbWVUeXBlLnN1YnN0cihNSU1FX1RZUEUubGVuZ3RoICsgMSkpIHx8IHVuZGVmaW5lZDtcclxuICAgfVxyXG5cclxuICAgcHJpdmF0ZSBfaXNEcm9wQWxsb3dlZChpdGVtVHlwZSkge1xyXG4gICAgICBpZiAodGhpcy5fbGlzdFNldHRpbmdzLmRpc2FibGVkKSB7XHJcbiAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoIXRoaXMuX2xpc3RTZXR0aW5ncy5leHRlcm5hbFNvdXJjZXMgJiYgIXRoaXMuX2RuZFNlcnZpY2UuZ2V0RHJhZ2dpbmdTdGF0ZSgpKSB7XHJcbiAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoIXRoaXMuX2xpc3RTZXR0aW5ncy5hbGxvd2VkVHlwZXMgfHwgaXRlbVR5cGUgPT09IG51bGwpIHtcclxuICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGl0ZW1UeXBlICYmIHRoaXMuX2xpc3RTZXR0aW5ncy5hbGxvd2VkVHlwZXMuaW5kZXhPZihpdGVtVHlwZSkgIT09IC0xO1xyXG4gICB9XHJcblxyXG4gICAvKipcclxuICAqIERldGVybWluZXMgd2hpY2ggZHJvcCBlZmZlY3QgdG8gdXNlIGZvciB0aGUgZ2l2ZW4gZXZlbnQuIEluIEludGVybmV0IEV4cGxvcmVyIHdlIGhhdmUgdG9cclxuICAqIGlnbm9yZSB0aGUgZWZmZWN0QWxsb3dlZCBmaWVsZCBvbiBkYXRhVHJhbnNmZXIsIHNpbmNlIHdlIHNldCBhIGZha2UgdmFsdWUgaW4gZHJhZ3N0YXJ0LlxyXG4gICogSW4gdGhvc2UgY2FzZXMgd2UgcmVseSBvbiBkbmRTdGF0ZSB0byBmaWx0ZXIgZWZmZWN0cy4gUmVhZCB0aGUgZGVzaWduIGRvYyBmb3IgbW9yZSBkZXRhaWxzOlxyXG4gICogaHR0cHM6Ly9naXRodWIuY29tL21hcmNlbGp1ZW5lbWFubi9hbmd1bGFyLWRyYWctYW5kLWRyb3AtbGlzdHMvd2lraS9EYXRhLVRyYW5zZmVyLURlc2lnblxyXG4gICovXHJcbiAgIHByaXZhdGUgX2dldERyb3BFZmZlY3QoZXZlbnQsIGlnbm9yZURhdGFUcmFuc2Zlcikge1xyXG4gICAgICBsZXQgZWZmZWN0cyA9IEFMTF9FRkZFQ1RTO1xyXG4gICAgICBpZiAoIWlnbm9yZURhdGFUcmFuc2Zlcikge1xyXG4gICAgICAgICBlZmZlY3RzID0gdGhpcy5fZmlsdGVyRWZmZWN0cyhlZmZlY3RzLCBldmVudC5kYXRhVHJhbnNmZXIuZWZmZWN0QWxsb3dlZCk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHRoaXMuX2RuZFNlcnZpY2UuZ2V0RHJhZ2dpbmdTdGF0ZSgpKSB7XHJcbiAgICAgICAgIGVmZmVjdHMgPSB0aGlzLl9maWx0ZXJFZmZlY3RzKGVmZmVjdHMsIHRoaXMuX2RuZFNlcnZpY2UuZ2V0RWZmZWN0QWxsb3dlZCgpKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAodGhpcy5kbmRFZmZlY3RBbGxvd2VkKSB7XHJcbiAgICAgICAgIGVmZmVjdHMgPSB0aGlzLl9maWx0ZXJFZmZlY3RzKGVmZmVjdHMsIHRoaXMuZG5kRWZmZWN0QWxsb3dlZCk7XHJcbiAgICAgIH1cclxuICAgICAgLy8gTWFjT1MgYXV0b21hdGljYWxseSBmaWx0ZXJzIGRhdGFUcmFuc2Zlci5lZmZlY3RBbGxvd2VkIGRlcGVuZGluZyBvbiB0aGUgbW9kaWZpZXIga2V5cyxcclxuICAgICAgLy8gdGhlcmVmb3JlIHRoZSBmb2xsb3dpbmcgbW9kaWZpZXIga2V5cyB3aWxsIG9ubHkgYWZmZWN0IG90aGVyIG9wZXJhdGluZyBzeXN0ZW1zLlxyXG4gICAgICBpZiAoIWVmZmVjdHMubGVuZ3RoKSB7XHJcbiAgICAgICAgIHJldHVybiAnbm9uZSc7XHJcbiAgICAgIH0gZWxzZSBpZiAoZXZlbnQuY3RybEtleSAmJiBlZmZlY3RzLmluZGV4T2YoJ2NvcHknKSAhPT0gLTEpIHtcclxuICAgICAgICAgcmV0dXJuICdjb3B5JztcclxuICAgICAgfSBlbHNlIGlmIChldmVudC5hbHRLZXkgJiYgZWZmZWN0cy5pbmRleE9mKCdsaW5rJykgIT09IC0xKSB7XHJcbiAgICAgICAgIHJldHVybiAnbGluayc7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgIHJldHVybiBlZmZlY3RzWzBdO1xyXG4gICAgICB9XHJcbiAgIH1cclxuXHJcbiAgIC8qKlxyXG4gICogRmlsdGVycyBhbiBhcnJheSBvZiBkcm9wIGVmZmVjdHMgdXNpbmcgYSBIVE1MNSBlZmZlY3RBbGxvd2VkIHN0cmluZy5cclxuICAqL1xyXG4gICBwcml2YXRlIF9maWx0ZXJFZmZlY3RzKGVmZmVjdHMsIGVmZmVjdEFsbG93ZWQpIHtcclxuICAgICAgaWYgKGVmZmVjdEFsbG93ZWQgPT09ICdhbGwnKSB7XHJcbiAgICAgICAgIHJldHVybiBlZmZlY3RzO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBlZmZlY3RzLmZpbHRlcihmdW5jdGlvbiAoZWZmZWN0KSB7XHJcbiAgICAgICAgIHJldHVybiBlZmZlY3RBbGxvd2VkLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihlZmZlY3QpICE9PSAtMTtcclxuICAgICAgfSk7XHJcbiAgIH1cclxufVxyXG4iXX0=