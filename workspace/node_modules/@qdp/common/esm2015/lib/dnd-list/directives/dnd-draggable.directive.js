/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, HostBinding, Input, HostListener, ElementRef, Renderer2, Output, EventEmitter } from '@angular/core';
import { DndDraggableService } from '../services/dnd-draggable.service';
import { MIME_TYPE, EDGE_MIME_TYPE, MSIE_MIME_TYPE, ALL_EFFECTS } from '../dnd-constants';
export class DndDraggableDirective {
    /**
     * @param {?} _dndService
     * @param {?} _renderer
     * @param {?} _hostElement
     */
    constructor(_dndService, _renderer, _hostElement) {
        this._dndService = _dndService;
        this._renderer = _renderer;
        this.dndType = '';
        this.dndDragstart = new EventEmitter();
        this.dndDragend = new EventEmitter();
        this.dndSelected = new EventEmitter();
        this.dndMoved = new EventEmitter();
        this.dndCopied = new EventEmitter();
        this.dndLinked = new EventEmitter();
        this.dndCanceled = new EventEmitter();
        if (_hostElement) {
            this._nativeElement = _hostElement.nativeElement;
        }
    }
    /**
     * @return {?}
     */
    get draggable() {
        return !this.dndDisable;
    }
    /**
     * @return {?}
     */
    ngOnInit() { }
    /**
     * @param {?} event
     * @return {?}
     */
    onDragStart(event) {
        event = event.originalEvent || event;
        if (!this.draggable) {
            return true;
        }
        this._dndService.setDraggingState(true);
        this._dndService.setItemType(this.dndType);
        /** @type {?} */
        const mimeType = MIME_TYPE + (this._dndService.getItemType() ? ('-' + this._dndService.getItemType()) : '');
        // Set the allowed drop effects. See below for special IE handling.
        this._dndService.setDropEffect('none');
        this._dndService.setEffectAllowed(this.dndEffectAllowed || ALL_EFFECTS[0]);
        event.dataTransfer.effectAllowed = this._dndService.getEffectAllowed(); // TODO: set allowed effects
        try {
            event.dataTransfer.setData(mimeType, JSON.stringify(this.dndDraggable));
        }
        catch (e) {
            /** @type {?} */
            const data = {
                item: this.dndDraggable,
                type: this._dndService.getItemType()
            };
            try {
                // Setting a custom MIME type did not work, we are probably in IE or Edge.
                event.dataTransfer.setData(EDGE_MIME_TYPE, JSON.stringify(data));
            }
            catch (e) {
                // We are in Internet Explorer and can only use the Text MIME type. Also note that IE
                // does not allow changing the cursor in the dragover event, therefore we have to choose
                // the one we want to display now by setting effectAllowed.
                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.setData(MSIE_MIME_TYPE, JSON.stringify(data));
            }
        }
        this._renderer.addClass(this._nativeElement, 'dndDragging');
        setTimeout((/**
         * @return {?}
         */
        () => this._renderer.addClass(this._nativeElement, 'dndDraggingSource')), 0);
        // Try setting a proper drag image if triggered on a dnd-handle (won't work in IE).
        if (event._dndHandle && event.dataTransfer.setDragImage) {
            event.dataTransfer.setDragImage(this._nativeElement, 0, 0);
        }
        // Emit dragstart event and prepare extra callback for dropzone.
        this.dndDragstart.emit(event);
        if (this.dndCallback) {
            /** @type {?} */
            const callback = this.dndCallback;
            this._dndService.setDropCallback((/**
             * @param {?} params
             * @return {?}
             */
            function (params) {
                return callback(params);
            }));
        }
        event.stopPropagation();
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onDragEnd(event) {
        /** @type {?} */
        const dropEffect = this._dndService.getDropEffect();
        /** @type {?} */
        const cb = { copy: 'dndCopied', link: 'dndLinked', move: 'dndMoved', none: 'dndCanceled' };
        this[cb[dropEffect]].emit(event);
        this.dndDragend.emit({
            event: event,
            dropEffect: dropEffect
        });
        // Clean up
        this._dndService.setDraggingState(false);
        this._dndService.setDropCallback(undefined);
        this._dndService.setRemoveOnDrop(false);
        this._renderer.removeClass(this._nativeElement, 'dndDragging');
        this._renderer.removeClass(this._nativeElement, 'dndDraggingSource');
        event.stopPropagation();
        // In IE9 it is possible that the timeout from dragstart triggers after the dragend handler.
        setTimeout((/**
         * @return {?}
         */
        () => this._renderer.removeClass(this._nativeElement, 'dndDraggingSource')), 0);
    }
    /**
     * @param {?} event
     * @return {?}
     */
    click(event) {
        this.dndSelected.emit(event);
        // Prevent triggering dndSelected in parent elements.
        event.stopPropagation();
    }
}
DndDraggableDirective.decorators = [
    { type: Directive, args: [{
                selector: '[dndDraggable]',
            },] }
];
/** @nocollapse */
DndDraggableDirective.ctorParameters = () => [
    { type: DndDraggableService },
    { type: Renderer2 },
    { type: ElementRef }
];
DndDraggableDirective.propDecorators = {
    dndDraggable: [{ type: Input }],
    dndDisable: [{ type: Input }],
    dndType: [{ type: Input }],
    dndCallback: [{ type: Input }],
    dndEffectAllowed: [{ type: Input }],
    dndDragstart: [{ type: Output }],
    dndDragend: [{ type: Output }],
    dndSelected: [{ type: Output }],
    dndMoved: [{ type: Output }],
    dndCopied: [{ type: Output }],
    dndLinked: [{ type: Output }],
    dndCanceled: [{ type: Output }],
    draggable: [{ type: HostBinding, args: ['draggable',] }],
    onDragStart: [{ type: HostListener, args: ['dragstart', ['$event'],] }],
    onDragEnd: [{ type: HostListener, args: ['dragend', ['$event'],] }],
    click: [{ type: HostListener, args: ['click', ['$event'],] }]
};
if (false) {
    /** @type {?} */
    DndDraggableDirective.prototype.dndDraggable;
    /** @type {?} */
    DndDraggableDirective.prototype.dndDisable;
    /** @type {?} */
    DndDraggableDirective.prototype.dndType;
    /** @type {?} */
    DndDraggableDirective.prototype.dndCallback;
    /** @type {?} */
    DndDraggableDirective.prototype.dndEffectAllowed;
    /** @type {?} */
    DndDraggableDirective.prototype.dndDragstart;
    /** @type {?} */
    DndDraggableDirective.prototype.dndDragend;
    /** @type {?} */
    DndDraggableDirective.prototype.dndSelected;
    /** @type {?} */
    DndDraggableDirective.prototype.dndMoved;
    /** @type {?} */
    DndDraggableDirective.prototype.dndCopied;
    /** @type {?} */
    DndDraggableDirective.prototype.dndLinked;
    /** @type {?} */
    DndDraggableDirective.prototype.dndCanceled;
    /**
     * @type {?}
     * @private
     */
    DndDraggableDirective.prototype._nativeElement;
    /**
     * @type {?}
     * @private
     */
    DndDraggableDirective.prototype._dndService;
    /**
     * @type {?}
     * @private
     */
    DndDraggableDirective.prototype._renderer;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG5kLWRyYWdnYWJsZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcWRwL2NvbW1vbi8iLCJzb3VyY2VzIjpbImxpYi9kbmQtbGlzdC9kaXJlY3RpdmVzL2RuZC1kcmFnZ2FibGUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUFFLFdBQVcsRUFBNEIsS0FBSyxFQUN2RCxZQUFZLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUMxRCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUN4RSxPQUFPLEVBQUUsU0FBUyxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFNMUYsTUFBTSxPQUFPLHFCQUFxQjs7Ozs7O0lBd0JoQyxZQUFvQixXQUFnQyxFQUFVLFNBQW9CLEVBQUUsWUFBd0I7UUFBeEYsZ0JBQVcsR0FBWCxXQUFXLENBQXFCO1FBQVUsY0FBUyxHQUFULFNBQVMsQ0FBVztRQXBCekUsWUFBTyxHQUFHLEVBQUUsQ0FBQztRQUlaLGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQWEsQ0FBQztRQUM3QyxlQUFVLEdBQUcsSUFBSSxZQUFZLEVBQW1CLENBQUM7UUFDakQsZ0JBQVcsR0FBRyxJQUFJLFlBQVksRUFBUyxDQUFDO1FBRXhDLGFBQVEsR0FBRyxJQUFJLFlBQVksRUFBYSxDQUFDO1FBQ3pDLGNBQVMsR0FBRyxJQUFJLFlBQVksRUFBYSxDQUFDO1FBQzFDLGNBQVMsR0FBRyxJQUFJLFlBQVksRUFBYSxDQUFDO1FBQzFDLGdCQUFXLEdBQUcsSUFBSSxZQUFZLEVBQWEsQ0FBQztRQVVwRCxJQUFJLFlBQVksRUFBRTtZQUNoQixJQUFJLENBQUMsY0FBYyxHQUFHLFlBQVksQ0FBQyxhQUFhLENBQUM7U0FDbEQ7SUFDSCxDQUFDOzs7O0lBWEQs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QUM1RixDQUFDOzs7OztJQUdELEtBQUssQ0FBQyxLQUFpQjtRQUNyQixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixxREFBcUQ7UUFDckQsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQzFCLENBQUM7OztZQWxIRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLGdCQUFnQjthQUMzQjs7OztZQU5RLG1CQUFtQjtZQUZBLFNBQVM7WUFBckIsVUFBVTs7OzJCQVd2QixLQUFLO3lCQUNMLEtBQUs7c0JBQ0wsS0FBSzswQkFDTCxLQUFLOytCQUNMLEtBQUs7MkJBRUwsTUFBTTt5QkFDTixNQUFNOzBCQUNOLE1BQU07dUJBRU4sTUFBTTt3QkFDTixNQUFNO3dCQUNOLE1BQU07MEJBQ04sTUFBTTt3QkFFTixXQUFXLFNBQUMsV0FBVzswQkFldkIsWUFBWSxTQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQzt3QkFvRHBDLFlBQVksU0FBQyxTQUFTLEVBQUUsQ0FBQyxRQUFRLENBQUM7b0JBc0JsQyxZQUFZLFNBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDOzs7O0lBeEdqQyw2Q0FBMkI7O0lBQzNCLDJDQUE2Qjs7SUFDN0Isd0NBQXNCOztJQUN0Qiw0Q0FBK0I7O0lBQy9CLGlEQUFrQzs7SUFFbEMsNkNBQXVEOztJQUN2RCwyQ0FBMkQ7O0lBQzNELDRDQUFrRDs7SUFFbEQseUNBQW1EOztJQUNuRCwwQ0FBb0Q7O0lBQ3BELDBDQUFvRDs7SUFDcEQsNENBQXNEOzs7OztJQU90RCwrQ0FBZ0M7Ozs7O0lBRXBCLDRDQUF3Qzs7Ozs7SUFBRSwwQ0FBNEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIERpcmVjdGl2ZSwgSG9zdEJpbmRpbmcsIE9uQ2hhbmdlcywgU2ltcGxlQ2hhbmdlcywgSW5wdXQsIE9uSW5pdCxcclxuICBIb3N0TGlzdGVuZXIsIEVsZW1lbnRSZWYsIFJlbmRlcmVyMiwgT3V0cHV0LCBFdmVudEVtaXR0ZXJcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRG5kRHJhZ2dhYmxlU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2RuZC1kcmFnZ2FibGUuc2VydmljZSc7XHJcbmltcG9ydCB7IE1JTUVfVFlQRSwgRURHRV9NSU1FX1RZUEUsIE1TSUVfTUlNRV9UWVBFLCBBTExfRUZGRUNUUyB9IGZyb20gJy4uL2RuZC1jb25zdGFudHMnO1xyXG5pbXBvcnQgeyBEbmREcmFnZW5kRXZlbnQgfSBmcm9tICcuLi9tb2RlbHMvZXZlbnRzJztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW2RuZERyYWdnYWJsZV0nLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgRG5kRHJhZ2dhYmxlRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0IHtcclxuXHJcbiAgQElucHV0KCkgZG5kRHJhZ2dhYmxlOiBhbnk7XHJcbiAgQElucHV0KCkgZG5kRGlzYWJsZTogYm9vbGVhbjtcclxuICBASW5wdXQoKSBkbmRUeXBlID0gJyc7XHJcbiAgQElucHV0KCkgZG5kQ2FsbGJhY2s6IEZ1bmN0aW9uO1xyXG4gIEBJbnB1dCgpIGRuZEVmZmVjdEFsbG93ZWQ6IHN0cmluZztcclxuXHJcbiAgQE91dHB1dCgpIGRuZERyYWdzdGFydCA9IG5ldyBFdmVudEVtaXR0ZXI8RHJhZ0V2ZW50PigpO1xyXG4gIEBPdXRwdXQoKSBkbmREcmFnZW5kID0gbmV3IEV2ZW50RW1pdHRlcjxEbmREcmFnZW5kRXZlbnQ+KCk7XHJcbiAgQE91dHB1dCgpIGRuZFNlbGVjdGVkID0gbmV3IEV2ZW50RW1pdHRlcjxFdmVudD4oKTtcclxuXHJcbiAgQE91dHB1dCgpIGRuZE1vdmVkID0gbmV3IEV2ZW50RW1pdHRlcjxEcmFnRXZlbnQ+KCk7XHJcbiAgQE91dHB1dCgpIGRuZENvcGllZCA9IG5ldyBFdmVudEVtaXR0ZXI8RHJhZ0V2ZW50PigpO1xyXG4gIEBPdXRwdXQoKSBkbmRMaW5rZWQgPSBuZXcgRXZlbnRFbWl0dGVyPERyYWdFdmVudD4oKTtcclxuICBAT3V0cHV0KCkgZG5kQ2FuY2VsZWQgPSBuZXcgRXZlbnRFbWl0dGVyPERyYWdFdmVudD4oKTtcclxuXHJcbiAgQEhvc3RCaW5kaW5nKCdkcmFnZ2FibGUnKVxyXG4gIGdldCBkcmFnZ2FibGUoKSB7XHJcbiAgICByZXR1cm4gIXRoaXMuZG5kRGlzYWJsZTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX25hdGl2ZUVsZW1lbnQ6IEVsZW1lbnQ7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgX2RuZFNlcnZpY2U6IERuZERyYWdnYWJsZVNlcnZpY2UsIHByaXZhdGUgX3JlbmRlcmVyOiBSZW5kZXJlcjIsIF9ob3N0RWxlbWVudDogRWxlbWVudFJlZikge1xyXG4gICAgaWYgKF9ob3N0RWxlbWVudCkge1xyXG4gICAgICB0aGlzLl9uYXRpdmVFbGVtZW50ID0gX2hvc3RFbGVtZW50Lm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHt9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ2RyYWdzdGFydCcsIFsnJGV2ZW50J10pXHJcbiAgb25EcmFnU3RhcnQoZXZlbnQpIHtcclxuICAgIGV2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudCB8fCBldmVudDtcclxuICAgIGlmICghdGhpcy5kcmFnZ2FibGUpIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICB0aGlzLl9kbmRTZXJ2aWNlLnNldERyYWdnaW5nU3RhdGUodHJ1ZSk7XHJcbiAgICB0aGlzLl9kbmRTZXJ2aWNlLnNldEl0ZW1UeXBlKHRoaXMuZG5kVHlwZSk7XHJcbiAgICBjb25zdCBtaW1lVHlwZSA9IE1JTUVfVFlQRSArICh0aGlzLl9kbmRTZXJ2aWNlLmdldEl0ZW1UeXBlKCkgPyAoJy0nICsgdGhpcy5fZG5kU2VydmljZS5nZXRJdGVtVHlwZSgpKSA6ICcnKTtcclxuICAgIC8vIFNldCB0aGUgYWxsb3dlZCBkcm9wIGVmZmVjdHMuIFNlZSBiZWxvdyBmb3Igc3BlY2lhbCBJRSBoYW5kbGluZy5cclxuICAgIHRoaXMuX2RuZFNlcnZpY2Uuc2V0RHJvcEVmZmVjdCgnbm9uZScpO1xyXG4gICAgdGhpcy5fZG5kU2VydmljZS5zZXRFZmZlY3RBbGxvd2VkKHRoaXMuZG5kRWZmZWN0QWxsb3dlZCB8fCBBTExfRUZGRUNUU1swXSk7XHJcblxyXG4gICAgZXZlbnQuZGF0YVRyYW5zZmVyLmVmZmVjdEFsbG93ZWQgPSB0aGlzLl9kbmRTZXJ2aWNlLmdldEVmZmVjdEFsbG93ZWQoKTsgLy8gVE9ETzogc2V0IGFsbG93ZWQgZWZmZWN0c1xyXG4gICAgdHJ5IHtcclxuICAgICAgZXZlbnQuZGF0YVRyYW5zZmVyLnNldERhdGEobWltZVR5cGUsIEpTT04uc3RyaW5naWZ5KHRoaXMuZG5kRHJhZ2dhYmxlKSk7XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgIGNvbnN0IGRhdGEgPSB7XHJcbiAgICAgICAgaXRlbTogdGhpcy5kbmREcmFnZ2FibGUsXHJcbiAgICAgICAgdHlwZTogdGhpcy5fZG5kU2VydmljZS5nZXRJdGVtVHlwZSgpXHJcbiAgICAgIH07XHJcblxyXG4gICAgICB0cnkge1xyXG4gICAgICAgIC8vIFNldHRpbmcgYSBjdXN0b20gTUlNRSB0eXBlIGRpZCBub3Qgd29yaywgd2UgYXJlIHByb2JhYmx5IGluIElFIG9yIEVkZ2UuXHJcbiAgICAgICAgZXZlbnQuZGF0YVRyYW5zZmVyLnNldERhdGEoRURHRV9NSU1FX1RZUEUsIEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcclxuXHJcbiAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAvLyBXZSBhcmUgaW4gSW50ZXJuZXQgRXhwbG9yZXIgYW5kIGNhbiBvbmx5IHVzZSB0aGUgVGV4dCBNSU1FIHR5cGUuIEFsc28gbm90ZSB0aGF0IElFXHJcbiAgICAgICAgLy8gZG9lcyBub3QgYWxsb3cgY2hhbmdpbmcgdGhlIGN1cnNvciBpbiB0aGUgZHJhZ292ZXIgZXZlbnQsIHRoZXJlZm9yZSB3ZSBoYXZlIHRvIGNob29zZVxyXG4gICAgICAgIC8vIHRoZSBvbmUgd2Ugd2FudCB0byBkaXNwbGF5IG5vdyBieSBzZXR0aW5nIGVmZmVjdEFsbG93ZWQuXHJcbiAgICAgICAgZXZlbnQuZGF0YVRyYW5zZmVyLmVmZmVjdEFsbG93ZWQgPSAnbW92ZSc7XHJcbiAgICAgICAgZXZlbnQuZGF0YVRyYW5zZmVyLnNldERhdGEoTVNJRV9NSU1FX1RZUEUsIEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgdGhpcy5fcmVuZGVyZXIuYWRkQ2xhc3ModGhpcy5fbmF0aXZlRWxlbWVudCwgJ2RuZERyYWdnaW5nJyk7XHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuX3JlbmRlcmVyLmFkZENsYXNzKHRoaXMuX25hdGl2ZUVsZW1lbnQsICdkbmREcmFnZ2luZ1NvdXJjZScpLCAwKTtcclxuICAgIC8vIFRyeSBzZXR0aW5nIGEgcHJvcGVyIGRyYWcgaW1hZ2UgaWYgdHJpZ2dlcmVkIG9uIGEgZG5kLWhhbmRsZSAod29uJ3Qgd29yayBpbiBJRSkuXHJcbiAgICBpZiAoZXZlbnQuX2RuZEhhbmRsZSAmJiBldmVudC5kYXRhVHJhbnNmZXIuc2V0RHJhZ0ltYWdlKSB7XHJcbiAgICAgIGV2ZW50LmRhdGFUcmFuc2Zlci5zZXREcmFnSW1hZ2UodGhpcy5fbmF0aXZlRWxlbWVudCwgMCwgMCk7XHJcbiAgICB9XHJcbiAgICAvLyBFbWl0IGRyYWdzdGFydCBldmVudCBhbmQgcHJlcGFyZSBleHRyYSBjYWxsYmFjayBmb3IgZHJvcHpvbmUuXHJcbiAgICB0aGlzLmRuZERyYWdzdGFydC5lbWl0KGV2ZW50KTtcclxuXHJcbiAgICBpZiAodGhpcy5kbmRDYWxsYmFjaykge1xyXG4gICAgICBjb25zdCBjYWxsYmFjayA9IHRoaXMuZG5kQ2FsbGJhY2s7XHJcbiAgICAgIHRoaXMuX2RuZFNlcnZpY2Uuc2V0RHJvcENhbGxiYWNrKGZ1bmN0aW9uIChwYXJhbXMpIHtcclxuICAgICAgICByZXR1cm4gY2FsbGJhY2socGFyYW1zKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ2RyYWdlbmQnLCBbJyRldmVudCddKVxyXG4gIG9uRHJhZ0VuZChldmVudDogRHJhZ0V2ZW50KSB7XHJcbiAgICBjb25zdCBkcm9wRWZmZWN0ID0gdGhpcy5fZG5kU2VydmljZS5nZXREcm9wRWZmZWN0KCk7XHJcbiAgICBjb25zdCBjYiA9IHsgY29weTogJ2RuZENvcGllZCcsIGxpbms6ICdkbmRMaW5rZWQnLCBtb3ZlOiAnZG5kTW92ZWQnLCBub25lOiAnZG5kQ2FuY2VsZWQnIH07XHJcbiAgICB0aGlzW2NiW2Ryb3BFZmZlY3RdXS5lbWl0KGV2ZW50KTtcclxuICAgIHRoaXMuZG5kRHJhZ2VuZC5lbWl0KHtcclxuICAgICAgZXZlbnQ6IGV2ZW50LFxyXG4gICAgICBkcm9wRWZmZWN0OiBkcm9wRWZmZWN0XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBDbGVhbiB1cFxyXG4gICAgdGhpcy5fZG5kU2VydmljZS5zZXREcmFnZ2luZ1N0YXRlKGZhbHNlKTtcclxuICAgIHRoaXMuX2RuZFNlcnZpY2Uuc2V0RHJvcENhbGxiYWNrKHVuZGVmaW5lZCk7XHJcbiAgICB0aGlzLl9kbmRTZXJ2aWNlLnNldFJlbW92ZU9uRHJvcChmYWxzZSk7XHJcbiAgICB0aGlzLl9yZW5kZXJlci5yZW1vdmVDbGFzcyh0aGlzLl9uYXRpdmVFbGVtZW50LCAnZG5kRHJhZ2dpbmcnKTtcclxuICAgIHRoaXMuX3JlbmRlcmVyLnJlbW92ZUNsYXNzKHRoaXMuX25hdGl2ZUVsZW1lbnQsICdkbmREcmFnZ2luZ1NvdXJjZScpO1xyXG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblxyXG4gICAgLy8gSW4gSUU5IGl0IGlzIHBvc3NpYmxlIHRoYXQgdGhlIHRpbWVvdXQgZnJvbSBkcmFnc3RhcnQgdHJpZ2dlcnMgYWZ0ZXIgdGhlIGRyYWdlbmQgaGFuZGxlci5cclxuICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fcmVuZGVyZXIucmVtb3ZlQ2xhc3ModGhpcy5fbmF0aXZlRWxlbWVudCwgJ2RuZERyYWdnaW5nU291cmNlJyksIDApO1xyXG4gIH1cclxuXHJcbiAgQEhvc3RMaXN0ZW5lcignY2xpY2snLCBbJyRldmVudCddKVxyXG4gIGNsaWNrKGV2ZW50OiBNb3VzZUV2ZW50KSB7XHJcbiAgICB0aGlzLmRuZFNlbGVjdGVkLmVtaXQoZXZlbnQpO1xyXG4gICAgLy8gUHJldmVudCB0cmlnZ2VyaW5nIGRuZFNlbGVjdGVkIGluIHBhcmVudCBlbGVtZW50cy5cclxuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gIH1cclxuXHJcbn1cclxuIl19