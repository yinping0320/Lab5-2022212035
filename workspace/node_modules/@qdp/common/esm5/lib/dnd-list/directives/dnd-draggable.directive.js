/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, HostBinding, Input, HostListener, ElementRef, Renderer2, Output, EventEmitter } from '@angular/core';
import { DndDraggableService } from '../services/dnd-draggable.service';
import { MIME_TYPE, EDGE_MIME_TYPE, MSIE_MIME_TYPE, ALL_EFFECTS } from '../dnd-constants';
var DndDraggableDirective = /** @class */ (function () {
    function DndDraggableDirective(_dndService, _renderer, _hostElement) {
        this._dndService = _dndService;
        this._renderer = _renderer;
        this.dndType = '';
        this.dndDragstart = new EventEmitter();
        this.dndDragend = new EventEmitter();
        this.dndSelected = new EventEmitter();
        this.dndMoved = new EventEmitter();
        this.dndCopied = new EventEmitter();
        this.dndLinked = new EventEmitter();
        this.dndCanceled = new EventEmitter();
        if (_hostElement) {
            this._nativeElement = _hostElement.nativeElement;
        }
    }
    Object.defineProperty(DndDraggableDirective.prototype, "draggable", {
        get: /**
         * @return {?}
         */
        function () {
            return !this.dndDisable;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    DndDraggableDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () { };
    /**
     * @param {?} event
     * @return {?}
     */
    DndDraggableDirective.prototype.onDragStart = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        var _this = this;
        event = event.originalEvent || event;
        if (!this.draggable) {
            return true;
        }
        this._dndService.setDraggingState(true);
        this._dndService.setItemType(this.dndType);
        /** @type {?} */
        var mimeType = MIME_TYPE + (this._dndService.getItemType() ? ('-' + this._dndService.getItemType()) : '');
        // Set the allowed drop effects. See below for special IE handling.
        this._dndService.setDropEffect('none');
        this._dndService.setEffectAllowed(this.dndEffectAllowed || ALL_EFFECTS[0]);
        event.dataTransfer.effectAllowed = this._dndService.getEffectAllowed(); // TODO: set allowed effects
        try {
            event.dataTransfer.setData(mimeType, JSON.stringify(this.dndDraggable));
        }
        catch (e) {
            /** @type {?} */
            var data = {
                item: this.dndDraggable,
                type: this._dndService.getItemType()
            };
            try {
                // Setting a custom MIME type did not work, we are probably in IE or Edge.
                event.dataTransfer.setData(EDGE_MIME_TYPE, JSON.stringify(data));
            }
            catch (e) {
                // We are in Internet Explorer and can only use the Text MIME type. Also note that IE
                // does not allow changing the cursor in the dragover event, therefore we have to choose
                // the one we want to display now by setting effectAllowed.
                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.setData(MSIE_MIME_TYPE, JSON.stringify(data));
            }
        }
        this._renderer.addClass(this._nativeElement, 'dndDragging');
        setTimeout((/**
         * @return {?}
         */
        function () { return _this._renderer.addClass(_this._nativeElement, 'dndDraggingSource'); }), 0);
        // Try setting a proper drag image if triggered on a dnd-handle (won't work in IE).
        if (event._dndHandle && event.dataTransfer.setDragImage) {
            event.dataTransfer.setDragImage(this._nativeElement, 0, 0);
        }
        // Emit dragstart event and prepare extra callback for dropzone.
        this.dndDragstart.emit(event);
        if (this.dndCallback) {
            /** @type {?} */
            var callback_1 = this.dndCallback;
            this._dndService.setDropCallback((/**
             * @param {?} params
             * @return {?}
             */
            function (params) {
                return callback_1(params);
            }));
        }
        event.stopPropagation();
    };
    /**
     * @param {?} event
     * @return {?}
     */
    DndDraggableDirective.prototype.onDragEnd = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        var _this = this;
        /** @type {?} */
        var dropEffect = this._dndService.getDropEffect();
        /** @type {?} */
        var cb = { copy: 'dndCopied', link: 'dndLinked', move: 'dndMoved', none: 'dndCanceled' };
        this[cb[dropEffect]].emit(event);
        this.dndDragend.emit({
            event: event,
            dropEffect: dropEffect
        });
        // Clean up
        this._dndService.setDraggingState(false);
        this._dndService.setDropCallback(undefined);
        this._dndService.setRemoveOnDrop(false);
        this._renderer.removeClass(this._nativeElement, 'dndDragging');
        this._renderer.removeClass(this._nativeElement, 'dndDraggingSource');
        event.stopPropagation();
        // In IE9 it is possible that the timeout from dragstart triggers after the dragend handler.
        setTimeout((/**
         * @return {?}
         */
        function () { return _this._renderer.removeClass(_this._nativeElement, 'dndDraggingSource'); }), 0);
    };
    /**
     * @param {?} event
     * @return {?}
     */
    DndDraggableDirective.prototype.click = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        this.dndSelected.emit(event);
        // Prevent triggering dndSelected in parent elements.
        event.stopPropagation();
    };
    DndDraggableDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[dndDraggable]',
                },] }
    ];
    /** @nocollapse */
    DndDraggableDirective.ctorParameters = function () { return [
        { type: DndDraggableService },
        { type: Renderer2 },
        { type: ElementRef }
    ]; };
    DndDraggableDirective.propDecorators = {
        dndDraggable: [{ type: Input }],
        dndDisable: [{ type: Input }],
        dndType: [{ type: Input }],
        dndCallback: [{ type: Input }],
        dndEffectAllowed: [{ type: Input }],
        dndDragstart: [{ type: Output }],
        dndDragend: [{ type: Output }],
        dndSelected: [{ type: Output }],
        dndMoved: [{ type: Output }],
        dndCopied: [{ type: Output }],
        dndLinked: [{ type: Output }],
        dndCanceled: [{ type: Output }],
        draggable: [{ type: HostBinding, args: ['draggable',] }],
        onDragStart: [{ type: HostListener, args: ['dragstart', ['$event'],] }],
        onDragEnd: [{ type: HostListener, args: ['dragend', ['$event'],] }],
        click: [{ type: HostListener, args: ['click', ['$event'],] }]
    };
    return DndDraggableDirective;
}());
export { DndDraggableDirective };
if (false) {
    /** @type {?} */
    DndDraggableDirective.prototype.dndDraggable;
    /** @type {?} */
    DndDraggableDirective.prototype.dndDisable;
    /** @type {?} */
    DndDraggableDirective.prototype.dndType;
    /** @type {?} */
    DndDraggableDirective.prototype.dndCallback;
    /** @type {?} */
    DndDraggableDirective.prototype.dndEffectAllowed;
    /** @type {?} */
    DndDraggableDirective.prototype.dndDragstart;
    /** @type {?} */
    DndDraggableDirective.prototype.dndDragend;
    /** @type {?} */
    DndDraggableDirective.prototype.dndSelected;
    /** @type {?} */
    DndDraggableDirective.prototype.dndMoved;
    /** @type {?} */
    DndDraggableDirective.prototype.dndCopied;
    /** @type {?} */
    DndDraggableDirective.prototype.dndLinked;
    /** @type {?} */
    DndDraggableDirective.prototype.dndCanceled;
    /**
     * @type {?}
     * @private
     */
    DndDraggableDirective.prototype._nativeElement;
    /**
     * @type {?}
     * @private
     */
    DndDraggableDirective.prototype._dndService;
    /**
     * @type {?}
     * @private
     */
    DndDraggableDirective.prototype._renderer;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG5kLWRyYWdnYWJsZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcWRwL2NvbW1vbi8iLCJzb3VyY2VzIjpbImxpYi9kbmQtbGlzdC9kaXJlY3RpdmVzL2RuZC1kcmFnZ2FibGUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUFFLFdBQVcsRUFBNEIsS0FBSyxFQUN2RCxZQUFZLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUMxRCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUN4RSxPQUFPLEVBQUUsU0FBUyxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFHMUY7SUEyQkUsK0JBQW9CLFdBQWdDLEVBQVUsU0FBb0IsRUFBRSxZQUF3QjtRQUF4RixnQkFBVyxHQUFYLFdBQVcsQ0FBcUI7UUFBVSxjQUFTLEdBQVQsU0FBUyxDQUFXO1FBcEJ6RSxZQUFPLEdBQUcsRUFBRSxDQUFDO1FBSVosaUJBQVksR0FBRyxJQUFJLFlBQVksRUFBYSxDQUFDO1FBQzdDLGVBQVUsR0FBRyxJQUFJLFlBQVksRUFBbUIsQ0FBQztRQUNqRCxnQkFBVyxHQUFHLElBQUksWUFBWSxFQUFTLENBQUM7UUFFeEMsYUFBUSxHQUFHLElBQUksWUFBWSxFQUFhLENBQUM7UUFDekMsY0FBUyxHQUFHLElBQUksWUFBWSxFQUFhLENBQUM7UUFDMUMsY0FBUyxHQUFHLElBQUksWUFBWSxFQUFhLENBQUM7UUFDMUMsZ0JBQVcsR0FBRyxJQUFJLFlBQVksRUFBYSxDQUFDO1FBVXBELElBQUksWUFBWSxFQUFFO1lBQ2hCLElBQUksQ0FBQyxjQUFjLEdBQUcsWUFBWSxDQUFDLGFBQWEsQ0FBQztTQUNsRDtJQUNILENBQUM7SUFYRCxzQkFDSSw0Q0FBUzs7OztRQURiO1lBRUUsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7UUFDMUIsQ0FBQzs7O09BQUE7Ozs7SUFVRCx3Q0FBUTs7O0lBQVIsY0FBWSxDQUFDOzs7OztJQUdiLDJDQUFXOzs7O0lBRFgsVUFDWSxLQUFLO1FBRGpCLGlCQWtEQztRQWhEQyxLQUFLLEdBQUcsS0FBSyxDQUFDLGFBQWEsSUFBSSxLQUFLLENBQUM7UUFDckMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbkIsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELElBQUksQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDeEMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDOztZQUNyQyxRQUFRLEdBQUcsU0FBUyxHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDM0csbUVBQW1FO1FBQ25FLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLGdCQUFnQixJQUFJLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRTNFLEtBQUssQ0FBQyxZQUFZLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDLDRCQUE0QjtRQUNwRyxJQUFJO1lBQ0YsS0FBSyxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7U0FDekU7UUFBQyxPQUFPLENBQUMsRUFBRTs7Z0JBQ0osSUFBSSxHQUFHO2dCQUNYLElBQUksRUFBRSxJQUFJLENBQUMsWUFBWTtnQkFDdkIsSUFBSSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFO2FBQ3JDO1lBRUQsSUFBSTtnQkFDRiwwRUFBMEU7Z0JBQzFFLEtBQUssQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7YUFFbEU7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFDVixxRkFBcUY7Z0JBQ3JGLHdGQUF3RjtnQkFDeEYsMkRBQTJEO2dCQUMzRCxLQUFLLENBQUMsWUFBWSxDQUFDLGFBQWEsR0FBRyxNQUFNLENBQUM7Z0JBQzFDLEtBQUssQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7YUFDbEU7U0FDRjtRQUNELElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDNUQsVUFBVTs7O1FBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLEtBQUksQ0FBQyxjQUFjLEVBQUUsbUJBQW1CLENBQUMsRUFBakUsQ0FBaUUsR0FBRSxDQUFDLENBQUMsQ0FBQztRQUN2RixtRkFBbUY7UUFDbkYsSUFBSSxLQUFLLENBQUMsVUFBVSxJQUFJLEtBQUssQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFO1lBQ3ZELEtBQUssQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQzVEO1FBQ0QsZ0VBQWdFO1FBQ2hFLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTlCLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTs7Z0JBQ2QsVUFBUSxHQUFHLElBQUksQ0FBQyxXQUFXO1lBQ2pDLElBQUksQ0FBQyxXQUFXLENBQUMsZUFBZTs7OztZQUFDLFVBQVUsTUFBTTtnQkFDL0MsT0FBTyxVQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDMUIsQ0FBQyxFQUFDLENBQUM7U0FDSjtRQUNELEtBQUssQ0FBQyxlQUFlLEVBQUUsQ0FBQztJQUMxQixDQUFDOzs7OztJQUdELHlDQUFTOzs7O0lBRFQsVUFDVSxLQUFnQjtRQUQxQixpQkFvQkM7O1lBbEJPLFVBQVUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsRUFBRTs7WUFDN0MsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBRTtRQUMxRixJQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDO1lBQ25CLEtBQUssRUFBRSxLQUFLO1lBQ1osVUFBVSxFQUFFLFVBQVU7U0FDdkIsQ0FBQyxDQUFDO1FBRUgsV0FBVztRQUNYLElBQUksQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDeEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLG1CQUFtQixDQUFDLENBQUM7UUFDckUsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBRXhCLDRGQUE0RjtRQUM1RixVQUFVOzs7UUFBQyxjQUFNLE9BQUEsS0FBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsS0FBSSxDQUFDLGNBQWMsRUFBRSxtQkFBbUIsQ0FBQyxFQUFwRSxDQUFvRSxHQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzVGLENBQUM7Ozs7O0lBR0QscUNBQUs7Ozs7SUFETCxVQUNNLEtBQWlCO1FBQ3JCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdCLHFEQUFxRDtRQUNyRCxLQUFLLENBQUMsZUFBZSxFQUFFLENBQUM7SUFDMUIsQ0FBQzs7Z0JBbEhGLFNBQVMsU0FBQztvQkFDVCxRQUFRLEVBQUUsZ0JBQWdCO2lCQUMzQjs7OztnQkFOUSxtQkFBbUI7Z0JBRkEsU0FBUztnQkFBckIsVUFBVTs7OytCQVd2QixLQUFLOzZCQUNMLEtBQUs7MEJBQ0wsS0FBSzs4QkFDTCxLQUFLO21DQUNMLEtBQUs7K0JBRUwsTUFBTTs2QkFDTixNQUFNOzhCQUNOLE1BQU07MkJBRU4sTUFBTTs0QkFDTixNQUFNOzRCQUNOLE1BQU07OEJBQ04sTUFBTTs0QkFFTixXQUFXLFNBQUMsV0FBVzs4QkFldkIsWUFBWSxTQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQzs0QkFvRHBDLFlBQVksU0FBQyxTQUFTLEVBQUUsQ0FBQyxRQUFRLENBQUM7d0JBc0JsQyxZQUFZLFNBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDOztJQU9uQyw0QkFBQztDQUFBLEFBcEhELElBb0hDO1NBakhZLHFCQUFxQjs7O0lBRWhDLDZDQUEyQjs7SUFDM0IsMkNBQTZCOztJQUM3Qix3Q0FBc0I7O0lBQ3RCLDRDQUErQjs7SUFDL0IsaURBQWtDOztJQUVsQyw2Q0FBdUQ7O0lBQ3ZELDJDQUEyRDs7SUFDM0QsNENBQWtEOztJQUVsRCx5Q0FBbUQ7O0lBQ25ELDBDQUFvRDs7SUFDcEQsMENBQW9EOztJQUNwRCw0Q0FBc0Q7Ozs7O0lBT3RELCtDQUFnQzs7Ozs7SUFFcEIsNENBQXdDOzs7OztJQUFFLDBDQUE0QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgRGlyZWN0aXZlLCBIb3N0QmluZGluZywgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzLCBJbnB1dCwgT25Jbml0LFxyXG4gIEhvc3RMaXN0ZW5lciwgRWxlbWVudFJlZiwgUmVuZGVyZXIyLCBPdXRwdXQsIEV2ZW50RW1pdHRlclxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBEbmREcmFnZ2FibGVTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvZG5kLWRyYWdnYWJsZS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTUlNRV9UWVBFLCBFREdFX01JTUVfVFlQRSwgTVNJRV9NSU1FX1RZUEUsIEFMTF9FRkZFQ1RTIH0gZnJvbSAnLi4vZG5kLWNvbnN0YW50cyc7XHJcbmltcG9ydCB7IERuZERyYWdlbmRFdmVudCB9IGZyb20gJy4uL21vZGVscy9ldmVudHMnO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgc2VsZWN0b3I6ICdbZG5kRHJhZ2dhYmxlXScsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBEbmREcmFnZ2FibGVEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQge1xyXG5cclxuICBASW5wdXQoKSBkbmREcmFnZ2FibGU6IGFueTtcclxuICBASW5wdXQoKSBkbmREaXNhYmxlOiBib29sZWFuO1xyXG4gIEBJbnB1dCgpIGRuZFR5cGUgPSAnJztcclxuICBASW5wdXQoKSBkbmRDYWxsYmFjazogRnVuY3Rpb247XHJcbiAgQElucHV0KCkgZG5kRWZmZWN0QWxsb3dlZDogc3RyaW5nO1xyXG5cclxuICBAT3V0cHV0KCkgZG5kRHJhZ3N0YXJ0ID0gbmV3IEV2ZW50RW1pdHRlcjxEcmFnRXZlbnQ+KCk7XHJcbiAgQE91dHB1dCgpIGRuZERyYWdlbmQgPSBuZXcgRXZlbnRFbWl0dGVyPERuZERyYWdlbmRFdmVudD4oKTtcclxuICBAT3V0cHV0KCkgZG5kU2VsZWN0ZWQgPSBuZXcgRXZlbnRFbWl0dGVyPEV2ZW50PigpO1xyXG5cclxuICBAT3V0cHV0KCkgZG5kTW92ZWQgPSBuZXcgRXZlbnRFbWl0dGVyPERyYWdFdmVudD4oKTtcclxuICBAT3V0cHV0KCkgZG5kQ29waWVkID0gbmV3IEV2ZW50RW1pdHRlcjxEcmFnRXZlbnQ+KCk7XHJcbiAgQE91dHB1dCgpIGRuZExpbmtlZCA9IG5ldyBFdmVudEVtaXR0ZXI8RHJhZ0V2ZW50PigpO1xyXG4gIEBPdXRwdXQoKSBkbmRDYW5jZWxlZCA9IG5ldyBFdmVudEVtaXR0ZXI8RHJhZ0V2ZW50PigpO1xyXG5cclxuICBASG9zdEJpbmRpbmcoJ2RyYWdnYWJsZScpXHJcbiAgZ2V0IGRyYWdnYWJsZSgpIHtcclxuICAgIHJldHVybiAhdGhpcy5kbmREaXNhYmxlO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfbmF0aXZlRWxlbWVudDogRWxlbWVudDtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfZG5kU2VydmljZTogRG5kRHJhZ2dhYmxlU2VydmljZSwgcHJpdmF0ZSBfcmVuZGVyZXI6IFJlbmRlcmVyMiwgX2hvc3RFbGVtZW50OiBFbGVtZW50UmVmKSB7XHJcbiAgICBpZiAoX2hvc3RFbGVtZW50KSB7XHJcbiAgICAgIHRoaXMuX25hdGl2ZUVsZW1lbnQgPSBfaG9zdEVsZW1lbnQubmF0aXZlRWxlbWVudDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCkge31cclxuXHJcbiAgQEhvc3RMaXN0ZW5lcignZHJhZ3N0YXJ0JywgWyckZXZlbnQnXSlcclxuICBvbkRyYWdTdGFydChldmVudCkge1xyXG4gICAgZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50IHx8IGV2ZW50O1xyXG4gICAgaWYgKCF0aGlzLmRyYWdnYWJsZSkge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICAgIHRoaXMuX2RuZFNlcnZpY2Uuc2V0RHJhZ2dpbmdTdGF0ZSh0cnVlKTtcclxuICAgIHRoaXMuX2RuZFNlcnZpY2Uuc2V0SXRlbVR5cGUodGhpcy5kbmRUeXBlKTtcclxuICAgIGNvbnN0IG1pbWVUeXBlID0gTUlNRV9UWVBFICsgKHRoaXMuX2RuZFNlcnZpY2UuZ2V0SXRlbVR5cGUoKSA/ICgnLScgKyB0aGlzLl9kbmRTZXJ2aWNlLmdldEl0ZW1UeXBlKCkpIDogJycpO1xyXG4gICAgLy8gU2V0IHRoZSBhbGxvd2VkIGRyb3AgZWZmZWN0cy4gU2VlIGJlbG93IGZvciBzcGVjaWFsIElFIGhhbmRsaW5nLlxyXG4gICAgdGhpcy5fZG5kU2VydmljZS5zZXREcm9wRWZmZWN0KCdub25lJyk7XHJcbiAgICB0aGlzLl9kbmRTZXJ2aWNlLnNldEVmZmVjdEFsbG93ZWQodGhpcy5kbmRFZmZlY3RBbGxvd2VkIHx8IEFMTF9FRkZFQ1RTWzBdKTtcclxuXHJcbiAgICBldmVudC5kYXRhVHJhbnNmZXIuZWZmZWN0QWxsb3dlZCA9IHRoaXMuX2RuZFNlcnZpY2UuZ2V0RWZmZWN0QWxsb3dlZCgpOyAvLyBUT0RPOiBzZXQgYWxsb3dlZCBlZmZlY3RzXHJcbiAgICB0cnkge1xyXG4gICAgICBldmVudC5kYXRhVHJhbnNmZXIuc2V0RGF0YShtaW1lVHlwZSwgSlNPTi5zdHJpbmdpZnkodGhpcy5kbmREcmFnZ2FibGUpKTtcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgY29uc3QgZGF0YSA9IHtcclxuICAgICAgICBpdGVtOiB0aGlzLmRuZERyYWdnYWJsZSxcclxuICAgICAgICB0eXBlOiB0aGlzLl9kbmRTZXJ2aWNlLmdldEl0ZW1UeXBlKClcclxuICAgICAgfTtcclxuXHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgLy8gU2V0dGluZyBhIGN1c3RvbSBNSU1FIHR5cGUgZGlkIG5vdCB3b3JrLCB3ZSBhcmUgcHJvYmFibHkgaW4gSUUgb3IgRWRnZS5cclxuICAgICAgICBldmVudC5kYXRhVHJhbnNmZXIuc2V0RGF0YShFREdFX01JTUVfVFlQRSwgSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xyXG5cclxuICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgIC8vIFdlIGFyZSBpbiBJbnRlcm5ldCBFeHBsb3JlciBhbmQgY2FuIG9ubHkgdXNlIHRoZSBUZXh0IE1JTUUgdHlwZS4gQWxzbyBub3RlIHRoYXQgSUVcclxuICAgICAgICAvLyBkb2VzIG5vdCBhbGxvdyBjaGFuZ2luZyB0aGUgY3Vyc29yIGluIHRoZSBkcmFnb3ZlciBldmVudCwgdGhlcmVmb3JlIHdlIGhhdmUgdG8gY2hvb3NlXHJcbiAgICAgICAgLy8gdGhlIG9uZSB3ZSB3YW50IHRvIGRpc3BsYXkgbm93IGJ5IHNldHRpbmcgZWZmZWN0QWxsb3dlZC5cclxuICAgICAgICBldmVudC5kYXRhVHJhbnNmZXIuZWZmZWN0QWxsb3dlZCA9ICdtb3ZlJztcclxuICAgICAgICBldmVudC5kYXRhVHJhbnNmZXIuc2V0RGF0YShNU0lFX01JTUVfVFlQRSwgSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICB0aGlzLl9yZW5kZXJlci5hZGRDbGFzcyh0aGlzLl9uYXRpdmVFbGVtZW50LCAnZG5kRHJhZ2dpbmcnKTtcclxuICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fcmVuZGVyZXIuYWRkQ2xhc3ModGhpcy5fbmF0aXZlRWxlbWVudCwgJ2RuZERyYWdnaW5nU291cmNlJyksIDApO1xyXG4gICAgLy8gVHJ5IHNldHRpbmcgYSBwcm9wZXIgZHJhZyBpbWFnZSBpZiB0cmlnZ2VyZWQgb24gYSBkbmQtaGFuZGxlICh3b24ndCB3b3JrIGluIElFKS5cclxuICAgIGlmIChldmVudC5fZG5kSGFuZGxlICYmIGV2ZW50LmRhdGFUcmFuc2Zlci5zZXREcmFnSW1hZ2UpIHtcclxuICAgICAgZXZlbnQuZGF0YVRyYW5zZmVyLnNldERyYWdJbWFnZSh0aGlzLl9uYXRpdmVFbGVtZW50LCAwLCAwKTtcclxuICAgIH1cclxuICAgIC8vIEVtaXQgZHJhZ3N0YXJ0IGV2ZW50IGFuZCBwcmVwYXJlIGV4dHJhIGNhbGxiYWNrIGZvciBkcm9wem9uZS5cclxuICAgIHRoaXMuZG5kRHJhZ3N0YXJ0LmVtaXQoZXZlbnQpO1xyXG5cclxuICAgIGlmICh0aGlzLmRuZENhbGxiYWNrKSB7XHJcbiAgICAgIGNvbnN0IGNhbGxiYWNrID0gdGhpcy5kbmRDYWxsYmFjaztcclxuICAgICAgdGhpcy5fZG5kU2VydmljZS5zZXREcm9wQ2FsbGJhY2soZnVuY3Rpb24gKHBhcmFtcykge1xyXG4gICAgICAgIHJldHVybiBjYWxsYmFjayhwYXJhbXMpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gIH1cclxuXHJcbiAgQEhvc3RMaXN0ZW5lcignZHJhZ2VuZCcsIFsnJGV2ZW50J10pXHJcbiAgb25EcmFnRW5kKGV2ZW50OiBEcmFnRXZlbnQpIHtcclxuICAgIGNvbnN0IGRyb3BFZmZlY3QgPSB0aGlzLl9kbmRTZXJ2aWNlLmdldERyb3BFZmZlY3QoKTtcclxuICAgIGNvbnN0IGNiID0geyBjb3B5OiAnZG5kQ29waWVkJywgbGluazogJ2RuZExpbmtlZCcsIG1vdmU6ICdkbmRNb3ZlZCcsIG5vbmU6ICdkbmRDYW5jZWxlZCcgfTtcclxuICAgIHRoaXNbY2JbZHJvcEVmZmVjdF1dLmVtaXQoZXZlbnQpO1xyXG4gICAgdGhpcy5kbmREcmFnZW5kLmVtaXQoe1xyXG4gICAgICBldmVudDogZXZlbnQsXHJcbiAgICAgIGRyb3BFZmZlY3Q6IGRyb3BFZmZlY3RcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIENsZWFuIHVwXHJcbiAgICB0aGlzLl9kbmRTZXJ2aWNlLnNldERyYWdnaW5nU3RhdGUoZmFsc2UpO1xyXG4gICAgdGhpcy5fZG5kU2VydmljZS5zZXREcm9wQ2FsbGJhY2sodW5kZWZpbmVkKTtcclxuICAgIHRoaXMuX2RuZFNlcnZpY2Uuc2V0UmVtb3ZlT25Ecm9wKGZhbHNlKTtcclxuICAgIHRoaXMuX3JlbmRlcmVyLnJlbW92ZUNsYXNzKHRoaXMuX25hdGl2ZUVsZW1lbnQsICdkbmREcmFnZ2luZycpO1xyXG4gICAgdGhpcy5fcmVuZGVyZXIucmVtb3ZlQ2xhc3ModGhpcy5fbmF0aXZlRWxlbWVudCwgJ2RuZERyYWdnaW5nU291cmNlJyk7XHJcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHJcbiAgICAvLyBJbiBJRTkgaXQgaXMgcG9zc2libGUgdGhhdCB0aGUgdGltZW91dCBmcm9tIGRyYWdzdGFydCB0cmlnZ2VycyBhZnRlciB0aGUgZHJhZ2VuZCBoYW5kbGVyLlxyXG4gICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLl9yZW5kZXJlci5yZW1vdmVDbGFzcyh0aGlzLl9uYXRpdmVFbGVtZW50LCAnZG5kRHJhZ2dpbmdTb3VyY2UnKSwgMCk7XHJcbiAgfVxyXG5cclxuICBASG9zdExpc3RlbmVyKCdjbGljaycsIFsnJGV2ZW50J10pXHJcbiAgY2xpY2soZXZlbnQ6IE1vdXNlRXZlbnQpIHtcclxuICAgIHRoaXMuZG5kU2VsZWN0ZWQuZW1pdChldmVudCk7XHJcbiAgICAvLyBQcmV2ZW50IHRyaWdnZXJpbmcgZG5kU2VsZWN0ZWQgaW4gcGFyZW50IGVsZW1lbnRzLlxyXG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=