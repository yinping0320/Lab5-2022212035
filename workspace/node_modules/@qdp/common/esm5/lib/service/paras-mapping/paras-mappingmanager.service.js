/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
// import 'rxjs/add/operator/map';
import { Injectable, Inject } from '@angular/core';
import { map } from 'rxjs/operators';
import { Subject } from 'rxjs';
import { SessionService } from '@ecp-caf/caf-common';
import { RestfulService } from '../restful-service/restful.service';
import { Server_Host } from '../../entitties/server.host';
import { RtfServices } from '../rtfservices/rtfservices';
var ParasMappingManagerService = /** @class */ (function () {
    function ParasMappingManagerService(restService, sessionService, host) {
        this.restService = restService;
        this.sessionService = sessionService;
        this.host = host;
        this.uri = '/api/runtime/bcc/v1.0/qdpparasmapping/';
        this.parasmappingInfoChange = new Subject();
        this.parasmappingInfoList = {};
    }
    /**
     * 获取查询参数映射信息
     * @param id 数据源ID
     * @param queryId 查询编号
     */
    /**
     * 获取查询参数映射信息
     * @param {?} id 数据源ID
     * @param {?} queryId 查询编号
     * @param {?} queryRelativeUrl
     * @param {?=} type
     * @return {?}
     */
    ParasMappingManagerService.prototype.getParasMapping = /**
     * 获取查询参数映射信息
     * @param {?} id 数据源ID
     * @param {?} queryId 查询编号
     * @param {?} queryRelativeUrl
     * @param {?=} type
     * @return {?}
     */
    function (id, queryId, queryRelativeUrl, type) {
        if (type === void 0) { type = 0; }
        /** @type {?} */
        var result$ = this.getParasMappingList(queryId, id, '', '', queryRelativeUrl, type);
        return result$.pipe(map((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            if (value && value[id]) {
                return value[id];
            }
            else {
                return null;
            }
        })));
    };
    /**
     * 获取参数映射列表
     * @param queryId 查询编号
     * @param userId 用户ID
     * @param languageType 语言类型
     */
    /**
     * 获取参数映射列表
     * @param {?} queryId 查询编号
     * @param {?} datasourceId
     * @param {?} userId 用户ID
     * @param {?} languageType 语言类型
     * @param {?} queryRelativeUrl
     * @param {?=} queryType
     * @return {?}
     */
    ParasMappingManagerService.prototype.getParasMappingList = /**
     * 获取参数映射列表
     * @param {?} queryId 查询编号
     * @param {?} datasourceId
     * @param {?} userId 用户ID
     * @param {?} languageType 语言类型
     * @param {?} queryRelativeUrl
     * @param {?=} queryType
     * @return {?}
     */
    function (queryId, datasourceId, userId, languageType, queryRelativeUrl, queryType) {
        var _this = this;
        if (queryType === void 0) { queryType = 0; }
        /** @type {?} */
        var restUri = this.host + this.uri + 'getparasmappinglist';
        /** @type {?} */
        var result$ = this.restService.get(restUri, { queryId: queryId, datasourceId: datasourceId, userId: userId, languageType: languageType, queryType: queryType }, this.createHeaderSessionId());
        return result$.pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            if (data && data.length) {
                data.forEach((/**
                 * @param {?} element
                 * @return {?}
                 */
                function (element) {
                    element.parasmapping = JSON.parse(element.parasmapping);
                    _this.parasmappingInfoList[element.datasourceid] = element;
                }));
                _this.parasmappingInfoChange.next({ parasInfoList: _this.parasmappingInfoList });
                return _this.parasmappingInfoList;
            }
            else {
                _this.parasmappingInfoChange.next({ parasInfoList: null });
                return null;
            }
        })));
    };
    /**
     * 保存参数映射
     * @param parasmapping 参数映射实体
     */
    /**
     * 保存参数映射
     * @param {?} parasmapping 参数映射实体
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    ParasMappingManagerService.prototype.saveParasMapping = /**
     * 保存参数映射
     * @param {?} parasmapping 参数映射实体
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    function (parasmapping, queryRelativeUrl) {
        var _this = this;
        /** @type {?} */
        var restUri = this.host + this.uri + 'saveparasmapping';
        /** @type {?} */
        var result$ = this.restService.post(restUri, parasmapping, {}, this.createHeaderSessionId());
        return result$.pipe(map((/**
         * @return {?}
         */
        function () {
            parasmapping.parasmapping = JSON.parse(parasmapping.parasmapping);
            if (Object.keys(_this.parasmappingInfoList).indexOf(parasmapping.datasourceid)) {
                _this.parasmappingInfoList[parasmapping.datasourceid] = parasmapping;
            }
        })));
    };
    /**
     * 删除方案
     * @param id 方案ID
     * @param queryId 查询编号
     */
    /**
     * 删除方案
     * @param {?} datasourceid
     * @param {?} queryId 查询编号
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    ParasMappingManagerService.prototype.deleteParasMapping = /**
     * 删除方案
     * @param {?} datasourceid
     * @param {?} queryId 查询编号
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    function (datasourceid, queryId, queryRelativeUrl) {
        var _this = this;
        /** @type {?} */
        var restUri = this.host + this.uri + 'deleteparasmapping';
        /** @type {?} */
        var result$ = this.restService.delete(restUri, { datasourceId: datasourceid, queryId: queryId }, this.createHeaderSessionId());
        return result$.pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            if (data === true) {
                _this.parasmappingInfoList[datasourceid] = null;
            }
            else {
                return false;
            }
        })));
    };
    /**
     * 获取元数据信息
     * @param Id metadataid
     */
    /**
     * 获取元数据信息
     * @param {?} Id metadataid
     * @return {?}
     */
    ParasMappingManagerService.prototype.getMetaDataInfoById = /**
     * 获取元数据信息
     * @param {?} Id metadataid
     * @return {?}
     */
    function (Id) {
        /** @type {?} */
        var restUri = this.host + '/api/runtime/lcm/v1.0/rt-metadatas/' + Id;
        /** @type {?} */
        var result$ = this.restService.get(restUri, {}, this.createHeaderSessionId());
        return result$.pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            if (data) {
                return data;
            }
            else {
                return null;
            }
        })));
    };
    /**
     * @private
     * @return {?}
     */
    ParasMappingManagerService.prototype.createHeaderSessionId = /**
     * @private
     * @return {?}
     */
    function () {
        return RtfServices.createHeaderSessionId(this.sessionService);
    };
    ParasMappingManagerService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ParasMappingManagerService.ctorParameters = function () { return [
        { type: RestfulService },
        { type: SessionService },
        { type: String, decorators: [{ type: Inject, args: [Server_Host,] }] }
    ]; };
    return ParasMappingManagerService;
}());
export { ParasMappingManagerService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    ParasMappingManagerService.prototype.uri;
    /** @type {?} */
    ParasMappingManagerService.prototype.parasmappingInfoChange;
    /** @type {?} */
    ParasMappingManagerService.prototype.parasmappingInfoList;
    /**
     * @type {?}
     * @private
     */
    ParasMappingManagerService.prototype.restService;
    /**
     * @type {?}
     * @private
     */
    ParasMappingManagerService.prototype.sessionService;
    /**
     * @type {?}
     * @private
     */
    ParasMappingManagerService.prototype.host;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyYXMtbWFwcGluZ21hbmFnZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BxZHAvY29tbW9uLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2UvcGFyYXMtbWFwcGluZy9wYXJhcy1tYXBwaW5nbWFuYWdlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JDLE9BQU8sRUFBYyxPQUFPLEVBQU0sTUFBTSxNQUFNLENBQUM7QUFDL0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUNwRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDMUQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRXpEO0lBT0Usb0NBQW9CLFdBQTJCLEVBQVUsY0FBOEIsRUFBK0IsSUFBWTtRQUE5RyxnQkFBVyxHQUFYLFdBQVcsQ0FBZ0I7UUFBVSxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFBK0IsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUwxSCxRQUFHLEdBQUcsd0NBQXdDLENBQUM7UUFDdkQsMkJBQXNCLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQUU1Qyx5QkFBb0IsR0FBUSxFQUFFLENBQUM7SUFHL0IsQ0FBQztJQUVEOzs7O09BSUc7Ozs7Ozs7OztJQUNILG9EQUFlOzs7Ozs7OztJQUFmLFVBQWdCLEVBQVUsRUFBRSxPQUFlLEVBQUUsZ0JBQXFCLEVBQUUsSUFBZ0I7UUFBaEIscUJBQUEsRUFBQSxRQUFnQjs7WUFDNUUsT0FBTyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLEVBQUUsRUFBRSxFQUFFLEVBQUUs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QUM7O2dCQTdHRixVQUFVOzs7O2dCQUpGLGNBQWM7Z0JBRGQsY0FBYzs2Q0FZcUUsTUFBTSxTQUFDLFdBQVc7O0lBdUc5RyxpQ0FBQztDQUFBLEFBOUdELElBOEdDO1NBN0dZLDBCQUEwQjs7Ozs7O0lBQ3JDLHlDQUF1RDs7SUFDdkQsNERBQTRDOztJQUU1QywwREFBK0I7Ozs7O0lBRW5CLGlEQUFtQzs7Ozs7SUFBRSxvREFBc0M7Ozs7O0lBQUUsMENBQXlDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9tYXAnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBTZXNzaW9uU2VydmljZSB9IGZyb20gJ0BlY3AtY2FmL2NhZi1jb21tb24nO1xyXG5pbXBvcnQgeyBSZXN0ZnVsU2VydmljZSB9IGZyb20gJy4uL3Jlc3RmdWwtc2VydmljZS9yZXN0ZnVsLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBTZXJ2ZXJfSG9zdCB9IGZyb20gJy4uLy4uL2VudGl0dGllcy9zZXJ2ZXIuaG9zdCc7XHJcbmltcG9ydCB7IFJ0ZlNlcnZpY2VzIH0gZnJvbSAnLi4vcnRmc2VydmljZXMvcnRmc2VydmljZXMnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgUGFyYXNNYXBwaW5nTWFuYWdlclNlcnZpY2Uge1xyXG4gIHByaXZhdGUgdXJpID0gJy9hcGkvcnVudGltZS9iY2MvdjEuMC9xZHBwYXJhc21hcHBpbmcvJztcclxuICBwYXJhc21hcHBpbmdJbmZvQ2hhbmdlID0gbmV3IFN1YmplY3Q8YW55PigpO1xyXG5cclxuICBwYXJhc21hcHBpbmdJbmZvTGlzdDogYW55ID0ge307XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVzdFNlcnZpY2U6IFJlc3RmdWxTZXJ2aWNlLCBwcml2YXRlIHNlc3Npb25TZXJ2aWNlOiBTZXNzaW9uU2VydmljZSwgQEluamVjdChTZXJ2ZXJfSG9zdCkgcHJpdmF0ZSBob3N0OiBzdHJpbmcpIHtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluafpeivouWPguaVsOaYoOWwhOS/oeaBr1xyXG4gICAqIEBwYXJhbSBpZCDmlbDmja7mupBJRFxyXG4gICAqIEBwYXJhbSBxdWVyeUlkIOafpeivoue8luWPt1xyXG4gICAqL1xyXG4gIGdldFBhcmFzTWFwcGluZyhpZDogc3RyaW5nLCBxdWVyeUlkOiBzdHJpbmcsIHF1ZXJ5UmVsYXRpdmVVcmw6IGFueSwgdHlwZTogbnVtYmVyID0gMCk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCByZXN1bHQkID0gdGhpcy5nZXRQYXJhc01hcHBpbmdMaXN0KHF1ZXJ5SWQsIGlkLCAnJywgJycsIHF1ZXJ5UmVsYXRpdmVVcmwsIHR5cGUpO1xyXG4gICAgcmV0dXJuIHJlc3VsdCQucGlwZShcclxuICAgICAgbWFwKHZhbHVlID0+IHtcclxuICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWVbaWRdKSB7XHJcbiAgICAgICAgICByZXR1cm4gdmFsdWVbaWRdO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5Y+C5pWw5pig5bCE5YiX6KGoXHJcbiAgICogQHBhcmFtIHF1ZXJ5SWQg5p+l6K+i57yW5Y+3XHJcbiAgICogQHBhcmFtIHVzZXJJZCDnlKjmiLdJRFxyXG4gICAqIEBwYXJhbSBsYW5ndWFnZVR5cGUg6K+t6KiA57G75Z6LXHJcbiAgICovXHJcbiAgZ2V0UGFyYXNNYXBwaW5nTGlzdChxdWVyeUlkOiBzdHJpbmcsIGRhdGFzb3VyY2VJZDogYW55LCB1c2VySWQ6IHN0cmluZywgbGFuZ3VhZ2VUeXBlOiBzdHJpbmcsIHF1ZXJ5UmVsYXRpdmVVcmw6IGFueSwgcXVlcnlUeXBlOiBudW1iZXIgPSAwKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHJlc3RVcmkgPSB0aGlzLmhvc3QgKyB0aGlzLnVyaSArICdnZXRwYXJhc21hcHBpbmdsaXN0JztcclxuICAgIGNvbnN0IHJlc3VsdCQgPSB0aGlzLnJlc3RTZXJ2aWNlLmdldChyZXN0VXJpLCB7IHF1ZXJ5SWQsIGRhdGFzb3VyY2VJZCwgdXNlcklkLCBsYW5ndWFnZVR5cGUsIHF1ZXJ5VHlwZSB9LCB0aGlzLmNyZWF0ZUhlYWRlclNlc3Npb25JZCgpKTtcclxuICAgIHJldHVybiByZXN1bHQkLnBpcGUoXHJcbiAgICAgIG1hcCgoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5sZW5ndGgpIHtcclxuICAgICAgICAgIGRhdGEuZm9yRWFjaCgoZWxlbWVudDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGVsZW1lbnQucGFyYXNtYXBwaW5nID0gSlNPTi5wYXJzZShlbGVtZW50LnBhcmFzbWFwcGluZyk7XHJcbiAgICAgICAgICAgIHRoaXMucGFyYXNtYXBwaW5nSW5mb0xpc3RbZWxlbWVudC5kYXRhc291cmNlaWRdID0gZWxlbWVudDtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgdGhpcy5wYXJhc21hcHBpbmdJbmZvQ2hhbmdlLm5leHQoeyBwYXJhc0luZm9MaXN0OiB0aGlzLnBhcmFzbWFwcGluZ0luZm9MaXN0IH0pO1xyXG4gICAgICAgICAgcmV0dXJuIHRoaXMucGFyYXNtYXBwaW5nSW5mb0xpc3Q7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMucGFyYXNtYXBwaW5nSW5mb0NoYW5nZS5uZXh0KHsgcGFyYXNJbmZvTGlzdDogbnVsbCB9KTtcclxuICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOS/neWtmOWPguaVsOaYoOWwhFxyXG4gICAqIEBwYXJhbSBwYXJhc21hcHBpbmcg5Y+C5pWw5pig5bCE5a6e5L2TXHJcbiAgICovXHJcbiAgc2F2ZVBhcmFzTWFwcGluZyhwYXJhc21hcHBpbmc6IGFueSwgcXVlcnlSZWxhdGl2ZVVybDogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHJlc3RVcmkgPSB0aGlzLmhvc3QgKyB0aGlzLnVyaSArICdzYXZlcGFyYXNtYXBwaW5nJztcclxuICAgIGNvbnN0IHJlc3VsdCQgPSB0aGlzLnJlc3RTZXJ2aWNlLnBvc3QocmVzdFVyaSwgcGFyYXNtYXBwaW5nLCB7fSwgdGhpcy5jcmVhdGVIZWFkZXJTZXNzaW9uSWQoKSk7XHJcbiAgICByZXR1cm4gcmVzdWx0JC5waXBlKFxyXG4gICAgICBtYXAoKCkgPT4ge1xyXG4gICAgICAgIHBhcmFzbWFwcGluZy5wYXJhc21hcHBpbmcgPSBKU09OLnBhcnNlKHBhcmFzbWFwcGluZy5wYXJhc21hcHBpbmcpO1xyXG4gICAgICAgIGlmIChPYmplY3Qua2V5cyh0aGlzLnBhcmFzbWFwcGluZ0luZm9MaXN0KS5pbmRleE9mKHBhcmFzbWFwcGluZy5kYXRhc291cmNlaWQpKSB7XHJcbiAgICAgICAgICB0aGlzLnBhcmFzbWFwcGluZ0luZm9MaXN0W3BhcmFzbWFwcGluZy5kYXRhc291cmNlaWRdID0gcGFyYXNtYXBwaW5nO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWIoOmZpOaWueahiFxyXG4gICAqIEBwYXJhbSBpZCDmlrnmoYhJRFxyXG4gICAqIEBwYXJhbSBxdWVyeUlkIOafpeivoue8luWPt1xyXG4gICAqL1xyXG4gIGRlbGV0ZVBhcmFzTWFwcGluZyhkYXRhc291cmNlaWQ6IHN0cmluZywgcXVlcnlJZDogc3RyaW5nLCBxdWVyeVJlbGF0aXZlVXJsOiBhbnkpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3QgcmVzdFVyaSA9IHRoaXMuaG9zdCArIHRoaXMudXJpICsgJ2RlbGV0ZXBhcmFzbWFwcGluZyc7XHJcbiAgICBjb25zdCByZXN1bHQkID0gdGhpcy5yZXN0U2VydmljZS5kZWxldGUocmVzdFVyaSwgeyBkYXRhc291cmNlSWQ6IGRhdGFzb3VyY2VpZCwgcXVlcnlJZCB9LCB0aGlzLmNyZWF0ZUhlYWRlclNlc3Npb25JZCgpKTtcclxuICAgIHJldHVybiByZXN1bHQkLnBpcGUoXHJcbiAgICAgIG1hcCgoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKGRhdGEgPT09IHRydWUpIHtcclxuICAgICAgICAgIHRoaXMucGFyYXNtYXBwaW5nSW5mb0xpc3RbZGF0YXNvdXJjZWlkXSA9IG51bGw7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5YWD5pWw5o2u5L+h5oGvXHJcbiAgICogQHBhcmFtIElkIG1ldGFkYXRhaWRcclxuICAgKi9cclxuICBnZXRNZXRhRGF0YUluZm9CeUlkKElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3QgcmVzdFVyaSA9IHRoaXMuaG9zdCArICcvYXBpL3J1bnRpbWUvbGNtL3YxLjAvcnQtbWV0YWRhdGFzLycgKyBJZDtcclxuICAgIGNvbnN0IHJlc3VsdCQgPSB0aGlzLnJlc3RTZXJ2aWNlLmdldChyZXN0VXJpLCB7fSwgdGhpcy5jcmVhdGVIZWFkZXJTZXNzaW9uSWQoKSk7XHJcblxyXG4gICAgcmV0dXJuIHJlc3VsdCQucGlwZShcclxuICAgICAgbWFwKChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgICBpZiAoZGF0YSkge1xyXG4gICAgICAgICAgcmV0dXJuIGRhdGE7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNyZWF0ZUhlYWRlclNlc3Npb25JZCgpIHtcclxuICAgIHJldHVybiBSdGZTZXJ2aWNlcy5jcmVhdGVIZWFkZXJTZXNzaW9uSWQodGhpcy5zZXNzaW9uU2VydmljZSk7XHJcbiAgfVxyXG59XHJcbiJdfQ==