/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
// import 'rxjs/add/operator/map';
import { Injectable, Inject } from '@angular/core';
import { map } from 'rxjs/operators';
import { Subject } from 'rxjs';
import { SessionService } from '@ecp-caf/caf-common';
import { RestfulService } from '../restful-service/restful.service';
import { Server_Host } from '../../entitties/server.host';
import { RtfServices } from '../rtfservices/rtfservices';
var JointSearchManagerService = /** @class */ (function () {
    function JointSearchManagerService(restService, sessionService, host) {
        this.restService = restService;
        this.sessionService = sessionService;
        this.host = host;
        this.uri = '/api/runtime/bcc/v1.0/joinsearch/';
        this.localUri = '/api/runtime/sys/v1.0/loginInfo';
        this.lcpUri = '/api/runtime/bcc/v1.0/qdpsearch/';
        this.jointsearchInfoChange = new Subject();
        this.jointsearchInfoList = {};
        // this.uri = this.host + this.uri;
    }
    /**
     * 获取查询参数映射信息
     * @param formid 表单ID
     * @param queryId 查询编号
     */
    /**
     * 获取查询参数映射信息
     * @param {?} formId
     * @param {?} queryId 查询编号
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    JointSearchManagerService.prototype.getjointsearch = /**
     * 获取查询参数映射信息
     * @param {?} formId
     * @param {?} queryId 查询编号
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    function (formId, queryId, queryRelativeUrl) {
        /** @type {?} */
        var result$ = this.getjointsearchList(formId, queryId, '', '', queryRelativeUrl);
        return result$.pipe(map((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            if (value && value[formId + queryId]) {
                return value[formId + queryId];
            }
            else {
                return null;
            }
        })));
    };
    /**
     * @param {?} visibleJointParam
     * @param {?} queryRelativeUrl
     * @param {?} searchList
     * @return {?}
     */
    JointSearchManagerService.prototype.getVisibleJoint = /**
     * @param {?} visibleJointParam
     * @param {?} queryRelativeUrl
     * @param {?} searchList
     * @return {?}
     */
    function (visibleJointParam, queryRelativeUrl, searchList) {
        /** @type {?} */
        var jointUri = this.host + (!queryRelativeUrl ? this.lcpUri : queryRelativeUrl) + 'visiblejoint';
        /** @type {?} */
        var result$ = this.restService.put(jointUri, { 'Param': visibleJointParam }, {}, this.createHeaderSessionId());
        return result$.pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            var e_1, _a, e_2, _b;
            /** @type {?} */
            var jointSearchList = [];
            if (data) {
                data = !queryRelativeUrl ? data : data.returnValue;
                if (!queryRelativeUrl) {
                    try {
                        for (var searchList_1 = tslib_1.__values(searchList), searchList_1_1 = searchList_1.next(); !searchList_1_1.done; searchList_1_1 = searchList_1.next()) {
                            var search = searchList_1_1.value;
                            if (data[search.id] !== null && data[search.id] === true) {
                                jointSearchList.push(search);
                            }
                        }
                    }
                    catch (e_1_1) { e_1 = { error: e_1_1 }; }
                    finally {
                        try {
                            if (searchList_1_1 && !searchList_1_1.done && (_a = searchList_1.return)) _a.call(searchList_1);
                        }
                        finally { if (e_1) throw e_1.error; }
                    }
                }
                else {
                    var _loop_1 = function (search) {
                        /** @type {?} */
                        var item = data.find((/**
                         * @param {?} d
                         * @return {?}
                         */
                        function (d) { return d.id === search.id; }));
                        if (item && item.visible === true) {
                            jointSearchList.push(search);
                        }
                    };
                    try {
                        for (var searchList_2 = tslib_1.__values(searchList), searchList_2_1 = searchList_2.next(); !searchList_2_1.done; searchList_2_1 = searchList_2.next()) {
                            var search = searchList_2_1.value;
                            _loop_1(search);
                        }
                    }
                    catch (e_2_1) { e_2 = { error: e_2_1 }; }
                    finally {
                        try {
                            if (searchList_2_1 && !searchList_2_1.done && (_b = searchList_2.return)) _b.call(searchList_2);
                        }
                        finally { if (e_2) throw e_2.error; }
                    }
                }
            }
            return jointSearchList;
        })));
    };
    /**
     * 获取参数映射列表
     * @param queryId 查询编号
     * @param userId 用户ID
     * @param languageType 语言类型
     */
    /**
     * 获取参数映射列表
     * @param {?} formId
     * @param {?} queryId 查询编号
     * @param {?} userId 用户ID
     * @param {?} languageType 语言类型
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    JointSearchManagerService.prototype.getjointsearchList = /**
     * 获取参数映射列表
     * @param {?} formId
     * @param {?} queryId 查询编号
     * @param {?} userId 用户ID
     * @param {?} languageType 语言类型
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    function (formId, queryId, userId, languageType, queryRelativeUrl) {
        var _this = this;
        /** @type {?} */
        var restUri = this.host + this.uri + 'getjoinsearch';
        /** @type {?} */
        var result$ = this.restService.get(restUri, { formId: formId, queryId: queryId, userId: userId, languageType: languageType }, this.createHeaderSessionId());
        return result$.pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            // this.jointsearchInfoList = {};
            if (data && data.length) {
                data.forEach((/**
                 * @param {?} element
                 * @return {?}
                 */
                function (element) {
                    _this.jointsearchInfoList[element.formId + element.queryId] = element;
                }));
                _this.jointsearchInfoChange.next({ jointsearchInfoList: _this.jointsearchInfoList });
                return _this.jointsearchInfoList;
            }
            else {
                _this.jointsearchInfoChange.next({ jointsearchInfoList: null });
                return null;
            }
        })));
    };
    /**
     * 保存参数映射
     * @param jointsearch 参数映射实体
     */
    /**
     * 保存参数映射
     * @param {?} jointsearch 参数映射实体
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    JointSearchManagerService.prototype.savejointsearch = /**
     * 保存参数映射
     * @param {?} jointsearch 参数映射实体
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    function (jointsearch, queryRelativeUrl) {
        var _this = this;
        /** @type {?} */
        var restUri = this.host + this.uri + 'addjointsearch';
        /** @type {?} */
        var result$ = this.restService.post(restUri, jointsearch, {}, this.createHeaderSessionId());
        return result$.pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            if (data === true) {
                _this.jointsearchInfoList[jointsearch.FormId + jointsearch.queryId] = jointsearch;
                return true;
            }
            else {
                return false;
            }
        })));
    };
    /**
     * 删除联查
     * @param queryId 查询编号
     */
    /**
     * 删除联查
     * @param {?} formId
     * @param {?} queryId 查询编号
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    JointSearchManagerService.prototype.deletejointsearch = /**
     * 删除联查
     * @param {?} formId
     * @param {?} queryId 查询编号
     * @param {?} queryRelativeUrl
     * @return {?}
     */
    function (formId, queryId, queryRelativeUrl) {
        var _this = this;
        /** @type {?} */
        var restUri = this.host + this.uri + 'deletejointsearch';
        /** @type {?} */
        var result$ = this.restService.delete(restUri, { formId: formId, queryId: queryId }, this.createHeaderSessionId());
        return result$.pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            if (data === true) {
                _this.jointsearchInfoList[formId + queryId] = null;
                return true;
            }
            else {
                return false;
            }
        })));
    };
    /**
     * @return {?}
     */
    JointSearchManagerService.prototype.getLanguageList = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var result$ = this.restService.get(this.localUri, { infoType: 'supportedLanguage' });
        return result$.pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            return data;
        })));
    };
    /**
     * @private
     * @return {?}
     */
    JointSearchManagerService.prototype.createHeaderSessionId = /**
     * @private
     * @return {?}
     */
    function () {
        return RtfServices.createHeaderSessionId(this.sessionService);
    };
    JointSearchManagerService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    JointSearchManagerService.ctorParameters = function () { return [
        { type: RestfulService },
        { type: SessionService },
        { type: String, decorators: [{ type: Inject, args: [Server_Host,] }] }
    ]; };
    return JointSearchManagerService;
}());
export { JointSearchManagerService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    JointSearchManagerService.prototype.uri;
    /**
     * @type {?}
     * @private
     */
    JointSearchManagerService.prototype.localUri;
    /**
     * @type {?}
     * @private
     */
    JointSearchManagerService.prototype.lcpUri;
    /** @type {?} */
    JointSearchManagerService.prototype.jointsearchInfoChange;
    /** @type {?} */
    JointSearchManagerService.prototype.jointsearchInfoList;
    /**
     * @type {?}
     * @private
     */
    JointSearchManagerService.prototype.restService;
    /**
     * @type {?}
     * @private
     */
    JointSearchManagerService.prototype.sessionService;
    /**
     * @type {?}
     * @private
     */
    JointSearchManagerService.prototype.host;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiam9pbnQtc2VhcmNobWFuYWdlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHFkcC9jb21tb24vIiwic291cmNlcyI6WyJsaWIvc2VydmljZS9qb2ludC1zZWFyY2gvam9pbnQtc2VhcmNobWFuYWdlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyQyxPQUFPLEVBQWMsT0FBTyxFQUFNLE1BQU0sTUFBTSxDQUFDO0FBQy9DLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDcEUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRTFELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUV6RDtJQVNFLG1DQUFvQixXQUEyQixFQUFVLGNBQThCLEVBQStCLElBQVk7UUFBOUcsZ0JBQVcsR0FBWCxXQUFXLENBQWdCO1FBQVUsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQStCLFNBQUksR0FBSixJQUFJLENBQVE7UUFQMUgsUUFBRyxHQUFHLG1DQUFtQyxDQUFDO1FBQzFDLGFBQVEsR0FBRyxpQ0FBaUMsQ0FBQztRQUM3QyxXQUFNLEdBQUcsa0NBQWtDLENBQUM7UUFDcEQsMEJBQXFCLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQUUzQyx3QkFBbUIsR0FBUSxFQUFFLENBQUM7UUFHNUIsbUNBQW1DO0lBQ3JDLENBQUM7SUFFRDs7OztPQUlHOzs7Ozs7OztJQUNILGtEQUFjOzs7Ozs7O0lBQWQsVUFBZSxNQUFjLEVBQUUsT0FBZSxFQUFFLGdCQUFxQjs7WUFDN0QsT0FBTyxHQUFHLElBQUksQ0FBQyxrQkFBa0Is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QkFBcUIsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDaEUsQ0FBQzs7Z0JBdklGLFVBQVU7Ozs7Z0JBTEYsY0FBYztnQkFEZCxjQUFjOzZDQWVxRSxNQUFNLFNBQUMsV0FBVzs7SUErSDlHLGdDQUFDO0NBQUEsQUF4SUQsSUF3SUM7U0F2SVkseUJBQXlCOzs7Ozs7SUFDcEMsd0NBQWtEOzs7OztJQUNsRCw2Q0FBcUQ7Ozs7O0lBQ3JELDJDQUFvRDs7SUFDcEQsMERBQTJDOztJQUUzQyx3REFBOEI7Ozs7O0lBRWxCLGdEQUFtQzs7Ozs7SUFBRSxtREFBc0M7Ozs7O0lBQUUseUNBQXlDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9tYXAnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBTZXNzaW9uU2VydmljZSB9IGZyb20gJ0BlY3AtY2FmL2NhZi1jb21tb24nO1xyXG5pbXBvcnQgeyBSZXN0ZnVsU2VydmljZSB9IGZyb20gJy4uL3Jlc3RmdWwtc2VydmljZS9yZXN0ZnVsLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBTZXJ2ZXJfSG9zdCB9IGZyb20gJy4uLy4uL2VudGl0dGllcy9zZXJ2ZXIuaG9zdCc7XHJcbmltcG9ydCB7IGVsZW1lbnQgfSBmcm9tICdAYW5ndWxhci9jb3JlL3NyYy9yZW5kZXIzJztcclxuaW1wb3J0IHsgUnRmU2VydmljZXMgfSBmcm9tICcuLi9ydGZzZXJ2aWNlcy9ydGZzZXJ2aWNlcyc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBKb2ludFNlYXJjaE1hbmFnZXJTZXJ2aWNlIHtcclxuICBwcml2YXRlIHVyaSA9ICcvYXBpL3J1bnRpbWUvYmNjL3YxLjAvam9pbnNlYXJjaC8nO1xyXG4gIHByaXZhdGUgbG9jYWxVcmkgPSAnL2FwaS9ydW50aW1lL3N5cy92MS4wL2xvZ2luSW5mbyc7XHJcbiAgcHJpdmF0ZSBsY3BVcmkgPSAnL2FwaS9ydW50aW1lL2JjYy92MS4wL3FkcHNlYXJjaC8nO1xyXG4gIGpvaW50c2VhcmNoSW5mb0NoYW5nZSA9IG5ldyBTdWJqZWN0PGFueT4oKTtcclxuXHJcbiAgam9pbnRzZWFyY2hJbmZvTGlzdDogYW55ID0ge307XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVzdFNlcnZpY2U6IFJlc3RmdWxTZXJ2aWNlLCBwcml2YXRlIHNlc3Npb25TZXJ2aWNlOiBTZXNzaW9uU2VydmljZSwgQEluamVjdChTZXJ2ZXJfSG9zdCkgcHJpdmF0ZSBob3N0OiBzdHJpbmcpIHtcclxuICAgIC8vIHRoaXMudXJpID0gdGhpcy5ob3N0ICsgdGhpcy51cmk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bmn6Xor6Llj4LmlbDmmKDlsITkv6Hmga9cclxuICAgKiBAcGFyYW0gZm9ybWlkIOihqOWNlUlEXHJcbiAgICogQHBhcmFtIHF1ZXJ5SWQg5p+l6K+i57yW5Y+3XHJcbiAgICovXHJcbiAgZ2V0am9pbnRzZWFyY2goZm9ybUlkOiBzdHJpbmcsIHF1ZXJ5SWQ6IHN0cmluZywgcXVlcnlSZWxhdGl2ZVVybDogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHJlc3VsdCQgPSB0aGlzLmdldGpvaW50c2VhcmNoTGlzdChmb3JtSWQsIHF1ZXJ5SWQsICcnLCAnJywgcXVlcnlSZWxhdGl2ZVVybCk7XHJcbiAgICByZXR1cm4gcmVzdWx0JC5waXBlKFxyXG4gICAgICBtYXAodmFsdWUgPT4ge1xyXG4gICAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZVtmb3JtSWQgKyBxdWVyeUlkXSkge1xyXG4gICAgICAgICAgcmV0dXJuIHZhbHVlW2Zvcm1JZCArIHF1ZXJ5SWRdO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZ2V0VmlzaWJsZUpvaW50KHZpc2libGVKb2ludFBhcmFtOiBhbnksIHF1ZXJ5UmVsYXRpdmVVcmw6IGFueSwgc2VhcmNoTGlzdDogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IGpvaW50VXJpID0gdGhpcy5ob3N0ICsgKCFxdWVyeVJlbGF0aXZlVXJsID8gdGhpcy5sY3BVcmkgOiBxdWVyeVJlbGF0aXZlVXJsKSArICd2aXNpYmxlam9pbnQnO1xyXG5cclxuICAgIGNvbnN0IHJlc3VsdCQgPSB0aGlzLnJlc3RTZXJ2aWNlLnB1dChqb2ludFVyaSwgeyAnUGFyYW0nOiB2aXNpYmxlSm9pbnRQYXJhbX0sIHt9LCB0aGlzLmNyZWF0ZUhlYWRlclNlc3Npb25JZCgpKTtcclxuICAgIHJldHVybiByZXN1bHQkLnBpcGUoXHJcbiAgICAgIG1hcCgoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgY29uc3Qgam9pbnRTZWFyY2hMaXN0ID0gW107XHJcbiAgICAgICAgaWYgKGRhdGEpIHtcclxuICAgICAgICAgIGRhdGEgPSAhcXVlcnlSZWxhdGl2ZVVybCA/IGRhdGEgOiBkYXRhLnJldHVyblZhbHVlO1xyXG4gICAgICAgICAgaWYgKCFxdWVyeVJlbGF0aXZlVXJsKSB7XHJcbiAgICAgICAgICAgIGZvciAoY29uc3Qgc2VhcmNoIG9mIHNlYXJjaExpc3QpIHtcclxuICAgICAgICAgICAgICBpZiAoZGF0YVtzZWFyY2guaWRdICE9PSBudWxsICYmIGRhdGFbc2VhcmNoLmlkXSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgICAgam9pbnRTZWFyY2hMaXN0LnB1c2goc2VhcmNoKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHNlYXJjaCBvZiBzZWFyY2hMaXN0KSB7XHJcbiAgICAgICAgICAgICAgY29uc3QgaXRlbSA9IGRhdGEuZmluZChkID0+IGQuaWQgPT09IHNlYXJjaC5pZCk7XHJcbiAgICAgICAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbS52aXNpYmxlID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgICAgICBqb2ludFNlYXJjaExpc3QucHVzaChzZWFyY2gpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGpvaW50U2VhcmNoTGlzdDtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blj4LmlbDmmKDlsITliJfooahcclxuICAgKiBAcGFyYW0gcXVlcnlJZCDmn6Xor6LnvJblj7dcclxuICAgKiBAcGFyYW0gdXNlcklkIOeUqOaIt0lEXHJcbiAgICogQHBhcmFtIGxhbmd1YWdlVHlwZSDor63oqIDnsbvlnotcclxuICAgKi9cclxuICBnZXRqb2ludHNlYXJjaExpc3QoZm9ybUlkOiBhbnksIHF1ZXJ5SWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcsIGxhbmd1YWdlVHlwZTogc3RyaW5nLCBxdWVyeVJlbGF0aXZlVXJsOiBhbnkpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3QgcmVzdFVyaSA9IHRoaXMuaG9zdCArIHRoaXMudXJpICsgJ2dldGpvaW5zZWFyY2gnO1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IHRoaXMucmVzdFNlcnZpY2UuZ2V0KHJlc3RVcmksIHsgZm9ybUlkLCBxdWVyeUlkLCB1c2VySWQsIGxhbmd1YWdlVHlwZSB9LCB0aGlzLmNyZWF0ZUhlYWRlclNlc3Npb25JZCgpKTtcclxuICAgIHJldHVybiByZXN1bHQkLnBpcGUoXHJcbiAgICAgIG1hcCgoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgLy8gdGhpcy5qb2ludHNlYXJjaEluZm9MaXN0ID0ge307XHJcbiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5sZW5ndGgpIHtcclxuICAgICAgICAgIGRhdGEuZm9yRWFjaCgoZWxlbWVudDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuam9pbnRzZWFyY2hJbmZvTGlzdFtlbGVtZW50LmZvcm1JZCArIGVsZW1lbnQucXVlcnlJZF0gPSBlbGVtZW50O1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICB0aGlzLmpvaW50c2VhcmNoSW5mb0NoYW5nZS5uZXh0KHsgam9pbnRzZWFyY2hJbmZvTGlzdDogdGhpcy5qb2ludHNlYXJjaEluZm9MaXN0IH0pO1xyXG4gICAgICAgICAgcmV0dXJuIHRoaXMuam9pbnRzZWFyY2hJbmZvTGlzdDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5qb2ludHNlYXJjaEluZm9DaGFuZ2UubmV4dCh7IGpvaW50c2VhcmNoSW5mb0xpc3Q6IG51bGwgfSk7XHJcbiAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDkv53lrZjlj4LmlbDmmKDlsIRcclxuICAgKiBAcGFyYW0gam9pbnRzZWFyY2gg5Y+C5pWw5pig5bCE5a6e5L2TXHJcbiAgICovXHJcbiAgc2F2ZWpvaW50c2VhcmNoKGpvaW50c2VhcmNoOiBhbnksIHF1ZXJ5UmVsYXRpdmVVcmw6IGFueSk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCByZXN0VXJpID0gdGhpcy5ob3N0ICsgdGhpcy51cmkgKyAnYWRkam9pbnRzZWFyY2gnO1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IHRoaXMucmVzdFNlcnZpY2UucG9zdChyZXN0VXJpLCBqb2ludHNlYXJjaCwge30sIHRoaXMuY3JlYXRlSGVhZGVyU2Vzc2lvbklkKCkpO1xyXG4gICAgcmV0dXJuIHJlc3VsdCQucGlwZShcclxuICAgICAgbWFwKChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgICBpZiAoZGF0YSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgdGhpcy5qb2ludHNlYXJjaEluZm9MaXN0W2pvaW50c2VhcmNoLkZvcm1JZCArIGpvaW50c2VhcmNoLnF1ZXJ5SWRdID0gam9pbnRzZWFyY2g7XHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yig6Zmk6IGU5p+lXHJcbiAgICogQHBhcmFtIHF1ZXJ5SWQg5p+l6K+i57yW5Y+3XHJcbiAgICovXHJcbiAgZGVsZXRlam9pbnRzZWFyY2goZm9ybUlkOiBhbnksIHF1ZXJ5SWQ6IHN0cmluZywgcXVlcnlSZWxhdGl2ZVVybDogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHJlc3RVcmkgPSB0aGlzLmhvc3QgKyB0aGlzLnVyaSArICdkZWxldGVqb2ludHNlYXJjaCc7XHJcbiAgICBjb25zdCByZXN1bHQkID0gdGhpcy5yZXN0U2VydmljZS5kZWxldGUocmVzdFVyaSwgeyBmb3JtSWQsIHF1ZXJ5SWQgfSwgdGhpcy5jcmVhdGVIZWFkZXJTZXNzaW9uSWQoKSk7XHJcbiAgICByZXR1cm4gcmVzdWx0JC5waXBlKFxyXG4gICAgICBtYXAoKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmIChkYXRhID09PSB0cnVlKSB7XHJcbiAgICAgICAgICB0aGlzLmpvaW50c2VhcmNoSW5mb0xpc3RbZm9ybUlkICsgcXVlcnlJZF0gPSBudWxsO1xyXG4gICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZ2V0TGFuZ3VhZ2VMaXN0KCkge1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IHRoaXMucmVzdFNlcnZpY2UuZ2V0KHRoaXMubG9jYWxVcmksIHsgaW5mb1R5cGU6ICdzdXBwb3J0ZWRMYW5ndWFnZScgfSk7XHJcbiAgICByZXR1cm4gcmVzdWx0JC5waXBlKFxyXG4gICAgICBtYXAoKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgIHJldHVybiBkYXRhO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlSGVhZGVyU2Vzc2lvbklkKCkge1xyXG4gICAgcmV0dXJuIFJ0ZlNlcnZpY2VzLmNyZWF0ZUhlYWRlclNlc3Npb25JZCh0aGlzLnNlc3Npb25TZXJ2aWNlKTtcclxuICB9XHJcbn1cclxuIl19