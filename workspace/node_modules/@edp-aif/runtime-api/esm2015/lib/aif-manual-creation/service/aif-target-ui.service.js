/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Inject, LOCALE_ID, Injector, ComponentFactoryResolver, NgModuleFactoryLoader } from '@angular/core';
import { BsModalService } from '@farris/ui-modal';
import { RpcCreationRuleExecutorResult } from '../../entity';
import { AIF_UISTATE_KEY_CREATION_RULE_RESULT } from '../config/aif-form-constants';
import { ReferSelectorComponent } from '../components/refer-selector/refer-selector.component';
import { FormGetCreationRuleEntityExArgs } from '../form-args';
import { AifDataService } from './aif-data.service';
import { FrameContext } from '@farris/devkit';
import { from } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { SourceDataSelectorComponent } from '../components/source-data-selector/source-data-selector.component';
import { AbstractAifUiService } from './abstract-aif-ui-service';
export class AifTargetUiService extends AbstractAifUiService {
    /**
     * @param {?} aifDataService
     * @param {?} frameContext
     * @param {?} modalService
     * @param {?} injector
     * @param {?} cfr
     * @param {?} loader
     * @param {?} localeId
     */
    constructor(aifDataService, frameContext, modalService, injector, cfr, loader, localeId) {
        super(frameContext, modalService, injector, cfr, loader, localeId);
        this.aifDataService = aifDataService;
        this.frameContext = frameContext;
        this.modalService = modalService;
        this.injector = injector;
        this.cfr = cfr;
        this.loader = loader;
        this.localeId = localeId;
        this.aifUIStateCreationRuleResultKey = AIF_UISTATE_KEY_CREATION_RULE_RESULT;
    }
    /**
     * 参照时打开生单规则选择器
     * @param {?} targetVoId
     * @param {?=} bizFlowchartId
     * @param {?=} modalOptions
     * @param {?=} customSelectorModuleUrl
     * @return {?}
     */
    openCreationRuleSelector4Refer(targetVoId, bizFlowchartId, modalOptions, customSelectorModuleUrl) {
        /** @type {?} */
        const args = new FormGetCreationRuleEntityExArgs();
        args.targetVoId = targetVoId;
        args.bizFlowchartId = bizFlowchartId;
        return this.openCreationRuleSelector(args, ReferSelectorComponent, modalOptions, customSelectorModuleUrl);
    }
    /**
     * 特定参照时打开生单规则选择器
     * @param {?} sourceVoId
     * @param {?} targetVoId
     * @param {?=} bizFlowchartId
     * @param {?=} modalOptions
     * @param {?=} customSelectorModuleUrl
     * @return {?}
     */
    openCreationRuleSelector4SpecificRefer(sourceVoId, targetVoId, bizFlowchartId, modalOptions, customSelectorModuleUrl) {
        /** @type {?} */
        const args = new FormGetCreationRuleEntityExArgs();
        args.sourceVoId = sourceVoId;
        args.targetVoId = targetVoId;
        args.bizFlowchartId = bizFlowchartId;
        return this.openCreationRuleSelector(args, ReferSelectorComponent, modalOptions, customSelectorModuleUrl);
    }
    /**
     * 打开来源单据选择器
     * @param {?=} formSettings
     * @param {?=} modalOptions
     * @return {?}
     */
    openSourceDataSelector4Refer(formSettings, modalOptions) {
        modalOptions = modalOptions == null ? this.defaultModalOptions : modalOptions;
        modalOptions.title = modalOptions.title == null ? this.aifLocalePipe.transform("sourceDataSelector") : modalOptions.title;
        /** @type {?} */
        let cmpR = null;
        if (formSettings == null || formSettings.sourceDataSelectorModuleUrl == null) {
            throw "暂无默认实现，请使用自定义来源单据选择器";
            /** @type {?} */
            let cmpF = this.cfr.resolveComponentFactory(SourceDataSelectorComponent);
            /** @type {?} */
            let inj = Injector.create([], this.injector);
            cmpR = cmpF.create(inj);
            this.configModalButtons(modalOptions, cmpR);
            cmpR.instance.bsModalRef4AifSelector = this.modalService.show(cmpR, modalOptions);
            return cmpR.instance.subject4EntityDatas.asObservable();
        }
        else {
            // return from(System.import(formSettings.sourceDataSelectorModuleUrl.substring(0, formSettings.sourceDataSelectorModuleUrl.indexOf("#")) + ".js")).pipe(
            return from(this.loader.load(formSettings.sourceDataSelectorModuleUrl)).pipe(switchMap((/**
             * @param {?} moduleFactory
             * @return {?}
             */
            (moduleFactory) => {
                /** @type {?} */
                const moduleRef = moduleFactory.create(this.frameContext.root.injector);
                cmpR = moduleRef.instance.createSourceDataSelector(this.frameContext.root.injector);
                this.configModalButtons(modalOptions, cmpR);
                cmpR.instance.bsModalRef4AifSelector = this.modalService.show(cmpR, modalOptions);
                return cmpR.instance.subject4EntityDatas.asObservable();
            })));
        }
    }
    /**
     * 获取传到根组件UIState上的生单规则执行器结果
     * @return {?}
     */
    getRpcCreationRuleExecutorResult() {
        /** @type {?} */
        const temp = this.frameContext.root.uiState[this.aifUIStateCreationRuleResultKey];
        /** @type {?} */
        const result = new RpcCreationRuleExecutorResult();
        if (typeof temp == "string") {
            result.LoadFromJson(temp);
        }
        else if (typeof temp == "object") {
            result.LoadFromJsonObject(temp);
        }
        else {
            throw "不合法的类型";
        }
        return result;
    }
}
AifTargetUiService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
AifTargetUiService.ctorParameters = () => [
    { type: AifDataService },
    { type: FrameContext },
    { type: BsModalService },
    { type: Injector },
    { type: ComponentFactoryResolver },
    { type: NgModuleFactoryLoader },
    { type: String, decorators: [{ type: Inject, args: [LOCALE_ID,] }] }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    AifTargetUiService.prototype.aifUIStateCreationRuleResultKey;
    /**
     * @type {?}
     * @protected
     */
    AifTargetUiService.prototype.aifDataService;
    /**
     * @type {?}
     * @protected
     */
    AifTargetUiService.prototype.frameContext;
    /**
     * @type {?}
     * @protected
     */
    AifTargetUiService.prototype.modalService;
    /**
     * @type {?}
     * @protected
     */
    AifTargetUiService.prototype.injector;
    /**
     * @type {?}
     * @protected
     */
    AifTargetUiService.prototype.cfr;
    /**
     * @type {?}
     * @protected
     */
    AifTargetUiService.prototype.loader;
    /** @type {?} */
    AifTargetUiService.prototype.localeId;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWlmLXRhcmdldC11aS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGVkcC1haWYvcnVudGltZS1hcGkvIiwic291cmNlcyI6WyJsaWIvYWlmLW1hbnVhbC1jcmVhdGlvbi9zZXJ2aWNlL2FpZi10YXJnZXQtdWkuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFrQyxRQUFRLEVBQUUsd0JBQXdCLEVBQUUscUJBQXFCLEVBQXVDLE1BQU0sZUFBZSxDQUFDO0FBRTlMLE9BQU8sRUFBZ0IsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFaEUsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzdELE9BQU8sRUFBRSxvQ0FBb0MsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ3BGLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHVEQUF1RCxDQUFDO0FBQy9GLE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUcvRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFFLFlBQVksRUFBVSxNQUFNLGdCQUFnQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxJQUFJLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDeEMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLG1FQUFtRSxDQUFDO0FBQ2hILE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBR2pFLE1BQU0sT0FBTyxrQkFBbUIsU0FBUSxvQkFBb0I7Ozs7Ozs7Ozs7SUFHeEQsWUFDYyxjQUE4QixFQUM5QixZQUEwQixFQUMxQixZQUE0QixFQUM1QixRQUFrQixFQUNsQixHQUE2QixFQUM3QixNQUE2QixFQUNiLFFBQWdCO1FBRTFD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Ozs7O0lBRzVGLDRDQUF3Qzs7Ozs7SUFDeEMsMENBQW9DOzs7OztJQUNwQywwQ0FBc0M7Ozs7O0lBQ3RDLHNDQUE0Qjs7Ozs7SUFDNUIsaUNBQXVDOzs7OztJQUN2QyxvQ0FBdUM7O0lBQ3ZDLHNDQUEwQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCwgTE9DQUxFX0lELCBDb21wb25lbnRSZWYsIENvbXBvbmVudEZhY3RvcnksIEluamVjdG9yLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIE5nTW9kdWxlRmFjdG9yeUxvYWRlciwgTmdNb2R1bGVGYWN0b3J5LCBSZWZsZWN0aXZlSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQWlmTG9jYWxlUGlwZSB9IGZyb20gJy4uL3BpcGUvbG9jYWxlLnBpcGUnO1xyXG5pbXBvcnQgeyBNb2RhbE9wdGlvbnMsIEJzTW9kYWxTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1tb2RhbCc7XHJcbmltcG9ydCB7IEZvcm1TZXR0aW5ncywgSVNsaW1DcmVhdGlvblJ1bGVFbnRpdHlFeCB9IGZyb20gJ0BlZHAtYWlmL2NvbW1vbi1hcGknO1xyXG5pbXBvcnQgeyBScGNDcmVhdGlvblJ1bGVFeGVjdXRvclJlc3VsdCB9IGZyb20gJy4uLy4uL2VudGl0eSc7XHJcbmltcG9ydCB7IEFJRl9VSVNUQVRFX0tFWV9DUkVBVElPTl9SVUxFX1JFU1VMVCB9IGZyb20gJy4uL2NvbmZpZy9haWYtZm9ybS1jb25zdGFudHMnO1xyXG5pbXBvcnQgeyBSZWZlclNlbGVjdG9yQ29tcG9uZW50IH0gZnJvbSAnLi4vY29tcG9uZW50cy9yZWZlci1zZWxlY3Rvci9yZWZlci1zZWxlY3Rvci5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBGb3JtR2V0Q3JlYXRpb25SdWxlRW50aXR5RXhBcmdzIH0gZnJvbSAnLi4vZm9ybS1hcmdzJztcclxuaW1wb3J0IHsgSUFpZkNyZWF0aW9uUnVsZVNlbGVjdG9yQ29tcG9uZW50LCBJQWlmQ3JlYXRpb25SdWxlU2VsZWN0b3JNb2R1bGUsIElBaWZTZWxlY3RvckNvbXBvbmVudCwgSUFpZkRhdGFTZWxlY3RvckNvbXBvbmVudCwgSUFpZkRhdGFTZWxlY3Rvck1vZHVsZSB9IGZyb20gJy4uL2Jhc2UnO1xyXG5pbXBvcnQgeyBTRUxFQ1RPUl9BUkdTX0lOSkVDVE9SIH0gZnJvbSAnLi4vY29uZmlnL3NlbGVjdG9yLWFyZ3MtaW5qZWN0b3IuY29uZmlnJztcclxuaW1wb3J0IHsgQWlmRGF0YVNlcnZpY2UgfSBmcm9tICcuL2FpZi1kYXRhLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQsIEVudGl0eSB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgZnJvbSwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IFNvdXJjZURhdGFTZWxlY3RvckNvbXBvbmVudCB9IGZyb20gJy4uL2NvbXBvbmVudHMvc291cmNlLWRhdGEtc2VsZWN0b3Ivc291cmNlLWRhdGEtc2VsZWN0b3IuY29tcG9uZW50JztcclxuaW1wb3J0IHsgQWJzdHJhY3RBaWZVaVNlcnZpY2UgfSBmcm9tICcuL2Fic3RyYWN0LWFpZi11aS1zZXJ2aWNlJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEFpZlRhcmdldFVpU2VydmljZSBleHRlbmRzIEFic3RyYWN0QWlmVWlTZXJ2aWNlIHtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgYWlmVUlTdGF0ZUNyZWF0aW9uUnVsZVJlc3VsdEtleTogc3RyaW5nID0gQUlGX1VJU1RBVEVfS0VZX0NSRUFUSU9OX1JVTEVfUkVTVUxUO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByb3RlY3RlZCBhaWZEYXRhU2VydmljZTogQWlmRGF0YVNlcnZpY2UsXHJcbiAgICAgICAgcHJvdGVjdGVkIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LFxyXG4gICAgICAgIHByb3RlY3RlZCBtb2RhbFNlcnZpY2U6IEJzTW9kYWxTZXJ2aWNlLFxyXG4gICAgICAgIHByb3RlY3RlZCBpbmplY3RvcjogSW5qZWN0b3IsXHJcbiAgICAgICAgcHJvdGVjdGVkIGNmcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxyXG4gICAgICAgIHByb3RlY3RlZCBsb2FkZXI6IE5nTW9kdWxlRmFjdG9yeUxvYWRlcixcclxuICAgICAgICBASW5qZWN0KExPQ0FMRV9JRCkgcHVibGljIGxvY2FsZUlkOiBzdHJpbmcsXHJcbiAgICApIHtcclxuICAgICAgICBzdXBlcihmcmFtZUNvbnRleHQsIG1vZGFsU2VydmljZSwgaW5qZWN0b3IsIGNmciwgbG9hZGVyLCBsb2NhbGVJZCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlj4Lnhafml7bmiZPlvIDnlJ/ljZXop4TliJnpgInmi6nlmahcclxuICAgICAqL1xyXG4gICAgcHVibGljIG9wZW5DcmVhdGlvblJ1bGVTZWxlY3RvcjRSZWZlcih0YXJnZXRWb0lkOiBzdHJpbmcsIGJpekZsb3djaGFydElkPzogc3RyaW5nLCBtb2RhbE9wdGlvbnM/OiBNb2RhbE9wdGlvbnMsIGN1c3RvbVNlbGVjdG9yTW9kdWxlVXJsPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxJU2xpbUNyZWF0aW9uUnVsZUVudGl0eUV4PiB7XHJcbiAgICAgICAgY29uc3QgYXJncyA9IG5ldyBGb3JtR2V0Q3JlYXRpb25SdWxlRW50aXR5RXhBcmdzKCk7XHJcbiAgICAgICAgYXJncy50YXJnZXRWb0lkID0gdGFyZ2V0Vm9JZDtcclxuICAgICAgICBhcmdzLmJpekZsb3djaGFydElkID0gYml6Rmxvd2NoYXJ0SWQ7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLm9wZW5DcmVhdGlvblJ1bGVTZWxlY3RvcihhcmdzLCBSZWZlclNlbGVjdG9yQ29tcG9uZW50LCBtb2RhbE9wdGlvbnMsIGN1c3RvbVNlbGVjdG9yTW9kdWxlVXJsKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOeJueWumuWPgueFp+aXtuaJk+W8gOeUn+WNleinhOWImemAieaLqeWZqFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgb3BlbkNyZWF0aW9uUnVsZVNlbGVjdG9yNFNwZWNpZmljUmVmZXIoc291cmNlVm9JZDogc3RyaW5nLCB0YXJnZXRWb0lkOiBzdHJpbmcsIGJpekZsb3djaGFydElkPzogc3RyaW5nLCBtb2RhbE9wdGlvbnM/OiBNb2RhbE9wdGlvbnMsIGN1c3RvbVNlbGVjdG9yTW9kdWxlVXJsPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxJU2xpbUNyZWF0aW9uUnVsZUVudGl0eUV4PiB7XHJcbiAgICAgICAgY29uc3QgYXJncyA9IG5ldyBGb3JtR2V0Q3JlYXRpb25SdWxlRW50aXR5RXhBcmdzKCk7XHJcbiAgICAgICAgYXJncy5zb3VyY2VWb0lkID0gc291cmNlVm9JZDtcclxuICAgICAgICBhcmdzLnRhcmdldFZvSWQgPSB0YXJnZXRWb0lkO1xyXG4gICAgICAgIGFyZ3MuYml6Rmxvd2NoYXJ0SWQgPSBiaXpGbG93Y2hhcnRJZDtcclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMub3BlbkNyZWF0aW9uUnVsZVNlbGVjdG9yKGFyZ3MsIFJlZmVyU2VsZWN0b3JDb21wb25lbnQsIG1vZGFsT3B0aW9ucywgY3VzdG9tU2VsZWN0b3JNb2R1bGVVcmwpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5omT5byA5p2l5rqQ5Y2V5o2u6YCJ5oup5ZmoXHJcbiAgICAgKiBAcGFyYW0gZm9ybVNldHRpbmdzIFxyXG4gICAgICogQHBhcmFtIG1vZGFsT3B0aW9ucyBcclxuICAgICAqL1xyXG4gICAgcHVibGljIG9wZW5Tb3VyY2VEYXRhU2VsZWN0b3I0UmVmZXIoZm9ybVNldHRpbmdzPzogRm9ybVNldHRpbmdzLCBtb2RhbE9wdGlvbnM/OiBNb2RhbE9wdGlvbnMpOiBPYnNlcnZhYmxlPEVudGl0eVtdPiB7XHJcbiAgICAgICAgbW9kYWxPcHRpb25zID0gbW9kYWxPcHRpb25zID09IG51bGwgPyB0aGlzLmRlZmF1bHRNb2RhbE9wdGlvbnMgOiBtb2RhbE9wdGlvbnM7XHJcbiAgICAgICAgbW9kYWxPcHRpb25zLnRpdGxlID0gbW9kYWxPcHRpb25zLnRpdGxlID09IG51bGwgPyB0aGlzLmFpZkxvY2FsZVBpcGUudHJhbnNmb3JtKFwic291cmNlRGF0YVNlbGVjdG9yXCIpIDogbW9kYWxPcHRpb25zLnRpdGxlO1xyXG5cclxuICAgICAgICBsZXQgY21wUjogQ29tcG9uZW50UmVmPElBaWZEYXRhU2VsZWN0b3JDb21wb25lbnQ+ID0gbnVsbDtcclxuICAgICAgICBpZiAoZm9ybVNldHRpbmdzID09IG51bGwgfHwgZm9ybVNldHRpbmdzLnNvdXJjZURhdGFTZWxlY3Rvck1vZHVsZVVybCA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHRocm93IFwi5pqC5peg6buY6K6k5a6e546w77yM6K+35L2/55So6Ieq5a6a5LmJ5p2l5rqQ5Y2V5o2u6YCJ5oup5ZmoXCI7XHJcbiAgICAgICAgICAgIGxldCBjbXBGOiBDb21wb25lbnRGYWN0b3J5PFNvdXJjZURhdGFTZWxlY3RvckNvbXBvbmVudD4gPSB0aGlzLmNmci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShTb3VyY2VEYXRhU2VsZWN0b3JDb21wb25lbnQpO1xyXG4gICAgICAgICAgICBsZXQgaW5qOiBJbmplY3RvciA9IEluamVjdG9yLmNyZWF0ZShbXHJcbiAgICAgICAgICAgIF0sIHRoaXMuaW5qZWN0b3IpO1xyXG4gICAgICAgICAgICBjbXBSID0gY21wRi5jcmVhdGUoaW5qKTtcclxuICAgICAgICAgICAgdGhpcy5jb25maWdNb2RhbEJ1dHRvbnMobW9kYWxPcHRpb25zLCBjbXBSKTtcclxuXHJcbiAgICAgICAgICAgIGNtcFIuaW5zdGFuY2UuYnNNb2RhbFJlZjRBaWZTZWxlY3RvciA9IHRoaXMubW9kYWxTZXJ2aWNlLnNob3coY21wUiwgbW9kYWxPcHRpb25zKTtcclxuICAgICAgICAgICAgcmV0dXJuIGNtcFIuaW5zdGFuY2Uuc3ViamVjdDRFbnRpdHlEYXRhcy5hc09ic2VydmFibGUoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyByZXR1cm4gZnJvbShTeXN0ZW0uaW1wb3J0KGZvcm1TZXR0aW5ncy5zb3VyY2VEYXRhU2VsZWN0b3JNb2R1bGVVcmwuc3Vic3RyaW5nKDAsIGZvcm1TZXR0aW5ncy5zb3VyY2VEYXRhU2VsZWN0b3JNb2R1bGVVcmwuaW5kZXhPZihcIiNcIikpICsgXCIuanNcIikpLnBpcGUoXHJcbiAgICAgICAgICAgIHJldHVybiBmcm9tKHRoaXMubG9hZGVyLmxvYWQoZm9ybVNldHRpbmdzLnNvdXJjZURhdGFTZWxlY3Rvck1vZHVsZVVybCkpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoXHJcbiAgICAgICAgICAgICAgICAgICAgKG1vZHVsZUZhY3Rvcnk6IE5nTW9kdWxlRmFjdG9yeTxJQWlmRGF0YVNlbGVjdG9yTW9kdWxlPikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtb2R1bGVSZWYgPSBtb2R1bGVGYWN0b3J5LmNyZWF0ZSh0aGlzLmZyYW1lQ29udGV4dC5yb290LmluamVjdG9yKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY21wUiA9IG1vZHVsZVJlZi5pbnN0YW5jZS5jcmVhdGVTb3VyY2VEYXRhU2VsZWN0b3IodGhpcy5mcmFtZUNvbnRleHQucm9vdC5pbmplY3Rvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnTW9kYWxCdXR0b25zKG1vZGFsT3B0aW9ucywgY21wUik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbXBSLmluc3RhbmNlLmJzTW9kYWxSZWY0QWlmU2VsZWN0b3IgPSB0aGlzLm1vZGFsU2VydmljZS5zaG93KGNtcFIsIG1vZGFsT3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjbXBSLmluc3RhbmNlLnN1YmplY3Q0RW50aXR5RGF0YXMuYXNPYnNlcnZhYmxlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPluS8oOWIsOaguee7hOS7tlVJU3RhdGXkuIrnmoTnlJ/ljZXop4TliJnmiafooYzlmajnu5PmnpxcclxuICAgICAqL1xyXG4gICAgcHVibGljIGdldFJwY0NyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0KCk6IFJwY0NyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0IHtcclxuICAgICAgICBjb25zdCB0ZW1wID0gdGhpcy5mcmFtZUNvbnRleHQucm9vdC51aVN0YXRlW3RoaXMuYWlmVUlTdGF0ZUNyZWF0aW9uUnVsZVJlc3VsdEtleV07XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IFJwY0NyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0KCk7XHJcbiAgICAgICAgaWYgKHR5cGVvZiB0ZW1wID09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICAgICAgcmVzdWx0LkxvYWRGcm9tSnNvbih0ZW1wKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0ZW1wID09IFwib2JqZWN0XCIpIHtcclxuICAgICAgICAgICAgcmVzdWx0LkxvYWRGcm9tSnNvbk9iamVjdCh0ZW1wKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aHJvdyBcIuS4jeWQiOazleeahOexu+Wei1wiO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG59Il19