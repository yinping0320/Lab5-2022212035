/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, Inject, LOCALE_ID, Injector, ComponentFactoryResolver, NgModuleFactoryLoader } from '@angular/core';
import { BsModalService } from '@farris/ui-modal';
import { RpcCreationRuleExecutorResult } from '../../entity';
import { AIF_UISTATE_KEY_CREATION_RULE_RESULT } from '../config/aif-form-constants';
import { ReferSelectorComponent } from '../components/refer-selector/refer-selector.component';
import { FormGetCreationRuleEntityExArgs } from '../form-args';
import { AifDataService } from './aif-data.service';
import { FrameContext } from '@farris/devkit';
import { from } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { SourceDataSelectorComponent } from '../components/source-data-selector/source-data-selector.component';
import { AbstractAifUiService } from './abstract-aif-ui-service';
var AifTargetUiService = /** @class */ (function (_super) {
    tslib_1.__extends(AifTargetUiService, _super);
    function AifTargetUiService(aifDataService, frameContext, modalService, injector, cfr, loader, localeId) {
        var _this = _super.call(this, frameContext, modalService, injector, cfr, loader, localeId) || this;
        _this.aifDataService = aifDataService;
        _this.frameContext = frameContext;
        _this.modalService = modalService;
        _this.injector = injector;
        _this.cfr = cfr;
        _this.loader = loader;
        _this.localeId = localeId;
        _this.aifUIStateCreationRuleResultKey = AIF_UISTATE_KEY_CREATION_RULE_RESULT;
        return _this;
    }
    /**
     * 参照时打开生单规则选择器
     */
    /**
     * 参照时打开生单规则选择器
     * @param {?} targetVoId
     * @param {?=} bizFlowchartId
     * @param {?=} modalOptions
     * @param {?=} customSelectorModuleUrl
     * @return {?}
     */
    AifTargetUiService.prototype.openCreationRuleSelector4Refer = /**
     * 参照时打开生单规则选择器
     * @param {?} targetVoId
     * @param {?=} bizFlowchartId
     * @param {?=} modalOptions
     * @param {?=} customSelectorModuleUrl
     * @return {?}
     */
    function (targetVoId, bizFlowchartId, modalOptions, customSelectorModuleUrl) {
        /** @type {?} */
        var args = new FormGetCreationRuleEntityExArgs();
        args.targetVoId = targetVoId;
        args.bizFlowchartId = bizFlowchartId;
        return this.openCreationRuleSelector(args, ReferSelectorComponent, modalOptions, customSelectorModuleUrl);
    };
    /**
     * 特定参照时打开生单规则选择器
     */
    /**
     * 特定参照时打开生单规则选择器
     * @param {?} sourceVoId
     * @param {?} targetVoId
     * @param {?=} bizFlowchartId
     * @param {?=} modalOptions
     * @param {?=} customSelectorModuleUrl
     * @return {?}
     */
    AifTargetUiService.prototype.openCreationRuleSelector4SpecificRefer = /**
     * 特定参照时打开生单规则选择器
     * @param {?} sourceVoId
     * @param {?} targetVoId
     * @param {?=} bizFlowchartId
     * @param {?=} modalOptions
     * @param {?=} customSelectorModuleUrl
     * @return {?}
     */
    function (sourceVoId, targetVoId, bizFlowchartId, modalOptions, customSelectorModuleUrl) {
        /** @type {?} */
        var args = new FormGetCreationRuleEntityExArgs();
        args.sourceVoId = sourceVoId;
        args.targetVoId = targetVoId;
        args.bizFlowchartId = bizFlowchartId;
        return this.openCreationRuleSelector(args, ReferSelectorComponent, modalOptions, customSelectorModuleUrl);
    };
    /**
     * 打开来源单据选择器
     * @param formSettings
     * @param modalOptions
     */
    /**
     * 打开来源单据选择器
     * @param {?=} formSettings
     * @param {?=} modalOptions
     * @return {?}
     */
    AifTargetUiService.prototype.openSourceDataSelector4Refer = /**
     * 打开来源单据选择器
     * @param {?=} formSettings
     * @param {?=} modalOptions
     * @return {?}
     */
    function (formSettings, modalOptions) {
        var _this = this;
        modalOptions = modalOptions == null ? this.defaultModalOptions : modalOptions;
        modalOptions.title = modalOptions.title == null ? this.aifLocalePipe.transform("sourceDataSelector") : modalOptions.title;
        /** @type {?} */
        var cmpR = null;
        if (formSettings == null || formSettings.sourceDataSelectorModuleUrl == null) {
            throw "暂无默认实现，请使用自定义来源单据选择器";
            /** @type {?} */
            var cmpF = this.cfr.resolveComponentFactory(SourceDataSelectorComponent);
            /** @type {?} */
            var inj = Injector.create([], this.injector);
            cmpR = cmpF.create(inj);
            this.configModalButtons(modalOptions, cmpR);
            cmpR.instance.bsModalRef4AifSelector = this.modalService.show(cmpR, modalOptions);
            return cmpR.instance.subject4EntityDatas.asObservable();
        }
        else {
            // return from(System.import(formSettings.sourceDataSelectorModuleUrl.substring(0, formSettings.sourceDataSelectorModuleUrl.indexOf("#")) + ".js")).pipe(
            return from(this.loader.load(formSettings.sourceDataSelectorModuleUrl)).pipe(switchMap((/**
             * @param {?} moduleFactory
             * @return {?}
             */
            function (moduleFactory) {
                /** @type {?} */
                var moduleRef = moduleFactory.create(_this.frameContext.root.injector);
                cmpR = moduleRef.instance.createSourceDataSelector(_this.frameContext.root.injector);
                _this.configModalButtons(modalOptions, cmpR);
                cmpR.instance.bsModalRef4AifSelector = _this.modalService.show(cmpR, modalOptions);
                return cmpR.instance.subject4EntityDatas.asObservable();
            })));
        }
    };
    /**
     * 获取传到根组件UIState上的生单规则执行器结果
     */
    /**
     * 获取传到根组件UIState上的生单规则执行器结果
     * @return {?}
     */
    AifTargetUiService.prototype.getRpcCreationRuleExecutorResult = /**
     * 获取传到根组件UIState上的生单规则执行器结果
     * @return {?}
     */
    function () {
        /** @type {?} */
        var temp = this.frameContext.root.uiState[this.aifUIStateCreationRuleResultKey];
        /** @type {?} */
        var result = new RpcCreationRuleExecutorResult();
        if (typeof temp == "string") {
            result.LoadFromJson(temp);
        }
        else if (typeof temp == "object") {
            result.LoadFromJsonObject(temp);
        }
        else {
            throw "不合法的类型";
        }
        return result;
    };
    AifTargetUiService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    AifTargetUiService.ctorParameters = function () { return [
        { type: AifDataService },
        { type: FrameContext },
        { type: BsModalService },
        { type: Injector },
        { type: ComponentFactoryResolver },
        { type: NgModuleFactoryLoader },
        { type: String, decorators: [{ type: Inject, args: [LOCALE_ID,] }] }
    ]; };
    return AifTargetUiService;
}(AbstractAifUiService));
export { AifTargetUiService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    AifTargetUiService.prototype.aifUIStateCreationRuleResultKey;
    /**
     * @type {?}
     * @protected
     */
    AifTargetUiService.prototype.aifDataService;
    /**
     * @type {?}
     * @protected
     */
    AifTargetUiService.prototype.frameContext;
    /**
     * @type {?}
     * @protected
     */
    AifTargetUiService.prototype.modalService;
    /**
     * @type {?}
     * @protected
     */
    AifTargetUiService.prototype.injector;
    /**
     * @type {?}
     * @protected
     */
    AifTargetUiService.prototype.cfr;
    /**
     * @type {?}
     * @protected
     */
    AifTargetUiService.prototype.loader;
    /** @type {?} */
    AifTargetUiService.prototype.localeId;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWlmLXRhcmdldC11aS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGVkcC1haWYvcnVudGltZS1hcGkvIiwic291cmNlcyI6WyJsaWIvYWlmLW1hbnVhbC1jcmVhdGlvbi9zZXJ2aWNlL2FpZi10YXJnZXQtdWkuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBa0MsUUFBUSxFQUFFLHdCQUF3QixFQUFFLHFCQUFxQixFQUF1QyxNQUFNLGVBQWUsQ0FBQztBQUU5TCxPQUFPLEVBQWdCLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWhFLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUM3RCxPQUFPLEVBQUUsb0NBQW9DLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUNwRixPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx1REFBdUQsQ0FBQztBQUMvRixPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFHL0QsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxZQUFZLEVBQVUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsSUFBSSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxtRUFBbUUsQ0FBQztBQUNoSCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUVqRTtJQUN3Qyw4Q0FBb0I7SUFHeEQsNEJBQ2MsY0FBOEIsRUFDOUIsWUFBMEIsRUFDMUIsWUFBNEIsRUFDNUIsUUFBa0IsRUFDbEIsR0FBNkIsRUFDN0IsTUFBNkIsRUFDYixRQUFnQjtRQVA5QyxZQVNJLGtCQUFNLFlBQVksRUFBRSxZ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QWM7Z0JBRm1DLFFBQVE7Z0JBQUUsd0JBQXdCO2dCQUFFLHFCQUFxQjs2Q0E0QnhILE1BQU0sU0FBQyxTQUFTOztJQWdGekIseUJBQUM7Q0FBQSxBQTNGRCxDQUN3QyxvQkFBb0IsR0EwRjNEO1NBMUZZLGtCQUFrQjs7Ozs7O0lBQzNCLDZEQUFnRzs7Ozs7SUFHNUYsNENBQXdDOzs7OztJQUN4QywwQ0FBb0M7Ozs7O0lBQ3BDLDBDQUFzQzs7Ozs7SUFDdEMsc0NBQTRCOzs7OztJQUM1QixpQ0FBdUM7Ozs7O0lBQ3ZDLG9DQUF1Qzs7SUFDdkMsc0NBQTBDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0LCBMT0NBTEVfSUQsIENvbXBvbmVudFJlZiwgQ29tcG9uZW50RmFjdG9yeSwgSW5qZWN0b3IsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgTmdNb2R1bGVGYWN0b3J5TG9hZGVyLCBOZ01vZHVsZUZhY3RvcnksIFJlZmxlY3RpdmVJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBBaWZMb2NhbGVQaXBlIH0gZnJvbSAnLi4vcGlwZS9sb2NhbGUucGlwZSc7XHJcbmltcG9ydCB7IE1vZGFsT3B0aW9ucywgQnNNb2RhbFNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLW1vZGFsJztcclxuaW1wb3J0IHsgRm9ybVNldHRpbmdzLCBJU2xpbUNyZWF0aW9uUnVsZUVudGl0eUV4IH0gZnJvbSAnQGVkcC1haWYvY29tbW9uLWFwaSc7XHJcbmltcG9ydCB7IFJwY0NyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0IH0gZnJvbSAnLi4vLi4vZW50aXR5JztcclxuaW1wb3J0IHsgQUlGX1VJU1RBVEVfS0VZX0NSRUFUSU9OX1JVTEVfUkVTVUxUIH0gZnJvbSAnLi4vY29uZmlnL2FpZi1mb3JtLWNvbnN0YW50cyc7XHJcbmltcG9ydCB7IFJlZmVyU2VsZWN0b3JDb21wb25lbnQgfSBmcm9tICcuLi9jb21wb25lbnRzL3JlZmVyLXNlbGVjdG9yL3JlZmVyLXNlbGVjdG9yLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IEZvcm1HZXRDcmVhdGlvblJ1bGVFbnRpdHlFeEFyZ3MgfSBmcm9tICcuLi9mb3JtLWFyZ3MnO1xyXG5pbXBvcnQgeyBJQWlmQ3JlYXRpb25SdWxlU2VsZWN0b3JDb21wb25lbnQsIElBaWZDcmVhdGlvblJ1bGVTZWxlY3Rvck1vZHVsZSwgSUFpZlNlbGVjdG9yQ29tcG9uZW50LCBJQWlmRGF0YVNlbGVjdG9yQ29tcG9uZW50LCBJQWlmRGF0YVNlbGVjdG9yTW9kdWxlIH0gZnJvbSAnLi4vYmFzZSc7XHJcbmltcG9ydCB7IFNFTEVDVE9SX0FSR1NfSU5KRUNUT1IgfSBmcm9tICcuLi9jb25maWcvc2VsZWN0b3ItYXJncy1pbmplY3Rvci5jb25maWcnO1xyXG5pbXBvcnQgeyBBaWZEYXRhU2VydmljZSB9IGZyb20gJy4vYWlmLWRhdGEuc2VydmljZSc7XHJcbmltcG9ydCB7IEZyYW1lQ29udGV4dCwgRW50aXR5IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBmcm9tLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgU291cmNlRGF0YVNlbGVjdG9yQ29tcG9uZW50IH0gZnJvbSAnLi4vY29tcG9uZW50cy9zb3VyY2UtZGF0YS1zZWxlY3Rvci9zb3VyY2UtZGF0YS1zZWxlY3Rvci5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBBYnN0cmFjdEFpZlVpU2VydmljZSB9IGZyb20gJy4vYWJzdHJhY3QtYWlmLXVpLXNlcnZpY2UnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQWlmVGFyZ2V0VWlTZXJ2aWNlIGV4dGVuZHMgQWJzdHJhY3RBaWZVaVNlcnZpY2Uge1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBhaWZVSVN0YXRlQ3JlYXRpb25SdWxlUmVzdWx0S2V5OiBzdHJpbmcgPSBBSUZfVUlTVEFURV9LRVlfQ1JFQVRJT05fUlVMRV9SRVNVTFQ7XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJvdGVjdGVkIGFpZkRhdGFTZXJ2aWNlOiBBaWZEYXRhU2VydmljZSxcclxuICAgICAgICBwcm90ZWN0ZWQgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXHJcbiAgICAgICAgcHJvdGVjdGVkIG1vZGFsU2VydmljZTogQnNNb2RhbFNlcnZpY2UsXHJcbiAgICAgICAgcHJvdGVjdGVkIGluamVjdG9yOiBJbmplY3RvcixcclxuICAgICAgICBwcm90ZWN0ZWQgY2ZyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICAgICAgcHJvdGVjdGVkIGxvYWRlcjogTmdNb2R1bGVGYWN0b3J5TG9hZGVyLFxyXG4gICAgICAgIEBJbmplY3QoTE9DQUxFX0lEKSBwdWJsaWMgbG9jYWxlSWQ6IHN0cmluZyxcclxuICAgICkge1xyXG4gICAgICAgIHN1cGVyKGZyYW1lQ29udGV4dCwgbW9kYWxTZXJ2aWNlLCBpbmplY3RvciwgY2ZyLCBsb2FkZXIsIGxvY2FsZUlkKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWPgueFp+aXtuaJk+W8gOeUn+WNleinhOWImemAieaLqeWZqFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgb3BlbkNyZWF0aW9uUnVsZVNlbGVjdG9yNFJlZmVyKHRhcmdldFZvSWQ6IHN0cmluZywgYml6Rmxvd2NoYXJ0SWQ/OiBzdHJpbmcsIG1vZGFsT3B0aW9ucz86IE1vZGFsT3B0aW9ucywgY3VzdG9tU2VsZWN0b3JNb2R1bGVVcmw/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPElTbGltQ3JlYXRpb25SdWxlRW50aXR5RXg+IHtcclxuICAgICAgICBjb25zdCBhcmdzID0gbmV3IEZvcm1HZXRDcmVhdGlvblJ1bGVFbnRpdHlFeEFyZ3MoKTtcclxuICAgICAgICBhcmdzLnRhcmdldFZvSWQgPSB0YXJnZXRWb0lkO1xyXG4gICAgICAgIGFyZ3MuYml6Rmxvd2NoYXJ0SWQgPSBiaXpGbG93Y2hhcnRJZDtcclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMub3BlbkNyZWF0aW9uUnVsZVNlbGVjdG9yKGFyZ3MsIFJlZmVyU2VsZWN0b3JDb21wb25lbnQsIG1vZGFsT3B0aW9ucywgY3VzdG9tU2VsZWN0b3JNb2R1bGVVcmwpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog54m55a6a5Y+C54Wn5pe25omT5byA55Sf5Y2V6KeE5YiZ6YCJ5oup5ZmoXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBvcGVuQ3JlYXRpb25SdWxlU2VsZWN0b3I0U3BlY2lmaWNSZWZlcihzb3VyY2VWb0lkOiBzdHJpbmcsIHRhcmdldFZvSWQ6IHN0cmluZywgYml6Rmxvd2NoYXJ0SWQ/OiBzdHJpbmcsIG1vZGFsT3B0aW9ucz86IE1vZGFsT3B0aW9ucywgY3VzdG9tU2VsZWN0b3JNb2R1bGVVcmw/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPElTbGltQ3JlYXRpb25SdWxlRW50aXR5RXg+IHtcclxuICAgICAgICBjb25zdCBhcmdzID0gbmV3IEZvcm1HZXRDcmVhdGlvblJ1bGVFbnRpdHlFeEFyZ3MoKTtcclxuICAgICAgICBhcmdzLnNvdXJjZVZvSWQgPSBzb3VyY2VWb0lkO1xyXG4gICAgICAgIGFyZ3MudGFyZ2V0Vm9JZCA9IHRhcmdldFZvSWQ7XHJcbiAgICAgICAgYXJncy5iaXpGbG93Y2hhcnRJZCA9IGJpekZsb3djaGFydElkO1xyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5vcGVuQ3JlYXRpb25SdWxlU2VsZWN0b3IoYXJncywgUmVmZXJTZWxlY3RvckNvbXBvbmVudCwgbW9kYWxPcHRpb25zLCBjdXN0b21TZWxlY3Rvck1vZHVsZVVybCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmiZPlvIDmnaXmupDljZXmja7pgInmi6nlmahcclxuICAgICAqIEBwYXJhbSBmb3JtU2V0dGluZ3MgXHJcbiAgICAgKiBAcGFyYW0gbW9kYWxPcHRpb25zIFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgb3BlblNvdXJjZURhdGFTZWxlY3RvcjRSZWZlcihmb3JtU2V0dGluZ3M/OiBGb3JtU2V0dGluZ3MsIG1vZGFsT3B0aW9ucz86IE1vZGFsT3B0aW9ucyk6IE9ic2VydmFibGU8RW50aXR5W10+IHtcclxuICAgICAgICBtb2RhbE9wdGlvbnMgPSBtb2RhbE9wdGlvbnMgPT0gbnVsbCA/IHRoaXMuZGVmYXVsdE1vZGFsT3B0aW9ucyA6IG1vZGFsT3B0aW9ucztcclxuICAgICAgICBtb2RhbE9wdGlvbnMudGl0bGUgPSBtb2RhbE9wdGlvbnMudGl0bGUgPT0gbnVsbCA/IHRoaXMuYWlmTG9jYWxlUGlwZS50cmFuc2Zvcm0oXCJzb3VyY2VEYXRhU2VsZWN0b3JcIikgOiBtb2RhbE9wdGlvbnMudGl0bGU7XHJcblxyXG4gICAgICAgIGxldCBjbXBSOiBDb21wb25lbnRSZWY8SUFpZkRhdGFTZWxlY3RvckNvbXBvbmVudD4gPSBudWxsO1xyXG4gICAgICAgIGlmIChmb3JtU2V0dGluZ3MgPT0gbnVsbCB8fCBmb3JtU2V0dGluZ3Muc291cmNlRGF0YVNlbGVjdG9yTW9kdWxlVXJsID09IG51bGwpIHtcclxuICAgICAgICAgICAgdGhyb3cgXCLmmoLml6Dpu5jorqTlrp7njrDvvIzor7fkvb/nlKjoh6rlrprkuYnmnaXmupDljZXmja7pgInmi6nlmahcIjtcclxuICAgICAgICAgICAgbGV0IGNtcEY6IENvbXBvbmVudEZhY3Rvcnk8U291cmNlRGF0YVNlbGVjdG9yQ29tcG9uZW50PiA9IHRoaXMuY2ZyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KFNvdXJjZURhdGFTZWxlY3RvckNvbXBvbmVudCk7XHJcbiAgICAgICAgICAgIGxldCBpbmo6IEluamVjdG9yID0gSW5qZWN0b3IuY3JlYXRlKFtcclxuICAgICAgICAgICAgXSwgdGhpcy5pbmplY3Rvcik7XHJcbiAgICAgICAgICAgIGNtcFIgPSBjbXBGLmNyZWF0ZShpbmopO1xyXG4gICAgICAgICAgICB0aGlzLmNvbmZpZ01vZGFsQnV0dG9ucyhtb2RhbE9wdGlvbnMsIGNtcFIpO1xyXG5cclxuICAgICAgICAgICAgY21wUi5pbnN0YW5jZS5ic01vZGFsUmVmNEFpZlNlbGVjdG9yID0gdGhpcy5tb2RhbFNlcnZpY2Uuc2hvdyhjbXBSLCBtb2RhbE9wdGlvbnMpO1xyXG4gICAgICAgICAgICByZXR1cm4gY21wUi5pbnN0YW5jZS5zdWJqZWN0NEVudGl0eURhdGFzLmFzT2JzZXJ2YWJsZSgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIHJldHVybiBmcm9tKFN5c3RlbS5pbXBvcnQoZm9ybVNldHRpbmdzLnNvdXJjZURhdGFTZWxlY3Rvck1vZHVsZVVybC5zdWJzdHJpbmcoMCwgZm9ybVNldHRpbmdzLnNvdXJjZURhdGFTZWxlY3Rvck1vZHVsZVVybC5pbmRleE9mKFwiI1wiKSkgKyBcIi5qc1wiKSkucGlwZShcclxuICAgICAgICAgICAgcmV0dXJuIGZyb20odGhpcy5sb2FkZXIubG9hZChmb3JtU2V0dGluZ3Muc291cmNlRGF0YVNlbGVjdG9yTW9kdWxlVXJsKSkucGlwZShcclxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcChcclxuICAgICAgICAgICAgICAgICAgICAobW9kdWxlRmFjdG9yeTogTmdNb2R1bGVGYWN0b3J5PElBaWZEYXRhU2VsZWN0b3JNb2R1bGU+KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1vZHVsZVJlZiA9IG1vZHVsZUZhY3RvcnkuY3JlYXRlKHRoaXMuZnJhbWVDb250ZXh0LnJvb3QuaW5qZWN0b3IpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbXBSID0gbW9kdWxlUmVmLmluc3RhbmNlLmNyZWF0ZVNvdXJjZURhdGFTZWxlY3Rvcih0aGlzLmZyYW1lQ29udGV4dC5yb290LmluamVjdG9yKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb25maWdNb2RhbEJ1dHRvbnMobW9kYWxPcHRpb25zLCBjbXBSKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNtcFIuaW5zdGFuY2UuYnNNb2RhbFJlZjRBaWZTZWxlY3RvciA9IHRoaXMubW9kYWxTZXJ2aWNlLnNob3coY21wUiwgbW9kYWxPcHRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNtcFIuaW5zdGFuY2Uuc3ViamVjdDRFbnRpdHlEYXRhcy5hc09ic2VydmFibGUoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6I635Y+W5Lyg5Yiw5qC557uE5Lu2VUlTdGF0ZeS4iueahOeUn+WNleinhOWImeaJp+ihjOWZqOe7k+aenFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgZ2V0UnBjQ3JlYXRpb25SdWxlRXhlY3V0b3JSZXN1bHQoKTogUnBjQ3JlYXRpb25SdWxlRXhlY3V0b3JSZXN1bHQge1xyXG4gICAgICAgIGNvbnN0IHRlbXAgPSB0aGlzLmZyYW1lQ29udGV4dC5yb290LnVpU3RhdGVbdGhpcy5haWZVSVN0YXRlQ3JlYXRpb25SdWxlUmVzdWx0S2V5XTtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgUnBjQ3JlYXRpb25SdWxlRXhlY3V0b3JSZXN1bHQoKTtcclxuICAgICAgICBpZiAodHlwZW9mIHRlbXAgPT0gXCJzdHJpbmdcIikge1xyXG4gICAgICAgICAgICByZXN1bHQuTG9hZEZyb21Kc29uKHRlbXApO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHRlbXAgPT0gXCJvYmplY3RcIikge1xyXG4gICAgICAgICAgICByZXN1bHQuTG9hZEZyb21Kc29uT2JqZWN0KHRlbXApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRocm93IFwi5LiN5ZCI5rOV55qE57G75Z6LXCI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcbn0iXX0=