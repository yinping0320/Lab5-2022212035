import { map } from 'rxjs/operators';
import { DomSanitizer } from '@angular/platform-browser';
import { EndEvent, BpmnModel, Process, BPMNDiagram, SequenceFlow, FlowNode, Node, Edge, FlowNodeState, SequenceFlowState } from '@edp-pmf/bpmn-model';
import { StartActivity, UserActivity, CallActivitySubProcess, AutoActivity, IntermediateCatchEventImpl, OperationActivity, MessageActivity, NotifyActivity, AifCreationBillActivity } from '@gsp-wf/wf-process-model';
import { mxCell, mxGraph, mxEvent, mxConstants, mxPoint, mxRectangle, mxUtils, mxGeometry, mxGraphSelectionModel, mxEventSource } from '@edp-pmf/mxgraph-ts';
import { BsModalService } from '@farris/ui-modal';
import { FrameworkService } from '@gsp-sys/rtf-common';
import { from, of, forkJoin } from 'rxjs';
import { CommonModule } from '@angular/common';
import { HttpService } from '@ecp-caf/caf-common';
import { MessagerService, MessagerModule } from '@farris/ui-messager';
import { FarrisDialogModule } from '@farris/ui-dialog';
import { Injectable, Injector, ComponentFactoryResolver, Component, ViewChild, Input, Output, EventEmitter, HostBinding, ChangeDetectorRef, Optional, ViewContainerRef, ViewEncapsulation, LOCALE_ID, ReflectiveInjector, Pipe, NgModule } from '@angular/core';
import { LayoutModule } from '@farris/ui-layout';
import { FarrisSectionModule } from '@farris/ui-section';
import { WfApprovalLogsModule } from '@gsp-wf/wf-approval-logs';
import { ComboListModule } from '@farris/ui-combo-list';
import { ReactiveFormsModule, FormsModule } from '@angular/forms';
import { FDropdownDirectiveTypeModule } from '@farris/ui-dropdown';
import { DatagridModule } from '@farris/ui-datagrid';
import { NotifyService, NotifyModule } from '@farris/ui-notify';
import { LoadingService, LoadingModule } from '@farris/ui-loading';
import { FarrisTabsModule } from '@farris/ui-tabs';
import { SplitterModule } from '@farris/ui-splitter';

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/** @type {?} */
const en = {
    static: {
        approvalLogs: {
            title: 'Approval Logs',
            approvalOpinion: 'Approval opinion',
            startTime: 'StartTime',
            endTime: 'EndTime',
            todo: 'Todo',
            done: 'Done',
            toAssign: 'To Assign'
        },
        flowchart: {
            title: 'Flow Chart',
            processNotFound: 'process instance id is null',
            flowChart: 'Flow Chart',
            complete: 'Hide Calculated Route',
            simulation: 'Show Calculated Route',
            sequenceColor: 'Description Of Sequence Color',
            completed: 'Completed',
            calculate: 'Calculate Route',
            default: 'Default',
            suspend: 'Calculate Suspend',
            noProcess: 'Process definition not found!',
            list: 'Process List',
            noDataId: 'form id is null',
            noBizDefKey: 'process category id is null'
        }
    }
};

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/** @type {?} */
const zh_CHT = {
    static: {
        approvalLogs: {
            title: '審批記錄',
            approvalOpinion: '審批意見',
            startTime: '接收時間',
            endTime: '處理時間',
            todo: '待辦理',
            done: '已辦理',
            toAssign: '未指派'
        },
        flowchart: {
            title: '查看流程',
            processNotFound: '流程實例ID為空',
            dataIdIsNull: '單據內碼為空',
            flowChart: '流程圖',
            complete: '隱藏計算路線',
            simulation: '顯示計算路線',
            sequenceColor: '分支線顏色說明',
            completed: '已運行',
            calculate: '計算路線',
            default: '默認',
            suspend: '計算中斷',
            noProcess: '未找到符合條件的流程定義！',
            list: '流程列表',
            noDataId: '單據內碼為空',
            noBizDefKey: '流程分類ID為空'
        }
    }
};

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/** @type {?} */
const zh_CHS = {
    static: {
        approvalLogs: {
            title: '审批记录',
            approvalOpinion: '审批意见',
            startTime: '接收时间',
            endTime: '处理时间',
            todo: '待办理',
            done: '已办理',
            toAssign: '未指派'
        },
        flowchart: {
            title: '查看流程',
            processNotFound: '流程实例ID为空',
            dataIdIsNull: '单据内码为空',
            flowChart: '流程图',
            complete: '显示设计路线',
            simulation: '显示预测路线',
            sequenceColor: '分支线颜色说明',
            completed: '已运行',
            calculate: '计算路线',
            default: '默认',
            suspend: '计算中断',
            noProcess: '未找到符合条件的流程定义！',
            list: '流程列表',
            noDataId: '单据内码为空',
            noBizDefKey: '流程分类ID为空'
        }
    }
};

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/** @type {?} */
const translate = {
    'zh-CHS': zh_CHS,
    'en': en,
    'zh-CHT': zh_CHT
};

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class UiFlowchartService {
    /**
     * @param {?} httpSvc
     */
    constructor(httpSvc) {
        this.httpSvc = httpSvc;
    }
    /**
     * @param {?} payload
     * @return {?}
     */
    getForecastProcessListByPayload(payload) {
        /** @type {?} */
        const url = '/api/runtime/wf/v1.0/processInstances/startProcess-simulation';
        return this.httpSvc.post(url, payload).pipe(map((/**
         * @param {?} re
         * @return {?}
         */
        (re) => re.procDefs)));
    }
    /**
     * @param {?} dataId
     * @return {?}
     */
    getRuntimeProcInstsByDataId(dataId) {
        if (dataId) {
            /** @type {?} */
            const url = `/api/runtime/wf/v1.0/processInstances/runtimeProcInstList?dataId=${dataId}`;
            return this.httpSvc.get(url);
        }
        else {
            return from(new Array());
        }
    }
    /**
     * @param {?} dataId
     * @return {?}
     */
    getHistoricProcInstsByDataId(dataId) {
        if (dataId) {
            /** @type {?} */
            const url = `/api/runtime/wf/v1.0/processInstances/historicProcInstList?dataId=${dataId}`;
            return this.httpSvc.get(url);
        }
        else {
            return from(new Array());
        }
    }
    /**
     * 基于流程实例ID获取流程实例
     * @param {?} procInstId 流程实例id
     * @return {?}
     */
    getProcInstanceById(procInstId) {
        /** @type {?} */
        const url = `/api/runtime/wf/v1.0/processInstances/${procInstId}`;
        return this.httpSvc.get(url);
    }
    /**
     * 基于流程实例ID获取bpmnModel
     * @param {?} procInstId
     * @return {?}
     */
    getBpmnModelbyProcInstId(procInstId) {
        /** @type {?} */
        const url = `/api/runtime/wf/v1.0/processInstances/${procInstId}/bpmnModel`;
        return this.httpSvc.get(url);
    }
    /**
     * 基于流程定义ID获取bpmnModel
     * @param {?} procDefId
     * @return {?}
     */
    getBpmnModelbyProcDefId(procDefId) {
        /** @type {?} */
        const url = `/api/runtime/wf/v1.0/procDefs/${procDefId}/bpmnModel`;
        return this.httpSvc.get(url);
    }
    /**
     * @param {?} superActInstId
     * @param {?} superProcInstId
     * @return {?}
     */
    getSubProcessInstance(superActInstId, superProcInstId) {
        if (superActInstId) {
            /** @type {?} */
            const url = `/api/runtime/wf/v1.0/processInstances/subProcInst?superActInstId=${superActInstId}&superProcInstId=${superProcInstId}`;
            return this.httpSvc.get(url);
        }
    }
    /**
     * 获取所有包含预解析的流程实例信息
     * @param {?} procInstId
     * @return {?}
     */
    getForecastProcessByProcInstId(procInstId) {
        /** @type {?} */
        const url = `/api/runtime/wf/v1.0/processInstances/${procInstId}/forecastProcess`;
        return this.httpSvc.get(url);
    }
    /**
     * 获取流程预测数据
     * @param {?} payload
     * @return {?}
     */
    getForecastProcessByPayload(payload) {
        /** @type {?} */
        const url = '/api/runtime/wf/v1.0/processInstances/forecastProcess';
        return this.httpSvc.post(url, payload);
    }
    /**
     * @param {?} procInstId
     * @return {?}
     */
    getCompleteProcessInfoByProcInstId(procInstId) {
        /** @type {?} */
        const url = `/api/runtime/wf/v1.0/processInstances/${procInstId}/flowChartInfo`;
        return this.httpSvc.get(url);
    }
    /**
     * 基于流程实例Id获取所有活动实例
     * @param {?} procInstId procInstId
     * @return {?}
     */
    getAllActiInstsbyProcInstId(procInstId) {
        /** @type {?} */
        const url = `/api/runtime/wf/v1.0/processInstances/${procInstId}/activityInstanceSlims`;
        return this.httpSvc.get(url);
    }
    /**
     * 基于流程实例ID获取所有的流转实例
     * @param {?} procInstId procInstId
     * @return {?}
     */
    getTransitionInstanceSlimsByProcInstId(procInstId) {
        /** @type {?} */
        const url = `/api/runtime/wf/v1.0/processInstances/${procInstId}/transitionInstanceSlims`;
        return this.httpSvc.get(url);
    }
    /**
     * @param {?} procInstId
     * @return {?}
     */
    getFormInfoByProcInstId(procInstId) {
        /** @type {?} */
        const url = `/api/runtime/wf/v1.0/processInstances/${procInstId}/formInfo`;
        return this.httpSvc.get(url);
    }
    /**
     * @param {?} procInstId
     * @param {?} actInstId
     * @return {?}
     */
    getFormInfoByActInstId(procInstId, actInstId) {
        /** @type {?} */
        let url = `/api/runtime/wf/v1.0/processInstances/${procInstId}/formInfo`;
        if (actInstId) {
            url += `?actInstId=${actInstId}`;
        }
        return this.httpSvc.get(url);
    }
    /**
     * 获取审批日志信息
     * @param {?} procInstId
     * @param {?=} activityDefinitionId
     * @return {?}
     */
    getWorkItemLogs(procInstId, activityDefinitionId) {
        /** @type {?} */
        const logUrl = activityDefinitionId ?
            `/api/runtime/wf/v1.0/processInstances/${procInstId}/logs?activityDefinitionId=${activityDefinitionId}` :
            `/api/runtime/wf/v1.0/processInstances/${procInstId}/logs`;
        return this.httpSvc.get(logUrl);
    }
    /**
     * @param {?} name
     * @return {?}
     */
    getI18nValue(name) {
        if (!name) {
            return '';
        }
        /** @type {?} */
        const defaultLang = localStorage.getItem('languageCode');
        /** @type {?} */
        const langData = defaultLang ? translate[defaultLang] : translate['zh-CHS'];
        /** @type {?} */
        let resultVal = '';
        if (name.indexOf('.') === -1) {
            resultVal = langData[name];
        }
        else {
            resultVal = name.split('.').reduce((/**
             * @param {?} obj
             * @param {?} key
             * @return {?}
             */
            (obj, key) => {
                if (obj) {
                    return obj[key];
                }
                else {
                    return null;
                }
            }), langData);
        }
        return resultVal;
    }
    /**
     * @param {?} processId
     * @return {?}
     */
    getProcessInstanceById(processId) {
        /** @type {?} */
        const url = `/api/runtime/wf/v1.0/processInstances/${processId}`;
        return this.httpSvc.get(url);
    }
    /**
     * @param {?} dataId
     * @return {?}
     */
    getProcInstIdByDataId(dataId) {
        /** @type {?} */
        const url = `/api/runtime/wf/v1.0/processInstances/procInstId?bizInstId=${dataId}`;
        return this.httpSvc.get(url);
    }
    /**
     * @param {?} procInstId
     * @param {?} actInstId
     * @param {?} bizInstId
     * @return {?}
     */
    retryAifCreation(procInstId, actInstId, bizInstId) {
        return this.httpSvc.post("/api/runtime/wf/v1.0/aifactivityinstance/retry", actInstId);
    }
    /**
     * 是否是外部流程第三方的任务
     * @param {?} processInstanceId 流程实例ID
     * @return {?}
     */
    ifThirdTask(processInstanceId) {
        /** @type {?} */
        const url = `/api/runtime/task/v1.0/instances/wfExternalProcess?processInstanceId=${processInstanceId}`;
        return this.httpSvc.get(url);
    }
    /**
     * 获取查看共享流程图的相关参数
     * @param {?} bizId 单据内码
     * @return {?}
     */
    getFsParamsByBizId(bizId) {
        /** @type {?} */
        const url = `/api/runtime/task/v1.0/tasks/third/bizId?bizId=${bizId}`;
        return this.httpSvc.get(url);
    }
    /**
     * 获取共享查看流程图的URL
     * @param {?} params 参数
     * @return {?}
     */
    viewFsProcessNew(params) {
        /** @type {?} */
        const url = `/api/fssp/ssp/v1.0/mybill/fswybz/viewprocess`;
        return this.httpSvc.post(url, params);
    }
    /**
     * @return {?}
     */
    getFlowChartStyleConfig() {
        /** @type {?} */
        const url = `/platform/runtime/common/web/@gsp-wf/wf-process-editor/config/cell-style-config.json`;
        return this.httpSvc.get(url);
    }
    /**
     * 获取多实例子流程
     * @param {?} actInst 活动实例
     * @param {?} superProcInstId 父流程实例id
     * @return {?}
     */
    getMutiChildInstance(actInst, superProcInstId) {
        /** @type {?} */
        const actInstId = actInst.activityInstanceId;
        /** @type {?} */
        const isMultiInstanceRoot = actInst.multiInstanceRoot || false;
        /** @type {?} */
        let url = `/api/runtime/wf/v1.0/processInstances/subProcInstList?actInstId=${actInstId}&isMultiInstanceRoot=${isMultiInstanceRoot}&superProcInstId=${superProcInstId}`;
        return this.httpSvc.get(url);
    }
}
UiFlowchartService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
UiFlowchartService.ctorParameters = () => [
    { type: HttpService }
];

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class Cell extends mxCell {
    /**
     * @param {?=} value
     * @param {?=} geometry
     * @param {?=} style
     */
    constructor(value, geometry, style) {
        super(value, geometry, style);
    }
}

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class FlowGraph extends mxGraph {
    /**
     * @param {?} container
     * @param {?=} cellStyleConfig
     */
    constructor(container, cellStyleConfig) {
        super(container);
        this.scrollTileSize = new mxRectangle(0, 0, 400, 600);
        this.cellStyleConfig = {
            edgeStyleDic: {},
            shapeStyleDic: {},
        };
        this.actList = [];
        this.transInsList = [];
        this.rootPath = ''; //基路径
        //基路径
        /**
         * 当前语言
         */
        this.langCode = ((/** @type {?} */ (window))).gspframeworkService && ((/** @type {?} */ (window))).gspframeworkService.rtf.language.getLanguageCode() || localStorage.getItem('languageCode') || 'zh-CHS';
        //获取基路径
        try {
            this.rootPath = ((/** @type {?} */ (window))).gspframeworkService.common.getBasePath.get();
        }
        catch (error) {
        }
        this.cellStyleConfig = cellStyleConfig ? cellStyleConfig : this.cellStyleConfig;
        this.autoScroll = false;
        this.autoExtend = true;
        this.pageVisible = false;
        //this.panningHandler.ignoreCell = true;
        //this.setPanning(true);
        this.setCellsSelectable(true);
        this.setDisconnectOnMove(false);
        //节点不可改变大小
        this.setCellsResizable(false);
        //cell是否可以连线
        this.setConnectable(false);
        //禁止操作
        this.setEnabled(true);
        //设置cell文本是否可移动
        this.setVertexLabelsMovable(false);
        this.setCellsLocked(true);
        //不允许图上存在没有连接活动节点的线（防止拖动线连接点导致失去连接）,还没有找到不允许拖动连接控制点的属性
        this.setAllowDanglingEdges(false);
        mxEvent.disableContextMenu(container);
        // 设置默认样式
        this.setDefaultStyles();
    }
    /**
     * 重写创建节点对象方法
     * @param {?} parent
     * @param {?} id
     * @param {?} value
     * @param {?} x
     * @param {?} y
     * @param {?} width
     * @param {?} height
     * @param {?} style
     * @param {?} relative
     * @return {?}
     */
    createVertex(parent, id, value, x, y, width, height, style, relative) {
        // Creates the geometry for the vertex
        /** @type {?} */
        const geometry = new mxGeometry(x, y, width, height);
        geometry.relative = (relative != null) ? relative : false;
        // Creates the vertex
        /** @type {?} */
        const vertex = new Cell(value, geometry, style);
        vertex.setId(id);
        vertex.setVertex(true);
        vertex.setConnectable(true);
        return vertex;
    }
    /**
     * 重写创建边对象方法
     * @param {?} parent
     * @param {?} id
     * @param {?} value
     * @param {?} source
     * @param {?} target
     * @param {?} style
     * @return {?}
     */
    createEdge(parent, id, value, source, target, style) {
        // Creates the edge
        /** @type {?} */
        var edge = new Cell(value, new mxGeometry(), style);
        edge.setId(id);
        edge.setEdge(true);
        edge.geometry.relative = true;
        return edge;
    }
    /**
     * 设置默认样式
     * @return {?}
     */
    setDefaultStyles() {
        /** @type {?} */
        const styleSheet = this.getStylesheet();
        // 节点默认样式
        /** @type {?} */
        const vertexStyle = styleSheet.getDefaultVertexStyle();
        vertexStyle[mxConstants.STYLE_SHAPE] = mxConstants.SHAPE_IMAGE;
        vertexStyle[mxConstants.STYLE_VERTICAL_LABEL_POSITION] = mxConstants.ALIGN_BOTTOM;
        vertexStyle[mxConstants.STYLE_FONTSIZE] = 12;
        vertexStyle[mxConstants.STYLE_FONTFAMILY] = 'Helvetica';
        vertexStyle[mxConstants.STYLE_FONTCOLOR] = "#333";
        // 连线样式默认为正交
        /** @type {?} */
        const edgeStyle = styleSheet.getDefaultEdgeStyle();
        edgeStyle[mxConstants.STYLE_SOURCE_PORT] = 'e';
        edgeStyle[mxConstants.STYLE_TARGET_PORT] = 'w';
        edgeStyle[mxConstants.STYLE_EDGE] = mxConstants.EDGESTYLE_ORTHOGONAL;
        edgeStyle[mxConstants.STYLE_ROUNDED] = 1;
        edgeStyle[mxConstants.STYLE_STROKECOLOR] = '#6482B9';
        edgeStyle[mxConstants.STYLE_FONTSIZE] = 12;
        edgeStyle[mxConstants.STYLE_FONTFAMILY] = 'Helvetica';
    }
    /**
     * 创建无限大画布
     * @return {?}
     */
    createInfiniteCanvas() {
        this.getPagePadding = (/**
         * @return {?}
         */
        () => {
            return new mxPoint(Math.max(0, Math.round(this.container.offsetWidth - 34)), Math.max(0, Math.round(this.container.offsetHeight - 34)));
        });
        this.getScrollTileSize = (/**
         * @return {?}
         */
        () => {
            if (this.scrollTileSize == null) {
                this.scrollTileSize = new mxRectangle(0, 0, 400, 600);
            }
            return this.scrollTileSize;
        });
        this.getPageSize = (/**
         * @return {?}
         */
        () => {
            return (this.pageVisible) ? new mxRectangle(0, 0, this.pageFormat.width * this.pageScale, this.pageFormat.height * this.pageScale) : this.getScrollTileSize();
        });
        this.getPageLayout = (/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            let size = (this.pageVisible) ? this.getPageSize() : this.getScrollTileSize();
            /** @type {?} */
            let bounds = this.getGraphBounds();
            if (bounds.width == 0 || bounds.height == 0) {
                return new mxRectangle(0, 0, 1, 1);
            }
            else {
                // Computes untransformed graph bounds
                /** @type {?} */
                let x = Math.ceil(bounds.x / this.view.scale - this.view.translate.x);
                /** @type {?} */
                let y = Math.ceil(bounds.y / this.view.scale - this.view.translate.y);
                /** @type {?} */
                let w = Math.floor(bounds.width / this.view.scale);
                /** @type {?} */
                let h = Math.floor(bounds.height / this.view.scale);
                /** @type {?} */
                let x0 = Math.floor(x / size.width);
                /** @type {?} */
                let y0 = Math.floor(y / size.height);
                /** @type {?} */
                let w0 = Math.ceil((x + w) / size.width) - x0;
                /** @type {?} */
                let h0 = Math.ceil((y + h) / size.height) - y0;
                return new mxRectangle(x0, y0, w0, h0);
            }
        });
        this.getPreferredPageSize = (/**
         * @param {?} bounds
         * @param {?} width
         * @param {?} height
         * @return {?}
         */
        (bounds, width, height) => {
            /** @type {?} */
            let pages = this.getPageLayout();
            /** @type {?} */
            let size = this.getPageSize();
            return new mxRectangle(0, 0, pages.width * size.width, pages.height * size.height);
        });
        // 重写画布大小变化后方法
        /** @type {?} */
        const graphSizeDidChange = this.sizeDidChange;
        this.sizeDidChange = (/**
         * @return {?}
         */
        () => {
            if (this.container != null && mxUtils.hasScrollbars(this.container)) {
                /** @type {?} */
                let pages = this.getPageLayout();
                /** @type {?} */
                let pad = this.getPagePadding();
                /** @type {?} */
                let size = this.getPageSize();
                // Updates the minimum graph size
                /** @type {?} */
                let minw = Math.ceil(2 * pad.x / this.view.scale + pages.width * size.width);
                /** @type {?} */
                let minh = Math.ceil(2 * pad.y / this.view.scale + pages.height * size.height);
                /** @type {?} */
                let min = this.minimumGraphSize;
                // LATER: Fix flicker of scrollbar size in IE quirks mode
                // after delayed call in window.resize event handler
                if (min == null || min.width != minw || min.height != minh) {
                    this.minimumGraphSize = new mxRectangle(0, 0, minw, minh);
                }
                // Updates auto-translate to include padding and graph size
                /** @type {?} */
                let dx = pad.x / this.view.scale - pages.x * size.width;
                /** @type {?} */
                let dy = pad.y / this.view.scale - pages.y * size.height;
                if (!this.autoTranslate && (this.view.translate.x != dx || this.view.translate.y != dy)) {
                    this.autoTranslate = true;
                    ((/** @type {?} */ (this.view))).x0 = pages.x;
                    ((/** @type {?} */ (this.view))).y0 = pages.y;
                    /** @type {?} */
                    let tx = this.view.translate.x;
                    /** @type {?} */
                    let ty = this.view.translate.y;
                    this.view.setTranslate(dx, dy);
                    this.container.scrollLeft += (dx - tx) * this.view.scale;
                    this.container.scrollTop += (dy - ty) * this.view.scale;
                    this.autoTranslate = false;
                    return;
                }
                graphSizeDidChange.apply(this, []);
            }
        });
        // 重写view获取背景页大小
        this.view.getBackgroundPageBounds = (/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            let layout = this.getPageLayout();
            /** @type {?} */
            let page = this.getPageSize();
            return new mxRectangle(this.view.scale * (this.view.translate.x + layout.x * page.width), this.view.scale * (this.view.translate.y + layout.y * page.height), this.view.scale * layout.width * page.width, this.view.scale * layout.height * page.height);
        });
        // 重写view validate方法
        /** @type {?} */
        const graphViewValidate = this.view.validate;
        this.view.validate = (/**
         * @param {?=} cell
         * @return {?}
         */
        (cell) => {
            if (this.container != null && mxUtils.hasScrollbars(this.container)) {
                /** @type {?} */
                let pad = this.getPagePadding();
                /** @type {?} */
                let size = this.getPageSize();
                /** @type {?} */
                let tx = this.view.translate.x;
                /** @type {?} */
                let ty = this.view.translate.y;
                this.view.translate.x = pad.x / this.view.scale - (((/** @type {?} */ (this.view))).x0 || 0) * size.width;
                this.view.translate.y = pad.y / this.view.scale - (((/** @type {?} */ (this.view))).y0 || 0) * size.height;
            }
            graphViewValidate.apply(this.view, [cell]);
        });
    }
    /**
     * 创建BpmnModel
     * @return {?}
     */
    createBpmnModel() {
        /** @type {?} */
        const bpmnModel = new BpmnModel();
        bpmnModel.TargetNamespace = "Default_Namespace";
        bpmnModel.DefaultProcess = new Process(bpmnModel);
        bpmnModel.DefaultDiagram = new BPMNDiagram(bpmnModel);
        bpmnModel.DefaultDiagram.BpmnPlane.BpmnElementId = bpmnModel.DefaultProcess.Id;
        return bpmnModel;
    }
    /**
     * 加载BpmnModel并画图
     * @param {?} json
     * @return {?}
     */
    loadBpmnModel(json) {
        this.removeCells(this.getChildCells(this.getDefaultParent()));
        this.bpmnModel = this.createBpmnModel();
        this.bpmnModel.LoadFromJson(json);
        this.drawBpmnGraph(this.bpmnModel);
    }
    /**
     * 重新加载BpmnModel并画图
     * @param {?=} json
     * @return {?}
     */
    reloadBpmnModel(json) {
        this.removeCells(this.getChildCells(this.getDefaultParent()));
        if (json) {
            this.loadBpmnModel(json);
        }
        else {
            this.drawBpmnGraph(this.bpmnModel);
        }
    }
    /**
     * 根据BpmnModel画图
     * @param {?} bpmnModel
     * @return {?}
     */
    drawBpmnGraph(bpmnModel) {
        const { nodeDict, edgeDict } = this.buildFlowDiagDict(bpmnModel);
        /** @type {?} */
        const flowDict = this.buildFlowDict(bpmnModel);
        this.drawNodeCells(flowDict, nodeDict);
        this.drawEdgeCells(flowDict, edgeDict);
        this.getModel().beginUpdate();
        if (this.mode === 'simulation') {
            this.drawInterceptGraph(flowDict, nodeDict, edgeDict);
            this.addJumpEdges(flowDict);
        }
        this.getModel().endUpdate();
    }
    /**
     * @private
     * @param {?} flowDict
     * @param {?} nodeDict
     * @param {?} edgeDict
     * @return {?}
     */
    drawInterceptGraph(flowDict, nodeDict, edgeDict) {
        /** @type {?} */
        const firstAct = this.findFirstStartActivityInstance(this.actList);
        // todo：此处待修复
        /** @type {?} */
        let endActDef;
        for (const key in flowDict) {
            if (flowDict[key] instanceof EndEvent) {
                endActDef = (/** @type {?} */ (flowDict[key]));
            }
        }
        if (firstAct) {
            /** @type {?} */
            const endActiInstList = this.findEndActiInstList(firstAct, this.actList, this.transInsList);
            endActiInstList.forEach(((/**
             * @param {?} endActiInst
             * @return {?}
             */
            endActiInst => {
                if (endActiInst.activityDefinitionId !== endActDef.Id) {
                    this.drawNextFlowChart(endActiInst.activityDefinitionId, nodeDict, edgeDict);
                }
            })));
        }
    }
    /**
     * @param {?} flowDict
     * @return {?}
     */
    addJumpEdges(flowDict) {
        /** @type {?} */
        const nodeCells = (/** @type {?} */ ((this.getChildCells(this.getDefaultParent(), true) || [])));
        /** @type {?} */
        const noIncomingNodes = this.findNoIncomingNodes(nodeCells);
        for (const node of noIncomingNodes) {
            /** @type {?} */
            const actInst = this.actList.filter((/**
             * @param {?} a
             * @return {?}
             */
            a => a.activityDefinitionId === node.flowElement.Id))[0];
            /** @type {?} */
            const cellId = actInst.precursorActivityDefinitionId + '_' + actInst.activityDefinitionId;
            /** @type {?} */
            const source = nodeCells.find((/**
             * @param {?} it
             * @return {?}
             */
            (it) => {
                return it.flowElement && it.flowElement.Id === actInst.precursorActivityDefinitionId;
            }));
            /** @type {?} */
            const target = nodeCells.find((/**
             * @param {?} it
             * @return {?}
             */
            (it) => {
                return it.flowElement && it.flowElement.Id === actInst.activityDefinitionId;
            }));
            /** @type {?} */
            const map$$1 = new Map();
            map$$1.set('jump', true);
            /** @type {?} */
            const style = this.getEdgeStyle(null, null, map$$1);
            /** @type {?} */
            const cell = (/** @type {?} */ (this.insertEdge(this.getDefaultParent(), cellId, '', source, target, style)));
            if (cell !== null) {
                cell.source = source;
                cell.target = target;
                cell.geometry.points = [
                // new mxPoint(source.geometry.x+ source.geometry.width/2, target.geometry.y+target.geometry.height/2)
                ];
                console.log(cell);
                this.moveCells([cell], undefined, undefined, undefined, this.getDefaultParent());
            }
        }
    }
    /**
     * 画节点
     * @param {?} flowDict
     * @param {?} nodeDict
     * @param {?=} additional
     * @return {?}
     */
    drawNodeCells(flowDict, nodeDict, additional = false) {
        Object.keys(nodeDict).forEach((/**
         * @param {?} bpmnModelElementId
         * @return {?}
         */
        (bpmnModelElementId) => {
            /** @type {?} */
            const flowElt = flowDict[bpmnModelElementId];
            /** @type {?} */
            const diagElt = (/** @type {?} */ (nodeDict[bpmnModelElementId]));
            if (flowElt == null) {
                return;
            }
            this.drawNodeCell(flowElt, diagElt, additional);
        }));
    }
    /**
     * 画单个节点
     * @param {?} flowElt
     * @param {?} diagElt
     * @param {?} additional
     * @return {?}
     */
    drawNodeCell(flowElt, diagElt, additional) {
        /** @type {?} */
        const style = this.getVertexStyle(flowElt, diagElt, additional);
        /** @type {?} */
        let cell = null;
        /** @type {?} */
        let label = "";
        if (flowElt != null) {
            label = flowElt.Name;
            if (flowElt.NameLanguage && flowElt.NameLanguage[this.langCode] != null) {
                label = flowElt.NameLanguage[this.langCode];
            }
        }
        if (this.mode === 'simulation') {
            if (this.actList.findIndex((/**
             * @param {?} a
             * @return {?}
             */
            a => a.activityDefinitionId === flowElt.Id)) > -1) {
                cell = (/** @type {?} */ (this.insertVertex(this.getDefaultParent(), flowElt.Id, label, diagElt.Bounds.X, diagElt.Bounds.Y, diagElt.Bounds.Width, diagElt.Bounds.Height, style)));
            }
            else if (additional) {
                cell = (/** @type {?} */ (this.insertVertex(this.getDefaultParent(), flowElt.Id, label, diagElt.Bounds.X, diagElt.Bounds.Y, diagElt.Bounds.Width, diagElt.Bounds.Height, style)));
            }
        }
        else {
            cell = (/** @type {?} */ (this.insertVertex(this.getDefaultParent(), flowElt.Id, label, diagElt.Bounds.X, diagElt.Bounds.Y, diagElt.Bounds.Width, diagElt.Bounds.Height, style)));
        }
        if (cell == null) {
            return;
        }
        // const cell = this.insertVertex(this.getDefaultParent(), flowElt.Id, label, diagElt.Bounds.X, diagElt.Bounds.Y, diagElt.Bounds.Width, diagElt.Bounds.Height, style) as Cell;
        cell.flowElement = flowElt;
        cell.diagramElement = diagElt;
        this.moveCells([cell], undefined, undefined, undefined, this.getDefaultParent());
    }
    /**
     * 画连线
     * @param {?} flowDict
     * @param {?} edgeDict
     * @param {?=} additional
     * @param {?=} cut
     * @return {?}
     */
    drawEdgeCells(flowDict, edgeDict, additional = false, cut = false) {
        Object.keys(edgeDict).forEach((/**
         * @param {?} bpmnModelElementId
         * @return {?}
         */
        (bpmnModelElementId) => {
            /** @type {?} */
            const flowElt = (/** @type {?} */ (flowDict[bpmnModelElementId]));
            /** @type {?} */
            const diagElt = (/** @type {?} */ (edgeDict[bpmnModelElementId]));
            if (flowElt == null) {
                return;
            }
            this.drawEdgeCell(flowElt, diagElt, additional, cut);
        }));
    }
    /**
     * @private
     * @param {?} flowDict
     * @param {?} sourceId
     * @param {?} targetId
     * @return {?}
     */
    judgeConnectBetweenTwoNodes(flowDict, sourceId, targetId) {
        /** @type {?} */
        const source = (/** @type {?} */ (flowDict[sourceId]));
        /** @type {?} */
        const outGoings = source.Outgoings;
        if (!outGoings || outGoings.length === 0) {
            return false;
        }
        for (const outGoing of outGoings) {
            /** @type {?} */
            const sequenceFlow = (/** @type {?} */ (flowDict[outGoing]));
            if (sequenceFlow.TargetRef === targetId) {
                return true;
            }
        }
        return false;
    }
    /**
     * 画单条连线
     * @param {?} flowElt
     * @param {?} diagElt
     * @param {?} additional
     * @param {?} cut
     * @return {?}
     */
    drawEdgeCell(flowElt, diagElt, additional, cut) {
        // 获取已插入的节点元素
        /** @type {?} */
        const nodeCells = (/** @type {?} */ ((this.getChildCells(this.getDefaultParent(), true) || [])));
        /** @type {?} */
        const source = nodeCells.find((/**
         * @param {?} it
         * @return {?}
         */
        (it) => {
            return it.flowElement && it.flowElement.Id === flowElt.SourceRef;
        }));
        /** @type {?} */
        const target = nodeCells.find((/**
         * @param {?} it
         * @return {?}
         */
        (it) => {
            return it.flowElement && it.flowElement.Id === flowElt.TargetRef;
        }));
        /** @type {?} */
        const map$$1 = new Map();
        map$$1.set('additional', additional);
        map$$1.set('cut', cut);
        /** @type {?} */
        const style = this.getEdgeStyle(flowElt, diagElt, map$$1);
        /** @type {?} */
        let cell = null;
        /** @type {?} */
        let label = "";
        if (flowElt != null) {
            label = flowElt.Name;
            if (flowElt.NameLanguage && flowElt.NameLanguage[this.langCode] != null) {
                label = flowElt.NameLanguage[this.langCode];
            }
        }
        if (this.mode === 'simulation') {
            if (this.transInsList.findIndex((/**
             * @param {?} a
             * @return {?}
             */
            a => a.sourceActivityDefinitionId === flowElt.SourceRef
                && a.destinationActivityDefinitionId === flowElt.TargetRef)) > -1) {
                cell = (/** @type {?} */ (this.insertEdge(this.getDefaultParent(), flowElt.Id, label, source, target, style)));
            }
            else if (additional || cut) {
                cell = (/** @type {?} */ (this.insertEdge(this.getDefaultParent(), flowElt.Id, label, source, target, style)));
            }
        }
        else {
            cell = (/** @type {?} */ (this.insertEdge(this.getDefaultParent(), flowElt.Id, label, source, target, style)));
        }
        if (cell == null) {
            return;
        }
        // const cell = this.insertEdge(this.getDefaultParent(), flowElt.Id, label, source, target, style) as Cell;
        // cell.geometry.relative = true;
        cell.flowElement = flowElt;
        cell.diagramElement = diagElt;
        cell.source = source;
        cell.target = target;
        cell.geometry.points = cell.geometry.points || [];
        // 判断是否为旧版本连线
        if (this.isOldBpmnEdge(diagElt)) {
            for (let i = 2; i < diagElt.Points.length; i++) {
                /** @type {?} */
                const pt = diagElt.Points[i];
                cell.geometry.points.push(new mxPoint(pt.X, pt.Y));
            }
            // 此行代码执行后可获取mxCellState
            this.moveCells([cell], undefined, undefined, undefined, this.getDefaultParent());
            //按坐标插入label
            /** @type {?} */
            const state = this.view.getState(cell);
            if (diagElt.BpmnLabel && state) {
                if (diagElt.BpmnLabel.Bounds.X === 0 && diagElt.BpmnLabel.Bounds.Y === 0) {
                    return;
                }
                /** @type {?} */
                const x = diagElt.BpmnLabel.Bounds.X + (state.x - state.paintBounds.x);
                /** @type {?} */
                const y = diagElt.BpmnLabel.Bounds.Y + (state.y - state.paintBounds.y);
                /** @type {?} */
                const edgeHandler = this.createEdgeHandler(state, undefined);
                edgeHandler.moveLabel(state, x, y);
                edgeHandler.destroy();
            }
        }
        else {
            for (let i = 1; i < diagElt.Points.length - 1; i++) {
                /** @type {?} */
                const pt = diagElt.Points[i];
                cell.geometry.points.push(new mxPoint(pt.X, pt.Y));
            }
            // 此行代码执行后可获取mxCellState
            this.moveCells([cell], undefined, undefined, undefined, this.getDefaultParent());
            //按坐标插入label
            /** @type {?} */
            const state = this.view.getState(cell);
            /** @type {?} */
            const scale = this.view.getScale();
            /** @type {?} */
            const translate = this.view.getTranslate();
            if (diagElt.BpmnLabel && state) {
                if (diagElt.BpmnLabel.Bounds.X === 0 && diagElt.BpmnLabel.Bounds.Y === 0) {
                    return;
                }
                /** @type {?} */
                const x = diagElt.BpmnLabel.Bounds.X * scale + translate.x;
                /** @type {?} */
                const y = diagElt.BpmnLabel.Bounds.Y * scale + translate.y;
                /** @type {?} */
                const edgeHandler = this.createEdgeHandler(state, undefined);
                edgeHandler.moveLabel(state, x, y);
                edgeHandler.destroy();
            }
        }
    }
    /**
     * 构建FlowElement字典，{ [flowEltId: string]: FlowElement }
     * @param {?} bpmnModel
     * @return {?}
     */
    buildFlowDict(bpmnModel) {
        /** @type {?} */
        let flowDict = bpmnModel.DefaultProcess.GetFlowElements();
        return flowDict;
    }
    /**
     * 构建DiagramElement字典，{ [flowEltId: string]: DiagramElement }
     * @param {?} bpmnModel
     * @return {?}
     */
    buildFlowDiagDict(bpmnModel) {
        /** @type {?} */
        const nodeDict = {};
        /** @type {?} */
        const edgeDict = {};
        /** @type {?} */
        const diagramElts = (/** @type {?} */ (bpmnModel.DefaultDiagram.BpmnPlane.GetDiagramElements()));
        diagramElts && diagramElts.forEach((/**
         * @param {?} elt
         * @return {?}
         */
        elt => {
            if (elt instanceof Node) {
                nodeDict[elt.BpmnElementId] = elt;
            }
            else if (elt instanceof Edge) {
                edgeDict[elt.BpmnElementId] = elt;
            }
        }));
        return {
            nodeDict,
            edgeDict,
        };
    }
    /**
     * 判断是否为旧版本BPMNEdge
     *
     * 旧版本连线Points数组中[0]和[1]分别表示起点和终点，因取值错误，[0]和[1]坐标均为(0,0)，以此为依据判断是否为旧版本的连线
     * 新版本从起点到终点按顺序记录每一个点坐标
     * @param {?} bpmnEdge
     * @return {?}
     */
    isOldBpmnEdge(bpmnEdge) {
        if (bpmnEdge.Points.length >= 2) {
            /** @type {?} */
            const pt1 = bpmnEdge.Points[0];
            /** @type {?} */
            const pt2 = bpmnEdge.Points[1];
            if (pt1.X == 0 && pt1.Y == 0 && pt2.X == 0 && pt2.Y == 0) {
                return true;
            }
        }
        return false;
    }
    /**
     * 获取节点样式
     * @param {?} flowElt
     * @param {?} diagElt
     * @param {?} additional
     * @return {?}
     */
    getVertexStyle(flowElt, diagElt, additional) {
        /** @type {?} */
        const activityInstanceSlims = this.actList;
        /** @type {?} */
        let stateShapeStyle = null;
        // 特殊处理,业务活动要单独赋成人工操作类型的样式
        // if (flowElt.ClrTypeID === UserActivity.Clr_Type_ID) {
        //   stateShapeStyle = this.cellStyleConfig.shapeStyleDic && this.cellStyleConfig.shapeStyleDic[flowElt.ClrTypeID];
        // } else if (flowElt.ClrTypeID === OperationActivity.Clr_Type_ID) {
        //   stateShapeStyle = this.cellStyleConfig.shapeStyleDic && this.cellStyleConfig.shapeStyleDic[OperationActivity.Clr_Type_ID];
        // }
        if (flowElt instanceof UserActivity && flowElt.BizActivityID !== '') {
            stateShapeStyle = this.cellStyleConfig.shapeStyleDic && this.cellStyleConfig.shapeStyleDic[OperationActivity.Clr_Type_ID];
        }
        else {
            stateShapeStyle = this.cellStyleConfig.shapeStyleDic && this.cellStyleConfig.shapeStyleDic[flowElt.ClrTypeID];
        }
        if (stateShapeStyle == null) {
            return this.getVertexStyleOld(flowElt, additional);
        }
        /** @type {?} */
        let img = stateShapeStyle[FlowNodeState.Default] && stateShapeStyle[FlowNodeState.Default].image;
        if (!additional) {
            /** @type {?} */
            const acts = activityInstanceSlims.filter((/**
             * @param {?} item
             * @return {?}
             */
            item => item.activityDefinitionId === flowElt.Id));
            if (acts && acts.length > 0) {
                if (acts.filter((/**
                 * @param {?} act
                 * @return {?}
                 */
                act => act.state === 'RUNNING')).length > 0) {
                    if (stateShapeStyle[FlowNodeState.Running]) {
                        img = stateShapeStyle[FlowNodeState.Running].image;
                    }
                }
                else if (acts.filter((/**
                 * @param {?} act
                 * @return {?}
                 */
                act => act.state === 'COMPLETED')).length > 0) {
                    if (stateShapeStyle[FlowNodeState.Completed]) {
                        img = stateShapeStyle[FlowNodeState.Completed].image;
                    }
                }
                else if (acts.filter((/**
                 * @param {?} act
                 * @return {?}
                 */
                act => act.state === 'TERMINATED')).length > 0) {
                    if (stateShapeStyle[FlowNodeState.Terminated]) {
                        img = stateShapeStyle[FlowNodeState.Terminated].image;
                    }
                }
            }
        }
        return img == null ? null : 'image=' + this.rootPath + img;
    }
    /**
     * 旧版diagramElement未存储样式信息
     * @param {?} flowElt
     * @param {?} additional
     * @return {?}
     */
    getVertexStyleOld(flowElt, additional) {
        /** @type {?} */
        let style;
        switch (flowElt.ClrTypeID) {
            //结束事件
            case "bpmn.EndEvent":
                style = 'end';
                break;
            //流程开始活动节点
            case StartActivity.Clr_Type_ID:
                style = 'start';
                break;
            // 业务活动节点
            case UserActivity.Clr_Type_ID:
                if (((/** @type {?} */ (flowElt))).BizActivityID) {
                    style = 'bizActivity';
                }
                else {
                    style = 'approval';
                }
                break;
            // 排他网关
            case 'bpmn.ExclusiveGateway':
                style = 'ExclusiveGateway';
                break;
            //并行网关
            case 'bpmn.ParallelGateway':
                style = 'ParallelGateway';
                break;
            case CallActivitySubProcess.Clr_Type_ID:
                style = 'sub';
                break;
            case AutoActivity.Clr_Type_ID:
                style = 'auto';
                break;
            case IntermediateCatchEventImpl.Clr_Type_ID:
                style = 'catchEvent';
                break;
            case OperationActivity.Clr_Type_ID:
                style = 'bizActivity';
                break;
            case MessageActivity.Clr_Type_ID:
                style = 'message';
                break;
            case NotifyActivity.Clr_Type_ID:
                style = 'notify';
                break;
            case AifCreationBillActivity.Clr_Type_ID:
                style = 'aifCreationActivity';
                break;
            default:
                break;
        }
        return 'image=' + this.rootPath + '/platform/runtime/common/web/@gsp-wf/wf-process-editor/images/' + style + this.getChartState(flowElt, additional) + ';';
    }
    /**
     * @param {?} flowElt
     * @param {?} additional
     * @return {?}
     */
    getChartState(flowElt, additional) {
        if (!additional) {
            /** @type {?} */
            const acts = this.actList.filter((/**
             * @param {?} item
             * @return {?}
             */
            item => item.activityDefinitionId === flowElt.Id));
            if (acts && acts.length > 0) {
                if (acts.filter((/**
                 * @param {?} act
                 * @return {?}
                 */
                act => act.state === 'RUNNING')).length > 0) {
                    return '_light.gif';
                }
                else if (acts.filter((/**
                 * @param {?} act
                 * @return {?}
                 */
                act => act.state === 'COMPLETED')).length > 0
                    || acts.filter((/**
                     * @param {?} act
                     * @return {?}
                     */
                    act => act.state === 'TERMINATED')).length > 0) {
                    return '_gray.png';
                }
                else {
                    return '.png';
                }
            }
        }
        return '.png';
    }
    /**
     * 获取连线样式
     * @param {?} flowElt
     * @param {?} diagElt
     * @param {?} parameters
     * @return {?}
     */
    getEdgeStyle(flowElt, diagElt, parameters) {
        if (parameters.get('jump')) {
            /** @type {?} */
            let style = '';
            /** @type {?} */
            const stateEdgeStyle = this.cellStyleConfig.edgeStyleDic && this.cellStyleConfig.edgeStyleDic['bpmn.SequenceFlow'];
            if (stateEdgeStyle['jump']) {
                Object.keys(stateEdgeStyle['jump']).forEach((/**
                 * @param {?} key
                 * @return {?}
                 */
                (key) => {
                    style += (`${key}=${stateEdgeStyle['jump'][key]};`);
                }));
                return style;
            }
            return null;
        }
        else {
            /** @type {?} */
            const stateEdgeStyle = this.cellStyleConfig.edgeStyleDic && this.cellStyleConfig.edgeStyleDic[flowElt.ClrTypeID];
            if (stateEdgeStyle == null) {
                return this.getEdgeStyleOld(flowElt, parameters.get('additional'), parameters.get('cut'));
            }
            /** @type {?} */
            const transitionInstanceSlims = this.transInsList;
            /** @type {?} */
            let style = '';
            if (parameters.get('cut')) {
                if (stateEdgeStyle[SequenceFlowState.Cut]) {
                    Object.keys(stateEdgeStyle[SequenceFlowState.Cut]).forEach((/**
                     * @param {?} key
                     * @return {?}
                     */
                    (key) => {
                        style += (`${key}=${stateEdgeStyle[SequenceFlowState.Cut][key]};`);
                    }));
                    return style;
                }
            }
            if (parameters.get('additional')) {
                if (stateEdgeStyle[SequenceFlowState.Add]) {
                    Object.keys(stateEdgeStyle[SequenceFlowState.Add]).forEach((/**
                     * @param {?} key
                     * @return {?}
                     */
                    (key) => {
                        style += (`${key}=${stateEdgeStyle[SequenceFlowState.Add][key]};`);
                    }));
                    return style;
                }
            }
            /** @type {?} */
            const transIns = transitionInstanceSlims.filter((/**
             * @param {?} item
             * @return {?}
             */
            item => item.sourceActivityDefinitionId === flowElt.SourceRef && item.destinationActivityDefinitionId === flowElt.TargetRef));
            if (transIns && transIns.filter((/**
             * @param {?} t
             * @return {?}
             */
            t => t.state === 'COMPLETED')).length > 0) {
                if (stateEdgeStyle[SequenceFlowState.Completed]) {
                    Object.keys(stateEdgeStyle[SequenceFlowState.Completed]).forEach((/**
                     * @param {?} key
                     * @return {?}
                     */
                    (key) => {
                        style += (`${key}=${stateEdgeStyle[SequenceFlowState.Completed][key]};`);
                    }));
                    return style;
                }
            }
            if (this.mode === 'simulation') {
                if (stateEdgeStyle[SequenceFlowState.Simulation]) {
                    Object.keys(stateEdgeStyle[SequenceFlowState.Simulation]).forEach((/**
                     * @param {?} key
                     * @return {?}
                     */
                    (key) => {
                        style += (`${key}=${stateEdgeStyle[SequenceFlowState.Simulation][key]};`);
                    }));
                    return style;
                }
            }
            if (stateEdgeStyle[SequenceFlowState.Default]) {
                Object.keys(stateEdgeStyle[SequenceFlowState.Default]).forEach((/**
                 * @param {?} key
                 * @return {?}
                 */
                (key) => {
                    style += (`${key}=${stateEdgeStyle[SequenceFlowState.Default][key]};`);
                }));
            }
            return style;
        }
    }
    /**
     * 获取连线颜色
     * @param {?} flowElt
     * @param {?} diagElt
     * @param {?} additional
     * @param {?} cut
     * @return {?}
     */
    getStrokeColor(flowElt, diagElt, additional, cut) {
        /** @type {?} */
        const transitionInstanceSlims = this.transInsList;
        /** @type {?} */
        const stateEdgeStyle = this.cellStyleConfig.edgeStyleDic && this.cellStyleConfig.edgeStyleDic[flowElt.ClrTypeID];
        if (cut) {
            if (stateEdgeStyle[SequenceFlowState.Cut]) {
                return stateEdgeStyle[SequenceFlowState.Cut].strokeColor;
            }
        }
        if (additional) {
            if (stateEdgeStyle[SequenceFlowState.Add]) {
                return stateEdgeStyle[SequenceFlowState.Add].strokeColor;
            }
        }
        /** @type {?} */
        const transIns = transitionInstanceSlims.filter((/**
         * @param {?} item
         * @return {?}
         */
        item => item.sourceActivityDefinitionId === flowElt.SourceRef && item.destinationActivityDefinitionId === flowElt.TargetRef));
        if (transIns && transIns.filter((/**
         * @param {?} t
         * @return {?}
         */
        t => t.state === 'COMPLETED')).length > 0) {
            if (stateEdgeStyle[SequenceFlowState.Completed]) {
                return stateEdgeStyle[SequenceFlowState.Completed].strokeColor;
            }
        }
        if (this.mode === 'simulation') {
            if (stateEdgeStyle[SequenceFlowState.Simulation]) {
                return stateEdgeStyle[SequenceFlowState.Simulation].strokeColor;
            }
        }
        return stateEdgeStyle[SequenceFlowState.Default].strokeColor;
    }
    /**
     * 旧版diagramElement未存储样式信息
     * @param {?} seq
     * @param {?} additional
     * @param {?} cut
     * @return {?}
     */
    getEdgeStyleOld(seq, additional, cut) {
        if (cut) {
            return 'strokeColor=#FF4040';
        }
        if (additional) {
            return 'strokeColor=#59A1FF';
        }
        /** @type {?} */
        const transIns = this.transInsList.filter((/**
         * @param {?} item
         * @return {?}
         */
        item => item.sourceActivityDefinitionId === seq.SourceRef && item.destinationActivityDefinitionId === seq.TargetRef));
        if (transIns && transIns.filter((/**
         * @param {?} t
         * @return {?}
         */
        t => t.state === 'COMPLETED')).length > 0) {
            return 'strokeColor=#595959;strokeWidth=2;';
        }
        if (this.mode === 'simulation') {
            return 'strokeColor=#f59c24;dashed=1;';
        }
        else {
            return 'strokeColor=#59A1FF;';
        }
    }
    /**
     * @param {?} actiDefId
     * @param {?} nodeDict
     * @param {?} edgeDict
     * @return {?}
     */
    drawNextFlowChart(actiDefId, nodeDict, edgeDict) {
        const { nextFlowNodeDict, nextSeqFlowDict } = this.findDrawFlowElementsByActDefId(actiDefId, this.bpmnModel);
        /** @type {?} */
        const actDef = (/** @type {?} */ (this.bpmnModel.DefaultProcess.GetFlowElement(actiDefId)));
        /** @type {?} */
        const outgoings = actDef.Outgoings;
        // 先插入节点
        Object.keys(nextFlowNodeDict).forEach((/**
         * @param {?} id
         * @return {?}
         */
        id => {
            /** @type {?} */
            const flowElt = nextFlowNodeDict[id];
            /** @type {?} */
            const diagElt = (/** @type {?} */ (nodeDict[flowElt.Id]));
            /** @type {?} */
            const cell = this.getCellByFlowElementId(flowElt.Id);
            if (!cell) {
                this.drawNodeCell(flowElt, diagElt, true);
            }
        }));
        // 再插入边
        Object.keys(nextSeqFlowDict).forEach((/**
         * @param {?} id
         * @return {?}
         */
        id => {
            /** @type {?} */
            const flowElt = nextSeqFlowDict[id];
            /** @type {?} */
            const diagElt = (/** @type {?} */ (edgeDict[flowElt.Id]));
            /** @type {?} */
            const cell = this.getCellByFlowElementId(flowElt.Id);
            if (!cell) {
                if (outgoings.some((/**
                 * @param {?} o
                 * @return {?}
                 */
                o => o === flowElt.Id))) {
                    this.drawEdgeCell(flowElt, diagElt, true, true);
                }
                else {
                    this.drawEdgeCell(flowElt, diagElt, true, false);
                }
            }
        }));
    }
    /**
     * 根据flowElementId获取cell
     * @param {?} flowEltId
     * @param {?=} parent
     * @return {?}
     */
    getCellByFlowElementId(flowEltId, parent) {
        parent = parent ? parent : this.getDefaultParent();
        /** @type {?} */
        const cells = this.getChildCells(parent);
        /** @type {?} */
        const cell = (/** @type {?} */ (cells.find((/**
         * @param {?} it
         * @return {?}
         */
        it => {
            if (it instanceof Cell) {
                return it.flowElement && it.flowElement.Id == flowEltId;
            }
            else {
                return false;
            }
        }))));
        return cell;
    }
    /**
     * @param {?} activities
     * @return {?}
     */
    findFirstStartActivityInstance(activities) {
        for (const act of activities) {
            if (!act.precursorActivityDefinitionId) {
                return act;
            }
        }
        return null;
    }
    /**
     * @param {?} nodeCells
     * @return {?}
     */
    findNoIncomingNodes(nodeCells) {
        /** @type {?} */
        const noIncomingNodes = new Array();
        for (const node of nodeCells) {
            if (node.flowElement.ClrTypeID === 'wf.StartActivity') {
                continue;
            }
            if (!node.edges || node.edges.length === 0) {
                noIncomingNodes.push(node);
                continue;
            }
            if (!node.edges.some((/**
             * @param {?} edge
             * @return {?}
             */
            edge => ((/** @type {?} */ (edge.target))).flowElement.Id === node.flowElement.Id))) {
                noIncomingNodes.push(node);
            }
        }
        return noIncomingNodes;
    }
    /**
     * @param {?} firstAct
     * @param {?} activities
     * @param {?} transInsList
     * @return {?}
     */
    findEndActiInstList(firstAct, activities, transInsList) {
        /** @type {?} */
        const endActiInstList = [];
        this.getNextTransitions(endActiInstList, firstAct.activityInstanceId, activities, transInsList);
        return endActiInstList;
    }
    /**
     * @param {?} endActiInstList
     * @param {?} sourceActInstId
     * @param {?} activities
     * @param {?} transInsList
     * @return {?}
     */
    getNextTransitions(endActiInstList, sourceActInstId, activities, transInsList) {
        /** @type {?} */
        const nextTransitions = this.findTranInstsBySourceActInstId(sourceActInstId, transInsList);
        if (nextTransitions && nextTransitions.length > 0) {
            for (const t of nextTransitions) {
                if (t.destinationActivityDefinitionId) {
                    this.getNextTransitions(endActiInstList, t.destinationActivityInstanceId, activities, transInsList);
                }
            }
        }
        else {
            /** @type {?} */
            const actInst = this.findActInstByActInstId(sourceActInstId, activities);
            if (actInst) {
                if (!endActiInstList.some((/**
                 * @param {?} a
                 * @return {?}
                 */
                a => a.activityInstanceId === actInst.activityInstanceId))) {
                    endActiInstList.push(actInst);
                }
            }
        }
    }
    /**
     * @param {?} sourceActInstId
     * @param {?} transInsList
     * @return {?}
     */
    findTranInstsBySourceActInstId(sourceActInstId, transInsList) {
        return transInsList.filter((/**
         * @param {?} t
         * @return {?}
         */
        t => t.sourceActivityInstanceId === sourceActInstId));
    }
    /**
     * @param {?} actInstId
     * @param {?} activities
     * @return {?}
     */
    findActInstByActInstId(actInstId, activities) {
        return activities.find((/**
         * @param {?} a
         * @return {?}
         */
        a => a.activityInstanceId === actInstId));
    }
    /**
     * @param {?} actiDefId
     * @param {?} bpmnModel
     * @return {?}
     */
    findDrawFlowElementsByActDefId(actiDefId, bpmnModel) {
        /** @type {?} */
        const nextFlowNodeDict = {};
        /** @type {?} */
        const nextSeqFlowDict = {};
        this.findNextFlowElementsByFlowElementId(nextFlowNodeDict, nextSeqFlowDict, actiDefId, bpmnModel);
        return {
            nextFlowNodeDict,
            nextSeqFlowDict,
        };
    }
    /**
     * @param {?} nextFlowNodeDict
     * @param {?} nextSeqFlowDict
     * @param {?} flowElementId
     * @param {?} bpmnModel
     * @return {?}
     */
    findNextFlowElementsByFlowElementId(nextFlowNodeDict, nextSeqFlowDict, flowElementId, bpmnModel) {
        /** @type {?} */
        const flowElt = bpmnModel.DefaultProcess.GetFlowElement(flowElementId);
        if (flowElt && nextFlowNodeDict[flowElementId] == null) {
            if (flowElt instanceof SequenceFlow) {
                nextSeqFlowDict[flowElt.Id] = flowElt;
                this.findNextFlowElementsByFlowElementId(nextFlowNodeDict, nextSeqFlowDict, flowElt.TargetRef, bpmnModel);
            }
            else if (flowElt instanceof FlowNode) {
                nextFlowNodeDict[flowElt.Id] = flowElt;
                if ((flowElt instanceof EndEvent) == false) {
                    flowElt.Outgoings && flowElt.Outgoings.forEach((/**
                     * @param {?} outgoing
                     * @return {?}
                     */
                    outgoing => {
                        this.findNextFlowElementsByFlowElementId(nextFlowNodeDict, nextSeqFlowDict, outgoing, bpmnModel);
                    }));
                }
            }
        }
    }
}

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class FlowChart extends mxEventSource {
    /**
     * @param {?} container
     * @param {?} config
     */
    constructor(container, config) {
        super();
        this.mode = 'complete';
        this.actList = [];
        this.transInsList = [];
        this.rootPath = ''; //基路径
        //基路径
        /**
         * 当前语言
         */
        this.langCode = ((/** @type {?} */ (window))).gspframeworkService && ((/** @type {?} */ (window))).gspframeworkService.rtf.language.getLanguageCode() || localStorage.getItem('languageCode') || 'zh-CHS';
        try {
            this.rootPath = ((/** @type {?} */ (window))).gspframeworkService.common.getBasePath.get();
        }
        catch (error) {
        }
        this.container = container;
        this.createDiv();
        this.graph = this.createGraph(config);
        window.setTimeout((/**
         * @return {?}
         */
        () => {
            this.resetScrollbars();
        }), 0);
        this.refresh();
        this.resizeHandler = (/**
         * @return {?}
         */
        () => {
            window.setTimeout((/**
             * @return {?}
             */
            () => {
                if (this.graph != null) {
                    this.refresh();
                }
            }), 0);
        });
        mxEvent.addListener(window, 'resize', this.resizeHandler);
        this.graph.getSelectionModel().addListener(mxEvent.CHANGE, (/**
         * @param {?} sender
         * @param {?} evt
         * @return {?}
         */
        (sender, evt) => {
            this.cellSelect(sender, evt);
        }));
    }
    /**
     * 设置当前语言
     * @param {?} lang
     * @return {?}
     */
    setLanguage(lang) {
        this.langCode = lang;
        if (this.graph) {
            this.graph.langCode = lang;
        }
    }
    /**
     * @param {?} __0
     * @return {?}
     */
    switchMode({ mode, actiInstList, transInsList }) {
        this.mode = mode;
        this.actList = actiInstList;
        this.transInsList = transInsList;
        this.graph.actList = this.actList;
        this.graph.transInsList = this.transInsList;
        this.graph.mode = this.mode;
        this.graph.reloadBpmnModel();
    }
    /**
     * @param {?} data
     * @return {?}
     */
    load(data) {
        if (data) {
            this.processInstance = data.processInstance;
            this.actList = data.actiInstList;
            this.transInsList = data.transInsList;
            this.mode = data.mode;
            this.graph.actList = this.actList;
            this.graph.transInsList = this.transInsList;
            this.graph.mode = this.mode;
            this.graph.loadBpmnModel(data.content);
            this.resetScrollbars();
        }
    }
    /**
     * @return {?}
     */
    createDiv() {
        this.diagramContainer = document.createElement('div');
        this.diagramContainer.className = 'flowChartContainer';
        this.container.appendChild(this.diagramContainer);
        setTimeout((/**
         * @return {?}
         */
        () => {
            // this.diagramContainer.style.overflow = 'hidden';
            mxEvent.addListener(this.diagramContainer, 'mouseover', (/**
             * @return {?}
             */
            () => {
                // this.diagramContainer.style.overflow = 'auto';
                this.diagramContainer.classList.add('active');
            }));
            mxEvent.addListener(this.diagramContainer, 'mouseleave', (/**
             * @return {?}
             */
            () => {
                // this.diagramContainer.style.overflow = 'hidden';
                this.diagramContainer.classList.remove('active');
            }));
        }), 0);
        /** @type {?} */
        const buttonIn = document.createElement('a');
        buttonIn.setAttribute('href', 'javascript:void(0);');
        /** @type {?} */
        let buttonInImg = document.createElement('img');
        buttonIn.style.marginRight = '10px';
        buttonInImg.src = this.rootPath + '/platform/runtime/common/web/@gsp-wf/wf-process-editor/images/zoomIn.svg';
        buttonInImg.style.display = "inline-block";
        buttonInImg.style.verticalAlign = "middle";
        buttonIn.appendChild(buttonInImg);
        mxEvent.addListener(buttonIn, 'click', (/**
         * @param {?} evt
         * @return {?}
         */
        (evt) => {
            this.graph.zoomIn();
        }));
        /** @type {?} */
        const buttonOut = document.createElement('a');
        buttonOut.setAttribute('href', 'javascript:void(0);');
        /** @type {?} */
        let buttonOutImg = document.createElement('img');
        buttonOutImg.src = this.rootPath + '/platform/runtime/common/web/@gsp-wf/wf-process-editor/images/zoomOut.svg';
        buttonOutImg.style.display = "inline-block";
        buttonOutImg.style.verticalAlign = "middle";
        buttonOut.appendChild(buttonOutImg);
        mxEvent.addListener(buttonOut, 'click', (/**
         * @param {?} evt
         * @return {?}
         */
        (evt) => {
            this.graph.zoomOut();
        }));
        /** @type {?} */
        const zoomBar = document.createElement('div');
        zoomBar.className = 'zoomBar';
        zoomBar.style.position = 'absolute';
        zoomBar.style.top = '10px';
        zoomBar.style.right = '20px';
        zoomBar.appendChild(buttonIn);
        zoomBar.appendChild(buttonOut);
        // zoomBar.appendChild(zoom);
        this.container.appendChild(zoomBar);
    }
    /**
     * @param {?} config
     * @return {?}
     */
    createGraph(config) {
        mxConstants.VERTEX_SELECTION_STROKEWIDTH = 1;
        mxConstants.VERTEX_SELECTION_COLOR = '#0000CD';
        mxConstants.VERTEX_SELECTION_DASHED = true;
        /** @type {?} */
        const graph = new FlowGraph(this.diagramContainer, config);
        // 创建无限大画布
        graph.createInfiniteCanvas();
        // 创建后需要调用一次才生效
        graph.sizeDidChange();
        graph.popupMenuHandler.autoExpand = true;
        graph.popupMenuHandler.factoryMethod = (/**
         * @param {?} menu
         * @param {?} cell
         * @param {?} evt
         * @return {?}
         */
        (menu, cell, evt) => {
            if (cell != null
                && cell.getId().indexOf('UserActivity') > -1
                && this.actList.findIndex((/**
                 * @param {?} a
                 * @return {?}
                 */
                a => a.activityDefinitionId === cell.getId())) > -1
                && this.processInstance) {
                /** @type {?} */
                const actInstId = this.actList.find((/**
                 * @param {?} a
                 * @return {?}
                 */
                a => a.activityDefinitionId === cell.getId())).activityInstanceId;
                menu.addItem('查看单据', null, (/**
                 * @return {?}
                 */
                () => {
                    this.viewForm(this.processInstance.id, actInstId, this.processInstance.bizInstId);
                }));
            }
            if (cell != null
                && cell.getId().indexOf('AifCreationBillActivity') > -1
                && this.actList.findIndex((/**
                 * @param {?} a
                 * @return {?}
                 */
                a => a.activityDefinitionId === cell.getId())) > -1
                && this.processInstance) {
                // 筛选状态是Running的自动生单活动实例
                /** @type {?} */
                const actInsts = this.actList.filter((/**
                 * @param {?} a
                 * @return {?}
                 */
                a => a.activityDefinitionId === cell.getId() && a.state == "RUNNING"));
                if (actInsts.length == 1) {
                    /** @type {?} */
                    const actInst = actInsts[0];
                    menu.addItem('重试', null, (/**
                     * @return {?}
                     */
                    () => {
                        this.retryAifCreation(this.processInstance.id, actInst.activityInstanceId, this.processInstance.bizInstId);
                    }));
                }
            }
        });
        return graph;
    }
    /**
     * @param {?} sender
     * @param {?} evt
     * @return {?}
     */
    cellSelect(sender, evt) {
        if (!(sender instanceof mxGraphSelectionModel)) {
            return;
        }
        /** @type {?} */
        const selectedCell = sender.cells[0];
        if (selectedCell) {
            if (selectedCell.vertex) {
                /** @type {?} */
                const selectId = selectedCell.getId();
                // 选中子流程节点时，弹出子流程图
                if (selectId && selectId.indexOf('CallActivitySubProcess') > -1
                    && this.actList.findIndex((/**
                     * @param {?} a
                     * @return {?}
                     */
                    a => a.state !== 'FORECAST'
                        && a.activityDefinitionId === selectId)) > -1) {
                    /** @type {?} */
                    const actInsts = this.actList.filter((/**
                     * @param {?} a
                     * @return {?}
                     */
                    a => a.state !== 'FORECAST' && a.activityDefinitionId === selectId));
                    /** @type {?} */
                    const activeInst = actInsts.find((/**
                     * @param {?} a
                     * @return {?}
                     */
                    a => a.state === 'RUNNING'));
                    if (activeInst) {
                        this.viewChildProcessChart(activeInst);
                    }
                    else {
                        this.viewChildProcessChart(actInsts[0]);
                    }
                }
                else {
                    this.ngComp.viewLogs({ type: 'activity', actiDefId: selectedCell.id });
                }
            }
            else {
                this.ngComp.viewLogs({ type: 'sequence' });
            }
        }
        else {
            this.ngComp.viewLogs({ type: 'process' });
        }
    }
    /**
     * @param {?} actInst
     * @return {?}
     */
    viewChildProcessChart(actInst) {
        this.ngComp.viewChild(actInst, this.processInstance);
    }
    /**
     * @param {?} procInstId
     * @param {?} actInstId
     * @param {?} bizInstId
     * @return {?}
     */
    viewForm(procInstId, actInstId, bizInstId) {
        this.ngComp.viewForm(procInstId, actInstId, bizInstId);
    }
    /**
     * @param {?} procInstId
     * @param {?} actInstId
     * @param {?} bizInstId
     * @return {?}
     */
    retryAifCreation(procInstId, actInstId, bizInstId) {
        this.ngComp.retryAifCreation(procInstId, actInstId, bizInstId);
    }
    /**
     * @return {?}
     */
    resetScrollbars() {
        /** @type {?} */
        let bounds = this.graph.getGraphBounds();
        /** @type {?} */
        let width = Math.max(bounds.width * this.graph.view.scale, 0);
        // this.getScrollTileSize().width * this.graph.view.scale);
        /** @type {?} */
        let height = Math.max(bounds.height * this.graph.view.scale, 0);
        this.graph.container.scrollTop = Math.floor(Math.max(0, bounds.y - Math.max(20, (this.graph.container.clientHeight - height) / 2)));
        this.graph.container.scrollLeft = Math.floor(Math.max(0, bounds.x - Math.max(0, (this.graph.container.clientWidth - width) / 2)));
    }
    /**
     * @return {?}
     */
    refresh() {
        this.resetScrollbars();
    }
    /**
     * @return {?}
     */
    reloadBpmnModel() {
        this.graph.removeCells(this.graph.getChildCells(this.graph.getDefaultParent()));
    }
}

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class WFFlowchartService {
    /**
     * @param {?} msgService
     * @param {?} injector
     * @param {?} resolver
     * @param {?} modalService
     */
    constructor(msgService, injector, resolver, modalService) {
        this.msgService = msgService;
        this.injector = injector;
        this.resolver = resolver;
        this.modalService = modalService;
        this.flowchartService = this.injector.get(UiFlowchartService);
        this.frameworkService = this.injector.get(FrameworkService);
    }
    /**
     * 查看流程图，支持预览
     * @param {?} payload
     * @return {?}
     */
    viewProcess(payload) {
        if (!payload || !payload.dataId) {
            this.msgService.warning(this.getI18nValue('static.flowchart.noDataId'));
            return;
        }
        if (!payload || !payload.bizDefKey) {
            this.msgService.warning(this.getI18nValue('static.flowchart.noBizDefKey'));
            return;
        }
        /** @type {?} */
        const parameters = new Map();
        parameters.set('dataId', payload.dataId);
        parameters.set('bizDefKey', payload.bizDefKey);
        if (payload.startMode) {
            parameters.set('startMode', payload.startMode);
        }
        if (payload.startUserId) {
            parameters.set('startUserId', payload.startUserId);
        }
        parameters.set('withTitle', true);
        /** @type {?} */
        const options = {
            appType: 'menu',
            funcId: 'WFViewFlowChart',
            appId: '',
            appEntrance: '',
            tabId: payload.dataId,
            isNewTab: true,
            queryStringParams: parameters
        };
        this.openMenu(options);
    }
    /**
     * 根据流程实例id查看流程（tab页中打开）
     * @param {?} procInstId 流程实例ID
     * @return {?}
     */
    viewFlowChart(procInstId) {
        if (!procInstId) {
            this.msgService.warning(this.getI18nValue('static.flowchart.processNotFound'));
            return;
        }
        /** @type {?} */
        const parameters = new Map();
        parameters.set('processId', procInstId);
        parameters.set('withTitle', true);
        /** @type {?} */
        const options = {
            appType: 'menu',
            funcId: 'WFViewFlowChart',
            appId: '',
            appEntrance: '',
            tabId: new Date().getTime().toString(),
            isNewTab: true,
            queryStringParams: parameters
        };
        this.openMenu(options);
    }
    /**
     * 根据单据内码查看流程
     * @param {?} dataId 单据内码
     * @return {?}
     */
    viewFlowChartByDataId(dataId) {
        if (!dataId) {
            this.msgService.warning(this.getI18nValue('static.flowchart.dataIdIsNull'));
            return;
        }
        /** @type {?} */
        const parameters = new Map();
        parameters.set('dataId', dataId);
        parameters.set('withTitle', true);
        /** @type {?} */
        const options = {
            appType: 'menu',
            funcId: 'WFViewFlowChart',
            appId: '',
            appEntrance: '',
            tabId: new Date().getTime().toString(),
            isNewTab: true,
            queryStringParams: parameters
        };
        this.openMenu(options);
    }
    /**
     * 查看流程（弹框中打开）
     * @param {?} procInstId 流程实例ID
     * @param {?=} mode
     * @return {?}
     */
    viewFlowChartByDialog(procInstId, mode) {
        if (!procInstId) {
            this.msgService.warning(this.getI18nValue('static.flowchart.processNotFound'));
            return;
        }
        this.flowchartService.getProcessInstanceById(procInstId).subscribe((/**
         * @param {?} re
         * @return {?}
         */
        re => {
            if (re) {
                this.viewMutiInstanceFlowChartByDialog([re]);
            }
        }));
    }
    /**
     * 查看流程（弹框中打开，兼容多实例子流程）
     * @param {?} procInstList
     * @param {?=} mode
     * @return {?}
     */
    viewMutiInstanceFlowChartByDialog(procInstList, mode) {
        /** @type {?} */
        let func;
        if (UIFlowchartComponent.func) {
            func = UIFlowchartComponent.func;
        }
        /** @type {?} */
        const options = {
            title: this.getI18nValue('static.flowchart.title'),
            width: 1200,
            height: 530,
            showButtons: false,
            beforeClose: (/**
             * @param {?} modalRef
             * @return {?}
             */
            (modalRef) => {
                if (UIFlowchartComponent.func) {
                    window.removeEventListener('message', UIFlowchartComponent.func, false);
                }
                if (func) {
                    window.addEventListener('message', func, false);
                    UIFlowchartComponent.func = func;
                }
                return of(true);
            })
        };
        /** @type {?} */
        const compFactory = this.resolver.resolveComponentFactory(UIFlowchartComponent);
        /** @type {?} */
        const inj = Injector.create({
            providers: [{
                    provide: UiFlowchartService, useFactory: (/**
                     * @param {?} httpSvc
                     * @return {?}
                     */
                    (httpSvc) => {
                        return new UiFlowchartService(httpSvc);
                    }),
                    deps: [
                        HttpService
                    ]
                }], parent: this.injector
        });
        /** @type {?} */
        const compRef = compFactory.create(inj);
        if (procInstList && procInstList.length) {
            if (procInstList.length == 1) {
                options.showHeader = true;
                options.title = procInstList[0].name + '-v' + procInstList[0].version + '.0';
                compRef.instance.ProcInstId = procInstList[0].id;
            }
            else {
                options.showHeader = false;
                compRef.instance.ProcInstList = procInstList;
            }
        }
        if (mode) {
            compRef.instance.mode = mode;
        }
        compRef.instance.fill();
        /** @type {?} */
        const dialog = this.modalService.show(compRef, options);
        compRef.instance.dialog = dialog;
    }
    /**
     * 查看流程图。（如果作为共享的外部流程，则打开共享的查看流程）
     * @param {?} procInstId 流程实例id
     * @param {?} dataId 单据内码
     * @return {?}
     */
    viewFlowchartByProcInstIdAndDataId(procInstId, dataId) {
        this.flowchartService.ifThirdTask(procInstId).subscribe((/**
         * @param {?} ifThirdTask
         * @return {?}
         */
        ifThirdTask => {
            if (ifThirdTask === true) { //是第三方的任务
                this.flowchartService.getFsParamsByBizId(dataId).subscribe((/**
                 * @param {?} params
                 * @return {?}
                 */
                params => {
                    if (params) { //有不往共享单据表推数据的情况，此时返回为空
                        //有不往共享单据表推数据的情况，此时返回为空
                        /** @type {?} */
                        const param = {
                            "lcsl": params[0],
                            "djnm": params[1],
                            "djlx": params[2],
                            "djbh": params[3]
                        };
                        this.flowchartService.viewFsProcessNew(param).subscribe((/**
                         * @param {?} re
                         * @return {?}
                         */
                        re => {
                            if (re && re.value) {
                                this.openViewProcessMenu(re.value);
                            }
                        }), (/**
                         * @param {?} error
                         * @return {?}
                         */
                        error => {
                            this.viewFlowChart(procInstId);
                        }));
                    }
                    else {
                        this.viewFlowChart(procInstId);
                    }
                }), (/**
                 * @param {?} error
                 * @return {?}
                 */
                error => {
                    this.viewFlowChart(procInstId);
                }));
            }
            else { //WF的任务
                this.viewFlowChart(procInstId);
            }
        }), (/**
         * @param {?} error
         * @return {?}
         */
        error => {
            this.viewFlowChart(procInstId);
        }));
    }
    /**
     * 共享的任务，借用自己的查看流程菜单，iframe嵌入共享的查看流程URL
     * @private
     * @param {?} url 共享查看流程的URL
     * @return {?}
     */
    openViewProcessMenu(url) {
        /** @type {?} */
        const queryParams = new Map();
        queryParams.set("thirdTask", true);
        /** @type {?} */
        const entityParams = new Map();
        entityParams.set("thirdProcessUrl", url);
        /** @type {?} */
        const options = {
            appType: 'menu',
            funcId: 'WFViewFlowChart',
            appId: '',
            appEntrance: '',
            tabId: new Date().getTime().toString(),
            isNewTab: true,
            entityParams: entityParams,
            queryStringParams: queryParams
        };
        this.openMenu(options);
    }
    /**
     * 获取i18n
     * @private
     * @param {?} name
     * @return {?}
     */
    getI18nValue(name) {
        if (!name) {
            return '';
        }
        /** @type {?} */
        var defaultLang = localStorage.getItem('languageCode');
        /** @type {?} */
        var langData = defaultLang ? translate[defaultLang] : translate['zh-CHS'];
        /** @type {?} */
        let resultVal = '';
        if (name.indexOf('.') === -1) {
            resultVal = langData[name];
        }
        else {
            resultVal = name.split('.').reduce((/**
             * @param {?} obj
             * @param {?} key
             * @return {?}
             */
            (obj, key) => {
                if (obj) {
                    return obj[key];
                }
                else {
                    return null;
                }
            }), langData);
        }
        return resultVal;
    }
    /**
     * 判断是否inSuite环境
     * @private
     * @return {?}
     */
    isInSuite() {
        /** @type {?} */
        const frameWorkService = ((/** @type {?} */ (window))).gspframeworkService;
        if (frameWorkService && frameWorkService.rtf) {
            /** @type {?} */
            const extendMethod = frameWorkService.rtf.extendMethod;
            if (extendMethod && extendMethod.getExtObj()) {
                /** @type {?} */
                var extObj = extendMethod.getExtObj();
                /** @type {?} */
                const mode = extObj.iGIX4inSuiteMode();
                if (mode) {
                    return true;
                }
            }
        }
        return false;
    }
    /**
     * 打开菜单，区分是否inSuite环境，用不同方式打开菜单
     * @private
     * @param {?} options 打开参数
     * @return {?}
     */
    openMenu(options) {
        /** @type {?} */
        const menuTitle = this.getI18nValue('static.flowchart.title');
        if (this.isInSuite()) {
            options.menuTitle = menuTitle;
            /** @type {?} */
            var extObj = ((/** @type {?} */ (window))).gspframeworkService.rtf.extendMethod.getExtObj();
            extObj.iGIXMenuOpen(options);
        }
        else {
            this.frameworkService.openMenu$(options).subscribe((/**
             * @param {?} re
             * @return {?}
             */
            re => {
            }), (/**
             * @param {?} error
             * @return {?}
             */
            error => {
                console.error(error);
            }));
        }
    }
}
WFFlowchartService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
WFFlowchartService.ctorParameters = () => [
    { type: MessagerService },
    { type: Injector },
    { type: ComponentFactoryResolver },
    { type: BsModalService }
];

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class UIFlowchartComponent {
    /**
     * @param {?} sanitizer
     * @param {?} service
     * @param {?} changeDetector
     * @param {?} injector
     * @param {?} chartService
     */
    constructor(sanitizer, service, changeDetector, injector, chartService) {
        this.sanitizer = sanitizer;
        this.service = service;
        this.changeDetector = changeDetector;
        this.injector = injector;
        this.chartService = chartService;
        // 消息监听处理方法
        this.cls = 'd-flex flex-fill h-100';
        this.modalHide = new EventEmitter();
        this.fcHtml = window.document.location.origin + '/platform/runtime/wf/web/designer/flowchart.html?v=20221111';
        this.theme = 'viewFlowChart';
        this._mode = 'complete';
        this.modeButton = this.service.getI18nValue('static.flowchart.simulation');
        this.typeList = [
            {
                value: 'complete', text: this.service.getI18nValue('static.flowchart.complete')
            },
            {
                value: 'simulation', text: this.service.getI18nValue('static.flowchart.simulation')
            }
        ];
        this.localeId = "zh-CHS";
        this.procInstList = []; //流程实例list，多实例子流程使用
        //当前选中的流程
        this.flowChartContainerClientSize = {};
        this.sequenceColorList = [
            {
                colorClass: 'color-gey',
                label: 'completed'
            }, {
                colorClass: 'color-yellow',
                label: 'calculate'
            }, {
                colorClass: 'color-blue',
                label: 'default'
            }, {
                colorClass: 'color-red',
                label: 'suspend'
            }
        ];
        this.message = this.injector.get(MessagerService);
        this.frameworkSvc = this.injector.get(FrameworkService);
        this.localeId = this.injector.get(LOCALE_ID, null) || this.localeId;
        this.loading = this.injector.get(LoadingService, null);
        if (this.loading == null) {
            /** @type {?} */
            const inject = ReflectiveInjector.resolveAndCreate([
                LoadingService
            ], this.injector);
            this.loading = inject.get(LoadingService, null);
        }
        this.notify = this.injector.get(NotifyService, null);
        if (this.notify == null) {
            /** @type {?} */
            const inject = ReflectiveInjector.resolveAndCreate([
                NotifyService
            ], this.injector);
            this.notify = inject.get(NotifyService, null);
        }
    }
    /**
     * @param {?} v
     * @return {?}
     */
    set mode(v) {
        this._mode = v;
        if (this._mode === 'simulation') {
            this.ifForecast = 'true';
            this.modeButton = this.service.getI18nValue('static.flowchart.complete');
        }
        else if (this._mode === 'complete') {
            this.modeButton = this.service.getI18nValue('static.flowchart.simulation');
        }
    }
    /**
     * @return {?}
     */
    get mode() {
        return this._mode;
    }
    /**
     * @param {?} procInstId
     * @return {?}
     */
    set ProcInstId(procInstId) {
        if (procInstId) {
            this.procInstId = procInstId;
        }
    }
    /**
     * @param {?} dataId
     * @return {?}
     */
    set DataId(dataId) {
        if (dataId) {
            this.dataId = dataId;
        }
    }
    /**
     * @param {?} procInstList
     * @return {?}
     */
    set ProcInstList(procInstList) {
        if (procInstList && procInstList.length) {
            this.procInstId = procInstList[0].id;
            this.procInstList = procInstList;
        }
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.service.getFlowChartStyleConfig().subscribe((/**
         * @param {?} config
         * @return {?}
         */
        (config) => {
            setTimeout((/**
             * @return {?}
             */
            () => {
                this.createFlowChart(config);
                this.viewFlowChart();
            }), 300);
        }));
    }
    /**
     * @return {?}
     */
    ngAfterViewChecked() {
        // 监听画布容器高度和宽度属性变化，发生变化时刷新画布
        if (this.flowChartContainerER == null || this.flowChartContainerER.nativeElement == null || this.flowChart == null) {
            return;
        }
        if (this.flowChartContainerClientSize.clientHeight != this.flowChartContainerER.nativeElement.clientHeight
            || this.flowChartContainerClientSize.clientWidth != this.flowChartContainerER.nativeElement.clientWidth) {
            this.flowChartContainerClientSize = {
                clientHeight: this.flowChartContainerER.nativeElement.clientHeight,
                clientWidth: this.flowChartContainerER.nativeElement.clientWidth,
            };
            this.flowChart.refresh();
            this.flowChart.graph.sizeDidChange();
        }
    }
    /**
     * @param {?} config
     * @return {?}
     */
    createFlowChart(config) {
        this.flowChart = new FlowChart(this.flowChartContainerER.nativeElement, config);
        this.flowChart.ngComp = this;
        this.flowChart.setLanguage(this.localeId);
    }
    /**
     * @return {?}
     */
    viewFlowChart() {
        if (this.theme === 'viewFlowChart') {
            this.viewFlowChartByProcInstId();
        }
        else {
            this.processForecast();
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    tabChange(event) {
        this.procInstId = event.nextId;
        this.viewFlowChart();
        this.flowChart.reloadBpmnModel();
    }
    /**
     * @return {?}
     */
    closeDialog() {
        this.dialog.close();
    }
    /**
     * 查看子流程图
     * @param {?} actInst 活动实例
     * @param {?} superProcess 父流程
     * @return {?}
     */
    viewChild(actInst, superProcess) {
        this.service.getMutiChildInstance(actInst, superProcess.id).subscribe((/**
         * @param {?} re
         * @return {?}
         */
        (re) => {
            if (this.chartService && re && re.length) {
                if (re.length == 1) { //单个子流程
                    this.chartService.viewFlowChartByDialog(re[0].id, this.mode);
                }
                else { //多实例子流程
                    this.chartService.viewMutiInstanceFlowChartByDialog(re, this.mode);
                }
            }
            else {
                throw Error('请升级查看流程公共包实现联查子流程图功能');
            }
        }));
    }
    /**
     * @return {?}
     */
    modeSwitch() {
        if (this.mode === 'complete') {
            this.mode = 'simulation';
            this.ifForecast = 'true';
            this.modeButton = this.service.getI18nValue('static.flowchart.complete');
            this.service.getForecastProcessByProcInstId(this.procInstId).subscribe((/**
             * @param {?} r
             * @return {?}
             */
            r => {
                this.actInstList = r.activityInstanceSlims;
                this.transInsList = r.transitionInstanceSlims;
                this.flowChart.switchMode({
                    mode: 'simulation',
                    actiInstList: r.activityInstanceSlims,
                    transInsList: r.transitionInstanceSlims
                });
            }));
        }
        else {
            this.mode = 'complete';
            this.ifForecast = 'false';
            this.modeButton = this.service.getI18nValue('static.flowchart.simulation');
            this.service.getCompleteProcessInfoByProcInstId(this.procInstId).subscribe((/**
             * @param {?} r
             * @return {?}
             */
            r => {
                this.actInstList = r.activityInstanceSlims;
                this.transInsList = r.transitionInstanceSlims;
                this.flowChart.switchMode({
                    mode: 'complete',
                    actiInstList: r.activityInstanceSlims,
                    transInsList: r.transitionInstanceSlims
                });
            }));
        }
    }
    /**
     * @param {?} data
     * @return {?}
     */
    viewLogs(data) {
        this.type = data.type;
        this.actDefId = data.actiDefId;
    }
    /**
     * @return {?}
     */
    viewFlowChartByProcInstId() {
        this.content = '';
        if (this.procInstId) {
            if (this.mode === 'complete') {
                forkJoin(this.service.getProcInstanceById(this.procInstId), this.service.getBpmnModelbyProcInstId(this.procInstId), this.service.getCompleteProcessInfoByProcInstId(this.procInstId))
                    .subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                (data) => {
                    this.processInstance = data[0];
                    this.content = JSON.stringify(data[1]);
                    this.actInstList = data[2].activityInstanceSlims;
                    this.transInsList = data[2].transitionInstanceSlims;
                    this.loadFlowChart();
                }));
            }
            else {
                forkJoin(this.service.getProcInstanceById(this.procInstId), this.service.getBpmnModelbyProcInstId(this.procInstId), this.service.getForecastProcessByProcInstId(this.procInstId))
                    .subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                (data) => {
                    this.processInstance = data[0];
                    this.content = JSON.stringify(data[1]);
                    this.actInstList = data[2].activityInstanceSlims;
                    this.transInsList = data[2].transitionInstanceSlims;
                    this.loadFlowChart();
                }));
            }
        }
    }
    /**
     * @return {?}
     */
    processForecast() {
        this.content = '';
        this.mode = 'simulation';
        if (this.processForecastPayload.processDefinitionId && this.processForecastPayload.dataId) {
            forkJoin(this.service.getBpmnModelbyProcDefId(this.processForecastPayload.processDefinitionId), this.service.getForecastProcessByPayload(this.processForecastPayload))
                .subscribe((/**
             * @param {?} data
             * @return {?}
             */
            (data) => {
                this.content = JSON.stringify(data[0]);
                this.actInstList = data[1].activityInstanceSlims;
                this.transInsList = data[1].transitionInstanceSlims;
                this.loadFlowChart();
            }));
        }
    }
    /**
     * @param {?} procInstId
     * @param {?} actInstId
     * @param {?} bizInstId
     * @return {?}
     */
    viewForm(procInstId, actInstId, bizInstId) {
        if (procInstId) {
            this.service.getFormInfoByActInstId(procInstId, actInstId).subscribe((/**
             * @param {?} re
             * @return {?}
             */
            (re) => {
                /** @type {?} */
                const formInfo = re;
                if (!formInfo || !formInfo.appId) {
                    if (this.message) {
                        this.message.info('找不到单据，请联系管理员查看原因！');
                    }
                    return;
                }
                /** @type {?} */
                const options = {
                    appType: 'menu',
                    funcId: formInfo.appId,
                    appId: '',
                    appEntrance: '',
                    tabId: bizInstId,
                    isNewTab: true
                };
                // 传工作流上下文参数
                /** @type {?} */
                const parameters = new Map();
                parameters.set('procInstId', procInstId);
                parameters.set('actInstId', actInstId);
                formInfo.parameters.forEach((/**
                 * @param {?} item
                 * @return {?}
                 */
                (item) => parameters.set(item.code, item.value)));
                options.queryStringParams = parameters;
                if (this.frameworkSvc) {
                    this.frameworkSvc.openMenu(options);
                }
                else {
                    throw Error('框架服务不存在！无法联查！');
                }
            }));
        }
    }
    /**
     * @param {?} procInstId
     * @param {?} actInstId
     * @param {?} bizInstId
     * @return {?}
     */
    retryAifCreation(procInstId, actInstId, bizInstId) {
        if (procInstId) {
            /** @type {?} */
            const l = this.loading.show();
            this.service.retryAifCreation(procInstId, actInstId, bizInstId).subscribe((/**
             * @param {?} re
             * @return {?}
             */
            (re) => {
                l.close();
                this.notify.success("重试成功");
                this.viewFlowChart();
            }), (/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                l.close();
                setTimeout((/**
                 * @return {?}
                 */
                () => {
                    //todo 确定异常结构, 目前采用兼容取值方式
                    this.message.error(err.error == null ? err.message : (err.error.Message || err.error.message || err.message));
                }), 300);
                throw err;
            }));
        }
    }
    /**
     * @return {?}
     */
    loadFlowChart() {
        if (this.content) {
            this.flowChart.load({
                processInstance: this.processInstance,
                content: this.content,
                actiInstList: this.actInstList,
                transInsList: this.transInsList,
                mode: this.mode
            });
        }
    }
    /**
     * @return {?}
     */
    fill() {
        this.cls = 'd-flex flex-fill h-100 f-utils-absolute-all';
    }
}
UIFlowchartComponent.func = null; // 消息监听处理方法
UIFlowchartComponent.decorators = [
    { type: Component, args: [{
                selector: 'wf-flowchart',
                template: "<div class=\"f-page f-page-navigate f-page-is-listnav\">\r\n    <!-- \u591A\u5B9E\u4F8B\u5B50\u6D41\u7A0B\u5934 -->\r\n    <div *ngIf=\"procInstList?.length\" class=\"flowChart-muti-header\">\r\n        <farris-tabs [value]=\"curChildProcInst?.id\" [contentFill]=\"true\" [autoTitleWidth]=\"true\" [titleWidth]=\"90\"\r\n            (tabChange)=\"tabChange($event)\" class=\"w-100\">\r\n            <farris-tab *ngFor=\"let process of procInstList\" [id]=\"process.id\"\r\n                [title]=\"process.name + '-v' + process.version + '.0'\" style=\"overflow: hidden\">\r\n                <ng-template farrisTabsExtend>\r\n                    <li class=\"f-btn-icon f-bare\" (click)=\"closeDialog()\"><span\r\n                            class=\"f-icon modal_close flowchart-header-button\"></span></li>\r\n                </ng-template>\r\n            </farris-tab>\r\n        </farris-tabs>\r\n    </div>\r\n    <!-- \u6B63\u5E38\u60C5\u51B5\u67E5\u770B\u6D41\u7A0B -->\r\n    <div class=\"f-page-main\" style=\"margin: 0;\">\r\n        <farris-splitter class=\"f-page-content f-component-splitter\">\r\n            <!-- \u5DE6\u4FA7\u6D41\u7A0B\u56FE -->\r\n            <farris-splitter-pane class=\"f-page-content-main f-component-splitter-pane\">\r\n                <div class=\"f-utils-flex-column h-100\">\r\n                    <div *ngIf=\"dataId || procInstId || processForecastPayload\" class=\"f-utils-fill\">\r\n                        <div style=\"position: relative; height: 100%; width: 100%;\">\r\n                            <div id=\"flowChartContainer\" class=\"geEditor flowchart-container\" #flowChartContainer></div>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"flowchart-buttons-padding \">\r\n                        <!-- \u663E\u793A\u9884\u6D4B\u8DEF\u7EBF -->\r\n                        <button *ngIf=\"theme==='viewFlowChart'\" class=\"btn btn-secondary mr-2\"\r\n                            (click)=\"modeSwitch()\">{{modeButton}}\r\n                        </button>\r\n                        <!-- \u5206\u652F\u7EBF\u989C\u8272\u8BF4\u660E -->\r\n                        <div class=\"btn-group\" fDropdown [placement]=\"'top'\">\r\n                            <button class=\"btn btn-secondary dropdown-toggle\" fDropdownToggle type=\"button\">\r\n                                {{'static.flowchart.sequenceColor' | translate}}\r\n                            </button>\r\n                            <div class=\"dropdown-menu\" fDropdownMenu>\r\n                                <div *ngFor=\"let s of sequenceColorList\" class=\"flowchart-sequence-color\">\r\n                                    <span class=\"flowchart-color-div\" [ngClass]=\"s.colorClass\"></span>\r\n                                    {{'static.flowchart.' + s.label | translate}}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </farris-splitter-pane>\r\n            <!-- \u53F3\u4FA7\u5BA1\u6279\u65E5\u5FD7 -->\r\n            <farris-splitter-pane class=\"f-page-content-nav f-component-splitter-pane flowchart-right-pane\" ngResizable\r\n                [rzHandles]=\"'w'\" [collapsePosition]=\"'left'\" [enableCollapse]=\"true\" [rzMinWidth]=\"200\"\r\n                [rzMaxWidth]=\"600\">\r\n                <farris-section [enableMaximize]=\"false\" [enableAccordion]=\"false\" [showHeader]=\"false\"\r\n                    class=\"f-overflow-y-auto px-0\">\r\n                    <wf-approval-logs [ProcInstId]=\"procInstId\" [DataId]=\"dataId\" [IfForecast]=\"ifForecast\"\r\n                        [ActivityDefinitionId]=\"actDefId\" [Type]=\"type\"\r\n                        [processForecastPayload]=\"processForecastPayload\" [ShowHeader]=\"true\" [ShowViewProcess]=\"false\"\r\n                        [OnlyIncludeCurrentProcInst]=\"true\">\r\n                    </wf-approval-logs>\r\n                </farris-section>\r\n            </farris-splitter-pane>\r\n        </farris-splitter>\r\n    </div>\r\n</div>",
                encapsulation: ViewEncapsulation.None,
                styles: ["@charset \"UTF-8\";::ng-deep .chartModal .ant-modal{height:100%}::ng-deep .chartModal .ant-modal-content{height:100%}::ng-deep .chartModal .ant-modal-body{height:90%}.flowChart{height:100%;min-height:300px;width:100%}.flowChartContainer{overflow:auto;position:absolute;top:0;left:0;width:100%;height:100%;cursor:default;outline:0;background:url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImdyaWQiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTSAwIDEwIEwgNDAgMTAgTSAxMCAwIEwgMTAgNDAgTSAwIDIwIEwgNDAgMjAgTSAyMCAwIEwgMjAgNDAgTSAwIDMwIEwgNDAgMzAgTSAzMCAwIEwgMzAgNDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2UwZTBlMCIgb3BhY2l0eT0iMC4yIiBzdHJva2Utd2lkdGg9IjEiLz48cGF0aCBkPSJNIDQwIDAgTCAwIDAgMCA0MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZTBlMGUwIiBzdHJva2Utd2lkdGg9IjEiLz48L3BhdHRlcm4+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JpZCkiLz48L3N2Zz4=)}.flowChartContainer.active::-webkit-scrollbar-thumb{background-color:rgba(0,0,0,.2)}.flowChartContainer::-webkit-scrollbar-thumb{background-color:rgba(0,0,0,0)}.geEditor{font-family:Microsoft YaHei,Source Han Sans,sans-serif;font-size:10pt;border:none;margin:0}.geEditor input[type=text]::-ms-clear{display:none}body div.mxPopupMenu{box-shadow:3px 3px 6px silver;background:#fff;position:absolute;border:3px solid #e7e7e7;padding:3px}body table.mxPopupMenu{border-collapse:collapse;margin:0}body tr.mxPopupMenuItem{color:#000;cursor:default}body td.mxPopupMenuItem{padding:6px 0 6px 30px;font-family:Arial;font-size:10pt}body td.mxPopupMenuIcon{background-color:#fff;padding:0}body tr.mxPopupMenuItemHover{background-color:#eee;color:#000}table.mxPopupMenu hr{border-top:1px solid #ccc}table.mxPopupMenu tr{font-size:4pt}.flowchart-container{position:relative;width:100%;height:100%;overflow:auto}.flowChart-muti-header{display:flex;align-items:center;padding:0 16px}.flowchart-header-button{cursor:pointer;color:#848c9a}.flowchart-header-button:hover{color:#529dff}.flowchart-right-pane{margin:0 10px;width:30%}.flowchart-buttons-padding{padding:0 0 10px 10px}.flowchart-sequence-color{display:flex;align-items:center;padding-left:8px}.flowchart-color-div{color:#fff;border-radius:0;display:block;width:15px;height:15px;margin-right:8px}.color-gey{background:#595959}.color-yellow{background:#f59c24}.color-blue{background:#59a1ff}.color-red{background:#ff4040}"]
            }] }
];
/** @nocollapse */
UIFlowchartComponent.ctorParameters = () => [
    { type: DomSanitizer },
    { type: UiFlowchartService },
    { type: ChangeDetectorRef },
    { type: Injector },
    { type: WFFlowchartService, decorators: [{ type: Optional }] }
];
UIFlowchartComponent.propDecorators = {
    cls: [{ type: HostBinding, args: ['class',] }],
    iframe: [{ type: ViewChild, args: ['iframe',] }],
    modalHide: [{ type: Output }],
    theme: [{ type: Input }],
    processForecastPayload: [{ type: Input }],
    mode: [{ type: Input }],
    ProcInstId: [{ type: Input }],
    DataId: [{ type: Input }],
    ProcInstList: [{ type: Input }],
    flowChartContainerER: [{ type: ViewChild, args: ["flowChartContainer",] }],
    flowChartContainerVCR: [{ type: ViewChild, args: ["flowChartContainer", { read: ViewContainerRef },] }]
};

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class TranslatePipe {
    /**
     * @param {?} service
     */
    constructor(service) {
        this.service = service;
    }
    /**
     * @param {?} name
     * @param {?=} defaultVal
     * @return {?}
     */
    transform(name, defaultVal = '') {
        /** @type {?} */
        const r = this.service.getI18nValue(name);
        return r ? r : defaultVal;
    }
}
TranslatePipe.decorators = [
    { type: Pipe, args: [{ name: 'translate' },] }
];
/** @nocollapse */
TranslatePipe.ctorParameters = () => [
    { type: UiFlowchartService }
];

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class UiFlowchartModule {
}
UiFlowchartModule.decorators = [
    { type: NgModule, args: [{
                declarations: [
                    UIFlowchartComponent,
                    TranslatePipe
                ],
                imports: [
                    LayoutModule,
                    CommonModule,
                    FarrisDialogModule,
                    MessagerModule.forRoot({
                        width: 500
                    }),
                    FarrisSectionModule,
                    WfApprovalLogsModule,
                    ComboListModule,
                    ReactiveFormsModule,
                    FormsModule,
                    FDropdownDirectiveTypeModule,
                    DatagridModule,
                    NotifyModule,
                    LoadingModule,
                    FarrisTabsModule.forRoot(),
                    SplitterModule
                ],
                exports: [UIFlowchartComponent],
                providers: [
                    HttpService,
                    UiFlowchartService,
                    WFFlowchartService,
                ],
                entryComponents: [
                    UIFlowchartComponent
                ]
            },] }
];

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class ForecastProcessPayload {
}

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */

export { UiFlowchartService, UIFlowchartComponent, UiFlowchartModule, WFFlowchartService, TranslatePipe, ForecastProcessPayload };

//# sourceMappingURL=gsp-wf-ui-flowchart.js.map