/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Injector, ComponentFactoryResolver } from '@angular/core';
import { MessagerService } from '@farris/ui-messager';
import { BsModalService } from '@farris/ui-modal';
import { UIFlowchartComponent } from './task-flowchart/task-flowchart.component';
import { translate } from './services/i18n/index';
import { UiFlowchartService } from './services/ui-flowchart.service';
import { FrameworkService } from '@gsp-sys/rtf-common';
import { of } from 'rxjs';
import { HttpService } from '@ecp-caf/caf-common';
export class WFFlowchartService {
    /**
     * @param {?} msgService
     * @param {?} injector
     * @param {?} resolver
     * @param {?} modalService
     */
    constructor(msgService, injector, resolver, modalService) {
        this.msgService = msgService;
        this.injector = injector;
        this.resolver = resolver;
        this.modalService = modalService;
        this.flowchartService = this.injector.get(UiFlowchartService);
        this.frameworkService = this.injector.get(FrameworkService);
    }
    /**
     * 查看流程图，支持预览
     * @param {?} payload
     * @return {?}
     */
    viewProcess(payload) {
        if (!payload || !payload.dataId) {
            this.msgService.warning(this.getI18nValue('static.flowchart.noDataId'));
            return;
        }
        if (!payload || !payload.bizDefKey) {
            this.msgService.warning(this.getI18nValue('static.flowchart.noBizDefKey'));
            return;
        }
        /** @type {?} */
        const parameters = new Map();
        parameters.set('dataId', payload.dataId);
        parameters.set('bizDefKey', payload.bizDefKey);
        if (payload.startMode) {
            parameters.set('startMode', payload.startMode);
        }
        if (payload.startUserId) {
            parameters.set('startUserId', payload.startUserId);
        }
        parameters.set('withTitle', true);
        /** @type {?} */
        const options = {
            appType: 'menu',
            funcId: 'WFViewFlowChart',
            appId: '',
            appEntrance: '',
            tabId: payload.dataId,
            isNewTab: true,
            queryStringParams: parameters
        };
        this.openMenu(options);
    }
    /**
     * 根据流程实例id查看流程（tab页中打开）
     * @param {?} procInstId 流程实例ID
     * @return {?}
     */
    viewFlowChart(procInstId) {
        if (!procInstId) {
            this.msgService.warning(this.getI18nValue('static.flowchart.processNotFound'));
            return;
        }
        /** @type {?} */
        const parameters = new Map();
        parameters.set('processId', procInstId);
        parameters.set('withTitle', true);
        /** @type {?} */
        const options = {
            appType: 'menu',
            funcId: 'WFViewFlowChart',
            appId: '',
            appEntrance: '',
            tabId: new Date().getTime().toString(),
            isNewTab: true,
            queryStringParams: parameters
        };
        this.openMenu(options);
    }
    /**
     * 根据单据内码查看流程
     * @param {?} dataId 单据内码
     * @return {?}
     */
    viewFlowChartByDataId(dataId) {
        if (!dataId) {
            this.msgService.warning(this.getI18nValue('static.flowchart.dataIdIsNull'));
            return;
        }
        /** @type {?} */
        const parameters = new Map();
        parameters.set('dataId', dataId);
        parameters.set('withTitle', true);
        /** @type {?} */
        const options = {
            appType: 'menu',
            funcId: 'WFViewFlowChart',
            appId: '',
            appEntrance: '',
            tabId: new Date().getTime().toString(),
            isNewTab: true,
            queryStringParams: parameters
        };
        this.openMenu(options);
    }
    /**
     * 查看流程（弹框中打开）
     * @param {?} procInstId 流程实例ID
     * @param {?=} mode
     * @return {?}
     */
    viewFlowChartByDialog(procInstId, mode) {
        if (!procInstId) {
            this.msgService.warning(this.getI18nValue('static.flowchart.processNotFound'));
            return;
        }
        this.flowchartService.getProcessInstanceById(procInstId).subscribe((/**
         * @param {?} re
         * @return {?}
         */
        re => {
            if (re) {
                this.viewMutiInstanceFlowChartByDialog([re]);
            }
        }));
    }
    /**
     * 查看流程（弹框中打开，兼容多实例子流程）
     * @param {?} procInstList
     * @param {?=} mode
     * @return {?}
     */
    viewMutiInstanceFlowChartByDialog(procInstList, mode) {
        /** @type {?} */
        let func;
        if (UIFlowchartComponent.func) {
            func = UIFlowchartComponent.func;
        }
        /** @type {?} */
        const options = {
            title: this.getI18nValue('static.flowchart.title'),
            width: 1200,
            height: 530,
            showButtons: false,
            beforeClose: (/**
             * @param {?} modalRef
             * @return {?}
             */
            (modalRef) => {
                if (UIFlowchartComponent.func) {
                    window.removeEventListener('message', UIFlowchartComponent.func, false);
                }
                if (func) {
                    window.addEventListener('message', func, false);
                    UIFlowchartComponent.func = func;
                }
                return of(true);
            })
        };
        /** @type {?} */
        const compFactory = this.resolver.resolveComponentFactory(UIFlowchartComponent);
        /** @type {?} */
        const inj = Injector.create({
            providers: [{
                    provide: UiFlowchartService, useFactory: (/**
                     * @param {?} httpSvc
                     * @return {?}
                     */
                    (httpSvc) => {
                        return new UiFlowchartService(httpSvc);
                    }),
                    deps: [
                        HttpService
                    ]
                }], parent: this.injector
        });
        /** @type {?} */
        const compRef = compFactory.create(inj);
        if (procInstList && procInstList.length) {
            if (procInstList.length == 1) {
                options.showHeader = true;
                options.title = procInstList[0].name + '-v' + procInstList[0].version + '.0';
                compRef.instance.ProcInstId = procInstList[0].id;
            }
            else {
                options.showHeader = false;
                compRef.instance.ProcInstList = procInstList;
            }
        }
        if (mode) {
            compRef.instance.mode = mode;
        }
        compRef.instance.fill();
        /** @type {?} */
        const dialog = this.modalService.show(compRef, options);
        compRef.instance.dialog = dialog;
    }
    /**
     * 查看流程图。（如果作为共享的外部流程，则打开共享的查看流程）
     * @param {?} procInstId 流程实例id
     * @param {?} dataId 单据内码
     * @return {?}
     */
    viewFlowchartByProcInstIdAndDataId(procInstId, dataId) {
        this.flowchartService.ifThirdTask(procInstId).subscribe((/**
         * @param {?} ifThirdTask
         * @return {?}
         */
        ifThirdTask => {
            if (ifThirdTask === true) { //是第三方的任务
                this.flowchartService.getFsParamsByBizId(dataId).subscribe((/**
                 * @param {?} params
                 * @return {?}
                 */
                params => {
                    if (params) { //有不往共享单据表推数据的情况，此时返回为空
                        //有不往共享单据表推数据的情况，此时返回为空
                        /** @type {?} */
                        const param = {
                            "lcsl": params[0],
                            "djnm": params[1],
                            "djlx": params[2],
                            "djbh": params[3]
                        };
                        this.flowchartService.viewFsProcessNew(param).subscribe((/**
                         * @param {?} re
                         * @return {?}
                         */
                        re => {
                            if (re && re.value) {
                                this.openViewProcessMenu(re.value);
                            }
                        }), (/**
                         * @param {?} error
                         * @return {?}
                         */
                        error => {
                            this.viewFlowChart(procInstId);
                        }));
                    }
                    else {
                        this.viewFlowChart(procInstId);
                    }
                }), (/**
                 * @param {?} error
                 * @return {?}
                 */
                error => {
                    this.viewFlowChart(procInstId);
                }));
            }
            else { //WF的任务
                this.viewFlowChart(procInstId);
            }
        }), (/**
         * @param {?} error
         * @return {?}
         */
        error => {
            this.viewFlowChart(procInstId);
        }));
    }
    /**
     * 共享的任务，借用自己的查看流程菜单，iframe嵌入共享的查看流程URL
     * @private
     * @param {?} url 共享查看流程的URL
     * @return {?}
     */
    openViewProcessMenu(url) {
        /** @type {?} */
        const queryParams = new Map();
        queryParams.set("thirdTask", true);
        /** @type {?} */
        const entityParams = new Map();
        entityParams.set("thirdProcessUrl", url);
        /** @type {?} */
        const options = {
            appType: 'menu',
            funcId: 'WFViewFlowChart',
            appId: '',
            appEntrance: '',
            tabId: new Date().getTime().toString(),
            isNewTab: true,
            entityParams: entityParams,
            queryStringParams: queryParams
        };
        this.openMenu(options);
    }
    /**
     * 获取i18n
     * @private
     * @param {?} name
     * @return {?}
     */
    getI18nValue(name) {
        if (!name) {
            return '';
        }
        /** @type {?} */
        var defaultLang = localStorage.getItem('languageCode');
        /** @type {?} */
        var langData = defaultLang ? translate[defaultLang] : translate['zh-CHS'];
        /** @type {?} */
        let resultVal = '';
        if (name.indexOf('.') === -1) {
            resultVal = langData[name];
        }
        else {
            resultVal = name.split('.').reduce((/**
             * @param {?} obj
             * @param {?} key
             * @return {?}
             */
            (obj, key) => {
                if (obj) {
                    return obj[key];
                }
                else {
                    return null;
                }
            }), langData);
        }
        return resultVal;
    }
    /**
     * 判断是否inSuite环境
     * @private
     * @return {?}
     */
    isInSuite() {
        /** @type {?} */
        const frameWorkService = ((/** @type {?} */ (window))).gspframeworkService;
        if (frameWorkService && frameWorkService.rtf) {
            /** @type {?} */
            const extendMethod = frameWorkService.rtf.extendMethod;
            if (extendMethod && extendMethod.getExtObj()) {
                /** @type {?} */
                var extObj = extendMethod.getExtObj();
                /** @type {?} */
                const mode = extObj.iGIX4inSuiteMode();
                if (mode) {
                    return true;
                }
            }
        }
        return false;
    }
    /**
     * 打开菜单，区分是否inSuite环境，用不同方式打开菜单
     * @private
     * @param {?} options 打开参数
     * @return {?}
     */
    openMenu(options) {
        /** @type {?} */
        const menuTitle = this.getI18nValue('static.flowchart.title');
        if (this.isInSuite()) {
            options.menuTitle = menuTitle;
            /** @type {?} */
            var extObj = ((/** @type {?} */ (window))).gspframeworkService.rtf.extendMethod.getExtObj();
            extObj.iGIXMenuOpen(options);
        }
        else {
            this.frameworkService.openMenu$(options).subscribe((/**
             * @param {?} re
             * @return {?}
             */
            re => {
            }), (/**
             * @param {?} error
             * @return {?}
             */
            error => {
                console.error(error);
            }));
        }
    }
}
WFFlowchartService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
WFFlowchartService.ctorParameters = () => [
    { type: MessagerService },
    { type: Injector },
    { type: ComponentFactoryResolver },
    { type: BsModalService }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.flowchartService;
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.frameworkService;
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.msgService;
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.resolver;
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.modalService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2YtZmxvd2NoYXJ0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ3NwLXdmL3VpLWZsb3djaGFydC8iLCJzb3VyY2VzIjpbImxpYi93Zi1mbG93Y2hhcnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0UsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFBZ0IsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDaEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkNBQTJDLENBQUM7QUFDakYsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ2xELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ3JFLE9BQU8sRUFBYyxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDMUIsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBTWxELE1BQU0sT0FBTyxrQkFBa0I7Ozs7Ozs7SUFLM0IsWUFDWSxVQUEyQixFQUMzQixRQUFrQixFQUNsQixRQUFrQyxFQUNsQyxZQUE0QjtRQUg1QixlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLGFBQVEsR0FBUixRQUFRLENBQTBCO1FBQ2xDLGlCQUFZLEdBQVosWUFBWSxDQUFnQjtRQUVwQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUM5RCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENB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IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTWVzc2FnZXJTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1tZXNzYWdlcic7XHJcbmltcG9ydCB7IE1vZGFsT3B0aW9ucywgQnNNb2RhbFNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLW1vZGFsJztcclxuaW1wb3J0IHsgVUlGbG93Y2hhcnRDb21wb25lbnQgfSBmcm9tICcuL3Rhc2stZmxvd2NoYXJ0L3Rhc2stZmxvd2NoYXJ0LmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IHRyYW5zbGF0ZSB9IGZyb20gJy4vc2VydmljZXMvaTE4bi9pbmRleCc7XHJcbmltcG9ydCB7IFVpRmxvd2NoYXJ0U2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvdWktZmxvd2NoYXJ0LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBBcHBPcHRpb25zLCBGcmFtZXdvcmtTZXJ2aWNlIH0gZnJvbSAnQGdzcC1zeXMvcnRmLWNvbW1vbic7XHJcbmltcG9ydCB7IG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IEh0dHBTZXJ2aWNlIH0gZnJvbSAnQGVjcC1jYWYvY2FmLWNvbW1vbic7XHJcbmltcG9ydCB7IEZvcmVjYXN0UHJvY2Vzc1BheWxvYWQgfSBmcm9tICcuL2VudGl0eS9mb3JlY2FzdC1wcm9jZXNzLXBheWxvYWQnO1xyXG5pbXBvcnQgeyBQcm9jZXNzSW5zdGFuY2UgfSBmcm9tICcuL2Zsb3ctY2hhcnQnO1xyXG5cclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFdGRmxvd2NoYXJ0U2VydmljZSB7XHJcblxyXG4gICAgcHJpdmF0ZSBmbG93Y2hhcnRTZXJ2aWNlOiBVaUZsb3djaGFydFNlcnZpY2U7XHJcbiAgICBwcml2YXRlIGZyYW1ld29ya1NlcnZpY2U6IEZyYW1ld29ya1NlcnZpY2U7XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSBtc2dTZXJ2aWNlOiBNZXNzYWdlclNlcnZpY2UsXHJcbiAgICAgICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXHJcbiAgICAgICAgcHJpdmF0ZSByZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxyXG4gICAgICAgIHByaXZhdGUgbW9kYWxTZXJ2aWNlOiBCc01vZGFsU2VydmljZSxcclxuICAgICkge1xyXG4gICAgICAgIHRoaXMuZmxvd2NoYXJ0U2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KFVpRmxvd2NoYXJ0U2VydmljZSk7XHJcbiAgICAgICAgdGhpcy5mcmFtZXdvcmtTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQoRnJhbWV3b3JrU2VydmljZSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmn6XnnIvmtYHnqIvlm77vvIzmlK/mjIHpooTop4hcclxuICAgICAqIEBwYXJhbSBwYXlsb2FkIFxyXG4gICAgICogQHJldHVybnMgXHJcbiAgICAgKi9cclxuICAgIHZpZXdQcm9jZXNzKHBheWxvYWQ6IEZvcmVjYXN0UHJvY2Vzc1BheWxvYWQpIHtcclxuICAgICAgICBpZiAoIXBheWxvYWQgfHwgIXBheWxvYWQuZGF0YUlkKSB7XHJcbiAgICAgICAgICAgIHRoaXMubXNnU2VydmljZS53YXJuaW5nKHRoaXMuZ2V0STE4blZhbHVlKCdzdGF0aWMuZmxvd2NoYXJ0Lm5vRGF0YUlkJykpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghcGF5bG9hZCB8fCAhcGF5bG9hZC5iaXpEZWZLZXkpIHtcclxuICAgICAgICAgICAgdGhpcy5tc2dTZXJ2aWNlLndhcm5pbmcodGhpcy5nZXRJMThuVmFsdWUoJ3N0YXRpYy5mbG93Y2hhcnQubm9CaXpEZWZLZXknKSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcGFyYW1ldGVycyA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcbiAgICAgICAgcGFyYW1ldGVycy5zZXQoJ2RhdGFJZCcsIHBheWxvYWQuZGF0YUlkKTtcclxuICAgICAgICBwYXJhbWV0ZXJzLnNldCgnYml6RGVmS2V5JywgcGF5bG9hZC5iaXpEZWZLZXkpO1xyXG4gICAgICAgIGlmIChwYXlsb2FkLnN0YXJ0TW9kZSkge1xyXG4gICAgICAgICAgICBwYXJhbWV0ZXJzLnNldCgnc3RhcnRNb2RlJywgcGF5bG9hZC5zdGFydE1vZGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocGF5bG9hZC5zdGFydFVzZXJJZCkge1xyXG4gICAgICAgICAgICBwYXJhbWV0ZXJzLnNldCgnc3RhcnRVc2VySWQnLCBwYXlsb2FkLnN0YXJ0VXNlcklkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcGFyYW1ldGVycy5zZXQoJ3dpdGhUaXRsZScsIHRydWUpO1xyXG4gICAgICAgIGNvbnN0IG9wdGlvbnM6IEFwcE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIGFwcFR5cGU6ICdtZW51JyxcclxuICAgICAgICAgICAgZnVuY0lkOiAnV0ZWaWV3Rmxvd0NoYXJ0JyxcclxuICAgICAgICAgICAgYXBwSWQ6ICcnLFxyXG4gICAgICAgICAgICBhcHBFbnRyYW5jZTogJycsXHJcbiAgICAgICAgICAgIHRhYklkOiBwYXlsb2FkLmRhdGFJZCxcclxuICAgICAgICAgICAgaXNOZXdUYWI6IHRydWUsXHJcbiAgICAgICAgICAgIHF1ZXJ5U3RyaW5nUGFyYW1zOiBwYXJhbWV0ZXJzXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLm9wZW5NZW51KG9wdGlvbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5qC55o2u5rWB56iL5a6e5L6LaWTmn6XnnIvmtYHnqIvvvIh0YWLpobXkuK3miZPlvIDvvIlcclxuICAgICAqIEBwYXJhbSBwcm9jSW5zdElkIOa1geeoi+WunuS+i0lEXHJcbiAgICAgKi9cclxuICAgIHZpZXdGbG93Q2hhcnQocHJvY0luc3RJZDogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKCFwcm9jSW5zdElkKSB7XHJcbiAgICAgICAgICAgIHRoaXMubXNnU2VydmljZS53YXJuaW5nKHRoaXMuZ2V0STE4blZhbHVlKCdzdGF0aWMuZmxvd2NoYXJ0LnByb2Nlc3NOb3RGb3VuZCcpKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBwYXJhbWV0ZXJzID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcclxuICAgICAgICBwYXJhbWV0ZXJzLnNldCgncHJvY2Vzc0lkJywgcHJvY0luc3RJZCk7XHJcbiAgICAgICAgcGFyYW1ldGVycy5zZXQoJ3dpdGhUaXRsZScsIHRydWUpO1xyXG4gICAgICAgIGNvbnN0IG9wdGlvbnM6IEFwcE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIGFwcFR5cGU6ICdtZW51JyxcclxuICAgICAgICAgICAgZnVuY0lkOiAnV0ZWaWV3Rmxvd0NoYXJ0JyxcclxuICAgICAgICAgICAgYXBwSWQ6ICcnLFxyXG4gICAgICAgICAgICBhcHBFbnRyYW5jZTogJycsXHJcbiAgICAgICAgICAgIHRhYklkOiBuZXcgRGF0ZSgpLmdldFRpbWUoKS50b1N0cmluZygpLFxyXG4gICAgICAgICAgICBpc05ld1RhYjogdHJ1ZSxcclxuICAgICAgICAgICAgcXVlcnlTdHJpbmdQYXJhbXM6IHBhcmFtZXRlcnNcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMub3Blbk1lbnUob3B0aW9ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmoLnmja7ljZXmja7lhoXnoIHmn6XnnIvmtYHnqItcclxuICAgICAqIEBwYXJhbSBkYXRhSWQg5Y2V5o2u5YaF56CBXHJcbiAgICAgKiBAcmV0dXJucyBcclxuICAgICAqL1xyXG4gICAgdmlld0Zsb3dDaGFydEJ5RGF0YUlkKGRhdGFJZDogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKCFkYXRhSWQpIHtcclxuICAgICAgICAgICAgdGhpcy5tc2dTZXJ2aWNlLndhcm5pbmcodGhpcy5nZXRJMThuVmFsdWUoJ3N0YXRpYy5mbG93Y2hhcnQuZGF0YUlkSXNOdWxsJykpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHBhcmFtZXRlcnMgPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xyXG4gICAgICAgIHBhcmFtZXRlcnMuc2V0KCdkYXRhSWQnLCBkYXRhSWQpO1xyXG4gICAgICAgIHBhcmFtZXRlcnMuc2V0KCd3aXRoVGl0bGUnLCB0cnVlKTtcclxuICAgICAgICBjb25zdCBvcHRpb25zOiBBcHBPcHRpb25zID0ge1xyXG4gICAgICAgICAgICBhcHBUeXBlOiAnbWVudScsXHJcbiAgICAgICAgICAgIGZ1bmNJZDogJ1dGVmlld0Zsb3dDaGFydCcsXHJcbiAgICAgICAgICAgIGFwcElkOiAnJyxcclxuICAgICAgICAgICAgYXBwRW50cmFuY2U6ICcnLFxyXG4gICAgICAgICAgICB0YWJJZDogbmV3IERhdGUoKS5nZXRUaW1lKCkudG9TdHJpbmcoKSxcclxuICAgICAgICAgICAgaXNOZXdUYWI6IHRydWUsXHJcbiAgICAgICAgICAgIHF1ZXJ5U3RyaW5nUGFyYW1zOiBwYXJhbWV0ZXJzXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLm9wZW5NZW51KG9wdGlvbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5p+l55yL5rWB56iL77yI5by55qGG5Lit5omT5byA77yJXHJcbiAgICAgKiBAcGFyYW0gcHJvY0luc3RJZCDmtYHnqIvlrp7kvotJRFxyXG4gICAgICovXHJcbiAgICB2aWV3Rmxvd0NoYXJ0QnlEaWFsb2cocHJvY0luc3RJZDogc3RyaW5nLCBtb2RlPzogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKCFwcm9jSW5zdElkKSB7XHJcbiAgICAgICAgICAgIHRoaXMubXNnU2VydmljZS53YXJuaW5nKHRoaXMuZ2V0STE4blZhbHVlKCdzdGF0aWMuZmxvd2NoYXJ0LnByb2Nlc3NOb3RGb3VuZCcpKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmZsb3djaGFydFNlcnZpY2UuZ2V0UHJvY2Vzc0luc3RhbmNlQnlJZChwcm9jSW5zdElkKS5zdWJzY3JpYmUocmUgPT4ge1xyXG4gICAgICAgICAgICBpZiAocmUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudmlld011dGlJbnN0YW5jZUZsb3dDaGFydEJ5RGlhbG9nKFtyZV0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOafpeeci+a1geeoi++8iOW8ueahhuS4reaJk+W8gO+8jOWFvOWuueWkmuWunuS+i+WtkOa1geeoi++8iVxyXG4gICAgICogQHBhcmFtIHByb2NJbnN0SWQg5rWB56iL5a6e5L6LSURcclxuICAgICAqL1xyXG4gICAgdmlld011dGlJbnN0YW5jZUZsb3dDaGFydEJ5RGlhbG9nKHByb2NJbnN0TGlzdDogUHJvY2Vzc0luc3RhbmNlW10sIG1vZGU/OiBzdHJpbmcpIHtcclxuICAgICAgICBsZXQgZnVuYztcclxuICAgICAgICBpZiAoVUlGbG93Y2hhcnRDb21wb25lbnQuZnVuYykge1xyXG4gICAgICAgICAgICBmdW5jID0gVUlGbG93Y2hhcnRDb21wb25lbnQuZnVuYztcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3Qgb3B0aW9uczogTW9kYWxPcHRpb25zID0ge1xyXG4gICAgICAgICAgICB0aXRsZTogdGhpcy5nZXRJMThuVmFsdWUoJ3N0YXRpYy5mbG93Y2hhcnQudGl0bGUnKSxcclxuICAgICAgICAgICAgd2lkdGg6IDEyMDAsXHJcbiAgICAgICAgICAgIGhlaWdodDogNTMwLFxyXG4gICAgICAgICAgICBzaG93QnV0dG9uczogZmFsc2UsXHJcbiAgICAgICAgICAgIGJlZm9yZUNsb3NlOiAobW9kYWxSZWY6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKFVJRmxvd2NoYXJ0Q29tcG9uZW50LmZ1bmMpIHtcclxuICAgICAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIFVJRmxvd2NoYXJ0Q29tcG9uZW50LmZ1bmMsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChmdW5jKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBmdW5jLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgVUlGbG93Y2hhcnRDb21wb25lbnQuZnVuYyA9IGZ1bmM7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIGNvbnN0IGNvbXBGYWN0b3J5ID0gdGhpcy5yZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShVSUZsb3djaGFydENvbXBvbmVudCk7XHJcbiAgICAgICAgY29uc3QgaW5qID0gSW5qZWN0b3IuY3JlYXRlKHtcclxuICAgICAgICAgICAgcHJvdmlkZXJzOiBbe1xyXG4gICAgICAgICAgICAgICAgcHJvdmlkZTogVWlGbG93Y2hhcnRTZXJ2aWNlLCB1c2VGYWN0b3J5OiAoaHR0cFN2YykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVWlGbG93Y2hhcnRTZXJ2aWNlKGh0dHBTdmMpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGRlcHM6IFtcclxuICAgICAgICAgICAgICAgICAgICBIdHRwU2VydmljZVxyXG4gICAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICB9XSwgcGFyZW50OiB0aGlzLmluamVjdG9yXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29uc3QgY29tcFJlZiA9IGNvbXBGYWN0b3J5LmNyZWF0ZShpbmopO1xyXG4gICAgICAgIGlmIChwcm9jSW5zdExpc3QgJiYgcHJvY0luc3RMaXN0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICBpZiAocHJvY0luc3RMaXN0Lmxlbmd0aCA9PSAxKSB7XHJcbiAgICAgICAgICAgICAgICBvcHRpb25zLnNob3dIZWFkZXIgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgb3B0aW9ucy50aXRsZSA9IHByb2NJbnN0TGlzdFswXS5uYW1lICsgJy12JyArIHByb2NJbnN0TGlzdFswXS52ZXJzaW9uICsgJy4wJztcclxuICAgICAgICAgICAgICAgIGNvbXBSZWYuaW5zdGFuY2UuUHJvY0luc3RJZCA9IHByb2NJbnN0TGlzdFswXS5pZDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG9wdGlvbnMuc2hvd0hlYWRlciA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgY29tcFJlZi5pbnN0YW5jZS5Qcm9jSW5zdExpc3QgPSBwcm9jSW5zdExpc3Q7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1vZGUpIHtcclxuICAgICAgICAgICAgY29tcFJlZi5pbnN0YW5jZS5tb2RlID0gbW9kZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29tcFJlZi5pbnN0YW5jZS5maWxsKCk7XHJcbiAgICAgICAgY29uc3QgZGlhbG9nID0gdGhpcy5tb2RhbFNlcnZpY2Uuc2hvdyhjb21wUmVmLCBvcHRpb25zKTtcclxuICAgICAgICBjb21wUmVmLmluc3RhbmNlLmRpYWxvZyA9IGRpYWxvZztcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOafpeeci+a1geeoi+WbvuOAgu+8iOWmguaenOS9nOS4uuWFseS6q+eahOWklumDqOa1geeoi++8jOWImeaJk+W8gOWFseS6q+eahOafpeeci+a1geeoi++8iVxyXG4gICAgICogQHBhcmFtIHByb2NJbnN0SWQg5rWB56iL5a6e5L6LaWRcclxuICAgICAqIEBwYXJhbSBkYXRhSWQg5Y2V5o2u5YaF56CBXHJcbiAgICAgKi9cclxuICAgIHZpZXdGbG93Y2hhcnRCeVByb2NJbnN0SWRBbmREYXRhSWQocHJvY0luc3RJZDogc3RyaW5nLCBkYXRhSWQ6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuZmxvd2NoYXJ0U2VydmljZS5pZlRoaXJkVGFzayhwcm9jSW5zdElkKS5zdWJzY3JpYmUoaWZUaGlyZFRhc2sgPT4ge1xyXG4gICAgICAgICAgICBpZiAoaWZUaGlyZFRhc2sgPT09IHRydWUpIHsvL+aYr+esrOS4ieaWueeahOS7u+WKoVxyXG4gICAgICAgICAgICAgICAgdGhpcy5mbG93Y2hhcnRTZXJ2aWNlLmdldEZzUGFyYW1zQnlCaXpJZChkYXRhSWQpLnN1YnNjcmliZShwYXJhbXMgPT4gey8v6I635Y+W5p+l55yL5rWB56iL5Zu+5omA6ZyA5Y+C5pWwXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtcykgey8v5pyJ5LiN5b6A5YWx5Lqr5Y2V5o2u6KGo5o6o5pWw5o2u55qE5oOF5Ya177yM5q2k5pe26L+U5Zue5Li656m6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcmFtID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJsY3NsXCI6IHBhcmFtc1swXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiZGpubVwiOiBwYXJhbXNbMV0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImRqbHhcIjogcGFyYW1zWzJdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJkamJoXCI6IHBhcmFtc1szXVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmxvd2NoYXJ0U2VydmljZS52aWV3RnNQcm9jZXNzTmV3KHBhcmFtKS5zdWJzY3JpYmUocmUgPT4gey8v5pen5o6l5Y+j5oql6ZSZ77yM5pS56LCD5paw5o6l5Y+jXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmUgJiYgcmUudmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9wZW5WaWV3UHJvY2Vzc01lbnUocmUudmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZpZXdGbG93Q2hhcnQocHJvY0luc3RJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52aWV3Rmxvd0NoYXJ0KHByb2NJbnN0SWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sIGVycm9yID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnZpZXdGbG93Q2hhcnQocHJvY0luc3RJZCk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9IGVsc2Ugey8vV0bnmoTku7vliqFcclxuICAgICAgICAgICAgICAgIHRoaXMudmlld0Zsb3dDaGFydChwcm9jSW5zdElkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sIGVycm9yID0+IHtcclxuICAgICAgICAgICAgdGhpcy52aWV3Rmxvd0NoYXJ0KHByb2NJbnN0SWQpO1xyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlhbHkuqvnmoTku7vliqHvvIzlgJ/nlKjoh6rlt7HnmoTmn6XnnIvmtYHnqIvoj5zljZXvvIxpZnJhbWXltYzlhaXlhbHkuqvnmoTmn6XnnIvmtYHnqItVUkxcclxuICAgICAqIEBwYXJhbSBlbnRpdHkg5Lu75Yqh5a6e5L2T77yM5Yy65YiGdGFi6aG1XHJcbiAgICAgKiBAcGFyYW0gdXJsIOWFseS6q+afpeeci+a1geeoi+eahFVSTFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIG9wZW5WaWV3UHJvY2Vzc01lbnUodXJsOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBxdWVyeVBhcmFtcyA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcbiAgICAgICAgcXVlcnlQYXJhbXMuc2V0KFwidGhpcmRUYXNrXCIsIHRydWUpO1xyXG4gICAgICAgIGNvbnN0IGVudGl0eVBhcmFtcyA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcbiAgICAgICAgZW50aXR5UGFyYW1zLnNldChcInRoaXJkUHJvY2Vzc1VybFwiLCB1cmwpO1xyXG4gICAgICAgIGNvbnN0IG9wdGlvbnM6IEFwcE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIGFwcFR5cGU6ICdtZW51JyxcclxuICAgICAgICAgICAgZnVuY0lkOiAnV0ZWaWV3Rmxvd0NoYXJ0JyxcclxuICAgICAgICAgICAgYXBwSWQ6ICcnLFxyXG4gICAgICAgICAgICBhcHBFbnRyYW5jZTogJycsXHJcbiAgICAgICAgICAgIHRhYklkOiBuZXcgRGF0ZSgpLmdldFRpbWUoKS50b1N0cmluZygpLFxyXG4gICAgICAgICAgICBpc05ld1RhYjogdHJ1ZSxcclxuICAgICAgICAgICAgZW50aXR5UGFyYW1zOiBlbnRpdHlQYXJhbXMsXHJcbiAgICAgICAgICAgIHF1ZXJ5U3RyaW5nUGFyYW1zOiBxdWVyeVBhcmFtc1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5vcGVuTWVudShvcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPlmkxOG5cclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBnZXRJMThuVmFsdWUobmFtZTogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKCFuYW1lKSB7IHJldHVybiAnJzsgfVxyXG4gICAgICAgIHZhciBkZWZhdWx0TGFuZyA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdsYW5ndWFnZUNvZGUnKTtcclxuICAgICAgICB2YXIgbGFuZ0RhdGEgPSBkZWZhdWx0TGFuZyA/IHRyYW5zbGF0ZVtkZWZhdWx0TGFuZ10gOiB0cmFuc2xhdGVbJ3poLUNIUyddO1xyXG4gICAgICAgIGxldCByZXN1bHRWYWwgPSAnJztcclxuICAgICAgICBpZiAobmFtZS5pbmRleE9mKCcuJykgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdFZhbCA9IGxhbmdEYXRhW25hbWVdO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJlc3VsdFZhbCA9IG5hbWUuc3BsaXQoJy4nKS5yZWR1Y2UoKG9iaiwga2V5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAob2JqKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9ialtrZXldO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSwgbGFuZ0RhdGEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0VmFsO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yik5pat5piv5ZCmaW5TdWl0ZeeOr+Wig1xyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGlzSW5TdWl0ZSgpOiBib29sZWFuIHtcclxuICAgICAgICBjb25zdCBmcmFtZVdvcmtTZXJ2aWNlID0gKHdpbmRvdyBhcyBhbnkpLmdzcGZyYW1ld29ya1NlcnZpY2U7XHJcbiAgICAgICAgaWYgKGZyYW1lV29ya1NlcnZpY2UgJiYgZnJhbWVXb3JrU2VydmljZS5ydGYpIHtcclxuICAgICAgICAgICAgY29uc3QgZXh0ZW5kTWV0aG9kID0gZnJhbWVXb3JrU2VydmljZS5ydGYuZXh0ZW5kTWV0aG9kO1xyXG4gICAgICAgICAgICBpZiAoZXh0ZW5kTWV0aG9kICYmIGV4dGVuZE1ldGhvZC5nZXRFeHRPYmooKSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGV4dE9iaiA9IGV4dGVuZE1ldGhvZC5nZXRFeHRPYmooKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG1vZGUgPSBleHRPYmouaUdJWDRpblN1aXRlTW9kZSgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKG1vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmiZPlvIDoj5zljZXvvIzljLrliIbmmK/lkKZpblN1aXRl546v5aKD77yM55So5LiN5ZCM5pa55byP5omT5byA6I+c5Y2VXHJcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyDmiZPlvIDlj4LmlbBcclxuICAgICAqIEBwYXJhbSBtZW51VGl0bGUg6I+c5Y2V5ZCN56ewXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgb3Blbk1lbnUob3B0aW9uczogYW55KSB7XHJcbiAgICAgICAgY29uc3QgbWVudVRpdGxlID0gdGhpcy5nZXRJMThuVmFsdWUoJ3N0YXRpYy5mbG93Y2hhcnQudGl0bGUnKVxyXG4gICAgICAgIGlmICh0aGlzLmlzSW5TdWl0ZSgpKSB7XHJcbiAgICAgICAgICAgIG9wdGlvbnMubWVudVRpdGxlID0gbWVudVRpdGxlO1xyXG4gICAgICAgICAgICB2YXIgZXh0T2JqID0gKHdpbmRvdyBhcyBhbnkpLmdzcGZyYW1ld29ya1NlcnZpY2UucnRmLmV4dGVuZE1ldGhvZC5nZXRFeHRPYmooKTtcclxuICAgICAgICAgICAgZXh0T2JqLmlHSVhNZW51T3BlbihvcHRpb25zKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmZyYW1ld29ya1NlcnZpY2Uub3Blbk1lbnUkKG9wdGlvbnMpLnN1YnNjcmliZShyZSA9PiB7XHJcblxyXG4gICAgICAgICAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19