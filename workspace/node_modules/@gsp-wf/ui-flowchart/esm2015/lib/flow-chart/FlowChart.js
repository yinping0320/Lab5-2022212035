/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { mxEvent, mxConstants, mxGraphSelectionModel, mxEventSource } from "@edp-pmf/mxgraph-ts";
import { FlowGraph } from "./FlowGraph";
export class FlowChart extends mxEventSource {
    /**
     * @param {?} container
     * @param {?} config
     */
    constructor(container, config) {
        super();
        this.mode = 'complete';
        this.actList = [];
        this.transInsList = [];
        this.rootPath = ''; //基路径
        //基路径
        /**
         * 当前语言
         */
        this.langCode = ((/** @type {?} */ (window))).gspframeworkService && ((/** @type {?} */ (window))).gspframeworkService.rtf.language.getLanguageCode() || localStorage.getItem('languageCode') || 'zh-CHS';
        try {
            this.rootPath = ((/** @type {?} */ (window))).gspframeworkService.common.getBasePath.get();
        }
        catch (error) {
        }
        this.container = container;
        this.createDiv();
        this.graph = this.createGraph(config);
        window.setTimeout((/**
         * @return {?}
         */
        () => {
            this.resetScrollbars();
        }), 0);
        this.refresh();
        this.resizeHandler = (/**
         * @return {?}
         */
        () => {
            window.setTimeout((/**
             * @return {?}
             */
            () => {
                if (this.graph != null) {
                    this.refresh();
                }
            }), 0);
        });
        mxEvent.addListener(window, 'resize', this.resizeHandler);
        this.graph.getSelectionModel().addListener(mxEvent.CHANGE, (/**
         * @param {?} sender
         * @param {?} evt
         * @return {?}
         */
        (sender, evt) => {
            this.cellSelect(sender, evt);
        }));
    }
    /**
     * 设置当前语言
     * @param {?} lang
     * @return {?}
     */
    setLanguage(lang) {
        this.langCode = lang;
        if (this.graph) {
            this.graph.langCode = lang;
        }
    }
    /**
     * @param {?} __0
     * @return {?}
     */
    switchMode({ mode, actiInstList, transInsList }) {
        this.mode = mode;
        this.actList = actiInstList;
        this.transInsList = transInsList;
        this.graph.actList = this.actList;
        this.graph.transInsList = this.transInsList;
        this.graph.mode = this.mode;
        this.graph.reloadBpmnModel();
    }
    /**
     * @param {?} data
     * @return {?}
     */
    load(data) {
        if (data) {
            this.processInstance = data.processInstance;
            this.actList = data.actiInstList;
            this.transInsList = data.transInsList;
            this.mode = data.mode;
            this.graph.actList = this.actList;
            this.graph.transInsList = this.transInsList;
            this.graph.mode = this.mode;
            this.graph.loadBpmnModel(data.content);
            this.resetScrollbars();
        }
    }
    /**
     * @return {?}
     */
    createDiv() {
        this.diagramContainer = document.createElement('div');
        this.diagramContainer.className = 'flowChartContainer';
        this.container.appendChild(this.diagramContainer);
        setTimeout((/**
         * @return {?}
         */
        () => {
            // this.diagramContainer.style.overflow = 'hidden';
            mxEvent.addListener(this.diagramContainer, 'mouseover', (/**
             * @return {?}
             */
            () => {
                // this.diagramContainer.style.overflow = 'auto';
                this.diagramContainer.classList.add('active');
            }));
            mxEvent.addListener(this.diagramContainer, 'mouseleave', (/**
             * @return {?}
             */
            () => {
                // this.diagramContainer.style.overflow = 'hidden';
                this.diagramContainer.classList.remove('active');
            }));
        }), 0);
        /** @type {?} */
        const buttonIn = document.createElement('a');
        buttonIn.setAttribute('href', 'javascript:void(0);');
        /** @type {?} */
        let buttonInImg = document.createElement('img');
        buttonIn.style.marginRight = '10px';
        buttonInImg.src = this.rootPath + '/platform/runtime/common/web/@gsp-wf/wf-process-editor/images/zoomIn.svg';
        buttonInImg.style.display = "inline-block";
        buttonInImg.style.verticalAlign = "middle";
        buttonIn.appendChild(buttonInImg);
        mxEvent.addListener(buttonIn, 'click', (/**
         * @param {?} evt
         * @return {?}
         */
        (evt) => {
            this.graph.zoomIn();
        }));
        /** @type {?} */
        const buttonOut = document.createElement('a');
        buttonOut.setAttribute('href', 'javascript:void(0);');
        /** @type {?} */
        let buttonOutImg = document.createElement('img');
        buttonOutImg.src = this.rootPath + '/platform/runtime/common/web/@gsp-wf/wf-process-editor/images/zoomOut.svg';
        buttonOutImg.style.display = "inline-block";
        buttonOutImg.style.verticalAlign = "middle";
        buttonOut.appendChild(buttonOutImg);
        mxEvent.addListener(buttonOut, 'click', (/**
         * @param {?} evt
         * @return {?}
         */
        (evt) => {
            this.graph.zoomOut();
        }));
        /** @type {?} */
        const zoomBar = document.createElement('div');
        zoomBar.className = 'zoomBar';
        zoomBar.style.position = 'absolute';
        zoomBar.style.top = '10px';
        zoomBar.style.right = '20px';
        zoomBar.appendChild(buttonIn);
        zoomBar.appendChild(buttonOut);
        // zoomBar.appendChild(zoom);
        this.container.appendChild(zoomBar);
    }
    /**
     * @param {?} config
     * @return {?}
     */
    createGraph(config) {
        mxConstants.VERTEX_SELECTION_STROKEWIDTH = 1;
        mxConstants.VERTEX_SELECTION_COLOR = '#0000CD';
        mxConstants.VERTEX_SELECTION_DASHED = true;
        /** @type {?} */
        const graph = new FlowGraph(this.diagramContainer, config);
        // 创建无限大画布
        graph.createInfiniteCanvas();
        // 创建后需要调用一次才生效
        graph.sizeDidChange();
        graph.popupMenuHandler.autoExpand = true;
        graph.popupMenuHandler.factoryMethod = (/**
         * @param {?} menu
         * @param {?} cell
         * @param {?} evt
         * @return {?}
         */
        (menu, cell, evt) => {
            if (cell != null
                && cell.getId().indexOf('UserActivity') > -1
                && this.actList.findIndex((/**
                 * @param {?} a
                 * @return {?}
                 */
                a => a.activityDefinitionId === cell.getId())) > -1
                && this.processInstance) {
                /** @type {?} */
                const actInstId = this.actList.find((/**
                 * @param {?} a
                 * @return {?}
                 */
                a => a.activityDefinitionId === cell.getId())).activityInstanceId;
                menu.addItem('查看单据', null, (/**
                 * @return {?}
                 */
                () => {
                    this.viewForm(this.processInstance.id, actInstId, this.processInstance.bizInstId);
                }));
            }
            if (cell != null
                && cell.getId().indexOf('AifCreationBillActivity') > -1
                && this.actList.findIndex((/**
                 * @param {?} a
                 * @return {?}
                 */
                a => a.activityDefinitionId === cell.getId())) > -1
                && this.processInstance) {
                // 筛选状态是Running的自动生单活动实例
                /** @type {?} */
                const actInsts = this.actList.filter((/**
                 * @param {?} a
                 * @return {?}
                 */
                a => a.activityDefinitionId === cell.getId() && a.state == "RUNNING"));
                if (actInsts.length == 1) {
                    /** @type {?} */
                    const actInst = actInsts[0];
                    menu.addItem('重试', null, (/**
                     * @return {?}
                     */
                    () => {
                        this.retryAifCreation(this.processInstance.id, actInst.activityInstanceId, this.processInstance.bizInstId);
                    }));
                }
            }
        });
        return graph;
    }
    /**
     * @param {?} sender
     * @param {?} evt
     * @return {?}
     */
    cellSelect(sender, evt) {
        if (!(sender instanceof mxGraphSelectionModel)) {
            return;
        }
        /** @type {?} */
        const selectedCell = sender.cells[0];
        if (selectedCell) {
            if (selectedCell.vertex) {
                /** @type {?} */
                const selectId = selectedCell.getId();
                // 选中子流程节点时，弹出子流程图
                if (selectId && selectId.indexOf('CallActivitySubProcess') > -1
                    && this.actList.findIndex((/**
                     * @param {?} a
                     * @return {?}
                     */
                    a => a.state !== 'FORECAST'
                        && a.activityDefinitionId === selectId)) > -1) {
                    /** @type {?} */
                    const actInsts = this.actList.filter((/**
                     * @param {?} a
                     * @return {?}
                     */
                    a => a.state !== 'FORECAST' && a.activityDefinitionId === selectId));
                    /** @type {?} */
                    const activeInst = actInsts.find((/**
                     * @param {?} a
                     * @return {?}
                     */
                    a => a.state === 'RUNNING'));
                    if (activeInst) {
                        this.viewChildProcessChart(activeInst);
                    }
                    else {
                        this.viewChildProcessChart(actInsts[0]);
                    }
                }
                else {
                    this.ngComp.viewLogs({ type: 'activity', actiDefId: selectedCell.id });
                }
            }
            else {
                this.ngComp.viewLogs({ type: 'sequence' });
            }
        }
        else {
            this.ngComp.viewLogs({ type: 'process' });
        }
    }
    /**
     * @param {?} actInst
     * @return {?}
     */
    viewChildProcessChart(actInst) {
        this.ngComp.viewChild(actInst, this.processInstance);
    }
    /**
     * @param {?} procInstId
     * @param {?} actInstId
     * @param {?} bizInstId
     * @return {?}
     */
    viewForm(procInstId, actInstId, bizInstId) {
        this.ngComp.viewForm(procInstId, actInstId, bizInstId);
    }
    /**
     * @param {?} procInstId
     * @param {?} actInstId
     * @param {?} bizInstId
     * @return {?}
     */
    retryAifCreation(procInstId, actInstId, bizInstId) {
        this.ngComp.retryAifCreation(procInstId, actInstId, bizInstId);
    }
    /**
     * @return {?}
     */
    resetScrollbars() {
        /** @type {?} */
        let bounds = this.graph.getGraphBounds();
        /** @type {?} */
        let width = Math.max(bounds.width * this.graph.view.scale, 0);
        // this.getScrollTileSize().width * this.graph.view.scale);
        /** @type {?} */
        let height = Math.max(bounds.height * this.graph.view.scale, 0);
        this.graph.container.scrollTop = Math.floor(Math.max(0, bounds.y - Math.max(20, (this.graph.container.clientHeight - height) / 2)));
        this.graph.container.scrollLeft = Math.floor(Math.max(0, bounds.x - Math.max(0, (this.graph.container.clientWidth - width) / 2)));
    }
    /**
     * @return {?}
     */
    refresh() {
        this.resetScrollbars();
    }
    /**
     * @return {?}
     */
    reloadBpmnModel() {
        this.graph.removeCells(this.graph.getChildCells(this.graph.getDefaultParent()));
    }
}
if (false) {
    /** @type {?} */
    FlowChart.prototype.ngComp;
    /** @type {?} */
    FlowChart.prototype.container;
    /** @type {?} */
    FlowChart.prototype.graph;
    /** @type {?} */
    FlowChart.prototype.diagramContainer;
    /** @type {?} */
    FlowChart.prototype.button;
    /** @type {?} */
    FlowChart.prototype.resizeHandler;
    /** @type {?} */
    FlowChart.prototype.mode;
    /** @type {?} */
    FlowChart.prototype.processInstance;
    /** @type {?} */
    FlowChart.prototype.bpmnModel;
    /** @type {?} */
    FlowChart.prototype.actList;
    /** @type {?} */
    FlowChart.prototype.transInsList;
    /** @type {?} */
    FlowChart.prototype.rootPath;
    /**
     * 当前语言
     * @type {?}
     */
    FlowChart.prototype.langCode;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRmxvd0NoYXJ0LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGdzcC13Zi91aS1mbG93Y2hhcnQvIiwic291cmNlcyI6WyJsaWIvZmxvdy1jaGFydC9GbG93Q2hhcnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQWEsV0FBVyxFQUFFLHFCQUFxQixFQUFFLGFBQWEsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBTTVHLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFJeEMsTUFBTSxPQUFPLFNBQVUsU0FBUSxhQUFhOzs7OztJQW1CeEMsWUFBWSxTQUFjLEVBQUUsTUFBdUI7UUFDL0MsS0FBSyxFQUFFLENBQUM7UUFaWixTQUFJLEdBQThCLFVBQVUsQ0FBQztRQUc3QyxZQUFPLEdBQTJCLEVBQUUsQ0FBQztRQUNyQyxpQkFBWSxHQUE2QixFQUFFLENBQUM7UUFDNUMsYUFBUSxHQUFXLEVBQUUsQ0FBQyxDQUFBLEtBQUs7Ozs7O1FBSTNCLGFBQVEsR0FBRyxDQUFDLG1CQUFBLE1BQU0sRUFBTyxDQUFDLENBQUMsbUJBQW1CLElBQUksQ0FBQyxtQkFBQSxNQUFNLEVBQU8sQ0FBQyxDQUFDLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsZUFBZSxFQUFFLElBQUksWUFBWSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsSUFBSSxRQUFRLENBQUM7UUFJckssSUFBSTtZQUNBLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxtQkFBQSxNQUFNLEVBQU8sQ0FBQyxDQUFDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUM7U0FDaEY7UUFBQyxPQUFPLEtBQUssRUFBRTtTQUNmO1FBQ0QsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFdBQVcs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QUUsTUFBTSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLFlBQVksR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEksSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDdEksQ0FBQzs7OztJQUNELE9BQU87UUFDSCxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7SUFDM0IsQ0FBQzs7OztJQUVELGVBQWU7UUFDWCxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3BGLENBQUM7Q0FDSjs7O0lBM09HLDJCQUE2Qjs7SUFDN0IsOEJBQTBCOztJQUMxQiwwQkFBaUI7O0lBQ2pCLHFDQUFpQzs7SUFDakMsMkJBQTBCOztJQUMxQixrQ0FBMEI7O0lBRTFCLHlCQUE2Qzs7SUFDN0Msb0NBQWlDOztJQUNqQyw4QkFBcUI7O0lBQ3JCLDRCQUFxQzs7SUFDckMsaUNBQTRDOztJQUM1Qyw2QkFBc0I7Ozs7O0lBSXRCLDZCQUF5SyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG14RXZlbnQsIE14R3JhcGhOUywgbXhDb25zdGFudHMsIG14R3JhcGhTZWxlY3Rpb25Nb2RlbCwgbXhFdmVudFNvdXJjZSB9IGZyb20gXCJAZWRwLXBtZi9teGdyYXBoLXRzXCI7XHJcbmltcG9ydCB7IEJwbW5Nb2RlbCB9IGZyb20gXCJAZWRwLXBtZi9icG1uLW1vZGVsXCI7XHJcbmltcG9ydCB7IFByb2Nlc3NJbnN0YW5jZSB9IGZyb20gXCIuL2VudGl0eS9Qcm9jZXNzSW5zdGFuY2VcIjtcclxuaW1wb3J0IHsgQWN0aXZpdHlJbnN0YW5jZVNsaW0gfSBmcm9tIFwiLi9lbnRpdHkvQWN0aXZpdHlJbnN0YW5jZVNsaW1cIjtcclxuaW1wb3J0IHsgVHJhbnNpdGlvbkluc3RhbmNlU2xpbSB9IGZyb20gXCIuL2VudGl0eS9UcmFuc2l0aW9uSW5zdGFuY2VTbGltXCI7XHJcbmltcG9ydCB7IFVJRmxvd2NoYXJ0Q29tcG9uZW50IH0gZnJvbSBcIi4uL3Rhc2stZmxvd2NoYXJ0L3Rhc2stZmxvd2NoYXJ0LmNvbXBvbmVudFwiO1xyXG5pbXBvcnQgeyBGbG93R3JhcGggfSBmcm9tIFwiLi9GbG93R3JhcGhcIjtcclxuaW1wb3J0IHsgQ2VsbFN0eWxlQ29uZmlnIH0gZnJvbSBcIi4uL2VudGl0eS9jZWxsLXN0eWxlL0NlbGxTdHlsZUNvbmZpZ1wiO1xyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBGbG93Q2hhcnQgZXh0ZW5kcyBteEV2ZW50U291cmNlIHtcclxuICAgIG5nQ29tcDogVUlGbG93Y2hhcnRDb21wb25lbnQ7XHJcbiAgICBjb250YWluZXI6IEhUTUxEaXZFbGVtZW50O1xyXG4gICAgZ3JhcGg6IEZsb3dHcmFwaDtcclxuICAgIGRpYWdyYW1Db250YWluZXI6IEhUTUxEaXZFbGVtZW50O1xyXG4gICAgYnV0dG9uOiBIVE1MQnV0dG9uRWxlbWVudDtcclxuICAgIHJlc2l6ZUhhbmRsZXI6ICgpID0+IHZvaWQ7XHJcblxyXG4gICAgbW9kZTogJ2NvbXBsZXRlJyB8ICdzaW11bGF0aW9uJyA9ICdjb21wbGV0ZSc7XHJcbiAgICBwcm9jZXNzSW5zdGFuY2U6IFByb2Nlc3NJbnN0YW5jZTtcclxuICAgIGJwbW5Nb2RlbDogQnBtbk1vZGVsO1xyXG4gICAgYWN0TGlzdDogQWN0aXZpdHlJbnN0YW5jZVNsaW1bXSA9IFtdO1xyXG4gICAgdHJhbnNJbnNMaXN0OiBUcmFuc2l0aW9uSW5zdGFuY2VTbGltW10gPSBbXTtcclxuICAgIHJvb3RQYXRoOiBzdHJpbmcgPSAnJzsvL+Wfuui3r+W+hFxyXG4gICAgLyoqXHJcbiAgICAgKiDlvZPliY3or63oqIBcclxuICAgICAqL1xyXG4gICAgbGFuZ0NvZGUgPSAod2luZG93IGFzIGFueSkuZ3NwZnJhbWV3b3JrU2VydmljZSAmJiAod2luZG93IGFzIGFueSkuZ3NwZnJhbWV3b3JrU2VydmljZS5ydGYubGFuZ3VhZ2UuZ2V0TGFuZ3VhZ2VDb2RlKCkgfHwgbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2xhbmd1YWdlQ29kZScpIHx8ICd6aC1DSFMnO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGNvbnRhaW5lcjogYW55LCBjb25maWc6IENlbGxTdHlsZUNvbmZpZykge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgdGhpcy5yb290UGF0aCA9ICh3aW5kb3cgYXMgYW55KS5nc3BmcmFtZXdvcmtTZXJ2aWNlLmNvbW1vbi5nZXRCYXNlUGF0aC5nZXQoKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGNvbnRhaW5lcjtcclxuICAgICAgICB0aGlzLmNyZWF0ZURpdigpO1xyXG4gICAgICAgIHRoaXMuZ3JhcGggPSB0aGlzLmNyZWF0ZUdyYXBoKGNvbmZpZyk7XHJcbiAgICAgICAgd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnJlc2V0U2Nyb2xsYmFycygpO1xyXG4gICAgICAgIH0sIDApO1xyXG4gICAgICAgIHRoaXMucmVmcmVzaCgpO1xyXG4gICAgICAgIHRoaXMucmVzaXplSGFuZGxlciA9ICgpID0+IHtcclxuICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZ3JhcGggIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LCAwKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIG14RXZlbnQuYWRkTGlzdGVuZXIod2luZG93LCAncmVzaXplJywgdGhpcy5yZXNpemVIYW5kbGVyKTtcclxuXHJcbiAgICAgICAgdGhpcy5ncmFwaC5nZXRTZWxlY3Rpb25Nb2RlbCgpLmFkZExpc3RlbmVyKG14RXZlbnQuQ0hBTkdFLCAoc2VuZGVyOiBhbnksIGV2dDogTXhHcmFwaE5TLm14RXZlbnRPYmplY3QpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5jZWxsU2VsZWN0KHNlbmRlciwgZXZ0KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiuvue9ruW9k+WJjeivreiogFxyXG4gICAgICogQHBhcmFtIGxhbmdcclxuICAgICAqL1xyXG4gICAgc2V0TGFuZ3VhZ2UobGFuZzogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5sYW5nQ29kZSA9IGxhbmc7XHJcbiAgICAgICAgaWYgKHRoaXMuZ3JhcGgpIHtcclxuICAgICAgICAgICAgdGhpcy5ncmFwaC5sYW5nQ29kZSA9IGxhbmc7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHN3aXRjaE1vZGUoeyBtb2RlLCBhY3RpSW5zdExpc3QsIHRyYW5zSW5zTGlzdCB9KSB7XHJcbiAgICAgICAgdGhpcy5tb2RlID0gbW9kZTtcclxuICAgICAgICB0aGlzLmFjdExpc3QgPSBhY3RpSW5zdExpc3Q7XHJcbiAgICAgICAgdGhpcy50cmFuc0luc0xpc3QgPSB0cmFuc0luc0xpc3Q7XHJcblxyXG4gICAgICAgIHRoaXMuZ3JhcGguYWN0TGlzdCA9IHRoaXMuYWN0TGlzdDtcclxuICAgICAgICB0aGlzLmdyYXBoLnRyYW5zSW5zTGlzdCA9IHRoaXMudHJhbnNJbnNMaXN0O1xyXG4gICAgICAgIHRoaXMuZ3JhcGgubW9kZSA9IHRoaXMubW9kZTtcclxuICAgICAgICB0aGlzLmdyYXBoLnJlbG9hZEJwbW5Nb2RlbCgpO1xyXG4gICAgfVxyXG5cclxuICAgIGxvYWQoZGF0YTogYW55KSB7XHJcbiAgICAgICAgaWYgKGRhdGEpIHtcclxuICAgICAgICAgICAgdGhpcy5wcm9jZXNzSW5zdGFuY2UgPSBkYXRhLnByb2Nlc3NJbnN0YW5jZTtcclxuICAgICAgICAgICAgdGhpcy5hY3RMaXN0ID0gZGF0YS5hY3RpSW5zdExpc3Q7XHJcbiAgICAgICAgICAgIHRoaXMudHJhbnNJbnNMaXN0ID0gZGF0YS50cmFuc0luc0xpc3Q7XHJcbiAgICAgICAgICAgIHRoaXMubW9kZSA9IGRhdGEubW9kZTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZ3JhcGguYWN0TGlzdCA9IHRoaXMuYWN0TGlzdDtcclxuICAgICAgICAgICAgdGhpcy5ncmFwaC50cmFuc0luc0xpc3QgPSB0aGlzLnRyYW5zSW5zTGlzdDtcclxuICAgICAgICAgICAgdGhpcy5ncmFwaC5tb2RlID0gdGhpcy5tb2RlO1xyXG4gICAgICAgICAgICB0aGlzLmdyYXBoLmxvYWRCcG1uTW9kZWwoZGF0YS5jb250ZW50KTtcclxuICAgICAgICAgICAgdGhpcy5yZXNldFNjcm9sbGJhcnMoKTtcclxuXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNyZWF0ZURpdigpIHtcclxuICAgICAgICB0aGlzLmRpYWdyYW1Db250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICB0aGlzLmRpYWdyYW1Db250YWluZXIuY2xhc3NOYW1lID0gJ2Zsb3dDaGFydENvbnRhaW5lcic7XHJcblxyXG4gICAgICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMuZGlhZ3JhbUNvbnRhaW5lcik7XHJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIHRoaXMuZGlhZ3JhbUNvbnRhaW5lci5zdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nO1xyXG5cclxuICAgICAgICAgICAgbXhFdmVudC5hZGRMaXN0ZW5lcih0aGlzLmRpYWdyYW1Db250YWluZXIsICdtb3VzZW92ZXInLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyB0aGlzLmRpYWdyYW1Db250YWluZXIuc3R5bGUub3ZlcmZsb3cgPSAnYXV0byc7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRpYWdyYW1Db250YWluZXIuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBteEV2ZW50LmFkZExpc3RlbmVyKHRoaXMuZGlhZ3JhbUNvbnRhaW5lciwgJ21vdXNlbGVhdmUnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyB0aGlzLmRpYWdyYW1Db250YWluZXIuc3R5bGUub3ZlcmZsb3cgPSAnaGlkZGVuJztcclxuICAgICAgICAgICAgICAgIHRoaXMuZGlhZ3JhbUNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSwgMCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGJ1dHRvbkluID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xyXG4gICAgICAgIGJ1dHRvbkluLnNldEF0dHJpYnV0ZSgnaHJlZicsICdqYXZhc2NyaXB0OnZvaWQoMCk7Jyk7XHJcbiAgICAgICAgbGV0IGJ1dHRvbkluSW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7XHJcbiAgICAgICAgYnV0dG9uSW4uc3R5bGUubWFyZ2luUmlnaHQgPSAnMTBweCc7XHJcbiAgICAgICAgYnV0dG9uSW5JbWcuc3JjID0gdGhpcy5yb290UGF0aCArICcvcGxhdGZvcm0vcnVudGltZS9jb21tb24vd2ViL0Bnc3Atd2Yvd2YtcHJvY2Vzcy1lZGl0b3IvaW1hZ2VzL3pvb21Jbi5zdmcnO1xyXG4gICAgICAgIGJ1dHRvbkluSW1nLnN0eWxlLmRpc3BsYXkgPSBcImlubGluZS1ibG9ja1wiO1xyXG4gICAgICAgIGJ1dHRvbkluSW1nLnN0eWxlLnZlcnRpY2FsQWxpZ24gPSBcIm1pZGRsZVwiO1xyXG4gICAgICAgIGJ1dHRvbkluLmFwcGVuZENoaWxkKGJ1dHRvbkluSW1nKTtcclxuICAgICAgICBteEV2ZW50LmFkZExpc3RlbmVyKGJ1dHRvbkluLCAnY2xpY2snLCAoZXZ0OiBQb2ludGVyRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5ncmFwaC56b29tSW4oKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgYnV0dG9uT3V0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xyXG4gICAgICAgIGJ1dHRvbk91dC5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCAnamF2YXNjcmlwdDp2b2lkKDApOycpO1xyXG4gICAgICAgIGxldCBidXR0b25PdXRJbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTtcclxuICAgICAgICBidXR0b25PdXRJbWcuc3JjID0gdGhpcy5yb290UGF0aCArICcvcGxhdGZvcm0vcnVudGltZS9jb21tb24vd2ViL0Bnc3Atd2Yvd2YtcHJvY2Vzcy1lZGl0b3IvaW1hZ2VzL3pvb21PdXQuc3ZnJztcclxuICAgICAgICBidXR0b25PdXRJbWcuc3R5bGUuZGlzcGxheSA9IFwiaW5saW5lLWJsb2NrXCI7XHJcbiAgICAgICAgYnV0dG9uT3V0SW1nLnN0eWxlLnZlcnRpY2FsQWxpZ24gPSBcIm1pZGRsZVwiO1xyXG4gICAgICAgIGJ1dHRvbk91dC5hcHBlbmRDaGlsZChidXR0b25PdXRJbWcpO1xyXG4gICAgICAgIG14RXZlbnQuYWRkTGlzdGVuZXIoYnV0dG9uT3V0LCAnY2xpY2snLCAoZXZ0OiBQb2ludGVyRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5ncmFwaC56b29tT3V0KCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHpvb21CYXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICB6b29tQmFyLmNsYXNzTmFtZSA9ICd6b29tQmFyJztcclxuICAgICAgICB6b29tQmFyLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJztcclxuICAgICAgICB6b29tQmFyLnN0eWxlLnRvcCA9ICcxMHB4JztcclxuICAgICAgICB6b29tQmFyLnN0eWxlLnJpZ2h0ID0gJzIwcHgnO1xyXG5cclxuICAgICAgICB6b29tQmFyLmFwcGVuZENoaWxkKGJ1dHRvbkluKTtcclxuICAgICAgICB6b29tQmFyLmFwcGVuZENoaWxkKGJ1dHRvbk91dCk7XHJcblxyXG4gICAgICAgIC8vIHpvb21CYXIuYXBwZW5kQ2hpbGQoem9vbSk7XHJcbiAgICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQoem9vbUJhcik7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGNyZWF0ZUdyYXBoKGNvbmZpZzogQ2VsbFN0eWxlQ29uZmlnKSB7XHJcbiAgICAgICAgbXhDb25zdGFudHMuVkVSVEVYX1NFTEVDVElPTl9TVFJPS0VXSURUSCA9IDE7XHJcbiAgICAgICAgbXhDb25zdGFudHMuVkVSVEVYX1NFTEVDVElPTl9DT0xPUiA9ICcjMDAwMENEJztcclxuICAgICAgICBteENvbnN0YW50cy5WRVJURVhfU0VMRUNUSU9OX0RBU0hFRCA9IHRydWU7XHJcblxyXG4gICAgICAgIGNvbnN0IGdyYXBoID0gbmV3IEZsb3dHcmFwaCh0aGlzLmRpYWdyYW1Db250YWluZXIsIGNvbmZpZyk7XHJcbiAgICAgICAgLy8g5Yib5bu65peg6ZmQ5aSn55S75biDXHJcbiAgICAgICAgZ3JhcGguY3JlYXRlSW5maW5pdGVDYW52YXMoKTtcclxuICAgICAgICAvLyDliJvlu7rlkI7pnIDopoHosIPnlKjkuIDmrKHmiY3nlJ/mlYhcclxuICAgICAgICBncmFwaC5zaXplRGlkQ2hhbmdlKCk7XHJcblxyXG4gICAgICAgIGdyYXBoLnBvcHVwTWVudUhhbmRsZXIuYXV0b0V4cGFuZCA9IHRydWU7XHJcbiAgICAgICAgZ3JhcGgucG9wdXBNZW51SGFuZGxlci5mYWN0b3J5TWV0aG9kID0gKG1lbnUsIGNlbGwsIGV2dCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoY2VsbCAhPSBudWxsXHJcbiAgICAgICAgICAgICAgICAmJiBjZWxsLmdldElkKCkuaW5kZXhPZignVXNlckFjdGl2aXR5JykgPiAtMVxyXG4gICAgICAgICAgICAgICAgJiYgdGhpcy5hY3RMaXN0LmZpbmRJbmRleChhID0+IGEuYWN0aXZpdHlEZWZpbml0aW9uSWQgPT09IGNlbGwuZ2V0SWQoKSkgPiAtMVxyXG4gICAgICAgICAgICAgICAgJiYgdGhpcy5wcm9jZXNzSW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFjdEluc3RJZCA9IHRoaXMuYWN0TGlzdC5maW5kKGEgPT4gYS5hY3Rpdml0eURlZmluaXRpb25JZCA9PT0gY2VsbC5nZXRJZCgpKS5hY3Rpdml0eUluc3RhbmNlSWQ7XHJcbiAgICAgICAgICAgICAgICBtZW51LmFkZEl0ZW0oJ+afpeeci+WNleaNricsIG51bGwsICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnZpZXdGb3JtKHRoaXMucHJvY2Vzc0luc3RhbmNlLmlkLCBhY3RJbnN0SWQsIHRoaXMucHJvY2Vzc0luc3RhbmNlLmJpekluc3RJZCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoY2VsbCAhPSBudWxsXHJcbiAgICAgICAgICAgICAgICAmJiBjZWxsLmdldElkKCkuaW5kZXhPZignQWlmQ3JlYXRpb25CaWxsQWN0aXZpdHknKSA+IC0xXHJcbiAgICAgICAgICAgICAgICAmJiB0aGlzLmFjdExpc3QuZmluZEluZGV4KGEgPT4gYS5hY3Rpdml0eURlZmluaXRpb25JZCA9PT0gY2VsbC5nZXRJZCgpKSA+IC0xXHJcbiAgICAgICAgICAgICAgICAmJiB0aGlzLnByb2Nlc3NJbnN0YW5jZSkge1xyXG4gICAgICAgICAgICAgICAgLy8g562b6YCJ54q25oCB5pivUnVubmluZ+eahOiHquWKqOeUn+WNlea0u+WKqOWunuS+i1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYWN0SW5zdHMgPSB0aGlzLmFjdExpc3QuZmlsdGVyKGEgPT4gYS5hY3Rpdml0eURlZmluaXRpb25JZCA9PT0gY2VsbC5nZXRJZCgpICYmIGEuc3RhdGUgPT0gXCJSVU5OSU5HXCIpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGFjdEluc3RzLmxlbmd0aCA9PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0SW5zdCA9IGFjdEluc3RzWzBdO1xyXG4gICAgICAgICAgICAgICAgICAgIG1lbnUuYWRkSXRlbSgn6YeN6K+VJywgbnVsbCwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJldHJ5QWlmQ3JlYXRpb24odGhpcy5wcm9jZXNzSW5zdGFuY2UuaWQsIGFjdEluc3QuYWN0aXZpdHlJbnN0YW5jZUlkLCB0aGlzLnByb2Nlc3NJbnN0YW5jZS5iaXpJbnN0SWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGdyYXBoO1xyXG4gICAgfVxyXG5cclxuICAgIGNlbGxTZWxlY3Qoc2VuZGVyLCBldnQ6IE14R3JhcGhOUy5teEV2ZW50T2JqZWN0KSB7XHJcbiAgICAgICAgaWYgKCEoc2VuZGVyIGluc3RhbmNlb2YgbXhHcmFwaFNlbGVjdGlvbk1vZGVsKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHNlbGVjdGVkQ2VsbCA9IHNlbmRlci5jZWxsc1swXTtcclxuICAgICAgICBpZiAoc2VsZWN0ZWRDZWxsKSB7XHJcbiAgICAgICAgICAgIGlmIChzZWxlY3RlZENlbGwudmVydGV4KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzZWxlY3RJZCA9IHNlbGVjdGVkQ2VsbC5nZXRJZCgpO1xyXG4gICAgICAgICAgICAgICAgLy8g6YCJ5Lit5a2Q5rWB56iL6IqC54K55pe277yM5by55Ye65a2Q5rWB56iL5Zu+XHJcbiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0SWQgJiYgc2VsZWN0SWQuaW5kZXhPZignQ2FsbEFjdGl2aXR5U3ViUHJvY2VzcycpID4gLTFcclxuICAgICAgICAgICAgICAgICAgICAmJiB0aGlzLmFjdExpc3QuZmluZEluZGV4KGEgPT4gYS5zdGF0ZSAhPT0gJ0ZPUkVDQVNUJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAmJiBhLmFjdGl2aXR5RGVmaW5pdGlvbklkID09PSBzZWxlY3RJZCkgPiAtMVxyXG4gICAgICAgICAgICAgICAgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0SW5zdHMgPSB0aGlzLmFjdExpc3QuZmlsdGVyKGEgPT4gYS5zdGF0ZSAhPT0gJ0ZPUkVDQVNUJyAmJiBhLmFjdGl2aXR5RGVmaW5pdGlvbklkID09PSBzZWxlY3RJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0aXZlSW5zdCA9IGFjdEluc3RzLmZpbmQoYSA9PiBhLnN0YXRlID09PSAnUlVOTklORycpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChhY3RpdmVJbnN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmlld0NoaWxkUHJvY2Vzc0NoYXJ0KGFjdGl2ZUluc3QpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmlld0NoaWxkUHJvY2Vzc0NoYXJ0KGFjdEluc3RzWzBdKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubmdDb21wLnZpZXdMb2dzKHsgdHlwZTogJ2FjdGl2aXR5JywgYWN0aURlZklkOiBzZWxlY3RlZENlbGwuaWQgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm5nQ29tcC52aWV3TG9ncyh7IHR5cGU6ICdzZXF1ZW5jZScgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLm5nQ29tcC52aWV3TG9ncyh7IHR5cGU6ICdwcm9jZXNzJyB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdmlld0NoaWxkUHJvY2Vzc0NoYXJ0KGFjdEluc3Q6IEFjdGl2aXR5SW5zdGFuY2VTbGltKSB7XHJcbiAgICAgICAgdGhpcy5uZ0NvbXAudmlld0NoaWxkKGFjdEluc3QsIHRoaXMucHJvY2Vzc0luc3RhbmNlKTtcclxuICAgIH1cclxuXHJcbiAgICB2aWV3Rm9ybShwcm9jSW5zdElkOiBzdHJpbmcsIGFjdEluc3RJZDogc3RyaW5nLCBiaXpJbnN0SWQ6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMubmdDb21wLnZpZXdGb3JtKHByb2NJbnN0SWQsIGFjdEluc3RJZCwgYml6SW5zdElkKTtcclxuICAgIH1cclxuXHJcbiAgICByZXRyeUFpZkNyZWF0aW9uKHByb2NJbnN0SWQ6IHN0cmluZywgYWN0SW5zdElkOiBzdHJpbmcsIGJpekluc3RJZDogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5uZ0NvbXAucmV0cnlBaWZDcmVhdGlvbihwcm9jSW5zdElkLCBhY3RJbnN0SWQsIGJpekluc3RJZCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVzZXRTY3JvbGxiYXJzKCkge1xyXG4gICAgICAgIGxldCBib3VuZHMgPSB0aGlzLmdyYXBoLmdldEdyYXBoQm91bmRzKCk7XHJcbiAgICAgICAgbGV0IHdpZHRoID0gTWF0aC5tYXgoYm91bmRzLndpZHRoICogdGhpcy5ncmFwaC52aWV3LnNjYWxlLCAwKTsgLy8gdGhpcy5nZXRTY3JvbGxUaWxlU2l6ZSgpLndpZHRoICogdGhpcy5ncmFwaC52aWV3LnNjYWxlKTtcclxuICAgICAgICBsZXQgaGVpZ2h0ID0gTWF0aC5tYXgoYm91bmRzLmhlaWdodCAqIHRoaXMuZ3JhcGgudmlldy5zY2FsZSwgMCk7IC8vIHRoaXMuZ2V0U2Nyb2xsVGlsZVNpemUoKS5oZWlnaHQgKiB0aGlzLmdyYXBoLnZpZXcuc2NhbGUpO1xyXG4gICAgICAgIHRoaXMuZ3JhcGguY29udGFpbmVyLnNjcm9sbFRvcCA9IE1hdGguZmxvb3IoTWF0aC5tYXgoMCwgYm91bmRzLnkgLSBNYXRoLm1heCgyMCwgKHRoaXMuZ3JhcGguY29udGFpbmVyLmNsaWVudEhlaWdodCAtIGhlaWdodCkgLyAyKSkpO1xyXG4gICAgICAgIHRoaXMuZ3JhcGguY29udGFpbmVyLnNjcm9sbExlZnQgPSBNYXRoLmZsb29yKE1hdGgubWF4KDAsIGJvdW5kcy54IC0gTWF0aC5tYXgoMCwgKHRoaXMuZ3JhcGguY29udGFpbmVyLmNsaWVudFdpZHRoIC0gd2lkdGgpIC8gMikpKTtcclxuICAgIH1cclxuICAgIHJlZnJlc2goKSB7XHJcbiAgICAgICAgdGhpcy5yZXNldFNjcm9sbGJhcnMoKTtcclxuICAgIH1cclxuXHJcbiAgICByZWxvYWRCcG1uTW9kZWwoKSB7XHJcbiAgICAgICAgdGhpcy5ncmFwaC5yZW1vdmVDZWxscyh0aGlzLmdyYXBoLmdldENoaWxkQ2VsbHModGhpcy5ncmFwaC5nZXREZWZhdWx0UGFyZW50KCkpKTtcclxuICAgIH1cclxufVxyXG4iXX0=