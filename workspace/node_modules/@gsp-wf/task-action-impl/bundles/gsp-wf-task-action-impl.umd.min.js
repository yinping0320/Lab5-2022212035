!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@ecp-caf/caf-common"),require("@gsp-wf/task-impl-api"),require("@angular/common"),require("@angular/forms"),require("@gsp-wf/wf-task-handler"),require("@farris/ui-loading"),require("@angular/core"),require("rxjs"),require("rxjs/operators"),require("@farris/ui-messager")):"function"==typeof define&&define.amd?define("@gsp-wf/task-action-impl",["exports","@ecp-caf/caf-common","@gsp-wf/task-impl-api","@angular/common","@angular/forms","@gsp-wf/wf-task-handler","@farris/ui-loading","@angular/core","rxjs","rxjs/operators","@farris/ui-messager"],t):t((e["gsp-wf"]=e["gsp-wf"]||{},e["gsp-wf"]["task-action-impl"]={}),e.cafCommon,e.taskImplApi,e.ng.common,e.ng.forms,e.wfTaskHandler,e.uiLoading,e.ng.core,e.rxjs,e.rxjs.operators,e.uiMessager)}(this,function(e,t,o,r,i,a,n,p,s,c,l){"use strict";var f=(d.prototype.getTaskCenterConfigByCode=function(e,t,o){var r="/api/runtime/task/v1.0/task-center-setting/code?code="+e;return t&&(r+="&ownerType="+t),o&&(r+="&ownerId="+o),this.http.get(r)},d.prototype.addFocus=function(e){var t="/api/runtime/task/v1.0/focus?sourceId="+e;return this.http.post(t,"")},d.prototype.removeFocus=function(e){var t="/api/runtime/task/v1.0/focus?processInstanceId="+e;return this.http["delete"](t,"")},d.prototype.ifFocused=function(e){var t="/api/runtime/task/v1.0/focus/?processInstanceId="+e;return this.http.get(t)},d.decorators=[{type:p.Injectable}],d.ctorParameters=function(){return[{type:p.Injector},{type:t.HttpService}]},d);function d(e,t){this.injector=e,this.http=t}function m(e,t){var o="function"==typeof Symbol&&e[Symbol.iterator];if(!o)return e;var r,i,n=o.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(r=n.next()).done;)a.push(r.value)}catch(p){i={error:p}}finally{try{r&&!r.done&&(o=n["return"])&&o.call(n)}finally{if(i)throw i.error}}return a}function u(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(m(arguments[t]));return e}var h=(Object.defineProperty(v.prototype,"iframe",{get:function(){return this._iframe},set:function(e){this._iframe=e,this.iframe&&this.componentRef&&(this.componentRef.instance.iframe=this.iframe)},enumerable:!0,configurable:!0}),v.prototype.ngOnInit=function(){var o=this;window.gspWfEventService=window.gspWfEventService||{},window.gspWfEventService.simulate=function(e){o.ngZone.run(function(){o.actionSelect(o.actions[0],0).subscribe(function(){return e&&"function"==typeof e&&e()})})};var r=this.loadingService.show();this.taskService.getTaskCenterConfigByCode("If_Show_My_Focus","all","*").subscribe(function(e){if(r.close(),e&&"false"===e.currentValue&&(o.ifShowFocus=!1),o.ifShowFocus&&o.task&&o.showButtons){var t=o.loadingService.show();o.taskService.ifFocused(o.task.processInstanceId).subscribe(function(e){t.close(),o.ifFocused=!(!e||!e.length)},function(){t.close()})}},function(){r.close()})},v.prototype.actionSelect=function(o,e){var r,i=this,n=new s.Subject;return this.selectAction=o,e&&(this.index=e),"wf"===o.typeId?(r=this.cfr.resolveComponentFactory(a.TaskExecuteComponent),this.loadComponentFactory(r),setTimeout(function(){n.next({result:!0})},100)):System["import"](o.impl+"?v="+(new Date).getTime().toString()).then(function(e){var t=Object.values(e)[0].create(i.injector);r=t.instance.getActionComponentFactory(o),i.loadComponentFactory(r),n.next({result:!0})}),n.asObservable()},v.prototype.loadComponentFactory=function(e){var t;this.componentRef&&this.componentRef.instance&&(t=this.componentRef.instance.comment),this.container.clear(),this.componentRef=this.container.createComponent(e,0,this.injector),this.componentRef.instance.origin=this.showButtons?o.ActionOrigin.TaskForm:o.ActionOrigin.TaskCenter,this.task&&this.componentRef.instance.setTask&&this.componentRef.instance.setTask(this.task),this.componentRef.instance.setAction&&this.componentRef.instance.setAction(this.selectAction),this.componentRef.instance.dialogHeight&&(this.dialogHeight=this.componentRef.instance.dialogHeight),this.componentRef.instance.dialogWidth&&(this.dialogWidth=this.componentRef.instance.dialogWidth),this.componentRef.instance.wfCacheComment=t,this.container.insert(this.componentRef.hostView)},v.prototype.submit=function(){var t=this;if(this.showButtons&&window.taskCenterBeforeLoad){this.submitDisable=!0;var e={task:this.task,action:this.selectAction};window.taskCenterBeforeLoad(e).then(function(e){t.submitDisable=!1,e&&1==e.result&&t.showConfirmDialog()},function(e){t.submitDisable=!1,console.error(e)})}else this.showConfirmDialog()},v.prototype.showConfirmDialog=function(){var t=this;this.taskService.getTaskCenterConfigByCode("Is_Confirm_Commit").subscribe(function(e){"true"===e.currentValue?t.msgService.question(t.i18nService("confirm")+t.selectAction.name+"？",function(){t.executeSubmit()}):t.executeSubmit()})},v.prototype.executeSubmit=function(){var e,t=this;this.submitDisable=!0,this.selectAction.preEvents&&0<this.selectAction.preEvents.length&&0<this.selectAction.preEvents.filter(function(e){return!e.batch}).length?("wf"===this.selectAction.typeId&&(e=this.componentRef.instance.comment),this.executeEvents(u(this.selectAction.preEvents.filter(function(e){return!e.batch})),function(){t.confirmSubmit(e)},e)):this.confirmSubmit()},v.prototype.confirmSubmit=function(t){var o=this,r=this.loadingService.show();this.handleSubmit().subscribe(function(e){e&&(r.close(),e.result?o.selectAction&&0<o.selectAction.postEvents.length&&0<o.selectAction.postEvents.filter(function(e){return!e.batch}).length?o.executeEvents(u(o.selectAction.postEvents.filter(function(e){return!e.batch})),function(){o.submited.emit(e),setTimeout(function(){o.submitDisable=!1},2e3)},t):(o.submited.emit(e),setTimeout(function(){o.submitDisable=!1},2e3)):o.submitDisable=!1),o.actionCodeMap.set("isTransfer","Transfer"===o.selectAction.code),o.actionCodeMap.set("isAddSignFront","AddSignFront"===o.selectAction.code),o.actionCodeMap.set("isUnClaim","Unclaim"===o.selectAction.code),o.actionCodeMap.set("isComment","Comment"===o.selectAction.code),o.actionCodeMap.set("isClaim","Claim"===o.selectAction.code),o.actionCode.emit(o.actionCodeMap)})},v.prototype.handleSubmit=function(){return this.componentRef.instance.submit()},v.prototype.batchHandleSubmit=function(e){return this.componentRef.instance.batchSubmit(e)},v.prototype.executeEvents=function(r,i,n){var a=this;if(r&&0<r.length){var e=r.shift(),t=e.eventImpl.split("#")[0],p=e.eventImpl.split("#")[1];System["import"](t+"?v="+(new Date).getTime().toString()).then(function(e){var t=Object.values(e)[0].create(a.injector),o={task:a.task,action:a.selectAction,origin:"TaskForm",formIframe:a.iframe,comment:n};t.instance[p].apply(t.instance,[o]).subscribe(function(e){"boolean"==typeof e?e?a.executeEvents(r,i,n):a.submitDisable=!1:e.result?(e.comment&&(n=e.comment),a.executeEvents(r,i,n)):a.submitDisable=!1})})}else this.componentRef.instance.comment=n,i()},v.prototype.focusTask=function(){var e=this.loadingService.show();this.ifFocused?this.taskService.addFocus(this.task.sourceId).subscribe(function(){e.close()},function(){e.close()}):this.taskService.removeFocus(this.task.processInstanceId).subscribe(function(){e.close()},function(){e.close()})},v.prototype.i18nService=function(e){var t=localStorage.getItem("languageCode"),o={"zh-CHS":{focus:"关注此流程",focused:"已关注此流程",confirm:"确认"},"zh-CHT":{focus:"關註此流程",focused:"已關註此流程",confirm:"確認"},en:{focus:"Focus this process",focused:"Focused this process",confirm:"Confirm"}};return t&&["zh-CHS","zh-CHT","en"].includes(t)?o[t][e]:o["zh-CHS"][e]},v.decorators=[{type:p.Component,args:[{selector:"task-action-impl",template:'<form\r\n  [class]="showButtons ? \'\' : \'px-4 py-2\'"\r\n  style="display: flex; flex-direction: column"\r\n>\r\n  <div\r\n    *ngIf="showButtons"\r\n    class="fa-approval-operate-list fa-approve-common-gutter flex-wrap"\r\n  >\r\n    <div\r\n      *ngFor="let action of actions; let i = index"\r\n      class="fa-approval-operate"\r\n    >\r\n      <input\r\n        type="radio"\r\n        name="operate"\r\n        [value]="i"\r\n        [id]="i"\r\n        class="approval-operate--radio"\r\n        [checked]="i === 0 ? true : false"\r\n      />\r\n      <label\r\n        class="approval-operate--label"\r\n        [for]="i"\r\n        (click)="actionSelect(action, i)"\r\n      >\r\n        <span class="label-title">{{ action.name }}</span>\r\n        <div class="label-tip"></div>\r\n        <span class="f-icon label-icon"></span>\r\n      </label>\r\n    </div>\r\n  </div>\r\n  \x3c!--组件容器--\x3e\r\n  <ng-container #container></ng-container>\r\n\r\n  \x3c!-- 关注此流程 --\x3e\r\n  <div\r\n    *ngIf="\r\n      showButtons && selectAction && selectAction.typeId === \'wf\' && ifShowFocus\r\n    "\r\n    class="custom-control custom-checkbox custom-control-inline"\r\n    style="margin-bottom: 20px"\r\n  >\r\n    <input\r\n      type="checkbox"\r\n      class="custom-control-input"\r\n      [(ngModel)]="ifFocused"\r\n      (ngModelChange)="focusTask()"\r\n      id="taskcenterfocus"\r\n      name="taskcenterfocus"\r\n    />\r\n    <label class="custom-control-label" for="taskcenterfocus">{{\r\n      focus\r\n    }}</label>\r\n  </div>\r\n\r\n  \x3c!-- 提交按钮 --\x3e\r\n  <div class="fa-btn-group-lg">\r\n    <button\r\n      *ngIf="showButtons && actions.length"\r\n      type="button"\r\n      class="btn btn-primary"\r\n      [disabled]="submitDisable"\r\n      directive-throttle\r\n      (throttleClick)="submit()"\r\n    >\r\n      {{ submitName }}\r\n    </button>\r\n  </div>\r\n</form>\r\n',styles:['.fa-approval-operate-list{display:flex;flex-direction:row;align-items:center}.fa-approval-operate-list .fa-approval-operate{margin-right:8px;margin-bottom:8px}.fa-approval-operate-list .approval-operate--label{position:relative;padding:4px 21px;overflow:hidden;cursor:pointer;margin-bottom:0;background:#f2f4f7;border-radius:6px;color:#424347;font-weight:500;font-size:13px}.fa-approval-operate-list .approval-operate--label:hover{color:#388fff;border-color:#388fff}.fa-approval-operate-list .approval-operate--label .label-title{line-height:20px;white-space:nowrap}.fa-approval-operate-list .approval-operate--label .label-tip{position:absolute;display:none;right:0;bottom:0;width:14px;height:14px;border:7px solid #dadada;border-top:7px solid transparent;border-left:7px solid transparent}.fa-approval-operate-list .approval-operate--label .label-icon{position:absolute;display:none;right:-3px;bottom:-2px;font-size:12px;color:#fff}.fa-approval-operate-list .approval-operate--label .label-icon::before{content:"\\e118"}.fa-approval-operate-list .approval-operate--radio{display:none}.fa-approval-operate-list .approval-operate--radio:checked~.approval-operate--label{padding:3px 19px;font-size:14px;background:rgba(23,145,255,.05);box-shadow:0 4px 10px 0 rgba(69,144,255,.3);border-radius:6px;border:1px solid #388fff;color:#388fff}.fa-approval-operate-list .approval-operate--radio:checked~.approval-operate--label .label-tip{display:block;border-right-color:#388fff;border-bottom-color:#388fff}.fa-approval-operate-list .approval-operate--radio:checked~.approval-operate--label .label-icon{display:block}.fa-btn-like-dropdown{display:flex;align-items:center}.fa-btn-like-dropdown .like-dropdown--text{margin:0 4px 0 0}.fa-btn-like-dropdown .like-dropdown--icon{color:rgba(0,0,0,.25)}.fa-approve-common-gutter{margin-bottom:20px}.fa-approve-comment .approve-comment--title{display:inline-block;color:#667580;border-radius:4px 4px 0 0;height:26px;padding:0 9px;position:relative;background:#f7f7f7;cursor:pointer}.fa-approve-comment .approve-comment--title:after{content:"";height:100%;position:absolute;right:-10px;top:0;bottom:0;border-right:5px solid transparent;border-left:5px solid #f7f7f7;border-bottom:13px solid #f7f7f7;border-top:13px solid transparent}.fa-approve-comment .approve-comment--title:hover{background:rgba(23,145,255,.05);color:#1791ff}.fa-approve-comment .approve-comment--title:hover:after{border-bottom-color:rgba(23,145,255,.05);border-left-color:rgba(23,145,255,.05)}.fa-approve-comment .approve-comment--title .fa-btn-like-dropdown{font-size:12px;padding:5px 0}.fa-approve-comment .fa-approve-comment--content .content-textarea{border-color:#dcdcdc;border-radius:0 0 2px 2px;height:140px}.fa-approve-comment .fa-approve-comment--footer{font-size:13px;color:#667580;background:#f7f7f7;padding:10px 0}.fa-approve-comment .approve-comment--text-btns{display:flex;flex-direction:row}.fa-approve-comment .approve-comment--text-btns .text-btns-item{display:flex;flex-direction:row;align-items:center;font-size:12px;line-height:18px;color:#667580;padding:4px;margin-right:8px;cursor:pointer}.fa-approve-comment .approve-comment--text-btns .text-btns-item:hover{color:#388fff}.fa-approve-comment .approve-comment--text-btns .text-btns-item .f-icon{margin-right:6px}.fa-approveal-links::after{content:".";display:block;height:0;clear:both;visibility:hidden}.fa-approveal-links .approveal-links--link{font-size:14px;position:relative;padding:0 16px 0 0;display:flex;align-items:center;float:left}.fa-approveal-links .approveal-links--link .link-text{color:rgba(0,0,0,.65);margin:0 8px 0 0}.fa-approveal-links .approveal-links--link+.approveal-links--link{padding-left:16px}.fa-approveal-links .approveal-links--link+.approveal-links--link::before{content:"";position:absolute;width:1px;height:80%;left:0;top:10%;background:#dbdbdb}.fa-btn-group-lg .btn{width:180px;height:32px;box-shadow:0 4px 10px 0 rgba(69,144,255,.25);border-radius:6px;min-width:100px;text-align:center;font-size:13px}.fa-approve-record{padding:0 0 16px;position:relative}.fa-approve-record .fa-approve-record--timeline{position:absolute;width:34px;top:0;bottom:0;z-index:100}.fa-approve-record .fa-approve-record--timeline::after{content:"";position:absolute;width:1px;height:100%;overflow:hidden;left:50%;top:0;z-index:101;border-left:1px dashed #dcdcdc}.fa-approve-record .fa-approve-record--timeline .fa-approve-star{position:relative;z-index:103;margin:20px auto}.fa-approve-record.fa-state-running .fa-approve-record--timeline::after{top:20px}.fa-approve-record:last-child .fa-approve-record--timeline::after{height:20px}.fa-approve-record .fa-approve-record--content{margin:0 0 0 34px;padding:16px 14px;background:#f9f9f9;border-radius:2px}.fa-approve-record .fa-approve-record--content .approve-record--header{margin:0 0 12px;display:flex;align-items:center}.fa-approve-record .fa-approve-record--content .approve-record--header .header--title{margin-bottom:0;color:rgba(0,0,0,.85)}.fa-approve-record .fa-approve-record--content .approve-record--header>*{margin:0 19px 0 0}.fa-approve-record .approve-record--list-item{display:flex;flex-direction:row}.fa-approve-record .approve-record--list-item+.approve-record--list-item{padding-top:8px}.fa-approve-record .approve-record--list-item .list-item--auxiliary{width:30px;margin:0 10px 0 0}.fa-approve-record .approve-record--list-item .list-item--main{flex-grow:1;flex-shrink:1;flex-basis:auto;padding:6px 0 0;background:#f9f9f9}.fa-approve-record .approve-record--list-item .list-item--content{padding:20px 0 0}.fa-approve-record .approve-record--list-item .list-item--content .list-item--info{font-size:12px;margin-bottom:0}.fa-approve-record .approve-record--list-item .list-item--content .list-item--info .info-label{color:rgba(0,0,0,.65)}.fa-approve-record .approve-record--list-item .list-item--content .list-item--info .info-text{color:rgba(0,0,0,.85)}.fa-approve-record .approve-record--list-item .list-item--header{display:flex;align-items:center}.fa-approve-record .approve-record--list-item .list-item--header>*{margin:0 16px 0 0}.fa-approve-record .approve-record--list-item .list-item--header .list-item--info{margin-bottom:0;font-size:12px}.fa-approve-record .approve-record--list-item .list-item--header .list-item--info .info-label{color:rgba(0,0,0,.35)}.fa-approve-record .approve-record--list-item .list-item--header .list-item--info .info-text{color:rgba(0,0,0,.65)}.fa-approve-record .approve-record--list-item .list-item--name{color:#4297fa}.fa-approve-record .approve-record--avatar{width:30px;height:30px;border-radius:15px}.fa-approve-round-bg{margin:4px auto 0;width:30px;height:30px;background:#59a1ff;border-radius:18px;line-height:30px;text-align:center;white-space:nowrap;font-size:12px;overflow:hidden}.fa-approve-round-bg-text{color:#fff}.fa-approve-star{width:14px;height:14px;display:block;background:rgba(56,143,255,.4);border-radius:7px;position:relative}.fa-approve-star::after{content:"";width:8px;height:8px;position:absolute;top:50%;left:50%;margin:-4px 0 0 -4px;border-radius:4px;background:#388fff}.fa-approve-star.bg-warning{background:rgba(245,156,36,.4)!important}.fa-approve-star.bg-warning::after{background:#f59c24}.fa-approve-badge{padding-top:4px;padding-bottom:4px;border-radius:10px}.fa-approve-badge-light{font-size:13px;line-height:20px;padding:0 8px;color:#5f637a;border:1px solid #e6e6e6;background:#f6faff}.fa-approve-link-border{cursor:pointer;display:inline-block;border:1px solid #60a5ff;border-radius:13px;font-size:12px;line-height:16px;color:#388fff;padding:3px 10px;background:#ebf5ff}.fa-approve-link-border:hover{background:#2881ff;color:#fff}']}]}],v.ctorParameters=function(){return[{type:p.Injector},{type:p.ComponentFactoryResolver},{type:n.LoadingService},{type:l.MessagerService},{type:f}]},v.propDecorators={container:[{type:p.ViewChild,args:["container",{read:p.ViewContainerRef}]}],actions:[{type:p.Input}],submitName:[{type:p.Input}],showButtons:[{type:p.Input}],batch:[{type:p.Input}],task:[{type:p.Input}],iframe:[{type:p.Input}],origin:[{type:p.Input}],submited:[{type:p.Output}],actionCode:[{type:p.Output}]},v);function v(e,t,o,r,i){this.injector=e,this.cfr=t,this.loadingService=o,this.msgService=r,this.taskService=i,this.showButtons=!0,this.batch=!1,this.submited=new p.EventEmitter,this.actionCode=new p.EventEmitter,this.actionCodeMap=new Map,this.index=0,this.submitDisable=!1,this.ifFocused=!1,this.focus=this.i18nService("focus"),this.ifShowFocus=!0,this.ngZone=this.injector.get(p.NgZone)}var b=(g.prototype.ngOnInit=function(){var t=this,e=this.subject.pipe(c.throttleTime(this.THROTTLE_TIME));this.click=e.subscribe(function(e){t.throttleClick.emit(e)})},g.prototype.ngOnDestroy=function(){this.click.unsubscribe()},g.prototype.onClick=function(e){this.subject.next(e)},g.decorators=[{type:p.Directive,args:[{selector:"[directive-throttle]"}]}],g.ctorParameters=function(){return[]},g.propDecorators={throttleClick:[{type:p.Output}],onClick:[{type:p.HostListener,args:["click",["$event"]]}]},g);function g(){this.THROTTLE_TIME=2e3,this.subject=new s.Subject,this.throttleClick=new p.EventEmitter}var x=(k.decorators=[{type:p.NgModule,args:[{declarations:[h,b],imports:[r.CommonModule,i.FormsModule,a.WfTaskHandlerModule,n.LoadingModule,l.MessagerModule.forRoot()],exports:[h],providers:[f]}]}],k);function k(){}e.TaskActionImplService=f,e.TaskActionImplComponent=h,e.TaskActionImplModule=x,e.ɵa=b,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=gsp-wf-task-action-impl.umd.min.js.map