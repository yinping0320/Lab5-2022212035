/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, HostBinding, Input, Output, EventEmitter, ViewChild, TemplateRef, ChangeDetectorRef, Optional, Inject, LOCALE_ID } from '@angular/core';
import { CallActivitySubProcess } from './call-activity-sub-process.entity';
import { MessagerService } from '@farris/ui-messager';
import { ProcessDeUtil } from '../../domain/process-de-util';
import { HttpService } from '@ecp-caf/caf-common';
import { ProcessDesignerUIState } from '../../app/process-designer.uistate';
import { ExpressionService, InjectedType } from '@gsp-svc/expression';
import { WF_LANG_RESOURCES, WfLocalePipe } from '../../i18n/pipe/wf-process-editor-locale.pipe';
export class CallActivitySubProcessComponent {
    /**
     * @param {?} message
     * @param {?} util
     * @param {?} http
     * @param {?} designerState
     * @param {?} expr
     * @param {?} cdr
     * @param {?} localeId
     * @param {?} resources
     * @param {?} localePipe
     */
    constructor(message, util, http, designerState, expr, cdr, localeId, resources, localePipe) {
        this.message = message;
        this.util = util;
        this.http = http;
        this.designerState = designerState;
        this.expr = expr;
        this.cdr = cdr;
        this.localeId = localeId;
        this.resources = resources;
        this.localePipe = localePipe;
        this.cls = 'farris-main-area flex-column';
        this.closeModal = new EventEmitter();
        this.submitModal = new EventEmitter();
        this.modalConfig = {
            title: this.localePipe.transform("component.subProcess.subProcessOpt"),
            width: 500,
            height: 380,
            showButtons: true
        };
        this.callActivitySubProcess = new CallActivitySubProcess();
        this.groupIcon = '<i class="f-icon f-icon-lookup"></i>';
        this.localePipe = this.localePipe || new WfLocalePipe(localeId, resources);
    }
    /**
     * @param {?} v
     * @return {?}
     */
    set value(v) {
        if (v) {
            this.callActivitySubProcess = v;
            this.getProcessDefKey(this.callActivitySubProcess.calledElement);
            this.getFlowForm(this.callActivitySubProcess.calledBizDefKey);
        }
    }
    /**
     * @return {?}
     */
    ngOnInit() {
    }
    /**
     * @return {?}
     */
    clickOK() {
        if (this.validator()) {
            /** @type {?} */
            const object = { value: this.callActivitySubProcess, parameters: null };
            this.submitModal.emit(object);
        }
    }
    /**
     * @return {?}
     */
    clickCancel() {
        this.closeModal.emit();
    }
    /**
     * @param {?} args
     * @return {?}
     */
    processConfirm(args) {
        if (args) {
            this.callActivitySubProcess.calledElement = args.procDefKey;
            this.callActivitySubProcess.calledElementName = args.name;
        }
    }
    /**
     * @param {?} args
     * @return {?}
     */
    clearProcessDef(args) {
        this.callActivitySubProcess.calledElement = '';
        this.callActivitySubProcess.calledElementName = '';
    }
    /**
     * @param {?} args
     * @return {?}
     */
    flowFormConfirm(args) {
        if (args) {
            this.callActivitySubProcess.calledBizDefKey = args.id;
            this.callActivitySubProcess.calledBizDefName = args.name;
        }
    }
    /**
     * @param {?} args
     * @return {?}
     */
    clearFlowForm(args) {
        this.callActivitySubProcess.calledBizDefKey = '';
        this.callActivitySubProcess.calledBizDefName = '';
    }
    /**
     * @return {?}
     */
    setBizDataId() {
        this.showExprHelp();
    }
    /**
     * @private
     * @return {?}
     */
    showExprHelp() {
        /** @type {?} */
        let context = new Array();
        // if(this.expr.exprEntity.contextEntities.find(x => x.key === 'CurrentLanguage')) {
        //   context.push(this.expr.exprEntity.contextEntities.find(x => x.key === 'CurrentLanguage'));
        // }
        // this.expr.clearContext();
        if (this.designerState.schemas.length > 0) {
            for (const schema of this.designerState.schemas) {
                this.expr.addSchema('Schema', schema);
            }
            if (this.designerState.schemas[0].entityTypes && this.designerState.schemas[0].entityTypes.length > 0) {
                /** @type {?} */
                const entityType = this.designerState.schemas[0].entityTypes[0];
                this.expr.addInjectedEntity(entityType.name, 'Schema', entityType.name, InjectedType.EntityType);
            }
        }
        context = this.designerState.addContext(context);
        if (this.designerState.subActivityContext.length > 0) {
            for (const variable of this.designerState.subActivityContext) {
                context.push(variable);
                // this.expr.addContext(variable);
            }
        }
        if (context.length > 0) {
            for (const v of context) {
                this.expr.addContext(v);
            }
        }
        this.expr.addExpressionText(this.callActivitySubProcess.bizDataId);
        this.expr.buildExpression().then((/**
         * @param {?} expressioninfo
         * @return {?}
         */
        (expressioninfo) => {
            this.callActivitySubProcess.bizDataId = expressioninfo;
            //点击确定后，去除表达式里面的新增的上下文变量
            if (context.length > 0) {
                this.expr.exprEntity.contextEntities = this.expr.exprEntity.contextEntities.filter((/**
                 * @param {?} x
                 * @return {?}
                 */
                x => !context.some((/**
                 * @param {?} y
                 * @return {?}
                 */
                y => y.key === x.key))));
            }
        }));
    }
    /**
     * @param {?} bool
     * @return {?}
     */
    valueChange(bool) {
        if (bool) {
            this.callActivitySubProcess.bizDataId = null;
        }
    }
    /**
     * @private
     * @return {?}
     */
    validator() {
        if (!this.callActivitySubProcess.inheritBizDataId && !this.callActivitySubProcess.bizDataId) {
            this.message.warning(this.localePipe.transform("component.subProcess.inheritBizDataId"));
            return false;
        }
        return true;
    }
    /**
     * @private
     * @param {?} key
     * @return {?}
     */
    getProcessDefKey(key) {
        /** @type {?} */
        let url = this.util.getProcessDefinitionWebApi();
        if (key) {
            url += `/procDefKey/${key}`;
            this.http.get(url).subscribe((/**
             * @param {?} re
             * @return {?}
             */
            (re) => {
                this.callActivitySubProcess.calledElementName = re.name;
            }));
        }
    }
    /**
     * @private
     * @param {?} id
     * @return {?}
     */
    getFlowForm(id) {
        /** @type {?} */
        let url = this.util.getFlowFormWebApi();
        if (id) {
            url += `/${id}`;
            this.http.get(url).subscribe((/**
             * @param {?} re
             * @return {?}
             */
            (re) => {
                this.callActivitySubProcess.calledBizDefName = re.name;
            }));
        }
    }
}
CallActivitySubProcessComponent.decorators = [
    { type: Component, args: [{
                selector: 'lib-call-activity-sub-process',
                template: "<div class=\"f-page\">\r\n  <div class=\"f-utils-fill-flex-column farris-split-section m-2 h-100\">\r\n    <section class=\"f-utils-fill-flex-column h-100\">\r\n      <div class=\"f-section-header pt-2 mx-2\">\r\n        <div class=\"f-title\">\r\n          <h4 class=\"f-title-text\">{{'component.subProcess.setOption' | wfLocale}}</h4>\r\n        </div>\r\n      </div>\r\n      <div class=\"f-utils-fill-flex-column h-100\">\r\n        <form class=\"h-100\">\r\n          <div class=\"farris-form form-inline farris-form-inline\">\r\n            <div class=\"farris-group-wrap mt-1\">\r\n              <div class=\"form-group farris-form-group\">\r\n                <label class=\"col-form-label\">\r\n                  <span class=\"farris-label-text\">{{'component.subProcess.flowForm' | wfLocale}}</span>\r\n                </label>\r\n                <div class=\"farris-input-wrap ml-1\">\r\n                  <wf-bizprocess-lookup title=\"{{'component.subProcess.flowForm' | wfLocale}}\" [sourceType]=\"'flowform'\" [displayTxt]=\"callActivitySubProcess.calledBizDefName\"\r\n                    (afterConfirm)=\"flowFormConfirm($event)\" (clear)=\"clearFlowForm($event)\">\r\n                  </wf-bizprocess-lookup>\r\n                  <div class=\"farris-feedback valid-feedback\"></div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            <div class=\"farris-group-wrap my-4\">\r\n              <div class=\"form-group farris-form-group\">\r\n                <label class=\"col-form-label\">\r\n                  <span class=\"farris-label-text\">{{'component.subProcess.processDef' | wfLocale}}</span>\r\n                </label>\r\n                <div class=\"farris-input-wrap ml-1\">\r\n                  <wf-bizprocess-lookup title=\"{{'component.subProcess.processDef' | wfLocale}}\"  [displayTxt]=\"callActivitySubProcess.calledElementName\"\r\n                    (afterConfirm)=\"processConfirm($event)\" (clear)=\"clearProcessDef($event)\">\r\n                  </wf-bizprocess-lookup>\r\n                  <div class=\"farris-feedback valid-feedback\"></div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            <!-- <div class=\"farris-group-wrap my-4\">\r\n              <div class=\"form-group farris-form-group\">\r\n                <label class=\"col-form-label\">\r\n                  <span class=\"farris-label-info text-danger\">*</span>\r\n                  <span class=\"farris-label-text\">\u7EE7\u627F\u53D8\u91CF</span>\r\n                </label>\r\n                <div class=\"farris-input-wrap ml-1\">\r\n                  <farris-switch [(ngModel)]=\"callActivitySubProcess.inheritVariables\" name=\"inheritVariables\">\r\n                  </farris-switch>\r\n                  <div class=\"farris-feedback valid-feedback\"></div>\r\n                </div>\r\n              </div>\r\n            </div> -->\r\n            <div class=\"farris-group-wrap my-4\">\r\n              <div class=\"form-group farris-form-group\">\r\n                <label class=\"ml-4 pl-3\">\r\n                  <span class=\"farris-label-text\">{{'component.subProcess.SameParentProcess' | wfLocale}}</span>\r\n                </label>\r\n                <div class=\"farris-input-wrap ml-3\">\r\n                  <farris-switch  [(ngModel)]=\"callActivitySubProcess.inheritBizDataId\" name=\"inheritBizDataId\"\r\n                    (valueChange)=\"valueChange($event)\">\r\n                  </farris-switch>\r\n                  <div class=\"farris-feedback valid-feedback\"></div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            <div *ngIf=\"!callActivitySubProcess.inheritBizDataId\" class=\"farris-group-wrap\">\r\n              <div class=\"form-group farris-form-group\">\r\n                <label class=\"ml-4 pl-3\">\r\n                  <span class=\"farris-label-text\">{{'component.subProcess.setBizDataId' | wfLocale}}</span>\r\n                </label>\r\n                <div class=\"farris-input-wrap ml-3\">\r\n                  <input-group class=\"form-control\" style=\"width: 100%;padding:0;border:0;\" [enableClear]=\"false\"\r\n                    [ngModel]=\"callActivitySubProcess.bizDataId\" name=\"bizDataId\"\r\n                    [editable]=\"false\" (clickHandle)=\"setBizDataId()\" [groupText]=\"groupIcon\"></input-group>\r\n                  <div class=\"farris-feedback valid-feedback\"></div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </section>\r\n  </div>\r\n</div>\r\n\r\n<ng-template #iconSelectFooter>\r\n  <button type=\"button\" class=\"btn btn-secondary btn-sm mx-2\" (click)=\"clickCancel()\">{{'component.subProcess.clickCancel' | wfLocale}}</button>\r\n  <button type=\"button\" class=\"btn btn-primary btn-sm mx-2\" (click)=\"clickOK()\">{{'component.subProcess.clickOk' | wfLocale}}</button>\r\n</ng-template>\r\n",
                providers: [
                    WfLocalePipe,
                ],
                styles: [""]
            }] }
];
/** @nocollapse */
CallActivitySubProcessComponent.ctorParameters = () => [
    { type: MessagerService },
    { type: ProcessDeUtil },
    { type: HttpService },
    { type: ProcessDesignerUIState },
    { type: ExpressionService },
    { type: ChangeDetectorRef, decorators: [{ type: Optional }] },
    { type: String, decorators: [{ type: Inject, args: [LOCALE_ID,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [WF_LANG_RESOURCES,] }] },
    { type: WfLocalePipe, decorators: [{ type: Optional }] }
];
CallActivitySubProcessComponent.propDecorators = {
    cls: [{ type: HostBinding, args: ['class',] }],
    value: [{ type: Input }],
    closeModal: [{ type: Output }],
    submitModal: [{ type: Output }],
    modalFooter: [{ type: ViewChild, args: ['iconSelectFooter',] }]
};
if (false) {
    /** @type {?} */
    CallActivitySubProcessComponent.prototype.cls;
    /** @type {?} */
    CallActivitySubProcessComponent.prototype.closeModal;
    /** @type {?} */
    CallActivitySubProcessComponent.prototype.submitModal;
    /** @type {?} */
    CallActivitySubProcessComponent.prototype.modalFooter;
    /** @type {?} */
    CallActivitySubProcessComponent.prototype.modalConfig;
    /** @type {?} */
    CallActivitySubProcessComponent.prototype.callActivitySubProcess;
    /** @type {?} */
    CallActivitySubProcessComponent.prototype.groupIcon;
    /**
     * @type {?}
     * @private
     */
    CallActivitySubProcessComponent.prototype.message;
    /**
     * @type {?}
     * @private
     */
    CallActivitySubProcessComponent.prototype.util;
    /**
     * @type {?}
     * @private
     */
    CallActivitySubProcessComponent.prototype.http;
    /**
     * @type {?}
     * @private
     */
    CallActivitySubProcessComponent.prototype.designerState;
    /**
     * @type {?}
     * @private
     */
    CallActivitySubProcessComponent.prototype.expr;
    /**
     * @type {?}
     * @private
     */
    CallActivitySubProcessComponent.prototype.cdr;
    /**
     * @type {?}
     * @private
     */
    CallActivitySubProcessComponent.prototype.localeId;
    /**
     * @type {?}
     * @private
     */
    CallActivitySubProcessComponent.prototype.resources;
    /**
     * @type {?}
     * @private
     */
    CallActivitySubProcessComponent.prototype.localePipe;
}
export class CallActivitySubProcessConverter {
    /**
     * @param {?} localePipe
     */
    constructor(localePipe) {
        this.localePipe = localePipe;
    }
    /**
     * @param {?} data
     * @return {?}
     */
    convertTo(data) {
        if (data && (data.calledBizDefKey || data.calledElement)) {
            return this.localePipe.transform("component.subProcess.set");
        }
        return this.localePipe.transform("component.subProcess.notSet");
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    CallActivitySubProcessConverter.prototype.localePipe;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsbC1hY3Rpdml0eS1zdWItcHJvY2Vzcy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ3NwLXdmL3dmLXByb2Nlc3MtZWRpdG9yLyIsInNvdXJjZXMiOlsibGliL3ZpZXdzL2NhbGwtYWN0aXZpdHktc3ViLXByb2Nlc3MvY2FsbC1hY3Rpdml0eS1zdWItcHJvY2Vzcy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQVUsV0FBVyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsaUJBQWlCLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFcEssT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDNUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFbEQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDNUUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFlBQVksRUFBYSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pGLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxZQUFZLEVBQUUsTUFBTSwrQ0FBK0MsQ0FBQztBQVdoRyxNQUFNLE9BQU8sK0JBQStCOzs7Ozs7Ozs7Ozs7SUF5QjFDLFlBQ1UsT0FBd0IsRUFDeEIsSUFBbUIsRUFDbkIsSUFBaUIsRUFDakIsYUFBcUMsRUFDckMsSUFBdUIsRUFDWCxHQUFzQixFQUNmLFFBQWdCLEVBQ1IsU0FBYyxFQUM3QixVQUF3QjtRQVJwQyxZQUFPLEdBQVAsT0FBTyxDQUFpQjtRQUN4QixTQUFJLEdBQUosSUFBSSxDQUFlO1FBQ25CLFNB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NUNELFlBQVksdUJBNkNuQyxRQUFROzs7a0JBakNWLFdBQVcsU0FBQyxPQUFPO29CQUduQixLQUFLO3lCQU9MLE1BQU07MEJBQ04sTUFBTTswQkFFTixTQUFTLFNBQUMsa0JBQWtCOzs7O0lBYjdCLDhDQUNxQzs7SUFTckMscURBQStDOztJQUMvQyxzREFBZ0Q7O0lBRWhELHNEQUE2RDs7SUFDN0Qsc0RBS0U7O0lBRUYsaUVBQThFOztJQUU5RSxvREFBbUQ7Ozs7O0lBRWpELGtEQUFnQzs7Ozs7SUFDaEMsK0NBQTJCOzs7OztJQUMzQiwrQ0FBeUI7Ozs7O0lBQ3pCLHdEQUE2Qzs7Ozs7SUFDN0MsK0NBQStCOzs7OztJQUMvQiw4Q0FBMEM7Ozs7O0lBQzFDLG1EQUEyQzs7Ozs7SUFDM0Msb0RBQWlEOzs7OztJQUNqRCxxREFBNEM7O0FBdUhoRCxNQUFNLE9BQU8sK0JBQStCOzs7O0lBQzFDLFlBQ1UsVUFBd0I7UUFBeEIsZUFBVSxHQUFWLFVBQVUsQ0FBYztJQUM5QixDQUFDOzs7OztJQUVMLFNBQVMsQ0FBQyxJQUFTO1FBQ2pCLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUU7WUFDeEQsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1NBQzlEO1FBQ0QsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0lBQ2xFLENBQUM7Q0FDRjs7Ozs7O0lBVEcscURBQWdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIEhvc3RCaW5kaW5nLCBJbnB1dCwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIFZpZXdDaGlsZCwgVGVtcGxhdGVSZWYsIENoYW5nZURldGVjdG9yUmVmLCBPcHRpb25hbCwgSW5qZWN0LCBMT0NBTEVfSUQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgVHlwZUNvbnZlcnRlciB9IGZyb20gJ0BmYXJyaXMvaWRlLXByb3BlcnR5LXBhbmVsJztcclxuaW1wb3J0IHsgQ2FsbEFjdGl2aXR5U3ViUHJvY2VzcyB9IGZyb20gJy4vY2FsbC1hY3Rpdml0eS1zdWItcHJvY2Vzcy5lbnRpdHknO1xyXG5pbXBvcnQgeyBNZXNzYWdlclNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLW1lc3NhZ2VyJztcclxuaW1wb3J0IHsgUHJvY2Vzc0RlVXRpbCB9IGZyb20gJy4uLy4uL2RvbWFpbi9wcm9jZXNzLWRlLXV0aWwnO1xyXG5pbXBvcnQgeyBIdHRwU2VydmljZSB9IGZyb20gJ0BlY3AtY2FmL2NhZi1jb21tb24nO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IFByb2Nlc3NEZXNpZ25lclVJU3RhdGUgfSBmcm9tICcuLi8uLi9hcHAvcHJvY2Vzcy1kZXNpZ25lci51aXN0YXRlJztcclxuaW1wb3J0IHsgRXhwcmVzc2lvblNlcnZpY2UsIEluamVjdGVkVHlwZSwgVmFyRW50aXR5IH0gZnJvbSAnQGdzcC1zdmMvZXhwcmVzc2lvbic7XHJcbmltcG9ydCB7IFdGX0xBTkdfUkVTT1VSQ0VTLCBXZkxvY2FsZVBpcGUgfSBmcm9tICcuLi8uLi9pMThuL3BpcGUvd2YtcHJvY2Vzcy1lZGl0b3ItbG9jYWxlLnBpcGUnO1xyXG5pbXBvcnQgeyBXRl9QUk9DRVNTX0VESVRPUl9MQU5HX1JFU09VUkNFUyB9IGZyb20gJy4uLy4uL2kxOG4vYXNzZXRzL2xhbmcucmVzb3VyY2UnO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdsaWItY2FsbC1hY3Rpdml0eS1zdWItcHJvY2VzcycsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL2NhbGwtYWN0aXZpdHktc3ViLXByb2Nlc3MuY29tcG9uZW50Lmh0bWwnLFxyXG4gIHN0eWxlVXJsczogWycuL2NhbGwtYWN0aXZpdHktc3ViLXByb2Nlc3MuY29tcG9uZW50LnNjc3MnXSxcclxuICBwcm92aWRlcnM6IFtcclxuICAgICBXZkxvY2FsZVBpcGUsXHJcbiAgXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgQ2FsbEFjdGl2aXR5U3ViUHJvY2Vzc0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcbiAgQEhvc3RCaW5kaW5nKCdjbGFzcycpXHJcbiAgY2xzID0gJ2ZhcnJpcy1tYWluLWFyZWEgZmxleC1jb2x1bW4nO1xyXG5cclxuICBASW5wdXQoKSBzZXQgdmFsdWUodjogQ2FsbEFjdGl2aXR5U3ViUHJvY2Vzcykge1xyXG4gICAgaWYgKHYpIHtcclxuICAgICAgdGhpcy5jYWxsQWN0aXZpdHlTdWJQcm9jZXNzID0gdjtcclxuICAgICAgdGhpcy5nZXRQcm9jZXNzRGVmS2V5KHRoaXMuY2FsbEFjdGl2aXR5U3ViUHJvY2Vzcy5jYWxsZWRFbGVtZW50KTtcclxuICAgICAgdGhpcy5nZXRGbG93Rm9ybSh0aGlzLmNhbGxBY3Rpdml0eVN1YlByb2Nlc3MuY2FsbGVkQml6RGVmS2V5KTtcclxuICAgIH1cclxuICB9XHJcbiAgQE91dHB1dCgpIGNsb3NlTW9kYWwgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuICBAT3V0cHV0KCkgc3VibWl0TW9kYWwgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuXHJcbiAgQFZpZXdDaGlsZCgnaWNvblNlbGVjdEZvb3RlcicpIG1vZGFsRm9vdGVyOiBUZW1wbGF0ZVJlZjxhbnk+O1xyXG4gIG1vZGFsQ29uZmlnID0ge1xyXG4gICAgdGl0bGU6IHRoaXMubG9jYWxlUGlwZS50cmFuc2Zvcm0oXCJjb21wb25lbnQuc3ViUHJvY2Vzcy5zdWJQcm9jZXNzT3B0XCIpLFxyXG4gICAgd2lkdGg6IDUwMCxcclxuICAgIGhlaWdodDogMzgwLFxyXG4gICAgc2hvd0J1dHRvbnM6IHRydWVcclxuICB9O1xyXG5cclxuICBjYWxsQWN0aXZpdHlTdWJQcm9jZXNzOiBDYWxsQWN0aXZpdHlTdWJQcm9jZXNzID0gbmV3IENhbGxBY3Rpdml0eVN1YlByb2Nlc3MoKTtcclxuXHJcbiAgZ3JvdXBJY29uID0gJzxpIGNsYXNzPVwiZi1pY29uIGYtaWNvbi1sb29rdXBcIj48L2k+JztcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgbWVzc2FnZTogTWVzc2FnZXJTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSB1dGlsOiBQcm9jZXNzRGVVdGlsLFxyXG4gICAgcHJpdmF0ZSBodHRwOiBIdHRwU2VydmljZSxcclxuICAgIHByaXZhdGUgZGVzaWduZXJTdGF0ZTogUHJvY2Vzc0Rlc2lnbmVyVUlTdGF0ZSxcclxuICAgIHByaXZhdGUgZXhwcjogRXhwcmVzc2lvblNlcnZpY2UsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgICBASW5qZWN0KExPQ0FMRV9JRCkgcHJpdmF0ZSBsb2NhbGVJZDogc3RyaW5nLFxyXG4gICAgQEluamVjdChXRl9MQU5HX1JFU09VUkNFUykgcHJpdmF0ZSByZXNvdXJjZXM6IGFueSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgbG9jYWxlUGlwZTogV2ZMb2NhbGVQaXBlXHJcbiAgKSB7XHJcbiAgICB0aGlzLmxvY2FsZVBpcGUgPSB0aGlzLmxvY2FsZVBpcGUgfHwgbmV3IFdmTG9jYWxlUGlwZShsb2NhbGVJZCwgcmVzb3VyY2VzKTtcclxuICAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICB9XHJcblxyXG5cclxuICBjbGlja09LKCkge1xyXG4gICAgaWYgKHRoaXMudmFsaWRhdG9yKCkpIHtcclxuICAgICAgY29uc3Qgb2JqZWN0ID0geyB2YWx1ZTogdGhpcy5jYWxsQWN0aXZpdHlTdWJQcm9jZXNzLCBwYXJhbWV0ZXJzOiBudWxsIH07XHJcbiAgICAgIHRoaXMuc3VibWl0TW9kYWwuZW1pdChvYmplY3QpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgY2xpY2tDYW5jZWwoKSB7XHJcbiAgICB0aGlzLmNsb3NlTW9kYWwuZW1pdCgpO1xyXG4gIH1cclxuXHJcbiAgcHJvY2Vzc0NvbmZpcm0oYXJnczogYW55KSB7XHJcbiAgICBpZiAoYXJncykge1xyXG4gICAgICB0aGlzLmNhbGxBY3Rpdml0eVN1YlByb2Nlc3MuY2FsbGVkRWxlbWVudCA9IGFyZ3MucHJvY0RlZktleTtcclxuICAgICAgdGhpcy5jYWxsQWN0aXZpdHlTdWJQcm9jZXNzLmNhbGxlZEVsZW1lbnROYW1lID0gYXJncy5uYW1lO1xyXG4gICAgfVxyXG4gIH1cclxuICBjbGVhclByb2Nlc3NEZWYoYXJnczogYW55KSB7XHJcbiAgICB0aGlzLmNhbGxBY3Rpdml0eVN1YlByb2Nlc3MuY2FsbGVkRWxlbWVudCA9ICcnO1xyXG4gICAgdGhpcy5jYWxsQWN0aXZpdHlTdWJQcm9jZXNzLmNhbGxlZEVsZW1lbnROYW1lID0gJyc7XHJcbiAgfVxyXG5cclxuICBmbG93Rm9ybUNvbmZpcm0oYXJnczogYW55KSB7XHJcbiAgICBpZiAoYXJncykge1xyXG4gICAgICB0aGlzLmNhbGxBY3Rpdml0eVN1YlByb2Nlc3MuY2FsbGVkQml6RGVmS2V5ID0gYXJncy5pZDtcclxuICAgICAgdGhpcy5jYWxsQWN0aXZpdHlTdWJQcm9jZXNzLmNhbGxlZEJpekRlZk5hbWUgPSBhcmdzLm5hbWU7XHJcbiAgICB9XHJcbiAgfVxyXG4gIGNsZWFyRmxvd0Zvcm0oYXJnczogYW55KSB7XHJcbiAgICB0aGlzLmNhbGxBY3Rpdml0eVN1YlByb2Nlc3MuY2FsbGVkQml6RGVmS2V5ID0gJyc7XHJcbiAgICB0aGlzLmNhbGxBY3Rpdml0eVN1YlByb2Nlc3MuY2FsbGVkQml6RGVmTmFtZSA9ICcnO1xyXG4gIH1cclxuXHJcbiAgc2V0Qml6RGF0YUlkKCkge1xyXG4gICAgdGhpcy5zaG93RXhwckhlbHAoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2hvd0V4cHJIZWxwKCkge1xyXG4gICAgbGV0IGNvbnRleHQgPSBuZXcgQXJyYXk8VmFyRW50aXR5PigpO1xyXG4gICAgLy8gaWYodGhpcy5leHByLmV4cHJFbnRpdHkuY29udGV4dEVudGl0aWVzLmZpbmQoeCA9PiB4LmtleSA9PT0gJ0N1cnJlbnRMYW5ndWFnZScpKSB7XHJcbiAgICAvLyAgIGNvbnRleHQucHVzaCh0aGlzLmV4cHIuZXhwckVudGl0eS5jb250ZXh0RW50aXRpZXMuZmluZCh4ID0+IHgua2V5ID09PSAnQ3VycmVudExhbmd1YWdlJykpO1xyXG4gICAgLy8gfVxyXG4gICAgLy8gdGhpcy5leHByLmNsZWFyQ29udGV4dCgpO1xyXG4gICAgaWYgKHRoaXMuZGVzaWduZXJTdGF0ZS5zY2hlbWFzLmxlbmd0aCA+IDApIHtcclxuICAgICAgZm9yIChjb25zdCBzY2hlbWEgb2YgdGhpcy5kZXNpZ25lclN0YXRlLnNjaGVtYXMpIHtcclxuICAgICAgICB0aGlzLmV4cHIuYWRkU2NoZW1hKCdTY2hlbWEnLCBzY2hlbWEpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICh0aGlzLmRlc2lnbmVyU3RhdGUuc2NoZW1hc1swXS5lbnRpdHlUeXBlcyAmJiB0aGlzLmRlc2lnbmVyU3RhdGUuc2NoZW1hc1swXS5lbnRpdHlUeXBlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgY29uc3QgZW50aXR5VHlwZSA9IHRoaXMuZGVzaWduZXJTdGF0ZS5zY2hlbWFzWzBdLmVudGl0eVR5cGVzWzBdO1xyXG4gICAgICAgIHRoaXMuZXhwci5hZGRJbmplY3RlZEVudGl0eShlbnRpdHlUeXBlLm5hbWUsICdTY2hlbWEnLFxyXG4gICAgICAgICAgZW50aXR5VHlwZS5uYW1lLCBJbmplY3RlZFR5cGUuRW50aXR5VHlwZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGNvbnRleHQgPSB0aGlzLmRlc2lnbmVyU3RhdGUuYWRkQ29udGV4dChjb250ZXh0KTtcclxuICAgIGlmICh0aGlzLmRlc2lnbmVyU3RhdGUuc3ViQWN0aXZpdHlDb250ZXh0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgZm9yIChjb25zdCB2YXJpYWJsZSBvZiB0aGlzLmRlc2lnbmVyU3RhdGUuc3ViQWN0aXZpdHlDb250ZXh0KSB7XHJcbiAgICAgICAgY29udGV4dC5wdXNoKHZhcmlhYmxlKTtcclxuICAgICAgICAvLyB0aGlzLmV4cHIuYWRkQ29udGV4dCh2YXJpYWJsZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGlmIChjb250ZXh0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgZm9yIChjb25zdCB2IG9mIGNvbnRleHQpIHtcclxuICAgICAgICB0aGlzLmV4cHIuYWRkQ29udGV4dCh2KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgdGhpcy5leHByLmFkZEV4cHJlc3Npb25UZXh0KHRoaXMuY2FsbEFjdGl2aXR5U3ViUHJvY2Vzcy5iaXpEYXRhSWQpO1xyXG4gICAgdGhpcy5leHByLmJ1aWxkRXhwcmVzc2lvbigpLnRoZW4oKGV4cHJlc3Npb25pbmZvOiBzdHJpbmcpID0+IHtcclxuICAgICAgdGhpcy5jYWxsQWN0aXZpdHlTdWJQcm9jZXNzLmJpekRhdGFJZCA9IGV4cHJlc3Npb25pbmZvO1xyXG4gICAgICAvL+eCueWHu+ehruWumuWQju+8jOWOu+mZpOihqOi+vuW8j+mHjOmdoueahOaWsOWinueahOS4iuS4i+aWh+WPmOmHj1xyXG4gICAgICBpZihjb250ZXh0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgICB0aGlzLmV4cHIuZXhwckVudGl0eS5jb250ZXh0RW50aXRpZXMgPSB0aGlzLmV4cHIuZXhwckVudGl0eS5jb250ZXh0RW50aXRpZXMuZmlsdGVyKHggPT4gIWNvbnRleHQuc29tZSh5ID0+IHkua2V5ID09PSB4LmtleSkpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHZhbHVlQ2hhbmdlKGJvb2w6IGJvb2xlYW4pIHtcclxuICAgIGlmIChib29sKSB7XHJcbiAgICAgIHRoaXMuY2FsbEFjdGl2aXR5U3ViUHJvY2Vzcy5iaXpEYXRhSWQgPSBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB2YWxpZGF0b3IoKTogYm9vbGVhbiB7XHJcbiAgICBpZiAoIXRoaXMuY2FsbEFjdGl2aXR5U3ViUHJvY2Vzcy5pbmhlcml0Qml6RGF0YUlkICYmICF0aGlzLmNhbGxBY3Rpdml0eVN1YlByb2Nlc3MuYml6RGF0YUlkKSB7XHJcbiAgICAgIHRoaXMubWVzc2FnZS53YXJuaW5nKHRoaXMubG9jYWxlUGlwZS50cmFuc2Zvcm0oXCJjb21wb25lbnQuc3ViUHJvY2Vzcy5pbmhlcml0Qml6RGF0YUlkXCIpKTtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldFByb2Nlc3NEZWZLZXkoa2V5OiBzdHJpbmcpe1xyXG4gICAgbGV0IHVybCA9IHRoaXMudXRpbC5nZXRQcm9jZXNzRGVmaW5pdGlvbldlYkFwaSgpO1xyXG4gICAgaWYgKGtleSkge1xyXG4gICAgICB1cmwgKz0gYC9wcm9jRGVmS2V5LyR7a2V5fWA7XHJcbiAgICAgIHRoaXMuaHR0cC5nZXQodXJsKS5zdWJzY3JpYmUoKHJlOiBhbnkpID0+IHtcclxuICAgICAgICB0aGlzLmNhbGxBY3Rpdml0eVN1YlByb2Nlc3MuY2FsbGVkRWxlbWVudE5hbWUgPSByZS5uYW1lO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRGbG93Rm9ybShpZDogc3RyaW5nKSB7XHJcbiAgICBsZXQgdXJsID0gdGhpcy51dGlsLmdldEZsb3dGb3JtV2ViQXBpKCk7XHJcbiAgICBpZiAoaWQpIHtcclxuICAgICAgdXJsICs9IGAvJHtpZH1gO1xyXG4gICAgICB0aGlzLmh0dHAuZ2V0KHVybCkuc3Vic2NyaWJlKChyZTogYW55KSA9PiB7XHJcbiAgICAgICAgdGhpcy5jYWxsQWN0aXZpdHlTdWJQcm9jZXNzLmNhbGxlZEJpekRlZk5hbWUgPSByZS5uYW1lO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcblxyXG5leHBvcnQgY2xhc3MgQ2FsbEFjdGl2aXR5U3ViUHJvY2Vzc0NvbnZlcnRlciBpbXBsZW1lbnRzIFR5cGVDb252ZXJ0ZXIge1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBsb2NhbGVQaXBlOiBXZkxvY2FsZVBpcGVcclxuICApIHsgfVxyXG5cclxuICBjb252ZXJ0VG8oZGF0YTogYW55KTogc3RyaW5nIHtcclxuICAgIGlmIChkYXRhICYmIChkYXRhLmNhbGxlZEJpekRlZktleSB8fCBkYXRhLmNhbGxlZEVsZW1lbnQpKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmxvY2FsZVBpcGUudHJhbnNmb3JtKFwiY29tcG9uZW50LnN1YlByb2Nlc3Muc2V0XCIpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMubG9jYWxlUGlwZS50cmFuc2Zvcm0oXCJjb21wb25lbnQuc3ViUHJvY2Vzcy5ub3RTZXRcIik7XHJcbiAgfVxyXG59XHJcbiJdfQ==