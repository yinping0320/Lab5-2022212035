/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChangeDetectorRef, Component, Inject, Input, LOCALE_ID, Optional, ViewChild } from '@angular/core';
import { DatagridComponent } from '@farris/ui-datagrid';
import { EditorTypes } from '@farris/ui-datagrid-editors';
import { MessagerService } from '@farris/ui-messager';
import { ExprEditMode, ExpressionService, InjectedType } from '@gsp-svc/expression';
import { ProcessDesignerUIState } from '../../app/process-designer.uistate';
import { SmsMessageTemplate, SmsMessageVariable } from './sms-message-template';
import { WF_LANG_RESOURCES, WfLocalePipe } from '../../i18n/pipe/wf-process-editor-locale.pipe';
export class SmsMessageTemplateComponent {
    /**
     * @param {?} designerState
     * @param {?} expr
     * @param {?} message
     * @param {?} cdr
     * @param {?} localeId
     * @param {?} resources
     * @param {?} localePipe
     */
    constructor(designerState, expr, message, cdr, localeId, resources, localePipe) {
        this.designerState = designerState;
        this.expr = expr;
        this.message = message;
        this.cdr = cdr;
        this.localeId = localeId;
        this.resources = resources;
        this.localePipe = localePipe;
        this.smsVariableList = new Array();
        this.smsVariableCols = new Array();
        this.smsTemplateContent = this.localePipe.transform('component.smsMessageTemplate.smsTemplateContent');
        this.localePipe = this.localePipe || new WfLocalePipe(localeId, resources);
        this.smsMessageTemplate = new SmsMessageTemplate();
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.smsVariableCols = [{
                field: 'code', width: 80, title: this.localePipe.transform('component.smsMessageTemplate.code'), editor: { type: EditorTypes.TEXTBOX, options: {} }
            }, {
                field: 'value', width: 100, title: this.localePipe.transform('component.smsMessageTemplate.value'), showTips: true, editor: {
                    type: 'input-group',
                    options: {
                        groupText: '<i class="f-icon f-icon-lookup"></i>',
                        editable: false,
                        clickHandle: (/**
                         * @param {?} e
                         * @return {?}
                         */
                        (e) => {
                            e.formControl.setValue(e.instance.value ? e.instance.value : '');
                            this.showExprHelp(e);
                        }),
                        clear: (/**
                         * @param {?} e
                         * @return {?}
                         */
                        (e) => {
                            console.log('clear', e);
                        })
                    }
                }
            }];
        console.log(this.smsMessageTemplate);
    }
    /**
     * @return {?}
     */
    addSmsVariable() {
        /** @type {?} */
        const variable = new SmsMessageVariable();
        this.smsMessageTemplate.smsMessageVariables.push(variable);
        this.grid.loadData(this.smsMessageTemplate.smsMessageVariables);
    }
    /**
     * @return {?}
     */
    deleteSmsVariable() {
        this.endGridEdit();
        /** @type {?} */
        const selectedVariable = this.grid.selectedRow;
        if (!selectedVariable) {
            this.message.info(this.localePipe.transform('component.smsMessageTemplate.noRowsSelected'));
            return;
        }
        /** @type {?} */
        const index = this.smsMessageTemplate.smsMessageVariables.findIndex((/**
         * @param {?} variable
         * @return {?}
         */
        variable => variable.id === selectedVariable.id));
        if (index > -1) {
            this.smsMessageTemplate.smsMessageVariables.splice(index, 1);
            this.grid.loadData(this.smsMessageTemplate.smsMessageVariables);
        }
    }
    /**
     * @return {?}
     */
    endGridEdit() {
        this.grid.endCellEdit();
    }
    /**
     * @private
     * @param {?} e
     * @return {?}
     */
    showExprHelp(e) {
        // this.expr.clearContext();
        if (this.designerState.schemas.length > 0) {
            for (const schema of this.designerState.schemas) {
                this.expr.addSchema('Schema', schema);
            }
            if (this.designerState.schemas[0].entityTypes && this.designerState.schemas[0].entityTypes.length > 0) {
                /** @type {?} */
                const entityType = this.designerState.schemas[0].entityTypes[0];
                this.expr.addInjectedEntity(entityType.name, 'Schema', entityType.name, InjectedType.EntityType);
            }
        }
        /** @type {?} */
        let context = new Array();
        context = this.designerState.addContext(context);
        if (this.designerState.subActivityContext.length > 0) {
            for (const variable of this.designerState.subActivityContext) {
                if (!context.some((/**
                 * @param {?} c
                 * @return {?}
                 */
                c => c.key === variable.key))) {
                    context.push(variable);
                }
            }
        }
        if (context.length > 0) {
            for (const v of context) {
                this.expr.addContext(v);
            }
        }
        this.expr.setEditPattern(ExprEditMode.Advanced); // 默认打开高级表达式编辑器
        this.expr.addExpressionText(e.instance.value);
        this.expr.buildExpression().then((/**
         * @param {?} expressioninfo
         * @return {?}
         */
        (expressioninfo) => {
            e.formControl.setValue(expressioninfo);
            e.instance.cd.detectChanges();
            //点击确定后，去除表达式里面的新增的上下文变量
            if (context.length > 0) {
                this.expr.exprEntity.contextEntities = this.expr.exprEntity.contextEntities.filter((/**
                 * @param {?} x
                 * @return {?}
                 */
                x => !context.some((/**
                 * @param {?} y
                 * @return {?}
                 */
                y => y.key === x.key))));
            }
        }));
    }
}
SmsMessageTemplateComponent.decorators = [
    { type: Component, args: [{
                selector: 'lib-sms-message-template',
                template: "<div class=\"w-100\">\r\n  <farris-section class=\"py-0 \" [enableAccordion]=\"''\" [enableMaximize]=\"false\">\r\n    <ng-template farrisSectionHeader>\r\n      <div class=\"f-title\">\r\n        <h4 class=\"f-title-text\">{{'component.smsMessageTemplate.smsMessageTemplate'|wfLocale}}</h4>\r\n        <span farrisPopover class=\"f-icon f-icon-message_help\" style=\"color:#FBB902\" [container]=\"'body'\"\r\n          [triggers]=\"'hover'\" [placement]=\"'right'\" [popover]=\"poptmpl\">\r\n        </span>\r\n        <ng-template #poptmpl let-infos>\r\n          <div style=\"padding:10px 10px 10px 10px;font-size: 12px;color: black;width: 260px;\">\r\n            <h4 style=\"font-weight: 600;font-size: 16px;color: saddlebrown;\">{{'component.smsMessageTemplate.smsMessageTemplate'|wfLocale}}</h4>\r\n            <p style=\"margin: 0 0 10px;\">{{'component.smsMessageTemplate.tips1'|wfLocale}}</p>\r\n            <h4 style=\"font-weight: 600;font-size: 16px;color: saddlebrown;\">{{'component.smsMessageTemplate.smsTemplateNumber'|wfLocale}}</h4>\r\n            <p style=\"margin: 0 0 10px;\">{{'component.smsMessageTemplate.tips2'|wfLocale}}</p>\r\n            <!-- <h4 style=\"font-weight: 600;font-size: 16px;color: saddlebrown;\">\u77ED\u4FE1\u6A21\u677F\u5185\u5BB9</h4>\r\n            <p style=\"margin: 0 0 10px;\">{{smsTemplateContent}}</p> -->\r\n            <h4 style=\"font-weight: 600;font-size: 16px;color: saddlebrown;\">{{'component.smsMessageTemplate.smsVariableBinding'|wfLocale}}</h4>\r\n            <p style=\"margin: 0 0 10px;\">{{'component.smsMessageTemplate.tips3'|wfLocale}}</p>\r\n          </div>\r\n        </ng-template>\r\n      </div>\r\n    </ng-template>\r\n    <div class=\"f-form-layout farris-form  farris-form-controls-inline f-form-lable-auto farris-form-auto\">\r\n      <div class=\"col-12\">\r\n        <div class=\"farris-group-wrap\">\r\n          <div class=\"form-group farris-form-group\">\r\n            <label class=\"col-form-label\">\r\n              <span class=\"farris-label-info text-danger\">*</span>\r\n              <span class=\"farris-label-text\">{{'component.smsMessageTemplate.smsTemplateNumber'|wfLocale}}</span>\r\n            </label>\r\n            <div class=\"farris-input-wrap ml-1\">\r\n              <input [(ngModel)]=\"smsMessageTemplate.code\" class=\"form-control\" name=\"tempCode\" type=\"text\">\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      <!-- <div class=\"col-12\">\r\n        <div class=\"farris-group-wrap\">\r\n          <div class=\"form-group farris-form-group\">\r\n            <label class=\"col-form-label\">\r\n              <span class=\"farris-label-info text-danger\" style=\"visibility: hidden;\">*</span>\r\n              <span class=\"farris-label-text\">\u77ED\u4FE1\u6A21\u677F\u5185\u5BB9</span>\r\n            </label>\r\n            <div class=\"farris-input-wrap ml-1\">\r\n              <textarea [(ngModel)]=\"smsMessageTemplate.content\"  class=\"form-control \" cols=\"10\" id=\"textobj\" name=\"tempText\" rows=\"3\"> </textarea>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div> -->\r\n    </div>\r\n  </farris-section>\r\n</div>\r\n<div class=\"w-100\">\r\n  <farris-section class=\"pt-0 f-section-grid f-section-in-managelist\"\r\n    enableAccordion=\"{{'component.smsMessageTemplate.smsTemplateNumber'|wfLocale}}\" [enableMaximize]=\"false\" [mainTitle]=\"''\">\r\n    <!-- <ng-template farrisSectionTitle>\r\n      <div class=\"farris-label-text\">\u77ED\u4FE1\u53D8\u91CF\u7ED1\u5B9A</div>\r\n    </ng-template> -->\r\n    <ng-template farrisSectionToolbar>\r\n      <farris-button [type]=\"'link'\" (click)=\"addSmsVariable()\">\r\n        <span class=\"f-icon f-icon-add\"></span>\r\n        {{'component.smsMessageTemplate.addSmsVariable'|wfLocale}}</farris-button>\r\n      <farris-button [type]=\"'link'\" (click)=\"deleteSmsVariable()\">\r\n        <span class=\"f-icon f-icon-delete\"></span>\r\n        {{'component.smsMessageTemplate.deleteSmsVariable'|wfLocale}}</farris-button>\r\n    </ng-template>\r\n    <div style=\"height: 180px\">\r\n      <farris-datagrid #grid [data]=\"smsMessageTemplate.smsMessageVariables\" [idField]=\"'id'\" [columns]=\"smsVariableCols\"\r\n        [fit]=\"true\" [fitColumns]=\"true\" [editable]=\"true\" [editMode]=\"'cell'\" [pagination]=\"false\"\r\n        [showLineNumber]=\"true\" [showCheckbox]=\"false\" [multiSelect]=\"false\">\r\n      </farris-datagrid>\r\n    </div>\r\n  </farris-section>\r\n</div>\r\n",
                providers: [
                    WfLocalePipe,
                ],
                styles: [""]
            }] }
];
/** @nocollapse */
SmsMessageTemplateComponent.ctorParameters = () => [
    { type: ProcessDesignerUIState },
    { type: ExpressionService },
    { type: MessagerService },
    { type: ChangeDetectorRef, decorators: [{ type: Optional }] },
    { type: String, decorators: [{ type: Inject, args: [LOCALE_ID,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [WF_LANG_RESOURCES,] }] },
    { type: WfLocalePipe, decorators: [{ type: Optional }] }
];
SmsMessageTemplateComponent.propDecorators = {
    grid: [{ type: ViewChild, args: ['grid',] }],
    smsMessageTemplate: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    SmsMessageTemplateComponent.prototype.grid;
    /** @type {?} */
    SmsMessageTemplateComponent.prototype.smsVariableList;
    /** @type {?} */
    SmsMessageTemplateComponent.prototype.smsVariableCols;
    /** @type {?} */
    SmsMessageTemplateComponent.prototype.smsTemplateContent;
    /** @type {?} */
    SmsMessageTemplateComponent.prototype.smsMessageTemplate;
    /**
     * @type {?}
     * @private
     */
    SmsMessageTemplateComponent.prototype.designerState;
    /**
     * @type {?}
     * @private
     */
    SmsMessageTemplateComponent.prototype.expr;
    /**
     * @type {?}
     * @private
     */
    SmsMessageTemplateComponent.prototype.message;
    /**
     * @type {?}
     * @private
     */
    SmsMessageTemplateComponent.prototype.cdr;
    /**
     * @type {?}
     * @private
     */
    SmsMessageTemplateComponent.prototype.localeId;
    /**
     * @type {?}
     * @private
     */
    SmsMessageTemplateComponent.prototype.resources;
    /**
     * @type {?}
     * @private
     */
    SmsMessageTemplateComponent.prototype.localePipe;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic21zLW1lc3NhZ2UtdGVtcGxhdGUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGdzcC13Zi93Zi1wcm9jZXNzLWVkaXRvci8iLCJzb3VyY2VzIjpbImxpYi92aWV3cy9zbXMtbWVzc2FnZS10ZW1wbGF0ZS9zbXMtbWVzc2FnZS10ZW1wbGF0ZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQVUsUUFBUSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNwSCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxZQUFZLEVBQUUsaUJBQWlCLEVBQUUsWUFBWSxFQUFhLE1BQU0scUJBQXFCLENBQUM7QUFDL0YsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDNUUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDaEYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFlBQVksRUFBRSxNQUFNLCtDQUErQyxDQUFDO0FBV2hHLE1BQU0sT0FBTywyQkFBMkI7Ozs7Ozs7Ozs7SUFXdEMsWUFDVSxhQUFxQyxFQUNyQyxJQUF1QixFQUN2QixPQUF3QixFQUNaLEdBQXNCLEVBQ2YsUUFBZ0IsRUFDUixTQUFjLEVBQzdCLFVBQXdCO1FBTnBDLGtCQUFhLEdBQWIsYUFBYSxDQUF3QjtRQUNyQyxTQUFJLEdBQUosSUFBSSxDQUFtQjtRQUN2QixZQUFPLEdBQVAsT0FBTyxDQUFpQjtRQUNaLFFBQUcsR0FBSCxHQUFHLENBQW1CO1FBQ2YsYUFBUSxH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LEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJOzs7O2dCQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFDLEVBQUMsQ0FBQzthQUM5SDtRQUNILENBQUMsRUFBQyxDQUFDO0lBQ0wsQ0FBQzs7O1lBbEhGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsMEJBQTBCO2dCQUNwQyx5OElBQW9EO2dCQUVwRCxTQUFTLEVBQUU7b0JBQ1IsWUFBWTtpQkFDZDs7YUFDRjs7OztZQVpRLHNCQUFzQjtZQURSLGlCQUFpQjtZQUQvQixlQUFlO1lBSGYsaUJBQWlCLHVCQWlDckIsUUFBUTt5Q0FDUixNQUFNLFNBQUMsU0FBUzs0Q0FDaEIsTUFBTSxTQUFDLGlCQUFpQjtZQTVCRCxZQUFZLHVCQTZCbkMsUUFBUTs7O21CQWhCVixTQUFTLFNBQUMsTUFBTTtpQ0FNaEIsS0FBSzs7OztJQU5OLDJDQUEyQzs7SUFFM0Msc0RBQThCOztJQUM5QixzREFBOEI7O0lBQzlCLHlEQUFpRzs7SUFFakcseURBQ3VDOzs7OztJQUdyQyxvREFBNkM7Ozs7O0lBQzdDLDJDQUErQjs7Ozs7SUFDL0IsOENBQWdDOzs7OztJQUNoQywwQ0FBMEM7Ozs7O0lBQzFDLCtDQUEyQzs7Ozs7SUFDM0MsZ0RBQWlEOzs7OztJQUNqRCxpREFBNEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGFuZ2VEZXRlY3RvclJlZiwgQ29tcG9uZW50LCBJbmplY3QsIElucHV0LCBMT0NBTEVfSUQsIE9uSW5pdCwgT3B0aW9uYWwsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBEYXRhZ3JpZENvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YWdyaWQnO1xyXG5pbXBvcnQgeyBFZGl0b3JUeXBlcyB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YWdyaWQtZWRpdG9ycyc7XHJcbmltcG9ydCB7IE1lc3NhZ2VyU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbWVzc2FnZXInO1xyXG5pbXBvcnQgeyBFeHByRWRpdE1vZGUsIEV4cHJlc3Npb25TZXJ2aWNlLCBJbmplY3RlZFR5cGUsIFZhckVudGl0eSB9IGZyb20gJ0Bnc3Atc3ZjL2V4cHJlc3Npb24nO1xyXG5pbXBvcnQgeyBQcm9jZXNzRGVzaWduZXJVSVN0YXRlIH0gZnJvbSAnLi4vLi4vYXBwL3Byb2Nlc3MtZGVzaWduZXIudWlzdGF0ZSc7XHJcbmltcG9ydCB7IFNtc01lc3NhZ2VUZW1wbGF0ZSwgU21zTWVzc2FnZVZhcmlhYmxlIH0gZnJvbSAnLi9zbXMtbWVzc2FnZS10ZW1wbGF0ZSc7XHJcbmltcG9ydCB7IFdGX0xBTkdfUkVTT1VSQ0VTLCBXZkxvY2FsZVBpcGUgfSBmcm9tICcuLi8uLi9pMThuL3BpcGUvd2YtcHJvY2Vzcy1lZGl0b3ItbG9jYWxlLnBpcGUnO1xyXG5pbXBvcnQgeyBXRl9QUk9DRVNTX0VESVRPUl9MQU5HX1JFU09VUkNFUyB9IGZyb20gJy4uLy4uL2kxOG4vYXNzZXRzL2xhbmcucmVzb3VyY2UnO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdsaWItc21zLW1lc3NhZ2UtdGVtcGxhdGUnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9zbXMtbWVzc2FnZS10ZW1wbGF0ZS5jb21wb25lbnQuaHRtbCcsXHJcbiAgc3R5bGVVcmxzOiBbJy4vc21zLW1lc3NhZ2UtdGVtcGxhdGUuY29tcG9uZW50LnNjc3MnXSxcclxuICBwcm92aWRlcnM6IFtcclxuICAgICBXZkxvY2FsZVBpcGUsXHJcbiAgXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgU21zTWVzc2FnZVRlbXBsYXRlQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcclxuXHJcbiAgQFZpZXdDaGlsZCgnZ3JpZCcpIGdyaWQ6IERhdGFncmlkQ29tcG9uZW50O1xyXG5cclxuICBzbXNWYXJpYWJsZUxpc3QgPSBuZXcgQXJyYXkoKTtcclxuICBzbXNWYXJpYWJsZUNvbHMgPSBuZXcgQXJyYXkoKTtcclxuICBzbXNUZW1wbGF0ZUNvbnRlbnQgPSB0aGlzLmxvY2FsZVBpcGUudHJhbnNmb3JtKCdjb21wb25lbnQuc21zTWVzc2FnZVRlbXBsYXRlLnNtc1RlbXBsYXRlQ29udGVudCcpXHJcblxyXG4gIEBJbnB1dCgpXHJcbiAgc21zTWVzc2FnZVRlbXBsYXRlOiBTbXNNZXNzYWdlVGVtcGxhdGU7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBkZXNpZ25lclN0YXRlOiBQcm9jZXNzRGVzaWduZXJVSVN0YXRlLFxyXG4gICAgcHJpdmF0ZSBleHByOiBFeHByZXNzaW9uU2VydmljZSxcclxuICAgIHByaXZhdGUgbWVzc2FnZTogTWVzc2FnZXJTZXJ2aWNlLFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBjZHI6IENoYW5nZURldGVjdG9yUmVmLFxyXG4gICAgQEluamVjdChMT0NBTEVfSUQpIHByaXZhdGUgbG9jYWxlSWQ6IHN0cmluZyxcclxuICAgIEBJbmplY3QoV0ZfTEFOR19SRVNPVVJDRVMpIHByaXZhdGUgcmVzb3VyY2VzOiBhbnksXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGxvY2FsZVBpcGU6IFdmTG9jYWxlUGlwZSxcclxuICApIHtcclxuICAgIHRoaXMubG9jYWxlUGlwZSA9IHRoaXMubG9jYWxlUGlwZSB8fCBuZXcgV2ZMb2NhbGVQaXBlKGxvY2FsZUlkLCByZXNvdXJjZXMpO1xyXG4gICAgdGhpcy5zbXNNZXNzYWdlVGVtcGxhdGUgPSBuZXcgU21zTWVzc2FnZVRlbXBsYXRlKCk7XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIHRoaXMuc21zVmFyaWFibGVDb2xzPVt7XHJcbiAgICAgIGZpZWxkOiAnY29kZScsIHdpZHRoOiA4MCwgdGl0bGU6IHRoaXMubG9jYWxlUGlwZS50cmFuc2Zvcm0oJ2NvbXBvbmVudC5zbXNNZXNzYWdlVGVtcGxhdGUuY29kZScpLCBlZGl0b3I6IHsgdHlwZTogRWRpdG9yVHlwZXMuVEVYVEJPWCwgb3B0aW9uczoge30gfVxyXG4gICAgfSwge1xyXG4gICAgICBmaWVsZDogJ3ZhbHVlJywgd2lkdGg6IDEwMCwgdGl0bGU6IHRoaXMubG9jYWxlUGlwZS50cmFuc2Zvcm0oJ2NvbXBvbmVudC5zbXNNZXNzYWdlVGVtcGxhdGUudmFsdWUnKSwgc2hvd1RpcHM6IHRydWUsZWRpdG9yOiB7XHJcbiAgICAgICAgdHlwZTogJ2lucHV0LWdyb3VwJyxcclxuICAgICAgICBvcHRpb25zOiB7XHJcbiAgICAgICAgICBncm91cFRleHQ6ICc8aSBjbGFzcz1cImYtaWNvbiBmLWljb24tbG9va3VwXCI+PC9pPicsXHJcbiAgICAgICAgICBlZGl0YWJsZTogZmFsc2UsXHJcbiAgICAgICAgICBjbGlja0hhbmRsZTogKGUpID0+IHtcclxuICAgICAgICAgICAgZS5mb3JtQ29udHJvbC5zZXRWYWx1ZShlLmluc3RhbmNlLnZhbHVlID8gZS5pbnN0YW5jZS52YWx1ZSA6ICcnKTtcclxuICAgICAgICAgICAgdGhpcy5zaG93RXhwckhlbHAoZSk7XHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgY2xlYXI6IChlKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdjbGVhcicsIGUpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICB9XVxyXG4gICAgY29uc29sZS5sb2codGhpcy5zbXNNZXNzYWdlVGVtcGxhdGUpO1xyXG4gIH1cclxuXHJcbiAgYWRkU21zVmFyaWFibGUoKSB7XHJcbiAgICBjb25zdCB2YXJpYWJsZSA9IG5ldyBTbXNNZXNzYWdlVmFyaWFibGUoKTtcclxuICAgIHRoaXMuc21zTWVzc2FnZVRlbXBsYXRlLnNtc01lc3NhZ2VWYXJpYWJsZXMucHVzaCh2YXJpYWJsZSk7XHJcbiAgICB0aGlzLmdyaWQubG9hZERhdGEodGhpcy5zbXNNZXNzYWdlVGVtcGxhdGUuc21zTWVzc2FnZVZhcmlhYmxlcyk7XHJcbiAgfVxyXG5cclxuICBkZWxldGVTbXNWYXJpYWJsZSgpIHtcclxuICAgIHRoaXMuZW5kR3JpZEVkaXQoKTtcclxuICAgIGNvbnN0IHNlbGVjdGVkVmFyaWFibGUgPSB0aGlzLmdyaWQuc2VsZWN0ZWRSb3c7XHJcbiAgICBpZiAoIXNlbGVjdGVkVmFyaWFibGUpIHtcclxuICAgICAgdGhpcy5tZXNzYWdlLmluZm8odGhpcy5sb2NhbGVQaXBlLnRyYW5zZm9ybSgnY29tcG9uZW50LnNtc01lc3NhZ2VUZW1wbGF0ZS5ub1Jvd3NTZWxlY3RlZCcpKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgaW5kZXggPSB0aGlzLnNtc01lc3NhZ2VUZW1wbGF0ZS5zbXNNZXNzYWdlVmFyaWFibGVzLmZpbmRJbmRleCh2YXJpYWJsZSA9PiB2YXJpYWJsZS5pZCA9PT0gc2VsZWN0ZWRWYXJpYWJsZS5pZCk7XHJcbiAgICBpZiAoaW5kZXggPiAtMSkge1xyXG4gICAgICB0aGlzLnNtc01lc3NhZ2VUZW1wbGF0ZS5zbXNNZXNzYWdlVmFyaWFibGVzLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgIHRoaXMuZ3JpZC5sb2FkRGF0YSh0aGlzLnNtc01lc3NhZ2VUZW1wbGF0ZS5zbXNNZXNzYWdlVmFyaWFibGVzKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGVuZEdyaWRFZGl0KCkge1xyXG4gICAgdGhpcy5ncmlkLmVuZENlbGxFZGl0KCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNob3dFeHBySGVscChlOiBhbnkpIHtcclxuICAgIC8vIHRoaXMuZXhwci5jbGVhckNvbnRleHQoKTtcclxuICAgIGlmICh0aGlzLmRlc2lnbmVyU3RhdGUuc2NoZW1hcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGZvciAoY29uc3Qgc2NoZW1hIG9mIHRoaXMuZGVzaWduZXJTdGF0ZS5zY2hlbWFzKSB7XHJcbiAgICAgICAgdGhpcy5leHByLmFkZFNjaGVtYSgnU2NoZW1hJywgc2NoZW1hKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAodGhpcy5kZXNpZ25lclN0YXRlLnNjaGVtYXNbMF0uZW50aXR5VHlwZXMgJiYgdGhpcy5kZXNpZ25lclN0YXRlLnNjaGVtYXNbMF0uZW50aXR5VHlwZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGNvbnN0IGVudGl0eVR5cGUgPSB0aGlzLmRlc2lnbmVyU3RhdGUuc2NoZW1hc1swXS5lbnRpdHlUeXBlc1swXTtcclxuICAgICAgICB0aGlzLmV4cHIuYWRkSW5qZWN0ZWRFbnRpdHkoZW50aXR5VHlwZS5uYW1lLCAnU2NoZW1hJyxcclxuICAgICAgICAgIGVudGl0eVR5cGUubmFtZSwgSW5qZWN0ZWRUeXBlLkVudGl0eVR5cGUpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBsZXQgY29udGV4dCA9IG5ldyBBcnJheTxWYXJFbnRpdHk+KCk7XHJcbiAgICBjb250ZXh0ID0gdGhpcy5kZXNpZ25lclN0YXRlLmFkZENvbnRleHQoY29udGV4dCk7XHJcbiAgICBpZiAodGhpcy5kZXNpZ25lclN0YXRlLnN1YkFjdGl2aXR5Q29udGV4dC5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGZvciAoY29uc3QgdmFyaWFibGUgb2YgdGhpcy5kZXNpZ25lclN0YXRlLnN1YkFjdGl2aXR5Q29udGV4dCkge1xyXG4gICAgICAgIGlmICghY29udGV4dC5zb21lKGMgPT4gYy5rZXkgPT09IHZhcmlhYmxlLmtleSkpIHtcclxuICAgICAgICAgIGNvbnRleHQucHVzaCh2YXJpYWJsZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBpZiAoY29udGV4dC5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGZvciAoY29uc3QgdiBvZiBjb250ZXh0KSB7XHJcbiAgICAgICAgdGhpcy5leHByLmFkZENvbnRleHQodik7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHRoaXMuZXhwci5zZXRFZGl0UGF0dGVybihFeHByRWRpdE1vZGUuQWR2YW5jZWQpOyAvLyDpu5jorqTmiZPlvIDpq5jnuqfooajovr7lvI/nvJbovpHlmahcclxuICAgIHRoaXMuZXhwci5hZGRFeHByZXNzaW9uVGV4dChlLmluc3RhbmNlLnZhbHVlKTtcclxuICAgIHRoaXMuZXhwci5idWlsZEV4cHJlc3Npb24oKS50aGVuKChleHByZXNzaW9uaW5mbzogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGUuZm9ybUNvbnRyb2wuc2V0VmFsdWUoZXhwcmVzc2lvbmluZm8pO1xyXG4gICAgICBlLmluc3RhbmNlLmNkLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgLy/ngrnlh7vnoa7lrprlkI7vvIzljrvpmaTooajovr7lvI/ph4zpnaLnmoTmlrDlop7nmoTkuIrkuIvmloflj5jph49cclxuICAgICAgaWYoY29udGV4dC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgdGhpcy5leHByLmV4cHJFbnRpdHkuY29udGV4dEVudGl0aWVzID0gdGhpcy5leHByLmV4cHJFbnRpdHkuY29udGV4dEVudGl0aWVzLmZpbHRlcih4ID0+ICFjb250ZXh0LnNvbWUoeSA9PiB5LmtleSA9PT0geC5rZXkpKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuXHJcblxyXG59XHJcbiJdfQ==