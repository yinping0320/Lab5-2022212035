/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { NodeCell, ElementPropertyConfig } from "@edp-pmf/grapheditor";
import { Signal } from "@edp-pmf/bpmn-model";
import { mxResources } from "@edp-pmf/mxgraph-ts";
import { IntermediateCatchEventImpl, Component, BackWardRule, ActualParameter, VariableSetting, SignalEventDefinitionImpl } from "@gsp-wf/wf-process-model";
import { PropertyHelper } from "./PropertyHelper";
import { BpmnModelHelper, FlowNodeState } from "@edp-pmf/bpmn-model";
import { WfConstants } from "../WfConstants";
import { IntermediateCatchEventImplPropertyKeys } from "./property-keys/IntermediateCatchEventImplPropertyKeys";
/**
 * 信号捕获活动节点
 */
export class IntermediateCatchEventImplCell extends NodeCell {
    /**
     * @param {?=} value
     * @param {?=} geometry
     * @param {?=} style
     */
    constructor(value, geometry, style) {
        super(value, geometry, style);
        this.clrTypeId = IntermediateCatchEventImplCell.CLR_TYPE_ID;
        this.name = "信号捕获";
        this.nameLanguage = {
            "zh-CHS": "信号捕获",
            "zh-CHT": "訊號捕獲",
            "en": "Acquisition",
        };
        this.imgUrls = {
            [FlowNodeState.Default]: WfConstants.IMAGE_PATH + "/catchEvent.png",
            [FlowNodeState.Selected]: WfConstants.IMAGE_PATH + "/catchEvent_select.svg",
        };
    }
    /**
     * @param {?=} flowElt
     * @return {?}
     */
    createFlowElement(flowElt) {
        /** @type {?} */
        const flowNode = (/** @type {?} */ (super.createFlowElement(flowElt)));
        flowNode.Id = "IntermediateCatchEvent" + BpmnModelHelper.GenerateElementId();
        // 创建而非复制时执行
        if (flowElt == null) {
            flowNode.initEventDefinitions();
        }
        return flowNode;
    }
    /**
     * @param {?=} flowElt
     * @param {?=} diagElt
     * @return {?}
     */
    bindBpmnModel(flowElt, diagElt) {
        super.bindBpmnModel(flowElt, diagElt);
        /** @type {?} */
        const bpmnModel = this.editorUi.graph.bpmnModel;
        this.addSignals(this.flowElement);
    }
    /**
     * @param {?} catchEvent
     * @return {?}
     */
    addSignals(catchEvent) {
        /** @type {?} */
        const bpmnModel = catchEvent.Model;
        if (catchEvent.EventDefinitions && catchEvent.EventDefinitions.length > 0) {
            if (!bpmnModel.signals) {
                bpmnModel.signals = [];
            }
            for (const e of catchEvent.EventDefinitions) {
                /** @type {?} */
                const event = (/** @type {?} */ (e));
                if (bpmnModel.signals.findIndex((/**
                 * @param {?} s
                 * @return {?}
                 */
                s => s.Name === event.SignalRef)) === -1) {
                    /** @type {?} */
                    const signal = new Signal(bpmnModel);
                    signal.Name = event.SignalRef;
                    bpmnModel.signals.push(signal);
                }
            }
        }
    }
    /**
     * @return {?}
     */
    getFarrisPropConfig() {
        /** @type {?} */
        let act = this.flowElement;
        /** @type {?} */
        let basicProperty = new ElementPropertyConfig();
        /** @type {?} */
        let activityProperty = new ElementPropertyConfig();
        /** @type {?} */
        let propertyData = {};
        basicProperty.categoryId = 'basicProperty';
        basicProperty.categoryName = mxResources.get('basicInformation');
        basicProperty.tabId = 'basic';
        basicProperty.tabName = mxResources.get('basicAttributes');
        basicProperty.properties = [
            { propertyID: IntermediateCatchEventImplPropertyKeys.Name, propertyName: mxResources.get('name'), propertyType: 'string', visible: !this.editorUi.multiLangEnabled },
            { propertyID: IntermediateCatchEventImplPropertyKeys.NameLanguage, propertyName: mxResources.get('nameLanguage'), propertyType: 'multiLanguage', visible: this.editorUi.multiLangEnabled },
            { propertyID: IntermediateCatchEventImplPropertyKeys.Id, propertyName: mxResources.get('id'), propertyType: 'string', readonly: true }
        ];
        activityProperty.categoryId = 'activityProperty';
        activityProperty.categoryName = mxResources.get('activityProperty');
        activityProperty.tabId = 'basic';
        activityProperty.tabName = mxResources.get('basicAttributes');
        activityProperty.properties = [
            { propertyID: IntermediateCatchEventImplPropertyKeys.EventDefinitions, propertyName: mxResources.get('eventDefinitions'), propertyType: 'modal' },
            { propertyID: IntermediateCatchEventImplPropertyKeys.variableSettings, propertyName: mxResources.get('variableSettings'), propertyType: 'modal' }
        ];
        if (act.EventDefinitions && this.isBackEventExist(act.EventDefinitions)) {
            activityProperty.properties.push({ propertyID: IntermediateCatchEventImplPropertyKeys.BackWardRule, propertyName: mxResources.get('backWardRule'), propertyType: 'modal' });
            propertyData[IntermediateCatchEventImplPropertyKeys.BackWardRule] = act.backWardRule;
        }
        propertyData[IntermediateCatchEventImplPropertyKeys.Id] = act.Id;
        propertyData[IntermediateCatchEventImplPropertyKeys.ClrTypeID] = act.ClrTypeID;
        propertyData[IntermediateCatchEventImplPropertyKeys.Name] = act.Name;
        propertyData[IntermediateCatchEventImplPropertyKeys.NameLanguage] = act.NameLanguage || {
            "zh-CHS": act.Name,
        };
        propertyData[IntermediateCatchEventImplPropertyKeys.EventDefinitions] = act.EventDefinitions;
        propertyData[IntermediateCatchEventImplPropertyKeys.variableSettings] = PropertyHelper.getVariableSettings(act.Model, act.variableSettings);
        return {
            propertyConfig: [basicProperty, activityProperty],
            propertyData: propertyData
        };
    }
    /**
     * 判断是否存在反向事件
     * @param {?} events
     * @return {?}
     */
    isBackEventExist(events) {
        for (let e of events) {
            /** @type {?} */
            const event = (/** @type {?} */ (e));
            if (event.triggerAction === 'Back') {
                return true;
            }
        }
        return false;
    }
    /**
     * @param {?} obj
     * @return {?}
     */
    updateProps(obj) {
        /** @type {?} */
        const catchEvent = this.flowElement;
        /** @type {?} */
        const propertyId = obj.propertyID;
        switch (propertyId) {
            case IntermediateCatchEventImplPropertyKeys.EventDefinitions:
                this.updateEventDefinitions(catchEvent, obj);
                break;
            case IntermediateCatchEventImplPropertyKeys.BackWardRule:
                this.updateBackWardRule(catchEvent, obj);
                break;
            case IntermediateCatchEventImplPropertyKeys.variableSettings:
                this.updateVariableSettings(catchEvent, obj);
                break;
            default:
                super.updateProps(obj);
                break;
        }
    }
    /**
     * @param {?} catchEvent
     * @param {?} obj
     * @return {?}
     */
    updateEventDefinitions(catchEvent, obj) {
        if (catchEvent) {
            this.removeSignals(catchEvent);
            /** @type {?} */
            let events = (/** @type {?} */ (obj.propertyValue));
            catchEvent.EventDefinitions = new Array();
            for (let e of events) {
                /** @type {?} */
                let item = new SignalEventDefinitionImpl(catchEvent.Model);
                item.name = e.name;
                item.triggerAction = e.triggerAction;
                item.Async = false;
                item.SignalRef = e.SignalRef;
                catchEvent.EventDefinitions.push(item);
            }
            this.addSignals(catchEvent);
        }
        // 判断审批项是否包含驳回？不包含时，驳回规则清空
        if (!this.isBackEventExist(catchEvent.EventDefinitions)) {
            catchEvent.backWardRule = null;
        }
        else if (!catchEvent.backWardRule) {
            catchEvent.backWardRule = new BackWardRule(catchEvent.Model);
        }
        // 更新属性框
        // Utils.postMessage(ResourceKeys.wf_showProperty, this.getPropConfig());
    }
    /**
     * @param {?} catchEvent
     * @param {?} obj
     * @return {?}
     */
    updateBackWardRule(catchEvent, obj) {
        /** @type {?} */
        const data = obj.propertyValue;
        /** @type {?} */
        let backWardRule = new BackWardRule(catchEvent.Model);
        backWardRule.TargetRef = data.TargetRef;
        backWardRule.SelectTargetAble = data.SelectTargetAble;
        backWardRule.WaitReturn = data.WaitReturn;
        backWardRule.ResubmitEffect = data.ResubmitEffect;
        backWardRule.DynamicBackWardRuleAble = data.DynamicBackWardRuleAble;
        backWardRule.SelectTargetList = data.SelectTargetList;
        catchEvent.backWardRule = backWardRule;
    }
    /**
     * @param {?} catchEvent
     * @param {?} obj
     * @return {?}
     */
    updateVariableSettings(catchEvent, obj) {
        /** @type {?} */
        const bpmnModel = catchEvent.Model;
        /** @type {?} */
        const extendElements = bpmnModel.DefaultProcess.GetExtensionElements();
        if (catchEvent.variableSettings && catchEvent.variableSettings.length > 0) {
            for (const v of catchEvent.variableSettings) {
                if (v.tag === 'component') {
                    /** @type {?} */
                    const i = extendElements.findIndex((/**
                     * @param {?} e
                     * @return {?}
                     */
                    e => (e instanceof Component && e.Id === v.value)));
                    extendElements.splice(i, 1);
                }
            }
        }
        catchEvent.variableSettings = new Array();
        /** @type {?} */
        const variables = (/** @type {?} */ (obj.propertyValue));
        if (variables && variables.length > 0) {
            for (const v of variables) {
                /** @type {?} */
                const variableSetting = new VariableSetting(bpmnModel);
                // variableSetting.variableId = v.variableId;
                variableSetting.variableCode = v.variableCode;
                variableSetting.variableName = v.variableName;
                variableSetting.tag = v.tag;
                variableSetting.executionTime = v.executionTime;
                variableSetting.value = v.value;
                variableSetting.valueText = v.valueText;
                catchEvent.variableSettings.push(variableSetting);
                if (variableSetting.tag === 'component') {
                    /** @type {?} */
                    const c = v.component;
                    if (c) {
                        /** @type {?} */
                        let cpt = new Component(bpmnModel);
                        cpt.MetadataId = c.MetadataId;
                        cpt.MethodCode = c.MethodCode;
                        cpt.Id = c.Id;
                        cpt.Name = c.Name;
                        cpt.ActualParameters = new Array();
                        if (c.ActualParameters && c.ActualParameters.length > 0) {
                            for (let a of c.ActualParameters) {
                                /** @type {?} */
                                let parameter = new ActualParameter(bpmnModel, a.Name, a.Value);
                                parameter.Tag = a.Tag;
                                cpt.ActualParameters.push(parameter);
                            }
                        }
                        extendElements.push(cpt);
                    }
                }
            }
        }
    }
    /**
     * @param {?} catchEvent
     * @return {?}
     */
    removeSignals(catchEvent) {
        /** @type {?} */
        const bpmnModel = catchEvent.Model;
        if (catchEvent.EventDefinitions && catchEvent.EventDefinitions.length > 0) {
            /** @type {?} */
            const flowElements = bpmnModel.DefaultProcess.GetFlowElements();
            /** @type {?} */
            const eventDefs = new Map();
            for (const key in flowElements) {
                if (flowElements[key] instanceof IntermediateCatchEventImpl && flowElements[key].Id !== catchEvent.Id) {
                    /** @type {?} */
                    const catchEvent = (/** @type {?} */ (flowElements[key]));
                    for (const e of catchEvent.EventDefinitions) {
                        /** @type {?} */
                        const event = (/** @type {?} */ (e));
                        if (!eventDefs.get(event.SignalRef)) {
                            eventDefs.set(event.SignalRef, event);
                        }
                    }
                }
            }
            for (const e of catchEvent.EventDefinitions) {
                /** @type {?} */
                const eventDef = (/** @type {?} */ (e));
                if (!eventDefs.get(eventDef.SignalRef)) {
                    /** @type {?} */
                    const i = bpmnModel.signals.findIndex((/**
                     * @param {?} s
                     * @return {?}
                     */
                    s => s.Name === eventDef.SignalRef));
                    if (i > -1) {
                        bpmnModel.signals.splice(i, 1);
                    }
                }
            }
        }
    }
}
IntermediateCatchEventImplCell.CLR_TYPE_ID = IntermediateCatchEventImpl.Clr_Type_ID;
if (false) {
    /** @type {?} */
    IntermediateCatchEventImplCell.CLR_TYPE_ID;
    /** @type {?} */
    IntermediateCatchEventImplCell.prototype.clrTypeId;
    /** @type {?} */
    IntermediateCatchEventImplCell.prototype.name;
    /** @type {?} */
    IntermediateCatchEventImplCell.prototype.nameLanguage;
    /** @type {?} */
    IntermediateCatchEventImplCell.prototype.flowElement;
    /** @type {?} */
    IntermediateCatchEventImplCell.prototype.imgUrls;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW50ZXJtZWRpYXRlQ2F0Y2hFdmVudEltcGxDZWxsLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGdzcC13Zi93Zi1wcm9jZXNzLWVkaXRvci8iLCJzb3VyY2VzIjpbImxpYi9kZXNpZ25lci93Zi1jZWxsL0ludGVybWVkaWF0ZUNhdGNoRXZlbnRJbXBsQ2VsbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxxQkFBcUIsRUFBNEIsTUFBTSxzQkFBc0IsQ0FBQztBQUNqRyxPQUFPLEVBQUUsTUFBTSxFQUE4QixNQUFNLHFCQUFxQixDQUFDO0FBQ3pFLE9BQU8sRUFBYSxXQUFXLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxlQUFlLEVBQUUsZUFBZSxFQUFFLHlCQUF5QixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDNUosT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDckUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxzQ0FBc0MsRUFBRSxNQUFNLHdEQUF3RCxDQUFDOzs7O0FBS2hILE1BQU0sT0FBTyw4QkFBK0IsU0FBUSxRQUFROzs7Ozs7SUFnQnhELFlBQVksS0FBVyxFQUFFLFFBQStCLEVBQUUsS0FBYztRQUNwRSxLQUFLLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztRQWhCbEMsY0FBUyxHQUFXLDhCQUE4QixDQUFDLFdBQVcsQ0FBQztRQUMvRCxTQUFJLEdBQVcsTUFBTSxDQUFDO1FBQ3RCLGlCQUFZLEdBQWdDO1lBQzFDLFFBQVEsRUFBRSxNQUFNO1lBQ2hCLFFBQVEsRUFBRSxNQUFNO1lBQ2hCLElBQUksRUFBRSxhQUFhO1NB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LE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7cUJBQ2xDO2lCQUNKO2FBQ0o7U0FDSjtJQUNMLENBQUM7O0FBblBNLDBDQUFXLEdBQVcsMEJBQTBCLENBQUMsV0FBVyxDQUFDOzs7SUFBcEUsMkNBQW9FOztJQVBwRSxtREFBK0Q7O0lBQy9ELDhDQUFzQjs7SUFDdEIsc0RBSUE7O0lBRUEscURBQXdDOztJQUV4QyxpREFHRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5vZGVDZWxsLCBFbGVtZW50UHJvcGVydHlDb25maWcsIEZhcnJpc1Byb3BDb25maWdXaXRoRGF0YSB9IGZyb20gXCJAZWRwLXBtZi9ncmFwaGVkaXRvclwiO1xyXG5pbXBvcnQgeyBTaWduYWwsIEV2ZW50RGVmaW5pdGlvbiwgQlBNTlNoYXBlIH0gZnJvbSBcIkBlZHAtcG1mL2JwbW4tbW9kZWxcIjtcclxuaW1wb3J0IHsgTXhHcmFwaE5TLCBteFJlc291cmNlcyB9IGZyb20gXCJAZWRwLXBtZi9teGdyYXBoLXRzXCI7XHJcbmltcG9ydCB7IEludGVybWVkaWF0ZUNhdGNoRXZlbnRJbXBsLCBDb21wb25lbnQsIEJhY2tXYXJkUnVsZSwgQWN0dWFsUGFyYW1ldGVyLCBWYXJpYWJsZVNldHRpbmcsIFNpZ25hbEV2ZW50RGVmaW5pdGlvbkltcGwgfSBmcm9tIFwiQGdzcC13Zi93Zi1wcm9jZXNzLW1vZGVsXCI7XHJcbmltcG9ydCB7IFByb3BlcnR5SGVscGVyIH0gZnJvbSBcIi4vUHJvcGVydHlIZWxwZXJcIjtcclxuaW1wb3J0IHsgQnBtbk1vZGVsSGVscGVyLCBGbG93Tm9kZVN0YXRlIH0gZnJvbSBcIkBlZHAtcG1mL2JwbW4tbW9kZWxcIjtcclxuaW1wb3J0IHsgV2ZDb25zdGFudHMgfSBmcm9tIFwiLi4vV2ZDb25zdGFudHNcIjtcclxuaW1wb3J0IHsgSW50ZXJtZWRpYXRlQ2F0Y2hFdmVudEltcGxQcm9wZXJ0eUtleXMgfSBmcm9tIFwiLi9wcm9wZXJ0eS1rZXlzL0ludGVybWVkaWF0ZUNhdGNoRXZlbnRJbXBsUHJvcGVydHlLZXlzXCI7XHJcblxyXG4vKipcclxuICog5L+h5Y+35o2V6I635rS75Yqo6IqC54K5XHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgSW50ZXJtZWRpYXRlQ2F0Y2hFdmVudEltcGxDZWxsIGV4dGVuZHMgTm9kZUNlbGwge1xyXG4gICAgY2xyVHlwZUlkOiBzdHJpbmcgPSBJbnRlcm1lZGlhdGVDYXRjaEV2ZW50SW1wbENlbGwuQ0xSX1RZUEVfSUQ7XHJcbiAgICBuYW1lOiBzdHJpbmcgPSBcIuS/oeWPt+aNleiOt1wiO1xyXG4gICAgbmFtZUxhbmd1YWdlOiB7IFtsYW5nOiBzdHJpbmddOiBzdHJpbmc7IH0gPSB7XHJcbiAgICAgIFwiemgtQ0hTXCI6IFwi5L+h5Y+35o2V6I63XCIsXHJcbiAgICAgIFwiemgtQ0hUXCI6IFwi6KiK6Jmf5o2V542yXCIsXHJcbiAgICAgIFwiZW5cIjogXCJBY3F1aXNpdGlvblwiLFxyXG4gIH07XHJcbiAgICBzdGF0aWMgQ0xSX1RZUEVfSUQ6IHN0cmluZyA9IEludGVybWVkaWF0ZUNhdGNoRXZlbnRJbXBsLkNscl9UeXBlX0lEO1xyXG4gICAgZmxvd0VsZW1lbnQ6IEludGVybWVkaWF0ZUNhdGNoRXZlbnRJbXBsO1xyXG5cclxuICAgIGltZ1VybHMgPSB7XHJcbiAgICAgICAgW0Zsb3dOb2RlU3RhdGUuRGVmYXVsdF06IFdmQ29uc3RhbnRzLklNQUdFX1BBVEggKyBcIi9jYXRjaEV2ZW50LnBuZ1wiLFxyXG4gICAgICAgIFtGbG93Tm9kZVN0YXRlLlNlbGVjdGVkXTogV2ZDb25zdGFudHMuSU1BR0VfUEFUSCArIFwiL2NhdGNoRXZlbnRfc2VsZWN0LnN2Z1wiLFxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcih2YWx1ZT86IGFueSwgZ2VvbWV0cnk/OiBNeEdyYXBoTlMubXhHZW9tZXRyeSwgc3R5bGU/OiBzdHJpbmcpIHtcclxuICAgICAgICBzdXBlcih2YWx1ZSwgZ2VvbWV0cnksIHN0eWxlKTtcclxuICAgIH1cclxuXHJcbiAgICBjcmVhdGVGbG93RWxlbWVudChmbG93RWx0PzogSW50ZXJtZWRpYXRlQ2F0Y2hFdmVudEltcGwpIHtcclxuICAgICAgICBjb25zdCBmbG93Tm9kZSA9IHN1cGVyLmNyZWF0ZUZsb3dFbGVtZW50KGZsb3dFbHQpIGFzIEludGVybWVkaWF0ZUNhdGNoRXZlbnRJbXBsO1xyXG4gICAgICAgIGZsb3dOb2RlLklkID0gXCJJbnRlcm1lZGlhdGVDYXRjaEV2ZW50XCIgKyBCcG1uTW9kZWxIZWxwZXIuR2VuZXJhdGVFbGVtZW50SWQoKTtcclxuICAgICAgICAvLyDliJvlu7rogIzpnZ7lpI3liLbml7bmiafooYxcclxuICAgICAgICBpZiAoZmxvd0VsdCA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGZsb3dOb2RlLmluaXRFdmVudERlZmluaXRpb25zKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZmxvd05vZGU7XHJcbiAgICB9XHJcblxyXG4gICAgYmluZEJwbW5Nb2RlbChmbG93RWx0PzogSW50ZXJtZWRpYXRlQ2F0Y2hFdmVudEltcGwsIGRpYWdFbHQ/OiBCUE1OU2hhcGUpOiB2b2lkIHtcclxuICAgICAgICBzdXBlci5iaW5kQnBtbk1vZGVsKGZsb3dFbHQsIGRpYWdFbHQpO1xyXG5cclxuICAgICAgICBjb25zdCBicG1uTW9kZWwgPSB0aGlzLmVkaXRvclVpLmdyYXBoLmJwbW5Nb2RlbDtcclxuICAgICAgICB0aGlzLmFkZFNpZ25hbHModGhpcy5mbG93RWxlbWVudCk7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkU2lnbmFscyhjYXRjaEV2ZW50OiBJbnRlcm1lZGlhdGVDYXRjaEV2ZW50SW1wbCkge1xyXG4gICAgICAgIGNvbnN0IGJwbW5Nb2RlbCA9IGNhdGNoRXZlbnQuTW9kZWw7XHJcbiAgICAgICAgaWYgKGNhdGNoRXZlbnQuRXZlbnREZWZpbml0aW9ucyAmJiBjYXRjaEV2ZW50LkV2ZW50RGVmaW5pdGlvbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBpZiAoIWJwbW5Nb2RlbC5zaWduYWxzKSB7XHJcbiAgICAgICAgICAgICAgICBicG1uTW9kZWwuc2lnbmFscyA9IFtdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgZSBvZiBjYXRjaEV2ZW50LkV2ZW50RGVmaW5pdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGV2ZW50ID0gZSBhcyBTaWduYWxFdmVudERlZmluaXRpb25JbXBsO1xyXG4gICAgICAgICAgICAgICAgaWYgKGJwbW5Nb2RlbC5zaWduYWxzLmZpbmRJbmRleChzID0+IHMuTmFtZSA9PT0gZXZlbnQuU2lnbmFsUmVmKSA9PT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzaWduYWwgPSBuZXcgU2lnbmFsKGJwbW5Nb2RlbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2lnbmFsLk5hbWUgPSBldmVudC5TaWduYWxSZWY7XHJcbiAgICAgICAgICAgICAgICAgICAgYnBtbk1vZGVsLnNpZ25hbHMucHVzaChzaWduYWwpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldEZhcnJpc1Byb3BDb25maWcoKTogRmFycmlzUHJvcENvbmZpZ1dpdGhEYXRhIHtcclxuICAgICAgICBsZXQgYWN0ID0gdGhpcy5mbG93RWxlbWVudDtcclxuXHJcbiAgICAgICAgbGV0IGJhc2ljUHJvcGVydHk6IEVsZW1lbnRQcm9wZXJ0eUNvbmZpZyA9IG5ldyBFbGVtZW50UHJvcGVydHlDb25maWcoKTtcclxuICAgICAgICBsZXQgYWN0aXZpdHlQcm9wZXJ0eTogRWxlbWVudFByb3BlcnR5Q29uZmlnID0gbmV3IEVsZW1lbnRQcm9wZXJ0eUNvbmZpZygpO1xyXG4gICAgICAgIGxldCBwcm9wZXJ0eURhdGE6IGFueSA9IHt9O1xyXG5cclxuICAgICAgICBiYXNpY1Byb3BlcnR5LmNhdGVnb3J5SWQgPSAnYmFzaWNQcm9wZXJ0eSc7XHJcbiAgICAgICAgYmFzaWNQcm9wZXJ0eS5jYXRlZ29yeU5hbWUgPSBteFJlc291cmNlcy5nZXQoJ2Jhc2ljSW5mb3JtYXRpb24nKTtcclxuICAgICAgICBiYXNpY1Byb3BlcnR5LnRhYklkID0gJ2Jhc2ljJztcclxuICAgICAgICBiYXNpY1Byb3BlcnR5LnRhYk5hbWUgPSBteFJlc291cmNlcy5nZXQoJ2Jhc2ljQXR0cmlidXRlcycpO1xyXG4gICAgICAgIGJhc2ljUHJvcGVydHkucHJvcGVydGllcyA9IFtcclxuICAgICAgICAgICAgeyBwcm9wZXJ0eUlEOiBJbnRlcm1lZGlhdGVDYXRjaEV2ZW50SW1wbFByb3BlcnR5S2V5cy5OYW1lLCBwcm9wZXJ0eU5hbWU6IG14UmVzb3VyY2VzLmdldCgnbmFtZScpLCBwcm9wZXJ0eVR5cGU6ICdzdHJpbmcnLCB2aXNpYmxlOiAhdGhpcy5lZGl0b3JVaS5tdWx0aUxhbmdFbmFibGVkIH0sXHJcbiAgICAgICAgICAgIHsgcHJvcGVydHlJRDogSW50ZXJtZWRpYXRlQ2F0Y2hFdmVudEltcGxQcm9wZXJ0eUtleXMuTmFtZUxhbmd1YWdlLCBwcm9wZXJ0eU5hbWU6IG14UmVzb3VyY2VzLmdldCgnbmFtZUxhbmd1YWdlJyksIHByb3BlcnR5VHlwZTogJ211bHRpTGFuZ3VhZ2UnLCB2aXNpYmxlOiB0aGlzLmVkaXRvclVpLm11bHRpTGFuZ0VuYWJsZWQgfSxcclxuICAgICAgICAgICAgeyBwcm9wZXJ0eUlEOiBJbnRlcm1lZGlhdGVDYXRjaEV2ZW50SW1wbFByb3BlcnR5S2V5cy5JZCwgcHJvcGVydHlOYW1lOiBteFJlc291cmNlcy5nZXQoJ2lkJyksIHByb3BlcnR5VHlwZTogJ3N0cmluZycsIHJlYWRvbmx5OiB0cnVlIH1cclxuICAgICAgICBdO1xyXG5cclxuXHJcbiAgICAgICAgYWN0aXZpdHlQcm9wZXJ0eS5jYXRlZ29yeUlkID0gJ2FjdGl2aXR5UHJvcGVydHknO1xyXG4gICAgICAgIGFjdGl2aXR5UHJvcGVydHkuY2F0ZWdvcnlOYW1lID0gbXhSZXNvdXJjZXMuZ2V0KCdhY3Rpdml0eVByb3BlcnR5Jyk7XHJcbiAgICAgICAgYWN0aXZpdHlQcm9wZXJ0eS50YWJJZCA9ICdiYXNpYyc7XHJcbiAgICAgICAgYWN0aXZpdHlQcm9wZXJ0eS50YWJOYW1lID0gbXhSZXNvdXJjZXMuZ2V0KCdiYXNpY0F0dHJpYnV0ZXMnKTtcclxuICAgICAgICBhY3Rpdml0eVByb3BlcnR5LnByb3BlcnRpZXMgPSBbXHJcbiAgICAgICAgICAgIHsgcHJvcGVydHlJRDogSW50ZXJtZWRpYXRlQ2F0Y2hFdmVudEltcGxQcm9wZXJ0eUtleXMuRXZlbnREZWZpbml0aW9ucywgcHJvcGVydHlOYW1lOiBteFJlc291cmNlcy5nZXQoJ2V2ZW50RGVmaW5pdGlvbnMnKSwgcHJvcGVydHlUeXBlOiAnbW9kYWwnIH0sXHJcbiAgICAgICAgICAgIHsgcHJvcGVydHlJRDogSW50ZXJtZWRpYXRlQ2F0Y2hFdmVudEltcGxQcm9wZXJ0eUtleXMudmFyaWFibGVTZXR0aW5ncywgcHJvcGVydHlOYW1lOiBteFJlc291cmNlcy5nZXQoJ3ZhcmlhYmxlU2V0dGluZ3MnKSwgcHJvcGVydHlUeXBlOiAnbW9kYWwnIH1cclxuICAgICAgICBdO1xyXG4gICAgICAgIGlmIChhY3QuRXZlbnREZWZpbml0aW9ucyAmJiB0aGlzLmlzQmFja0V2ZW50RXhpc3QoYWN0LkV2ZW50RGVmaW5pdGlvbnMpKSB7XHJcbiAgICAgICAgICAgIGFjdGl2aXR5UHJvcGVydHkucHJvcGVydGllcy5wdXNoKFxyXG4gICAgICAgICAgICAgICAgeyBwcm9wZXJ0eUlEOiBJbnRlcm1lZGlhdGVDYXRjaEV2ZW50SW1wbFByb3BlcnR5S2V5cy5CYWNrV2FyZFJ1bGUsIHByb3BlcnR5TmFtZTogbXhSZXNvdXJjZXMuZ2V0KCdiYWNrV2FyZFJ1bGUnKSwgcHJvcGVydHlUeXBlOiAnbW9kYWwnIH1cclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgcHJvcGVydHlEYXRhW0ludGVybWVkaWF0ZUNhdGNoRXZlbnRJbXBsUHJvcGVydHlLZXlzLkJhY2tXYXJkUnVsZV0gPSBhY3QuYmFja1dhcmRSdWxlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHJvcGVydHlEYXRhW0ludGVybWVkaWF0ZUNhdGNoRXZlbnRJbXBsUHJvcGVydHlLZXlzLklkXSA9IGFjdC5JZDtcclxuICAgICAgICBwcm9wZXJ0eURhdGFbSW50ZXJtZWRpYXRlQ2F0Y2hFdmVudEltcGxQcm9wZXJ0eUtleXMuQ2xyVHlwZUlEXSA9IGFjdC5DbHJUeXBlSUQ7XHJcbiAgICAgICAgcHJvcGVydHlEYXRhW0ludGVybWVkaWF0ZUNhdGNoRXZlbnRJbXBsUHJvcGVydHlLZXlzLk5hbWVdID0gYWN0Lk5hbWU7XHJcbiAgICAgICAgcHJvcGVydHlEYXRhW0ludGVybWVkaWF0ZUNhdGNoRXZlbnRJbXBsUHJvcGVydHlLZXlzLk5hbWVMYW5ndWFnZV0gPSBhY3QuTmFtZUxhbmd1YWdlIHx8IHtcclxuICAgICAgICAgICAgXCJ6aC1DSFNcIjogYWN0Lk5hbWUsXHJcbiAgICAgICAgfTtcclxuICAgICAgICBwcm9wZXJ0eURhdGFbSW50ZXJtZWRpYXRlQ2F0Y2hFdmVudEltcGxQcm9wZXJ0eUtleXMuRXZlbnREZWZpbml0aW9uc10gPSBhY3QuRXZlbnREZWZpbml0aW9ucztcclxuICAgICAgICBwcm9wZXJ0eURhdGFbSW50ZXJtZWRpYXRlQ2F0Y2hFdmVudEltcGxQcm9wZXJ0eUtleXMudmFyaWFibGVTZXR0aW5nc10gPSBQcm9wZXJ0eUhlbHBlci5nZXRWYXJpYWJsZVNldHRpbmdzKGFjdC5Nb2RlbCwgYWN0LnZhcmlhYmxlU2V0dGluZ3MpO1xyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBwcm9wZXJ0eUNvbmZpZzogW2Jhc2ljUHJvcGVydHksIGFjdGl2aXR5UHJvcGVydHldLFxyXG4gICAgICAgICAgICBwcm9wZXJ0eURhdGE6IHByb3BlcnR5RGF0YVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWIpOaWreaYr+WQpuWtmOWcqOWPjeWQkeS6i+S7tlxyXG4gICAgICogQHBhcmFtXHJcbiAgICAgKi9cclxuICAgIGlzQmFja0V2ZW50RXhpc3QoZXZlbnRzOiBFdmVudERlZmluaXRpb25bXSkge1xyXG4gICAgICAgIGZvciAobGV0IGUgb2YgZXZlbnRzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGV2ZW50ID0gZSBhcyBTaWduYWxFdmVudERlZmluaXRpb25JbXBsO1xyXG4gICAgICAgICAgICBpZiAoZXZlbnQudHJpZ2dlckFjdGlvbiA9PT0gJ0JhY2snKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlUHJvcHMob2JqOiBhbnkpIHtcclxuICAgICAgICBjb25zdCBjYXRjaEV2ZW50ID0gdGhpcy5mbG93RWxlbWVudDtcclxuICAgICAgICBjb25zdCBwcm9wZXJ0eUlkOiBzdHJpbmcgPSBvYmoucHJvcGVydHlJRDtcclxuICAgICAgICBzd2l0Y2ggKHByb3BlcnR5SWQpIHtcclxuICAgICAgICAgICAgY2FzZSBJbnRlcm1lZGlhdGVDYXRjaEV2ZW50SW1wbFByb3BlcnR5S2V5cy5FdmVudERlZmluaXRpb25zOlxyXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVFdmVudERlZmluaXRpb25zKGNhdGNoRXZlbnQsIG9iaik7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBJbnRlcm1lZGlhdGVDYXRjaEV2ZW50SW1wbFByb3BlcnR5S2V5cy5CYWNrV2FyZFJ1bGU6XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUJhY2tXYXJkUnVsZShjYXRjaEV2ZW50LCBvYmopO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgSW50ZXJtZWRpYXRlQ2F0Y2hFdmVudEltcGxQcm9wZXJ0eUtleXMudmFyaWFibGVTZXR0aW5nczpcclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlVmFyaWFibGVTZXR0aW5ncyhjYXRjaEV2ZW50LCBvYmopO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICBzdXBlci51cGRhdGVQcm9wcyhvYmopO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZUV2ZW50RGVmaW5pdGlvbnMoY2F0Y2hFdmVudDogSW50ZXJtZWRpYXRlQ2F0Y2hFdmVudEltcGwsIG9iajogYW55KSB7XHJcbiAgICAgICAgaWYgKGNhdGNoRXZlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy5yZW1vdmVTaWduYWxzKGNhdGNoRXZlbnQpO1xyXG4gICAgICAgICAgICBsZXQgZXZlbnRzID0gb2JqLnByb3BlcnR5VmFsdWUgYXMgYW55W107XHJcbiAgICAgICAgICAgIGNhdGNoRXZlbnQuRXZlbnREZWZpbml0aW9ucyA9IG5ldyBBcnJheTxFdmVudERlZmluaXRpb24+KCk7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGUgb2YgZXZlbnRzKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgaXRlbSA9IG5ldyBTaWduYWxFdmVudERlZmluaXRpb25JbXBsKGNhdGNoRXZlbnQuTW9kZWwpO1xyXG4gICAgICAgICAgICAgICAgaXRlbS5uYW1lID0gZS5uYW1lO1xyXG4gICAgICAgICAgICAgICAgaXRlbS50cmlnZ2VyQWN0aW9uID0gZS50cmlnZ2VyQWN0aW9uXHJcbiAgICAgICAgICAgICAgICBpdGVtLkFzeW5jID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBpdGVtLlNpZ25hbFJlZiA9IGUuU2lnbmFsUmVmO1xyXG5cclxuICAgICAgICAgICAgICAgIGNhdGNoRXZlbnQuRXZlbnREZWZpbml0aW9ucy5wdXNoKGl0ZW0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuYWRkU2lnbmFscyhjYXRjaEV2ZW50KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5Yik5pat5a6h5om56aG55piv5ZCm5YyF5ZCr6amz5Zue77yf5LiN5YyF5ZCr5pe277yM6amz5Zue6KeE5YiZ5riF56m6XHJcbiAgICAgICAgaWYgKCF0aGlzLmlzQmFja0V2ZW50RXhpc3QoY2F0Y2hFdmVudC5FdmVudERlZmluaXRpb25zKSkge1xyXG4gICAgICAgICAgICBjYXRjaEV2ZW50LmJhY2tXYXJkUnVsZSA9IG51bGw7XHJcbiAgICAgICAgfSBlbHNlIGlmICghY2F0Y2hFdmVudC5iYWNrV2FyZFJ1bGUpIHtcclxuICAgICAgICAgICAgY2F0Y2hFdmVudC5iYWNrV2FyZFJ1bGUgPSBuZXcgQmFja1dhcmRSdWxlKGNhdGNoRXZlbnQuTW9kZWwpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDmm7TmlrDlsZ7mgKfmoYZcclxuICAgICAgICAvLyBVdGlscy5wb3N0TWVzc2FnZShSZXNvdXJjZUtleXMud2Zfc2hvd1Byb3BlcnR5LCB0aGlzLmdldFByb3BDb25maWcoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlQmFja1dhcmRSdWxlKGNhdGNoRXZlbnQ6IEludGVybWVkaWF0ZUNhdGNoRXZlbnRJbXBsLCBvYmo6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IGRhdGEgPSBvYmoucHJvcGVydHlWYWx1ZTtcclxuICAgICAgICBsZXQgYmFja1dhcmRSdWxlID0gbmV3IEJhY2tXYXJkUnVsZShjYXRjaEV2ZW50Lk1vZGVsKTtcclxuICAgICAgICBiYWNrV2FyZFJ1bGUuVGFyZ2V0UmVmID0gZGF0YS5UYXJnZXRSZWY7XHJcbiAgICAgICAgYmFja1dhcmRSdWxlLlNlbGVjdFRhcmdldEFibGUgPSBkYXRhLlNlbGVjdFRhcmdldEFibGU7XHJcbiAgICAgICAgYmFja1dhcmRSdWxlLldhaXRSZXR1cm4gPSBkYXRhLldhaXRSZXR1cm47XHJcbiAgICAgICAgYmFja1dhcmRSdWxlLlJlc3VibWl0RWZmZWN0ID0gZGF0YS5SZXN1Ym1pdEVmZmVjdDtcclxuICAgICAgICBiYWNrV2FyZFJ1bGUuRHluYW1pY0JhY2tXYXJkUnVsZUFibGUgPSBkYXRhLkR5bmFtaWNCYWNrV2FyZFJ1bGVBYmxlO1xyXG4gICAgICAgIGJhY2tXYXJkUnVsZS5TZWxlY3RUYXJnZXRMaXN0ID0gZGF0YS5TZWxlY3RUYXJnZXRMaXN0O1xyXG5cclxuICAgICAgICBjYXRjaEV2ZW50LmJhY2tXYXJkUnVsZSA9IGJhY2tXYXJkUnVsZTtcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVWYXJpYWJsZVNldHRpbmdzKGNhdGNoRXZlbnQ6IEludGVybWVkaWF0ZUNhdGNoRXZlbnRJbXBsLCBvYmo6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IGJwbW5Nb2RlbCA9IGNhdGNoRXZlbnQuTW9kZWw7XHJcbiAgICAgICAgY29uc3QgZXh0ZW5kRWxlbWVudHMgPSBicG1uTW9kZWwuRGVmYXVsdFByb2Nlc3MuR2V0RXh0ZW5zaW9uRWxlbWVudHMoKTtcclxuICAgICAgICBpZiAoY2F0Y2hFdmVudC52YXJpYWJsZVNldHRpbmdzICYmIGNhdGNoRXZlbnQudmFyaWFibGVTZXR0aW5ncy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgdiBvZiBjYXRjaEV2ZW50LnZhcmlhYmxlU2V0dGluZ3MpIHtcclxuICAgICAgICAgICAgICAgIGlmICh2LnRhZyA9PT0gJ2NvbXBvbmVudCcpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpID0gZXh0ZW5kRWxlbWVudHMuZmluZEluZGV4KGUgPT4gKGUgaW5zdGFuY2VvZiBDb21wb25lbnQgJiYgZS5JZCA9PT0gdi52YWx1ZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4dGVuZEVsZW1lbnRzLnNwbGljZShpLCAxKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaEV2ZW50LnZhcmlhYmxlU2V0dGluZ3MgPSBuZXcgQXJyYXkoKTtcclxuXHJcbiAgICAgICAgY29uc3QgdmFyaWFibGVzID0gb2JqLnByb3BlcnR5VmFsdWUgYXMgYW55W107XHJcbiAgICAgICAgaWYgKHZhcmlhYmxlcyAmJiB2YXJpYWJsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHYgb2YgdmFyaWFibGVzKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB2YXJpYWJsZVNldHRpbmcgPSBuZXcgVmFyaWFibGVTZXR0aW5nKGJwbW5Nb2RlbCk7XHJcbiAgICAgICAgICAgICAgICAvLyB2YXJpYWJsZVNldHRpbmcudmFyaWFibGVJZCA9IHYudmFyaWFibGVJZDtcclxuICAgICAgICAgICAgICAgIHZhcmlhYmxlU2V0dGluZy52YXJpYWJsZUNvZGUgPSB2LnZhcmlhYmxlQ29kZTtcclxuICAgICAgICAgICAgICAgIHZhcmlhYmxlU2V0dGluZy52YXJpYWJsZU5hbWUgPSB2LnZhcmlhYmxlTmFtZTtcclxuICAgICAgICAgICAgICAgIHZhcmlhYmxlU2V0dGluZy50YWcgPSB2LnRhZztcclxuICAgICAgICAgICAgICAgIHZhcmlhYmxlU2V0dGluZy5leGVjdXRpb25UaW1lID0gdi5leGVjdXRpb25UaW1lO1xyXG4gICAgICAgICAgICAgICAgdmFyaWFibGVTZXR0aW5nLnZhbHVlID0gdi52YWx1ZTtcclxuICAgICAgICAgICAgICAgIHZhcmlhYmxlU2V0dGluZy52YWx1ZVRleHQgPSB2LnZhbHVlVGV4dDtcclxuXHJcbiAgICAgICAgICAgICAgICBjYXRjaEV2ZW50LnZhcmlhYmxlU2V0dGluZ3MucHVzaCh2YXJpYWJsZVNldHRpbmcpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHZhcmlhYmxlU2V0dGluZy50YWcgPT09ICdjb21wb25lbnQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYyA9IHYuY29tcG9uZW50O1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBjcHQgPSBuZXcgQ29tcG9uZW50KGJwbW5Nb2RlbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNwdC5NZXRhZGF0YUlkID0gYy5NZXRhZGF0YUlkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjcHQuTWV0aG9kQ29kZSA9IGMuTWV0aG9kQ29kZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3B0LklkID0gYy5JZDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3B0Lk5hbWUgPSBjLk5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNwdC5BY3R1YWxQYXJhbWV0ZXJzID0gbmV3IEFycmF5KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjLkFjdHVhbFBhcmFtZXRlcnMgJiYgYy5BY3R1YWxQYXJhbWV0ZXJzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGEgb2YgYy5BY3R1YWxQYXJhbWV0ZXJzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBhcmFtZXRlciA9IG5ldyBBY3R1YWxQYXJhbWV0ZXIoYnBtbk1vZGVsLCBhLk5hbWUsIGEuVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlci5UYWcgPSBhLlRhZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcHQuQWN0dWFsUGFyYW1ldGVycy5wdXNoKHBhcmFtZXRlcik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4dGVuZEVsZW1lbnRzLnB1c2goY3B0KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlU2lnbmFscyhjYXRjaEV2ZW50OiBJbnRlcm1lZGlhdGVDYXRjaEV2ZW50SW1wbCkge1xyXG4gICAgICAgIGNvbnN0IGJwbW5Nb2RlbCA9IGNhdGNoRXZlbnQuTW9kZWw7XHJcbiAgICAgICAgaWYgKGNhdGNoRXZlbnQuRXZlbnREZWZpbml0aW9ucyAmJiBjYXRjaEV2ZW50LkV2ZW50RGVmaW5pdGlvbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBjb25zdCBmbG93RWxlbWVudHMgPSBicG1uTW9kZWwuRGVmYXVsdFByb2Nlc3MuR2V0Rmxvd0VsZW1lbnRzKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGV2ZW50RGVmcyA9IG5ldyBNYXA8c3RyaW5nLCBTaWduYWxFdmVudERlZmluaXRpb25JbXBsPigpO1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBmbG93RWxlbWVudHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChmbG93RWxlbWVudHNba2V5XSBpbnN0YW5jZW9mIEludGVybWVkaWF0ZUNhdGNoRXZlbnRJbXBsICYmIGZsb3dFbGVtZW50c1trZXldLklkICE9PSBjYXRjaEV2ZW50LklkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2F0Y2hFdmVudCA9IGZsb3dFbGVtZW50c1trZXldIGFzIEludGVybWVkaWF0ZUNhdGNoRXZlbnRJbXBsO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgZSBvZiBjYXRjaEV2ZW50LkV2ZW50RGVmaW5pdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXZlbnQgPSBlIGFzIFNpZ25hbEV2ZW50RGVmaW5pdGlvbkltcGw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZXZlbnREZWZzLmdldChldmVudC5TaWduYWxSZWYpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudERlZnMuc2V0KGV2ZW50LlNpZ25hbFJlZiwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgZSBvZiBjYXRjaEV2ZW50LkV2ZW50RGVmaW5pdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGV2ZW50RGVmID0gZSBhcyBTaWduYWxFdmVudERlZmluaXRpb25JbXBsO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFldmVudERlZnMuZ2V0KGV2ZW50RGVmLlNpZ25hbFJlZikpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpID0gYnBtbk1vZGVsLnNpZ25hbHMuZmluZEluZGV4KHMgPT4gcy5OYW1lID09PSBldmVudERlZi5TaWduYWxSZWYpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnBtbk1vZGVsLnNpZ25hbHMuc3BsaWNlKGksIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=