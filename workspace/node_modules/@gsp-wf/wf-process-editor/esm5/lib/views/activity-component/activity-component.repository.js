/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { ActivityComponentUIState } from './activity-component.uistate';
import { HttpService } from '@ecp-caf/caf-common';
import { BizComponentEntity, OwnerType } from '../../domain/entities/biz-component.entity';
import { ProcessDesignerUIState } from '../../app/process-designer.uistate';
import { Subject } from 'rxjs';
import { ProcessDeUtil } from '../../domain/process-de-util';
var ActivityComponentRepository = /** @class */ (function () {
    function ActivityComponentRepository(uistate, util, http, designerState) {
        this.uistate = uistate;
        this.util = util;
        this.http = http;
        this.designerState = designerState;
        this.defaultProcessComponentIds = ['5863c8a8-e0a7-4137-a8b2-4c05e42b3b73', 'be781ba1-a88b-4bb8-9c88-2e2a27a9226e'];
        this.subject = new Subject();
    }
    /**
     * @param {?} flowFormId
     * @param {?} bizActId
     * @return {?}
     */
    ActivityComponentRepository.prototype.loadComponents = /**
     * @param {?} flowFormId
     * @param {?} bizActId
     * @return {?}
     */
    function (flowFormId, bizActId) {
        var _this = this;
        /** @type {?} */
        var url = this.util.getBizComponentsWebApi();
        if (bizActId) {
            url += "/query?param=" + encodeURIComponent("{\"flowFormKey\":\"" + flowFormId + "\",\"owner\":\"" + bizActId + "\",\"ownerType\":\"Activity\"}");
        }
        else {
            this.uistate.allComponents = [];
            return;
        }
        this.http.get(url).subscribe((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            _this.uistate.allComponents = data.filter((/**
             * @param {?} c
             * @return {?}
             */
            function (c) { return c.ownerType === OwnerType.Activity; }));
        }));
    };
    /**
     * @param {?} id
     * @return {?}
     */
    ActivityComponentRepository.prototype.removeComponent = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        if (id) {
            this.uistate.components = this.uistate.components.filter((/**
             * @param {?} c
             * @return {?}
             */
            function (c) { return c.id !== id; }));
        }
    };
    /**
     * @param {?} cpt
     * @return {?}
     */
    ActivityComponentRepository.prototype.addComponent = /**
     * @param {?} cpt
     * @return {?}
     */
    function (cpt) {
        if (cpt) {
            /** @type {?} */
            var component = new BizComponentEntity(cpt.name, cpt.id, cpt.operations[0].code);
            component.id = ProcessDeUtil.GenerateElementId();
            component.actualParameters = this.bindParas(cpt);
            console.log(cpt);
            console.log(component.actualParameters);
            if (component.metadataId === '7433df25-9260-4c24-86f0-9da3e89450fb' ||
                component.metadataId === 'd0783800-ed60-488c-b053-8806a15947fe' ||
                component.metadataId === 'b89e9b9a-2e2d-4bd0-b354-187219544d34' ||
                component.metadataId === 'a8b8f7a4-49ae-4b7d-88d2-b3772b9d0ae5') {
                component.scopeType = 'ExternalProcess';
            }
            else {
                component.scopeType = 'DirectStart';
            }
            this.uistate.components.push(component);
            this.subject.next(component);
        }
    };
    /**
     * @private
     * @param {?} component
     * @return {?}
     */
    ActivityComponentRepository.prototype.bindParas = /**
     * @private
     * @param {?} component
     * @return {?}
     */
    function (component) {
        /** @type {?} */
        var parameters = [];
        if (component.operations[0].parameters && component.operations[0].parameters.length > 0) {
            if (this.defaultProcessComponentIds.indexOf(component.id) > -1) {
                parameters = this.assignParameterValue(component.operations[0].parameters);
            }
            else {
                parameters = component.operations[0].parameters.map((/**
                 * @param {?} p
                 * @return {?}
                 */
                function (p) { return ({ code: p.code, name: p.name, value: '' }); }));
            }
        }
        return parameters;
    };
    /**
     * @private
     * @param {?} params
     * @return {?}
     */
    ActivityComponentRepository.prototype.assignParameterValue = /**
     * @private
     * @param {?} params
     * @return {?}
     */
    function (params) {
        var _this = this;
        return params.map((/**
         * @param {?} p
         * @return {?}
         */
        function (p) {
            if (p.code.indexOf('beId') > -1) {
                /** @type {?} */
                var v = _this.designerState.formalParameterContext.filter((/**
                 * @param {?} c
                 * @return {?}
                 */
                function (c) { return c.key.indexOf('metadataId') > -1; }))[0].key;
                return { code: p.code, name: p.name, value: "{\"expr\":\"DefaultFunction.GetContextParameter(\\\"" + v + "\\\")\"}" };
            }
            else if (p.code.indexOf('nodeId') > -1) {
                /** @type {?} */
                var v = _this.designerState.formalParameterContext.filter((/**
                 * @param {?} c
                 * @return {?}
                 */
                function (c) { return c.key.indexOf('schemaId') > -1; }))[0].key;
                return { code: p.code, name: p.name, value: "{\"expr\":\"DefaultFunction.GetContextParameter(\\\"" + v + "\\\")\"}" };
            }
            else if (p.code.indexOf('dataId') > -1) {
                return { code: p.code, name: p.name, value: "{\"expr\":\"DefaultFunction.GetContextParameter(\\\"dataId\\\")\"}" };
            }
            else if (p.code.indexOf('procInstId') > -1) {
                return { code: p.code, name: p.name, value: "{\"expr\":\"DefaultFunction.GetContextParameter(\\\"procInstId\\\")\"}" };
            }
            else {
                return { code: p.code, name: p.name, value: '' };
            }
        }));
    };
    /**
     * @param {?} arr
     * @param {?} i1
     * @param {?} i2
     * @return {?}
     */
    ActivityComponentRepository.prototype.swapArray = /**
     * @param {?} arr
     * @param {?} i1
     * @param {?} i2
     * @return {?}
     */
    function (arr, i1, i2) {
        arr[i1] = arr.splice(i2, 1, arr[i1])[0];
        return arr;
    };
    // 获取是否预制了外部流程构件
    // 获取是否预制了外部流程构件
    /**
     * @param {?} hander
     * @return {?}
     */
    ActivityComponentRepository.prototype.getBizCmp = 
    // 获取是否预制了外部流程构件
    /**
     * @param {?} hander
     * @return {?}
     */
    function (hander) {
        /** @type {?} */
        var url = "/api/runtime/wf/v1.0/bizComponent?flowFormKey=*&owner=*&ownerType=Process";
        this.http.get(url).subscribe((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            hander(data);
        }));
    };
    ActivityComponentRepository.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ActivityComponentRepository.ctorParameters = function () { return [
        { type: ActivityComponentUIState },
        { type: ProcessDeUtil },
        { type: HttpService },
        { type: ProcessDesignerUIState }
    ]; };
    return ActivityComponentRepository;
}());
export { ActivityComponentRepository };
if (false) {
    /**
     * @type {?}
     * @private
     */
    ActivityComponentRepository.prototype.defaultProcessComponentIds;
    /** @type {?} */
    ActivityComponentRepository.prototype.subject;
    /**
     * @type {?}
     * @private
     */
    ActivityComponentRepository.prototype.uistate;
    /**
     * @type {?}
     * @private
     */
    ActivityComponentRepository.prototype.util;
    /**
     * @type {?}
     * @private
     */
    ActivityComponentRepository.prototype.http;
    /**
     * @type {?}
     * @private
     */
    ActivityComponentRepository.prototype.designerState;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWN0aXZpdHktY29tcG9uZW50LnJlcG9zaXRvcnkuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ3NwLXdmL3dmLXByb2Nlc3MtZWRpdG9yLyIsInNvdXJjZXMiOlsibGliL3ZpZXdzL2FjdGl2aXR5LWNvbXBvbmVudC9hY3Rpdml0eS1jb21wb25lbnQucmVwb3NpdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUN4RSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFbEQsT0FBTyxFQUFFLGtCQUFrQixFQUFxQixTQUFTLEVBQUUsTUFBTSw0Q0FBNEMsQ0FBQztBQUk5RyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUM1RSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUM3RDtJQU1JLHFDQUNZLE9BQWlDLEVBQ2pDLElBQW1CLEVBQ25CLElBQWlCLEVBQ2pCLGFBQXFDO1FBSHJDLFlBQU8sR0FBUCxPQUFPLENBQTBCO1FBQ2pDLFNBQUksR0FBSixJQUFJLENBQWU7UUFDbkIsU0FBSSxHQUFKLElBQUksQ0FBYTtRQUNqQixrQkFBYSxHQUFiLGFBQWEsQ0FBd0I7UUFQekMsK0JBQTBCLEdBQUcsQ0FBQyxzQ0FBc0MsRUFBRSxzQ0FBc0MsQ0FBQyxDQUFDO1FBRXRILFlBQU8sR0FBZ0MsSUFBSSxPQUFPLEVBQXNCLENBQUM7SUFNckUsQ0FBQzs7Ozs7O0lBRUwsb0RBQWM7Ozs7O0lBQWQsVUFBZSxVQUFrQixFQUFFLFFBQWdCO1FBQW5ELGlCQVdDOztZQVZPLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLHNCQUFzQixFQUFFO1FBQzVDLElBQUksUUFBUSxFQUFFO1lBQ1YsR0FBRyxJQUFJLGVBQWUsR0FBRyxrQkFBa0IsQ0FBQyx3QkFBbUIsVUFBVSx1QkFBYyxRQUFRLG1DQUEyQixDQUFDLENBQUM7U0FDL0g7YUFBTTtZQUNILElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQztZQUNoQyxPQUFPO1NBQ1Y7UUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTOzs7O1FBQUMsVUFBQyxJQUFTO1lBQ25DLEtBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxNQUFNOzs7O1lBQUMsVUFBQyxDQUFxQixJQUFLLE9BQUEsQ0FBQyxDQUFDLFNBQVMsS0FBSyxTQUFTLENBQUMsUUFBUSxFQUFsQyxDQUFrQyxFQUFDLENBQUM7UUFDNUcsQ0FBQyxFQUFDLENBQUM7SUFDUCxDQUFDOzs7OztJQUNELHFEQUFlOzs7O0lBQWYsVUFBZ0IsRUFBVTtRQUN0QixJQUFJLEVBQUUsRUFBRTtZQUNKLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLE1BQU07Ozs7WUFBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFYLENBQVcsRUFBQyxDQUFDO1NBQzlFO0lBQ0wsQ0FBQzs7Ozs7SUFDRCxrREFBWTs7OztJQUFaLFVBQWEsR0FBaUI7UUFDMUIsSUFBSSxHQUFHLEVBQUU7O2dCQUNDLFNBQVMsR0FBRyxJQUFJLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNsRixTQUFTLENBQUMsRUFBRSxHQUFHLGFBQWEsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1lBQ2pELFNBQVMsQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2pELE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDakIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUN4QyxJQUFJLFNBQVMsQ0FBQyxVQUFVLEtBQUssc0NBQXNDO2dCQUNuRSxTQUFTLENBQUMsVUFBVSxLQUFLLHNDQUFzQztnQkFDL0QsU0FBUyxDQUFDLFVBQVUsS0FBSyxzQ0FBc0M7Z0JBQy9ELFNBQVMsQ0FBQyxVQUFVLEtBQUssc0NBQXNDLEVBQUc7Z0JBQ2hFLFNBQVMsQ0FBQyxTQUFTLEdBQUcsaUJBQWlCLENBQUM7YUFDekM7aUJBQU07Z0JBQ0wsU0FBUyxDQUFDLFNBQVMsR0FBRyxhQUFhLENBQUM7YUFDckM7WUFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDeEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDaEM7SUFDTCxDQUFDOzs7Ozs7SUFDTywrQ0FBUzs7Ozs7SUFBakIsVUFBa0IsU0FBdUI7O1lBQ2pDLFVBQVUsR0FBRyxFQUFFO1FBRW5CLElBQUksU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLElBQUksU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUNyRixJQUFJLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO2dCQUM1RCxVQUFVLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUM7YUFDOUU7aUJBQU07Z0JBQ0gsVUFBVSxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUc7Ozs7Z0JBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQTNDLENBQTJDLEVBQUMsQ0FBQzthQUN6RztTQUNKO1FBQ0QsT0FBTyxVQUFVLENBQUM7SUFDdEIsQ0FBQzs7Ozs7O0lBQ08sMERBQW9COzs7OztJQUE1QixVQUE2QixNQUFtQjtRQUFoRCxpQkFnQkM7UUFmRyxPQUFPLE1BQU0sQ0FBQyxHQUFHOzs7O1FBQUMsVUFBQSxDQUFDO1lBQ2YsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTs7b0JBQ3ZCLENBQUMsR0FBRyxLQUFJLENBQUMsYUFBYSxDQUFDLHNCQUFzQixDQUFDLE1BQU07Ozs7Z0JBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBaEMsQ0FBZ0MsRUFBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUc7Z0JBQ3hHLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUseURBQW1ELENBQUMsYUFBUSxFQUFFLENBQUM7YUFDOUc7aUJBQU0sSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTs7b0JBQ2hDLENBQUMsR0FBRyxLQUFJLENBQUMsYUFBYSxDQUFDLHNCQUFzQixDQUFDLE1BQU07Ozs7Z0JBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBOUIsQ0FBOEIsRUFBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUc7Z0JBQ3RHLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUseURBQW1ELENBQUMsYUFBUSxFQUFFLENBQUM7YUFDOUc7aUJBQU0sSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTtnQkFDdEMsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxvRUFBOEQsRUFBRSxDQUFDO2FBQ2hIO2lCQUFNLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7Z0JBQzFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsd0VBQWtFLEVBQUUsQ0FBQzthQUNwSDtpQkFBTTtnQkFDSCxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUFDO2FBQ3BEO1FBQ0wsQ0FBQyxFQUFDLENBQUM7SUFDUCxDQUFDOzs7Ozs7O0lBRUQsK0NBQVM7Ozs7OztJQUFULFVBQVUsR0FBZSxFQUFFLEVBQVUsRUFBRSxFQUFVO1FBQzdDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDeEMsT0FBTyxHQUFHLENBQUM7SUFDZixDQUFDO0lBRUgsZ0JBQWdCOzs7Ozs7SUFDaEIsK0NBQVM7Ozs7OztJQUFULFVBQVUsTUFBVzs7WUFDYixHQUFHLEdBQUcsMkVBQTJFO1FBQ3ZGLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFNBQVM7Ozs7UUFBQyxVQUFDLElBQVM7WUFDckMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2YsQ0FBQyxFQUFDLENBQUM7SUFDTCxDQUFDOztnQkExRkYsVUFBVTs7OztnQkFWRix3QkFBd0I7Z0JBU3hCLGFBQWE7Z0JBUmIsV0FBVztnQkFNWCxzQkFBc0I7O0lBOEYvQixrQ0FBQztDQUFBLEFBM0ZELElBMkZDO1NBekZZLDJCQUEyQjs7Ozs7O0lBQ3BDLGlFQUFzSDs7SUFFdEgsOENBQXlFOzs7OztJQUVyRSw4Q0FBeUM7Ozs7O0lBQ3pDLDJDQUEyQjs7Ozs7SUFDM0IsMkNBQXlCOzs7OztJQUN6QixvREFBNkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEFjdGl2aXR5Q29tcG9uZW50VUlTdGF0ZSB9IGZyb20gJy4vYWN0aXZpdHktY29tcG9uZW50LnVpc3RhdGUnO1xyXG5pbXBvcnQgeyBIdHRwU2VydmljZSB9IGZyb20gJ0BlY3AtY2FmL2NhZi1jb21tb24nO1xyXG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEJpekNvbXBvbmVudEVudGl0eSwgQ29tcG9uZW50TG9jYXRpb24sIE93bmVyVHlwZSB9IGZyb20gJy4uLy4uL2RvbWFpbi9lbnRpdGllcy9iaXotY29tcG9uZW50LmVudGl0eSc7XHJcbmltcG9ydCB7IEdzcENvbXBvbmVudCB9IGZyb20gJ0Bnc3AtY21wL2NvbW1vbi1jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBBY3R1YWxQYXJhbWV0ZXIgfSBmcm9tICcuLi8uLi9kb21haW4vZW50aXRpZXMvYWN0dWFsLXBhcmFtZXRlcic7XHJcbmltcG9ydCB7IFBhcmFtZXRlciB9IGZyb20gJ0BlY3AtY2FmL2NvbW1vbi1zdHJ1Y3R1cmUnO1xyXG5pbXBvcnQgeyBQcm9jZXNzRGVzaWduZXJVSVN0YXRlIH0gZnJvbSAnLi4vLi4vYXBwL3Byb2Nlc3MtZGVzaWduZXIudWlzdGF0ZSc7XHJcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgUHJvY2Vzc0RlVXRpbCB9IGZyb20gJy4uLy4uL2RvbWFpbi9wcm9jZXNzLWRlLXV0aWwnO1xyXG5ASW5qZWN0YWJsZSgpXHJcblxyXG5leHBvcnQgY2xhc3MgQWN0aXZpdHlDb21wb25lbnRSZXBvc2l0b3J5IHtcclxuICAgIHByaXZhdGUgZGVmYXVsdFByb2Nlc3NDb21wb25lbnRJZHMgPSBbJzU4NjNjOGE4LWUwYTctNDEzNy1hOGIyLTRjMDVlNDJiM2I3MycsICdiZTc4MWJhMS1hODhiLTRiYjgtOWM4OC0yZTJhMjdhOTIyNmUnXTtcclxuXHJcbiAgICBzdWJqZWN0OiBTdWJqZWN0PEJpekNvbXBvbmVudEVudGl0eT4gPSBuZXcgU3ViamVjdDxCaXpDb21wb25lbnRFbnRpdHk+KCk7XHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlIHVpc3RhdGU6IEFjdGl2aXR5Q29tcG9uZW50VUlTdGF0ZSxcclxuICAgICAgICBwcml2YXRlIHV0aWw6IFByb2Nlc3NEZVV0aWwsXHJcbiAgICAgICAgcHJpdmF0ZSBodHRwOiBIdHRwU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIGRlc2lnbmVyU3RhdGU6IFByb2Nlc3NEZXNpZ25lclVJU3RhdGUsXHJcbiAgICApIHsgfVxyXG5cclxuICAgIGxvYWRDb21wb25lbnRzKGZsb3dGb3JtSWQ6IHN0cmluZywgYml6QWN0SWQ6IHN0cmluZykge1xyXG4gICAgICAgIGxldCB1cmwgPSB0aGlzLnV0aWwuZ2V0Qml6Q29tcG9uZW50c1dlYkFwaSgpO1xyXG4gICAgICAgIGlmIChiaXpBY3RJZCkge1xyXG4gICAgICAgICAgICB1cmwgKz0gYC9xdWVyeT9wYXJhbT1gICsgZW5jb2RlVVJJQ29tcG9uZW50KGB7XCJmbG93Rm9ybUtleVwiOlwiJHtmbG93Rm9ybUlkfVwiLFwib3duZXJcIjpcIiR7Yml6QWN0SWR9XCIsXCJvd25lclR5cGVcIjpcIkFjdGl2aXR5XCJ9YCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy51aXN0YXRlLmFsbENvbXBvbmVudHMgPSBbXTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmh0dHAuZ2V0KHVybCkuc3Vic2NyaWJlKChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgdGhpcy51aXN0YXRlLmFsbENvbXBvbmVudHMgPSBkYXRhLmZpbHRlcigoYzogQml6Q29tcG9uZW50RW50aXR5KSA9PiBjLm93bmVyVHlwZSA9PT0gT3duZXJUeXBlLkFjdGl2aXR5KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHJlbW92ZUNvbXBvbmVudChpZDogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKGlkKSB7XHJcbiAgICAgICAgICAgIHRoaXMudWlzdGF0ZS5jb21wb25lbnRzID0gdGhpcy51aXN0YXRlLmNvbXBvbmVudHMuZmlsdGVyKGMgPT4gYy5pZCAhPT0gaWQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGFkZENvbXBvbmVudChjcHQ6IEdzcENvbXBvbmVudCkge1xyXG4gICAgICAgIGlmIChjcHQpIHtcclxuICAgICAgICAgICAgY29uc3QgY29tcG9uZW50ID0gbmV3IEJpekNvbXBvbmVudEVudGl0eShjcHQubmFtZSwgY3B0LmlkLCBjcHQub3BlcmF0aW9uc1swXS5jb2RlKTtcclxuICAgICAgICAgICAgY29tcG9uZW50LmlkID0gUHJvY2Vzc0RlVXRpbC5HZW5lcmF0ZUVsZW1lbnRJZCgpO1xyXG4gICAgICAgICAgICBjb21wb25lbnQuYWN0dWFsUGFyYW1ldGVycyA9IHRoaXMuYmluZFBhcmFzKGNwdCk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGNwdCk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGNvbXBvbmVudC5hY3R1YWxQYXJhbWV0ZXJzKTtcclxuICAgICAgICAgICAgaWYgKGNvbXBvbmVudC5tZXRhZGF0YUlkID09PSAnNzQzM2RmMjUtOTI2MC00YzI0LTg2ZjAtOWRhM2U4OTQ1MGZiJyB8fFxyXG4gICAgICAgICAgICBjb21wb25lbnQubWV0YWRhdGFJZCA9PT0gJ2QwNzgzODAwLWVkNjAtNDg4Yy1iMDUzLTg4MDZhMTU5NDdmZScgfHxcclxuICAgICAgICAgICAgY29tcG9uZW50Lm1ldGFkYXRhSWQgPT09ICdiODllOWI5YS0yZTJkLTRiZDAtYjM1NC0xODcyMTk1NDRkMzQnIHx8XHJcbiAgICAgICAgICAgIGNvbXBvbmVudC5tZXRhZGF0YUlkID09PSAnYThiOGY3YTQtNDlhZS00YjdkLTg4ZDItYjM3NzJiOWQwYWU1JyApIHtcclxuICAgICAgICAgICAgICBjb21wb25lbnQuc2NvcGVUeXBlID0gJ0V4dGVybmFsUHJvY2Vzcyc7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgY29tcG9uZW50LnNjb3BlVHlwZSA9ICdEaXJlY3RTdGFydCc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy51aXN0YXRlLmNvbXBvbmVudHMucHVzaChjb21wb25lbnQpO1xyXG4gICAgICAgICAgICB0aGlzLnN1YmplY3QubmV4dChjb21wb25lbnQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHByaXZhdGUgYmluZFBhcmFzKGNvbXBvbmVudDogR3NwQ29tcG9uZW50KTogQWN0dWFsUGFyYW1ldGVyW10ge1xyXG4gICAgICAgIGxldCBwYXJhbWV0ZXJzID0gW107XHJcblxyXG4gICAgICAgIGlmIChjb21wb25lbnQub3BlcmF0aW9uc1swXS5wYXJhbWV0ZXJzICYmIGNvbXBvbmVudC5vcGVyYXRpb25zWzBdLnBhcmFtZXRlcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5kZWZhdWx0UHJvY2Vzc0NvbXBvbmVudElkcy5pbmRleE9mKGNvbXBvbmVudC5pZCkgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgcGFyYW1ldGVycyA9IHRoaXMuYXNzaWduUGFyYW1ldGVyVmFsdWUoY29tcG9uZW50Lm9wZXJhdGlvbnNbMF0ucGFyYW1ldGVycyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzID0gY29tcG9uZW50Lm9wZXJhdGlvbnNbMF0ucGFyYW1ldGVycy5tYXAocCA9PiAoeyBjb2RlOiBwLmNvZGUsIG5hbWU6IHAubmFtZSwgdmFsdWU6ICcnIH0pKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcGFyYW1ldGVycztcclxuICAgIH1cclxuICAgIHByaXZhdGUgYXNzaWduUGFyYW1ldGVyVmFsdWUocGFyYW1zOiBQYXJhbWV0ZXJbXSk6IEFjdHVhbFBhcmFtZXRlcltdIHtcclxuICAgICAgICByZXR1cm4gcGFyYW1zLm1hcChwID0+IHtcclxuICAgICAgICAgICAgaWYgKHAuY29kZS5pbmRleE9mKCdiZUlkJykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdiA9IHRoaXMuZGVzaWduZXJTdGF0ZS5mb3JtYWxQYXJhbWV0ZXJDb250ZXh0LmZpbHRlcihjID0+IGMua2V5LmluZGV4T2YoJ21ldGFkYXRhSWQnKSA+IC0xKVswXS5rZXk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4geyBjb2RlOiBwLmNvZGUsIG5hbWU6IHAubmFtZSwgdmFsdWU6IGB7XCJleHByXCI6XCJEZWZhdWx0RnVuY3Rpb24uR2V0Q29udGV4dFBhcmFtZXRlcihcXFxcXCIke3Z9XFxcXFwiKVwifWAgfTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChwLmNvZGUuaW5kZXhPZignbm9kZUlkJykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdiA9IHRoaXMuZGVzaWduZXJTdGF0ZS5mb3JtYWxQYXJhbWV0ZXJDb250ZXh0LmZpbHRlcihjID0+IGMua2V5LmluZGV4T2YoJ3NjaGVtYUlkJykgPiAtMSlbMF0ua2V5O1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgY29kZTogcC5jb2RlLCBuYW1lOiBwLm5hbWUsIHZhbHVlOiBge1wiZXhwclwiOlwiRGVmYXVsdEZ1bmN0aW9uLkdldENvbnRleHRQYXJhbWV0ZXIoXFxcXFwiJHt2fVxcXFxcIilcIn1gIH07XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jb2RlLmluZGV4T2YoJ2RhdGFJZCcpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7IGNvZGU6IHAuY29kZSwgbmFtZTogcC5uYW1lLCB2YWx1ZTogYHtcImV4cHJcIjpcIkRlZmF1bHRGdW5jdGlvbi5HZXRDb250ZXh0UGFyYW1ldGVyKFxcXFxcImRhdGFJZFxcXFxcIilcIn1gIH07XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jb2RlLmluZGV4T2YoJ3Byb2NJbnN0SWQnKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4geyBjb2RlOiBwLmNvZGUsIG5hbWU6IHAubmFtZSwgdmFsdWU6IGB7XCJleHByXCI6XCJEZWZhdWx0RnVuY3Rpb24uR2V0Q29udGV4dFBhcmFtZXRlcihcXFxcXCJwcm9jSW5zdElkXFxcXFwiKVwifWAgfTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7IGNvZGU6IHAuY29kZSwgbmFtZTogcC5uYW1lLCB2YWx1ZTogJycgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHN3YXBBcnJheShhcnI6IEFycmF5PGFueT4sIGkxOiBudW1iZXIsIGkyOiBudW1iZXIpOiBBcnJheTxhbnk+IHtcclxuICAgICAgICBhcnJbaTFdID0gYXJyLnNwbGljZShpMiwgMSwgYXJyW2kxXSlbMF07XHJcbiAgICAgICAgcmV0dXJuIGFycjtcclxuICAgIH1cclxuXHJcbiAgLy8g6I635Y+W5piv5ZCm6aKE5Yi25LqG5aSW6YOo5rWB56iL5p6E5Lu2XHJcbiAgZ2V0Qml6Q21wKGhhbmRlcjogYW55KSB7XHJcbiAgICBjb25zdCB1cmwgPSBgL2FwaS9ydW50aW1lL3dmL3YxLjAvYml6Q29tcG9uZW50P2Zsb3dGb3JtS2V5PSomb3duZXI9KiZvd25lclR5cGU9UHJvY2Vzc2A7XHJcbiAgICB0aGlzLmh0dHAuZ2V0KHVybCkuc3Vic2NyaWJlKChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgaGFuZGVyKGRhdGEpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG59XHJcbiJdfQ==