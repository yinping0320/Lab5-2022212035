/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { ChangeDetectorRef, Component, Inject, Input, LOCALE_ID, Optional, ViewChild } from '@angular/core';
import { DatagridComponent } from '@farris/ui-datagrid';
import { EditorTypes } from '@farris/ui-datagrid-editors';
import { MessagerService } from '@farris/ui-messager';
import { ExprEditMode, ExpressionService, InjectedType } from '@gsp-svc/expression';
import { ProcessDesignerUIState } from '../../app/process-designer.uistate';
import { SmsMessageTemplate, SmsMessageVariable } from './sms-message-template';
import { WF_LANG_RESOURCES, WfLocalePipe } from '../../i18n/pipe/wf-process-editor-locale.pipe';
var SmsMessageTemplateComponent = /** @class */ (function () {
    function SmsMessageTemplateComponent(designerState, expr, message, cdr, localeId, resources, localePipe) {
        this.designerState = designerState;
        this.expr = expr;
        this.message = message;
        this.cdr = cdr;
        this.localeId = localeId;
        this.resources = resources;
        this.localePipe = localePipe;
        this.smsVariableList = new Array();
        this.smsVariableCols = new Array();
        this.smsTemplateContent = this.localePipe.transform('component.smsMessageTemplate.smsTemplateContent');
        this.localePipe = this.localePipe || new WfLocalePipe(localeId, resources);
        this.smsMessageTemplate = new SmsMessageTemplate();
    }
    /**
     * @return {?}
     */
    SmsMessageTemplateComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.smsVariableCols = [{
                field: 'code', width: 80, title: this.localePipe.transform('component.smsMessageTemplate.code'), editor: { type: EditorTypes.TEXTBOX, options: {} }
            }, {
                field: 'value', width: 100, title: this.localePipe.transform('component.smsMessageTemplate.value'), showTips: true, editor: {
                    type: 'input-group',
                    options: {
                        groupText: '<i class="f-icon f-icon-lookup"></i>',
                        editable: false,
                        clickHandle: (/**
                         * @param {?} e
                         * @return {?}
                         */
                        function (e) {
                            e.formControl.setValue(e.instance.value ? e.instance.value : '');
                            _this.showExprHelp(e);
                        }),
                        clear: (/**
                         * @param {?} e
                         * @return {?}
                         */
                        function (e) {
                            console.log('clear', e);
                        })
                    }
                }
            }];
        console.log(this.smsMessageTemplate);
    };
    /**
     * @return {?}
     */
    SmsMessageTemplateComponent.prototype.addSmsVariable = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var variable = new SmsMessageVariable();
        this.smsMessageTemplate.smsMessageVariables.push(variable);
        this.grid.loadData(this.smsMessageTemplate.smsMessageVariables);
    };
    /**
     * @return {?}
     */
    SmsMessageTemplateComponent.prototype.deleteSmsVariable = /**
     * @return {?}
     */
    function () {
        this.endGridEdit();
        /** @type {?} */
        var selectedVariable = this.grid.selectedRow;
        if (!selectedVariable) {
            this.message.info(this.localePipe.transform('component.smsMessageTemplate.noRowsSelected'));
            return;
        }
        /** @type {?} */
        var index = this.smsMessageTemplate.smsMessageVariables.findIndex((/**
         * @param {?} variable
         * @return {?}
         */
        function (variable) { return variable.id === selectedVariable.id; }));
        if (index > -1) {
            this.smsMessageTemplate.smsMessageVariables.splice(index, 1);
            this.grid.loadData(this.smsMessageTemplate.smsMessageVariables);
        }
    };
    /**
     * @return {?}
     */
    SmsMessageTemplateComponent.prototype.endGridEdit = /**
     * @return {?}
     */
    function () {
        this.grid.endCellEdit();
    };
    /**
     * @private
     * @param {?} e
     * @return {?}
     */
    SmsMessageTemplateComponent.prototype.showExprHelp = /**
     * @private
     * @param {?} e
     * @return {?}
     */
    function (e) {
        var _this = this;
        var e_1, _a, e_2, _b, e_3, _c;
        // this.expr.clearContext();
        if (this.designerState.schemas.length > 0) {
            try {
                for (var _d = tslib_1.__values(this.designerState.schemas), _e = _d.next(); !_e.done; _e = _d.next()) {
                    var schema = _e.value;
                    this.expr.addSchema('Schema', schema);
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_e && !_e.done && (_a = _d.return)) _a.call(_d);
                }
                finally { if (e_1) throw e_1.error; }
            }
            if (this.designerState.schemas[0].entityTypes && this.designerState.schemas[0].entityTypes.length > 0) {
                /** @type {?} */
                var entityType = this.designerState.schemas[0].entityTypes[0];
                this.expr.addInjectedEntity(entityType.name, 'Schema', entityType.name, InjectedType.EntityType);
            }
        }
        /** @type {?} */
        var context = new Array();
        context = this.designerState.addContext(context);
        if (this.designerState.subActivityContext.length > 0) {
            var _loop_1 = function (variable) {
                if (!context.some((/**
                 * @param {?} c
                 * @return {?}
                 */
                function (c) { return c.key === variable.key; }))) {
                    context.push(variable);
                }
            };
            try {
                for (var _f = tslib_1.__values(this.designerState.subActivityContext), _g = _f.next(); !_g.done; _g = _f.next()) {
                    var variable = _g.value;
                    _loop_1(variable);
                }
            }
            catch (e_2_1) { e_2 = { error: e_2_1 }; }
            finally {
                try {
                    if (_g && !_g.done && (_b = _f.return)) _b.call(_f);
                }
                finally { if (e_2) throw e_2.error; }
            }
        }
        if (context.length > 0) {
            try {
                for (var context_1 = tslib_1.__values(context), context_1_1 = context_1.next(); !context_1_1.done; context_1_1 = context_1.next()) {
                    var v = context_1_1.value;
                    this.expr.addContext(v);
                }
            }
            catch (e_3_1) { e_3 = { error: e_3_1 }; }
            finally {
                try {
                    if (context_1_1 && !context_1_1.done && (_c = context_1.return)) _c.call(context_1);
                }
                finally { if (e_3) throw e_3.error; }
            }
        }
        this.expr.setEditPattern(ExprEditMode.Advanced); // 默认打开高级表达式编辑器
        this.expr.addExpressionText(e.instance.value);
        this.expr.buildExpression().then((/**
         * @param {?} expressioninfo
         * @return {?}
         */
        function (expressioninfo) {
            e.formControl.setValue(expressioninfo);
            e.instance.cd.detectChanges();
            //点击确定后，去除表达式里面的新增的上下文变量
            if (context.length > 0) {
                _this.expr.exprEntity.contextEntities = _this.expr.exprEntity.contextEntities.filter((/**
                 * @param {?} x
                 * @return {?}
                 */
                function (x) { return !context.some((/**
                 * @param {?} y
                 * @return {?}
                 */
                function (y) { return y.key === x.key; })); }));
            }
        }));
    };
    SmsMessageTemplateComponent.decorators = [
        { type: Component, args: [{
                    selector: 'lib-sms-message-template',
                    template: "<div class=\"w-100\">\r\n  <farris-section class=\"py-0 \" [enableAccordion]=\"''\" [enableMaximize]=\"false\">\r\n    <ng-template farrisSectionHeader>\r\n      <div class=\"f-title\">\r\n        <h4 class=\"f-title-text\">{{'component.smsMessageTemplate.smsMessageTemplate'|wfLocale}}</h4>\r\n        <span farrisPopover class=\"f-icon f-icon-message_help\" style=\"color:#FBB902\" [container]=\"'body'\"\r\n          [triggers]=\"'hover'\" [placement]=\"'right'\" [popover]=\"poptmpl\">\r\n        </span>\r\n        <ng-template #poptmpl let-infos>\r\n          <div style=\"padding:10px 10px 10px 10px;font-size: 12px;color: black;width: 260px;\">\r\n            <h4 style=\"font-weight: 600;font-size: 16px;color: saddlebrown;\">{{'component.smsMessageTemplate.smsMessageTemplate'|wfLocale}}</h4>\r\n            <p style=\"margin: 0 0 10px;\">{{'component.smsMessageTemplate.tips1'|wfLocale}}</p>\r\n            <h4 style=\"font-weight: 600;font-size: 16px;color: saddlebrown;\">{{'component.smsMessageTemplate.smsTemplateNumber'|wfLocale}}</h4>\r\n            <p style=\"margin: 0 0 10px;\">{{'component.smsMessageTemplate.tips2'|wfLocale}}</p>\r\n            <!-- <h4 style=\"font-weight: 600;font-size: 16px;color: saddlebrown;\">\u77ED\u4FE1\u6A21\u677F\u5185\u5BB9</h4>\r\n            <p style=\"margin: 0 0 10px;\">{{smsTemplateContent}}</p> -->\r\n            <h4 style=\"font-weight: 600;font-size: 16px;color: saddlebrown;\">{{'component.smsMessageTemplate.smsVariableBinding'|wfLocale}}</h4>\r\n            <p style=\"margin: 0 0 10px;\">{{'component.smsMessageTemplate.tips3'|wfLocale}}</p>\r\n          </div>\r\n        </ng-template>\r\n      </div>\r\n    </ng-template>\r\n    <div class=\"f-form-layout farris-form  farris-form-controls-inline f-form-lable-auto farris-form-auto\">\r\n      <div class=\"col-12\">\r\n        <div class=\"farris-group-wrap\">\r\n          <div class=\"form-group farris-form-group\">\r\n            <label class=\"col-form-label\">\r\n              <span class=\"farris-label-info text-danger\">*</span>\r\n              <span class=\"farris-label-text\">{{'component.smsMessageTemplate.smsTemplateNumber'|wfLocale}}</span>\r\n            </label>\r\n            <div class=\"farris-input-wrap ml-1\">\r\n              <input [(ngModel)]=\"smsMessageTemplate.code\" class=\"form-control\" name=\"tempCode\" type=\"text\">\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      <!-- <div class=\"col-12\">\r\n        <div class=\"farris-group-wrap\">\r\n          <div class=\"form-group farris-form-group\">\r\n            <label class=\"col-form-label\">\r\n              <span class=\"farris-label-info text-danger\" style=\"visibility: hidden;\">*</span>\r\n              <span class=\"farris-label-text\">\u77ED\u4FE1\u6A21\u677F\u5185\u5BB9</span>\r\n            </label>\r\n            <div class=\"farris-input-wrap ml-1\">\r\n              <textarea [(ngModel)]=\"smsMessageTemplate.content\"  class=\"form-control \" cols=\"10\" id=\"textobj\" name=\"tempText\" rows=\"3\"> </textarea>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div> -->\r\n    </div>\r\n  </farris-section>\r\n</div>\r\n<div class=\"w-100\">\r\n  <farris-section class=\"pt-0 f-section-grid f-section-in-managelist\"\r\n    enableAccordion=\"{{'component.smsMessageTemplate.smsTemplateNumber'|wfLocale}}\" [enableMaximize]=\"false\" [mainTitle]=\"''\">\r\n    <!-- <ng-template farrisSectionTitle>\r\n      <div class=\"farris-label-text\">\u77ED\u4FE1\u53D8\u91CF\u7ED1\u5B9A</div>\r\n    </ng-template> -->\r\n    <ng-template farrisSectionToolbar>\r\n      <farris-button [type]=\"'link'\" (click)=\"addSmsVariable()\">\r\n        <span class=\"f-icon f-icon-add\"></span>\r\n        {{'component.smsMessageTemplate.addSmsVariable'|wfLocale}}</farris-button>\r\n      <farris-button [type]=\"'link'\" (click)=\"deleteSmsVariable()\">\r\n        <span class=\"f-icon f-icon-delete\"></span>\r\n        {{'component.smsMessageTemplate.deleteSmsVariable'|wfLocale}}</farris-button>\r\n    </ng-template>\r\n    <div style=\"height: 180px\">\r\n      <farris-datagrid #grid [data]=\"smsMessageTemplate.smsMessageVariables\" [idField]=\"'id'\" [columns]=\"smsVariableCols\"\r\n        [fit]=\"true\" [fitColumns]=\"true\" [editable]=\"true\" [editMode]=\"'cell'\" [pagination]=\"false\"\r\n        [showLineNumber]=\"true\" [showCheckbox]=\"false\" [multiSelect]=\"false\">\r\n      </farris-datagrid>\r\n    </div>\r\n  </farris-section>\r\n</div>\r\n",
                    providers: [
                        WfLocalePipe,
                    ],
                    styles: [""]
                }] }
    ];
    /** @nocollapse */
    SmsMessageTemplateComponent.ctorParameters = function () { return [
        { type: ProcessDesignerUIState },
        { type: ExpressionService },
        { type: MessagerService },
        { type: ChangeDetectorRef, decorators: [{ type: Optional }] },
        { type: String, decorators: [{ type: Inject, args: [LOCALE_ID,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [WF_LANG_RESOURCES,] }] },
        { type: WfLocalePipe, decorators: [{ type: Optional }] }
    ]; };
    SmsMessageTemplateComponent.propDecorators = {
        grid: [{ type: ViewChild, args: ['grid',] }],
        smsMessageTemplate: [{ type: Input }]
    };
    return SmsMessageTemplateComponent;
}());
export { SmsMessageTemplateComponent };
if (false) {
    /** @type {?} */
    SmsMessageTemplateComponent.prototype.grid;
    /** @type {?} */
    SmsMessageTemplateComponent.prototype.smsVariableList;
    /** @type {?} */
    SmsMessageTemplateComponent.prototype.smsVariableCols;
    /** @type {?} */
    SmsMessageTemplateComponent.prototype.smsTemplateContent;
    /** @type {?} */
    SmsMessageTemplateComponent.prototype.smsMessageTemplate;
    /**
     * @type {?}
     * @private
     */
    SmsMessageTemplateComponent.prototype.designerState;
    /**
     * @type {?}
     * @private
     */
    SmsMessageTemplateComponent.prototype.expr;
    /**
     * @type {?}
     * @private
     */
    SmsMessageTemplateComponent.prototype.message;
    /**
     * @type {?}
     * @private
     */
    SmsMessageTemplateComponent.prototype.cdr;
    /**
     * @type {?}
     * @private
     */
    SmsMessageTemplateComponent.prototype.localeId;
    /**
     * @type {?}
     * @private
     */
    SmsMessageTemplateComponent.prototype.resources;
    /**
     * @type {?}
     * @private
     */
    SmsMessageTemplateComponent.prototype.localePipe;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic21zLW1lc3NhZ2UtdGVtcGxhdGUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGdzcC13Zi93Zi1wcm9jZXNzLWVkaXRvci8iLCJzb3VyY2VzIjpbImxpYi92aWV3cy9zbXMtbWVzc2FnZS10ZW1wbGF0ZS9zbXMtbWVzc2FnZS10ZW1wbGF0ZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFVLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDcEgsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzFELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsWUFBWSxFQUFFLGlCQUFpQixFQUFFLFlBQVksRUFBYSxNQUFNLHFCQUFxQixDQUFDO0FBQy9GLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQzVFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ2hGLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxZQUFZLEVBQUUsTUFBTSwrQ0FBK0MsQ0FBQztBQUdoRztJQW1CRSxxQ0FDVSxhQUFxQyxFQUNyQyxJQUF1QixFQUN2QixPQUF3QixFQUNaLEdBQXNCLEVBQ2YsUUFBZ0IsRUFDUixTQUFjLEVBQzdCLFVBQXdCO1FBTnBDLGtCQUFhLEdBQWIsYUFBYSxDQUF3QjtRQUNyQyxTQUFJLEdBQUosSUFBSSxDQUFtQjtRQUN2QixZQUFPLEdBQVAsT0FBTyxDQUFpQjtRQUNaLFFBQUcsR0FBSCxHQUFHLENBQW1CO1FBQ2YsYUFBUSxHQUFSLFFBQVEsQ0FBUTtRQUNSLGNBQVMs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YW5nZURldGVjdG9yUmVmLCBDb21wb25lbnQsIEluamVjdCwgSW5wdXQsIExPQ0FMRV9JRCwgT25Jbml0LCBPcHRpb25hbCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IERhdGFncmlkQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1kYXRhZ3JpZCc7XHJcbmltcG9ydCB7IEVkaXRvclR5cGVzIH0gZnJvbSAnQGZhcnJpcy91aS1kYXRhZ3JpZC1lZGl0b3JzJztcclxuaW1wb3J0IHsgTWVzc2FnZXJTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1tZXNzYWdlcic7XHJcbmltcG9ydCB7IEV4cHJFZGl0TW9kZSwgRXhwcmVzc2lvblNlcnZpY2UsIEluamVjdGVkVHlwZSwgVmFyRW50aXR5IH0gZnJvbSAnQGdzcC1zdmMvZXhwcmVzc2lvbic7XHJcbmltcG9ydCB7IFByb2Nlc3NEZXNpZ25lclVJU3RhdGUgfSBmcm9tICcuLi8uLi9hcHAvcHJvY2Vzcy1kZXNpZ25lci51aXN0YXRlJztcclxuaW1wb3J0IHsgU21zTWVzc2FnZVRlbXBsYXRlLCBTbXNNZXNzYWdlVmFyaWFibGUgfSBmcm9tICcuL3Ntcy1tZXNzYWdlLXRlbXBsYXRlJztcclxuaW1wb3J0IHsgV0ZfTEFOR19SRVNPVVJDRVMsIFdmTG9jYWxlUGlwZSB9IGZyb20gJy4uLy4uL2kxOG4vcGlwZS93Zi1wcm9jZXNzLWVkaXRvci1sb2NhbGUucGlwZSc7XHJcbmltcG9ydCB7IFdGX1BST0NFU1NfRURJVE9SX0xBTkdfUkVTT1VSQ0VTIH0gZnJvbSAnLi4vLi4vaTE4bi9hc3NldHMvbGFuZy5yZXNvdXJjZSc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ2xpYi1zbXMtbWVzc2FnZS10ZW1wbGF0ZScsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL3Ntcy1tZXNzYWdlLXRlbXBsYXRlLmNvbXBvbmVudC5odG1sJyxcclxuICBzdHlsZVVybHM6IFsnLi9zbXMtbWVzc2FnZS10ZW1wbGF0ZS5jb21wb25lbnQuc2NzcyddLFxyXG4gIHByb3ZpZGVyczogW1xyXG4gICAgIFdmTG9jYWxlUGlwZSxcclxuICBdXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBTbXNNZXNzYWdlVGVtcGxhdGVDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xyXG5cclxuICBAVmlld0NoaWxkKCdncmlkJykgZ3JpZDogRGF0YWdyaWRDb21wb25lbnQ7XHJcblxyXG4gIHNtc1ZhcmlhYmxlTGlzdCA9IG5ldyBBcnJheSgpO1xyXG4gIHNtc1ZhcmlhYmxlQ29scyA9IG5ldyBBcnJheSgpO1xyXG4gIHNtc1RlbXBsYXRlQ29udGVudCA9IHRoaXMubG9jYWxlUGlwZS50cmFuc2Zvcm0oJ2NvbXBvbmVudC5zbXNNZXNzYWdlVGVtcGxhdGUuc21zVGVtcGxhdGVDb250ZW50JylcclxuXHJcbiAgQElucHV0KClcclxuICBzbXNNZXNzYWdlVGVtcGxhdGU6IFNtc01lc3NhZ2VUZW1wbGF0ZTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGRlc2lnbmVyU3RhdGU6IFByb2Nlc3NEZXNpZ25lclVJU3RhdGUsXHJcbiAgICBwcml2YXRlIGV4cHI6IEV4cHJlc3Npb25TZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBtZXNzYWdlOiBNZXNzYWdlclNlcnZpY2UsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgICBASW5qZWN0KExPQ0FMRV9JRCkgcHJpdmF0ZSBsb2NhbGVJZDogc3RyaW5nLFxyXG4gICAgQEluamVjdChXRl9MQU5HX1JFU09VUkNFUykgcHJpdmF0ZSByZXNvdXJjZXM6IGFueSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgbG9jYWxlUGlwZTogV2ZMb2NhbGVQaXBlLFxyXG4gICkge1xyXG4gICAgdGhpcy5sb2NhbGVQaXBlID0gdGhpcy5sb2NhbGVQaXBlIHx8IG5ldyBXZkxvY2FsZVBpcGUobG9jYWxlSWQsIHJlc291cmNlcyk7XHJcbiAgICB0aGlzLnNtc01lc3NhZ2VUZW1wbGF0ZSA9IG5ldyBTbXNNZXNzYWdlVGVtcGxhdGUoKTtcclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgdGhpcy5zbXNWYXJpYWJsZUNvbHM9W3tcclxuICAgICAgZmllbGQ6ICdjb2RlJywgd2lkdGg6IDgwLCB0aXRsZTogdGhpcy5sb2NhbGVQaXBlLnRyYW5zZm9ybSgnY29tcG9uZW50LnNtc01lc3NhZ2VUZW1wbGF0ZS5jb2RlJyksIGVkaXRvcjogeyB0eXBlOiBFZGl0b3JUeXBlcy5URVhUQk9YLCBvcHRpb25zOiB7fSB9XHJcbiAgICB9LCB7XHJcbiAgICAgIGZpZWxkOiAndmFsdWUnLCB3aWR0aDogMTAwLCB0aXRsZTogdGhpcy5sb2NhbGVQaXBlLnRyYW5zZm9ybSgnY29tcG9uZW50LnNtc01lc3NhZ2VUZW1wbGF0ZS52YWx1ZScpLCBzaG93VGlwczogdHJ1ZSxlZGl0b3I6IHtcclxuICAgICAgICB0eXBlOiAnaW5wdXQtZ3JvdXAnLFxyXG4gICAgICAgIG9wdGlvbnM6IHtcclxuICAgICAgICAgIGdyb3VwVGV4dDogJzxpIGNsYXNzPVwiZi1pY29uIGYtaWNvbi1sb29rdXBcIj48L2k+JyxcclxuICAgICAgICAgIGVkaXRhYmxlOiBmYWxzZSxcclxuICAgICAgICAgIGNsaWNrSGFuZGxlOiAoZSkgPT4ge1xyXG4gICAgICAgICAgICBlLmZvcm1Db250cm9sLnNldFZhbHVlKGUuaW5zdGFuY2UudmFsdWUgPyBlLmluc3RhbmNlLnZhbHVlIDogJycpO1xyXG4gICAgICAgICAgICB0aGlzLnNob3dFeHBySGVscChlKTtcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBjbGVhcjogKGUpID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ2NsZWFyJywgZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIH1dXHJcbiAgICBjb25zb2xlLmxvZyh0aGlzLnNtc01lc3NhZ2VUZW1wbGF0ZSk7XHJcbiAgfVxyXG5cclxuICBhZGRTbXNWYXJpYWJsZSgpIHtcclxuICAgIGNvbnN0IHZhcmlhYmxlID0gbmV3IFNtc01lc3NhZ2VWYXJpYWJsZSgpO1xyXG4gICAgdGhpcy5zbXNNZXNzYWdlVGVtcGxhdGUuc21zTWVzc2FnZVZhcmlhYmxlcy5wdXNoKHZhcmlhYmxlKTtcclxuICAgIHRoaXMuZ3JpZC5sb2FkRGF0YSh0aGlzLnNtc01lc3NhZ2VUZW1wbGF0ZS5zbXNNZXNzYWdlVmFyaWFibGVzKTtcclxuICB9XHJcblxyXG4gIGRlbGV0ZVNtc1ZhcmlhYmxlKCkge1xyXG4gICAgdGhpcy5lbmRHcmlkRWRpdCgpO1xyXG4gICAgY29uc3Qgc2VsZWN0ZWRWYXJpYWJsZSA9IHRoaXMuZ3JpZC5zZWxlY3RlZFJvdztcclxuICAgIGlmICghc2VsZWN0ZWRWYXJpYWJsZSkge1xyXG4gICAgICB0aGlzLm1lc3NhZ2UuaW5mbyh0aGlzLmxvY2FsZVBpcGUudHJhbnNmb3JtKCdjb21wb25lbnQuc21zTWVzc2FnZVRlbXBsYXRlLm5vUm93c1NlbGVjdGVkJykpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuc21zTWVzc2FnZVRlbXBsYXRlLnNtc01lc3NhZ2VWYXJpYWJsZXMuZmluZEluZGV4KHZhcmlhYmxlID0+IHZhcmlhYmxlLmlkID09PSBzZWxlY3RlZFZhcmlhYmxlLmlkKTtcclxuICAgIGlmIChpbmRleCA+IC0xKSB7XHJcbiAgICAgIHRoaXMuc21zTWVzc2FnZVRlbXBsYXRlLnNtc01lc3NhZ2VWYXJpYWJsZXMuc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgdGhpcy5ncmlkLmxvYWREYXRhKHRoaXMuc21zTWVzc2FnZVRlbXBsYXRlLnNtc01lc3NhZ2VWYXJpYWJsZXMpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZW5kR3JpZEVkaXQoKSB7XHJcbiAgICB0aGlzLmdyaWQuZW5kQ2VsbEVkaXQoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2hvd0V4cHJIZWxwKGU6IGFueSkge1xyXG4gICAgLy8gdGhpcy5leHByLmNsZWFyQ29udGV4dCgpO1xyXG4gICAgaWYgKHRoaXMuZGVzaWduZXJTdGF0ZS5zY2hlbWFzLmxlbmd0aCA+IDApIHtcclxuICAgICAgZm9yIChjb25zdCBzY2hlbWEgb2YgdGhpcy5kZXNpZ25lclN0YXRlLnNjaGVtYXMpIHtcclxuICAgICAgICB0aGlzLmV4cHIuYWRkU2NoZW1hKCdTY2hlbWEnLCBzY2hlbWEpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICh0aGlzLmRlc2lnbmVyU3RhdGUuc2NoZW1hc1swXS5lbnRpdHlUeXBlcyAmJiB0aGlzLmRlc2lnbmVyU3RhdGUuc2NoZW1hc1swXS5lbnRpdHlUeXBlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgY29uc3QgZW50aXR5VHlwZSA9IHRoaXMuZGVzaWduZXJTdGF0ZS5zY2hlbWFzWzBdLmVudGl0eVR5cGVzWzBdO1xyXG4gICAgICAgIHRoaXMuZXhwci5hZGRJbmplY3RlZEVudGl0eShlbnRpdHlUeXBlLm5hbWUsICdTY2hlbWEnLFxyXG4gICAgICAgICAgZW50aXR5VHlwZS5uYW1lLCBJbmplY3RlZFR5cGUuRW50aXR5VHlwZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGxldCBjb250ZXh0ID0gbmV3IEFycmF5PFZhckVudGl0eT4oKTtcclxuICAgIGNvbnRleHQgPSB0aGlzLmRlc2lnbmVyU3RhdGUuYWRkQ29udGV4dChjb250ZXh0KTtcclxuICAgIGlmICh0aGlzLmRlc2lnbmVyU3RhdGUuc3ViQWN0aXZpdHlDb250ZXh0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgZm9yIChjb25zdCB2YXJpYWJsZSBvZiB0aGlzLmRlc2lnbmVyU3RhdGUuc3ViQWN0aXZpdHlDb250ZXh0KSB7XHJcbiAgICAgICAgaWYgKCFjb250ZXh0LnNvbWUoYyA9PiBjLmtleSA9PT0gdmFyaWFibGUua2V5KSkge1xyXG4gICAgICAgICAgY29udGV4dC5wdXNoKHZhcmlhYmxlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGlmIChjb250ZXh0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgZm9yIChjb25zdCB2IG9mIGNvbnRleHQpIHtcclxuICAgICAgICB0aGlzLmV4cHIuYWRkQ29udGV4dCh2KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgdGhpcy5leHByLnNldEVkaXRQYXR0ZXJuKEV4cHJFZGl0TW9kZS5BZHZhbmNlZCk7IC8vIOm7mOiupOaJk+W8gOmrmOe6p+ihqOi+vuW8j+e8lui+keWZqFxyXG4gICAgdGhpcy5leHByLmFkZEV4cHJlc3Npb25UZXh0KGUuaW5zdGFuY2UudmFsdWUpO1xyXG4gICAgdGhpcy5leHByLmJ1aWxkRXhwcmVzc2lvbigpLnRoZW4oKGV4cHJlc3Npb25pbmZvOiBzdHJpbmcpID0+IHtcclxuICAgICAgZS5mb3JtQ29udHJvbC5zZXRWYWx1ZShleHByZXNzaW9uaW5mbyk7XHJcbiAgICAgIGUuaW5zdGFuY2UuY2QuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAvL+eCueWHu+ehruWumuWQju+8jOWOu+mZpOihqOi+vuW8j+mHjOmdoueahOaWsOWinueahOS4iuS4i+aWh+WPmOmHj1xyXG4gICAgICBpZihjb250ZXh0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgICB0aGlzLmV4cHIuZXhwckVudGl0eS5jb250ZXh0RW50aXRpZXMgPSB0aGlzLmV4cHIuZXhwckVudGl0eS5jb250ZXh0RW50aXRpZXMuZmlsdGVyKHggPT4gIWNvbnRleHQuc29tZSh5ID0+IHkua2V5ID09PSB4LmtleSkpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG5cclxuXHJcbn1cclxuIl19