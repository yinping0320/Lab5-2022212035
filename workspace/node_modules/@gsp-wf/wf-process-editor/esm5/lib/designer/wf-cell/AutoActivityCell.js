/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { NodeCell, ElementPropertyConfig } from "@edp-pmf/grapheditor";
import { mxResources } from "@edp-pmf/mxgraph-ts";
import { AutoActivity, Component, ActualParameter, VariableSetting } from "@gsp-wf/wf-process-model";
import { PropertyHelper } from "./PropertyHelper";
import { BpmnModelHelper, FlowNodeState } from "@edp-pmf/bpmn-model";
import { WfConstants } from "../WfConstants";
import { AutoActivityPropertyKeys } from "./property-keys/AutoActivityPropertyKeys";
/**
 * 服务活动节点
 */
var AutoActivityCell = /** @class */ (function (_super) {
    tslib_1.__extends(AutoActivityCell, _super);
    function AutoActivityCell(value, geometry, style) {
        var _a;
        var _this = _super.call(this, value, geometry, style) || this;
        _this.clrTypeId = AutoActivityCell.CLR_TYPE_ID;
        _this.name = "服务";
        _this.nameLanguage = {
            "zh-CHS": "服务",
            "zh-CHT": "服務",
            "en": "Service ",
        };
        _this.imgUrls = (_a = {},
            _a[FlowNodeState.Default] = WfConstants.IMAGE_PATH + "/auto.png",
            _a[FlowNodeState.Selected] = WfConstants.IMAGE_PATH + "/auto_select.svg",
            _a);
        return _this;
    }
    /**
     * @param {?=} flowElt
     * @return {?}
     */
    AutoActivityCell.prototype.createFlowElement = /**
     * @param {?=} flowElt
     * @return {?}
     */
    function (flowElt) {
        /** @type {?} */
        var flowNode = (/** @type {?} */ (_super.prototype.createFlowElement.call(this, flowElt)));
        flowNode.Id = "autoActivity" + BpmnModelHelper.GenerateElementId();
        return flowNode;
    };
    /**
     * @return {?}
     */
    AutoActivityCell.prototype.getFarrisPropConfig = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var act = this.flowElement;
        // 组织属性框
        /** @type {?} */
        var basicProperty = new ElementPropertyConfig();
        /** @type {?} */
        var activityProperty = new ElementPropertyConfig();
        /** @type {?} */
        var propertyData = {};
        basicProperty.categoryId = 'basicProperty';
        basicProperty.categoryName = mxResources.get('basicInformation');
        basicProperty.tabId = 'basic';
        basicProperty.tabName = mxResources.get('basicAttributes');
        basicProperty.properties = [
            { propertyID: AutoActivityPropertyKeys.Name, propertyName: mxResources.get('name'), propertyType: 'string', visible: !this.editorUi.multiLangEnabled },
            { propertyID: AutoActivityPropertyKeys.NameLanguage, propertyName: mxResources.get('nameLanguage'), propertyType: 'multiLanguage', visible: this.editorUi.multiLangEnabled },
            { propertyID: AutoActivityPropertyKeys.Id, propertyName: mxResources.get('id'), propertyType: 'string', readonly: true }
        ];
        activityProperty.categoryId = 'activityProperty';
        activityProperty.categoryName = mxResources.get('activityProperty');
        activityProperty.tabId = 'basic';
        activityProperty.tabName = mxResources.get('basicAttributes');
        activityProperty.properties = [
            { propertyID: AutoActivityPropertyKeys.Tools, propertyName: mxResources.get('tools'), propertyType: 'modal' },
            { propertyID: AutoActivityPropertyKeys.variableSettings, propertyName: mxResources.get('variableSettings'), propertyType: 'modal' },
        ];
        propertyData[AutoActivityPropertyKeys.Id] = act.Id;
        propertyData[AutoActivityPropertyKeys.ClrTypeID] = act.ClrTypeID;
        propertyData[AutoActivityPropertyKeys.Name] = act.Name;
        propertyData[AutoActivityPropertyKeys.NameLanguage] = act.NameLanguage || {
            "zh-CHS": act.Name,
        };
        propertyData[AutoActivityPropertyKeys.Tools] = PropertyHelper.getBizComponentList((/** @type {?} */ (act.tools)));
        propertyData[AutoActivityPropertyKeys.variableSettings] = PropertyHelper.getVariableSettings(act.Model, act.variableSettings);
        return {
            propertyConfig: [basicProperty, activityProperty],
            propertyData: propertyData
        };
    };
    /**
     * @param {?} obj
     * @return {?}
     */
    AutoActivityCell.prototype.updateProps = /**
     * @param {?} obj
     * @return {?}
     */
    function (obj) {
        /** @type {?} */
        var autoActivity = this.flowElement;
        /** @type {?} */
        var propertyId = obj.propertyID;
        switch (propertyId) {
            case AutoActivityPropertyKeys.Tools:
                this.updateAutoActivityTools(autoActivity, obj);
                break;
            case AutoActivityPropertyKeys.variableSettings:
                this.updateVariableSettings(autoActivity, obj);
                break;
            default:
                _super.prototype.updateProps.call(this, obj);
                break;
        }
    };
    /**
     * @param {?} autoActivity
     * @param {?} obj
     * @return {?}
     */
    AutoActivityCell.prototype.updateAutoActivityTools = /**
     * @param {?} autoActivity
     * @param {?} obj
     * @return {?}
     */
    function (autoActivity, obj) {
        var e_1, _a, e_2, _b;
        /** @type {?} */
        var tools = (/** @type {?} */ (obj.propertyValue));
        autoActivity.tools = new Array();
        if (tools && tools.length > 0) {
            try {
                for (var tools_1 = tslib_1.__values(tools), tools_1_1 = tools_1.next(); !tools_1_1.done; tools_1_1 = tools_1.next()) {
                    var tool = tools_1_1.value;
                    /** @type {?} */
                    var component = new Component(autoActivity.Model);
                    component.Id = tool.id;
                    component.Name = tool.name;
                    // component.Time = tool.executionTime;
                    // TODO 写死了构件类型
                    component.ComponentType = 'WebServiceComponent';
                    component.MetadataId = tool.metadataId;
                    component.MethodCode = tool.methodCode;
                    component.isForCompensation = tool.isForCompensation;
                    component.ActualParameters = [];
                    if (tool.actualParameters && ((/** @type {?} */ (tool.actualParameters))).length > 0) {
                        try {
                            for (var _c = tslib_1.__values(((/** @type {?} */ (tool.actualParameters)))), _d = _c.next(); !_d.done; _d = _c.next()) {
                                var a = _d.value;
                                /** @type {?} */
                                var parameter = new ActualParameter(autoActivity.Model, a.code, a.value);
                                component.ActualParameters.push(parameter);
                            }
                        }
                        catch (e_2_1) { e_2 = { error: e_2_1 }; }
                        finally {
                            try {
                                if (_d && !_d.done && (_b = _c.return)) _b.call(_c);
                            }
                            finally { if (e_2) throw e_2.error; }
                        }
                    }
                    autoActivity.tools.push(component);
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (tools_1_1 && !tools_1_1.done && (_a = tools_1.return)) _a.call(tools_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
        }
    };
    /**
     * @param {?} autoActivity
     * @param {?} obj
     * @return {?}
     */
    AutoActivityCell.prototype.updateVariableSettings = /**
     * @param {?} autoActivity
     * @param {?} obj
     * @return {?}
     */
    function (autoActivity, obj) {
        var e_3, _a, e_4, _b, e_5, _c;
        /** @type {?} */
        var bpmnModel = autoActivity.Model;
        /** @type {?} */
        var extendElements = bpmnModel.DefaultProcess.GetExtensionElements();
        if (autoActivity.variableSettings && autoActivity.variableSettings.length > 0) {
            var _loop_1 = function (v) {
                if (v.tag === 'component') {
                    /** @type {?} */
                    var i = extendElements.findIndex((/**
                     * @param {?} e
                     * @return {?}
                     */
                    function (e) { return (e instanceof Component && e.Id === v.value); }));
                    extendElements.splice(i, 1);
                }
            };
            try {
                for (var _d = tslib_1.__values(autoActivity.variableSettings), _e = _d.next(); !_e.done; _e = _d.next()) {
                    var v = _e.value;
                    _loop_1(v);
                }
            }
            catch (e_3_1) { e_3 = { error: e_3_1 }; }
            finally {
                try {
                    if (_e && !_e.done && (_a = _d.return)) _a.call(_d);
                }
                finally { if (e_3) throw e_3.error; }
            }
        }
        autoActivity.variableSettings = new Array();
        /** @type {?} */
        var variables = (/** @type {?} */ (obj.propertyValue));
        if (variables && variables.length > 0) {
            try {
                for (var variables_1 = tslib_1.__values(variables), variables_1_1 = variables_1.next(); !variables_1_1.done; variables_1_1 = variables_1.next()) {
                    var v = variables_1_1.value;
                    /** @type {?} */
                    var variableSetting = new VariableSetting(bpmnModel);
                    variableSetting.variableCode = v.variableCode;
                    variableSetting.variableName = v.variableName;
                    variableSetting.tag = v.tag;
                    variableSetting.executionTime = v.executionTime;
                    variableSetting.value = v.value;
                    variableSetting.valueText = v.valueText;
                    autoActivity.variableSettings.push(variableSetting);
                    if (variableSetting.tag === 'component') {
                        /** @type {?} */
                        var c = v.component;
                        if (c) {
                            /** @type {?} */
                            var cpt = new Component(bpmnModel);
                            cpt.MetadataId = c.MetadataId;
                            cpt.MethodCode = c.MethodCode;
                            cpt.Id = c.Id;
                            cpt.Name = c.Name;
                            cpt.ActualParameters = new Array();
                            if (c.ActualParameters && c.ActualParameters.length > 0) {
                                try {
                                    for (var _f = tslib_1.__values(c.ActualParameters), _g = _f.next(); !_g.done; _g = _f.next()) {
                                        var a = _g.value;
                                        /** @type {?} */
                                        var parameter = new ActualParameter(bpmnModel, a.Name, a.Value);
                                        parameter.Tag = a.Tag;
                                        cpt.ActualParameters.push(parameter);
                                    }
                                }
                                catch (e_5_1) { e_5 = { error: e_5_1 }; }
                                finally {
                                    try {
                                        if (_g && !_g.done && (_c = _f.return)) _c.call(_f);
                                    }
                                    finally { if (e_5) throw e_5.error; }
                                }
                            }
                            extendElements.push(cpt);
                        }
                    }
                }
            }
            catch (e_4_1) { e_4 = { error: e_4_1 }; }
            finally {
                try {
                    if (variables_1_1 && !variables_1_1.done && (_b = variables_1.return)) _b.call(variables_1);
                }
                finally { if (e_4) throw e_4.error; }
            }
        }
    };
    AutoActivityCell.CLR_TYPE_ID = AutoActivity.Clr_Type_ID;
    return AutoActivityCell;
}(NodeCell));
export { AutoActivityCell };
if (false) {
    /** @type {?} */
    AutoActivityCell.CLR_TYPE_ID;
    /** @type {?} */
    AutoActivityCell.prototype.clrTypeId;
    /** @type {?} */
    AutoActivityCell.prototype.name;
    /** @type {?} */
    AutoActivityCell.prototype.nameLanguage;
    /** @type {?} */
    AutoActivityCell.prototype.flowElement;
    /** @type {?} */
    AutoActivityCell.prototype.imgUrls;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXV0b0FjdGl2aXR5Q2VsbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bnc3Atd2Yvd2YtcHJvY2Vzcy1lZGl0b3IvIiwic291cmNlcyI6WyJsaWIvZGVzaWduZXIvd2YtY2VsbC9BdXRvQWN0aXZpdHlDZWxsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxxQkFBcUIsRUFBNEIsTUFBTSxzQkFBc0IsQ0FBQztBQUNqRyxPQUFPLEVBQWEsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDN0QsT0FBTyxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQVEsZUFBZSxFQUFFLGVBQWUsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzNHLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3JFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQzs7OztBQUtwRjtJQUFzQyw0Q0FBUTtJQWdCMUMsMEJBQVksS0FBVyxFQUFFLFFBQStCLEVBQUUsS0FBYzs7UUFBeEUsWUFDSSxrQkFBTSxLQUFLLEVBQUUsUUFBUSxFQUFFLEtBQUssQ0FBQyxTQUNoQztRQWpCRCxlQUFTLEdBQVcsZ0JBQWdCLENBQUMsV0FBVyxDQUFDO1FBQ2pELFVBQUksR0FBVyxJQUFJLENBQUM7UUFDcEIsa0JBQVksR0FBZ0M7WUFDMUMsUUFBUSxFQUFFLElBQUk7WUFDZCxRQUFRLEVBQUUsSUFBSTtZQUNkLElBQUksRUFBRSxVQUFVO1NBQ25CLENBQUM7UUFJQSxhQUFPO1lBQ0gsR0FBQyxhQUFhLENBQUMsT0FBTyxJQUFHLFdBQVcsQ0FBQyxVQUFVLEdBQUcsV0FBVztZQUM3RCxHQUFDLGFBQWEsQ0FBQyxRQUFRLElBQUcsV0FBVyxDQUFDLFVBQVUsR0FBRyxrQkFBa0I7Z0JBQ3ZFOztJQUlGLENBQUM7Ozs7O0lBRUQsNENBQWlCOzs7O0lBQWpCLFVBQWtCLE9BQXNCOztZQUM5QixRQUFRLEdBQUcsbUJBQUEsaUJBQU0saUJBQWlCLFlBQUMsT0FBTyxDQUFDLEVBQWdCO1FBQ2pFLFFBQVEsQ0FBQyxFQUFFLEdBQUcsY0FBYyxHQUFHLGVBQWUsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBRW5FLE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7Ozs7SUFFRCw4Q0FBbUI7OztJQUFuQjs7WUFDUSxHQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVc7OztZQUd0QixhQUFhLEdBQTBCLElBQUkscUJBQXFCLEVBQUU7O1lBQ2xFLGdCQUFnQixHQUEwQixJQUFJLHFCQUFxQixFQUFFOztZQUNyRSxZQUFZLEdBQVEsRUFBRTtRQUUxQixhQUFhLENBQUMsVUFBVSxHQUFHLGVBQWUsQ0FBQztRQUMzQyxhQUFhLENBQUMsWUFBWSxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUNqRSxhQUFhLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQztRQUM5QixhQUFhLENBQUMsT0FBTyxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUMzRCxhQUFhLENBQUMsVUFBVSxHQUFHO1lBQ3ZCLEVBQUUsVUFBVSxFQUFFLHdCQUF3QixDQUFDLElBQUksRUFBRSxZQUFZLEVBQUUsV0FBVyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLEVBQUU7WUFDdEosRUFBRSxVQUFVLEVBQUUsd0JBQXdCLENBQUMsWUFBWSxFQUFFLFlBQVksRUFBRSxXQUFXLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxFQUFFLFlBQVksRUFBRSxlQUFlLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLEVBQUU7WUFDNUssRUFBRSxVQUFVLEVBQUUsd0JBQXdCLENBQUMsRUFBRSxFQUFFLFlBQVksRUFBRSxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRTtTQUMzSCxDQUFDO1FBR0YsZ0JBQWdCLENBQUMsVUFBVSxHQUFHLGtCQUFrQixDQUFDO1FBQ2pELGdCQUFnQixDQUFDLFlBQVksR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDcEUsZ0JBQWdCLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQztRQUNqQyxnQkFBZ0IsQ0FBQyxPQUFPLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQzlELGdCQUFnQixDQUFDLFVBQVUsR0FBRztZQUMxQixFQUFFLFVBQVUsRUFBRSx3QkFBd0IsQ0FBQyxLQUFLLEVBQUUsWUFBWSxFQUFFLFdBQVcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRTtZQUM3RyxFQUFFLFVBQVUsRUFBRSx3QkFBd0IsQ0FBQyxnQkFBZ0IsRUFBRSxZQUFZLEVBQUUsV0FBVyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUU7U0FDdEksQ0FBQztRQUVGLFlBQVksQ0FBQyx3QkFBd0IsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ25ELFlBQVksQ0FBQyx3QkFBd0IsQ0FBQyxTQUFTLENBQUMsR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDO1FBQ2pFLFlBQVksQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ3ZELFlBQVksQ0FBQyx3QkFBd0IsQ0FBQyxZQUFZLENBQUMsR0FBRyxHQUFHLENBQUMsWUFBWSxJQUFJO1lBQ3RFLFFBQVEsRUFBRSxHQUFHLENBQUMsSUFBSTtTQUNyQixDQUFDO1FBQ0YsWUFBWSxDQUFDLHdCQUF3QixDQUFDLEtBQUssQ0FBQyxHQUFHLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxtQkFBQSxHQUFHLENBQUMsS0FBSyxFQUFvQixDQUFDLENBQUM7UUFDakgsWUFBWSxDQUFDLHdCQUF3QixDQUFDLGdCQUFnQixDQUFDLEdBQUcsY0FBYyxDQUFDLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFFOUgsT0FBTztZQUNILGNBQWMsRUFBRSxDQUFDLGFBQWEsRUFBRSxnQkFBZ0IsQ0FBQztZQUNqRCxZQUFZLEVBQUUsWUFBWTtTQUM3QixDQUFBO0lBQ0wsQ0FBQzs7Ozs7SUFFRCxzQ0FBVzs7OztJQUFYLFVBQVksR0FBUTs7WUFDVixZQUFZLEdBQUcsSUFBSSxDQUFDLFdBQVc7O1lBQy9CLFVBQVUsR0FBVyxHQUFHLENBQUMsVUFBVTtRQUN6QyxRQUFRLFVBQVUsRUFBRTtZQUNoQixLQUFLLHdCQUF3QixDQUFDLEtBQUs7Z0JBQy9CLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxZQUFZLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ2hELE1BQU07WUFDVixLQUFLLHdCQUF3QixDQUFDLGdCQUFnQjtnQkFDMUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsQ0FBQztnQkFDL0MsTUFBTTtZQUNWO2dCQUNJLGlCQUFNLFdBQVcsWUFBQyxHQUFHLENBQUMsQ0FBQztnQkFDdkIsTUFBTTtTQUNiO0lBQ0wsQ0FBQzs7Ozs7O0lBRUQsa0RBQXVCOzs7OztJQUF2QixVQUF3QixZQUEwQixFQUFFLEdBQVE7OztZQUNwRCxLQUFLLEdBQUcsbUJBQUEsR0FBRyxDQUFDLGFBQWEsRUFBUztRQUN0QyxZQUFZLENBQUMsS0FBSyxHQUFHLElBQUksS0FBSyxFQUFRLENBQUM7UUFDdkMsSUFBSSxLQUFLLElBQUksS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7O2dCQUMzQixLQUFtQixJQUFBLFVBQUEsaUJBQUEsS0FBSyxDQUFBLDRCQUFBLCtDQUFFO29CQUFyQixJQUFNLElBQUksa0JBQUE7O3dCQUNQLFNBQVMsR0FBRyxJQUFJLFNBQVMsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDO29CQUNqRCxTQUFTLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUM7b0JBQ3ZCLFNBQVMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztvQkFDM0IsdUNBQXVDO29CQUN2QyxlQUFlO29CQUNmLFNBQVMsQ0FBQyxhQUFhLEdBQUcscUJBQXFCLENBQUM7b0JBQ2hELFNBQVMsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztvQkFDdkMsU0FBUyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO29CQUN2QyxTQUFTLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDO29CQUNyRCxTQUFTLENBQUMsZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO29CQUNoQyxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDLG1CQUFBLElBQUksQ0FBQyxnQkFBZ0IsRUFBUyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTs7NEJBQ3RFLEtBQWMsSUFBQSxLQUFBLGlCQUFBLENBQUMsbUJBQUEsSUFBSSxDQUFDLGdCQUFnQixFQUFTLENBQUMsQ0FBQSxnQkFBQSw0QkFBRTtnQ0FBM0MsSUFBSSxDQUFDLFdBQUE7O29DQUNGLFNBQVMsR0FBRyxJQUFJLGVBQWUsQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQztnQ0FDeEUsU0FBUyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQzs2QkFDOUM7Ozs7Ozs7OztxQkFDSjtvQkFDRCxZQUFZLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztpQkFDdEM7Ozs7Ozs7OztTQUNKO0lBQ0wsQ0FBQzs7Ozs7O0lBRUQsaURBQXNCOzs7OztJQUF0QixVQUF1QixZQUEwQixFQUFFLEdBQVE7OztZQUNqRCxTQUFTLEdBQUcsWUFBWSxDQUFDLEtBQUs7O1lBQzlCLGNBQWMsR0FBRyxTQUFTLENBQUMsY0FBYyxDQUFDLG9CQUFvQixFQUFFO1FBQ3RFLElBQUksWUFBWSxDQUFDLGdCQUFnQixJQUFJLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO29DQUNoRSxDQUFDO2dCQUNSLElBQUksQ0FBQyxDQUFDLEdBQUcsS0FBSyxXQUFXLEVBQUU7O3dCQUNqQixDQUFDLEdBQUcsY0FBYyxDQUFDLFNBQVM7Ozs7b0JBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsWUFBWSxTQUFTLElBQUksQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQTVDLENBQTRDLEVBQUM7b0JBQ3JGLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2lCQUMvQjs7O2dCQUpMLEtBQWdCLElBQUEsS0FBQSxpQkFBQSxZQUFZLENBQUMsZ0JBQWdCLENBQUEsZ0JBQUE7b0JBQXhDLElBQU0sQ0FBQyxXQUFBOzRCQUFELENBQUM7aUJBS1g7Ozs7Ozs7OztTQUNKO1FBQ0QsWUFBWSxDQUFDLGdCQUFnQixHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7O1lBRXRDLFNBQVMsR0FBRyxtQkFBQSxHQUFHLENBQUMsYUFBYSxFQUFTO1FBQzVDLElBQUksU0FBUyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFOztnQkFDbkMsS0FBZ0IsSUFBQSxjQUFBLGlCQUFBLFNBQVMsQ0FBQSxvQ0FBQSwyREFBRTtvQkFBdEIsSUFBTSxDQUFDLHNCQUFBOzt3QkFDRixlQUFlLEdBQUcsSUFBSSxlQUFlLENBQUMsU0FBUyxDQUFDO29CQUN0RCxlQUFlLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQyxZQUFZLENBQUM7b0JBQzlDLGVBQWUsQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDLFlBQVksQ0FBQztvQkFDOUMsZUFBZSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDO29CQUM1QixlQUFlLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQyxhQUFhLENBQUM7b0JBQ2hELGVBQWUsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztvQkFDaEMsZUFBZSxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDO29CQUV4QyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO29CQUNwRCxJQUFJLGVBQWUsQ0FBQyxHQUFHLEtBQUssV0FBVyxFQUFFOzs0QkFDL0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTO3dCQUNyQixJQUFJLENBQUMsRUFBRTs7Z0NBQ0MsR0FBRyxHQUFHLElBQUksU0FBUyxDQUFDLFNBQVMsQ0FBQzs0QkFDbEMsR0FBRyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDOzRCQUM5QixHQUFHLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxVQUFVLENBQUM7NEJBQzlCLEdBQUcsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQzs0QkFDZCxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7NEJBQ2xCLEdBQUcsQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDOzRCQUNuQyxJQUFJLENBQUMsQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTs7b0NBQ3JELEtBQWMsSUFBQSxLQUFBLGlCQUFBLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQSxnQkFBQSw0QkFBRTt3Q0FBN0IsSUFBSSxDQUFDLFdBQUE7OzRDQUNGLFNBQVMsR0FBRyxJQUFJLGVBQWUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDO3dDQUMvRCxTQUFTLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUM7d0NBQ3RCLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7cUNBQ3hDOzs7Ozs7Ozs7NkJBQ0o7NEJBRUQsY0FBYyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQzt5QkFDNUI7cUJBQ0o7aUJBQ0o7Ozs7Ozs7OztTQUNKO0lBQ0wsQ0FBQztJQXZKTSw0QkFBVyxHQUFXLFlBQVksQ0FBQyxXQUFXLENBQUM7SUF3SjFELHVCQUFDO0NBQUEsQUFoS0QsQ0FBc0MsUUFBUSxHQWdLN0M7U0FoS1ksZ0JBQWdCOzs7SUFRekIsNkJBQXNEOztJQVB0RCxxQ0FBaUQ7O0lBQ2pELGdDQUFvQjs7SUFDcEIsd0NBSUE7O0lBRUEsdUNBQTBCOztJQUUxQixtQ0FHRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5vZGVDZWxsLCBFbGVtZW50UHJvcGVydHlDb25maWcsIEZhcnJpc1Byb3BDb25maWdXaXRoRGF0YSB9IGZyb20gXCJAZWRwLXBtZi9ncmFwaGVkaXRvclwiO1xyXG5pbXBvcnQgeyBNeEdyYXBoTlMsIG14UmVzb3VyY2VzIH0gZnJvbSBcIkBlZHAtcG1mL214Z3JhcGgtdHNcIjtcclxuaW1wb3J0IHsgQXV0b0FjdGl2aXR5LCBDb21wb25lbnQsIFRvb2wsIEFjdHVhbFBhcmFtZXRlciwgVmFyaWFibGVTZXR0aW5nIH0gZnJvbSBcIkBnc3Atd2Yvd2YtcHJvY2Vzcy1tb2RlbFwiO1xyXG5pbXBvcnQgeyBQcm9wZXJ0eUhlbHBlciB9IGZyb20gXCIuL1Byb3BlcnR5SGVscGVyXCI7XHJcbmltcG9ydCB7IEJwbW5Nb2RlbEhlbHBlciwgRmxvd05vZGVTdGF0ZSB9IGZyb20gXCJAZWRwLXBtZi9icG1uLW1vZGVsXCI7XHJcbmltcG9ydCB7IFdmQ29uc3RhbnRzIH0gZnJvbSBcIi4uL1dmQ29uc3RhbnRzXCI7XHJcbmltcG9ydCB7IEF1dG9BY3Rpdml0eVByb3BlcnR5S2V5cyB9IGZyb20gXCIuL3Byb3BlcnR5LWtleXMvQXV0b0FjdGl2aXR5UHJvcGVydHlLZXlzXCI7XHJcblxyXG4vKipcclxuICog5pyN5Yqh5rS75Yqo6IqC54K5XHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgQXV0b0FjdGl2aXR5Q2VsbCBleHRlbmRzIE5vZGVDZWxsIHtcclxuICAgIGNsclR5cGVJZDogc3RyaW5nID0gQXV0b0FjdGl2aXR5Q2VsbC5DTFJfVFlQRV9JRDtcclxuICAgIG5hbWU6IHN0cmluZyA9IFwi5pyN5YqhXCI7XHJcbiAgICBuYW1lTGFuZ3VhZ2U6IHsgW2xhbmc6IHN0cmluZ106IHN0cmluZzsgfSA9IHtcclxuICAgICAgXCJ6aC1DSFNcIjogXCLmnI3liqFcIixcclxuICAgICAgXCJ6aC1DSFRcIjogXCLmnI3li5lcIixcclxuICAgICAgXCJlblwiOiBcIlNlcnZpY2UgXCIsXHJcbiAgfTtcclxuICAgIHN0YXRpYyBDTFJfVFlQRV9JRDogc3RyaW5nID0gQXV0b0FjdGl2aXR5LkNscl9UeXBlX0lEO1xyXG4gICAgZmxvd0VsZW1lbnQ6IEF1dG9BY3Rpdml0eTtcclxuXHJcbiAgICBpbWdVcmxzID0ge1xyXG4gICAgICAgIFtGbG93Tm9kZVN0YXRlLkRlZmF1bHRdOiBXZkNvbnN0YW50cy5JTUFHRV9QQVRIICsgXCIvYXV0by5wbmdcIixcclxuICAgICAgICBbRmxvd05vZGVTdGF0ZS5TZWxlY3RlZF06IFdmQ29uc3RhbnRzLklNQUdFX1BBVEggKyBcIi9hdXRvX3NlbGVjdC5zdmdcIixcclxuICAgIH07XHJcblxyXG4gICAgY29uc3RydWN0b3IodmFsdWU/OiBhbnksIGdlb21ldHJ5PzogTXhHcmFwaE5TLm14R2VvbWV0cnksIHN0eWxlPzogc3RyaW5nKSB7XHJcbiAgICAgICAgc3VwZXIodmFsdWUsIGdlb21ldHJ5LCBzdHlsZSk7XHJcbiAgICB9XHJcblxyXG4gICAgY3JlYXRlRmxvd0VsZW1lbnQoZmxvd0VsdD86IEF1dG9BY3Rpdml0eSkge1xyXG4gICAgICAgIGNvbnN0IGZsb3dOb2RlID0gc3VwZXIuY3JlYXRlRmxvd0VsZW1lbnQoZmxvd0VsdCkgYXMgQXV0b0FjdGl2aXR5O1xyXG4gICAgICAgIGZsb3dOb2RlLklkID0gXCJhdXRvQWN0aXZpdHlcIiArIEJwbW5Nb2RlbEhlbHBlci5HZW5lcmF0ZUVsZW1lbnRJZCgpO1xyXG5cclxuICAgICAgICByZXR1cm4gZmxvd05vZGU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0RmFycmlzUHJvcENvbmZpZygpOiBGYXJyaXNQcm9wQ29uZmlnV2l0aERhdGEge1xyXG4gICAgICAgIGxldCBhY3QgPSB0aGlzLmZsb3dFbGVtZW50O1xyXG5cclxuICAgICAgICAvLyDnu4Tnu4flsZ7mgKfmoYZcclxuICAgICAgICBsZXQgYmFzaWNQcm9wZXJ0eTogRWxlbWVudFByb3BlcnR5Q29uZmlnID0gbmV3IEVsZW1lbnRQcm9wZXJ0eUNvbmZpZygpO1xyXG4gICAgICAgIGxldCBhY3Rpdml0eVByb3BlcnR5OiBFbGVtZW50UHJvcGVydHlDb25maWcgPSBuZXcgRWxlbWVudFByb3BlcnR5Q29uZmlnKCk7XHJcbiAgICAgICAgbGV0IHByb3BlcnR5RGF0YTogYW55ID0ge307XHJcblxyXG4gICAgICAgIGJhc2ljUHJvcGVydHkuY2F0ZWdvcnlJZCA9ICdiYXNpY1Byb3BlcnR5JztcclxuICAgICAgICBiYXNpY1Byb3BlcnR5LmNhdGVnb3J5TmFtZSA9IG14UmVzb3VyY2VzLmdldCgnYmFzaWNJbmZvcm1hdGlvbicpO1xyXG4gICAgICAgIGJhc2ljUHJvcGVydHkudGFiSWQgPSAnYmFzaWMnO1xyXG4gICAgICAgIGJhc2ljUHJvcGVydHkudGFiTmFtZSA9IG14UmVzb3VyY2VzLmdldCgnYmFzaWNBdHRyaWJ1dGVzJyk7XHJcbiAgICAgICAgYmFzaWNQcm9wZXJ0eS5wcm9wZXJ0aWVzID0gW1xyXG4gICAgICAgICAgICB7IHByb3BlcnR5SUQ6IEF1dG9BY3Rpdml0eVByb3BlcnR5S2V5cy5OYW1lLCBwcm9wZXJ0eU5hbWU6IG14UmVzb3VyY2VzLmdldCgnbmFtZScpLCBwcm9wZXJ0eVR5cGU6ICdzdHJpbmcnLCB2aXNpYmxlOiAhdGhpcy5lZGl0b3JVaS5tdWx0aUxhbmdFbmFibGVkIH0sXHJcbiAgICAgICAgICAgIHsgcHJvcGVydHlJRDogQXV0b0FjdGl2aXR5UHJvcGVydHlLZXlzLk5hbWVMYW5ndWFnZSwgcHJvcGVydHlOYW1lOiBteFJlc291cmNlcy5nZXQoJ25hbWVMYW5ndWFnZScpLCBwcm9wZXJ0eVR5cGU6ICdtdWx0aUxhbmd1YWdlJywgdmlzaWJsZTogdGhpcy5lZGl0b3JVaS5tdWx0aUxhbmdFbmFibGVkIH0sXHJcbiAgICAgICAgICAgIHsgcHJvcGVydHlJRDogQXV0b0FjdGl2aXR5UHJvcGVydHlLZXlzLklkLCBwcm9wZXJ0eU5hbWU6IG14UmVzb3VyY2VzLmdldCgnaWQnKSwgcHJvcGVydHlUeXBlOiAnc3RyaW5nJywgcmVhZG9ubHk6IHRydWUgfVxyXG4gICAgICAgIF07XHJcblxyXG5cclxuICAgICAgICBhY3Rpdml0eVByb3BlcnR5LmNhdGVnb3J5SWQgPSAnYWN0aXZpdHlQcm9wZXJ0eSc7XHJcbiAgICAgICAgYWN0aXZpdHlQcm9wZXJ0eS5jYXRlZ29yeU5hbWUgPSBteFJlc291cmNlcy5nZXQoJ2FjdGl2aXR5UHJvcGVydHknKTtcclxuICAgICAgICBhY3Rpdml0eVByb3BlcnR5LnRhYklkID0gJ2Jhc2ljJztcclxuICAgICAgICBhY3Rpdml0eVByb3BlcnR5LnRhYk5hbWUgPSBteFJlc291cmNlcy5nZXQoJ2Jhc2ljQXR0cmlidXRlcycpO1xyXG4gICAgICAgIGFjdGl2aXR5UHJvcGVydHkucHJvcGVydGllcyA9IFtcclxuICAgICAgICAgICAgeyBwcm9wZXJ0eUlEOiBBdXRvQWN0aXZpdHlQcm9wZXJ0eUtleXMuVG9vbHMsIHByb3BlcnR5TmFtZTogbXhSZXNvdXJjZXMuZ2V0KCd0b29scycpLCBwcm9wZXJ0eVR5cGU6ICdtb2RhbCcgfSxcclxuICAgICAgICAgICAgeyBwcm9wZXJ0eUlEOiBBdXRvQWN0aXZpdHlQcm9wZXJ0eUtleXMudmFyaWFibGVTZXR0aW5ncywgcHJvcGVydHlOYW1lOiBteFJlc291cmNlcy5nZXQoJ3ZhcmlhYmxlU2V0dGluZ3MnKSwgcHJvcGVydHlUeXBlOiAnbW9kYWwnIH0sXHJcbiAgICAgICAgXTtcclxuXHJcbiAgICAgICAgcHJvcGVydHlEYXRhW0F1dG9BY3Rpdml0eVByb3BlcnR5S2V5cy5JZF0gPSBhY3QuSWQ7XHJcbiAgICAgICAgcHJvcGVydHlEYXRhW0F1dG9BY3Rpdml0eVByb3BlcnR5S2V5cy5DbHJUeXBlSURdID0gYWN0LkNsclR5cGVJRDtcclxuICAgICAgICBwcm9wZXJ0eURhdGFbQXV0b0FjdGl2aXR5UHJvcGVydHlLZXlzLk5hbWVdID0gYWN0Lk5hbWU7XHJcbiAgICAgICAgcHJvcGVydHlEYXRhW0F1dG9BY3Rpdml0eVByb3BlcnR5S2V5cy5OYW1lTGFuZ3VhZ2VdID0gYWN0Lk5hbWVMYW5ndWFnZSB8fCB7XHJcbiAgICAgICAgICAgIFwiemgtQ0hTXCI6IGFjdC5OYW1lLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgcHJvcGVydHlEYXRhW0F1dG9BY3Rpdml0eVByb3BlcnR5S2V5cy5Ub29sc10gPSBQcm9wZXJ0eUhlbHBlci5nZXRCaXpDb21wb25lbnRMaXN0KGFjdC50b29scyBhcyBBcnJheTxDb21wb25lbnQ+KTtcclxuICAgICAgICBwcm9wZXJ0eURhdGFbQXV0b0FjdGl2aXR5UHJvcGVydHlLZXlzLnZhcmlhYmxlU2V0dGluZ3NdID0gUHJvcGVydHlIZWxwZXIuZ2V0VmFyaWFibGVTZXR0aW5ncyhhY3QuTW9kZWwsIGFjdC52YXJpYWJsZVNldHRpbmdzKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgcHJvcGVydHlDb25maWc6IFtiYXNpY1Byb3BlcnR5LCBhY3Rpdml0eVByb3BlcnR5XSxcclxuICAgICAgICAgICAgcHJvcGVydHlEYXRhOiBwcm9wZXJ0eURhdGFcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlUHJvcHMob2JqOiBhbnkpIHtcclxuICAgICAgICBjb25zdCBhdXRvQWN0aXZpdHkgPSB0aGlzLmZsb3dFbGVtZW50O1xyXG4gICAgICAgIGNvbnN0IHByb3BlcnR5SWQ6IHN0cmluZyA9IG9iai5wcm9wZXJ0eUlEO1xyXG4gICAgICAgIHN3aXRjaCAocHJvcGVydHlJZCkge1xyXG4gICAgICAgICAgICBjYXNlIEF1dG9BY3Rpdml0eVByb3BlcnR5S2V5cy5Ub29sczpcclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQXV0b0FjdGl2aXR5VG9vbHMoYXV0b0FjdGl2aXR5LCBvYmopO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgQXV0b0FjdGl2aXR5UHJvcGVydHlLZXlzLnZhcmlhYmxlU2V0dGluZ3M6XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZhcmlhYmxlU2V0dGluZ3MoYXV0b0FjdGl2aXR5LCBvYmopO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICBzdXBlci51cGRhdGVQcm9wcyhvYmopO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZUF1dG9BY3Rpdml0eVRvb2xzKGF1dG9BY3Rpdml0eTogQXV0b0FjdGl2aXR5LCBvYmo6IGFueSkge1xyXG4gICAgICAgIGxldCB0b29scyA9IG9iai5wcm9wZXJ0eVZhbHVlIGFzIGFueVtdO1xyXG4gICAgICAgIGF1dG9BY3Rpdml0eS50b29scyA9IG5ldyBBcnJheTxUb29sPigpO1xyXG4gICAgICAgIGlmICh0b29scyAmJiB0b29scy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgdG9vbCBvZiB0b29scykge1xyXG4gICAgICAgICAgICAgICAgbGV0IGNvbXBvbmVudCA9IG5ldyBDb21wb25lbnQoYXV0b0FjdGl2aXR5Lk1vZGVsKTtcclxuICAgICAgICAgICAgICAgIGNvbXBvbmVudC5JZCA9IHRvb2wuaWQ7XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnQuTmFtZSA9IHRvb2wubmFtZTtcclxuICAgICAgICAgICAgICAgIC8vIGNvbXBvbmVudC5UaW1lID0gdG9vbC5leGVjdXRpb25UaW1lO1xyXG4gICAgICAgICAgICAgICAgLy8gVE9ETyDlhpnmrbvkuobmnoTku7bnsbvlnotcclxuICAgICAgICAgICAgICAgIGNvbXBvbmVudC5Db21wb25lbnRUeXBlID0gJ1dlYlNlcnZpY2VDb21wb25lbnQnO1xyXG4gICAgICAgICAgICAgICAgY29tcG9uZW50Lk1ldGFkYXRhSWQgPSB0b29sLm1ldGFkYXRhSWQ7XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnQuTWV0aG9kQ29kZSA9IHRvb2wubWV0aG9kQ29kZTtcclxuICAgICAgICAgICAgICAgIGNvbXBvbmVudC5pc0ZvckNvbXBlbnNhdGlvbiA9IHRvb2wuaXNGb3JDb21wZW5zYXRpb247XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnQuQWN0dWFsUGFyYW1ldGVycyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRvb2wuYWN0dWFsUGFyYW1ldGVycyAmJiAodG9vbC5hY3R1YWxQYXJhbWV0ZXJzIGFzIGFueVtdKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgYSBvZiAodG9vbC5hY3R1YWxQYXJhbWV0ZXJzIGFzIGFueVtdKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGFyYW1ldGVyID0gbmV3IEFjdHVhbFBhcmFtZXRlcihhdXRvQWN0aXZpdHkuTW9kZWwsIGEuY29kZSwgYS52YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudC5BY3R1YWxQYXJhbWV0ZXJzLnB1c2gocGFyYW1ldGVyKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBhdXRvQWN0aXZpdHkudG9vbHMucHVzaChjb21wb25lbnQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZVZhcmlhYmxlU2V0dGluZ3MoYXV0b0FjdGl2aXR5OiBBdXRvQWN0aXZpdHksIG9iajogYW55KSB7XHJcbiAgICAgICAgY29uc3QgYnBtbk1vZGVsID0gYXV0b0FjdGl2aXR5Lk1vZGVsO1xyXG4gICAgICAgIGNvbnN0IGV4dGVuZEVsZW1lbnRzID0gYnBtbk1vZGVsLkRlZmF1bHRQcm9jZXNzLkdldEV4dGVuc2lvbkVsZW1lbnRzKCk7XHJcbiAgICAgICAgaWYgKGF1dG9BY3Rpdml0eS52YXJpYWJsZVNldHRpbmdzICYmIGF1dG9BY3Rpdml0eS52YXJpYWJsZVNldHRpbmdzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgZm9yIChjb25zdCB2IG9mIGF1dG9BY3Rpdml0eS52YXJpYWJsZVNldHRpbmdzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodi50YWcgPT09ICdjb21wb25lbnQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaSA9IGV4dGVuZEVsZW1lbnRzLmZpbmRJbmRleChlID0+IChlIGluc3RhbmNlb2YgQ29tcG9uZW50ICYmIGUuSWQgPT09IHYudmFsdWUpKTtcclxuICAgICAgICAgICAgICAgICAgICBleHRlbmRFbGVtZW50cy5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgYXV0b0FjdGl2aXR5LnZhcmlhYmxlU2V0dGluZ3MgPSBuZXcgQXJyYXkoKTtcclxuXHJcbiAgICAgICAgY29uc3QgdmFyaWFibGVzID0gb2JqLnByb3BlcnR5VmFsdWUgYXMgYW55W107XHJcbiAgICAgICAgaWYgKHZhcmlhYmxlcyAmJiB2YXJpYWJsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHYgb2YgdmFyaWFibGVzKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB2YXJpYWJsZVNldHRpbmcgPSBuZXcgVmFyaWFibGVTZXR0aW5nKGJwbW5Nb2RlbCk7XHJcbiAgICAgICAgICAgICAgICB2YXJpYWJsZVNldHRpbmcudmFyaWFibGVDb2RlID0gdi52YXJpYWJsZUNvZGU7XHJcbiAgICAgICAgICAgICAgICB2YXJpYWJsZVNldHRpbmcudmFyaWFibGVOYW1lID0gdi52YXJpYWJsZU5hbWU7XHJcbiAgICAgICAgICAgICAgICB2YXJpYWJsZVNldHRpbmcudGFnID0gdi50YWc7XHJcbiAgICAgICAgICAgICAgICB2YXJpYWJsZVNldHRpbmcuZXhlY3V0aW9uVGltZSA9IHYuZXhlY3V0aW9uVGltZTtcclxuICAgICAgICAgICAgICAgIHZhcmlhYmxlU2V0dGluZy52YWx1ZSA9IHYudmFsdWU7XHJcbiAgICAgICAgICAgICAgICB2YXJpYWJsZVNldHRpbmcudmFsdWVUZXh0ID0gdi52YWx1ZVRleHQ7XHJcblxyXG4gICAgICAgICAgICAgICAgYXV0b0FjdGl2aXR5LnZhcmlhYmxlU2V0dGluZ3MucHVzaCh2YXJpYWJsZVNldHRpbmcpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHZhcmlhYmxlU2V0dGluZy50YWcgPT09ICdjb21wb25lbnQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYyA9IHYuY29tcG9uZW50O1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBjcHQgPSBuZXcgQ29tcG9uZW50KGJwbW5Nb2RlbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNwdC5NZXRhZGF0YUlkID0gYy5NZXRhZGF0YUlkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjcHQuTWV0aG9kQ29kZSA9IGMuTWV0aG9kQ29kZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3B0LklkID0gYy5JZDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3B0Lk5hbWUgPSBjLk5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNwdC5BY3R1YWxQYXJhbWV0ZXJzID0gbmV3IEFycmF5KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjLkFjdHVhbFBhcmFtZXRlcnMgJiYgYy5BY3R1YWxQYXJhbWV0ZXJzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGEgb2YgYy5BY3R1YWxQYXJhbWV0ZXJzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBhcmFtZXRlciA9IG5ldyBBY3R1YWxQYXJhbWV0ZXIoYnBtbk1vZGVsLCBhLk5hbWUsIGEuVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlci5UYWcgPSBhLlRhZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcHQuQWN0dWFsUGFyYW1ldGVycy5wdXNoKHBhcmFtZXRlcik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4dGVuZEVsZW1lbnRzLnB1c2goY3B0KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19