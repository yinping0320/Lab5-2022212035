/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, ViewChild, Input } from '@angular/core';
import { FarrisPageDetailComponent } from '@farris/ui-wizard';
import { TreeTableComponent } from '@farris/ui-treetable';
// import { MessagerService } from '@farris/ui-messager';
export class SelectObjElementComponent {
    constructor() {
        this.gridData = {};
        this.gridCols = [
            { field: 'show', title: '显示', width: 40 },
            { field: 'Name', title: '字段名称' },
            { field: 'Code', title: '字段编号', width: 200 },
            { field: 'LabelID', title: '字段标签' },
            { field: 'MDataType', title: '字段类型' }
        ];
        this.grid_selected = {
            selectedAll: {}
        };
        this.readonlyFields = []; // 不可取消勾选的字段
        // 不可取消勾选的字段
        this.selectedAll = {};
        this.selectedTreeKeys = [];
        this.selectedTreeKey = '';
        this.enableNextStep = true;
        this.detailPage = null;
    }
    /**
     * @param {?} cmp
     * @return {?}
     */
    set cmpPageDetail(cmp) {
        this.detailPage = cmp;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.load();
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        this.load();
    }
    /**
     * @return {?}
     */
    load() {
        /** @type {?} */
        const obj = this.detailPage.getPageData('selectobject');
        if (this.data && this.data.selectedObj) {
            /** @type {?} */
            const parentTable = (/** @type {?} */ (this.data.selectedObj));
            this.selectedTreeKey = this.data.selectedObj.Code;
            this.selectedTreeKeys = [this.selectedTreeKey];
            this.grid_selected[this.selectedTreeKey] = this.data.selectedBeFields;
            this.gridData[parentTable.Code] = this.getGridFields(parentTable.ContainElements, parentTable.Code, false);
        }
    }
    /**
     * 获取各表字段，关联字段以树形式展示
     * @param {?} fields
     * @param {?} tableCode
     * @param {?} needSelectAll
     * @return {?}
     */
    getGridFields(fields, tableCode, needSelectAll) {
        /** @type {?} */
        const gridData = [];
        /** @type {?} */
        const fieldIdList = [];
        if (!fields || fields.length === 0) {
            return [];
        }
        fields.forEach((/**
         * @param {?} field
         * @return {?}
         */
        field => {
            const { ChildAssociations } = field, fieldObject = tslib_1.__rest(field, ["ChildAssociations"]);
            /** @type {?} */
            const children = [];
            if (this.data.assoRefElement) {
                // 关联表
                if (ChildAssociations && ChildAssociations.length > 0) {
                    ChildAssociations.forEach((/**
                     * @param {?} child
                     * @return {?}
                     */
                    child => {
                        child.RefElementCollection.forEach((/**
                         * @param {?} refEle
                         * @return {?}
                         */
                        refEle => {
                            children.push({ data: refEle, children: [], expanded: true, layer: 2 });
                            fieldIdList.push(refEle.ID);
                        }));
                    }));
                }
            }
            gridData.push({ data: fieldObject, children: children, expanded: true, layer: 1 });
            fieldIdList.push(fieldObject.ID);
        }));
        //  默认选中所有字段
        if (needSelectAll) {
            this.grid_selected[tableCode] = fieldIdList;
            this.grid_selected['selectedAll'][tableCode] = true;
        }
        return gridData;
    }
    /**
     * @param {?} rowData
     * @param {?} rowNode
     * @return {?}
     */
    changeCheckbox(rowData, rowNode) {
        /** @type {?} */
        const ID = rowData.ID;
        /** @type {?} */
        const index = this.grid_selected[this.selectedTreeKey].indexOf(ID);
        if (index >= 0) {
            this.grid_selected[this.selectedTreeKey].splice(index, 1);
            this.grid_selected['selectedAll'][this.selectedTreeKey] = false;
        }
        else {
            // 若为[单选]，则清空已选择字段
            if (this.data.singleElement) {
                this.grid_selected[this.selectedTreeKey] = [];
            }
            this.grid_selected[this.selectedTreeKey].push(ID);
        }
        // 主表的关联字段
        if (rowNode.children.length > 0) {
            rowNode.children.forEach((/**
             * @param {?} element
             * @return {?}
             */
            element => {
                /** @type {?} */
                const reIndex = this.grid_selected[this.selectedTreeKey].findIndex((/**
                 * @param {?} id
                 * @return {?}
                 */
                id => id === element.data.ID));
                if (index >= 0 && reIndex >= 0) {
                    this.grid_selected[this.selectedTreeKey].splice(reIndex, 1);
                }
                if (index < 0 && reIndex < 0) {
                    this.grid_selected[this.selectedTreeKey].push(element.data.ID);
                }
            }));
        }
        // 关联表的字段
        if (rowNode.parent) {
            /** @type {?} */
            const parentNode = rowNode.parent;
            if (!parentNode) {
                return;
            }
            /** @type {?} */
            const parentIndex = this.grid_selected[this.selectedTreeKey].indexOf(parentNode.data.ID);
            if (index < 0 && parentIndex < 0) {
                this.grid_selected[this.selectedTreeKey].push(parentNode.data.ID);
            }
        }
    }
    /**
     * @return {?}
     */
    clickSelectAllCheckbox() {
        this.selectAllChange(this.gridData[this.selectedTreeKey], this.grid_selected['selectedAll'][this.selectedTreeKey]);
    }
    /**
     * 全选
     * @param {?} treeData treeData
     * @param {?} isSelected isSelected
     * @return {?}
     */
    selectAllChange(treeData, isSelected) {
        if (treeData.length === 0) {
            return;
        }
        treeData.forEach((/**
         * @param {?} treeNode
         * @return {?}
         */
        treeNode => {
            /** @type {?} */
            const ID = treeNode.data.ID;
            if (treeNode.children && treeNode.children.length > 0) {
                this.selectAllChange(treeNode.children, isSelected);
            }
            /** @type {?} */
            const index = this.grid_selected[this.selectedTreeKey].indexOf(ID);
            // 全选
            if (isSelected && index < 0) {
                this.grid_selected[this.selectedTreeKey].push(ID);
                return;
            }
            // 取消全选
            if (!isSelected && this.readonlyFields.indexOf(ID) < 0) {
                this.grid_selected[this.selectedTreeKey].splice(index, 1);
            }
        }));
    }
    /**
     * @return {?}
     */
    prevStep() {
        this.detailPage.prevStep();
    }
    /**
     * @return {?}
     */
    finish() {
        // 校验
        if (this.grid_selected[this.selectedTreeKey].length === 0) {
            // this.messagerService.warning('请勾选字段。');
            alert('请勾选字段。');
            return;
        }
        // 设置当前页传递出去数据
        this.data.selectedBeFields = [this.grid_selected[this.selectedTreeKey]];
        this.detailPage.setPageData(this.data.selectedBeFields);
        // 下一步
        this.detailPage.finishWizard();
    }
    /**
     * @return {?}
     */
    cancel() {
        this.detailPage.cancelWizard();
    }
    /**
     * @param {?} args
     * @return {?}
     */
    pagedetailSelected(args) {
    }
}
SelectObjElementComponent.decorators = [
    { type: Component, args: [{
                selector: 'select-obj-element',
                template: "<wizard-page-detail #detailpage2 (pagedetailSelected)=\"pagedetailSelected($event)\">\r\n    <ng-template wizardPageContent>\r\n        <div class=\"f-template-wizard-page-content\" style=\"margin-left:2px\">\r\n            <farris-treetable #treeTable [data]=\"gridData[selectedTreeKey]\" [columns]=\"gridCols\" [idField]=\"'ID'\" [fixedHeader]=\"true\" [width]=\"'100%'\" [height]=\"330\" [showFilterBar]=\"false\" [showIcon]=\"false\" [resizableColumns]=\"true\" [cascadeCheck]=\"true\" [showBorder]=\"false\"\r\n                class=\"f-selectbe-treetable\">\r\n                <ng-template farrisTemplate=\"header\" let-columns>\r\n                    <tr>\r\n                        <ng-container *ngFor=\"let col of columns; let i = index\">\r\n\r\n                            <th *ngIf=\"col.field!=='show'\">\r\n                                <ng-container> {{col.title}} </ng-container>\r\n                            </th>\r\n                            <th *ngIf=\"col.field==='show'\" [width]=\"col.width\">\r\n                                <ng-container>\r\n                                    <div class=\"custom-control custom-checkbox f-checkradio-single\">\r\n                                        <!-- <input class=\"custom-control-input\" id=\"CheckAll\" type=\"checkbox\" [(ngModel)]=\"grid_selected.selectedAll[selectedTreeKey]\" (ngModelChange)=\"clickSelectAllCheckbox()\" />\r\n                                        <label class=\"custom-control-label\" for=\"CheckAll\"></label> -->\r\n                                    </div>\r\n                                </ng-container>\r\n                            </th>\r\n                            <th *ngIf=\"col.field==='toggler'\" [width]=\"col.width\">\r\n                            </th>\r\n                        </ng-container>\r\n\r\n                    </tr>\r\n                </ng-template>\r\n                <ng-template farrisTemplate=\"body\" let-rowNode let-rowIndex=\"index\" let-rowData=\"rowData\" let-columns=\"columns\">\r\n                    <tr [selectRow]=\"rowNode\" [rowIndex]=\"rowIndex\" [dblclick]=\"true\" [selectRowDisabled]=\"true\">\r\n                        <ng-container *ngFor=\"let col of columns; let i = index\">\r\n                            <td *ngIf=\"col.field==='show'\" [width]=\"col.width\">\r\n                                <ng-container *ngIf=\"!rowNode.node.tableNode  && readonlyFields.indexOf(rowData.ID)<0\">\r\n                                    <div class=\"custom-control custom-checkbox f-checkradio-single\">\r\n                                        <input type=\"checkbox\" [id]=\"rowData.ID\" class=\"custom-control-input\" [checked]=\"grid_selected[selectedTreeKey] && grid_selected[selectedTreeKey].indexOf(rowData.ID)>=0\" (click)=\"changeCheckbox(rowData,rowNode.node)\">\r\n                                        <label class=\"custom-control-label\" [for]=\"rowData.ID\"></label>\r\n                                    </div>\r\n                                </ng-container>\r\n\r\n                                <ng-container *ngIf=\"!rowNode.node.tableNode && readonlyFields.indexOf(rowData.ID)>=0\">\r\n                                    <div class=\"custom-control custom-checkbox f-checkradio-single\">\r\n                                        <input type=\"checkbox\" [id]=\"rowData.ID\" class=\"custom-control-input\" checked=\"checked\" disabled>\r\n                                        <label class=\"custom-control-label\" [for]=\"rowData.ID\"></label>\r\n                                    </div>\r\n                                </ng-container>\r\n                            </td>\r\n                            <td *ngIf=\"col.field!=='show'\">\r\n                                <farris-treeTableToggler [rowNode]=\"rowNode\" *ngIf=\"i == 1\"></farris-treeTableToggler>\r\n                                <ng-container *ngIf=\"col.field!=='MDataType'\">\r\n                                    <span [title]=\"rowData[col.field]\">{{rowData[col.field]}}</span>\r\n                                </ng-container>\r\n                                <ng-container *ngIf=\"col.field ==='MDataType' && rowData.IsUdt\">\r\n                                    <span [title]=\"rowData[col.field]\">{{rowData.UdtName}}</span>\r\n                                </ng-container>\r\n                                <ng-container *ngIf=\"col.field ==='MDataType' && !rowData.IsUdt\">\r\n                                    <span [title]=\"rowData[col.field]\">{{rowData.MDataType}}</span>\r\n                                </ng-container>\r\n                            </td>\r\n                        </ng-container>\r\n                    </tr>\r\n                </ng-template>\r\n\r\n            </farris-treetable>\r\n        </div>\r\n    </ng-template>\r\n    <ng-template wizardPageFooter>\r\n        <div class=\"f-template-wizard-page-footer\">\r\n            <button class=\"btn btn-secondary\" (click)=\"prevStep()\">\u4E0A\u4E00\u6B65</button>\r\n            <button class=\"btn btn-secondary\" (click)=\"cancel()\">\u53D6\u6D88</button>\r\n            <button class=\"btn btn-primary\" [disabled]=\"!enableNextStep\" (click)=\"finish()\">\u5B8C\u6210</button>\r\n        </div>\r\n    </ng-template>\r\n</wizard-page-detail>",
                styles: [":host{display:flex;flex:1}button{margin:10px}"]
            }] }
];
/** @nocollapse */
SelectObjElementComponent.ctorParameters = () => [];
SelectObjElementComponent.propDecorators = {
    data: [{ type: Input }],
    changeObj: [{ type: Input }],
    treeTable: [{ type: ViewChild, args: ['treeTable',] }],
    cmpPageDetail: [{ type: ViewChild, args: [FarrisPageDetailComponent,] }]
};
if (false) {
    /** @type {?} */
    SelectObjElementComponent.prototype.data;
    /** @type {?} */
    SelectObjElementComponent.prototype.changeObj;
    /**
     * 右侧树表信息
     * @type {?}
     */
    SelectObjElementComponent.prototype.treeTable;
    /** @type {?} */
    SelectObjElementComponent.prototype.gridData;
    /** @type {?} */
    SelectObjElementComponent.prototype.gridCols;
    /** @type {?} */
    SelectObjElementComponent.prototype.grid_selected;
    /** @type {?} */
    SelectObjElementComponent.prototype.readonlyFields;
    /** @type {?} */
    SelectObjElementComponent.prototype.selectedAll;
    /** @type {?} */
    SelectObjElementComponent.prototype.selectedTreeKeys;
    /** @type {?} */
    SelectObjElementComponent.prototype.selectedTreeKey;
    /** @type {?} */
    SelectObjElementComponent.prototype.enableNextStep;
    /**
     * @type {?}
     * @private
     */
    SelectObjElementComponent.prototype.detailPage;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LW9iai1lbGVtZW50LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bnc3Atd2Yvd2YtZGltZW5zaW9uLWRlZi8iLCJzb3VyY2VzIjpbImxpYi9yZWZNb2R1bGUvc2VsZWN0LWVsZW1lbnQvc3RlcHMvc2VsZWN0LW9iai1lbGVtZW50L3NlbGVjdC1vYmotZWxlbWVudC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFxQixTQUFTLEVBQUUsS0FBSyxFQUFpQixNQUFNLGVBQWUsQ0FBQztBQUM5RixPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQzs7QUFTMUQsTUFBTSxPQUFPLHlCQUF5QjtJQTRDcEM7UUF6QkEsYUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNkLGFBQVEsR0FBRztZQUNULEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUU7WUFDekMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUU7WUFDaEMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRTtZQUM1QyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRTtZQUNuQyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRTtTQUN0QyxDQUFDO1FBQ0Ysa0JBQWEsR0FBRztZQUNkLFdBQVcsRUFBRSxFQUFFO1NBQ2hCLENBQUM7UUFDRixtQkFBYyxHQUFHLEVBQUUsQ0FBQyxDQUFDLFlBQVk7O1FBQ2pDLGdCQUFXLEdBQUcsRUFBRSxDQUFDO1FBRWpCLHFCQUFnQixHQUFHLEVBQUUsQ0FBQztRQUN0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QU0sS0FBSyxDQUFDLEVBQUU7WUFDekQsMENBQTBDO1lBQzFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNoQixPQUFPO1NBQ1I7UUFDRCxjQUFjO1FBQ2QsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7UUFDeEUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3hELE1BQU07UUFDTixJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ2pDLENBQUM7Ozs7SUFDRCxNQUFNO1FBQ0osSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUNqQyxDQUFDOzs7OztJQUNELGtCQUFrQixDQUFDLElBQUk7SUFFdkIsQ0FBQzs7O1lBM01GLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsb0JBQW9CO2dCQUM5Qiw2c0tBQWtEOzthQUVuRDs7Ozs7bUJBY0UsS0FBSzt3QkFDTCxLQUFLO3dCQUlMLFNBQVMsU0FBQyxXQUFXOzRCQW9CckIsU0FBUyxTQUFDLHlCQUF5Qjs7OztJQXpCcEMseUNBQWM7O0lBQ2QsOENBQW1COzs7OztJQUluQiw4Q0FBc0Q7O0lBQ3RELDZDQUFjOztJQUNkLDZDQU1FOztJQUNGLGtEQUVFOztJQUNGLG1EQUFvQjs7SUFDcEIsZ0RBQWlCOztJQUVqQixxREFBc0I7O0lBQ3RCLG9EQUFxQjs7SUFFckIsbURBQXNCOzs7OztJQUN0QiwrQ0FBcUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgT25DaGFuZ2VzLCBWaWV3Q2hpbGQsIElucHV0LCBTaW1wbGVDaGFuZ2VzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEZhcnJpc1BhZ2VEZXRhaWxDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLXdpemFyZCc7XHJcbmltcG9ydCB7IFRyZWVUYWJsZUNvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktdHJlZXRhYmxlJztcclxuaW1wb3J0IHsgSUdTUENvbW1vbkVsZW1lbnQsIEdTUENvbW1vbk9iamVjdCB9IGZyb20gJ0Bnc3AtYmVmL2dzcC1jbS1tZXRhZGF0YSc7XHJcbi8vIGltcG9ydCB7IE1lc3NhZ2VyU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbWVzc2FnZXInO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdzZWxlY3Qtb2JqLWVsZW1lbnQnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9zZWxlY3Qtb2JqLWVsZW1lbnQuY29tcG9uZW50Lmh0bWwnLFxyXG4gIHN0eWxlVXJsczogWycuL3NlbGVjdC1vYmotZWxlbWVudC5jb21wb25lbnQuY3NzJ11cclxufSlcclxuZXhwb3J0IGNsYXNzIFNlbGVjdE9iakVsZW1lbnRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcyB7XHJcblxyXG4gIC8vIC8qKlxyXG4gIC8vICAgKiDovpPlhaXlj4LmlbDmoLzlvI9cclxuICAvLyAgICovXHJcbiAgLy8gZGF0YSA9IHtcclxuICAvLyAgIGJlOiBudWxsLCAgICAgICAgICAgICAgLy8gYmXlrp7kvZNcclxuICAvLyAgIHNlbGVjdGVkT2JqOiBudWxsLCAgICAgLy8gYmXoioLngrlcclxuICAvLyAgIEJlRmllbGRzOiBbXSwgICAgICAgICAgLy8gQmXlrZfmrrXliJfooahcclxuICAvLyAgIHNlbGVjdGVkQmVGaWVsZHM6IFtdLCAgLy8gQmXlrZfmrrVJROWIl+ihqFxyXG4gIC8vICAgc2luZ2xlRWxlbWVudDogZmFsc2UsICAvLyDmmK/lkKbljZXpgIlcclxuICAvLyAgIGFzc29SZWZFbGVtZW50OiBmYWxzZSAgLy8g5piv5ZCm5YyF5ZCr5YWz6IGU5bim5Ye65a2X5q61XHJcbiAgLy8gfTtcclxuICBASW5wdXQoKSBkYXRhO1xyXG4gIEBJbnB1dCgpIGNoYW5nZU9iajtcclxuXHJcblxyXG4gIC8qKiDlj7PkvqfmoJHooajkv6Hmga8gKi9cclxuICBAVmlld0NoaWxkKCd0cmVlVGFibGUnKSB0cmVlVGFibGU6IFRyZWVUYWJsZUNvbXBvbmVudDtcclxuICBncmlkRGF0YSA9IHt9O1xyXG4gIGdyaWRDb2xzID0gW1xyXG4gICAgeyBmaWVsZDogJ3Nob3cnLCB0aXRsZTogJ+aYvuekuicsIHdpZHRoOiA0MCB9LFxyXG4gICAgeyBmaWVsZDogJ05hbWUnLCB0aXRsZTogJ+Wtl+auteWQjeensCcgfSxcclxuICAgIHsgZmllbGQ6ICdDb2RlJywgdGl0bGU6ICflrZfmrrXnvJblj7cnLCB3aWR0aDogMjAwIH0sXHJcbiAgICB7IGZpZWxkOiAnTGFiZWxJRCcsIHRpdGxlOiAn5a2X5q615qCH562+JyB9LFxyXG4gICAgeyBmaWVsZDogJ01EYXRhVHlwZScsIHRpdGxlOiAn5a2X5q6157G75Z6LJyB9XHJcbiAgXTtcclxuICBncmlkX3NlbGVjdGVkID0ge1xyXG4gICAgc2VsZWN0ZWRBbGw6IHt9XHJcbiAgfTtcclxuICByZWFkb25seUZpZWxkcyA9IFtdOyAvLyDkuI3lj6/lj5bmtojli77pgInnmoTlrZfmrrVcclxuICBzZWxlY3RlZEFsbCA9IHt9O1xyXG5cclxuICBzZWxlY3RlZFRyZWVLZXlzID0gW107XHJcbiAgc2VsZWN0ZWRUcmVlS2V5ID0gJyc7XHJcblxyXG4gIGVuYWJsZU5leHRTdGVwID0gdHJ1ZTtcclxuICBwcml2YXRlIGRldGFpbFBhZ2U6IEZhcnJpc1BhZ2VEZXRhaWxDb21wb25lbnQgPSBudWxsO1xyXG4gIEBWaWV3Q2hpbGQoRmFycmlzUGFnZURldGFpbENvbXBvbmVudCkgc2V0IGNtcFBhZ2VEZXRhaWwoXHJcbiAgICBjbXA6IEZhcnJpc1BhZ2VEZXRhaWxDb21wb25lbnRcclxuICApIHtcclxuICAgIHRoaXMuZGV0YWlsUGFnZSA9IGNtcDtcclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkgeyB9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgdGhpcy5sb2FkKCk7XHJcbiAgfVxyXG5cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XHJcbiAgICB0aGlzLmxvYWQoKTtcclxuICB9XHJcblxyXG4gIGxvYWQoKSB7XHJcbiAgICBjb25zdCBvYmogPSB0aGlzLmRldGFpbFBhZ2UuZ2V0UGFnZURhdGEoJ3NlbGVjdG9iamVjdCcpO1xyXG4gICAgaWYgKHRoaXMuZGF0YSAmJiB0aGlzLmRhdGEuc2VsZWN0ZWRPYmopIHtcclxuICAgICAgY29uc3QgcGFyZW50VGFibGUgPSB0aGlzLmRhdGEuc2VsZWN0ZWRPYmogYXMgR1NQQ29tbW9uT2JqZWN0O1xyXG4gICAgICB0aGlzLnNlbGVjdGVkVHJlZUtleSA9IHRoaXMuZGF0YS5zZWxlY3RlZE9iai5Db2RlO1xyXG4gICAgICB0aGlzLnNlbGVjdGVkVHJlZUtleXMgPSBbdGhpcy5zZWxlY3RlZFRyZWVLZXldO1xyXG4gICAgICB0aGlzLmdyaWRfc2VsZWN0ZWRbdGhpcy5zZWxlY3RlZFRyZWVLZXldID0gdGhpcy5kYXRhLnNlbGVjdGVkQmVGaWVsZHM7XHJcbiAgICAgIHRoaXMuZ3JpZERhdGFbcGFyZW50VGFibGUuQ29kZV0gPSB0aGlzLmdldEdyaWRGaWVsZHMocGFyZW50VGFibGUuQ29udGFpbkVsZW1lbnRzLCBwYXJlbnRUYWJsZS5Db2RlLCBmYWxzZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blkITooajlrZfmrrXvvIzlhbPogZTlrZfmrrXku6XmoJHlvaLlvI/lsZXnpLpcclxuICAgKiBAcGFyYW0gZmllbGRzXHJcbiAgICovXHJcbiAgZ2V0R3JpZEZpZWxkcyhmaWVsZHM6IElHU1BDb21tb25FbGVtZW50W10sIHRhYmxlQ29kZTogc3RyaW5nLCBuZWVkU2VsZWN0QWxsOiBib29sZWFuKSB7XHJcbiAgICBjb25zdCBncmlkRGF0YSA9IFtdO1xyXG4gICAgY29uc3QgZmllbGRJZExpc3QgPSBbXTtcclxuICAgIGlmICghZmllbGRzIHx8IGZpZWxkcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG4gICAgZmllbGRzLmZvckVhY2goZmllbGQgPT4ge1xyXG4gICAgICBjb25zdCB7IENoaWxkQXNzb2NpYXRpb25zLCAuLi5maWVsZE9iamVjdCB9ID0gZmllbGQ7XHJcbiAgICAgIGNvbnN0IGNoaWxkcmVuID0gW107XHJcblxyXG4gICAgICBpZiAodGhpcy5kYXRhLmFzc29SZWZFbGVtZW50KSB7XHJcbiAgICAgICAgLy8g5YWz6IGU6KGoXHJcbiAgICAgICAgaWYgKENoaWxkQXNzb2NpYXRpb25zICYmIENoaWxkQXNzb2NpYXRpb25zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIENoaWxkQXNzb2NpYXRpb25zLmZvckVhY2goY2hpbGQgPT4ge1xyXG4gICAgICAgICAgICBjaGlsZC5SZWZFbGVtZW50Q29sbGVjdGlvbi5mb3JFYWNoKHJlZkVsZSA9PiB7XHJcbiAgICAgICAgICAgICAgY2hpbGRyZW4ucHVzaCh7IGRhdGE6IHJlZkVsZSwgY2hpbGRyZW46IFtdLCBleHBhbmRlZDogdHJ1ZSwgbGF5ZXI6IDIgfSk7XHJcbiAgICAgICAgICAgICAgZmllbGRJZExpc3QucHVzaChyZWZFbGUuSUQpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgZ3JpZERhdGEucHVzaCh7IGRhdGE6IGZpZWxkT2JqZWN0LCBjaGlsZHJlbjogY2hpbGRyZW4sIGV4cGFuZGVkOiB0cnVlLCBsYXllcjogMSB9KTtcclxuICAgICAgZmllbGRJZExpc3QucHVzaChmaWVsZE9iamVjdC5JRCk7XHJcbiAgICB9KTtcclxuICAgIC8vICDpu5jorqTpgInkuK3miYDmnInlrZfmrrVcclxuICAgIGlmIChuZWVkU2VsZWN0QWxsKSB7XHJcbiAgICAgIHRoaXMuZ3JpZF9zZWxlY3RlZFt0YWJsZUNvZGVdID0gZmllbGRJZExpc3Q7XHJcbiAgICAgIHRoaXMuZ3JpZF9zZWxlY3RlZFsnc2VsZWN0ZWRBbGwnXVt0YWJsZUNvZGVdID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZ3JpZERhdGE7XHJcbiAgfVxyXG5cclxuICBjaGFuZ2VDaGVja2JveChyb3dEYXRhLCByb3dOb2RlKSB7XHJcbiAgICBjb25zdCBJRCA9IHJvd0RhdGEuSUQ7XHJcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuZ3JpZF9zZWxlY3RlZFt0aGlzLnNlbGVjdGVkVHJlZUtleV0uaW5kZXhPZihJRCk7XHJcblxyXG4gICAgaWYgKGluZGV4ID49IDApIHtcclxuICAgICAgdGhpcy5ncmlkX3NlbGVjdGVkW3RoaXMuc2VsZWN0ZWRUcmVlS2V5XS5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICB0aGlzLmdyaWRfc2VsZWN0ZWRbJ3NlbGVjdGVkQWxsJ11bdGhpcy5zZWxlY3RlZFRyZWVLZXldID0gZmFsc2U7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyDoi6XkuLpb5Y2V6YCJXe+8jOWImea4heepuuW3sumAieaLqeWtl+autVxyXG4gICAgICBpZiAodGhpcy5kYXRhLnNpbmdsZUVsZW1lbnQpIHtcclxuICAgICAgICB0aGlzLmdyaWRfc2VsZWN0ZWRbdGhpcy5zZWxlY3RlZFRyZWVLZXldID0gW107XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5ncmlkX3NlbGVjdGVkW3RoaXMuc2VsZWN0ZWRUcmVlS2V5XS5wdXNoKElEKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDkuLvooajnmoTlhbPogZTlrZfmrrVcclxuICAgIGlmIChyb3dOb2RlLmNoaWxkcmVuLmxlbmd0aCA+IDApIHtcclxuICAgICAgcm93Tm9kZS5jaGlsZHJlbi5mb3JFYWNoKGVsZW1lbnQgPT4ge1xyXG4gICAgICAgIGNvbnN0IHJlSW5kZXggPSB0aGlzLmdyaWRfc2VsZWN0ZWRbdGhpcy5zZWxlY3RlZFRyZWVLZXldLmZpbmRJbmRleChpZCA9PiBpZCA9PT0gZWxlbWVudC5kYXRhLklEKTtcclxuICAgICAgICBpZiAoaW5kZXggPj0gMCAmJiByZUluZGV4ID49IDApIHtcclxuICAgICAgICAgIHRoaXMuZ3JpZF9zZWxlY3RlZFt0aGlzLnNlbGVjdGVkVHJlZUtleV0uc3BsaWNlKHJlSW5kZXgsIDEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoaW5kZXggPCAwICYmIHJlSW5kZXggPCAwKSB7XHJcbiAgICAgICAgICB0aGlzLmdyaWRfc2VsZWN0ZWRbdGhpcy5zZWxlY3RlZFRyZWVLZXldLnB1c2goZWxlbWVudC5kYXRhLklEKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDlhbPogZTooajnmoTlrZfmrrVcclxuICAgIGlmIChyb3dOb2RlLnBhcmVudCkge1xyXG4gICAgICBjb25zdCBwYXJlbnROb2RlID0gcm93Tm9kZS5wYXJlbnQ7XHJcbiAgICAgIGlmICghcGFyZW50Tm9kZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBwYXJlbnRJbmRleCA9IHRoaXMuZ3JpZF9zZWxlY3RlZFt0aGlzLnNlbGVjdGVkVHJlZUtleV0uaW5kZXhPZihwYXJlbnROb2RlLmRhdGEuSUQpO1xyXG4gICAgICBpZiAoaW5kZXggPCAwICYmIHBhcmVudEluZGV4IDwgMCkge1xyXG4gICAgICAgIHRoaXMuZ3JpZF9zZWxlY3RlZFt0aGlzLnNlbGVjdGVkVHJlZUtleV0ucHVzaChwYXJlbnROb2RlLmRhdGEuSUQpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gIH1cclxuXHJcbiAgY2xpY2tTZWxlY3RBbGxDaGVja2JveCgpIHtcclxuICAgIHRoaXMuc2VsZWN0QWxsQ2hhbmdlKHRoaXMuZ3JpZERhdGFbdGhpcy5zZWxlY3RlZFRyZWVLZXldLCB0aGlzLmdyaWRfc2VsZWN0ZWRbJ3NlbGVjdGVkQWxsJ11bdGhpcy5zZWxlY3RlZFRyZWVLZXldKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWFqOmAiVxyXG4gICAqIEBwYXJhbSB0cmVlRGF0YSB0cmVlRGF0YVxyXG4gICAqIEBwYXJhbSBpc1NlbGVjdGVkIGlzU2VsZWN0ZWRcclxuICAgKi9cclxuICBzZWxlY3RBbGxDaGFuZ2UodHJlZURhdGEsIGlzU2VsZWN0ZWQ6IGJvb2xlYW4pIHtcclxuICAgIGlmICh0cmVlRGF0YS5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRyZWVEYXRhLmZvckVhY2godHJlZU5vZGUgPT4ge1xyXG4gICAgICBjb25zdCBJRCA9IHRyZWVOb2RlLmRhdGEuSUQ7XHJcbiAgICAgIGlmICh0cmVlTm9kZS5jaGlsZHJlbiAmJiB0cmVlTm9kZS5jaGlsZHJlbi5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RBbGxDaGFuZ2UodHJlZU5vZGUuY2hpbGRyZW4sIGlzU2VsZWN0ZWQpO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5ncmlkX3NlbGVjdGVkW3RoaXMuc2VsZWN0ZWRUcmVlS2V5XS5pbmRleE9mKElEKTtcclxuICAgICAgLy8g5YWo6YCJXHJcbiAgICAgIGlmIChpc1NlbGVjdGVkICYmIGluZGV4IDwgMCkge1xyXG4gICAgICAgIHRoaXMuZ3JpZF9zZWxlY3RlZFt0aGlzLnNlbGVjdGVkVHJlZUtleV0ucHVzaChJRCk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIOWPlua2iOWFqOmAiVxyXG4gICAgICBpZiAoIWlzU2VsZWN0ZWQgJiYgdGhpcy5yZWFkb25seUZpZWxkcy5pbmRleE9mKElEKSA8IDApIHtcclxuICAgICAgICB0aGlzLmdyaWRfc2VsZWN0ZWRbdGhpcy5zZWxlY3RlZFRyZWVLZXldLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICBwcmV2U3RlcCgpIHtcclxuICAgIHRoaXMuZGV0YWlsUGFnZS5wcmV2U3RlcCgpO1xyXG4gIH1cclxuICBmaW5pc2goKSB7XHJcbiAgICAvLyDmoKHpqoxcclxuICAgIGlmICh0aGlzLmdyaWRfc2VsZWN0ZWRbdGhpcy5zZWxlY3RlZFRyZWVLZXldLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAvLyB0aGlzLm1lc3NhZ2VyU2VydmljZS53YXJuaW5nKCfor7fli77pgInlrZfmrrXjgIInKTtcclxuICAgICAgYWxlcnQoJ+ivt+WLvumAieWtl+auteOAgicpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDorr7nva7lvZPliY3pobXkvKDpgJLlh7rljrvmlbDmja5cclxuICAgIHRoaXMuZGF0YS5zZWxlY3RlZEJlRmllbGRzID0gW3RoaXMuZ3JpZF9zZWxlY3RlZFt0aGlzLnNlbGVjdGVkVHJlZUtleV1dO1xyXG4gICAgdGhpcy5kZXRhaWxQYWdlLnNldFBhZ2VEYXRhKHRoaXMuZGF0YS5zZWxlY3RlZEJlRmllbGRzKTtcclxuICAgIC8vIOS4i+S4gOatpVxyXG4gICAgdGhpcy5kZXRhaWxQYWdlLmZpbmlzaFdpemFyZCgpO1xyXG4gIH1cclxuICBjYW5jZWwoKSB7XHJcbiAgICB0aGlzLmRldGFpbFBhZ2UuY2FuY2VsV2l6YXJkKCk7XHJcbiAgfVxyXG4gIHBhZ2VkZXRhaWxTZWxlY3RlZChhcmdzKSB7XHJcblxyXG4gIH1cclxufVxyXG4iXX0=