/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, ViewChild, Input } from '@angular/core';
import { FarrisPageDetailComponent } from '@farris/ui-wizard';
import { TreeTableComponent } from '@farris/ui-treetable';
// import { MessagerService } from '@farris/ui-messager';
var SelectObjElementComponent = /** @class */ (function () {
    function SelectObjElementComponent() {
        this.gridData = {};
        this.gridCols = [
            { field: 'show', title: '显示', width: 40 },
            { field: 'Name', title: '字段名称' },
            { field: 'Code', title: '字段编号', width: 200 },
            { field: 'LabelID', title: '字段标签' },
            { field: 'MDataType', title: '字段类型' }
        ];
        this.grid_selected = {
            selectedAll: {}
        };
        this.readonlyFields = []; // 不可取消勾选的字段
        // 不可取消勾选的字段
        this.selectedAll = {};
        this.selectedTreeKeys = [];
        this.selectedTreeKey = '';
        this.enableNextStep = true;
        this.detailPage = null;
    }
    Object.defineProperty(SelectObjElementComponent.prototype, "cmpPageDetail", {
        set: /**
         * @param {?} cmp
         * @return {?}
         */
        function (cmp) {
            this.detailPage = cmp;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    SelectObjElementComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.load();
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    SelectObjElementComponent.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        this.load();
    };
    /**
     * @return {?}
     */
    SelectObjElementComponent.prototype.load = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var obj = this.detailPage.getPageData('selectobject');
        if (this.data && this.data.selectedObj) {
            /** @type {?} */
            var parentTable = (/** @type {?} */ (this.data.selectedObj));
            this.selectedTreeKey = this.data.selectedObj.Code;
            this.selectedTreeKeys = [this.selectedTreeKey];
            this.grid_selected[this.selectedTreeKey] = this.data.selectedBeFields;
            this.gridData[parentTable.Code] = this.getGridFields(parentTable.ContainElements, parentTable.Code, false);
        }
    };
    /**
     * 获取各表字段，关联字段以树形式展示
     * @param fields
     */
    /**
     * 获取各表字段，关联字段以树形式展示
     * @param {?} fields
     * @param {?} tableCode
     * @param {?} needSelectAll
     * @return {?}
     */
    SelectObjElementComponent.prototype.getGridFields = /**
     * 获取各表字段，关联字段以树形式展示
     * @param {?} fields
     * @param {?} tableCode
     * @param {?} needSelectAll
     * @return {?}
     */
    function (fields, tableCode, needSelectAll) {
        var _this = this;
        /** @type {?} */
        var gridData = [];
        /** @type {?} */
        var fieldIdList = [];
        if (!fields || fields.length === 0) {
            return [];
        }
        fields.forEach((/**
         * @param {?} field
         * @return {?}
         */
        function (field) {
            var ChildAssociations = field.ChildAssociations, fieldObject = tslib_1.__rest(field, ["ChildAssociations"]);
            /** @type {?} */
            var children = [];
            if (_this.data.assoRefElement) {
                // 关联表
                if (ChildAssociations && ChildAssociations.length > 0) {
                    ChildAssociations.forEach((/**
                     * @param {?} child
                     * @return {?}
                     */
                    function (child) {
                        child.RefElementCollection.forEach((/**
                         * @param {?} refEle
                         * @return {?}
                         */
                        function (refEle) {
                            children.push({ data: refEle, children: [], expanded: true, layer: 2 });
                            fieldIdList.push(refEle.ID);
                        }));
                    }));
                }
            }
            gridData.push({ data: fieldObject, children: children, expanded: true, layer: 1 });
            fieldIdList.push(fieldObject.ID);
        }));
        //  默认选中所有字段
        if (needSelectAll) {
            this.grid_selected[tableCode] = fieldIdList;
            this.grid_selected['selectedAll'][tableCode] = true;
        }
        return gridData;
    };
    /**
     * @param {?} rowData
     * @param {?} rowNode
     * @return {?}
     */
    SelectObjElementComponent.prototype.changeCheckbox = /**
     * @param {?} rowData
     * @param {?} rowNode
     * @return {?}
     */
    function (rowData, rowNode) {
        var _this = this;
        /** @type {?} */
        var ID = rowData.ID;
        /** @type {?} */
        var index = this.grid_selected[this.selectedTreeKey].indexOf(ID);
        if (index >= 0) {
            this.grid_selected[this.selectedTreeKey].splice(index, 1);
            this.grid_selected['selectedAll'][this.selectedTreeKey] = false;
        }
        else {
            // 若为[单选]，则清空已选择字段
            if (this.data.singleElement) {
                this.grid_selected[this.selectedTreeKey] = [];
            }
            this.grid_selected[this.selectedTreeKey].push(ID);
        }
        // 主表的关联字段
        if (rowNode.children.length > 0) {
            rowNode.children.forEach((/**
             * @param {?} element
             * @return {?}
             */
            function (element) {
                /** @type {?} */
                var reIndex = _this.grid_selected[_this.selectedTreeKey].findIndex((/**
                 * @param {?} id
                 * @return {?}
                 */
                function (id) { return id === element.data.ID; }));
                if (index >= 0 && reIndex >= 0) {
                    _this.grid_selected[_this.selectedTreeKey].splice(reIndex, 1);
                }
                if (index < 0 && reIndex < 0) {
                    _this.grid_selected[_this.selectedTreeKey].push(element.data.ID);
                }
            }));
        }
        // 关联表的字段
        if (rowNode.parent) {
            /** @type {?} */
            var parentNode = rowNode.parent;
            if (!parentNode) {
                return;
            }
            /** @type {?} */
            var parentIndex = this.grid_selected[this.selectedTreeKey].indexOf(parentNode.data.ID);
            if (index < 0 && parentIndex < 0) {
                this.grid_selected[this.selectedTreeKey].push(parentNode.data.ID);
            }
        }
    };
    /**
     * @return {?}
     */
    SelectObjElementComponent.prototype.clickSelectAllCheckbox = /**
     * @return {?}
     */
    function () {
        this.selectAllChange(this.gridData[this.selectedTreeKey], this.grid_selected['selectedAll'][this.selectedTreeKey]);
    };
    /**
     * 全选
     * @param treeData treeData
     * @param isSelected isSelected
     */
    /**
     * 全选
     * @param {?} treeData treeData
     * @param {?} isSelected isSelected
     * @return {?}
     */
    SelectObjElementComponent.prototype.selectAllChange = /**
     * 全选
     * @param {?} treeData treeData
     * @param {?} isSelected isSelected
     * @return {?}
     */
    function (treeData, isSelected) {
        var _this = this;
        if (treeData.length === 0) {
            return;
        }
        treeData.forEach((/**
         * @param {?} treeNode
         * @return {?}
         */
        function (treeNode) {
            /** @type {?} */
            var ID = treeNode.data.ID;
            if (treeNode.children && treeNode.children.length > 0) {
                _this.selectAllChange(treeNode.children, isSelected);
            }
            /** @type {?} */
            var index = _this.grid_selected[_this.selectedTreeKey].indexOf(ID);
            // 全选
            if (isSelected && index < 0) {
                _this.grid_selected[_this.selectedTreeKey].push(ID);
                return;
            }
            // 取消全选
            if (!isSelected && _this.readonlyFields.indexOf(ID) < 0) {
                _this.grid_selected[_this.selectedTreeKey].splice(index, 1);
            }
        }));
    };
    /**
     * @return {?}
     */
    SelectObjElementComponent.prototype.prevStep = /**
     * @return {?}
     */
    function () {
        this.detailPage.prevStep();
    };
    /**
     * @return {?}
     */
    SelectObjElementComponent.prototype.finish = /**
     * @return {?}
     */
    function () {
        // 校验
        if (this.grid_selected[this.selectedTreeKey].length === 0) {
            // this.messagerService.warning('请勾选字段。');
            alert('请勾选字段。');
            return;
        }
        // 设置当前页传递出去数据
        this.data.selectedBeFields = [this.grid_selected[this.selectedTreeKey]];
        this.detailPage.setPageData(this.data.selectedBeFields);
        // 下一步
        this.detailPage.finishWizard();
    };
    /**
     * @return {?}
     */
    SelectObjElementComponent.prototype.cancel = /**
     * @return {?}
     */
    function () {
        this.detailPage.cancelWizard();
    };
    /**
     * @param {?} args
     * @return {?}
     */
    SelectObjElementComponent.prototype.pagedetailSelected = /**
     * @param {?} args
     * @return {?}
     */
    function (args) {
    };
    SelectObjElementComponent.decorators = [
        { type: Component, args: [{
                    selector: 'select-obj-element',
                    template: "<wizard-page-detail #detailpage2 (pagedetailSelected)=\"pagedetailSelected($event)\">\r\n    <ng-template wizardPageContent>\r\n        <div class=\"f-template-wizard-page-content\" style=\"margin-left:2px\">\r\n            <farris-treetable #treeTable [data]=\"gridData[selectedTreeKey]\" [columns]=\"gridCols\" [idField]=\"'ID'\" [fixedHeader]=\"true\" [width]=\"'100%'\" [height]=\"330\" [showFilterBar]=\"false\" [showIcon]=\"false\" [resizableColumns]=\"true\" [cascadeCheck]=\"true\" [showBorder]=\"false\"\r\n                class=\"f-selectbe-treetable\">\r\n                <ng-template farrisTemplate=\"header\" let-columns>\r\n                    <tr>\r\n                        <ng-container *ngFor=\"let col of columns; let i = index\">\r\n\r\n                            <th *ngIf=\"col.field!=='show'\">\r\n                                <ng-container> {{col.title}} </ng-container>\r\n                            </th>\r\n                            <th *ngIf=\"col.field==='show'\" [width]=\"col.width\">\r\n                                <ng-container>\r\n                                    <div class=\"custom-control custom-checkbox f-checkradio-single\">\r\n                                        <!-- <input class=\"custom-control-input\" id=\"CheckAll\" type=\"checkbox\" [(ngModel)]=\"grid_selected.selectedAll[selectedTreeKey]\" (ngModelChange)=\"clickSelectAllCheckbox()\" />\r\n                                        <label class=\"custom-control-label\" for=\"CheckAll\"></label> -->\r\n                                    </div>\r\n                                </ng-container>\r\n                            </th>\r\n                            <th *ngIf=\"col.field==='toggler'\" [width]=\"col.width\">\r\n                            </th>\r\n                        </ng-container>\r\n\r\n                    </tr>\r\n                </ng-template>\r\n                <ng-template farrisTemplate=\"body\" let-rowNode let-rowIndex=\"index\" let-rowData=\"rowData\" let-columns=\"columns\">\r\n                    <tr [selectRow]=\"rowNode\" [rowIndex]=\"rowIndex\" [dblclick]=\"true\" [selectRowDisabled]=\"true\">\r\n                        <ng-container *ngFor=\"let col of columns; let i = index\">\r\n                            <td *ngIf=\"col.field==='show'\" [width]=\"col.width\">\r\n                                <ng-container *ngIf=\"!rowNode.node.tableNode  && readonlyFields.indexOf(rowData.ID)<0\">\r\n                                    <div class=\"custom-control custom-checkbox f-checkradio-single\">\r\n                                        <input type=\"checkbox\" [id]=\"rowData.ID\" class=\"custom-control-input\" [checked]=\"grid_selected[selectedTreeKey] && grid_selected[selectedTreeKey].indexOf(rowData.ID)>=0\" (click)=\"changeCheckbox(rowData,rowNode.node)\">\r\n                                        <label class=\"custom-control-label\" [for]=\"rowData.ID\"></label>\r\n                                    </div>\r\n                                </ng-container>\r\n\r\n                                <ng-container *ngIf=\"!rowNode.node.tableNode && readonlyFields.indexOf(rowData.ID)>=0\">\r\n                                    <div class=\"custom-control custom-checkbox f-checkradio-single\">\r\n                                        <input type=\"checkbox\" [id]=\"rowData.ID\" class=\"custom-control-input\" checked=\"checked\" disabled>\r\n                                        <label class=\"custom-control-label\" [for]=\"rowData.ID\"></label>\r\n                                    </div>\r\n                                </ng-container>\r\n                            </td>\r\n                            <td *ngIf=\"col.field!=='show'\">\r\n                                <farris-treeTableToggler [rowNode]=\"rowNode\" *ngIf=\"i == 1\"></farris-treeTableToggler>\r\n                                <ng-container *ngIf=\"col.field!=='MDataType'\">\r\n                                    <span [title]=\"rowData[col.field]\">{{rowData[col.field]}}</span>\r\n                                </ng-container>\r\n                                <ng-container *ngIf=\"col.field ==='MDataType' && rowData.IsUdt\">\r\n                                    <span [title]=\"rowData[col.field]\">{{rowData.UdtName}}</span>\r\n                                </ng-container>\r\n                                <ng-container *ngIf=\"col.field ==='MDataType' && !rowData.IsUdt\">\r\n                                    <span [title]=\"rowData[col.field]\">{{rowData.MDataType}}</span>\r\n                                </ng-container>\r\n                            </td>\r\n                        </ng-container>\r\n                    </tr>\r\n                </ng-template>\r\n\r\n            </farris-treetable>\r\n        </div>\r\n    </ng-template>\r\n    <ng-template wizardPageFooter>\r\n        <div class=\"f-template-wizard-page-footer\">\r\n            <button class=\"btn btn-secondary\" (click)=\"prevStep()\">\u4E0A\u4E00\u6B65</button>\r\n            <button class=\"btn btn-secondary\" (click)=\"cancel()\">\u53D6\u6D88</button>\r\n            <button class=\"btn btn-primary\" [disabled]=\"!enableNextStep\" (click)=\"finish()\">\u5B8C\u6210</button>\r\n        </div>\r\n    </ng-template>\r\n</wizard-page-detail>",
                    styles: [":host{display:flex;flex:1}button{margin:10px}"]
                }] }
    ];
    /** @nocollapse */
    SelectObjElementComponent.ctorParameters = function () { return []; };
    SelectObjElementComponent.propDecorators = {
        data: [{ type: Input }],
        changeObj: [{ type: Input }],
        treeTable: [{ type: ViewChild, args: ['treeTable',] }],
        cmpPageDetail: [{ type: ViewChild, args: [FarrisPageDetailComponent,] }]
    };
    return SelectObjElementComponent;
}());
export { SelectObjElementComponent };
if (false) {
    /** @type {?} */
    SelectObjElementComponent.prototype.data;
    /** @type {?} */
    SelectObjElementComponent.prototype.changeObj;
    /**
     * 右侧树表信息
     * @type {?}
     */
    SelectObjElementComponent.prototype.treeTable;
    /** @type {?} */
    SelectObjElementComponent.prototype.gridData;
    /** @type {?} */
    SelectObjElementComponent.prototype.gridCols;
    /** @type {?} */
    SelectObjElementComponent.prototype.grid_selected;
    /** @type {?} */
    SelectObjElementComponent.prototype.readonlyFields;
    /** @type {?} */
    SelectObjElementComponent.prototype.selectedAll;
    /** @type {?} */
    SelectObjElementComponent.prototype.selectedTreeKeys;
    /** @type {?} */
    SelectObjElementComponent.prototype.selectedTreeKey;
    /** @type {?} */
    SelectObjElementComponent.prototype.enableNextStep;
    /**
     * @type {?}
     * @private
     */
    SelectObjElementComponent.prototype.detailPage;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LW9iai1lbGVtZW50LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bnc3Atd2Yvd2YtZGltZW5zaW9uLWRlZi8iLCJzb3VyY2VzIjpbImxpYi9yZWZNb2R1bGUvc2VsZWN0LWVsZW1lbnQvc3RlcHMvc2VsZWN0LW9iai1lbGVtZW50L3NlbGVjdC1vYmotZWxlbWVudC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFxQixTQUFTLEVBQUUsS0FBSyxFQUFpQixNQUFNLGVBQWUsQ0FBQztBQUM5RixPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQzs7QUFJMUQ7SUFpREU7UUF6QkEsYUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNkLGFBQVEsR0FBRztZQUNULEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUU7WUFDekMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUU7WUFDaEMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRTtZQUM1QyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRTtZQUNuQyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRTtTQUN0QyxDQUFDO1FBQ0Ysa0JBQWEsR0FBRztZQUNkLFdBQVcsRUFBRSxFQUFFO1NBQ2hCLENBQUM7UUFDRixtQkFBYyxHQUFHLEVBQUUsQ0FBQyxDQUFDLFlBQVk7O1FBQ2pDLGdCQUFXLEdBQUcsRUFBRSxDQUFDO1FBRWpCLHFCQUFnQixHQUFHLEVBQUUsQ0FBQztRQUN0QixvQkFBZSxHQUFHLEVBQUUs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b3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgT25DaGFuZ2VzLCBWaWV3Q2hpbGQsIElucHV0LCBTaW1wbGVDaGFuZ2VzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEZhcnJpc1BhZ2VEZXRhaWxDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLXdpemFyZCc7XHJcbmltcG9ydCB7IFRyZWVUYWJsZUNvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktdHJlZXRhYmxlJztcclxuaW1wb3J0IHsgSUdTUENvbW1vbkVsZW1lbnQsIEdTUENvbW1vbk9iamVjdCB9IGZyb20gJ0Bnc3AtYmVmL2dzcC1jbS1tZXRhZGF0YSc7XHJcbi8vIGltcG9ydCB7IE1lc3NhZ2VyU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbWVzc2FnZXInO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdzZWxlY3Qtb2JqLWVsZW1lbnQnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9zZWxlY3Qtb2JqLWVsZW1lbnQuY29tcG9uZW50Lmh0bWwnLFxyXG4gIHN0eWxlVXJsczogWycuL3NlbGVjdC1vYmotZWxlbWVudC5jb21wb25lbnQuY3NzJ11cclxufSlcclxuZXhwb3J0IGNsYXNzIFNlbGVjdE9iakVsZW1lbnRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcyB7XHJcblxyXG4gIC8vIC8qKlxyXG4gIC8vICAgKiDovpPlhaXlj4LmlbDmoLzlvI9cclxuICAvLyAgICovXHJcbiAgLy8gZGF0YSA9IHtcclxuICAvLyAgIGJlOiBudWxsLCAgICAgICAgICAgICAgLy8gYmXlrp7kvZNcclxuICAvLyAgIHNlbGVjdGVkT2JqOiBudWxsLCAgICAgLy8gYmXoioLngrlcclxuICAvLyAgIEJlRmllbGRzOiBbXSwgICAgICAgICAgLy8gQmXlrZfmrrXliJfooahcclxuICAvLyAgIHNlbGVjdGVkQmVGaWVsZHM6IFtdLCAgLy8gQmXlrZfmrrVJROWIl+ihqFxyXG4gIC8vICAgc2luZ2xlRWxlbWVudDogZmFsc2UsICAvLyDmmK/lkKbljZXpgIlcclxuICAvLyAgIGFzc29SZWZFbGVtZW50OiBmYWxzZSAgLy8g5piv5ZCm5YyF5ZCr5YWz6IGU5bim5Ye65a2X5q61XHJcbiAgLy8gfTtcclxuICBASW5wdXQoKSBkYXRhO1xyXG4gIEBJbnB1dCgpIGNoYW5nZU9iajtcclxuXHJcblxyXG4gIC8qKiDlj7PkvqfmoJHooajkv6Hmga8gKi9cclxuICBAVmlld0NoaWxkKCd0cmVlVGFibGUnKSB0cmVlVGFibGU6IFRyZWVUYWJsZUNvbXBvbmVudDtcclxuICBncmlkRGF0YSA9IHt9O1xyXG4gIGdyaWRDb2xzID0gW1xyXG4gICAgeyBmaWVsZDogJ3Nob3cnLCB0aXRsZTogJ+aYvuekuicsIHdpZHRoOiA0MCB9LFxyXG4gICAgeyBmaWVsZDogJ05hbWUnLCB0aXRsZTogJ+Wtl+auteWQjeensCcgfSxcclxuICAgIHsgZmllbGQ6ICdDb2RlJywgdGl0bGU6ICflrZfmrrXnvJblj7cnLCB3aWR0aDogMjAwIH0sXHJcbiAgICB7IGZpZWxkOiAnTGFiZWxJRCcsIHRpdGxlOiAn5a2X5q615qCH562+JyB9LFxyXG4gICAgeyBmaWVsZDogJ01EYXRhVHlwZScsIHRpdGxlOiAn5a2X5q6157G75Z6LJyB9XHJcbiAgXTtcclxuICBncmlkX3NlbGVjdGVkID0ge1xyXG4gICAgc2VsZWN0ZWRBbGw6IHt9XHJcbiAgfTtcclxuICByZWFkb25seUZpZWxkcyA9IFtdOyAvLyDkuI3lj6/lj5bmtojli77pgInnmoTlrZfmrrVcclxuICBzZWxlY3RlZEFsbCA9IHt9O1xyXG5cclxuICBzZWxlY3RlZFRyZWVLZXlzID0gW107XHJcbiAgc2VsZWN0ZWRUcmVlS2V5ID0gJyc7XHJcblxyXG4gIGVuYWJsZU5leHRTdGVwID0gdHJ1ZTtcclxuICBwcml2YXRlIGRldGFpbFBhZ2U6IEZhcnJpc1BhZ2VEZXRhaWxDb21wb25lbnQgPSBudWxsO1xyXG4gIEBWaWV3Q2hpbGQoRmFycmlzUGFnZURldGFpbENvbXBvbmVudCkgc2V0IGNtcFBhZ2VEZXRhaWwoXHJcbiAgICBjbXA6IEZhcnJpc1BhZ2VEZXRhaWxDb21wb25lbnRcclxuICApIHtcclxuICAgIHRoaXMuZGV0YWlsUGFnZSA9IGNtcDtcclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkgeyB9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgdGhpcy5sb2FkKCk7XHJcbiAgfVxyXG5cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XHJcbiAgICB0aGlzLmxvYWQoKTtcclxuICB9XHJcblxyXG4gIGxvYWQoKSB7XHJcbiAgICBjb25zdCBvYmogPSB0aGlzLmRldGFpbFBhZ2UuZ2V0UGFnZURhdGEoJ3NlbGVjdG9iamVjdCcpO1xyXG4gICAgaWYgKHRoaXMuZGF0YSAmJiB0aGlzLmRhdGEuc2VsZWN0ZWRPYmopIHtcclxuICAgICAgY29uc3QgcGFyZW50VGFibGUgPSB0aGlzLmRhdGEuc2VsZWN0ZWRPYmogYXMgR1NQQ29tbW9uT2JqZWN0O1xyXG4gICAgICB0aGlzLnNlbGVjdGVkVHJlZUtleSA9IHRoaXMuZGF0YS5zZWxlY3RlZE9iai5Db2RlO1xyXG4gICAgICB0aGlzLnNlbGVjdGVkVHJlZUtleXMgPSBbdGhpcy5zZWxlY3RlZFRyZWVLZXldO1xyXG4gICAgICB0aGlzLmdyaWRfc2VsZWN0ZWRbdGhpcy5zZWxlY3RlZFRyZWVLZXldID0gdGhpcy5kYXRhLnNlbGVjdGVkQmVGaWVsZHM7XHJcbiAgICAgIHRoaXMuZ3JpZERhdGFbcGFyZW50VGFibGUuQ29kZV0gPSB0aGlzLmdldEdyaWRGaWVsZHMocGFyZW50VGFibGUuQ29udGFpbkVsZW1lbnRzLCBwYXJlbnRUYWJsZS5Db2RlLCBmYWxzZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blkITooajlrZfmrrXvvIzlhbPogZTlrZfmrrXku6XmoJHlvaLlvI/lsZXnpLpcclxuICAgKiBAcGFyYW0gZmllbGRzXHJcbiAgICovXHJcbiAgZ2V0R3JpZEZpZWxkcyhmaWVsZHM6IElHU1BDb21tb25FbGVtZW50W10sIHRhYmxlQ29kZTogc3RyaW5nLCBuZWVkU2VsZWN0QWxsOiBib29sZWFuKSB7XHJcbiAgICBjb25zdCBncmlkRGF0YSA9IFtdO1xyXG4gICAgY29uc3QgZmllbGRJZExpc3QgPSBbXTtcclxuICAgIGlmICghZmllbGRzIHx8IGZpZWxkcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG4gICAgZmllbGRzLmZvckVhY2goZmllbGQgPT4ge1xyXG4gICAgICBjb25zdCB7IENoaWxkQXNzb2NpYXRpb25zLCAuLi5maWVsZE9iamVjdCB9ID0gZmllbGQ7XHJcbiAgICAgIGNvbnN0IGNoaWxkcmVuID0gW107XHJcblxyXG4gICAgICBpZiAodGhpcy5kYXRhLmFzc29SZWZFbGVtZW50KSB7XHJcbiAgICAgICAgLy8g5YWz6IGU6KGoXHJcbiAgICAgICAgaWYgKENoaWxkQXNzb2NpYXRpb25zICYmIENoaWxkQXNzb2NpYXRpb25zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIENoaWxkQXNzb2NpYXRpb25zLmZvckVhY2goY2hpbGQgPT4ge1xyXG4gICAgICAgICAgICBjaGlsZC5SZWZFbGVtZW50Q29sbGVjdGlvbi5mb3JFYWNoKHJlZkVsZSA9PiB7XHJcbiAgICAgICAgICAgICAgY2hpbGRyZW4ucHVzaCh7IGRhdGE6IHJlZkVsZSwgY2hpbGRyZW46IFtdLCBleHBhbmRlZDogdHJ1ZSwgbGF5ZXI6IDIgfSk7XHJcbiAgICAgICAgICAgICAgZmllbGRJZExpc3QucHVzaChyZWZFbGUuSUQpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgZ3JpZERhdGEucHVzaCh7IGRhdGE6IGZpZWxkT2JqZWN0LCBjaGlsZHJlbjogY2hpbGRyZW4sIGV4cGFuZGVkOiB0cnVlLCBsYXllcjogMSB9KTtcclxuICAgICAgZmllbGRJZExpc3QucHVzaChmaWVsZE9iamVjdC5JRCk7XHJcbiAgICB9KTtcclxuICAgIC8vICDpu5jorqTpgInkuK3miYDmnInlrZfmrrVcclxuICAgIGlmIChuZWVkU2VsZWN0QWxsKSB7XHJcbiAgICAgIHRoaXMuZ3JpZF9zZWxlY3RlZFt0YWJsZUNvZGVdID0gZmllbGRJZExpc3Q7XHJcbiAgICAgIHRoaXMuZ3JpZF9zZWxlY3RlZFsnc2VsZWN0ZWRBbGwnXVt0YWJsZUNvZGVdID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZ3JpZERhdGE7XHJcbiAgfVxyXG5cclxuICBjaGFuZ2VDaGVja2JveChyb3dEYXRhLCByb3dOb2RlKSB7XHJcbiAgICBjb25zdCBJRCA9IHJvd0RhdGEuSUQ7XHJcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuZ3JpZF9zZWxlY3RlZFt0aGlzLnNlbGVjdGVkVHJlZUtleV0uaW5kZXhPZihJRCk7XHJcblxyXG4gICAgaWYgKGluZGV4ID49IDApIHtcclxuICAgICAgdGhpcy5ncmlkX3NlbGVjdGVkW3RoaXMuc2VsZWN0ZWRUcmVlS2V5XS5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICB0aGlzLmdyaWRfc2VsZWN0ZWRbJ3NlbGVjdGVkQWxsJ11bdGhpcy5zZWxlY3RlZFRyZWVLZXldID0gZmFsc2U7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyDoi6XkuLpb5Y2V6YCJXe+8jOWImea4heepuuW3sumAieaLqeWtl+autVxyXG4gICAgICBpZiAodGhpcy5kYXRhLnNpbmdsZUVsZW1lbnQpIHtcclxuICAgICAgICB0aGlzLmdyaWRfc2VsZWN0ZWRbdGhpcy5zZWxlY3RlZFRyZWVLZXldID0gW107XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5ncmlkX3NlbGVjdGVkW3RoaXMuc2VsZWN0ZWRUcmVlS2V5XS5wdXNoKElEKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDkuLvooajnmoTlhbPogZTlrZfmrrVcclxuICAgIGlmIChyb3dOb2RlLmNoaWxkcmVuLmxlbmd0aCA+IDApIHtcclxuICAgICAgcm93Tm9kZS5jaGlsZHJlbi5mb3JFYWNoKGVsZW1lbnQgPT4ge1xyXG4gICAgICAgIGNvbnN0IHJlSW5kZXggPSB0aGlzLmdyaWRfc2VsZWN0ZWRbdGhpcy5zZWxlY3RlZFRyZWVLZXldLmZpbmRJbmRleChpZCA9PiBpZCA9PT0gZWxlbWVudC5kYXRhLklEKTtcclxuICAgICAgICBpZiAoaW5kZXggPj0gMCAmJiByZUluZGV4ID49IDApIHtcclxuICAgICAgICAgIHRoaXMuZ3JpZF9zZWxlY3RlZFt0aGlzLnNlbGVjdGVkVHJlZUtleV0uc3BsaWNlKHJlSW5kZXgsIDEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoaW5kZXggPCAwICYmIHJlSW5kZXggPCAwKSB7XHJcbiAgICAgICAgICB0aGlzLmdyaWRfc2VsZWN0ZWRbdGhpcy5zZWxlY3RlZFRyZWVLZXldLnB1c2goZWxlbWVudC5kYXRhLklEKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDlhbPogZTooajnmoTlrZfmrrVcclxuICAgIGlmIChyb3dOb2RlLnBhcmVudCkge1xyXG4gICAgICBjb25zdCBwYXJlbnROb2RlID0gcm93Tm9kZS5wYXJlbnQ7XHJcbiAgICAgIGlmICghcGFyZW50Tm9kZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBwYXJlbnRJbmRleCA9IHRoaXMuZ3JpZF9zZWxlY3RlZFt0aGlzLnNlbGVjdGVkVHJlZUtleV0uaW5kZXhPZihwYXJlbnROb2RlLmRhdGEuSUQpO1xyXG4gICAgICBpZiAoaW5kZXggPCAwICYmIHBhcmVudEluZGV4IDwgMCkge1xyXG4gICAgICAgIHRoaXMuZ3JpZF9zZWxlY3RlZFt0aGlzLnNlbGVjdGVkVHJlZUtleV0ucHVzaChwYXJlbnROb2RlLmRhdGEuSUQpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gIH1cclxuXHJcbiAgY2xpY2tTZWxlY3RBbGxDaGVja2JveCgpIHtcclxuICAgIHRoaXMuc2VsZWN0QWxsQ2hhbmdlKHRoaXMuZ3JpZERhdGFbdGhpcy5zZWxlY3RlZFRyZWVLZXldLCB0aGlzLmdyaWRfc2VsZWN0ZWRbJ3NlbGVjdGVkQWxsJ11bdGhpcy5zZWxlY3RlZFRyZWVLZXldKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWFqOmAiVxyXG4gICAqIEBwYXJhbSB0cmVlRGF0YSB0cmVlRGF0YVxyXG4gICAqIEBwYXJhbSBpc1NlbGVjdGVkIGlzU2VsZWN0ZWRcclxuICAgKi9cclxuICBzZWxlY3RBbGxDaGFuZ2UodHJlZURhdGEsIGlzU2VsZWN0ZWQ6IGJvb2xlYW4pIHtcclxuICAgIGlmICh0cmVlRGF0YS5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRyZWVEYXRhLmZvckVhY2godHJlZU5vZGUgPT4ge1xyXG4gICAgICBjb25zdCBJRCA9IHRyZWVOb2RlLmRhdGEuSUQ7XHJcbiAgICAgIGlmICh0cmVlTm9kZS5jaGlsZHJlbiAmJiB0cmVlTm9kZS5jaGlsZHJlbi5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RBbGxDaGFuZ2UodHJlZU5vZGUuY2hpbGRyZW4sIGlzU2VsZWN0ZWQpO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5ncmlkX3NlbGVjdGVkW3RoaXMuc2VsZWN0ZWRUcmVlS2V5XS5pbmRleE9mKElEKTtcclxuICAgICAgLy8g5YWo6YCJXHJcbiAgICAgIGlmIChpc1NlbGVjdGVkICYmIGluZGV4IDwgMCkge1xyXG4gICAgICAgIHRoaXMuZ3JpZF9zZWxlY3RlZFt0aGlzLnNlbGVjdGVkVHJlZUtleV0ucHVzaChJRCk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIOWPlua2iOWFqOmAiVxyXG4gICAgICBpZiAoIWlzU2VsZWN0ZWQgJiYgdGhpcy5yZWFkb25seUZpZWxkcy5pbmRleE9mKElEKSA8IDApIHtcclxuICAgICAgICB0aGlzLmdyaWRfc2VsZWN0ZWRbdGhpcy5zZWxlY3RlZFRyZWVLZXldLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICBwcmV2U3RlcCgpIHtcclxuICAgIHRoaXMuZGV0YWlsUGFnZS5wcmV2U3RlcCgpO1xyXG4gIH1cclxuICBmaW5pc2goKSB7XHJcbiAgICAvLyDmoKHpqoxcclxuICAgIGlmICh0aGlzLmdyaWRfc2VsZWN0ZWRbdGhpcy5zZWxlY3RlZFRyZWVLZXldLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAvLyB0aGlzLm1lc3NhZ2VyU2VydmljZS53YXJuaW5nKCfor7fli77pgInlrZfmrrXjgIInKTtcclxuICAgICAgYWxlcnQoJ+ivt+WLvumAieWtl+auteOAgicpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDorr7nva7lvZPliY3pobXkvKDpgJLlh7rljrvmlbDmja5cclxuICAgIHRoaXMuZGF0YS5zZWxlY3RlZEJlRmllbGRzID0gW3RoaXMuZ3JpZF9zZWxlY3RlZFt0aGlzLnNlbGVjdGVkVHJlZUtleV1dO1xyXG4gICAgdGhpcy5kZXRhaWxQYWdlLnNldFBhZ2VEYXRhKHRoaXMuZGF0YS5zZWxlY3RlZEJlRmllbGRzKTtcclxuICAgIC8vIOS4i+S4gOatpVxyXG4gICAgdGhpcy5kZXRhaWxQYWdlLmZpbmlzaFdpemFyZCgpO1xyXG4gIH1cclxuICBjYW5jZWwoKSB7XHJcbiAgICB0aGlzLmRldGFpbFBhZ2UuY2FuY2VsV2l6YXJkKCk7XHJcbiAgfVxyXG4gIHBhZ2VkZXRhaWxTZWxlY3RlZChhcmdzKSB7XHJcblxyXG4gIH1cclxufVxyXG4iXX0=