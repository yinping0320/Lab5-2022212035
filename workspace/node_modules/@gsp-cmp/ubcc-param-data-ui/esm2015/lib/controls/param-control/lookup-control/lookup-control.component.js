/**
 * @fileoverview added by tsickle
 * Generated from: lib/controls/param-control/lookup-control/lookup-control.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, Input } from '@angular/core';
import { UbccParamTemplate, DataTypeExtensionConst } from '@gsp-cmp/ubcc-param-vo';
import { DataTypeConst } from '@ecp-caf/common-structure';
import { GSPMetadataRTService } from '@gsp-lcm/metadatart-selector';
import { ServerSideToken } from '@farris/ui-lookup';
import { LookUpHttpService } from '../../../service/lookup-http-service';
import { LookUpBindingFields } from '../../../common/look-up-binding-fields';
/** @type {?} */
const BCC_HELP_URL = `/api/runtime/bcc/v1.0/param/help/{helpId}`;
export class LookupControlComponent {
    /**
     * @param {?} metadataRTService
     */
    constructor(metadataRTService) {
        this.metadataRTService = metadataRTService;
        this.canEdit = true;
        this.isSingleSelect = true;
        this.isHelpInfoLoad = false;
        this.helpUrl = BCC_HELP_URL;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.param = this.param || {};
        this.bindingFields = this.bindingFields || new LookUpBindingFields();
        this.helpConfigInit();
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        this.helpConfigInit();
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    selectedHelpHandler($event) {
        if (!$event) {
            return;
        }
        this.param.value = '';
        this.param.valueText = '';
        if (this.isCollection()) {
            if ($event.length <= 0) {
                return;
            }
            $event.map((/**
             * @param {?} selectItem
             * @param {?} index
             * @return {?}
             */
            (selectItem, index) => {
                this.param.value = this.param.value + (index > 0 ? `,${selectItem[this.bindingFields.idField]}` : selectItem[this.bindingFields.idField]);
                this.param.valueText = this.param.valueText + (index > 0 ? `,${selectItem[this.bindingFields.textField]}` : selectItem[this.bindingFields.textField]);
            }));
        }
        else {
            this.param.value = $event[this.bindingFields.idField];
            this.param.valueText = $event[this.bindingFields.textField];
        }
    }
    /**
     * @private
     * @return {?}
     */
    helpConfigInit() {
        if (this.isHelpInfoLoad || !this.param || !this.param.parameterType) {
            return;
        }
        if (this.param.parameterType.kind === DataTypeConst.DEFAULT_COLLECTION) {
            this.isSingleSelect = false;
            /** @type {?} */
            let elementType = (/** @type {?} */ (this.getCollectionElementType(this.param.parameterType)));
            this.loadDataFromMetadata(elementType);
        }
        else if (this.param.parameterType.kind === DataTypeExtensionConst.UBCC_STRUCTURE_TYPE_REF) {
            this.isSingleSelect = true;
            /** @type {?} */
            let typeRef = (/** @type {?} */ (this.param.parameterType));
            this.loadDataFromMetadata(typeRef);
        }
        else {
            throw new Error(`帮助不支持的参数类型${this.param.parameterType.kind}`);
        }
    }
    /**
     * @private
     * @param {?} refType
     * @return {?}
     */
    loadDataFromMetadata(refType) {
        if (!refType.refId) {
            return;
        }
        this.metadataRTService.GetMetadataRT(refType.refId).subscribe((/**
         * @param {?} metadataDto
         * @return {?}
         */
        (metadataDto) => {
            /** @type {?} */
            let helpMetadata = JSON.parse(metadataDto.content);
            this.setHelpInfo(helpMetadata);
            this.isHelpInfoLoad = true;
        }));
    }
    /**
     * @param {?} helpMetadata
     * @return {?}
     */
    setHelpInfo(helpMetadata) {
        this.helpUrl = BCC_HELP_URL.replace('{helpId}', helpMetadata.id);
        this.bindingFields.idField = helpMetadata.idField;
        this.bindingFields.textField = helpMetadata.textField;
        this.bindingFields.valueField = helpMetadata.valueField;
        this.bindingFields.displayType = helpMetadata.displayType;
    }
    /**
     * @private
     * @param {?} dataType
     * @return {?}
     */
    getCollectionElementType(dataType) {
        /** @type {?} */
        let kind = dataType.getKind();
        switch (kind) {
            case DataTypeConst.DEFAULT_COLLECTION:
                /** @type {?} */
                let elementType = ((/** @type {?} */ (dataType))).elementType;
                return this.getCollectionElementType(elementType);
            default:
                return dataType;
        }
    }
    /**
     * @return {?}
     */
    isCollection() {
        if (!this.param || !this.param.parameterType) {
            return false;
        }
        if (this.param.parameterType.getKind() === DataTypeConst.DEFAULT_COLLECTION) {
            return true;
        }
        else {
            return false;
        }
    }
    /**
     * @return {?}
     */
    isReadonly() {
        if (!this.canEdit) {
            return true;
        }
        else {
            return !this.param || !this.param.readonly ? false : true;
        }
    }
    /**
     * @return {?}
     */
    show() {
        return !this.param || !this.param.description ? false : true;
    }
}
LookupControlComponent.decorators = [
    { type: Component, args: [{
                selector: 'lib-lookup-control',
                template: "<div class=\"farris-form-controls-inline farris-group-wrap col-12\">\n  <div class=\"form-group farris-form-group\">\n    <label class=\"col-form-label col-4\">\n      <span class=\"farris-label-text\" style=\"float:right\">{{param.name}}</span>\n    </label>\n    <div class=\"farris-input-wrap col-6\">\n      <farris-lookup-grid [editable]=\"false\" [readonly]=\"isReadonly()\" (selectedData)=\"selectedHelpHandler($event)\" [uri]=\"helpUrl\" [idField]=\"bindingFields.idField\"\n        [textField]=\"bindingFields.textField\" [valueField]=\"bindingFields.valueField\" [enableClear]=\"false\" [displayType]=\"bindingFields.displayType\"\n        [(ngModel)]=\"param.valueText\" name=\"{{param.code}}\" [pagination]=\"true\" [singleSelect]=\"isSingleSelect\">\n      </farris-lookup-grid>\n    </div>\n     <span *ngIf=\"show()\" farrisTooltip [placement]=\"'right-top'\" [content]=\"param.description\" class=\"f-icon f-icon-info\"></span>\n  </div>\n</div>",
                providers: [{ provide: ServerSideToken, useClass: LookUpHttpService }, GSPMetadataRTService],
                styles: [""]
            }] }
];
/** @nocollapse */
LookupControlComponent.ctorParameters = () => [
    { type: GSPMetadataRTService }
];
LookupControlComponent.propDecorators = {
    param: [{ type: Input }],
    template: [{ type: Input }],
    canEdit: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    LookupControlComponent.prototype.param;
    /** @type {?} */
    LookupControlComponent.prototype.template;
    /** @type {?} */
    LookupControlComponent.prototype.canEdit;
    /** @type {?} */
    LookupControlComponent.prototype.isSingleSelect;
    /** @type {?} */
    LookupControlComponent.prototype.isHelpInfoLoad;
    /** @type {?} */
    LookupControlComponent.prototype.bindingFields;
    /** @type {?} */
    LookupControlComponent.prototype.helpUrl;
    /**
     * @type {?}
     * @private
     */
    LookupControlComponent.prototype.metadataRTService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9va3VwLWNvbnRyb2wuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGdzcC1jbXAvdWJjYy1wYXJhbS1kYXRhLXVpLyIsInNvdXJjZXMiOlsibGliL2NvbnRyb2xzL3BhcmFtLWNvbnRyb2wvbG9va3VwLWNvbnRyb2wvbG9va3VwLWNvbnRyb2wuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxLQUFLLEVBQTRCLE1BQU0sZUFBZSxDQUFDO0FBQ25GLE9BQU8sRUFBRSxpQkFBaUIsRUFBb0Isc0JBQXNCLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQztBQUNwRyxPQUFPLEVBQUUsYUFBYSxFQUE2QixNQUFNLDJCQUEyQixDQUFDO0FBQ3JGLE9BQU8sRUFBZSxvQkFBb0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ2pGLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUN6RSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQzs7TUFFdkUsWUFBWSxHQUFDLDJDQUEyQztBQVE5RCxNQUFNLE9BQU8sc0JBQXNCOzs7O0lBZ0IvQixZQUFvQixpQkFBdUM7UUFBdkMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFzQjtRQVZsRCxZQUFPLEdBQVMsSUFBSSxDQUFDO1FBRTlCLG1CQUFjLEdBQVMsSUFBSSxDQUFDO1FBRTVCLG1CQUFjLEdBQVMsS0FBSyxDQUFDO1FBSTdCLFlBQU8sR0FBUyxZQUFZLENBQUM7SUFFbUMsQ0FBQzs7OztJQUVqRSxRQUFRO1FBQ0osSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUM5QixJQUFJLENBQUMsYUFBYSxHQUFDLElBQUksQ0FBQyxhQUFhLElBQUUsSUFBSSxtQkFBbUIsRUFBRSxDQUFDO1FB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ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0LCBJbnB1dCwgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBVYmNjUGFyYW1UZW1wbGF0ZSwgU3RydWN0dXJlVHlwZVJlZiwgRGF0YVR5cGVFeHRlbnNpb25Db25zdH0gZnJvbSAnQGdzcC1jbXAvdWJjYy1wYXJhbS12byc7XG5pbXBvcnQgeyBEYXRhVHlwZUNvbnN0LCBJRGF0YVR5cGUsIENvbGxlY3Rpb25UeXBlIH0gZnJvbSAnQGVjcC1jYWYvY29tbW9uLXN0cnVjdHVyZSc7XG5pbXBvcnQgeyBNZXRhZGF0YUR0bywgR1NQTWV0YWRhdGFSVFNlcnZpY2UgfSBmcm9tICdAZ3NwLWxjbS9tZXRhZGF0YXJ0LXNlbGVjdG9yJztcbmltcG9ydCB7IFNlcnZlclNpZGVUb2tlbiB9IGZyb20gJ0BmYXJyaXMvdWktbG9va3VwJztcbmltcG9ydCB7IExvb2tVcEh0dHBTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZS9sb29rdXAtaHR0cC1zZXJ2aWNlJztcbmltcG9ydCB7IExvb2tVcEJpbmRpbmdGaWVsZHMgfSBmcm9tICcuLi8uLi8uLi9jb21tb24vbG9vay11cC1iaW5kaW5nLWZpZWxkcyc7XG5cbmNvbnN0IEJDQ19IRUxQX1VSTD1gL2FwaS9ydW50aW1lL2JjYy92MS4wL3BhcmFtL2hlbHAve2hlbHBJZH1gO1xuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ2xpYi1sb29rdXAtY29udHJvbCcsXG4gICAgdGVtcGxhdGVVcmw6ICcuL2xvb2t1cC1jb250cm9sLmNvbXBvbmVudC5odG1sJyxcbiAgICBzdHlsZVVybHM6IFsnLi9sb29rdXAtY29udHJvbC5jb21wb25lbnQuY3NzJ10sXG4gICAgcHJvdmlkZXJzOiBbeyBwcm92aWRlOiBTZXJ2ZXJTaWRlVG9rZW4sIHVzZUNsYXNzOiBMb29rVXBIdHRwU2VydmljZSB9LCBHU1BNZXRhZGF0YVJUU2VydmljZV1cbn0pXG5leHBvcnQgY2xhc3MgTG9va3VwQ29udHJvbENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCAsT25DaGFuZ2Vze1xuICAgIFxuICAgIEBJbnB1dCgpIHBhcmFtOmFueTtcblxuICAgIEBJbnB1dCgpIHRlbXBsYXRlOlViY2NQYXJhbVRlbXBsYXRlO1xuXG4gICAgQElucHV0KCkgY2FuRWRpdDpib29sZWFuPXRydWU7XG4gICAgXG4gICAgaXNTaW5nbGVTZWxlY3Q6Ym9vbGVhbj10cnVlO1xuXG4gICAgaXNIZWxwSW5mb0xvYWQ6Ym9vbGVhbj1mYWxzZTtcblxuICAgIGJpbmRpbmdGaWVsZHM6TG9va1VwQmluZGluZ0ZpZWxkcztcblxuICAgIGhlbHBVcmw6c3RyaW5nPSBCQ0NfSEVMUF9VUkw7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIG1ldGFkYXRhUlRTZXJ2aWNlOiBHU1BNZXRhZGF0YVJUU2VydmljZSwpIHsgfVxuXG4gICAgbmdPbkluaXQoKSB7XG4gICAgICAgIHRoaXMucGFyYW0gPSB0aGlzLnBhcmFtIHx8IHt9O1xuICAgICAgICB0aGlzLmJpbmRpbmdGaWVsZHM9dGhpcy5iaW5kaW5nRmllbGRzfHxuZXcgTG9va1VwQmluZGluZ0ZpZWxkcygpO1xuICAgICAgICB0aGlzLmhlbHBDb25maWdJbml0KCk7XG4gICAgfVxuXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xuICAgICAgICB0aGlzLmhlbHBDb25maWdJbml0KCk7XG4gICAgfVxuXG4gICAgc2VsZWN0ZWRIZWxwSGFuZGxlcigkZXZlbnQpIHtcbiAgICAgICAgaWYgKCEkZXZlbnQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnBhcmFtLnZhbHVlID0gJyc7XG4gICAgICAgIHRoaXMucGFyYW0udmFsdWVUZXh0ID0gJyc7XG4gICAgICAgIGlmICh0aGlzLmlzQ29sbGVjdGlvbigpKSB7XG4gICAgICAgICAgICBpZiAoJGV2ZW50Lmxlbmd0aCA8PTApIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAkZXZlbnQubWFwKChzZWxlY3RJdGVtLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucGFyYW0udmFsdWU9dGhpcy5wYXJhbS52YWx1ZSsoaW5kZXg+MD9gLCR7c2VsZWN0SXRlbVt0aGlzLmJpbmRpbmdGaWVsZHMuaWRGaWVsZF19YDpzZWxlY3RJdGVtW3RoaXMuYmluZGluZ0ZpZWxkcy5pZEZpZWxkXSk7XG4gICAgICAgICAgICAgICAgdGhpcy5wYXJhbS52YWx1ZVRleHQ9dGhpcy5wYXJhbS52YWx1ZVRleHQrKGluZGV4PjA/YCwke3NlbGVjdEl0ZW1bdGhpcy5iaW5kaW5nRmllbGRzLnRleHRGaWVsZF19YDpzZWxlY3RJdGVtW3RoaXMuYmluZGluZ0ZpZWxkcy50ZXh0RmllbGRdKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wYXJhbS52YWx1ZSA9ICRldmVudFt0aGlzLmJpbmRpbmdGaWVsZHMuaWRGaWVsZF07XG4gICAgICAgICAgICB0aGlzLnBhcmFtLnZhbHVlVGV4dD0kZXZlbnRbdGhpcy5iaW5kaW5nRmllbGRzLnRleHRGaWVsZF07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGhlbHBDb25maWdJbml0KCkge1xuICAgICAgICBpZiAodGhpcy5pc0hlbHBJbmZvTG9hZCB8fCAhdGhpcy5wYXJhbSB8fCAhdGhpcy5wYXJhbS5wYXJhbWV0ZXJUeXBlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMucGFyYW0ucGFyYW1ldGVyVHlwZS5raW5kID09PSBEYXRhVHlwZUNvbnN0LkRFRkFVTFRfQ09MTEVDVElPTikge1xuICAgICAgICAgICAgdGhpcy5pc1NpbmdsZVNlbGVjdD1mYWxzZTtcbiAgICAgICAgICAgIGxldCBlbGVtZW50VHlwZSA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnRUeXBlKHRoaXMucGFyYW0ucGFyYW1ldGVyVHlwZSkgYXMgU3RydWN0dXJlVHlwZVJlZjtcbiAgICAgICAgICAgIHRoaXMubG9hZERhdGFGcm9tTWV0YWRhdGEoZWxlbWVudFR5cGUpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHRoaXMucGFyYW0ucGFyYW1ldGVyVHlwZS5raW5kID09PSBEYXRhVHlwZUV4dGVuc2lvbkNvbnN0LlVCQ0NfU1RSVUNUVVJFX1RZUEVfUkVGKSB7XG4gICAgICAgICAgICB0aGlzLmlzU2luZ2xlU2VsZWN0PXRydWU7XG4gICAgICAgICAgICBsZXQgdHlwZVJlZiA9IHRoaXMucGFyYW0ucGFyYW1ldGVyVHlwZSBhcyBTdHJ1Y3R1cmVUeXBlUmVmO1xuICAgICAgICAgICAgdGhpcy5sb2FkRGF0YUZyb21NZXRhZGF0YSh0eXBlUmVmKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihg5biu5Yqp5LiN5pSv5oyB55qE5Y+C5pWw57G75Z6LJHt0aGlzLnBhcmFtLnBhcmFtZXRlclR5cGUua2luZH1gKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIGxvYWREYXRhRnJvbU1ldGFkYXRhKHJlZlR5cGU6IFN0cnVjdHVyZVR5cGVSZWYpIHtcbiAgICAgICAgaWYgKCFyZWZUeXBlLnJlZklkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5tZXRhZGF0YVJUU2VydmljZS5HZXRNZXRhZGF0YVJUKHJlZlR5cGUucmVmSWQpLnN1YnNjcmliZSgobWV0YWRhdGFEdG86IE1ldGFkYXRhRHRvKSA9PiB7XG4gICAgICAgICAgICBsZXQgaGVscE1ldGFkYXRhID0gSlNPTi5wYXJzZShtZXRhZGF0YUR0by5jb250ZW50KTtcbiAgICAgICAgICAgIHRoaXMuc2V0SGVscEluZm8oaGVscE1ldGFkYXRhKTtcbiAgICAgICAgICAgIHRoaXMuaXNIZWxwSW5mb0xvYWQgPSB0cnVlO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBzZXRIZWxwSW5mbyhoZWxwTWV0YWRhdGE6YW55KXtcbiAgICAgICAgdGhpcy5oZWxwVXJsID0gQkNDX0hFTFBfVVJMLnJlcGxhY2UoJ3toZWxwSWR9JywgaGVscE1ldGFkYXRhLmlkKTtcbiAgICAgICAgdGhpcy5iaW5kaW5nRmllbGRzLmlkRmllbGQgPSBoZWxwTWV0YWRhdGEuaWRGaWVsZDtcbiAgICAgICAgdGhpcy5iaW5kaW5nRmllbGRzLnRleHRGaWVsZCA9IGhlbHBNZXRhZGF0YS50ZXh0RmllbGQ7XG4gICAgICAgIHRoaXMuYmluZGluZ0ZpZWxkcy52YWx1ZUZpZWxkID0gaGVscE1ldGFkYXRhLnZhbHVlRmllbGQ7XG4gICAgICAgIHRoaXMuYmluZGluZ0ZpZWxkcy5kaXNwbGF5VHlwZSA9IGhlbHBNZXRhZGF0YS5kaXNwbGF5VHlwZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldENvbGxlY3Rpb25FbGVtZW50VHlwZShkYXRhVHlwZTogSURhdGFUeXBlKSB7XG4gICAgICAgIGxldCBraW5kID0gZGF0YVR5cGUuZ2V0S2luZCgpO1xuICAgICAgICBzd2l0Y2ggKGtpbmQpIHtcbiAgICAgICAgICAgIGNhc2UgRGF0YVR5cGVDb25zdC5ERUZBVUxUX0NPTExFQ1RJT046XG4gICAgICAgICAgICAgICAgbGV0IGVsZW1lbnRUeXBlID0gKGRhdGFUeXBlIGFzIENvbGxlY3Rpb25UeXBlKS5lbGVtZW50VHlwZTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudFR5cGUoZWxlbWVudFR5cGUpO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YVR5cGU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpc0NvbGxlY3Rpb24oKSB7XG4gICAgICAgIGlmICghdGhpcy5wYXJhbSB8fCAhdGhpcy5wYXJhbS5wYXJhbWV0ZXJUeXBlKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMucGFyYW0ucGFyYW1ldGVyVHlwZS5nZXRLaW5kKCkgPT09IERhdGFUeXBlQ29uc3QuREVGQVVMVF9DT0xMRUNUSU9OKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlzUmVhZG9ubHkoKXtcbiAgICAgICAgaWYoIXRoaXMuY2FuRWRpdCl7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBlbHNle1xuICAgICAgICAgICAgcmV0dXJuICF0aGlzLnBhcmFtfHwhdGhpcy5wYXJhbS5yZWFkb25seT9mYWxzZTp0cnVlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2hvdygpe1xuICAgICAgICByZXR1cm4gIXRoaXMucGFyYW18fCF0aGlzLnBhcmFtLmRlc2NyaXB0aW9uP2ZhbHNlOnRydWU7XG4gICAgfVxufVxuIl19