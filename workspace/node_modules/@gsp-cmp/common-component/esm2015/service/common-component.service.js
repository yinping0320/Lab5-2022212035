/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { of } from 'rxjs';
import { map, mergeMap } from 'rxjs/operators';
import { DefaultSerializeContext, CommonStructureDTService, CollectionType, MapType, PrimitiveType } from '@ecp-caf/common-structure';
import { DefaultGspComponentSerializer } from '../serialize-context/default/serializer/default-gsp-component-serializer';
import { DefaultGspComponentSerializeContext } from '../serialize-context/default/default-gsp-component-serialize-context';
import { StructureReferType } from '../define/data-type/structure-refer-type';
export class CommonComponentService {
    /**
     * @param {?} http
     * @param {?} structureSvc
     */
    constructor(http, structureSvc) {
        this.http = http;
        this.structureSvc = structureSvc;
        this.commom_component_url = '/api/runtime/sys/v1.0/common-component';
    }
    /**
     * @param {?} componentId
     * @param {?} headers
     * @return {?}
     */
    getComponent(componentId, headers) {
        /** @type {?} */
        let url = this.commom_component_url + '?componentId=' + componentId;
        return this.http.get(url, { headers: headers }).pipe(map((/**
         * @param {?} cmpObj
         * @return {?}
         */
        cmpObj => {
            /** @type {?} */
            let serializer = new DefaultGspComponentSerializer();
            /** @type {?} */
            let ctxt = new DefaultGspComponentSerializeContext();
            /** @type {?} */
            let cmp = serializer.deserialize(cmpObj, ctxt);
            return cmp;
        })));
    }
    /**
     * 获取构件中操作参数的Schema
     * @param {?} componentId 构件Id
     * @param {?} operationCode 操作编号
     * @param {?} paramCode 参数编号
     * @param {?} headers 请求header，应包含sessionId等必需参数
     * @return {?}
     */
    getParamSchema(componentId, operationCode, paramCode, headers) {
        /** @type {?} */
        let url = this.commom_component_url + '?componentId=' + componentId;
        return this.http.get(url, { headers: headers }).pipe(mergeMap((/**
         * @param {?} cmpObj
         * @return {?}
         */
        cmpObj => {
            /** @type {?} */
            let serializer = new DefaultGspComponentSerializer();
            /** @type {?} */
            let ctxt = new DefaultGspComponentSerializeContext();
            /** @type {?} */
            let cmp = serializer.deserialize(cmpObj, ctxt);
            /** @type {?} */
            let op = cmp.operations.find((/**
             * @param {?} x
             * @return {?}
             */
            x => x.code == operationCode));
            if (op == null) {
                throw new Error(`CommonComponent Operation NotFound，OperationCode: ${operationCode}`);
            }
            /** @type {?} */
            let param = op.parameters.find((/**
             * @param {?} x
             * @return {?}
             */
            x => x.code == paramCode));
            if (param == null) {
                throw new Error(`CommonComponent Parameter NotFound，ParameterCode: ${paramCode}`);
            }
            /** @type {?} */
            let paramType = param.parameterType;
            /** @type {?} */
            let result;
            //引用类型
            if (paramType instanceof StructureReferType) {
                return this.getStructureReferType(cmp, paramType, headers);
            }
            //列表类型
            else if (paramType instanceof CollectionType) {
                return this.getCollectionType(cmp, paramType, headers);
            }
            //字典类型
            else if (paramType instanceof MapType) {
                return this.getMapType(cmp, paramType, headers);
            }
            //基本类型
            else {
                return of(paramType);
            }
        })));
    }
    ;
    /**
     * 获取构件中操作返回值的Schema
     * @param {?} componentId 构件Id
     * @param {?} operationCode 操作编号
     * @param {?} headers 请求header，应包含sessionId等必需参数
     * @return {?}
     */
    getReturnValueSchema(componentId, operationCode, headers) {
        /** @type {?} */
        let url = this.commom_component_url + '?componentId=' + componentId;
        return this.http.get(url, { headers: headers }).pipe(mergeMap((/**
         * @param {?} cmpObj
         * @return {?}
         */
        cmpObj => {
            /** @type {?} */
            let serializer = new DefaultGspComponentSerializer();
            /** @type {?} */
            let ctxt = new DefaultGspComponentSerializeContext();
            /** @type {?} */
            let cmp = serializer.deserialize(cmpObj, ctxt);
            /** @type {?} */
            let op = cmp.operations.find((/**
             * @param {?} x
             * @return {?}
             */
            x => x.code == operationCode));
            if (op == null) {
                throw new Error(`CommonComponent Operation NotFound，OperationCode: ${operationCode}`);
            }
            /** @type {?} */
            let returnType = op.returnType;
            /** @type {?} */
            let result;
            //引用类型
            if (returnType instanceof StructureReferType) {
                return this.getStructureReferType(cmp, returnType, headers);
            }
            //列表类型
            else if (returnType instanceof CollectionType) {
                return this.getCollectionType(cmp, returnType, headers);
            }
            //字典类型
            else if (returnType instanceof MapType) {
                return this.getMapType(cmp, returnType, headers);
            }
            //基本类型
            else {
                return of(returnType);
            }
        })));
    }
    /**
     * @private
     * @param {?} cmp
     * @param {?} dataType
     * @param {?} headers
     * @return {?}
     */
    getCollectionType(cmp, dataType, headers) {
        /** @type {?} */
        let elementType = dataType.elementType;
        if (elementType instanceof StructureReferType) {
            return this.getStructureReferType(cmp, elementType, headers).pipe(map((/**
             * @param {?} structuredType
             * @return {?}
             */
            structuredType => {
                dataType.elementType = structuredType;
                return dataType;
            })));
        }
        else if (elementType instanceof PrimitiveType) {
            return of(dataType);
        }
        else {
            throw new Error(`不支持的列表项类型: ${elementType.getKind()}`);
        }
    }
    /**
     * @private
     * @param {?} cmp
     * @param {?} dataType
     * @param {?} headers
     * @return {?}
     */
    getMapType(cmp, dataType, headers) {
        /** @type {?} */
        let valueType = dataType.valueType;
        if (valueType instanceof StructureReferType) {
            return this.getStructureReferType(cmp, valueType, headers).pipe(map((/**
             * @param {?} structuredType
             * @return {?}
             */
            structuredType => {
                dataType.valueType = structuredType;
                return dataType;
            })));
        }
        else if (valueType instanceof PrimitiveType) {
            return of(dataType);
        }
        else if (valueType instanceof CollectionType) {
            return this.getCollectionType(cmp, valueType, headers).pipe(map((/**
             * @param {?} collectionType
             * @return {?}
             */
            collectionType => {
                dataType.valueType = collectionType;
                return dataType;
            })));
        }
        else {
            throw new Error(`不支持的列表项类型: ${valueType.getKind()}`);
        }
    }
    /**
     * @private
     * @param {?} cmp
     * @param {?} referType
     * @param {?} headers
     * @return {?}
     */
    getStructureReferType(cmp, referType, headers) {
        /** @type {?} */
        let refInfo = cmp.refStructures.find((/**
         * @param {?} x
         * @return {?}
         */
        x => x.id == referType.referId));
        return this.structureSvc.get(refInfo.referType, refInfo.referId, headers).pipe(map((/**
         * @param {?} structureObj
         * @return {?}
         */
        structureObj => {
            //使用默认serializeContext进行反序列化
            /** @type {?} */
            let serializeCtxt = new DefaultSerializeContext();
            /** @type {?} */
            let kind = structureObj['kind'];
            /** @type {?} */
            let serializer = serializeCtxt.getStructureSerializerFactory().get(kind);
            /** @type {?} */
            let structure = (/** @type {?} */ (serializer.deserialize(structureObj, serializeCtxt)));
            /** @type {?} */
            let structuredTypeId = refInfo.structuredTypeId;
            /** @type {?} */
            let allStructures = this.getAllStructures(structure);
            /** @type {?} */
            let referType = allStructures.find((/**
             * @param {?} x
             * @return {?}
             */
            x => x.id == structuredTypeId));
            return referType;
        })));
    }
    /**
     * @private
     * @param {?} structure
     * @return {?}
     */
    getAllStructures(structure) {
        /** @type {?} */
        let array = new Array();
        if (structure.structuredTypes != null) {
            array = array.concat(structure.structuredTypes);
        }
        if (structure.refStructures != null) {
            structure.refStructures.forEach((/**
             * @param {?} refStructure
             * @return {?}
             */
            refStructure => {
                if (refStructure.structuredTypes != null) {
                    array = array.concat(refStructure.structuredTypes);
                }
            }));
        }
        return array;
    }
}
CommonComponentService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
CommonComponentService.ctorParameters = () => [
    { type: HttpClient },
    { type: CommonStructureDTService }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    CommonComponentService.prototype.commom_component_url;
    /**
     * @type {?}
     * @private
     */
    CommonComponentService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    CommonComponentService.prototype.structureSvc;
    /* Skipping unhandled member: ;*/
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbW9uLWNvbXBvbmVudC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGdzcC1jbXAvY29tbW9uLWNvbXBvbmVudC8iLCJzb3VyY2VzIjpbInNlcnZpY2UvY29tbW9uLWNvbXBvbmVudC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxVQUFVLEVBQWUsTUFBTSxzQkFBc0IsQ0FBQztBQUMvRCxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDL0MsT0FBTyxFQUFFLHVCQUF1QixFQUFhLHdCQUF3QixFQUFhLGNBQWMsRUFBRSxPQUFPLEVBQTJELGFBQWEsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3JOLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxNQUFNLDBFQUEwRSxDQUFDO0FBQ3pILE9BQU8sRUFBRSxtQ0FBbUMsRUFBRSxNQUFNLHNFQUFzRSxDQUFDO0FBRTNILE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBSzlFLE1BQU0sT0FBTyxzQkFBc0I7Ozs7O0lBSy9CLFlBQW9CLElBQWdCLEVBQVUsWUFBc0M7UUFBaEUsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUEwQjtRQUg1RSx5QkFBb0IsR0FBRyx3Q0FBd0MsQ0FBQztJQUdnQixDQUFDOzs7Ozs7SUFHekYsWUFBWSxDQUFDLFdBQW1CLEVBQUUsT0FBb0I7O1lBQzlDLEdBQUcsR0FBRyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsZUFBZSxHQUFHLFdBQVc7UUFDbkUsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FB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UyxDQUFDLGVBQWUsSUFBSSxJQUFJLEVBQUU7WUFDbkMsS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1NBQ25EO1FBQ0QsSUFBSSxTQUFTLENBQUMsYUFBYSxJQUFJLElBQUksRUFBRTtZQUNqQyxTQUFTLENBQUMsYUFBYSxDQUFDLE9BQU87Ozs7WUFBQyxZQUFZLENBQUMsRUFBRTtnQkFDM0MsSUFBSSxZQUFZLENBQUMsZUFBZSxJQUFJLElBQUksRUFBRTtvQkFDdEMsS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxDQUFDO2lCQUN0RDtZQUNMLENBQUMsRUFBQyxDQUFBO1NBQ0w7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDOzs7WUF6S0osVUFBVTs7OztZQVhGLFVBQVU7WUFHMEIsd0JBQXdCOzs7Ozs7O0lBV2pFLHNEQUF3RTs7Ozs7SUFHNUQsc0NBQXdCOzs7OztJQUFFLDhDQUE4QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgbWFwLCBtZXJnZU1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgRGVmYXVsdFNlcmlhbGl6ZUNvbnRleHQsIElEYXRhVHlwZSwgQ29tbW9uU3RydWN0dXJlRFRTZXJ2aWNlLCBPcGVyYXRpb24sIENvbGxlY3Rpb25UeXBlLCBNYXBUeXBlLCBFbnRpdHlPYmplY3QsIENvbW1vblN0cnVjdHVyZSwgU3RydWN0dXJlZFR5cGUsIERhdGFUeXBlLCBQcmltaXRpdmVUeXBlIH0gZnJvbSAnQGVjcC1jYWYvY29tbW9uLXN0cnVjdHVyZSc7XHJcbmltcG9ydCB7IERlZmF1bHRHc3BDb21wb25lbnRTZXJpYWxpemVyIH0gZnJvbSAnLi4vc2VyaWFsaXplLWNvbnRleHQvZGVmYXVsdC9zZXJpYWxpemVyL2RlZmF1bHQtZ3NwLWNvbXBvbmVudC1zZXJpYWxpemVyJztcclxuaW1wb3J0IHsgRGVmYXVsdEdzcENvbXBvbmVudFNlcmlhbGl6ZUNvbnRleHQgfSBmcm9tICcuLi9zZXJpYWxpemUtY29udGV4dC9kZWZhdWx0L2RlZmF1bHQtZ3NwLWNvbXBvbmVudC1zZXJpYWxpemUtY29udGV4dCc7XHJcbmltcG9ydCB7IEdzcENvbXBvbmVudCB9IGZyb20gJy4uL2RlZmluZS9nc3AtY29tcG9uZW50JztcclxuaW1wb3J0IHsgU3RydWN0dXJlUmVmZXJUeXBlIH0gZnJvbSAnLi4vZGVmaW5lL2RhdGEtdHlwZS9zdHJ1Y3R1cmUtcmVmZXItdHlwZSc7XHJcbmltcG9ydCB7IFJlZlN0cnVjdHVyZUluZm8gfSBmcm9tICcuLi9kZWZpbmUvcmVmLXN0cnVjdHVyZS1pbmZvJztcclxuXHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBDb21tb25Db21wb25lbnRTZXJ2aWNlIHtcclxuXHJcbiAgICBwcml2YXRlIGNvbW1vbV9jb21wb25lbnRfdXJsID0gJy9hcGkvcnVudGltZS9zeXMvdjEuMC9jb21tb24tY29tcG9uZW50JztcclxuXHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LCBwcml2YXRlIHN0cnVjdHVyZVN2YzogQ29tbW9uU3RydWN0dXJlRFRTZXJ2aWNlKSB7IH1cclxuXHJcblxyXG4gICAgZ2V0Q29tcG9uZW50KGNvbXBvbmVudElkOiBzdHJpbmcsIGhlYWRlcnM6IEh0dHBIZWFkZXJzKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgICAgICBsZXQgdXJsID0gdGhpcy5jb21tb21fY29tcG9uZW50X3VybCArICc/Y29tcG9uZW50SWQ9JyArIGNvbXBvbmVudElkO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KHVybCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pLnBpcGUobWFwKGNtcE9iaiA9PiB7XHJcbiAgICAgICAgICAgIGxldCBzZXJpYWxpemVyOiBEZWZhdWx0R3NwQ29tcG9uZW50U2VyaWFsaXplciA9IG5ldyBEZWZhdWx0R3NwQ29tcG9uZW50U2VyaWFsaXplcigpO1xyXG4gICAgICAgICAgICBsZXQgY3R4dDogRGVmYXVsdEdzcENvbXBvbmVudFNlcmlhbGl6ZUNvbnRleHQgPSBuZXcgRGVmYXVsdEdzcENvbXBvbmVudFNlcmlhbGl6ZUNvbnRleHQoKTtcclxuICAgICAgICAgICAgbGV0IGNtcDogR3NwQ29tcG9uZW50ID0gc2VyaWFsaXplci5kZXNlcmlhbGl6ZShjbXBPYmosIGN0eHQpO1xyXG4gICAgICAgICAgICByZXR1cm4gY21wO1xyXG4gICAgICAgIH0pKVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6I635Y+W5p6E5Lu25Lit5pON5L2c5Y+C5pWw55qEU2NoZW1hXHJcbiAgICAgKiBAcGFyYW0gY29tcG9uZW50SWQg5p6E5Lu2SWRcclxuICAgICAqIEBwYXJhbSBvcGVyYXRpb25Db2RlIOaTjeS9nOe8luWPt1xyXG4gICAgICogQHBhcmFtIHBhcmFtQ29kZSDlj4LmlbDnvJblj7dcclxuICAgICAqIEBwYXJhbSBoZWFkZXJzIOivt+axgmhlYWRlcu+8jOW6lOWMheWQq3Nlc3Npb25JZOetieW/hemcgOWPguaVsFxyXG4gICAgICovXHJcbiAgICBnZXRQYXJhbVNjaGVtYShjb21wb25lbnRJZDogc3RyaW5nLCBvcGVyYXRpb25Db2RlOiBzdHJpbmcsIHBhcmFtQ29kZTogc3RyaW5nLCBoZWFkZXJzOiBIdHRwSGVhZGVycyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICAgICAgbGV0IHVybCA9IHRoaXMuY29tbW9tX2NvbXBvbmVudF91cmwgKyAnP2NvbXBvbmVudElkPScgKyBjb21wb25lbnRJZDtcclxuICAgICAgICByZXR1cm4gdGhpcy5odHRwLmdldDxhbnk+KHVybCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pLnBpcGUobWVyZ2VNYXAoY21wT2JqID0+IHtcclxuICAgICAgICAgICAgbGV0IHNlcmlhbGl6ZXI6IERlZmF1bHRHc3BDb21wb25lbnRTZXJpYWxpemVyID0gbmV3IERlZmF1bHRHc3BDb21wb25lbnRTZXJpYWxpemVyKCk7XHJcbiAgICAgICAgICAgIGxldCBjdHh0OiBEZWZhdWx0R3NwQ29tcG9uZW50U2VyaWFsaXplQ29udGV4dCA9IG5ldyBEZWZhdWx0R3NwQ29tcG9uZW50U2VyaWFsaXplQ29udGV4dCgpO1xyXG4gICAgICAgICAgICBsZXQgY21wOiBHc3BDb21wb25lbnQgPSBzZXJpYWxpemVyLmRlc2VyaWFsaXplKGNtcE9iaiwgY3R4dCk7XHJcbiAgICAgICAgICAgIGxldCBvcDogT3BlcmF0aW9uID0gY21wLm9wZXJhdGlvbnMuZmluZCh4ID0+IHguY29kZSA9PSBvcGVyYXRpb25Db2RlKTtcclxuICAgICAgICAgICAgaWYgKG9wID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ29tbW9uQ29tcG9uZW50IE9wZXJhdGlvbiBOb3RGb3VuZO+8jE9wZXJhdGlvbkNvZGU6ICR7b3BlcmF0aW9uQ29kZX1gKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgcGFyYW0gPSBvcC5wYXJhbWV0ZXJzLmZpbmQoeCA9PiB4LmNvZGUgPT0gcGFyYW1Db2RlKTtcclxuICAgICAgICAgICAgaWYgKHBhcmFtID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ29tbW9uQ29tcG9uZW50IFBhcmFtZXRlciBOb3RGb3VuZO+8jFBhcmFtZXRlckNvZGU6ICR7cGFyYW1Db2RlfWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCBwYXJhbVR5cGUgPSBwYXJhbS5wYXJhbWV0ZXJUeXBlO1xyXG4gICAgICAgICAgICBsZXQgcmVzdWx0OiBJRGF0YVR5cGU7XHJcbiAgICAgICAgICAgIC8v5byV55So57G75Z6LXHJcbiAgICAgICAgICAgIGlmIChwYXJhbVR5cGUgaW5zdGFuY2VvZiBTdHJ1Y3R1cmVSZWZlclR5cGUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFN0cnVjdHVyZVJlZmVyVHlwZShjbXAsIHBhcmFtVHlwZSwgaGVhZGVycyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy/liJfooajnsbvlnotcclxuICAgICAgICAgICAgZWxzZSBpZiAocGFyYW1UeXBlIGluc3RhbmNlb2YgQ29sbGVjdGlvblR5cGUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldENvbGxlY3Rpb25UeXBlKGNtcCwgcGFyYW1UeXBlLCBoZWFkZXJzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvL+Wtl+WFuOexu+Wei1xyXG4gICAgICAgICAgICBlbHNlIGlmIChwYXJhbVR5cGUgaW5zdGFuY2VvZiBNYXBUeXBlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRNYXBUeXBlKGNtcCwgcGFyYW1UeXBlLCBoZWFkZXJzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvL+WfuuacrOexu+Wei1xyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBvZihwYXJhbVR5cGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPluaehOS7tuS4reaTjeS9nOi/lOWbnuWAvOeahFNjaGVtYVxyXG4gICAgICogQHBhcmFtIGNvbXBvbmVudElkIOaehOS7tklkXHJcbiAgICAgKiBAcGFyYW0gb3BlcmF0aW9uQ29kZSDmk43kvZznvJblj7dcclxuICAgICAqIEBwYXJhbSBoZWFkZXJzIOivt+axgmhlYWRlcu+8jOW6lOWMheWQq3Nlc3Npb25JZOetieW/hemcgOWPguaVsFxyXG4gICAgICovXHJcbiAgICBnZXRSZXR1cm5WYWx1ZVNjaGVtYShjb21wb25lbnRJZDogc3RyaW5nLCBvcGVyYXRpb25Db2RlOiBzdHJpbmcsIGhlYWRlcnM6IEh0dHBIZWFkZXJzKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgICAgICBsZXQgdXJsID0gdGhpcy5jb21tb21fY29tcG9uZW50X3VybCArICc/Y29tcG9uZW50SWQ9JyArIGNvbXBvbmVudElkO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PGFueT4odXJsLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSkucGlwZShtZXJnZU1hcChjbXBPYmogPT4ge1xyXG4gICAgICAgICAgICBsZXQgc2VyaWFsaXplcjogRGVmYXVsdEdzcENvbXBvbmVudFNlcmlhbGl6ZXIgPSBuZXcgRGVmYXVsdEdzcENvbXBvbmVudFNlcmlhbGl6ZXIoKTtcclxuICAgICAgICAgICAgbGV0IGN0eHQ6IERlZmF1bHRHc3BDb21wb25lbnRTZXJpYWxpemVDb250ZXh0ID0gbmV3IERlZmF1bHRHc3BDb21wb25lbnRTZXJpYWxpemVDb250ZXh0KCk7XHJcbiAgICAgICAgICAgIGxldCBjbXA6IEdzcENvbXBvbmVudCA9IHNlcmlhbGl6ZXIuZGVzZXJpYWxpemUoY21wT2JqLCBjdHh0KTtcclxuICAgICAgICAgICAgbGV0IG9wOiBPcGVyYXRpb24gPSBjbXAub3BlcmF0aW9ucy5maW5kKHggPT4geC5jb2RlID09IG9wZXJhdGlvbkNvZGUpO1xyXG4gICAgICAgICAgICBpZiAob3AgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb21tb25Db21wb25lbnQgT3BlcmF0aW9uIE5vdEZvdW5k77yMT3BlcmF0aW9uQ29kZTogJHtvcGVyYXRpb25Db2RlfWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCByZXR1cm5UeXBlID0gb3AucmV0dXJuVHlwZTtcclxuICAgICAgICAgICAgbGV0IHJlc3VsdDogSURhdGFUeXBlO1xyXG4gICAgICAgICAgICAvL+W8leeUqOexu+Wei1xyXG4gICAgICAgICAgICBpZiAocmV0dXJuVHlwZSBpbnN0YW5jZW9mIFN0cnVjdHVyZVJlZmVyVHlwZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U3RydWN0dXJlUmVmZXJUeXBlKGNtcCwgcmV0dXJuVHlwZSwgaGVhZGVycyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy/liJfooajnsbvlnotcclxuICAgICAgICAgICAgZWxzZSBpZiAocmV0dXJuVHlwZSBpbnN0YW5jZW9mIENvbGxlY3Rpb25UeXBlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRDb2xsZWN0aW9uVHlwZShjbXAsIHJldHVyblR5cGUsIGhlYWRlcnMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8v5a2X5YW457G75Z6LXHJcbiAgICAgICAgICAgIGVsc2UgaWYgKHJldHVyblR5cGUgaW5zdGFuY2VvZiBNYXBUeXBlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRNYXBUeXBlKGNtcCwgcmV0dXJuVHlwZSwgaGVhZGVycyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy/ln7rmnKznsbvlnotcclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb2YocmV0dXJuVHlwZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgKSk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgZ2V0Q29sbGVjdGlvblR5cGUoY21wOiBHc3BDb21wb25lbnQsIGRhdGFUeXBlOiBDb2xsZWN0aW9uVHlwZSwgaGVhZGVyczogSHR0cEhlYWRlcnMpOiBPYnNlcnZhYmxlPENvbGxlY3Rpb25UeXBlPiB7XHJcbiAgICAgICAgbGV0IGVsZW1lbnRUeXBlID0gZGF0YVR5cGUuZWxlbWVudFR5cGU7XHJcbiAgICAgICAgaWYgKGVsZW1lbnRUeXBlIGluc3RhbmNlb2YgU3RydWN0dXJlUmVmZXJUeXBlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFN0cnVjdHVyZVJlZmVyVHlwZShjbXAsIGVsZW1lbnRUeXBlLCBoZWFkZXJzKS5waXBlKG1hcChzdHJ1Y3R1cmVkVHlwZSA9PiB7XHJcbiAgICAgICAgICAgICAgICBkYXRhVHlwZS5lbGVtZW50VHlwZSA9IHN0cnVjdHVyZWRUeXBlXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YVR5cGU7XHJcbiAgICAgICAgICAgIH0pKVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmIChlbGVtZW50VHlwZSBpbnN0YW5jZW9mIFByaW1pdGl2ZVR5cGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9mKGRhdGFUeXBlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihg5LiN5pSv5oyB55qE5YiX6KGo6aG557G75Z6LOiAke2VsZW1lbnRUeXBlLmdldEtpbmQoKX1gKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgZ2V0TWFwVHlwZShjbXA6IEdzcENvbXBvbmVudCwgZGF0YVR5cGU6IE1hcFR5cGUsIGhlYWRlcnM6IEh0dHBIZWFkZXJzKTogT2JzZXJ2YWJsZTxNYXBUeXBlPiB7XHJcbiAgICAgICAgbGV0IHZhbHVlVHlwZSA9IGRhdGFUeXBlLnZhbHVlVHlwZTtcclxuICAgICAgICBpZiAodmFsdWVUeXBlIGluc3RhbmNlb2YgU3RydWN0dXJlUmVmZXJUeXBlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFN0cnVjdHVyZVJlZmVyVHlwZShjbXAsIHZhbHVlVHlwZSwgaGVhZGVycykucGlwZShtYXAoc3RydWN0dXJlZFR5cGUgPT4ge1xyXG4gICAgICAgICAgICAgICAgZGF0YVR5cGUudmFsdWVUeXBlID0gc3RydWN0dXJlZFR5cGU7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YVR5cGU7XHJcbiAgICAgICAgICAgIH0pKVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmICh2YWx1ZVR5cGUgaW5zdGFuY2VvZiBQcmltaXRpdmVUeXBlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBvZihkYXRhVHlwZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKHZhbHVlVHlwZSBpbnN0YW5jZW9mIENvbGxlY3Rpb25UeXBlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldENvbGxlY3Rpb25UeXBlKGNtcCwgdmFsdWVUeXBlLCBoZWFkZXJzKS5waXBlKG1hcChjb2xsZWN0aW9uVHlwZSA9PiB7XHJcbiAgICAgICAgICAgICAgICBkYXRhVHlwZS52YWx1ZVR5cGUgPSBjb2xsZWN0aW9uVHlwZTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBkYXRhVHlwZTtcclxuICAgICAgICAgICAgfSkpXHJcblxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGDkuI3mlK/mjIHnmoTliJfooajpobnnsbvlnos6ICR7dmFsdWVUeXBlLmdldEtpbmQoKX1gKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgZ2V0U3RydWN0dXJlUmVmZXJUeXBlKGNtcDogR3NwQ29tcG9uZW50LCByZWZlclR5cGU6IFN0cnVjdHVyZVJlZmVyVHlwZSwgaGVhZGVyczogSHR0cEhlYWRlcnMpOiBPYnNlcnZhYmxlPFN0cnVjdHVyZWRUeXBlPiB7XHJcbiAgICAgICAgbGV0IHJlZkluZm86IFJlZlN0cnVjdHVyZUluZm8gPSBjbXAucmVmU3RydWN0dXJlcy5maW5kKHggPT4geC5pZCA9PSByZWZlclR5cGUucmVmZXJJZCk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RydWN0dXJlU3ZjLmdldChyZWZJbmZvLnJlZmVyVHlwZSwgcmVmSW5mby5yZWZlcklkLCBoZWFkZXJzKS5waXBlKG1hcChzdHJ1Y3R1cmVPYmogPT4ge1xyXG4gICAgICAgICAgICAvL+S9v+eUqOm7mOiupHNlcmlhbGl6ZUNvbnRleHTov5vooYzlj43luo/liJfljJZcclxuICAgICAgICAgICAgbGV0IHNlcmlhbGl6ZUN0eHQgPSBuZXcgRGVmYXVsdFNlcmlhbGl6ZUNvbnRleHQoKTtcclxuICAgICAgICAgICAgbGV0IGtpbmQgPSBzdHJ1Y3R1cmVPYmpbJ2tpbmQnXTtcclxuICAgICAgICAgICAgbGV0IHNlcmlhbGl6ZXIgPSBzZXJpYWxpemVDdHh0LmdldFN0cnVjdHVyZVNlcmlhbGl6ZXJGYWN0b3J5KCkuZ2V0KGtpbmQpO1xyXG4gICAgICAgICAgICBsZXQgc3RydWN0dXJlID0gc2VyaWFsaXplci5kZXNlcmlhbGl6ZShzdHJ1Y3R1cmVPYmosIHNlcmlhbGl6ZUN0eHQpIGFzIENvbW1vblN0cnVjdHVyZTtcclxuICAgICAgICAgICAgbGV0IHN0cnVjdHVyZWRUeXBlSWQgPSByZWZJbmZvLnN0cnVjdHVyZWRUeXBlSWQ7XHJcbiAgICAgICAgICAgIGxldCBhbGxTdHJ1Y3R1cmVzID0gdGhpcy5nZXRBbGxTdHJ1Y3R1cmVzKHN0cnVjdHVyZSk7XHJcbiAgICAgICAgICAgIGxldCByZWZlclR5cGUgPSBhbGxTdHJ1Y3R1cmVzLmZpbmQoeCA9PiB4LmlkID09IHN0cnVjdHVyZWRUeXBlSWQpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVmZXJUeXBlO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldEFsbFN0cnVjdHVyZXMoc3RydWN0dXJlOiBDb21tb25TdHJ1Y3R1cmUpIHtcclxuICAgICAgICBsZXQgYXJyYXk6IEFycmF5PFN0cnVjdHVyZWRUeXBlPiA9IG5ldyBBcnJheTxTdHJ1Y3R1cmVkVHlwZT4oKTtcclxuICAgICAgICBpZiAoc3RydWN0dXJlLnN0cnVjdHVyZWRUeXBlcyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGFycmF5ID0gYXJyYXkuY29uY2F0KHN0cnVjdHVyZS5zdHJ1Y3R1cmVkVHlwZXMpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoc3RydWN0dXJlLnJlZlN0cnVjdHVyZXMgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBzdHJ1Y3R1cmUucmVmU3RydWN0dXJlcy5mb3JFYWNoKHJlZlN0cnVjdHVyZSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVmU3RydWN0dXJlLnN0cnVjdHVyZWRUeXBlcyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXJyYXkgPSBhcnJheS5jb25jYXQocmVmU3RydWN0dXJlLnN0cnVjdHVyZWRUeXBlcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBhcnJheTtcclxuICAgIH1cclxuXHJcblxyXG59Il19