/**
 * @fileoverview added by tsickle
 * Generated from: lib/service/chgdr.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Injector } from '@angular/core';
import { HttpService, SessionService } from '@ecp-caf/caf-common';
import { of } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { OperateType } from '../model/operate-type';
import { MapUtil } from '../util/map.util';
import * as i0 from "@angular/core";
import * as i1 from "@ecp-caf/caf-common";
/** @type {?} */
var ServerIP = '/';
/** @type {?} */
var chgdrUrl = ServerIP + "api/runtime/chgdr/v1.0";
var ChgdrService = /** @class */ (function () {
    function ChgdrService(http, sessionService, injector) {
        this.http = http;
        this.sessionService = sessionService;
        this.injector = injector;
        this.rootDataCodeFieldsMap = new Map();
    }
    /**
     * @param {?} currentQueryParam
     * @return {?}
     */
    ChgdrService.prototype.queryChangeDataHeader = /**
     * @param {?} currentQueryParam
     * @return {?}
     */
    function (currentQueryParam) {
        var _this = this;
        /** @type {?} */
        var obj = Object.assign({}, currentQueryParam);
        if (currentQueryParam.dataCode) {
            obj.dataCode = MapUtil.convertMapToObject(currentQueryParam.dataCode);
        }
        /** @type {?} */
        var json = JSON.stringify(obj);
        /** @type {?} */
        var queryParam = encodeURIComponent(json);
        /** @type {?} */
        var url = chgdrUrl + "?queryParam=" + queryParam;
        return this.http.get(url).pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            if (!data) {
                return data;
            }
            /** @type {?} */
            var queryResult = (/** @type {?} */ ((/** @type {?} */ (data))));
            queryResult && queryResult.headers && queryResult.headers.forEach((/**
             * @param {?} header
             * @return {?}
             */
            function (header) {
                //TODO 待删，兼容老数据格式
                if (typeof header.dataCode == "string") {
                    header.dataCode = JSON.parse(header.dataCode);
                }
                header.dataCode = MapUtil.convertObjectToMap(header.dataCode);
                header.changeTime = _this.toDate(header.changeTime);
                header.operateType = OperateType.parse(header.operateType);
            }));
            return queryResult;
        })));
    };
    /**
     * @param {?} beId
     * @return {?}
     */
    ChgdrService.prototype.getRootEntityDataCodeFields = /**
     * @param {?} beId
     * @return {?}
     */
    function (beId) {
        var _this = this;
        if (!beId) {
            return of([]);
        }
        if (this.rootDataCodeFieldsMap.has(beId)) {
            //直接从缓存中获取
            return of(this.rootDataCodeFieldsMap.get(beId));
        }
        else {
            //获取结果并存入缓存
            /** @type {?} */
            var url = chgdrUrl + "/rootDataCodeFields?beId=" + beId;
            return ((/** @type {?} */ ((/** @type {?} */ ((this.http.get(url)))))))
                .pipe(tap((/**
             * @param {?} data
             * @return {?}
             */
            function (data) { return _this.rootDataCodeFieldsMap.set(beId, data); })));
        }
    };
    /** 将字符串或数字转为Date */
    /**
     * 将字符串或数字转为Date
     * @private
     * @param {?} date
     * @return {?}
     */
    ChgdrService.prototype.toDate = /**
     * 将字符串或数字转为Date
     * @private
     * @param {?} date
     * @return {?}
     */
    function (date) {
        if (typeof date == "string") {
            return new Date(date);
        }
        else if (typeof date == "number") {
            return new Date(date);
        }
        else {
            return date;
        }
    };
    /**
     * @param {?} idOrParam
     * @param {?=} changeTime
     * @return {?}
     */
    ChgdrService.prototype.getChangeData = /**
     * @param {?} idOrParam
     * @param {?=} changeTime
     * @return {?}
     */
    function (idOrParam, changeTime) {
        if (idOrParam == null) {
            throw new Error("id can not be null");
        }
        if (idOrParam instanceof String || typeof idOrParam == "string") {
            return this.getChangeDataById((/** @type {?} */ (idOrParam)), changeTime);
        }
        else {
            return this.getChangeDataByParam(idOrParam);
        }
    };
    /**
     * @private
     * @param {?} id
     * @param {?} changeTime
     * @return {?}
     */
    ChgdrService.prototype.getChangeDataById = /**
     * @private
     * @param {?} id
     * @param {?} changeTime
     * @return {?}
     */
    function (id, changeTime) {
        var _this = this;
        /** @type {?} */
        var json = JSON.stringify(changeTime);
        /** @type {?} */
        var queryParam = encodeURIComponent(json);
        /** @type {?} */
        var url = chgdrUrl + "/" + id + "?changeTime=" + queryParam;
        return this.http.get(url).pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            return _this.transChangeDataFromResponse(data);
        })));
    };
    /**
     * @private
     * @param {?} param
     * @return {?}
     */
    ChgdrService.prototype.getChangeDataByParam = /**
     * @private
     * @param {?} param
     * @return {?}
     */
    function (param) {
        var _this = this;
        if (param == null) {
            throw new Error("ChgdrItemQueryParam can not be null");
        }
        /** @type {?} */
        var requestParam = {};
        Object.assign(requestParam, param);
        //将Map转为Object，否则无法正常序列化
        requestParam.dataIds = MapUtil.convertMapToObject(param.dataIds);
        /** @type {?} */
        var url = "" + chgdrUrl;
        return this.http.post(url, requestParam).pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            return _this.transChangeDataFromResponse(data);
        })));
    };
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    ChgdrService.prototype.transChangeDataFromResponse = /**
     * @private
     * @param {?} data
     * @return {?}
     */
    function (data) {
        if (!data) {
            return data;
        }
        /** @type {?} */
        var sh = (/** @type {?} */ ((/** @type {?} */ (data))));
        //TODO 待删，兼容老数据格式
        if (typeof sh.dataCode == "string") {
            sh.dataCode = JSON.parse(sh.dataCode);
        }
        sh.dataCode = MapUtil.convertObjectToMap(sh.dataCode);
        sh.changeTime = this.toDate(sh.changeTime);
        sh.operateType = OperateType.parse(sh.operateType);
        sh.rows = this.transChangeDataRowsFromResponse(sh.rows || []);
        return sh;
    };
    /**
     * @private
     * @param {?} rows
     * @return {?}
     */
    ChgdrService.prototype.transChangeDataRowsFromResponse = /**
     * @private
     * @param {?} rows
     * @return {?}
     */
    function (rows) {
        if (!rows || rows.length == 0) {
            return rows;
        }
        rows.forEach((/**
         * @param {?} row
         * @return {?}
         */
        function (row) {
            if (!row) {
                return;
            }
            row.operateType = OperateType.parse(row.operateType);
            //TODO 待删，兼容老数据格式
            if (typeof row.dataCode == "string") {
                row.dataCode = JSON.parse(row.dataCode);
            }
            row.dataCode = MapUtil.convertObjectToMap(row.dataCode);
            row.oldContent = (/** @type {?} */ (MapUtil.convertObjectToMap(row.oldContent))) || new Map();
            row.newContent = (/** @type {?} */ (MapUtil.convertObjectToMap(row.newContent))) || new Map();
        }));
        return rows;
    };
    ChgdrService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    ChgdrService.ctorParameters = function () { return [
        { type: HttpService },
        { type: SessionService },
        { type: Injector }
    ]; };
    /** @nocollapse */ ChgdrService.ngInjectableDef = i0.defineInjectable({ factory: function ChgdrService_Factory() { return new ChgdrService(i0.inject(i1.HttpService), i0.inject(i1.SessionService), i0.inject(i0.INJECTOR)); }, token: ChgdrService, providedIn: "root" });
    return ChgdrService;
}());
export { ChgdrService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    ChgdrService.prototype.rootDataCodeFieldsMap;
    /**
     * @type {?}
     * @private
     */
    ChgdrService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    ChgdrService.prototype.sessionService;
    /**
     * @type {?}
     * @private
     */
    ChgdrService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hnZHIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bnc3AtY21wL2NoZ2RyLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2UvY2hnZHIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxXQUFXLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbEUsT0FBTyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0QyxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBTzFDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7Ozs7SUFFckMsUUFBUSxHQUFHLEdBQUc7O0lBQ2QsUUFBUSxHQUFNLFFBQVEsMkJBQXdCO0FBRXBEO0lBTUUsc0JBQW9CLElBQWlCLEVBQzNCLGNBQThCLEVBQzlCLFFBQWtCO1FBRlIsU0FBSSxHQUFKLElBQUksQ0FBYTtRQUMzQixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDOUIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUpwQiwwQkFBcUIsR0FBcUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUk1QyxDQUFDOzs7OztJQUUxQiw0Q0FBcUI7Ozs7SUFBNUIsVUFBNkIsaUJBQXVDO1FBQXBFLGlCQTBCQzs7WUF6QkssR0FBRyxHQUFRLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLGlCQUFpQixDQUFDO1FBQ25ELElBQUksaUJBQWlCLENBQUMsUUFBUSxFQUFFO1lBQzlCLEdBQUcsQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3ZFOztZQUVHLElBQUksR0FBRyxJ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R0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUNyRCxpQkFBaUI7WUFDakIsSUFBSSxPQUFPLEdBQUcsQ0FBQyxRQUFRLElBQUksUUFBUSxFQUFFO2dCQUNuQyxHQUFHLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ3pDO1lBQ0QsR0FBRyxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3hELEdBQUcsQ0FBQyxVQUFVLEdBQUcsbUJBQXFCLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEVBQUEsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDO1lBQzlGLEdBQUcsQ0FBQyxVQUFVLEdBQUcsbUJBQXFCLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEVBQUEsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2hHLENBQUMsRUFBQyxDQUFDO1FBRUgsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDOztnQkEvSUYsVUFBVSxTQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQjs7OztnQkFqQlEsV0FBVztnQkFBRSxjQUFjO2dCQURmLFFBQVE7Ozt1QkFBN0I7Q0FnS0MsQUFoSkQsSUFnSkM7U0E3SVksWUFBWTs7Ozs7O0lBQ3ZCLDZDQUE0RTs7Ozs7SUFFaEUsNEJBQXlCOzs7OztJQUNuQyxzQ0FBc0M7Ozs7O0lBQ3RDLGdDQUEwQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwU2VydmljZSwgU2Vzc2lvblNlcnZpY2UgfSBmcm9tICdAZWNwLWNhZi9jYWYtY29tbW9uJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IENoYW5nZURhdGFDb21wSGVhZGVyLCBDaGFuZ2VEYXRhSGVhZGVyIH0gZnJvbSAnLi4vbW9kZWwvY2hhbmdlLWRhdGEtaGVhZGVyJztcbmltcG9ydCB7IENoYW5nZURhdGFRdWVyeVBhcmFtIH0gZnJvbSAnLi4vbW9kZWwvY2hhbmdlLWRhdGEtcXVlcnktcGFyYW0nO1xuaW1wb3J0IHsgQ2hhbmdlRGF0YVF1ZXJ5UmVzdWx0IH0gZnJvbSAnLi4vbW9kZWwvY2hhbmdlLWRhdGEtcXVlcnktcmVzdWx0JztcbmltcG9ydCB7IENoYW5nZURhdGFSb3cgfSBmcm9tICcuLi9tb2RlbC9jaGFuZ2UtZGF0YS1yb3cnO1xuaW1wb3J0IHsgQ2hnTG9nQ29uZmlnRmllbGQgfSBmcm9tICcuLi9tb2RlbC9jaGdkci1jb25maWctZmllbGQnO1xuaW1wb3J0IHsgQ2hnZHJJdGVtUXVlcnlQYXJhbSB9IGZyb20gJy4uL21vZGVsL2NoZ2RyLWl0ZW0tcXVlcnktcGFyYW0nO1xuaW1wb3J0IHsgT3BlcmF0ZVR5cGUgfSBmcm9tICcuLi9tb2RlbC9vcGVyYXRlLXR5cGUnO1xuaW1wb3J0IHsgTWFwVXRpbCB9IGZyb20gJy4uL3V0aWwvbWFwLnV0aWwnO1xuXG5jb25zdCBTZXJ2ZXJJUCA9ICcvJztcbmNvbnN0IGNoZ2RyVXJsID0gYCR7U2VydmVySVB9YXBpL3J1bnRpbWUvY2hnZHIvdjEuMGA7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIENoZ2RyU2VydmljZSB7XG4gIHByaXZhdGUgcm9vdERhdGFDb2RlRmllbGRzTWFwOiBNYXA8c3RyaW5nLCBDaGdMb2dDb25maWdGaWVsZFtdPiA9IG5ldyBNYXAoKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBTZXJ2aWNlLFxuICAgIHByaXZhdGUgc2Vzc2lvblNlcnZpY2U6IFNlc3Npb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yKSB7IH1cblxuICBwdWJsaWMgcXVlcnlDaGFuZ2VEYXRhSGVhZGVyKGN1cnJlbnRRdWVyeVBhcmFtOiBDaGFuZ2VEYXRhUXVlcnlQYXJhbSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgbGV0IG9iajogYW55ID0gT2JqZWN0LmFzc2lnbih7fSwgY3VycmVudFF1ZXJ5UGFyYW0pO1xuICAgIGlmIChjdXJyZW50UXVlcnlQYXJhbS5kYXRhQ29kZSkge1xuICAgICAgb2JqLmRhdGFDb2RlID0gTWFwVXRpbC5jb252ZXJ0TWFwVG9PYmplY3QoY3VycmVudFF1ZXJ5UGFyYW0uZGF0YUNvZGUpO1xuICAgIH1cblxuICAgIGxldCBqc29uID0gSlNPTi5zdHJpbmdpZnkob2JqKTtcbiAgICBsZXQgcXVlcnlQYXJhbSA9IGVuY29kZVVSSUNvbXBvbmVudChqc29uKTtcbiAgICBsZXQgdXJsID0gYCR7Y2hnZHJVcmx9P3F1ZXJ5UGFyYW09JHtxdWVyeVBhcmFtfWA7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodXJsKS5waXBlKG1hcChkYXRhID0+IHtcbiAgICAgIGlmICghZGF0YSkge1xuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgIH1cbiAgICAgIGxldCBxdWVyeVJlc3VsdDogQ2hhbmdlRGF0YVF1ZXJ5UmVzdWx0ID0gPENoYW5nZURhdGFRdWVyeVJlc3VsdD48dW5rbm93bj5kYXRhO1xuICAgICAgcXVlcnlSZXN1bHQgJiYgcXVlcnlSZXN1bHQuaGVhZGVycyAmJiBxdWVyeVJlc3VsdC5oZWFkZXJzLmZvckVhY2goaGVhZGVyID0+IHtcbiAgICAgICAgLy9UT0RPIOW+heWIoO+8jOWFvOWuueiAgeaVsOaNruagvOW8j1xuICAgICAgICBpZiAodHlwZW9mIGhlYWRlci5kYXRhQ29kZSA9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgaGVhZGVyLmRhdGFDb2RlID0gSlNPTi5wYXJzZShoZWFkZXIuZGF0YUNvZGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaGVhZGVyLmRhdGFDb2RlID0gTWFwVXRpbC5jb252ZXJ0T2JqZWN0VG9NYXAoaGVhZGVyLmRhdGFDb2RlKTtcbiAgICAgICAgaGVhZGVyLmNoYW5nZVRpbWUgPSB0aGlzLnRvRGF0ZShoZWFkZXIuY2hhbmdlVGltZSk7XG4gICAgICAgIGhlYWRlci5vcGVyYXRlVHlwZSA9IE9wZXJhdGVUeXBlLnBhcnNlKGhlYWRlci5vcGVyYXRlVHlwZSk7XG4gICAgICB9KVxuICAgICAgcmV0dXJuIHF1ZXJ5UmVzdWx0O1xuICAgIH0pKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRSb290RW50aXR5RGF0YUNvZGVGaWVsZHMoYmVJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxDaGdMb2dDb25maWdGaWVsZFtdPiB7XG4gICAgaWYgKCFiZUlkKSB7XG4gICAgICByZXR1cm4gb2YoW10pO1xuICAgIH1cbiAgICBpZiAodGhpcy5yb290RGF0YUNvZGVGaWVsZHNNYXAuaGFzKGJlSWQpKSB7XG4gICAgICAvL+ebtOaOpeS7jue8k+WtmOS4reiOt+WPllxuICAgICAgcmV0dXJuIG9mKHRoaXMucm9vdERhdGFDb2RlRmllbGRzTWFwLmdldChiZUlkKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8v6I635Y+W57uT5p6c5bm25a2Y5YWl57yT5a2YXG4gICAgICBsZXQgdXJsID0gYCR7Y2hnZHJVcmx9L3Jvb3REYXRhQ29kZUZpZWxkcz9iZUlkPSR7YmVJZH1gO1xuICAgICAgcmV0dXJuICg8T2JzZXJ2YWJsZTxDaGdMb2dDb25maWdGaWVsZFtdPj48dW5rbm93bj4odGhpcy5odHRwLmdldCh1cmwpKSlcbiAgICAgICAgLnBpcGUodGFwKGRhdGEgPT4gdGhpcy5yb290RGF0YUNvZGVGaWVsZHNNYXAuc2V0KGJlSWQsIGRhdGEpKSk7XG4gICAgfVxuICB9XG5cbiAgLyoqIOWwhuWtl+espuS4suaIluaVsOWtl+i9rOS4ukRhdGUgKi9cbiAgcHJpdmF0ZSB0b0RhdGUoZGF0ZTogYW55KTogRGF0ZSB7XG4gICAgaWYgKHR5cGVvZiBkYXRlID09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiBuZXcgRGF0ZShkYXRlKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBkYXRlID09IFwibnVtYmVyXCIpIHtcbiAgICAgIHJldHVybiBuZXcgRGF0ZShkYXRlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGRhdGU7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOafpeivouS4muWKoeWPmOabtOaXpeW/l+ivpue7huaVsOaNruOAglxuICAgKiBAcGFyYW0gaWQgaGVhZGVySWRcbiAgICogQHBhcmFtIGNoYW5nZVRpbWUg5Y+Y5pu05pe26Ze077yM5ZKMaGVhZGVyLmNoYW5nZVRpbWXkv53mjIHkuIDoh7RcbiAgICovXG4gIHB1YmxpYyBnZXRDaGFuZ2VEYXRhKGhlYWRlcklkOiBzdHJpbmcsIGNoYW5nZVRpbWU6IERhdGUpOiBPYnNlcnZhYmxlPGFueT5cbiAgcHVibGljIGdldENoYW5nZURhdGEocGFyYW06IENoZ2RySXRlbVF1ZXJ5UGFyYW0pOiBPYnNlcnZhYmxlPGFueT5cbiAgcHVibGljIGdldENoYW5nZURhdGEoaWRPclBhcmFtOiBDaGdkckl0ZW1RdWVyeVBhcmFtIHwgc3RyaW5nLCBjaGFuZ2VUaW1lPzogRGF0ZSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKGlkT3JQYXJhbSA9PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJpZCBjYW4gbm90IGJlIG51bGxcIik7XG4gICAgfVxuICAgIGlmIChpZE9yUGFyYW0gaW5zdGFuY2VvZiBTdHJpbmcgfHwgdHlwZW9mIGlkT3JQYXJhbSA9PSBcInN0cmluZ1wiKSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRDaGFuZ2VEYXRhQnlJZCg8c3RyaW5nPmlkT3JQYXJhbSwgY2hhbmdlVGltZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLmdldENoYW5nZURhdGFCeVBhcmFtKGlkT3JQYXJhbSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRDaGFuZ2VEYXRhQnlJZChpZDogc3RyaW5nLCBjaGFuZ2VUaW1lOiBEYXRlKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBsZXQganNvbiA9IEpTT04uc3RyaW5naWZ5KGNoYW5nZVRpbWUpO1xuICAgIGxldCBxdWVyeVBhcmFtID0gZW5jb2RlVVJJQ29tcG9uZW50KGpzb24pO1xuICAgIGxldCB1cmwgPSBgJHtjaGdkclVybH0vJHtpZH0/Y2hhbmdlVGltZT0ke3F1ZXJ5UGFyYW19YDtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldCh1cmwpLnBpcGUobWFwKGRhdGEgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMudHJhbnNDaGFuZ2VEYXRhRnJvbVJlc3BvbnNlKGRhdGEpO1xuICAgIH0pKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q2hhbmdlRGF0YUJ5UGFyYW0ocGFyYW06IENoZ2RySXRlbVF1ZXJ5UGFyYW0pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmIChwYXJhbSA9PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDaGdkckl0ZW1RdWVyeVBhcmFtIGNhbiBub3QgYmUgbnVsbFwiKTtcbiAgICB9XG5cbiAgICBsZXQgcmVxdWVzdFBhcmFtOiBhbnkgPSB7fTtcbiAgICBPYmplY3QuYXNzaWduKHJlcXVlc3RQYXJhbSwgcGFyYW0pO1xuICAgIC8v5bCGTWFw6L2s5Li6T2JqZWN077yM5ZCm5YiZ5peg5rOV5q2j5bi45bqP5YiX5YyWXG4gICAgcmVxdWVzdFBhcmFtLmRhdGFJZHMgPSBNYXBVdGlsLmNvbnZlcnRNYXBUb09iamVjdChwYXJhbS5kYXRhSWRzKTtcblxuICAgIGxldCB1cmwgPSBgJHtjaGdkclVybH1gO1xuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdCh1cmwsIHJlcXVlc3RQYXJhbSkucGlwZShtYXAoZGF0YSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy50cmFuc0NoYW5nZURhdGFGcm9tUmVzcG9uc2UoZGF0YSk7XG4gICAgfSkpO1xuICB9XG5cbiAgcHJpdmF0ZSB0cmFuc0NoYW5nZURhdGFGcm9tUmVzcG9uc2UoZGF0YSk6IENoYW5nZURhdGFDb21wSGVhZGVyIHtcbiAgICBpZiAoIWRhdGEpIHtcbiAgICAgIHJldHVybiBkYXRhO1xuICAgIH1cbiAgICBsZXQgc2g6IENoYW5nZURhdGFDb21wSGVhZGVyID0gPENoYW5nZURhdGFDb21wSGVhZGVyPjx1bmtub3duPmRhdGE7XG4gICAgLy9UT0RPIOW+heWIoO+8jOWFvOWuueiAgeaVsOaNruagvOW8j1xuICAgIGlmICh0eXBlb2Ygc2guZGF0YUNvZGUgPT0gXCJzdHJpbmdcIikge1xuICAgICAgc2guZGF0YUNvZGUgPSBKU09OLnBhcnNlKHNoLmRhdGFDb2RlKTtcbiAgICB9XG4gICAgc2guZGF0YUNvZGUgPSBNYXBVdGlsLmNvbnZlcnRPYmplY3RUb01hcChzaC5kYXRhQ29kZSk7XG4gICAgc2guY2hhbmdlVGltZSA9IHRoaXMudG9EYXRlKHNoLmNoYW5nZVRpbWUpO1xuICAgIHNoLm9wZXJhdGVUeXBlID0gT3BlcmF0ZVR5cGUucGFyc2Uoc2gub3BlcmF0ZVR5cGUpO1xuICAgIHNoLnJvd3MgPSB0aGlzLnRyYW5zQ2hhbmdlRGF0YVJvd3NGcm9tUmVzcG9uc2Uoc2gucm93cyB8fCBbXSk7XG4gICAgcmV0dXJuIHNoO1xuICB9XG5cbiAgcHJpdmF0ZSB0cmFuc0NoYW5nZURhdGFSb3dzRnJvbVJlc3BvbnNlKHJvd3M6IENoYW5nZURhdGFSb3dbXSk6IENoYW5nZURhdGFSb3dbXSB7XG4gICAgaWYgKCFyb3dzIHx8IHJvd3MubGVuZ3RoID09IDApIHtcbiAgICAgIHJldHVybiByb3dzO1xuICAgIH1cblxuICAgIHJvd3MuZm9yRWFjaChyb3cgPT4ge1xuICAgICAgaWYgKCFyb3cpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgcm93Lm9wZXJhdGVUeXBlID0gT3BlcmF0ZVR5cGUucGFyc2Uocm93Lm9wZXJhdGVUeXBlKTtcbiAgICAgIC8vVE9ETyDlvoXliKDvvIzlhbzlrrnogIHmlbDmja7moLzlvI9cbiAgICAgIGlmICh0eXBlb2Ygcm93LmRhdGFDb2RlID09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgcm93LmRhdGFDb2RlID0gSlNPTi5wYXJzZShyb3cuZGF0YUNvZGUpO1xuICAgICAgfVxuICAgICAgcm93LmRhdGFDb2RlID0gTWFwVXRpbC5jb252ZXJ0T2JqZWN0VG9NYXAocm93LmRhdGFDb2RlKTtcbiAgICAgIHJvdy5vbGRDb250ZW50ID0gPE1hcDxzdHJpbmcsIHN0cmluZz4+TWFwVXRpbC5jb252ZXJ0T2JqZWN0VG9NYXAocm93Lm9sZENvbnRlbnQpIHx8IG5ldyBNYXAoKTtcbiAgICAgIHJvdy5uZXdDb250ZW50ID0gPE1hcDxzdHJpbmcsIHN0cmluZz4+TWFwVXRpbC5jb252ZXJ0T2JqZWN0VG9NYXAocm93Lm5ld0NvbnRlbnQpIHx8IG5ldyBNYXAoKTtcbiAgICB9KTtcblxuICAgIHJldHVybiByb3dzO1xuICB9XG59XG4iXX0=