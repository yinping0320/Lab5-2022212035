/**
 * @fileoverview added by tsickle
 * Generated from: lib/chgdr-data-viewer/chgdr-data-builder.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChgdrData, ChgdrDataRowNode, ChangeColumnItem, ChgdrDataEntityNode, DataCodeField } from './chgdr-data';
import { I18nUtil } from '../service/i18n-service';
var ChgdrDataBuilder = /** @class */ (function () {
    function ChgdrDataBuilder() {
    }
    /**
     * @param {?} data
     * @param {?} handler
     * @return {?}
     */
    ChgdrDataBuilder.prototype.buildChgdrData = /**
     * @param {?} data
     * @param {?} handler
     * @return {?}
     */
    function (data, handler) {
        var _this = this;
        this.handler = handler;
        //初始化变更日志基本信息
        /** @type {?} */
        var chgdrData = new ChgdrData();
        chgdrData.entityName = this.handler.getBeName();
        chgdrData.operateType = data.operateType;
        chgdrData.userName = data.userName;
        chgdrData.dataId = data.dataId;
        chgdrData.dataCode = data.dataCode;
        chgdrData.dataCodes = this.buildDataCodes(data.dataCode, this.handler.getMainObjectCode());
        chgdrData.reason = data.reason;
        chgdrData.changeTime = data.changeTime;
        chgdrData.entityNodes = [];
        //分层组织变更日志行
        /** @type {?} */
        var rowNodes = [];
        !!data.rows && data.rows.forEach((/**
         * @param {?} row
         * @return {?}
         */
        function (row) {
            if (!row) {
                return;
            }
            /** @type {?} */
            var rowNode = new ChgdrDataRowNode();
            rowNode.id = row.id;
            rowNode.parentDataId = row.parentDataId;
            rowNode.dataId = row.dataId;
            rowNode.dataCode = row.dataCode;
            rowNode.dataCodes = _this.buildDataCodes(row.dataCode, row.entityCode);
            rowNode.entityCode = row.entityCode;
            rowNode.entityName = _this.handler.getEntityNameOrDefault(row.entityCode);
            rowNode.operateType = row.operateType;
            rowNode.entityNodes = [];
            //组织列的变更信息
            /** @type {?} */
            var changeColumnKeys = _this.extractChangeColumnKeys(row);
            /** @type {?} */
            var columnValueChanges = [];
            changeColumnKeys.forEach((/**
             * @param {?} key
             * @return {?}
             */
            function (key) {
                /** @type {?} */
                var column = new ChangeColumnItem();
                column.fieldLabel = key;
                column.fieldName = _this.handler.getEntityFieldNameOrDefault(row.entityCode, key);
                column.oldValue = _this.handler.formatFieldValue(row.oldContent.get(key), row.entityCode, key);
                column.newValue = _this.handler.formatFieldValue(row.newContent.get(key), row.entityCode, key);
                /** @type {?} */
                var ele = _this.handler.getElement(row.entityCode, key);
                if (ele) {
                    //判断是否是关联字段
                    column.hasAssociation = ele.ObjectType == "Association" && ele.IsUdt == false;
                    column.isAssociationRefField = ele.IsRefElement;
                    /** @type {?} */
                    var parentElement = _this.handler.getParentElement(row.entityCode, key);
                    if (parentElement) {
                        column.belongFieldLabelId = parentElement.LabelID;
                    }
                }
                columnValueChanges.push(column);
            }));
            //变更值排序
            _this.handler.sort(columnValueChanges, row.entityCode, (/**
             * @param {?} column
             * @return {?}
             */
            function (column) { return column.fieldLabel; }));
            //合并关联带出字段
            /** @type {?} */
            var columnMap = new Map();
            columnValueChanges.forEach((/**
             * @param {?} column
             * @return {?}
             */
            function (column) {
                columnMap.set(column.fieldLabel, column);
            }));
            //1. 移除所有关联带出字段，并附加到其所属关联字段的children属性上
            columnValueChanges = columnValueChanges.filter((/**
             * @param {?} column
             * @return {?}
             */
            function (column) {
                if (column.isAssociationRefField) {
                    /** @type {?} */
                    var parentColumn = columnMap.get(column.belongFieldLabelId);
                    if (parentColumn) {
                        //找到父级字段则添加为父
                        parentColumn.children.push(column);
                        return false;
                    }
                    else {
                        return true;
                    }
                }
                else {
                    return true;
                }
            }));
            //2. 转换关联字段，将其子级的变更值拼接作为其变更值
            columnValueChanges = columnValueChanges.map((/**
             * @param {?} column
             * @return {?}
             */
            function (column) {
                if (column.hasAssociation && column.children.length > 0) {
                    //如果是关联字段，且存在关联带出字段
                    /** @type {?} */
                    var virtualColumn = Object.assign(new ChangeColumnItem(), column);
                    virtualColumn.originalColumnItem = column;
                    virtualColumn.oldValue = column.children.map((/**
                     * @param {?} child
                     * @return {?}
                     */
                    function (child) { return child.oldValue; })).join(";");
                    virtualColumn.newValue = column.children.map((/**
                     * @param {?} child
                     * @return {?}
                     */
                    function (child) { return child.newValue; })).join(";");
                    return virtualColumn;
                }
                else {
                    return column;
                }
            }));
            rowNode.changes = columnValueChanges;
            rowNodes.push(rowNode);
        }));
        /**
         * dataId与变更行的Map
         * @type {?}
         */
        var dataIdRowMap = new Map();
        rowNodes.forEach((/**
         * @param {?} node
         * @return {?}
         */
        function (node) { return dataIdRowMap.set(node.dataId, node); }));
        rowNodes.forEach((/**
         * @param {?} node
         * @return {?}
         */
        function (node) {
            if (!node.parentDataId) {
                //根节点
                /** @type {?} */
                var entityNode = _this.genChgdrDataEntityNode(node.entityCode, node.entityName);
                entityNode.rows.push(node);
                chgdrData.entityNodes.push(entityNode);
                return;
            }
            /** @type {?} */
            var parentRowNode = dataIdRowMap.get(node.parentDataId);
            if (!!parentRowNode) {
                //上级节点存在的节点
                /** @type {?} */
                var entityNode = parentRowNode.entityNodes.find((/**
                 * @param {?} en
                 * @return {?}
                 */
                function (en) { return en.entityCode == node.entityCode; }));
                if (!entityNode) {
                    entityNode = _this.genChgdrDataEntityNode(node.entityCode, node.entityName);
                    parentRowNode.entityNodes.push(entityNode);
                }
                entityNode.rows.push(node);
            }
            else {
                //上级节点不存在的节点
                //TODO 上级节点不存在的节点是否需要构造完整的上级结构？
                /** @type {?} */
                var entityNode = _this.genChgdrDataEntityNode(node.entityCode, node.entityName);
                entityNode.rows.push(node);
                chgdrData.entityNodes.push(entityNode);
            }
        }));
        return chgdrData;
    };
    /**
     * @private
     * @param {?} dataCode
     * @param {?} entityCode
     * @return {?}
     */
    ChgdrDataBuilder.prototype.buildDataCodes = /**
     * @private
     * @param {?} dataCode
     * @param {?} entityCode
     * @return {?}
     */
    function (dataCode, entityCode) {
        var _this = this;
        /** @type {?} */
        var dataCodes = [];
        dataCode && dataCode.forEach((/**
         * @param {?} value
         * @param {?} key
         * @return {?}
         */
        function (value, key) {
            /** @type {?} */
            var dataCodeField = new DataCodeField();
            if (key == "_$dataCode") {
                dataCodeField.fieldLabelId = "dataCode";
                dataCodeField.fieldName = I18nUtil.instantOrDefault("business-code-text", "业务编号");
                dataCodeField.fieldValue = value;
            }
            else {
                dataCodeField.fieldLabelId = key;
                dataCodeField.fieldName = _this.handler.getEntityFieldNameOrDefault(entityCode, key);
                dataCodeField.fieldValue = _this.handler.formatFieldValue(value, entityCode, key);
            }
            dataCodes.push(dataCodeField);
        }));
        //业务编号排序
        this.handler.sort(dataCodes, entityCode, (/**
         * @param {?} dataCode
         * @return {?}
         */
        function (dataCode) { return dataCode.fieldLabelId; }));
        return dataCodes;
    };
    /** 得到新旧内容中所有的key */
    /**
     * 得到新旧内容中所有的key
     * @private
     * @param {?} row
     * @return {?}
     */
    ChgdrDataBuilder.prototype.extractChangeColumnKeys = /**
     * 得到新旧内容中所有的key
     * @private
     * @param {?} row
     * @return {?}
     */
    function (row) {
        /** @type {?} */
        var keysSet = new Set();
        row.oldContent && row.oldContent.forEach((/**
         * @param {?} value
         * @param {?} key
         * @return {?}
         */
        function (value, key) { return keysSet.add(key); }));
        row.newContent && row.newContent.forEach((/**
         * @param {?} value
         * @param {?} key
         * @return {?}
         */
        function (value, key) { return keysSet.add(key); }));
        /** @type {?} */
        var keys = Array.from(keysSet.keys());
        return keys;
    };
    /**
     * @private
     * @param {?} entityCode
     * @param {?} entityName
     * @return {?}
     */
    ChgdrDataBuilder.prototype.genChgdrDataEntityNode = /**
     * @private
     * @param {?} entityCode
     * @param {?} entityName
     * @return {?}
     */
    function (entityCode, entityName) {
        /** @type {?} */
        var node = new ChgdrDataEntityNode();
        node.entityCode = entityCode;
        node.entityName = entityName;
        node.rows = [];
        return node;
    };
    return ChgdrDataBuilder;
}());
export { ChgdrDataBuilder };
if (false) {
    /**
     * @type {?}
     * @private
     */
    ChgdrDataBuilder.prototype.handler;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hnZHItZGF0YS1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGdzcC1jbXAvY2hnZHIvIiwic291cmNlcyI6WyJsaWIvY2hnZHItZGF0YS12aWV3ZXIvY2hnZHItZGF0YS1idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBTUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxnQkFBZ0IsRUFBRSxnQkFBZ0IsRUFBRSxtQkFBbUIsRUFBRSxhQUFhLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFakgsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRW5EO0lBQUE7SUE0S0EsQ0FBQzs7Ozs7O0lBektHLHlDQUFjOzs7OztJQUFkLFVBQWUsSUFBc0IsRUFBRSxPQUEyQjtRQUFsRSxpQkErSEM7UUE5SEcsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7OztZQUVuQixTQUFTLEdBQUcsSUFBSSxTQUFTLEVBQUU7UUFDL0IsU0FBUyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2hELFNBQVMsQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUN6QyxTQUFTLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDbkMsU0FBUyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQy9CLFNBQVMsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUNuQyxTQUFTLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFLENBQUMsQ0FBQztRQUMzRixTQUFTLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDL0IsU0FBUyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBQ3ZDLFNB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LENBQUM7O1lBQ3JFLElBQUksR0FBYSxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNqRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDOzs7Ozs7O0lBR08saURBQXNCOzs7Ozs7SUFBOUIsVUFBK0IsVUFBa0IsRUFBRSxVQUFrQjs7WUFDN0QsSUFBSSxHQUFHLElBQUksbUJBQW1CLEVBQUU7UUFDcEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDN0IsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDN0IsSUFBSSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUM7UUFDZixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUwsdUJBQUM7QUFBRCxDQUFDLEFBNUtELElBNEtDOzs7Ozs7O0lBM0tHLG1DQUFvQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzVG9kYXksIGZvcm1hdCB9IGZyb20gJ2RhdGUtZm5zJztcclxuaW1wb3J0IHsgR1NQQnVzaW5lc3NFbnRpdHkgfSBmcm9tICdAZ3NwLWJlZi9nc3AtYmUtbWV0YWRhdGEnO1xyXG5pbXBvcnQgeyBJR1NQQ29tbW9uT2JqZWN0LCBJR1NQQ29tbW9uRWxlbWVudCwgR1NQQXNzb2NpYXRpb24sIEdTUENvbW1vbkVsZW1lbnQsIEdTUEVsZW1lbnREYXRhVHlwZSwgR1NQRWxlbWVudE9iamVjdFR5cGUsIEdTUEVudW1WYWx1ZSB9IGZyb20gJ0Bnc3AtYmVmL2dzcC1jbS1tZXRhZGF0YSc7XHJcbmltcG9ydCB7IENoYW5nZURhdGFIZWFkZXIgfSBmcm9tICcuLi9tb2RlbC9jaGFuZ2UtZGF0YS1oZWFkZXInO1xyXG5pbXBvcnQgeyBDaGFuZ2VEYXRhUm93IH0gZnJvbSAnLi4vbW9kZWwvY2hhbmdlLWRhdGEtcm93JztcclxuaW1wb3J0IHsgTWFwVXRpbCB9IGZyb20gJy4uL3V0aWwvbWFwLnV0aWwnO1xyXG5pbXBvcnQgeyBDaGdkckRhdGEsIENoZ2RyRGF0YVJvd05vZGUsIENoYW5nZUNvbHVtbkl0ZW0sIENoZ2RyRGF0YUVudGl0eU5vZGUsIERhdGFDb2RlRmllbGQgfSBmcm9tICcuL2NoZ2RyLWRhdGEnO1xyXG5pbXBvcnQgeyBDaGdkckNvbmZpZ0hhbmRsZXIgfSBmcm9tICcuLi9zZXJ2aWNlL2NoZ2RyLWNvbmZpZy1oYW5kbGVyJztcclxuaW1wb3J0IHsgSTE4blV0aWwgfSBmcm9tICcuLi9zZXJ2aWNlL2kxOG4tc2VydmljZSc7XHJcblxyXG5leHBvcnQgY2xhc3MgQ2hnZHJEYXRhQnVpbGRlciB7XHJcbiAgICBwcml2YXRlIGhhbmRsZXI6IENoZ2RyQ29uZmlnSGFuZGxlcjtcclxuXHJcbiAgICBidWlsZENoZ2RyRGF0YShkYXRhOiBDaGFuZ2VEYXRhSGVhZGVyLCBoYW5kbGVyOiBDaGdkckNvbmZpZ0hhbmRsZXIpOiBDaGdkckRhdGEge1xyXG4gICAgICAgIHRoaXMuaGFuZGxlciA9IGhhbmRsZXI7XHJcbiAgICAgICAgLy/liJ3lp4vljJblj5jmm7Tml6Xlv5fln7rmnKzkv6Hmga9cclxuICAgICAgICBsZXQgY2hnZHJEYXRhID0gbmV3IENoZ2RyRGF0YSgpO1xyXG4gICAgICAgIGNoZ2RyRGF0YS5lbnRpdHlOYW1lID0gdGhpcy5oYW5kbGVyLmdldEJlTmFtZSgpO1xyXG4gICAgICAgIGNoZ2RyRGF0YS5vcGVyYXRlVHlwZSA9IGRhdGEub3BlcmF0ZVR5cGU7XHJcbiAgICAgICAgY2hnZHJEYXRhLnVzZXJOYW1lID0gZGF0YS51c2VyTmFtZTtcclxuICAgICAgICBjaGdkckRhdGEuZGF0YUlkID0gZGF0YS5kYXRhSWQ7XHJcbiAgICAgICAgY2hnZHJEYXRhLmRhdGFDb2RlID0gZGF0YS5kYXRhQ29kZTtcclxuICAgICAgICBjaGdkckRhdGEuZGF0YUNvZGVzID0gdGhpcy5idWlsZERhdGFDb2RlcyhkYXRhLmRhdGFDb2RlLCB0aGlzLmhhbmRsZXIuZ2V0TWFpbk9iamVjdENvZGUoKSk7XHJcbiAgICAgICAgY2hnZHJEYXRhLnJlYXNvbiA9IGRhdGEucmVhc29uO1xyXG4gICAgICAgIGNoZ2RyRGF0YS5jaGFuZ2VUaW1lID0gZGF0YS5jaGFuZ2VUaW1lO1xyXG4gICAgICAgIGNoZ2RyRGF0YS5lbnRpdHlOb2RlcyA9IFtdO1xyXG5cclxuICAgICAgICAvL+WIhuWxgue7hOe7h+WPmOabtOaXpeW/l+ihjFxyXG4gICAgICAgIGxldCByb3dOb2RlczogQ2hnZHJEYXRhUm93Tm9kZVtdID0gW107XHJcbiAgICAgICAgISFkYXRhLnJvd3MgJiYgZGF0YS5yb3dzLmZvckVhY2gocm93ID0+IHtcclxuICAgICAgICAgICAgaWYgKCFyb3cpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgcm93Tm9kZSA9IG5ldyBDaGdkckRhdGFSb3dOb2RlKCk7XHJcbiAgICAgICAgICAgIHJvd05vZGUuaWQgPSByb3cuaWQ7XHJcbiAgICAgICAgICAgIHJvd05vZGUucGFyZW50RGF0YUlkID0gcm93LnBhcmVudERhdGFJZDtcclxuICAgICAgICAgICAgcm93Tm9kZS5kYXRhSWQgPSByb3cuZGF0YUlkO1xyXG4gICAgICAgICAgICByb3dOb2RlLmRhdGFDb2RlID0gcm93LmRhdGFDb2RlO1xyXG4gICAgICAgICAgICByb3dOb2RlLmRhdGFDb2RlcyA9IHRoaXMuYnVpbGREYXRhQ29kZXMocm93LmRhdGFDb2RlLCByb3cuZW50aXR5Q29kZSk7XHJcbiAgICAgICAgICAgIHJvd05vZGUuZW50aXR5Q29kZSA9IHJvdy5lbnRpdHlDb2RlO1xyXG4gICAgICAgICAgICByb3dOb2RlLmVudGl0eU5hbWUgPSB0aGlzLmhhbmRsZXIuZ2V0RW50aXR5TmFtZU9yRGVmYXVsdChyb3cuZW50aXR5Q29kZSk7XHJcbiAgICAgICAgICAgIHJvd05vZGUub3BlcmF0ZVR5cGUgPSByb3cub3BlcmF0ZVR5cGU7XHJcbiAgICAgICAgICAgIHJvd05vZGUuZW50aXR5Tm9kZXMgPSBbXTtcclxuXHJcbiAgICAgICAgICAgIC8v57uE57uH5YiX55qE5Y+Y5pu05L+h5oGvXHJcbiAgICAgICAgICAgIGxldCBjaGFuZ2VDb2x1bW5LZXlzOiBzdHJpbmdbXSA9IHRoaXMuZXh0cmFjdENoYW5nZUNvbHVtbktleXMocm93KTtcclxuICAgICAgICAgICAgbGV0IGNvbHVtblZhbHVlQ2hhbmdlczogQ2hhbmdlQ29sdW1uSXRlbVtdID0gW107XHJcbiAgICAgICAgICAgIGNoYW5nZUNvbHVtbktleXMuZm9yRWFjaCgoa2V5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBsZXQgY29sdW1uID0gbmV3IENoYW5nZUNvbHVtbkl0ZW0oKTtcclxuICAgICAgICAgICAgICAgIGNvbHVtbi5maWVsZExhYmVsID0ga2V5O1xyXG4gICAgICAgICAgICAgICAgY29sdW1uLmZpZWxkTmFtZSA9IHRoaXMuaGFuZGxlci5nZXRFbnRpdHlGaWVsZE5hbWVPckRlZmF1bHQocm93LmVudGl0eUNvZGUsIGtleSk7XHJcbiAgICAgICAgICAgICAgICBjb2x1bW4ub2xkVmFsdWUgPSB0aGlzLmhhbmRsZXIuZm9ybWF0RmllbGRWYWx1ZShyb3cub2xkQ29udGVudC5nZXQoa2V5KSwgcm93LmVudGl0eUNvZGUsIGtleSk7XHJcbiAgICAgICAgICAgICAgICBjb2x1bW4ubmV3VmFsdWUgPSB0aGlzLmhhbmRsZXIuZm9ybWF0RmllbGRWYWx1ZShyb3cubmV3Q29udGVudC5nZXQoa2V5KSwgcm93LmVudGl0eUNvZGUsIGtleSk7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IGVsZTogSUdTUENvbW1vbkVsZW1lbnQgPSB0aGlzLmhhbmRsZXIuZ2V0RWxlbWVudChyb3cuZW50aXR5Q29kZSwga2V5KTtcclxuICAgICAgICAgICAgICAgIGlmIChlbGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAvL+WIpOaWreaYr+WQpuaYr+WFs+iBlOWtl+autVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbHVtbi5oYXNBc3NvY2lhdGlvbiA9IGVsZS5PYmplY3RUeXBlID09IFwiQXNzb2NpYXRpb25cIiAmJiBlbGUuSXNVZHQgPT0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgY29sdW1uLmlzQXNzb2NpYXRpb25SZWZGaWVsZCA9IGVsZS5Jc1JlZkVsZW1lbnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHBhcmVudEVsZW1lbnQgPSB0aGlzLmhhbmRsZXIuZ2V0UGFyZW50RWxlbWVudChyb3cuZW50aXR5Q29kZSwga2V5KTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50RWxlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW4uYmVsb25nRmllbGRMYWJlbElkID0gcGFyZW50RWxlbWVudC5MYWJlbElEO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBjb2x1bW5WYWx1ZUNoYW5nZXMucHVzaChjb2x1bW4pO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAvL+WPmOabtOWAvOaOkuW6j1xyXG4gICAgICAgICAgICB0aGlzLmhhbmRsZXIuc29ydChjb2x1bW5WYWx1ZUNoYW5nZXMsIHJvdy5lbnRpdHlDb2RlLCAoY29sdW1uKSA9PiBjb2x1bW4uZmllbGRMYWJlbCk7XHJcblxyXG4gICAgICAgICAgICAvL+WQiOW5tuWFs+iBlOW4puWHuuWtl+autVxyXG4gICAgICAgICAgICBsZXQgY29sdW1uTWFwOiBNYXA8c3RyaW5nLCBDaGFuZ2VDb2x1bW5JdGVtPiA9IG5ldyBNYXAoKTtcclxuICAgICAgICAgICAgY29sdW1uVmFsdWVDaGFuZ2VzLmZvckVhY2goKGNvbHVtbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29sdW1uTWFwLnNldChjb2x1bW4uZmllbGRMYWJlbCwgY29sdW1uKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIC8vMS4g56e76Zmk5omA5pyJ5YWz6IGU5bim5Ye65a2X5q6177yM5bm26ZmE5Yqg5Yiw5YW25omA5bGe5YWz6IGU5a2X5q6155qEY2hpbGRyZW7lsZ7mgKfkuIpcclxuICAgICAgICAgICAgY29sdW1uVmFsdWVDaGFuZ2VzID0gY29sdW1uVmFsdWVDaGFuZ2VzLmZpbHRlcigoY29sdW1uKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29sdW1uLmlzQXNzb2NpYXRpb25SZWZGaWVsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBwYXJlbnRDb2x1bW46IENoYW5nZUNvbHVtbkl0ZW0gPSBjb2x1bW5NYXAuZ2V0KGNvbHVtbi5iZWxvbmdGaWVsZExhYmVsSWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRDb2x1bW4pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy/mib7liLDniLbnuqflrZfmrrXliJnmt7vliqDkuLrniLZcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Q29sdW1uLmNoaWxkcmVuLnB1c2goY29sdW1uKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvLzIuIOi9rOaNouWFs+iBlOWtl+aute+8jOWwhuWFtuWtkOe6p+eahOWPmOabtOWAvOaLvOaOpeS9nOS4uuWFtuWPmOabtOWAvFxyXG4gICAgICAgICAgICBjb2x1bW5WYWx1ZUNoYW5nZXMgPSBjb2x1bW5WYWx1ZUNoYW5nZXMubWFwPENoYW5nZUNvbHVtbkl0ZW0+KGNvbHVtbiA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29sdW1uLmhhc0Fzc29jaWF0aW9uICYmIGNvbHVtbi5jaGlsZHJlbi5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy/lpoLmnpzmmK/lhbPogZTlrZfmrrXvvIzkuJTlrZjlnKjlhbPogZTluKblh7rlrZfmrrVcclxuICAgICAgICAgICAgICAgICAgICBsZXQgdmlydHVhbENvbHVtbjogQ2hhbmdlQ29sdW1uSXRlbSA9IE9iamVjdC5hc3NpZ24obmV3IENoYW5nZUNvbHVtbkl0ZW0oKSwgY29sdW1uKTtcclxuICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsQ29sdW1uLm9yaWdpbmFsQ29sdW1uSXRlbSA9IGNvbHVtbjtcclxuICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsQ29sdW1uLm9sZFZhbHVlID0gY29sdW1uLmNoaWxkcmVuLm1hcChjaGlsZCA9PiBjaGlsZC5vbGRWYWx1ZSkuam9pbihcIjtcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgdmlydHVhbENvbHVtbi5uZXdWYWx1ZSA9IGNvbHVtbi5jaGlsZHJlbi5tYXAoY2hpbGQgPT4gY2hpbGQubmV3VmFsdWUpLmpvaW4oXCI7XCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB2aXJ0dWFsQ29sdW1uO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29sdW1uO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHJvd05vZGUuY2hhbmdlcyA9IGNvbHVtblZhbHVlQ2hhbmdlcztcclxuXHJcbiAgICAgICAgICAgIHJvd05vZGVzLnB1c2gocm93Tm9kZSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8qKiBkYXRhSWTkuI7lj5jmm7TooYznmoRNYXAgKi9cclxuICAgICAgICBsZXQgZGF0YUlkUm93TWFwOiBNYXA8c3RyaW5nLCBDaGdkckRhdGFSb3dOb2RlPiA9IG5ldyBNYXAoKTtcclxuICAgICAgICByb3dOb2Rlcy5mb3JFYWNoKG5vZGUgPT4gZGF0YUlkUm93TWFwLnNldChub2RlLmRhdGFJZCwgbm9kZSkpO1xyXG5cclxuICAgICAgICByb3dOb2Rlcy5mb3JFYWNoKG5vZGUgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIW5vZGUucGFyZW50RGF0YUlkKSB7XHJcbiAgICAgICAgICAgICAgICAvL+agueiKgueCuVxyXG4gICAgICAgICAgICAgICAgbGV0IGVudGl0eU5vZGUgPSB0aGlzLmdlbkNoZ2RyRGF0YUVudGl0eU5vZGUobm9kZS5lbnRpdHlDb2RlLCBub2RlLmVudGl0eU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgZW50aXR5Tm9kZS5yb3dzLnB1c2gobm9kZSk7XHJcbiAgICAgICAgICAgICAgICBjaGdkckRhdGEuZW50aXR5Tm9kZXMucHVzaChlbnRpdHlOb2RlKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgcGFyZW50Um93Tm9kZSA9IGRhdGFJZFJvd01hcC5nZXQobm9kZS5wYXJlbnREYXRhSWQpO1xyXG4gICAgICAgICAgICBpZiAoISFwYXJlbnRSb3dOb2RlKSB7XHJcbiAgICAgICAgICAgICAgICAvL+S4iue6p+iKgueCueWtmOWcqOeahOiKgueCuVxyXG4gICAgICAgICAgICAgICAgbGV0IGVudGl0eU5vZGUgPSBwYXJlbnRSb3dOb2RlLmVudGl0eU5vZGVzLmZpbmQoZW4gPT4gZW4uZW50aXR5Q29kZSA9PSBub2RlLmVudGl0eUNvZGUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFlbnRpdHlOb2RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZW50aXR5Tm9kZSA9IHRoaXMuZ2VuQ2hnZHJEYXRhRW50aXR5Tm9kZShub2RlLmVudGl0eUNvZGUsIG5vZGUuZW50aXR5TmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcGFyZW50Um93Tm9kZS5lbnRpdHlOb2Rlcy5wdXNoKGVudGl0eU5vZGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZW50aXR5Tm9kZS5yb3dzLnB1c2gobm9kZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvL+S4iue6p+iKgueCueS4jeWtmOWcqOeahOiKgueCuVxyXG4gICAgICAgICAgICAgICAgLy9UT0RPIOS4iue6p+iKgueCueS4jeWtmOWcqOeahOiKgueCueaYr+WQpumcgOimgeaehOmAoOWujOaVtOeahOS4iue6p+e7k+aehO+8n1xyXG4gICAgICAgICAgICAgICAgbGV0IGVudGl0eU5vZGUgPSB0aGlzLmdlbkNoZ2RyRGF0YUVudGl0eU5vZGUobm9kZS5lbnRpdHlDb2RlLCBub2RlLmVudGl0eU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgZW50aXR5Tm9kZS5yb3dzLnB1c2gobm9kZSk7XHJcbiAgICAgICAgICAgICAgICBjaGdkckRhdGEuZW50aXR5Tm9kZXMucHVzaChlbnRpdHlOb2RlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIHJldHVybiBjaGdkckRhdGE7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBidWlsZERhdGFDb2RlcyhkYXRhQ29kZTogTWFwPHN0cmluZywgc3RyaW5nPiwgZW50aXR5Q29kZTogc3RyaW5nKTogRGF0YUNvZGVGaWVsZFtdIHtcclxuICAgICAgICBsZXQgZGF0YUNvZGVzOiBEYXRhQ29kZUZpZWxkW10gPSBbXTtcclxuICAgICAgICBkYXRhQ29kZSAmJiBkYXRhQ29kZS5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBkYXRhQ29kZUZpZWxkOiBEYXRhQ29kZUZpZWxkID0gbmV3IERhdGFDb2RlRmllbGQoKTtcclxuICAgICAgICAgICAgaWYgKGtleSA9PSBcIl8kZGF0YUNvZGVcIikge1xyXG4gICAgICAgICAgICAgICAgZGF0YUNvZGVGaWVsZC5maWVsZExhYmVsSWQgPSBcImRhdGFDb2RlXCI7XHJcbiAgICAgICAgICAgICAgICBkYXRhQ29kZUZpZWxkLmZpZWxkTmFtZSA9IEkxOG5VdGlsLmluc3RhbnRPckRlZmF1bHQoXCJidXNpbmVzcy1jb2RlLXRleHRcIiwgXCLkuJrliqHnvJblj7dcIik7XHJcbiAgICAgICAgICAgICAgICBkYXRhQ29kZUZpZWxkLmZpZWxkVmFsdWUgPSB2YWx1ZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGRhdGFDb2RlRmllbGQuZmllbGRMYWJlbElkID0ga2V5O1xyXG4gICAgICAgICAgICAgICAgZGF0YUNvZGVGaWVsZC5maWVsZE5hbWUgPSB0aGlzLmhhbmRsZXIuZ2V0RW50aXR5RmllbGROYW1lT3JEZWZhdWx0KGVudGl0eUNvZGUsIGtleSk7XHJcbiAgICAgICAgICAgICAgICBkYXRhQ29kZUZpZWxkLmZpZWxkVmFsdWUgPSB0aGlzLmhhbmRsZXIuZm9ybWF0RmllbGRWYWx1ZSh2YWx1ZSwgZW50aXR5Q29kZSwga2V5KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBkYXRhQ29kZXMucHVzaChkYXRhQ29kZUZpZWxkKTtcclxuICAgICAgICB9KVxyXG5cclxuICAgICAgICAvL+S4muWKoee8luWPt+aOkuW6j1xyXG4gICAgICAgIHRoaXMuaGFuZGxlci5zb3J0KGRhdGFDb2RlcywgZW50aXR5Q29kZSwgKGRhdGFDb2RlKSA9PiBkYXRhQ29kZS5maWVsZExhYmVsSWQpO1xyXG5cclxuICAgICAgICByZXR1cm4gZGF0YUNvZGVzO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKiDlvpfliLDmlrDml6flhoXlrrnkuK3miYDmnInnmoRrZXkgKi9cclxuICAgIHByaXZhdGUgZXh0cmFjdENoYW5nZUNvbHVtbktleXMocm93OiBDaGFuZ2VEYXRhUm93KTogc3RyaW5nW10ge1xyXG4gICAgICAgIGxldCBrZXlzU2V0OiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTtcclxuICAgICAgICByb3cub2xkQ29udGVudCAmJiByb3cub2xkQ29udGVudC5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiBrZXlzU2V0LmFkZChrZXkpKTtcclxuICAgICAgICByb3cubmV3Q29udGVudCAmJiByb3cubmV3Q29udGVudC5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiBrZXlzU2V0LmFkZChrZXkpKTtcclxuICAgICAgICBjb25zdCBrZXlzOiBzdHJpbmdbXSA9IEFycmF5LmZyb20oa2V5c1NldC5rZXlzKCkpO1xyXG4gICAgICAgIHJldHVybiBrZXlzO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIGdlbkNoZ2RyRGF0YUVudGl0eU5vZGUoZW50aXR5Q29kZTogc3RyaW5nLCBlbnRpdHlOYW1lOiBzdHJpbmcpOiBDaGdkckRhdGFFbnRpdHlOb2RlIHtcclxuICAgICAgICBsZXQgbm9kZSA9IG5ldyBDaGdkckRhdGFFbnRpdHlOb2RlKCk7XHJcbiAgICAgICAgbm9kZS5lbnRpdHlDb2RlID0gZW50aXR5Q29kZTtcclxuICAgICAgICBub2RlLmVudGl0eU5hbWUgPSBlbnRpdHlOYW1lO1xyXG4gICAgICAgIG5vZGUucm93cyA9IFtdO1xyXG4gICAgICAgIHJldHVybiBub2RlO1xyXG4gICAgfVxyXG5cclxufSJdfQ==