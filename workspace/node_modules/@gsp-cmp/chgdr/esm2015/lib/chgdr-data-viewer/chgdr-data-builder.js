/**
 * @fileoverview added by tsickle
 * Generated from: lib/chgdr-data-viewer/chgdr-data-builder.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChgdrData, ChgdrDataRowNode, ChangeColumnItem, ChgdrDataEntityNode, DataCodeField } from './chgdr-data';
import { I18nUtil } from '../service/i18n-service';
export class ChgdrDataBuilder {
    /**
     * @param {?} data
     * @param {?} handler
     * @return {?}
     */
    buildChgdrData(data, handler) {
        this.handler = handler;
        //初始化变更日志基本信息
        /** @type {?} */
        let chgdrData = new ChgdrData();
        chgdrData.entityName = this.handler.getBeName();
        chgdrData.operateType = data.operateType;
        chgdrData.userName = data.userName;
        chgdrData.dataId = data.dataId;
        chgdrData.dataCode = data.dataCode;
        chgdrData.dataCodes = this.buildDataCodes(data.dataCode, this.handler.getMainObjectCode());
        chgdrData.reason = data.reason;
        chgdrData.changeTime = data.changeTime;
        chgdrData.entityNodes = [];
        //分层组织变更日志行
        /** @type {?} */
        let rowNodes = [];
        !!data.rows && data.rows.forEach((/**
         * @param {?} row
         * @return {?}
         */
        row => {
            if (!row) {
                return;
            }
            /** @type {?} */
            let rowNode = new ChgdrDataRowNode();
            rowNode.id = row.id;
            rowNode.parentDataId = row.parentDataId;
            rowNode.dataId = row.dataId;
            rowNode.dataCode = row.dataCode;
            rowNode.dataCodes = this.buildDataCodes(row.dataCode, row.entityCode);
            rowNode.entityCode = row.entityCode;
            rowNode.entityName = this.handler.getEntityNameOrDefault(row.entityCode);
            rowNode.operateType = row.operateType;
            rowNode.entityNodes = [];
            //组织列的变更信息
            /** @type {?} */
            let changeColumnKeys = this.extractChangeColumnKeys(row);
            /** @type {?} */
            let columnValueChanges = [];
            changeColumnKeys.forEach((/**
             * @param {?} key
             * @return {?}
             */
            (key) => {
                /** @type {?} */
                let column = new ChangeColumnItem();
                column.fieldLabel = key;
                column.fieldName = this.handler.getEntityFieldNameOrDefault(row.entityCode, key);
                column.oldValue = this.handler.formatFieldValue(row.oldContent.get(key), row.entityCode, key);
                column.newValue = this.handler.formatFieldValue(row.newContent.get(key), row.entityCode, key);
                /** @type {?} */
                let ele = this.handler.getElement(row.entityCode, key);
                if (ele) {
                    //判断是否是关联字段
                    column.hasAssociation = ele.ObjectType == "Association" && ele.IsUdt == false;
                    column.isAssociationRefField = ele.IsRefElement;
                    /** @type {?} */
                    let parentElement = this.handler.getParentElement(row.entityCode, key);
                    if (parentElement) {
                        column.belongFieldLabelId = parentElement.LabelID;
                    }
                }
                columnValueChanges.push(column);
            }));
            //变更值排序
            this.handler.sort(columnValueChanges, row.entityCode, (/**
             * @param {?} column
             * @return {?}
             */
            (column) => column.fieldLabel));
            //合并关联带出字段
            /** @type {?} */
            let columnMap = new Map();
            columnValueChanges.forEach((/**
             * @param {?} column
             * @return {?}
             */
            (column) => {
                columnMap.set(column.fieldLabel, column);
            }));
            //1. 移除所有关联带出字段，并附加到其所属关联字段的children属性上
            columnValueChanges = columnValueChanges.filter((/**
             * @param {?} column
             * @return {?}
             */
            (column) => {
                if (column.isAssociationRefField) {
                    /** @type {?} */
                    let parentColumn = columnMap.get(column.belongFieldLabelId);
                    if (parentColumn) {
                        //找到父级字段则添加为父
                        parentColumn.children.push(column);
                        return false;
                    }
                    else {
                        return true;
                    }
                }
                else {
                    return true;
                }
            }));
            //2. 转换关联字段，将其子级的变更值拼接作为其变更值
            columnValueChanges = columnValueChanges.map((/**
             * @param {?} column
             * @return {?}
             */
            column => {
                if (column.hasAssociation && column.children.length > 0) {
                    //如果是关联字段，且存在关联带出字段
                    /** @type {?} */
                    let virtualColumn = Object.assign(new ChangeColumnItem(), column);
                    virtualColumn.originalColumnItem = column;
                    virtualColumn.oldValue = column.children.map((/**
                     * @param {?} child
                     * @return {?}
                     */
                    child => child.oldValue)).join(";");
                    virtualColumn.newValue = column.children.map((/**
                     * @param {?} child
                     * @return {?}
                     */
                    child => child.newValue)).join(";");
                    return virtualColumn;
                }
                else {
                    return column;
                }
            }));
            rowNode.changes = columnValueChanges;
            rowNodes.push(rowNode);
        }));
        /**
         * dataId与变更行的Map
         * @type {?}
         */
        let dataIdRowMap = new Map();
        rowNodes.forEach((/**
         * @param {?} node
         * @return {?}
         */
        node => dataIdRowMap.set(node.dataId, node)));
        rowNodes.forEach((/**
         * @param {?} node
         * @return {?}
         */
        node => {
            if (!node.parentDataId) {
                //根节点
                /** @type {?} */
                let entityNode = this.genChgdrDataEntityNode(node.entityCode, node.entityName);
                entityNode.rows.push(node);
                chgdrData.entityNodes.push(entityNode);
                return;
            }
            /** @type {?} */
            let parentRowNode = dataIdRowMap.get(node.parentDataId);
            if (!!parentRowNode) {
                //上级节点存在的节点
                /** @type {?} */
                let entityNode = parentRowNode.entityNodes.find((/**
                 * @param {?} en
                 * @return {?}
                 */
                en => en.entityCode == node.entityCode));
                if (!entityNode) {
                    entityNode = this.genChgdrDataEntityNode(node.entityCode, node.entityName);
                    parentRowNode.entityNodes.push(entityNode);
                }
                entityNode.rows.push(node);
            }
            else {
                //上级节点不存在的节点
                //TODO 上级节点不存在的节点是否需要构造完整的上级结构？
                /** @type {?} */
                let entityNode = this.genChgdrDataEntityNode(node.entityCode, node.entityName);
                entityNode.rows.push(node);
                chgdrData.entityNodes.push(entityNode);
            }
        }));
        return chgdrData;
    }
    /**
     * @private
     * @param {?} dataCode
     * @param {?} entityCode
     * @return {?}
     */
    buildDataCodes(dataCode, entityCode) {
        /** @type {?} */
        let dataCodes = [];
        dataCode && dataCode.forEach((/**
         * @param {?} value
         * @param {?} key
         * @return {?}
         */
        (value, key) => {
            /** @type {?} */
            let dataCodeField = new DataCodeField();
            if (key == "_$dataCode") {
                dataCodeField.fieldLabelId = "dataCode";
                dataCodeField.fieldName = I18nUtil.instantOrDefault("business-code-text", "业务编号");
                dataCodeField.fieldValue = value;
            }
            else {
                dataCodeField.fieldLabelId = key;
                dataCodeField.fieldName = this.handler.getEntityFieldNameOrDefault(entityCode, key);
                dataCodeField.fieldValue = this.handler.formatFieldValue(value, entityCode, key);
            }
            dataCodes.push(dataCodeField);
        }));
        //业务编号排序
        this.handler.sort(dataCodes, entityCode, (/**
         * @param {?} dataCode
         * @return {?}
         */
        (dataCode) => dataCode.fieldLabelId));
        return dataCodes;
    }
    /**
     * 得到新旧内容中所有的key
     * @private
     * @param {?} row
     * @return {?}
     */
    extractChangeColumnKeys(row) {
        /** @type {?} */
        let keysSet = new Set();
        row.oldContent && row.oldContent.forEach((/**
         * @param {?} value
         * @param {?} key
         * @return {?}
         */
        (value, key) => keysSet.add(key)));
        row.newContent && row.newContent.forEach((/**
         * @param {?} value
         * @param {?} key
         * @return {?}
         */
        (value, key) => keysSet.add(key)));
        /** @type {?} */
        const keys = Array.from(keysSet.keys());
        return keys;
    }
    /**
     * @private
     * @param {?} entityCode
     * @param {?} entityName
     * @return {?}
     */
    genChgdrDataEntityNode(entityCode, entityName) {
        /** @type {?} */
        let node = new ChgdrDataEntityNode();
        node.entityCode = entityCode;
        node.entityName = entityName;
        node.rows = [];
        return node;
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    ChgdrDataBuilder.prototype.handler;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hnZHItZGF0YS1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGdzcC1jbXAvY2hnZHIvIiwic291cmNlcyI6WyJsaWIvY2hnZHItZGF0YS12aWV3ZXIvY2hnZHItZGF0YS1idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBTUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxnQkFBZ0IsRUFBRSxnQkFBZ0IsRUFBRSxtQkFBbUIsRUFBRSxhQUFhLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFakgsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRW5ELE1BQU0sT0FBTyxnQkFBZ0I7Ozs7OztJQUd6QixjQUFjLENBQUMsSUFBc0IsRUFBRSxPQUEyQjtRQUM5RCxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQzs7O1lBRW5CLFNBQVMsR0FBRyxJQUFJLFNBQVMsRUFBRTtRQUMvQixTQUFTLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDaEQsU0FBUyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDO1FBQ3pDLFNBQVMsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUNuQyxTQUFTLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDL0IsU0FBUyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQ25DLFNBQVMsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxDQUFDO1FBQzNGLFNBQVMsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUMvQixTQUFTLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7UUFDdkMsU0FBUyxDQUFDLFdBQVcsR0FBRyxFQUFF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SUFDaEIsQ0FBQzs7Ozs7OztJQUdPLHNCQUFzQixDQUFDLFVBQWtCLEVBQUUsVUFBa0I7O1lBQzdELElBQUksR0FBRyxJQUFJLG1CQUFtQixFQUFFO1FBQ3BDLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2YsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztDQUVKOzs7Ozs7SUEzS0csbUNBQW9DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNUb2RheSwgZm9ybWF0IH0gZnJvbSAnZGF0ZS1mbnMnO1xyXG5pbXBvcnQgeyBHU1BCdXNpbmVzc0VudGl0eSB9IGZyb20gJ0Bnc3AtYmVmL2dzcC1iZS1tZXRhZGF0YSc7XHJcbmltcG9ydCB7IElHU1BDb21tb25PYmplY3QsIElHU1BDb21tb25FbGVtZW50LCBHU1BBc3NvY2lhdGlvbiwgR1NQQ29tbW9uRWxlbWVudCwgR1NQRWxlbWVudERhdGFUeXBlLCBHU1BFbGVtZW50T2JqZWN0VHlwZSwgR1NQRW51bVZhbHVlIH0gZnJvbSAnQGdzcC1iZWYvZ3NwLWNtLW1ldGFkYXRhJztcclxuaW1wb3J0IHsgQ2hhbmdlRGF0YUhlYWRlciB9IGZyb20gJy4uL21vZGVsL2NoYW5nZS1kYXRhLWhlYWRlcic7XHJcbmltcG9ydCB7IENoYW5nZURhdGFSb3cgfSBmcm9tICcuLi9tb2RlbC9jaGFuZ2UtZGF0YS1yb3cnO1xyXG5pbXBvcnQgeyBNYXBVdGlsIH0gZnJvbSAnLi4vdXRpbC9tYXAudXRpbCc7XHJcbmltcG9ydCB7IENoZ2RyRGF0YSwgQ2hnZHJEYXRhUm93Tm9kZSwgQ2hhbmdlQ29sdW1uSXRlbSwgQ2hnZHJEYXRhRW50aXR5Tm9kZSwgRGF0YUNvZGVGaWVsZCB9IGZyb20gJy4vY2hnZHItZGF0YSc7XHJcbmltcG9ydCB7IENoZ2RyQ29uZmlnSGFuZGxlciB9IGZyb20gJy4uL3NlcnZpY2UvY2hnZHItY29uZmlnLWhhbmRsZXInO1xyXG5pbXBvcnQgeyBJMThuVXRpbCB9IGZyb20gJy4uL3NlcnZpY2UvaTE4bi1zZXJ2aWNlJztcclxuXHJcbmV4cG9ydCBjbGFzcyBDaGdkckRhdGFCdWlsZGVyIHtcclxuICAgIHByaXZhdGUgaGFuZGxlcjogQ2hnZHJDb25maWdIYW5kbGVyO1xyXG5cclxuICAgIGJ1aWxkQ2hnZHJEYXRhKGRhdGE6IENoYW5nZURhdGFIZWFkZXIsIGhhbmRsZXI6IENoZ2RyQ29uZmlnSGFuZGxlcik6IENoZ2RyRGF0YSB7XHJcbiAgICAgICAgdGhpcy5oYW5kbGVyID0gaGFuZGxlcjtcclxuICAgICAgICAvL+WIneWni+WMluWPmOabtOaXpeW/l+WfuuacrOS/oeaBr1xyXG4gICAgICAgIGxldCBjaGdkckRhdGEgPSBuZXcgQ2hnZHJEYXRhKCk7XHJcbiAgICAgICAgY2hnZHJEYXRhLmVudGl0eU5hbWUgPSB0aGlzLmhhbmRsZXIuZ2V0QmVOYW1lKCk7XHJcbiAgICAgICAgY2hnZHJEYXRhLm9wZXJhdGVUeXBlID0gZGF0YS5vcGVyYXRlVHlwZTtcclxuICAgICAgICBjaGdkckRhdGEudXNlck5hbWUgPSBkYXRhLnVzZXJOYW1lO1xyXG4gICAgICAgIGNoZ2RyRGF0YS5kYXRhSWQgPSBkYXRhLmRhdGFJZDtcclxuICAgICAgICBjaGdkckRhdGEuZGF0YUNvZGUgPSBkYXRhLmRhdGFDb2RlO1xyXG4gICAgICAgIGNoZ2RyRGF0YS5kYXRhQ29kZXMgPSB0aGlzLmJ1aWxkRGF0YUNvZGVzKGRhdGEuZGF0YUNvZGUsIHRoaXMuaGFuZGxlci5nZXRNYWluT2JqZWN0Q29kZSgpKTtcclxuICAgICAgICBjaGdkckRhdGEucmVhc29uID0gZGF0YS5yZWFzb247XHJcbiAgICAgICAgY2hnZHJEYXRhLmNoYW5nZVRpbWUgPSBkYXRhLmNoYW5nZVRpbWU7XHJcbiAgICAgICAgY2hnZHJEYXRhLmVudGl0eU5vZGVzID0gW107XHJcblxyXG4gICAgICAgIC8v5YiG5bGC57uE57uH5Y+Y5pu05pel5b+X6KGMXHJcbiAgICAgICAgbGV0IHJvd05vZGVzOiBDaGdkckRhdGFSb3dOb2RlW10gPSBbXTtcclxuICAgICAgICAhIWRhdGEucm93cyAmJiBkYXRhLnJvd3MuZm9yRWFjaChyb3cgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIXJvdykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCByb3dOb2RlID0gbmV3IENoZ2RyRGF0YVJvd05vZGUoKTtcclxuICAgICAgICAgICAgcm93Tm9kZS5pZCA9IHJvdy5pZDtcclxuICAgICAgICAgICAgcm93Tm9kZS5wYXJlbnREYXRhSWQgPSByb3cucGFyZW50RGF0YUlkO1xyXG4gICAgICAgICAgICByb3dOb2RlLmRhdGFJZCA9IHJvdy5kYXRhSWQ7XHJcbiAgICAgICAgICAgIHJvd05vZGUuZGF0YUNvZGUgPSByb3cuZGF0YUNvZGU7XHJcbiAgICAgICAgICAgIHJvd05vZGUuZGF0YUNvZGVzID0gdGhpcy5idWlsZERhdGFDb2Rlcyhyb3cuZGF0YUNvZGUsIHJvdy5lbnRpdHlDb2RlKTtcclxuICAgICAgICAgICAgcm93Tm9kZS5lbnRpdHlDb2RlID0gcm93LmVudGl0eUNvZGU7XHJcbiAgICAgICAgICAgIHJvd05vZGUuZW50aXR5TmFtZSA9IHRoaXMuaGFuZGxlci5nZXRFbnRpdHlOYW1lT3JEZWZhdWx0KHJvdy5lbnRpdHlDb2RlKTtcclxuICAgICAgICAgICAgcm93Tm9kZS5vcGVyYXRlVHlwZSA9IHJvdy5vcGVyYXRlVHlwZTtcclxuICAgICAgICAgICAgcm93Tm9kZS5lbnRpdHlOb2RlcyA9IFtdO1xyXG5cclxuICAgICAgICAgICAgLy/nu4Tnu4fliJfnmoTlj5jmm7Tkv6Hmga9cclxuICAgICAgICAgICAgbGV0IGNoYW5nZUNvbHVtbktleXM6IHN0cmluZ1tdID0gdGhpcy5leHRyYWN0Q2hhbmdlQ29sdW1uS2V5cyhyb3cpO1xyXG4gICAgICAgICAgICBsZXQgY29sdW1uVmFsdWVDaGFuZ2VzOiBDaGFuZ2VDb2x1bW5JdGVtW10gPSBbXTtcclxuICAgICAgICAgICAgY2hhbmdlQ29sdW1uS2V5cy5mb3JFYWNoKChrZXkpID0+IHtcclxuICAgICAgICAgICAgICAgIGxldCBjb2x1bW4gPSBuZXcgQ2hhbmdlQ29sdW1uSXRlbSgpO1xyXG4gICAgICAgICAgICAgICAgY29sdW1uLmZpZWxkTGFiZWwgPSBrZXk7XHJcbiAgICAgICAgICAgICAgICBjb2x1bW4uZmllbGROYW1lID0gdGhpcy5oYW5kbGVyLmdldEVudGl0eUZpZWxkTmFtZU9yRGVmYXVsdChyb3cuZW50aXR5Q29kZSwga2V5KTtcclxuICAgICAgICAgICAgICAgIGNvbHVtbi5vbGRWYWx1ZSA9IHRoaXMuaGFuZGxlci5mb3JtYXRGaWVsZFZhbHVlKHJvdy5vbGRDb250ZW50LmdldChrZXkpLCByb3cuZW50aXR5Q29kZSwga2V5KTtcclxuICAgICAgICAgICAgICAgIGNvbHVtbi5uZXdWYWx1ZSA9IHRoaXMuaGFuZGxlci5mb3JtYXRGaWVsZFZhbHVlKHJvdy5uZXdDb250ZW50LmdldChrZXkpLCByb3cuZW50aXR5Q29kZSwga2V5KTtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgZWxlOiBJR1NQQ29tbW9uRWxlbWVudCA9IHRoaXMuaGFuZGxlci5nZXRFbGVtZW50KHJvdy5lbnRpdHlDb2RlLCBrZXkpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGVsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8v5Yik5pat5piv5ZCm5piv5YWz6IGU5a2X5q61XHJcbiAgICAgICAgICAgICAgICAgICAgY29sdW1uLmhhc0Fzc29jaWF0aW9uID0gZWxlLk9iamVjdFR5cGUgPT0gXCJBc3NvY2lhdGlvblwiICYmIGVsZS5Jc1VkdCA9PSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICBjb2x1bW4uaXNBc3NvY2lhdGlvblJlZkZpZWxkID0gZWxlLklzUmVmRWxlbWVudDtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgcGFyZW50RWxlbWVudCA9IHRoaXMuaGFuZGxlci5nZXRQYXJlbnRFbGVtZW50KHJvdy5lbnRpdHlDb2RlLCBrZXkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRFbGVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbi5iZWxvbmdGaWVsZExhYmVsSWQgPSBwYXJlbnRFbGVtZW50LkxhYmVsSUQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGNvbHVtblZhbHVlQ2hhbmdlcy5wdXNoKGNvbHVtbik7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC8v5Y+Y5pu05YC85o6S5bqPXHJcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlci5zb3J0KGNvbHVtblZhbHVlQ2hhbmdlcywgcm93LmVudGl0eUNvZGUsIChjb2x1bW4pID0+IGNvbHVtbi5maWVsZExhYmVsKTtcclxuXHJcbiAgICAgICAgICAgIC8v5ZCI5bm25YWz6IGU5bim5Ye65a2X5q61XHJcbiAgICAgICAgICAgIGxldCBjb2x1bW5NYXA6IE1hcDxzdHJpbmcsIENoYW5nZUNvbHVtbkl0ZW0+ID0gbmV3IE1hcCgpO1xyXG4gICAgICAgICAgICBjb2x1bW5WYWx1ZUNoYW5nZXMuZm9yRWFjaCgoY29sdW1uKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb2x1bW5NYXAuc2V0KGNvbHVtbi5maWVsZExhYmVsLCBjb2x1bW4pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgLy8xLiDnp7vpmaTmiYDmnInlhbPogZTluKblh7rlrZfmrrXvvIzlubbpmYTliqDliLDlhbbmiYDlsZ7lhbPogZTlrZfmrrXnmoRjaGlsZHJlbuWxnuaAp+S4ilxyXG4gICAgICAgICAgICBjb2x1bW5WYWx1ZUNoYW5nZXMgPSBjb2x1bW5WYWx1ZUNoYW5nZXMuZmlsdGVyKChjb2x1bW4pID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChjb2x1bW4uaXNBc3NvY2lhdGlvblJlZkZpZWxkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHBhcmVudENvbHVtbjogQ2hhbmdlQ29sdW1uSXRlbSA9IGNvbHVtbk1hcC5nZXQoY29sdW1uLmJlbG9uZ0ZpZWxkTGFiZWxJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudENvbHVtbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL+aJvuWIsOeItue6p+Wtl+auteWImea3u+WKoOS4uueItlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRDb2x1bW4uY2hpbGRyZW4ucHVzaChjb2x1bW4pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIC8vMi4g6L2s5o2i5YWz6IGU5a2X5q6177yM5bCG5YW25a2Q57qn55qE5Y+Y5pu05YC85ou85o6l5L2c5Li65YW25Y+Y5pu05YC8XHJcbiAgICAgICAgICAgIGNvbHVtblZhbHVlQ2hhbmdlcyA9IGNvbHVtblZhbHVlQ2hhbmdlcy5tYXA8Q2hhbmdlQ29sdW1uSXRlbT4oY29sdW1uID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChjb2x1bW4uaGFzQXNzb2NpYXRpb24gJiYgY29sdW1uLmNoaWxkcmVuLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAvL+WmguaenOaYr+WFs+iBlOWtl+aute+8jOS4lOWtmOWcqOWFs+iBlOW4puWHuuWtl+autVxyXG4gICAgICAgICAgICAgICAgICAgIGxldCB2aXJ0dWFsQ29sdW1uOiBDaGFuZ2VDb2x1bW5JdGVtID0gT2JqZWN0LmFzc2lnbihuZXcgQ2hhbmdlQ29sdW1uSXRlbSgpLCBjb2x1bW4pO1xyXG4gICAgICAgICAgICAgICAgICAgIHZpcnR1YWxDb2x1bW4ub3JpZ2luYWxDb2x1bW5JdGVtID0gY29sdW1uO1xyXG4gICAgICAgICAgICAgICAgICAgIHZpcnR1YWxDb2x1bW4ub2xkVmFsdWUgPSBjb2x1bW4uY2hpbGRyZW4ubWFwKGNoaWxkID0+IGNoaWxkLm9sZFZhbHVlKS5qb2luKFwiO1wiKTtcclxuICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsQ29sdW1uLm5ld1ZhbHVlID0gY29sdW1uLmNoaWxkcmVuLm1hcChjaGlsZCA9PiBjaGlsZC5uZXdWYWx1ZSkuam9pbihcIjtcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZpcnR1YWxDb2x1bW47XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjb2x1bW47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgcm93Tm9kZS5jaGFuZ2VzID0gY29sdW1uVmFsdWVDaGFuZ2VzO1xyXG5cclxuICAgICAgICAgICAgcm93Tm9kZXMucHVzaChyb3dOb2RlKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgLyoqIGRhdGFJZOS4juWPmOabtOihjOeahE1hcCAqL1xyXG4gICAgICAgIGxldCBkYXRhSWRSb3dNYXA6IE1hcDxzdHJpbmcsIENoZ2RyRGF0YVJvd05vZGU+ID0gbmV3IE1hcCgpO1xyXG4gICAgICAgIHJvd05vZGVzLmZvckVhY2gobm9kZSA9PiBkYXRhSWRSb3dNYXAuc2V0KG5vZGUuZGF0YUlkLCBub2RlKSk7XHJcblxyXG4gICAgICAgIHJvd05vZGVzLmZvckVhY2gobm9kZSA9PiB7XHJcbiAgICAgICAgICAgIGlmICghbm9kZS5wYXJlbnREYXRhSWQpIHtcclxuICAgICAgICAgICAgICAgIC8v5qC56IqC54K5XHJcbiAgICAgICAgICAgICAgICBsZXQgZW50aXR5Tm9kZSA9IHRoaXMuZ2VuQ2hnZHJEYXRhRW50aXR5Tm9kZShub2RlLmVudGl0eUNvZGUsIG5vZGUuZW50aXR5TmFtZSk7XHJcbiAgICAgICAgICAgICAgICBlbnRpdHlOb2RlLnJvd3MucHVzaChub2RlKTtcclxuICAgICAgICAgICAgICAgIGNoZ2RyRGF0YS5lbnRpdHlOb2Rlcy5wdXNoKGVudGl0eU5vZGUpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCBwYXJlbnRSb3dOb2RlID0gZGF0YUlkUm93TWFwLmdldChub2RlLnBhcmVudERhdGFJZCk7XHJcbiAgICAgICAgICAgIGlmICghIXBhcmVudFJvd05vZGUpIHtcclxuICAgICAgICAgICAgICAgIC8v5LiK57qn6IqC54K55a2Y5Zyo55qE6IqC54K5XHJcbiAgICAgICAgICAgICAgICBsZXQgZW50aXR5Tm9kZSA9IHBhcmVudFJvd05vZGUuZW50aXR5Tm9kZXMuZmluZChlbiA9PiBlbi5lbnRpdHlDb2RlID09IG5vZGUuZW50aXR5Q29kZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWVudGl0eU5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBlbnRpdHlOb2RlID0gdGhpcy5nZW5DaGdkckRhdGFFbnRpdHlOb2RlKG5vZGUuZW50aXR5Q29kZSwgbm9kZS5lbnRpdHlOYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnRSb3dOb2RlLmVudGl0eU5vZGVzLnB1c2goZW50aXR5Tm9kZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbnRpdHlOb2RlLnJvd3MucHVzaChub2RlKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8v5LiK57qn6IqC54K55LiN5a2Y5Zyo55qE6IqC54K5XHJcbiAgICAgICAgICAgICAgICAvL1RPRE8g5LiK57qn6IqC54K55LiN5a2Y5Zyo55qE6IqC54K55piv5ZCm6ZyA6KaB5p6E6YCg5a6M5pW055qE5LiK57qn57uT5p6E77yfXHJcbiAgICAgICAgICAgICAgICBsZXQgZW50aXR5Tm9kZSA9IHRoaXMuZ2VuQ2hnZHJEYXRhRW50aXR5Tm9kZShub2RlLmVudGl0eUNvZGUsIG5vZGUuZW50aXR5TmFtZSk7XHJcbiAgICAgICAgICAgICAgICBlbnRpdHlOb2RlLnJvd3MucHVzaChub2RlKTtcclxuICAgICAgICAgICAgICAgIGNoZ2RyRGF0YS5lbnRpdHlOb2Rlcy5wdXNoKGVudGl0eU5vZGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuXHJcbiAgICAgICAgcmV0dXJuIGNoZ2RyRGF0YTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGJ1aWxkRGF0YUNvZGVzKGRhdGFDb2RlOiBNYXA8c3RyaW5nLCBzdHJpbmc+LCBlbnRpdHlDb2RlOiBzdHJpbmcpOiBEYXRhQ29kZUZpZWxkW10ge1xyXG4gICAgICAgIGxldCBkYXRhQ29kZXM6IERhdGFDb2RlRmllbGRbXSA9IFtdO1xyXG4gICAgICAgIGRhdGFDb2RlICYmIGRhdGFDb2RlLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHtcclxuICAgICAgICAgICAgbGV0IGRhdGFDb2RlRmllbGQ6IERhdGFDb2RlRmllbGQgPSBuZXcgRGF0YUNvZGVGaWVsZCgpO1xyXG4gICAgICAgICAgICBpZiAoa2V5ID09IFwiXyRkYXRhQ29kZVwiKSB7XHJcbiAgICAgICAgICAgICAgICBkYXRhQ29kZUZpZWxkLmZpZWxkTGFiZWxJZCA9IFwiZGF0YUNvZGVcIjtcclxuICAgICAgICAgICAgICAgIGRhdGFDb2RlRmllbGQuZmllbGROYW1lID0gSTE4blV0aWwuaW5zdGFudE9yRGVmYXVsdChcImJ1c2luZXNzLWNvZGUtdGV4dFwiLCBcIuS4muWKoee8luWPt1wiKTtcclxuICAgICAgICAgICAgICAgIGRhdGFDb2RlRmllbGQuZmllbGRWYWx1ZSA9IHZhbHVlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZGF0YUNvZGVGaWVsZC5maWVsZExhYmVsSWQgPSBrZXk7XHJcbiAgICAgICAgICAgICAgICBkYXRhQ29kZUZpZWxkLmZpZWxkTmFtZSA9IHRoaXMuaGFuZGxlci5nZXRFbnRpdHlGaWVsZE5hbWVPckRlZmF1bHQoZW50aXR5Q29kZSwga2V5KTtcclxuICAgICAgICAgICAgICAgIGRhdGFDb2RlRmllbGQuZmllbGRWYWx1ZSA9IHRoaXMuaGFuZGxlci5mb3JtYXRGaWVsZFZhbHVlKHZhbHVlLCBlbnRpdHlDb2RlLCBrZXkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRhdGFDb2Rlcy5wdXNoKGRhdGFDb2RlRmllbGQpO1xyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIC8v5Lia5Yqh57yW5Y+35o6S5bqPXHJcbiAgICAgICAgdGhpcy5oYW5kbGVyLnNvcnQoZGF0YUNvZGVzLCBlbnRpdHlDb2RlLCAoZGF0YUNvZGUpID0+IGRhdGFDb2RlLmZpZWxkTGFiZWxJZCk7XHJcblxyXG4gICAgICAgIHJldHVybiBkYXRhQ29kZXM7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIOW+l+WIsOaWsOaXp+WGheWuueS4reaJgOacieeahGtleSAqL1xyXG4gICAgcHJpdmF0ZSBleHRyYWN0Q2hhbmdlQ29sdW1uS2V5cyhyb3c6IENoYW5nZURhdGFSb3cpOiBzdHJpbmdbXSB7XHJcbiAgICAgICAgbGV0IGtleXNTZXQ6IFNldDxzdHJpbmc+ID0gbmV3IFNldCgpO1xyXG4gICAgICAgIHJvdy5vbGRDb250ZW50ICYmIHJvdy5vbGRDb250ZW50LmZvckVhY2goKHZhbHVlLCBrZXkpID0+IGtleXNTZXQuYWRkKGtleSkpO1xyXG4gICAgICAgIHJvdy5uZXdDb250ZW50ICYmIHJvdy5uZXdDb250ZW50LmZvckVhY2goKHZhbHVlLCBrZXkpID0+IGtleXNTZXQuYWRkKGtleSkpO1xyXG4gICAgICAgIGNvbnN0IGtleXM6IHN0cmluZ1tdID0gQXJyYXkuZnJvbShrZXlzU2V0LmtleXMoKSk7XHJcbiAgICAgICAgcmV0dXJuIGtleXM7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgZ2VuQ2hnZHJEYXRhRW50aXR5Tm9kZShlbnRpdHlDb2RlOiBzdHJpbmcsIGVudGl0eU5hbWU6IHN0cmluZyk6IENoZ2RyRGF0YUVudGl0eU5vZGUge1xyXG4gICAgICAgIGxldCBub2RlID0gbmV3IENoZ2RyRGF0YUVudGl0eU5vZGUoKTtcclxuICAgICAgICBub2RlLmVudGl0eUNvZGUgPSBlbnRpdHlDb2RlO1xyXG4gICAgICAgIG5vZGUuZW50aXR5TmFtZSA9IGVudGl0eU5hbWU7XHJcbiAgICAgICAgbm9kZS5yb3dzID0gW107XHJcbiAgICAgICAgcmV0dXJuIG5vZGU7XHJcbiAgICB9XHJcblxyXG59Il19