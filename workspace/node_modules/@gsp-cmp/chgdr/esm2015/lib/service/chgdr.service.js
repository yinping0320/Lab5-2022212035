/**
 * @fileoverview added by tsickle
 * Generated from: lib/service/chgdr.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Injector } from '@angular/core';
import { HttpService, SessionService } from '@ecp-caf/caf-common';
import { of } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { OperateType } from '../model/operate-type';
import { MapUtil } from '../util/map.util';
import * as i0 from "@angular/core";
import * as i1 from "@ecp-caf/caf-common";
/** @type {?} */
const ServerIP = '/';
/** @type {?} */
const chgdrUrl = `${ServerIP}api/runtime/chgdr/v1.0`;
export class ChgdrService {
    /**
     * @param {?} http
     * @param {?} sessionService
     * @param {?} injector
     */
    constructor(http, sessionService, injector) {
        this.http = http;
        this.sessionService = sessionService;
        this.injector = injector;
        this.rootDataCodeFieldsMap = new Map();
    }
    /**
     * @param {?} currentQueryParam
     * @return {?}
     */
    queryChangeDataHeader(currentQueryParam) {
        /** @type {?} */
        let obj = Object.assign({}, currentQueryParam);
        if (currentQueryParam.dataCode) {
            obj.dataCode = MapUtil.convertMapToObject(currentQueryParam.dataCode);
        }
        /** @type {?} */
        let json = JSON.stringify(obj);
        /** @type {?} */
        let queryParam = encodeURIComponent(json);
        /** @type {?} */
        let url = `${chgdrUrl}?queryParam=${queryParam}`;
        return this.http.get(url).pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        data => {
            if (!data) {
                return data;
            }
            /** @type {?} */
            let queryResult = (/** @type {?} */ ((/** @type {?} */ (data))));
            queryResult && queryResult.headers && queryResult.headers.forEach((/**
             * @param {?} header
             * @return {?}
             */
            header => {
                //TODO 待删，兼容老数据格式
                if (typeof header.dataCode == "string") {
                    header.dataCode = JSON.parse(header.dataCode);
                }
                header.dataCode = MapUtil.convertObjectToMap(header.dataCode);
                header.changeTime = this.toDate(header.changeTime);
                header.operateType = OperateType.parse(header.operateType);
            }));
            return queryResult;
        })));
    }
    /**
     * @param {?} beId
     * @return {?}
     */
    getRootEntityDataCodeFields(beId) {
        if (!beId) {
            return of([]);
        }
        if (this.rootDataCodeFieldsMap.has(beId)) {
            //直接从缓存中获取
            return of(this.rootDataCodeFieldsMap.get(beId));
        }
        else {
            //获取结果并存入缓存
            /** @type {?} */
            let url = `${chgdrUrl}/rootDataCodeFields?beId=${beId}`;
            return ((/** @type {?} */ ((/** @type {?} */ ((this.http.get(url)))))))
                .pipe(tap((/**
             * @param {?} data
             * @return {?}
             */
            data => this.rootDataCodeFieldsMap.set(beId, data))));
        }
    }
    /**
     * 将字符串或数字转为Date
     * @private
     * @param {?} date
     * @return {?}
     */
    toDate(date) {
        if (typeof date == "string") {
            return new Date(date);
        }
        else if (typeof date == "number") {
            return new Date(date);
        }
        else {
            return date;
        }
    }
    /**
     * @param {?} idOrParam
     * @param {?=} changeTime
     * @return {?}
     */
    getChangeData(idOrParam, changeTime) {
        if (idOrParam == null) {
            throw new Error("id can not be null");
        }
        if (idOrParam instanceof String || typeof idOrParam == "string") {
            return this.getChangeDataById((/** @type {?} */ (idOrParam)), changeTime);
        }
        else {
            return this.getChangeDataByParam(idOrParam);
        }
    }
    /**
     * @private
     * @param {?} id
     * @param {?} changeTime
     * @return {?}
     */
    getChangeDataById(id, changeTime) {
        /** @type {?} */
        let json = JSON.stringify(changeTime);
        /** @type {?} */
        let queryParam = encodeURIComponent(json);
        /** @type {?} */
        let url = `${chgdrUrl}/${id}?changeTime=${queryParam}`;
        return this.http.get(url).pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        data => {
            return this.transChangeDataFromResponse(data);
        })));
    }
    /**
     * @private
     * @param {?} param
     * @return {?}
     */
    getChangeDataByParam(param) {
        if (param == null) {
            throw new Error("ChgdrItemQueryParam can not be null");
        }
        /** @type {?} */
        let requestParam = {};
        Object.assign(requestParam, param);
        //将Map转为Object，否则无法正常序列化
        requestParam.dataIds = MapUtil.convertMapToObject(param.dataIds);
        /** @type {?} */
        let url = `${chgdrUrl}`;
        return this.http.post(url, requestParam).pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        data => {
            return this.transChangeDataFromResponse(data);
        })));
    }
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    transChangeDataFromResponse(data) {
        if (!data) {
            return data;
        }
        /** @type {?} */
        let sh = (/** @type {?} */ ((/** @type {?} */ (data))));
        //TODO 待删，兼容老数据格式
        if (typeof sh.dataCode == "string") {
            sh.dataCode = JSON.parse(sh.dataCode);
        }
        sh.dataCode = MapUtil.convertObjectToMap(sh.dataCode);
        sh.changeTime = this.toDate(sh.changeTime);
        sh.operateType = OperateType.parse(sh.operateType);
        sh.rows = this.transChangeDataRowsFromResponse(sh.rows || []);
        return sh;
    }
    /**
     * @private
     * @param {?} rows
     * @return {?}
     */
    transChangeDataRowsFromResponse(rows) {
        if (!rows || rows.length == 0) {
            return rows;
        }
        rows.forEach((/**
         * @param {?} row
         * @return {?}
         */
        row => {
            if (!row) {
                return;
            }
            row.operateType = OperateType.parse(row.operateType);
            //TODO 待删，兼容老数据格式
            if (typeof row.dataCode == "string") {
                row.dataCode = JSON.parse(row.dataCode);
            }
            row.dataCode = MapUtil.convertObjectToMap(row.dataCode);
            row.oldContent = (/** @type {?} */ (MapUtil.convertObjectToMap(row.oldContent))) || new Map();
            row.newContent = (/** @type {?} */ (MapUtil.convertObjectToMap(row.newContent))) || new Map();
        }));
        return rows;
    }
}
ChgdrService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
ChgdrService.ctorParameters = () => [
    { type: HttpService },
    { type: SessionService },
    { type: Injector }
];
/** @nocollapse */ ChgdrService.ngInjectableDef = i0.defineInjectable({ factory: function ChgdrService_Factory() { return new ChgdrService(i0.inject(i1.HttpService), i0.inject(i1.SessionService), i0.inject(i0.INJECTOR)); }, token: ChgdrService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    ChgdrService.prototype.rootDataCodeFieldsMap;
    /**
     * @type {?}
     * @private
     */
    ChgdrService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    ChgdrService.prototype.sessionService;
    /**
     * @type {?}
     * @private
     */
    ChgdrService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hnZHIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bnc3AtY21wL2NoZ2RyLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2UvY2hnZHIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxXQUFXLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbEUsT0FBTyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0QyxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBTzFDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7Ozs7TUFFckMsUUFBUSxHQUFHLEdBQUc7O01BQ2QsUUFBUSxHQUFHLEdBQUcsUUFBUSx3QkFBd0I7QUFLcEQsTUFBTSxPQUFPLFlBQVk7Ozs7OztJQUd2QixZQUFvQixJQUFpQixFQUMzQixjQUE4QixFQUM5QixRQUFrQjtRQUZSLFNBQUksR0FBSixJQUFJLENBQWE7UUFDM0IsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFKcEIsMEJBQXFCLEdBQXFDLElBQUksR0FBRyxFQUFFLENBQUM7SUFJNUMsQ0FBQzs7Ozs7SUFFMUIscUJBQXFCLENBQUMsaUJBQXVDOztZQUM5RCxHQUFHLEdBQVEsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsaUJBQWlCLENBQUM7UUFDbkQsSUFBSSxpQkFBaUIsQ0FBQyxRQUFRLEVBQUU7WUFDOUIsR0FBRyxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUMsa0JBQWtCLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDdkU7O1lBRUcsSUFBSSxHQUFH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T0FBTyxHQUFHLENBQUMsUUFBUSxJQUFJLFFBQVEsRUFBRTtnQkFDbkMsR0FBRyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUN6QztZQUNELEdBQUcsQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN4RCxHQUFHLENBQUMsVUFBVSxHQUFHLG1CQUFxQixPQUFPLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxFQUFBLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUM5RixHQUFHLENBQUMsVUFBVSxHQUFHLG1CQUFxQixPQUFPLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxFQUFBLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNoRyxDQUFDLEVBQUMsQ0FBQztRQUVILE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQzs7O1lBL0lGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7OztZQWpCUSxXQUFXO1lBQUUsY0FBYztZQURmLFFBQVE7Ozs7Ozs7O0lBb0IzQiw2Q0FBNEU7Ozs7O0lBRWhFLDRCQUF5Qjs7Ozs7SUFDbkMsc0NBQXNDOzs7OztJQUN0QyxnQ0FBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cFNlcnZpY2UsIFNlc3Npb25TZXJ2aWNlIH0gZnJvbSAnQGVjcC1jYWYvY2FmLWNvbW1vbic7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBDaGFuZ2VEYXRhQ29tcEhlYWRlciwgQ2hhbmdlRGF0YUhlYWRlciB9IGZyb20gJy4uL21vZGVsL2NoYW5nZS1kYXRhLWhlYWRlcic7XG5pbXBvcnQgeyBDaGFuZ2VEYXRhUXVlcnlQYXJhbSB9IGZyb20gJy4uL21vZGVsL2NoYW5nZS1kYXRhLXF1ZXJ5LXBhcmFtJztcbmltcG9ydCB7IENoYW5nZURhdGFRdWVyeVJlc3VsdCB9IGZyb20gJy4uL21vZGVsL2NoYW5nZS1kYXRhLXF1ZXJ5LXJlc3VsdCc7XG5pbXBvcnQgeyBDaGFuZ2VEYXRhUm93IH0gZnJvbSAnLi4vbW9kZWwvY2hhbmdlLWRhdGEtcm93JztcbmltcG9ydCB7IENoZ0xvZ0NvbmZpZ0ZpZWxkIH0gZnJvbSAnLi4vbW9kZWwvY2hnZHItY29uZmlnLWZpZWxkJztcbmltcG9ydCB7IENoZ2RySXRlbVF1ZXJ5UGFyYW0gfSBmcm9tICcuLi9tb2RlbC9jaGdkci1pdGVtLXF1ZXJ5LXBhcmFtJztcbmltcG9ydCB7IE9wZXJhdGVUeXBlIH0gZnJvbSAnLi4vbW9kZWwvb3BlcmF0ZS10eXBlJztcbmltcG9ydCB7IE1hcFV0aWwgfSBmcm9tICcuLi91dGlsL21hcC51dGlsJztcblxuY29uc3QgU2VydmVySVAgPSAnLyc7XG5jb25zdCBjaGdkclVybCA9IGAke1NlcnZlcklQfWFwaS9ydW50aW1lL2NoZ2RyL3YxLjBgO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBDaGdkclNlcnZpY2Uge1xuICBwcml2YXRlIHJvb3REYXRhQ29kZUZpZWxkc01hcDogTWFwPHN0cmluZywgQ2hnTG9nQ29uZmlnRmllbGRbXT4gPSBuZXcgTWFwKCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwU2VydmljZSxcbiAgICBwcml2YXRlIHNlc3Npb25TZXJ2aWNlOiBTZXNzaW9uU2VydmljZSxcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcikgeyB9XG5cbiAgcHVibGljIHF1ZXJ5Q2hhbmdlRGF0YUhlYWRlcihjdXJyZW50UXVlcnlQYXJhbTogQ2hhbmdlRGF0YVF1ZXJ5UGFyYW0pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGxldCBvYmo6IGFueSA9IE9iamVjdC5hc3NpZ24oe30sIGN1cnJlbnRRdWVyeVBhcmFtKTtcbiAgICBpZiAoY3VycmVudFF1ZXJ5UGFyYW0uZGF0YUNvZGUpIHtcbiAgICAgIG9iai5kYXRhQ29kZSA9IE1hcFV0aWwuY29udmVydE1hcFRvT2JqZWN0KGN1cnJlbnRRdWVyeVBhcmFtLmRhdGFDb2RlKTtcbiAgICB9XG5cbiAgICBsZXQganNvbiA9IEpTT04uc3RyaW5naWZ5KG9iaik7XG4gICAgbGV0IHF1ZXJ5UGFyYW0gPSBlbmNvZGVVUklDb21wb25lbnQoanNvbik7XG4gICAgbGV0IHVybCA9IGAke2NoZ2RyVXJsfT9xdWVyeVBhcmFtPSR7cXVlcnlQYXJhbX1gO1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KHVybCkucGlwZShtYXAoZGF0YSA9PiB7XG4gICAgICBpZiAoIWRhdGEpIHtcbiAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICB9XG4gICAgICBsZXQgcXVlcnlSZXN1bHQ6IENoYW5nZURhdGFRdWVyeVJlc3VsdCA9IDxDaGFuZ2VEYXRhUXVlcnlSZXN1bHQ+PHVua25vd24+ZGF0YTtcbiAgICAgIHF1ZXJ5UmVzdWx0ICYmIHF1ZXJ5UmVzdWx0LmhlYWRlcnMgJiYgcXVlcnlSZXN1bHQuaGVhZGVycy5mb3JFYWNoKGhlYWRlciA9PiB7XG4gICAgICAgIC8vVE9ETyDlvoXliKDvvIzlhbzlrrnogIHmlbDmja7moLzlvI9cbiAgICAgICAgaWYgKHR5cGVvZiBoZWFkZXIuZGF0YUNvZGUgPT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgIGhlYWRlci5kYXRhQ29kZSA9IEpTT04ucGFyc2UoaGVhZGVyLmRhdGFDb2RlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGhlYWRlci5kYXRhQ29kZSA9IE1hcFV0aWwuY29udmVydE9iamVjdFRvTWFwKGhlYWRlci5kYXRhQ29kZSk7XG4gICAgICAgIGhlYWRlci5jaGFuZ2VUaW1lID0gdGhpcy50b0RhdGUoaGVhZGVyLmNoYW5nZVRpbWUpO1xuICAgICAgICBoZWFkZXIub3BlcmF0ZVR5cGUgPSBPcGVyYXRlVHlwZS5wYXJzZShoZWFkZXIub3BlcmF0ZVR5cGUpO1xuICAgICAgfSlcbiAgICAgIHJldHVybiBxdWVyeVJlc3VsdDtcbiAgICB9KSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Um9vdEVudGl0eURhdGFDb2RlRmllbGRzKGJlSWQ6IHN0cmluZyk6IE9ic2VydmFibGU8Q2hnTG9nQ29uZmlnRmllbGRbXT4ge1xuICAgIGlmICghYmVJZCkge1xuICAgICAgcmV0dXJuIG9mKFtdKTtcbiAgICB9XG4gICAgaWYgKHRoaXMucm9vdERhdGFDb2RlRmllbGRzTWFwLmhhcyhiZUlkKSkge1xuICAgICAgLy/nm7TmjqXku47nvJPlrZjkuK3ojrflj5ZcbiAgICAgIHJldHVybiBvZih0aGlzLnJvb3REYXRhQ29kZUZpZWxkc01hcC5nZXQoYmVJZCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvL+iOt+WPlue7k+aenOW5tuWtmOWFpee8k+WtmFxuICAgICAgbGV0IHVybCA9IGAke2NoZ2RyVXJsfS9yb290RGF0YUNvZGVGaWVsZHM/YmVJZD0ke2JlSWR9YDtcbiAgICAgIHJldHVybiAoPE9ic2VydmFibGU8Q2hnTG9nQ29uZmlnRmllbGRbXT4+PHVua25vd24+KHRoaXMuaHR0cC5nZXQodXJsKSkpXG4gICAgICAgIC5waXBlKHRhcChkYXRhID0+IHRoaXMucm9vdERhdGFDb2RlRmllbGRzTWFwLnNldChiZUlkLCBkYXRhKSkpO1xuICAgIH1cbiAgfVxuXG4gIC8qKiDlsIblrZfnrKbkuLLmiJbmlbDlrZfovazkuLpEYXRlICovXG4gIHByaXZhdGUgdG9EYXRlKGRhdGU6IGFueSk6IERhdGUge1xuICAgIGlmICh0eXBlb2YgZGF0ZSA9PSBcInN0cmluZ1wiKSB7XG4gICAgICByZXR1cm4gbmV3IERhdGUoZGF0ZSk7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgZGF0ZSA9PSBcIm51bWJlclwiKSB7XG4gICAgICByZXR1cm4gbmV3IERhdGUoZGF0ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBkYXRlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDmn6Xor6LkuJrliqHlj5jmm7Tml6Xlv5for6bnu4bmlbDmja7jgIJcbiAgICogQHBhcmFtIGlkIGhlYWRlcklkXG4gICAqIEBwYXJhbSBjaGFuZ2VUaW1lIOWPmOabtOaXtumXtO+8jOWSjGhlYWRlci5jaGFuZ2VUaW1l5L+d5oyB5LiA6Ie0XG4gICAqL1xuICBwdWJsaWMgZ2V0Q2hhbmdlRGF0YShoZWFkZXJJZDogc3RyaW5nLCBjaGFuZ2VUaW1lOiBEYXRlKTogT2JzZXJ2YWJsZTxhbnk+XG4gIHB1YmxpYyBnZXRDaGFuZ2VEYXRhKHBhcmFtOiBDaGdkckl0ZW1RdWVyeVBhcmFtKTogT2JzZXJ2YWJsZTxhbnk+XG4gIHB1YmxpYyBnZXRDaGFuZ2VEYXRhKGlkT3JQYXJhbTogQ2hnZHJJdGVtUXVlcnlQYXJhbSB8IHN0cmluZywgY2hhbmdlVGltZT86IERhdGUpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmIChpZE9yUGFyYW0gPT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaWQgY2FuIG5vdCBiZSBudWxsXCIpO1xuICAgIH1cbiAgICBpZiAoaWRPclBhcmFtIGluc3RhbmNlb2YgU3RyaW5nIHx8IHR5cGVvZiBpZE9yUGFyYW0gPT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0Q2hhbmdlRGF0YUJ5SWQoPHN0cmluZz5pZE9yUGFyYW0sIGNoYW5nZVRpbWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRDaGFuZ2VEYXRhQnlQYXJhbShpZE9yUGFyYW0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q2hhbmdlRGF0YUJ5SWQoaWQ6IHN0cmluZywgY2hhbmdlVGltZTogRGF0ZSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgbGV0IGpzb24gPSBKU09OLnN0cmluZ2lmeShjaGFuZ2VUaW1lKTtcbiAgICBsZXQgcXVlcnlQYXJhbSA9IGVuY29kZVVSSUNvbXBvbmVudChqc29uKTtcbiAgICBsZXQgdXJsID0gYCR7Y2hnZHJVcmx9LyR7aWR9P2NoYW5nZVRpbWU9JHtxdWVyeVBhcmFtfWA7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodXJsKS5waXBlKG1hcChkYXRhID0+IHtcbiAgICAgIHJldHVybiB0aGlzLnRyYW5zQ2hhbmdlRGF0YUZyb21SZXNwb25zZShkYXRhKTtcbiAgICB9KSk7XG4gIH1cblxuICBwcml2YXRlIGdldENoYW5nZURhdGFCeVBhcmFtKHBhcmFtOiBDaGdkckl0ZW1RdWVyeVBhcmFtKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZiAocGFyYW0gPT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2hnZHJJdGVtUXVlcnlQYXJhbSBjYW4gbm90IGJlIG51bGxcIik7XG4gICAgfVxuXG4gICAgbGV0IHJlcXVlc3RQYXJhbTogYW55ID0ge307XG4gICAgT2JqZWN0LmFzc2lnbihyZXF1ZXN0UGFyYW0sIHBhcmFtKTtcbiAgICAvL+Wwhk1hcOi9rOS4uk9iamVjdO+8jOWQpuWImeaXoOazleato+W4uOW6j+WIl+WMllxuICAgIHJlcXVlc3RQYXJhbS5kYXRhSWRzID0gTWFwVXRpbC5jb252ZXJ0TWFwVG9PYmplY3QocGFyYW0uZGF0YUlkcyk7XG5cbiAgICBsZXQgdXJsID0gYCR7Y2hnZHJVcmx9YDtcbiAgICByZXR1cm4gdGhpcy5odHRwLnBvc3QodXJsLCByZXF1ZXN0UGFyYW0pLnBpcGUobWFwKGRhdGEgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMudHJhbnNDaGFuZ2VEYXRhRnJvbVJlc3BvbnNlKGRhdGEpO1xuICAgIH0pKTtcbiAgfVxuXG4gIHByaXZhdGUgdHJhbnNDaGFuZ2VEYXRhRnJvbVJlc3BvbnNlKGRhdGEpOiBDaGFuZ2VEYXRhQ29tcEhlYWRlciB7XG4gICAgaWYgKCFkYXRhKSB7XG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG4gICAgbGV0IHNoOiBDaGFuZ2VEYXRhQ29tcEhlYWRlciA9IDxDaGFuZ2VEYXRhQ29tcEhlYWRlcj48dW5rbm93bj5kYXRhO1xuICAgIC8vVE9ETyDlvoXliKDvvIzlhbzlrrnogIHmlbDmja7moLzlvI9cbiAgICBpZiAodHlwZW9mIHNoLmRhdGFDb2RlID09IFwic3RyaW5nXCIpIHtcbiAgICAgIHNoLmRhdGFDb2RlID0gSlNPTi5wYXJzZShzaC5kYXRhQ29kZSk7XG4gICAgfVxuICAgIHNoLmRhdGFDb2RlID0gTWFwVXRpbC5jb252ZXJ0T2JqZWN0VG9NYXAoc2guZGF0YUNvZGUpO1xuICAgIHNoLmNoYW5nZVRpbWUgPSB0aGlzLnRvRGF0ZShzaC5jaGFuZ2VUaW1lKTtcbiAgICBzaC5vcGVyYXRlVHlwZSA9IE9wZXJhdGVUeXBlLnBhcnNlKHNoLm9wZXJhdGVUeXBlKTtcbiAgICBzaC5yb3dzID0gdGhpcy50cmFuc0NoYW5nZURhdGFSb3dzRnJvbVJlc3BvbnNlKHNoLnJvd3MgfHwgW10pO1xuICAgIHJldHVybiBzaDtcbiAgfVxuXG4gIHByaXZhdGUgdHJhbnNDaGFuZ2VEYXRhUm93c0Zyb21SZXNwb25zZShyb3dzOiBDaGFuZ2VEYXRhUm93W10pOiBDaGFuZ2VEYXRhUm93W10ge1xuICAgIGlmICghcm93cyB8fCByb3dzLmxlbmd0aCA9PSAwKSB7XG4gICAgICByZXR1cm4gcm93cztcbiAgICB9XG5cbiAgICByb3dzLmZvckVhY2gocm93ID0+IHtcbiAgICAgIGlmICghcm93KSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHJvdy5vcGVyYXRlVHlwZSA9IE9wZXJhdGVUeXBlLnBhcnNlKHJvdy5vcGVyYXRlVHlwZSk7XG4gICAgICAvL1RPRE8g5b6F5Yig77yM5YW85a656ICB5pWw5o2u5qC85byPXG4gICAgICBpZiAodHlwZW9mIHJvdy5kYXRhQ29kZSA9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIHJvdy5kYXRhQ29kZSA9IEpTT04ucGFyc2Uocm93LmRhdGFDb2RlKTtcbiAgICAgIH1cbiAgICAgIHJvdy5kYXRhQ29kZSA9IE1hcFV0aWwuY29udmVydE9iamVjdFRvTWFwKHJvdy5kYXRhQ29kZSk7XG4gICAgICByb3cub2xkQ29udGVudCA9IDxNYXA8c3RyaW5nLCBzdHJpbmc+Pk1hcFV0aWwuY29udmVydE9iamVjdFRvTWFwKHJvdy5vbGRDb250ZW50KSB8fCBuZXcgTWFwKCk7XG4gICAgICByb3cubmV3Q29udGVudCA9IDxNYXA8c3RyaW5nLCBzdHJpbmc+Pk1hcFV0aWwuY29udmVydE9iamVjdFRvTWFwKHJvdy5uZXdDb250ZW50KSB8fCBuZXcgTWFwKCk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcm93cztcbiAgfVxufVxuIl19