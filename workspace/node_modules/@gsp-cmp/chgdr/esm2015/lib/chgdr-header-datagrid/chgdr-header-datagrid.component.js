/**
 * @fileoverview added by tsickle
 * Generated from: lib/chgdr-header-datagrid/chgdr-header-datagrid.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChangeDetectorRef, Component, EventEmitter, HostBinding, Injector, Input, Output, TemplateRef, ViewChild } from '@angular/core';
import { DialogComponent } from '@farris/ui-dialog';
import { MessagerService } from '@farris/ui-messager';
import { NotifyService } from '@farris/ui-notify';
import { ChgdrService } from '../service/chgdr.service';
import { ChangeDataQueryResult } from '../model/change-data-query-result';
import { ErrorUtil } from '../util/error.util';
import { tap } from 'rxjs/operators';
import { forkJoin, of } from 'rxjs';
import { MapUtil } from '../util/map.util';
import { ChgdrInnerService } from '../service/chgdr-inner.service';
import { I18nUtil } from '../service/i18n-service';
import { BeforeShowChangeDetailEvent } from '../model/chgdr-ui-config';
export class ChgdrHeaderDatagridComponent {
    /**
     * @param {?} chgdrService
     * @param {?} messageService
     * @param {?} notifyService
     * @param {?} ref
     * @param {?} chgdrInnerService
     * @param {?} injector
     */
    constructor(chgdrService, messageService, notifyService, ref, chgdrInnerService, injector) {
        this.chgdrService = chgdrService;
        this.messageService = messageService;
        this.notifyService = notifyService;
        this.ref = ref;
        this.chgdrInnerService = chgdrInnerService;
        this.injector = injector;
        this.baseCls = true;
        this.showDataId = true;
        this.headers = [];
        this.dataCodeFields = [];
        this.pageChanged = new EventEmitter();
        this.pageSizeChanged = new EventEmitter();
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.resetColumnAndData(null, []);
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (!changes.chgdrs) {
            //如果chgdrs没有更新，则直接返回
            return;
        }
        /** @type {?} */
        let prevEntityId = this.getEntityId(changes.chgdrs.previousValue);
        /** @type {?} */
        let curEntityId = this.getEntityId(changes.chgdrs.currentValue);
        /** @type {?} */
        let requests = [
            this.updateChgdrConfigHandler(curEntityId),
            this.updateDataCodeFields(prevEntityId, curEntityId)
        ];
        forkJoin(requests).subscribe((/**
         * @param {?} data
         * @return {?}
         */
        data => {
            /** @type {?} */
            let chgdrDatas = changes.chgdrs.currentValue;
            if (!!chgdrDatas) {
                this.formatHeaders(chgdrDatas.headers);
            }
            //如果业务实体变更，则重置列信息
            if (curEntityId != null && curEntityId != prevEntityId) {
                this.resetColumnAndData(curEntityId, chgdrDatas.headers);
            }
            else {
                this.headers = chgdrDatas.headers;
            }
        }), (/**
         * @param {?} err
         * @return {?}
         */
        err => {
            console.error("获取BE【" + curEntityId + "】的配置的业务变更日志的业务编号失败：", err);
            this.messageService.error(I18nUtil.instant("get-business-code-config-error", { errorMessage: ErrorUtil.getErrorMessage(err) }));
        }));
    }
    /**
     * 更新业务实体元数据
     * @private
     * @param {?} entityId
     * @return {?}
     */
    updateChgdrConfigHandler(entityId) {
        if (entityId) {
            return this.chgdrInnerService.getChgdrConfigHandler(entityId).pipe(tap((/**
             * @param {?} data
             * @return {?}
             */
            data => this.chgdrConfigHandler = data)));
        }
        else {
            return of(this.chgdrConfigHandler);
        }
    }
    /**
     * 更新dataCodeField数据
     * @param {?} prevEntityId 原BeId
     * @param {?} curEntityId 当前BeId
     * @return {?}
     */
    updateDataCodeFields(prevEntityId, curEntityId) {
        if (curEntityId != null && curEntityId != prevEntityId) {
            //只有发生变更时才更新
            return this.chgdrService.getRootEntityDataCodeFields(curEntityId).pipe(tap((/**
             * @param {?} data
             * @return {?}
             */
            data => this.dataCodeFields = data || [])));
        }
        else {
            //否则直接返回当前值
            return of(this.dataCodeFields);
        }
    }
    /**
     * 格式化headers。主要是解析其中的dataCode，将其转为Object
     * 使用dataCodeObj存放dataCode解析后的结果
     * dataCodeObj属性在ChangeDataHeader中不存在，此处通过强制赋值使用，并且只限于该处使用。
     * @private
     * @param {?} headers
     * @return {?}
     */
    formatHeaders(headers) {
        if (!headers) {
            return;
        }
        headers.forEach((/**
         * @param {?} header
         * @return {?}
         */
        header => {
            /** @type {?} */
            let dataCodeObj;
            this.formatDataCodeMap(header.dataCode);
            if (header.dataCode && header.dataCode.size == 1 && header.dataCode.has("_$dataCode")) {
                //兼容老数据
                //老数据dataCode为自由文本
                dataCodeObj = {};
                if (this.dataCodeFields && this.dataCodeFields.length > 0) {
                    dataCodeObj[this.dataCodeFields[0].fieldLabelId] = header.dataCode.get("_$dataCode");
                }
            }
            else {
                dataCodeObj = MapUtil.convertMapToObject(header.dataCode);
            }
            ((/** @type {?} */ (header))).dataCodeObj = dataCodeObj;
        }));
    }
    /**
     * 格式化业务主键Map
     * @private
     * @param {?} dataCode
     * @return {?}
     */
    formatDataCodeMap(dataCode) {
        if (!dataCode || !this.chgdrConfigHandler) {
            return;
        }
        Array.from(dataCode.keys()).forEach((/**
         * @param {?} fieldLabelId
         * @return {?}
         */
        fieldLabelId => {
            /** @type {?} */
            let value = dataCode.get(fieldLabelId);
            /** @type {?} */
            let formatedValue = this.chgdrConfigHandler.formatMainObjectFieldValue(value, fieldLabelId);
            dataCode.set(fieldLabelId, formatedValue);
        }));
    }
    /**
     * @private
     * @param {?} chgdrs
     * @return {?}
     */
    getEntityId(chgdrs) {
        if (!chgdrs || !chgdrs.headers || chgdrs.headers.length == 0) {
            return null;
        }
        else {
            return chgdrs.headers[0].entityId;
        }
    }
    /**
     * @private
     * @param {?} entityId
     * @param {?} headers
     * @return {?}
     */
    resetColumnAndData(entityId, headers) {
        /** @type {?} */
        let columns = [
            { field: 'userName', width: 130, title: I18nUtil.instant("user-name-column-title") },
            { field: 'changeTime', width: 130, title: I18nUtil.instant("change-time-column-title"), formatter: { type: 'datetime', options: { format: I18nUtil.instant("change-time-column-format") } } },
            { field: 'operateType.name', width: 60, title: I18nUtil.instant("operation-type-title") },
            { field: 'dataId', width: 130, title: I18nUtil.instant("tech-pk-column-title"), visible: this.showDataId }
        ];
        //{field: 'dataCode', width: 130, title: '业务编号'},
        // {field: 'reason', width: 130, title: '变更原因'},
        this.dataCodeFields.forEach((/**
         * @param {?} field
         * @return {?}
         */
        (field) => {
            /** @type {?} */
            let column = {
                field: "dataCodeObj." + field.fieldLabelId,
                title: field.fieldName,
                width: 130
            };
            columns.push(column);
        }));
        /** @type {?} */
        let opColumn = { title: I18nUtil.instant("operation-column-title"), width: 130, template: this.opCell, halign: 'center', align: 'center' };
        columns.push(opColumn);
        this.columns = columns;
        this.headers = headers;
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    onPageChanged($event) {
        this.pageChanged.emit($event);
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    onPageSizeChanged($event) {
        this.pageSizeChanged.emit($event);
    }
    /**
     * @param {?} ctx
     * @return {?}
     */
    clickShowChangeDetail(ctx) {
        /** @type {?} */
        let header = ctx.rowData;
        if (!header) {
            return;
        }
        if (!this.beforeShowChangeDetail) {
            //如果没有打开详情前回调，则按照默认方式打开
            this.showChangeDetail(header);
        }
        else {
            /** @type {?} */
            let event = new BeforeShowChangeDetailEvent();
            event.header = header;
            this.beforeShowChangeDetail(event).subscribe((/**
             * @param {?} isShow
             * @return {?}
             */
            (isShow) => {
                if (isShow) {
                    this.showChangeDetail(header);
                }
            }), (/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                console.error("执行业务变更详情打开前事件报错：", err);
                this.messageService.error("执行业务变更详情打开前事件报错：" + ErrorUtil.getErrorMessage(err));
            }));
        }
    }
    /**
     * @private
     * @param {?} header
     * @return {?}
     */
    showChangeDetail(header) {
        this.chgdrService.getChangeData(header.id, header.changeTime).subscribe((/**
         * @param {?} data
         * @return {?}
         */
        data => {
            if (!data) {
                this.notifyService.error(I18nUtil.instant("can-not-found-change-record-by-id", { headerId: header.id }));
            }
            else {
                this.currentChgdrData = data;
                this.chgdrInfoDialog.show();
            }
        }), (/**
         * @param {?} error
         * @return {?}
         */
        error => {
            console.error("查询业务变更日志出错", error);
            this.messageService.error(I18nUtil.instant("query-change-data-record-error", { errorMessage: ErrorUtil.getErrorMessage(error) }));
        }));
    }
    /**
     * @return {?}
     */
    get showChangeDetailBtn() {
        return I18nUtil.instant("show-change-detail-btn");
    }
    /**
     * @return {?}
     */
    get changeDetailDialogTitle() {
        return I18nUtil.instant("change-detail-dialog-title");
    }
}
ChgdrHeaderDatagridComponent.decorators = [
    { type: Component, args: [{
                selector: 'lib-chgdr-header-datagrid',
                template: "<farris-datagrid #chgdrGrid idField=\"id\" [columns]=\"columns\" [data]=\"headers\"\n  showLineNumber=\"true\" [fit]=\"true\" [fitColumns]=\"true\" \n  [pagination]=\"true\" [pageSize]=\"20\" [showPageList]=\"false\" [pageIndex]=\"chgdrs.pageIndex\" [total]=\"chgdrs.total\"\n  (pageChanged)=\"onPageChanged($event)\" (pageSizeChanged)=\"onPageSizeChanged($event)\"\n>\n</farris-datagrid>\n<ng-template #opCell let-ctx>\n  <a href=\"javascript: void(0);\" (click)=\"clickShowChangeDetail(ctx)\">{{showChangeDetailBtn}}</a>\n</ng-template>\n\n<!-- \u67E5\u770B\u53D8\u66F4\u65E5\u5FD7\u7684\u5F39\u7A97 -->\n<farris-dialog #chgdrInfoDialog\n  [title]=\"changeDetailDialogTitle\"\n  [width]=\"1100\"\n  [height]=\"600\"\n  [showMaxButton]=\"true\"\n  [resizable]=\"true\"\n  [showButtons]=\"false\"\n>\n  <chgdr-data-viewer [data]=\"currentChgdrData\"></chgdr-data-viewer>\n</farris-dialog>",
                styles: [""]
            }] }
];
/** @nocollapse */
ChgdrHeaderDatagridComponent.ctorParameters = () => [
    { type: ChgdrService },
    { type: MessagerService },
    { type: NotifyService },
    { type: ChangeDetectorRef },
    { type: ChgdrInnerService },
    { type: Injector }
];
ChgdrHeaderDatagridComponent.propDecorators = {
    baseCls: [{ type: HostBinding, args: ['class.f-utils-fill',] }],
    chgdrs: [{ type: Input }],
    showDataId: [{ type: Input }],
    beforeShowChangeDetail: [{ type: Input }],
    pageChanged: [{ type: Output }],
    pageSizeChanged: [{ type: Output }],
    opCell: [{ type: ViewChild, args: ['opCell',] }],
    chgdrInfoDialog: [{ type: ViewChild, args: ["chgdrInfoDialog",] }]
};
if (false) {
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.baseCls;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.chgdrs;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.showDataId;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.beforeShowChangeDetail;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.headers;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.dataCodeFields;
    /**
     * @type {?}
     * @private
     */
    ChgdrHeaderDatagridComponent.prototype.chgdrConfigHandler;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.pageChanged;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.pageSizeChanged;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.opCell;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.chgdrInfoDialog;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.columns;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.currentChgdrData;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.I18nUtil;
    /**
     * @type {?}
     * @private
     */
    ChgdrHeaderDatagridComponent.prototype.chgdrService;
    /**
     * @type {?}
     * @private
     */
    ChgdrHeaderDatagridComponent.prototype.messageService;
    /**
     * @type {?}
     * @private
     */
    ChgdrHeaderDatagridComponent.prototype.notifyService;
    /**
     * @type {?}
     * @private
     */
    ChgdrHeaderDatagridComponent.prototype.ref;
    /**
     * @type {?}
     * @private
     */
    ChgdrHeaderDatagridComponent.prototype.chgdrInnerService;
    /**
     * @type {?}
     * @private
     */
    ChgdrHeaderDatagridComponent.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hnZHItaGVhZGVyLWRhdGFncmlkLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bnc3AtY21wL2NoZ2RyLyIsInNvdXJjZXMiOlsibGliL2NoZ2RyLWhlYWRlci1kYXRhZ3JpZC9jaGdkci1oZWFkZXItZGF0YWdyaWQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQVUsTUFBTSxFQUFpQixXQUFXLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRWhLLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUV4RCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUUxRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFL0MsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JDLE9BQU8sRUFBRSxRQUFRLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2hELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUszQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUVuRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDbkQsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFPdkUsTUFBTSxPQUFPLDRCQUE0Qjs7Ozs7Ozs7O0lBMkJ2QyxZQUFvQixZQUEwQixF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eUJBQ0wsS0FBSztxQ0FFTCxLQUFLOzBCQU9MLE1BQU07OEJBRU4sTUFBTTtxQkFJTixTQUFTLFNBQUMsUUFBUTs4QkFDbEIsU0FBUyxTQUFDLGlCQUFpQjs7OztJQWxCNUIsK0NBQWtEOztJQUNsRCw4Q0FBdUM7O0lBQ3ZDLGtEQUFvQzs7SUFFcEMsOERBRW9GOztJQUVwRiwrQ0FBaUM7O0lBQ2pDLHNEQUF5Qzs7Ozs7SUFDekMsMERBQStDOztJQUMvQyxtREFDdUQ7O0lBQ3ZELHVEQUMyRDs7SUFHM0QsOENBQThDOztJQUM5Qyx1REFDaUM7O0lBRWpDLCtDQUFlOztJQUVmLHdEQUFtQzs7SUFDbkMsZ0RBQW1COzs7OztJQUVQLG9EQUFrQzs7Ozs7SUFDNUMsc0RBQXVDOzs7OztJQUN2QyxxREFBb0M7Ozs7O0lBQ3BDLDJDQUE4Qjs7Ozs7SUFDOUIseURBQTRDOzs7OztJQUM1QyxnREFBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGFuZ2VEZXRlY3RvclJlZiwgQ29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIEhvc3RCaW5kaW5nLCBJbmplY3RvciwgSW5wdXQsIE9uSW5pdCwgT3V0cHV0LCBTaW1wbGVDaGFuZ2VzLCBUZW1wbGF0ZVJlZiwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IERhdGFDb2x1bW4gfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbi9jb2x1bW4nO1xyXG5pbXBvcnQgeyBEaWFsb2dDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWRpYWxvZyc7XHJcbmltcG9ydCB7IE1lc3NhZ2VyU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbWVzc2FnZXInO1xyXG5pbXBvcnQgeyBOb3RpZnlTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1ub3RpZnknO1xyXG5pbXBvcnQgeyBDaGdkclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlL2NoZ2RyLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBDaGFuZ2VEYXRhSGVhZGVyIH0gZnJvbSAnLi4vbW9kZWwvY2hhbmdlLWRhdGEtaGVhZGVyJztcclxuaW1wb3J0IHsgQ2hhbmdlRGF0YVF1ZXJ5UmVzdWx0IH0gZnJvbSAnLi4vbW9kZWwvY2hhbmdlLWRhdGEtcXVlcnktcmVzdWx0JztcclxuaW1wb3J0IHsgT3BlcmF0ZVR5cGUgfSBmcm9tICcuLi9tb2RlbC9vcGVyYXRlLXR5cGUnO1xyXG5pbXBvcnQgeyBFcnJvclV0aWwgfSBmcm9tICcuLi91dGlsL2Vycm9yLnV0aWwnO1xyXG5pbXBvcnQgeyBDaGdMb2dDb25maWdGaWVsZCB9IGZyb20gJy4uL21vZGVsL2NoZ2RyLWNvbmZpZy1maWVsZCc7XHJcbmltcG9ydCB7IHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgZm9ya0pvaW4sIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IE1hcFV0aWwgfSBmcm9tICcuLi91dGlsL21hcC51dGlsJztcclxuaW1wb3J0IHsgQ2hnZHJNZXRhZGF0YVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlL2NoZ2RyLW1ldGFkYXRhLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBHU1BCdXNpbmVzc0VudGl0eSB9IGZyb20gJ0Bnc3AtYmVmL2dzcC1iZS1tZXRhZGF0YSc7XHJcbmltcG9ydCB7IEdTUE1ldGFkYXRhUlRTZXJ2aWNlIH0gZnJvbSAnQGdzcC1sY20vbWV0YWRhdGFydC1zZWxlY3Rvcic7XHJcbmltcG9ydCB7IEdTUENvbW1vbkVsZW1lbnQgfSBmcm9tICdAZ3NwLWJlZi9nc3AtY20tbWV0YWRhdGEnO1xyXG5pbXBvcnQgeyBDaGdkcklubmVyU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2UvY2hnZHItaW5uZXIuc2VydmljZSc7XHJcbmltcG9ydCB7IENoZ2RyQ29uZmlnSGFuZGxlciB9IGZyb20gJy4uL3NlcnZpY2UvY2hnZHItY29uZmlnLWhhbmRsZXInO1xyXG5pbXBvcnQgeyBJMThuVXRpbCB9IGZyb20gJy4uL3NlcnZpY2UvaTE4bi1zZXJ2aWNlJztcclxuaW1wb3J0IHsgQmVmb3JlU2hvd0NoYW5nZURldGFpbEV2ZW50IH0gZnJvbSAnLi4vbW9kZWwvY2hnZHItdWktY29uZmlnJztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAnbGliLWNoZ2RyLWhlYWRlci1kYXRhZ3JpZCcsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL2NoZ2RyLWhlYWRlci1kYXRhZ3JpZC5jb21wb25lbnQuaHRtbCcsXHJcbiAgc3R5bGVVcmxzOiBbJy4vY2hnZHItaGVhZGVyLWRhdGFncmlkLmNvbXBvbmVudC5jc3MnXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgQ2hnZHJIZWFkZXJEYXRhZ3JpZENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcbiAgQEhvc3RCaW5kaW5nKCdjbGFzcy5mLXV0aWxzLWZpbGwnKSBiYXNlQ2xzID0gdHJ1ZTtcclxuICBASW5wdXQoKSBjaGdkcnM6IENoYW5nZURhdGFRdWVyeVJlc3VsdDtcclxuICBASW5wdXQoKSBzaG93RGF0YUlkOiBib29sZWFuID0gdHJ1ZTtcclxuXHJcbiAgQElucHV0KClcclxuICAvKiog5omT5byA6K+m5oOF5YmN55qE5Zue6LCDICovXHJcbiAgYmVmb3JlU2hvd0NoYW5nZURldGFpbDogKGV2ZW50OiBCZWZvcmVTaG93Q2hhbmdlRGV0YWlsRXZlbnQpID0+IE9ic2VydmFibGU8Ym9vbGVhbj47XHJcblxyXG4gIGhlYWRlcnM6IENoYW5nZURhdGFIZWFkZXJbXSA9IFtdO1xyXG4gIGRhdGFDb2RlRmllbGRzOiBDaGdMb2dDb25maWdGaWVsZFtdID0gW107XHJcbiAgcHJpdmF0ZSBjaGdkckNvbmZpZ0hhbmRsZXI6IENoZ2RyQ29uZmlnSGFuZGxlcjtcclxuICBAT3V0cHV0KClcclxuICBwYWdlQ2hhbmdlZDogRXZlbnRFbWl0dGVyPG51bWJlcj4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcbiAgQE91dHB1dCgpXHJcbiAgcGFnZVNpemVDaGFuZ2VkOiBFdmVudEVtaXR0ZXI8bnVtYmVyPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcclxuXHJcbiAgLy8g6I635Y+W5a6a5LmJ55qE5Y2V5YWD5qC85qih5p2/XHJcbiAgQFZpZXdDaGlsZCgnb3BDZWxsJykgb3BDZWxsOiBUZW1wbGF0ZVJlZjxhbnk+O1xyXG4gIEBWaWV3Q2hpbGQoXCJjaGdkckluZm9EaWFsb2dcIilcclxuICBjaGdkckluZm9EaWFsb2c6IERpYWxvZ0NvbXBvbmVudDtcclxuXHJcbiAgY29sdW1uczogYW55W107XHJcblxyXG4gIGN1cnJlbnRDaGdkckRhdGE6IENoYW5nZURhdGFIZWFkZXI7XHJcbiAgSTE4blV0aWw6IEkxOG5VdGlsO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNoZ2RyU2VydmljZTogQ2hnZHJTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBtZXNzYWdlU2VydmljZTogTWVzc2FnZXJTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBub3RpZnlTZXJ2aWNlOiBOb3RpZnlTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSByZWY6IENoYW5nZURldGVjdG9yUmVmLFxyXG4gICAgcHJpdmF0ZSBjaGdkcklubmVyU2VydmljZTogQ2hnZHJJbm5lclNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICB0aGlzLnJlc2V0Q29sdW1uQW5kRGF0YShudWxsLCBbXSk7XHJcbiAgfVxyXG5cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XHJcbiAgICBpZiAoIWNoYW5nZXMuY2hnZHJzKSB7XHJcbiAgICAgIC8v5aaC5p6cY2hnZHJz5rKh5pyJ5pu05paw77yM5YiZ55u05o6l6L+U5ZueXHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgcHJldkVudGl0eUlkID0gdGhpcy5nZXRFbnRpdHlJZChjaGFuZ2VzLmNoZ2Rycy5wcmV2aW91c1ZhbHVlKTtcclxuICAgIGxldCBjdXJFbnRpdHlJZCA9IHRoaXMuZ2V0RW50aXR5SWQoY2hhbmdlcy5jaGdkcnMuY3VycmVudFZhbHVlKTtcclxuICAgIGxldCByZXF1ZXN0cyA9IFtcclxuICAgICAgdGhpcy51cGRhdGVDaGdkckNvbmZpZ0hhbmRsZXIoY3VyRW50aXR5SWQpLFxyXG4gICAgICB0aGlzLnVwZGF0ZURhdGFDb2RlRmllbGRzKHByZXZFbnRpdHlJZCwgY3VyRW50aXR5SWQpXHJcbiAgICBdXHJcbiAgICBmb3JrSm9pbihyZXF1ZXN0cykuc3Vic2NyaWJlKGRhdGEgPT4ge1xyXG4gICAgICBsZXQgY2hnZHJEYXRhczogQ2hhbmdlRGF0YVF1ZXJ5UmVzdWx0ID0gY2hhbmdlcy5jaGdkcnMuY3VycmVudFZhbHVlO1xyXG4gICAgICBpZiAoISFjaGdkckRhdGFzKSB7XHJcbiAgICAgICAgdGhpcy5mb3JtYXRIZWFkZXJzKGNoZ2RyRGF0YXMuaGVhZGVycyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8v5aaC5p6c5Lia5Yqh5a6e5L2T5Y+Y5pu077yM5YiZ6YeN572u5YiX5L+h5oGvXHJcbiAgICAgIGlmIChjdXJFbnRpdHlJZCAhPSBudWxsICYmIGN1ckVudGl0eUlkICE9IHByZXZFbnRpdHlJZCkge1xyXG4gICAgICAgIHRoaXMucmVzZXRDb2x1bW5BbmREYXRhKGN1ckVudGl0eUlkLCBjaGdkckRhdGFzLmhlYWRlcnMpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuaGVhZGVycyA9IGNoZ2RyRGF0YXMuaGVhZGVycztcclxuICAgICAgfVxyXG4gICAgfSwgZXJyID0+IHtcclxuICAgICAgY29uc29sZS5lcnJvcihcIuiOt+WPlkJF44CQXCIgKyBjdXJFbnRpdHlJZCArIFwi44CR55qE6YWN572u55qE5Lia5Yqh5Y+Y5pu05pel5b+X55qE5Lia5Yqh57yW5Y+35aSx6LSl77yaXCIsIGVycik7XHJcbiAgICAgIHRoaXMubWVzc2FnZVNlcnZpY2UuZXJyb3IoSTE4blV0aWwuaW5zdGFudChcImdldC1idXNpbmVzcy1jb2RlLWNvbmZpZy1lcnJvclwiLCB7IGVycm9yTWVzc2FnZTogRXJyb3JVdGlsLmdldEVycm9yTWVzc2FnZShlcnIpIH0pKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqIOabtOaWsOS4muWKoeWunuS9k+WFg+aVsOaNriAqL1xyXG4gIHByaXZhdGUgdXBkYXRlQ2hnZHJDb25maWdIYW5kbGVyKGVudGl0eUlkOiBzdHJpbmcpIHtcclxuICAgIGlmIChlbnRpdHlJZCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5jaGdkcklubmVyU2VydmljZS5nZXRDaGdkckNvbmZpZ0hhbmRsZXIoZW50aXR5SWQpLnBpcGUodGFwKGRhdGEgPT4gdGhpcy5jaGdkckNvbmZpZ0hhbmRsZXIgPSBkYXRhKSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gb2YodGhpcy5jaGdkckNvbmZpZ0hhbmRsZXIpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5pu05pawZGF0YUNvZGVGaWVsZOaVsOaNrlxyXG4gICAqIEBwYXJhbSBwcmV2RW50aXR5SWQg5Y6fQmVJZFxyXG4gICAqIEBwYXJhbSBjdXJFbnRpdHlJZCDlvZPliY1CZUlkXHJcbiAgICovXHJcbiAgdXBkYXRlRGF0YUNvZGVGaWVsZHMocHJldkVudGl0eUlkOiBzdHJpbmcsIGN1ckVudGl0eUlkOiBzdHJpbmcpIHtcclxuICAgIGlmIChjdXJFbnRpdHlJZCAhPSBudWxsICYmIGN1ckVudGl0eUlkICE9IHByZXZFbnRpdHlJZCkge1xyXG4gICAgICAvL+WPquacieWPkeeUn+WPmOabtOaXtuaJjeabtOaWsFxyXG4gICAgICByZXR1cm4gdGhpcy5jaGdkclNlcnZpY2UuZ2V0Um9vdEVudGl0eURhdGFDb2RlRmllbGRzKGN1ckVudGl0eUlkKS5waXBlKHRhcChkYXRhID0+IHRoaXMuZGF0YUNvZGVGaWVsZHMgPSBkYXRhIHx8IFtdKSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvL+WQpuWImeebtOaOpei/lOWbnuW9k+WJjeWAvFxyXG4gICAgICByZXR1cm4gb2YodGhpcy5kYXRhQ29kZUZpZWxkcyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmoLzlvI/ljJZoZWFkZXJz44CC5Li76KaB5piv6Kej5p6Q5YW25Lit55qEZGF0YUNvZGXvvIzlsIblhbbovazkuLpPYmplY3RcclxuICAgKiDkvb/nlKhkYXRhQ29kZU9iauWtmOaUvmRhdGFDb2Rl6Kej5p6Q5ZCO55qE57uT5p6cXHJcbiAgICogZGF0YUNvZGVPYmrlsZ7mgKflnKhDaGFuZ2VEYXRhSGVhZGVy5Lit5LiN5a2Y5Zyo77yM5q2k5aSE6YCa6L+H5by65Yi26LWL5YC85L2/55So77yM5bm25LiU5Y+q6ZmQ5LqO6K+l5aSE5L2/55So44CCXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmb3JtYXRIZWFkZXJzKGhlYWRlcnM6IENoYW5nZURhdGFIZWFkZXJbXSkge1xyXG4gICAgaWYgKCFoZWFkZXJzKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGhlYWRlcnMuZm9yRWFjaChoZWFkZXIgPT4ge1xyXG4gICAgICBsZXQgZGF0YUNvZGVPYmo6IGFueTtcclxuICAgICAgdGhpcy5mb3JtYXREYXRhQ29kZU1hcChoZWFkZXIuZGF0YUNvZGUpO1xyXG4gICAgICBpZiAoaGVhZGVyLmRhdGFDb2RlICYmIGhlYWRlci5kYXRhQ29kZS5zaXplID09IDEgJiYgaGVhZGVyLmRhdGFDb2RlLmhhcyhcIl8kZGF0YUNvZGVcIikpIHtcclxuICAgICAgICAvL+WFvOWuueiAgeaVsOaNrlxyXG4gICAgICAgIC8v6ICB5pWw5o2uZGF0YUNvZGXkuLroh6rnlLHmlofmnKxcclxuICAgICAgICBkYXRhQ29kZU9iaiA9IHt9O1xyXG4gICAgICAgIGlmICh0aGlzLmRhdGFDb2RlRmllbGRzICYmIHRoaXMuZGF0YUNvZGVGaWVsZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgZGF0YUNvZGVPYmpbdGhpcy5kYXRhQ29kZUZpZWxkc1swXS5maWVsZExhYmVsSWRdID0gaGVhZGVyLmRhdGFDb2RlLmdldChcIl8kZGF0YUNvZGVcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGRhdGFDb2RlT2JqID0gTWFwVXRpbC5jb252ZXJ0TWFwVG9PYmplY3QoaGVhZGVyLmRhdGFDb2RlKTtcclxuICAgICAgfVxyXG4gICAgICAoPGFueT5oZWFkZXIpLmRhdGFDb2RlT2JqID0gZGF0YUNvZGVPYmo7XHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgLyoqIOagvOW8j+WMluS4muWKoeS4u+mUrk1hcCAqL1xyXG4gIHByaXZhdGUgZm9ybWF0RGF0YUNvZGVNYXAoZGF0YUNvZGU6IE1hcDxzdHJpbmcsIHN0cmluZz4pOiB2b2lkIHtcclxuICAgIGlmICghZGF0YUNvZGUgfHwgIXRoaXMuY2hnZHJDb25maWdIYW5kbGVyKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIEFycmF5LmZyb20oZGF0YUNvZGUua2V5cygpKS5mb3JFYWNoKGZpZWxkTGFiZWxJZCA9PiB7XHJcbiAgICAgIGxldCB2YWx1ZSA9IGRhdGFDb2RlLmdldChmaWVsZExhYmVsSWQpO1xyXG4gICAgICBsZXQgZm9ybWF0ZWRWYWx1ZSA9IHRoaXMuY2hnZHJDb25maWdIYW5kbGVyLmZvcm1hdE1haW5PYmplY3RGaWVsZFZhbHVlKHZhbHVlLCBmaWVsZExhYmVsSWQpO1xyXG4gICAgICBkYXRhQ29kZS5zZXQoZmllbGRMYWJlbElkLCBmb3JtYXRlZFZhbHVlKTtcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEVudGl0eUlkKGNoZ2RyczogQ2hhbmdlRGF0YVF1ZXJ5UmVzdWx0KTogc3RyaW5nIHtcclxuICAgIGlmICghY2hnZHJzIHx8ICFjaGdkcnMuaGVhZGVycyB8fCBjaGdkcnMuaGVhZGVycy5sZW5ndGggPT0gMCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBjaGdkcnMuaGVhZGVyc1swXS5lbnRpdHlJZDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVzZXRDb2x1bW5BbmREYXRhKGVudGl0eUlkOiBzdHJpbmcsIGhlYWRlcnM6IENoYW5nZURhdGFIZWFkZXJbXSkge1xyXG4gICAgbGV0IGNvbHVtbnM6IGFueVtdID0gW1xyXG4gICAgICB7IGZpZWxkOiAndXNlck5hbWUnLCB3aWR0aDogMTMwLCB0aXRsZTogSTE4blV0aWwuaW5zdGFudChcInVzZXItbmFtZS1jb2x1bW4tdGl0bGVcIikgfSxcclxuICAgICAgeyBmaWVsZDogJ2NoYW5nZVRpbWUnLCB3aWR0aDogMTMwLCB0aXRsZTogSTE4blV0aWwuaW5zdGFudChcImNoYW5nZS10aW1lLWNvbHVtbi10aXRsZVwiKSwgZm9ybWF0dGVyOiB7IHR5cGU6ICdkYXRldGltZScsIG9wdGlvbnM6IHsgZm9ybWF0OiBJMThuVXRpbC5pbnN0YW50KFwiY2hhbmdlLXRpbWUtY29sdW1uLWZvcm1hdFwiKSB9IH0gfSxcclxuICAgICAgeyBmaWVsZDogJ29wZXJhdGVUeXBlLm5hbWUnLCB3aWR0aDogNjAsIHRpdGxlOiBJMThuVXRpbC5pbnN0YW50KFwib3BlcmF0aW9uLXR5cGUtdGl0bGVcIikgfSxcclxuICAgICAgeyBmaWVsZDogJ2RhdGFJZCcsIHdpZHRoOiAxMzAsIHRpdGxlOiBJMThuVXRpbC5pbnN0YW50KFwidGVjaC1way1jb2x1bW4tdGl0bGVcIiksIHZpc2libGU6IHRoaXMuc2hvd0RhdGFJZCB9XTtcclxuICAgIC8ve2ZpZWxkOiAnZGF0YUNvZGUnLCB3aWR0aDogMTMwLCB0aXRsZTogJ+S4muWKoee8luWPtyd9LFxyXG4gICAgLy8ge2ZpZWxkOiAncmVhc29uJywgd2lkdGg6IDEzMCwgdGl0bGU6ICflj5jmm7Tljp/lm6AnfSxcclxuICAgIHRoaXMuZGF0YUNvZGVGaWVsZHMuZm9yRWFjaCgoZmllbGQpID0+IHtcclxuICAgICAgbGV0IGNvbHVtbjogRGF0YUNvbHVtbiA9IHtcclxuICAgICAgICBmaWVsZDogXCJkYXRhQ29kZU9iai5cIiArIGZpZWxkLmZpZWxkTGFiZWxJZCxcclxuICAgICAgICB0aXRsZTogZmllbGQuZmllbGROYW1lLFxyXG4gICAgICAgIHdpZHRoOiAxMzBcclxuICAgICAgfTtcclxuICAgICAgY29sdW1ucy5wdXNoKGNvbHVtbik7XHJcbiAgICB9KVxyXG4gICAgbGV0IG9wQ29sdW1uID0geyB0aXRsZTogSTE4blV0aWwuaW5zdGFudChcIm9wZXJhdGlvbi1jb2x1bW4tdGl0bGVcIiksIHdpZHRoOiAxMzAsIHRlbXBsYXRlOiB0aGlzLm9wQ2VsbCwgaGFsaWduOiAnY2VudGVyJywgYWxpZ246ICdjZW50ZXInIH07XHJcbiAgICBjb2x1bW5zLnB1c2gob3BDb2x1bW4pO1xyXG5cclxuICAgIHRoaXMuY29sdW1ucyA9IGNvbHVtbnM7XHJcbiAgICB0aGlzLmhlYWRlcnMgPSBoZWFkZXJzO1xyXG4gIH1cclxuXHJcbiAgb25QYWdlQ2hhbmdlZCgkZXZlbnQpIHtcclxuICAgIHRoaXMucGFnZUNoYW5nZWQuZW1pdCgkZXZlbnQpO1xyXG4gIH1cclxuXHJcbiAgb25QYWdlU2l6ZUNoYW5nZWQoJGV2ZW50KSB7XHJcbiAgICB0aGlzLnBhZ2VTaXplQ2hhbmdlZC5lbWl0KCRldmVudCk7XHJcbiAgfVxyXG5cclxuICBjbGlja1Nob3dDaGFuZ2VEZXRhaWwoY3R4KSB7XHJcbiAgICBsZXQgaGVhZGVyOiBDaGFuZ2VEYXRhSGVhZGVyID0gY3R4LnJvd0RhdGE7XHJcbiAgICBpZiAoIWhlYWRlcikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoIXRoaXMuYmVmb3JlU2hvd0NoYW5nZURldGFpbCkge1xyXG4gICAgICAvL+WmguaenOayoeacieaJk+W8gOivpuaDheWJjeWbnuiwg++8jOWImeaMieeFp+m7mOiupOaWueW8j+aJk+W8gFxyXG4gICAgICB0aGlzLnNob3dDaGFuZ2VEZXRhaWwoaGVhZGVyKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGxldCBldmVudDogQmVmb3JlU2hvd0NoYW5nZURldGFpbEV2ZW50ID0gbmV3IEJlZm9yZVNob3dDaGFuZ2VEZXRhaWxFdmVudCgpO1xyXG4gICAgICBldmVudC5oZWFkZXIgPSBoZWFkZXI7XHJcbiAgICAgIHRoaXMuYmVmb3JlU2hvd0NoYW5nZURldGFpbChldmVudCkuc3Vic2NyaWJlKChpc1Nob3cpID0+IHtcclxuICAgICAgICBpZiAoaXNTaG93KSB7XHJcbiAgICAgICAgICB0aGlzLnNob3dDaGFuZ2VEZXRhaWwoaGVhZGVyKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sIChlcnIpID0+IHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKFwi5omn6KGM5Lia5Yqh5Y+Y5pu06K+m5oOF5omT5byA5YmN5LqL5Lu25oql6ZSZ77yaXCIsIGVycik7XHJcbiAgICAgICAgdGhpcy5tZXNzYWdlU2VydmljZS5lcnJvcihcIuaJp+ihjOS4muWKoeWPmOabtOivpuaDheaJk+W8gOWJjeS6i+S7tuaKpemUme+8mlwiICsgRXJyb3JVdGlsLmdldEVycm9yTWVzc2FnZShlcnIpKTtcclxuICAgICAgfSlcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2hvd0NoYW5nZURldGFpbChoZWFkZXI6IENoYW5nZURhdGFIZWFkZXIpIHtcclxuICAgIHRoaXMuY2hnZHJTZXJ2aWNlLmdldENoYW5nZURhdGEoaGVhZGVyLmlkLCBoZWFkZXIuY2hhbmdlVGltZSkuc3Vic2NyaWJlKGRhdGEgPT4ge1xyXG4gICAgICBpZiAoIWRhdGEpIHtcclxuICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2UuZXJyb3IoSTE4blV0aWwuaW5zdGFudChcImNhbi1ub3QtZm91bmQtY2hhbmdlLXJlY29yZC1ieS1pZFwiLCB7IGhlYWRlcklkOiBoZWFkZXIuaWQgfSkpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuY3VycmVudENoZ2RyRGF0YSA9IGRhdGE7XHJcbiAgICAgICAgdGhpcy5jaGdkckluZm9EaWFsb2cuc2hvdygpO1xyXG4gICAgICB9XHJcbiAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCLmn6Xor6LkuJrliqHlj5jmm7Tml6Xlv5flh7rplJlcIiwgZXJyb3IpO1xyXG4gICAgICB0aGlzLm1lc3NhZ2VTZXJ2aWNlLmVycm9yKEkxOG5VdGlsLmluc3RhbnQoXCJxdWVyeS1jaGFuZ2UtZGF0YS1yZWNvcmQtZXJyb3JcIiwgeyBlcnJvck1lc3NhZ2U6IEVycm9yVXRpbC5nZXRFcnJvck1lc3NhZ2UoZXJyb3IpIH0pKTtcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0IHNob3dDaGFuZ2VEZXRhaWxCdG4oKSB7XHJcbiAgICByZXR1cm4gSTE4blV0aWwuaW5zdGFudChcInNob3ctY2hhbmdlLWRldGFpbC1idG5cIik7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0IGNoYW5nZURldGFpbERpYWxvZ1RpdGxlKCkge1xyXG4gICAgcmV0dXJuIEkxOG5VdGlsLmluc3RhbnQoXCJjaGFuZ2UtZGV0YWlsLWRpYWxvZy10aXRsZVwiKTtcclxuICB9XHJcbn1cclxuIl19