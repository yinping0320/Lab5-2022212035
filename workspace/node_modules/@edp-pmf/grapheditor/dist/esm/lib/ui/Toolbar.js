import { mxClient, mxResources, mxEvent, mxUtils, mxPopupMenu } from "@edp-pmf/mxgraph-ts";
import { ToolbarButton } from "../toolbar/ToolbarButton";
import { ToolbarDropDownButton } from "../toolbar/ToolbarDropDownButton";
import { ToolbarDropDownMenuItem } from "../toolbar/ToolbarDropDownMenuItem";
import { ToolbarItemDisplayStyle } from "../toolbar/ToolbarItemDisplayStyle";
import { ToolbarMenuItem } from "../toolbar/ToolbarMenuItem";
import { ToolbarSeparator } from "../toolbar/ToolbarSeparator";
import { Constant } from "../util/Constant";
import { PmfEvents } from "../util/PmfEvents";
import { ResourceKeys } from "../util/ResourceKeys";
/**
 * 工具栏
 */
var Toolbar = /** @class */ (function () {
    function Toolbar(editorUi, container) {
        this.dropdownImage = (!mxClient.IS_SVG) ? Constant.IMAGE_PATH + '/dropdown.gif' : 'data:image/gif;base64,R0lGODlhDQANAIABAHt7e////yH/C1hNUCBEYXRhWE1QPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS4wLWMwNjAgNjEuMTM0Nzc3LCAyMDEwLzAyLzEyLTE3OjMyOjAwICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpCREM1NkJFMjE0NEMxMUU1ODk1Q0M5MjQ0MTA4QjNDMSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpCREM1NkJFMzE0NEMxMUU1ODk1Q0M5MjQ0MTA4QjNDMSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkQzOUMzMjZCMTQ0QjExRTU4OTVDQzkyNDQxMDhCM0MxIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkQzOUMzMjZDMTQ0QjExRTU4OTVDQzkyNDQxMDhCM0MxIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+Af/+/fz7+vn49/b19PPy8fDv7u3s6+rp6Ofm5eTj4uHg397d3Nva2djX1tXU09LR0M/OzczLysnIx8bFxMPCwcC/vr28u7q5uLe2tbSzsrGwr66trKuqqainpqWko6KhoJ+enZybmpmYl5aVlJOSkZCPjo2Mi4qJiIeGhYSDgoGAf359fHt6eXh3dnV0c3JxcG9ubWxramloZ2ZlZGNiYWBfXl1cW1pZWFdWVVRTUlFQT05NTEtKSUhHRkVEQ0JBQD8+PTw7Ojk4NzY1NDMyMTAvLi0sKyopKCcmJSQjIiEgHx4dHBsaGRgXFhUUExIREA8ODQwLCgkIBwYFBAMCAQAAIfkEAQAAAQAsAAAAAA0ADQAAAhGMj6nL3QAjVHIu6azbvPtWAAA7';
        this.container = container;
        this.editorUi = editorUi;
    }
    /**
     * 重置工具栏
     * @param items
     * @returns
     */
    Toolbar.prototype.reset = function (items) {
        var _this = this;
        while (this.container.hasChildNodes()) {
            this.container.removeChild(this.container.firstChild);
        }
        if (items == null) {
            return;
        }
        items.itemList.forEach(function (item) {
            if (item instanceof ToolbarButton) {
                var elt = _this.buildToolbarButton(item);
                _this.container.appendChild(elt);
                item.elt = elt;
            }
            if (item instanceof ToolbarDropDownButton) {
                var elt = _this.buildToolbarButton(item);
                _this.container.appendChild(elt);
                item.elt = elt;
            }
            if (item instanceof ToolbarSeparator) {
                var elt = _this.addToolbarSeparator();
                item.elt = elt;
            }
        });
    };
    Toolbar.prototype.destroy = function () {
    };
    /**
     * 添加按钮
     * @param item
     * @returns
     */
    Toolbar.prototype.buildToolbarButton = function (item) {
        var _this = this;
        var tooltip = item.toolTipText || mxResources.get(item.resourceKey) || "";
        if (item instanceof ToolbarButton) {
            var action = this.editorUi.actions.getAction(item.actionKey);
            if (action != null && action.getShortcut() != null) {
                tooltip += " (" + action.getShortcut() + ")";
            }
        }
        var btn = this.createToolbarButton(tooltip);
        if (item.displayStyle == ToolbarItemDisplayStyle.ImageAndText || item.displayStyle == ToolbarItemDisplayStyle.Image) {
            var btnImage = this.createToolbarButtonImage(item.imageSrc, item.imageClassName);
            btn.appendChild(btnImage);
        }
        if (item.displayStyle == ToolbarItemDisplayStyle.ImageAndText || item.displayStyle == ToolbarItemDisplayStyle.Text) {
            var btnText_1 = this.createToolbarButtonText(item.text || mxResources.get(item.resourceKey));
            btn.appendChild(btnText_1);
            // 特殊情况处理
            // 缩放按钮显示文本随实际比例变化
            if (item.resourceKey == ResourceKeys.pmf_zoom) {
                this.editorUi.graph.view.addListener(mxEvent.EVENT_SCALE, function () {
                    btnText_1.innerText = Math.round(_this.editorUi.graph.view.scale * 100) + '%';
                });
            }
        }
        if (item instanceof ToolbarButton) {
            this.addToolbarButtonHandler(btn, item);
        }
        if (item instanceof ToolbarDropDownButton) {
            var btnDropdownImage = this.createToolbarButtonDropdownImage();
            btn.appendChild(btnDropdownImage);
            this.addToolbarDropDownButtonHandler(btn, item);
        }
        return btn;
    };
    /**
     * 添加分割线
     * @param c
     * @returns
     */
    Toolbar.prototype.addToolbarSeparator = function (c) {
        c = (c != null) ? c : this.container;
        var elt = document.createElement('div');
        elt.className = 'geSeparator';
        c.appendChild(elt);
        return elt;
    };
    /**
     * 创建按钮
     * @param tooltip
     * @returns
     */
    Toolbar.prototype.createToolbarButton = function (tooltip) {
        var elt = document.createElement('a');
        elt.setAttribute('href', 'javascript:void(0);');
        elt.className = 'geLabel';
        elt.style.color = "#000000";
        if (tooltip != null)
            elt.title = tooltip;
        return elt;
    };
    /**
     * 创建按钮图片
     * @param src
     * @param className
     * @returns
     */
    Toolbar.prototype.createToolbarButtonImage = function (src, className) {
        var elt = document.createElement('img');
        elt.src = src;
        if (className != null)
            elt.className = className;
        elt.style.display = "inline-block";
        elt.style.verticalAlign = "middle";
        return elt;
    };
    /**
     * 创建按钮文字
     * @param text
     * @param className
     * @returns
     */
    Toolbar.prototype.createToolbarButtonText = function (text, className) {
        var elt = document.createElement('div');
        mxUtils.write(elt, text);
        if (className != null)
            elt.className = className;
        elt.style.display = "inline-block";
        elt.style.verticalAlign = "middle";
        elt.style.paddingLeft = "2px";
        return elt;
    };
    /**
     * 创建下拉按钮图标
     * @returns
     */
    Toolbar.prototype.createToolbarButtonDropdownImage = function () {
        var elt = document.createElement('img');
        elt.src = this.dropdownImage;
        elt.style.display = "inline-block";
        elt.style.verticalAlign = "middle";
        elt.style.paddingLeft = "2px";
        return elt;
    };
    /**
     * 添加按钮处理器
     * @param elt
     * @param item
     * @returns
     */
    Toolbar.prototype.addToolbarButtonHandler = function (elt, item) {
        var action = this.editorUi.actions.getAction(item.actionKey);
        if (action == null) {
            return;
        }
        mxEvent.addListener(elt, 'click', function (evt) {
            if (action != null && action.isEnabled()) {
                action.execute(evt);
            }
            mxEvent.consume(evt);
        });
        if (document.documentMode != null && document.documentMode >= 9) {
            mxEvent.addListener(elt, 'mousedown', function (evt) {
                evt.preventDefault();
            });
        }
        var classname = elt.className;
        elt.setEnabled = function (value) {
            if (value) {
                elt.className = classname;
            }
            else {
                elt.className = classname + ' mxDisabled';
            }
        };
        elt.setEnabled(action.isEnabled());
        action.addListener(PmfEvents.StateChanged, function () {
            elt.setEnabled(action.isEnabled());
        });
    };
    /**
     * 添加下拉按钮处理器
     * @param elt
     * @param item
     * @param showLabels
     * @param showDisabled
     */
    Toolbar.prototype.addToolbarDropDownButtonHandler = function (elt, item, showLabels, showDisabled) {
        var _this = this;
        if (showLabels === void 0) { showLabels = true; }
        if (showDisabled === void 0) { showDisabled = true; }
        var show = true;
        var funct = function (popupMenu, cell, evt) {
            _this.addPopupMenuItems(popupMenu, item.items, popupMenu);
        };
        mxEvent.addListener(elt, 'click', function (evt) {
            if (show && (elt.enabled == null || elt.enabled)) {
                _this.editorUi.graph.popupMenuHandler.hideMenu();
                var popupMenu_1 = new mxPopupMenu(funct);
                popupMenu_1.div.className += ' geToolbarMenu';
                popupMenu_1.showDisabled = showDisabled;
                popupMenu_1.labels = showLabels;
                popupMenu_1.autoExpand = true;
                var offset = mxUtils.getOffset(elt);
                popupMenu_1.popup(offset.x, offset.y + elt.offsetHeight, null, evt);
                _this.editorUi.setCurrentMenu(popupMenu_1, elt);
                if (!showLabels && popupMenu_1.div.scrollHeight > popupMenu_1.div.clientHeight) {
                    popupMenu_1.div.style.width = '40px';
                }
                popupMenu_1.hideMenu = function () {
                    mxPopupMenu.prototype.hideMenu.apply(popupMenu_1);
                    _this.editorUi.resetCurrentMenu();
                    popupMenu_1.destroy();
                };
            }
            show = true;
            mxEvent.consume(evt);
        });
        mxEvent.addListener(elt, 'mousedown', function (evt) {
            show = _this.currentElt != elt;
            if (document.documentMode != null && document.documentMode >= 9) {
                evt.preventDefault();
            }
        });
    };
    /**
     * 添加弹出菜单项
     * @param popupMenu
     * @param items
     * @param parent
     */
    Toolbar.prototype.addPopupMenuItems = function (popupMenu, items, parent) {
        var _this = this;
        items.forEach(function (item) {
            if (item instanceof ToolbarMenuItem) {
                var action_1 = _this.editorUi.actions.getAction(item.actionKey);
                var row = popupMenu.addItem(item.text || mxResources.get(item.resourceKey), null, function (evt) {
                    if (action_1 != null && action_1.isEnabled()) {
                        action_1.execute(evt);
                    }
                }, parent, null, action_1 == null ? false : action_1.isEnabled());
                if (action_1 != null && action_1.isToggleAction() && action_1.isSelected()) {
                    popupMenu.addCheckmark(row, Constant.CHECK_MARK_IMAGE);
                }
                _this.addShortcut(row, action_1);
                item.elt = row;
            }
            if (item instanceof ToolbarSeparator) {
                popupMenu.addSeparator(parent);
            }
            if (item instanceof ToolbarDropDownMenuItem) {
                var row = popupMenu.addItem(item.text || mxResources.get(item.resourceKey), null, null, parent);
                _this.addPopupMenuItems(popupMenu, item.items, row);
                item.elt = row;
            }
        });
    };
    /**
     * 添加快捷键提示
     * @param item
     * @param action
     */
    Toolbar.prototype.addShortcut = function (item, action) {
        if (action != null && action.getShortcut() != null) {
            var td = item.firstChild.nextSibling.nextSibling;
            var span = document.createElement('span');
            span.style.color = 'gray';
            mxUtils.write(span, action.getShortcut());
            td.appendChild(span);
        }
    };
    return Toolbar;
}());
export { Toolbar };
//# sourceMappingURL=Toolbar.js.map