/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Optional } from '@angular/core';
import { of, zip } from 'rxjs';
import { HttpService, LanguageService, SessionService } from '@ecp-caf/caf-common';
import { IframeLink } from '../../models/iframe.model';
import { map, switchMap } from 'rxjs/operators';
import { EventUtil, FrmUtil, AppType } from '../../shared/frm-util';
import { FrameworkVariableService } from '../frmVariableService/framework-variable.service';
import { FrmI18nSettingService } from '../i18nService/i18n-setting.service';
export class AppService {
    /**
     * @param {?} http
     * @param {?} sessionSvc
     * @param {?} i18nSetting
     */
    constructor(http, sessionSvc, i18nSetting) {
        this.http = http;
        this.sessionSvc = sessionSvc;
        this.i18nSetting = i18nSetting;
        this.FUNCSTATUS_PATH = '/api/runtime/sys/v1.0/function-states';
        this.APPINVOKE_CAHCE_KEY = 'allappinvoks';
        this.frmVariableService = new FrameworkVariableService();
        if (!this.i18nSetting) {
            /** @type {?} */
            const variables = new FrameworkVariableService();
            /** @type {?} */
            const language = new LanguageService(null);
            this.i18nSetting = new FrmI18nSettingService(variables, language, http);
        }
    }
    /**
     * App跳转打开
     * @param {?} appId
     * @param {?} appEntrance
     * @param {?} params
     * @param {?=} reload
     * @return {?}
     */
    openApp(appId, appEntrance, params, reload) {
        /** @type {?} */
        const appOpts = {
            funcId: '',
            appId,
            appEntrance,
            appType: AppType.App,
            entityParams: params,
            queryStringParams: params,
            isReload: reload
        };
        this.openAppByOptions(appOpts);
    }
    /**
     * App跳转打开服务
     * @param {?} options
     * @return {?}
     */
    openAppByOptions(options) {
        /** @type {?} */
        const linkobj = this.checkingRepeatOpen(options);
        if (linkobj) {
            return;
        }
        this.getInvokeAndEnterApp$(options).subscribe((/**
         * @param {?} link
         * @return {?}
         */
        link => {
            this.getFeb().post(EventUtil.FARRIS_APP_CLICK, link);
        }));
    }
    /**
     * 流方式，App跳转打开服务
     * @param {?} options
     * @return {?}
     */
    openAppByOptions$(options) {
        /** @type {?} */
        const linkobj = this.checkingRepeatOpen(options);
        if (linkobj) {
            return of(true);
        }
        return this.getInvokeAndEnterApp$(options).pipe(map((/**
         * @param {?} link
         * @return {?}
         */
        link => {
            this.getFeb().post(EventUtil.FARRIS_APP_CLICK, link);
            return true;
        })));
    }
    /**
     * 获取app调用信息
     * @param {?} appId
     * @return {?}
     */
    getAppInvok(appId) {
        /** @type {?} */
        const invoks = this.getInvokCache();
        /** @type {?} */
        const funcInvok = invoks.find((/**
         * @param {?} f
         * @return {?}
         */
        f => f.id === appId));
        if (!funcInvok) {
            return this.getInvokConfig(appId).pipe(map((/**
             * @param {?} v
             * @return {?}
             */
            v => {
                if (!v) {
                    return null;
                }
                this.refreshInvokCache(invoks, v);
                return v;
            })));
        }
        return of(funcInvok);
    }
    /**
     * @param {?} options
     * @return {?}
     */
    beforeCloseAppByOptions(options) {
        /** @type {?} */
        const appObkey = EventUtil.appObsToken(options.appId, options.appEntrance, options.tabId);
        /** @type {?} */
        const obs = EventUtil.getObserver(EventUtil.BEFORE_FUNC_CLOSE).get(appObkey);
        if (!obs) {
            this.closeAppByOptions(options).subscribe();
            return;
        }
        /** @type {?} */
        const eventArgs = {
            tabId: this.getPageId(options.appId, options.appEntrance, options.tabId),
            appType: AppType.App,
            appId: options.appId,
            appEntrance: options.appEntrance
        };
        this.getFeb().post(EventUtil.BEFORE_FUNC_CLOSE, eventArgs);
    }
    /**
     * App关闭前接口
     * @param {?} appId
     * @param {?} appEntrance
     * @param {?=} tabId
     * @return {?}
     */
    beforeCloseApp(appId, appEntrance, tabId) {
        /** @type {?} */
        const self = this;
        /** @type {?} */
        const appObkey = EventUtil.appObsToken(appId, appEntrance, tabId);
        /** @type {?} */
        const obs = EventUtil.getObserver(EventUtil.BEFORE_FUNC_CLOSE).get(appObkey);
        if (!obs) {
            this.closeApp(appId, appEntrance, tabId).subscribe();
            return;
        }
        /** @type {?} */
        const eventArgs = {
            tabId: self.getPageId(appId, appEntrance, tabId),
            appType: AppType.App,
            appId,
            appEntrance
        };
        this.getFeb().post(EventUtil.BEFORE_FUNC_CLOSE, eventArgs);
    }
    /**
     * @param {?} options
     * @return {?}
     */
    closeAppByOptions(options) {
        /** @type {?} */
        const appObkey = EventUtil.appObsToken(options.appId, options.appEntrance, options.tabId);
        /** @type {?} */
        const pageToken = this.getPageId(options.appId, options.appEntrance, options.tabId);
        EventUtil.clearObserver(appObkey);
        EventUtil.clearEventPipe(pageToken);
        /** @type {?} */
        const objIndex = FrmUtil.getTabArray().findIndex((/**
         * @param {?} i
         * @return {?}
         */
        i => i.id === pageToken && i.appType === AppType.App));
        /** @type {?} */
        const obj = FrmUtil.getTabArray()[objIndex];
        options.token = options.token || obj.formToken;
        FrmUtil.removeTab(objIndex);
        /** @type {?} */
        const eventArgs = {
            tabId: pageToken,
            appType: AppType.App,
            appId: options.tabId,
            appEntrance: options.appEntrance
        };
        this.getFeb().post(EventUtil.FUNC_CLOSED, eventArgs);
        return this.quitApp(options, obj.su);
    }
    /**
     * 关闭app
     * @param {?} appId
     * @param {?} appEntrance
     * @param {?=} tabId
     * @return {?}
     */
    closeApp(appId, appEntrance, tabId) {
        /** @type {?} */
        const self = this;
        /** @type {?} */
        const appObkey = EventUtil.appObsToken(appId, appEntrance, tabId);
        /** @type {?} */
        const pageId = this.getPageId(appId, appEntrance, tabId);
        EventUtil.clearObserver(appObkey);
        EventUtil.clearEventPipe(pageId);
        /** @type {?} */
        const objIndex = FrmUtil.getTabArray().findIndex((/**
         * @param {?} i
         * @return {?}
         */
        i => i.id === pageId && i.appType === AppType.App));
        /** @type {?} */
        const obj = FrmUtil.getTabArray()[objIndex];
        /** @type {?} */
        const formToken = obj.formToken;
        FrmUtil.removeTab(objIndex);
        /** @type {?} */
        const eventArgs = {
            tabId: pageId,
            appType: AppType.App,
            appId,
            appEntrance,
        };
        self.getFeb().post(EventUtil.FUNC_CLOSED, eventArgs);
        /** @type {?} */
        const options = {
            tabId,
            funcId: '',
            appId,
            appEntrance,
            appType: AppType.App,
            token: formToken
        };
        return this.quitApp(options, obj.su).pipe(map((/**
         * @param {?} v
         * @return {?}
         */
        v => { })));
    }
    /**
     * @private
     * @param {?} options
     * @return {?}
     */
    getInvokeAndEnterApp$(options) {
        /** @type {?} */
        const newPageId = this.newPageId(options.appId, options.appEntrance, options.tabId);
        options.tabId = newPageId;
        return this.getAppInvok(options.appId).pipe(switchMap((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            /** @type {?} */
            let invokEntry = value.appInvoks.find((/**
             * @param {?} invok
             * @return {?}
             */
            invok => invok.appEntrance === options.appEntrance));
            if (!options.appEntrance && !invokEntry) {
                invokEntry = value.appInvoks.find((/**
                 * @param {?} invok
                 * @return {?}
                 */
                invok => !invok.appEntrance));
            }
            if (!invokEntry) {
                window.alert(`请检查当前应用(ID:${options.appId})配置的应用入口(appEntrance:${options.appEntrance})是否存在`);
                return;
            }
            /** @type {?} */
            let entityParam;
            try {
                entityParam = invokEntry.entityParams ? JSON.parse(invokEntry.entityParams) : null;
            }
            catch (e) {
                entityParam = null;
                console.log(e);
            }
            /** @type {?} */
            const su = this.getSu(value.url);
            return this.enterApp({
                tabId: newPageId,
                appId: options.appId,
                appEntrance: options.appEntrance,
                menuName: options.tabName || invokEntry.name,
                action: 'enterapp'
            }, su).pipe(map((/**
             * @param {?} token
             * @return {?}
             */
            token => {
                /** @type {?} */
                const routurl = value.url + (options.appEntrance ? `#/${options.appEntrance}` : '');
                /** @type {?} */
                const linkobj = new IframeLink(value.code, null, this.buildQueryString(routurl, options.appId, options.appEntrance, options.tabId, token, options.queryStringParams));
                // id加入口区分,tabId页签唯一标识
                linkobj.id = newPageId;
                linkobj.appType = AppType.App;
                linkobj.appId = options.appId;
                linkobj.appEntrance = options.appEntrance;
                // 显示app名字及入口名字
                linkobj.FuncName = options.tabName || invokEntry.name;
                linkobj.url = value.url;
                linkobj.reload = options.isReload;
                linkobj.su = su;
                linkobj.formToken = token;
                if (entityParam) {
                    entityParam.forEach((/**
                     * @param {?} item
                     * @return {?}
                     */
                    item => {
                        if (item.name === 'mode') {
                            linkobj.mode = item.value;
                            linkobj.src += (item.value ? `&appMode=${item.value}&` : '');
                        }
                    }));
                }
                this.getFeb().post(newPageId, options.entityParams);
                return linkobj;
            })), switchMap((/**
             * @param {?} formLink
             * @return {?}
             */
            formLink => {
                return this.i18nSetting.getSetting$().pipe(map((/**
                 * @return {?}
                 */
                () => formLink)));
            })));
        })));
    }
    /**
     * @private
     * @param {?} appId
     * @return {?}
     */
    getInvokConfig(appId) {
        /** @type {?} */
        const url = `/api/runtime/sys/v1.0/gspapp/${appId}`;
        return this.http.request('Get', url, FrmUtil.setHeader(null, {}));
    }
    /**
     * 进入应用，触发相关服务
     * @private
     * @param {?} enterParam
     * @param {?} su
     * @return {?}
     */
    enterApp(enterParam, su) {
        /** @type {?} */
        const bizContextUrl = this.FUNCSTATUS_PATH + (!su ? '' : `?su=${su}`);
        return this.http.request('Post', bizContextUrl, FrmUtil.setHeader(null, { body: enterParam })).pipe(map((/**
         * @param {?} v
         * @return {?}
         */
        (v) => {
            return v.token || v.sessionId;
        })));
    }
    /**
     * 退出应用，触发相关服务
     * @private
     * @param {?} options
     * @param {?=} su
     * @return {?}
     */
    quitApp(options, su) {
        /** @type {?} */
        const body = {
            tabId: options.tabId,
            token: options.token,
            appId: options.appId,
            appEntrance: options.appEntrance,
            action: 'quitapp'
        };
        /** @type {?} */
        const invokObs = this.getAppInvok(options.appId);
        /** @type {?} */
        const bizContextUrl = this.FUNCSTATUS_PATH + (!su ? '' : `?su=${su}`);
        /** @type {?} */
        const funcState$ = this.http.request('Post', bizContextUrl, FrmUtil.setHeader(null, { body }));
        // tslint:disable-next-line: deprecation
        /** @type {?} */
        const $r = zip(invokObs, funcState$, (/**
         * @param {?} res1
         * @param {?} res2
         * @return {?}
         */
        (res1, res2) => ({ res1, res2 })));
        return $r;
    }
    /**
     * @private
     * @param {?} url
     * @return {?}
     */
    getSu(url) {
        /** @type {?} */
        const uriArr = url.split('/');
        return uriArr.length > 3 ? uriArr[3] : '';
    }
    /**
     * @private
     * @return {?}
     */
    getInvokCache() {
        /** @type {?} */
        const appInvokesCache = this.frmVariableService.getFrmVariableByKey(this.APPINVOKE_CAHCE_KEY);
        return (/** @type {?} */ (appInvokesCache)) || [];
    }
    /**
     * @private
     * @param {?} invoks
     * @param {?} funcInvok
     * @return {?}
     */
    refreshInvokCache(invoks, funcInvok) {
        if (!funcInvok) {
            return;
        }
        invoks.push(funcInvok);
        this.frmVariableService.frameworkVariableReg(this.APPINVOKE_CAHCE_KEY, invoks);
    }
    // tslint:disable-next-line: max-line-length
    /**
     * @private
     * @param {?} routurl
     * @param {?} appId
     * @param {?} appEntrance
     * @param {?} tabId
     * @param {?} token
     * @param {?} params
     * @return {?}
     */
    buildQueryString(routurl, appId, appEntrance, tabId, token, params) {
        if (routurl.indexOf('?') < 0) {
            routurl += `?appId=${appId}&appEntrance=${appEntrance}`;
        }
        else {
            routurl += `&appId=${appId}&appEntrance=${appEntrance}`;
        }
        routurl += `&appType=${AppType.App}`;
        routurl += `&tabId=${this.getPageId(appId, appEntrance, tabId)}`;
        routurl += !token ? '' : `&cvft=${token}`;
        if (params) {
            params.forEach((/**
             * @param {?} value
             * @param {?} key
             * @return {?}
             */
            (value, key) => {
                routurl += !key ? '' : `&${key}=${value}`;
            }));
        }
        return routurl;
    }
    /**
     * @private
     * @return {?}
     */
    getFeb() {
        return EventUtil.getFrmEvent();
    }
    /**
     * @private
     * @param {?} appId
     * @param {?} appEntrance
     * @return {?}
     */
    mergeAppId(appId, appEntrance) {
        return `${appId}_${appEntrance}`;
    }
    /**
     * 获取当前菜单页面的唯一标识
     * @private
     * @param {?} appId
     * @param {?} appEntrance
     * @param {?} tabId
     * @return {?}
     */
    getPageId(appId, appEntrance, tabId) {
        return tabId || this.mergeAppId(appId, appEntrance);
    }
    /**
     * 生成页面唯一标识
     * @private
     * @param {?} appId
     * @param {?} appEntrance
     * @param {?} tabId
     * @return {?}
     */
    newPageId(appId, appEntrance, tabId) {
        return tabId ? `${this.mergeAppId(appId, appEntrance)}_${tabId}` : this.mergeAppId(appId, appEntrance);
    }
    /**
     * @private
     * @param {?} options
     * @return {?}
     */
    checkingRepeatOpen(options) {
        /** @type {?} */
        const appId = options.appId;
        /** @type {?} */
        const appEntrance = options.appEntrance;
        /** @type {?} */
        const tabId = options.tabId;
        /** @type {?} */
        const entityParams = options.entityParams;
        /** @type {?} */
        let linkobj;
        /** @type {?} */
        const pageId = this.getPageId(appId, appEntrance, tabId);
        linkobj = FrmUtil.getTabArray().find((/**
         * @param {?} i
         * @return {?}
         */
        i => i.id === pageId && i.appType === AppType.App));
        if (linkobj) {
            linkobj.FuncName = options.tabName || linkobj.FuncName;
            linkobj.src = this.buildQueryString(linkobj.url, appId, appEntrance, options.tabId, linkobj.sessionid, options.queryStringParams);
            linkobj.reload = options.isReload;
            this.getFeb().post(pageId, entityParams);
            this.getFeb().post(EventUtil.FARRIS_APP_CLICK, linkobj);
        }
        return linkobj;
    }
}
AppService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
AppService.ctorParameters = () => [
    { type: HttpService },
    { type: SessionService },
    { type: FrmI18nSettingService, decorators: [{ type: Optional }] }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    AppService.prototype.FUNCSTATUS_PATH;
    /**
     * @type {?}
     * @private
     */
    AppService.prototype.APPINVOKE_CAHCE_KEY;
    /**
     * @type {?}
     * @private
     */
    AppService.prototype.frmVariableService;
    /**
     * @type {?}
     * @private
     */
    AppService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    AppService.prototype.sessionSvc;
    /**
     * @type {?}
     * @private
     */
    AppService.prototype.i18nSetting;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ3NwLXN5cy9ydGYtY29tbW9uLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2FwcHNlcnZpY2UvYXBwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBYyxFQUFFLEVBQUUsR0FBRyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25GLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRWhELE9BQU8sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBNkMsTUFBTSx1QkFBdUIsQ0FBQztBQUMvRyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxrREFBa0QsQ0FBQztBQUM1RixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUk1RSxNQUFNLE9BQU8sVUFBVTs7Ozs7O0lBS25CLFlBQ1ksSUFBaUIsRUFDakIsVUFBMEIsRUFDZCxXQUFrQztRQUY5QyxTQUFJLEdBQUosSUFBSSxDQUFhO1FBQ2pCLGVBQVUsR0FBVixVQUFVLENBQWdCO1FBQ2QsZ0JBQVcsR0FBWCxXQUFXLENBQXVCO1FBUGxELG9CQUFlLEdBQUcsdUNBQXVDLENBQUM7UUFDMUQsd0JBQW1CLEdBQUcsY0FBYyxDQUFDO1FBUXpDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLHdCQUF3QixFQUFFLENBQUM7UUFDekQsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUU7O2tCQUNiLFNBQVMsR0FBRyxJQUFJLHdCQUF3QixFQUFFOztrQkFD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TSxFQUFFLFlBQVksQ0FBQyxDQUFDO1lBQ3pDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLGdCQUFnQixFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQzNEO1FBQ0QsT0FBTyxPQUFPLENBQUM7SUFDbkIsQ0FBQzs7O1lBeFhKLFVBQVU7Ozs7WUFURixXQUFXO1lBQW1CLGNBQWM7WUFNNUMscUJBQXFCLHVCQVlyQixRQUFROzs7Ozs7O0lBUGIscUNBQWtFOzs7OztJQUNsRSx5Q0FBNkM7Ozs7O0lBQzdDLHdDQUFxRDs7Ozs7SUFHakQsMEJBQXlCOzs7OztJQUN6QixnQ0FBa0M7Ozs7O0lBQ2xDLGlDQUFzRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCB6aXAgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgSHR0cFNlcnZpY2UsIExhbmd1YWdlU2VydmljZSwgU2Vzc2lvblNlcnZpY2UgfSBmcm9tICdAZWNwLWNhZi9jYWYtY29tbW9uJztcclxuaW1wb3J0IHsgSWZyYW1lTGluayB9IGZyb20gJy4uLy4uL21vZGVscy9pZnJhbWUubW9kZWwnO1xyXG5pbXBvcnQgeyBtYXAsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgRnJtRXZlbnRCdXMgfSBmcm9tICcuLi8uLi9ldmVudGJ1cy9mcm0tZXZlbmJ1cyc7XHJcbmltcG9ydCB7IEV2ZW50VXRpbCwgRnJtVXRpbCwgQXBwVHlwZSwgRnVuY0V2ZW50QXJncywgQXBwT3B0aW9ucywgRnVuY1N0YXRlUGFyYW0gfSBmcm9tICcuLi8uLi9zaGFyZWQvZnJtLXV0aWwnO1xyXG5pbXBvcnQgeyBGcmFtZXdvcmtWYXJpYWJsZVNlcnZpY2UgfSBmcm9tICcuLi9mcm1WYXJpYWJsZVNlcnZpY2UvZnJhbWV3b3JrLXZhcmlhYmxlLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGcm1JMThuU2V0dGluZ1NlcnZpY2UgfSBmcm9tICcuLi9pMThuU2VydmljZS9pMThuLXNldHRpbmcuc2VydmljZSc7XHJcblxyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQXBwU2VydmljZSB7XHJcbiAgICBwcml2YXRlIEZVTkNTVEFUVVNfUEFUSCA9ICcvYXBpL3J1bnRpbWUvc3lzL3YxLjAvZnVuY3Rpb24tc3RhdGVzJztcclxuICAgIHByaXZhdGUgQVBQSU5WT0tFX0NBSENFX0tFWSA9ICdhbGxhcHBpbnZva3MnO1xyXG4gICAgcHJpdmF0ZSBmcm1WYXJpYWJsZVNlcnZpY2U6IEZyYW1ld29ya1ZhcmlhYmxlU2VydmljZTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlIGh0dHA6IEh0dHBTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgc2Vzc2lvblN2YzogU2Vzc2lvblNlcnZpY2UsXHJcbiAgICAgICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBpMThuU2V0dGluZzogRnJtSTE4blNldHRpbmdTZXJ2aWNlXHJcbiAgICApIHtcclxuICAgICAgICB0aGlzLmZybVZhcmlhYmxlU2VydmljZSA9IG5ldyBGcmFtZXdvcmtWYXJpYWJsZVNlcnZpY2UoKTtcclxuICAgICAgICBpZiAoIXRoaXMuaTE4blNldHRpbmcpIHtcclxuICAgICAgICAgICAgY29uc3QgdmFyaWFibGVzID0gbmV3IEZyYW1ld29ya1ZhcmlhYmxlU2VydmljZSgpO1xyXG4gICAgICAgICAgICBjb25zdCBsYW5ndWFnZSA9IG5ldyBMYW5ndWFnZVNlcnZpY2UobnVsbCk7XHJcbiAgICAgICAgICAgIHRoaXMuaTE4blNldHRpbmcgPSBuZXcgRnJtSTE4blNldHRpbmdTZXJ2aWNlKHZhcmlhYmxlcywgbGFuZ3VhZ2UsIGh0dHApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEFwcOi3s+i9rOaJk+W8gFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgb3BlbkFwcChhcHBJZDogc3RyaW5nLCBhcHBFbnRyYW5jZTogc3RyaW5nLCBwYXJhbXM6IE1hcDxzdHJpbmcsIHN0cmluZz4sIHJlbG9hZD86IGJvb2xlYW4pIHtcclxuICAgICAgICBjb25zdCBhcHBPcHRzOiBBcHBPcHRpb25zID0ge1xyXG4gICAgICAgICAgICBmdW5jSWQ6ICcnLFxyXG4gICAgICAgICAgICBhcHBJZCxcclxuICAgICAgICAgICAgYXBwRW50cmFuY2UsXHJcbiAgICAgICAgICAgIGFwcFR5cGU6IEFwcFR5cGUuQXBwLFxyXG4gICAgICAgICAgICBlbnRpdHlQYXJhbXM6IHBhcmFtcyxcclxuICAgICAgICAgICAgcXVlcnlTdHJpbmdQYXJhbXM6IHBhcmFtcyxcclxuICAgICAgICAgICAgaXNSZWxvYWQ6IHJlbG9hZFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5vcGVuQXBwQnlPcHRpb25zKGFwcE9wdHMpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQXBw6Lez6L2s5omT5byA5pyN5YqhXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBvcGVuQXBwQnlPcHRpb25zKG9wdGlvbnM6IEFwcE9wdGlvbnMpIHtcclxuXHJcbiAgICAgICAgY29uc3QgbGlua29iaiA9IHRoaXMuY2hlY2tpbmdSZXBlYXRPcGVuKG9wdGlvbnMpO1xyXG4gICAgICAgIGlmIChsaW5rb2JqKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5nZXRJbnZva2VBbmRFbnRlckFwcCQob3B0aW9ucykuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICBsaW5rID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0RmViKCkucG9zdChFdmVudFV0aWwuRkFSUklTX0FQUF9DTElDSywgbGluayk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5rWB5pa55byP77yMQXBw6Lez6L2s5omT5byA5pyN5YqhXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBvcGVuQXBwQnlPcHRpb25zJChvcHRpb25zOiBBcHBPcHRpb25zKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgICAgICBjb25zdCBsaW5rb2JqID0gdGhpcy5jaGVja2luZ1JlcGVhdE9wZW4ob3B0aW9ucyk7XHJcbiAgICAgICAgaWYgKGxpbmtvYmopIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRJbnZva2VBbmRFbnRlckFwcCQob3B0aW9ucykucGlwZShcclxuICAgICAgICAgICAgbWFwKFxyXG4gICAgICAgICAgICAgICAgbGluayA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRGZWIoKS5wb3N0KEV2ZW50VXRpbC5GQVJSSVNfQVBQX0NMSUNLLCBsaW5rKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDojrflj5ZhcHDosIPnlKjkv6Hmga9cclxuICAgICAqL1xyXG4gICAgcHVibGljIGdldEFwcEludm9rKGFwcElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgICAgIGNvbnN0IGludm9rcyA9IHRoaXMuZ2V0SW52b2tDYWNoZSgpO1xyXG4gICAgICAgIGNvbnN0IGZ1bmNJbnZvayA9IGludm9rcy5maW5kKGYgPT4gZi5pZCA9PT0gYXBwSWQpO1xyXG4gICAgICAgIGlmICghZnVuY0ludm9rKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEludm9rQ29uZmlnKGFwcElkKS5waXBlKFxyXG4gICAgICAgICAgICAgICAgbWFwKHYgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoSW52b2tDYWNoZShpbnZva3MsIHYpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB2O1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG9mKGZ1bmNJbnZvayk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGJlZm9yZUNsb3NlQXBwQnlPcHRpb25zKG9wdGlvbnM6IEFwcE9wdGlvbnMpIHtcclxuICAgICAgICBjb25zdCBhcHBPYmtleSA9IEV2ZW50VXRpbC5hcHBPYnNUb2tlbihvcHRpb25zLmFwcElkLCBvcHRpb25zLmFwcEVudHJhbmNlLCBvcHRpb25zLnRhYklkKTtcclxuICAgICAgICBjb25zdCBvYnMgPSBFdmVudFV0aWwuZ2V0T2JzZXJ2ZXIoRXZlbnRVdGlsLkJFRk9SRV9GVU5DX0NMT1NFKS5nZXQoYXBwT2JrZXkpO1xyXG4gICAgICAgIGlmICghb2JzKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2xvc2VBcHBCeU9wdGlvbnMob3B0aW9ucykuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGV2ZW50QXJnczogRnVuY0V2ZW50QXJncyA9IHtcclxuICAgICAgICAgICAgdGFiSWQ6IHRoaXMuZ2V0UGFnZUlkKG9wdGlvbnMuYXBwSWQsIG9wdGlvbnMuYXBwRW50cmFuY2UsIG9wdGlvbnMudGFiSWQpLFxyXG4gICAgICAgICAgICBhcHBUeXBlOiBBcHBUeXBlLkFwcCxcclxuICAgICAgICAgICAgYXBwSWQ6IG9wdGlvbnMuYXBwSWQsXHJcbiAgICAgICAgICAgIGFwcEVudHJhbmNlOiBvcHRpb25zLmFwcEVudHJhbmNlXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmdldEZlYigpLnBvc3QoRXZlbnRVdGlsLkJFRk9SRV9GVU5DX0NMT1NFLCBldmVudEFyZ3MpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQXBw5YWz6Zet5YmN5o6l5Y+jXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBiZWZvcmVDbG9zZUFwcChhcHBJZDogc3RyaW5nLCBhcHBFbnRyYW5jZTogc3RyaW5nLCB0YWJJZD86IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgICAgIGNvbnN0IGFwcE9ia2V5ID0gRXZlbnRVdGlsLmFwcE9ic1Rva2VuKGFwcElkLCBhcHBFbnRyYW5jZSwgdGFiSWQpO1xyXG4gICAgICAgIGNvbnN0IG9icyA9IEV2ZW50VXRpbC5nZXRPYnNlcnZlcihFdmVudFV0aWwuQkVGT1JFX0ZVTkNfQ0xPU0UpLmdldChhcHBPYmtleSk7XHJcbiAgICAgICAgaWYgKCFvYnMpIHtcclxuICAgICAgICAgICAgdGhpcy5jbG9zZUFwcChhcHBJZCwgYXBwRW50cmFuY2UsIHRhYklkKS5zdWJzY3JpYmUoKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgZXZlbnRBcmdzOiBGdW5jRXZlbnRBcmdzID0ge1xyXG4gICAgICAgICAgICB0YWJJZDogc2VsZi5nZXRQYWdlSWQoYXBwSWQsIGFwcEVudHJhbmNlLCB0YWJJZCksXHJcbiAgICAgICAgICAgIGFwcFR5cGU6IEFwcFR5cGUuQXBwLFxyXG4gICAgICAgICAgICBhcHBJZCxcclxuICAgICAgICAgICAgYXBwRW50cmFuY2VcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuZ2V0RmViKCkucG9zdChFdmVudFV0aWwuQkVGT1JFX0ZVTkNfQ0xPU0UsIGV2ZW50QXJncyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNsb3NlQXBwQnlPcHRpb25zKG9wdGlvbnM6IEFwcE9wdGlvbnMpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgICAgIGNvbnN0IGFwcE9ia2V5ID0gRXZlbnRVdGlsLmFwcE9ic1Rva2VuKG9wdGlvbnMuYXBwSWQsIG9wdGlvbnMuYXBwRW50cmFuY2UsIG9wdGlvbnMudGFiSWQpO1xyXG4gICAgICAgIGNvbnN0IHBhZ2VUb2tlbiA9IHRoaXMuZ2V0UGFnZUlkKG9wdGlvbnMuYXBwSWQsIG9wdGlvbnMuYXBwRW50cmFuY2UsIG9wdGlvbnMudGFiSWQpO1xyXG4gICAgICAgIEV2ZW50VXRpbC5jbGVhck9ic2VydmVyKGFwcE9ia2V5KTtcclxuICAgICAgICBFdmVudFV0aWwuY2xlYXJFdmVudFBpcGUocGFnZVRva2VuKTtcclxuICAgICAgICBjb25zdCBvYmpJbmRleCA9IEZybVV0aWwuZ2V0VGFiQXJyYXkoKS5maW5kSW5kZXgoaSA9PiBpLmlkID09PSBwYWdlVG9rZW4gJiYgaS5hcHBUeXBlID09PSBBcHBUeXBlLkFwcCk7XHJcbiAgICAgICAgY29uc3Qgb2JqID0gRnJtVXRpbC5nZXRUYWJBcnJheSgpW29iakluZGV4XTtcclxuXHJcbiAgICAgICAgb3B0aW9ucy50b2tlbiA9IG9wdGlvbnMudG9rZW4gfHwgb2JqLmZvcm1Ub2tlbjtcclxuICAgICAgICBGcm1VdGlsLnJlbW92ZVRhYihvYmpJbmRleCk7XHJcbiAgICAgICAgY29uc3QgZXZlbnRBcmdzOiBGdW5jRXZlbnRBcmdzID0ge1xyXG4gICAgICAgICAgICB0YWJJZDogcGFnZVRva2VuLFxyXG4gICAgICAgICAgICBhcHBUeXBlOiBBcHBUeXBlLkFwcCxcclxuICAgICAgICAgICAgYXBwSWQ6IG9wdGlvbnMudGFiSWQsXHJcbiAgICAgICAgICAgIGFwcEVudHJhbmNlOiBvcHRpb25zLmFwcEVudHJhbmNlXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmdldEZlYigpLnBvc3QoRXZlbnRVdGlsLkZVTkNfQ0xPU0VELCBldmVudEFyZ3MpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLnF1aXRBcHAob3B0aW9ucywgb2JqLnN1KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWFs+mXrWFwcFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgY2xvc2VBcHAoYXBwSWQ6IHN0cmluZywgYXBwRW50cmFuY2U6IHN0cmluZywgdGFiSWQ/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG4gICAgICAgIGNvbnN0IGFwcE9ia2V5ID0gRXZlbnRVdGlsLmFwcE9ic1Rva2VuKGFwcElkLCBhcHBFbnRyYW5jZSwgdGFiSWQpO1xyXG4gICAgICAgIGNvbnN0IHBhZ2VJZCA9IHRoaXMuZ2V0UGFnZUlkKGFwcElkLCBhcHBFbnRyYW5jZSwgdGFiSWQpO1xyXG4gICAgICAgIEV2ZW50VXRpbC5jbGVhck9ic2VydmVyKGFwcE9ia2V5KTtcclxuICAgICAgICBFdmVudFV0aWwuY2xlYXJFdmVudFBpcGUocGFnZUlkKTtcclxuICAgICAgICBjb25zdCBvYmpJbmRleCA9IEZybVV0aWwuZ2V0VGFiQXJyYXkoKS5maW5kSW5kZXgoaSA9PiBpLmlkID09PSBwYWdlSWQgJiYgaS5hcHBUeXBlID09PSBBcHBUeXBlLkFwcCk7XHJcbiAgICAgICAgY29uc3Qgb2JqID0gRnJtVXRpbC5nZXRUYWJBcnJheSgpW29iakluZGV4XTtcclxuICAgICAgICBjb25zdCBmb3JtVG9rZW4gPSBvYmouZm9ybVRva2VuO1xyXG4gICAgICAgIEZybVV0aWwucmVtb3ZlVGFiKG9iakluZGV4KTtcclxuICAgICAgICBjb25zdCBldmVudEFyZ3M6IEZ1bmNFdmVudEFyZ3MgPSB7XHJcbiAgICAgICAgICAgIHRhYklkOiBwYWdlSWQsXHJcbiAgICAgICAgICAgIGFwcFR5cGU6IEFwcFR5cGUuQXBwLFxyXG4gICAgICAgICAgICBhcHBJZCxcclxuICAgICAgICAgICAgYXBwRW50cmFuY2UsXHJcbiAgICAgICAgfTtcclxuICAgICAgICBzZWxmLmdldEZlYigpLnBvc3QoRXZlbnRVdGlsLkZVTkNfQ0xPU0VELCBldmVudEFyZ3MpO1xyXG5cclxuICAgICAgICBjb25zdCBvcHRpb25zOiBBcHBPcHRpb25zID0ge1xyXG4gICAgICAgICAgICB0YWJJZCxcclxuICAgICAgICAgICAgZnVuY0lkOiAnJyxcclxuICAgICAgICAgICAgYXBwSWQsXHJcbiAgICAgICAgICAgIGFwcEVudHJhbmNlLFxyXG4gICAgICAgICAgICBhcHBUeXBlOiBBcHBUeXBlLkFwcCxcclxuICAgICAgICAgICAgdG9rZW46IGZvcm1Ub2tlblxyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucXVpdEFwcChvcHRpb25zLCBvYmouc3UpLnBpcGUoXHJcbiAgICAgICAgICAgIG1hcCh2ID0+IHsgfSlcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0SW52b2tlQW5kRW50ZXJBcHAkKG9wdGlvbnM6IEFwcE9wdGlvbnMpOiBPYnNlcnZhYmxlPElmcmFtZUxpbms+IHtcclxuICAgICAgICBjb25zdCBuZXdQYWdlSWQgPSB0aGlzLm5ld1BhZ2VJZChvcHRpb25zLmFwcElkLCBvcHRpb25zLmFwcEVudHJhbmNlLCBvcHRpb25zLnRhYklkKTtcclxuICAgICAgICBvcHRpb25zLnRhYklkID0gbmV3UGFnZUlkO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldEFwcEludm9rKG9wdGlvbnMuYXBwSWQpLnBpcGUoXHJcbiAgICAgICAgICAgIHN3aXRjaE1hcChcclxuICAgICAgICAgICAgICAgIHZhbHVlID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgaW52b2tFbnRyeSA9IHZhbHVlLmFwcEludm9rcy5maW5kKGludm9rID0+IGludm9rLmFwcEVudHJhbmNlID09PSBvcHRpb25zLmFwcEVudHJhbmNlKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMuYXBwRW50cmFuY2UgJiYgIWludm9rRW50cnkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW52b2tFbnRyeSA9IHZhbHVlLmFwcEludm9rcy5maW5kKGludm9rID0+ICFpbnZvay5hcHBFbnRyYW5jZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghaW52b2tFbnRyeSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuYWxlcnQoYOivt+ajgOafpeW9k+WJjeW6lOeUqChJRDoke29wdGlvbnMuYXBwSWR9KemFjee9rueahOW6lOeUqOWFpeWPoyhhcHBFbnRyYW5jZToke29wdGlvbnMuYXBwRW50cmFuY2V9KeaYr+WQpuWtmOWcqGApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBlbnRpdHlQYXJhbTogYW55O1xyXG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eVBhcmFtID0gaW52b2tFbnRyeS5lbnRpdHlQYXJhbXMgPyBKU09OLnBhcnNlKGludm9rRW50cnkuZW50aXR5UGFyYW1zKSA6IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHlQYXJhbSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzdSA9IHRoaXMuZ2V0U3UodmFsdWUudXJsKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW50ZXJBcHAoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWJJZDogbmV3UGFnZUlkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcHBJZDogb3B0aW9ucy5hcHBJZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXBwRW50cmFuY2U6IG9wdGlvbnMuYXBwRW50cmFuY2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lbnVOYW1lOiBvcHRpb25zLnRhYk5hbWUgfHwgaW52b2tFbnRyeS5uYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICdlbnRlcmFwcCdcclxuICAgICAgICAgICAgICAgICAgICB9LCBzdSkucGlwZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWFwKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW4gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJvdXR1cmwgPSB2YWx1ZS51cmwgKyAob3B0aW9ucy5hcHBFbnRyYW5jZSA/IGAjLyR7b3B0aW9ucy5hcHBFbnRyYW5jZX1gIDogJycpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbmtvYmogPSBuZXcgSWZyYW1lTGluayhcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUuY29kZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5idWlsZFF1ZXJ5U3RyaW5nKHJvdXR1cmwsIG9wdGlvbnMuYXBwSWQsIG9wdGlvbnMuYXBwRW50cmFuY2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnRhYklkLCB0b2tlbiwgb3B0aW9ucy5xdWVyeVN0cmluZ1BhcmFtcyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZOWKoOWFpeWPo+WMuuWIhix0YWJJZOmhteetvuWUr+S4gOagh+ivhlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtvYmouaWQgPSBuZXdQYWdlSWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua29iai5hcHBUeXBlID0gQXBwVHlwZS5BcHA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua29iai5hcHBJZCA9IG9wdGlvbnMuYXBwSWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua29iai5hcHBFbnRyYW5jZSA9IG9wdGlvbnMuYXBwRW50cmFuY2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8g5pi+56S6YXBw5ZCN5a2X5Y+K5YWl5Y+j5ZCN5a2XXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua29iai5GdW5jTmFtZSA9IG9wdGlvbnMudGFiTmFtZSB8fCBpbnZva0VudHJ5Lm5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua29iai51cmwgPSB2YWx1ZS51cmw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua29iai5yZWxvYWQgPSBvcHRpb25zLmlzUmVsb2FkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtvYmouc3UgPSBzdTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rb2JqLmZvcm1Ub2tlbiA9IHRva2VuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHlQYXJhbSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHlQYXJhbS5mb3JFYWNoKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0ubmFtZSA9PT0gJ21vZGUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtvYmoubW9kZSA9IGl0ZW0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtvYmouc3JjICs9IChpdGVtLnZhbHVlID8gYCZhcHBNb2RlPSR7aXRlbS52YWx1ZX0mYCA6ICcnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdldEZlYigpLnBvc3QobmV3UGFnZUlkLCBvcHRpb25zLmVudGl0eVBhcmFtcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxpbmtvYmo7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaE1hcChcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1MaW5rID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pMThuU2V0dGluZy5nZXRTZXR0aW5nJCgpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcChcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgpID0+IGZvcm1MaW5rXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldEludm9rQ29uZmlnKGFwcElkOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCB1cmwgPSBgL2FwaS9ydW50aW1lL3N5cy92MS4wL2dzcGFwcC8ke2FwcElkfWA7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5yZXF1ZXN0KCdHZXQnLCB1cmwsIEZybVV0aWwuc2V0SGVhZGVyKG51bGwsIHt9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDov5vlhaXlupTnlKjvvIzop6blj5Hnm7jlhbPmnI3liqFcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBlbnRlckFwcChlbnRlclBhcmFtOiBGdW5jU3RhdGVQYXJhbSwgc3U6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICAgICAgY29uc3QgYml6Q29udGV4dFVybCA9IHRoaXMuRlVOQ1NUQVRVU19QQVRIICsgKCFzdSA/ICcnIDogYD9zdT0ke3N1fWApO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAucmVxdWVzdCgnUG9zdCcsIGJpekNvbnRleHRVcmwsIEZybVV0aWwuc2V0SGVhZGVyKG51bGwsIHsgYm9keTogZW50ZXJQYXJhbSB9KSkucGlwZShcclxuICAgICAgICAgICAgbWFwKCh2OiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB2LnRva2VuIHx8IHYuc2Vzc2lvbklkO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDpgIDlh7rlupTnlKjvvIzop6blj5Hnm7jlhbPmnI3liqFcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBxdWl0QXBwKG9wdGlvbnM6IEFwcE9wdGlvbnMsIHN1Pzogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgICAgICBjb25zdCBib2R5ID0ge1xyXG4gICAgICAgICAgICB0YWJJZDogb3B0aW9ucy50YWJJZCxcclxuICAgICAgICAgICAgdG9rZW46IG9wdGlvbnMudG9rZW4sXHJcbiAgICAgICAgICAgIGFwcElkOiBvcHRpb25zLmFwcElkLFxyXG4gICAgICAgICAgICBhcHBFbnRyYW5jZTogb3B0aW9ucy5hcHBFbnRyYW5jZSxcclxuICAgICAgICAgICAgYWN0aW9uOiAncXVpdGFwcCdcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBjb25zdCBpbnZva09icyA9IHRoaXMuZ2V0QXBwSW52b2sob3B0aW9ucy5hcHBJZCk7XHJcbiAgICAgICAgY29uc3QgYml6Q29udGV4dFVybCA9IHRoaXMuRlVOQ1NUQVRVU19QQVRIICsgKCFzdSA/ICcnIDogYD9zdT0ke3N1fWApO1xyXG4gICAgICAgIGNvbnN0IGZ1bmNTdGF0ZSQgPSB0aGlzLmh0dHAucmVxdWVzdCgnUG9zdCcsIGJpekNvbnRleHRVcmwsIEZybVV0aWwuc2V0SGVhZGVyKG51bGwsIHsgYm9keSB9KSk7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBkZXByZWNhdGlvblxyXG4gICAgICAgIGNvbnN0ICRyID0gemlwKGludm9rT2JzLCBmdW5jU3RhdGUkLCAocmVzMSwgcmVzMikgPT4gKHsgcmVzMSwgcmVzMiB9KSk7XHJcbiAgICAgICAgcmV0dXJuICRyO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0U3UodXJsOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIGNvbnN0IHVyaUFyciA9IHVybC5zcGxpdCgnLycpO1xyXG4gICAgICAgIHJldHVybiB1cmlBcnIubGVuZ3RoID4gMyA/IHVyaUFyclszXSA6ICcnO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0SW52b2tDYWNoZSgpIHtcclxuICAgICAgICBjb25zdCBhcHBJbnZva2VzQ2FjaGUgPSB0aGlzLmZybVZhcmlhYmxlU2VydmljZS5nZXRGcm1WYXJpYWJsZUJ5S2V5KHRoaXMuQVBQSU5WT0tFX0NBSENFX0tFWSk7XHJcbiAgICAgICAgcmV0dXJuIGFwcEludm9rZXNDYWNoZSBhcyBhbnlbXSB8fCBbXTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlZnJlc2hJbnZva0NhY2hlKGludm9rczogYW55W10sIGZ1bmNJbnZvazogYW55KSB7XHJcbiAgICAgICAgaWYgKCFmdW5jSW52b2spIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpbnZva3MucHVzaChmdW5jSW52b2spO1xyXG4gICAgICAgIHRoaXMuZnJtVmFyaWFibGVTZXJ2aWNlLmZyYW1ld29ya1ZhcmlhYmxlUmVnKHRoaXMuQVBQSU5WT0tFX0NBSENFX0tFWSwgaW52b2tzKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1heC1saW5lLWxlbmd0aFxyXG4gICAgcHJpdmF0ZSBidWlsZFF1ZXJ5U3RyaW5nKHJvdXR1cmw6IHN0cmluZywgYXBwSWQ6IHN0cmluZywgYXBwRW50cmFuY2U6IHN0cmluZywgdGFiSWQ6IHN0cmluZywgdG9rZW46IHN0cmluZywgcGFyYW1zOiBNYXA8c3RyaW5nLCBzdHJpbmc+KTogc3RyaW5nIHtcclxuICAgICAgICBpZiAocm91dHVybC5pbmRleE9mKCc/JykgPCAwKSB7XHJcbiAgICAgICAgICAgIHJvdXR1cmwgKz0gYD9hcHBJZD0ke2FwcElkfSZhcHBFbnRyYW5jZT0ke2FwcEVudHJhbmNlfWA7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcm91dHVybCArPSBgJmFwcElkPSR7YXBwSWR9JmFwcEVudHJhbmNlPSR7YXBwRW50cmFuY2V9YDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJvdXR1cmwgKz0gYCZhcHBUeXBlPSR7QXBwVHlwZS5BcHB9YDtcclxuICAgICAgICByb3V0dXJsICs9IGAmdGFiSWQ9JHt0aGlzLmdldFBhZ2VJZChhcHBJZCwgYXBwRW50cmFuY2UsIHRhYklkKX1gO1xyXG4gICAgICAgIHJvdXR1cmwgKz0gIXRva2VuID8gJycgOiBgJmN2ZnQ9JHt0b2tlbn1gO1xyXG4gICAgICAgIGlmIChwYXJhbXMpIHtcclxuICAgICAgICAgICAgcGFyYW1zLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHtcclxuICAgICAgICAgICAgICAgIHJvdXR1cmwgKz0gIWtleSA/ICcnIDogYCYke2tleX09JHt2YWx1ZX1gO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJvdXR1cmw7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgZ2V0RmViKCk6IEZybUV2ZW50QnVzIHtcclxuICAgICAgICByZXR1cm4gRXZlbnRVdGlsLmdldEZybUV2ZW50KCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBtZXJnZUFwcElkKGFwcElkOiBzdHJpbmcsIGFwcEVudHJhbmNlKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gYCR7YXBwSWR9XyR7YXBwRW50cmFuY2V9YDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPluW9k+WJjeiPnOWNlemhtemdoueahOWUr+S4gOagh+ivhlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGdldFBhZ2VJZChhcHBJZDogc3RyaW5nLCBhcHBFbnRyYW5jZTogc3RyaW5nLCB0YWJJZDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gdGFiSWQgfHwgdGhpcy5tZXJnZUFwcElkKGFwcElkLCBhcHBFbnRyYW5jZSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnlJ/miJDpobXpnaLllK/kuIDmoIfor4ZcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBuZXdQYWdlSWQoYXBwSWQ6IHN0cmluZywgYXBwRW50cmFuY2U6IHN0cmluZywgdGFiSWQ6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRhYklkID8gYCR7dGhpcy5tZXJnZUFwcElkKGFwcElkLCBhcHBFbnRyYW5jZSl9XyR7dGFiSWR9YCA6IHRoaXMubWVyZ2VBcHBJZChhcHBJZCwgYXBwRW50cmFuY2UpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hlY2tpbmdSZXBlYXRPcGVuKG9wdGlvbnM6IEFwcE9wdGlvbnMpOiBJZnJhbWVMaW5rIHtcclxuICAgICAgICBjb25zdCBhcHBJZCA9IG9wdGlvbnMuYXBwSWQ7XHJcbiAgICAgICAgY29uc3QgYXBwRW50cmFuY2UgPSBvcHRpb25zLmFwcEVudHJhbmNlO1xyXG4gICAgICAgIGNvbnN0IHRhYklkID0gb3B0aW9ucy50YWJJZDtcclxuICAgICAgICBjb25zdCBlbnRpdHlQYXJhbXMgPSBvcHRpb25zLmVudGl0eVBhcmFtcztcclxuXHJcbiAgICAgICAgbGV0IGxpbmtvYmo6IElmcmFtZUxpbms7XHJcbiAgICAgICAgY29uc3QgcGFnZUlkID0gdGhpcy5nZXRQYWdlSWQoYXBwSWQsIGFwcEVudHJhbmNlLCB0YWJJZCk7XHJcbiAgICAgICAgbGlua29iaiA9IEZybVV0aWwuZ2V0VGFiQXJyYXkoKS5maW5kKGkgPT4gaS5pZCA9PT0gcGFnZUlkICYmIGkuYXBwVHlwZSA9PT0gQXBwVHlwZS5BcHApO1xyXG4gICAgICAgIGlmIChsaW5rb2JqKSB7XHJcbiAgICAgICAgICAgIGxpbmtvYmouRnVuY05hbWUgPSBvcHRpb25zLnRhYk5hbWUgfHwgbGlua29iai5GdW5jTmFtZTtcclxuICAgICAgICAgICAgbGlua29iai5zcmMgPSB0aGlzLmJ1aWxkUXVlcnlTdHJpbmcobGlua29iai51cmwsIGFwcElkLCBhcHBFbnRyYW5jZSwgb3B0aW9ucy50YWJJZCxcclxuICAgICAgICAgICAgICAgIGxpbmtvYmouc2Vzc2lvbmlkLCBvcHRpb25zLnF1ZXJ5U3RyaW5nUGFyYW1zKTtcclxuICAgICAgICAgICAgbGlua29iai5yZWxvYWQgPSBvcHRpb25zLmlzUmVsb2FkO1xyXG4gICAgICAgICAgICB0aGlzLmdldEZlYigpLnBvc3QocGFnZUlkLCBlbnRpdHlQYXJhbXMpO1xyXG4gICAgICAgICAgICB0aGlzLmdldEZlYigpLnBvc3QoRXZlbnRVdGlsLkZBUlJJU19BUFBfQ0xJQ0ssIGxpbmtvYmopO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbGlua29iajtcclxuICAgIH1cclxuXHJcbn1cclxuIl19