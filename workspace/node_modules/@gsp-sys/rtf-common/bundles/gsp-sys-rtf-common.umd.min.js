!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@ecp-caf/caf-common"),require("rxjs/operators"),require("@angular/router"),require("rxjs"),require("@angular/core"),require("@angular/common")):"function"==typeof define&&define.amd?define("@gsp-sys/rtf-common",["exports","@ecp-caf/caf-common","rxjs/operators","@angular/router","rxjs","@angular/core","@angular/common"],t):t((e["gsp-sys"]=e["gsp-sys"]||{},e["gsp-sys"]["rtf-common"]={}),e.cafCommon,e.rxjs.operators,e.ng.router,e.rxjs,e.ng.core,e.ng.common)}(this,function(e,f,l,t,c,i,n){"use strict";var r=(a.decorators=[{type:i.NgModule,args:[{imports:[n.CommonModule,t.RouterModule],declarations:[],exports:[],providers:[],entryComponents:[]}]}],a);function a(){}var h=(o.prototype.getFrameworkVariable=function(){return this.windowService.getTopWindow()[this.frameworkVariable]},o.prototype.frameworkVariableReg=function(e,t){var n=this.getFrameworkVariable();if(n&&n.name&&n.name===this.frmVariableName)return n[this.nameSpace]=n[this.nameSpace]||{},void(n[this.nameSpace][e]=t);this.frmVariableInitial(),this.getFrameworkVariable()[this.nameSpace][e]=t},o.prototype.getFrmVariableByKey=function(e){var t=this.getFrameworkVariable();return t&&t[this.nameSpace]&&t[this.nameSpace][e]?t[this.nameSpace][e]:null},o.prototype.frmVariableInitial=function(){var e=this.windowService.getTopWindow();e[this.frameworkVariable]=e[this.frameworkVariable]||{},e[this.frameworkVariable].name=this.frmVariableName,e[this.frameworkVariable][this.nameSpace]=e[this.frameworkVariable][this.nameSpace]||{}},o.decorators=[{type:i.Injectable}],o.ctorParameters=function(){return[]},o);function o(){this.frameworkVariable="frameworkVariable",this.nameSpace="variables",this.frmVariableName="rtfFrmVariable",this.windowService=new f.WindowVariableService,this.frmVariableInitial()}var s=(p.prototype.cacheAllFuncs=function(e){this.frmVariableService.frameworkVariableReg(this.allgspfuncs,e)},p.prototype.getAllCachedFuncs=function(){return this.frmVariableService.getFrmVariableByKey(this.allgspfuncs)||[]},p.prototype.getCachedFunc=function(t){var e=this.getAllCachedFuncs();if(e)return e.find(function(e){return e.id===t})},p.prototype.cacheAllFuncInvoks=function(e){this.frmVariableService.frameworkVariableReg(this.allfuncinvoks,e)},p.prototype.getAllCachedFuncInvoks=function(){return this.frmVariableService.getFrmVariableByKey(this.allfuncinvoks)||[]},p.decorators=[{type:i.Injectable}],p.ctorParameters=function(){return[{type:h,decorators:[{type:i.Optional}]}]},p);function p(e){this.frmVariableService=e,this.allgspfuncs="allgspfuncs",this.allfuncinvoks="allfuncinvoks",this.frmVariableService||(this.frmVariableService=new h)}function u(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}var d=(v.prototype.post=function(e){this.eventSubject.next(e)},v.prototype.subscribe=function(t){return this.subscription=this.eventSubject.subscribe(function(e){t(e)}),this},v.prototype.subscribeWithObkey=function(e,t){var n=this.observers.get(e);n&&n.unsubscribe();var r=this.eventSubject.subscribe(function(e){t(e)});return this.observers.set(e,r),this},v.prototype.subscribeOnce=function(t){var n=this,r=this.eventSubject.subscribe(function(e){t(e),r&&r.unsubscribe(),n.parentEventPipeList=new Array});return this},v.prototype.unSubscribe=function(){this.subscription&&(this.subscription.unsubscribe(),this.subscription=null)},v.prototype.unSubscribeForOnce=function(){this.onceSubscription.unsubscribe()},v.prototype.unSubscribeWithObkey=function(e){var t=this.observers.get(e);t&&t.unsubscribe()},v.prototype.matchEmitterToken=function(e){return!this.tokenValue||!e||this.tokenValue===e},v.prototype.examByTargetToken=function(e){return this.tokenValue===e},v.prototype.dispose=function(e){},v.decorators=[{type:i.Injectable}],v.ctorParameters=function(){return[{type:String},{type:Array},{type:c.Subject}]},v);function v(e,t,n){this.tokenValue=e,this.parentEventPipeList=t,this.eventSubject=n||new c.BehaviorSubject(null),this.subscription=new c.Subscription,this.onceSubscription=new c.Subscription,this.observers=new Map,this.parentEventPipeList&&this.parentEventPipeList.push(this)}var g=(b.prototype.post=function(t,e){var n,r,i=this.eventMap.get(t);i||(i=new Array,this.eventMap.set(t,i));var a=i.find(function(e){return e.examByTargetToken(t)});a=a||new d(t,i,null);try{for(var o=u(i),s=o.next();!s.done;s=o.next()){var p=s.value;p.matchEmitterToken(t)&&p.post(e)}}catch(c){n={error:c}}finally{try{s&&!s.done&&(r=o["return"])&&r.call(o)}finally{if(n)throw n.error}}},b.prototype.initialPipe=function(t,e){var n=this.eventMap.get(t);n||(n=new Array,this.eventMap.set(t,n));var r=n.find(function(e){return e.examByTargetToken(t)});r=r||new d(t,n,e)},b.prototype.on=function(e,t){var n=this.getEventPipe(e);if(n)return n.subscribe(t)},b.prototype.onWithObkey=function(e,t,n){var r=this.getEventPipe(e);if(r)return r.subscribeWithObkey(t,n)},b.prototype.once=function(e,t){var n=this.getEventPipe(e);if(n){var r=n.subscribeOnce(t);return this.eventMap["delete"](e),r}},b.prototype.unSubscribe=function(e){var t=this.getEventPipe(e);t&&t.unSubscribe()},b.prototype.getEventPipe=function(t){var e=this.eventMap.get(t);return e?e.find(function(e){return e.examByTargetToken(t)}):null},b.decorators=[{type:i.Injectable}],b.ctorParameters=function(){return[]},b);function b(){this.eventMap=new Map}var y=(Object.defineProperty(m.prototype,"isActive",{get:function(){return this._isActive},set:function(e){(this._isActive=e)?this.animate("fadeIn"):this.el.nativeElement&&this.el.nativeElement.remove()},enumerable:!0,configurable:!0}),m.prototype.ngOnInit=function(){},m.prototype.ngOnDestroy=function(){},m.prototype.ngAfterViewInit=function(){this.setPosition()},m.prototype.close=function(){this.isActive=!1},m.prototype.setPosition=function(){var e=this.loadingContainerEl.nativeElement.clientWidth,t=this.loadingContainerEl.nativeElement.clientHeight;this.render.setStyle(this.loadingContainerEl.nativeElement,"marginTop",-t/2+"px"),this.render.setStyle(this.loadingContainerEl.nativeElement,"marginLeft",-e/2+"px")},m.prototype.animate=function(e){this.render.setAttribute(this.el.nativeElement,"class",e),this.addAnimationEndEvent("webkitAnimationEnd","mozAnimationEnd","MSAnimationEnd","oanimationend","animationend")},m.prototype.addAnimationEndEvent=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=this;e.forEach(function(e){n.el.nativeElement.addEventListener(e,function t(){n.render.removeAttribute(n.el.nativeElement,"class"),n.el.nativeElement.removeEventListener(e,t),n.closed.emit(n.isActive)})})},m.decorators=[{type:i.Component,args:[{selector:"farris-loading",template:'\n        <div #loadingBackdrop class="farris-loading-backdrop" *ngIf="isActive"></div>\n        <div #loadingContainerEl class="farris-loading" *ngIf="isActive">\n            <div class="ng-busy-default-wrapper">\n                <div class="ng-busy-default-sign">\n                    <div class="ng-busy-default-spinner">\n                        <svg class="circular" viewBox="25 25 50 50">\n                            <circle class="path" cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10"></circle>\n                        </svg>\n                    </div>\n                </div>\n            </div>\n        </div>\n    ',styles:["\n        .circular {\n            -webkit-animation: rotate 2s linear infinite;\n            animation: rotate 2s linear infinite;\n            height: 100%;\n            -webkit-transform-origin: center center;\n            transform-origin: center center;\n            width: 100%;\n            position: absolute;\n            top: 0;\n            bottom: 0;\n            left: 0;\n            right: 0;\n            margin: auto;\n        }\n        .circular .path {\n            stroke-dasharray: 1, 200;\n            stroke-dashoffset: 0;\n            -webkit-animation: dash 1.5s ease-in-out infinite, color 6s ease-in-out infinite;\n            animation: dash 1.5s ease-in-out infinite, color 6s ease-in-out infinite;\n            stroke-linecap: round;\n        }\n\n        @-webkit-keyframes rotate {\n            100% {\n            -webkit-transform: rotate(360deg);\n                    transform: rotate(360deg);\n            }\n        }\n        @keyframes rotate {\n            100% {\n            -webkit-transform: rotate(360deg);\n                    transform: rotate(360deg);\n            }\n        }\n        @-webkit-keyframes dash {\n            0% {\n            stroke-dasharray: 1, 200;\n            stroke-dashoffset: 0;\n            }\n            50% {\n            stroke-dasharray: 89, 200;\n            stroke-dashoffset: -35px;\n            }\n            100% {\n            stroke-dasharray: 89, 200;\n            stroke-dashoffset: -124px;\n            }\n        }\n        @keyframes dash {\n            0% {\n            stroke-dasharray: 1, 200;\n            stroke-dashoffset: 0;\n            }\n            50% {\n            stroke-dasharray: 89, 200;\n            stroke-dashoffset: -35px;\n            }\n            100% {\n            stroke-dasharray: 89, 200;\n            stroke-dashoffset: -124px;\n            }\n        }\n        @-webkit-keyframes color {\n            100%,\n            0% {\n            stroke: #48a7ff;\n            }\n            40% {\n            stroke: #48a7ff;\n            }\n            66% {\n            stroke: #48a7ff;\n            }\n            80%,\n            90% {\n            stroke: #48a7ff;\n            }\n        }\n        @keyframes color {\n            100%,\n            0% {\n            stroke: #48a7ff;\n            }\n            40% {\n            stroke: #48a7ff;\n            }\n            66% {\n            stroke: #48a7ff;\n            }\n            80%,\n            90% {\n            stroke: #48a7ff;\n            }\n        }\n        .ng-busy-default-spinner {\n            width: 126px;height: 126px;\n        }\n        .ng-busy-default-sign{\n            background: transparent;\n            box-shadow: none;\n        }\n        .farris-loading-backdrop {\n            background-color: #ffffff;\n            opacity: .0;\n        }\n        "]}]}],m.ctorParameters=function(){return[{type:i.Renderer2},{type:i.ElementRef}]},m.propDecorators={loadingContainerEl:[{type:i.ViewChild,args:["loadingContainerEl"]}],loadingBackdrop:[{type:i.ViewChild,args:["loadingBackdrop"]}],closed:[{type:i.Output}]},m);function m(e,t){this.render=e,this.el=t,this._isActive=!1,this.message="正在加载，请稍候...",this.closed=new i.EventEmitter}var I={container:"body",message:"正在加载中，请稍候...",posion:"center"},S=new i.InjectionToken("loading default options."),k=(F.prototype.show=function(e){var t=this;this.removeDomCheck(),this.config=this.injecotr.get(S)||{},this.config=Object.assign(I,this.config);var n=this.cfr.resolveComponentFactory(y);this.loadingCmpRef=n.create(this.injecotr),e&&(this.config=Object.assign({},this.config,e)),"en"===localStorage.getItem("languageCode")&&(this.config.message="Loading...");var r=this.config.container;return"body"===r?document.querySelector(r).appendChild(this.loadingCmpRef.location.nativeElement):r instanceof i.ElementRef&&r.nativeElement.appendChild(this.loadingCmpRef.location.nativeElement),this.loadingCmpRef.instance.isActive=!0,Object.assign(this.loadingCmpRef.instance,this.config),this.loadingCmpRef.instance.closed.subscribe(function(e){e||t.clearDom(t.loadingCmpRef)}),this.loadingCmpRef.changeDetectorRef.markForCheck(),this.loadingCmpRef.changeDetectorRef.detectChanges(),this.loadingCmpRef.instance},F.prototype.close=function(){this.loadingCmpRef&&this.clearDom(this.loadingCmpRef)},F.prototype.clearDom=function(e){var t=this;try{var n=e.location.nativeElement;n&&n.parentNode&&n.parentNode.removeChild(n),this.config=this.injecotr.get(S),e.destroy(),e=null,setTimeout(function(){t.removeDomCheck()},1500)}catch(r){console.log(r),this.removeDomCheck()}},F.prototype.removeDomCheck=function(){try{var e=document.getElementsByTagName("farris-loading")[0];e&&e.parentNode&&e.parentNode.removeChild(e)}catch(t){console.log(t)}},F.decorators=[{type:i.Injectable}],F.ctorParameters=function(){return[{type:i.ApplicationRef},{type:i.ComponentFactoryResolver},{type:i.Injector}]},F);function F(e,t,n){this.appRef=e,this.cfr=t,this.injecotr=n}var E=function D(e,t,n,r){void 0===n&&(n=""),void 0===r&&(r=!1),this.active=!1,this.code=e,this.src=n,this.active=r,this.sessionid=t},C=(A.setHeader=function(e,t){return t.headers={"Content-Type":"application/json"},e&&(t.headers["X-CAF-Runtime-Context"]=e),t},A.getTabArray=function(){for(var e="iframeTabarray",t=this.getTopWindow(),n=window;(!n[e]||0===n[e].length)&&n!==t;)n=n.parent;return n[e]||[]},A.getTopWindow=function(){var e=window.self;try{for(;e.location.origin===e.parent.location.origin&&e!==e.parent;)e=e.parent}catch(t){}return e},A.removeTab=function(e){this.getTabArray().splice(e,1)},A);function A(){}var w=(O.getFrmEvent=function(){return this.frmVariable.getFrmVariableByKey(this.eventBusKey)},O.setFrmEvent=function(e){this.frmVariable.frameworkVariableReg(this.eventBusKey,e)},O.appObsToken=function(e,t,n){return n||e+"#"+t},O.funcObsToken=function(e,t){return t||e},O.getObserver=function(e){var t,n,r,i=this.getFrmEvent().eventMap.get(e);if(!i)return null;try{for(var a=u(i),o=a.next();!o.done;o=a.next()){var s=o.value;if(s.matchEmitterToken(e)){r=s;break}}}catch(p){t={error:p}}finally{try{o&&!o.done&&(n=a["return"])&&n.call(a)}finally{if(t)throw t.error}}return r?r.observers:null},O.clearObserver=function(e){var t=this.getObserver(this.FUNC_SWITCH),n=t.get(e);n&&(n.unsubscribe(),t["delete"](e));var r=this.getObserver(this.FUNC_CLOSED),i=r.get(e);i&&(i.unsubscribe(),r["delete"](e));var a=this.getObserver(this.BEFORE_FUNC_CLOSE),o=a.get(e);o&&(o.unsubscribe(),a["delete"](e))},O.clearEventPipe=function(t){var e=this.getFrmEvent(),n=e.eventMap.get(t);if(n){var r=n.find(function(e){return e.examByTargetToken(t)});r&&(r.unSubscribe(),e.eventMap["delete"](t))}},O.FARRIS_APPS="all-gsp-farrisapps",O.FARRIS_APP_CLICK="farrisapp-click",O.ALL_GSP_FUNCS="all-gsp-functions",O.BEFORE_FUNC_CLOSE="beforeFuncCloseEvent",O.FUNC_CLOSED="FuncClosed",O.FUNC_SWITCH="funcSwitchEvent",O.AFTER_FRAME_LOAD="after-iframe-load-event",O.eventBusKey="frmEventBus",O.frmVariable=new h,O);function O(){}var T={App:"app",Menu:"menu",Other:"other"},P=(R.prototype.getSetting=function(){var e=this.frmVariable.getFrmVariableByKey(this.variableKey);return this.deepClone(e)},R.prototype.getSetting$=function(){var e=this.frmVariable.getFrmVariableByKey(this.variableKey);return e?c.of(this.deepClone(e)):this.loadSetting$()},R.prototype.loadSetting$=function(){var t=this,e=window.gspframeworkService&&window.gspframeworkService.rtf,n={};if(!e||!e.language)return n.currentLanCode=this.lanService.getLanguageCode(),this.http.get("/api/runtime/sys/v1.0/i18n/languageservice/getalllanguages").pipe(l.map(function(e){return n.languages=e}),l.switchMap(function(){return t.http.get("/api/runtime/sys/v1.0/i18n/i18nusersetting/setting")}),l.map(function(e){return n.i18nSetting=e,t.frmVariable.frameworkVariableReg(t.variableKey,n),n}),l.catchError(function(e){return console.log(e),c.of(null)}));try{var r=e.language;return r.i18nSetting(function(e){n.i18nSetting=e},function(e){console.log(e)}),r.allLanguages(function(e){n.languages=e},function(e){console.log(e)}),n.currentLanCode=r.getLanguageCode(),this.frmVariable.frameworkVariableReg(this.variableKey,n),c.of(n)}catch(i){return console.log(i),c.of(null)}},R.prototype.deepClone=function(e){var t;if("object"==typeof e)if(Array.isArray(e))for(var n in t=[],e)t.push(this.deepClone(e[n]));else if(null===e)t=null;else if(e.constructor===RegExp)t=e;else for(var n in t={},e)t[n]=this.deepClone(e[n]);else t=e;return t},R.decorators=[{type:i.Injectable}],R.ctorParameters=function(){return[{type:h},{type:f.LanguageService},{type:f.HttpService}]},R);function R(e,t,n){this.frmVariable=e,this.lanService=t,this.http=n,this.variableKey="frm-i18nSetting"}var _=(N.prototype.openApp=function(e,t,n,r){var i={funcId:"",appId:e,appEntrance:t,appType:T.App,entityParams:n,queryStringParams:n,isReload:r};this.openAppByOptions(i)},N.prototype.openAppByOptions=function(e){var t=this;this.checkingRepeatOpen(e)||this.getInvokeAndEnterApp$(e).subscribe(function(e){t.getFeb().post(w.FARRIS_APP_CLICK,e)})},N.prototype.openAppByOptions$=function(e){var t=this;return this.checkingRepeatOpen(e)?c.of(!0):this.getInvokeAndEnterApp$(e).pipe(l.map(function(e){return t.getFeb().post(w.FARRIS_APP_CLICK,e),!0}))},N.prototype.getAppInvok=function(t){var n=this,r=this.getInvokCache(),e=r.find(function(e){return e.id===t});return e?c.of(e):this.getInvokConfig(t).pipe(l.map(function(e){return e?(n.refreshInvokCache(r,e),e):null}))},N.prototype.beforeCloseAppByOptions=function(e){var t=w.appObsToken(e.appId,e.appEntrance,e.tabId);if(w.getObserver(w.BEFORE_FUNC_CLOSE).get(t)){var n={tabId:this.getPageId(e.appId,e.appEntrance,e.tabId),appType:T.App,appId:e.appId,appEntrance:e.appEntrance};this.getFeb().post(w.BEFORE_FUNC_CLOSE,n)}else this.closeAppByOptions(e).subscribe()},N.prototype.beforeCloseApp=function(e,t,n){var r=w.appObsToken(e,t,n);if(w.getObserver(w.BEFORE_FUNC_CLOSE).get(r)){var i={tabId:this.getPageId(e,t,n),appType:T.App,appId:e,appEntrance:t};this.getFeb().post(w.BEFORE_FUNC_CLOSE,i)}else this.closeApp(e,t,n).subscribe()},N.prototype.closeAppByOptions=function(e){var t=w.appObsToken(e.appId,e.appEntrance,e.tabId),n=this.getPageId(e.appId,e.appEntrance,e.tabId);w.clearObserver(t),w.clearEventPipe(n);var r=C.getTabArray().findIndex(function(e){return e.id===n&&e.appType===T.App}),i=C.getTabArray()[r];e.token=e.token||i.formToken,C.removeTab(r);var a={tabId:n,appType:T.App,appId:e.tabId,appEntrance:e.appEntrance};return this.getFeb().post(w.FUNC_CLOSED,a),this.quitApp(e,i.su)},N.prototype.closeApp=function(e,t,n){var r=w.appObsToken(e,t,n),i=this.getPageId(e,t,n);w.clearObserver(r),w.clearEventPipe(i);var a=C.getTabArray().findIndex(function(e){return e.id===i&&e.appType===T.App}),o=C.getTabArray()[a],s=o.formToken;C.removeTab(a);var p={tabId:i,appType:T.App,appId:e,appEntrance:t};this.getFeb().post(w.FUNC_CLOSED,p);var c={tabId:n,funcId:"",appId:e,appEntrance:t,appType:T.App,token:s};return this.quitApp(c,o.su).pipe(l.map(function(e){}))},N.prototype.getInvokeAndEnterApp$=function(s){var p=this,c=this.newPageId(s.appId,s.appEntrance,s.tabId);return s.tabId=c,this.getAppInvok(s.appId).pipe(l.switchMap(function(r){var i=r.appInvoks.find(function(e){return e.appEntrance===s.appEntrance});if(s.appEntrance||i||(i=r.appInvoks.find(function(e){return!e.appEntrance})),i){var a;try{a=i.entityParams?JSON.parse(i.entityParams):null}catch(e){a=null,console.log(e)}var o=p.getSu(r.url);return p.enterApp({tabId:c,appId:s.appId,appEntrance:s.appEntrance,menuName:s.tabName||i.name,action:"enterapp"},o).pipe(l.map(function(e){var t=r.url+(s.appEntrance?"#/"+s.appEntrance:""),n=new E(r.code,null,p.buildQueryString(t,s.appId,s.appEntrance,s.tabId,e,s.queryStringParams));return n.id=c,n.appType=T.App,n.appId=s.appId,n.appEntrance=s.appEntrance,n.FuncName=s.tabName||i.name,n.url=r.url,n.reload=s.isReload,n.su=o,n.formToken=e,a&&a.forEach(function(e){"mode"===e.name&&(n.mode=e.value,n.src+=e.value?"&appMode="+e.value+"&":"")}),p.getFeb().post(c,s.entityParams),n}),l.switchMap(function(e){return p.i18nSetting.getSetting$().pipe(l.map(function(){return e}))}))}window.alert("请检查当前应用(ID:"+s.appId+")配置的应用入口(appEntrance:"+s.appEntrance+")是否存在")}))},N.prototype.getInvokConfig=function(e){var t="/api/runtime/sys/v1.0/gspapp/"+e;return this.http.request("Get",t,C.setHeader(null,{}))},N.prototype.enterApp=function(e,t){var n=this.FUNCSTATUS_PATH+(t?"?su="+t:"");return this.http.request("Post",n,C.setHeader(null,{body:e})).pipe(l.map(function(e){return e.token||e.sessionId}))},N.prototype.quitApp=function(e,t){var n={tabId:e.tabId,token:e.token,appId:e.appId,appEntrance:e.appEntrance,action:"quitapp"},r=this.getAppInvok(e.appId),i=this.FUNCSTATUS_PATH+(t?"?su="+t:""),a=this.http.request("Post",i,C.setHeader(null,{body:n}));return c.zip(r,a,function(e,t){return{res1:e,res2:t}})},N.prototype.getSu=function(e){var t=e.split("/");return 3<t.length?t[3]:""},N.prototype.getInvokCache=function(){return this.frmVariableService.getFrmVariableByKey(this.APPINVOKE_CAHCE_KEY)||[]},N.prototype.refreshInvokCache=function(e,t){t&&(e.push(t),this.frmVariableService.frameworkVariableReg(this.APPINVOKE_CAHCE_KEY,e))},N.prototype.buildQueryString=function(n,e,t,r,i,a){return n.indexOf("?")<0?n+="?appId="+e+"&appEntrance="+t:n+="&appId="+e+"&appEntrance="+t,n+="&appType="+T.App,n+="&tabId="+this.getPageId(e,t,r),n+=i?"&cvft="+i:"",a&&a.forEach(function(e,t){n+=t?"&"+t+"="+e:""}),n},N.prototype.getFeb=function(){return w.getFrmEvent()},N.prototype.mergeAppId=function(e,t){return e+"_"+t},N.prototype.getPageId=function(e,t,n){return n||this.mergeAppId(e,t)},N.prototype.newPageId=function(e,t,n){return n?this.mergeAppId(e,t)+"_"+n:this.mergeAppId(e,t)},N.prototype.checkingRepeatOpen=function(e){var t,n=e.appId,r=e.appEntrance,i=e.tabId,a=e.entityParams,o=this.getPageId(n,r,i);return(t=C.getTabArray().find(function(e){return e.id===o&&e.appType===T.App}))&&(t.FuncName=e.tabName||t.FuncName,t.src=this.buildQueryString(t.url,n,r,e.tabId,t.sessionid,e.queryStringParams),t.reload=e.isReload,this.getFeb().post(o,a),this.getFeb().post(w.FARRIS_APP_CLICK,t)),t},N.decorators=[{type:i.Injectable}],N.ctorParameters=function(){return[{type:f.HttpService},{type:f.SessionService},{type:P,decorators:[{type:i.Optional}]}]},N);function N(e,t,n){if(this.http=e,this.sessionSvc=t,this.i18nSetting=n,this.FUNCSTATUS_PATH="/api/runtime/sys/v1.0/function-states",this.APPINVOKE_CAHCE_KEY="allappinvoks",this.frmVariableService=new h,!this.i18nSetting){var r=new h,i=new f.LanguageService(null);this.i18nSetting=new P(r,i,e)}}var j=(M.prototype.openFunc=function(e,t,n,r,i){void 0===r&&(r=!0),void 0===i&&(i="");var a={appType:T.Menu,funcId:e,appId:"",appEntrance:""};return this.internalOpen(a),c.of(!0)},M.prototype.openMenu=function(e){switch(e.appType&&e.appType.toLowerCase()){case T.App:if(!e.appId)return void window.alert("参数appId不能为空！");this.appService.openAppByOptions(e);break;case T.Menu:this.internalOpen(e)}},M.prototype.openMenu$=function(e){switch(e.appType&&e.appType.toLowerCase()){case T.App:return e.appId?this.appService.openAppByOptions$(e):void window.alert("参数appId不能为空！");case T.Menu:return!0===e.onlyGetIframeLink?this.internalOpenByIframeLink$(e):this.internalOpen$(e)}},M.prototype.openConnectedFunc=function(e,t){var n={appType:T.Menu,funcId:e,appId:"",appEntrance:"",entityParams:t.EntityParam};this.internalOpen(n)},M.prototype.openFuncWithParam=function(e,t,n){var r={appType:T.Menu,funcId:e,appId:"",appEntrance:"",entityParams:t,queryStringParams:t,isReload:n};this.internalOpen(r)},M.prototype.internalOpen=function(n){var r=this;this.checkingBeforeOpen$(n).subscribe(function(e){if(e&&e.func&&!e.linkobj){var t=e.func;r.getInvokeAndEnterFunc$(n,t).subscribe(function(e){return r.getFeb().post(w.FARRIS_APP_CLICK,e)},function(e){var t={isErr:!0,errInfo:e};r.getFeb().post(w.FARRIS_APP_CLICK,t)})}})},M.prototype.internalOpen$=function(n){var r=this;return this.checkingBeforeOpen$(n).pipe(l.switchMap(function(e){if(!e||!e.func||e.linkobj)return c.of(null);var t=e.func;return r.getInvokeAndEnterFunc$(n,t).pipe(l.map(function(e){return r.getFeb().post(w.FARRIS_APP_CLICK,e),!0}))}))},M.prototype.internalOpenByIframeLink$=function(t){var n=this;return t.funcId?this.getFuncEntity(t.funcId).pipe(l.switchMap(function(e){return e?n.getInvokeAndEnterFunc$(t,e):(window.alert("请确认您是否具备打开菜单(ID:"+t.funcId+")的权限"),null)})):(window.alert("参数funcId不能为空！"),c.of(null))},M.prototype.getInvokeAndEnterFunc$=function(o,s){var p,c=this,u=this.newPageId(o.funcId,o.tabId);return o.tabId=u,this.getFuncInvok(o.funcId).pipe(l.switchMap(function(t){var n=t.invokingConfig.url,e=t.invokingConfig.staticParams,r=t.invokingConfig.entityParams,i=e?JSON.parse(e):"",a=(r&&JSON.parse(r),c.getSu(n));return c.enterFunc({tabId:u,funcId:o.funcId,menuName:o.tabName||s.name,action:"enter"},a).pipe(l.map(function(e){return(p=new E(s.code,null,c.buildQueryStringByMap(n,o.funcId,o.tabId,e,o.queryStringParams))).id=u,p.appType=T.Menu,p.funcId=o.funcId,p.FuncName=o.tabName||s.name,p.url=t.invokingConfig.url,p.reload=o.isReload,p.su=a,p.isNewTab=o.isNewTab,p.formToken=e,i&&i.forEach(function(e){"jquery"===e.name&&(p.isjquery=!0),"mode"===e.name&&(p.mode=e.value,p.src+=e.value?"&appMode="+e.value+"&":"")}),c.getFeb().post(u,o.entityParams),p}),l.switchMap(function(e){return c.i18nSetting.getSetting$().pipe(l.map(function(){return e}))}))}))},M.prototype.checkingBeforeOpen$=function(a){var o=this;return a.funcId?this.getFuncEntity(a.funcId).pipe(l.map(function(e){if(!e)return window.alert("请确认您是否具备打开菜单(ID:"+a.funcId+")的权限"),null;var t=a.funcId,n=a.tabId,r=o.getPageId(t,n),i=C.getTabArray().find(function(e){return e.id===r&&e.appType===T.Menu});return i&&(i.FuncName=a.tabName||i.FuncName,i.src=o.buildQueryStringByMap(i.url,t,a.tabId,"",a.queryStringParams),i.reload=a.isReload,o.getFeb().post(r,a.entityParams),o.getFeb().post(w.FARRIS_APP_CLICK,i)),{func:e,linkobj:i}})):(window.alert("参数funcId不能为空！"),c.of(null))},M.prototype.beforeCloseMenu=function(e){switch(e.appType&&e.appType.toLowerCase()){case T.App:this.appService.beforeCloseAppByOptions(e);break;case T.Menu:this.beforeCloseFuncByOptions(e)}},M.prototype.beforeCloseFuncByOptions=function(e){var t=this.funcService.getCachedFunc(e.funcId),n=w.funcObsToken(e.funcId,e.tabId),r=this.getPageId(e.funcId,e.tabId);if(w.getObserver(w.BEFORE_FUNC_CLOSE).get(n)){var i={tabId:r,appType:T.Menu,funcId:e.funcId,tabName:t&&t.Name,beforeCloseHandle:e.beforeCloseHandle};this.getFeb().post(w.BEFORE_FUNC_CLOSE,i)}else this.closeFuncByOptions(e)},M.prototype.beforeCloseFunc=function(e,t){var n=this.funcService.getCachedFunc(e),r=w.funcObsToken(e,t);if(w.getObserver(w.BEFORE_FUNC_CLOSE).get(r)){var i={tabId:this.getPageId(e,t),appType:T.Menu,funcId:e,tabName:n&&n.Name};this.getFeb().post(w.BEFORE_FUNC_CLOSE,i)}else this.closeFunc(e,t)},M.prototype.closeMenu=function(e){switch(e.appType&&e.appType.toLowerCase()){case T.App:this.appService.closeAppByOptions(e).subscribe();break;case T.Menu:this.closeFuncByOptions(e)}},M.prototype.closeFuncByOptions=function(e){var t=this.getPageId(e.funcId,e.tabId);w.clearObserver(w.funcObsToken(e.funcId,e.tabId)),w.clearEventPipe(t);var n=this.funcService.getCachedFunc(e.funcId),r=C.getTabArray().findIndex(function(e){return e.id===t&&e.appType===T.Menu}),i=C.getTabArray()[r];e.token=e.token||i.formToken;var a=e.su;if(i){a=i.su,C.removeTab(r);var o={tabId:t,appType:T.Menu,funcId:e.funcId,tabName:n&&n.name};this.getFeb().post(w.FUNC_CLOSED,o)}this.quitFunc(e,a).subscribe(function(){})},M.prototype.closeFunc=function(e,t){var n=this.getPageId(e,t);w.clearObserver(w.funcObsToken(e,t)),w.clearEventPipe(n);var r=this.funcService.getCachedFunc(e),i=C.getTabArray().findIndex(function(e){return e.id===n&&e.appType===T.Menu}),a=C.getTabArray()[i],o=a.formToken;if(a){C.removeTab(i);var s={tabId:n,appType:T.Menu,funcId:e,tabName:r&&r.name};this.getFeb().post(w.FUNC_CLOSED,s)}var p={tabId:t,funcId:e,appId:"",appEntrance:"",appType:T.Menu,token:o};return this.quitFunc(p,a.su).subscribe(function(){}),c.of(!0)},M.prototype.getFuncInvok=function(t){var n=this,r=this.getInvokCache(),e=r.find(function(e){return e.id===t});return e?c.of(e):this.getInvokConfig(t).pipe(l.map(function(e){return e?(r.push(e),n.funcService.cacheAllFuncInvoks(r),e):null}))},M.prototype.getFuncEntity=function(e){var n=this,t=this.funcService.getCachedFunc(e);if(t)return c.of(t);var r="/api/runtime/sys/v1.0/functions/"+e;return this.http.request("Get",r,C.setHeader(null,{})).pipe(l.map(function(e){if(!e||!e[0])return null;var t=n.funcService.getAllCachedFuncs();return t.push(e[0]),n.funcService.cacheAllFuncs(t),e[0]}))},M.prototype.getPresetParams=function(e){var a=this;return this.getFuncInvok(e).pipe(l.map(function(e){var t=e.invokingConfig.staticParams,n=e.invokingConfig.entityParams,r=t?JSON.parse(t):[],i=n?JSON.parse(n):[];return a.mergeParams(r,i)}))},M.prototype.getStaticParam=function(e){return this.getFuncInvok(e).pipe(l.map(function(e){if(e.invokingConfig.staticParams)return JSON.parse(e.invokingConfig.staticParams)}))},M.prototype.getEntityParam=function(e,t,n){void 0===n&&(n=!0),n&&this.getFeb().once(e,t),this.getFeb().on(e,t)},M.prototype.entityParamUnsub=function(e){this.getFeb().unSubscribe(e)},M.prototype.getEntityParamStructure=function(e){return this.getFuncInvok(e).pipe(l.map(function(e){if(e.invokingConfig.entityParams)return JSON.parse(e.invokingConfig.entityParams)}))},M.prototype.mergeParams=function(e,t){var n=new Map;return t&&t.forEach(function(e){n.set(e.name,e.value)}),e&&e.forEach(function(e){n.set(e.name,e.value)}),n},M.prototype.getInvokConfig=function(e){var t="/api/runtime/sys/v1.0/functions/funcInvok/"+e;return this.http.request("Get",t,C.setHeader(null,{}))},M.prototype.getInvokCache=function(){return this.funcService.getAllCachedFuncInvoks()},M.prototype.getFeb=function(){return w.getFrmEvent()},M.prototype.buildFuncSession=function(n,e){var r=this,t=this.sessionSvc.getUserSessionId(),i={token:t,funcId:n,action:"enter"},a=this.FUNCSTATUS_PATH+(e?"?su="+e:"");return this.http.request("Post",a,C.setHeader(t,{body:i})).pipe(l.map(function(e){var t=e.sessionId;return t!==undefined&&null!==t&&0<t.length&&r.sessionSvc.setFuncSessionId(n,t),t}))},M.prototype.enterFunc=function(e,t){var n=this.FUNCSTATUS_PATH+(t?"?su="+t:"");return this.http.request("Post",n,C.setHeader(null,{body:e})).pipe(l.map(function(e){return e.token||e.sessionId}))},M.prototype.quitFunc=function(e,t){var n={token:e.token,tabId:e.tabId,funcId:e.funcId,action:"quit"},r=this.FUNCSTATUS_PATH+(t?"?su="+t:"");return this.http.request("Post",r,C.setHeader(null,{body:n}))},M.prototype.getSu=function(e){var t=e.split("/");return 3<t.length?t[3]:""},M.prototype.buildQueryString=function(n,e,r){return n.indexOf("?")<0?n+="?funcId="+e:n+="&funcId="+e,r&&Object.keys(r).forEach(function(e,t){n+=(0===t?"":"&")+e+"="+r[e]}),n},M.prototype.buildQueryStringByMap=function(n,e,t,r,i){return n.indexOf("?")<0?n+="?funcId="+e:n+="&funcId="+e,n+="&appType="+T.Menu,n+="&tabId="+this.getPageId(e,t),n+=r?"&cvft="+r:"",i&&i.forEach(function(e,t){n+=t?"&"+t+"="+e:""}),n},M.prototype.getPageId=function(e,t){return t||e},M.prototype.newPageId=function(e,t){return t?e+"_"+t:e},M.prototype.eventFire=function(e,t){var n=w.getFrmEvent();n&&"function"==typeof n.post&&n.post(e,t)},M.prototype.eventListner=function(e,t,n){var r=w.getFrmEvent();if(r&&"function"==typeof r.on){if(n&&n.appType)switch(n.appType.toLowerCase()){case T.App:var i=w.appObsToken(n.appId,n.appEntrance,n.tabId);return void r.onWithObkey(e,i,t);case T.Menu:var a=w.funcObsToken(n.funcId,n.tabId);return void r.onWithObkey(e,a,t)}r.on(e,t)}},M.prototype.eventListner4Func=function(e,t,n){var r=w.getFrmEvent();r&&"function"==typeof r.on&&r.onWithObkey(e,t,n)},M.prototype.eventListner4App=function(e,t,n,r){var i=w.getFrmEvent();if(i&&"function"==typeof i.on){var a=w.appObsToken(t,n);i.onWithObkey(e,a,r)}},M.decorators=[{type:i.Injectable}],M.ctorParameters=function(){return[{type:f.HttpService},{type:t.Router},{type:f.CacheService},{type:f.SessionService},{type:g},{type:s},{type:k},{type:_,decorators:[{type:i.Optional}]},{type:P,decorators:[{type:i.Optional}]}]},M);function M(e,t,n,r,i,a,o,s,p){if(this.http=e,this.router=t,this.cache=n,this.sessionSvc=r,this.feb=i,this.funcService=a,this.loadService=o,this.appService=s,this.i18nSetting=p,this.FUNCSTATUS_PATH="/api/runtime/sys/v1.0/function-states",this.BeforeFuncClose=w.BEFORE_FUNC_CLOSE,this.FuncClosed=w.FUNC_CLOSED,this.FuncSwitch=w.FUNC_SWITCH,!this.i18nSetting){var c=new h,u=new f.LanguageService(null);this.i18nSetting=new P(c,u,e)}this.appService||(this.appService=new _(this.http,this.sessionSvc,this.i18nSetting))}var V=(L.prototype.eventFire=function(e,t){var n=w.getFrmEvent();n&&"function"==typeof n.post&&n.post(e,t)},L.prototype.eventListner=function(e,t,n){var r=w.getFrmEvent();if(r&&"function"==typeof r.on){if(n&&n.appType)switch(n.appType.toLowerCase()){case T.App:var i=w.appObsToken(n.appId,n.appEntrance,n.tabId);return void r.onWithObkey(e,i,t);case T.Menu:var a=w.funcObsToken(n.funcId,n.tabId);return void r.onWithObkey(e,a,t)}r.on(e,t)}},L.prototype.eventInitial=function(){var e=w.getFrmEvent();e&&"function"==typeof e.post&&(e.post(this.FarrisApps,null),e.post(this.FarrisAppClick,null),e.post(this.AllGspFuncs,null),e.initialPipe(this.FuncClosed,new c.Subject),e.initialPipe(this.FuncSwitch,new c.Subject),e.initialPipe(this.BeforeFuncClose,new c.Subject),e.initialPipe(this.AfterFrameLoad,new c.Subject))},L.decorators=[{type:i.Injectable}],L.ctorParameters=function(){return[{type:g}]},L);function L(e){this.feb=e,this.FarrisApps=w.FARRIS_APPS,this.FarrisAppClick=w.FARRIS_APP_CLICK,this.AllGspFuncs=w.ALL_GSP_FUNCS,this.BeforeFuncClose=w.BEFORE_FUNC_CLOSE,this.FuncClosed=w.FUNC_CLOSED,this.FuncSwitch=w.FUNC_SWITCH,this.AfterFrameLoad=w.AFTER_FRAME_LOAD,w.getFrmEvent()||(w.setFrmEvent(this.feb||new g),this.eventInitial())}var B=(U.prototype.subjectRegister=function(e,t,n){var r;n=n||new c.Subject,r=t&&t.funcId?t.funcId:t&&t.appId&&t.appEntrance?t.appId+"-"+t.appEntrance:this.createToken();var i=new d(r,null,n);return i.pipeCode=e,this.subjectMaps.set(r,i),this.frmVariableService.frameworkVariableReg(this.frmSubject,this.subjectMaps),r},U.prototype.customSubjectRegister=function(e,t){var n,r=new Map;t=t||new c.Subject,n=e&&e.customToken?e.customToken:e&&e.funcId?e.funcId:e&&e.appId&&e.appEntrance?e.appId+"-"+e.appEntrance:this.createToken();var i=new d(n,null,t);return r.set(n,i),r},U.prototype.subjectRemove=function(e){this.subjectMaps["delete"](e),this.frmVariableService.frameworkVariableReg(this.frmSubject,this.subjectMaps)},U.prototype.notify=function(e,t){var n=this.getSubject(e);n&&n.post(t)},U.prototype.response=function(e,t,n){var r=this.getSubject(e);r&&r.subscribeWithObkey(t,n)},U.prototype.responseUnSubscribe=function(e,t){var n=this.getSubject(e);n&&n.unSubscribeWithObkey(t)},U.prototype.getSubject=function(e){return this.subjectMaps.get(e)},U.prototype.createToken=function(){var e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},U.decorators=[{type:i.Injectable,args:[{providedIn:"root"}]}],U.ctorParameters=function(){return[]},U.ngInjectableDef=i.defineInjectable({factory:function(){return new U},token:U,providedIn:"root"}),U);function U(){this.frmSubject="frmBroadcast-subjects",this.frmVariableService=new h,this.subjectMaps=this.frmVariableService.getFrmVariableByKey(this.frmSubject)||new Map}var x=(q.prototype.resolve=function(e,t){var n=this;return e.paramMap.get("funcid"),this.editvalue=null,this.feb.on("frmopenfunc",function(e){n.editvalue=e}),c.of(this.editvalue)},q.decorators=[{type:i.Injectable}],q.ctorParameters=function(){return[{type:t.Router},{type:g}]},q);function q(e,t){this.router=e,this.feb=t}var K=(H.forRoot=function(e){return{ngModule:H,providers:[{provide:S,useValue:e||I},k]}},H.decorators=[{type:i.NgModule,args:[{imports:[n.CommonModule],declarations:[y],entryComponents:[y]}]}],H);function H(){}e.CommonSharedModule=r,e.FuncsService=s,e.FrameworkService=j,e.AppService=_,e.FrameworkEventService=V,e.FrameworkVariableService=h,e.BroadcastingStationService=B,e.FrmI18nSettingService=P,e.FunctionResolver=x,e.EventBusPipe=d,e.FrmEventBus=g,e.LoadingModule=K,e.LoadingService=k,e.AppType=T,e.IframeLink=E,e.ɵa=y,e.ɵc=S,e.ɵb=I,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=gsp-sys-rtf-common.umd.min.js.map