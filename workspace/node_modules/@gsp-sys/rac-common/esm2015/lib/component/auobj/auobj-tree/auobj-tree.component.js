/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, Input, Output, EventEmitter, ViewChild, TemplateRef } from '@angular/core';
import { TranslateService } from '@ngx-translate/core';
import { TreeTableComponent } from '@farris/ui-treetable';
import { AuthObjService } from '../../../common/service/authobj.service';
import { RacCommonUtil } from '../../../common/util/rac-util';
export class AuobjTreeComponent {
    /**
     * @param {?} service
     * @param {?} racUtil
     * @param {?} translate
     */
    constructor(service, racUtil, translate) {
        this.service = service;
        this.racUtil = racUtil;
        this.translate = translate;
        this.data = [];
        this.selectedKey = '';
        this.selectedKeyOld = '';
        // 树所需参数
        this.cols = [];
        this.selectedchanged = new EventEmitter();
        /**
         * 帮助输出事件
         */
        this.selectedAfterOk = new EventEmitter();
        this.closeModalEmitter = new EventEmitter();
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.cols = [
            // { field: 'name', title: this.translate.instant('lblAuthObj') }
            { field: 'name', title: '名称' }
        ];
    }
    /**
     * 根据分配的功能操作初始对应的权限对象
     * @return {?}
     */
    initData() {
        /** @type {?} */
        let obs = this.service.getAll();
        if (this.dataMode === 'reassign') {
            obs = this.service.getAllReAssign();
        }
        else {
            obs = this.service.getAll();
        }
        obs.subscribe((/**
         * @param {?} result
         * @return {?}
         */
        (result) => {
            this.data = result;
            if (this.data) {
                /** @type {?} */
                const initNodeList = [];
                /** @type {?} */
                const layer1 = this.racUtil.findLayer1ByParentId(this.data, 'id', 'parentId');
                layer1.forEach((/**
                 * @param {?} item
                 * @return {?}
                 */
                item => {
                    /** @type {?} */
                    const node = this.convertToTreeNode(item);
                    initNodeList.push(node);
                    this.initTreeNodeList(node);
                }));
                this.treeNodeData = initNodeList;
                this.racUtil.setTreeIcon(this.farrisTt);
            }
        }));
    }
    /**
     * 构造Farris-Tree所需结构
     * @private
     * @param {?} parentNode
     * @return {?}
     */
    initTreeNodeList(parentNode) {
        // 根据父节点过滤子节点
        /** @type {?} */
        const children = this.data.filter((/**
         * @param {?} x
         * @return {?}
         */
        x => x.parentId === parentNode.data.id));
        // 将过滤的数据加到TreeNodes中
        if (children && children.length > 0) {
            children.forEach((/**
             * @param {?} item
             * @return {?}
             */
            item => {
                /** @type {?} */
                const child = this.convertToTreeNode(item);
                parentNode.leaf = false;
                parentNode.children.push(child);
                this.initTreeNodeList(child);
            }));
        }
    }
    /**
     * 将权限字段实体转换为Farris-TreeNode
     * @private
     * @param {?} obj
     * @return {?}
     */
    convertToTreeNode(obj) {
        /** @type {?} */
        const node = { data: obj, leaf: true, children: [], icon: this.racUtil.leafIcon };
        // 是否明细节点，type为0 说明是导航
        if (this.racUtil.isNav(obj.type.toString())) {
            // tslint:disable-next-line:no-string-literal
            node['leaf'] = false;
            // tslint:disable-next-line:no-string-literal
            node['children'] = [];
            node['expandedIcon'] = this.racUtil.expandIcon; // 'folder-open';
            node['collapseIcon'] = this.racUtil.collapseIcon; // 'folder';
        }
        return node;
    }
    /**
     * @param {?} newObj
     * @return {?}
     */
    appendNode(newObj) {
        /** @type {?} */
        const parentRowNode = this.farrisTt.findRowNode(newObj.parentId);
        // const newTreeNode = this.convertToTreeNode(newObj);
        /** @type {?} */
        const selectedRow = this.farrisTt.selectedRow;
        if (this.racUtil.isNav(selectedRow.data.type)) {
            this.farrisTt.append(newObj, this.farrisTt.selectedRow);
        }
        else {
            this.farrisTt.append(newObj, this.farrisTt.selectedRow.parent);
        }
        this.farrisTt.selectNode(newObj.id);
    }
    /**
     * @param {?} newObj
     * @return {?}
     */
    removeNode(newObj) {
        this.farrisTt.remove(newObj.id);
    }
    /**
     * @param {?} newObj
     * @return {?}
     */
    updateNode(newObj) {
        // TODO update时data 参数有问题
        // this.farrisTt.update(newObj.id, newObj);
    }
    /**
     * 选中行改变后触发事件
     * @param {?} args
     * @return {?}
     */
    handleSelection(args) {
        this.selectedKey = args.node.data.id;
        this.selectedModel = args.node.data;
        // 首次触发
        if (this.selectedKeyOld === '') {
            this.selectedKeyOld = this.selectedKey;
            this.selectedchanged.emit(this.selectedModel);
        }
        else {
            // 变化的情况下触发
            if (this.selectedKeyOld !== this.selectedKey) {
                this.selectedKeyOld = this.selectedKey;
                this.selectedchanged.emit(this.selectedModel);
            }
        }
    }
    /**
     * @param {?} __0
     * @return {?}
     */
    iconClass({ id }) {
        return {
            'k-i-folder': true,
            'k-icon': true
        };
    }
    /**
     * 帮助确定按钮
     * @return {?}
     */
    confirm() {
        this.selectedKeyOld = this.selectedKey;
        this.selectedAfterOk.emit(this.selectedModel);
    }
    /**
     * @return {?}
     */
    cancle() {
        this.closeModalEmitter.next();
    }
}
AuobjTreeComponent.decorators = [
    { type: Component, args: [{
                selector: 'rac-auobj-tree',
                template: "<farris-treetable class =\"f-utils-fill-flex-column\"  #farrisTt  \r\n[data]=\"treeNodeData\"\r\n[columns]=\"cols\"\r\n[idField]=\"'id'\" \r\n[fixedHeader]=\"true\"\r\n[fit]=\"true\"\r\n[showIcon]=\"true\"\r\n(nodeSelected)=\"handleSelection($event)\">\r\n</farris-treetable>\r\n\r\n<ng-template #btnOkAndCancle >\r\n    <button class=\"btn btn-sm btn-primary\" (click)=\"confirm()\">\u786E\u8BA4</button>\r\n    <button class=\"btn btn-sm btn-default\" (click)=\"cancle()\">\u53D6\u6D88</button>\r\n  </ng-template>\r\n\r\n",
                styles: [""]
            }] }
];
/** @nocollapse */
AuobjTreeComponent.ctorParameters = () => [
    { type: AuthObjService },
    { type: RacCommonUtil },
    { type: TranslateService }
];
AuobjTreeComponent.propDecorators = {
    dataMode: [{ type: Input }],
    initSelectedKeys: [{ type: Input }],
    farrisTt: [{ type: ViewChild, args: ['farrisTt',] }],
    selectedchanged: [{ type: Output }],
    selectedAfterOk: [{ type: Output }],
    closeModalEmitter: [{ type: Output }],
    btnOkAndCancleRef: [{ type: ViewChild, args: ['btnOkAndCancle',] }]
};
if (false) {
    /**
     * 要加载的数据类型
     * all代表全部权限对象
     * reassign代表允许在用户上重新授权的权限对象
     * @type {?}
     */
    AuobjTreeComponent.prototype.dataMode;
    /** @type {?} */
    AuobjTreeComponent.prototype.initSelectedKeys;
    /** @type {?} */
    AuobjTreeComponent.prototype.data;
    /** @type {?} */
    AuobjTreeComponent.prototype.selectedKey;
    /** @type {?} */
    AuobjTreeComponent.prototype.selectedKeyOld;
    /** @type {?} */
    AuobjTreeComponent.prototype.selectedModel;
    /** @type {?} */
    AuobjTreeComponent.prototype.cols;
    /**
     * 树绑定数据源
     * @type {?}
     */
    AuobjTreeComponent.prototype.treeNodeData;
    /** @type {?} */
    AuobjTreeComponent.prototype.farrisTt;
    /** @type {?} */
    AuobjTreeComponent.prototype.selectedchanged;
    /**
     * 帮助输出事件
     * @type {?}
     */
    AuobjTreeComponent.prototype.selectedAfterOk;
    /** @type {?} */
    AuobjTreeComponent.prototype.closeModalEmitter;
    /** @type {?} */
    AuobjTreeComponent.prototype.btnOkAndCancleRef;
    /**
     * @type {?}
     * @private
     */
    AuobjTreeComponent.prototype.service;
    /** @type {?} */
    AuobjTreeComponent.prototype.racUtil;
    /**
     * @type {?}
     * @private
     */
    AuobjTreeComponent.prototype.translate;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXVvYmotdHJlZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ3NwLXN5cy9yYWMtY29tbW9uLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudC9hdW9iai9hdW9iai10cmVlL2F1b2JqLXRyZWUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLEtBQUssRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHdkcsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFZLGtCQUFrQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFJcEUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQU85RCxNQUFNLE9BQU8sa0JBQWtCOzs7Ozs7SUE4QjdCLFlBQ1UsT0FBdUIsRUFDeEIsT0FBc0IsRUFDckIsU0FBMkI7UUFGM0IsWUFBTyxHQUFQLE9BQU8sQ0FBZ0I7UUFDeEIsWUFBTyxHQUFQLE9BQU8sQ0FBZTtRQUNyQixjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQXJCOUIsU0FBSSxHQUFVLEVBQUUsQ0FBQztRQUNqQixnQkFBVyxHQUFHLEVBQUUsQ0FBQztRQUN4QixtQkFBYyxHQUFHLEVBQUUsQ0FBQzs7UUFHcEIsU0FBSSxHQUFVLEVBQUUsQ0FBQztRQUlQLG9CQUFlLEdBQWdDLElBQUksWUFBWSxFQUFpQixDQUFDOzs7O1FBR2pGLG9CQUFlLEdBQWdDLElBQUksWUFBWSxFQUFpQixDQUFDO1FBQ2pGLHNCQUFpQixHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO0lBU3pFLENBQUM7Ozs7SUFFRCxRQUFRO1FBQ04sSUFBSSxDQUFDLElBQUksR0FBRztZQUNWLGlFQUFpRTtZQUNqRSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRTtTQUMvQixDQUFDO0lBRUosQ0FBQzs7Ozs7SUFHRCxRQUFROztZQUNGLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRTtRQUMvQixJQUFLLElBQUksQ0FBQyxRQUFRLEtBQUssVUFBVSxFQUFHO1lBQ2xDLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLGNBQWMsRUFBRSxDQUFDO1NBQ3JDO2FBQU07WUFDTCxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUM3QjtRQUNELEdBQUcsQ0FBQyxTQUFTOzs7O1FBQUMsQ0FBQyxNQUFXLEVBQUUsRUFBRTtZQUM1QixJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQztZQUNuQixJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUU7O3NCQUNQLFlBQVksR0FBZSxFQUFFOztzQkFDN0IsTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDO2dCQUM3RSxNQUFNLENBQUMsT0FBTzs7OztnQkFBQyxJQUFJLENBQUMsRUFBRTs7MEJBQ2QsSUFBSSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUM7b0JBQ3pDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ3hCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDOUIsQ0FBQyxFQUFDLENBQUM7Z0JBQ0gsSUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUM7Z0JBQ2pDLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUN6QztRQUNILENBQUMsRUFBQyxDQUFDO0lBQ0wsQ0FBQzs7Ozs7OztJQUtPLGdCQUFnQixDQUFDLFVBQW9COzs7Y0FFckMsUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTTs7OztRQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsS0FBSyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBQztRQUV6RSxxQkFBcUI7UUFDckIsSUFBSSxRQUFRLElBQUksUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDbkMsUUFBUSxDQUFDLE9BQU87Ozs7WUFBQyxJQUFJLENBQUMsRUFBRTs7c0JBQ2hCLEtBQUssR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDO2dCQUMxQyxVQUFVLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQztnQkFDeEIsVUFBVSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ2hDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMvQixDQUFDLEVBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQzs7Ozs7OztJQUtPLGlCQUFpQixDQUFDLEdBQWtCOztjQUNwQyxJQUFJLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUU7UUFDakYsc0JBQXNCO1FBQ3RCLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUFFO1lBQzNDLDZDQUE2QztZQUM3QyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsS0FBSyxDQUFDO1lBQ3JCLDZDQUE2QztZQUM3QyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ3RCLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFFLGlCQUFpQjtZQUNsRSxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxZQUFZO1NBQy9EO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDOzs7OztJQUVELFVBQVUsQ0FBQyxNQUFxQjs7Y0FDeEIsYUFBYSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7OztjQUUxRCxXQUFXLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXO1FBQzdDLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUUsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUM5QyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUMxRDthQUFNO1lBQ0wsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUUsTUFBTSxFQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ2xFO1FBQ0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7Ozs7O0lBRUQsVUFBVSxDQUFDLE1BQXFCO1FBQzlCLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNsQyxDQUFDOzs7OztJQUVELFVBQVUsQ0FBQyxNQUFxQjtRQUMvQix5QkFBeUI7UUFDekIsMkNBQTJDO0lBQzVDLENBQUM7Ozs7OztJQUtELGVBQWUsQ0FBQyxJQUFTO1FBQ3ZCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1FBQ3JDLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDcEMsT0FBTztRQUNQLElBQUksSUFBSSxDQUFDLGNBQWMsS0FBSyxFQUFFLEVBQUU7WUFDOUIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDO1lBQ3ZDLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUMvQzthQUFNO1lBQ0wsV0FBVztZQUNYLElBQUksSUFBSSxDQUFDLGNBQWMsS0FBSyxJQUFJLENBQUMsV0FBVyxFQUFFO2dCQUM1QyxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7Z0JBQ3ZDLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQzthQUMvQztTQUNGO0lBQ0gsQ0FBQzs7Ozs7SUFFRCxTQUFTLENBQUMsRUFBRSxFQUFFLEVBQU87UUFDbkIsT0FBTztZQUNMLFlBQVksRUFBRSxJQUFJO1lBQ2xCLFFBQVEsRUFBRSxJQUFJO1NBQ2YsQ0FBQztJQUNKLENBQUM7Ozs7O0lBR0QsT0FBTztRQUNMLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUN2QyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDaEQsQ0FBQzs7OztJQUVELE1BQU07UUFDSixJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDaEMsQ0FBQzs7O1lBbktGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsZ0JBQWdCO2dCQUMxQix3aEJBQTBDOzthQUUzQzs7OztZQVBRLGNBQWM7WUFDZCxhQUFhO1lBTmIsZ0JBQWdCOzs7dUJBbUJ0QixLQUFLOytCQUdMLEtBQUs7dUJBV0wsU0FBUyxTQUFDLFVBQVU7OEJBQ3BCLE1BQU07OEJBR04sTUFBTTtnQ0FDTixNQUFNO2dDQUdOLFNBQVMsU0FBQyxnQkFBZ0I7Ozs7Ozs7OztJQXRCM0Isc0NBQzZCOztJQUU3Qiw4Q0FDMkI7O0lBRTNCLGtDQUF3Qjs7SUFDeEIseUNBQXdCOztJQUN4Qiw0Q0FBb0I7O0lBQ3BCLDJDQUE2Qjs7SUFFN0Isa0NBQWlCOzs7OztJQUVqQiwwQ0FBeUI7O0lBQ3pCLHNDQUFvRDs7SUFDcEQsNkNBQTJGOzs7OztJQUczRiw2Q0FBMkY7O0lBQzNGLCtDQUF5RTs7SUFHekUsK0NBQWlFOzs7OztJQUcvRCxxQ0FBK0I7O0lBQy9CLHFDQUE2Qjs7Ozs7SUFDN0IsdUNBQW1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIElucHV0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgVmlld0NoaWxkLCBUZW1wbGF0ZVJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb20sIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcclxuaW1wb3J0IHsgVHJlZU5vZGUsIFRyZWVUYWJsZUNvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktdHJlZXRhYmxlJztcclxuXHJcblxyXG5pbXBvcnQgeyBBdXRob2JqRW50aXR5IH0gZnJvbSAnLi4vLi4vLi4vY29tbW9uL2VudGl0eS9hdXRob2JqLmVudGl0eSc7XHJcbmltcG9ydCB7IEF1dGhPYmpTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vY29tbW9uL3NlcnZpY2UvYXV0aG9iai5zZXJ2aWNlJztcclxuaW1wb3J0IHsgUmFjQ29tbW9uVXRpbCB9IGZyb20gJy4uLy4uLy4uL2NvbW1vbi91dGlsL3JhYy11dGlsJztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAncmFjLWF1b2JqLXRyZWUnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9hdW9iai10cmVlLmNvbXBvbmVudC5odG1sJyxcclxuICBzdHlsZVVybHM6IFsnLi9hdW9iai10cmVlLmNvbXBvbmVudC5jc3MnXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgQXVvYmpUcmVlQ29tcG9uZW50ICBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcblxyXG4gICAgLyoqIOimgeWKoOi9veeahOaVsOaNruexu+Wei1xyXG4gICAgICogYWxs5Luj6KGo5YWo6YOo5p2D6ZmQ5a+56LGhXHJcbiAgICAgKiByZWFzc2lnbuS7o+ihqOWFgeiuuOWcqOeUqOaIt+S4iumHjeaWsOaOiOadg+eahOadg+mZkOWvueixoVxyXG4gICAgICovXHJcbiAgQElucHV0KClcclxuICBkYXRhTW9kZTogJ2FsbCcgfCAncmVhc3NpZ24nO1xyXG5cclxuICBASW5wdXQoKVxyXG4gIGluaXRTZWxlY3RlZEtleXM6IHN0cmluZ1tdO1xyXG5cclxuICBwdWJsaWMgZGF0YTogYW55W10gPSBbXTtcclxuICBwdWJsaWMgc2VsZWN0ZWRLZXkgPSAnJztcclxuICBzZWxlY3RlZEtleU9sZCA9ICcnO1xyXG4gIHNlbGVjdGVkTW9kZWw6IEF1dGhvYmpFbnRpdHk7XHJcbiAgLy8g5qCR5omA6ZyA5Y+C5pWwXHJcbiAgY29sczogYW55W10gPSBbXTtcclxuICAvKiog5qCR57uR5a6a5pWw5o2u5rqQICovXHJcbiAgdHJlZU5vZGVEYXRhOiBUcmVlTm9kZVtdO1xyXG4gIEBWaWV3Q2hpbGQoJ2ZhcnJpc1R0JykgZmFycmlzVHQ6IFRyZWVUYWJsZUNvbXBvbmVudDtcclxuICBAT3V0cHV0KCkgc2VsZWN0ZWRjaGFuZ2VkOiBFdmVudEVtaXR0ZXI8QXV0aG9iakVudGl0eT4gPSBuZXcgRXZlbnRFbWl0dGVyPEF1dGhvYmpFbnRpdHk+KCk7XHJcblxyXG4gIC8qKiDluK7liqnovpPlh7rkuovku7YgKi9cclxuICBAT3V0cHV0KCkgc2VsZWN0ZWRBZnRlck9rOiBFdmVudEVtaXR0ZXI8QXV0aG9iakVudGl0eT4gPSBuZXcgRXZlbnRFbWl0dGVyPEF1dGhvYmpFbnRpdHk+KCk7XHJcbiAgQE91dHB1dCgpIGNsb3NlTW9kYWxFbWl0dGVyOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG5cclxuICAvLyDms6jlhaXliLDluK7liqnnmoTnoa7orqTlkozlj5bmtojmjInpkq5cclxuICBAVmlld0NoaWxkKCdidG5Pa0FuZENhbmNsZScpIGJ0bk9rQW5kQ2FuY2xlUmVmOiBUZW1wbGF0ZVJlZjxhbnk+O1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgc2VydmljZTogQXV0aE9ialNlcnZpY2UsXHJcbiAgICBwdWJsaWMgcmFjVXRpbDogUmFjQ29tbW9uVXRpbCxcclxuICAgIHByaXZhdGUgdHJhbnNsYXRlOiBUcmFuc2xhdGVTZXJ2aWNlKSB7XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIHRoaXMuY29scyA9IFtcclxuICAgICAgLy8geyBmaWVsZDogJ25hbWUnLCB0aXRsZTogdGhpcy50cmFuc2xhdGUuaW5zdGFudCgnbGJsQXV0aE9iaicpIH1cclxuICAgICAgeyBmaWVsZDogJ25hbWUnLCB0aXRsZTogJ+WQjeensCcgfVxyXG4gICAgXTtcclxuXHJcbiAgfVxyXG5cclxuICAvKiog5qC55o2u5YiG6YWN55qE5Yqf6IO95pON5L2c5Yid5aeL5a+55bqU55qE5p2D6ZmQ5a+56LGhICovXHJcbiAgaW5pdERhdGEoKSB7XHJcbiAgICBsZXQgb2JzID0gdGhpcy5zZXJ2aWNlLmdldEFsbCgpO1xyXG4gICAgaWYgKCB0aGlzLmRhdGFNb2RlID09PSAncmVhc3NpZ24nICkge1xyXG4gICAgICBvYnMgPSB0aGlzLnNlcnZpY2UuZ2V0QWxsUmVBc3NpZ24oKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIG9icyA9IHRoaXMuc2VydmljZS5nZXRBbGwoKTtcclxuICAgIH1cclxuICAgIG9icy5zdWJzY3JpYmUoKHJlc3VsdDogYW55KSA9PiB7XHJcbiAgICAgIHRoaXMuZGF0YSA9IHJlc3VsdDtcclxuICAgICAgaWYgKHRoaXMuZGF0YSkge1xyXG4gICAgICAgIGNvbnN0IGluaXROb2RlTGlzdDogVHJlZU5vZGVbXSA9IFtdO1xyXG4gICAgICAgIGNvbnN0IGxheWVyMSA9IHRoaXMucmFjVXRpbC5maW5kTGF5ZXIxQnlQYXJlbnRJZCh0aGlzLmRhdGEsICdpZCcsICdwYXJlbnRJZCcpO1xyXG4gICAgICAgIGxheWVyMS5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgY29uc3Qgbm9kZSA9IHRoaXMuY29udmVydFRvVHJlZU5vZGUoaXRlbSk7XHJcbiAgICAgICAgICBpbml0Tm9kZUxpc3QucHVzaChub2RlKTtcclxuICAgICAgICAgIHRoaXMuaW5pdFRyZWVOb2RlTGlzdChub2RlKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnRyZWVOb2RlRGF0YSA9IGluaXROb2RlTGlzdDtcclxuICAgICAgICB0aGlzLnJhY1V0aWwuc2V0VHJlZUljb24odGhpcy5mYXJyaXNUdCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmnoTpgKBGYXJyaXMtVHJlZeaJgOmcgOe7k+aehFxyXG4gICAqIEBwYXJhbSBhdXRoZmllbGRMaXN0IOadg+mZkOWtl+auteWIl+ihqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgaW5pdFRyZWVOb2RlTGlzdChwYXJlbnROb2RlOiBUcmVlTm9kZSkge1xyXG4gICAgLy8g5qC55o2u54i26IqC54K56L+H5ruk5a2Q6IqC54K5XHJcbiAgICBjb25zdCBjaGlsZHJlbiA9IHRoaXMuZGF0YS5maWx0ZXIoeCA9PiB4LnBhcmVudElkID09PSBwYXJlbnROb2RlLmRhdGEuaWQpO1xyXG5cclxuICAgIC8vIOWwhui/h+a7pOeahOaVsOaNruWKoOWIsFRyZWVOb2Rlc+S4rVxyXG4gICAgaWYgKGNoaWxkcmVuICYmIGNoaWxkcmVuLmxlbmd0aCA+IDApIHtcclxuICAgICAgY2hpbGRyZW4uZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICBjb25zdCBjaGlsZCA9IHRoaXMuY29udmVydFRvVHJlZU5vZGUoaXRlbSk7XHJcbiAgICAgICAgcGFyZW50Tm9kZS5sZWFmID0gZmFsc2U7XHJcbiAgICAgICAgcGFyZW50Tm9kZS5jaGlsZHJlbi5wdXNoKGNoaWxkKTtcclxuICAgICAgICB0aGlzLmluaXRUcmVlTm9kZUxpc3QoY2hpbGQpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWwhuadg+mZkOWtl+auteWunuS9k+i9rOaNouS4ukZhcnJpcy1UcmVlTm9kZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgY29udmVydFRvVHJlZU5vZGUob2JqOiBBdXRob2JqRW50aXR5KTogVHJlZU5vZGUge1xyXG4gICAgY29uc3Qgbm9kZSA9IHsgZGF0YTogb2JqLCBsZWFmOiB0cnVlLCBjaGlsZHJlbjogW10sIGljb246IHRoaXMucmFjVXRpbC5sZWFmSWNvbiB9O1xyXG4gICAgLy8g5piv5ZCm5piO57uG6IqC54K577yMdHlwZeS4ujAg6K+05piO5piv5a+86IiqXHJcbiAgICBpZiAodGhpcy5yYWNVdGlsLmlzTmF2KG9iai50eXBlLnRvU3RyaW5nKCkpKSB7XHJcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1zdHJpbmctbGl0ZXJhbFxyXG4gICAgICBub2RlWydsZWFmJ10gPSBmYWxzZTtcclxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXN0cmluZy1saXRlcmFsXHJcbiAgICAgIG5vZGVbJ2NoaWxkcmVuJ10gPSBbXTtcclxuICAgICAgbm9kZVsnZXhwYW5kZWRJY29uJ10gPSB0aGlzLnJhY1V0aWwuZXhwYW5kSWNvbjsgIC8vICdmb2xkZXItb3Blbic7XHJcbiAgICAgIG5vZGVbJ2NvbGxhcHNlSWNvbiddID0gdGhpcy5yYWNVdGlsLmNvbGxhcHNlSWNvbjsgLy8gJ2ZvbGRlcic7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbm9kZTtcclxuICB9XHJcblxyXG4gIGFwcGVuZE5vZGUobmV3T2JqOiBBdXRob2JqRW50aXR5KSB7XHJcbiAgICBjb25zdCBwYXJlbnRSb3dOb2RlID0gdGhpcy5mYXJyaXNUdC5maW5kUm93Tm9kZShuZXdPYmoucGFyZW50SWQpO1xyXG4gICAgLy8gY29uc3QgbmV3VHJlZU5vZGUgPSB0aGlzLmNvbnZlcnRUb1RyZWVOb2RlKG5ld09iaik7XHJcbiAgICBjb25zdCBzZWxlY3RlZFJvdyA9IHRoaXMuZmFycmlzVHQuc2VsZWN0ZWRSb3c7XHJcbiAgICBpZiAodGhpcy5yYWNVdGlsLmlzTmF2KCBzZWxlY3RlZFJvdy5kYXRhLnR5cGUpKSB7XHJcbiAgICAgIHRoaXMuZmFycmlzVHQuYXBwZW5kKCBuZXdPYmosIHRoaXMuZmFycmlzVHQuc2VsZWN0ZWRSb3cpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5mYXJyaXNUdC5hcHBlbmQoIG5ld09iaiAsIHRoaXMuZmFycmlzVHQuc2VsZWN0ZWRSb3cucGFyZW50KTtcclxuICAgIH1cclxuICAgIHRoaXMuZmFycmlzVHQuc2VsZWN0Tm9kZShuZXdPYmouaWQpO1xyXG4gIH1cclxuXHJcbiAgcmVtb3ZlTm9kZShuZXdPYmo6IEF1dGhvYmpFbnRpdHkpIHtcclxuICAgIHRoaXMuZmFycmlzVHQucmVtb3ZlKG5ld09iai5pZCk7XHJcbiAgfVxyXG5cclxuICB1cGRhdGVOb2RlKG5ld09iajogQXV0aG9iakVudGl0eSkge1xyXG4gICAvLyBUT0RPIHVwZGF0ZeaXtmRhdGEg5Y+C5pWw5pyJ6Zeu6aKYXHJcbiAgIC8vIHRoaXMuZmFycmlzVHQudXBkYXRlKG5ld09iai5pZCwgbmV3T2JqKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOmAieS4reihjOaUueWPmOWQjuinpuWPkeS6i+S7tlxyXG4gICAqL1xyXG4gIGhhbmRsZVNlbGVjdGlvbihhcmdzOiBhbnkpIHtcclxuICAgIHRoaXMuc2VsZWN0ZWRLZXkgPSBhcmdzLm5vZGUuZGF0YS5pZDtcclxuICAgIHRoaXMuc2VsZWN0ZWRNb2RlbCA9IGFyZ3Mubm9kZS5kYXRhO1xyXG4gICAgLy8g6aaW5qyh6Kem5Y+RXHJcbiAgICBpZiAodGhpcy5zZWxlY3RlZEtleU9sZCA9PT0gJycpIHtcclxuICAgICAgdGhpcy5zZWxlY3RlZEtleU9sZCA9IHRoaXMuc2VsZWN0ZWRLZXk7XHJcbiAgICAgIHRoaXMuc2VsZWN0ZWRjaGFuZ2VkLmVtaXQodGhpcy5zZWxlY3RlZE1vZGVsKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIOWPmOWMlueahOaDheWGteS4i+inpuWPkVxyXG4gICAgICBpZiAodGhpcy5zZWxlY3RlZEtleU9sZCAhPT0gdGhpcy5zZWxlY3RlZEtleSkge1xyXG4gICAgICAgIHRoaXMuc2VsZWN0ZWRLZXlPbGQgPSB0aGlzLnNlbGVjdGVkS2V5O1xyXG4gICAgICAgIHRoaXMuc2VsZWN0ZWRjaGFuZ2VkLmVtaXQodGhpcy5zZWxlY3RlZE1vZGVsKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaWNvbkNsYXNzKHsgaWQgfTogYW55KTogYW55IHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICdrLWktZm9sZGVyJzogdHJ1ZSxcclxuICAgICAgJ2staWNvbic6IHRydWVcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKiog5biu5Yqp56Gu5a6a5oyJ6ZKuICovXHJcbiAgY29uZmlybSgpIHtcclxuICAgIHRoaXMuc2VsZWN0ZWRLZXlPbGQgPSB0aGlzLnNlbGVjdGVkS2V5O1xyXG4gICAgdGhpcy5zZWxlY3RlZEFmdGVyT2suZW1pdCh0aGlzLnNlbGVjdGVkTW9kZWwpO1xyXG4gIH1cclxuXHJcbiAgY2FuY2xlKCkge1xyXG4gICAgdGhpcy5jbG9zZU1vZGFsRW1pdHRlci5uZXh0KCk7XHJcbiAgfVxyXG59XHJcblxyXG4iXX0=