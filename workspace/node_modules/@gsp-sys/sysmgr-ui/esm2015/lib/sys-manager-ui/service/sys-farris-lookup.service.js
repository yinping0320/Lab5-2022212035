/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { from } from 'rxjs';
import { HttpClient } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { SysCommonUtilService, SysDataUtil } from '@gsp-sys/sysmgr-common';
import { map } from 'rxjs/operators';
import { userHelp, posHelp, roleHelp, userGroupHelp, posGroupHelp, roleGroupHelp, sysOrgHelp } from '../help-meta/sys-help-meta';
import { SysLocaleService } from '../../locale/sys-locale.service';
/**
 * 帮助服务
 */
export class SysFarrisLookupService {
    /**
     * @param {?} http
     * @param {?} sysUtil
     * @param {?} localService
     */
    constructor(http, sysUtil, localService) {
        this.http = http;
        this.sysUtil = sysUtil;
        this.localService = localService;
    }
    /**
     * 初始过滤条件
     * @private
     * @param {?} filter
     * @return {?}
     */
    setFilterData(filter) {
        // 有过滤条件
        if (filter) {
            /** @type {?} */
            const str = JSON.stringify(filter);
            if (str !== '{}') {
                // 一定要复制
                this.filterData = JSON.parse(str);
            }
            else {
                this.filterData = null;
            }
        }
        else {
            this.filterData = null;
        }
    }
    /**
     * 添加数据
     * @private
     * @param {?} src
     * @param {?} data
     * @return {?}
     */
    setListData(src, data) {
        if (src) {
            src.push.apply(src, data);
        }
    }
    /**
     * 获取过滤数据
     * @private
     * @return {?}
     */
    getFilterData() {
        return this.filterData;
    }
    /**
     * 异步获取版本
     * @param {?} url
     * @param {?=} params
     * @return {?}
     */
    getTreeDataAsync(url, params) {
        this.i18nRes = this.localService.getComponentOpt('help');
        // 解析查询json对象
        /** @type {?} */
        const treeParam = JSON.parse(params.searchValue);
        /** @type {?} */
        let farrisSelectedData = params['customData'].farrisSelectedData;
        /** @type {?} */
        let filter = {};
        // filter.withPermission = true;
        /** @type {?} */
        const category = treeParam.category;
        // 1.首次加载
        if (category === 'all') {
            filter.layer = 1;
        }
        // 2.异步展开下级
        if (category === 'children') {
            if (treeParam.hasOwnProperty('parentPath')) {
                filter.path = treeParam.parentPath;
            }
            if (treeParam.hasOwnProperty('parentLayer')) {
                // 后端搜索以下级节点为级数的节点
                filter.layer = treeParam.parentLayer + 1;
            }
            if (treeParam.hasOwnProperty('parentId')) {
                filter.parentId = treeParam.parentId;
            }
        }
        // 3.搜索
        if (category === 'search') {
            /** @type {?} */
            const searchField = treeParam.searchField;
            /** @type {?} */
            const searchValue = treeParam.searchValue.trim();
            if (searchValue) {
                filter.isSearchTree = true;
                switch (searchField) {
                    case 'code':
                        filter.code = searchValue;
                        break;
                    case 'name':
                        filter.name = searchValue;
                        break;
                    // 全部列搜索，之前是'*'
                    case '*':
                    default:
                        filter.codeOrName = searchValue;
                        break;
                }
            }
            else {
                // 搜索为空，重新加载，默认从1级开始
                filter.layer = 1;
            }
        }
        //如果是组织，请求选中数据时
        if (url === '/api/runtime/sys/v1.0/sysOrgs' && category === 'fav') {
            /** @type {?} */
            let newUrl = url + '/nullorg';
            /** @type {?} */
            const newOpt = {
                headers: this.sysUtil.getHeader()['headers'],
                params: { useView: 'true' }
            };
            return this.http.get(newUrl, newOpt).pipe(map((/**
             * @param {?} val
             * @return {?}
             */
            (val) => {
                /** @type {?} */
                const gridResult = {};
                return gridResult;
            })));
        }
        // 说明有过滤条件
        if (this.getFilterData()) {
            filter = Object.assign(this.getFilterData(), filter);
            SysDataUtil.deleteEmpty(filter);
        }
        /** @type {?} */
        const paramStr = JSON.stringify(filter);
        /** @type {?} */
        const opt = {
            headers: this.sysUtil.getHeader()['headers'],
            params: { param: paramStr }
        };
        return this.http.get(url, opt).pipe(map((/**
         * @param {?} val
         * @return {?}
         */
        (val) => {
            /** @type {?} */
            const gridResult = {};
            gridResult.selectedData = farrisSelectedData;
            gridResult.items = [];
            gridResult.treeInfo = {
                loadDataType: 'async',
                layerType: 'parentId',
                dataField: 'treeInfo',
                pathField: 'path',
                layerField: 'layer',
                parentField: 'parentId',
                isDetailField: 'isDetail'
            };
            gridResult.treeInfo['treeDataIsInit'] = true;
            gridResult.columns = [
                { field: 'code', title: this.i18nRes.codeField },
                { field: 'name', title: this.i18nRes.nameField }
            ];
            gridResult.searchFields = [
                { label: this.i18nRes.codeField, value: 'code' },
                { label: this.i18nRes.nameField, value: 'name' }
            ];
            // 必须要赋值
            from(val).subscribe((/**
             * @param {?} item
             * @return {?}
             */
            item => {
                if (item.layer === 1 || !item.parentId) {
                    item.parentId = null;
                }
                item.treeInfo = {
                    parentId: item.parentId,
                    path: item.path,
                    layer: item.layer,
                    isDetail: item.isDetail
                };
            }));
            // 如果是搜索的话，需要自己构造树
            if (filter.isSearchTree) {
                gridResult.items = this.makeTreeByParent(val, 'parentId', 'id');
                console.log(gridResult.items);
            }
            else {
                // 有结果，普通分层加载
                if (val && val.length > 0) {
                    from(val).subscribe((/**
                     * @param {?} item
                     * @return {?}
                     */
                    item => {
                        gridResult.items.push(this.convertToTreeNode(item));
                    }));
                }
            }
            return gridResult;
        })));
    }
    /**
     * 将树节点转换为Farris TreeNode
     * @private
     * @param {?} src
     * @return {?}
     */
    convertToTreeNode(src) {
        /** @type {?} */
        const node = {};
        node.data = src;
        node.children = [];
        node.selectable = src.farris_selectable;
        node.leaf = src.isDetail;
        node.parent = src.parentId;
        // 这一条必须得加，否则不行
        node.id = node.data.id;
        // 搜索的时候最末级添加了这个属性，不需要展开
        if (src.hasOwnProperty('expanded')) {
            node.expanded = src.expanded;
        }
        return node;
    }
    /**
     * 按照parent码构造树
     * @param {?} datas
     * @param {?} parentField
     * @param {?} keyField
     * @return {?}
     */
    makeTreeByParent(datas, parentField, keyField) {
        // 上級爲空，或者沒有上級的
        /** @type {?} */
        const pathLayerOnes = datas.filter((/**
         * @param {?} x
         * @return {?}
         */
        x => {
            if (!x[parentField]) {
                return true;
            }
            // 断层的这种，应该也属于一级
            /** @type {?} */
            const p = datas.find((/**
             * @param {?} parent
             * @return {?}
             */
            parent => parent[keyField] === x[parentField]));
            if (!p) {
                return true;
            }
        }));
        /** @type {?} */
        const treedata = [];
        pathLayerOnes.forEach((/**
         * @param {?} x
         * @return {?}
         */
        x => {
            /** @type {?} */
            const node = this.convertToTreeNode(x);
            treedata.push(node);
        }));
        treedata.forEach((/**
         * @param {?} item
         * @return {?}
         */
        item => {
            this.findChildrenByParent(item, datas, parentField, keyField);
        }));
        return treedata;
    }
    /**
     * 找到子节点
     * @param {?} parent
     * @param {?} datas
     * @param {?} parentField
     * @param {?} keyField
     * @return {?}
     */
    findChildrenByParent(parent, datas, parentField, keyField) {
        /** @type {?} */
        const childList = datas.filter((/**
         * @param {?} childitem
         * @return {?}
         */
        childitem => {
            if (childitem[parentField] === parent.data[keyField]) {
                return true;
            }
        }));
        if (childList && childList.length > 0) {
            childList.forEach((/**
             * @param {?} child
             * @return {?}
             */
            child => {
                /** @type {?} */
                const node = this.convertToTreeNode(child);
                parent.children.push(node);
                this.findChildrenByParent(node, datas, parentField, keyField);
            }));
        }
    }
    /**
     * 全部获取版本版本
     * @param {?} url
     * @param {?=} params
     * @return {?}
     */
    getTreeData(url, params) {
        /** @type {?} */
        let filter = {};
        // 说明有过滤条件
        if (this.getFilterData()) {
            filter = Object.assign(this.getFilterData(), filter);
            SysDataUtil.deleteEmpty(filter);
        }
        /** @type {?} */
        const paramStr = JSON.stringify(filter);
        /** @type {?} */
        const opt = {
            headers: this.sysUtil.getHeader()['headers'],
            params: { param: paramStr }
        };
        return this.http.get(url, opt).pipe(map((/**
         * @param {?} val
         * @return {?}
         */
        (val) => {
            if (val && val.length > 0) {
                val.forEach((/**
                 * @param {?} item
                 * @return {?}
                 */
                item => {
                    if (item.layer == 1 || item.parentId == null) {
                        item.parentId = '';
                    }
                    // 满足前端结构
                    item.treeInfo = {
                        parentId: item.parentId,
                        path: item.path,
                        layer: item.layer,
                        isDetail: item.isDetail
                    };
                    item.selectable = false;
                }));
            }
            else {
                val = [];
            }
            return { items: val };
        })));
    }
    /**
     * 获取列表数据
     * @param {?} url
     * @param {?=} params
     * @return {?}
     */
    getGridData(url, params) {
        /** @type {?} */
        let index = params.pageIndex;
        /** @type {?} */
        let size = params.pageSize;
        /** @type {?} */
        let farrisSelectedData = params['customData'].farrisSelectedData;
        // 目前这个地方有问题，第一次的时候传递不过来
        if (!index) {
            /** @type {?} */
            const customData = params['customData'];
            index = customData.filter.pageIndex;
            size = customData.filter.pageSize;
        }
        /** @type {?} */
        let param = {
            pageIndex: index,
            pageSize: size,
        };
        // 是否有搜索
        /** @type {?} */
        const filterStr = params.searchValue;
        /** @type {?} */
        const filterObj = JSON.parse(filterStr);
        /** @type {?} */
        const searchField = filterObj.searchField;
        /** @type {?} */
        const searchValue = filterObj.searchValue;
        // 有过滤查询,有可能搜索值为空，这时候是不需要搜索的
        if (searchField && searchValue) {
            switch (searchField) {
                case 'code':
                    param.code = searchValue;
                    break;
                case 'name':
                    param.name = searchValue;
                    break;
                // 全部列搜索，之前是'*'
                case '*':
                default:
                    param.codeOrName = searchValue;
                    break;
            }
        }
        // 说明有过滤条件
        if (this.getFilterData()) {
            param = Object.assign(this.getFilterData(), param);
            SysDataUtil.deleteEmpty(param);
        }
        console.log(param);
        /** @type {?} */
        const paramStr = JSON.stringify(param);
        /** @type {?} */
        const opt = {
            headers: this.sysUtil.getHeader()['headers'],
            params: { param: paramStr }
        };
        return this.http.get(url, opt).pipe(map((/**
         * @param {?} val
         * @return {?}
         */
        (val) => {
            if (val && val.data) {
                // 将本次分页的数据附加到当前帮助的列表中
                this.setListData(params['customData'].allData, val.data);
            }
            return {
                items: val.data,
                total: val.totalCount,
                pageInfo: {
                    pageIndex: index,
                    pageSize: size,
                    pageList: [20, 40, 60, 80, 100],
                    enablePager: true
                },
                selectedData: farrisSelectedData
            };
        })));
    }
    /**
     * 取数
     * @param {?} url
     * @param {?=} params
     * @return {?}
     */
    getData(url, params) {
        console.log(params);
        console.log(url);
        /** @type {?} */
        const filter = params['customData'].filter;
        this.setFilterData(filter);
        /** @type {?} */
        const typeIndex = url.indexOf('\/');
        /** @type {?} */
        const httpUrl = url.substring(typeIndex, url.length);
        /** @type {?} */
        const helpType = url.substring(0, typeIndex);
        switch (helpType) {
            case userHelp:
            case posHelp:
            case roleHelp:
                return this.getGridData(httpUrl, params);
            case userGroupHelp:
            case posGroupHelp:
            case roleGroupHelp:
            case sysOrgHelp:
                return this.getTreeDataAsync(httpUrl, params);
            default:
                break;
        }
    }
}
SysFarrisLookupService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
SysFarrisLookupService.ctorParameters = () => [
    { type: HttpClient },
    { type: SysCommonUtilService },
    { type: SysLocaleService }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    SysFarrisLookupService.prototype.filterData;
    /**
     * @type {?}
     * @private
     */
    SysFarrisLookupService.prototype.i18nRes;
    /**
     * @type {?}
     * @private
     */
    SysFarrisLookupService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    SysFarrisLookupService.prototype.sysUtil;
    /**
     * @type {?}
     * @private
     */
    SysFarrisLookupService.prototype.localService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3lzLWZhcnJpcy1sb29rdXAuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bnc3Atc3lzL3N5c21nci11aS8iLCJzb3VyY2VzIjpbImxpYi9zeXMtbWFuYWdlci11aS9zZXJ2aWNlL3N5cy1mYXJyaXMtbG9va3VwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBa0IsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxXQUFXLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUMzRSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLGFBQWEsRUFBRSxZQUFZLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRWpJLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlDQUFpQyxDQUFDOzs7O0FBUW5FLE1BQU0sT0FBTyxzQkFBc0I7Ozs7OztJQUkvQixZQUNZLElBQWdCLEVBQ2hCLE9BQTZCLEVBQzdCLFlBQThCO1FBRjlCLFNBQUksR0FBSixJQUFJLENBQVk7UUFDaEIsWUFBTyxHQUFQLE9BQU8sQ0FBc0I7UUFDN0IsaUJBQVksR0FBWixZQUFZLENBQWtCO0lBRTFDLENBQUM7Ozs7Ozs7SUFHTyxhQUFhLENBQUUsTUFBVztRQUM5QixRQUFRO1FBQ1IsSUFBSSxNQUFNLEVBQUU7O2tCQUNGLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQztZQUNsQyxJQUFJLEdBQUcsS0FBSyxJQUFJLEVBQUU7Z0JBQ2QsUUFBUTtnQkFDUixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUks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YUFBYSxDQUFDO1lBQ25CLEtBQUssWUFBWSxDQUFDO1lBQ2xCLEtBQUssYUFBYSxDQUFDO1lBQ25CLEtBQUssVUFBVTtnQkFDWCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDbEQ7Z0JBQ0ksTUFBTTtTQUNiO0lBQ0wsQ0FBQzs7O1lBL1ZKLFVBQVU7Ozs7WUFkRixVQUFVO1lBR1Ysb0JBQW9CO1lBSXBCLGdCQUFnQjs7Ozs7OztJQVVyQiw0Q0FBd0I7Ozs7O0lBQ3hCLHlDQUFxQjs7Ozs7SUFFakIsc0NBQXdCOzs7OztJQUN4Qix5Q0FBcUM7Ozs7O0lBQ3JDLDhDQUFzQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBmcm9tIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgSUxvb2t1cEh0dHBTZXJ2aWNlLCBSZW1vdGVQYXJhbXMsIExvb2t1cEdyaWRSZXN1bHQgfSBmcm9tICdAZmFycmlzL3VpLWxvb2t1cCc7XHJcbmltcG9ydCB7IFN5c0NvbW1vblV0aWxTZXJ2aWNlLCBTeXNEYXRhVXRpbCB9IGZyb20gJ0Bnc3Atc3lzL3N5c21nci1jb21tb24nO1xyXG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IHVzZXJIZWxwLCBwb3NIZWxwLCByb2xlSGVscCwgdXNlckdyb3VwSGVscCwgcG9zR3JvdXBIZWxwLCByb2xlR3JvdXBIZWxwLCBzeXNPcmdIZWxwIH0gZnJvbSAnLi4vaGVscC1tZXRhL3N5cy1oZWxwLW1ldGEnO1xyXG5pbXBvcnQgeyBUcmVlTm9kZSB9IGZyb20gJ0BmYXJyaXMvdWktdHJlZXRhYmxlJztcclxuaW1wb3J0IHsgU3lzTG9jYWxlU2VydmljZSB9IGZyb20gJy4uLy4uL2xvY2FsZS9zeXMtbG9jYWxlLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBUcmVlRmlsdGVyIH0gZnJvbSAnLi4vZmlsdGVyL3RyZWUtZmlsdGVyJztcclxuXHJcblxyXG4vKipcclxuICog5biu5Yqp5pyN5YqhXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBTeXNGYXJyaXNMb29rdXBTZXJ2aWNlIGltcGxlbWVudHMgSUxvb2t1cEh0dHBTZXJ2aWNlIHtcclxuXHJcbiAgICBwcml2YXRlIGZpbHRlckRhdGE6IGFueTtcclxuICAgIHByaXZhdGUgaTE4blJlczogYW55O1xyXG4gICAgY29uc3RydWN0b3IgKFxyXG4gICAgICAgIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCxcclxuICAgICAgICBwcml2YXRlIHN5c1V0aWw6IFN5c0NvbW1vblV0aWxTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgbG9jYWxTZXJ2aWNlOiBTeXNMb2NhbGVTZXJ2aWNlXHJcbiAgICApIHtcclxuICAgIH1cclxuXHJcbiAgICAvKiog5Yid5aeL6L+H5ruk5p2h5Lu2ICovXHJcbiAgICBwcml2YXRlIHNldEZpbHRlckRhdGEgKGZpbHRlcjogYW55KSB7XHJcbiAgICAgICAgLy8g5pyJ6L+H5ruk5p2h5Lu2XHJcbiAgICAgICAgaWYgKGZpbHRlcikge1xyXG4gICAgICAgICAgICBjb25zdCBzdHIgPSBKU09OLnN0cmluZ2lmeShmaWx0ZXIpO1xyXG4gICAgICAgICAgICBpZiAoc3RyICE9PSAne30nKSB7XHJcbiAgICAgICAgICAgICAgICAvLyDkuIDlrpropoHlpI3liLZcclxuICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YSA9IEpTT04ucGFyc2Uoc3RyKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YSA9IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmZpbHRlckRhdGEgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog5re75Yqg5pWw5o2uXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgc2V0TGlzdERhdGEgKHNyYzogYW55W10sIGRhdGE6IGFueVtdKSB7XHJcbiAgICAgICAgaWYgKHNyYykge1xyXG4gICAgICAgICAgICBzcmMucHVzaC5hcHBseShzcmMsIGRhdGEpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8qKiDojrflj5bov4fmu6TmlbDmja4gKi9cclxuICAgIHByaXZhdGUgZ2V0RmlsdGVyRGF0YSAoKTogYW55IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5maWx0ZXJEYXRhO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDlvILmraXojrflj5bniYjmnKxcclxuICAgICAqL1xyXG4gICAgZ2V0VHJlZURhdGFBc3luYyh1cmw6IHN0cmluZywgcGFyYW1zPzogUmVtb3RlUGFyYW1zKTogT2JzZXJ2YWJsZTxMb29rdXBHcmlkUmVzdWx0PiB7XHJcbiAgICAgICAgdGhpcy5pMThuUmVzID0gdGhpcy5sb2NhbFNlcnZpY2UuZ2V0Q29tcG9uZW50T3B0KCdoZWxwJyk7XHJcbiAgICAgICAgLy8g6Kej5p6Q5p+l6K+ianNvbuWvueixoVxyXG4gICAgICAgIGNvbnN0IHRyZWVQYXJhbSA9IEpTT04ucGFyc2UocGFyYW1zLnNlYXJjaFZhbHVlKTtcclxuICAgICAgICBsZXQgZmFycmlzU2VsZWN0ZWREYXRhID0gcGFyYW1zWydjdXN0b21EYXRhJ10uZmFycmlzU2VsZWN0ZWREYXRhO1xyXG5cclxuICAgICAgICBsZXQgZmlsdGVyOiBUcmVlRmlsdGVyID0ge307XHJcbiAgICAgICAgLy8gZmlsdGVyLndpdGhQZXJtaXNzaW9uID0gdHJ1ZTtcclxuICAgICAgICBjb25zdCBjYXRlZ29yeSA9IHRyZWVQYXJhbS5jYXRlZ29yeTtcclxuICAgICAgICAvLyAxLummluasoeWKoOi9vVxyXG4gICAgICAgIGlmIChjYXRlZ29yeSA9PT0gJ2FsbCcpIHtcclxuICAgICAgICAgICAgZmlsdGVyLmxheWVyID0gMTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gMi7lvILmraXlsZXlvIDkuIvnuqdcclxuICAgICAgICBpZiAoY2F0ZWdvcnkgPT09ICdjaGlsZHJlbicpIHtcclxuICAgICAgICAgICAgaWYgKHRyZWVQYXJhbS5oYXNPd25Qcm9wZXJ0eSgncGFyZW50UGF0aCcpKSB7XHJcbiAgICAgICAgICAgICAgICBmaWx0ZXIucGF0aCA9IHRyZWVQYXJhbS5wYXJlbnRQYXRoO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0cmVlUGFyYW0uaGFzT3duUHJvcGVydHkoJ3BhcmVudExheWVyJykpIHtcclxuICAgICAgICAgICAgICAgIC8vIOWQjuerr+aQnOe0ouS7peS4i+e6p+iKgueCueS4uue6p+aVsOeahOiKgueCuVxyXG4gICAgICAgICAgICAgICAgZmlsdGVyLmxheWVyID0gdHJlZVBhcmFtLnBhcmVudExheWVyICsgMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodHJlZVBhcmFtLmhhc093blByb3BlcnR5KCdwYXJlbnRJZCcpKSB7XHJcbiAgICAgICAgICAgICAgICBmaWx0ZXIucGFyZW50SWQgPSB0cmVlUGFyYW0ucGFyZW50SWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gMy7mkJzntKJcclxuICAgICAgICBpZiAoY2F0ZWdvcnkgPT09ICdzZWFyY2gnKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNlYXJjaEZpZWxkID0gdHJlZVBhcmFtLnNlYXJjaEZpZWxkO1xyXG4gICAgICAgICAgICBjb25zdCBzZWFyY2hWYWx1ZTogc3RyaW5nID0gdHJlZVBhcmFtLnNlYXJjaFZhbHVlLnRyaW0oKTtcclxuICAgICAgICAgICAgaWYgKHNlYXJjaFZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICBmaWx0ZXIuaXNTZWFyY2hUcmVlID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIHN3aXRjaCAoc2VhcmNoRmllbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdjb2RlJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyLmNvZGUgPSBzZWFyY2hWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbmFtZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlci5uYW1lID0gc2VhcmNoVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOWFqOmDqOWIl+aQnOe0ou+8jOS5i+WJjeaYrycqJ1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJyonOlxyXG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlci5jb2RlT3JOYW1lID0gc2VhcmNoVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8g5pCc57Si5Li656m677yM6YeN5paw5Yqg6L2977yM6buY6K6k5LuOMee6p+W8gOWni1xyXG4gICAgICAgICAgICAgICAgZmlsdGVyLmxheWVyID0gMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy/lpoLmnpzmmK/nu4Tnu4fvvIzor7fmsYLpgInkuK3mlbDmja7ml7ZcclxuICAgICAgICBpZiAodXJsID09PSAnL2FwaS9ydW50aW1lL3N5cy92MS4wL3N5c09yZ3MnICYmIGNhdGVnb3J5ID09PSAnZmF2Jykge1xyXG5cclxuICAgICAgICAgICAgbGV0IG5ld1VybCA9IHVybCsnL251bGxvcmcnIFxyXG4gICAgICAgICAgICBjb25zdCBuZXdPcHQgPSB7XHJcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiB0aGlzLnN5c1V0aWwuZ2V0SGVhZGVyKClbJ2hlYWRlcnMnXSxcclxuICAgICAgICAgICAgICAgIHBhcmFtczogeyB1c2VWaWV3IDogJ3RydWUnfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KG5ld1VybCwgbmV3T3B0KS5waXBlKG1hcCgodmFsOiBhbnlbXSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZ3JpZFJlc3VsdDogTG9va3VwR3JpZFJlc3VsdCA9IHt9O1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGdyaWRSZXN1bHQ7XHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOivtOaYjuaciei/h+a7pOadoeS7tlxyXG4gICAgICAgIGlmICh0aGlzLmdldEZpbHRlckRhdGEoKSkge1xyXG4gICAgICAgICAgICBmaWx0ZXIgPSBPYmplY3QuYXNzaWduKHRoaXMuZ2V0RmlsdGVyRGF0YSgpLCBmaWx0ZXIpO1xyXG4gICAgICAgICAgICBTeXNEYXRhVXRpbC5kZWxldGVFbXB0eShmaWx0ZXIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBwYXJhbVN0ciA9IEpTT04uc3RyaW5naWZ5KGZpbHRlcik7XHJcbiAgICAgICAgY29uc3Qgb3B0ID0ge1xyXG4gICAgICAgICAgICBoZWFkZXJzOiB0aGlzLnN5c1V0aWwuZ2V0SGVhZGVyKClbJ2hlYWRlcnMnXSxcclxuICAgICAgICAgICAgcGFyYW1zOiB7IHBhcmFtOiBwYXJhbVN0ciB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICByZXR1cm4gdGhpcy5odHRwLmdldCh1cmwsIG9wdCkucGlwZShtYXAoKHZhbDogYW55W10pID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZ3JpZFJlc3VsdDogYW55ID0ge307XHJcbiAgICAgICAgICAgIGdyaWRSZXN1bHQuc2VsZWN0ZWREYXRhID0gZmFycmlzU2VsZWN0ZWREYXRhO1xyXG5cclxuICAgICAgICAgICAgZ3JpZFJlc3VsdC5pdGVtcyA9IFtdO1xyXG4gICAgICAgICAgICBncmlkUmVzdWx0LnRyZWVJbmZvID0ge1xyXG4gICAgICAgICAgICAgICAgbG9hZERhdGFUeXBlOiAnYXN5bmMnLFxyXG4gICAgICAgICAgICAgICAgbGF5ZXJUeXBlOiAncGFyZW50SWQnLFxyXG4gICAgICAgICAgICAgICAgZGF0YUZpZWxkOiAndHJlZUluZm8nLFxyXG4gICAgICAgICAgICAgICAgcGF0aEZpZWxkOiAncGF0aCcsXHJcbiAgICAgICAgICAgICAgICBsYXllckZpZWxkOiAnbGF5ZXInLFxyXG4gICAgICAgICAgICAgICAgcGFyZW50RmllbGQ6ICdwYXJlbnRJZCcsXHJcbiAgICAgICAgICAgICAgICBpc0RldGFpbEZpZWxkOiAnaXNEZXRhaWwnXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGdyaWRSZXN1bHQudHJlZUluZm9bJ3RyZWVEYXRhSXNJbml0J10gPSB0cnVlO1xyXG4gICAgICAgICAgICBncmlkUmVzdWx0LmNvbHVtbnMgPSBbXHJcbiAgICAgICAgICAgICAgICB7IGZpZWxkOiAnY29kZScsIHRpdGxlOiB0aGlzLmkxOG5SZXMuY29kZUZpZWxkIH0sXHJcbiAgICAgICAgICAgICAgICB7IGZpZWxkOiAnbmFtZScsIHRpdGxlOiB0aGlzLmkxOG5SZXMubmFtZUZpZWxkIH1dO1xyXG4gICAgICAgICAgICBncmlkUmVzdWx0LnNlYXJjaEZpZWxkcyA9IFtcclxuICAgICAgICAgICAgICAgIHsgbGFiZWw6IHRoaXMuaTE4blJlcy5jb2RlRmllbGQsIHZhbHVlOiAnY29kZScgfSxcclxuICAgICAgICAgICAgICAgIHsgbGFiZWw6IHRoaXMuaTE4blJlcy5uYW1lRmllbGQsIHZhbHVlOiAnbmFtZScgfVxyXG4gICAgICAgICAgICBdO1xyXG4gICAgICAgICAgICAvLyDlv4XpobvopoHotYvlgLxcclxuICAgICAgICAgICAgZnJvbSh2YWwpLnN1YnNjcmliZShpdGVtID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChpdGVtLmxheWVyID09PSAxIHx8ICFpdGVtLnBhcmVudElkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaXRlbS5wYXJlbnRJZCA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpdGVtLnRyZWVJbmZvID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudElkOiBpdGVtLnBhcmVudElkLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhdGg6IGl0ZW0ucGF0aCxcclxuICAgICAgICAgICAgICAgICAgICBsYXllcjogaXRlbS5sYXllcixcclxuICAgICAgICAgICAgICAgICAgICBpc0RldGFpbDogaXRlbS5pc0RldGFpbFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIC8vIOWmguaenOaYr+aQnOe0oueahOivne+8jOmcgOimgeiHquW3seaehOmAoOagkVxyXG4gICAgICAgICAgICBpZiAoZmlsdGVyLmlzU2VhcmNoVHJlZSkge1xyXG4gICAgICAgICAgICAgICAgZ3JpZFJlc3VsdC5pdGVtcyA9IHRoaXMubWFrZVRyZWVCeVBhcmVudCh2YWwsICdwYXJlbnRJZCcsICdpZCcpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZ3JpZFJlc3VsdC5pdGVtcyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvLyDmnInnu5PmnpzvvIzmma7pgJrliIblsYLliqDovb1cclxuICAgICAgICAgICAgICAgIGlmICh2YWwgJiYgdmFsLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBmcm9tKHZhbCkuc3Vic2NyaWJlKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBncmlkUmVzdWx0Lml0ZW1zLnB1c2godGhpcy5jb252ZXJ0VG9UcmVlTm9kZShpdGVtKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGdyaWRSZXN1bHQ7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5bCG5qCR6IqC54K56L2s5o2i5Li6RmFycmlzIFRyZWVOb2RlXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgY29udmVydFRvVHJlZU5vZGUgKHNyYzogYW55KTogVHJlZU5vZGUge1xyXG4gICAgICAgIGNvbnN0IG5vZGU6IFRyZWVOb2RlID0ge307XHJcbiAgICAgICAgbm9kZS5kYXRhID0gc3JjO1xyXG4gICAgICAgIG5vZGUuY2hpbGRyZW4gPSBbXTtcclxuICAgICAgICBub2RlLnNlbGVjdGFibGUgPSBzcmMuZmFycmlzX3NlbGVjdGFibGU7XHJcbiAgICAgICAgbm9kZS5sZWFmID0gc3JjLmlzRGV0YWlsO1xyXG4gICAgICAgIG5vZGUucGFyZW50ID0gc3JjLnBhcmVudElkO1xyXG4gICAgICAgIC8vIOi/meS4gOadoeW/hemhu+W+l+WKoO+8jOWQpuWImeS4jeihjFxyXG4gICAgICAgIG5vZGUuaWQgPSBub2RlLmRhdGEuaWQ7XHJcbiAgICAgICAgLy8g5pCc57Si55qE5pe25YCZ5pyA5pyr57qn5re75Yqg5LqG6L+Z5Liq5bGe5oCn77yM5LiN6ZyA6KaB5bGV5byAXHJcbiAgICAgICAgaWYgKHNyYy5oYXNPd25Qcm9wZXJ0eSgnZXhwYW5kZWQnKSkge1xyXG4gICAgICAgICAgICBub2RlLmV4cGFuZGVkID0gc3JjLmV4cGFuZGVkO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbm9kZTtcclxuICAgIH1cclxuXHJcbiAgICAvKiog5oyJ54WncGFyZW5056CB5p6E6YCg5qCRICovXHJcbiAgICBtYWtlVHJlZUJ5UGFyZW50IChkYXRhczogYW55W10sIHBhcmVudEZpZWxkOiBzdHJpbmcsIGtleUZpZWxkOiBzdHJpbmcpOiBUcmVlTm9kZVtdIHtcclxuICAgICAgICAvLyDkuIrntJrniLLnqbrvvIzmiJbogIXmspLmnInkuIrntJrnmoRcclxuICAgICAgICBjb25zdCBwYXRoTGF5ZXJPbmVzID0gZGF0YXMuZmlsdGVyKHggPT4ge1xyXG4gICAgICAgICAgICBpZiAoIXhbcGFyZW50RmllbGRdKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyDmlq3lsYLnmoTov5nnp43vvIzlupTor6XkuZ/lsZ7kuo7kuIDnuqdcclxuICAgICAgICAgICAgY29uc3QgcCA9IGRhdGFzLmZpbmQocGFyZW50ID0+IHBhcmVudFtrZXlGaWVsZF0gPT09IHhbcGFyZW50RmllbGRdKTtcclxuICAgICAgICAgICAgaWYgKCFwKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IHRyZWVkYXRhOiBUcmVlTm9kZVtdID0gW107XHJcbiAgICAgICAgcGF0aExheWVyT25lcy5mb3JFYWNoKHggPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBub2RlID0gdGhpcy5jb252ZXJ0VG9UcmVlTm9kZSh4KTtcclxuICAgICAgICAgICAgdHJlZWRhdGEucHVzaChub2RlKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0cmVlZGF0YS5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmZpbmRDaGlsZHJlbkJ5UGFyZW50KGl0ZW0sIGRhdGFzLCBwYXJlbnRGaWVsZCwga2V5RmllbGQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiB0cmVlZGF0YTtcclxuICAgIH1cclxuXHJcbiAgICAvKiog5om+5Yiw5a2Q6IqC54K5ICovXHJcbiAgICBmaW5kQ2hpbGRyZW5CeVBhcmVudCAocGFyZW50OiBUcmVlTm9kZSwgZGF0YXM6IGFueVtdLCBwYXJlbnRGaWVsZDogc3RyaW5nLCBrZXlGaWVsZDogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgY2hpbGRMaXN0ID0gZGF0YXMuZmlsdGVyKGNoaWxkaXRlbSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChjaGlsZGl0ZW1bcGFyZW50RmllbGRdID09PSBwYXJlbnQuZGF0YVtrZXlGaWVsZF0pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKGNoaWxkTGlzdCAmJiBjaGlsZExpc3QubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBjaGlsZExpc3QuZm9yRWFjaChjaGlsZCA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBub2RlID0gdGhpcy5jb252ZXJ0VG9UcmVlTm9kZShjaGlsZCk7XHJcbiAgICAgICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChub2RlKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZmluZENoaWxkcmVuQnlQYXJlbnQobm9kZSwgZGF0YXMsIHBhcmVudEZpZWxkLCBrZXlGaWVsZCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWFqOmDqOiOt+WPlueJiOacrOeJiOacrFxyXG4gICAgICovXHJcbiAgICBnZXRUcmVlRGF0YSAodXJsOiBzdHJpbmcsIHBhcmFtcz86IFJlbW90ZVBhcmFtcyk6IE9ic2VydmFibGU8TG9va3VwR3JpZFJlc3VsdD4ge1xyXG4gICAgICAgIGxldCBmaWx0ZXI6IGFueSA9IHt9O1xyXG4gICAgICAgIC8vIOivtOaYjuaciei/h+a7pOadoeS7tlxyXG4gICAgICAgIGlmICh0aGlzLmdldEZpbHRlckRhdGEoKSkge1xyXG4gICAgICAgICAgICBmaWx0ZXIgPSBPYmplY3QuYXNzaWduKHRoaXMuZ2V0RmlsdGVyRGF0YSgpLCBmaWx0ZXIpO1xyXG4gICAgICAgICAgICBTeXNEYXRhVXRpbC5kZWxldGVFbXB0eShmaWx0ZXIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBwYXJhbVN0ciA9IEpTT04uc3RyaW5naWZ5KGZpbHRlcik7XHJcbiAgICAgICAgY29uc3Qgb3B0ID0ge1xyXG4gICAgICAgICAgICBoZWFkZXJzOiB0aGlzLnN5c1V0aWwuZ2V0SGVhZGVyKClbJ2hlYWRlcnMnXSxcclxuICAgICAgICAgICAgcGFyYW1zOiB7IHBhcmFtOiBwYXJhbVN0ciB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICByZXR1cm4gdGhpcy5odHRwLmdldCh1cmwsIG9wdCkucGlwZShtYXAoKHZhbDogYW55W10pID0+IHtcclxuICAgICAgICAgICAgaWYgKHZhbCAmJiB2YWwubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgdmFsLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0ubGF5ZXIgPT0gMSB8fCBpdGVtLnBhcmVudElkID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5wYXJlbnRJZCA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAvLyDmu6HotrPliY3nq6/nu5PmnoRcclxuICAgICAgICAgICAgICAgICAgICBpdGVtLnRyZWVJbmZvID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRJZDogaXRlbS5wYXJlbnRJZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGF0aDogaXRlbS5wYXRoLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBsYXllcjogaXRlbS5sYXllcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXNEZXRhaWw6IGl0ZW0uaXNEZXRhaWxcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgIGl0ZW0uc2VsZWN0YWJsZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB2YWwgPSBbXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4geyBpdGVtczogdmFsIH07XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKiDojrflj5bliJfooajmlbDmja4gKi9cclxuICAgIGdldEdyaWREYXRhICh1cmw6IHN0cmluZywgcGFyYW1zPzogUmVtb3RlUGFyYW1zKTogT2JzZXJ2YWJsZTxMb29rdXBHcmlkUmVzdWx0PiB7XHJcbiAgICAgICAgbGV0IGluZGV4ID0gcGFyYW1zLnBhZ2VJbmRleDtcclxuICAgICAgICBsZXQgc2l6ZSA9IHBhcmFtcy5wYWdlU2l6ZTtcclxuICAgICAgICBsZXQgZmFycmlzU2VsZWN0ZWREYXRhID0gcGFyYW1zWydjdXN0b21EYXRhJ10uZmFycmlzU2VsZWN0ZWREYXRhO1xyXG5cclxuICAgICAgICAvLyDnm67liY3ov5nkuKrlnLDmlrnmnInpl67popjvvIznrKzkuIDmrKHnmoTml7blgJnkvKDpgJLkuI3ov4fmnaVcclxuICAgICAgICBpZiAoIWluZGV4KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGN1c3RvbURhdGEgPSBwYXJhbXNbJ2N1c3RvbURhdGEnXTtcclxuICAgICAgICAgICAgaW5kZXggPSBjdXN0b21EYXRhLmZpbHRlci5wYWdlSW5kZXg7XHJcbiAgICAgICAgICAgIHNpemUgPSBjdXN0b21EYXRhLmZpbHRlci5wYWdlU2l6ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHBhcmFtOiBhbnkgPSB7XHJcbiAgICAgICAgICAgIHBhZ2VJbmRleDogaW5kZXgsXHJcbiAgICAgICAgICAgIHBhZ2VTaXplOiBzaXplLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgLy8g5piv5ZCm5pyJ5pCc57SiXHJcbiAgICAgICAgY29uc3QgZmlsdGVyU3RyID0gcGFyYW1zLnNlYXJjaFZhbHVlO1xyXG4gICAgICAgIGNvbnN0IGZpbHRlck9iaiA9IEpTT04ucGFyc2UoZmlsdGVyU3RyKTtcclxuICAgICAgICBjb25zdCBzZWFyY2hGaWVsZCA9IGZpbHRlck9iai5zZWFyY2hGaWVsZDtcclxuICAgICAgICBjb25zdCBzZWFyY2hWYWx1ZSA9IGZpbHRlck9iai5zZWFyY2hWYWx1ZTtcclxuICAgICAgICAvLyDmnInov4fmu6Tmn6Xor6Is5pyJ5Y+v6IO95pCc57Si5YC85Li656m677yM6L+Z5pe25YCZ5piv5LiN6ZyA6KaB5pCc57Si55qEXHJcbiAgICAgICAgaWYgKHNlYXJjaEZpZWxkICYmIHNlYXJjaFZhbHVlKSB7XHJcbiAgICAgICAgICAgIHN3aXRjaCAoc2VhcmNoRmllbGQpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgJ2NvZGUnOlxyXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtLmNvZGUgPSBzZWFyY2hWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ25hbWUnOlxyXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtLm5hbWUgPSBzZWFyY2hWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIC8vIOWFqOmDqOWIl+aQnOe0ou+8jOS5i+WJjeaYrycqJ1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnKic6XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtLmNvZGVPck5hbWUgPSBzZWFyY2hWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDor7TmmI7mnInov4fmu6TmnaHku7ZcclxuICAgICAgICBpZiAodGhpcy5nZXRGaWx0ZXJEYXRhKCkpIHtcclxuICAgICAgICAgICAgcGFyYW0gPSBPYmplY3QuYXNzaWduKHRoaXMuZ2V0RmlsdGVyRGF0YSgpLCBwYXJhbSk7XHJcbiAgICAgICAgICAgIFN5c0RhdGFVdGlsLmRlbGV0ZUVtcHR5KHBhcmFtKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc29sZS5sb2cocGFyYW0pO1xyXG4gICAgICAgIGNvbnN0IHBhcmFtU3RyID0gSlNPTi5zdHJpbmdpZnkocGFyYW0pO1xyXG4gICAgICAgIGNvbnN0IG9wdCA9IHtcclxuICAgICAgICAgICAgaGVhZGVyczogdGhpcy5zeXNVdGlsLmdldEhlYWRlcigpWydoZWFkZXJzJ10sXHJcbiAgICAgICAgICAgIHBhcmFtczogeyBwYXJhbTogcGFyYW1TdHIgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodXJsLCBvcHQpLnBpcGUobWFwKCh2YWw6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodmFsICYmIHZhbC5kYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAvLyDlsIbmnKzmrKHliIbpobXnmoTmlbDmja7pmYTliqDliLDlvZPliY3luK7liqnnmoTliJfooajkuK1cclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0TGlzdERhdGEocGFyYW1zWydjdXN0b21EYXRhJ10uYWxsRGF0YSwgdmFsLmRhdGEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBpdGVtczogdmFsLmRhdGEsXHJcbiAgICAgICAgICAgICAgICB0b3RhbDogdmFsLnRvdGFsQ291bnQsXHJcbiAgICAgICAgICAgICAgICBwYWdlSW5mbzoge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VJbmRleDogaW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgcGFnZVNpemU6IHNpemUsXHJcbiAgICAgICAgICAgICAgICAgICAgcGFnZUxpc3Q6IFsyMCwgNDAsIDYwLCA4MCwgMTAwXSxcclxuICAgICAgICAgICAgICAgICAgICBlbmFibGVQYWdlcjogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHNlbGVjdGVkRGF0YTpmYXJyaXNTZWxlY3RlZERhdGFcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcbiAgICAvKiog5Y+W5pWwICovXHJcbiAgICBnZXREYXRhICh1cmw6IHN0cmluZywgcGFyYW1zPzogUmVtb3RlUGFyYW1zKTogT2JzZXJ2YWJsZTxMb29rdXBHcmlkUmVzdWx0PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2cocGFyYW1zKTtcclxuICAgICAgICBjb25zb2xlLmxvZyh1cmwpO1xyXG4gICAgICAgIGNvbnN0IGZpbHRlciA9IHBhcmFtc1snY3VzdG9tRGF0YSddLmZpbHRlcjtcclxuICAgICAgICB0aGlzLnNldEZpbHRlckRhdGEoZmlsdGVyKTtcclxuICAgICAgICBjb25zdCB0eXBlSW5kZXggPSB1cmwuaW5kZXhPZignXFwvJyk7XHJcbiAgICAgICAgY29uc3QgaHR0cFVybCA9IHVybC5zdWJzdHJpbmcodHlwZUluZGV4LCB1cmwubGVuZ3RoKTtcclxuICAgICAgICBjb25zdCBoZWxwVHlwZSA9IHVybC5zdWJzdHJpbmcoMCwgdHlwZUluZGV4KTtcclxuICAgICAgICBzd2l0Y2ggKGhlbHBUeXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgdXNlckhlbHA6XHJcbiAgICAgICAgICAgIGNhc2UgcG9zSGVscDpcclxuICAgICAgICAgICAgY2FzZSByb2xlSGVscDpcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEdyaWREYXRhKGh0dHBVcmwsIHBhcmFtcyk7XHJcbiAgICAgICAgICAgIGNhc2UgdXNlckdyb3VwSGVscDpcclxuICAgICAgICAgICAgY2FzZSBwb3NHcm91cEhlbHA6XHJcbiAgICAgICAgICAgIGNhc2Ugcm9sZUdyb3VwSGVscDpcclxuICAgICAgICAgICAgY2FzZSBzeXNPcmdIZWxwOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VHJlZURhdGFBc3luYyhodHRwVXJsLCBwYXJhbXMpO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcbiJdfQ==